{
    "url": "http://localhost:9999/marcorinck/jquery-mobile-iscrollview/demo/build/javascripts/jquery.mobile-1.3.1.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statement:<ul><li>location.href = location.href.replace( /#.*/, '' ) + history_hash;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/marcorinck/jquery-mobile-iscrollview/demo/build/javascripts/jquery.mobile-1.3.1.js",
                "path": "/marcorinck/jquery-mobile-iscrollview/demo/build/javascripts/jquery.mobile-1.3.1.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tYXJjb3JpbmNrL2pxdWVyeS1tb2JpbGUtaXNjcm9sbHZpZXcvZGVtby9idWlsZC9qYXZhc2NyaXB0cy9qcXVlcnkubW9iaWxlLTEuMy4xLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzU5MDA3DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA2OjQ5OjQzIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNjo0OTo0MyBHTVQNCg0KLyoKKiBqUXVlcnkgTW9iaWxlIDEuMy4xCiogR2l0IEhFQUQgaGFzaDogNzRiNGJlYzA0OWZkOTNlNGZlNDAyMDVlNjE1N2RlMTZlYjY0ZWI0NiA8PiBEYXRlOiBXZWQgQXByIDEwIDIwMTMgMjE6NTc6MjMgVVRDCiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDEwLCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgoKCihmdW5jdGlvbiAoIHJvb3QsIGRvYywgZmFjdG9yeSApIHsKCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlkZWZpbmUoIFsgImpxdWVyeSIgXSwgZnVuY3Rpb24gKCAkICkgewoJCQlmYWN0b3J5KCAkLCByb290LCBkb2MgKTsKCQkJcmV0dXJuICQubW9iaWxlOwoJCX0pOwoJfSBlbHNlIHsKCQkvLyBCcm93c2VyIGdsb2JhbHMKCQlmYWN0b3J5KCByb290LmpRdWVyeSwgcm9vdCwgZG9jICk7Cgl9Cn0oIHRoaXMsIGRvY3VtZW50LCBmdW5jdGlvbiAoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewooZnVuY3Rpb24oICQgKSB7CgkkLm1vYmlsZSA9IHt9Owp9KCBqUXVlcnkgKSk7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgbnNOb3JtYWxpemVEaWN0ID0ge307CgoJLy8galF1ZXJ5Lm1vYmlsZSBjb25maWd1cmFibGUgb3B0aW9ucwoJJC5tb2JpbGUgPSAkLmV4dGVuZCgkLm1vYmlsZSwgewoKCQkvLyBWZXJzaW9uIG9mIHRoZSBqUXVlcnkgTW9iaWxlIEZyYW1ld29yawoJCXZlcnNpb246ICIxLjMuMSIsCgoJCS8vIE5hbWVzcGFjZSB1c2VkIGZyYW1ld29yay13aWRlIGZvciBkYXRhLWF0dHJzLiBEZWZhdWx0IGlzIG5vIG5hbWVzcGFjZQoJCW5zOiAiIiwKCgkJLy8gRGVmaW5lIHRoZSB1cmwgcGFyYW1ldGVyIHVzZWQgZm9yIHJlZmVyZW5jaW5nIHdpZGdldC1nZW5lcmF0ZWQgc3ViLXBhZ2VzLgoJCS8vIFRyYW5zbGF0ZXMgdG8gdG8gZXhhbXBsZS5odG1sJnVpLXBhZ2U9c3VicGFnZUlkZW50aWZpZXIKCQkvLyBoYXNoIHNlZ21lbnQgYmVmb3JlICZ1aS1wYWdlPSBpcyB1c2VkIHRvIG1ha2UgQWpheCByZXF1ZXN0CgkJc3ViUGFnZVVybEtleTogInVpLXBhZ2UiLAoKCQkvLyBDbGFzcyBhc3NpZ25lZCB0byBwYWdlIGN1cnJlbnRseSBpbiB2aWV3LCBhbmQgZHVyaW5nIHRyYW5zaXRpb25zCgkJYWN0aXZlUGFnZUNsYXNzOiAidWktcGFnZS1hY3RpdmUiLAoKCQkvLyBDbGFzcyB1c2VkIGZvciAiYWN0aXZlIiBidXR0b24gc3RhdGUsIGZyb20gQ1NTIGZyYW1ld29yawoJCWFjdGl2ZUJ0bkNsYXNzOiAidWktYnRuLWFjdGl2ZSIsCgoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQltaW5TY3JvbGxCYWNrOiAyNTAsCgoJCS8vIERFUFJFQ0FURUQ6IHRoZSBmb2xsb3dpbmcgcHJvcGVydHkgaXMgbm8gbG9uZ2VyIGluIHVzZSwgYnV0IGRlZmluZWQgdW50aWwgMi4wIHRvIHByZXZlbnQgY29uZmxpY3RzCgkJdG91Y2hPdmVyZmxvd0VuYWJsZWQ6IGZhbHNlLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZXM/CgkJcGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZTogImUiLAoKCQkvLyByZXBsYWNlIGNhbGxzIHRvIHdpbmRvdy5oaXN0b3J5LmJhY2sgd2l0aCBwaG9uZWdhcHMgbmF2aWdhdGlvbiBoZWxwZXIKCQkvLyB3aGVyZSBpdCBpcyBwcm92aWRlZCBvbiB0aGUgd2luZG93IG9iamVjdAoJCXBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQ6IGZhbHNlLAoKCQkvL2F1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgRE9NIHdoZW4gaXQncyByZWFkeQoJCWF1dG9Jbml0aWFsaXplUGFnZTogdHJ1ZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gYWxsb3dzIHVzZXJzIHRvIG9wdCBpbiB0byBpZ25vcmluZyBjb250ZW50IGJ5IG1hcmtpbmcgYSBwYXJlbnQgZWxlbWVudCBhcwoJCS8vIGRhdGEtaWdub3JlZAoJCWlnbm9yZUNvbnRlbnRFbmFibGVkOiBmYWxzZSwKCgkJLy8gdHVybiBvZiBiaW5kaW5nIHRvIHRoZSBuYXRpdmUgb3JpZW50YXRpb25jaGFuZ2UgZHVlIHRvIGFuZHJvaWQgb3JpZW50YXRpb24gYmVoYXZpb3IKCQlvcmllbnRhdGlvbkNoYW5nZUVuYWJsZWQ6IHRydWUsCgoJCWJ1dHRvbk1hcmt1cDogewoJCQlob3ZlckRlbGF5OiAyMDAKCQl9LAoKCQkvLyBkZWZpbmUgdGhlIHdpbmRvdyBhbmQgdGhlIGRvY3VtZW50IG9iamVjdHMKCQl3aW5kb3c6ICQoIHdpbmRvdyApLAoJCWRvY3VtZW50OiAkKCBkb2N1bWVudCApLAoKCQkvLyBUT0RPIG1pZ2h0IGJlIHVzZWZ1bCB1cHN0cmVhbSBpbiBqcXVlcnkgaXRzZWxmID8KCQlrZXlDb2RlOiB7CgkJCUFMVDogMTgsCgkJCUJBQ0tTUEFDRTogOCwKCQkJQ0FQU19MT0NLOiAyMCwKCQkJQ09NTUE6IDE4OCwKCQkJQ09NTUFORDogOTEsCgkJCUNPTU1BTkRfTEVGVDogOTEsIC8vIENPTU1BTkQKCQkJQ09NTUFORF9SSUdIVDogOTMsCgkJCUNPTlRST0w6IDE3LAoJCQlERUxFVEU6IDQ2LAoJCQlET1dOOiA0MCwKCQkJRU5EOiAzNSwKCQkJRU5URVI6IDEzLAoJCQlFU0NBUEU6IDI3LAoJCQlIT01FOiAzNiwKCQkJSU5TRVJUOiA0NSwKCQkJTEVGVDogMzcsCgkJCU1FTlU6IDkzLCAvLyBDT01NQU5EX1JJR0hUCgkJCU5VTVBBRF9BREQ6IDEwNywKCQkJTlVNUEFEX0RFQ0lNQUw6IDExMCwKCQkJTlVNUEFEX0RJVklERTogMTExLAoJCQlOVU1QQURfRU5URVI6IDEwOCwKCQkJTlVNUEFEX01VTFRJUExZOiAxMDYsCgkJCU5VTVBBRF9TVUJUUkFDVDogMTA5LAoJCQlQQUdFX0RPV046IDM0LAoJCQlQQUdFX1VQOiAzMywKCQkJUEVSSU9EOiAxOTAsCgkJCVJJR0hUOiAzOSwKCQkJU0hJRlQ6IDE2LAoJCQlTUEFDRTogMzIsCgkJCVRBQjogOSwKCQkJVVA6IDM4LAoJCQlXSU5ET1dTOiA5MSAvLyBDT01NQU5ECgkJfSwKCgkJLy8gUGxhY2UgdG8gc3RvcmUgdmFyaW91cyB3aWRnZXQgZXh0ZW5zaW9ucwoJCWJlaGF2aW9yczoge30sCgoJCS8vIFNjcm9sbCBwYWdlIHZlcnRpY2FsbHk6IHNjcm9sbCB0byAwIHRvIGhpZGUgaU9TIGFkZHJlc3MgYmFyLCBvciBwYXNzIGEgWSB2YWx1ZQoJCXNpbGVudFNjcm9sbDogZnVuY3Rpb24oIHlwb3MgKSB7CgkJCWlmICggJC50eXBlKCB5cG9zICkgIT09ICJudW1iZXIiICkgewoJCQkJeXBvcyA9ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCQl9CgoJCQkvLyBwcmV2ZW50IHNjcm9sbHN0YXJ0IGFuZCBzY3JvbGxzdG9wIGV2ZW50cwoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHlwb3MgKTsKCQkJCSQubW9iaWxlLmRvY3VtZW50LnRyaWdnZXIoICJzaWxlbnRzY3JvbGwiLCB7IHg6IDAsIHk6IHlwb3MgfSk7CgkJCX0sIDIwICk7CgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJaWYgKCAhcHJvcCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8ICggbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gPSAkLmNhbWVsQ2FzZSggJC5tb2JpbGUubnMgKyBwcm9wICkgKTsKCQl9LAoKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCgkJCXdoaWxlICggZSApIHsKCQkJCWMgPSBlLmNsYXNzTmFtZSB8fCAiIjsKCQkJCWlmICggYyAmJiAoIG0gPSByZS5leGVjKCBjICkgKSAmJiAoIGx0ciA9IG1bIDIgXSApICkgewoJCQkJCS8vIFdlIGZvdW5kIGEgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcwoJCQkJCS8vIG9uIGl0IHNvIGJhaWwgZnJvbSB0aGlzIGxvb3AuCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJfQoKCQkJLy8gUmV0dXJuIHRoZSB0aGVtZSBsZXR0ZXIgd2UgZm91bmQsIGlmIG5vbmUsIHJldHVybiB0aGUKCQkJLy8gc3BlY2lmaWVkIGRlZmF1bHQuCgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJLy8gVE9ETyB0aGUgZm9sbG93aW5nICQgYW5kICQuZm4gZXh0ZW5zaW9ucyBjYW4vcHJvYmFibHkgc2hvdWxkIGJlIG1vdmVkIGludG8ganF1ZXJ5Lm1vYmlsZS5jb3JlLmhlbHBlcnMKCQkvLwoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgamF2YXNjcmlwdCBwYWdlIGVsZW1lbnQgdG8gZ2F0aGVyIHNldHRpbmdzIGRhdGEganNwZXJmIHRlc3QKCQkvLyBodHRwOi8vanNwZXJmLmNvbS9zaW5nbGUtY29tcGxleC1zZWxlY3Rvci12cy1tYW55LWNvbXBsZXgtc2VsZWN0b3JzL2VkaXQKCQkvLyBwb3NzaWJseSBuYWl2ZSwgYnV0IGl0IHNob3dzIHRoYXQgdGhlIHBhcnNpbmcgb3ZlcmhlYWQgZm9yICpqdXN0KiB0aGUgcGFnZSBzZWxlY3RvciB2cwoJCS8vIHRoZSBwYWdlIGFuZCBkaWFsb2cgc2VsZWN0b3IgaXMgbmVnbGlnYWJsZS4gVGhpcyBjb3VsZCBwcm9iYWJseSBiZSBzcGVlZCB1cCBieQoJCS8vIGRvaW5nIGEgc2ltaWxhciBwYXJlbnQgbm9kZSB0cmF2ZXJzYWwgdG8gdGhlIG9uZSBmb3VuZCBpbiB0aGUgaW5oZXJpdGVkIHRoZW1lIGNvZGUgYWJvdmUKCQljbG9zZXN0UGFnZURhdGE6IGZ1bmN0aW9uKCAkdGFyZ2V0ICkgewoJCQlyZXR1cm4gJHRhcmdldAoJCQkJLmNsb3Nlc3QoICc6anFtRGF0YShyb2xlPSJwYWdlIiksIDpqcW1EYXRhKHJvbGU9ImRpYWxvZyIpJyApCgkJCQkuZGF0YSggIm1vYmlsZS1wYWdlIiApOwoJCX0sCgoJCWVuaGFuY2VhYmxlOiBmdW5jdGlvbiggJHNldCApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoICRzZXQsICJlbmhhbmNlIiApOwoJCX0sCgoJCWhpamFja2FibGU6IGZ1bmN0aW9uKCAkc2V0ICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggJHNldCwgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCAkc2V0LCBhdHRyICkgewoJCQlpZiAoICEkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCApIHsKCQkJCXJldHVybiAkc2V0OwoJCQl9CgoJCQl2YXIgY291bnQgPSAkc2V0Lmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQ7CgoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSAkc2V0LmVxKCBpICk7CgkJCQlleGNsdWRlZCA9IGZhbHNlOwoJCQkJZSA9ICRzZXRbIGkgXTsKCgkJCQl3aGlsZSAoIGUgKSB7CgkJCQkJdmFyIGMgPSBlLmdldEF0dHJpYnV0ZSA/IGUuZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBhdHRyICkgOiAiIjsKCgkJCQkJaWYgKCBjID09PSAiZmFsc2UiICkgewoJCQkJCQlleGNsdWRlZCA9IHRydWU7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCgkJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJCX0KCgkJCQlpZiAoICFleGNsdWRlZCApIHsKCQkJCQkkbmV3U2V0ID0gJG5ld1NldC5hZGQoICRlbGVtZW50ICk7CgkJCQl9CgkJCX0KCgkJCXJldHVybiAkbmV3U2V0OwoJCX0sCgoJCWdldFNjcmVlbkhlaWdodDogZnVuY3Rpb24oKSB7CgkJCS8vIE5hdGl2ZSBpbm5lckhlaWdodCByZXR1cm5zIG1vcmUgYWNjdXJhdGUgdmFsdWUgZm9yIHRoaXMgYWNyb3NzIHBsYXRmb3JtcywKCQkJLy8galF1ZXJ5IHZlcnNpb24gaXMgaGVyZSBhcyBhIG5vcm1hbGl6ZWQgZmFsbGJhY2sgZm9yIHBsYXRmb3JtcyBsaWtlIFN5bWJpYW4KCQkJcmV0dXJuIHdpbmRvdy5pbm5lckhlaWdodCB8fCAkLm1vYmlsZS53aW5kb3cuaGVpZ2h0KCk7CgkJfQoJfSwgJC5tb2JpbGUgKTsKCgkvLyBNb2JpbGUgdmVyc2lvbiBvZiBkYXRhIGFuZCByZW1vdmVEYXRhIGFuZCBoYXNEYXRhIG1ldGhvZHMKCS8vIGVuc3VyZXMgYWxsIGRhdGEgaXMgc2V0IGFuZCByZXRyaWV2ZWQgdXNpbmcgalF1ZXJ5IE1vYmlsZSdzIGRhdGEgbmFtZXNwYWNlCgkkLmZuLmpxbURhdGEgPSBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJaWYgKCBwcm9wICkgewoJCQkJcHJvcCA9ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICk7CgkJCX0KCgkJCS8vIHVuZGVmaW5lZCBpcyBwZXJtaXR0ZWQgYXMgYW4gZXhwbGljaXQgaW5wdXQgZm9yIHRoZSBzZWNvbmQgcGFyYW0KCQkJLy8gaW4gdGhpcyBjYXNlIGl0IHJldHVybnMgdGhlIHZhbHVlIGFuZCBkb2VzIG5vdCBzZXQgaXQgdG8gdW5kZWZpbmVkCgkJCWlmKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICl7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AgKTsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCwgdmFsdWUgKTsKCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmpxbURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gJC5kYXRhKCBlbGVtLCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuZm4uanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBwcm9wICkgewoJCXJldHVybiB0aGlzLnJlbW92ZURhdGEoICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AgKSB7CgkJcmV0dXJuICQucmVtb3ZlRGF0YSggZWxlbSwgJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmZuLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oKSB7CgkJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyggdGhpcyApOwoJfTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyICRlbGVtID0gJCggZWxlbSApOwoKCQkoICRlbGVtLmpxbURhdGEoICdkZXBlbmRlbnRzJyApIHx8ICQoKSApLnJlbW92ZSgpOwoJCSRlbGVtLnJlbW92ZSgpOwoJfTsKCgkkLmZuLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggbmV3RGVwZW5kZW50cyApIHsKCQkkLmFkZERlcGVuZGVudHMoICQoIHRoaXMgKSwgbmV3RGVwZW5kZW50cyApOwoJfTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgZGVwZW5kZW50cyA9ICQoIGVsZW0gKS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCk7CgoJCSQoIGVsZW0gKS5qcW1EYXRhKCAnZGVwZW5kZW50cycsICQubWVyZ2UoIGRlcGVuZGVudHMsIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkvLyBub3RlIHRoYXQgdGhpcyBoZWxwZXIgZG9lc24ndCBhdHRlbXB0IHRvIGhhbmRsZSB0aGUgY2FsbGJhY2sKCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50J3MgdGV4dCwgaXRzIG9ubHkgcHVycG9zZSBpcwoJLy8gdG8gcmV0dXJuIHRoZSBodG1sIGVuY29kZWQgdmVyc2lvbiBvZiB0aGUgdGV4dCBpbiBhbGwgY2FzZXMuICh0aHVzIHRoZSBuYW1lKQoJJC5mbi5nZXRFbmNvZGVkVGV4dCA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApLnRleHQoICQoIHRoaXMgKS50ZXh0KCkgKS5odG1sKCk7Cgl9OwoKCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkkLmZuLmpxbUVuaGFuY2VhYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmVuaGFuY2VhYmxlKCB0aGlzICk7Cgl9OwoKCSQuZm4uanFtSGlqYWNrYWJsZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5oaWphY2thYmxlKCB0aGlzICk7Cgl9OwoKCS8vIE1vbmtleS1wYXRjaGluZyBTaXp6bGUgdG8gZmlsdGVyIHRoZSA6anFtRGF0YSBzZWxlY3RvcgoJdmFyIG9sZEZpbmQgPSAkLmZpbmQsCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKCSQuZmluZC5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIHNldCApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKCX07CgoJJC5maW5kLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBub2RlLCBleHByICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIFsgbm9kZSBdICkubGVuZ3RoID4gMDsKCX07Cn0pKCBqUXVlcnksIHRoaXMgKTsKCgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCB2MS4xMC4wcHJlIC0gMjAxMi0xMS0xMyAoZmYwNTVhMGMzNTNjM2M4Y2U2ZTViZmEwN2FkN2NiMDNlODg4NWJjNSkKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgMjAxMCwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9qUXVlcnkud2lkZ2V0LwogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdXVpZCA9IDAsCglzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKCV9jbGVhbkRhdGEgPSAkLmNsZWFuRGF0YTsKJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7Cglmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQl0cnkgewoJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODIzNQoJCX0gY2F0Y2goIGUgKSB7fQoJfQoJX2NsZWFuRGF0YSggZWxlbXMgKTsKfTsKCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBmdWxsTmFtZSwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgY29uc3RydWN0b3IsIGJhc2VQcm90b3R5cGUsCgkJbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lLnRvTG93ZXJDYXNlKCkgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgZnVsbE5hbWUgKTsKCX07CgoJJFsgbmFtZXNwYWNlIF0gPSAkWyBuYW1lc3BhY2UgXSB8fCB7fTsKCWV4aXN0aW5nQ29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdOwoJY29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0ICJuZXciIGtleXdvcmQKCQlpZiAoICF0aGlzLl9jcmVhdGVXaWRnZXQgKSB7CgkJCXJldHVybiBuZXcgY29uc3RydWN0b3IoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9CgoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCS8vIG11c3QgdXNlICJuZXciIGtleXdvcmQgKHRoZSBjb2RlIGFib3ZlIGFsd2F5cyBwYXNzZXMgYXJncykKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCX07CgkvLyBleHRlbmQgd2l0aCB0aGUgZXhpc3RpbmcgY29uc3RydWN0b3IgdG8gY2Fycnkgb3ZlciBhbnkgc3RhdGljIHByb3BlcnRpZXMKCSQuZXh0ZW5kKCBjb25zdHJ1Y3RvciwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgewoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLAoJCS8vIGNvcHkgdGhlIG9iamVjdCB1c2VkIHRvIGNyZWF0ZSB0aGUgcHJvdG90eXBlIGluIGNhc2Ugd2UgbmVlZCB0bwoJCS8vIHJlZGVmaW5lIHRoZSB3aWRnZXQgbGF0ZXIKCQlfcHJvdG86ICQuZXh0ZW5kKCB7fSwgcHJvdG90eXBlICksCgkJLy8gdHJhY2sgd2lkZ2V0cyB0aGF0IGluaGVyaXQgZnJvbSB0aGlzIHdpZGdldCBpbiBjYXNlIHRoaXMgd2lkZ2V0IGlzCgkJLy8gcmVkZWZpbmVkIGFmdGVyIGEgd2lkZ2V0IGluaGVyaXRzIGZyb20gaXQKCQlfY2hpbGRDb25zdHJ1Y3RvcnM6IFtdCgl9KTsKCgliYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCS8vIHdlIG5lZWQgdG8gbWFrZSB0aGUgb3B0aW9ucyBoYXNoIGEgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIG5ldyBpbnN0YW5jZQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQoJLy8gaW5oZXJpdGluZyBmcm9tCgliYXNlUHJvdG90eXBlLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LCBiYXNlUHJvdG90eXBlLm9wdGlvbnMgKTsKCSQuZWFjaCggcHJvdG90eXBlLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJaWYgKCAkLmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXByb3RvdHlwZVsgcHJvcCBdID0gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIF9zdXBlciA9IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQkJfSwKCQkJCQlfc3VwZXJBcHBseSA9IGZ1bmN0aW9uKCBhcmdzICkgewoJCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJncyApOwoJCQkJCX07CgkJCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCQkJdmFyIF9fc3VwZXIgPSB0aGlzLl9zdXBlciwKCQkJCQkJX19zdXBlckFwcGx5ID0gdGhpcy5fc3VwZXJBcHBseSwKCQkJCQkJcmV0dXJuVmFsdWU7CgoJCQkJCXRoaXMuX3N1cGVyID0gX3N1cGVyOwoJCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfc3VwZXJBcHBseTsKCgkJCQkJcmV0dXJuVmFsdWUgPSB2YWx1ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCQkJCXRoaXMuX3N1cGVyID0gX19zdXBlcjsKCQkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX19zdXBlckFwcGx5OwoKCQkJCQlyZXR1cm4gcmV0dXJuVmFsdWU7CgkJCQl9OwoJCQl9KSgpOwoJCX0KCX0pOwoJY29uc3RydWN0b3IucHJvdG90eXBlID0gJC53aWRnZXQuZXh0ZW5kKCBiYXNlUHJvdG90eXBlLCB7CgkJLy8gVE9ETzogcmVtb3ZlIHN1cHBvcnQgZm9yIHdpZGdldEV2ZW50UHJlZml4CgkJLy8gYWx3YXlzIHVzZSB0aGUgbmFtZSArIGEgY29sb24gYXMgdGhlIHByZWZpeCwgZS5nLiwgZHJhZ2dhYmxlOnN0YXJ0CgkJLy8gZG9uJ3QgcHJlZml4IGZvciB3aWRnZXRzIHRoYXQgYXJlbid0IERPTS1iYXNlZAoJCXdpZGdldEV2ZW50UHJlZml4OiBleGlzdGluZ0NvbnN0cnVjdG9yID8gYmFzZVByb3RvdHlwZS53aWRnZXRFdmVudFByZWZpeCA6IG5hbWUKCX0sIHByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSk7CgoJLy8gSWYgdGhpcyB3aWRnZXQgaXMgYmVpbmcgcmVkZWZpbmVkIHRoZW4gd2UgbmVlZCB0byBmaW5kIGFsbCB3aWRnZXRzIHRoYXQKCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20KCS8vIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGlzIHdpZGdldC4gV2UncmUgZXNzZW50aWFsbHkgdHJ5aW5nIHRvIHJlcGxhY2Ugb25lCgkvLyBsZXZlbCBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgewoJCSQuZWFjaCggZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnMsIGZ1bmN0aW9uKCBpLCBjaGlsZCApIHsKCQkJdmFyIGNoaWxkUHJvdG90eXBlID0gY2hpbGQucHJvdG90eXBlOwoKCQkJLy8gcmVkZWZpbmUgdGhlIGNoaWxkIHdpZGdldCB1c2luZyB0aGUgc2FtZSBwcm90b3R5cGUgdGhhdCB3YXMKCQkJLy8gb3JpZ2luYWxseSB1c2VkLCBidXQgaW5oZXJpdCBmcm9tIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUgYmFzZQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsIGNoaWxkLl9wcm90byApOwoJCX0pOwoJCS8vIHJlbW92ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjaGlsZCBjb25zdHJ1Y3RvcnMgZnJvbSB0aGUgb2xkIGNvbnN0cnVjdG9yCgkJLy8gc28gdGhlIG9sZCBjaGlsZCBjb25zdHJ1Y3RvcnMgY2FuIGJlIGdhcmJhZ2UgY29sbGVjdGVkCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOwoJfSBlbHNlIHsKCQliYXNlLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKCBjb25zdHJ1Y3RvciApOwoJfQoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgY29uc3RydWN0b3IgKTsKfTsKCiQud2lkZ2V0LmV4dGVuZCA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7Cgl2YXIgaW5wdXQgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQlpbnB1dEluZGV4ID0gMCwKCQlpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aCwKCQlrZXksCgkJdmFsdWU7Cglmb3IgKCA7IGlucHV0SW5kZXggPCBpbnB1dExlbmd0aDsgaW5wdXRJbmRleCsrICkgewoJCWZvciAoIGtleSBpbiBpbnB1dFsgaW5wdXRJbmRleCBdICkgewoJCQl2YWx1ZSA9IGlucHV0WyBpbnB1dEluZGV4IF1bIGtleSBdOwoJCQlpZiAoIGlucHV0WyBpbnB1dEluZGV4IF0uaGFzT3duUHJvcGVydHkoIGtleSApICYmIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkvLyBDbG9uZSBvYmplY3RzCgkJCQlpZiAoICQuaXNQbGFpbk9iamVjdCggdmFsdWUgKSApIHsKCQkJCQl0YXJnZXRbIGtleSBdID0gJC5pc1BsYWluT2JqZWN0KCB0YXJnZXRbIGtleSBdICkgPwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB0YXJnZXRbIGtleSBdLCB2YWx1ZSApIDoKCQkJCQkJLy8gRG9uJ3QgZXh0ZW5kIHN0cmluZ3MsIGFycmF5cywgZXRjLiB3aXRoIG9iamVjdHMKCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdmFsdWUgKTsKCQkJCS8vIENvcHkgZXZlcnl0aGluZyBlbHNlIGJ5IHJlZmVyZW5jZQoJCQkJfSBlbHNlIHsKCQkJCQl0YXJnZXRbIGtleSBdID0gdmFsdWU7CgkJCQl9CgkJCX0KCQl9Cgl9CglyZXR1cm4gdGFyZ2V0Owp9OwoKJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsKCXZhciBmdWxsTmFtZSA9IG9iamVjdC5wcm90b3R5cGUud2lkZ2V0RnVsbE5hbWUgfHwgbmFtZTsKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpc01ldGhvZENhbGwgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIsCgkJCWFyZ3MgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQkJcmV0dXJuVmFsdWUgPSB0aGlzOwoKCQkvLyBhbGxvdyBtdWx0aXBsZSBoYXNoZXMgdG8gYmUgcGFzc2VkIG9uIGluaXQKCQlvcHRpb25zID0gIWlzTWV0aG9kQ2FsbCAmJiBhcmdzLmxlbmd0aCA/CgkJCSQud2lkZ2V0LmV4dGVuZC5hcHBseSggbnVsbCwgWyBvcHRpb25zIF0uY29uY2F0KGFyZ3MpICkgOgoJCQlvcHRpb25zOwoKCQlpZiAoIGlzTWV0aG9kQ2FsbCApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIG1ldGhvZFZhbHVlLAoJCQkJCWluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCAhaW5zdGFuY2UgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJjYW5ub3QgY2FsbCBtZXRob2RzIG9uICIgKyBuYW1lICsgIiBwcmlvciB0byBpbml0aWFsaXphdGlvbjsgIiArCgkJCQkJCSJhdHRlbXB0ZWQgdG8gY2FsbCBtZXRob2QgJyIgKyBvcHRpb25zICsgIiciICk7CgkJCQl9CgkJCQlpZiAoICEkLmlzRnVuY3Rpb24oIGluc3RhbmNlW29wdGlvbnNdICkgfHwgb3B0aW9ucy5jaGFyQXQoIDAgKSA9PT0gIl8iICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAibm8gc3VjaCBtZXRob2QgJyIgKyBvcHRpb25zICsgIicgZm9yICIgKyBuYW1lICsgIiB3aWRnZXQgaW5zdGFuY2UiICk7CgkJCQl9CgkJCQltZXRob2RWYWx1ZSA9IGluc3RhbmNlWyBvcHRpb25zIF0uYXBwbHkoIGluc3RhbmNlLCBhcmdzICk7CgkJCQlpZiAoIG1ldGhvZFZhbHVlICE9PSBpbnN0YW5jZSAmJiBtZXRob2RWYWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVyblZhbHVlID0gbWV0aG9kVmFsdWUgJiYgbWV0aG9kVmFsdWUuanF1ZXJ5ID8KCQkJCQkJcmV0dXJuVmFsdWUucHVzaFN0YWNrKCBtZXRob2RWYWx1ZS5nZXQoKSApIDoKCQkJCQkJbWV0aG9kVmFsdWU7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoIGluc3RhbmNlICkgewoJCQkJCWluc3RhbmNlLm9wdGlvbiggb3B0aW9ucyB8fCB7fSApLl9pbml0KCk7CgkJCQl9IGVsc2UgewoJCQkJCSQuZGF0YSggdGhpcywgZnVsbE5hbWUsIG5ldyBvYmplY3QoIG9wdGlvbnMsIHRoaXMgKSApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX07Cn07CgokLldpZGdldCA9IGZ1bmN0aW9uKCAvKiBvcHRpb25zLCBlbGVtZW50ICovICkge307CiQuV2lkZ2V0Ll9jaGlsZENvbnN0cnVjdG9ycyA9IFtdOwoKJC5XaWRnZXQucHJvdG90eXBlID0gewoJd2lkZ2V0TmFtZTogIndpZGdldCIsCgl3aWRnZXRFdmVudFByZWZpeDogIiIsCglkZWZhdWx0RWxlbWVudDogIjxkaXY+IiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogZmFsc2UsCgoJCS8vIGNhbGxiYWNrcwoJCWNyZWF0ZTogbnVsbAoJfSwKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCWVsZW1lbnQgPSAkKCBlbGVtZW50IHx8IHRoaXMuZGVmYXVsdEVsZW1lbnQgfHwgdGhpcyApWyAwIF07CgkJdGhpcy5lbGVtZW50ID0gJCggZWxlbWVudCApOwoJCXRoaXMudXVpZCA9IHV1aWQrKzsKCQl0aGlzLmV2ZW50TmFtZXNwYWNlID0gIi4iICsgdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkOwoJCXRoaXMub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sCgkJCXRoaXMub3B0aW9ucywKCQkJdGhpcy5fZ2V0Q3JlYXRlT3B0aW9ucygpLAoJCQlvcHRpb25zICk7CgoJCXRoaXMuYmluZGluZ3MgPSAkKCk7CgkJdGhpcy5ob3ZlcmFibGUgPSAkKCk7CgkJdGhpcy5mb2N1c2FibGUgPSAkKCk7CgoJCWlmICggZWxlbWVudCAhPT0gdGhpcyApIHsKCQkJJC5kYXRhKCBlbGVtZW50LCB0aGlzLndpZGdldEZ1bGxOYW1lLCB0aGlzICk7CgkJCXRoaXMuX29uKCB0cnVlLCB0aGlzLmVsZW1lbnQsIHsKCQkJCXJlbW92ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggZXZlbnQudGFyZ2V0ID09PSBlbGVtZW50ICkgewoJCQkJCQl0aGlzLmRlc3Ryb3koKTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCQl0aGlzLmRvY3VtZW50ID0gJCggZWxlbWVudC5zdHlsZSA/CgkJCQkvLyBlbGVtZW50IHdpdGhpbiB0aGUgZG9jdW1lbnQKCQkJCWVsZW1lbnQub3duZXJEb2N1bWVudCA6CgkJCQkvLyBlbGVtZW50IGlzIHdpbmRvdyBvciBkb2N1bWVudAoJCQkJZWxlbWVudC5kb2N1bWVudCB8fCBlbGVtZW50ICk7CgkJCXRoaXMud2luZG93ID0gJCggdGhpcy5kb2N1bWVudFswXS5kZWZhdWx0VmlldyB8fCB0aGlzLmRvY3VtZW50WzBdLnBhcmVudFdpbmRvdyApOwoJCX0KCgkJdGhpcy5fY3JlYXRlKCk7CgkJdGhpcy5fdHJpZ2dlciggImNyZWF0ZSIsIG51bGwsIHRoaXMuX2dldENyZWF0ZUV2ZW50RGF0YSgpICk7CgkJdGhpcy5faW5pdCgpOwoJfSwKCV9nZXRDcmVhdGVPcHRpb25zOiAkLm5vb3AsCglfZ2V0Q3JlYXRlRXZlbnREYXRhOiAkLm5vb3AsCglfY3JlYXRlOiAkLm5vb3AsCglfaW5pdDogJC5ub29wLAoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2Rlc3Ryb3koKTsKCQkvLyB3ZSBjYW4gcHJvYmFibHkgcmVtb3ZlIHRoZSB1bmJpbmQgY2FsbHMgaW4gMi4wCgkJLy8gYWxsIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBnbyB0aHJvdWdoIHRoaXMuX29uKCkKCQl0aGlzLmVsZW1lbnQKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS8vIDEuOSBCQyBmb3IgIzc4MTAKCQkJLy8gVE9ETyByZW1vdmUgZHVhbCBzdG9yYWdlCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldE5hbWUgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXRGdWxsTmFtZSApCgkJCS8vIHN1cHBvcnQ6IGpxdWVyeSA8MS42LjMKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvOTQxMwoJCQkucmVtb3ZlRGF0YSggJC5jYW1lbENhc2UoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCAiICsKCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCgkJLy8gY2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMKCQl0aGlzLmJpbmRpbmdzLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCX0sCglfZGVzdHJveTogJC5ub29wLAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleSwKCQkJcGFydHMsCgkJCWN1ck9wdGlvbiwKCQkJaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiApIHsKCQkJLy8gaGFuZGxlIG5lc3RlZCBrZXlzLCBlLmcuLCAiZm9vLmJhciIgPT4geyBmb286IHsgYmFyOiBfX18gfSB9CgkJCW9wdGlvbnMgPSB7fTsKCQkJcGFydHMgPSBrZXkuc3BsaXQoICIuIiApOwoJCQlrZXkgPSBwYXJ0cy5zaGlmdCgpOwoJCQlpZiAoIHBhcnRzLmxlbmd0aCApIHsKCQkJCWN1ck9wdGlvbiA9IG9wdGlvbnNbIGtleSBdID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zWyBrZXkgXSApOwoJCQkJZm9yICggaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGggLSAxOyBpKysgKSB7CgkJCQkJY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXSB8fCB7fTsKCQkJCQljdXJPcHRpb24gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXTsKCQkJCX0KCQkJCWtleSA9IHBhcnRzLnBvcCgpOwoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBjdXJPcHRpb25bIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogY3VyT3B0aW9uWyBrZXkgXTsKCQkJCX0KCQkJCWN1ck9wdGlvblsga2V5IF0gPSB2YWx1ZTsKCQkJfSBlbHNlIHsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IHRoaXMub3B0aW9uc1sga2V5IF07CgkJCQl9CgkJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCQl9CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5OwoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCQkJdGhpcy5fc2V0T3B0aW9uKCBrZXksIG9wdGlvbnNbIGtleSBdICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLndpZGdldCgpCgkJCQkudG9nZ2xlQ2xhc3MoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkIHVpLXN0YXRlLWRpc2FibGVkIiwgISF2YWx1ZSApCgkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCV9vbjogZnVuY3Rpb24oIHN1cHByZXNzRGlzYWJsZWRDaGVjaywgZWxlbWVudCwgaGFuZGxlcnMgKSB7CgkJdmFyIGRlbGVnYXRlRWxlbWVudCwKCQkJaW5zdGFuY2UgPSB0aGlzOwoKCQkvLyBubyBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgZmxhZywgc2h1ZmZsZSBhcmd1bWVudHMKCQlpZiAoIHR5cGVvZiBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgIT09ICJib29sZWFuIiApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gc3VwcHJlc3NEaXNhYmxlZENoZWNrOwoJCQlzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgPSBmYWxzZTsKCQl9CgoJCS8vIG5vIGVsZW1lbnQgYXJndW1lbnQsIHNodWZmbGUgYW5kIHVzZSB0aGlzLmVsZW1lbnQKCQlpZiAoICFoYW5kbGVycyApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50OwoJCQlkZWxlZ2F0ZUVsZW1lbnQgPSB0aGlzLndpZGdldCgpOwoJCX0gZWxzZSB7CgkJCS8vIGFjY2VwdCBzZWxlY3RvcnMsIERPTSBlbGVtZW50cwoJCQllbGVtZW50ID0gZGVsZWdhdGVFbGVtZW50ID0gJCggZWxlbWVudCApOwoJCQl0aGlzLmJpbmRpbmdzID0gdGhpcy5iaW5kaW5ncy5hZGQoIGVsZW1lbnQgKTsKCQl9CgoJCSQuZWFjaCggaGFuZGxlcnMsIGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlciApIHsKCQkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQkJLy8gYWxsb3cgd2lkZ2V0cyB0byBjdXN0b21pemUgdGhlIGRpc2FibGVkIGhhbmRsaW5nCgkJCQkvLyAtIGRpc2FibGVkIGFzIGFuIGFycmF5IGluc3RlYWQgb2YgYm9vbGVhbgoJCQkJLy8gLSBkaXNhYmxlZCBjbGFzcyBhcyBtZXRob2QgZm9yIGRpc2FibGluZyBpbmRpdmlkdWFsIHBhcnRzCgkJCQlpZiAoICFzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgJiYKCQkJCQkJKCBpbnN0YW5jZS5vcHRpb25zLmRpc2FibGVkID09PSB0cnVlIHx8CgkJCQkJCQkkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQkJfQoKCQkJLy8gY29weSB0aGUgZ3VpZCBzbyBkaXJlY3QgdW5iaW5kaW5nIHdvcmtzCgkJCWlmICggdHlwZW9mIGhhbmRsZXIgIT09ICJzdHJpbmciICkgewoJCQkJaGFuZGxlclByb3h5Lmd1aWQgPSBoYW5kbGVyLmd1aWQgPQoJCQkJCWhhbmRsZXIuZ3VpZCB8fCBoYW5kbGVyUHJveHkuZ3VpZCB8fCAkLmd1aWQrKzsKCQkJfQoKCQkJdmFyIG1hdGNoID0gZXZlbnQubWF0Y2goIC9eKFx3KylccyooLiopJC8gKSwKCQkJCWV2ZW50TmFtZSA9IG1hdGNoWzFdICsgaW5zdGFuY2UuZXZlbnROYW1lc3BhY2UsCgkJCQlzZWxlY3RvciA9IG1hdGNoWzJdOwoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJZGVsZWdhdGVFbGVtZW50LmRlbGVnYXRlKCBzZWxlY3RvciwgZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfSBlbHNlIHsKCQkJCWVsZW1lbnQuYmluZCggZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfQoJCX0pOwoJfSwKCglfb2ZmOiBmdW5jdGlvbiggZWxlbWVudCwgZXZlbnROYW1lICkgewoJCWV2ZW50TmFtZSA9IChldmVudE5hbWUgfHwgIiIpLnNwbGl0KCAiICIgKS5qb2luKCB0aGlzLmV2ZW50TmFtZXNwYWNlICsgIiAiICkgKyB0aGlzLmV2ZW50TmFtZXNwYWNlOwoJCWVsZW1lbnQudW5iaW5kKCBldmVudE5hbWUgKS51bmRlbGVnYXRlKCBldmVudE5hbWUgKTsKCX0sCgoJX2RlbGF5OiBmdW5jdGlvbiggaGFuZGxlciwgZGVsYXkgKSB7CgkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQl9CgkJdmFyIGluc3RhbmNlID0gdGhpczsKCQlyZXR1cm4gc2V0VGltZW91dCggaGFuZGxlclByb3h5LCBkZWxheSB8fCAwICk7Cgl9LAoKCV9ob3ZlcmFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuaG92ZXJhYmxlID0gdGhpcy5ob3ZlcmFibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJbW91c2VlbnRlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0sCgkJCW1vdXNlbGVhdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV9mb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuZm9jdXNhYmxlID0gdGhpcy5mb2N1c2FibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJZm9jdXNpbjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0sCgkJCWZvY3Vzb3V0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfQoJCX0pOwoJfSwKCglfdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGV2ZW50LCBkYXRhICkgewoJCXZhciBwcm9wLCBvcmlnLAoJCQljYWxsYmFjayA9IHRoaXMub3B0aW9uc1sgdHlwZSBdOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCQlldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CgkJZXZlbnQudHlwZSA9ICggdHlwZSA9PT0gdGhpcy53aWRnZXRFdmVudFByZWZpeCA/CgkJCXR5cGUgOgoJCQl0aGlzLndpZGdldEV2ZW50UHJlZml4ICsgdHlwZSApLnRvTG93ZXJDYXNlKCk7CgkJLy8gdGhlIG9yaWdpbmFsIGV2ZW50IG1heSBjb21lIGZyb20gYW55IGVsZW1lbnQKCQkvLyBzbyB3ZSBuZWVkIHRvIHJlc2V0IHRoZSB0YXJnZXQgb24gdGhlIG5ldyBldmVudAoJCWV2ZW50LnRhcmdldCA9IHRoaXMuZWxlbWVudFsgMCBdOwoKCQkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkJb3JpZyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7CgkJaWYgKCBvcmlnICkgewoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQlpZiAoICEoIHByb3AgaW4gZXZlbnQgKSApIHsKCQkJCQlldmVudFsgcHJvcCBdID0gb3JpZ1sgcHJvcCBdOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggZXZlbnQsIGRhdGEgKTsKCQlyZXR1cm4gISggJC5pc0Z1bmN0aW9uKCBjYWxsYmFjayApICYmCgkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLmVsZW1lbnRbMF0sIFsgZXZlbnQgXS5jb25jYXQoIGRhdGEgKSApID09PSBmYWxzZSB8fAoJCQlldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApOwoJfQp9OwoKJC5lYWNoKCB7IHNob3c6ICJmYWRlSW4iLCBoaWRlOiAiZmFkZU91dCIgfSwgZnVuY3Rpb24oIG1ldGhvZCwgZGVmYXVsdEVmZmVjdCApIHsKCSQuV2lkZ2V0LnByb3RvdHlwZVsgIl8iICsgbWV0aG9kIF0gPSBmdW5jdGlvbiggZWxlbWVudCwgb3B0aW9ucywgY2FsbGJhY2sgKSB7CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgKSB7CgkJCW9wdGlvbnMgPSB7IGVmZmVjdDogb3B0aW9ucyB9OwoJCX0KCQl2YXIgaGFzT3B0aW9ucywKCQkJZWZmZWN0TmFtZSA9ICFvcHRpb25zID8KCQkJCW1ldGhvZCA6CgkJCQlvcHRpb25zID09PSB0cnVlIHx8IHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiA/CgkJCQkJZGVmYXVsdEVmZmVjdCA6CgkJCQkJb3B0aW9ucy5lZmZlY3QgfHwgZGVmYXVsdEVmZmVjdDsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiApIHsKCQkJb3B0aW9ucyA9IHsgZHVyYXRpb246IG9wdGlvbnMgfTsKCQl9CgkJaGFzT3B0aW9ucyA9ICEkLmlzRW1wdHlPYmplY3QoIG9wdGlvbnMgKTsKCQlvcHRpb25zLmNvbXBsZXRlID0gY2FsbGJhY2s7CgkJaWYgKCBvcHRpb25zLmRlbGF5ICkgewoJCQllbGVtZW50LmRlbGF5KCBvcHRpb25zLmRlbGF5ICk7CgkJfQoJCWlmICggaGFzT3B0aW9ucyAmJiAkLmVmZmVjdHMgJiYgJC5lZmZlY3RzLmVmZmVjdFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBtZXRob2QgXSggb3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIGVmZmVjdE5hbWUgIT09IG1ldGhvZCAmJiBlbGVtZW50WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIGVmZmVjdE5hbWUgXSggb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudC5xdWV1ZShmdW5jdGlvbiggbmV4dCApIHsKCQkJCSQoIHRoaXMgKVsgbWV0aG9kIF0oKTsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7CgkJCQl9CgkJCQluZXh0KCk7CgkJCX0pOwoJCX0KCX07Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS53aWRnZXQiLCB7CgkvLyBkZWNvcmF0ZSB0aGUgcGFyZW50IF9jcmVhdGVXaWRnZXQgdG8gdHJpZ2dlciBgd2lkZ2V0aW5pdGAgZm9yIHVzZXJzCgkvLyB3aG8gd2lzaCB0byBkbyBwb3N0IHBvc3QgYHdpZGdldGNyZWF0ZWAgYWx0ZXJhdGlvbnMvYWRkaXRpb25zCgkvLwoJLy8gVE9ETyBjcmVhdGUgYSBwdWxsIHJlcXVlc3QgZm9yIGpxdWVyeSB1aSB0byB0cmlnZ2VyIHRoaXMgZXZlbnQKCS8vIGluIHRoZSBvcmlnaW5hbCBfY3JlYXRlV2lkZ2V0CglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQkkLldpZGdldC5wcm90b3R5cGUuX2NyZWF0ZVdpZGdldC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fdHJpZ2dlciggJ2luaXQnICk7Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdGlvbnMgPSB7fTsKCgkJJC5lYWNoKCB0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKCBvcHRpb24gKSB7CgoJCQl2YXIgdmFsdWUgPSBlbGVtLmpxbURhdGEoIG9wdGlvbi5yZXBsYWNlKCAvW0EtWl0vZywgZnVuY3Rpb24oIGMgKSB7CgkJCQkJCQlyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwoJCQkJCQl9KQoJCQkJCSk7CgoJCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQl9CgkJfSk7CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCgllbmhhbmNlV2l0aGluOiBmdW5jdGlvbiggdGFyZ2V0LCB1c2VLZWVwTmF0aXZlICkgewoJCXRoaXMuZW5oYW5jZSggJCggdGhpcy5vcHRpb25zLmluaXRTZWxlY3RvciwgJCggdGFyZ2V0ICkpLCB1c2VLZWVwTmF0aXZlICk7Cgl9LAoKCWVuaGFuY2U6IGZ1bmN0aW9uKCB0YXJnZXRzLCB1c2VLZWVwTmF0aXZlICkgewoJCXZhciBwYWdlLCBrZWVwTmF0aXZlLCAkd2lkZ2V0RWxlbWVudHMgPSAkKCB0YXJnZXRzICksIHNlbGYgPSB0aGlzOwoKCQkvLyBpZiBpZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgdG8gdHJ1ZSB0aGUgZnJhbWV3b3JrIHNob3VsZAoJCS8vIG9ubHkgZW5oYW5jZSB0aGUgc2VsZWN0ZWQgZWxlbWVudHMgd2hlbiB0aGV5IGRvIE5PVCBoYXZlIGEKCQkvLyBwYXJlbnQgd2l0aCB0aGUgZGF0YS1uYW1lc3BhY2UtaWdub3JlIGF0dHJpYnV0ZQoJCSR3aWRnZXRFbGVtZW50cyA9ICQubW9iaWxlLmVuaGFuY2VhYmxlKCAkd2lkZ2V0RWxlbWVudHMgKTsKCgkJaWYgKCB1c2VLZWVwTmF0aXZlICYmICR3aWRnZXRFbGVtZW50cy5sZW5ndGggKSB7CgkJCS8vIFRPRE8gcmVtb3ZlIGRlcGVuZGVuY3kgb24gdGhlIHBhZ2Ugd2lkZ2V0IGZvciB0aGUga2VlcE5hdGl2ZS4KCQkJLy8gQ3VycmVudGx5IHRoZSBrZWVwTmF0aXZlIHZhbHVlIGlzIGRlZmluZWQgb24gdGhlIHBhZ2UgcHJvdG90eXBlIHNvCgkJCS8vIHRoZSBtZXRob2QgaXMgYXMgd2VsbAoJCQlwYWdlID0gJC5tb2JpbGUuY2xvc2VzdFBhZ2VEYXRhKCAkd2lkZ2V0RWxlbWVudHMgKTsKCQkJa2VlcE5hdGl2ZSA9ICggcGFnZSAmJiBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpKSB8fCAiIjsKCgkJCSR3aWRnZXRFbGVtZW50cyA9ICR3aWRnZXRFbGVtZW50cy5ub3QoIGtlZXBOYXRpdmUgKTsKCQl9CgoJCSR3aWRnZXRFbGVtZW50c1sgdGhpcy53aWRnZXROYW1lIF0oKTsKCX0sCgoJcmFpc2U6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgIldpZGdldCBbIiArIHRoaXMud2lkZ2V0TmFtZSArICJdOiAiICsgbXNnOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCS8vIERFUFJFQ0FURUQKCS8vIE5PVEUgZ2xvYmFsIG1vYmlsZSBvYmplY3Qgc2V0dGluZ3MKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIERFUFJFQ0FURUQgU2hvdWxkIHRoZSB0ZXh0IGJlIHZpc2JsZSBpbiB0aGUgbG9hZGluZyBtZXNzYWdlPwoJCWxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGU6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRCBXaGVuIHRoZSB0ZXh0IGlzIHZpc2libGUsIHdoYXQgdGhlbWUgZG9lcyB0aGUgbG9hZGluZyBib3ggdXNlPwoJCWxvYWRpbmdNZXNzYWdlVGhlbWU6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRCBkZWZhdWx0IG1lc3NhZ2Ugc2V0dGluZwoJCWxvYWRpbmdNZXNzYWdlOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJc2hvd1BhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQkkLm1vYmlsZS5sb2FkaW5nKCAnc2hvdycsIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApOwoJCX0sCgoJCS8vIERFUFJFQ0FURUQKCQloaWRlUGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5sb2FkaW5nKCAnaGlkZScgKTsKCQl9LAoKCQlsb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5sb2FkZXJXaWRnZXQubG9hZGVyLmFwcGx5KCB0aGlzLmxvYWRlcldpZGdldCwgYXJndW1lbnRzICk7CgkJfQoJfSk7CgoJLy8gVE9ETyBtb3ZlIGxvYWRlciBjbGFzcyBkb3duIGludG8gdGhlIHdpZGdldCBzZXR0aW5ncwoJdmFyIGxvYWRlckNsYXNzID0gInVpLWxvYWRlciIsICRodG1sID0gJCggImh0bWwiICksICR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJJC53aWRnZXQoICJtb2JpbGUubG9hZGVyIiwgewoJCS8vIE5PVEUgaWYgdGhlIGdsb2JhbCBjb25maWcgc2V0dGluZ3MgYXJlIGRlZmluZWQgdGhleSB3aWxsIG92ZXJyaWRlIHRoZXNlCgkJLy8gICAgICBvcHRpb25zCgkJb3B0aW9uczogewoJCQkvLyB0aGUgdGhlbWUgZm9yIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhlbWU6ICJhIiwKCgkJCS8vIHdoZXRoZXIgdGhlIHRleHQgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZSBpcyBzaG93bgoJCQl0ZXh0VmlzaWJsZTogZmFsc2UsCgoJCQkvLyBjdXN0b20gaHRtbCBmb3IgdGhlIGlubmVyIGNvbnRlbnQgb2YgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQlodG1sOiAiIiwKCgkJCS8vIHRoZSB0ZXh0IHRvIGJlIGRpc3BsYXllZCB3aGVuIHRoZSBwb3B1cCBpcyBzaG93bgoJCQl0ZXh0OiAibG9hZGluZyIKCQl9LAoKCQlkZWZhdWx0SHRtbDogIjxkaXYgY2xhc3M9JyIgKyBsb2FkZXJDbGFzcyArICInPiIgKwoJCQkiPHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1sb2FkaW5nJz48L3NwYW4+IiArCgkJCSI8aDE+PC9oMT4iICsKCQkJIjwvZGl2PiIsCgoJCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJZmFrZUZpeExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jc3MoewoJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiAkd2luZG93LnNjcm9sbFRvcCgpICsgJHdpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQkJfSk7CgkJfSwKCgkJLy8gY2hlY2sgcG9zaXRpb24gb2YgbG9hZGVyIHRvIHNlZSBpZiBpdCBhcHBlYXJzIHRvIGJlICJmaXhlZCIgdG8gY2VudGVyCgkJLy8gaWYgbm90LCB1c2UgYWJzIHBvc2l0aW9uaW5nCgkJY2hlY2tMb2FkZXJQb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCksCgkJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKCBvZmZzZXQudG9wIC0gc2Nyb2xsVG9wICkgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJCXRoaXMuZmFrZUZpeExvYWRlcigpOwoJCQkJJHdpbmRvdwoJCQkJCS51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKQoJCQkJCS5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5mYWtlRml4TG9hZGVyLCB0aGlzICkgKTsKCQkJfQoJCX0sCgoJCXJlc2V0SHRtbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5odG1sKCAkKCB0aGlzLmRlZmF1bHRIdG1sICkuaHRtbCgpICk7CgkJfSwKCgkJLy8gVHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuIFRoZW1lIGRvdWJsZXMgYXMgYW4gb2JqZWN0IGFyZ3VtZW50CgkJLy8gd2l0aCB0aGUgZm9sbG93aW5nIHNoYXBlOiB7IHRoZW1lOiAnJywgdGV4dDogJycsIGh0bWw6ICcnLCB0ZXh0VmlzaWJsZTogJycgfQoJCS8vIE5PVEUgdGhhdCB0aGUgJC5tb2JpbGUubG9hZGluZyogc2V0dGluZ3MgYW5kIHBhcmFtcyBwYXN0IHRoZSBmaXJzdCBhcmUgZGVwcmVjYXRlZAoJCS8vIFRPRE8gc3dlZXQgamVzdXMgd2UgbmVlZCB0byBicmVhayBzb21lIG9mIHRoaXMgb3V0CgkJc2hvdzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJdmFyIHRleHRWaXNpYmxlLCBtZXNzYWdlLCAkaGVhZGVyLCBsb2FkU2V0dGluZ3M7CgoJCQl0aGlzLnJlc2V0SHRtbCgpOwoKCQkJLy8gdXNlIHRoZSBwcm90b3R5cGUgb3B0aW9ucyBzbyB0aGF0IHBlb3BsZSBjYW4gc2V0IHRoZW0gZ2xvYmFsbHkgYXQKCQkJLy8gbW9iaWxlIGluaXQuIENvbnNpc3RlbmN5LCBpdCdzIHdoYXQncyBmb3IgZGlubmVyCgkJCWlmICggJC50eXBlKHRoZW1lKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQkvLyBwcmVmZXIgb2JqZWN0IHByb3BlcnR5IGZyb20gdGhlIHBhcmFtIHRoZW4gdGhlIG9sZCB0aGVtZSBzZXR0aW5nCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lOwoJCQl9IGVsc2UgewoJCQkJbG9hZFNldHRpbmdzID0gdGhpcy5vcHRpb25zOwoKCQkJCS8vIGhlcmUgd2UgcHJlZmVyIHRoZSB0aGVtIHZhbHVlIHBhc3NlZCBhcyBhIHN0cmluZyBhcmd1bWVudCwgdGhlbgoJCQkJLy8gd2UgcHJlZmVyIHRoZSBnbG9iYWwgb3B0aW9uIGJlY2F1c2Ugd2UgY2FuJ3QgdXNlIHVuZGVmaW5lZCBkZWZhdWx0CgkJCQkvLyBwcm90b3R5cGUgb3B0aW9ucywgdGhlbiB0aGUgcHJvdG90eXBlIG9wdGlvbgoJCQkJdGhlbWUgPSB0aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSB8fCBsb2FkU2V0dGluZ3MudGV4dDsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICE9PSBmYWxzZSB8fCBsb2FkU2V0dGluZ3MuaHRtbCApIHsKCQkJCS8vIGJvb2xlYW4gdmFsdWVzIHJlcXVpcmUgYSBiaXQgbW9yZSB3b3JrIDpQLCBzdXBwb3J0cyBvYmplY3QgcHJvcGVydGllcwoJCQkJLy8gYW5kIG9sZCBzZXR0aW5ncwoJCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGV4dFZpc2libGUgPSAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOwoJCQkJfSBlbHNlIHsKCQkJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCQkJCX0KCgkJCQkvLyBhZGQgdGhlIHByb3BlciBjc3MgZ2l2ZW4gdGhlIG9wdGlvbnMgKHRoZW1lLCB0ZXh0LCBldGMpCgkJCQkvLyBGb3JjZSB0ZXh0IHZpc2liaWxpdHkgaWYgdGhlIHNlY29uZCBhcmd1bWVudCB3YXMgc3VwcGxpZWQsIG9yCgkJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCQl0aGlzLmVsZW1lbnQuYXR0cigiY2xhc3MiLCBsb2FkZXJDbGFzcyArCgkJCQkJIiB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArIHRoZW1lICsKCQkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkJKCBsb2FkU2V0dGluZ3MudGV4dG9ubHkgfHwgdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICk7CgoJCQkJLy8gVE9ETyB2ZXJpZnkgdGhhdCBqcXVlcnkuZm4uaHRtbCBpcyBvayB0byB1c2UgaW4gYm90aCBjYXNlcyBoZXJlCgkJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJCS8vIGlmIHRoZSBodG1sIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIHRoZSBsb2FkaW5nIHNldHRpbmdzLCB1c2UgdGhhdAoJCQkJLy8gb3RoZXJ3aXNlIHVzZSB0aGUgZmFsbGJhY2tzIGZyb20gYWJvdmUKCQkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIGxvYWRTZXR0aW5ncy5odG1sICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQkJfQoKCQkJCS8vIGF0dGFjaCB0aGUgbG9hZGVyIHRvIHRoZSBET00KCQkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCS8vIGNoZWNrIHRoYXQgdGhlIGxvYWRlciBpcyB2aXNpYmxlCgkJCQl0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24oKTsKCgkJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQkJfQoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCkgewoJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCX0KCgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmZha2VGaXhMb2FkZXIgKTsKCQkJJC5tb2JpbGUud2luZG93LnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApOwoJCX0KCX0pOwoKCSR3aW5kb3cuYmluZCggJ3BhZ2Vjb250YWluZXJjcmVhdGUnLCBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5sb2FkZXJXaWRnZXQgPSAkLm1vYmlsZS5sb2FkZXJXaWRnZXQgfHwgJCggJC5tb2JpbGUubG9hZGVyLnByb3RvdHlwZS5kZWZhdWx0SHRtbCApLmxvYWRlcigpOwoJfSk7Cn0pKGpRdWVyeSwgdGhpcyk7CgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjwvc2NyaXB0PicgKTsKICAgICAgICAgIAogICAgICAgICAgaWZyYW1lX2RvYy5jbG9zZSgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIElmcmFtZSdzIGhhc2gsIGZvciBncmVhdCBqdXN0aWNlLgogICAgICAgICAgaWZyYW1lLmxvY2F0aW9uLmhhc2ggPSBoYXNoOwogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICB9KSgpOwogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eIFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IF5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgCiAgICByZXR1cm4gc2VsZjsKICB9KSgpOwogIAp9KShqUXVlcnksdGhpcyk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvKiEgbWF0Y2hNZWRpYSgpIHBvbHlmaWxsIC0gVGVzdCBhIENTUyBtZWRpYSB0eXBlL3F1ZXJ5IGluIEpTLiBBdXRob3JzICYgY29weXJpZ2h0IChjKSAyMDEyOiBTY290dCBKZWhsLCBQYXVsIElyaXNoLCBOaWNob2xhcyBaYWthcy4gRHVhbCBNSVQvQlNEIGxpY2Vuc2UgKi8KCXdpbmRvdy5tYXRjaE1lZGlhID0gd2luZG93Lm1hdGNoTWVkaWEgfHwgKGZ1bmN0aW9uKCBkb2MsIHVuZGVmaW5lZCApIHsKCgkJCgoJCXZhciBib29sLAoJCQlkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudCwKCQkJcmVmTm9kZSA9IGRvY0VsZW0uZmlyc3RFbGVtZW50Q2hpbGQgfHwgZG9jRWxlbS5maXJzdENoaWxkLAoJCQkvLyBmYWtlQm9keSByZXF1aXJlZCBmb3IgPEZGNCB3aGVuIGV4ZWN1dGVkIGluIDxoZWFkPgoJCQlmYWtlQm9keSA9IGRvYy5jcmVhdGVFbGVtZW50KCAiYm9keSIgKSwKCQkJZGl2ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgoJCWRpdi5pZCA9ICJtcS10ZXN0LTEiOwoJCWRpdi5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOmFic29sdXRlO3RvcDotMTAwZW0iOwoJCWZha2VCb2R5LnN0eWxlLmJhY2tncm91bmQgPSAibm9uZSI7CgkJZmFrZUJvZHkuYXBwZW5kQ2hpbGQoZGl2KTsKCgkJcmV0dXJuIGZ1bmN0aW9uKHEpewoKCQkJZGl2LmlubmVySFRNTCA9ICImc2h5OzxzdHlsZSBtZWRpYT1cIiIgKyBxICsgIlwiPiAjbXEtdGVzdC0xIHsgd2lkdGg6IDQycHg7IH08L3N0eWxlPiI7CgoJCQlkb2NFbGVtLmluc2VydEJlZm9yZSggZmFrZUJvZHksIHJlZk5vZGUgKTsKCQkJYm9vbCA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gNDI7CgkJCWRvY0VsZW0ucmVtb3ZlQ2hpbGQoIGZha2VCb2R5ICk7CgoJCQlyZXR1cm4gewoJCQkJbWF0Y2hlczogYm9vbCwKCQkJCW1lZGlhOiBxCgkJCX07CgoJCX07CgoJfSggZG9jdW1lbnQgKSk7CgoJLy8gJC5tb2JpbGUubWVkaWEgdXNlcyBtYXRjaE1lZGlhIHRvIHJldHVybiBhIGJvb2xlYW4uCgkkLm1vYmlsZS5tZWRpYSA9IGZ1bmN0aW9uKCBxICkgewoJCXJldHVybiB3aW5kb3cubWF0Y2hNZWRpYSggcSApLm1hdGNoZXM7Cgl9OwoKfSkoalF1ZXJ5KTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgc3VwcG9ydCA9IHsKCQkJdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudAoJCX07CgoJCSQubW9iaWxlLnN1cHBvcnQgPSAkLm1vYmlsZS5zdXBwb3J0IHx8IHt9OwoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHN1cHBvcnQgKTsKCQkkLmV4dGVuZCggJC5tb2JpbGUuc3VwcG9ydCwgc3VwcG9ydCApOwoJfSggalF1ZXJ5ICkpOwoKCShmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCQkJb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIgaW4gd2luZG93ICYmICJvbm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cKCQl9KTsKCX0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gdGh4IE1vZGVybml6cgpmdW5jdGlvbiBwcm9wRXhpc3RzKCBwcm9wICkgewoJdmFyIHVjX3Byb3AgPSBwcm9wLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnN1YnN0ciggMSApLAoJCXByb3BzID0gKCBwcm9wICsgIiAiICsgdmVuZG9ycy5qb2luKCB1Y19wcm9wICsgIiAiICkgKyB1Y19wcm9wICkuc3BsaXQoICIgIiApOwoKCWZvciAoIHZhciB2IGluIHByb3BzICkgewoJCWlmICggZmJDU1NbIHByb3BzWyB2IF0gXSAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9Cn0KCnZhciBmYWtlQm9keSA9ICQoICI8Ym9keT4iICkucHJlcGVuZFRvKCAiaHRtbCIgKSwKCWZiQ1NTID0gZmFrZUJvZHlbIDAgXS5zdHlsZSwKCXZlbmRvcnMgPSBbICJXZWJraXQiLCAiTW96IiwgIk8iIF0sCgl3ZWJvcyA9ICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdywgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgc2Nyb2xsVG9wCglvcGVyYSA9IHdpbmRvdy5vcGVyYSwKCW9wZXJhbWluaSA9IHdpbmRvdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3aW5kb3cub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iLAoJYmIgPSB3aW5kb3cuYmxhY2tiZXJyeSAmJiAhcHJvcEV4aXN0cyggIi13ZWJraXQtdHJhbnNmb3JtIiApOyAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIgNSBhbmQgbG93ZXIKCgpmdW5jdGlvbiB2YWxpZFN0eWxlKCBwcm9wLCB2YWx1ZSwgY2hlY2tfdmVuZCApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApOwoJCX0sCgkJdmVuZF9wcmVmID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCWlmKCB2ZW5kID09PSAiIiApIHsKCQkJCXJldHVybiAiIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiAgIi0iICsgdmVuZC5jaGFyQXQoIDAgKS50b0xvd2VyQ2FzZSgpICsgdmVuZC5zdWJzdHIoIDEgKSArICItIjsKCQkJfQoJCX0sCgkJY2hlY2tfc3R5bGUgPSBmdW5jdGlvbiggdmVuZCApIHsKCQkJdmFyIHZlbmRfcHJvcCA9IHZlbmRfcHJlZiggdmVuZCApICsgcHJvcCArICI6ICIgKyB2YWx1ZSArICI7IiwKCQkJCXVjX3ZlbmQgPSB1YyggdmVuZCApLAoJCQkJcHJvcFN0eWxlID0gdWNfdmVuZCArICggdWNfdmVuZCA9PT0gIiIgPyBwcm9wIDogdWMoIHByb3AgKSApOwoKCQkJZGl2LnNldEF0dHJpYnV0ZSggInN0eWxlIiwgdmVuZF9wcm9wICk7CgoJCQlpZiAoICEhZGl2LnN0eWxlWyBwcm9wU3R5bGUgXSApIHsKCQkJCXJldCA9IHRydWU7CgkJCX0KCQl9LAoJCWNoZWNrX3ZlbmRzID0gY2hlY2tfdmVuZCA/IGNoZWNrX3ZlbmQgOiB2ZW5kb3JzLAoJCXJldDsKCglmb3IoIHZhciBpID0gMDsgaSA8IGNoZWNrX3ZlbmRzLmxlbmd0aDsgaSsrICkgewoJCWNoZWNrX3N0eWxlKCBjaGVja192ZW5kc1tpXSApOwoJfQoJcmV0dXJuICEhcmV0Owp9CgpmdW5jdGlvbiB0cmFuc2Zvcm0zZFRlc3QoKSB7Cgl2YXIgbXFQcm9wID0gInRyYW5zZm9ybS0zZCIsCgkJLy8gQmVjYXVzZSB0aGUgYHRyYW5zbGF0ZTNkYCB0ZXN0IGJlbG93IHRocm93cyBmYWxzZSBwb3NpdGl2ZXMgaW4gQW5kcm9pZDoKCQlyZXQgPSAkLm1vYmlsZS5tZWRpYSggIigtIiArIHZlbmRvcnMuam9pbiggIi0iICsgbXFQcm9wICsgIiksKC0iICkgKyAiLSIgKyBtcVByb3AgKyAiKSwoIiArIG1xUHJvcCArICIpIiApOwoKCWlmKCByZXQgKSB7CgkJcmV0dXJuICEhcmV0OwoJfQoKCXZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJdHJhbnNmb3JtcyA9IHsKCQkJLy8gV2XigJlyZSBvbWl0dGluZyBPcGVyYSBmb3IgdGhlIHRpbWUgYmVpbmc7IE1TIHVzZXMgdW5wcmVmaXhlZC4KCQkJJ01velRyYW5zZm9ybSc6Jy1tb3otdHJhbnNmb3JtJywKCQkJJ3RyYW5zZm9ybSc6J3RyYW5zZm9ybScKCQl9OwoKCWZha2VCb2R5LmFwcGVuZCggZWwgKTsKCglmb3IgKCB2YXIgdCBpbiB0cmFuc2Zvcm1zICkgewoJCWlmKCBlbC5zdHlsZVsgdCBdICE9PSB1bmRlZmluZWQgKXsKCQkJZWwuc3R5bGVbIHQgXSA9ICd0cmFuc2xhdGUzZCggMTAwcHgsIDFweCwgMXB4ICknOwoJCQlyZXQgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZWwgKS5nZXRQcm9wZXJ0eVZhbHVlKCB0cmFuc2Zvcm1zWyB0IF0gKTsKCQl9Cgl9CglyZXR1cm4gKCAhIXJldCAmJiByZXQgIT09ICJub25lIiApOwp9CgovLyBUZXN0IGZvciBkeW5hbWljLXVwZGF0aW5nIGJhc2UgdGFnIHN1cHBvcnQgKCBhbGxvd3MgdXMgdG8gYXZvaWQgaHJlZixzcmMgYXR0ciByZXdyaXRpbmcgKQpmdW5jdGlvbiBiYXNlVGFnVGVzdCgpIHsKCXZhciBmYXV4QmFzZSA9IGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSArICJ1aS1kaXIvIiwKCQliYXNlID0gJCggImhlYWQgYmFzZSIgKSwKCQlmYXV4RWxlID0gbnVsbCwKCQlocmVmID0gIiIsCgkJbGluaywgcmViYXNlOwoKCWlmICggIWJhc2UubGVuZ3RoICkgewoJCWJhc2UgPSBmYXV4RWxlID0gJCggIjxiYXNlPiIsIHsgImhyZWYiOiBmYXV4QmFzZSB9KS5hcHBlbmRUbyggImhlYWQiICk7Cgl9IGVsc2UgewoJCWhyZWYgPSBiYXNlLmF0dHIoICJocmVmIiApOwoJfQoKCWxpbmsgPSAkKCAiPGEgaHJlZj0ndGVzdHVybCcgLz4iICkucHJlcGVuZFRvKCBmYWtlQm9keSApOwoJcmViYXNlID0gbGlua1sgMCBdLmhyZWY7CgliYXNlWyAwIF0uaHJlZiA9IGhyZWYgfHwgbG9jYXRpb24ucGF0aG5hbWU7CgoJaWYgKCBmYXV4RWxlICkgewoJCWZhdXhFbGUucmVtb3ZlKCk7Cgl9CglyZXR1cm4gcmViYXNlLmluZGV4T2YoIGZhdXhCYXNlICkgPT09IDA7Cn0KCi8vIFRoYW5rcyBNb2Rlcm5penIKZnVuY3Rpb24gY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSB7Cgl2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICd4JyApLAoJCWRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlnZXRDb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUsCgkJc3VwcG9ydHM7CgoJaWYgKCAhKCAncG9pbnRlckV2ZW50cycgaW4gZWxlbWVudC5zdHlsZSApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnYXV0byc7CgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAneCc7Cglkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGVsZW1lbnQgKTsKCXN1cHBvcnRzID0gZ2V0Q29tcHV0ZWRTdHlsZSAmJgoJZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbWVudCwgJycgKS5wb2ludGVyRXZlbnRzID09PSAnYXV0byc7Cglkb2N1bWVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoIGVsZW1lbnQgKTsKCXJldHVybiAhIXN1cHBvcnRzOwp9CgpmdW5jdGlvbiBib3VuZGluZ1JlY3QoKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCXJldHVybiB0eXBlb2YgZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gInVuZGVmaW5lZCI7Cn0KCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5leHRlbmQoICQubW9iaWxlLCB7IGJyb3dzZXI6IHt9IH0gKTsKJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA9IChmdW5jdGlvbigpIHsKCXZhciB2ID0gMywKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCWEgPSBkaXYuYWxsIHx8IFtdOwoKCWRvIHsKCQlkaXYuaW5uZXJIVE1MID0gIjwhLS1baWYgZ3QgSUUgIiArICggKyt2ICkgKyAiXT48YnI+PCFbZW5kaWZdLS0+IjsKCX0gd2hpbGUoIGFbMF0gKTsKCglyZXR1cm4gdiA+IDQgPyB2IDogIXY7Cn0pKCk7CgpmdW5jdGlvbiBmaXhlZFBvc2l0aW9uKCkgewoJdmFyIHcgPSB3aW5kb3csCgkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLAoJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJZmZtYXRjaCA9IHVhLm1hdGNoKCAvRmVubmVjXC8oWzAtOV0rKS8gKSwKCQlmZnZlcnNpb24gPSAhIWZmbWF0Y2ggJiYgZmZtYXRjaFsgMSBdLAoJCW9wZXJhbW1vYmlsZW1hdGNoID0gdWEubWF0Y2goIC9PcGVyYSBNb2JpXC8oWzAtOV0rKS8gKSwKCQlvbXZlcnNpb24gPSAhIW9wZXJhbW1vYmlsZW1hdGNoICYmIG9wZXJhbW1vYmlsZW1hdGNoWyAxIF07CgoJaWYoCgkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCS8vIE9wZXJhIE1pbmkKCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCS8vIE1lZUdvCgkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJcmV0dXJuIHRydWU7Cn0KCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cgfHwKCQl2YWxpZFN0eWxlKCAndHJhbnNpdGlvbicsICdoZWlnaHQgMTAwbXMgbGluZWFyJywgWyAiV2Via2l0IiwgIk1veiIsICIiIF0gKSAmJgoJCSEkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICFvcGVyYSwKCgkvLyBOb3RlLCBDaHJvbWUgZm9yIGlPUyBoYXMgYW4gZXh0cmVtZWx5IHF1aXJreSBpbXBsZW1lbnRhdGlvbiBvZiBwb3BzdGF0ZS4KCS8vIFdlJ3ZlIGNob3NlbiB0byB0YWtlIHRoZSBzaG9ydGVzdCBwYXRoIHRvIGEgYnVnIGZpeCBoZXJlIGZvciBpc3N1ZSAjNTQyNgoJLy8gU2VlIHRoZSBmb2xsb3dpbmcgbGluayBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlZ2V4IGNob3NlbgoJLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hyb21lL21vYmlsZS9kb2NzL3VzZXItYWdlbnQjY2hyb21lX2Zvcl9pb3NfdXNlci1hZ2VudAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCS8vIFdoZW4gcnVubmluZyBpbnNpZGUgYSBGRiBpZnJhbWUsIGNhbGxpbmcgcmVwbGFjZVN0YXRlIGNhdXNlcyBhbiBlcnJvcgoJCSEoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJGaXJlZm94IiApID49IDAgJiYgd2luZG93LnRvcCAhPT0gd2luZG93ICkgJiYKCQkoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnNlYXJjaCgvQ3JpT1MvKSA9PT0gLTEgKSwKCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJYm94U2hhZG93OiAhIXByb3BFeGlzdHMoICJib3hTaGFkb3ciICkgJiYgIWJiLAoJZml4ZWRQb3NpdGlvbjogZml4ZWRQb3NpdGlvbigpLAoJc2Nyb2xsVG9wOiAoInBhZ2VYT2Zmc2V0IiBpbiB3aW5kb3cgfHwKCQkic2Nyb2xsVG9wIiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHwKCQkic2Nyb2xsVG9wIiBpbiBmYWtlQm9keVsgMCBdKSAmJiAhd2Vib3MgJiYgIW9wZXJhbWluaSwKCglkeW5hbWljQmFzZVRhZzogYmFzZVRhZ1Rlc3QoKSwKCWNzc1BvaW50ZXJFdmVudHM6IGNzc1BvaW50ZXJFdmVudHNUZXN0KCksCglib3VuZGluZ1JlY3Q6IGJvdW5kaW5nUmVjdCgpCn0pOwoKZmFrZUJvZHkucmVtb3ZlKCk7CgoKLy8gJC5tb2JpbGUuYWpheEJsYWNrbGlzdCBpcyB1c2VkIHRvIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMgKEJCNSwgU3ltYmlhbikKLy8gb3IgdGhhdCBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChPcGVyYSBNaW5pKQovLyBOb3RlOiBUaGlzIGRldGVjdGlvbiBiZWxvdyBpcyB1c2VkIGFzIGEgbGFzdCByZXNvcnQuCi8vIFdlIHJlY29tbWVuZCBvbmx5IHVzaW5nIHRoZXNlIGRldGVjdGlvbiBtZXRob2RzIHdoZW4gYWxsIG90aGVyIG1vcmUgcmVsaWFibGUvZm9yd2FyZC1sb29raW5nIGFwcHJvYWNoZXMgYXJlIG5vdCBwb3NzaWJsZQp2YXIgbm9raWFMVEU3XzMgPSAoZnVuY3Rpb24oKSB7CgoJdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CgoJLy9UaGUgZm9sbG93aW5nIGlzIGFuIGF0dGVtcHQgdG8gbWF0Y2ggTm9raWEgYnJvd3NlcnMgdGhhdCBhcmUgcnVubmluZyBTeW1iaWFuL3M2MCwgd2l0aCB3ZWJraXQsIHZlcnNpb24gNy4zIG9yIG9sZGVyCglyZXR1cm4gdWEuaW5kZXhPZiggIk5va2lhIiApID4gLTEgJiYKCQkJKCB1YS5pbmRleE9mKCAiU3ltYmlhbi8zIiApID4gLTEgfHwgdWEuaW5kZXhPZiggIlNlcmllczYwLzUiICkgPiAtMSApICYmCgkJCXVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICYmCgkJCXVhLm1hdGNoKCAvKEJyb3dzZXJOR3xOb2tpYUJyb3dzZXIpXC83XC5bMC0zXS8gKTsKfSkoKTsKCi8vIFN1cHBvcnQgY29uZGl0aW9ucyB0aGF0IG11c3QgYmUgbWV0IGluIG9yZGVyIHRvIHByb2NlZWQKLy8gZGVmYXVsdCBlbmhhbmNlZCBxdWFsaWZpY2F0aW9ucyBhcmUgbWVkaWEgcXVlcnkgc3VwcG9ydCBPUiBJRSA3KwoKJC5tb2JpbGUuZ3JhZGVBID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gKCAkLnN1cHBvcnQubWVkaWFxdWVyeSB8fCAkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICQubW9iaWxlLmJyb3dzZXIub2xkSUUgPj0gNyApICYmICggJC5zdXBwb3J0LmJvdW5kaW5nUmVjdCB8fCAkLmZuLmpxdWVyeS5tYXRjaCgvMVwuWzAtNytdXC5bMC05K10/LykgIT09IG51bGwgKTsKfTsKCiQubW9iaWxlLmFqYXhCbGFja2xpc3QgPQoJCQkvLyBCbGFja0JlcnJ5IGJyb3dzZXJzLCBwcmUtd2Via2l0CgkJCXdpbmRvdy5ibGFja2JlcnJ5ICYmICF3aW5kb3cuV2ViS2l0UG9pbnQgfHwKCQkJLy8gT3BlcmEgTWluaQoJCQlvcGVyYW1pbmkgfHwKCQkJLy8gU3ltYmlhbiB3ZWJraXRzIHByZSA3LjMKCQkJbm9raWFMVEU3XzM7CgovLyBMYXN0bHksIHRoaXMgd29ya2Fyb3VuZCBpcyB0aGUgb25seSB3YXkgd2UndmUgZm91bmQgc28gZmFyIHRvIGdldCBwcmUgNy4zIFN5bWJpYW4gd2Via2l0IGRldmljZXMKLy8gdG8gcmVuZGVyIHRoZSBzdHlsZXNoZWV0cyB3aGVuIHRoZXkncmUgcmVmZXJlbmNlZCBiZWZvcmUgdGhpcyBzY3JpcHQsIGFzIHdlJ2QgcmVjb21tZW5kIGRvaW5nLgovLyBUaGlzIHNpbXBseSByZWFwcGVuZHMgdGhlIENTUyBpbiBwbGFjZSwgd2hpY2ggZm9yIHNvbWUgcmVhc29uIG1ha2VzIGl0IGFwcGx5CmlmICggbm9raWFMVEU3XzMgKSB7CgkkKGZ1bmN0aW9uKCkgewoJCSQoICJoZWFkIGxpbmtbcmVsPSdzdHlsZXNoZWV0J10iICkuYXR0ciggInJlbCIsICJhbHRlcm5hdGUgc3R5bGVzaGVldCIgKS5hdHRyKCAicmVsIiwgInN0eWxlc2hlZXQiICk7Cgl9KTsKfQoKLy8gRm9yIHJ1bGluZyBvdXQgc2hhZG93cyB2aWEgY3NzCmlmICggISQuc3VwcG9ydC5ib3hTaGFkb3cgKSB7CgkkKCAiaHRtbCIgKS5hZGRDbGFzcyggInVpLW1vYmlsZS1ub3N1cHBvcnQtYm94c2hhZG93IiApOwp9Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdywgc2VsZiwgaGlzdG9yeTsKCgkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUgPSBzZWxmID0gewoJCWJvdW5kOiBmYWxzZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJb3JpZ2luYWxFdmVudE5hbWU6IHVuZGVmaW5lZCwKCgkJLy8gSWYgcHVzaHN0YXRlIHN1cHBvcnQgaXMgcHJlc2VudCBhbmQgcHVzaCBzdGF0ZSBzdXBwb3J0IGlzIGRlZmluZWQgdG8KCQkvLyBiZSB0cnVlIG9uIHRoZSBtb2JpbGUgbmFtZXNwYWNlLgoJCWlzUHVzaFN0YXRlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLnN1cHBvcnQucHVzaFN0YXRlICYmCgkJCQkkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkID09PSB0cnVlICYmCgkJCQl0aGlzLmlzSGFzaENoYW5nZUVuYWJsZWQoKTsKCQl9LAoKCQkvLyAhISBhc3N1bWVzIG1vYmlsZSBuYW1lc3BhY2UgaXMgcHJlc2VudAoJCWlzSGFzaENoYW5nZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJLy8gVE9ETyBhIGxvdCBvZiBkdXBsaWNhdGlvbiBiZXR3ZWVuIHBvcHN0YXRlIGFuZCBoYXNoY2hhbmdlCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIG5ld0V2ZW50ID0gbmV3ICQuRXZlbnQoICJuYXZpZ2F0ZSIgKSwKCQkJCWJlZm9yZU5hdmlnYXRlID0gbmV3ICQuRXZlbnQoICJiZWZvcmVuYXZpZ2F0ZSIgKSwKCQkJCXN0YXRlID0gZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fSwKCQkJCWhyZWYgPSBsb2NhdGlvbi5ocmVmOwoKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmKCBldmVudC5oaXN0b3J5U3RhdGUgKXsKCQkJCSQuZXh0ZW5kKHN0YXRlLCBldmVudC5oaXN0b3J5U3RhdGUpOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gTk9URSB3ZSBsZXQgdGhlIGN1cnJlbnQgc3RhY2sgdW53aW5kIGJlY2F1c2UgYW55IGFzc2lnbm1lbnQgdG8KCQkJLy8gICAgICBsb2NhdGlvbi5oYXNoIHdpbGwgc3RvcCB0aGUgd29ybGQgYW5kIHJ1biB0aGlzIGV2ZW50IGhhbmRsZXIuIEJ5CgkJCS8vICAgICAgZG9pbmcgdGhpcyB3ZSBjcmVhdGUgYSBzaW1pbGFyIGJlaGF2aW9yIHRvIGhhc2hjaGFuZ2Ugb24gaGFzaAoJCQkvLyAgICAgIGFzc2lnbm1lbnQKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCQlzdGF0ZTogc3RhdGUKCQkJCX0pOwoJCQl9LCAwKTsKCQl9LAoKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQsIGRhdGEgKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICk7CgoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIFRyaWdnZXIgdGhlIGhhc2hjaGFuZ2Ugd2l0aCBzdGF0ZSBwcm92aWRlZCBieSB0aGUgdXNlcgoJCQkvLyB0aGF0IGFsdGVyZWQgdGhlIGhhc2gKCQkJJHdpbi50cmlnZ2VyKCBuZXdFdmVudCwgewoJCQkJLy8gVXNlcnMgdGhhdCB3YW50IHRvIGZ1bGx5IG5vcm1hbGl6ZSB0aGUgdHdvIGV2ZW50cwoJCQkJLy8gd2lsbCBuZWVkIHRvIGRvIGhpc3RvcnkgbWFuYWdlbWVudCBkb3duIHRoZSBzdGFjayBhbmQKCQkJCS8vIGFkZCB0aGUgc3RhdGUgdG8gdGhlIGV2ZW50IGJlZm9yZSB0aGlzIGJpbmRpbmcgaXMgZmlyZWQKCQkJCS8vIFRPRE8gY29uc2lkZXIgYWxsb3dpbmcgZm9yIHRoZSBleHBsaWNpdCBhZGRpdGlvbiBvZiBjYWxsYmFja3MKCQkJCS8vICAgICAgdG8gYmUgZmlyZWQgYmVmb3JlIHRoaXMgdmFsdWUgaXMgc2V0IHRvIGF2b2lkIGV2ZW50IHRpbWluZyBpc3N1ZXMKCQkJCXN0YXRlOiBldmVudC5oYXNoY2hhbmdlU3RhdGUgfHwge30KCQkJfSk7CgkJfSwKCgkJLy8gVE9ETyBXZSByZWFsbHkgb25seSB3YW50IHRvIHNldCB0aGlzIHVwIG9uY2UKCQkvLyAgICAgIGJ1dCBJJ20gbm90IGNsZWFyIGlmIHRoZXJlJ3MgYSBiZXRlciB3YXkgdG8gYWNoaWV2ZQoJCS8vICAgICAgdGhpcyB3aXRoIHRoZSBqUXVlcnkgc3BlY2lhbCBldmVudCBzdHJ1Y3R1cmUKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZXMgKSB7CgkJCWlmKCBzZWxmLmJvdW5kICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlzZWxmLmJvdW5kID0gdHJ1ZTsKCgkJCWlmKCBzZWxmLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJwb3BzdGF0ZSI7CgkJCQkkd2luLmJpbmQoICJwb3BzdGF0ZS5uYXZpZ2F0ZSIsIHNlbGYucG9wc3RhdGUgKTsKCQkJfSBlbHNlIGlmICggc2VsZi5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgKXsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAiaGFzaGNoYW5nZSI7CgkJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlLm5hdmlnYXRlIiwgc2VsZi5oYXNoY2hhbmdlICk7CgkJCX0KCQl9Cgl9Owp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCXZhciBwYXRoLCBkb2N1bWVudEJhc2UsICRiYXNlLCBkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciOwoKCQkkLm1vYmlsZS5wYXRoID0gcGF0aCA9IHsKCQkJdWlTdGF0ZUtleTogIiZ1aS1zdGF0ZSIsCgoJCQkvLyBUaGlzIHNjYXJ5IGxvb2tpbmcgcmVndWxhciBleHByZXNzaW9uIHBhcnNlcyBhbiBhYnNvbHV0ZSBVUkwgb3IgaXRzIHJlbGF0aXZlCgkJCS8vIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBhbmQgaGFzaCksIGludG8gdGhlIHZhcmlvdXMKCQkJLy8gY29tcG9uZW50cyAocHJvdG9jb2wsIGhvc3QsIHBhdGgsIHF1ZXJ5LCBmcmFnbWVudCwgZXRjIHRoYXQgbWFrZSB1cCB0aGUKCQkJLy8gVVJMIGFzIHdlbGwgYXMgc29tZSBvdGhlciBjb21tb25seSB1c2VkIHN1Yi1wYXJ0cy4gV2hlbiB1c2VkIHdpdGggUmVnRXhwLmV4ZWMoKQoJCQkvLyBvciBTdHJpbmcubWF0Y2gsIGl0IHBhcnNlcyB0aGUgVVJMIGludG8gYSByZXN1bHRzIGFycmF5IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoJCQkvLwoJCQkvLyAgICAgWzBdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQjbXNnLWNvbnRlbnQKCQkJLy8gICAgIFsxXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgICBbMl06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveAoJCQkvLyAgICAgWzNdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbNF06IGh0dHA6CgkJCS8vICAgICBbNV06IC8vCgkJCS8vICAgICBbNl06IGpibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzddOiBqYmxhczpwYXNzd29yZAoJCQkvLyAgICAgWzhdOiBqYmxhcwoJCQkvLyAgICAgWzldOiBwYXNzd29yZAoJCQkvLyAgICBbMTBdOiBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgWzExXTogbXljb21wYW55LmNvbQoJCQkvLyAgICBbMTJdOiA4MDgwCgkJCS8vICAgIFsxM106IC9tYWlsL2luYm94CgkJCS8vICAgIFsxNF06IC9tYWlsLwoJCQkvLyAgICBbMTVdOiBpbmJveAoJCQkvLyAgICBbMTZdOiA/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgWzE3XTogI21zZy1jb250ZW50CgkJCS8vCgkJCXVybFBhcnNlUkU6IC9eXHMqKCgoKFteOlwvI1w/XSs6KT8oPzooXC9cLykoKD86KChbXjpAXC8jXD9dKykoPzpcOihbXjpAXC8jXD9dKykpPylAKT8oKFteOlwvI1w/XF1cW10rfFxbW15cL1xdQCM/XStcXSkoPzpcOihbMC05XSspKT8pKT8pPyk/KChcLz8oPzpbXlwvXD8jXStcLyspKikoW15cPyNdKikpKT8oXD9bXiNdKyk/KSgjLiopPy8sCgoJCQkvLyBBYnN0cmFjdGlvbiB0byBhZGRyZXNzIHhzcyAoSXNzdWUgIzQ3ODcpIGJ5IHJlbW92aW5nIHRoZSBhdXRob3JpdHkgaW4KCQkJLy8gYnJvd3NlcnMgdGhhdCBhdXRvCWRlY29kZSBpdC4gQWxsIHJlZmVyZW5jZXMgdG8gbG9jYXRpb24uaHJlZiBzaG91bGQgYmUKCQkJLy8gcmVwbGFjZWQgd2l0aCBhIGNhbGwgdG8gdGhpcyBtZXRob2Qgc28gdGhhdCBpdCBjYW4gYmUgZGVhbHQgd2l0aCBwcm9wZXJseSBoZXJlCgkJCWdldExvY2F0aW9uOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHVyaSA9IHVybCA/IHRoaXMucGFyc2VVcmwoIHVybCApIDogbG9jYXRpb24sCgkJCQkJaGFzaCA9IHRoaXMucGFyc2VVcmwoIHVybCB8fCBsb2NhdGlvbi5ocmVmICkuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCS8vIE1ha2Ugc3VyZSB0byBwYXJzZSB0aGUgdXJsIG9yIHRoZSBsb2NhdGlvbiBvYmplY3QgZm9yIHRoZSBoYXNoIGJlY2F1c2UgdXNpbmcgbG9jYXRpb24uaGFzaAoJCQkJLy8gaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbSB0aGUgb2JqZWN0IChsb2NhdGlvbiB1bmxlc3MKCQkJCS8vIHdlJ3JlIHRlc3RpbmcpIHRvIGF2b2lkIHRoZSBpbmNsdXNpb24gb2YgdGhlIGF1dGhvcml0eQoJCQkJcmV0dXJuIHVyaS5wcm90b2NvbCArICIvLyIgKyB1cmkuaG9zdCArIHVyaS5wYXRobmFtZSArIHVyaS5zZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJcGFyc2VMb2NhdGlvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5wYXJzZVVybCggdGhpcy5nZXRMb2NhdGlvbigpICk7CgkJCX0sCgoJCQkvL1BhcnNlIGEgVVJMIGludG8gYSBzdHJ1Y3R1cmUgdGhhdCBhbGxvd3MgZWFzeSBhY2Nlc3MgdG8KCQkJLy9hbGwgb2YgdGhlIFVSTCBjb21wb25lbnRzIGJ5IG5hbWUuCgkJCXBhcnNlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gSWYgd2UncmUgcGFzc2VkIGFuIG9iamVjdCwgd2UnbGwgYXNzdW1lIHRoYXQgaXQgaXMKCQkJCS8vIGEgcGFyc2VkIHVybCBvYmplY3QgYW5kIGp1c3QgcmV0dXJuIGl0IGJhY2sgdG8gdGhlIGNhbGxlci4KCQkJCWlmICggJC50eXBlKCB1cmwgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQkJcmV0dXJuIHVybDsKCQkJCX0KCgkJCQl2YXIgbWF0Y2hlcyA9IHBhdGgudXJsUGFyc2VSRS5leGVjKCB1cmwgfHwgIiIgKSB8fCBbXTsKCgkJCQkJLy8gQ3JlYXRlIGFuIG9iamVjdCB0aGF0IGFsbG93cyB0aGUgY2FsbGVyIHRvIGFjY2VzcyB0aGUgc3ViLW1hdGNoZXMKCQkJCQkvLyBieSBuYW1lLiBOb3RlIHRoYXQgSUUgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiB1bmRlZmluZWQsCgkJCQkJLy8gbGlrZSBhbGwgb3RoZXIgYnJvd3NlcnMgZG8sIHNvIHdlIG5vcm1hbGl6ZSBldmVyeXRoaW5nIHNvIGl0cyBjb25zaXN0ZW50CgkJCQkJLy8gbm8gbWF0dGVyIHdoYXQgYnJvd3NlciB3ZSdyZSBydW5uaW5nIG9uLgoJCQkJCXJldHVybiB7CgkJCQkJCWhyZWY6ICAgICAgICAgbWF0Y2hlc1sgIDAgXSB8fCAiIiwKCQkJCQkJaHJlZk5vSGFzaDogICBtYXRjaGVzWyAgMSBdIHx8ICIiLAoJCQkJCQlocmVmTm9TZWFyY2g6IG1hdGNoZXNbICAyIF0gfHwgIiIsCgkJCQkJCWRvbWFpbjogICAgICAgbWF0Y2hlc1sgIDMgXSB8fCAiIiwKCQkJCQkJcHJvdG9jb2w6ICAgICBtYXRjaGVzWyAgNCBdIHx8ICIiLAoJCQkJCQlkb3VibGVTbGFzaDogIG1hdGNoZXNbICA1IF0gfHwgIiIsCgkJCQkJCWF1dGhvcml0eTogICAgbWF0Y2hlc1sgIDYgXSB8fCAiIiwKCQkJCQkJdXNlcm5hbWU6ICAgICBtYXRjaGVzWyAgOCBdIHx8ICIiLAoJCQkJCQlwYXNzd29yZDogICAgIG1hdGNoZXNbICA5IF0gfHwgIiIsCgkJCQkJCWhvc3Q6ICAgICAgICAgbWF0Y2hlc1sgMTAgXSB8fCAiIiwKCQkJCQkJaG9zdG5hbWU6ICAgICBtYXRjaGVzWyAxMSBdIHx8ICIiLAoJCQkJCQlwb3J0OiAgICAgICAgIG1hdGNoZXNbIDEyIF0gfHwgIiIsCgkJCQkJCXBhdGhuYW1lOiAgICAgbWF0Y2hlc1sgMTMgXSB8fCAiIiwKCQkJCQkJZGlyZWN0b3J5OiAgICBtYXRjaGVzWyAxNCBdIHx8ICIiLAoJCQkJCQlmaWxlbmFtZTogICAgIG1hdGNoZXNbIDE1IF0gfHwgIiIsCgkJCQkJCXNlYXJjaDogICAgICAgbWF0Y2hlc1sgMTYgXSB8fCAiIiwKCQkJCQkJaGFzaDogICAgICAgICBtYXRjaGVzWyAxNyBdIHx8ICIiCgkJCQkJfTsKCQkJfSwKCgkJCS8vVHVybiByZWxQYXRoIGludG8gYW4gYXNib2x1dGUgcGF0aC4gYWJzUGF0aCBpcwoJCQkvL2FuIG9wdGlvbmFsIGFic29sdXRlIHBhdGggd2hpY2ggZGVzY3JpYmVzIHdoYXQKCQkJLy9yZWxQYXRoIGlzIHJlbGF0aXZlIHRvLgoJCQltYWtlUGF0aEFic29sdXRlOiBmdW5jdGlvbiggcmVsUGF0aCwgYWJzUGF0aCApIHsKCQkJCWlmICggcmVsUGF0aCAmJiByZWxQYXRoLmNoYXJBdCggMCApID09PSAiLyIgKSB7CgkJCQkJcmV0dXJuIHJlbFBhdGg7CgkJCQl9CgoJCQkJcmVsUGF0aCA9IHJlbFBhdGggfHwgIiI7CgkJCQlhYnNQYXRoID0gYWJzUGF0aCA/IGFic1BhdGgucmVwbGFjZSggL15cL3woXC9bXlwvXSp8W15cL10rKSQvZywgIiIgKSA6ICIiOwoKCQkJCXZhciBhYnNTdGFjayA9IGFic1BhdGggPyBhYnNQYXRoLnNwbGl0KCAiLyIgKSA6IFtdLAoJCQkJCXJlbFN0YWNrID0gcmVsUGF0aC5zcGxpdCggIi8iICk7CgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCByZWxTdGFjay5sZW5ndGg7IGkrKyApIHsKCQkJCQl2YXIgZCA9IHJlbFN0YWNrWyBpIF07CgkJCQkJc3dpdGNoICggZCApIHsKCQkJCQkJY2FzZSAiLiI6CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiLi4iOgoJCQkJCQkJaWYgKCBhYnNTdGFjay5sZW5ndGggKSB7CgkJCQkJCQkJYWJzU3RhY2sucG9wKCk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCWFic1N0YWNrLnB1c2goIGQgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAiLyIgKyBhYnNTdGFjay5qb2luKCAiLyIgKTsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGlmIGJvdGggdXJscyBoYXZlIHRoZSBzYW1lIGRvbWFpbi4KCQkJaXNTYW1lRG9tYWluOiBmdW5jdGlvbiggYWJzVXJsMSwgYWJzVXJsMiApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCBhYnNVcmwxICkuZG9tYWluID09PSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwyICkuZG9tYWluOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFueSByZWxhdGl2ZSB2YXJpYW50LgoJCQlpc1JlbGF0aXZlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gQWxsIHJlbGF0aXZlIFVybCB2YXJpYW50cyBoYXZlIG9uZSB0aGluZyBpbiBjb21tb24sIG5vIHByb3RvY29sLgoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sID09PSAiIjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbiBhYnNvbHV0ZSB1cmwuCgkJCWlzQWJzb2x1dGVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgIT09ICIiOwoJCQl9LAoKCQkJLy9UdXJuIHRoZSBzcGVjaWZpZWQgcmVhbHRpdmUgVVJMIGludG8gYW4gYWJzb2x1dGUgb25lLiBUaGlzIGZ1bmN0aW9uCgkJCS8vY2FuIGhhbmRsZSBhbGwgcmVsYXRpdmUgdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGZyYWdtZW50KS4KCQkJbWFrZVVybEFic29sdXRlOiBmdW5jdGlvbiggcmVsVXJsLCBhYnNVcmwgKSB7CgkJCQlpZiAoICFwYXRoLmlzUmVsYXRpdmVVcmwoIHJlbFVybCApICkgewoJCQkJCXJldHVybiByZWxVcmw7CgkJCQl9CgoJCQkJaWYgKCBhYnNVcmwgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlhYnNVcmwgPSB0aGlzLmRvY3VtZW50QmFzZTsKCQkJCX0KCgkJCQl2YXIgcmVsT2JqID0gcGF0aC5wYXJzZVVybCggcmVsVXJsICksCgkJCQkJYWJzT2JqID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICksCgkJCQkJcHJvdG9jb2wgPSByZWxPYmoucHJvdG9jb2wgfHwgYWJzT2JqLnByb3RvY29sLAoJCQkJCWRvdWJsZVNsYXNoID0gcmVsT2JqLnByb3RvY29sID8gcmVsT2JqLmRvdWJsZVNsYXNoIDogKCByZWxPYmouZG91YmxlU2xhc2ggfHwgYWJzT2JqLmRvdWJsZVNsYXNoICksCgkJCQkJYXV0aG9yaXR5ID0gcmVsT2JqLmF1dGhvcml0eSB8fCBhYnNPYmouYXV0aG9yaXR5LAoJCQkJCWhhc1BhdGggPSByZWxPYmoucGF0aG5hbWUgIT09ICIiLAoJCQkJCXBhdGhuYW1lID0gcGF0aC5tYWtlUGF0aEFic29sdXRlKCByZWxPYmoucGF0aG5hbWUgfHwgYWJzT2JqLmZpbGVuYW1lLCBhYnNPYmoucGF0aG5hbWUgKSwKCQkJCQlzZWFyY2ggPSByZWxPYmouc2VhcmNoIHx8ICggIWhhc1BhdGggJiYgYWJzT2JqLnNlYXJjaCApIHx8ICIiLAoJCQkJCWhhc2ggPSByZWxPYmouaGFzaDsKCgkJCQlyZXR1cm4gcHJvdG9jb2wgKyBkb3VibGVTbGFzaCArIGF1dGhvcml0eSArIHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCS8vQWRkIHNlYXJjaCAoYWthIHF1ZXJ5KSBwYXJhbXMgdG8gdGhlIHNwZWNpZmllZCB1cmwuCgkJCWFkZFNlYXJjaFBhcmFtczogZnVuY3Rpb24oIHVybCwgcGFyYW1zICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwID0gKCB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApID8gJC5wYXJhbSggcGFyYW1zICkgOiBwYXJhbXMsCgkJCQkJcyA9IHUuc2VhcmNoIHx8ICI/IjsKCQkJCXJldHVybiB1LmhyZWZOb1NlYXJjaCArIHMgKyAoIHMuY2hhckF0KCBzLmxlbmd0aCAtIDEgKSAhPT0gIj8iID8gIiYiIDogIiIgKSArIHAgKyAoIHUuaGFzaCB8fCAiIiApOwoJCQl9LAoKCQkJY29udmVydFVybFRvRGF0YVVybDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICk7CgkJCQlpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIHUgKSApIHsKCQkJCQkvLyBGb3IgZW1iZWRkZWQgcGFnZXMsIHJlbW92ZSB0aGUgZGlhbG9nIGhhc2gga2V5IGFzIGluIGdldEZpbGVQYXRoKCksCgkJCQkJLy8gYW5kIHJlbW92ZSBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoCgkJCQkJCS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdCgkJCQkJCS5yZXBsYWNlKCAvXiMvLCAiIiApCgkJCQkJCS5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1NhbWVEb21haW4oIHUsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSB7CgkJCQkJcmV0dXJuIHUuaHJlZk5vSGFzaC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJCX0KCgkJCQlyZXR1cm4gd2luZG93LmRlY29kZVVSSUNvbXBvbmVudChhYnNVcmwpOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYgKCBuZXdQYXRoID09PSB1bmRlZmluZWQgKSB7CgkJCQkJbmV3UGF0aCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCQl9CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIG5ld1BhdGggKS5yZXBsYWNlKCAvW15cL10qXC5bXlwvKl0rJC8sICcnICk7CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKTsKCQkJfSwKCgkJCS8vanVzdCByZXR1cm4gdGhlIHVybCB3aXRob3V0IGFuIGluaXRpYWwgIwoJCQlzdHJpcEhhc2g6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCX0sCgoJCQlzdHJpcFF1ZXJ5UGFyYW1zOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJaXNIYXNoVmFsaWQ6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuICggL14jW14jXSskLyApLnRlc3QoIGhhc2ggKTsKCQkJfSwKCgkJCS8vY2hlY2sgd2hldGhlciBhIHVybCBpcyByZWZlcmVuY2luZyB0aGUgc2FtZSBkb21haW4sIG9yIGFuIGV4dGVybmFsIGRvbWFpbiBvciBkaWZmZXJlbnQgcHJvdG9jb2wKCQkJLy9jb3VsZCBiZSBtYWlsdG8sIGV0YwoJCQlpc0V4dGVybmFsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCQkJCXJldHVybiB1LnByb3RvY29sICYmIHUuZG9tYWluICE9PSB0aGlzLmRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgdGhpcy5kb2N1bWVudFVybCBhbmQgdGhlIGRvY3VtZW50QmFzZS4gVGhlIG1haW4gcmVhc29uIGZvciB0aGlzCgkJCQkvL2lzIHRoYXQgbGlua3MgZW1iZWRkZWQgd2l0aGluIGV4dGVybmFsIGRvY3VtZW50cyB3aWxsIHJlZmVyIHRvIHRoZQoJCQkJLy9hcHBsaWNhdGlvbiBkb2N1bWVudCwgd2hlcmVhcyBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gdGhlIGFwcGxpY2F0aW9uCgkJCQkvL2RvY3VtZW50IHdpbGwgYmUgcmVzb2x2ZWQgYWdhaW5zdCB0aGUgZG9jdW1lbnQgYmFzZS4KCQkJCWlmICggdS5wcm90b2NvbCAhPT0gIiIgKSB7CgkJCQkJcmV0dXJuICggIXRoaXMuaXNQYXRoKHUuaGFzaCkgJiYgdS5oYXNoICYmICggdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwgKCB0aGlzLmRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgKSApOwoJCQkJfQoJCQkJcmV0dXJuICggL14jLyApLnRlc3QoIHUuaHJlZiApOwoJCQl9LAoKCQkJc3F1YXNoOiBmdW5jdGlvbiggdXJsLCByZXNvbHV0aW9uVXJsICkgewoJCQkJdmFyIHN0YXRlLCBocmVmLCBjbGVhbmVkVXJsLCBzZWFyY2gsIHN0YXRlSW5kZXgsCgkJCQkJaXNQYXRoID0gdGhpcy5pc1BhdGgoIHVybCApLAoJCQkJCXVyaSA9IHRoaXMucGFyc2VVcmwoIHVybCApLAoJCQkJCXByZXNlcnZlZEhhc2ggPSB1cmkuaGFzaCwKCQkJCQl1aVN0YXRlID0gIiI7CgoJCQkJLy8gcHJvZHVjZSBhIHVybCBhZ2FpbnN0IHdoaWNoIHdlIGNhbiByZXNvbGUgdGhlIHByb3ZpZGVkIHBhdGgKCQkJCXJlc29sdXRpb25VcmwgPSByZXNvbHV0aW9uVXJsIHx8IChwYXRoLmlzUGF0aCh1cmwpID8gcGF0aC5nZXRMb2NhdGlvbigpIDogcGF0aC5nZXREb2N1bWVudFVybCgpKTsKCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGFueXRoaW5nIGJ1dCBhIHNpbXBsZSBzdHJpbmcsIHJlbW92ZSBhbnkgcHJlY2VkaW5nIGhhc2gKCQkJCS8vIGVnICNmb28vYmFyIC0+IGZvby9iYXIKCQkJCS8vICAgICNmb28gLT4gI2ZvbwoJCQkJY2xlYW5lZFVybCA9IGlzUGF0aCA/IHBhdGguc3RyaXBIYXNoKCB1cmwgKSA6IHVybDsKCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGEgZnVsbCB1cmwgd2l0aCBhIGhhc2ggY2hlY2sgaWYgdGhlIHBhcnNlZCBoYXNoIGlzIGEgcGF0aAoJCQkJLy8gaWYgaXQgaXMsIHN0cmlwIHRoZSAjLCBhbmQgdXNlIGl0IG90aGVyd2lzZSBjb250aW51ZSB3aXRob3V0IGNoYW5nZQoJCQkJY2xlYW5lZFVybCA9IHBhdGguaXNQYXRoKCB1cmkuaGFzaCApID8gcGF0aC5zdHJpcEhhc2goIHVyaS5oYXNoICkgOiBjbGVhbmVkVXJsOwoKCQkJCS8vIFNwbGl0IHRoZSBVSSBTdGF0ZSBrZXlzIG9mZiB0aGUgaHJlZgoJCQkJc3RhdGVJbmRleCA9IGNsZWFuZWRVcmwuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICk7CgoJCQkJLy8gc3RvcmUgdGhlIHVpIHN0YXRlIGtleXMgZm9yIHVzZQoJCQkJaWYoIHN0YXRlSW5kZXggPiAtMSApewoJCQkJCXVpU3RhdGUgPSBjbGVhbmVkVXJsLnNsaWNlKCBzdGF0ZUluZGV4ICk7CgkJCQkJY2xlYW5lZFVybCA9IGNsZWFuZWRVcmwuc2xpY2UoIDAsIHN0YXRlSW5kZXggKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHRoZSBjbGVhbmVkVXJsIGFic29sdXRlIHJlbGF0aXZlIHRvIHRoZSByZXNvbHV0aW9uIHVybAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBjbGVhbmVkVXJsLCByZXNvbHV0aW9uVXJsICk7CgoJCQkJLy8gZ3JhYiB0aGUgc2VhcmNoIGZyb20gdGhlIHJlc29sdmVkIHVybCBzaW5jZSBwYXJzaW5nIGZyb20KCQkJCS8vIHRoZSBwYXNzZWQgdXJsIG1heSBub3QgeWllbGQgdGhlIGNvcnJlY3QgcmVzdWx0CgkJCQlzZWFyY2ggPSB0aGlzLnBhcnNlVXJsKCBocmVmICkuc2VhcmNoOwoKCQkJCS8vIFRPRE8gYWxsIHRoaXMgY3JhcCBpcyB0ZXJyaWJsZSwgY2xlYW4gaXQgdXAKCQkJCWlmICggaXNQYXRoICkgewoJCQkJCS8vIHJlamVjdCB0aGUgaGFzaCBpZiBpdCdzIGEgcGF0aCBvciBpdCdzIGp1c3QgYSBkaWFsb2cga2V5CgkJCQkJaWYoIHBhdGguaXNQYXRoKCBwcmVzZXJ2ZWRIYXNoICkgfHwgcHJlc2VydmVkSGFzaC5yZXBsYWNlKCIjIiwgIiIpLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAwKSB7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIjsKCQkJCQl9CgoJCQkJCS8vIEFwcGVuZCB0aGUgVUkgU3RhdGUga2V5cyB3aGVyZSBpdCBleGlzdHMgYW5kIGl0J3MgYmVlbiByZW1vdmVkCgkJCQkJLy8gZnJvbSB0aGUgdXJsCgkJCQkJaWYoIHVpU3RhdGUgJiYgcHJlc2VydmVkSGFzaC5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gLTEpewoJCQkJCQlwcmVzZXJ2ZWRIYXNoICs9IHVpU3RhdGU7CgkJCQkJfQoKCQkJCQkvLyBtYWtlIHN1cmUgdGhhdCBwb3VuZCBpcyBvbiB0aGUgZnJvbnQgb2YgdGhlIGhhc2gKCQkJCQlpZiggcHJlc2VydmVkSGFzaC5pbmRleE9mKCAiIyIgKSA9PT0gLTEgJiYgcHJlc2VydmVkSGFzaCAhPT0gIiIgKXsKCQkJCQkJcHJlc2VydmVkSGFzaCA9ICIjIiArIHByZXNlcnZlZEhhc2g7CgkJCQkJfQoKCQkJCQkvLyByZWNvbnN0cnVjdCBlYWNoIG9mIHRoZSBwaWVjZXMgd2l0aCB0aGUgbmV3IHNlYXJjaCBzdHJpbmcgYW5kIGhhc2gKCQkJCQlocmVmID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJCWhyZWYgPSBocmVmLnByb3RvY29sICsgIi8vIiArIGhyZWYuaG9zdCArIGhyZWYucGF0aG5hbWUgKyBzZWFyY2ggKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJfSBlbHNlIHsKCQkJCQlocmVmICs9IGhyZWYuaW5kZXhPZiggIiMiICkgPiAtMSA/IHVpU3RhdGUgOiAiIyIgKyB1aVN0YXRlOwoJCQkJfQoKCQkJCXJldHVybiBocmVmOwoJCQl9LAoKCQkJaXNQcmVzZXJ2YWJsZUhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIGhhc2gucmVwbGFjZSggIiMiLCAiIiApLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAwOwoJCQl9CgkJfTsKCgkJcGF0aC5kb2N1bWVudFVybCA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkkYmFzZSA9ICQoICJoZWFkIiApLmZpbmQoICJiYXNlIiApOwoKCQlwYXRoLmRvY3VtZW50QmFzZSA9ICRiYXNlLmxlbmd0aCA/CgkJCXBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCAkYmFzZS5hdHRyKCAiaHJlZiIgKSwgcGF0aC5kb2N1bWVudFVybC5ocmVmICkgKSA6CgkJCXBhdGguZG9jdW1lbnRVcmw7CgoJCXBhdGguZG9jdW1lbnRCYXNlRGlmZmVycyA9IChwYXRoLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggIT09IHBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2gpOwoKCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkJcGF0aC5nZXREb2N1bWVudFVybCA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50VXJsICkgOiBwYXRoLmRvY3VtZW50VXJsLmhyZWY7CgkJfTsKCgkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkJcGF0aC5nZXREb2N1bWVudEJhc2UgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudEJhc2UgKSA6IHBhdGguZG9jdW1lbnRCYXNlLmhyZWY7CgkJfTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aDsKCgkkLm1vYmlsZS5IaXN0b3J5ID0gZnVuY3Rpb24oIHN0YWNrLCBpbmRleCApIHsKCQl0aGlzLnN0YWNrID0gc3RhY2sgfHwgW107CgkJdGhpcy5hY3RpdmVJbmRleCA9IGluZGV4IHx8IDA7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLkhpc3RvcnkucHJvdG90eXBlLCB7CgkJZ2V0QWN0aXZlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggXTsKCQl9LAoKCQlnZXRMYXN0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMucHJldmlvdXNJbmRleCBdOwoJCX0sCgoJCWdldE5leHQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCArIDEgXTsKCQl9LAoKCQlnZXRQcmV2OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggLSAxIF07CgkJfSwKCgkJLy8gYWRkTmV3IGlzIHVzZWQgd2hlbmV2ZXIgYSBuZXcgcGFnZSBpcyBhZGRlZAoJCWFkZDogZnVuY3Rpb24oIHVybCwgZGF0YSApewoJCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJCS8vaWYgdGhlcmUncyBmb3J3YXJkIGhpc3RvcnksIHdpcGUgaXQKCQkJaWYgKCB0aGlzLmdldE5leHQoKSApIHsKCQkJCXRoaXMuY2xlYXJGb3J3YXJkKCk7CgkJCX0KCgkJCS8vIGlmIHRoZSBoYXNoIGlzIGluY2x1ZGVkIGluIHRoZSBkYXRhIG1ha2Ugc3VyZSB0aGUgc2hhcGUKCQkJLy8gaXMgY29uc2lzdGVudCBmb3IgY29tcGFyaXNvbgoJCQlpZiggZGF0YS5oYXNoICYmIGRhdGEuaGFzaC5pbmRleE9mKCAiIyIgKSA9PT0gLTEpIHsKCQkJCWRhdGEuaGFzaCA9ICIjIiArIGRhdGEuaGFzaDsKCQkJfQoKCQkJZGF0YS51cmwgPSB1cmw7CgkJCXRoaXMuc3RhY2sucHVzaCggZGF0YSApOwoJCQl0aGlzLmFjdGl2ZUluZGV4ID0gdGhpcy5zdGFjay5sZW5ndGggLSAxOwoJCX0sCgoJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCWNsZWFyRm9yd2FyZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc3RhY2sgPSB0aGlzLnN0YWNrLnNsaWNlKCAwLCB0aGlzLmFjdGl2ZUluZGV4ICsgMSApOwoJCX0sCgoJCWZpbmQ6IGZ1bmN0aW9uKCB1cmwsIHN0YWNrLCBlYXJseVJldHVybiApIHsKCQkJc3RhY2sgPSBzdGFjayB8fCB0aGlzLnN0YWNrOwoKCQkJdmFyIGVudHJ5LCBpLCBsZW5ndGggPSBzdGFjay5sZW5ndGgsIGluZGV4OwoKCQkJZm9yICggaSA9IDA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWVudHJ5ID0gc3RhY2tbaV07CgoJCQkJaWYgKCBkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5LnVybCkgfHwKCQkJCQlkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5Lmhhc2gpICkgewoJCQkJCWluZGV4ID0gaTsKCgkJCQkJaWYoIGVhcmx5UmV0dXJuICkgewoJCQkJCQlyZXR1cm4gaW5kZXg7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gaW5kZXg7CgkJfSwKCgkJY2xvc2VzdDogZnVuY3Rpb24oIHVybCApIHsKCQkJdmFyIGNsb3Nlc3QsIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gRmlyc3QsIHRha2UgdGhlIHNsaWNlIG9mIHRoZSBoaXN0b3J5IHN0YWNrIGJlZm9yZSB0aGUgY3VycmVudCBpbmRleCBhbmQgc2VhcmNoCgkJCS8vIGZvciBhIHVybCBtYXRjaC4gSWYgb25lIGlzIGZvdW5kLCB3ZSdsbCBhdm9pZCBhdm9pZCBsb29raW5nIHRocm91Z2ggZm9yd2FyZCBoaXN0b3J5CgkJCS8vIE5PVEUgdGhlIHByZWZlcmVuY2UgZm9yIGJhY2t3YXJkIGhpc3RvcnkgbW92ZW1lbnQgaXMgZHJpdmVuIGJ5IHRoZSBmYWN0IHRoYXQKCQkJLy8gICAgICBtb3N0IG1vYmlsZSBicm93c2VycyBvbmx5IGhhdmUgYSBkZWRpY2F0ZWQgYmFjayBidXR0b24sIGFuZCB1c2VycyByYXJlbHkgdXNlCgkJCS8vICAgICAgdGhlIGZvcndhcmQgYnV0dG9uIGluIGRlc2t0b3AgYnJvd3NlciBhbnlob3cKCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKDAsIGEpICk7CgoJCQkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbiBiYWNrd2FyZCBoaXN0b3J5IGNoZWNrIGZvcndhcmQuIFRoZSBgdHJ1ZWAKCQkJLy8gdmFsdWUgcGFzc2VkIGFzIHRoZSB0aGlyZCBwYXJhbWV0ZXIgY2F1c2VzIHRoZSBmaW5kIG1ldGhvZCB0byBicmVhawoJCQkvLyBvbiB0aGUgZmlyc3QgbWF0Y2ggaW4gdGhlIGZvcndhcmQgaGlzdG9yeSBzbGljZS4gVGhlIHN0YXJ0aW5nIGluZGV4CgkJCS8vIG9mIHRoZSBzbGljZSBtdXN0IHRoZW4gYmUgYWRkZWQgdG8gdGhlIHJlc3VsdCB0byBnZXQgdGhlIGVsZW1lbnQgaW5kZXgKCQkJLy8gaW4gdGhlIG9yaWdpbmFsIGhpc3Rvcnkgc3RhY2sgOiggOigKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGh5cGVyIGNvbmZ1c2luZyBhbmQgc2hvdWxkIGJlIGNsZWFuZWQgdXAgKHVnaCBzbyBiYWQpCgkJCWlmKCBjbG9zZXN0ID09PSB1bmRlZmluZWQgKSB7CgkJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoYSksIHRydWUgKTsKCQkJCWNsb3Nlc3QgPSBjbG9zZXN0ID09PSB1bmRlZmluZWQgPyBjbG9zZXN0IDogY2xvc2VzdCArIGE7CgkJCX0KCgkJCXJldHVybiBjbG9zZXN0OwoJCX0sCgoJCWRpcmVjdDogZnVuY3Rpb24oIG9wdHMgKSB7CgkJCXZhciBuZXdBY3RpdmVJbmRleCA9IHRoaXMuY2xvc2VzdCggb3B0cy51cmwgKSwgYSA9IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCS8vIHJlY29yZCB0aGUgcHJldmlvdXMgaW5kZXggZm9yIHJlZmVyZW5jZQoJCQlpZiggbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuYWN0aXZlSW5kZXggPSBuZXdBY3RpdmVJbmRleDsKCQkJCXRoaXMucHJldmlvdXNJbmRleCA9IGE7CgkJCX0KCgkJCS8vIGludm9rZSBjYWxsYmFja3Mgd2hlcmUgYXBwcm9wcmlhdGUKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGFsc28gY29udm9sdXRlZCBhbmQgY29uZnVzaW5nCgkJCWlmICggbmV3QWN0aXZlSW5kZXggPCBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5iYWNrIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAnYmFjaycgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPiBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5mb3J3YXJkIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAnZm9yd2FyZCcgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPT09IHVuZGVmaW5lZCAmJiBvcHRzLm1pc3NpbmcgKXsKCQkJCW9wdHMubWlzc2luZyggdGhpcy5nZXRBY3RpdmUoKSApOwoJCQl9CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aCwKCQlpbml0aWFsSHJlZiA9IGxvY2F0aW9uLmhyZWY7CgoJJC5tb2JpbGUuTmF2aWdhdG9yID0gZnVuY3Rpb24oIGhpc3RvcnkgKSB7CgkJdGhpcy5oaXN0b3J5ID0gaGlzdG9yeTsKCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gdHJ1ZTsKCgkJJC5tb2JpbGUud2luZG93LmJpbmQoewoJCQkicG9wc3RhdGUuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMucG9wc3RhdGUsIHRoaXMgKSwKCQkJImhhc2hjaGFuZ2UuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMuaGFzaGNoYW5nZSwgdGhpcyApCgkJfSk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLk5hdmlnYXRvci5wcm90b3R5cGUsIHsKCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCXZhciBzdGF0ZSwgaHJlZiwgaGFzaCA9IHBhdGguaXNQYXRoKHVybCkgPyBwYXRoLnN0cmlwSGFzaCh1cmwpIDogdXJsOwoKCQkJaHJlZiA9IHBhdGguc3F1YXNoKCB1cmwgKTsKCgkJCS8vIG1ha2Ugc3VyZSB0byBwcm92aWRlIHRoaXMgaW5mb3JtYXRpb24gd2hlbiBpdCBpc24ndCBleHBsaWNpdGx5IHNldCBpbiB0aGUKCQkJLy8gZGF0YSBvYmplY3QgdGhhdCB3YXMgcGFzc2VkIHRvIHRoZSBzcXVhc2ggbWV0aG9kCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJaGFzaDogaGFzaCwKCQkJCXVybDogaHJlZgoJCQl9LCBkYXRhKTsKCgkJCS8vIHJlcGxhY2UgdGhlIGN1cnJlbnQgdXJsIHdpdGggdGhlIG5ldyBocmVmIGFuZCBzdG9yZSB0aGUgc3RhdGUKCQkJLy8gTm90ZSB0aGF0IGluIHNvbWUgY2FzZXMgd2UgbWlnaHQgYmUgcmVwbGFjaW5nIGFuIHVybCB3aXRoIHRoZQoJCQkvLyBzYW1lIHVybC4gV2UgZG8gdGhpcyBhbnl3YXlzIGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdAoJCQkvLyBhbGwgb2Ygb3VyIGhpc3RvcnkgZW50cmllcyBoYXZlIGEgc3RhdGUgb2JqZWN0IGFzc29jaWF0ZWQgd2l0aAoJCQkvLyB0aGVtLiBUaGlzIGFsbG93cyB1cyB0byB3b3JrIGFyb3VuZCB0aGUgY2FzZSB3aGVyZSAkLm1vYmlsZS5iYWNrKCkKCQkJLy8gaXMgY2FsbGVkIHRvIHRyYW5zaXRpb24gZnJvbSBhbiBleHRlcm5hbCBwYWdlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuCgkJCS8vIEluIHRoYXQgcGFydGljdWxhciBjYXNlLCBhIGhhc2hjaGFuZ2UgZXZlbnQgaXMgKk5PVCogZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLgoJCQkvLyBFbnN1cmluZyBlYWNoIGhpc3RvcnkgZW50cnkgaGFzIGEgc3RhdGUgb2JqZWN0IG1lYW5zIHRoYXQgb25Qb3BTdGF0ZSgpCgkJCS8vIHdpbGwgYWx3YXlzIHRyaWdnZXIgb3VyIGhhc2hjaGFuZ2UgY2FsbGJhY2sgZXZlbiB3aGVuIGEgaGFzaGNoYW5nZSBldmVudAoJCQkvLyBpcyBub3QgZmlyZWQuCgkJCXdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSggc3RhdGUsIHN0YXRlLnRpdGxlIHx8IGRvY3VtZW50LnRpdGxlLCBocmVmICk7CgoJCQlyZXR1cm4gc3RhdGU7CgkJfSwKCgkJaGFzaDogZnVuY3Rpb24oIHVybCwgaHJlZiApIHsKCQkJdmFyIHBhcnNlZCwgbG9jLCBoYXNoOwoKCQkJLy8gR3JhYiB0aGUgaGFzaCBmb3IgcmVjb3JkaW5nLiBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgKCQkJLy8gd2UgdXNlZCB0aGUgcGFyc2VkIHZlcnNpb24gb2YgdGhlIHNxdWFzaGVkIHVybCB0byByZWNvbnN0cnVjdCwKCQkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBpdCdzIGEgaGFzaCBhbmQgc3RvcmUgaXQgZGlyZWN0bHkKCQkJcGFyc2VkID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCWxvYyA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkJaWYoIGxvYy5wYXRobmFtZSArIGxvYy5zZWFyY2ggPT09IHBhcnNlZC5wYXRobmFtZSArIHBhcnNlZC5zZWFyY2ggKSB7CgkJCQkvLyBJZiB0aGUgcGF0aG5hbWUgYW5kIHNlYXJjaCBvZiB0aGUgcGFzc2VkIHVybCBpcyBpZGVudGljYWwgdG8gdGhlIGN1cnJlbnQgbG9jCgkJCQkvLyB0aGVuIHdlIG11c3QgdXNlIHRoZSBoYXNoLiBPdGhlcndpc2UgdGhlcmUgd2lsbCBiZSBubyBldmVudAoJCQkJLy8gZWcsIHVybCA9ICIvZm9vL2Jhcj9iYXojYmFuZyIsIGxvY2F0aW9uLmhyZWYgPSAiaHR0cDovL2V4YW1wbGUuY29tL2Zvby9iYXI/YmF6IgoJCQkJaGFzaCA9IHBhcnNlZC5oYXNoID8gcGFyc2VkLmhhc2ggOiBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoOwoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzUGF0aCh1cmwpICkgewoJCQkJdmFyIHJlc29sdmVkID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJLy8gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoLCBtYWtlIGl0IGRvbWFpbiByZWxhdGl2ZSBhbmQgcmVtb3ZlIGFueSB0cmFpbGluZyBoYXNoCgkJCQloYXNoID0gcmVzb2x2ZWQucGF0aG5hbWUgKyByZXNvbHZlZC5zZWFyY2ggKyAocGF0aC5pc1ByZXNlcnZhYmxlSGFzaCggcmVzb2x2ZWQuaGFzaCApPyByZXNvbHZlZC5oYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6ICIiKTsKCQkJfSBlbHNlIHsKCQkJCWhhc2ggPSB1cmw7CgkJCX0KCgkJCXJldHVybiBoYXNoOwoJCX0sCgoJCS8vIFRPRE8gcmVjb25zaWRlciBuYW1lCgkJZ286IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2gsIHBvcHN0YXRlRXZlbnQsCgkJCQlpc1BvcFN0YXRlRXZlbnQgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCk7CgoJCQkvLyBHZXQgdGhlIHVybCBhcyBpdCB3b3VsZCBsb29rIHNxdWFzaGVkIG9uIHRvIHRoZSBjdXJyZW50IHJlc29sdXRpb24gdXJsCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBzb3J0IG91dCB3aGF0IHRoZSBoYXNoIHNvdWxkIGJlIGZyb20gdGhlIHVybAoJCQloYXNoID0gdGhpcy5oYXNoKCB1cmwsIGhyZWYgKTsKCgkJCS8vIEhlcmUgd2UgcHJldmVudCB0aGUgbmV4dCBoYXNoIGNoYW5nZSBvciBwb3BzdGF0ZSBldmVudCBmcm9tIGRvaW5nIGFueQoJCQkvLyBoaXN0b3J5IG1hbmFnZW1lbnQuIEluIHRoZSBjYXNlIG9mIGhhc2hjaGFuZ2Ugd2UgZG9uJ3Qgc3dhbGxvdyBpdAoJCQkvLyBpZiB0aGVyZSB3aWxsIGJlIG5vIGhhc2hjaGFuZ2UgZmlyZWQgKHNpbmNlIHRoYXQgd29uJ3QgcmVzZXQgdGhlIHZhbHVlKQoJCQkvLyBhbmQgd2lsbCBzd2FsbG93IHRoZSBmb2xsb3dpbmcgaGFzaGNoYW5nZQoJCQlpZiggbm9FdmVudHMgJiYgaGFzaCAhPT0gcGF0aC5zdHJpcEhhc2gocGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCkgKSB7CgkJCQl0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSA9IG5vRXZlbnRzOwoJCQl9CgoJCQkvLyBJTVBPUlRBTlQgaW4gdGhlIGNhc2Ugd2hlcmUgcG9wc3RhdGUgaXMgc3VwcG9ydGVkIHRoZSBldmVudCB3aWxsIGJlIHRyaWdnZXJlZAoJCQkvLyAgICAgIGRpcmVjdGx5LCBzdG9wcGluZyBmdXJ0aGVyIGV4ZWN1dGlvbiAtIGllLCBpbnRlcnVwdGluZyB0aGUgZmxvdyBvZiB0aGlzCgkJCS8vICAgICAgbWV0aG9kIGNhbGwgdG8gZmlyZSBiaW5kaW5ncyBhdCB0aGlzIGV4cHJlc3Npb24uIEJlbG93IHRoZSBuYXZpZ2F0ZSBtZXRob2QKCQkJLy8gICAgICB0aGVyZSBpcyBhIGJpbmRpbmcgdG8gY2F0Y2ggdGhpcyBldmVudCBhbmQgc3RvcCBpdHMgcHJvcGFnYXRpb24uCgkJCS8vCgkJCS8vICAgICAgV2UgdGhlbiB0cmlnZ2VyIGEgbmV3IHBvcHN0YXRlIGV2ZW50IG9uIHRoZSB3aW5kb3cgd2l0aCBhIG51bGwgc3RhdGUKCQkJLy8gICAgICBzbyB0aGF0IHRoZSBuYXZpZ2F0ZSBldmVudHMgY2FuIGNvbmNsdWRlIHRoZWlyIHdvcmsgcHJvcGVybHkKCQkJLy8KCQkJLy8gaWYgdGhlIHVybCBpcyBhIHBhdGggd2Ugd2FudCB0byBwcmVzZXJ2ZSB0aGUgcXVlcnkgcGFyYW1zIHRoYXQgYXJlIGF2YWlsYWJsZSBvbgoJCQkvLyB0aGUgY3VycmVudCB1cmwuCgkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IHRydWU7CgkJCXdpbmRvdy5sb2NhdGlvbi5oYXNoID0gaGFzaDsKCgkJCS8vIElmIHBvcHN0YXRlIGlzIGVuYWJsZWQgYW5kIHRoZSBicm93c2VyIHRyaWdnZXJzIGBwb3BzdGF0ZWAgZXZlbnRzIHdoZW4gdGhlIGhhc2gKCQkJLy8gaXMgc2V0ICh0aGlzIG9mdGVuIGhhcHBlbnMgaW1tZWRpYXRlbHkgaW4gYnJvd3NlcnMgbGlrZSBDaHJvbWUpLCB0aGVuIHRoZQoJCQkvLyB0aGlzIGZsYWcgd2lsbCBiZSBzZXQgdG8gZmFsc2UgYWxyZWFkeS4gSWYgaXQncyBhIGJyb3dzZXIgdGhhdCBkb2VzIG5vdCB0cmlnZ2VyCgkJCS8vIGEgYHBvcHN0YXRlYCBvbiBoYXNoIGFzc2lnbmVtZW50IG9yIGByZXBsYWNlU3RhdGVgIHRoZW4gd2UgbmVlZCBhdm9pZCB0aGUgYnJhbmNoCgkJCS8vIHRoYXQgc3dhbGxvd3MgdGhlIGV2ZW50IGNyZWF0ZWQgYnkgdGhlIHBvcHN0YXRlIGdlbmVyYXRlZCBieSB0aGUgaGFzaCBhc3NpZ25tZW50CgkJCS8vIEF0IHRoZSB0aW1lIG9mIHRoaXMgd3JpdGluZyB0aGlzIGhhcHBlbnMgd2l0aCBPcGVyYSAxMiBhbmQgc29tZSB2ZXJzaW9uIG9mIElFCgkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IGZhbHNlOwoKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQl1cmw6IGhyZWYsCgkJCQloYXNoOiBoYXNoLAoJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCX0sIGRhdGEpOwoKCQkJaWYoIGlzUG9wU3RhdGVFdmVudCApIHsKCQkJCXBvcHN0YXRlRXZlbnQgPSBuZXcgJC5FdmVudCggInBvcHN0YXRlIiApOwoJCQkJcG9wc3RhdGVFdmVudC5vcmlnaW5hbEV2ZW50ID0gewoJCQkJCXR5cGU6ICJwb3BzdGF0ZSIsCgkJCQkJc3RhdGU6IG51bGwKCQkJCX07CgoJCQkJdGhpcy5zcXVhc2goIHVybCwgc3RhdGUgKTsKCgkJCQkvLyBUcmlnZ2VyIGEgbmV3IGZhdXggcG9wc3RhdGUgZXZlbnQgdG8gcmVwbGFjZSB0aGUgb25lIHRoYXQgd2UKCQkJCS8vIGNhdWdodCB0aGF0IHdhcyB0cmlnZ2VyZWQgYnkgdGhlIGhhc2ggc2V0dGluZyBhYm92ZS4KCQkJCWlmKCAhbm9FdmVudHMgKSB7CgkJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IHRydWU7CgkJCQkJJC5tb2JpbGUud2luZG93LnRyaWdnZXIoIHBvcHN0YXRlRXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVjb3JkIHRoZSBoaXN0b3J5IGVudHJ5IHNvIHRoYXQgdGhlIGluZm9ybWF0aW9uIGNhbiBiZSBpbmNsdWRlZAoJCQkvLyBpbiBoYXNoY2hhbmdlIGV2ZW50IGRyaXZlbiBuYXZpZ2F0ZSBldmVudHMgaW4gYSBzaW1pbGFyIGZhc2hpb24gdG8KCQkJLy8gdGhlIHN0YXRlIHRoYXQncyBwcm92aWRlZCBieSBwb3BzdGF0ZQoJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgkJfSwKCgoJCS8vIFRoaXMgYmluZGluZyBpcyBpbnRlbmRlZCB0byBjYXRjaCB0aGUgcG9wc3RhdGUgZXZlbnRzIHRoYXQgYXJlIGZpcmVkCgkJLy8gd2hlbiBleGVjdXRpb24gb2YgdGhlIGAkLm5hdmlnYXRlYCBtZXRob2Qgc3RvcHMgYXQgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7CgkJLy8gYW5kIGNvbXBsZXRlbHkgcHJldmVudCB0aGVtIGZyb20gcHJvcGFnYXRpbmcuIFRoZSBwb3BzdGF0ZSBldmVudCB3aWxsIHRoZW4gYmUKCQkvLyByZXRyaWdnZXJlZCBhZnRlciBleGVjdXRpb24gcmVzdW1lcwoJCS8vCgkJLy8gVE9ETyBncmFiIHRoZSBvcmlnaW5hbCBldmVudCBoZXJlIGFuZCB1c2UgaXQgZm9yIHRoZSBzeW50aGV0aWMgZXZlbnQgaW4gdGhlCgkJLy8gICAgICBzZWNvbmQgaGFsZiBvZiB0aGUgbmF2aWdhdGUgZXhlY3V0aW9uIHRoYXQgd2lsbCBmb2xsb3cgdGhpcyBiaW5kaW5nCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGFjdGl2ZSwgaGFzaCwgc3RhdGUsIGNsb3Nlc3RJbmRleDsKCgkJCS8vIFBhcnRseSB0byBzdXBwb3J0IG91ciB0ZXN0IHN1aXRlIHdoaWNoIG1hbnVhbGx5IGFsdGVycyB0aGUgc3VwcG9ydAoJCQkvLyB2YWx1ZSB0byB0ZXN0IGhhc2hjaGFuZ2UuIFBhcnRseSB0byBwcmV2ZW50IGFsbCBhcm91bmQgd2VpcmRuZXNzCgkJCWlmKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBieSB0aGUgYWN0dWFsIGFsdGVyYXRpb24gb2YgdGhlIGhhc2gKCQkJLy8gcHJldmVudCBpdCBjb21wbGV0ZWx5LiBIaXN0b3J5IGlzIHRyYWNrZWQgbWFudWFsbHkKCQkJaWYoIHRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSApIHsKCQkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IGZhbHNlOwoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIGlmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBhZnRlciB0aGUgYHJlcGxhY2VTdGF0ZWAgY2FsbCBpbiB0aGUgZ28KCQkJLy8gbWV0aG9kLCB0aGVuIHNpbXBseSBpZ25vcmUgaXQuIFRoZSBoaXN0b3J5IGVudHJ5IGhhcyBhbHJlYWR5IGJlZW4gY2FwdHVyZWQKCQkJaWYoIHRoaXMuaWdub3JlUG9wU3RhdGUgKSB7CgkJCQl0aGlzLmlnbm9yZVBvcFN0YXRlID0gZmFsc2U7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoZXJlIGlzIG5vIHN0YXRlLCBhbmQgdGhlIGhpc3Rvcnkgc3RhY2sgbGVuZ3RoIGlzIG9uZSB3ZXJlCgkJCS8vIHByb2JhYmx5IGdldHRpbmcgdGhlIHBhZ2UgbG9hZCBwb3BzdGF0ZSBmaXJlZCBieSBicm93c2VycyBsaWtlIGNocm9tZQoJCQkvLyBhdm9pZCBpdCBhbmQgc2V0IHRoZSBvbmUgdGltZSBmbGFnIHRvIGZhbHNlLgoJCQkvLyBUT0RPOiBEbyB3ZSByZWFsbHkgbmVlZCBhbGwgdGhlc2UgY29uZGl0aW9ucz8gQ29tcGFyaW5nIGxvY2F0aW9uIGhyZWZzCgkJCS8vIHNob3VsZCBiZSBzdWZmaWNpZW50LgoJCQlpZiggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYKCQkJCXRoaXMuaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDEgJiYKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gZmFsc2U7CgoJCQkJaWYgKCBsb2NhdGlvbi5ocmVmID09PSBpbml0aWFsSHJlZiApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gYWNjb3VudCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbiBvZiB0aGUgaGFzaC4gVGhhdCBpcywgd2Ugd2lsbCByZWNlaXZlIGEgcG9wc3RhdGUKCQkJLy8gd2hlbiB0aGUgaGFzaCBpcyBjaGFuZ2VkIGJ5IGFzc2lnbm1lbnQsIGFuZCBpdCB3b24ndCBoYXZlIGEgc3RhdGUgYXNzb2NpYXRlZC4gV2UKCQkJLy8gdGhlbiBuZWVkIHRvIHNxdWFzaCB0aGUgaGFzaC4gU2VlIGJlbG93IGZvciBoYW5kbGluZyBvZiBoYXNoIGFzc2lnbm1lbnQgdGhhdAoJCQkvLyBtYXRjaGVzIGFuIGV4aXN0aW5nIGhpc3RvcnkgZW50cnkKCQkJLy8gVE9ETyBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgc3RhY2sKCQkJLy8gICAgICB3aGVuIHRoZSBoYXNoIGlzIGFkamFjZW50IHRvIHRoZSBhY3RpdmUgaGlzdG9yeSBlbnRyeQoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJaWYoICFldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlICYmIGhhc2ggKSB7CgkJCQkvLyBzcXVhc2ggdGhlIGhhc2ggdGhhdCdzIGJlZW4gYXNzaWduZWQgb24gdGhlIFVSTCB3aXRoIHJlcGxhY2VTdGF0ZQoJCQkJLy8gYWxzbyBncmFiIHRoZSByZXN1bHRpbmcgc3RhdGUgb2JqZWN0IGZvciBzdG9yYWdlCgkJCQlzdGF0ZSA9IHRoaXMuc3F1YXNoKCBoYXNoICk7CgoJCQkJLy8gcmVjb3JkIHRoZSBuZXcgaGFzaCBhcyBhbiBhZGRpdGlvbmFsIGhpc3RvcnkgZW50cnkKCQkJCS8vIHRvIG1hdGNoIHRoZSBicm93c2VyJ3MgdHJlYXRtZW50IG9mIGhhc2ggYXNzaWdubWVudAoJCQkJdGhpcy5oaXN0b3J5LmFkZCggc3RhdGUudXJsLCBzdGF0ZSApOwoKCQkJCS8vIHBhc3MgdGhlIG5ld2x5IGNyZWF0ZWQgc3RhdGUgaW5mb3JtYXRpb24KCQkJCS8vIGFsb25nIHdpdGggdGhlIGV2ZW50CgkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSBzdGF0ZTsKCgkJCQkvLyBkbyBub3QgYWx0ZXIgaGlzdG9yeSwgd2UndmUgYWRkZWQgYSBuZXcgaGlzdG9yeSBlbnRyeQoJCQkJLy8gc28gd2Uga25vdyB3aGVyZSB3ZSBhcmUKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgYWxsIGVsc2UgZmFpbHMgdGhpcyBpcyBhIHBvcHN0YXRlIHRoYXQgY29tZXMgZnJvbSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbnMKCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHksIGFuZCByZWNvcmQgdGhlIGRpcmVjdGlvbmFsaXR5CgkJCXRoaXMuaGlzdG9yeS5kaXJlY3QoewoJCQkJdXJsOiAoZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fSkudXJsIHx8IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIE5PVEUgbXVzdCBiaW5kIGJlZm9yZSBgbmF2aWdhdGVgIHNwZWNpYWwgZXZlbnQgaGFzaGNoYW5nZSBiaW5kaW5nIG90aGVyd2lzZSB0aGUKCQkvLyAgICAgIG5hdmlnYXRpb24gZGF0YSB3b24ndCBiZSBhdHRhY2hlZCB0byB0aGUgaGFzaGNoYW5nZSBldmVudCBpbiB0aW1lIGZvciB0aG9zZQoJCS8vICAgICAgYmluZGluZ3MgdG8gYXR0YWNoIGl0IHRvIHRoZSBgbmF2aWdhdGVgIHNwZWNpYWwgZXZlbnQKCQkvLyBUT0RPIGFkZCBhIGNoZWNrIGhlcmUgdGhhdCBgaGFzaGNoYW5nZS5uYXZpZ2F0ZWAgaXMgYm91bmQgYWxyZWFkeSBvdGhlcndpc2UgaXQncwoJCS8vICAgICAgYnJva2VuIChleGNlcHRpb24/KQoJCWhhc2hjaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGhpc3RvcnksIGhhc2g7CgoJCQkvLyBJZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBleHBsaWNpdGx5IGRpc2FibGVkIG9yIHB1c2hzdGF0ZSBpcyBzdXBwb3J0ZWQKCQkJLy8gYXZvaWQgbWFraW5nIHVzZSBvZiB0aGUgaGFzaGNoYW5nZSBoYW5kbGVyLgoJCQlpZighJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzSGFzaENoYW5nZUVuYWJsZWQoKSB8fAoJCQkJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBPbiBvY2Nhc2lvbiBleHBsaWNpdGx5IHdhbnQgdG8gcHJldmVudCB0aGUgbmV4dCBoYXNoIGZyb20gcHJvcG9nYXRpbmcgYmVjYXVzZSB3ZSBvbmx5CgkJCS8vIHdpdGggdG8gYWx0ZXIgdGhlIHVybCB0byByZXByZXNlbnQgdGhlIG5ldyBzdGF0ZSBkbyBzbyBoZXJlCgkJCWlmKCB0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSApewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQloaXN0b3J5ID0gdGhpcy5oaXN0b3J5OwoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCgkJCS8vIElmIHRoaXMgaXMgYSBoYXNoY2hhbmdlIGNhdXNlZCBieSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbgoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0sCgoJCQkJLy8gV2hlbiB3ZSBkb24ndCBmaW5kIGEgaGFzaCBpbiBvdXIgaGlzdG9yeSBjbGVhcmx5IHdlJ3JlIGFpbWluZyB0byBnbyB0aGVyZQoJCQkJLy8gcmVjb3JkIHRoZSBlbnRyeSBhcyBuZXcgZm9yIGZ1dHVyZSB0cmF2ZXJzYWwKCQkJCS8vCgkJCQkvLyBOT1RFIGl0J3Mgbm90IGVudGlyZWx5IGNsZWFyIHRoYXQgdGhpcyBpcyB0aGUgcmlnaHQgdGhpbmcgdG8gZG8gZ2l2ZW4gdGhhdCB3ZQoJCQkJLy8gICAgICBjYW4ndCBrbm93IHRoZSB1c2VycyBpbnRlbnRpb24uIEl0IG1pZ2h0IGJlIGJldHRlciB0byBleHBsaWNpdGx5IF9ub3RfCgkJCQkvLyAgICAgIHN1cHBvcnQgbG9jYXRpb24uaGFzaCBhc3NpZ25tZW50IGluIHByZWZlcmVuY2UgdG8gJC5uYXZpZ2F0ZSBjYWxscwoJCQkJLy8gVE9ETyBmaXJzdCBhcmcgdG8gYWRkIHNob3VsZCBiZSB0aGUgaHJlZiwgYnV0IGl0IGNhdXNlcyBpc3N1ZXMgaW4gaWRlbnRpZnlpbmcKCQkJCS8vICAgICAgZW1iZWRlZCBwYWdlcwoJCQkJbWlzc2luZzogZnVuY3Rpb24oKSB7CgkJCQkJaGlzdG9yeS5hZGQoIGhhc2gsIHsKCQkJCQkJaGFzaDogaGFzaCwKCQkJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJLy8gVE9ETyBjb25zaWRlciBxdWV1ZWluZyBuYXZpZ2F0aW9uIGFjdGl2aXR5IHVudGlsIHByZXZpb3VzIGFjdGl2aXRpZXMgaGF2ZSBjb21wbGV0ZWQKCS8vICAgICAgc28gdGhhdCBlbmQgdXNlcnMgZG9uJ3QgaGF2ZSB0byB0aGluayBhYm91dCBpdC4gUHVudGluZyBmb3Igbm93CgkvLyBUT0RPICEhIG1vdmUgdGhlIGV2ZW50IGJpbmRpbmdzIGludG8gY2FsbGJhY2tzIG9uIHRoZSBuYXZpZ2F0ZSBldmVudAoJJC5tb2JpbGUubmF2aWdhdGUgPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IuZ28oIHVybCwgZGF0YSwgbm9FdmVudHMgKTsKCX07CgoJLy8gZXhwb3NlIHRoZSBoaXN0b3J5IG9uIHRoZSBuYXZpZ2F0ZSBtZXRob2QgaW4gYW50aWNpcGF0aW9uIG9mIGZ1bGwgaW50ZWdyYXRpb24gd2l0aAoJLy8gZXhpc3RpbmcgbmF2aWdhdGlvbiBmdW5jdGlvbmFsdHkgdGhhdCBpcyB0aWdodGx5IGNvdXBsZWQgdG8gdGhlIGhpc3RvcnkgaW5mb3JtYXRpb24KCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgPSBuZXcgJC5tb2JpbGUuSGlzdG9yeSgpOwoKCS8vIGluc3RhbnRpYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBuYXZpZ2F0b3IgZm9yIHVzZSB3aXRoaW4gdGhlICQubmF2aWdhdGUgbWV0aG9kCgkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IgPSBuZXcgJC5tb2JpbGUuTmF2aWdhdG9yKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ICk7CgoJdmFyIGxvYyA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpOwoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIGxvYy5ocmVmLCB7aGFzaDogbG9jLmhhc2h9ICk7Cn0pKCBqUXVlcnkgKTsKCgovLyBUaGlzIHBsdWdpbiBpcyBhbiBleHBlcmltZW50IGZvciBhYnN0cmFjdGluZyBhd2F5IHRoZSB0b3VjaCBhbmQgbW91c2UKLy8gZXZlbnRzIHNvIHRoYXQgZGV2ZWxvcGVycyBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHdoaWNoIG1ldGhvZCBvZiBpbnB1dAovLyB0aGUgZGV2aWNlIHRoZWlyIGRvY3VtZW50IGlzIGxvYWRlZCBvbiBzdXBwb3J0cy4KLy8KLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBhbGxvdyB0aGUgZGV2ZWxvcGVyIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyBmb3IgdGhlCi8vIGJhc2ljIG1vdXNlIGV2ZW50cywgc3VjaCBhcyBtb3VzZWRvd24sIG1vdXNlbW92ZSwgbW91c2V1cCwgYW5kIGNsaWNrLAovLyBhbmQgdGhlIHBsdWdpbiB3aWxsIHRha2UgY2FyZSBvZiByZWdpc3RlcmluZyB0aGUgY29ycmVjdCBsaXN0ZW5lcnMKLy8gYmVoaW5kIHRoZSBzY2VuZXMgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciBhdCB0aGUgZmFzdGVzdCBwb3NzaWJsZSB0aW1lCi8vIGZvciB0aGF0IGRldmljZSwgd2hpbGUgc3RpbGwgcmV0YWluaW5nIHRoZSBvcmRlciBvZiBldmVudCBmaXJpbmcgaW4KLy8gdGhlIHRyYWRpdGlvbmFsIG1vdXNlIGVudmlyb25tZW50LCBzaG91bGQgbXVsdGlwbGUgaGFuZGxlcnMgYmUgcmVnaXN0ZXJlZAovLyBvbiB0aGUgc2FtZSBlbGVtZW50IGZvciBkaWZmZXJlbnQgZXZlbnRzLgovLwovLyBUaGUgY3VycmVudCB2ZXJzaW9uIGV4cG9zZXMgdGhlIGZvbGxvd2luZyB2aXJ0dWFsIGV2ZW50cyB0byBqUXVlcnkgYmluZCBtZXRob2RzOgovLyAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiCgooZnVuY3Rpb24oICQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCnZhciBkYXRhUHJvcGVydHlOYW1lID0gInZpcnR1YWxNb3VzZUJpbmRpbmdzIiwKCXRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lID0gInZpcnR1YWxUb3VjaElEIiwKCXZpcnR1YWxFdmVudE5hbWVzID0gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIi5zcGxpdCggIiAiICksCgl0b3VjaEV2ZW50UHJvcHMgPSAiY2xpZW50WCBjbGllbnRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSIuc3BsaXQoICIgIiApLAoJbW91c2VIb29rUHJvcHMgPSAkLmV2ZW50Lm1vdXNlSG9va3MgPyAkLmV2ZW50Lm1vdXNlSG9va3MucHJvcHMgOiBbXSwKCW1vdXNlRXZlbnRQcm9wcyA9ICQuZXZlbnQucHJvcHMuY29uY2F0KCBtb3VzZUhvb2tQcm9wcyApLAoJYWN0aXZlRG9jSGFuZGxlcnMgPSB7fSwKCXJlc2V0VGltZXJJRCA9IDAsCglzdGFydFggPSAwLAoJc3RhcnRZID0gMCwKCWRpZFNjcm9sbCA9IGZhbHNlLAoJY2xpY2tCbG9ja0xpc3QgPSBbXSwKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlLAoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2UsCglldmVudENhcHR1cmVTdXBwb3J0ZWQgPSAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZG9jdW1lbnQsCgkkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJbmV4dFRvdWNoSUQgPSAxLAoJbGFzdFRvdWNoSUQgPSAwLCB0aHJlc2hvbGQ7CgokLnZtb3VzZSA9IHsKCW1vdmVEaXN0YW5jZVRocmVzaG9sZDogMTAsCgljbGlja0Rpc3RhbmNlVGhyZXNob2xkOiAxMCwKCXJlc2V0VGltZXJEdXJhdGlvbjogMTUwMAp9OwoKZnVuY3Rpb24gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkgewoKCXdoaWxlICggZXZlbnQgJiYgdHlwZW9mIGV2ZW50Lm9yaWdpbmFsRXZlbnQgIT09ICJ1bmRlZmluZWQiICkgewoJCWV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCX0KCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICkgewoKCXZhciB0ID0gZXZlbnQudHlwZSwKCQlvZSwgcHJvcHMsIG5lLCBwcm9wLCBjdCwgdG91Y2gsIGksIGosIGxlbjsKCglldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CglldmVudC50eXBlID0gZXZlbnRUeXBlOwoKCW9lID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCXByb3BzID0gJC5ldmVudC5wcm9wczsKCgkvLyBhZGRyZXNzZXMgc2VwYXJhdGlvbiBvZiAkLmV2ZW50LnByb3BzIGluIHRvICQuZXZlbnQubW91c2VIb29rLnByb3BzIGFuZCBJc3N1ZSAzMjgwCgkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzMyODAKCWlmICggdC5zZWFyY2goIC9eKG1vdXNlfGNsaWNrKS8gKSA+IC0xICkgewoJCXByb3BzID0gbW91c2VFdmVudFByb3BzOwoJfQoKCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJaWYgKCBvZSApIHsKCQlmb3IgKCBpID0gcHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJcHJvcCA9IHByb3BzWyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9lWyBwcm9wIF07CgkJfQoJfQoKCS8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBtb3VzZSBhbmQgY2xpY2sgdmlydHVhbCBldmVudHMgYXJlIGdlbmVyYXRlZAoJLy8gd2l0aG91dCBhIC53aGljaCBvbmUgaXMgZGVmaW5lZAoJaWYgKCB0LnNlYXJjaCgvbW91c2UoZG93bnx1cCl8Y2xpY2svKSA+IC0xICYmICFldmVudC53aGljaCApIHsKCQlldmVudC53aGljaCA9IDE7Cgl9CgoJaWYgKCB0LnNlYXJjaCgvXnRvdWNoLykgIT09IC0xICkgewoJCW5lID0gZ2V0TmF0aXZlRXZlbnQoIG9lICk7CgkJdCA9IG5lLnRvdWNoZXM7CgkJY3QgPSBuZS5jaGFuZ2VkVG91Y2hlczsKCQl0b3VjaCA9ICggdCAmJiB0Lmxlbmd0aCApID8gdFswXSA6ICggKCBjdCAmJiBjdC5sZW5ndGggKSA/IGN0WyAwIF0gOiB1bmRlZmluZWQgKTsKCgkJaWYgKCB0b3VjaCApIHsKCQkJZm9yICggaiA9IDAsIGxlbiA9IHRvdWNoRXZlbnRQcm9wcy5sZW5ndGg7IGogPCBsZW47IGorKykgewoJCQkJcHJvcCA9IHRvdWNoRXZlbnRQcm9wc1sgaiBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IHRvdWNoWyBwcm9wIF07CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBlbGVtZW50ICkgewoKCXZhciBmbGFncyA9IHt9LAoJCWIsIGs7CgoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWZvciAoICBrIGluIGIgKSB7CgkJCWlmICggYlsgayBdICkgewoJCQkJZmxhZ3NbIGsgXSA9IGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nID0gdHJ1ZTsKCQkJfQoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIGZsYWdzOwp9CgpmdW5jdGlvbiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZWxlbWVudCwgZXZlbnRUeXBlICkgewoJdmFyIGI7Cgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJaWYgKCBiICYmICggIWV2ZW50VHlwZSB8fCBiWyBldmVudFR5cGUgXSApICkgewoJCQlyZXR1cm4gZWxlbWVudDsKCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBudWxsOwp9CgpmdW5jdGlvbiBlbmFibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGRpc2FibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gdHJ1ZTsKfQoKZnVuY3Rpb24gZW5hYmxlTW91c2VCaW5kaW5ncygpIHsKCWxhc3RUb3VjaElEID0gMDsKCWNsaWNrQmxvY2tMaXN0Lmxlbmd0aCA9IDA7CglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZTsKCgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBlbmFibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBkaXNhYmxlZC4KCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIGRpc2FibGVNb3VzZUJpbmRpbmdzKCkgewoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZGlzYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGVuYWJsZWQuCgllbmFibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIHN0YXJ0UmVzZXRUaW1lcigpIHsKCWNsZWFyUmVzZXRUaW1lcigpOwoJcmVzZXRUaW1lcklEID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJcmVzZXRUaW1lcklEID0gMDsKCQllbmFibGVNb3VzZUJpbmRpbmdzKCk7Cgl9LCAkLnZtb3VzZS5yZXNldFRpbWVyRHVyYXRpb24gKTsKfQoKZnVuY3Rpb24gY2xlYXJSZXNldFRpbWVyKCkgewoJaWYgKCByZXNldFRpbWVySUQgKSB7CgkJY2xlYXJUaW1lb3V0KCByZXNldFRpbWVySUQgKTsKCQlyZXNldFRpbWVySUQgPSAwOwoJfQp9CgpmdW5jdGlvbiB0cmlnZ2VyVmlydHVhbEV2ZW50KCBldmVudFR5cGUsIGV2ZW50LCBmbGFncyApIHsKCXZhciB2ZTsKCglpZiAoICggZmxhZ3MgJiYgZmxhZ3NbIGV2ZW50VHlwZSBdICkgfHwKCQkJCSggIWZsYWdzICYmIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBldmVudC50YXJnZXQsIGV2ZW50VHlwZSApICkgKSB7CgoJCXZlID0gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICk7CgoJCSQoIGV2ZW50LnRhcmdldCkudHJpZ2dlciggdmUgKTsKCX0KCglyZXR1cm4gdmU7Cn0KCmZ1bmN0aW9uIG1vdXNlRXZlbnRDYWxsYmFjayggZXZlbnQgKSB7Cgl2YXIgdG91Y2hJRCA9ICQuZGF0YSggZXZlbnQudGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApOwoKCWlmICggIWJsb2NrTW91c2VUcmlnZ2VycyAmJiAoICFsYXN0VG91Y2hJRCB8fCBsYXN0VG91Y2hJRCAhPT0gdG91Y2hJRCApICkgewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2IiArIGV2ZW50LnR5cGUsIGV2ZW50ICk7CgkJaWYgKCB2ZSApIHsKCQkJaWYgKCB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKCB2ZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQkJaWYgKCB2ZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoIGV2ZW50ICkgewoKCXZhciB0b3VjaGVzID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlcywKCQl0YXJnZXQsIGZsYWdzOwoKCWlmICggdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA9PT0gMSApIHsKCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggdGFyZ2V0ICk7CgoJCWlmICggZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgKSB7CgoJCQlsYXN0VG91Y2hJRCA9IG5leHRUb3VjaElEKys7CgkJCSQuZGF0YSggdGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSwgbGFzdFRvdWNoSUQgKTsKCgkJCWNsZWFyUmVzZXRUaW1lcigpOwoKCQkJZGlzYWJsZU1vdXNlQmluZGluZ3MoKTsKCQkJZGlkU2Nyb2xsID0gZmFsc2U7CgoJCQl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKCB0LnBhZ2VYIC0gc3RhcnRYICkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyggdC5wYWdlWSAtIHN0YXJ0WSApID4gbW92ZVRocmVzaG9sZCApOwoKCglpZiAoIGRpZFNjcm9sbCAmJiAhZGlkQ2FuY2VsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZmxhZ3MgKTsKCX0KCgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlbW92ZSIsIGV2ZW50LCBmbGFncyApOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwoKCXZhciBmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApLAoJCXQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInZjbGljayIsIGV2ZW50LCBmbGFncyApOwoJCWlmICggdmUgJiYgdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCS8vIFRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyB0aGUgdG91Y2hlbmQKCQkJLy8gZXZlbnQgZG9uJ3QgbmVjZXNzYXJpbHkgbWF0Y2ggdGhlIHRhcmdldCB1c2VkIGR1cmluZyB0aGUKCQkJLy8gdG91Y2guIFRoaXMgbWVhbnMgd2UgbmVlZCB0byByZWx5IG9uIGNvb3JkaW5hdGVzIGZvciBibG9ja2luZwoJCQkvLyBhbnkgY2xpY2sgdGhhdCBpcyBnZW5lcmF0ZWQuCgkJCXQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS5jaGFuZ2VkVG91Y2hlc1sgMCBdOwoJCQljbGlja0Jsb2NrTGlzdC5wdXNoKHsKCQkJCXRvdWNoSUQ6IGxhc3RUb3VjaElELAoJCQkJeDogdC5jbGllbnRYLAoJCQkJeTogdC5jbGllbnRZCgkJCX0pOwoKCQkJLy8gUHJldmVudCBhbnkgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IGZyb20gdHJpZ2dlcmluZwoJCQkvLyB2aXJ0dWFsIGV2ZW50IG5vdGlmaWNhdGlvbnMuCgkJCWJsb2NrTW91c2VUcmlnZ2VycyA9IHRydWU7CgkJfQoJfQoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW91dCIsIGV2ZW50LCBmbGFncyk7CglkaWRTY3JvbGwgPSBmYWxzZTsKCglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFzVmlydHVhbEJpbmRpbmdzKCBlbGUgKSB7Cgl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIGVsZSwgZGF0YVByb3BlcnR5TmFtZSApLAoJCWs7CgoJaWYgKCBiaW5kaW5ncyApIHsKCQlmb3IgKCBrIGluIGJpbmRpbmdzICkgewoJCQlpZiAoIGJpbmRpbmdzWyBrIF0gKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCX0KCXJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gZHVtbXlNb3VzZUhhbmRsZXIoKSB7fQoKZnVuY3Rpb24gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCBldmVudFR5cGUgKSB7Cgl2YXIgcmVhbFR5cGUgPSBldmVudFR5cGUuc3Vic3RyKCAxICk7CgoJcmV0dXJuIHsKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBiaW5kaW5nIGZvciB0aGlzIGV2ZW50VHlwZSwKCQkJLy8gcmVtb3ZlIGl0cyBnbG9iYWwgaGFuZGxlciBmcm9tIHRoZSBkb2N1bWVudC4KCgkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdOwoKCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdICkgewoJCQkJJGRvY3VtZW50LnVuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGluIGV4aXN0ZW5jZSwKCQkJCS8vIHJlbW92ZSBvdXIgZG9jdW1lbnQgdG91Y2hzdGFydCBsaXN0ZW5lci4KCgkJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXTsKCgkJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gKSB7CgkJCQkJJGRvY3VtZW50LnVuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLnVuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS51bmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCQkJCQkJLnVuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQliaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoKCQkJLy8gdGVhcmRvd24gbWF5IGJlIGNhbGxlZCB3aGVuIGFuIGVsZW1lbnQgd2FzCgkJCS8vIHJlbW92ZWQgZnJvbSB0aGUgRE9NLiBJZiB0aGlzIGlzIHRoZSBjYXNlLAoJCQkvLyBqUXVlcnkgY29yZSBtYXkgaGF2ZSBhbHJlYWR5IHN0cmlwcGVkIHRoZSBlbGVtZW50CgkJCS8vIG9mIGFueSBkYXRhIGJpbmRpbmdzIHNvIHdlIG5lZWQgdG8gY2hlY2sgaXQgYmVmb3JlCgkJCS8vIHVzaW5nIGl0LgoJCQlpZiAoIGJpbmRpbmdzICkgewoJCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gZmFsc2U7CgkJCX0KCgkJCS8vIFVucmVnaXN0ZXIgdGhlIGR1bW15IGV2ZW50IGhhbmRsZXIuCgoJCQkkdGhpcy51bmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgb24gdGhlCgkJCS8vIGVsZW1lbnQsIHJlbW92ZSB0aGUgYmluZGluZyBkYXRhIGZyb20gdGhlIGVsZW1lbnQuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSR0aGlzLnJlbW92ZURhdGEoIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJfQoJCX0KCX07Cn0KCi8vIEV4cG9zZSBvdXIgY3VzdG9tIGV2ZW50cyB0byB0aGUgalF1ZXJ5IGJpbmQvdW5iaW5kIG1lY2hhbmlzbS4KCmZvciAoIHZhciBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGVoc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApOwoKCS8vIGFkZCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCgl2YXIgc3VwcG9ydFRvdWNoID0gJC5tb2JpbGUuc3VwcG9ydC50b3VjaCwKCQlzY3JvbGxFdmVudCA9ICJ0b3VjaG1vdmUgc2Nyb2xsIiwKCQl0b3VjaFN0YXJ0RXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hzdGFydCIgOiAibW91c2Vkb3duIiwKCQl0b3VjaFN0b3BFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaGVuZCIgOiAibW91c2V1cCIsCgkJdG91Y2hNb3ZlRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2htb3ZlIiA6ICJtb3VzZW1vdmUiOwoKCWZ1bmN0aW9uIHRyaWdnZXJDdXN0b21FdmVudCggb2JqLCBldmVudFR5cGUsIGV2ZW50ICkgewoJCXZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlOwoJCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgkJJC5ldmVudC5kaXNwYXRjaC5jYWxsKCBvYmosIGV2ZW50ICk7CgkJZXZlbnQudHlwZSA9IG9yaWdpbmFsVHlwZTsKCX0KCgkvLyBhbHNvIGhhbmRsZXMgc2Nyb2xsc3RvcAoJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0ID0gewoKCQllbmFibGVkOiB0cnVlLAoKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCWlmICggZXZlbnQud2hpY2ggJiYgZXZlbnQud2hpY2ggIT09IDEgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCXZhciBvcmlnVGFyZ2V0ID0gZXZlbnQudGFyZ2V0LAoJCQkJCW9yaWdFdmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQsCgkJCQkJdGltZXI7CgoJCQkJZnVuY3Rpb24gY2xlYXJUYXBUaW1lcigpIHsKCQkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xlYXJUYXBIYW5kbGVycygpIHsKCQkJCQljbGVhclRhcFRpbWVyKCk7CgoJCQkJCSR0aGlzLnVuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApCgkJCQkJCS51bmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKTsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsaWNrSGFuZGxlciggZXZlbnQgKSB7CgkJCQkJY2xlYXJUYXBIYW5kbGVycygpOwoKCQkJCQkvLyBPTkxZIHRyaWdnZXIgYSAndGFwJyBldmVudCBpZiB0aGUgc3RhcnQgdGFyZ2V0IGlzCgkJCQkJLy8gdGhlIHNhbWUgYXMgdGhlIHN0b3AgdGFyZ2V0LgoJCQkJCWlmICggb3JpZ1RhcmdldCA9PT0gZXZlbnQudGFyZ2V0ICkgewoJCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXAiLCBldmVudCApOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJGRvY3VtZW50LmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXBob2xkIiwgJC5FdmVudCggInRhcGhvbGQiLCB7IHRhcmdldDogb3JpZ1RhcmdldCB9ICkgKTsKCQkJCX0sICQuZXZlbnQuc3BlY2lhbC50YXAudGFwaG9sZFRocmVzaG9sZCApOwoJCQl9KTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyBzd2lwZWxlZnQsIHN3aXBlcmlnaHQKCSQuZXZlbnQuc3BlY2lhbC5zd2lwZSA9IHsKCQlzY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkOiAzMCwgLy8gTW9yZSB0aGFuIHRoaXMgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQsIGFuZCB3ZSB3aWxsIHN1cHByZXNzIHNjcm9sbGluZy4KCgkJZHVyYXRpb25UaHJlc2hvbGQ6IDEwMDAsIC8vIE1vcmUgdGltZSB0aGFuIHRoaXMsIGFuZCBpdCBpc24ndCBhIHN3aXBlLgoKCQlob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQ6IDMwLCAgLy8gU3dpcGUgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBtb3JlIHRoYW4gdGhpcy4KCgkJdmVydGljYWxEaXN0YW5jZVRocmVzaG9sZDogNzUsICAvLyBTd2lwZSB2ZXJ0aWNhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBsZXNzIHRoYW4gdGhpcy4KCgkJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXSwKCQkJCQkJb3JpZ2luOiAkKCBldmVudC50YXJnZXQgKQoJCQkJCX07CgkJfSwKCgkJc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudDsKCQkJcmV0dXJuIHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdCgkJCQkJfTsKCQl9LAoKCQloYW5kbGVTd2lwZTogZnVuY3Rpb24oIHN0YXJ0LCBzdG9wICkgewoJCQlpZiAoIHN0b3AudGltZSAtIHN0YXJ0LnRpbWUgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZHVyYXRpb25UaHJlc2hvbGQgJiYKCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQgJiYKCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDEgXSAtIHN0b3AuY29vcmRzWyAxIF0gKSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS52ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkICkgewoKCQkJCXN0YXJ0Lm9yaWdpbi50cmlnZ2VyKCAic3dpcGUiICkKCQkJCQkudHJpZ2dlciggc3RhcnQuY29vcmRzWzBdID4gc3RvcC5jb29yZHNbIDAgXSA/ICJzd2lwZWxlZnQiIDogInN3aXBlcmlnaHQiICk7CgkJCX0KCQl9LAoKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApOwoKCQkJJHRoaXMuYmluZCggdG91Y2hTdGFydEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl2YXIgc3RhcnQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RhcnQoIGV2ZW50ICksCgkJCQkJc3RvcDsKCgkJCQlmdW5jdGlvbiBtb3ZlSGFuZGxlciggZXZlbnQgKSB7CgkJCQkJaWYgKCAhc3RhcnQgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCXN0b3AgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RvcCggZXZlbnQgKTsKCgkJCQkJLy8gcHJldmVudCBzY3JvbGxpbmcKCQkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJCS5vbmUoIHRvdWNoU3RvcEV2ZW50LCBmdW5jdGlvbigpIHsKCQkJCQkJJHRoaXMudW5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKTsKCgkJCQkJCWlmICggc3RhcnQgJiYgc3RvcCApIHsKCQkJCQkJCSQuZXZlbnQuc3BlY2lhbC5zd2lwZS5oYW5kbGVTd2lwZSggc3RhcnQsIHN0b3AgKTsKCQkJCQkJfQoJCQkJCQlzdGFydCA9IHN0b3AgPSB1bmRlZmluZWQ7CgkJCQkJfSk7CgkJCX0pOwoJCX0KCX07CgkkLmVhY2goewoJCXNjcm9sbHN0b3A6ICJzY3JvbGxzdGFydCIsCgkJdGFwaG9sZDogInRhcCIsCgkJc3dpcGVsZWZ0OiAic3dpcGUiLAoJCXN3aXBlcmlnaHQ6ICJzd2lwZSIKCX0sIGZ1bmN0aW9uKCBldmVudCwgc291cmNlRXZlbnQgKSB7CgoJCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoIHNvdXJjZUV2ZW50LCAkLm5vb3AgKTsKCQkJfQoJCX07Cgl9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgoJLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAoJKGZ1bmN0aW9uKCAkICkgewoJCSQuZXZlbnQuc3BlY2lhbC50aHJvdHRsZWRyZXNpemUgPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9CgkJfTsKCgkJdmFyIHRocm90dGxlID0gMjUwLAoJCQloYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQkJZGlmZiA9IGN1cnIgLSBsYXN0Q2FsbDsKCgkJCQlpZiAoIGRpZmYgPj0gdGhyb3R0bGUgKSB7CgoJCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCQkkKCB0aGlzICkudHJpZ2dlciggInRocm90dGxlZHJlc2l6ZSIgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhlbGRDYWxsICk7CgkJCQkJfQoKCQkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJCWhlbGRDYWxsID0gc2V0VGltZW91dCggaGFuZGxlciwgdGhyb3R0bGUgLSBkaWZmICk7CgkJCQl9CgkJCX0sCgkJCWxhc3RDYWxsID0gMCwKCQkJaGVsZENhbGwsCgkJCWN1cnIsCgkJCWRpZmY7Cgl9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCXZhciB3aW4gPSAkKCB3aW5kb3cgKSwKCQlldmVudF9uYW1lID0gIm9yaWVudGF0aW9uY2hhbmdlIiwKCQlzcGVjaWFsX2V2ZW50LAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfTsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGF0dGVtcHRzIHRvIHVzZSB0aGUgd2luZG93CgkvLyBkaW1lbnNpb25zIHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4gbWFrZXMgYWRqdXN0bWVudHMKCS8vIHRvIHRoZSB0byB0aGUgcG9ydHJhaXRfbWFwIGlmIG5lY2Vzc2FyeSwgc28gdGhhdCB3ZSBjYW4gcHJvcGVybHkgZGVjb2RlIHRoZQoJLy8gd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlIHdoZW5ldmVyIGdldF9vcmllbnRhdGlvbigpIGlzIGNhbGxlZC4KCS8vCgkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2UgYSBtZWRpYSBxdWVyeSB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIG9yaWVudGF0aW9uIHRoZSBicm93c2VyCgkvLyB0aGlua3MgaXQgaXMgaW46CgkvLwoJLy8gICAgIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgkvLwoJLy8gYnV0IHRoZXJlIHdhcyBhbiBpUGhvbmUvaVBvZCBUb3VjaCBidWcgYmVnaW5uaW5nIHdpdGggaU9TIDQuMiwgdXAgdGhyb3VnaCBpT1MgNS4xLAoJLy8gd2hlcmUgdGhlIGJyb3dzZXIgKkFMV0FZUyogYXBwbGllZCB0aGUgbGFuZHNjYXBlIG1lZGlhIHF1ZXJ5LiBUaGlzIGJ1ZyBkb2VzIG5vdAoJLy8gaGFwcGVuIG9uIGlQYWQuCgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIENoZWNrIHRoZSB3aW5kb3cgd2lkdGggYW5kIGhlaWdodCB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24KCQkvLyBvZiB0aGUgZGV2aWNlIGlzIGF0IHRoaXMgbW9tZW50LiBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcAoJCS8vIHZhbHVlcyB0byAwIGFuZCAxODAsICpBTkQqIHdlIHB1cnBvc2VseSBjaGVjayBmb3IgbGFuZHNjYXBlIHNvIHRoYXQgaWYgd2UgZ3Vlc3MKCQkvLyB3cm9uZywgLCB3ZSBkZWZhdWx0IHRvIHRoZSBhc3N1bXB0aW9uIHRoYXQgcG9ydHJhaXQgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24uCgkJLy8gV2UgdXNlIGEgdGhyZXNob2xkIGNoZWNrIGJlbG93IGJlY2F1c2Ugb24gc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MsIHRoZSBpUGhvbmUKCQkvLyBmb3JtLWZhY3RvciBjYW4gcmVwb3J0IGEgbGFyZ2VyIHdpZHRoIHRoYW4gaGVpZ2h0IGlmIHRoZSB1c2VyIHR1cm5zIG9uIHRoZQoJCS8vIGRldmVsb3BlciBjb25zb2xlLiBUaGUgYWN0dWFsIHRocmVzaG9sZCB2YWx1ZSBpcyBzb21ld2hhdCBhcmJpdHJhcnksIHdlIGp1c3QKCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSBpdCBpcyBsYXJnZSBlbm91Z2ggdG8gZXhjbHVkZSB0aGUgZGV2ZWxvcGVyIGNvbnNvbGUgY2FzZS4KCgkJdmFyIHd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgd2luLndpZHRoKCksCgkJCXdoID0gd2luZG93LmlubmVySGVpZ2h0IHx8IHdpbi5oZWlnaHQoKSwKCQkJbGFuZHNjYXBlX3RocmVzaG9sZCA9IDUwOwoKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9IHd3ID4gd2ggJiYgKCB3dyAtIHdoICkgPiBsYW5kc2NhcGVfdGhyZXNob2xkOwoKCgkJLy8gTm93IGNoZWNrIHRvIHNlZSBpZiB0aGUgY3VycmVudCB3aW5kb3cub3JpZW50YXRpb24gaXMgMCBvciAxODAuCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCgkJLy8gSWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgbGFuZHNjYXBlLCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgMCBvciAxODAsICpPUioKCQkvLyBpZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBwb3J0cmFpdCwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDkwIG9yIC05MCwgd2UKCQkvLyBuZWVkIHRvIGZsaXAgb3VyIHBvcnRyYWl0X21hcCB2YWx1ZXMgYmVjYXVzZSBsYW5kc2NhcGUgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gZm9yCgkJLy8gdGhpcyBkZXZpY2UvYnJvd3Nlci4KCQlpZiAoICggaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgfHwgKCAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgIWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApICkgewoJCQlwb3J0cmFpdF9tYXAgPSB7ICItOTAiOiB0cnVlLCAiOTAiOiB0cnVlIH07CgkJfQoJfQoKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSA9ICQuZXh0ZW5kKCB7fSwgJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLCB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdCBqUXVlcnkKCQkJLy8gd2lsbCBiaW5kIHRvIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdAoJCQkvLyBqUXVlcnkgd2lsbCB1bmJpbmQgdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCB1bmJpbmQgdGhlCgkJCS8vIHJlc2l6ZSBldmVudCBoYW5kbGVyLgoJCQl3aW4udW5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJYWRkOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBib3VuZCBldmVudCBoYW5kbGVyLgoJCQl2YXIgb2xkX2hhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlcjsKCgoJCQloYW5kbGVPYmouaGFuZGxlciA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIE1vZGlmeSBldmVudCBvYmplY3QsIGFkZGluZyB0aGUgLm9yaWVudGF0aW9uIHByb3BlcnR5LgoJCQkJZXZlbnQub3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCQkvLyBDYWxsIHRoZSBvcmlnaW5hbGx5LWJvdW5kIGV2ZW50IGhhbmRsZXIgYW5kIHJldHVybiBpdHMgcmVzdWx0LgoJCQkJcmV0dXJuIG9sZF9oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfTsKCQl9Cgl9KTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCBldmVudF9uYW1lICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgkJfSBlbHNlIHsKCQkJaXNQb3J0cmFpdCA9IGVsZW0gJiYgZWxlbS5jbGllbnRXaWR0aCAvIGVsZW0uY2xpZW50SGVpZ2h0IDwgMS4xOwoJCX0KCgkJcmV0dXJuIGlzUG9ydHJhaXQgPyAicG9ydHJhaXQiIDogImxhbmRzY2FwZSI7Cgl9OwoKCSQuZm5bIGV2ZW50X25hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIGV2ZW50X25hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIGV2ZW50X25hbWUgKTsKCX07CgoJLy8galF1ZXJ5IDwgMS44CglpZiAoICQuYXR0ckZuICkgewoJCSQuYXR0ckZuWyBldmVudF9uYW1lIF0gPSB0cnVlOwoJfQoKfSggalF1ZXJ5LCB0aGlzICkpOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImMiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCQlrZWVwTmF0aXZlRGVmYXVsdDogIjpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkvLyBpZiBmYWxzZSBpcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2tzIGRvIG5vdCBjcmVhdGUgdGhlIHBhZ2UKCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQl0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktYm9keS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQsIHsKCQkJcGFnZWJlZm9yZWhpZGU6ICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiwKCQkJcGFnZWJlZm9yZXNob3c6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciCgkJfSk7Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oIGUgKSB7CgkJdGhpcy5zZXRDb250YWluZXJCYWNrZ3JvdW5kKCk7Cgl9LAoKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LnBhcmVudCgpICkgKTsKCX0sCgoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAoIHRoZW1lIHx8IHRoaXMub3B0aW9ucy50aGVtZSApICk7CgkJfQoJfSwKCglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlRGVmaW5lZCA9IG9wdGlvbnMua2VlcE5hdGl2ZSAmJiAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZSApOwoKCQlpZiAoIGtlZXBOYXRpdmVEZWZpbmVkICYmIG9wdGlvbnMua2VlcE5hdGl2ZSAhPT0gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdCApIHsKCQkJcmV0dXJuIFtvcHRpb25zLmtlZXBOYXRpdmUsIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHRdLmpvaW4oICIsICIgKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0OwoJfQp9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCnZhciBjcmVhdGVIYW5kbGVyID0gZnVuY3Rpb24oIHNlcXVlbnRpYWwgKSB7CgoJLy8gRGVmYXVsdCB0byBzZXF1ZW50aWFsCglpZiAoIHNlcXVlbnRpYWwgPT09IHVuZGVmaW5lZCApIHsKCQlzZXF1ZW50aWFsID0gdHJ1ZTsKCX0KCglyZXR1cm4gZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgoJCXZhciBkZWZlcnJlZCA9IG5ldyAkLkRlZmVycmVkKCksCgkJCXJldmVyc2VDbGFzcyA9IHJldmVyc2UgPyAiIHJldmVyc2UiIDogIiIsCgkJCWFjdGl2ZQk9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCXRvU2Nyb2xsID0gYWN0aXZlLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwsCgkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQltYXhUcmFuc2l0aW9uT3ZlcnJpZGUgPSAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGggIT09IGZhbHNlICYmICQubW9iaWxlLndpbmRvdy53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoLAoJCQlub25lID0gISQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyB8fCBtYXhUcmFuc2l0aW9uT3ZlcnJpZGUgfHwgIW5hbWUgfHwgbmFtZSA9PT0gIm5vbmUiIHx8IE1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRvU2Nyb2xsICkgPiAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uKCksCgkJCXRvUHJlQ2xhc3MgPSAiIHVpLXBhZ2UtcHJlLWluIiwKCQkJdG9nZ2xlVmlld3BvcnRDbGFzcyA9IGZ1bmN0aW9uKCkgewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyBuYW1lICk7CgkJCX0sCgkJCXNjcm9sbFBhZ2UgPSBmdW5jdGlvbigpIHsKCQkJCS8vIEJ5IHVzaW5nIHNjcm9sbFRvIGluc3RlYWQgb2Ygc2lsZW50U2Nyb2xsLCB3ZSBjYW4ga2VlcCB0aGluZ3MgYmV0dGVyIGluIG9yZGVyCgkJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdG9TY3JvbGwgKTsKCgkJCQkvLyByZWVuYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJCX0sIDE1MCApOwoJCQl9LAoJCQljbGVhbkZyb20gPSBmdW5jdGlvbigpIHsKCQkJCSRmcm9tCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyAiIG91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoJCQl9LAoJCQlzdGFydE91dCA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gaWYgaXQncyBub3Qgc2VxdWVudGlhbCwgY2FsbCB0aGUgZG9uZU91dCB0cmFuc2l0aW9uIHRvIHN0YXJ0IHRoZSBUTyBwYWdlIGFuaW1hdGluZyBpbiBzaW11bHRhbmVvdXNseQoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCQkJCQlkb25lT3V0KCk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQkkZnJvbS5hbmltYXRpb25Db21wbGV0ZSggZG9uZU91dCApOwoJCQkJfQoKCQkJCS8vIFNldCB0aGUgZnJvbSBwYWdlJ3MgaGVpZ2h0IGFuZCBzdGFydCBpdCB0cmFuc2l0aW9uaW5nIG91dAoJCQkJLy8gTm90ZTogc2V0dGluZyBhbiBleHBsaWNpdCBoZWlnaHQgaGVscHMgZWxpbWluYXRlIHRpbGluZyBpbiB0aGUgdHJhbnNpdGlvbnMKCQkJCSRmcm9tCgkJCQkJLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpICkKCQkJCQkuYWRkQ2xhc3MoIG5hbWUgKyAiIG91dCIgKyByZXZlcnNlQ2xhc3MgKTsKCQkJfSwKCgkJCWRvbmVPdXQgPSBmdW5jdGlvbigpIHsKCgkJCQlpZiAoICRmcm9tICYmIHNlcXVlbnRpYWwgKSB7CgkJCQkJY2xlYW5Gcm9tKCk7CgkJCQl9CgoJCQkJc3RhcnRJbigpOwoJCQl9LAoKCQkJc3RhcnRJbiA9IGZ1bmN0aW9uKCkgewoKCQkJCS8vIFByZXZlbnQgZmxpY2tlcmluZyBpbiBwaG9uZWdhcCBjb250YWluZXI6IHNlZSBjb21tZW50cyBhdCAjNDAyNCByZWdhcmRpbmcgaU9TCgkJCQkkdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoKCQkJCSR0by5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgdG9QcmVDbGFzcyApOwoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggJHRvICk7CgoJCQkJLy8gU2V0IHRvIHBhZ2UgaGVpZ2h0CgkJCQkkdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0b1Njcm9sbCApOwoKCQkJCXNjcm9sbFBhZ2UoKTsKCgkJCQkvLyBSZXN0b3JlcyB2aXNpYmlsaXR5IG9mIHRoZSBuZXcgcGFnZTogYWRkZWQgdG9nZXRoZXIgd2l0aCAkdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoJCQkJJHRvLmNzcyggInotaW5kZXgiLCAiIiApOwoKCQkJCWlmICggIW5vbmUgKSB7CgkJCQkJJHRvLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lSW4gKTsKCQkJCX0KCgkJCQkkdG8KCQkJCQkucmVtb3ZlQ2xhc3MoIHRvUHJlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgaW4iICsgcmV2ZXJzZUNsYXNzICk7CgoJCQkJaWYgKCBub25lICkgewoJCQkJCWRvbmVJbigpOwoJCQkJfQoKCQkJfSwKCgkJCWRvbmVJbiA9IGZ1bmN0aW9uKCkgewoKCQkJCWlmICggIXNlcXVlbnRpYWwgKSB7CgoJCQkJCWlmICggJGZyb20gKSB7CgkJCQkJCWNsZWFuRnJvbSgpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdG8KCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgaW4gcmV2ZXJzZSAiICsgbmFtZSApCgkJCQkJLmhlaWdodCggIiIgKTsKCgkJCQl0b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQkJLy8gSW4gc29tZSBicm93c2VycyAoaU9TNSksIDNEIHRyYW5zaXRpb25zIGJsb2NrIHRoZSBhYmlsaXR5IHRvIHNjcm9sbCB0byB0aGUgZGVzaXJlZCBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdGlvbgoJCQkJLy8gVGhpcyBlbnN1cmVzIHdlIGp1bXAgdG8gdGhhdCBzcG90IGFmdGVyIHRoZSBmYWN0LCBpZiB3ZSBhcmVuJ3QgdGhlcmUgYWxyZWFkeS4KCQkJCWlmICggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpICE9PSB0b1Njcm9sbCApIHsKCQkJCQlzY3JvbGxQYWdlKCk7CgkJCQl9CgoJCQkJZGVmZXJyZWQucmVzb2x2ZSggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgdHJ1ZSApOwoJCQl9OwoKCQl0b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCWlmICggJGZyb20gJiYgIW5vbmUgKSB7CgkJCXN0YXJ0T3V0KCk7CgkJfQoJCWVsc2UgewoJCQlkb25lT3V0KCk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKfTsKCi8vIGdlbmVyYXRlIHRoZSBoYW5kbGVycyBmcm9tIHRoZSBhYm92ZQp2YXIgc2VxdWVudGlhbEhhbmRsZXIgPSBjcmVhdGVIYW5kbGVyKCksCglzaW11bHRhbmVvdXNIYW5kbGVyID0gY3JlYXRlSGFuZGxlciggZmFsc2UgKSwKCWRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpICogMzsKCX07CgovLyBNYWtlIG91ciB0cmFuc2l0aW9uIGhhbmRsZXIgdGhlIHB1YmxpYyBkZWZhdWx0LgokLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSBzZXF1ZW50aWFsSGFuZGxlcjsKCi8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMgPSB7CgkiZGVmYXVsdCI6ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCSJzZXF1ZW50aWFsIjogc2VxdWVudGlhbEhhbmRsZXIsCgkic2ltdWx0YW5lb3VzIjogc2ltdWx0YW5lb3VzSGFuZGxlcgp9OwoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcyA9IHt9OwoKLy8gSWYgdHJhbnNpdGlvbiBpcyBkZWZpbmVkLCBjaGVjayBpZiBjc3MgM0QgdHJhbnNmb3JtcyBhcmUgc3VwcG9ydGVkLCBhbmQgaWYgbm90LCBpZiBhIGZhbGxiYWNrIGlzIHNwZWNpZmllZAokLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCWlmICggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXTsKCQl9CgoJCXJldHVybiB0cmFuc2l0aW9uOwp9OwoKLy8gU2V0IHRoZSBnZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHRvIGRlZmF1bHQgaWYgbm8gaW1wbGVtZW50YXRpb24gd2FzIHNldCBieSB1c2VyCiQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHx8IGRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uOwp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvL2RlZmluZSB2YXJzIGZvciBpbnRlcmFsIHVzZQoJdmFyICR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3csCgkJJGh0bWwgPSAkKCAnaHRtbCcgKSwKCQkkaGVhZCA9ICQoICdoZWFkJyApLAoKCQkvLyBOT1RFOiBwYXRoIGV4dGVuc2lvbnMgZGVwZW5kZW50IG9uIGNvcmUgYXR0cmlidXRlcy4gTW92ZWQgaGVyZSB0byByZW1vdmUgZGVwcyBmcm9tCgkJLy8gICAgICAgJC5tb2JpbGUucGF0aCBkZWZpbml0aW9uCgkJcGF0aCA9ICQuZXh0ZW5kKCQubW9iaWxlLnBhdGgsIHsKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICcmJyArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL2NoZWNrIGlmIHRoZSBzcGVjaWZpZWQgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgbWFpbiBhcHBsaWNhdGlvbiBkb2N1bWVudC4KCQkJaXNGaXJzdFBhZ2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBXZSBvbmx5IGRlYWwgd2l0aCBhYnNvbHV0ZSBwYXRocy4KCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgdGhpcy5kb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8ICggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJLy8gVGhlIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaWYgdGhlIHBhdGggbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYW5kCgkJCQkvLyBpdCBlaXRoZXIgaGFzIG5vIGhhc2ggdmFsdWUsIG9yIHRoZSBoYXNoIGlzIGV4YWN0bHkgZXF1YWwgdG8gdGhlIGlkIG9mIHRoZQoJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJcmV0dXJuIHNhbWVQYXRoICYmICggIXUuaGFzaCB8fCB1Lmhhc2ggPT09ICIjIiB8fCAoIGZwSWQgJiYgdS5oYXNoLnJlcGxhY2UoIC9eIy8sICIiICkgPT09IGZwSWQgKSApOwoJCQl9LAoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCWlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0OiBmdW5jdGlvbiggZG9jVXJsLCByZXFVcmwgKSB7CgkJCQlyZXR1cm4gJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzICYmCgkJCQkJZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiICYmCgkJCQkJcmVxVXJsLnNlYXJjaCggL15odHRwcz86LyApICE9PSAtMTsKCQkJfQoJCX0pLAoKCQkvLyB1c2VkIHRvIHRyYWNrIGxhc3QgdmNsaWNrZWQgZWxlbWVudCB0byBtYWtlIHN1cmUgaXRzIHZhbHVlIGlzIGFkZGVkIHRvIGZvcm0gZGF0YQoJCSRsYXN0VkNsaWNrZWQgPSBudWxsLAoKCQkvL3dpbGwgYmUgZGVmaW5lZCB3aGVuIGEgbGluayBpcyBjbGlja2VkIGFuZCBnaXZlbiBhbiBhY3RpdmUgY2xhc3MKCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsLAoKCQkvLyByZXNvbHZlZCBvbiBkb21yZWFkeQoJCWRvbXJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgoJCS8vdXJsSGlzdG9yeSBpcyBwdXJlbHkgaGVyZSB0byBtYWtlIGd1ZXNzZXMgYXQgd2hldGhlciB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbiB3YXMgY2xpY2tlZAoJCS8vYW5kIHByb3ZpZGUgYW4gYXBwcm9wcmlhdGUgdHJhbnNpdGlvbgoJCXVybEhpc3RvcnkgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LAoKCQkvL2RlZmluZSBmaXJzdCBzZWxlY3RvciB0byByZWNlaXZlIGZvY3VzIHdoZW4gYSBwYWdlIGlzIHNob3duCgkJZm9jdXNhYmxlID0gIlt0YWJpbmRleF0sYSxidXR0b246dmlzaWJsZSxzZWxlY3Q6dmlzaWJsZSxpbnB1dCIsCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGguZG9jdW1lbnRVcmwsCgoJCS8vaWYgdGhlIGRvY3VtZW50IGhhcyBhbiBlbWJlZGRlZCBiYXNlIHRhZywgZG9jdW1lbnRCYXNlIGlzIHNldCB0byBpdHMKCQkvL2luaXRpYWwgdmFsdWUuIElmIGEgYmFzZSB0YWcgZG9lcyBub3QgZXhpc3QsIHRoZW4gd2UgZGVmYXVsdCB0byB0aGUgZG9jdW1lbnRVcmwuCgkJZG9jdW1lbnRCYXNlID0gcGF0aC5kb2N1bWVudEJhc2UsCgoJCS8vY2FjaGUgdGhlIGNvbXBhcmlzb24gb25jZS4KCQlkb2N1bWVudEJhc2VEaWZmZXJzID0gcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzLAoKCQlnZXRTY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQ7CgoJCS8vYmFzZSBlbGVtZW50IG1hbmFnZW1lbnQsIGRlZmluZWQgZGVwZW5kaW5nIG9uIGR5bmFtaWMgYmFzZSB0YWcgc3VwcG9ydAoJCXZhciBiYXNlID0gJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnID8gewoKCQkJLy9kZWZpbmUgYmFzZSBlbGVtZW50LCBmb3IgdXNlIGluIHJvdXRpbmcgYXNzZXQgdXJscyB0aGF0IGFyZSByZWZlcmVuY2VkIGluIEFqYXgtcmVxdWVzdGVkIG1hcmt1cAoJCQllbGVtZW50OiAoICRiYXNlLmxlbmd0aCA/ICRiYXNlIDogJCggIjxiYXNlPiIsIHsgaHJlZjogZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggfSApLnByZXBlbmRUbyggJGhlYWQgKSApLAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXNldDogZnVuY3Rpb24oIGhyZWYgKSB7CgkJCQlocmVmID0gcGF0aC5wYXJzZVVybChocmVmKS5ocmVmTm9IYXNoOwoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGRvY3VtZW50QmFzZSApICk7CgkJCX0sCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgZG9jdW1lbnRCYXNlLmhyZWZOb1NlYXJjaCApOwoJCQl9CgoJCX0gOiB1bmRlZmluZWQ7CgoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCSQubW9iaWxlLmdldERvY3VtZW50VXJsID0gcGF0aC5nZXREb2N1bWVudFVybDsKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCSQubW9iaWxlLmdldERvY3VtZW50QmFzZSA9IHBhdGguZ2V0RG9jdW1lbnRCYXNlOwoKCS8qIGludGVybmFsIHV0aWxpdHkgZnVuY3Rpb25zICovCgoJLy8gTk9URSBJc3N1ZSAjNDk1MCBBbmRyb2lkIHBob25lZ2FwIGRvZXNuJ3QgbmF2aWdhdGUgYmFjayBwcm9wZXJseQoJLy8gICAgICB3aGVuIGEgZnVsbCBwYWdlIHJlZnJlc2ggaGFzIHRha2VuIHBsYWNlLiBJdCBhcHBlYXJzIHRoYXQgaGFzaGNoYW5nZQoJLy8gICAgICBhbmQgcmVwbGFjZXN0YXRlIGhpc3RvcnkgYWx0ZXJhdGlvbnMgd29yayBmaW5lIGJ1dCB3ZSBuZWVkIHRvIHN1cHBvcnQKCS8vICAgICAgYm90aCBmb3JtcyBvZiBoaXN0b3J5IHRyYXZlcnNhbCBpbiBvdXIgY29kZSB0aGF0IHVzZXMgYmFja3dhcmQgaGlzdG9yeQoJLy8gICAgICBtb3ZlbWVudAoJJC5tb2JpbGUuYmFjayA9IGZ1bmN0aW9uKCkgewoJCXZhciBuYXYgPSB3aW5kb3cubmF2aWdhdG9yOwoKCQkvLyBpZiB0aGUgc2V0dGluZyBpcyBvbiBhbmQgdGhlIG5hdmlnYXRvciBvYmplY3QgaXMKCQkvLyBhdmFpbGFibGUgdXNlIHRoZSBwaG9uZWdhcCBuYXZpZ2F0aW9uIGNhcGFiaWxpdHkKCQlpZiggdGhpcy5waG9uZWdhcE5hdmlnYXRpb25FbmFibGVkICYmCgkJCW5hdiAmJgoJCQluYXYuYXBwICYmCgkJCW5hdi5hcHAuYmFja0hpc3RvcnkgKXsKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSgpOwoJCX0gZWxzZSB7CgkJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCQl9Cgl9OwoKCS8vZGlyZWN0IGZvY3VzIHRvIHRoZSBwYWdlIHRpdGxlLCBvciBvdGhlcndpc2UgZmlyc3QgZm9jdXNhYmxlIGVsZW1lbnQKCSQubW9iaWxlLmZvY3VzUGFnZSA9IGZ1bmN0aW9uICggcGFnZSApIHsKCQl2YXIgYXV0b2ZvY3VzID0gcGFnZS5maW5kKCAiW2F1dG9mb2N1c10iICksCgkJCXBhZ2VUaXRsZSA9IHBhZ2UuZmluZCggIi51aS10aXRsZTplcSgwKSIgKTsKCgkJaWYgKCBhdXRvZm9jdXMubGVuZ3RoICkgewoJCQlhdXRvZm9jdXMuZm9jdXMoKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBwYWdlVGl0bGUubGVuZ3RoICkgewoJCQlwYWdlVGl0bGUuZm9jdXMoKTsKCQl9IGVsc2V7CgkJCXBhZ2UuZm9jdXMoKTsKCQl9Cgl9OwoKCS8vcmVtb3ZlIGFjdGl2ZSBjbGFzc2VzIGFmdGVyIHBhZ2UgdHJhbnNpdGlvbiBvciBlcnJvcgoJZnVuY3Rpb24gcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZVJlbW92YWwgKSB7CgkJaWYgKCAhISRhY3RpdmVDbGlja2VkTGluayAmJiAoICEkYWN0aXZlQ2xpY2tlZExpbmsuY2xvc2VzdCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICkubGVuZ3RoIHx8IGZvcmNlUmVtb3ZhbCApICkgewoJCQkkYWN0aXZlQ2xpY2tlZExpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfQoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGw7Cgl9CgoJZnVuY3Rpb24gcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpIHsKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJaWYgKCBwYWdlVHJhbnNpdGlvblF1ZXVlLmxlbmd0aCA+IDAgKSB7CgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UuYXBwbHkoIG51bGwsIHBhZ2VUcmFuc2l0aW9uUXVldWUucG9wKCkgKTsKCQl9Cgl9CgoJLy8gU2F2ZSB0aGUgbGFzdCBzY3JvbGwgZGlzdGFuY2UgcGVyIHBhZ2UsIGJlZm9yZSBpdCBpcyBoaWRkZW4KCXZhciBzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWUsCgkJc2V0TGFzdFNjcm9sbCwgZGVsYXllZFNldExhc3RTY3JvbGw7CgoJc2V0TGFzdFNjcm9sbCA9IGZ1bmN0aW9uKCkgewoJCS8vIHRoaXMgYmFycmllciBwcmV2ZW50cyBzZXR0aW5nIHRoZSBzY3JvbGwgdmFsdWUgYmFzZWQgb24gdGhlIGJyb3dzZXIKCQkvLyBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQlpZiAoICFzZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCk7CgoJCWlmICggYWN0aXZlICkgewoJCQl2YXIgbGFzdFNjcm9sbCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCQkvLyBTZXQgYWN0aXZlIHBhZ2UncyBsYXN0U2Nyb2xsIHByb3AuCgkJCS8vIElmIHRoZSBsb2NhdGlvbiB3ZSdyZSBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJYWN0aXZlLmxhc3RTY3JvbGwgPSBsYXN0U2Nyb2xsIDwgJC5tb2JpbGUubWluU2Nyb2xsQmFjayA/ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsIDogbGFzdFNjcm9sbDsKCQl9Cgl9OwoKCS8vIGJpbmQgdG8gc2Nyb2xsc3RvcCB0byBnYXRoZXIgc2Nyb2xsIHBvc2l0aW9uLiBUaGUgZGVsYXkgYWxsb3dzIGZvciB0aGUgaGFzaGNoYW5nZQoJLy8gZXZlbnQgdG8gZmlyZSBhbmQgZGlzYWJsZSBzY3JvbGwgcmVjb3JkaW5nIGluIHRoZSBjYXNlIHdoZXJlIHRoZSBicm93c2VyIHNjcm9sbHMKCS8vIHRvIHRoZSBoYXNoIHRhcmdldHMgbG9jYXRpb24gKHNvbWV0aW1lcyB0aGUgdG9wIG9mIHRoZSBwYWdlKS4gb25jZSBwYWdlY2hhbmdlIGZpcmVzCgkvLyBnZXRMYXN0U2Nyb2xsIGlzIGFnYWluIHBlcm1pdHRlZCB0byBvcGVyYXRlCglkZWxheWVkU2V0TGFzdFNjcm9sbCA9IGZ1bmN0aW9uKCkgewoJCXNldFRpbWVvdXQoIHNldExhc3RTY3JvbGwsIDEwMCApOwoJfTsKCgkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLCB0aGlzIG9ubHkgd29ya3MKCS8vIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uIGlzIGRlbGF5ZWQgZm9yIDEwMG1zIGFmdGVyCgkvLyB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlIHBvc2l0aW9uIGJlY2F1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UKCSR3aW5kb3cuYmluZCggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJCXNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7Cgl9KTsKCgkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkkd2luZG93Lm9uZSggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCX0pOwoKCS8vIHdhaXQgdW50aWwgdGhlIG1vYmlsZSBwYWdlIGNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIHRvIGJpbmQgdG8gcGFnZWNoYW5nZQoJJHdpbmRvdy5vbmUoICJwYWdlY29udGFpbmVyY3JlYXRlIiwgZnVuY3Rpb24oKSB7CgkJLy8gb25jZSB0aGUgcGFnZSBoYXMgY2hhbmdlZCwgcmUtZW5hYmxlIHRoZSBzY3JvbGwgcmVjb3JkaW5nCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5iaW5kKCAicGFnZWNoYW5nZSIsIGZ1bmN0aW9uKCkgewoKCQkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gcmVtb3ZlIGFueSBiaW5kaW5nIHRoYXQgcHJldmlvdXNseSBleGlzdGVkIG9uIHRoZSBnZXQgc2Nyb2xsCgkJCS8vIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIGRpZmZlcmVudCB0aGFuIHRoZSBzY3JvbGwgZWxlbWVudCBkZXRlcm1pbmVkIGZvcgoJCQkvLyB0aGlzIHBhZ2UgcHJldmlvdXNseQoJCQkkd2luZG93LnVuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCQkJLy8gZGV0ZXJtaW5lIGFuZCBiaW5kIHRvIHRoZSBjdXJyZW50IHNjb2xsIGVsZW1lbnQgd2hpY2ggbWF5IGJlIHRoZSB3aW5kb3cKCQkJLy8gb3IgaW4gdGhlIGNhc2Ugb2YgdG91Y2ggb3ZlcmZsb3cgdGhlIGVsZW1lbnQgd2l0aCB0b3VjaCBvdmVyZmxvdwoJCQkkd2luZG93LmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCQl9KTsKCX0pOwoKCS8vIGJpbmQgdG8gc2Nyb2xsc3RvcCBmb3IgdGhlIGZpcnN0IHBhZ2UgYXMgInBhZ2VjaGFuZ2UiIHdvbid0IGJlIGZpcmVkIGluIHRoYXQgY2FzZQoJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJLy8gTm8tb3AgaW1wbGVtZW50YXRpb24gb2YgdHJhbnNpdGlvbiBkZWdyYWRhdGlvbgoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiB8fCBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy9mdW5jdGlvbiBmb3IgdHJhbnNpdGlvbmluZyBiZXR3ZWVuIHR3byBleGlzdGluZyBwYWdlcwoJZnVuY3Rpb24gdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCB0cmFuc2l0aW9uLCByZXZlcnNlICkgewoJCWlmICggZnJvbVBhZ2UgKSB7CgkJCS8vdHJpZ2dlciBiZWZvcmUgc2hvdy9oaWRlIGV2ZW50cwoJCQlmcm9tUGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVoaWRlIiwgbnVsbCwgeyBuZXh0UGFnZTogdG9QYWdlIH0gKTsKCQl9CgoJCXRvUGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgoJCS8vY2xlYXIgcGFnZSBsb2FkZXIKCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCgkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB0cmFuc2l0aW9uICk7CgoJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJLy9pc24ndCBvbmUgaW4gb3VyIHRyYW5zaXRpb25IYW5kbGVycyBkaWN0aW9uYXJ5LCB1c2UgdGhlIGRlZmF1bHQgb25lLgoJCS8vY2FsbCB0aGUgaGFuZGxlciBpbW1lZGlhdGVseSB0byBraWNrLW9mZiB0aGUgdHJhbnNpdGlvbi4KCQl2YXIgdGggPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnNbIHRyYW5zaXRpb24gfHwgImRlZmF1bHQiIF0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyLAoJCQlwcm9taXNlID0gdGgoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvUGFnZSwgZnJvbVBhZ2UgKTsKCgkJcHJvbWlzZS5kb25lKGZ1bmN0aW9uKCkgewoJCQkvL3RyaWdnZXIgc2hvdy9oaWRlIGV2ZW50cwoJCQlpZiAoIGZyb21QYWdlICkgewoJCQkJZnJvbVBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAiaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJCX0KCgkJCS8vdHJpZ2dlciBwYWdlc2hvdywgZGVmaW5lIHByZXZQYWdlIGFzIGVpdGhlciBmcm9tUGFnZSBvciBlbXB0eSBqUXVlcnkgb2JqCgkJCXRvUGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkuX3RyaWdnZXIoICJzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgkJfSk7CgoJCXJldHVybiBwcm9taXNlOwoJfQoKCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCA9IGZ1bmN0aW9uIHJlc2V0QWN0aXZlUGFnZUhlaWdodCggaGVpZ2h0ICkgewoJCXZhciBhUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQlhUGFnZVBhZFQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQlhUGFnZVBhZEIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApLAoJCQlhUGFnZUJvcmRlclQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICksCgkJCWFQYWdlQm9yZGVyQiA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggImJvcmRlci1ib3R0b20td2lkdGgiICkgKTsKCgkJaGVpZ2h0ID0gKCB0eXBlb2YgaGVpZ2h0ID09PSAibnVtYmVyIiApPyBoZWlnaHQgOiBnZXRTY3JlZW5IZWlnaHQoKTsKCQkKCQlhUGFnZS5jc3MoICJtaW4taGVpZ2h0IiwgaGVpZ2h0IC0gYVBhZ2VQYWRUIC0gYVBhZ2VQYWRCIC0gYVBhZ2VCb3JkZXJUIC0gYVBhZ2VCb3JkZXJCICk7Cgl9OwoKCS8vc2hhcmVkIHBhZ2UgZW5oYW5jZW1lbnRzCglmdW5jdGlvbiBlbmhhbmNlUGFnZSggJHBhZ2UsIHJvbGUgKSB7CgkJLy8gSWYgYSByb2xlIHdhcyBzcGVjaWZpZWQsIG1ha2Ugc3VyZSB0aGUgZGF0YS1yb2xlIGF0dHJpYnV0ZQoJCS8vIG9uIHRoZSBwYWdlIGVsZW1lbnQgaXMgaW4gc3luYy4KCQlpZiAoIHJvbGUgKSB7CgkJCSRwYWdlLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgcm9sZSApOwoJCX0KCgkJLy9ydW4gcGFnZSBwbHVnaW4KCQkkcGFnZS5wYWdlKCk7Cgl9CgoJLy8gZGV0ZXJtaW5lIHRoZSBjdXJyZW50IGJhc2UgdXJsCglmdW5jdGlvbiBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgewoJCXZhciBjbG9zZXN0QmFzZSA9ICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiBnZXRDbG9zZXN0QmFzZVVybCggJC5tb2JpbGUuYWN0aXZlUGFnZSApICk7CgkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJfQoKCS8qIGV4cG9zZWQgJC5tb2JpbGUgbWV0aG9kcyAqLwoKCS8vYW5pbWF0aW9uIGNvbXBsZXRlIGNhbGxiYWNrCgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zICkgewoJCQlyZXR1cm4gJCggdGhpcyApLm9uZSggJ3dlYmtpdEFuaW1hdGlvbkVuZCBhbmltYXRpb25lbmQnLCBjYWxsYmFjayApOwoJCX0KCQllbHNlewoJCQkvLyBkZWZlciBleGVjdXRpb24gZm9yIGNvbnNpc3RlbmN5IGJldHdlZW4gd2Via2l0L25vbiB3ZWJraXQKCQkJc2V0VGltZW91dCggY2FsbGJhY2ssIDAgKTsKCQkJcmV0dXJuICQoIHRoaXMgKTsKCQl9Cgl9OwoKCS8vZXhwb3NlIHBhdGggb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5wYXRoID0gcGF0aDsKCgkvL2V4cG9zZSBiYXNlIG9iamVjdCBvbiAkLm1vYmlsZQoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7CgoJLy9oaXN0b3J5IHN0YWNrCgkkLm1vYmlsZS51cmxIaXN0b3J5ID0gdXJsSGlzdG9yeTsKCgkkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ID0gZGlhbG9nSGFzaEtleTsKCgkvL2VuYWJsZSBjcm9zcy1kb21haW4gcGFnZSBzdXBwb3J0CgkkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgPSBmYWxzZTsKCgkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgPSBmdW5jdGlvbigpIHsKCQl2YXIgcGFnZSA9ICQoIHRoaXMgKTsKCgkJLy8gd2hlbiBkb20gY2FjaGluZyBpcyBub3QgZW5hYmxlZCBvciB0aGUgcGFnZSBpcyBlbWJlZGRlZCBiaW5kIHRvIHJlbW92ZSB0aGUgcGFnZSBvbiBoaWRlCgkJaWYgKCAhcGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkub3B0aW9ucy5kb21DYWNoZSAmJgoJCQlwYWdlLmlzKCAiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIiApICkgewoKCQkJcGFnZS5iaW5kKCAncGFnZWhpZGUucmVtb3ZlJywgZnVuY3Rpb24oIGUgKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkkdGhpcy50cmlnZ2VyKCBwckV2ZW50ICk7CgoJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9OwoKCS8vIExvYWQgYSBwYWdlIGludG8gdGhlIERPTS4KCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkvLyBUaGlzIGZ1bmN0aW9uIHVzZXMgZGVmZXJyZWQgbm90aWZpY2F0aW9ucyB0byBsZXQgY2FsbGVycwoJCS8vIGtub3cgd2hlbiB0aGUgcGFnZSBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQl2YXIgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgoJCQkvLyBUaGUgZGVmYXVsdCBsb2FkUGFnZSBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieQoJCQkvLyB0aGUgY2FsbGVyLgoJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKSwKCgkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIHBhZ2UgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQlwYWdlID0gbnVsbCwKCgkJCS8vIElmIHRoZSByZWxvYWRQYWdlIG9wdGlvbiBpcyB0cnVlLCBhbmQgdGhlIHBhZ2UgaXMgYWxyZWFkeQoJCQkvLyBpbiB0aGUgRE9NLCBkdXBDYWNoZWRQYWdlIHdpbGwgYmUgc2V0IHRvIHRoZSBwYWdlIGVsZW1lbnQKCQkJLy8gc28gdGhhdCBpdCBjYW4gYmUgcmVtb3ZlZCBhZnRlciB0aGUgbmV3IHZlcnNpb24gb2YgdGhlCgkJCS8vIHBhZ2UgaXMgbG9hZGVkIG9mZiB0aGUgbmV0d29yay4KCQkJZHVwQ2FjaGVkUGFnZSA9IG51bGwsCgoJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIHBhc3NlZCBpbnRvIHRoZSBmdW5jdGlvbi4gVGhpcwoJCQkvLyB2ZXJzaW9uIG9mIHRoZSBVUkwgbWF5IGNvbnRhaW4gZGlhbG9nL3N1YnBhZ2UgcGFyYW1zIGluIGl0LgoJCQlhYnNVcmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCgkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkvLyBhcHBlbmQgdGhlIGRhdGEgdG8gdGhlIFVSTC4KCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gImdldCIgKSB7CgkJCWFic1VybCA9IHBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJc2V0dGluZ3MuZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkUGFnZSBtdXN0IGJlIHRydWUKCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICkgewoJCQlzZXR0aW5ncy5yZWxvYWRQYWdlID0gdHJ1ZTsKCQl9CgoJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJwYWdlIHBhcmFtcy4KCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgcGFnZSB0byBiZSBsb2FkZWQuCgkJdmFyIGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBhYnNVcmwgKSwKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIHBhZ2UuIEZvciBlbWJlZGRlZCBwYWdlcywgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvciBwYWdlcwoJCQkvLyB3aXRoaW4gdGhlIHNhbWUgZG9tYWluIGFzIHRoZSBkb2N1bWVudCBiYXNlLCBpdCBpcyB0aGUgc2l0ZSByZWxhdGl2ZQoJCQkvLyBwYXRoLiBGb3IgY3Jvc3MtZG9tYWluIHBhZ2VzIChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZSBhYnNvbHV0ZSBVcmwKCQkJLy8gdXNlZCB0byBsb2FkIHRoZSBwYWdlLgoJCQlkYXRhVXJsID0gcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBhYnNVcmwgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHN1ZWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkvLyAgICAgIGFyZSBhIHZhbGlkIHVybCBjaGFyIGFuZCBpdCBicmVha3Mgb24gdGhlIGZpcnN0IG9jY3VyZW5jZQoJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkvLyByZWZlcmVuY2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4gSWYgc28sIGl0IG1heSBoYXZlIGJlZW4gZHluYW1pY2FsbHkKCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEgZGF0YS11cmwKCQkvLyBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJiBkYXRhVXJsICYmICFwYXRoLmlzUGF0aCggZGF0YVVybCApICkgewoJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIiMiICsgZGF0YVVybCApCgkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIGRhdGFVcmwgKQoJCQkJLmpxbURhdGEoICJ1cmwiLCBkYXRhVXJsICk7CgkJfQoKCQkKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCBhIHBhZ2UgaW4gdGhlIERPTSwgY2hlY2sgdGhlIFVSTCB0byBzZWUgaWYgaXQKCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZQoJCS8vIHRvIHRoZSBmaXJzdCBwYWdlIGFuZCByZWZlcnMgdG8gbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UsIGVycm9yIG91dC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICkgewoJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZSAmJiBwYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgKSB7CgkJCQkvLyBDaGVjayB0byBtYWtlIHN1cmUgb3VyIGNhY2hlZC1maXJzdC1wYWdlIGlzIGFjdHVhbGx5CgkJCQkvLyBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQgYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMsIHdlIGNoZWNrIGZvciB0aGlzCgkJCQkvLyBjYXNlIGhlcmUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGEgZmlyc3QtcGFnZSB3aXRoIGFuIGlkCgkJCQkvLyBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yCgkJCQkvLyBjYXNlLiBJZiB0aGUgZmlyc3QtcGFnZSBpcyBub3QgaW4gdGhlIERPTSwgdGhlbiB3ZSBsZXQKCQkJCS8vIHRoaW5ncyBmYWxsIHRocm91Z2ggdG8gdGhlIGFqYXggbG9hZGluZyBjb2RlIGJlbG93IHNvCgkJCQkvLyB0aGF0IGl0IGdldHMgcmVsb2FkZWQuCgkJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZS5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQkJcGFnZSA9ICQoICQubW9iaWxlLmZpcnN0UGFnZSApOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCBmaWxlVXJsICkgICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQl9CgkJCgkJLy8gSWYgdGhlIHBhZ2Ugd2UgYXJlIGludGVyZXN0ZWQgaW4gaXMgYWxyZWFkeSBpbiB0aGUgRE9NLAoJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCS8vIHJlbG9hZCBvZiB0aGUgZmlsZSwgd2UgYXJlIGRvbmUuIE90aGVyd2lzZSwgdHJhY2sgdGhlCgkJLy8gZXhpc3RpbmcgcGFnZSBhcyBhIGR1cGxpY2F0ZWQuCgkJaWYgKCBwYWdlLmxlbmd0aCApIHsKCQkJaWYgKCAhc2V0dGluZ3MucmVsb2FkUGFnZSApIHsKCQkJCWVuaGFuY2VQYWdlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIG9wdGlvbnMsIHBhZ2UgKTsKCQkJCS8vaWYgd2UgYXJlIHJlbG9hZGluZyB0aGUgcGFnZSBtYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSBiYXNlIGlmIGl0cyBub3QgYSBwcmVmZXRjaCAKCQkJCWlmKCBiYXNlICYmICFvcHRpb25zLnByZWZldGNoICl7CgkJCQkJYmFzZS5zZXQodXJsKTsKCQkJCX0KCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQkJZHVwQ2FjaGVkUGFnZSA9IHBhZ2U7CgkJfQoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmxFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWxvYWQiICksCgkJCXRyaWdnZXJEYXRhID0geyB1cmw6IHVybCwgYWJzVXJsOiBhYnNVcmwsIGRhdGFVcmw6IGRhdGFVcmwsIGRlZmVycmVkOiBkZWZlcnJlZCwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGxvYWQgYSBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmxFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYgKCBwYmxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQl9CgoJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZiBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJdmFyIGxvYWRNc2dEZWxheSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9LCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKSwKCgkJCQkvLyBTaGFyZWQgbG9naWMgZm9yIGNsZWFyaW5nIHRpbWVvdXQgYW5kIHJlbW92aW5nIG1lc3NhZ2UuCgkJCQloaWRlTXNnID0gZnVuY3Rpb24oKSB7CgoJCQkJCS8vIFN0b3AgbWVzc2FnZSBzaG93IHRpbWVyCgkJCQkJY2xlYXJUaW1lb3V0KCBsb2FkTXNnRGVsYXkgKTsKCgkJCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCQkJCX07CgkJfQoJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQkvLyBvbmx5IHJlc2V0IGlmIHdlIGFyZSBub3QgcHJlZmV0Y2hpbmcgCgkJaWYgKCBiYXNlICYmIHR5cGVvZiBvcHRpb25zLnByZWZldGNoID09PSAidW5kZWZpbmVkIiApIHsKCQkJYmFzZS5yZXNldCgpOwoJCX0KCgkJaWYgKCAhKCAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgfHwgcGF0aC5pc1NhbWVEb21haW4oIGRvY3VtZW50VXJsLCBhYnNVcmwgKSApICkgewoJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCX0gZWxzZSB7CgkJCS8vIExvYWQgdGhlIG5ldyBwYWdlLgoJCQkkLmFqYXgoewoJCQkJdXJsOiBmaWxlVXJsLAoJCQkJdHlwZTogc2V0dGluZ3MudHlwZSwKCQkJCWRhdGE6IHNldHRpbmdzLmRhdGEsCgkJCQljb250ZW50VHlwZTogc2V0dGluZ3MuY29udGVudFR5cGUsCgkJCQlkYXRhVHlwZTogImh0bWwiLAoJCQkJc3VjY2VzczogZnVuY3Rpb24oIGh0bWwsIHRleHRTdGF0dXMsIHhociApIHsKCQkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJCS8vdXNlIGl0IGFzIHRoZSBuZXcgZmlsZVVybCwgYmFzZSBwYXRoLCBldGMKCQkJCQl2YXIgYWxsID0gJCggIjxkaXY+PC9kaXY+IiApLAoKCQkJCQkJLy9wYWdlIHRpdGxlIHJlZ2V4cAoJCQkJCQluZXdQYWdlVGl0bGUgPSBodG1sLm1hdGNoKCAvPHRpdGxlW14+XSo+KFtePF0qKS8gKSAmJiBSZWdFeHAuJDEsCgoJCQkJCQkvLyBUT0RPIGhhbmRsZSBkaWFsb2dzIGFnYWluCgkJCQkJCXBhZ2VFbGVtUmVnZXggPSBuZXcgUmVnRXhwKCAiKDxbXj5dK1xcYmRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgkJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmw9W1wiJ10/KFteXCInPl0qKVtcIiddPyIgKTsKCgoJCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cyBjYW4gYmUgZGlyZWN0ZWQgdG8gdGhlCgkJCQkJLy8gY29ycmVjdCB1cmwuIGxvYWRpbmcgaW50byBhIHRlbXByb3JhcnkgZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJCWlmICggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkgJiYKCQkJCQkJCVJlZ0V4cC4kMSAmJgoJCQkJCQkJZGF0YVVybFJlZ2V4LnRlc3QoIFJlZ0V4cC4kMSApICYmCgkJCQkJCQlSZWdFeHAuJDEgKSB7CgkJCQkJCXVybCA9IGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCAkKCAiPGRpdj4iICsgUmVnRXhwLiQxICsgIjwvZGl2PiIgKS50ZXh0KCkgKTsKCQkJCQl9CgkJCQkJLy9kb250IHVwZGF0ZSB0aGUgYmFzZSB0YWcgaWYgd2UgYXJlIHByZWZldGNoaW5nCgkJCQkJaWYgKCBiYXNlICYmIHR5cGVvZiBvcHRpb25zLnByZWZldGNoID09PSAidW5kZWZpbmVkIikgewoJCQkJCQliYXNlLnNldCggZmlsZVVybCApOwoJCQkJCX0KCgkJCQkJLy93b3JrYXJvdW5kIHRvIGFsbG93IHNjcmlwdHMgdG8gZXhlY3V0ZSB3aGVuIGluY2x1ZGVkIGluIHBhZ2UgZGl2cwoJCQkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoJCQkJCXBhZ2UgPSBhbGwuZmluZCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmlyc3QoKTsKCgkJCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJCQlpZiAoICFwYWdlLmxlbmd0aCApIHsKCQkJCQkJcGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPiIgKyAoIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSB8fCAiIiApICsgIjwvZGl2PiIgKTsKCQkJCQl9CgoJCQkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCQkJaWYgKCB+bmV3UGFnZVRpdGxlLmluZGV4T2YoICImIiApICkgewoJCQkJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJCQl9CgkJCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCQkJfQoKCQkJCQkvL3Jld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsCgkJCQkJaWYgKCAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJCQl2YXIgbmV3UGF0aCA9IHBhdGguZ2V0KCBmaWxlVXJsICk7CgkJCQkJCXBhZ2UuZmluZCggIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgdGhpc0F0dHIgPSAkKCB0aGlzICkuaXMoICdbaHJlZl0nICkgPyAnaHJlZicgOgoJCQkJCQkJCQkkKCB0aGlzICkuaXMoICdbc3JjXScgKSA/ICdzcmMnIDogJ2FjdGlvbicsCgkJCQkJCQkJdGhpc1VybCA9ICQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciApOwoKCQkJCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkJCQkvLyAgICAgICAgICAgIGJhc2UgVVJMLCBhbmQgdGhlbiBwcmVwZW5kcyB3aXRoIHRoZSBuZXcgcGFnZSBVUkwuCgkJCQkJCQkvL2lmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgJycgKTsKCgkJCQkJCQlpZiAoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJCQkJJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCS8vYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJCQkvLyBUT0RPIHRhZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QgcmVtb3ZlZAoJCQkJCS8vICAgICAgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZSBpbiBtYW55CgkJCQkJLy8gICAgICBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJCQlwYWdlCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBmaWxlVXJsICkgKQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICkKCQkJCQkJLmFwcGVuZFRvKCBzZXR0aW5ncy5wYWdlQ29udGFpbmVyICk7CgoJCQkJCS8vIHdhaXQgZm9yIHBhZ2UgY3JlYXRpb24gdG8gbGV2ZXJhZ2Ugb3B0aW9ucyBkZWZpbmVkIG9uIHdpZGdldAoJCQkJCXBhZ2Uub25lKCAncGFnZWNyZWF0ZScsICQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSApOwoKCQkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJCQkvLyBFbmhhbmNpbmcgdGhlIHBhZ2UgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgcGFnZXMgYmVpbmcgaW5zZXJ0ZWQKCQkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLXBhZ2UsIHRoYXQgaXMgdGhlCgkJCQkJLy8gcmVhbCBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQkJfQoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJCWhpZGVNc2coKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCB0aGUgcGFnZSByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLnBhZ2UgPSBwYWdlOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZGVkIHN1Y2Nlc3NmdWxseS4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSwgZHVwQ2FjaGVkUGFnZSApOwoJCQkJfSwKCQkJCWVycm9yOiBmdW5jdGlvbiggeGhyLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biApIHsKCQkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQkJaWYgKCBiYXNlICkgewoJCQkJCQliYXNlLnNldCggcGF0aC5nZXQoKSApOwoJCQkJCX0KCgkJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCQl2YXIgcGxmRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2Vsb2FkZmFpbGVkIiApOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCBwbGZFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJCWlmICggcGxmRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJCWhpZGVNc2coKTsKCgkJCQkJCS8vIHNob3cgZXJyb3IgbWVzc2FnZQoJCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkJCQkvLyBoaWRlIGFmdGVyIGRlbGF5CgkJCQkJCXNldFRpbWVvdXQoICQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZywgMTUwMCApOwoJCQkJCX0KCgkJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKCgkkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cyA9IHsKCQl0eXBlOiAiZ2V0IiwKCQlkYXRhOiB1bmRlZmluZWQsCgkJcmVsb2FkUGFnZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJc2hvd0xvYWRNc2c6IGZhbHNlLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlsb2FkTXNnRGVsYXk6IDUwIC8vIFRoaXMgZGVsYXkgYWxsb3dzIGxvYWRzIHRoYXQgcHVsbCBmcm9tIGJyb3dzZXIgY2FjaGUgdG8gb2NjdXIgd2l0aG91dCBzaG93aW5nIHRoZSBsb2FkaW5nIG1lc3NhZ2UuCgl9OwoKCS8vIFNob3cgYSBzcGVjaWZpYyBwYWdlIGluIHRoZSBwYWdlIGNvbnRhaW5lci4KCSQubW9iaWxlLmNoYW5nZVBhZ2UgPSBmdW5jdGlvbiggdG9QYWdlLCBvcHRpb25zICkgewoJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24gdG8KCQkvLyBzZXJ2aWNlIHRoZSByZXF1ZXN0LgoJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksIGlzVG9QYWdlU3RyaW5nOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCAkLm1vYmlsZS5hY3RpdmVQYWdlOwoKCQlpc1RvUGFnZVN0cmluZyA9ICh0eXBlb2YgdG9QYWdlID09PSAic3RyaW5nIik7CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHRvUGFnZTogdG9QYWdlLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBOT1RFOiBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUgc2ltcGxpZmllZAoJCS8vICAgICAgIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcyBmcm9tIHRoZSBoYXNoCgkJLy8gICAgICAgdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbQoJCS8vICAgICAgIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UgbGlmZSBjeWNsZSBTZWUgaXNzdWUgIzUwODUKCQlpZiAoIGlzVG9QYWdlU3RyaW5nICkgewoJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgc3RyaW5nIHNpbXBseSBjb252ZXJ0IGl0CgkJCXRyaWdnZXJEYXRhLmFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB0b1BhZ2UsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoJCX0gZWxzZSB7CgkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBqUXVlcnkgb2JqZWN0IGdyYWIgdGhlIGFic29sdXRlIHVybCBzdG9yZWQKCQkJLy8gaW4gdGhlIGxvYWRQYWdlIGNhbGxiYWNrIHdoZXJlIGl0IGV4aXN0cwoJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSB0b1BhZ2UuZGF0YSggJ2Fic1VybCcgKTsKCQl9CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZS4KCQltcGMudHJpZ2dlciggcGJjRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmICggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0b1BhZ2UgaW4gdGhlIHRyaWdnZXIKCQkvLyBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG9QYWdlIGlzIHVwZGF0ZWQuCgkJLy8KCQkvLyBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywgYmVjYXVzZSBhbiBvYmplY3QgY2FuCgkJLy8gYWxzbyBiZSByZXBsYWNlZCBieSBhIHN0cmluZwoKCQl0b1BhZ2UgPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgkJaXNUb1BhZ2VTdHJpbmcgPSAodHlwZW9mIHRvUGFnZSA9PT0gInN0cmluZyIpOwoKCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCS8vIElmIHRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgdXJsLCBjYWxsIGxvYWRQYWdlKCkKCQkvLyB0byBtYWtlIHN1cmUgaXQgaXMgbG9hZGVkIGludG8gdGhlIERPTS4gV2UnbGwgbGlzdGVuCgkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJLy8gaXQgaXMgZG9uZSBsb2FkaW5nIG9yIGlmIGFuIGVycm9yIG9jdXJyZWQuCgkJaWYgKCBpc1RvUGFnZVN0cmluZyApIHsKCQkJLy8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlIHNpbXBsaWZpZWQKCQkJLy8gZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zIGZyb20gdGhlIGhhc2gKCQkJLy8gdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbQoJCQkvLyBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJCXNldHRpbmdzLnRhcmdldCA9IHRvUGFnZTsKCgkJCSQubW9iaWxlLmxvYWRQYWdlKCB0b1BhZ2UsIHNldHRpbmdzICkKCQkJCS5kb25lKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIG5ld1BhZ2UsIGR1cENhY2hlZFBhZ2UgKSB7CgkJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQkJCW9wdGlvbnMuZHVwbGljYXRlQ2FjaGVkUGFnZSA9IGR1cENhY2hlZFBhZ2U7CgoJCQkJCS8vIHN0b3JlIHRoZSBvcmlnaW5hbCBhYnNvbHV0ZSB1cmwgc28gdGhhdCBpdCBjYW4gYmUgcHJvdmlkZWQKCQkJCQkvLyB0byBldmVudHMgaW4gdGhlIHRyaWdnZXJEYXRhIG9mIHRoZSBzdWJzZXF1ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJCW5ld1BhZ2UuZGF0YSggJ2Fic1VybCcsIHRyaWdnZXJEYXRhLmFic1VybCApOwoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIG5ld1BhZ2UsIG9wdGlvbnMgKTsKCQkJCX0pCgkJCQkuZmFpbChmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoKCQkJCQkvL2NsZWFyIG91dCB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZQoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoKCQkJCQkvL3JlbGVhc2UgdHJhbnNpdGlvbiBsb2NrIHNvIG5hdmlnYXRpb24gaXMgZnJlZSBhZ2FpbgoJCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJCX0pOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkvLyBzdXJlIHNldHRpbmdzLmRhdGFVcmwgaXMgc2V0IHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB1cmwuIFRoaXMgYWxsb3dzCgkJLy8gdXMgdG8gYXZvaWQgZ2VuZXJhdGluZyBhIGRvY3VtZW50IHVybCB3aXRoIGFuIGlkIGhhc2ggaW4gdGhlIGNhc2Ugd2hlcmUgdGhlCgkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJaWYgKCB0b1BhZ2VbIDAgXSA9PT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gJiYgIXNldHRpbmdzLmRhdGFVcmwgKSB7CgkJCXNldHRpbmdzLmRhdGFVcmwgPSBkb2N1bWVudFVybC5ocmVmTm9IYXNoOwoJCX0KCgkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkvLyBpbnRlcm5hbCBzdGF0ZSBhbmQgdGhlbiB0cmlnZ2VyIGEgdHJhbnNpdGlvbiB0byB0aGUgcGFnZS4KCQl2YXIgZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSwKCQkJdXJsID0gKCBzZXR0aW5ncy5kYXRhVXJsICYmIHBhdGguY29udmVydFVybFRvRGF0YVVybCggc2V0dGluZ3MuZGF0YVVybCApICkgfHwgdG9QYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCS8vIFRoZSBwYWdlVXJsIHZhciBpcyB1c3VhbGx5IHRoZSBzYW1lIGFzIHVybCwgZXhjZXB0IHdoZW4gdXJsIGlzIG9ic2N1cmVkIGFzIGEgZGlhbG9nIHVybC4gcGFnZVVybCBhbHdheXMgY29udGFpbnMgdGhlIGZpbGUgcGF0aAoJCQlwYWdlVXJsID0gdXJsLAoJCQlmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggdXJsICksCgkJCWFjdGl2ZSA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCWFjdGl2ZUlzSW5pdGlhbFBhZ2UgPSB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwLAoJCQloaXN0b3J5RGlyID0gMCwKCQkJcGFnZVRpdGxlID0gZG9jdW1lbnQudGl0bGUsCgkJCWlzRGlhbG9nID0gc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwgdG9QYWdlLmpxbURhdGEoICJyb2xlIiApID09PSAiZGlhbG9nIjsKCgoJCS8vIEJ5IGRlZmF1bHQsIHdlIHByZXZlbnQgY2hhbmdlUGFnZSByZXF1ZXN0cyB3aGVuIHRoZSBmcm9tUGFnZSBhbmQgdG9QYWdlCgkJLy8gYXJlIHRoZSBzYW1lIGVsZW1lbnQsIGJ1dCBmb2xrcyB0aGF0IGdlbmVyYXRlIGNvbnRlbnQgbWFudWFsbHkvZHluYW1pY2FsbHkKCQkvLyBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cKCQkvLyB0aGlzLCB0aGV5IHdpbGwgbmVlZCB0byBjaGFuZ2UgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24KCQkvLyB0byB0cnVlLCAqT1IqLCBwYXNzIGl0IGluIGFzIGFuIG9wdGlvbiB3aGVuIHRoZXkgbWFudWFsbHkgY2FsbCBjaGFuZ2VQYWdlKCkuCgkJLy8gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQgb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZQoJCS8vIGZvcm1QYWdlIGFuZCB0b1BhZ2UgYXJlIGRpZmZlcmVudCBlbGVtZW50cywgc28gdGhleSBtYXkgYmVoYXZlIHVuZXhwZWN0ZWRseS4KCQkvLyBJdCBpcyB1cCB0byB0aGUgZGV2ZWxvcGVyIHRoYXQgdHVybnMgb24gdGhlIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uYSBvcHRpb24KCQkvLyB0byBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCS8vIGFuaW1hdGlvbiB0cmFuc2l0aW9uIGlzIHVzZWQuCgkJaWYgKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUgdXJsSGlzdG9yeSBpbiBzeW5jIHdpdGggdGhlIGhhc2ggY2hhbmdlcwoJCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJfQoKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhZ2Ugd2UgYXJlIGdpdmVuIGhhcyBhbHJlYWR5IGJlZW4gZW5oYW5jZWQuCgkJZW5oYW5jZVBhZ2UoIHRvUGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0byBzZWUgaWYgdGhlCgkJLy8gcGFnZSBpcyBhbHJlYWR5IHdpdGhpbiB0aGUgdXJsSGlzdG9yeSBzdGFjay4gSWYgc28sIHdlJ2xsIGFzc3VtZSB0aGUgdXNlciBoaXQKCQkvLyB0aGUgZm9yd2FyZC9iYWNrIGJ1dHRvbiBhbmQgd2lsbCB0cnkgdG8gbWF0Y2ggdGhlIHRyYW5zaXRpb24gYWNjb3JkaW5nbHkuCgkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJaGlzdG9yeURpciA9IG9wdGlvbnMuZGlyZWN0aW9uID09PSAiYmFjayIgPyAtMSA6IDE7CgkJfQoKCQkvLyBLaWxsIHRoZSBrZXlib2FyZC4KCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gc3RvcCBjcmF3bGluZyB0aGUgZW50aXJlIGRvY3VtZW50IHRvIGtpbGwgZm9jdXMuIEluc3RlYWQsCgkJLy8gICAgICAgICAgICB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkgaGFuZGxlciBzbyB3ZSBhbHJlYWR5IGhhdmUKCQkvLyAgICAgICAgICAgIHRoZSBlbGVtZW50IGluIGhhbmQgYXQgdGhpcyBwb2ludC4KCQkvLyBXcmFwIHRoaXMgaW4gYSB0cnkvY2F0Y2ggYmxvY2sgc2luY2UgSUU5IHRocm93ICJVbnNwZWNpZmllZCBlcnJvciIgaWYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudAoJCS8vIGlzIHVuZGVmaW5lZCB3aGVuIHdlIGFyZSBpbiBhbiBJRnJhbWUuCgkJdHJ5IHsKCQkJaWYgKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ2JvZHknICkgewoJCQkJJCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCApLmJsdXIoKTsKCQkJfSBlbHNlIHsKCQkJCSQoICJpbnB1dDpmb2N1cywgdGV4dGFyZWE6Zm9jdXMsIHNlbGVjdDpmb2N1cyIgKS5ibHVyKCk7CgkJCX0KCQl9IGNhdGNoKCBlICkge30KCgkJLy8gUmVjb3JkIHdoZXRoZXIgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB3aGVyZSBhIGRpYWxvZyB1c2VkIHRvIGJlIC0gaWYgc28sIGRvIG5vdCBhZGQgYSBuZXcgaGlzdG9yeSBlbnRyeSBhbmQgZG8gbm90IGNoYW5nZSB0aGUgaGFzaCBlaXRoZXIKCQl2YXIgYWxyZWFkeVRoZXJlID0gZmFsc2U7CgoJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCS8vIHRvIGFwcGVuZCB0aGUgZGlhbG9nSGFzaEtleSB0byB0aGUgdXJsIG9mIHRoZSBjdXJyZW50IHBhZ2UuCgkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlIHNob3VsZAoJCQkvLyBiZSBhbiBlbXB0eSBzdHJpbmcuIE1vdmluZyB0aGUgdW5kZWZpbmVkIC0+IGVtcHR5IHN0cmluZyBiYWNrIGludG8KCQkJLy8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyIHJlcHJlc2VudHMKCQkJLy8gdGhlIHVybCBzdGF0ZQoKCQkJLy8gSWYgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB0aGF0IG9uY2UgYmVsb25nZWQgdG8gYSBkaWFsb2csIHJldXNlCgkJCS8vIHRoaXMgc3RhdGUgd2l0aG91dCBhZGRpbmcgdG8gdXJsSGlzdG9yeSBhbmQgd2l0aG91dCBtb2RpZnlpbmcgdGhlIGhhc2guCgkJCS8vIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZCB3ZSdyZQoJCQkvLyBhYm91dCB0byBkaXNwbGF5IGFub3RoZXIgZGlhbG9nLCB0aGVuIHdlIG11c3QgYWRkIGFub3RoZXIgaGFzaCBhbmQKCQkJLy8gaGlzdG9yeSBlbnRyeSBvbiB0b3Agc28gdGhhdCBvbmUgbWF5IG5hdmlnYXRlIGJhY2sgdG8gdGhlIG9yaWdpbmFsIGRpYWxvZwoJCQlpZiAoIGFjdGl2ZS51cmwgJiYKCQkJCWFjdGl2ZS51cmwuaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYKCQkJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYKCQkJCSEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSAmJgoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQlhbHJlYWR5VGhlcmUgPSB0cnVlOwoJCQl9CgoJCQkvLyBOb3JtYWxseSwgd2UgdGFjayBvbiBhIGRpYWxvZyBoYXNoIGtleSwgYnV0IGlmIHRoaXMgaXMgdGhlIGxvY2F0aW9uIG9mIGEgc3RhbGUgZGlhbG9nLAoJCQkvLyB3ZSByZXVzZSB0aGUgVVJMIGZyb20gdGhlIGVudHJ5CgkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApOwoKCQkJLy8gYWNjb3VudCBmb3IgYWJzb2x1dGUgdXJscyBpbnN0ZWFkIG9mIGp1c3QgcmVsYXRpdmUgdXJscyB1c2UgYXMgaGFzaGVzCgkJCWlmKCAhYWxyZWFkeVRoZXJlICYmIHVybC5pbmRleE9mKCIjIikgPiAtMSApIHsKCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQl9IGVsc2UgewoJCQkJdXJsICs9ICIjIiArIGRpYWxvZ0hhc2hLZXk7CgkJCX0KCgkJCS8vIHRhY2sgb24gYW5vdGhlciBkaWFsb2dIYXNoS2V5IGlmIHRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIGluaXRpYWwgaGFzaAoJCQkvLyB0aGlzIG1ha2VzIHN1cmUgdGhhdCBhIGhpc3RvcnkgZW50cnkgaXMgY3JlYXRlZCBmb3IgdGhpcyBkaWFsb2cKCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJdXJsICs9IGRpYWxvZ0hhc2hLZXk7CgkJCX0KCQl9CgoJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QgdXNlIHBhZ2VUaXRsZQoJCXZhciBuZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKT8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fCB0b1BhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maW5kKCAiLnVpLXRpdGxlIiApLnRleHQoKTsKCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCXBhZ2VUaXRsZSA9IG5ld1BhZ2VUaXRsZTsKCQl9CgkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIsIHBhZ2VUaXRsZSApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJc2V0dGluZ3MudHJhbnNpdGlvbiA9IHNldHRpbmdzLnRyYW5zaXRpb24gfHwKCQkJKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkgfHwKCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCS8vYWRkIHBhZ2UgdG8gaGlzdG9yeSBzdGFjayBpZiBpdCdzIG5vdCBiYWNrIG9yIGZvcndhcmQKCQlpZiAoICFoaXN0b3J5RGlyICYmIGFscmVhZHlUaGVyZSApIHsKCQkJdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS5wYWdlVXJsID0gcGFnZVVybDsKCQl9CgoJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQlpZiAoIHVybCAmJiAhc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCXZhciBwYXJhbXM7CgoJCQkvLyByZWJ1aWxkaW5nIHRoZSBoYXNoIGhlcmUgc2luY2Ugd2UgbG9vc2UgaXQgZWFybGllciBvbgoJCQkvLyBUT0RPIHByZXNlcnZlIHRoZSBvcmlnaW5hbGx5IHBhc3NlZCBpbiBwYXRoCgkJCWlmKCAhcGF0aC5pc1BhdGgoIHVybCApICYmIHVybC5pbmRleE9mKCAiIyIgKSA8IDAgKSB7CgkJCQl1cmwgPSAiIyIgKyB1cmw7CgkJCX0KCgkJCS8vIFRPRE8gdGhlIHByb3BlcnR5IG5hbWVzIGhlcmUgYXJlIGp1c3Qgc2lsbHkKCQkJcGFyYW1zID0gewoJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCXRpdGxlOiBwYWdlVGl0bGUsCgkJCQlwYWdlVXJsOiBwYWdlVXJsLAoJCQkJcm9sZTogc2V0dGluZ3Mucm9sZQoJCQl9OwoKCQkJaWYgKCBzZXR0aW5ncy5jaGFuZ2VIYXNoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHBhcmFtcywgdHJ1ZSk7CgkJCX0gZWxzZSBpZiAoIHRvUGFnZVsgMCBdICE9PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCB1cmwsIHBhcmFtcyApOwoJCQl9CgkJfQoKCQkvL3NldCBwYWdlIHRpdGxlCgkJZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7CgoJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UKCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBzZXR0aW5ncy5yZXZlcnNlICkKCQkJLmRvbmUoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gU2VuZCBmb2N1cyB0byB0aGUgbmV3bHkgc2hvd24gcGFnZS4gTW92ZWQgZnJvbSBwcm9taXNlIC5kb25lIGJpbmRpbmcgaW4gdHJhbnNpdGlvblBhZ2VzCgkJCQkvLyBpdHNlbGYgdG8gYXZvaWQgaWUgYnVnIHRoYXQgcmVwb3J0cyBvZmZzZXRXaWR0aCBhcyA+IDAgKGNvcmUgY2hlY2sgZm9yIHZpc2liaWxpdHkpCgkJCQkvLyBkZXNwaXRlIHZpc2liaWxpdHk6IGhpZGRlbiBhZGRyZXNzZXMgaXNzdWUgIzI5NjUKCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMjk2NQoJCQkJaWYgKCAhYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0b1BhZ2UgKTsKCQkJCX0KCgkJCQlyZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQl9KTsKCX07CgoJJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cyA9IHsKCQl0cmFuc2l0aW9uOiB1bmRlZmluZWQsCgkJcmV2ZXJzZTogZmFsc2UsCgkJY2hhbmdlSGFzaDogdHJ1ZSwKCQlmcm9tSGFzaENoYW5nZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJZHVwbGljYXRlQ2FjaGVkUGFnZTogdW5kZWZpbmVkLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlzaG93TG9hZE1zZzogdHJ1ZSwgLy9sb2FkaW5nIG1lc3NhZ2Ugc2hvd3MgYnkgZGVmYXVsdCB3aGVuIHBhZ2VzIGFyZSBiZWluZyBmZXRjaGVkIGR1cmluZyBjaGFuZ2VQYWdlCgkJZGF0YVVybDogdW5kZWZpbmVkLAoJCWZyb21QYWdlOiB1bmRlZmluZWQsCgkJYWxsb3dTYW1lUGFnZVRyYW5zaXRpb246IGZhbHNlCgl9OwoKLyogRXZlbnQgQmluZGluZ3MgLSBoYXNoY2hhbmdlLCBzdWJtaXQsIGFuZCBjbGljayAqLwoJZnVuY3Rpb24gZmluZENsb3Nlc3RMaW5rKCBlbGUgKQoJewoJCXdoaWxlICggZWxlICkgewoJCQkvLyBMb29rIGZvciB0aGUgY2xvc2VzdCBlbGVtZW50IHdpdGggYSBub2RlTmFtZSBvZiAiYSIuCgkJCS8vIE5vdGUgdGhhdCB3ZSBhcmUgY2hlY2tpbmcgaWYgd2UgaGF2ZSBhIHZhbGlkIG5vZGVOYW1lCgkJCS8vIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGFjY2VzcyBpdC4gVGhpcyBpcyBiZWNhdXNlIHRoZQoJCQkvLyBub2RlIHdlIGdldCBjYWxsZWQgd2l0aCBjb3VsZCBoYXZlIG9yaWdpbmF0ZWQgZnJvbSB3aXRoaW4KCQkJLy8gYW4gZW1iZWRkZWQgU1ZHIGRvY3VtZW50IHdoZXJlIHNvbWUgc3ltYm9sIGluc3RhbmNlIGVsZW1lbnRzCgkJCS8vIGRvbid0IGhhdmUgbm9kZU5hbWUgZGVmaW5lZCBvbiB0aGVtLCBvciBzdHJpbmdzIGFyZSBvZiB0eXBlCgkJCS8vIFNWR0FuaW1hdGVkU3RyaW5nLgoJCQlpZiAoICggdHlwZW9mIGVsZS5ub2RlTmFtZSA9PT0gInN0cmluZyIgKSAmJiBlbGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImEiICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBlbGU7Cgl9CgoJLy8gVGhlIGJhc2UgVVJMIGZvciBhbnkgZ2l2ZW4gZWxlbWVudCBkZXBlbmRzIG9uIHRoZSBwYWdlIGl0IHJlc2lkZXMgaW4uCglmdW5jdGlvbiBnZXRDbG9zZXN0QmFzZVVybCggZWxlICkKCXsKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhZ2UgYW5kIGV4dHJhY3Qgb3V0IGl0cyB1cmwuCgkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQliYXNlID0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCWlmICggIXVybCB8fCAhcGF0aC5pc1BhdGgoIHVybCApICkgewoJCQl1cmwgPSBiYXNlOwoJCX0KCgkJcmV0dXJuIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UpOwoJfQoKCS8vVGhlIGZvbGxvd2luZyBldmVudCBiaW5kaW5ncyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vdGhlIGZvbGxvd2luZyBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgPSBmdW5jdGlvbigpIHsKCQl2YXIgZ2V0QWpheEZvcm1EYXRhID0gZnVuY3Rpb24oICRmb3JtLCBjYWxjdWxhdGVPbmx5ICkgewoJCQl2YXIgdXJsLCByZXQgPSB0cnVlLCBmb3JtRGF0YSwgdmNsaWNrZWROYW1lLCBtZXRob2Q7CgkJCQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCB8fAoJCQkJCS8vIHRlc3QgdGhhdCB0aGUgZm9ybSBpcywgaXRzZWxmLCBhamF4IGZhbHNlCgkJCQkJJGZvcm0uaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8CgkJCQkJLy8gdGVzdCB0aGF0ICQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCBhbmQKCQkJCQkvLyB0aGUgZm9ybSBvciBvbmUgb2YgaXQncyBwYXJlbnRzIGlzIGFqYXg9ZmFsc2UKCQkJCQkhJGZvcm0uanFtSGlqYWNrYWJsZSgpLmxlbmd0aCB8fAoJCQkJCSRmb3JtLmF0dHIoICJ0YXJnZXQiICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXVybCA9ICRmb3JtLmF0dHIoICJhY3Rpb24iICk7CgkJCW1ldGhvZCA9ICggJGZvcm0uYXR0ciggIm1ldGhvZCIgKSB8fCAiZ2V0IiApLnRvTG93ZXJDYXNlKCk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApOwoKCQkJCS8vIE5PVEU6IElmIHRoZSBtZXRob2QgaXMgImdldCIsIHdlIG5lZWQgdG8gc3RyaXAgb2ZmIHRoZSBxdWVyeSBzdHJpbmcKCQkJCS8vIGJlY2F1c2UgaXQgd2lsbCBnZXQgcmVwbGFjZWQgd2l0aCB0aGUgbmV3IGZvcm0gZGF0YS4gU2VlIGlzc3VlICM1NzEwLgoJCQkJaWYgKCBtZXRob2QgPT09ICJnZXQiICkgewoJCQkJCXVybCA9IHBhdGgucGFyc2VVcmwoIHVybCApLmhyZWZOb1NlYXJjaDsKCQkJCX0KCgkJCQlpZiAoIHVybCA9PT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsIGdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApICk7CgoJCQlpZiAoICggcGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIHVybCApICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmICggIWNhbGN1bGF0ZU9ubHkgKSB7CgkJCQlmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZUFycmF5KCk7CgoJCQkJaWYgKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWRbIDAgXS5mb3JtID09PSAkZm9ybVsgMCBdICkgewoJCQkJCXZjbGlja2VkTmFtZSA9ICRsYXN0VkNsaWNrZWQuYXR0ciggIm5hbWUiICk7CgkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCS8vIE1ha2Ugc3VyZSB0aGUgbGFzdCBjbGlja2VkIGVsZW1lbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGZvcm0KCQkJCQkJJC5lYWNoKCBmb3JtRGF0YSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkJCQlpZiAoIHZhbHVlLm5hbWUgPT09IHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCQkvLyBVbnNldCB2Y2xpY2tlZE5hbWUgLSB3ZSd2ZSBmb3VuZCBpdCBpbiB0aGUgc2VyaWFsaXplZCBkYXRhIGFscmVhZHkKCQkJCQkJCQl2Y2xpY2tlZE5hbWUgPSAiIjsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCWZvcm1EYXRhLnB1c2goIHsgbmFtZTogdmNsaWNrZWROYW1lLCB2YWx1ZTogJGxhc3RWQ2xpY2tlZC5hdHRyKCAidmFsdWUiICkgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldCA9IHsKCQkJCQl1cmw6IHVybCwKCQkJCQlvcHRpb25zOiB7CgkJCQkJCXR5cGU6CQltZXRob2QsCgkJCQkJCWRhdGE6CQkkLnBhcmFtKCBmb3JtRGF0YSApLAoJCQkJCQl0cmFuc2l0aW9uOgkkZm9ybS5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQkJcmV2ZXJzZToJJGZvcm0uanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiLAoJCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZvcm1EYXRhID0gZ2V0QWpheEZvcm1EYXRhKCAkKCB0aGlzICkgKTsKCgkJCWlmICggZm9ybURhdGEgKSB7CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBmb3JtRGF0YS51cmwsIGZvcm1EYXRhLm9wdGlvbnMgKTsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkYnRuLCBidG5FbHMsIHRhcmdldCA9IGV2ZW50LnRhcmdldCwgbmVlZENsb3Nlc3QgPSBmYWxzZTsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVjb3JkIHRoYXQgdGhpcyBlbGVtZW50IHdhcyBjbGlja2VkLCBpbiBjYXNlIHdlIG5lZWQgaXQgZm9yIGNvcnJlY3QKCQkJLy8gZm9ybSBzdWJtaXNzaW9uIGR1cmluZyB0aGUgInN1Ym1pdCIgaGFuZGxlciBhYm92ZQoJCQkkbGFzdFZDbGlja2VkID0gJCggdGFyZ2V0ICk7CgoJCQkvLyBUcnkgdG8gZmluZCBhIHRhcmdldCBlbGVtZW50IHRvIHdoaWNoIHRoZSBhY3RpdmUgY2xhc3Mgd2lsbCBiZSBhcHBsaWVkCgkJCWlmICggJC5kYXRhKCB0YXJnZXQsICJtb2JpbGUtYnV0dG9uIiApICkgewoJCQkJLy8gSWYgdGhlIGZvcm0gd2lsbCBub3QgYmUgc3VibWl0dGVkIHZpYSBBSkFYLCBkbyBub3QgYWRkIGFjdGl2ZSBjbGFzcwoJCQkJaWYgKCAhZ2V0QWpheEZvcm1EYXRhKCAkKCB0YXJnZXQgKS5jbG9zZXN0KCAiZm9ybSIgKSwgdHJ1ZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vIFdlIHdpbGwgYXBwbHkgdGhlIGFjdGl2ZSBzdGF0ZSB0byB0aGlzIGJ1dHRvbiB3aWRnZXQgLSB0aGUgcGFyZW50CgkJCQkvLyBvZiB0aGUgaW5wdXQgdGhhdCB3YXMgY2xpY2tlZCB3aWxsIGhhdmUgdGhlIGFzc29jaWF0ZWQgZGF0YQoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRhcmdldCA9IGZpbmRDbG9zZXN0TGluayggdGFyZ2V0ICk7CgkJCQlpZiAoICEoIHRhcmdldCAmJiBwYXRoLnBhcnNlVXJsKCB0YXJnZXQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUKCQkJCS8vIGxpbmsgd3JhcHBpbmcgY2FuIGJlIGF2b2lkZWQKCQkJCWlmICggISQoIHRhcmdldCApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBBdm9pZCBjYWxsaW5nIC5jbG9zZXN0IGJ5IHVzaW5nIHRoZSBkYXRhIHNldCBkdXJpbmcgLmJ1dHRvbk1hcmt1cCgpCgkJCS8vIExpc3QgaXRlbXMgaGF2ZSB0aGUgYnV0dG9uIGRhdGEgaW4gdGhlIHBhcmVudCBvZiB0aGUgZWxlbWVudCBjbGlja2VkCgkJCWlmICggISF+dGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCAidWktbGluay1pbmhlcml0IiApICkgewoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldC5wYXJlbnROb2RlLCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCQl9CgkJCS8vIE90aGVyd2lzZSwgbG9vayBmb3IgdGhlIGRhdGEgb24gdGhlIHRhcmdldCBpdHNlbGYKCQkJfSBlbHNlIHsKCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCX0KCQkJLy8gSWYgZm91bmQsIGdyYWIgdGhlIGJ1dHRvbidzIG91dGVyIGVsZW1lbnQKCQkJaWYgKCBidG5FbHMgKSB7CgkJCQl0YXJnZXQgPSBidG5FbHMub3V0ZXI7CgkJCX0gZWxzZSB7CgkJCQluZWVkQ2xvc2VzdCA9IHRydWU7CgkJCX0KCgkJCSRidG4gPSAkKCB0YXJnZXQgKTsKCQkJLy8gSWYgdGhlIG91dGVyIGVsZW1lbnQgd2Fzbid0IGZvdW5kIGJ5IHRoZSBvdXIgaGV1cmlzdGljcywgdXNlIC5jbG9zZXN0KCkKCQkJaWYgKCBuZWVkQ2xvc2VzdCApIHsKCQkJCSRidG4gPSAkYnRuLmNsb3Nlc3QoICIudWktYnRuIiApOwoJCQl9CgoJCQlpZiAoICRidG4ubGVuZ3RoID4gMCAmJiAhJGJ0bi5oYXNDbGFzcyggInVpLWRpc2FibGVkIiApICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSAkYnRuOwoJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIGNsaWNrIHJvdXRpbmcgLSBkaXJlY3QgdG8gSFRUUCBvciBBamF4LCBhY2NvcmRpbmdseQoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkIHx8IGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICksICRsaW5rID0gJCggbGluayApLCBodHRwQ2xlYW51cDsKCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCX07CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBiYXNlVXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICksCgoJCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gWFhYX2pibGFzOiBJZGVhbGx5IGxpbmtzIHRvIGFwcGxpY2F0aW9uIHBhZ2VzIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMKCQkJLy8gICAgICAgICAgICBhbiB1cmwgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggYSBoYXNoIHRoYXQgaXMgZWl0aGVyCgkJCS8vICAgICAgICAgICAgdGhlIHNpdGUgcmVsYXRpdmUgcGF0aCBvciBpZCB0byB0aGUgcGFnZS4gQnV0IHNvbWUgb2YgdGhlCgkJCS8vICAgICAgICAgICAgaW50ZXJuYWwgY29kZSB0aGF0IGR5bmFtaWNhbGx5IGdlbmVyYXRlcyBzdWItcGFnZXMgZm9yIG5lc3RlZAoJCQkvLyAgICAgICAgICAgIGxpc3RzIGFuZCBzZWxlY3QgZGlhbG9ncywganVzdCB3cml0ZSBhIGhhc2ggaW4gdGhlIGxpbmsgdGhleQoJCQkvLyAgICAgICAgICAgIGNyZWF0ZS4gVGhpcyBtZWFucyB0aGUgYWN0dWFsIFVSTCBwYXRoIGlzIGJhc2VkIG9uIHdoYXRldmVyCgkJCS8vICAgICAgICAgICAgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJhc2UgdGFnIGlzIGF0IHRoZSB0aW1lIHRoaXMgY29kZQoJCQkvLyAgICAgICAgICAgIGlzIGNhbGxlZC4gRm9yIG5vdyB3ZSBhcmUganVzdCBhc3N1bWluZyB0aGF0IGFueSB1cmwgd2l0aCBhCgkJCS8vICAgICAgICAgICAgaGFzaCBpbiBpdCBpcyBhbiBhcHBsaWNhdGlvbiBwYWdlIHJlZmVyZW5jZS4KCQkJaWYgKCBocmVmLnNlYXJjaCggIiMiICkgIT09IC0xICkgewoJCQkJaHJlZiA9IGhyZWYucmVwbGFjZSggL1teI10qIy8sICIiICk7CgkJCQlpZiAoICFocmVmICkgewoJCQkJCS8vbGluayB3YXMgYW4gZW1wdHkgaGFzaCBtZWFudCBwdXJlbHkKCQkJCQkvL2ZvciBpbnRlcmFjdGlvbiwgc28gd2UgaWdub3JlIGl0LgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgoIGhyZWYgKSApIHsKCQkJCQkvL3dlIGhhdmUgYXBhdGggc28gbWFrZSBpdCB0aGUgaHJlZiB3ZSB3YW50IHRvIGxvYWQuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBiYXNlVXJsICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vd2UgaGF2ZSBhIHNpbXBsZSBpZCBzbyB1c2UgdGhlIGRvY3VtZW50VXJsIGFzIGl0cyBiYXNlLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgaHJlZiwgZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCApOwoJCQkJfQoJCQl9CgoJCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXZhciB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICksCgoJCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCQkvL2NoZWNrIGZvciBwcm90b2NvbCBvciByZWwgYW5kIGl0cyBub3QgYW4gZW1iZWRkZWQgcGFnZQoJCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJCWlzRXh0ZXJuYWwgPSB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgfHwgKCBwYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIGhyZWYgKSApOwoKCQkJaWYgKCBpc0V4dGVybmFsICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy91c2UgYWpheAoJCQl2YXIgdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJcmV2ZXJzZSA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiB8fAoJCQkJCQkJLy8gZGVwcmVjYXRlZCAtIHJlbW92ZSBieSAxLjAKCQkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApLAoKCQkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCQlyb2xlID0gJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB8fCB1bmRlZmluZWQ7CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBocmVmLCB7IHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHJldmVyc2U6IHJldmVyc2UsIHJvbGU6IHJvbGUsIGxpbms6ICRsaW5rIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiLnVpLXBhZ2UiLCAicGFnZXNob3cucHJlZmV0Y2giLCBmdW5jdGlvbigpIHsKCQkJdmFyIHVybHMgPSBbXTsKCQkJJCggdGhpcyApLmZpbmQoICJhOmpxbURhdGEocHJlZmV0Y2gpIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGxpbmsgPSAkKCB0aGlzICksCgkJCQkJdXJsID0gJGxpbmsuYXR0ciggImhyZWYiICk7CgoJCQkJaWYgKCB1cmwgJiYgJC5pbkFycmF5KCB1cmwsIHVybHMgKSA9PT0gLTEgKSB7CgkJCQkJdXJscy5wdXNoKCB1cmwgKTsKCgkJCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHVybCwgeyByb2xlOiAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApLHByZWZldGNoOiB0cnVlIH0gKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlID0gZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJLy9maW5kIGZpcnN0IHBhZ2UgdmlhIGhhc2gKCQkJdmFyIHRvID0gcGF0aC5zdHJpcEhhc2godXJsKSwKCQkJCS8vdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQgb3RoZXJ3aXNlIChhbmQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgZGVmYXVsdCkKCQkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS51cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMCA/ICJub25lIiA6IHVuZGVmaW5lZCwKCgkJCQkvLyBkZWZhdWx0IG9wdGlvbnMgZm9yIHRoZSBjaGFuZ1BhZ2UgY2FsbHMgbWFkZSBhZnRlciBleGFtaW5pbmcgdGhlIGN1cnJlbnQgc3RhdGUKCQkJCS8vIG9mIHRoZSBwYWdlIGFuZCB0aGUgaGFzaCwgTk9URSB0aGF0IHRoZSB0cmFuc2l0aW9uIGlzIGRlcml2ZWQgZnJvbSB0aGUgcHJldmlvdXMKCQkJCS8vIGhpc3RvcnkgZW50cnkKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX07CgoJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEsIHsKCQkJCXRyYW5zaXRpb246ICh1cmxIaXN0b3J5LmdldExhc3QoKSB8fCB7fSkudHJhbnNpdGlvbiB8fCB0cmFuc2l0aW9uCgkJCX0pOwoKCQkJLy8gc3BlY2lhbCBjYXNlIGZvciBkaWFsb2dzCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgJiYgdG8uaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYgdXJsSGlzdG9yeS5pbml0aWFsRHN0ICE9PSB0byApIHsKCgkJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiAhJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkgKSB7CgkJCQkJLy9kZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZSBhY2NvcmRpbmdseSBwYXN0CgkJCQkJLy90aGUgY3VycmVudCBkaWFsb2cKCQkJCQlpZiggZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIiApIHsKCQkJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXdpbmRvdy5oaXN0b3J5LmZvcndhcmQoKTsKCQkJCQl9CgoJCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJCS8vIHRvIGEgZGlhbG9nIHVzZSB0aGUgZGlhbG9nIG9iamVjdGVkIHNhdmVkIGluIHRoZSBzdGFjawoJCQkJCXRvID0gZGF0YS5wYWdlVXJsOwoJCQkJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJCS8vIGFzIG1vc3Qgb2YgdGhpcyBpcyBsb3N0IGJ5IHRoZSBkb21DYWNoZSBjbGVhbmluZwoJCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQkJdHJhbnNpdGlvbjogYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCQl9KTsKCQkJCX0KCQkJfQoKCQkJLy9pZiB0byBpcyBkZWZpbmVkLCBsb2FkIGl0CgkJCWlmICggdG8gKSB7CgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UgZWxlbWVudCBmcm9tCgkJCQkvLyBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlL2Fic29sdXRlIFVSTC4gSWYgJ3RvJyBpcwoJCQkJLy8gYW4gaWQsIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBhZ2FpbnN0IHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwKCQkJCS8vIHNpbmNlIHRoZSBoYXNoY2hhbmdlIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwgcGFnZS9kaWFsb2cuCgkJCQl0byA9ICFwYXRoLmlzUGF0aCggdG8gKSA/ICggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHRvLCBkb2N1bWVudEJhc2UgKSApIDogdG87CgoJCQkJLy8gSWYgd2UncmUgYWJvdXQgdG8gZ28gdG8gYW4gaW5pdGlhbCBVUkwgdGhhdCBjb250YWlucyBhIHJlZmVyZW5jZSB0byBhIG5vbi1leGlzdGVudAoJCQkJLy8gaW50ZXJuYWwgcGFnZSwgZ28gdG8gdGhlIGZpcnN0IHBhZ2UgaW5zdGVhZC4gV2Uga25vdyB0aGF0IHRoZSBpbml0aWFsIGhhc2ggcmVmZXJzIHRvIGEKCQkJCS8vIG5vbi1leGlzdGVudCBwYWdlLCBiZWNhdXNlIHRoZSBpbml0aWFsIGhhc2ggZGlkIG5vdCBlbmQgdXAgaW4gdGhlIGluaXRpYWwgdXJsSGlzdG9yeSBlbnRyeQoJCQkJaWYgKCB0byA9PT0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHVybEhpc3RvcnkuaW5pdGlhbERzdCwgZG9jdW1lbnRCYXNlICkgJiYKCQkJCQl1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCAmJiB1cmxIaXN0b3J5LnN0YWNrWzBdLnVybCAhPT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0LnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKSB7CgkJCQkJdG8gPSAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggdG8sIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0JZWxzZSB7CgoJCQkJLy90aGVyZSdzIG5vIGhhc2gsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBkb20KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQoJCX07CgoJCS8vIFRPRE8gcm9sbCB0aGUgbG9naWMgaGVyZSBpbnRvIHRoZSBoYW5kbGVIYXNoQ2hhbmdlIG1ldGhvZAoJCSR3aW5kb3cuYmluZCggIm5hdmlnYXRlIiwgZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciB1cmw7CgoJCQlpZiAoIGUub3JpZ2luYWxFdmVudCAmJiBlLm9yaWdpbmFsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXVybCA9ICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50TmFtZS5pbmRleE9mKCAiaGFzaGNoYW5nZSIgKSA+IC0xID8gZGF0YS5zdGF0ZS5oYXNoIDogZGF0YS5zdGF0ZS51cmw7CgoJCQlpZiggIXVybCApIHsKCQkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCX0KCgkJCWlmKCAhdXJsIHx8IHVybCA9PT0gIiMiIHx8IHVybC5pbmRleE9mKCAiIyIgKyAkLm1vYmlsZS5wYXRoLnVpU3RhdGVLZXkgKSA9PT0gMCApewoJCQkJdXJsID0gbG9jYXRpb24uaHJlZjsKCQkJfQoKCQkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UoIHVybCwgZGF0YS5zdGF0ZSApOwoJCX0pOwoKCQkvL3NldCBwYWdlIG1pbi1oZWlnaHRzIHRvIGJlIGRldmljZSBzcGVjaWZpYwoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlc2hvdyIsICQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQubW9iaWxlLndpbmRvdy5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfTsvL25hdnJlYWR5RGVmZXJyZWQgZG9uZSBjYWxsYmFjawoKCSQoIGZ1bmN0aW9uKCkgeyBkb21yZWFkeURlZmVycmVkLnJlc29sdmUoKTsgfSApOwoKCSQud2hlbiggZG9tcmVhZHlEZWZlcnJlZCwgJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCApLmRvbmUoIGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cygpOyB9ICk7Cn0pKCBqUXVlcnkgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxpcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxpcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHBvcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MucG9wID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbnMgaGFuZGxlciBmb3Igc2xpZGUgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNsaWRlID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNpbXVsdGFuZW91czsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWRvd24gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZG93biA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWZhZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVmYWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRldXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRldXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgdHVybiBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MudHVybiA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5kZWdyYWRlSW5wdXRzID0gewoJY29sb3I6IGZhbHNlLAoJZGF0ZTogZmFsc2UsCglkYXRldGltZTogZmFsc2UsCgkiZGF0ZXRpbWUtbG9jYWwiOiBmYWxzZSwKCWVtYWlsOiBmYWxzZSwKCW1vbnRoOiBmYWxzZSwKCW51bWJlcjogZmFsc2UsCglyYW5nZTogIm51bWJlciIsCglzZWFyY2g6ICJ0ZXh0IiwKCXRlbDogZmFsc2UsCgl0aW1lOiBmYWxzZSwKCXVybDogZmFsc2UsCgl3ZWVrOiBmYWxzZQp9OwoKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgl2YXIgcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJCggZS50YXJnZXQgKSApLCBvcHRpb25zOwoKCWlmICggIXBhZ2UgKSB7CgkJcmV0dXJuOwoJfQoKCW9wdGlvbnMgPSBwYWdlLm9wdGlvbnM7CgoJLy8gZGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5CgkkKCBlLnRhcmdldCApLmZpbmQoICJpbnB1dCIgKS5ub3QoIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJdHlwZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwKCQkJb3B0VHlwZSA9IG9wdGlvbnMuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IjsKCgkJaWYgKCBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJdmFyIGh0bWwgPSAkKCAiPGRpdj4iICkuaHRtbCggJHRoaXMuY2xvbmUoKSApLmh0bWwoKSwKCQkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQkJaGFzVHlwZSA9IGh0bWwuaW5kZXhPZiggIiB0eXBlPSIgKSA+IC0xLAoJCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LywKCQkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJJHRoaXMucmVwbGFjZVdpdGgoIGh0bWwucmVwbGFjZSggZmluZHN0ciwgcmVwc3RyICkgKTsKCQl9Cgl9KTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWNsb3NlQnRuOiAibGVmdCIsCgkJY2xvc2VCdG5UZXh0OiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWNvcm5lcnM6IHRydWUsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nZGlhbG9nJykiCgl9LAoKCS8vIE92ZXJyaWRlIHRoZSB0aGVtZSBzZXQgYnkgdGhlIHBhZ2UgcGx1Z2luIG9uIHBhZ2VzaG93CglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gdHJ1ZTsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkucGFnZSggInNldENvbnRhaW5lckJhY2tncm91bmQiLCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJY29ybmVyQ2xhc3MgPSAhIXRoaXMub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiLAoJCQlkaWFsb2dXcmFwID0gJCggIjxkaXYvPiIsIHsKCQkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArIGNvcm5lckNsYXNzCgkJCQl9KTsKCgkJJGVsLmFkZENsYXNzKCAidWktZGlhbG9nIHVpLW92ZXJsYXktIiArIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCgkJLy8gQ2xhc3MgdGhlIG1hcmt1cCBmb3IgZGlhbG9nIHN0eWxpbmcKCQkvLyBTZXQgYXJpYSByb2xlCgkJJGVsLndyYXBJbm5lciggZGlhbG9nV3JhcCApOwoKCQkvKiBiaW5kIGV2ZW50cwoJCQktIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nIG9wZW5lZCB3aXRoCgkJCQl1bmxlc3MgYSBkYXRhLXRyYW5zaXRpb24gaXMgc3BlY2lmaWVkIG9uIHRoZSBsaW5rL2Zvcm0KCQkJLSBpZiB0aGUgY2xpY2sgd2FzIG9uIHRoZSBjbG9zZSBidXR0b24sIG9yIHRoZSBsaW5rIGhhcyBhIGRhdGEtcmVsPSJiYWNrIiBpdCdsbCBnbyBiYWNrIGluIGhpc3RvcnkgbmF0dXJhbGx5CgkJKi8KCQkkZWwuYmluZCggInZjbGljayBzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggZXZlbnQudHlwZSA9PT0gInZjbGljayIgPyAiYSIgOiAiZm9ybSIgKSwKCQkJCWFjdGl2ZTsKCgkJCWlmICggJHRhcmdldC5sZW5ndGggJiYgISR0YXJnZXQuanFtRGF0YSggInRyYW5zaXRpb24iICkgKSB7CgoJCQkJYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKSB8fCB7fTsKCgkJCQkkdGFyZ2V0LmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0cmFuc2l0aW9uIiwgKCBhY3RpdmUudHJhbnNpdGlvbiB8fCAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiApICkKCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImRpcmVjdGlvbiIsICJyZXZlcnNlIiApOwoJCQl9CgkJfSk7CgoJCXRoaXMuX29uKCAkZWwsIHsKCQkJcGFnZWJlZm9yZXNob3c6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciCgkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jcmVhdGVDb21wbGV0ZTogZmFsc2UKCQl9KTsKCgkJdGhpcy5fc2V0Q2xvc2VCdG4oIHRoaXMub3B0aW9ucy5jbG9zZUJ0biApOwoJfSwKCglfc2V0Q2xvc2VCdG46IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgc2VsZiA9IHRoaXMsIGJ0biwgbG9jYXRpb247CgoJCWlmICggdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gKSB7CgkJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uLnJlbW92ZSgpOwoJCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbiA9IG51bGw7CgkJfQoJCWlmICggdmFsdWUgIT09ICJub25lIiApIHsKCQkJLy8gU2FuaXRpemUgdmFsdWUKCQkJbG9jYXRpb24gPSAoIHZhbHVlID09PSAibGVmdCIgPyAibGVmdCIgOiAicmlnaHQiICk7CgkJCWJ0biA9ICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktYnRuLSIgKyBsb2NhdGlvbiArICInIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb249J2RlbGV0ZScgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcz0nbm90ZXh0Jz4iKyB0aGlzLm9wdGlvbnMuY2xvc2VCdG5UZXh0ICsgIjwvYT4iICk7CgkJCXRoaXMuZWxlbWVudC5jaGlsZHJlbigpLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maXJzdCgpLnByZXBlbmQoIGJ0biApOwoJCQlpZiAoIHRoaXMuX2NyZWF0ZUNvbXBsZXRlICYmICQuZm4uYnV0dG9uTWFya3VwICkgewoJCQkJYnRuLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgkJCXRoaXMuX2NyZWF0ZUNvbXBsZXRlID0gdHJ1ZTsKCgkJCS8vIHRoaXMgbXVzdCBiZSBhbiBhbm9ueW1vdXMgZnVuY3Rpb24gc28gdGhhdCBzZWxlY3QgbWVudSBkaWFsb2dzIGNhbiByZXBsYWNlCgkJCS8vIHRoZSBjbG9zZSBtZXRob2QuIFRoaXMgaXMgYSBjaGFuZ2UgZnJvbSBwcmV2aW91c2x5IGp1c3QgZGVmaW5pbmcgZGF0YS1yZWw9YmFjawoJCQkvLyBvbiB0aGUgYnV0dG9uIGFuZCBsZXR0aW5nIG5hdiBoYW5kbGUgaXQKCQkJLy8KCQkJLy8gVXNlIGNsaWNrIHJhdGhlciB0aGFuIHZjbGljayBpbiBvcmRlciB0byBwcmV2ZW50IHRoZSBwb3NzaWJpbGl0eSBvZiB1bmludGVudGlvbmFsbHkKCQkJLy8gcmVvcGVuaW5nIHRoZSBkaWFsb2cgaWYgdGhlIGRpYWxvZyBvcGVuaW5nIGl0ZW0gd2FzIGRpcmVjdGx5IHVuZGVyIHRoZSBjbG9zZSBidXR0b24uCgkJCWJ0bi5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSk7CgoJCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbiA9IGJ0bjsKCQl9Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCWlmICgga2V5ID09PSAiY2xvc2VCdG4iICkgewoJCQl0aGlzLl9zZXRDbG9zZUJ0biggdmFsdWUgKTsKCQl9CgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCX0sCgoJLy8gQ2xvc2UgbWV0aG9kIGdvZXMgYmFjayBpbiBoaXN0b3J5CgljbG9zZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkeCwgZHN0LCBoaXN0ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeTsKCgkJaWYgKCB0aGlzLl9pc0Nsb3NlYWJsZSApIHsKCQkJdGhpcy5faXNDbG9zZWFibGUgPSBmYWxzZTsKCQkJLy8gSWYgdGhlIGhhc2ggbGlzdGVuaW5nIGlzIGVuYWJsZWQgYW5kIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBwcmVjZWRpbmcgaGlzdG9yeQoJCQkvLyBlbnRyeSBpdCdzIG9rIHRvIGdvIGJhY2suIEluaXRpYWwgcGFnZXMgd2l0aCB0aGUgZGlhbG9nIGhhc2ggc3RhdGUgYXJlIGFuIGV4YW1wbGUKCQkJLy8gd2hlcmUgdGhlIHN0YWNrIGNoZWNrIGlzIG5lY2Vzc2FyeQoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmIGhpc3QuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJaWR4ID0gTWF0aC5tYXgoIDAsIGhpc3QuYWN0aXZlSW5kZXggLSAxICk7CgkJCQlkc3QgPSBoaXN0LnN0YWNrWyBpZHggXS5wYWdlVXJsIHx8IGhpc3Quc3RhY2tbIGlkeCBdLnVybDsKCQkJCWhpc3QucHJldmlvdXNJbmRleCA9IGhpc3QuYWN0aXZlSW5kZXg7CgkJCQloaXN0LmFjdGl2ZUluZGV4ID0gaWR4OwoJCQkJaWYgKCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRzdCApICkgewoJCQkJCWRzdCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBkc3QgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBkc3QsIHsgZGlyZWN0aW9uOiAiYmFjayIsIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCQl9Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5lbmhhbmNlKCB0aGlzICk7Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UZXh0ICA9ICJCYWNrIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5hZGRCYWNrQnRuICAgPSBmYWxzZTsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGhlbWUgPSBudWxsOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmhlYWRlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5mb290ZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuY29udGVudFRoZW1lID0gbnVsbDsKCi8vIE5PVEUgYmluZCB1c2VkIHRvIGZvcmNlIHRoaXMgYmluZGluZyB0byBydW4gYmVmb3JlIHRoZSBidXR0b25NYXJrdXAgYmluZGluZwovLyAgICAgIHdoaWNoIGV4cGVjdHMgLnVpLWZvb3RlciB0b3AgYmUgYXBwbGllZCBpbiBpdHMgZ2lnYW50aWMgc2VsZWN0b3IKLy8gVE9ETyByZW1vdmUgdGhlIGJ1dHRvbk1hcmt1cCBnaWFudCBzZWxlY3RvciBhbmQgbW92ZSBpdCB0byB0aGUgdmFyaW91cyBtb2R1bGVzCi8vICAgICAgb24gd2hpY2ggaXQgZGVwZW5kcwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJdmFyICRwYWdlID0gJCggZS50YXJnZXQgKSwKCQlvID0gJHBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMsCgkJcGFnZVJvbGUgPSAkcGFnZS5qcW1EYXRhKCAicm9sZSIgKSwKCQlwYWdlVGhlbWUgPSBvLnRoZW1lOwoKCSQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSwgOmpxbURhdGEocm9sZT0nZm9vdGVyJyksIDpqcW1EYXRhKHJvbGU9J2NvbnRlbnQnKSIsICRwYWdlICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXJvbGUgPSAkdGhpcy5qcW1EYXRhKCAicm9sZSIgKSwKCQkJdGhlbWUgPSAkdGhpcy5qcW1EYXRhKCAidGhlbWUiICksCgkJCWNvbnRlbnRUaGVtZSA9IHRoZW1lIHx8IG8uY29udGVudFRoZW1lIHx8ICggcGFnZVJvbGUgPT09ICJkaWFsb2ciICYmIHBhZ2VUaGVtZSApLAoJCQkkaGVhZGVyYW5jaG9ycywKCQkJbGVmdGJ0biwKCQkJcmlnaHRidG4sCgkJCWJhY2tCdG47CgoJCSR0aGlzLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCgkJLy9hcHBseSB0aGVtaW5nIGFuZCBtYXJrdXAgbW9kaWZpY2F0aW9ucyB0byBwYWdlLGhlYWRlcixjb250ZW50LGZvb3RlcgoJCWlmICggcm9sZSA9PT0gImhlYWRlciIgfHwgcm9sZSA9PT0gImZvb3RlciIgKSB7CgoJCQl2YXIgdGhpc1RoZW1lID0gdGhlbWUgfHwgKCByb2xlID09PSAiaGVhZGVyIiA/IG8uaGVhZGVyVGhlbWUgOiBvLmZvb3RlclRoZW1lICkgfHwgcGFnZVRoZW1lOwoKCQkJJHRoaXMKCQkJCS8vYWRkIHRoZW1lIGNsYXNzCgkJCQkuYWRkQ2xhc3MoICJ1aS1iYXItIiArIHRoaXNUaGVtZSApCgkJCQkvLyBBZGQgQVJJQSByb2xlCgkJCQkuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApOwoKCQkJaWYgKCByb2xlID09PSAiaGVhZGVyIikgewoJCQkJLy8gUmlnaHQsbGVmdCBidXR0b25zCgkJCQkkaGVhZGVyYW5jaG9ycwk9ICR0aGlzLmNoaWxkcmVuKCAiYSwgYnV0dG9uIiApOwoJCQkJbGVmdGJ0bgk9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICk7CgkJCQlyaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJCWxlZnRidG4gPSBsZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJCQlyaWdodGJ0biA9IHJpZ2h0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoJCQl9CgoJCQkvLyBBdXRvLWFkZCBiYWNrIGJ0biBvbiBwYWdlcyBiZXlvbmQgZmlyc3QgdmlldwoJCQlpZiAoIG8uYWRkQmFja0J0biAmJgoJCQkJcm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCSQoICIudWktcGFnZSIgKS5sZW5ndGggPiAxICYmCgkJCQkkcGFnZS5qcW1EYXRhKCAidXJsIiApICE9PSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggbG9jYXRpb24uaGFzaCApICYmCgkJCQkhbGVmdGJ0biApIHsKCgkJCQliYWNrQnRuID0gJCggIjxhIGhyZWY9J2phdmFzY3JpcHQ6dm9pZCgwKTsnIGNsYXNzPSd1aS1idG4tbGVmdCcgZGF0YS0iKyAkLm1vYmlsZS5ucyArInJlbD0nYmFjaycgZGF0YS0iKyAkLm1vYmlsZS5ucyArImljb249J2Fycm93LWwnPiIrIG8uYmFja0J0blRleHQgKyI8L2E+IiApCgkJCQkJLy8gSWYgdGhlbWUgaXMgcHJvdmlkZWQsIG92ZXJyaWRlIGRlZmF1bHQgaW5oZXJpdGFuY2UKCQkJCQkuYXR0ciggImRhdGEtIisgJC5tb2JpbGUubnMgKyJ0aGVtZSIsIG8uYmFja0J0blRoZW1lIHx8IHRoaXNUaGVtZSApCgkJCQkJLnByZXBlbmRUbyggJHRoaXMgKTsKCQkJfQoKCQkJLy8gUGFnZSB0aXRsZQoJCQkkdGhpcy5jaGlsZHJlbiggImgxLCBoMiwgaDMsIGg0LCBoNSwgaDYiICkKCQkJCS5hZGRDbGFzcyggInVpLXRpdGxlIiApCgkJCQkvLyBSZWdhcmRsZXNzIG9mIGggZWxlbWVudCBudW1iZXIgaW4gc3JjLCBpdCBiZWNvbWVzIGgxIGZvciB0aGUgZW5oYW5jZWQgcGFnZQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogImhlYWRpbmciLAoJCQkJCSJhcmlhLWxldmVsIjogIjEiCgkJCQl9KTsKCgkJfSBlbHNlIGlmICggcm9sZSA9PT0gImNvbnRlbnQiICkgewoJCQlpZiAoIGNvbnRlbnRUaGVtZSApIHsKCQkJCSR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBjb250ZW50VGhlbWUgKSApOwoJCQl9CgoJCQkvLyBBZGQgQVJJQSByb2xlCgkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICk7CgkJfQoJfSk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBUaGlzIGZ1bmN0aW9uIGNhbGxzIGdldEF0dHJpYnV0ZSwgd2hpY2ggc2hvdWxkIGJlIHNhZmUgZm9yIGRhdGEtKiBhdHRyaWJ1dGVzCnZhciBnZXRBdHRyRml4ZWQgPSBmdW5jdGlvbiggZSwga2V5ICkgewoJdmFyIHZhbHVlID0gZS5nZXRBdHRyaWJ1dGUoIGtleSApOwoKCXJldHVybiB2YWx1ZSA9PT0gInRydWUiID8gdHJ1ZSA6CgkJdmFsdWUgPT09ICJmYWxzZSIgPyBmYWxzZSA6CgkJdmFsdWUgPT09IG51bGwgPyB1bmRlZmluZWQgOiB2YWx1ZTsKfTsKCiQuZm4uYnV0dG9uTWFya3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7Cgl2YXIgJHdvcmtpbmdTZXQgPSB0aGlzLAoJCW5zS2V5ID0gImRhdGEtIiArICQubW9iaWxlLm5zLAoJCWtleTsKCgkvLyBFbmZvcmNlIG9wdGlvbnMgdG8gYmUgb2YgdHlwZSBzdHJpbmcKCW9wdGlvbnMgPSAoIG9wdGlvbnMgJiYgKCAkLnR5cGUoIG9wdGlvbnMgKSA9PT0gIm9iamVjdCIgKSApPyBvcHRpb25zIDoge307Cglmb3IgKCB2YXIgaSA9IDA7IGkgPCAkd29ya2luZ1NldC5sZW5ndGg7IGkrKyApIHsKCQl2YXIgZWwgPSAkd29ya2luZ1NldC5lcSggaSApLAoJCQllID0gZWxbIDAgXSwKCQkJbyA9ICQuZXh0ZW5kKCB7fSwgJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMsIHsKCQkJCWljb246ICAgICAgIG9wdGlvbnMuaWNvbiAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29uICAgICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJpY29uIiApLAoJCQkJaWNvbnBvczogICAgb3B0aW9ucy5pY29ucG9zICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25wb3MgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImljb25wb3MiICksCgkJCQl0aGVtZTogICAgICBvcHRpb25zLnRoZW1lICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudGhlbWUgICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGVsLCAiYyIgKSwKCQkJCWlubGluZTogICAgIG9wdGlvbnMuaW5saW5lICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pbmxpbmUgICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJpbmxpbmUiICksCgkJCQlzaGFkb3c6ICAgICBvcHRpb25zLnNoYWRvdyAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc2hhZG93ICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAic2hhZG93IiApLAoJCQkJY29ybmVyczogICAgb3B0aW9ucy5jb3JuZXJzICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvcm5lcnMgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImNvcm5lcnMiICksCgkJCQlpY29uc2hhZG93OiBvcHRpb25zLmljb25zaGFkb3cgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbnNoYWRvdyA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaWNvbnNoYWRvdyIgKSwKCQkJCW1pbmk6ICAgICAgIG9wdGlvbnMubWluaSAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5taW5pICAgICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJtaW5pIiApCgkJCX0sIG9wdGlvbnMgKSwKCgkJCS8vIENsYXNzZXMgRGVmaW5lZAoJCQlpbm5lckNsYXNzID0gInVpLWJ0bi1pbm5lciIsCgkJCXRleHRDbGFzcyA9ICJ1aS1idG4tdGV4dCIsCgkJCWJ1dHRvbkNsYXNzLCBpY29uQ2xhc3MsCgkJCWhvdmVyID0gZmFsc2UsCgkJCXN0YXRlID0gInVwIiwKCQkJLy8gQnV0dG9uIGlubmVyIG1hcmt1cAoJCQlidXR0b25Jbm5lciwKCQkJYnV0dG9uVGV4dCwKCQkJYnV0dG9uSWNvbiwKCQkJYnV0dG9uRWxlbWVudHM7CgoJCWZvciAoIGtleSBpbiBvICkgewoJCQlpZiAoIG9bIGtleSBdID09PSB1bmRlZmluZWQgfHwgb1sga2V5IF0gPT09IG51bGwgKSB7CgkJCQllbC5yZW1vdmVBdHRyKCBuc0tleSArIGtleSApOwoJCQl9IGVsc2UgewoJCQkJZS5zZXRBdHRyaWJ1dGUoIG5zS2V5ICsga2V5LCBvWyBrZXkgXSApOwoJCQl9CgkJfQoKCQlpZiAoIGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAicmVsIiApID09PSAicG9wdXAiICYmIGVsLmF0dHIoICJocmVmIiApICkgewoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtaGFzcG9wdXAiLCB0cnVlICk7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgZWwuYXR0ciggImhyZWYiICkgKTsKCQl9CgoJCS8vIENoZWNrIGlmIHRoaXMgZWxlbWVudCBpcyBhbHJlYWR5IGVuaGFuY2VkCgkJYnV0dG9uRWxlbWVudHMgPSAkLmRhdGEoICggKCBlLnRhZ05hbWUgPT09ICJJTlBVVCIgfHwgZS50YWdOYW1lID09PSAiQlVUVE9OIiApID8gZS5wYXJlbnROb2RlIDogZSApLCAiYnV0dG9uRWxlbWVudHMiICk7CgoJCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJCWUgPSBidXR0b25FbGVtZW50cy5vdXRlcjsKCQkJZWwgPSAkKCBlICk7CgkJCWJ1dHRvbklubmVyID0gYnV0dG9uRWxlbWVudHMuaW5uZXI7CgkJCWJ1dHRvblRleHQgPSBidXR0b25FbGVtZW50cy50ZXh0OwoJCQkvLyBXZSB3aWxsIHJlY3JlYXRlIHRoaXMgaWNvbiBiZWxvdwoJCQkkKCBidXR0b25FbGVtZW50cy5pY29uICkucmVtb3ZlKCk7CgkJCWJ1dHRvbkVsZW1lbnRzLmljb24gPSBudWxsOwoJCQlob3ZlciA9IGJ1dHRvbkVsZW1lbnRzLmhvdmVyOwoJCQlzdGF0ZSA9IGJ1dHRvbkVsZW1lbnRzLnN0YXRlOwoJCX0KCQllbHNlIHsKCQkJYnV0dG9uSW5uZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQkJYnV0dG9uVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCX0KCQlidXR0b25JY29uID0gby5pY29uID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgOiBudWxsOwoKCQlpZiAoIGF0dGFjaEV2ZW50cyAmJiAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWF0dGFjaEV2ZW50cygpOwoJCX0KCgkJLy8gaWYgbm90LCB0cnkgdG8gZmluZCBjbG9zZXN0IHRoZW1lIGNvbnRhaW5lcgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggZWwsICJjIiApOwoJCX0KCgkJYnV0dG9uQ2xhc3MgPSAidWktYnRuICI7CgkJYnV0dG9uQ2xhc3MgKz0gKCBob3ZlciA/ICJ1aS1idG4taG92ZXItIiArIG8udGhlbWUgOiAiIiApOwoJCWJ1dHRvbkNsYXNzICs9ICggc3RhdGUgPyAiIHVpLWJ0bi0iICsgc3RhdGUgKyAiLSIgKyBvLnRoZW1lIDogIiIgKTsKCQlidXR0b25DbGFzcyArPSBvLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCWJ1dHRvbkNsYXNzICs9IG8uY29ybmVycyA/ICIgdWktYnRuLWNvcm5lci1hbGwiIDogIiI7CgoJCWlmICggby5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCS8vIFVzZWQgdG8gY29udHJvbCBzdHlsaW5nIGluIGhlYWRlcnMvZm9vdGVycywgd2hlcmUgYnV0dG9ucyBkZWZhdWx0IHRvIGBtaW5pYCBzdHlsZS4KCQkJYnV0dG9uQ2xhc3MgKz0gby5taW5pID09PSB0cnVlID8gIiB1aS1taW5pIiA6ICIgdWktZnVsbHNpemUiOwoJCX0KCgkJaWYgKCBvLmlubGluZSAhPT0gdW5kZWZpbmVkICkgewoJCQkvLyBVc2VkIHRvIGNvbnRyb2wgc3R5bGluZyBpbiBoZWFkZXJzL2Zvb3RlcnMsIHdoZXJlIGJ1dHRvbnMgZGVmYXVsdCB0byBgaW5saW5lYCBzdHlsZS4KCQkJYnV0dG9uQ2xhc3MgKz0gby5pbmxpbmUgPT09IHRydWUgPyAiIHVpLWJ0bi1pbmxpbmUiIDogIiB1aS1idG4tYmxvY2siOwoJCX0KCgkJaWYgKCBvLmljb24gKSB7CgkJCW8uaWNvbiA9ICJ1aS1pY29uLSIgKyBvLmljb247CgkJCW8uaWNvbnBvcyA9IG8uaWNvbnBvcyB8fCAibGVmdCI7CgoJCQlpY29uQ2xhc3MgPSAidWktaWNvbiAiICsgby5pY29uOwoKCQkJaWYgKCBvLmljb25zaGFkb3cgKSB7CgkJCQlpY29uQ2xhc3MgKz0gIiB1aS1pY29uLXNoYWRvdyI7CgkJCX0KCQl9CgoJCWlmICggby5pY29ucG9zICkgewoJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1pY29uLSIgKyBvLmljb25wb3M7CgoJCQlpZiAoIG8uaWNvbnBvcyA9PT0gIm5vdGV4dCIgJiYgIWVsLmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJCWVsLmF0dHIoICJ0aXRsZSIsIGVsLmdldEVuY29kZWRUZXh0KCkgKTsKCQkJfQoJCX0KCgkJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQkJZWwucmVtb3ZlQ2xhc3MoIGJ1dHRvbkVsZW1lbnRzLmJjbHMgfHwgIiIgKTsKCQl9CgkJZWwucmVtb3ZlQ2xhc3MoICJ1aS1saW5rIiApLmFkZENsYXNzKCBidXR0b25DbGFzcyApOwoKCQlidXR0b25Jbm5lci5jbGFzc05hbWUgPSBpbm5lckNsYXNzOwoJCWJ1dHRvblRleHQuY2xhc3NOYW1lID0gdGV4dENsYXNzOwoJCWlmICggIWJ1dHRvbkVsZW1lbnRzICkgewoJCQlidXR0b25Jbm5lci5hcHBlbmRDaGlsZCggYnV0dG9uVGV4dCApOwoJCX0KCQlpZiAoIGJ1dHRvbkljb24gKSB7CgkJCWJ1dHRvbkljb24uY2xhc3NOYW1lID0gaWNvbkNsYXNzOwoJCQlpZiAoICEoIGJ1dHRvbkVsZW1lbnRzICYmIGJ1dHRvbkVsZW1lbnRzLmljb24gKSApIHsKCQkJCWJ1dHRvbkljb24uaW5uZXJIVE1MID0gIiYjMTYwOyI7CgkJCQlidXR0b25Jbm5lci5hcHBlbmRDaGlsZCggYnV0dG9uSWNvbiApOwoJCQl9CgkJfQoKCQl3aGlsZSAoIGUuZmlyc3RDaGlsZCAmJiAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvblRleHQuYXBwZW5kQ2hpbGQoIGUuZmlyc3RDaGlsZCApOwoJCX0KCgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWUuYXBwZW5kQ2hpbGQoIGJ1dHRvbklubmVyICk7CgkJfQoKCQkvLyBBc3NpZ24gYSBzdHJ1Y3R1cmUgY29udGFpbmluZyB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24gdG8gdGhlIGVsZW1lbnRzIG9mIHRoaXMgYnV0dG9uLiBUaGlzCgkJLy8gd2lsbCBhbGxvdyB1cyB0byByZWNvZ25pemUgdGhpcyBhcyBhbiBhbHJlYWR5LWVuaGFuY2VkIGJ1dHRvbiBpbiBmdXR1cmUgY2FsbHMgdG8gYnV0dG9uTWFya3VwKCkuCgkJYnV0dG9uRWxlbWVudHMgPSB7CgkJCWhvdmVyIDogaG92ZXIsCgkJCXN0YXRlIDogc3RhdGUsCgkJCWJjbHMgIDogYnV0dG9uQ2xhc3MsCgkJCW91dGVyIDogZSwKCQkJaW5uZXIgOiBidXR0b25Jbm5lciwKCQkJdGV4dCAgOiBidXR0b25UZXh0LAoJCQlpY29uICA6IGJ1dHRvbkljb24KCQl9OwoKCQkkLmRhdGEoIGUsICAgICAgICAgICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCSQuZGF0YSggYnV0dG9uSW5uZXIsICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJJC5kYXRhKCBidXR0b25UZXh0LCAgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQlpZiAoIGJ1dHRvbkljb24gKSB7CgkJCSQuZGF0YSggYnV0dG9uSWNvbiwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgokLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cyA9IHsKCWNvcm5lcnM6IHRydWUsCglzaGFkb3c6IHRydWUsCglpY29uc2hhZG93OiB0cnVlLAoJd3JhcHBlckVsczogInNwYW4iCn07CgpmdW5jdGlvbiBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZWxlbWVudCApIHsKICAgIHZhciBjbmFtZTsKCiAgICB3aGlsZSAoIGVsZW1lbnQgKSB7CgkJLy8gTm90ZSB0aGF0IHdlIGNoZWNrIGZvciB0eXBlb2YgY2xhc3NOYW1lIGJlbG93IGJlY2F1c2UgdGhlIGVsZW1lbnQgd2UKCQkvLyBoYW5kZWQgY291bGQgYmUgaW4gYW4gU1ZHIERPTSB3aGVyZSBjbGFzc05hbWUgb24gU1ZHIGVsZW1lbnRzIGlzIGRlZmluZWQgdG8KCQkvLyBiZSBvZiBhIGRpZmZlcmVudCB0eXBlIChTVkdBbmltYXRlZFN0cmluZykuIFdlIG9ubHkgb3BlcmF0ZSBvbiBIVE1MIERPTQoJCS8vIGVsZW1lbnRzLCBzbyB3ZSBsb29rIGZvciBwbGFpbiAic3RyaW5nIi4KICAgICAgICBjbmFtZSA9ICggdHlwZW9mIGVsZW1lbnQuY2xhc3NOYW1lID09PSAnc3RyaW5nJyApICYmICggZWxlbWVudC5jbGFzc05hbWUgKyAnICcgKTsKICAgICAgICBpZiAoIGNuYW1lICYmIGNuYW1lLmluZGV4T2YoICJ1aS1idG4gIiApID4gLTEgJiYgY25hbWUuaW5kZXhPZiggInVpLWRpc2FibGVkICIgKSA8IDAgKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudDsKfQoKZnVuY3Rpb24gdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sIGNsYXNzVG9SZW1vdmUsIGNsYXNzVG9BZGQsIGhvdmVyLCBzdGF0ZSApIHsKCXZhciBidXR0b25FbGVtZW50cyA9ICQuZGF0YSggJGJ0blsgMCBdLCAiYnV0dG9uRWxlbWVudHMiICk7CgkkYnRuLnJlbW92ZUNsYXNzKCBjbGFzc1RvUmVtb3ZlICkuYWRkQ2xhc3MoIGNsYXNzVG9BZGQgKTsKCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJYnV0dG9uRWxlbWVudHMuYmNscyA9ICQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICkgKQoJCQkuYWRkQ2xhc3MoIGJ1dHRvbkVsZW1lbnRzLmJjbHMgKyAiICIgKyBjbGFzc1RvQWRkICkKCQkJLnJlbW92ZUNsYXNzKCBjbGFzc1RvUmVtb3ZlICkKCQkJLmF0dHIoICJjbGFzcyIgKTsKCQlpZiAoIGhvdmVyICE9PSB1bmRlZmluZWQgKSB7CgkJCWJ1dHRvbkVsZW1lbnRzLmhvdmVyID0gaG92ZXI7CgkJfQoJCWJ1dHRvbkVsZW1lbnRzLnN0YXRlID0gc3RhdGU7Cgl9Cn0KCnZhciBhdHRhY2hFdmVudHMgPSBmdW5jdGlvbigpIHsKCXZhciBob3ZlckRlbGF5ID0gJC5tb2JpbGUuYnV0dG9uTWFya3VwLmhvdmVyRGVsYXksIGhvdiwgZm9jOwoKCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoIHsKCQkidm1vdXNlZG93biB2bW91c2VjYW5jZWwgdm1vdXNldXAgdm1vdXNlb3ZlciB2bW91c2VvdXQgZm9jdXMgYmx1ciBzY3JvbGxzdGFydCI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHRoZW1lLAoJCQkJJGJ0biA9ICQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLAoJCQkJaXNUb3VjaEV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCAmJiAvXnRvdWNoLy50ZXN0KCBldmVudC5vcmlnaW5hbEV2ZW50LnR5cGUgKSwKCQkJCWV2dCA9IGV2ZW50LnR5cGU7CgoJCQlpZiAoICRidG4ubGVuZ3RoICkgewoJCQkJdGhlbWUgPSAkYnRuLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIgKTsKCgkJCQlpZiAoIGV2dCA9PT0gInZtb3VzZWRvd24iICkgewoJCQkJCWlmICggaXNUb3VjaEV2ZW50ICkgewoJCQkJCQkvLyBVc2UgYSBzaG9ydCBkZWxheSB0byBkZXRlcm1pbmUgaWYgdGhlIHVzZXIgaXMgc2Nyb2xsaW5nIGJlZm9yZSBoaWdobGlnaHRpbmcKCQkJCQkJaG92ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi11cC0iICsgdGhlbWUsICJ1aS1idG4tZG93bi0iICsgdGhlbWUsIHVuZGVmaW5lZCwgImRvd24iICk7CgkJCQkJCX0sIGhvdmVyRGVsYXkgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi11cC0iICsgdGhlbWUsICJ1aS1idG4tZG93bi0iICsgdGhlbWUsIHVuZGVmaW5lZCwgImRvd24iICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlY2FuY2VsIiB8fCBldnQgPT09ICJ2bW91c2V1cCIgKSB7CgkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tZG93bi0iICsgdGhlbWUsICJ1aS1idG4tdXAtIiArIHRoZW1lLCB1bmRlZmluZWQsICJ1cCIgKTsKCQkJCX0gZWxzZSBpZiAoIGV2dCA9PT0gInZtb3VzZW92ZXIiIHx8IGV2dCA9PT0gImZvY3VzIiApIHsKCQkJCQlpZiAoIGlzVG91Y2hFdmVudCApIHsKCQkJCQkJLy8gVXNlIGEgc2hvcnQgZGVsYXkgdG8gZGV0ZXJtaW5lIGlmIHRoZSB1c2VyIGlzIHNjcm9sbGluZyBiZWZvcmUgaGlnaGxpZ2h0aW5nCgkJCQkJCWZvYyA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tdXAtIiArIHRoZW1lLCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSwgdHJ1ZSwgIiIgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUsIHRydWUsICIiICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3V0IiB8fCBldnQgPT09ICJibHVyIiB8fCBldnQgPT09ICJzY3JvbGxzdGFydCIgKSB7CgkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4taG92ZXItIiArIHRoZW1lICArICIgdWktYnRuLWRvd24tIiArIHRoZW1lLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgZmFsc2UsICJ1cCIgKTsKCQkJCQlpZiAoIGhvdiApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBob3YgKTsKCQkJCQl9CgkJCQkJaWYgKCBmb2MgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggZm9jICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCQkiZm9jdXNpbiBmb2N1cyI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQl9LAoJCSJmb2N1c291dCBibHVyIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0KCX0pOwoKCWF0dGFjaEV2ZW50cyA9IG51bGw7Cn07CgovL2xpbmtzIGluIGJhcnMsIG9yIHRob3NlIHdpdGggIGRhdGEtcm9sZSBiZWNvbWUgYnV0dG9ucwovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJJCggIjpqcW1EYXRhKHJvbGU9J2J1dHRvbicpLCAudWktYmFyID4gYSwgLnVpLWhlYWRlciA+IGEsIC51aS1mb290ZXIgPiBhLCAudWktYmFyID4gOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykgPiBhIiwgZS50YXJnZXQgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLm5vdCggImJ1dHRvbiwgaW5wdXQsIC51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmJ1dHRvbk1hcmt1cCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJZXhwYW5kQ3VlVGV4dDogIiBjbGljayB0byBleHBhbmQgY29udGVudHMiLAoJCWNvbGxhcHNlQ3VlVGV4dDogIiBjbGljayB0byBjb2xsYXBzZSBjb250ZW50cyIsCgkJY29sbGFwc2VkOiB0cnVlLAoJCWhlYWRpbmc6ICJoMSxoMixoMyxoNCxoNSxoNixsZWdlbmQiLAoJCWNvbGxhcHNlZEljb246ICJwbHVzIiwKCQlleHBhbmRlZEljb246ICJtaW51cyIsCgkJaWNvbnBvczogImxlZnQiLAoJCXRoZW1lOiBudWxsLAoJCWNvbnRlbnRUaGVtZTogbnVsbCwKCQlpbnNldDogdHJ1ZSwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlID0gJGVsLmFkZENsYXNzKCAidWktY29sbGFwc2libGUiICksCgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICRlbC5jaGlsZHJlbiggby5oZWFkaW5nICkuZmlyc3QoKSwKCQkJY29sbGFwc2libGVDb250ZW50ID0gY29sbGFwc2libGUud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCc+PC9kaXY+IiApLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWNvbnRlbnQiICksCgkJCWNvbGxhcHNpYmxlU2V0ID0gJGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKSwKCQkJY29sbGFwc2libGVDbGFzc2VzID0gIiI7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIGNvbGxhcHNpYmxlSGVhZGluZy5pcyggImxlZ2VuZCIgKSApIHsKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJCggIjxkaXYgcm9sZT0naGVhZGluZyc+IisgY29sbGFwc2libGVIZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlSGVhZGluZyApOwoJCQljb2xsYXBzaWJsZUhlYWRpbmcubmV4dCgpLnJlbW92ZSgpOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGluIGEgY29sbGFwc2libGUgc2V0CgkJaWYgKCBjb2xsYXBzaWJsZVNldC5sZW5ndGggKSB7CgkJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb2xsYXBzaWJsZVNldCwgImMiICk7CgkJCX0KCQkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJCW8uY29udGVudFRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJCX0KCgkJCS8vIEdldCB0aGUgcHJlZmVyZW5jZSBmb3IgY29sbGFwc2VkIGljb24gaW4gdGhlIHNldCwgYnV0IG92ZXJyaWRlIHdpdGggZGF0YS0gYXR0cmlidXRlIG9uIHRoZSBpbmRpdmlkdWFsIGNvbGxhcHNpYmxlCgkJCW8uY29sbGFwc2VkSWNvbiA9ICRlbC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICkgfHwgY29sbGFwc2libGVTZXQuanFtRGF0YSggImNvbGxhcHNlZC1pY29uIiApIHx8IG8uY29sbGFwc2VkSWNvbjsKCgkJCS8vIEdldCB0aGUgcHJlZmVyZW5jZSBmb3IgZXhwYW5kZWQgaWNvbiBpbiB0aGUgc2V0LCBidXQgb3ZlcnJpZGUgd2l0aCBkYXRhLSBhdHRyaWJ1dGUgb24gdGhlIGluZGl2aWR1YWwgY29sbGFwc2libGUKCQkJby5leHBhbmRlZEljb24gPSAkZWwuanFtRGF0YSggImV4cGFuZGVkLWljb24iICkgfHwgY29sbGFwc2libGVTZXQuanFtRGF0YSggImV4cGFuZGVkLWljb24iICkgfHwgby5leHBhbmRlZEljb247CgoJCQkvLyBHZXRzIHRoZSBwcmVmZXJlbmNlIGljb24gcG9zaXRpb24gaW4gdGhlIHNldCwgYnV0IG92ZXJyaWRlIHdpdGggZGF0YS0gYXR0cmlidXRlIG9uIHRoZSBpbmRpdmlkdWFsIGNvbGxhcHNpYmxlCgkJCW8uaWNvbnBvcyA9ICRlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSB8fCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaWNvbnBvcyIgKSB8fCBvLmljb25wb3M7CgoJCQkvLyBJbmhlcml0IHRoZSBwcmVmZXJlbmNlIGZvciBpbnNldCBmcm9tIGNvbGxhcHNpYmxlLXNldCBvciBzZXQgdGhlIGRlZmF1bHQgdmFsdWUgdG8gZW5zdXJlIGVxdWFsdHkgd2l0aGluIGEgc2V0CgkJCWlmICggY29sbGFwc2libGVTZXQuanFtRGF0YSggImluc2V0IiApICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvLmluc2V0ID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImluc2V0IiApOwoJCQl9IGVsc2UgewoJCQkJby5pbnNldCA9IHRydWU7CgkJCX0KCQkJLy8gU2V0IGNvcm5lcnMgZm9yIGluZGl2aWR1YWwgY29sbGFwc2libGVzIHRvIGZhbHNlIHdoZW4gaW4gYSBjb2xsYXBzaWJsZS1zZXQKCQkJby5jb3JuZXJzID0gZmFsc2U7CgkJCS8vIEdldHMgdGhlIHByZWZlcmVuY2UgZm9yIG1pbmkgaW4gdGhlIHNldAoJCQlpZiAoICFvLm1pbmkgKSB7CgkJCQlvLm1pbmkgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAibWluaSIgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCS8vIGdldCBpbmhlcml0ZWQgdGhlbWUgaWYgbm90IGEgc2V0IGFuZCBubyB0aGVtZSBoYXMgYmVlbiBzZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggJGVsLCAiYyIgKTsKCQkJfQoJCX0KCgkJaWYgKCAhIW8uaW5zZXQgKSB7CgkJCWNvbGxhcHNpYmxlQ2xhc3NlcyArPSAiIHVpLWNvbGxhcHNpYmxlLWluc2V0IjsKCQkJaWYgKCAhIW8uY29ybmVycyApIHsKCQkJCWNvbGxhcHNpYmxlQ2xhc3NlcyArPSAiIHVpLWNvcm5lci1hbGwiIDsKCQkJfQoJCX0KCQlpZiAoIG8uY29udGVudFRoZW1lICkgewoJCQljb2xsYXBzaWJsZUNsYXNzZXMgKz0gIiB1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCI7CgkJCWNvbGxhcHNpYmxlQ29udGVudC5hZGRDbGFzcyggInVpLWJvZHktIiArIG8uY29udGVudFRoZW1lICk7CgkJfQoJCWlmICggY29sbGFwc2libGVDbGFzc2VzICE9PSAiIiApIHsKCQkJY29sbGFwc2libGUuYWRkQ2xhc3MoIGNvbGxhcHNpYmxlQ2xhc3NlcyApOwoJCX0KCQkKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQkJLmluc2VydEJlZm9yZSggY29sbGFwc2libGVDb250ZW50ICkKCQkJLy9tb2RpZnkgbWFya3VwICYgYXR0cmlidXRlcwoJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCS5hcHBlbmQoICI8c3BhbiBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMnPjwvc3Bhbj4iICkKCQkJLndyYXBJbm5lciggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXRvZ2dsZSc+PC9hPiIgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCQlpY29uOiBvLmNvbGxhcHNlZEljb24sCgkJCQkJbWluaTogby5taW5pLAoJCQkJCXRoZW1lOiBvLnRoZW1lCgkJCQl9KTsKCgkJLy9ldmVudHMKCQljb2xsYXBzaWJsZQoJCQkuYmluZCggImV4cGFuZCBjb2xsYXBzZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJaXNDb2xsYXBzZSA9ICggZXZlbnQudHlwZSA9PT0gImNvbGxhcHNlIiApOwoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkKCQkJCQkJLmZpbmQoICIudWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMiICkKCQkJCQkJCS50ZXh0KCBpc0NvbGxhcHNlID8gby5leHBhbmRDdWVUZXh0IDogby5jb2xsYXBzZUN1ZVRleHQgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgby5leHBhbmRlZEljb24sICFpc0NvbGxhcHNlICkKCQkJCQkJCS8vIGxvZ2ljIG9yIGNhdXNlIHNhbWUgaWNvbiBmb3IgZXhwYW5kZWQvY29sbGFwc2VkIHN0YXRlIHdvdWxkIHJlbW92ZSB0aGUgdWktaWNvbi1jbGFzcwoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgby5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgby5leHBhbmRlZEljb24gPT09IG8uY29sbGFwc2VkSWNvbiApICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCQkkdGhpcy50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICk7CgoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAidGFwIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPyAiZXhwYW5kIiA6ICJjb2xsYXBzZSI7CgoJCQkJY29sbGFwc2libGUudHJpZ2dlciggdHlwZSApOwoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyA9IHsKCV9nZXRWaXNpYmxlczogZnVuY3Rpb24oICRlbHMsIGNyZWF0ZSApIHsKCQl2YXIgdmlzaWJsZXM7CgoJCWlmICggY3JlYXRlICkgewoJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdmlzaWJsZXMgPSAkZWxzLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQlpZiAoIHZpc2libGVzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHZpc2libGVzOwoJfSwKCglfYWRkRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMsICR2aXNpYmxlcywgY3JlYXRlICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJCSR2aXNpYmxlcy5lcSggMCApLmFkZENsYXNzKCAidWktZmlyc3QtY2hpbGQiICkuZW5kKCkubGFzdCgpLmFkZENsYXNzKCAidWktbGFzdC1jaGlsZCIgKTsKCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0KfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKSwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoICRlbCwgImMiICk7CgkJfQoJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJby5jb250ZW50VGhlbWUgPSAkZWwuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJfQoJCS8vIEluaGVyaXQgdGhlIGNvcm5lciBzdHlsaW5nIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby5jb3JuZXJzICkgewoJCQlvLmNvcm5lcnMgPSAkZWwuanFtRGF0YSggImNvcm5lcnMiICk7CgkJfQoJCQoJCWlmICggJGVsLmpxbURhdGEoICJpbnNldCIgKSAhPT0gdW5kZWZpbmVkICkgewoJCQlvLmluc2V0ID0gJGVsLmpxbURhdGEoICJpbnNldCIgKTsKCQl9CgkJby5pbnNldCA9IG8uaW5zZXQgIT09IHVuZGVmaW5lZCA/IG8uaW5zZXQgOiB0cnVlOwoJCW8uY29ybmVycyA9IG8uY29ybmVycyAhPT0gdW5kZWZpbmVkID8gby5jb3JuZXJzIDogdHJ1ZTsKCQkKCQlpZiAoICEhby5jb3JuZXJzICYmICEhby5pbnNldCApIHsKCQkJJGVsLmFkZENsYXNzKCAidWktY29ybmVyLWFsbCIgKTsKCQl9CgoJCS8vIEluaXRpYWxpemUgdGhlIGNvbGxhcHNpYmxlIHNldCBpZiBpdCdzIG5vdCBhbHJlYWR5IGluaXRpYWxpemVkCgkJaWYgKCAhJGVsLmpxbURhdGEoICJjb2xsYXBzaWJsZWJvdW5kIiApICkgewoJCQkkZWwKCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIsIHRydWUgKQoJCQkJLmJpbmQoICJleHBhbmQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJdmFyIGNsb3Nlc3RDb2xsYXBzaWJsZSA9ICQoIGV2ZW50LnRhcmdldCApCgkJCQkJCS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApOwoJCQkJCWlmICggY2xvc2VzdENvbGxhcHNpYmxlLnBhcmVudCgpLmlzKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkgKSB7CgkJCQkJCWNsb3Nlc3RDb2xsYXBzaWJsZQoJCQkJCQkJLnNpYmxpbmdzKCAiLnVpLWNvbGxhcHNpYmxlIiApCgkJCQkJCQkudHJpZ2dlciggImNvbGxhcHNlIiApOwoJCQkJCX0KCQkJCX0pOwoJCX0KCX0sCgoJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWNvbGxhcHNpYmxlc0luU2V0ID0gJGVsLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIgKSwKCQkJZXhwYW5kZWQgPSBjb2xsYXBzaWJsZXNJblNldC5maWx0ZXIoICI6anFtRGF0YShjb2xsYXBzZWQ9J2ZhbHNlJykiICk7CgkJdGhpcy5fcmVmcmVzaCggInRydWUiICk7CgoJCS8vIEJlY2F1c2UgdGhlIGNvcm5lcnMgYXJlIGhhbmRsZWQgYnkgdGhlIGNvbGxhcHNpYmxlIGl0c2VsZiBhbmQgdGhlIGRlZmF1bHQgc3RhdGUgaXMgY29sbGFwc2VkCgkJLy8gVGhhdCB3YXMgY2F1c2luZyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQxMTYKCQlleHBhbmRlZC50cmlnZ2VyKCAiZXhwYW5kIiApOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgY29sbGFwc2libGVzSW5TZXQgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApOwoKCQkkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUuZW5oYW5jZSggY29sbGFwc2libGVzSW5TZXQubm90KCAiLnVpLWNvbGxhcHNpYmxlIiApICk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGNvbGxhcHNpYmxlc0luU2V0LCB0aGlzLl9nZXRWaXNpYmxlcyggY29sbGFwc2libGVzSW5TZXQsIGNyZWF0ZSApLCBjcmVhdGUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY29sbGFwc2libGVzZXQucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBmaWx0ZXIgZnVuY3Rpb24gcmVtb3ZlcyB3aGl0ZXNwYWNlIGJldHdlZW4gbGFiZWwgYW5kIGZvcm0gZWxlbWVudCBzbyB3ZSBjYW4gdXNlIGlubGluZS1ibG9jayAobm9kZVR5cGUgMyA9IHRleHQpCiQuZm4uZmllbGRjb250YWluID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcwoJCS5hZGRDbGFzcyggInVpLWZpZWxkLWNvbnRhaW4gdWktYm9keSB1aS1iciIgKQoJCS5jb250ZW50cygpLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCXJldHVybiAoIHRoaXMubm9kZVR5cGUgPT09IDMgJiYgIS9cUy8udGVzdCggdGhpcy5ub2RlVmFsdWUgKSApOwoJCX0pLnJlbW92ZSgpOwp9OwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nZmllbGRjb250YWluJykiLCBlLnRhcmdldCApLmpxbUVuaGFuY2VhYmxlKCkuZmllbGRjb250YWluKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmdyaWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCWdyaWQ6IG51bGwKCQkJfSwgb3B0aW9ucyApLAoJCQkka2lkcyA9ICR0aGlzLmNoaWxkcmVuKCksCgkJCWdyaWRDb2xzID0geyBzb2xvOjEsIGE6MiwgYjozLCBjOjQsIGQ6NSB9LAoJCQlncmlkID0gby5ncmlkLAoJCQlpdGVyYXRvcjsKCgkJCWlmICggIWdyaWQgKSB7CgkJCQlpZiAoICRraWRzLmxlbmd0aCA8PSA1ICkgewoJCQkJCWZvciAoIHZhciBsZXR0ZXIgaW4gZ3JpZENvbHMgKSB7CgkJCQkJCWlmICggZ3JpZENvbHNbIGxldHRlciBdID09PSAka2lkcy5sZW5ndGggKSB7CgkJCQkJCQlncmlkID0gbGV0dGVyOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlncmlkID0gImEiOwoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC1kdW8iICk7CgkJCQl9CgkJCX0KCQkJaXRlcmF0b3IgPSBncmlkQ29sc1tncmlkXTsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLSIgKyBncmlkICk7CgoJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1hIiApOwoKCQlpZiAoIGl0ZXJhdG9yID4gMSApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisyKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWIiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAyICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzMpIiApLmFkZENsYXNzKCAidWktYmxvY2stYyIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDMgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNCkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1kIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gNCApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis1KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWUiICk7CgkJfQoJfSk7Cn07Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUubmF2YmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJaWNvbnBvczogInRvcCIsCgkJZ3JpZDogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSduYXZiYXInKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkbmF2YmFyID0gdGhpcy5lbGVtZW50LAoJCQkkbmF2YnRucyA9ICRuYXZiYXIuZmluZCggImEiICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPwoJCQkJCQkJCQl0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciB1aS1taW5pIiApCgkJCS5hdHRyKCAicm9sZSIsICJuYXZpZ2F0aW9uIiApCgkJCS5maW5kKCAidWwiICkKCQkJLmpxbUVuaGFuY2VhYmxlKCkKCQkJLmdyaWQoeyBncmlkOiB0aGlzLm9wdGlvbnMuZ3JpZCB9KTsKCgkJJG5hdmJ0bnMuYnV0dG9uTWFya3VwKHsKCQkJY29ybmVyczoJZmFsc2UsCgkJCXNoYWRvdzoJCWZhbHNlLAoJCQlpbmxpbmU6ICAgICB0cnVlLAoJCQlpY29ucG9zOglpY29ucG9zCgkJfSk7CgoJCSRuYXZiYXIuZGVsZWdhdGUoICJhIiwgInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gdWktYnRuLWlubmVyIGlzIHJldHVybmVkIGFzIHRhcmdldAoJCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoICJhIiApID8gJCggdGhpcyApIDogJCggdGhpcyApLnBhcmVudCggImEiICk7CgkJCQoJCQlpZiAoICF0YXJnZXQuaXMoICIudWktZGlzYWJsZWQsIC51aS1idG4tYWN0aXZlIiApICkgewoJCQkJJG5hdmJ0bnMucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkkKCB0aGlzICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkKCQkJCS8vIFRoZSBjb2RlIGJlbG93IGlzIGEgd29ya2Fyb3VuZCB0byBmaXggIzExODEKCQkJCXZhciBhY3RpdmVCdG4gPSAkKCB0aGlzICk7CgkJCQkKCQkJCSQoIGRvY3VtZW50ICkub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQlhY3RpdmVCdG4ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCX0pOwoKCQkvLyBCdXR0b25zIGluIHRoZSBuYXZiYXIgd2l0aCB1aS1zdGF0ZS1wZXJzaXN0IGNsYXNzIHNob3VsZCByZWdhaW4gdGhlaXIgYWN0aXZlIHN0YXRlIGJlZm9yZSBwYWdlIHNob3cKCQkkbmF2YmFyLmNsb3Nlc3QoICIudWktcGFnZSIgKS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJJG5hdmJ0bnMuZmlsdGVyKCAiLnVpLXN0YXRlLXBlcnNpc3QiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUubmF2YmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy9LZWVwcyB0cmFjayBvZiB0aGUgbnVtYmVyIG9mIGxpc3RzIHBlciBwYWdlIFVJRAovL1RoaXMgYWxsb3dzIHN1cHBvcnQgZm9yIG11bHRpcGxlIG5lc3RlZCBsaXN0IGluIHRoZSBzYW1lIHBhZ2UKLy9odHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzE2MTcKdmFyIGxpc3RDb3VudFBlclBhZ2UgPSB7fTsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiAiYyIsCgkJaGVhZGVyVGhlbWU6ICJiIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQlpY29uOiAiYXJyb3ctciIsCgkJc3BsaXRJY29uOiAiYXJyb3ctciIsCgkJc3BsaXRUaGVtZTogImIiLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWluc2V0OiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdsaXN0dmlldycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCIgOiAiIjsKCgkJaWYgKCAhIXQub3B0aW9ucy5pbnNldCApIHsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiOwoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCX0KCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyhmdW5jdGlvbiggaSwgb3JpZyApIHsKCQkJcmV0dXJuIG9yaWcgKyAiIHVpLWxpc3R2aWV3IiArIGxpc3R2aWV3Q2xhc3NlczsKCQl9KTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCS8vIFRoaXMgaXMgYSBnZW5lcmljIHV0aWxpdHkgbWV0aG9kIGZvciBmaW5kaW5nIHRoZSBmaXJzdAoJLy8gbm9kZSB3aXRoIGEgZ2l2ZW4gbm9kZU5hbWUuIEl0IHVzZXMgYmFzaWMgRE9NIHRyYXZlcnNhbAoJLy8gdG8gYmUgZmFzdCBhbmQgaXMgbWVhbnQgdG8gYmUgYSBzdWJzdGl0dXRlIGZvciBzaW1wbGUKCS8vICQuZm4uY2xvc2VzdCgpIGFuZCAkLmZuLmNoaWxkcmVuKCkgY2FsbHMgb24gYSBzaW5nbGUKCS8vIGVsZW1lbnQuIE5vdGUgdGhhdCBjYWxsZXJzIG11c3QgcGFzcyBib3RoIHRoZSBsb3dlckNhc2UKCS8vIGFuZCB1cHBlckNhc2UgdmVyc2lvbiBvZiB0aGUgbm9kZU5hbWUgdGhleSBhcmUgbG9va2luZyBmb3IuCgkvLyBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMgaXMgdGhhdCB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUKCS8vIGNhbGxlZCBtYW55IHRpbWVzIGFuZCB3ZSB3YW50IHRvIGF2b2lkIGhhdmluZyB0byBsb3dlcmNhc2UKCS8vIHRoZSBub2RlTmFtZSBmcm9tIHRoZSBlbGVtZW50IGV2ZXJ5IHRpbWUgdG8gZW5zdXJlIHdlIGhhdmUKCS8vIGEgbWF0Y2guIE5vdGUgdGhhdCB0aGlzIGZ1bmN0aW9uIGxpdmVzIGhlcmUgZm9yIG5vdywgYnV0IG1heQoJLy8gYmUgbW92ZWQgaW50byAkLm1vYmlsZSBpZiBvdGhlciBjb21wb25lbnRzIG5lZWQgYSBzaW1pbGFyIG1ldGhvZC4KCV9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBuZXh0UHJvcCwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApIHsKCQl2YXIgaSwgaW1nLCBsZW4gPSBjb250YWluZXJzLmxlbmd0aDsKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlpbWcgPSAkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBjb250YWluZXJzWyBpIF0uZmlyc3RDaGlsZCwgIm5leHRTaWJsaW5nIiwgImltZyIsICJJTUciICkgKTsKCQkJaWYgKCBpbWcubGVuZ3RoICkgewoJCQkJaW1nLmFkZENsYXNzKCAidWktbGktdGh1bWIiICk7CgkJCQkkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBpbWdbIDAgXS5wYXJlbnROb2RlLCAicGFyZW50Tm9kZSIsICJsaSIsICJMSSIgKSApLmFkZENsYXNzKCBpbWcuaXMoICIudWktbGktaWNvbiIgKSA/ICJ1aS1saS1oYXMtaWNvbiIgOiAidWktbGktaGFzLXRodW1iIiApOwoJCQl9CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXRoaXMucGFyZW50UGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJdGhpcy5fY3JlYXRlU3ViUGFnZXMoKTsKCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCSRsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlzZWxmID0gdGhpcywKCQkJZGl2aWRlcnRoZW1lID0gJGxpc3QuanFtRGF0YSggImRpdmlkZXJ0aGVtZSIgKSB8fCBvLmRpdmlkZXJUaGVtZSwKCQkJbGlzdHNwbGl0dGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAic3BsaXR0aGVtZSIgKSwKCQkJbGlzdHNwbGl0aWNvbiA9ICRsaXN0LmpxbURhdGEoICJzcGxpdGljb24iICksCgkJCWxpc3RpY29uID0gJGxpc3QuanFtRGF0YSggImljb24iICksCgkJCWxpID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoICRsaXN0WyAwIF0sICJsaSIsICJMSSIgKSwKCQkJb2wgPSAhISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSwKCQkJanNDb3VudCA9ICEkLnN1cHBvcnQuY3NzUHNldWRvRWxlbWVudCwKCQkJc3RhcnQgPSAkbGlzdC5hdHRyKCAic3RhcnQiICksCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsCgkJCWEsIGxhc3QsIHNwbGl0dGhlbWUsIGNvdW50ZXIsIHN0YXJ0Q291bnQsIG5ld1N0YXJ0Q291bnQsIGNvdW50UGFyZW50LCBpY29uLCBpbWdQYXJlbnRzLCBpbWcsIGxpbmtJY29uOwoKCQlpZiAoIG9sICYmIGpzQ291bnQgKSB7CgkJCSRsaXN0LmZpbmQoICIudWktbGktZGVjIiApLnJlbW92ZSgpOwoJCX0KCgkJaWYgKCBvbCApIHsKCQkJLy8gQ2hlY2sgaWYgYSBzdGFydCBhdHRyaWJ1dGUgaGFzIGJlZW4gc2V0IHdoaWxlIHRha2luZyBhIHZhbHVlIG9mIDAgaW50byBhY2NvdW50CgkJCWlmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSB7CgkJCQlpZiAoICFqc0NvdW50ICkgewoJCQkJCXN0YXJ0Q291bnQgPSBwYXJzZUludCggc3RhcnQgLCAxMCApIC0gMTsKCQkJCQkkbGlzdC5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIHN0YXJ0Q291bnQgKTsKCQkJCX0gZWxzZSB7CgkJCQkJY291bnRlciA9IHBhcnNlSW50KCBzdGFydCAsIDEwICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJY291bnRlciA9IDE7CgkJCX0KCQl9CgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lOwoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQl2YXIgaXNEaXZpZGVyID0gKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApOwoKCQkJCWlmICggYS5sZW5ndGggJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpY29uID0gaXRlbS5qcW1EYXRhKCAiaWNvbiIgKTsKCgkJCQkJaXRlbS5idXR0b25NYXJrdXAoewoJCQkJCQl3cmFwcGVyRWxzOiAiZGl2IiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCWljb25wb3M6ICJyaWdodCIsCgkJCQkJCWljb246IGEubGVuZ3RoID4gMSB8fCBpY29uID09PSBmYWxzZSA/IGZhbHNlIDogaWNvbiB8fCBsaXN0aWNvbiB8fCBvLmljb24sCgkJCQkJCXRoZW1lOiBpdGVtVGhlbWUKCQkJCQl9KTsKCgkJCQkJaWYgKCAoIGljb24gIT09IGZhbHNlICkgJiYgKCBhLmxlbmd0aCA9PT0gMSApICkgewoJCQkJCQlpdGVtLmFkZENsYXNzKCAidWktbGktaGFzLWFycm93IiApOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggInVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gbGlzdHNwbGl0dGhlbWUgfHwgbGFzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lOwoJCQkJCQlsaW5rSWNvbiA9IGxhc3QuanFtRGF0YSggImljb24iICk7CgoJCQkJCQlsYXN0LmFwcGVuZFRvKCBpdGVtICkKCQkJCQkJCS5hdHRyKCAidGl0bGUiLCAkLnRyaW0obGFzdC5nZXRFbmNvZGVkVGV4dCgpKSApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1saS1saW5rLWFsdCIgKQoJCQkJCQkJLmVtcHR5KCkKCQkJCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZSwKCQkJCQkJCQlpY29uOiBmYWxzZSwKCQkJCQkJCQlpY29ucG9zOiAibm90ZXh0IgoJCQkJCQkJfSkKCQkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJCS5hcHBlbmQoCgkJCQkJCQkJCSQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQkJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJCQkJCQl0aGVtZTogc3BsaXR0aGVtZSwKCQkJCQkJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCQkJCQkJLy8gbGluayBpY29uIG92ZXJyaWRlcyBsaXN0IGl0ZW0gaWNvbiBvdmVycmlkZXMgdWwgZWxlbWVudCBvdmVycmlkZXMgb3B0aW9ucwoJCQkJCQkJCQkJaWNvbjogbGlua0ljb24gfHwgaWNvbiB8fCBsaXN0c3BsaXRpY29uIHx8IG8uc3BsaXRJY29uCgkJCQkJCQkJCX0pCgkJCQkJCQkJKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBpc0RpdmlkZXIgKSB7CgoJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWRpdmlkZXIgdWktYmFyLSIgKyAoIGl0ZW0uanFtRGF0YSggInRoZW1lIiApIHx8IGRpdmlkZXJ0aGVtZSApOwoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCgkJCQkJaWYgKCBvbCApIHsKCQkJCQkJLy9yZXNldCBjb3VudGVyIHdoZW4gYSBkaXZpZGVyIGhlYWRpbmcgaXMgZW5jb3VudGVyZWQKCQkJCQkJaWYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApIHsKCQkJCQkJCWlmICggIWpzQ291bnQgKSB7CgkJCQkJCQkJbmV3U3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCAsIDEwICkgLSAxOwoJCQkJCQkJCWl0ZW0uY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBuZXdTdGFydENvdW50ICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWNvdW50ZXIgPSBwYXJzZUludCggc3RhcnQgLCAxMCApOwoJCQkJCQkJfQoJCQkJCQl9IGVsc2UgaWYgKCBqc0NvdW50ICkgewoJCQkJCQkJCWNvdW50ZXIgPSAxOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0gZWxzZSB7CgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktc3RhdGljIHVpLWJ0bi11cC0iICsgaXRlbVRoZW1lOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG9sICYmIGpzQ291bnQgJiYgaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1kaXZpZGVyIiApIDwgMCApIHsKCQkJCWNvdW50UGFyZW50ID0gaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1zdGF0aWMiICkgPiAwID8gaXRlbSA6IGl0ZW0uZmluZCggIi51aS1saW5rLWluaGVyaXQiICk7CgoJCQkJY291bnRQYXJlbnQuYWRkQ2xhc3MoICJ1aS1saS1qc251bWJlcmluZyIgKQoJCQkJCS5wcmVwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWxpLWRlYyc+IiArICggY291bnRlcisrICkgKyAiLiA8L3NwYW4+IiApOwoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtIGFuZCBpdHMKCQkJLy8gYnRuLWlubmVyIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtCgkJLy8gYW5kIHRoZWlyIGJ0bi1pbm5lciBlbGVtZW50cy4gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICkuY2hpbGRyZW4oICIudWktYnRuLWlubmVyIiApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKTsKCQl9CgoJCSRsaXN0LmZpbmQoICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApLmFkZENsYXNzKCAidWktbGktaGVhZGluZyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAicCwgZGwiICkuYWRkQ2xhc3MoICJ1aS1saS1kZXNjIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktYXNpZGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgkJCQkJJHRoaXMucHJlcGVuZFRvKCAkdGhpcy5wYXJlbnQoKSApOyAvL3NoaWZ0IGFzaWRlIHRvIGZyb250IGZvciBjc3MgZmxvYXQKCQkJCX0pCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktY291bnQiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCQkJfSkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArICggJGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUpICsgIiB1aS1idG4tY29ybmVyLWFsbCIgKTsKCgkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBsb29rIGF0IHRoZSBmaXJzdCBpbWFnZSBpbiB0aGUgbGlzdCBpdGVtCgkJLy8gaXRzZWxmLCBhbmQgYW55IC51aS1saW5rLWluaGVyaXQgZWxlbWVudCBpdCBtYXkgY29udGFpbiwgc28gd2UKCQkvLyBjYW4gcGxhY2UgdGhlIGFwcHJvcHJpYXRlIGNsYXNzZXMgb24gdGhlIGltYWdlIGFuZCBsaXN0IGl0ZW0uCgkJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIHNvbWV0aGluZyBsaWtlOgoJCS8vCgkJLy8gICAgbGkuZmluZCgiPmltZzplcSgwKSwgLnVpLWxpbmstaW5oZXJpdD5pbWc6ZXEoMCkiKS5lYWNoKCAuLi4gKTsKCQkvLwoJCS8vIEJ1dCBleGVjdXRpbmcgYSBmaW5kKCkgbGlrZSB0aGF0IG9uIFdpbmRvd3MgUGhvbmUgNy41IHRvb2sgYQoJCS8vIHJlYWxseSBsb25nIHRpbWUuIFdhbGtpbmcgdGhpbmdzIG1hbnVhbGx5IHdpdGggdGhlIGNvZGUgYmVsb3cKCQkvLyBhbGxvd3MgdGhlIDQwMCBsaXN0dmlldyBpdGVtIHBhZ2UgdG8gbG9hZCBpbiBhYm91dCAzIHNlY29uZHMgYXMKCQkvLyBvcHBvc2VkIHRvIDMwIHNlY29uZHMuCgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoICRsaXN0LmZpbmQoICIudWktbGluay1pbmhlcml0IiApICk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCB0aGlzLl9nZXRWaXNpYmxlcyggbGksIGNyZWF0ZSApLCBjcmVhdGUgKTsKCQkvLyBhdXRvZGl2aWRlcnMgYmluZHMgdG8gdGhpcyB0byByZWRyYXcgZGl2aWRlcnMgYWZ0ZXIgdGhlIGxpc3R2aWV3IHJlZnJlc2gKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJyZWZyZXNoIiApOwoJfSwKCgkvL2NyZWF0ZSBhIHN0cmluZyBmb3IgSUQvc3VicGFnZSB1cmwgY3JlYXRpb24KCV9pZFN0cmluZ0VzY2FwZTogZnVuY3Rpb24oIHN0ciApIHsKCQlyZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnLScpOwoJfSwKCglfY3JlYXRlU3ViUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gcGFyZW50TGlzdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXBhcmVudFVybCA9IHBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJcGFyZW50SWQgPSBwYXJlbnRVcmwgfHwgcGFyZW50UGFnZVsgMCBdWyAkLmV4cGFuZG8gXSwKCQkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdC5hdHRyKCAiaWQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRucyA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXMsCgkJCXBlcnNpc3RlbnRGb290ZXJJRCA9IHBhcmVudFBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLmpxbURhdGEoICJpZCIgKSwKCQkJaGFzU3ViUGFnZXM7CgoJCWlmICggdHlwZW9mIGxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPT09ICJ1bmRlZmluZWQiICkgewoJCQlsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID0gLTE7CgkJfQoKCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0SWQgfHwgKytsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdOwoKCQkkKCBwYXJlbnRMaXN0LmZpbmQoICJsaT51bCwgbGk+b2wiICkudG9BcnJheSgpLnJldmVyc2UoKSApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCWxpc3QgPSAkKCB0aGlzICksCgkJCQlsaXN0SWQgPSBsaXN0LmF0dHIoICJpZCIgKSB8fCBwYXJlbnRMaXN0SWQgKyAiLSIgKyBpLAoJCQkJcGFyZW50ID0gbGlzdC5wYXJlbnQoKSwKCQkJCW5vZGVFbHNGdWxsID0gJCggbGlzdC5wcmV2QWxsKCkudG9BcnJheSgpLnJldmVyc2UoKSApLAoJCQkJbm9kZUVscyA9IG5vZGVFbHNGdWxsLmxlbmd0aCA/IG5vZGVFbHNGdWxsIDogJCggIjxzcGFuPiIgKyAkLnRyaW0ocGFyZW50LmNvbnRlbnRzKClbIDAgXS5ub2RlVmFsdWUpICsgIjwvc3Bhbj4iICksCgkJCQl0aXRsZSA9IG5vZGVFbHMuZmlyc3QoKS5nZXRFbmNvZGVkVGV4dCgpLC8vdXJsIGxpbWl0cyB0byBmaXJzdCAzMCBjaGFycyBvZiB0ZXh0CgkJCQlpZCA9ICggcGFyZW50VXJsIHx8ICIiICkgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIj0iICsgbGlzdElkLAoJCQkJdGhlbWUgPSBsaXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lLAoJCQkJY291bnRUaGVtZSA9IGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgcGFyZW50TGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBvLmNvdW50VGhlbWUsCgkJCQluZXdQYWdlLCBhbmNob3I7CgoJCQkvL2RlZmluZSBoYXNTdWJQYWdlcyBmb3IgdXNlIGluIGxhdGVyIHJlbW92YWwKCQkJaGFzU3ViUGFnZXMgPSB0cnVlOwoKCQkJbmV3UGFnZSA9IGxpc3QuZGV0YWNoKCkKCQkJCQkJLndyYXAoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0ncGFnZScgIiArIGRucyArICJ1cmw9JyIgKyBpZCArICInICIgKyBkbnMgKyAidGhlbWU9JyIgKyB0aGVtZSArICInICIgKyBkbnMgKyAiY291bnQtdGhlbWU9JyIgKyBjb3VudFRoZW1lICsgIic+PGRpdiAiICsgZG5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkucGFyZW50KCkKCQkJCQkJCS5iZWZvcmUoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0naGVhZGVyJyAiICsgZG5zICsgInRoZW1lPSciICsgby5oZWFkZXJUaGVtZSArICInPjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgdGl0bGUgKyAiPC9kaXY+PC9kaXY+IiApCgkJCQkJCQkuYWZ0ZXIoIHBlcnNpc3RlbnRGb290ZXJJRCA/ICQoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0nZm9vdGVyJyAiICsgZG5zICsgImlkPSciKyBwZXJzaXN0ZW50Rm9vdGVySUQgKyInPiIgKSA6ICIiICkKCQkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJCS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJbmV3UGFnZS5wYWdlKCk7CgoJCQlhbmNob3IgPSBwYXJlbnQuZmluZCggJ2E6Zmlyc3QnICk7CgoJCQlpZiAoICFhbmNob3IubGVuZ3RoICkgewoJCQkJYW5jaG9yID0gJCggIjxhLz4iICkuaHRtbCggbm9kZUVscyB8fCB0aXRsZSApLnByZXBlbmRUbyggcGFyZW50LmVtcHR5KCkgKTsKCQkJfQoKCQkJYW5jaG9yLmF0dHIoICJocmVmIiwgIiMiICsgaWQgKTsKCgkJfSkubGlzdHZpZXcoKTsKCgkJLy8gb24gcGFnZWhpZGUsIHJlbW92ZSBhbnkgbmVzdGVkIHBhZ2VzIGFsb25nIHdpdGggdGhlIHBhcmVudCBwYWdlLCBhcyBsb25nIGFzIHRoZXkgYXJlbid0IGFjdGl2ZQoJCS8vIGFuZCBhcmVuJ3QgZW1iZWRkZWQKCQlpZiAoIGhhc1N1YlBhZ2VzICYmCgkJCXBhcmVudFBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgJiYKCQkJcGFyZW50UGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkub3B0aW9ucy5kb21DYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQl2YXIgbmV3UmVtb3ZlID0gZnVuY3Rpb24oIGUsIHVpICkgewoJCQkJdmFyIG5leHRQYWdlID0gdWkubmV4dFBhZ2UsIG5wVVJMLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJaWYgKCB1aS5uZXh0UGFnZSApIHsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYgKCBucFVSTC5pbmRleE9mKCBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgIT09IDAgKSB7CgkJCQkJCXNlbGYuY2hpbGRQYWdlcygpLnJlbW92ZSgpOwoJCQkJCQlwYXJlbnRQYWdlLnRyaWdnZXIoIHByRXZlbnQgKTsKCQkJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJCXBhcmVudFBhZ2UucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCgkJCS8vIHVuYmluZCB0aGUgb3JpZ2luYWwgcGFnZSByZW1vdmUgYW5kIHJlcGxhY2Ugd2l0aCBvdXIgc3BlY2lhbGl6ZWQgdmVyc2lvbgoJCQlwYXJlbnRQYWdlCgkJCQkudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApCgkJCQkuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIG5ld1JlbW92ZSk7CgkJfQoJfSwKCgkvLyBUT0RPIHNvcnQgb3V0IGEgYmV0dGVyIHdheSB0byB0cmFjayBzdWIgcGFnZXMgb2YgdGhlIGxpc3R2aWV3IHRoaXMgaXMgYnJpdHRsZQoJY2hpbGRQYWdlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhcmVudFVybCA9IHRoaXMucGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQlyZXR1cm4gJCggIjpqcW1EYXRhKHVybF49JyIrICBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIicpIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQgKSB7Cgl2YXIJbWV0YSA9ICQoICJtZXRhW25hbWU9dmlld3BvcnRdIiApLAoJCWluaXRpYWxDb250ZW50ID0gbWV0YS5hdHRyKCAiY29udGVudCIgKSwKCQlkaXNhYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xLCB1c2VyLXNjYWxhYmxlPW5vIiwKCQllbmFibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEwLCB1c2VyLXNjYWxhYmxlPXllcyIsCgkJZGlzYWJsZWRJbml0aWFsbHkgPSAvKHVzZXItc2NhbGFibGVbXHNdKj1bXHNdKm5vKXwobWF4aW11bS1zY2FsZVtcc10qPVtcc10qMSlbJCxcc10vLnRlc3QoIGluaXRpYWxDb250ZW50ICk7CgoJJC5tb2JpbGUuem9vbSA9ICQuZXh0ZW5kKCB7fSwgewoJCWVuYWJsZWQ6ICFkaXNhYmxlZEluaXRpYWxseSwKCQlsb2NrZWQ6IGZhbHNlLAoJCWRpc2FibGU6IGZ1bmN0aW9uKCBsb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAhJC5tb2JpbGUuem9vbS5sb2NrZWQgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZGlzYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSBmYWxzZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gbG9jayB8fCBmYWxzZTsKCQkJfQoJCX0sCgkJZW5hYmxlOiBmdW5jdGlvbiggdW5sb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAoICEkLm1vYmlsZS56b29tLmxvY2tlZCB8fCB1bmxvY2sgPT09IHRydWUgKSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBlbmFibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gZmFsc2U7CgkJCX0KCQl9LAoJCXJlc3RvcmU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBpbml0aWFsQ29udGVudCApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCX0pOwoKfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQltaW5pOiBmYWxzZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwgaW5wdXRbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCBpbnB1dFt0eXBlPSdudW1iZXInXSwgOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIGlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIGlucHV0W3R5cGU9J2VtYWlsJ10sIGlucHV0W3R5cGU9J3VybCddLCBpbnB1dFt0eXBlPSd0ZWwnXSwgdGV4dGFyZWEsIGlucHV0W3R5cGU9J3RpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZSddLCBpbnB1dFt0eXBlPSdtb250aCddLCBpbnB1dFt0eXBlPSd3ZWVrJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIGlucHV0W3R5cGU9J2NvbG9yJ10sIGlucHV0Om5vdChbdHlwZV0pLCBpbnB1dFt0eXBlPSdmaWxlJ10iLAoJCWNsZWFyQnRuOiBmYWxzZSwKCQljbGVhclNlYXJjaEJ1dHRvblRleHQ6IG51bGwsIC8vZGVwcmVjYXRpbmcgZm9yIDEuMy4uLgoJCWNsZWFyQnRuVGV4dDogImNsZWFyIHRleHQiLAoJCWRpc2FibGVkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdGhlbWUgPSBvLnRoZW1lIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZWNsYXNzICA9ICIgdWktYm9keS0iICsgdGhlbWUsCgkJCW1pbmljbGFzcyA9IG8ubWluaSA/ICIgdWktbWluaSIgOiAiIiwKCQkJaXNTZWFyY2ggPSBpbnB1dC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWZvY3VzZWRFbCwKCQkJY2xlYXJidG4sCgkJCWNsZWFyQnRuVGV4dCA9IG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0IHx8IG8uY2xlYXJCdG5UZXh0LAoJCQljbGVhckJ0bkJsYWNrbGlzdCA9IGlucHV0LmlzKCAidGV4dGFyZWEsIDpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICksCgkJCWlucHV0TmVlZHNDbGVhckJ0biA9ICEhby5jbGVhckJ0biAmJiAhY2xlYXJCdG5CbGFja2xpc3QsCgkJCWlucHV0TmVlZHNXcmFwID0gaW5wdXQuaXMoICJpbnB1dCIgKSAmJiAhaW5wdXQuaXMoICI6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApOwoKCQlmdW5jdGlvbiB0b2dnbGVDbGVhcigpIHsKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQljbGVhcmJ0bi50b2dnbGVDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIsICFpbnB1dC52YWwoKSApOwoJCQl9LCAwICk7CgkJfQoKCQkkKCAibGFiZWxbZm9yPSciICsgaW5wdXQuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktaW5wdXQtdGV4dCIgKTsKCgkJZm9jdXNlZEVsID0gaW5wdXQuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IHVpLWJvZHktIisgdGhlbWUgKTsKCgkJLy8gWFhYOiBUZW1wb3Jhcnkgd29ya2Fyb3VuZCBmb3IgaXNzdWUgNzg1IChBcHBsZSBidWcgODkxMDU4OSkuCgkJLy8gICAgICBUdXJuIG9mZiBhdXRvY29ycmVjdCBhbmQgYXV0b2NvbXBsZXRlIG9uIG5vbi1pT1MgNSBkZXZpY2VzCgkJLy8gICAgICBzaW5jZSB0aGUgcG9wdXAgdGhleSB1c2UgY2FuJ3QgYmUgZGlzbWlzc2VkIGJ5IHRoZSB1c2VyLiBOb3RlCgkJLy8gICAgICB0aGF0IHdlIHRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiB0aGUgZmVhdHVyZSBieSBsb29raW5nIGZvcgoJCS8vICAgICAgdGhlIGF1dG9jb3JyZWN0IHByb3BlcnR5IG9uIHRoZSBpbnB1dCBlbGVtZW50LiBXZSBjdXJyZW50bHkKCQkvLyAgICAgIGhhdmUgbm8gdGVzdCBmb3IgaU9TIDUgb3IgbmV3ZXIgc28gd2UncmUgdGVtcG9yYXJpbHkgdXNpbmcKCQkvLyAgICAgIHRoZSB0b3VjaE92ZXJmbG93IHN1cHBvcnQgZmxhZyBmb3IgalFNIDEuMC4gWWVzLCBJIGZlZWwgZGlydHkuIC0gamJsYXMKCQlpZiAoIHR5cGVvZiBpbnB1dFswXS5hdXRvY29ycmVjdCAhPT0gInVuZGVmaW5lZCIgJiYgISQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICkgewoJCQkvLyBTZXQgdGhlIGF0dHJpYnV0ZSBpbnN0ZWFkIG9mIHRoZSBwcm9wZXJ0eSBqdXN0IGluIGNhc2UgdGhlcmUKCQkJLy8gaXMgY29kZSB0aGF0IGF0dGVtcHRzIHRvIG1ha2UgbW9kaWZpY2F0aW9ucyB2aWEgSFRNTC4KCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvcnJlY3QiLCAib2ZmIiApOwoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCgkJLy8ic2VhcmNoIiBhbmQgInRleHQiIGlucHV0IHdpZGdldHMKCQlpZiAoIGlzU2VhcmNoICkgewoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtc2VhcmNoIHVpLXNoYWRvdy1pbnNldCB1aS1idG4tY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IHVpLWljb24tc2VhcmNoZmllbGQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQl9IGVsc2UgaWYgKCBpbnB1dE5lZWRzV3JhcCApIHsKCQkJZm9jdXNlZEVsID0gaW5wdXQud3JhcCggIjxkaXYgY2xhc3M9J3VpLWlucHV0LXRleHQgdWktc2hhZG93LWluc2V0IHVpLWNvcm5lci1hbGwgdWktYnRuLXNoYWRvdyIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICsgIic+PC9kaXY+IiApLnBhcmVudCgpOwoJCX0KCgkJaWYoIGlucHV0TmVlZHNDbGVhckJ0biB8fCBpc1NlYXJjaCApIHsKCQkJY2xlYXJidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyJyB0aXRsZT0nIiArIGNsZWFyQnRuVGV4dCArICInPiIgKyBjbGVhckJ0blRleHQgKyAiPC9hPiIgKQoJCQkJLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpbnB1dAoJCQkJCQkudmFsKCAiIiApCgkJCQkJCS5mb2N1cygpCgkJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCWNsZWFyYnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KQoJCQkJLmFwcGVuZFRvKCBmb2N1c2VkRWwgKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJaWNvbjogImRlbGV0ZSIsCgkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJbWluaTogby5taW5pCgkJCQl9KTsKCQkJCQoJCQlpZiAoICFpc1NlYXJjaCApIHsKCQkJCWZvY3VzZWRFbC5hZGRDbGFzcyggInVpLWlucHV0LWhhcy1jbGVhciIgKTsKCQkJfQoKCQkJdG9nZ2xlQ2xlYXIoKTsKCgkJCWlucHV0LmJpbmQoICJwYXN0ZSBjdXQga2V5dXAgaW5wdXQgZm9jdXMgY2hhbmdlIGJsdXIiLCB0b2dnbGVDbGVhciApOwoJCX0KCQllbHNlIGlmICggIWlucHV0TmVlZHNXcmFwICYmICFpc1NlYXJjaCApIHsKCQkJaW5wdXQuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLXNoYWRvdy1pbnNldCIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICk7CgkJfQoKCQlpbnB1dC5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBpbnB1dCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJCQlpZiAoIG8ucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJCX0JCQkKCQkJCWZvY3VzZWRFbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmx1cihmdW5jdGlvbigpIHsKCQkJCWZvY3VzZWRFbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJaWYgKCBvLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCX0JCQkJCgkJCX0pOwoKCQkvLyBBdXRvZ3JvdwoJCWlmICggaW5wdXQuaXMoICJ0ZXh0YXJlYSIgKSApIHsKCQkJdmFyIGV4dHJhTGluZUhlaWdodCA9IDE1LAoJCQkJa2V5dXBUaW1lb3V0QnVmZmVyID0gMTAwLAoJCQkJa2V5dXBUaW1lb3V0OwoKCQkJdGhpcy5fa2V5dXAgPSBmdW5jdGlvbigpIHsKCQkJCXZhciBzY3JvbGxIZWlnaHQgPSBpbnB1dFsgMCBdLnNjcm9sbEhlaWdodCwKCQkJCQljbGllbnRIZWlnaHQgPSBpbnB1dFsgMCBdLmNsaWVudEhlaWdodDsKCgkJCQlpZiAoIGNsaWVudEhlaWdodCA8IHNjcm9sbEhlaWdodCApIHsKCQkJCQl2YXIgcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoIGlucHV0LmNzcyggInBhZGRpbmctdG9wIiApICksCgkJCQkJCXBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCBpbnB1dC5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApLAoJCQkJCQlwYWRkaW5nSGVpZ2h0ID0gcGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b207CgkJCQkJCgkJCQkJaW5wdXQuaGVpZ2h0KCBzY3JvbGxIZWlnaHQgLSBwYWRkaW5nSGVpZ2h0ICsgZXh0cmFMaW5lSGVpZ2h0ICk7CgkJCQl9CgkJCX07CgoJCQlpbnB1dC5vbiggImtleXVwIGNoYW5nZSBpbnB1dCBwYXN0ZSIsIGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCBrZXl1cFRpbWVvdXQgKTsKCQkJCWtleXVwVGltZW91dCA9IHNldFRpbWVvdXQoIHNlbGYuX2tleXVwLCBrZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQkJfSk7CgoJCQkvLyBiaW5kaW5nIHRvIHBhZ2VjaGFuZ2UgaGVyZSBlbnN1cmVzIHRoYXQgZm9yIHBhZ2VzIGxvYWRlZCB2aWEKCQkJLy8gYWpheCB0aGUgaGVpZ2h0IGlzIHJlY2FsY3VsYXRlZCB3aXRob3V0IHVzZXIgaW5wdXQKCQkJdGhpcy5fb24oIHRydWUsICQubW9iaWxlLmRvY3VtZW50LCB7ICJwYWdlY2hhbmdlIjogIl9rZXl1cCIgfSk7CgoJCQkvLyBJc3N1ZSA1MDk6IHRoZSBicm93c2VyIGlzIG5vdCBwcm92aWRpbmcgc2Nyb2xsSGVpZ2h0IHByb3Blcmx5IHVudGlsIHRoZSBzdHlsZXMgbG9hZAoJCQlpZiAoICQudHJpbSggaW5wdXQudmFsKCkgKSApIHsKCQkJCS8vIGJpbmQgdG8gdGhlIHdpbmRvdyBsb2FkIHRvIG1ha2Ugc3VyZSB0aGUgaGVpZ2h0IGlzIGNhbGN1bGF0ZWQgYmFzZWQgb24gQk9USAoJCQkJLy8gdGhlIERPTSBhbmQgQ1NTCgkJCQl0aGlzLl9vbiggdHJ1ZSwgJC5tb2JpbGUud2luZG93LCB7ImxvYWQiOiAiX2tleXVwIn0pOwoJCQl9CgkJfQoJCWlmICggaW5wdXQuYXR0ciggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwsCgkJCWlzU2VhcmNoID0gdGhpcy5lbGVtZW50LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJaW5wdXROZWVkc1dyYXAgPSB0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKSAmJiAhdGhpcy5lbGVtZW50LmlzKCAiOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSwKCQkJcGFyZW50TmVlZHNEaXNhYmxlZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICkJJiYgKCBpbnB1dE5lZWRzV3JhcCB8fCBpc1NlYXJjaCApOwoJCQkKCQlpZiAoIHBhcmVudE5lZWRzRGlzYWJsZWQgKSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCQl9IGVsc2UgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgkJfQoJCSRlbC5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsLAoJCQlpc1NlYXJjaCA9IHRoaXMuZWxlbWVudC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWlucHV0TmVlZHNXcmFwID0gdGhpcy5lbGVtZW50LmlzKCAiaW5wdXQiICkgJiYgIXRoaXMuZWxlbWVudC5pcyggIjpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICksCgkJCXBhcmVudE5lZWRzRW5hYmxlZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApCSYmICggaW5wdXROZWVkc1dyYXAgfHwgaXNTZWFyY2ggKTsKCgkJaWYgKCBwYXJlbnROZWVkc0VuYWJsZWQgKSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCQl9IGVsc2UgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgkJfQoJCSRlbC5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyID0gZmFsc2U7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyID0gIkZpbHRlciBpdGVtcy4uLiI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclRoZW1lID0gImMiOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJSZXZlYWwgPSBmYWxzZTsKLy8gVE9ETyByZW5hbWUgY2FsbGJhY2svZGVwcmVjYXRlIGFuZCBkZWZhdWx0IHRvIHRoZSBpdGVtIGl0c2VsZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQKdmFyIGRlZmF1bHRGaWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCB0ZXh0LCBzZWFyY2hWYWx1ZSwgaXRlbSApIHsKCQlyZXR1cm4gdGV4dC50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTE7Cgl9OwoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggInVsLCBvbCIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJdmFyIGxpc3QgPSAkKCB0aGlzICksCgkJbGlzdHZpZXcgPSBsaXN0LmRhdGEoICJtb2JpbGUtbGlzdHZpZXciICk7CgoJaWYgKCAhbGlzdHZpZXcgfHwgIWxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyICkgewoJCXJldHVybjsKCX0KCglpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUmV2ZWFsICkgewoJCWxpc3QuY2hpbGRyZW4oKS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7Cgl9CgoJdmFyIHdyYXBwZXIgPSAkKCAiPGZvcm0+IiwgewoJCQkiY2xhc3MiOiAidWktbGlzdHZpZXctZmlsdGVyIHVpLWJhci0iICsgbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJUaGVtZSwKCQkJInJvbGUiOiAic2VhcmNoIgoJCX0pLnN1Ym1pdCggZnVuY3Rpb24oIGUgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJc2VhcmNoLmJsdXIoKTsKCQl9KSwKCQlvbktleVVwID0gZnVuY3Rpb24oIGUgKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCXZhbCA9IHRoaXMudmFsdWUudG9Mb3dlckNhc2UoKSwKCQkJCWxpc3RJdGVtcyA9IG51bGwsCgkJCQlsaSA9IGxpc3QuY2hpbGRyZW4oKSwKCQkJCWxhc3R2YWwgPSAkdGhpcy5qcW1EYXRhKCAibGFzdHZhbCIgKSArICIiLAoJCQkJY2hpbGRJdGVtcyA9IGZhbHNlLAoJCQkJaXRlbXRleHQgPSAiIiwKCQkJCWl0ZW0sCgkJCQkvLyBDaGVjayBpZiBhIGN1c3RvbSBmaWx0ZXIgY2FsbGJhY2sgYXBwbGllcwoJCQkJaXNDdXN0b21GaWx0ZXJDYWxsYmFjayA9IGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgIT09IGRlZmF1bHRGaWx0ZXJDYWxsYmFjazsKCgkJCWlmICggbGFzdHZhbCAmJiBsYXN0dmFsID09PSB2YWwgKSB7CgkJCQkvLyBFeGVjdXRlIHRoZSBoYW5kbGVyIG9ubHkgb25jZSBwZXIgdmFsdWUgY2hhbmdlCgkJCQlyZXR1cm47CgkJCX0KCgkJCWxpc3R2aWV3Ll90cmlnZ2VyKCAiYmVmb3JlZmlsdGVyIiwgImJlZm9yZWZpbHRlciIsIHsgaW5wdXQ6IHRoaXMgfSApOwoKCQkJLy8gQ2hhbmdlIHZhbCBhcyBsYXN0dmFsIGZvciBuZXh0IGV4ZWN1dGlvbgoJCQkkdGhpcy5qcW1EYXRhKCAibGFzdHZhbCIgLCB2YWwgKTsKCQkJaWYgKCBpc0N1c3RvbUZpbHRlckNhbGxiYWNrIHx8IHZhbC5sZW5ndGggPCBsYXN0dmFsLmxlbmd0aCB8fCB2YWwuaW5kZXhPZiggbGFzdHZhbCApICE9PSAwICkgewoKCQkJCS8vIEN1c3RvbSBmaWx0ZXIgY2FsbGJhY2sgYXBwbGllcyBvciByZW1vdmVkIGNoYXJzIG9yIHBhc3RlZCBzb21ldGhpbmcgdG90YWxseSBkaWZmZXJlbnQsIGNoZWNrIGFsbCBpdGVtcwoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbigpOwoJCQl9IGVsc2UgewoKCQkJCS8vIE9ubHkgY2hhcnMgYWRkZWQsIG5vdCByZW1vdmVkLCBvbmx5IHVzZSB2aXNpYmxlIHN1YnNldAoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbiggIjpub3QoLnVpLXNjcmVlbi1oaWRkZW4pIiApOwoKCQkJCWlmICggIWxpc3RJdGVtcy5sZW5ndGggJiYgbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJSZXZlYWwgKSB7CgkJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbiggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJfQoJCQl9CgoJCQlpZiAoIHZhbCApIHsKCgkJCQkvLyBUaGlzIGhhbmRsZXMgaGlkaW5nIHJlZ3VsYXIgcm93cyB3aXRob3V0IHRoZSB0ZXh0IHdlIHNlYXJjaCBmb3IKCQkJCS8vIGFuZCBhbnkgbGlzdCBkaXZpZGVycyB3aXRob3V0IHJlZ3VsYXIgcm93cyBzaG93biB1bmRlciBpdAoKCQkJCWZvciAoIHZhciBpID0gbGlzdEl0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQkJCWl0ZW0gPSAkKCBsaXN0SXRlbXNbIGkgXSApOwoJCQkJCWl0ZW10ZXh0ID0gaXRlbS5qcW1EYXRhKCAiZmlsdGVydGV4dCIgKSB8fCBpdGVtLnRleHQoKTsKCgkJCQkJaWYgKCBpdGVtLmlzKCAibGk6anFtRGF0YShyb2xlPWxpc3QtZGl2aWRlcikiICkgKSB7CgoJCQkJCQlpdGVtLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIgLCAhY2hpbGRJdGVtcyApOwoKCQkJCQkJLy8gTmV3IGJ1Y2tldCEKCQkJCQkJY2hpbGRJdGVtcyA9IGZhbHNlOwoKCQkJCQl9IGVsc2UgaWYgKCBsaXN0dmlldy5vcHRpb25zLmZpbHRlckNhbGxiYWNrKCBpdGVtdGV4dCwgdmFsLCBpdGVtICkgKSB7CgoJCQkJCQkvL21hcmsgdG8gYmUgaGlkZGVuCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsIHRydWUgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gVGhlcmUncyBhIHNob3duIGl0ZW0gaW4gdGhlIGJ1Y2tldAoJCQkJCQljaGlsZEl0ZW1zID0gdHJ1ZTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU2hvdyBpdGVtcywgbm90IG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICI6bm90KC51aS1maWx0ZXItaGlkZXF1ZXVlKSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBmYWxzZSApOwoKCQkJCS8vIEhpZGUgaXRlbXMsIG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICIudWktZmlsdGVyLWhpZGVxdWV1ZSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCB0cnVlICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiwgZmFsc2UgKTsKCgkJCX0gZWxzZSB7CgoJCQkJLy9maWx0ZXJ2YWx1ZSBpcyBlbXB0eSA9PiBzaG93IGFsbAoJCQkJbGlzdEl0ZW1zLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsICEhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJSZXZlYWwgKTsKCQkJfQoJCQlsaXN0dmlldy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggbGksIGxpc3R2aWV3Ll9nZXRWaXNpYmxlcyggbGksIGZhbHNlICksIGZhbHNlICk7CgkJfSwKCQlzZWFyY2ggPSAkKCAiPGlucHV0PiIsIHsKCQkJcGxhY2Vob2xkZXI6IGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIKCQl9KQoJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIsICJzZWFyY2giICkKCQkuanFtRGF0YSggImxhc3R2YWwiLCAiIiApCgkJLmJpbmQoICJrZXl1cCBjaGFuZ2UgaW5wdXQiLCBvbktleVVwICkKCQkuYXBwZW5kVG8oIHdyYXBwZXIgKQoJCS50ZXh0aW5wdXQoKTsKCglpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuaW5zZXQgKSB7CgkJd3JhcHBlci5hZGRDbGFzcyggInVpLWxpc3R2aWV3LWZpbHRlci1pbnNldCIgKTsKCX0KCgl3cmFwcGVyLmJpbmQoICJzdWJtaXQiLCBmdW5jdGlvbigpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9KQoJLmluc2VydEJlZm9yZSggbGlzdCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuYXV0b2RpdmlkZXJzID0gZmFsc2U7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmF1dG9kaXZpZGVyc1NlbGVjdG9yID0gZnVuY3Rpb24oIGVsdCApIHsKCS8vIGxvb2sgZm9yIHRoZSB0ZXh0IGluIHRoZSBnaXZlbiBlbGVtZW50Cgl2YXIgdGV4dCA9ICQudHJpbSggZWx0LnRleHQoKSApIHx8IG51bGw7CgoJaWYgKCAhdGV4dCApIHsKCQlyZXR1cm4gbnVsbDsKCX0KCgkvLyBjcmVhdGUgdGhlIHRleHQgZm9yIHRoZSBkaXZpZGVyIChmaXJzdCB1cHBlcmNhc2VkIGxldHRlcikKCXRleHQgPSB0ZXh0LnNsaWNlKCAwLCAxICkudG9VcHBlckNhc2UoKTsKCglyZXR1cm4gdGV4dDsKfTsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAidWwsb2wiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQkJbGlzdHZpZXcgPSBsaXN0LmRhdGEoICJtb2JpbGUtbGlzdHZpZXciICk7CgoJaWYgKCAhbGlzdHZpZXcgfHwgIWxpc3R2aWV3Lm9wdGlvbnMuYXV0b2RpdmlkZXJzICkgewoJCXJldHVybjsKCX0KCgl2YXIgcmVwbGFjZURpdmlkZXJzID0gZnVuY3Rpb24gKCkgewoJCWxpc3QuZmluZCggImxpOmpxbURhdGEocm9sZT0nbGlzdC1kaXZpZGVyJykiICkucmVtb3ZlKCk7CgoJCXZhciBsaXMgPSBsaXN0LmZpbmQoICdsaScgKSwKCQkJbGFzdERpdmlkZXJUZXh0ID0gbnVsbCwgbGksIGRpdmlkZXJUZXh0OwoKCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBsaXMubGVuZ3RoIDsgaSsrICkgewoJCQlsaSA9IGxpc1tpXTsKCQkJZGl2aWRlclRleHQgPSBsaXN0dmlldy5vcHRpb25zLmF1dG9kaXZpZGVyc1NlbGVjdG9yKCAkKCBsaSApICk7CgoJCQlpZiAoIGRpdmlkZXJUZXh0ICYmIGxhc3REaXZpZGVyVGV4dCAhPT0gZGl2aWRlclRleHQgKSB7CgkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdsaScgKTsKCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBkaXZpZGVyVGV4dCApICk7CgkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ2RhdGEtJyArICQubW9iaWxlLm5zICsgJ3JvbGUnLCAnbGlzdC1kaXZpZGVyJyApOwoJCQkJbGkucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGRpdmlkZXIsIGxpICk7CgkJCX0KCgkJCWxhc3REaXZpZGVyVGV4dCA9IGRpdmlkZXJUZXh0OwoJCX0KCX07CgoJdmFyIGFmdGVyTGlzdHZpZXdSZWZyZXNoID0gZnVuY3Rpb24gKCkgewoJCWxpc3QudW5iaW5kKCAnbGlzdHZpZXdhZnRlcnJlZnJlc2gnLCBhZnRlckxpc3R2aWV3UmVmcmVzaCApOwoJCXJlcGxhY2VEaXZpZGVycygpOwoJCWxpc3R2aWV3LnJlZnJlc2goKTsKCQlsaXN0LmJpbmQoICdsaXN0dmlld2FmdGVycmVmcmVzaCcsIGFmdGVyTGlzdHZpZXdSZWZyZXNoICk7Cgl9OwoKCWFmdGVyTGlzdHZpZXdSZWZyZXNoKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJCggIjpqcW1EYXRhKHJvbGU9J25vanMnKSIsIGUudGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1ub2pzIiApOwoJCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ID0gewoJX2hhbmRsZUZvcm1SZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9kZWxheSggIl9yZXNldCIgKTsKCQkJfQoJCX0pOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKLyoKKiAiY2hlY2tib3hyYWRpbyIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNoZWNrYm94cmFkaW8iLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8IGlucHV0LmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCIgKS5qcW1EYXRhKCBkYXRhQXR0ciApOwoJCQl9LAoJCQkvLyBOT1RFOiBXaW5kb3dzIFBob25lIGNvdWxkIG5vdCBmaW5kIHRoZSBsYWJlbCB0aHJvdWdoIGEgc2VsZWN0b3IKCQkJLy8gZmlsdGVyIHdvcmtzIHRob3VnaC4KCQkJcGFyZW50TGFiZWwgPSAkKCBpbnB1dCApLmNsb3Nlc3QoICJsYWJlbCIgKSwKCQkJbGFiZWwgPSBwYXJlbnRMYWJlbC5sZW5ndGggPyBwYXJlbnRMYWJlbCA6ICQoIGlucHV0ICkuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0LCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpbmQoICJsYWJlbCIgKS5maWx0ZXIoICJbZm9yPSciICsgaW5wdXRbMF0uaWQgKyAiJ10iICkuZmlyc3QoKSwKCQkJaW5wdXR0eXBlID0gaW5wdXRbMF0udHlwZSwKCQkJbWluaSA9IGluaGVyaXRBdHRyKCBpbnB1dCwgIm1pbmkiICkgfHwgby5taW5pLAoJCQljaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9uIiwKCQkJdW5jaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9mZiIsCgkJCWljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApLAoJCQljaGVja2VkQ2xhc3MgPSAidWktIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkQ2xhc3MgPSAidWktIiArIHVuY2hlY2tlZFN0YXRlOwoKCQlpZiAoIGlucHV0dHlwZSAhPT0gImNoZWNrYm94IiAmJiBpbnB1dHR5cGUgIT09ICJyYWRpbyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEV4cG9zZSBmb3Igb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWxhYmVsOiBsYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MsCgkJCWNoZWNrZWRpY29uOiBjaGVja2VkU3RhdGUsCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZFN0YXRlCgkJfSk7CgoJCS8vIElmIHRoZXJlJ3Mgbm8gc2VsZWN0ZWQgdGhlbWUgY2hlY2sgdGhlIGRhdGEgYXR0cgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWxhYmVsLmJ1dHRvbk1hcmt1cCh7CgkJCXRoZW1lOiBvLnRoZW1lLAoJCQlpY29uOiB1bmNoZWNrZWRTdGF0ZSwKCQkJc2hhZG93OiBmYWxzZSwKCQkJbWluaTogbWluaSwKCQkJaWNvbnBvczogaWNvbnBvcwoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS0nICsgaW5wdXR0eXBlOwoKCQlpbnB1dC5hZGQoIGxhYmVsICkud3JhcEFsbCggd3JhcHBlciApOwoKCQlsYWJlbC5iaW5kKHsKCQkJdm1vdXNlb3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAkKCB0aGlzICkucGFyZW50KCkuaXMoICIudWktZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCX0sCgoJCQl2Y2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgoJCQkJaW5wdXQucHJvcCggImNoZWNrZWQiLCBpbnB1dHR5cGUgPT09ICJyYWRpbyIgJiYgdHJ1ZSB8fCAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKTsKCgkJCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCQkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJCQkvLyBUT0RPOiBpdCB3b3VsZCBiZSBuaWNlIHRvIGxldCB0aGUgYnJvd3NlcidzIGhhbmRsZSB0aGUgY2xpY2tzIGFuZCBwYXNzIHRoZW0KCQkJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQkJCWlucHV0LnRyaWdnZXJIYW5kbGVyKCAnY2xpY2snICk7CgoJCQkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCQkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkJCS8vIG9mIG90aGVyIHJhZGlvcyBlbnN1cmVzIHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlIGlzIGFwcGxpZWQgcHJvcGVybHkKCQkJCXNlbGYuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoKCQlpbnB1dAoJCQkuYmluZCh7CgkJCQl2bW91c2Vkb3duOiBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9jYWNoZVZhbHMoKTsKCQkJCX0sCgoJCQkJdmNsaWNrOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQkJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggJHRoaXMgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCSR0aGlzLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX3VwZGF0ZUFsbCgpOwoJCQkJfSwKCgkJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkJbGFiZWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0sCgoJCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfY2FjaGVWYWxzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy9yZXR1cm5zIGVpdGhlciBhIHNldCBvZiByYWRpb3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGF0dHJpYnV0ZSwgb3IgYSBzaW5nbGUgY2hlY2tib3gKCV9nZXRJbnB1dFNldDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0sIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJLmZpbmQoICJpbnB1dFtuYW1lPSciICsgdGhpcy5lbGVtZW50WzBdLm5hbWUgKyAiJ11bdHlwZT0nIiArIHRoaXMuaW5wdXR0eXBlICsgIiddIiApOwoJfSwKCglfdXBkYXRlQWxsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJaWYgKCB0aGlzLmNoZWNrZWQgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudFsgMCBdLAoJCQlhY3RpdmUgPSAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcywKCQkJY2hlY2tlZENsYXNzID0gdGhpcy5jaGVja2VkQ2xhc3MgKyAoIHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiLnVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIiApLmxlbmd0aCA/IGFjdGl2ZSA6ICIiICksCgkJCWxhYmVsID0gdGhpcy5sYWJlbDsKCgkJaWYgKCBpbnB1dC5jaGVja2VkICkgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyArIGFjdGl2ZSApLmFkZENsYXNzKCBjaGVja2VkQ2xhc3MgKS5idXR0b25NYXJrdXAoIHsgaWNvbjogdGhpcy5jaGVja2VkaWNvbiB9ICk7CgkJfSBlbHNlIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIGNoZWNrZWRDbGFzcyApLmFkZENsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICkuYnV0dG9uTWFya3VwKCB7IGljb246IHRoaXMudW5jaGVja2VkaWNvbiB9ICk7CgkJfQoKCQlpZiAoIGlucHV0LmRpc2FibGVkICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVuYWJsZSgpOwoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIHRydWUgKS5wYXJlbnQoKS5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCBmYWxzZSApLnBhcmVudCgpLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY2hlY2tib3hyYWRpby5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiB0cnVlLAoJCWlubGluZTogbnVsbCwKCQltaW5pOiBudWxsLAoJCWluaXRTZWxlY3RvcjogImJ1dHRvbiwgW3R5cGU9J2J1dHRvbiddLCBbdHlwZT0nc3VibWl0J10sIFt0eXBlPSdyZXNldCddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCSRidXR0b24sCgkJCS8vIGNyZWF0ZSBhIGNvcHkgb2YgdGhpcy5vcHRpb25zIHdlIGNhbiBwYXNzIHRvIGJ1dHRvbk1hcmt1cAoJCQlvID0gKCBmdW5jdGlvbiggdGRvICkgewoJCQkJdmFyIGtleSwgcmV0ID0ge307CgoJCQkJZm9yICgga2V5IGluIHRkbyApIHsKCQkJCQlpZiAoIHRkb1sga2V5IF0gIT09IG51bGwgJiYga2V5ICE9PSAiaW5pdFNlbGVjdG9yIiApIHsKCQkJCQkJcmV0WyBrZXkgXSA9IHRkb1sga2V5IF07CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiByZXQ7CgkJCX0gKSggdGhpcy5vcHRpb25zICksCgkJCWNsYXNzZXMgPSAiIiwKCQkJJGJ1dHRvblBsYWNlaG9sZGVyOwoKCQkvLyBpZiB0aGlzIGlzIGEgbGluaywgY2hlY2sgaWYgaXQncyBiZWVuIGVuaGFuY2VkIGFuZCwgaWYgbm90LCB1c2UgdGhlIHJpZ2h0IGZ1bmN0aW9uCgkJaWYgKCAkZWxbIDAgXS50YWdOYW1lID09PSAiQSIgKSB7CgkJCWlmICggISRlbC5oYXNDbGFzcyggInVpLWJ0biIgKSApIHsKCQkJCSRlbC5idXR0b25NYXJrdXAoKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoKCQkvLyBnZXQgdGhlIGluaGVyaXRlZCB0aGVtZQoJCS8vIFRPRE8gY2VudHJhbGl6ZSBmb3IgYWxsIHdpZGdldHMKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJLy8gVE9ETzogUG9zdCAxLjEtLW9uY2Ugd2UgaGF2ZSB0aW1lIHRvIHRlc3QgdGhvcm91Z2hseS0tYW55IGNsYXNzZXMgbWFudWFsbHkgYXBwbGllZCB0byB0aGUgb3JpZ2luYWwgZWxlbWVudCBzaG91bGQgYmUgY2FycmllZCBvdmVyIHRvIHRoZSBlbmhhbmNlZCBlbGVtZW50LCB3aXRoIGFuIGAtZW5oYW5jZWRgIHN1ZmZpeC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU3NwoJCS8qIGlmICggJGVsWzBdLmNsYXNzTmFtZS5sZW5ndGggKSB7CgkJCWNsYXNzZXMgPSAkZWxbMF0uY2xhc3NOYW1lOwoJCX0gKi8KCQlpZiAoICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICJ1aS1idG4tcmlnaHQiOwoJCX0KCgkJaWYgKCAgJGVsLmF0dHIoICJ0eXBlIiApID09PSAic3VibWl0IiB8fCAkZWwuYXR0ciggInR5cGUiICkgPT09ICJyZXNldCIgKSB7CgkJCWlmICggY2xhc3NlcyApIHsKCQkJCWNsYXNzZXMgKz0gIiB1aS1zdWJtaXQiOwoJCQl9IGVsc2UgewoJCQkJY2xhc3NlcyA9ICJ1aS1zdWJtaXQiOwoJCQl9CgkJfQoJCSQoICJsYWJlbFtmb3I9JyIgKyAkZWwuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktc3VibWl0IiApOwoKCQkvLyBBZGQgQVJJQSByb2xlCgkJdGhpcy5idXR0b24gPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJWyAkZWwuaHRtbCgpID8gImh0bWwiIDogInRleHQiIF0oICRlbC5odG1sKCkgfHwgJGVsLnZhbCgpICkKCQkJLmluc2VydEJlZm9yZSggJGVsICkKCQkJLmJ1dHRvbk1hcmt1cCggbyApCgkJCS5hZGRDbGFzcyggY2xhc3NlcyApCgkJCS5hcHBlbmQoICRlbC5hZGRDbGFzcyggInVpLWJ0bi1oaWRkZW4iICkgKTsKCiAgICAgICAgJGJ1dHRvbiA9IHRoaXMuYnV0dG9uOwoKCQkkZWwuYmluZCh7CgkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCSRidXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSwKCgkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJJGJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9CgkJfSk7CgoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3AgPSB7fTsKCgkJb3BbIGtleSBdID0gdmFsdWU7CgkJaWYgKCBrZXkgIT09ICJpbml0U2VsZWN0b3IiICkgewoJCQl0aGlzLmJ1dHRvbi5idXR0b25NYXJrdXAoIG9wICk7CgkJCS8vIFJlY29yZCB0aGUgb3B0aW9uIGNoYW5nZSBpbiB0aGUgb3B0aW9ucyBhbmQgaW4gdGhlIERPTSBkYXRhLSogYXR0cmlidXRlcwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICgga2V5LnJlcGxhY2UoIC8oW0EtWl0pLywgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICksIHZhbHVlICk7CgkJfQoJCXRoaXMuX3N1cGVyKCAiX3NldE9wdGlvbiIsIGtleSwgdmFsdWUgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKTsKCQl0aGlzLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgZmFsc2UgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50OwoKCQlpZiAoICRlbC5wcm9wKCJkaXNhYmxlZCIpICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVuYWJsZSgpOwoJCX0KCgkJLy8gR3JhYiB0aGUgYnV0dG9uJ3MgdGV4dCBlbGVtZW50IGZyb20gaXRzIGltcGxlbWVudGF0aW9uLWluZGVwZW5kZW50IGRhdGEgaXRlbQoJCSQoIHRoaXMuYnV0dG9uLmRhdGEoICdidXR0b25FbGVtZW50cycgKS50ZXh0IClbICRlbC5odG1sKCkgPyAiaHRtbCIgOiAidGV4dCIgXSggJGVsLmh0bWwoKSB8fCAkZWwudmFsKCkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5idXR0b24ucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zbGlkZXIiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7Cgl3aWRnZXRFdmVudFByZWZpeDogInNsaWRlIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiLAoJCW1pbmk6IGZhbHNlLAoJCWhpZ2hsaWdodDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCS8vIFRPRE86IEVhY2ggb2YgdGhlc2Ugc2hvdWxkIGhhdmUgY29tbWVudHMgZXhwbGFpbiB3aGF0IHRoZXkncmUgZm9yCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb250cm9sLCAiYyIgKSwKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJY1R5cGUgPSBjb250cm9sWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJaXNTZWxlY3QgPSB0aGlzLmlzVG9nZ2xlU3dpdGNoID0gY1R5cGUgPT09ICJzZWxlY3QiLAoJCQlpc1Jhbmdlc2xpZGVyID0gY29udHJvbC5wYXJlbnQoKS5pcyggIjpqcW1EYXRhKHJvbGU9J3Jhbmdlc2xpZGVyJykiICksCgkJCXNlbGVjdENsYXNzID0gKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgPyAidWktc2xpZGVyLXN3aXRjaCIgOiAiIiwKCQkJY29udHJvbElEID0gY29udHJvbC5hdHRyKCAiaWQiICksCgkJCSRsYWJlbCA9ICQoICJbZm9yPSciICsgY29udHJvbElEICsgIiddIiApLAoJCQlsYWJlbElEID0gJGxhYmVsLmF0dHIoICJpZCIgKSB8fCBjb250cm9sSUQgKyAiLWxhYmVsIiwKCQkJbGFiZWwgPSAkbGFiZWwuYXR0ciggImlkIiwgbGFiZWxJRCApLAoJCQltaW4gPSAhdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMCwKCQkJbWF4ID0gICF0aGlzLmlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoLTEsCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgkJCW1pbmlDbGFzcyA9ICggdGhpcy5vcHRpb25zLm1pbmkgfHwgY29udHJvbC5qcW1EYXRhKCAibWluaSIgKSApID8gIiB1aS1taW5pIiA6ICIiLAoJCQlkb21IYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKSwKCQkJaGFuZGxlID0gJCggZG9tSGFuZGxlICksCgkJCWRvbVNsaWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJCXNsaWRlciA9ICQoIGRvbVNsaWRlciApLAoJCQl2YWx1ZWJnID0gdGhpcy5vcHRpb25zLmhpZ2hsaWdodCAmJiAhdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyArICIgdWktYnRuLWNvcm5lci1hbGwiOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfSkoKSA6IGZhbHNlLAoJCQlvcHRpb25zLAoJCQl3cmFwcGVyOwoJCQkKCQlkb21IYW5kbGUuc2V0QXR0cmlidXRlKCAiaHJlZiIsICIjIiApOwoJCWRvbVNsaWRlci5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImFwcGxpY2F0aW9uIiApOwoJCWRvbVNsaWRlci5jbGFzc05hbWUgPSBbdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgIiA6ICJ1aS1zbGlkZXItdHJhY2sgIixzZWxlY3RDbGFzcywiIHVpLWJ0bi1kb3duLSIsdHJhY2tUaGVtZSwiIHVpLWJ0bi1jb3JuZXItYWxsIiwgbWluaUNsYXNzXS5qb2luKCAiIiApOwoJCWRvbUhhbmRsZS5jbGFzc05hbWUgPSAidWktc2xpZGVyLWhhbmRsZSI7CgkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKCBkb21IYW5kbGUgKTsKCgkJaGFuZGxlLmJ1dHRvbk1hcmt1cCh7IGNvcm5lcnM6IHRydWUsIHRoZW1lOiB0aGVtZSwgc2hhZG93OiB0cnVlIH0pCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJCQkiYXJpYS12YWx1ZW1pbiI6IG1pbiwKCQkJCQkiYXJpYS12YWx1ZW1heCI6IG1heCwKCQkJCQkiYXJpYS12YWx1ZW5vdyI6IHRoaXMuX3ZhbHVlKCksCgkJCQkJImFyaWEtdmFsdWV0ZXh0IjogdGhpcy5fdmFsdWUoKSwKCQkJCQkidGl0bGUiOiB0aGlzLl92YWx1ZSgpLAoJCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJCQl9KTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2xpZGVyOiBzbGlkZXIsCgkJCWhhbmRsZTogaGFuZGxlLAoJCQl0eXBlOiBjVHlwZSwKCQkJc3RlcDogc3RlcCwKCQkJbWF4OiBtYXgsCgkJCW1pbjogbWluLAoJCQl2YWx1ZWJnOiB2YWx1ZWJnLAoJCQlpc1Jhbmdlc2xpZGVyOiBpc1Jhbmdlc2xpZGVyLAoJCQlkcmFnZ2luZzogZmFsc2UsCgkJCWJlZm9yZVN0YXJ0OiBudWxsLAoJCQl1c2VyTW9kaWZpZWQ6IGZhbHNlLAoJCQltb3VzZU1vdmVkOiBmYWxzZQoJCX0pOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItaW5uZXJvZmZzZXQiOwoKCQkJZm9yICggdmFyIGogPSAwLCBsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7IGogPCBsZW5ndGg7IGorKyApIHsKCQkJCXdyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdICk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggd3JhcHBlciApOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yICggdmFyIGkgPSAwLCBvcHRpb25zQ291bnQgPSBvcHRpb25zLmxlbmd0aDsgaSA8IG9wdGlvbnNDb3VudDsgaSsrICkgewoJCQkJdmFyIHNpZGUgPSAhaSA/ICJiIiA6ICJhIiwKCQkJCQlzbGlkZXJUaGVtZSA9ICFpID8gIiB1aS1idG4tZG93bi0iICsgdHJhY2tUaGVtZSA6ICggIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKSwKCQkJCQlzbGlkZXJMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJCQkJc2xpZGVySW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICk7CgoJCQkJc2xpZGVySW1nLmNsYXNzTmFtZSA9IFsidWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0iLCBzaWRlLCBzbGlkZXJUaGVtZSwgIiB1aS1idG4tY29ybmVyLWFsbCJdLmpvaW4oICIiICk7CgkJCQlzbGlkZXJJbWcuc2V0QXR0cmlidXRlKCAicm9sZSIsICJpbWciICk7CgkJCQlzbGlkZXJJbWcuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRpb25zW2ldLmlubmVySFRNTCApICk7CgkJCQkkKCBzbGlkZXJJbWcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9CgoJCQlzZWxmLl9sYWJlbHMgPSAkKCAiLnVpLXNsaWRlci1sYWJlbCIsIHNsaWRlciApOwoKCQl9CgoJCWxhYmVsLmFkZENsYXNzKCAidWktc2xpZGVyIiApOwoJCQoJCS8vIG1vbml0b3IgdGhlIGlucHV0IGZvciB1cGRhdGVkIHZhbHVlcwoJCWNvbnRyb2wuYWRkQ2xhc3MoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyLXN3aXRjaCIgOiAidWktc2xpZGVyLWlucHV0IiApOwoKCQl0aGlzLl9vbiggY29udHJvbCwgewoJCQkiY2hhbmdlIjogIl9jb250cm9sQ2hhbmdlIiwKCQkJImtleXVwIjogIl9jb250cm9sS2V5dXAiLAoJCQkiYmx1ciI6ICJfY29udHJvbEJsdXIiLAoJCQkidm1vdXNldXAiOiAiX2NvbnRyb2xWTW91c2VVcCIKCQl9KTsKCgkJc2xpZGVyLmJpbmQoICJ2bW91c2Vkb3duIiwgJC5wcm94eSggdGhpcy5fc2xpZGVyVk1vdXNlRG93biwgdGhpcyApICkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQkvLyBXZSBoYXZlIHRvIGluc3RhbnRpYXRlIGEgbmV3IGZ1bmN0aW9uIG9iamVjdCBmb3IgdGhlIHVuYmluZCB0byB3b3JrIHByb3Blcmx5CgkJLy8gc2luY2UgdGhlIG1ldGhvZCBpdHNlbGYgaXMgZGVmaW5lZCBpbiB0aGUgcHJvdG90eXBlIChjYXVzaW5nIGl0IHRvIHVuYmluZCBldmVyeXRoaW5nKQoJCXRoaXMuX29uKCBkb2N1bWVudCwgeyAidm1vdXNlbW92ZSI6ICJfcHJldmVudERvY3VtZW50RHJhZyIgfSk7CgkJdGhpcy5fb24oIHNsaWRlci5hZGQoIGRvY3VtZW50ICksIHsgInZtb3VzZXVwIjogIl9zbGlkZXJWTW91c2VVcCIgfSk7CgoJCXNsaWRlci5pbnNlcnRBZnRlciggY29udHJvbCApOwoKCQkvLyB3cmFwIGluIGEgZGl2IGZvciBzdHlsaW5nIHB1cnBvc2VzCgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiAhaXNSYW5nZXNsaWRlciApIHsKCQkJd3JhcHBlciA9IHRoaXMub3B0aW9ucy5taW5pID8gIjxkaXYgY2xhc3M9J3VpLXNsaWRlciB1aS1taW5pJz4iIDogIjxkaXYgY2xhc3M9J3VpLXNsaWRlcic+IjsKCQkJCgkJCWNvbnRyb2wuYWRkKCBzbGlkZXIgKS53cmFwQWxsKCB3cmFwcGVyICk7CgkJfQoKCQkvLyBPbmx5IGFkZCBmb2N1cyBjbGFzcyB0byB0b2dnbGUgc3dpdGNoLCBzbGlkZXJzIGdldCBpdCBhdXRvbWF0aWNhbGx5IGZyb20gdWktYnRuCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmhhbmRsZS5iaW5kKHsKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0sCgoJCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkJc2xpZGVyLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJLy8gYmluZCB0aGUgaGFuZGxlIGV2ZW50IGNhbGxiYWNrcyBhbmQgc2V0IHRoZSBjb250ZXh0IHRvIHRoZSB3aWRnZXQgaW5zdGFuY2UKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGUsIHsKCQkJInZtb3VzZWRvd24iOiAiX2hhbmRsZVZNb3VzZURvd24iLAoJCQkia2V5ZG93biI6ICJfaGFuZGxlS2V5ZG93biIsCgkJCSJrZXl1cCI6ICJfaGFuZGxlS2V5dXAiCgkJfSk7CgoJCXRoaXMuaGFuZGxlLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSApOwoJfSwKCglfY29udHJvbENoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIGlmIHRoZSB1c2VyIGRyYWdnZWQgdGhlIGhhbmRsZSwgdGhlICJjaGFuZ2UiIGV2ZW50IHdhcyB0cmlnZ2VyZWQgZnJvbSBpbnNpZGUgcmVmcmVzaCgpOyBkb24ndCBjYWxsIHJlZnJlc2goKSBhZ2FpbgoJCWlmICggdGhpcy5fdHJpZ2dlciggImNvbnRyb2xjaGFuZ2UiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoICF0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJCX0KCX0sCgoJX2NvbnRyb2xLZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgeyAvLyBuZWNlc3Nhcnk/CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlLCB0cnVlICk7Cgl9LAoKCV9jb250cm9sQmx1cjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJfSwKCgkvLyBpdCBhcHBlYXJzIHRoZSBjbGlja2luZyB0aGUgdXAgYW5kIGRvd24gYnV0dG9ucyBpbiBjaHJvbWUgb24KCS8vIHJhbmdlL251bWJlciBpbnB1dHMgZG9lc24ndCB0cmlnZ2VyIGEgY2hhbmdlIHVudGlsIHRoZSBmaWVsZCBpcwoJLy8gYmx1cnJlZC4gSGVyZSB3ZSBjaGVjayB0aGlmIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZCBhbmQgcmVmcmVzaAoJX2NvbnRyb2xWTW91c2VVcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMuX2NoZWNrZWRSZWZyZXNoKCk7Cgl9LAoKCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCglfaGFuZGxlVk1vdXNlRG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMuaGFuZGxlLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGluZGV4ID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSW4gYWxsIGNhc2VzIHByZXZlbnQgdGhlIGRlZmF1bHQgYW5kIG1hcmsgdGhlIGhhbmRsZSBhcyBhY3RpdmUKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCWlmICggIXRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCQkJdGhpcy5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgoJCQkJYnJlYWs7CgkJfQoKCQkvLyBtb3ZlIHRoZSBzbGlkZXIgYWNjb3JkaW5nIHRvIHRoZSBrZXlwcmVzcwoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1pbiApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWF4ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCArIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggLSB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCX0KCX0sIC8vIHJlbW92ZSBhY3RpdmUgbWFyawoKCV9oYW5kbGVLZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJdGhpcy5fa2V5U2xpZGluZyA9IGZhbHNlOwoJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQl9Cgl9LAoKCV9zbGlkZXJWTW91c2VEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgISggZXZlbnQud2hpY2ggPT09IDEgfHwgZXZlbnQud2hpY2ggPT09IDAgKSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVzdGFydCIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXRoaXMuZHJhZ2dpbmcgPSB0cnVlOwoJCXRoaXMudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgoJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJdGhpcy5iZWZvcmVTdGFydCA9IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCX0KCgkJCgkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoJCXRoaXMuX3RyaWdnZXIoICJzdGFydCIgKTsKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9zbGlkZXJWTW91c2VVcDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmRyYWdnaW5nICkgewoJCQl0aGlzLmRyYWdnaW5nID0gZmFsc2U7CgoJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCQlpZiAoIHRoaXMubW91c2VNb3ZlZCApIHsKCQkJCQkvLyB0aGlzIGlzIGEgZHJhZywgY2hhbmdlIHRoZSB2YWx1ZSBvbmx5IGlmIHVzZXIgZHJhZ2dlZCBlbm91Z2gKCQkJCQlpZiAoIHRoaXMudXNlck1vZGlmaWVkICkgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgPT09IDAgPyAxIDogMCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCApOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcyBpcyBqdXN0IGEgY2xpY2ssIGNoYW5nZSB0aGUgdmFsdWUKCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgPT09IDAgPyAxIDogMCApOwoJCQkJfQoJCQl9CgoJCQl0aGlzLm1vdXNlTW92ZWQgPSBmYWxzZTsKCQkJdGhpcy5fdHJpZ2dlciggInN0b3AiICk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9wcmV2ZW50RG9jdW1lbnREcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIE5PVEU6IHdlIGRvbid0IGRvIHRoaXMgaW4gcmVmcmVzaCBiZWNhdXNlIHdlIHN0aWxsIHdhbnQgdG8KCQkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiZHJhZyIsIGV2ZW50ICkgPT09IGZhbHNlKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCB0aGlzLmRyYWdnaW5nICYmICF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkKCQkJCS8vIHRoaXMubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJdGhpcy5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCQkJCQoJCQkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoKCQkJCS8vIG9ubHkgYWZ0ZXIgcmVmcmVzaCgpIHlvdSBjYW4gY2FsY3VsYXRlIHRoaXMudXNlck1vZGlmaWVkCgkJCQl0aGlzLnVzZXJNb2RpZmllZCA9IHRoaXMuYmVmb3JlU3RhcnQgIT09IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCglfY2hlY2tlZFJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy52YWx1ZSAhPT0gdGhpcy5fdmFsdWUoKSApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpICk7CgkJfQoJfSwKCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4IDogcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOwoJfSwKCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgZmFsc2UsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IHJldHVybiBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0byBzdXBwb3J0IHByb2dyYW1tYXRpYwoJCS8vICAgICAgIGFsdGVyYXRpb24gb2YgdGhlIGlucHV0IHZhbHVlLCB3aGljaCBzaG91bGQgc3RpbGwgdXBkYXRlIHRoZSBzbGlkZXIKCQkKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXBhcmVudFRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCWxlZnQsIHdpZHRoLCBkYXRhLCB0b2w7CgoJCXNlbGYuc2xpZGVyWzBdLmNsYXNzTmFtZSA9IFsgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgdWktc2xpZGVyLXN3aXRjaCIgOiAidWktc2xpZGVyLXRyYWNrIiwiIHVpLWJ0bi1kb3duLSIgKyB0cmFja1RoZW1lLCcgdWktYnRuLWNvcm5lci1hbGwnLCAoIHRoaXMub3B0aW9ucy5taW5pICkgPyAiIHVpLW1pbmkiOiIiXS5qb2luKCAiIiApOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gc2V0IHRoZSBzdG9yZWQgdmFsdWUgZm9yIGNvbXBhcmlzb24gbGF0ZXIKCQl0aGlzLnZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgdGhpcy5zbGlkZXIuZmluZCggIi51aS1zbGlkZXItYmciICkubGVuZ3RoID09PSAwICkgewoJCQl0aGlzLnZhbHVlYmcgPSAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIjsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2VsZi5zbGlkZXIgKTsKCQkJfSkoKTsKCQl9CgkJdGhpcy5oYW5kbGUuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSk7CgoJCXZhciBweFN0ZXAsIHBlcmNlbnQsCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgkJCWlzSW5wdXQgPSAhdGhpcy5pc1RvZ2dsZVN3aXRjaCwKCQkJb3B0aW9uRWxlbWVudHMgPSBpc0lucHV0ID8gW10gOiBjb250cm9sLmZpbmQoICJvcHRpb24iICksCgkJCW1pbiA9ICBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBvcHRpb25FbGVtZW50cy5sZW5ndGggLSAxLAoJCQlzdGVwID0gKCBpc0lucHV0ICYmIHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA+IDAgKSA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA6IDE7CgkJCQoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCWRhdGEgPSB2YWw7CgkJCS8vIGEgc2xpZ2h0IHRvbGVyYW5jZSBoZWxwZWQgZ2V0IHRvIHRoZSBlbmRzIG9mIHRoZSBzbGlkZXIKCQkJdG9sID0gODsKCgkJCWxlZnQgPSB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0OwoJCQl3aWR0aCA9IHRoaXMuc2xpZGVyLndpZHRoKCk7CgkJCXB4U3RlcCA9IHdpZHRoLygobWF4LW1pbikvc3RlcCk7CgkJCWlmICggIXRoaXMuZHJhZ2dpbmcgfHwKCQkJCQlkYXRhLnBhZ2VYIDwgbGVmdCAtIHRvbCB8fAoJCQkJCWRhdGEucGFnZVggPiBsZWZ0ICsgd2lkdGggKyB0b2wgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBweFN0ZXAgPiAxICkgewoJCQkJcGVyY2VudCA9ICggKCBkYXRhLnBhZ2VYIC0gbGVmdCApIC8gd2lkdGggKSAqIDEwMDsKCQkJfSBlbHNlIHsKCQkJCXBlcmNlbnQgPSBNYXRoLnJvdW5kKCAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDAgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSB8fCAwICkgOiBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJcGVyY2VudCA9ICggcGFyc2VGbG9hdCggdmFsICkgLSBtaW4gKSAvICggbWF4IC0gbWluICkgKiAxMDA7CgkJfQoKCQlpZiAoIGlzTmFOKCBwZXJjZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBuZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YXIgdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCXZhciBhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoKCQl2YXIgcGVyY2VudFBlclN0ZXAgPSAxMDAvKChtYXgtbWluKS9zdGVwKTsKCQkvLyBTaW5jZSBKYXZhU2NyaXB0IGhhcyBwcm9ibGVtcyB3aXRoIGxhcmdlIGZsb2F0cywgcm91bmQKCQkvLyB0aGUgZmluYWwgdmFsdWUgdG8gNSBkaWdpdHMgYWZ0ZXIgdGhlIGRlY2ltYWwgcG9pbnQgKHNlZSBqUXVlcnlVSTogIzQxMjQpCgkJbmV3dmFsID0gcGFyc2VGbG9hdCggYWxpZ25WYWx1ZS50b0ZpeGVkKDUpICk7CgoJCWlmICggdHlwZW9mIHB4U3RlcCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCXB4U3RlcCA9IHdpZHRoIC8gKCAobWF4LW1pbikgLyBzdGVwICk7CgkJfQoJCWlmICggcHhTdGVwID4gMSAmJiBpc0lucHV0ICkgewoJCQlwZXJjZW50ID0gKCBuZXd2YWwgLSBtaW4gKSAqIHBlcmNlbnRQZXJTdGVwICogKCAxIC8gc3RlcCApOwoJCX0KCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCWlmICggbmV3dmFsIDwgbWluICkgewoJCQluZXd2YWwgPSBtaW47CgkJfQoKCQlpZiAoIG5ld3ZhbCA+IG1heCApIHsKCQkJbmV3dmFsID0gbWF4OwoJCX0KCgkJdGhpcy5oYW5kbGUuY3NzKCAibGVmdCIsIHBlcmNlbnQgKyAiJSIgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZW5vdyIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWV0ZXh0IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggInRpdGxlIiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCWlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgkJfQoKCQkvLyBkcmFnIHRoZSBsYWJlbCB3aWR0aHMKCQlpZiAoIHRoaXMuX2xhYmVscyApIHsKCQkJdmFyIGhhbmRsZVBlcmNlbnQgPSB0aGlzLmhhbmRsZS53aWR0aCgpIC8gdGhpcy5zbGlkZXIud2lkdGgoKSAqIDEwMCwKCQkJCWFQZXJjZW50ID0gcGVyY2VudCAmJiBoYW5kbGVQZXJjZW50ICsgKCAxMDAgLSBoYW5kbGVQZXJjZW50ICkgKiBwZXJjZW50IC8gMTAwLAoJCQkJYlBlcmNlbnQgPSBwZXJjZW50ID09PSAxMDAgPyAwIDogTWF0aC5taW4oIGhhbmRsZVBlcmNlbnQgKyAxMDAgLSBhUGVyY2VudCwgMTAwICk7CgoJCQl0aGlzLl9sYWJlbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBhYiA9ICQoIHRoaXMgKS5pcyggIi51aS1zbGlkZXItbGFiZWwtYSIgKTsKCQkJCSQoIHRoaXMgKS53aWR0aCggKCBhYiA/IGFQZXJjZW50IDogYlBlcmNlbnQgICkgKyAiJSIgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICFwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJCXZhciB2YWx1ZUNoYW5nZWQgPSBmYWxzZTsKCgkJCS8vIHVwZGF0ZSBjb250cm9sInMgdmFsdWUKCQkJaWYgKCBpc0lucHV0ICkgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbC52YWwoKSAhPT0gbmV3dmFsOwoJCQkJY29udHJvbC52YWwoIG5ld3ZhbCApOwoJCQl9IGVsc2UgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ID0gbmV3dmFsOwoJCQl9CgkJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWNoYW5nZSIsIHZhbCApID09PSBmYWxzZSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoICFpc2Zyb21Db250cm9sICYmIHZhbHVlQ2hhbmdlZCApIHsKCQkJCWNvbnRyb2wudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKTsKCQl0aGlzLnNsaWRlci5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgZmFsc2UgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApOwoJCXRoaXMuc2xpZGVyLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5zbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS5yYW5nZXNsaWRlciIsICQubW9iaWxlLndpZGdldCwgewoKCQlvcHRpb25zOiB7CgkJCXRoZW1lOiBudWxsLAoJCQl0cmFja1RoZW1lOiBudWxsLAoJCQlkaXNhYmxlZDogZmFsc2UsCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3Jhbmdlc2xpZGVyJykiLAoJCQltaW5pOiBmYWxzZSwKCQkJaGlnaGxpZ2h0OiB0cnVlCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWNvbmRMYWJlbCwKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQllbENsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgOiAidWktcmFuZ2VzbGlkZXIiLAoJCQlfaW5wdXRGaXJzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKSwKCQkJX2lucHV0TGFzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkubGFzdCgpLAoJCQlsYWJlbCA9ICRlbC5maW5kKCAibGFiZWwiICkuZmlyc3QoKSwKCQkJX3NsaWRlckZpcnN0ID0gJC5kYXRhKCBfaW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuc2xpZGVyLAoJCQlfc2xpZGVyTGFzdCA9ICQuZGF0YSggX2lucHV0TGFzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuc2xpZGVyLAoJCQlmaXJzdEhhbmRsZSA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZSwKCQkJX3NsaWRlcnMgPSAkKCAiPGRpdiBjbGFzcz1cInVpLXJhbmdlc2xpZGVyLXNsaWRlcnNcIiAvPiIgKS5hcHBlbmRUbyggJGVsICk7CgkJCQoJCQlpZiAoICRlbC5maW5kKCAibGFiZWwiICkubGVuZ3RoID4gMSApIHsKCQkJCXNlY29uZExhYmVsID0gJGVsLmZpbmQoICJsYWJlbCIgKS5sYXN0KCkuaGlkZSgpOwoJCQl9CgoJCQlfaW5wdXRGaXJzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IiApOwoJCQlfaW5wdXRMYXN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItbGFzdCIgKTsKCQkJJGVsLmFkZENsYXNzKCBlbENsYXNzICk7CgkJCQoJCQlfc2xpZGVyRmlyc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCV9zbGlkZXJMYXN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlsYWJlbC5wcmVwZW5kVG8oICRlbCApOwoJCQlmaXJzdEhhbmRsZS5wcmVwZW5kVG8oIF9zbGlkZXJMYXN0ICk7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lucHV0Rmlyc3Q6IF9pbnB1dEZpcnN0LAoJCQkJX2lucHV0TGFzdDogX2lucHV0TGFzdCwKCQkJCV9zbGlkZXJGaXJzdDogX3NsaWRlckZpcnN0LAoJCQkJX3NsaWRlckxhc3Q6IF9zbGlkZXJMYXN0LAoJCQkJX3RhcmdldFZhbDogbnVsbCwKCQkJCV9zbGlkZXJUYXJnZXQ6IGZhbHNlLAoJCQkJX3NsaWRlcnM6IF9zbGlkZXJzLAoJCQkJX3Byb3h5OiBmYWxzZQoJCQl9KTsKCQkJCgkJCXRoaXMucmVmcmVzaCgpOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dC51aS1zbGlkZXItaW5wdXQiICksIHsKCQkJCSJzbGlkZWJlZm9yZXN0YXJ0IjogIl9zbGlkZWJlZm9yZXN0YXJ0IiwKCQkJCSJzbGlkZXN0b3AiOiAiX3NsaWRlc3RvcCIsCgkJCQkic2xpZGVkcmFnIjogIl9zbGlkZWRyYWciLAoJCQkJInNsaWRlYmVmb3JlY2hhbmdlIjogIl9jaGFuZ2UiLAoJCQkJImJsdXIiOiAiX2NoYW5nZSIsCgkJCQkia2V5dXAiOiAiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKHsKCQkJCSJtb3VzZWRvd24iOiJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQkJInJlc2V0IjoiX2hhbmRsZVJlc2V0IgoJCQl9KTsKCQkJdGhpcy5fb24oIGZpcnN0SGFuZGxlLCB7CgkJCQkidm1vdXNlZG93biI6ICJfZHJhZ0ZpcnN0SGFuZGxlIgoJCQl9KTsKCQl9LAoJCV9oYW5kbGVSZXNldDogZnVuY3Rpb24oKXsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkvL3dlIG11c3Qgd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBiZWZvcmUgdXBkYXRlaW5nIG90aGVyIHdpc2Ugc2xpZGVycyB3aWxsIG5vdCBoYXZlIHVwZGF0ZWQgeWV0CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCl7CgkJCQlzZWxmLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJfSwwKTsKCQl9LAoKCQlfZHJhZ0ZpcnN0SGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vaWYgdGhlIGZpcnN0IGhhbmRsZSBpcyBkcmFnZ2VkIHNlbmQgdGhlIGV2ZW50IHRvIHRoZSBmaXJzdCBzbGlkZXIKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCV9zbGlkZWRyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKSwKCQkJCW90aGVyU2xpZGVyID0gKCBmaXJzdCApID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSBkcmFnIHdhcyBpbml0aWF0ZWQgb24gYW4gZXh0cmVtZSBhbmQgdGhlIG90aGVyIGhhbmRsZSBpcyBmb2N1c2VkIHNlbmQgdGhlIGV2ZW50cyB0bwoJCQkvL3RoZSBjbG9zZXN0IGhhbmRsZQoJCQlpZiAoICggdGhpcy5fcHJveHkgPT09ICJmaXJzdCIgJiYgZmlyc3QgKSB8fCAoIHRoaXMuX3Byb3h5ID09PSAibGFzdCIgJiYgIWZpcnN0ICkgKSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3NsaWRlc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApOwoJCQkKCQkJdGhpcy5fcHJveHkgPSBmYWxzZTsKCQkJLy90aGlzIHN0b3BzIGRyYWdnaW5nIG9mIHRoZSBoYW5kbGUgYW5kIGJyaW5ncyB0aGUgYWN0aXZlIHRyYWNrIHRvIHRoZSBmcm9udCAKCQkJLy90aGlzIG1ha2VzIGNsaWNrcyBvbiB0aGUgdHJhY2sgZ28gdGhlIHRoZSBsYXN0IGhhbmRsZSB1c2VkCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkudHJpZ2dlciggInZtb3VzZXVwIiApOwoJCQl0aGlzLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAxIDogIiIgKTsKCQl9LAoKCQlfc2xpZGViZWZvcmVzdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgdHJhY2sgaXMgdGhlIHRhcmdldCByZW1lbWJlciB0aGlzIGFuZCB0aGUgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCAkKCBldmVudC5vcmlnaW5hbEV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktc2xpZGVyLXRyYWNrIiApICkgewoJCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gdHJ1ZTsKCQkJCXRoaXMuX3RhcmdldFZhbCA9ICQoIGV2ZW50LnRhcmdldCApLnZhbCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3N1cGVyQXBwbHkoIG9wdGlvbnMgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkJJGVsLmZpbmQoICJpbnB1dCIgKS5zbGlkZXIoewoJCQkJdGhlbWU6IG8udGhlbWUsCgkJCQl0cmFja1RoZW1lOiBvLnRyYWNrVGhlbWUsCgkJCQlkaXNhYmxlZDogby5kaXNhYmxlZCwKCQkJCW1pbmk6IG8ubWluaSwKCQkJCWhpZ2hsaWdodDogby5oaWdobGlnaHQKCQkJfSkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJfSwKCgkJX2NoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoIGV2ZW50LnR5cGUgPT09ICJrZXl1cCIgKSB7CgkJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbWluID0gcGFyc2VGbG9hdCggdGhpcy5faW5wdXRGaXJzdC52YWwoKSwgMTAgKSwKCQkJCW1heCA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0TGFzdC52YWwoKSwgMTAgKSwKCQkJCWZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKSwKCQkJCXRoaXNTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0Rmlyc3QgOiB0aGlzLl9pbnB1dExhc3QsCgkJCQlvdGhlclNsaWRlciA9IGZpcnN0ID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCQkJCgkJCQoJCQlpZiggKCB0aGlzLl9pbnB1dEZpcnN0LnZhbCgpID4gdGhpcy5faW5wdXRMYXN0LnZhbCgpICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICYmICEkKGV2ZW50LnRhcmdldCkuaGFzQ2xhc3MoInVpLXNsaWRlci1oYW5kbGUiKSkgKXsKCQkJCXRoaXNTbGlkZXIuYmx1cigpOwoJCQl9IGVsc2UgaWYoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICl7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBtaW4gPiBtYXggJiYgIXRoaXMuX3NsaWRlclRhcmdldCApIHsKCQkJCS8vdGhpcyBwcmV2ZW50cyBtaW4gZnJvbSBiZWluZyBncmVhdGVyIHRoZW4gbWF4CgkJCQl0aGlzU2xpZGVyLnZhbCggZmlyc3QgPyBtYXg6IG1pbiApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQl0aGlzLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQl9IGVsc2UgaWYgKCBtaW4gPiBtYXggKSB7CgkJCQkvL3RoaXMgbWFrZXMgaXQgc28gY2xpY2tzIG9uIHRoZSB0YXJnZXQgb24gZWl0aGVyIGV4dHJlbWUgZ28gdG8gdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCQl0aGlzU2xpZGVyLnZhbCggdGhpcy5fdGFyZ2V0VmFsICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCgkJCQkvL1lvdSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgc28gZmlyc3Qgc2xpZGVyIGlzIHVwZGF0ZWQgYmVmb3JlIHVwZGF0aW5nIHNlY29uZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJb3RoZXJTbGlkZXIudmFsKCBmaXJzdCA/IG1pbjogbWF4ICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuZm9jdXMoKTsKCQkJCQlzZWxmLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAiIiA6IDEgKTsKCQkJCQlzZWxmLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQkJfSwgMCApOwoJCQkJdGhpcy5fcHJveHkgPSAoIGZpcnN0ICkgPyAiZmlyc3QiIDogImxhc3QiOwoJCQl9CgkJCS8vZml4ZXMgaXNzdWUgd2hlcmUgd2hlbiBib3RoIF9zbGlkZXJzIGFyZSBhdCBtaW4gdGhleSBjYW5ub3QgYmUgYWRqdXN0ZWQKCQkJaWYgKCBtaW4gPT09IG1heCApIHsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAxICk7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDAgKTsKCQkJfSBlbHNlIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQl9CgkJCQoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJCgkJCWlmICggbWluID49IG1heCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV91cGRhdGVIaWdobGlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWluID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJbWF4ID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLmxlZnQsIDEwICksCgkJCQl3aWR0aCA9IChtYXggLSBtaW4pOwoKCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktc2xpZGVyLWJnIiApLmNzcyh7CgkJCQkibWFyZ2luLWxlZnQiOiBtaW4gKyAiJSIsCgkJCQkid2lkdGgiOiB3aWR0aCArICIlIgoJCQl9KTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiICkuZmluZCggImxhYmVsIiApLnNob3coKTsKCQkJdGhpcy5faW5wdXRGaXJzdC5hZnRlciggdGhpcy5fc2xpZGVyRmlyc3QgKTsKCQkJdGhpcy5faW5wdXRMYXN0LmFmdGVyKCB0aGlzLl9zbGlkZXJMYXN0ICk7CgkJCXRoaXMuX3NsaWRlcnMucmVtb3ZlKCk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCB1aS1yYW5nZXNsaWRlci1sYXN0IiApLnNsaWRlciggImRlc3Ryb3kiICk7CgkJfQoKCX0pOwoKJC53aWRnZXQoICJtb2JpbGUucmFuZ2VzbGlkZXIiLCAkLm1vYmlsZS5yYW5nZXNsaWRlciwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5yYW5nZXNsaWRlci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWljb246ICJhcnJvdy1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSApIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCglfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7Cgl9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgoJCXRoaXMuc2VsZWN0ID0gdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLndyYXAoICI8ZGl2IGNsYXNzPSd1aS1zZWxlY3QiICsgY2xhc3NlcyArICInPiIgKTsKCQl0aGlzLnNlbGVjdElEICA9IHRoaXMuc2VsZWN0LmF0dHIoICJpZCIgKTsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJRCArIiddIiApLmFkZENsYXNzKCAidWktc2VsZWN0IiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7CgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5zZWxlY3QsICJjIiApOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB3cmFwcGVyID0gdGhpcy5lbGVtZW50LnBhcmVudHMoICIudWktc2VsZWN0IiApOwoJCWlmICggd3JhcHBlci5sZW5ndGggPiAwICkgewoJCQlpZiAoIHdyYXBwZXIuaXMoICIudWktYnRuLWxlZnQsIC51aS1idG4tcmlnaHQiICkgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHdyYXBwZXIuaXMoICIudWktYnRuLWxlZnQiICkgPyAidWktYnRuLWxlZnQiIDogInVpLWJ0bi1yaWdodCIgKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QWZ0ZXIoIHdyYXBwZXIgKTsKCQkJd3JhcHBlci5yZW1vdmUoKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQkvLyBBbGxvd3MgZm9yIGV4dGVuc2lvbiBvZiB0aGUgbmF0aXZlIHNlbGVjdCBmb3IgY3VzdG9tIHNlbGVjdHMgYW5kIG90aGVyIHBsdWdpbnMKCQkvLyBzZWUgc2VsZWN0LmN1c3RvbSBmb3IgZXhhbXBsZSBleHRlbnNpb24KCQkvLyBUT0RPIGV4cGxvcmUgcGx1Z2luIHJlZ2lzdHJhdGlvbgoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVDcmVhdGUiICk7CgoJCXRoaXMuYnV0dG9uID0gdGhpcy5fYnV0dG9uKCk7CgoJCXZhciBzZWxmID0gdGhpcywKCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgoJCQlpbmxpbmUgPSBvcHRpb25zLmlubGluZSB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQltaW5pID0gb3B0aW9ucy5taW5pIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJtaW5pIiApLAoJCQlpY29ucG9zID0gb3B0aW9ucy5pY29uID8gKCBvcHRpb25zLmljb25wb3MgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImljb25wb3MiICkgKSA6IGZhbHNlLAoKCQkJLy8gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbiBhdCBvcHRpb25zLml0ZW0oKSBmdW5jdGlvbiB3aGVuCgkJCS8vIHRoZXJlIGlzIG5vIHNlbGVjdGVkIGl0ZW0KCQkJLy8gc2VsZWN0IGZpcnN0IGluIHRoaXMgY2FzZQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4ID09PSAtMSA/IDAgOiB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgoJCQkvLyBUT0RPIHZhbHVlcyBidXR0b25JZCBhbmQgbWVudUlkIGFyZSB1bmRlZmluZWQgaGVyZQoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmJ1dHRvbk1hcmt1cCggewoJCQkJCXRoZW1lOiBvcHRpb25zLnRoZW1lLAoJCQkJCWljb246IG9wdGlvbnMuaWNvbiwKCQkJCQlpY29ucG9zOiBpY29ucG9zLAoJCQkJCWlubGluZTogaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdywKCQkJCQltaW5pOiBtaW5pCgkJCQl9KTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQoKCQkvLyBBZGQgY291bnRlciBmb3IgbXVsdGkgc2VsZWN0cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50ID0gJCggIjxzcGFuPiIgKQoJCQkJLmFkZENsYXNzKCAidWktbGktY291bnQgdWktYnRuLXVwLWMgdWktYnRuLWNvcm5lci1hbGwiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCd1aS1saS1oYXMtY291bnQnKSApOwoJCX0KCgkJLy8gRGlzYWJsZSBpZiBzcGVjaWZpZWQKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBFdmVudHMgb24gbmF0aXZlIHNlbGVjdAoJCXRoaXMuc2VsZWN0LmNoYW5nZShmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgkJCQoJCQlpZiAoICEhb3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQkJdGhpcy5ibHVyKCk7CgkJCX0KCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMgdm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgkJCX0pCgkJCS5iaW5kKCAidm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gUmVtb3ZlIGFjdGl2ZSBjbGFzcyBvbiBzY3JvbGwvdG91Y2htb3ZlCgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciB2bW91c2VvdXQiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdXQiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYubGFiZWwuYmluZCggImNsaWNrIGZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuYnV0dG9uLmJpbmQoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CQkJCQoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfSwgMCApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsJCQkJCgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQiICk7Cgl9LAoKCXNlbGVjdGVkSW5kaWNlczogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlyZXR1cm4gdGhpcy5zZWxlY3RlZCgpLm1hcChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpLAoJCQl0ZXh0ID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJc3BhbiA9ICQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICk7CgoJCXRoaXMuYnV0dG9uLmZpbmQoICIudWktYnRuLXRleHQiICkuaHRtbChmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxlY3RlZC5sZW5ndGggKSB7CgkJCQl0ZXh0ID0gc2VsZWN0ZWQubWFwKGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQkJfSkuZ2V0KCkuam9pbiggIiwgIiApOwoJCQl9IGVsc2UgewoJCQkJdGV4dCA9IHNlbGYucGxhY2Vob2xkZXI7CgkJCX0KCgkJCS8vIFRPRE8gcG9zc2libHkgYWdncmVnYXRlIG11bHRpcGxlIHNlbGVjdCBvcHRpb24gY2xhc3NlcwoJCQlyZXR1cm4gc3Bhbi50ZXh0KCB0ZXh0ICkKCQkJCS5hZGRDbGFzcyggc2VsZi5zZWxlY3QuYXR0ciggImNsYXNzIiApICkKCQkJCS5hZGRDbGFzcyggc2VsZWN0ZWQuYXR0ciggImNsYXNzIiApICk7CgkJfSk7Cgl9LAoKCXNldEJ1dHRvbkNvdW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCk7CgoJCS8vIG11bHRpcGxlIGNvdW50IGluc2lkZSBidXR0b24KCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudFsgc2VsZWN0ZWQubGVuZ3RoID4gMSA/ICJzaG93IiA6ICJoaWRlIiBdKCkudGV4dCggc2VsZWN0ZWQubGVuZ3RoICk7CgkJfQoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCQl0aGlzLnNldEJ1dHRvbkNvdW50KCk7Cgl9LAoKCS8vIG9wZW4gYW5kIGNsb3NlIHByZXNlcnZlZCBpbiBuYXRpdmUgc2VsZWN0cwoJLy8gdG8gc2ltcGxpZnkgdXNlcnMgY29kZSB3aGVuIGxvb3Bpbmcgb3ZlciBzZWxlY3RzCglvcGVuOiAkLm5vb3AsCgljbG9zZTogJC5ub29wLAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCB0cnVlICk7CgkJdGhpcy5idXR0b24uYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggZmFsc2UgKTsKCQl0aGlzLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnNlbGVjdG1lbnUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCglmdW5jdGlvbiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggd2luU2l6ZSwgc2VnU2l6ZSwgb2Zmc2V0LCBkZXNpcmVkICkgewoJCXZhciByZXQgPSBkZXNpcmVkOwoKCQlpZiAoIHdpblNpemUgPCBzZWdTaXplICkgewoJCQkvLyBDZW50ZXIgc2VnbWVudCBpZiBpdCdzIGJpZ2dlciB0aGFuIHRoZSB3aW5kb3cKCQkJcmV0ID0gb2Zmc2V0ICsgKCB3aW5TaXplIC0gc2VnU2l6ZSApIC8gMjsKCQl9IGVsc2UgewoJCQkvLyBPdGhlcndpc2UgY2VudGVyIGl0IGF0IHRoZSBkZXNpcmVkIGNvb3JkaW5hdGUgd2hpbGUga2VlcGluZyBpdCBjb21wbGV0ZWx5IGluc2lkZSB0aGUgd2luZG93CgkJCXJldCA9IE1hdGgubWluKCBNYXRoLm1heCggb2Zmc2V0LCBkZXNpcmVkIC0gc2VnU2l6ZSAvIDIgKSwgb2Zmc2V0ICsgd2luU2l6ZSAtIHNlZ1NpemUgKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJZnVuY3Rpb24gd2luZG93Q29vcmRzKCkgewoJCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93OwoKCQlyZXR1cm4gewoJCQl4OiAkd2luLnNjcm9sbExlZnQoKSwKCQkJeTogJHdpbi5zY3JvbGxUb3AoKSwKCQkJY3g6ICggd2luZG93LmlubmVyV2lkdGggfHwgJHdpbi53aWR0aCgpICksCgkJCWN5OiAoIHdpbmRvdy5pbm5lckhlaWdodCB8fCAkd2luLmhlaWdodCgpICkKCQl9OwoJfQoKCSQud2lkZ2V0KCAibW9iaWxlLnBvcHVwIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCQlzaGFkb3c6IHRydWUsCgkJCWNvcm5lcnM6IHRydWUsCgkJCXRyYW5zaXRpb246ICJub25lIiwKCQkJcG9zaXRpb25UbzogIm9yaWdpbiIsCgkJCXRvbGVyYW5jZTogbnVsbCwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSIsCgkJCWNsb3NlTGlua1NlbGVjdG9yOiAiYTpqcW1EYXRhKHJlbD0nYmFjaycpIiwKCQkJY2xvc2VMaW5rRXZlbnRzOiAiY2xpY2sucG9wdXAiLAoJCQluYXZpZ2F0ZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIiwKCQkJY2xvc2VFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCBwYWdlYmVmb3JlY2hhbmdlLnBvcHVwIiwKCQkJZGlzbWlzc2libGU6IHRydWUsCgoJCQkvLyBOT1RFIFdpbmRvd3MgUGhvbmUgNyBoYXMgYSBzY3JvbGwgcG9zaXRpb24gY2FjaGluZyBpc3N1ZSB0aGF0CgkJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCQkvLyAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDc4NAoJCQkvLwoJCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJCWhpc3Rvcnk6ICEkLm1vYmlsZS5icm93c2VyLm9sZElFCgkJfSwKCgkJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCWlmICggdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQkJdGhpcy5jbG9zZSgpOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9LAoKCQkvLyBNYWtlIHN1cmUgdGhlIHNjcmVlbiBzaXplIGlzIGluY3JlYXNlZCBiZXlvbmQgdGhlIHBhZ2UgaGVpZ2h0IGlmIHRoZSBwb3B1cCdzIGNhdXNlcyB0aGUgZG9jdW1lbnQgdG8gaW5jcmVhc2UgaW4gaGVpZ2h0CgkJX3Jlc2l6ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJCXZhciBwb3B1cEhlaWdodCA9IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApOwoKCQkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQkJaWYgKCBwb3B1cEhlaWdodCA+IHRoaXMuX3VpLnNjcmVlbi5oZWlnaHQoKSApIHsKCQkJCXRoaXMuX3VpLnNjcmVlbi5oZWlnaHQoIHBvcHVwSGVpZ2h0ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlV2luZG93S2V5VXA6IGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiBlLmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRVNDQVBFICkgewoJCQkJcmV0dXJuIHRoaXMuX2VhdEV2ZW50QW5kQ2xvc2UoIGUgKTsKCQkJfQoJCX0sCgoJCV9leHBlY3RSZXNpemVFdmVudDogZnVuY3Rpb24oKSB7CgkJCXZhciB3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKTsKCgkJCWlmICggdGhpcy5fcmVzaXplRGF0YSApIHsKCQkJCWlmICggd2luQ29vcmRzLnggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLnggJiYKCQkJCQl3aW5Db29yZHMueSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMueSAmJgoJCQkJCXdpbkNvb3Jkcy5jeCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMuY3ggJiYKCQkJCQl3aW5Db29yZHMuY3kgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN5ICkgewoJCQkJCS8vIHRpbWVvdXQgbm90IHJlZnJlc2hlZAoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY2xlYXIgZXhpc3RpbmcgdGltZW91dCAtIGl0IHdpbGwgYmUgcmVmcmVzaGVkIGJlbG93CgkJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9yZXNpemVEYXRhLnRpbWVvdXRJZCApOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl9yZXNpemVEYXRhID0gewoJCQkJdGltZW91dElkOiBzZXRUaW1lb3V0KCAkLnByb3h5KCB0aGlzLCAiX3Jlc2l6ZVRpbWVvdXQiICksIDIwMCApLAoJCQkJd2luQ29vcmRzOiB3aW5Db29yZHMKCQkJfTsKCgkJCXJldHVybiB0cnVlOwoJCX0sCgoJCV9yZXNpemVUaW1lb3V0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQlpZiAoICF0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpICkgewoJCQkJCWlmICggdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1vcGVuIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKTsKCQkJCQkJdGhpcy5yZXBvc2l0aW9uKCB7IHBvc2l0aW9uVG86ICJ3aW5kb3ciIH0gKTsKCQkJCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJCQkJfQoKCQkJCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJCX0KCQl9LAoKCQlfaWdub3JlUmVzaXplRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJaWYgKCB0aGlzLl9pZ25vcmVSZXNpemVUbyApIHsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5faWdub3JlUmVzaXplVG8gKTsKCQkJfQoJCQl0aGlzLl9pZ25vcmVSZXNpemVUbyA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgeyBzZWxmLl9pZ25vcmVSZXNpemVUbyA9IDA7IH0sIDEwMDAgKTsKCQl9LAoKCQlfaGFuZGxlV2luZG93UmVzaXplOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCQlpZiAoICggdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSB8fCB0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgKSAmJgoJCQkJCSF0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtY2xvc2UgdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApCgkJCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJCQl9CgkJCX0KCQl9LAoKCQlfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2U6IGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoICF0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgJiYgdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQkJdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKTsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IHRydWU7CgkJCX0KCQl9LAoKCQkvLyBXaGVuIHRoZSBwb3B1cCBpcyBvcGVuLCBhdHRlbXB0aW5nIHRvIGZvY3VzIG9uIGFuIGVsZW1lbnQgdGhhdCBpcyBub3QgYQoJCS8vIGNoaWxkIG9mIHRoZSBwb3B1cCB3aWxsIHJlZGlyZWN0IGZvY3VzIHRvIHRoZSBwb3B1cAoJCV9oYW5kbGVEb2N1bWVudEZvY3VzSW46IGZ1bmN0aW9uKCBlICkgewoJCQl2YXIgdGd0ID0gZS50YXJnZXQsICR0Z3QsIHVpID0gdGhpcy5fdWk7CgoJCQlpZiAoICF0aGlzLl9pc09wZW4gKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGd0ICE9PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJCSR0Z3QgPSAkKCBlLnRhcmdldCApOwoJCQkJaWYgKCAwID09PSAkdGd0LnBhcmVudHMoKS5maWx0ZXIoIHVpLmNvbnRhaW5lclsgMCBdICkubGVuZ3RoICkgewoJCQkJCSQoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgKS5vbmUoICJmb2N1cyIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQkkdGd0LmJsdXIoKTsKCQkJCQl9KTsKCQkJCQl1aS5mb2N1c0VsZW1lbnQuZm9jdXMoKTsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9IGVsc2UgaWYgKCB1aS5mb2N1c0VsZW1lbnRbIDAgXSA9PT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCQkJdWkuZm9jdXNFbGVtZW50ID0gJHRndDsKCQkJCX0KCQkJfQoKCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciB1aSA9IHsKCQkJCQlzY3JlZW46ICQoICI8ZGl2IGNsYXNzPSd1aS1zY3JlZW4taGlkZGVuIHVpLXBvcHVwLXNjcmVlbic+PC9kaXY+IiApLAoJCQkJCXBsYWNlaG9sZGVyOiAkKCAiPGRpdiBzdHlsZT0nZGlzcGxheTogbm9uZTsnPjwhLS0gcGxhY2Vob2xkZXIgLS0+PC9kaXY+IiApLAoJCQkJCWNvbnRhaW5lcjogJCggIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWNvbnRhaW5lciB1aS1wb3B1cC1oaWRkZW4nPjwvZGl2PiIgKQoJCQkJfSwKCQkJCXRoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJCW15SWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApLAoJCQkJc2VsZiA9IHRoaXM7CgoJCQkvLyBXZSBuZWVkIHRvIGFkanVzdCB0aGUgaGlzdG9yeSBvcHRpb24gdG8gYmUgZmFsc2UgaWYgdGhlcmUncyBubyBBSkFYIG5hdi4KCQkJLy8gV2UgY2FuJ3QgZG8gaXQgaW4gdGhlIG9wdGlvbiBkZWNsYXJhdGlvbnMgYmVjYXVzZSB0aG9zZSBhcmUgcnVuIGJlZm9yZQoJCQkvLyBpdCBpcyBkZXRlcm1pbmVkIHdoZXRoZXIgdGhlcmUgc2hhbGwgYmUgQUpBWCBuYXYuCgkJCXRoaXMub3B0aW9ucy5oaXN0b3J5ID0gdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCQlpZiAoIHRoaXNQYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJCXRoaXNQYWdlID0gJCggImJvZHkiICk7CgkJCX0KCgkJCS8vIGRlZmluZSB0aGUgY29udGFpbmVyIGZvciBuYXZpZ2F0aW9uIGV2ZW50IGJpbmRpbmdzCgkJCS8vIFRPRE8gdGhpcyB3b3VsZCBiZSBuaWNlIGF0IHRoZSB0aGUgbW9iaWxlIHdpZGdldCBsZXZlbAoJCQl0aGlzLm9wdGlvbnMuY29udGFpbmVyID0gdGhpcy5vcHRpb25zLmNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkJLy8gQXBwbHkgdGhlIHByb3RvCgkJCXRoaXNQYWdlLmFwcGVuZCggdWkuc2NyZWVuICk7CgkJCXVpLmNvbnRhaW5lci5pbnNlcnRBZnRlciggdWkuc2NyZWVuICk7CgkJCS8vIExlYXZlIGEgcGxhY2Vob2xkZXIgd2hlcmUgdGhlIGVsZW1lbnQgdXNlZCB0byBiZQoJCQl1aS5wbGFjZWhvbGRlci5pbnNlcnRBZnRlciggdGhpcy5lbGVtZW50ICk7CgkJCWlmICggbXlJZCApIHsKCQkJCXVpLnNjcmVlbi5hdHRyKCAiaWQiLCBteUlkICsgIi1zY3JlZW4iICk7CgkJCQl1aS5jb250YWluZXIuYXR0ciggImlkIiwgbXlJZCArICItcG9wdXAiICk7CgkJCQl1aS5wbGFjZWhvbGRlci5odG1sKCAiPCEtLSBwbGFjZWhvbGRlciBmb3IgIiArIG15SWQgKyAiIC0tPiIgKTsKCQkJfQoJCQl1aS5jb250YWluZXIuYXBwZW5kKCB0aGlzLmVsZW1lbnQgKTsKCQkJdWkuZm9jdXNFbGVtZW50ID0gdWkuY29udGFpbmVyOwoKCQkJLy8gQWRkIGNsYXNzIHRvIHBvcHVwIGVsZW1lbnQKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktcG9wdXAiICk7CgoJCQkvLyBEZWZpbmUgaW5zdGFuY2UgdmFyaWFibGVzCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfc2Nyb2xsVG9wOiAwLAoJCQkJX3BhZ2U6IHRoaXNQYWdlLAoJCQkJX3VpOiB1aSwKCQkJCV9mYWxsYmFja1RyYW5zaXRpb246ICIiLAoJCQkJX2N1cnJlbnRUcmFuc2l0aW9uOiBmYWxzZSwKCQkJCV9wcmVyZXFzOiBudWxsLAoJCQkJX2lzT3BlbjogZmFsc2UsCgkJCQlfdG9sZXJhbmNlOiBudWxsLAoJCQkJX3Jlc2l6ZURhdGE6IG51bGwsCgkJCQlfaWdub3JlUmVzaXplVG86IDAsCgkJCQlfb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzOiBmYWxzZQoJCQl9KTsKCgkJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCS8vIENhdXNlIGluaXRpYWwgb3B0aW9ucyB0byBiZSBhcHBsaWVkIGJ5IHRoZWlyIGhhbmRsZXIgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyB0aGUgb3B0aW9uIHRvIHVuZGVmaW5lZAoJCQkJLy8gLSB0aGUgaGFuZGxlciB0aGVuIHNldHMgaXQgdG8gdGhlIGluaXRpYWwgdmFsdWUKCQkJCXNlbGYub3B0aW9uc1sga2V5IF0gPSB1bmRlZmluZWQ7CgkJCQlzZWxmLl9zZXRPcHRpb24oIGtleSwgdmFsdWUsIHRydWUgKTsKCQkJfSk7CgoJCQl1aS5zY3JlZW4uYmluZCggInZjbGljayIsICQucHJveHkoIHRoaXMsICJfZWF0RXZlbnRBbmRDbG9zZSIgKSApOwoKCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgewoJCQkJb3JpZW50YXRpb25jaGFuZ2U6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2UiICksCgkJCQlyZXNpemU6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93UmVzaXplIiApLAoJCQkJa2V5dXA6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93S2V5VXAiICkKCQkJfSk7CgkJCXRoaXMuX29uKCAkLm1vYmlsZS5kb2N1bWVudCwgewoJCQkJZm9jdXNpbjogJC5wcm94eSggdGhpcywgIl9oYW5kbGVEb2N1bWVudEZvY3VzSW4iICkKCQkJfSk7CgkJfSwKCgkJX2FwcGx5VGhlbWU6IGZ1bmN0aW9uKCBkc3QsIHRoZW1lLCBwcmVmaXggKSB7CgkJCXZhciBjbGFzc2VzID0gKCBkc3QuYXR0ciggImNsYXNzIiApIHx8ICIiKS5zcGxpdCggIiAiICksCgkJCQlhbHJlYWR5QWRkZWQgPSB0cnVlLAoJCQkJY3VycmVudFRoZW1lID0gbnVsbCwKCQkJCW1hdGNoZXMsCgkJCQl0aGVtZVN0ciA9IFN0cmluZyggdGhlbWUgKTsKCgkJCXdoaWxlICggY2xhc3Nlcy5sZW5ndGggPiAwICkgewoJCQkJY3VycmVudFRoZW1lID0gY2xhc3Nlcy5wb3AoKTsKCQkJCW1hdGNoZXMgPSAoIG5ldyBSZWdFeHAoICJedWktIiArIHByZWZpeCArICItKFthLXpdKSQiICkgKS5leGVjKCBjdXJyZW50VGhlbWUgKTsKCQkJCWlmICggbWF0Y2hlcyAmJiBtYXRjaGVzLmxlbmd0aCA+IDEgKSB7CgkJCQkJY3VycmVudFRoZW1lID0gbWF0Y2hlc1sgMSBdOwoJCQkJCWJyZWFrOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50VGhlbWUgPSBudWxsOwoJCQkJfQoJCQl9CgoJCQlpZiAoIHRoZW1lICE9PSBjdXJyZW50VGhlbWUgKSB7CgkJCQlkc3QucmVtb3ZlQ2xhc3MoICJ1aS0iICsgcHJlZml4ICsgIi0iICsgY3VycmVudFRoZW1lICk7CgkJCQlpZiAoICEgKCB0aGVtZSA9PT0gbnVsbCB8fCB0aGVtZSA9PT0gIm5vbmUiICkgKSB7CgkJCQkJZHN0LmFkZENsYXNzKCAidWktIiArIHByZWZpeCArICItIiArIHRoZW1lU3RyICk7CgkJCQl9CgkJCX0KCQl9LAoKCQlfc2V0VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5fYXBwbHlUaGVtZSggdGhpcy5lbGVtZW50LCB2YWx1ZSwgImJvZHkiICk7CgkJfSwKCgkJX3NldE92ZXJsYXlUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9hcHBseVRoZW1lKCB0aGlzLl91aS5zY3JlZW4sIHZhbHVlLCAib3ZlcmxheSIgKTsKCgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJdGhpcy5fdWkuc2NyZWVuLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQl9LAoKCQlfc2V0U2hhZG93OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW92ZXJsYXktc2hhZG93IiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0Q29ybmVyczogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9LAoKCQlfYXBwbHlUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCWlmICggdmFsdWUgJiYgdmFsdWUgIT09ICJub25lIiApIHsKCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPT09ICJub25lIiApIHsKCQkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAiIjsKCQkJCX0KCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCX0KCQl9LAoKCQlfc2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oIHZhbHVlICkgewoJCQlpZiAoICF0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggdmFsdWUgKTsKCQkJfQoJCX0sCgoJCV9zZXRUb2xlcmFuY2U6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIHRvbCA9IHsgdDogMzAsIHI6IDE1LCBiOiAzMCwgbDogMTUgfTsKCgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXZhciBhciA9IFN0cmluZyggdmFsdWUgKS5zcGxpdCggIiwiICk7CgoJCQkJJC5lYWNoKCBhciwgZnVuY3Rpb24oIGlkeCwgdmFsICkgeyBhclsgaWR4IF0gPSBwYXJzZUludCggdmFsLCAxMCApOyB9ICk7CgoJCQkJc3dpdGNoKCBhci5sZW5ndGggKSB7CgkJCQkJLy8gQWxsIHZhbHVlcyBhcmUgdG8gYmUgdGhlIHNhbWUKCQkJCQljYXNlIDE6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IHRvbC5yID0gdG9sLmIgPSB0b2wubCA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCS8vIFRoZSBmaXJzdCB2YWx1ZSBkZW5vdGVzIHRvcC9ib3R0b20gdG9sZXJhbmNlLCBhbmQgdGhlIHNlY29uZCB2YWx1ZSBkZW5vdGVzIGxlZnQvcmlnaHQgdG9sZXJhbmNlCgkJCQkJY2FzZSAyOgoJCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQkJdG9sLnQgPSB0b2wuYiA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJCXRvbC5sID0gdG9sLnIgPSBhclsgMSBdOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoKCQkJCQkvLyBUaGUgYXJyYXkgY29udGFpbnMgdmFsdWVzIGluIHRoZSBvcmRlciB0b3AsIHJpZ2h0LCBib3R0b20sIGxlZnQKCQkJCQljYXNlIDQ6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJCXRvbC5yID0gYXJbIDEgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDIgXSApICkgewoJCQkJCQkJdG9sLmIgPSBhclsgMiBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMyBdICkgKSB7CgkJCQkJCQl0b2wubCA9IGFyWyAzIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCWRlZmF1bHQ6CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl90b2xlcmFuY2UgPSB0b2w7CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCXZhciBleGNsdXNpb25zLCBzZXR0ZXIgPSAiX3NldCIgKyBrZXkuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIGtleS5zbGljZSggMSApOwoKCQkJaWYgKCB0aGlzWyBzZXR0ZXIgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpc1sgc2V0dGVyIF0oIHZhbHVlICk7CgkJCX0KCgkJCS8vIFRPRE8gUkVNT1ZFIEZPUiAxLjIuMSBieSBtb3ZpbmcgdGhlbSBvdXQgdG8gYSBkZWZhdWx0IG9wdGlvbnMgb2JqZWN0CgkJCWV4Y2x1c2lvbnMgPSBbCgkJCQkiaW5pdFNlbGVjdG9yIiwKCQkJCSJjbG9zZUxpbmtTZWxlY3RvciIsCgkJCQkiY2xvc2VMaW5rRXZlbnRzIiwKCQkJCSJuYXZpZ2F0ZUV2ZW50cyIsCgkJCQkiY2xvc2VFdmVudHMiLAoJCQkJImhpc3RvcnkiLAoJCQkJImNvbnRhaW5lciIKCQkJXTsKCgkJCSQubW9iaWxlLndpZGdldC5wcm90b3R5cGUuX3NldE9wdGlvbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCWlmICggJC5pbkFycmF5KCBrZXksIGV4Y2x1c2lvbnMgKSA9PT0gLTEgKSB7CgkJCQkvLyBSZWNvcmQgdGhlIG9wdGlvbiBjaGFuZ2UgaW4gdGhlIG9wdGlvbnMgYW5kIGluIHRoZSBET00gZGF0YS0qIGF0dHJpYnV0ZXMKCQkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgKCBrZXkucmVwbGFjZSggLyhbQS1aXSkvLCAiLSQxIiApLnRvTG93ZXJDYXNlKCkgKSwgdmFsdWUgKTsKCQkJfQoJCX0sCgoJCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCgkJX3BsYWNlbWVudENvb3JkczogZnVuY3Rpb24oIGRlc2lyZWQgKSB7CgkJCS8vIHJlY3RhbmdsZSB3aXRoaW4gd2hpY2ggdGhlIHBvcHVwIG11c3QgZml0CgkJCXZhcgoJCQkJd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCksCgkJCQlyYyA9IHsKCQkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCQl5OiB3aW5Db29yZHMueSArIHRoaXMuX3RvbGVyYW5jZS50LAoJCQkJCWN4OiB3aW5Db29yZHMuY3ggLSB0aGlzLl90b2xlcmFuY2UubCAtIHRoaXMuX3RvbGVyYW5jZS5yLAoJCQkJCWN5OiB3aW5Db29yZHMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCQl9LAoJCQkJbWVudVNpemUsIHJldDsKCgkJCS8vIENsYW1wIHRoZSB3aWR0aCBvZiB0aGUgbWVudSBiZWZvcmUgZ3JhYmJpbmcgaXRzIHNpemUKCQkJdGhpcy5fdWkuY29udGFpbmVyLmNzcyggIm1heC13aWR0aCIsIHJjLmN4ICk7CgkJCW1lbnVTaXplID0gewoJCQkJY3g6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlcldpZHRoKCB0cnVlICksCgkJCQljeTogdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICkKCQkJfTsKCgkJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCQkvLyB0aGUgd2luZG93IHRvbGVyYW5jZXMuIFRoaXMgd2lsbCBjZW50ZXIgd3J0LiB0aGUgd2luZG93IGlmIHRoZSBwb3B1cCBpcyB0b28gbGFyZ2UuCgkJCXJldCA9IHsKCQkJCXg6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByYy5jeCwgbWVudVNpemUuY3gsIHJjLngsIGRlc2lyZWQueCApLAoJCQkJeTogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJjLmN5LCBtZW51U2l6ZS5jeSwgcmMueSwgZGVzaXJlZC55ICkKCQkJfTsKCgkJCS8vIE1ha2Ugc3VyZSB0aGUgdG9wIG9mIHRoZSBtZW51IGlzIHZpc2libGUKCQkJcmV0LnkgPSBNYXRoLm1heCggMCwgcmV0LnkgKTsKCgkJCS8vIElmIHRoZSBoZWlnaHQgb2YgdGhlIG1lbnUgaXMgc21hbGxlciB0aGFuIHRoZSBoZWlnaHQgb2YgdGhlIGRvY3VtZW50CgkJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQkJLy8gZml4IGZvciAkLm1vYmlsZS5kb2N1bWVudC5oZWlnaHQoKSBidWcgaW4gY29yZSAxLjcuMi4KCQkJdmFyIGRvY0VsID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBkb2NCb2R5ID0gZG9jdW1lbnQuYm9keSwKCQkJCWRvY0hlaWdodCA9IE1hdGgubWF4KCBkb2NFbC5jbGllbnRIZWlnaHQsIGRvY0JvZHkuc2Nyb2xsSGVpZ2h0LCBkb2NCb2R5Lm9mZnNldEhlaWdodCwgZG9jRWwuc2Nyb2xsSGVpZ2h0LCBkb2NFbC5vZmZzZXRIZWlnaHQgKTsKCgkJCXJldC55IC09IE1hdGgubWluKCByZXQueSwgTWF0aC5tYXgoIDAsIHJldC55ICsgbWVudVNpemUuY3kgLSBkb2NIZWlnaHQgKSApOwoKCQkJcmV0dXJuIHsgbGVmdDogcmV0LngsIHRvcDogcmV0LnkgfTsKCQl9LAoKCQlfY3JlYXRlUHJlcmVxczogZnVuY3Rpb24oIHNjcmVlblByZXJlcSwgY29udGFpbmVyUHJlcmVxLCB3aGVuRG9uZSApIHsKCQkJdmFyIHNlbGYgPSB0aGlzLCBwcmVyZXFzOwoKCQkJLy8gSXQgaXMgaW1wb3J0YW50IHRvIG1haW50YWluIGJvdGggdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXMgYW5kIHNlbGYuX3ByZXJlcXMuIFRoZSBsb2NhbCB2YXJpYWJsZSByZW1haW5zIGluCgkJCS8vIHRoZSBjbG9zdXJlIG9mIHRoZSBmdW5jdGlvbnMgd2hpY2ggY2FsbCB0aGUgY2FsbGJhY2tzIHBhc3NlZCBpbi4gVGhlIGNvbXBhcmlzb24gYmV0d2VlbiB0aGUgbG9jYWwgdmFyaWFibGUgYW5kCgkJCS8vIHNlbGYuX3ByZXJlcXMgaXMgbmVjZXNzYXJ5LCBiZWNhdXNlIG9uY2UgYSBmdW5jdGlvbiBoYXMgYmVlbiBwYXNzZWQgdG8gLmFuaW1hdGlvbkNvbXBsZXRlKCkgaXQgd2lsbCBiZSBjYWxsZWQKCQkJLy8gbmV4dCB0aW1lIGFuIGFuaW1hdGlvbiBjb21wbGV0ZXMsIGV2ZW4gaWYgdGhhdCdzIG5vdCB0aGUgYW5pbWF0aW9uIHdob3NlIGVuZCB0aGUgZnVuY3Rpb24gd2FzIHN1cHBvc2VkIHRvIGNhdGNoCgkJCS8vIChmb3IgZXhhbXBsZSwgaWYgYW4gYWJvcnQgaGFwcGVucyBkdXJpbmcgdGhlIG9wZW5pbmcgYW5pbWF0aW9uLCB0aGUgLmFuaW1hdGlvbkNvbXBsZXRlIGhhbmRsZXIgaXMgbm90IGNhbGxlZCBmb3IKCQkJLy8gdGhhdCBhbmltYXRpb24gYW55bW9yZSwgYnV0IHRoZSBoYW5kbGVyIHJlbWFpbnMgYXR0YWNoZWQsIHNvIGl0IGlzIGNhbGxlZCB0aGUgbmV4dCB0aW1lIHRoZSBwb3B1cCBpcyBvcGVuZWQKCQkJLy8gLSBtYWtpbmcgaXQgc3RhbGUuIENvbXBhcmluZyB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxcyB0byB0aGUgd2lkZ2V0LWxldmVsIHZhcmlhYmxlIHNlbGYuX3ByZXJlcXMgZW5zdXJlcyB0aGF0CgkJCS8vIGNhbGxiYWNrcyB0cmlnZ2VyZWQgYnkgYSBzdGFsZSAuYW5pbWF0aW9uQ29tcGxldGUgd2lsbCBiZSBpZ25vcmVkLgoKCQkJcHJlcmVxcyA9IHsKCQkJCXNjcmVlbjogJC5EZWZlcnJlZCgpLAoJCQkJY29udGFpbmVyOiAkLkRlZmVycmVkKCkKCQkJfTsKCgkJCXByZXJlcXMuc2NyZWVuLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJCXNjcmVlblByZXJlcSgpOwoJCQkJfQoJCQl9KTsKCgkJCXByZXJlcXMuY29udGFpbmVyLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJCWNvbnRhaW5lclByZXJlcSgpOwoJCQkJfQoJCQl9KTsKCgkJCSQud2hlbiggcHJlcmVxcy5zY3JlZW4sIHByZXJlcXMuY29udGFpbmVyICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQkJc2VsZi5fcHJlcmVxcyA9IG51bGw7CgkJCQkJd2hlbkRvbmUoKTsKCQkJCX0KCQkJfSk7CgoJCQlzZWxmLl9wcmVyZXFzID0gcHJlcmVxczsKCQl9LAoKCQlfYW5pbWF0ZTogZnVuY3Rpb24oIGFyZ3MgKSB7CgkJCS8vIE5PVEUgYmVmb3JlIHJlbW92aW5nIHRoZSBkZWZhdWx0IGFuaW1hdGlvbiBvZiB0aGUgc2NyZWVuCgkJCS8vICAgICAgdGhpcyBoYWQgYW4gYW5pbWF0ZSBjYWxsYmFjayB0aGF0IHdvdWxkIHJlc29sdmUgdGhlIGRlZmVycmVkCgkJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCQkvLyBUT0RPIHJlbW92ZSB0aGUgZGVwZW5kZW5jeSBvbiB0aGUgc2NyZWVuIGRlZmVycmVkCgkJCXRoaXMuX3VpLnNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkJLmFkZENsYXNzKCBhcmdzLnNjcmVlbkNsYXNzVG9BZGQgKTsKCgkJCWFyZ3MucHJlcmVxcy5zY3JlZW4ucmVzb2x2ZSgpOwoKCQkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCQlpZiAoIGFyZ3MuYXBwbHlUcmFuc2l0aW9uICkgewoJCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggYXJncy50cmFuc2l0aW9uICk7CgkJCQl9CgkJCQlpZiAoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApIHsKCQkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KCBhcmdzLnByZXJlcXMuY29udGFpbmVyLCAicmVzb2x2ZSIgKSApCgkJCQkJCS5hZGRDbGFzcyggYXJncy5jb250YWluZXJDbGFzc1RvQWRkICkKCQkJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQkJYXJncy5wcmVyZXFzLmNvbnRhaW5lci5yZXNvbHZlKCk7CgkJfSwKCgkJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJCS8vIGRlc2lyZWRQb3NpdGlvbi5wb3NpdGlvblRvLiBOZXZlcnRoZWxlc3MsIHRoaXMgZnVuY3Rpb24gZW5zdXJlcyB0aGF0IGl0cyByZXR1cm4gdmFsdWUgYWx3YXlzIGNvbnRhaW5zIHZhbGlkCgkJLy8geCBhbmQgeSBjb29yZGluYXRlcyBieSBzcGVjaWZ5aW5nIHRoZSBjZW50ZXIgbWlkZGxlIG9mIHRoZSB3aW5kb3cgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSBhYnNlbnQuCgkJLy8gb3B0aW9uczogeyB4OiBjb29yZGluYXRlLCB5OiBjb29yZGluYXRlLCBwb3NpdGlvblRvOiBzdHJpbmc6ICJvcmlnaW4iLCAid2luZG93Iiwgb3IgalF1ZXJ5IHNlbGVjdG9yCgkJX2Rlc2lyZWRDb29yZHM6IGZ1bmN0aW9uKCBvICkgewoJCQl2YXIgZHN0ID0gbnVsbCwgb2Zmc2V0LCB3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKSwgeCA9IG8ueCwgeSA9IG8ueSwgcFRvID0gby5wb3NpdGlvblRvOwoKCQkJLy8gRXN0YWJsaXNoIHdoaWNoIGVsZW1lbnQgd2lsbCBzZXJ2ZSBhcyB0aGUgcmVmZXJlbmNlCgkJCWlmICggcFRvICYmIHBUbyAhPT0gIm9yaWdpbiIgKSB7CgkJCQlpZiAoIHBUbyA9PT0gIndpbmRvdyIgKSB7CgkJCQkJeCA9IHdpbkNvb3Jkcy5jeCAvIDIgKyB3aW5Db29yZHMueDsKCQkJCQl5ID0gd2luQ29vcmRzLmN5IC8gMiArIHdpbkNvb3Jkcy55OwoJCQkJfSBlbHNlIHsKCQkJCQl0cnkgewoJCQkJCQlkc3QgPSAkKCBwVG8gKTsKCQkJCQl9IGNhdGNoKCBlICkgewoJCQkJCQlkc3QgPSBudWxsOwoJCQkJCX0KCQkJCQlpZiAoIGRzdCApIHsKCQkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCQlpZiAoIGRzdC5sZW5ndGggPT09IDAgKSB7CgkJCQkJCQlkc3QgPSBudWxsOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBJZiBhbiBlbGVtZW50IHdhcyBmb3VuZCwgY2VudGVyIG92ZXIgaXQKCQkJaWYgKCBkc3QgKSB7CgkJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCQl4ID0gb2Zmc2V0LmxlZnQgKyBkc3Qub3V0ZXJXaWR0aCgpIC8gMjsKCQkJCXkgPSBvZmZzZXQudG9wICsgZHN0Lm91dGVySGVpZ2h0KCkgLyAyOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgeCBhbmQgeSBhcmUgdmFsaWQgbnVtYmVycyAtIGNlbnRlciBvdmVyIHRoZSB3aW5kb3cKCQkJaWYgKCAkLnR5cGUoIHggKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHggKSApIHsKCQkJCXggPSB3aW5Db29yZHMuY3ggLyAyICsgd2luQ29vcmRzLng7CgkJCX0KCQkJaWYgKCAkLnR5cGUoIHkgKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHkgKSApIHsKCQkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJCX0KCgkJCXJldHVybiB7IHg6IHgsIHk6IHkgfTsKCQl9LAoKCQlfcmVwb3NpdGlvbjogZnVuY3Rpb24oIG8gKSB7CgkJCS8vIFdlIG9ubHkgY2FyZSBhYm91dCBwb3NpdGlvbi1yZWxhdGVkIHBhcmFtZXRlcnMgZm9yIHJlcG9zaXRpb25pbmcKCQkJbyA9IHsgeDogby54LCB5OiBvLnksIHBvc2l0aW9uVG86IG8ucG9zaXRpb25UbyB9OwoJCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlcG9zaXRpb24iLCBvICk7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5vZmZzZXQoIHRoaXMuX3BsYWNlbWVudENvb3JkcyggdGhpcy5fZGVzaXJlZENvb3JkcyggbyApICkgKTsKCQl9LAoKCQlyZXBvc2l0aW9uOiBmdW5jdGlvbiggbyApIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQl0aGlzLl9yZXBvc2l0aW9uKCBvICk7CgkJCX0KCQl9LAoKCQlfb3BlblByZXJlcXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQkJdGhpcy5faXNPcGVuID0gdHJ1ZTsKCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKS5mb2N1cygpOwoJCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQkJdGhpcy5fdHJpZ2dlciggImFmdGVyb3BlbiIgKTsKCQl9LAoKCQlfb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXZhciBvID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMgKSwKCQkJCS8vIFRPRE8gbW92ZSBibGFja2xpc3QgdG8gcHJpdmF0ZSBtZXRob2QKCQkJCWFuZHJvaWRCbGFja2xpc3QgPSAoIGZ1bmN0aW9uKCkgewoJCQkJCXZhciB3ID0gd2luZG93LAoJCQkJCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOVwuXSspLyApLAoJCQkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJCQlhbmRyb2lkbWF0Y2ggPSB1YS5tYXRjaCggL0FuZHJvaWQgKFxkKyg/OlwuXGQrKSkvICksCgkJCQkJCWFuZHZlcnNpb24gPSAhIWFuZHJvaWRtYXRjaCAmJiBhbmRyb2lkbWF0Y2hbIDEgXSwKCQkJCQkJY2hyb21lbWF0Y2ggPSB1YS5pbmRleE9mKCAiQ2hyb21lIiApID4gLTE7CgoJCQkJCS8vIFBsYXRmb3JtIGlzIEFuZHJvaWQsIFdlYktpdCB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiA1MzQuMTMgKCBBbmRyb2lkIDMuMi4xICkgYW5kIG5vdCBDaHJvbWUuCgkJCQkJaWYoIGFuZHJvaWRtYXRjaCAhPT0gbnVsbCAmJiBhbmR2ZXJzaW9uID09PSAiNC4wIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uID4gNTM0LjEzICYmICFjaHJvbWVtYXRjaCApIHsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0oKSk7CgoJCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJvcGVuIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJCS8vIDIuIFRoZSBzY3JlZW4gb3BhY2l0eSBhbmltYXRpb24gY29tcGxldGVzIChzY3JlZW4oKSkKCQkJdGhpcy5fY3JlYXRlUHJlcmVxcygKCQkJCSQubm9vcCwKCQkJCSQubm9vcCwKCQkJCSQucHJveHkoIHRoaXMsICJfb3BlblByZXJlcXNDb21wbGV0ZSIgKSApOwoKCQkJdGhpcy5fY3VycmVudFRyYW5zaXRpb24gPSBvLnRyYW5zaXRpb247CgkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggby50cmFuc2l0aW9uICk7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCQl0aGlzLl9zZXRUaGVtZSggdGhpcy5fcGFnZS5qcW1EYXRhKCAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuX3BhZ2UsICJjIiApICk7CgkJCX0KCgkJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKTsKCgkJCS8vIEdpdmUgYXBwbGljYXRpb25zIGEgY2hhbmNlIHRvIG1vZGlmeSB0aGUgY29udGVudHMgb2YgdGhlIGNvbnRhaW5lciBiZWZvcmUgaXQgYXBwZWFycwoJCQl0aGlzLl9yZXBvc2l0aW9uKCBvICk7CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgJiYgYW5kcm9pZEJsYWNrbGlzdCApIHsKCQkJCS8qIFRPRE86CgkJCQlUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZAoJCQkJYWJvdmUgdGhlIHBvcHVwIGl0c2VsZiB3aGVuIGNlcnRhaW4gb3RoZXIgc3R5bGVzIGV4aXN0IG9uIHRoZSBzYW1lIHBhZ2UgLS0gbmFtZWx5LCBhbnkgZWxlbWVudCBzZXQgdG8gYHBvc2l0aW9uOiBmaXhlZGAgYW5kIGNlcnRhaW4KCQkJCXR5cGVzIG9mIGlucHV0LiBUaGVzZSBpc3N1ZXMgYXJlIHJlbWluaXNjZW50IG9mIHByZXZpb3VzbHkgdW5jb3ZlcmVkIGJ1Z3MgaW4gb2xkZXIgdmVyc2lvbnMgb2YgQW5kcm9pZCdzIG5hdGl2ZSBicm93c2VyOgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoKCQkJCVRoaXMgZml4IGNsb3NlcyB0aGUgZm9sbG93aW5nIGJ1Z3MgKCBJIHVzZSAiY2xvc2VzIiB3aXRoIHJlbHVjdGFuY2UsIGFuZCBzdHJlc3MgdGhhdCB0aGlzIGlzc3VlIHNob3VsZCBiZSByZXZpc2l0ZWQgYXMgc29vbiBhcyBwb3NzaWJsZSApOgoKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDgxNgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODQ0CgkJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NzQKCQkJCSovCgoJCQkJLy8gVE9ETyBzb3J0IG91dCB3aHkgdGhpcy5fcGFnZSBpc24ndCB3b3JraW5nCgkJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCQkJfQoJCQl0aGlzLl9hbmltYXRlKHsKCQkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRydWUsCgkJCQl0cmFuc2l0aW9uOiBvLnRyYW5zaXRpb24sCgkJCQljbGFzc1RvUmVtb3ZlOiAiIiwKCQkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJpbiIsCgkJCQljb250YWluZXJDbGFzc1RvQWRkOiAiaW4iLAoJCQkJYXBwbHlUcmFuc2l0aW9uOiBmYWxzZSwKCQkJCXByZXJlcXM6IHRoaXMuX3ByZXJlcXMKCQkJfSk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxU2NyZWVuOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdWkuc2NyZWVuCgkJCQkucmVtb3ZlQ2xhc3MoICJvdXQiICkKCQkJCS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxQ29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkucmVtb3ZlQ2xhc3MoICJyZXZlcnNlIG91dCIgKQoJCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApCgkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCX0sCgoJCV9jbG9zZVByZXJlcXNEb25lOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoKCQkJLy8gcmVtb3ZlIHRoZSBnbG9iYWwgbXV0ZXggZm9yIHBvcHVwcwoJCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB1bmRlZmluZWQ7CgoJCQkvLyBhbGVydCB1c2VycyB0aGF0IHRoZSBwb3B1cCBpcyBjbG9zZWQKCQkJdGhpcy5fdHJpZ2dlciggImFmdGVyY2xvc2UiICk7CgkJfSwKCgkJX2Nsb3NlOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoKCQkJdGhpcy5faXNPcGVuID0gZmFsc2U7CgoJCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJjbG9zZSIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IHJldmVyc2UgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJCS8vIDIuIFRoZSBzY3JlZW4gb3BhY2l0eSBhbmltYXRpb24gY29tcGxldGVzIChzY3JlZW4oKSkKCQkJdGhpcy5fY3JlYXRlUHJlcmVxcygKCQkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFTY3JlZW4iICksCgkJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxQ29udGFpbmVyIiApLAoJCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXNEb25lIiApICk7CgoJCQl0aGlzLl9hbmltYXRlKCB7CgkJCQlhZGRpdGlvbmFsQ29uZGl0aW9uOiB0aGlzLl91aS5zY3JlZW4uaGFzQ2xhc3MoICJpbiIgKSwKCQkJCXRyYW5zaXRpb246ICggaW1tZWRpYXRlID8gIm5vbmUiIDogKCB0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApICksCgkJCQljbGFzc1RvUmVtb3ZlOiAiaW4iLAoJCQkJc2NyZWVuQ2xhc3NUb0FkZDogIm91dCIsCgkJCQljb250YWluZXJDbGFzc1RvQWRkOiAicmV2ZXJzZSBvdXQiLAoJCQkJYXBwbHlUcmFuc2l0aW9uOiB0cnVlLAoJCQkJcHJlcmVxczogdGhpcy5fcHJlcmVxcwoJCQl9KTsKCQl9LAoKCQlfdW5lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQkJLy8gUHV0IHRoZSBlbGVtZW50IGJhY2sgdG8gd2hlcmUgdGhlIHBsYWNlaG9sZGVyIHdhcyBhbmQgcmVtb3ZlIHRoZSAidWktcG9wdXAiIGNsYXNzCgkJCXRoaXMuX3NldFRoZW1lKCAibm9uZSIgKTsKCQkJdGhpcy5lbGVtZW50CgkJCQkvLyBDYW5ub3QgZGlyZWN0bHkgaW5zZXJ0QWZ0ZXIoKSAtIHdlIG5lZWQgdG8gZGV0YWNoKCkgZmlyc3QsIGJlY2F1c2UKCQkJCS8vIGluc2VydEFmdGVyKCkgd2lsbCBkbyBub3RoaW5nIGlmIHRoZSBwYXlsb2FkIGRpdiB3YXMgbm90IGF0dGFjaGVkCgkJCQkvLyB0byB0aGUgRE9NIGF0IHRoZSB0aW1lIHRoZSB3aWRnZXQgd2FzIGNyZWF0ZWQsIGFuZCBzbyB0aGUgcGF5bG9hZAoJCQkJLy8gd2lsbCByZW1haW4gaW5zaWRlIHRoZSBjb250YWluZXIgZXZlbiBhZnRlciB3ZSBjYWxsIGluc2VydEFmdGVyKCkuCgkJCQkvLyBJZiB0aGF0IGhhcHBlbnMgYW5kIHdlIHJlbW92ZSB0aGUgY29udGFpbmVyIGEgZmV3IGxpbmVzIGJlbG93LCB3ZQoJCQkJLy8gd2lsbCBjYXVzZSBhbiBpbmZpbml0ZSByZWN1cnNpb24gLSAjNTI0NAoJCQkJLmRldGFjaCgpCgkJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuX3VpLnBsYWNlaG9sZGVyICkKCQkJCS5yZW1vdmVDbGFzcyggInVpLXBvcHVwIHVpLW92ZXJsYXktc2hhZG93IHVpLWNvcm5lci1hbGwiICk7CgkJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmUoKTsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZSgpOwoJCQl0aGlzLl91aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlID09PSB0aGlzICkgewoJCQkJdGhpcy5lbGVtZW50Lm9uZSggInBvcHVwYWZ0ZXJjbG9zZSIsICQucHJveHkoIHRoaXMsICJfdW5lbmhhbmNlIiApICk7CgkJCQl0aGlzLmNsb3NlKCk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl91bmVuaGFuY2UoKTsKCQkJfQoJCX0sCgoJCV9jbG9zZVBvcHVwOiBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQkJdmFyIHBhcnNlZERzdCwgdG9VcmwsIG8gPSB0aGlzLm9wdGlvbnMsIGltbWVkaWF0ZSA9IGZhbHNlOwoKCQkJLy8gcmVzdG9yZSBsb2NhdGlvbiBvbiBzY3JlZW4KCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLl9zY3JvbGxUb3AgKTsKCgkJCWlmICggZSAmJiBlLnR5cGUgPT09ICJwYWdlYmVmb3JlY2hhbmdlIiAmJiBkYXRhICkgewoJCQkJLy8gRGV0ZXJtaW5lIHdoZXRoZXIgd2UgbmVlZCB0byByYXBpZC1jbG9zZSB0aGUgcG9wdXAsIG9yIHdoZXRoZXIgd2UgY2FuCgkJCQkvLyB0YWtlIHRoZSB0aW1lIHRvIHJ1biB0aGUgY2xvc2luZyB0cmFuc2l0aW9uCgkJCQlpZiAoIHR5cGVvZiBkYXRhLnRvUGFnZSA9PT0gInN0cmluZyIgKSB7CgkJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2U7CgkJCQl9IGVsc2UgewoJCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQl9CgkJCQlwYXJzZWREc3QgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCBwYXJzZWREc3QgKTsKCQkJCXRvVXJsID0gcGFyc2VkRHN0LnBhdGhuYW1lICsgcGFyc2VkRHN0LnNlYXJjaCArIHBhcnNlZERzdC5oYXNoOwoKCQkJCWlmICggdGhpcy5fbXlVcmwgIT09ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB0b1VybCApICkgewoJCQkJCS8vIEdvaW5nIHRvIGEgZGlmZmVyZW50IHBhZ2UgLSBjbG9zZSBpbW1lZGlhdGVseQoJCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVtb3ZlIG5hdiBiaW5kaW5ncwoJCQlvLmNvbnRhaW5lci51bmJpbmQoIG8uY2xvc2VFdmVudHMgKTsKCQkJLy8gdW5iaW5kIGNsaWNrIGhhbmRsZXJzIGFkZGVkIHdoZW4gaGlzdG9yeSBpcyBkaXNhYmxlZAoJCQl0aGlzLmVsZW1lbnQudW5kZWxlZ2F0ZSggby5jbG9zZUxpbmtTZWxlY3Rvciwgby5jbG9zZUxpbmtFdmVudHMgKTsKCgkJCXRoaXMuX2Nsb3NlKCBpbW1lZGlhdGUgKTsKCQl9LAoKCQkvLyBhbnkgbmF2aWdhdGlvbiBldmVudCBhZnRlciBhIHBvcHVwIGlzIG9wZW5lZCBzaG91bGQgY2xvc2UgdGhlIHBvcHVwCgkJLy8gTk9URSB0aGUgcGFnZWJlZm9yZWNoYW5nZSBpcyBib3VuZCB0byBjYXRjaCBuYXZpZ2F0aW9uIGV2ZW50cyB0aGF0IGRvbid0CgkJLy8gICAgICBhbHRlciB0aGUgdXJsIChlZywgZGlhbG9ncyBmcm9tIHBvcHVwcykKCQlfYmluZENvbnRhaW5lckNsb3NlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5vcHRpb25zLmNvbnRhaW5lcgoJCQkJLm9uZSggdGhpcy5vcHRpb25zLmNsb3NlRXZlbnRzLCAkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUG9wdXAiICkgKTsKCQl9LAoKCQkvLyBUT0RPIG5vIGNsZWFyIGRlbGluaWF0aW9uIG9mIHdoYXQgc2hvdWxkIGJlIGhlcmUgYW5kCgkJLy8gd2hhdCBzaG91bGQgYmUgaW4gX29wZW4uIFNlZW1zIHRvIGJlICJ2aXN1YWwiIHZzICJoaXN0b3J5IiBmb3Igbm93CgkJb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXZhciBzZWxmID0gdGhpcywgb3B0cyA9IHRoaXMub3B0aW9ucywgdXJsLCBoYXNoa2V5LCBhY3RpdmVQYWdlLCBjdXJyZW50SXNEaWFsb2csIGhhc0hhc2gsIHVybEhpc3Rvcnk7CgoJCQkvLyBtYWtlIHN1cmUgb3BlbiBpcyBpZGVtcG90ZW50CgkJCWlmKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHNldCB0aGUgZ2xvYmFsIHBvcHVwIG11dGV4CgkJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHRoaXM7CgkJCXRoaXMuX3Njcm9sbFRvcCA9ICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKTsKCgkJCS8vIGlmIGhpc3RvcnkgYWx0ZXJhdGlvbiBpcyBkaXNhYmxlZCBjbG9zZSBvbiBuYXZpZ2F0ZSBldmVudHMKCQkJLy8gYW5kIGxlYXZlIHRoZSB1cmwgYXMgaXMKCQkJaWYoICEoIG9wdHMuaGlzdG9yeSApICkgewoJCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgoJCQkJLy8gV2hlbiBoaXN0b3kgaXMgZGlzYWJsZWQgd2UgaGF2ZSB0byBncmFiIHRoZSBkYXRhLXJlbAoJCQkJLy8gYmFjayBsaW5rIGNsaWNrcyBzbyB3ZSBjYW4gY2xvc2UgdGhlIHBvcHVwIGluc3RlYWQgb2YKCQkJCS8vIHJlbHlpbmcgb24gaGlzdG9yeSB0byBkbyBpdCBmb3IgdXMKCQkJCXNlbGYuZWxlbWVudAoJCQkJCS5kZWxlZ2F0ZSggb3B0cy5jbG9zZUxpbmtTZWxlY3Rvciwgb3B0cy5jbG9zZUxpbmtFdmVudHMsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQl9KTsKCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIGNhY2hlIHNvbWUgdmFsdWVzIGZvciBtaW4vcmVhZGFiaWxpdHkKCQkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLnVybEhpc3Rvcnk7CgkJCWhhc2hrZXkgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCQlhY3RpdmVQYWdlID0gJC5tb2JpbGUuYWN0aXZlUGFnZTsKCQkJY3VycmVudElzRGlhbG9nID0gYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICk7CgkJCXRoaXMuX215VXJsID0gdXJsID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS51cmw7CgkJCWhhc0hhc2ggPSAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPiAtMSApICYmICFjdXJyZW50SXNEaWFsb2cgJiYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApOwoKCQkJaWYgKCBoYXNIYXNoICkgewoJCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIGlmIHRoZSBjdXJyZW50IHVybCBoYXMgbm8gZGlhbG9nIGhhc2gga2V5IHByb2NlZWQgYXMgbm9ybWFsCgkJCS8vIG90aGVyd2lzZSwgaWYgdGhlIHBhZ2UgaXMgYSBkaWFsb2cgc2ltcGx5IHRhY2sgb24gdGhlIGhhc2gga2V5CgkJCWlmICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA9PT0gLTEgJiYgIWN1cnJlbnRJc0RpYWxvZyApewoJCQkJdXJsID0gdXJsICsgKHVybC5pbmRleE9mKCAiIyIgKSA+IC0xID8gaGFzaGtleSA6ICIjIiArIGhhc2hrZXkpOwoJCQl9IGVsc2UgewoJCQkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCArIGhhc2hrZXk7CgkJCX0KCgkJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCQl1cmwgKz0gaGFzaGtleTsKCQkJfQoKCQkJLy8gc3dhbGxvdyB0aGUgdGhlIGluaXRpYWwgbmF2aWdhdGlvbiBldmVudCwgYW5kIGJpbmQgZm9yIHRoZSBuZXh0CgkJCSQod2luZG93KS5vbmUoICJiZWZvcmVuYXZpZ2F0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJCX0pOwoKCQkJdGhpcy51cmxBbHRlcmVkID0gdHJ1ZTsKCQkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwge3JvbGU6ICJkaWFsb2cifSApOwoJCX0sCgoJCWNsb3NlOiBmdW5jdGlvbigpIHsKCQkJLy8gbWFrZSBzdXJlIGNsb3NlIGlzIGlkZW1wb3RlbnQKCQkJaWYoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdGhpcy5fc2Nyb2xsVG9wID0gJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpOwoKCQkJaWYoIHRoaXMub3B0aW9ucy5oaXN0b3J5ICYmIHRoaXMudXJsQWx0ZXJlZCApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCXRoaXMudXJsQWx0ZXJlZCA9IGZhbHNlOwoJCQl9IGVsc2UgewoJCQkJLy8gc2ltdWxhdGUgdGhlIG5hdiBiaW5kaW5ncyBoYXZpbmcgZmlyZWQKCQkJCXRoaXMuX2Nsb3NlUG9wdXAoKTsKCQkJfQoJCX0KCX0pOwoKCgkvLyBUT0RPIHRoaXMgY2FuIGJlIG1vdmVkIGluc2lkZSB0aGUgd2lkZ2V0CgkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rID0gZnVuY3Rpb24oICRsaW5rICkgewoJCXZhciBjbG9zZXN0UGFnZSA9ICRsaW5rLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICksCgkJCXNjb3BlID0gKCAoIGNsb3Nlc3RQYWdlLmxlbmd0aCA9PT0gMCApID8gJCggImJvZHkiICkgOiBjbG9zZXN0UGFnZSApLAoJCQkvLyBOT1RFIG1ha2Ugc3VyZSB0byBnZXQgb25seSB0aGUgaGFzaCwgaWU3ICh3cDcpIHJldHVybiB0aGUgYWJzb2x1dGUgaHJlZgoJCQkvLyAgICAgIGluIHRoaXMgY2FzZSBydWluaW5nIHRoZSBlbGVtZW50IHNlbGVjdGlvbgoJCQlwb3B1cCA9ICQoICQubW9iaWxlLnBhdGgucGFyc2VVcmwoJGxpbmsuYXR0ciggImhyZWYiICkpLmhhc2gsIHNjb3BlWzBdICksCgkJCW9mZnNldDsKCgkJaWYgKCBwb3B1cC5kYXRhKCAibW9iaWxlLXBvcHVwIiApICkgewoJCQlvZmZzZXQgPSAkbGluay5vZmZzZXQoKTsKCQkJcG9wdXAucG9wdXAoICJvcGVuIiwgewoJCQkJeDogb2Zmc2V0LmxlZnQgKyAkbGluay5vdXRlcldpZHRoKCkgLyAyLAoJCQkJeTogb2Zmc2V0LnRvcCArICRsaW5rLm91dGVySGVpZ2h0KCkgLyAyLAoJCQkJdHJhbnNpdGlvbjogJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlwb3NpdGlvblRvOiAkbGluay5qcW1EYXRhKCAicG9zaXRpb24tdG8iICkKCQkJfSk7CgkJfQoKCQkvL3JlbW92ZSBhZnRlciBkZWxheQoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkvLyBDaGVjayBpZiB3ZSBhcmUgaW4gYSBsaXN0dmlldwoJCQl2YXIgJHBhcmVudCA9ICRsaW5rLnBhcmVudCgpLnBhcmVudCgpOwoJCQlpZiAoJHBhcmVudC5oYXNDbGFzcygidWktbGkiKSkgewoJCQkJJGxpbmsgPSAkcGFyZW50LnBhcmVudCgpOwoJCQl9CgkJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0sIDMwMCApOwoJfTsKCgkvLyBUT0RPIG1vdmUgaW5zaWRlIF9jcmVhdGUKCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlYmVmb3JlY2hhbmdlIiwgZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayggZGF0YS5vcHRpb25zLmxpbmsgKTsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0pOwoKCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgIHsKCQkkLm1vYmlsZS5wb3B1cC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKCX0pOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgZXh0ZW5kU2VsZWN0ID0gZnVuY3Rpb24oIHdpZGdldCApIHsKCgkJdmFyIHNlbGVjdCA9IHdpZGdldC5zZWxlY3QsCgkJCW9yaWdEZXN0cm95ID0gd2lkZ2V0Ll9kZXN0cm95LAoJCQlzZWxlY3RJRCAgPSB3aWRnZXQuc2VsZWN0SUQsCgkJCXByZWZpeCA9ICggc2VsZWN0SUQgPyBzZWxlY3RJRCA6ICggKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInV1aWQtIiArIHdpZGdldC51dWlkICkgKSwKCQkJcG9wdXBJRCA9IHByZWZpeCArICItbGlzdGJveCIsCgkJCWRpYWxvZ0lEID0gcHJlZml4ICsgIi1kaWFsb2ciLAoJCQlsYWJlbCA9IHdpZGdldC5sYWJlbCwKCQkJdGhpc1BhZ2UgPSB3aWRnZXQuc2VsZWN0LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJc2VsZWN0T3B0aW9ucyA9IHdpZGdldC5fc2VsZWN0T3B0aW9ucygpLAoJCQlpc011bHRpcGxlID0gd2lkZ2V0LmlzTXVsdGlwbGUgPSB3aWRnZXQuc2VsZWN0WyAwIF0ubXVsdGlwbGUsCgkJCWJ1dHRvbklkID0gc2VsZWN0SUQgKyAiLWJ1dHRvbiIsCgkJCW1lbnVJZCA9IHNlbGVjdElEICsgIi1tZW51IiwKCQkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGlkPSciICsgZGlhbG9nSUQgKyAiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgInRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy50aGVtZSArIicgZGF0YS0iICskLm1vYmlsZS5ucyArICJvdmVybGF5LXRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgKyInPiIgKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0naGVhZGVyJz4iICsKCQkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJCSI8L2Rpdj4iKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+IisKCQkJCSI8L2Rpdj4iICksCgoJCQlsaXN0Ym94ID0gICQoICI8ZGl2IGlkPSciICsgcG9wdXBJRCArICInIGNsYXNzPSd1aS1zZWxlY3RtZW51Jz4iICkuaW5zZXJ0QWZ0ZXIoIHdpZGdldC5zZWxlY3QgKS5wb3B1cCggeyB0aGVtZTogd2lkZ2V0Lm9wdGlvbnMub3ZlcmxheVRoZW1lIH0gKSwKCgkJCWxpc3QgPSAkKCAiPHVsPiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS1zZWxlY3RtZW51LWxpc3QiLAoJCQkJImlkIjogbWVudUlkLAoJCQkJInJvbGUiOiAibGlzdGJveCIsCgkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogYnV0dG9uSWQKCQkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIsIHdpZGdldC5vcHRpb25zLnRoZW1lICkKCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImRpdmlkZXItdGhlbWUiLCB3aWRnZXQub3B0aW9ucy5kaXZpZGVyVGhlbWUgKQoJCQkJCS5hcHBlbmRUbyggbGlzdGJveCApLAoKCgkJCWhlYWRlciA9ICQoICI8ZGl2PiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS1oZWFkZXIgdWktYmFyLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZQoJCQl9KS5wcmVwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlclRpdGxlID0gJCggIjxoMT4iLCB7CgkJCQkiY2xhc3MiOiAidWktdGl0bGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKSwKCgkJCW1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZSwKCQkJaGVhZGVyQ2xvc2U7CgoJCWlmICggd2lkZ2V0LmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJ0ZXh0Ijogd2lkZ2V0Lm9wdGlvbnMuY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuLWxlZnQiCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiwgIm5vdGV4dCIgKS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbiIsICJkZWxldGUiICkuYXBwZW5kVG8oIGhlYWRlciApLmJ1dHRvbk1hcmt1cCgpOwoJCX0KCgkJJC5leHRlbmQoIHdpZGdldCwgewoJCQlzZWxlY3Q6IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEOiBzZWxlY3RJRCwKCQkJYnV0dG9uSWQ6IGJ1dHRvbklkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJcG9wdXBJRDogcG9wdXBJRCwKCQkJZGlhbG9nSUQ6IGRpYWxvZ0lELAoJCQl0aGlzUGFnZTogdGhpc1BhZ2UsCgkJCW1lbnVQYWdlOiBtZW51UGFnZSwKCQkJbGFiZWw6IGxhYmVsLAoJCQlzZWxlY3RPcHRpb25zOiBzZWxlY3RPcHRpb25zLAoJCQlpc011bHRpcGxlOiBpc011bHRpcGxlLAoJCQl0aGVtZTogd2lkZ2V0Lm9wdGlvbnMudGhlbWUsCgkJCWxpc3Rib3g6IGxpc3Rib3gsCgkJCWxpc3Q6IGxpc3QsCgkJCWhlYWRlcjogaGVhZGVyLAoJCQloZWFkZXJUaXRsZTogaGVhZGVyVGl0bGUsCgkJCWhlYWRlckNsb3NlOiBoZWFkZXJDbG9zZSwKCQkJbWVudVBhZ2VDb250ZW50OiBtZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2U6IG1lbnVQYWdlQ2xvc2UsCgkJCXBsYWNlaG9sZGVyOiAiIiwKCgkJCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpczsKCgkJCQkvLyBDcmVhdGUgbGlzdCBmcm9tIHNlbGVjdCwgdXBkYXRlIHN0YXRlCgkJCQlzZWxmLnJlZnJlc2goKTsKCgkJCQlpZiAoIHNlbGYuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCS8vIE1hcCB1bmRlZmluZWQgdG8gZmFsc2UsIGJlY2F1c2Ugc2VsZi5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQKCQkJCQkvLyBpbmRpY2F0ZXMgdGhhdCB3ZSBoYXZlIG5vdCB5ZXQgY2hlY2tlZCB3aGV0aGVyIHRoZSBzZWxlY3QgaGFzCgkJCQkJLy8gb3JpZ2luYWxseSBoYWQgYSB0YWJpbmRleCBhdHRyaWJ1dGUsIHdoZXJlYXMgZmFsc2UgaW5kaWNhdGVzIHRoYXQKCQkJCQkvLyB3ZSBoYXZlIGNoZWNrZWQgdGhlIHNlbGVjdCBmb3Igc3VjaCBhbiBhdHRyaWJ1dGUsIGFuZCBoYXZlIGZvdW5kCgkJCQkJLy8gbm9uZSBwcmVzZW50LgoJCQkJCXNlbGYuX29yaWdUYWJJbmRleCA9ICggc2VsZi5zZWxlY3RbIDAgXS5nZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIgKSA9PT0gbnVsbCApID8gZmFsc2UgOiBzZWxmLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiICk7CgkJCQl9CgkJCQlzZWxmLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmJsdXIoKTsKCQkJCQlzZWxmLmJ1dHRvbi5mb2N1cygpOwoJCQkJfSk7CgoJCQkJLy8gQnV0dG9uIGV2ZW50cwoJCQkJc2VsZi5idXR0b24uYmluZCggInZjbGljayBrZXlkb3duIiAsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCB8fCBzZWxmLmlzT3BlbiApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8CgkJCQkJCQkJCQkJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFKSkgewoKCQkJCQkJc2VsZi5fZGVjaWRlRm9ybWF0KCk7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyBzZWxmLnBvcHVwSUQgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJwb3B1cCIgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXNlbGYuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgc2VsZi5kaWFsb2dJRCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgImRpYWxvZyIgKTsKCQkJCQkJfQoJCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQkJCS8vIERvIG5vdCBwcmV2ZW50IGRlZmF1bHQsIHNvIHRoZSBuYXZpZ2F0aW9uIG1heSBoYXZlIGEgY2hhbmNlIHRvIGFjdHVhbGx5IG9wZW4gdGhlIGNob3NlbiBmb3JtYXQKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQkJCXNlbGYubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApCgkJCQkJLmJpbmQoICJmb2N1c2luIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkJCQkJLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoKCQkJCQl9KQoJCQkJCS5iaW5kKCAiZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJJCggZS50YXJnZXQgKQoJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKQoJCQkJCQkJLnRyaWdnZXIoICJ2bW91c2VvdXQiICk7CgkJCQkJfSkKCQkJCQkuZGVsZWdhdGUoICJsaTpub3QoLnVpLWRpc2FibGVkLCAudWktbGktZGl2aWRlcikiLCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJCQkvLyBpbmRleCBvZiBvcHRpb24gdGFnIHRvIGJlIHNlbGVjdGVkCgkJCQkJCXZhciBvbGRJbmRleCA9IHNlbGYuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCQkJCQkJCW5ld0luZGV4ID0gc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmluZGV4KCB0aGlzICksCgkJCQkJCQlvcHRpb24gPSBzZWxmLl9zZWxlY3RPcHRpb25zKCkuZXEoIG5ld0luZGV4IClbIDAgXTsKCgkJCQkJCS8vIHRvZ2dsZSBzZWxlY3RlZCBzdGF0dXMgb24gdGhlIHRhZyBmb3IgbXVsdGkgc2VsZWN0cwoJCQkJCQlvcHRpb24uc2VsZWN0ZWQgPSBzZWxmLmlzTXVsdGlwbGUgPyAhb3B0aW9uLnNlbGVjdGVkIDogdHJ1ZTsKCgkJCQkJCS8vIHRvZ2dsZSBjaGVja2JveCBjbGFzcyBmb3IgbXVsdGlwbGUgc2VsZWN0cwoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCSQoIHRoaXMgKS5maW5kKCAiLnVpLWljb24iICkKCQkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiwgb3B0aW9uLnNlbGVjdGVkICkKCQkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9mZiIsICFvcHRpb24uc2VsZWN0ZWQgKTsKCQkJCQkJfQoKCQkJCQkJLy8gdHJpZ2dlciBjaGFuZ2UgaWYgdmFsdWUgY2hhbmdlZAoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSB8fCBvbGRJbmRleCAhPT0gbmV3SW5kZXggKSB7CgkJCQkJCQlzZWxmLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCQl9CgoJCQkJCQkvLyBoaWRlIGN1c3RvbSBzZWxlY3QgZm9yIHNpbmdsZSBzZWxlY3RzIG9ubHkgLSBvdGhlcndpc2UgZm9jdXMgY2xpY2tlZCBpdGVtCgkJCQkJCS8vIFdlIG5lZWQgdG8gZ3JhYiB0aGUgY2xpY2tlZCBpdGVtIHRoZSBoYXJkIHdheSwgYmVjYXVzZSB0aGUgbGlzdCBtYXkgaGF2ZSBiZWVuIHJlYnVpbHQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuZXEoIG5ld0luZGV4ICkKCQkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCX0KCgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfSkKCQkJCQkua2V5ZG93bihmdW5jdGlvbiggZXZlbnQgKSB7ICAvL2tleWJvYXJkIGV2ZW50cyBmb3IgbWVudSBpdGVtcwoJCQkJCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCQkJCQlsaSA9IHRhcmdldC5jbG9zZXN0KCAibGkiICksCgkJCQkJCQlwcmV2LCBuZXh0OwoKCQkJCQkJLy8gc3dpdGNoIGxvZ2ljIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCQkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCQkJLy8gdXAgb3IgbGVmdCBhcnJvdyBrZXlzCgkJCQkJCWNhc2UgMzg6CgkJCQkJCQlwcmV2ID0gbGkucHJldigpLm5vdCggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoKCQkJCQkJCWlmICggcHJldi5pcyggIi51aS1saS1kaXZpZGVyIiApICkgewoJCQkJCQkJCXByZXYgPSBwcmV2LnByZXYoKTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgcHJldmlvdXMgb3B0aW9uLCBmb2N1cyBpdAoJCQkJCQkJaWYgKCBwcmV2Lmxlbmd0aCApIHsKCQkJCQkJCQl0YXJnZXQKCQkJCQkJCQkJLmJsdXIoKQoJCQkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJCQkJCQlwcmV2LmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCQkJCQljYXNlIDQwOgoJCQkJCQkJbmV4dCA9IGxpLm5leHQoKTsKCgkJCQkJCQlpZiAoIG5leHQuaXMoICIudWktbGktZGl2aWRlciIgKSApIHsKCQkJCQkJCQluZXh0ID0gbmV4dC5uZXh0KCk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIG5leHQgb3B0aW9uLCBmb2N1cyBpdAoJCQkJCQkJaWYgKCBuZXh0Lmxlbmd0aCApIHsKCQkJCQkJCQl0YXJnZXQKCQkJCQkJCQkJLmJsdXIoKQoJCQkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJCQkJCQluZXh0LmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQkJCQkJY2FzZSAxMzoKCQkJCQkJY2FzZSAzMjoKCQkJCQkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgoJCQkJLy8gYnV0dG9uIHJlZm9jdXMgZW5zdXJlcyBwcm9wZXIgaGVpZ2h0IGNhbGN1bGF0aW9uCgkJCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCQkJc2VsZi5tZW51UGFnZS5iaW5kKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJCQkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCQkJCS8vCgkJCQkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkJCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkJCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJCQkJLy8KCQkJCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkJCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCQkJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkJCQkvLwoJCQkJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCQkJCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZS5jYWxsKCBzZWxmLnRoaXNQYWdlICk7CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJCQlzZWxmLmxpc3Rib3guYmluZCggInBvcHVwYWZ0ZXJjbG9zZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCgkJCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYuaGVhZGVyQ2xvc2UuY2xpY2soZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gdHJhY2sgdGhpcyBkZXBlbmRlbmN5IHNvIHRoYXQgd2hlbiB0aGUgcGFyZW50IHBhZ2UKCQkJCS8vIGlzIHJlbW92ZWQgb24gcGFnZWhpZGUgaXQgd2lsbCBhbHNvIHJlbW92ZSB0aGUgbWVudXBhZ2UKCQkJCXNlbGYudGhpc1BhZ2UuYWRkRGVwZW5kZW50cyggdGhpcy5tZW51UGFnZSApOwoJCQl9LAoKCQkJX2lzUmVidWlsZFJlcXVpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBsaXN0ID0gdGhpcy5saXN0LmZpbmQoICJsaSIgKSwKCQkJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoKCQkJCS8vIFRPRE8gZXhjZWVkaW5nbHkgbmFpdmUgbWV0aG9kIHRvIGRldGVybWluZSBkaWZmZXJlbmNlCgkJCQkvLyBpZ25vcmVzIHZhbHVlIGNoYW5nZXMgZXRjIGluIGZhdm9yIG9mIGEgZm9yY2VkUmVidWlsZAoJCQkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQkJCXJldHVybiBvcHRpb25zLnRleHQoKSAhPT0gbGlzdC50ZXh0KCk7CgkJCX0sCgoJCQlzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZDpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSIgKTsKCQkJfSwKCgkJCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZVJlYnVpbGQgLCBmb28gKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlzZWxlY3QgPSB0aGlzLmVsZW1lbnQsCgkJCQlpc011bHRpcGxlID0gdGhpcy5pc011bHRpcGxlLAoJCQkJaW5kaWNpZXM7CgoJCQkJaWYgKCAgZm9yY2VSZWJ1aWxkIHx8IHRoaXMuX2lzUmVidWlsZFJlcXVpcmVkKCkgKSB7CgkJCQkJc2VsZi5fYnVpbGRMaXN0KCk7CgkJCQl9CgoJCQkJaW5kaWNpZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQkJCXNlbGYuc2V0QnV0dG9uVGV4dCgpOwoJCQkJc2VsZi5zZXRCdXR0b25Db3VudCgpOwoKCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKQoJCQkJCS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIGZhbHNlICkKCQkJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQkJCWlmICggJC5pbkFycmF5KCBpLCBpbmRpY2llcyApID4gLTEgKSB7CgkJCQkJCQl2YXIgaXRlbSA9ICQoIHRoaXMgKTsKCgkJCQkJCQkvLyBBcmlhIHNlbGVjdGVkIGF0dHIKCQkJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCQkJLy8gTXVsdGlwbGUgc2VsZWN0czogYWRkIHRoZSAib24iIGNoZWNrYm94IHN0YXRlIHRvIHRoZSBpY29uCgkJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCQlpdGVtLmZpbmQoICIudWktaWNvbiIgKS5yZW1vdmVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKCBpdGVtLmlzKCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICkgKSB7CgkJCQkJCQkJCWl0ZW0ubmV4dCgpLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCWl0ZW0uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCX0sCgoJCQljbG9zZTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhdGhpcy5pc09wZW4gKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpczsKCgkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJwYWdlIiApIHsKCQkJCQlzZWxmLm1lbnVQYWdlLmRpYWxvZyggImNsb3NlIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCQkJfQoKCQkJCXNlbGYuX2ZvY3VzQnV0dG9uKCk7CgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5idXR0b24uY2xpY2soKTsKCQkJfSwKCgkJCV9kZWNpZGVGb3JtYXQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3csCgkJCQkJc2VsZkxpc3RQYXJlbnQgPSBzZWxmLmxpc3QucGFyZW50KCksCgkJCQkJbWVudUhlaWdodCA9IHNlbGZMaXN0UGFyZW50Lm91dGVySGVpZ2h0KCksCgkJCQkJbWVudVdpZHRoID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJXaWR0aCgpLAoJCQkJCWFjdGl2ZVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJCQlzY3JlZW5IZWlnaHQgPSAkd2luZG93LmhlaWdodCgpLAoJCQkJCXNjcmVlbldpZHRoID0gJHdpbmRvdy53aWR0aCgpOwoKCQkJCWZ1bmN0aW9uIGZvY3VzTWVudUl0ZW0oKSB7CgkJCQkJdmFyIHNlbGVjdG9yID0gc2VsZi5saXN0LmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiBhIiApOwoJCQkJCWlmICggc2VsZWN0b3IubGVuZ3RoID09PSAwICkgewoJCQkJCQlzZWxlY3RvciA9IHNlbGYubGlzdC5maW5kKCAibGkudWktYnRuOm5vdCggOmpxbURhdGEocGxhY2Vob2xkZXI9J3RydWUnKSApIGEiICk7CgkJCQkJfQoJCQkJCXNlbGVjdG9yLmZpcnN0KCkuZm9jdXMoKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKTsKCQkJCX0KCgkJCQlpZiAoIG1lbnVIZWlnaHQgPiBzY3JlZW5IZWlnaHQgLSA4MCB8fCAhJC5zdXBwb3J0LnNjcm9sbFRvcCApIHsKCgkJCQkJc2VsZi5tZW51UGFnZS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApLnBhZ2UoKTsKCQkJCQlzZWxmLm1lbnVQYWdlQ29udGVudCA9IG1lbnVQYWdlLmZpbmQoICIudWktY29udGVudCIgKTsKCQkJCQlzZWxmLm1lbnVQYWdlQ2xvc2UgPSBtZW51UGFnZS5maW5kKCAiLnVpLWhlYWRlciBhIiApOwoKCQkJCQkvLyBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgRE9NLAoJCQkJCS8vIG90aGVyd2lzZSB0aGUgcmVzdWx0cyBvZiBzZWxlY3RpbmcgYSBsaXN0IGl0ZW0gaW4gdGhlIGRpYWxvZwoJCQkJCS8vIGZhbGwgaW50byBhIGJsYWNrIGhvbGUKCQkJCQlzZWxmLnRoaXNQYWdlLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKTsKCgkJCQkJLy9mb3IgV2ViT1MvT3BlcmEgTWluaSAoc2V0IGxhc3RzY3JvbGwgdXNpbmcgYnV0dG9uIG9mZnNldCkKCQkJCQlpZiAoIHNjcm9sbFRvcCA9PT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCXNlbGYubWVudVBhZ2UKCQkJCQkJLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCQlmb2N1c01lbnVJdGVtKCk7CgkJCQkJCX0pCgkJCQkJCS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9KTsKCgkJCQkJc2VsZi5tZW51VHlwZSA9ICJwYWdlIjsKCQkJCQlzZWxmLm1lbnVQYWdlQ29udGVudC5hcHBlbmQoIHNlbGYubGlzdCApOwoJCQkJCXNlbGYubWVudVBhZ2UuZmluZCgiZGl2IC51aS10aXRsZSIpLnRleHQoc2VsZi5sYWJlbC50ZXh0KCkpOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJCQlzZWxmLmxpc3Rib3gub25lKCAicG9wdXBhZnRlcm9wZW4iLCBmb2N1c01lbnVJdGVtICk7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQkJCW9wdGdyb3VwcyA9IFtdLAoJCQkJCWxpcyA9IFtdLAoJCQkJCWRhdGFJY29uID0gc2VsZi5pc011bHRpcGxlID8gImNoZWNrYm94LW9mZiIgOiAiZmFsc2UiOwoKCQkJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgoJCQkJdmFyICRvcHRpb25zID0gc2VsZi5zZWxlY3QuZmluZCggIm9wdGlvbiIgKSwKCQkJCQludW1PcHRpb25zID0gJG9wdGlvbnMubGVuZ3RoLAoJCQkJCXNlbGVjdCA9IHRoaXMuc2VsZWN0WyAwIF0sCgkJCQkJZGF0YVByZWZpeCA9ICdkYXRhLScgKyAkLm1vYmlsZS5ucywKCQkJCQlkYXRhSW5kZXhBdHRyID0gZGF0YVByZWZpeCArICdvcHRpb24taW5kZXgnLAoJCQkJCWRhdGFJY29uQXR0ciA9IGRhdGFQcmVmaXggKyAnaWNvbicsCgkJCQkJZGF0YVJvbGVBdHRyID0gZGF0YVByZWZpeCArICdyb2xlJywKCQkJCQlkYXRhUGxhY2Vob2xkZXJBdHRyID0gZGF0YVByZWZpeCArICdwbGFjZWhvbGRlcicsCgkJCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSwKCQkJCQlvcHRHcm91cDsKCgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IG51bU9wdGlvbnM7aSsrLCBpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlKSB7CgkJCQkJdmFyIG9wdGlvbiA9ICRvcHRpb25zW2ldLAoJCQkJCQkkb3B0aW9uID0gJCggb3B0aW9uICksCgkJCQkJCXBhcmVudCA9IG9wdGlvbi5wYXJlbnROb2RlLAoJCQkJCQl0ZXh0ID0gJG9wdGlvbi50ZXh0KCksCgkJCQkJCWFuY2hvciAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnYScgKSwKCQkJCQkJY2xhc3NlcyA9IFtdOwoKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAnaHJlZicsICcjJyApOwoJCQkJCWFuY2hvci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSApOwoKCQkJCQkvLyBBcmUgd2UgaW5zaWRlIGFuIG9wdGdyb3VwPwoJCQkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQkJCXZhciBvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICdsYWJlbCcgKTsKCQkJCQkJaWYgKCBvcHRMYWJlbCAhPT0gb3B0R3JvdXAgKSB7CgkJCQkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdsaScgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCBkYXRhUm9sZUF0dHIsICdsaXN0LWRpdmlkZXInICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ3JvbGUnLCAnb3B0aW9uJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICd0YWJpbmRleCcsICctMScgKTsKCQkJCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRMYWJlbCApICk7CgkJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCQkJb3B0R3JvdXAgPSBvcHRMYWJlbDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKCBuZWVkUGxhY2Vob2xkZXIgJiYgKCAhb3B0aW9uLmdldEF0dHJpYnV0ZSggInZhbHVlIiApIHx8IHRleHQubGVuZ3RoID09PSAwIHx8ICRvcHRpb24uanFtRGF0YSggInBsYWNlaG9sZGVyIiApICkgKSB7CgkJCQkJCW5lZWRQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJCQkvLyBJZiB3ZSBoYXZlIGlkZW50aWZpZWQgYSBwbGFjZWhvbGRlciwgcmVjb3JkIHRoZSBmYWN0IHRoYXQgaXQgd2FzCgkJCQkJCS8vIHVzIHdobyBoYXZlIGFkZGVkIHRoZSBwbGFjZWhvbGRlciB0byB0aGUgb3B0aW9uIGFuZCBtYXJrIGl0CgkJCQkJCS8vIHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQkJCWlmICggbnVsbCA9PT0gb3B0aW9uLmdldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciApICkgewoJCQkJCQkJdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyID0gdHJ1ZTsKCQkJCQkJfQoJCQkJCQlvcHRpb24uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoJCQkJCQl9CgkJCQkJCWlmICggcGxhY2Vob2xkZXIgIT09IHRleHQgKSB7CgkJCQkJCQlwbGFjZWhvbGRlciA9IHNlbGYucGxhY2Vob2xkZXIgPSB0ZXh0OwoJCQkJCQl9CgkJCQkJfQoKCQkJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7CgkJCQkJaWYgKCBvcHRpb24uZGlzYWJsZWQgKSB7CgkJCQkJCWNsYXNzZXMucHVzaCggInVpLWRpc2FibGVkIiApOwoJCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSgnYXJpYS1kaXNhYmxlZCcsdHJ1ZSk7CgkJCQkJfQoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSW5kZXhBdHRyLGkgKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUljb25BdHRyLCBkYXRhSWNvbiApOwoJCQkJCWlmICggaXNQbGFjZWhvbGRlckl0ZW0gKSB7CgkJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQkJfQoJCQkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCAiICIgKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggJ3JvbGUnLCAnb3B0aW9uJyApOwoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICd0YWJpbmRleCcsICctMScgKTsKCQkJCQlpdGVtLmFwcGVuZENoaWxkKCBhbmNob3IgKTsKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggaXRlbSApOwoJCQkJfQoKCQkJCXNlbGYubGlzdFswXS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCgkJCQkvLyBIaWRlIGhlYWRlciBpZiBpdCdzIG5vdCBhIG11bHRpc2VsZWN0IGFuZCB0aGVyZSdzIG5vIHBsYWNlaG9sZGVyCgkJCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJCQl0aGlzLmhlYWRlci5oaWRlKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCQkJfQoKCQkJCS8vIE5vdyBwb3B1bGF0ZWQsIGNyZWF0ZSBsaXN0dmlldwoJCQkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7CgkJCX0sCgoJCQlfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCAiPGE+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiaWQiOiB0aGlzLmJ1dHRvbklkLAoJCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJhcmlhLW93bnMiOiB0aGlzLm1lbnVJZAoJCQkJfSk7CgkJCX0sCgoJCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgoJCQkJLy8gUmVzdG9yZSB0aGUgdGFiaW5kZXggYXR0cmlidXRlIHRvIGl0cyBvcmlnaW5hbCB2YWx1ZQoJCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gZmFsc2UgKSB7CgkJCQkJCXRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsIHRoaXMuX29yaWdUYWJJbmRleCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMuc2VsZWN0LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIHRoZSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgaWYgd2Ugd2VyZSB0aGUgb25lcyB0byBhZGQgaXQKCQkJCWlmICggdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyICkgewoJCQkJCXRoaXMuX3NlbGVjdE9wdGlvbnMoKS5yZW1vdmVBdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicGxhY2Vob2xkZXIiICk7CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIHRoZSBwb3B1cAoJCQkJdGhpcy5saXN0Ym94LnJlbW92ZSgpOwoKCQkJCS8vIENoYWluIHVwCgkJCQlvcmlnRGVzdHJveS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0KCQl9KTsKCX07CgoJLy8gaXNzdWUgIzM4OTQgLSBjb3JlIGRvZXNuJ3QgdHJpZ2dlciBldmVudHMgb24gZGlzYWJsZWQgZGVsZWdhdGVzCgkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAic2VsZWN0bWVudWJlZm9yZWNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIGV2ZW50LnRhcmdldCApLmRhdGEoICJtb2JpbGUtc2VsZWN0bWVudSIgKTsKCgkJaWYgKCAhc2VsZWN0bWVudVdpZGdldC5vcHRpb25zLm5hdGl2ZU1lbnUgJiYKCQkJCXNlbGVjdG1lbnVXaWRnZXQuZWxlbWVudC5wYXJlbnRzKCAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSIgKS5sZW5ndGggPT09IDAgKSB7CgkJCWV4dGVuZFNlbGVjdCggc2VsZWN0bWVudVdpZGdldCApOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS5jb250cm9sZ3JvdXAiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CgkJb3B0aW9uczogewoJCQlzaGFkb3c6IGZhbHNlLAoJCQljb3JuZXJzOiB0cnVlLAoJCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCQl0eXBlOiAidmVydGljYWwiLAoJCQltaW5pOiBmYWxzZSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQl1aSA9IHsKCQkJCQlpbm5lcjogJCggIjxkaXYgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyc+PC9kaXY+IiApLAoJCQkJCWxlZ2VuZDogJCggIjxkaXYgcm9sZT0naGVhZGluZycgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1sYWJlbCc+PC9kaXY+IiApCgkJCQl9LAoJCQkJZ3JvdXBsZWdlbmQgPSAkZWwuY2hpbGRyZW4oICJsZWdlbmQiICksCgkJCQlzZWxmID0gdGhpczsKCgkJCS8vIEFwcGx5IHRoZSBwcm90bwoJCQkkZWwud3JhcElubmVyKCB1aS5pbm5lciApOwoJCQlpZiAoIGdyb3VwbGVnZW5kLmxlbmd0aCApIHsKCQkJCXVpLmxlZ2VuZC5hcHBlbmQoIGdyb3VwbGVnZW5kICkuaW5zZXJ0QmVmb3JlKCAkZWwuY2hpbGRyZW4oIDAgKSApOwoJCQl9CgkJCSRlbC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktY29udHJvbGdyb3VwIiApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbml0aWFsUmVmcmVzaDogdHJ1ZQoJCQl9KTsKCgkJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCS8vIENhdXNlIGluaXRpYWwgb3B0aW9ucyB0byBiZSBhcHBsaWVkIGJ5IHRoZWlyIGhhbmRsZXIgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyB0aGUgb3B0aW9uIHRvIHVuZGVmaW5lZAoJCQkJLy8gLSB0aGUgaGFuZGxlciB0aGVuIHNldHMgaXQgdG8gdGhlIGluaXRpYWwgdmFsdWUKCQkJCXNlbGYub3B0aW9uc1sga2V5IF0gPSB1bmRlZmluZWQ7CgkJCQlzZWxmLl9zZXRPcHRpb24oIGtleSwgdmFsdWUsIHRydWUgKTsKCQkJfSk7CgkJfSwKCgkJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJdmFyIHNldHRlciA9ICJfc2V0IiArIGtleS5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsga2V5LnNsaWNlKCAxICk7CgoJCQlpZiAoIHRoaXNbIHNldHRlciBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzWyBzZXR0ZXIgXSggdmFsdWUgKTsKCQkJfQoKCQkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRUeXBlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwLWhvcml6b250YWwgdWktY29udHJvbGdyb3VwLXZlcnRpY2FsIiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtIiArIHZhbHVlICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRTaGFkb3c6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktc2hhZG93IiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0TWluaTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQl9LAoKCQljb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJdmFyIGVscyA9IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWJ0biIgKS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKSwKCQkJCWNyZWF0ZSA9IHRoaXMuX2luaXRpYWxSZWZyZXNoOwoJCQlpZiAoICQubW9iaWxlLmNoZWNrYm94cmFkaW8gKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggIjptb2JpbGUtY2hlY2tib3hyYWRpbyIgKS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQkJfQoJCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBlbHMsIHRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID8gdGhpcy5fZ2V0VmlzaWJsZXMoIGVscywgY3JlYXRlICkgOiBlbHMsIGNyZWF0ZSApOwoJCQl0aGlzLl9pbml0aWFsUmVmcmVzaCA9IGZhbHNlOwoJCX0KCX0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCgkvLyBUT0RPOiBJbXBsZW1lbnQgYSBtZWNoYW5pc20gdG8gYWxsb3cgd2lkZ2V0cyB0byBiZWNvbWUgZW5oYW5jZWQgaW4gdGhlCgkvLyBjb3JyZWN0IG9yZGVyIHdoZW4gdGhlaXIgY29ycmVjdCBlbmhhbmNlbWVudCBkZXBlbmRzIG9uIG90aGVyIHdpZGdldHMgaW4KCS8vIHRoZSBwYWdlIGJlaW5nIGNvcnJlY3RseSBlbmhhbmNlZCBhbHJlYWR5LgoJLy8KCS8vIEZvciBub3csIHdlIHdhaXQgdW50aWwgZG9tLXJlYWR5IHRvIGF0dGFjaCB0aGUgY29udHJvbGdyb3VwJ3MgZW5oYW5jZW1lbnQKCS8vIGhvb2ssIGJlY2F1c2UgYnkgdGhhdCB0aW1lLCBhbGwgdGhlIG90aGVyIHdpZGdldHMnIGVuaGFuY2VtZW50IGhvb2tzIHNob3VsZAoJLy8gYWxyZWFkeSBiZSBpbiBwbGFjZSwgZW5zdXJpbmcgdGhhdCBhbGwgd2lkZ2V0cyB0aGF0IG5lZWQgdG8gYmUgZ3JvdXBlZCB3aWxsCgkvLyBhbHJlYWR5IGhhdmUgYmVlbiBlbmhhbmNlZCBieSB0aGUgdGltZSB0aGUgY29udHJvbGdyb3VwIGlzIGNyZWF0ZWQuCgkkKCBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApICB7CgkJCSQubW9iaWxlLmNvbnRyb2xncm91cC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKCQl9KTsKCX0pOwp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCS8vbGlua3Mgd2l0aGluIGNvbnRlbnQgYXJlYXMsIHRlc3RzIGluY2x1ZGVkIHdpdGggcGFnZQoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLm5vdCggIi51aS1idG4sIC51aS1saW5rLWluaGVyaXQsIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS5maXhlZHRvb2xiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCQlvcHRpb25zOiB7CgkJCXZpc2libGVPblBhZ2VTaG93OiB0cnVlLAoJCQlkaXNhYmxlUGFnZVpvb206IHRydWUsCgkJCXRyYW5zaXRpb246ICJzbGlkZSIsIC8vY2FuIGJlIG5vbmUsIGZhZGUsIHNsaWRlIChzbGlkZSBtYXBzIHRvIHNsaWRldXAgb3Igc2xpZGVkb3duKQoJCQlmdWxsc2NyZWVuOiBmYWxzZSwKCQkJdGFwVG9nZ2xlOiB0cnVlLAoJCQl0YXBUb2dnbGVCbGFja2xpc3Q6ICJhLCBidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCAudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkLCAudWktcG9wdXAsIC51aS1wYW5lbCwgLnVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCWhpZGVEdXJpbmdGb2N1czogImlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0IiwKCQkJdXBkYXRlUGFnZVBhZGRpbmc6IHRydWUsCgkJCXRyYWNrUGVyc2lzdGVudFRvb2xiYXJzOiB0cnVlLAoKCQkJLy8gQnJvd3NlciBkZXRlY3Rpb24hIFdlZWVlLCBoZXJlIHdlIGdvLi4uCgkJCS8vIFVuZm9ydHVuYXRlbHksIHBvc2l0aW9uOmZpeGVkIGlzIGNvc3RseSwgbm90IHRvIG1lbnRpb24gcHJvYmFibHkgaW1wb3NzaWJsZSwgdG8gZmVhdHVyZS1kZXRlY3QgYWNjdXJhdGVseS4KCQkJLy8gU29tZSB0ZXN0cyBleGlzdCwgYnV0IHRoZXkgY3VycmVudGx5IHJldHVybiBmYWxzZSByZXN1bHRzIGluIGNyaXRpY2FsIGRldmljZXMgYW5kIGJyb3dzZXJzLCB3aGljaCBjb3VsZCBsZWFkIHRvIGEgYnJva2VuIGV4cGVyaWVuY2UuCgkJCS8vIFRlc3RpbmcgZml4ZWQgcG9zaXRpb25pbmcgaXMgYWxzbyBwcmV0dHkgb2J0cnVzaXZlIHRvIHBhZ2UgbG9hZCwgcmVxdWlyaW5nIGluamVjdGVkIGVsZW1lbnRzIGFuZCBzY3JvbGxpbmcgdGhlIHdpbmRvdwoJCQkvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIHNlcnZlcyB0byBydWxlIG91dCBzb21lIHBvcHVsYXIgYnJvd3NlcnMgd2l0aCBrbm93biBmaXhlZC1wb3NpdGlvbmluZyBpc3N1ZXMKCQkJLy8gVGhpcyBpcyBhIHBsdWdpbiBvcHRpb24gbGlrZSBhbnkgb3RoZXIsIHNvIGZlZWwgZnJlZSB0byBpbXByb3ZlIG9yIG92ZXJ3cml0ZSBpdAoJCQlzdXBwb3J0QmxhY2tsaXN0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhJC5zdXBwb3J0LmZpeGVkUG9zaXRpb247CgkJCX0sCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJCXRidHlwZSA9ICRlbC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIiwKCQkJCSRwYWdlID0gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCgkJCS8vIEZlYXR1cmUgZGV0ZWN0aW5nIHN1cHBvcnQgZm9yCgkJCWlmICggby5zdXBwb3J0QmxhY2tsaXN0KCkgKSB7CgkJCQlzZWxmLmRlc3Ryb3koKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZpeGVkIiApOwoKCQkJLy8gImZ1bGxzY3JlZW4iIG92ZXJsYXkgcG9zaXRpb25pbmcKCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkkZWwuYWRkQ2xhc3MoICJ1aS0iKyB0YnR5cGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1mdWxsc2NyZWVuIiApOwoJCQl9CgkJCS8vIElmIG5vdCBmdWxsc2NyZWVuLCBhZGQgY2xhc3MgdG8gcGFnZSB0byBzZXQgdG9wIG9yIGJvdHRvbSBwYWRkaW5nCgkJCWVsc2V7CgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRidHlwZSArICItZml4ZWQiICk7CgkJCX0KCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfdGhpc1BhZ2U6IG51bGwKCQkJfSk7CiAKCQkJc2VsZi5fYWRkVHJhbnNpdGlvbkNsYXNzKCk7CgkJCXNlbGYuX2JpbmRQYWdlRXZlbnRzKCk7CgkJCXNlbGYuX2JpbmRUb2dnbGVIYW5kbGVycygpOwoJCX0sCgoJCV9hZGRUcmFuc2l0aW9uQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGNsYXNzID0gdGhpcy5vcHRpb25zLnRyYW5zaXRpb247CgoJCQlpZiAoIHRjbGFzcyAmJiB0Y2xhc3MgIT09ICJub25lIiApIHsKCQkJCS8vIHVzZSBhcHByb3ByaWF0ZSBzbGlkZSBmb3IgaGVhZGVyIG9yIGZvb3RlcgoJCQkJaWYgKCB0Y2xhc3MgPT09ICJzbGlkZSIgKSB7CgkJCQkJdGNsYXNzID0gdGhpcy5lbGVtZW50LmlzKCAiLnVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl90aGlzUGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJCS8vcGFnZSBldmVudCBiaW5kaW5ncwoJCQkvLyBGaXhlZCB0b29sYmFycyByZXF1aXJlIHBhZ2Ugem9vbSB0byBiZSBkaXNhYmxlZCwgb3RoZXJ3aXNlIHVzYWJpbGl0eSBpc3N1ZXMgY3JvcCB1cAoJCQkvLyBUaGlzIG1ldGhvZCBpcyBtZWFudCB0byBkaXNhYmxlIHpvb20gd2hpbGUgYSBmaXhlZC1wb3NpdGlvbmVkIHRvb2xiYXIgcGFnZSBpcyB2aXNpYmxlCgkJCXRoaXMuX29uKCB0aGlzLl90aGlzUGFnZSwgewoJCQkJInBhZ2ViZWZvcmVzaG93IjogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCQkid2Via2l0QW5pbWF0aW9uU3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJImFuaW1hdGlvbnN0YXJ0IjoiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJ1cGRhdGVsYXlvdXQiOiAiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlUGFnZVNob3ciLAoJCQkJInBhZ2ViZWZvcmVoaWRlIjogIl9oYW5kbGVQYWdlQmVmb3JlSGlkZSIKCQkJfSk7CgkJfSwKCgkJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbigpIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJdGhpcy5oaWRlKCB0cnVlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlQW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXMuX3RoaXNQYWdlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZVNob3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCB0aGlzLl90aGlzUGFnZSApOwoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29uKCAkLm1vYmlsZS53aW5kb3csIHsgInRocm90dGxlZHJlc2l6ZSI6ICJ1cGRhdGVQYWdlUGFkZGluZyIgfSApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VCZWZvcmVIaWRlOiBmdW5jdGlvbiggZSwgdWkgKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkJaWYgKCBvLmRpc2FibGVQYWdlWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQkJaWYgKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb2ZmKCAkLm1vYmlsZS53aW5kb3csICJ0aHJvdHRsZWRyZXNpemUiICk7CgkJCX0KCgkJCWlmICggby50cmFja1BlcnNpc3RlbnRUb29sYmFycyApIHsKCQkJCXZhciB0aGlzRm9vdGVyID0gJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLl90aGlzUGFnZSApLAoJCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMuX3RoaXNQYWdlICksCgkJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpLAoJCQkJCW5leHRIZWFkZXIgPSB0aGlzSGVhZGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0hlYWRlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKTsKCgkJCQlpZiAoIG5leHRGb290ZXIubGVuZ3RoIHx8IG5leHRIZWFkZXIubGVuZ3RoICkgewoKCQkJCQluZXh0Rm9vdGVyLmFkZCggbmV4dEhlYWRlciApLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJCXVpLm5leHRQYWdlLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCW5leHRIZWFkZXIucHJlcGVuZFRvKCB0aGlzICk7CgkJCQkJCW5leHRGb290ZXIuYXBwZW5kVG8oIHRoaXMgKTsKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0sCgoJCV92aXNpYmxlOiB0cnVlLAoKCQkvLyBUaGlzIHdpbGwgc2V0IHRoZSBjb250ZW50IGVsZW1lbnQncyB0b3Agb3IgYm90dG9tIHBhZGRpbmcgZXF1YWwgdG8gdGhlIHRvb2xiYXIncyBoZWlnaHQKCQl1cGRhdGVQYWdlUGFkZGluZzogZnVuY3Rpb24oIHRiUGFnZSApIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICksCgkJCQlwb3MgPSBwYXJzZUZsb2F0KCAkZWwuY3NzKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICkgKTsKCgkJCS8vIFRoaXMgYmVoYXZpb3Igb25seSBhcHBsaWVzIHRvICJmaXhlZCIsIG5vdCAiZnVsbHNjcmVlbiIKCQkJaWYgKCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiApIHsgcmV0dXJuOyB9CgoJCQkvLyB0YlBhZ2UgYXJndW1lbnQgY2FuIGJlIGEgUGFnZSBvYmplY3Qgb3IgYW4gZXZlbnQsIGlmIGNvbWluZyBmcm9tIHRocm90dGxlZCByZXNpemUuIAoJCQl0YlBhZ2UgPSAoIHRiUGFnZSAmJiB0YlBhZ2UudHlwZSA9PT0gdW5kZWZpbmVkICYmIHRiUGFnZSApIHx8IHRoaXMuX3RoaXNQYWdlIHx8ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSArIHBvcyApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdywKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCXNjcm9sbCA9ICR3aW4uc2Nyb2xsVG9wKCksCgkJCQllbEhlaWdodCA9ICRlbC5oZWlnaHQoKSwKCQkJCXBIZWlnaHQgPSAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLmhlaWdodCgpLAoJCQkJdmlld3BvcnRIZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSwKCQkJCXRidHlwZSA9ICRlbC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIjsKCgkJCXJldHVybiAhbm90cmFuc2l0aW9uICYmCgkJCQkoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICYmIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICE9PSAibm9uZSIgJiYKCQkJCSgKCQkJCQkoIHRidHlwZSA9PT0gImhlYWRlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCA+IGVsSGVpZ2h0ICkgfHwKCQkJCQkoIHRidHlwZSA9PT0gImZvb3RlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCArIHZpZXdwb3J0SGVpZ2h0IDwgcEhlaWdodCAtIGVsSGVpZ2h0ICkKCQkJCSkgfHwgdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4KCQkJCSk7CgkJfSwKCgkJc2hvdzogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50OwoKCQkJaWYgKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCAiICsgaGlkZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoICJpbiIgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbiAoKSB7CgkJCQkJCSRlbC5yZW1vdmVDbGFzcygnaW4nKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5yZW1vdmVDbGFzcyggaGlkZUNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IHRydWU7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkuYWRkQ2xhc3MoIG91dGNsYXNzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJpbiIgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpIHsKCQkJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IGZhbHNlOwoJCX0sCgoJCXRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJCXRoaXNbIHRoaXMuX3Zpc2libGUgPyAiaGlkZSIgOiAic2hvdyIgXSgpOwoJCX0sCgoJCV9iaW5kVG9nZ2xlSGFuZGxlcnM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50LAoJCQkJZGVsYXlTaG93LCBkZWxheUhpZGUsCgkJCQlpc1Zpc2libGUgPSB0cnVlOwoKCQkJLy8gdGFwIHRvZ2dsZQoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApCgkJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCWlmICggby50YXBUb2dnbGUgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggby50YXBUb2dnbGVCbGFja2xpc3QgKS5sZW5ndGggKSB7CgkJCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZm9jdXNpbiBmb2N1c291dCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCS8vdGhpcyBoaWRlcyB0aGUgdG9vbGJhcnMgb24gYSBrZXlib2FyZCBwb3AgdG8gZ2l2ZSBtb3JlIHNjcmVlbiByb29tIGFuZCBwcmV2ZW50IGlvcyBidWcgd2hpY2ggCgkJCQkJLy9wb3NpdGlvbnMgZml4ZWQgdG9vbGJhcnMgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuIG9uIHBvcCBpZiB0aGUgaW5wdXQgaXMgbmVhciB0aGUgdG9wIG9yCgkJCQkJLy9ib3R0b20gb2YgdGhlIHNjcmVlbiBhZGRyZXNzZXMgaXNzdWVzICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCS8vYW5kIGlzc3VlICM0MTEzIEhlYWRlciBhbmQgZm9vdGVyIGNoYW5nZSB0aGVpciBwb3NpdGlvbiBhZnRlciBrZXlib2FyZCBwb3B1cCAtIGlPUwoJCQkJCS8vYW5kIGlzc3VlICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgMTAyNSAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApIHsKCQkJCQkJLy9GaXggZm9yIGlzc3VlICM0NzI0IE1vdmluZyB0aHJvdWdoIGZvcm0gaW4gTW9iaWxlIFNhZmFyaSB3aXRoICJOZXh0IiBhbmQgIlByZXZpb3VzIiBzeXN0ZW0gCgkJCQkJCS8vY29udHJvbHMgY2F1c2VzIGZpeGVkIHBvc2l0aW9uLCB0YXAtdG9nZ2xlIGZhbHNlIEhlYWRlciB0byByZXZlYWwgaXRzZWxmCgkJCQkJCS8vIGlzVmlzaWJsZSBpbnN0ZWFkIG9mIHNlbGYuX3Zpc2libGUgYmVjYXVzZSB0aGUgZm9jdXNpbiBhbmQgZm9jdXNvdXQgZXZlbnRzIGZpcmUgdHdpY2UgYXQgdGhlIHNhbWUgdGltZQoJCQkJCQkvLyBBbHNvIHVzZSBhIGRlbGF5IGZvciBoaWRpbmcgdGhlIHRvb2xiYXJzIGJlY2F1c2Ugb24gQW5kcm9pZCBuYXRpdmUgYnJvd3NlciBmb2N1c2luIGlzIGRpcmVjbHR5IGZvbGxvd2VkCgkJCQkJCS8vIGJ5IGEgZm9jdXNvdXQgd2hlbiBhIG5hdGl2ZSBzZWxlY3RzIG9wZW5zIGFuZCB0aGUgb3RoZXIgd2F5IGFyb3VuZCB3aGVuIGl0IGNsb3Nlcy4KCQkJCQkJaWYgKCBlLnR5cGUgPT09ICJmb2N1c291dCIgJiYgIWlzVmlzaWJsZSApIHsKCQkJCQkJCWlzVmlzaWJsZSA9IHRydWU7CgkJCQkJCQkvL3dhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYW5kIHNlZSBpZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0CgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5SGlkZSApOwoJCQkJCQkJZGVsYXlTaG93ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJc2VsZi5zaG93KCk7CgkJCQkJCQl9LCAwICk7IAoJCQkJCQl9IGVsc2UgaWYgKCBlLnR5cGUgPT09ICJmb2N1c2luIiAmJiAhIWlzVmlzaWJsZSApIHsKCQkJCQkJCS8vaWYgd2UgaGF2ZSBqdW1wZWQgdG8gYW5vdGhlciBpbnB1dCBjbGVhciB0aGUgdGltZSBvdXQgdG8gY2FuY2VsIHRoZSBzaG93LgoJCQkJCQkJY2xlYXJUaW1lb3V0KCBkZWxheVNob3cgKTsKCQkJCQkJCWlzVmlzaWJsZSA9IGZhbHNlOwoJCQkJCQkJZGVsYXlIaWRlID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJc2VsZi5oaWRlKCk7CgkJCQkJCQl9LCAwICk7IAoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmlzKCAiLnVpLWhlYWRlciIgKTsKCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICIiICk7CgkJCSRlbC5yZW1vdmVDbGFzcyggInVpLWhlYWRlci1maXhlZCB1aS1mb290ZXItZml4ZWQgdWktaGVhZGVyLWZ1bGxzY3JlZW4gdWktZm9vdGVyLWZ1bGxzY3JlZW4gaW4gb3V0IGZhZGUgc2xpZGVkb3duIHNsaWRldXAgdWktZml4ZWQtaGlkZGVuIiApOwoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLnJlbW92ZUNsYXNzKCAidWktcGFnZS1oZWFkZXItZml4ZWQgdWktcGFnZS1mb290ZXItZml4ZWQgdWktcGFnZS1oZWFkZXItZnVsbHNjcmVlbiB1aS1wYWdlLWZvb3Rlci1mdWxsc2NyZWVuIiApOwoJCX0KCgl9KTsKCgkvL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKCSQubW9iaWxlLmRvY3VtZW50CgkJLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCQkJLy8gREVQUkVDQVRFRCBpbiAxLjE6IHN1cHBvcnQgZm9yIGRhdGEtZnVsbHNjcmVlbj10cnVlfGZhbHNlIG9uIHRoZSBwYWdlIGVsZW1lbnQuCgkJCS8vIFRoaXMgbGluZSBlbnN1cmVzIGl0IHN0aWxsIHdvcmtzLCBidXQgd2UgcmVjb21tZW5kIG1vdmluZyB0aGUgYXR0cmlidXRlIHRvIHRoZSB0b29sYmFycyB0aGVtc2VsdmVzLgoJCQlpZiAoICQoIGUudGFyZ2V0ICkuanFtRGF0YSggImZ1bGxzY3JlZW4iICkgKSB7CgkJCQkkKCAkLm1vYmlsZS5maXhlZHRvb2xiYXIucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCBlLnRhcmdldCApLm5vdCggIjpqcW1EYXRhKGZ1bGxzY3JlZW4pIiApLmpxbURhdGEoICJmdWxsc2NyZWVuIiwgdHJ1ZSApOwoJCQl9CgoJCQkkLm1vYmlsZS5maXhlZHRvb2xiYXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7CgkJfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLmZpeGVkdG9vbGJhciIsICQubW9iaWxlLmZpeGVkdG9vbGJhciwgewoKCQkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9zdXBlcigpOwoJCQkJdGhpcy5fd29ya2Fyb3VuZHMoKTsKCQkJfSwKCgkJCS8vY2hlY2sgdGhlIGJyb3dzZXIgYW5kIHZlcnNpb24gYW5kIHJ1biBuZWVkZWQgd29ya2Fyb3VuZHMKCQkJX3dvcmthcm91bmRzOiBmdW5jdGlvbigpIHsKCQkJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJb3MgPSBudWxsLAoJCQkJc2VsZiA9IHRoaXM7CgkJCQkvL3NldCB0aGUgb3Mgd2UgYXJlIHdvcmtpbmcgaW4gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQkJaWYoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICl7CgkJCQkJb3MgPSAiaW9zIjsKCQkJCX0gZWxzZSBpZiggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSApewoJCQkJCW9zID0gImFuZHJvaWQiOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkvL2NoZWNrIG9zIHZlcnNpb24gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQkJaWYoIG9zID09PSAiaW9zIiApIHsKCQkJCQkvL2lPUyAgd29ya2Fyb3VuZHMKCQkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQkJfSBlbHNlIGlmKCBvcyA9PT0gImFuZHJvaWQiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB7CgkJCQkJLy9BbmRyb2lkIDIuMyBydW4gYWxsIEFuZHJvaWQgMi4zIHdvcmthcm91bmQKCQkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQkJCXNlbGYuX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kKCk7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfSwKCgkJCS8vVXRpbGl0eSBjbGFzcyBmb3IgY2hlY2tpbmcgaGVhZGVyIGFuZCBmb290ZXIgcG9zaXRpb25zIHJlbGF0aXZlIHRvIHZpZXdwb3J0CgkJCV92aWV3cG9ydE9mZnNldDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICksCgkJCQkJb2Zmc2V0ID0gTWF0aC5hYnMoJGVsLm9mZnNldCgpLnRvcCAtICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSk7CgkJCQlpZiggIWhlYWRlciApIHsKCQkJCQlvZmZzZXQgPSBNYXRoLnJvdW5kKG9mZnNldCAtICQubW9iaWxlLndpbmRvdy5oZWlnaHQoKSArICRlbC5vdXRlckhlaWdodCgpKS02MDsKCQkJCX0KCQkJCXJldHVybiBvZmZzZXQ7CgkJCX0sCgoJCQkvL2JpbmQgZXZlbnRzIGZvciBfdHJpZ2dlclJlZHJhdygpIGZ1bmN0aW9uIAoJCQlfYmluZFNjcm9sbFdvcmthcm91bmQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJLy9iaW5kIHRvIHNjcm9sbHN0b3AgYW5kIGNoZWNrIGlmIHRoZSB0b29sYmFycyBhcmUgY29ycmVjdGx5IHBvc2l0aW9uZWQKCQkJCXRoaXMuX29uKCAkLm1vYmlsZS53aW5kb3csIHsgc2Nyb2xsc3RvcDogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHZpZXdwb3J0T2Zmc2V0ID0gc2VsZi5fdmlld3BvcnRPZmZzZXQoKTsKCQkJCQkvL2NoZWNrIGlmIHRoZSBoZWFkZXIgaXMgdmlzaWJsZSBhbmQgaWYgaXRzIGluIHRoZSByaWdodCBwbGFjZQoJCQkJCWlmKCB2aWV3cG9ydE9mZnNldCA+IDIgJiYgc2VsZi5fdmlzaWJsZSkgewoJCQkJCQlzZWxmLl90cmlnZ2VyUmVkcmF3KCk7CgkJCQkJfQoJCQkJfX0pOwoJCQl9LAoKCQkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZSAjNDI1MCBQZXJzaXN0ZW50IGZvb3RlciBpbnN0YWJpbGl0eSBpbiB2MS4xIHdpdGggbG9uZyBzZWxlY3QgbGlzdHMgaW4gQW5kcm9pZCAyLjMuMwoJCQkvL2FuZCBpc3N1ZSAjMzc0OCBBbmRyb2lkIDIueDogUGFnZSB0cmFuc2l0aW9ucyBicm9rZW4gd2hlbiBmaXhlZCB0b29sYmFycyB1c2VkCgkJCS8vdGhlIGFic29sdXRlbHkgcG9zaXRpb25lZCB0aHVtYm5haWwgaW4gYSBsaXN0IHZpZXcgY2F1c2VzIHByb2JsZW1zIHdpdGggZml4ZWQgcG9zaXRpb24gYnV0dG9ucyBhYm92ZSBpbiBhIG5hdiBiYXIKCQkJLy9zZXR0aW5nIHRoZSBsaSdzIHRvIC13ZWJraXQtdHJhbnNmb3JtOnRyYW5zbGF0ZTNkKDAsMCwwKTsgc29sdmVzIHRoaXMgcHJvYmxlbSB0byBhdm9pZGUgcG90ZW50aWFsIGlzc3VlcyBpbiBvdGhlcgoJCQkvL3BsYXRmb3JtcyB3ZSBzY29wZSB0aGlzIHdpdGggdGhlIGNsYXNzIHVpLWFuZHJvaWQtMngtZml4CgkJCV9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCgiLnVpLXBhZ2UiKS5hZGRDbGFzcyggInVpLWFuZHJvaWQtMngtZml4ZWQiICk7CgkJCX0sCgkJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWVzICM0MzM3IEZpeGVkIGhlYWRlciBwcm9ibGVtIGFmdGVyIHNjcm9sbGluZyBjb250ZW50IG9uIGlPUyBhbmQgQW5kcm9pZAoJCQkvL2FuZCBkZXZpY2UgYnVncyBwcm9qZWN0IGlzc3VlICMxIEZvcm0gZWxlbWVudHMgY2FuIGxvc2UgY2xpY2sgaGl0IGFyZWEgaW4gcG9zaXRpb246IGZpeGVkIGNvbnRhaW5lcnMuCgkJCS8vdGhpcyBhbHNvIGFkZHJlc3NlcyBub3Qgb24gZml4ZWQgdG9vbGJhcnMgcGFnZSBpbiBkb2NzCgkJCS8vYWRkaW5nIDFweCBvZiBwYWRkaW5nIHRvIHRoZSBib3R0b20gdGhlbiByZW1vdmluZyBpdCBjYXVzZXMgYSAicmVkcmF3IgoJCQkvL3doaWNoIHBvc2l0aW9ucyB0aGUgdG9vbGJhcnMgY29ycmVjdGx5ICh0aGV5IHdpbGwgYWx3YXlzIGJlIHZpc3VhbGx5IGNvcnJlY3QpIAoJCQlfdHJpZ2dlclJlZHJhdzogZnVuY3Rpb24oKSB7CgkJCQl2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoICQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKTsKCQkJCS8vdHJpZ2dlciBwYWdlIHJlZHJhdyB0byBmaXggaW5jb3JyZWN0bHkgcG9zaXRpb25lZCBmaXhlZCBlbGVtZW50cwoJCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIsICggcGFkZGluZ0JvdHRvbSArIDEgKSArInB4IiApOwoJCQkJLy9pZiB0aGUgcGFkZGluZyBpcyByZXNldCB3aXRoIG91dCBhIHRpbWVvdXQgdGhlIHJlcG9zaXRpb24gd2lsbCBub3Qgb2NjdXJlLgoJCQkJLy90aGlzIGlzIGluZGVwZW5kYW50IG9mIEpRTSB0aGUgYnJvd3NlciBzZWVtcyB0byBuZWVkIHRoZSB0aW1lIHRvIHJlYWN0LgoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIsIHBhZGRpbmdCb3R0b20gKyAicHgiICk7CgkJCQl9LCAwICk7CgkJCX0sCgoJCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3N1cGVyKCk7CgkJCQkvL1JlbW92ZSB0aGUgY2xhc3Mgd2UgYWRkZWQgdG8gdGhlIHBhZ2UgcHJldmlvdXNseSBpbiBhbmRyb2lkIDIueCAKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCIudWktcGFnZS1hY3RpdmUiKS5yZW1vdmVDbGFzcyggInVpLWFuZHJvaWQtMngtZml4IiApOwoJCQl9Cgl9KTsKCgl9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhbmVsIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQlwYW5lbDogInVpLXBhbmVsIiwKCQkJcGFuZWxPcGVuOiAidWktcGFuZWwtb3BlbiIsCgkJCXBhbmVsQ2xvc2VkOiAidWktcGFuZWwtY2xvc2VkIiwKCQkJcGFuZWxGaXhlZDogInVpLXBhbmVsLWZpeGVkIiwKCQkJcGFuZWxJbm5lcjogInVpLXBhbmVsLWlubmVyIiwKCQkJbW9kYWw6ICJ1aS1wYW5lbC1kaXNtaXNzIiwKCQkJbW9kYWxPcGVuOiAidWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJcGFnZVBhbmVsOiAidWktcGFnZS1wYW5lbCIsCgkJCXBhZ2VQYW5lbE9wZW46ICJ1aS1wYWdlLXBhbmVsLW9wZW4iLAoJCQljb250ZW50V3JhcDogInVpLXBhbmVsLWNvbnRlbnQtd3JhcCIsCgkJCWNvbnRlbnRXcmFwT3BlbjogInVpLXBhbmVsLWNvbnRlbnQtd3JhcC1vcGVuIiwKCQkJY29udGVudFdyYXBDbG9zZWQ6ICJ1aS1wYW5lbC1jb250ZW50LXdyYXAtY2xvc2VkIiwKCQkJY29udGVudEZpeGVkVG9vbGJhcjogInVpLXBhbmVsLWNvbnRlbnQtZml4ZWQtdG9vbGJhciIsCgkJCWNvbnRlbnRGaXhlZFRvb2xiYXJPcGVuOiAidWktcGFuZWwtY29udGVudC1maXhlZC10b29sYmFyLW9wZW4iLAoJCQljb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkOiAidWktcGFuZWwtY29udGVudC1maXhlZC10b29sYmFyLWNsb3NlZCIsCgkJCWFuaW1hdGU6ICJ1aS1wYW5lbC1hbmltYXRlIgoJCX0sCgkJYW5pbWF0ZTogdHJ1ZSwKCQl0aGVtZTogImMiLAoJCXBvc2l0aW9uOiAibGVmdCIsCgkJZGlzbWlzc2libGU6IHRydWUsCgkJZGlzcGxheTogInJldmVhbCIsIC8vYWNjZXB0cyByZXZlYWwsIHB1c2gsIG92ZXJsYXkKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdwYW5lbCcpIiwKCQlzd2lwZUNsb3NlOiB0cnVlLAoJCXBvc2l0aW9uRml4ZWQ6IGZhbHNlCgl9LAoKCV9wYW5lbElEOiBudWxsLAoJX2Nsb3NlTGluazogbnVsbCwKCV9wYWdlOiBudWxsLAoJX21vZGFsOiBudWxsLAoJX3BhbmVsSW5uZXI6IG51bGwsCglfd3JhcHBlcjogbnVsbCwKCV9maXhlZFRvb2xiYXI6IG51bGwsCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkZWwgPSBzZWxmLmVsZW1lbnQsCgkJCXBhZ2UgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJX2dldFBhZ2VUaGVtZSA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGVtZSA9ICQuZGF0YSggcGFnZVswXSwgIm1vYmlsZVBhZ2UiICkub3B0aW9ucy50aGVtZSwKCQkJCSRwYWdlVGhlbWVDbGFzcyA9ICJ1aS1ib2R5LSIgKyAkdGhlbWU7CgkJCQlyZXR1cm4gJHBhZ2VUaGVtZUNsYXNzOwoJCQl9LAoJCQlfZ2V0UGFuZWxJbm5lciA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICRwYW5lbElubmVyID0gJGVsLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKTsKCQkJCWlmICggJHBhbmVsSW5uZXIubGVuZ3RoID09PSAwICkgewoJCQkJCSRwYW5lbElubmVyID0gJGVsLmNoaWxkcmVuKCkud3JhcEFsbCggJzxkaXYgY2xhc3M9IicgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICsgJyIgLz4nICkucGFyZW50KCk7CgkJCQl9CgkJCQlyZXR1cm4gJHBhbmVsSW5uZXI7CgkJCX0sCgkJCV9nZXRXcmFwcGVyID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHdyYXBwZXIgPSBwYWdlLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRXcmFwICk7CgkJCQlpZiAoICR3cmFwcGVyLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkkd3JhcHBlciA9IHBhZ2UuY2hpbGRyZW4oICIudWktaGVhZGVyOm5vdCg6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSksIC51aS1jb250ZW50Om5vdCg6anFtRGF0YShyb2xlPSdwb3B1cCcpKSwgLnVpLWZvb3Rlcjpub3QoOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykpIiApLndyYXBBbGwoICc8ZGl2IGNsYXNzPSInICsgc2VsZi5vcHRpb25zLmNsYXNzZXMuY29udGVudFdyYXAgKyAnICcgKyBfZ2V0UGFnZVRoZW1lKCkgKyAnIiAvPicgKS5wYXJlbnQoKTsKCQkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXNlbGYub3B0aW9ucy5hbmltYXRlICkgewoJCQkJCQkkd3JhcHBlci5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAkd3JhcHBlcjsKCQkJfSwKCQkJX2dldEZpeGVkVG9vbGJhciA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICRmaXhlZFRvb2xiYXIgPSBwYWdlLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXIgKTsKCQkJCWlmICggJGZpeGVkVG9vbGJhci5sZW5ndGggPT09IDAgKSB7CgkJCQkJJGZpeGVkVG9vbGJhciA9IHBhZ2UuZmluZCggIi51aS1oZWFkZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSwgLnVpLWZvb3RlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiApLmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyICk7CgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFzZWxmLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJCQkJJGZpeGVkVG9vbGJhci5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAkZml4ZWRUb29sYmFyOwoJCQl9OwoKCQkvLyBleHBvc2Ugc29tZSBwcml2YXRlIHByb3BzIHRvIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfcGFuZWxJRDogJGVsLmF0dHIoICJpZCIgKSwKCQkJX2Nsb3NlTGluazogJGVsLmZpbmQoICI6anFtRGF0YShyZWw9J2Nsb3NlJykiICksCgkJCV9wYWdlOiAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJX3BhZ2VUaGVtZTogX2dldFBhZ2VUaGVtZSgpLAoJCQlfcGFuZWxJbm5lcjogX2dldFBhbmVsSW5uZXIoKSwKCQkJX3dyYXBwZXI6IF9nZXRXcmFwcGVyKCksCgkJCV9maXhlZFRvb2xiYXI6IF9nZXRGaXhlZFRvb2xiYXIoKQoJCX0pOwoJCQoJCXNlbGYuX2FkZFBhbmVsQ2xhc3NlcygpOwoJCXNlbGYuX3dyYXBwZXIuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRXcmFwQ2xvc2VkICk7CgkJc2VsZi5fZml4ZWRUb29sYmFyLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkICk7CgkJLy8gYWRkIGNsYXNzIHRvIHBhZ2Ugc28gd2UgY2FuIHNldCAib3ZlcmZsb3cteDogaGlkZGVuOyIgZm9yIGl0IHRvIGZpeCBBbmRyb2lkIHpvb20gaXNzdWUKCQlzZWxmLl9wYWdlLmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5wYWdlUGFuZWwgKTsKCQkKCQkvLyBpZiBhbmltYXRpbmcsIGFkZCB0aGUgY2xhc3MgdG8gZG8gc28KCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXNlbGYub3B0aW9ucy5hbmltYXRlICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHNlbGYub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQl9CgkJCgkJc2VsZi5fYmluZFVwZGF0ZUxheW91dCgpOwoJCXNlbGYuX2JpbmRDbG9zZUV2ZW50cygpOwoJCXNlbGYuX2JpbmRMaW5rTGlzdGVuZXJzKCk7CgkJc2VsZi5fYmluZFBhZ2VFdmVudHMoKTsKCgkJaWYgKCAhIXNlbGYub3B0aW9ucy5kaXNtaXNzaWJsZSApIHsKCQkJc2VsZi5fY3JlYXRlTW9kYWwoKTsKCQl9CgoJCXNlbGYuX2JpbmRTd2lwZUV2ZW50cygpOwoJfSwKCglfY3JlYXRlTW9kYWw6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBzZWxmID0gdGhpczsKCQkKCQlzZWxmLl9tb2RhbCA9ICQoICI8ZGl2IGNsYXNzPSciICsgc2VsZi5vcHRpb25zLmNsYXNzZXMubW9kYWwgKyAiJyBkYXRhLXBhbmVsaWQ9JyIgKyBzZWxmLl9wYW5lbElEICsgIic+PC9kaXY+IiApCgkJCS5vbiggIm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5jbG9zZSgpOwoJCQl9KQoJCQkuYXBwZW5kVG8oIHRoaXMuX3BhZ2UgKTsKCX0sCgoJX2dldFBvc0Rpc3BsYXlDbGFzc2VzOiBmdW5jdGlvbiggcHJlZml4ICkgewoJCXJldHVybiBwcmVmaXggKyAiLXBvc2l0aW9uLSIgKyB0aGlzLm9wdGlvbnMucG9zaXRpb24gKyAiICIgKyBwcmVmaXggKyAiLWRpc3BsYXktIiArIHRoaXMub3B0aW9ucy5kaXNwbGF5OwoJfSwKCglfZ2V0UGFuZWxDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFuZWxDbGFzc2VzID0gdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWwgKwoJCQkiICIgKyB0aGlzLl9nZXRQb3NEaXNwbGF5Q2xhc3NlcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWwgKSArCgkJCSIgIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsQ2xvc2VkOwoKCQlpZiAoIHRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJcGFuZWxDbGFzc2VzICs9ICIgdWktYm9keS0iICsgdGhpcy5vcHRpb25zLnRoZW1lOwoJCX0KCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkOwoJCX0KCQlyZXR1cm4gcGFuZWxDbGFzc2VzOwoJfSwKCglfYWRkUGFuZWxDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMuX2dldFBhbmVsQ2xhc3NlcygpICk7Cgl9LAoKCV9iaW5kQ2xvc2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCQkKCQlzZWxmLl9jbG9zZUxpbmsub24oICJjbGljay5wYW5lbCIgLCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWxmLmNsb3NlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCQlzZWxmLmVsZW1lbnQub24oICJjbGljay5wYW5lbCIgLCAiYTpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiLCBmdW5jdGlvbiggZSApIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwkJCgl9LAoKCV9wb3NpdGlvblBhbmVsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXBhbmVsSW5uZXJIZWlnaHQgPSBzZWxmLl9wYW5lbElubmVyLm91dGVySGVpZ2h0KCksCgkJCWV4cGFuZCA9IHBhbmVsSW5uZXJIZWlnaHQgPiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJaWYgKCBleHBhbmQgfHwgIXNlbGYub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlpZiAoIGV4cGFuZCApIHsKCQkJCXNlbGYuX3VuZml4UGFuZWwoKTsKCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCggcGFuZWxJbm5lckhlaWdodCApOwoJCQl9CgkJCXNlbGYuX3Njcm9sbEludG9WaWV3KCBwYW5lbElubmVySGVpZ2h0ICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5fZml4UGFuZWwoKTsKCQl9Cgl9LAoKCV9zY3JvbGxJbnRvVmlldzogZnVuY3Rpb24oIHBhbmVsSW5uZXJIZWlnaHQgKSB7CgkJaWYgKCBwYW5lbElubmVySGVpZ2h0IDwgJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgKSB7CgkJCXdpbmRvdy5zY3JvbGxUbyggMCwgMCApOwoJCX0JCgl9LAoKCV9iaW5kRml4TGlzdGVuZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAkKCB3aW5kb3cgKSwgeyAidGhyb3R0bGVkcmVzaXplIjogIl9wb3NpdGlvblBhbmVsIiB9KTsKCX0sCgoJX3VuYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vZmYoICQoIHdpbmRvdyApLCAidGhyb3R0bGVkcmVzaXplIiApOwoJfSwKCglfdW5maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoKCV9maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoJCglfYmluZFVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCQoJCXNlbGYuZWxlbWVudC5vbiggInVwZGF0ZWxheW91dCIsIGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQlzZWxmLl9wb3NpdGlvblBhbmVsKCk7CgkJCX0KCQl9KTsKCX0sCgoJX2JpbmRMaW5rTGlzdGVuZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuX3BhZ2Uub24oICJjbGljay5wYW5lbCIgLCAiYSIsIGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoIHRoaXMuaHJlZi5zcGxpdCggIiMiIClbIDEgXSA9PT0gc2VsZi5fcGFuZWxJRCAmJiBzZWxmLl9wYW5lbElEICE9PSB1bmRlZmluZWQgKSB7CgkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQl2YXIgJGxpbmsgPSAkKCB0aGlzICk7CgkJCQlpZiAoICEgJGxpbmsuaGFzQ2xhc3MoICJ1aS1saW5rIiApICkgewoJCQkJCSRsaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCXNlbGYuZWxlbWVudC5vbmUoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkkbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQl9KTsKCQkJCX0KCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9KTsKCX0sCgkKCV9iaW5kU3dpcGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJlYSA9IHNlbGYuX21vZGFsID8gc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fbW9kYWwgKSA6IHNlbGYuZWxlbWVudDsKCQkKCQkvLyBvbiBzd2lwZSwgY2xvc2UgdGhlIHBhbmVsCgkJaWYoICEhc2VsZi5vcHRpb25zLnN3aXBlQ2xvc2UgKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnBvc2l0aW9uID09PSAibGVmdCIgKSB7CgkJCQlhcmVhLm9uKCAic3dpcGVsZWZ0LnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlhcmVhLm9uKCAic3dpcGVyaWdodC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9CgkJfQoJfSwKCglfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCQkJCgkJc2VsZi5fcGFnZQoJCQkvLyBDbG9zZSB0aGUgcGFuZWwgaWYgYW5vdGhlciBwYW5lbCBvbiB0aGUgcGFnZSBvcGVucwoJCQkub24oICJwYW5lbGJlZm9yZW9wZW4iLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggc2VsZi5fb3BlbiAmJiBlLnRhcmdldCAhPT0gc2VsZi5lbGVtZW50WyAwIF0gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KQoJCQkvLyBjbGVhbiB1cCBvcGVuIHBhbmVscyBhZnRlciBwYWdlIGhpZGUKCQkJLm9uKCAicGFnZWhpZGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCB0cnVlICk7CgkJCQl9CgkJCX0pCgkJCS8vIG9uIGVzY2FwZSwgY2xvc2U/IG1pZ2h0IG5lZWQgdG8gaGF2ZSBhIHRhcmdldCBjaGVjayB0b28uLi4KCQkJLm9uKCAia2V5dXAucGFuZWwiLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggZS5rZXlDb2RlID09PSAyNyAmJiBzZWxmLl9vcGVuICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSk7Cgl9LAoKCS8vIHN0YXRlIHN0b3JhZ2Ugb2Ygb3BlbiBvciBjbG9zZWQKCV9vcGVuOiBmYWxzZSwKCglfY29udGVudFdyYXBPcGVuQ2xhc3NlczogbnVsbCwKCV9maXhlZFRvb2xiYXJPcGVuQ2xhc3NlczogbnVsbCwKCV9tb2RhbE9wZW5DbGFzc2VzOiBudWxsLAoKCW9wZW46IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCAhdGhpcy5fb3BlbiApIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCV9vcGVuUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9wYWdlLm9mZiggInBhbmVsY2xvc2UiICk7CgkJCQkJc2VsZi5fcGFnZS5qcW1EYXRhKCAicGFuZWwiLCAib3BlbiIgKTsKCQkJCQkKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgkJCQkJCgkJCQkJaWYgKCBzZWxmLm9wdGlvbnMudGhlbWUgJiYgc2VsZi5vcHRpb25zLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZQoJCQkJCQkJLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlVGhlbWUgKQoJCQkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCQkJfQoJCQkJCQoJCQkJCXNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCQkJCQkKCQkJCQlzZWxmLl9wb3NpdGlvblBhbmVsKCk7CgkJCQkJCgkJCQkJLy8gRml4IGZvciBJRTcgbWluLWhlaWdodCBidWcKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aGVtZSAmJiBzZWxmLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLmNzcyggIm1pbi1oZWlnaHQiLCBzZWxmLl9wYWdlLmNzcyggIm1pbi1oZWlnaHQiICkgKTsKCQkJCQl9CgkJCQkJCgkJCQkJc2VsZi5fY29udGVudFdyYXBPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMuY29udGVudFdyYXAgKTsKCQkJCQlzZWxmLl93cmFwcGVyCgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRXcmFwQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBzZWxmLl9jb250ZW50V3JhcE9wZW5DbGFzc2VzICsgIiAiICsgby5jbGFzc2VzLmNvbnRlbnRXcmFwT3BlbiApOwoJCQkJCQkKCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhciApOwoJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcgoJCQkJCQkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBzZWxmLl9maXhlZFRvb2xiYXJPcGVuQ2xhc3NlcyArICIgIiArIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyT3BlbiApOwoJCQkJCQkKCQkJCQlzZWxmLl9tb2RhbE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5tb2RhbCApICsgIiAiICsgby5jbGFzc2VzLm1vZGFsT3BlbjsKCQkJCQlpZiAoIHNlbGYuX21vZGFsICkgewoJCQkJCQlzZWxmLl9tb2RhbC5hZGRDbGFzcyggc2VsZi5fbW9kYWxPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCQkJCX0sCgkJCQljb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vZmYoIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgoJCQkJCXNlbGYuX3BhZ2UuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlUGFuZWxPcGVuICk7CgkJCQkJCgkJCQkJc2VsZi5fYmluZEZpeExpc3RlbmVyKCk7CgkJCQkJCgkJCQkJc2VsZi5fdHJpZ2dlciggIm9wZW4iICk7CgkJCQl9OwoKCQkJaWYgKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlLWFjdGl2ZSIgKS5sZW5ndGggPCAwICkgewoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfQoJCQkKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZW9wZW4iICk7CgkJCQoJCQlpZiAoIHNlbGYuX3BhZ2UuanFtRGF0YSgncGFuZWwnKSA9PT0gIm9wZW4iICkgewoJCQkJc2VsZi5fcGFnZS5vbiggInBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQlfb3BlblBhbmVsKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCV9vcGVuUGFuZWwoKTsKCQkJfQoJCQkKCQkJc2VsZi5fb3BlbiA9IHRydWU7CgkJfQoJfSwKCgljbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQkJc2VsZiA9IHRoaXMsCgkJCQlfY2xvc2VQYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vbiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCQkJCQkKCQkJCQlzZWxmLl9wYWdlLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoJCQkJCXNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoJCQkJCXNlbGYuX3dyYXBwZXIucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50V3JhcE9wZW4gKTsKCQkJCQlzZWxmLl9maXhlZFRvb2xiYXIucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyT3BlbiApOwoJCQkJCQoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsLnJlbW92ZUNsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCBzZWxmLm9wdGlvbnMudGhlbWUgJiYgc2VsZi5vcHRpb25zLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHNlbGYub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCBzZWxmLl9wYWdlVGhlbWUgKTsKCQkJCQkJLy8gcmVzZXQgZml4IGZvciBJRTcgbWluLWhlaWdodCBidWcKCQkJCQkJc2VsZi5fd3JhcHBlci5jc3MoICJtaW4taGVpZ2h0IiwgIiIgKTsKCQkJCQl9CgkJCQkJc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fd3JhcHBlciApLm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQlzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbENsb3NlZCApOwoJCQkJCQoJCQkJCXNlbGYuX3dyYXBwZXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBzZWxmLl9jb250ZW50V3JhcE9wZW5DbGFzc2VzICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMuY29udGVudFdyYXBDbG9zZWQgKTsKCQkJCQkJCgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyCgkJCQkJCS5yZW1vdmVDbGFzcyggc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgKQoJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkICk7CgkJCQkJCQoJCQkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJCQkJc2VsZi5fdW5iaW5kRml4TGlzdGVuZXIoKTsKCQkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCQkJCQkKCQkJCQlzZWxmLl9wYWdlLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQkJCQlzZWxmLl90cmlnZ2VyKCAiY2xvc2UiICk7CgkJCQl9OwoJCQkJCgkJCWlmICggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZS1hY3RpdmUiICkubGVuZ3RoIDwgMCApIHsKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0KCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZWNsb3NlIiApOwoKCQkJX2Nsb3NlUGFuZWwoKTsKCgkJCXNlbGYuX29wZW4gPSBmYWxzZTsKCQl9Cgl9LAoJCgl0b2dnbGU6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXRoaXNbIHRoaXMuX29wZW4gPyAiY2xvc2UiIDogIm9wZW4iIF0oKTsKCX0sCgoJX3RyYW5zaXRpb25FbmRFdmVudHM6ICJ3ZWJraXRUcmFuc2l0aW9uRW5kIG9UcmFuc2l0aW9uRW5kIG90cmFuc2l0aW9uZW5kIHRyYW5zaXRpb25lbmQgbXNUcmFuc2l0aW9uRW5kIiwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGNsYXNzZXMgPSB0aGlzLm9wdGlvbnMuY2xhc3NlcywKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCWhhc090aGVyU2libGluZ1BhbmVscyA9IHRoaXMuZWxlbWVudC5zaWJsaW5ncyggIi4iICsgY2xhc3Nlcy5wYW5lbCApLmxlbmd0aDsKCgkJLy8gY3JlYXRlCgkJaWYgKCAhaGFzT3RoZXJTaWJsaW5nUGFuZWxzICkgewoJCQl0aGlzLl93cmFwcGVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgkJCXRoaXMuX3BhZ2UuZmluZCggImEiICkudW5iaW5kKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiICk7CgkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoIGNsYXNzZXMucGFnZVBhbmVsICk7CgkJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJCXRoaXMuX3BhZ2UuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggY2xhc3Nlcy5wYWdlUGFuZWxPcGVuICk7CgkJCQlpZiAoIHRoZW1lICkgewoJCQkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyB0aGVtZSApLmFkZENsYXNzKCB0aGlzLl9wYWdlVGhlbWUgKTsKCQkJCX0KCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCgpOwoJCQl9CgkJfSBlbHNlIGlmICggdGhpcy5fb3BlbiApIHsKCQkJdGhpcy5fd3JhcHBlci5yZW1vdmVDbGFzcyggY2xhc3Nlcy5jb250ZW50V3JhcE9wZW4gKTsKCQkJdGhpcy5fZml4ZWRUb29sYmFyLnJlbW92ZUNsYXNzKCBjbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJPcGVuICk7CgkJCXRoaXMuX3BhZ2UuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCBjbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJaWYgKCB0aGVtZSApIHsKCQkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyB0aGVtZSApLmFkZENsYXNzKCB0aGlzLl9wYWdlVGhlbWUgKTsKCQkJfQoJCX0KCQkKCQl0aGlzLl9wYW5lbElubmVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggWyB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSwgY2xhc3Nlcy5wYW5lbEFuaW1hdGUgXS5qb2luKCAiICIgKSApCgkJCS5vZmYoICJzd2lwZWxlZnQucGFuZWwgc3dpcGVyaWdodC5wYW5lbCIgKQoJCQkub2ZmKCAicGFuZWxiZWZvcmVvcGVuIiApCgkJCS5vZmYoICJwYW5lbGhpZGUiICkKCQkJLm9mZiggImtleXVwLnBhbmVsIiApCgkJCS5vZmYoICJ1cGRhdGVsYXlvdXQiICk7CgoJCXRoaXMuX2Nsb3NlTGluay5vZmYoICJjbGljay5wYW5lbCIgKTsKCgkJaWYgKCB0aGlzLl9tb2RhbCApIHsKCQkJdGhpcy5fbW9kYWwucmVtb3ZlKCk7CgkJfQoKCQkvLyBvcGVuIGFuZCBjbG9zZQoJCXRoaXMuZWxlbWVudC5vZmYoIHRoaXMuX3RyYW5zaXRpb25FbmRFdmVudHMgKQoJCQkucmVtb3ZlQ2xhc3MoIFsgY2xhc3Nlcy5wYW5lbFVuZml4ZWQsIGNsYXNzZXMucGFuZWxDbG9zZWQsIGNsYXNzZXMucGFuZWxPcGVuIF0uam9pbiggIiAiICkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnBhbmVsLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCgkJb3B0aW9uczogewoJCQljbGFzc2VzOiB7CgkJCQl0YWJsZTogInVpLXRhYmxlIgoJCQl9LAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSd0YWJsZScpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCXNlbGYucmVmcmVzaCggdHJ1ZSApOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uIChjcmVhdGUpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJdHJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0aGVhZCB0ciIgKTsKCgkJCWlmICggY3JlYXRlICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy50YWJsZSApOwoJCQl9CgoJCQkvLyBFeHBvc2UgaGVhZGVycyBhbmQgYWxsSGVhZGVycyBwcm9wZXJ0aWVzIG9uIHRoZSB3aWRnZXQKCQkJLy8gaGVhZGVycyByZWZlcmVuY2VzIHRoZSBUSHMgd2l0aGluIHRoZSBmaXJzdCBUUiBpbiB0aGUgdGFibGUKCQkJc2VsZi5oZWFkZXJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0cjplcSgwKSIgKS5jaGlsZHJlbigpOwoKCQkJLy8gYWxsSGVhZGVycyByZWZlcmVuY2VzIGhlYWRlcnMsIHBsdXMgYWxsIFRIcyBpbiB0aGUgdGhlYWQsIHdoaWNoIG1heSBpbmNsdWRlIHNldmVyYWwgcm93cywgb3Igbm90CgkJCXNlbGYuYWxsSGVhZGVycyA9IHNlbGYuaGVhZGVycy5hZGQoIHRycy5jaGlsZHJlbigpICk7CgoJCQl0cnMuZWFjaChmdW5jdGlvbigpewoKCQkJCXZhciBjb2x0YWxseSA9IDA7CgoJCQkJJCggdGhpcyApLmNoaWxkcmVuKCkuZWFjaChmdW5jdGlvbiggaSApewoKCQkJCQl2YXIgc3BhbiA9IHBhcnNlSW50KCAkKCB0aGlzICkuYXR0ciggImNvbHNwYW4iICksIDEwICksCgkJCQkJCXNlbCA9ICI6bnRoLWNoaWxkKCIgKyAoIGNvbHRhbGx5ICsgMSApICsgIikiOwoJCQkJCSQoIHRoaXMgKQoJCQkJCQkuanFtRGF0YSggImNvbHN0YXJ0IiwgY29sdGFsbHkgKyAxICk7CgoJCQkJCWlmKCBzcGFuICl7CgkJCQkJCWZvciggdmFyIGogPSAwOyBqIDwgc3BhbiAtIDE7IGorKyApewoJCQkJCQkJY29sdGFsbHkrKzsKCQkJCQkJCXNlbCArPSAiLCA6bnRoLWNoaWxkKCIgKyAoIGNvbHRhbGx5ICsgMSApICsgIikiOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIGNyZWF0ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkkKHRoaXMpLmpxbURhdGEoImNlbGxzIiwgIiIpOwoJCQkJCX0KCQkJCQkvLyBTdG9yZSAiY2VsbHMiIGRhdGEgb24gaGVhZGVyIGFzIGEgcmVmZXJlbmNlIHRvIGFsbCBjZWxscyBpbiB0aGUgc2FtZSBjb2x1bW4gYXMgdGhpcyBUSAoJCQkJCSQoIHRoaXMgKQoJCQkJCQkuanFtRGF0YSggImNlbGxzIiwgc2VsZi5lbGVtZW50LmZpbmQoICJ0ciIgKS5ub3QoIHRycy5lcSgwKSApLm5vdCggdGhpcyApLmNoaWxkcmVuKCBzZWwgKSApOwoKCQkJCQljb2x0YWxseSsrOwoKCQkJCX0pOwoKCQkJfSk7CgoJCQkvLyB1cGRhdGUgdGFibGUgbW9kZXMKCQkJaWYgKCBjcmVhdGUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAncmVmcmVzaCcgKTsKCQkJfQoJfQoKfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5tb2RlID0gImNvbHVtbnRvZ2dsZSI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jb2x1bW5CdG5UaGVtZSA9IG51bGw7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jb2x1bW5Qb3B1cFRoZW1lID0gbnVsbDsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNvbHVtbkJ0blRleHQgPSAiQ29sdW1ucy4uLiI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzID0gJC5leHRlbmQoCgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLAoJewoJCXBvcHVwOiAidWktdGFibGUtY29sdW1udG9nZ2xlLXBvcHVwIiwKCQljb2x1bW5CdG46ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtYnRuIiwKCQlwcmlvcml0eVByZWZpeDogInVpLXRhYmxlLXByaW9yaXR5LSIsCgkJY29sdW1uVG9nZ2xlVGFibGU6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUiCgl9Cik7CgokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J3RhYmxlJykiLCAidGFibGVjcmVhdGUgcmVmcmVzaCIsIGZ1bmN0aW9uKCBlICkgewoJCgl2YXIgJHRhYmxlID0gJCggdGhpcyApLAoJCXNlbGYgPSAkdGFibGUuZGF0YSggIm1vYmlsZS10YWJsZSIgKSwKCQlldmVudCA9IGUudHlwZSwKCQlvID0gc2VsZi5vcHRpb25zLAoJCW5zID0gJC5tb2JpbGUubnMsCgkJaWQgPSAoICR0YWJsZS5hdHRyKCAiaWQiICkgfHwgby5jbGFzc2VzLnBvcHVwICkgKyAiLXBvcHVwIiwgLyogVE9ETyBCRVRURVIgRkFMTEJBQ0sgSUQgSEVSRSAqLwoJCSRtZW51QnV0dG9uLAoJCSRwb3B1cCwKCQkkbWVudSwKCQkkc3dpdGNoYm9hcmQ7CgoJaWYgKCBvLm1vZGUgIT09ICJjb2x1bW50b2dnbGUiICkgewoJCXJldHVybjsKCX0KCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMuY29sdW1uVG9nZ2xlVGFibGUgKTsKCQoJCSRtZW51QnV0dG9uID0gJCggIjxhIGhyZWY9JyMiICsgaWQgKyAiJyBjbGFzcz0nIiArIG8uY2xhc3Nlcy5jb2x1bW5CdG4gKyAiJyBkYXRhLSIgKyBucyArICJyZWw9J3BvcHVwJyBkYXRhLSIgKyBucyArICJtaW5pPSd0cnVlJz4iICsgby5jb2x1bW5CdG5UZXh0ICsgIjwvYT4iICksCgkJJHBvcHVwID0gJCggIjxkaXYgZGF0YS0iICsgbnMgKyAicm9sZT0ncG9wdXAnIGRhdGEtIiArIG5zICsgInJvbGU9J2ZpZWxkY29udGFpbicgY2xhc3M9JyIgKyBvLmNsYXNzZXMucG9wdXAgKyAiJyBpZD0nIiArIGlkICsgIic+PC9kaXY+IiksCgkJJG1lbnUgPSAkKCI8ZmllbGRzZXQgZGF0YS0iICsgbnMgKyAicm9sZT0nY29udHJvbGdyb3VwJz48L2ZpZWxkc2V0PiIpOwoJfQoJCgkvLyBjcmVhdGUgdGhlIGhpZGUvc2hvdyB0b2dnbGVzCglzZWxmLmhlYWRlcnMubm90KCAidGQiICkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJdmFyIHByaW9yaXR5ID0gJCggdGhpcyApLmpxbURhdGEoICJwcmlvcml0eSIgKSwKCQkJJGNlbGxzID0gJCggdGhpcyApLmFkZCggJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSApOwoKCQlpZiAoIHByaW9yaXR5ICkgewoKCQkJJGNlbGxzLmFkZENsYXNzKCBvLmNsYXNzZXMucHJpb3JpdHlQcmVmaXggKyBwcmlvcml0eSApOwoKCQkJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCQkJJCgiPGxhYmVsPjxpbnB1dCB0eXBlPSdjaGVja2JveCcgY2hlY2tlZCAvPiIgKyAkKCB0aGlzICkudGV4dCgpICsgIjwvbGFiZWw+IiApCgkJCQkJLmFwcGVuZFRvKCAkbWVudSApCgkJCQkJLmNoaWxkcmVuKCAwICkKCQkJCQkuanFtRGF0YSggImNlbGxzIiwgJGNlbGxzICkKCQkJCQkuY2hlY2tib3hyYWRpbyh7CgkJCQkJCXRoZW1lOiBvLmNvbHVtblBvcHVwVGhlbWUKCQkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCSQoICcjJyArIGlkICsgJyBmaWVsZHNldCBkaXY6ZXEoJyArIGkgKycpJykuZmluZCgnaW5wdXQnKS5qcW1EYXRhKCAnY2VsbHMnLCAkY2VsbHMgKTsKCQkJfQoJCX0KCX0pOwoJCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJJG1lbnUuYXBwZW5kVG8oICRwb3B1cCApOwoJfQoKCS8vIGJpbmQgY2hhbmdlIGV2ZW50IGxpc3RlbmVycyB0byBpbnB1dHMgLSBUT0RPOiBtb3ZlIHRvIGEgcHJpdmF0ZSBtZXRob2Q/CglpZiAoICRtZW51ID09PSB1bmRlZmluZWQgKSB7CgkJJHN3aXRjaGJvYXJkID0gJCgnIycgKyBpZCArICcgZmllbGRzZXQnKTsKCX0gZWxzZSB7CgkJJHN3aXRjaGJvYXJkID0gJG1lbnU7Cgl9CgoJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCSRzd2l0Y2hib2FyZC5vbiggImNoYW5nZSIsICJpbnB1dCIsIGZ1bmN0aW9uKCBlICl7CgkJCWlmKCB0aGlzLmNoZWNrZWQgKXsKCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiIgKS5hZGRDbGFzcyggInVpLXRhYmxlLWNlbGwtdmlzaWJsZSIgKTsKCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLXZpc2libGUiICkuYWRkQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiIgKTsKCQkJfQoJCX0pOwoKCQkkbWVudUJ1dHRvbgoJCQkuaW5zZXJ0QmVmb3JlKCAkdGFibGUgKQoJCQkuYnV0dG9uTWFya3VwKHsKCQkJCXRoZW1lOiBvLmNvbHVtbkJ0blRoZW1lCgkJCX0pOwoKCQkkcG9wdXAKCQkJLmluc2VydEJlZm9yZSggJHRhYmxlICkKCQkJLnBvcHVwKCk7Cgl9CgoJLy8gcmVmcmVzaCBtZXRob2QKCXNlbGYudXBkYXRlID0gZnVuY3Rpb24oKXsKCQkkc3dpdGNoYm9hcmQuZmluZCggImlucHV0IiApLmVhY2goIGZ1bmN0aW9uKCl7CgkJCWlmICh0aGlzLmNoZWNrZWQpIHsKCQkJCXRoaXMuY2hlY2tlZCA9ICQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkuZXEoMCkuY3NzKCAiZGlzcGxheSIgKSA9PT0gInRhYmxlLWNlbGwiOwoJCQkJaWYgKGV2ZW50ID09PSAicmVmcmVzaCIpIHsKCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLmFkZENsYXNzKCd1aS10YWJsZS1jZWxsLXZpc2libGUnKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkuYWRkQ2xhc3MoJ3VpLXRhYmxlLWNlbGwtaGlkZGVuJyk7CgkJCX0KCQkJJCggdGhpcyApLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJCX0pOwoJfTsKCgkkLm1vYmlsZS53aW5kb3cub24oICJ0aHJvdHRsZWRyZXNpemUiLCBzZWxmLnVwZGF0ZSApOwoKCXNlbGYudXBkYXRlKCk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMubW9kZSA9ICJyZWZsb3ciOwoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcyA9ICQuZXh0ZW5kKAoJJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcywKCXsKCQlyZWZsb3dUYWJsZTogInVpLXRhYmxlLXJlZmxvdyIsCgkJY2VsbExhYmVsczogInVpLXRhYmxlLWNlbGwtbGFiZWwiCgl9Cik7CgokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J3RhYmxlJykiLCAidGFibGVjcmVhdGUgcmVmcmVzaCIsIGZ1bmN0aW9uKCBlICkgewoKCXZhciAkdGFibGUgPSAkKCB0aGlzICksCgkJZXZlbnQgPSBlLnR5cGUsCgkJc2VsZiA9ICR0YWJsZS5kYXRhKCAibW9iaWxlLXRhYmxlIiApLAoJCW8gPSBzZWxmLm9wdGlvbnM7CgoJLy8gSWYgaXQncyBub3QgcmVmbG93IG1vZGUsIHJldHVybiBoZXJlLgoJaWYoIG8ubW9kZSAhPT0gInJlZmxvdyIgKXsKCQlyZXR1cm47Cgl9CgoJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLnJlZmxvd1RhYmxlICk7Cgl9CgoJLy8gZ2V0IGhlYWRlcnMgaW4gcmV2ZXJzZSBvcmRlciBzbyB0aGF0IHRvcC1sZXZlbCBoZWFkZXJzIGFyZSBhcHBlbmRlZCBsYXN0Cgl2YXIgcmV2ZXJzZUhlYWRlcnMgPSAgJCggc2VsZi5hbGxIZWFkZXJzLmdldCgpLnJldmVyc2UoKSApOwoKCS8vIGNyZWF0ZSB0aGUgaGlkZS9zaG93IHRvZ2dsZXMKCXJldmVyc2VIZWFkZXJzLmVhY2goZnVuY3Rpb24oIGkgKXsKCQl2YXIgJGNlbGxzID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSwKCQkJY29sc3RhcnQgPSAkKCB0aGlzICkuanFtRGF0YSggImNvbHN0YXJ0IiApLAoJCQloaWVyYXJjaHlDbGFzcyA9ICRjZWxscy5ub3QoIHRoaXMgKS5maWx0ZXIoICJ0aGVhZCB0aCIgKS5sZW5ndGggJiYgIiB1aS10YWJsZS1jZWxsLWxhYmVsLXRvcCIsCgkJCXRleHQgPSAkKHRoaXMpLnRleHQoKTsKCgkJCWlmKCB0ZXh0ICE9PSAiIiAgKXsKCgkJCQlpZiggaGllcmFyY2h5Q2xhc3MgKXsKCQkJCQl2YXIgaXRlcmF0aW9uID0gcGFyc2VJbnQoICQoIHRoaXMgKS5hdHRyKCAiY29sc3BhbiIgKSwgMTAgKSwKCQkJCQkJZmlsdGVyID0gIiI7CgoJCQkJCWlmKCBpdGVyYXRpb24gKXsKCQkJCQkJZmlsdGVyID0gInRkOm50aC1jaGlsZCgiKyBpdGVyYXRpb24gKyJuICsgIiArICggY29sc3RhcnQgKSArIikiOwoJCQkJCX0KCQkJCQkkY2VsbHMuZmlsdGVyKCBmaWx0ZXIgKS5wcmVwZW5kKCAiPGIgY2xhc3M9JyIgKyBvLmNsYXNzZXMuY2VsbExhYmVscyArIGhpZXJhcmNoeUNsYXNzICsgIic+IiArIHRleHQgKyAiPC9iPiIgICk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQkkY2VsbHMucHJlcGVuZCggIjxiIGNsYXNzPSciICsgby5jbGFzc2VzLmNlbGxMYWJlbHMgKyAiJz4iICsgdGV4dCArICI8L2I+IiAgKTsKCQkJCX0KCgkJCX0KCX0pOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCgkkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgPSB0cnVlOwoKCS8vIFRoaXMgZml4IGFkZHJlc3NlcyBhbiBpT1MgYnVnLCBzbyByZXR1cm4gZWFybHkgaWYgdGhlIFVBIGNsYWltcyBpdCdzIHNvbWV0aGluZyBlbHNlLgoJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCWlmKCAhKCAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgL09TIFsxLTVdX1swLTlfXSogbGlrZSBNYWMgT1MgWC9pLnRlc3QoIHVhICkgJiYgdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgKSApewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl2YXIgem9vbSA9ICQubW9iaWxlLnpvb20sCgkJZXZ0LCB4LCB5LCB6LCBhaWc7CgoJZnVuY3Rpb24gY2hlY2tUaWx0KCBlICkgewoJCWV2dCA9IGUub3JpZ2luYWxFdmVudDsKCQlhaWcgPSBldnQuYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eTsKCgkJeCA9IE1hdGguYWJzKCBhaWcueCApOwoJCXkgPSBNYXRoLmFicyggYWlnLnkgKTsKCQl6ID0gTWF0aC5hYnMoIGFpZy56ICk7CgoJCS8vIElmIHBvcnRyYWl0IG9yaWVudGF0aW9uIGFuZCBpbiBvbmUgb2YgdGhlIGRhbmdlciB6b25lcwoJCWlmICggIXdpbmRvdy5vcmllbnRhdGlvbiAmJiAoIHggPiA3IHx8ICggKCB6ID4gNiAmJiB5IDwgOCB8fCB6IDwgOCAmJiB5ID4gNiApICYmIHggPiA1ICkgKSApIHsKCQkJCWlmICggem9vbS5lbmFibGVkICkgewoJCQkJCXpvb20uZGlzYWJsZSgpOwoJCQkJfQoJCX0JZWxzZSBpZiAoICF6b29tLmVuYWJsZWQgKSB7CgkJCQl6b29tLmVuYWJsZSgpOwoJCX0KCX0KCgkkLm1vYmlsZS5kb2N1bWVudC5vbiggIm1vYmlsZWluaXQiLCBmdW5jdGlvbigpewoJCWlmKCAkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgKXsKCQkJJC5tb2JpbGUud2luZG93CgkJCQkuYmluZCggIm9yaWVudGF0aW9uY2hhbmdlLmlvc29yaWVudGF0aW9uZml4Iiwgem9vbS5lbmFibGUgKQoJCQkJLmJpbmQoICJkZXZpY2Vtb3Rpb24uaW9zb3JpZW50YXRpb25maXgiLCBjaGVja1RpbHQgKTsKCQl9Cgl9KTsKCn0oIGpRdWVyeSwgdGhpcyApKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIJJGh0bWwgPSAkKCAiaHRtbCIgKSwKCQkJJGhlYWQgPSAkKCAiaGVhZCIgKSwKCQkJJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKSB7CgkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoJfQoKCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gQWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gVGhpcyBpcyBhIGZhbGxiYWNrLiBJZiBhbnl0aGluZyBnb2VzIHdyb25nIChKUyBlcnJvcnMsIGV0YyksIG9yIGV2ZW50cyBkb24ndCBmaXJlLAoJLy8gdGhpcyBlbnN1cmVzIHRoZSByZW5kZXJpbmcgY2xhc3MgaXMgcmVtb3ZlZCBhZnRlciA1IHNlY29uZHMsIHNvIGNvbnRlbnQgaXMgdmlzaWJsZSBhbmQgYWNjZXNzaWJsZQoJc2V0VGltZW91dCggaGlkZVJlbmRlcmluZ0NsYXNzLCA1MDAwICk7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJCQkkcGFnZXMgPSAkKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKSwKCQkJCWhhc2ggPSBwYXRoLnN0cmlwSGFzaCggcGF0aC5zdHJpcFF1ZXJ5UGFyYW1zKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICksCgkJCQloYXNoUGFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBoYXNoICk7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzLmpxbURhdGEoICJ1cmwiICkgKSB7CgkJCQkJJHRoaXMuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsICR0aGlzLmF0dHIoICJpZCIgKSB8fCBsb2NhdGlvbi5wYXRobmFtZSArIGxvY2F0aW9uLnNlYXJjaCApOwoJCQkJfQoJCQl9KTsKCgkJCS8vIGRlZmluZSBmaXJzdCBwYWdlIGluIGRvbSBjYXNlIG9uZSBiYWNrcyBvdXQgdG8gdGhlIGRpcmVjdG9yeSByb290IChub3QgYWx3YXlzIHRoZSBmaXJzdCBwYWdlIHZpc2l0ZWQsIGJ1dCBkZWZpbmVkIGFzIGZhbGxiYWNrKQoJCQkkLm1vYmlsZS5maXJzdFBhZ2UgPSAkcGFnZXMuZmlyc3QoKTsKCgkJCS8vIGRlZmluZSBwYWdlIGNvbnRhaW5lcgoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyID0gJC5tb2JpbGUuZmlyc3RQYWdlLnBhcmVudCgpLmFkZENsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0IiApOwoKCQkJLy8gYWxlcnQgbGlzdGVuZXJzIHRoYXQgdGhlIHBhZ2Vjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCBmb3IgYmluZGluZwoJCQkvLyB0byBldmVudHMgdHJpZ2dlcmVkIG9uIGl0CgkJCSR3aW5kb3cudHJpZ2dlciggInBhZ2Vjb250YWluZXJjcmVhdGUiICk7CgoJCQkvLyBjdWUgcGFnZSBsb2FkaW5nIG1lc3NhZ2UKCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgoJCQkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCgkJCWhpZGVSZW5kZXJpbmdDbGFzcygpOwoKCQkJLy8gaWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQsIHRoZXJlJ3Mgbm8gaGFzaCBkZWVwbGluaywKCQkJLy8gdGhlIGhhc2ggaXMgbm90IHZhbGlkIChjb250YWlucyBtb3JlIHRoYW4gb25lICMgb3IgZG9lcyBub3Qgc3RhcnQgd2l0aCAjKQoJCQkvLyBvciB0aGVyZSBpcyBubyBwYWdlIHdpdGggdGhhdCBoYXNoLCBjaGFuZ2UgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIERPTQoJCQkvLyBSZW1lbWJlciwgaG93ZXZlciwgdGhhdCB0aGUgaGFzaCBjYW4gYWxzbyBiZSBhIHBhdGghCgkJCWlmICggISAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSggJCggaGFzaFBhZ2UgKS5pcyggJzpqcW1EYXRhKHJvbGU9InBhZ2UiKScgKSB8fAoJCQkJCSQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICkgfHwKCQkJCQloYXNoID09PSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgKSApIHsKCgkJCQkvLyBTdG9yZSB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbgoJCQkJaWYgKCAkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgKSB7CgkJCQkJJC5tb2JpbGUudXJsSGlzdG9yeS5pbml0aWFsRHN0ID0gaGFzaC5yZXBsYWNlKCAiIyIsICIiICk7CgkJCQl9CgoJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCBpbml0aWFsIHBvcHN0YXRlIHN0YXRlIGlmIGl0IGV4aXN0cwoJCQkJLy8gc28gdGhhdCBuYXZpZ2F0aW9uIGJhY2sgdG8gdGhlIGluaXRpYWwgcGFnZSB3b3JrcyBwcm9wZXJseQoJCQkJaWYoICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3Iuc3F1YXNoKCBwYXRoLnBhcnNlTG9jYXRpb24oKS5ocmVmICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7CgkJCQkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCQkJCXJldmVyc2U6IHRydWUsCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJLy8gdHJpZ2dlciBoYXNoY2hhbmdlIG9yIG5hdmlnYXRlIHRvIHNxdWFzaCBhbmQgcmVjb3JkIHRoZSBjb3JyZWN0CgkJCQkvLyBoaXN0b3J5IGVudHJ5IGZvciBhbiBpbml0aWFsIGhhc2ggcGF0aAoJCQkJaWYoICEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQkJJHdpbmRvdy50cmlnZ2VyKCAiaGFzaGNoYW5nZSIsIFt0cnVlXSApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBUT0RPIGZpZ3VyZSBvdXQgaG93IHRvIHNpbXBsaWZ5IHRoaXMgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5pdGlhbCBoaXN0b3J5IGVudHJ5CgkJCQkJLy8gYXQgdGhlIGJvdHRvbSBqcy9uYXZpZ2F0ZS9uYXZpZ2F0ZS5qcwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnkuc3RhY2sgPSBbXTsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZSggJC5tb2JpbGUucGF0aC5pc1BhdGgoIGxvY2F0aW9uLmhhc2ggKSA/IGxvY2F0aW9uLmhhc2ggOiBsb2NhdGlvbi5ocmVmICk7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCgkvLyBpbml0aWFsaXplIGV2ZW50cyBub3csIGFmdGVyIG1vYmlsZWluaXQgaGFzIG9jY3VycmVkCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkLnJlc29sdmUoKTsKCgkvLyBjaGVjayB3aGljaCBzY3JvbGxUb3AgdmFsdWUgc2hvdWxkIGJlIHVzZWQgYnkgc2Nyb2xsaW5nIHRvIDEgaW1tZWRpYXRlbHkgYXQgZG9tcmVhZHkKCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkvLyBub3RlIHRoYXQgdGhpcyBpbml0aWFsIHNjcm9sbCB3b24ndCBoaWRlIHRoZSBhZGRyZXNzIGJhci4gSXQncyBqdXN0IGZvciB0aGUgY2hlY2suCgkkKGZ1bmN0aW9uKCkgewoJCXdpbmRvdy5zY3JvbGxUbyggMCwgMSApOwoKCQkvLyBpZiBkZWZhdWx0SG9tZVNjcm9sbCBoYXNuJ3QgYmVlbiBzZXQgeWV0LCBzZWUgaWYgc2Nyb2xsVG9wIGlzIDEKCQkvLyBpdCBzaG91bGQgYmUgMSBpbiBtb3N0IGJyb3dzZXJzLCBidXQgYW5kcm9pZCB0cmVhdHMgMSBhcyAwIChmb3IgaGlkaW5nIGFkZHIgYmFyKQoJCS8vIHNvIGlmIGl0J3MgMSwgdXNlIDAgZnJvbSBub3cgb24KCQkkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA9ICggISQuc3VwcG9ydC5zY3JvbGxUb3AgfHwgJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpID09PSAxICkgPyAwIDogMTsKCgkJLy9kb20tcmVhZHkgaW5pdHMKCQlpZiAoICQubW9iaWxlLmF1dG9Jbml0aWFsaXplUGFnZSApIHsKCQkJJC5tb2JpbGUuaW5pdGlhbGl6ZVBhZ2UoKTsKCQl9CgoJCS8vIHdpbmRvdyBsb2FkIGV2ZW50CgkJLy8gaGlkZSBpT1MgYnJvd3NlciBjaHJvbWUgb24gbG9hZAoJCSR3aW5kb3cubG9hZCggJC5tb2JpbGUuc2lsZW50U2Nyb2xsICk7CgoJCWlmICggISQuc3VwcG9ydC5jc3NQb2ludGVyRXZlbnRzICkgewoJCQkvLyBJRSBhbmQgT3BlcmEgZG9uJ3Qgc3VwcG9ydCBDU1MgcG9pbnRlci1ldmVudHM6IG5vbmUgdGhhdCB3ZSB1c2UgdG8gZGlzYWJsZSBsaW5rLWJhc2VkIGJ1dHRvbnMKCQkJLy8gYnkgYWRkaW5nIHRoZSAndWktZGlzYWJsZWQnIGNsYXNzIHRvIHRoZW0uIFVzaW5nIGEgSmF2YVNjcmlwdCB3b3JrYXJvdW5kIGZvciB0aG9zZSBicm93c2VyLgoJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NTgKCgkJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiLnVpLWRpc2FibGVkIiwgInZjbGljayIsCgkJCQlmdW5jdGlvbiggZSApIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJKTsKCQl9Cgl9KTsKfSggalF1ZXJ5LCB0aGlzICkpOwoKCn0pKTsK",
                "body": "LyoKKiBqUXVlcnkgTW9iaWxlIDEuMy4xCiogR2l0IEhFQUQgaGFzaDogNzRiNGJlYzA0OWZkOTNlNGZlNDAyMDVlNjE1N2RlMTZlYjY0ZWI0NiA8PiBEYXRlOiBXZWQgQXByIDEwIDIwMTMgMjE6NTc6MjMgVVRDCiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDEwLCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgoKCihmdW5jdGlvbiAoIHJvb3QsIGRvYywgZmFjdG9yeSApIHsKCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlkZWZpbmUoIFsgImpxdWVyeSIgXSwgZnVuY3Rpb24gKCAkICkgewoJCQlmYWN0b3J5KCAkLCByb290LCBkb2MgKTsKCQkJcmV0dXJuICQubW9iaWxlOwoJCX0pOwoJfSBlbHNlIHsKCQkvLyBCcm93c2VyIGdsb2JhbHMKCQlmYWN0b3J5KCByb290LmpRdWVyeSwgcm9vdCwgZG9jICk7Cgl9Cn0oIHRoaXMsIGRvY3VtZW50LCBmdW5jdGlvbiAoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewooZnVuY3Rpb24oICQgKSB7CgkkLm1vYmlsZSA9IHt9Owp9KCBqUXVlcnkgKSk7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgbnNOb3JtYWxpemVEaWN0ID0ge307CgoJLy8galF1ZXJ5Lm1vYmlsZSBjb25maWd1cmFibGUgb3B0aW9ucwoJJC5tb2JpbGUgPSAkLmV4dGVuZCgkLm1vYmlsZSwgewoKCQkvLyBWZXJzaW9uIG9mIHRoZSBqUXVlcnkgTW9iaWxlIEZyYW1ld29yawoJCXZlcnNpb246ICIxLjMuMSIsCgoJCS8vIE5hbWVzcGFjZSB1c2VkIGZyYW1ld29yay13aWRlIGZvciBkYXRhLWF0dHJzLiBEZWZhdWx0IGlzIG5vIG5hbWVzcGFjZQoJCW5zOiAiIiwKCgkJLy8gRGVmaW5lIHRoZSB1cmwgcGFyYW1ldGVyIHVzZWQgZm9yIHJlZmVyZW5jaW5nIHdpZGdldC1nZW5lcmF0ZWQgc3ViLXBhZ2VzLgoJCS8vIFRyYW5zbGF0ZXMgdG8gdG8gZXhhbXBsZS5odG1sJnVpLXBhZ2U9c3VicGFnZUlkZW50aWZpZXIKCQkvLyBoYXNoIHNlZ21lbnQgYmVmb3JlICZ1aS1wYWdlPSBpcyB1c2VkIHRvIG1ha2UgQWpheCByZXF1ZXN0CgkJc3ViUGFnZVVybEtleTogInVpLXBhZ2UiLAoKCQkvLyBDbGFzcyBhc3NpZ25lZCB0byBwYWdlIGN1cnJlbnRseSBpbiB2aWV3LCBhbmQgZHVyaW5nIHRyYW5zaXRpb25zCgkJYWN0aXZlUGFnZUNsYXNzOiAidWktcGFnZS1hY3RpdmUiLAoKCQkvLyBDbGFzcyB1c2VkIGZvciAiYWN0aXZlIiBidXR0b24gc3RhdGUsIGZyb20gQ1NTIGZyYW1ld29yawoJCWFjdGl2ZUJ0bkNsYXNzOiAidWktYnRuLWFjdGl2ZSIsCgoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQltaW5TY3JvbGxCYWNrOiAyNTAsCgoJCS8vIERFUFJFQ0FURUQ6IHRoZSBmb2xsb3dpbmcgcHJvcGVydHkgaXMgbm8gbG9uZ2VyIGluIHVzZSwgYnV0IGRlZmluZWQgdW50aWwgMi4wIHRvIHByZXZlbnQgY29uZmxpY3RzCgkJdG91Y2hPdmVyZmxvd0VuYWJsZWQ6IGZhbHNlLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZXM/CgkJcGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZTogImUiLAoKCQkvLyByZXBsYWNlIGNhbGxzIHRvIHdpbmRvdy5oaXN0b3J5LmJhY2sgd2l0aCBwaG9uZWdhcHMgbmF2aWdhdGlvbiBoZWxwZXIKCQkvLyB3aGVyZSBpdCBpcyBwcm92aWRlZCBvbiB0aGUgd2luZG93IG9iamVjdAoJCXBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQ6IGZhbHNlLAoKCQkvL2F1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgRE9NIHdoZW4gaXQncyByZWFkeQoJCWF1dG9Jbml0aWFsaXplUGFnZTogdHJ1ZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gYWxsb3dzIHVzZXJzIHRvIG9wdCBpbiB0byBpZ25vcmluZyBjb250ZW50IGJ5IG1hcmtpbmcgYSBwYXJlbnQgZWxlbWVudCBhcwoJCS8vIGRhdGEtaWdub3JlZAoJCWlnbm9yZUNvbnRlbnRFbmFibGVkOiBmYWxzZSwKCgkJLy8gdHVybiBvZiBiaW5kaW5nIHRvIHRoZSBuYXRpdmUgb3JpZW50YXRpb25jaGFuZ2UgZHVlIHRvIGFuZHJvaWQgb3JpZW50YXRpb24gYmVoYXZpb3IKCQlvcmllbnRhdGlvbkNoYW5nZUVuYWJsZWQ6IHRydWUsCgoJCWJ1dHRvbk1hcmt1cDogewoJCQlob3ZlckRlbGF5OiAyMDAKCQl9LAoKCQkvLyBkZWZpbmUgdGhlIHdpbmRvdyBhbmQgdGhlIGRvY3VtZW50IG9iamVjdHMKCQl3aW5kb3c6ICQoIHdpbmRvdyApLAoJCWRvY3VtZW50OiAkKCBkb2N1bWVudCApLAoKCQkvLyBUT0RPIG1pZ2h0IGJlIHVzZWZ1bCB1cHN0cmVhbSBpbiBqcXVlcnkgaXRzZWxmID8KCQlrZXlDb2RlOiB7CgkJCUFMVDogMTgsCgkJCUJBQ0tTUEFDRTogOCwKCQkJQ0FQU19MT0NLOiAyMCwKCQkJQ09NTUE6IDE4OCwKCQkJQ09NTUFORDogOTEsCgkJCUNPTU1BTkRfTEVGVDogOTEsIC8vIENPTU1BTkQKCQkJQ09NTUFORF9SSUdIVDogOTMsCgkJCUNPTlRST0w6IDE3LAoJCQlERUxFVEU6IDQ2LAoJCQlET1dOOiA0MCwKCQkJRU5EOiAzNSwKCQkJRU5URVI6IDEzLAoJCQlFU0NBUEU6IDI3LAoJCQlIT01FOiAzNiwKCQkJSU5TRVJUOiA0NSwKCQkJTEVGVDogMzcsCgkJCU1FTlU6IDkzLCAvLyBDT01NQU5EX1JJR0hUCgkJCU5VTVBBRF9BREQ6IDEwNywKCQkJTlVNUEFEX0RFQ0lNQUw6IDExMCwKCQkJTlVNUEFEX0RJVklERTogMTExLAoJCQlOVU1QQURfRU5URVI6IDEwOCwKCQkJTlVNUEFEX01VTFRJUExZOiAxMDYsCgkJCU5VTVBBRF9TVUJUUkFDVDogMTA5LAoJCQlQQUdFX0RPV046IDM0LAoJCQlQQUdFX1VQOiAzMywKCQkJUEVSSU9EOiAxOTAsCgkJCVJJR0hUOiAzOSwKCQkJU0hJRlQ6IDE2LAoJCQlTUEFDRTogMzIsCgkJCVRBQjogOSwKCQkJVVA6IDM4LAoJCQlXSU5ET1dTOiA5MSAvLyBDT01NQU5ECgkJfSwKCgkJLy8gUGxhY2UgdG8gc3RvcmUgdmFyaW91cyB3aWRnZXQgZXh0ZW5zaW9ucwoJCWJlaGF2aW9yczoge30sCgoJCS8vIFNjcm9sbCBwYWdlIHZlcnRpY2FsbHk6IHNjcm9sbCB0byAwIHRvIGhpZGUgaU9TIGFkZHJlc3MgYmFyLCBvciBwYXNzIGEgWSB2YWx1ZQoJCXNpbGVudFNjcm9sbDogZnVuY3Rpb24oIHlwb3MgKSB7CgkJCWlmICggJC50eXBlKCB5cG9zICkgIT09ICJudW1iZXIiICkgewoJCQkJeXBvcyA9ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCQl9CgoJCQkvLyBwcmV2ZW50IHNjcm9sbHN0YXJ0IGFuZCBzY3JvbGxzdG9wIGV2ZW50cwoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHlwb3MgKTsKCQkJCSQubW9iaWxlLmRvY3VtZW50LnRyaWdnZXIoICJzaWxlbnRzY3JvbGwiLCB7IHg6IDAsIHk6IHlwb3MgfSk7CgkJCX0sIDIwICk7CgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJaWYgKCAhcHJvcCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8ICggbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gPSAkLmNhbWVsQ2FzZSggJC5tb2JpbGUubnMgKyBwcm9wICkgKTsKCQl9LAoKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCgkJCXdoaWxlICggZSApIHsKCQkJCWMgPSBlLmNsYXNzTmFtZSB8fCAiIjsKCQkJCWlmICggYyAmJiAoIG0gPSByZS5leGVjKCBjICkgKSAmJiAoIGx0ciA9IG1bIDIgXSApICkgewoJCQkJCS8vIFdlIGZvdW5kIGEgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcwoJCQkJCS8vIG9uIGl0IHNvIGJhaWwgZnJvbSB0aGlzIGxvb3AuCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJfQoKCQkJLy8gUmV0dXJuIHRoZSB0aGVtZSBsZXR0ZXIgd2UgZm91bmQsIGlmIG5vbmUsIHJldHVybiB0aGUKCQkJLy8gc3BlY2lmaWVkIGRlZmF1bHQuCgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJLy8gVE9ETyB0aGUgZm9sbG93aW5nICQgYW5kICQuZm4gZXh0ZW5zaW9ucyBjYW4vcHJvYmFibHkgc2hvdWxkIGJlIG1vdmVkIGludG8ganF1ZXJ5Lm1vYmlsZS5jb3JlLmhlbHBlcnMKCQkvLwoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgamF2YXNjcmlwdCBwYWdlIGVsZW1lbnQgdG8gZ2F0aGVyIHNldHRpbmdzIGRhdGEganNwZXJmIHRlc3QKCQkvLyBodHRwOi8vanNwZXJmLmNvbS9zaW5nbGUtY29tcGxleC1zZWxlY3Rvci12cy1tYW55LWNvbXBsZXgtc2VsZWN0b3JzL2VkaXQKCQkvLyBwb3NzaWJseSBuYWl2ZSwgYnV0IGl0IHNob3dzIHRoYXQgdGhlIHBhcnNpbmcgb3ZlcmhlYWQgZm9yICpqdXN0KiB0aGUgcGFnZSBzZWxlY3RvciB2cwoJCS8vIHRoZSBwYWdlIGFuZCBkaWFsb2cgc2VsZWN0b3IgaXMgbmVnbGlnYWJsZS4gVGhpcyBjb3VsZCBwcm9iYWJseSBiZSBzcGVlZCB1cCBieQoJCS8vIGRvaW5nIGEgc2ltaWxhciBwYXJlbnQgbm9kZSB0cmF2ZXJzYWwgdG8gdGhlIG9uZSBmb3VuZCBpbiB0aGUgaW5oZXJpdGVkIHRoZW1lIGNvZGUgYWJvdmUKCQljbG9zZXN0UGFnZURhdGE6IGZ1bmN0aW9uKCAkdGFyZ2V0ICkgewoJCQlyZXR1cm4gJHRhcmdldAoJCQkJLmNsb3Nlc3QoICc6anFtRGF0YShyb2xlPSJwYWdlIiksIDpqcW1EYXRhKHJvbGU9ImRpYWxvZyIpJyApCgkJCQkuZGF0YSggIm1vYmlsZS1wYWdlIiApOwoJCX0sCgoJCWVuaGFuY2VhYmxlOiBmdW5jdGlvbiggJHNldCApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoICRzZXQsICJlbmhhbmNlIiApOwoJCX0sCgoJCWhpamFja2FibGU6IGZ1bmN0aW9uKCAkc2V0ICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggJHNldCwgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCAkc2V0LCBhdHRyICkgewoJCQlpZiAoICEkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCApIHsKCQkJCXJldHVybiAkc2V0OwoJCQl9CgoJCQl2YXIgY291bnQgPSAkc2V0Lmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQ7CgoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSAkc2V0LmVxKCBpICk7CgkJCQlleGNsdWRlZCA9IGZhbHNlOwoJCQkJZSA9ICRzZXRbIGkgXTsKCgkJCQl3aGlsZSAoIGUgKSB7CgkJCQkJdmFyIGMgPSBlLmdldEF0dHJpYnV0ZSA/IGUuZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBhdHRyICkgOiAiIjsKCgkJCQkJaWYgKCBjID09PSAiZmFsc2UiICkgewoJCQkJCQlleGNsdWRlZCA9IHRydWU7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCgkJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJCX0KCgkJCQlpZiAoICFleGNsdWRlZCApIHsKCQkJCQkkbmV3U2V0ID0gJG5ld1NldC5hZGQoICRlbGVtZW50ICk7CgkJCQl9CgkJCX0KCgkJCXJldHVybiAkbmV3U2V0OwoJCX0sCgoJCWdldFNjcmVlbkhlaWdodDogZnVuY3Rpb24oKSB7CgkJCS8vIE5hdGl2ZSBpbm5lckhlaWdodCByZXR1cm5zIG1vcmUgYWNjdXJhdGUgdmFsdWUgZm9yIHRoaXMgYWNyb3NzIHBsYXRmb3JtcywKCQkJLy8galF1ZXJ5IHZlcnNpb24gaXMgaGVyZSBhcyBhIG5vcm1hbGl6ZWQgZmFsbGJhY2sgZm9yIHBsYXRmb3JtcyBsaWtlIFN5bWJpYW4KCQkJcmV0dXJuIHdpbmRvdy5pbm5lckhlaWdodCB8fCAkLm1vYmlsZS53aW5kb3cuaGVpZ2h0KCk7CgkJfQoJfSwgJC5tb2JpbGUgKTsKCgkvLyBNb2JpbGUgdmVyc2lvbiBvZiBkYXRhIGFuZCByZW1vdmVEYXRhIGFuZCBoYXNEYXRhIG1ldGhvZHMKCS8vIGVuc3VyZXMgYWxsIGRhdGEgaXMgc2V0IGFuZCByZXRyaWV2ZWQgdXNpbmcgalF1ZXJ5IE1vYmlsZSdzIGRhdGEgbmFtZXNwYWNlCgkkLmZuLmpxbURhdGEgPSBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJaWYgKCBwcm9wICkgewoJCQkJcHJvcCA9ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICk7CgkJCX0KCgkJCS8vIHVuZGVmaW5lZCBpcyBwZXJtaXR0ZWQgYXMgYW4gZXhwbGljaXQgaW5wdXQgZm9yIHRoZSBzZWNvbmQgcGFyYW0KCQkJLy8gaW4gdGhpcyBjYXNlIGl0IHJldHVybnMgdGhlIHZhbHVlIGFuZCBkb2VzIG5vdCBzZXQgaXQgdG8gdW5kZWZpbmVkCgkJCWlmKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICl7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AgKTsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCwgdmFsdWUgKTsKCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmpxbURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gJC5kYXRhKCBlbGVtLCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuZm4uanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBwcm9wICkgewoJCXJldHVybiB0aGlzLnJlbW92ZURhdGEoICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AgKSB7CgkJcmV0dXJuICQucmVtb3ZlRGF0YSggZWxlbSwgJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmZuLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oKSB7CgkJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyggdGhpcyApOwoJfTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyICRlbGVtID0gJCggZWxlbSApOwoKCQkoICRlbGVtLmpxbURhdGEoICdkZXBlbmRlbnRzJyApIHx8ICQoKSApLnJlbW92ZSgpOwoJCSRlbGVtLnJlbW92ZSgpOwoJfTsKCgkkLmZuLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggbmV3RGVwZW5kZW50cyApIHsKCQkkLmFkZERlcGVuZGVudHMoICQoIHRoaXMgKSwgbmV3RGVwZW5kZW50cyApOwoJfTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgZGVwZW5kZW50cyA9ICQoIGVsZW0gKS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCk7CgoJCSQoIGVsZW0gKS5qcW1EYXRhKCAnZGVwZW5kZW50cycsICQubWVyZ2UoIGRlcGVuZGVudHMsIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkvLyBub3RlIHRoYXQgdGhpcyBoZWxwZXIgZG9lc24ndCBhdHRlbXB0IHRvIGhhbmRsZSB0aGUgY2FsbGJhY2sKCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50J3MgdGV4dCwgaXRzIG9ubHkgcHVycG9zZSBpcwoJLy8gdG8gcmV0dXJuIHRoZSBodG1sIGVuY29kZWQgdmVyc2lvbiBvZiB0aGUgdGV4dCBpbiBhbGwgY2FzZXMuICh0aHVzIHRoZSBuYW1lKQoJJC5mbi5nZXRFbmNvZGVkVGV4dCA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApLnRleHQoICQoIHRoaXMgKS50ZXh0KCkgKS5odG1sKCk7Cgl9OwoKCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkkLmZuLmpxbUVuaGFuY2VhYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmVuaGFuY2VhYmxlKCB0aGlzICk7Cgl9OwoKCSQuZm4uanFtSGlqYWNrYWJsZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5oaWphY2thYmxlKCB0aGlzICk7Cgl9OwoKCS8vIE1vbmtleS1wYXRjaGluZyBTaXp6bGUgdG8gZmlsdGVyIHRoZSA6anFtRGF0YSBzZWxlY3RvcgoJdmFyIG9sZEZpbmQgPSAkLmZpbmQsCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKCSQuZmluZC5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIHNldCApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKCX07CgoJJC5maW5kLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBub2RlLCBleHByICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIFsgbm9kZSBdICkubGVuZ3RoID4gMDsKCX07Cn0pKCBqUXVlcnksIHRoaXMgKTsKCgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCB2MS4xMC4wcHJlIC0gMjAxMi0xMS0xMyAoZmYwNTVhMGMzNTNjM2M4Y2U2ZTViZmEwN2FkN2NiMDNlODg4NWJjNSkKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgMjAxMCwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9qUXVlcnkud2lkZ2V0LwogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdXVpZCA9IDAsCglzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKCV9jbGVhbkRhdGEgPSAkLmNsZWFuRGF0YTsKJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7Cglmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQl0cnkgewoJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODIzNQoJCX0gY2F0Y2goIGUgKSB7fQoJfQoJX2NsZWFuRGF0YSggZWxlbXMgKTsKfTsKCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBmdWxsTmFtZSwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgY29uc3RydWN0b3IsIGJhc2VQcm90b3R5cGUsCgkJbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lLnRvTG93ZXJDYXNlKCkgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgZnVsbE5hbWUgKTsKCX07CgoJJFsgbmFtZXNwYWNlIF0gPSAkWyBuYW1lc3BhY2UgXSB8fCB7fTsKCWV4aXN0aW5nQ29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdOwoJY29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0ICJuZXciIGtleXdvcmQKCQlpZiAoICF0aGlzLl9jcmVhdGVXaWRnZXQgKSB7CgkJCXJldHVybiBuZXcgY29uc3RydWN0b3IoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9CgoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCS8vIG11c3QgdXNlICJuZXciIGtleXdvcmQgKHRoZSBjb2RlIGFib3ZlIGFsd2F5cyBwYXNzZXMgYXJncykKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCX07CgkvLyBleHRlbmQgd2l0aCB0aGUgZXhpc3RpbmcgY29uc3RydWN0b3IgdG8gY2Fycnkgb3ZlciBhbnkgc3RhdGljIHByb3BlcnRpZXMKCSQuZXh0ZW5kKCBjb25zdHJ1Y3RvciwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgewoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLAoJCS8vIGNvcHkgdGhlIG9iamVjdCB1c2VkIHRvIGNyZWF0ZSB0aGUgcHJvdG90eXBlIGluIGNhc2Ugd2UgbmVlZCB0bwoJCS8vIHJlZGVmaW5lIHRoZSB3aWRnZXQgbGF0ZXIKCQlfcHJvdG86ICQuZXh0ZW5kKCB7fSwgcHJvdG90eXBlICksCgkJLy8gdHJhY2sgd2lkZ2V0cyB0aGF0IGluaGVyaXQgZnJvbSB0aGlzIHdpZGdldCBpbiBjYXNlIHRoaXMgd2lkZ2V0IGlzCgkJLy8gcmVkZWZpbmVkIGFmdGVyIGEgd2lkZ2V0IGluaGVyaXRzIGZyb20gaXQKCQlfY2hpbGRDb25zdHJ1Y3RvcnM6IFtdCgl9KTsKCgliYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCS8vIHdlIG5lZWQgdG8gbWFrZSB0aGUgb3B0aW9ucyBoYXNoIGEgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIG5ldyBpbnN0YW5jZQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQoJLy8gaW5oZXJpdGluZyBmcm9tCgliYXNlUHJvdG90eXBlLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LCBiYXNlUHJvdG90eXBlLm9wdGlvbnMgKTsKCSQuZWFjaCggcHJvdG90eXBlLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJaWYgKCAkLmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXByb3RvdHlwZVsgcHJvcCBdID0gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIF9zdXBlciA9IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQkJfSwKCQkJCQlfc3VwZXJBcHBseSA9IGZ1bmN0aW9uKCBhcmdzICkgewoJCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJncyApOwoJCQkJCX07CgkJCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCQkJdmFyIF9fc3VwZXIgPSB0aGlzLl9zdXBlciwKCQkJCQkJX19zdXBlckFwcGx5ID0gdGhpcy5fc3VwZXJBcHBseSwKCQkJCQkJcmV0dXJuVmFsdWU7CgoJCQkJCXRoaXMuX3N1cGVyID0gX3N1cGVyOwoJCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfc3VwZXJBcHBseTsKCgkJCQkJcmV0dXJuVmFsdWUgPSB2YWx1ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCQkJCXRoaXMuX3N1cGVyID0gX19zdXBlcjsKCQkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX19zdXBlckFwcGx5OwoKCQkJCQlyZXR1cm4gcmV0dXJuVmFsdWU7CgkJCQl9OwoJCQl9KSgpOwoJCX0KCX0pOwoJY29uc3RydWN0b3IucHJvdG90eXBlID0gJC53aWRnZXQuZXh0ZW5kKCBiYXNlUHJvdG90eXBlLCB7CgkJLy8gVE9ETzogcmVtb3ZlIHN1cHBvcnQgZm9yIHdpZGdldEV2ZW50UHJlZml4CgkJLy8gYWx3YXlzIHVzZSB0aGUgbmFtZSArIGEgY29sb24gYXMgdGhlIHByZWZpeCwgZS5nLiwgZHJhZ2dhYmxlOnN0YXJ0CgkJLy8gZG9uJ3QgcHJlZml4IGZvciB3aWRnZXRzIHRoYXQgYXJlbid0IERPTS1iYXNlZAoJCXdpZGdldEV2ZW50UHJlZml4OiBleGlzdGluZ0NvbnN0cnVjdG9yID8gYmFzZVByb3RvdHlwZS53aWRnZXRFdmVudFByZWZpeCA6IG5hbWUKCX0sIHByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSk7CgoJLy8gSWYgdGhpcyB3aWRnZXQgaXMgYmVpbmcgcmVkZWZpbmVkIHRoZW4gd2UgbmVlZCB0byBmaW5kIGFsbCB3aWRnZXRzIHRoYXQKCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20KCS8vIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGlzIHdpZGdldC4gV2UncmUgZXNzZW50aWFsbHkgdHJ5aW5nIHRvIHJlcGxhY2Ugb25lCgkvLyBsZXZlbCBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgewoJCSQuZWFjaCggZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnMsIGZ1bmN0aW9uKCBpLCBjaGlsZCApIHsKCQkJdmFyIGNoaWxkUHJvdG90eXBlID0gY2hpbGQucHJvdG90eXBlOwoKCQkJLy8gcmVkZWZpbmUgdGhlIGNoaWxkIHdpZGdldCB1c2luZyB0aGUgc2FtZSBwcm90b3R5cGUgdGhhdCB3YXMKCQkJLy8gb3JpZ2luYWxseSB1c2VkLCBidXQgaW5oZXJpdCBmcm9tIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUgYmFzZQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsIGNoaWxkLl9wcm90byApOwoJCX0pOwoJCS8vIHJlbW92ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjaGlsZCBjb25zdHJ1Y3RvcnMgZnJvbSB0aGUgb2xkIGNvbnN0cnVjdG9yCgkJLy8gc28gdGhlIG9sZCBjaGlsZCBjb25zdHJ1Y3RvcnMgY2FuIGJlIGdhcmJhZ2UgY29sbGVjdGVkCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOwoJfSBlbHNlIHsKCQliYXNlLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKCBjb25zdHJ1Y3RvciApOwoJfQoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgY29uc3RydWN0b3IgKTsKfTsKCiQud2lkZ2V0LmV4dGVuZCA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7Cgl2YXIgaW5wdXQgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQlpbnB1dEluZGV4ID0gMCwKCQlpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aCwKCQlrZXksCgkJdmFsdWU7Cglmb3IgKCA7IGlucHV0SW5kZXggPCBpbnB1dExlbmd0aDsgaW5wdXRJbmRleCsrICkgewoJCWZvciAoIGtleSBpbiBpbnB1dFsgaW5wdXRJbmRleCBdICkgewoJCQl2YWx1ZSA9IGlucHV0WyBpbnB1dEluZGV4IF1bIGtleSBdOwoJCQlpZiAoIGlucHV0WyBpbnB1dEluZGV4IF0uaGFzT3duUHJvcGVydHkoIGtleSApICYmIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkvLyBDbG9uZSBvYmplY3RzCgkJCQlpZiAoICQuaXNQbGFpbk9iamVjdCggdmFsdWUgKSApIHsKCQkJCQl0YXJnZXRbIGtleSBdID0gJC5pc1BsYWluT2JqZWN0KCB0YXJnZXRbIGtleSBdICkgPwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB0YXJnZXRbIGtleSBdLCB2YWx1ZSApIDoKCQkJCQkJLy8gRG9uJ3QgZXh0ZW5kIHN0cmluZ3MsIGFycmF5cywgZXRjLiB3aXRoIG9iamVjdHMKCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdmFsdWUgKTsKCQkJCS8vIENvcHkgZXZlcnl0aGluZyBlbHNlIGJ5IHJlZmVyZW5jZQoJCQkJfSBlbHNlIHsKCQkJCQl0YXJnZXRbIGtleSBdID0gdmFsdWU7CgkJCQl9CgkJCX0KCQl9Cgl9CglyZXR1cm4gdGFyZ2V0Owp9OwoKJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsKCXZhciBmdWxsTmFtZSA9IG9iamVjdC5wcm90b3R5cGUud2lkZ2V0RnVsbE5hbWUgfHwgbmFtZTsKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpc01ldGhvZENhbGwgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIsCgkJCWFyZ3MgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQkJcmV0dXJuVmFsdWUgPSB0aGlzOwoKCQkvLyBhbGxvdyBtdWx0aXBsZSBoYXNoZXMgdG8gYmUgcGFzc2VkIG9uIGluaXQKCQlvcHRpb25zID0gIWlzTWV0aG9kQ2FsbCAmJiBhcmdzLmxlbmd0aCA/CgkJCSQud2lkZ2V0LmV4dGVuZC5hcHBseSggbnVsbCwgWyBvcHRpb25zIF0uY29uY2F0KGFyZ3MpICkgOgoJCQlvcHRpb25zOwoKCQlpZiAoIGlzTWV0aG9kQ2FsbCApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIG1ldGhvZFZhbHVlLAoJCQkJCWluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCAhaW5zdGFuY2UgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJjYW5ub3QgY2FsbCBtZXRob2RzIG9uICIgKyBuYW1lICsgIiBwcmlvciB0byBpbml0aWFsaXphdGlvbjsgIiArCgkJCQkJCSJhdHRlbXB0ZWQgdG8gY2FsbCBtZXRob2QgJyIgKyBvcHRpb25zICsgIiciICk7CgkJCQl9CgkJCQlpZiAoICEkLmlzRnVuY3Rpb24oIGluc3RhbmNlW29wdGlvbnNdICkgfHwgb3B0aW9ucy5jaGFyQXQoIDAgKSA9PT0gIl8iICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAibm8gc3VjaCBtZXRob2QgJyIgKyBvcHRpb25zICsgIicgZm9yICIgKyBuYW1lICsgIiB3aWRnZXQgaW5zdGFuY2UiICk7CgkJCQl9CgkJCQltZXRob2RWYWx1ZSA9IGluc3RhbmNlWyBvcHRpb25zIF0uYXBwbHkoIGluc3RhbmNlLCBhcmdzICk7CgkJCQlpZiAoIG1ldGhvZFZhbHVlICE9PSBpbnN0YW5jZSAmJiBtZXRob2RWYWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVyblZhbHVlID0gbWV0aG9kVmFsdWUgJiYgbWV0aG9kVmFsdWUuanF1ZXJ5ID8KCQkJCQkJcmV0dXJuVmFsdWUucHVzaFN0YWNrKCBtZXRob2RWYWx1ZS5nZXQoKSApIDoKCQkJCQkJbWV0aG9kVmFsdWU7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoIGluc3RhbmNlICkgewoJCQkJCWluc3RhbmNlLm9wdGlvbiggb3B0aW9ucyB8fCB7fSApLl9pbml0KCk7CgkJCQl9IGVsc2UgewoJCQkJCSQuZGF0YSggdGhpcywgZnVsbE5hbWUsIG5ldyBvYmplY3QoIG9wdGlvbnMsIHRoaXMgKSApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX07Cn07CgokLldpZGdldCA9IGZ1bmN0aW9uKCAvKiBvcHRpb25zLCBlbGVtZW50ICovICkge307CiQuV2lkZ2V0Ll9jaGlsZENvbnN0cnVjdG9ycyA9IFtdOwoKJC5XaWRnZXQucHJvdG90eXBlID0gewoJd2lkZ2V0TmFtZTogIndpZGdldCIsCgl3aWRnZXRFdmVudFByZWZpeDogIiIsCglkZWZhdWx0RWxlbWVudDogIjxkaXY+IiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogZmFsc2UsCgoJCS8vIGNhbGxiYWNrcwoJCWNyZWF0ZTogbnVsbAoJfSwKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCWVsZW1lbnQgPSAkKCBlbGVtZW50IHx8IHRoaXMuZGVmYXVsdEVsZW1lbnQgfHwgdGhpcyApWyAwIF07CgkJdGhpcy5lbGVtZW50ID0gJCggZWxlbWVudCApOwoJCXRoaXMudXVpZCA9IHV1aWQrKzsKCQl0aGlzLmV2ZW50TmFtZXNwYWNlID0gIi4iICsgdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkOwoJCXRoaXMub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sCgkJCXRoaXMub3B0aW9ucywKCQkJdGhpcy5fZ2V0Q3JlYXRlT3B0aW9ucygpLAoJCQlvcHRpb25zICk7CgoJCXRoaXMuYmluZGluZ3MgPSAkKCk7CgkJdGhpcy5ob3ZlcmFibGUgPSAkKCk7CgkJdGhpcy5mb2N1c2FibGUgPSAkKCk7CgoJCWlmICggZWxlbWVudCAhPT0gdGhpcyApIHsKCQkJJC5kYXRhKCBlbGVtZW50LCB0aGlzLndpZGdldEZ1bGxOYW1lLCB0aGlzICk7CgkJCXRoaXMuX29uKCB0cnVlLCB0aGlzLmVsZW1lbnQsIHsKCQkJCXJlbW92ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggZXZlbnQudGFyZ2V0ID09PSBlbGVtZW50ICkgewoJCQkJCQl0aGlzLmRlc3Ryb3koKTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCQl0aGlzLmRvY3VtZW50ID0gJCggZWxlbWVudC5zdHlsZSA/CgkJCQkvLyBlbGVtZW50IHdpdGhpbiB0aGUgZG9jdW1lbnQKCQkJCWVsZW1lbnQub3duZXJEb2N1bWVudCA6CgkJCQkvLyBlbGVtZW50IGlzIHdpbmRvdyBvciBkb2N1bWVudAoJCQkJZWxlbWVudC5kb2N1bWVudCB8fCBlbGVtZW50ICk7CgkJCXRoaXMud2luZG93ID0gJCggdGhpcy5kb2N1bWVudFswXS5kZWZhdWx0VmlldyB8fCB0aGlzLmRvY3VtZW50WzBdLnBhcmVudFdpbmRvdyApOwoJCX0KCgkJdGhpcy5fY3JlYXRlKCk7CgkJdGhpcy5fdHJpZ2dlciggImNyZWF0ZSIsIG51bGwsIHRoaXMuX2dldENyZWF0ZUV2ZW50RGF0YSgpICk7CgkJdGhpcy5faW5pdCgpOwoJfSwKCV9nZXRDcmVhdGVPcHRpb25zOiAkLm5vb3AsCglfZ2V0Q3JlYXRlRXZlbnREYXRhOiAkLm5vb3AsCglfY3JlYXRlOiAkLm5vb3AsCglfaW5pdDogJC5ub29wLAoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2Rlc3Ryb3koKTsKCQkvLyB3ZSBjYW4gcHJvYmFibHkgcmVtb3ZlIHRoZSB1bmJpbmQgY2FsbHMgaW4gMi4wCgkJLy8gYWxsIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBnbyB0aHJvdWdoIHRoaXMuX29uKCkKCQl0aGlzLmVsZW1lbnQKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS8vIDEuOSBCQyBmb3IgIzc4MTAKCQkJLy8gVE9ETyByZW1vdmUgZHVhbCBzdG9yYWdlCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldE5hbWUgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXRGdWxsTmFtZSApCgkJCS8vIHN1cHBvcnQ6IGpxdWVyeSA8MS42LjMKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvOTQxMwoJCQkucmVtb3ZlRGF0YSggJC5jYW1lbENhc2UoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCAiICsKCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCgkJLy8gY2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMKCQl0aGlzLmJpbmRpbmdzLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCX0sCglfZGVzdHJveTogJC5ub29wLAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleSwKCQkJcGFydHMsCgkJCWN1ck9wdGlvbiwKCQkJaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiApIHsKCQkJLy8gaGFuZGxlIG5lc3RlZCBrZXlzLCBlLmcuLCAiZm9vLmJhciIgPT4geyBmb286IHsgYmFyOiBfX18gfSB9CgkJCW9wdGlvbnMgPSB7fTsKCQkJcGFydHMgPSBrZXkuc3BsaXQoICIuIiApOwoJCQlrZXkgPSBwYXJ0cy5zaGlmdCgpOwoJCQlpZiAoIHBhcnRzLmxlbmd0aCApIHsKCQkJCWN1ck9wdGlvbiA9IG9wdGlvbnNbIGtleSBdID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zWyBrZXkgXSApOwoJCQkJZm9yICggaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGggLSAxOyBpKysgKSB7CgkJCQkJY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXSB8fCB7fTsKCQkJCQljdXJPcHRpb24gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXTsKCQkJCX0KCQkJCWtleSA9IHBhcnRzLnBvcCgpOwoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBjdXJPcHRpb25bIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogY3VyT3B0aW9uWyBrZXkgXTsKCQkJCX0KCQkJCWN1ck9wdGlvblsga2V5IF0gPSB2YWx1ZTsKCQkJfSBlbHNlIHsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IHRoaXMub3B0aW9uc1sga2V5IF07CgkJCQl9CgkJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCQl9CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5OwoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCQkJdGhpcy5fc2V0T3B0aW9uKCBrZXksIG9wdGlvbnNbIGtleSBdICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLndpZGdldCgpCgkJCQkudG9nZ2xlQ2xhc3MoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkIHVpLXN0YXRlLWRpc2FibGVkIiwgISF2YWx1ZSApCgkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCV9vbjogZnVuY3Rpb24oIHN1cHByZXNzRGlzYWJsZWRDaGVjaywgZWxlbWVudCwgaGFuZGxlcnMgKSB7CgkJdmFyIGRlbGVnYXRlRWxlbWVudCwKCQkJaW5zdGFuY2UgPSB0aGlzOwoKCQkvLyBubyBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgZmxhZywgc2h1ZmZsZSBhcmd1bWVudHMKCQlpZiAoIHR5cGVvZiBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgIT09ICJib29sZWFuIiApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gc3VwcHJlc3NEaXNhYmxlZENoZWNrOwoJCQlzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgPSBmYWxzZTsKCQl9CgoJCS8vIG5vIGVsZW1lbnQgYXJndW1lbnQsIHNodWZmbGUgYW5kIHVzZSB0aGlzLmVsZW1lbnQKCQlpZiAoICFoYW5kbGVycyApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50OwoJCQlkZWxlZ2F0ZUVsZW1lbnQgPSB0aGlzLndpZGdldCgpOwoJCX0gZWxzZSB7CgkJCS8vIGFjY2VwdCBzZWxlY3RvcnMsIERPTSBlbGVtZW50cwoJCQllbGVtZW50ID0gZGVsZWdhdGVFbGVtZW50ID0gJCggZWxlbWVudCApOwoJCQl0aGlzLmJpbmRpbmdzID0gdGhpcy5iaW5kaW5ncy5hZGQoIGVsZW1lbnQgKTsKCQl9CgoJCSQuZWFjaCggaGFuZGxlcnMsIGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlciApIHsKCQkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQkJLy8gYWxsb3cgd2lkZ2V0cyB0byBjdXN0b21pemUgdGhlIGRpc2FibGVkIGhhbmRsaW5nCgkJCQkvLyAtIGRpc2FibGVkIGFzIGFuIGFycmF5IGluc3RlYWQgb2YgYm9vbGVhbgoJCQkJLy8gLSBkaXNhYmxlZCBjbGFzcyBhcyBtZXRob2QgZm9yIGRpc2FibGluZyBpbmRpdmlkdWFsIHBhcnRzCgkJCQlpZiAoICFzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgJiYKCQkJCQkJKCBpbnN0YW5jZS5vcHRpb25zLmRpc2FibGVkID09PSB0cnVlIHx8CgkJCQkJCQkkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQkJfQoKCQkJLy8gY29weSB0aGUgZ3VpZCBzbyBkaXJlY3QgdW5iaW5kaW5nIHdvcmtzCgkJCWlmICggdHlwZW9mIGhhbmRsZXIgIT09ICJzdHJpbmciICkgewoJCQkJaGFuZGxlclByb3h5Lmd1aWQgPSBoYW5kbGVyLmd1aWQgPQoJCQkJCWhhbmRsZXIuZ3VpZCB8fCBoYW5kbGVyUHJveHkuZ3VpZCB8fCAkLmd1aWQrKzsKCQkJfQoKCQkJdmFyIG1hdGNoID0gZXZlbnQubWF0Y2goIC9eKFx3KylccyooLiopJC8gKSwKCQkJCWV2ZW50TmFtZSA9IG1hdGNoWzFdICsgaW5zdGFuY2UuZXZlbnROYW1lc3BhY2UsCgkJCQlzZWxlY3RvciA9IG1hdGNoWzJdOwoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJZGVsZWdhdGVFbGVtZW50LmRlbGVnYXRlKCBzZWxlY3RvciwgZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfSBlbHNlIHsKCQkJCWVsZW1lbnQuYmluZCggZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfQoJCX0pOwoJfSwKCglfb2ZmOiBmdW5jdGlvbiggZWxlbWVudCwgZXZlbnROYW1lICkgewoJCWV2ZW50TmFtZSA9IChldmVudE5hbWUgfHwgIiIpLnNwbGl0KCAiICIgKS5qb2luKCB0aGlzLmV2ZW50TmFtZXNwYWNlICsgIiAiICkgKyB0aGlzLmV2ZW50TmFtZXNwYWNlOwoJCWVsZW1lbnQudW5iaW5kKCBldmVudE5hbWUgKS51bmRlbGVnYXRlKCBldmVudE5hbWUgKTsKCX0sCgoJX2RlbGF5OiBmdW5jdGlvbiggaGFuZGxlciwgZGVsYXkgKSB7CgkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQl9CgkJdmFyIGluc3RhbmNlID0gdGhpczsKCQlyZXR1cm4gc2V0VGltZW91dCggaGFuZGxlclByb3h5LCBkZWxheSB8fCAwICk7Cgl9LAoKCV9ob3ZlcmFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuaG92ZXJhYmxlID0gdGhpcy5ob3ZlcmFibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJbW91c2VlbnRlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0sCgkJCW1vdXNlbGVhdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV9mb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuZm9jdXNhYmxlID0gdGhpcy5mb2N1c2FibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJZm9jdXNpbjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0sCgkJCWZvY3Vzb3V0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfQoJCX0pOwoJfSwKCglfdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGV2ZW50LCBkYXRhICkgewoJCXZhciBwcm9wLCBvcmlnLAoJCQljYWxsYmFjayA9IHRoaXMub3B0aW9uc1sgdHlwZSBdOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCQlldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CgkJZXZlbnQudHlwZSA9ICggdHlwZSA9PT0gdGhpcy53aWRnZXRFdmVudFByZWZpeCA/CgkJCXR5cGUgOgoJCQl0aGlzLndpZGdldEV2ZW50UHJlZml4ICsgdHlwZSApLnRvTG93ZXJDYXNlKCk7CgkJLy8gdGhlIG9yaWdpbmFsIGV2ZW50IG1heSBjb21lIGZyb20gYW55IGVsZW1lbnQKCQkvLyBzbyB3ZSBuZWVkIHRvIHJlc2V0IHRoZSB0YXJnZXQgb24gdGhlIG5ldyBldmVudAoJCWV2ZW50LnRhcmdldCA9IHRoaXMuZWxlbWVudFsgMCBdOwoKCQkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkJb3JpZyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7CgkJaWYgKCBvcmlnICkgewoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQlpZiAoICEoIHByb3AgaW4gZXZlbnQgKSApIHsKCQkJCQlldmVudFsgcHJvcCBdID0gb3JpZ1sgcHJvcCBdOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggZXZlbnQsIGRhdGEgKTsKCQlyZXR1cm4gISggJC5pc0Z1bmN0aW9uKCBjYWxsYmFjayApICYmCgkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLmVsZW1lbnRbMF0sIFsgZXZlbnQgXS5jb25jYXQoIGRhdGEgKSApID09PSBmYWxzZSB8fAoJCQlldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApOwoJfQp9OwoKJC5lYWNoKCB7IHNob3c6ICJmYWRlSW4iLCBoaWRlOiAiZmFkZU91dCIgfSwgZnVuY3Rpb24oIG1ldGhvZCwgZGVmYXVsdEVmZmVjdCApIHsKCSQuV2lkZ2V0LnByb3RvdHlwZVsgIl8iICsgbWV0aG9kIF0gPSBmdW5jdGlvbiggZWxlbWVudCwgb3B0aW9ucywgY2FsbGJhY2sgKSB7CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgKSB7CgkJCW9wdGlvbnMgPSB7IGVmZmVjdDogb3B0aW9ucyB9OwoJCX0KCQl2YXIgaGFzT3B0aW9ucywKCQkJZWZmZWN0TmFtZSA9ICFvcHRpb25zID8KCQkJCW1ldGhvZCA6CgkJCQlvcHRpb25zID09PSB0cnVlIHx8IHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiA/CgkJCQkJZGVmYXVsdEVmZmVjdCA6CgkJCQkJb3B0aW9ucy5lZmZlY3QgfHwgZGVmYXVsdEVmZmVjdDsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiApIHsKCQkJb3B0aW9ucyA9IHsgZHVyYXRpb246IG9wdGlvbnMgfTsKCQl9CgkJaGFzT3B0aW9ucyA9ICEkLmlzRW1wdHlPYmplY3QoIG9wdGlvbnMgKTsKCQlvcHRpb25zLmNvbXBsZXRlID0gY2FsbGJhY2s7CgkJaWYgKCBvcHRpb25zLmRlbGF5ICkgewoJCQllbGVtZW50LmRlbGF5KCBvcHRpb25zLmRlbGF5ICk7CgkJfQoJCWlmICggaGFzT3B0aW9ucyAmJiAkLmVmZmVjdHMgJiYgJC5lZmZlY3RzLmVmZmVjdFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBtZXRob2QgXSggb3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIGVmZmVjdE5hbWUgIT09IG1ldGhvZCAmJiBlbGVtZW50WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIGVmZmVjdE5hbWUgXSggb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudC5xdWV1ZShmdW5jdGlvbiggbmV4dCApIHsKCQkJCSQoIHRoaXMgKVsgbWV0aG9kIF0oKTsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7CgkJCQl9CgkJCQluZXh0KCk7CgkJCX0pOwoJCX0KCX07Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS53aWRnZXQiLCB7CgkvLyBkZWNvcmF0ZSB0aGUgcGFyZW50IF9jcmVhdGVXaWRnZXQgdG8gdHJpZ2dlciBgd2lkZ2V0aW5pdGAgZm9yIHVzZXJzCgkvLyB3aG8gd2lzaCB0byBkbyBwb3N0IHBvc3QgYHdpZGdldGNyZWF0ZWAgYWx0ZXJhdGlvbnMvYWRkaXRpb25zCgkvLwoJLy8gVE9ETyBjcmVhdGUgYSBwdWxsIHJlcXVlc3QgZm9yIGpxdWVyeSB1aSB0byB0cmlnZ2VyIHRoaXMgZXZlbnQKCS8vIGluIHRoZSBvcmlnaW5hbCBfY3JlYXRlV2lkZ2V0CglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQkkLldpZGdldC5wcm90b3R5cGUuX2NyZWF0ZVdpZGdldC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fdHJpZ2dlciggJ2luaXQnICk7Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdGlvbnMgPSB7fTsKCgkJJC5lYWNoKCB0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKCBvcHRpb24gKSB7CgoJCQl2YXIgdmFsdWUgPSBlbGVtLmpxbURhdGEoIG9wdGlvbi5yZXBsYWNlKCAvW0EtWl0vZywgZnVuY3Rpb24oIGMgKSB7CgkJCQkJCQlyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwoJCQkJCQl9KQoJCQkJCSk7CgoJCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQl9CgkJfSk7CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCgllbmhhbmNlV2l0aGluOiBmdW5jdGlvbiggdGFyZ2V0LCB1c2VLZWVwTmF0aXZlICkgewoJCXRoaXMuZW5oYW5jZSggJCggdGhpcy5vcHRpb25zLmluaXRTZWxlY3RvciwgJCggdGFyZ2V0ICkpLCB1c2VLZWVwTmF0aXZlICk7Cgl9LAoKCWVuaGFuY2U6IGZ1bmN0aW9uKCB0YXJnZXRzLCB1c2VLZWVwTmF0aXZlICkgewoJCXZhciBwYWdlLCBrZWVwTmF0aXZlLCAkd2lkZ2V0RWxlbWVudHMgPSAkKCB0YXJnZXRzICksIHNlbGYgPSB0aGlzOwoKCQkvLyBpZiBpZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgdG8gdHJ1ZSB0aGUgZnJhbWV3b3JrIHNob3VsZAoJCS8vIG9ubHkgZW5oYW5jZSB0aGUgc2VsZWN0ZWQgZWxlbWVudHMgd2hlbiB0aGV5IGRvIE5PVCBoYXZlIGEKCQkvLyBwYXJlbnQgd2l0aCB0aGUgZGF0YS1uYW1lc3BhY2UtaWdub3JlIGF0dHJpYnV0ZQoJCSR3aWRnZXRFbGVtZW50cyA9ICQubW9iaWxlLmVuaGFuY2VhYmxlKCAkd2lkZ2V0RWxlbWVudHMgKTsKCgkJaWYgKCB1c2VLZWVwTmF0aXZlICYmICR3aWRnZXRFbGVtZW50cy5sZW5ndGggKSB7CgkJCS8vIFRPRE8gcmVtb3ZlIGRlcGVuZGVuY3kgb24gdGhlIHBhZ2Ugd2lkZ2V0IGZvciB0aGUga2VlcE5hdGl2ZS4KCQkJLy8gQ3VycmVudGx5IHRoZSBrZWVwTmF0aXZlIHZhbHVlIGlzIGRlZmluZWQgb24gdGhlIHBhZ2UgcHJvdG90eXBlIHNvCgkJCS8vIHRoZSBtZXRob2QgaXMgYXMgd2VsbAoJCQlwYWdlID0gJC5tb2JpbGUuY2xvc2VzdFBhZ2VEYXRhKCAkd2lkZ2V0RWxlbWVudHMgKTsKCQkJa2VlcE5hdGl2ZSA9ICggcGFnZSAmJiBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpKSB8fCAiIjsKCgkJCSR3aWRnZXRFbGVtZW50cyA9ICR3aWRnZXRFbGVtZW50cy5ub3QoIGtlZXBOYXRpdmUgKTsKCQl9CgoJCSR3aWRnZXRFbGVtZW50c1sgdGhpcy53aWRnZXROYW1lIF0oKTsKCX0sCgoJcmFpc2U6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgIldpZGdldCBbIiArIHRoaXMud2lkZ2V0TmFtZSArICJdOiAiICsgbXNnOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCS8vIERFUFJFQ0FURUQKCS8vIE5PVEUgZ2xvYmFsIG1vYmlsZSBvYmplY3Qgc2V0dGluZ3MKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIERFUFJFQ0FURUQgU2hvdWxkIHRoZSB0ZXh0IGJlIHZpc2JsZSBpbiB0aGUgbG9hZGluZyBtZXNzYWdlPwoJCWxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGU6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRCBXaGVuIHRoZSB0ZXh0IGlzIHZpc2libGUsIHdoYXQgdGhlbWUgZG9lcyB0aGUgbG9hZGluZyBib3ggdXNlPwoJCWxvYWRpbmdNZXNzYWdlVGhlbWU6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRCBkZWZhdWx0IG1lc3NhZ2Ugc2V0dGluZwoJCWxvYWRpbmdNZXNzYWdlOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJc2hvd1BhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQkkLm1vYmlsZS5sb2FkaW5nKCAnc2hvdycsIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApOwoJCX0sCgoJCS8vIERFUFJFQ0FURUQKCQloaWRlUGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5sb2FkaW5nKCAnaGlkZScgKTsKCQl9LAoKCQlsb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5sb2FkZXJXaWRnZXQubG9hZGVyLmFwcGx5KCB0aGlzLmxvYWRlcldpZGdldCwgYXJndW1lbnRzICk7CgkJfQoJfSk7CgoJLy8gVE9ETyBtb3ZlIGxvYWRlciBjbGFzcyBkb3duIGludG8gdGhlIHdpZGdldCBzZXR0aW5ncwoJdmFyIGxvYWRlckNsYXNzID0gInVpLWxvYWRlciIsICRodG1sID0gJCggImh0bWwiICksICR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJJC53aWRnZXQoICJtb2JpbGUubG9hZGVyIiwgewoJCS8vIE5PVEUgaWYgdGhlIGdsb2JhbCBjb25maWcgc2V0dGluZ3MgYXJlIGRlZmluZWQgdGhleSB3aWxsIG92ZXJyaWRlIHRoZXNlCgkJLy8gICAgICBvcHRpb25zCgkJb3B0aW9uczogewoJCQkvLyB0aGUgdGhlbWUgZm9yIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhlbWU6ICJhIiwKCgkJCS8vIHdoZXRoZXIgdGhlIHRleHQgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZSBpcyBzaG93bgoJCQl0ZXh0VmlzaWJsZTogZmFsc2UsCgoJCQkvLyBjdXN0b20gaHRtbCBmb3IgdGhlIGlubmVyIGNvbnRlbnQgb2YgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQlodG1sOiAiIiwKCgkJCS8vIHRoZSB0ZXh0IHRvIGJlIGRpc3BsYXllZCB3aGVuIHRoZSBwb3B1cCBpcyBzaG93bgoJCQl0ZXh0OiAibG9hZGluZyIKCQl9LAoKCQlkZWZhdWx0SHRtbDogIjxkaXYgY2xhc3M9JyIgKyBsb2FkZXJDbGFzcyArICInPiIgKwoJCQkiPHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1sb2FkaW5nJz48L3NwYW4+IiArCgkJCSI8aDE+PC9oMT4iICsKCQkJIjwvZGl2PiIsCgoJCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJZmFrZUZpeExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jc3MoewoJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiAkd2luZG93LnNjcm9sbFRvcCgpICsgJHdpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQkJfSk7CgkJfSwKCgkJLy8gY2hlY2sgcG9zaXRpb24gb2YgbG9hZGVyIHRvIHNlZSBpZiBpdCBhcHBlYXJzIHRvIGJlICJmaXhlZCIgdG8gY2VudGVyCgkJLy8gaWYgbm90LCB1c2UgYWJzIHBvc2l0aW9uaW5nCgkJY2hlY2tMb2FkZXJQb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCksCgkJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKCBvZmZzZXQudG9wIC0gc2Nyb2xsVG9wICkgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJCXRoaXMuZmFrZUZpeExvYWRlcigpOwoJCQkJJHdpbmRvdwoJCQkJCS51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKQoJCQkJCS5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5mYWtlRml4TG9hZGVyLCB0aGlzICkgKTsKCQkJfQoJCX0sCgoJCXJlc2V0SHRtbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5odG1sKCAkKCB0aGlzLmRlZmF1bHRIdG1sICkuaHRtbCgpICk7CgkJfSwKCgkJLy8gVHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuIFRoZW1lIGRvdWJsZXMgYXMgYW4gb2JqZWN0IGFyZ3VtZW50CgkJLy8gd2l0aCB0aGUgZm9sbG93aW5nIHNoYXBlOiB7IHRoZW1lOiAnJywgdGV4dDogJycsIGh0bWw6ICcnLCB0ZXh0VmlzaWJsZTogJycgfQoJCS8vIE5PVEUgdGhhdCB0aGUgJC5tb2JpbGUubG9hZGluZyogc2V0dGluZ3MgYW5kIHBhcmFtcyBwYXN0IHRoZSBmaXJzdCBhcmUgZGVwcmVjYXRlZAoJCS8vIFRPRE8gc3dlZXQgamVzdXMgd2UgbmVlZCB0byBicmVhayBzb21lIG9mIHRoaXMgb3V0CgkJc2hvdzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJdmFyIHRleHRWaXNpYmxlLCBtZXNzYWdlLCAkaGVhZGVyLCBsb2FkU2V0dGluZ3M7CgoJCQl0aGlzLnJlc2V0SHRtbCgpOwoKCQkJLy8gdXNlIHRoZSBwcm90b3R5cGUgb3B0aW9ucyBzbyB0aGF0IHBlb3BsZSBjYW4gc2V0IHRoZW0gZ2xvYmFsbHkgYXQKCQkJLy8gbW9iaWxlIGluaXQuIENvbnNpc3RlbmN5LCBpdCdzIHdoYXQncyBmb3IgZGlubmVyCgkJCWlmICggJC50eXBlKHRoZW1lKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQkvLyBwcmVmZXIgb2JqZWN0IHByb3BlcnR5IGZyb20gdGhlIHBhcmFtIHRoZW4gdGhlIG9sZCB0aGVtZSBzZXR0aW5nCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lOwoJCQl9IGVsc2UgewoJCQkJbG9hZFNldHRpbmdzID0gdGhpcy5vcHRpb25zOwoKCQkJCS8vIGhlcmUgd2UgcHJlZmVyIHRoZSB0aGVtIHZhbHVlIHBhc3NlZCBhcyBhIHN0cmluZyBhcmd1bWVudCwgdGhlbgoJCQkJLy8gd2UgcHJlZmVyIHRoZSBnbG9iYWwgb3B0aW9uIGJlY2F1c2Ugd2UgY2FuJ3QgdXNlIHVuZGVmaW5lZCBkZWZhdWx0CgkJCQkvLyBwcm90b3R5cGUgb3B0aW9ucywgdGhlbiB0aGUgcHJvdG90eXBlIG9wdGlvbgoJCQkJdGhlbWUgPSB0aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSB8fCBsb2FkU2V0dGluZ3MudGV4dDsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICE9PSBmYWxzZSB8fCBsb2FkU2V0dGluZ3MuaHRtbCApIHsKCQkJCS8vIGJvb2xlYW4gdmFsdWVzIHJlcXVpcmUgYSBiaXQgbW9yZSB3b3JrIDpQLCBzdXBwb3J0cyBvYmplY3QgcHJvcGVydGllcwoJCQkJLy8gYW5kIG9sZCBzZXR0aW5ncwoJCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGV4dFZpc2libGUgPSAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOwoJCQkJfSBlbHNlIHsKCQkJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCQkJCX0KCgkJCQkvLyBhZGQgdGhlIHByb3BlciBjc3MgZ2l2ZW4gdGhlIG9wdGlvbnMgKHRoZW1lLCB0ZXh0LCBldGMpCgkJCQkvLyBGb3JjZSB0ZXh0IHZpc2liaWxpdHkgaWYgdGhlIHNlY29uZCBhcmd1bWVudCB3YXMgc3VwcGxpZWQsIG9yCgkJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCQl0aGlzLmVsZW1lbnQuYXR0cigiY2xhc3MiLCBsb2FkZXJDbGFzcyArCgkJCQkJIiB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArIHRoZW1lICsKCQkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkJKCBsb2FkU2V0dGluZ3MudGV4dG9ubHkgfHwgdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICk7CgoJCQkJLy8gVE9ETyB2ZXJpZnkgdGhhdCBqcXVlcnkuZm4uaHRtbCBpcyBvayB0byB1c2UgaW4gYm90aCBjYXNlcyBoZXJlCgkJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJCS8vIGlmIHRoZSBodG1sIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIHRoZSBsb2FkaW5nIHNldHRpbmdzLCB1c2UgdGhhdAoJCQkJLy8gb3RoZXJ3aXNlIHVzZSB0aGUgZmFsbGJhY2tzIGZyb20gYWJvdmUKCQkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIGxvYWRTZXR0aW5ncy5odG1sICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQkJfQoKCQkJCS8vIGF0dGFjaCB0aGUgbG9hZGVyIHRvIHRoZSBET00KCQkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCS8vIGNoZWNrIHRoYXQgdGhlIGxvYWRlciBpcyB2aXNpYmxlCgkJCQl0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24oKTsKCgkJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQkJfQoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCkgewoJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCX0KCgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmZha2VGaXhMb2FkZXIgKTsKCQkJJC5tb2JpbGUud2luZG93LnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApOwoJCX0KCX0pOwoKCSR3aW5kb3cuYmluZCggJ3BhZ2Vjb250YWluZXJjcmVhdGUnLCBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5sb2FkZXJXaWRnZXQgPSAkLm1vYmlsZS5sb2FkZXJXaWRnZXQgfHwgJCggJC5tb2JpbGUubG9hZGVyLnByb3RvdHlwZS5kZWZhdWx0SHRtbCApLmxvYWRlcigpOwoJfSk7Cn0pKGpRdWVyeSwgdGhpcyk7CgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjwvc2NyaXB0PicgKTsKICAgICAgICAgIAogICAgICAgICAgaWZyYW1lX2RvYy5jbG9zZSgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIElmcmFtZSdzIGhhc2gsIGZvciBncmVhdCBqdXN0aWNlLgogICAgICAgICAgaWZyYW1lLmxvY2F0aW9uLmhhc2ggPSBoYXNoOwogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICB9KSgpOwogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eIFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IF5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgCiAgICByZXR1cm4gc2VsZjsKICB9KSgpOwogIAp9KShqUXVlcnksdGhpcyk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvKiEgbWF0Y2hNZWRpYSgpIHBvbHlmaWxsIC0gVGVzdCBhIENTUyBtZWRpYSB0eXBlL3F1ZXJ5IGluIEpTLiBBdXRob3JzICYgY29weXJpZ2h0IChjKSAyMDEyOiBTY290dCBKZWhsLCBQYXVsIElyaXNoLCBOaWNob2xhcyBaYWthcy4gRHVhbCBNSVQvQlNEIGxpY2Vuc2UgKi8KCXdpbmRvdy5tYXRjaE1lZGlhID0gd2luZG93Lm1hdGNoTWVkaWEgfHwgKGZ1bmN0aW9uKCBkb2MsIHVuZGVmaW5lZCApIHsKCgkJCgoJCXZhciBib29sLAoJCQlkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudCwKCQkJcmVmTm9kZSA9IGRvY0VsZW0uZmlyc3RFbGVtZW50Q2hpbGQgfHwgZG9jRWxlbS5maXJzdENoaWxkLAoJCQkvLyBmYWtlQm9keSByZXF1aXJlZCBmb3IgPEZGNCB3aGVuIGV4ZWN1dGVkIGluIDxoZWFkPgoJCQlmYWtlQm9keSA9IGRvYy5jcmVhdGVFbGVtZW50KCAiYm9keSIgKSwKCQkJZGl2ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgoJCWRpdi5pZCA9ICJtcS10ZXN0LTEiOwoJCWRpdi5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOmFic29sdXRlO3RvcDotMTAwZW0iOwoJCWZha2VCb2R5LnN0eWxlLmJhY2tncm91bmQgPSAibm9uZSI7CgkJZmFrZUJvZHkuYXBwZW5kQ2hpbGQoZGl2KTsKCgkJcmV0dXJuIGZ1bmN0aW9uKHEpewoKCQkJZGl2LmlubmVySFRNTCA9ICImc2h5OzxzdHlsZSBtZWRpYT1cIiIgKyBxICsgIlwiPiAjbXEtdGVzdC0xIHsgd2lkdGg6IDQycHg7IH08L3N0eWxlPiI7CgoJCQlkb2NFbGVtLmluc2VydEJlZm9yZSggZmFrZUJvZHksIHJlZk5vZGUgKTsKCQkJYm9vbCA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gNDI7CgkJCWRvY0VsZW0ucmVtb3ZlQ2hpbGQoIGZha2VCb2R5ICk7CgoJCQlyZXR1cm4gewoJCQkJbWF0Y2hlczogYm9vbCwKCQkJCW1lZGlhOiBxCgkJCX07CgoJCX07CgoJfSggZG9jdW1lbnQgKSk7CgoJLy8gJC5tb2JpbGUubWVkaWEgdXNlcyBtYXRjaE1lZGlhIHRvIHJldHVybiBhIGJvb2xlYW4uCgkkLm1vYmlsZS5tZWRpYSA9IGZ1bmN0aW9uKCBxICkgewoJCXJldHVybiB3aW5kb3cubWF0Y2hNZWRpYSggcSApLm1hdGNoZXM7Cgl9OwoKfSkoalF1ZXJ5KTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgc3VwcG9ydCA9IHsKCQkJdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudAoJCX07CgoJCSQubW9iaWxlLnN1cHBvcnQgPSAkLm1vYmlsZS5zdXBwb3J0IHx8IHt9OwoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHN1cHBvcnQgKTsKCQkkLmV4dGVuZCggJC5tb2JpbGUuc3VwcG9ydCwgc3VwcG9ydCApOwoJfSggalF1ZXJ5ICkpOwoKCShmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCQkJb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIgaW4gd2luZG93ICYmICJvbm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cKCQl9KTsKCX0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gdGh4IE1vZGVybml6cgpmdW5jdGlvbiBwcm9wRXhpc3RzKCBwcm9wICkgewoJdmFyIHVjX3Byb3AgPSBwcm9wLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnN1YnN0ciggMSApLAoJCXByb3BzID0gKCBwcm9wICsgIiAiICsgdmVuZG9ycy5qb2luKCB1Y19wcm9wICsgIiAiICkgKyB1Y19wcm9wICkuc3BsaXQoICIgIiApOwoKCWZvciAoIHZhciB2IGluIHByb3BzICkgewoJCWlmICggZmJDU1NbIHByb3BzWyB2IF0gXSAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9Cn0KCnZhciBmYWtlQm9keSA9ICQoICI8Ym9keT4iICkucHJlcGVuZFRvKCAiaHRtbCIgKSwKCWZiQ1NTID0gZmFrZUJvZHlbIDAgXS5zdHlsZSwKCXZlbmRvcnMgPSBbICJXZWJraXQiLCAiTW96IiwgIk8iIF0sCgl3ZWJvcyA9ICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdywgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgc2Nyb2xsVG9wCglvcGVyYSA9IHdpbmRvdy5vcGVyYSwKCW9wZXJhbWluaSA9IHdpbmRvdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3aW5kb3cub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iLAoJYmIgPSB3aW5kb3cuYmxhY2tiZXJyeSAmJiAhcHJvcEV4aXN0cyggIi13ZWJraXQtdHJhbnNmb3JtIiApOyAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIgNSBhbmQgbG93ZXIKCgpmdW5jdGlvbiB2YWxpZFN0eWxlKCBwcm9wLCB2YWx1ZSwgY2hlY2tfdmVuZCApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApOwoJCX0sCgkJdmVuZF9wcmVmID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCWlmKCB2ZW5kID09PSAiIiApIHsKCQkJCXJldHVybiAiIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiAgIi0iICsgdmVuZC5jaGFyQXQoIDAgKS50b0xvd2VyQ2FzZSgpICsgdmVuZC5zdWJzdHIoIDEgKSArICItIjsKCQkJfQoJCX0sCgkJY2hlY2tfc3R5bGUgPSBmdW5jdGlvbiggdmVuZCApIHsKCQkJdmFyIHZlbmRfcHJvcCA9IHZlbmRfcHJlZiggdmVuZCApICsgcHJvcCArICI6ICIgKyB2YWx1ZSArICI7IiwKCQkJCXVjX3ZlbmQgPSB1YyggdmVuZCApLAoJCQkJcHJvcFN0eWxlID0gdWNfdmVuZCArICggdWNfdmVuZCA9PT0gIiIgPyBwcm9wIDogdWMoIHByb3AgKSApOwoKCQkJZGl2LnNldEF0dHJpYnV0ZSggInN0eWxlIiwgdmVuZF9wcm9wICk7CgoJCQlpZiAoICEhZGl2LnN0eWxlWyBwcm9wU3R5bGUgXSApIHsKCQkJCXJldCA9IHRydWU7CgkJCX0KCQl9LAoJCWNoZWNrX3ZlbmRzID0gY2hlY2tfdmVuZCA/IGNoZWNrX3ZlbmQgOiB2ZW5kb3JzLAoJCXJldDsKCglmb3IoIHZhciBpID0gMDsgaSA8IGNoZWNrX3ZlbmRzLmxlbmd0aDsgaSsrICkgewoJCWNoZWNrX3N0eWxlKCBjaGVja192ZW5kc1tpXSApOwoJfQoJcmV0dXJuICEhcmV0Owp9CgpmdW5jdGlvbiB0cmFuc2Zvcm0zZFRlc3QoKSB7Cgl2YXIgbXFQcm9wID0gInRyYW5zZm9ybS0zZCIsCgkJLy8gQmVjYXVzZSB0aGUgYHRyYW5zbGF0ZTNkYCB0ZXN0IGJlbG93IHRocm93cyBmYWxzZSBwb3NpdGl2ZXMgaW4gQW5kcm9pZDoKCQlyZXQgPSAkLm1vYmlsZS5tZWRpYSggIigtIiArIHZlbmRvcnMuam9pbiggIi0iICsgbXFQcm9wICsgIiksKC0iICkgKyAiLSIgKyBtcVByb3AgKyAiKSwoIiArIG1xUHJvcCArICIpIiApOwoKCWlmKCByZXQgKSB7CgkJcmV0dXJuICEhcmV0OwoJfQoKCXZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJdHJhbnNmb3JtcyA9IHsKCQkJLy8gV2XigJlyZSBvbWl0dGluZyBPcGVyYSBmb3IgdGhlIHRpbWUgYmVpbmc7IE1TIHVzZXMgdW5wcmVmaXhlZC4KCQkJJ01velRyYW5zZm9ybSc6Jy1tb3otdHJhbnNmb3JtJywKCQkJJ3RyYW5zZm9ybSc6J3RyYW5zZm9ybScKCQl9OwoKCWZha2VCb2R5LmFwcGVuZCggZWwgKTsKCglmb3IgKCB2YXIgdCBpbiB0cmFuc2Zvcm1zICkgewoJCWlmKCBlbC5zdHlsZVsgdCBdICE9PSB1bmRlZmluZWQgKXsKCQkJZWwuc3R5bGVbIHQgXSA9ICd0cmFuc2xhdGUzZCggMTAwcHgsIDFweCwgMXB4ICknOwoJCQlyZXQgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZWwgKS5nZXRQcm9wZXJ0eVZhbHVlKCB0cmFuc2Zvcm1zWyB0IF0gKTsKCQl9Cgl9CglyZXR1cm4gKCAhIXJldCAmJiByZXQgIT09ICJub25lIiApOwp9CgovLyBUZXN0IGZvciBkeW5hbWljLXVwZGF0aW5nIGJhc2UgdGFnIHN1cHBvcnQgKCBhbGxvd3MgdXMgdG8gYXZvaWQgaHJlZixzcmMgYXR0ciByZXdyaXRpbmcgKQpmdW5jdGlvbiBiYXNlVGFnVGVzdCgpIHsKCXZhciBmYXV4QmFzZSA9IGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSArICJ1aS1kaXIvIiwKCQliYXNlID0gJCggImhlYWQgYmFzZSIgKSwKCQlmYXV4RWxlID0gbnVsbCwKCQlocmVmID0gIiIsCgkJbGluaywgcmViYXNlOwoKCWlmICggIWJhc2UubGVuZ3RoICkgewoJCWJhc2UgPSBmYXV4RWxlID0gJCggIjxiYXNlPiIsIHsgImhyZWYiOiBmYXV4QmFzZSB9KS5hcHBlbmRUbyggImhlYWQiICk7Cgl9IGVsc2UgewoJCWhyZWYgPSBiYXNlLmF0dHIoICJocmVmIiApOwoJfQoKCWxpbmsgPSAkKCAiPGEgaHJlZj0ndGVzdHVybCcgLz4iICkucHJlcGVuZFRvKCBmYWtlQm9keSApOwoJcmViYXNlID0gbGlua1sgMCBdLmhyZWY7CgliYXNlWyAwIF0uaHJlZiA9IGhyZWYgfHwgbG9jYXRpb24ucGF0aG5hbWU7CgoJaWYgKCBmYXV4RWxlICkgewoJCWZhdXhFbGUucmVtb3ZlKCk7Cgl9CglyZXR1cm4gcmViYXNlLmluZGV4T2YoIGZhdXhCYXNlICkgPT09IDA7Cn0KCi8vIFRoYW5rcyBNb2Rlcm5penIKZnVuY3Rpb24gY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSB7Cgl2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICd4JyApLAoJCWRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlnZXRDb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUsCgkJc3VwcG9ydHM7CgoJaWYgKCAhKCAncG9pbnRlckV2ZW50cycgaW4gZWxlbWVudC5zdHlsZSApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnYXV0byc7CgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAneCc7Cglkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGVsZW1lbnQgKTsKCXN1cHBvcnRzID0gZ2V0Q29tcHV0ZWRTdHlsZSAmJgoJZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbWVudCwgJycgKS5wb2ludGVyRXZlbnRzID09PSAnYXV0byc7Cglkb2N1bWVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoIGVsZW1lbnQgKTsKCXJldHVybiAhIXN1cHBvcnRzOwp9CgpmdW5jdGlvbiBib3VuZGluZ1JlY3QoKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCXJldHVybiB0eXBlb2YgZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gInVuZGVmaW5lZCI7Cn0KCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5leHRlbmQoICQubW9iaWxlLCB7IGJyb3dzZXI6IHt9IH0gKTsKJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA9IChmdW5jdGlvbigpIHsKCXZhciB2ID0gMywKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCWEgPSBkaXYuYWxsIHx8IFtdOwoKCWRvIHsKCQlkaXYuaW5uZXJIVE1MID0gIjwhLS1baWYgZ3QgSUUgIiArICggKyt2ICkgKyAiXT48YnI+PCFbZW5kaWZdLS0+IjsKCX0gd2hpbGUoIGFbMF0gKTsKCglyZXR1cm4gdiA+IDQgPyB2IDogIXY7Cn0pKCk7CgpmdW5jdGlvbiBmaXhlZFBvc2l0aW9uKCkgewoJdmFyIHcgPSB3aW5kb3csCgkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLAoJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJZmZtYXRjaCA9IHVhLm1hdGNoKCAvRmVubmVjXC8oWzAtOV0rKS8gKSwKCQlmZnZlcnNpb24gPSAhIWZmbWF0Y2ggJiYgZmZtYXRjaFsgMSBdLAoJCW9wZXJhbW1vYmlsZW1hdGNoID0gdWEubWF0Y2goIC9PcGVyYSBNb2JpXC8oWzAtOV0rKS8gKSwKCQlvbXZlcnNpb24gPSAhIW9wZXJhbW1vYmlsZW1hdGNoICYmIG9wZXJhbW1vYmlsZW1hdGNoWyAxIF07CgoJaWYoCgkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCS8vIE9wZXJhIE1pbmkKCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCS8vIE1lZUdvCgkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJcmV0dXJuIHRydWU7Cn0KCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cgfHwKCQl2YWxpZFN0eWxlKCAndHJhbnNpdGlvbicsICdoZWlnaHQgMTAwbXMgbGluZWFyJywgWyAiV2Via2l0IiwgIk1veiIsICIiIF0gKSAmJgoJCSEkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICFvcGVyYSwKCgkvLyBOb3RlLCBDaHJvbWUgZm9yIGlPUyBoYXMgYW4gZXh0cmVtZWx5IHF1aXJreSBpbXBsZW1lbnRhdGlvbiBvZiBwb3BzdGF0ZS4KCS8vIFdlJ3ZlIGNob3NlbiB0byB0YWtlIHRoZSBzaG9ydGVzdCBwYXRoIHRvIGEgYnVnIGZpeCBoZXJlIGZvciBpc3N1ZSAjNTQyNgoJLy8gU2VlIHRoZSBmb2xsb3dpbmcgbGluayBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlZ2V4IGNob3NlbgoJLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hyb21lL21vYmlsZS9kb2NzL3VzZXItYWdlbnQjY2hyb21lX2Zvcl9pb3NfdXNlci1hZ2VudAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCS8vIFdoZW4gcnVubmluZyBpbnNpZGUgYSBGRiBpZnJhbWUsIGNhbGxpbmcgcmVwbGFjZVN0YXRlIGNhdXNlcyBhbiBlcnJvcgoJCSEoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJGaXJlZm94IiApID49IDAgJiYgd2luZG93LnRvcCAhPT0gd2luZG93ICkgJiYKCQkoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnNlYXJjaCgvQ3JpT1MvKSA9PT0gLTEgKSwKCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJYm94U2hhZG93OiAhIXByb3BFeGlzdHMoICJib3hTaGFkb3ciICkgJiYgIWJiLAoJZml4ZWRQb3NpdGlvbjogZml4ZWRQb3NpdGlvbigpLAoJc2Nyb2xsVG9wOiAoInBhZ2VYT2Zmc2V0IiBpbiB3aW5kb3cgfHwKCQkic2Nyb2xsVG9wIiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHwKCQkic2Nyb2xsVG9wIiBpbiBmYWtlQm9keVsgMCBdKSAmJiAhd2Vib3MgJiYgIW9wZXJhbWluaSwKCglkeW5hbWljQmFzZVRhZzogYmFzZVRhZ1Rlc3QoKSwKCWNzc1BvaW50ZXJFdmVudHM6IGNzc1BvaW50ZXJFdmVudHNUZXN0KCksCglib3VuZGluZ1JlY3Q6IGJvdW5kaW5nUmVjdCgpCn0pOwoKZmFrZUJvZHkucmVtb3ZlKCk7CgoKLy8gJC5tb2JpbGUuYWpheEJsYWNrbGlzdCBpcyB1c2VkIHRvIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMgKEJCNSwgU3ltYmlhbikKLy8gb3IgdGhhdCBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChPcGVyYSBNaW5pKQovLyBOb3RlOiBUaGlzIGRldGVjdGlvbiBiZWxvdyBpcyB1c2VkIGFzIGEgbGFzdCByZXNvcnQuCi8vIFdlIHJlY29tbWVuZCBvbmx5IHVzaW5nIHRoZXNlIGRldGVjdGlvbiBtZXRob2RzIHdoZW4gYWxsIG90aGVyIG1vcmUgcmVsaWFibGUvZm9yd2FyZC1sb29raW5nIGFwcHJvYWNoZXMgYXJlIG5vdCBwb3NzaWJsZQp2YXIgbm9raWFMVEU3XzMgPSAoZnVuY3Rpb24oKSB7CgoJdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CgoJLy9UaGUgZm9sbG93aW5nIGlzIGFuIGF0dGVtcHQgdG8gbWF0Y2ggTm9raWEgYnJvd3NlcnMgdGhhdCBhcmUgcnVubmluZyBTeW1iaWFuL3M2MCwgd2l0aCB3ZWJraXQsIHZlcnNpb24gNy4zIG9yIG9sZGVyCglyZXR1cm4gdWEuaW5kZXhPZiggIk5va2lhIiApID4gLTEgJiYKCQkJKCB1YS5pbmRleE9mKCAiU3ltYmlhbi8zIiApID4gLTEgfHwgdWEuaW5kZXhPZiggIlNlcmllczYwLzUiICkgPiAtMSApICYmCgkJCXVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICYmCgkJCXVhLm1hdGNoKCAvKEJyb3dzZXJOR3xOb2tpYUJyb3dzZXIpXC83XC5bMC0zXS8gKTsKfSkoKTsKCi8vIFN1cHBvcnQgY29uZGl0aW9ucyB0aGF0IG11c3QgYmUgbWV0IGluIG9yZGVyIHRvIHByb2NlZWQKLy8gZGVmYXVsdCBlbmhhbmNlZCBxdWFsaWZpY2F0aW9ucyBhcmUgbWVkaWEgcXVlcnkgc3VwcG9ydCBPUiBJRSA3KwoKJC5tb2JpbGUuZ3JhZGVBID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gKCAkLnN1cHBvcnQubWVkaWFxdWVyeSB8fCAkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICQubW9iaWxlLmJyb3dzZXIub2xkSUUgPj0gNyApICYmICggJC5zdXBwb3J0LmJvdW5kaW5nUmVjdCB8fCAkLmZuLmpxdWVyeS5tYXRjaCgvMVwuWzAtNytdXC5bMC05K10/LykgIT09IG51bGwgKTsKfTsKCiQubW9iaWxlLmFqYXhCbGFja2xpc3QgPQoJCQkvLyBCbGFja0JlcnJ5IGJyb3dzZXJzLCBwcmUtd2Via2l0CgkJCXdpbmRvdy5ibGFja2JlcnJ5ICYmICF3aW5kb3cuV2ViS2l0UG9pbnQgfHwKCQkJLy8gT3BlcmEgTWluaQoJCQlvcGVyYW1pbmkgfHwKCQkJLy8gU3ltYmlhbiB3ZWJraXRzIHByZSA3LjMKCQkJbm9raWFMVEU3XzM7CgovLyBMYXN0bHksIHRoaXMgd29ya2Fyb3VuZCBpcyB0aGUgb25seSB3YXkgd2UndmUgZm91bmQgc28gZmFyIHRvIGdldCBwcmUgNy4zIFN5bWJpYW4gd2Via2l0IGRldmljZXMKLy8gdG8gcmVuZGVyIHRoZSBzdHlsZXNoZWV0cyB3aGVuIHRoZXkncmUgcmVmZXJlbmNlZCBiZWZvcmUgdGhpcyBzY3JpcHQsIGFzIHdlJ2QgcmVjb21tZW5kIGRvaW5nLgovLyBUaGlzIHNpbXBseSByZWFwcGVuZHMgdGhlIENTUyBpbiBwbGFjZSwgd2hpY2ggZm9yIHNvbWUgcmVhc29uIG1ha2VzIGl0IGFwcGx5CmlmICggbm9raWFMVEU3XzMgKSB7CgkkKGZ1bmN0aW9uKCkgewoJCSQoICJoZWFkIGxpbmtbcmVsPSdzdHlsZXNoZWV0J10iICkuYXR0ciggInJlbCIsICJhbHRlcm5hdGUgc3R5bGVzaGVldCIgKS5hdHRyKCAicmVsIiwgInN0eWxlc2hlZXQiICk7Cgl9KTsKfQoKLy8gRm9yIHJ1bGluZyBvdXQgc2hhZG93cyB2aWEgY3NzCmlmICggISQuc3VwcG9ydC5ib3hTaGFkb3cgKSB7CgkkKCAiaHRtbCIgKS5hZGRDbGFzcyggInVpLW1vYmlsZS1ub3N1cHBvcnQtYm94c2hhZG93IiApOwp9Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdywgc2VsZiwgaGlzdG9yeTsKCgkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUgPSBzZWxmID0gewoJCWJvdW5kOiBmYWxzZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJb3JpZ2luYWxFdmVudE5hbWU6IHVuZGVmaW5lZCwKCgkJLy8gSWYgcHVzaHN0YXRlIHN1cHBvcnQgaXMgcHJlc2VudCBhbmQgcHVzaCBzdGF0ZSBzdXBwb3J0IGlzIGRlZmluZWQgdG8KCQkvLyBiZSB0cnVlIG9uIHRoZSBtb2JpbGUgbmFtZXNwYWNlLgoJCWlzUHVzaFN0YXRlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLnN1cHBvcnQucHVzaFN0YXRlICYmCgkJCQkkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkID09PSB0cnVlICYmCgkJCQl0aGlzLmlzSGFzaENoYW5nZUVuYWJsZWQoKTsKCQl9LAoKCQkvLyAhISBhc3N1bWVzIG1vYmlsZSBuYW1lc3BhY2UgaXMgcHJlc2VudAoJCWlzSGFzaENoYW5nZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJLy8gVE9ETyBhIGxvdCBvZiBkdXBsaWNhdGlvbiBiZXR3ZWVuIHBvcHN0YXRlIGFuZCBoYXNoY2hhbmdlCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIG5ld0V2ZW50ID0gbmV3ICQuRXZlbnQoICJuYXZpZ2F0ZSIgKSwKCQkJCWJlZm9yZU5hdmlnYXRlID0gbmV3ICQuRXZlbnQoICJiZWZvcmVuYXZpZ2F0ZSIgKSwKCQkJCXN0YXRlID0gZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fSwKCQkJCWhyZWYgPSBsb2NhdGlvbi5ocmVmOwoKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmKCBldmVudC5oaXN0b3J5U3RhdGUgKXsKCQkJCSQuZXh0ZW5kKHN0YXRlLCBldmVudC5oaXN0b3J5U3RhdGUpOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gTk9URSB3ZSBsZXQgdGhlIGN1cnJlbnQgc3RhY2sgdW53aW5kIGJlY2F1c2UgYW55IGFzc2lnbm1lbnQgdG8KCQkJLy8gICAgICBsb2NhdGlvbi5oYXNoIHdpbGwgc3RvcCB0aGUgd29ybGQgYW5kIHJ1biB0aGlzIGV2ZW50IGhhbmRsZXIuIEJ5CgkJCS8vICAgICAgZG9pbmcgdGhpcyB3ZSBjcmVhdGUgYSBzaW1pbGFyIGJlaGF2aW9yIHRvIGhhc2hjaGFuZ2Ugb24gaGFzaAoJCQkvLyAgICAgIGFzc2lnbm1lbnQKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCQlzdGF0ZTogc3RhdGUKCQkJCX0pOwoJCQl9LCAwKTsKCQl9LAoKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQsIGRhdGEgKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICk7CgoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIFRyaWdnZXIgdGhlIGhhc2hjaGFuZ2Ugd2l0aCBzdGF0ZSBwcm92aWRlZCBieSB0aGUgdXNlcgoJCQkvLyB0aGF0IGFsdGVyZWQgdGhlIGhhc2gKCQkJJHdpbi50cmlnZ2VyKCBuZXdFdmVudCwgewoJCQkJLy8gVXNlcnMgdGhhdCB3YW50IHRvIGZ1bGx5IG5vcm1hbGl6ZSB0aGUgdHdvIGV2ZW50cwoJCQkJLy8gd2lsbCBuZWVkIHRvIGRvIGhpc3RvcnkgbWFuYWdlbWVudCBkb3duIHRoZSBzdGFjayBhbmQKCQkJCS8vIGFkZCB0aGUgc3RhdGUgdG8gdGhlIGV2ZW50IGJlZm9yZSB0aGlzIGJpbmRpbmcgaXMgZmlyZWQKCQkJCS8vIFRPRE8gY29uc2lkZXIgYWxsb3dpbmcgZm9yIHRoZSBleHBsaWNpdCBhZGRpdGlvbiBvZiBjYWxsYmFja3MKCQkJCS8vICAgICAgdG8gYmUgZmlyZWQgYmVmb3JlIHRoaXMgdmFsdWUgaXMgc2V0IHRvIGF2b2lkIGV2ZW50IHRpbWluZyBpc3N1ZXMKCQkJCXN0YXRlOiBldmVudC5oYXNoY2hhbmdlU3RhdGUgfHwge30KCQkJfSk7CgkJfSwKCgkJLy8gVE9ETyBXZSByZWFsbHkgb25seSB3YW50IHRvIHNldCB0aGlzIHVwIG9uY2UKCQkvLyAgICAgIGJ1dCBJJ20gbm90IGNsZWFyIGlmIHRoZXJlJ3MgYSBiZXRlciB3YXkgdG8gYWNoaWV2ZQoJCS8vICAgICAgdGhpcyB3aXRoIHRoZSBqUXVlcnkgc3BlY2lhbCBldmVudCBzdHJ1Y3R1cmUKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZXMgKSB7CgkJCWlmKCBzZWxmLmJvdW5kICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlzZWxmLmJvdW5kID0gdHJ1ZTsKCgkJCWlmKCBzZWxmLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJwb3BzdGF0ZSI7CgkJCQkkd2luLmJpbmQoICJwb3BzdGF0ZS5uYXZpZ2F0ZSIsIHNlbGYucG9wc3RhdGUgKTsKCQkJfSBlbHNlIGlmICggc2VsZi5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgKXsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAiaGFzaGNoYW5nZSI7CgkJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlLm5hdmlnYXRlIiwgc2VsZi5oYXNoY2hhbmdlICk7CgkJCX0KCQl9Cgl9Owp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCXZhciBwYXRoLCBkb2N1bWVudEJhc2UsICRiYXNlLCBkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciOwoKCQkkLm1vYmlsZS5wYXRoID0gcGF0aCA9IHsKCQkJdWlTdGF0ZUtleTogIiZ1aS1zdGF0ZSIsCgoJCQkvLyBUaGlzIHNjYXJ5IGxvb2tpbmcgcmVndWxhciBleHByZXNzaW9uIHBhcnNlcyBhbiBhYnNvbHV0ZSBVUkwgb3IgaXRzIHJlbGF0aXZlCgkJCS8vIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBhbmQgaGFzaCksIGludG8gdGhlIHZhcmlvdXMKCQkJLy8gY29tcG9uZW50cyAocHJvdG9jb2wsIGhvc3QsIHBhdGgsIHF1ZXJ5LCBmcmFnbWVudCwgZXRjIHRoYXQgbWFrZSB1cCB0aGUKCQkJLy8gVVJMIGFzIHdlbGwgYXMgc29tZSBvdGhlciBjb21tb25seSB1c2VkIHN1Yi1wYXJ0cy4gV2hlbiB1c2VkIHdpdGggUmVnRXhwLmV4ZWMoKQoJCQkvLyBvciBTdHJpbmcubWF0Y2gsIGl0IHBhcnNlcyB0aGUgVVJMIGludG8gYSByZXN1bHRzIGFycmF5IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoJCQkvLwoJCQkvLyAgICAgWzBdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQjbXNnLWNvbnRlbnQKCQkJLy8gICAgIFsxXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgICBbMl06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveAoJCQkvLyAgICAgWzNdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbNF06IGh0dHA6CgkJCS8vICAgICBbNV06IC8vCgkJCS8vICAgICBbNl06IGpibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzddOiBqYmxhczpwYXNzd29yZAoJCQkvLyAgICAgWzhdOiBqYmxhcwoJCQkvLyAgICAgWzldOiBwYXNzd29yZAoJCQkvLyAgICBbMTBdOiBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgWzExXTogbXljb21wYW55LmNvbQoJCQkvLyAgICBbMTJdOiA4MDgwCgkJCS8vICAgIFsxM106IC9tYWlsL2luYm94CgkJCS8vICAgIFsxNF06IC9tYWlsLwoJCQkvLyAgICBbMTVdOiBpbmJveAoJCQkvLyAgICBbMTZdOiA/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgWzE3XTogI21zZy1jb250ZW50CgkJCS8vCgkJCXVybFBhcnNlUkU6IC9eXHMqKCgoKFteOlwvI1w/XSs6KT8oPzooXC9cLykoKD86KChbXjpAXC8jXD9dKykoPzpcOihbXjpAXC8jXD9dKykpPylAKT8oKFteOlwvI1w/XF1cW10rfFxbW15cL1xdQCM/XStcXSkoPzpcOihbMC05XSspKT8pKT8pPyk/KChcLz8oPzpbXlwvXD8jXStcLyspKikoW15cPyNdKikpKT8oXD9bXiNdKyk/KSgjLiopPy8sCgoJCQkvLyBBYnN0cmFjdGlvbiB0byBhZGRyZXNzIHhzcyAoSXNzdWUgIzQ3ODcpIGJ5IHJlbW92aW5nIHRoZSBhdXRob3JpdHkgaW4KCQkJLy8gYnJvd3NlcnMgdGhhdCBhdXRvCWRlY29kZSBpdC4gQWxsIHJlZmVyZW5jZXMgdG8gbG9jYXRpb24uaHJlZiBzaG91bGQgYmUKCQkJLy8gcmVwbGFjZWQgd2l0aCBhIGNhbGwgdG8gdGhpcyBtZXRob2Qgc28gdGhhdCBpdCBjYW4gYmUgZGVhbHQgd2l0aCBwcm9wZXJseSBoZXJlCgkJCWdldExvY2F0aW9uOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHVyaSA9IHVybCA/IHRoaXMucGFyc2VVcmwoIHVybCApIDogbG9jYXRpb24sCgkJCQkJaGFzaCA9IHRoaXMucGFyc2VVcmwoIHVybCB8fCBsb2NhdGlvbi5ocmVmICkuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCS8vIE1ha2Ugc3VyZSB0byBwYXJzZSB0aGUgdXJsIG9yIHRoZSBsb2NhdGlvbiBvYmplY3QgZm9yIHRoZSBoYXNoIGJlY2F1c2UgdXNpbmcgbG9jYXRpb24uaGFzaAoJCQkJLy8gaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbSB0aGUgb2JqZWN0IChsb2NhdGlvbiB1bmxlc3MKCQkJCS8vIHdlJ3JlIHRlc3RpbmcpIHRvIGF2b2lkIHRoZSBpbmNsdXNpb24gb2YgdGhlIGF1dGhvcml0eQoJCQkJcmV0dXJuIHVyaS5wcm90b2NvbCArICIvLyIgKyB1cmkuaG9zdCArIHVyaS5wYXRobmFtZSArIHVyaS5zZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJcGFyc2VMb2NhdGlvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5wYXJzZVVybCggdGhpcy5nZXRMb2NhdGlvbigpICk7CgkJCX0sCgoJCQkvL1BhcnNlIGEgVVJMIGludG8gYSBzdHJ1Y3R1cmUgdGhhdCBhbGxvd3MgZWFzeSBhY2Nlc3MgdG8KCQkJLy9hbGwgb2YgdGhlIFVSTCBjb21wb25lbnRzIGJ5IG5hbWUuCgkJCXBhcnNlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gSWYgd2UncmUgcGFzc2VkIGFuIG9iamVjdCwgd2UnbGwgYXNzdW1lIHRoYXQgaXQgaXMKCQkJCS8vIGEgcGFyc2VkIHVybCBvYmplY3QgYW5kIGp1c3QgcmV0dXJuIGl0IGJhY2sgdG8gdGhlIGNhbGxlci4KCQkJCWlmICggJC50eXBlKCB1cmwgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQkJcmV0dXJuIHVybDsKCQkJCX0KCgkJCQl2YXIgbWF0Y2hlcyA9IHBhdGgudXJsUGFyc2VSRS5leGVjKCB1cmwgfHwgIiIgKSB8fCBbXTsKCgkJCQkJLy8gQ3JlYXRlIGFuIG9iamVjdCB0aGF0IGFsbG93cyB0aGUgY2FsbGVyIHRvIGFjY2VzcyB0aGUgc3ViLW1hdGNoZXMKCQkJCQkvLyBieSBuYW1lLiBOb3RlIHRoYXQgSUUgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiB1bmRlZmluZWQsCgkJCQkJLy8gbGlrZSBhbGwgb3RoZXIgYnJvd3NlcnMgZG8sIHNvIHdlIG5vcm1hbGl6ZSBldmVyeXRoaW5nIHNvIGl0cyBjb25zaXN0ZW50CgkJCQkJLy8gbm8gbWF0dGVyIHdoYXQgYnJvd3NlciB3ZSdyZSBydW5uaW5nIG9uLgoJCQkJCXJldHVybiB7CgkJCQkJCWhyZWY6ICAgICAgICAgbWF0Y2hlc1sgIDAgXSB8fCAiIiwKCQkJCQkJaHJlZk5vSGFzaDogICBtYXRjaGVzWyAgMSBdIHx8ICIiLAoJCQkJCQlocmVmTm9TZWFyY2g6IG1hdGNoZXNbICAyIF0gfHwgIiIsCgkJCQkJCWRvbWFpbjogICAgICAgbWF0Y2hlc1sgIDMgXSB8fCAiIiwKCQkJCQkJcHJvdG9jb2w6ICAgICBtYXRjaGVzWyAgNCBdIHx8ICIiLAoJCQkJCQlkb3VibGVTbGFzaDogIG1hdGNoZXNbICA1IF0gfHwgIiIsCgkJCQkJCWF1dGhvcml0eTogICAgbWF0Y2hlc1sgIDYgXSB8fCAiIiwKCQkJCQkJdXNlcm5hbWU6ICAgICBtYXRjaGVzWyAgOCBdIHx8ICIiLAoJCQkJCQlwYXNzd29yZDogICAgIG1hdGNoZXNbICA5IF0gfHwgIiIsCgkJCQkJCWhvc3Q6ICAgICAgICAgbWF0Y2hlc1sgMTAgXSB8fCAiIiwKCQkJCQkJaG9zdG5hbWU6ICAgICBtYXRjaGVzWyAxMSBdIHx8ICIiLAoJCQkJCQlwb3J0OiAgICAgICAgIG1hdGNoZXNbIDEyIF0gfHwgIiIsCgkJCQkJCXBhdGhuYW1lOiAgICAgbWF0Y2hlc1sgMTMgXSB8fCAiIiwKCQkJCQkJZGlyZWN0b3J5OiAgICBtYXRjaGVzWyAxNCBdIHx8ICIiLAoJCQkJCQlmaWxlbmFtZTogICAgIG1hdGNoZXNbIDE1IF0gfHwgIiIsCgkJCQkJCXNlYXJjaDogICAgICAgbWF0Y2hlc1sgMTYgXSB8fCAiIiwKCQkJCQkJaGFzaDogICAgICAgICBtYXRjaGVzWyAxNyBdIHx8ICIiCgkJCQkJfTsKCQkJfSwKCgkJCS8vVHVybiByZWxQYXRoIGludG8gYW4gYXNib2x1dGUgcGF0aC4gYWJzUGF0aCBpcwoJCQkvL2FuIG9wdGlvbmFsIGFic29sdXRlIHBhdGggd2hpY2ggZGVzY3JpYmVzIHdoYXQKCQkJLy9yZWxQYXRoIGlzIHJlbGF0aXZlIHRvLgoJCQltYWtlUGF0aEFic29sdXRlOiBmdW5jdGlvbiggcmVsUGF0aCwgYWJzUGF0aCApIHsKCQkJCWlmICggcmVsUGF0aCAmJiByZWxQYXRoLmNoYXJBdCggMCApID09PSAiLyIgKSB7CgkJCQkJcmV0dXJuIHJlbFBhdGg7CgkJCQl9CgoJCQkJcmVsUGF0aCA9IHJlbFBhdGggfHwgIiI7CgkJCQlhYnNQYXRoID0gYWJzUGF0aCA/IGFic1BhdGgucmVwbGFjZSggL15cL3woXC9bXlwvXSp8W15cL10rKSQvZywgIiIgKSA6ICIiOwoKCQkJCXZhciBhYnNTdGFjayA9IGFic1BhdGggPyBhYnNQYXRoLnNwbGl0KCAiLyIgKSA6IFtdLAoJCQkJCXJlbFN0YWNrID0gcmVsUGF0aC5zcGxpdCggIi8iICk7CgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCByZWxTdGFjay5sZW5ndGg7IGkrKyApIHsKCQkJCQl2YXIgZCA9IHJlbFN0YWNrWyBpIF07CgkJCQkJc3dpdGNoICggZCApIHsKCQkJCQkJY2FzZSAiLiI6CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiLi4iOgoJCQkJCQkJaWYgKCBhYnNTdGFjay5sZW5ndGggKSB7CgkJCQkJCQkJYWJzU3RhY2sucG9wKCk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCWFic1N0YWNrLnB1c2goIGQgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAiLyIgKyBhYnNTdGFjay5qb2luKCAiLyIgKTsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGlmIGJvdGggdXJscyBoYXZlIHRoZSBzYW1lIGRvbWFpbi4KCQkJaXNTYW1lRG9tYWluOiBmdW5jdGlvbiggYWJzVXJsMSwgYWJzVXJsMiApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCBhYnNVcmwxICkuZG9tYWluID09PSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwyICkuZG9tYWluOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFueSByZWxhdGl2ZSB2YXJpYW50LgoJCQlpc1JlbGF0aXZlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gQWxsIHJlbGF0aXZlIFVybCB2YXJpYW50cyBoYXZlIG9uZSB0aGluZyBpbiBjb21tb24sIG5vIHByb3RvY29sLgoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sID09PSAiIjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbiBhYnNvbHV0ZSB1cmwuCgkJCWlzQWJzb2x1dGVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgIT09ICIiOwoJCQl9LAoKCQkJLy9UdXJuIHRoZSBzcGVjaWZpZWQgcmVhbHRpdmUgVVJMIGludG8gYW4gYWJzb2x1dGUgb25lLiBUaGlzIGZ1bmN0aW9uCgkJCS8vY2FuIGhhbmRsZSBhbGwgcmVsYXRpdmUgdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGZyYWdtZW50KS4KCQkJbWFrZVVybEFic29sdXRlOiBmdW5jdGlvbiggcmVsVXJsLCBhYnNVcmwgKSB7CgkJCQlpZiAoICFwYXRoLmlzUmVsYXRpdmVVcmwoIHJlbFVybCApICkgewoJCQkJCXJldHVybiByZWxVcmw7CgkJCQl9CgoJCQkJaWYgKCBhYnNVcmwgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlhYnNVcmwgPSB0aGlzLmRvY3VtZW50QmFzZTsKCQkJCX0KCgkJCQl2YXIgcmVsT2JqID0gcGF0aC5wYXJzZVVybCggcmVsVXJsICksCgkJCQkJYWJzT2JqID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICksCgkJCQkJcHJvdG9jb2wgPSByZWxPYmoucHJvdG9jb2wgfHwgYWJzT2JqLnByb3RvY29sLAoJCQkJCWRvdWJsZVNsYXNoID0gcmVsT2JqLnByb3RvY29sID8gcmVsT2JqLmRvdWJsZVNsYXNoIDogKCByZWxPYmouZG91YmxlU2xhc2ggfHwgYWJzT2JqLmRvdWJsZVNsYXNoICksCgkJCQkJYXV0aG9yaXR5ID0gcmVsT2JqLmF1dGhvcml0eSB8fCBhYnNPYmouYXV0aG9yaXR5LAoJCQkJCWhhc1BhdGggPSByZWxPYmoucGF0aG5hbWUgIT09ICIiLAoJCQkJCXBhdGhuYW1lID0gcGF0aC5tYWtlUGF0aEFic29sdXRlKCByZWxPYmoucGF0aG5hbWUgfHwgYWJzT2JqLmZpbGVuYW1lLCBhYnNPYmoucGF0aG5hbWUgKSwKCQkJCQlzZWFyY2ggPSByZWxPYmouc2VhcmNoIHx8ICggIWhhc1BhdGggJiYgYWJzT2JqLnNlYXJjaCApIHx8ICIiLAoJCQkJCWhhc2ggPSByZWxPYmouaGFzaDsKCgkJCQlyZXR1cm4gcHJvdG9jb2wgKyBkb3VibGVTbGFzaCArIGF1dGhvcml0eSArIHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCS8vQWRkIHNlYXJjaCAoYWthIHF1ZXJ5KSBwYXJhbXMgdG8gdGhlIHNwZWNpZmllZCB1cmwuCgkJCWFkZFNlYXJjaFBhcmFtczogZnVuY3Rpb24oIHVybCwgcGFyYW1zICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwID0gKCB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApID8gJC5wYXJhbSggcGFyYW1zICkgOiBwYXJhbXMsCgkJCQkJcyA9IHUuc2VhcmNoIHx8ICI/IjsKCQkJCXJldHVybiB1LmhyZWZOb1NlYXJjaCArIHMgKyAoIHMuY2hhckF0KCBzLmxlbmd0aCAtIDEgKSAhPT0gIj8iID8gIiYiIDogIiIgKSArIHAgKyAoIHUuaGFzaCB8fCAiIiApOwoJCQl9LAoKCQkJY29udmVydFVybFRvRGF0YVVybDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICk7CgkJCQlpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIHUgKSApIHsKCQkJCQkvLyBGb3IgZW1iZWRkZWQgcGFnZXMsIHJlbW92ZSB0aGUgZGlhbG9nIGhhc2gga2V5IGFzIGluIGdldEZpbGVQYXRoKCksCgkJCQkJLy8gYW5kIHJlbW92ZSBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoCgkJCQkJCS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdCgkJCQkJCS5yZXBsYWNlKCAvXiMvLCAiIiApCgkJCQkJCS5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1NhbWVEb21haW4oIHUsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSB7CgkJCQkJcmV0dXJuIHUuaHJlZk5vSGFzaC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJCX0KCgkJCQlyZXR1cm4gd2luZG93LmRlY29kZVVSSUNvbXBvbmVudChhYnNVcmwpOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYgKCBuZXdQYXRoID09PSB1bmRlZmluZWQgKSB7CgkJCQkJbmV3UGF0aCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCQl9CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIG5ld1BhdGggKS5yZXBsYWNlKCAvW15cL10qXC5bXlwvKl0rJC8sICcnICk7CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKTsKCQkJfSwKCgkJCS8vanVzdCByZXR1cm4gdGhlIHVybCB3aXRob3V0IGFuIGluaXRpYWwgIwoJCQlzdHJpcEhhc2g6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCX0sCgoJCQlzdHJpcFF1ZXJ5UGFyYW1zOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJaXNIYXNoVmFsaWQ6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuICggL14jW14jXSskLyApLnRlc3QoIGhhc2ggKTsKCQkJfSwKCgkJCS8vY2hlY2sgd2hldGhlciBhIHVybCBpcyByZWZlcmVuY2luZyB0aGUgc2FtZSBkb21haW4sIG9yIGFuIGV4dGVybmFsIGRvbWFpbiBvciBkaWZmZXJlbnQgcHJvdG9jb2wKCQkJLy9jb3VsZCBiZSBtYWlsdG8sIGV0YwoJCQlpc0V4dGVybmFsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCQkJCXJldHVybiB1LnByb3RvY29sICYmIHUuZG9tYWluICE9PSB0aGlzLmRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgdGhpcy5kb2N1bWVudFVybCBhbmQgdGhlIGRvY3VtZW50QmFzZS4gVGhlIG1haW4gcmVhc29uIGZvciB0aGlzCgkJCQkvL2lzIHRoYXQgbGlua3MgZW1iZWRkZWQgd2l0aGluIGV4dGVybmFsIGRvY3VtZW50cyB3aWxsIHJlZmVyIHRvIHRoZQoJCQkJLy9hcHBsaWNhdGlvbiBkb2N1bWVudCwgd2hlcmVhcyBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gdGhlIGFwcGxpY2F0aW9uCgkJCQkvL2RvY3VtZW50IHdpbGwgYmUgcmVzb2x2ZWQgYWdhaW5zdCB0aGUgZG9jdW1lbnQgYmFzZS4KCQkJCWlmICggdS5wcm90b2NvbCAhPT0gIiIgKSB7CgkJCQkJcmV0dXJuICggIXRoaXMuaXNQYXRoKHUuaGFzaCkgJiYgdS5oYXNoICYmICggdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwgKCB0aGlzLmRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgKSApOwoJCQkJfQoJCQkJcmV0dXJuICggL14jLyApLnRlc3QoIHUuaHJlZiApOwoJCQl9LAoKCQkJc3F1YXNoOiBmdW5jdGlvbiggdXJsLCByZXNvbHV0aW9uVXJsICkgewoJCQkJdmFyIHN0YXRlLCBocmVmLCBjbGVhbmVkVXJsLCBzZWFyY2gsIHN0YXRlSW5kZXgsCgkJCQkJaXNQYXRoID0gdGhpcy5pc1BhdGgoIHVybCApLAoJCQkJCXVyaSA9IHRoaXMucGFyc2VVcmwoIHVybCApLAoJCQkJCXByZXNlcnZlZEhhc2ggPSB1cmkuaGFzaCwKCQkJCQl1aVN0YXRlID0gIiI7CgoJCQkJLy8gcHJvZHVjZSBhIHVybCBhZ2FpbnN0IHdoaWNoIHdlIGNhbiByZXNvbGUgdGhlIHByb3ZpZGVkIHBhdGgKCQkJCXJlc29sdXRpb25VcmwgPSByZXNvbHV0aW9uVXJsIHx8IChwYXRoLmlzUGF0aCh1cmwpID8gcGF0aC5nZXRMb2NhdGlvbigpIDogcGF0aC5nZXREb2N1bWVudFVybCgpKTsKCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGFueXRoaW5nIGJ1dCBhIHNpbXBsZSBzdHJpbmcsIHJlbW92ZSBhbnkgcHJlY2VkaW5nIGhhc2gKCQkJCS8vIGVnICNmb28vYmFyIC0+IGZvby9iYXIKCQkJCS8vICAgICNmb28gLT4gI2ZvbwoJCQkJY2xlYW5lZFVybCA9IGlzUGF0aCA/IHBhdGguc3RyaXBIYXNoKCB1cmwgKSA6IHVybDsKCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGEgZnVsbCB1cmwgd2l0aCBhIGhhc2ggY2hlY2sgaWYgdGhlIHBhcnNlZCBoYXNoIGlzIGEgcGF0aAoJCQkJLy8gaWYgaXQgaXMsIHN0cmlwIHRoZSAjLCBhbmQgdXNlIGl0IG90aGVyd2lzZSBjb250aW51ZSB3aXRob3V0IGNoYW5nZQoJCQkJY2xlYW5lZFVybCA9IHBhdGguaXNQYXRoKCB1cmkuaGFzaCApID8gcGF0aC5zdHJpcEhhc2goIHVyaS5oYXNoICkgOiBjbGVhbmVkVXJsOwoKCQkJCS8vIFNwbGl0IHRoZSBVSSBTdGF0ZSBrZXlzIG9mZiB0aGUgaHJlZgoJCQkJc3RhdGVJbmRleCA9IGNsZWFuZWRVcmwuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICk7CgoJCQkJLy8gc3RvcmUgdGhlIHVpIHN0YXRlIGtleXMgZm9yIHVzZQoJCQkJaWYoIHN0YXRlSW5kZXggPiAtMSApewoJCQkJCXVpU3RhdGUgPSBjbGVhbmVkVXJsLnNsaWNlKCBzdGF0ZUluZGV4ICk7CgkJCQkJY2xlYW5lZFVybCA9IGNsZWFuZWRVcmwuc2xpY2UoIDAsIHN0YXRlSW5kZXggKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHRoZSBjbGVhbmVkVXJsIGFic29sdXRlIHJlbGF0aXZlIHRvIHRoZSByZXNvbHV0aW9uIHVybAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBjbGVhbmVkVXJsLCByZXNvbHV0aW9uVXJsICk7CgoJCQkJLy8gZ3JhYiB0aGUgc2VhcmNoIGZyb20gdGhlIHJlc29sdmVkIHVybCBzaW5jZSBwYXJzaW5nIGZyb20KCQkJCS8vIHRoZSBwYXNzZWQgdXJsIG1heSBub3QgeWllbGQgdGhlIGNvcnJlY3QgcmVzdWx0CgkJCQlzZWFyY2ggPSB0aGlzLnBhcnNlVXJsKCBocmVmICkuc2VhcmNoOwoKCQkJCS8vIFRPRE8gYWxsIHRoaXMgY3JhcCBpcyB0ZXJyaWJsZSwgY2xlYW4gaXQgdXAKCQkJCWlmICggaXNQYXRoICkgewoJCQkJCS8vIHJlamVjdCB0aGUgaGFzaCBpZiBpdCdzIGEgcGF0aCBvciBpdCdzIGp1c3QgYSBkaWFsb2cga2V5CgkJCQkJaWYoIHBhdGguaXNQYXRoKCBwcmVzZXJ2ZWRIYXNoICkgfHwgcHJlc2VydmVkSGFzaC5yZXBsYWNlKCIjIiwgIiIpLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAwKSB7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIjsKCQkJCQl9CgoJCQkJCS8vIEFwcGVuZCB0aGUgVUkgU3RhdGUga2V5cyB3aGVyZSBpdCBleGlzdHMgYW5kIGl0J3MgYmVlbiByZW1vdmVkCgkJCQkJLy8gZnJvbSB0aGUgdXJsCgkJCQkJaWYoIHVpU3RhdGUgJiYgcHJlc2VydmVkSGFzaC5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gLTEpewoJCQkJCQlwcmVzZXJ2ZWRIYXNoICs9IHVpU3RhdGU7CgkJCQkJfQoKCQkJCQkvLyBtYWtlIHN1cmUgdGhhdCBwb3VuZCBpcyBvbiB0aGUgZnJvbnQgb2YgdGhlIGhhc2gKCQkJCQlpZiggcHJlc2VydmVkSGFzaC5pbmRleE9mKCAiIyIgKSA9PT0gLTEgJiYgcHJlc2VydmVkSGFzaCAhPT0gIiIgKXsKCQkJCQkJcHJlc2VydmVkSGFzaCA9ICIjIiArIHByZXNlcnZlZEhhc2g7CgkJCQkJfQoKCQkJCQkvLyByZWNvbnN0cnVjdCBlYWNoIG9mIHRoZSBwaWVjZXMgd2l0aCB0aGUgbmV3IHNlYXJjaCBzdHJpbmcgYW5kIGhhc2gKCQkJCQlocmVmID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJCWhyZWYgPSBocmVmLnByb3RvY29sICsgIi8vIiArIGhyZWYuaG9zdCArIGhyZWYucGF0aG5hbWUgKyBzZWFyY2ggKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJfSBlbHNlIHsKCQkJCQlocmVmICs9IGhyZWYuaW5kZXhPZiggIiMiICkgPiAtMSA/IHVpU3RhdGUgOiAiIyIgKyB1aVN0YXRlOwoJCQkJfQoKCQkJCXJldHVybiBocmVmOwoJCQl9LAoKCQkJaXNQcmVzZXJ2YWJsZUhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIGhhc2gucmVwbGFjZSggIiMiLCAiIiApLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAwOwoJCQl9CgkJfTsKCgkJcGF0aC5kb2N1bWVudFVybCA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkkYmFzZSA9ICQoICJoZWFkIiApLmZpbmQoICJiYXNlIiApOwoKCQlwYXRoLmRvY3VtZW50QmFzZSA9ICRiYXNlLmxlbmd0aCA/CgkJCXBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCAkYmFzZS5hdHRyKCAiaHJlZiIgKSwgcGF0aC5kb2N1bWVudFVybC5ocmVmICkgKSA6CgkJCXBhdGguZG9jdW1lbnRVcmw7CgoJCXBhdGguZG9jdW1lbnRCYXNlRGlmZmVycyA9IChwYXRoLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggIT09IHBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2gpOwoKCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkJcGF0aC5nZXREb2N1bWVudFVybCA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50VXJsICkgOiBwYXRoLmRvY3VtZW50VXJsLmhyZWY7CgkJfTsKCgkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkJcGF0aC5nZXREb2N1bWVudEJhc2UgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudEJhc2UgKSA6IHBhdGguZG9jdW1lbnRCYXNlLmhyZWY7CgkJfTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aDsKCgkkLm1vYmlsZS5IaXN0b3J5ID0gZnVuY3Rpb24oIHN0YWNrLCBpbmRleCApIHsKCQl0aGlzLnN0YWNrID0gc3RhY2sgfHwgW107CgkJdGhpcy5hY3RpdmVJbmRleCA9IGluZGV4IHx8IDA7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLkhpc3RvcnkucHJvdG90eXBlLCB7CgkJZ2V0QWN0aXZlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggXTsKCQl9LAoKCQlnZXRMYXN0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMucHJldmlvdXNJbmRleCBdOwoJCX0sCgoJCWdldE5leHQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCArIDEgXTsKCQl9LAoKCQlnZXRQcmV2OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggLSAxIF07CgkJfSwKCgkJLy8gYWRkTmV3IGlzIHVzZWQgd2hlbmV2ZXIgYSBuZXcgcGFnZSBpcyBhZGRlZAoJCWFkZDogZnVuY3Rpb24oIHVybCwgZGF0YSApewoJCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJCS8vaWYgdGhlcmUncyBmb3J3YXJkIGhpc3RvcnksIHdpcGUgaXQKCQkJaWYgKCB0aGlzLmdldE5leHQoKSApIHsKCQkJCXRoaXMuY2xlYXJGb3J3YXJkKCk7CgkJCX0KCgkJCS8vIGlmIHRoZSBoYXNoIGlzIGluY2x1ZGVkIGluIHRoZSBkYXRhIG1ha2Ugc3VyZSB0aGUgc2hhcGUKCQkJLy8gaXMgY29uc2lzdGVudCBmb3IgY29tcGFyaXNvbgoJCQlpZiggZGF0YS5oYXNoICYmIGRhdGEuaGFzaC5pbmRleE9mKCAiIyIgKSA9PT0gLTEpIHsKCQkJCWRhdGEuaGFzaCA9ICIjIiArIGRhdGEuaGFzaDsKCQkJfQoKCQkJZGF0YS51cmwgPSB1cmw7CgkJCXRoaXMuc3RhY2sucHVzaCggZGF0YSApOwoJCQl0aGlzLmFjdGl2ZUluZGV4ID0gdGhpcy5zdGFjay5sZW5ndGggLSAxOwoJCX0sCgoJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCWNsZWFyRm9yd2FyZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc3RhY2sgPSB0aGlzLnN0YWNrLnNsaWNlKCAwLCB0aGlzLmFjdGl2ZUluZGV4ICsgMSApOwoJCX0sCgoJCWZpbmQ6IGZ1bmN0aW9uKCB1cmwsIHN0YWNrLCBlYXJseVJldHVybiApIHsKCQkJc3RhY2sgPSBzdGFjayB8fCB0aGlzLnN0YWNrOwoKCQkJdmFyIGVudHJ5LCBpLCBsZW5ndGggPSBzdGFjay5sZW5ndGgsIGluZGV4OwoKCQkJZm9yICggaSA9IDA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWVudHJ5ID0gc3RhY2tbaV07CgoJCQkJaWYgKCBkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5LnVybCkgfHwKCQkJCQlkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5Lmhhc2gpICkgewoJCQkJCWluZGV4ID0gaTsKCgkJCQkJaWYoIGVhcmx5UmV0dXJuICkgewoJCQkJCQlyZXR1cm4gaW5kZXg7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gaW5kZXg7CgkJfSwKCgkJY2xvc2VzdDogZnVuY3Rpb24oIHVybCApIHsKCQkJdmFyIGNsb3Nlc3QsIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gRmlyc3QsIHRha2UgdGhlIHNsaWNlIG9mIHRoZSBoaXN0b3J5IHN0YWNrIGJlZm9yZSB0aGUgY3VycmVudCBpbmRleCBhbmQgc2VhcmNoCgkJCS8vIGZvciBhIHVybCBtYXRjaC4gSWYgb25lIGlzIGZvdW5kLCB3ZSdsbCBhdm9pZCBhdm9pZCBsb29raW5nIHRocm91Z2ggZm9yd2FyZCBoaXN0b3J5CgkJCS8vIE5PVEUgdGhlIHByZWZlcmVuY2UgZm9yIGJhY2t3YXJkIGhpc3RvcnkgbW92ZW1lbnQgaXMgZHJpdmVuIGJ5IHRoZSBmYWN0IHRoYXQKCQkJLy8gICAgICBtb3N0IG1vYmlsZSBicm93c2VycyBvbmx5IGhhdmUgYSBkZWRpY2F0ZWQgYmFjayBidXR0b24sIGFuZCB1c2VycyByYXJlbHkgdXNlCgkJCS8vICAgICAgdGhlIGZvcndhcmQgYnV0dG9uIGluIGRlc2t0b3AgYnJvd3NlciBhbnlob3cKCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKDAsIGEpICk7CgoJCQkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbiBiYWNrd2FyZCBoaXN0b3J5IGNoZWNrIGZvcndhcmQuIFRoZSBgdHJ1ZWAKCQkJLy8gdmFsdWUgcGFzc2VkIGFzIHRoZSB0aGlyZCBwYXJhbWV0ZXIgY2F1c2VzIHRoZSBmaW5kIG1ldGhvZCB0byBicmVhawoJCQkvLyBvbiB0aGUgZmlyc3QgbWF0Y2ggaW4gdGhlIGZvcndhcmQgaGlzdG9yeSBzbGljZS4gVGhlIHN0YXJ0aW5nIGluZGV4CgkJCS8vIG9mIHRoZSBzbGljZSBtdXN0IHRoZW4gYmUgYWRkZWQgdG8gdGhlIHJlc3VsdCB0byBnZXQgdGhlIGVsZW1lbnQgaW5kZXgKCQkJLy8gaW4gdGhlIG9yaWdpbmFsIGhpc3Rvcnkgc3RhY2sgOiggOigKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGh5cGVyIGNvbmZ1c2luZyBhbmQgc2hvdWxkIGJlIGNsZWFuZWQgdXAgKHVnaCBzbyBiYWQpCgkJCWlmKCBjbG9zZXN0ID09PSB1bmRlZmluZWQgKSB7CgkJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoYSksIHRydWUgKTsKCQkJCWNsb3Nlc3QgPSBjbG9zZXN0ID09PSB1bmRlZmluZWQgPyBjbG9zZXN0IDogY2xvc2VzdCArIGE7CgkJCX0KCgkJCXJldHVybiBjbG9zZXN0OwoJCX0sCgoJCWRpcmVjdDogZnVuY3Rpb24oIG9wdHMgKSB7CgkJCXZhciBuZXdBY3RpdmVJbmRleCA9IHRoaXMuY2xvc2VzdCggb3B0cy51cmwgKSwgYSA9IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCS8vIHJlY29yZCB0aGUgcHJldmlvdXMgaW5kZXggZm9yIHJlZmVyZW5jZQoJCQlpZiggbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuYWN0aXZlSW5kZXggPSBuZXdBY3RpdmVJbmRleDsKCQkJCXRoaXMucHJldmlvdXNJbmRleCA9IGE7CgkJCX0KCgkJCS8vIGludm9rZSBjYWxsYmFja3Mgd2hlcmUgYXBwcm9wcmlhdGUKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGFsc28gY29udm9sdXRlZCBhbmQgY29uZnVzaW5nCgkJCWlmICggbmV3QWN0aXZlSW5kZXggPCBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5iYWNrIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAnYmFjaycgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPiBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5mb3J3YXJkIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAnZm9yd2FyZCcgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPT09IHVuZGVmaW5lZCAmJiBvcHRzLm1pc3NpbmcgKXsKCQkJCW9wdHMubWlzc2luZyggdGhpcy5nZXRBY3RpdmUoKSApOwoJCQl9CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aCwKCQlpbml0aWFsSHJlZiA9IGxvY2F0aW9uLmhyZWY7CgoJJC5tb2JpbGUuTmF2aWdhdG9yID0gZnVuY3Rpb24oIGhpc3RvcnkgKSB7CgkJdGhpcy5oaXN0b3J5ID0gaGlzdG9yeTsKCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gdHJ1ZTsKCgkJJC5tb2JpbGUud2luZG93LmJpbmQoewoJCQkicG9wc3RhdGUuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMucG9wc3RhdGUsIHRoaXMgKSwKCQkJImhhc2hjaGFuZ2UuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMuaGFzaGNoYW5nZSwgdGhpcyApCgkJfSk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLk5hdmlnYXRvci5wcm90b3R5cGUsIHsKCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCXZhciBzdGF0ZSwgaHJlZiwgaGFzaCA9IHBhdGguaXNQYXRoKHVybCkgPyBwYXRoLnN0cmlwSGFzaCh1cmwpIDogdXJsOwoKCQkJaHJlZiA9IHBhdGguc3F1YXNoKCB1cmwgKTsKCgkJCS8vIG1ha2Ugc3VyZSB0byBwcm92aWRlIHRoaXMgaW5mb3JtYXRpb24gd2hlbiBpdCBpc24ndCBleHBsaWNpdGx5IHNldCBpbiB0aGUKCQkJLy8gZGF0YSBvYmplY3QgdGhhdCB3YXMgcGFzc2VkIHRvIHRoZSBzcXVhc2ggbWV0aG9kCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJaGFzaDogaGFzaCwKCQkJCXVybDogaHJlZgoJCQl9LCBkYXRhKTsKCgkJCS8vIHJlcGxhY2UgdGhlIGN1cnJlbnQgdXJsIHdpdGggdGhlIG5ldyBocmVmIGFuZCBzdG9yZSB0aGUgc3RhdGUKCQkJLy8gTm90ZSB0aGF0IGluIHNvbWUgY2FzZXMgd2UgbWlnaHQgYmUgcmVwbGFjaW5nIGFuIHVybCB3aXRoIHRoZQoJCQkvLyBzYW1lIHVybC4gV2UgZG8gdGhpcyBhbnl3YXlzIGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdAoJCQkvLyBhbGwgb2Ygb3VyIGhpc3RvcnkgZW50cmllcyBoYXZlIGEgc3RhdGUgb2JqZWN0IGFzc29jaWF0ZWQgd2l0aAoJCQkvLyB0aGVtLiBUaGlzIGFsbG93cyB1cyB0byB3b3JrIGFyb3VuZCB0aGUgY2FzZSB3aGVyZSAkLm1vYmlsZS5iYWNrKCkKCQkJLy8gaXMgY2FsbGVkIHRvIHRyYW5zaXRpb24gZnJvbSBhbiBleHRlcm5hbCBwYWdlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuCgkJCS8vIEluIHRoYXQgcGFydGljdWxhciBjYXNlLCBhIGhhc2hjaGFuZ2UgZXZlbnQgaXMgKk5PVCogZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLgoJCQkvLyBFbnN1cmluZyBlYWNoIGhpc3RvcnkgZW50cnkgaGFzIGEgc3RhdGUgb2JqZWN0IG1lYW5zIHRoYXQgb25Qb3BTdGF0ZSgpCgkJCS8vIHdpbGwgYWx3YXlzIHRyaWdnZXIgb3VyIGhhc2hjaGFuZ2UgY2FsbGJhY2sgZXZlbiB3aGVuIGEgaGFzaGNoYW5nZSBldmVudAoJCQkvLyBpcyBub3QgZmlyZWQuCgkJCXdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSggc3RhdGUsIHN0YXRlLnRpdGxlIHx8IGRvY3VtZW50LnRpdGxlLCBocmVmICk7CgoJCQlyZXR1cm4gc3RhdGU7CgkJfSwKCgkJaGFzaDogZnVuY3Rpb24oIHVybCwgaHJlZiApIHsKCQkJdmFyIHBhcnNlZCwgbG9jLCBoYXNoOwoKCQkJLy8gR3JhYiB0aGUgaGFzaCBmb3IgcmVjb3JkaW5nLiBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgKCQkJLy8gd2UgdXNlZCB0aGUgcGFyc2VkIHZlcnNpb24gb2YgdGhlIHNxdWFzaGVkIHVybCB0byByZWNvbnN0cnVjdCwKCQkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBpdCdzIGEgaGFzaCBhbmQgc3RvcmUgaXQgZGlyZWN0bHkKCQkJcGFyc2VkID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCWxvYyA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkJaWYoIGxvYy5wYXRobmFtZSArIGxvYy5zZWFyY2ggPT09IHBhcnNlZC5wYXRobmFtZSArIHBhcnNlZC5zZWFyY2ggKSB7CgkJCQkvLyBJZiB0aGUgcGF0aG5hbWUgYW5kIHNlYXJjaCBvZiB0aGUgcGFzc2VkIHVybCBpcyBpZGVudGljYWwgdG8gdGhlIGN1cnJlbnQgbG9jCgkJCQkvLyB0aGVuIHdlIG11c3QgdXNlIHRoZSBoYXNoLiBPdGhlcndpc2UgdGhlcmUgd2lsbCBiZSBubyBldmVudAoJCQkJLy8gZWcsIHVybCA9ICIvZm9vL2Jhcj9iYXojYmFuZyIsIGxvY2F0aW9uLmhyZWYgPSAiaHR0cDovL2V4YW1wbGUuY29tL2Zvby9iYXI/YmF6IgoJCQkJaGFzaCA9IHBhcnNlZC5oYXNoID8gcGFyc2VkLmhhc2ggOiBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoOwoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzUGF0aCh1cmwpICkgewoJCQkJdmFyIHJlc29sdmVkID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJLy8gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoLCBtYWtlIGl0IGRvbWFpbiByZWxhdGl2ZSBhbmQgcmVtb3ZlIGFueSB0cmFpbGluZyBoYXNoCgkJCQloYXNoID0gcmVzb2x2ZWQucGF0aG5hbWUgKyByZXNvbHZlZC5zZWFyY2ggKyAocGF0aC5pc1ByZXNlcnZhYmxlSGFzaCggcmVzb2x2ZWQuaGFzaCApPyByZXNvbHZlZC5oYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6ICIiKTsKCQkJfSBlbHNlIHsKCQkJCWhhc2ggPSB1cmw7CgkJCX0KCgkJCXJldHVybiBoYXNoOwoJCX0sCgoJCS8vIFRPRE8gcmVjb25zaWRlciBuYW1lCgkJZ286IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2gsIHBvcHN0YXRlRXZlbnQsCgkJCQlpc1BvcFN0YXRlRXZlbnQgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCk7CgoJCQkvLyBHZXQgdGhlIHVybCBhcyBpdCB3b3VsZCBsb29rIHNxdWFzaGVkIG9uIHRvIHRoZSBjdXJyZW50IHJlc29sdXRpb24gdXJsCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBzb3J0IG91dCB3aGF0IHRoZSBoYXNoIHNvdWxkIGJlIGZyb20gdGhlIHVybAoJCQloYXNoID0gdGhpcy5oYXNoKCB1cmwsIGhyZWYgKTsKCgkJCS8vIEhlcmUgd2UgcHJldmVudCB0aGUgbmV4dCBoYXNoIGNoYW5nZSBvciBwb3BzdGF0ZSBldmVudCBmcm9tIGRvaW5nIGFueQoJCQkvLyBoaXN0b3J5IG1hbmFnZW1lbnQuIEluIHRoZSBjYXNlIG9mIGhhc2hjaGFuZ2Ugd2UgZG9uJ3Qgc3dhbGxvdyBpdAoJCQkvLyBpZiB0aGVyZSB3aWxsIGJlIG5vIGhhc2hjaGFuZ2UgZmlyZWQgKHNpbmNlIHRoYXQgd29uJ3QgcmVzZXQgdGhlIHZhbHVlKQoJCQkvLyBhbmQgd2lsbCBzd2FsbG93IHRoZSBmb2xsb3dpbmcgaGFzaGNoYW5nZQoJCQlpZiggbm9FdmVudHMgJiYgaGFzaCAhPT0gcGF0aC5zdHJpcEhhc2gocGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCkgKSB7CgkJCQl0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSA9IG5vRXZlbnRzOwoJCQl9CgoJCQkvLyBJTVBPUlRBTlQgaW4gdGhlIGNhc2Ugd2hlcmUgcG9wc3RhdGUgaXMgc3VwcG9ydGVkIHRoZSBldmVudCB3aWxsIGJlIHRyaWdnZXJlZAoJCQkvLyAgICAgIGRpcmVjdGx5LCBzdG9wcGluZyBmdXJ0aGVyIGV4ZWN1dGlvbiAtIGllLCBpbnRlcnVwdGluZyB0aGUgZmxvdyBvZiB0aGlzCgkJCS8vICAgICAgbWV0aG9kIGNhbGwgdG8gZmlyZSBiaW5kaW5ncyBhdCB0aGlzIGV4cHJlc3Npb24uIEJlbG93IHRoZSBuYXZpZ2F0ZSBtZXRob2QKCQkJLy8gICAgICB0aGVyZSBpcyBhIGJpbmRpbmcgdG8gY2F0Y2ggdGhpcyBldmVudCBhbmQgc3RvcCBpdHMgcHJvcGFnYXRpb24uCgkJCS8vCgkJCS8vICAgICAgV2UgdGhlbiB0cmlnZ2VyIGEgbmV3IHBvcHN0YXRlIGV2ZW50IG9uIHRoZSB3aW5kb3cgd2l0aCBhIG51bGwgc3RhdGUKCQkJLy8gICAgICBzbyB0aGF0IHRoZSBuYXZpZ2F0ZSBldmVudHMgY2FuIGNvbmNsdWRlIHRoZWlyIHdvcmsgcHJvcGVybHkKCQkJLy8KCQkJLy8gaWYgdGhlIHVybCBpcyBhIHBhdGggd2Ugd2FudCB0byBwcmVzZXJ2ZSB0aGUgcXVlcnkgcGFyYW1zIHRoYXQgYXJlIGF2YWlsYWJsZSBvbgoJCQkvLyB0aGUgY3VycmVudCB1cmwuCgkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IHRydWU7CgkJCXdpbmRvdy5sb2NhdGlvbi5oYXNoID0gaGFzaDsKCgkJCS8vIElmIHBvcHN0YXRlIGlzIGVuYWJsZWQgYW5kIHRoZSBicm93c2VyIHRyaWdnZXJzIGBwb3BzdGF0ZWAgZXZlbnRzIHdoZW4gdGhlIGhhc2gKCQkJLy8gaXMgc2V0ICh0aGlzIG9mdGVuIGhhcHBlbnMgaW1tZWRpYXRlbHkgaW4gYnJvd3NlcnMgbGlrZSBDaHJvbWUpLCB0aGVuIHRoZQoJCQkvLyB0aGlzIGZsYWcgd2lsbCBiZSBzZXQgdG8gZmFsc2UgYWxyZWFkeS4gSWYgaXQncyBhIGJyb3dzZXIgdGhhdCBkb2VzIG5vdCB0cmlnZ2VyCgkJCS8vIGEgYHBvcHN0YXRlYCBvbiBoYXNoIGFzc2lnbmVtZW50IG9yIGByZXBsYWNlU3RhdGVgIHRoZW4gd2UgbmVlZCBhdm9pZCB0aGUgYnJhbmNoCgkJCS8vIHRoYXQgc3dhbGxvd3MgdGhlIGV2ZW50IGNyZWF0ZWQgYnkgdGhlIHBvcHN0YXRlIGdlbmVyYXRlZCBieSB0aGUgaGFzaCBhc3NpZ25tZW50CgkJCS8vIEF0IHRoZSB0aW1lIG9mIHRoaXMgd3JpdGluZyB0aGlzIGhhcHBlbnMgd2l0aCBPcGVyYSAxMiBhbmQgc29tZSB2ZXJzaW9uIG9mIElFCgkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IGZhbHNlOwoKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQl1cmw6IGhyZWYsCgkJCQloYXNoOiBoYXNoLAoJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCX0sIGRhdGEpOwoKCQkJaWYoIGlzUG9wU3RhdGVFdmVudCApIHsKCQkJCXBvcHN0YXRlRXZlbnQgPSBuZXcgJC5FdmVudCggInBvcHN0YXRlIiApOwoJCQkJcG9wc3RhdGVFdmVudC5vcmlnaW5hbEV2ZW50ID0gewoJCQkJCXR5cGU6ICJwb3BzdGF0ZSIsCgkJCQkJc3RhdGU6IG51bGwKCQkJCX07CgoJCQkJdGhpcy5zcXVhc2goIHVybCwgc3RhdGUgKTsKCgkJCQkvLyBUcmlnZ2VyIGEgbmV3IGZhdXggcG9wc3RhdGUgZXZlbnQgdG8gcmVwbGFjZSB0aGUgb25lIHRoYXQgd2UKCQkJCS8vIGNhdWdodCB0aGF0IHdhcyB0cmlnZ2VyZWQgYnkgdGhlIGhhc2ggc2V0dGluZyBhYm92ZS4KCQkJCWlmKCAhbm9FdmVudHMgKSB7CgkJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IHRydWU7CgkJCQkJJC5tb2JpbGUud2luZG93LnRyaWdnZXIoIHBvcHN0YXRlRXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVjb3JkIHRoZSBoaXN0b3J5IGVudHJ5IHNvIHRoYXQgdGhlIGluZm9ybWF0aW9uIGNhbiBiZSBpbmNsdWRlZAoJCQkvLyBpbiBoYXNoY2hhbmdlIGV2ZW50IGRyaXZlbiBuYXZpZ2F0ZSBldmVudHMgaW4gYSBzaW1pbGFyIGZhc2hpb24gdG8KCQkJLy8gdGhlIHN0YXRlIHRoYXQncyBwcm92aWRlZCBieSBwb3BzdGF0ZQoJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgkJfSwKCgoJCS8vIFRoaXMgYmluZGluZyBpcyBpbnRlbmRlZCB0byBjYXRjaCB0aGUgcG9wc3RhdGUgZXZlbnRzIHRoYXQgYXJlIGZpcmVkCgkJLy8gd2hlbiBleGVjdXRpb24gb2YgdGhlIGAkLm5hdmlnYXRlYCBtZXRob2Qgc3RvcHMgYXQgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7CgkJLy8gYW5kIGNvbXBsZXRlbHkgcHJldmVudCB0aGVtIGZyb20gcHJvcGFnYXRpbmcuIFRoZSBwb3BzdGF0ZSBldmVudCB3aWxsIHRoZW4gYmUKCQkvLyByZXRyaWdnZXJlZCBhZnRlciBleGVjdXRpb24gcmVzdW1lcwoJCS8vCgkJLy8gVE9ETyBncmFiIHRoZSBvcmlnaW5hbCBldmVudCBoZXJlIGFuZCB1c2UgaXQgZm9yIHRoZSBzeW50aGV0aWMgZXZlbnQgaW4gdGhlCgkJLy8gICAgICBzZWNvbmQgaGFsZiBvZiB0aGUgbmF2aWdhdGUgZXhlY3V0aW9uIHRoYXQgd2lsbCBmb2xsb3cgdGhpcyBiaW5kaW5nCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGFjdGl2ZSwgaGFzaCwgc3RhdGUsIGNsb3Nlc3RJbmRleDsKCgkJCS8vIFBhcnRseSB0byBzdXBwb3J0IG91ciB0ZXN0IHN1aXRlIHdoaWNoIG1hbnVhbGx5IGFsdGVycyB0aGUgc3VwcG9ydAoJCQkvLyB2YWx1ZSB0byB0ZXN0IGhhc2hjaGFuZ2UuIFBhcnRseSB0byBwcmV2ZW50IGFsbCBhcm91bmQgd2VpcmRuZXNzCgkJCWlmKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBieSB0aGUgYWN0dWFsIGFsdGVyYXRpb24gb2YgdGhlIGhhc2gKCQkJLy8gcHJldmVudCBpdCBjb21wbGV0ZWx5LiBIaXN0b3J5IGlzIHRyYWNrZWQgbWFudWFsbHkKCQkJaWYoIHRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSApIHsKCQkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IGZhbHNlOwoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIGlmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBhZnRlciB0aGUgYHJlcGxhY2VTdGF0ZWAgY2FsbCBpbiB0aGUgZ28KCQkJLy8gbWV0aG9kLCB0aGVuIHNpbXBseSBpZ25vcmUgaXQuIFRoZSBoaXN0b3J5IGVudHJ5IGhhcyBhbHJlYWR5IGJlZW4gY2FwdHVyZWQKCQkJaWYoIHRoaXMuaWdub3JlUG9wU3RhdGUgKSB7CgkJCQl0aGlzLmlnbm9yZVBvcFN0YXRlID0gZmFsc2U7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoZXJlIGlzIG5vIHN0YXRlLCBhbmQgdGhlIGhpc3Rvcnkgc3RhY2sgbGVuZ3RoIGlzIG9uZSB3ZXJlCgkJCS8vIHByb2JhYmx5IGdldHRpbmcgdGhlIHBhZ2UgbG9hZCBwb3BzdGF0ZSBmaXJlZCBieSBicm93c2VycyBsaWtlIGNocm9tZQoJCQkvLyBhdm9pZCBpdCBhbmQgc2V0IHRoZSBvbmUgdGltZSBmbGFnIHRvIGZhbHNlLgoJCQkvLyBUT0RPOiBEbyB3ZSByZWFsbHkgbmVlZCBhbGwgdGhlc2UgY29uZGl0aW9ucz8gQ29tcGFyaW5nIGxvY2F0aW9uIGhyZWZzCgkJCS8vIHNob3VsZCBiZSBzdWZmaWNpZW50LgoJCQlpZiggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYKCQkJCXRoaXMuaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDEgJiYKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gZmFsc2U7CgoJCQkJaWYgKCBsb2NhdGlvbi5ocmVmID09PSBpbml0aWFsSHJlZiApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gYWNjb3VudCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbiBvZiB0aGUgaGFzaC4gVGhhdCBpcywgd2Ugd2lsbCByZWNlaXZlIGEgcG9wc3RhdGUKCQkJLy8gd2hlbiB0aGUgaGFzaCBpcyBjaGFuZ2VkIGJ5IGFzc2lnbm1lbnQsIGFuZCBpdCB3b24ndCBoYXZlIGEgc3RhdGUgYXNzb2NpYXRlZC4gV2UKCQkJLy8gdGhlbiBuZWVkIHRvIHNxdWFzaCB0aGUgaGFzaC4gU2VlIGJlbG93IGZvciBoYW5kbGluZyBvZiBoYXNoIGFzc2lnbm1lbnQgdGhhdAoJCQkvLyBtYXRjaGVzIGFuIGV4aXN0aW5nIGhpc3RvcnkgZW50cnkKCQkJLy8gVE9ETyBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgc3RhY2sKCQkJLy8gICAgICB3aGVuIHRoZSBoYXNoIGlzIGFkamFjZW50IHRvIHRoZSBhY3RpdmUgaGlzdG9yeSBlbnRyeQoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJaWYoICFldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlICYmIGhhc2ggKSB7CgkJCQkvLyBzcXVhc2ggdGhlIGhhc2ggdGhhdCdzIGJlZW4gYXNzaWduZWQgb24gdGhlIFVSTCB3aXRoIHJlcGxhY2VTdGF0ZQoJCQkJLy8gYWxzbyBncmFiIHRoZSByZXN1bHRpbmcgc3RhdGUgb2JqZWN0IGZvciBzdG9yYWdlCgkJCQlzdGF0ZSA9IHRoaXMuc3F1YXNoKCBoYXNoICk7CgoJCQkJLy8gcmVjb3JkIHRoZSBuZXcgaGFzaCBhcyBhbiBhZGRpdGlvbmFsIGhpc3RvcnkgZW50cnkKCQkJCS8vIHRvIG1hdGNoIHRoZSBicm93c2VyJ3MgdHJlYXRtZW50IG9mIGhhc2ggYXNzaWdubWVudAoJCQkJdGhpcy5oaXN0b3J5LmFkZCggc3RhdGUudXJsLCBzdGF0ZSApOwoKCQkJCS8vIHBhc3MgdGhlIG5ld2x5IGNyZWF0ZWQgc3RhdGUgaW5mb3JtYXRpb24KCQkJCS8vIGFsb25nIHdpdGggdGhlIGV2ZW50CgkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSBzdGF0ZTsKCgkJCQkvLyBkbyBub3QgYWx0ZXIgaGlzdG9yeSwgd2UndmUgYWRkZWQgYSBuZXcgaGlzdG9yeSBlbnRyeQoJCQkJLy8gc28gd2Uga25vdyB3aGVyZSB3ZSBhcmUKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgYWxsIGVsc2UgZmFpbHMgdGhpcyBpcyBhIHBvcHN0YXRlIHRoYXQgY29tZXMgZnJvbSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbnMKCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHksIGFuZCByZWNvcmQgdGhlIGRpcmVjdGlvbmFsaXR5CgkJCXRoaXMuaGlzdG9yeS5kaXJlY3QoewoJCQkJdXJsOiAoZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fSkudXJsIHx8IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIE5PVEUgbXVzdCBiaW5kIGJlZm9yZSBgbmF2aWdhdGVgIHNwZWNpYWwgZXZlbnQgaGFzaGNoYW5nZSBiaW5kaW5nIG90aGVyd2lzZSB0aGUKCQkvLyAgICAgIG5hdmlnYXRpb24gZGF0YSB3b24ndCBiZSBhdHRhY2hlZCB0byB0aGUgaGFzaGNoYW5nZSBldmVudCBpbiB0aW1lIGZvciB0aG9zZQoJCS8vICAgICAgYmluZGluZ3MgdG8gYXR0YWNoIGl0IHRvIHRoZSBgbmF2aWdhdGVgIHNwZWNpYWwgZXZlbnQKCQkvLyBUT0RPIGFkZCBhIGNoZWNrIGhlcmUgdGhhdCBgaGFzaGNoYW5nZS5uYXZpZ2F0ZWAgaXMgYm91bmQgYWxyZWFkeSBvdGhlcndpc2UgaXQncwoJCS8vICAgICAgYnJva2VuIChleGNlcHRpb24/KQoJCWhhc2hjaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGhpc3RvcnksIGhhc2g7CgoJCQkvLyBJZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBleHBsaWNpdGx5IGRpc2FibGVkIG9yIHB1c2hzdGF0ZSBpcyBzdXBwb3J0ZWQKCQkJLy8gYXZvaWQgbWFraW5nIHVzZSBvZiB0aGUgaGFzaGNoYW5nZSBoYW5kbGVyLgoJCQlpZighJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzSGFzaENoYW5nZUVuYWJsZWQoKSB8fAoJCQkJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBPbiBvY2Nhc2lvbiBleHBsaWNpdGx5IHdhbnQgdG8gcHJldmVudCB0aGUgbmV4dCBoYXNoIGZyb20gcHJvcG9nYXRpbmcgYmVjYXVzZSB3ZSBvbmx5CgkJCS8vIHdpdGggdG8gYWx0ZXIgdGhlIHVybCB0byByZXByZXNlbnQgdGhlIG5ldyBzdGF0ZSBkbyBzbyBoZXJlCgkJCWlmKCB0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSApewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQloaXN0b3J5ID0gdGhpcy5oaXN0b3J5OwoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCgkJCS8vIElmIHRoaXMgaXMgYSBoYXNoY2hhbmdlIGNhdXNlZCBieSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbgoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0sCgoJCQkJLy8gV2hlbiB3ZSBkb24ndCBmaW5kIGEgaGFzaCBpbiBvdXIgaGlzdG9yeSBjbGVhcmx5IHdlJ3JlIGFpbWluZyB0byBnbyB0aGVyZQoJCQkJLy8gcmVjb3JkIHRoZSBlbnRyeSBhcyBuZXcgZm9yIGZ1dHVyZSB0cmF2ZXJzYWwKCQkJCS8vCgkJCQkvLyBOT1RFIGl0J3Mgbm90IGVudGlyZWx5IGNsZWFyIHRoYXQgdGhpcyBpcyB0aGUgcmlnaHQgdGhpbmcgdG8gZG8gZ2l2ZW4gdGhhdCB3ZQoJCQkJLy8gICAgICBjYW4ndCBrbm93IHRoZSB1c2VycyBpbnRlbnRpb24uIEl0IG1pZ2h0IGJlIGJldHRlciB0byBleHBsaWNpdGx5IF9ub3RfCgkJCQkvLyAgICAgIHN1cHBvcnQgbG9jYXRpb24uaGFzaCBhc3NpZ25tZW50IGluIHByZWZlcmVuY2UgdG8gJC5uYXZpZ2F0ZSBjYWxscwoJCQkJLy8gVE9ETyBmaXJzdCBhcmcgdG8gYWRkIHNob3VsZCBiZSB0aGUgaHJlZiwgYnV0IGl0IGNhdXNlcyBpc3N1ZXMgaW4gaWRlbnRpZnlpbmcKCQkJCS8vICAgICAgZW1iZWRlZCBwYWdlcwoJCQkJbWlzc2luZzogZnVuY3Rpb24oKSB7CgkJCQkJaGlzdG9yeS5hZGQoIGhhc2gsIHsKCQkJCQkJaGFzaDogaGFzaCwKCQkJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJLy8gVE9ETyBjb25zaWRlciBxdWV1ZWluZyBuYXZpZ2F0aW9uIGFjdGl2aXR5IHVudGlsIHByZXZpb3VzIGFjdGl2aXRpZXMgaGF2ZSBjb21wbGV0ZWQKCS8vICAgICAgc28gdGhhdCBlbmQgdXNlcnMgZG9uJ3QgaGF2ZSB0byB0aGluayBhYm91dCBpdC4gUHVudGluZyBmb3Igbm93CgkvLyBUT0RPICEhIG1vdmUgdGhlIGV2ZW50IGJpbmRpbmdzIGludG8gY2FsbGJhY2tzIG9uIHRoZSBuYXZpZ2F0ZSBldmVudAoJJC5tb2JpbGUubmF2aWdhdGUgPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IuZ28oIHVybCwgZGF0YSwgbm9FdmVudHMgKTsKCX07CgoJLy8gZXhwb3NlIHRoZSBoaXN0b3J5IG9uIHRoZSBuYXZpZ2F0ZSBtZXRob2QgaW4gYW50aWNpcGF0aW9uIG9mIGZ1bGwgaW50ZWdyYXRpb24gd2l0aAoJLy8gZXhpc3RpbmcgbmF2aWdhdGlvbiBmdW5jdGlvbmFsdHkgdGhhdCBpcyB0aWdodGx5IGNvdXBsZWQgdG8gdGhlIGhpc3RvcnkgaW5mb3JtYXRpb24KCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgPSBuZXcgJC5tb2JpbGUuSGlzdG9yeSgpOwoKCS8vIGluc3RhbnRpYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBuYXZpZ2F0b3IgZm9yIHVzZSB3aXRoaW4gdGhlICQubmF2aWdhdGUgbWV0aG9kCgkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IgPSBuZXcgJC5tb2JpbGUuTmF2aWdhdG9yKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ICk7CgoJdmFyIGxvYyA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpOwoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIGxvYy5ocmVmLCB7aGFzaDogbG9jLmhhc2h9ICk7Cn0pKCBqUXVlcnkgKTsKCgovLyBUaGlzIHBsdWdpbiBpcyBhbiBleHBlcmltZW50IGZvciBhYnN0cmFjdGluZyBhd2F5IHRoZSB0b3VjaCBhbmQgbW91c2UKLy8gZXZlbnRzIHNvIHRoYXQgZGV2ZWxvcGVycyBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHdoaWNoIG1ldGhvZCBvZiBpbnB1dAovLyB0aGUgZGV2aWNlIHRoZWlyIGRvY3VtZW50IGlzIGxvYWRlZCBvbiBzdXBwb3J0cy4KLy8KLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBhbGxvdyB0aGUgZGV2ZWxvcGVyIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyBmb3IgdGhlCi8vIGJhc2ljIG1vdXNlIGV2ZW50cywgc3VjaCBhcyBtb3VzZWRvd24sIG1vdXNlbW92ZSwgbW91c2V1cCwgYW5kIGNsaWNrLAovLyBhbmQgdGhlIHBsdWdpbiB3aWxsIHRha2UgY2FyZSBvZiByZWdpc3RlcmluZyB0aGUgY29ycmVjdCBsaXN0ZW5lcnMKLy8gYmVoaW5kIHRoZSBzY2VuZXMgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciBhdCB0aGUgZmFzdGVzdCBwb3NzaWJsZSB0aW1lCi8vIGZvciB0aGF0IGRldmljZSwgd2hpbGUgc3RpbGwgcmV0YWluaW5nIHRoZSBvcmRlciBvZiBldmVudCBmaXJpbmcgaW4KLy8gdGhlIHRyYWRpdGlvbmFsIG1vdXNlIGVudmlyb25tZW50LCBzaG91bGQgbXVsdGlwbGUgaGFuZGxlcnMgYmUgcmVnaXN0ZXJlZAovLyBvbiB0aGUgc2FtZSBlbGVtZW50IGZvciBkaWZmZXJlbnQgZXZlbnRzLgovLwovLyBUaGUgY3VycmVudCB2ZXJzaW9uIGV4cG9zZXMgdGhlIGZvbGxvd2luZyB2aXJ0dWFsIGV2ZW50cyB0byBqUXVlcnkgYmluZCBtZXRob2RzOgovLyAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiCgooZnVuY3Rpb24oICQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCnZhciBkYXRhUHJvcGVydHlOYW1lID0gInZpcnR1YWxNb3VzZUJpbmRpbmdzIiwKCXRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lID0gInZpcnR1YWxUb3VjaElEIiwKCXZpcnR1YWxFdmVudE5hbWVzID0gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIi5zcGxpdCggIiAiICksCgl0b3VjaEV2ZW50UHJvcHMgPSAiY2xpZW50WCBjbGllbnRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSIuc3BsaXQoICIgIiApLAoJbW91c2VIb29rUHJvcHMgPSAkLmV2ZW50Lm1vdXNlSG9va3MgPyAkLmV2ZW50Lm1vdXNlSG9va3MucHJvcHMgOiBbXSwKCW1vdXNlRXZlbnRQcm9wcyA9ICQuZXZlbnQucHJvcHMuY29uY2F0KCBtb3VzZUhvb2tQcm9wcyApLAoJYWN0aXZlRG9jSGFuZGxlcnMgPSB7fSwKCXJlc2V0VGltZXJJRCA9IDAsCglzdGFydFggPSAwLAoJc3RhcnRZID0gMCwKCWRpZFNjcm9sbCA9IGZhbHNlLAoJY2xpY2tCbG9ja0xpc3QgPSBbXSwKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlLAoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2UsCglldmVudENhcHR1cmVTdXBwb3J0ZWQgPSAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZG9jdW1lbnQsCgkkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJbmV4dFRvdWNoSUQgPSAxLAoJbGFzdFRvdWNoSUQgPSAwLCB0aHJlc2hvbGQ7CgokLnZtb3VzZSA9IHsKCW1vdmVEaXN0YW5jZVRocmVzaG9sZDogMTAsCgljbGlja0Rpc3RhbmNlVGhyZXNob2xkOiAxMCwKCXJlc2V0VGltZXJEdXJhdGlvbjogMTUwMAp9OwoKZnVuY3Rpb24gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkgewoKCXdoaWxlICggZXZlbnQgJiYgdHlwZW9mIGV2ZW50Lm9yaWdpbmFsRXZlbnQgIT09ICJ1bmRlZmluZWQiICkgewoJCWV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCX0KCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICkgewoKCXZhciB0ID0gZXZlbnQudHlwZSwKCQlvZSwgcHJvcHMsIG5lLCBwcm9wLCBjdCwgdG91Y2gsIGksIGosIGxlbjsKCglldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CglldmVudC50eXBlID0gZXZlbnRUeXBlOwoKCW9lID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCXByb3BzID0gJC5ldmVudC5wcm9wczsKCgkvLyBhZGRyZXNzZXMgc2VwYXJhdGlvbiBvZiAkLmV2ZW50LnByb3BzIGluIHRvICQuZXZlbnQubW91c2VIb29rLnByb3BzIGFuZCBJc3N1ZSAzMjgwCgkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzMyODAKCWlmICggdC5zZWFyY2goIC9eKG1vdXNlfGNsaWNrKS8gKSA+IC0xICkgewoJCXByb3BzID0gbW91c2VFdmVudFByb3BzOwoJfQoKCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJaWYgKCBvZSApIHsKCQlmb3IgKCBpID0gcHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJcHJvcCA9IHByb3BzWyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9lWyBwcm9wIF07CgkJfQoJfQoKCS8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBtb3VzZSBhbmQgY2xpY2sgdmlydHVhbCBldmVudHMgYXJlIGdlbmVyYXRlZAoJLy8gd2l0aG91dCBhIC53aGljaCBvbmUgaXMgZGVmaW5lZAoJaWYgKCB0LnNlYXJjaCgvbW91c2UoZG93bnx1cCl8Y2xpY2svKSA+IC0xICYmICFldmVudC53aGljaCApIHsKCQlldmVudC53aGljaCA9IDE7Cgl9CgoJaWYgKCB0LnNlYXJjaCgvXnRvdWNoLykgIT09IC0xICkgewoJCW5lID0gZ2V0TmF0aXZlRXZlbnQoIG9lICk7CgkJdCA9IG5lLnRvdWNoZXM7CgkJY3QgPSBuZS5jaGFuZ2VkVG91Y2hlczsKCQl0b3VjaCA9ICggdCAmJiB0Lmxlbmd0aCApID8gdFswXSA6ICggKCBjdCAmJiBjdC5sZW5ndGggKSA/IGN0WyAwIF0gOiB1bmRlZmluZWQgKTsKCgkJaWYgKCB0b3VjaCApIHsKCQkJZm9yICggaiA9IDAsIGxlbiA9IHRvdWNoRXZlbnRQcm9wcy5sZW5ndGg7IGogPCBsZW47IGorKykgewoJCQkJcHJvcCA9IHRvdWNoRXZlbnRQcm9wc1sgaiBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IHRvdWNoWyBwcm9wIF07CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBlbGVtZW50ICkgewoKCXZhciBmbGFncyA9IHt9LAoJCWIsIGs7CgoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWZvciAoICBrIGluIGIgKSB7CgkJCWlmICggYlsgayBdICkgewoJCQkJZmxhZ3NbIGsgXSA9IGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nID0gdHJ1ZTsKCQkJfQoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIGZsYWdzOwp9CgpmdW5jdGlvbiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZWxlbWVudCwgZXZlbnRUeXBlICkgewoJdmFyIGI7Cgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJaWYgKCBiICYmICggIWV2ZW50VHlwZSB8fCBiWyBldmVudFR5cGUgXSApICkgewoJCQlyZXR1cm4gZWxlbWVudDsKCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBudWxsOwp9CgpmdW5jdGlvbiBlbmFibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGRpc2FibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gdHJ1ZTsKfQoKZnVuY3Rpb24gZW5hYmxlTW91c2VCaW5kaW5ncygpIHsKCWxhc3RUb3VjaElEID0gMDsKCWNsaWNrQmxvY2tMaXN0Lmxlbmd0aCA9IDA7CglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZTsKCgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBlbmFibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBkaXNhYmxlZC4KCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIGRpc2FibGVNb3VzZUJpbmRpbmdzKCkgewoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZGlzYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGVuYWJsZWQuCgllbmFibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIHN0YXJ0UmVzZXRUaW1lcigpIHsKCWNsZWFyUmVzZXRUaW1lcigpOwoJcmVzZXRUaW1lcklEID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJcmVzZXRUaW1lcklEID0gMDsKCQllbmFibGVNb3VzZUJpbmRpbmdzKCk7Cgl9LCAkLnZtb3VzZS5yZXNldFRpbWVyRHVyYXRpb24gKTsKfQoKZnVuY3Rpb24gY2xlYXJSZXNldFRpbWVyKCkgewoJaWYgKCByZXNldFRpbWVySUQgKSB7CgkJY2xlYXJUaW1lb3V0KCByZXNldFRpbWVySUQgKTsKCQlyZXNldFRpbWVySUQgPSAwOwoJfQp9CgpmdW5jdGlvbiB0cmlnZ2VyVmlydHVhbEV2ZW50KCBldmVudFR5cGUsIGV2ZW50LCBmbGFncyApIHsKCXZhciB2ZTsKCglpZiAoICggZmxhZ3MgJiYgZmxhZ3NbIGV2ZW50VHlwZSBdICkgfHwKCQkJCSggIWZsYWdzICYmIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBldmVudC50YXJnZXQsIGV2ZW50VHlwZSApICkgKSB7CgoJCXZlID0gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICk7CgoJCSQoIGV2ZW50LnRhcmdldCkudHJpZ2dlciggdmUgKTsKCX0KCglyZXR1cm4gdmU7Cn0KCmZ1bmN0aW9uIG1vdXNlRXZlbnRDYWxsYmFjayggZXZlbnQgKSB7Cgl2YXIgdG91Y2hJRCA9ICQuZGF0YSggZXZlbnQudGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApOwoKCWlmICggIWJsb2NrTW91c2VUcmlnZ2VycyAmJiAoICFsYXN0VG91Y2hJRCB8fCBsYXN0VG91Y2hJRCAhPT0gdG91Y2hJRCApICkgewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2IiArIGV2ZW50LnR5cGUsIGV2ZW50ICk7CgkJaWYgKCB2ZSApIHsKCQkJaWYgKCB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKCB2ZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQkJaWYgKCB2ZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoIGV2ZW50ICkgewoKCXZhciB0b3VjaGVzID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlcywKCQl0YXJnZXQsIGZsYWdzOwoKCWlmICggdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA9PT0gMSApIHsKCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggdGFyZ2V0ICk7CgoJCWlmICggZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgKSB7CgoJCQlsYXN0VG91Y2hJRCA9IG5leHRUb3VjaElEKys7CgkJCSQuZGF0YSggdGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSwgbGFzdFRvdWNoSUQgKTsKCgkJCWNsZWFyUmVzZXRUaW1lcigpOwoKCQkJZGlzYWJsZU1vdXNlQmluZGluZ3MoKTsKCQkJZGlkU2Nyb2xsID0gZmFsc2U7CgoJCQl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKCB0LnBhZ2VYIC0gc3RhcnRYICkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyggdC5wYWdlWSAtIHN0YXJ0WSApID4gbW92ZVRocmVzaG9sZCApOwoKCglpZiAoIGRpZFNjcm9sbCAmJiAhZGlkQ2FuY2VsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZmxhZ3MgKTsKCX0KCgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlbW92ZSIsIGV2ZW50LCBmbGFncyApOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwoKCXZhciBmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApLAoJCXQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInZjbGljayIsIGV2ZW50LCBmbGFncyApOwoJCWlmICggdmUgJiYgdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCS8vIFRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyB0aGUgdG91Y2hlbmQKCQkJLy8gZXZlbnQgZG9uJ3QgbmVjZXNzYXJpbHkgbWF0Y2ggdGhlIHRhcmdldCB1c2VkIGR1cmluZyB0aGUKCQkJLy8gdG91Y2guIFRoaXMgbWVhbnMgd2UgbmVlZCB0byByZWx5IG9uIGNvb3JkaW5hdGVzIGZvciBibG9ja2luZwoJCQkvLyBhbnkgY2xpY2sgdGhhdCBpcyBnZW5lcmF0ZWQuCgkJCXQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS5jaGFuZ2VkVG91Y2hlc1sgMCBdOwoJCQljbGlja0Jsb2NrTGlzdC5wdXNoKHsKCQkJCXRvdWNoSUQ6IGxhc3RUb3VjaElELAoJCQkJeDogdC5jbGllbnRYLAoJCQkJeTogdC5jbGllbnRZCgkJCX0pOwoKCQkJLy8gUHJldmVudCBhbnkgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IGZyb20gdHJpZ2dlcmluZwoJCQkvLyB2aXJ0dWFsIGV2ZW50IG5vdGlmaWNhdGlvbnMuCgkJCWJsb2NrTW91c2VUcmlnZ2VycyA9IHRydWU7CgkJfQoJfQoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW91dCIsIGV2ZW50LCBmbGFncyk7CglkaWRTY3JvbGwgPSBmYWxzZTsKCglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFzVmlydHVhbEJpbmRpbmdzKCBlbGUgKSB7Cgl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIGVsZSwgZGF0YVByb3BlcnR5TmFtZSApLAoJCWs7CgoJaWYgKCBiaW5kaW5ncyApIHsKCQlmb3IgKCBrIGluIGJpbmRpbmdzICkgewoJCQlpZiAoIGJpbmRpbmdzWyBrIF0gKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCX0KCXJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gZHVtbXlNb3VzZUhhbmRsZXIoKSB7fQoKZnVuY3Rpb24gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCBldmVudFR5cGUgKSB7Cgl2YXIgcmVhbFR5cGUgPSBldmVudFR5cGUuc3Vic3RyKCAxICk7CgoJcmV0dXJuIHsKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBiaW5kaW5nIGZvciB0aGlzIGV2ZW50VHlwZSwKCQkJLy8gcmVtb3ZlIGl0cyBnbG9iYWwgaGFuZGxlciBmcm9tIHRoZSBkb2N1bWVudC4KCgkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdOwoKCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdICkgewoJCQkJJGRvY3VtZW50LnVuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGluIGV4aXN0ZW5jZSwKCQkJCS8vIHJlbW92ZSBvdXIgZG9jdW1lbnQgdG91Y2hzdGFydCBsaXN0ZW5lci4KCgkJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXTsKCgkJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gKSB7CgkJCQkJJGRvY3VtZW50LnVuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLnVuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS51bmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCQkJCQkJLnVuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQliaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoKCQkJLy8gdGVhcmRvd24gbWF5IGJlIGNhbGxlZCB3aGVuIGFuIGVsZW1lbnQgd2FzCgkJCS8vIHJlbW92ZWQgZnJvbSB0aGUgRE9NLiBJZiB0aGlzIGlzIHRoZSBjYXNlLAoJCQkvLyBqUXVlcnkgY29yZSBtYXkgaGF2ZSBhbHJlYWR5IHN0cmlwcGVkIHRoZSBlbGVtZW50CgkJCS8vIG9mIGFueSBkYXRhIGJpbmRpbmdzIHNvIHdlIG5lZWQgdG8gY2hlY2sgaXQgYmVmb3JlCgkJCS8vIHVzaW5nIGl0LgoJCQlpZiAoIGJpbmRpbmdzICkgewoJCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gZmFsc2U7CgkJCX0KCgkJCS8vIFVucmVnaXN0ZXIgdGhlIGR1bW15IGV2ZW50IGhhbmRsZXIuCgoJCQkkdGhpcy51bmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgb24gdGhlCgkJCS8vIGVsZW1lbnQsIHJlbW92ZSB0aGUgYmluZGluZyBkYXRhIGZyb20gdGhlIGVsZW1lbnQuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSR0aGlzLnJlbW92ZURhdGEoIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJfQoJCX0KCX07Cn0KCi8vIEV4cG9zZSBvdXIgY3VzdG9tIGV2ZW50cyB0byB0aGUgalF1ZXJ5IGJpbmQvdW5iaW5kIG1lY2hhbmlzbS4KCmZvciAoIHZhciBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGVoc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApOwoKCS8vIGFkZCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCgl2YXIgc3VwcG9ydFRvdWNoID0gJC5tb2JpbGUuc3VwcG9ydC50b3VjaCwKCQlzY3JvbGxFdmVudCA9ICJ0b3VjaG1vdmUgc2Nyb2xsIiwKCQl0b3VjaFN0YXJ0RXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hzdGFydCIgOiAibW91c2Vkb3duIiwKCQl0b3VjaFN0b3BFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaGVuZCIgOiAibW91c2V1cCIsCgkJdG91Y2hNb3ZlRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2htb3ZlIiA6ICJtb3VzZW1vdmUiOwoKCWZ1bmN0aW9uIHRyaWdnZXJDdXN0b21FdmVudCggb2JqLCBldmVudFR5cGUsIGV2ZW50ICkgewoJCXZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlOwoJCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgkJJC5ldmVudC5kaXNwYXRjaC5jYWxsKCBvYmosIGV2ZW50ICk7CgkJZXZlbnQudHlwZSA9IG9yaWdpbmFsVHlwZTsKCX0KCgkvLyBhbHNvIGhhbmRsZXMgc2Nyb2xsc3RvcAoJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0ID0gewoKCQllbmFibGVkOiB0cnVlLAoKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCWlmICggZXZlbnQud2hpY2ggJiYgZXZlbnQud2hpY2ggIT09IDEgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCXZhciBvcmlnVGFyZ2V0ID0gZXZlbnQudGFyZ2V0LAoJCQkJCW9yaWdFdmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQsCgkJCQkJdGltZXI7CgoJCQkJZnVuY3Rpb24gY2xlYXJUYXBUaW1lcigpIHsKCQkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xlYXJUYXBIYW5kbGVycygpIHsKCQkJCQljbGVhclRhcFRpbWVyKCk7CgoJCQkJCSR0aGlzLnVuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApCgkJCQkJCS51bmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKTsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsaWNrSGFuZGxlciggZXZlbnQgKSB7CgkJCQkJY2xlYXJUYXBIYW5kbGVycygpOwoKCQkJCQkvLyBPTkxZIHRyaWdnZXIgYSAndGFwJyBldmVudCBpZiB0aGUgc3RhcnQgdGFyZ2V0IGlzCgkJCQkJLy8gdGhlIHNhbWUgYXMgdGhlIHN0b3AgdGFyZ2V0LgoJCQkJCWlmICggb3JpZ1RhcmdldCA9PT0gZXZlbnQudGFyZ2V0ICkgewoJCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXAiLCBldmVudCApOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJGRvY3VtZW50LmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXBob2xkIiwgJC5FdmVudCggInRhcGhvbGQiLCB7IHRhcmdldDogb3JpZ1RhcmdldCB9ICkgKTsKCQkJCX0sICQuZXZlbnQuc3BlY2lhbC50YXAudGFwaG9sZFRocmVzaG9sZCApOwoJCQl9KTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyBzd2lwZWxlZnQsIHN3aXBlcmlnaHQKCSQuZXZlbnQuc3BlY2lhbC5zd2lwZSA9IHsKCQlzY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkOiAzMCwgLy8gTW9yZSB0aGFuIHRoaXMgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQsIGFuZCB3ZSB3aWxsIHN1cHByZXNzIHNjcm9sbGluZy4KCgkJZHVyYXRpb25UaHJlc2hvbGQ6IDEwMDAsIC8vIE1vcmUgdGltZSB0aGFuIHRoaXMsIGFuZCBpdCBpc24ndCBhIHN3aXBlLgoKCQlob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQ6IDMwLCAgLy8gU3dpcGUgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBtb3JlIHRoYW4gdGhpcy4KCgkJdmVydGljYWxEaXN0YW5jZVRocmVzaG9sZDogNzUsICAvLyBTd2lwZSB2ZXJ0aWNhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBsZXNzIHRoYW4gdGhpcy4KCgkJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXSwKCQkJCQkJb3JpZ2luOiAkKCBldmVudC50YXJnZXQgKQoJCQkJCX07CgkJfSwKCgkJc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudDsKCQkJcmV0dXJuIHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdCgkJCQkJfTsKCQl9LAoKCQloYW5kbGVTd2lwZTogZnVuY3Rpb24oIHN0YXJ0LCBzdG9wICkgewoJCQlpZiAoIHN0b3AudGltZSAtIHN0YXJ0LnRpbWUgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZHVyYXRpb25UaHJlc2hvbGQgJiYKCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQgJiYKCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDEgXSAtIHN0b3AuY29vcmRzWyAxIF0gKSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS52ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkICkgewoKCQkJCXN0YXJ0Lm9yaWdpbi50cmlnZ2VyKCAic3dpcGUiICkKCQkJCQkudHJpZ2dlciggc3RhcnQuY29vcmRzWzBdID4gc3RvcC5jb29yZHNbIDAgXSA/ICJzd2lwZWxlZnQiIDogInN3aXBlcmlnaHQiICk7CgkJCX0KCQl9LAoKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApOwoKCQkJJHRoaXMuYmluZCggdG91Y2hTdGFydEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl2YXIgc3RhcnQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RhcnQoIGV2ZW50ICksCgkJCQkJc3RvcDsKCgkJCQlmdW5jdGlvbiBtb3ZlSGFuZGxlciggZXZlbnQgKSB7CgkJCQkJaWYgKCAhc3RhcnQgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCXN0b3AgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RvcCggZXZlbnQgKTsKCgkJCQkJLy8gcHJldmVudCBzY3JvbGxpbmcKCQkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJCS5vbmUoIHRvdWNoU3RvcEV2ZW50LCBmdW5jdGlvbigpIHsKCQkJCQkJJHRoaXMudW5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKTsKCgkJCQkJCWlmICggc3RhcnQgJiYgc3RvcCApIHsKCQkJCQkJCSQuZXZlbnQuc3BlY2lhbC5zd2lwZS5oYW5kbGVTd2lwZSggc3RhcnQsIHN0b3AgKTsKCQkJCQkJfQoJCQkJCQlzdGFydCA9IHN0b3AgPSB1bmRlZmluZWQ7CgkJCQkJfSk7CgkJCX0pOwoJCX0KCX07CgkkLmVhY2goewoJCXNjcm9sbHN0b3A6ICJzY3JvbGxzdGFydCIsCgkJdGFwaG9sZDogInRhcCIsCgkJc3dpcGVsZWZ0OiAic3dpcGUiLAoJCXN3aXBlcmlnaHQ6ICJzd2lwZSIKCX0sIGZ1bmN0aW9uKCBldmVudCwgc291cmNlRXZlbnQgKSB7CgoJCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoIHNvdXJjZUV2ZW50LCAkLm5vb3AgKTsKCQkJfQoJCX07Cgl9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgoJLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAoJKGZ1bmN0aW9uKCAkICkgewoJCSQuZXZlbnQuc3BlY2lhbC50aHJvdHRsZWRyZXNpemUgPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9CgkJfTsKCgkJdmFyIHRocm90dGxlID0gMjUwLAoJCQloYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQkJZGlmZiA9IGN1cnIgLSBsYXN0Q2FsbDsKCgkJCQlpZiAoIGRpZmYgPj0gdGhyb3R0bGUgKSB7CgoJCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCQkkKCB0aGlzICkudHJpZ2dlciggInRocm90dGxlZHJlc2l6ZSIgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhlbGRDYWxsICk7CgkJCQkJfQoKCQkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJCWhlbGRDYWxsID0gc2V0VGltZW91dCggaGFuZGxlciwgdGhyb3R0bGUgLSBkaWZmICk7CgkJCQl9CgkJCX0sCgkJCWxhc3RDYWxsID0gMCwKCQkJaGVsZENhbGwsCgkJCWN1cnIsCgkJCWRpZmY7Cgl9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCXZhciB3aW4gPSAkKCB3aW5kb3cgKSwKCQlldmVudF9uYW1lID0gIm9yaWVudGF0aW9uY2hhbmdlIiwKCQlzcGVjaWFsX2V2ZW50LAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfTsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGF0dGVtcHRzIHRvIHVzZSB0aGUgd2luZG93CgkvLyBkaW1lbnNpb25zIHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4gbWFrZXMgYWRqdXN0bWVudHMKCS8vIHRvIHRoZSB0byB0aGUgcG9ydHJhaXRfbWFwIGlmIG5lY2Vzc2FyeSwgc28gdGhhdCB3ZSBjYW4gcHJvcGVybHkgZGVjb2RlIHRoZQoJLy8gd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlIHdoZW5ldmVyIGdldF9vcmllbnRhdGlvbigpIGlzIGNhbGxlZC4KCS8vCgkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2UgYSBtZWRpYSBxdWVyeSB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIG9yaWVudGF0aW9uIHRoZSBicm93c2VyCgkvLyB0aGlua3MgaXQgaXMgaW46CgkvLwoJLy8gICAgIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgkvLwoJLy8gYnV0IHRoZXJlIHdhcyBhbiBpUGhvbmUvaVBvZCBUb3VjaCBidWcgYmVnaW5uaW5nIHdpdGggaU9TIDQuMiwgdXAgdGhyb3VnaCBpT1MgNS4xLAoJLy8gd2hlcmUgdGhlIGJyb3dzZXIgKkFMV0FZUyogYXBwbGllZCB0aGUgbGFuZHNjYXBlIG1lZGlhIHF1ZXJ5LiBUaGlzIGJ1ZyBkb2VzIG5vdAoJLy8gaGFwcGVuIG9uIGlQYWQuCgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIENoZWNrIHRoZSB3aW5kb3cgd2lkdGggYW5kIGhlaWdodCB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24KCQkvLyBvZiB0aGUgZGV2aWNlIGlzIGF0IHRoaXMgbW9tZW50LiBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcAoJCS8vIHZhbHVlcyB0byAwIGFuZCAxODAsICpBTkQqIHdlIHB1cnBvc2VseSBjaGVjayBmb3IgbGFuZHNjYXBlIHNvIHRoYXQgaWYgd2UgZ3Vlc3MKCQkvLyB3cm9uZywgLCB3ZSBkZWZhdWx0IHRvIHRoZSBhc3N1bXB0aW9uIHRoYXQgcG9ydHJhaXQgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24uCgkJLy8gV2UgdXNlIGEgdGhyZXNob2xkIGNoZWNrIGJlbG93IGJlY2F1c2Ugb24gc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MsIHRoZSBpUGhvbmUKCQkvLyBmb3JtLWZhY3RvciBjYW4gcmVwb3J0IGEgbGFyZ2VyIHdpZHRoIHRoYW4gaGVpZ2h0IGlmIHRoZSB1c2VyIHR1cm5zIG9uIHRoZQoJCS8vIGRldmVsb3BlciBjb25zb2xlLiBUaGUgYWN0dWFsIHRocmVzaG9sZCB2YWx1ZSBpcyBzb21ld2hhdCBhcmJpdHJhcnksIHdlIGp1c3QKCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSBpdCBpcyBsYXJnZSBlbm91Z2ggdG8gZXhjbHVkZSB0aGUgZGV2ZWxvcGVyIGNvbnNvbGUgY2FzZS4KCgkJdmFyIHd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgd2luLndpZHRoKCksCgkJCXdoID0gd2luZG93LmlubmVySGVpZ2h0IHx8IHdpbi5oZWlnaHQoKSwKCQkJbGFuZHNjYXBlX3RocmVzaG9sZCA9IDUwOwoKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9IHd3ID4gd2ggJiYgKCB3dyAtIHdoICkgPiBsYW5kc2NhcGVfdGhyZXNob2xkOwoKCgkJLy8gTm93IGNoZWNrIHRvIHNlZSBpZiB0aGUgY3VycmVudCB3aW5kb3cub3JpZW50YXRpb24gaXMgMCBvciAxODAuCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCgkJLy8gSWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgbGFuZHNjYXBlLCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgMCBvciAxODAsICpPUioKCQkvLyBpZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBwb3J0cmFpdCwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDkwIG9yIC05MCwgd2UKCQkvLyBuZWVkIHRvIGZsaXAgb3VyIHBvcnRyYWl0X21hcCB2YWx1ZXMgYmVjYXVzZSBsYW5kc2NhcGUgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gZm9yCgkJLy8gdGhpcyBkZXZpY2UvYnJvd3Nlci4KCQlpZiAoICggaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgfHwgKCAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgIWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApICkgewoJCQlwb3J0cmFpdF9tYXAgPSB7ICItOTAiOiB0cnVlLCAiOTAiOiB0cnVlIH07CgkJfQoJfQoKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSA9ICQuZXh0ZW5kKCB7fSwgJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLCB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdCBqUXVlcnkKCQkJLy8gd2lsbCBiaW5kIHRvIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdAoJCQkvLyBqUXVlcnkgd2lsbCB1bmJpbmQgdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCB1bmJpbmQgdGhlCgkJCS8vIHJlc2l6ZSBldmVudCBoYW5kbGVyLgoJCQl3aW4udW5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJYWRkOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBib3VuZCBldmVudCBoYW5kbGVyLgoJCQl2YXIgb2xkX2hhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlcjsKCgoJCQloYW5kbGVPYmouaGFuZGxlciA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIE1vZGlmeSBldmVudCBvYmplY3QsIGFkZGluZyB0aGUgLm9yaWVudGF0aW9uIHByb3BlcnR5LgoJCQkJZXZlbnQub3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCQkvLyBDYWxsIHRoZSBvcmlnaW5hbGx5LWJvdW5kIGV2ZW50IGhhbmRsZXIgYW5kIHJldHVybiBpdHMgcmVzdWx0LgoJCQkJcmV0dXJuIG9sZF9oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfTsKCQl9Cgl9KTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCBldmVudF9uYW1lICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgkJfSBlbHNlIHsKCQkJaXNQb3J0cmFpdCA9IGVsZW0gJiYgZWxlbS5jbGllbnRXaWR0aCAvIGVsZW0uY2xpZW50SGVpZ2h0IDwgMS4xOwoJCX0KCgkJcmV0dXJuIGlzUG9ydHJhaXQgPyAicG9ydHJhaXQiIDogImxhbmRzY2FwZSI7Cgl9OwoKCSQuZm5bIGV2ZW50X25hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIGV2ZW50X25hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIGV2ZW50X25hbWUgKTsKCX07CgoJLy8galF1ZXJ5IDwgMS44CglpZiAoICQuYXR0ckZuICkgewoJCSQuYXR0ckZuWyBldmVudF9uYW1lIF0gPSB0cnVlOwoJfQoKfSggalF1ZXJ5LCB0aGlzICkpOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImMiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCQlrZWVwTmF0aXZlRGVmYXVsdDogIjpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkvLyBpZiBmYWxzZSBpcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2tzIGRvIG5vdCBjcmVhdGUgdGhlIHBhZ2UKCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQl0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktYm9keS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQsIHsKCQkJcGFnZWJlZm9yZWhpZGU6ICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiwKCQkJcGFnZWJlZm9yZXNob3c6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciCgkJfSk7Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oIGUgKSB7CgkJdGhpcy5zZXRDb250YWluZXJCYWNrZ3JvdW5kKCk7Cgl9LAoKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LnBhcmVudCgpICkgKTsKCX0sCgoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAoIHRoZW1lIHx8IHRoaXMub3B0aW9ucy50aGVtZSApICk7CgkJfQoJfSwKCglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlRGVmaW5lZCA9IG9wdGlvbnMua2VlcE5hdGl2ZSAmJiAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZSApOwoKCQlpZiAoIGtlZXBOYXRpdmVEZWZpbmVkICYmIG9wdGlvbnMua2VlcE5hdGl2ZSAhPT0gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdCApIHsKCQkJcmV0dXJuIFtvcHRpb25zLmtlZXBOYXRpdmUsIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHRdLmpvaW4oICIsICIgKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0OwoJfQp9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCnZhciBjcmVhdGVIYW5kbGVyID0gZnVuY3Rpb24oIHNlcXVlbnRpYWwgKSB7CgoJLy8gRGVmYXVsdCB0byBzZXF1ZW50aWFsCglpZiAoIHNlcXVlbnRpYWwgPT09IHVuZGVmaW5lZCApIHsKCQlzZXF1ZW50aWFsID0gdHJ1ZTsKCX0KCglyZXR1cm4gZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgoJCXZhciBkZWZlcnJlZCA9IG5ldyAkLkRlZmVycmVkKCksCgkJCXJldmVyc2VDbGFzcyA9IHJldmVyc2UgPyAiIHJldmVyc2UiIDogIiIsCgkJCWFjdGl2ZQk9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCXRvU2Nyb2xsID0gYWN0aXZlLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwsCgkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQltYXhUcmFuc2l0aW9uT3ZlcnJpZGUgPSAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGggIT09IGZhbHNlICYmICQubW9iaWxlLndpbmRvdy53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoLAoJCQlub25lID0gISQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyB8fCBtYXhUcmFuc2l0aW9uT3ZlcnJpZGUgfHwgIW5hbWUgfHwgbmFtZSA9PT0gIm5vbmUiIHx8IE1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRvU2Nyb2xsICkgPiAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uKCksCgkJCXRvUHJlQ2xhc3MgPSAiIHVpLXBhZ2UtcHJlLWluIiwKCQkJdG9nZ2xlVmlld3BvcnRDbGFzcyA9IGZ1bmN0aW9uKCkgewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyBuYW1lICk7CgkJCX0sCgkJCXNjcm9sbFBhZ2UgPSBmdW5jdGlvbigpIHsKCQkJCS8vIEJ5IHVzaW5nIHNjcm9sbFRvIGluc3RlYWQgb2Ygc2lsZW50U2Nyb2xsLCB3ZSBjYW4ga2VlcCB0aGluZ3MgYmV0dGVyIGluIG9yZGVyCgkJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdG9TY3JvbGwgKTsKCgkJCQkvLyByZWVuYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJCX0sIDE1MCApOwoJCQl9LAoJCQljbGVhbkZyb20gPSBmdW5jdGlvbigpIHsKCQkJCSRmcm9tCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyAiIG91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoJCQl9LAoJCQlzdGFydE91dCA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gaWYgaXQncyBub3Qgc2VxdWVudGlhbCwgY2FsbCB0aGUgZG9uZU91dCB0cmFuc2l0aW9uIHRvIHN0YXJ0IHRoZSBUTyBwYWdlIGFuaW1hdGluZyBpbiBzaW11bHRhbmVvdXNseQoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCQkJCQlkb25lT3V0KCk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQkkZnJvbS5hbmltYXRpb25Db21wbGV0ZSggZG9uZU91dCApOwoJCQkJfQoKCQkJCS8vIFNldCB0aGUgZnJvbSBwYWdlJ3MgaGVpZ2h0IGFuZCBzdGFydCBpdCB0cmFuc2l0aW9uaW5nIG91dAoJCQkJLy8gTm90ZTogc2V0dGluZyBhbiBleHBsaWNpdCBoZWlnaHQgaGVscHMgZWxpbWluYXRlIHRpbGluZyBpbiB0aGUgdHJhbnNpdGlvbnMKCQkJCSRmcm9tCgkJCQkJLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpICkKCQkJCQkuYWRkQ2xhc3MoIG5hbWUgKyAiIG91dCIgKyByZXZlcnNlQ2xhc3MgKTsKCQkJfSwKCgkJCWRvbmVPdXQgPSBmdW5jdGlvbigpIHsKCgkJCQlpZiAoICRmcm9tICYmIHNlcXVlbnRpYWwgKSB7CgkJCQkJY2xlYW5Gcm9tKCk7CgkJCQl9CgoJCQkJc3RhcnRJbigpOwoJCQl9LAoKCQkJc3RhcnRJbiA9IGZ1bmN0aW9uKCkgewoKCQkJCS8vIFByZXZlbnQgZmxpY2tlcmluZyBpbiBwaG9uZWdhcCBjb250YWluZXI6IHNlZSBjb21tZW50cyBhdCAjNDAyNCByZWdhcmRpbmcgaU9TCgkJCQkkdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoKCQkJCSR0by5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgdG9QcmVDbGFzcyApOwoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggJHRvICk7CgoJCQkJLy8gU2V0IHRvIHBhZ2UgaGVpZ2h0CgkJCQkkdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0b1Njcm9sbCApOwoKCQkJCXNjcm9sbFBhZ2UoKTsKCgkJCQkvLyBSZXN0b3JlcyB2aXNpYmlsaXR5IG9mIHRoZSBuZXcgcGFnZTogYWRkZWQgdG9nZXRoZXIgd2l0aCAkdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoJCQkJJHRvLmNzcyggInotaW5kZXgiLCAiIiApOwoKCQkJCWlmICggIW5vbmUgKSB7CgkJCQkJJHRvLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lSW4gKTsKCQkJCX0KCgkJCQkkdG8KCQkJCQkucmVtb3ZlQ2xhc3MoIHRvUHJlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgaW4iICsgcmV2ZXJzZUNsYXNzICk7CgoJCQkJaWYgKCBub25lICkgewoJCQkJCWRvbmVJbigpOwoJCQkJfQoKCQkJfSwKCgkJCWRvbmVJbiA9IGZ1bmN0aW9uKCkgewoKCQkJCWlmICggIXNlcXVlbnRpYWwgKSB7CgoJCQkJCWlmICggJGZyb20gKSB7CgkJCQkJCWNsZWFuRnJvbSgpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdG8KCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgaW4gcmV2ZXJzZSAiICsgbmFtZSApCgkJCQkJLmhlaWdodCggIiIgKTsKCgkJCQl0b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQkJLy8gSW4gc29tZSBicm93c2VycyAoaU9TNSksIDNEIHRyYW5zaXRpb25zIGJsb2NrIHRoZSBhYmlsaXR5IHRvIHNjcm9sbCB0byB0aGUgZGVzaXJlZCBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdGlvbgoJCQkJLy8gVGhpcyBlbnN1cmVzIHdlIGp1bXAgdG8gdGhhdCBzcG90IGFmdGVyIHRoZSBmYWN0LCBpZiB3ZSBhcmVuJ3QgdGhlcmUgYWxyZWFkeS4KCQkJCWlmICggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpICE9PSB0b1Njcm9sbCApIHsKCQkJCQlzY3JvbGxQYWdlKCk7CgkJCQl9CgoJCQkJZGVmZXJyZWQucmVzb2x2ZSggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgdHJ1ZSApOwoJCQl9OwoKCQl0b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCWlmICggJGZyb20gJiYgIW5vbmUgKSB7CgkJCXN0YXJ0T3V0KCk7CgkJfQoJCWVsc2UgewoJCQlkb25lT3V0KCk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKfTsKCi8vIGdlbmVyYXRlIHRoZSBoYW5kbGVycyBmcm9tIHRoZSBhYm92ZQp2YXIgc2VxdWVudGlhbEhhbmRsZXIgPSBjcmVhdGVIYW5kbGVyKCksCglzaW11bHRhbmVvdXNIYW5kbGVyID0gY3JlYXRlSGFuZGxlciggZmFsc2UgKSwKCWRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpICogMzsKCX07CgovLyBNYWtlIG91ciB0cmFuc2l0aW9uIGhhbmRsZXIgdGhlIHB1YmxpYyBkZWZhdWx0LgokLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSBzZXF1ZW50aWFsSGFuZGxlcjsKCi8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMgPSB7CgkiZGVmYXVsdCI6ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCSJzZXF1ZW50aWFsIjogc2VxdWVudGlhbEhhbmRsZXIsCgkic2ltdWx0YW5lb3VzIjogc2ltdWx0YW5lb3VzSGFuZGxlcgp9OwoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcyA9IHt9OwoKLy8gSWYgdHJhbnNpdGlvbiBpcyBkZWZpbmVkLCBjaGVjayBpZiBjc3MgM0QgdHJhbnNmb3JtcyBhcmUgc3VwcG9ydGVkLCBhbmQgaWYgbm90LCBpZiBhIGZhbGxiYWNrIGlzIHNwZWNpZmllZAokLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCWlmICggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXTsKCQl9CgoJCXJldHVybiB0cmFuc2l0aW9uOwp9OwoKLy8gU2V0IHRoZSBnZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHRvIGRlZmF1bHQgaWYgbm8gaW1wbGVtZW50YXRpb24gd2FzIHNldCBieSB1c2VyCiQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHx8IGRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uOwp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvL2RlZmluZSB2YXJzIGZvciBpbnRlcmFsIHVzZQoJdmFyICR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3csCgkJJGh0bWwgPSAkKCAnaHRtbCcgKSwKCQkkaGVhZCA9ICQoICdoZWFkJyApLAoKCQkvLyBOT1RFOiBwYXRoIGV4dGVuc2lvbnMgZGVwZW5kZW50IG9uIGNvcmUgYXR0cmlidXRlcy4gTW92ZWQgaGVyZSB0byByZW1vdmUgZGVwcyBmcm9tCgkJLy8gICAgICAgJC5tb2JpbGUucGF0aCBkZWZpbml0aW9uCgkJcGF0aCA9ICQuZXh0ZW5kKCQubW9iaWxlLnBhdGgsIHsKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICcmJyArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL2NoZWNrIGlmIHRoZSBzcGVjaWZpZWQgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgbWFpbiBhcHBsaWNhdGlvbiBkb2N1bWVudC4KCQkJaXNGaXJzdFBhZ2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBXZSBvbmx5IGRlYWwgd2l0aCBhYnNvbHV0ZSBwYXRocy4KCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgdGhpcy5kb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8ICggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJLy8gVGhlIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaWYgdGhlIHBhdGggbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYW5kCgkJCQkvLyBpdCBlaXRoZXIgaGFzIG5vIGhhc2ggdmFsdWUsIG9yIHRoZSBoYXNoIGlzIGV4YWN0bHkgZXF1YWwgdG8gdGhlIGlkIG9mIHRoZQoJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJcmV0dXJuIHNhbWVQYXRoICYmICggIXUuaGFzaCB8fCB1Lmhhc2ggPT09ICIjIiB8fCAoIGZwSWQgJiYgdS5oYXNoLnJlcGxhY2UoIC9eIy8sICIiICkgPT09IGZwSWQgKSApOwoJCQl9LAoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCWlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0OiBmdW5jdGlvbiggZG9jVXJsLCByZXFVcmwgKSB7CgkJCQlyZXR1cm4gJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzICYmCgkJCQkJZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiICYmCgkJCQkJcmVxVXJsLnNlYXJjaCggL15odHRwcz86LyApICE9PSAtMTsKCQkJfQoJCX0pLAoKCQkvLyB1c2VkIHRvIHRyYWNrIGxhc3QgdmNsaWNrZWQgZWxlbWVudCB0byBtYWtlIHN1cmUgaXRzIHZhbHVlIGlzIGFkZGVkIHRvIGZvcm0gZGF0YQoJCSRsYXN0VkNsaWNrZWQgPSBudWxsLAoKCQkvL3dpbGwgYmUgZGVmaW5lZCB3aGVuIGEgbGluayBpcyBjbGlja2VkIGFuZCBnaXZlbiBhbiBhY3RpdmUgY2xhc3MKCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsLAoKCQkvLyByZXNvbHZlZCBvbiBkb21yZWFkeQoJCWRvbXJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgoJCS8vdXJsSGlzdG9yeSBpcyBwdXJlbHkgaGVyZSB0byBtYWtlIGd1ZXNzZXMgYXQgd2hldGhlciB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbiB3YXMgY2xpY2tlZAoJCS8vYW5kIHByb3ZpZGUgYW4gYXBwcm9wcmlhdGUgdHJhbnNpdGlvbgoJCXVybEhpc3RvcnkgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LAoKCQkvL2RlZmluZSBmaXJzdCBzZWxlY3RvciB0byByZWNlaXZlIGZvY3VzIHdoZW4gYSBwYWdlIGlzIHNob3duCgkJZm9jdXNhYmxlID0gIlt0YWJpbmRleF0sYSxidXR0b246dmlzaWJsZSxzZWxlY3Q6dmlzaWJsZSxpbnB1dCIsCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGguZG9jdW1lbnRVcmwsCgoJCS8vaWYgdGhlIGRvY3VtZW50IGhhcyBhbiBlbWJlZGRlZCBiYXNlIHRhZywgZG9jdW1lbnRCYXNlIGlzIHNldCB0byBpdHMKCQkvL2luaXRpYWwgdmFsdWUuIElmIGEgYmFzZSB0YWcgZG9lcyBub3QgZXhpc3QsIHRoZW4gd2UgZGVmYXVsdCB0byB0aGUgZG9jdW1lbnRVcmwuCgkJZG9jdW1lbnRCYXNlID0gcGF0aC5kb2N1bWVudEJhc2UsCgoJCS8vY2FjaGUgdGhlIGNvbXBhcmlzb24gb25jZS4KCQlkb2N1bWVudEJhc2VEaWZmZXJzID0gcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzLAoKCQlnZXRTY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQ7CgoJCS8vYmFzZSBlbGVtZW50IG1hbmFnZW1lbnQsIGRlZmluZWQgZGVwZW5kaW5nIG9uIGR5bmFtaWMgYmFzZSB0YWcgc3VwcG9ydAoJCXZhciBiYXNlID0gJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnID8gewoKCQkJLy9kZWZpbmUgYmFzZSBlbGVtZW50LCBmb3IgdXNlIGluIHJvdXRpbmcgYXNzZXQgdXJscyB0aGF0IGFyZSByZWZlcmVuY2VkIGluIEFqYXgtcmVxdWVzdGVkIG1hcmt1cAoJCQllbGVtZW50OiAoICRiYXNlLmxlbmd0aCA/ICRiYXNlIDogJCggIjxiYXNlPiIsIHsgaHJlZjogZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggfSApLnByZXBlbmRUbyggJGhlYWQgKSApLAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXNldDogZnVuY3Rpb24oIGhyZWYgKSB7CgkJCQlocmVmID0gcGF0aC5wYXJzZVVybChocmVmKS5ocmVmTm9IYXNoOwoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGRvY3VtZW50QmFzZSApICk7CgkJCX0sCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgZG9jdW1lbnRCYXNlLmhyZWZOb1NlYXJjaCApOwoJCQl9CgoJCX0gOiB1bmRlZmluZWQ7CgoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCSQubW9iaWxlLmdldERvY3VtZW50VXJsID0gcGF0aC5nZXREb2N1bWVudFVybDsKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCSQubW9iaWxlLmdldERvY3VtZW50QmFzZSA9IHBhdGguZ2V0RG9jdW1lbnRCYXNlOwoKCS8qIGludGVybmFsIHV0aWxpdHkgZnVuY3Rpb25zICovCgoJLy8gTk9URSBJc3N1ZSAjNDk1MCBBbmRyb2lkIHBob25lZ2FwIGRvZXNuJ3QgbmF2aWdhdGUgYmFjayBwcm9wZXJseQoJLy8gICAgICB3aGVuIGEgZnVsbCBwYWdlIHJlZnJlc2ggaGFzIHRha2VuIHBsYWNlLiBJdCBhcHBlYXJzIHRoYXQgaGFzaGNoYW5nZQoJLy8gICAgICBhbmQgcmVwbGFjZXN0YXRlIGhpc3RvcnkgYWx0ZXJhdGlvbnMgd29yayBmaW5lIGJ1dCB3ZSBuZWVkIHRvIHN1cHBvcnQKCS8vICAgICAgYm90aCBmb3JtcyBvZiBoaXN0b3J5IHRyYXZlcnNhbCBpbiBvdXIgY29kZSB0aGF0IHVzZXMgYmFja3dhcmQgaGlzdG9yeQoJLy8gICAgICBtb3ZlbWVudAoJJC5tb2JpbGUuYmFjayA9IGZ1bmN0aW9uKCkgewoJCXZhciBuYXYgPSB3aW5kb3cubmF2aWdhdG9yOwoKCQkvLyBpZiB0aGUgc2V0dGluZyBpcyBvbiBhbmQgdGhlIG5hdmlnYXRvciBvYmplY3QgaXMKCQkvLyBhdmFpbGFibGUgdXNlIHRoZSBwaG9uZWdhcCBuYXZpZ2F0aW9uIGNhcGFiaWxpdHkKCQlpZiggdGhpcy5waG9uZWdhcE5hdmlnYXRpb25FbmFibGVkICYmCgkJCW5hdiAmJgoJCQluYXYuYXBwICYmCgkJCW5hdi5hcHAuYmFja0hpc3RvcnkgKXsKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSgpOwoJCX0gZWxzZSB7CgkJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCQl9Cgl9OwoKCS8vZGlyZWN0IGZvY3VzIHRvIHRoZSBwYWdlIHRpdGxlLCBvciBvdGhlcndpc2UgZmlyc3QgZm9jdXNhYmxlIGVsZW1lbnQKCSQubW9iaWxlLmZvY3VzUGFnZSA9IGZ1bmN0aW9uICggcGFnZSApIHsKCQl2YXIgYXV0b2ZvY3VzID0gcGFnZS5maW5kKCAiW2F1dG9mb2N1c10iICksCgkJCXBhZ2VUaXRsZSA9IHBhZ2UuZmluZCggIi51aS10aXRsZTplcSgwKSIgKTsKCgkJaWYgKCBhdXRvZm9jdXMubGVuZ3RoICkgewoJCQlhdXRvZm9jdXMuZm9jdXMoKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBwYWdlVGl0bGUubGVuZ3RoICkgewoJCQlwYWdlVGl0bGUuZm9jdXMoKTsKCQl9IGVsc2V7CgkJCXBhZ2UuZm9jdXMoKTsKCQl9Cgl9OwoKCS8vcmVtb3ZlIGFjdGl2ZSBjbGFzc2VzIGFmdGVyIHBhZ2UgdHJhbnNpdGlvbiBvciBlcnJvcgoJZnVuY3Rpb24gcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZVJlbW92YWwgKSB7CgkJaWYgKCAhISRhY3RpdmVDbGlja2VkTGluayAmJiAoICEkYWN0aXZlQ2xpY2tlZExpbmsuY2xvc2VzdCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICkubGVuZ3RoIHx8IGZvcmNlUmVtb3ZhbCApICkgewoJCQkkYWN0aXZlQ2xpY2tlZExpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfQoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGw7Cgl9CgoJZnVuY3Rpb24gcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpIHsKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJaWYgKCBwYWdlVHJhbnNpdGlvblF1ZXVlLmxlbmd0aCA+IDAgKSB7CgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UuYXBwbHkoIG51bGwsIHBhZ2VUcmFuc2l0aW9uUXVldWUucG9wKCkgKTsKCQl9Cgl9CgoJLy8gU2F2ZSB0aGUgbGFzdCBzY3JvbGwgZGlzdGFuY2UgcGVyIHBhZ2UsIGJlZm9yZSBpdCBpcyBoaWRkZW4KCXZhciBzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWUsCgkJc2V0TGFzdFNjcm9sbCwgZGVsYXllZFNldExhc3RTY3JvbGw7CgoJc2V0TGFzdFNjcm9sbCA9IGZ1bmN0aW9uKCkgewoJCS8vIHRoaXMgYmFycmllciBwcmV2ZW50cyBzZXR0aW5nIHRoZSBzY3JvbGwgdmFsdWUgYmFzZWQgb24gdGhlIGJyb3dzZXIKCQkvLyBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQlpZiAoICFzZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCk7CgoJCWlmICggYWN0aXZlICkgewoJCQl2YXIgbGFzdFNjcm9sbCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCQkvLyBTZXQgYWN0aXZlIHBhZ2UncyBsYXN0U2Nyb2xsIHByb3AuCgkJCS8vIElmIHRoZSBsb2NhdGlvbiB3ZSdyZSBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJYWN0aXZlLmxhc3RTY3JvbGwgPSBsYXN0U2Nyb2xsIDwgJC5tb2JpbGUubWluU2Nyb2xsQmFjayA/ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsIDogbGFzdFNjcm9sbDsKCQl9Cgl9OwoKCS8vIGJpbmQgdG8gc2Nyb2xsc3RvcCB0byBnYXRoZXIgc2Nyb2xsIHBvc2l0aW9uLiBUaGUgZGVsYXkgYWxsb3dzIGZvciB0aGUgaGFzaGNoYW5nZQoJLy8gZXZlbnQgdG8gZmlyZSBhbmQgZGlzYWJsZSBzY3JvbGwgcmVjb3JkaW5nIGluIHRoZSBjYXNlIHdoZXJlIHRoZSBicm93c2VyIHNjcm9sbHMKCS8vIHRvIHRoZSBoYXNoIHRhcmdldHMgbG9jYXRpb24gKHNvbWV0aW1lcyB0aGUgdG9wIG9mIHRoZSBwYWdlKS4gb25jZSBwYWdlY2hhbmdlIGZpcmVzCgkvLyBnZXRMYXN0U2Nyb2xsIGlzIGFnYWluIHBlcm1pdHRlZCB0byBvcGVyYXRlCglkZWxheWVkU2V0TGFzdFNjcm9sbCA9IGZ1bmN0aW9uKCkgewoJCXNldFRpbWVvdXQoIHNldExhc3RTY3JvbGwsIDEwMCApOwoJfTsKCgkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLCB0aGlzIG9ubHkgd29ya3MKCS8vIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uIGlzIGRlbGF5ZWQgZm9yIDEwMG1zIGFmdGVyCgkvLyB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlIHBvc2l0aW9uIGJlY2F1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UKCSR3aW5kb3cuYmluZCggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJCXNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7Cgl9KTsKCgkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkkd2luZG93Lm9uZSggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCX0pOwoKCS8vIHdhaXQgdW50aWwgdGhlIG1vYmlsZSBwYWdlIGNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIHRvIGJpbmQgdG8gcGFnZWNoYW5nZQoJJHdpbmRvdy5vbmUoICJwYWdlY29udGFpbmVyY3JlYXRlIiwgZnVuY3Rpb24oKSB7CgkJLy8gb25jZSB0aGUgcGFnZSBoYXMgY2hhbmdlZCwgcmUtZW5hYmxlIHRoZSBzY3JvbGwgcmVjb3JkaW5nCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5iaW5kKCAicGFnZWNoYW5nZSIsIGZ1bmN0aW9uKCkgewoKCQkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gcmVtb3ZlIGFueSBiaW5kaW5nIHRoYXQgcHJldmlvdXNseSBleGlzdGVkIG9uIHRoZSBnZXQgc2Nyb2xsCgkJCS8vIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIGRpZmZlcmVudCB0aGFuIHRoZSBzY3JvbGwgZWxlbWVudCBkZXRlcm1pbmVkIGZvcgoJCQkvLyB0aGlzIHBhZ2UgcHJldmlvdXNseQoJCQkkd2luZG93LnVuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCQkJLy8gZGV0ZXJtaW5lIGFuZCBiaW5kIHRvIHRoZSBjdXJyZW50IHNjb2xsIGVsZW1lbnQgd2hpY2ggbWF5IGJlIHRoZSB3aW5kb3cKCQkJLy8gb3IgaW4gdGhlIGNhc2Ugb2YgdG91Y2ggb3ZlcmZsb3cgdGhlIGVsZW1lbnQgd2l0aCB0b3VjaCBvdmVyZmxvdwoJCQkkd2luZG93LmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCQl9KTsKCX0pOwoKCS8vIGJpbmQgdG8gc2Nyb2xsc3RvcCBmb3IgdGhlIGZpcnN0IHBhZ2UgYXMgInBhZ2VjaGFuZ2UiIHdvbid0IGJlIGZpcmVkIGluIHRoYXQgY2FzZQoJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJLy8gTm8tb3AgaW1wbGVtZW50YXRpb24gb2YgdHJhbnNpdGlvbiBkZWdyYWRhdGlvbgoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiB8fCBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy9mdW5jdGlvbiBmb3IgdHJhbnNpdGlvbmluZyBiZXR3ZWVuIHR3byBleGlzdGluZyBwYWdlcwoJZnVuY3Rpb24gdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCB0cmFuc2l0aW9uLCByZXZlcnNlICkgewoJCWlmICggZnJvbVBhZ2UgKSB7CgkJCS8vdHJpZ2dlciBiZWZvcmUgc2hvdy9oaWRlIGV2ZW50cwoJCQlmcm9tUGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVoaWRlIiwgbnVsbCwgeyBuZXh0UGFnZTogdG9QYWdlIH0gKTsKCQl9CgoJCXRvUGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgoJCS8vY2xlYXIgcGFnZSBsb2FkZXIKCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCgkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB0cmFuc2l0aW9uICk7CgoJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJLy9pc24ndCBvbmUgaW4gb3VyIHRyYW5zaXRpb25IYW5kbGVycyBkaWN0aW9uYXJ5LCB1c2UgdGhlIGRlZmF1bHQgb25lLgoJCS8vY2FsbCB0aGUgaGFuZGxlciBpbW1lZGlhdGVseSB0byBraWNrLW9mZiB0aGUgdHJhbnNpdGlvbi4KCQl2YXIgdGggPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnNbIHRyYW5zaXRpb24gfHwgImRlZmF1bHQiIF0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyLAoJCQlwcm9taXNlID0gdGgoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvUGFnZSwgZnJvbVBhZ2UgKTsKCgkJcHJvbWlzZS5kb25lKGZ1bmN0aW9uKCkgewoJCQkvL3RyaWdnZXIgc2hvdy9oaWRlIGV2ZW50cwoJCQlpZiAoIGZyb21QYWdlICkgewoJCQkJZnJvbVBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLl90cmlnZ2VyKCAiaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJCX0KCgkJCS8vdHJpZ2dlciBwYWdlc2hvdywgZGVmaW5lIHByZXZQYWdlIGFzIGVpdGhlciBmcm9tUGFnZSBvciBlbXB0eSBqUXVlcnkgb2JqCgkJCXRvUGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkuX3RyaWdnZXIoICJzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgkJfSk7CgoJCXJldHVybiBwcm9taXNlOwoJfQoKCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCA9IGZ1bmN0aW9uIHJlc2V0QWN0aXZlUGFnZUhlaWdodCggaGVpZ2h0ICkgewoJCXZhciBhUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQlhUGFnZVBhZFQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQlhUGFnZVBhZEIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApLAoJCQlhUGFnZUJvcmRlclQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICksCgkJCWFQYWdlQm9yZGVyQiA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggImJvcmRlci1ib3R0b20td2lkdGgiICkgKTsKCgkJaGVpZ2h0ID0gKCB0eXBlb2YgaGVpZ2h0ID09PSAibnVtYmVyIiApPyBoZWlnaHQgOiBnZXRTY3JlZW5IZWlnaHQoKTsKCQkKCQlhUGFnZS5jc3MoICJtaW4taGVpZ2h0IiwgaGVpZ2h0IC0gYVBhZ2VQYWRUIC0gYVBhZ2VQYWRCIC0gYVBhZ2VCb3JkZXJUIC0gYVBhZ2VCb3JkZXJCICk7Cgl9OwoKCS8vc2hhcmVkIHBhZ2UgZW5oYW5jZW1lbnRzCglmdW5jdGlvbiBlbmhhbmNlUGFnZSggJHBhZ2UsIHJvbGUgKSB7CgkJLy8gSWYgYSByb2xlIHdhcyBzcGVjaWZpZWQsIG1ha2Ugc3VyZSB0aGUgZGF0YS1yb2xlIGF0dHJpYnV0ZQoJCS8vIG9uIHRoZSBwYWdlIGVsZW1lbnQgaXMgaW4gc3luYy4KCQlpZiAoIHJvbGUgKSB7CgkJCSRwYWdlLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgcm9sZSApOwoJCX0KCgkJLy9ydW4gcGFnZSBwbHVnaW4KCQkkcGFnZS5wYWdlKCk7Cgl9CgoJLy8gZGV0ZXJtaW5lIHRoZSBjdXJyZW50IGJhc2UgdXJsCglmdW5jdGlvbiBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgewoJCXZhciBjbG9zZXN0QmFzZSA9ICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiBnZXRDbG9zZXN0QmFzZVVybCggJC5tb2JpbGUuYWN0aXZlUGFnZSApICk7CgkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJfQoKCS8qIGV4cG9zZWQgJC5tb2JpbGUgbWV0aG9kcyAqLwoKCS8vYW5pbWF0aW9uIGNvbXBsZXRlIGNhbGxiYWNrCgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zICkgewoJCQlyZXR1cm4gJCggdGhpcyApLm9uZSggJ3dlYmtpdEFuaW1hdGlvbkVuZCBhbmltYXRpb25lbmQnLCBjYWxsYmFjayApOwoJCX0KCQllbHNlewoJCQkvLyBkZWZlciBleGVjdXRpb24gZm9yIGNvbnNpc3RlbmN5IGJldHdlZW4gd2Via2l0L25vbiB3ZWJraXQKCQkJc2V0VGltZW91dCggY2FsbGJhY2ssIDAgKTsKCQkJcmV0dXJuICQoIHRoaXMgKTsKCQl9Cgl9OwoKCS8vZXhwb3NlIHBhdGggb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5wYXRoID0gcGF0aDsKCgkvL2V4cG9zZSBiYXNlIG9iamVjdCBvbiAkLm1vYmlsZQoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7CgoJLy9oaXN0b3J5IHN0YWNrCgkkLm1vYmlsZS51cmxIaXN0b3J5ID0gdXJsSGlzdG9yeTsKCgkkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ID0gZGlhbG9nSGFzaEtleTsKCgkvL2VuYWJsZSBjcm9zcy1kb21haW4gcGFnZSBzdXBwb3J0CgkkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgPSBmYWxzZTsKCgkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgPSBmdW5jdGlvbigpIHsKCQl2YXIgcGFnZSA9ICQoIHRoaXMgKTsKCgkJLy8gd2hlbiBkb20gY2FjaGluZyBpcyBub3QgZW5hYmxlZCBvciB0aGUgcGFnZSBpcyBlbWJlZGRlZCBiaW5kIHRvIHJlbW92ZSB0aGUgcGFnZSBvbiBoaWRlCgkJaWYgKCAhcGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkub3B0aW9ucy5kb21DYWNoZSAmJgoJCQlwYWdlLmlzKCAiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIiApICkgewoKCQkJcGFnZS5iaW5kKCAncGFnZWhpZGUucmVtb3ZlJywgZnVuY3Rpb24oIGUgKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkkdGhpcy50cmlnZ2VyKCBwckV2ZW50ICk7CgoJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9OwoKCS8vIExvYWQgYSBwYWdlIGludG8gdGhlIERPTS4KCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkvLyBUaGlzIGZ1bmN0aW9uIHVzZXMgZGVmZXJyZWQgbm90aWZpY2F0aW9ucyB0byBsZXQgY2FsbGVycwoJCS8vIGtub3cgd2hlbiB0aGUgcGFnZSBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQl2YXIgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgoJCQkvLyBUaGUgZGVmYXVsdCBsb2FkUGFnZSBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieQoJCQkvLyB0aGUgY2FsbGVyLgoJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKSwKCgkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIHBhZ2UgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQlwYWdlID0gbnVsbCwKCgkJCS8vIElmIHRoZSByZWxvYWRQYWdlIG9wdGlvbiBpcyB0cnVlLCBhbmQgdGhlIHBhZ2UgaXMgYWxyZWFkeQoJCQkvLyBpbiB0aGUgRE9NLCBkdXBDYWNoZWRQYWdlIHdpbGwgYmUgc2V0IHRvIHRoZSBwYWdlIGVsZW1lbnQKCQkJLy8gc28gdGhhdCBpdCBjYW4gYmUgcmVtb3ZlZCBhZnRlciB0aGUgbmV3IHZlcnNpb24gb2YgdGhlCgkJCS8vIHBhZ2UgaXMgbG9hZGVkIG9mZiB0aGUgbmV0d29yay4KCQkJZHVwQ2FjaGVkUGFnZSA9IG51bGwsCgoJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIHBhc3NlZCBpbnRvIHRoZSBmdW5jdGlvbi4gVGhpcwoJCQkvLyB2ZXJzaW9uIG9mIHRoZSBVUkwgbWF5IGNvbnRhaW4gZGlhbG9nL3N1YnBhZ2UgcGFyYW1zIGluIGl0LgoJCQlhYnNVcmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCgkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkvLyBhcHBlbmQgdGhlIGRhdGEgdG8gdGhlIFVSTC4KCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gImdldCIgKSB7CgkJCWFic1VybCA9IHBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJc2V0dGluZ3MuZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkUGFnZSBtdXN0IGJlIHRydWUKCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICkgewoJCQlzZXR0aW5ncy5yZWxvYWRQYWdlID0gdHJ1ZTsKCQl9CgoJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJwYWdlIHBhcmFtcy4KCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgcGFnZSB0byBiZSBsb2FkZWQuCgkJdmFyIGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBhYnNVcmwgKSwKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIHBhZ2UuIEZvciBlbWJlZGRlZCBwYWdlcywgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvciBwYWdlcwoJCQkvLyB3aXRoaW4gdGhlIHNhbWUgZG9tYWluIGFzIHRoZSBkb2N1bWVudCBiYXNlLCBpdCBpcyB0aGUgc2l0ZSByZWxhdGl2ZQoJCQkvLyBwYXRoLiBGb3IgY3Jvc3MtZG9tYWluIHBhZ2VzIChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZSBhYnNvbHV0ZSBVcmwKCQkJLy8gdXNlZCB0byBsb2FkIHRoZSBwYWdlLgoJCQlkYXRhVXJsID0gcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBhYnNVcmwgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHN1ZWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkvLyAgICAgIGFyZSBhIHZhbGlkIHVybCBjaGFyIGFuZCBpdCBicmVha3Mgb24gdGhlIGZpcnN0IG9jY3VyZW5jZQoJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkvLyByZWZlcmVuY2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4gSWYgc28sIGl0IG1heSBoYXZlIGJlZW4gZHluYW1pY2FsbHkKCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEgZGF0YS11cmwKCQkvLyBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJiBkYXRhVXJsICYmICFwYXRoLmlzUGF0aCggZGF0YVVybCApICkgewoJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIiMiICsgZGF0YVVybCApCgkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIGRhdGFVcmwgKQoJCQkJLmpxbURhdGEoICJ1cmwiLCBkYXRhVXJsICk7CgkJfQoKCQkKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCBhIHBhZ2UgaW4gdGhlIERPTSwgY2hlY2sgdGhlIFVSTCB0byBzZWUgaWYgaXQKCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZQoJCS8vIHRvIHRoZSBmaXJzdCBwYWdlIGFuZCByZWZlcnMgdG8gbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UsIGVycm9yIG91dC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICkgewoJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZSAmJiBwYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgKSB7CgkJCQkvLyBDaGVjayB0byBtYWtlIHN1cmUgb3VyIGNhY2hlZC1maXJzdC1wYWdlIGlzIGFjdHVhbGx5CgkJCQkvLyBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQgYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMsIHdlIGNoZWNrIGZvciB0aGlzCgkJCQkvLyBjYXNlIGhlcmUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGEgZmlyc3QtcGFnZSB3aXRoIGFuIGlkCgkJCQkvLyBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yCgkJCQkvLyBjYXNlLiBJZiB0aGUgZmlyc3QtcGFnZSBpcyBub3QgaW4gdGhlIERPTSwgdGhlbiB3ZSBsZXQKCQkJCS8vIHRoaW5ncyBmYWxsIHRocm91Z2ggdG8gdGhlIGFqYXggbG9hZGluZyBjb2RlIGJlbG93IHNvCgkJCQkvLyB0aGF0IGl0IGdldHMgcmVsb2FkZWQuCgkJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZS5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQkJcGFnZSA9ICQoICQubW9iaWxlLmZpcnN0UGFnZSApOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCBmaWxlVXJsICkgICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQl9CgkJCgkJLy8gSWYgdGhlIHBhZ2Ugd2UgYXJlIGludGVyZXN0ZWQgaW4gaXMgYWxyZWFkeSBpbiB0aGUgRE9NLAoJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCS8vIHJlbG9hZCBvZiB0aGUgZmlsZSwgd2UgYXJlIGRvbmUuIE90aGVyd2lzZSwgdHJhY2sgdGhlCgkJLy8gZXhpc3RpbmcgcGFnZSBhcyBhIGR1cGxpY2F0ZWQuCgkJaWYgKCBwYWdlLmxlbmd0aCApIHsKCQkJaWYgKCAhc2V0dGluZ3MucmVsb2FkUGFnZSApIHsKCQkJCWVuaGFuY2VQYWdlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIG9wdGlvbnMsIHBhZ2UgKTsKCQkJCS8vaWYgd2UgYXJlIHJlbG9hZGluZyB0aGUgcGFnZSBtYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSBiYXNlIGlmIGl0cyBub3QgYSBwcmVmZXRjaCAKCQkJCWlmKCBiYXNlICYmICFvcHRpb25zLnByZWZldGNoICl7CgkJCQkJYmFzZS5zZXQodXJsKTsKCQkJCX0KCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQkJZHVwQ2FjaGVkUGFnZSA9IHBhZ2U7CgkJfQoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmxFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWxvYWQiICksCgkJCXRyaWdnZXJEYXRhID0geyB1cmw6IHVybCwgYWJzVXJsOiBhYnNVcmwsIGRhdGFVcmw6IGRhdGFVcmwsIGRlZmVycmVkOiBkZWZlcnJlZCwgb3B0aW9uczogc2V0dGluZ3MgfTsKCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGxvYWQgYSBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmxFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYgKCBwYmxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQl9CgoJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZiBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJdmFyIGxvYWRNc2dEZWxheSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9LCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKSwKCgkJCQkvLyBTaGFyZWQgbG9naWMgZm9yIGNsZWFyaW5nIHRpbWVvdXQgYW5kIHJlbW92aW5nIG1lc3NhZ2UuCgkJCQloaWRlTXNnID0gZnVuY3Rpb24oKSB7CgoJCQkJCS8vIFN0b3AgbWVzc2FnZSBzaG93IHRpbWVyCgkJCQkJY2xlYXJUaW1lb3V0KCBsb2FkTXNnRGVsYXkgKTsKCgkJCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCQkJCX07CgkJfQoJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQkvLyBvbmx5IHJlc2V0IGlmIHdlIGFyZSBub3QgcHJlZmV0Y2hpbmcgCgkJaWYgKCBiYXNlICYmIHR5cGVvZiBvcHRpb25zLnByZWZldGNoID09PSAidW5kZWZpbmVkIiApIHsKCQkJYmFzZS5yZXNldCgpOwoJCX0KCgkJaWYgKCAhKCAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgfHwgcGF0aC5pc1NhbWVEb21haW4oIGRvY3VtZW50VXJsLCBhYnNVcmwgKSApICkgewoJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCX0gZWxzZSB7CgkJCS8vIExvYWQgdGhlIG5ldyBwYWdlLgoJCQkkLmFqYXgoewoJCQkJdXJsOiBmaWxlVXJsLAoJCQkJdHlwZTogc2V0dGluZ3MudHlwZSwKCQkJCWRhdGE6IHNldHRpbmdzLmRhdGEsCgkJCQljb250ZW50VHlwZTogc2V0dGluZ3MuY29udGVudFR5cGUsCgkJCQlkYXRhVHlwZTogImh0bWwiLAoJCQkJc3VjY2VzczogZnVuY3Rpb24oIGh0bWwsIHRleHRTdGF0dXMsIHhociApIHsKCQkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJCS8vdXNlIGl0IGFzIHRoZSBuZXcgZmlsZVVybCwgYmFzZSBwYXRoLCBldGMKCQkJCQl2YXIgYWxsID0gJCggIjxkaXY+PC9kaXY+IiApLAoKCQkJCQkJLy9wYWdlIHRpdGxlIHJlZ2V4cAoJCQkJCQluZXdQYWdlVGl0bGUgPSBodG1sLm1hdGNoKCAvPHRpdGxlW14+XSo+KFtePF0qKS8gKSAmJiBSZWdFeHAuJDEsCgoJCQkJCQkvLyBUT0RPIGhhbmRsZSBkaWFsb2dzIGFnYWluCgkJCQkJCXBhZ2VFbGVtUmVnZXggPSBuZXcgUmVnRXhwKCAiKDxbXj5dK1xcYmRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgkJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmw9W1wiJ10/KFteXCInPl0qKVtcIiddPyIgKTsKCgoJCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cyBjYW4gYmUgZGlyZWN0ZWQgdG8gdGhlCgkJCQkJLy8gY29ycmVjdCB1cmwuIGxvYWRpbmcgaW50byBhIHRlbXByb3JhcnkgZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJCWlmICggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkgJiYKCQkJCQkJCVJlZ0V4cC4kMSAmJgoJCQkJCQkJZGF0YVVybFJlZ2V4LnRlc3QoIFJlZ0V4cC4kMSApICYmCgkJCQkJCQlSZWdFeHAuJDEgKSB7CgkJCQkJCXVybCA9IGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCAkKCAiPGRpdj4iICsgUmVnRXhwLiQxICsgIjwvZGl2PiIgKS50ZXh0KCkgKTsKCQkJCQl9CgkJCQkJLy9kb250IHVwZGF0ZSB0aGUgYmFzZSB0YWcgaWYgd2UgYXJlIHByZWZldGNoaW5nCgkJCQkJaWYgKCBiYXNlICYmIHR5cGVvZiBvcHRpb25zLnByZWZldGNoID09PSAidW5kZWZpbmVkIikgewoJCQkJCQliYXNlLnNldCggZmlsZVVybCApOwoJCQkJCX0KCgkJCQkJLy93b3JrYXJvdW5kIHRvIGFsbG93IHNjcmlwdHMgdG8gZXhlY3V0ZSB3aGVuIGluY2x1ZGVkIGluIHBhZ2UgZGl2cwoJCQkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoJCQkJCXBhZ2UgPSBhbGwuZmluZCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmlyc3QoKTsKCgkJCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJCQlpZiAoICFwYWdlLmxlbmd0aCApIHsKCQkJCQkJcGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPiIgKyAoIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSB8fCAiIiApICsgIjwvZGl2PiIgKTsKCQkJCQl9CgoJCQkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCQkJaWYgKCB+bmV3UGFnZVRpdGxlLmluZGV4T2YoICImIiApICkgewoJCQkJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJCQl9CgkJCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCQkJfQoKCQkJCQkvL3Jld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsCgkJCQkJaWYgKCAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJCQl2YXIgbmV3UGF0aCA9IHBhdGguZ2V0KCBmaWxlVXJsICk7CgkJCQkJCXBhZ2UuZmluZCggIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgdGhpc0F0dHIgPSAkKCB0aGlzICkuaXMoICdbaHJlZl0nICkgPyAnaHJlZicgOgoJCQkJCQkJCQkkKCB0aGlzICkuaXMoICdbc3JjXScgKSA/ICdzcmMnIDogJ2FjdGlvbicsCgkJCQkJCQkJdGhpc1VybCA9ICQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciApOwoKCQkJCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkJCQkvLyAgICAgICAgICAgIGJhc2UgVVJMLCBhbmQgdGhlbiBwcmVwZW5kcyB3aXRoIHRoZSBuZXcgcGFnZSBVUkwuCgkJCQkJCQkvL2lmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgJycgKTsKCgkJCQkJCQlpZiAoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJCQkJJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCS8vYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJCQkvLyBUT0RPIHRhZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QgcmVtb3ZlZAoJCQkJCS8vICAgICAgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZSBpbiBtYW55CgkJCQkJLy8gICAgICBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJCQlwYWdlCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBmaWxlVXJsICkgKQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICkKCQkJCQkJLmFwcGVuZFRvKCBzZXR0aW5ncy5wYWdlQ29udGFpbmVyICk7CgoJCQkJCS8vIHdhaXQgZm9yIHBhZ2UgY3JlYXRpb24gdG8gbGV2ZXJhZ2Ugb3B0aW9ucyBkZWZpbmVkIG9uIHdpZGdldAoJCQkJCXBhZ2Uub25lKCAncGFnZWNyZWF0ZScsICQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSApOwoKCQkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJCQkvLyBFbmhhbmNpbmcgdGhlIHBhZ2UgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgcGFnZXMgYmVpbmcgaW5zZXJ0ZWQKCQkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLXBhZ2UsIHRoYXQgaXMgdGhlCgkJCQkJLy8gcmVhbCBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQkJfQoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJCWhpZGVNc2coKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCB0aGUgcGFnZSByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLnBhZ2UgPSBwYWdlOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZGVkIHN1Y2Nlc3NmdWxseS4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSwgZHVwQ2FjaGVkUGFnZSApOwoJCQkJfSwKCQkJCWVycm9yOiBmdW5jdGlvbiggeGhyLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biApIHsKCQkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQkJaWYgKCBiYXNlICkgewoJCQkJCQliYXNlLnNldCggcGF0aC5nZXQoKSApOwoJCQkJCX0KCgkJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCQl2YXIgcGxmRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2Vsb2FkZmFpbGVkIiApOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCBwbGZFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJCWlmICggcGxmRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJCWhpZGVNc2coKTsKCgkJCQkJCS8vIHNob3cgZXJyb3IgbWVzc2FnZQoJCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkJCQkvLyBoaWRlIGFmdGVyIGRlbGF5CgkJCQkJCXNldFRpbWVvdXQoICQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZywgMTUwMCApOwoJCQkJCX0KCgkJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKCgkkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cyA9IHsKCQl0eXBlOiAiZ2V0IiwKCQlkYXRhOiB1bmRlZmluZWQsCgkJcmVsb2FkUGFnZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJc2hvd0xvYWRNc2c6IGZhbHNlLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlsb2FkTXNnRGVsYXk6IDUwIC8vIFRoaXMgZGVsYXkgYWxsb3dzIGxvYWRzIHRoYXQgcHVsbCBmcm9tIGJyb3dzZXIgY2FjaGUgdG8gb2NjdXIgd2l0aG91dCBzaG93aW5nIHRoZSBsb2FkaW5nIG1lc3NhZ2UuCgl9OwoKCS8vIFNob3cgYSBzcGVjaWZpYyBwYWdlIGluIHRoZSBwYWdlIGNvbnRhaW5lci4KCSQubW9iaWxlLmNoYW5nZVBhZ2UgPSBmdW5jdGlvbiggdG9QYWdlLCBvcHRpb25zICkgewoJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24gdG8KCQkvLyBzZXJ2aWNlIHRoZSByZXF1ZXN0LgoJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksIGlzVG9QYWdlU3RyaW5nOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCAkLm1vYmlsZS5hY3RpdmVQYWdlOwoKCQlpc1RvUGFnZVN0cmluZyA9ICh0eXBlb2YgdG9QYWdlID09PSAic3RyaW5nIik7CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHRvUGFnZTogdG9QYWdlLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBOT1RFOiBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUgc2ltcGxpZmllZAoJCS8vICAgICAgIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcyBmcm9tIHRoZSBoYXNoCgkJLy8gICAgICAgdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbQoJCS8vICAgICAgIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UgbGlmZSBjeWNsZSBTZWUgaXNzdWUgIzUwODUKCQlpZiAoIGlzVG9QYWdlU3RyaW5nICkgewoJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgc3RyaW5nIHNpbXBseSBjb252ZXJ0IGl0CgkJCXRyaWdnZXJEYXRhLmFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB0b1BhZ2UsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoJCX0gZWxzZSB7CgkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBqUXVlcnkgb2JqZWN0IGdyYWIgdGhlIGFic29sdXRlIHVybCBzdG9yZWQKCQkJLy8gaW4gdGhlIGxvYWRQYWdlIGNhbGxiYWNrIHdoZXJlIGl0IGV4aXN0cwoJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSB0b1BhZ2UuZGF0YSggJ2Fic1VybCcgKTsKCQl9CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZS4KCQltcGMudHJpZ2dlciggcGJjRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmICggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0b1BhZ2UgaW4gdGhlIHRyaWdnZXIKCQkvLyBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG9QYWdlIGlzIHVwZGF0ZWQuCgkJLy8KCQkvLyBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywgYmVjYXVzZSBhbiBvYmplY3QgY2FuCgkJLy8gYWxzbyBiZSByZXBsYWNlZCBieSBhIHN0cmluZwoKCQl0b1BhZ2UgPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgkJaXNUb1BhZ2VTdHJpbmcgPSAodHlwZW9mIHRvUGFnZSA9PT0gInN0cmluZyIpOwoKCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCS8vIElmIHRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgdXJsLCBjYWxsIGxvYWRQYWdlKCkKCQkvLyB0byBtYWtlIHN1cmUgaXQgaXMgbG9hZGVkIGludG8gdGhlIERPTS4gV2UnbGwgbGlzdGVuCgkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJLy8gaXQgaXMgZG9uZSBsb2FkaW5nIG9yIGlmIGFuIGVycm9yIG9jdXJyZWQuCgkJaWYgKCBpc1RvUGFnZVN0cmluZyApIHsKCQkJLy8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlIHNpbXBsaWZpZWQKCQkJLy8gZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zIGZyb20gdGhlIGhhc2gKCQkJLy8gdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbQoJCQkvLyBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJCXNldHRpbmdzLnRhcmdldCA9IHRvUGFnZTsKCgkJCSQubW9iaWxlLmxvYWRQYWdlKCB0b1BhZ2UsIHNldHRpbmdzICkKCQkJCS5kb25lKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIG5ld1BhZ2UsIGR1cENhY2hlZFBhZ2UgKSB7CgkJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQkJCW9wdGlvbnMuZHVwbGljYXRlQ2FjaGVkUGFnZSA9IGR1cENhY2hlZFBhZ2U7CgoJCQkJCS8vIHN0b3JlIHRoZSBvcmlnaW5hbCBhYnNvbHV0ZSB1cmwgc28gdGhhdCBpdCBjYW4gYmUgcHJvdmlkZWQKCQkJCQkvLyB0byBldmVudHMgaW4gdGhlIHRyaWdnZXJEYXRhIG9mIHRoZSBzdWJzZXF1ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJCW5ld1BhZ2UuZGF0YSggJ2Fic1VybCcsIHRyaWdnZXJEYXRhLmFic1VybCApOwoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIG5ld1BhZ2UsIG9wdGlvbnMgKTsKCQkJCX0pCgkJCQkuZmFpbChmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoKCQkJCQkvL2NsZWFyIG91dCB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZQoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoKCQkJCQkvL3JlbGVhc2UgdHJhbnNpdGlvbiBsb2NrIHNvIG5hdmlnYXRpb24gaXMgZnJlZSBhZ2FpbgoJCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJCX0pOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkvLyBzdXJlIHNldHRpbmdzLmRhdGFVcmwgaXMgc2V0IHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB1cmwuIFRoaXMgYWxsb3dzCgkJLy8gdXMgdG8gYXZvaWQgZ2VuZXJhdGluZyBhIGRvY3VtZW50IHVybCB3aXRoIGFuIGlkIGhhc2ggaW4gdGhlIGNhc2Ugd2hlcmUgdGhlCgkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJaWYgKCB0b1BhZ2VbIDAgXSA9PT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gJiYgIXNldHRpbmdzLmRhdGFVcmwgKSB7CgkJCXNldHRpbmdzLmRhdGFVcmwgPSBkb2N1bWVudFVybC5ocmVmTm9IYXNoOwoJCX0KCgkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkvLyBpbnRlcm5hbCBzdGF0ZSBhbmQgdGhlbiB0cmlnZ2VyIGEgdHJhbnNpdGlvbiB0byB0aGUgcGFnZS4KCQl2YXIgZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSwKCQkJdXJsID0gKCBzZXR0aW5ncy5kYXRhVXJsICYmIHBhdGguY29udmVydFVybFRvRGF0YVVybCggc2V0dGluZ3MuZGF0YVVybCApICkgfHwgdG9QYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCS8vIFRoZSBwYWdlVXJsIHZhciBpcyB1c3VhbGx5IHRoZSBzYW1lIGFzIHVybCwgZXhjZXB0IHdoZW4gdXJsIGlzIG9ic2N1cmVkIGFzIGEgZGlhbG9nIHVybC4gcGFnZVVybCBhbHdheXMgY29udGFpbnMgdGhlIGZpbGUgcGF0aAoJCQlwYWdlVXJsID0gdXJsLAoJCQlmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggdXJsICksCgkJCWFjdGl2ZSA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCWFjdGl2ZUlzSW5pdGlhbFBhZ2UgPSB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwLAoJCQloaXN0b3J5RGlyID0gMCwKCQkJcGFnZVRpdGxlID0gZG9jdW1lbnQudGl0bGUsCgkJCWlzRGlhbG9nID0gc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwgdG9QYWdlLmpxbURhdGEoICJyb2xlIiApID09PSAiZGlhbG9nIjsKCgoJCS8vIEJ5IGRlZmF1bHQsIHdlIHByZXZlbnQgY2hhbmdlUGFnZSByZXF1ZXN0cyB3aGVuIHRoZSBmcm9tUGFnZSBhbmQgdG9QYWdlCgkJLy8gYXJlIHRoZSBzYW1lIGVsZW1lbnQsIGJ1dCBmb2xrcyB0aGF0IGdlbmVyYXRlIGNvbnRlbnQgbWFudWFsbHkvZHluYW1pY2FsbHkKCQkvLyBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cKCQkvLyB0aGlzLCB0aGV5IHdpbGwgbmVlZCB0byBjaGFuZ2UgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24KCQkvLyB0byB0cnVlLCAqT1IqLCBwYXNzIGl0IGluIGFzIGFuIG9wdGlvbiB3aGVuIHRoZXkgbWFudWFsbHkgY2FsbCBjaGFuZ2VQYWdlKCkuCgkJLy8gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQgb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZQoJCS8vIGZvcm1QYWdlIGFuZCB0b1BhZ2UgYXJlIGRpZmZlcmVudCBlbGVtZW50cywgc28gdGhleSBtYXkgYmVoYXZlIHVuZXhwZWN0ZWRseS4KCQkvLyBJdCBpcyB1cCB0byB0aGUgZGV2ZWxvcGVyIHRoYXQgdHVybnMgb24gdGhlIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uYSBvcHRpb24KCQkvLyB0byBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCS8vIGFuaW1hdGlvbiB0cmFuc2l0aW9uIGlzIHVzZWQuCgkJaWYgKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUgdXJsSGlzdG9yeSBpbiBzeW5jIHdpdGggdGhlIGhhc2ggY2hhbmdlcwoJCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJfQoKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhZ2Ugd2UgYXJlIGdpdmVuIGhhcyBhbHJlYWR5IGJlZW4gZW5oYW5jZWQuCgkJZW5oYW5jZVBhZ2UoIHRvUGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0byBzZWUgaWYgdGhlCgkJLy8gcGFnZSBpcyBhbHJlYWR5IHdpdGhpbiB0aGUgdXJsSGlzdG9yeSBzdGFjay4gSWYgc28sIHdlJ2xsIGFzc3VtZSB0aGUgdXNlciBoaXQKCQkvLyB0aGUgZm9yd2FyZC9iYWNrIGJ1dHRvbiBhbmQgd2lsbCB0cnkgdG8gbWF0Y2ggdGhlIHRyYW5zaXRpb24gYWNjb3JkaW5nbHkuCgkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJaGlzdG9yeURpciA9IG9wdGlvbnMuZGlyZWN0aW9uID09PSAiYmFjayIgPyAtMSA6IDE7CgkJfQoKCQkvLyBLaWxsIHRoZSBrZXlib2FyZC4KCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gc3RvcCBjcmF3bGluZyB0aGUgZW50aXJlIGRvY3VtZW50IHRvIGtpbGwgZm9jdXMuIEluc3RlYWQsCgkJLy8gICAgICAgICAgICB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkgaGFuZGxlciBzbyB3ZSBhbHJlYWR5IGhhdmUKCQkvLyAgICAgICAgICAgIHRoZSBlbGVtZW50IGluIGhhbmQgYXQgdGhpcyBwb2ludC4KCQkvLyBXcmFwIHRoaXMgaW4gYSB0cnkvY2F0Y2ggYmxvY2sgc2luY2UgSUU5IHRocm93ICJVbnNwZWNpZmllZCBlcnJvciIgaWYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudAoJCS8vIGlzIHVuZGVmaW5lZCB3aGVuIHdlIGFyZSBpbiBhbiBJRnJhbWUuCgkJdHJ5IHsKCQkJaWYgKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ2JvZHknICkgewoJCQkJJCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCApLmJsdXIoKTsKCQkJfSBlbHNlIHsKCQkJCSQoICJpbnB1dDpmb2N1cywgdGV4dGFyZWE6Zm9jdXMsIHNlbGVjdDpmb2N1cyIgKS5ibHVyKCk7CgkJCX0KCQl9IGNhdGNoKCBlICkge30KCgkJLy8gUmVjb3JkIHdoZXRoZXIgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB3aGVyZSBhIGRpYWxvZyB1c2VkIHRvIGJlIC0gaWYgc28sIGRvIG5vdCBhZGQgYSBuZXcgaGlzdG9yeSBlbnRyeSBhbmQgZG8gbm90IGNoYW5nZSB0aGUgaGFzaCBlaXRoZXIKCQl2YXIgYWxyZWFkeVRoZXJlID0gZmFsc2U7CgoJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCS8vIHRvIGFwcGVuZCB0aGUgZGlhbG9nSGFzaEtleSB0byB0aGUgdXJsIG9mIHRoZSBjdXJyZW50IHBhZ2UuCgkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlIHNob3VsZAoJCQkvLyBiZSBhbiBlbXB0eSBzdHJpbmcuIE1vdmluZyB0aGUgdW5kZWZpbmVkIC0+IGVtcHR5IHN0cmluZyBiYWNrIGludG8KCQkJLy8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyIHJlcHJlc2VudHMKCQkJLy8gdGhlIHVybCBzdGF0ZQoKCQkJLy8gSWYgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB0aGF0IG9uY2UgYmVsb25nZWQgdG8gYSBkaWFsb2csIHJldXNlCgkJCS8vIHRoaXMgc3RhdGUgd2l0aG91dCBhZGRpbmcgdG8gdXJsSGlzdG9yeSBhbmQgd2l0aG91dCBtb2RpZnlpbmcgdGhlIGhhc2guCgkJCS8vIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZCB3ZSdyZQoJCQkvLyBhYm91dCB0byBkaXNwbGF5IGFub3RoZXIgZGlhbG9nLCB0aGVuIHdlIG11c3QgYWRkIGFub3RoZXIgaGFzaCBhbmQKCQkJLy8gaGlzdG9yeSBlbnRyeSBvbiB0b3Agc28gdGhhdCBvbmUgbWF5IG5hdmlnYXRlIGJhY2sgdG8gdGhlIG9yaWdpbmFsIGRpYWxvZwoJCQlpZiAoIGFjdGl2ZS51cmwgJiYKCQkJCWFjdGl2ZS51cmwuaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYKCQkJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYKCQkJCSEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSAmJgoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQlhbHJlYWR5VGhlcmUgPSB0cnVlOwoJCQl9CgoJCQkvLyBOb3JtYWxseSwgd2UgdGFjayBvbiBhIGRpYWxvZyBoYXNoIGtleSwgYnV0IGlmIHRoaXMgaXMgdGhlIGxvY2F0aW9uIG9mIGEgc3RhbGUgZGlhbG9nLAoJCQkvLyB3ZSByZXVzZSB0aGUgVVJMIGZyb20gdGhlIGVudHJ5CgkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApOwoKCQkJLy8gYWNjb3VudCBmb3IgYWJzb2x1dGUgdXJscyBpbnN0ZWFkIG9mIGp1c3QgcmVsYXRpdmUgdXJscyB1c2UgYXMgaGFzaGVzCgkJCWlmKCAhYWxyZWFkeVRoZXJlICYmIHVybC5pbmRleE9mKCIjIikgPiAtMSApIHsKCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQl9IGVsc2UgewoJCQkJdXJsICs9ICIjIiArIGRpYWxvZ0hhc2hLZXk7CgkJCX0KCgkJCS8vIHRhY2sgb24gYW5vdGhlciBkaWFsb2dIYXNoS2V5IGlmIHRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIGluaXRpYWwgaGFzaAoJCQkvLyB0aGlzIG1ha2VzIHN1cmUgdGhhdCBhIGhpc3RvcnkgZW50cnkgaXMgY3JlYXRlZCBmb3IgdGhpcyBkaWFsb2cKCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJdXJsICs9IGRpYWxvZ0hhc2hLZXk7CgkJCX0KCQl9CgoJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QgdXNlIHBhZ2VUaXRsZQoJCXZhciBuZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKT8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fCB0b1BhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maW5kKCAiLnVpLXRpdGxlIiApLnRleHQoKTsKCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCXBhZ2VUaXRsZSA9IG5ld1BhZ2VUaXRsZTsKCQl9CgkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIsIHBhZ2VUaXRsZSApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJc2V0dGluZ3MudHJhbnNpdGlvbiA9IHNldHRpbmdzLnRyYW5zaXRpb24gfHwKCQkJKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkgfHwKCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCS8vYWRkIHBhZ2UgdG8gaGlzdG9yeSBzdGFjayBpZiBpdCdzIG5vdCBiYWNrIG9yIGZvcndhcmQKCQlpZiAoICFoaXN0b3J5RGlyICYmIGFscmVhZHlUaGVyZSApIHsKCQkJdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS5wYWdlVXJsID0gcGFnZVVybDsKCQl9CgoJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQlpZiAoIHVybCAmJiAhc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCXZhciBwYXJhbXM7CgoJCQkvLyByZWJ1aWxkaW5nIHRoZSBoYXNoIGhlcmUgc2luY2Ugd2UgbG9vc2UgaXQgZWFybGllciBvbgoJCQkvLyBUT0RPIHByZXNlcnZlIHRoZSBvcmlnaW5hbGx5IHBhc3NlZCBpbiBwYXRoCgkJCWlmKCAhcGF0aC5pc1BhdGgoIHVybCApICYmIHVybC5pbmRleE9mKCAiIyIgKSA8IDAgKSB7CgkJCQl1cmwgPSAiIyIgKyB1cmw7CgkJCX0KCgkJCS8vIFRPRE8gdGhlIHByb3BlcnR5IG5hbWVzIGhlcmUgYXJlIGp1c3Qgc2lsbHkKCQkJcGFyYW1zID0gewoJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCXRpdGxlOiBwYWdlVGl0bGUsCgkJCQlwYWdlVXJsOiBwYWdlVXJsLAoJCQkJcm9sZTogc2V0dGluZ3Mucm9sZQoJCQl9OwoKCQkJaWYgKCBzZXR0aW5ncy5jaGFuZ2VIYXNoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHBhcmFtcywgdHJ1ZSk7CgkJCX0gZWxzZSBpZiAoIHRvUGFnZVsgMCBdICE9PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCB1cmwsIHBhcmFtcyApOwoJCQl9CgkJfQoKCQkvL3NldCBwYWdlIHRpdGxlCgkJZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7CgoJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UKCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBzZXR0aW5ncy5yZXZlcnNlICkKCQkJLmRvbmUoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gU2VuZCBmb2N1cyB0byB0aGUgbmV3bHkgc2hvd24gcGFnZS4gTW92ZWQgZnJvbSBwcm9taXNlIC5kb25lIGJpbmRpbmcgaW4gdHJhbnNpdGlvblBhZ2VzCgkJCQkvLyBpdHNlbGYgdG8gYXZvaWQgaWUgYnVnIHRoYXQgcmVwb3J0cyBvZmZzZXRXaWR0aCBhcyA+IDAgKGNvcmUgY2hlY2sgZm9yIHZpc2liaWxpdHkpCgkJCQkvLyBkZXNwaXRlIHZpc2liaWxpdHk6IGhpZGRlbiBhZGRyZXNzZXMgaXNzdWUgIzI5NjUKCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMjk2NQoJCQkJaWYgKCAhYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0b1BhZ2UgKTsKCQkJCX0KCgkJCQlyZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQl9KTsKCX07CgoJJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cyA9IHsKCQl0cmFuc2l0aW9uOiB1bmRlZmluZWQsCgkJcmV2ZXJzZTogZmFsc2UsCgkJY2hhbmdlSGFzaDogdHJ1ZSwKCQlmcm9tSGFzaENoYW5nZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJZHVwbGljYXRlQ2FjaGVkUGFnZTogdW5kZWZpbmVkLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlzaG93TG9hZE1zZzogdHJ1ZSwgLy9sb2FkaW5nIG1lc3NhZ2Ugc2hvd3MgYnkgZGVmYXVsdCB3aGVuIHBhZ2VzIGFyZSBiZWluZyBmZXRjaGVkIGR1cmluZyBjaGFuZ2VQYWdlCgkJZGF0YVVybDogdW5kZWZpbmVkLAoJCWZyb21QYWdlOiB1bmRlZmluZWQsCgkJYWxsb3dTYW1lUGFnZVRyYW5zaXRpb246IGZhbHNlCgl9OwoKLyogRXZlbnQgQmluZGluZ3MgLSBoYXNoY2hhbmdlLCBzdWJtaXQsIGFuZCBjbGljayAqLwoJZnVuY3Rpb24gZmluZENsb3Nlc3RMaW5rKCBlbGUgKQoJewoJCXdoaWxlICggZWxlICkgewoJCQkvLyBMb29rIGZvciB0aGUgY2xvc2VzdCBlbGVtZW50IHdpdGggYSBub2RlTmFtZSBvZiAiYSIuCgkJCS8vIE5vdGUgdGhhdCB3ZSBhcmUgY2hlY2tpbmcgaWYgd2UgaGF2ZSBhIHZhbGlkIG5vZGVOYW1lCgkJCS8vIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGFjY2VzcyBpdC4gVGhpcyBpcyBiZWNhdXNlIHRoZQoJCQkvLyBub2RlIHdlIGdldCBjYWxsZWQgd2l0aCBjb3VsZCBoYXZlIG9yaWdpbmF0ZWQgZnJvbSB3aXRoaW4KCQkJLy8gYW4gZW1iZWRkZWQgU1ZHIGRvY3VtZW50IHdoZXJlIHNvbWUgc3ltYm9sIGluc3RhbmNlIGVsZW1lbnRzCgkJCS8vIGRvbid0IGhhdmUgbm9kZU5hbWUgZGVmaW5lZCBvbiB0aGVtLCBvciBzdHJpbmdzIGFyZSBvZiB0eXBlCgkJCS8vIFNWR0FuaW1hdGVkU3RyaW5nLgoJCQlpZiAoICggdHlwZW9mIGVsZS5ub2RlTmFtZSA9PT0gInN0cmluZyIgKSAmJiBlbGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImEiICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBlbGU7Cgl9CgoJLy8gVGhlIGJhc2UgVVJMIGZvciBhbnkgZ2l2ZW4gZWxlbWVudCBkZXBlbmRzIG9uIHRoZSBwYWdlIGl0IHJlc2lkZXMgaW4uCglmdW5jdGlvbiBnZXRDbG9zZXN0QmFzZVVybCggZWxlICkKCXsKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhZ2UgYW5kIGV4dHJhY3Qgb3V0IGl0cyB1cmwuCgkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQliYXNlID0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCWlmICggIXVybCB8fCAhcGF0aC5pc1BhdGgoIHVybCApICkgewoJCQl1cmwgPSBiYXNlOwoJCX0KCgkJcmV0dXJuIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UpOwoJfQoKCS8vVGhlIGZvbGxvd2luZyBldmVudCBiaW5kaW5ncyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vdGhlIGZvbGxvd2luZyBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgPSBmdW5jdGlvbigpIHsKCQl2YXIgZ2V0QWpheEZvcm1EYXRhID0gZnVuY3Rpb24oICRmb3JtLCBjYWxjdWxhdGVPbmx5ICkgewoJCQl2YXIgdXJsLCByZXQgPSB0cnVlLCBmb3JtRGF0YSwgdmNsaWNrZWROYW1lLCBtZXRob2Q7CgkJCQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCB8fAoJCQkJCS8vIHRlc3QgdGhhdCB0aGUgZm9ybSBpcywgaXRzZWxmLCBhamF4IGZhbHNlCgkJCQkJJGZvcm0uaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8CgkJCQkJLy8gdGVzdCB0aGF0ICQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCBhbmQKCQkJCQkvLyB0aGUgZm9ybSBvciBvbmUgb2YgaXQncyBwYXJlbnRzIGlzIGFqYXg9ZmFsc2UKCQkJCQkhJGZvcm0uanFtSGlqYWNrYWJsZSgpLmxlbmd0aCB8fAoJCQkJCSRmb3JtLmF0dHIoICJ0YXJnZXQiICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXVybCA9ICRmb3JtLmF0dHIoICJhY3Rpb24iICk7CgkJCW1ldGhvZCA9ICggJGZvcm0uYXR0ciggIm1ldGhvZCIgKSB8fCAiZ2V0IiApLnRvTG93ZXJDYXNlKCk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApOwoKCQkJCS8vIE5PVEU6IElmIHRoZSBtZXRob2QgaXMgImdldCIsIHdlIG5lZWQgdG8gc3RyaXAgb2ZmIHRoZSBxdWVyeSBzdHJpbmcKCQkJCS8vIGJlY2F1c2UgaXQgd2lsbCBnZXQgcmVwbGFjZWQgd2l0aCB0aGUgbmV3IGZvcm0gZGF0YS4gU2VlIGlzc3VlICM1NzEwLgoJCQkJaWYgKCBtZXRob2QgPT09ICJnZXQiICkgewoJCQkJCXVybCA9IHBhdGgucGFyc2VVcmwoIHVybCApLmhyZWZOb1NlYXJjaDsKCQkJCX0KCgkJCQlpZiAoIHVybCA9PT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsIGdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApICk7CgoJCQlpZiAoICggcGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIHVybCApICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmICggIWNhbGN1bGF0ZU9ubHkgKSB7CgkJCQlmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZUFycmF5KCk7CgoJCQkJaWYgKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWRbIDAgXS5mb3JtID09PSAkZm9ybVsgMCBdICkgewoJCQkJCXZjbGlja2VkTmFtZSA9ICRsYXN0VkNsaWNrZWQuYXR0ciggIm5hbWUiICk7CgkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCS8vIE1ha2Ugc3VyZSB0aGUgbGFzdCBjbGlja2VkIGVsZW1lbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGZvcm0KCQkJCQkJJC5lYWNoKCBmb3JtRGF0YSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkJCQlpZiAoIHZhbHVlLm5hbWUgPT09IHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCQkvLyBVbnNldCB2Y2xpY2tlZE5hbWUgLSB3ZSd2ZSBmb3VuZCBpdCBpbiB0aGUgc2VyaWFsaXplZCBkYXRhIGFscmVhZHkKCQkJCQkJCQl2Y2xpY2tlZE5hbWUgPSAiIjsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCWZvcm1EYXRhLnB1c2goIHsgbmFtZTogdmNsaWNrZWROYW1lLCB2YWx1ZTogJGxhc3RWQ2xpY2tlZC5hdHRyKCAidmFsdWUiICkgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldCA9IHsKCQkJCQl1cmw6IHVybCwKCQkJCQlvcHRpb25zOiB7CgkJCQkJCXR5cGU6CQltZXRob2QsCgkJCQkJCWRhdGE6CQkkLnBhcmFtKCBmb3JtRGF0YSApLAoJCQkJCQl0cmFuc2l0aW9uOgkkZm9ybS5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQkJcmV2ZXJzZToJJGZvcm0uanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiLAoJCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZvcm1EYXRhID0gZ2V0QWpheEZvcm1EYXRhKCAkKCB0aGlzICkgKTsKCgkJCWlmICggZm9ybURhdGEgKSB7CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBmb3JtRGF0YS51cmwsIGZvcm1EYXRhLm9wdGlvbnMgKTsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkYnRuLCBidG5FbHMsIHRhcmdldCA9IGV2ZW50LnRhcmdldCwgbmVlZENsb3Nlc3QgPSBmYWxzZTsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVjb3JkIHRoYXQgdGhpcyBlbGVtZW50IHdhcyBjbGlja2VkLCBpbiBjYXNlIHdlIG5lZWQgaXQgZm9yIGNvcnJlY3QKCQkJLy8gZm9ybSBzdWJtaXNzaW9uIGR1cmluZyB0aGUgInN1Ym1pdCIgaGFuZGxlciBhYm92ZQoJCQkkbGFzdFZDbGlja2VkID0gJCggdGFyZ2V0ICk7CgoJCQkvLyBUcnkgdG8gZmluZCBhIHRhcmdldCBlbGVtZW50IHRvIHdoaWNoIHRoZSBhY3RpdmUgY2xhc3Mgd2lsbCBiZSBhcHBsaWVkCgkJCWlmICggJC5kYXRhKCB0YXJnZXQsICJtb2JpbGUtYnV0dG9uIiApICkgewoJCQkJLy8gSWYgdGhlIGZvcm0gd2lsbCBub3QgYmUgc3VibWl0dGVkIHZpYSBBSkFYLCBkbyBub3QgYWRkIGFjdGl2ZSBjbGFzcwoJCQkJaWYgKCAhZ2V0QWpheEZvcm1EYXRhKCAkKCB0YXJnZXQgKS5jbG9zZXN0KCAiZm9ybSIgKSwgdHJ1ZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vIFdlIHdpbGwgYXBwbHkgdGhlIGFjdGl2ZSBzdGF0ZSB0byB0aGlzIGJ1dHRvbiB3aWRnZXQgLSB0aGUgcGFyZW50CgkJCQkvLyBvZiB0aGUgaW5wdXQgdGhhdCB3YXMgY2xpY2tlZCB3aWxsIGhhdmUgdGhlIGFzc29jaWF0ZWQgZGF0YQoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRhcmdldCA9IGZpbmRDbG9zZXN0TGluayggdGFyZ2V0ICk7CgkJCQlpZiAoICEoIHRhcmdldCAmJiBwYXRoLnBhcnNlVXJsKCB0YXJnZXQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUKCQkJCS8vIGxpbmsgd3JhcHBpbmcgY2FuIGJlIGF2b2lkZWQKCQkJCWlmICggISQoIHRhcmdldCApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBBdm9pZCBjYWxsaW5nIC5jbG9zZXN0IGJ5IHVzaW5nIHRoZSBkYXRhIHNldCBkdXJpbmcgLmJ1dHRvbk1hcmt1cCgpCgkJCS8vIExpc3QgaXRlbXMgaGF2ZSB0aGUgYnV0dG9uIGRhdGEgaW4gdGhlIHBhcmVudCBvZiB0aGUgZWxlbWVudCBjbGlja2VkCgkJCWlmICggISF+dGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCAidWktbGluay1pbmhlcml0IiApICkgewoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldC5wYXJlbnROb2RlLCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCQl9CgkJCS8vIE90aGVyd2lzZSwgbG9vayBmb3IgdGhlIGRhdGEgb24gdGhlIHRhcmdldCBpdHNlbGYKCQkJfSBlbHNlIHsKCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCX0KCQkJLy8gSWYgZm91bmQsIGdyYWIgdGhlIGJ1dHRvbidzIG91dGVyIGVsZW1lbnQKCQkJaWYgKCBidG5FbHMgKSB7CgkJCQl0YXJnZXQgPSBidG5FbHMub3V0ZXI7CgkJCX0gZWxzZSB7CgkJCQluZWVkQ2xvc2VzdCA9IHRydWU7CgkJCX0KCgkJCSRidG4gPSAkKCB0YXJnZXQgKTsKCQkJLy8gSWYgdGhlIG91dGVyIGVsZW1lbnQgd2Fzbid0IGZvdW5kIGJ5IHRoZSBvdXIgaGV1cmlzdGljcywgdXNlIC5jbG9zZXN0KCkKCQkJaWYgKCBuZWVkQ2xvc2VzdCApIHsKCQkJCSRidG4gPSAkYnRuLmNsb3Nlc3QoICIudWktYnRuIiApOwoJCQl9CgoJCQlpZiAoICRidG4ubGVuZ3RoID4gMCAmJiAhJGJ0bi5oYXNDbGFzcyggInVpLWRpc2FibGVkIiApICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSAkYnRuOwoJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIGNsaWNrIHJvdXRpbmcgLSBkaXJlY3QgdG8gSFRUUCBvciBBamF4LCBhY2NvcmRpbmdseQoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkIHx8IGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICksICRsaW5rID0gJCggbGluayApLCBodHRwQ2xlYW51cDsKCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCX07CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBiYXNlVXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICksCgoJCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gWFhYX2pibGFzOiBJZGVhbGx5IGxpbmtzIHRvIGFwcGxpY2F0aW9uIHBhZ2VzIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMKCQkJLy8gICAgICAgICAgICBhbiB1cmwgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggYSBoYXNoIHRoYXQgaXMgZWl0aGVyCgkJCS8vICAgICAgICAgICAgdGhlIHNpdGUgcmVsYXRpdmUgcGF0aCBvciBpZCB0byB0aGUgcGFnZS4gQnV0IHNvbWUgb2YgdGhlCgkJCS8vICAgICAgICAgICAgaW50ZXJuYWwgY29kZSB0aGF0IGR5bmFtaWNhbGx5IGdlbmVyYXRlcyBzdWItcGFnZXMgZm9yIG5lc3RlZAoJCQkvLyAgICAgICAgICAgIGxpc3RzIGFuZCBzZWxlY3QgZGlhbG9ncywganVzdCB3cml0ZSBhIGhhc2ggaW4gdGhlIGxpbmsgdGhleQoJCQkvLyAgICAgICAgICAgIGNyZWF0ZS4gVGhpcyBtZWFucyB0aGUgYWN0dWFsIFVSTCBwYXRoIGlzIGJhc2VkIG9uIHdoYXRldmVyCgkJCS8vICAgICAgICAgICAgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJhc2UgdGFnIGlzIGF0IHRoZSB0aW1lIHRoaXMgY29kZQoJCQkvLyAgICAgICAgICAgIGlzIGNhbGxlZC4gRm9yIG5vdyB3ZSBhcmUganVzdCBhc3N1bWluZyB0aGF0IGFueSB1cmwgd2l0aCBhCgkJCS8vICAgICAgICAgICAgaGFzaCBpbiBpdCBpcyBhbiBhcHBsaWNhdGlvbiBwYWdlIHJlZmVyZW5jZS4KCQkJaWYgKCBocmVmLnNlYXJjaCggIiMiICkgIT09IC0xICkgewoJCQkJaHJlZiA9IGhyZWYucmVwbGFjZSggL1teI10qIy8sICIiICk7CgkJCQlpZiAoICFocmVmICkgewoJCQkJCS8vbGluayB3YXMgYW4gZW1wdHkgaGFzaCBtZWFudCBwdXJlbHkKCQkJCQkvL2ZvciBpbnRlcmFjdGlvbiwgc28gd2UgaWdub3JlIGl0LgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgoIGhyZWYgKSApIHsKCQkJCQkvL3dlIGhhdmUgYXBhdGggc28gbWFrZSBpdCB0aGUgaHJlZiB3ZSB3YW50IHRvIGxvYWQuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBiYXNlVXJsICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vd2UgaGF2ZSBhIHNpbXBsZSBpZCBzbyB1c2UgdGhlIGRvY3VtZW50VXJsIGFzIGl0cyBiYXNlLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgaHJlZiwgZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCApOwoJCQkJfQoJCQl9CgoJCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXZhciB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICksCgoJCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCQkvL2NoZWNrIGZvciBwcm90b2NvbCBvciByZWwgYW5kIGl0cyBub3QgYW4gZW1iZWRkZWQgcGFnZQoJCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJCWlzRXh0ZXJuYWwgPSB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgfHwgKCBwYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIGhyZWYgKSApOwoKCQkJaWYgKCBpc0V4dGVybmFsICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy91c2UgYWpheAoJCQl2YXIgdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJcmV2ZXJzZSA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiB8fAoJCQkJCQkJLy8gZGVwcmVjYXRlZCAtIHJlbW92ZSBieSAxLjAKCQkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApLAoKCQkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCQlyb2xlID0gJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB8fCB1bmRlZmluZWQ7CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBocmVmLCB7IHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHJldmVyc2U6IHJldmVyc2UsIHJvbGU6IHJvbGUsIGxpbms6ICRsaW5rIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiLnVpLXBhZ2UiLCAicGFnZXNob3cucHJlZmV0Y2giLCBmdW5jdGlvbigpIHsKCQkJdmFyIHVybHMgPSBbXTsKCQkJJCggdGhpcyApLmZpbmQoICJhOmpxbURhdGEocHJlZmV0Y2gpIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGxpbmsgPSAkKCB0aGlzICksCgkJCQkJdXJsID0gJGxpbmsuYXR0ciggImhyZWYiICk7CgoJCQkJaWYgKCB1cmwgJiYgJC5pbkFycmF5KCB1cmwsIHVybHMgKSA9PT0gLTEgKSB7CgkJCQkJdXJscy5wdXNoKCB1cmwgKTsKCgkJCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHVybCwgeyByb2xlOiAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApLHByZWZldGNoOiB0cnVlIH0gKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlID0gZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJLy9maW5kIGZpcnN0IHBhZ2UgdmlhIGhhc2gKCQkJdmFyIHRvID0gcGF0aC5zdHJpcEhhc2godXJsKSwKCQkJCS8vdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQgb3RoZXJ3aXNlIChhbmQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgZGVmYXVsdCkKCQkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS51cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMCA/ICJub25lIiA6IHVuZGVmaW5lZCwKCgkJCQkvLyBkZWZhdWx0IG9wdGlvbnMgZm9yIHRoZSBjaGFuZ1BhZ2UgY2FsbHMgbWFkZSBhZnRlciBleGFtaW5pbmcgdGhlIGN1cnJlbnQgc3RhdGUKCQkJCS8vIG9mIHRoZSBwYWdlIGFuZCB0aGUgaGFzaCwgTk9URSB0aGF0IHRoZSB0cmFuc2l0aW9uIGlzIGRlcml2ZWQgZnJvbSB0aGUgcHJldmlvdXMKCQkJCS8vIGhpc3RvcnkgZW50cnkKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX07CgoJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEsIHsKCQkJCXRyYW5zaXRpb246ICh1cmxIaXN0b3J5LmdldExhc3QoKSB8fCB7fSkudHJhbnNpdGlvbiB8fCB0cmFuc2l0aW9uCgkJCX0pOwoKCQkJLy8gc3BlY2lhbCBjYXNlIGZvciBkaWFsb2dzCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgJiYgdG8uaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYgdXJsSGlzdG9yeS5pbml0aWFsRHN0ICE9PSB0byApIHsKCgkJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiAhJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkgKSB7CgkJCQkJLy9kZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZSBhY2NvcmRpbmdseSBwYXN0CgkJCQkJLy90aGUgY3VycmVudCBkaWFsb2cKCQkJCQlpZiggZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIiApIHsKCQkJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXdpbmRvdy5oaXN0b3J5LmZvcndhcmQoKTsKCQkJCQl9CgoJCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJCS8vIHRvIGEgZGlhbG9nIHVzZSB0aGUgZGlhbG9nIG9iamVjdGVkIHNhdmVkIGluIHRoZSBzdGFjawoJCQkJCXRvID0gZGF0YS5wYWdlVXJsOwoJCQkJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJCS8vIGFzIG1vc3Qgb2YgdGhpcyBpcyBsb3N0IGJ5IHRoZSBkb21DYWNoZSBjbGVhbmluZwoJCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQkJdHJhbnNpdGlvbjogYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCQl9KTsKCQkJCX0KCQkJfQoKCQkJLy9pZiB0byBpcyBkZWZpbmVkLCBsb2FkIGl0CgkJCWlmICggdG8gKSB7CgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UgZWxlbWVudCBmcm9tCgkJCQkvLyBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlL2Fic29sdXRlIFVSTC4gSWYgJ3RvJyBpcwoJCQkJLy8gYW4gaWQsIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBhZ2FpbnN0IHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwKCQkJCS8vIHNpbmNlIHRoZSBoYXNoY2hhbmdlIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwgcGFnZS9kaWFsb2cuCgkJCQl0byA9ICFwYXRoLmlzUGF0aCggdG8gKSA/ICggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHRvLCBkb2N1bWVudEJhc2UgKSApIDogdG87CgoJCQkJLy8gSWYgd2UncmUgYWJvdXQgdG8gZ28gdG8gYW4gaW5pdGlhbCBVUkwgdGhhdCBjb250YWlucyBhIHJlZmVyZW5jZSB0byBhIG5vbi1leGlzdGVudAoJCQkJLy8gaW50ZXJuYWwgcGFnZSwgZ28gdG8gdGhlIGZpcnN0IHBhZ2UgaW5zdGVhZC4gV2Uga25vdyB0aGF0IHRoZSBpbml0aWFsIGhhc2ggcmVmZXJzIHRvIGEKCQkJCS8vIG5vbi1leGlzdGVudCBwYWdlLCBiZWNhdXNlIHRoZSBpbml0aWFsIGhhc2ggZGlkIG5vdCBlbmQgdXAgaW4gdGhlIGluaXRpYWwgdXJsSGlzdG9yeSBlbnRyeQoJCQkJaWYgKCB0byA9PT0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHVybEhpc3RvcnkuaW5pdGlhbERzdCwgZG9jdW1lbnRCYXNlICkgJiYKCQkJCQl1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCAmJiB1cmxIaXN0b3J5LnN0YWNrWzBdLnVybCAhPT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0LnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKSB7CgkJCQkJdG8gPSAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggdG8sIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0JZWxzZSB7CgoJCQkJLy90aGVyZSdzIG5vIGhhc2gsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBkb20KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQoJCX07CgoJCS8vIFRPRE8gcm9sbCB0aGUgbG9naWMgaGVyZSBpbnRvIHRoZSBoYW5kbGVIYXNoQ2hhbmdlIG1ldGhvZAoJCSR3aW5kb3cuYmluZCggIm5hdmlnYXRlIiwgZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciB1cmw7CgoJCQlpZiAoIGUub3JpZ2luYWxFdmVudCAmJiBlLm9yaWdpbmFsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXVybCA9ICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50TmFtZS5pbmRleE9mKCAiaGFzaGNoYW5nZSIgKSA+IC0xID8gZGF0YS5zdGF0ZS5oYXNoIDogZGF0YS5zdGF0ZS51cmw7CgoJCQlpZiggIXVybCApIHsKCQkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCX0KCgkJCWlmKCAhdXJsIHx8IHVybCA9PT0gIiMiIHx8IHVybC5pbmRleE9mKCAiIyIgKyAkLm1vYmlsZS5wYXRoLnVpU3RhdGVLZXkgKSA9PT0gMCApewoJCQkJdXJsID0gbG9jYXRpb24uaHJlZjsKCQkJfQoKCQkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UoIHVybCwgZGF0YS5zdGF0ZSApOwoJCX0pOwoKCQkvL3NldCBwYWdlIG1pbi1oZWlnaHRzIHRvIGJlIGRldmljZSBzcGVjaWZpYwoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlc2hvdyIsICQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQubW9iaWxlLndpbmRvdy5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfTsvL25hdnJlYWR5RGVmZXJyZWQgZG9uZSBjYWxsYmFjawoKCSQoIGZ1bmN0aW9uKCkgeyBkb21yZWFkeURlZmVycmVkLnJlc29sdmUoKTsgfSApOwoKCSQud2hlbiggZG9tcmVhZHlEZWZlcnJlZCwgJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCApLmRvbmUoIGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cygpOyB9ICk7Cn0pKCBqUXVlcnkgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxpcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxpcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHBvcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MucG9wID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbnMgaGFuZGxlciBmb3Igc2xpZGUgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNsaWRlID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNpbXVsdGFuZW91czsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWRvd24gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZG93biA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWZhZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVmYWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRldXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRldXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgdHVybiBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MudHVybiA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5kZWdyYWRlSW5wdXRzID0gewoJY29sb3I6IGZhbHNlLAoJZGF0ZTogZmFsc2UsCglkYXRldGltZTogZmFsc2UsCgkiZGF0ZXRpbWUtbG9jYWwiOiBmYWxzZSwKCWVtYWlsOiBmYWxzZSwKCW1vbnRoOiBmYWxzZSwKCW51bWJlcjogZmFsc2UsCglyYW5nZTogIm51bWJlciIsCglzZWFyY2g6ICJ0ZXh0IiwKCXRlbDogZmFsc2UsCgl0aW1lOiBmYWxzZSwKCXVybDogZmFsc2UsCgl3ZWVrOiBmYWxzZQp9OwoKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgl2YXIgcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJCggZS50YXJnZXQgKSApLCBvcHRpb25zOwoKCWlmICggIXBhZ2UgKSB7CgkJcmV0dXJuOwoJfQoKCW9wdGlvbnMgPSBwYWdlLm9wdGlvbnM7CgoJLy8gZGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5CgkkKCBlLnRhcmdldCApLmZpbmQoICJpbnB1dCIgKS5ub3QoIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJdHlwZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwKCQkJb3B0VHlwZSA9IG9wdGlvbnMuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IjsKCgkJaWYgKCBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJdmFyIGh0bWwgPSAkKCAiPGRpdj4iICkuaHRtbCggJHRoaXMuY2xvbmUoKSApLmh0bWwoKSwKCQkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQkJaGFzVHlwZSA9IGh0bWwuaW5kZXhPZiggIiB0eXBlPSIgKSA+IC0xLAoJCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LywKCQkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJJHRoaXMucmVwbGFjZVdpdGgoIGh0bWwucmVwbGFjZSggZmluZHN0ciwgcmVwc3RyICkgKTsKCQl9Cgl9KTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWNsb3NlQnRuOiAibGVmdCIsCgkJY2xvc2VCdG5UZXh0OiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWNvcm5lcnM6IHRydWUsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nZGlhbG9nJykiCgl9LAoKCS8vIE92ZXJyaWRlIHRoZSB0aGVtZSBzZXQgYnkgdGhlIHBhZ2UgcGx1Z2luIG9uIHBhZ2VzaG93CglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gdHJ1ZTsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkucGFnZSggInNldENvbnRhaW5lckJhY2tncm91bmQiLCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJY29ybmVyQ2xhc3MgPSAhIXRoaXMub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiLAoJCQlkaWFsb2dXcmFwID0gJCggIjxkaXYvPiIsIHsKCQkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArIGNvcm5lckNsYXNzCgkJCQl9KTsKCgkJJGVsLmFkZENsYXNzKCAidWktZGlhbG9nIHVpLW92ZXJsYXktIiArIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCgkJLy8gQ2xhc3MgdGhlIG1hcmt1cCBmb3IgZGlhbG9nIHN0eWxpbmcKCQkvLyBTZXQgYXJpYSByb2xlCgkJJGVsLndyYXBJbm5lciggZGlhbG9nV3JhcCApOwoKCQkvKiBiaW5kIGV2ZW50cwoJCQktIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nIG9wZW5lZCB3aXRoCgkJCQl1bmxlc3MgYSBkYXRhLXRyYW5zaXRpb24gaXMgc3BlY2lmaWVkIG9uIHRoZSBsaW5rL2Zvcm0KCQkJLSBpZiB0aGUgY2xpY2sgd2FzIG9uIHRoZSBjbG9zZSBidXR0b24sIG9yIHRoZSBsaW5rIGhhcyBhIGRhdGEtcmVsPSJiYWNrIiBpdCdsbCBnbyBiYWNrIGluIGhpc3RvcnkgbmF0dXJhbGx5CgkJKi8KCQkkZWwuYmluZCggInZjbGljayBzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggZXZlbnQudHlwZSA9PT0gInZjbGljayIgPyAiYSIgOiAiZm9ybSIgKSwKCQkJCWFjdGl2ZTsKCgkJCWlmICggJHRhcmdldC5sZW5ndGggJiYgISR0YXJnZXQuanFtRGF0YSggInRyYW5zaXRpb24iICkgKSB7CgoJCQkJYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKSB8fCB7fTsKCgkJCQkkdGFyZ2V0LmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0cmFuc2l0aW9uIiwgKCBhY3RpdmUudHJhbnNpdGlvbiB8fCAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiApICkKCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImRpcmVjdGlvbiIsICJyZXZlcnNlIiApOwoJCQl9CgkJfSk7CgoJCXRoaXMuX29uKCAkZWwsIHsKCQkJcGFnZWJlZm9yZXNob3c6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciCgkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jcmVhdGVDb21wbGV0ZTogZmFsc2UKCQl9KTsKCgkJdGhpcy5fc2V0Q2xvc2VCdG4oIHRoaXMub3B0aW9ucy5jbG9zZUJ0biApOwoJfSwKCglfc2V0Q2xvc2VCdG46IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgc2VsZiA9IHRoaXMsIGJ0biwgbG9jYXRpb247CgoJCWlmICggdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gKSB7CgkJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uLnJlbW92ZSgpOwoJCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbiA9IG51bGw7CgkJfQoJCWlmICggdmFsdWUgIT09ICJub25lIiApIHsKCQkJLy8gU2FuaXRpemUgdmFsdWUKCQkJbG9jYXRpb24gPSAoIHZhbHVlID09PSAibGVmdCIgPyAibGVmdCIgOiAicmlnaHQiICk7CgkJCWJ0biA9ICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktYnRuLSIgKyBsb2NhdGlvbiArICInIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb249J2RlbGV0ZScgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcz0nbm90ZXh0Jz4iKyB0aGlzLm9wdGlvbnMuY2xvc2VCdG5UZXh0ICsgIjwvYT4iICk7CgkJCXRoaXMuZWxlbWVudC5jaGlsZHJlbigpLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maXJzdCgpLnByZXBlbmQoIGJ0biApOwoJCQlpZiAoIHRoaXMuX2NyZWF0ZUNvbXBsZXRlICYmICQuZm4uYnV0dG9uTWFya3VwICkgewoJCQkJYnRuLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgkJCXRoaXMuX2NyZWF0ZUNvbXBsZXRlID0gdHJ1ZTsKCgkJCS8vIHRoaXMgbXVzdCBiZSBhbiBhbm9ueW1vdXMgZnVuY3Rpb24gc28gdGhhdCBzZWxlY3QgbWVudSBkaWFsb2dzIGNhbiByZXBsYWNlCgkJCS8vIHRoZSBjbG9zZSBtZXRob2QuIFRoaXMgaXMgYSBjaGFuZ2UgZnJvbSBwcmV2aW91c2x5IGp1c3QgZGVmaW5pbmcgZGF0YS1yZWw9YmFjawoJCQkvLyBvbiB0aGUgYnV0dG9uIGFuZCBsZXR0aW5nIG5hdiBoYW5kbGUgaXQKCQkJLy8KCQkJLy8gVXNlIGNsaWNrIHJhdGhlciB0aGFuIHZjbGljayBpbiBvcmRlciB0byBwcmV2ZW50IHRoZSBwb3NzaWJpbGl0eSBvZiB1bmludGVudGlvbmFsbHkKCQkJLy8gcmVvcGVuaW5nIHRoZSBkaWFsb2cgaWYgdGhlIGRpYWxvZyBvcGVuaW5nIGl0ZW0gd2FzIGRpcmVjdGx5IHVuZGVyIHRoZSBjbG9zZSBidXR0b24uCgkJCWJ0bi5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSk7CgoJCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbiA9IGJ0bjsKCQl9Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCWlmICgga2V5ID09PSAiY2xvc2VCdG4iICkgewoJCQl0aGlzLl9zZXRDbG9zZUJ0biggdmFsdWUgKTsKCQl9CgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCX0sCgoJLy8gQ2xvc2UgbWV0aG9kIGdvZXMgYmFjayBpbiBoaXN0b3J5CgljbG9zZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkeCwgZHN0LCBoaXN0ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeTsKCgkJaWYgKCB0aGlzLl9pc0Nsb3NlYWJsZSApIHsKCQkJdGhpcy5faXNDbG9zZWFibGUgPSBmYWxzZTsKCQkJLy8gSWYgdGhlIGhhc2ggbGlzdGVuaW5nIGlzIGVuYWJsZWQgYW5kIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBwcmVjZWRpbmcgaGlzdG9yeQoJCQkvLyBlbnRyeSBpdCdzIG9rIHRvIGdvIGJhY2suIEluaXRpYWwgcGFnZXMgd2l0aCB0aGUgZGlhbG9nIGhhc2ggc3RhdGUgYXJlIGFuIGV4YW1wbGUKCQkJLy8gd2hlcmUgdGhlIHN0YWNrIGNoZWNrIGlzIG5lY2Vzc2FyeQoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmIGhpc3QuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJaWR4ID0gTWF0aC5tYXgoIDAsIGhpc3QuYWN0aXZlSW5kZXggLSAxICk7CgkJCQlkc3QgPSBoaXN0LnN0YWNrWyBpZHggXS5wYWdlVXJsIHx8IGhpc3Quc3RhY2tbIGlkeCBdLnVybDsKCQkJCWhpc3QucHJldmlvdXNJbmRleCA9IGhpc3QuYWN0aXZlSW5kZXg7CgkJCQloaXN0LmFjdGl2ZUluZGV4ID0gaWR4OwoJCQkJaWYgKCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRzdCApICkgewoJCQkJCWRzdCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBkc3QgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBkc3QsIHsgZGlyZWN0aW9uOiAiYmFjayIsIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCQl9Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5lbmhhbmNlKCB0aGlzICk7Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UZXh0ICA9ICJCYWNrIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5hZGRCYWNrQnRuICAgPSBmYWxzZTsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGhlbWUgPSBudWxsOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmhlYWRlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5mb290ZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuY29udGVudFRoZW1lID0gbnVsbDsKCi8vIE5PVEUgYmluZCB1c2VkIHRvIGZvcmNlIHRoaXMgYmluZGluZyB0byBydW4gYmVmb3JlIHRoZSBidXR0b25NYXJrdXAgYmluZGluZwovLyAgICAgIHdoaWNoIGV4cGVjdHMgLnVpLWZvb3RlciB0b3AgYmUgYXBwbGllZCBpbiBpdHMgZ2lnYW50aWMgc2VsZWN0b3IKLy8gVE9ETyByZW1vdmUgdGhlIGJ1dHRvbk1hcmt1cCBnaWFudCBzZWxlY3RvciBhbmQgbW92ZSBpdCB0byB0aGUgdmFyaW91cyBtb2R1bGVzCi8vICAgICAgb24gd2hpY2ggaXQgZGVwZW5kcwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJdmFyICRwYWdlID0gJCggZS50YXJnZXQgKSwKCQlvID0gJHBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMsCgkJcGFnZVJvbGUgPSAkcGFnZS5qcW1EYXRhKCAicm9sZSIgKSwKCQlwYWdlVGhlbWUgPSBvLnRoZW1lOwoKCSQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSwgOmpxbURhdGEocm9sZT0nZm9vdGVyJyksIDpqcW1EYXRhKHJvbGU9J2NvbnRlbnQnKSIsICRwYWdlICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXJvbGUgPSAkdGhpcy5qcW1EYXRhKCAicm9sZSIgKSwKCQkJdGhlbWUgPSAkdGhpcy5qcW1EYXRhKCAidGhlbWUiICksCgkJCWNvbnRlbnRUaGVtZSA9IHRoZW1lIHx8IG8uY29udGVudFRoZW1lIHx8ICggcGFnZVJvbGUgPT09ICJkaWFsb2ciICYmIHBhZ2VUaGVtZSApLAoJCQkkaGVhZGVyYW5jaG9ycywKCQkJbGVmdGJ0biwKCQkJcmlnaHRidG4sCgkJCWJhY2tCdG47CgoJCSR0aGlzLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCgkJLy9hcHBseSB0aGVtaW5nIGFuZCBtYXJrdXAgbW9kaWZpY2F0aW9ucyB0byBwYWdlLGhlYWRlcixjb250ZW50LGZvb3RlcgoJCWlmICggcm9sZSA9PT0gImhlYWRlciIgfHwgcm9sZSA9PT0gImZvb3RlciIgKSB7CgoJCQl2YXIgdGhpc1RoZW1lID0gdGhlbWUgfHwgKCByb2xlID09PSAiaGVhZGVyIiA/IG8uaGVhZGVyVGhlbWUgOiBvLmZvb3RlclRoZW1lICkgfHwgcGFnZVRoZW1lOwoKCQkJJHRoaXMKCQkJCS8vYWRkIHRoZW1lIGNsYXNzCgkJCQkuYWRkQ2xhc3MoICJ1aS1iYXItIiArIHRoaXNUaGVtZSApCgkJCQkvLyBBZGQgQVJJQSByb2xlCgkJCQkuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApOwoKCQkJaWYgKCByb2xlID09PSAiaGVhZGVyIikgewoJCQkJLy8gUmlnaHQsbGVmdCBidXR0b25zCgkJCQkkaGVhZGVyYW5jaG9ycwk9ICR0aGlzLmNoaWxkcmVuKCAiYSwgYnV0dG9uIiApOwoJCQkJbGVmdGJ0bgk9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICk7CgkJCQlyaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJCWxlZnRidG4gPSBsZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJCQlyaWdodGJ0biA9IHJpZ2h0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoJCQl9CgoJCQkvLyBBdXRvLWFkZCBiYWNrIGJ0biBvbiBwYWdlcyBiZXlvbmQgZmlyc3QgdmlldwoJCQlpZiAoIG8uYWRkQmFja0J0biAmJgoJCQkJcm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCSQoICIudWktcGFnZSIgKS5sZW5ndGggPiAxICYmCgkJCQkkcGFnZS5qcW1EYXRhKCAidXJsIiApICE9PSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggbG9jYXRpb24uaGFzaCApICYmCgkJCQkhbGVmdGJ0biApIHsKCgkJCQliYWNrQnRuID0gJCggIjxhIGhyZWY9J2phdmFzY3JpcHQ6dm9pZCgwKTsnIGNsYXNzPSd1aS1idG4tbGVmdCcgZGF0YS0iKyAkLm1vYmlsZS5ucyArInJlbD0nYmFjaycgZGF0YS0iKyAkLm1vYmlsZS5ucyArImljb249J2Fycm93LWwnPiIrIG8uYmFja0J0blRleHQgKyI8L2E+IiApCgkJCQkJLy8gSWYgdGhlbWUgaXMgcHJvdmlkZWQsIG92ZXJyaWRlIGRlZmF1bHQgaW5oZXJpdGFuY2UKCQkJCQkuYXR0ciggImRhdGEtIisgJC5tb2JpbGUubnMgKyJ0aGVtZSIsIG8uYmFja0J0blRoZW1lIHx8IHRoaXNUaGVtZSApCgkJCQkJLnByZXBlbmRUbyggJHRoaXMgKTsKCQkJfQoKCQkJLy8gUGFnZSB0aXRsZQoJCQkkdGhpcy5jaGlsZHJlbiggImgxLCBoMiwgaDMsIGg0LCBoNSwgaDYiICkKCQkJCS5hZGRDbGFzcyggInVpLXRpdGxlIiApCgkJCQkvLyBSZWdhcmRsZXNzIG9mIGggZWxlbWVudCBudW1iZXIgaW4gc3JjLCBpdCBiZWNvbWVzIGgxIGZvciB0aGUgZW5oYW5jZWQgcGFnZQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogImhlYWRpbmciLAoJCQkJCSJhcmlhLWxldmVsIjogIjEiCgkJCQl9KTsKCgkJfSBlbHNlIGlmICggcm9sZSA9PT0gImNvbnRlbnQiICkgewoJCQlpZiAoIGNvbnRlbnRUaGVtZSApIHsKCQkJCSR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBjb250ZW50VGhlbWUgKSApOwoJCQl9CgoJCQkvLyBBZGQgQVJJQSByb2xlCgkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICk7CgkJfQoJfSk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBUaGlzIGZ1bmN0aW9uIGNhbGxzIGdldEF0dHJpYnV0ZSwgd2hpY2ggc2hvdWxkIGJlIHNhZmUgZm9yIGRhdGEtKiBhdHRyaWJ1dGVzCnZhciBnZXRBdHRyRml4ZWQgPSBmdW5jdGlvbiggZSwga2V5ICkgewoJdmFyIHZhbHVlID0gZS5nZXRBdHRyaWJ1dGUoIGtleSApOwoKCXJldHVybiB2YWx1ZSA9PT0gInRydWUiID8gdHJ1ZSA6CgkJdmFsdWUgPT09ICJmYWxzZSIgPyBmYWxzZSA6CgkJdmFsdWUgPT09IG51bGwgPyB1bmRlZmluZWQgOiB2YWx1ZTsKfTsKCiQuZm4uYnV0dG9uTWFya3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7Cgl2YXIgJHdvcmtpbmdTZXQgPSB0aGlzLAoJCW5zS2V5ID0gImRhdGEtIiArICQubW9iaWxlLm5zLAoJCWtleTsKCgkvLyBFbmZvcmNlIG9wdGlvbnMgdG8gYmUgb2YgdHlwZSBzdHJpbmcKCW9wdGlvbnMgPSAoIG9wdGlvbnMgJiYgKCAkLnR5cGUoIG9wdGlvbnMgKSA9PT0gIm9iamVjdCIgKSApPyBvcHRpb25zIDoge307Cglmb3IgKCB2YXIgaSA9IDA7IGkgPCAkd29ya2luZ1NldC5sZW5ndGg7IGkrKyApIHsKCQl2YXIgZWwgPSAkd29ya2luZ1NldC5lcSggaSApLAoJCQllID0gZWxbIDAgXSwKCQkJbyA9ICQuZXh0ZW5kKCB7fSwgJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMsIHsKCQkJCWljb246ICAgICAgIG9wdGlvbnMuaWNvbiAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29uICAgICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJpY29uIiApLAoJCQkJaWNvbnBvczogICAgb3B0aW9ucy5pY29ucG9zICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25wb3MgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImljb25wb3MiICksCgkJCQl0aGVtZTogICAgICBvcHRpb25zLnRoZW1lICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudGhlbWUgICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGVsLCAiYyIgKSwKCQkJCWlubGluZTogICAgIG9wdGlvbnMuaW5saW5lICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pbmxpbmUgICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJpbmxpbmUiICksCgkJCQlzaGFkb3c6ICAgICBvcHRpb25zLnNoYWRvdyAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc2hhZG93ICAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAic2hhZG93IiApLAoJCQkJY29ybmVyczogICAgb3B0aW9ucy5jb3JuZXJzICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvcm5lcnMgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImNvcm5lcnMiICksCgkJCQlpY29uc2hhZG93OiBvcHRpb25zLmljb25zaGFkb3cgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbnNoYWRvdyA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaWNvbnNoYWRvdyIgKSwKCQkJCW1pbmk6ICAgICAgIG9wdGlvbnMubWluaSAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5taW5pICAgICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJtaW5pIiApCgkJCX0sIG9wdGlvbnMgKSwKCgkJCS8vIENsYXNzZXMgRGVmaW5lZAoJCQlpbm5lckNsYXNzID0gInVpLWJ0bi1pbm5lciIsCgkJCXRleHRDbGFzcyA9ICJ1aS1idG4tdGV4dCIsCgkJCWJ1dHRvbkNsYXNzLCBpY29uQ2xhc3MsCgkJCWhvdmVyID0gZmFsc2UsCgkJCXN0YXRlID0gInVwIiwKCQkJLy8gQnV0dG9uIGlubmVyIG1hcmt1cAoJCQlidXR0b25Jbm5lciwKCQkJYnV0dG9uVGV4dCwKCQkJYnV0dG9uSWNvbiwKCQkJYnV0dG9uRWxlbWVudHM7CgoJCWZvciAoIGtleSBpbiBvICkgewoJCQlpZiAoIG9bIGtleSBdID09PSB1bmRlZmluZWQgfHwgb1sga2V5IF0gPT09IG51bGwgKSB7CgkJCQllbC5yZW1vdmVBdHRyKCBuc0tleSArIGtleSApOwoJCQl9IGVsc2UgewoJCQkJZS5zZXRBdHRyaWJ1dGUoIG5zS2V5ICsga2V5LCBvWyBrZXkgXSApOwoJCQl9CgkJfQoKCQlpZiAoIGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAicmVsIiApID09PSAicG9wdXAiICYmIGVsLmF0dHIoICJocmVmIiApICkgewoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtaGFzcG9wdXAiLCB0cnVlICk7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgZWwuYXR0ciggImhyZWYiICkgKTsKCQl9CgoJCS8vIENoZWNrIGlmIHRoaXMgZWxlbWVudCBpcyBhbHJlYWR5IGVuaGFuY2VkCgkJYnV0dG9uRWxlbWVudHMgPSAkLmRhdGEoICggKCBlLnRhZ05hbWUgPT09ICJJTlBVVCIgfHwgZS50YWdOYW1lID09PSAiQlVUVE9OIiApID8gZS5wYXJlbnROb2RlIDogZSApLCAiYnV0dG9uRWxlbWVudHMiICk7CgoJCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJCWUgPSBidXR0b25FbGVtZW50cy5vdXRlcjsKCQkJZWwgPSAkKCBlICk7CgkJCWJ1dHRvbklubmVyID0gYnV0dG9uRWxlbWVudHMuaW5uZXI7CgkJCWJ1dHRvblRleHQgPSBidXR0b25FbGVtZW50cy50ZXh0OwoJCQkvLyBXZSB3aWxsIHJlY3JlYXRlIHRoaXMgaWNvbiBiZWxvdwoJCQkkKCBidXR0b25FbGVtZW50cy5pY29uICkucmVtb3ZlKCk7CgkJCWJ1dHRvbkVsZW1lbnRzLmljb24gPSBudWxsOwoJCQlob3ZlciA9IGJ1dHRvbkVsZW1lbnRzLmhvdmVyOwoJCQlzdGF0ZSA9IGJ1dHRvbkVsZW1lbnRzLnN0YXRlOwoJCX0KCQllbHNlIHsKCQkJYnV0dG9uSW5uZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQkJYnV0dG9uVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCX0KCQlidXR0b25JY29uID0gby5pY29uID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgOiBudWxsOwoKCQlpZiAoIGF0dGFjaEV2ZW50cyAmJiAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWF0dGFjaEV2ZW50cygpOwoJCX0KCgkJLy8gaWYgbm90LCB0cnkgdG8gZmluZCBjbG9zZXN0IHRoZW1lIGNvbnRhaW5lcgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggZWwsICJjIiApOwoJCX0KCgkJYnV0dG9uQ2xhc3MgPSAidWktYnRuICI7CgkJYnV0dG9uQ2xhc3MgKz0gKCBob3ZlciA/ICJ1aS1idG4taG92ZXItIiArIG8udGhlbWUgOiAiIiApOwoJCWJ1dHRvbkNsYXNzICs9ICggc3RhdGUgPyAiIHVpLWJ0bi0iICsgc3RhdGUgKyAiLSIgKyBvLnRoZW1lIDogIiIgKTsKCQlidXR0b25DbGFzcyArPSBvLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCWJ1dHRvbkNsYXNzICs9IG8uY29ybmVycyA/ICIgdWktYnRuLWNvcm5lci1hbGwiIDogIiI7CgoJCWlmICggby5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCS8vIFVzZWQgdG8gY29udHJvbCBzdHlsaW5nIGluIGhlYWRlcnMvZm9vdGVycywgd2hlcmUgYnV0dG9ucyBkZWZhdWx0IHRvIGBtaW5pYCBzdHlsZS4KCQkJYnV0dG9uQ2xhc3MgKz0gby5taW5pID09PSB0cnVlID8gIiB1aS1taW5pIiA6ICIgdWktZnVsbHNpemUiOwoJCX0KCgkJaWYgKCBvLmlubGluZSAhPT0gdW5kZWZpbmVkICkgewoJCQkvLyBVc2VkIHRvIGNvbnRyb2wgc3R5bGluZyBpbiBoZWFkZXJzL2Zvb3RlcnMsIHdoZXJlIGJ1dHRvbnMgZGVmYXVsdCB0byBgaW5saW5lYCBzdHlsZS4KCQkJYnV0dG9uQ2xhc3MgKz0gby5pbmxpbmUgPT09IHRydWUgPyAiIHVpLWJ0bi1pbmxpbmUiIDogIiB1aS1idG4tYmxvY2siOwoJCX0KCgkJaWYgKCBvLmljb24gKSB7CgkJCW8uaWNvbiA9ICJ1aS1pY29uLSIgKyBvLmljb247CgkJCW8uaWNvbnBvcyA9IG8uaWNvbnBvcyB8fCAibGVmdCI7CgoJCQlpY29uQ2xhc3MgPSAidWktaWNvbiAiICsgby5pY29uOwoKCQkJaWYgKCBvLmljb25zaGFkb3cgKSB7CgkJCQlpY29uQ2xhc3MgKz0gIiB1aS1pY29uLXNoYWRvdyI7CgkJCX0KCQl9CgoJCWlmICggby5pY29ucG9zICkgewoJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1pY29uLSIgKyBvLmljb25wb3M7CgoJCQlpZiAoIG8uaWNvbnBvcyA9PT0gIm5vdGV4dCIgJiYgIWVsLmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJCWVsLmF0dHIoICJ0aXRsZSIsIGVsLmdldEVuY29kZWRUZXh0KCkgKTsKCQkJfQoJCX0KCgkJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQkJZWwucmVtb3ZlQ2xhc3MoIGJ1dHRvbkVsZW1lbnRzLmJjbHMgfHwgIiIgKTsKCQl9CgkJZWwucmVtb3ZlQ2xhc3MoICJ1aS1saW5rIiApLmFkZENsYXNzKCBidXR0b25DbGFzcyApOwoKCQlidXR0b25Jbm5lci5jbGFzc05hbWUgPSBpbm5lckNsYXNzOwoJCWJ1dHRvblRleHQuY2xhc3NOYW1lID0gdGV4dENsYXNzOwoJCWlmICggIWJ1dHRvbkVsZW1lbnRzICkgewoJCQlidXR0b25Jbm5lci5hcHBlbmRDaGlsZCggYnV0dG9uVGV4dCApOwoJCX0KCQlpZiAoIGJ1dHRvbkljb24gKSB7CgkJCWJ1dHRvbkljb24uY2xhc3NOYW1lID0gaWNvbkNsYXNzOwoJCQlpZiAoICEoIGJ1dHRvbkVsZW1lbnRzICYmIGJ1dHRvbkVsZW1lbnRzLmljb24gKSApIHsKCQkJCWJ1dHRvbkljb24uaW5uZXJIVE1MID0gIiYjMTYwOyI7CgkJCQlidXR0b25Jbm5lci5hcHBlbmRDaGlsZCggYnV0dG9uSWNvbiApOwoJCQl9CgkJfQoKCQl3aGlsZSAoIGUuZmlyc3RDaGlsZCAmJiAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvblRleHQuYXBwZW5kQ2hpbGQoIGUuZmlyc3RDaGlsZCApOwoJCX0KCgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWUuYXBwZW5kQ2hpbGQoIGJ1dHRvbklubmVyICk7CgkJfQoKCQkvLyBBc3NpZ24gYSBzdHJ1Y3R1cmUgY29udGFpbmluZyB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24gdG8gdGhlIGVsZW1lbnRzIG9mIHRoaXMgYnV0dG9uLiBUaGlzCgkJLy8gd2lsbCBhbGxvdyB1cyB0byByZWNvZ25pemUgdGhpcyBhcyBhbiBhbHJlYWR5LWVuaGFuY2VkIGJ1dHRvbiBpbiBmdXR1cmUgY2FsbHMgdG8gYnV0dG9uTWFya3VwKCkuCgkJYnV0dG9uRWxlbWVudHMgPSB7CgkJCWhvdmVyIDogaG92ZXIsCgkJCXN0YXRlIDogc3RhdGUsCgkJCWJjbHMgIDogYnV0dG9uQ2xhc3MsCgkJCW91dGVyIDogZSwKCQkJaW5uZXIgOiBidXR0b25Jbm5lciwKCQkJdGV4dCAgOiBidXR0b25UZXh0LAoJCQlpY29uICA6IGJ1dHRvbkljb24KCQl9OwoKCQkkLmRhdGEoIGUsICAgICAgICAgICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCSQuZGF0YSggYnV0dG9uSW5uZXIsICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJJC5kYXRhKCBidXR0b25UZXh0LCAgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQlpZiAoIGJ1dHRvbkljb24gKSB7CgkJCSQuZGF0YSggYnV0dG9uSWNvbiwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgokLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cyA9IHsKCWNvcm5lcnM6IHRydWUsCglzaGFkb3c6IHRydWUsCglpY29uc2hhZG93OiB0cnVlLAoJd3JhcHBlckVsczogInNwYW4iCn07CgpmdW5jdGlvbiBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZWxlbWVudCApIHsKICAgIHZhciBjbmFtZTsKCiAgICB3aGlsZSAoIGVsZW1lbnQgKSB7CgkJLy8gTm90ZSB0aGF0IHdlIGNoZWNrIGZvciB0eXBlb2YgY2xhc3NOYW1lIGJlbG93IGJlY2F1c2UgdGhlIGVsZW1lbnQgd2UKCQkvLyBoYW5kZWQgY291bGQgYmUgaW4gYW4gU1ZHIERPTSB3aGVyZSBjbGFzc05hbWUgb24gU1ZHIGVsZW1lbnRzIGlzIGRlZmluZWQgdG8KCQkvLyBiZSBvZiBhIGRpZmZlcmVudCB0eXBlIChTVkdBbmltYXRlZFN0cmluZykuIFdlIG9ubHkgb3BlcmF0ZSBvbiBIVE1MIERPTQoJCS8vIGVsZW1lbnRzLCBzbyB3ZSBsb29rIGZvciBwbGFpbiAic3RyaW5nIi4KICAgICAgICBjbmFtZSA9ICggdHlwZW9mIGVsZW1lbnQuY2xhc3NOYW1lID09PSAnc3RyaW5nJyApICYmICggZWxlbWVudC5jbGFzc05hbWUgKyAnICcgKTsKICAgICAgICBpZiAoIGNuYW1lICYmIGNuYW1lLmluZGV4T2YoICJ1aS1idG4gIiApID4gLTEgJiYgY25hbWUuaW5kZXhPZiggInVpLWRpc2FibGVkICIgKSA8IDAgKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudDsKfQoKZnVuY3Rpb24gdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sIGNsYXNzVG9SZW1vdmUsIGNsYXNzVG9BZGQsIGhvdmVyLCBzdGF0ZSApIHsKCXZhciBidXR0b25FbGVtZW50cyA9ICQuZGF0YSggJGJ0blsgMCBdLCAiYnV0dG9uRWxlbWVudHMiICk7CgkkYnRuLnJlbW92ZUNsYXNzKCBjbGFzc1RvUmVtb3ZlICkuYWRkQ2xhc3MoIGNsYXNzVG9BZGQgKTsKCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJYnV0dG9uRWxlbWVudHMuYmNscyA9ICQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICkgKQoJCQkuYWRkQ2xhc3MoIGJ1dHRvbkVsZW1lbnRzLmJjbHMgKyAiICIgKyBjbGFzc1RvQWRkICkKCQkJLnJlbW92ZUNsYXNzKCBjbGFzc1RvUmVtb3ZlICkKCQkJLmF0dHIoICJjbGFzcyIgKTsKCQlpZiAoIGhvdmVyICE9PSB1bmRlZmluZWQgKSB7CgkJCWJ1dHRvbkVsZW1lbnRzLmhvdmVyID0gaG92ZXI7CgkJfQoJCWJ1dHRvbkVsZW1lbnRzLnN0YXRlID0gc3RhdGU7Cgl9Cn0KCnZhciBhdHRhY2hFdmVudHMgPSBmdW5jdGlvbigpIHsKCXZhciBob3ZlckRlbGF5ID0gJC5tb2JpbGUuYnV0dG9uTWFya3VwLmhvdmVyRGVsYXksIGhvdiwgZm9jOwoKCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoIHsKCQkidm1vdXNlZG93biB2bW91c2VjYW5jZWwgdm1vdXNldXAgdm1vdXNlb3ZlciB2bW91c2VvdXQgZm9jdXMgYmx1ciBzY3JvbGxzdGFydCI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHRoZW1lLAoJCQkJJGJ0biA9ICQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLAoJCQkJaXNUb3VjaEV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCAmJiAvXnRvdWNoLy50ZXN0KCBldmVudC5vcmlnaW5hbEV2ZW50LnR5cGUgKSwKCQkJCWV2dCA9IGV2ZW50LnR5cGU7CgoJCQlpZiAoICRidG4ubGVuZ3RoICkgewoJCQkJdGhlbWUgPSAkYnRuLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIgKTsKCgkJCQlpZiAoIGV2dCA9PT0gInZtb3VzZWRvd24iICkgewoJCQkJCWlmICggaXNUb3VjaEV2ZW50ICkgewoJCQkJCQkvLyBVc2UgYSBzaG9ydCBkZWxheSB0byBkZXRlcm1pbmUgaWYgdGhlIHVzZXIgaXMgc2Nyb2xsaW5nIGJlZm9yZSBoaWdobGlnaHRpbmcKCQkJCQkJaG92ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi11cC0iICsgdGhlbWUsICJ1aS1idG4tZG93bi0iICsgdGhlbWUsIHVuZGVmaW5lZCwgImRvd24iICk7CgkJCQkJCX0sIGhvdmVyRGVsYXkgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi11cC0iICsgdGhlbWUsICJ1aS1idG4tZG93bi0iICsgdGhlbWUsIHVuZGVmaW5lZCwgImRvd24iICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlY2FuY2VsIiB8fCBldnQgPT09ICJ2bW91c2V1cCIgKSB7CgkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tZG93bi0iICsgdGhlbWUsICJ1aS1idG4tdXAtIiArIHRoZW1lLCB1bmRlZmluZWQsICJ1cCIgKTsKCQkJCX0gZWxzZSBpZiAoIGV2dCA9PT0gInZtb3VzZW92ZXIiIHx8IGV2dCA9PT0gImZvY3VzIiApIHsKCQkJCQlpZiAoIGlzVG91Y2hFdmVudCApIHsKCQkJCQkJLy8gVXNlIGEgc2hvcnQgZGVsYXkgdG8gZGV0ZXJtaW5lIGlmIHRoZSB1c2VyIGlzIHNjcm9sbGluZyBiZWZvcmUgaGlnaGxpZ2h0aW5nCgkJCQkJCWZvYyA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tdXAtIiArIHRoZW1lLCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSwgdHJ1ZSwgIiIgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUsIHRydWUsICIiICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3V0IiB8fCBldnQgPT09ICJibHVyIiB8fCBldnQgPT09ICJzY3JvbGxzdGFydCIgKSB7CgkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4taG92ZXItIiArIHRoZW1lICArICIgdWktYnRuLWRvd24tIiArIHRoZW1lLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgZmFsc2UsICJ1cCIgKTsKCQkJCQlpZiAoIGhvdiApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBob3YgKTsKCQkJCQl9CgkJCQkJaWYgKCBmb2MgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggZm9jICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCQkiZm9jdXNpbiBmb2N1cyI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQl9LAoJCSJmb2N1c291dCBibHVyIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0KCX0pOwoKCWF0dGFjaEV2ZW50cyA9IG51bGw7Cn07CgovL2xpbmtzIGluIGJhcnMsIG9yIHRob3NlIHdpdGggIGRhdGEtcm9sZSBiZWNvbWUgYnV0dG9ucwovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJJCggIjpqcW1EYXRhKHJvbGU9J2J1dHRvbicpLCAudWktYmFyID4gYSwgLnVpLWhlYWRlciA+IGEsIC51aS1mb290ZXIgPiBhLCAudWktYmFyID4gOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykgPiBhIiwgZS50YXJnZXQgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLm5vdCggImJ1dHRvbiwgaW5wdXQsIC51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmJ1dHRvbk1hcmt1cCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJZXhwYW5kQ3VlVGV4dDogIiBjbGljayB0byBleHBhbmQgY29udGVudHMiLAoJCWNvbGxhcHNlQ3VlVGV4dDogIiBjbGljayB0byBjb2xsYXBzZSBjb250ZW50cyIsCgkJY29sbGFwc2VkOiB0cnVlLAoJCWhlYWRpbmc6ICJoMSxoMixoMyxoNCxoNSxoNixsZWdlbmQiLAoJCWNvbGxhcHNlZEljb246ICJwbHVzIiwKCQlleHBhbmRlZEljb246ICJtaW51cyIsCgkJaWNvbnBvczogImxlZnQiLAoJCXRoZW1lOiBudWxsLAoJCWNvbnRlbnRUaGVtZTogbnVsbCwKCQlpbnNldDogdHJ1ZSwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlID0gJGVsLmFkZENsYXNzKCAidWktY29sbGFwc2libGUiICksCgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICRlbC5jaGlsZHJlbiggby5oZWFkaW5nICkuZmlyc3QoKSwKCQkJY29sbGFwc2libGVDb250ZW50ID0gY29sbGFwc2libGUud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCc+PC9kaXY+IiApLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWNvbnRlbnQiICksCgkJCWNvbGxhcHNpYmxlU2V0ID0gJGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKSwKCQkJY29sbGFwc2libGVDbGFzc2VzID0gIiI7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIGNvbGxhcHNpYmxlSGVhZGluZy5pcyggImxlZ2VuZCIgKSApIHsKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJCggIjxkaXYgcm9sZT0naGVhZGluZyc+IisgY29sbGFwc2libGVIZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlSGVhZGluZyApOwoJCQljb2xsYXBzaWJsZUhlYWRpbmcubmV4dCgpLnJlbW92ZSgpOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGluIGEgY29sbGFwc2libGUgc2V0CgkJaWYgKCBjb2xsYXBzaWJsZVNldC5sZW5ndGggKSB7CgkJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb2xsYXBzaWJsZVNldCwgImMiICk7CgkJCX0KCQkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJCW8uY29udGVudFRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJCX0KCgkJCS8vIEdldCB0aGUgcHJlZmVyZW5jZSBmb3IgY29sbGFwc2VkIGljb24gaW4gdGhlIHNldCwgYnV0IG92ZXJyaWRlIHdpdGggZGF0YS0gYXR0cmlidXRlIG9uIHRoZSBpbmRpdmlkdWFsIGNvbGxhcHNpYmxlCgkJCW8uY29sbGFwc2VkSWNvbiA9ICRlbC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICkgfHwgY29sbGFwc2libGVTZXQuanFtRGF0YSggImNvbGxhcHNlZC1pY29uIiApIHx8IG8uY29sbGFwc2VkSWNvbjsKCgkJCS8vIEdldCB0aGUgcHJlZmVyZW5jZSBmb3IgZXhwYW5kZWQgaWNvbiBpbiB0aGUgc2V0LCBidXQgb3ZlcnJpZGUgd2l0aCBkYXRhLSBhdHRyaWJ1dGUgb24gdGhlIGluZGl2aWR1YWwgY29sbGFwc2libGUKCQkJby5leHBhbmRlZEljb24gPSAkZWwuanFtRGF0YSggImV4cGFuZGVkLWljb24iICkgfHwgY29sbGFwc2libGVTZXQuanFtRGF0YSggImV4cGFuZGVkLWljb24iICkgfHwgby5leHBhbmRlZEljb247CgoJCQkvLyBHZXRzIHRoZSBwcmVmZXJlbmNlIGljb24gcG9zaXRpb24gaW4gdGhlIHNldCwgYnV0IG92ZXJyaWRlIHdpdGggZGF0YS0gYXR0cmlidXRlIG9uIHRoZSBpbmRpdmlkdWFsIGNvbGxhcHNpYmxlCgkJCW8uaWNvbnBvcyA9ICRlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSB8fCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaWNvbnBvcyIgKSB8fCBvLmljb25wb3M7CgoJCQkvLyBJbmhlcml0IHRoZSBwcmVmZXJlbmNlIGZvciBpbnNldCBmcm9tIGNvbGxhcHNpYmxlLXNldCBvciBzZXQgdGhlIGRlZmF1bHQgdmFsdWUgdG8gZW5zdXJlIGVxdWFsdHkgd2l0aGluIGEgc2V0CgkJCWlmICggY29sbGFwc2libGVTZXQuanFtRGF0YSggImluc2V0IiApICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvLmluc2V0ID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImluc2V0IiApOwoJCQl9IGVsc2UgewoJCQkJby5pbnNldCA9IHRydWU7CgkJCX0KCQkJLy8gU2V0IGNvcm5lcnMgZm9yIGluZGl2aWR1YWwgY29sbGFwc2libGVzIHRvIGZhbHNlIHdoZW4gaW4gYSBjb2xsYXBzaWJsZS1zZXQKCQkJby5jb3JuZXJzID0gZmFsc2U7CgkJCS8vIEdldHMgdGhlIHByZWZlcmVuY2UgZm9yIG1pbmkgaW4gdGhlIHNldAoJCQlpZiAoICFvLm1pbmkgKSB7CgkJCQlvLm1pbmkgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAibWluaSIgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCS8vIGdldCBpbmhlcml0ZWQgdGhlbWUgaWYgbm90IGEgc2V0IGFuZCBubyB0aGVtZSBoYXMgYmVlbiBzZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggJGVsLCAiYyIgKTsKCQkJfQoJCX0KCgkJaWYgKCAhIW8uaW5zZXQgKSB7CgkJCWNvbGxhcHNpYmxlQ2xhc3NlcyArPSAiIHVpLWNvbGxhcHNpYmxlLWluc2V0IjsKCQkJaWYgKCAhIW8uY29ybmVycyApIHsKCQkJCWNvbGxhcHNpYmxlQ2xhc3NlcyArPSAiIHVpLWNvcm5lci1hbGwiIDsKCQkJfQoJCX0KCQlpZiAoIG8uY29udGVudFRoZW1lICkgewoJCQljb2xsYXBzaWJsZUNsYXNzZXMgKz0gIiB1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCI7CgkJCWNvbGxhcHNpYmxlQ29udGVudC5hZGRDbGFzcyggInVpLWJvZHktIiArIG8uY29udGVudFRoZW1lICk7CgkJfQoJCWlmICggY29sbGFwc2libGVDbGFzc2VzICE9PSAiIiApIHsKCQkJY29sbGFwc2libGUuYWRkQ2xhc3MoIGNvbGxhcHNpYmxlQ2xhc3NlcyApOwoJCX0KCQkKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQkJLmluc2VydEJlZm9yZSggY29sbGFwc2libGVDb250ZW50ICkKCQkJLy9tb2RpZnkgbWFya3VwICYgYXR0cmlidXRlcwoJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCS5hcHBlbmQoICI8c3BhbiBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMnPjwvc3Bhbj4iICkKCQkJLndyYXBJbm5lciggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXRvZ2dsZSc+PC9hPiIgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCQlpY29uOiBvLmNvbGxhcHNlZEljb24sCgkJCQkJbWluaTogby5taW5pLAoJCQkJCXRoZW1lOiBvLnRoZW1lCgkJCQl9KTsKCgkJLy9ldmVudHMKCQljb2xsYXBzaWJsZQoJCQkuYmluZCggImV4cGFuZCBjb2xsYXBzZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJaXNDb2xsYXBzZSA9ICggZXZlbnQudHlwZSA9PT0gImNvbGxhcHNlIiApOwoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkKCQkJCQkJLmZpbmQoICIudWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMiICkKCQkJCQkJCS50ZXh0KCBpc0NvbGxhcHNlID8gby5leHBhbmRDdWVUZXh0IDogby5jb2xsYXBzZUN1ZVRleHQgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgby5leHBhbmRlZEljb24sICFpc0NvbGxhcHNlICkKCQkJCQkJCS8vIGxvZ2ljIG9yIGNhdXNlIHNhbWUgaWNvbiBmb3IgZXhwYW5kZWQvY29sbGFwc2VkIHN0YXRlIHdvdWxkIHJlbW92ZSB0aGUgdWktaWNvbi1jbGFzcwoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgby5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgby5leHBhbmRlZEljb24gPT09IG8uY29sbGFwc2VkSWNvbiApICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCQkkdGhpcy50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICk7CgoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAidGFwIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPyAiZXhwYW5kIiA6ICJjb2xsYXBzZSI7CgoJCQkJY29sbGFwc2libGUudHJpZ2dlciggdHlwZSApOwoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyA9IHsKCV9nZXRWaXNpYmxlczogZnVuY3Rpb24oICRlbHMsIGNyZWF0ZSApIHsKCQl2YXIgdmlzaWJsZXM7CgoJCWlmICggY3JlYXRlICkgewoJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdmlzaWJsZXMgPSAkZWxzLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQlpZiAoIHZpc2libGVzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHZpc2libGVzOwoJfSwKCglfYWRkRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMsICR2aXNpYmxlcywgY3JlYXRlICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJCSR2aXNpYmxlcy5lcSggMCApLmFkZENsYXNzKCAidWktZmlyc3QtY2hpbGQiICkuZW5kKCkubGFzdCgpLmFkZENsYXNzKCAidWktbGFzdC1jaGlsZCIgKTsKCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0KfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKSwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoICRlbCwgImMiICk7CgkJfQoJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJby5jb250ZW50VGhlbWUgPSAkZWwuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJfQoJCS8vIEluaGVyaXQgdGhlIGNvcm5lciBzdHlsaW5nIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby5jb3JuZXJzICkgewoJCQlvLmNvcm5lcnMgPSAkZWwuanFtRGF0YSggImNvcm5lcnMiICk7CgkJfQoJCQoJCWlmICggJGVsLmpxbURhdGEoICJpbnNldCIgKSAhPT0gdW5kZWZpbmVkICkgewoJCQlvLmluc2V0ID0gJGVsLmpxbURhdGEoICJpbnNldCIgKTsKCQl9CgkJby5pbnNldCA9IG8uaW5zZXQgIT09IHVuZGVmaW5lZCA/IG8uaW5zZXQgOiB0cnVlOwoJCW8uY29ybmVycyA9IG8uY29ybmVycyAhPT0gdW5kZWZpbmVkID8gby5jb3JuZXJzIDogdHJ1ZTsKCQkKCQlpZiAoICEhby5jb3JuZXJzICYmICEhby5pbnNldCApIHsKCQkJJGVsLmFkZENsYXNzKCAidWktY29ybmVyLWFsbCIgKTsKCQl9CgoJCS8vIEluaXRpYWxpemUgdGhlIGNvbGxhcHNpYmxlIHNldCBpZiBpdCdzIG5vdCBhbHJlYWR5IGluaXRpYWxpemVkCgkJaWYgKCAhJGVsLmpxbURhdGEoICJjb2xsYXBzaWJsZWJvdW5kIiApICkgewoJCQkkZWwKCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIsIHRydWUgKQoJCQkJLmJpbmQoICJleHBhbmQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJdmFyIGNsb3Nlc3RDb2xsYXBzaWJsZSA9ICQoIGV2ZW50LnRhcmdldCApCgkJCQkJCS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApOwoJCQkJCWlmICggY2xvc2VzdENvbGxhcHNpYmxlLnBhcmVudCgpLmlzKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkgKSB7CgkJCQkJCWNsb3Nlc3RDb2xsYXBzaWJsZQoJCQkJCQkJLnNpYmxpbmdzKCAiLnVpLWNvbGxhcHNpYmxlIiApCgkJCQkJCQkudHJpZ2dlciggImNvbGxhcHNlIiApOwoJCQkJCX0KCQkJCX0pOwoJCX0KCX0sCgoJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWNvbGxhcHNpYmxlc0luU2V0ID0gJGVsLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIgKSwKCQkJZXhwYW5kZWQgPSBjb2xsYXBzaWJsZXNJblNldC5maWx0ZXIoICI6anFtRGF0YShjb2xsYXBzZWQ9J2ZhbHNlJykiICk7CgkJdGhpcy5fcmVmcmVzaCggInRydWUiICk7CgoJCS8vIEJlY2F1c2UgdGhlIGNvcm5lcnMgYXJlIGhhbmRsZWQgYnkgdGhlIGNvbGxhcHNpYmxlIGl0c2VsZiBhbmQgdGhlIGRlZmF1bHQgc3RhdGUgaXMgY29sbGFwc2VkCgkJLy8gVGhhdCB3YXMgY2F1c2luZyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQxMTYKCQlleHBhbmRlZC50cmlnZ2VyKCAiZXhwYW5kIiApOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgY29sbGFwc2libGVzSW5TZXQgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApOwoKCQkkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUuZW5oYW5jZSggY29sbGFwc2libGVzSW5TZXQubm90KCAiLnVpLWNvbGxhcHNpYmxlIiApICk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGNvbGxhcHNpYmxlc0luU2V0LCB0aGlzLl9nZXRWaXNpYmxlcyggY29sbGFwc2libGVzSW5TZXQsIGNyZWF0ZSApLCBjcmVhdGUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY29sbGFwc2libGVzZXQucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBmaWx0ZXIgZnVuY3Rpb24gcmVtb3ZlcyB3aGl0ZXNwYWNlIGJldHdlZW4gbGFiZWwgYW5kIGZvcm0gZWxlbWVudCBzbyB3ZSBjYW4gdXNlIGlubGluZS1ibG9jayAobm9kZVR5cGUgMyA9IHRleHQpCiQuZm4uZmllbGRjb250YWluID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcwoJCS5hZGRDbGFzcyggInVpLWZpZWxkLWNvbnRhaW4gdWktYm9keSB1aS1iciIgKQoJCS5jb250ZW50cygpLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCXJldHVybiAoIHRoaXMubm9kZVR5cGUgPT09IDMgJiYgIS9cUy8udGVzdCggdGhpcy5ub2RlVmFsdWUgKSApOwoJCX0pLnJlbW92ZSgpOwp9OwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nZmllbGRjb250YWluJykiLCBlLnRhcmdldCApLmpxbUVuaGFuY2VhYmxlKCkuZmllbGRjb250YWluKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmdyaWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCWdyaWQ6IG51bGwKCQkJfSwgb3B0aW9ucyApLAoJCQkka2lkcyA9ICR0aGlzLmNoaWxkcmVuKCksCgkJCWdyaWRDb2xzID0geyBzb2xvOjEsIGE6MiwgYjozLCBjOjQsIGQ6NSB9LAoJCQlncmlkID0gby5ncmlkLAoJCQlpdGVyYXRvcjsKCgkJCWlmICggIWdyaWQgKSB7CgkJCQlpZiAoICRraWRzLmxlbmd0aCA8PSA1ICkgewoJCQkJCWZvciAoIHZhciBsZXR0ZXIgaW4gZ3JpZENvbHMgKSB7CgkJCQkJCWlmICggZ3JpZENvbHNbIGxldHRlciBdID09PSAka2lkcy5sZW5ndGggKSB7CgkJCQkJCQlncmlkID0gbGV0dGVyOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlncmlkID0gImEiOwoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC1kdW8iICk7CgkJCQl9CgkJCX0KCQkJaXRlcmF0b3IgPSBncmlkQ29sc1tncmlkXTsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLSIgKyBncmlkICk7CgoJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1hIiApOwoKCQlpZiAoIGl0ZXJhdG9yID4gMSApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisyKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWIiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAyICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzMpIiApLmFkZENsYXNzKCAidWktYmxvY2stYyIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDMgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNCkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1kIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gNCApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis1KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWUiICk7CgkJfQoJfSk7Cn07Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUubmF2YmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJaWNvbnBvczogInRvcCIsCgkJZ3JpZDogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSduYXZiYXInKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkbmF2YmFyID0gdGhpcy5lbGVtZW50LAoJCQkkbmF2YnRucyA9ICRuYXZiYXIuZmluZCggImEiICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPwoJCQkJCQkJCQl0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciB1aS1taW5pIiApCgkJCS5hdHRyKCAicm9sZSIsICJuYXZpZ2F0aW9uIiApCgkJCS5maW5kKCAidWwiICkKCQkJLmpxbUVuaGFuY2VhYmxlKCkKCQkJLmdyaWQoeyBncmlkOiB0aGlzLm9wdGlvbnMuZ3JpZCB9KTsKCgkJJG5hdmJ0bnMuYnV0dG9uTWFya3VwKHsKCQkJY29ybmVyczoJZmFsc2UsCgkJCXNoYWRvdzoJCWZhbHNlLAoJCQlpbmxpbmU6ICAgICB0cnVlLAoJCQlpY29ucG9zOglpY29ucG9zCgkJfSk7CgoJCSRuYXZiYXIuZGVsZWdhdGUoICJhIiwgInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gdWktYnRuLWlubmVyIGlzIHJldHVybmVkIGFzIHRhcmdldAoJCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoICJhIiApID8gJCggdGhpcyApIDogJCggdGhpcyApLnBhcmVudCggImEiICk7CgkJCQoJCQlpZiAoICF0YXJnZXQuaXMoICIudWktZGlzYWJsZWQsIC51aS1idG4tYWN0aXZlIiApICkgewoJCQkJJG5hdmJ0bnMucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkkKCB0aGlzICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkKCQkJCS8vIFRoZSBjb2RlIGJlbG93IGlzIGEgd29ya2Fyb3VuZCB0byBmaXggIzExODEKCQkJCXZhciBhY3RpdmVCdG4gPSAkKCB0aGlzICk7CgkJCQkKCQkJCSQoIGRvY3VtZW50ICkub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQlhY3RpdmVCdG4ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCX0pOwoKCQkvLyBCdXR0b25zIGluIHRoZSBuYXZiYXIgd2l0aCB1aS1zdGF0ZS1wZXJzaXN0IGNsYXNzIHNob3VsZCByZWdhaW4gdGhlaXIgYWN0aXZlIHN0YXRlIGJlZm9yZSBwYWdlIHNob3cKCQkkbmF2YmFyLmNsb3Nlc3QoICIudWktcGFnZSIgKS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJJG5hdmJ0bnMuZmlsdGVyKCAiLnVpLXN0YXRlLXBlcnNpc3QiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUubmF2YmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy9LZWVwcyB0cmFjayBvZiB0aGUgbnVtYmVyIG9mIGxpc3RzIHBlciBwYWdlIFVJRAovL1RoaXMgYWxsb3dzIHN1cHBvcnQgZm9yIG11bHRpcGxlIG5lc3RlZCBsaXN0IGluIHRoZSBzYW1lIHBhZ2UKLy9odHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzE2MTcKdmFyIGxpc3RDb3VudFBlclBhZ2UgPSB7fTsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUud2lkZ2V0LCAkLmV4dGVuZCggewoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiAiYyIsCgkJaGVhZGVyVGhlbWU6ICJiIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQlpY29uOiAiYXJyb3ctciIsCgkJc3BsaXRJY29uOiAiYXJyb3ctciIsCgkJc3BsaXRUaGVtZTogImIiLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWluc2V0OiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdsaXN0dmlldycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCIgOiAiIjsKCgkJaWYgKCAhIXQub3B0aW9ucy5pbnNldCApIHsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiOwoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCX0KCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyhmdW5jdGlvbiggaSwgb3JpZyApIHsKCQkJcmV0dXJuIG9yaWcgKyAiIHVpLWxpc3R2aWV3IiArIGxpc3R2aWV3Q2xhc3NlczsKCQl9KTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCS8vIFRoaXMgaXMgYSBnZW5lcmljIHV0aWxpdHkgbWV0aG9kIGZvciBmaW5kaW5nIHRoZSBmaXJzdAoJLy8gbm9kZSB3aXRoIGEgZ2l2ZW4gbm9kZU5hbWUuIEl0IHVzZXMgYmFzaWMgRE9NIHRyYXZlcnNhbAoJLy8gdG8gYmUgZmFzdCBhbmQgaXMgbWVhbnQgdG8gYmUgYSBzdWJzdGl0dXRlIGZvciBzaW1wbGUKCS8vICQuZm4uY2xvc2VzdCgpIGFuZCAkLmZuLmNoaWxkcmVuKCkgY2FsbHMgb24gYSBzaW5nbGUKCS8vIGVsZW1lbnQuIE5vdGUgdGhhdCBjYWxsZXJzIG11c3QgcGFzcyBib3RoIHRoZSBsb3dlckNhc2UKCS8vIGFuZCB1cHBlckNhc2UgdmVyc2lvbiBvZiB0aGUgbm9kZU5hbWUgdGhleSBhcmUgbG9va2luZyBmb3IuCgkvLyBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMgaXMgdGhhdCB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUKCS8vIGNhbGxlZCBtYW55IHRpbWVzIGFuZCB3ZSB3YW50IHRvIGF2b2lkIGhhdmluZyB0byBsb3dlcmNhc2UKCS8vIHRoZSBub2RlTmFtZSBmcm9tIHRoZSBlbGVtZW50IGV2ZXJ5IHRpbWUgdG8gZW5zdXJlIHdlIGhhdmUKCS8vIGEgbWF0Y2guIE5vdGUgdGhhdCB0aGlzIGZ1bmN0aW9uIGxpdmVzIGhlcmUgZm9yIG5vdywgYnV0IG1heQoJLy8gYmUgbW92ZWQgaW50byAkLm1vYmlsZSBpZiBvdGhlciBjb21wb25lbnRzIG5lZWQgYSBzaW1pbGFyIG1ldGhvZC4KCV9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBuZXh0UHJvcCwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApIHsKCQl2YXIgaSwgaW1nLCBsZW4gPSBjb250YWluZXJzLmxlbmd0aDsKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlpbWcgPSAkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBjb250YWluZXJzWyBpIF0uZmlyc3RDaGlsZCwgIm5leHRTaWJsaW5nIiwgImltZyIsICJJTUciICkgKTsKCQkJaWYgKCBpbWcubGVuZ3RoICkgewoJCQkJaW1nLmFkZENsYXNzKCAidWktbGktdGh1bWIiICk7CgkJCQkkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBpbWdbIDAgXS5wYXJlbnROb2RlLCAicGFyZW50Tm9kZSIsICJsaSIsICJMSSIgKSApLmFkZENsYXNzKCBpbWcuaXMoICIudWktbGktaWNvbiIgKSA/ICJ1aS1saS1oYXMtaWNvbiIgOiAidWktbGktaGFzLXRodW1iIiApOwoJCQl9CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXRoaXMucGFyZW50UGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJdGhpcy5fY3JlYXRlU3ViUGFnZXMoKTsKCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCSRsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlzZWxmID0gdGhpcywKCQkJZGl2aWRlcnRoZW1lID0gJGxpc3QuanFtRGF0YSggImRpdmlkZXJ0aGVtZSIgKSB8fCBvLmRpdmlkZXJUaGVtZSwKCQkJbGlzdHNwbGl0dGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAic3BsaXR0aGVtZSIgKSwKCQkJbGlzdHNwbGl0aWNvbiA9ICRsaXN0LmpxbURhdGEoICJzcGxpdGljb24iICksCgkJCWxpc3RpY29uID0gJGxpc3QuanFtRGF0YSggImljb24iICksCgkJCWxpID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoICRsaXN0WyAwIF0sICJsaSIsICJMSSIgKSwKCQkJb2wgPSAhISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSwKCQkJanNDb3VudCA9ICEkLnN1cHBvcnQuY3NzUHNldWRvRWxlbWVudCwKCQkJc3RhcnQgPSAkbGlzdC5hdHRyKCAic3RhcnQiICksCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsCgkJCWEsIGxhc3QsIHNwbGl0dGhlbWUsIGNvdW50ZXIsIHN0YXJ0Q291bnQsIG5ld1N0YXJ0Q291bnQsIGNvdW50UGFyZW50LCBpY29uLCBpbWdQYXJlbnRzLCBpbWcsIGxpbmtJY29uOwoKCQlpZiAoIG9sICYmIGpzQ291bnQgKSB7CgkJCSRsaXN0LmZpbmQoICIudWktbGktZGVjIiApLnJlbW92ZSgpOwoJCX0KCgkJaWYgKCBvbCApIHsKCQkJLy8gQ2hlY2sgaWYgYSBzdGFydCBhdHRyaWJ1dGUgaGFzIGJlZW4gc2V0IHdoaWxlIHRha2luZyBhIHZhbHVlIG9mIDAgaW50byBhY2NvdW50CgkJCWlmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSB7CgkJCQlpZiAoICFqc0NvdW50ICkgewoJCQkJCXN0YXJ0Q291bnQgPSBwYXJzZUludCggc3RhcnQgLCAxMCApIC0gMTsKCQkJCQkkbGlzdC5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIHN0YXJ0Q291bnQgKTsKCQkJCX0gZWxzZSB7CgkJCQkJY291bnRlciA9IHBhcnNlSW50KCBzdGFydCAsIDEwICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJY291bnRlciA9IDE7CgkJCX0KCQl9CgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lOwoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQl2YXIgaXNEaXZpZGVyID0gKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApOwoKCQkJCWlmICggYS5sZW5ndGggJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpY29uID0gaXRlbS5qcW1EYXRhKCAiaWNvbiIgKTsKCgkJCQkJaXRlbS5idXR0b25NYXJrdXAoewoJCQkJCQl3cmFwcGVyRWxzOiAiZGl2IiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCWljb25wb3M6ICJyaWdodCIsCgkJCQkJCWljb246IGEubGVuZ3RoID4gMSB8fCBpY29uID09PSBmYWxzZSA/IGZhbHNlIDogaWNvbiB8fCBsaXN0aWNvbiB8fCBvLmljb24sCgkJCQkJCXRoZW1lOiBpdGVtVGhlbWUKCQkJCQl9KTsKCgkJCQkJaWYgKCAoIGljb24gIT09IGZhbHNlICkgJiYgKCBhLmxlbmd0aCA9PT0gMSApICkgewoJCQkJCQlpdGVtLmFkZENsYXNzKCAidWktbGktaGFzLWFycm93IiApOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggInVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gbGlzdHNwbGl0dGhlbWUgfHwgbGFzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lOwoJCQkJCQlsaW5rSWNvbiA9IGxhc3QuanFtRGF0YSggImljb24iICk7CgoJCQkJCQlsYXN0LmFwcGVuZFRvKCBpdGVtICkKCQkJCQkJCS5hdHRyKCAidGl0bGUiLCAkLnRyaW0obGFzdC5nZXRFbmNvZGVkVGV4dCgpKSApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1saS1saW5rLWFsdCIgKQoJCQkJCQkJLmVtcHR5KCkKCQkJCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZSwKCQkJCQkJCQlpY29uOiBmYWxzZSwKCQkJCQkJCQlpY29ucG9zOiAibm90ZXh0IgoJCQkJCQkJfSkKCQkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJCS5hcHBlbmQoCgkJCQkJCQkJCSQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQkJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJCQkJCQl0aGVtZTogc3BsaXR0aGVtZSwKCQkJCQkJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCQkJCQkJLy8gbGluayBpY29uIG92ZXJyaWRlcyBsaXN0IGl0ZW0gaWNvbiBvdmVycmlkZXMgdWwgZWxlbWVudCBvdmVycmlkZXMgb3B0aW9ucwoJCQkJCQkJCQkJaWNvbjogbGlua0ljb24gfHwgaWNvbiB8fCBsaXN0c3BsaXRpY29uIHx8IG8uc3BsaXRJY29uCgkJCQkJCQkJCX0pCgkJCQkJCQkJKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBpc0RpdmlkZXIgKSB7CgoJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWRpdmlkZXIgdWktYmFyLSIgKyAoIGl0ZW0uanFtRGF0YSggInRoZW1lIiApIHx8IGRpdmlkZXJ0aGVtZSApOwoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCgkJCQkJaWYgKCBvbCApIHsKCQkJCQkJLy9yZXNldCBjb3VudGVyIHdoZW4gYSBkaXZpZGVyIGhlYWRpbmcgaXMgZW5jb3VudGVyZWQKCQkJCQkJaWYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApIHsKCQkJCQkJCWlmICggIWpzQ291bnQgKSB7CgkJCQkJCQkJbmV3U3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCAsIDEwICkgLSAxOwoJCQkJCQkJCWl0ZW0uY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBuZXdTdGFydENvdW50ICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWNvdW50ZXIgPSBwYXJzZUludCggc3RhcnQgLCAxMCApOwoJCQkJCQkJfQoJCQkJCQl9IGVsc2UgaWYgKCBqc0NvdW50ICkgewoJCQkJCQkJCWNvdW50ZXIgPSAxOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0gZWxzZSB7CgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktc3RhdGljIHVpLWJ0bi11cC0iICsgaXRlbVRoZW1lOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG9sICYmIGpzQ291bnQgJiYgaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1kaXZpZGVyIiApIDwgMCApIHsKCQkJCWNvdW50UGFyZW50ID0gaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1zdGF0aWMiICkgPiAwID8gaXRlbSA6IGl0ZW0uZmluZCggIi51aS1saW5rLWluaGVyaXQiICk7CgoJCQkJY291bnRQYXJlbnQuYWRkQ2xhc3MoICJ1aS1saS1qc251bWJlcmluZyIgKQoJCQkJCS5wcmVwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWxpLWRlYyc+IiArICggY291bnRlcisrICkgKyAiLiA8L3NwYW4+IiApOwoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtIGFuZCBpdHMKCQkJLy8gYnRuLWlubmVyIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtCgkJLy8gYW5kIHRoZWlyIGJ0bi1pbm5lciBlbGVtZW50cy4gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICkuY2hpbGRyZW4oICIudWktYnRuLWlubmVyIiApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKTsKCQl9CgoJCSRsaXN0LmZpbmQoICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApLmFkZENsYXNzKCAidWktbGktaGVhZGluZyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAicCwgZGwiICkuYWRkQ2xhc3MoICJ1aS1saS1kZXNjIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktYXNpZGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgkJCQkJJHRoaXMucHJlcGVuZFRvKCAkdGhpcy5wYXJlbnQoKSApOyAvL3NoaWZ0IGFzaWRlIHRvIGZyb250IGZvciBjc3MgZmxvYXQKCQkJCX0pCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktY291bnQiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCQkJfSkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArICggJGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUpICsgIiB1aS1idG4tY29ybmVyLWFsbCIgKTsKCgkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBsb29rIGF0IHRoZSBmaXJzdCBpbWFnZSBpbiB0aGUgbGlzdCBpdGVtCgkJLy8gaXRzZWxmLCBhbmQgYW55IC51aS1saW5rLWluaGVyaXQgZWxlbWVudCBpdCBtYXkgY29udGFpbiwgc28gd2UKCQkvLyBjYW4gcGxhY2UgdGhlIGFwcHJvcHJpYXRlIGNsYXNzZXMgb24gdGhlIGltYWdlIGFuZCBsaXN0IGl0ZW0uCgkJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIHNvbWV0aGluZyBsaWtlOgoJCS8vCgkJLy8gICAgbGkuZmluZCgiPmltZzplcSgwKSwgLnVpLWxpbmstaW5oZXJpdD5pbWc6ZXEoMCkiKS5lYWNoKCAuLi4gKTsKCQkvLwoJCS8vIEJ1dCBleGVjdXRpbmcgYSBmaW5kKCkgbGlrZSB0aGF0IG9uIFdpbmRvd3MgUGhvbmUgNy41IHRvb2sgYQoJCS8vIHJlYWxseSBsb25nIHRpbWUuIFdhbGtpbmcgdGhpbmdzIG1hbnVhbGx5IHdpdGggdGhlIGNvZGUgYmVsb3cKCQkvLyBhbGxvd3MgdGhlIDQwMCBsaXN0dmlldyBpdGVtIHBhZ2UgdG8gbG9hZCBpbiBhYm91dCAzIHNlY29uZHMgYXMKCQkvLyBvcHBvc2VkIHRvIDMwIHNlY29uZHMuCgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoICRsaXN0LmZpbmQoICIudWktbGluay1pbmhlcml0IiApICk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCB0aGlzLl9nZXRWaXNpYmxlcyggbGksIGNyZWF0ZSApLCBjcmVhdGUgKTsKCQkvLyBhdXRvZGl2aWRlcnMgYmluZHMgdG8gdGhpcyB0byByZWRyYXcgZGl2aWRlcnMgYWZ0ZXIgdGhlIGxpc3R2aWV3IHJlZnJlc2gKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJyZWZyZXNoIiApOwoJfSwKCgkvL2NyZWF0ZSBhIHN0cmluZyBmb3IgSUQvc3VicGFnZSB1cmwgY3JlYXRpb24KCV9pZFN0cmluZ0VzY2FwZTogZnVuY3Rpb24oIHN0ciApIHsKCQlyZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnLScpOwoJfSwKCglfY3JlYXRlU3ViUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gcGFyZW50TGlzdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXBhcmVudFVybCA9IHBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJcGFyZW50SWQgPSBwYXJlbnRVcmwgfHwgcGFyZW50UGFnZVsgMCBdWyAkLmV4cGFuZG8gXSwKCQkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdC5hdHRyKCAiaWQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRucyA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXMsCgkJCXBlcnNpc3RlbnRGb290ZXJJRCA9IHBhcmVudFBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLmpxbURhdGEoICJpZCIgKSwKCQkJaGFzU3ViUGFnZXM7CgoJCWlmICggdHlwZW9mIGxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPT09ICJ1bmRlZmluZWQiICkgewoJCQlsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID0gLTE7CgkJfQoKCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0SWQgfHwgKytsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdOwoKCQkkKCBwYXJlbnRMaXN0LmZpbmQoICJsaT51bCwgbGk+b2wiICkudG9BcnJheSgpLnJldmVyc2UoKSApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCWxpc3QgPSAkKCB0aGlzICksCgkJCQlsaXN0SWQgPSBsaXN0LmF0dHIoICJpZCIgKSB8fCBwYXJlbnRMaXN0SWQgKyAiLSIgKyBpLAoJCQkJcGFyZW50ID0gbGlzdC5wYXJlbnQoKSwKCQkJCW5vZGVFbHNGdWxsID0gJCggbGlzdC5wcmV2QWxsKCkudG9BcnJheSgpLnJldmVyc2UoKSApLAoJCQkJbm9kZUVscyA9IG5vZGVFbHNGdWxsLmxlbmd0aCA/IG5vZGVFbHNGdWxsIDogJCggIjxzcGFuPiIgKyAkLnRyaW0ocGFyZW50LmNvbnRlbnRzKClbIDAgXS5ub2RlVmFsdWUpICsgIjwvc3Bhbj4iICksCgkJCQl0aXRsZSA9IG5vZGVFbHMuZmlyc3QoKS5nZXRFbmNvZGVkVGV4dCgpLC8vdXJsIGxpbWl0cyB0byBmaXJzdCAzMCBjaGFycyBvZiB0ZXh0CgkJCQlpZCA9ICggcGFyZW50VXJsIHx8ICIiICkgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIj0iICsgbGlzdElkLAoJCQkJdGhlbWUgPSBsaXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lLAoJCQkJY291bnRUaGVtZSA9IGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgcGFyZW50TGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBvLmNvdW50VGhlbWUsCgkJCQluZXdQYWdlLCBhbmNob3I7CgoJCQkvL2RlZmluZSBoYXNTdWJQYWdlcyBmb3IgdXNlIGluIGxhdGVyIHJlbW92YWwKCQkJaGFzU3ViUGFnZXMgPSB0cnVlOwoKCQkJbmV3UGFnZSA9IGxpc3QuZGV0YWNoKCkKCQkJCQkJLndyYXAoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0ncGFnZScgIiArIGRucyArICJ1cmw9JyIgKyBpZCArICInICIgKyBkbnMgKyAidGhlbWU9JyIgKyB0aGVtZSArICInICIgKyBkbnMgKyAiY291bnQtdGhlbWU9JyIgKyBjb3VudFRoZW1lICsgIic+PGRpdiAiICsgZG5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkucGFyZW50KCkKCQkJCQkJCS5iZWZvcmUoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0naGVhZGVyJyAiICsgZG5zICsgInRoZW1lPSciICsgby5oZWFkZXJUaGVtZSArICInPjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgdGl0bGUgKyAiPC9kaXY+PC9kaXY+IiApCgkJCQkJCQkuYWZ0ZXIoIHBlcnNpc3RlbnRGb290ZXJJRCA/ICQoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0nZm9vdGVyJyAiICsgZG5zICsgImlkPSciKyBwZXJzaXN0ZW50Rm9vdGVySUQgKyInPiIgKSA6ICIiICkKCQkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJCS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJbmV3UGFnZS5wYWdlKCk7CgoJCQlhbmNob3IgPSBwYXJlbnQuZmluZCggJ2E6Zmlyc3QnICk7CgoJCQlpZiAoICFhbmNob3IubGVuZ3RoICkgewoJCQkJYW5jaG9yID0gJCggIjxhLz4iICkuaHRtbCggbm9kZUVscyB8fCB0aXRsZSApLnByZXBlbmRUbyggcGFyZW50LmVtcHR5KCkgKTsKCQkJfQoKCQkJYW5jaG9yLmF0dHIoICJocmVmIiwgIiMiICsgaWQgKTsKCgkJfSkubGlzdHZpZXcoKTsKCgkJLy8gb24gcGFnZWhpZGUsIHJlbW92ZSBhbnkgbmVzdGVkIHBhZ2VzIGFsb25nIHdpdGggdGhlIHBhcmVudCBwYWdlLCBhcyBsb25nIGFzIHRoZXkgYXJlbid0IGFjdGl2ZQoJCS8vIGFuZCBhcmVuJ3QgZW1iZWRkZWQKCQlpZiAoIGhhc1N1YlBhZ2VzICYmCgkJCXBhcmVudFBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgJiYKCQkJcGFyZW50UGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkub3B0aW9ucy5kb21DYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQl2YXIgbmV3UmVtb3ZlID0gZnVuY3Rpb24oIGUsIHVpICkgewoJCQkJdmFyIG5leHRQYWdlID0gdWkubmV4dFBhZ2UsIG5wVVJMLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJaWYgKCB1aS5uZXh0UGFnZSApIHsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYgKCBucFVSTC5pbmRleE9mKCBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgIT09IDAgKSB7CgkJCQkJCXNlbGYuY2hpbGRQYWdlcygpLnJlbW92ZSgpOwoJCQkJCQlwYXJlbnRQYWdlLnRyaWdnZXIoIHByRXZlbnQgKTsKCQkJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJCXBhcmVudFBhZ2UucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCgkJCS8vIHVuYmluZCB0aGUgb3JpZ2luYWwgcGFnZSByZW1vdmUgYW5kIHJlcGxhY2Ugd2l0aCBvdXIgc3BlY2lhbGl6ZWQgdmVyc2lvbgoJCQlwYXJlbnRQYWdlCgkJCQkudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApCgkJCQkuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIG5ld1JlbW92ZSk7CgkJfQoJfSwKCgkvLyBUT0RPIHNvcnQgb3V0IGEgYmV0dGVyIHdheSB0byB0cmFjayBzdWIgcGFnZXMgb2YgdGhlIGxpc3R2aWV3IHRoaXMgaXMgYnJpdHRsZQoJY2hpbGRQYWdlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhcmVudFVybCA9IHRoaXMucGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQlyZXR1cm4gJCggIjpqcW1EYXRhKHVybF49JyIrICBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIicpIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQgKSB7Cgl2YXIJbWV0YSA9ICQoICJtZXRhW25hbWU9dmlld3BvcnRdIiApLAoJCWluaXRpYWxDb250ZW50ID0gbWV0YS5hdHRyKCAiY29udGVudCIgKSwKCQlkaXNhYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xLCB1c2VyLXNjYWxhYmxlPW5vIiwKCQllbmFibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEwLCB1c2VyLXNjYWxhYmxlPXllcyIsCgkJZGlzYWJsZWRJbml0aWFsbHkgPSAvKHVzZXItc2NhbGFibGVbXHNdKj1bXHNdKm5vKXwobWF4aW11bS1zY2FsZVtcc10qPVtcc10qMSlbJCxcc10vLnRlc3QoIGluaXRpYWxDb250ZW50ICk7CgoJJC5tb2JpbGUuem9vbSA9ICQuZXh0ZW5kKCB7fSwgewoJCWVuYWJsZWQ6ICFkaXNhYmxlZEluaXRpYWxseSwKCQlsb2NrZWQ6IGZhbHNlLAoJCWRpc2FibGU6IGZ1bmN0aW9uKCBsb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAhJC5tb2JpbGUuem9vbS5sb2NrZWQgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZGlzYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSBmYWxzZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gbG9jayB8fCBmYWxzZTsKCQkJfQoJCX0sCgkJZW5hYmxlOiBmdW5jdGlvbiggdW5sb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAoICEkLm1vYmlsZS56b29tLmxvY2tlZCB8fCB1bmxvY2sgPT09IHRydWUgKSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBlbmFibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gZmFsc2U7CgkJCX0KCQl9LAoJCXJlc3RvcmU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBpbml0aWFsQ29udGVudCApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCX0pOwoKfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQltaW5pOiBmYWxzZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwgaW5wdXRbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCBpbnB1dFt0eXBlPSdudW1iZXInXSwgOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIGlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIGlucHV0W3R5cGU9J2VtYWlsJ10sIGlucHV0W3R5cGU9J3VybCddLCBpbnB1dFt0eXBlPSd0ZWwnXSwgdGV4dGFyZWEsIGlucHV0W3R5cGU9J3RpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZSddLCBpbnB1dFt0eXBlPSdtb250aCddLCBpbnB1dFt0eXBlPSd3ZWVrJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIGlucHV0W3R5cGU9J2NvbG9yJ10sIGlucHV0Om5vdChbdHlwZV0pLCBpbnB1dFt0eXBlPSdmaWxlJ10iLAoJCWNsZWFyQnRuOiBmYWxzZSwKCQljbGVhclNlYXJjaEJ1dHRvblRleHQ6IG51bGwsIC8vZGVwcmVjYXRpbmcgZm9yIDEuMy4uLgoJCWNsZWFyQnRuVGV4dDogImNsZWFyIHRleHQiLAoJCWRpc2FibGVkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdGhlbWUgPSBvLnRoZW1lIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZWNsYXNzICA9ICIgdWktYm9keS0iICsgdGhlbWUsCgkJCW1pbmljbGFzcyA9IG8ubWluaSA/ICIgdWktbWluaSIgOiAiIiwKCQkJaXNTZWFyY2ggPSBpbnB1dC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWZvY3VzZWRFbCwKCQkJY2xlYXJidG4sCgkJCWNsZWFyQnRuVGV4dCA9IG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0IHx8IG8uY2xlYXJCdG5UZXh0LAoJCQljbGVhckJ0bkJsYWNrbGlzdCA9IGlucHV0LmlzKCAidGV4dGFyZWEsIDpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICksCgkJCWlucHV0TmVlZHNDbGVhckJ0biA9ICEhby5jbGVhckJ0biAmJiAhY2xlYXJCdG5CbGFja2xpc3QsCgkJCWlucHV0TmVlZHNXcmFwID0gaW5wdXQuaXMoICJpbnB1dCIgKSAmJiAhaW5wdXQuaXMoICI6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApOwoKCQlmdW5jdGlvbiB0b2dnbGVDbGVhcigpIHsKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQljbGVhcmJ0bi50b2dnbGVDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIsICFpbnB1dC52YWwoKSApOwoJCQl9LCAwICk7CgkJfQoKCQkkKCAibGFiZWxbZm9yPSciICsgaW5wdXQuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktaW5wdXQtdGV4dCIgKTsKCgkJZm9jdXNlZEVsID0gaW5wdXQuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IHVpLWJvZHktIisgdGhlbWUgKTsKCgkJLy8gWFhYOiBUZW1wb3Jhcnkgd29ya2Fyb3VuZCBmb3IgaXNzdWUgNzg1IChBcHBsZSBidWcgODkxMDU4OSkuCgkJLy8gICAgICBUdXJuIG9mZiBhdXRvY29ycmVjdCBhbmQgYXV0b2NvbXBsZXRlIG9uIG5vbi1pT1MgNSBkZXZpY2VzCgkJLy8gICAgICBzaW5jZSB0aGUgcG9wdXAgdGhleSB1c2UgY2FuJ3QgYmUgZGlzbWlzc2VkIGJ5IHRoZSB1c2VyLiBOb3RlCgkJLy8gICAgICB0aGF0IHdlIHRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiB0aGUgZmVhdHVyZSBieSBsb29raW5nIGZvcgoJCS8vICAgICAgdGhlIGF1dG9jb3JyZWN0IHByb3BlcnR5IG9uIHRoZSBpbnB1dCBlbGVtZW50LiBXZSBjdXJyZW50bHkKCQkvLyAgICAgIGhhdmUgbm8gdGVzdCBmb3IgaU9TIDUgb3IgbmV3ZXIgc28gd2UncmUgdGVtcG9yYXJpbHkgdXNpbmcKCQkvLyAgICAgIHRoZSB0b3VjaE92ZXJmbG93IHN1cHBvcnQgZmxhZyBmb3IgalFNIDEuMC4gWWVzLCBJIGZlZWwgZGlydHkuIC0gamJsYXMKCQlpZiAoIHR5cGVvZiBpbnB1dFswXS5hdXRvY29ycmVjdCAhPT0gInVuZGVmaW5lZCIgJiYgISQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICkgewoJCQkvLyBTZXQgdGhlIGF0dHJpYnV0ZSBpbnN0ZWFkIG9mIHRoZSBwcm9wZXJ0eSBqdXN0IGluIGNhc2UgdGhlcmUKCQkJLy8gaXMgY29kZSB0aGF0IGF0dGVtcHRzIHRvIG1ha2UgbW9kaWZpY2F0aW9ucyB2aWEgSFRNTC4KCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvcnJlY3QiLCAib2ZmIiApOwoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCgkJLy8ic2VhcmNoIiBhbmQgInRleHQiIGlucHV0IHdpZGdldHMKCQlpZiAoIGlzU2VhcmNoICkgewoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtc2VhcmNoIHVpLXNoYWRvdy1pbnNldCB1aS1idG4tY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IHVpLWljb24tc2VhcmNoZmllbGQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQl9IGVsc2UgaWYgKCBpbnB1dE5lZWRzV3JhcCApIHsKCQkJZm9jdXNlZEVsID0gaW5wdXQud3JhcCggIjxkaXYgY2xhc3M9J3VpLWlucHV0LXRleHQgdWktc2hhZG93LWluc2V0IHVpLWNvcm5lci1hbGwgdWktYnRuLXNoYWRvdyIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICsgIic+PC9kaXY+IiApLnBhcmVudCgpOwoJCX0KCgkJaWYoIGlucHV0TmVlZHNDbGVhckJ0biB8fCBpc1NlYXJjaCApIHsKCQkJY2xlYXJidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyJyB0aXRsZT0nIiArIGNsZWFyQnRuVGV4dCArICInPiIgKyBjbGVhckJ0blRleHQgKyAiPC9hPiIgKQoJCQkJLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpbnB1dAoJCQkJCQkudmFsKCAiIiApCgkJCQkJCS5mb2N1cygpCgkJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCWNsZWFyYnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KQoJCQkJLmFwcGVuZFRvKCBmb2N1c2VkRWwgKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJaWNvbjogImRlbGV0ZSIsCgkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJbWluaTogby5taW5pCgkJCQl9KTsKCQkJCQoJCQlpZiAoICFpc1NlYXJjaCApIHsKCQkJCWZvY3VzZWRFbC5hZGRDbGFzcyggInVpLWlucHV0LWhhcy1jbGVhciIgKTsKCQkJfQoKCQkJdG9nZ2xlQ2xlYXIoKTsKCgkJCWlucHV0LmJpbmQoICJwYXN0ZSBjdXQga2V5dXAgaW5wdXQgZm9jdXMgY2hhbmdlIGJsdXIiLCB0b2dnbGVDbGVhciApOwoJCX0KCQllbHNlIGlmICggIWlucHV0TmVlZHNXcmFwICYmICFpc1NlYXJjaCApIHsKCQkJaW5wdXQuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLXNoYWRvdy1pbnNldCIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICk7CgkJfQoKCQlpbnB1dC5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBpbnB1dCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJCQlpZiAoIG8ucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJCX0JCQkKCQkJCWZvY3VzZWRFbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmx1cihmdW5jdGlvbigpIHsKCQkJCWZvY3VzZWRFbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJaWYgKCBvLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCX0JCQkJCgkJCX0pOwoKCQkvLyBBdXRvZ3JvdwoJCWlmICggaW5wdXQuaXMoICJ0ZXh0YXJlYSIgKSApIHsKCQkJdmFyIGV4dHJhTGluZUhlaWdodCA9IDE1LAoJCQkJa2V5dXBUaW1lb3V0QnVmZmVyID0gMTAwLAoJCQkJa2V5dXBUaW1lb3V0OwoKCQkJdGhpcy5fa2V5dXAgPSBmdW5jdGlvbigpIHsKCQkJCXZhciBzY3JvbGxIZWlnaHQgPSBpbnB1dFsgMCBdLnNjcm9sbEhlaWdodCwKCQkJCQljbGllbnRIZWlnaHQgPSBpbnB1dFsgMCBdLmNsaWVudEhlaWdodDsKCgkJCQlpZiAoIGNsaWVudEhlaWdodCA8IHNjcm9sbEhlaWdodCApIHsKCQkJCQl2YXIgcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoIGlucHV0LmNzcyggInBhZGRpbmctdG9wIiApICksCgkJCQkJCXBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCBpbnB1dC5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApLAoJCQkJCQlwYWRkaW5nSGVpZ2h0ID0gcGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b207CgkJCQkJCgkJCQkJaW5wdXQuaGVpZ2h0KCBzY3JvbGxIZWlnaHQgLSBwYWRkaW5nSGVpZ2h0ICsgZXh0cmFMaW5lSGVpZ2h0ICk7CgkJCQl9CgkJCX07CgoJCQlpbnB1dC5vbiggImtleXVwIGNoYW5nZSBpbnB1dCBwYXN0ZSIsIGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCBrZXl1cFRpbWVvdXQgKTsKCQkJCWtleXVwVGltZW91dCA9IHNldFRpbWVvdXQoIHNlbGYuX2tleXVwLCBrZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQkJfSk7CgoJCQkvLyBiaW5kaW5nIHRvIHBhZ2VjaGFuZ2UgaGVyZSBlbnN1cmVzIHRoYXQgZm9yIHBhZ2VzIGxvYWRlZCB2aWEKCQkJLy8gYWpheCB0aGUgaGVpZ2h0IGlzIHJlY2FsY3VsYXRlZCB3aXRob3V0IHVzZXIgaW5wdXQKCQkJdGhpcy5fb24oIHRydWUsICQubW9iaWxlLmRvY3VtZW50LCB7ICJwYWdlY2hhbmdlIjogIl9rZXl1cCIgfSk7CgoJCQkvLyBJc3N1ZSA1MDk6IHRoZSBicm93c2VyIGlzIG5vdCBwcm92aWRpbmcgc2Nyb2xsSGVpZ2h0IHByb3Blcmx5IHVudGlsIHRoZSBzdHlsZXMgbG9hZAoJCQlpZiAoICQudHJpbSggaW5wdXQudmFsKCkgKSApIHsKCQkJCS8vIGJpbmQgdG8gdGhlIHdpbmRvdyBsb2FkIHRvIG1ha2Ugc3VyZSB0aGUgaGVpZ2h0IGlzIGNhbGN1bGF0ZWQgYmFzZWQgb24gQk9USAoJCQkJLy8gdGhlIERPTSBhbmQgQ1NTCgkJCQl0aGlzLl9vbiggdHJ1ZSwgJC5tb2JpbGUud2luZG93LCB7ImxvYWQiOiAiX2tleXVwIn0pOwoJCQl9CgkJfQoJCWlmICggaW5wdXQuYXR0ciggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwsCgkJCWlzU2VhcmNoID0gdGhpcy5lbGVtZW50LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJaW5wdXROZWVkc1dyYXAgPSB0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKSAmJiAhdGhpcy5lbGVtZW50LmlzKCAiOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSwKCQkJcGFyZW50TmVlZHNEaXNhYmxlZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICkJJiYgKCBpbnB1dE5lZWRzV3JhcCB8fCBpc1NlYXJjaCApOwoJCQkKCQlpZiAoIHBhcmVudE5lZWRzRGlzYWJsZWQgKSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCQl9IGVsc2UgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgkJfQoJCSRlbC5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsLAoJCQlpc1NlYXJjaCA9IHRoaXMuZWxlbWVudC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWlucHV0TmVlZHNXcmFwID0gdGhpcy5lbGVtZW50LmlzKCAiaW5wdXQiICkgJiYgIXRoaXMuZWxlbWVudC5pcyggIjpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICksCgkJCXBhcmVudE5lZWRzRW5hYmxlZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApCSYmICggaW5wdXROZWVkc1dyYXAgfHwgaXNTZWFyY2ggKTsKCgkJaWYgKCBwYXJlbnROZWVkc0VuYWJsZWQgKSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCQl9IGVsc2UgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgkJfQoJCSRlbC5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyID0gZmFsc2U7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyID0gIkZpbHRlciBpdGVtcy4uLiI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclRoZW1lID0gImMiOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJSZXZlYWwgPSBmYWxzZTsKLy8gVE9ETyByZW5hbWUgY2FsbGJhY2svZGVwcmVjYXRlIGFuZCBkZWZhdWx0IHRvIHRoZSBpdGVtIGl0c2VsZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQKdmFyIGRlZmF1bHRGaWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCB0ZXh0LCBzZWFyY2hWYWx1ZSwgaXRlbSApIHsKCQlyZXR1cm4gdGV4dC50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTE7Cgl9OwoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggInVsLCBvbCIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJdmFyIGxpc3QgPSAkKCB0aGlzICksCgkJbGlzdHZpZXcgPSBsaXN0LmRhdGEoICJtb2JpbGUtbGlzdHZpZXciICk7CgoJaWYgKCAhbGlzdHZpZXcgfHwgIWxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyICkgewoJCXJldHVybjsKCX0KCglpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUmV2ZWFsICkgewoJCWxpc3QuY2hpbGRyZW4oKS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7Cgl9CgoJdmFyIHdyYXBwZXIgPSAkKCAiPGZvcm0+IiwgewoJCQkiY2xhc3MiOiAidWktbGlzdHZpZXctZmlsdGVyIHVpLWJhci0iICsgbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJUaGVtZSwKCQkJInJvbGUiOiAic2VhcmNoIgoJCX0pLnN1Ym1pdCggZnVuY3Rpb24oIGUgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJc2VhcmNoLmJsdXIoKTsKCQl9KSwKCQlvbktleVVwID0gZnVuY3Rpb24oIGUgKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCXZhbCA9IHRoaXMudmFsdWUudG9Mb3dlckNhc2UoKSwKCQkJCWxpc3RJdGVtcyA9IG51bGwsCgkJCQlsaSA9IGxpc3QuY2hpbGRyZW4oKSwKCQkJCWxhc3R2YWwgPSAkdGhpcy5qcW1EYXRhKCAibGFzdHZhbCIgKSArICIiLAoJCQkJY2hpbGRJdGVtcyA9IGZhbHNlLAoJCQkJaXRlbXRleHQgPSAiIiwKCQkJCWl0ZW0sCgkJCQkvLyBDaGVjayBpZiBhIGN1c3RvbSBmaWx0ZXIgY2FsbGJhY2sgYXBwbGllcwoJCQkJaXNDdXN0b21GaWx0ZXJDYWxsYmFjayA9IGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgIT09IGRlZmF1bHRGaWx0ZXJDYWxsYmFjazsKCgkJCWlmICggbGFzdHZhbCAmJiBsYXN0dmFsID09PSB2YWwgKSB7CgkJCQkvLyBFeGVjdXRlIHRoZSBoYW5kbGVyIG9ubHkgb25jZSBwZXIgdmFsdWUgY2hhbmdlCgkJCQlyZXR1cm47CgkJCX0KCgkJCWxpc3R2aWV3Ll90cmlnZ2VyKCAiYmVmb3JlZmlsdGVyIiwgImJlZm9yZWZpbHRlciIsIHsgaW5wdXQ6IHRoaXMgfSApOwoKCQkJLy8gQ2hhbmdlIHZhbCBhcyBsYXN0dmFsIGZvciBuZXh0IGV4ZWN1dGlvbgoJCQkkdGhpcy5qcW1EYXRhKCAibGFzdHZhbCIgLCB2YWwgKTsKCQkJaWYgKCBpc0N1c3RvbUZpbHRlckNhbGxiYWNrIHx8IHZhbC5sZW5ndGggPCBsYXN0dmFsLmxlbmd0aCB8fCB2YWwuaW5kZXhPZiggbGFzdHZhbCApICE9PSAwICkgewoKCQkJCS8vIEN1c3RvbSBmaWx0ZXIgY2FsbGJhY2sgYXBwbGllcyBvciByZW1vdmVkIGNoYXJzIG9yIHBhc3RlZCBzb21ldGhpbmcgdG90YWxseSBkaWZmZXJlbnQsIGNoZWNrIGFsbCBpdGVtcwoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbigpOwoJCQl9IGVsc2UgewoKCQkJCS8vIE9ubHkgY2hhcnMgYWRkZWQsIG5vdCByZW1vdmVkLCBvbmx5IHVzZSB2aXNpYmxlIHN1YnNldAoJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbiggIjpub3QoLnVpLXNjcmVlbi1oaWRkZW4pIiApOwoKCQkJCWlmICggIWxpc3RJdGVtcy5sZW5ndGggJiYgbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJSZXZlYWwgKSB7CgkJCQkJbGlzdEl0ZW1zID0gbGlzdC5jaGlsZHJlbiggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJfQoJCQl9CgoJCQlpZiAoIHZhbCApIHsKCgkJCQkvLyBUaGlzIGhhbmRsZXMgaGlkaW5nIHJlZ3VsYXIgcm93cyB3aXRob3V0IHRoZSB0ZXh0IHdlIHNlYXJjaCBmb3IKCQkJCS8vIGFuZCBhbnkgbGlzdCBkaXZpZGVycyB3aXRob3V0IHJlZ3VsYXIgcm93cyBzaG93biB1bmRlciBpdAoKCQkJCWZvciAoIHZhciBpID0gbGlzdEl0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQkJCWl0ZW0gPSAkKCBsaXN0SXRlbXNbIGkgXSApOwoJCQkJCWl0ZW10ZXh0ID0gaXRlbS5qcW1EYXRhKCAiZmlsdGVydGV4dCIgKSB8fCBpdGVtLnRleHQoKTsKCgkJCQkJaWYgKCBpdGVtLmlzKCAibGk6anFtRGF0YShyb2xlPWxpc3QtZGl2aWRlcikiICkgKSB7CgoJCQkJCQlpdGVtLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIgLCAhY2hpbGRJdGVtcyApOwoKCQkJCQkJLy8gTmV3IGJ1Y2tldCEKCQkJCQkJY2hpbGRJdGVtcyA9IGZhbHNlOwoKCQkJCQl9IGVsc2UgaWYgKCBsaXN0dmlldy5vcHRpb25zLmZpbHRlckNhbGxiYWNrKCBpdGVtdGV4dCwgdmFsLCBpdGVtICkgKSB7CgoJCQkJCQkvL21hcmsgdG8gYmUgaGlkZGVuCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsIHRydWUgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gVGhlcmUncyBhIHNob3duIGl0ZW0gaW4gdGhlIGJ1Y2tldAoJCQkJCQljaGlsZEl0ZW1zID0gdHJ1ZTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU2hvdyBpdGVtcywgbm90IG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICI6bm90KC51aS1maWx0ZXItaGlkZXF1ZXVlKSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBmYWxzZSApOwoKCQkJCS8vIEhpZGUgaXRlbXMsIG1hcmtlZCB0byBiZSBoaWRkZW4KCQkJCWxpc3RJdGVtcwoJCQkJCS5maWx0ZXIoICIudWktZmlsdGVyLWhpZGVxdWV1ZSIgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCB0cnVlICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiwgZmFsc2UgKTsKCgkJCX0gZWxzZSB7CgoJCQkJLy9maWx0ZXJ2YWx1ZSBpcyBlbXB0eSA9PiBzaG93IGFsbAoJCQkJbGlzdEl0ZW1zLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsICEhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJSZXZlYWwgKTsKCQkJfQoJCQlsaXN0dmlldy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggbGksIGxpc3R2aWV3Ll9nZXRWaXNpYmxlcyggbGksIGZhbHNlICksIGZhbHNlICk7CgkJfSwKCQlzZWFyY2ggPSAkKCAiPGlucHV0PiIsIHsKCQkJcGxhY2Vob2xkZXI6IGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIKCQl9KQoJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIsICJzZWFyY2giICkKCQkuanFtRGF0YSggImxhc3R2YWwiLCAiIiApCgkJLmJpbmQoICJrZXl1cCBjaGFuZ2UgaW5wdXQiLCBvbktleVVwICkKCQkuYXBwZW5kVG8oIHdyYXBwZXIgKQoJCS50ZXh0aW5wdXQoKTsKCglpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuaW5zZXQgKSB7CgkJd3JhcHBlci5hZGRDbGFzcyggInVpLWxpc3R2aWV3LWZpbHRlci1pbnNldCIgKTsKCX0KCgl3cmFwcGVyLmJpbmQoICJzdWJtaXQiLCBmdW5jdGlvbigpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9KQoJLmluc2VydEJlZm9yZSggbGlzdCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuYXV0b2RpdmlkZXJzID0gZmFsc2U7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmF1dG9kaXZpZGVyc1NlbGVjdG9yID0gZnVuY3Rpb24oIGVsdCApIHsKCS8vIGxvb2sgZm9yIHRoZSB0ZXh0IGluIHRoZSBnaXZlbiBlbGVtZW50Cgl2YXIgdGV4dCA9ICQudHJpbSggZWx0LnRleHQoKSApIHx8IG51bGw7CgoJaWYgKCAhdGV4dCApIHsKCQlyZXR1cm4gbnVsbDsKCX0KCgkvLyBjcmVhdGUgdGhlIHRleHQgZm9yIHRoZSBkaXZpZGVyIChmaXJzdCB1cHBlcmNhc2VkIGxldHRlcikKCXRleHQgPSB0ZXh0LnNsaWNlKCAwLCAxICkudG9VcHBlckNhc2UoKTsKCglyZXR1cm4gdGV4dDsKfTsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAidWwsb2wiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQkJbGlzdHZpZXcgPSBsaXN0LmRhdGEoICJtb2JpbGUtbGlzdHZpZXciICk7CgoJaWYgKCAhbGlzdHZpZXcgfHwgIWxpc3R2aWV3Lm9wdGlvbnMuYXV0b2RpdmlkZXJzICkgewoJCXJldHVybjsKCX0KCgl2YXIgcmVwbGFjZURpdmlkZXJzID0gZnVuY3Rpb24gKCkgewoJCWxpc3QuZmluZCggImxpOmpxbURhdGEocm9sZT0nbGlzdC1kaXZpZGVyJykiICkucmVtb3ZlKCk7CgoJCXZhciBsaXMgPSBsaXN0LmZpbmQoICdsaScgKSwKCQkJbGFzdERpdmlkZXJUZXh0ID0gbnVsbCwgbGksIGRpdmlkZXJUZXh0OwoKCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBsaXMubGVuZ3RoIDsgaSsrICkgewoJCQlsaSA9IGxpc1tpXTsKCQkJZGl2aWRlclRleHQgPSBsaXN0dmlldy5vcHRpb25zLmF1dG9kaXZpZGVyc1NlbGVjdG9yKCAkKCBsaSApICk7CgoJCQlpZiAoIGRpdmlkZXJUZXh0ICYmIGxhc3REaXZpZGVyVGV4dCAhPT0gZGl2aWRlclRleHQgKSB7CgkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdsaScgKTsKCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBkaXZpZGVyVGV4dCApICk7CgkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ2RhdGEtJyArICQubW9iaWxlLm5zICsgJ3JvbGUnLCAnbGlzdC1kaXZpZGVyJyApOwoJCQkJbGkucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGRpdmlkZXIsIGxpICk7CgkJCX0KCgkJCWxhc3REaXZpZGVyVGV4dCA9IGRpdmlkZXJUZXh0OwoJCX0KCX07CgoJdmFyIGFmdGVyTGlzdHZpZXdSZWZyZXNoID0gZnVuY3Rpb24gKCkgewoJCWxpc3QudW5iaW5kKCAnbGlzdHZpZXdhZnRlcnJlZnJlc2gnLCBhZnRlckxpc3R2aWV3UmVmcmVzaCApOwoJCXJlcGxhY2VEaXZpZGVycygpOwoJCWxpc3R2aWV3LnJlZnJlc2goKTsKCQlsaXN0LmJpbmQoICdsaXN0dmlld2FmdGVycmVmcmVzaCcsIGFmdGVyTGlzdHZpZXdSZWZyZXNoICk7Cgl9OwoKCWFmdGVyTGlzdHZpZXdSZWZyZXNoKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJCggIjpqcW1EYXRhKHJvbGU9J25vanMnKSIsIGUudGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1ub2pzIiApOwoJCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ID0gewoJX2hhbmRsZUZvcm1SZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9kZWxheSggIl9yZXNldCIgKTsKCQkJfQoJCX0pOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKLyoKKiAiY2hlY2tib3hyYWRpbyIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNoZWNrYm94cmFkaW8iLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8IGlucHV0LmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCIgKS5qcW1EYXRhKCBkYXRhQXR0ciApOwoJCQl9LAoJCQkvLyBOT1RFOiBXaW5kb3dzIFBob25lIGNvdWxkIG5vdCBmaW5kIHRoZSBsYWJlbCB0aHJvdWdoIGEgc2VsZWN0b3IKCQkJLy8gZmlsdGVyIHdvcmtzIHRob3VnaC4KCQkJcGFyZW50TGFiZWwgPSAkKCBpbnB1dCApLmNsb3Nlc3QoICJsYWJlbCIgKSwKCQkJbGFiZWwgPSBwYXJlbnRMYWJlbC5sZW5ndGggPyBwYXJlbnRMYWJlbCA6ICQoIGlucHV0ICkuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0LCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpbmQoICJsYWJlbCIgKS5maWx0ZXIoICJbZm9yPSciICsgaW5wdXRbMF0uaWQgKyAiJ10iICkuZmlyc3QoKSwKCQkJaW5wdXR0eXBlID0gaW5wdXRbMF0udHlwZSwKCQkJbWluaSA9IGluaGVyaXRBdHRyKCBpbnB1dCwgIm1pbmkiICkgfHwgby5taW5pLAoJCQljaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9uIiwKCQkJdW5jaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9mZiIsCgkJCWljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApLAoJCQljaGVja2VkQ2xhc3MgPSAidWktIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkQ2xhc3MgPSAidWktIiArIHVuY2hlY2tlZFN0YXRlOwoKCQlpZiAoIGlucHV0dHlwZSAhPT0gImNoZWNrYm94IiAmJiBpbnB1dHR5cGUgIT09ICJyYWRpbyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEV4cG9zZSBmb3Igb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWxhYmVsOiBsYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MsCgkJCWNoZWNrZWRpY29uOiBjaGVja2VkU3RhdGUsCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZFN0YXRlCgkJfSk7CgoJCS8vIElmIHRoZXJlJ3Mgbm8gc2VsZWN0ZWQgdGhlbWUgY2hlY2sgdGhlIGRhdGEgYXR0cgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWxhYmVsLmJ1dHRvbk1hcmt1cCh7CgkJCXRoZW1lOiBvLnRoZW1lLAoJCQlpY29uOiB1bmNoZWNrZWRTdGF0ZSwKCQkJc2hhZG93OiBmYWxzZSwKCQkJbWluaTogbWluaSwKCQkJaWNvbnBvczogaWNvbnBvcwoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS0nICsgaW5wdXR0eXBlOwoKCQlpbnB1dC5hZGQoIGxhYmVsICkud3JhcEFsbCggd3JhcHBlciApOwoKCQlsYWJlbC5iaW5kKHsKCQkJdm1vdXNlb3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAkKCB0aGlzICkucGFyZW50KCkuaXMoICIudWktZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCX0sCgoJCQl2Y2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgoJCQkJaW5wdXQucHJvcCggImNoZWNrZWQiLCBpbnB1dHR5cGUgPT09ICJyYWRpbyIgJiYgdHJ1ZSB8fCAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKTsKCgkJCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCQkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJCQkvLyBUT0RPOiBpdCB3b3VsZCBiZSBuaWNlIHRvIGxldCB0aGUgYnJvd3NlcidzIGhhbmRsZSB0aGUgY2xpY2tzIGFuZCBwYXNzIHRoZW0KCQkJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQkJCWlucHV0LnRyaWdnZXJIYW5kbGVyKCAnY2xpY2snICk7CgoJCQkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCQkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkJCS8vIG9mIG90aGVyIHJhZGlvcyBlbnN1cmVzIHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlIGlzIGFwcGxpZWQgcHJvcGVybHkKCQkJCXNlbGYuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoKCQlpbnB1dAoJCQkuYmluZCh7CgkJCQl2bW91c2Vkb3duOiBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9jYWNoZVZhbHMoKTsKCQkJCX0sCgoJCQkJdmNsaWNrOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQkJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggJHRoaXMgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCSR0aGlzLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX3VwZGF0ZUFsbCgpOwoJCQkJfSwKCgkJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkJbGFiZWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0sCgoJCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfY2FjaGVWYWxzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy9yZXR1cm5zIGVpdGhlciBhIHNldCBvZiByYWRpb3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGF0dHJpYnV0ZSwgb3IgYSBzaW5nbGUgY2hlY2tib3gKCV9nZXRJbnB1dFNldDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0sIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJLmZpbmQoICJpbnB1dFtuYW1lPSciICsgdGhpcy5lbGVtZW50WzBdLm5hbWUgKyAiJ11bdHlwZT0nIiArIHRoaXMuaW5wdXR0eXBlICsgIiddIiApOwoJfSwKCglfdXBkYXRlQWxsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJaWYgKCB0aGlzLmNoZWNrZWQgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudFsgMCBdLAoJCQlhY3RpdmUgPSAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcywKCQkJY2hlY2tlZENsYXNzID0gdGhpcy5jaGVja2VkQ2xhc3MgKyAoIHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiLnVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIiApLmxlbmd0aCA/IGFjdGl2ZSA6ICIiICksCgkJCWxhYmVsID0gdGhpcy5sYWJlbDsKCgkJaWYgKCBpbnB1dC5jaGVja2VkICkgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyArIGFjdGl2ZSApLmFkZENsYXNzKCBjaGVja2VkQ2xhc3MgKS5idXR0b25NYXJrdXAoIHsgaWNvbjogdGhpcy5jaGVja2VkaWNvbiB9ICk7CgkJfSBlbHNlIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIGNoZWNrZWRDbGFzcyApLmFkZENsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICkuYnV0dG9uTWFya3VwKCB7IGljb246IHRoaXMudW5jaGVja2VkaWNvbiB9ICk7CgkJfQoKCQlpZiAoIGlucHV0LmRpc2FibGVkICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVuYWJsZSgpOwoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIHRydWUgKS5wYXJlbnQoKS5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCBmYWxzZSApLnBhcmVudCgpLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY2hlY2tib3hyYWRpby5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiB0cnVlLAoJCWlubGluZTogbnVsbCwKCQltaW5pOiBudWxsLAoJCWluaXRTZWxlY3RvcjogImJ1dHRvbiwgW3R5cGU9J2J1dHRvbiddLCBbdHlwZT0nc3VibWl0J10sIFt0eXBlPSdyZXNldCddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCSRidXR0b24sCgkJCS8vIGNyZWF0ZSBhIGNvcHkgb2YgdGhpcy5vcHRpb25zIHdlIGNhbiBwYXNzIHRvIGJ1dHRvbk1hcmt1cAoJCQlvID0gKCBmdW5jdGlvbiggdGRvICkgewoJCQkJdmFyIGtleSwgcmV0ID0ge307CgoJCQkJZm9yICgga2V5IGluIHRkbyApIHsKCQkJCQlpZiAoIHRkb1sga2V5IF0gIT09IG51bGwgJiYga2V5ICE9PSAiaW5pdFNlbGVjdG9yIiApIHsKCQkJCQkJcmV0WyBrZXkgXSA9IHRkb1sga2V5IF07CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiByZXQ7CgkJCX0gKSggdGhpcy5vcHRpb25zICksCgkJCWNsYXNzZXMgPSAiIiwKCQkJJGJ1dHRvblBsYWNlaG9sZGVyOwoKCQkvLyBpZiB0aGlzIGlzIGEgbGluaywgY2hlY2sgaWYgaXQncyBiZWVuIGVuaGFuY2VkIGFuZCwgaWYgbm90LCB1c2UgdGhlIHJpZ2h0IGZ1bmN0aW9uCgkJaWYgKCAkZWxbIDAgXS50YWdOYW1lID09PSAiQSIgKSB7CgkJCWlmICggISRlbC5oYXNDbGFzcyggInVpLWJ0biIgKSApIHsKCQkJCSRlbC5idXR0b25NYXJrdXAoKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoKCQkvLyBnZXQgdGhlIGluaGVyaXRlZCB0aGVtZQoJCS8vIFRPRE8gY2VudHJhbGl6ZSBmb3IgYWxsIHdpZGdldHMKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJLy8gVE9ETzogUG9zdCAxLjEtLW9uY2Ugd2UgaGF2ZSB0aW1lIHRvIHRlc3QgdGhvcm91Z2hseS0tYW55IGNsYXNzZXMgbWFudWFsbHkgYXBwbGllZCB0byB0aGUgb3JpZ2luYWwgZWxlbWVudCBzaG91bGQgYmUgY2FycmllZCBvdmVyIHRvIHRoZSBlbmhhbmNlZCBlbGVtZW50LCB3aXRoIGFuIGAtZW5oYW5jZWRgIHN1ZmZpeC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU3NwoJCS8qIGlmICggJGVsWzBdLmNsYXNzTmFtZS5sZW5ndGggKSB7CgkJCWNsYXNzZXMgPSAkZWxbMF0uY2xhc3NOYW1lOwoJCX0gKi8KCQlpZiAoICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICJ1aS1idG4tcmlnaHQiOwoJCX0KCgkJaWYgKCAgJGVsLmF0dHIoICJ0eXBlIiApID09PSAic3VibWl0IiB8fCAkZWwuYXR0ciggInR5cGUiICkgPT09ICJyZXNldCIgKSB7CgkJCWlmICggY2xhc3NlcyApIHsKCQkJCWNsYXNzZXMgKz0gIiB1aS1zdWJtaXQiOwoJCQl9IGVsc2UgewoJCQkJY2xhc3NlcyA9ICJ1aS1zdWJtaXQiOwoJCQl9CgkJfQoJCSQoICJsYWJlbFtmb3I9JyIgKyAkZWwuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktc3VibWl0IiApOwoKCQkvLyBBZGQgQVJJQSByb2xlCgkJdGhpcy5idXR0b24gPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJWyAkZWwuaHRtbCgpID8gImh0bWwiIDogInRleHQiIF0oICRlbC5odG1sKCkgfHwgJGVsLnZhbCgpICkKCQkJLmluc2VydEJlZm9yZSggJGVsICkKCQkJLmJ1dHRvbk1hcmt1cCggbyApCgkJCS5hZGRDbGFzcyggY2xhc3NlcyApCgkJCS5hcHBlbmQoICRlbC5hZGRDbGFzcyggInVpLWJ0bi1oaWRkZW4iICkgKTsKCiAgICAgICAgJGJ1dHRvbiA9IHRoaXMuYnV0dG9uOwoKCQkkZWwuYmluZCh7CgkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCSRidXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSwKCgkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJJGJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9CgkJfSk7CgoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3AgPSB7fTsKCgkJb3BbIGtleSBdID0gdmFsdWU7CgkJaWYgKCBrZXkgIT09ICJpbml0U2VsZWN0b3IiICkgewoJCQl0aGlzLmJ1dHRvbi5idXR0b25NYXJrdXAoIG9wICk7CgkJCS8vIFJlY29yZCB0aGUgb3B0aW9uIGNoYW5nZSBpbiB0aGUgb3B0aW9ucyBhbmQgaW4gdGhlIERPTSBkYXRhLSogYXR0cmlidXRlcwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICgga2V5LnJlcGxhY2UoIC8oW0EtWl0pLywgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICksIHZhbHVlICk7CgkJfQoJCXRoaXMuX3N1cGVyKCAiX3NldE9wdGlvbiIsIGtleSwgdmFsdWUgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKTsKCQl0aGlzLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgZmFsc2UgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50OwoKCQlpZiAoICRlbC5wcm9wKCJkaXNhYmxlZCIpICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVuYWJsZSgpOwoJCX0KCgkJLy8gR3JhYiB0aGUgYnV0dG9uJ3MgdGV4dCBlbGVtZW50IGZyb20gaXRzIGltcGxlbWVudGF0aW9uLWluZGVwZW5kZW50IGRhdGEgaXRlbQoJCSQoIHRoaXMuYnV0dG9uLmRhdGEoICdidXR0b25FbGVtZW50cycgKS50ZXh0IClbICRlbC5odG1sKCkgPyAiaHRtbCIgOiAidGV4dCIgXSggJGVsLmh0bWwoKSB8fCAkZWwudmFsKCkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5idXR0b24ucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zbGlkZXIiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7Cgl3aWRnZXRFdmVudFByZWZpeDogInNsaWRlIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiLAoJCW1pbmk6IGZhbHNlLAoJCWhpZ2hsaWdodDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCS8vIFRPRE86IEVhY2ggb2YgdGhlc2Ugc2hvdWxkIGhhdmUgY29tbWVudHMgZXhwbGFpbiB3aGF0IHRoZXkncmUgZm9yCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb250cm9sLCAiYyIgKSwKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJY1R5cGUgPSBjb250cm9sWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJaXNTZWxlY3QgPSB0aGlzLmlzVG9nZ2xlU3dpdGNoID0gY1R5cGUgPT09ICJzZWxlY3QiLAoJCQlpc1Jhbmdlc2xpZGVyID0gY29udHJvbC5wYXJlbnQoKS5pcyggIjpqcW1EYXRhKHJvbGU9J3Jhbmdlc2xpZGVyJykiICksCgkJCXNlbGVjdENsYXNzID0gKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgPyAidWktc2xpZGVyLXN3aXRjaCIgOiAiIiwKCQkJY29udHJvbElEID0gY29udHJvbC5hdHRyKCAiaWQiICksCgkJCSRsYWJlbCA9ICQoICJbZm9yPSciICsgY29udHJvbElEICsgIiddIiApLAoJCQlsYWJlbElEID0gJGxhYmVsLmF0dHIoICJpZCIgKSB8fCBjb250cm9sSUQgKyAiLWxhYmVsIiwKCQkJbGFiZWwgPSAkbGFiZWwuYXR0ciggImlkIiwgbGFiZWxJRCApLAoJCQltaW4gPSAhdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMCwKCQkJbWF4ID0gICF0aGlzLmlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoLTEsCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgkJCW1pbmlDbGFzcyA9ICggdGhpcy5vcHRpb25zLm1pbmkgfHwgY29udHJvbC5qcW1EYXRhKCAibWluaSIgKSApID8gIiB1aS1taW5pIiA6ICIiLAoJCQlkb21IYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKSwKCQkJaGFuZGxlID0gJCggZG9tSGFuZGxlICksCgkJCWRvbVNsaWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJCXNsaWRlciA9ICQoIGRvbVNsaWRlciApLAoJCQl2YWx1ZWJnID0gdGhpcy5vcHRpb25zLmhpZ2hsaWdodCAmJiAhdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyArICIgdWktYnRuLWNvcm5lci1hbGwiOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfSkoKSA6IGZhbHNlLAoJCQlvcHRpb25zLAoJCQl3cmFwcGVyOwoJCQkKCQlkb21IYW5kbGUuc2V0QXR0cmlidXRlKCAiaHJlZiIsICIjIiApOwoJCWRvbVNsaWRlci5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImFwcGxpY2F0aW9uIiApOwoJCWRvbVNsaWRlci5jbGFzc05hbWUgPSBbdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgIiA6ICJ1aS1zbGlkZXItdHJhY2sgIixzZWxlY3RDbGFzcywiIHVpLWJ0bi1kb3duLSIsdHJhY2tUaGVtZSwiIHVpLWJ0bi1jb3JuZXItYWxsIiwgbWluaUNsYXNzXS5qb2luKCAiIiApOwoJCWRvbUhhbmRsZS5jbGFzc05hbWUgPSAidWktc2xpZGVyLWhhbmRsZSI7CgkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKCBkb21IYW5kbGUgKTsKCgkJaGFuZGxlLmJ1dHRvbk1hcmt1cCh7IGNvcm5lcnM6IHRydWUsIHRoZW1lOiB0aGVtZSwgc2hhZG93OiB0cnVlIH0pCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJCQkiYXJpYS12YWx1ZW1pbiI6IG1pbiwKCQkJCQkiYXJpYS12YWx1ZW1heCI6IG1heCwKCQkJCQkiYXJpYS12YWx1ZW5vdyI6IHRoaXMuX3ZhbHVlKCksCgkJCQkJImFyaWEtdmFsdWV0ZXh0IjogdGhpcy5fdmFsdWUoKSwKCQkJCQkidGl0bGUiOiB0aGlzLl92YWx1ZSgpLAoJCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJCQl9KTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2xpZGVyOiBzbGlkZXIsCgkJCWhhbmRsZTogaGFuZGxlLAoJCQl0eXBlOiBjVHlwZSwKCQkJc3RlcDogc3RlcCwKCQkJbWF4OiBtYXgsCgkJCW1pbjogbWluLAoJCQl2YWx1ZWJnOiB2YWx1ZWJnLAoJCQlpc1Jhbmdlc2xpZGVyOiBpc1Jhbmdlc2xpZGVyLAoJCQlkcmFnZ2luZzogZmFsc2UsCgkJCWJlZm9yZVN0YXJ0OiBudWxsLAoJCQl1c2VyTW9kaWZpZWQ6IGZhbHNlLAoJCQltb3VzZU1vdmVkOiBmYWxzZQoJCX0pOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItaW5uZXJvZmZzZXQiOwoKCQkJZm9yICggdmFyIGogPSAwLCBsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7IGogPCBsZW5ndGg7IGorKyApIHsKCQkJCXdyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdICk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggd3JhcHBlciApOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yICggdmFyIGkgPSAwLCBvcHRpb25zQ291bnQgPSBvcHRpb25zLmxlbmd0aDsgaSA8IG9wdGlvbnNDb3VudDsgaSsrICkgewoJCQkJdmFyIHNpZGUgPSAhaSA/ICJiIiA6ICJhIiwKCQkJCQlzbGlkZXJUaGVtZSA9ICFpID8gIiB1aS1idG4tZG93bi0iICsgdHJhY2tUaGVtZSA6ICggIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKSwKCQkJCQlzbGlkZXJMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJCQkJc2xpZGVySW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICk7CgoJCQkJc2xpZGVySW1nLmNsYXNzTmFtZSA9IFsidWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0iLCBzaWRlLCBzbGlkZXJUaGVtZSwgIiB1aS1idG4tY29ybmVyLWFsbCJdLmpvaW4oICIiICk7CgkJCQlzbGlkZXJJbWcuc2V0QXR0cmlidXRlKCAicm9sZSIsICJpbWciICk7CgkJCQlzbGlkZXJJbWcuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRpb25zW2ldLmlubmVySFRNTCApICk7CgkJCQkkKCBzbGlkZXJJbWcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9CgoJCQlzZWxmLl9sYWJlbHMgPSAkKCAiLnVpLXNsaWRlci1sYWJlbCIsIHNsaWRlciApOwoKCQl9CgoJCWxhYmVsLmFkZENsYXNzKCAidWktc2xpZGVyIiApOwoJCQoJCS8vIG1vbml0b3IgdGhlIGlucHV0IGZvciB1cGRhdGVkIHZhbHVlcwoJCWNvbnRyb2wuYWRkQ2xhc3MoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyLXN3aXRjaCIgOiAidWktc2xpZGVyLWlucHV0IiApOwoKCQl0aGlzLl9vbiggY29udHJvbCwgewoJCQkiY2hhbmdlIjogIl9jb250cm9sQ2hhbmdlIiwKCQkJImtleXVwIjogIl9jb250cm9sS2V5dXAiLAoJCQkiYmx1ciI6ICJfY29udHJvbEJsdXIiLAoJCQkidm1vdXNldXAiOiAiX2NvbnRyb2xWTW91c2VVcCIKCQl9KTsKCgkJc2xpZGVyLmJpbmQoICJ2bW91c2Vkb3duIiwgJC5wcm94eSggdGhpcy5fc2xpZGVyVk1vdXNlRG93biwgdGhpcyApICkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQkvLyBXZSBoYXZlIHRvIGluc3RhbnRpYXRlIGEgbmV3IGZ1bmN0aW9uIG9iamVjdCBmb3IgdGhlIHVuYmluZCB0byB3b3JrIHByb3Blcmx5CgkJLy8gc2luY2UgdGhlIG1ldGhvZCBpdHNlbGYgaXMgZGVmaW5lZCBpbiB0aGUgcHJvdG90eXBlIChjYXVzaW5nIGl0IHRvIHVuYmluZCBldmVyeXRoaW5nKQoJCXRoaXMuX29uKCBkb2N1bWVudCwgeyAidm1vdXNlbW92ZSI6ICJfcHJldmVudERvY3VtZW50RHJhZyIgfSk7CgkJdGhpcy5fb24oIHNsaWRlci5hZGQoIGRvY3VtZW50ICksIHsgInZtb3VzZXVwIjogIl9zbGlkZXJWTW91c2VVcCIgfSk7CgoJCXNsaWRlci5pbnNlcnRBZnRlciggY29udHJvbCApOwoKCQkvLyB3cmFwIGluIGEgZGl2IGZvciBzdHlsaW5nIHB1cnBvc2VzCgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiAhaXNSYW5nZXNsaWRlciApIHsKCQkJd3JhcHBlciA9IHRoaXMub3B0aW9ucy5taW5pID8gIjxkaXYgY2xhc3M9J3VpLXNsaWRlciB1aS1taW5pJz4iIDogIjxkaXYgY2xhc3M9J3VpLXNsaWRlcic+IjsKCQkJCgkJCWNvbnRyb2wuYWRkKCBzbGlkZXIgKS53cmFwQWxsKCB3cmFwcGVyICk7CgkJfQoKCQkvLyBPbmx5IGFkZCBmb2N1cyBjbGFzcyB0byB0b2dnbGUgc3dpdGNoLCBzbGlkZXJzIGdldCBpdCBhdXRvbWF0aWNhbGx5IGZyb20gdWktYnRuCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmhhbmRsZS5iaW5kKHsKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0sCgoJCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkJc2xpZGVyLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJLy8gYmluZCB0aGUgaGFuZGxlIGV2ZW50IGNhbGxiYWNrcyBhbmQgc2V0IHRoZSBjb250ZXh0IHRvIHRoZSB3aWRnZXQgaW5zdGFuY2UKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGUsIHsKCQkJInZtb3VzZWRvd24iOiAiX2hhbmRsZVZNb3VzZURvd24iLAoJCQkia2V5ZG93biI6ICJfaGFuZGxlS2V5ZG93biIsCgkJCSJrZXl1cCI6ICJfaGFuZGxlS2V5dXAiCgkJfSk7CgoJCXRoaXMuaGFuZGxlLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSApOwoJfSwKCglfY29udHJvbENoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIGlmIHRoZSB1c2VyIGRyYWdnZWQgdGhlIGhhbmRsZSwgdGhlICJjaGFuZ2UiIGV2ZW50IHdhcyB0cmlnZ2VyZWQgZnJvbSBpbnNpZGUgcmVmcmVzaCgpOyBkb24ndCBjYWxsIHJlZnJlc2goKSBhZ2FpbgoJCWlmICggdGhpcy5fdHJpZ2dlciggImNvbnRyb2xjaGFuZ2UiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoICF0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJCX0KCX0sCgoJX2NvbnRyb2xLZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgeyAvLyBuZWNlc3Nhcnk/CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlLCB0cnVlICk7Cgl9LAoKCV9jb250cm9sQmx1cjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJfSwKCgkvLyBpdCBhcHBlYXJzIHRoZSBjbGlja2luZyB0aGUgdXAgYW5kIGRvd24gYnV0dG9ucyBpbiBjaHJvbWUgb24KCS8vIHJhbmdlL251bWJlciBpbnB1dHMgZG9lc24ndCB0cmlnZ2VyIGEgY2hhbmdlIHVudGlsIHRoZSBmaWVsZCBpcwoJLy8gYmx1cnJlZC4gSGVyZSB3ZSBjaGVjayB0aGlmIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZCBhbmQgcmVmcmVzaAoJX2NvbnRyb2xWTW91c2VVcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMuX2NoZWNrZWRSZWZyZXNoKCk7Cgl9LAoKCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCglfaGFuZGxlVk1vdXNlRG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMuaGFuZGxlLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGluZGV4ID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSW4gYWxsIGNhc2VzIHByZXZlbnQgdGhlIGRlZmF1bHQgYW5kIG1hcmsgdGhlIGhhbmRsZSBhcyBhY3RpdmUKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCWlmICggIXRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCQkJdGhpcy5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgoJCQkJYnJlYWs7CgkJfQoKCQkvLyBtb3ZlIHRoZSBzbGlkZXIgYWNjb3JkaW5nIHRvIHRoZSBrZXlwcmVzcwoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1pbiApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWF4ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCArIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggLSB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCX0KCX0sIC8vIHJlbW92ZSBhY3RpdmUgbWFyawoKCV9oYW5kbGVLZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJdGhpcy5fa2V5U2xpZGluZyA9IGZhbHNlOwoJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQl9Cgl9LAoKCV9zbGlkZXJWTW91c2VEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgISggZXZlbnQud2hpY2ggPT09IDEgfHwgZXZlbnQud2hpY2ggPT09IDAgKSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVzdGFydCIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXRoaXMuZHJhZ2dpbmcgPSB0cnVlOwoJCXRoaXMudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgoJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJdGhpcy5iZWZvcmVTdGFydCA9IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCX0KCgkJCgkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoJCXRoaXMuX3RyaWdnZXIoICJzdGFydCIgKTsKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9zbGlkZXJWTW91c2VVcDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmRyYWdnaW5nICkgewoJCQl0aGlzLmRyYWdnaW5nID0gZmFsc2U7CgoJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCQlpZiAoIHRoaXMubW91c2VNb3ZlZCApIHsKCQkJCQkvLyB0aGlzIGlzIGEgZHJhZywgY2hhbmdlIHRoZSB2YWx1ZSBvbmx5IGlmIHVzZXIgZHJhZ2dlZCBlbm91Z2gKCQkJCQlpZiAoIHRoaXMudXNlck1vZGlmaWVkICkgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgPT09IDAgPyAxIDogMCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCApOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcyBpcyBqdXN0IGEgY2xpY2ssIGNoYW5nZSB0aGUgdmFsdWUKCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgPT09IDAgPyAxIDogMCApOwoJCQkJfQoJCQl9CgoJCQl0aGlzLm1vdXNlTW92ZWQgPSBmYWxzZTsKCQkJdGhpcy5fdHJpZ2dlciggInN0b3AiICk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9wcmV2ZW50RG9jdW1lbnREcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIE5PVEU6IHdlIGRvbid0IGRvIHRoaXMgaW4gcmVmcmVzaCBiZWNhdXNlIHdlIHN0aWxsIHdhbnQgdG8KCQkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiZHJhZyIsIGV2ZW50ICkgPT09IGZhbHNlKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCB0aGlzLmRyYWdnaW5nICYmICF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkKCQkJCS8vIHRoaXMubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJdGhpcy5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCQkJCQoJCQkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoKCQkJCS8vIG9ubHkgYWZ0ZXIgcmVmcmVzaCgpIHlvdSBjYW4gY2FsY3VsYXRlIHRoaXMudXNlck1vZGlmaWVkCgkJCQl0aGlzLnVzZXJNb2RpZmllZCA9IHRoaXMuYmVmb3JlU3RhcnQgIT09IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCglfY2hlY2tlZFJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy52YWx1ZSAhPT0gdGhpcy5fdmFsdWUoKSApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpICk7CgkJfQoJfSwKCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4IDogcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOwoJfSwKCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgZmFsc2UsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IHJldHVybiBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0byBzdXBwb3J0IHByb2dyYW1tYXRpYwoJCS8vICAgICAgIGFsdGVyYXRpb24gb2YgdGhlIGlucHV0IHZhbHVlLCB3aGljaCBzaG91bGQgc3RpbGwgdXBkYXRlIHRoZSBzbGlkZXIKCQkKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXBhcmVudFRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCWxlZnQsIHdpZHRoLCBkYXRhLCB0b2w7CgoJCXNlbGYuc2xpZGVyWzBdLmNsYXNzTmFtZSA9IFsgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgdWktc2xpZGVyLXN3aXRjaCIgOiAidWktc2xpZGVyLXRyYWNrIiwiIHVpLWJ0bi1kb3duLSIgKyB0cmFja1RoZW1lLCcgdWktYnRuLWNvcm5lci1hbGwnLCAoIHRoaXMub3B0aW9ucy5taW5pICkgPyAiIHVpLW1pbmkiOiIiXS5qb2luKCAiIiApOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gc2V0IHRoZSBzdG9yZWQgdmFsdWUgZm9yIGNvbXBhcmlzb24gbGF0ZXIKCQl0aGlzLnZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgdGhpcy5zbGlkZXIuZmluZCggIi51aS1zbGlkZXItYmciICkubGVuZ3RoID09PSAwICkgewoJCQl0aGlzLnZhbHVlYmcgPSAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIjsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2VsZi5zbGlkZXIgKTsKCQkJfSkoKTsKCQl9CgkJdGhpcy5oYW5kbGUuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSk7CgoJCXZhciBweFN0ZXAsIHBlcmNlbnQsCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgkJCWlzSW5wdXQgPSAhdGhpcy5pc1RvZ2dsZVN3aXRjaCwKCQkJb3B0aW9uRWxlbWVudHMgPSBpc0lucHV0ID8gW10gOiBjb250cm9sLmZpbmQoICJvcHRpb24iICksCgkJCW1pbiA9ICBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBvcHRpb25FbGVtZW50cy5sZW5ndGggLSAxLAoJCQlzdGVwID0gKCBpc0lucHV0ICYmIHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA+IDAgKSA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA6IDE7CgkJCQoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCWRhdGEgPSB2YWw7CgkJCS8vIGEgc2xpZ2h0IHRvbGVyYW5jZSBoZWxwZWQgZ2V0IHRvIHRoZSBlbmRzIG9mIHRoZSBzbGlkZXIKCQkJdG9sID0gODsKCgkJCWxlZnQgPSB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0OwoJCQl3aWR0aCA9IHRoaXMuc2xpZGVyLndpZHRoKCk7CgkJCXB4U3RlcCA9IHdpZHRoLygobWF4LW1pbikvc3RlcCk7CgkJCWlmICggIXRoaXMuZHJhZ2dpbmcgfHwKCQkJCQlkYXRhLnBhZ2VYIDwgbGVmdCAtIHRvbCB8fAoJCQkJCWRhdGEucGFnZVggPiBsZWZ0ICsgd2lkdGggKyB0b2wgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBweFN0ZXAgPiAxICkgewoJCQkJcGVyY2VudCA9ICggKCBkYXRhLnBhZ2VYIC0gbGVmdCApIC8gd2lkdGggKSAqIDEwMDsKCQkJfSBlbHNlIHsKCQkJCXBlcmNlbnQgPSBNYXRoLnJvdW5kKCAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDAgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSB8fCAwICkgOiBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJcGVyY2VudCA9ICggcGFyc2VGbG9hdCggdmFsICkgLSBtaW4gKSAvICggbWF4IC0gbWluICkgKiAxMDA7CgkJfQoKCQlpZiAoIGlzTmFOKCBwZXJjZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBuZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YXIgdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCXZhciBhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoKCQl2YXIgcGVyY2VudFBlclN0ZXAgPSAxMDAvKChtYXgtbWluKS9zdGVwKTsKCQkvLyBTaW5jZSBKYXZhU2NyaXB0IGhhcyBwcm9ibGVtcyB3aXRoIGxhcmdlIGZsb2F0cywgcm91bmQKCQkvLyB0aGUgZmluYWwgdmFsdWUgdG8gNSBkaWdpdHMgYWZ0ZXIgdGhlIGRlY2ltYWwgcG9pbnQgKHNlZSBqUXVlcnlVSTogIzQxMjQpCgkJbmV3dmFsID0gcGFyc2VGbG9hdCggYWxpZ25WYWx1ZS50b0ZpeGVkKDUpICk7CgoJCWlmICggdHlwZW9mIHB4U3RlcCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCXB4U3RlcCA9IHdpZHRoIC8gKCAobWF4LW1pbikgLyBzdGVwICk7CgkJfQoJCWlmICggcHhTdGVwID4gMSAmJiBpc0lucHV0ICkgewoJCQlwZXJjZW50ID0gKCBuZXd2YWwgLSBtaW4gKSAqIHBlcmNlbnRQZXJTdGVwICogKCAxIC8gc3RlcCApOwoJCX0KCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCWlmICggbmV3dmFsIDwgbWluICkgewoJCQluZXd2YWwgPSBtaW47CgkJfQoKCQlpZiAoIG5ld3ZhbCA+IG1heCApIHsKCQkJbmV3dmFsID0gbWF4OwoJCX0KCgkJdGhpcy5oYW5kbGUuY3NzKCAibGVmdCIsIHBlcmNlbnQgKyAiJSIgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZW5vdyIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWV0ZXh0IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggInRpdGxlIiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCWlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgkJfQoKCQkvLyBkcmFnIHRoZSBsYWJlbCB3aWR0aHMKCQlpZiAoIHRoaXMuX2xhYmVscyApIHsKCQkJdmFyIGhhbmRsZVBlcmNlbnQgPSB0aGlzLmhhbmRsZS53aWR0aCgpIC8gdGhpcy5zbGlkZXIud2lkdGgoKSAqIDEwMCwKCQkJCWFQZXJjZW50ID0gcGVyY2VudCAmJiBoYW5kbGVQZXJjZW50ICsgKCAxMDAgLSBoYW5kbGVQZXJjZW50ICkgKiBwZXJjZW50IC8gMTAwLAoJCQkJYlBlcmNlbnQgPSBwZXJjZW50ID09PSAxMDAgPyAwIDogTWF0aC5taW4oIGhhbmRsZVBlcmNlbnQgKyAxMDAgLSBhUGVyY2VudCwgMTAwICk7CgoJCQl0aGlzLl9sYWJlbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBhYiA9ICQoIHRoaXMgKS5pcyggIi51aS1zbGlkZXItbGFiZWwtYSIgKTsKCQkJCSQoIHRoaXMgKS53aWR0aCggKCBhYiA/IGFQZXJjZW50IDogYlBlcmNlbnQgICkgKyAiJSIgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICFwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJCXZhciB2YWx1ZUNoYW5nZWQgPSBmYWxzZTsKCgkJCS8vIHVwZGF0ZSBjb250cm9sInMgdmFsdWUKCQkJaWYgKCBpc0lucHV0ICkgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbC52YWwoKSAhPT0gbmV3dmFsOwoJCQkJY29udHJvbC52YWwoIG5ld3ZhbCApOwoJCQl9IGVsc2UgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ID0gbmV3dmFsOwoJCQl9CgkJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWNoYW5nZSIsIHZhbCApID09PSBmYWxzZSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoICFpc2Zyb21Db250cm9sICYmIHZhbHVlQ2hhbmdlZCApIHsKCQkJCWNvbnRyb2wudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKTsKCQl0aGlzLnNsaWRlci5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgZmFsc2UgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApOwoJCXRoaXMuc2xpZGVyLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5zbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS5yYW5nZXNsaWRlciIsICQubW9iaWxlLndpZGdldCwgewoKCQlvcHRpb25zOiB7CgkJCXRoZW1lOiBudWxsLAoJCQl0cmFja1RoZW1lOiBudWxsLAoJCQlkaXNhYmxlZDogZmFsc2UsCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3Jhbmdlc2xpZGVyJykiLAoJCQltaW5pOiBmYWxzZSwKCQkJaGlnaGxpZ2h0OiB0cnVlCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWNvbmRMYWJlbCwKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQllbENsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgOiAidWktcmFuZ2VzbGlkZXIiLAoJCQlfaW5wdXRGaXJzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKSwKCQkJX2lucHV0TGFzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkubGFzdCgpLAoJCQlsYWJlbCA9ICRlbC5maW5kKCAibGFiZWwiICkuZmlyc3QoKSwKCQkJX3NsaWRlckZpcnN0ID0gJC5kYXRhKCBfaW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuc2xpZGVyLAoJCQlfc2xpZGVyTGFzdCA9ICQuZGF0YSggX2lucHV0TGFzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuc2xpZGVyLAoJCQlmaXJzdEhhbmRsZSA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZSwKCQkJX3NsaWRlcnMgPSAkKCAiPGRpdiBjbGFzcz1cInVpLXJhbmdlc2xpZGVyLXNsaWRlcnNcIiAvPiIgKS5hcHBlbmRUbyggJGVsICk7CgkJCQoJCQlpZiAoICRlbC5maW5kKCAibGFiZWwiICkubGVuZ3RoID4gMSApIHsKCQkJCXNlY29uZExhYmVsID0gJGVsLmZpbmQoICJsYWJlbCIgKS5sYXN0KCkuaGlkZSgpOwoJCQl9CgoJCQlfaW5wdXRGaXJzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IiApOwoJCQlfaW5wdXRMYXN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItbGFzdCIgKTsKCQkJJGVsLmFkZENsYXNzKCBlbENsYXNzICk7CgkJCQoJCQlfc2xpZGVyRmlyc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCV9zbGlkZXJMYXN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlsYWJlbC5wcmVwZW5kVG8oICRlbCApOwoJCQlmaXJzdEhhbmRsZS5wcmVwZW5kVG8oIF9zbGlkZXJMYXN0ICk7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lucHV0Rmlyc3Q6IF9pbnB1dEZpcnN0LAoJCQkJX2lucHV0TGFzdDogX2lucHV0TGFzdCwKCQkJCV9zbGlkZXJGaXJzdDogX3NsaWRlckZpcnN0LAoJCQkJX3NsaWRlckxhc3Q6IF9zbGlkZXJMYXN0LAoJCQkJX3RhcmdldFZhbDogbnVsbCwKCQkJCV9zbGlkZXJUYXJnZXQ6IGZhbHNlLAoJCQkJX3NsaWRlcnM6IF9zbGlkZXJzLAoJCQkJX3Byb3h5OiBmYWxzZQoJCQl9KTsKCQkJCgkJCXRoaXMucmVmcmVzaCgpOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dC51aS1zbGlkZXItaW5wdXQiICksIHsKCQkJCSJzbGlkZWJlZm9yZXN0YXJ0IjogIl9zbGlkZWJlZm9yZXN0YXJ0IiwKCQkJCSJzbGlkZXN0b3AiOiAiX3NsaWRlc3RvcCIsCgkJCQkic2xpZGVkcmFnIjogIl9zbGlkZWRyYWciLAoJCQkJInNsaWRlYmVmb3JlY2hhbmdlIjogIl9jaGFuZ2UiLAoJCQkJImJsdXIiOiAiX2NoYW5nZSIsCgkJCQkia2V5dXAiOiAiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKHsKCQkJCSJtb3VzZWRvd24iOiJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQkJInJlc2V0IjoiX2hhbmRsZVJlc2V0IgoJCQl9KTsKCQkJdGhpcy5fb24oIGZpcnN0SGFuZGxlLCB7CgkJCQkidm1vdXNlZG93biI6ICJfZHJhZ0ZpcnN0SGFuZGxlIgoJCQl9KTsKCQl9LAoJCV9oYW5kbGVSZXNldDogZnVuY3Rpb24oKXsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkvL3dlIG11c3Qgd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBiZWZvcmUgdXBkYXRlaW5nIG90aGVyIHdpc2Ugc2xpZGVycyB3aWxsIG5vdCBoYXZlIHVwZGF0ZWQgeWV0CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCl7CgkJCQlzZWxmLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJfSwwKTsKCQl9LAoKCQlfZHJhZ0ZpcnN0SGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vaWYgdGhlIGZpcnN0IGhhbmRsZSBpcyBkcmFnZ2VkIHNlbmQgdGhlIGV2ZW50IHRvIHRoZSBmaXJzdCBzbGlkZXIKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCV9zbGlkZWRyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKSwKCQkJCW90aGVyU2xpZGVyID0gKCBmaXJzdCApID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSBkcmFnIHdhcyBpbml0aWF0ZWQgb24gYW4gZXh0cmVtZSBhbmQgdGhlIG90aGVyIGhhbmRsZSBpcyBmb2N1c2VkIHNlbmQgdGhlIGV2ZW50cyB0bwoJCQkvL3RoZSBjbG9zZXN0IGhhbmRsZQoJCQlpZiAoICggdGhpcy5fcHJveHkgPT09ICJmaXJzdCIgJiYgZmlyc3QgKSB8fCAoIHRoaXMuX3Byb3h5ID09PSAibGFzdCIgJiYgIWZpcnN0ICkgKSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3NsaWRlc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApOwoJCQkKCQkJdGhpcy5fcHJveHkgPSBmYWxzZTsKCQkJLy90aGlzIHN0b3BzIGRyYWdnaW5nIG9mIHRoZSBoYW5kbGUgYW5kIGJyaW5ncyB0aGUgYWN0aXZlIHRyYWNrIHRvIHRoZSBmcm9udCAKCQkJLy90aGlzIG1ha2VzIGNsaWNrcyBvbiB0aGUgdHJhY2sgZ28gdGhlIHRoZSBsYXN0IGhhbmRsZSB1c2VkCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkudHJpZ2dlciggInZtb3VzZXVwIiApOwoJCQl0aGlzLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAxIDogIiIgKTsKCQl9LAoKCQlfc2xpZGViZWZvcmVzdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgdHJhY2sgaXMgdGhlIHRhcmdldCByZW1lbWJlciB0aGlzIGFuZCB0aGUgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCAkKCBldmVudC5vcmlnaW5hbEV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktc2xpZGVyLXRyYWNrIiApICkgewoJCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gdHJ1ZTsKCQkJCXRoaXMuX3RhcmdldFZhbCA9ICQoIGV2ZW50LnRhcmdldCApLnZhbCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3N1cGVyQXBwbHkoIG9wdGlvbnMgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkJJGVsLmZpbmQoICJpbnB1dCIgKS5zbGlkZXIoewoJCQkJdGhlbWU6IG8udGhlbWUsCgkJCQl0cmFja1RoZW1lOiBvLnRyYWNrVGhlbWUsCgkJCQlkaXNhYmxlZDogby5kaXNhYmxlZCwKCQkJCW1pbmk6IG8ubWluaSwKCQkJCWhpZ2hsaWdodDogby5oaWdobGlnaHQKCQkJfSkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJfSwKCgkJX2NoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoIGV2ZW50LnR5cGUgPT09ICJrZXl1cCIgKSB7CgkJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbWluID0gcGFyc2VGbG9hdCggdGhpcy5faW5wdXRGaXJzdC52YWwoKSwgMTAgKSwKCQkJCW1heCA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0TGFzdC52YWwoKSwgMTAgKSwKCQkJCWZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKSwKCQkJCXRoaXNTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0Rmlyc3QgOiB0aGlzLl9pbnB1dExhc3QsCgkJCQlvdGhlclNsaWRlciA9IGZpcnN0ID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCQkJCgkJCQoJCQlpZiggKCB0aGlzLl9pbnB1dEZpcnN0LnZhbCgpID4gdGhpcy5faW5wdXRMYXN0LnZhbCgpICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICYmICEkKGV2ZW50LnRhcmdldCkuaGFzQ2xhc3MoInVpLXNsaWRlci1oYW5kbGUiKSkgKXsKCQkJCXRoaXNTbGlkZXIuYmx1cigpOwoJCQl9IGVsc2UgaWYoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICl7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBtaW4gPiBtYXggJiYgIXRoaXMuX3NsaWRlclRhcmdldCApIHsKCQkJCS8vdGhpcyBwcmV2ZW50cyBtaW4gZnJvbSBiZWluZyBncmVhdGVyIHRoZW4gbWF4CgkJCQl0aGlzU2xpZGVyLnZhbCggZmlyc3QgPyBtYXg6IG1pbiApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQl0aGlzLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQl9IGVsc2UgaWYgKCBtaW4gPiBtYXggKSB7CgkJCQkvL3RoaXMgbWFrZXMgaXQgc28gY2xpY2tzIG9uIHRoZSB0YXJnZXQgb24gZWl0aGVyIGV4dHJlbWUgZ28gdG8gdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCQl0aGlzU2xpZGVyLnZhbCggdGhpcy5fdGFyZ2V0VmFsICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCgkJCQkvL1lvdSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgc28gZmlyc3Qgc2xpZGVyIGlzIHVwZGF0ZWQgYmVmb3JlIHVwZGF0aW5nIHNlY29uZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJb3RoZXJTbGlkZXIudmFsKCBmaXJzdCA/IG1pbjogbWF4ICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuZm9jdXMoKTsKCQkJCQlzZWxmLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAiIiA6IDEgKTsKCQkJCQlzZWxmLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQkJfSwgMCApOwoJCQkJdGhpcy5fcHJveHkgPSAoIGZpcnN0ICkgPyAiZmlyc3QiIDogImxhc3QiOwoJCQl9CgkJCS8vZml4ZXMgaXNzdWUgd2hlcmUgd2hlbiBib3RoIF9zbGlkZXJzIGFyZSBhdCBtaW4gdGhleSBjYW5ub3QgYmUgYWRqdXN0ZWQKCQkJaWYgKCBtaW4gPT09IG1heCApIHsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAxICk7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDAgKTsKCQkJfSBlbHNlIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQl9CgkJCQoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJCgkJCWlmICggbWluID49IG1heCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV91cGRhdGVIaWdobGlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWluID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJbWF4ID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLmxlZnQsIDEwICksCgkJCQl3aWR0aCA9IChtYXggLSBtaW4pOwoKCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktc2xpZGVyLWJnIiApLmNzcyh7CgkJCQkibWFyZ2luLWxlZnQiOiBtaW4gKyAiJSIsCgkJCQkid2lkdGgiOiB3aWR0aCArICIlIgoJCQl9KTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiICkuZmluZCggImxhYmVsIiApLnNob3coKTsKCQkJdGhpcy5faW5wdXRGaXJzdC5hZnRlciggdGhpcy5fc2xpZGVyRmlyc3QgKTsKCQkJdGhpcy5faW5wdXRMYXN0LmFmdGVyKCB0aGlzLl9zbGlkZXJMYXN0ICk7CgkJCXRoaXMuX3NsaWRlcnMucmVtb3ZlKCk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCB1aS1yYW5nZXNsaWRlci1sYXN0IiApLnNsaWRlciggImRlc3Ryb3kiICk7CgkJfQoKCX0pOwoKJC53aWRnZXQoICJtb2JpbGUucmFuZ2VzbGlkZXIiLCAkLm1vYmlsZS5yYW5nZXNsaWRlciwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5yYW5nZXNsaWRlci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWljb246ICJhcnJvdy1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSApIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCglfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7Cgl9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgoJCXRoaXMuc2VsZWN0ID0gdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLndyYXAoICI8ZGl2IGNsYXNzPSd1aS1zZWxlY3QiICsgY2xhc3NlcyArICInPiIgKTsKCQl0aGlzLnNlbGVjdElEICA9IHRoaXMuc2VsZWN0LmF0dHIoICJpZCIgKTsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJRCArIiddIiApLmFkZENsYXNzKCAidWktc2VsZWN0IiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7CgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5zZWxlY3QsICJjIiApOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB3cmFwcGVyID0gdGhpcy5lbGVtZW50LnBhcmVudHMoICIudWktc2VsZWN0IiApOwoJCWlmICggd3JhcHBlci5sZW5ndGggPiAwICkgewoJCQlpZiAoIHdyYXBwZXIuaXMoICIudWktYnRuLWxlZnQsIC51aS1idG4tcmlnaHQiICkgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHdyYXBwZXIuaXMoICIudWktYnRuLWxlZnQiICkgPyAidWktYnRuLWxlZnQiIDogInVpLWJ0bi1yaWdodCIgKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QWZ0ZXIoIHdyYXBwZXIgKTsKCQkJd3JhcHBlci5yZW1vdmUoKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQkvLyBBbGxvd3MgZm9yIGV4dGVuc2lvbiBvZiB0aGUgbmF0aXZlIHNlbGVjdCBmb3IgY3VzdG9tIHNlbGVjdHMgYW5kIG90aGVyIHBsdWdpbnMKCQkvLyBzZWUgc2VsZWN0LmN1c3RvbSBmb3IgZXhhbXBsZSBleHRlbnNpb24KCQkvLyBUT0RPIGV4cGxvcmUgcGx1Z2luIHJlZ2lzdHJhdGlvbgoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVDcmVhdGUiICk7CgoJCXRoaXMuYnV0dG9uID0gdGhpcy5fYnV0dG9uKCk7CgoJCXZhciBzZWxmID0gdGhpcywKCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgoJCQlpbmxpbmUgPSBvcHRpb25zLmlubGluZSB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQltaW5pID0gb3B0aW9ucy5taW5pIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJtaW5pIiApLAoJCQlpY29ucG9zID0gb3B0aW9ucy5pY29uID8gKCBvcHRpb25zLmljb25wb3MgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImljb25wb3MiICkgKSA6IGZhbHNlLAoKCQkJLy8gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbiBhdCBvcHRpb25zLml0ZW0oKSBmdW5jdGlvbiB3aGVuCgkJCS8vIHRoZXJlIGlzIG5vIHNlbGVjdGVkIGl0ZW0KCQkJLy8gc2VsZWN0IGZpcnN0IGluIHRoaXMgY2FzZQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4ID09PSAtMSA/IDAgOiB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgoJCQkvLyBUT0RPIHZhbHVlcyBidXR0b25JZCBhbmQgbWVudUlkIGFyZSB1bmRlZmluZWQgaGVyZQoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmJ1dHRvbk1hcmt1cCggewoJCQkJCXRoZW1lOiBvcHRpb25zLnRoZW1lLAoJCQkJCWljb246IG9wdGlvbnMuaWNvbiwKCQkJCQlpY29ucG9zOiBpY29ucG9zLAoJCQkJCWlubGluZTogaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdywKCQkJCQltaW5pOiBtaW5pCgkJCQl9KTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQoKCQkvLyBBZGQgY291bnRlciBmb3IgbXVsdGkgc2VsZWN0cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50ID0gJCggIjxzcGFuPiIgKQoJCQkJLmFkZENsYXNzKCAidWktbGktY291bnQgdWktYnRuLXVwLWMgdWktYnRuLWNvcm5lci1hbGwiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCd1aS1saS1oYXMtY291bnQnKSApOwoJCX0KCgkJLy8gRGlzYWJsZSBpZiBzcGVjaWZpZWQKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBFdmVudHMgb24gbmF0aXZlIHNlbGVjdAoJCXRoaXMuc2VsZWN0LmNoYW5nZShmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgkJCQoJCQlpZiAoICEhb3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQkJdGhpcy5ibHVyKCk7CgkJCX0KCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMgdm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgkJCX0pCgkJCS5iaW5kKCAidm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gUmVtb3ZlIGFjdGl2ZSBjbGFzcyBvbiBzY3JvbGwvdG91Y2htb3ZlCgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciB2bW91c2VvdXQiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdXQiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYubGFiZWwuYmluZCggImNsaWNrIGZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuYnV0dG9uLmJpbmQoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CQkJCQoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfSwgMCApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsJCQkJCgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQiICk7Cgl9LAoKCXNlbGVjdGVkSW5kaWNlczogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlyZXR1cm4gdGhpcy5zZWxlY3RlZCgpLm1hcChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpLAoJCQl0ZXh0ID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJc3BhbiA9ICQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICk7CgoJCXRoaXMuYnV0dG9uLmZpbmQoICIudWktYnRuLXRleHQiICkuaHRtbChmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxlY3RlZC5sZW5ndGggKSB7CgkJCQl0ZXh0ID0gc2VsZWN0ZWQubWFwKGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQkJfSkuZ2V0KCkuam9pbiggIiwgIiApOwoJCQl9IGVsc2UgewoJCQkJdGV4dCA9IHNlbGYucGxhY2Vob2xkZXI7CgkJCX0KCgkJCS8vIFRPRE8gcG9zc2libHkgYWdncmVnYXRlIG11bHRpcGxlIHNlbGVjdCBvcHRpb24gY2xhc3NlcwoJCQlyZXR1cm4gc3Bhbi50ZXh0KCB0ZXh0ICkKCQkJCS5hZGRDbGFzcyggc2VsZi5zZWxlY3QuYXR0ciggImNsYXNzIiApICkKCQkJCS5hZGRDbGFzcyggc2VsZWN0ZWQuYXR0ciggImNsYXNzIiApICk7CgkJfSk7Cgl9LAoKCXNldEJ1dHRvbkNvdW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCk7CgoJCS8vIG11bHRpcGxlIGNvdW50IGluc2lkZSBidXR0b24KCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudFsgc2VsZWN0ZWQubGVuZ3RoID4gMSA/ICJzaG93IiA6ICJoaWRlIiBdKCkudGV4dCggc2VsZWN0ZWQubGVuZ3RoICk7CgkJfQoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCQl0aGlzLnNldEJ1dHRvbkNvdW50KCk7Cgl9LAoKCS8vIG9wZW4gYW5kIGNsb3NlIHByZXNlcnZlZCBpbiBuYXRpdmUgc2VsZWN0cwoJLy8gdG8gc2ltcGxpZnkgdXNlcnMgY29kZSB3aGVuIGxvb3Bpbmcgb3ZlciBzZWxlY3RzCglvcGVuOiAkLm5vb3AsCgljbG9zZTogJC5ub29wLAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCB0cnVlICk7CgkJdGhpcy5idXR0b24uYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggZmFsc2UgKTsKCQl0aGlzLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnNlbGVjdG1lbnUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCglmdW5jdGlvbiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggd2luU2l6ZSwgc2VnU2l6ZSwgb2Zmc2V0LCBkZXNpcmVkICkgewoJCXZhciByZXQgPSBkZXNpcmVkOwoKCQlpZiAoIHdpblNpemUgPCBzZWdTaXplICkgewoJCQkvLyBDZW50ZXIgc2VnbWVudCBpZiBpdCdzIGJpZ2dlciB0aGFuIHRoZSB3aW5kb3cKCQkJcmV0ID0gb2Zmc2V0ICsgKCB3aW5TaXplIC0gc2VnU2l6ZSApIC8gMjsKCQl9IGVsc2UgewoJCQkvLyBPdGhlcndpc2UgY2VudGVyIGl0IGF0IHRoZSBkZXNpcmVkIGNvb3JkaW5hdGUgd2hpbGUga2VlcGluZyBpdCBjb21wbGV0ZWx5IGluc2lkZSB0aGUgd2luZG93CgkJCXJldCA9IE1hdGgubWluKCBNYXRoLm1heCggb2Zmc2V0LCBkZXNpcmVkIC0gc2VnU2l6ZSAvIDIgKSwgb2Zmc2V0ICsgd2luU2l6ZSAtIHNlZ1NpemUgKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJZnVuY3Rpb24gd2luZG93Q29vcmRzKCkgewoJCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93OwoKCQlyZXR1cm4gewoJCQl4OiAkd2luLnNjcm9sbExlZnQoKSwKCQkJeTogJHdpbi5zY3JvbGxUb3AoKSwKCQkJY3g6ICggd2luZG93LmlubmVyV2lkdGggfHwgJHdpbi53aWR0aCgpICksCgkJCWN5OiAoIHdpbmRvdy5pbm5lckhlaWdodCB8fCAkd2luLmhlaWdodCgpICkKCQl9OwoJfQoKCSQud2lkZ2V0KCAibW9iaWxlLnBvcHVwIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCQlzaGFkb3c6IHRydWUsCgkJCWNvcm5lcnM6IHRydWUsCgkJCXRyYW5zaXRpb246ICJub25lIiwKCQkJcG9zaXRpb25UbzogIm9yaWdpbiIsCgkJCXRvbGVyYW5jZTogbnVsbCwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSIsCgkJCWNsb3NlTGlua1NlbGVjdG9yOiAiYTpqcW1EYXRhKHJlbD0nYmFjaycpIiwKCQkJY2xvc2VMaW5rRXZlbnRzOiAiY2xpY2sucG9wdXAiLAoJCQluYXZpZ2F0ZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIiwKCQkJY2xvc2VFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCBwYWdlYmVmb3JlY2hhbmdlLnBvcHVwIiwKCQkJZGlzbWlzc2libGU6IHRydWUsCgoJCQkvLyBOT1RFIFdpbmRvd3MgUGhvbmUgNyBoYXMgYSBzY3JvbGwgcG9zaXRpb24gY2FjaGluZyBpc3N1ZSB0aGF0CgkJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCQkvLyAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDc4NAoJCQkvLwoJCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJCWhpc3Rvcnk6ICEkLm1vYmlsZS5icm93c2VyLm9sZElFCgkJfSwKCgkJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCWlmICggdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQkJdGhpcy5jbG9zZSgpOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9LAoKCQkvLyBNYWtlIHN1cmUgdGhlIHNjcmVlbiBzaXplIGlzIGluY3JlYXNlZCBiZXlvbmQgdGhlIHBhZ2UgaGVpZ2h0IGlmIHRoZSBwb3B1cCdzIGNhdXNlcyB0aGUgZG9jdW1lbnQgdG8gaW5jcmVhc2UgaW4gaGVpZ2h0CgkJX3Jlc2l6ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJCXZhciBwb3B1cEhlaWdodCA9IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApOwoKCQkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQkJaWYgKCBwb3B1cEhlaWdodCA+IHRoaXMuX3VpLnNjcmVlbi5oZWlnaHQoKSApIHsKCQkJCXRoaXMuX3VpLnNjcmVlbi5oZWlnaHQoIHBvcHVwSGVpZ2h0ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlV2luZG93S2V5VXA6IGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiBlLmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRVNDQVBFICkgewoJCQkJcmV0dXJuIHRoaXMuX2VhdEV2ZW50QW5kQ2xvc2UoIGUgKTsKCQkJfQoJCX0sCgoJCV9leHBlY3RSZXNpemVFdmVudDogZnVuY3Rpb24oKSB7CgkJCXZhciB3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKTsKCgkJCWlmICggdGhpcy5fcmVzaXplRGF0YSApIHsKCQkJCWlmICggd2luQ29vcmRzLnggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLnggJiYKCQkJCQl3aW5Db29yZHMueSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMueSAmJgoJCQkJCXdpbkNvb3Jkcy5jeCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMuY3ggJiYKCQkJCQl3aW5Db29yZHMuY3kgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN5ICkgewoJCQkJCS8vIHRpbWVvdXQgbm90IHJlZnJlc2hlZAoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY2xlYXIgZXhpc3RpbmcgdGltZW91dCAtIGl0IHdpbGwgYmUgcmVmcmVzaGVkIGJlbG93CgkJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9yZXNpemVEYXRhLnRpbWVvdXRJZCApOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl9yZXNpemVEYXRhID0gewoJCQkJdGltZW91dElkOiBzZXRUaW1lb3V0KCAkLnByb3h5KCB0aGlzLCAiX3Jlc2l6ZVRpbWVvdXQiICksIDIwMCApLAoJCQkJd2luQ29vcmRzOiB3aW5Db29yZHMKCQkJfTsKCgkJCXJldHVybiB0cnVlOwoJCX0sCgoJCV9yZXNpemVUaW1lb3V0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQlpZiAoICF0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpICkgewoJCQkJCWlmICggdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1vcGVuIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKTsKCQkJCQkJdGhpcy5yZXBvc2l0aW9uKCB7IHBvc2l0aW9uVG86ICJ3aW5kb3ciIH0gKTsKCQkJCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJCQkJfQoKCQkJCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJCX0KCQl9LAoKCQlfaWdub3JlUmVzaXplRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJaWYgKCB0aGlzLl9pZ25vcmVSZXNpemVUbyApIHsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5faWdub3JlUmVzaXplVG8gKTsKCQkJfQoJCQl0aGlzLl9pZ25vcmVSZXNpemVUbyA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgeyBzZWxmLl9pZ25vcmVSZXNpemVUbyA9IDA7IH0sIDEwMDAgKTsKCQl9LAoKCQlfaGFuZGxlV2luZG93UmVzaXplOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCQlpZiAoICggdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSB8fCB0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgKSAmJgoJCQkJCSF0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtY2xvc2UgdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApCgkJCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJCQl9CgkJCX0KCQl9LAoKCQlfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2U6IGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoICF0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgJiYgdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQkJdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKTsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IHRydWU7CgkJCX0KCQl9LAoKCQkvLyBXaGVuIHRoZSBwb3B1cCBpcyBvcGVuLCBhdHRlbXB0aW5nIHRvIGZvY3VzIG9uIGFuIGVsZW1lbnQgdGhhdCBpcyBub3QgYQoJCS8vIGNoaWxkIG9mIHRoZSBwb3B1cCB3aWxsIHJlZGlyZWN0IGZvY3VzIHRvIHRoZSBwb3B1cAoJCV9oYW5kbGVEb2N1bWVudEZvY3VzSW46IGZ1bmN0aW9uKCBlICkgewoJCQl2YXIgdGd0ID0gZS50YXJnZXQsICR0Z3QsIHVpID0gdGhpcy5fdWk7CgoJCQlpZiAoICF0aGlzLl9pc09wZW4gKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGd0ICE9PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJCSR0Z3QgPSAkKCBlLnRhcmdldCApOwoJCQkJaWYgKCAwID09PSAkdGd0LnBhcmVudHMoKS5maWx0ZXIoIHVpLmNvbnRhaW5lclsgMCBdICkubGVuZ3RoICkgewoJCQkJCSQoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgKS5vbmUoICJmb2N1cyIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQkkdGd0LmJsdXIoKTsKCQkJCQl9KTsKCQkJCQl1aS5mb2N1c0VsZW1lbnQuZm9jdXMoKTsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9IGVsc2UgaWYgKCB1aS5mb2N1c0VsZW1lbnRbIDAgXSA9PT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCQkJdWkuZm9jdXNFbGVtZW50ID0gJHRndDsKCQkJCX0KCQkJfQoKCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciB1aSA9IHsKCQkJCQlzY3JlZW46ICQoICI8ZGl2IGNsYXNzPSd1aS1zY3JlZW4taGlkZGVuIHVpLXBvcHVwLXNjcmVlbic+PC9kaXY+IiApLAoJCQkJCXBsYWNlaG9sZGVyOiAkKCAiPGRpdiBzdHlsZT0nZGlzcGxheTogbm9uZTsnPjwhLS0gcGxhY2Vob2xkZXIgLS0+PC9kaXY+IiApLAoJCQkJCWNvbnRhaW5lcjogJCggIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWNvbnRhaW5lciB1aS1wb3B1cC1oaWRkZW4nPjwvZGl2PiIgKQoJCQkJfSwKCQkJCXRoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJCW15SWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApLAoJCQkJc2VsZiA9IHRoaXM7CgoJCQkvLyBXZSBuZWVkIHRvIGFkanVzdCB0aGUgaGlzdG9yeSBvcHRpb24gdG8gYmUgZmFsc2UgaWYgdGhlcmUncyBubyBBSkFYIG5hdi4KCQkJLy8gV2UgY2FuJ3QgZG8gaXQgaW4gdGhlIG9wdGlvbiBkZWNsYXJhdGlvbnMgYmVjYXVzZSB0aG9zZSBhcmUgcnVuIGJlZm9yZQoJCQkvLyBpdCBpcyBkZXRlcm1pbmVkIHdoZXRoZXIgdGhlcmUgc2hhbGwgYmUgQUpBWCBuYXYuCgkJCXRoaXMub3B0aW9ucy5oaXN0b3J5ID0gdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCQlpZiAoIHRoaXNQYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJCXRoaXNQYWdlID0gJCggImJvZHkiICk7CgkJCX0KCgkJCS8vIGRlZmluZSB0aGUgY29udGFpbmVyIGZvciBuYXZpZ2F0aW9uIGV2ZW50IGJpbmRpbmdzCgkJCS8vIFRPRE8gdGhpcyB3b3VsZCBiZSBuaWNlIGF0IHRoZSB0aGUgbW9iaWxlIHdpZGdldCBsZXZlbAoJCQl0aGlzLm9wdGlvbnMuY29udGFpbmVyID0gdGhpcy5vcHRpb25zLmNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkJLy8gQXBwbHkgdGhlIHByb3RvCgkJCXRoaXNQYWdlLmFwcGVuZCggdWkuc2NyZWVuICk7CgkJCXVpLmNvbnRhaW5lci5pbnNlcnRBZnRlciggdWkuc2NyZWVuICk7CgkJCS8vIExlYXZlIGEgcGxhY2Vob2xkZXIgd2hlcmUgdGhlIGVsZW1lbnQgdXNlZCB0byBiZQoJCQl1aS5wbGFjZWhvbGRlci5pbnNlcnRBZnRlciggdGhpcy5lbGVtZW50ICk7CgkJCWlmICggbXlJZCApIHsKCQkJCXVpLnNjcmVlbi5hdHRyKCAiaWQiLCBteUlkICsgIi1zY3JlZW4iICk7CgkJCQl1aS5jb250YWluZXIuYXR0ciggImlkIiwgbXlJZCArICItcG9wdXAiICk7CgkJCQl1aS5wbGFjZWhvbGRlci5odG1sKCAiPCEtLSBwbGFjZWhvbGRlciBmb3IgIiArIG15SWQgKyAiIC0tPiIgKTsKCQkJfQoJCQl1aS5jb250YWluZXIuYXBwZW5kKCB0aGlzLmVsZW1lbnQgKTsKCQkJdWkuZm9jdXNFbGVtZW50ID0gdWkuY29udGFpbmVyOwoKCQkJLy8gQWRkIGNsYXNzIHRvIHBvcHVwIGVsZW1lbnQKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktcG9wdXAiICk7CgoJCQkvLyBEZWZpbmUgaW5zdGFuY2UgdmFyaWFibGVzCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfc2Nyb2xsVG9wOiAwLAoJCQkJX3BhZ2U6IHRoaXNQYWdlLAoJCQkJX3VpOiB1aSwKCQkJCV9mYWxsYmFja1RyYW5zaXRpb246ICIiLAoJCQkJX2N1cnJlbnRUcmFuc2l0aW9uOiBmYWxzZSwKCQkJCV9wcmVyZXFzOiBudWxsLAoJCQkJX2lzT3BlbjogZmFsc2UsCgkJCQlfdG9sZXJhbmNlOiBudWxsLAoJCQkJX3Jlc2l6ZURhdGE6IG51bGwsCgkJCQlfaWdub3JlUmVzaXplVG86IDAsCgkJCQlfb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzOiBmYWxzZQoJCQl9KTsKCgkJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCS8vIENhdXNlIGluaXRpYWwgb3B0aW9ucyB0byBiZSBhcHBsaWVkIGJ5IHRoZWlyIGhhbmRsZXIgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyB0aGUgb3B0aW9uIHRvIHVuZGVmaW5lZAoJCQkJLy8gLSB0aGUgaGFuZGxlciB0aGVuIHNldHMgaXQgdG8gdGhlIGluaXRpYWwgdmFsdWUKCQkJCXNlbGYub3B0aW9uc1sga2V5IF0gPSB1bmRlZmluZWQ7CgkJCQlzZWxmLl9zZXRPcHRpb24oIGtleSwgdmFsdWUsIHRydWUgKTsKCQkJfSk7CgoJCQl1aS5zY3JlZW4uYmluZCggInZjbGljayIsICQucHJveHkoIHRoaXMsICJfZWF0RXZlbnRBbmRDbG9zZSIgKSApOwoKCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgewoJCQkJb3JpZW50YXRpb25jaGFuZ2U6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2UiICksCgkJCQlyZXNpemU6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93UmVzaXplIiApLAoJCQkJa2V5dXA6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93S2V5VXAiICkKCQkJfSk7CgkJCXRoaXMuX29uKCAkLm1vYmlsZS5kb2N1bWVudCwgewoJCQkJZm9jdXNpbjogJC5wcm94eSggdGhpcywgIl9oYW5kbGVEb2N1bWVudEZvY3VzSW4iICkKCQkJfSk7CgkJfSwKCgkJX2FwcGx5VGhlbWU6IGZ1bmN0aW9uKCBkc3QsIHRoZW1lLCBwcmVmaXggKSB7CgkJCXZhciBjbGFzc2VzID0gKCBkc3QuYXR0ciggImNsYXNzIiApIHx8ICIiKS5zcGxpdCggIiAiICksCgkJCQlhbHJlYWR5QWRkZWQgPSB0cnVlLAoJCQkJY3VycmVudFRoZW1lID0gbnVsbCwKCQkJCW1hdGNoZXMsCgkJCQl0aGVtZVN0ciA9IFN0cmluZyggdGhlbWUgKTsKCgkJCXdoaWxlICggY2xhc3Nlcy5sZW5ndGggPiAwICkgewoJCQkJY3VycmVudFRoZW1lID0gY2xhc3Nlcy5wb3AoKTsKCQkJCW1hdGNoZXMgPSAoIG5ldyBSZWdFeHAoICJedWktIiArIHByZWZpeCArICItKFthLXpdKSQiICkgKS5leGVjKCBjdXJyZW50VGhlbWUgKTsKCQkJCWlmICggbWF0Y2hlcyAmJiBtYXRjaGVzLmxlbmd0aCA+IDEgKSB7CgkJCQkJY3VycmVudFRoZW1lID0gbWF0Y2hlc1sgMSBdOwoJCQkJCWJyZWFrOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50VGhlbWUgPSBudWxsOwoJCQkJfQoJCQl9CgoJCQlpZiAoIHRoZW1lICE9PSBjdXJyZW50VGhlbWUgKSB7CgkJCQlkc3QucmVtb3ZlQ2xhc3MoICJ1aS0iICsgcHJlZml4ICsgIi0iICsgY3VycmVudFRoZW1lICk7CgkJCQlpZiAoICEgKCB0aGVtZSA9PT0gbnVsbCB8fCB0aGVtZSA9PT0gIm5vbmUiICkgKSB7CgkJCQkJZHN0LmFkZENsYXNzKCAidWktIiArIHByZWZpeCArICItIiArIHRoZW1lU3RyICk7CgkJCQl9CgkJCX0KCQl9LAoKCQlfc2V0VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5fYXBwbHlUaGVtZSggdGhpcy5lbGVtZW50LCB2YWx1ZSwgImJvZHkiICk7CgkJfSwKCgkJX3NldE92ZXJsYXlUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9hcHBseVRoZW1lKCB0aGlzLl91aS5zY3JlZW4sIHZhbHVlLCAib3ZlcmxheSIgKTsKCgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJdGhpcy5fdWkuc2NyZWVuLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQl9LAoKCQlfc2V0U2hhZG93OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW92ZXJsYXktc2hhZG93IiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0Q29ybmVyczogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9LAoKCQlfYXBwbHlUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCWlmICggdmFsdWUgJiYgdmFsdWUgIT09ICJub25lIiApIHsKCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPT09ICJub25lIiApIHsKCQkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAiIjsKCQkJCX0KCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCX0KCQl9LAoKCQlfc2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oIHZhbHVlICkgewoJCQlpZiAoICF0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggdmFsdWUgKTsKCQkJfQoJCX0sCgoJCV9zZXRUb2xlcmFuY2U6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIHRvbCA9IHsgdDogMzAsIHI6IDE1LCBiOiAzMCwgbDogMTUgfTsKCgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXZhciBhciA9IFN0cmluZyggdmFsdWUgKS5zcGxpdCggIiwiICk7CgoJCQkJJC5lYWNoKCBhciwgZnVuY3Rpb24oIGlkeCwgdmFsICkgeyBhclsgaWR4IF0gPSBwYXJzZUludCggdmFsLCAxMCApOyB9ICk7CgoJCQkJc3dpdGNoKCBhci5sZW5ndGggKSB7CgkJCQkJLy8gQWxsIHZhbHVlcyBhcmUgdG8gYmUgdGhlIHNhbWUKCQkJCQljYXNlIDE6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IHRvbC5yID0gdG9sLmIgPSB0b2wubCA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCS8vIFRoZSBmaXJzdCB2YWx1ZSBkZW5vdGVzIHRvcC9ib3R0b20gdG9sZXJhbmNlLCBhbmQgdGhlIHNlY29uZCB2YWx1ZSBkZW5vdGVzIGxlZnQvcmlnaHQgdG9sZXJhbmNlCgkJCQkJY2FzZSAyOgoJCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQkJdG9sLnQgPSB0b2wuYiA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJCXRvbC5sID0gdG9sLnIgPSBhclsgMSBdOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoKCQkJCQkvLyBUaGUgYXJyYXkgY29udGFpbnMgdmFsdWVzIGluIHRoZSBvcmRlciB0b3AsIHJpZ2h0LCBib3R0b20sIGxlZnQKCQkJCQljYXNlIDQ6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJCXRvbC5yID0gYXJbIDEgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDIgXSApICkgewoJCQkJCQkJdG9sLmIgPSBhclsgMiBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMyBdICkgKSB7CgkJCQkJCQl0b2wubCA9IGFyWyAzIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCWRlZmF1bHQ6CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl90b2xlcmFuY2UgPSB0b2w7CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCXZhciBleGNsdXNpb25zLCBzZXR0ZXIgPSAiX3NldCIgKyBrZXkuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIGtleS5zbGljZSggMSApOwoKCQkJaWYgKCB0aGlzWyBzZXR0ZXIgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpc1sgc2V0dGVyIF0oIHZhbHVlICk7CgkJCX0KCgkJCS8vIFRPRE8gUkVNT1ZFIEZPUiAxLjIuMSBieSBtb3ZpbmcgdGhlbSBvdXQgdG8gYSBkZWZhdWx0IG9wdGlvbnMgb2JqZWN0CgkJCWV4Y2x1c2lvbnMgPSBbCgkJCQkiaW5pdFNlbGVjdG9yIiwKCQkJCSJjbG9zZUxpbmtTZWxlY3RvciIsCgkJCQkiY2xvc2VMaW5rRXZlbnRzIiwKCQkJCSJuYXZpZ2F0ZUV2ZW50cyIsCgkJCQkiY2xvc2VFdmVudHMiLAoJCQkJImhpc3RvcnkiLAoJCQkJImNvbnRhaW5lciIKCQkJXTsKCgkJCSQubW9iaWxlLndpZGdldC5wcm90b3R5cGUuX3NldE9wdGlvbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCWlmICggJC5pbkFycmF5KCBrZXksIGV4Y2x1c2lvbnMgKSA9PT0gLTEgKSB7CgkJCQkvLyBSZWNvcmQgdGhlIG9wdGlvbiBjaGFuZ2UgaW4gdGhlIG9wdGlvbnMgYW5kIGluIHRoZSBET00gZGF0YS0qIGF0dHJpYnV0ZXMKCQkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgKCBrZXkucmVwbGFjZSggLyhbQS1aXSkvLCAiLSQxIiApLnRvTG93ZXJDYXNlKCkgKSwgdmFsdWUgKTsKCQkJfQoJCX0sCgoJCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCgkJX3BsYWNlbWVudENvb3JkczogZnVuY3Rpb24oIGRlc2lyZWQgKSB7CgkJCS8vIHJlY3RhbmdsZSB3aXRoaW4gd2hpY2ggdGhlIHBvcHVwIG11c3QgZml0CgkJCXZhcgoJCQkJd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCksCgkJCQlyYyA9IHsKCQkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCQl5OiB3aW5Db29yZHMueSArIHRoaXMuX3RvbGVyYW5jZS50LAoJCQkJCWN4OiB3aW5Db29yZHMuY3ggLSB0aGlzLl90b2xlcmFuY2UubCAtIHRoaXMuX3RvbGVyYW5jZS5yLAoJCQkJCWN5OiB3aW5Db29yZHMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCQl9LAoJCQkJbWVudVNpemUsIHJldDsKCgkJCS8vIENsYW1wIHRoZSB3aWR0aCBvZiB0aGUgbWVudSBiZWZvcmUgZ3JhYmJpbmcgaXRzIHNpemUKCQkJdGhpcy5fdWkuY29udGFpbmVyLmNzcyggIm1heC13aWR0aCIsIHJjLmN4ICk7CgkJCW1lbnVTaXplID0gewoJCQkJY3g6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlcldpZHRoKCB0cnVlICksCgkJCQljeTogdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICkKCQkJfTsKCgkJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCQkvLyB0aGUgd2luZG93IHRvbGVyYW5jZXMuIFRoaXMgd2lsbCBjZW50ZXIgd3J0LiB0aGUgd2luZG93IGlmIHRoZSBwb3B1cCBpcyB0b28gbGFyZ2UuCgkJCXJldCA9IHsKCQkJCXg6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByYy5jeCwgbWVudVNpemUuY3gsIHJjLngsIGRlc2lyZWQueCApLAoJCQkJeTogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJjLmN5LCBtZW51U2l6ZS5jeSwgcmMueSwgZGVzaXJlZC55ICkKCQkJfTsKCgkJCS8vIE1ha2Ugc3VyZSB0aGUgdG9wIG9mIHRoZSBtZW51IGlzIHZpc2libGUKCQkJcmV0LnkgPSBNYXRoLm1heCggMCwgcmV0LnkgKTsKCgkJCS8vIElmIHRoZSBoZWlnaHQgb2YgdGhlIG1lbnUgaXMgc21hbGxlciB0aGFuIHRoZSBoZWlnaHQgb2YgdGhlIGRvY3VtZW50CgkJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQkJLy8gZml4IGZvciAkLm1vYmlsZS5kb2N1bWVudC5oZWlnaHQoKSBidWcgaW4gY29yZSAxLjcuMi4KCQkJdmFyIGRvY0VsID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBkb2NCb2R5ID0gZG9jdW1lbnQuYm9keSwKCQkJCWRvY0hlaWdodCA9IE1hdGgubWF4KCBkb2NFbC5jbGllbnRIZWlnaHQsIGRvY0JvZHkuc2Nyb2xsSGVpZ2h0LCBkb2NCb2R5Lm9mZnNldEhlaWdodCwgZG9jRWwuc2Nyb2xsSGVpZ2h0LCBkb2NFbC5vZmZzZXRIZWlnaHQgKTsKCgkJCXJldC55IC09IE1hdGgubWluKCByZXQueSwgTWF0aC5tYXgoIDAsIHJldC55ICsgbWVudVNpemUuY3kgLSBkb2NIZWlnaHQgKSApOwoKCQkJcmV0dXJuIHsgbGVmdDogcmV0LngsIHRvcDogcmV0LnkgfTsKCQl9LAoKCQlfY3JlYXRlUHJlcmVxczogZnVuY3Rpb24oIHNjcmVlblByZXJlcSwgY29udGFpbmVyUHJlcmVxLCB3aGVuRG9uZSApIHsKCQkJdmFyIHNlbGYgPSB0aGlzLCBwcmVyZXFzOwoKCQkJLy8gSXQgaXMgaW1wb3J0YW50IHRvIG1haW50YWluIGJvdGggdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXMgYW5kIHNlbGYuX3ByZXJlcXMuIFRoZSBsb2NhbCB2YXJpYWJsZSByZW1haW5zIGluCgkJCS8vIHRoZSBjbG9zdXJlIG9mIHRoZSBmdW5jdGlvbnMgd2hpY2ggY2FsbCB0aGUgY2FsbGJhY2tzIHBhc3NlZCBpbi4gVGhlIGNvbXBhcmlzb24gYmV0d2VlbiB0aGUgbG9jYWwgdmFyaWFibGUgYW5kCgkJCS8vIHNlbGYuX3ByZXJlcXMgaXMgbmVjZXNzYXJ5LCBiZWNhdXNlIG9uY2UgYSBmdW5jdGlvbiBoYXMgYmVlbiBwYXNzZWQgdG8gLmFuaW1hdGlvbkNvbXBsZXRlKCkgaXQgd2lsbCBiZSBjYWxsZWQKCQkJLy8gbmV4dCB0aW1lIGFuIGFuaW1hdGlvbiBjb21wbGV0ZXMsIGV2ZW4gaWYgdGhhdCdzIG5vdCB0aGUgYW5pbWF0aW9uIHdob3NlIGVuZCB0aGUgZnVuY3Rpb24gd2FzIHN1cHBvc2VkIHRvIGNhdGNoCgkJCS8vIChmb3IgZXhhbXBsZSwgaWYgYW4gYWJvcnQgaGFwcGVucyBkdXJpbmcgdGhlIG9wZW5pbmcgYW5pbWF0aW9uLCB0aGUgLmFuaW1hdGlvbkNvbXBsZXRlIGhhbmRsZXIgaXMgbm90IGNhbGxlZCBmb3IKCQkJLy8gdGhhdCBhbmltYXRpb24gYW55bW9yZSwgYnV0IHRoZSBoYW5kbGVyIHJlbWFpbnMgYXR0YWNoZWQsIHNvIGl0IGlzIGNhbGxlZCB0aGUgbmV4dCB0aW1lIHRoZSBwb3B1cCBpcyBvcGVuZWQKCQkJLy8gLSBtYWtpbmcgaXQgc3RhbGUuIENvbXBhcmluZyB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxcyB0byB0aGUgd2lkZ2V0LWxldmVsIHZhcmlhYmxlIHNlbGYuX3ByZXJlcXMgZW5zdXJlcyB0aGF0CgkJCS8vIGNhbGxiYWNrcyB0cmlnZ2VyZWQgYnkgYSBzdGFsZSAuYW5pbWF0aW9uQ29tcGxldGUgd2lsbCBiZSBpZ25vcmVkLgoKCQkJcHJlcmVxcyA9IHsKCQkJCXNjcmVlbjogJC5EZWZlcnJlZCgpLAoJCQkJY29udGFpbmVyOiAkLkRlZmVycmVkKCkKCQkJfTsKCgkJCXByZXJlcXMuc2NyZWVuLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJCXNjcmVlblByZXJlcSgpOwoJCQkJfQoJCQl9KTsKCgkJCXByZXJlcXMuY29udGFpbmVyLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJCWNvbnRhaW5lclByZXJlcSgpOwoJCQkJfQoJCQl9KTsKCgkJCSQud2hlbiggcHJlcmVxcy5zY3JlZW4sIHByZXJlcXMuY29udGFpbmVyICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQkJc2VsZi5fcHJlcmVxcyA9IG51bGw7CgkJCQkJd2hlbkRvbmUoKTsKCQkJCX0KCQkJfSk7CgoJCQlzZWxmLl9wcmVyZXFzID0gcHJlcmVxczsKCQl9LAoKCQlfYW5pbWF0ZTogZnVuY3Rpb24oIGFyZ3MgKSB7CgkJCS8vIE5PVEUgYmVmb3JlIHJlbW92aW5nIHRoZSBkZWZhdWx0IGFuaW1hdGlvbiBvZiB0aGUgc2NyZWVuCgkJCS8vICAgICAgdGhpcyBoYWQgYW4gYW5pbWF0ZSBjYWxsYmFjayB0aGF0IHdvdWxkIHJlc29sdmUgdGhlIGRlZmVycmVkCgkJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCQkvLyBUT0RPIHJlbW92ZSB0aGUgZGVwZW5kZW5jeSBvbiB0aGUgc2NyZWVuIGRlZmVycmVkCgkJCXRoaXMuX3VpLnNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkJLmFkZENsYXNzKCBhcmdzLnNjcmVlbkNsYXNzVG9BZGQgKTsKCgkJCWFyZ3MucHJlcmVxcy5zY3JlZW4ucmVzb2x2ZSgpOwoKCQkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCQlpZiAoIGFyZ3MuYXBwbHlUcmFuc2l0aW9uICkgewoJCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggYXJncy50cmFuc2l0aW9uICk7CgkJCQl9CgkJCQlpZiAoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApIHsKCQkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KCBhcmdzLnByZXJlcXMuY29udGFpbmVyLCAicmVzb2x2ZSIgKSApCgkJCQkJCS5hZGRDbGFzcyggYXJncy5jb250YWluZXJDbGFzc1RvQWRkICkKCQkJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQkJYXJncy5wcmVyZXFzLmNvbnRhaW5lci5yZXNvbHZlKCk7CgkJfSwKCgkJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJCS8vIGRlc2lyZWRQb3NpdGlvbi5wb3NpdGlvblRvLiBOZXZlcnRoZWxlc3MsIHRoaXMgZnVuY3Rpb24gZW5zdXJlcyB0aGF0IGl0cyByZXR1cm4gdmFsdWUgYWx3YXlzIGNvbnRhaW5zIHZhbGlkCgkJLy8geCBhbmQgeSBjb29yZGluYXRlcyBieSBzcGVjaWZ5aW5nIHRoZSBjZW50ZXIgbWlkZGxlIG9mIHRoZSB3aW5kb3cgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSBhYnNlbnQuCgkJLy8gb3B0aW9uczogeyB4OiBjb29yZGluYXRlLCB5OiBjb29yZGluYXRlLCBwb3NpdGlvblRvOiBzdHJpbmc6ICJvcmlnaW4iLCAid2luZG93Iiwgb3IgalF1ZXJ5IHNlbGVjdG9yCgkJX2Rlc2lyZWRDb29yZHM6IGZ1bmN0aW9uKCBvICkgewoJCQl2YXIgZHN0ID0gbnVsbCwgb2Zmc2V0LCB3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKSwgeCA9IG8ueCwgeSA9IG8ueSwgcFRvID0gby5wb3NpdGlvblRvOwoKCQkJLy8gRXN0YWJsaXNoIHdoaWNoIGVsZW1lbnQgd2lsbCBzZXJ2ZSBhcyB0aGUgcmVmZXJlbmNlCgkJCWlmICggcFRvICYmIHBUbyAhPT0gIm9yaWdpbiIgKSB7CgkJCQlpZiAoIHBUbyA9PT0gIndpbmRvdyIgKSB7CgkJCQkJeCA9IHdpbkNvb3Jkcy5jeCAvIDIgKyB3aW5Db29yZHMueDsKCQkJCQl5ID0gd2luQ29vcmRzLmN5IC8gMiArIHdpbkNvb3Jkcy55OwoJCQkJfSBlbHNlIHsKCQkJCQl0cnkgewoJCQkJCQlkc3QgPSAkKCBwVG8gKTsKCQkJCQl9IGNhdGNoKCBlICkgewoJCQkJCQlkc3QgPSBudWxsOwoJCQkJCX0KCQkJCQlpZiAoIGRzdCApIHsKCQkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCQlpZiAoIGRzdC5sZW5ndGggPT09IDAgKSB7CgkJCQkJCQlkc3QgPSBudWxsOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBJZiBhbiBlbGVtZW50IHdhcyBmb3VuZCwgY2VudGVyIG92ZXIgaXQKCQkJaWYgKCBkc3QgKSB7CgkJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCQl4ID0gb2Zmc2V0LmxlZnQgKyBkc3Qub3V0ZXJXaWR0aCgpIC8gMjsKCQkJCXkgPSBvZmZzZXQudG9wICsgZHN0Lm91dGVySGVpZ2h0KCkgLyAyOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgeCBhbmQgeSBhcmUgdmFsaWQgbnVtYmVycyAtIGNlbnRlciBvdmVyIHRoZSB3aW5kb3cKCQkJaWYgKCAkLnR5cGUoIHggKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHggKSApIHsKCQkJCXggPSB3aW5Db29yZHMuY3ggLyAyICsgd2luQ29vcmRzLng7CgkJCX0KCQkJaWYgKCAkLnR5cGUoIHkgKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHkgKSApIHsKCQkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJCX0KCgkJCXJldHVybiB7IHg6IHgsIHk6IHkgfTsKCQl9LAoKCQlfcmVwb3NpdGlvbjogZnVuY3Rpb24oIG8gKSB7CgkJCS8vIFdlIG9ubHkgY2FyZSBhYm91dCBwb3NpdGlvbi1yZWxhdGVkIHBhcmFtZXRlcnMgZm9yIHJlcG9zaXRpb25pbmcKCQkJbyA9IHsgeDogby54LCB5OiBvLnksIHBvc2l0aW9uVG86IG8ucG9zaXRpb25UbyB9OwoJCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlcG9zaXRpb24iLCBvICk7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5vZmZzZXQoIHRoaXMuX3BsYWNlbWVudENvb3JkcyggdGhpcy5fZGVzaXJlZENvb3JkcyggbyApICkgKTsKCQl9LAoKCQlyZXBvc2l0aW9uOiBmdW5jdGlvbiggbyApIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQl0aGlzLl9yZXBvc2l0aW9uKCBvICk7CgkJCX0KCQl9LAoKCQlfb3BlblByZXJlcXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQkJdGhpcy5faXNPcGVuID0gdHJ1ZTsKCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKS5mb2N1cygpOwoJCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQkJdGhpcy5fdHJpZ2dlciggImFmdGVyb3BlbiIgKTsKCQl9LAoKCQlfb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXZhciBvID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMgKSwKCQkJCS8vIFRPRE8gbW92ZSBibGFja2xpc3QgdG8gcHJpdmF0ZSBtZXRob2QKCQkJCWFuZHJvaWRCbGFja2xpc3QgPSAoIGZ1bmN0aW9uKCkgewoJCQkJCXZhciB3ID0gd2luZG93LAoJCQkJCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOVwuXSspLyApLAoJCQkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJCQlhbmRyb2lkbWF0Y2ggPSB1YS5tYXRjaCggL0FuZHJvaWQgKFxkKyg/OlwuXGQrKSkvICksCgkJCQkJCWFuZHZlcnNpb24gPSAhIWFuZHJvaWRtYXRjaCAmJiBhbmRyb2lkbWF0Y2hbIDEgXSwKCQkJCQkJY2hyb21lbWF0Y2ggPSB1YS5pbmRleE9mKCAiQ2hyb21lIiApID4gLTE7CgoJCQkJCS8vIFBsYXRmb3JtIGlzIEFuZHJvaWQsIFdlYktpdCB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiA1MzQuMTMgKCBBbmRyb2lkIDMuMi4xICkgYW5kIG5vdCBDaHJvbWUuCgkJCQkJaWYoIGFuZHJvaWRtYXRjaCAhPT0gbnVsbCAmJiBhbmR2ZXJzaW9uID09PSAiNC4wIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uID4gNTM0LjEzICYmICFjaHJvbWVtYXRjaCApIHsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0oKSk7CgoJCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJvcGVuIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJCS8vIDIuIFRoZSBzY3JlZW4gb3BhY2l0eSBhbmltYXRpb24gY29tcGxldGVzIChzY3JlZW4oKSkKCQkJdGhpcy5fY3JlYXRlUHJlcmVxcygKCQkJCSQubm9vcCwKCQkJCSQubm9vcCwKCQkJCSQucHJveHkoIHRoaXMsICJfb3BlblByZXJlcXNDb21wbGV0ZSIgKSApOwoKCQkJdGhpcy5fY3VycmVudFRyYW5zaXRpb24gPSBvLnRyYW5zaXRpb247CgkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggby50cmFuc2l0aW9uICk7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCQl0aGlzLl9zZXRUaGVtZSggdGhpcy5fcGFnZS5qcW1EYXRhKCAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuX3BhZ2UsICJjIiApICk7CgkJCX0KCgkJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKTsKCgkJCS8vIEdpdmUgYXBwbGljYXRpb25zIGEgY2hhbmNlIHRvIG1vZGlmeSB0aGUgY29udGVudHMgb2YgdGhlIGNvbnRhaW5lciBiZWZvcmUgaXQgYXBwZWFycwoJCQl0aGlzLl9yZXBvc2l0aW9uKCBvICk7CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgJiYgYW5kcm9pZEJsYWNrbGlzdCApIHsKCQkJCS8qIFRPRE86CgkJCQlUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZAoJCQkJYWJvdmUgdGhlIHBvcHVwIGl0c2VsZiB3aGVuIGNlcnRhaW4gb3RoZXIgc3R5bGVzIGV4aXN0IG9uIHRoZSBzYW1lIHBhZ2UgLS0gbmFtZWx5LCBhbnkgZWxlbWVudCBzZXQgdG8gYHBvc2l0aW9uOiBmaXhlZGAgYW5kIGNlcnRhaW4KCQkJCXR5cGVzIG9mIGlucHV0LiBUaGVzZSBpc3N1ZXMgYXJlIHJlbWluaXNjZW50IG9mIHByZXZpb3VzbHkgdW5jb3ZlcmVkIGJ1Z3MgaW4gb2xkZXIgdmVyc2lvbnMgb2YgQW5kcm9pZCdzIG5hdGl2ZSBicm93c2VyOgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoKCQkJCVRoaXMgZml4IGNsb3NlcyB0aGUgZm9sbG93aW5nIGJ1Z3MgKCBJIHVzZSAiY2xvc2VzIiB3aXRoIHJlbHVjdGFuY2UsIGFuZCBzdHJlc3MgdGhhdCB0aGlzIGlzc3VlIHNob3VsZCBiZSByZXZpc2l0ZWQgYXMgc29vbiBhcyBwb3NzaWJsZSApOgoKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDgxNgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODQ0CgkJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NzQKCQkJCSovCgoJCQkJLy8gVE9ETyBzb3J0IG91dCB3aHkgdGhpcy5fcGFnZSBpc24ndCB3b3JraW5nCgkJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCQkJfQoJCQl0aGlzLl9hbmltYXRlKHsKCQkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRydWUsCgkJCQl0cmFuc2l0aW9uOiBvLnRyYW5zaXRpb24sCgkJCQljbGFzc1RvUmVtb3ZlOiAiIiwKCQkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJpbiIsCgkJCQljb250YWluZXJDbGFzc1RvQWRkOiAiaW4iLAoJCQkJYXBwbHlUcmFuc2l0aW9uOiBmYWxzZSwKCQkJCXByZXJlcXM6IHRoaXMuX3ByZXJlcXMKCQkJfSk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxU2NyZWVuOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdWkuc2NyZWVuCgkJCQkucmVtb3ZlQ2xhc3MoICJvdXQiICkKCQkJCS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxQ29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkucmVtb3ZlQ2xhc3MoICJyZXZlcnNlIG91dCIgKQoJCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApCgkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCX0sCgoJCV9jbG9zZVByZXJlcXNEb25lOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoKCQkJLy8gcmVtb3ZlIHRoZSBnbG9iYWwgbXV0ZXggZm9yIHBvcHVwcwoJCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB1bmRlZmluZWQ7CgoJCQkvLyBhbGVydCB1c2VycyB0aGF0IHRoZSBwb3B1cCBpcyBjbG9zZWQKCQkJdGhpcy5fdHJpZ2dlciggImFmdGVyY2xvc2UiICk7CgkJfSwKCgkJX2Nsb3NlOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoKCQkJdGhpcy5faXNPcGVuID0gZmFsc2U7CgoJCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJjbG9zZSIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IHJldmVyc2UgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJCS8vIDIuIFRoZSBzY3JlZW4gb3BhY2l0eSBhbmltYXRpb24gY29tcGxldGVzIChzY3JlZW4oKSkKCQkJdGhpcy5fY3JlYXRlUHJlcmVxcygKCQkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFTY3JlZW4iICksCgkJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxQ29udGFpbmVyIiApLAoJCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXNEb25lIiApICk7CgoJCQl0aGlzLl9hbmltYXRlKCB7CgkJCQlhZGRpdGlvbmFsQ29uZGl0aW9uOiB0aGlzLl91aS5zY3JlZW4uaGFzQ2xhc3MoICJpbiIgKSwKCQkJCXRyYW5zaXRpb246ICggaW1tZWRpYXRlID8gIm5vbmUiIDogKCB0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApICksCgkJCQljbGFzc1RvUmVtb3ZlOiAiaW4iLAoJCQkJc2NyZWVuQ2xhc3NUb0FkZDogIm91dCIsCgkJCQljb250YWluZXJDbGFzc1RvQWRkOiAicmV2ZXJzZSBvdXQiLAoJCQkJYXBwbHlUcmFuc2l0aW9uOiB0cnVlLAoJCQkJcHJlcmVxczogdGhpcy5fcHJlcmVxcwoJCQl9KTsKCQl9LAoKCQlfdW5lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQkJLy8gUHV0IHRoZSBlbGVtZW50IGJhY2sgdG8gd2hlcmUgdGhlIHBsYWNlaG9sZGVyIHdhcyBhbmQgcmVtb3ZlIHRoZSAidWktcG9wdXAiIGNsYXNzCgkJCXRoaXMuX3NldFRoZW1lKCAibm9uZSIgKTsKCQkJdGhpcy5lbGVtZW50CgkJCQkvLyBDYW5ub3QgZGlyZWN0bHkgaW5zZXJ0QWZ0ZXIoKSAtIHdlIG5lZWQgdG8gZGV0YWNoKCkgZmlyc3QsIGJlY2F1c2UKCQkJCS8vIGluc2VydEFmdGVyKCkgd2lsbCBkbyBub3RoaW5nIGlmIHRoZSBwYXlsb2FkIGRpdiB3YXMgbm90IGF0dGFjaGVkCgkJCQkvLyB0byB0aGUgRE9NIGF0IHRoZSB0aW1lIHRoZSB3aWRnZXQgd2FzIGNyZWF0ZWQsIGFuZCBzbyB0aGUgcGF5bG9hZAoJCQkJLy8gd2lsbCByZW1haW4gaW5zaWRlIHRoZSBjb250YWluZXIgZXZlbiBhZnRlciB3ZSBjYWxsIGluc2VydEFmdGVyKCkuCgkJCQkvLyBJZiB0aGF0IGhhcHBlbnMgYW5kIHdlIHJlbW92ZSB0aGUgY29udGFpbmVyIGEgZmV3IGxpbmVzIGJlbG93LCB3ZQoJCQkJLy8gd2lsbCBjYXVzZSBhbiBpbmZpbml0ZSByZWN1cnNpb24gLSAjNTI0NAoJCQkJLmRldGFjaCgpCgkJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuX3VpLnBsYWNlaG9sZGVyICkKCQkJCS5yZW1vdmVDbGFzcyggInVpLXBvcHVwIHVpLW92ZXJsYXktc2hhZG93IHVpLWNvcm5lci1hbGwiICk7CgkJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmUoKTsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZSgpOwoJCQl0aGlzLl91aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlID09PSB0aGlzICkgewoJCQkJdGhpcy5lbGVtZW50Lm9uZSggInBvcHVwYWZ0ZXJjbG9zZSIsICQucHJveHkoIHRoaXMsICJfdW5lbmhhbmNlIiApICk7CgkJCQl0aGlzLmNsb3NlKCk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl91bmVuaGFuY2UoKTsKCQkJfQoJCX0sCgoJCV9jbG9zZVBvcHVwOiBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQkJdmFyIHBhcnNlZERzdCwgdG9VcmwsIG8gPSB0aGlzLm9wdGlvbnMsIGltbWVkaWF0ZSA9IGZhbHNlOwoKCQkJLy8gcmVzdG9yZSBsb2NhdGlvbiBvbiBzY3JlZW4KCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLl9zY3JvbGxUb3AgKTsKCgkJCWlmICggZSAmJiBlLnR5cGUgPT09ICJwYWdlYmVmb3JlY2hhbmdlIiAmJiBkYXRhICkgewoJCQkJLy8gRGV0ZXJtaW5lIHdoZXRoZXIgd2UgbmVlZCB0byByYXBpZC1jbG9zZSB0aGUgcG9wdXAsIG9yIHdoZXRoZXIgd2UgY2FuCgkJCQkvLyB0YWtlIHRoZSB0aW1lIHRvIHJ1biB0aGUgY2xvc2luZyB0cmFuc2l0aW9uCgkJCQlpZiAoIHR5cGVvZiBkYXRhLnRvUGFnZSA9PT0gInN0cmluZyIgKSB7CgkJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2U7CgkJCQl9IGVsc2UgewoJCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQl9CgkJCQlwYXJzZWREc3QgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCBwYXJzZWREc3QgKTsKCQkJCXRvVXJsID0gcGFyc2VkRHN0LnBhdGhuYW1lICsgcGFyc2VkRHN0LnNlYXJjaCArIHBhcnNlZERzdC5oYXNoOwoKCQkJCWlmICggdGhpcy5fbXlVcmwgIT09ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB0b1VybCApICkgewoJCQkJCS8vIEdvaW5nIHRvIGEgZGlmZmVyZW50IHBhZ2UgLSBjbG9zZSBpbW1lZGlhdGVseQoJCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVtb3ZlIG5hdiBiaW5kaW5ncwoJCQlvLmNvbnRhaW5lci51bmJpbmQoIG8uY2xvc2VFdmVudHMgKTsKCQkJLy8gdW5iaW5kIGNsaWNrIGhhbmRsZXJzIGFkZGVkIHdoZW4gaGlzdG9yeSBpcyBkaXNhYmxlZAoJCQl0aGlzLmVsZW1lbnQudW5kZWxlZ2F0ZSggby5jbG9zZUxpbmtTZWxlY3Rvciwgby5jbG9zZUxpbmtFdmVudHMgKTsKCgkJCXRoaXMuX2Nsb3NlKCBpbW1lZGlhdGUgKTsKCQl9LAoKCQkvLyBhbnkgbmF2aWdhdGlvbiBldmVudCBhZnRlciBhIHBvcHVwIGlzIG9wZW5lZCBzaG91bGQgY2xvc2UgdGhlIHBvcHVwCgkJLy8gTk9URSB0aGUgcGFnZWJlZm9yZWNoYW5nZSBpcyBib3VuZCB0byBjYXRjaCBuYXZpZ2F0aW9uIGV2ZW50cyB0aGF0IGRvbid0CgkJLy8gICAgICBhbHRlciB0aGUgdXJsIChlZywgZGlhbG9ncyBmcm9tIHBvcHVwcykKCQlfYmluZENvbnRhaW5lckNsb3NlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5vcHRpb25zLmNvbnRhaW5lcgoJCQkJLm9uZSggdGhpcy5vcHRpb25zLmNsb3NlRXZlbnRzLCAkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUG9wdXAiICkgKTsKCQl9LAoKCQkvLyBUT0RPIG5vIGNsZWFyIGRlbGluaWF0aW9uIG9mIHdoYXQgc2hvdWxkIGJlIGhlcmUgYW5kCgkJLy8gd2hhdCBzaG91bGQgYmUgaW4gX29wZW4uIFNlZW1zIHRvIGJlICJ2aXN1YWwiIHZzICJoaXN0b3J5IiBmb3Igbm93CgkJb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXZhciBzZWxmID0gdGhpcywgb3B0cyA9IHRoaXMub3B0aW9ucywgdXJsLCBoYXNoa2V5LCBhY3RpdmVQYWdlLCBjdXJyZW50SXNEaWFsb2csIGhhc0hhc2gsIHVybEhpc3Rvcnk7CgoJCQkvLyBtYWtlIHN1cmUgb3BlbiBpcyBpZGVtcG90ZW50CgkJCWlmKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHNldCB0aGUgZ2xvYmFsIHBvcHVwIG11dGV4CgkJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHRoaXM7CgkJCXRoaXMuX3Njcm9sbFRvcCA9ICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKTsKCgkJCS8vIGlmIGhpc3RvcnkgYWx0ZXJhdGlvbiBpcyBkaXNhYmxlZCBjbG9zZSBvbiBuYXZpZ2F0ZSBldmVudHMKCQkJLy8gYW5kIGxlYXZlIHRoZSB1cmwgYXMgaXMKCQkJaWYoICEoIG9wdHMuaGlzdG9yeSApICkgewoJCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgoJCQkJLy8gV2hlbiBoaXN0b3kgaXMgZGlzYWJsZWQgd2UgaGF2ZSB0byBncmFiIHRoZSBkYXRhLXJlbAoJCQkJLy8gYmFjayBsaW5rIGNsaWNrcyBzbyB3ZSBjYW4gY2xvc2UgdGhlIHBvcHVwIGluc3RlYWQgb2YKCQkJCS8vIHJlbHlpbmcgb24gaGlzdG9yeSB0byBkbyBpdCBmb3IgdXMKCQkJCXNlbGYuZWxlbWVudAoJCQkJCS5kZWxlZ2F0ZSggb3B0cy5jbG9zZUxpbmtTZWxlY3Rvciwgb3B0cy5jbG9zZUxpbmtFdmVudHMsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQl9KTsKCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIGNhY2hlIHNvbWUgdmFsdWVzIGZvciBtaW4vcmVhZGFiaWxpdHkKCQkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLnVybEhpc3Rvcnk7CgkJCWhhc2hrZXkgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCQlhY3RpdmVQYWdlID0gJC5tb2JpbGUuYWN0aXZlUGFnZTsKCQkJY3VycmVudElzRGlhbG9nID0gYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICk7CgkJCXRoaXMuX215VXJsID0gdXJsID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS51cmw7CgkJCWhhc0hhc2ggPSAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPiAtMSApICYmICFjdXJyZW50SXNEaWFsb2cgJiYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApOwoKCQkJaWYgKCBoYXNIYXNoICkgewoJCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIGlmIHRoZSBjdXJyZW50IHVybCBoYXMgbm8gZGlhbG9nIGhhc2gga2V5IHByb2NlZWQgYXMgbm9ybWFsCgkJCS8vIG90aGVyd2lzZSwgaWYgdGhlIHBhZ2UgaXMgYSBkaWFsb2cgc2ltcGx5IHRhY2sgb24gdGhlIGhhc2gga2V5CgkJCWlmICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA9PT0gLTEgJiYgIWN1cnJlbnRJc0RpYWxvZyApewoJCQkJdXJsID0gdXJsICsgKHVybC5pbmRleE9mKCAiIyIgKSA+IC0xID8gaGFzaGtleSA6ICIjIiArIGhhc2hrZXkpOwoJCQl9IGVsc2UgewoJCQkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCArIGhhc2hrZXk7CgkJCX0KCgkJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCQl1cmwgKz0gaGFzaGtleTsKCQkJfQoKCQkJLy8gc3dhbGxvdyB0aGUgdGhlIGluaXRpYWwgbmF2aWdhdGlvbiBldmVudCwgYW5kIGJpbmQgZm9yIHRoZSBuZXh0CgkJCSQod2luZG93KS5vbmUoICJiZWZvcmVuYXZpZ2F0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJCX0pOwoKCQkJdGhpcy51cmxBbHRlcmVkID0gdHJ1ZTsKCQkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwge3JvbGU6ICJkaWFsb2cifSApOwoJCX0sCgoJCWNsb3NlOiBmdW5jdGlvbigpIHsKCQkJLy8gbWFrZSBzdXJlIGNsb3NlIGlzIGlkZW1wb3RlbnQKCQkJaWYoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdGhpcy5fc2Nyb2xsVG9wID0gJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpOwoKCQkJaWYoIHRoaXMub3B0aW9ucy5oaXN0b3J5ICYmIHRoaXMudXJsQWx0ZXJlZCApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCXRoaXMudXJsQWx0ZXJlZCA9IGZhbHNlOwoJCQl9IGVsc2UgewoJCQkJLy8gc2ltdWxhdGUgdGhlIG5hdiBiaW5kaW5ncyBoYXZpbmcgZmlyZWQKCQkJCXRoaXMuX2Nsb3NlUG9wdXAoKTsKCQkJfQoJCX0KCX0pOwoKCgkvLyBUT0RPIHRoaXMgY2FuIGJlIG1vdmVkIGluc2lkZSB0aGUgd2lkZ2V0CgkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rID0gZnVuY3Rpb24oICRsaW5rICkgewoJCXZhciBjbG9zZXN0UGFnZSA9ICRsaW5rLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICksCgkJCXNjb3BlID0gKCAoIGNsb3Nlc3RQYWdlLmxlbmd0aCA9PT0gMCApID8gJCggImJvZHkiICkgOiBjbG9zZXN0UGFnZSApLAoJCQkvLyBOT1RFIG1ha2Ugc3VyZSB0byBnZXQgb25seSB0aGUgaGFzaCwgaWU3ICh3cDcpIHJldHVybiB0aGUgYWJzb2x1dGUgaHJlZgoJCQkvLyAgICAgIGluIHRoaXMgY2FzZSBydWluaW5nIHRoZSBlbGVtZW50IHNlbGVjdGlvbgoJCQlwb3B1cCA9ICQoICQubW9iaWxlLnBhdGgucGFyc2VVcmwoJGxpbmsuYXR0ciggImhyZWYiICkpLmhhc2gsIHNjb3BlWzBdICksCgkJCW9mZnNldDsKCgkJaWYgKCBwb3B1cC5kYXRhKCAibW9iaWxlLXBvcHVwIiApICkgewoJCQlvZmZzZXQgPSAkbGluay5vZmZzZXQoKTsKCQkJcG9wdXAucG9wdXAoICJvcGVuIiwgewoJCQkJeDogb2Zmc2V0LmxlZnQgKyAkbGluay5vdXRlcldpZHRoKCkgLyAyLAoJCQkJeTogb2Zmc2V0LnRvcCArICRsaW5rLm91dGVySGVpZ2h0KCkgLyAyLAoJCQkJdHJhbnNpdGlvbjogJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlwb3NpdGlvblRvOiAkbGluay5qcW1EYXRhKCAicG9zaXRpb24tdG8iICkKCQkJfSk7CgkJfQoKCQkvL3JlbW92ZSBhZnRlciBkZWxheQoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkvLyBDaGVjayBpZiB3ZSBhcmUgaW4gYSBsaXN0dmlldwoJCQl2YXIgJHBhcmVudCA9ICRsaW5rLnBhcmVudCgpLnBhcmVudCgpOwoJCQlpZiAoJHBhcmVudC5oYXNDbGFzcygidWktbGkiKSkgewoJCQkJJGxpbmsgPSAkcGFyZW50LnBhcmVudCgpOwoJCQl9CgkJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0sIDMwMCApOwoJfTsKCgkvLyBUT0RPIG1vdmUgaW5zaWRlIF9jcmVhdGUKCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlYmVmb3JlY2hhbmdlIiwgZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayggZGF0YS5vcHRpb25zLmxpbmsgKTsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0pOwoKCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgIHsKCQkkLm1vYmlsZS5wb3B1cC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKCX0pOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgZXh0ZW5kU2VsZWN0ID0gZnVuY3Rpb24oIHdpZGdldCApIHsKCgkJdmFyIHNlbGVjdCA9IHdpZGdldC5zZWxlY3QsCgkJCW9yaWdEZXN0cm95ID0gd2lkZ2V0Ll9kZXN0cm95LAoJCQlzZWxlY3RJRCAgPSB3aWRnZXQuc2VsZWN0SUQsCgkJCXByZWZpeCA9ICggc2VsZWN0SUQgPyBzZWxlY3RJRCA6ICggKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInV1aWQtIiArIHdpZGdldC51dWlkICkgKSwKCQkJcG9wdXBJRCA9IHByZWZpeCArICItbGlzdGJveCIsCgkJCWRpYWxvZ0lEID0gcHJlZml4ICsgIi1kaWFsb2ciLAoJCQlsYWJlbCA9IHdpZGdldC5sYWJlbCwKCQkJdGhpc1BhZ2UgPSB3aWRnZXQuc2VsZWN0LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJc2VsZWN0T3B0aW9ucyA9IHdpZGdldC5fc2VsZWN0T3B0aW9ucygpLAoJCQlpc011bHRpcGxlID0gd2lkZ2V0LmlzTXVsdGlwbGUgPSB3aWRnZXQuc2VsZWN0WyAwIF0ubXVsdGlwbGUsCgkJCWJ1dHRvbklkID0gc2VsZWN0SUQgKyAiLWJ1dHRvbiIsCgkJCW1lbnVJZCA9IHNlbGVjdElEICsgIi1tZW51IiwKCQkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGlkPSciICsgZGlhbG9nSUQgKyAiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgInRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy50aGVtZSArIicgZGF0YS0iICskLm1vYmlsZS5ucyArICJvdmVybGF5LXRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgKyInPiIgKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0naGVhZGVyJz4iICsKCQkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJCSI8L2Rpdj4iKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+IisKCQkJCSI8L2Rpdj4iICksCgoJCQlsaXN0Ym94ID0gICQoICI8ZGl2IGlkPSciICsgcG9wdXBJRCArICInIGNsYXNzPSd1aS1zZWxlY3RtZW51Jz4iICkuaW5zZXJ0QWZ0ZXIoIHdpZGdldC5zZWxlY3QgKS5wb3B1cCggeyB0aGVtZTogd2lkZ2V0Lm9wdGlvbnMub3ZlcmxheVRoZW1lIH0gKSwKCgkJCWxpc3QgPSAkKCAiPHVsPiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS1zZWxlY3RtZW51LWxpc3QiLAoJCQkJImlkIjogbWVudUlkLAoJCQkJInJvbGUiOiAibGlzdGJveCIsCgkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogYnV0dG9uSWQKCQkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIsIHdpZGdldC5vcHRpb25zLnRoZW1lICkKCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImRpdmlkZXItdGhlbWUiLCB3aWRnZXQub3B0aW9ucy5kaXZpZGVyVGhlbWUgKQoJCQkJCS5hcHBlbmRUbyggbGlzdGJveCApLAoKCgkJCWhlYWRlciA9ICQoICI8ZGl2PiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS1oZWFkZXIgdWktYmFyLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZQoJCQl9KS5wcmVwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlclRpdGxlID0gJCggIjxoMT4iLCB7CgkJCQkiY2xhc3MiOiAidWktdGl0bGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKSwKCgkJCW1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZSwKCQkJaGVhZGVyQ2xvc2U7CgoJCWlmICggd2lkZ2V0LmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJ0ZXh0Ijogd2lkZ2V0Lm9wdGlvbnMuY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuLWxlZnQiCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiwgIm5vdGV4dCIgKS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbiIsICJkZWxldGUiICkuYXBwZW5kVG8oIGhlYWRlciApLmJ1dHRvbk1hcmt1cCgpOwoJCX0KCgkJJC5leHRlbmQoIHdpZGdldCwgewoJCQlzZWxlY3Q6IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEOiBzZWxlY3RJRCwKCQkJYnV0dG9uSWQ6IGJ1dHRvbklkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJcG9wdXBJRDogcG9wdXBJRCwKCQkJZGlhbG9nSUQ6IGRpYWxvZ0lELAoJCQl0aGlzUGFnZTogdGhpc1BhZ2UsCgkJCW1lbnVQYWdlOiBtZW51UGFnZSwKCQkJbGFiZWw6IGxhYmVsLAoJCQlzZWxlY3RPcHRpb25zOiBzZWxlY3RPcHRpb25zLAoJCQlpc011bHRpcGxlOiBpc011bHRpcGxlLAoJCQl0aGVtZTogd2lkZ2V0Lm9wdGlvbnMudGhlbWUsCgkJCWxpc3Rib3g6IGxpc3Rib3gsCgkJCWxpc3Q6IGxpc3QsCgkJCWhlYWRlcjogaGVhZGVyLAoJCQloZWFkZXJUaXRsZTogaGVhZGVyVGl0bGUsCgkJCWhlYWRlckNsb3NlOiBoZWFkZXJDbG9zZSwKCQkJbWVudVBhZ2VDb250ZW50OiBtZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2U6IG1lbnVQYWdlQ2xvc2UsCgkJCXBsYWNlaG9sZGVyOiAiIiwKCgkJCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpczsKCgkJCQkvLyBDcmVhdGUgbGlzdCBmcm9tIHNlbGVjdCwgdXBkYXRlIHN0YXRlCgkJCQlzZWxmLnJlZnJlc2goKTsKCgkJCQlpZiAoIHNlbGYuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCS8vIE1hcCB1bmRlZmluZWQgdG8gZmFsc2UsIGJlY2F1c2Ugc2VsZi5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQKCQkJCQkvLyBpbmRpY2F0ZXMgdGhhdCB3ZSBoYXZlIG5vdCB5ZXQgY2hlY2tlZCB3aGV0aGVyIHRoZSBzZWxlY3QgaGFzCgkJCQkJLy8gb3JpZ2luYWxseSBoYWQgYSB0YWJpbmRleCBhdHRyaWJ1dGUsIHdoZXJlYXMgZmFsc2UgaW5kaWNhdGVzIHRoYXQKCQkJCQkvLyB3ZSBoYXZlIGNoZWNrZWQgdGhlIHNlbGVjdCBmb3Igc3VjaCBhbiBhdHRyaWJ1dGUsIGFuZCBoYXZlIGZvdW5kCgkJCQkJLy8gbm9uZSBwcmVzZW50LgoJCQkJCXNlbGYuX29yaWdUYWJJbmRleCA9ICggc2VsZi5zZWxlY3RbIDAgXS5nZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIgKSA9PT0gbnVsbCApID8gZmFsc2UgOiBzZWxmLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiICk7CgkJCQl9CgkJCQlzZWxmLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmJsdXIoKTsKCQkJCQlzZWxmLmJ1dHRvbi5mb2N1cygpOwoJCQkJfSk7CgoJCQkJLy8gQnV0dG9uIGV2ZW50cwoJCQkJc2VsZi5idXR0b24uYmluZCggInZjbGljayBrZXlkb3duIiAsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCB8fCBzZWxmLmlzT3BlbiApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8CgkJCQkJCQkJCQkJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFKSkgewoKCQkJCQkJc2VsZi5fZGVjaWRlRm9ybWF0KCk7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyBzZWxmLnBvcHVwSUQgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJwb3B1cCIgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXNlbGYuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgc2VsZi5kaWFsb2dJRCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgImRpYWxvZyIgKTsKCQkJCQkJfQoJCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQkJCS8vIERvIG5vdCBwcmV2ZW50IGRlZmF1bHQsIHNvIHRoZSBuYXZpZ2F0aW9uIG1heSBoYXZlIGEgY2hhbmNlIHRvIGFjdHVhbGx5IG9wZW4gdGhlIGNob3NlbiBmb3JtYXQKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQkJCXNlbGYubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApCgkJCQkJLmJpbmQoICJmb2N1c2luIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkJCQkJLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoKCQkJCQl9KQoJCQkJCS5iaW5kKCAiZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJJCggZS50YXJnZXQgKQoJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKQoJCQkJCQkJLnRyaWdnZXIoICJ2bW91c2VvdXQiICk7CgkJCQkJfSkKCQkJCQkuZGVsZWdhdGUoICJsaTpub3QoLnVpLWRpc2FibGVkLCAudWktbGktZGl2aWRlcikiLCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJCQkvLyBpbmRleCBvZiBvcHRpb24gdGFnIHRvIGJlIHNlbGVjdGVkCgkJCQkJCXZhciBvbGRJbmRleCA9IHNlbGYuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCQkJCQkJCW5ld0luZGV4ID0gc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmluZGV4KCB0aGlzICksCgkJCQkJCQlvcHRpb24gPSBzZWxmLl9zZWxlY3RPcHRpb25zKCkuZXEoIG5ld0luZGV4IClbIDAgXTsKCgkJCQkJCS8vIHRvZ2dsZSBzZWxlY3RlZCBzdGF0dXMgb24gdGhlIHRhZyBmb3IgbXVsdGkgc2VsZWN0cwoJCQkJCQlvcHRpb24uc2VsZWN0ZWQgPSBzZWxmLmlzTXVsdGlwbGUgPyAhb3B0aW9uLnNlbGVjdGVkIDogdHJ1ZTsKCgkJCQkJCS8vIHRvZ2dsZSBjaGVja2JveCBjbGFzcyBmb3IgbXVsdGlwbGUgc2VsZWN0cwoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCSQoIHRoaXMgKS5maW5kKCAiLnVpLWljb24iICkKCQkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiwgb3B0aW9uLnNlbGVjdGVkICkKCQkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9mZiIsICFvcHRpb24uc2VsZWN0ZWQgKTsKCQkJCQkJfQoKCQkJCQkJLy8gdHJpZ2dlciBjaGFuZ2UgaWYgdmFsdWUgY2hhbmdlZAoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSB8fCBvbGRJbmRleCAhPT0gbmV3SW5kZXggKSB7CgkJCQkJCQlzZWxmLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCQl9CgoJCQkJCQkvLyBoaWRlIGN1c3RvbSBzZWxlY3QgZm9yIHNpbmdsZSBzZWxlY3RzIG9ubHkgLSBvdGhlcndpc2UgZm9jdXMgY2xpY2tlZCBpdGVtCgkJCQkJCS8vIFdlIG5lZWQgdG8gZ3JhYiB0aGUgY2xpY2tlZCBpdGVtIHRoZSBoYXJkIHdheSwgYmVjYXVzZSB0aGUgbGlzdCBtYXkgaGF2ZSBiZWVuIHJlYnVpbHQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuZXEoIG5ld0luZGV4ICkKCQkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCX0KCgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfSkKCQkJCQkua2V5ZG93bihmdW5jdGlvbiggZXZlbnQgKSB7ICAvL2tleWJvYXJkIGV2ZW50cyBmb3IgbWVudSBpdGVtcwoJCQkJCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCQkJCQlsaSA9IHRhcmdldC5jbG9zZXN0KCAibGkiICksCgkJCQkJCQlwcmV2LCBuZXh0OwoKCQkJCQkJLy8gc3dpdGNoIGxvZ2ljIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCQkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCQkJLy8gdXAgb3IgbGVmdCBhcnJvdyBrZXlzCgkJCQkJCWNhc2UgMzg6CgkJCQkJCQlwcmV2ID0gbGkucHJldigpLm5vdCggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoKCQkJCQkJCWlmICggcHJldi5pcyggIi51aS1saS1kaXZpZGVyIiApICkgewoJCQkJCQkJCXByZXYgPSBwcmV2LnByZXYoKTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgcHJldmlvdXMgb3B0aW9uLCBmb2N1cyBpdAoJCQkJCQkJaWYgKCBwcmV2Lmxlbmd0aCApIHsKCQkJCQkJCQl0YXJnZXQKCQkJCQkJCQkJLmJsdXIoKQoJCQkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJCQkJCQlwcmV2LmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCQkJCQljYXNlIDQwOgoJCQkJCQkJbmV4dCA9IGxpLm5leHQoKTsKCgkJCQkJCQlpZiAoIG5leHQuaXMoICIudWktbGktZGl2aWRlciIgKSApIHsKCQkJCQkJCQluZXh0ID0gbmV4dC5uZXh0KCk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIG5leHQgb3B0aW9uLCBmb2N1cyBpdAoJCQkJCQkJaWYgKCBuZXh0Lmxlbmd0aCApIHsKCQkJCQkJCQl0YXJnZXQKCQkJCQkJCQkJLmJsdXIoKQoJCQkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJCQkJCQluZXh0LmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQkJCQkJY2FzZSAxMzoKCQkJCQkJY2FzZSAzMjoKCQkJCQkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgoJCQkJLy8gYnV0dG9uIHJlZm9jdXMgZW5zdXJlcyBwcm9wZXIgaGVpZ2h0IGNhbGN1bGF0aW9uCgkJCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCQkJc2VsZi5tZW51UGFnZS5iaW5kKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJCQkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCQkJCS8vCgkJCQkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkJCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkJCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJCQkJLy8KCQkJCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkJCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCQkJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkJCQkvLwoJCQkJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCQkJCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZS5jYWxsKCBzZWxmLnRoaXNQYWdlICk7CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJCQlzZWxmLmxpc3Rib3guYmluZCggInBvcHVwYWZ0ZXJjbG9zZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCgkJCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYuaGVhZGVyQ2xvc2UuY2xpY2soZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gdHJhY2sgdGhpcyBkZXBlbmRlbmN5IHNvIHRoYXQgd2hlbiB0aGUgcGFyZW50IHBhZ2UKCQkJCS8vIGlzIHJlbW92ZWQgb24gcGFnZWhpZGUgaXQgd2lsbCBhbHNvIHJlbW92ZSB0aGUgbWVudXBhZ2UKCQkJCXNlbGYudGhpc1BhZ2UuYWRkRGVwZW5kZW50cyggdGhpcy5tZW51UGFnZSApOwoJCQl9LAoKCQkJX2lzUmVidWlsZFJlcXVpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBsaXN0ID0gdGhpcy5saXN0LmZpbmQoICJsaSIgKSwKCQkJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoKCQkJCS8vIFRPRE8gZXhjZWVkaW5nbHkgbmFpdmUgbWV0aG9kIHRvIGRldGVybWluZSBkaWZmZXJlbmNlCgkJCQkvLyBpZ25vcmVzIHZhbHVlIGNoYW5nZXMgZXRjIGluIGZhdm9yIG9mIGEgZm9yY2VkUmVidWlsZAoJCQkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQkJCXJldHVybiBvcHRpb25zLnRleHQoKSAhPT0gbGlzdC50ZXh0KCk7CgkJCX0sCgoJCQlzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZDpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSIgKTsKCQkJfSwKCgkJCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZVJlYnVpbGQgLCBmb28gKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlzZWxlY3QgPSB0aGlzLmVsZW1lbnQsCgkJCQlpc011bHRpcGxlID0gdGhpcy5pc011bHRpcGxlLAoJCQkJaW5kaWNpZXM7CgoJCQkJaWYgKCAgZm9yY2VSZWJ1aWxkIHx8IHRoaXMuX2lzUmVidWlsZFJlcXVpcmVkKCkgKSB7CgkJCQkJc2VsZi5fYnVpbGRMaXN0KCk7CgkJCQl9CgoJCQkJaW5kaWNpZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQkJCXNlbGYuc2V0QnV0dG9uVGV4dCgpOwoJCQkJc2VsZi5zZXRCdXR0b25Db3VudCgpOwoKCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKQoJCQkJCS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIGZhbHNlICkKCQkJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQkJCWlmICggJC5pbkFycmF5KCBpLCBpbmRpY2llcyApID4gLTEgKSB7CgkJCQkJCQl2YXIgaXRlbSA9ICQoIHRoaXMgKTsKCgkJCQkJCQkvLyBBcmlhIHNlbGVjdGVkIGF0dHIKCQkJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCQkJLy8gTXVsdGlwbGUgc2VsZWN0czogYWRkIHRoZSAib24iIGNoZWNrYm94IHN0YXRlIHRvIHRoZSBpY29uCgkJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCQlpdGVtLmZpbmQoICIudWktaWNvbiIgKS5yZW1vdmVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKCBpdGVtLmlzKCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICkgKSB7CgkJCQkJCQkJCWl0ZW0ubmV4dCgpLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCWl0ZW0uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCX0sCgoJCQljbG9zZTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhdGhpcy5pc09wZW4gKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpczsKCgkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJwYWdlIiApIHsKCQkJCQlzZWxmLm1lbnVQYWdlLmRpYWxvZyggImNsb3NlIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCQkJfQoKCQkJCXNlbGYuX2ZvY3VzQnV0dG9uKCk7CgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5idXR0b24uY2xpY2soKTsKCQkJfSwKCgkJCV9kZWNpZGVGb3JtYXQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3csCgkJCQkJc2VsZkxpc3RQYXJlbnQgPSBzZWxmLmxpc3QucGFyZW50KCksCgkJCQkJbWVudUhlaWdodCA9IHNlbGZMaXN0UGFyZW50Lm91dGVySGVpZ2h0KCksCgkJCQkJbWVudVdpZHRoID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJXaWR0aCgpLAoJCQkJCWFjdGl2ZVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJCQlzY3JlZW5IZWlnaHQgPSAkd2luZG93LmhlaWdodCgpLAoJCQkJCXNjcmVlbldpZHRoID0gJHdpbmRvdy53aWR0aCgpOwoKCQkJCWZ1bmN0aW9uIGZvY3VzTWVudUl0ZW0oKSB7CgkJCQkJdmFyIHNlbGVjdG9yID0gc2VsZi5saXN0LmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiBhIiApOwoJCQkJCWlmICggc2VsZWN0b3IubGVuZ3RoID09PSAwICkgewoJCQkJCQlzZWxlY3RvciA9IHNlbGYubGlzdC5maW5kKCAibGkudWktYnRuOm5vdCggOmpxbURhdGEocGxhY2Vob2xkZXI9J3RydWUnKSApIGEiICk7CgkJCQkJfQoJCQkJCXNlbGVjdG9yLmZpcnN0KCkuZm9jdXMoKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKTsKCQkJCX0KCgkJCQlpZiAoIG1lbnVIZWlnaHQgPiBzY3JlZW5IZWlnaHQgLSA4MCB8fCAhJC5zdXBwb3J0LnNjcm9sbFRvcCApIHsKCgkJCQkJc2VsZi5tZW51UGFnZS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApLnBhZ2UoKTsKCQkJCQlzZWxmLm1lbnVQYWdlQ29udGVudCA9IG1lbnVQYWdlLmZpbmQoICIudWktY29udGVudCIgKTsKCQkJCQlzZWxmLm1lbnVQYWdlQ2xvc2UgPSBtZW51UGFnZS5maW5kKCAiLnVpLWhlYWRlciBhIiApOwoKCQkJCQkvLyBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgRE9NLAoJCQkJCS8vIG90aGVyd2lzZSB0aGUgcmVzdWx0cyBvZiBzZWxlY3RpbmcgYSBsaXN0IGl0ZW0gaW4gdGhlIGRpYWxvZwoJCQkJCS8vIGZhbGwgaW50byBhIGJsYWNrIGhvbGUKCQkJCQlzZWxmLnRoaXNQYWdlLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKTsKCgkJCQkJLy9mb3IgV2ViT1MvT3BlcmEgTWluaSAoc2V0IGxhc3RzY3JvbGwgdXNpbmcgYnV0dG9uIG9mZnNldCkKCQkJCQlpZiAoIHNjcm9sbFRvcCA9PT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCXNlbGYubWVudVBhZ2UKCQkJCQkJLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCQlmb2N1c01lbnVJdGVtKCk7CgkJCQkJCX0pCgkJCQkJCS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9KTsKCgkJCQkJc2VsZi5tZW51VHlwZSA9ICJwYWdlIjsKCQkJCQlzZWxmLm1lbnVQYWdlQ29udGVudC5hcHBlbmQoIHNlbGYubGlzdCApOwoJCQkJCXNlbGYubWVudVBhZ2UuZmluZCgiZGl2IC51aS10aXRsZSIpLnRleHQoc2VsZi5sYWJlbC50ZXh0KCkpOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJCQlzZWxmLmxpc3Rib3gub25lKCAicG9wdXBhZnRlcm9wZW4iLCBmb2N1c01lbnVJdGVtICk7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQkJCW9wdGdyb3VwcyA9IFtdLAoJCQkJCWxpcyA9IFtdLAoJCQkJCWRhdGFJY29uID0gc2VsZi5pc011bHRpcGxlID8gImNoZWNrYm94LW9mZiIgOiAiZmFsc2UiOwoKCQkJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgoJCQkJdmFyICRvcHRpb25zID0gc2VsZi5zZWxlY3QuZmluZCggIm9wdGlvbiIgKSwKCQkJCQludW1PcHRpb25zID0gJG9wdGlvbnMubGVuZ3RoLAoJCQkJCXNlbGVjdCA9IHRoaXMuc2VsZWN0WyAwIF0sCgkJCQkJZGF0YVByZWZpeCA9ICdkYXRhLScgKyAkLm1vYmlsZS5ucywKCQkJCQlkYXRhSW5kZXhBdHRyID0gZGF0YVByZWZpeCArICdvcHRpb24taW5kZXgnLAoJCQkJCWRhdGFJY29uQXR0ciA9IGRhdGFQcmVmaXggKyAnaWNvbicsCgkJCQkJZGF0YVJvbGVBdHRyID0gZGF0YVByZWZpeCArICdyb2xlJywKCQkJCQlkYXRhUGxhY2Vob2xkZXJBdHRyID0gZGF0YVByZWZpeCArICdwbGFjZWhvbGRlcicsCgkJCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSwKCQkJCQlvcHRHcm91cDsKCgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IG51bU9wdGlvbnM7aSsrLCBpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlKSB7CgkJCQkJdmFyIG9wdGlvbiA9ICRvcHRpb25zW2ldLAoJCQkJCQkkb3B0aW9uID0gJCggb3B0aW9uICksCgkJCQkJCXBhcmVudCA9IG9wdGlvbi5wYXJlbnROb2RlLAoJCQkJCQl0ZXh0ID0gJG9wdGlvbi50ZXh0KCksCgkJCQkJCWFuY2hvciAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnYScgKSwKCQkJCQkJY2xhc3NlcyA9IFtdOwoKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAnaHJlZicsICcjJyApOwoJCQkJCWFuY2hvci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSApOwoKCQkJCQkvLyBBcmUgd2UgaW5zaWRlIGFuIG9wdGdyb3VwPwoJCQkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQkJCXZhciBvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICdsYWJlbCcgKTsKCQkJCQkJaWYgKCBvcHRMYWJlbCAhPT0gb3B0R3JvdXAgKSB7CgkJCQkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdsaScgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCBkYXRhUm9sZUF0dHIsICdsaXN0LWRpdmlkZXInICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ3JvbGUnLCAnb3B0aW9uJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICd0YWJpbmRleCcsICctMScgKTsKCQkJCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRMYWJlbCApICk7CgkJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCQkJb3B0R3JvdXAgPSBvcHRMYWJlbDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKCBuZWVkUGxhY2Vob2xkZXIgJiYgKCAhb3B0aW9uLmdldEF0dHJpYnV0ZSggInZhbHVlIiApIHx8IHRleHQubGVuZ3RoID09PSAwIHx8ICRvcHRpb24uanFtRGF0YSggInBsYWNlaG9sZGVyIiApICkgKSB7CgkJCQkJCW5lZWRQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJCQkvLyBJZiB3ZSBoYXZlIGlkZW50aWZpZWQgYSBwbGFjZWhvbGRlciwgcmVjb3JkIHRoZSBmYWN0IHRoYXQgaXQgd2FzCgkJCQkJCS8vIHVzIHdobyBoYXZlIGFkZGVkIHRoZSBwbGFjZWhvbGRlciB0byB0aGUgb3B0aW9uIGFuZCBtYXJrIGl0CgkJCQkJCS8vIHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQkJCWlmICggbnVsbCA9PT0gb3B0aW9uLmdldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciApICkgewoJCQkJCQkJdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyID0gdHJ1ZTsKCQkJCQkJfQoJCQkJCQlvcHRpb24uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoJCQkJCQl9CgkJCQkJCWlmICggcGxhY2Vob2xkZXIgIT09IHRleHQgKSB7CgkJCQkJCQlwbGFjZWhvbGRlciA9IHNlbGYucGxhY2Vob2xkZXIgPSB0ZXh0OwoJCQkJCQl9CgkJCQkJfQoKCQkJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7CgkJCQkJaWYgKCBvcHRpb24uZGlzYWJsZWQgKSB7CgkJCQkJCWNsYXNzZXMucHVzaCggInVpLWRpc2FibGVkIiApOwoJCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSgnYXJpYS1kaXNhYmxlZCcsdHJ1ZSk7CgkJCQkJfQoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSW5kZXhBdHRyLGkgKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUljb25BdHRyLCBkYXRhSWNvbiApOwoJCQkJCWlmICggaXNQbGFjZWhvbGRlckl0ZW0gKSB7CgkJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQkJfQoJCQkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCAiICIgKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggJ3JvbGUnLCAnb3B0aW9uJyApOwoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICd0YWJpbmRleCcsICctMScgKTsKCQkJCQlpdGVtLmFwcGVuZENoaWxkKCBhbmNob3IgKTsKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggaXRlbSApOwoJCQkJfQoKCQkJCXNlbGYubGlzdFswXS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCgkJCQkvLyBIaWRlIGhlYWRlciBpZiBpdCdzIG5vdCBhIG11bHRpc2VsZWN0IGFuZCB0aGVyZSdzIG5vIHBsYWNlaG9sZGVyCgkJCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJCQl0aGlzLmhlYWRlci5oaWRlKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCQkJfQoKCQkJCS8vIE5vdyBwb3B1bGF0ZWQsIGNyZWF0ZSBsaXN0dmlldwoJCQkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7CgkJCX0sCgoJCQlfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCAiPGE+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiaWQiOiB0aGlzLmJ1dHRvbklkLAoJCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJhcmlhLW93bnMiOiB0aGlzLm1lbnVJZAoJCQkJfSk7CgkJCX0sCgoJCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgoJCQkJLy8gUmVzdG9yZSB0aGUgdGFiaW5kZXggYXR0cmlidXRlIHRvIGl0cyBvcmlnaW5hbCB2YWx1ZQoJCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gZmFsc2UgKSB7CgkJCQkJCXRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsIHRoaXMuX29yaWdUYWJJbmRleCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMuc2VsZWN0LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIHRoZSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgaWYgd2Ugd2VyZSB0aGUgb25lcyB0byBhZGQgaXQKCQkJCWlmICggdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyICkgewoJCQkJCXRoaXMuX3NlbGVjdE9wdGlvbnMoKS5yZW1vdmVBdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicGxhY2Vob2xkZXIiICk7CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIHRoZSBwb3B1cAoJCQkJdGhpcy5saXN0Ym94LnJlbW92ZSgpOwoKCQkJCS8vIENoYWluIHVwCgkJCQlvcmlnRGVzdHJveS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0KCQl9KTsKCX07CgoJLy8gaXNzdWUgIzM4OTQgLSBjb3JlIGRvZXNuJ3QgdHJpZ2dlciBldmVudHMgb24gZGlzYWJsZWQgZGVsZWdhdGVzCgkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAic2VsZWN0bWVudWJlZm9yZWNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIGV2ZW50LnRhcmdldCApLmRhdGEoICJtb2JpbGUtc2VsZWN0bWVudSIgKTsKCgkJaWYgKCAhc2VsZWN0bWVudVdpZGdldC5vcHRpb25zLm5hdGl2ZU1lbnUgJiYKCQkJCXNlbGVjdG1lbnVXaWRnZXQuZWxlbWVudC5wYXJlbnRzKCAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSIgKS5sZW5ndGggPT09IDAgKSB7CgkJCWV4dGVuZFNlbGVjdCggc2VsZWN0bWVudVdpZGdldCApOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS5jb250cm9sZ3JvdXAiLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CgkJb3B0aW9uczogewoJCQlzaGFkb3c6IGZhbHNlLAoJCQljb3JuZXJzOiB0cnVlLAoJCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCQl0eXBlOiAidmVydGljYWwiLAoJCQltaW5pOiBmYWxzZSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQl1aSA9IHsKCQkJCQlpbm5lcjogJCggIjxkaXYgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyc+PC9kaXY+IiApLAoJCQkJCWxlZ2VuZDogJCggIjxkaXYgcm9sZT0naGVhZGluZycgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1sYWJlbCc+PC9kaXY+IiApCgkJCQl9LAoJCQkJZ3JvdXBsZWdlbmQgPSAkZWwuY2hpbGRyZW4oICJsZWdlbmQiICksCgkJCQlzZWxmID0gdGhpczsKCgkJCS8vIEFwcGx5IHRoZSBwcm90bwoJCQkkZWwud3JhcElubmVyKCB1aS5pbm5lciApOwoJCQlpZiAoIGdyb3VwbGVnZW5kLmxlbmd0aCApIHsKCQkJCXVpLmxlZ2VuZC5hcHBlbmQoIGdyb3VwbGVnZW5kICkuaW5zZXJ0QmVmb3JlKCAkZWwuY2hpbGRyZW4oIDAgKSApOwoJCQl9CgkJCSRlbC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktY29udHJvbGdyb3VwIiApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbml0aWFsUmVmcmVzaDogdHJ1ZQoJCQl9KTsKCgkJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCS8vIENhdXNlIGluaXRpYWwgb3B0aW9ucyB0byBiZSBhcHBsaWVkIGJ5IHRoZWlyIGhhbmRsZXIgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyB0aGUgb3B0aW9uIHRvIHVuZGVmaW5lZAoJCQkJLy8gLSB0aGUgaGFuZGxlciB0aGVuIHNldHMgaXQgdG8gdGhlIGluaXRpYWwgdmFsdWUKCQkJCXNlbGYub3B0aW9uc1sga2V5IF0gPSB1bmRlZmluZWQ7CgkJCQlzZWxmLl9zZXRPcHRpb24oIGtleSwgdmFsdWUsIHRydWUgKTsKCQkJfSk7CgkJfSwKCgkJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJdmFyIHNldHRlciA9ICJfc2V0IiArIGtleS5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsga2V5LnNsaWNlKCAxICk7CgoJCQlpZiAoIHRoaXNbIHNldHRlciBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzWyBzZXR0ZXIgXSggdmFsdWUgKTsKCQkJfQoKCQkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRUeXBlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwLWhvcml6b250YWwgdWktY29udHJvbGdyb3VwLXZlcnRpY2FsIiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtIiArIHZhbHVlICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRTaGFkb3c6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktc2hhZG93IiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0TWluaTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQl9LAoKCQljb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJdmFyIGVscyA9IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWJ0biIgKS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKSwKCQkJCWNyZWF0ZSA9IHRoaXMuX2luaXRpYWxSZWZyZXNoOwoJCQlpZiAoICQubW9iaWxlLmNoZWNrYm94cmFkaW8gKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggIjptb2JpbGUtY2hlY2tib3hyYWRpbyIgKS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQkJfQoJCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBlbHMsIHRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID8gdGhpcy5fZ2V0VmlzaWJsZXMoIGVscywgY3JlYXRlICkgOiBlbHMsIGNyZWF0ZSApOwoJCQl0aGlzLl9pbml0aWFsUmVmcmVzaCA9IGZhbHNlOwoJCX0KCX0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCgkvLyBUT0RPOiBJbXBsZW1lbnQgYSBtZWNoYW5pc20gdG8gYWxsb3cgd2lkZ2V0cyB0byBiZWNvbWUgZW5oYW5jZWQgaW4gdGhlCgkvLyBjb3JyZWN0IG9yZGVyIHdoZW4gdGhlaXIgY29ycmVjdCBlbmhhbmNlbWVudCBkZXBlbmRzIG9uIG90aGVyIHdpZGdldHMgaW4KCS8vIHRoZSBwYWdlIGJlaW5nIGNvcnJlY3RseSBlbmhhbmNlZCBhbHJlYWR5LgoJLy8KCS8vIEZvciBub3csIHdlIHdhaXQgdW50aWwgZG9tLXJlYWR5IHRvIGF0dGFjaCB0aGUgY29udHJvbGdyb3VwJ3MgZW5oYW5jZW1lbnQKCS8vIGhvb2ssIGJlY2F1c2UgYnkgdGhhdCB0aW1lLCBhbGwgdGhlIG90aGVyIHdpZGdldHMnIGVuaGFuY2VtZW50IGhvb2tzIHNob3VsZAoJLy8gYWxyZWFkeSBiZSBpbiBwbGFjZSwgZW5zdXJpbmcgdGhhdCBhbGwgd2lkZ2V0cyB0aGF0IG5lZWQgdG8gYmUgZ3JvdXBlZCB3aWxsCgkvLyBhbHJlYWR5IGhhdmUgYmVlbiBlbmhhbmNlZCBieSB0aGUgdGltZSB0aGUgY29udHJvbGdyb3VwIGlzIGNyZWF0ZWQuCgkkKCBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApICB7CgkJCSQubW9iaWxlLmNvbnRyb2xncm91cC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKCQl9KTsKCX0pOwp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCS8vbGlua3Mgd2l0aGluIGNvbnRlbnQgYXJlYXMsIHRlc3RzIGluY2x1ZGVkIHdpdGggcGFnZQoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLm5vdCggIi51aS1idG4sIC51aS1saW5rLWluaGVyaXQsIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS5maXhlZHRvb2xiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCQlvcHRpb25zOiB7CgkJCXZpc2libGVPblBhZ2VTaG93OiB0cnVlLAoJCQlkaXNhYmxlUGFnZVpvb206IHRydWUsCgkJCXRyYW5zaXRpb246ICJzbGlkZSIsIC8vY2FuIGJlIG5vbmUsIGZhZGUsIHNsaWRlIChzbGlkZSBtYXBzIHRvIHNsaWRldXAgb3Igc2xpZGVkb3duKQoJCQlmdWxsc2NyZWVuOiBmYWxzZSwKCQkJdGFwVG9nZ2xlOiB0cnVlLAoJCQl0YXBUb2dnbGVCbGFja2xpc3Q6ICJhLCBidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCAudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkLCAudWktcG9wdXAsIC51aS1wYW5lbCwgLnVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCWhpZGVEdXJpbmdGb2N1czogImlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0IiwKCQkJdXBkYXRlUGFnZVBhZGRpbmc6IHRydWUsCgkJCXRyYWNrUGVyc2lzdGVudFRvb2xiYXJzOiB0cnVlLAoKCQkJLy8gQnJvd3NlciBkZXRlY3Rpb24hIFdlZWVlLCBoZXJlIHdlIGdvLi4uCgkJCS8vIFVuZm9ydHVuYXRlbHksIHBvc2l0aW9uOmZpeGVkIGlzIGNvc3RseSwgbm90IHRvIG1lbnRpb24gcHJvYmFibHkgaW1wb3NzaWJsZSwgdG8gZmVhdHVyZS1kZXRlY3QgYWNjdXJhdGVseS4KCQkJLy8gU29tZSB0ZXN0cyBleGlzdCwgYnV0IHRoZXkgY3VycmVudGx5IHJldHVybiBmYWxzZSByZXN1bHRzIGluIGNyaXRpY2FsIGRldmljZXMgYW5kIGJyb3dzZXJzLCB3aGljaCBjb3VsZCBsZWFkIHRvIGEgYnJva2VuIGV4cGVyaWVuY2UuCgkJCS8vIFRlc3RpbmcgZml4ZWQgcG9zaXRpb25pbmcgaXMgYWxzbyBwcmV0dHkgb2J0cnVzaXZlIHRvIHBhZ2UgbG9hZCwgcmVxdWlyaW5nIGluamVjdGVkIGVsZW1lbnRzIGFuZCBzY3JvbGxpbmcgdGhlIHdpbmRvdwoJCQkvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIHNlcnZlcyB0byBydWxlIG91dCBzb21lIHBvcHVsYXIgYnJvd3NlcnMgd2l0aCBrbm93biBmaXhlZC1wb3NpdGlvbmluZyBpc3N1ZXMKCQkJLy8gVGhpcyBpcyBhIHBsdWdpbiBvcHRpb24gbGlrZSBhbnkgb3RoZXIsIHNvIGZlZWwgZnJlZSB0byBpbXByb3ZlIG9yIG92ZXJ3cml0ZSBpdAoJCQlzdXBwb3J0QmxhY2tsaXN0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhJC5zdXBwb3J0LmZpeGVkUG9zaXRpb247CgkJCX0sCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJCXRidHlwZSA9ICRlbC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIiwKCQkJCSRwYWdlID0gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCgkJCS8vIEZlYXR1cmUgZGV0ZWN0aW5nIHN1cHBvcnQgZm9yCgkJCWlmICggby5zdXBwb3J0QmxhY2tsaXN0KCkgKSB7CgkJCQlzZWxmLmRlc3Ryb3koKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZpeGVkIiApOwoKCQkJLy8gImZ1bGxzY3JlZW4iIG92ZXJsYXkgcG9zaXRpb25pbmcKCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkkZWwuYWRkQ2xhc3MoICJ1aS0iKyB0YnR5cGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1mdWxsc2NyZWVuIiApOwoJCQl9CgkJCS8vIElmIG5vdCBmdWxsc2NyZWVuLCBhZGQgY2xhc3MgdG8gcGFnZSB0byBzZXQgdG9wIG9yIGJvdHRvbSBwYWRkaW5nCgkJCWVsc2V7CgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRidHlwZSArICItZml4ZWQiICk7CgkJCX0KCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfdGhpc1BhZ2U6IG51bGwKCQkJfSk7CiAKCQkJc2VsZi5fYWRkVHJhbnNpdGlvbkNsYXNzKCk7CgkJCXNlbGYuX2JpbmRQYWdlRXZlbnRzKCk7CgkJCXNlbGYuX2JpbmRUb2dnbGVIYW5kbGVycygpOwoJCX0sCgoJCV9hZGRUcmFuc2l0aW9uQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGNsYXNzID0gdGhpcy5vcHRpb25zLnRyYW5zaXRpb247CgoJCQlpZiAoIHRjbGFzcyAmJiB0Y2xhc3MgIT09ICJub25lIiApIHsKCQkJCS8vIHVzZSBhcHByb3ByaWF0ZSBzbGlkZSBmb3IgaGVhZGVyIG9yIGZvb3RlcgoJCQkJaWYgKCB0Y2xhc3MgPT09ICJzbGlkZSIgKSB7CgkJCQkJdGNsYXNzID0gdGhpcy5lbGVtZW50LmlzKCAiLnVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl90aGlzUGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJCS8vcGFnZSBldmVudCBiaW5kaW5ncwoJCQkvLyBGaXhlZCB0b29sYmFycyByZXF1aXJlIHBhZ2Ugem9vbSB0byBiZSBkaXNhYmxlZCwgb3RoZXJ3aXNlIHVzYWJpbGl0eSBpc3N1ZXMgY3JvcCB1cAoJCQkvLyBUaGlzIG1ldGhvZCBpcyBtZWFudCB0byBkaXNhYmxlIHpvb20gd2hpbGUgYSBmaXhlZC1wb3NpdGlvbmVkIHRvb2xiYXIgcGFnZSBpcyB2aXNpYmxlCgkJCXRoaXMuX29uKCB0aGlzLl90aGlzUGFnZSwgewoJCQkJInBhZ2ViZWZvcmVzaG93IjogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCQkid2Via2l0QW5pbWF0aW9uU3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJImFuaW1hdGlvbnN0YXJ0IjoiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJ1cGRhdGVsYXlvdXQiOiAiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlUGFnZVNob3ciLAoJCQkJInBhZ2ViZWZvcmVoaWRlIjogIl9oYW5kbGVQYWdlQmVmb3JlSGlkZSIKCQkJfSk7CgkJfSwKCgkJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbigpIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJdGhpcy5oaWRlKCB0cnVlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlQW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXMuX3RoaXNQYWdlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZVNob3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCB0aGlzLl90aGlzUGFnZSApOwoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29uKCAkLm1vYmlsZS53aW5kb3csIHsgInRocm90dGxlZHJlc2l6ZSI6ICJ1cGRhdGVQYWdlUGFkZGluZyIgfSApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VCZWZvcmVIaWRlOiBmdW5jdGlvbiggZSwgdWkgKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkJaWYgKCBvLmRpc2FibGVQYWdlWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQkJaWYgKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb2ZmKCAkLm1vYmlsZS53aW5kb3csICJ0aHJvdHRsZWRyZXNpemUiICk7CgkJCX0KCgkJCWlmICggby50cmFja1BlcnNpc3RlbnRUb29sYmFycyApIHsKCQkJCXZhciB0aGlzRm9vdGVyID0gJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLl90aGlzUGFnZSApLAoJCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMuX3RoaXNQYWdlICksCgkJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpLAoJCQkJCW5leHRIZWFkZXIgPSB0aGlzSGVhZGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0hlYWRlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKTsKCgkJCQlpZiAoIG5leHRGb290ZXIubGVuZ3RoIHx8IG5leHRIZWFkZXIubGVuZ3RoICkgewoKCQkJCQluZXh0Rm9vdGVyLmFkZCggbmV4dEhlYWRlciApLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJCXVpLm5leHRQYWdlLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCW5leHRIZWFkZXIucHJlcGVuZFRvKCB0aGlzICk7CgkJCQkJCW5leHRGb290ZXIuYXBwZW5kVG8oIHRoaXMgKTsKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0sCgoJCV92aXNpYmxlOiB0cnVlLAoKCQkvLyBUaGlzIHdpbGwgc2V0IHRoZSBjb250ZW50IGVsZW1lbnQncyB0b3Agb3IgYm90dG9tIHBhZGRpbmcgZXF1YWwgdG8gdGhlIHRvb2xiYXIncyBoZWlnaHQKCQl1cGRhdGVQYWdlUGFkZGluZzogZnVuY3Rpb24oIHRiUGFnZSApIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICksCgkJCQlwb3MgPSBwYXJzZUZsb2F0KCAkZWwuY3NzKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICkgKTsKCgkJCS8vIFRoaXMgYmVoYXZpb3Igb25seSBhcHBsaWVzIHRvICJmaXhlZCIsIG5vdCAiZnVsbHNjcmVlbiIKCQkJaWYgKCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiApIHsgcmV0dXJuOyB9CgoJCQkvLyB0YlBhZ2UgYXJndW1lbnQgY2FuIGJlIGEgUGFnZSBvYmplY3Qgb3IgYW4gZXZlbnQsIGlmIGNvbWluZyBmcm9tIHRocm90dGxlZCByZXNpemUuIAoJCQl0YlBhZ2UgPSAoIHRiUGFnZSAmJiB0YlBhZ2UudHlwZSA9PT0gdW5kZWZpbmVkICYmIHRiUGFnZSApIHx8IHRoaXMuX3RoaXNQYWdlIHx8ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSArIHBvcyApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdywKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCXNjcm9sbCA9ICR3aW4uc2Nyb2xsVG9wKCksCgkJCQllbEhlaWdodCA9ICRlbC5oZWlnaHQoKSwKCQkJCXBIZWlnaHQgPSAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLmhlaWdodCgpLAoJCQkJdmlld3BvcnRIZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSwKCQkJCXRidHlwZSA9ICRlbC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIjsKCgkJCXJldHVybiAhbm90cmFuc2l0aW9uICYmCgkJCQkoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICYmIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICE9PSAibm9uZSIgJiYKCQkJCSgKCQkJCQkoIHRidHlwZSA9PT0gImhlYWRlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCA+IGVsSGVpZ2h0ICkgfHwKCQkJCQkoIHRidHlwZSA9PT0gImZvb3RlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCArIHZpZXdwb3J0SGVpZ2h0IDwgcEhlaWdodCAtIGVsSGVpZ2h0ICkKCQkJCSkgfHwgdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4KCQkJCSk7CgkJfSwKCgkJc2hvdzogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50OwoKCQkJaWYgKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCAiICsgaGlkZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoICJpbiIgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbiAoKSB7CgkJCQkJCSRlbC5yZW1vdmVDbGFzcygnaW4nKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5yZW1vdmVDbGFzcyggaGlkZUNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IHRydWU7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkuYWRkQ2xhc3MoIG91dGNsYXNzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJpbiIgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpIHsKCQkJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IGZhbHNlOwoJCX0sCgoJCXRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJCXRoaXNbIHRoaXMuX3Zpc2libGUgPyAiaGlkZSIgOiAic2hvdyIgXSgpOwoJCX0sCgoJCV9iaW5kVG9nZ2xlSGFuZGxlcnM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50LAoJCQkJZGVsYXlTaG93LCBkZWxheUhpZGUsCgkJCQlpc1Zpc2libGUgPSB0cnVlOwoKCQkJLy8gdGFwIHRvZ2dsZQoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApCgkJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCWlmICggby50YXBUb2dnbGUgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggby50YXBUb2dnbGVCbGFja2xpc3QgKS5sZW5ndGggKSB7CgkJCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZm9jdXNpbiBmb2N1c291dCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCS8vdGhpcyBoaWRlcyB0aGUgdG9vbGJhcnMgb24gYSBrZXlib2FyZCBwb3AgdG8gZ2l2ZSBtb3JlIHNjcmVlbiByb29tIGFuZCBwcmV2ZW50IGlvcyBidWcgd2hpY2ggCgkJCQkJLy9wb3NpdGlvbnMgZml4ZWQgdG9vbGJhcnMgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuIG9uIHBvcCBpZiB0aGUgaW5wdXQgaXMgbmVhciB0aGUgdG9wIG9yCgkJCQkJLy9ib3R0b20gb2YgdGhlIHNjcmVlbiBhZGRyZXNzZXMgaXNzdWVzICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCS8vYW5kIGlzc3VlICM0MTEzIEhlYWRlciBhbmQgZm9vdGVyIGNoYW5nZSB0aGVpciBwb3NpdGlvbiBhZnRlciBrZXlib2FyZCBwb3B1cCAtIGlPUwoJCQkJCS8vYW5kIGlzc3VlICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgMTAyNSAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApIHsKCQkJCQkJLy9GaXggZm9yIGlzc3VlICM0NzI0IE1vdmluZyB0aHJvdWdoIGZvcm0gaW4gTW9iaWxlIFNhZmFyaSB3aXRoICJOZXh0IiBhbmQgIlByZXZpb3VzIiBzeXN0ZW0gCgkJCQkJCS8vY29udHJvbHMgY2F1c2VzIGZpeGVkIHBvc2l0aW9uLCB0YXAtdG9nZ2xlIGZhbHNlIEhlYWRlciB0byByZXZlYWwgaXRzZWxmCgkJCQkJCS8vIGlzVmlzaWJsZSBpbnN0ZWFkIG9mIHNlbGYuX3Zpc2libGUgYmVjYXVzZSB0aGUgZm9jdXNpbiBhbmQgZm9jdXNvdXQgZXZlbnRzIGZpcmUgdHdpY2UgYXQgdGhlIHNhbWUgdGltZQoJCQkJCQkvLyBBbHNvIHVzZSBhIGRlbGF5IGZvciBoaWRpbmcgdGhlIHRvb2xiYXJzIGJlY2F1c2Ugb24gQW5kcm9pZCBuYXRpdmUgYnJvd3NlciBmb2N1c2luIGlzIGRpcmVjbHR5IGZvbGxvd2VkCgkJCQkJCS8vIGJ5IGEgZm9jdXNvdXQgd2hlbiBhIG5hdGl2ZSBzZWxlY3RzIG9wZW5zIGFuZCB0aGUgb3RoZXIgd2F5IGFyb3VuZCB3aGVuIGl0IGNsb3Nlcy4KCQkJCQkJaWYgKCBlLnR5cGUgPT09ICJmb2N1c291dCIgJiYgIWlzVmlzaWJsZSApIHsKCQkJCQkJCWlzVmlzaWJsZSA9IHRydWU7CgkJCQkJCQkvL3dhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYW5kIHNlZSBpZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0CgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5SGlkZSApOwoJCQkJCQkJZGVsYXlTaG93ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJc2VsZi5zaG93KCk7CgkJCQkJCQl9LCAwICk7IAoJCQkJCQl9IGVsc2UgaWYgKCBlLnR5cGUgPT09ICJmb2N1c2luIiAmJiAhIWlzVmlzaWJsZSApIHsKCQkJCQkJCS8vaWYgd2UgaGF2ZSBqdW1wZWQgdG8gYW5vdGhlciBpbnB1dCBjbGVhciB0aGUgdGltZSBvdXQgdG8gY2FuY2VsIHRoZSBzaG93LgoJCQkJCQkJY2xlYXJUaW1lb3V0KCBkZWxheVNob3cgKTsKCQkJCQkJCWlzVmlzaWJsZSA9IGZhbHNlOwoJCQkJCQkJZGVsYXlIaWRlID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJc2VsZi5oaWRlKCk7CgkJCQkJCQl9LCAwICk7IAoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmlzKCAiLnVpLWhlYWRlciIgKTsKCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICIiICk7CgkJCSRlbC5yZW1vdmVDbGFzcyggInVpLWhlYWRlci1maXhlZCB1aS1mb290ZXItZml4ZWQgdWktaGVhZGVyLWZ1bGxzY3JlZW4gdWktZm9vdGVyLWZ1bGxzY3JlZW4gaW4gb3V0IGZhZGUgc2xpZGVkb3duIHNsaWRldXAgdWktZml4ZWQtaGlkZGVuIiApOwoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLnJlbW92ZUNsYXNzKCAidWktcGFnZS1oZWFkZXItZml4ZWQgdWktcGFnZS1mb290ZXItZml4ZWQgdWktcGFnZS1oZWFkZXItZnVsbHNjcmVlbiB1aS1wYWdlLWZvb3Rlci1mdWxsc2NyZWVuIiApOwoJCX0KCgl9KTsKCgkvL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKCSQubW9iaWxlLmRvY3VtZW50CgkJLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCQkJLy8gREVQUkVDQVRFRCBpbiAxLjE6IHN1cHBvcnQgZm9yIGRhdGEtZnVsbHNjcmVlbj10cnVlfGZhbHNlIG9uIHRoZSBwYWdlIGVsZW1lbnQuCgkJCS8vIFRoaXMgbGluZSBlbnN1cmVzIGl0IHN0aWxsIHdvcmtzLCBidXQgd2UgcmVjb21tZW5kIG1vdmluZyB0aGUgYXR0cmlidXRlIHRvIHRoZSB0b29sYmFycyB0aGVtc2VsdmVzLgoJCQlpZiAoICQoIGUudGFyZ2V0ICkuanFtRGF0YSggImZ1bGxzY3JlZW4iICkgKSB7CgkJCQkkKCAkLm1vYmlsZS5maXhlZHRvb2xiYXIucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCBlLnRhcmdldCApLm5vdCggIjpqcW1EYXRhKGZ1bGxzY3JlZW4pIiApLmpxbURhdGEoICJmdWxsc2NyZWVuIiwgdHJ1ZSApOwoJCQl9CgoJCQkkLm1vYmlsZS5maXhlZHRvb2xiYXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7CgkJfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLmZpeGVkdG9vbGJhciIsICQubW9iaWxlLmZpeGVkdG9vbGJhciwgewoKCQkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9zdXBlcigpOwoJCQkJdGhpcy5fd29ya2Fyb3VuZHMoKTsKCQkJfSwKCgkJCS8vY2hlY2sgdGhlIGJyb3dzZXIgYW5kIHZlcnNpb24gYW5kIHJ1biBuZWVkZWQgd29ya2Fyb3VuZHMKCQkJX3dvcmthcm91bmRzOiBmdW5jdGlvbigpIHsKCQkJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJb3MgPSBudWxsLAoJCQkJc2VsZiA9IHRoaXM7CgkJCQkvL3NldCB0aGUgb3Mgd2UgYXJlIHdvcmtpbmcgaW4gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQkJaWYoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICl7CgkJCQkJb3MgPSAiaW9zIjsKCQkJCX0gZWxzZSBpZiggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSApewoJCQkJCW9zID0gImFuZHJvaWQiOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkvL2NoZWNrIG9zIHZlcnNpb24gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQkJaWYoIG9zID09PSAiaW9zIiApIHsKCQkJCQkvL2lPUyAgd29ya2Fyb3VuZHMKCQkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQkJfSBlbHNlIGlmKCBvcyA9PT0gImFuZHJvaWQiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB7CgkJCQkJLy9BbmRyb2lkIDIuMyBydW4gYWxsIEFuZHJvaWQgMi4zIHdvcmthcm91bmQKCQkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQkJCXNlbGYuX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kKCk7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfSwKCgkJCS8vVXRpbGl0eSBjbGFzcyBmb3IgY2hlY2tpbmcgaGVhZGVyIGFuZCBmb290ZXIgcG9zaXRpb25zIHJlbGF0aXZlIHRvIHZpZXdwb3J0CgkJCV92aWV3cG9ydE9mZnNldDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICksCgkJCQkJb2Zmc2V0ID0gTWF0aC5hYnMoJGVsLm9mZnNldCgpLnRvcCAtICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSk7CgkJCQlpZiggIWhlYWRlciApIHsKCQkJCQlvZmZzZXQgPSBNYXRoLnJvdW5kKG9mZnNldCAtICQubW9iaWxlLndpbmRvdy5oZWlnaHQoKSArICRlbC5vdXRlckhlaWdodCgpKS02MDsKCQkJCX0KCQkJCXJldHVybiBvZmZzZXQ7CgkJCX0sCgoJCQkvL2JpbmQgZXZlbnRzIGZvciBfdHJpZ2dlclJlZHJhdygpIGZ1bmN0aW9uIAoJCQlfYmluZFNjcm9sbFdvcmthcm91bmQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJLy9iaW5kIHRvIHNjcm9sbHN0b3AgYW5kIGNoZWNrIGlmIHRoZSB0b29sYmFycyBhcmUgY29ycmVjdGx5IHBvc2l0aW9uZWQKCQkJCXRoaXMuX29uKCAkLm1vYmlsZS53aW5kb3csIHsgc2Nyb2xsc3RvcDogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHZpZXdwb3J0T2Zmc2V0ID0gc2VsZi5fdmlld3BvcnRPZmZzZXQoKTsKCQkJCQkvL2NoZWNrIGlmIHRoZSBoZWFkZXIgaXMgdmlzaWJsZSBhbmQgaWYgaXRzIGluIHRoZSByaWdodCBwbGFjZQoJCQkJCWlmKCB2aWV3cG9ydE9mZnNldCA+IDIgJiYgc2VsZi5fdmlzaWJsZSkgewoJCQkJCQlzZWxmLl90cmlnZ2VyUmVkcmF3KCk7CgkJCQkJfQoJCQkJfX0pOwoJCQl9LAoKCQkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZSAjNDI1MCBQZXJzaXN0ZW50IGZvb3RlciBpbnN0YWJpbGl0eSBpbiB2MS4xIHdpdGggbG9uZyBzZWxlY3QgbGlzdHMgaW4gQW5kcm9pZCAyLjMuMwoJCQkvL2FuZCBpc3N1ZSAjMzc0OCBBbmRyb2lkIDIueDogUGFnZSB0cmFuc2l0aW9ucyBicm9rZW4gd2hlbiBmaXhlZCB0b29sYmFycyB1c2VkCgkJCS8vdGhlIGFic29sdXRlbHkgcG9zaXRpb25lZCB0aHVtYm5haWwgaW4gYSBsaXN0IHZpZXcgY2F1c2VzIHByb2JsZW1zIHdpdGggZml4ZWQgcG9zaXRpb24gYnV0dG9ucyBhYm92ZSBpbiBhIG5hdiBiYXIKCQkJLy9zZXR0aW5nIHRoZSBsaSdzIHRvIC13ZWJraXQtdHJhbnNmb3JtOnRyYW5zbGF0ZTNkKDAsMCwwKTsgc29sdmVzIHRoaXMgcHJvYmxlbSB0byBhdm9pZGUgcG90ZW50aWFsIGlzc3VlcyBpbiBvdGhlcgoJCQkvL3BsYXRmb3JtcyB3ZSBzY29wZSB0aGlzIHdpdGggdGhlIGNsYXNzIHVpLWFuZHJvaWQtMngtZml4CgkJCV9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCgiLnVpLXBhZ2UiKS5hZGRDbGFzcyggInVpLWFuZHJvaWQtMngtZml4ZWQiICk7CgkJCX0sCgkJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWVzICM0MzM3IEZpeGVkIGhlYWRlciBwcm9ibGVtIGFmdGVyIHNjcm9sbGluZyBjb250ZW50IG9uIGlPUyBhbmQgQW5kcm9pZAoJCQkvL2FuZCBkZXZpY2UgYnVncyBwcm9qZWN0IGlzc3VlICMxIEZvcm0gZWxlbWVudHMgY2FuIGxvc2UgY2xpY2sgaGl0IGFyZWEgaW4gcG9zaXRpb246IGZpeGVkIGNvbnRhaW5lcnMuCgkJCS8vdGhpcyBhbHNvIGFkZHJlc3NlcyBub3Qgb24gZml4ZWQgdG9vbGJhcnMgcGFnZSBpbiBkb2NzCgkJCS8vYWRkaW5nIDFweCBvZiBwYWRkaW5nIHRvIHRoZSBib3R0b20gdGhlbiByZW1vdmluZyBpdCBjYXVzZXMgYSAicmVkcmF3IgoJCQkvL3doaWNoIHBvc2l0aW9ucyB0aGUgdG9vbGJhcnMgY29ycmVjdGx5ICh0aGV5IHdpbGwgYWx3YXlzIGJlIHZpc3VhbGx5IGNvcnJlY3QpIAoJCQlfdHJpZ2dlclJlZHJhdzogZnVuY3Rpb24oKSB7CgkJCQl2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoICQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKTsKCQkJCS8vdHJpZ2dlciBwYWdlIHJlZHJhdyB0byBmaXggaW5jb3JyZWN0bHkgcG9zaXRpb25lZCBmaXhlZCBlbGVtZW50cwoJCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIsICggcGFkZGluZ0JvdHRvbSArIDEgKSArInB4IiApOwoJCQkJLy9pZiB0aGUgcGFkZGluZyBpcyByZXNldCB3aXRoIG91dCBhIHRpbWVvdXQgdGhlIHJlcG9zaXRpb24gd2lsbCBub3Qgb2NjdXJlLgoJCQkJLy90aGlzIGlzIGluZGVwZW5kYW50IG9mIEpRTSB0aGUgYnJvd3NlciBzZWVtcyB0byBuZWVkIHRoZSB0aW1lIHRvIHJlYWN0LgoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIsIHBhZGRpbmdCb3R0b20gKyAicHgiICk7CgkJCQl9LCAwICk7CgkJCX0sCgoJCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3N1cGVyKCk7CgkJCQkvL1JlbW92ZSB0aGUgY2xhc3Mgd2UgYWRkZWQgdG8gdGhlIHBhZ2UgcHJldmlvdXNseSBpbiBhbmRyb2lkIDIueCAKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCIudWktcGFnZS1hY3RpdmUiKS5yZW1vdmVDbGFzcyggInVpLWFuZHJvaWQtMngtZml4IiApOwoJCQl9Cgl9KTsKCgl9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhbmVsIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQlwYW5lbDogInVpLXBhbmVsIiwKCQkJcGFuZWxPcGVuOiAidWktcGFuZWwtb3BlbiIsCgkJCXBhbmVsQ2xvc2VkOiAidWktcGFuZWwtY2xvc2VkIiwKCQkJcGFuZWxGaXhlZDogInVpLXBhbmVsLWZpeGVkIiwKCQkJcGFuZWxJbm5lcjogInVpLXBhbmVsLWlubmVyIiwKCQkJbW9kYWw6ICJ1aS1wYW5lbC1kaXNtaXNzIiwKCQkJbW9kYWxPcGVuOiAidWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJcGFnZVBhbmVsOiAidWktcGFnZS1wYW5lbCIsCgkJCXBhZ2VQYW5lbE9wZW46ICJ1aS1wYWdlLXBhbmVsLW9wZW4iLAoJCQljb250ZW50V3JhcDogInVpLXBhbmVsLWNvbnRlbnQtd3JhcCIsCgkJCWNvbnRlbnRXcmFwT3BlbjogInVpLXBhbmVsLWNvbnRlbnQtd3JhcC1vcGVuIiwKCQkJY29udGVudFdyYXBDbG9zZWQ6ICJ1aS1wYW5lbC1jb250ZW50LXdyYXAtY2xvc2VkIiwKCQkJY29udGVudEZpeGVkVG9vbGJhcjogInVpLXBhbmVsLWNvbnRlbnQtZml4ZWQtdG9vbGJhciIsCgkJCWNvbnRlbnRGaXhlZFRvb2xiYXJPcGVuOiAidWktcGFuZWwtY29udGVudC1maXhlZC10b29sYmFyLW9wZW4iLAoJCQljb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkOiAidWktcGFuZWwtY29udGVudC1maXhlZC10b29sYmFyLWNsb3NlZCIsCgkJCWFuaW1hdGU6ICJ1aS1wYW5lbC1hbmltYXRlIgoJCX0sCgkJYW5pbWF0ZTogdHJ1ZSwKCQl0aGVtZTogImMiLAoJCXBvc2l0aW9uOiAibGVmdCIsCgkJZGlzbWlzc2libGU6IHRydWUsCgkJZGlzcGxheTogInJldmVhbCIsIC8vYWNjZXB0cyByZXZlYWwsIHB1c2gsIG92ZXJsYXkKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdwYW5lbCcpIiwKCQlzd2lwZUNsb3NlOiB0cnVlLAoJCXBvc2l0aW9uRml4ZWQ6IGZhbHNlCgl9LAoKCV9wYW5lbElEOiBudWxsLAoJX2Nsb3NlTGluazogbnVsbCwKCV9wYWdlOiBudWxsLAoJX21vZGFsOiBudWxsLAoJX3BhbmVsSW5uZXI6IG51bGwsCglfd3JhcHBlcjogbnVsbCwKCV9maXhlZFRvb2xiYXI6IG51bGwsCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkZWwgPSBzZWxmLmVsZW1lbnQsCgkJCXBhZ2UgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJX2dldFBhZ2VUaGVtZSA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGVtZSA9ICQuZGF0YSggcGFnZVswXSwgIm1vYmlsZVBhZ2UiICkub3B0aW9ucy50aGVtZSwKCQkJCSRwYWdlVGhlbWVDbGFzcyA9ICJ1aS1ib2R5LSIgKyAkdGhlbWU7CgkJCQlyZXR1cm4gJHBhZ2VUaGVtZUNsYXNzOwoJCQl9LAoJCQlfZ2V0UGFuZWxJbm5lciA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICRwYW5lbElubmVyID0gJGVsLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKTsKCQkJCWlmICggJHBhbmVsSW5uZXIubGVuZ3RoID09PSAwICkgewoJCQkJCSRwYW5lbElubmVyID0gJGVsLmNoaWxkcmVuKCkud3JhcEFsbCggJzxkaXYgY2xhc3M9IicgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICsgJyIgLz4nICkucGFyZW50KCk7CgkJCQl9CgkJCQlyZXR1cm4gJHBhbmVsSW5uZXI7CgkJCX0sCgkJCV9nZXRXcmFwcGVyID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHdyYXBwZXIgPSBwYWdlLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRXcmFwICk7CgkJCQlpZiAoICR3cmFwcGVyLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkkd3JhcHBlciA9IHBhZ2UuY2hpbGRyZW4oICIudWktaGVhZGVyOm5vdCg6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSksIC51aS1jb250ZW50Om5vdCg6anFtRGF0YShyb2xlPSdwb3B1cCcpKSwgLnVpLWZvb3Rlcjpub3QoOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykpIiApLndyYXBBbGwoICc8ZGl2IGNsYXNzPSInICsgc2VsZi5vcHRpb25zLmNsYXNzZXMuY29udGVudFdyYXAgKyAnICcgKyBfZ2V0UGFnZVRoZW1lKCkgKyAnIiAvPicgKS5wYXJlbnQoKTsKCQkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXNlbGYub3B0aW9ucy5hbmltYXRlICkgewoJCQkJCQkkd3JhcHBlci5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAkd3JhcHBlcjsKCQkJfSwKCQkJX2dldEZpeGVkVG9vbGJhciA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyICRmaXhlZFRvb2xiYXIgPSBwYWdlLmZpbmQoICIuIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXIgKTsKCQkJCWlmICggJGZpeGVkVG9vbGJhci5sZW5ndGggPT09IDAgKSB7CgkJCQkJJGZpeGVkVG9vbGJhciA9IHBhZ2UuZmluZCggIi51aS1oZWFkZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSwgLnVpLWZvb3RlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiApLmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyICk7CgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFzZWxmLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJCQkJJGZpeGVkVG9vbGJhci5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAkZml4ZWRUb29sYmFyOwoJCQl9OwoKCQkvLyBleHBvc2Ugc29tZSBwcml2YXRlIHByb3BzIHRvIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfcGFuZWxJRDogJGVsLmF0dHIoICJpZCIgKSwKCQkJX2Nsb3NlTGluazogJGVsLmZpbmQoICI6anFtRGF0YShyZWw9J2Nsb3NlJykiICksCgkJCV9wYWdlOiAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJX3BhZ2VUaGVtZTogX2dldFBhZ2VUaGVtZSgpLAoJCQlfcGFuZWxJbm5lcjogX2dldFBhbmVsSW5uZXIoKSwKCQkJX3dyYXBwZXI6IF9nZXRXcmFwcGVyKCksCgkJCV9maXhlZFRvb2xiYXI6IF9nZXRGaXhlZFRvb2xiYXIoKQoJCX0pOwoJCQoJCXNlbGYuX2FkZFBhbmVsQ2xhc3NlcygpOwoJCXNlbGYuX3dyYXBwZXIuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRXcmFwQ2xvc2VkICk7CgkJc2VsZi5fZml4ZWRUb29sYmFyLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkICk7CgkJLy8gYWRkIGNsYXNzIHRvIHBhZ2Ugc28gd2UgY2FuIHNldCAib3ZlcmZsb3cteDogaGlkZGVuOyIgZm9yIGl0IHRvIGZpeCBBbmRyb2lkIHpvb20gaXNzdWUKCQlzZWxmLl9wYWdlLmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5wYWdlUGFuZWwgKTsKCQkKCQkvLyBpZiBhbmltYXRpbmcsIGFkZCB0aGUgY2xhc3MgdG8gZG8gc28KCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXNlbGYub3B0aW9ucy5hbmltYXRlICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHNlbGYub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQl9CgkJCgkJc2VsZi5fYmluZFVwZGF0ZUxheW91dCgpOwoJCXNlbGYuX2JpbmRDbG9zZUV2ZW50cygpOwoJCXNlbGYuX2JpbmRMaW5rTGlzdGVuZXJzKCk7CgkJc2VsZi5fYmluZFBhZ2VFdmVudHMoKTsKCgkJaWYgKCAhIXNlbGYub3B0aW9ucy5kaXNtaXNzaWJsZSApIHsKCQkJc2VsZi5fY3JlYXRlTW9kYWwoKTsKCQl9CgoJCXNlbGYuX2JpbmRTd2lwZUV2ZW50cygpOwoJfSwKCglfY3JlYXRlTW9kYWw6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBzZWxmID0gdGhpczsKCQkKCQlzZWxmLl9tb2RhbCA9ICQoICI8ZGl2IGNsYXNzPSciICsgc2VsZi5vcHRpb25zLmNsYXNzZXMubW9kYWwgKyAiJyBkYXRhLXBhbmVsaWQ9JyIgKyBzZWxmLl9wYW5lbElEICsgIic+PC9kaXY+IiApCgkJCS5vbiggIm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5jbG9zZSgpOwoJCQl9KQoJCQkuYXBwZW5kVG8oIHRoaXMuX3BhZ2UgKTsKCX0sCgoJX2dldFBvc0Rpc3BsYXlDbGFzc2VzOiBmdW5jdGlvbiggcHJlZml4ICkgewoJCXJldHVybiBwcmVmaXggKyAiLXBvc2l0aW9uLSIgKyB0aGlzLm9wdGlvbnMucG9zaXRpb24gKyAiICIgKyBwcmVmaXggKyAiLWRpc3BsYXktIiArIHRoaXMub3B0aW9ucy5kaXNwbGF5OwoJfSwKCglfZ2V0UGFuZWxDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFuZWxDbGFzc2VzID0gdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWwgKwoJCQkiICIgKyB0aGlzLl9nZXRQb3NEaXNwbGF5Q2xhc3NlcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWwgKSArCgkJCSIgIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsQ2xvc2VkOwoKCQlpZiAoIHRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJcGFuZWxDbGFzc2VzICs9ICIgdWktYm9keS0iICsgdGhpcy5vcHRpb25zLnRoZW1lOwoJCX0KCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkOwoJCX0KCQlyZXR1cm4gcGFuZWxDbGFzc2VzOwoJfSwKCglfYWRkUGFuZWxDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMuX2dldFBhbmVsQ2xhc3NlcygpICk7Cgl9LAoKCV9iaW5kQ2xvc2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCQkKCQlzZWxmLl9jbG9zZUxpbmsub24oICJjbGljay5wYW5lbCIgLCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWxmLmNsb3NlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCQlzZWxmLmVsZW1lbnQub24oICJjbGljay5wYW5lbCIgLCAiYTpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiLCBmdW5jdGlvbiggZSApIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwkJCgl9LAoKCV9wb3NpdGlvblBhbmVsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXBhbmVsSW5uZXJIZWlnaHQgPSBzZWxmLl9wYW5lbElubmVyLm91dGVySGVpZ2h0KCksCgkJCWV4cGFuZCA9IHBhbmVsSW5uZXJIZWlnaHQgPiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJaWYgKCBleHBhbmQgfHwgIXNlbGYub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlpZiAoIGV4cGFuZCApIHsKCQkJCXNlbGYuX3VuZml4UGFuZWwoKTsKCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCggcGFuZWxJbm5lckhlaWdodCApOwoJCQl9CgkJCXNlbGYuX3Njcm9sbEludG9WaWV3KCBwYW5lbElubmVySGVpZ2h0ICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5fZml4UGFuZWwoKTsKCQl9Cgl9LAoKCV9zY3JvbGxJbnRvVmlldzogZnVuY3Rpb24oIHBhbmVsSW5uZXJIZWlnaHQgKSB7CgkJaWYgKCBwYW5lbElubmVySGVpZ2h0IDwgJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgKSB7CgkJCXdpbmRvdy5zY3JvbGxUbyggMCwgMCApOwoJCX0JCgl9LAoKCV9iaW5kRml4TGlzdGVuZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAkKCB3aW5kb3cgKSwgeyAidGhyb3R0bGVkcmVzaXplIjogIl9wb3NpdGlvblBhbmVsIiB9KTsKCX0sCgoJX3VuYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vZmYoICQoIHdpbmRvdyApLCAidGhyb3R0bGVkcmVzaXplIiApOwoJfSwKCglfdW5maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoKCV9maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoJCglfYmluZFVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCQoJCXNlbGYuZWxlbWVudC5vbiggInVwZGF0ZWxheW91dCIsIGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQlzZWxmLl9wb3NpdGlvblBhbmVsKCk7CgkJCX0KCQl9KTsKCX0sCgoJX2JpbmRMaW5rTGlzdGVuZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuX3BhZ2Uub24oICJjbGljay5wYW5lbCIgLCAiYSIsIGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoIHRoaXMuaHJlZi5zcGxpdCggIiMiIClbIDEgXSA9PT0gc2VsZi5fcGFuZWxJRCAmJiBzZWxmLl9wYW5lbElEICE9PSB1bmRlZmluZWQgKSB7CgkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQl2YXIgJGxpbmsgPSAkKCB0aGlzICk7CgkJCQlpZiAoICEgJGxpbmsuaGFzQ2xhc3MoICJ1aS1saW5rIiApICkgewoJCQkJCSRsaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCXNlbGYuZWxlbWVudC5vbmUoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkkbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQl9KTsKCQkJCX0KCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9KTsKCX0sCgkKCV9iaW5kU3dpcGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJlYSA9IHNlbGYuX21vZGFsID8gc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fbW9kYWwgKSA6IHNlbGYuZWxlbWVudDsKCQkKCQkvLyBvbiBzd2lwZSwgY2xvc2UgdGhlIHBhbmVsCgkJaWYoICEhc2VsZi5vcHRpb25zLnN3aXBlQ2xvc2UgKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnBvc2l0aW9uID09PSAibGVmdCIgKSB7CgkJCQlhcmVhLm9uKCAic3dpcGVsZWZ0LnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlhcmVhLm9uKCAic3dpcGVyaWdodC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9CgkJfQoJfSwKCglfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCQkJCgkJc2VsZi5fcGFnZQoJCQkvLyBDbG9zZSB0aGUgcGFuZWwgaWYgYW5vdGhlciBwYW5lbCBvbiB0aGUgcGFnZSBvcGVucwoJCQkub24oICJwYW5lbGJlZm9yZW9wZW4iLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggc2VsZi5fb3BlbiAmJiBlLnRhcmdldCAhPT0gc2VsZi5lbGVtZW50WyAwIF0gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KQoJCQkvLyBjbGVhbiB1cCBvcGVuIHBhbmVscyBhZnRlciBwYWdlIGhpZGUKCQkJLm9uKCAicGFnZWhpZGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCB0cnVlICk7CgkJCQl9CgkJCX0pCgkJCS8vIG9uIGVzY2FwZSwgY2xvc2U/IG1pZ2h0IG5lZWQgdG8gaGF2ZSBhIHRhcmdldCBjaGVjayB0b28uLi4KCQkJLm9uKCAia2V5dXAucGFuZWwiLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggZS5rZXlDb2RlID09PSAyNyAmJiBzZWxmLl9vcGVuICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSk7Cgl9LAoKCS8vIHN0YXRlIHN0b3JhZ2Ugb2Ygb3BlbiBvciBjbG9zZWQKCV9vcGVuOiBmYWxzZSwKCglfY29udGVudFdyYXBPcGVuQ2xhc3NlczogbnVsbCwKCV9maXhlZFRvb2xiYXJPcGVuQ2xhc3NlczogbnVsbCwKCV9tb2RhbE9wZW5DbGFzc2VzOiBudWxsLAoKCW9wZW46IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCAhdGhpcy5fb3BlbiApIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCV9vcGVuUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9wYWdlLm9mZiggInBhbmVsY2xvc2UiICk7CgkJCQkJc2VsZi5fcGFnZS5qcW1EYXRhKCAicGFuZWwiLCAib3BlbiIgKTsKCQkJCQkKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgkJCQkJCgkJCQkJaWYgKCBzZWxmLm9wdGlvbnMudGhlbWUgJiYgc2VsZi5vcHRpb25zLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZQoJCQkJCQkJLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlVGhlbWUgKQoJCQkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCQkJfQoJCQkJCQoJCQkJCXNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCQkJCQkKCQkJCQlzZWxmLl9wb3NpdGlvblBhbmVsKCk7CgkJCQkJCgkJCQkJLy8gRml4IGZvciBJRTcgbWluLWhlaWdodCBidWcKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aGVtZSAmJiBzZWxmLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLmNzcyggIm1pbi1oZWlnaHQiLCBzZWxmLl9wYWdlLmNzcyggIm1pbi1oZWlnaHQiICkgKTsKCQkJCQl9CgkJCQkJCgkJCQkJc2VsZi5fY29udGVudFdyYXBPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMuY29udGVudFdyYXAgKTsKCQkJCQlzZWxmLl93cmFwcGVyCgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRXcmFwQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBzZWxmLl9jb250ZW50V3JhcE9wZW5DbGFzc2VzICsgIiAiICsgby5jbGFzc2VzLmNvbnRlbnRXcmFwT3BlbiApOwoJCQkJCQkKCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhciApOwoJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcgoJCQkJCQkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBzZWxmLl9maXhlZFRvb2xiYXJPcGVuQ2xhc3NlcyArICIgIiArIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyT3BlbiApOwoJCQkJCQkKCQkJCQlzZWxmLl9tb2RhbE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5tb2RhbCApICsgIiAiICsgby5jbGFzc2VzLm1vZGFsT3BlbjsKCQkJCQlpZiAoIHNlbGYuX21vZGFsICkgewoJCQkJCQlzZWxmLl9tb2RhbC5hZGRDbGFzcyggc2VsZi5fbW9kYWxPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCQkJCX0sCgkJCQljb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vZmYoIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgoJCQkJCXNlbGYuX3BhZ2UuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlUGFuZWxPcGVuICk7CgkJCQkJCgkJCQkJc2VsZi5fYmluZEZpeExpc3RlbmVyKCk7CgkJCQkJCgkJCQkJc2VsZi5fdHJpZ2dlciggIm9wZW4iICk7CgkJCQl9OwoKCQkJaWYgKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlLWFjdGl2ZSIgKS5sZW5ndGggPCAwICkgewoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfQoJCQkKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZW9wZW4iICk7CgkJCQoJCQlpZiAoIHNlbGYuX3BhZ2UuanFtRGF0YSgncGFuZWwnKSA9PT0gIm9wZW4iICkgewoJCQkJc2VsZi5fcGFnZS5vbiggInBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQlfb3BlblBhbmVsKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCV9vcGVuUGFuZWwoKTsKCQkJfQoJCQkKCQkJc2VsZi5fb3BlbiA9IHRydWU7CgkJfQoJfSwKCgljbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQkJc2VsZiA9IHRoaXMsCgkJCQlfY2xvc2VQYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vbiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCQkJCQkKCQkJCQlzZWxmLl9wYWdlLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoJCQkJCXNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoJCQkJCXNlbGYuX3dyYXBwZXIucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50V3JhcE9wZW4gKTsKCQkJCQlzZWxmLl9maXhlZFRvb2xiYXIucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyT3BlbiApOwoJCQkJCQoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsLnJlbW92ZUNsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCBzZWxmLm9wdGlvbnMudGhlbWUgJiYgc2VsZi5vcHRpb25zLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHNlbGYub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCBzZWxmLl9wYWdlVGhlbWUgKTsKCQkJCQkJLy8gcmVzZXQgZml4IGZvciBJRTcgbWluLWhlaWdodCBidWcKCQkJCQkJc2VsZi5fd3JhcHBlci5jc3MoICJtaW4taGVpZ2h0IiwgIiIgKTsKCQkJCQl9CgkJCQkJc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fd3JhcHBlciApLm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQlzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbENsb3NlZCApOwoJCQkJCQoJCQkJCXNlbGYuX3dyYXBwZXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBzZWxmLl9jb250ZW50V3JhcE9wZW5DbGFzc2VzICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMuY29udGVudFdyYXBDbG9zZWQgKTsKCQkJCQkJCgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyCgkJCQkJCS5yZW1vdmVDbGFzcyggc2VsZi5fZml4ZWRUb29sYmFyT3BlbkNsYXNzZXMgKQoJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyQ2xvc2VkICk7CgkJCQkJCQoJCQkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJCQkJc2VsZi5fdW5iaW5kRml4TGlzdGVuZXIoKTsKCQkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCQkJCQkKCQkJCQlzZWxmLl9wYWdlLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQkJCQlzZWxmLl90cmlnZ2VyKCAiY2xvc2UiICk7CgkJCQl9OwoJCQkJCgkJCWlmICggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZS1hY3RpdmUiICkubGVuZ3RoIDwgMCApIHsKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0KCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZWNsb3NlIiApOwoKCQkJX2Nsb3NlUGFuZWwoKTsKCgkJCXNlbGYuX29wZW4gPSBmYWxzZTsKCQl9Cgl9LAoJCgl0b2dnbGU6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXRoaXNbIHRoaXMuX29wZW4gPyAiY2xvc2UiIDogIm9wZW4iIF0oKTsKCX0sCgoJX3RyYW5zaXRpb25FbmRFdmVudHM6ICJ3ZWJraXRUcmFuc2l0aW9uRW5kIG9UcmFuc2l0aW9uRW5kIG90cmFuc2l0aW9uZW5kIHRyYW5zaXRpb25lbmQgbXNUcmFuc2l0aW9uRW5kIiwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGNsYXNzZXMgPSB0aGlzLm9wdGlvbnMuY2xhc3NlcywKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCWhhc090aGVyU2libGluZ1BhbmVscyA9IHRoaXMuZWxlbWVudC5zaWJsaW5ncyggIi4iICsgY2xhc3Nlcy5wYW5lbCApLmxlbmd0aDsKCgkJLy8gY3JlYXRlCgkJaWYgKCAhaGFzT3RoZXJTaWJsaW5nUGFuZWxzICkgewoJCQl0aGlzLl93cmFwcGVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgkJCXRoaXMuX3BhZ2UuZmluZCggImEiICkudW5iaW5kKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiICk7CgkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoIGNsYXNzZXMucGFnZVBhbmVsICk7CgkJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJCXRoaXMuX3BhZ2UuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggY2xhc3Nlcy5wYWdlUGFuZWxPcGVuICk7CgkJCQlpZiAoIHRoZW1lICkgewoJCQkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyB0aGVtZSApLmFkZENsYXNzKCB0aGlzLl9wYWdlVGhlbWUgKTsKCQkJCX0KCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCgpOwoJCQl9CgkJfSBlbHNlIGlmICggdGhpcy5fb3BlbiApIHsKCQkJdGhpcy5fd3JhcHBlci5yZW1vdmVDbGFzcyggY2xhc3Nlcy5jb250ZW50V3JhcE9wZW4gKTsKCQkJdGhpcy5fZml4ZWRUb29sYmFyLnJlbW92ZUNsYXNzKCBjbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJPcGVuICk7CgkJCXRoaXMuX3BhZ2UuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCBjbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJaWYgKCB0aGVtZSApIHsKCQkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyB0aGVtZSApLmFkZENsYXNzKCB0aGlzLl9wYWdlVGhlbWUgKTsKCQkJfQoJCX0KCQkKCQl0aGlzLl9wYW5lbElubmVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggWyB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSwgY2xhc3Nlcy5wYW5lbEFuaW1hdGUgXS5qb2luKCAiICIgKSApCgkJCS5vZmYoICJzd2lwZWxlZnQucGFuZWwgc3dpcGVyaWdodC5wYW5lbCIgKQoJCQkub2ZmKCAicGFuZWxiZWZvcmVvcGVuIiApCgkJCS5vZmYoICJwYW5lbGhpZGUiICkKCQkJLm9mZiggImtleXVwLnBhbmVsIiApCgkJCS5vZmYoICJ1cGRhdGVsYXlvdXQiICk7CgoJCXRoaXMuX2Nsb3NlTGluay5vZmYoICJjbGljay5wYW5lbCIgKTsKCgkJaWYgKCB0aGlzLl9tb2RhbCApIHsKCQkJdGhpcy5fbW9kYWwucmVtb3ZlKCk7CgkJfQoKCQkvLyBvcGVuIGFuZCBjbG9zZQoJCXRoaXMuZWxlbWVudC5vZmYoIHRoaXMuX3RyYW5zaXRpb25FbmRFdmVudHMgKQoJCQkucmVtb3ZlQ2xhc3MoIFsgY2xhc3Nlcy5wYW5lbFVuZml4ZWQsIGNsYXNzZXMucGFuZWxDbG9zZWQsIGNsYXNzZXMucGFuZWxPcGVuIF0uam9pbiggIiAiICkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnBhbmVsLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCgkJb3B0aW9uczogewoJCQljbGFzc2VzOiB7CgkJCQl0YWJsZTogInVpLXRhYmxlIgoJCQl9LAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSd0YWJsZScpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCXNlbGYucmVmcmVzaCggdHJ1ZSApOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uIChjcmVhdGUpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJdHJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0aGVhZCB0ciIgKTsKCgkJCWlmICggY3JlYXRlICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy50YWJsZSApOwoJCQl9CgoJCQkvLyBFeHBvc2UgaGVhZGVycyBhbmQgYWxsSGVhZGVycyBwcm9wZXJ0aWVzIG9uIHRoZSB3aWRnZXQKCQkJLy8gaGVhZGVycyByZWZlcmVuY2VzIHRoZSBUSHMgd2l0aGluIHRoZSBmaXJzdCBUUiBpbiB0aGUgdGFibGUKCQkJc2VsZi5oZWFkZXJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0cjplcSgwKSIgKS5jaGlsZHJlbigpOwoKCQkJLy8gYWxsSGVhZGVycyByZWZlcmVuY2VzIGhlYWRlcnMsIHBsdXMgYWxsIFRIcyBpbiB0aGUgdGhlYWQsIHdoaWNoIG1heSBpbmNsdWRlIHNldmVyYWwgcm93cywgb3Igbm90CgkJCXNlbGYuYWxsSGVhZGVycyA9IHNlbGYuaGVhZGVycy5hZGQoIHRycy5jaGlsZHJlbigpICk7CgoJCQl0cnMuZWFjaChmdW5jdGlvbigpewoKCQkJCXZhciBjb2x0YWxseSA9IDA7CgoJCQkJJCggdGhpcyApLmNoaWxkcmVuKCkuZWFjaChmdW5jdGlvbiggaSApewoKCQkJCQl2YXIgc3BhbiA9IHBhcnNlSW50KCAkKCB0aGlzICkuYXR0ciggImNvbHNwYW4iICksIDEwICksCgkJCQkJCXNlbCA9ICI6bnRoLWNoaWxkKCIgKyAoIGNvbHRhbGx5ICsgMSApICsgIikiOwoJCQkJCSQoIHRoaXMgKQoJCQkJCQkuanFtRGF0YSggImNvbHN0YXJ0IiwgY29sdGFsbHkgKyAxICk7CgoJCQkJCWlmKCBzcGFuICl7CgkJCQkJCWZvciggdmFyIGogPSAwOyBqIDwgc3BhbiAtIDE7IGorKyApewoJCQkJCQkJY29sdGFsbHkrKzsKCQkJCQkJCXNlbCArPSAiLCA6bnRoLWNoaWxkKCIgKyAoIGNvbHRhbGx5ICsgMSApICsgIikiOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIGNyZWF0ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkkKHRoaXMpLmpxbURhdGEoImNlbGxzIiwgIiIpOwoJCQkJCX0KCQkJCQkvLyBTdG9yZSAiY2VsbHMiIGRhdGEgb24gaGVhZGVyIGFzIGEgcmVmZXJlbmNlIHRvIGFsbCBjZWxscyBpbiB0aGUgc2FtZSBjb2x1bW4gYXMgdGhpcyBUSAoJCQkJCSQoIHRoaXMgKQoJCQkJCQkuanFtRGF0YSggImNlbGxzIiwgc2VsZi5lbGVtZW50LmZpbmQoICJ0ciIgKS5ub3QoIHRycy5lcSgwKSApLm5vdCggdGhpcyApLmNoaWxkcmVuKCBzZWwgKSApOwoKCQkJCQljb2x0YWxseSsrOwoKCQkJCX0pOwoKCQkJfSk7CgoJCQkvLyB1cGRhdGUgdGFibGUgbW9kZXMKCQkJaWYgKCBjcmVhdGUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAncmVmcmVzaCcgKTsKCQkJfQoJfQoKfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5tb2RlID0gImNvbHVtbnRvZ2dsZSI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jb2x1bW5CdG5UaGVtZSA9IG51bGw7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jb2x1bW5Qb3B1cFRoZW1lID0gbnVsbDsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNvbHVtbkJ0blRleHQgPSAiQ29sdW1ucy4uLiI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzID0gJC5leHRlbmQoCgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLAoJewoJCXBvcHVwOiAidWktdGFibGUtY29sdW1udG9nZ2xlLXBvcHVwIiwKCQljb2x1bW5CdG46ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtYnRuIiwKCQlwcmlvcml0eVByZWZpeDogInVpLXRhYmxlLXByaW9yaXR5LSIsCgkJY29sdW1uVG9nZ2xlVGFibGU6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUiCgl9Cik7CgokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J3RhYmxlJykiLCAidGFibGVjcmVhdGUgcmVmcmVzaCIsIGZ1bmN0aW9uKCBlICkgewoJCgl2YXIgJHRhYmxlID0gJCggdGhpcyApLAoJCXNlbGYgPSAkdGFibGUuZGF0YSggIm1vYmlsZS10YWJsZSIgKSwKCQlldmVudCA9IGUudHlwZSwKCQlvID0gc2VsZi5vcHRpb25zLAoJCW5zID0gJC5tb2JpbGUubnMsCgkJaWQgPSAoICR0YWJsZS5hdHRyKCAiaWQiICkgfHwgby5jbGFzc2VzLnBvcHVwICkgKyAiLXBvcHVwIiwgLyogVE9ETyBCRVRURVIgRkFMTEJBQ0sgSUQgSEVSRSAqLwoJCSRtZW51QnV0dG9uLAoJCSRwb3B1cCwKCQkkbWVudSwKCQkkc3dpdGNoYm9hcmQ7CgoJaWYgKCBvLm1vZGUgIT09ICJjb2x1bW50b2dnbGUiICkgewoJCXJldHVybjsKCX0KCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMuY29sdW1uVG9nZ2xlVGFibGUgKTsKCQoJCSRtZW51QnV0dG9uID0gJCggIjxhIGhyZWY9JyMiICsgaWQgKyAiJyBjbGFzcz0nIiArIG8uY2xhc3Nlcy5jb2x1bW5CdG4gKyAiJyBkYXRhLSIgKyBucyArICJyZWw9J3BvcHVwJyBkYXRhLSIgKyBucyArICJtaW5pPSd0cnVlJz4iICsgby5jb2x1bW5CdG5UZXh0ICsgIjwvYT4iICksCgkJJHBvcHVwID0gJCggIjxkaXYgZGF0YS0iICsgbnMgKyAicm9sZT0ncG9wdXAnIGRhdGEtIiArIG5zICsgInJvbGU9J2ZpZWxkY29udGFpbicgY2xhc3M9JyIgKyBvLmNsYXNzZXMucG9wdXAgKyAiJyBpZD0nIiArIGlkICsgIic+PC9kaXY+IiksCgkJJG1lbnUgPSAkKCI8ZmllbGRzZXQgZGF0YS0iICsgbnMgKyAicm9sZT0nY29udHJvbGdyb3VwJz48L2ZpZWxkc2V0PiIpOwoJfQoJCgkvLyBjcmVhdGUgdGhlIGhpZGUvc2hvdyB0b2dnbGVzCglzZWxmLmhlYWRlcnMubm90KCAidGQiICkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJdmFyIHByaW9yaXR5ID0gJCggdGhpcyApLmpxbURhdGEoICJwcmlvcml0eSIgKSwKCQkJJGNlbGxzID0gJCggdGhpcyApLmFkZCggJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSApOwoKCQlpZiAoIHByaW9yaXR5ICkgewoKCQkJJGNlbGxzLmFkZENsYXNzKCBvLmNsYXNzZXMucHJpb3JpdHlQcmVmaXggKyBwcmlvcml0eSApOwoKCQkJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCQkJJCgiPGxhYmVsPjxpbnB1dCB0eXBlPSdjaGVja2JveCcgY2hlY2tlZCAvPiIgKyAkKCB0aGlzICkudGV4dCgpICsgIjwvbGFiZWw+IiApCgkJCQkJLmFwcGVuZFRvKCAkbWVudSApCgkJCQkJLmNoaWxkcmVuKCAwICkKCQkJCQkuanFtRGF0YSggImNlbGxzIiwgJGNlbGxzICkKCQkJCQkuY2hlY2tib3hyYWRpbyh7CgkJCQkJCXRoZW1lOiBvLmNvbHVtblBvcHVwVGhlbWUKCQkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCSQoICcjJyArIGlkICsgJyBmaWVsZHNldCBkaXY6ZXEoJyArIGkgKycpJykuZmluZCgnaW5wdXQnKS5qcW1EYXRhKCAnY2VsbHMnLCAkY2VsbHMgKTsKCQkJfQoJCX0KCX0pOwoJCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJJG1lbnUuYXBwZW5kVG8oICRwb3B1cCApOwoJfQoKCS8vIGJpbmQgY2hhbmdlIGV2ZW50IGxpc3RlbmVycyB0byBpbnB1dHMgLSBUT0RPOiBtb3ZlIHRvIGEgcHJpdmF0ZSBtZXRob2Q/CglpZiAoICRtZW51ID09PSB1bmRlZmluZWQgKSB7CgkJJHN3aXRjaGJvYXJkID0gJCgnIycgKyBpZCArICcgZmllbGRzZXQnKTsKCX0gZWxzZSB7CgkJJHN3aXRjaGJvYXJkID0gJG1lbnU7Cgl9CgoJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCSRzd2l0Y2hib2FyZC5vbiggImNoYW5nZSIsICJpbnB1dCIsIGZ1bmN0aW9uKCBlICl7CgkJCWlmKCB0aGlzLmNoZWNrZWQgKXsKCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiIgKS5hZGRDbGFzcyggInVpLXRhYmxlLWNlbGwtdmlzaWJsZSIgKTsKCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLXZpc2libGUiICkuYWRkQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiIgKTsKCQkJfQoJCX0pOwoKCQkkbWVudUJ1dHRvbgoJCQkuaW5zZXJ0QmVmb3JlKCAkdGFibGUgKQoJCQkuYnV0dG9uTWFya3VwKHsKCQkJCXRoZW1lOiBvLmNvbHVtbkJ0blRoZW1lCgkJCX0pOwoKCQkkcG9wdXAKCQkJLmluc2VydEJlZm9yZSggJHRhYmxlICkKCQkJLnBvcHVwKCk7Cgl9CgoJLy8gcmVmcmVzaCBtZXRob2QKCXNlbGYudXBkYXRlID0gZnVuY3Rpb24oKXsKCQkkc3dpdGNoYm9hcmQuZmluZCggImlucHV0IiApLmVhY2goIGZ1bmN0aW9uKCl7CgkJCWlmICh0aGlzLmNoZWNrZWQpIHsKCQkJCXRoaXMuY2hlY2tlZCA9ICQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkuZXEoMCkuY3NzKCAiZGlzcGxheSIgKSA9PT0gInRhYmxlLWNlbGwiOwoJCQkJaWYgKGV2ZW50ID09PSAicmVmcmVzaCIpIHsKCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLmFkZENsYXNzKCd1aS10YWJsZS1jZWxsLXZpc2libGUnKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkuYWRkQ2xhc3MoJ3VpLXRhYmxlLWNlbGwtaGlkZGVuJyk7CgkJCX0KCQkJJCggdGhpcyApLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJCX0pOwoJfTsKCgkkLm1vYmlsZS53aW5kb3cub24oICJ0aHJvdHRsZWRyZXNpemUiLCBzZWxmLnVwZGF0ZSApOwoKCXNlbGYudXBkYXRlKCk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMubW9kZSA9ICJyZWZsb3ciOwoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcyA9ICQuZXh0ZW5kKAoJJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcywKCXsKCQlyZWZsb3dUYWJsZTogInVpLXRhYmxlLXJlZmxvdyIsCgkJY2VsbExhYmVsczogInVpLXRhYmxlLWNlbGwtbGFiZWwiCgl9Cik7CgokLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J3RhYmxlJykiLCAidGFibGVjcmVhdGUgcmVmcmVzaCIsIGZ1bmN0aW9uKCBlICkgewoKCXZhciAkdGFibGUgPSAkKCB0aGlzICksCgkJZXZlbnQgPSBlLnR5cGUsCgkJc2VsZiA9ICR0YWJsZS5kYXRhKCAibW9iaWxlLXRhYmxlIiApLAoJCW8gPSBzZWxmLm9wdGlvbnM7CgoJLy8gSWYgaXQncyBub3QgcmVmbG93IG1vZGUsIHJldHVybiBoZXJlLgoJaWYoIG8ubW9kZSAhPT0gInJlZmxvdyIgKXsKCQlyZXR1cm47Cgl9CgoJaWYgKCBldmVudCAhPT0gInJlZnJlc2giICkgewoJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLnJlZmxvd1RhYmxlICk7Cgl9CgoJLy8gZ2V0IGhlYWRlcnMgaW4gcmV2ZXJzZSBvcmRlciBzbyB0aGF0IHRvcC1sZXZlbCBoZWFkZXJzIGFyZSBhcHBlbmRlZCBsYXN0Cgl2YXIgcmV2ZXJzZUhlYWRlcnMgPSAgJCggc2VsZi5hbGxIZWFkZXJzLmdldCgpLnJldmVyc2UoKSApOwoKCS8vIGNyZWF0ZSB0aGUgaGlkZS9zaG93IHRvZ2dsZXMKCXJldmVyc2VIZWFkZXJzLmVhY2goZnVuY3Rpb24oIGkgKXsKCQl2YXIgJGNlbGxzID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSwKCQkJY29sc3RhcnQgPSAkKCB0aGlzICkuanFtRGF0YSggImNvbHN0YXJ0IiApLAoJCQloaWVyYXJjaHlDbGFzcyA9ICRjZWxscy5ub3QoIHRoaXMgKS5maWx0ZXIoICJ0aGVhZCB0aCIgKS5sZW5ndGggJiYgIiB1aS10YWJsZS1jZWxsLWxhYmVsLXRvcCIsCgkJCXRleHQgPSAkKHRoaXMpLnRleHQoKTsKCgkJCWlmKCB0ZXh0ICE9PSAiIiAgKXsKCgkJCQlpZiggaGllcmFyY2h5Q2xhc3MgKXsKCQkJCQl2YXIgaXRlcmF0aW9uID0gcGFyc2VJbnQoICQoIHRoaXMgKS5hdHRyKCAiY29sc3BhbiIgKSwgMTAgKSwKCQkJCQkJZmlsdGVyID0gIiI7CgoJCQkJCWlmKCBpdGVyYXRpb24gKXsKCQkJCQkJZmlsdGVyID0gInRkOm50aC1jaGlsZCgiKyBpdGVyYXRpb24gKyJuICsgIiArICggY29sc3RhcnQgKSArIikiOwoJCQkJCX0KCQkJCQkkY2VsbHMuZmlsdGVyKCBmaWx0ZXIgKS5wcmVwZW5kKCAiPGIgY2xhc3M9JyIgKyBvLmNsYXNzZXMuY2VsbExhYmVscyArIGhpZXJhcmNoeUNsYXNzICsgIic+IiArIHRleHQgKyAiPC9iPiIgICk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQkkY2VsbHMucHJlcGVuZCggIjxiIGNsYXNzPSciICsgby5jbGFzc2VzLmNlbGxMYWJlbHMgKyAiJz4iICsgdGV4dCArICI8L2I+IiAgKTsKCQkJCX0KCgkJCX0KCX0pOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCgkkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgPSB0cnVlOwoKCS8vIFRoaXMgZml4IGFkZHJlc3NlcyBhbiBpT1MgYnVnLCBzbyByZXR1cm4gZWFybHkgaWYgdGhlIFVBIGNsYWltcyBpdCdzIHNvbWV0aGluZyBlbHNlLgoJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCWlmKCAhKCAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgL09TIFsxLTVdX1swLTlfXSogbGlrZSBNYWMgT1MgWC9pLnRlc3QoIHVhICkgJiYgdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgKSApewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl2YXIgem9vbSA9ICQubW9iaWxlLnpvb20sCgkJZXZ0LCB4LCB5LCB6LCBhaWc7CgoJZnVuY3Rpb24gY2hlY2tUaWx0KCBlICkgewoJCWV2dCA9IGUub3JpZ2luYWxFdmVudDsKCQlhaWcgPSBldnQuYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eTsKCgkJeCA9IE1hdGguYWJzKCBhaWcueCApOwoJCXkgPSBNYXRoLmFicyggYWlnLnkgKTsKCQl6ID0gTWF0aC5hYnMoIGFpZy56ICk7CgoJCS8vIElmIHBvcnRyYWl0IG9yaWVudGF0aW9uIGFuZCBpbiBvbmUgb2YgdGhlIGRhbmdlciB6b25lcwoJCWlmICggIXdpbmRvdy5vcmllbnRhdGlvbiAmJiAoIHggPiA3IHx8ICggKCB6ID4gNiAmJiB5IDwgOCB8fCB6IDwgOCAmJiB5ID4gNiApICYmIHggPiA1ICkgKSApIHsKCQkJCWlmICggem9vbS5lbmFibGVkICkgewoJCQkJCXpvb20uZGlzYWJsZSgpOwoJCQkJfQoJCX0JZWxzZSBpZiAoICF6b29tLmVuYWJsZWQgKSB7CgkJCQl6b29tLmVuYWJsZSgpOwoJCX0KCX0KCgkkLm1vYmlsZS5kb2N1bWVudC5vbiggIm1vYmlsZWluaXQiLCBmdW5jdGlvbigpewoJCWlmKCAkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgKXsKCQkJJC5tb2JpbGUud2luZG93CgkJCQkuYmluZCggIm9yaWVudGF0aW9uY2hhbmdlLmlvc29yaWVudGF0aW9uZml4Iiwgem9vbS5lbmFibGUgKQoJCQkJLmJpbmQoICJkZXZpY2Vtb3Rpb24uaW9zb3JpZW50YXRpb25maXgiLCBjaGVja1RpbHQgKTsKCQl9Cgl9KTsKCn0oIGpRdWVyeSwgdGhpcyApKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIJJGh0bWwgPSAkKCAiaHRtbCIgKSwKCQkJJGhlYWQgPSAkKCAiaGVhZCIgKSwKCQkJJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKSB7CgkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoJfQoKCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gQWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gVGhpcyBpcyBhIGZhbGxiYWNrLiBJZiBhbnl0aGluZyBnb2VzIHdyb25nIChKUyBlcnJvcnMsIGV0YyksIG9yIGV2ZW50cyBkb24ndCBmaXJlLAoJLy8gdGhpcyBlbnN1cmVzIHRoZSByZW5kZXJpbmcgY2xhc3MgaXMgcmVtb3ZlZCBhZnRlciA1IHNlY29uZHMsIHNvIGNvbnRlbnQgaXMgdmlzaWJsZSBhbmQgYWNjZXNzaWJsZQoJc2V0VGltZW91dCggaGlkZVJlbmRlcmluZ0NsYXNzLCA1MDAwICk7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJCQkkcGFnZXMgPSAkKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKSwKCQkJCWhhc2ggPSBwYXRoLnN0cmlwSGFzaCggcGF0aC5zdHJpcFF1ZXJ5UGFyYW1zKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICksCgkJCQloYXNoUGFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBoYXNoICk7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzLmpxbURhdGEoICJ1cmwiICkgKSB7CgkJCQkJJHRoaXMuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsICR0aGlzLmF0dHIoICJpZCIgKSB8fCBsb2NhdGlvbi5wYXRobmFtZSArIGxvY2F0aW9uLnNlYXJjaCApOwoJCQkJfQoJCQl9KTsKCgkJCS8vIGRlZmluZSBmaXJzdCBwYWdlIGluIGRvbSBjYXNlIG9uZSBiYWNrcyBvdXQgdG8gdGhlIGRpcmVjdG9yeSByb290IChub3QgYWx3YXlzIHRoZSBmaXJzdCBwYWdlIHZpc2l0ZWQsIGJ1dCBkZWZpbmVkIGFzIGZhbGxiYWNrKQoJCQkkLm1vYmlsZS5maXJzdFBhZ2UgPSAkcGFnZXMuZmlyc3QoKTsKCgkJCS8vIGRlZmluZSBwYWdlIGNvbnRhaW5lcgoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyID0gJC5tb2JpbGUuZmlyc3RQYWdlLnBhcmVudCgpLmFkZENsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0IiApOwoKCQkJLy8gYWxlcnQgbGlzdGVuZXJzIHRoYXQgdGhlIHBhZ2Vjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCBmb3IgYmluZGluZwoJCQkvLyB0byBldmVudHMgdHJpZ2dlcmVkIG9uIGl0CgkJCSR3aW5kb3cudHJpZ2dlciggInBhZ2Vjb250YWluZXJjcmVhdGUiICk7CgoJCQkvLyBjdWUgcGFnZSBsb2FkaW5nIG1lc3NhZ2UKCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgoJCQkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCgkJCWhpZGVSZW5kZXJpbmdDbGFzcygpOwoKCQkJLy8gaWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQsIHRoZXJlJ3Mgbm8gaGFzaCBkZWVwbGluaywKCQkJLy8gdGhlIGhhc2ggaXMgbm90IHZhbGlkIChjb250YWlucyBtb3JlIHRoYW4gb25lICMgb3IgZG9lcyBub3Qgc3RhcnQgd2l0aCAjKQoJCQkvLyBvciB0aGVyZSBpcyBubyBwYWdlIHdpdGggdGhhdCBoYXNoLCBjaGFuZ2UgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIERPTQoJCQkvLyBSZW1lbWJlciwgaG93ZXZlciwgdGhhdCB0aGUgaGFzaCBjYW4gYWxzbyBiZSBhIHBhdGghCgkJCWlmICggISAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSggJCggaGFzaFBhZ2UgKS5pcyggJzpqcW1EYXRhKHJvbGU9InBhZ2UiKScgKSB8fAoJCQkJCSQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICkgfHwKCQkJCQloYXNoID09PSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgKSApIHsKCgkJCQkvLyBTdG9yZSB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbgoJCQkJaWYgKCAkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgKSB7CgkJCQkJJC5tb2JpbGUudXJsSGlzdG9yeS5pbml0aWFsRHN0ID0gaGFzaC5yZXBsYWNlKCAiIyIsICIiICk7CgkJCQl9CgoJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCBpbml0aWFsIHBvcHN0YXRlIHN0YXRlIGlmIGl0IGV4aXN0cwoJCQkJLy8gc28gdGhhdCBuYXZpZ2F0aW9uIGJhY2sgdG8gdGhlIGluaXRpYWwgcGFnZSB3b3JrcyBwcm9wZXJseQoJCQkJaWYoICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3Iuc3F1YXNoKCBwYXRoLnBhcnNlTG9jYXRpb24oKS5ocmVmICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7CgkJCQkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCQkJCXJldmVyc2U6IHRydWUsCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJLy8gdHJpZ2dlciBoYXNoY2hhbmdlIG9yIG5hdmlnYXRlIHRvIHNxdWFzaCBhbmQgcmVjb3JkIHRoZSBjb3JyZWN0CgkJCQkvLyBoaXN0b3J5IGVudHJ5IGZvciBhbiBpbml0aWFsIGhhc2ggcGF0aAoJCQkJaWYoICEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQkJJHdpbmRvdy50cmlnZ2VyKCAiaGFzaGNoYW5nZSIsIFt0cnVlXSApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBUT0RPIGZpZ3VyZSBvdXQgaG93IHRvIHNpbXBsaWZ5IHRoaXMgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5pdGlhbCBoaXN0b3J5IGVudHJ5CgkJCQkJLy8gYXQgdGhlIGJvdHRvbSBqcy9uYXZpZ2F0ZS9uYXZpZ2F0ZS5qcwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnkuc3RhY2sgPSBbXTsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZSggJC5tb2JpbGUucGF0aC5pc1BhdGgoIGxvY2F0aW9uLmhhc2ggKSA/IGxvY2F0aW9uLmhhc2ggOiBsb2NhdGlvbi5ocmVmICk7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCgkvLyBpbml0aWFsaXplIGV2ZW50cyBub3csIGFmdGVyIG1vYmlsZWluaXQgaGFzIG9jY3VycmVkCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkLnJlc29sdmUoKTsKCgkvLyBjaGVjayB3aGljaCBzY3JvbGxUb3AgdmFsdWUgc2hvdWxkIGJlIHVzZWQgYnkgc2Nyb2xsaW5nIHRvIDEgaW1tZWRpYXRlbHkgYXQgZG9tcmVhZHkKCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkvLyBub3RlIHRoYXQgdGhpcyBpbml0aWFsIHNjcm9sbCB3b24ndCBoaWRlIHRoZSBhZGRyZXNzIGJhci4gSXQncyBqdXN0IGZvciB0aGUgY2hlY2suCgkkKGZ1bmN0aW9uKCkgewoJCXdpbmRvdy5zY3JvbGxUbyggMCwgMSApOwoKCQkvLyBpZiBkZWZhdWx0SG9tZVNjcm9sbCBoYXNuJ3QgYmVlbiBzZXQgeWV0LCBzZWUgaWYgc2Nyb2xsVG9wIGlzIDEKCQkvLyBpdCBzaG91bGQgYmUgMSBpbiBtb3N0IGJyb3dzZXJzLCBidXQgYW5kcm9pZCB0cmVhdHMgMSBhcyAwIChmb3IgaGlkaW5nIGFkZHIgYmFyKQoJCS8vIHNvIGlmIGl0J3MgMSwgdXNlIDAgZnJvbSBub3cgb24KCQkkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA9ICggISQuc3VwcG9ydC5zY3JvbGxUb3AgfHwgJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpID09PSAxICkgPyAwIDogMTsKCgkJLy9kb20tcmVhZHkgaW5pdHMKCQlpZiAoICQubW9iaWxlLmF1dG9Jbml0aWFsaXplUGFnZSApIHsKCQkJJC5tb2JpbGUuaW5pdGlhbGl6ZVBhZ2UoKTsKCQl9CgoJCS8vIHdpbmRvdyBsb2FkIGV2ZW50CgkJLy8gaGlkZSBpT1MgYnJvd3NlciBjaHJvbWUgb24gbG9hZAoJCSR3aW5kb3cubG9hZCggJC5tb2JpbGUuc2lsZW50U2Nyb2xsICk7CgoJCWlmICggISQuc3VwcG9ydC5jc3NQb2ludGVyRXZlbnRzICkgewoJCQkvLyBJRSBhbmQgT3BlcmEgZG9uJ3Qgc3VwcG9ydCBDU1MgcG9pbnRlci1ldmVudHM6IG5vbmUgdGhhdCB3ZSB1c2UgdG8gZGlzYWJsZSBsaW5rLWJhc2VkIGJ1dHRvbnMKCQkJLy8gYnkgYWRkaW5nIHRoZSAndWktZGlzYWJsZWQnIGNsYXNzIHRvIHRoZW0uIFVzaW5nIGEgSmF2YVNjcmlwdCB3b3JrYXJvdW5kIGZvciB0aG9zZSBicm93c2VyLgoJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NTgKCgkJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiLnVpLWRpc2FibGVkIiwgInZjbGljayIsCgkJCQlmdW5jdGlvbiggZSApIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJKTsKCQl9Cgl9KTsKfSggalF1ZXJ5LCB0aGlzICkpOwoKCn0pKTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 06:49:43 GMT",
                    "Content-Length": "359007",
                    "Date": "Fri, 07 Nov 2014 06:49:43 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}