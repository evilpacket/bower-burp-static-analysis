{
    "url": "http://localhost:9999/CloudKidStudio/CloudKidOS/dist/cloudkid-os-pixi.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Client-side JSON injection (DOM-based)",
    "issueType": 2098032,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based JSON injection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and incorporates this into a string that is parsed as a JSON data structure and then processed by the application. An attacker may be able to use this behavior to construct a URL which, if visited by another application user, will cause arbitrary JSON data to be processed. Depending on the purpose for which this data is used, it may be possible to subvert the application's logic, or cause unintended actions on behalf of the user.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based JSON injection vulnerabilities is not to parse as JSON any string containing data that originated from an untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from modifying the JSON structure in inappropriate ways. This may involve strict validation of specific items to ensure they do not contain any characters that may interfere with the structure of the JSON when it is parsed.",
    "issueDetail": "The application may be vulnerable to DOM-based client-side JSON injection. Data is read from <b>document.cookie</b> and written to <b>JSON.parse()</b> via the following statements:<ul><li>var nameEQ = name + \"=\",     ca = document.cookie.split(';'),     i = 0, c;</li><li>c = ca[i];</li><li>c = c.substring(1,c.length);</li><li>return JSON.parse(unescape(c.substring(nameEQ.length,c.length)));</li></ul>Because the data originates from a cookie, the application's behavior is not trivial to exploit in an attack against another user. Typically, you will need to find a means of setting an arbitrary cookie value in the victim's browser in order to exploit the vulnerability. Applications often contain \"cookie-forcing\" conditions which make this possible, and such a condition in any related domain or subdomain can potentially be used for this purpose. Nonetheless, this limitation somewhat mitigates the impact of the vulnerability. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/CloudKidStudio/CloudKidOS/dist/cloudkid-os-pixi.js",
                "path": "/CloudKidStudio/CloudKidOS/dist/cloudkid-os-pixi.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9DbG91ZEtpZFN0dWRpby9DbG91ZEtpZE9TL2Rpc3QvY2xvdWRraWQtb3MtcGl4aS5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTE3NTI1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDE1OjM5OjM0IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxNTozOTozMCBHTVQNCg0KLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKHVuZGVmaW5lZCl7CgkKCS8qKgoJKiAgRGVzaWduZWQgdG8gbWltaWMgdGhlIGZlYXR1cmUtc2V0IG9mIHRoZSBDbG91ZEtpZE9TIGZvciBBUzMKCSogIFByb3ZpZGVzIGEgc3RhZ2luZyBmcmFtZXdvcmsgZm9yIG90aGVyIHRoaW5ncyB0byBsb2FkCgkqICBoYW5kbGVzIHRoZSBzdGFnZSBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycywgcHJvdmlkZXMgZGVidWcgdG9vbHMsCgkqICBhcyB3ZWxsIGFzIGJyb3dzZXIgY2FjaGUtYnVzdGluZy4KCSoKCSogIEBjbGFzcyBPUwoJKiAgQGV4dGVuZHMgY3JlYXRlanMuQ29udGFpbmVyfFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcgoJKi8KCXZhciBPUyA9IGZ1bmN0aW9uKCl7fSwKCQoJLyoqCgkqIFRoZSBwcm90b3R5cGUgZXh0ZW5kcyB0aGUgZWFzZWxqcycgQ29udGFpbmVyIGNsYXNzCgkqIG9yIHRoZSBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIgY2xhc3MKCSogCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7Y3JlYXRlanMuQ29udGFpbmVyfFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcn0gcAoJKi8KCXAgPSBPUy5wcm90b3R5cGUgPSAoZmFsc2UpID8gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpIDogT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKSwKCQoJLyoqCgkqICBCb29sZWFuIHRvIGtlZXAgdHJhY2sgaWYgd2UncmUgcGF1c2VkCgkqICAKCSogIEBwcm9wZXJ0eSB7Ym9vbH0gX3BhdXNlZAoJKiAgQHByaXZhdGUKCSovCglfcGF1c2VkID0gZmFsc2UsCgkKCS8qKgoJKiAgV2hlbiB0aGUgT1MgaXMgcmVhZHkgdG8gdXNlCgkqIAoJKiAgQHByb3BlcnR5IHtib29sfSBfaXNSZWFkeQoJKiAgQHByaXZhdGUKCSovCglfaXNSZWFkeSA9IGZhbHNlLAoJCgkvKioKCSogIFRoZSBmcmFtZSByYXRlIG9iamVjdAoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7Y3JlYXRlanMuVGV4dHxQSVhJLlRleHR9IF9mcmFtZXJhdGUKCSovCglfZnJhbWVyYXRlID0gbnVsbCwKCQoJLyoqCgkqICBUaGUgbnVtYmVyIG9mIG1zIHNpbmNlIHRoZSBsYXN0IGZyYW1lIHVwZGF0ZQoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7aW50fSBfbGFzdEZyYW1lVGltZQoJKi8KCV9sYXN0RnJhbWVUaW1lID0gMCwKCQoJLyoqCgkqICBUaGUgbGFzdCB0aW1lIHNpbmNlIHRoZSBsYXN0IGZwcyB1cGRhdGUKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2ludH0gX2xhc3RGUFNVcGRhdGVUaW1lCgkqLwoJX2xhc3RGUFNVcGRhdGVUaW1lID0gMCwKCQoJLyoqCgkqICBUaGUgY2FsY3VsYXRlZCBfZnJhbWVyYXRlCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IF9mcmFtZXJhdGVWYWx1ZQoJKi8KCV9mcmFtZXJhdGVWYWx1ZSA9IG51bGwsCgkKCS8qKgoJKiAgVGhlIG51bWJlciBvZiBmcmFtZXMgc2luY2UgdGhlIGxhc3QgZnBzIHVwZGF0ZQoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7aW50fSBfZnJhbWVDb3VudAoJKi8KCV9mcmFtZUNvdW50ID0gMCwKCQoJLyoqCgkqCVRoZSBib3VuZCBjYWxsYmFjayBmb3IgbGlzdGVuaW5nIHRvIHRpY2sgZXZlbnRzCgkqCUBwcml2YXRlCgkqICAgQHByb3BlcnR5IHtGdW5jdGlvbn0gX3RpY2tDYWxsYmFjawoJKi8KCV90aWNrQ2FsbGJhY2sgPSBudWxsLAoJCgkvKioKCSogUmVmZXJlbmNlIHRvIHRoZSBwcml2YXRlIGluc3RhbmNlIG9iamVjdAoJKiAKCSogQHByb3BlcnR5IHtPU30gX2luc3RhbmNlCgkqIEBzdGF0aWMKCSogQHByb3RlY3RlZAoJKi8KCV9pbnN0YW5jZSA9IG51bGwsCgkKCS8qKgoJKiBUaGUgaWQgb2YgdGhlIGFjdGl2ZSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgb3Igc2V0VGltZW91dCBjYWxsLgoJKgoJKiBAcHJvcGVydHkge051bWJlcn0gX3RpY2tJZAoJKiBAcHJpdmF0ZQoJKi8KCV90aWNrSWQgPSAtMSwKCQoJLyoqCgkqIElmIHJlcXVlc3Rpb25BbmltYXRpb25GcmFtZSBzaG91bGQgYmUgdXNlZAoJKgoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Jvb2x9IF91c2VSQUYKCSogQGRlZmF1bHQgZmFsc2UKCSovCglfdXNlUkFGID0gZmFsc2UsCgkKCS8qKiAKCSogVGhlIGN1cnJlbnQgaW50ZXJuYWwgZnJhbWVzIHBlciBzZWNvbmQKCSoKCSogQHByb3BlcnR5IHtOdW1iZXJ9IF9mcHMKCSogQHByaXZhdGUKCSovCglfZnBzID0gMCwKCQoJLyoqCgkqIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHBlciBmcmFtZQoJKgoJKiBAcHJvcGVydHkge2ludH0gX21zUGVyRnJhbWUKCSogQHByaXZhdGUKCSovCglfbXNQZXJGcmFtZSA9IDA7CgkKCS8qKiAKCSogVGhlIHZlcnNpb24gbnVtYmVyIAoJKiBAcHVibGljCgkqIEBzdGF0aWMKCSogQHByb3BlcnR5IHtTdHJpbmd9IFZFUlNJT04KCSovCglPUy5WRVJTSU9OID0gIiR7dmVyc2lvbn0iOwkKCQoJLyoqCgkqIFJlZmVyZW5jZSB0byB0aGUgQ29udGFpbmVyIGluaXRpYWxpemUoKQoJKiBAcHJvdGVjdGVkCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IENvbnRhaW5lcl9pbml0aWFsaXplCgkqLwoJaWYoZmFsc2UpCgkJcC5Db250YWluZXJfaW5pdGlhbGl6ZSA9IHAuaW5pdGlhbGl6ZTsKCQkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIHN0YWdlIG9iamVjdAoJKiAKCSogQHByb3BlcnR5IHtjcmVhdGVqcy5TdGFnZXxQSVhJLlN0YWdlfSBzdGFnZQoJKiBAcHVibGljCgkqLwoJcC5zdGFnZSA9IG51bGw7CgkKCS8qKgoJKiBbUGl4aSBPbmx5XSBUaGUgcmVuZGVyZXIgdXNlZCB0byBkcmF3IHRoZSBmcmFtZS4KCSogCgkqIEBwcm9wZXJ0eSB7UElYSS5DYW52YXNSZW5kZXJlcnxQSVhJLldlYkdMUmVuZGVyZXJ9IF9yZW5kZXJlciBUaGUgUGl4aUpTIHJlbmRlcmVyLgoJKiBAcHJpdmF0ZQoJKi8KCWlmKHRydWUpCgkJcC5fcmVuZGVyZXIgPSBudWxsOwoJCgkvKioKCSogW1BpeGkgT25seV0gQSBkaXYgdGhhdCBjb250YWlucyB0aGUgY2FudmFzLCBzbyB0aGF0IGdhbWVzIGNhbiBsYXllciBpdCB3aXRoIG90aGVyIGNhbnZhc2VzIGlmIGRlc2lyZWQuCgkqIAoJKiBAcHJvcGVydHkge0RPTUVsZW1lbnR9IGNhbnZhc0NvbnRhaW5lcgoJKiBAcHVibGljCgkqLwoJaWYodHJ1ZSkKCQlwLmNhbnZhc0NvbnRhaW5lciA9IG51bGw7CgkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgYXBwbGljYXRpb24KCSogQHByb3RlY3RlZAoJKiBAcHJvcGVydHkge0FwcGxpY2F0aW9ufSBfYXBwCgkqLwoJcC5fYXBwID0gbnVsbDsKCQoJLyoqCgkqIFRoZSBjb2xsZWN0aW9uIG9mIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzCgkqIEBwdWJsaWMKCSogQHByb3BlcnR5IHtEaWN0aW9uYXJ5fSBvcHRpb25zCgkqLwoJcC5vcHRpb25zID0gbnVsbDsKCQoJLyoqCgkqICBDb2xsZWN0aW9uIG9mIHVwZGF0ZSBmdW5jdGlvbnMKCSogIEBwcm90ZWN0ZWQKCSogIEBwcm9wZXJ0eSB7RGljdGlvbmFyeX0gX3VwZGF0ZUZ1bmN0aW9ucwoJKi8KCXAuX3VwZGF0ZUZ1bmN0aW9ucyA9IHt9OwoJCgkvKioKCSogIFN0YXRpYyBjb25zdHJ1Y3RvciBmb3Igc2V0dGluZyB1cCB0aGUgc3RhZ2UKCSogIAoJKiAgQGV4YW1wbGUKCQl2YXIgb3MgPSBjbG91ZGtpZC5PUy5pbml0KCJzdGFnZSIsIHsKCQkJc2hvd0ZyYW1lcmF0ZTogdHJ1ZSwKCQkJZnBzOiA2MCwKCQkJcGFyc2VRdWVyeVN0cmluZzogdHJ1ZSwKCQkJZGVidWc6IHRydWUKCQl9KTsKCQkKCQlvcy5hZGRBcHAobXlBcHBsaWNhdGlvbik7CgkqICAKCSogIEBtZXRob2QgaW5pdAoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IHN0YWdlTmFtZSBUaGUgc3RhZ2UgbmFtZSBzZWxlY3RvcgoJKiAgQHBhcmFtIHtEaWN0aW9uYXJ5fSBbb3B0aW9uc10gQWRkaXRpb25hbCBvcHRpb25zCgkqICBAcGFyYW0ge2ludH0gW29wdGlvbnMubW91c2VPdmVyUmF0ZT0zMF0gKENyZWF0ZUpTIG9ubHkpIHRoZSBmcmFtZXJhdGUgZm9yIG1vdXNlb3ZlciBlZmZlY3RzLCBoaWdoZXIgaXMgbW9yZSByZXNwb25zaXZlCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLmRlYnVnPWZhbHNlXSBJZiB3ZSBzaG91bGQgZW5hYmxlIHRoZSBEZWJ1ZyBjbGFzcyBmb3IgZG9pbmcgY29uc29sZSBhbmQgcmVtb3RlIGxvZ3MKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5taW5Mb2dMZXZlbD0wXSBUaGUgbWluaW11bSBsb2cgbGV2ZWwgZm9yIHRoZSBEZWJ1ZyBjbGFzcywgZGVmYXVsdCBpcyBzaG93IGFsbCBzdGF0ZW1lbnRzLCB2YWx1ZXMgZnJvbSAwIChhbGwpLTQgKGVycm9ycyBvbmx5KQoJKiAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLmlwPW51bGxdIFRoZSBJUCBhZGRyZXNzIGZvciBkb2luZyByZW1vdGUgZGVidWdnaW5nCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnBhcnNlUXVlcnlTdHJpbmc9ZmFsc2VdIElmIHdlIHNob3VsZCBjb252ZXJ0IHRoZSBxdWVyeSBzdHJpbmcgaW50byBPUyBvcHRpb25zCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnNob3dGcmFtZXJhdGU9ZmFsc2VdIFRvIGRpc3BsYXkgdGhlIGN1cnJlbnQgZnJhbWVyYXRlIGNvdW50ZXIKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuY2xlYXJWaWV3PWZhbHNlXSBBdXRvIGNsZWFyIHRoZSBzdGFnZSByZW5kZXIKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3I9MHgwMDAwMDBdIChQSVhJIG9ubHkpIFRoZSBiYWNrZ3JvdW5kIGNvbG9yIG9mIHRoZSBzdGFnZSBhcyBhIHVpbnQsIGUuZy4gMHhGRkZGRkYgZm9yIHdoaXRlLgoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5wcmVNdWx0QWxwaGE9ZmFsc2VdIChQSVhJIG9ubHkpIElmIHRoZSByZW5kZXJlciBpcyB0byB1c2UgcHJlIG11bHRpcGxpZWQgYWxwaGEgZm9yIGFsbCBpbWFnZXMuIFRoaXMgb25seSBhZmZlY3RzIHRoZSBXZWJHTCByZW5kZXJlci4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMudHJhbnNwYXJlbnQ9ZmFsc2VdIChQSVhJIG9ubHkpIFRoZSBzdGFnZSBpcyB0cmFuc3BhcmVudAoJKiAgQHBhcmFtIHtpbnR9IFtvcHRpb25zLndpZHRoXSAoUElYSSBvbmx5KSBUaGUgd2lkdGggb2YgdGhlIHJlbmRlcmVyLCBkZWZhdWx0IGlzIHRoZSBjYW52YXMgd2lkdGgKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5oZWlnaHRdIChQSVhJIG9ubHkpIFRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlcmVyLCBkZWZhdWx0IGlzIHRoZSBjYW52YXMgaGVpZ2h0CgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuZm9yY2VDb250ZXh0PW51bGxdIChQSVhJIG9ubHkpIFRoZSBzdGFnZSByZW5kZXJlciwgb3B0aW9ucyBhcmUgImNhbnZhczJkIiwgIndlYmdsIiBvciBudWxsLiBPbWl0dGluZyB0aGlzIChvciBudWxsKSB1c2VzIFdlYkdMIGlmIGF2YWlsYWJsZSwgYW5kIENhbnZhczJEIG90aGVyd2lzZS4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucmFmPWZhbHNlXSBVc2UgdGhlIHJlcXVlc3QgYW5pbWF0aW9uIGZyYW1lIGluc3RlYWQgb2YgYSBzZXRJbnRlcnZhbAoJKiAgQHBhcmFtIHtpbnR9IFtvcHRpb25zLmZwcz02MF0gU2V0IHRoZSBmcmFtZXJhdGUgCgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMudmVyc2lvbnNGaWxlXSBUaGUgdGV4dCBmaWVsZCB0byBzdG9yZSBjYWNoZS1idXN0aW5nIHZlcnNpb25zIGZvciBpbmRpdmlkdWFsIGZpbGVzCgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuYmFzZVBhdGhdIFRoZSBiYXNlIHBhdGggdG8gbG9hZCBhbGwgZmlsZXMgZnJvbSAodXNlZnVsIGlmIHVzaW5nIGEgQ0ROKQoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5jYWNoZUJ1c3Q9ZmFsc2VdIElmIGFsbCBmaWxlIHJlcXVlc3RzIHdpdGggdGhlIE1lZGlhTG9hZGVyIHNob3VsZCBiZSBjYWNoZUJ1c3RlZCAoZS5nLiwgImZpbGUubXAzP2NiPTEyMzEyMyIpCgkqLwoJT1MuaW5pdCA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykKCXsKCQlpZiAoIV9pbnN0YW5jZSkKCQl7CgkJCWlmICh0cnVlKQoJCQl7CgkJCQlEZWJ1Zy5sb2coIkNyZWF0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgT1MiKTsKCQkJfQoJCQkKCQkJX2luc3RhbmNlID0gbmV3IE9TKCk7CgkJCV9pbnN0YW5jZS5pbml0aWFsaXplKHN0YWdlTmFtZSwgb3B0aW9ucyk7CgkJfQoJCXJldHVybiBfaW5zdGFuY2U7Cgl9OwoJCgkvKioKCSogIFRoZSBpbnRlcm5hbCBjb25zdHJ1Y3RvciBleHRlbmRzIENvbnRhaW5lciBjb25zdHJ1Y3RvcgoJKiAgQGNvbnN0cnVjdG9yCgkqICBAcHJvdGVjdGVkCgkqICBAbWV0aG9kIGluaXRpYWxpemUKCSogIEBwYXJhbSB7c3RyaW5nfSBzdGFnZU5hbWUgVGhlIHN0cmluZyBuYW1lIG9mIHRoZSBzdGFnZSBpZAoJKiAgQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSBUaGUgb3B0aW9uYWwgb3B0aW9ucyB0byBzZXQsIHNlZSBPUy5pbml0KCkgZm9yIG1vcmUgaW5mb3JtYXRpb24gb24gdGhlIG9wdGlvbnMgdGhhdCBjYW4gYmUgc2V0LgoJKi8KCXAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykKCXsKCQkvLyBDYWxsIHRoZSBzdXBlciBjb25zdHJ1Y3RvcgoJCWlmIChmYWxzZSkgdGhpcy5Db250YWluZXJfaW5pdGlhbGl6ZSgpOwoJCWlmICh0cnVlKSBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCh0aGlzKTsKCQkKCQkvLyBTZXR1cCB0aGUgb3B0aW9ucyBjb250YWluZXIKCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCQoJCS8vIFNlZSBpZiB3ZSBzaG91bGQgcGFyc2UgcXVlcnlzdHJpbmcKCQlpZiAodGhpcy5vcHRpb25zLnBhcnNlUXVlcnlTdHJpbmcgIT09IHVuZGVmaW5lZCkKCQkJdGhpcy5vcHRpb25zID0gcGFyc2VRdWVyeVN0cmluZ1BhcmFtcyh0aGlzLm9wdGlvbnMpOwoJCQoJCS8vIFR1cm4gb24gZGVidWdnaW5nCgkJaWYgKHRoaXMub3B0aW9ucy5kZWJ1ZyAhPT0gdW5kZWZpbmVkKQoJCQlEZWJ1Zy5lbmFibGVkID0gdGhpcy5vcHRpb25zLmRlYnVnID09PSB0cnVlIHx8IHRoaXMub3B0aW9ucy5kZWJ1ZyA9PT0gInRydWUiOwoJCQkKCQlpZiAodGhpcy5vcHRpb25zLm1pbkxvZ0xldmVsICE9PSB1bmRlZmluZWQpCgkJCURlYnVnLm1pbkxvZ0xldmVsID0gcGFyc2VJbnQodGhpcy5vcHRpb25zLm1pbkxvZ0xldmVsLCAxMCk7CgoJCS8vaWYgd2Ugd2VyZSBzdXBwbGllZCB3aXRoIGFuIElQIGFkZHJlc3MsIGNvbm5lY3QgdG8gaXQgd2l0aCB0aGUgRGVidWcgY2xhc3MgZm9yIGxvZ2dpbmcKCQlpZih0eXBlb2YgdGhpcy5vcHRpb25zLmlwID09ICJzdHJpbmciKQoJCQlEZWJ1Zy5jb25uZWN0KHRoaXMub3B0aW9ucy5pcCk7CgkKCQkvLyBTZXR1cCB0aGUgbWVkaWFsb2FkZXIKCQl2YXIgbG9hZGVyID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5pdCgpOwoJCQoJCS8vIFNldHVwIHRoZSBzdGFnZQoJCWlmKGZhbHNlKQoJCXsKCQkJdGhpcy5zdGFnZSA9IG5ldyBjcmVhdGVqcy5TdGFnZShzdGFnZU5hbWUpOwoJCQl0aGlzLnN0YWdlLm5hbWUgPSAiY2xvdWRraWQuT1MiOwoJCQoJCQkvLyBwcmV2ZW50IG1vdXNlIGRvd24gdHVybmluZyBpbnRvIGN1cnNvcgoJCQl0aGlzLnN0YWdlLmNhbnZhcy5vbm1vdXNlZG93biA9IGZ1bmN0aW9uKGUpCgkJCXsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJfTsKCgkJCS8vIEVuYWJsZSB0aGUgbW91c2VvdmVyIGJ5IHNldHRpbmcgdGhlIGZyZXF1ZW5jeQoJCQkvLyBpZiB3ZSBzZXQgbW91c2VPdmVyUmF0ZSA8PSAwLCB0aGVuIHR1cm5zIG9mZiBtb3VzZW92ZXIgZWZmZWN0cwoJCQl2YXIgbW91c2VPdmVyUmF0ZSA9IHRoaXMub3B0aW9ucy5tb3VzZU92ZXJSYXRlID0gdGhpcy5vcHRpb25zLm1vdXNlT3ZlclJhdGUgfHwgMzA7CgkJCXRoaXMuc3RhZ2UuZW5hYmxlTW91c2VPdmVyKG1vdXNlT3ZlclJhdGUpOwoJCX0KCQkKCQlpZih0cnVlKQoJCXsKCQkJdGhpcy5zdGFnZSA9IG5ldyBQSVhJLlN0YWdlKHRoaXMub3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IgfHwgMCwgdHJ1ZSk7CgkJfQoJCXRoaXMuc3RhZ2UuYWRkQ2hpbGQodGhpcyk7CgkJCgkJLy9saXN0ZW4gZm9yIHdoZW4gdGhlIHBhZ2UgdmlzaWJpbGl0eSBjaGFuZ2VzIHNvIHdlIGNhbiBwYXVzZSBvdXIgdGltaW5ncwoJCXRoaXMudmlzaWJsZUxpc3RlbmVyID0gdGhpcy5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkLmJpbmQodGhpcyk7CgkJYWRkUGFnZUhpZGVMaXN0ZW5lcih0aGlzLnZpc2libGVMaXN0ZW5lcik7CgkJCgkJaWYoZmFsc2UpCgkJewoJCQkvLyBTZXR1cCB0aGUgdG91Y2ggZXZlbnRzCgkJCXZhciB0b3VjaERldmljZT0od2luZG93Lmhhc093blByb3BlcnR5KCdvbnRvdWNoc3RhcnQnKSk7CgkJCQoJCQkvL0lFMTAgZG9lc24ndCBzZW5kIG1vdXNlb3ZlciBldmVudHMgcHJvcGVybHkgaWYgdG91Y2ggaXMgZW5hYmxlZAoJCQlpZih3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJNU0lFIDEwLjAiKSAhPSAtMSAmJiAhdG91Y2hEZXZpY2UpCgkJCXsKCQkJCWlmICh0cnVlKSBEZWJ1Zy5sb2coJ0lFMTAgRGVza3RvcCcpOwoJCQl9CgkJCWVsc2UKCQkJCWNyZWF0ZWpzLlRvdWNoLmVuYWJsZSh0aGlzLnN0YWdlKTsKCgkJCS8vIENsZWFyIHRoZSBzdGFnZQoJCQl0aGlzLnN0YWdlLmF1dG9DbGVhciA9ICEhdGhpcy5vcHRpb25zLmNsZWFyVmlldyB8fCBmYWxzZTsKCQkJCgkJCWlmKHRoaXMub3B0aW9ucy5zaG93RnJhbWVyYXRlKQoJCQl7CgkJCQkvLyBBZGQgdGhlIGZyYW1lIHJhdGUgb2JqZWN0CgkJCQlfZnJhbWVyYXRlID0gbmV3IGNyZWF0ZWpzLlRleHQoJycsICcxMHB4IEFyaWFsJywgJyMwMDAnKTsKCQkJCV9mcmFtZXJhdGUuc3Ryb2tlID0ge3dpZHRoOjIsIGNvbG9yOiIjZmZmZmZmIn07CgkJCQlfZnJhbWVyYXRlLnggPSBfZnJhbWVyYXRlLnkgPSA1OwoJCQkJdGhpcy5hZGRDaGlsZChfZnJhbWVyYXRlKTsKCQkJfQoJCQkKCQkJLy8gSW5pdGlhbCByZW5kZXIKCQkJdGhpcy5zdGFnZS51cGRhdGUoKTsKCQl9CgkJCgkJaWYodHJ1ZSkKCQl7CgkJCXZhciB0cmFuc3BhcmVudCA9ICEhdGhpcy5vcHRpb25zLnRyYW5zcGFyZW50IHx8IGZhbHNlOwoJCQl2YXIgcHJlTXVsdEFscGhhID0gISF0aGlzLm9wdGlvbnMucHJlTXVsdEFscGhhIHx8IGZhbHNlOwoKCQkJdGhpcy5jb250YWluZXJOYW1lID0gKHR5cGVvZiBzdGFnZU5hbWUgPT0gInN0cmluZyIpID8gc3RhZ2VOYW1lIDogc3RhZ2VOYW1lLmF0dHIoImlkIik7CgkJCXZhciBjb250YWluZXIgPSAodHlwZW9mIHN0YWdlTmFtZSA9PSAic3RyaW5nIikgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChzdGFnZU5hbWUpIDogc3RhZ2VOYW1lOwoJCQl2YXIgY2FudmFzQ29udGFpbmVyID0gdGhpcy5jYW52YXNDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCQkJY29udGFpbmVyLmFwcGVuZENoaWxkKGNhbnZhc0NvbnRhaW5lcik7CgkJCWNhbnZhc0NvbnRhaW5lci5pZCA9ICJDS09TIjsKCQkJCgkJCS8vY3JlYXRlIHRoZSByZW5kZXJlcmVyCgkJCXZhciB3aWR0aCA9IHRoaXMub3B0aW9ucy53aWR0aCB8fCBjb250YWluZXIuaW5uZXJXaWR0aDsKCQkJdmFyIGhlaWdodCA9IHRoaXMub3B0aW9ucy5oZWlnaHQgfHwgY29udGFpbmVyLmlubmVySGVpZ2h0OwoJCQlpZih0aGlzLm9wdGlvbnMuZm9yY2VDb250ZXh0ID09ICJjYW52YXMyZCIpCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gbmV3IFBJWEkuQ2FudmFzUmVuZGVyZXIoCgkJCQkJd2lkdGgsIAoJCQkJCWhlaWdodCwgCgkJCQkJbnVsbCwgCgkJCQkJdHJhbnNwYXJlbnQKCQkJCSk7CgkJCX0KCQkJZWxzZSBpZih0aGlzLm9wdGlvbnMuZm9yY2VDb250ZXh0ID09ICJ3ZWJnbCIpCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJlcigKCQkJCQl3aWR0aCwgCgkJCQkJaGVpZ2h0LAoJCQkJCW51bGwsIAoJCQkJCXRyYW5zcGFyZW50LAoJCQkJCXByZU11bHRBbHBoYQoJCQkJKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gUElYSS5hdXRvRGV0ZWN0UmVuZGVyZXIoCgkJCQkJd2lkdGgsIAoJCQkJCWhlaWdodCwKCQkJCQludWxsLCAKCQkJCQl0cmFuc3BhcmVudCwKCQkJCQlwcmVNdWx0QWxwaGEKCQkJCSk7CgkJCX0KCQkJY2FudmFzQ29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuX3JlbmRlcmVyLnZpZXcpOwoJCQljYW52YXNDb250YWluZXIuc2V0QXR0cmlidXRlKCJzdHlsZSIsInBvc2l0aW9uOnJlbGF0aXZlO3dpZHRoOiIgKyB3aWR0aCArICJweDtoZWlnaHQ6IiArIGhlaWdodCArICJweCIpOwoJCQkKCQkJLy9IZXJlIGF0IENsb3VkS2lkLCB3ZSBhbHdheXMgaGF2ZSBhIGJpdG1hcCBiYWNrZ3JvdW5kLCBzbyB3ZSBjYW4gZ2V0IGJldHRlciBwZXJmb3JtYW5jZSBieSBub3QgY2xlYXJpbmcgdGhlIHJlbmRlciBhcmVhIGVhY2ggcmVuZGVyCgkJCXRoaXMuX3JlbmRlcmVyLmNsZWFyVmlldyA9ICEhdGhpcy5vcHRpb25zLmNsZWFyVmlldzsKCgkJCWlmKHRoaXMub3B0aW9ucy5zaG93RnJhbWVyYXRlKQoJCQl7CgkJCQkvLyBBZGQgdGhlIGZyYW1lIHJhdGUgb2JqZWN0CgkJCQlfZnJhbWVyYXRlID0gbmV3IFBJWEkuVGV4dCgnRlBTOiAwLjAwMCcsIHtmb250OicxMHB4IEFyaWFsJywgZmlsbDonYmxhY2snLCBzdHJva2U6J3doaXRlJywgc3Ryb2tlVGhpY2tuZXNzOjJ9KTsKCQkJCV9mcmFtZXJhdGUueCA9IF9mcmFtZXJhdGUueSA9IDU7CgkJCQl0aGlzLmFkZENoaWxkKF9mcmFtZXJhdGUpOwoJCQl9CgkJCQoJCQkvLyBJbml0aWFsIHJlbmRlcgoJCQl0aGlzLl9yZW5kZXJlci5yZW5kZXIodGhpcy5zdGFnZSk7CgkJfQoJCQoJCS8vc2V0IHVwIHRoZSB0aWNrIGNhbGxiYWNrCgkJX3RpY2tDYWxsYmFjayA9IHRoaXMudGljay5iaW5kKHRoaXMpOwoJCQoJCS8vIElmIHdlIHNob3VsZCB1c2UgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIGluIHRoZSBicm93c2VyIGluc3RlYWQgb2Ygc2V0VGltZW91dAoJCV91c2VSQUYgPSB0aGlzLm9wdGlvbnMucmFmIHx8IGZhbHNlOwoJCQoJCS8vVGhlIGZwcyB0byB0YXJnZXQgLSBvbmx5IHVzZWQgaWYgbm90IHVzaW5nIHJlcXVlc3RBbmltYXRpb25GcmFtZQoJCXRoaXMuZnBzID0gdGhpcy5vcHRpb25zLmZwcyB8fCA2MDsKCgkJLy8gU2V0IHRoZSBhcHAgdG8gZGVmYXVsdAoJCXRoaXMucmVtb3ZlQXBwKCk7CgkJCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIHNob3VsZCBsb2FkIGEgdmVyc2lvbnMgZmlsZQoJCS8vIFRoZSB2ZXJzaW9ucyBmaWxlIGtlZXBzIHRyYWNrIG9mIHRoZSBPUyB2ZXJzaW9uCgkJaWYgKHRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUgIT09IHVuZGVmaW5lZCkKCQl7CgkJCV9pc1JlYWR5ID0gZmFsc2U7CgkJCQoJCQl2YXIgb3MgPSB0aGlzOwoJCQkKCQkJLy8gVHJ5IHRvIGxvYWQgdGhlIGRlZmF1bHQgdmVyc2lvbnMgZmlsZQoJCQkvLyBjYWxsYmFjayBzaG91bGQgYmUgbWFkZSB3aXRoIGEgc2NvcGUgaW4gbWluZAoJCQlsb2FkZXIuY2FjaGVNYW5hZ2VyLmFkZFZlcnNpb25zRmlsZSgKCQkJCXRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUsIAoJCQkJZnVuY3Rpb24oKXsKCQkJCQkKCQkJCQlfaXNSZWFkeSA9IHRydWU7CgkJCQkJCgkJCQkJLy8gU29tZW9uZSBhZGRlZCBhbiBhcHBsaWNhdGlvbiBiZWZvcmUgdGhlIE9TIHdhcyByZWFkeQoJCQkJCS8vIGxldHMgaW5pdGlhbGl6ZSBpcyBub3cKCQkJCQlpZiAob3MuX2FwcCkKCQkJCQl7CgkJCQkJCW9zLmFkZENoaWxkQXQob3MuX2FwcCwgMCk7CgkJCQkJCW9zLl9hcHAuaW5pdCgpOwoJCQkJCQlvcy5yZXN1bWUoKTsKCQkJCQl9CgkJCQl9CgkJCSk7CgkJfQoJCWVsc2UKCQl7CgkJCV9pc1JlYWR5ID0gdHJ1ZTsKCQl9Cgl9OwoJCgl2YXIgaGlkZGVuID0gbnVsbDsvL25lZWRlZCBpbnNpZGUgdGhlIGV2ZW50IGxpc3RlbmVyIGFzIHdlbGwKCXZhciBldnRNYXAgPSBudWxsOwoJdmFyIHYgPSAndmlzaWJsZScsIGggPSAnaGlkZGVuJzsKCXZhciBhZGRQYWdlSGlkZUxpc3RlbmVyID0gZnVuY3Rpb24obGlzdGVuZXIpCgl7CgkJaGlkZGVuID0gImhpZGRlbiI7CgkJLy8gU3RhbmRhcmRzOgoJCWlmIChoaWRkZW4gaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcik7CgkJZWxzZSBpZiAoKGhpZGRlbiA9ICJtb3pIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibW96dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQllbHNlIGlmICgoaGlkZGVuID0gIndlYmtpdEhpZGRlbiIpIGluIGRvY3VtZW50KQoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKChoaWRkZW4gPSAibXNIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibXN2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKCdvbmZvY3VzaW4nIGluIGRvY3VtZW50KS8vIElFIDkgYW5kIGxvd2VyOgoJCXsKCQkJZXZ0TWFwID0geyBmb2N1c2luOnYsIGZvY3Vzb3V0OmggfTsKCQkJZG9jdW1lbnQub25mb2N1c2luID0gZG9jdW1lbnQub25mb2N1c291dCA9IGxpc3RlbmVyOwoJCX0KCQllbHNlLy8gQWxsIG90aGVyczoKCQl7CgkJCWV2dE1hcCA9IHsgZm9jdXM6diwgcGFnZXNob3c6diwgYmx1cjpoLCBwYWdlaGlkZTpoIH07CgkJCXdpbmRvdy5vbnBhZ2VzaG93ID0gd2luZG93Lm9ucGFnZWhpZGUgPSB3aW5kb3cub25mb2N1cyA9IHdpbmRvdy5vbmJsdXIgPSBsaXN0ZW5lcjsKCQl9Cgl9OwoJCgl2YXIgcmVtb3ZlUGFnZUhpZGVMaXN0ZW5lciA9IGZ1bmN0aW9uKGxpc3RlbmVyKQoJewoJCXZhciBoaWRkZW4gPSAiaGlkZGVuIjsKCQlpZiAoaGlkZGVuIGluIGRvY3VtZW50KQoJCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKChoaWRkZW4gPSAibW96SGlkZGVuIikgaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1venZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcik7CgkJZWxzZSBpZiAoKGhpZGRlbiA9ICJ3ZWJraXRIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigid2Via2l0dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQllbHNlIGlmICgoaGlkZGVuID0gIm1zSGlkZGVuIikgaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1zdmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQlkb2N1bWVudC5vbmZvY3VzaW4gPSBkb2N1bWVudC5vbmZvY3Vzb3V0ID0gbnVsbDsKCQl3aW5kb3cub25wYWdlc2hvdyA9IHdpbmRvdy5vbnBhZ2VoaWRlID0gd2luZG93Lm9uZm9jdXMgPSB3aW5kb3cub25ibHVyID0gbnVsbDsKCX07CgoJcC5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkID0gZnVuY3Rpb24oZXZ0KQoJewoJCXZhciB2ID0gJ3Zpc2libGUnLCBoID0gJ2hpZGRlbic7CgoJCWV2dCA9IGV2dCB8fCB3aW5kb3cuZXZlbnQ7CgkJdmFyIHZhbHVlOwoJCWlmIChldnRNYXApCgkJCXZhbHVlID0gZXZ0TWFwW2V2dC50eXBlXTsKCQllbHNlCgkJCXZhbHVlID0gZG9jdW1lbnRbaGlkZGVuXSA/IGggOiB2OwoJCWlmKHZhbHVlID09IGgpCgkJCXRoaXMucGF1c2UoKTsKCQllbHNlCgkJCXRoaXMucmVzdW1lKCk7Cgl9OwoJCgkvKioKCSogIERlZmluZSBhbGwgb2YgdGhlIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zCgkqICBAcGFyYW0ge29iamVjdH0gb3V0cHV0IFRoZSBvYmplY3QgcmVmZXJlbmNlIHRvIHVwZGF0ZQoJKi8KCXZhciBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zID0gZnVuY3Rpb24ob3V0cHV0KQoJewoJCXZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CgkJdmFyIHF1ZXN0aW9uTWFyayA9IGhyZWYuaW5kZXhPZigiPyIpOwoJCWlmIChxdWVzdGlvbk1hcmsgPT0gLTEpIHJldHVybiBvdXRwdXQ7CgkJCgkJdmFyIHZhcnMgPSBxdWVzdGlvbk1hcmsgPCAwID8gJycgOiBocmVmLnN1YnN0cihxdWVzdGlvbk1hcmsrMSk7CgkJdmFyIHBvdW5kID0gdmFycy5pbmRleE9mKCcjJyk7CgkJdmFycyA9IHBvdW5kIDwgMCA/IHZhcnMgOiB2YXJzLnN1YnN0cmluZygwLCBwb3VuZCk7CgkJdmFyIHNwbGl0Rmxhc2hWYXJzID0gdmFycy5zcGxpdCgiJiIpOwoJCXZhciBteVZhcjsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHNwbGl0Rmxhc2hWYXJzLmxlbmd0aDsgaSsrKQoJCXsKCQkJbXlWYXIgPSBzcGxpdEZsYXNoVmFyc1tpXS5zcGxpdCgiPSIpOwoJCQlpZiAodHJ1ZSkKCQkJewoJCQkJRGVidWcubG9nKG15VmFyWzBdICsgIiAtPiAiICsgbXlWYXJbMV0pOwoJCQl9CgkJCW91dHB1dFtteVZhclswXV0gPSBteVZhclsxXTsKCQl9CgkJcmV0dXJuIG91dHB1dDsKCX07CgkKCS8qKgoJKiAgUGF1c2UgdGhlIE9TIGFuZCBzdG9wIGZyYW1lIHVwZGF0ZXMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgcGF1c2UKCSovCglwLnBhdXNlID0gZnVuY3Rpb24oKQoJewoJCWlmKF90aWNrSWQgIT0gLTEpCgkJewoJCQlpZihfdXNlUkFGKQoJCQl7CgkJCQlpZih3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUpCgkJCQkJY2FuY2VsQW5pbWF0aW9uRnJhbWUoX3RpY2tJZCk7CgkJCX0KCQkJZWxzZQoJCQkJY2xlYXJUaW1lb3V0KF90aWNrSWQpOwoJCQlfdGlja0lkID0gLTE7CgkJfQoJCV9wYXVzZWQgPSB0cnVlOwoJfTsKCQoJdmFyIG5vd0Z1bmMgPSB3aW5kb3cucGVyZm9ybWFuY2UgJiYgKHBlcmZvcm1hbmNlLm5vdyB8fCBwZXJmb3JtYW5jZS5tb3pOb3cgfHwgcGVyZm9ybWFuY2UubXNOb3cgfHwgcGVyZm9ybWFuY2Uub05vdyB8fCBwZXJmb3JtYW5jZS53ZWJraXROb3cpOwoJaWYobm93RnVuYykKCQlub3dGdW5jID0gbm93RnVuYy5iaW5kKHBlcmZvcm1hbmNlKTsKCWVsc2UKCQlub3dGdW5jID0gZnVuY3Rpb24oKSB7IHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsgfTsvL2FwcGFyZW50bHkgaW4gQ2hyb21lIHRoaXMgaXMgZXh0cmVtZWx5IGluYWNjdXJhdGUgKHRyaXBsZSBmcmFtZXJhdGUgb3Igc29tZXRoaW5nIHNpbGx5KQoKCS8qKgoJKiAgR2V0cyB0aGUgY3VycmVudCB0aW1lIGluIG1pbGxpc2Vjb25kcyBmb3IgdGltaW5nIHB1cnBvc2VzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGdldFRpbWUKCSovCglwLmdldFRpbWUgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIG5vd0Z1bmMoKTsKCX07CgkKCS8qKgoJKiAgUmVzdW1lIHRoZSBPUyB1cGRhdGVzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc3VtZQoJKi8KCXAucmVzdW1lID0gZnVuY3Rpb24oKQoJewoJCV9wYXVzZWQgPSBmYWxzZTsKCQkKCQlpZihfdGlja0lkID09IC0xKQoJCXsKCQkJX3RpY2tJZCA9IF91c2VSQUYgPyAKCQkJCXJlcXVlc3RBbmltRnJhbWUoX3RpY2tDYWxsYmFjayk6IAoJCQkJc2V0VGFyZ2V0ZWRUaW1lb3V0KF90aWNrQ2FsbGJhY2spOwoJCX0KCQlfbGFzdEZQU1VwZGF0ZVRpbWUgPSBfbGFzdEZyYW1lVGltZSA9IHRoaXMuZ2V0VGltZSgpOwoJfTsKCQoJLyoqCgkqIFRoZSBGUFMgdGhhdCB0aGUgT1MgaXMgdGFyZ2V0aW5nLgoJKiAKCSogQHByb3BlcnR5IHtOdW1iZXJ9IGZwcwoJKiBAcHVibGljCgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJmcHMiLCB7CgkJZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9mcHM7IH0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoJCQlpZih0eXBlb2YgdmFsdWUgIT0gIm51bWJlciIpIHJldHVybjsKCQkJX2ZwcyA9IHZhbHVlOwoJCQlfbXNQZXJGcmFtZSA9ICgxMDAwIC8gX2ZwcykgfCAwOwoJCX0KCX0pOwoJCgkvKioKCSogIENvbnZlbmllbmNlIGZvciBhY2Nlc3NpbmcgdGhlIHN0YWdlJ3Mgd2lkdGgKCSogICAKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBzdGFnZVdpZHRoCgkqICBAcHVibGljCgkqICBAcmVhZE9ubHkKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInN0YWdlV2lkdGgiLCB7CgkJZ2V0OiBmdW5jdGlvbigpewoJCQlpZiAoZmFsc2UpIHJldHVybiBfaW5zdGFuY2Uuc3RhZ2UuY2FudmFzLndpZHRoOwoJCQlpZiAodHJ1ZSkgcmV0dXJuIF9pbnN0YW5jZS5fcmVuZGVyZXIudmlldy53aWR0aDsKCQl9Cgl9KTsKCQoJLyoqCgkqICBDb252ZW5pZW5jZSBmb3IgYWNjZXNzaW5nIHRoZSBzdGFnZSdzIGhlaWdodAoJKiAgIAoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IHN0YWdlSGVpZ2h0CgkqICBAcHVibGljCgkqICBAcmVhZE9ubHkKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInN0YWdlSGVpZ2h0IiwgewoJCWdldDogZnVuY3Rpb24oKXsKCQkJaWYgKGZhbHNlKSByZXR1cm4gX2luc3RhbmNlLnN0YWdlLmNhbnZhcy5oZWlnaHQ7CgkJCWlmICh0cnVlKSByZXR1cm4gX2luc3RhbmNlLl9yZW5kZXJlci52aWV3LmhlaWdodDsKCQl9Cgl9KTsKCQoJdmFyIHNldFRhcmdldGVkVGltZW91dCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aW1lSW5GcmFtZSkKCXsKCQl2YXIgdGltZVRvQ2FsbCA9IDA7CgkJaWYodGltZUluRnJhbWUpCgkJCXRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCBfbXNQZXJGcmFtZSAtIHRpbWVJbkZyYW1lKTsvL3N1YnRyYWN0IHRoZSB0aW1lIHNwZW50IGluIHRoZSBmcmFtZSB0byBhY3R1YWxseSBoaXQgdGhlIHRhcmdldCBmcHMKCQlyZXR1cm4gc2V0VGltZW91dChjYWxsYmFjaywgdGltZVRvQ2FsbCk7Cgl9OwoJCgkvKioKCSogIFJlbW92ZSB0aGUgYXBwbGljYXRpb24KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgcmVtb3ZlQXBwCgkqICBAcGFyYW0ge0Jvb2xlYW59IGRlc3Ryb3lpbmcgSWYgdGhlIE9TIGlzIGJlaW5nIGRlc3Ryb3llZCBhbmQgc2hvdWxkbid0IGJvdGhlciBydW5uaW5nIGFueSByZXNldHRpbmcgY29kZS4KCSogIEByZXR1cm4ge0Jvb2xlYW59IElmIGFuIGBBcHBsaWNhdGlvbmAgd2FzIHN1Y2Nlc3NmdWxseSByZW1vdmVkCgkqLwoJcC5yZW1vdmVBcHAgPSBmdW5jdGlvbihkZXN0cm95aW5nKQoJewoJCXZhciByZW1vdmVkID0gZmFsc2U7CgkJCgkJdmFyIHN0YWdlID0gdGhpcy5zdGFnZTsKCQlpZiAodGhpcy5fYXBwKQoJCXsKCQkJaWYoZmFsc2UpCgkJCXsKCQkJCWlmKHRoaXMuY29udGFpbnModGhpcy5fYXBwKSkKCQkJCQl0aGlzLnJlbW92ZUNoaWxkKHRoaXMuX2FwcCk7CgkJCQlzdGFnZS5yZW1vdmVBbGxDaGlsZHJlbigpOwoJCQl9CgkJCWlmKHRydWUpCgkJCXsKCQkJCWlmKHRoaXMuX2FwcC5wYXJlbnQgPT0gdGhpcykKCQkJCQl0aGlzLnJlbW92ZUNoaWxkKHRoaXMuX2FwcCk7CgkJCQlzdGFnZS5yZW1vdmVDaGlsZHJlbigpOwoJCQl9CgkJCXRoaXMuX2FwcC5kZXN0cm95KCk7CgkJCXJlbW92ZWQgPSB0cnVlOwoJCX0KCQl0aGlzLl9hcHAgPSBudWxsOwoJCQoJCS8vIFN0b3AgdGhlIHVwZGF0ZQoJCXRoaXMucGF1c2UoKTsKCQkJCQoJCWlmKCFkZXN0cm95aW5nKQoJCXsJCQkKCQkJc3RhZ2UuYWRkQ2hpbGQodGhpcyk7CgkJCWlmKF9mcmFtZXJhdGUpCgkJCXsKCQkJCS8vIFJlc2V0IHRoZSBmcmFtZXJhdGUKCQkJCV9mcmFtZXJhdGUudGV4dCA9ICJGUFM6IDAuMDAwIjsKCQkJfQoJCQkKCQkJLy8gSWdub3JlIHNwaWtlcyBpbiBmcmFtZSBjb3VudAoJCQlfbGFzdEZyYW1lVGltZSA9IF9sYXN0RlBTVXBkYXRlVGltZSA9IF9mcmFtZXJhdGVWYWx1ZSA9IF9mcmFtZUNvdW50ID0gMDsKCQkJCgkJCS8vIFVwZGF0ZSB0aGUgc3RhZ2UKCQkJaWYodHJ1ZSkgdGhpcy5fcmVuZGVyZXIucmVuZGVyKHN0YWdlKTsKCQkJZWxzZSBpZihmYWxzZSkgdGhpcy5zdGFnZS51cGRhdGUoKTsKCQl9CgkJCgkJcmV0dXJuIHJlbW92ZWQ7Cgl9OwoJCgkvKioKCSogIEFkZCBhbiBhcHAgdG8gdGhpcyBkaXNwbGF5IGxpc3QKCSogIEBwdWJsaWMgCgkqICBAbWV0aG9kIGFkZEFwcAoJKiAgQHBhcmFtIHtBcHBsaWNhdGlvbn0gYXBwIFRoZSBhcHBsaWNhdGlvbiB0byBhZGQKCSovCglwLmFkZEFwcCA9IGZ1bmN0aW9uKGFwcCkKCXsKCQl0aGlzLnJlbW92ZUFwcCgpOwoJCWlmICghKGFwcCBpbnN0YW5jZW9mIGNsb3Vka2lkLkFwcGxpY2F0aW9uKSkKCQl7CgkJCXRocm93IG5ldyBFcnJvcigiQ2FuIG9ubHkgb2JqZWN0cyB0aGF0IGluaGVyaXQgY2xvdWRraWQuQXBwbGljYXRpb24iKTsKCQl9CgkJdGhpcy5fYXBwID0gYXBwOwoJCWlmIChfaXNSZWFkeSkKCQl7CgkJCXRoaXMuYWRkQ2hpbGRBdChhcHAsIDApOwoJCQl0aGlzLl9hcHAuaW5pdCgpOwoJCQl0aGlzLnJlc3VtZSgpOwoJCX0KCX07CgkKCS8qKgoJKiAgR2V0IHRoZSBjdXJyZW50IGFwcGxpY2F0aW9uCgkqICBAbWV0aG9kIGdldEFwcAoJKiAgQHB1YmxpYwoJKiAgQHJldHVybiB7QXBwbGljYXRpb259IFRoZSBjdXJyZW50IEFwcGxpY2F0aW9uLCBudWxsIGlmIG5vIGFwcGxpY2F0aW9uCgkqLwoJcC5nZXRBcHAgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIHRoaXMuX2FwcDsKCX07CgkKCS8qKgoJKiAgQWRkIGFuIHVwZGF0ZSBjYWxsYmFjaywgbXVzdCB0YWtlIGVsYXBzZWQgYXMgYSBwYXJhbWV0ZXIKCSogIEBtZXRob2QgYWRkVXBkYXRlQ2FsbGJhY2sKCSogIEBwdWJsaWMKCSogIEBwYXJhbSB7c3RyaW5nfSBhbGlhcyBBbiBhbGlhcyB0byBhc3NvY2lhdGUgd2l0aCB0aGlzIGNhbGxiYWNrCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBmIFRoZSBjYWxsYmFjayBmdW5jdGlvbgoJKi8KCXAuYWRkVXBkYXRlQ2FsbGJhY2sgPSBmdW5jdGlvbihhbGlhcywgZikKCXsKCQlpZiAodGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9PT0gdW5kZWZpbmVkKQoJCXsKCQkJdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9IGY7CgkJfQkJCgl9OwoJCgkvKioKCSogIFJlbW92ZSBhbiB1cGRhdGUgY2FsbGJhY2ssIG11c3QgdGFrZSBlbGFwc2VkIGFzIGEgcGFyYW1ldGVyCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlbW92ZVVwZGF0ZUNhbGxiYWNrCgkqICBAcGFyYW0ge3N0cmluZ30gYWxpYXMgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGFsaWFzCgkqLwoJcC5yZW1vdmVVcGRhdGVDYWxsYmFjayA9IGZ1bmN0aW9uKGFsaWFzKQoJewoJCWlmICh0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdICE9PSB1bmRlZmluZWQpCgkJewoJCQlkZWxldGUgdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXTsKCQl9Cgl9OwoJCgkvKioKCSogIENhbGxlZCBieSB0aGUgc3RhZ2UgbGlzdGVuZXIKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgdGljawoJKi8KCXAudGljayA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAoX3BhdXNlZCkKCQl7CgkJCV90aWNrSWQgPSAtMTsKCQkJcmV0dXJuOwoJCX0KCQkKCQl2YXIgbm93ID0gdGhpcy5nZXRUaW1lKCk7CgkJdmFyIGRUaW1lID0gbm93IC0gX2xhc3RGcmFtZVRpbWU7CgkJCgkJLy8gT25seSB1cGRhdGUgdGhlIGZyYW1lcmF0ZSBldmVyIHNlY29uZAoJCWlmKF9mcmFtZXJhdGUgJiYgX2ZyYW1lcmF0ZS52aXNpYmxlKQoJCXsKCQkJX2ZyYW1lQ291bnQrKzsKCQkJdmFyIGVsYXBzZWQgPSBub3cgLSBfbGFzdEZQU1VwZGF0ZVRpbWU7CgkJCWlmIChlbGFwc2VkID4gMTAwMCkKCQkJewoJCQkJX2ZyYW1lcmF0ZVZhbHVlID0gMTAwMCAvIGVsYXBzZWQgKiBfZnJhbWVDb3VudDsKCQkJCWlmKHRydWUpCgkJCQkJX2ZyYW1lcmF0ZS5zZXRUZXh0KCJGUFM6ICIgKyAoTWF0aC5yb3VuZChfZnJhbWVyYXRlVmFsdWUgKiAxMDAwKSAvIDEwMDApKTsKCQkJCWVsc2UgaWYoZmFsc2UpCgkJCQkJX2ZyYW1lcmF0ZS50ZXh0ID0gIkZQUzogIiArIChNYXRoLnJvdW5kKF9mcmFtZXJhdGVWYWx1ZSAqIDEwMDApIC8gMTAwMCk7CgkJCQlfbGFzdEZQU1VwZGF0ZVRpbWUgPSBub3c7CgkJCQlfZnJhbWVDb3VudCA9IDA7CgkJCX0KCQl9CgkJX2xhc3RGcmFtZVRpbWUgPSBub3c7CgkJCgkJLy91cGRhdGUgYXBwCQkJCQoJCWlmICh0aGlzLl9hcHApCgkJewoJCQl0aGlzLl9hcHAudXBkYXRlKGRUaW1lKTsKCQl9CgkJLy91cGRhdGUgb3RoZXIgZnVuY3Rpb25zCgkJZm9yKHZhciBhbGlhcyBpbiB0aGlzLl91cGRhdGVGdW5jdGlvbnMpCgkJewoJCQl0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdKGRUaW1lKTsKCQl9CgkJLy9yZW5kZXIgc3RhZ2UKCQlpZiAodHJ1ZSkgdGhpcy5fcmVuZGVyZXIucmVuZGVyKHRoaXMuc3RhZ2UpOwoJCWlmIChmYWxzZSkgdGhpcy5zdGFnZS51cGRhdGUoZFRpbWUpOwoJCQoJCS8vcmVxdWVzdCB0aGUgbmV4dCBhbmltYXRpb24gZnJhbWUKCQlfdGlja0lkID0gX3VzZVJBRiA/IAoJCQlyZXF1ZXN0QW5pbUZyYW1lKF90aWNrQ2FsbGJhY2spIDogCgkJCXNldFRhcmdldGVkVGltZW91dChfdGlja0NhbGxiYWNrLCB0aGlzLmdldFRpbWUoKSAtIF9sYXN0RnJhbWVUaW1lKTsKCX07CgkKCS8qKgoJKiAgW1BJWEkgT25seV0gUmVzaXplcyB0aGUgcmVuZGVyZXIgYW5kIHRoZSBjYW52YXNDb250YWluZXIuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc2l6ZQoJKi8KCWlmKHRydWUpCgl7CgkJcC5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQoJCXsKCQkJdGhpcy5fcmVuZGVyZXIucmVzaXplKHdpZHRoLCBoZWlnaHQpOwoJCQl0aGlzLmNhbnZhc0NvbnRhaW5lci5zZXRBdHRyaWJ1dGUoInN0eWxlIiwicG9zaXRpb246cmVsYXRpdmU7d2lkdGg6IiArIHdpZHRoICsgInB4O2hlaWdodDoiICsgaGVpZ2h0ICsgInB4Iik7CgkJfTsKCX0KCQoJLyoqCgkqICBEZXN0cm95IHRoZSBpbnN0YW5jZSBvZiB0aGUgT1MsIGNhbiBpbml0IGFmdGVyIHRoaXMsCgkqICBhbHNvIGRlc3Ryb3lzIHRoZSBhcHBsaWNhdGlvbiwgaWYgYXJvdW5kCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdmFyIHN0YWdlID0gdGhpcy5zdGFnZTsvL2tlZXAgYSByZWZlcmVuY2UgZm9yIGxhdGVyIGluIGNhc2UgdGhlIE9TIGlzIHJlbW92ZWQgZnJvbSB0aGUgc3RhZ2UKCQkKCQl2YXIgbWwgPSBjbG91ZGtpZC5NZWRpYUxvYWRlci5pbnN0YW5jZTsKCQl0aGlzLnBhdXNlKCk7CgkJdGhpcy5yZW1vdmVBcHAodHJ1ZSk7CgkJX2luc3RhbmNlID0gbnVsbDsKCQkKCQlpZihmYWxzZSkKCQl7CgkJCWNyZWF0ZWpzLlRvdWNoLmRpc2FibGUoc3RhZ2UpOwoJCQlzdGFnZS5lbmFibGVNb3VzZU92ZXIoLTEpOy8vZGlzYWJsZSBtb3VzZW92ZXIgZXZlbnRzCgkJCXN0YWdlLmVuYWJsZURPTUV2ZW50cyhmYWxzZSk7CgkJfQoJCQoJCW1sLmRlc3Ryb3koKTsKCQl0aGlzLnN0YWdlID0gbnVsbDsKCQl0aGlzLl91cGRhdGVGdW5jdGlvbnMgPSBudWxsOwoJCXJlbW92ZVBhZ2VIaWRlTGlzdGVuZXIodGhpcy52aXNpYmxlTGlzdGVuZXIpOwoJCQoJCWlmKHRydWUpCgkJewoJCQl0aGlzLnJlbW92ZUNoaWxkcmVuKHRydWUpOwoJCQlzdGFnZS5kZXN0cm95KCk7CgkJCXRoaXMuX3JlbmRlcmVyLmRlc3Ryb3koKTsKCQkJdGhpcy5fcmVuZGVyZXIgPSBudWxsOwoJCQl0aGlzLmNhbnZhc0NvbnRhaW5lciA9IG51bGw7CgkJfQoJfTsKCQoJLyoqCgkqICBTdGF0aWMgZnVuY3Rpb24gZm9yIGdldHRpbmcgdGhlIHNpbmdsZXRvbiBpbnN0YW5jZQoJKiAgQHN0YXRpYwoJKiAgQHJlYWRPbmx5CgkqICBAcHVibGljCgkqICBAYXR0cmlidXRlIGluc3RhbmNlCgkqICBAdHlwZSBPUwoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShPUywgImluc3RhbmNlIiwgewoJCWdldDpmdW5jdGlvbigpCgkJewoJCQlpZiAoIV9pbnN0YW5jZSkKCQkJewoJCQkJdGhyb3cgJ0NhbGwgY2xvdWRraWQuT1MuaW5pdChjYW52YXNJZCknOwoJCQl9CgkJCXJldHVybiBfaW5zdGFuY2U7CgkJfQoJfSk7CgkKCS8vIEFkZCB0byB0aGUgbmFtZSBzcGFjZQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLk9TID0gT1M7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgkKCS8qKiAKCSogIFRoZSBTYXZlZERhdGEgZnVuY3Rpb25zIHVzZSBsb2NhbFN0b3JhZ2UgYW5kIHNlc3Npb25TdG9yYWdlLCB3aXRoIGEgY29va2llIGZhbGxiYWNrLiAKCSoKCSogIEBjbGFzcyBTYXZlZERhdGEKCSovCgl2YXIgU2F2ZWREYXRhID0ge30sCgkKCS8qKiBBIGNvbnN0YW50IHRvIGRldGVybWluZSBpZiB3ZSBjYW4gdXNlIGxvY2FsU3RvcmFnZSBhbmQgc2Vzc2lvblN0b3JhZ2UgKi8KCVdFQl9TVE9SQUdFX1NVUFBPUlQgPSB0eXBlb2Yod2luZG93LlN0b3JhZ2UpICE9PSAidW5kZWZpbmVkIiwKCQoJLyoqIEEgY29uc3RhbnQgZm9yIGNvb2tpZSBmYWxsYmFjayBmb3IgU2F2ZWREYXRhLmNsZWFyKCkgKi8KCUVSQVNFX0NPT0tJRSA9IC0xOwoKCS8vaW4gaU9TLCBpZiB0aGUgdXNlciBpcyBpbiBQcml2YXRlIEJyb3dzaW5nLCB3cml0aW5nIHRvIGxvY2FsU3RvcmFnZSB0aHJvd3MgYW4gZXJyb3IuCglpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJewoJCXRyeQoJCXsKCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpOwoJCQlsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiTFNfVEVTVCIpOwoJCX0KCQljYXRjaChlKQoJCXsKCQkJV0VCX1NUT1JBR0VfU1VQUE9SVCA9IGZhbHNlOwoJCX0KCX0KCgkvKioKCSAqIElmIFNhdmVkRGF0YSB3aWxsIGJlIHVzaW5nIGxvY2FsU3RvcmFnZSBhbmQgc2Vzc2lvblN0b3JhZ2UuCgkgKiBAcHJvcGVydHkge0Jvb2xlYW59IHVzZVdlYlN0b3JhZ2UKCSAqIEBkZWZhdWx0ICB0cnVlCgkgKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShTYXZlZERhdGEsICJ1c2VXZWJTdG9yYWdlIiwgewoJCWdldDogZnVuY3Rpb24oKSB7IHJldHVybiBXRUJfU1RPUkFHRV9TVVBQT1JUOyB9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQlpZih2YWx1ZSAmJiB0eXBlb2Yod2luZG93LlN0b3JhZ2UpICE9PSAidW5kZWZpbmVkIikKCQkJewoJCQkJdHJ5CgkJCQl7CgkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpOwoJCQkJCWxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJMU19URVNUIik7CgkJCQkJV0VCX1NUT1JBR0VfU1VQUE9SVCA9IHRydWU7CgkJCQl9CgkJCQljYXRjaChlKQoJCQkJewoJCQkJCVdFQl9TVE9SQUdFX1NVUFBPUlQgPSBmYWxzZTsKCQkJCX0KCQkJfQoJCQllbHNlCgkJCQlXRUJfU1RPUkFHRV9TVVBQT1JUID0gZmFsc2U7CgkJfQoJfSk7IAoJCgkvKiogCgkqICBSZW1vdmUgYSBzYXZlZCB2YXJpYWJsZSBieSBuYW1lLgoJKiAgQG1ldGhvZCByZW1vdmUKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB2YWx1ZSB0byByZW1vdmUKCSovCglTYXZlZERhdGEucmVtb3ZlID0gZnVuY3Rpb24obmFtZSkKCXsKCQlpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJCXsKCQkJbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0obmFtZSk7CgkJCXNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0obmFtZSk7CgkJfQoJCWVsc2UKCQkJU2F2ZWREYXRhLndyaXRlKG5hbWUsIiIsRVJBU0VfQ09PS0lFKTsKCX07CgkKCS8qKgoJKiAgU2F2ZSBhIHZhcmlhYmxlLgoJKiAgQG1ldGhvZCB3cml0ZQoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHZhbHVlIHRvIHNhdmUKCSogIEBwYXJhbSB7bWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzYXZlLiBUaGlzIHdpbGwgYmUgcnVuIHRocm91Z2ggSlNPTi5zdHJpbmdpZnkoKS4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW3RlbXBPbmx5PWZhbHNlXSBJZiB0aGUgdmFsdWUgc2hvdWxkIGJlIHNhdmVkIG9ubHkgaW4gdGhlIGN1cnJlbnQgYnJvd3NlciBzZXNzaW9uLgoJKi8KCVNhdmVkRGF0YS53cml0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCB0ZW1wT25seSkKCXsKCQlpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJCXsKCQkJaWYodGVtcE9ubHkpCgkJCQlzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7CgkJCWVsc2UKCQkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7CgkJfQoJCWVsc2UKCQl7CgkJCXZhciBleHBpcmVzOwoJCQlpZiAodGVtcE9ubHkpCgkJCXsKCQkJCWlmKHRlbXBPbmx5ICE9PSBFUkFTRV9DT09LSUUpCgkJCQkJZXhwaXJlcyA9ICIiOy8vcmVtb3ZlIHdoZW4gYnJvd3NlciBpcyBjbG9zZWQKCQkJCWVsc2UKCQkJCQlleHBpcmVzID0gIjsgZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCI7Ly9zYXZlIGNvb2tpZSBpbiB0aGUgcGFzdCBmb3IgaW1tZWRpYXRlIHJlbW92YWwKCQkJfQoJCQllbHNlCgkJCQlleHBpcmVzID0gIjsgZXhwaXJlcz0iK25ldyBEYXRlKDIxNDc0ODM2NDYwMDApLnRvR01UU3RyaW5nKCk7Ly9USEUgRU5EIE9GICgzMmJpdCBVTklYKSBUSU1FIQoJCQkJCgkJCWRvY3VtZW50LmNvb2tpZSA9IG5hbWUrIj0iK2VzY2FwZShKU09OLnN0cmluZ2lmeSh2YWx1ZSkpK2V4cGlyZXMrIjsgcGF0aD0vIjsKCQl9Cgl9OwoJCgkvKioKCSogIFJlYWQgdGhlIHZhbHVlIG9mIGEgc2F2ZWQgdmFyaWFibGUKCSogIEBtZXRob2QgcmVhZAoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHZhcmlhYmxlCgkqICBAcmV0dXJuIHttaXhlZH0gVGhlIHZhbHVlIChydW4gdGhyb3VnaCBgSlNPTi5wYXJzZSgpYCkgb3IgbnVsbCBpZiBpdCBkb2Vzbid0IGV4aXN0CgkqLwoJU2F2ZWREYXRhLnJlYWQgPSBmdW5jdGlvbihuYW1lKQoJewoJCWlmKFdFQl9TVE9SQUdFX1NVUFBPUlQpCgkJewoJCQl2YXIgdmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShuYW1lKSB8fCBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKG5hbWUpOwoJCQlpZih2YWx1ZSkKCQkJCXJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKCQkJZWxzZQoJCQkJcmV0dXJuIG51bGw7CgkJfQoJCWVsc2UKCQl7CgkJCXZhciBuYW1lRVEgPSBuYW1lICsgIj0iLAoJCQkJY2EgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoJzsnKSwKCQkJCWkgPSAwLCBjOwoJCQkJCgkJCWZvcihpPTA7aSA8IGNhLmxlbmd0aDtpKyspCgkJCXsKCQkJCWMgPSBjYVtpXTsKCQkJCXdoaWxlIChjLmNoYXJBdCgwKSA9PSAnICcpIGMgPSBjLnN1YnN0cmluZygxLGMubGVuZ3RoKTsKCQkJCWlmIChjLmluZGV4T2YobmFtZUVRKSA9PT0gMCkgcmV0dXJuIEpTT04ucGFyc2UodW5lc2NhcGUoYy5zdWJzdHJpbmcobmFtZUVRLmxlbmd0aCxjLmxlbmd0aCkpKTsKCQkJfQoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIGdsb2JhbCBzcGFjZQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLlNhdmVkRGF0YSA9IFNhdmVkRGF0YTsKCQp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24oKXsKCQoJInVzZSBzdHJpY3QiOwoJCgkvLyBDb21iaW5lIHByZWZpeGVkIFVSTCBmb3IgY3JlYXRlT2JqZWN0VVJMIGZyb20gYmxvYnMuCgl3aW5kb3cuVVJMID0gd2luZG93LlVSTCB8fCB3aW5kb3cud2Via2l0VVJMOwoKCS8vIENvbWJpbmUgcHJlZml4ZWQgYmxvYiBidWlsZGVyCgl3aW5kb3cuQmxvYkJ1aWxkZXIgPSB3aW5kb3cuQmxvYkJ1aWxkZXIgfHwgd2luZG93LldlYktpdEJsb2JCdWlsZGVyIHx8IHdpbmRvdy5Nb3pCbG9iQnVpbGRlcjsKCgkvKioKCSogIFRoZSBXZWIgV29ya2VycyBzcGVjaWZpY2F0aW9uIGRlZmluZXMgYW4gQVBJIGZvciBzcGF3bmluZyBiYWNrZ3JvdW5kIHNjcmlwdHMgaW4geW91ciB3ZWIgCgkqICBhcHBsaWNhdGlvbi4gV2ViIFdvcmtlcnMgYWxsb3cgeW91IHRvIGRvIHRoaW5ncyBsaWtlIGZpcmUgdXAgbG9uZy1ydW5uaW5nIHNjcmlwdHMgdG8gCgkqICBoYW5kbGUgY29tcHV0YXRpb25hbGx5IGludGVuc2l2ZSB0YXNrcywgYnV0IHdpdGhvdXQgYmxvY2tpbmcgdGhlIFVJIG9yIG90aGVyIHNjcmlwdHMgCgkqICB0byBoYW5kbGUgdXNlciBpbnRlcmFjdGlvbnMuIEJlY2F1c2UgV29ya2VycyBhcmVuJ3QgYXZhaWxhYmxlIG9uIGFsbCBicm93c2Vycywgd2UgcHJvdmlkZQoJKiAgYSBoZWxwZnVsIHBvbHlmaWxsIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LgoJKgoJKgl2YXIgd29ya2VyQ29kZSA9ICJ0aGlzLmluaXRpYWxWYXJpYWJsZSA9IDEwOyIgKwoJKgkidGhpcy5vbm1lc3NhZ2UgPSBmdW5jdGlvbihldmVudCkiICsKCSoJInsiICsKCSoJCSJ2YXIgZGF0YSA9IGV2ZW50LmRhdGE7IiArCgkqCQkidmFyIHJldHVyblZhbCA9IHRoaXMuaW5pdGlhbFZhcmlhYmxlICsgZGF0YS5hZGRWYWx1ZTsiICsKCSoJCSJ0aGlzLnBvc3RNZXNzYWdlKHJldHVyblZhbCk7IiArCgkqCSJ9OyI7CgkqCgkqCS8vIENyZWF0ZSB0aGUgd29ya2VyCgkqCXZhciB3b3JrZXIgPSBjbG91ZGtpZC5Xb3JrZXIuaW5pdCh3b3JrZXJDb2RlKTsKCSoJd29ya2VyLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGUpIHsKCSoJCS8vIGUuZGF0YSBpcyB0aGUgcmV0dXJuVmFsCgkqCX07CgkqCQoJKgkvLyBTdGFydCB0aGUgd29ya2VyLgoJKgl3b3JrZXIucG9zdE1lc3NhZ2UoKTsgCgkqCgkqICBAY2xhc3MgV29ya2VyCgkqLwoJdmFyIFdvcmtlciA9IHt9OwoKCS8qKgoJKiAgSW5pdGlhbGl6ZSB0aGUgd29ya2VyLCB0aGlzIGlzIGhvdyB5b3UgY3JlYXRlIGEgV29ya2VyIG9yIEZhbGxiYWNrV29ya2VyIG9iamVjdC4KCSogIEBtZXRob2QgaW5pdAoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IGNvZGVTdHJpbmcgVGhlIGNvZGUgaW4gc3RyaW5nIGZvcm0gdG8gbWFrZSB0aGUgd29ya2VyIGZyb20uIEFzIGEgc3RyaW5nLCBmYWxsYmFjayBzdXBwb3J0IGlzIGVhc2llci4KCSogIEByZXR1cm4ge0ZhbGxiYWNrV29ya2VyfHdpbmRvdy5Xb3JrZXJ9IEVpdGhlciBhIFdlYiBXb3JrZXIgb3IgYSBmYWxsYmFjayB3aXRoIHRoZSBzYW1lIEFQSSB0byB1c2UuCgkqLwoJV29ya2VyLmluaXQgPSBmdW5jdGlvbihjb2RlU3RyaW5nKQoJewoJCWlmKCF3aW5kb3cuVVJMIHx8ICF3aW5kb3cuV29ya2VyKSByZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwoKCQl2YXIgYmxvYjsKCQl0cnkKCQl7CgkJCWJsb2IgPSBuZXcgQmxvYihbY29kZVN0cmluZ10sIHt0eXBlOiAnYXBwbGljYXRpb24vamF2YXNjcmlwdCd9KTsKCQl9CgkJY2F0Y2ggKGUpCgkJewoJCQkvLyB0cnkgQmFja3dhcmRzLWNvbXBhdGliaWxpdHkgd2l0aCBibG9iIGJ1aWxkZXJzCgkJCWlmKCF3aW5kb3cuQmxvYkJ1aWxkZXIpIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CgkJCXRyeQoJCQl7CgkJCQlibG9iID0gbmV3IEJsb2JCdWlsZGVyKCk7CgkJCQlibG9iLmFwcGVuZChjb2RlU3RyaW5nKTsKCQkJCWJsb2IgPSBibG9iLmdldEJsb2IoKTsKCQkJfQoJCQljYXRjaChlcnJvcikKCQkJewoJCQkJLy9ubyB3YXkgb2YgZ2VuZXJhdGluZyBhIGJsb2IgdG8gY3JlYXRlIHRoZSB3b3JrZXIgZnJvbQoJCQkJcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKCQkJfQoJCX0KCQlpZighYmxvYikgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsvL2lmIHNvbWVob3cgbm8gYmxvYiB3YXMgY3JlYXRlZCwgcmV0dXJuIGEgZmFsbGJhY2sgd29ya2VyCgkJdHJ5CgkJewoJCQkvL0lFIDEwIGFuZCAxMSwgd2hpbGUgc3VwcG9ydGluZyBCbG9iIGFuZCBXb3JrZXJzLCBzaG91bGQgdGhyb3cgYW4gZXJyb3IgaGVyZSwgc28gd2Ugc2hvdWxkIGNhdGNoIGl0IGFuZCBmYWxsIGJhY2sKCQkJdmFyIHdvcmtlciA9IG5ldyBXb3JrZXIoVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKSk7CgkJCXJldHVybiB3b3JrZXI7CgkJfQoJCWNhdGNoKGUpCgkJewoJCQkvL2Nhbid0IGNyZWF0ZSBhIHdvcmtlcgoJCQlyZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwoJCX0KCX07CgoJLy8gRGVwcmVjYXRlZCBpbXBsZW1lbnRhdGlvbgoJbmFtZXNwYWNlKCJjbG91ZGtpZCIpLmNyZWF0ZVdvcmtlciA9IFdvcmtlci5pbml0OwoKCS8vIEFzc2lnbiB0byBuYW1lc3BhY2UKCW5hbWVzcGFjZSgiY2xvdWRraWQiKS5Xb3JrZXIgPSBXb3JrZXI7CgkKCS8qKgoJKglJbnRlcm5hbCBjbGFzcyB0aGF0IHByZXRlbmRzIHRvIGJlIGEgV2ViIFdvcmtlcidzIGNvbnRleHQuCgkqCUBjbGFzcyBTdWJXb3JrZXIKCSoJQGNvbnN0cnVjdG9yCgkqCUBwYXJhbSB7U3RyaW5nfSBjb2RlU3RyaW5nIEEgc3RyaW5nIHRvIGV2YWx1YXRlIGludG8gd29ya2VyIGNvZGUuCgkqCUBwYXJhbSB7RmFsbGJhY2tXb3JrZXJ9IHBhcmVudCBUaGUgRmFsbGJhY2tXb3JrZXIgdGhhdCBvd25zIHRoaXMgU3ViV29ya2VyLgoJKi8KCXZhciBTdWJXb3JrZXIgPSBmdW5jdGlvbihjb2RlU3RyaW5nLCBwYXJlbnQpCgl7CgkJdGhpcy5fd1BhcmVudCA9IHBhcmVudDsKCQlldmFsKGNvZGVTdHJpbmcpOyAvLyBqc2hpbnQgaWdub3JlOmxpbmUKCX07CgoJdmFyIHAgPSBTdWJXb3JrZXIucHJvdG90eXBlOwoKCS8qKgoJKglzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dvcmtlci5vbm1lc3NhZ2UKCSoJQHByb3BlcnR5IHtGdW5jdGlvbn0gb25tZXNzYWdlCgkqLwoJcC5vbm1lc3NhZ2UgPSBudWxsOwoKCS8qKgoJKglUaGUgRmFsbGJhY2tXb3JrZXIgdGhhdCBpcyBjb250cm9sbHMgYnkgdGhpcyBTdWJXb3JrZXIuCgkqCUBwcm9wZXJ0eSB7RmFsbGJhY2tXb3JrZXJ9IF93UGFyZW50CgkqCUBwcml2YXRlCgkqLwoJcC5fd1BhcmVudCA9IG51bGw7CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLnBvc3RNZXNzYWdlCgkqCUBtZXRob2QgcG9zdE1lc3NhZ2UKCSoJQHBhcmFtIHsqfSBkYXRhIFRoZSBkYXRhIHRvIHNlbmQuCgkqLwoJcC5wb3N0TWVzc2FnZSA9IGZ1bmN0aW9uKGRhdGEpCgl7CgkJdmFyIHBhcmVudCA9IHRoaXMuX3dQYXJlbnQ7CgkJc2V0VGltZW91dChwYXJlbnQub25tZXNzYWdlLmJpbmQocGFyZW50LCB7ZGF0YTpkYXRhfSksIDEpOwoJfTsKCQoJLyoqCgkqCUFuIGludGVybmFsIGNsYXNzIHRoYXQgZHVwbGljYXRlcyB0aGUgV29ya2VyIEFQSSBhcyBhIGZhbGxiYWNrIHdoZW4gV2ViV29ya2VycyBhcmUgbm90IHN1cHBvcnRlZC4KCSoJQGNsYXNzIEZhbGxiYWNrV29ya2VyCgkqCUBjb25zdHJ1Y3RvcgoJKglAcGFyYW0ge1N0cmluZ30gY29kZVN0cmluZyBBIHN0cmluZyB0byBldmFsdWF0ZSBpbnRvIHdvcmtlciBjb2RlLgoJKi8KCXZhciBGYWxsYmFja1dvcmtlciA9IGZ1bmN0aW9uKGNvZGVTdHJpbmcpCgl7CgkJdGhpcy5fd0NoaWxkID0gbmV3IFN1Yldvcmtlcihjb2RlU3RyaW5nLCB0aGlzKTsKCX07CgoJcCA9IEZhbGxiYWNrV29ya2VyLnByb3RvdHlwZTsKCgkvKioKCSoJU2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9Xb3JrZXIucG9zdE1lc3NhZ2UKCSoJQG1ldGhvZCBwb3N0TWVzc2FnZQoJKglAcGFyYW0geyp9IGRhdGEgVGhlIGRhdGEgdG8gc2VuZC4KCSovCglwLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24oZGF0YSkKCXsKCQl2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CgkJc2V0VGltZW91dChjaGlsZC5vbm1lc3NhZ2UuYmluZChjaGlsZCwge2RhdGE6ZGF0YX0pLCAxKTsKCX07CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLnRlcm1pbmF0ZQoJKglAbWV0aG9kIHRlcm1pbmF0ZQoJKi8KCXAudGVybWluYXRlID0gZnVuY3Rpb24oKQoJewoJCXRoaXMub25tZXNzYWdlID0gbnVsbDsKCQl2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CgkJY2hpbGQuX3dQYXJlbnQgPSBudWxsOwoJCWNoaWxkLm9ubWVzc2FnZSA9IG51bGw7CgkJdGhpcy5fd0NoaWxkID0gbnVsbDsKCX07CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLm9ubWVzc2FnZQoJKglAcHJvcGVydHkge0Z1bmN0aW9ufSBvbm1lc3NhZ2UKCSovCglwLm9ubWVzc2FnZSA9IG51bGw7CgkKCS8qKgoJKglUaGUgU3ViV29ya2VyIHRoYXQgaXMgY29udHJvbGxlZCBieSB0aGlzIEZhbGxiYWNrV29ya2VyLgoJKglAcHJvcGVydHkge1N1Yldvcmtlcn0gX3dDaGlsZAoJKglAcHJpdmF0ZQoJKi8KCXAuX3dDaGlsZCA9IG51bGw7CgkKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCkgewoJCgkidXNlIHN0cmljdCI7CgoJLyoqCgkqICBBIGZ1bmN0aW9uIHRoYXQgaXMgdXNlZCBhcyBhIG5vcm1hbCBjYWxsYmFjaywgYnV0IGNoZWNrcyBhbiBvYmplY3QgZm9yIGEgcHJvcGVydHkgaW4gb3JkZXIgdG8gY29tYmluZSB0d28KCSogIGNhbGxiYWNrcyBpbnRvIG9uZS4gRm9yIGV4YW1wbGUgdXNhZ2U6CgkqCgkqICB2YXIgdm9QbGF5ZXIgPSBuZXcgY2xvdWRraWQuVk9QbGF5ZXIoKTsKCSogIHZhciBjYWxsYmFjayA9IGNsb3Vka2lkLkNvbWJpbmVkQ2FsbGJhY2suY3JlYXRlKG15RnVuYy5iaW5kKHRoaXMpLCB2b1BsYXllciwgInBsYXlpbmciLCAiX2NhbGxiYWNrIik7CgkqICBBbmltYXRvci5wbGF5KG15Q2xpcCwgIm15QW5pbSIsIGNhbGxiYWNrKTsKCSogIAoJKiAgSW4gdGhpcyBleGFtcGxlLCB3aGVuIEFuaW1hdG9yIGNhbGxzICdjYWxsYmFjaycsIGlmIHZvUGxheWVyWyJwbGF5aW5nIl0gaXMgZmFsc2UsICdteUZ1bmMnIGlzIGNhbGxlZCBpbW1lZGlhdGVseS4KCSogIElmIHZvUGxheWVyWyJwbGF5aW5nIl0gaXMgdHJ1ZSwgdGhlbiB2b1BsYXllclsiX2NhbGxiYWNrIl0gaXMgc2V0IHRvICdteUZ1bmMnIHNvIHRoYXQgaXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB2b1BsYXllciBjb21wbGV0ZXMuCgkqICAKCSogIEBjbGFzcyBDb21iaW5lZENhbGxiYWNrCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGwgVGhlIGNhbGxiYWNrIHRvIGNhbGwgd2hlbiBldmVyeXRoaW5nIGlzIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHsqfSBvYmogVGhlIG9iamVjdCB0byBjaGVjayBhcyBhbiBhZGRpdGlvbmFsIGNvbXBsZXRpb24gZGVwZW5kZW5jeS4KCSogIEBwYXJhbSB7U3RyaW5nfSBwcm9wIFRoZSBwcm9wZXJ0eSB0byBjaGVjayBvbiBvYmouIElmIG9ialtwcm9wXSBpcyBmYWxzZSwgdGhlbiBpdCBpcyBjb25zaWRlcmVkIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHtTdHJpbmd9IGNhbGxQcm9wIFRoZSBwcm9wZXJ0eSB0byBzZXQgb24gb2JqIGlmIG9ialtwcm9wXSBpcyB0cnVlIHdoZW4gdGhlIENvbWJpbmVkQ2FsbGJhY2sgaXMgY2FsbGVkLgoJKi8KCXZhciBDb21iaW5lZENhbGxiYWNrID0gZnVuY3Rpb24oY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCkKCXsKCQlpZighb2JqW3Byb3BdKS8vYWNjZXB0IGFueXRoaW5nIHRoYXQgcmVzb2x2ZXMgdG8gZmFsc2U6IGVnIHZvUGxheWVyLnBsYXlpbmcgPT0gZmFsc2UKCQkJY2FsbCgpOwoJCWVsc2UKCQkJb2JqW2NhbGxQcm9wXSA9IGNhbGw7Cgl9OwoKCS8qKgoJKiAgQ3JlYXRlcyBhIENvbWJpbmVkQ2FsbGJhY2sgZm9yIHVzZS4KCSogIAoJKiAgQG1ldGhvZCBjcmVhdGUKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGwgVGhlIGNhbGxiYWNrIHRvIGNhbGwgd2hlbiBldmVyeXRoaW5nIGlzIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHsqfSBvYmogVGhlIG9iamVjdCB0byBjaGVjayBhcyBhbiBhZGRpdGlvbmFsIGNvbXBsZXRpb24gZGVwZW5kZW5jeS4KCSogIEBwYXJhbSB7U3RyaW5nfSBwcm9wIFRoZSBwcm9wZXJ0eSB0byBjaGVjayBvbiBvYmouIElmIG9ialtwcm9wXSBpcyBmYWxzZSwgdGhlbiBpdCBpcyBjb25zaWRlcmVkIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHtTdHJpbmd9IGNhbGxQcm9wIFRoZSBwcm9wZXJ0eSB0byBzZXQgb24gb2JqIGlmIG9ialtwcm9wXSBpcyB0cnVlIHdoZW4gdGhlIENvbWJpbmVkQ2FsbGJhY2sgaXMgY2FsbGVkLgoJKi8KCUNvbWJpbmVkQ2FsbGJhY2suY3JlYXRlID0gZnVuY3Rpb24oY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCkKCXsKCQlyZXR1cm4gQ29tYmluZWRDYWxsYmFjay5iaW5kKHRoaXMsIGNhbGwsIG9iaiwgcHJvcCwgY2FsbFByb3ApOwoJfTsKCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuQ29tYmluZWRDYWxsYmFjayA9IENvbWJpbmVkQ2FsbGJhY2s7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkidXNlIHN0cmljdCI7CgoJdmFyIE5FWFRfSUQgPSAwOwoKCS8qKgoJKiAgQSBjbGFzcyBmb3IgZGVsYXlpbmcgYSBjYWxsIHRocm91Z2ggdGhlIE9TLCBpbnN0ZWFkIG9mIHJlbHlpbmcgb24gc2V0SW50ZXJ2YWwoKSBvciBzZXRUaW1lb3V0KCkuCgkqIAoJKiAgQGNsYXNzIERlbGF5ZWRDYWxsCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGRlbGF5IGhhcyBjb21wbGV0ZWQuCgkqICBAcGFyYW0ge2ludH0gZGVsYXkgVGhlIHRpbWUgdG8gZGVsYXkgdGhlIGNhbGwsIGluIG1pbGxpc2Vjb25kcy4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gcmVwZWF0PWZhbHNlIElmIHRoZSBEZWxheWVkQ2FsbCBzaG91bGQgYXV0b21hdGljYWxseSByZXBlYXQgaXRzZWxmIHdoZW4gY29tcGxldGVkLgoJKiAgQHBhcmFtIHtCb29sZWFufSBhdXRvRGVzdHJveT10cnVlIElmIHRoZSBEZWxheWVkQ2FsbCBzaG91bGQgY2xlYW4gaXRzZWxmIHVwIHdoZW4gY29tcGxldGVkLgoJKi8KCXZhciBEZWxheWVkQ2FsbCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZWxheSwgcmVwZWF0LCBhdXRvRGVzdHJveSkKCXsKCQkvKioKCQkqICBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBkZWxheSBpcyBjb21wbGV0ZWQuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBfY2FsbGJhY2sKCQkqLwoJCXRoaXMuX2NhbGxiYWNrID0gY2FsbGJhY2s7CgkJLyoqCgkJKiAgVGhlIGRlbGF5IHRpbWUsIGluIG1pbGxpc2Vjb25kcy4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7aW50fSBfZGVsYXkKCQkqLwoJCXRoaXMuX2RlbGF5ID0gZGVsYXk7CgkJLyoqCgkJKiAgVGhlIHRpbWVyIGNvdW50aW5nIGRvd24gZnJvbSBfZGVsYXksIGluIG1pbGxpc2Vjb25kcy4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7aW50fSBfdGltZXIKCQkqLwoJCXRoaXMuX3RpbWVyID0gZGVsYXk7CgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCByZXBlYXQgaXRzZWxmIGF1dG9tYXRpY2FsbHkuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9yZXBlYXQKCQkqICBAZGVmYXVsdCBmYWxzZQoJCSovCgkJdGhpcy5fcmVwZWF0ID0gISFyZXBlYXQ7CgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCBkZXN0cm95IGl0c2VsZiBhZnRlciBjb21wbGV0aW5nCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9hdXRvRGVzdHJveQoJCSogIEBkZWZhdWx0IHRydWUKCQkqLwoJCXRoaXMuX2F1dG9EZXN0cm95ID0gYXV0b0Rlc3Ryb3kgPT09IHVuZGVmaW5lZCA/IHRydWUgOiAhIWF1dG9EZXN0cm95OwoJCS8qKgoJCSogIFRoZSB1bmlxdWUgSUQgdXNlZCBmb3IgdGhlIHVwZGF0ZSBjYWxsYmFjayBmb3IgdGhlIE9TLgoJCSogIEBwcml2YXRlCgkJKiAgQHByb3BlcnR5IHtTdHJpbmd9IF91cGRhdGVJZAoJCSovCgkJdGhpcy5fdXBkYXRlSWQgPSAiRGVsYXllZENhbGwjIiArICgrK05FWFRfSUQpOwoJCS8qKgoJCSogIElmIHRoZSBEZWxheWVkQ2FsbCBpcyBjdXJyZW50bHkgcGF1c2VkIChub3Qgc3RvcHBlZCkuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9wYXVzZWQKCQkqLwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoKCQkvL3NhdmUgYSBib3VuZCB2ZXJzaW9uIG9mIHRoZSB1cGRhdGUgZnVuY3Rpb24KCQl0aGlzLl91cGRhdGUgPSB0aGlzLl91cGRhdGUuYmluZCh0aGlzKTsKCQkvL3N0YXJ0IHRoZSBkZWxheQoJCWNsb3Vka2lkLk9TLmluc3RhbmNlLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpOwoJfTsKCgl2YXIgcCA9IERlbGF5ZWRDYWxsLnByb3RvdHlwZTsKCgkvKioKCSogIFRoZSBjYWxsYmFjayBzdXBwbGllZCB0byB0aGUgT1MgZm9yIGFuIHVwZGF0ZSBlYWNoIGZyYW1lLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX3VwZGF0ZQoJKiAgQHBhcmFtIHtpbnR9IGVsYXBzZWQgVGhlIHRpbWUgZWxhcHNlZCBzaW5jZSB0aGUgcHJldmlvdXMgZnJhbWUuCgkqLwoJcC5fdXBkYXRlID0gZnVuY3Rpb24oZWxhcHNlZCkKCXsKCQlpZighdGhpcy5fY2FsbGJhY2spCgkJewoJCQl0aGlzLmRlc3Ryb3koKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fdGltZXIgLT0gZWxhcHNlZDsKCQlpZih0aGlzLl90aW1lciA8PSAwKQoJCXsKCQkJdGhpcy5fY2FsbGJhY2soKTsKCQkJaWYodGhpcy5fcmVwZWF0KQoJCQkJdGhpcy5fdGltZXIgKz0gdGhpcy5fZGVsYXk7CgkJCWVsc2UgaWYodGhpcy5fYXV0b0Rlc3Ryb3kpCgkJCQl0aGlzLmRlc3Ryb3koKTsKCQkJZWxzZQoJCQkJY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpOwoJCX0KCX07CgoJLyoqCgkqICBSZXN0YXJ0cyB0aGUgRGVsYXllZENhbGwsIHdoZXRoZXIgaXQgaXMgcnVubmluZyBvciBub3QuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc3RhcnQKCSovCglwLnJlc3RhcnQgPSBmdW5jdGlvbigpCgl7CgkJaWYoIXRoaXMuX2NhbGxiYWNrKSByZXR1cm47CgkJdmFyIG9zID0gY2xvdWRraWQuT1MuaW5zdGFuY2U7CgkJLy9jYW4ndCBhZGQgZHVwbGljYXRlcwoJCW9zLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpOwoJCXRoaXMuX3RpbWVyID0gdGhpcy5fZGVsYXk7CgkJdGhpcy5fcGF1c2VkID0gZmFsc2U7Cgl9OwoKCS8qKgoJKiAgU3RvcHMgdGhlIERlbGF5ZWRDYWxsLCB3aXRob3V0IGRlc3Ryb3lpbmcgaXQuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHN0b3AKCSovCglwLnN0b3AgPSBmdW5jdGlvbigpCgl7CgkJY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpOwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJfTsKCgkvKioKCSogIElmIHRoZSBEZWxheWVkQ2FsbCBpcyBwYXVzZWQgb3Igbm90LgoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBwYXVzZWQKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInBhdXNlZCIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5fcGF1c2VkOyB9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQlpZighdGhpcy5fY2FsbGJhY2spIHJldHVybjsKCQkJdmFyIG9zID0gY2xvdWRraWQuT1MuaW5zdGFuY2U7CgkJCWlmKHRoaXMuX3BhdXNlZCAmJiAhdmFsdWUpCgkJCXsKCQkJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJCQkJaWYoIW9zLmhhc1VwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSkKCQkJCQlvcy5hZGRVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCwgdGhpcy5fdXBkYXRlKTsKCQkJfQoJCQllbHNlIGlmKHZhbHVlKQoJCQl7CgkJCQlpZihvcy5oYXNVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCkpCgkJCQl7CgkJCQkJdGhpcy5fcGF1c2VkID0gdHJ1ZTsKCQkJCQlvcy5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCk7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCgkvKioKCSogIFN0b3BzIGFuZCBjbGVhbnMgdXAgdGhlIERlbGF5ZWRDYWxsLiBEbyBub3QgdXNlIGl0IGFmdGVyIGNhbGxpbmcKCSogIGRlc3Ryb3koKS4KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQljbG91ZGtpZC5PUy5pbnN0YW5jZS5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCk7CgkJdGhpcy5fY2FsbGJhY2sgPSBudWxsOwoJfTsKCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuRGVsYXllZENhbGwgPSBEZWxheWVkQ2FsbDsKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCl7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIEFuIGFwcGxpY2F0aW9uIGlzIGFuIGFic3RyYWN0IGNsYXNzIHdoaWNoIGV4dGVuZHMgYGNyZWF0ZWpzLkNvbnRhaW5lcmAKCSogIGFuZCBpcyBtYW5hZ2VkIGJ5IHRoZSBgY2xvdWRraWQuT1NgCgkqCgkqICBAY2xhc3MgQXBwbGljYXRpb24KCSovCgl2YXIgQXBwbGljYXRpb24gPSBmdW5jdGlvbigpCgl7CgkJaWYoZmFsc2UpIAoJCXsKCQkJdGhpcy5pbml0aWFsaXplKCk7CgkJfQkKCQllbHNlIGlmKHRydWUpCgkJewoJCQlQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCh0aGlzKTsKCQl9CQoJfTsKCQoJLy8gU2hvcnRjdXQgcmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUKCXZhciBwOwoJCgkvLyBFeHRlbmRzIHRoZSBjb250YWluZXIKCWlmIChmYWxzZSkKCXsKCQlwID0gQXBwbGljYXRpb24ucHJvdG90eXBlID0gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpOwoJfQoJLy8gRXh0ZW5kcyB0aGUgUElYSSBkaXNwbGF5IG9iamVjdAoJZWxzZSBpZiAodHJ1ZSkKCXsKCQlwID0gQXBwbGljYXRpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKTsKCX0KCQkKCS8qKgoJKiBUaGUgYXBwbGljYXRpb24gaXMgcmVhZHkgdG8gdXNlLCBhZGRlZCB0byBzdGFnZQoJKgoJKiBAcHVibGljCgkqIEBtZXRob2QgaW5pdAoJKi8KCXAuaW5pdCA9IGZ1bmN0aW9uKCl7fTsKCQoJLyoqCgkqICBUaGUgdXBkYXRlZCBmdW5jdGlvbiBjYWxsZWQgYnkgdGhlIE9TCgkqICB0aGlzIGZ1bmN0aW9uIGlzIGltcGxlbWVudGF0aW9uLXNwZWNpZmljCgkqCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHVwZGF0ZQoJKiAgQHBhcmFtIHtpbnR9IGVsYXBzZWQgVGhlIG51bWJlciBvZiBNUyBzaW5jZSB0aGUgbGFzdCBmcmFtZSB1cGRhdGUKCSovCglwLnVwZGF0ZSA9IGZ1bmN0aW9uKGVsYXBzZWQpe307CgkKCS8qKgoJKiBEZXN0cm95IHRoZSBhcHBsaWNhdGlvbiwgZG9uJ3QgdXNlIGFmdGVyIHRoaXMKCSogCgkqIEBwdWJsaWMKCSogQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKXt9OwoJCgkvKioKCSogIFJlc2l6ZSB0aGUgYXBwbGljYXRpb24KCSoKCSogQHB1YmxpYyAKCSogQG1ldGhvZCByZXNpemUKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKCl7fTsKCQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLkFwcGxpY2F0aW9uID0gQXBwbGljYXRpb247Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgoJLyoqCgkqICBSZXByZXNlbnRzIGEgc2luZ2xlIGl0ZW0gaW4gdGhlIGxvYWRlciBxdWV1ZSAKCSoKCSogIEBjbGFzcyBMb2FkZXJRdWV1ZUl0ZW0KCSovCgl2YXIgTG9hZGVyUXVldWVJdGVtID0gZnVuY3Rpb24oKXt9OwoJCgkvKiogUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gTG9hZGVyUXVldWVJdGVtLnByb3RvdHlwZTsKCQoJLyoqIAoJKiBIaWdoZXN0IHByaW9yaXR5CgkqIEBzdGF0aWMKCSogQHB1YmxpYwoJKiBAZmluYWwKCSogQHByb3BlcnR5IHtpbnR9IFBSSU9SSVRZX0hJR0gKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfSElHSCA9IDE7CgkKCS8qKiAKCSogTm9ybWFsIHByaW9yaXR5LCB0aGUgZGVmYXVsdAoJKiBAc3RhdGljCgkqIEBwdWJsaWMKCSogQGZpbmFsCgkqIEBwcm9wZXJ0eSB7aW50fSBQUklPUklUWV9OT1JNQUwKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMID0gMDsKCQoJLyoqIAoJKiBMb3dlc3QgcHJpb3JpdHkKCSogQHN0YXRpYwoJKiBAcHVibGljCgkqIEBmaW5hbAoJKiBAcHJvcGVydHkge2ludH0gUFJJT1JJVFlfTE9XCgkqLwoJTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX0xPVyA9IC0xOwoJCgkvKioKCSogIFRoZSB1cmwgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwKCSovCglwLnVybCA9IG51bGw7CgkKCS8qKgoJKiAgRGF0YSBhc3NvY2lhdGUgd2l0aCB0aGUgbG9hZAoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHsqfSBkYXRhCgkqLwoJcC5kYXRhID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gb2YgdGhlIGxvYWQsIHRvIGNhbGwgd2hlbiAKCSogIHRoZSBsb2FkIGFzIGZpbmlzaGVkLCB0YWtlcyBvbmUgYXJndW1lbnQgYXMgcmVzdWx0CgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBjYWxsYmFjawoJKi8KCXAuY2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogIFRoZSBwcmlvcml0eSBvZiB0aGlzIGl0ZW0KCSogIEBwcm9wZXJ0eSB7aW50fSBwcmlvcml0eQoJKiAgQHB1YmxpYwoJKi8KCXAucHJpb3JpdHkgPSAwOwoJCgkvKioKCSogIFRoZSBhbW91bnQgd2UndmUgbG9hZGVkIHNvIGZhciwgZnJvbSAwIHRvIDEKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBwcm9ncmVzcwoJKi8KCXAucHJvZ3Jlc3MgPSAwOwoJCgkvKioKCSogIFRoZSBwcm9ncmVzcyBjYWxsYmFjawoJKiAgQHB1YmxpYwoJKiAgQHByb3BydHkge2Z1bmN0aW9ufSB1cGRhdGVDYWxsYmFjawoJKi8KCXAudXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoJCglwLl9ib3VuZEZhaWwgPSBudWxsOwoJcC5fYm91bmRQcm9ncmVzcyA9IG51bGw7CglwLl9ib3VuZENvbXBsZXRlID0gbnVsbDsKCQoJLyoqCgkqICBSZXByZXNlbnQgdGhpcyBvYmplY3QgYXMgYSBzdHJpbmcKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgdG9TdHJpbmcKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIG9iamVjdAoJKi8KCXAudG9TdHJpbmcgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuICJbTG9hZGVyUXVldWVJdGVtKHVybDonIit0aGlzLnVybCsiJywgcHJpb3JpdHk6Iit0aGlzLnByaW9yaXR5KyIpXSI7Cgl9OwoJCgkvKioKCSogIERlc3Ryb3kgdGhpcyByZXN1bHQKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLmNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLnVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLmRhdGEgPSBudWxsOwoJCXRoaXMuX2JvdW5kRmFpbCA9IG51bGw7CgkJdGhpcy5fYm91bmRQcm9ncmVzcyA9IG51bGw7CgkJdGhpcy5fYm91bmRDb21wbGV0ZSA9IG51bGw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5Mb2FkZXJRdWV1ZUl0ZW0gPSBMb2FkZXJRdWV1ZUl0ZW07Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgkKCS8qKgoJKiAgVGhlIE1lZGlhbG9hZGVyIGlzIHRoZSBzaW5nbGV0b24gbG9hZGVyIGZvciBsb2FkaW5nIGFsbCBhc3NldHMKCSogIGluY2x1ZGluZyBpbWFnZXMsIGRhdGEsIGNvZGUgYW5kIHNvdW5kcy4gTWVkaWFMb2FkZXIgc3VwcG9ydHMgY2FjaGUtYnVzdGluZwoJKiAgaW4gdGhlIGJyb3dzZXIgdXNpbmcgZHluYW1pYyBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycy4KCSogCgkqICBAY2xhc3MgTWVkaWFMb2FkZXIKCSovCgl2YXIgTWVkaWFMb2FkZXIgPSBmdW5jdGlvbigpe307CgkKCS8qKiBUaGUgcHJvdG90eXBlICovCgl2YXIgcCA9IE1lZGlhTG9hZGVyLnByb3RvdHlwZTsKCQoJLyoqCgkqIFJlZmVyZW5jZSB0byB0aGUgcHJpdmF0ZSBpbnN0YW5jZSBvYmplY3QKCSogQHN0YXRpYwoJKiBAcHJvdGVjdGVkCgkqLwoJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgY29sbGVjdGlvbiBvZiBMb2FkZXJRdWV1ZUl0ZW1zCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBxdWV1ZSA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGNvbGxlY3Rpb24gb2YgTG9hZGVyUXVldWVJdGVtcyBieSB1cmwKCSogIEBwcml2YXRlCgkqLwoJdmFyIHF1ZXVlSXRlbXMgPSBudWxsOwoJCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIGxvYWRlcnMKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge29iamVjdH0gbG9hZGVycwoJKi8KCXZhciBsb2FkZXJzID0gbnVsbDsKCQoJdmFyIHFpUG9vbCA9IG51bGw7Cgl2YXIgbG9hZGVyUG9vbCA9IG51bGw7Cgl2YXIgcmVzdWx0UG9vbCA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGN1cnJlbnQgbnVtYmVyIG9mIGl0ZW1zIGxvYWRpbmcKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2ludH0gbnVtTG9hZHMKCSogIEBkZWZhdWx0IDAKCSovCgl2YXIgbnVtTG9hZHMgPSAwOwoJCgl2YXIgcmV0cmllcyA9IG51bGw7CgkKCS8qKgoJKiAgSWYgd2UgY2FuIGxvYWQKCSogIEBwcml2YXRlCgkqLwoJcC5fY2FuTG9hZCA9IHRydWU7CgkKCS8qKgoJKiAgVGhlIG1heGltdW0gbnVtYmVyIG9mIHNpbXVsYW5lb3VzIGxvYWRzCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2ludH0gbWF4U2ltdWx0YW5lb3VzTG9hZHMKCSogIEBkZWZhdWx0IDIKCSovCglwLm1heFNpbXVsdGFuZW91c0xvYWRzID0gMjsKCQoJLyoqCgkqICBUaGUgcmVmZXJlbmNlIHRvIHRoZSBjYWNoZSBtYW5hZ2VyCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2Nsb3Vka2lkLkNhY2hlTWFuYWdlcn0gY2FjaGVNYW5hZ2VyCgkqLwoJcC5jYWNoZU1hbmFnZXIgPSBudWxsOwoJCgkvKioKCSogIFN0YXRpYyBjb25zdHJ1Y3RvciBjcmVhdGluZyB0aGUgc2luZ2xldG9uCgkqICBAbWV0aG9kIGluaXQKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSovCglNZWRpYUxvYWRlci5pbml0ID0gZnVuY3Rpb24oKQoJewoJCWlmICghTWVkaWFMb2FkZXIuX2luc3RhbmNlKQoJCXsKCQkJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbmV3IE1lZGlhTG9hZGVyKCk7CgkJCU1lZGlhTG9hZGVyLl9pbnN0YW5jZS5faW5pdGlhbGl6ZSgpOwoJCX0KCQlyZXR1cm4gTWVkaWFMb2FkZXIuX2luc3RhbmNlOwoJfTsKCQkKCS8qKgoJKiAgU3RhdGljIGZ1bmN0aW9uIGZvciBnZXR0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2UKCSogIEBzdGF0aWMKCSogIEByZWFkT25seQoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtjbG91ZGtpZC5PU30gaW5zdGFuY2UKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkoTWVkaWFMb2FkZXIsICJpbnN0YW5jZSIsIHsKCQlnZXQ6ZnVuY3Rpb24oKQoJCXsKCQkJaWYgKCFNZWRpYUxvYWRlci5faW5zdGFuY2UpCgkJCXsKCQkJCXRocm93ICdDYWxsIGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluaXQoKSc7CgkJCX0KCQkJcmV0dXJuIE1lZGlhTG9hZGVyLl9pbnN0YW5jZTsKCQl9Cgl9KTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBNZWRpYUxvYWRlciBzaW5nbGV0b24sIGRvbid0IHVzZSBhZnRlciB0aGlzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdmFyIGksIGxlbiwga2V5LCBhcnIgPSB0aGlzLnF1ZXVlOwoJCWlmKGFycikKCQl7CgkJCWZvcihpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA8IGk7ICsraSkKCQkJCWFycltpXS5kZXN0cm95KCk7CgkJCWFyciA9IHFpUG9vbDsKCQkJZm9yKGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpIDwgaTsgKytpKQoJCQkJYXJyW2ldLmRlc3Ryb3koKTsKCQkJYXJyID0gcmVzdWx0UG9vbDsKCQkJZm9yKGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpIDwgaTsgKytpKQoJCQkJYXJyW2ldLmRlc3Ryb3koKTsKCQkJZm9yKGtleSBpbiBsb2FkZXJzKQoJCQl7CgkJCQlxdWV1ZUl0ZW1zW2tleV0uZGVzdHJveSgpOwoJCQkJbG9hZGVyc1trZXldLmNsb3NlKCk7CgkJCX0KCQl9CgkJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbDsKCQlpZiAodGhpcy5jYWNoZU1hbmFnZXIpCgkJCXRoaXMuY2FjaGVNYW5hZ2VyLmRlc3Ryb3koKTsKCQl0aGlzLmNhY2hlTWFuYWdlciA9IG51bGw7CgkJcXVldWUgPSBudWxsOwoJCXJlc3VsdFBvb2wgPSBudWxsOwoJCWxvYWRlclBvb2wgPSBudWxsOwoJCXFpUG9vbCA9IG51bGw7CgkJcXVldWVJdGVtcyA9IG51bGw7CgkJcmV0cmllcyA9IG51bGw7CgkJbG9hZGVycyA9IG51bGw7Cgl9OwoJCgkvKioKCSogIEluaXRpbGl6ZSB0aGUgb2JqZWN0CgkqICBAcHJvdGVjdGVkCgkqICBAbWV0aG9kIF9pbml0aWFsaXplCgkqLwoJcC5faW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkKCXsKCQlxaVBvb2wgPSBbXTsKCQlsb2FkZXJQb29sID0gW107CgkJcmVzdWx0UG9vbCA9IFtdOwoJCXF1ZXVlID0gW107CgkJcXVldWVJdGVtcyA9IHt9OwoJCWxvYWRlcnMgPSB7fTsKCQlyZXRyaWVzID0ge307CgkJdGhpcy5jYWNoZU1hbmFnZXIgPSBuZXcgY2xvdWRraWQuQ2FjaGVNYW5hZ2VyKCk7Cgl9OwoJCgkvKioKCSogIExvYWQgYSBmaWxlIAoJKiAgQG1ldGhvZCBsb2FkCgkqICBAcHVibGljCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSBmaWxlIHBhdGggdG8gbG9hZAoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gY29tcGxldGVkCgkqICBAcGFyYW0ge2Z1bmN0aW9uKn0gdXBkYXRlQ2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZvciBsb2FkIHByb2dyZXNzIHVwZGF0ZSwgcGFzc2VzIDAtMSBhcyBwYXJhbQoJKiAgQHBhcmFtIHtpbnQqfSBwcmlvcml0eSBUaGUgcHJpb3JpdHkgb2YgdGhlIGxvYWQKCSogIEBwYXJhbSB7Kn0gZGF0YSBvcHRpb25hbCBkYXRhCgkqLwoJcC5sb2FkID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgdXBkYXRlQ2FsbGJhY2ssIHByaW9yaXR5LCBkYXRhKQoJewoJCXZhciBxaSA9IHRoaXMuX2dldFFJKCk7CgkJCgkJdmFyIGJhc2VQYXRoID0gY2xvdWRraWQuT1MuaW5zdGFuY2Uub3B0aW9ucy5iYXNlUGF0aDsKCQlpZiAoYmFzZVBhdGggIT09IHVuZGVmaW5lZCAmJiAvXmh0dHAocyk/XDovLnRlc3QodXJsKSA9PT0gZmFsc2UgJiYgdXJsLnNlYXJjaChiYXNlUGF0aCkgPT0gLTEpCgkJewoJCQlxaS5iYXNlUGF0aCA9IGJhc2VQYXRoOwoJCX0KCQkKCQlxaS51cmwgPSB1cmw7CgkJcWkuY2FsbGJhY2sgPSBjYWxsYmFjazsKCQlxaS51cGRhdGVDYWxsYmFjayA9IHVwZGF0ZUNhbGxiYWNrIHx8IG51bGw7CgkJcWkucHJpb3JpdHkgPSBwcmlvcml0eSB8fCBjbG91ZGtpZC5Mb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMOwoJCXFpLmRhdGEgPSBkYXRhIHx8IG51bGw7CgkJCgkJcXVldWUucHVzaChxaSk7CgkJCgkJLy8gU29yeSBieSBwcmlvcml0eQoJCXF1ZXVlLnNvcnQoZnVuY3Rpb24oYSwgYil7CgkJCXJldHVybiBhLnByaW9yaXR5IC0gYi5wcmlvcml0eTsKCQl9KTsKCQkKCQkvLyBUcnkgdG8gbG9hZCB0aGUgbmV4dCBxdWV1ZSBpdGVtCgkJdGhpcy5fdHJ5TmV4dExvYWQoKTsKCX07CgkKCS8qKgoJKiAgVGhlcmUgd2FzIGFuIGVycm9yIGxvYWRpbmcgdGhlIGZpbGUKCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkxvYWRGYWlsZWQKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSovCglwLl9vbkxvYWRGYWlsZWQgPSBmdW5jdGlvbihxaSwgZXZlbnQpCgl7CgkJRGVidWcuZXJyb3IoIlVuYWJsZSB0byBsb2FkIGZpbGU6ICIgKyBxaS51cmwgICsgIiAtIHJlYXNvbjogIiArIGV2ZW50LmVycm9yKTsKCQkKCQl2YXIgbG9hZGVyID0gbG9hZGVyc1txaS51cmxdOwoJCWxvYWRlci5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpOwoJCWxvYWRlci5jbG9zZSgpOwoJCXRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKTsKCQkKCQlkZWxldGUgcXVldWVJdGVtc1txaS51cmxdOwoJCWRlbGV0ZSBsb2FkZXJzW3FpLnVybF07CgkJCgkJaWYocmV0cmllc1txaS51cmxdKQoJCQlyZXRyaWVzW3FpLnVybF0rKzsKCQllbHNlCgkJCXJldHJpZXNbcWkudXJsXSA9IDE7CgkJaWYocmV0cmllc1txaS51cmxdID4gMykKCQkJdGhpcy5fbG9hZERvbmUocWksIG51bGwpOwoJCWVsc2UKCQl7CgkJCW51bUxvYWRzLS07CgkJCXF1ZXVlLnB1c2gocWkpOwoJCQl0aGlzLl90cnlOZXh0TG9hZCgpOwoJCX0KCX07CgkKCS8qKgoJKiAgVGhlIGZpbGUgbG9hZCBwcm9ncmVzcyBldmVudAoJKiAgQG1ldGhvZCBfb25Mb2FkUHJvZ3Jlc3MKCSogIEBwcml2YXRlCgkqICBAcGFyYW0ge2Nsb3Vka2lkLkxvYWRlclF1ZXVlSXRlbX0gcWkgVGhlIGxvYWRlciBxdWV1ZSBpdGVtCgkqICBAcGFyYW0ge29iamVjdH0gZXZlbnQgVGhlIHByb2dyZXNzIGV2ZW50CgkqLwoJcC5fb25Mb2FkUHJvZ3Jlc3MgPSBmdW5jdGlvbihxaSwgZXZlbnQpCgl7CgkJcWkucHJvZ3Jlc3MgPSBldmVudC5wcm9ncmVzczsKCQlpZiAocWkudXBkYXRlQ2FsbGJhY2spewoJCQlxaS51cGRhdGVDYWxsYmFjayhxaS5wcm9ncmVzcyk7CgkJfQkKCX07CgkKCS8qKgoJKiAgVGhlIGZpbGUgd2FzIGxvYWRlZCBzdWNjZXNzZnVsbHkKCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkxvYWRDb21wbGV0ZWQKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSogIEBwYXJhbSB7b2JqZWN0fSBldiBUaGUgbG9hZCBldmVudAoJKi8KCXAuX29uTG9hZENvbXBsZXRlZCA9IGZ1bmN0aW9uKHFpLCBldikKCXsKCQlpZih0cnVlKQoJCXsKCQkJRGVidWcubG9nKCJGaWxlIGxvYWRlZCBzdWNjZXNzZnVsbHkgZnJvbSAiICsgcWkudXJsKTsKCQl9CgkJdmFyIGxvYWRlciA9IGxvYWRlcnNbcWkudXJsXTsKCQlsb2FkZXIucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMoKTsKCQlsb2FkZXIuY2xvc2UoKTsKCQl0aGlzLl9wb29sTG9hZGVyKGxvYWRlcik7CgkJCgkJZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXTsKCQlkZWxldGUgbG9hZGVyc1txaS51cmxdOwoJCXRoaXMuX2xvYWREb25lKHFpLCB0aGlzLl9nZXRSZXN1bHQoZXYucmVzdWx0LCBxaS51cmwsIGxvYWRlcikpOwoJfTsKCQoJLyoqCgkqICBBdHRlbXB0IHRvIGRvIHRoZSBuZXh0IGxvYWQKCSogIEBtZXRob2QgX3RyeU5leHRMb2FkCgkqICBAcHJpdmF0ZQoJKi8KCXAuX3RyeU5leHRMb2FkID0gZnVuY3Rpb24oKQoJewoJCWlmIChudW1Mb2FkcyA+IHRoaXMubWF4U2ltdWx0YW5lb3VzTG9hZHMgLSAxIHx8IHF1ZXVlLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoJCQoJCW51bUxvYWRzKys7CgkJCgkJdmFyIHFpID0gcXVldWUuc2hpZnQoKTsKCQkKCQlpZih0cnVlKQoJCXsKCQkJRGVidWcubG9nKCJBdHRlbXB0aW5nIHRvIGxvYWQgZmlsZSAnIiArIHFpLnVybCArICInIik7CgkJfQoJCQoJCXF1ZXVlSXRlbXNbcWkudXJsXSA9IHFpOwoJCQoJCXZhciBsb2FkZXIgPSB0aGlzLl9nZXRMb2FkZXIocWkuYmFzZVBhdGgpOwoJCQoJCS8vIEFkZCB0byB0aGUgbGlzdCBvZiBsb2FkZXJzCgkJbG9hZGVyc1txaS51cmxdID0gbG9hZGVyOwoJCQoJCWxvYWRlci5hZGRFdmVudExpc3RlbmVyKCJmaWxlbG9hZCIsIHFpLl9ib3VuZENvbXBsZXRlKTsKCQlsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBxaS5fYm91bmRGYWlsKTsKCQlsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZmlsZXByb2dyZXNzIiwgcWkuX2JvdW5kUHJvZ3Jlc3MpOwoJCXZhciB1cmwgPSB0aGlzLmNhY2hlTWFuYWdlci5wcmVwYXJlKHFpLnVybCk7CgkJbG9hZGVyLmxvYWRGaWxlKHFpLmRhdGEgPyB7aWQ6cWkuZGF0YS5pZCwgc3JjOnVybCwgZGF0YTpxaS5kYXRhfSA6IHVybCk7Cgl9OwoJCgkvKioKCSogIEFsZXJ0IHRoYXQgdGhlIGxvYWRpbmcgaXMgZmluaXNoZWQKCSogIEBwcml2YXRlIAoJKiAgQG1ldGhvZCBfbG9hZERvbmUKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSogIEBwYXJhbSB7b2JqZWN0fSByZXN1bHQgVGhlIGV2ZW50IGZyb20gcHJlbG9hZGpzIG9yIG51bGwKCSovCglwLl9sb2FkRG9uZSA9IGZ1bmN0aW9uKHFpLCByZXN1bHQpCgl7CgkJbnVtTG9hZHMtLTsKCQlpZihxaS5kYXRhICYmIHJlc3VsdCkvL2Egd2F5IHRvIGtlZXAgdHJhY2sgb2YgbG9hZCByZXN1bHRzIHdpdGhvdXQgZXhjZXNzaXZlIGZ1bmN0aW9uIGJpbmRpbmcKCQkJcmVzdWx0LmlkID0gcWkuZGF0YS5pZDsKCQlxaS5jYWxsYmFjayhyZXN1bHQpOwoJCS8vcWkuZGVzdHJveSgpOwoJCXRoaXMuX3Bvb2xRSShxaSk7CgkJdGhpcy5fdHJ5TmV4dExvYWQoKTsKCX07CgkKCS8qKgoJKiAgQ2FuY2VsIGEgbG9hZCB0aGF0J3MgY3VycmVudGx5IGluIHByb2dyZXNzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGNhbmNlbAoJKiAgQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgdXJsCgkqICBAcmV0dXJuIHtib29sfSBJZiBjYW5jZWxlZCByZXR1cm5zIHRydWUsIGZhbHNlIGlmIG5vdCBjYW5jZWxlZAoJKi8KCXAuY2FuY2VsID0gZnVuY3Rpb24odXJsKQoJewoJCXZhciBxaSA9IHF1ZXVlSXRlbXNbdXJsXTsKCQl2YXIgbG9hZGVyID0gbG9hZGVyc1t1cmxdOwoJCQoJCWlmIChxaSAmJiBsb2FkZXIpCgkJewoJCQlsb2FkZXIuY2xvc2UoKTsKCQkJZGVsZXRlIGxvYWRlcnNbdXJsXTsKCQkJZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXTsKCQkJbnVtTG9hZHMtLTsKCQkJdGhpcy5fcG9vbExvYWRlcihsb2FkZXIpOwoJCQl0aGlzLl9wb29sUUkocWkpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJCgkJZm9yKGkgPSAwLCBsZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBsZW47IGkrKykKCQl7CgkJCXFpID0gcXVldWVbaV07CgkJCWlmIChxaS51cmwgPT0gdXJsKXsKCQkJCXF1ZXVlLnNwbGljZShpLCAxKTsKCQkJCXRoaXMuX3Bvb2xRSShxaSk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7CQkKCX07CgkKCXAuX2dldFFJID0gZnVuY3Rpb24oKQoJewoJCXZhciBydG47CgkJaWYocWlQb29sLmxlbmd0aCkKCQkJcnRuID0gcWlQb29sLnBvcCgpOwoJCWVsc2UKCQl7CgkJCXJ0biA9IG5ldyBjbG91ZGtpZC5Mb2FkZXJRdWV1ZUl0ZW0oKTsKCQkJcnRuLl9ib3VuZEZhaWwgPSB0aGlzLl9vbkxvYWRGYWlsZWQuYmluZCh0aGlzLCBydG4pOwoJCQlydG4uX2JvdW5kUHJvZ3Jlc3MgPSB0aGlzLl9vbkxvYWRQcm9ncmVzcy5iaW5kKHRoaXMsIHJ0bik7CgkJCXJ0bi5fYm91bmRDb21wbGV0ZSA9IHRoaXMuX29uTG9hZENvbXBsZXRlZC5iaW5kKHRoaXMsIHJ0bik7CgkJfQoJCXJldHVybiBydG47Cgl9OwoJCglwLl9wb29sUUkgPSBmdW5jdGlvbihxaSkKCXsKCQlxaVBvb2wucHVzaChxaSk7CgkJcWkuY2FsbGJhY2sgPSBxaS51cGRhdGVDYWxsYmFjayA9IHFpLmRhdGEgPSBxaS51cmwgPSBudWxsOwoJCXFpLnByb2dyZXNzID0gMDsKCX07CgkKCXAuX2dldExvYWRlciA9IGZ1bmN0aW9uKGJhc2VQYXRoKQoJewoJCXZhciBydG47CgkJaWYobG9hZGVyUG9vbC5sZW5ndGgpCgkJewoJCQlydG4gPSBsb2FkZXJQb29sLnBvcCgpOwoJCQlydG4uX2Jhc2VQYXRoID0gYmFzZVBhdGg7Ly9hcHBhcmVudGx5IHRoZXkgbmVnbGVjdGVkIHRvIG1ha2UgdGhpcyBwdWJsaWMKCQl9CgkJZWxzZQoJCQlydG4gPSBuZXcgY3JlYXRlanMuTG9hZFF1ZXVlKHRydWUsIGJhc2VQYXRoKTsKCQkvL2FsbG93IHRoZSBsb2FkZXIgdG8gaGFuZGxlIHNvdW5kIGFzIHdlbGwKCQlpZihjcmVhdGVqcy5Tb3VuZCkKCQkJcnRuLmluc3RhbGxQbHVnaW4oY3JlYXRlanMuU291bmQpOwoJCXJldHVybiBydG47Cgl9OwoJCglwLl9wb29sTG9hZGVyID0gZnVuY3Rpb24obG9hZGVyKQoJewoJCWxvYWRlci5yZW1vdmVBbGwoKTsvL2NsZWFyIHRoZSBsb2FkZXIgZm9yIHJldXNlCgkJbG9hZGVyUG9vbC5wdXNoKGxvYWRlcik7Cgl9OwoJCglwLl9nZXRSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQsIHVybCwgbG9hZGVyKQoJewoJCXZhciBydG47CgkJaWYocmVzdWx0UG9vbC5sZW5ndGgpCgkJewoJCQlydG4gPSByZXN1bHRQb29sLnBvcCgpOwoJCQlydG4uY29udGVudCA9IHJlc3VsdDsKCQkJcnRuLnVybCA9IHVybDsKCQkJcnRuLmxvYWRlciA9IGxvYWRlcjsKCQl9CgkJZWxzZQoJCQlydG4gPSBuZXcgY2xvdWRraWQuTWVkaWFMb2FkZXJSZXN1bHQocmVzdWx0LCB1cmwsIGxvYWRlcik7CgkJcmV0dXJuIHJ0bjsKCX07CgkKCXAuX3Bvb2xSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQpCgl7CgkJcmVzdWx0LmNvbnRlbnQgPSByZXN1bHQudXJsID0gcmVzdWx0LmxvYWRlciA9IHJlc3VsdC5pZCA9IG51bGw7CgkJcmVzdWx0UG9vbC5wdXNoKHJlc3VsdCk7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuTWVkaWFMb2FkZXIgPSBNZWRpYUxvYWRlcjsKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCl7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIFRoZSByZXR1cm4gcmVzdWx0IG9mIHRoZSBNZWRpYUxvYWRlciBsb2FkCgkqICBAY2xhc3MgTWVkaWFMb2FkZXJSZXN1bHQKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHsqfSBjb250ZW50IFRoZSBkeW5hbWljIGNvbnRlbnQgbG9hZGVkCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdGhhdCB3YXMgbG9hZGVkCgkqICBAcGFyYW0ge2NyZWF0ZWpzLkxvYWRRdWV1ZX0gbG9hZGVyIFRoZSBMb2FkUXVldWUgdGhhdCBwZXJmb3JtZWQgdGhlIGxvYWQKCSovCgl2YXIgTWVkaWFMb2FkZXJSZXN1bHQgPSBmdW5jdGlvbihjb250ZW50LCB1cmwsIGxvYWRlcikKCXsKCQl0aGlzLmNvbnRlbnQgPSBjb250ZW50OwoJCXRoaXMudXJsID0gdXJsOwoJCXRoaXMubG9hZGVyID0gbG9hZGVyOwoJfTsKCQoJLyoqIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlICovCgl2YXIgcCA9IE1lZGlhTG9hZGVyUmVzdWx0LnByb3RvdHlwZTsKCQoJLyoqCgkqICBUaGUgY29udGVudHMgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7Kn0gY29udGVudCAKCSovCglwLmNvbnRlbnQgPSBudWxsOwoJCgkvKioKCSogIFRoZSB1cmwgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwKCSovCglwLnVybCA9IG51bGw7CgkKCS8qKgoJKiAgUmVmZXJlbmNlIHRvIHRoZSBwcmVsb2FkZXIgb2JqZWN0CgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2NyZWF0ZWpzLkxvYWRlclF1ZXVlfSBsb2FkZXIKCSovCglwLmxvYWRlciA9IG51bGw7CgkKCS8qKgoJKiBBIHRvIHN0cmluZyBtZXRob2QKCSogQHB1YmxpYwoJKiBAbWV0aG9kIHRvU3RyaW5nCgkqIEByZXR1cm4ge3N0cmluZ30gQSBzdHJpbmcgcmVwIG9mIHRoZSBvYmplY3QKCSovCglwLnRvU3RyaW5nID0gZnVuY3Rpb24oKQoJewoJCXJldHVybiAiW01lZGlhTG9hZGVyUmVzdWx0KCciK3RoaXMudXJsKyInKV0iOwoJfTsKCQoJLyoqCgkqIERlc3Ryb3kgdGhpcyByZXN1bHQKCSogQHB1YmxpYwoJKiBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5jYWxsYmFjayA9IG51bGw7CgkJdGhpcy51cmwgPSBudWxsOwoJCXRoaXMuY29udGVudCA9IG51bGw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5NZWRpYUxvYWRlclJlc3VsdCA9IE1lZGlhTG9hZGVyUmVzdWx0Owp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24odW5kZWZpbmVkKXsKCQoJInVzZSBzdHJpY3QiOwoJCgkvKioKCSogIFVzZWQgZm9yIG1hbmFnaW5nIHRoZSBicm93c2VyIGNhY2hlIG9mIGxvYWRpbmcgZXh0ZXJuYWwgZWxlbWVudHMKCSogIGNhbiBlYXNpbHkgbG9hZCB2ZXJzaW9uIG1hbmlmZXN0IGFuZCBhcHBseSBpdCB0byB0aGUgbWVkaWEgbG9hZGVyCgkqICBzdXBwb3J0cyBjYWNoZSBidXN0aW5nIGFsbCBtZWRpYSBsb2FkIHJlcXVlc3RzCgkqICB1c2VzIHRoZSBxdWVyeSBzdHJpbmcgdG8gYnVzdCBicm93c2VyIHZlcnNpb25zLgoJKiAKCSogIEBjbGFzcyBDYWNoZU1hbmFnZXIKCSovCgl2YXIgQ2FjaGVNYW5hZ2VyID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuaW5pdGlhbGl6ZSgpOwoJfTsKCQoJLyoqIEVhc3kgYWNjZXNzIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gQ2FjaGVNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwoJCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIHZlcnNpb24gbnVtYmVycwoJKiAgQHByb3RlY3RlZAoJKiAgQHByb3BlcnR5IHtEaWN0aW9uYXJ5fSBfdmVyc2lvbnMKCSovCglwLl92ZXJzaW9ucyA9IG51bGw7CgkKCS8qKgoJKiAgSWYgd2UgYXJlIHN1cHBvc2UgdG8gY2FjaGUgYnVzdCBldmVyeSBmaWxlCgkqICBAcHJvcGVydHkge2Jvb2x9IGNhY2hlQnVzdAoJKiAgQHB1YmxpYwoJKiAgQGRlZmF1bHQgZmFsc2UKCSovCglwLmNhY2hlQnVzdCA9IGZhbHNlOwoJCgkvKioKCSogVGhlIGNvbnN0cnVjdG9yIGZvciB0aGUgQ2FjaGUgbWFuYWdlcgoJKiBAcHVibGljCgkqIEBjb25zdHJ1Y3RvcgoJKiBAbWV0aG9kIGluaXRpYWxpemUKCSovCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5fdmVyc2lvbnMgPSBbXTsKCQkJCQoJCXZhciBjYiA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLm9wdGlvbnMuY2FjaGVCdXN0OwoJCXRoaXMuY2FjaGVCdXN0ID0gY2IgPyAoY2IgPT09ICJ0cnVlIiB8fCBjYiA9PT0gdHJ1ZSkgOiBmYWxzZTsKCQkKCQlpZih0cnVlKQoJCXsKCQkJaWYgKHRoaXMuY2FjaGVCdXN0KSBEZWJ1Zy5sb2coIkNhY2hlQnVzdCBhbGwgZmlsZXMgaXMgb24uIik7CgkJfQoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBjYWNoZSBtYW5hZ2VyLCBkb24ndCB1c2UgYWZ0ZXIgdGhpcwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuX3ZlcnNpb25zID0gbnVsbDsKCX07CgkKCS8qKgoJKiAgQWRkIHRoZSB2ZXJzaW9ucwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBhZGRWZXJzaW9uc0ZpbGUKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCBvZiB0aGUgdmVyc2lvbnMgZmlsZQoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGJhY2sgd2hlbiB0aGUgdXJsIGhhcyBiZWVuIGxhb2RlZAoJKiAgQHBhcmFtIHtzdHJpbmd9IGJhc2VVcmwgQSBiYXNlIHVybCB0byBwcmVwZW5kIGFsbCBsaW5lcyBvZiB0aGUgZmlsZQoJKi8KCXAuYWRkVmVyc2lvbnNGaWxlID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgYmFzZVVybCkKCXsJCQoJCURlYnVnLmFzc2VydCgvXi4qXC50eHQkLy50ZXN0KHVybCksICJUaGUgdmVyc2lvbnMgZmlsZSBtdXN0IGJlIGEgKi50eHQgZmlsZSIpOwoJCQkJCgkJdmFyIG1sID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5zdGFuY2U7CgkJCgkJLy8gSWYgd2UgYWxyZWFkeSBjYWNoZSBidXN0aW5nLCB3ZSBjYW4gaWdub3JlIHRoaXMKCQlpZiAodGhpcy5jYWNoZUJ1c3QpCgkJewoJCQlpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7CgkJCXJldHVybjsKCQl9CgkJCgkJLy8gQWRkIGEgcmFuZG9tIHZlcnNpb24gbnVtYmVyIHRvIG5ldmVyIGNhY2hlIHRoZSB0ZXh0IGZpbGUKCQl0aGlzLmFkZFZlcnNpb24odXJsLCBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkqMTAwMDAwKSk7CgkJCgkJdmFyIGNtID0gdGhpczsKCQkKCQkvLyBMb2FkIHRoZSB2ZXJzaW9uCgkJbWwubG9hZCh1cmwsIAoJCQlmdW5jdGlvbihyZXN1bHQpCgkJCXsJCQkJCgkJCQkvLyBjaGVjayBmb3IgYSB2YWxpZCByZXN1bHQgY29udGVudAoJCQkJaWYgKHJlc3VsdCAmJiByZXN1bHQuY29udGVudCkKCQkJCXsKCQkJCQkvLyBSZW1vdmUgY2FycmFnZSByZXR1cm5zIGFuZCBzcGxpdCBvbiBuZXdsaW5lcwoJCQkJCXZhciBsaW5lcyA9IHJlc3VsdC5jb250ZW50LnJlcGxhY2UoL1xyL2csICcnKS5zcGxpdCgiXG4iKTsKCQkJCQl2YXIgaSwgcGFydHM7CgoJCQkJCS8vIEdvIGxpbmUgYnkgbGluZQoJCQkJCWZvcihpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKQoJCQkJCXsJCgkJCQkJCS8vIENoZWNrIGZvciBhIHZhbGlkIGxpbmUKCQkJCQkJaWYgKCFsaW5lc1tpXSkgY29udGludWU7CgoJCQkJCQkvLyBTcGxpdCBsaW5lcwoJCQkJCQlwYXJ0cyA9IGxpbmVzW2ldLnNwbGl0KCcgJyk7CgoJCQkJCQkvLyBBZGQgdGhlIHBhcnRzCgkJCQkJCWlmIChwYXJ0cy5sZW5ndGggIT0gMikgY29udGludWU7CgoJCQkJCQkvLyBBZGQgdGhlIHZlcnNpb25pbmcKCQkJCQkJY20uYWRkVmVyc2lvbigoYmFzZVVybCB8fCAiIikgKyBwYXJ0c1swXSwgcGFydHNbMV0pOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChjYWxsYmFjaykgY2FsbGJhY2soKTsKCQkJfQoJCSk7Cgl9OwoJCgkvKioKCSogIEFkZCBhIHZlcnNpb24gbnVtYmVyIGZvciBhIGZpbGUKCSogIEBtZXRob2QgYWRkVmVyc2lvbgoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgdXJsIG9mIHRoZSBvYmplY3QKCSogIEBwYXJhbSB7c3RyaW5nfSB2ZXJzaW9uIFZlcnNpb24gbnVtYmVyIG9yIGhhcyBvZiBmaWxlCgkqLwoJcC5hZGRWZXJzaW9uID0gZnVuY3Rpb24odXJsLCB2ZXJzaW9uKQoJewoJCXZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKCQlpZiAoIXZlcikKCQkJdGhpcy5fdmVyc2lvbnMucHVzaCh7J3VybCc6IHVybCwgJ3ZlcnNpb24nOiB2ZXJzaW9ufSk7Cgl9OwoJCgkvKioKCSogIFNlYXJjaCBmb3IgYSB2ZXJzaW9uIG51bWJlciBieSB1cmwKCSogIEBtZXRob2QgX2dldFZlcnNpb25CeVVybAoJKiAgQHByaXZhdGUKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCB0byBzZWFyY2gKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIHZlcnNpb24gbnVtYmVyIGFzIGEgc3RyaW5nIG9yIG51bGwKCSovCglwLl9nZXRWZXJzaW9uQnlVcmwgPSBmdW5jdGlvbih1cmwpCgl7CgkJdmFyIGksIGxlbiA9IHRoaXMuX3ZlcnNpb25zLmxlbmd0aDsKCQlmb3IoaSA9IDA7IGkgPCBsZW47IGkrKykKCQl7CgkJCWlmICh1cmwgPT0gdGhpcy5fdmVyc2lvbnNbaV0udXJsKQoJCQl7CgkJCQlyZXR1cm4gdGhpcy5fdmVyc2lvbnNbaV07CgkJCX0KCQl9CgkJcmV0dXJuIG51bGw7Cgl9OwoJCgkvKioKCSogIFByZXBhcmUgYSBVUkwgd2l0aCB0aGUgbmVjZXNzYXJ5IGNhY2hlIGJ1c3RpbmcgYW5kL29yIHZlcnNpb25pbmcKCSogIGFzIHdlbGwgYXMgdGhlIGJhc2UgZGlyZWN0b3J5cgoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBwcmVwYXJlCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdG8gcHJlcGFyZQoJKiAgQHBhcmFtIHtib29sfSBhcHBseUJhc2VQYXRoIElmIHRoZSBnbG9iYWwgYmFzZSBwYXRoIHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSB1cmwuIFRoaXMgZGVmYXVsdHMgdG8gZmFsc2UgYmVjYXVzZSBpdCBjYW4gCgkqCQkJCQkJCQlwb3RlbnRpYWxseSBpbnRlcmZlcmUgd2l0aCBsYXRlciByZWd1bGFyIGV4cHJlc3Npb24gY2hlY2tzLCBwYXJ0aWN1bGFybHkgd2l0aCBQcmVsb2FkSlMKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIGZpbmFsIHVybCB3aXRoIHZlcnNpb24vY2FjaGUgYW5kIGJhc2VQYXRoIGFkZGVkCgkqLwoJcC5wcmVwYXJlID0gZnVuY3Rpb24odXJsLCBhcHBseUJhc2VQYXRoKQoJewoJCXZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKCQkKCQlpZiAodGhpcy5jYWNoZUJ1c3QgJiYgLyhcP3xcJiljYlw9WzAtOV0qLy50ZXN0KHVybCkgPT09IGZhbHNlKQoJCXsKCQkJaWYoIXRoaXMuX2NiVmFsKQoJCQkJdGhpcy5fY2JWYWwgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpOwoJCQl1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgImNiPSIgKyB0aGlzLl9jYlZhbDsKCQl9IAoJCWVsc2UgaWYgKHZlciAmJiAvKFw/fFwmKXZcPVswLTldKi8udGVzdCh1cmwpID09PSBmYWxzZSkKCQl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyAidj0iICsgdmVyLnZlcnNpb247CgkJfQoJCWlmKGFwcGx5QmFzZVBhdGgpCgkJewoJCQl2YXIgYmFzZVBhdGggPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5vcHRpb25zLmJhc2VQYXRoOwoJCQlpZiAoL15odHRwKHMpP1w6Ly50ZXN0KHVybCkgPT09IGZhbHNlICYmIGJhc2VQYXRoICE9PSB1bmRlZmluZWQgJiYgdXJsLnNlYXJjaChiYXNlUGF0aCkgPT0gLTEpCgkJCXsKCQkJCXVybCA9IGJhc2VQYXRoICsgdXJsOwoJCQl9CgkJfQoJCXJldHVybiB1cmw7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuQ2FjaGVNYW5hZ2VyID0gQ2FjaGVNYW5hZ2VyOwoJCn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkidXNlIHN0cmljdCI7CgkKCS8qKgoJKiAgQSBNdWx0aXB1cnBvc2UgYnV0dG9uIGNsYXNzLiBJdCBpcyBkZXNpZ25lZCB0byBoYXZlIG9uZSBpbWFnZSwgYW5kIGFuIG9wdGlvbmFsIHRleHQgbGFiZWwuCgkqICBUaGUgYnV0dG9uIGNhbiBiZSBhIG5vcm1hbCBidXR0b24gb3IgYSBzZWxlY3RhYmxlIGJ1dHRvbi4KCSogIFRoZSBidXR0b24gZnVuY3Rpb25zIHNpbWlsYXJseSB3aXRoIGJvdGggQ3JlYXRlSlMgYW5kIFBJWEksIGJ1dCBzbGlnaHRseSBkaWZmZXJlbnRseSBpbgoJKiAgaW5pdGlhbGl6YXRpb24gYW5kIGNhbGxiYWNrcy4KCSogIFVzZSByZWxlYXNlQ2FsbGJhY2sgYW5kIG92ZXJDYWxsYmFjayB0byBrbm93IGFib3V0IGJ1dHRvbiBjbGlja3MgYW5kIG1vdXNlIG92ZXJzLCByZXNwZWN0aXZlbHkuCgkqICAKCSogIEBjbGFzcyBCdXR0b24gKFBJWEkpCgkqICBAZXh0ZW5kcyBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzXSBJbmZvcm1hdGlvbiBhYm91dCB0aGUgYXJ0IHRvIGJlIHVzZWQgZm9yIGJ1dHRvbiBzdGF0ZXMsIGFzIHdlbGwgYXMgaWYgdGhlIGJ1dHRvbiBpcyBzZWxlY3RhYmxlIG9yIG5vdC4KCSogIEBwYXJhbSB7QXJyYXl9IFtpbWFnZVNldHRpbmdzLnByaW9yaXR5PW51bGxdIFRoZSBzdGF0ZSBwcmlvcml0eSBvcmRlci4gSWYgb21pdHRlZCwgZGVmYXVsdHMgdG8gWyJkaXNhYmxlZCIsICJkb3duIiwgIm92ZXIiLCAidXAiXS4KCSogICAgICAgICBQcmV2aW91cyB2ZXJzaW9ucyBvZiBCdXR0b24gdXNlZCBhIGhhcmQgY29kZWQgb3JkZXI6IFsiaGlnaGxpZ2h0ZWQiLCAiZGlzYWJsZWQiLCAiZG93biIsICJvdmVyIiwgInNlbGVjdGVkIiwgInVwIl0uCgkqICBAcGFyYW0ge09iamVjdHxQSVhJLlRleHR1cmV9IFtpbWFnZVNldHRpbmdzLnVwXSBUaGUgdGV4dHVyZSBmb3IgdGhlIHVwIHN0YXRlIG9mIHRoZSBidXR0b24uIFRoaXMgY2FuIGJlIGVpdGhlciB0aGUgdGV4dHVyZSBpdHNlbGYsCgkqICAgICAgICAgb3IgYW4gb2JqZWN0IHdpdGggJ3RleCcgYW5kICdsYWJlbCcgcHJvcGVydGllcy4KCSogIEBwYXJhbSB7UElYSS5UZXh0dXJlfSBbaW1hZ2VTZXR0aW5ncy51cC50ZXhdIFRoZSBzb3VyY2VSZWN0IGZvciB0aGUgc3RhdGUgd2l0aGluIHRoZSBpbWFnZS4KCSogIEBwYXJhbSB7T2JqZWN0fSBbaW1hZ2VTZXR0aW5ncy51cC5sYWJlbD1udWxsXSBMYWJlbCBpbmZvcm1hdGlvbiBzcGVjaWZpYyB0byB0aGlzIHN0YXRlLiBQcm9wZXJ0aWVzIG9uIHRoaXMgcGFyYW1ldGVyIG92ZXJyaWRlIGRhdGEgCgkqICAgICAgICAgaW4gdGhlIGxhYmVsIHBhcmFtZXRlciBmb3IgdGhpcyBidXR0b24gc3RhdGUgb25seS4gQWxsIHZhbHVlcyBleGNlcHQgInRleHQiIGFuZCAidHlwZSIgZnJvbSB0aGUgbGFiZWwgcGFyYW1ldGVyIG1heSBiZSBvdmVycmlkZGVuLgoJKiAgQHBhcmFtIHtPYmplY3R8UElYSS5UZXh0dXJlfSBbaW1hZ2VTZXR0aW5ncy5vdmVyPW51bGxdIFRoZSB0ZXh0dXJlIGZvciB0aGUgb3ZlciBzdGF0ZSBvZiB0aGUgYnV0dG9uLiBJZiBvbWl0dGVkLCB1c2VzIHRoZSB1cCBzdGF0ZS4KCSogIEBwYXJhbSB7UElYSS5UZXh0dXJlfSBbaW1hZ2VTZXR0aW5ncy5vdmVyLnRleF0gVGhlIHNvdXJjZVJlY3QgZm9yIHRoZSBzdGF0ZSB3aXRoaW4gdGhlIGltYWdlLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzLm92ZXIubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciBvdmVycmlkZSBkYXRhIAoJKiAgICAgICAgIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBhbmQgInR5cGUiIGZyb20gdGhlIGxhYmVsIHBhcmFtZXRlciBtYXkgYmUgb3ZlcnJpZGRlbi4KCSogIEBwYXJhbSB7T2JqZWN0fFBJWEkuVGV4dHVyZX0gW2ltYWdlU2V0dGluZ3MuZG93bj1udWxsXSBUaGUgdGV4dHVyZSBmb3IgdGhlIGRvd24gc3RhdGUgb2YgdGhlIGJ1dHRvbi4gSWYgb21pdHRlZCwgdXNlcyB0aGUgdXAgc3RhdGUuCgkqICBAcGFyYW0ge1BJWEkuVGV4dHVyZX0gW2ltYWdlU2V0dGluZ3MuZG93bi50ZXhdIFRoZSBzb3VyY2VSZWN0IGZvciB0aGUgc3RhdGUgd2l0aGluIHRoZSBpbWFnZS4KCSogIEBwYXJhbSB7T2JqZWN0fSBbaW1hZ2VTZXR0aW5ncy5kb3duLmxhYmVsPW51bGxdIExhYmVsIGluZm9ybWF0aW9uIHNwZWNpZmljIHRvIHRoaXMgc3RhdGUuIFByb3BlcnRpZXMgb24gdGhpcyBwYXJhbWV0ZXIgb3ZlcnJpZGUgZGF0YSAKCSogICAgICAgICBpbiB0aGUgbGFiZWwgcGFyYW1ldGVyIGZvciB0aGlzIGJ1dHRvbiBzdGF0ZSBvbmx5LiBBbGwgdmFsdWVzIGV4Y2VwdCAidGV4dCIgYW5kICJ0eXBlIiBmcm9tIHRoZSBsYWJlbCBwYXJhbWV0ZXIgbWF5IGJlIG92ZXJyaWRkZW4uCgkqICBAcGFyYW0ge09iamVjdHxQSVhJLlRleHR1cmV9IFtpbWFnZVNldHRpbmdzLmRpc2FibGVkPW51bGxdIFRoZSB0ZXh0dXJlIGZvciB0aGUgZGlzYWJsZWQgc3RhdGUgb2YgdGhlIGJ1dHRvbi4gSWYgb21pdHRlZCwgdXNlcyB0aGUgdXAgc3RhdGUuCgkqICBAcGFyYW0ge1BJWEkuVGV4dHVyZX0gW2ltYWdlU2V0dGluZ3MuZGlzYWJsZWQudGV4XSBUaGUgc291cmNlUmVjdCBmb3IgdGhlIHN0YXRlIHdpdGhpbiB0aGUgaW1hZ2UuCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3MuZGlzYWJsZWQubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciBvdmVycmlkZSBkYXRhIAoJKiAgICAgICAgIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBhbmQgInR5cGUiIGZyb20gdGhlIGxhYmVsIHBhcmFtZXRlciBtYXkgYmUgb3ZlcnJpZGRlbi4KCSogIEBwYXJhbSB7T2JqZWN0fFBJWEkuVGV4dHVyZX0gW2ltYWdlU2V0dGluZ3MuPHlvdXJDdXN0b21TdGF0ZT49bnVsbF0gVGhlIHZpc3VhbCBpbmZvcm1hdGlvbiBhYm91dCBhIGN1c3RvbSBzdGF0ZSBmb3VuZCBpbiBpbWFnZVNldHRpbmdzLnByaW9yaXR5LgoJKiAgICAgICAgIEFueSBzdGF0ZSBhZGRlZCB0aGlzIHdheSBoYXMgYSBwcm9wZXJ0eSBvZiB0aGUgc2FtZSBuYW1lIGFkZGVkIHRvIHRoZSBidXR0b24uIEV4YW1wbGVzIG9mIHByZXZpb3VzIHN0YXRlcyB0aGF0IGhhdmUgYmVlbgoJKiAgICAgICAgIG1vdmVkIHRvIHRoaXMgc3lzdGVtIGFyZSAic2VsZWN0ZWQiIGFuZCAiaGlnaGxpZ2h0ZWQiLgoJKiAgQHBhcmFtIHtQSVhJLlRleHR1cmV9IFtpbWFnZVNldHRpbmdzLjx5b3VyQ3VzdG9tU3RhdGU+LnRleF0gVGhlIHRleHR1cmUgZm9yIHRoZSBjdXN0b20gc3RhdGUuCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3MuPHlvdXJDdXN0b21TdGF0ZT4ubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciAKCSogICAgICAgICBvdmVycmlkZSBkYXRhIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBmcm9tIHRoZSBsYWJlbCBwYXJhbWV0ZXIgbWF5IGJlCgkqICAgICAgICAgb3ZlcnJpZGRlbi4KCSogIEBwYXJhbSB7UElYSS5Qb2ludH0gW2ltYWdlU2V0dGluZ3Mub3JpZ2luPW51bGxdIEFuIG9wdGlvbmFsIG9mZnNldCBmb3IgYWxsIGJ1dHRvbiBncmFwaGljcywgaW4gY2FzZSB5b3Ugd2FudCBidXR0b24gCgkqICAgICAgICAgcG9zaXRpb25pbmcgdG8gbm90IGluY2x1ZGUgYSBoaWdobGlnaHQgZ2xvdywgb3IgYW55IG90aGVyIHJlYXNvbiB5b3Ugd291bGQgd2FudCB0byBvZmZzZXQgdGhlIGJ1dHRvbiBhcnQgYW5kIGxhYmVsLgoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtpbWFnZVNldHRpbmdzLnNjYWxlPTFdIFRoZSBzY2FsZSB0byB1c2UgZm9yIHRoZSB0ZXh0dXJlcy4gVGhpcyBhbGxvd3Mgc21hbGxlciBhcnQgYXNzZXRzIHRoYW4gdGhlIGRlc2lnbmVkIHNpemUgdG8gYmUgdXNlZC4KCSogIEBwYXJhbSB7T2JqZWN0fSBbbGFiZWw9bnVsbF0gSW5mb3JtYXRpb24gYWJvdXQgdGhlIHRleHQgbGFiZWwgb24gdGhlIGJ1dHRvbi4gT21pdHRpbmcgdGhpcyBtYWtlcyB0aGUgYnV0dG9uIG5vdCB1c2UgYSBsYWJlbC4KCSogIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWwudHlwZV0gSWYgbGFiZWwudHlwZSBpcyAiYml0bWFwIiwgdGhlbiBhIFBJWEkuQml0bWFwVGV4dCB0ZXh0IGlzIGNyZWF0ZWQsIG90aGVyd2lzZSBhIFBJWEkuVGV4dCBpcyBjcmVhdGVkIGZvciB0aGUgbGFiZWwuCgkqICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsLnRleHRdIFRoZSB0ZXh0IHRvIGRpc3BsYXkgb24gdGhlIGxhYmVsLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtsYWJlbC5zdHlsZV0gVGhlIHN0eWxlIG9mIHRoZSB0ZXh0IGZpZWxkLCBpbiB0aGUgZm9ybWF0IHRoYXQgUElYSS5CaXRtYXBUZXh0IGFuZCBQSVhJLlRleHQgZXhwZWN0LgoJKiAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBbbGFiZWwueD0iY2VudGVyIl0gQW4geCBwb3NpdGlvbiB0byBwbGFjZSB0aGUgbGFiZWwgdGV4dCBhdCByZWxhdGl2ZSB0byB0aGUgYnV0dG9uLgoJKiAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBbbGFiZWwueT0iY2VudGVyIl0gQSB5IHBvc2l0aW9uIHRvIHBsYWNlIHRoZSBsYWJlbCB0ZXh0IGF0IHJlbGF0aXZlIHRvIHRoZSBidXR0b24uIElmIG9taXR0ZWQsCgkqICAgICAgICAgImNlbnRlciIgaXMgdXNlZCwgd2hpY2ggYXR0ZW1wdHMgdG8gdmVydGljYWxseSBjZW50ZXIgdGhlIGxhYmVsIG9uIHRoZSBidXR0b24uCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtlbmFibGVkPXRydWVdIFdoZXRoZXIgb3Igbm90IHRoZSBidXR0b24gaXMgaW5pdGlhbGx5IGVuYWJsZWQuCgkqLwoJdmFyIEJ1dHRvbiA9IGZ1bmN0aW9uKGltYWdlU2V0dGluZ3MsIGxhYmVsLCBlbmFibGVkKQoJewoJCWlmKCFpbWFnZVNldHRpbmdzKSByZXR1cm47CgkJUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwodGhpcyk7CgkJdGhpcy5pbml0aWFsaXplKGltYWdlU2V0dGluZ3MsIGxhYmVsLCBlbmFibGVkKTsKCX07CgkKCS8vIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlCgl2YXIgcCA9IEJ1dHRvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUpOwoJCgkvKgoJKiAgVGhlIHNwcml0ZSB0aGF0IGlzIHRoZSBib2R5IG9mIHRoZSBidXR0b24uCgkqICBUaGUgdHlwZSBvZiB0aGlzIHByb3BlcnR5IGlzIGRlcGVuZGVudCBvbiB3aGljaCB2ZXJzaW9uIG9mIHRoZSBPUyBsaWJyYXJ5IGlzIHVzZWQuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge1BJWEkuU3ByaXRlfSBiYWNrCgkqICBAcmVhZE9ubHkKCSovCglwLmJhY2sgPSBudWxsOwoKCS8qCgkqICBUaGUgdGV4dCBmaWVsZCBvZiB0aGUgYnV0dG9uLiBUaGUgbGFiZWwgaXMgY2VudGVyZWQgYnkgYm90aCB3aWR0aCBhbmQgaGVpZ2h0IG9uIHRoZSBidXR0b24uCgkqICBUaGUgdHlwZSBvZiB0aGlzIHByb3BlcnR5IGlzIGRlcGVuZGVudCBvbiB3aGljaCB2ZXJzaW9uIG9mIHRoZSBPUyBsaWJyYXJ5IGlzIHVzZWQuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge1BJWEkuVGV4dHxQSVhJLkJpdG1hcFRleHR9IGxhYmVsCgkqICBAcmVhZE9ubHkKCSovCglwLmxhYmVsID0gbnVsbDsKCgkvKioKCSogIFRoZSBmdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBjYWxsZWQgd2hlbiB0aGUgYnV0dG9uIGlzIHJlbGVhc2VkLgoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtmdW5jdGlvbn0gcmVsZWFzZUNhbGxiYWNrCgkqLwoJcC5yZWxlYXNlQ2FsbGJhY2sgPSBudWxsOwoKCS8qKgoJKiAgVGhlIGZ1bmN0aW9uIHRoYXQgc2hvdWxkIGJlIGNhbGxlZCB3aGVuIHRoZSBidXR0b24gaXMgbW91c2VkIG92ZXIuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBvdmVyQ2FsbGJhY2sKCSovCglwLm92ZXJDYWxsYmFjayA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGZ1bmN0aW9uIHRoYXQgc2hvdWxkIGJlIGNhbGxlZCB3aGVuIG1vdXNlIGxlYXZlcyB0aGUgYnV0dG9uLgoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtmdW5jdGlvbn0gb3V0Q2FsbGJhY2sKCSovCglwLm91dENhbGxiYWNrID0gbnVsbDsKCgkvKioKCSogQSBkaWN0aW9uYXJ5IG9mIHN0YXRlIGJvb2xlYW5zLCBrZXllZCBieSBzdGF0ZSBuYW1lLgoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge09iamVjdH0gX3N0YXRlRmxhZ3MKCSovCglwLl9zdGF0ZUZsYWdzID0gbnVsbDsKCS8qKgoJKiBBbiBhcnJheSBvZiBzdGF0ZSBuYW1lcyAoU3RyaW5ncyksIGluIHRoZWlyIG9yZGVyIG9mIHByaW9yaXR5LgoJKiBUaGUgc3RhbmRhcmQgb3JkZXIgcHJldmlvdXNseSB3YXMgWyJoaWdobGlnaHRlZCIsICJkaXNhYmxlZCIsICJkb3duIiwgIm92ZXIiLCAic2VsZWN0ZWQiLCAidXAiXS4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtBcnJheX0gX3N0YXRlUHJpb3JpdHkKCSovCglwLl9zdGF0ZVByaW9yaXR5ID0gbnVsbDsKCQoJLyoqCgkqIEEgZGljdGlvbmFyeSBvZiBzdGF0ZSBncmFwaGljIGRhdGEsIGtleWVkIGJ5IHN0YXRlIG5hbWUuCgkqIEVhY2ggb2JqZWN0IGNvbnRhaW5zIHRoZSBzb3VyY2VSZWN0IChzcmMpIGFuZCBvcHRpb25hbGx5ICd0cmltJywgYW5vdGhlciBSZWN0YW5nbGUuCgkqIEFkZGl0aW9uYWxseSwgZWFjaCBvYmplY3Qgd2lsbCBjb250YWluIGEgJ2xhYmVsJyBvYmplY3QgaWYgdGhlIGJ1dHRvbiBoYXMgYSB0ZXh0IGxhYmVsLgoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge09iamVjdH0gX3N0YXRlRGF0YQoJKi8KCXAuX3N0YXRlRGF0YSA9IG51bGw7CgoJLyoqCgkqIFRoZSBjdXJyZW50IHN0eWxlIGZvciB0aGUgbGFiZWwsIHRvIGF2b2lkIHNldHRpbmcgdGhpcyBpZiBpdCBpcyB1bmNoYW5nZWQuCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7T2JqZWN0fSBfY3VycmVudExhYmVsU3R5bGUKCSovCglwLl9jdXJyZW50TGFiZWxTdHlsZSA9IG51bGw7CgoJLyoqCgkqIEFuIG9mZnNldCB0byBidXR0b24gcG9zaXRpb25pbmcsIGdlbmVyYWxseSB1c2VkIHRvIGFkanVzdCBmb3IgYSBoaWdobGlnaHQgYXJvdW5kIHRoZSBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7UElYSS5Qb2ludH0gX29mZnNldAoJKi8KCXAuX29mZnNldCA9IG51bGw7CgkKCS8vPT09Y2FsbGJhY2tzIGZvciBtb3VzZS90b3VjaCBldmVudHMKCS8qCgkqIENhbGxiYWNrIGZvciBtb3VzZSBvdmVyLCBib3VuZCB0byB0aGlzIGJ1dHRvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX292ZXJDQgoJKi8KCXAuX292ZXJDQiA9IG51bGw7CgoJLyoKCSogQ2FsbGJhY2sgZm9yIG1vdXNlIG91dCwgYm91bmQgdG8gdGhpcyBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF9vdXRDQgoJKi8KCXAuX291dENCID0gbnVsbDsKCgkvKgoJKiBDYWxsYmFjayBmb3IgbW91c2UgZG93biwgYm91bmQgdG8gdGhpcyBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF9kb3duQ0IKCSovCglwLl9kb3duQ0IgPSBudWxsOwoKCS8qCgkqIENhbGxiYWNrIGZvciBtb3VzZSB1cCwgYm91bmQgdG8gdGhpcyBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF91cENCCgkqLwoJcC5fdXBDQiA9IG51bGw7CgoJLyoqCgkqIENhbGxiYWNrIGZvciBtb3VzZSB1cCBvdXRzaWRlLCBib3VuZCB0byB0aGlzIGJ1dHRvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX3VwT3V0Q0IKCSovCglwLl91cE91dENCID0gbnVsbDsKCQoJLyoKCSogVGhlIHdpZHRoIG9mIHRoZSBidXR0b24gYXJ0LCBpbmRlcGVuZGVudCBvZiB0aGUgc2NhbGluZyBvZiB0aGUgYnV0dG9uIGl0c2VsZi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtOdW1iZXJ9IF93aWR0aAoJKi8KCXAuX3dpZHRoID0gMDsKCgkvKgoJKiBUaGUgaGVpZ2h0IG9mIHRoZSBidXR0b24gYXJ0LCBpbmRlcGVuZGVudCBvZiB0aGUgc2NhbGluZyBvZiB0aGUgYnV0dG9uIGl0c2VsZi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtOdW1iZXJ9IF9oZWlnaHQKCSovCglwLl9oZWlnaHQgPSAwOwoKCS8qCgkqIEEgbGlzdCBvZiBzdGF0ZSBuYW1lcyB0aGF0IHNob3VsZCBub3QgaGF2ZSBwcm9wZXJ0aWVzIGF1dG9nZW5lcmF0ZWQuCgkqIEBwcml2YXRlCgkqIEBzdGF0aWMKCSogQHByb3BlcnR5IHtBcnJheX0gUkVTRVJWRURfU1RBVEVTCgkqLwoJdmFyIFJFU0VSVkVEX1NUQVRFUyA9IFsiZGlzYWJsZWQiLCAiZW5hYmxlZCIsICJ1cCIsICJvdmVyIiwgImRvd24iXTsKCS8qCgkqIEEgc3RhdGUgcHJpb3JpdHkgbGlzdCB0byB1c2UgYXMgdGhlIGRlZmF1bHQuCgkqIEBwcml2YXRlCgkqIEBzdGF0aWMKCSogQHByb3BlcnR5IHtBcnJheX0gREVGQVVMVF9QUklPUklUWQoJKi8KCXZhciBERUZBVUxUX1BSSU9SSVRZID0gWyJkaXNhYmxlZCIsICJkb3duIiwgIm92ZXIiLCAidXAiXTsKCQoJLyoqIAoJKiAgQ29uc3RydWN0b3IgZm9yIHRoZSBidXR0b24gd2hlbiB1c2luZyBQSVhJLgoJKiAgQG1ldGhvZCBpbml0aWFsaXplCgkqICBAcGFyYW0gIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzXSBJbmZvcm1hdGlvbiBhYm91dCB0aGUgYXJ0IHRvIGJlIHVzZWQgZm9yIGJ1dHRvbiBzdGF0ZXMsIGFzIHdlbGwgYXMgaWYgdGhlIGJ1dHRvbiBpcyBzZWxlY3RhYmxlIG9yIG5vdC4KCSogIEBwYXJhbSB7T2JqZWN0fSBbbGFiZWw9bnVsbF0gSW5mb3JtYXRpb24gYWJvdXQgdGhlIHRleHQgbGFiZWwgb24gdGhlIGJ1dHRvbi4gT21pdHRpbmcgdGhpcyBtYWtlcyB0aGUgYnV0dG9uIG5vdCB1c2UgYSBsYWJlbC4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW2VuYWJsZWQ9dHJ1ZV0gV2hldGhlciBvciBub3QgdGhlIGJ1dHRvbiBpcyBpbml0aWFsbHkgZW5hYmxlZC4KCSovCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbihpbWFnZVNldHRpbmdzLCBsYWJlbCwgZW5hYmxlZCkKCXsKCQl0aGlzLmJhY2sgPSBuZXcgUElYSS5TcHJpdGUoaW1hZ2VTZXR0aW5ncy51cCk7CgkJdGhpcy5hZGRDaGlsZCh0aGlzLmJhY2spOwoJCQoJCXRoaXMuX292ZXJDQiA9IHRoaXMuX29uT3Zlci5iaW5kKHRoaXMpOwoJCXRoaXMuX291dENCID0gdGhpcy5fb25PdXQuYmluZCh0aGlzKTsKCQl0aGlzLl9kb3duQ0IgPSB0aGlzLl9vbkRvd24uYmluZCh0aGlzKTsKCQl0aGlzLl91cENCID0gdGhpcy5fb25VcC5iaW5kKHRoaXMpOwoJCXRoaXMuX3VwT3V0Q0IgPSB0aGlzLl9vblVwT3V0c2lkZS5iaW5kKHRoaXMpOwoKCQl2YXIgX3N0YXRlRGF0YSA9IHRoaXMuX3N0YXRlRGF0YSA9IHt9OwoJCXRoaXMuX3N0YXRlRmxhZ3MgPSB7fTsKCQl0aGlzLl9vZmZzZXQgPSBuZXcgUElYSS5Qb2ludCgpOwoJCQoJCS8vYSBjbG9uZSBvZiB0aGUgbGFiZWwgZGF0YSB0byB1c2UgYXMgYSBkZWZhdWx0IHZhbHVlLCB3aXRob3V0IGNoYW5naW5nIHRoZSBvcmlnaW5hbAoJCXZhciBsYWJlbERhdGE7CgkJaWYobGFiZWwpCgkJewoJCQlsYWJlbERhdGEgPSBjbG9uZShsYWJlbCk7CgkJCWRlbGV0ZSBsYWJlbERhdGEudGV4dDsKCQkJZGVsZXRlIGxhYmVsRGF0YS50eXBlOwoJCQlpZihsYWJlbERhdGEueCA9PT0gdW5kZWZpbmVkKQoJCQkJbGFiZWxEYXRhLnggPSAiY2VudGVyIjsKCQkJaWYobGFiZWxEYXRhLnkgPT09IHVuZGVmaW5lZCkKCQkJCWxhYmVsRGF0YS55ID0gImNlbnRlciI7CgkJCS8vY2xvbmUgdGhlIHN0eWxlIG9iamVjdCBhbmQgc2V0IHVwIHRoZSBkZWZhdWx0cyBmcm9tIFBJWEkuVGV4dCBvciBQSVhJLkJpdG1hcFRleHQKCQkJdmFyIHN0eWxlID0gbGFiZWxEYXRhLnN0eWxlID0gY2xvbmUobGFiZWwuc3R5bGUpOwoJCQlpZihsYWJlbC50eXBlID09ICJiaXRtYXAiKQoJCQl7CgkJCQlzdHlsZS5hbGlnbiA9IHN0eWxlLmFsaWduIHx8ICJsZWZ0IjsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXN0eWxlLmZvbnQgPSBzdHlsZS5mb250IHx8ICJib2xkIDIwcHQgQXJpYWwiOwoJCQkJc3R5bGUuZmlsbCA9IHN0eWxlLmZpbGwgfHwgImJsYWNrIjsKCQkJCXN0eWxlLmFsaWduID0gc3R5bGUuYWxpZ24gfHwgImxlZnQiOwoJCQkJc3R5bGUuc3Ryb2tlID0gc3R5bGUuc3Ryb2tlIHx8ICJibGFjayI7CgkJCQlzdHlsZS5zdHJva2VUaGlja25lc3MgPSBzdHlsZS5zdHJva2VUaGlja25lc3MgfHwgMDsKCQkJCXN0eWxlLndvcmRXcmFwID0gc3R5bGUud29yZFdyYXAgfHwgZmFsc2U7CgkJCQlzdHlsZS53b3JkV3JhcFdpZHRoID0gc3R5bGUud29yZFdyYXBXaWR0aCB8fCAxMDA7CgkJCX0KCQl9CgkJCgkJdGhpcy5fc3RhdGVQcmlvcml0eSA9IGltYWdlU2V0dGluZ3MucHJpb3JpdHkgfHwgREVGQVVMVF9QUklPUklUWTsKCQlmb3IodmFyIGkgPSB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKS8vc3RhcnQgYXQgdGhlIGVuZCB0byBzdGFydCBhdCB0aGUgdXAgc3RhdGUKCQl7CgkJCXZhciBzdGF0ZSA9IHRoaXMuX3N0YXRlUHJpb3JpdHlbaV07CgkJCS8vc2V0IHVwIHRoZSBwcm9wZXJ0eSBmb3IgdGhlIHN0YXRlIHNvIGl0IGNhbiBiZSBzZXQgLSB0aGUgZnVuY3Rpb24gd2lsbCBpZ25vcmUgcmVzZXJ2ZWQgc3RhdGVzCgkJCXRoaXMuX2FkZFByb3BlcnR5KHN0YXRlKTsKCQkJLy9zZXQgdGhlIGRlZmF1bHQgdmFsdWUgZm9yIHRoZSBzdGF0ZSBmbGFnCgkJCWlmKHN0YXRlICE9ICJkaXNhYmxlZCIgJiYgc3RhdGUgIT0gInVwIikKCQkJCXRoaXMuX3N0YXRlRmxhZ3Nbc3RhdGVdID0gZmFsc2U7CgkJCXZhciBpbnB1dERhdGEgPSBpbWFnZVNldHRpbmdzW3N0YXRlXTsKCQkJCgkJCWlmKGlucHV0RGF0YSkKCQkJewoJCQkJLy9pZiBpbnB1dERhdGEgaXMgYW4gb2JqZWN0IHdpdGggYSB0ZXggcHJvcGVydHksIHVzZSB0aGF0CgkJCQkvL290aGVyd2lzZSBpdCBpcyBhIHRleHR1cmUgaXRzZWxmCgkJCQlpZihpbnB1dERhdGEudGV4KQoJCQkJCV9zdGF0ZURhdGFbc3RhdGVdID0ge3RleDogaW5wdXREYXRhLnRleH07CgkJCQllbHNlCgkJCQkJX3N0YXRlRGF0YVtzdGF0ZV0gPSB7dGV4OiBpbnB1dERhdGF9OwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJLy9pdCdzIGVzdGFibGlzaGVkIHRoYXQgb3ZlciwgZG93biwgYW5kIHBhcnRpY3VsYXJseSBkaXNhYmxlZCBkZWZhdWx0IHRvIHRoZSB1cCBzdGF0ZQoJCQkJX3N0YXRlRGF0YVtzdGF0ZV0gPSBfc3RhdGVEYXRhLnVwOwoJCQl9CgkJCS8vc2V0IHVwIHRoZSBsYWJlbCBpbmZvIGZvciB0aGlzIHN0YXRlCgkJCWlmKGxhYmVsKQoJCQl7CgkJCQkvL2lmIHRoZXJlIGlzIGFjdHVhbCBsYWJlbCBkYXRhIGZvciB0aGlzIHN0YXRlLCB1c2UgdGhhdAoJCQkJaWYoaW5wdXREYXRhICYmIGlucHV0RGF0YS5sYWJlbCkKCQkJCXsKCQkJCQlpbnB1dERhdGEgPSBpbnB1dERhdGEubGFiZWw7CgkJCQkJdmFyIHN0YXRlTGFiZWwgPSBfc3RhdGVEYXRhW3N0YXRlXS5sYWJlbCA9IHt9OwoJCQkJCXN0YXRlTGFiZWwuc3R5bGUgPSBpbnB1dERhdGEuc3R5bGUgfHwgbGFiZWxEYXRhLnN0eWxlOwoJCQkJCXN0YXRlTGFiZWwueCA9IGlucHV0RGF0YS54IHx8IGxhYmVsRGF0YS54OwoJCQkJCXN0YXRlTGFiZWwueSA9IGlucHV0RGF0YS55IHx8IGxhYmVsRGF0YS55OwoJCQkJfQoJCQkJLy9vdGhlcndpc2UgdXNlIHRoZSBkZWZhdWx0CgkJCQllbHNlCgkJCQkJX3N0YXRlRGF0YVtzdGF0ZV0ubGFiZWwgPSBsYWJlbERhdGE7CgkJCX0KCQl9CgkJLy9lbnN1cmUgdGhhdCBvdXIgcmVxdWlyZWQgc3RhdGVzIGV4aXN0CgkJaWYoIV9zdGF0ZURhdGEudXApCgkJewoJCQlEZWJ1Zy5lcnJvcigiQnV0dG9uIGxhY2tzIGFuIHVwIHN0YXRlISBUaGlzIGlzIGEgc2VyaW91cyBwcm9ibGVtISBJbnB1dCBkYXRhIGZvbGxvd3M6Iik7CgkJCURlYnVnLmVycm9yKGltYWdlU2V0dGluZ3MpOwoJCX0KCQlpZighX3N0YXRlRGF0YS5vdmVyKQoJCQlfc3RhdGVEYXRhLm92ZXIgPSBfc3RhdGVEYXRhLnVwOwoJCWlmKCFfc3RhdGVEYXRhLmRvd24pCgkJCV9zdGF0ZURhdGEuZG93biA9IF9zdGF0ZURhdGEudXA7CgkJaWYoIV9zdGF0ZURhdGEuZGlzYWJsZWQpCgkJCV9zdGF0ZURhdGEuZGlzYWJsZWQgPSBfc3RhdGVEYXRhLnVwOwoJCS8vc2V0IHVwIHRoZSBvZmZzZXQKCQlpZihpbWFnZVNldHRpbmdzLm9mZnNldCkKCQl7CgkJCXRoaXMuX29mZnNldC54ID0gaW1hZ2VTZXR0aW5ncy5vZmZzZXQueDsKCQkJdGhpcy5fb2Zmc2V0LnkgPSBpbWFnZVNldHRpbmdzLm9mZnNldC55OwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLl9vZmZzZXQueCA9IHRoaXMuX29mZnNldC55ID0gMDsKCQl9CgoJCWlmKGltYWdlU2V0dGluZ3Muc2NhbGUpCgkJewoJCQl2YXIgcyA9IGltYWdlU2V0dGluZ3Muc2NhbGUgfHwgMTsKCQkJdGhpcy5iYWNrLnNjYWxlLnggPSB0aGlzLmJhY2suc2NhbGUueSA9IHM7CgkJfQoJCQoJCWlmKGxhYmVsKQoJCXsKCQkJdGhpcy5sYWJlbCA9IGxhYmVsLnR5cGUgPT0gImJpdG1hcCIgPyBuZXcgUElYSS5CaXRtYXBUZXh0KGxhYmVsLnRleHQsIGxhYmVsRGF0YS5zdHlsZSkgOiBuZXcgUElYSS5UZXh0KGxhYmVsLnRleHQsIGxhYmVsRGF0YS5zdHlsZSk7CgkJCXRoaXMuYWRkQ2hpbGQodGhpcy5sYWJlbCk7CgkJfQoKCQl0aGlzLmJhY2sueCA9IHRoaXMuX29mZnNldC54OwoJCXRoaXMuYmFjay55ID0gdGhpcy5fb2Zmc2V0Lnk7CgkJCgkJdGhpcy5fd2lkdGggPSB0aGlzLmJhY2sud2lkdGg7CgkJdGhpcy5faGVpZ2h0ID0gdGhpcy5iYWNrLmhlaWdodDsKCQkKCQl0aGlzLmVuYWJsZWQgPSBlbmFibGVkID09PSB1bmRlZmluZWQgPyB0cnVlIDogISFlbmFibGVkOwoJfTsKCgkvKgoJKiAgQSBzaW1wbGUgZnVuY3Rpb24gZm9yIG1ha2luZyBhIHNoYWxsb3cgY29weSBvZiBhbiBvYmplY3QuCgkqLwoJZnVuY3Rpb24gY2xvbmUob2JqKQoJewoJCWlmICghb2JqIHx8ICJvYmplY3QiICE9IHR5cGVvZiBvYmopIHJldHVybiBudWxsOwoJCXZhciBjb3B5ID0gb2JqLmNvbnN0cnVjdG9yKCk7CgkJZm9yICh2YXIgYXR0ciBpbiBvYmopIHsKCQkJaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShhdHRyKSkgY29weVthdHRyXSA9IG9ialthdHRyXTsKCQl9CgkJcmV0dXJuIGNvcHk7Cgl9CgkKCS8qCgkqICBUaGUgd2lkdGggb2YgdGhlIGJ1dHRvbiwgYmFzZWQgb24gdGhlIHdpZHRoIG9mIGJhY2suIFRoaXMgdmFsdWUgaXMgYWZmZWN0ZWQgYnkgc2NhbGUuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge051bWJlcn0gd2lkdGgKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgIndpZHRoIiwgewoJCWdldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLl93aWR0aCAqIHRoaXMuc2NhbGUueDt9LAoJCXNldDpmdW5jdGlvbih2YWx1ZSl7CgkJCXRoaXMuc2NhbGUueCA9IHZhbHVlIC8gdGhpcy5fd2lkdGg7CgkJfQoJfSk7CgkvKgoJKiAgVGhlIGhlaWdodCBvZiB0aGUgYnV0dG9uLCBiYXNlZCBvbiB0aGUgaGVpZ2h0IG9mIGJhY2suIFRoaXMgdmFsdWUgaXMgYWZmZWN0ZWQgYnkgc2NhbGUuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge051bWJlcn0gaGVpZ2h0CgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJoZWlnaHQiLCB7CgkJZ2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuX2hlaWdodCAqIHRoaXMuc2NhbGUueTt9LAoJCXNldDpmdW5jdGlvbih2YWx1ZSl7CgkJCXRoaXMuc2NhbGUueSA9IHZhbHVlIC8gdGhpcy5faGVpZ2h0OwoJCX0KCX0pOwoJCgkvKgoJKiAgU2V0cyB0aGUgdGV4dCBvZiB0aGUgbGFiZWwuIFRoaXMgZG9lcyBub3RoaW5nIGlmIHRoZSBidXR0b24gd2FzIG5vdCBpbml0aWFsaXplZCB3aXRoIGEgbGFiZWwuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHNldFRleHQKCSogIEBwYXJhbSB7U3RyaW5nfSB0ZXh0IFRoZSB0ZXh0IHRvIHNldCB0aGUgbGFiZWwgdG8uCgkqLwoJcC5zZXRUZXh0ID0gZnVuY3Rpb24odGV4dCkKCXsKCQlpZih0aGlzLmxhYmVsKQoJCXsKCQkJdGhpcy5sYWJlbC5zZXRUZXh0KHRleHQpOwoJCQkvL21ha2UgdGhlIHRleHQgdXBkYXRlIHNvIHdlIGNhbiBmaWd1cmUgb3V0IHRoZSBzaXplIGZvciBwb3NpdGlvbmluZwoJCQlpZih0aGlzLmxhYmVsIGluc3RhbmNlb2YgUElYSS5UZXh0KQoJCQl7CgkJCQl0aGlzLmxhYmVsLnVwZGF0ZVRleHQoKTsKCQkJCXRoaXMubGFiZWwuZGlydHkgPSBmYWxzZTsKCQkJfQoJCQllbHNlCgkJCQl0aGlzLmxhYmVsLmZvcmNlVXBkYXRlVGV4dCgpOwoJCQkvL3Bvc2l0aW9uIHRoZSB0ZXh0CgkJCXZhciBkYXRhOwoJCQlmb3IodmFyIGkgPSAwOyBpIDwgdGhpcy5fc3RhdGVQcmlvcml0eS5sZW5ndGg7ICsraSkKCQkJewoJCQkJaWYodGhpcy5fc3RhdGVGbGFnc1t0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXSkKCQkJCXsKCQkJCQlkYXRhID0gdGhpcy5fc3RhdGVEYXRhW3RoaXMuX3N0YXRlUHJpb3JpdHlbaV1dOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCWlmKCFkYXRhKQoJCQkJZGF0YSA9IHRoaXMuX3N0YXRlRGF0YS51cDsKCQkJZGF0YSA9IGRhdGEubGFiZWw7CgkJCWlmKGRhdGEueCA9PSAiY2VudGVyIikKCQkJewoJCQkJdmFyIGJXID0gdGhpcy5iYWNrLndpZHRoLCBsVyA9IHRoaXMubGFiZWwud2lkdGg7CgkJCQlzd2l0Y2godGhpcy5fY3VycmVudExhYmVsU3R5bGUuYWxpZ24pCgkJCQl7CgkJCQkJY2FzZSAiY2VudGVyIjoKCQkJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gYlcgKiAwLjU7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgInJpZ2h0IjoKCQkJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gKGJXIC0gbFcpICogMC41ICsgbFc7CgkJCQkJCWJyZWFrOwoJCQkJCWRlZmF1bHQ6Ly9sZWZ0IG9yIG51bGwgKGRlZmF1bHRzIHRvIGxlZnQpCgkJCQkJCXRoaXMubGFiZWwucG9zaXRpb24ueCA9IChiVyAtIGxXKSAqIDAuNTsKCQkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQkJZWxzZQoJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gZGF0YS54ICsgdGhpcy5fb2Zmc2V0Lng7CgkJCWlmKGRhdGEueSA9PSAiY2VudGVyIikKCQkJewoJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi55ID0gKHRoaXMuYmFjay5oZWlnaHQgLSB0aGlzLmxhYmVsLmhlaWdodCkgKiAwLjU7CgkJCX0KCQkJZWxzZQoJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi55ID0gZGF0YS55ICsgdGhpcy5fb2Zmc2V0Lnk7CgkJfQoJfTsKCQoJLyoKCSogIFdoZXRoZXIgb3Igbm90IHRoZSBidXR0b24gaXMgZW5hYmxlZC4KCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gZW5hYmxlZAoJKiAgQGRlZmF1bHQgdHJ1ZQoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiZW5hYmxlZCIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIXRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQ7IH0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQl7CgkJCXRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQgPSAhdmFsdWU7CgkJCXRoaXMuYnV0dG9uTW9kZSA9IHZhbHVlOwoJCQl0aGlzLmludGVyYWN0aXZlID0gdmFsdWU7CgkJCQoJCQkvL21ha2Ugc3VyZSBpbnRlcmFjdGlvbiBjYWxsYmFja3MgYXJlIHByb3Blcmx5IHNldAoJCQlpZih2YWx1ZSkKCQkJewoJCQkJdGhpcy5tb3VzZWRvd24gPSB0aGlzLnRvdWNoc3RhcnQgPSB0aGlzLl9kb3duQ0I7CgkJCQl0aGlzLm1vdXNlb3ZlciA9IHRoaXMuX292ZXJDQjsKCQkJCXRoaXMubW91c2VvdXQgPSB0aGlzLl9vdXRDQjsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMubW91c2Vkb3duID0gdGhpcy50b3VjaHN0YXJ0ID0gdGhpcy5tb3VzZW92ZXIgPSB0aGlzLm1vdXNlb3V0ID0gbnVsbDsKCQkJCXRoaXMubW91c2V1cCA9IHRoaXMudG91Y2hlbmQgPSB0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSBudWxsOwoJCQkJdGhpcy5fc3RhdGVGbGFncy5kb3duID0gdGhpcy5fc3RhdGVGbGFncy5vdmVyID0gZmFsc2U7CgkJCQkvL2Fsc28gdHVybiBvZmYgcGl4aSB2YWx1ZXMgc28gdGhhdCByZS1lbmFibGluZyBidXR0b24gd29ya3MgcHJvcGVybHkKCQkJCXRoaXMuX19pc092ZXIgPSBmYWxzZTsKCQkJfQoJCQkKCQkJdGhpcy5fdXBkYXRlU3RhdGUoKTsKCQl9Cgl9KTsKCgkvKioKCSogIEFkZHMgYSBwcm9wZXJ0eSB0byB0aGUgYnV0dG9uLiBTZXR0aW5nIHRoZSBwcm9wZXJ0eSBzZXRzIHRoZSB2YWx1ZSBpbgoJKiAgX3N0YXRlRmxhZ3MgYW5kIGNhbGxzIF91cGRhdGVTdGF0ZSgpLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX2FkZFByb3BlcnR5CgkqICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHlOYW1lIFRoZSBwcm9wZXJ0eSBuYW1lIHRvIGFkZCB0byB0aGUgYnV0dG9uLgoJKi8KCXAuX2FkZFByb3BlcnR5ID0gZnVuY3Rpb24ocHJvcGVydHlOYW1lKQoJewoJCS8vY2hlY2sgdG8gbWFrZSBzdXJlIHdlIGRvbid0IGFkZCByZXNlcnZlZCBuYW1lcwoJCWlmKFJFU0VSVkVEX1NUQVRFUy5pbmRleE9mKHByb3BlcnR5TmFtZSkgPj0gMCkgcmV0dXJuOwoJCQoJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHsKCQkJZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuX3N0YXRlRmxhZ3NbcHJvcGVydHlOYW1lXTsgfSwKCQkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQkJewoJCQkJdGhpcy5fc3RhdGVGbGFnc1twcm9wZXJ0eU5hbWVdID0gdmFsdWU7CgkJCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJCQl9CgkJfSk7Cgl9OwoJCgkvKgoJKiAgVXBkYXRlcyBiYWNrIGJhc2VkIG9uIHRoZSBjdXJyZW50IGJ1dHRvbiBzdGF0ZS4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF91cGRhdGVTdGF0ZQoJKi8KCXAuX3VwZGF0ZVN0YXRlID0gZnVuY3Rpb24oKQoJewoJCWlmKCF0aGlzLmJhY2spIHJldHVybjsKCgkJdmFyIGRhdGE7CgkJLy91c2UgdGhlIGhpZ2hlc3QgcHJpb3JpdHkgc3RhdGUKCQlmb3IodmFyIGkgPSAwOyBpIDwgdGhpcy5fc3RhdGVQcmlvcml0eS5sZW5ndGg7ICsraSkKCQl7CgkJCWlmKHRoaXMuX3N0YXRlRmxhZ3NbdGhpcy5fc3RhdGVQcmlvcml0eVtpXV0pCgkJCXsKCQkJCWRhdGEgPSB0aGlzLl9zdGF0ZURhdGFbdGhpcy5fc3RhdGVQcmlvcml0eVtpXV07CgkJCQlicmVhazsKCQkJfQoJCX0KCQkvL2lmIG5vIHN0YXRlIGlzIGFjdGl2ZSwgdXNlIHRoZSB1cCBzdGF0ZQoJCWlmKCFkYXRhKQoJCQlkYXRhID0gdGhpcy5fc3RhdGVEYXRhLnVwOwoJCXRoaXMuYmFjay5zZXRUZXh0dXJlKGRhdGEudGV4KTsKCQkvL2lmIHdlIGhhdmUgYSBsYWJlbCwgdXBkYXRlIHRoYXQgdG9vCgkJaWYodGhpcy5sYWJlbCkKCQl7CgkJCWRhdGEgPSBkYXRhLmxhYmVsOwoJCQkvL3VwZGF0ZSB0aGUgdGV4dCBzdHlsZQoJCQlpZighdGhpcy5fY3VycmVudExhYmVsU3R5bGUgfHwgIWRvT2JqZWN0c01hdGNoKHRoaXMuX2N1cnJlbnRMYWJlbFN0eWxlLCBkYXRhLnN0eWxlKSkKCQkJewoJCQkJdGhpcy5sYWJlbC5zZXRTdHlsZShkYXRhLnN0eWxlKTsKCQkJCXRoaXMuX2N1cnJlbnRMYWJlbFN0eWxlID0gZGF0YS5zdHlsZTsKCQkJCS8vbWFrZSB0aGUgdGV4dCB1cGRhdGUgc28gd2UgY2FuIGZpZ3VyZSBvdXQgdGhlIHNpemUgZm9yIHBvc2l0aW9uaW5nCgkJCQlpZih0aGlzLmxhYmVsIGluc3RhbmNlb2YgUElYSS5UZXh0KQoJCQkJewoJCQkJCXRoaXMubGFiZWwudXBkYXRlVGV4dCgpOwoJCQkJCXRoaXMubGFiZWwuZGlydHkgPSBmYWxzZTsKCQkJCX0KCQkJCWVsc2UKCQkJCQl0aGlzLmxhYmVsLmZvcmNlVXBkYXRlVGV4dCgpOwoJCQl9CgkJCS8vcG9zaXRpb24gdGhlIHRleHQKCQkJaWYoZGF0YS54ID09ICJjZW50ZXIiKQoJCQl7CgkJCQl2YXIgYlcgPSB0aGlzLmJhY2sud2lkdGgsIGxXID0gdGhpcy5sYWJlbC53aWR0aDsKCQkJCXN3aXRjaCh0aGlzLl9jdXJyZW50TGFiZWxTdHlsZS5hbGlnbikKCQkJCXsKCQkJCQljYXNlICJjZW50ZXIiOgoJCQkJCQl0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSBiVyAqIDAuNTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAicmlnaHQiOgoJCQkJCQl0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSAoYlcgLSBsVykgKiAwLjUgKyBsVzsKCQkJCQkJYnJlYWs7CgkJCQkJZGVmYXVsdDovL2xlZnQgb3IgbnVsbCAoZGVmYXVsdHMgdG8gbGVmdCkKCQkJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gKGJXIC0gbFcpICogMC41OwoJCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCQllbHNlCgkJCQl0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSBkYXRhLnggKyB0aGlzLl9vZmZzZXQueDsKCQkJaWYoZGF0YS55ID09ICJjZW50ZXIiKQoJCQl7CgkJCQl0aGlzLmxhYmVsLnBvc2l0aW9uLnkgPSAodGhpcy5iYWNrLmhlaWdodCAtIHRoaXMubGFiZWwuaGVpZ2h0KSAqIDAuNTsKCQkJfQoJCQllbHNlCgkJCQl0aGlzLmxhYmVsLnBvc2l0aW9uLnkgPSBkYXRhLnkgKyB0aGlzLl9vZmZzZXQueTsKCQl9Cgl9OwoKCS8qCgkqIEEgc2ltcGxlIGZ1bmN0aW9uIGZvciBjb21wYXJpbmcgdGhlIHByb3BlcnRpZXMgb2YgdHdvIG9iamVjdHMKCSovCglmdW5jdGlvbiBkb09iamVjdHNNYXRjaChvYmoxLCBvYmoyKQoJewoJCWlmKG9iajEgPT09IG9iajIpCgkJCXJldHVybiB0cnVlOwoJCWZvcih2YXIga2V5IGluIG9iajEpCgkJewoJCQlpZihvYmoxW2tleV0gIT0gb2JqMltrZXldKQoJCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0KCQoJLyoqCgkqICBUaGUgY2FsbGJhY2sgZm9yIHdoZW4gdGhlIGJ1dHRvbiBpcyBtb3VzZWQgb3Zlci4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbk92ZXIKCSovCglwLl9vbk92ZXIgPSBmdW5jdGlvbihkYXRhKQoJewoJCXRoaXMuX3N0YXRlRmxhZ3Mub3ZlciA9IHRydWU7CgkJdGhpcy5fdXBkYXRlU3RhdGUoKTsKCQlpZih0aGlzLm92ZXJDYWxsYmFjaykKCQkJdGhpcy5vdmVyQ2FsbGJhY2sodGhpcyk7Cgl9OwoJCgkvKioKCSogIFRoZSBjYWxsYmFjayBmb3Igd2hlbiB0aGUgbW91c2UgbGVhdmVzIHRoZSBidXR0b24gYXJlYS4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbk91dAoJKi8KCXAuX29uT3V0ID0gZnVuY3Rpb24oZGF0YSkKCXsKCQl0aGlzLl9zdGF0ZUZsYWdzLm92ZXIgPSBmYWxzZTsKCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJCWlmKHRoaXMub3V0Q2FsbGJhY2spCgkJCXRoaXMub3V0Q2FsbGJhY2sodGhpcyk7Cgl9OwoJCgkvKioKCSogIFRoZSBjYWxsYmFjayBmb3Igd2hlbiB0aGUgYnV0dG9uIHJlY2VpdmVzIGEgbW91c2UgZG93biBldmVudC4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkRvd24KCSovCglwLl9vbkRvd24gPSBmdW5jdGlvbihkYXRhKQoJewoJCWRhdGEub3JpZ2luYWxFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCXRoaXMuX3N0YXRlRmxhZ3MuZG93biA9IHRydWU7CgkJdGhpcy5fdXBkYXRlU3RhdGUoKTsKCQkKCQl0aGlzLm1vdXNldXAgPSB0aGlzLnRvdWNoZW5kID0gdGhpcy5fdXBDQjsKCQl0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSB0aGlzLl91cE91dENCOwoJfTsKCQoJLyoqCgkqICBUaGUgY2FsbGJhY2sgZm9yIHdoZW4gdGhlIGJ1dHRvbiBmb3Igd2hlbiB0aGUgbW91c2UvdG91Y2ggaXMgcmVsZWFzZWQgb24gdGhlIGJ1dHRvbgoJKiAgLSBvbmx5IHdoZW4gdGhlIGJ1dHRvbiB3YXMgaGVsZCBkb3duIGluaXRpYWxseS4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vblVwCgkqLwoJcC5fb25VcCA9IGZ1bmN0aW9uKGRhdGEpCgl7CgkJZGF0YS5vcmlnaW5hbEV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJdGhpcy5fc3RhdGVGbGFncy5kb3duID0gZmFsc2U7CgkJdGhpcy5tb3VzZXVwID0gdGhpcy50b3VjaGVuZCA9IG51bGw7CgkJdGhpcy5tb3VzZXVwb3V0c2lkZSA9IHRoaXMudG91Y2hlbmRvdXRzaWRlID0gbnVsbDsKCQkKCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJCWlmKHRoaXMucmVsZWFzZUNhbGxiYWNrKQoJCQl0aGlzLnJlbGVhc2VDYWxsYmFjayh0aGlzKTsKCX07CgkKCS8qKgoJKiAgVGhlIGNhbGxiYWNrIGZvciB3aGVuIHRoZSBtb3VzZS90b3VjaCBpcyByZWxlYXNlZCBvdXRzaWRlIHRoZSBidXR0b24gd2hlbiB0aGUgYnV0dG9uIHdhcyBoZWxkIGRvd24uCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfb25VcE91dHNpZGUKCSovCglwLl9vblVwT3V0c2lkZSA9IGZ1bmN0aW9uKGRhdGEpCgl7CgkJdGhpcy5fc3RhdGVGbGFncy5kb3duID0gZmFsc2U7CgkJdGhpcy5tb3VzZXVwID0gdGhpcy50b3VjaGVuZCA9IG51bGw7CgkJdGhpcy5tb3VzZXVwb3V0c2lkZSA9IHRoaXMudG91Y2hlbmRvdXRzaWRlID0gbnVsbDsKCQkKCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJfTsKCQoJLyoKCSogIERlc3Ryb3lzIHRoZSBidXR0b24uCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5tb3VzZWRvd24gPSB0aGlzLnRvdWNoc3RhcnQgPSB0aGlzLm1vdXNlb3ZlciA9IHRoaXMubW91c2VvdXQgPSBudWxsOwoJCXRoaXMubW91c2V1cCA9IHRoaXMudG91Y2hlbmQgPSB0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSBudWxsOwoJCXRoaXMucmVtb3ZlQ2hpbGRyZW4odHJ1ZSk7CgkJdGhpcy5sYWJlbCA9IG51bGw7CgkJdGhpcy5iYWNrID0gbnVsbDsKCQl0aGlzLnJlbGVhc2VDYWxsYmFjayA9IG51bGw7CgkJdGhpcy5vdmVyQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMub3V0Q2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuX3N0YXRlRGF0YSA9IG51bGw7CgkJdGhpcy5fc3RhdGVGbGFncyA9IG51bGw7CgkJdGhpcy5fc3RhdGVQcmlvcml0eSA9IG51bGw7CgkJdGhpcy5fZG93bkNCID0gbnVsbDsKCQl0aGlzLl91cENCID0gbnVsbDsKCQl0aGlzLl9vdmVyQ0IgPSBudWxsOwoJCXRoaXMuX291dENCID0gbnVsbDsKCQl0aGlzLl91cE91dENCID0gbnVsbDsKCX07CgkKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5CdXR0b24gPSBCdXR0b247Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpIHsKCQoJInVzZSBzdHJpY3QiOwoJCgkvKioKCSogIERyYWcgbWFuYWdlciBpcyByZXNwb25zaWJsZSBmb3IgaGFuZGxpbmcgdGhlIGRyYWdnaW5nIG9mIHN0YWdlIGVsZW1lbnRzCgkqICBzdXBwb3J0cyBjbGljay1uLXN0aWNrIGFuZCBjbGljay1uLWRyYWcgZnVuY3Rpb25hbGl0eS4KCSoKCSogIEBjbGFzcyBEcmFnTWFuYWdlciAoUElYSSkKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gc3RhcnRDYWxsYmFjayBUaGUgY2FsbGJhY2sgd2hlbiB3aGVuIHN0YXJ0aW5nCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBlbmRDYWxsYmFjayBUaGUgY2FsbGJhY2sgd2hlbiBlbmRpbmcKCSovCgl2YXIgRHJhZ01hbmFnZXIgPSBmdW5jdGlvbihzdGFydENhbGxiYWNrLCBlbmRDYWxsYmFjaykKCXsKCQl0aGlzLmluaXRpYWxpemUoc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spOwoJfTsKCQoJLyoqIFJlZmVyZW5jZSB0byB0aGUgZHJhZyBtYW5hZ2VyICovCgl2YXIgcCA9IERyYWdNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwoJCgkvKioKCSogVGhlIG9iamVjdCB0aGF0J3MgYmVpbmcgZHJhZ2dlZAoJKiBAcHVibGljCgkqIEByZWFkT25seQoJKiBAcHJvcGVydHkge1BJWEkuRGlzcGxheU9iamVjdH0gZHJhZ2dlZE9iagoJKi8KCXAuZHJhZ2dlZE9iaiA9IG51bGw7CgkKCS8qKgoJKiBUaGUgcmFkaXVzIGluIHBpeGVsIHRvIGFsbG93IGZvciBkcmFnZ2luZywgb3IgZWxzZSBkb2VzIHN0aWNreSBjbGljawoJKiBAcHVibGljCgkqIEBwcm9wZXJ0eSBkcmFnU3RhcnRUaHJlc2hvbGQKCSogQGRlZmF1bHQgMjAKCSovCglwLmRyYWdTdGFydFRocmVzaG9sZCA9IDIwOwoJCgkvKioKCSogVGhlIHBvc2l0aW9uIHgsIHkgb2YgdGhlIG1vdXNlIGRvd24gb24gdGhlIHN0YWdlCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7UElYSS5Qb2ludH0gbW91c2VEb3duU3RhZ2VQb3MKCSovCglwLm1vdXNlRG93blN0YWdlUG9zID0gbnVsbDsKCgkvKioKCSogVGhlIHBvc2l0aW9uIHgsIHkgb2YgdGhlIG9iamVjdCB3aGVuIGludGVyYWN0aW9uIHdpdGggaXQgc3RhcnRlZC4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtQSVhJLlBvaW50fSBtb3VzZURvd25PYmpQb3MKCSovCglwLm1vdXNlRG93bk9ialBvcyA9IG51bGw7CgkKCS8qKgoJKiBJcyB0aGUgbW92ZSB0b3VjaCBiYXNlZAoJKiBAcHVibGljCgkqIEByZWFkT25seQoJKiBAcHJvcGVydHkge0Jvb2x9IGlzVG91Y2hNb3ZlCgkqIEBkZWZhdWx0IGZhbHNlCgkqLwoJcC5pc1RvdWNoTW92ZSA9IGZhbHNlOwoJCgkvKioKCSogSXMgdGhlIGRyYWcgYmVpbmcgaGVsZCBvbiBtb3VzZSBkb3duIChub3Qgc3RpY2t5IGNsaWNraW5nKQoJKiBAcHVibGljCgkqIEByZWFkT25seQoJKiBAcHJvcGVydHkge0Jvb2x9IGlzSGVsZERyYWcKCSogQGRlZmF1bHQgZmFsc2UKCSovCglwLmlzSGVsZERyYWcgPSBmYWxzZTsKCQoJLyoqCgkqIElzIHRoZSBkcmFnIGEgc3RpY2t5IGNsaWNraW5nIChjbGljayBvbiBhIGl0ZW0sIHRoZW4gbW91c2UgdGhlIG1vdXNlKQoJKiBAcHVibGljCgkqIEByZWFkT25seQoJKiBAcHJvcGVydHkge0Jvb2x9IGlzU3RpY2t5Q2xpY2sKCSogQGRlZmF1bHQgZmFsc2UKCSovCglwLmlzU3RpY2t5Q2xpY2sgPSBmYWxzZTsKCQoJLyoqCgkqIElmIHN0aWNreSBjbGljayBkcmFnZ2luZyBpcyBhbGxvd2VkLgoJKiBAcHVibGljCgkqIEBwcm9wZXJ0eSB7Qm9vbH0gYWxsb3dTdGlja3lDbGljawoJKiBAZGVmYXVsdCB0cnVlCgkqLwoJcC5hbGxvd1N0aWNreUNsaWNrID0gdHJ1ZTsKCgkvKioKCSogU2V0dGluZ3MgZm9yIHNuYXBwaW5nLgoJKgoJKiAgRm9ybWF0IGZvciBzbmFwcGluZyB0byBhIGxpc3Qgb2YgcG9pbnRzOgoJKgl7CgkqCQltb2RlOiJwb2ludHMiLAoJKgkJZGlzdDoyMCwvL3NuYXAgd2hlbiB3aXRoaW4gMjAgcGl4ZWxzL3VuaXRzCgkqCQlwb2ludHM6WwoJKgkJCXsgeDogMjAsIHk6MzAgfSwKCSoJCQl7IHg6IDUwLCB5OjEwIH0KCSoJCV0KCSoJfQoJKgoJKiBAcHVibGljCgkqIEBwcm9wZXJ0eSB7T2JqZWN0fSBzbmFwU2V0dGluZ3MKCSogQGRlZmF1bHQgbnVsbAoJKi8KCXAuc25hcFNldHRpbmdzID0gbnVsbDsKCQoJLyoqCgkqIFJlZmVyZW5jZSB0byB0aGUgc3RhZ2UKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtQSVhJLlN0YWdlfSBfdGhlU3RhZ2UKCSovCglwLl90aGVTdGFnZSA9IG51bGw7CgkKCS8qKgoJKiBUaGUgbG9jYWwgdG8gZ2xvYmFsIHBvc2l0aW9uIG9mIHRoZSBkcmFnCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7UElYSS5Qb2ludH0gX2RyYWdPZmZzZXQKCSovCglwLl9kcmFnT2Zmc2V0ID0gbnVsbDsKCQoJLyoqCgkqIEV4dGVybmFsIGNhbGxiYWNrIHdoZW4gd2Ugc3RhcnQgZHJhZ2dpbmcKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX2RyYWdTdGFydENhbGxiYWNrCgkqLwoJcC5fZHJhZ1N0YXJ0Q2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogRXh0ZXJuYWwgY2FsbGJhY2sgd2hlbiB3ZSBhcmUgZG9uZSBkcmFnZ2luZwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBfZHJhZ0VuZENhbGxiYWNrCgkqLwoJcC5fZHJhZ0VuZENhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIENhbGxiYWNrIHRvIHRlc3QgZm9yIHRoZSBzdGFydCBhIGhlbGQgZHJhZwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBfdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2sKCSovCglwLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayA9IG51bGw7CgkKCS8qKgoJKiBDYWxsYmFjayB0byBzdGFydCBhIHN0aWNreSBjbGljayBkcmFnCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjawoJKi8KCXAuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIENhbGxiYWNrIHdoZW4gd2UgYXJlIGRvbmUgd2l0aCB0aGUgZHJhZwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBfc3RhZ2VNb3VzZVVwQ2FsbGJhY2sKCSovCglwLl9zdGFnZU1vdXNlVXBDYWxsYmFjayA9IG51bGw7CgkJCgkvKioKCSogVGhlIGZ1bmN0aW9uIGNhbGwgd2hlbiB0aGUgbW91c2UvdG91Y2ggbW92ZXMKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gX3VwZGF0ZUNhbGxiYWNrIAoJKi8KCXAuX3VwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIFRoZSBjb2xsZWN0aW9uIG9mIGRyYWdnYWJsZSBvYmplY3RzCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7QXJyYXl9IF9kcmFnZ2FibGVPYmplY3RzCgkqLwoJcC5fZHJhZ2dhYmxlT2JqZWN0cyA9IG51bGw7CgkKCXZhciBoZWxwZXJQb2ludCA9IG51bGw7CgkKCXZhciBUWVBFX01PVVNFID0gMDsKCXZhciBUWVBFX1RPVUNIID0gMTsKCQoJLyoqIAoJKiBDb25zdHJ1Y3RvciAKCSogQG1ldGhvZCBpbml0aWFsaXplCgkqIEBwYXJhbSB7ZnVuY3Rpb259IHN0YXJ0Q2FsbGJhY2sgVGhlIGNhbGxiYWNrIHdoZW4gd2hlbiBzdGFydGluZwoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBlbmRDYWxsYmFjayBUaGUgY2FsbGJhY2sgd2hlbiBlbmRpbmcKCSovCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbihzdGFydENhbGxiYWNrLCBlbmRDYWxsYmFjaykKCXsKCQl0aGlzLl91cGRhdGVDYWxsYmFjayA9IHRoaXMuX3VwZGF0ZU9ialBvc2l0aW9uLmJpbmQodGhpcyk7CgkJdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2sgPSB0aGlzLl90cmlnZ2VySGVsZERyYWcuYmluZCh0aGlzKTsKCQl0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayA9IHRoaXMuX3RyaWdnZXJTdGlja3lDbGljay5iaW5kKHRoaXMpOwoJCXRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrID0gdGhpcy5fc3RvcERyYWcuYmluZCh0aGlzKTsKCQl0aGlzLl90aGVTdGFnZSA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLnN0YWdlOwoJCXRoaXMuX2RyYWdTdGFydENhbGxiYWNrID0gc3RhcnRDYWxsYmFjazsKCQl0aGlzLl9kcmFnRW5kQ2FsbGJhY2sgPSBlbmRDYWxsYmFjazsKCQl0aGlzLl9kcmFnZ2FibGVPYmplY3RzID0gW107CgkJdGhpcy5tb3VzZURvd25TdGFnZVBvcyA9IG5ldyBQSVhJLlBvaW50KDAsIDApOwoJCXRoaXMubW91c2VEb3duT2JqUG9zID0gbmV3IFBJWEkuUG9pbnQoMCwgMCk7CgkJaGVscGVyUG9pbnQgPSBuZXcgUElYSS5Qb2ludCgwLCAwKTsKCX07CgkKCS8qKgoJKglNYW51YWxseSBzdGFydHMgZHJhZ2dpbmcgYW4gb2JqZWN0LiBJZiBhIG1vdXNlIGRvd24gZXZlbnQgaXMgbm90IHN1cHBsaWVkIGFzIHRoZSBzZWNvbmQgYXJndW1lbnQsIGl0IAoJKiAgIGRlZmF1bHRzIHRvIGEgaGVsZCBkcmFnLCB0aGF0IGVuZHMgYXMgc29vbiBhcyB0aGUgbW91c2UgaXMgcmVsZWFzZWQuCgkqICBAbWV0aG9kIHN0YXJ0RHJhZwoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtQSVhJLkRpc3BsYXlPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRoYXQgc2hvdWxkIGJlIGRyYWdnZWQuCgkqICBAcGFyYW0ge1BJWEkuSW50ZXJhY3Rpb25EYXRhfSBpbnRlcmFjdGlvbkRhdGEgVGhlIGludGVyYWN0aW9uIGRhdGEgYWJvdXQgdGhlIGlucHV0IGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoaXMuCgkqLwoJcC5zdGFydERyYWcgPSBmdW5jdGlvbihvYmplY3QsIGludGVyYWN0aW9uRGF0YSkKCXsKCQl0aGlzLl9vYmpNb3VzZURvd24oVFlQRV9NT1VTRSwgb2JqZWN0LCBpbnRlcmFjdGlvbkRhdGEpOwoJfTsKCQoJLyoqCgkqIE1vdXNlIGRvd24gb24gYW4gb2JtZWN0CgkqICBAbWV0aG9kIF9vYmpNb3VzZURvd24KCSogIEBwcml2YXRlCgkqICBAcGFyYW0ge2ludH0gdHlwZSBUaGUgdHlwZSBvZiBpbnB1dCB0aGF0IHRyaWdnZXJlZCB0aGlzIGNhbGwgLSBlaXRoZXIgVFlQRV9NT1VTRSBvciBUWVBFX1RPVUNILgoJKiAgQHBhcmFtIHtQSVhJLkRpc3BsYXlPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRoYXQgc2hvdWxkIGJlIGRyYWdnZWQuCgkqLwoJcC5fb2JqTW91c2VEb3duID0gZnVuY3Rpb24odHlwZSwgb2JqLCBpbnRlcmFjdGlvbkRhdGEpCgl7CgkJLy8gaWYgd2UgYXJlIGRyYWdnaW5nIHNvbWV0aGluZywgdGhlbiBpZ25vcmUgYW55IG1vdXNlIGRvd25zCgkJLy8gdW50aWwgd2UgcmVsZWFzZSB0aGUgY3VycmVudGx5IGRyYWdnZWQgc3R1ZmYKCQlpZih0aGlzLmRyYWdnZWRPYmogIT09IG51bGwpIHJldHVybjsKCgkJdGhpcy5kcmFnZ2VkT2JqID0gb2JqOwoJCWNyZWF0ZWpzLlR3ZWVuLnJlbW92ZVR3ZWVucyh0aGlzLmRyYWdnZWRPYmopOwoJCWNyZWF0ZWpzLlR3ZWVuLnJlbW92ZVR3ZWVucyh0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24pOwoJCQoJCS8vZ2V0IHRoZSBtb3VzZSBwb3NpdGlvbiBhbmQgY29udmVydCBpdCB0byBvYmplY3QgcGFyZW50IHNwYWNlCgkJdGhpcy5fZHJhZ09mZnNldCA9IGludGVyYWN0aW9uRGF0YS5nZXRMb2NhbFBvc2l0aW9uKHRoaXMuZHJhZ2dlZE9iai5wYXJlbnQpOwoJCQoJCS8vbW92ZSB0aGUgb2Zmc2V0IHRvIHJlc3BlY3QgdGhlIG9iamVjdCdzIGN1cnJlbnQgcG9zaXRpb24KCQl0aGlzLl9kcmFnT2Zmc2V0LnggLT0gdGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uLng7CgkJdGhpcy5fZHJhZ09mZnNldC55IC09IHRoaXMuZHJhZ2dlZE9iai5wb3NpdGlvbi55OwoKCQl0aGlzLm1vdXNlRG93bk9ialBvcy54ID0gdGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uLng7CgkJdGhpcy5tb3VzZURvd25PYmpQb3MueSA9IHRoaXMuZHJhZ2dlZE9iai5wb3NpdGlvbi55OwoJCQoJCXRoaXMubW91c2VEb3duU3RhZ2VQb3MueCA9IGludGVyYWN0aW9uRGF0YS5nbG9iYWwueDsKCQl0aGlzLm1vdXNlRG93blN0YWdlUG9zLnkgPSBpbnRlcmFjdGlvbkRhdGEuZ2xvYmFsLnk7CgkJaWYoIXRoaXMuYWxsb3dTdGlja3lDbGljayB8fCB0eXBlID09IFRZUEVfVE9VQ0gpLy9pZiBpdCBpcyBhIHRvdWNoIGV2ZW50LCBmb3JjZSBpdCB0byBiZSB0aGUgaGVsZCBkcmFnIHR5cGUKCQl7CgkJCXRoaXMuaXNUb3VjaE1vdmUgPSB0eXBlID09IFRZUEVfVE9VQ0g7CgkJCXRoaXMuaXNIZWxkRHJhZyA9IHRydWU7CgkJCXRoaXMuX3N0YXJ0RHJhZygpOwoJCX0KCQllbHNlLy9vdGhlcndpc2UsIHdhaXQgZm9yIGEgbW92ZW1lbnQgb3IgYSBtb3VzZSB1cCBpbiBvcmRlciB0byBkbyBhIGhlbGQgZHJhZyBvciBhIHN0aWNreSBjbGljayBkcmFnCgkJewoJCQl0aGlzLmRyYWdnZWRPYmoubW91c2Vtb3ZlID0gdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2s7CgkJCXRoaXMuX3RoZVN0YWdlLmludGVyYWN0aW9uTWFuYWdlci5zdGFnZVVwID0gdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2s7CgkJfQoJfTsKCQoJLyoqCgkqIFN0YXJ0IHRoZSBzdGlja3kgY2xpY2sKCSogQG1ldGhvZCBfdHJpZ2dlclN0aWNreUNsaWNrCgkqIEBwcml2YXRlCgkqLwoJcC5fdHJpZ2dlclN0aWNreUNsaWNrID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuaXNTdGlja3lDbGljayA9IHRydWU7CgkJdGhpcy5kcmFnZ2VkT2JqLm1vdXNlbW92ZSA9IG51bGw7CgkJdGhpcy5fdGhlU3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLnN0YWdlVXAgPSBudWxsOwoJCXRoaXMuX3N0YXJ0RHJhZygpOwoJfTsKCgkvKioKCSogU3RhcnQgaG9sZCBkcmFnZ2luZwoJKiBAbWV0aG9kIF90cmlnZ2VySGVsZERyYWcKCSogQHByaXZhdGUKCSogQHBhcmFtIHtQSVhJLkludGVyYWN0aW9uRGF0YX0gaW50ZXJhY3Rpb25EYXRhIFRoZSBpbmVyYWN0aW9uIGRhdGEgYWJvdXQgdGhlIG1vdmVkIG1vdXNlCgkqLwoJcC5fdHJpZ2dlckhlbGREcmFnID0gZnVuY3Rpb24oaW50ZXJhY3Rpb25EYXRhKQoJewoJCXZhciB4RGlmZiA9IGludGVyYWN0aW9uRGF0YS5nbG9iYWwueCAtIHRoaXMubW91c2VEb3duU3RhZ2VQb3MueDsKCQl2YXIgeURpZmYgPSBpbnRlcmFjdGlvbkRhdGEuZ2xvYmFsLnkgLSB0aGlzLm1vdXNlRG93blN0YWdlUG9zLnk7CgkJaWYoeERpZmYgKiB4RGlmZiArIHlEaWZmICogeURpZmYgPj0gdGhpcy5kcmFnU3RhcnRUaHJlc2hvbGQgKiB0aGlzLmRyYWdTdGFydFRocmVzaG9sZCkKCQl7CgkJCXRoaXMuaXNIZWxkRHJhZyA9IHRydWU7CgkJCXRoaXMuZHJhZ2dlZE9iai5tb3VzZW1vdmUgPSBudWxsOwoJCQl0aGlzLl90aGVTdGFnZS5pbnRlcmFjdGlvbk1hbmFnZXIuc3RhZ2VVcCA9IG51bGw7CgkJCXRoaXMuX3N0YXJ0RHJhZygpOwoJCX0KCX07CgoJLyoqCgkqIEludGVybmFsIHN0YXJ0IGRyYWdnaW5nIG9uIHRoZSBzdGFnZQoJKiBAbWV0aG9kIF9zdGFydERyYWcKCSogQHByaXZhdGUgCgkqLwoJcC5fc3RhcnREcmFnID0gZnVuY3Rpb24oKQoJewoJCXZhciBpbSA9IHRoaXMuX3RoZVN0YWdlLmludGVyYWN0aW9uTWFuYWdlcjsKCQlpbS5zdGFnZVVwID0gdGhpcy5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2s7CgkJdGhpcy5kcmFnZ2VkT2JqLm1vdXNlbW92ZSA9IHRoaXMuZHJhZ2dlZE9iai50b3VjaG1vdmUgPSB0aGlzLl91cGRhdGVDYWxsYmFjazsKCQkKCQl0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayh0aGlzLmRyYWdnZWRPYmopOwoJfTsKCQoJLyoqCgkqIFN0b3BzIGRyYWdnaW5nIHRoZSBjdXJyZW50bHkgZHJhZ2dlZCBvYmplY3QuCgkqIEBwdWJsaWMKCSogQG1ldGhvZCBzdG9wRHJhZwoJKiBAcGFyYW0ge0Jvb2x9IGRvQ2FsbGJhY2sgSWYgdGhlIGRyYWcgZW5kIGNhbGxiYWNrIHNob3VsZCBiZSBjYWxsZWQuIERlZmF1bHQgaXMgZmFsc2UuCgkqLwoJcC5zdG9wRHJhZyA9IGZ1bmN0aW9uKGRvQ2FsbGJhY2spCgl7CgkJdGhpcy5fc3RvcERyYWcobnVsbCwgZG9DYWxsYmFjayA9PT0gdHJ1ZSk7Ly9wYXNzIHRydWUgaWYgaXQgd2FzIGV4cGxpY2l0bHkgcGFzc2VkIHRvIHVzLCBmYWxzZSBhbmQgdW5kZWZpbmVkIC0+IGZhbHNlCgl9OwoKCS8qKgoJKiBJbnRlcm5hbCBzdG9wIGRyYWdnaW5nIG9uIHRoZSBzdGFnZQoJKiBAbWV0aG9kIF9zdG9wRHJhZwoJKiBAcHJpdmF0ZSAKCSogQHBhcmFtIHtFdmVudH0gZXYgTW91c2UgdXAgZXZlbnQKCSogQHBhcmFtIHtCb29sfSBkb0NhbGxiYWNrIElmIHdlIHNob3VsZCBkbyB0aGUgY2FsbGJhY2sKCSovCglwLl9zdG9wRHJhZyA9IGZ1bmN0aW9uKG9yaWdNb3VzZUV2LCBkb0NhbGxiYWNrKQoJewoJCWlmKHRoaXMuZHJhZ2dlZE9iaikKCQkJdGhpcy5kcmFnZ2VkT2JqLnRvdWNobW92ZSA9IHRoaXMuZHJhZ2dlZE9iai5tb3VzZW1vdmUgPSBudWxsOwoJCXZhciBpbSA9IHRoaXMuX3RoZVN0YWdlLmludGVyYWN0aW9uTWFuYWdlcjsKCQlpbS5zdGFnZVVwID0gbnVsbDsKCQl2YXIgb2JqID0gdGhpcy5kcmFnZ2VkT2JqOwoJCXRoaXMuZHJhZ2dlZE9iaiA9IG51bGw7CgkJdGhpcy5pc1RvdWNoTW92ZSA9IGZhbHNlOwoJCXRoaXMuaXNTdGlja3lDbGljayA9IGZhbHNlOwoJCXRoaXMuaXNIZWxkTW92ZSA9IGZhbHNlOwoKCQlpZihkb0NhbGxiYWNrICE9PSBmYWxzZSkgLy8gdHJ1ZSBvciB1bmRlZmluZWQKCQkJdGhpcy5fZHJhZ0VuZENhbGxiYWNrKG9iaik7Cgl9OwoKCS8qKgoJKiBVcGRhdGUgdGhlIG9iamVjdCBwb3NpdGlvbiBiYXNlZCBvbiB0aGUgbW91c2UKCSogQG1ldGhvZCBfdXBkYXRlT2JqUG9zaXRpb24KCSogQHByaXZhdGUKCSogQHBhcmFtIHtQSVhJLkludGVyYWN0aW9uRGF0YX0gaW50ZXJhY3Rpb25EYXRhIE1vdXNlIG1vdmUgZXZlbnQKCSovCglwLl91cGRhdGVPYmpQb3NpdGlvbiA9IGZ1bmN0aW9uKGludGVyYWN0aW9uRGF0YSkKCXsKCQlpZighdGhpcy5pc1RvdWNoTW92ZSAmJiAhdGhpcy5fdGhlU3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLm1vdXNlSW5TdGFnZSkgcmV0dXJuOwoJCWlmKCF0aGlzLmRyYWdnZWRPYmogfHwgIXRoaXMuZHJhZ2dlZE9iai5wYXJlbnQpLy9ub3QgcXVpdGUgc3VyZSB3aGF0IGNoYWluIG9mIGV2ZW50cyB3b3VsZCBsZWFkIHRvIHRoaXMsIGJ1dCB3ZSdsbCBzdG9wIGRyYWdnaW5nIHRvIGJlIHNhZmUKCQl7CgkJCXRoaXMuX3N0b3BEcmFnKG51bGwsIGZhbHNlKTsKCQkJcmV0dXJuOwoJCX0KCQkKCQl2YXIgbW91c2VQb3MgPSBpbnRlcmFjdGlvbkRhdGEuZ2V0TG9jYWxQb3NpdGlvbih0aGlzLmRyYWdnZWRPYmoucGFyZW50LCBoZWxwZXJQb2ludCk7CgkJdmFyIGJvdW5kcyA9IHRoaXMuZHJhZ2dlZE9iai5fZHJhZ0JvdW5kczsKCQl0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueCA9IGNsYW1wKG1vdXNlUG9zLnggLSB0aGlzLl9kcmFnT2Zmc2V0LngsIGJvdW5kcy54LCBib3VuZHMucmlnaHQpOwoJCXRoaXMuZHJhZ2dlZE9iai5wb3NpdGlvbi55ID0gY2xhbXAobW91c2VQb3MueSAtIHRoaXMuX2RyYWdPZmZzZXQueSwgYm91bmRzLnksIGJvdW5kcy5ib3R0b20pOwoJCWlmKHRoaXMuc25hcFNldHRpbmdzKQoJCXsKCQkJc3dpdGNoKHRoaXMuc25hcFNldHRpbmdzLm1vZGUpCgkJCXsKCQkJCWNhc2UgInBvaW50cyI6CgkJCQkJdGhpcy5faGFuZGxlUG9pbnRTbmFwKG1vdXNlUG9zKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgImdyaWQiOgoJCQkJCS8vbm90IHlldCBpbXBsZW1lbnRlZAoJCQkJCWJyZWFrOwoJCQkJY2FzZSAibGluZSI6CgkJCQkJLy9ub3QgeWV0IGltcGxlbWVudGVkCgkJCQkJYnJlYWs7CgkJCX0KCQl9Cgl9OwoKCS8qKgoJKiBIYW5kbGVzIHNuYXBwaW5nIHRoZSBkcmFnZ2VkIG9iamVjdCB0byB0aGUgbmVhcmVzdCBhbW9uZyBhIGxpc3Qgb2YgcG9pbnRzCgkqIEBtZXRob2QgX2hhbmRsZVBvaW50U25hcAoJKiBAcHJpdmF0ZQoJKiBAcGFyYW0ge2NyZWF0ZWpzLlBvaW50fSBsb2NhbE1vdXNlUG9zIFRoZSBtb3VzZSBwb3NpdGlvbiBpbiB0aGUgc2FtZSBzcGFjZSBhcyB0aGUgZHJhZ2dlZCBvYmplY3QuCgkqLwoJcC5faGFuZGxlUG9pbnRTbmFwID0gZnVuY3Rpb24obG9jYWxNb3VzZVBvcykKCXsKCQl2YXIgc25hcFNldHRpbmdzID0gdGhpcy5zbmFwU2V0dGluZ3M7CgkJdmFyIG1pbkRpc3RTcSA9IHNuYXBTZXR0aW5ncy5kaXN0ICogc25hcFNldHRpbmdzLmRpc3Q7CgkJdmFyIHBvaW50cyA9IHNuYXBTZXR0aW5ncy5wb2ludHM7CgkJdmFyIG9ialggPSBsb2NhbE1vdXNlUG9zLnggLSB0aGlzLl9kcmFnT2Zmc2V0Lng7CgkJdmFyIG9ialkgPSBsb2NhbE1vdXNlUG9zLnkgLSB0aGlzLl9kcmFnT2Zmc2V0Lnk7CgkJdmFyIGxlYXN0RGlzdCA9IC0xOwoJCXZhciBjbG9zZXN0UG9pbnQgPSBudWxsOwoJCWZvcih2YXIgaSA9IHBvaW50cy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkKCQl7CgkJCXZhciBwID0gcG9pbnRzW2ldOwoJCQl2YXIgZGlzdFNxID0gZGlzdFNxdWFyZWQob2JqWCwgb2JqWSwgcC54LCBwLnkpOwoJCQlpZihkaXN0U3EgPD0gbWluRGlzdFNxICYmIChkaXN0U3EgPCBsZWFzdERpc3QgfHwgbGVhc3REaXN0ID09IC0xKSkKCQkJewoJCQkJbGVhc3REaXN0ID0gZGlzdFNxOwoJCQkJY2xvc2VzdFBvaW50ID0gcDsKCQkJfQoJCX0KCQlpZihjbG9zZXN0UG9pbnQpCgkJewoJCQl0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueCA9IGNsb3Nlc3RQb2ludC54OwoJCQl0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueSA9IGNsb3Nlc3RQb2ludC55OwoJCX0KCX07CgoJLyoKCSogU21hbGwgZGlzdGFuY2Ugc3F1YXJlZCBmdW5jdGlvbgoJKi8KCXZhciBkaXN0U3F1YXJlZCA9IGZ1bmN0aW9uKHgxLCB5MSwgeDIsIHkyKQoJewoJCXZhciB4RGlmZiA9IHgxIC0geDI7CgkJdmFyIHlEaWZmID0geTEgLSB5MjsKCQlyZXR1cm4geERpZmYgKiB4RGlmZiArIHlEaWZmICogeURpZmY7Cgl9OwoJCgkvKioKCSogU2ltcGxlIGNsYW1wIGZ1bmN0aW9uCgkqLwoJdmFyIGNsYW1wID0gZnVuY3Rpb24oeCxhLGIpCgl7CgkJcmV0dXJuICh4IDwgYSA/IGEgOiAoeCA+IGIgPyBiIDogeCkpOwoJfTsKCQoJLy89PT0gR2l2aW5nIGZ1bmN0aW9ucyBhbmQgcHJvcGVydGllcyB0byBkcmFnZ2FibGUgb2JqZWN0cyBvYmplY3RzCgl2YXIgZW5hYmxlRHJhZyA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLm1vdXNlZG93biA9IHRoaXMuX29uTW91c2VEb3duTGlzdGVuZXI7CgkJdGhpcy50b3VjaHN0YXJ0ID0gdGhpcy5fb25Ub3VjaFN0YXJ0TGlzdGVuZXI7CgkJdGhpcy5idXR0b25Nb2RlID0gdGhpcy5pbnRlcmFjdGl2ZSA9IHRydWU7Cgl9OwoJCgl2YXIgZGlzYWJsZURyYWcgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5tb3VzZWRvd24gPSB0aGlzLnRvdWNoc3RhcnQgPSBudWxsOwoJCXRoaXMuYnV0dG9uTW9kZSA9IHRoaXMuaW50ZXJhY3RpdmUgPSBmYWxzZTsKCX07CgkKCXZhciBfb25Nb3VzZURvd24gPSBmdW5jdGlvbih0eXBlLCBtb3VzZURhdGEpCgl7CgkJdGhpcy5fZHJhZ01hbi5fb2JqTW91c2VEb3duKHR5cGUsIHRoaXMsIG1vdXNlRGF0YSk7Cgl9OwoJCgkvKiogCgkqIEFkZHMgcHJvcGVydGllcyBhbmQgZnVuY3Rpb25zIHRvIHRoZSBvYmplY3QgLSB1c2UgZW5hYmxlRHJhZygpIGFuZCBkaXNhYmxlRHJhZygpIG9uIAoJKiBvYmplY3RzIHRvIGVuYWJsZS9kaXNhYmxlIHRoZW0gKHRoZXkgc3RhcnQgb3V0IGRpc2FibGVkKS4gUHJvcGVydGllcyBhZGRlZCB0byBvYmplY3RzOgoJKiBfZHJhZ0JvdW5kcyAoUmVjdGFuZ2xlKSwgX29uTW91c2VEb3duTGlzdGVuZXIgKEZ1bmN0aW9uKSwgX2RyYWdNYW4gKGNsb3Vka2lkLkRyYWdNYW5hZ2VyKSByZWZlcmVuY2UgdG8gdGhlIERyYWdNYW5hZ2VyCgkqIHRoZXNlIHdpbGwgb3ZlcnJpZGUgYW55IGV4aXN0aW5nIHByb3BlcnRpZXMgb2YgdGhlIHNhbWUgbmFtZQoJKiBAbWV0aG9kIGFkZE9iamVjdAoJKiBAcHVibGljCgkqIEBwYXJhbSB7UElYSS5EaXNwbGF5T2JqZWN0fSBvYmogVGhlIGRpc3BsYXkgb2JqZWN0CgkqIEBwYXJhbSB7UElYSS5SZWN0YW5nbGV9IGJvdW5kIFRoZSByZWN0YW5nbGUgYm91bmRzCgkqLwoJcC5hZGRPYmplY3QgPSBmdW5jdGlvbihvYmosIGJvdW5kcykKCXsKCQlpZighYm91bmRzKQoJCXsKCQkJdmFyIGNhbnZhcyA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLl9yZW5kZXJlci52aWV3OwoJCQlib3VuZHMgPSB7eDowLCB5OjAsIHdpZHRoOmNhbnZhcy53aWR0aCwgaGVpZ2h0OmNhbnZhcy5oZWlnaHR9OwoJCX0KCQlib3VuZHMucmlnaHQgPSBib3VuZHMueCArIGJvdW5kcy53aWR0aDsKCQlib3VuZHMuYm90dG9tID0gYm91bmRzLnkgKyBib3VuZHMuaGVpZ2h0OwoJCW9iai5fZHJhZ0JvdW5kcyA9IGJvdW5kczsKCQlpZih0aGlzLl9kcmFnZ2FibGVPYmplY3RzLmluZGV4T2Yob2JqKSA+PSAwKQoJCXsKCQkJLy9kb24ndCBjaGFuZ2UgYW55IG9mIHRoZSBmdW5jdGlvbnMgb3IgYW55dGhpbmcsIGp1c3QgcXVpdCB0aGUgZnVuY3Rpb24gYWZ0ZXIgaGF2aW5nIHVwZGF0ZWQgdGhlIGJvdW5kcwoJCQlyZXR1cm47CgkJfQoJCW9iai5lbmFibGVEcmFnID0gZW5hYmxlRHJhZzsKCQlvYmouZGlzYWJsZURyYWcgPSBkaXNhYmxlRHJhZzsKCQlvYmouX29uTW91c2VEb3duTGlzdGVuZXIgPSBfb25Nb3VzZURvd24uYmluZChvYmosIFRZUEVfTU9VU0UpOwoJCW9iai5fb25Ub3VjaFN0YXJ0TGlzdGVuZXIgPSBfb25Nb3VzZURvd24uYmluZChvYmosIFRZUEVfVE9VQ0gpOwoJCW9iai5fZHJhZ01hbiA9IHRoaXM7CgkJdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5wdXNoKG9iaik7Cgl9OwoJCgkvKiogCgkqIFJlbW92ZXMgcHJvcGVydGllcyBhbmQgZnVuY3Rpb25zIGFkZGVkIGJ5IGFkZE9iamVjdCgpLgoJKiBAcHVibGljCgkqIEBtZXRob2QgcmVtb3ZlT2JqZWN0CgkqIEBwYXJhbSB7UElYSS5EaXNwbGF5T2JqZWN0fSBvYmogVGhlIGRpc3BsYXkgb2JqZWN0CgkqLwoJcC5yZW1vdmVPYmplY3QgPSBmdW5jdGlvbihvYmopCgl7CgkJdmFyIGluZGV4ID0gdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5pbmRleE9mKG9iaik7CgkJaWYoaW5kZXggPj0gMCkKCQl7CgkJCW9iai5kaXNhYmxlRHJhZygpOwoJCQlkZWxldGUgb2JqLmVuYWJsZURyYWc7CgkJCWRlbGV0ZSBvYmouZGlzYWJsZURyYWc7CgkJCWRlbGV0ZSBvYmouX29uTW91c2VEb3duTGlzdGVuZXI7CgkJCWRlbGV0ZSBvYmouX29uVG91Y2hTdGFydExpc3RlbmVyOwoJCQlkZWxldGUgb2JqLl9kcmFnTWFuOwoJCQlkZWxldGUgb2JqLl9kcmFnQm91bmRzOwoJCQl0aGlzLl9kcmFnZ2FibGVPYmplY3RzLnNwbGljZShpbmRleCwgMSk7CgkJfQoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBtYW5hZ2VyCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJaWYodGhpcy5kcmFnZ2VkT2JqICE9PSBudWxsKQoJCXsKCQkJLy9jbGVhbiB1cCBkcmFnZ2VkIG9iagoJCQl0aGlzLl9zdG9wRHJhZyhudWxsLCBmYWxzZSk7CgkJfQoJCXRoaXMuX3VwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayA9IG51bGw7CgkJdGhpcy5fZHJhZ0VuZENhbGxiYWNrID0gbnVsbDsKCQl0aGlzLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayA9IG51bGw7CgkJdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrID0gbnVsbDsKCQl0aGlzLl90aGVTdGFnZSA9IG51bGw7CgkJZm9yKHZhciBpID0gdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkKCQl7CgkJCXZhciBvYmogPSB0aGlzLl9kcmFnZ2FibGVPYmplY3RzW2ldOwoJCQlvYmouZGlzYWJsZURyYWcoKTsKCQkJZGVsZXRlIG9iai5lbmFibGVEcmFnOwoJCQlkZWxldGUgb2JqLmRpc2FibGVEcmFnOwoJCQlkZWxldGUgb2JqLl9vbk1vdXNlRG93bkxpc3RlbmVyOwoJCQlkZWxldGUgb2JqLl9kcmFnTWFuOwoJCQlkZWxldGUgb2JqLl9kcmFnQm91bmRzOwoJCX0KCQl0aGlzLl9kcmFnZ2FibGVPYmplY3RzID0gbnVsbDsKCX07CgkKCS8qKiBBc3NpZ24gdG8gdGhlIGdsb2JhbCBuYW1lc3BhY2UgKi8KCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5EcmFnTWFuYWdlciA9IERyYWdNYW5hZ2VyOwp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCQoJLyoqCgkqICBJbml0aWFsbHkgbGF5b3V0cyBhbGwgaW50ZXJmYWNlIGVsZW1lbnRzCgkqICBAbW9kdWxlIGNsb3Vka2lkCgkqICBAY2xhc3MgUG9zaXRpb25lcgoJKi8KCXZhciBQb3NpdGlvbmVyID0gZnVuY3Rpb24oKXt9OwoJCgkvLyBTZXQgdGhlIHByb3R5cGUKCVBvc2l0aW9uZXIucHJvdG90eXBlID0ge307CgkKCS8qKgoJKiAgSW5pdGlhbCBwb3NpdGlvbiBvZiBhbGwgbGF5b3V0IGl0ZW1zCgkqICBAbWV0aG9kIHBvc2l0aW9uSXRlbXMKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudAoJKiAgQHBhcmFtIHtPYmplY3R9IGl0ZW1TZXR0aW5ncyBKU09OIGZvcm1hdCB3aXRoIHBvc2l0aW9uIGluZm9ybWF0aW9uCgkqLwoJUG9zaXRpb25lci5wb3NpdGlvbkl0ZW1zID0gZnVuY3Rpb24ocGFyZW50LCBpdGVtU2V0dGluZ3MpCgl7CgkJdmFyIHJvdCwgcHQsIGRlZ1RvUmFkOwoJCWlmKHRydWUpCgkJCWRlZ1RvUmFkID0gTWF0aC5QSSAvIDE4MDsKCQlmb3IodmFyIGlOYW1lIGluIGl0ZW1TZXR0aW5ncykKCQl7CgkJCXZhciBpdGVtID0gcGFyZW50W2lOYW1lXTsKCQkJaWYoIWl0ZW0pCgkJCXsKCQkJCURlYnVnLmVycm9yKCJjb3VsZCBub3QgZmluZCBvYmplY3QgJyIgKyAgaU5hbWUgKyAiJyIpOwoJCQkJY29udGludWU7CgkJCX0KCQkJdmFyIHNldHRpbmcgPSBpdGVtU2V0dGluZ3NbaU5hbWVdOwoJCQlpZih0cnVlKQoJCQl7CgkJCQlpdGVtLnBvc2l0aW9uLnggPSBzZXR0aW5nLng7CgkJCQlpdGVtLnBvc2l0aW9uLnkgPSBzZXR0aW5nLnk7CgkJCQlwdCA9IHNldHRpbmcuc2NhbGU7CgkJCQlpZihwdCkKCQkJCXsKCQkJCQlpdGVtLnNjYWxlLnggKj0gcHQueDsKCQkJCQlpdGVtLnNjYWxlLnkgKj0gcHQueTsKCQkJCX0KCQkJCXB0ID0gc2V0dGluZy5waXZvdDsKCQkJCWlmKHB0KQoJCQkJewoJCQkJCWl0ZW0ucGl2b3QueCA9IHB0Lng7CgkJCQkJaXRlbS5waXZvdC55ID0gcHQueTsKCQkJCX0KCQkJCXJvdCA9IHNldHRpbmcucm90YXRpb247CgkJCQlpZihyb3QpCgkJCQkJaXRlbS5yb3RhdGlvbiA9IHJvdCAqIGRlZ1RvUmFkOy8vUGl4aSByb3RhdGlvbnMgYXJlIGluIHJhZGlhbnMKCQkJfQoJCQllbHNlCgkJCXsKCQkJCWl0ZW0ueCA9IHNldHRpbmcueDsKCQkJCWl0ZW0ueSA9IHNldHRpbmcueTsKCQkJCXB0ID0gc2V0dGluZy5zY2FsZTsKCQkJCWlmKHB0KQoJCQkJewoJCQkJCWl0ZW0uc2NhbGVYICo9IHB0Lng7CgkJCQkJaXRlbS5zY2FsZVkgKj0gcHQueTsKCQkJCX0KCQkJCXB0ID0gc2V0dGluZy5waXZvdDsKCQkJCWlmKHB0KQoJCQkJewoJCQkJCWl0ZW0ucmVnWCA9IHB0Lng7CgkJCQkJaXRlbS5yZWdZID0gcHQueTsKCQkJCX0KCQkJCXJvdCA9IHNldHRpbmcucm90YXRpb247CgkJCQlpZihyb3QpCgkJCQkJaXRlbS5yb3RhdGlvbiA9IHJvdDsKCQkJfQoJCQkvL2l0ZW0ubmFtZSA9IGlOYW1lOwoJCQlpZihzZXR0aW5nLmhpdEFyZWEpCgkJCXsKCQkJCXZhciBoaXRBcmVhID0gc2V0dGluZy5oaXRBcmVhOwoJCQkJaWYodHJ1ZSkKCQkJCXsKCQkJCQlpdGVtLmhpdEFyZWEgPSBQb3NpdGlvbmVyLmdlbmVyYXRlSGl0QXJlYShoaXRBcmVhKTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQlpdGVtLmhpdFNoYXBlID0gUG9zaXRpb25lci5nZW5lcmF0ZUhpdEFyZWEoaGl0QXJlYSk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoJCgkvKioKCSogIENyZWF0ZSB0aGUgcG9seWdvbiBoaXQgYXJlYSBmb3IgaW50ZXJmYWNlIGVsZW1lbnRzCgkqICBAc3RhdGljCgkqICBAbWV0aG9kIGdlbmVyYXRlSGl0QXJlYQoJKiAgQHBhcmFtIHtPYmplY3R8QXJyYXl9IGhpdEFyZWEgT25lIG9mIHRoZSBmb2xsb3dpbmc6IDxici8+CgkqICAqIEFuIGFycmF5IG9mIHBvaW50cyBmb3IgYSBwb2x5Z29uLCBlLmcuIAoJKgoJKgkJW3t4OjAsIHk6MH0sIHt4OjAsIHk6MjB9LCB7eDoyMCwgeTowfV0KCSoKCSogICogQW4gb2JqZWN0IGRlc2NyaWJpbmcgYSByZWN0YW5nbGUsIGUuZy4KCSoKCSoJCXt0eXBlOiJyZWN0IiwgeDowLCB5OjAsIHc6MTAsIGg6MzB9CgkqCgkqICAqIEFuIG9iamVjdCBkZXNjcmliaW5nIGFuIGVsbGlwc2UsIHdoZXJlIHggYW5kIHkgYXJlIHRoZSBjZW50ZXIsIGUuZy4gCgkqCgkqCQl7dHlwZToiZWxsaXBzZSIsIHg6MCwgeTowLCB3OjEwLCBoOjMwfQoJKgoJKiAgKiBBbiBvYmplY3QgZGVzY3JpYmluZyBhIGNpcmNsZSwgd2hlcmUgeCBhbmQgeSBhcmUgdGhlIGNlbnRlciwgZS5nLgoJKgoJKgkJe3R5cGU6ImNpcmNsZSIsIHg6MCwgeTowLCByOjIwfQoJKiAgQHBhcmFtIHtOdW1iZXJ9IHNjYWxlPTEgVGhlIHNpemUgdG8gc2NhbGUgaGl0QXJlYSBieQoJKiAgQHJldHVybiB7T2JqZWN0fSBBIGdlb21ldHJpYyBzaGFwZSBvYmplY3QgZm9yIGhpdCB0ZXN0aW5nLCBlaXRoZXIgYSBQb2x5Z29uLCBSZWN0YW5nbGUsIEVsbGlwc2UsIG9yIENpcmNsZSwKCSogICAgICBkZXBlbmRpbmcgb24gdGhlIGhpdEFyZWEgb2JqZWN0LiBUaGUgc2hhcGUgd2lsbCBoYXZlIGEgY29udGFpbnMoKSBmdW5jdGlvbiBmb3IgaGl0IHRlc3RpbmcuCgkqLwoJUG9zaXRpb25lci5nZW5lcmF0ZUhpdEFyZWEgPSBmdW5jdGlvbihoaXRBcmVhLCBzY2FsZSkKCXsKCQlpZighc2NhbGUpCgkJCXNjYWxlID0gMTsKCQl2YXIgbGlicmFyeTsKCQlpZih0cnVlKQoJCQlsaWJyYXJ5ID0gd2luZG93LlBJWEk7CgkJZWxzZQoJCQlsaWJyYXJ5ID0gd2luZG93LmNyZWF0ZWpzOwoJCWlmKGlzQXJyYXkoaGl0QXJlYSkpCgkJewoJCQlpZihzY2FsZSA9PSAxKQoJCQkJcmV0dXJuIG5ldyBsaWJyYXJ5LlBvbHlnb24oaGl0QXJlYSk7CgkJCWVsc2UKCQkJewoJCQkJdmFyIHRlbXAgPSBbXTsKCQkJCWZvcih2YXIgaSA9IDAsIGxlbiA9IGhpdEFyZWEubGVuZ3RoOyBpIDwgbGVuOyArK2kpCgkJCQl7CgkJCQkJdGVtcC5wdXNoKG5ldyBsaWJyYXJ5LlBvaW50KGhpdEFyZWFbaV0ueCAqIHNjYWxlLCBoaXRBcmVhW2ldLnkgKiBzY2FsZSkpOwoJCQkJfQoJCQkJcmV0dXJuIG5ldyBsaWJyYXJ5LlBvbHlnb24odGVtcCk7CgkJCX0KCQl9CgkJZWxzZSBpZihoaXRBcmVhLnR5cGUgPT0gInJlY3QiIHx8ICFoaXRBcmVhLnR5cGUpCgkJCXJldHVybiBuZXcgbGlicmFyeS5SZWN0YW5nbGUoaGl0QXJlYS54ICogc2NhbGUsIGhpdEFyZWEueSAqIHNjYWxlLCBoaXRBcmVhLncgKiBzY2FsZSwgaGl0QXJlYS5oICogc2NhbGUpOwoJCWVsc2UgaWYoaGl0QXJlYS50eXBlID09ICJlbGxpcHNlIikKCQkJcmV0dXJuIG5ldyBsaWJyYXJ5LkVsbGlwc2UoKGhpdEFyZWEueCAtIGhpdEFyZWEudyAqIDAuNSkgKiBzY2FsZSwgKGhpdEFyZWEueSAtIGhpdEFyZWEuaCAqIDAuNSkgKiBzY2FsZSwgaGl0QXJlYS53ICogc2NhbGUsIGhpdEFyZWEuaCAqIHNjYWxlKTsvL2NvbnZlcnQgY2VudGVyIHRvIHVwcGVyIGxlZnQgY29ybmVyCgkJZWxzZSBpZihoaXRBcmVhLnR5cGUgPT0gImNpcmNsZSIpCgkJCXJldHVybiBuZXcgbGlicmFyeS5DaXJjbGUoaGl0QXJlYS54ICogc2NhbGUsIGhpdEFyZWEueSAqIHNjYWxlLCBoaXRBcmVhLnIgKiBzY2FsZSk7Ly94ICYgeSBhcmUgY2VudGVyLCBwaXhpIGRvY3VtZW50YXRpb24gbGllcwoJCWVsc2UgaWYoaGl0QXJlYS50eXBlID09ICJzZWN0b3IiKQoJCQlyZXR1cm4gbmV3IGxpYnJhcnkuU2VjdG9yKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS5yICogc2NhbGUsIGhpdEFyZWEuc3RhcnQsIGhpdEFyZWEuZW5kKTsKCQlyZXR1cm4gbnVsbDsKCX07CgoJdmFyIGlzQXJyYXkgPSBmdW5jdGlvbihvKQoJewoJCXJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobykgPT09ICdbb2JqZWN0IEFycmF5XSc7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuUG9zaXRpb25lciA9IFBvc2l0aW9uZXI7Cn0oKSk7CihmdW5jdGlvbigpIHsKCQoJInVzZSBzdHJpY3QiOwoKCS8qKgoJKiAgIE9iamVjdCB0aGF0IGNvbnRhaW5zIHRoZSBzY3JlZW4gc2V0dGluZ3MgdG8gaGVscCBzY2FsaW5nCgkqICAgQG1vZHVsZSBjbG91ZGtpZAoJKiAgIEBjbGFzcyBTY3JlZW5TZXR0aW5ncwoJKiAgIEBjb25zdHJ1Y3RvcgoJKiAgIEBwYXJhbSB7TnVtYmVyfSB3aWR0aCBUaGUgc2NyZWVuIHdpZHRoIGluIHBpeGVscwoJKiAgIEBwYXJhbSB7TnVtYmVyfSBoZWlnaHQgVGhlIHNjcmVlbiBoZWlnaHQgaW4gcGl4ZWxzCgkqICAgQHBhcmFtIHtOdW1iZXJ9IHBwaSBUaGUgc2NyZWVuIHBpeGVsIGRlbnNpdHkgKFBQSSkKCSovCgl2YXIgU2NyZWVuU2V0dGluZ3MgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0LCBwcGkpCgl7CgkJLyoqCgkJKiAgVGhlIHNjcmVlbiB3aWR0aCBpbiBwaXhlbHMKCQkqICBAcHJvcGVydHkge051bWJlcn0gd2lkdGggCgkJKi8KCQl0aGlzLndpZHRoID0gd2lkdGg7CgoJCS8qKgoJCSogIFRoZSBzY3JlZW4gaGVpZ2h0IGluIHBpeGVscwoJCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBoZWlnaHQgCgkJKi8KCQl0aGlzLmhlaWdodCA9IGhlaWdodDsKCgkJLyoqCgkJKiAgVGhlIHNjcmVlbiBwaXhlbCBkZW5zaXR5IChQUEkpCgkJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IHBwaQoJCSovCgkJdGhpcy5wcGkgPSBwcGk7Cgl9OwoJCgkvLyBTZXQgdGhlIHByb3RvdHlwZQoJU2NyZWVuU2V0dGluZ3MucHJvdG90eXBlID0ge307CgkKCS8vIEFzc2lnbiB0byBuYW1lc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5TY3JlZW5TZXR0aW5ncyA9IFNjcmVlblNldHRpbmdzOwoKfSgpKTsKKGZ1bmN0aW9uKCkgewoKCSJ1c2Ugc3RyaWN0IjsKCgkvLyBDbGFzcyBpbXBvcnRzCgl2YXIgVUlTY2FsZXI7CgoJLyoqCgkqICAgQSBzaW5nbGUgVUkgaXRlbSB0aGF0IG5lZWRzIHRvIGJlIHJlc2l6ZWQJCgkqCgkqICAgQG1vZHVsZSBjbG91ZGtpZAoJKiAgIEBjbGFzcyBVSUVsZW1lbnQKCSoJQHBhcmFtIHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fFBJWEkuRGlzcGxheU9iamVjdH0gaXRlbSBUaGUgaXRlbSB0byBhZmZlY3QgIAoJKiAgIEBwYXJhbSB7VUlFbGVtZW50U2V0dGluZ3N9IHNldHRpbmdzIFRoZSBzY2FsZSBzZXR0aW5ncwoJKglAcGFyYW0ge1NjcmVlblNldHRpbmdzfSBkZXNpZ25lZFNjcmVlbiBUaGUgb3JpZ2luYWwgc2NyZWVuIHRoZSBpdGVtIHdhcyBkZXNpZ25lZCBmb3IKCSovCgl2YXIgVUlFbGVtZW50ID0gZnVuY3Rpb24oaXRlbSwgc2V0dGluZ3MsIGRlc2lnbmVkU2NyZWVuKQoJewoJCVVJU2NhbGVyID0gY2xvdWRraWQuVUlTY2FsZXI7CgkJCgkJdGhpcy5faXRlbSA9IGl0ZW07CQkJCgkJdGhpcy5fc2V0dGluZ3MgPSBzZXR0aW5nczsKCQl0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IGRlc2lnbmVkU2NyZWVuOwoJCQoJCWlmKHRydWUpCgkJewoJCQl0aGlzLm9yaWdTY2FsZVggPSBpdGVtLnNjYWxlLng7CQoJCQl0aGlzLm9yaWdTY2FsZVkgPSBpdGVtLnNjYWxlLnk7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMub3JpZ1NjYWxlWCA9IGl0ZW0uc2NhbGVYOwoJCQl0aGlzLm9yaWdTY2FsZVkgPSBpdGVtLnNjYWxlWTsKCQl9CgoJCXRoaXMub3JpZ1dpZHRoID0gaXRlbS53aWR0aDsKCgkJdGhpcy5vcmlnQm91bmRzID0ge3g6MCwgeTowLCB3aWR0aDppdGVtLndpZHRoLCBoZWlnaHQ6aXRlbS5oZWlnaHR9OwoJCXRoaXMub3JpZ0JvdW5kcy5yaWdodCA9IHRoaXMub3JpZ0JvdW5kcy54ICsgdGhpcy5vcmlnQm91bmRzLndpZHRoOwoJCXRoaXMub3JpZ0JvdW5kcy5ib3R0b20gPSB0aGlzLm9yaWdCb3VuZHMueSArIHRoaXMub3JpZ0JvdW5kcy5oZWlnaHQ7CgkJCgkJc3dpdGNoKHNldHRpbmdzLnZlcnRBbGlnbikKCQl7CgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fVE9QOgoJCQl7CgkJCQlpZih0cnVlKQoJCQkJCXRoaXMub3JpZ01hcmdpblZlcnQgPSBpdGVtLnBvc2l0aW9uLnkgKyB0aGlzLm9yaWdCb3VuZHMueTsKCQkJCWVsc2UKCQkJCQl0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gaXRlbS55ICsgdGhpcy5vcmlnQm91bmRzLnk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKCQkJewoJCQkJaWYodHJ1ZSkKCQkJCQl0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gZGVzaWduZWRTY3JlZW4uaGVpZ2h0ICogMC41IC0gaXRlbS5wb3NpdGlvbi55OwoJCQkJZWxzZQoJCQkJCXRoaXMub3JpZ01hcmdpblZlcnQgPSBkZXNpZ25lZFNjcmVlbi5oZWlnaHQgKiAwLjUgLSBpdGVtLnk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0JPVFRPTToKCQkJewoJCQkJaWYodHJ1ZSkKCQkJCQl0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gZGVzaWduZWRTY3JlZW4uaGVpZ2h0IC0gKGl0ZW0ucG9zaXRpb24ueSArIHRoaXMub3JpZ0JvdW5kcy5ib3R0b20pOwoJCQkJZWxzZQoJCQkJCXRoaXMub3JpZ01hcmdpblZlcnQgPSBkZXNpZ25lZFNjcmVlbi5oZWlnaHQgLSAoaXRlbS55ICsgdGhpcy5vcmlnQm91bmRzLmJvdHRvbSk7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJc3dpdGNoKHNldHRpbmdzLmhvcmlBbGlnbikKCQl7CgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fTEVGVDoKCQkJewoJCQkJaWYodHJ1ZSkKCQkJCQl0aGlzLm9yaWdNYXJnaW5Ib3JpID0gaXRlbS5wb3NpdGlvbi54ICsgdGhpcy5vcmlnQm91bmRzLng7CgkJCQllbHNlCgkJCQkJdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGl0ZW0ueCArIHRoaXMub3JpZ0JvdW5kcy54OwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSBVSVNjYWxlci5BTElHTl9DRU5URVI6CgkJCXsKCQkJCWlmKHRydWUpCgkJCQkJdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGRlc2lnbmVkU2NyZWVuLndpZHRoICogMC41IC0gaXRlbS5wb3NpdGlvbi54OwoJCQkJZWxzZQoJCQkJCXRoaXMub3JpZ01hcmdpbkhvcmkgPSBkZXNpZ25lZFNjcmVlbi53aWR0aCAqIDAuNSAtIGl0ZW0ueDsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fUklHSFQ6CgkJCXsKCQkJCWlmKHRydWUpCgkJCQkJdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGRlc2lnbmVkU2NyZWVuLndpZHRoIC0gKGl0ZW0ucG9zaXRpb24ueCArIHRoaXMub3JpZ0JvdW5kcy5yaWdodCk7CgkJCQllbHNlCgkJCQkJdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGRlc2lnbmVkU2NyZWVuLndpZHRoIC0gKGl0ZW0ueCArIHRoaXMub3JpZ0JvdW5kcy5yaWdodCk7CgkJCQlicmVhazsKCQkJfQoJCX0KCX07CgkKCXZhciBwID0gVUlFbGVtZW50LnByb3RvdHlwZSA9IHt9OwoKCS8qKgoJKiAgT3JpZ2luYWwgaG9yaXpvbnRhbCBtYXJnaW4gaW4gcGl4ZWxzCgkqICBAcHJvcGVydHkge051bWJlcn0gb3JpZ01hcmdpbkhvcmkKCSogIEBkZWZhdWx0IDAKCSovCglwLm9yaWdNYXJnaW5Ib3JpID0gMDsKCgkvKioKCSogIE9yaWdpbmFsIHZlcnRpY2FsIG1hcmdpbiBpbiBwaXhlbHMKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBvcmlnTWFyZ2luVmVydAoJKiAgQGRlZmF1bHQgMAoJKi8KCXAub3JpZ01hcmdpblZlcnQgPSAwOwoKCS8qKiAKCSogIE9yaWdpbmFsIHdpZHRoIGluIHBpeGVscyAKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBvcmlnV2lkdGgKCSogIEBkZWZhdWx0IDAKCSovCglwLm9yaWdXaWR0aCA9IDA7CgoJLyoqCgkqICBPcmlnaW5hbCBYIHNjYWxlIG9mIHRoZSBpdGVtCgkqICBAcHJvcGVydHkge051bWJlcn0gb3JpZ1NjYWxlWAoJKiAgQGRlZmF1bHQgMAoJKi8KCXAub3JpZ1NjYWxlWCA9IDA7CgoJLyoqCgkqICBUaGUgb3JpZ2luYWwgWSBzY2FsZSBvZiB0aGUgaXRlbQoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IG9yaWdTY2FsZVkKCSogIEBkZWZhdWx0IDAKCSovCglwLm9yaWdTY2FsZVkgPSAwOwoKCS8qKgoJKiAgVGhlIG9yaWdpbmFsIGJvdW5kcyBvZiB0aGUgaXRlbSB3aXRoIHgsIHksIHJpZ2h0LCBib3R0b20sIHdpZHRoLCBoZWlnaHQgcHJvcGVydGllcy4KCSogIFVzZWQgdG8gZGV0ZXJtaW5lIHRoZSBkaXN0YW5jZSB0byBlYWNoIGVkZ2Ugb2YgdGhlIGl0ZW0gZnJvbSBpdHMgb3JpZ2luCgkqICBAcHJvcGVydHkge09iamVjdH0gb3JpZ0JvdW5kcwoJKi8KCXAub3JpZ0JvdW5kcyA9IG51bGw7CgoJLyoqCgkqICBUaGUgcmVmZXJlbmNlIHRvIHRoZSBzY2FsZSBzZXR0aW5ncwoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7VUlFbGVtZW50U2V0dGluZ3N9IF9zZXR0aW5ncwoJKi8JCglwLl9zZXR0aW5ncyA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJmYWNlIGl0ZW0gd2UncmUgc2NhbGluZwoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IF9pdGVtCgkqLwoJcC5faXRlbSA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIG9yaWdpbmFsIHNjcmVlbiB0aGUgaXRlbSB3YXMgZGVzaWduZWQgZm9yCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtTY3JlZW5TZXR0aW5nc30gX2Rlc2lnbmVkU2NyZWVuCgkqLwoJcC5fZGVzaWduZWRTY3JlZW4gPSBudWxsOwoJCgkvKioKCSogIEFkanVzdCB0aGUgaXRlbSBzY2FsZSBhbmQgcG9zaXRpb24sIHRvIHJlZmxlY3QgbmV3IHNjcmVlbgoJKiAgQG1ldGhvZCByZXNpemUKCSogIEBwYXJhbSB7U2NyZWVuU2V0dGluZ3N9IG5ld1NjcmVlbiBUaGUgY3VycmVudCBzY3JlZW4gc2V0dGluZ3MKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKG5ld1NjcmVlbikKCXsKCQl2YXIgb3ZlcmFsbFNjYWxlID0gbmV3U2NyZWVuLmhlaWdodCAvIHRoaXMuX2Rlc2lnbmVkU2NyZWVuLmhlaWdodDsKCQl2YXIgcHBpU2NhbGUgPSBuZXdTY3JlZW4ucHBpIC8gdGhpcy5fZGVzaWduZWRTY3JlZW4ucHBpOwoJCXZhciBsZXR0ZXJCb3hXaWR0aCA9IChuZXdTY3JlZW4ud2lkdGggLSB0aGlzLl9kZXNpZ25lZFNjcmVlbi53aWR0aCAqIG92ZXJhbGxTY2FsZSkgLyAyOwoKCQkvLyBTY2FsZSBpdGVtIHRvIHRoZSBvdmVyYWxsU2NhbGUgdG8gbWF0Y2ggcmVzdCBvZiB0aGUgYXBwLCAKCQkvLyB0aGVuIGNsYW1wIGl0cyBwaHlzaWNhbCBzaXplIGFzIHNwZWNpZmllZCAKCQkvLyB0aGVuIHNldCB0aGUgaXRlbSdzIHNjYWxlIHRvIGJlIGNvcnJlY3QgLSB0aGUgc2NyZWVuIGlzIG5vdCBzY2FsZWQKCgkJLy9GdWxsIG1hdGg6CgkJLyp2YXIgcGh5c2ljYWxTY2FsZTpOdW1iZXIgPSBvdmVyYWxsU2NhbGUgLyBwcGlTY2FsZTsKCQl2YXIgaXRlbVNjYWxlOk51bWJlciA9IE1hdGhVdGlscy5jbGFtcChwaHlzaWNhbFNjYWxlLCBtaW5TY2FsZSwgbWF4U2NhbGUpIC8gcGh5c2ljYWxTY2FsZSAqIG92ZXJhbGxTY2FsZTsqLwoKCQkvL09wdGltaXplZCBtYXRoOgoJCXZhciBpdGVtU2NhbGUgPSBvdmVyYWxsU2NhbGUgLyBwcGlTY2FsZTsKCQlpZih0aGlzLl9zZXR0aW5ncy5taW5TY2FsZSAmJiBpdGVtU2NhbGUgPCB0aGlzLl9zZXR0aW5ncy5taW5TY2FsZSkKCQkJaXRlbVNjYWxlID0gdGhpcy5fc2V0dGluZ3MubWluU2NhbGU7CgkJZWxzZSBpZih0aGlzLl9zZXR0aW5ncy5tYXhTY2FsZSAmJiBpdGVtU2NhbGUgPiB0aGlzLl9zZXR0aW5ncy5tYXhTY2FsZSkKCQkJaXRlbVNjYWxlID0gdGhpcy5fc2V0dGluZ3MubWF4U2NhbGU7CgkJaXRlbVNjYWxlICo9IHBwaVNjYWxlOwoKCQlpZih0cnVlKQoJCXsKCQkJdGhpcy5faXRlbS5zY2FsZS54ID0gdGhpcy5vcmlnU2NhbGVYICogaXRlbVNjYWxlOwoJCQl0aGlzLl9pdGVtLnNjYWxlLnkgPSB0aGlzLm9yaWdTY2FsZVkgKiBpdGVtU2NhbGU7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuX2l0ZW0uc2NhbGVYID0gdGhpcy5vcmlnU2NhbGVYICogaXRlbVNjYWxlOwoJCQl0aGlzLl9pdGVtLnNjYWxlWSA9IHRoaXMub3JpZ1NjYWxlWSAqIGl0ZW1TY2FsZTsKCQl9CgoJCS8vIHBvc2l0aW9uaW5nCgkJdmFyIG07CgoJCS8vIHZlcnRpY2FsIG1vdmUKCQltID0gdGhpcy5vcmlnTWFyZ2luVmVydCAqIG92ZXJhbGxTY2FsZTsKCQkKCQkKCQlzd2l0Y2godGhpcy5fc2V0dGluZ3MudmVydEFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9UT1A6CgkJCXsKCQkJCWlmKHRydWUpCgkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gbSAtIHRoaXMub3JpZ0JvdW5kcy55ICogaXRlbVNjYWxlOwoJCQkJZWxzZQoJCQkJCXRoaXMuX2l0ZW0ueSA9IG0gLSB0aGlzLm9yaWdCb3VuZHMueSAqIGl0ZW1TY2FsZTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOgoJCQl7CgkJCQlpZih0cnVlKQoJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueSA9IG5ld1NjcmVlbi5oZWlnaHQgKiAwLjUgLSBtOwoJCQkJZWxzZQoJCQkJCXRoaXMuX2l0ZW0ueSA9IG5ld1NjcmVlbi5oZWlnaHQgKiAwLjUgLSBtOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSBVSVNjYWxlci5BTElHTl9CT1RUT006CgkJCXsKCQkJCWlmKHRydWUpCgkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gbmV3U2NyZWVuLmhlaWdodCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMuYm90dG9tICogaXRlbVNjYWxlOwoJCQkJZWxzZQoJCQkJCXRoaXMuX2l0ZW0ueSA9IG5ld1NjcmVlbi5oZWlnaHQgLSBtIC0gdGhpcy5vcmlnQm91bmRzLmJvdHRvbSAqIGl0ZW1TY2FsZTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQkvLyBob3Jpem9udGFsIG1vdmUKCQltID0gdGhpcy5vcmlnTWFyZ2luSG9yaSAqIG92ZXJhbGxTY2FsZTsKCQkKCQlzd2l0Y2godGhpcy5fc2V0dGluZ3MuaG9yaUFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9MRUZUOgoJCQl7CgkJCQlpZih0aGlzLl9zZXR0aW5ncy50aXRsZVNhZmUpCgkJCQl7CgkJCQkJaWYodHJ1ZSkKCQkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gbGV0dGVyQm94V2lkdGggKyBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGU7CgkJCQkJZWxzZQoJCQkJCQl0aGlzLl9pdGVtLnggPSBsZXR0ZXJCb3hXaWR0aCArIG0gLSB0aGlzLm9yaWdCb3VuZHMueCAqIGl0ZW1TY2FsZTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQlpZih0cnVlKQoJCQkJCQl0aGlzLl9pdGVtLnBvc2l0aW9uLnggPSBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGU7CgkJCQkJZWxzZQoJCQkJCQl0aGlzLl9pdGVtLnggPSBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGU7CgkJCQl9CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKCQkJewoJCQkJaWYodGhpcy5fc2V0dGluZ3MuY2VudGVyZWRIb3Jpem9udGFsbHkpCgkJCQl7CgkJCQkJaWYodHJ1ZSkKCQkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2l0ZW0ud2lkdGgpICogMC41OwoJCQkJCWVsc2UKCQkJCQkJdGhpcy5faXRlbS54ID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2l0ZW0ud2lkdGgpICogMC41OwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCWlmKHRydWUpCgkJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueCA9IG5ld1NjcmVlbi53aWR0aCAqIDAuNSAtIG07CgkJCQkJZWxzZQoJCQkJCQl0aGlzLl9pdGVtLnggPSBuZXdTY3JlZW4ud2lkdGggKiAwLjUgLSBtOwoJCQkJfQoJCQkJYnJlYWs7CgkJCX0JCgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fUklHSFQ6CgkJCXsKCQkJCWlmKHRoaXMuX3NldHRpbmdzLnRpdGxlU2FmZSkKCQkJCXsKCQkJCQlpZih0cnVlKQoJCQkJCQl0aGlzLl9pdGVtLnBvc2l0aW9uLnggPSBuZXdTY3JlZW4ud2lkdGggLSBsZXR0ZXJCb3hXaWR0aCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMucmlnaHQgKiBpdGVtU2NhbGU7CgkJCQkJZWxzZQoJCQkJCQl0aGlzLl9pdGVtLnggPSBuZXdTY3JlZW4ud2lkdGggLSBsZXR0ZXJCb3hXaWR0aCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMucmlnaHQgKiBpdGVtU2NhbGU7CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJaWYodHJ1ZSkKCQkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gbmV3U2NyZWVuLndpZHRoIC0gbSAtIHRoaXMub3JpZ0JvdW5kcy5yaWdodCAqIGl0ZW1TY2FsZTsKCQkJCQllbHNlCgkJCQkJCXRoaXMuX2l0ZW0ueCA9IG5ld1NjcmVlbi53aWR0aCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMucmlnaHQgKiBpdGVtU2NhbGU7CgkJCQl9CgkJCQlicmVhazsKCQkJfQkJCgkJfQoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoaXMgaXRlbSwgZG9uJ3QgdXNlIGFmdGVyIHRoaXMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLm9yaWdCb3VuZHMgPSBudWxsOwoJCXRoaXMuX2l0ZW0gPSBudWxsOwoJCXRoaXMuX3NldHRpbmdzID0gbnVsbDsKCQl0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuVUlFbGVtZW50ID0gVUlFbGVtZW50Owp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIFRoZSBVSSBJdGVtIFNldHRpbmdzIHdoaWNoIGlzIHRoZSBwb3NpdGlvbmluZyBzZXR0aW5ncyB1c2VkIHRvIGFkanVzdCBlYWNoIGVsZW1lbnQKCSogIEBtb2R1bGUgY2xvdWRraWQKCSogIEBjbGFzcyBVSUVsZW1lbnRTZXR0aW5ncwoJKi8KCXZhciBVSUVsZW1lbnRTZXR0aW5ncyA9IGZ1bmN0aW9uKCl7fTsKCQoJLy8gUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUKCXZhciBwID0gVUlFbGVtZW50U2V0dGluZ3MucHJvdG90eXBlID0ge307CgkKCS8qKiAKCSogIFdoYXQgdmVydGljYWwgc2NyZWVuIGxvY2F0aW9uIHRoZSBpdGVtIHNob3VsZCBiZSBhbGlnbmVkIHRvOiAidG9wIiwgImNlbnRlciIsICJib3R0b20iCgkqICBAcHJvcGVydHkge1N0cmluZ30gdmVydEFsaWduCgkqLwoJcC52ZXJ0QWxpZ24gPSBudWxsOwoKCS8qKiAKCSogIFdoYXQgaG9yaXpvbnRhbCBzY3JlZW4gbG9jYXRpb24gdGhlIGl0ZW0gc2hvdWxkIGJlIGFsaWduZWQgdG86ICJsZWZ0IiwgImNlbnRlciIsICJyaWdodCIKCSogIEBwcm9wZXJ0eSB7U3RyaW5nfSBob3JpQWxpZ24KCSovCglwLmhvcmlBbGlnbiA9IG51bGw7CgoJLyoqIAoJKiAgSWYgdGhpcyBlbGVtZW50IHNob3VsZCBiZSBhbGlnbmVkIHRvIHRoZSB0aXRsZSBzYWZlIGFyZWEsIG5vdCB0aGUgYWN0dWFsIHNjcmVlbiAKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gdGl0bGVTYWZlCgkqICBAZGVmYXVsdCBmYWxzZQoJKi8KCXAudGl0bGVTYWZlID0gZmFsc2U7CgoJLyoqIAoJKiAgTWF4aW11bSBzY2FsZSBhbGxvd2VkIGluIHBoeXNpY2FsIHNpemUgCgkqICBAcHJvcGVydHkge051bWJlcn0gbWF4U2NhbGUKCSogIEBkZWZhdWx0IDEKCSovCglwLm1heFNjYWxlID0gMTsKCgkvKiogCgkqICBNaW5pbXVtIHNjYWxlIGFsbG93ZWQgaW4gcGh5c2ljYWwgc2l6ZSAKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBtaW5TY2FsZQoJKiAgQGRlZmF1bHQgMQoJKi8KCXAubWluU2NhbGUgPSAxOwoJCgkvKioKCSogIElmIHRoZSBVSSBlbGVtZW50IGlzIGNlbnRlcmVkIGhvcml6b250YWxseQoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBjZW50ZXJlZEhvcml6b250YWxseQoJKiAgQGRlZmF1bHQgZmFsc2UKCSovCglwLmNlbnRlcmVkSG9yaXpvbnRhbGx5ID0gZmFsc2U7CgkKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5VSUVsZW1lbnRTZXR0aW5ncyA9IFVJRWxlbWVudFNldHRpbmdzOwp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvLyBDbGFzcyBpbXBvcnRzCgl2YXIgVUlFbGVtZW50U2V0dGluZ3MgPSBjbG91ZGtpZC5VSUVsZW1lbnRTZXR0aW5ncywKCQlVSUVsZW1lbnQgPSBjbG91ZGtpZC5VSUVsZW1lbnQsCgkJU2NyZWVuU2V0dGluZ3MgPSBjbG91ZGtpZC5TY3JlZW5TZXR0aW5nczsKCgkvKioKCSogICBUaGUgVUkgc2NhbGUgaXMgcmVzcG9uc2libGUgZm9yIHNjYWxpbmcgVUkgY29tcG9uZW50cwoJKiAgIHRvIGhlbHAgZWFzeSB0aGUgYnVyZGVuIG9mIGRpZmZlcmVudCBkZXZpY2UgYXNwZWN0IHJhdGlvcwoJKgoJKiAgQG1vZHVsZSBjbG91ZGtpZAoJKiAgQGNsYXNzIFVJU2NhbGVyCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudCBUaGUgVUkgZGlzcGxheSBjb250YWluZXIKCSogIEBwYXJhbSB7TnVtYmVyfSBkZXNpZ25lZFdpZHRoIFRoZSBkZXNpZ25lZCB3aWR0aCBvZiB0aGUgVUkKCSogIEBwYXJhbSB7TnVtYmVyfSBkZXNpZ25lZEhlaWdodCBUaGUgZGVzaWduZWQgaGVpZ2h0IG9mIHRoZSBVSQoJKiAgQHBhcmFtIHtOdW1iZXJ9IGRlc2lnbmVkUFBJIFRoZSBkZXNpZ25lZCBQUEkgb2YgdGhlIFVJCgkqLwoJdmFyIFVJU2NhbGVyID0gZnVuY3Rpb24ocGFyZW50LCBkZXNpZ25lZFdpZHRoLCBkZXNpZ25lZEhlaWdodCwgZGVzaWduZWRQUEkpCgl7CgkJdGhpcy5fcGFyZW50ID0gcGFyZW50OwoJCXRoaXMuX2l0ZW1zID0gW107CgkJdGhpcy5fZGVzaWduZWRTY3JlZW4gPSBuZXcgU2NyZWVuU2V0dGluZ3MoZGVzaWduZWRXaWR0aCwgZGVzaWduZWRIZWlnaHQsIGRlc2lnbmVkUFBJKTsKCX07CgkKCS8vIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlCgl2YXIgcCA9IFVJU2NhbGVyLnByb3RvdHlwZSA9IHt9OwoJCQkJCgkvKiogCgkqICBUaGUgY3VycmVudCBzY3JlZW4gc2V0dGluZ3MgCgkqICBAcHJvcGVydHkge1NjcmVlblNldHRpbmdzfSBjdXJyZW50U2NyZWVuCgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBjdXJyZW50U2NyZWVuID0gbmV3IFNjcmVlblNldHRpbmdzKDAsIDAsIDApOwoJCgkvKiogCgkqICBJZiB0aGUgc2NyZWVuc2l6ZSBoYXMgYmVlbiBzZXQgCgkqICBAcHJvcGVydHkge0Jvb2xlYW59IGluaXRpYWxpemVkCgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBpbml0aWFsaXplZCA9IGZhbHNlOwoJCgkvKiogCgkqICBUaGUgVUkgZGlzcGxheSBvYmplY3QgdG8gdXBkYXRlIAoJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fFBJWEkuRGlzcGxheU9iamVjdH0gX3BhcmVudAoJKiAgQHByaXZhdGUKCSovCglwLl9wYXJlbnQgPSBudWxsOwoJCgkvKiogCgkqICBUaGUgc2NyZWVuIHNldHRpbmdzIG9iamVjdCwgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgZGVzaWduZWQgc2l6ZSAKCSogIEBwcm9wZXJ0eSB7U2NyZWVuU2V0dGluZ3N9IF9kZXNpZ25lZFNjcmVlbgoJKiAgQHByaXZhdGUKCSovCglwLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CgkKCS8qKiAKCSogIFRoZSBjb25maWd1cmF0aW9uIGZvciBlYWNoIGl0ZW1zCgkqICBAcHJvcGVydHkge0FycmF5fSBfaXRlbXMKCSogIEBwcml2YXRlCgkqLwoJcC5faXRlbXMgPSBudWxsOwoJCgkvKioKCSogIFZlcnRpY2FsbHkgYWxpZ24gdG8gdGhlIHRvcAoJKiAgQHByb3BlcnR5IHtTdHJpbmd9IEFMSUdOX1RPUAoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJ0b3AiCgkqLwoJVUlTY2FsZXIuQUxJR05fVE9QID0gInRvcCI7CgoJLyoqCgkqICBWZXJ0aWNhbGx5IGFsaWduIHRvIHRoZSBib3R0b20KCSogIEBwcm9wZXJ0eSB7U3RyaW5nfSBBTElHTl9CT1RUT00KCSogIEBzdGF0aWMKCSogIEBmaW5hbAoJKiAgQHJlYWRPbmx5CgkqICBAZGVmYXVsdCAiYm90dG9tIgoJKi8KCVVJU2NhbGVyLkFMSUdOX0JPVFRPTSA9ICJib3R0b20iOwoKCS8qKgoJKiAgSG9yaXpvbnRhbGx5IGFsaWduIHRvIHRoZSBsZWZ0CgkqICBAcHJvcGVydHkge1N0cmluZ30gQUxJR05fTEVGVAoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJsZWZ0IgoJKi8KCVVJU2NhbGVyLkFMSUdOX0xFRlQgPSAibGVmdCI7CgoJLyoqCgkqICBIb3Jpem9udGFsbHkgYWxpZ24gdG8gdGhlIHJpZ2h0CgkqICBAcHJvcGVydHkge1N0cmluZ30gQUxJR05fUklHSFQKCSogIEBzdGF0aWMKCSogIEBmaW5hbAoJKiAgQHJlYWRPbmx5CgkqICBAZGVmYXVsdCAicmlnaHQiCgkqLwoJVUlTY2FsZXIuQUxJR05fUklHSFQgPSAicmlnaHQiOwoKCS8qKgoJKiAgVmVydGljYWxseSBvciBob3Jpem9udGFsbHkgYWxpZ24gdG8gdGhlIGNlbnRlcgoJKiAgQHByb3BlcnR5IHtTdHJpbmd9IEFMSUdOX0NFTlRFUgoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJjZW50ZXIiCgkqLwoJVUlTY2FsZXIuQUxJR05fQ0VOVEVSID0gImNlbnRlciI7CgkKCS8qKgoJKiAgQ3JlYXRlIHRoZSBzY2FsZXIgZnJvbSBKU09OIGRhdGEKCSogIEBtZXRob2QgZnJvbUpTT04KCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudCBUaGUgVUkgZGlzcGxheSBjb250YWluZXIKCSogIEBwYXJhbSB7T2JqZWN0fSBqc29uU2V0dGluZ3MgVGhlIGpzb24gb2YgdGhlIGRlc2lnbmVkIHNldHRpbmdzIHtkZXNpZ25lZFdpZHRoOjgwMCwgZGVzaWduZWRIZWlnaHQ6NjAwLCBkZXNpZ25lZFBQSTo3Mn0KCSogIEBwYXJhbSB7T2JqZWN0fSBqc29uSXRlbXMgVGhlIGpzb24gaXRlbXMgb2JqZWN0IHdoZXJlIHRoZSBrZXlzIGFyZSB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgb24gdGhlIHBhcmVudCBhbmQgdGhlIHZhbHVlCgkqICAgICAgICAgaXMgYW4gb2JqZWN0IHdpdGgga2V5cyBvZiAidGl0bGVTYWZlIiwgIm1pblNjYWxlIiwgIm1heFNjYWxlIiwgImNlbnRlckhvcml6b250YWxseSIsICJhbGlnbiIKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW2ltbWVkaWF0ZURlc3Ryb3k9dHJ1ZV0gSWYgd2Ugc2hvdWxkIGltbWVkaWF0ZWx5IGNsZWFudXAgdGhlIFVJU2NhbGVyIGFmdGVyIHNjYWxpbmcgaXRlbXMKCSogIEByZXR1cm4ge1VJU2NhbGVyfSBUaGUgc2NhbGVyIG9iamVjdCB0aGF0IGNhbiBiZSByZXVzZWQKCSovCglVSVNjYWxlci5mcm9tSlNPTiA9IGZ1bmN0aW9uKHBhcmVudCwganNvblNldHRpbmdzLCBqc29uSXRlbXMsIGltbWVkaWF0ZURlc3Ryb3kpCgl7CgkJaWYgKHR5cGVvZiBpbW1lZGlhdGVEZXN0cm95ICE9ICJib29sZWFuIikgaW1tZWRpYXRlRGVzdHJveSA9IHRydWU7CgkJCQoJCXZhciBzY2FsZXIgPSBuZXcgVUlTY2FsZXIoCgkJCXBhcmVudCwgCgkJCWpzb25TZXR0aW5ncy5kZXNpZ25lZFdpZHRoLAoJCQlqc29uU2V0dGluZ3MuZGVzaWduZWRIZWlnaHQsCgkJCWpzb25TZXR0aW5ncy5kZXNpZ25lZFBQSQoJCSk7CgkJCgkJLy8gVGVtcCB2YXJpYWJsZXMKCQl2YXIgaXRlbSwgaSwgYWxpZ24sIHZlcnRBbGlnbiwgaG9yaUFsaWduOwoJCQoJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIGl0ZW1zIGFuZCByZWdpc3RlcgoJCS8vIGVhY2ggZHBlbmRpbmcgb24gdGhlIHNldHRpbmdzCgkJZm9yKGkgaW4ganNvbkl0ZW1zKQoJCXsKCQkJaXRlbSA9IGpzb25JdGVtc1tpXTsKCQkJCgkJCWlmIChpdGVtLmFsaWduKQoJCQl7CgkJCQlhbGlnbiA9IGl0ZW0uYWxpZ24uc3BsaXQoIi0iKTsKCQkJCXZlcnRBbGlnbiA9IGFsaWduWzBdOwoJCQkJaG9yaUFsaWduID0gYWxpZ25bMV07CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQl2ZXJ0QWxpZ24gPSBBTElHTl9DRU5URVI7CgkJCQlob3JpQWxpZ24gPSBBTElHTl9DRU5URVI7CgkJCX0KCQkJc2NhbGVyLmFkZCgKCQkJCXBhcmVudFtpXSwgCgkJCQl2ZXJ0QWxpZ24sCgkJCQlob3JpQWxpZ24sCgkJCQlpdGVtLnRpdGxlU2FmZSB8fCBmYWxzZSwKCQkJCWl0ZW0ubWluU2NhbGUgfHwgTmFOLAoJCQkJaXRlbS5tYXhTY2FsZSB8fCBOYU4sCgkJCQlpdGVtLmNlbnRlcmVkSG9yaXpvbnRhbGx5IHx8IGZhbHNlCgkJCSk7CgkJfQoJCQoJCS8vIFNjYWxlIHRoZSBpdGVtcwoJCXNjYWxlci5yZXNpemUoKTsKCQkKCQlpZiAoaW1tZWRpYXRlRGVzdHJveSkKCQl7CgkJCXNjYWxlci5kZXN0cm95KCk7CgkJfQoJCXJldHVybiBzY2FsZXI7Cgl9OwoJCgkvKioKCSogICBTZXQgdGhlIGN1cnJlbnQgc2NyZWVuIHNldHRpbmdzLiBJZiB0aGUgc3RhZ2Ugc2l6ZSBjaGFuZ2VzIGF0IGFsbCwgcmUtY2FsbCB0aGlzIGZ1bmN0aW9uCgkqICAgQG1ldGhvZCBpbml0CgkqICAgQHN0YXRpYwoJKiAgIEBwYXJhbSB7TnVtYmVyfSBzY3JlZW5XaWR0aCBUaGUgZnVsbHNjcmVlbiB3aWR0aAoJKiAgIEBwYXJhbSB7TnVtYmVyfSBzY3JlZW5IZWlnaHQgVGhlIGZ1bGxzY3JlZW4gaGVpZ2h0CgkqICAgQHBhcmFtIHtOdW1iZXJ9IHNjcmVlblBQSSBUaGUgc2NyZWVuIHJlc29sdXRpb24gZGVuc2l0eQoJKi8KCVVJU2NhbGVyLmluaXQgPSBmdW5jdGlvbihzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0LCBzY3JlZW5QUEkpCgl7CgkJY3VycmVudFNjcmVlbi53aWR0aCA9IHNjcmVlbldpZHRoOwoJCWN1cnJlbnRTY3JlZW4uaGVpZ2h0ID0gc2NyZWVuSGVpZ2h0OwoJCWN1cnJlbnRTY3JlZW4ucHBpID0gc2NyZWVuUFBJOwoJCWluaXRpYWxpemVkID0gdHJ1ZTsKCX07CgoJLyoqCgkqICBHZXQgdGhlIGN1cnJlbnQgc2NhbGUgb2YgdGhlIHNjcmVlbgoJKiAgQG1ldGhvZCBnZXRTY2FsZQoJKiAgQHJldHVybiB7TnVtYmVyfSBUaGUgY3VycmVudCBzdGFnZSBzY2FsZQoJKi8KCXAuZ2V0U2NhbGUgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIGN1cnJlbnRTY3JlZW4uaGVpZ2h0IC8gdGhpcy5fZGVzaWduZWRTY3JlZW4uaGVpZ2h0OwoJfTsKCQoJLyoqCgkqICAgTWFudWFsbHkgYWRkIGFuIGl0ZW0gCgkqICAgQG1ldGhvZCBhZGQKCSogICBAcGFyYW0ge2NyZWF0ZWpzLkRpc3BsYXlPYmplY3R8UElYSS5EaXNwbGF5T2JqZWN0fSBpdGVtIFRoZSBkaXNwbGF5IG9iamVjdCBpdGVtIHRvIGFkZAoJKiAgIEBwYXJhbSB7U3RyaW5nfSBbdmVydEFsaWduPSJjZW50ZXIiXSBUaGUgdmVydGljYWwgYWxpZ24gb2YgdGhlIGl0ZW0gKGNlZmF1bHQgaXMgY2VudGVyKQoJKiAgIEBwYXJhbSB7U3RyaW5nfSBbaG9yaUFsaWduPSJjZW50ZXIiXSBUaGUgaG9yaXpvbnRhbCBhbGlnbiBvZiB0aGUgaXRlbSAoZGVmYXVsdCBpcyBjZW50ZXIpCgkqICAgQHBhcmFtIHtCb29sZWFufSBbdGl0bGVTYWZlPWZhbHNlXSBJZiB0aGUgaXRlbSBuZWVkcyB0byBiZSBpbiB0aGUgdGl0bGUgc2FmZSBhcmVhIChkZWZhdWx0IGlzIGZhbHNlKQoJKiAgIEBwYXJhbSB7TnVtYmVyfSBbbWluU2NhbGU9MV0gVGhlIG1pbmltdW0gc2NhbGUgYW1vdW50IChkZWZhdWx0LCBzY2FsZXMgdGhlIHNhbWUgc2l6ZSBhcyB0aGUgc3RhZ2UpCgkqICAgQHBhcmFtIHtOdW1iZXJ9IFttYXhTY2FsZT0xXSBUaGUgbWF4aW11bSBzY2FsZSBhbW91bnQgKGRlZmF1bHQsIHNjYWxlcyB0aGUgc2FtZSBzaXplIGFzIHRoZSBzdGFnZSkKCSogICBAcGFyYW0ge0Jvb2xlYW59IFtjZW50ZXJlZEhvcml6b250YWxseT1mYWxzZV0gTWFrZXMgc3VyZSB0aGF0IHRoZSBjZW50ZXIgb2YgdGhlIG9iamVjdCB3YXMgYXQgdGhlIGNlbnRlciBvZiB0aGUgc2NyZWVuLCBhc3N1bWluZyBhbiBvcmlnaW4gYXQgdGhlIHRvcCBsZWZ0IG9mIHRoZSBvYmplY3QKCSovCglwLmFkZCA9IGZ1bmN0aW9uKGl0ZW0sIHZlcnRBbGlnbiwgaG9yaUFsaWduLCB0aXRsZVNhZmUsIG1pblNjYWxlLCBtYXhTY2FsZSwgY2VudGVyZWRIb3Jpem9udGFsbHkpCgl7CgkJLy8gQ3JlYXRlIHRoZSBpdGVtIHNldHRpbmdzCgkJdmFyIHMgPSBuZXcgVUlFbGVtZW50U2V0dGluZ3MoKTsKCQkKCQlzLnZlcnRBbGlnbiA9IHZlcnRBbGlnbiB8fCBVSVNjYWxlci5BTElHTl9DRU5URVI7CgkJcy5ob3JpQWxpZ24gPSBob3JpQWxpZ24gfHwgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOwoJCXMudGl0bGVTYWZlID0gKHR5cGVvZiB0aXRsZVNhZmUgIT0gImJvb2xlYW4iKSA/IGZhbHNlIDogdGl0bGVTYWZlOwoJCXMubWF4U2NhbGUgPSAodHlwZW9mIG1heFNjYWxlICE9ICJudW1iZXIiKSA/IE5hTiA6IG1heFNjYWxlOwoJCXMubWluU2NhbGUgPSAodHlwZW9mIG1pblNjYWxlICE9ICJudW1iZXIiKSA/IE5hTiA6IG1pblNjYWxlOwoJCXMuY2VudGVyZWRIb3Jpem9udGFsbHkgPSBjZW50ZXJlZEhvcml6b250YWxseSB8fCBmYWxzZTsKCQkJCQoJCXRoaXMuX2l0ZW1zLnB1c2gobmV3IFVJRWxlbWVudChpdGVtLCBzLCB0aGlzLl9kZXNpZ25lZFNjcmVlbikpOwoJfTsKCQoJLyoqCgkqICAgU2NhbGUgYSBzaW5nbGUgYmFja2dyb3VuZCBpbWFnZSBhY2NvcmRpbmcgdG8gdGhlIFVJU2NhbGVyLndpZHRoIGFuZCBoZWlnaHQKCSogICBAbWV0aG9kIHJlc2l6ZUJhY2tncm91bmQKCSogICBAc3RhdGljCgkqICAgQHBhcmFtIHtjcmVhdGVqcy5CaXRtYXB8UElYSS5CaXRtYXB9IFRoZSBiaXRtYXAgdG8gc2NhbGUKCSovCglVSVNjYWxlci5yZXNpemVCYWNrZ3JvdW5kID0gZnVuY3Rpb24oYml0bWFwKQoJewoJCWlmICghaW5pdGlhbGl6ZWQpIHJldHVybjsKCQkKCQl2YXIgaCwgdywgc2NhbGU7CgkJaWYodHJ1ZSkKCQl7CgkJCWggPSBiaXRtYXAuaGVpZ2h0IC8gYml0bWFwLnNjYWxlLnk7CgkJCXcgPSBiaXRtYXAud2lkdGggLyBiaXRtYXAuc2NhbGUueDsKCgkJCS8vc2NhbGUgdGhlIGJhY2tncm91bmQKCQkJc2NhbGUgPSBjdXJyZW50U2NyZWVuLmhlaWdodCAvIGg7CgkJCWJpdG1hcC5zY2FsZS54ID0gYml0bWFwLnNjYWxlLnkgPSBzY2FsZTsKCQkJCgkJCS8vY2VudGVyIHRoZSBiYWNrZ3JvdW5kCgkJCWJpdG1hcC5wb3NpdGlvbi54ID0gKGN1cnJlbnRTY3JlZW4ud2lkdGggLSBiaXRtYXAud2lkdGgpICogMC41OwoJCX0KCQllbHNlIGlmKGZhbHNlKQoJCXsKCQkJaCA9IGJpdG1hcC5pbWFnZS5oZWlnaHQ7CgkJCXcgPSBiaXRtYXAuaW1hZ2Uud2lkdGg7CgoJCQkvL3NjYWxlIHRoZSBiYWNrZ3JvdW5kCgkJCXNjYWxlID0gY3VycmVudFNjcmVlbi5oZWlnaHQgLyBoOwoJCQliaXRtYXAuc2NhbGVYID0gYml0bWFwLnNjYWxlWSA9IHNjYWxlOwoJCQkKCQkJLy9jZW50ZXIgdGhlIGJhY2tncm91bmQKCQkJYml0bWFwLnggPSAoY3VycmVudFNjcmVlbi53aWR0aCAtIHcgKiBzY2FsZSkgKiAwLjU7CgkJfQoJfTsKCQoJLyoqCgkqICBDb252ZW5pZW5jZSBmdW5jdGlvbiB0byBzY2FsZSBhIGNvbGxlY3Rpb24gb2YgYmFja2dyb3VuZHMKCSogIEBtZXRob2QgcmVzaXplQmFja2dyb3VuZHMKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7QXJyYXl9IGJpdG1hcHMgVGhlIGNvbGxlY3Rpb24gb2YgYml0bWFwIGltYWdlcwoJKi8KCVVJU2NhbGVyLnJlc2l6ZUJhY2tncm91bmRzID0gZnVuY3Rpb24oYml0bWFwcykKCXsKCQlmb3IodmFyIGkgPSAwLCBsZW4gPSBiaXRtYXBzLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCXsKCQkJVUlTY2FsZXIucmVzaXplQmFja2dyb3VuZChiaXRtYXBzW2ldKTsKCQl9Cgl9OwoJCgkvKioKCSogIFNjYWxlIHRoZSBVSSBpdGVtcyB0aGF0IGhhdmUgYmVlbiByZWdpc3RlcmVkIHRvIHRoZSBjdXJyZW50IHNjcmVlbgoJKiAgQG1ldGhvZCByZXNpemUKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAodGhpcy5faXRlbXMubGVuZ3RoID4gMCkKCQl7CgkJCWZvcih2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2l0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCQl7CgkJCQl0aGlzLl9pdGVtc1tpXS5yZXNpemUoY3VycmVudFNjcmVlbik7CgkJCX0KCQl9Cgl9OwoJCgkvKioKCSogIERlc3Ryb3kgdGhlIHNjYWxlciBvYmplY3QKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAodGhpcy5faXRlbXMubGVuZ3RoID4gMCkKCQl7CgkJCWZvcih2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2l0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCQl7CgkJCQl0aGlzLl9pdGVtc1tpXS5kZXN0cm95KCk7CgkJCX0KCQl9CgkJCgkJdGhpcy5fcGFyZW50ID0gbnVsbDsKCQl0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CgkJdGhpcy5faXRlbXMgPSBudWxsOwoJfTsKCQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLlVJU2NhbGVyID0gVUlTY2FsZXI7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpIHsKCQoJInVzZSBzdHJpY3QiOwoKCS8qKgoJKiAgW1BJWEktb25seV0gQXNzZXQgTWFuYWdlciBpcyByZXNwb25zaWJsZSBmb3IgbWFuYWdpbmcgZGlmZmVyZW50IHJlc29sdXRpb25zIG9mIGFzc2V0cyBhbmQgc3ByaXRlc2hlZXRzCgkqICBiYXNlZCBvbiB0aGUgcmVzb2x1dGlvbiBvZiB0aGUgc3RhZ2UuIFRoaXMgaXMgYSBoZWxwZnVsIG9wdGltaXphdGlvbiBmb3IgUElYSSB3aGljaCBzb21lIGxvdy1oYXJkd2FyZQoJKiAgZGV2aWNlcyBoYXZlIGEgcHJvYmxlbSBrZWVwaW5nIHVwIHdpdGguCgkqCgkqICBAY2xhc3MgQXNzZXRNYW5hZ2VyIChQSVhJKQoJKi8KCXZhciBBc3NldE1hbmFnZXIgPSB7fTsKCQoJLyoqIAoJKiAgRGljdGlvbmFyeSBvZiBzY2FsZXMgYnkgYXNzZXQgaWQgCgkqICBAcHJvcGVydHkge09iamVjdH0gc2NhbGVzCgkqICBAZmluYWwKCSogIEBzdGF0aWMKCSovCglBc3NldE1hbmFnZXIuc2NhbGVzID0gbnVsbDsKCgkvKioKCSogIFRoZSBhdmFpbGFibGUgc2l6ZSBkZWZpbml0aW9ucywgZS5nLiwgeyJtYXhTaXplIjo0MDAsICJvcmRlciI6IFsidGlueSIsICJzZCJdfQoJKiAgQHByb3BlcnR5IHtBcnJheX0gc2l6ZXMKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJdmFyIHNpemVzID0gbnVsbDsKCgkvKiogCgkqICBEaWN0aW9uYXJ5IG9mIGFzc2V0cyBieSBhc3NldCBpZCAKCSogIEBwcm9wZXJ0eSB7T2JqZWN0fSBhc3NldHMKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJdmFyIGFzc2V0cyA9IG51bGw7CgoJLyoqIAoJKiAgVGhlIGNhY2hlIG9mIGFzc2V0IHVybCBwYXRocwoJKiAgQHByb3BlcnR5IHtPYmplY3R9IGFzc2V0VXJsQ2FjaGUKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJdmFyIGFzc2V0VXJsQ2FjaGUgPSBudWxsOwoKCS8qKiAKCSogIFRoZSBzY2FsaW5nIHZhbHVlIGZvciBlYWNoIGFzc2V0IHNpemUgaWQsIGUuZy4sIHsic2QiIDogMSwgInRpbnkiIDogMn0KCSogIEBwcm9wZXJ0eSB7T2JqZWN0fSBzY2FsZXMKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJdmFyIHNjYWxlcyA9IG51bGw7CgoJLyoqCgkqICBUaGUgcGF0aHMgdG8gZWFjaCByZXNvbHV0aW9uIGZvbGRlciwgZS5nLiwgeyJzZCI6ImltYWdlcy9zZC8iLCAidGlueSI6ImltYWdlcy90aW55LyJ9CgkqICBAcHJvcGVydHkge09iamVjdH0gcGF0aHMKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJdmFyIHBhdGhzID0gbnVsbDsKCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIHBlcmZlcnJlZCBzaXplIHRvIGxvYWQKCSogIEBwcm9wZXJ0eSB7QXJyYXl9IHNpemVPcmRlcgoJKiAgQHByaXZhdGUKCSogIEBzdGF0aWMKCSovCgl2YXIgc2l6ZU9yZGVyID0gbnVsbDsKCgkvKioKCSogIElmIHdlIHNob3VsZCB1c2UgbG93IGhhcmR3YXJlLCBpZiB3ZSBrbm93IHdlJ3JlIG9uIGEgc2xvdyBkZXZpY2UKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gbG93SFcKCSogIEBzdGF0aWMKCSovCglBc3NldE1hbmFnZXIubG93SFcgPSBmYWxzZTsKCQoJLyoqCgkqICBJbml0aWFsaXplIHRoZSBhc3NldCBtYW5hZ2VyCgkqICBAbWV0aG9kIGluaXQKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGNvbmZpZ3VyYXRpb24gZmlsZSB3aGljaCBjb250YWlucyBrZXlzIGZvciAicGF0aCIsICJzY2FsZSIsICJzaXppbmciLCAiYXNzZXRzIgoJKiAgQHBhcmFtIHtOdW1iZXJ9IHdpZHRoIFRoZSBzdGFnZSB3aWR0aAoJKiAgQHBhcmFtIHtOdW1iZXJ9IGhlaWdodCBUaGUgc3RhZ2UgaGVpZ2h0CgkqLwoJQXNzZXRNYW5hZ2VyLmluaXQgPSBmdW5jdGlvbihjb25maWcsIHdpZHRoLCBoZWlnaHQpCgl7CgkJQXNzZXRNYW5hZ2VyLnNjYWxlcyA9IHt9OwoJCWFzc2V0cyA9IGNvbmZpZy5hc3NldHM7CgkJYXNzZXRVcmxDYWNoZSA9IHt9OwoJCXBhdGhzID0gY29uZmlnLnBhdGg7CgkJc2l6ZXMgPSBjb25maWcuc2l6aW5nOwoJCXNjYWxlcyA9IGNvbmZpZy5zY2FsZTsKCQlwaWNrU2NhbGUod2lkdGgsIGhlaWdodCk7Cgl9OwoJCgkvKioKCSogIEdldCB0aGUgYWxpYXMgb2YgdGhlIHByZWZlcnJlZCBzaXplIHRvIHVzZQoJKiAgQG1ldGhvZCBnZXRQcmVmZXJyZWRTaXplCgkqICBAc3RhdGljCgkqICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBhbGlhcyBmb3IgdGhlIHByZWZlcnJlZCBzaXplCgkqLwoJQXNzZXRNYW5hZ2VyLmdldFByZWZlcnJlZFNpemUgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIHNpemVPcmRlclswXTsKCX07CgkKCS8qKgoJKiAgR2V0IHRoZSBwcmVmZXJyZWQgc2NhbGUgYW1vdW50CgkqICBAbWV0aG9kIGdldFByZWZlcnJlZFNjYWxlCgkqICBAc3RhdGljCgkqICBAcmV0dXJuIHtOdW1iZXJ9IFRoZSBzY2FsZSBhbW91bnQgYXNzb2NpYXRlZCB3aXRoIHRoZSBwcmVmZXJyZWQgc2l6ZQoJKi8KCUFzc2V0TWFuYWdlci5nZXRQcmVmZXJyZWRTY2FsZSA9IGZ1bmN0aW9uKCkKCXsKCQlyZXR1cm4gc2NhbGVzW3NpemVPcmRlclswXV07Cgl9OwoJCgkvKioKCSogIFBpY2sgdGhlIHByZWZlcnJlZCBzY2FsZSBiYXNlZCBvbiB0aGUgc2NyZWVuIHJlc29sdXRpb24KCSogIEBtZXRob2QgcGlja1NjYWxlCgkqICBAcHJpdmF0ZQoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtOdW1iZXJ9IHdpZHRoIFRoZSBzdGFnZSB3aWR0aAoJKiAgQHBhcmFtIHtOdW1iZXJ9IGhlaWdodCBUaGUgc3RhZ2UgaGVpZ2h0CgkqLwoJdmFyIHBpY2tTY2FsZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCgl7CgkJdmFyIG1pblNpemUgPSB3aWR0aCA8IGhlaWdodCA/IHdpZHRoIDogaGVpZ2h0OwoJCXZhciBzOwoJCWZvcih2YXIgaSA9IHNpemVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKQoJCXsKCQkJaWYoc2l6ZXNbaV0ubWF4U2l6ZSA+IG1pblNpemUpCgkJCQlzID0gc2l6ZXNbaV07CgkJCWVsc2UJCgkJCQlicmVhazsKCQl9CgkJc2l6ZU9yZGVyID0gcy5vcmRlcjsKCX07CgkKCS8qKgoJKiAgR2V0IGEgYXNzZXQgdXJsIGJ5IGFzc2V0IGlkCgkqICBAbWV0aG9kIGdldFVybAoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IGFzc2V0SWQgVGhlIHVuaXF1ZSBhc3NldCBrZHkKCSovCglBc3NldE1hbmFnZXIuZ2V0VXJsID0gZnVuY3Rpb24oYXNzZXRJZCkKCXsKCQl2YXIgYSA9IGFzc2V0c1thc3NldElkXTsKCQlpZighYSkgcmV0dXJuIG51bGw7CgkJCgkJaWYoYXNzZXRVcmxDYWNoZVthc3NldElkXSkKCQkJcmV0dXJuIGFzc2V0VXJsQ2FjaGVbYXNzZXRJZF07CgkJCgkJdmFyIHVybDsKCQlpZihhLmFuaW0pCgkJewoJCQl1cmwgPSBhc3NldFVybENhY2hlW2Fzc2V0SWRdID0gcGF0aHMuYW5pbSArIGEuc3JjOwoJCQlyZXR1cm4gdXJsOwoJCX0KCgkJaWYoQXNzZXRNYW5hZ2VyLmxvd0hXICYmIGEubG93SFcpCgkJewoJCQlBc3NldE1hbmFnZXIuc2NhbGVzW2Fzc2V0SWRdID0gc2NhbGVzW2EubG93SFddOwoJCQl1cmwgPSBhc3NldFVybENhY2hlW2Fzc2V0SWRdID0gcGF0aHNbYS5sb3dIV10gKyBhLnNyYzsKCQkJcmV0dXJuIHVybDsKCQl9CgkJCgkJZm9yKHZhciBpID0gMDsgaSA8IHNpemVPcmRlci5sZW5ndGg7ICsraSkKCQl7CgkJCXZhciB0eXBlSWQgPSBzaXplT3JkZXJbaV07CgkJCWlmKGFbdHlwZUlkXSkKCQkJewoJCQkJQXNzZXRNYW5hZ2VyLnNjYWxlc1thc3NldElkXSA9IHNjYWxlc1t0eXBlSWRdOwoJCQkJdXJsID0gYXNzZXRVcmxDYWNoZVthc3NldElkXSA9IHBhdGhzW3R5cGVJZF0gKyBhLnNyYzsKCQkJCXJldHVybiB1cmw7CgkJCX0KCQl9CgkJcmV0dXJuIG51bGw7Cgl9OwoJCgkvKioKCSogIFVubG9hZCBhbiBhc3NldAoJKiAgQG1ldGhvZCB1bmxvYWQKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7QXJyYXl8U3RyaW5nfSBhc3NldE9yQXNzZXQgVGhlIGNvbGxlY3Rpb24gb2YgYXNzZXRzIG9yIHNpbmdsZSBhc3NldCBpZAoJKi8KCUFzc2V0TWFuYWdlci51bmxvYWQgPSBmdW5jdGlvbihhc3NldE9yQXNzZXRzKQoJewoJCWlmKGFzc2V0T3JBc3NldHMgaW5zdGFuY2VvZiBBcnJheSkKCQl7CgkJCWZvcih2YXIgaSA9IGFzc2V0T3JBc3NldHMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpCgkJCXsKCQkJCXZhciBpZCA9IGFzc2V0T3JBc3NldHNbaV07CgkJCQl1bmxvYWRBc3NldChpZCk7CgkJCX0KCQl9CgkJZWxzZS8vc3RyaW5nCgkJewoJCQl1bmxvYWRBc3NldChhc3NldE9yQXNzZXRzKTsKCQl9Cgl9OwoKCS8qKgoJKiAgVW5sb2FkIGFuIGFzc2V0CgkqICBAbWV0aG9kIHVubG9hZEFzc2V0CgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKiAgQHBhcmFtIHtTdHJpbmd9IGFzc2V0IFRoZSBhc3NldCBpZCB0byB1bmxvYWQKCSovCgl2YXIgdW5sb2FkQXNzZXQgPSBmdW5jdGlvbihhc3NldCkKCXsKCQlpZighYXNzZXRVcmxDYWNoZVthc3NldF0pIHJldHVybjsvL2lmIHRoaXMgZG9lc24ndCBleGlzdCwgdGhlbiBpdCB3YXNuJ3QgbG9hZGVkCgkJdmFyIGEgPSBhc3NldHNbYXNzZXRdOwoJCWlmKCFhKSByZXR1cm47Ly9hc3NldCBuZXZlciBleGlzdGVkIGluIHRoZSBtYXN0ZXIgbGlzdAoJCWlmKGEuYW5pbSkgcmV0dXJuOy8vZG9uJ3QgdW5sb2FkIHRoZXNlLCB0aGV5IGFyZSBwcmV0dHkgc21hbGwKCQlpZihhLmlzRm9udCkKCQl7CgkJCWlmKFBJWEkuQml0bWFwVGV4dC5mb250c1thc3NldF0pCgkJCQlkZWxldGUgUElYSS5CaXRtYXBUZXh0LmZvbnRzW2Fzc2V0XTsKCQl9CgkJLy9hbnl0aGluZyBlbHNlIGlzIGEgdGV4dHVyZQoJCVBJWEkuVGV4dHVyZS5kZXN0cm95VGV4dHVyZShhc3NldFVybENhY2hlW2Fzc2V0XSk7CgkJZGVsZXRlIEFzc2V0TWFuYWdlci5zY2FsZXNbYXNzZXRdOwoJCWRlbGV0ZSBhc3NldFVybENhY2hlW2Fzc2V0XTsKCX07CgoJLyoqCgkqICBHZXQgdGhlIGNvbGxlY3Rpb24gb2YgYXNzZXRzIHRoYXQgYXJlIGFsc28gYW5pbWF0aW9ucwoJKiAgQG1ldGhvZCBnZXRBbmltcwoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtPYmplY3R9IGFuaW1zIFRoZSBkaWN0aW9uYXJ5IG9mIGFuaW1hdGlvbiBhc3NldHMKCSogIEBwYXJhbSB7aW50fSBbbWF4RGlnaXRzPTRdIE1heGltdW0gbnVtYmVyIG9mIGRpZ2l0cywgbGlrZSA0IGZvciBhbiBhbmltYXRpb24gZXhwb3J0ZWQgYXMgYW5pbV8wMDAxLnBuZwoJKiAgQHBhcmFtIHtPYmplY3R9IFtvdXRPYmpdIElmIGFscmVhZHkgdXNpbmcgYW4gcmV0dXJuIG9iamVjdAoJKiAgQHJldHVybiB7T2JqZWN0fSBBbiBjb2xsZWN0aW9uIG9mIFBJWEkuVGV4dHVyZXMgZm9yIGVhY2ggYW5pbWF0aW9uIGlkIHN1aXRhYmxlIGZvciB1c2UgaW4gUElYSS5Nb3ZpZUNsaXAKCSovCglBc3NldE1hbmFnZXIuZ2V0QW5pbXMgPSBmdW5jdGlvbihhbmltcywgbWF4RGlnaXRzLCBvdXRPYmopCgl7CgkJaWYobWF4RGlnaXRzID09PSB1bmRlZmluZWQpCgkJCW1heERpZ2l0cyA9IDQ7CgkJaWYobWF4RGlnaXRzIDwgMCkKCQkJbWF4RGlnaXRzID0gMDsKCQl2YXIgemVyb3MgPSBbXTsKCQl2YXIgY29tcGFyZXMgPSBbXTsKCQl2YXIgaSwgYzsKCQlmb3IoaSA9IDE7IGkgPCBtYXhEaWdpdHM7ICsraSkKCQl7CgkJCXZhciBzID0gIiI7CgkJCWMgPSAxOwoJCQlmb3IodmFyIGogPSAwOyBqIDwgaTsgKytqKQoJCQl7CgkJCQlzICs9ICIwIjsKCQkJCWMgKj0gMTA7CgkJCX0KCQkJemVyb3MudW5zaGlmdChzKTsKCQkJY29tcGFyZXMucHVzaChjKTsKCQl9CgkJdmFyIGNvbXBhcmVMZW5ndGggPSBjb21wYXJlcy5sZW5ndGg7CgkJCgkJdmFyIHJ0bkRpY3QgPSBvdXRPYmogfHwge307CgkJdmFyIGZyb21GcmFtZSA9IFBJWEkuVGV4dHVyZS5mcm9tRnJhbWU7CgkJdmFyIHByZXZUZXgsIGxlbjsKCQlmb3IodmFyIGEgaW4gYW5pbXMpCgkJewoJCQl2YXIgZGF0YSA9IGFuaW1zW2FdOwoJCQl2YXIgbGlzdCA9IFtdOwoKCQkJZm9yKGkgPSBkYXRhLm51bWJlck1pbiwgbGVuID0gZGF0YS5udW1iZXJNYXg7IGkgPD0gbGVuOyArK2kpCgkJCXsKCQkJCXZhciBudW0gPSBudWxsOwoJCQkJZm9yKGMgPSAwOyBjIDwgY29tcGFyZUxlbmd0aDsgKytjKQoJCQkJewoJCQkJCWlmKGkgPCBjb21wYXJlc1tjXSkKCQkJCQl7CgkJCQkJCW51bSA9IHplcm9zW2NdICsgaTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJaWYoIW51bSkKCQkJCQludW0gPSBpLnRvU3RyaW5nKCk7CgkJCQkKCQkJCS8vSWYgdGhlIHRleHR1cmUgZG9lc24ndCBleGlzdCwgdXNlIHRoZSBwcmV2aW91cyB0ZXh0dXJlIC0gdGhpcyBzaG91bGQgYWxsb3cgdXMgdG8gdXNlIGZld2VyIHRleHR1cmVzCgkJCQkvL3RoYXQgYXJlIGluIGZhY3QgdGhlIHNhbWUsIGlmIHdlIGNhbiBmaW5kIGFuIGVhc3kgd2F5IHRvIGltcHJvdmUgdGhlIHNwcml0ZXNoZWV0IGZvcm1hdCBmb3IgdGhhdCBwdXJwb3NlCgkJCQl2YXIgdGV4TmFtZSA9IGRhdGEubmFtZS5yZXBsYWNlKCIjIiwgbnVtKTsKCQkJCXZhciB0ZXggPSBmcm9tRnJhbWUodGV4TmFtZSwgdHJ1ZSk7CgkJCQlpZih0ZXgpCgkJCQkJcHJldlRleCA9IHRleDsKCQkJCWxpc3QucHVzaChwcmV2VGV4KTsKCQkJfQoJCQlydG5EaWN0W2FdID0gbGlzdDsKCQl9CgkJcmV0dXJuIHJ0bkRpY3Q7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWVzcGFjZQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLkFzc2V0TWFuYWdlciA9IEFzc2V0TWFuYWdlcjsKfSgpKTsK",
                "body": "LyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKHVuZGVmaW5lZCl7CgkKCS8qKgoJKiAgRGVzaWduZWQgdG8gbWltaWMgdGhlIGZlYXR1cmUtc2V0IG9mIHRoZSBDbG91ZEtpZE9TIGZvciBBUzMKCSogIFByb3ZpZGVzIGEgc3RhZ2luZyBmcmFtZXdvcmsgZm9yIG90aGVyIHRoaW5ncyB0byBsb2FkCgkqICBoYW5kbGVzIHRoZSBzdGFnZSBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycywgcHJvdmlkZXMgZGVidWcgdG9vbHMsCgkqICBhcyB3ZWxsIGFzIGJyb3dzZXIgY2FjaGUtYnVzdGluZy4KCSoKCSogIEBjbGFzcyBPUwoJKiAgQGV4dGVuZHMgY3JlYXRlanMuQ29udGFpbmVyfFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcgoJKi8KCXZhciBPUyA9IGZ1bmN0aW9uKCl7fSwKCQoJLyoqCgkqIFRoZSBwcm90b3R5cGUgZXh0ZW5kcyB0aGUgZWFzZWxqcycgQ29udGFpbmVyIGNsYXNzCgkqIG9yIHRoZSBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIgY2xhc3MKCSogCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7Y3JlYXRlanMuQ29udGFpbmVyfFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcn0gcAoJKi8KCXAgPSBPUy5wcm90b3R5cGUgPSAoZmFsc2UpID8gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpIDogT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKSwKCQoJLyoqCgkqICBCb29sZWFuIHRvIGtlZXAgdHJhY2sgaWYgd2UncmUgcGF1c2VkCgkqICAKCSogIEBwcm9wZXJ0eSB7Ym9vbH0gX3BhdXNlZAoJKiAgQHByaXZhdGUKCSovCglfcGF1c2VkID0gZmFsc2UsCgkKCS8qKgoJKiAgV2hlbiB0aGUgT1MgaXMgcmVhZHkgdG8gdXNlCgkqIAoJKiAgQHByb3BlcnR5IHtib29sfSBfaXNSZWFkeQoJKiAgQHByaXZhdGUKCSovCglfaXNSZWFkeSA9IGZhbHNlLAoJCgkvKioKCSogIFRoZSBmcmFtZSByYXRlIG9iamVjdAoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7Y3JlYXRlanMuVGV4dHxQSVhJLlRleHR9IF9mcmFtZXJhdGUKCSovCglfZnJhbWVyYXRlID0gbnVsbCwKCQoJLyoqCgkqICBUaGUgbnVtYmVyIG9mIG1zIHNpbmNlIHRoZSBsYXN0IGZyYW1lIHVwZGF0ZQoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7aW50fSBfbGFzdEZyYW1lVGltZQoJKi8KCV9sYXN0RnJhbWVUaW1lID0gMCwKCQoJLyoqCgkqICBUaGUgbGFzdCB0aW1lIHNpbmNlIHRoZSBsYXN0IGZwcyB1cGRhdGUKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2ludH0gX2xhc3RGUFNVcGRhdGVUaW1lCgkqLwoJX2xhc3RGUFNVcGRhdGVUaW1lID0gMCwKCQoJLyoqCgkqICBUaGUgY2FsY3VsYXRlZCBfZnJhbWVyYXRlCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IF9mcmFtZXJhdGVWYWx1ZQoJKi8KCV9mcmFtZXJhdGVWYWx1ZSA9IG51bGwsCgkKCS8qKgoJKiAgVGhlIG51bWJlciBvZiBmcmFtZXMgc2luY2UgdGhlIGxhc3QgZnBzIHVwZGF0ZQoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7aW50fSBfZnJhbWVDb3VudAoJKi8KCV9mcmFtZUNvdW50ID0gMCwKCQoJLyoqCgkqCVRoZSBib3VuZCBjYWxsYmFjayBmb3IgbGlzdGVuaW5nIHRvIHRpY2sgZXZlbnRzCgkqCUBwcml2YXRlCgkqICAgQHByb3BlcnR5IHtGdW5jdGlvbn0gX3RpY2tDYWxsYmFjawoJKi8KCV90aWNrQ2FsbGJhY2sgPSBudWxsLAoJCgkvKioKCSogUmVmZXJlbmNlIHRvIHRoZSBwcml2YXRlIGluc3RhbmNlIG9iamVjdAoJKiAKCSogQHByb3BlcnR5IHtPU30gX2luc3RhbmNlCgkqIEBzdGF0aWMKCSogQHByb3RlY3RlZAoJKi8KCV9pbnN0YW5jZSA9IG51bGwsCgkKCS8qKgoJKiBUaGUgaWQgb2YgdGhlIGFjdGl2ZSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgb3Igc2V0VGltZW91dCBjYWxsLgoJKgoJKiBAcHJvcGVydHkge051bWJlcn0gX3RpY2tJZAoJKiBAcHJpdmF0ZQoJKi8KCV90aWNrSWQgPSAtMSwKCQoJLyoqCgkqIElmIHJlcXVlc3Rpb25BbmltYXRpb25GcmFtZSBzaG91bGQgYmUgdXNlZAoJKgoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Jvb2x9IF91c2VSQUYKCSogQGRlZmF1bHQgZmFsc2UKCSovCglfdXNlUkFGID0gZmFsc2UsCgkKCS8qKiAKCSogVGhlIGN1cnJlbnQgaW50ZXJuYWwgZnJhbWVzIHBlciBzZWNvbmQKCSoKCSogQHByb3BlcnR5IHtOdW1iZXJ9IF9mcHMKCSogQHByaXZhdGUKCSovCglfZnBzID0gMCwKCQoJLyoqCgkqIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHBlciBmcmFtZQoJKgoJKiBAcHJvcGVydHkge2ludH0gX21zUGVyRnJhbWUKCSogQHByaXZhdGUKCSovCglfbXNQZXJGcmFtZSA9IDA7CgkKCS8qKiAKCSogVGhlIHZlcnNpb24gbnVtYmVyIAoJKiBAcHVibGljCgkqIEBzdGF0aWMKCSogQHByb3BlcnR5IHtTdHJpbmd9IFZFUlNJT04KCSovCglPUy5WRVJTSU9OID0gIiR7dmVyc2lvbn0iOwkKCQoJLyoqCgkqIFJlZmVyZW5jZSB0byB0aGUgQ29udGFpbmVyIGluaXRpYWxpemUoKQoJKiBAcHJvdGVjdGVkCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IENvbnRhaW5lcl9pbml0aWFsaXplCgkqLwoJaWYoZmFsc2UpCgkJcC5Db250YWluZXJfaW5pdGlhbGl6ZSA9IHAuaW5pdGlhbGl6ZTsKCQkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIHN0YWdlIG9iamVjdAoJKiAKCSogQHByb3BlcnR5IHtjcmVhdGVqcy5TdGFnZXxQSVhJLlN0YWdlfSBzdGFnZQoJKiBAcHVibGljCgkqLwoJcC5zdGFnZSA9IG51bGw7CgkKCS8qKgoJKiBbUGl4aSBPbmx5XSBUaGUgcmVuZGVyZXIgdXNlZCB0byBkcmF3IHRoZSBmcmFtZS4KCSogCgkqIEBwcm9wZXJ0eSB7UElYSS5DYW52YXNSZW5kZXJlcnxQSVhJLldlYkdMUmVuZGVyZXJ9IF9yZW5kZXJlciBUaGUgUGl4aUpTIHJlbmRlcmVyLgoJKiBAcHJpdmF0ZQoJKi8KCWlmKHRydWUpCgkJcC5fcmVuZGVyZXIgPSBudWxsOwoJCgkvKioKCSogW1BpeGkgT25seV0gQSBkaXYgdGhhdCBjb250YWlucyB0aGUgY2FudmFzLCBzbyB0aGF0IGdhbWVzIGNhbiBsYXllciBpdCB3aXRoIG90aGVyIGNhbnZhc2VzIGlmIGRlc2lyZWQuCgkqIAoJKiBAcHJvcGVydHkge0RPTUVsZW1lbnR9IGNhbnZhc0NvbnRhaW5lcgoJKiBAcHVibGljCgkqLwoJaWYodHJ1ZSkKCQlwLmNhbnZhc0NvbnRhaW5lciA9IG51bGw7CgkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgYXBwbGljYXRpb24KCSogQHByb3RlY3RlZAoJKiBAcHJvcGVydHkge0FwcGxpY2F0aW9ufSBfYXBwCgkqLwoJcC5fYXBwID0gbnVsbDsKCQoJLyoqCgkqIFRoZSBjb2xsZWN0aW9uIG9mIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzCgkqIEBwdWJsaWMKCSogQHByb3BlcnR5IHtEaWN0aW9uYXJ5fSBvcHRpb25zCgkqLwoJcC5vcHRpb25zID0gbnVsbDsKCQoJLyoqCgkqICBDb2xsZWN0aW9uIG9mIHVwZGF0ZSBmdW5jdGlvbnMKCSogIEBwcm90ZWN0ZWQKCSogIEBwcm9wZXJ0eSB7RGljdGlvbmFyeX0gX3VwZGF0ZUZ1bmN0aW9ucwoJKi8KCXAuX3VwZGF0ZUZ1bmN0aW9ucyA9IHt9OwoJCgkvKioKCSogIFN0YXRpYyBjb25zdHJ1Y3RvciBmb3Igc2V0dGluZyB1cCB0aGUgc3RhZ2UKCSogIAoJKiAgQGV4YW1wbGUKCQl2YXIgb3MgPSBjbG91ZGtpZC5PUy5pbml0KCJzdGFnZSIsIHsKCQkJc2hvd0ZyYW1lcmF0ZTogdHJ1ZSwKCQkJZnBzOiA2MCwKCQkJcGFyc2VRdWVyeVN0cmluZzogdHJ1ZSwKCQkJZGVidWc6IHRydWUKCQl9KTsKCQkKCQlvcy5hZGRBcHAobXlBcHBsaWNhdGlvbik7CgkqICAKCSogIEBtZXRob2QgaW5pdAoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IHN0YWdlTmFtZSBUaGUgc3RhZ2UgbmFtZSBzZWxlY3RvcgoJKiAgQHBhcmFtIHtEaWN0aW9uYXJ5fSBbb3B0aW9uc10gQWRkaXRpb25hbCBvcHRpb25zCgkqICBAcGFyYW0ge2ludH0gW29wdGlvbnMubW91c2VPdmVyUmF0ZT0zMF0gKENyZWF0ZUpTIG9ubHkpIHRoZSBmcmFtZXJhdGUgZm9yIG1vdXNlb3ZlciBlZmZlY3RzLCBoaWdoZXIgaXMgbW9yZSByZXNwb25zaXZlCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLmRlYnVnPWZhbHNlXSBJZiB3ZSBzaG91bGQgZW5hYmxlIHRoZSBEZWJ1ZyBjbGFzcyBmb3IgZG9pbmcgY29uc29sZSBhbmQgcmVtb3RlIGxvZ3MKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5taW5Mb2dMZXZlbD0wXSBUaGUgbWluaW11bSBsb2cgbGV2ZWwgZm9yIHRoZSBEZWJ1ZyBjbGFzcywgZGVmYXVsdCBpcyBzaG93IGFsbCBzdGF0ZW1lbnRzLCB2YWx1ZXMgZnJvbSAwIChhbGwpLTQgKGVycm9ycyBvbmx5KQoJKiAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLmlwPW51bGxdIFRoZSBJUCBhZGRyZXNzIGZvciBkb2luZyByZW1vdGUgZGVidWdnaW5nCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnBhcnNlUXVlcnlTdHJpbmc9ZmFsc2VdIElmIHdlIHNob3VsZCBjb252ZXJ0IHRoZSBxdWVyeSBzdHJpbmcgaW50byBPUyBvcHRpb25zCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnNob3dGcmFtZXJhdGU9ZmFsc2VdIFRvIGRpc3BsYXkgdGhlIGN1cnJlbnQgZnJhbWVyYXRlIGNvdW50ZXIKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuY2xlYXJWaWV3PWZhbHNlXSBBdXRvIGNsZWFyIHRoZSBzdGFnZSByZW5kZXIKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3I9MHgwMDAwMDBdIChQSVhJIG9ubHkpIFRoZSBiYWNrZ3JvdW5kIGNvbG9yIG9mIHRoZSBzdGFnZSBhcyBhIHVpbnQsIGUuZy4gMHhGRkZGRkYgZm9yIHdoaXRlLgoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5wcmVNdWx0QWxwaGE9ZmFsc2VdIChQSVhJIG9ubHkpIElmIHRoZSByZW5kZXJlciBpcyB0byB1c2UgcHJlIG11bHRpcGxpZWQgYWxwaGEgZm9yIGFsbCBpbWFnZXMuIFRoaXMgb25seSBhZmZlY3RzIHRoZSBXZWJHTCByZW5kZXJlci4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMudHJhbnNwYXJlbnQ9ZmFsc2VdIChQSVhJIG9ubHkpIFRoZSBzdGFnZSBpcyB0cmFuc3BhcmVudAoJKiAgQHBhcmFtIHtpbnR9IFtvcHRpb25zLndpZHRoXSAoUElYSSBvbmx5KSBUaGUgd2lkdGggb2YgdGhlIHJlbmRlcmVyLCBkZWZhdWx0IGlzIHRoZSBjYW52YXMgd2lkdGgKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5oZWlnaHRdIChQSVhJIG9ubHkpIFRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlcmVyLCBkZWZhdWx0IGlzIHRoZSBjYW52YXMgaGVpZ2h0CgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuZm9yY2VDb250ZXh0PW51bGxdIChQSVhJIG9ubHkpIFRoZSBzdGFnZSByZW5kZXJlciwgb3B0aW9ucyBhcmUgImNhbnZhczJkIiwgIndlYmdsIiBvciBudWxsLiBPbWl0dGluZyB0aGlzIChvciBudWxsKSB1c2VzIFdlYkdMIGlmIGF2YWlsYWJsZSwgYW5kIENhbnZhczJEIG90aGVyd2lzZS4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucmFmPWZhbHNlXSBVc2UgdGhlIHJlcXVlc3QgYW5pbWF0aW9uIGZyYW1lIGluc3RlYWQgb2YgYSBzZXRJbnRlcnZhbAoJKiAgQHBhcmFtIHtpbnR9IFtvcHRpb25zLmZwcz02MF0gU2V0IHRoZSBmcmFtZXJhdGUgCgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMudmVyc2lvbnNGaWxlXSBUaGUgdGV4dCBmaWVsZCB0byBzdG9yZSBjYWNoZS1idXN0aW5nIHZlcnNpb25zIGZvciBpbmRpdmlkdWFsIGZpbGVzCgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuYmFzZVBhdGhdIFRoZSBiYXNlIHBhdGggdG8gbG9hZCBhbGwgZmlsZXMgZnJvbSAodXNlZnVsIGlmIHVzaW5nIGEgQ0ROKQoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5jYWNoZUJ1c3Q9ZmFsc2VdIElmIGFsbCBmaWxlIHJlcXVlc3RzIHdpdGggdGhlIE1lZGlhTG9hZGVyIHNob3VsZCBiZSBjYWNoZUJ1c3RlZCAoZS5nLiwgImZpbGUubXAzP2NiPTEyMzEyMyIpCgkqLwoJT1MuaW5pdCA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykKCXsKCQlpZiAoIV9pbnN0YW5jZSkKCQl7CgkJCWlmICh0cnVlKQoJCQl7CgkJCQlEZWJ1Zy5sb2coIkNyZWF0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgT1MiKTsKCQkJfQoJCQkKCQkJX2luc3RhbmNlID0gbmV3IE9TKCk7CgkJCV9pbnN0YW5jZS5pbml0aWFsaXplKHN0YWdlTmFtZSwgb3B0aW9ucyk7CgkJfQoJCXJldHVybiBfaW5zdGFuY2U7Cgl9OwoJCgkvKioKCSogIFRoZSBpbnRlcm5hbCBjb25zdHJ1Y3RvciBleHRlbmRzIENvbnRhaW5lciBjb25zdHJ1Y3RvcgoJKiAgQGNvbnN0cnVjdG9yCgkqICBAcHJvdGVjdGVkCgkqICBAbWV0aG9kIGluaXRpYWxpemUKCSogIEBwYXJhbSB7c3RyaW5nfSBzdGFnZU5hbWUgVGhlIHN0cmluZyBuYW1lIG9mIHRoZSBzdGFnZSBpZAoJKiAgQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSBUaGUgb3B0aW9uYWwgb3B0aW9ucyB0byBzZXQsIHNlZSBPUy5pbml0KCkgZm9yIG1vcmUgaW5mb3JtYXRpb24gb24gdGhlIG9wdGlvbnMgdGhhdCBjYW4gYmUgc2V0LgoJKi8KCXAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykKCXsKCQkvLyBDYWxsIHRoZSBzdXBlciBjb25zdHJ1Y3RvcgoJCWlmIChmYWxzZSkgdGhpcy5Db250YWluZXJfaW5pdGlhbGl6ZSgpOwoJCWlmICh0cnVlKSBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCh0aGlzKTsKCQkKCQkvLyBTZXR1cCB0aGUgb3B0aW9ucyBjb250YWluZXIKCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCQoJCS8vIFNlZSBpZiB3ZSBzaG91bGQgcGFyc2UgcXVlcnlzdHJpbmcKCQlpZiAodGhpcy5vcHRpb25zLnBhcnNlUXVlcnlTdHJpbmcgIT09IHVuZGVmaW5lZCkKCQkJdGhpcy5vcHRpb25zID0gcGFyc2VRdWVyeVN0cmluZ1BhcmFtcyh0aGlzLm9wdGlvbnMpOwoJCQoJCS8vIFR1cm4gb24gZGVidWdnaW5nCgkJaWYgKHRoaXMub3B0aW9ucy5kZWJ1ZyAhPT0gdW5kZWZpbmVkKQoJCQlEZWJ1Zy5lbmFibGVkID0gdGhpcy5vcHRpb25zLmRlYnVnID09PSB0cnVlIHx8IHRoaXMub3B0aW9ucy5kZWJ1ZyA9PT0gInRydWUiOwoJCQkKCQlpZiAodGhpcy5vcHRpb25zLm1pbkxvZ0xldmVsICE9PSB1bmRlZmluZWQpCgkJCURlYnVnLm1pbkxvZ0xldmVsID0gcGFyc2VJbnQodGhpcy5vcHRpb25zLm1pbkxvZ0xldmVsLCAxMCk7CgoJCS8vaWYgd2Ugd2VyZSBzdXBwbGllZCB3aXRoIGFuIElQIGFkZHJlc3MsIGNvbm5lY3QgdG8gaXQgd2l0aCB0aGUgRGVidWcgY2xhc3MgZm9yIGxvZ2dpbmcKCQlpZih0eXBlb2YgdGhpcy5vcHRpb25zLmlwID09ICJzdHJpbmciKQoJCQlEZWJ1Zy5jb25uZWN0KHRoaXMub3B0aW9ucy5pcCk7CgkKCQkvLyBTZXR1cCB0aGUgbWVkaWFsb2FkZXIKCQl2YXIgbG9hZGVyID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5pdCgpOwoJCQoJCS8vIFNldHVwIHRoZSBzdGFnZQoJCWlmKGZhbHNlKQoJCXsKCQkJdGhpcy5zdGFnZSA9IG5ldyBjcmVhdGVqcy5TdGFnZShzdGFnZU5hbWUpOwoJCQl0aGlzLnN0YWdlLm5hbWUgPSAiY2xvdWRraWQuT1MiOwoJCQoJCQkvLyBwcmV2ZW50IG1vdXNlIGRvd24gdHVybmluZyBpbnRvIGN1cnNvcgoJCQl0aGlzLnN0YWdlLmNhbnZhcy5vbm1vdXNlZG93biA9IGZ1bmN0aW9uKGUpCgkJCXsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJfTsKCgkJCS8vIEVuYWJsZSB0aGUgbW91c2VvdmVyIGJ5IHNldHRpbmcgdGhlIGZyZXF1ZW5jeQoJCQkvLyBpZiB3ZSBzZXQgbW91c2VPdmVyUmF0ZSA8PSAwLCB0aGVuIHR1cm5zIG9mZiBtb3VzZW92ZXIgZWZmZWN0cwoJCQl2YXIgbW91c2VPdmVyUmF0ZSA9IHRoaXMub3B0aW9ucy5tb3VzZU92ZXJSYXRlID0gdGhpcy5vcHRpb25zLm1vdXNlT3ZlclJhdGUgfHwgMzA7CgkJCXRoaXMuc3RhZ2UuZW5hYmxlTW91c2VPdmVyKG1vdXNlT3ZlclJhdGUpOwoJCX0KCQkKCQlpZih0cnVlKQoJCXsKCQkJdGhpcy5zdGFnZSA9IG5ldyBQSVhJLlN0YWdlKHRoaXMub3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IgfHwgMCwgdHJ1ZSk7CgkJfQoJCXRoaXMuc3RhZ2UuYWRkQ2hpbGQodGhpcyk7CgkJCgkJLy9saXN0ZW4gZm9yIHdoZW4gdGhlIHBhZ2UgdmlzaWJpbGl0eSBjaGFuZ2VzIHNvIHdlIGNhbiBwYXVzZSBvdXIgdGltaW5ncwoJCXRoaXMudmlzaWJsZUxpc3RlbmVyID0gdGhpcy5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkLmJpbmQodGhpcyk7CgkJYWRkUGFnZUhpZGVMaXN0ZW5lcih0aGlzLnZpc2libGVMaXN0ZW5lcik7CgkJCgkJaWYoZmFsc2UpCgkJewoJCQkvLyBTZXR1cCB0aGUgdG91Y2ggZXZlbnRzCgkJCXZhciB0b3VjaERldmljZT0od2luZG93Lmhhc093blByb3BlcnR5KCdvbnRvdWNoc3RhcnQnKSk7CgkJCQoJCQkvL0lFMTAgZG9lc24ndCBzZW5kIG1vdXNlb3ZlciBldmVudHMgcHJvcGVybHkgaWYgdG91Y2ggaXMgZW5hYmxlZAoJCQlpZih3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJNU0lFIDEwLjAiKSAhPSAtMSAmJiAhdG91Y2hEZXZpY2UpCgkJCXsKCQkJCWlmICh0cnVlKSBEZWJ1Zy5sb2coJ0lFMTAgRGVza3RvcCcpOwoJCQl9CgkJCWVsc2UKCQkJCWNyZWF0ZWpzLlRvdWNoLmVuYWJsZSh0aGlzLnN0YWdlKTsKCgkJCS8vIENsZWFyIHRoZSBzdGFnZQoJCQl0aGlzLnN0YWdlLmF1dG9DbGVhciA9ICEhdGhpcy5vcHRpb25zLmNsZWFyVmlldyB8fCBmYWxzZTsKCQkJCgkJCWlmKHRoaXMub3B0aW9ucy5zaG93RnJhbWVyYXRlKQoJCQl7CgkJCQkvLyBBZGQgdGhlIGZyYW1lIHJhdGUgb2JqZWN0CgkJCQlfZnJhbWVyYXRlID0gbmV3IGNyZWF0ZWpzLlRleHQoJycsICcxMHB4IEFyaWFsJywgJyMwMDAnKTsKCQkJCV9mcmFtZXJhdGUuc3Ryb2tlID0ge3dpZHRoOjIsIGNvbG9yOiIjZmZmZmZmIn07CgkJCQlfZnJhbWVyYXRlLnggPSBfZnJhbWVyYXRlLnkgPSA1OwoJCQkJdGhpcy5hZGRDaGlsZChfZnJhbWVyYXRlKTsKCQkJfQoJCQkKCQkJLy8gSW5pdGlhbCByZW5kZXIKCQkJdGhpcy5zdGFnZS51cGRhdGUoKTsKCQl9CgkJCgkJaWYodHJ1ZSkKCQl7CgkJCXZhciB0cmFuc3BhcmVudCA9ICEhdGhpcy5vcHRpb25zLnRyYW5zcGFyZW50IHx8IGZhbHNlOwoJCQl2YXIgcHJlTXVsdEFscGhhID0gISF0aGlzLm9wdGlvbnMucHJlTXVsdEFscGhhIHx8IGZhbHNlOwoKCQkJdGhpcy5jb250YWluZXJOYW1lID0gKHR5cGVvZiBzdGFnZU5hbWUgPT0gInN0cmluZyIpID8gc3RhZ2VOYW1lIDogc3RhZ2VOYW1lLmF0dHIoImlkIik7CgkJCXZhciBjb250YWluZXIgPSAodHlwZW9mIHN0YWdlTmFtZSA9PSAic3RyaW5nIikgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChzdGFnZU5hbWUpIDogc3RhZ2VOYW1lOwoJCQl2YXIgY2FudmFzQ29udGFpbmVyID0gdGhpcy5jYW52YXNDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCQkJY29udGFpbmVyLmFwcGVuZENoaWxkKGNhbnZhc0NvbnRhaW5lcik7CgkJCWNhbnZhc0NvbnRhaW5lci5pZCA9ICJDS09TIjsKCQkJCgkJCS8vY3JlYXRlIHRoZSByZW5kZXJlcmVyCgkJCXZhciB3aWR0aCA9IHRoaXMub3B0aW9ucy53aWR0aCB8fCBjb250YWluZXIuaW5uZXJXaWR0aDsKCQkJdmFyIGhlaWdodCA9IHRoaXMub3B0aW9ucy5oZWlnaHQgfHwgY29udGFpbmVyLmlubmVySGVpZ2h0OwoJCQlpZih0aGlzLm9wdGlvbnMuZm9yY2VDb250ZXh0ID09ICJjYW52YXMyZCIpCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gbmV3IFBJWEkuQ2FudmFzUmVuZGVyZXIoCgkJCQkJd2lkdGgsIAoJCQkJCWhlaWdodCwgCgkJCQkJbnVsbCwgCgkJCQkJdHJhbnNwYXJlbnQKCQkJCSk7CgkJCX0KCQkJZWxzZSBpZih0aGlzLm9wdGlvbnMuZm9yY2VDb250ZXh0ID09ICJ3ZWJnbCIpCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJlcigKCQkJCQl3aWR0aCwgCgkJCQkJaGVpZ2h0LAoJCQkJCW51bGwsIAoJCQkJCXRyYW5zcGFyZW50LAoJCQkJCXByZU11bHRBbHBoYQoJCQkJKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gUElYSS5hdXRvRGV0ZWN0UmVuZGVyZXIoCgkJCQkJd2lkdGgsIAoJCQkJCWhlaWdodCwKCQkJCQludWxsLCAKCQkJCQl0cmFuc3BhcmVudCwKCQkJCQlwcmVNdWx0QWxwaGEKCQkJCSk7CgkJCX0KCQkJY2FudmFzQ29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuX3JlbmRlcmVyLnZpZXcpOwoJCQljYW52YXNDb250YWluZXIuc2V0QXR0cmlidXRlKCJzdHlsZSIsInBvc2l0aW9uOnJlbGF0aXZlO3dpZHRoOiIgKyB3aWR0aCArICJweDtoZWlnaHQ6IiArIGhlaWdodCArICJweCIpOwoJCQkKCQkJLy9IZXJlIGF0IENsb3VkS2lkLCB3ZSBhbHdheXMgaGF2ZSBhIGJpdG1hcCBiYWNrZ3JvdW5kLCBzbyB3ZSBjYW4gZ2V0IGJldHRlciBwZXJmb3JtYW5jZSBieSBub3QgY2xlYXJpbmcgdGhlIHJlbmRlciBhcmVhIGVhY2ggcmVuZGVyCgkJCXRoaXMuX3JlbmRlcmVyLmNsZWFyVmlldyA9ICEhdGhpcy5vcHRpb25zLmNsZWFyVmlldzsKCgkJCWlmKHRoaXMub3B0aW9ucy5zaG93RnJhbWVyYXRlKQoJCQl7CgkJCQkvLyBBZGQgdGhlIGZyYW1lIHJhdGUgb2JqZWN0CgkJCQlfZnJhbWVyYXRlID0gbmV3IFBJWEkuVGV4dCgnRlBTOiAwLjAwMCcsIHtmb250OicxMHB4IEFyaWFsJywgZmlsbDonYmxhY2snLCBzdHJva2U6J3doaXRlJywgc3Ryb2tlVGhpY2tuZXNzOjJ9KTsKCQkJCV9mcmFtZXJhdGUueCA9IF9mcmFtZXJhdGUueSA9IDU7CgkJCQl0aGlzLmFkZENoaWxkKF9mcmFtZXJhdGUpOwoJCQl9CgkJCQoJCQkvLyBJbml0aWFsIHJlbmRlcgoJCQl0aGlzLl9yZW5kZXJlci5yZW5kZXIodGhpcy5zdGFnZSk7CgkJfQoJCQoJCS8vc2V0IHVwIHRoZSB0aWNrIGNhbGxiYWNrCgkJX3RpY2tDYWxsYmFjayA9IHRoaXMudGljay5iaW5kKHRoaXMpOwoJCQoJCS8vIElmIHdlIHNob3VsZCB1c2UgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIGluIHRoZSBicm93c2VyIGluc3RlYWQgb2Ygc2V0VGltZW91dAoJCV91c2VSQUYgPSB0aGlzLm9wdGlvbnMucmFmIHx8IGZhbHNlOwoJCQoJCS8vVGhlIGZwcyB0byB0YXJnZXQgLSBvbmx5IHVzZWQgaWYgbm90IHVzaW5nIHJlcXVlc3RBbmltYXRpb25GcmFtZQoJCXRoaXMuZnBzID0gdGhpcy5vcHRpb25zLmZwcyB8fCA2MDsKCgkJLy8gU2V0IHRoZSBhcHAgdG8gZGVmYXVsdAoJCXRoaXMucmVtb3ZlQXBwKCk7CgkJCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIHNob3VsZCBsb2FkIGEgdmVyc2lvbnMgZmlsZQoJCS8vIFRoZSB2ZXJzaW9ucyBmaWxlIGtlZXBzIHRyYWNrIG9mIHRoZSBPUyB2ZXJzaW9uCgkJaWYgKHRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUgIT09IHVuZGVmaW5lZCkKCQl7CgkJCV9pc1JlYWR5ID0gZmFsc2U7CgkJCQoJCQl2YXIgb3MgPSB0aGlzOwoJCQkKCQkJLy8gVHJ5IHRvIGxvYWQgdGhlIGRlZmF1bHQgdmVyc2lvbnMgZmlsZQoJCQkvLyBjYWxsYmFjayBzaG91bGQgYmUgbWFkZSB3aXRoIGEgc2NvcGUgaW4gbWluZAoJCQlsb2FkZXIuY2FjaGVNYW5hZ2VyLmFkZFZlcnNpb25zRmlsZSgKCQkJCXRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUsIAoJCQkJZnVuY3Rpb24oKXsKCQkJCQkKCQkJCQlfaXNSZWFkeSA9IHRydWU7CgkJCQkJCgkJCQkJLy8gU29tZW9uZSBhZGRlZCBhbiBhcHBsaWNhdGlvbiBiZWZvcmUgdGhlIE9TIHdhcyByZWFkeQoJCQkJCS8vIGxldHMgaW5pdGlhbGl6ZSBpcyBub3cKCQkJCQlpZiAob3MuX2FwcCkKCQkJCQl7CgkJCQkJCW9zLmFkZENoaWxkQXQob3MuX2FwcCwgMCk7CgkJCQkJCW9zLl9hcHAuaW5pdCgpOwoJCQkJCQlvcy5yZXN1bWUoKTsKCQkJCQl9CgkJCQl9CgkJCSk7CgkJfQoJCWVsc2UKCQl7CgkJCV9pc1JlYWR5ID0gdHJ1ZTsKCQl9Cgl9OwoJCgl2YXIgaGlkZGVuID0gbnVsbDsvL25lZWRlZCBpbnNpZGUgdGhlIGV2ZW50IGxpc3RlbmVyIGFzIHdlbGwKCXZhciBldnRNYXAgPSBudWxsOwoJdmFyIHYgPSAndmlzaWJsZScsIGggPSAnaGlkZGVuJzsKCXZhciBhZGRQYWdlSGlkZUxpc3RlbmVyID0gZnVuY3Rpb24obGlzdGVuZXIpCgl7CgkJaGlkZGVuID0gImhpZGRlbiI7CgkJLy8gU3RhbmRhcmRzOgoJCWlmIChoaWRkZW4gaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcik7CgkJZWxzZSBpZiAoKGhpZGRlbiA9ICJtb3pIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibW96dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQllbHNlIGlmICgoaGlkZGVuID0gIndlYmtpdEhpZGRlbiIpIGluIGRvY3VtZW50KQoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKChoaWRkZW4gPSAibXNIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibXN2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKCdvbmZvY3VzaW4nIGluIGRvY3VtZW50KS8vIElFIDkgYW5kIGxvd2VyOgoJCXsKCQkJZXZ0TWFwID0geyBmb2N1c2luOnYsIGZvY3Vzb3V0OmggfTsKCQkJZG9jdW1lbnQub25mb2N1c2luID0gZG9jdW1lbnQub25mb2N1c291dCA9IGxpc3RlbmVyOwoJCX0KCQllbHNlLy8gQWxsIG90aGVyczoKCQl7CgkJCWV2dE1hcCA9IHsgZm9jdXM6diwgcGFnZXNob3c6diwgYmx1cjpoLCBwYWdlaGlkZTpoIH07CgkJCXdpbmRvdy5vbnBhZ2VzaG93ID0gd2luZG93Lm9ucGFnZWhpZGUgPSB3aW5kb3cub25mb2N1cyA9IHdpbmRvdy5vbmJsdXIgPSBsaXN0ZW5lcjsKCQl9Cgl9OwoJCgl2YXIgcmVtb3ZlUGFnZUhpZGVMaXN0ZW5lciA9IGZ1bmN0aW9uKGxpc3RlbmVyKQoJewoJCXZhciBoaWRkZW4gPSAiaGlkZGVuIjsKCQlpZiAoaGlkZGVuIGluIGRvY3VtZW50KQoJCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKChoaWRkZW4gPSAibW96SGlkZGVuIikgaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1venZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcik7CgkJZWxzZSBpZiAoKGhpZGRlbiA9ICJ3ZWJraXRIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigid2Via2l0dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQllbHNlIGlmICgoaGlkZGVuID0gIm1zSGlkZGVuIikgaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1zdmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQlkb2N1bWVudC5vbmZvY3VzaW4gPSBkb2N1bWVudC5vbmZvY3Vzb3V0ID0gbnVsbDsKCQl3aW5kb3cub25wYWdlc2hvdyA9IHdpbmRvdy5vbnBhZ2VoaWRlID0gd2luZG93Lm9uZm9jdXMgPSB3aW5kb3cub25ibHVyID0gbnVsbDsKCX07CgoJcC5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkID0gZnVuY3Rpb24oZXZ0KQoJewoJCXZhciB2ID0gJ3Zpc2libGUnLCBoID0gJ2hpZGRlbic7CgoJCWV2dCA9IGV2dCB8fCB3aW5kb3cuZXZlbnQ7CgkJdmFyIHZhbHVlOwoJCWlmIChldnRNYXApCgkJCXZhbHVlID0gZXZ0TWFwW2V2dC50eXBlXTsKCQllbHNlCgkJCXZhbHVlID0gZG9jdW1lbnRbaGlkZGVuXSA/IGggOiB2OwoJCWlmKHZhbHVlID09IGgpCgkJCXRoaXMucGF1c2UoKTsKCQllbHNlCgkJCXRoaXMucmVzdW1lKCk7Cgl9OwoJCgkvKioKCSogIERlZmluZSBhbGwgb2YgdGhlIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zCgkqICBAcGFyYW0ge29iamVjdH0gb3V0cHV0IFRoZSBvYmplY3QgcmVmZXJlbmNlIHRvIHVwZGF0ZQoJKi8KCXZhciBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zID0gZnVuY3Rpb24ob3V0cHV0KQoJewoJCXZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CgkJdmFyIHF1ZXN0aW9uTWFyayA9IGhyZWYuaW5kZXhPZigiPyIpOwoJCWlmIChxdWVzdGlvbk1hcmsgPT0gLTEpIHJldHVybiBvdXRwdXQ7CgkJCgkJdmFyIHZhcnMgPSBxdWVzdGlvbk1hcmsgPCAwID8gJycgOiBocmVmLnN1YnN0cihxdWVzdGlvbk1hcmsrMSk7CgkJdmFyIHBvdW5kID0gdmFycy5pbmRleE9mKCcjJyk7CgkJdmFycyA9IHBvdW5kIDwgMCA/IHZhcnMgOiB2YXJzLnN1YnN0cmluZygwLCBwb3VuZCk7CgkJdmFyIHNwbGl0Rmxhc2hWYXJzID0gdmFycy5zcGxpdCgiJiIpOwoJCXZhciBteVZhcjsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHNwbGl0Rmxhc2hWYXJzLmxlbmd0aDsgaSsrKQoJCXsKCQkJbXlWYXIgPSBzcGxpdEZsYXNoVmFyc1tpXS5zcGxpdCgiPSIpOwoJCQlpZiAodHJ1ZSkKCQkJewoJCQkJRGVidWcubG9nKG15VmFyWzBdICsgIiAtPiAiICsgbXlWYXJbMV0pOwoJCQl9CgkJCW91dHB1dFtteVZhclswXV0gPSBteVZhclsxXTsKCQl9CgkJcmV0dXJuIG91dHB1dDsKCX07CgkKCS8qKgoJKiAgUGF1c2UgdGhlIE9TIGFuZCBzdG9wIGZyYW1lIHVwZGF0ZXMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgcGF1c2UKCSovCglwLnBhdXNlID0gZnVuY3Rpb24oKQoJewoJCWlmKF90aWNrSWQgIT0gLTEpCgkJewoJCQlpZihfdXNlUkFGKQoJCQl7CgkJCQlpZih3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUpCgkJCQkJY2FuY2VsQW5pbWF0aW9uRnJhbWUoX3RpY2tJZCk7CgkJCX0KCQkJZWxzZQoJCQkJY2xlYXJUaW1lb3V0KF90aWNrSWQpOwoJCQlfdGlja0lkID0gLTE7CgkJfQoJCV9wYXVzZWQgPSB0cnVlOwoJfTsKCQoJdmFyIG5vd0Z1bmMgPSB3aW5kb3cucGVyZm9ybWFuY2UgJiYgKHBlcmZvcm1hbmNlLm5vdyB8fCBwZXJmb3JtYW5jZS5tb3pOb3cgfHwgcGVyZm9ybWFuY2UubXNOb3cgfHwgcGVyZm9ybWFuY2Uub05vdyB8fCBwZXJmb3JtYW5jZS53ZWJraXROb3cpOwoJaWYobm93RnVuYykKCQlub3dGdW5jID0gbm93RnVuYy5iaW5kKHBlcmZvcm1hbmNlKTsKCWVsc2UKCQlub3dGdW5jID0gZnVuY3Rpb24oKSB7IHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsgfTsvL2FwcGFyZW50bHkgaW4gQ2hyb21lIHRoaXMgaXMgZXh0cmVtZWx5IGluYWNjdXJhdGUgKHRyaXBsZSBmcmFtZXJhdGUgb3Igc29tZXRoaW5nIHNpbGx5KQoKCS8qKgoJKiAgR2V0cyB0aGUgY3VycmVudCB0aW1lIGluIG1pbGxpc2Vjb25kcyBmb3IgdGltaW5nIHB1cnBvc2VzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGdldFRpbWUKCSovCglwLmdldFRpbWUgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIG5vd0Z1bmMoKTsKCX07CgkKCS8qKgoJKiAgUmVzdW1lIHRoZSBPUyB1cGRhdGVzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc3VtZQoJKi8KCXAucmVzdW1lID0gZnVuY3Rpb24oKQoJewoJCV9wYXVzZWQgPSBmYWxzZTsKCQkKCQlpZihfdGlja0lkID09IC0xKQoJCXsKCQkJX3RpY2tJZCA9IF91c2VSQUYgPyAKCQkJCXJlcXVlc3RBbmltRnJhbWUoX3RpY2tDYWxsYmFjayk6IAoJCQkJc2V0VGFyZ2V0ZWRUaW1lb3V0KF90aWNrQ2FsbGJhY2spOwoJCX0KCQlfbGFzdEZQU1VwZGF0ZVRpbWUgPSBfbGFzdEZyYW1lVGltZSA9IHRoaXMuZ2V0VGltZSgpOwoJfTsKCQoJLyoqCgkqIFRoZSBGUFMgdGhhdCB0aGUgT1MgaXMgdGFyZ2V0aW5nLgoJKiAKCSogQHByb3BlcnR5IHtOdW1iZXJ9IGZwcwoJKiBAcHVibGljCgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJmcHMiLCB7CgkJZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9mcHM7IH0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoJCQlpZih0eXBlb2YgdmFsdWUgIT0gIm51bWJlciIpIHJldHVybjsKCQkJX2ZwcyA9IHZhbHVlOwoJCQlfbXNQZXJGcmFtZSA9ICgxMDAwIC8gX2ZwcykgfCAwOwoJCX0KCX0pOwoJCgkvKioKCSogIENvbnZlbmllbmNlIGZvciBhY2Nlc3NpbmcgdGhlIHN0YWdlJ3Mgd2lkdGgKCSogICAKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBzdGFnZVdpZHRoCgkqICBAcHVibGljCgkqICBAcmVhZE9ubHkKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInN0YWdlV2lkdGgiLCB7CgkJZ2V0OiBmdW5jdGlvbigpewoJCQlpZiAoZmFsc2UpIHJldHVybiBfaW5zdGFuY2Uuc3RhZ2UuY2FudmFzLndpZHRoOwoJCQlpZiAodHJ1ZSkgcmV0dXJuIF9pbnN0YW5jZS5fcmVuZGVyZXIudmlldy53aWR0aDsKCQl9Cgl9KTsKCQoJLyoqCgkqICBDb252ZW5pZW5jZSBmb3IgYWNjZXNzaW5nIHRoZSBzdGFnZSdzIGhlaWdodAoJKiAgIAoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IHN0YWdlSGVpZ2h0CgkqICBAcHVibGljCgkqICBAcmVhZE9ubHkKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInN0YWdlSGVpZ2h0IiwgewoJCWdldDogZnVuY3Rpb24oKXsKCQkJaWYgKGZhbHNlKSByZXR1cm4gX2luc3RhbmNlLnN0YWdlLmNhbnZhcy5oZWlnaHQ7CgkJCWlmICh0cnVlKSByZXR1cm4gX2luc3RhbmNlLl9yZW5kZXJlci52aWV3LmhlaWdodDsKCQl9Cgl9KTsKCQoJdmFyIHNldFRhcmdldGVkVGltZW91dCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aW1lSW5GcmFtZSkKCXsKCQl2YXIgdGltZVRvQ2FsbCA9IDA7CgkJaWYodGltZUluRnJhbWUpCgkJCXRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCBfbXNQZXJGcmFtZSAtIHRpbWVJbkZyYW1lKTsvL3N1YnRyYWN0IHRoZSB0aW1lIHNwZW50IGluIHRoZSBmcmFtZSB0byBhY3R1YWxseSBoaXQgdGhlIHRhcmdldCBmcHMKCQlyZXR1cm4gc2V0VGltZW91dChjYWxsYmFjaywgdGltZVRvQ2FsbCk7Cgl9OwoJCgkvKioKCSogIFJlbW92ZSB0aGUgYXBwbGljYXRpb24KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgcmVtb3ZlQXBwCgkqICBAcGFyYW0ge0Jvb2xlYW59IGRlc3Ryb3lpbmcgSWYgdGhlIE9TIGlzIGJlaW5nIGRlc3Ryb3llZCBhbmQgc2hvdWxkbid0IGJvdGhlciBydW5uaW5nIGFueSByZXNldHRpbmcgY29kZS4KCSogIEByZXR1cm4ge0Jvb2xlYW59IElmIGFuIGBBcHBsaWNhdGlvbmAgd2FzIHN1Y2Nlc3NmdWxseSByZW1vdmVkCgkqLwoJcC5yZW1vdmVBcHAgPSBmdW5jdGlvbihkZXN0cm95aW5nKQoJewoJCXZhciByZW1vdmVkID0gZmFsc2U7CgkJCgkJdmFyIHN0YWdlID0gdGhpcy5zdGFnZTsKCQlpZiAodGhpcy5fYXBwKQoJCXsKCQkJaWYoZmFsc2UpCgkJCXsKCQkJCWlmKHRoaXMuY29udGFpbnModGhpcy5fYXBwKSkKCQkJCQl0aGlzLnJlbW92ZUNoaWxkKHRoaXMuX2FwcCk7CgkJCQlzdGFnZS5yZW1vdmVBbGxDaGlsZHJlbigpOwoJCQl9CgkJCWlmKHRydWUpCgkJCXsKCQkJCWlmKHRoaXMuX2FwcC5wYXJlbnQgPT0gdGhpcykKCQkJCQl0aGlzLnJlbW92ZUNoaWxkKHRoaXMuX2FwcCk7CgkJCQlzdGFnZS5yZW1vdmVDaGlsZHJlbigpOwoJCQl9CgkJCXRoaXMuX2FwcC5kZXN0cm95KCk7CgkJCXJlbW92ZWQgPSB0cnVlOwoJCX0KCQl0aGlzLl9hcHAgPSBudWxsOwoJCQoJCS8vIFN0b3AgdGhlIHVwZGF0ZQoJCXRoaXMucGF1c2UoKTsKCQkJCQoJCWlmKCFkZXN0cm95aW5nKQoJCXsJCQkKCQkJc3RhZ2UuYWRkQ2hpbGQodGhpcyk7CgkJCWlmKF9mcmFtZXJhdGUpCgkJCXsKCQkJCS8vIFJlc2V0IHRoZSBmcmFtZXJhdGUKCQkJCV9mcmFtZXJhdGUudGV4dCA9ICJGUFM6IDAuMDAwIjsKCQkJfQoJCQkKCQkJLy8gSWdub3JlIHNwaWtlcyBpbiBmcmFtZSBjb3VudAoJCQlfbGFzdEZyYW1lVGltZSA9IF9sYXN0RlBTVXBkYXRlVGltZSA9IF9mcmFtZXJhdGVWYWx1ZSA9IF9mcmFtZUNvdW50ID0gMDsKCQkJCgkJCS8vIFVwZGF0ZSB0aGUgc3RhZ2UKCQkJaWYodHJ1ZSkgdGhpcy5fcmVuZGVyZXIucmVuZGVyKHN0YWdlKTsKCQkJZWxzZSBpZihmYWxzZSkgdGhpcy5zdGFnZS51cGRhdGUoKTsKCQl9CgkJCgkJcmV0dXJuIHJlbW92ZWQ7Cgl9OwoJCgkvKioKCSogIEFkZCBhbiBhcHAgdG8gdGhpcyBkaXNwbGF5IGxpc3QKCSogIEBwdWJsaWMgCgkqICBAbWV0aG9kIGFkZEFwcAoJKiAgQHBhcmFtIHtBcHBsaWNhdGlvbn0gYXBwIFRoZSBhcHBsaWNhdGlvbiB0byBhZGQKCSovCglwLmFkZEFwcCA9IGZ1bmN0aW9uKGFwcCkKCXsKCQl0aGlzLnJlbW92ZUFwcCgpOwoJCWlmICghKGFwcCBpbnN0YW5jZW9mIGNsb3Vka2lkLkFwcGxpY2F0aW9uKSkKCQl7CgkJCXRocm93IG5ldyBFcnJvcigiQ2FuIG9ubHkgb2JqZWN0cyB0aGF0IGluaGVyaXQgY2xvdWRraWQuQXBwbGljYXRpb24iKTsKCQl9CgkJdGhpcy5fYXBwID0gYXBwOwoJCWlmIChfaXNSZWFkeSkKCQl7CgkJCXRoaXMuYWRkQ2hpbGRBdChhcHAsIDApOwoJCQl0aGlzLl9hcHAuaW5pdCgpOwoJCQl0aGlzLnJlc3VtZSgpOwoJCX0KCX07CgkKCS8qKgoJKiAgR2V0IHRoZSBjdXJyZW50IGFwcGxpY2F0aW9uCgkqICBAbWV0aG9kIGdldEFwcAoJKiAgQHB1YmxpYwoJKiAgQHJldHVybiB7QXBwbGljYXRpb259IFRoZSBjdXJyZW50IEFwcGxpY2F0aW9uLCBudWxsIGlmIG5vIGFwcGxpY2F0aW9uCgkqLwoJcC5nZXRBcHAgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIHRoaXMuX2FwcDsKCX07CgkKCS8qKgoJKiAgQWRkIGFuIHVwZGF0ZSBjYWxsYmFjaywgbXVzdCB0YWtlIGVsYXBzZWQgYXMgYSBwYXJhbWV0ZXIKCSogIEBtZXRob2QgYWRkVXBkYXRlQ2FsbGJhY2sKCSogIEBwdWJsaWMKCSogIEBwYXJhbSB7c3RyaW5nfSBhbGlhcyBBbiBhbGlhcyB0byBhc3NvY2lhdGUgd2l0aCB0aGlzIGNhbGxiYWNrCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBmIFRoZSBjYWxsYmFjayBmdW5jdGlvbgoJKi8KCXAuYWRkVXBkYXRlQ2FsbGJhY2sgPSBmdW5jdGlvbihhbGlhcywgZikKCXsKCQlpZiAodGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9PT0gdW5kZWZpbmVkKQoJCXsKCQkJdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9IGY7CgkJfQkJCgl9OwoJCgkvKioKCSogIFJlbW92ZSBhbiB1cGRhdGUgY2FsbGJhY2ssIG11c3QgdGFrZSBlbGFwc2VkIGFzIGEgcGFyYW1ldGVyCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlbW92ZVVwZGF0ZUNhbGxiYWNrCgkqICBAcGFyYW0ge3N0cmluZ30gYWxpYXMgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGFsaWFzCgkqLwoJcC5yZW1vdmVVcGRhdGVDYWxsYmFjayA9IGZ1bmN0aW9uKGFsaWFzKQoJewoJCWlmICh0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdICE9PSB1bmRlZmluZWQpCgkJewoJCQlkZWxldGUgdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXTsKCQl9Cgl9OwoJCgkvKioKCSogIENhbGxlZCBieSB0aGUgc3RhZ2UgbGlzdGVuZXIKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgdGljawoJKi8KCXAudGljayA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAoX3BhdXNlZCkKCQl7CgkJCV90aWNrSWQgPSAtMTsKCQkJcmV0dXJuOwoJCX0KCQkKCQl2YXIgbm93ID0gdGhpcy5nZXRUaW1lKCk7CgkJdmFyIGRUaW1lID0gbm93IC0gX2xhc3RGcmFtZVRpbWU7CgkJCgkJLy8gT25seSB1cGRhdGUgdGhlIGZyYW1lcmF0ZSBldmVyIHNlY29uZAoJCWlmKF9mcmFtZXJhdGUgJiYgX2ZyYW1lcmF0ZS52aXNpYmxlKQoJCXsKCQkJX2ZyYW1lQ291bnQrKzsKCQkJdmFyIGVsYXBzZWQgPSBub3cgLSBfbGFzdEZQU1VwZGF0ZVRpbWU7CgkJCWlmIChlbGFwc2VkID4gMTAwMCkKCQkJewoJCQkJX2ZyYW1lcmF0ZVZhbHVlID0gMTAwMCAvIGVsYXBzZWQgKiBfZnJhbWVDb3VudDsKCQkJCWlmKHRydWUpCgkJCQkJX2ZyYW1lcmF0ZS5zZXRUZXh0KCJGUFM6ICIgKyAoTWF0aC5yb3VuZChfZnJhbWVyYXRlVmFsdWUgKiAxMDAwKSAvIDEwMDApKTsKCQkJCWVsc2UgaWYoZmFsc2UpCgkJCQkJX2ZyYW1lcmF0ZS50ZXh0ID0gIkZQUzogIiArIChNYXRoLnJvdW5kKF9mcmFtZXJhdGVWYWx1ZSAqIDEwMDApIC8gMTAwMCk7CgkJCQlfbGFzdEZQU1VwZGF0ZVRpbWUgPSBub3c7CgkJCQlfZnJhbWVDb3VudCA9IDA7CgkJCX0KCQl9CgkJX2xhc3RGcmFtZVRpbWUgPSBub3c7CgkJCgkJLy91cGRhdGUgYXBwCQkJCQoJCWlmICh0aGlzLl9hcHApCgkJewoJCQl0aGlzLl9hcHAudXBkYXRlKGRUaW1lKTsKCQl9CgkJLy91cGRhdGUgb3RoZXIgZnVuY3Rpb25zCgkJZm9yKHZhciBhbGlhcyBpbiB0aGlzLl91cGRhdGVGdW5jdGlvbnMpCgkJewoJCQl0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdKGRUaW1lKTsKCQl9CgkJLy9yZW5kZXIgc3RhZ2UKCQlpZiAodHJ1ZSkgdGhpcy5fcmVuZGVyZXIucmVuZGVyKHRoaXMuc3RhZ2UpOwoJCWlmIChmYWxzZSkgdGhpcy5zdGFnZS51cGRhdGUoZFRpbWUpOwoJCQoJCS8vcmVxdWVzdCB0aGUgbmV4dCBhbmltYXRpb24gZnJhbWUKCQlfdGlja0lkID0gX3VzZVJBRiA/IAoJCQlyZXF1ZXN0QW5pbUZyYW1lKF90aWNrQ2FsbGJhY2spIDogCgkJCXNldFRhcmdldGVkVGltZW91dChfdGlja0NhbGxiYWNrLCB0aGlzLmdldFRpbWUoKSAtIF9sYXN0RnJhbWVUaW1lKTsKCX07CgkKCS8qKgoJKiAgW1BJWEkgT25seV0gUmVzaXplcyB0aGUgcmVuZGVyZXIgYW5kIHRoZSBjYW52YXNDb250YWluZXIuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc2l6ZQoJKi8KCWlmKHRydWUpCgl7CgkJcC5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQoJCXsKCQkJdGhpcy5fcmVuZGVyZXIucmVzaXplKHdpZHRoLCBoZWlnaHQpOwoJCQl0aGlzLmNhbnZhc0NvbnRhaW5lci5zZXRBdHRyaWJ1dGUoInN0eWxlIiwicG9zaXRpb246cmVsYXRpdmU7d2lkdGg6IiArIHdpZHRoICsgInB4O2hlaWdodDoiICsgaGVpZ2h0ICsgInB4Iik7CgkJfTsKCX0KCQoJLyoqCgkqICBEZXN0cm95IHRoZSBpbnN0YW5jZSBvZiB0aGUgT1MsIGNhbiBpbml0IGFmdGVyIHRoaXMsCgkqICBhbHNvIGRlc3Ryb3lzIHRoZSBhcHBsaWNhdGlvbiwgaWYgYXJvdW5kCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdmFyIHN0YWdlID0gdGhpcy5zdGFnZTsvL2tlZXAgYSByZWZlcmVuY2UgZm9yIGxhdGVyIGluIGNhc2UgdGhlIE9TIGlzIHJlbW92ZWQgZnJvbSB0aGUgc3RhZ2UKCQkKCQl2YXIgbWwgPSBjbG91ZGtpZC5NZWRpYUxvYWRlci5pbnN0YW5jZTsKCQl0aGlzLnBhdXNlKCk7CgkJdGhpcy5yZW1vdmVBcHAodHJ1ZSk7CgkJX2luc3RhbmNlID0gbnVsbDsKCQkKCQlpZihmYWxzZSkKCQl7CgkJCWNyZWF0ZWpzLlRvdWNoLmRpc2FibGUoc3RhZ2UpOwoJCQlzdGFnZS5lbmFibGVNb3VzZU92ZXIoLTEpOy8vZGlzYWJsZSBtb3VzZW92ZXIgZXZlbnRzCgkJCXN0YWdlLmVuYWJsZURPTUV2ZW50cyhmYWxzZSk7CgkJfQoJCQoJCW1sLmRlc3Ryb3koKTsKCQl0aGlzLnN0YWdlID0gbnVsbDsKCQl0aGlzLl91cGRhdGVGdW5jdGlvbnMgPSBudWxsOwoJCXJlbW92ZVBhZ2VIaWRlTGlzdGVuZXIodGhpcy52aXNpYmxlTGlzdGVuZXIpOwoJCQoJCWlmKHRydWUpCgkJewoJCQl0aGlzLnJlbW92ZUNoaWxkcmVuKHRydWUpOwoJCQlzdGFnZS5kZXN0cm95KCk7CgkJCXRoaXMuX3JlbmRlcmVyLmRlc3Ryb3koKTsKCQkJdGhpcy5fcmVuZGVyZXIgPSBudWxsOwoJCQl0aGlzLmNhbnZhc0NvbnRhaW5lciA9IG51bGw7CgkJfQoJfTsKCQoJLyoqCgkqICBTdGF0aWMgZnVuY3Rpb24gZm9yIGdldHRpbmcgdGhlIHNpbmdsZXRvbiBpbnN0YW5jZQoJKiAgQHN0YXRpYwoJKiAgQHJlYWRPbmx5CgkqICBAcHVibGljCgkqICBAYXR0cmlidXRlIGluc3RhbmNlCgkqICBAdHlwZSBPUwoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShPUywgImluc3RhbmNlIiwgewoJCWdldDpmdW5jdGlvbigpCgkJewoJCQlpZiAoIV9pbnN0YW5jZSkKCQkJewoJCQkJdGhyb3cgJ0NhbGwgY2xvdWRraWQuT1MuaW5pdChjYW52YXNJZCknOwoJCQl9CgkJCXJldHVybiBfaW5zdGFuY2U7CgkJfQoJfSk7CgkKCS8vIEFkZCB0byB0aGUgbmFtZSBzcGFjZQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLk9TID0gT1M7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgkKCS8qKiAKCSogIFRoZSBTYXZlZERhdGEgZnVuY3Rpb25zIHVzZSBsb2NhbFN0b3JhZ2UgYW5kIHNlc3Npb25TdG9yYWdlLCB3aXRoIGEgY29va2llIGZhbGxiYWNrLiAKCSoKCSogIEBjbGFzcyBTYXZlZERhdGEKCSovCgl2YXIgU2F2ZWREYXRhID0ge30sCgkKCS8qKiBBIGNvbnN0YW50IHRvIGRldGVybWluZSBpZiB3ZSBjYW4gdXNlIGxvY2FsU3RvcmFnZSBhbmQgc2Vzc2lvblN0b3JhZ2UgKi8KCVdFQl9TVE9SQUdFX1NVUFBPUlQgPSB0eXBlb2Yod2luZG93LlN0b3JhZ2UpICE9PSAidW5kZWZpbmVkIiwKCQoJLyoqIEEgY29uc3RhbnQgZm9yIGNvb2tpZSBmYWxsYmFjayBmb3IgU2F2ZWREYXRhLmNsZWFyKCkgKi8KCUVSQVNFX0NPT0tJRSA9IC0xOwoKCS8vaW4gaU9TLCBpZiB0aGUgdXNlciBpcyBpbiBQcml2YXRlIEJyb3dzaW5nLCB3cml0aW5nIHRvIGxvY2FsU3RvcmFnZSB0aHJvd3MgYW4gZXJyb3IuCglpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJewoJCXRyeQoJCXsKCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpOwoJCQlsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiTFNfVEVTVCIpOwoJCX0KCQljYXRjaChlKQoJCXsKCQkJV0VCX1NUT1JBR0VfU1VQUE9SVCA9IGZhbHNlOwoJCX0KCX0KCgkvKioKCSAqIElmIFNhdmVkRGF0YSB3aWxsIGJlIHVzaW5nIGxvY2FsU3RvcmFnZSBhbmQgc2Vzc2lvblN0b3JhZ2UuCgkgKiBAcHJvcGVydHkge0Jvb2xlYW59IHVzZVdlYlN0b3JhZ2UKCSAqIEBkZWZhdWx0ICB0cnVlCgkgKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShTYXZlZERhdGEsICJ1c2VXZWJTdG9yYWdlIiwgewoJCWdldDogZnVuY3Rpb24oKSB7IHJldHVybiBXRUJfU1RPUkFHRV9TVVBQT1JUOyB9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQlpZih2YWx1ZSAmJiB0eXBlb2Yod2luZG93LlN0b3JhZ2UpICE9PSAidW5kZWZpbmVkIikKCQkJewoJCQkJdHJ5CgkJCQl7CgkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpOwoJCQkJCWxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJMU19URVNUIik7CgkJCQkJV0VCX1NUT1JBR0VfU1VQUE9SVCA9IHRydWU7CgkJCQl9CgkJCQljYXRjaChlKQoJCQkJewoJCQkJCVdFQl9TVE9SQUdFX1NVUFBPUlQgPSBmYWxzZTsKCQkJCX0KCQkJfQoJCQllbHNlCgkJCQlXRUJfU1RPUkFHRV9TVVBQT1JUID0gZmFsc2U7CgkJfQoJfSk7IAoJCgkvKiogCgkqICBSZW1vdmUgYSBzYXZlZCB2YXJpYWJsZSBieSBuYW1lLgoJKiAgQG1ldGhvZCByZW1vdmUKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB2YWx1ZSB0byByZW1vdmUKCSovCglTYXZlZERhdGEucmVtb3ZlID0gZnVuY3Rpb24obmFtZSkKCXsKCQlpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJCXsKCQkJbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0obmFtZSk7CgkJCXNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0obmFtZSk7CgkJfQoJCWVsc2UKCQkJU2F2ZWREYXRhLndyaXRlKG5hbWUsIiIsRVJBU0VfQ09PS0lFKTsKCX07CgkKCS8qKgoJKiAgU2F2ZSBhIHZhcmlhYmxlLgoJKiAgQG1ldGhvZCB3cml0ZQoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHZhbHVlIHRvIHNhdmUKCSogIEBwYXJhbSB7bWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzYXZlLiBUaGlzIHdpbGwgYmUgcnVuIHRocm91Z2ggSlNPTi5zdHJpbmdpZnkoKS4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW3RlbXBPbmx5PWZhbHNlXSBJZiB0aGUgdmFsdWUgc2hvdWxkIGJlIHNhdmVkIG9ubHkgaW4gdGhlIGN1cnJlbnQgYnJvd3NlciBzZXNzaW9uLgoJKi8KCVNhdmVkRGF0YS53cml0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCB0ZW1wT25seSkKCXsKCQlpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJCXsKCQkJaWYodGVtcE9ubHkpCgkJCQlzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7CgkJCWVsc2UKCQkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7CgkJfQoJCWVsc2UKCQl7CgkJCXZhciBleHBpcmVzOwoJCQlpZiAodGVtcE9ubHkpCgkJCXsKCQkJCWlmKHRlbXBPbmx5ICE9PSBFUkFTRV9DT09LSUUpCgkJCQkJZXhwaXJlcyA9ICIiOy8vcmVtb3ZlIHdoZW4gYnJvd3NlciBpcyBjbG9zZWQKCQkJCWVsc2UKCQkJCQlleHBpcmVzID0gIjsgZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCI7Ly9zYXZlIGNvb2tpZSBpbiB0aGUgcGFzdCBmb3IgaW1tZWRpYXRlIHJlbW92YWwKCQkJfQoJCQllbHNlCgkJCQlleHBpcmVzID0gIjsgZXhwaXJlcz0iK25ldyBEYXRlKDIxNDc0ODM2NDYwMDApLnRvR01UU3RyaW5nKCk7Ly9USEUgRU5EIE9GICgzMmJpdCBVTklYKSBUSU1FIQoJCQkJCgkJCWRvY3VtZW50LmNvb2tpZSA9IG5hbWUrIj0iK2VzY2FwZShKU09OLnN0cmluZ2lmeSh2YWx1ZSkpK2V4cGlyZXMrIjsgcGF0aD0vIjsKCQl9Cgl9OwoJCgkvKioKCSogIFJlYWQgdGhlIHZhbHVlIG9mIGEgc2F2ZWQgdmFyaWFibGUKCSogIEBtZXRob2QgcmVhZAoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHZhcmlhYmxlCgkqICBAcmV0dXJuIHttaXhlZH0gVGhlIHZhbHVlIChydW4gdGhyb3VnaCBgSlNPTi5wYXJzZSgpYCkgb3IgbnVsbCBpZiBpdCBkb2Vzbid0IGV4aXN0CgkqLwoJU2F2ZWREYXRhLnJlYWQgPSBmdW5jdGlvbihuYW1lKQoJewoJCWlmKFdFQl9TVE9SQUdFX1NVUFBPUlQpCgkJewoJCQl2YXIgdmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShuYW1lKSB8fCBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKG5hbWUpOwoJCQlpZih2YWx1ZSkKCQkJCXJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKCQkJZWxzZQoJCQkJcmV0dXJuIG51bGw7CgkJfQoJCWVsc2UKCQl7CgkJCXZhciBuYW1lRVEgPSBuYW1lICsgIj0iLAoJCQkJY2EgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoJzsnKSwKCQkJCWkgPSAwLCBjOwoJCQkJCgkJCWZvcihpPTA7aSA8IGNhLmxlbmd0aDtpKyspCgkJCXsKCQkJCWMgPSBjYVtpXTsKCQkJCXdoaWxlIChjLmNoYXJBdCgwKSA9PSAnICcpIGMgPSBjLnN1YnN0cmluZygxLGMubGVuZ3RoKTsKCQkJCWlmIChjLmluZGV4T2YobmFtZUVRKSA9PT0gMCkgcmV0dXJuIEpTT04ucGFyc2UodW5lc2NhcGUoYy5zdWJzdHJpbmcobmFtZUVRLmxlbmd0aCxjLmxlbmd0aCkpKTsKCQkJfQoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIGdsb2JhbCBzcGFjZQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLlNhdmVkRGF0YSA9IFNhdmVkRGF0YTsKCQp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24oKXsKCQoJInVzZSBzdHJpY3QiOwoJCgkvLyBDb21iaW5lIHByZWZpeGVkIFVSTCBmb3IgY3JlYXRlT2JqZWN0VVJMIGZyb20gYmxvYnMuCgl3aW5kb3cuVVJMID0gd2luZG93LlVSTCB8fCB3aW5kb3cud2Via2l0VVJMOwoKCS8vIENvbWJpbmUgcHJlZml4ZWQgYmxvYiBidWlsZGVyCgl3aW5kb3cuQmxvYkJ1aWxkZXIgPSB3aW5kb3cuQmxvYkJ1aWxkZXIgfHwgd2luZG93LldlYktpdEJsb2JCdWlsZGVyIHx8IHdpbmRvdy5Nb3pCbG9iQnVpbGRlcjsKCgkvKioKCSogIFRoZSBXZWIgV29ya2VycyBzcGVjaWZpY2F0aW9uIGRlZmluZXMgYW4gQVBJIGZvciBzcGF3bmluZyBiYWNrZ3JvdW5kIHNjcmlwdHMgaW4geW91ciB3ZWIgCgkqICBhcHBsaWNhdGlvbi4gV2ViIFdvcmtlcnMgYWxsb3cgeW91IHRvIGRvIHRoaW5ncyBsaWtlIGZpcmUgdXAgbG9uZy1ydW5uaW5nIHNjcmlwdHMgdG8gCgkqICBoYW5kbGUgY29tcHV0YXRpb25hbGx5IGludGVuc2l2ZSB0YXNrcywgYnV0IHdpdGhvdXQgYmxvY2tpbmcgdGhlIFVJIG9yIG90aGVyIHNjcmlwdHMgCgkqICB0byBoYW5kbGUgdXNlciBpbnRlcmFjdGlvbnMuIEJlY2F1c2UgV29ya2VycyBhcmVuJ3QgYXZhaWxhYmxlIG9uIGFsbCBicm93c2Vycywgd2UgcHJvdmlkZQoJKiAgYSBoZWxwZnVsIHBvbHlmaWxsIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LgoJKgoJKgl2YXIgd29ya2VyQ29kZSA9ICJ0aGlzLmluaXRpYWxWYXJpYWJsZSA9IDEwOyIgKwoJKgkidGhpcy5vbm1lc3NhZ2UgPSBmdW5jdGlvbihldmVudCkiICsKCSoJInsiICsKCSoJCSJ2YXIgZGF0YSA9IGV2ZW50LmRhdGE7IiArCgkqCQkidmFyIHJldHVyblZhbCA9IHRoaXMuaW5pdGlhbFZhcmlhYmxlICsgZGF0YS5hZGRWYWx1ZTsiICsKCSoJCSJ0aGlzLnBvc3RNZXNzYWdlKHJldHVyblZhbCk7IiArCgkqCSJ9OyI7CgkqCgkqCS8vIENyZWF0ZSB0aGUgd29ya2VyCgkqCXZhciB3b3JrZXIgPSBjbG91ZGtpZC5Xb3JrZXIuaW5pdCh3b3JrZXJDb2RlKTsKCSoJd29ya2VyLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGUpIHsKCSoJCS8vIGUuZGF0YSBpcyB0aGUgcmV0dXJuVmFsCgkqCX07CgkqCQoJKgkvLyBTdGFydCB0aGUgd29ya2VyLgoJKgl3b3JrZXIucG9zdE1lc3NhZ2UoKTsgCgkqCgkqICBAY2xhc3MgV29ya2VyCgkqLwoJdmFyIFdvcmtlciA9IHt9OwoKCS8qKgoJKiAgSW5pdGlhbGl6ZSB0aGUgd29ya2VyLCB0aGlzIGlzIGhvdyB5b3UgY3JlYXRlIGEgV29ya2VyIG9yIEZhbGxiYWNrV29ya2VyIG9iamVjdC4KCSogIEBtZXRob2QgaW5pdAoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IGNvZGVTdHJpbmcgVGhlIGNvZGUgaW4gc3RyaW5nIGZvcm0gdG8gbWFrZSB0aGUgd29ya2VyIGZyb20uIEFzIGEgc3RyaW5nLCBmYWxsYmFjayBzdXBwb3J0IGlzIGVhc2llci4KCSogIEByZXR1cm4ge0ZhbGxiYWNrV29ya2VyfHdpbmRvdy5Xb3JrZXJ9IEVpdGhlciBhIFdlYiBXb3JrZXIgb3IgYSBmYWxsYmFjayB3aXRoIHRoZSBzYW1lIEFQSSB0byB1c2UuCgkqLwoJV29ya2VyLmluaXQgPSBmdW5jdGlvbihjb2RlU3RyaW5nKQoJewoJCWlmKCF3aW5kb3cuVVJMIHx8ICF3aW5kb3cuV29ya2VyKSByZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwoKCQl2YXIgYmxvYjsKCQl0cnkKCQl7CgkJCWJsb2IgPSBuZXcgQmxvYihbY29kZVN0cmluZ10sIHt0eXBlOiAnYXBwbGljYXRpb24vamF2YXNjcmlwdCd9KTsKCQl9CgkJY2F0Y2ggKGUpCgkJewoJCQkvLyB0cnkgQmFja3dhcmRzLWNvbXBhdGliaWxpdHkgd2l0aCBibG9iIGJ1aWxkZXJzCgkJCWlmKCF3aW5kb3cuQmxvYkJ1aWxkZXIpIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CgkJCXRyeQoJCQl7CgkJCQlibG9iID0gbmV3IEJsb2JCdWlsZGVyKCk7CgkJCQlibG9iLmFwcGVuZChjb2RlU3RyaW5nKTsKCQkJCWJsb2IgPSBibG9iLmdldEJsb2IoKTsKCQkJfQoJCQljYXRjaChlcnJvcikKCQkJewoJCQkJLy9ubyB3YXkgb2YgZ2VuZXJhdGluZyBhIGJsb2IgdG8gY3JlYXRlIHRoZSB3b3JrZXIgZnJvbQoJCQkJcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKCQkJfQoJCX0KCQlpZighYmxvYikgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsvL2lmIHNvbWVob3cgbm8gYmxvYiB3YXMgY3JlYXRlZCwgcmV0dXJuIGEgZmFsbGJhY2sgd29ya2VyCgkJdHJ5CgkJewoJCQkvL0lFIDEwIGFuZCAxMSwgd2hpbGUgc3VwcG9ydGluZyBCbG9iIGFuZCBXb3JrZXJzLCBzaG91bGQgdGhyb3cgYW4gZXJyb3IgaGVyZSwgc28gd2Ugc2hvdWxkIGNhdGNoIGl0IGFuZCBmYWxsIGJhY2sKCQkJdmFyIHdvcmtlciA9IG5ldyBXb3JrZXIoVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKSk7CgkJCXJldHVybiB3b3JrZXI7CgkJfQoJCWNhdGNoKGUpCgkJewoJCQkvL2Nhbid0IGNyZWF0ZSBhIHdvcmtlcgoJCQlyZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwoJCX0KCX07CgoJLy8gRGVwcmVjYXRlZCBpbXBsZW1lbnRhdGlvbgoJbmFtZXNwYWNlKCJjbG91ZGtpZCIpLmNyZWF0ZVdvcmtlciA9IFdvcmtlci5pbml0OwoKCS8vIEFzc2lnbiB0byBuYW1lc3BhY2UKCW5hbWVzcGFjZSgiY2xvdWRraWQiKS5Xb3JrZXIgPSBXb3JrZXI7CgkKCS8qKgoJKglJbnRlcm5hbCBjbGFzcyB0aGF0IHByZXRlbmRzIHRvIGJlIGEgV2ViIFdvcmtlcidzIGNvbnRleHQuCgkqCUBjbGFzcyBTdWJXb3JrZXIKCSoJQGNvbnN0cnVjdG9yCgkqCUBwYXJhbSB7U3RyaW5nfSBjb2RlU3RyaW5nIEEgc3RyaW5nIHRvIGV2YWx1YXRlIGludG8gd29ya2VyIGNvZGUuCgkqCUBwYXJhbSB7RmFsbGJhY2tXb3JrZXJ9IHBhcmVudCBUaGUgRmFsbGJhY2tXb3JrZXIgdGhhdCBvd25zIHRoaXMgU3ViV29ya2VyLgoJKi8KCXZhciBTdWJXb3JrZXIgPSBmdW5jdGlvbihjb2RlU3RyaW5nLCBwYXJlbnQpCgl7CgkJdGhpcy5fd1BhcmVudCA9IHBhcmVudDsKCQlldmFsKGNvZGVTdHJpbmcpOyAvLyBqc2hpbnQgaWdub3JlOmxpbmUKCX07CgoJdmFyIHAgPSBTdWJXb3JrZXIucHJvdG90eXBlOwoKCS8qKgoJKglzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dvcmtlci5vbm1lc3NhZ2UKCSoJQHByb3BlcnR5IHtGdW5jdGlvbn0gb25tZXNzYWdlCgkqLwoJcC5vbm1lc3NhZ2UgPSBudWxsOwoKCS8qKgoJKglUaGUgRmFsbGJhY2tXb3JrZXIgdGhhdCBpcyBjb250cm9sbHMgYnkgdGhpcyBTdWJXb3JrZXIuCgkqCUBwcm9wZXJ0eSB7RmFsbGJhY2tXb3JrZXJ9IF93UGFyZW50CgkqCUBwcml2YXRlCgkqLwoJcC5fd1BhcmVudCA9IG51bGw7CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLnBvc3RNZXNzYWdlCgkqCUBtZXRob2QgcG9zdE1lc3NhZ2UKCSoJQHBhcmFtIHsqfSBkYXRhIFRoZSBkYXRhIHRvIHNlbmQuCgkqLwoJcC5wb3N0TWVzc2FnZSA9IGZ1bmN0aW9uKGRhdGEpCgl7CgkJdmFyIHBhcmVudCA9IHRoaXMuX3dQYXJlbnQ7CgkJc2V0VGltZW91dChwYXJlbnQub25tZXNzYWdlLmJpbmQocGFyZW50LCB7ZGF0YTpkYXRhfSksIDEpOwoJfTsKCQoJLyoqCgkqCUFuIGludGVybmFsIGNsYXNzIHRoYXQgZHVwbGljYXRlcyB0aGUgV29ya2VyIEFQSSBhcyBhIGZhbGxiYWNrIHdoZW4gV2ViV29ya2VycyBhcmUgbm90IHN1cHBvcnRlZC4KCSoJQGNsYXNzIEZhbGxiYWNrV29ya2VyCgkqCUBjb25zdHJ1Y3RvcgoJKglAcGFyYW0ge1N0cmluZ30gY29kZVN0cmluZyBBIHN0cmluZyB0byBldmFsdWF0ZSBpbnRvIHdvcmtlciBjb2RlLgoJKi8KCXZhciBGYWxsYmFja1dvcmtlciA9IGZ1bmN0aW9uKGNvZGVTdHJpbmcpCgl7CgkJdGhpcy5fd0NoaWxkID0gbmV3IFN1Yldvcmtlcihjb2RlU3RyaW5nLCB0aGlzKTsKCX07CgoJcCA9IEZhbGxiYWNrV29ya2VyLnByb3RvdHlwZTsKCgkvKioKCSoJU2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9Xb3JrZXIucG9zdE1lc3NhZ2UKCSoJQG1ldGhvZCBwb3N0TWVzc2FnZQoJKglAcGFyYW0geyp9IGRhdGEgVGhlIGRhdGEgdG8gc2VuZC4KCSovCglwLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24oZGF0YSkKCXsKCQl2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CgkJc2V0VGltZW91dChjaGlsZC5vbm1lc3NhZ2UuYmluZChjaGlsZCwge2RhdGE6ZGF0YX0pLCAxKTsKCX07CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLnRlcm1pbmF0ZQoJKglAbWV0aG9kIHRlcm1pbmF0ZQoJKi8KCXAudGVybWluYXRlID0gZnVuY3Rpb24oKQoJewoJCXRoaXMub25tZXNzYWdlID0gbnVsbDsKCQl2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CgkJY2hpbGQuX3dQYXJlbnQgPSBudWxsOwoJCWNoaWxkLm9ubWVzc2FnZSA9IG51bGw7CgkJdGhpcy5fd0NoaWxkID0gbnVsbDsKCX07CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLm9ubWVzc2FnZQoJKglAcHJvcGVydHkge0Z1bmN0aW9ufSBvbm1lc3NhZ2UKCSovCglwLm9ubWVzc2FnZSA9IG51bGw7CgkKCS8qKgoJKglUaGUgU3ViV29ya2VyIHRoYXQgaXMgY29udHJvbGxlZCBieSB0aGlzIEZhbGxiYWNrV29ya2VyLgoJKglAcHJvcGVydHkge1N1Yldvcmtlcn0gX3dDaGlsZAoJKglAcHJpdmF0ZQoJKi8KCXAuX3dDaGlsZCA9IG51bGw7CgkKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCkgewoJCgkidXNlIHN0cmljdCI7CgoJLyoqCgkqICBBIGZ1bmN0aW9uIHRoYXQgaXMgdXNlZCBhcyBhIG5vcm1hbCBjYWxsYmFjaywgYnV0IGNoZWNrcyBhbiBvYmplY3QgZm9yIGEgcHJvcGVydHkgaW4gb3JkZXIgdG8gY29tYmluZSB0d28KCSogIGNhbGxiYWNrcyBpbnRvIG9uZS4gRm9yIGV4YW1wbGUgdXNhZ2U6CgkqCgkqICB2YXIgdm9QbGF5ZXIgPSBuZXcgY2xvdWRraWQuVk9QbGF5ZXIoKTsKCSogIHZhciBjYWxsYmFjayA9IGNsb3Vka2lkLkNvbWJpbmVkQ2FsbGJhY2suY3JlYXRlKG15RnVuYy5iaW5kKHRoaXMpLCB2b1BsYXllciwgInBsYXlpbmciLCAiX2NhbGxiYWNrIik7CgkqICBBbmltYXRvci5wbGF5KG15Q2xpcCwgIm15QW5pbSIsIGNhbGxiYWNrKTsKCSogIAoJKiAgSW4gdGhpcyBleGFtcGxlLCB3aGVuIEFuaW1hdG9yIGNhbGxzICdjYWxsYmFjaycsIGlmIHZvUGxheWVyWyJwbGF5aW5nIl0gaXMgZmFsc2UsICdteUZ1bmMnIGlzIGNhbGxlZCBpbW1lZGlhdGVseS4KCSogIElmIHZvUGxheWVyWyJwbGF5aW5nIl0gaXMgdHJ1ZSwgdGhlbiB2b1BsYXllclsiX2NhbGxiYWNrIl0gaXMgc2V0IHRvICdteUZ1bmMnIHNvIHRoYXQgaXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB2b1BsYXllciBjb21wbGV0ZXMuCgkqICAKCSogIEBjbGFzcyBDb21iaW5lZENhbGxiYWNrCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGwgVGhlIGNhbGxiYWNrIHRvIGNhbGwgd2hlbiBldmVyeXRoaW5nIGlzIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHsqfSBvYmogVGhlIG9iamVjdCB0byBjaGVjayBhcyBhbiBhZGRpdGlvbmFsIGNvbXBsZXRpb24gZGVwZW5kZW5jeS4KCSogIEBwYXJhbSB7U3RyaW5nfSBwcm9wIFRoZSBwcm9wZXJ0eSB0byBjaGVjayBvbiBvYmouIElmIG9ialtwcm9wXSBpcyBmYWxzZSwgdGhlbiBpdCBpcyBjb25zaWRlcmVkIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHtTdHJpbmd9IGNhbGxQcm9wIFRoZSBwcm9wZXJ0eSB0byBzZXQgb24gb2JqIGlmIG9ialtwcm9wXSBpcyB0cnVlIHdoZW4gdGhlIENvbWJpbmVkQ2FsbGJhY2sgaXMgY2FsbGVkLgoJKi8KCXZhciBDb21iaW5lZENhbGxiYWNrID0gZnVuY3Rpb24oY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCkKCXsKCQlpZighb2JqW3Byb3BdKS8vYWNjZXB0IGFueXRoaW5nIHRoYXQgcmVzb2x2ZXMgdG8gZmFsc2U6IGVnIHZvUGxheWVyLnBsYXlpbmcgPT0gZmFsc2UKCQkJY2FsbCgpOwoJCWVsc2UKCQkJb2JqW2NhbGxQcm9wXSA9IGNhbGw7Cgl9OwoKCS8qKgoJKiAgQ3JlYXRlcyBhIENvbWJpbmVkQ2FsbGJhY2sgZm9yIHVzZS4KCSogIAoJKiAgQG1ldGhvZCBjcmVhdGUKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGwgVGhlIGNhbGxiYWNrIHRvIGNhbGwgd2hlbiBldmVyeXRoaW5nIGlzIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHsqfSBvYmogVGhlIG9iamVjdCB0byBjaGVjayBhcyBhbiBhZGRpdGlvbmFsIGNvbXBsZXRpb24gZGVwZW5kZW5jeS4KCSogIEBwYXJhbSB7U3RyaW5nfSBwcm9wIFRoZSBwcm9wZXJ0eSB0byBjaGVjayBvbiBvYmouIElmIG9ialtwcm9wXSBpcyBmYWxzZSwgdGhlbiBpdCBpcyBjb25zaWRlcmVkIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHtTdHJpbmd9IGNhbGxQcm9wIFRoZSBwcm9wZXJ0eSB0byBzZXQgb24gb2JqIGlmIG9ialtwcm9wXSBpcyB0cnVlIHdoZW4gdGhlIENvbWJpbmVkQ2FsbGJhY2sgaXMgY2FsbGVkLgoJKi8KCUNvbWJpbmVkQ2FsbGJhY2suY3JlYXRlID0gZnVuY3Rpb24oY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCkKCXsKCQlyZXR1cm4gQ29tYmluZWRDYWxsYmFjay5iaW5kKHRoaXMsIGNhbGwsIG9iaiwgcHJvcCwgY2FsbFByb3ApOwoJfTsKCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuQ29tYmluZWRDYWxsYmFjayA9IENvbWJpbmVkQ2FsbGJhY2s7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkidXNlIHN0cmljdCI7CgoJdmFyIE5FWFRfSUQgPSAwOwoKCS8qKgoJKiAgQSBjbGFzcyBmb3IgZGVsYXlpbmcgYSBjYWxsIHRocm91Z2ggdGhlIE9TLCBpbnN0ZWFkIG9mIHJlbHlpbmcgb24gc2V0SW50ZXJ2YWwoKSBvciBzZXRUaW1lb3V0KCkuCgkqIAoJKiAgQGNsYXNzIERlbGF5ZWRDYWxsCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGRlbGF5IGhhcyBjb21wbGV0ZWQuCgkqICBAcGFyYW0ge2ludH0gZGVsYXkgVGhlIHRpbWUgdG8gZGVsYXkgdGhlIGNhbGwsIGluIG1pbGxpc2Vjb25kcy4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gcmVwZWF0PWZhbHNlIElmIHRoZSBEZWxheWVkQ2FsbCBzaG91bGQgYXV0b21hdGljYWxseSByZXBlYXQgaXRzZWxmIHdoZW4gY29tcGxldGVkLgoJKiAgQHBhcmFtIHtCb29sZWFufSBhdXRvRGVzdHJveT10cnVlIElmIHRoZSBEZWxheWVkQ2FsbCBzaG91bGQgY2xlYW4gaXRzZWxmIHVwIHdoZW4gY29tcGxldGVkLgoJKi8KCXZhciBEZWxheWVkQ2FsbCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZWxheSwgcmVwZWF0LCBhdXRvRGVzdHJveSkKCXsKCQkvKioKCQkqICBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBkZWxheSBpcyBjb21wbGV0ZWQuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBfY2FsbGJhY2sKCQkqLwoJCXRoaXMuX2NhbGxiYWNrID0gY2FsbGJhY2s7CgkJLyoqCgkJKiAgVGhlIGRlbGF5IHRpbWUsIGluIG1pbGxpc2Vjb25kcy4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7aW50fSBfZGVsYXkKCQkqLwoJCXRoaXMuX2RlbGF5ID0gZGVsYXk7CgkJLyoqCgkJKiAgVGhlIHRpbWVyIGNvdW50aW5nIGRvd24gZnJvbSBfZGVsYXksIGluIG1pbGxpc2Vjb25kcy4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7aW50fSBfdGltZXIKCQkqLwoJCXRoaXMuX3RpbWVyID0gZGVsYXk7CgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCByZXBlYXQgaXRzZWxmIGF1dG9tYXRpY2FsbHkuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9yZXBlYXQKCQkqICBAZGVmYXVsdCBmYWxzZQoJCSovCgkJdGhpcy5fcmVwZWF0ID0gISFyZXBlYXQ7CgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCBkZXN0cm95IGl0c2VsZiBhZnRlciBjb21wbGV0aW5nCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9hdXRvRGVzdHJveQoJCSogIEBkZWZhdWx0IHRydWUKCQkqLwoJCXRoaXMuX2F1dG9EZXN0cm95ID0gYXV0b0Rlc3Ryb3kgPT09IHVuZGVmaW5lZCA/IHRydWUgOiAhIWF1dG9EZXN0cm95OwoJCS8qKgoJCSogIFRoZSB1bmlxdWUgSUQgdXNlZCBmb3IgdGhlIHVwZGF0ZSBjYWxsYmFjayBmb3IgdGhlIE9TLgoJCSogIEBwcml2YXRlCgkJKiAgQHByb3BlcnR5IHtTdHJpbmd9IF91cGRhdGVJZAoJCSovCgkJdGhpcy5fdXBkYXRlSWQgPSAiRGVsYXllZENhbGwjIiArICgrK05FWFRfSUQpOwoJCS8qKgoJCSogIElmIHRoZSBEZWxheWVkQ2FsbCBpcyBjdXJyZW50bHkgcGF1c2VkIChub3Qgc3RvcHBlZCkuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9wYXVzZWQKCQkqLwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoKCQkvL3NhdmUgYSBib3VuZCB2ZXJzaW9uIG9mIHRoZSB1cGRhdGUgZnVuY3Rpb24KCQl0aGlzLl91cGRhdGUgPSB0aGlzLl91cGRhdGUuYmluZCh0aGlzKTsKCQkvL3N0YXJ0IHRoZSBkZWxheQoJCWNsb3Vka2lkLk9TLmluc3RhbmNlLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpOwoJfTsKCgl2YXIgcCA9IERlbGF5ZWRDYWxsLnByb3RvdHlwZTsKCgkvKioKCSogIFRoZSBjYWxsYmFjayBzdXBwbGllZCB0byB0aGUgT1MgZm9yIGFuIHVwZGF0ZSBlYWNoIGZyYW1lLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX3VwZGF0ZQoJKiAgQHBhcmFtIHtpbnR9IGVsYXBzZWQgVGhlIHRpbWUgZWxhcHNlZCBzaW5jZSB0aGUgcHJldmlvdXMgZnJhbWUuCgkqLwoJcC5fdXBkYXRlID0gZnVuY3Rpb24oZWxhcHNlZCkKCXsKCQlpZighdGhpcy5fY2FsbGJhY2spCgkJewoJCQl0aGlzLmRlc3Ryb3koKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fdGltZXIgLT0gZWxhcHNlZDsKCQlpZih0aGlzLl90aW1lciA8PSAwKQoJCXsKCQkJdGhpcy5fY2FsbGJhY2soKTsKCQkJaWYodGhpcy5fcmVwZWF0KQoJCQkJdGhpcy5fdGltZXIgKz0gdGhpcy5fZGVsYXk7CgkJCWVsc2UgaWYodGhpcy5fYXV0b0Rlc3Ryb3kpCgkJCQl0aGlzLmRlc3Ryb3koKTsKCQkJZWxzZQoJCQkJY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpOwoJCX0KCX07CgoJLyoqCgkqICBSZXN0YXJ0cyB0aGUgRGVsYXllZENhbGwsIHdoZXRoZXIgaXQgaXMgcnVubmluZyBvciBub3QuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc3RhcnQKCSovCglwLnJlc3RhcnQgPSBmdW5jdGlvbigpCgl7CgkJaWYoIXRoaXMuX2NhbGxiYWNrKSByZXR1cm47CgkJdmFyIG9zID0gY2xvdWRraWQuT1MuaW5zdGFuY2U7CgkJLy9jYW4ndCBhZGQgZHVwbGljYXRlcwoJCW9zLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpOwoJCXRoaXMuX3RpbWVyID0gdGhpcy5fZGVsYXk7CgkJdGhpcy5fcGF1c2VkID0gZmFsc2U7Cgl9OwoKCS8qKgoJKiAgU3RvcHMgdGhlIERlbGF5ZWRDYWxsLCB3aXRob3V0IGRlc3Ryb3lpbmcgaXQuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHN0b3AKCSovCglwLnN0b3AgPSBmdW5jdGlvbigpCgl7CgkJY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpOwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJfTsKCgkvKioKCSogIElmIHRoZSBEZWxheWVkQ2FsbCBpcyBwYXVzZWQgb3Igbm90LgoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBwYXVzZWQKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInBhdXNlZCIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5fcGF1c2VkOyB9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQlpZighdGhpcy5fY2FsbGJhY2spIHJldHVybjsKCQkJdmFyIG9zID0gY2xvdWRraWQuT1MuaW5zdGFuY2U7CgkJCWlmKHRoaXMuX3BhdXNlZCAmJiAhdmFsdWUpCgkJCXsKCQkJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJCQkJaWYoIW9zLmhhc1VwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSkKCQkJCQlvcy5hZGRVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCwgdGhpcy5fdXBkYXRlKTsKCQkJfQoJCQllbHNlIGlmKHZhbHVlKQoJCQl7CgkJCQlpZihvcy5oYXNVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCkpCgkJCQl7CgkJCQkJdGhpcy5fcGF1c2VkID0gdHJ1ZTsKCQkJCQlvcy5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCk7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCgkvKioKCSogIFN0b3BzIGFuZCBjbGVhbnMgdXAgdGhlIERlbGF5ZWRDYWxsLiBEbyBub3QgdXNlIGl0IGFmdGVyIGNhbGxpbmcKCSogIGRlc3Ryb3koKS4KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQljbG91ZGtpZC5PUy5pbnN0YW5jZS5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCk7CgkJdGhpcy5fY2FsbGJhY2sgPSBudWxsOwoJfTsKCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuRGVsYXllZENhbGwgPSBEZWxheWVkQ2FsbDsKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCl7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIEFuIGFwcGxpY2F0aW9uIGlzIGFuIGFic3RyYWN0IGNsYXNzIHdoaWNoIGV4dGVuZHMgYGNyZWF0ZWpzLkNvbnRhaW5lcmAKCSogIGFuZCBpcyBtYW5hZ2VkIGJ5IHRoZSBgY2xvdWRraWQuT1NgCgkqCgkqICBAY2xhc3MgQXBwbGljYXRpb24KCSovCgl2YXIgQXBwbGljYXRpb24gPSBmdW5jdGlvbigpCgl7CgkJaWYoZmFsc2UpIAoJCXsKCQkJdGhpcy5pbml0aWFsaXplKCk7CgkJfQkKCQllbHNlIGlmKHRydWUpCgkJewoJCQlQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCh0aGlzKTsKCQl9CQoJfTsKCQoJLy8gU2hvcnRjdXQgcmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUKCXZhciBwOwoJCgkvLyBFeHRlbmRzIHRoZSBjb250YWluZXIKCWlmIChmYWxzZSkKCXsKCQlwID0gQXBwbGljYXRpb24ucHJvdG90eXBlID0gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpOwoJfQoJLy8gRXh0ZW5kcyB0aGUgUElYSSBkaXNwbGF5IG9iamVjdAoJZWxzZSBpZiAodHJ1ZSkKCXsKCQlwID0gQXBwbGljYXRpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKTsKCX0KCQkKCS8qKgoJKiBUaGUgYXBwbGljYXRpb24gaXMgcmVhZHkgdG8gdXNlLCBhZGRlZCB0byBzdGFnZQoJKgoJKiBAcHVibGljCgkqIEBtZXRob2QgaW5pdAoJKi8KCXAuaW5pdCA9IGZ1bmN0aW9uKCl7fTsKCQoJLyoqCgkqICBUaGUgdXBkYXRlZCBmdW5jdGlvbiBjYWxsZWQgYnkgdGhlIE9TCgkqICB0aGlzIGZ1bmN0aW9uIGlzIGltcGxlbWVudGF0aW9uLXNwZWNpZmljCgkqCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHVwZGF0ZQoJKiAgQHBhcmFtIHtpbnR9IGVsYXBzZWQgVGhlIG51bWJlciBvZiBNUyBzaW5jZSB0aGUgbGFzdCBmcmFtZSB1cGRhdGUKCSovCglwLnVwZGF0ZSA9IGZ1bmN0aW9uKGVsYXBzZWQpe307CgkKCS8qKgoJKiBEZXN0cm95IHRoZSBhcHBsaWNhdGlvbiwgZG9uJ3QgdXNlIGFmdGVyIHRoaXMKCSogCgkqIEBwdWJsaWMKCSogQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKXt9OwoJCgkvKioKCSogIFJlc2l6ZSB0aGUgYXBwbGljYXRpb24KCSoKCSogQHB1YmxpYyAKCSogQG1ldGhvZCByZXNpemUKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKCl7fTsKCQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLkFwcGxpY2F0aW9uID0gQXBwbGljYXRpb247Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgoJLyoqCgkqICBSZXByZXNlbnRzIGEgc2luZ2xlIGl0ZW0gaW4gdGhlIGxvYWRlciBxdWV1ZSAKCSoKCSogIEBjbGFzcyBMb2FkZXJRdWV1ZUl0ZW0KCSovCgl2YXIgTG9hZGVyUXVldWVJdGVtID0gZnVuY3Rpb24oKXt9OwoJCgkvKiogUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gTG9hZGVyUXVldWVJdGVtLnByb3RvdHlwZTsKCQoJLyoqIAoJKiBIaWdoZXN0IHByaW9yaXR5CgkqIEBzdGF0aWMKCSogQHB1YmxpYwoJKiBAZmluYWwKCSogQHByb3BlcnR5IHtpbnR9IFBSSU9SSVRZX0hJR0gKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfSElHSCA9IDE7CgkKCS8qKiAKCSogTm9ybWFsIHByaW9yaXR5LCB0aGUgZGVmYXVsdAoJKiBAc3RhdGljCgkqIEBwdWJsaWMKCSogQGZpbmFsCgkqIEBwcm9wZXJ0eSB7aW50fSBQUklPUklUWV9OT1JNQUwKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMID0gMDsKCQoJLyoqIAoJKiBMb3dlc3QgcHJpb3JpdHkKCSogQHN0YXRpYwoJKiBAcHVibGljCgkqIEBmaW5hbAoJKiBAcHJvcGVydHkge2ludH0gUFJJT1JJVFlfTE9XCgkqLwoJTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX0xPVyA9IC0xOwoJCgkvKioKCSogIFRoZSB1cmwgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwKCSovCglwLnVybCA9IG51bGw7CgkKCS8qKgoJKiAgRGF0YSBhc3NvY2lhdGUgd2l0aCB0aGUgbG9hZAoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHsqfSBkYXRhCgkqLwoJcC5kYXRhID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gb2YgdGhlIGxvYWQsIHRvIGNhbGwgd2hlbiAKCSogIHRoZSBsb2FkIGFzIGZpbmlzaGVkLCB0YWtlcyBvbmUgYXJndW1lbnQgYXMgcmVzdWx0CgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBjYWxsYmFjawoJKi8KCXAuY2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogIFRoZSBwcmlvcml0eSBvZiB0aGlzIGl0ZW0KCSogIEBwcm9wZXJ0eSB7aW50fSBwcmlvcml0eQoJKiAgQHB1YmxpYwoJKi8KCXAucHJpb3JpdHkgPSAwOwoJCgkvKioKCSogIFRoZSBhbW91bnQgd2UndmUgbG9hZGVkIHNvIGZhciwgZnJvbSAwIHRvIDEKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBwcm9ncmVzcwoJKi8KCXAucHJvZ3Jlc3MgPSAwOwoJCgkvKioKCSogIFRoZSBwcm9ncmVzcyBjYWxsYmFjawoJKiAgQHB1YmxpYwoJKiAgQHByb3BydHkge2Z1bmN0aW9ufSB1cGRhdGVDYWxsYmFjawoJKi8KCXAudXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoJCglwLl9ib3VuZEZhaWwgPSBudWxsOwoJcC5fYm91bmRQcm9ncmVzcyA9IG51bGw7CglwLl9ib3VuZENvbXBsZXRlID0gbnVsbDsKCQoJLyoqCgkqICBSZXByZXNlbnQgdGhpcyBvYmplY3QgYXMgYSBzdHJpbmcKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgdG9TdHJpbmcKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIG9iamVjdAoJKi8KCXAudG9TdHJpbmcgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuICJbTG9hZGVyUXVldWVJdGVtKHVybDonIit0aGlzLnVybCsiJywgcHJpb3JpdHk6Iit0aGlzLnByaW9yaXR5KyIpXSI7Cgl9OwoJCgkvKioKCSogIERlc3Ryb3kgdGhpcyByZXN1bHQKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLmNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLnVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLmRhdGEgPSBudWxsOwoJCXRoaXMuX2JvdW5kRmFpbCA9IG51bGw7CgkJdGhpcy5fYm91bmRQcm9ncmVzcyA9IG51bGw7CgkJdGhpcy5fYm91bmRDb21wbGV0ZSA9IG51bGw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5Mb2FkZXJRdWV1ZUl0ZW0gPSBMb2FkZXJRdWV1ZUl0ZW07Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgkKCS8qKgoJKiAgVGhlIE1lZGlhbG9hZGVyIGlzIHRoZSBzaW5nbGV0b24gbG9hZGVyIGZvciBsb2FkaW5nIGFsbCBhc3NldHMKCSogIGluY2x1ZGluZyBpbWFnZXMsIGRhdGEsIGNvZGUgYW5kIHNvdW5kcy4gTWVkaWFMb2FkZXIgc3VwcG9ydHMgY2FjaGUtYnVzdGluZwoJKiAgaW4gdGhlIGJyb3dzZXIgdXNpbmcgZHluYW1pYyBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycy4KCSogCgkqICBAY2xhc3MgTWVkaWFMb2FkZXIKCSovCgl2YXIgTWVkaWFMb2FkZXIgPSBmdW5jdGlvbigpe307CgkKCS8qKiBUaGUgcHJvdG90eXBlICovCgl2YXIgcCA9IE1lZGlhTG9hZGVyLnByb3RvdHlwZTsKCQoJLyoqCgkqIFJlZmVyZW5jZSB0byB0aGUgcHJpdmF0ZSBpbnN0YW5jZSBvYmplY3QKCSogQHN0YXRpYwoJKiBAcHJvdGVjdGVkCgkqLwoJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgY29sbGVjdGlvbiBvZiBMb2FkZXJRdWV1ZUl0ZW1zCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBxdWV1ZSA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGNvbGxlY3Rpb24gb2YgTG9hZGVyUXVldWVJdGVtcyBieSB1cmwKCSogIEBwcml2YXRlCgkqLwoJdmFyIHF1ZXVlSXRlbXMgPSBudWxsOwoJCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIGxvYWRlcnMKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge29iamVjdH0gbG9hZGVycwoJKi8KCXZhciBsb2FkZXJzID0gbnVsbDsKCQoJdmFyIHFpUG9vbCA9IG51bGw7Cgl2YXIgbG9hZGVyUG9vbCA9IG51bGw7Cgl2YXIgcmVzdWx0UG9vbCA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGN1cnJlbnQgbnVtYmVyIG9mIGl0ZW1zIGxvYWRpbmcKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2ludH0gbnVtTG9hZHMKCSogIEBkZWZhdWx0IDAKCSovCgl2YXIgbnVtTG9hZHMgPSAwOwoJCgl2YXIgcmV0cmllcyA9IG51bGw7CgkKCS8qKgoJKiAgSWYgd2UgY2FuIGxvYWQKCSogIEBwcml2YXRlCgkqLwoJcC5fY2FuTG9hZCA9IHRydWU7CgkKCS8qKgoJKiAgVGhlIG1heGltdW0gbnVtYmVyIG9mIHNpbXVsYW5lb3VzIGxvYWRzCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2ludH0gbWF4U2ltdWx0YW5lb3VzTG9hZHMKCSogIEBkZWZhdWx0IDIKCSovCglwLm1heFNpbXVsdGFuZW91c0xvYWRzID0gMjsKCQoJLyoqCgkqICBUaGUgcmVmZXJlbmNlIHRvIHRoZSBjYWNoZSBtYW5hZ2VyCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2Nsb3Vka2lkLkNhY2hlTWFuYWdlcn0gY2FjaGVNYW5hZ2VyCgkqLwoJcC5jYWNoZU1hbmFnZXIgPSBudWxsOwoJCgkvKioKCSogIFN0YXRpYyBjb25zdHJ1Y3RvciBjcmVhdGluZyB0aGUgc2luZ2xldG9uCgkqICBAbWV0aG9kIGluaXQKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSovCglNZWRpYUxvYWRlci5pbml0ID0gZnVuY3Rpb24oKQoJewoJCWlmICghTWVkaWFMb2FkZXIuX2luc3RhbmNlKQoJCXsKCQkJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbmV3IE1lZGlhTG9hZGVyKCk7CgkJCU1lZGlhTG9hZGVyLl9pbnN0YW5jZS5faW5pdGlhbGl6ZSgpOwoJCX0KCQlyZXR1cm4gTWVkaWFMb2FkZXIuX2luc3RhbmNlOwoJfTsKCQkKCS8qKgoJKiAgU3RhdGljIGZ1bmN0aW9uIGZvciBnZXR0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2UKCSogIEBzdGF0aWMKCSogIEByZWFkT25seQoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtjbG91ZGtpZC5PU30gaW5zdGFuY2UKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkoTWVkaWFMb2FkZXIsICJpbnN0YW5jZSIsIHsKCQlnZXQ6ZnVuY3Rpb24oKQoJCXsKCQkJaWYgKCFNZWRpYUxvYWRlci5faW5zdGFuY2UpCgkJCXsKCQkJCXRocm93ICdDYWxsIGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluaXQoKSc7CgkJCX0KCQkJcmV0dXJuIE1lZGlhTG9hZGVyLl9pbnN0YW5jZTsKCQl9Cgl9KTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBNZWRpYUxvYWRlciBzaW5nbGV0b24sIGRvbid0IHVzZSBhZnRlciB0aGlzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdmFyIGksIGxlbiwga2V5LCBhcnIgPSB0aGlzLnF1ZXVlOwoJCWlmKGFycikKCQl7CgkJCWZvcihpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA8IGk7ICsraSkKCQkJCWFycltpXS5kZXN0cm95KCk7CgkJCWFyciA9IHFpUG9vbDsKCQkJZm9yKGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpIDwgaTsgKytpKQoJCQkJYXJyW2ldLmRlc3Ryb3koKTsKCQkJYXJyID0gcmVzdWx0UG9vbDsKCQkJZm9yKGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpIDwgaTsgKytpKQoJCQkJYXJyW2ldLmRlc3Ryb3koKTsKCQkJZm9yKGtleSBpbiBsb2FkZXJzKQoJCQl7CgkJCQlxdWV1ZUl0ZW1zW2tleV0uZGVzdHJveSgpOwoJCQkJbG9hZGVyc1trZXldLmNsb3NlKCk7CgkJCX0KCQl9CgkJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbDsKCQlpZiAodGhpcy5jYWNoZU1hbmFnZXIpCgkJCXRoaXMuY2FjaGVNYW5hZ2VyLmRlc3Ryb3koKTsKCQl0aGlzLmNhY2hlTWFuYWdlciA9IG51bGw7CgkJcXVldWUgPSBudWxsOwoJCXJlc3VsdFBvb2wgPSBudWxsOwoJCWxvYWRlclBvb2wgPSBudWxsOwoJCXFpUG9vbCA9IG51bGw7CgkJcXVldWVJdGVtcyA9IG51bGw7CgkJcmV0cmllcyA9IG51bGw7CgkJbG9hZGVycyA9IG51bGw7Cgl9OwoJCgkvKioKCSogIEluaXRpbGl6ZSB0aGUgb2JqZWN0CgkqICBAcHJvdGVjdGVkCgkqICBAbWV0aG9kIF9pbml0aWFsaXplCgkqLwoJcC5faW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkKCXsKCQlxaVBvb2wgPSBbXTsKCQlsb2FkZXJQb29sID0gW107CgkJcmVzdWx0UG9vbCA9IFtdOwoJCXF1ZXVlID0gW107CgkJcXVldWVJdGVtcyA9IHt9OwoJCWxvYWRlcnMgPSB7fTsKCQlyZXRyaWVzID0ge307CgkJdGhpcy5jYWNoZU1hbmFnZXIgPSBuZXcgY2xvdWRraWQuQ2FjaGVNYW5hZ2VyKCk7Cgl9OwoJCgkvKioKCSogIExvYWQgYSBmaWxlIAoJKiAgQG1ldGhvZCBsb2FkCgkqICBAcHVibGljCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSBmaWxlIHBhdGggdG8gbG9hZAoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gY29tcGxldGVkCgkqICBAcGFyYW0ge2Z1bmN0aW9uKn0gdXBkYXRlQ2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZvciBsb2FkIHByb2dyZXNzIHVwZGF0ZSwgcGFzc2VzIDAtMSBhcyBwYXJhbQoJKiAgQHBhcmFtIHtpbnQqfSBwcmlvcml0eSBUaGUgcHJpb3JpdHkgb2YgdGhlIGxvYWQKCSogIEBwYXJhbSB7Kn0gZGF0YSBvcHRpb25hbCBkYXRhCgkqLwoJcC5sb2FkID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgdXBkYXRlQ2FsbGJhY2ssIHByaW9yaXR5LCBkYXRhKQoJewoJCXZhciBxaSA9IHRoaXMuX2dldFFJKCk7CgkJCgkJdmFyIGJhc2VQYXRoID0gY2xvdWRraWQuT1MuaW5zdGFuY2Uub3B0aW9ucy5iYXNlUGF0aDsKCQlpZiAoYmFzZVBhdGggIT09IHVuZGVmaW5lZCAmJiAvXmh0dHAocyk/XDovLnRlc3QodXJsKSA9PT0gZmFsc2UgJiYgdXJsLnNlYXJjaChiYXNlUGF0aCkgPT0gLTEpCgkJewoJCQlxaS5iYXNlUGF0aCA9IGJhc2VQYXRoOwoJCX0KCQkKCQlxaS51cmwgPSB1cmw7CgkJcWkuY2FsbGJhY2sgPSBjYWxsYmFjazsKCQlxaS51cGRhdGVDYWxsYmFjayA9IHVwZGF0ZUNhbGxiYWNrIHx8IG51bGw7CgkJcWkucHJpb3JpdHkgPSBwcmlvcml0eSB8fCBjbG91ZGtpZC5Mb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMOwoJCXFpLmRhdGEgPSBkYXRhIHx8IG51bGw7CgkJCgkJcXVldWUucHVzaChxaSk7CgkJCgkJLy8gU29yeSBieSBwcmlvcml0eQoJCXF1ZXVlLnNvcnQoZnVuY3Rpb24oYSwgYil7CgkJCXJldHVybiBhLnByaW9yaXR5IC0gYi5wcmlvcml0eTsKCQl9KTsKCQkKCQkvLyBUcnkgdG8gbG9hZCB0aGUgbmV4dCBxdWV1ZSBpdGVtCgkJdGhpcy5fdHJ5TmV4dExvYWQoKTsKCX07CgkKCS8qKgoJKiAgVGhlcmUgd2FzIGFuIGVycm9yIGxvYWRpbmcgdGhlIGZpbGUKCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkxvYWRGYWlsZWQKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSovCglwLl9vbkxvYWRGYWlsZWQgPSBmdW5jdGlvbihxaSwgZXZlbnQpCgl7CgkJRGVidWcuZXJyb3IoIlVuYWJsZSB0byBsb2FkIGZpbGU6ICIgKyBxaS51cmwgICsgIiAtIHJlYXNvbjogIiArIGV2ZW50LmVycm9yKTsKCQkKCQl2YXIgbG9hZGVyID0gbG9hZGVyc1txaS51cmxdOwoJCWxvYWRlci5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpOwoJCWxvYWRlci5jbG9zZSgpOwoJCXRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKTsKCQkKCQlkZWxldGUgcXVldWVJdGVtc1txaS51cmxdOwoJCWRlbGV0ZSBsb2FkZXJzW3FpLnVybF07CgkJCgkJaWYocmV0cmllc1txaS51cmxdKQoJCQlyZXRyaWVzW3FpLnVybF0rKzsKCQllbHNlCgkJCXJldHJpZXNbcWkudXJsXSA9IDE7CgkJaWYocmV0cmllc1txaS51cmxdID4gMykKCQkJdGhpcy5fbG9hZERvbmUocWksIG51bGwpOwoJCWVsc2UKCQl7CgkJCW51bUxvYWRzLS07CgkJCXF1ZXVlLnB1c2gocWkpOwoJCQl0aGlzLl90cnlOZXh0TG9hZCgpOwoJCX0KCX07CgkKCS8qKgoJKiAgVGhlIGZpbGUgbG9hZCBwcm9ncmVzcyBldmVudAoJKiAgQG1ldGhvZCBfb25Mb2FkUHJvZ3Jlc3MKCSogIEBwcml2YXRlCgkqICBAcGFyYW0ge2Nsb3Vka2lkLkxvYWRlclF1ZXVlSXRlbX0gcWkgVGhlIGxvYWRlciBxdWV1ZSBpdGVtCgkqICBAcGFyYW0ge29iamVjdH0gZXZlbnQgVGhlIHByb2dyZXNzIGV2ZW50CgkqLwoJcC5fb25Mb2FkUHJvZ3Jlc3MgPSBmdW5jdGlvbihxaSwgZXZlbnQpCgl7CgkJcWkucHJvZ3Jlc3MgPSBldmVudC5wcm9ncmVzczsKCQlpZiAocWkudXBkYXRlQ2FsbGJhY2spewoJCQlxaS51cGRhdGVDYWxsYmFjayhxaS5wcm9ncmVzcyk7CgkJfQkKCX07CgkKCS8qKgoJKiAgVGhlIGZpbGUgd2FzIGxvYWRlZCBzdWNjZXNzZnVsbHkKCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkxvYWRDb21wbGV0ZWQKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSogIEBwYXJhbSB7b2JqZWN0fSBldiBUaGUgbG9hZCBldmVudAoJKi8KCXAuX29uTG9hZENvbXBsZXRlZCA9IGZ1bmN0aW9uKHFpLCBldikKCXsKCQlpZih0cnVlKQoJCXsKCQkJRGVidWcubG9nKCJGaWxlIGxvYWRlZCBzdWNjZXNzZnVsbHkgZnJvbSAiICsgcWkudXJsKTsKCQl9CgkJdmFyIGxvYWRlciA9IGxvYWRlcnNbcWkudXJsXTsKCQlsb2FkZXIucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMoKTsKCQlsb2FkZXIuY2xvc2UoKTsKCQl0aGlzLl9wb29sTG9hZGVyKGxvYWRlcik7CgkJCgkJZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXTsKCQlkZWxldGUgbG9hZGVyc1txaS51cmxdOwoJCXRoaXMuX2xvYWREb25lKHFpLCB0aGlzLl9nZXRSZXN1bHQoZXYucmVzdWx0LCBxaS51cmwsIGxvYWRlcikpOwoJfTsKCQoJLyoqCgkqICBBdHRlbXB0IHRvIGRvIHRoZSBuZXh0IGxvYWQKCSogIEBtZXRob2QgX3RyeU5leHRMb2FkCgkqICBAcHJpdmF0ZQoJKi8KCXAuX3RyeU5leHRMb2FkID0gZnVuY3Rpb24oKQoJewoJCWlmIChudW1Mb2FkcyA+IHRoaXMubWF4U2ltdWx0YW5lb3VzTG9hZHMgLSAxIHx8IHF1ZXVlLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoJCQoJCW51bUxvYWRzKys7CgkJCgkJdmFyIHFpID0gcXVldWUuc2hpZnQoKTsKCQkKCQlpZih0cnVlKQoJCXsKCQkJRGVidWcubG9nKCJBdHRlbXB0aW5nIHRvIGxvYWQgZmlsZSAnIiArIHFpLnVybCArICInIik7CgkJfQoJCQoJCXF1ZXVlSXRlbXNbcWkudXJsXSA9IHFpOwoJCQoJCXZhciBsb2FkZXIgPSB0aGlzLl9nZXRMb2FkZXIocWkuYmFzZVBhdGgpOwoJCQoJCS8vIEFkZCB0byB0aGUgbGlzdCBvZiBsb2FkZXJzCgkJbG9hZGVyc1txaS51cmxdID0gbG9hZGVyOwoJCQoJCWxvYWRlci5hZGRFdmVudExpc3RlbmVyKCJmaWxlbG9hZCIsIHFpLl9ib3VuZENvbXBsZXRlKTsKCQlsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBxaS5fYm91bmRGYWlsKTsKCQlsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZmlsZXByb2dyZXNzIiwgcWkuX2JvdW5kUHJvZ3Jlc3MpOwoJCXZhciB1cmwgPSB0aGlzLmNhY2hlTWFuYWdlci5wcmVwYXJlKHFpLnVybCk7CgkJbG9hZGVyLmxvYWRGaWxlKHFpLmRhdGEgPyB7aWQ6cWkuZGF0YS5pZCwgc3JjOnVybCwgZGF0YTpxaS5kYXRhfSA6IHVybCk7Cgl9OwoJCgkvKioKCSogIEFsZXJ0IHRoYXQgdGhlIGxvYWRpbmcgaXMgZmluaXNoZWQKCSogIEBwcml2YXRlIAoJKiAgQG1ldGhvZCBfbG9hZERvbmUKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSogIEBwYXJhbSB7b2JqZWN0fSByZXN1bHQgVGhlIGV2ZW50IGZyb20gcHJlbG9hZGpzIG9yIG51bGwKCSovCglwLl9sb2FkRG9uZSA9IGZ1bmN0aW9uKHFpLCByZXN1bHQpCgl7CgkJbnVtTG9hZHMtLTsKCQlpZihxaS5kYXRhICYmIHJlc3VsdCkvL2Egd2F5IHRvIGtlZXAgdHJhY2sgb2YgbG9hZCByZXN1bHRzIHdpdGhvdXQgZXhjZXNzaXZlIGZ1bmN0aW9uIGJpbmRpbmcKCQkJcmVzdWx0LmlkID0gcWkuZGF0YS5pZDsKCQlxaS5jYWxsYmFjayhyZXN1bHQpOwoJCS8vcWkuZGVzdHJveSgpOwoJCXRoaXMuX3Bvb2xRSShxaSk7CgkJdGhpcy5fdHJ5TmV4dExvYWQoKTsKCX07CgkKCS8qKgoJKiAgQ2FuY2VsIGEgbG9hZCB0aGF0J3MgY3VycmVudGx5IGluIHByb2dyZXNzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGNhbmNlbAoJKiAgQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgdXJsCgkqICBAcmV0dXJuIHtib29sfSBJZiBjYW5jZWxlZCByZXR1cm5zIHRydWUsIGZhbHNlIGlmIG5vdCBjYW5jZWxlZAoJKi8KCXAuY2FuY2VsID0gZnVuY3Rpb24odXJsKQoJewoJCXZhciBxaSA9IHF1ZXVlSXRlbXNbdXJsXTsKCQl2YXIgbG9hZGVyID0gbG9hZGVyc1t1cmxdOwoJCQoJCWlmIChxaSAmJiBsb2FkZXIpCgkJewoJCQlsb2FkZXIuY2xvc2UoKTsKCQkJZGVsZXRlIGxvYWRlcnNbdXJsXTsKCQkJZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXTsKCQkJbnVtTG9hZHMtLTsKCQkJdGhpcy5fcG9vbExvYWRlcihsb2FkZXIpOwoJCQl0aGlzLl9wb29sUUkocWkpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJCgkJZm9yKGkgPSAwLCBsZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBsZW47IGkrKykKCQl7CgkJCXFpID0gcXVldWVbaV07CgkJCWlmIChxaS51cmwgPT0gdXJsKXsKCQkJCXF1ZXVlLnNwbGljZShpLCAxKTsKCQkJCXRoaXMuX3Bvb2xRSShxaSk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7CQkKCX07CgkKCXAuX2dldFFJID0gZnVuY3Rpb24oKQoJewoJCXZhciBydG47CgkJaWYocWlQb29sLmxlbmd0aCkKCQkJcnRuID0gcWlQb29sLnBvcCgpOwoJCWVsc2UKCQl7CgkJCXJ0biA9IG5ldyBjbG91ZGtpZC5Mb2FkZXJRdWV1ZUl0ZW0oKTsKCQkJcnRuLl9ib3VuZEZhaWwgPSB0aGlzLl9vbkxvYWRGYWlsZWQuYmluZCh0aGlzLCBydG4pOwoJCQlydG4uX2JvdW5kUHJvZ3Jlc3MgPSB0aGlzLl9vbkxvYWRQcm9ncmVzcy5iaW5kKHRoaXMsIHJ0bik7CgkJCXJ0bi5fYm91bmRDb21wbGV0ZSA9IHRoaXMuX29uTG9hZENvbXBsZXRlZC5iaW5kKHRoaXMsIHJ0bik7CgkJfQoJCXJldHVybiBydG47Cgl9OwoJCglwLl9wb29sUUkgPSBmdW5jdGlvbihxaSkKCXsKCQlxaVBvb2wucHVzaChxaSk7CgkJcWkuY2FsbGJhY2sgPSBxaS51cGRhdGVDYWxsYmFjayA9IHFpLmRhdGEgPSBxaS51cmwgPSBudWxsOwoJCXFpLnByb2dyZXNzID0gMDsKCX07CgkKCXAuX2dldExvYWRlciA9IGZ1bmN0aW9uKGJhc2VQYXRoKQoJewoJCXZhciBydG47CgkJaWYobG9hZGVyUG9vbC5sZW5ndGgpCgkJewoJCQlydG4gPSBsb2FkZXJQb29sLnBvcCgpOwoJCQlydG4uX2Jhc2VQYXRoID0gYmFzZVBhdGg7Ly9hcHBhcmVudGx5IHRoZXkgbmVnbGVjdGVkIHRvIG1ha2UgdGhpcyBwdWJsaWMKCQl9CgkJZWxzZQoJCQlydG4gPSBuZXcgY3JlYXRlanMuTG9hZFF1ZXVlKHRydWUsIGJhc2VQYXRoKTsKCQkvL2FsbG93IHRoZSBsb2FkZXIgdG8gaGFuZGxlIHNvdW5kIGFzIHdlbGwKCQlpZihjcmVhdGVqcy5Tb3VuZCkKCQkJcnRuLmluc3RhbGxQbHVnaW4oY3JlYXRlanMuU291bmQpOwoJCXJldHVybiBydG47Cgl9OwoJCglwLl9wb29sTG9hZGVyID0gZnVuY3Rpb24obG9hZGVyKQoJewoJCWxvYWRlci5yZW1vdmVBbGwoKTsvL2NsZWFyIHRoZSBsb2FkZXIgZm9yIHJldXNlCgkJbG9hZGVyUG9vbC5wdXNoKGxvYWRlcik7Cgl9OwoJCglwLl9nZXRSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQsIHVybCwgbG9hZGVyKQoJewoJCXZhciBydG47CgkJaWYocmVzdWx0UG9vbC5sZW5ndGgpCgkJewoJCQlydG4gPSByZXN1bHRQb29sLnBvcCgpOwoJCQlydG4uY29udGVudCA9IHJlc3VsdDsKCQkJcnRuLnVybCA9IHVybDsKCQkJcnRuLmxvYWRlciA9IGxvYWRlcjsKCQl9CgkJZWxzZQoJCQlydG4gPSBuZXcgY2xvdWRraWQuTWVkaWFMb2FkZXJSZXN1bHQocmVzdWx0LCB1cmwsIGxvYWRlcik7CgkJcmV0dXJuIHJ0bjsKCX07CgkKCXAuX3Bvb2xSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQpCgl7CgkJcmVzdWx0LmNvbnRlbnQgPSByZXN1bHQudXJsID0gcmVzdWx0LmxvYWRlciA9IHJlc3VsdC5pZCA9IG51bGw7CgkJcmVzdWx0UG9vbC5wdXNoKHJlc3VsdCk7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuTWVkaWFMb2FkZXIgPSBNZWRpYUxvYWRlcjsKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCl7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIFRoZSByZXR1cm4gcmVzdWx0IG9mIHRoZSBNZWRpYUxvYWRlciBsb2FkCgkqICBAY2xhc3MgTWVkaWFMb2FkZXJSZXN1bHQKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHsqfSBjb250ZW50IFRoZSBkeW5hbWljIGNvbnRlbnQgbG9hZGVkCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdGhhdCB3YXMgbG9hZGVkCgkqICBAcGFyYW0ge2NyZWF0ZWpzLkxvYWRRdWV1ZX0gbG9hZGVyIFRoZSBMb2FkUXVldWUgdGhhdCBwZXJmb3JtZWQgdGhlIGxvYWQKCSovCgl2YXIgTWVkaWFMb2FkZXJSZXN1bHQgPSBmdW5jdGlvbihjb250ZW50LCB1cmwsIGxvYWRlcikKCXsKCQl0aGlzLmNvbnRlbnQgPSBjb250ZW50OwoJCXRoaXMudXJsID0gdXJsOwoJCXRoaXMubG9hZGVyID0gbG9hZGVyOwoJfTsKCQoJLyoqIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlICovCgl2YXIgcCA9IE1lZGlhTG9hZGVyUmVzdWx0LnByb3RvdHlwZTsKCQoJLyoqCgkqICBUaGUgY29udGVudHMgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7Kn0gY29udGVudCAKCSovCglwLmNvbnRlbnQgPSBudWxsOwoJCgkvKioKCSogIFRoZSB1cmwgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwKCSovCglwLnVybCA9IG51bGw7CgkKCS8qKgoJKiAgUmVmZXJlbmNlIHRvIHRoZSBwcmVsb2FkZXIgb2JqZWN0CgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2NyZWF0ZWpzLkxvYWRlclF1ZXVlfSBsb2FkZXIKCSovCglwLmxvYWRlciA9IG51bGw7CgkKCS8qKgoJKiBBIHRvIHN0cmluZyBtZXRob2QKCSogQHB1YmxpYwoJKiBAbWV0aG9kIHRvU3RyaW5nCgkqIEByZXR1cm4ge3N0cmluZ30gQSBzdHJpbmcgcmVwIG9mIHRoZSBvYmplY3QKCSovCglwLnRvU3RyaW5nID0gZnVuY3Rpb24oKQoJewoJCXJldHVybiAiW01lZGlhTG9hZGVyUmVzdWx0KCciK3RoaXMudXJsKyInKV0iOwoJfTsKCQoJLyoqCgkqIERlc3Ryb3kgdGhpcyByZXN1bHQKCSogQHB1YmxpYwoJKiBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5jYWxsYmFjayA9IG51bGw7CgkJdGhpcy51cmwgPSBudWxsOwoJCXRoaXMuY29udGVudCA9IG51bGw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5NZWRpYUxvYWRlclJlc3VsdCA9IE1lZGlhTG9hZGVyUmVzdWx0Owp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24odW5kZWZpbmVkKXsKCQoJInVzZSBzdHJpY3QiOwoJCgkvKioKCSogIFVzZWQgZm9yIG1hbmFnaW5nIHRoZSBicm93c2VyIGNhY2hlIG9mIGxvYWRpbmcgZXh0ZXJuYWwgZWxlbWVudHMKCSogIGNhbiBlYXNpbHkgbG9hZCB2ZXJzaW9uIG1hbmlmZXN0IGFuZCBhcHBseSBpdCB0byB0aGUgbWVkaWEgbG9hZGVyCgkqICBzdXBwb3J0cyBjYWNoZSBidXN0aW5nIGFsbCBtZWRpYSBsb2FkIHJlcXVlc3RzCgkqICB1c2VzIHRoZSBxdWVyeSBzdHJpbmcgdG8gYnVzdCBicm93c2VyIHZlcnNpb25zLgoJKiAKCSogIEBjbGFzcyBDYWNoZU1hbmFnZXIKCSovCgl2YXIgQ2FjaGVNYW5hZ2VyID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuaW5pdGlhbGl6ZSgpOwoJfTsKCQoJLyoqIEVhc3kgYWNjZXNzIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gQ2FjaGVNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwoJCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIHZlcnNpb24gbnVtYmVycwoJKiAgQHByb3RlY3RlZAoJKiAgQHByb3BlcnR5IHtEaWN0aW9uYXJ5fSBfdmVyc2lvbnMKCSovCglwLl92ZXJzaW9ucyA9IG51bGw7CgkKCS8qKgoJKiAgSWYgd2UgYXJlIHN1cHBvc2UgdG8gY2FjaGUgYnVzdCBldmVyeSBmaWxlCgkqICBAcHJvcGVydHkge2Jvb2x9IGNhY2hlQnVzdAoJKiAgQHB1YmxpYwoJKiAgQGRlZmF1bHQgZmFsc2UKCSovCglwLmNhY2hlQnVzdCA9IGZhbHNlOwoJCgkvKioKCSogVGhlIGNvbnN0cnVjdG9yIGZvciB0aGUgQ2FjaGUgbWFuYWdlcgoJKiBAcHVibGljCgkqIEBjb25zdHJ1Y3RvcgoJKiBAbWV0aG9kIGluaXRpYWxpemUKCSovCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5fdmVyc2lvbnMgPSBbXTsKCQkJCQoJCXZhciBjYiA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLm9wdGlvbnMuY2FjaGVCdXN0OwoJCXRoaXMuY2FjaGVCdXN0ID0gY2IgPyAoY2IgPT09ICJ0cnVlIiB8fCBjYiA9PT0gdHJ1ZSkgOiBmYWxzZTsKCQkKCQlpZih0cnVlKQoJCXsKCQkJaWYgKHRoaXMuY2FjaGVCdXN0KSBEZWJ1Zy5sb2coIkNhY2hlQnVzdCBhbGwgZmlsZXMgaXMgb24uIik7CgkJfQoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBjYWNoZSBtYW5hZ2VyLCBkb24ndCB1c2UgYWZ0ZXIgdGhpcwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuX3ZlcnNpb25zID0gbnVsbDsKCX07CgkKCS8qKgoJKiAgQWRkIHRoZSB2ZXJzaW9ucwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBhZGRWZXJzaW9uc0ZpbGUKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCBvZiB0aGUgdmVyc2lvbnMgZmlsZQoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGJhY2sgd2hlbiB0aGUgdXJsIGhhcyBiZWVuIGxhb2RlZAoJKiAgQHBhcmFtIHtzdHJpbmd9IGJhc2VVcmwgQSBiYXNlIHVybCB0byBwcmVwZW5kIGFsbCBsaW5lcyBvZiB0aGUgZmlsZQoJKi8KCXAuYWRkVmVyc2lvbnNGaWxlID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgYmFzZVVybCkKCXsJCQoJCURlYnVnLmFzc2VydCgvXi4qXC50eHQkLy50ZXN0KHVybCksICJUaGUgdmVyc2lvbnMgZmlsZSBtdXN0IGJlIGEgKi50eHQgZmlsZSIpOwoJCQkJCgkJdmFyIG1sID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5zdGFuY2U7CgkJCgkJLy8gSWYgd2UgYWxyZWFkeSBjYWNoZSBidXN0aW5nLCB3ZSBjYW4gaWdub3JlIHRoaXMKCQlpZiAodGhpcy5jYWNoZUJ1c3QpCgkJewoJCQlpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7CgkJCXJldHVybjsKCQl9CgkJCgkJLy8gQWRkIGEgcmFuZG9tIHZlcnNpb24gbnVtYmVyIHRvIG5ldmVyIGNhY2hlIHRoZSB0ZXh0IGZpbGUKCQl0aGlzLmFkZFZlcnNpb24odXJsLCBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkqMTAwMDAwKSk7CgkJCgkJdmFyIGNtID0gdGhpczsKCQkKCQkvLyBMb2FkIHRoZSB2ZXJzaW9uCgkJbWwubG9hZCh1cmwsIAoJCQlmdW5jdGlvbihyZXN1bHQpCgkJCXsJCQkJCgkJCQkvLyBjaGVjayBmb3IgYSB2YWxpZCByZXN1bHQgY29udGVudAoJCQkJaWYgKHJlc3VsdCAmJiByZXN1bHQuY29udGVudCkKCQkJCXsKCQkJCQkvLyBSZW1vdmUgY2FycmFnZSByZXR1cm5zIGFuZCBzcGxpdCBvbiBuZXdsaW5lcwoJCQkJCXZhciBsaW5lcyA9IHJlc3VsdC5jb250ZW50LnJlcGxhY2UoL1xyL2csICcnKS5zcGxpdCgiXG4iKTsKCQkJCQl2YXIgaSwgcGFydHM7CgoJCQkJCS8vIEdvIGxpbmUgYnkgbGluZQoJCQkJCWZvcihpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKQoJCQkJCXsJCgkJCQkJCS8vIENoZWNrIGZvciBhIHZhbGlkIGxpbmUKCQkJCQkJaWYgKCFsaW5lc1tpXSkgY29udGludWU7CgoJCQkJCQkvLyBTcGxpdCBsaW5lcwoJCQkJCQlwYXJ0cyA9IGxpbmVzW2ldLnNwbGl0KCcgJyk7CgoJCQkJCQkvLyBBZGQgdGhlIHBhcnRzCgkJCQkJCWlmIChwYXJ0cy5sZW5ndGggIT0gMikgY29udGludWU7CgoJCQkJCQkvLyBBZGQgdGhlIHZlcnNpb25pbmcKCQkJCQkJY20uYWRkVmVyc2lvbigoYmFzZVVybCB8fCAiIikgKyBwYXJ0c1swXSwgcGFydHNbMV0pOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChjYWxsYmFjaykgY2FsbGJhY2soKTsKCQkJfQoJCSk7Cgl9OwoJCgkvKioKCSogIEFkZCBhIHZlcnNpb24gbnVtYmVyIGZvciBhIGZpbGUKCSogIEBtZXRob2QgYWRkVmVyc2lvbgoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgdXJsIG9mIHRoZSBvYmplY3QKCSogIEBwYXJhbSB7c3RyaW5nfSB2ZXJzaW9uIFZlcnNpb24gbnVtYmVyIG9yIGhhcyBvZiBmaWxlCgkqLwoJcC5hZGRWZXJzaW9uID0gZnVuY3Rpb24odXJsLCB2ZXJzaW9uKQoJewoJCXZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKCQlpZiAoIXZlcikKCQkJdGhpcy5fdmVyc2lvbnMucHVzaCh7J3VybCc6IHVybCwgJ3ZlcnNpb24nOiB2ZXJzaW9ufSk7Cgl9OwoJCgkvKioKCSogIFNlYXJjaCBmb3IgYSB2ZXJzaW9uIG51bWJlciBieSB1cmwKCSogIEBtZXRob2QgX2dldFZlcnNpb25CeVVybAoJKiAgQHByaXZhdGUKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCB0byBzZWFyY2gKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIHZlcnNpb24gbnVtYmVyIGFzIGEgc3RyaW5nIG9yIG51bGwKCSovCglwLl9nZXRWZXJzaW9uQnlVcmwgPSBmdW5jdGlvbih1cmwpCgl7CgkJdmFyIGksIGxlbiA9IHRoaXMuX3ZlcnNpb25zLmxlbmd0aDsKCQlmb3IoaSA9IDA7IGkgPCBsZW47IGkrKykKCQl7CgkJCWlmICh1cmwgPT0gdGhpcy5fdmVyc2lvbnNbaV0udXJsKQoJCQl7CgkJCQlyZXR1cm4gdGhpcy5fdmVyc2lvbnNbaV07CgkJCX0KCQl9CgkJcmV0dXJuIG51bGw7Cgl9OwoJCgkvKioKCSogIFByZXBhcmUgYSBVUkwgd2l0aCB0aGUgbmVjZXNzYXJ5IGNhY2hlIGJ1c3RpbmcgYW5kL29yIHZlcnNpb25pbmcKCSogIGFzIHdlbGwgYXMgdGhlIGJhc2UgZGlyZWN0b3J5cgoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBwcmVwYXJlCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdG8gcHJlcGFyZQoJKiAgQHBhcmFtIHtib29sfSBhcHBseUJhc2VQYXRoIElmIHRoZSBnbG9iYWwgYmFzZSBwYXRoIHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSB1cmwuIFRoaXMgZGVmYXVsdHMgdG8gZmFsc2UgYmVjYXVzZSBpdCBjYW4gCgkqCQkJCQkJCQlwb3RlbnRpYWxseSBpbnRlcmZlcmUgd2l0aCBsYXRlciByZWd1bGFyIGV4cHJlc3Npb24gY2hlY2tzLCBwYXJ0aWN1bGFybHkgd2l0aCBQcmVsb2FkSlMKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIGZpbmFsIHVybCB3aXRoIHZlcnNpb24vY2FjaGUgYW5kIGJhc2VQYXRoIGFkZGVkCgkqLwoJcC5wcmVwYXJlID0gZnVuY3Rpb24odXJsLCBhcHBseUJhc2VQYXRoKQoJewoJCXZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKCQkKCQlpZiAodGhpcy5jYWNoZUJ1c3QgJiYgLyhcP3xcJiljYlw9WzAtOV0qLy50ZXN0KHVybCkgPT09IGZhbHNlKQoJCXsKCQkJaWYoIXRoaXMuX2NiVmFsKQoJCQkJdGhpcy5fY2JWYWwgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpOwoJCQl1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgImNiPSIgKyB0aGlzLl9jYlZhbDsKCQl9IAoJCWVsc2UgaWYgKHZlciAmJiAvKFw/fFwmKXZcPVswLTldKi8udGVzdCh1cmwpID09PSBmYWxzZSkKCQl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyAidj0iICsgdmVyLnZlcnNpb247CgkJfQoJCWlmKGFwcGx5QmFzZVBhdGgpCgkJewoJCQl2YXIgYmFzZVBhdGggPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5vcHRpb25zLmJhc2VQYXRoOwoJCQlpZiAoL15odHRwKHMpP1w6Ly50ZXN0KHVybCkgPT09IGZhbHNlICYmIGJhc2VQYXRoICE9PSB1bmRlZmluZWQgJiYgdXJsLnNlYXJjaChiYXNlUGF0aCkgPT0gLTEpCgkJCXsKCQkJCXVybCA9IGJhc2VQYXRoICsgdXJsOwoJCQl9CgkJfQoJCXJldHVybiB1cmw7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuQ2FjaGVNYW5hZ2VyID0gQ2FjaGVNYW5hZ2VyOwoJCn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkidXNlIHN0cmljdCI7CgkKCS8qKgoJKiAgQSBNdWx0aXB1cnBvc2UgYnV0dG9uIGNsYXNzLiBJdCBpcyBkZXNpZ25lZCB0byBoYXZlIG9uZSBpbWFnZSwgYW5kIGFuIG9wdGlvbmFsIHRleHQgbGFiZWwuCgkqICBUaGUgYnV0dG9uIGNhbiBiZSBhIG5vcm1hbCBidXR0b24gb3IgYSBzZWxlY3RhYmxlIGJ1dHRvbi4KCSogIFRoZSBidXR0b24gZnVuY3Rpb25zIHNpbWlsYXJseSB3aXRoIGJvdGggQ3JlYXRlSlMgYW5kIFBJWEksIGJ1dCBzbGlnaHRseSBkaWZmZXJlbnRseSBpbgoJKiAgaW5pdGlhbGl6YXRpb24gYW5kIGNhbGxiYWNrcy4KCSogIFVzZSByZWxlYXNlQ2FsbGJhY2sgYW5kIG92ZXJDYWxsYmFjayB0byBrbm93IGFib3V0IGJ1dHRvbiBjbGlja3MgYW5kIG1vdXNlIG92ZXJzLCByZXNwZWN0aXZlbHkuCgkqICAKCSogIEBjbGFzcyBCdXR0b24gKFBJWEkpCgkqICBAZXh0ZW5kcyBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzXSBJbmZvcm1hdGlvbiBhYm91dCB0aGUgYXJ0IHRvIGJlIHVzZWQgZm9yIGJ1dHRvbiBzdGF0ZXMsIGFzIHdlbGwgYXMgaWYgdGhlIGJ1dHRvbiBpcyBzZWxlY3RhYmxlIG9yIG5vdC4KCSogIEBwYXJhbSB7QXJyYXl9IFtpbWFnZVNldHRpbmdzLnByaW9yaXR5PW51bGxdIFRoZSBzdGF0ZSBwcmlvcml0eSBvcmRlci4gSWYgb21pdHRlZCwgZGVmYXVsdHMgdG8gWyJkaXNhYmxlZCIsICJkb3duIiwgIm92ZXIiLCAidXAiXS4KCSogICAgICAgICBQcmV2aW91cyB2ZXJzaW9ucyBvZiBCdXR0b24gdXNlZCBhIGhhcmQgY29kZWQgb3JkZXI6IFsiaGlnaGxpZ2h0ZWQiLCAiZGlzYWJsZWQiLCAiZG93biIsICJvdmVyIiwgInNlbGVjdGVkIiwgInVwIl0uCgkqICBAcGFyYW0ge09iamVjdHxQSVhJLlRleHR1cmV9IFtpbWFnZVNldHRpbmdzLnVwXSBUaGUgdGV4dHVyZSBmb3IgdGhlIHVwIHN0YXRlIG9mIHRoZSBidXR0b24uIFRoaXMgY2FuIGJlIGVpdGhlciB0aGUgdGV4dHVyZSBpdHNlbGYsCgkqICAgICAgICAgb3IgYW4gb2JqZWN0IHdpdGggJ3RleCcgYW5kICdsYWJlbCcgcHJvcGVydGllcy4KCSogIEBwYXJhbSB7UElYSS5UZXh0dXJlfSBbaW1hZ2VTZXR0aW5ncy51cC50ZXhdIFRoZSBzb3VyY2VSZWN0IGZvciB0aGUgc3RhdGUgd2l0aGluIHRoZSBpbWFnZS4KCSogIEBwYXJhbSB7T2JqZWN0fSBbaW1hZ2VTZXR0aW5ncy51cC5sYWJlbD1udWxsXSBMYWJlbCBpbmZvcm1hdGlvbiBzcGVjaWZpYyB0byB0aGlzIHN0YXRlLiBQcm9wZXJ0aWVzIG9uIHRoaXMgcGFyYW1ldGVyIG92ZXJyaWRlIGRhdGEgCgkqICAgICAgICAgaW4gdGhlIGxhYmVsIHBhcmFtZXRlciBmb3IgdGhpcyBidXR0b24gc3RhdGUgb25seS4gQWxsIHZhbHVlcyBleGNlcHQgInRleHQiIGFuZCAidHlwZSIgZnJvbSB0aGUgbGFiZWwgcGFyYW1ldGVyIG1heSBiZSBvdmVycmlkZGVuLgoJKiAgQHBhcmFtIHtPYmplY3R8UElYSS5UZXh0dXJlfSBbaW1hZ2VTZXR0aW5ncy5vdmVyPW51bGxdIFRoZSB0ZXh0dXJlIGZvciB0aGUgb3ZlciBzdGF0ZSBvZiB0aGUgYnV0dG9uLiBJZiBvbWl0dGVkLCB1c2VzIHRoZSB1cCBzdGF0ZS4KCSogIEBwYXJhbSB7UElYSS5UZXh0dXJlfSBbaW1hZ2VTZXR0aW5ncy5vdmVyLnRleF0gVGhlIHNvdXJjZVJlY3QgZm9yIHRoZSBzdGF0ZSB3aXRoaW4gdGhlIGltYWdlLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzLm92ZXIubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciBvdmVycmlkZSBkYXRhIAoJKiAgICAgICAgIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBhbmQgInR5cGUiIGZyb20gdGhlIGxhYmVsIHBhcmFtZXRlciBtYXkgYmUgb3ZlcnJpZGRlbi4KCSogIEBwYXJhbSB7T2JqZWN0fFBJWEkuVGV4dHVyZX0gW2ltYWdlU2V0dGluZ3MuZG93bj1udWxsXSBUaGUgdGV4dHVyZSBmb3IgdGhlIGRvd24gc3RhdGUgb2YgdGhlIGJ1dHRvbi4gSWYgb21pdHRlZCwgdXNlcyB0aGUgdXAgc3RhdGUuCgkqICBAcGFyYW0ge1BJWEkuVGV4dHVyZX0gW2ltYWdlU2V0dGluZ3MuZG93bi50ZXhdIFRoZSBzb3VyY2VSZWN0IGZvciB0aGUgc3RhdGUgd2l0aGluIHRoZSBpbWFnZS4KCSogIEBwYXJhbSB7T2JqZWN0fSBbaW1hZ2VTZXR0aW5ncy5kb3duLmxhYmVsPW51bGxdIExhYmVsIGluZm9ybWF0aW9uIHNwZWNpZmljIHRvIHRoaXMgc3RhdGUuIFByb3BlcnRpZXMgb24gdGhpcyBwYXJhbWV0ZXIgb3ZlcnJpZGUgZGF0YSAKCSogICAgICAgICBpbiB0aGUgbGFiZWwgcGFyYW1ldGVyIGZvciB0aGlzIGJ1dHRvbiBzdGF0ZSBvbmx5LiBBbGwgdmFsdWVzIGV4Y2VwdCAidGV4dCIgYW5kICJ0eXBlIiBmcm9tIHRoZSBsYWJlbCBwYXJhbWV0ZXIgbWF5IGJlIG92ZXJyaWRkZW4uCgkqICBAcGFyYW0ge09iamVjdHxQSVhJLlRleHR1cmV9IFtpbWFnZVNldHRpbmdzLmRpc2FibGVkPW51bGxdIFRoZSB0ZXh0dXJlIGZvciB0aGUgZGlzYWJsZWQgc3RhdGUgb2YgdGhlIGJ1dHRvbi4gSWYgb21pdHRlZCwgdXNlcyB0aGUgdXAgc3RhdGUuCgkqICBAcGFyYW0ge1BJWEkuVGV4dHVyZX0gW2ltYWdlU2V0dGluZ3MuZGlzYWJsZWQudGV4XSBUaGUgc291cmNlUmVjdCBmb3IgdGhlIHN0YXRlIHdpdGhpbiB0aGUgaW1hZ2UuCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3MuZGlzYWJsZWQubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciBvdmVycmlkZSBkYXRhIAoJKiAgICAgICAgIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBhbmQgInR5cGUiIGZyb20gdGhlIGxhYmVsIHBhcmFtZXRlciBtYXkgYmUgb3ZlcnJpZGRlbi4KCSogIEBwYXJhbSB7T2JqZWN0fFBJWEkuVGV4dHVyZX0gW2ltYWdlU2V0dGluZ3MuPHlvdXJDdXN0b21TdGF0ZT49bnVsbF0gVGhlIHZpc3VhbCBpbmZvcm1hdGlvbiBhYm91dCBhIGN1c3RvbSBzdGF0ZSBmb3VuZCBpbiBpbWFnZVNldHRpbmdzLnByaW9yaXR5LgoJKiAgICAgICAgIEFueSBzdGF0ZSBhZGRlZCB0aGlzIHdheSBoYXMgYSBwcm9wZXJ0eSBvZiB0aGUgc2FtZSBuYW1lIGFkZGVkIHRvIHRoZSBidXR0b24uIEV4YW1wbGVzIG9mIHByZXZpb3VzIHN0YXRlcyB0aGF0IGhhdmUgYmVlbgoJKiAgICAgICAgIG1vdmVkIHRvIHRoaXMgc3lzdGVtIGFyZSAic2VsZWN0ZWQiIGFuZCAiaGlnaGxpZ2h0ZWQiLgoJKiAgQHBhcmFtIHtQSVhJLlRleHR1cmV9IFtpbWFnZVNldHRpbmdzLjx5b3VyQ3VzdG9tU3RhdGU+LnRleF0gVGhlIHRleHR1cmUgZm9yIHRoZSBjdXN0b20gc3RhdGUuCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3MuPHlvdXJDdXN0b21TdGF0ZT4ubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciAKCSogICAgICAgICBvdmVycmlkZSBkYXRhIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBmcm9tIHRoZSBsYWJlbCBwYXJhbWV0ZXIgbWF5IGJlCgkqICAgICAgICAgb3ZlcnJpZGRlbi4KCSogIEBwYXJhbSB7UElYSS5Qb2ludH0gW2ltYWdlU2V0dGluZ3Mub3JpZ2luPW51bGxdIEFuIG9wdGlvbmFsIG9mZnNldCBmb3IgYWxsIGJ1dHRvbiBncmFwaGljcywgaW4gY2FzZSB5b3Ugd2FudCBidXR0b24gCgkqICAgICAgICAgcG9zaXRpb25pbmcgdG8gbm90IGluY2x1ZGUgYSBoaWdobGlnaHQgZ2xvdywgb3IgYW55IG90aGVyIHJlYXNvbiB5b3Ugd291bGQgd2FudCB0byBvZmZzZXQgdGhlIGJ1dHRvbiBhcnQgYW5kIGxhYmVsLgoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtpbWFnZVNldHRpbmdzLnNjYWxlPTFdIFRoZSBzY2FsZSB0byB1c2UgZm9yIHRoZSB0ZXh0dXJlcy4gVGhpcyBhbGxvd3Mgc21hbGxlciBhcnQgYXNzZXRzIHRoYW4gdGhlIGRlc2lnbmVkIHNpemUgdG8gYmUgdXNlZC4KCSogIEBwYXJhbSB7T2JqZWN0fSBbbGFiZWw9bnVsbF0gSW5mb3JtYXRpb24gYWJvdXQgdGhlIHRleHQgbGFiZWwgb24gdGhlIGJ1dHRvbi4gT21pdHRpbmcgdGhpcyBtYWtlcyB0aGUgYnV0dG9uIG5vdCB1c2UgYSBsYWJlbC4KCSogIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWwudHlwZV0gSWYgbGFiZWwudHlwZSBpcyAiYml0bWFwIiwgdGhlbiBhIFBJWEkuQml0bWFwVGV4dCB0ZXh0IGlzIGNyZWF0ZWQsIG90aGVyd2lzZSBhIFBJWEkuVGV4dCBpcyBjcmVhdGVkIGZvciB0aGUgbGFiZWwuCgkqICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsLnRleHRdIFRoZSB0ZXh0IHRvIGRpc3BsYXkgb24gdGhlIGxhYmVsLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtsYWJlbC5zdHlsZV0gVGhlIHN0eWxlIG9mIHRoZSB0ZXh0IGZpZWxkLCBpbiB0aGUgZm9ybWF0IHRoYXQgUElYSS5CaXRtYXBUZXh0IGFuZCBQSVhJLlRleHQgZXhwZWN0LgoJKiAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBbbGFiZWwueD0iY2VudGVyIl0gQW4geCBwb3NpdGlvbiB0byBwbGFjZSB0aGUgbGFiZWwgdGV4dCBhdCByZWxhdGl2ZSB0byB0aGUgYnV0dG9uLgoJKiAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBbbGFiZWwueT0iY2VudGVyIl0gQSB5IHBvc2l0aW9uIHRvIHBsYWNlIHRoZSBsYWJlbCB0ZXh0IGF0IHJlbGF0aXZlIHRvIHRoZSBidXR0b24uIElmIG9taXR0ZWQsCgkqICAgICAgICAgImNlbnRlciIgaXMgdXNlZCwgd2hpY2ggYXR0ZW1wdHMgdG8gdmVydGljYWxseSBjZW50ZXIgdGhlIGxhYmVsIG9uIHRoZSBidXR0b24uCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtlbmFibGVkPXRydWVdIFdoZXRoZXIgb3Igbm90IHRoZSBidXR0b24gaXMgaW5pdGlhbGx5IGVuYWJsZWQuCgkqLwoJdmFyIEJ1dHRvbiA9IGZ1bmN0aW9uKGltYWdlU2V0dGluZ3MsIGxhYmVsLCBlbmFibGVkKQoJewoJCWlmKCFpbWFnZVNldHRpbmdzKSByZXR1cm47CgkJUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwodGhpcyk7CgkJdGhpcy5pbml0aWFsaXplKGltYWdlU2V0dGluZ3MsIGxhYmVsLCBlbmFibGVkKTsKCX07CgkKCS8vIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlCgl2YXIgcCA9IEJ1dHRvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUpOwoJCgkvKgoJKiAgVGhlIHNwcml0ZSB0aGF0IGlzIHRoZSBib2R5IG9mIHRoZSBidXR0b24uCgkqICBUaGUgdHlwZSBvZiB0aGlzIHByb3BlcnR5IGlzIGRlcGVuZGVudCBvbiB3aGljaCB2ZXJzaW9uIG9mIHRoZSBPUyBsaWJyYXJ5IGlzIHVzZWQuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge1BJWEkuU3ByaXRlfSBiYWNrCgkqICBAcmVhZE9ubHkKCSovCglwLmJhY2sgPSBudWxsOwoKCS8qCgkqICBUaGUgdGV4dCBmaWVsZCBvZiB0aGUgYnV0dG9uLiBUaGUgbGFiZWwgaXMgY2VudGVyZWQgYnkgYm90aCB3aWR0aCBhbmQgaGVpZ2h0IG9uIHRoZSBidXR0b24uCgkqICBUaGUgdHlwZSBvZiB0aGlzIHByb3BlcnR5IGlzIGRlcGVuZGVudCBvbiB3aGljaCB2ZXJzaW9uIG9mIHRoZSBPUyBsaWJyYXJ5IGlzIHVzZWQuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge1BJWEkuVGV4dHxQSVhJLkJpdG1hcFRleHR9IGxhYmVsCgkqICBAcmVhZE9ubHkKCSovCglwLmxhYmVsID0gbnVsbDsKCgkvKioKCSogIFRoZSBmdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBjYWxsZWQgd2hlbiB0aGUgYnV0dG9uIGlzIHJlbGVhc2VkLgoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtmdW5jdGlvbn0gcmVsZWFzZUNhbGxiYWNrCgkqLwoJcC5yZWxlYXNlQ2FsbGJhY2sgPSBudWxsOwoKCS8qKgoJKiAgVGhlIGZ1bmN0aW9uIHRoYXQgc2hvdWxkIGJlIGNhbGxlZCB3aGVuIHRoZSBidXR0b24gaXMgbW91c2VkIG92ZXIuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBvdmVyQ2FsbGJhY2sKCSovCglwLm92ZXJDYWxsYmFjayA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGZ1bmN0aW9uIHRoYXQgc2hvdWxkIGJlIGNhbGxlZCB3aGVuIG1vdXNlIGxlYXZlcyB0aGUgYnV0dG9uLgoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtmdW5jdGlvbn0gb3V0Q2FsbGJhY2sKCSovCglwLm91dENhbGxiYWNrID0gbnVsbDsKCgkvKioKCSogQSBkaWN0aW9uYXJ5IG9mIHN0YXRlIGJvb2xlYW5zLCBrZXllZCBieSBzdGF0ZSBuYW1lLgoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge09iamVjdH0gX3N0YXRlRmxhZ3MKCSovCglwLl9zdGF0ZUZsYWdzID0gbnVsbDsKCS8qKgoJKiBBbiBhcnJheSBvZiBzdGF0ZSBuYW1lcyAoU3RyaW5ncyksIGluIHRoZWlyIG9yZGVyIG9mIHByaW9yaXR5LgoJKiBUaGUgc3RhbmRhcmQgb3JkZXIgcHJldmlvdXNseSB3YXMgWyJoaWdobGlnaHRlZCIsICJkaXNhYmxlZCIsICJkb3duIiwgIm92ZXIiLCAic2VsZWN0ZWQiLCAidXAiXS4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtBcnJheX0gX3N0YXRlUHJpb3JpdHkKCSovCglwLl9zdGF0ZVByaW9yaXR5ID0gbnVsbDsKCQoJLyoqCgkqIEEgZGljdGlvbmFyeSBvZiBzdGF0ZSBncmFwaGljIGRhdGEsIGtleWVkIGJ5IHN0YXRlIG5hbWUuCgkqIEVhY2ggb2JqZWN0IGNvbnRhaW5zIHRoZSBzb3VyY2VSZWN0IChzcmMpIGFuZCBvcHRpb25hbGx5ICd0cmltJywgYW5vdGhlciBSZWN0YW5nbGUuCgkqIEFkZGl0aW9uYWxseSwgZWFjaCBvYmplY3Qgd2lsbCBjb250YWluIGEgJ2xhYmVsJyBvYmplY3QgaWYgdGhlIGJ1dHRvbiBoYXMgYSB0ZXh0IGxhYmVsLgoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge09iamVjdH0gX3N0YXRlRGF0YQoJKi8KCXAuX3N0YXRlRGF0YSA9IG51bGw7CgoJLyoqCgkqIFRoZSBjdXJyZW50IHN0eWxlIGZvciB0aGUgbGFiZWwsIHRvIGF2b2lkIHNldHRpbmcgdGhpcyBpZiBpdCBpcyB1bmNoYW5nZWQuCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7T2JqZWN0fSBfY3VycmVudExhYmVsU3R5bGUKCSovCglwLl9jdXJyZW50TGFiZWxTdHlsZSA9IG51bGw7CgoJLyoqCgkqIEFuIG9mZnNldCB0byBidXR0b24gcG9zaXRpb25pbmcsIGdlbmVyYWxseSB1c2VkIHRvIGFkanVzdCBmb3IgYSBoaWdobGlnaHQgYXJvdW5kIHRoZSBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7UElYSS5Qb2ludH0gX29mZnNldAoJKi8KCXAuX29mZnNldCA9IG51bGw7CgkKCS8vPT09Y2FsbGJhY2tzIGZvciBtb3VzZS90b3VjaCBldmVudHMKCS8qCgkqIENhbGxiYWNrIGZvciBtb3VzZSBvdmVyLCBib3VuZCB0byB0aGlzIGJ1dHRvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX292ZXJDQgoJKi8KCXAuX292ZXJDQiA9IG51bGw7CgoJLyoKCSogQ2FsbGJhY2sgZm9yIG1vdXNlIG91dCwgYm91bmQgdG8gdGhpcyBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF9vdXRDQgoJKi8KCXAuX291dENCID0gbnVsbDsKCgkvKgoJKiBDYWxsYmFjayBmb3IgbW91c2UgZG93biwgYm91bmQgdG8gdGhpcyBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF9kb3duQ0IKCSovCglwLl9kb3duQ0IgPSBudWxsOwoKCS8qCgkqIENhbGxiYWNrIGZvciBtb3VzZSB1cCwgYm91bmQgdG8gdGhpcyBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF91cENCCgkqLwoJcC5fdXBDQiA9IG51bGw7CgoJLyoqCgkqIENhbGxiYWNrIGZvciBtb3VzZSB1cCBvdXRzaWRlLCBib3VuZCB0byB0aGlzIGJ1dHRvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX3VwT3V0Q0IKCSovCglwLl91cE91dENCID0gbnVsbDsKCQoJLyoKCSogVGhlIHdpZHRoIG9mIHRoZSBidXR0b24gYXJ0LCBpbmRlcGVuZGVudCBvZiB0aGUgc2NhbGluZyBvZiB0aGUgYnV0dG9uIGl0c2VsZi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtOdW1iZXJ9IF93aWR0aAoJKi8KCXAuX3dpZHRoID0gMDsKCgkvKgoJKiBUaGUgaGVpZ2h0IG9mIHRoZSBidXR0b24gYXJ0LCBpbmRlcGVuZGVudCBvZiB0aGUgc2NhbGluZyBvZiB0aGUgYnV0dG9uIGl0c2VsZi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtOdW1iZXJ9IF9oZWlnaHQKCSovCglwLl9oZWlnaHQgPSAwOwoKCS8qCgkqIEEgbGlzdCBvZiBzdGF0ZSBuYW1lcyB0aGF0IHNob3VsZCBub3QgaGF2ZSBwcm9wZXJ0aWVzIGF1dG9nZW5lcmF0ZWQuCgkqIEBwcml2YXRlCgkqIEBzdGF0aWMKCSogQHByb3BlcnR5IHtBcnJheX0gUkVTRVJWRURfU1RBVEVTCgkqLwoJdmFyIFJFU0VSVkVEX1NUQVRFUyA9IFsiZGlzYWJsZWQiLCAiZW5hYmxlZCIsICJ1cCIsICJvdmVyIiwgImRvd24iXTsKCS8qCgkqIEEgc3RhdGUgcHJpb3JpdHkgbGlzdCB0byB1c2UgYXMgdGhlIGRlZmF1bHQuCgkqIEBwcml2YXRlCgkqIEBzdGF0aWMKCSogQHByb3BlcnR5IHtBcnJheX0gREVGQVVMVF9QUklPUklUWQoJKi8KCXZhciBERUZBVUxUX1BSSU9SSVRZID0gWyJkaXNhYmxlZCIsICJkb3duIiwgIm92ZXIiLCAidXAiXTsKCQoJLyoqIAoJKiAgQ29uc3RydWN0b3IgZm9yIHRoZSBidXR0b24gd2hlbiB1c2luZyBQSVhJLgoJKiAgQG1ldGhvZCBpbml0aWFsaXplCgkqICBAcGFyYW0gIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzXSBJbmZvcm1hdGlvbiBhYm91dCB0aGUgYXJ0IHRvIGJlIHVzZWQgZm9yIGJ1dHRvbiBzdGF0ZXMsIGFzIHdlbGwgYXMgaWYgdGhlIGJ1dHRvbiBpcyBzZWxlY3RhYmxlIG9yIG5vdC4KCSogIEBwYXJhbSB7T2JqZWN0fSBbbGFiZWw9bnVsbF0gSW5mb3JtYXRpb24gYWJvdXQgdGhlIHRleHQgbGFiZWwgb24gdGhlIGJ1dHRvbi4gT21pdHRpbmcgdGhpcyBtYWtlcyB0aGUgYnV0dG9uIG5vdCB1c2UgYSBsYWJlbC4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW2VuYWJsZWQ9dHJ1ZV0gV2hldGhlciBvciBub3QgdGhlIGJ1dHRvbiBpcyBpbml0aWFsbHkgZW5hYmxlZC4KCSovCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbihpbWFnZVNldHRpbmdzLCBsYWJlbCwgZW5hYmxlZCkKCXsKCQl0aGlzLmJhY2sgPSBuZXcgUElYSS5TcHJpdGUoaW1hZ2VTZXR0aW5ncy51cCk7CgkJdGhpcy5hZGRDaGlsZCh0aGlzLmJhY2spOwoJCQoJCXRoaXMuX292ZXJDQiA9IHRoaXMuX29uT3Zlci5iaW5kKHRoaXMpOwoJCXRoaXMuX291dENCID0gdGhpcy5fb25PdXQuYmluZCh0aGlzKTsKCQl0aGlzLl9kb3duQ0IgPSB0aGlzLl9vbkRvd24uYmluZCh0aGlzKTsKCQl0aGlzLl91cENCID0gdGhpcy5fb25VcC5iaW5kKHRoaXMpOwoJCXRoaXMuX3VwT3V0Q0IgPSB0aGlzLl9vblVwT3V0c2lkZS5iaW5kKHRoaXMpOwoKCQl2YXIgX3N0YXRlRGF0YSA9IHRoaXMuX3N0YXRlRGF0YSA9IHt9OwoJCXRoaXMuX3N0YXRlRmxhZ3MgPSB7fTsKCQl0aGlzLl9vZmZzZXQgPSBuZXcgUElYSS5Qb2ludCgpOwoJCQoJCS8vYSBjbG9uZSBvZiB0aGUgbGFiZWwgZGF0YSB0byB1c2UgYXMgYSBkZWZhdWx0IHZhbHVlLCB3aXRob3V0IGNoYW5naW5nIHRoZSBvcmlnaW5hbAoJCXZhciBsYWJlbERhdGE7CgkJaWYobGFiZWwpCgkJewoJCQlsYWJlbERhdGEgPSBjbG9uZShsYWJlbCk7CgkJCWRlbGV0ZSBsYWJlbERhdGEudGV4dDsKCQkJZGVsZXRlIGxhYmVsRGF0YS50eXBlOwoJCQlpZihsYWJlbERhdGEueCA9PT0gdW5kZWZpbmVkKQoJCQkJbGFiZWxEYXRhLnggPSAiY2VudGVyIjsKCQkJaWYobGFiZWxEYXRhLnkgPT09IHVuZGVmaW5lZCkKCQkJCWxhYmVsRGF0YS55ID0gImNlbnRlciI7CgkJCS8vY2xvbmUgdGhlIHN0eWxlIG9iamVjdCBhbmQgc2V0IHVwIHRoZSBkZWZhdWx0cyBmcm9tIFBJWEkuVGV4dCBvciBQSVhJLkJpdG1hcFRleHQKCQkJdmFyIHN0eWxlID0gbGFiZWxEYXRhLnN0eWxlID0gY2xvbmUobGFiZWwuc3R5bGUpOwoJCQlpZihsYWJlbC50eXBlID09ICJiaXRtYXAiKQoJCQl7CgkJCQlzdHlsZS5hbGlnbiA9IHN0eWxlLmFsaWduIHx8ICJsZWZ0IjsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXN0eWxlLmZvbnQgPSBzdHlsZS5mb250IHx8ICJib2xkIDIwcHQgQXJpYWwiOwoJCQkJc3R5bGUuZmlsbCA9IHN0eWxlLmZpbGwgfHwgImJsYWNrIjsKCQkJCXN0eWxlLmFsaWduID0gc3R5bGUuYWxpZ24gfHwgImxlZnQiOwoJCQkJc3R5bGUuc3Ryb2tlID0gc3R5bGUuc3Ryb2tlIHx8ICJibGFjayI7CgkJCQlzdHlsZS5zdHJva2VUaGlja25lc3MgPSBzdHlsZS5zdHJva2VUaGlja25lc3MgfHwgMDsKCQkJCXN0eWxlLndvcmRXcmFwID0gc3R5bGUud29yZFdyYXAgfHwgZmFsc2U7CgkJCQlzdHlsZS53b3JkV3JhcFdpZHRoID0gc3R5bGUud29yZFdyYXBXaWR0aCB8fCAxMDA7CgkJCX0KCQl9CgkJCgkJdGhpcy5fc3RhdGVQcmlvcml0eSA9IGltYWdlU2V0dGluZ3MucHJpb3JpdHkgfHwgREVGQVVMVF9QUklPUklUWTsKCQlmb3IodmFyIGkgPSB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKS8vc3RhcnQgYXQgdGhlIGVuZCB0byBzdGFydCBhdCB0aGUgdXAgc3RhdGUKCQl7CgkJCXZhciBzdGF0ZSA9IHRoaXMuX3N0YXRlUHJpb3JpdHlbaV07CgkJCS8vc2V0IHVwIHRoZSBwcm9wZXJ0eSBmb3IgdGhlIHN0YXRlIHNvIGl0IGNhbiBiZSBzZXQgLSB0aGUgZnVuY3Rpb24gd2lsbCBpZ25vcmUgcmVzZXJ2ZWQgc3RhdGVzCgkJCXRoaXMuX2FkZFByb3BlcnR5KHN0YXRlKTsKCQkJLy9zZXQgdGhlIGRlZmF1bHQgdmFsdWUgZm9yIHRoZSBzdGF0ZSBmbGFnCgkJCWlmKHN0YXRlICE9ICJkaXNhYmxlZCIgJiYgc3RhdGUgIT0gInVwIikKCQkJCXRoaXMuX3N0YXRlRmxhZ3Nbc3RhdGVdID0gZmFsc2U7CgkJCXZhciBpbnB1dERhdGEgPSBpbWFnZVNldHRpbmdzW3N0YXRlXTsKCQkJCgkJCWlmKGlucHV0RGF0YSkKCQkJewoJCQkJLy9pZiBpbnB1dERhdGEgaXMgYW4gb2JqZWN0IHdpdGggYSB0ZXggcHJvcGVydHksIHVzZSB0aGF0CgkJCQkvL290aGVyd2lzZSBpdCBpcyBhIHRleHR1cmUgaXRzZWxmCgkJCQlpZihpbnB1dERhdGEudGV4KQoJCQkJCV9zdGF0ZURhdGFbc3RhdGVdID0ge3RleDogaW5wdXREYXRhLnRleH07CgkJCQllbHNlCgkJCQkJX3N0YXRlRGF0YVtzdGF0ZV0gPSB7dGV4OiBpbnB1dERhdGF9OwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJLy9pdCdzIGVzdGFibGlzaGVkIHRoYXQgb3ZlciwgZG93biwgYW5kIHBhcnRpY3VsYXJseSBkaXNhYmxlZCBkZWZhdWx0IHRvIHRoZSB1cCBzdGF0ZQoJCQkJX3N0YXRlRGF0YVtzdGF0ZV0gPSBfc3RhdGVEYXRhLnVwOwoJCQl9CgkJCS8vc2V0IHVwIHRoZSBsYWJlbCBpbmZvIGZvciB0aGlzIHN0YXRlCgkJCWlmKGxhYmVsKQoJCQl7CgkJCQkvL2lmIHRoZXJlIGlzIGFjdHVhbCBsYWJlbCBkYXRhIGZvciB0aGlzIHN0YXRlLCB1c2UgdGhhdAoJCQkJaWYoaW5wdXREYXRhICYmIGlucHV0RGF0YS5sYWJlbCkKCQkJCXsKCQkJCQlpbnB1dERhdGEgPSBpbnB1dERhdGEubGFiZWw7CgkJCQkJdmFyIHN0YXRlTGFiZWwgPSBfc3RhdGVEYXRhW3N0YXRlXS5sYWJlbCA9IHt9OwoJCQkJCXN0YXRlTGFiZWwuc3R5bGUgPSBpbnB1dERhdGEuc3R5bGUgfHwgbGFiZWxEYXRhLnN0eWxlOwoJCQkJCXN0YXRlTGFiZWwueCA9IGlucHV0RGF0YS54IHx8IGxhYmVsRGF0YS54OwoJCQkJCXN0YXRlTGFiZWwueSA9IGlucHV0RGF0YS55IHx8IGxhYmVsRGF0YS55OwoJCQkJfQoJCQkJLy9vdGhlcndpc2UgdXNlIHRoZSBkZWZhdWx0CgkJCQllbHNlCgkJCQkJX3N0YXRlRGF0YVtzdGF0ZV0ubGFiZWwgPSBsYWJlbERhdGE7CgkJCX0KCQl9CgkJLy9lbnN1cmUgdGhhdCBvdXIgcmVxdWlyZWQgc3RhdGVzIGV4aXN0CgkJaWYoIV9zdGF0ZURhdGEudXApCgkJewoJCQlEZWJ1Zy5lcnJvcigiQnV0dG9uIGxhY2tzIGFuIHVwIHN0YXRlISBUaGlzIGlzIGEgc2VyaW91cyBwcm9ibGVtISBJbnB1dCBkYXRhIGZvbGxvd3M6Iik7CgkJCURlYnVnLmVycm9yKGltYWdlU2V0dGluZ3MpOwoJCX0KCQlpZighX3N0YXRlRGF0YS5vdmVyKQoJCQlfc3RhdGVEYXRhLm92ZXIgPSBfc3RhdGVEYXRhLnVwOwoJCWlmKCFfc3RhdGVEYXRhLmRvd24pCgkJCV9zdGF0ZURhdGEuZG93biA9IF9zdGF0ZURhdGEudXA7CgkJaWYoIV9zdGF0ZURhdGEuZGlzYWJsZWQpCgkJCV9zdGF0ZURhdGEuZGlzYWJsZWQgPSBfc3RhdGVEYXRhLnVwOwoJCS8vc2V0IHVwIHRoZSBvZmZzZXQKCQlpZihpbWFnZVNldHRpbmdzLm9mZnNldCkKCQl7CgkJCXRoaXMuX29mZnNldC54ID0gaW1hZ2VTZXR0aW5ncy5vZmZzZXQueDsKCQkJdGhpcy5fb2Zmc2V0LnkgPSBpbWFnZVNldHRpbmdzLm9mZnNldC55OwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLl9vZmZzZXQueCA9IHRoaXMuX29mZnNldC55ID0gMDsKCQl9CgoJCWlmKGltYWdlU2V0dGluZ3Muc2NhbGUpCgkJewoJCQl2YXIgcyA9IGltYWdlU2V0dGluZ3Muc2NhbGUgfHwgMTsKCQkJdGhpcy5iYWNrLnNjYWxlLnggPSB0aGlzLmJhY2suc2NhbGUueSA9IHM7CgkJfQoJCQoJCWlmKGxhYmVsKQoJCXsKCQkJdGhpcy5sYWJlbCA9IGxhYmVsLnR5cGUgPT0gImJpdG1hcCIgPyBuZXcgUElYSS5CaXRtYXBUZXh0KGxhYmVsLnRleHQsIGxhYmVsRGF0YS5zdHlsZSkgOiBuZXcgUElYSS5UZXh0KGxhYmVsLnRleHQsIGxhYmVsRGF0YS5zdHlsZSk7CgkJCXRoaXMuYWRkQ2hpbGQodGhpcy5sYWJlbCk7CgkJfQoKCQl0aGlzLmJhY2sueCA9IHRoaXMuX29mZnNldC54OwoJCXRoaXMuYmFjay55ID0gdGhpcy5fb2Zmc2V0Lnk7CgkJCgkJdGhpcy5fd2lkdGggPSB0aGlzLmJhY2sud2lkdGg7CgkJdGhpcy5faGVpZ2h0ID0gdGhpcy5iYWNrLmhlaWdodDsKCQkKCQl0aGlzLmVuYWJsZWQgPSBlbmFibGVkID09PSB1bmRlZmluZWQgPyB0cnVlIDogISFlbmFibGVkOwoJfTsKCgkvKgoJKiAgQSBzaW1wbGUgZnVuY3Rpb24gZm9yIG1ha2luZyBhIHNoYWxsb3cgY29weSBvZiBhbiBvYmplY3QuCgkqLwoJZnVuY3Rpb24gY2xvbmUob2JqKQoJewoJCWlmICghb2JqIHx8ICJvYmplY3QiICE9IHR5cGVvZiBvYmopIHJldHVybiBudWxsOwoJCXZhciBjb3B5ID0gb2JqLmNvbnN0cnVjdG9yKCk7CgkJZm9yICh2YXIgYXR0ciBpbiBvYmopIHsKCQkJaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShhdHRyKSkgY29weVthdHRyXSA9IG9ialthdHRyXTsKCQl9CgkJcmV0dXJuIGNvcHk7Cgl9CgkKCS8qCgkqICBUaGUgd2lkdGggb2YgdGhlIGJ1dHRvbiwgYmFzZWQgb24gdGhlIHdpZHRoIG9mIGJhY2suIFRoaXMgdmFsdWUgaXMgYWZmZWN0ZWQgYnkgc2NhbGUuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge051bWJlcn0gd2lkdGgKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgIndpZHRoIiwgewoJCWdldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLl93aWR0aCAqIHRoaXMuc2NhbGUueDt9LAoJCXNldDpmdW5jdGlvbih2YWx1ZSl7CgkJCXRoaXMuc2NhbGUueCA9IHZhbHVlIC8gdGhpcy5fd2lkdGg7CgkJfQoJfSk7CgkvKgoJKiAgVGhlIGhlaWdodCBvZiB0aGUgYnV0dG9uLCBiYXNlZCBvbiB0aGUgaGVpZ2h0IG9mIGJhY2suIFRoaXMgdmFsdWUgaXMgYWZmZWN0ZWQgYnkgc2NhbGUuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge051bWJlcn0gaGVpZ2h0CgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJoZWlnaHQiLCB7CgkJZ2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuX2hlaWdodCAqIHRoaXMuc2NhbGUueTt9LAoJCXNldDpmdW5jdGlvbih2YWx1ZSl7CgkJCXRoaXMuc2NhbGUueSA9IHZhbHVlIC8gdGhpcy5faGVpZ2h0OwoJCX0KCX0pOwoJCgkvKgoJKiAgU2V0cyB0aGUgdGV4dCBvZiB0aGUgbGFiZWwuIFRoaXMgZG9lcyBub3RoaW5nIGlmIHRoZSBidXR0b24gd2FzIG5vdCBpbml0aWFsaXplZCB3aXRoIGEgbGFiZWwuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHNldFRleHQKCSogIEBwYXJhbSB7U3RyaW5nfSB0ZXh0IFRoZSB0ZXh0IHRvIHNldCB0aGUgbGFiZWwgdG8uCgkqLwoJcC5zZXRUZXh0ID0gZnVuY3Rpb24odGV4dCkKCXsKCQlpZih0aGlzLmxhYmVsKQoJCXsKCQkJdGhpcy5sYWJlbC5zZXRUZXh0KHRleHQpOwoJCQkvL21ha2UgdGhlIHRleHQgdXBkYXRlIHNvIHdlIGNhbiBmaWd1cmUgb3V0IHRoZSBzaXplIGZvciBwb3NpdGlvbmluZwoJCQlpZih0aGlzLmxhYmVsIGluc3RhbmNlb2YgUElYSS5UZXh0KQoJCQl7CgkJCQl0aGlzLmxhYmVsLnVwZGF0ZVRleHQoKTsKCQkJCXRoaXMubGFiZWwuZGlydHkgPSBmYWxzZTsKCQkJfQoJCQllbHNlCgkJCQl0aGlzLmxhYmVsLmZvcmNlVXBkYXRlVGV4dCgpOwoJCQkvL3Bvc2l0aW9uIHRoZSB0ZXh0CgkJCXZhciBkYXRhOwoJCQlmb3IodmFyIGkgPSAwOyBpIDwgdGhpcy5fc3RhdGVQcmlvcml0eS5sZW5ndGg7ICsraSkKCQkJewoJCQkJaWYodGhpcy5fc3RhdGVGbGFnc1t0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXSkKCQkJCXsKCQkJCQlkYXRhID0gdGhpcy5fc3RhdGVEYXRhW3RoaXMuX3N0YXRlUHJpb3JpdHlbaV1dOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCWlmKCFkYXRhKQoJCQkJZGF0YSA9IHRoaXMuX3N0YXRlRGF0YS51cDsKCQkJZGF0YSA9IGRhdGEubGFiZWw7CgkJCWlmKGRhdGEueCA9PSAiY2VudGVyIikKCQkJewoJCQkJdmFyIGJXID0gdGhpcy5iYWNrLndpZHRoLCBsVyA9IHRoaXMubGFiZWwud2lkdGg7CgkJCQlzd2l0Y2godGhpcy5fY3VycmVudExhYmVsU3R5bGUuYWxpZ24pCgkJCQl7CgkJCQkJY2FzZSAiY2VudGVyIjoKCQkJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gYlcgKiAwLjU7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgInJpZ2h0IjoKCQkJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gKGJXIC0gbFcpICogMC41ICsgbFc7CgkJCQkJCWJyZWFrOwoJCQkJCWRlZmF1bHQ6Ly9sZWZ0IG9yIG51bGwgKGRlZmF1bHRzIHRvIGxlZnQpCgkJCQkJCXRoaXMubGFiZWwucG9zaXRpb24ueCA9IChiVyAtIGxXKSAqIDAuNTsKCQkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQkJZWxzZQoJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gZGF0YS54ICsgdGhpcy5fb2Zmc2V0Lng7CgkJCWlmKGRhdGEueSA9PSAiY2VudGVyIikKCQkJewoJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi55ID0gKHRoaXMuYmFjay5oZWlnaHQgLSB0aGlzLmxhYmVsLmhlaWdodCkgKiAwLjU7CgkJCX0KCQkJZWxzZQoJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi55ID0gZGF0YS55ICsgdGhpcy5fb2Zmc2V0Lnk7CgkJfQoJfTsKCQoJLyoKCSogIFdoZXRoZXIgb3Igbm90IHRoZSBidXR0b24gaXMgZW5hYmxlZC4KCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gZW5hYmxlZAoJKiAgQGRlZmF1bHQgdHJ1ZQoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiZW5hYmxlZCIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIXRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQ7IH0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQl7CgkJCXRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQgPSAhdmFsdWU7CgkJCXRoaXMuYnV0dG9uTW9kZSA9IHZhbHVlOwoJCQl0aGlzLmludGVyYWN0aXZlID0gdmFsdWU7CgkJCQoJCQkvL21ha2Ugc3VyZSBpbnRlcmFjdGlvbiBjYWxsYmFja3MgYXJlIHByb3Blcmx5IHNldAoJCQlpZih2YWx1ZSkKCQkJewoJCQkJdGhpcy5tb3VzZWRvd24gPSB0aGlzLnRvdWNoc3RhcnQgPSB0aGlzLl9kb3duQ0I7CgkJCQl0aGlzLm1vdXNlb3ZlciA9IHRoaXMuX292ZXJDQjsKCQkJCXRoaXMubW91c2VvdXQgPSB0aGlzLl9vdXRDQjsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMubW91c2Vkb3duID0gdGhpcy50b3VjaHN0YXJ0ID0gdGhpcy5tb3VzZW92ZXIgPSB0aGlzLm1vdXNlb3V0ID0gbnVsbDsKCQkJCXRoaXMubW91c2V1cCA9IHRoaXMudG91Y2hlbmQgPSB0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSBudWxsOwoJCQkJdGhpcy5fc3RhdGVGbGFncy5kb3duID0gdGhpcy5fc3RhdGVGbGFncy5vdmVyID0gZmFsc2U7CgkJCQkvL2Fsc28gdHVybiBvZmYgcGl4aSB2YWx1ZXMgc28gdGhhdCByZS1lbmFibGluZyBidXR0b24gd29ya3MgcHJvcGVybHkKCQkJCXRoaXMuX19pc092ZXIgPSBmYWxzZTsKCQkJfQoJCQkKCQkJdGhpcy5fdXBkYXRlU3RhdGUoKTsKCQl9Cgl9KTsKCgkvKioKCSogIEFkZHMgYSBwcm9wZXJ0eSB0byB0aGUgYnV0dG9uLiBTZXR0aW5nIHRoZSBwcm9wZXJ0eSBzZXRzIHRoZSB2YWx1ZSBpbgoJKiAgX3N0YXRlRmxhZ3MgYW5kIGNhbGxzIF91cGRhdGVTdGF0ZSgpLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX2FkZFByb3BlcnR5CgkqICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHlOYW1lIFRoZSBwcm9wZXJ0eSBuYW1lIHRvIGFkZCB0byB0aGUgYnV0dG9uLgoJKi8KCXAuX2FkZFByb3BlcnR5ID0gZnVuY3Rpb24ocHJvcGVydHlOYW1lKQoJewoJCS8vY2hlY2sgdG8gbWFrZSBzdXJlIHdlIGRvbid0IGFkZCByZXNlcnZlZCBuYW1lcwoJCWlmKFJFU0VSVkVEX1NUQVRFUy5pbmRleE9mKHByb3BlcnR5TmFtZSkgPj0gMCkgcmV0dXJuOwoJCQoJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHsKCQkJZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuX3N0YXRlRmxhZ3NbcHJvcGVydHlOYW1lXTsgfSwKCQkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQkJewoJCQkJdGhpcy5fc3RhdGVGbGFnc1twcm9wZXJ0eU5hbWVdID0gdmFsdWU7CgkJCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJCQl9CgkJfSk7Cgl9OwoJCgkvKgoJKiAgVXBkYXRlcyBiYWNrIGJhc2VkIG9uIHRoZSBjdXJyZW50IGJ1dHRvbiBzdGF0ZS4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF91cGRhdGVTdGF0ZQoJKi8KCXAuX3VwZGF0ZVN0YXRlID0gZnVuY3Rpb24oKQoJewoJCWlmKCF0aGlzLmJhY2spIHJldHVybjsKCgkJdmFyIGRhdGE7CgkJLy91c2UgdGhlIGhpZ2hlc3QgcHJpb3JpdHkgc3RhdGUKCQlmb3IodmFyIGkgPSAwOyBpIDwgdGhpcy5fc3RhdGVQcmlvcml0eS5sZW5ndGg7ICsraSkKCQl7CgkJCWlmKHRoaXMuX3N0YXRlRmxhZ3NbdGhpcy5fc3RhdGVQcmlvcml0eVtpXV0pCgkJCXsKCQkJCWRhdGEgPSB0aGlzLl9zdGF0ZURhdGFbdGhpcy5fc3RhdGVQcmlvcml0eVtpXV07CgkJCQlicmVhazsKCQkJfQoJCX0KCQkvL2lmIG5vIHN0YXRlIGlzIGFjdGl2ZSwgdXNlIHRoZSB1cCBzdGF0ZQoJCWlmKCFkYXRhKQoJCQlkYXRhID0gdGhpcy5fc3RhdGVEYXRhLnVwOwoJCXRoaXMuYmFjay5zZXRUZXh0dXJlKGRhdGEudGV4KTsKCQkvL2lmIHdlIGhhdmUgYSBsYWJlbCwgdXBkYXRlIHRoYXQgdG9vCgkJaWYodGhpcy5sYWJlbCkKCQl7CgkJCWRhdGEgPSBkYXRhLmxhYmVsOwoJCQkvL3VwZGF0ZSB0aGUgdGV4dCBzdHlsZQoJCQlpZighdGhpcy5fY3VycmVudExhYmVsU3R5bGUgfHwgIWRvT2JqZWN0c01hdGNoKHRoaXMuX2N1cnJlbnRMYWJlbFN0eWxlLCBkYXRhLnN0eWxlKSkKCQkJewoJCQkJdGhpcy5sYWJlbC5zZXRTdHlsZShkYXRhLnN0eWxlKTsKCQkJCXRoaXMuX2N1cnJlbnRMYWJlbFN0eWxlID0gZGF0YS5zdHlsZTsKCQkJCS8vbWFrZSB0aGUgdGV4dCB1cGRhdGUgc28gd2UgY2FuIGZpZ3VyZSBvdXQgdGhlIHNpemUgZm9yIHBvc2l0aW9uaW5nCgkJCQlpZih0aGlzLmxhYmVsIGluc3RhbmNlb2YgUElYSS5UZXh0KQoJCQkJewoJCQkJCXRoaXMubGFiZWwudXBkYXRlVGV4dCgpOwoJCQkJCXRoaXMubGFiZWwuZGlydHkgPSBmYWxzZTsKCQkJCX0KCQkJCWVsc2UKCQkJCQl0aGlzLmxhYmVsLmZvcmNlVXBkYXRlVGV4dCgpOwoJCQl9CgkJCS8vcG9zaXRpb24gdGhlIHRleHQKCQkJaWYoZGF0YS54ID09ICJjZW50ZXIiKQoJCQl7CgkJCQl2YXIgYlcgPSB0aGlzLmJhY2sud2lkdGgsIGxXID0gdGhpcy5sYWJlbC53aWR0aDsKCQkJCXN3aXRjaCh0aGlzLl9jdXJyZW50TGFiZWxTdHlsZS5hbGlnbikKCQkJCXsKCQkJCQljYXNlICJjZW50ZXIiOgoJCQkJCQl0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSBiVyAqIDAuNTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAicmlnaHQiOgoJCQkJCQl0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSAoYlcgLSBsVykgKiAwLjUgKyBsVzsKCQkJCQkJYnJlYWs7CgkJCQkJZGVmYXVsdDovL2xlZnQgb3IgbnVsbCAoZGVmYXVsdHMgdG8gbGVmdCkKCQkJCQkJdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gKGJXIC0gbFcpICogMC41OwoJCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCQllbHNlCgkJCQl0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSBkYXRhLnggKyB0aGlzLl9vZmZzZXQueDsKCQkJaWYoZGF0YS55ID09ICJjZW50ZXIiKQoJCQl7CgkJCQl0aGlzLmxhYmVsLnBvc2l0aW9uLnkgPSAodGhpcy5iYWNrLmhlaWdodCAtIHRoaXMubGFiZWwuaGVpZ2h0KSAqIDAuNTsKCQkJfQoJCQllbHNlCgkJCQl0aGlzLmxhYmVsLnBvc2l0aW9uLnkgPSBkYXRhLnkgKyB0aGlzLl9vZmZzZXQueTsKCQl9Cgl9OwoKCS8qCgkqIEEgc2ltcGxlIGZ1bmN0aW9uIGZvciBjb21wYXJpbmcgdGhlIHByb3BlcnRpZXMgb2YgdHdvIG9iamVjdHMKCSovCglmdW5jdGlvbiBkb09iamVjdHNNYXRjaChvYmoxLCBvYmoyKQoJewoJCWlmKG9iajEgPT09IG9iajIpCgkJCXJldHVybiB0cnVlOwoJCWZvcih2YXIga2V5IGluIG9iajEpCgkJewoJCQlpZihvYmoxW2tleV0gIT0gb2JqMltrZXldKQoJCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0KCQoJLyoqCgkqICBUaGUgY2FsbGJhY2sgZm9yIHdoZW4gdGhlIGJ1dHRvbiBpcyBtb3VzZWQgb3Zlci4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbk92ZXIKCSovCglwLl9vbk92ZXIgPSBmdW5jdGlvbihkYXRhKQoJewoJCXRoaXMuX3N0YXRlRmxhZ3Mub3ZlciA9IHRydWU7CgkJdGhpcy5fdXBkYXRlU3RhdGUoKTsKCQlpZih0aGlzLm92ZXJDYWxsYmFjaykKCQkJdGhpcy5vdmVyQ2FsbGJhY2sodGhpcyk7Cgl9OwoJCgkvKioKCSogIFRoZSBjYWxsYmFjayBmb3Igd2hlbiB0aGUgbW91c2UgbGVhdmVzIHRoZSBidXR0b24gYXJlYS4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbk91dAoJKi8KCXAuX29uT3V0ID0gZnVuY3Rpb24oZGF0YSkKCXsKCQl0aGlzLl9zdGF0ZUZsYWdzLm92ZXIgPSBmYWxzZTsKCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJCWlmKHRoaXMub3V0Q2FsbGJhY2spCgkJCXRoaXMub3V0Q2FsbGJhY2sodGhpcyk7Cgl9OwoJCgkvKioKCSogIFRoZSBjYWxsYmFjayBmb3Igd2hlbiB0aGUgYnV0dG9uIHJlY2VpdmVzIGEgbW91c2UgZG93biBldmVudC4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkRvd24KCSovCglwLl9vbkRvd24gPSBmdW5jdGlvbihkYXRhKQoJewoJCWRhdGEub3JpZ2luYWxFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCXRoaXMuX3N0YXRlRmxhZ3MuZG93biA9IHRydWU7CgkJdGhpcy5fdXBkYXRlU3RhdGUoKTsKCQkKCQl0aGlzLm1vdXNldXAgPSB0aGlzLnRvdWNoZW5kID0gdGhpcy5fdXBDQjsKCQl0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSB0aGlzLl91cE91dENCOwoJfTsKCQoJLyoqCgkqICBUaGUgY2FsbGJhY2sgZm9yIHdoZW4gdGhlIGJ1dHRvbiBmb3Igd2hlbiB0aGUgbW91c2UvdG91Y2ggaXMgcmVsZWFzZWQgb24gdGhlIGJ1dHRvbgoJKiAgLSBvbmx5IHdoZW4gdGhlIGJ1dHRvbiB3YXMgaGVsZCBkb3duIGluaXRpYWxseS4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vblVwCgkqLwoJcC5fb25VcCA9IGZ1bmN0aW9uKGRhdGEpCgl7CgkJZGF0YS5vcmlnaW5hbEV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJdGhpcy5fc3RhdGVGbGFncy5kb3duID0gZmFsc2U7CgkJdGhpcy5tb3VzZXVwID0gdGhpcy50b3VjaGVuZCA9IG51bGw7CgkJdGhpcy5tb3VzZXVwb3V0c2lkZSA9IHRoaXMudG91Y2hlbmRvdXRzaWRlID0gbnVsbDsKCQkKCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJCWlmKHRoaXMucmVsZWFzZUNhbGxiYWNrKQoJCQl0aGlzLnJlbGVhc2VDYWxsYmFjayh0aGlzKTsKCX07CgkKCS8qKgoJKiAgVGhlIGNhbGxiYWNrIGZvciB3aGVuIHRoZSBtb3VzZS90b3VjaCBpcyByZWxlYXNlZCBvdXRzaWRlIHRoZSBidXR0b24gd2hlbiB0aGUgYnV0dG9uIHdhcyBoZWxkIGRvd24uCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfb25VcE91dHNpZGUKCSovCglwLl9vblVwT3V0c2lkZSA9IGZ1bmN0aW9uKGRhdGEpCgl7CgkJdGhpcy5fc3RhdGVGbGFncy5kb3duID0gZmFsc2U7CgkJdGhpcy5tb3VzZXVwID0gdGhpcy50b3VjaGVuZCA9IG51bGw7CgkJdGhpcy5tb3VzZXVwb3V0c2lkZSA9IHRoaXMudG91Y2hlbmRvdXRzaWRlID0gbnVsbDsKCQkKCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJfTsKCQoJLyoKCSogIERlc3Ryb3lzIHRoZSBidXR0b24uCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5tb3VzZWRvd24gPSB0aGlzLnRvdWNoc3RhcnQgPSB0aGlzLm1vdXNlb3ZlciA9IHRoaXMubW91c2VvdXQgPSBudWxsOwoJCXRoaXMubW91c2V1cCA9IHRoaXMudG91Y2hlbmQgPSB0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSBudWxsOwoJCXRoaXMucmVtb3ZlQ2hpbGRyZW4odHJ1ZSk7CgkJdGhpcy5sYWJlbCA9IG51bGw7CgkJdGhpcy5iYWNrID0gbnVsbDsKCQl0aGlzLnJlbGVhc2VDYWxsYmFjayA9IG51bGw7CgkJdGhpcy5vdmVyQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMub3V0Q2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuX3N0YXRlRGF0YSA9IG51bGw7CgkJdGhpcy5fc3RhdGVGbGFncyA9IG51bGw7CgkJdGhpcy5fc3RhdGVQcmlvcml0eSA9IG51bGw7CgkJdGhpcy5fZG93bkNCID0gbnVsbDsKCQl0aGlzLl91cENCID0gbnVsbDsKCQl0aGlzLl9vdmVyQ0IgPSBudWxsOwoJCXRoaXMuX291dENCID0gbnVsbDsKCQl0aGlzLl91cE91dENCID0gbnVsbDsKCX07CgkKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5CdXR0b24gPSBCdXR0b247Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpIHsKCQoJInVzZSBzdHJpY3QiOwoJCgkvKioKCSogIERyYWcgbWFuYWdlciBpcyByZXNwb25zaWJsZSBmb3IgaGFuZGxpbmcgdGhlIGRyYWdnaW5nIG9mIHN0YWdlIGVsZW1lbnRzCgkqICBzdXBwb3J0cyBjbGljay1uLXN0aWNrIGFuZCBjbGljay1uLWRyYWcgZnVuY3Rpb25hbGl0eS4KCSoKCSogIEBjbGFzcyBEcmFnTWFuYWdlciAoUElYSSkKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gc3RhcnRDYWxsYmFjayBUaGUgY2FsbGJhY2sgd2hlbiB3aGVuIHN0YXJ0aW5nCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBlbmRDYWxsYmFjayBUaGUgY2FsbGJhY2sgd2hlbiBlbmRpbmcKCSovCgl2YXIgRHJhZ01hbmFnZXIgPSBmdW5jdGlvbihzdGFydENhbGxiYWNrLCBlbmRDYWxsYmFjaykKCXsKCQl0aGlzLmluaXRpYWxpemUoc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spOwoJfTsKCQoJLyoqIFJlZmVyZW5jZSB0byB0aGUgZHJhZyBtYW5hZ2VyICovCgl2YXIgcCA9IERyYWdNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwoJCgkvKioKCSogVGhlIG9iamVjdCB0aGF0J3MgYmVpbmcgZHJhZ2dlZAoJKiBAcHVibGljCgkqIEByZWFkT25seQoJKiBAcHJvcGVydHkge1BJWEkuRGlzcGxheU9iamVjdH0gZHJhZ2dlZE9iagoJKi8KCXAuZHJhZ2dlZE9iaiA9IG51bGw7CgkKCS8qKgoJKiBUaGUgcmFkaXVzIGluIHBpeGVsIHRvIGFsbG93IGZvciBkcmFnZ2luZywgb3IgZWxzZSBkb2VzIHN0aWNreSBjbGljawoJKiBAcHVibGljCgkqIEBwcm9wZXJ0eSBkcmFnU3RhcnRUaHJlc2hvbGQKCSogQGRlZmF1bHQgMjAKCSovCglwLmRyYWdTdGFydFRocmVzaG9sZCA9IDIwOwoJCgkvKioKCSogVGhlIHBvc2l0aW9uIHgsIHkgb2YgdGhlIG1vdXNlIGRvd24gb24gdGhlIHN0YWdlCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7UElYSS5Qb2ludH0gbW91c2VEb3duU3RhZ2VQb3MKCSovCglwLm1vdXNlRG93blN0YWdlUG9zID0gbnVsbDsKCgkvKioKCSogVGhlIHBvc2l0aW9uIHgsIHkgb2YgdGhlIG9iamVjdCB3aGVuIGludGVyYWN0aW9uIHdpdGggaXQgc3RhcnRlZC4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtQSVhJLlBvaW50fSBtb3VzZURvd25PYmpQb3MKCSovCglwLm1vdXNlRG93bk9ialBvcyA9IG51bGw7CgkKCS8qKgoJKiBJcyB0aGUgbW92ZSB0b3VjaCBiYXNlZAoJKiBAcHVibGljCgkqIEByZWFkT25seQoJKiBAcHJvcGVydHkge0Jvb2x9IGlzVG91Y2hNb3ZlCgkqIEBkZWZhdWx0IGZhbHNlCgkqLwoJcC5pc1RvdWNoTW92ZSA9IGZhbHNlOwoJCgkvKioKCSogSXMgdGhlIGRyYWcgYmVpbmcgaGVsZCBvbiBtb3VzZSBkb3duIChub3Qgc3RpY2t5IGNsaWNraW5nKQoJKiBAcHVibGljCgkqIEByZWFkT25seQoJKiBAcHJvcGVydHkge0Jvb2x9IGlzSGVsZERyYWcKCSogQGRlZmF1bHQgZmFsc2UKCSovCglwLmlzSGVsZERyYWcgPSBmYWxzZTsKCQoJLyoqCgkqIElzIHRoZSBkcmFnIGEgc3RpY2t5IGNsaWNraW5nIChjbGljayBvbiBhIGl0ZW0sIHRoZW4gbW91c2UgdGhlIG1vdXNlKQoJKiBAcHVibGljCgkqIEByZWFkT25seQoJKiBAcHJvcGVydHkge0Jvb2x9IGlzU3RpY2t5Q2xpY2sKCSogQGRlZmF1bHQgZmFsc2UKCSovCglwLmlzU3RpY2t5Q2xpY2sgPSBmYWxzZTsKCQoJLyoqCgkqIElmIHN0aWNreSBjbGljayBkcmFnZ2luZyBpcyBhbGxvd2VkLgoJKiBAcHVibGljCgkqIEBwcm9wZXJ0eSB7Qm9vbH0gYWxsb3dTdGlja3lDbGljawoJKiBAZGVmYXVsdCB0cnVlCgkqLwoJcC5hbGxvd1N0aWNreUNsaWNrID0gdHJ1ZTsKCgkvKioKCSogU2V0dGluZ3MgZm9yIHNuYXBwaW5nLgoJKgoJKiAgRm9ybWF0IGZvciBzbmFwcGluZyB0byBhIGxpc3Qgb2YgcG9pbnRzOgoJKgl7CgkqCQltb2RlOiJwb2ludHMiLAoJKgkJZGlzdDoyMCwvL3NuYXAgd2hlbiB3aXRoaW4gMjAgcGl4ZWxzL3VuaXRzCgkqCQlwb2ludHM6WwoJKgkJCXsgeDogMjAsIHk6MzAgfSwKCSoJCQl7IHg6IDUwLCB5OjEwIH0KCSoJCV0KCSoJfQoJKgoJKiBAcHVibGljCgkqIEBwcm9wZXJ0eSB7T2JqZWN0fSBzbmFwU2V0dGluZ3MKCSogQGRlZmF1bHQgbnVsbAoJKi8KCXAuc25hcFNldHRpbmdzID0gbnVsbDsKCQoJLyoqCgkqIFJlZmVyZW5jZSB0byB0aGUgc3RhZ2UKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtQSVhJLlN0YWdlfSBfdGhlU3RhZ2UKCSovCglwLl90aGVTdGFnZSA9IG51bGw7CgkKCS8qKgoJKiBUaGUgbG9jYWwgdG8gZ2xvYmFsIHBvc2l0aW9uIG9mIHRoZSBkcmFnCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7UElYSS5Qb2ludH0gX2RyYWdPZmZzZXQKCSovCglwLl9kcmFnT2Zmc2V0ID0gbnVsbDsKCQoJLyoqCgkqIEV4dGVybmFsIGNhbGxiYWNrIHdoZW4gd2Ugc3RhcnQgZHJhZ2dpbmcKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX2RyYWdTdGFydENhbGxiYWNrCgkqLwoJcC5fZHJhZ1N0YXJ0Q2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogRXh0ZXJuYWwgY2FsbGJhY2sgd2hlbiB3ZSBhcmUgZG9uZSBkcmFnZ2luZwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBfZHJhZ0VuZENhbGxiYWNrCgkqLwoJcC5fZHJhZ0VuZENhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIENhbGxiYWNrIHRvIHRlc3QgZm9yIHRoZSBzdGFydCBhIGhlbGQgZHJhZwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBfdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2sKCSovCglwLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayA9IG51bGw7CgkKCS8qKgoJKiBDYWxsYmFjayB0byBzdGFydCBhIHN0aWNreSBjbGljayBkcmFnCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjawoJKi8KCXAuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIENhbGxiYWNrIHdoZW4gd2UgYXJlIGRvbmUgd2l0aCB0aGUgZHJhZwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBfc3RhZ2VNb3VzZVVwQ2FsbGJhY2sKCSovCglwLl9zdGFnZU1vdXNlVXBDYWxsYmFjayA9IG51bGw7CgkJCgkvKioKCSogVGhlIGZ1bmN0aW9uIGNhbGwgd2hlbiB0aGUgbW91c2UvdG91Y2ggbW92ZXMKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gX3VwZGF0ZUNhbGxiYWNrIAoJKi8KCXAuX3VwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIFRoZSBjb2xsZWN0aW9uIG9mIGRyYWdnYWJsZSBvYmplY3RzCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7QXJyYXl9IF9kcmFnZ2FibGVPYmplY3RzCgkqLwoJcC5fZHJhZ2dhYmxlT2JqZWN0cyA9IG51bGw7CgkKCXZhciBoZWxwZXJQb2ludCA9IG51bGw7CgkKCXZhciBUWVBFX01PVVNFID0gMDsKCXZhciBUWVBFX1RPVUNIID0gMTsKCQoJLyoqIAoJKiBDb25zdHJ1Y3RvciAKCSogQG1ldGhvZCBpbml0aWFsaXplCgkqIEBwYXJhbSB7ZnVuY3Rpb259IHN0YXJ0Q2FsbGJhY2sgVGhlIGNhbGxiYWNrIHdoZW4gd2hlbiBzdGFydGluZwoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBlbmRDYWxsYmFjayBUaGUgY2FsbGJhY2sgd2hlbiBlbmRpbmcKCSovCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbihzdGFydENhbGxiYWNrLCBlbmRDYWxsYmFjaykKCXsKCQl0aGlzLl91cGRhdGVDYWxsYmFjayA9IHRoaXMuX3VwZGF0ZU9ialBvc2l0aW9uLmJpbmQodGhpcyk7CgkJdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2sgPSB0aGlzLl90cmlnZ2VySGVsZERyYWcuYmluZCh0aGlzKTsKCQl0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayA9IHRoaXMuX3RyaWdnZXJTdGlja3lDbGljay5iaW5kKHRoaXMpOwoJCXRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrID0gdGhpcy5fc3RvcERyYWcuYmluZCh0aGlzKTsKCQl0aGlzLl90aGVTdGFnZSA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLnN0YWdlOwoJCXRoaXMuX2RyYWdTdGFydENhbGxiYWNrID0gc3RhcnRDYWxsYmFjazsKCQl0aGlzLl9kcmFnRW5kQ2FsbGJhY2sgPSBlbmRDYWxsYmFjazsKCQl0aGlzLl9kcmFnZ2FibGVPYmplY3RzID0gW107CgkJdGhpcy5tb3VzZURvd25TdGFnZVBvcyA9IG5ldyBQSVhJLlBvaW50KDAsIDApOwoJCXRoaXMubW91c2VEb3duT2JqUG9zID0gbmV3IFBJWEkuUG9pbnQoMCwgMCk7CgkJaGVscGVyUG9pbnQgPSBuZXcgUElYSS5Qb2ludCgwLCAwKTsKCX07CgkKCS8qKgoJKglNYW51YWxseSBzdGFydHMgZHJhZ2dpbmcgYW4gb2JqZWN0LiBJZiBhIG1vdXNlIGRvd24gZXZlbnQgaXMgbm90IHN1cHBsaWVkIGFzIHRoZSBzZWNvbmQgYXJndW1lbnQsIGl0IAoJKiAgIGRlZmF1bHRzIHRvIGEgaGVsZCBkcmFnLCB0aGF0IGVuZHMgYXMgc29vbiBhcyB0aGUgbW91c2UgaXMgcmVsZWFzZWQuCgkqICBAbWV0aG9kIHN0YXJ0RHJhZwoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtQSVhJLkRpc3BsYXlPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRoYXQgc2hvdWxkIGJlIGRyYWdnZWQuCgkqICBAcGFyYW0ge1BJWEkuSW50ZXJhY3Rpb25EYXRhfSBpbnRlcmFjdGlvbkRhdGEgVGhlIGludGVyYWN0aW9uIGRhdGEgYWJvdXQgdGhlIGlucHV0IGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoaXMuCgkqLwoJcC5zdGFydERyYWcgPSBmdW5jdGlvbihvYmplY3QsIGludGVyYWN0aW9uRGF0YSkKCXsKCQl0aGlzLl9vYmpNb3VzZURvd24oVFlQRV9NT1VTRSwgb2JqZWN0LCBpbnRlcmFjdGlvbkRhdGEpOwoJfTsKCQoJLyoqCgkqIE1vdXNlIGRvd24gb24gYW4gb2JtZWN0CgkqICBAbWV0aG9kIF9vYmpNb3VzZURvd24KCSogIEBwcml2YXRlCgkqICBAcGFyYW0ge2ludH0gdHlwZSBUaGUgdHlwZSBvZiBpbnB1dCB0aGF0IHRyaWdnZXJlZCB0aGlzIGNhbGwgLSBlaXRoZXIgVFlQRV9NT1VTRSBvciBUWVBFX1RPVUNILgoJKiAgQHBhcmFtIHtQSVhJLkRpc3BsYXlPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRoYXQgc2hvdWxkIGJlIGRyYWdnZWQuCgkqLwoJcC5fb2JqTW91c2VEb3duID0gZnVuY3Rpb24odHlwZSwgb2JqLCBpbnRlcmFjdGlvbkRhdGEpCgl7CgkJLy8gaWYgd2UgYXJlIGRyYWdnaW5nIHNvbWV0aGluZywgdGhlbiBpZ25vcmUgYW55IG1vdXNlIGRvd25zCgkJLy8gdW50aWwgd2UgcmVsZWFzZSB0aGUgY3VycmVudGx5IGRyYWdnZWQgc3R1ZmYKCQlpZih0aGlzLmRyYWdnZWRPYmogIT09IG51bGwpIHJldHVybjsKCgkJdGhpcy5kcmFnZ2VkT2JqID0gb2JqOwoJCWNyZWF0ZWpzLlR3ZWVuLnJlbW92ZVR3ZWVucyh0aGlzLmRyYWdnZWRPYmopOwoJCWNyZWF0ZWpzLlR3ZWVuLnJlbW92ZVR3ZWVucyh0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24pOwoJCQoJCS8vZ2V0IHRoZSBtb3VzZSBwb3NpdGlvbiBhbmQgY29udmVydCBpdCB0byBvYmplY3QgcGFyZW50IHNwYWNlCgkJdGhpcy5fZHJhZ09mZnNldCA9IGludGVyYWN0aW9uRGF0YS5nZXRMb2NhbFBvc2l0aW9uKHRoaXMuZHJhZ2dlZE9iai5wYXJlbnQpOwoJCQoJCS8vbW92ZSB0aGUgb2Zmc2V0IHRvIHJlc3BlY3QgdGhlIG9iamVjdCdzIGN1cnJlbnQgcG9zaXRpb24KCQl0aGlzLl9kcmFnT2Zmc2V0LnggLT0gdGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uLng7CgkJdGhpcy5fZHJhZ09mZnNldC55IC09IHRoaXMuZHJhZ2dlZE9iai5wb3NpdGlvbi55OwoKCQl0aGlzLm1vdXNlRG93bk9ialBvcy54ID0gdGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uLng7CgkJdGhpcy5tb3VzZURvd25PYmpQb3MueSA9IHRoaXMuZHJhZ2dlZE9iai5wb3NpdGlvbi55OwoJCQoJCXRoaXMubW91c2VEb3duU3RhZ2VQb3MueCA9IGludGVyYWN0aW9uRGF0YS5nbG9iYWwueDsKCQl0aGlzLm1vdXNlRG93blN0YWdlUG9zLnkgPSBpbnRlcmFjdGlvbkRhdGEuZ2xvYmFsLnk7CgkJaWYoIXRoaXMuYWxsb3dTdGlja3lDbGljayB8fCB0eXBlID09IFRZUEVfVE9VQ0gpLy9pZiBpdCBpcyBhIHRvdWNoIGV2ZW50LCBmb3JjZSBpdCB0byBiZSB0aGUgaGVsZCBkcmFnIHR5cGUKCQl7CgkJCXRoaXMuaXNUb3VjaE1vdmUgPSB0eXBlID09IFRZUEVfVE9VQ0g7CgkJCXRoaXMuaXNIZWxkRHJhZyA9IHRydWU7CgkJCXRoaXMuX3N0YXJ0RHJhZygpOwoJCX0KCQllbHNlLy9vdGhlcndpc2UsIHdhaXQgZm9yIGEgbW92ZW1lbnQgb3IgYSBtb3VzZSB1cCBpbiBvcmRlciB0byBkbyBhIGhlbGQgZHJhZyBvciBhIHN0aWNreSBjbGljayBkcmFnCgkJewoJCQl0aGlzLmRyYWdnZWRPYmoubW91c2Vtb3ZlID0gdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2s7CgkJCXRoaXMuX3RoZVN0YWdlLmludGVyYWN0aW9uTWFuYWdlci5zdGFnZVVwID0gdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2s7CgkJfQoJfTsKCQoJLyoqCgkqIFN0YXJ0IHRoZSBzdGlja3kgY2xpY2sKCSogQG1ldGhvZCBfdHJpZ2dlclN0aWNreUNsaWNrCgkqIEBwcml2YXRlCgkqLwoJcC5fdHJpZ2dlclN0aWNreUNsaWNrID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuaXNTdGlja3lDbGljayA9IHRydWU7CgkJdGhpcy5kcmFnZ2VkT2JqLm1vdXNlbW92ZSA9IG51bGw7CgkJdGhpcy5fdGhlU3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLnN0YWdlVXAgPSBudWxsOwoJCXRoaXMuX3N0YXJ0RHJhZygpOwoJfTsKCgkvKioKCSogU3RhcnQgaG9sZCBkcmFnZ2luZwoJKiBAbWV0aG9kIF90cmlnZ2VySGVsZERyYWcKCSogQHByaXZhdGUKCSogQHBhcmFtIHtQSVhJLkludGVyYWN0aW9uRGF0YX0gaW50ZXJhY3Rpb25EYXRhIFRoZSBpbmVyYWN0aW9uIGRhdGEgYWJvdXQgdGhlIG1vdmVkIG1vdXNlCgkqLwoJcC5fdHJpZ2dlckhlbGREcmFnID0gZnVuY3Rpb24oaW50ZXJhY3Rpb25EYXRhKQoJewoJCXZhciB4RGlmZiA9IGludGVyYWN0aW9uRGF0YS5nbG9iYWwueCAtIHRoaXMubW91c2VEb3duU3RhZ2VQb3MueDsKCQl2YXIgeURpZmYgPSBpbnRlcmFjdGlvbkRhdGEuZ2xvYmFsLnkgLSB0aGlzLm1vdXNlRG93blN0YWdlUG9zLnk7CgkJaWYoeERpZmYgKiB4RGlmZiArIHlEaWZmICogeURpZmYgPj0gdGhpcy5kcmFnU3RhcnRUaHJlc2hvbGQgKiB0aGlzLmRyYWdTdGFydFRocmVzaG9sZCkKCQl7CgkJCXRoaXMuaXNIZWxkRHJhZyA9IHRydWU7CgkJCXRoaXMuZHJhZ2dlZE9iai5tb3VzZW1vdmUgPSBudWxsOwoJCQl0aGlzLl90aGVTdGFnZS5pbnRlcmFjdGlvbk1hbmFnZXIuc3RhZ2VVcCA9IG51bGw7CgkJCXRoaXMuX3N0YXJ0RHJhZygpOwoJCX0KCX07CgoJLyoqCgkqIEludGVybmFsIHN0YXJ0IGRyYWdnaW5nIG9uIHRoZSBzdGFnZQoJKiBAbWV0aG9kIF9zdGFydERyYWcKCSogQHByaXZhdGUgCgkqLwoJcC5fc3RhcnREcmFnID0gZnVuY3Rpb24oKQoJewoJCXZhciBpbSA9IHRoaXMuX3RoZVN0YWdlLmludGVyYWN0aW9uTWFuYWdlcjsKCQlpbS5zdGFnZVVwID0gdGhpcy5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2s7CgkJdGhpcy5kcmFnZ2VkT2JqLm1vdXNlbW92ZSA9IHRoaXMuZHJhZ2dlZE9iai50b3VjaG1vdmUgPSB0aGlzLl91cGRhdGVDYWxsYmFjazsKCQkKCQl0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayh0aGlzLmRyYWdnZWRPYmopOwoJfTsKCQoJLyoqCgkqIFN0b3BzIGRyYWdnaW5nIHRoZSBjdXJyZW50bHkgZHJhZ2dlZCBvYmplY3QuCgkqIEBwdWJsaWMKCSogQG1ldGhvZCBzdG9wRHJhZwoJKiBAcGFyYW0ge0Jvb2x9IGRvQ2FsbGJhY2sgSWYgdGhlIGRyYWcgZW5kIGNhbGxiYWNrIHNob3VsZCBiZSBjYWxsZWQuIERlZmF1bHQgaXMgZmFsc2UuCgkqLwoJcC5zdG9wRHJhZyA9IGZ1bmN0aW9uKGRvQ2FsbGJhY2spCgl7CgkJdGhpcy5fc3RvcERyYWcobnVsbCwgZG9DYWxsYmFjayA9PT0gdHJ1ZSk7Ly9wYXNzIHRydWUgaWYgaXQgd2FzIGV4cGxpY2l0bHkgcGFzc2VkIHRvIHVzLCBmYWxzZSBhbmQgdW5kZWZpbmVkIC0+IGZhbHNlCgl9OwoKCS8qKgoJKiBJbnRlcm5hbCBzdG9wIGRyYWdnaW5nIG9uIHRoZSBzdGFnZQoJKiBAbWV0aG9kIF9zdG9wRHJhZwoJKiBAcHJpdmF0ZSAKCSogQHBhcmFtIHtFdmVudH0gZXYgTW91c2UgdXAgZXZlbnQKCSogQHBhcmFtIHtCb29sfSBkb0NhbGxiYWNrIElmIHdlIHNob3VsZCBkbyB0aGUgY2FsbGJhY2sKCSovCglwLl9zdG9wRHJhZyA9IGZ1bmN0aW9uKG9yaWdNb3VzZUV2LCBkb0NhbGxiYWNrKQoJewoJCWlmKHRoaXMuZHJhZ2dlZE9iaikKCQkJdGhpcy5kcmFnZ2VkT2JqLnRvdWNobW92ZSA9IHRoaXMuZHJhZ2dlZE9iai5tb3VzZW1vdmUgPSBudWxsOwoJCXZhciBpbSA9IHRoaXMuX3RoZVN0YWdlLmludGVyYWN0aW9uTWFuYWdlcjsKCQlpbS5zdGFnZVVwID0gbnVsbDsKCQl2YXIgb2JqID0gdGhpcy5kcmFnZ2VkT2JqOwoJCXRoaXMuZHJhZ2dlZE9iaiA9IG51bGw7CgkJdGhpcy5pc1RvdWNoTW92ZSA9IGZhbHNlOwoJCXRoaXMuaXNTdGlja3lDbGljayA9IGZhbHNlOwoJCXRoaXMuaXNIZWxkTW92ZSA9IGZhbHNlOwoKCQlpZihkb0NhbGxiYWNrICE9PSBmYWxzZSkgLy8gdHJ1ZSBvciB1bmRlZmluZWQKCQkJdGhpcy5fZHJhZ0VuZENhbGxiYWNrKG9iaik7Cgl9OwoKCS8qKgoJKiBVcGRhdGUgdGhlIG9iamVjdCBwb3NpdGlvbiBiYXNlZCBvbiB0aGUgbW91c2UKCSogQG1ldGhvZCBfdXBkYXRlT2JqUG9zaXRpb24KCSogQHByaXZhdGUKCSogQHBhcmFtIHtQSVhJLkludGVyYWN0aW9uRGF0YX0gaW50ZXJhY3Rpb25EYXRhIE1vdXNlIG1vdmUgZXZlbnQKCSovCglwLl91cGRhdGVPYmpQb3NpdGlvbiA9IGZ1bmN0aW9uKGludGVyYWN0aW9uRGF0YSkKCXsKCQlpZighdGhpcy5pc1RvdWNoTW92ZSAmJiAhdGhpcy5fdGhlU3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLm1vdXNlSW5TdGFnZSkgcmV0dXJuOwoJCWlmKCF0aGlzLmRyYWdnZWRPYmogfHwgIXRoaXMuZHJhZ2dlZE9iai5wYXJlbnQpLy9ub3QgcXVpdGUgc3VyZSB3aGF0IGNoYWluIG9mIGV2ZW50cyB3b3VsZCBsZWFkIHRvIHRoaXMsIGJ1dCB3ZSdsbCBzdG9wIGRyYWdnaW5nIHRvIGJlIHNhZmUKCQl7CgkJCXRoaXMuX3N0b3BEcmFnKG51bGwsIGZhbHNlKTsKCQkJcmV0dXJuOwoJCX0KCQkKCQl2YXIgbW91c2VQb3MgPSBpbnRlcmFjdGlvbkRhdGEuZ2V0TG9jYWxQb3NpdGlvbih0aGlzLmRyYWdnZWRPYmoucGFyZW50LCBoZWxwZXJQb2ludCk7CgkJdmFyIGJvdW5kcyA9IHRoaXMuZHJhZ2dlZE9iai5fZHJhZ0JvdW5kczsKCQl0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueCA9IGNsYW1wKG1vdXNlUG9zLnggLSB0aGlzLl9kcmFnT2Zmc2V0LngsIGJvdW5kcy54LCBib3VuZHMucmlnaHQpOwoJCXRoaXMuZHJhZ2dlZE9iai5wb3NpdGlvbi55ID0gY2xhbXAobW91c2VQb3MueSAtIHRoaXMuX2RyYWdPZmZzZXQueSwgYm91bmRzLnksIGJvdW5kcy5ib3R0b20pOwoJCWlmKHRoaXMuc25hcFNldHRpbmdzKQoJCXsKCQkJc3dpdGNoKHRoaXMuc25hcFNldHRpbmdzLm1vZGUpCgkJCXsKCQkJCWNhc2UgInBvaW50cyI6CgkJCQkJdGhpcy5faGFuZGxlUG9pbnRTbmFwKG1vdXNlUG9zKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgImdyaWQiOgoJCQkJCS8vbm90IHlldCBpbXBsZW1lbnRlZAoJCQkJCWJyZWFrOwoJCQkJY2FzZSAibGluZSI6CgkJCQkJLy9ub3QgeWV0IGltcGxlbWVudGVkCgkJCQkJYnJlYWs7CgkJCX0KCQl9Cgl9OwoKCS8qKgoJKiBIYW5kbGVzIHNuYXBwaW5nIHRoZSBkcmFnZ2VkIG9iamVjdCB0byB0aGUgbmVhcmVzdCBhbW9uZyBhIGxpc3Qgb2YgcG9pbnRzCgkqIEBtZXRob2QgX2hhbmRsZVBvaW50U25hcAoJKiBAcHJpdmF0ZQoJKiBAcGFyYW0ge2NyZWF0ZWpzLlBvaW50fSBsb2NhbE1vdXNlUG9zIFRoZSBtb3VzZSBwb3NpdGlvbiBpbiB0aGUgc2FtZSBzcGFjZSBhcyB0aGUgZHJhZ2dlZCBvYmplY3QuCgkqLwoJcC5faGFuZGxlUG9pbnRTbmFwID0gZnVuY3Rpb24obG9jYWxNb3VzZVBvcykKCXsKCQl2YXIgc25hcFNldHRpbmdzID0gdGhpcy5zbmFwU2V0dGluZ3M7CgkJdmFyIG1pbkRpc3RTcSA9IHNuYXBTZXR0aW5ncy5kaXN0ICogc25hcFNldHRpbmdzLmRpc3Q7CgkJdmFyIHBvaW50cyA9IHNuYXBTZXR0aW5ncy5wb2ludHM7CgkJdmFyIG9ialggPSBsb2NhbE1vdXNlUG9zLnggLSB0aGlzLl9kcmFnT2Zmc2V0Lng7CgkJdmFyIG9ialkgPSBsb2NhbE1vdXNlUG9zLnkgLSB0aGlzLl9kcmFnT2Zmc2V0Lnk7CgkJdmFyIGxlYXN0RGlzdCA9IC0xOwoJCXZhciBjbG9zZXN0UG9pbnQgPSBudWxsOwoJCWZvcih2YXIgaSA9IHBvaW50cy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkKCQl7CgkJCXZhciBwID0gcG9pbnRzW2ldOwoJCQl2YXIgZGlzdFNxID0gZGlzdFNxdWFyZWQob2JqWCwgb2JqWSwgcC54LCBwLnkpOwoJCQlpZihkaXN0U3EgPD0gbWluRGlzdFNxICYmIChkaXN0U3EgPCBsZWFzdERpc3QgfHwgbGVhc3REaXN0ID09IC0xKSkKCQkJewoJCQkJbGVhc3REaXN0ID0gZGlzdFNxOwoJCQkJY2xvc2VzdFBvaW50ID0gcDsKCQkJfQoJCX0KCQlpZihjbG9zZXN0UG9pbnQpCgkJewoJCQl0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueCA9IGNsb3Nlc3RQb2ludC54OwoJCQl0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueSA9IGNsb3Nlc3RQb2ludC55OwoJCX0KCX07CgoJLyoKCSogU21hbGwgZGlzdGFuY2Ugc3F1YXJlZCBmdW5jdGlvbgoJKi8KCXZhciBkaXN0U3F1YXJlZCA9IGZ1bmN0aW9uKHgxLCB5MSwgeDIsIHkyKQoJewoJCXZhciB4RGlmZiA9IHgxIC0geDI7CgkJdmFyIHlEaWZmID0geTEgLSB5MjsKCQlyZXR1cm4geERpZmYgKiB4RGlmZiArIHlEaWZmICogeURpZmY7Cgl9OwoJCgkvKioKCSogU2ltcGxlIGNsYW1wIGZ1bmN0aW9uCgkqLwoJdmFyIGNsYW1wID0gZnVuY3Rpb24oeCxhLGIpCgl7CgkJcmV0dXJuICh4IDwgYSA/IGEgOiAoeCA+IGIgPyBiIDogeCkpOwoJfTsKCQoJLy89PT0gR2l2aW5nIGZ1bmN0aW9ucyBhbmQgcHJvcGVydGllcyB0byBkcmFnZ2FibGUgb2JqZWN0cyBvYmplY3RzCgl2YXIgZW5hYmxlRHJhZyA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLm1vdXNlZG93biA9IHRoaXMuX29uTW91c2VEb3duTGlzdGVuZXI7CgkJdGhpcy50b3VjaHN0YXJ0ID0gdGhpcy5fb25Ub3VjaFN0YXJ0TGlzdGVuZXI7CgkJdGhpcy5idXR0b25Nb2RlID0gdGhpcy5pbnRlcmFjdGl2ZSA9IHRydWU7Cgl9OwoJCgl2YXIgZGlzYWJsZURyYWcgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5tb3VzZWRvd24gPSB0aGlzLnRvdWNoc3RhcnQgPSBudWxsOwoJCXRoaXMuYnV0dG9uTW9kZSA9IHRoaXMuaW50ZXJhY3RpdmUgPSBmYWxzZTsKCX07CgkKCXZhciBfb25Nb3VzZURvd24gPSBmdW5jdGlvbih0eXBlLCBtb3VzZURhdGEpCgl7CgkJdGhpcy5fZHJhZ01hbi5fb2JqTW91c2VEb3duKHR5cGUsIHRoaXMsIG1vdXNlRGF0YSk7Cgl9OwoJCgkvKiogCgkqIEFkZHMgcHJvcGVydGllcyBhbmQgZnVuY3Rpb25zIHRvIHRoZSBvYmplY3QgLSB1c2UgZW5hYmxlRHJhZygpIGFuZCBkaXNhYmxlRHJhZygpIG9uIAoJKiBvYmplY3RzIHRvIGVuYWJsZS9kaXNhYmxlIHRoZW0gKHRoZXkgc3RhcnQgb3V0IGRpc2FibGVkKS4gUHJvcGVydGllcyBhZGRlZCB0byBvYmplY3RzOgoJKiBfZHJhZ0JvdW5kcyAoUmVjdGFuZ2xlKSwgX29uTW91c2VEb3duTGlzdGVuZXIgKEZ1bmN0aW9uKSwgX2RyYWdNYW4gKGNsb3Vka2lkLkRyYWdNYW5hZ2VyKSByZWZlcmVuY2UgdG8gdGhlIERyYWdNYW5hZ2VyCgkqIHRoZXNlIHdpbGwgb3ZlcnJpZGUgYW55IGV4aXN0aW5nIHByb3BlcnRpZXMgb2YgdGhlIHNhbWUgbmFtZQoJKiBAbWV0aG9kIGFkZE9iamVjdAoJKiBAcHVibGljCgkqIEBwYXJhbSB7UElYSS5EaXNwbGF5T2JqZWN0fSBvYmogVGhlIGRpc3BsYXkgb2JqZWN0CgkqIEBwYXJhbSB7UElYSS5SZWN0YW5nbGV9IGJvdW5kIFRoZSByZWN0YW5nbGUgYm91bmRzCgkqLwoJcC5hZGRPYmplY3QgPSBmdW5jdGlvbihvYmosIGJvdW5kcykKCXsKCQlpZighYm91bmRzKQoJCXsKCQkJdmFyIGNhbnZhcyA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLl9yZW5kZXJlci52aWV3OwoJCQlib3VuZHMgPSB7eDowLCB5OjAsIHdpZHRoOmNhbnZhcy53aWR0aCwgaGVpZ2h0OmNhbnZhcy5oZWlnaHR9OwoJCX0KCQlib3VuZHMucmlnaHQgPSBib3VuZHMueCArIGJvdW5kcy53aWR0aDsKCQlib3VuZHMuYm90dG9tID0gYm91bmRzLnkgKyBib3VuZHMuaGVpZ2h0OwoJCW9iai5fZHJhZ0JvdW5kcyA9IGJvdW5kczsKCQlpZih0aGlzLl9kcmFnZ2FibGVPYmplY3RzLmluZGV4T2Yob2JqKSA+PSAwKQoJCXsKCQkJLy9kb24ndCBjaGFuZ2UgYW55IG9mIHRoZSBmdW5jdGlvbnMgb3IgYW55dGhpbmcsIGp1c3QgcXVpdCB0aGUgZnVuY3Rpb24gYWZ0ZXIgaGF2aW5nIHVwZGF0ZWQgdGhlIGJvdW5kcwoJCQlyZXR1cm47CgkJfQoJCW9iai5lbmFibGVEcmFnID0gZW5hYmxlRHJhZzsKCQlvYmouZGlzYWJsZURyYWcgPSBkaXNhYmxlRHJhZzsKCQlvYmouX29uTW91c2VEb3duTGlzdGVuZXIgPSBfb25Nb3VzZURvd24uYmluZChvYmosIFRZUEVfTU9VU0UpOwoJCW9iai5fb25Ub3VjaFN0YXJ0TGlzdGVuZXIgPSBfb25Nb3VzZURvd24uYmluZChvYmosIFRZUEVfVE9VQ0gpOwoJCW9iai5fZHJhZ01hbiA9IHRoaXM7CgkJdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5wdXNoKG9iaik7Cgl9OwoJCgkvKiogCgkqIFJlbW92ZXMgcHJvcGVydGllcyBhbmQgZnVuY3Rpb25zIGFkZGVkIGJ5IGFkZE9iamVjdCgpLgoJKiBAcHVibGljCgkqIEBtZXRob2QgcmVtb3ZlT2JqZWN0CgkqIEBwYXJhbSB7UElYSS5EaXNwbGF5T2JqZWN0fSBvYmogVGhlIGRpc3BsYXkgb2JqZWN0CgkqLwoJcC5yZW1vdmVPYmplY3QgPSBmdW5jdGlvbihvYmopCgl7CgkJdmFyIGluZGV4ID0gdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5pbmRleE9mKG9iaik7CgkJaWYoaW5kZXggPj0gMCkKCQl7CgkJCW9iai5kaXNhYmxlRHJhZygpOwoJCQlkZWxldGUgb2JqLmVuYWJsZURyYWc7CgkJCWRlbGV0ZSBvYmouZGlzYWJsZURyYWc7CgkJCWRlbGV0ZSBvYmouX29uTW91c2VEb3duTGlzdGVuZXI7CgkJCWRlbGV0ZSBvYmouX29uVG91Y2hTdGFydExpc3RlbmVyOwoJCQlkZWxldGUgb2JqLl9kcmFnTWFuOwoJCQlkZWxldGUgb2JqLl9kcmFnQm91bmRzOwoJCQl0aGlzLl9kcmFnZ2FibGVPYmplY3RzLnNwbGljZShpbmRleCwgMSk7CgkJfQoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBtYW5hZ2VyCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJaWYodGhpcy5kcmFnZ2VkT2JqICE9PSBudWxsKQoJCXsKCQkJLy9jbGVhbiB1cCBkcmFnZ2VkIG9iagoJCQl0aGlzLl9zdG9wRHJhZyhudWxsLCBmYWxzZSk7CgkJfQoJCXRoaXMuX3VwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayA9IG51bGw7CgkJdGhpcy5fZHJhZ0VuZENhbGxiYWNrID0gbnVsbDsKCQl0aGlzLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayA9IG51bGw7CgkJdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrID0gbnVsbDsKCQl0aGlzLl90aGVTdGFnZSA9IG51bGw7CgkJZm9yKHZhciBpID0gdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkKCQl7CgkJCXZhciBvYmogPSB0aGlzLl9kcmFnZ2FibGVPYmplY3RzW2ldOwoJCQlvYmouZGlzYWJsZURyYWcoKTsKCQkJZGVsZXRlIG9iai5lbmFibGVEcmFnOwoJCQlkZWxldGUgb2JqLmRpc2FibGVEcmFnOwoJCQlkZWxldGUgb2JqLl9vbk1vdXNlRG93bkxpc3RlbmVyOwoJCQlkZWxldGUgb2JqLl9kcmFnTWFuOwoJCQlkZWxldGUgb2JqLl9kcmFnQm91bmRzOwoJCX0KCQl0aGlzLl9kcmFnZ2FibGVPYmplY3RzID0gbnVsbDsKCX07CgkKCS8qKiBBc3NpZ24gdG8gdGhlIGdsb2JhbCBuYW1lc3BhY2UgKi8KCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5EcmFnTWFuYWdlciA9IERyYWdNYW5hZ2VyOwp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCQoJLyoqCgkqICBJbml0aWFsbHkgbGF5b3V0cyBhbGwgaW50ZXJmYWNlIGVsZW1lbnRzCgkqICBAbW9kdWxlIGNsb3Vka2lkCgkqICBAY2xhc3MgUG9zaXRpb25lcgoJKi8KCXZhciBQb3NpdGlvbmVyID0gZnVuY3Rpb24oKXt9OwoJCgkvLyBTZXQgdGhlIHByb3R5cGUKCVBvc2l0aW9uZXIucHJvdG90eXBlID0ge307CgkKCS8qKgoJKiAgSW5pdGlhbCBwb3NpdGlvbiBvZiBhbGwgbGF5b3V0IGl0ZW1zCgkqICBAbWV0aG9kIHBvc2l0aW9uSXRlbXMKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudAoJKiAgQHBhcmFtIHtPYmplY3R9IGl0ZW1TZXR0aW5ncyBKU09OIGZvcm1hdCB3aXRoIHBvc2l0aW9uIGluZm9ybWF0aW9uCgkqLwoJUG9zaXRpb25lci5wb3NpdGlvbkl0ZW1zID0gZnVuY3Rpb24ocGFyZW50LCBpdGVtU2V0dGluZ3MpCgl7CgkJdmFyIHJvdCwgcHQsIGRlZ1RvUmFkOwoJCWlmKHRydWUpCgkJCWRlZ1RvUmFkID0gTWF0aC5QSSAvIDE4MDsKCQlmb3IodmFyIGlOYW1lIGluIGl0ZW1TZXR0aW5ncykKCQl7CgkJCXZhciBpdGVtID0gcGFyZW50W2lOYW1lXTsKCQkJaWYoIWl0ZW0pCgkJCXsKCQkJCURlYnVnLmVycm9yKCJjb3VsZCBub3QgZmluZCBvYmplY3QgJyIgKyAgaU5hbWUgKyAiJyIpOwoJCQkJY29udGludWU7CgkJCX0KCQkJdmFyIHNldHRpbmcgPSBpdGVtU2V0dGluZ3NbaU5hbWVdOwoJCQlpZih0cnVlKQoJCQl7CgkJCQlpdGVtLnBvc2l0aW9uLnggPSBzZXR0aW5nLng7CgkJCQlpdGVtLnBvc2l0aW9uLnkgPSBzZXR0aW5nLnk7CgkJCQlwdCA9IHNldHRpbmcuc2NhbGU7CgkJCQlpZihwdCkKCQkJCXsKCQkJCQlpdGVtLnNjYWxlLnggKj0gcHQueDsKCQkJCQlpdGVtLnNjYWxlLnkgKj0gcHQueTsKCQkJCX0KCQkJCXB0ID0gc2V0dGluZy5waXZvdDsKCQkJCWlmKHB0KQoJCQkJewoJCQkJCWl0ZW0ucGl2b3QueCA9IHB0Lng7CgkJCQkJaXRlbS5waXZvdC55ID0gcHQueTsKCQkJCX0KCQkJCXJvdCA9IHNldHRpbmcucm90YXRpb247CgkJCQlpZihyb3QpCgkJCQkJaXRlbS5yb3RhdGlvbiA9IHJvdCAqIGRlZ1RvUmFkOy8vUGl4aSByb3RhdGlvbnMgYXJlIGluIHJhZGlhbnMKCQkJfQoJCQllbHNlCgkJCXsKCQkJCWl0ZW0ueCA9IHNldHRpbmcueDsKCQkJCWl0ZW0ueSA9IHNldHRpbmcueTsKCQkJCXB0ID0gc2V0dGluZy5zY2FsZTsKCQkJCWlmKHB0KQoJCQkJewoJCQkJCWl0ZW0uc2NhbGVYICo9IHB0Lng7CgkJCQkJaXRlbS5zY2FsZVkgKj0gcHQueTsKCQkJCX0KCQkJCXB0ID0gc2V0dGluZy5waXZvdDsKCQkJCWlmKHB0KQoJCQkJewoJCQkJCWl0ZW0ucmVnWCA9IHB0Lng7CgkJCQkJaXRlbS5yZWdZID0gcHQueTsKCQkJCX0KCQkJCXJvdCA9IHNldHRpbmcucm90YXRpb247CgkJCQlpZihyb3QpCgkJCQkJaXRlbS5yb3RhdGlvbiA9IHJvdDsKCQkJfQoJCQkvL2l0ZW0ubmFtZSA9IGlOYW1lOwoJCQlpZihzZXR0aW5nLmhpdEFyZWEpCgkJCXsKCQkJCXZhciBoaXRBcmVhID0gc2V0dGluZy5oaXRBcmVhOwoJCQkJaWYodHJ1ZSkKCQkJCXsKCQkJCQlpdGVtLmhpdEFyZWEgPSBQb3NpdGlvbmVyLmdlbmVyYXRlSGl0QXJlYShoaXRBcmVhKTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQlpdGVtLmhpdFNoYXBlID0gUG9zaXRpb25lci5nZW5lcmF0ZUhpdEFyZWEoaGl0QXJlYSk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoJCgkvKioKCSogIENyZWF0ZSB0aGUgcG9seWdvbiBoaXQgYXJlYSBmb3IgaW50ZXJmYWNlIGVsZW1lbnRzCgkqICBAc3RhdGljCgkqICBAbWV0aG9kIGdlbmVyYXRlSGl0QXJlYQoJKiAgQHBhcmFtIHtPYmplY3R8QXJyYXl9IGhpdEFyZWEgT25lIG9mIHRoZSBmb2xsb3dpbmc6IDxici8+CgkqICAqIEFuIGFycmF5IG9mIHBvaW50cyBmb3IgYSBwb2x5Z29uLCBlLmcuIAoJKgoJKgkJW3t4OjAsIHk6MH0sIHt4OjAsIHk6MjB9LCB7eDoyMCwgeTowfV0KCSoKCSogICogQW4gb2JqZWN0IGRlc2NyaWJpbmcgYSByZWN0YW5nbGUsIGUuZy4KCSoKCSoJCXt0eXBlOiJyZWN0IiwgeDowLCB5OjAsIHc6MTAsIGg6MzB9CgkqCgkqICAqIEFuIG9iamVjdCBkZXNjcmliaW5nIGFuIGVsbGlwc2UsIHdoZXJlIHggYW5kIHkgYXJlIHRoZSBjZW50ZXIsIGUuZy4gCgkqCgkqCQl7dHlwZToiZWxsaXBzZSIsIHg6MCwgeTowLCB3OjEwLCBoOjMwfQoJKgoJKiAgKiBBbiBvYmplY3QgZGVzY3JpYmluZyBhIGNpcmNsZSwgd2hlcmUgeCBhbmQgeSBhcmUgdGhlIGNlbnRlciwgZS5nLgoJKgoJKgkJe3R5cGU6ImNpcmNsZSIsIHg6MCwgeTowLCByOjIwfQoJKiAgQHBhcmFtIHtOdW1iZXJ9IHNjYWxlPTEgVGhlIHNpemUgdG8gc2NhbGUgaGl0QXJlYSBieQoJKiAgQHJldHVybiB7T2JqZWN0fSBBIGdlb21ldHJpYyBzaGFwZSBvYmplY3QgZm9yIGhpdCB0ZXN0aW5nLCBlaXRoZXIgYSBQb2x5Z29uLCBSZWN0YW5nbGUsIEVsbGlwc2UsIG9yIENpcmNsZSwKCSogICAgICBkZXBlbmRpbmcgb24gdGhlIGhpdEFyZWEgb2JqZWN0LiBUaGUgc2hhcGUgd2lsbCBoYXZlIGEgY29udGFpbnMoKSBmdW5jdGlvbiBmb3IgaGl0IHRlc3RpbmcuCgkqLwoJUG9zaXRpb25lci5nZW5lcmF0ZUhpdEFyZWEgPSBmdW5jdGlvbihoaXRBcmVhLCBzY2FsZSkKCXsKCQlpZighc2NhbGUpCgkJCXNjYWxlID0gMTsKCQl2YXIgbGlicmFyeTsKCQlpZih0cnVlKQoJCQlsaWJyYXJ5ID0gd2luZG93LlBJWEk7CgkJZWxzZQoJCQlsaWJyYXJ5ID0gd2luZG93LmNyZWF0ZWpzOwoJCWlmKGlzQXJyYXkoaGl0QXJlYSkpCgkJewoJCQlpZihzY2FsZSA9PSAxKQoJCQkJcmV0dXJuIG5ldyBsaWJyYXJ5LlBvbHlnb24oaGl0QXJlYSk7CgkJCWVsc2UKCQkJewoJCQkJdmFyIHRlbXAgPSBbXTsKCQkJCWZvcih2YXIgaSA9IDAsIGxlbiA9IGhpdEFyZWEubGVuZ3RoOyBpIDwgbGVuOyArK2kpCgkJCQl7CgkJCQkJdGVtcC5wdXNoKG5ldyBsaWJyYXJ5LlBvaW50KGhpdEFyZWFbaV0ueCAqIHNjYWxlLCBoaXRBcmVhW2ldLnkgKiBzY2FsZSkpOwoJCQkJfQoJCQkJcmV0dXJuIG5ldyBsaWJyYXJ5LlBvbHlnb24odGVtcCk7CgkJCX0KCQl9CgkJZWxzZSBpZihoaXRBcmVhLnR5cGUgPT0gInJlY3QiIHx8ICFoaXRBcmVhLnR5cGUpCgkJCXJldHVybiBuZXcgbGlicmFyeS5SZWN0YW5nbGUoaGl0QXJlYS54ICogc2NhbGUsIGhpdEFyZWEueSAqIHNjYWxlLCBoaXRBcmVhLncgKiBzY2FsZSwgaGl0QXJlYS5oICogc2NhbGUpOwoJCWVsc2UgaWYoaGl0QXJlYS50eXBlID09ICJlbGxpcHNlIikKCQkJcmV0dXJuIG5ldyBsaWJyYXJ5LkVsbGlwc2UoKGhpdEFyZWEueCAtIGhpdEFyZWEudyAqIDAuNSkgKiBzY2FsZSwgKGhpdEFyZWEueSAtIGhpdEFyZWEuaCAqIDAuNSkgKiBzY2FsZSwgaGl0QXJlYS53ICogc2NhbGUsIGhpdEFyZWEuaCAqIHNjYWxlKTsvL2NvbnZlcnQgY2VudGVyIHRvIHVwcGVyIGxlZnQgY29ybmVyCgkJZWxzZSBpZihoaXRBcmVhLnR5cGUgPT0gImNpcmNsZSIpCgkJCXJldHVybiBuZXcgbGlicmFyeS5DaXJjbGUoaGl0QXJlYS54ICogc2NhbGUsIGhpdEFyZWEueSAqIHNjYWxlLCBoaXRBcmVhLnIgKiBzY2FsZSk7Ly94ICYgeSBhcmUgY2VudGVyLCBwaXhpIGRvY3VtZW50YXRpb24gbGllcwoJCWVsc2UgaWYoaGl0QXJlYS50eXBlID09ICJzZWN0b3IiKQoJCQlyZXR1cm4gbmV3IGxpYnJhcnkuU2VjdG9yKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS5yICogc2NhbGUsIGhpdEFyZWEuc3RhcnQsIGhpdEFyZWEuZW5kKTsKCQlyZXR1cm4gbnVsbDsKCX07CgoJdmFyIGlzQXJyYXkgPSBmdW5jdGlvbihvKQoJewoJCXJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobykgPT09ICdbb2JqZWN0IEFycmF5XSc7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuUG9zaXRpb25lciA9IFBvc2l0aW9uZXI7Cn0oKSk7CihmdW5jdGlvbigpIHsKCQoJInVzZSBzdHJpY3QiOwoKCS8qKgoJKiAgIE9iamVjdCB0aGF0IGNvbnRhaW5zIHRoZSBzY3JlZW4gc2V0dGluZ3MgdG8gaGVscCBzY2FsaW5nCgkqICAgQG1vZHVsZSBjbG91ZGtpZAoJKiAgIEBjbGFzcyBTY3JlZW5TZXR0aW5ncwoJKiAgIEBjb25zdHJ1Y3RvcgoJKiAgIEBwYXJhbSB7TnVtYmVyfSB3aWR0aCBUaGUgc2NyZWVuIHdpZHRoIGluIHBpeGVscwoJKiAgIEBwYXJhbSB7TnVtYmVyfSBoZWlnaHQgVGhlIHNjcmVlbiBoZWlnaHQgaW4gcGl4ZWxzCgkqICAgQHBhcmFtIHtOdW1iZXJ9IHBwaSBUaGUgc2NyZWVuIHBpeGVsIGRlbnNpdHkgKFBQSSkKCSovCgl2YXIgU2NyZWVuU2V0dGluZ3MgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0LCBwcGkpCgl7CgkJLyoqCgkJKiAgVGhlIHNjcmVlbiB3aWR0aCBpbiBwaXhlbHMKCQkqICBAcHJvcGVydHkge051bWJlcn0gd2lkdGggCgkJKi8KCQl0aGlzLndpZHRoID0gd2lkdGg7CgoJCS8qKgoJCSogIFRoZSBzY3JlZW4gaGVpZ2h0IGluIHBpeGVscwoJCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBoZWlnaHQgCgkJKi8KCQl0aGlzLmhlaWdodCA9IGhlaWdodDsKCgkJLyoqCgkJKiAgVGhlIHNjcmVlbiBwaXhlbCBkZW5zaXR5IChQUEkpCgkJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IHBwaQoJCSovCgkJdGhpcy5wcGkgPSBwcGk7Cgl9OwoJCgkvLyBTZXQgdGhlIHByb3RvdHlwZQoJU2NyZWVuU2V0dGluZ3MucHJvdG90eXBlID0ge307CgkKCS8vIEFzc2lnbiB0byBuYW1lc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5TY3JlZW5TZXR0aW5ncyA9IFNjcmVlblNldHRpbmdzOwoKfSgpKTsKKGZ1bmN0aW9uKCkgewoKCSJ1c2Ugc3RyaWN0IjsKCgkvLyBDbGFzcyBpbXBvcnRzCgl2YXIgVUlTY2FsZXI7CgoJLyoqCgkqICAgQSBzaW5nbGUgVUkgaXRlbSB0aGF0IG5lZWRzIHRvIGJlIHJlc2l6ZWQJCgkqCgkqICAgQG1vZHVsZSBjbG91ZGtpZAoJKiAgIEBjbGFzcyBVSUVsZW1lbnQKCSoJQHBhcmFtIHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fFBJWEkuRGlzcGxheU9iamVjdH0gaXRlbSBUaGUgaXRlbSB0byBhZmZlY3QgIAoJKiAgIEBwYXJhbSB7VUlFbGVtZW50U2V0dGluZ3N9IHNldHRpbmdzIFRoZSBzY2FsZSBzZXR0aW5ncwoJKglAcGFyYW0ge1NjcmVlblNldHRpbmdzfSBkZXNpZ25lZFNjcmVlbiBUaGUgb3JpZ2luYWwgc2NyZWVuIHRoZSBpdGVtIHdhcyBkZXNpZ25lZCBmb3IKCSovCgl2YXIgVUlFbGVtZW50ID0gZnVuY3Rpb24oaXRlbSwgc2V0dGluZ3MsIGRlc2lnbmVkU2NyZWVuKQoJewoJCVVJU2NhbGVyID0gY2xvdWRraWQuVUlTY2FsZXI7CgkJCgkJdGhpcy5faXRlbSA9IGl0ZW07CQkJCgkJdGhpcy5fc2V0dGluZ3MgPSBzZXR0aW5nczsKCQl0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IGRlc2lnbmVkU2NyZWVuOwoJCQoJCWlmKHRydWUpCgkJewoJCQl0aGlzLm9yaWdTY2FsZVggPSBpdGVtLnNjYWxlLng7CQoJCQl0aGlzLm9yaWdTY2FsZVkgPSBpdGVtLnNjYWxlLnk7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMub3JpZ1NjYWxlWCA9IGl0ZW0uc2NhbGVYOwoJCQl0aGlzLm9yaWdTY2FsZVkgPSBpdGVtLnNjYWxlWTsKCQl9CgoJCXRoaXMub3JpZ1dpZHRoID0gaXRlbS53aWR0aDsKCgkJdGhpcy5vcmlnQm91bmRzID0ge3g6MCwgeTowLCB3aWR0aDppdGVtLndpZHRoLCBoZWlnaHQ6aXRlbS5oZWlnaHR9OwoJCXRoaXMub3JpZ0JvdW5kcy5yaWdodCA9IHRoaXMub3JpZ0JvdW5kcy54ICsgdGhpcy5vcmlnQm91bmRzLndpZHRoOwoJCXRoaXMub3JpZ0JvdW5kcy5ib3R0b20gPSB0aGlzLm9yaWdCb3VuZHMueSArIHRoaXMub3JpZ0JvdW5kcy5oZWlnaHQ7CgkJCgkJc3dpdGNoKHNldHRpbmdzLnZlcnRBbGlnbikKCQl7CgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fVE9QOgoJCQl7CgkJCQlpZih0cnVlKQoJCQkJCXRoaXMub3JpZ01hcmdpblZlcnQgPSBpdGVtLnBvc2l0aW9uLnkgKyB0aGlzLm9yaWdCb3VuZHMueTsKCQkJCWVsc2UKCQkJCQl0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gaXRlbS55ICsgdGhpcy5vcmlnQm91bmRzLnk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKCQkJewoJCQkJaWYodHJ1ZSkKCQkJCQl0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gZGVzaWduZWRTY3JlZW4uaGVpZ2h0ICogMC41IC0gaXRlbS5wb3NpdGlvbi55OwoJCQkJZWxzZQoJCQkJCXRoaXMub3JpZ01hcmdpblZlcnQgPSBkZXNpZ25lZFNjcmVlbi5oZWlnaHQgKiAwLjUgLSBpdGVtLnk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0JPVFRPTToKCQkJewoJCQkJaWYodHJ1ZSkKCQkJCQl0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gZGVzaWduZWRTY3JlZW4uaGVpZ2h0IC0gKGl0ZW0ucG9zaXRpb24ueSArIHRoaXMub3JpZ0JvdW5kcy5ib3R0b20pOwoJCQkJZWxzZQoJCQkJCXRoaXMub3JpZ01hcmdpblZlcnQgPSBkZXNpZ25lZFNjcmVlbi5oZWlnaHQgLSAoaXRlbS55ICsgdGhpcy5vcmlnQm91bmRzLmJvdHRvbSk7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJc3dpdGNoKHNldHRpbmdzLmhvcmlBbGlnbikKCQl7CgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fTEVGVDoKCQkJewoJCQkJaWYodHJ1ZSkKCQkJCQl0aGlzLm9yaWdNYXJnaW5Ib3JpID0gaXRlbS5wb3NpdGlvbi54ICsgdGhpcy5vcmlnQm91bmRzLng7CgkJCQllbHNlCgkJCQkJdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGl0ZW0ueCArIHRoaXMub3JpZ0JvdW5kcy54OwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSBVSVNjYWxlci5BTElHTl9DRU5URVI6CgkJCXsKCQkJCWlmKHRydWUpCgkJCQkJdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGRlc2lnbmVkU2NyZWVuLndpZHRoICogMC41IC0gaXRlbS5wb3NpdGlvbi54OwoJCQkJZWxzZQoJCQkJCXRoaXMub3JpZ01hcmdpbkhvcmkgPSBkZXNpZ25lZFNjcmVlbi53aWR0aCAqIDAuNSAtIGl0ZW0ueDsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fUklHSFQ6CgkJCXsKCQkJCWlmKHRydWUpCgkJCQkJdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGRlc2lnbmVkU2NyZWVuLndpZHRoIC0gKGl0ZW0ucG9zaXRpb24ueCArIHRoaXMub3JpZ0JvdW5kcy5yaWdodCk7CgkJCQllbHNlCgkJCQkJdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGRlc2lnbmVkU2NyZWVuLndpZHRoIC0gKGl0ZW0ueCArIHRoaXMub3JpZ0JvdW5kcy5yaWdodCk7CgkJCQlicmVhazsKCQkJfQoJCX0KCX07CgkKCXZhciBwID0gVUlFbGVtZW50LnByb3RvdHlwZSA9IHt9OwoKCS8qKgoJKiAgT3JpZ2luYWwgaG9yaXpvbnRhbCBtYXJnaW4gaW4gcGl4ZWxzCgkqICBAcHJvcGVydHkge051bWJlcn0gb3JpZ01hcmdpbkhvcmkKCSogIEBkZWZhdWx0IDAKCSovCglwLm9yaWdNYXJnaW5Ib3JpID0gMDsKCgkvKioKCSogIE9yaWdpbmFsIHZlcnRpY2FsIG1hcmdpbiBpbiBwaXhlbHMKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBvcmlnTWFyZ2luVmVydAoJKiAgQGRlZmF1bHQgMAoJKi8KCXAub3JpZ01hcmdpblZlcnQgPSAwOwoKCS8qKiAKCSogIE9yaWdpbmFsIHdpZHRoIGluIHBpeGVscyAKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBvcmlnV2lkdGgKCSogIEBkZWZhdWx0IDAKCSovCglwLm9yaWdXaWR0aCA9IDA7CgoJLyoqCgkqICBPcmlnaW5hbCBYIHNjYWxlIG9mIHRoZSBpdGVtCgkqICBAcHJvcGVydHkge051bWJlcn0gb3JpZ1NjYWxlWAoJKiAgQGRlZmF1bHQgMAoJKi8KCXAub3JpZ1NjYWxlWCA9IDA7CgoJLyoqCgkqICBUaGUgb3JpZ2luYWwgWSBzY2FsZSBvZiB0aGUgaXRlbQoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IG9yaWdTY2FsZVkKCSogIEBkZWZhdWx0IDAKCSovCglwLm9yaWdTY2FsZVkgPSAwOwoKCS8qKgoJKiAgVGhlIG9yaWdpbmFsIGJvdW5kcyBvZiB0aGUgaXRlbSB3aXRoIHgsIHksIHJpZ2h0LCBib3R0b20sIHdpZHRoLCBoZWlnaHQgcHJvcGVydGllcy4KCSogIFVzZWQgdG8gZGV0ZXJtaW5lIHRoZSBkaXN0YW5jZSB0byBlYWNoIGVkZ2Ugb2YgdGhlIGl0ZW0gZnJvbSBpdHMgb3JpZ2luCgkqICBAcHJvcGVydHkge09iamVjdH0gb3JpZ0JvdW5kcwoJKi8KCXAub3JpZ0JvdW5kcyA9IG51bGw7CgoJLyoqCgkqICBUaGUgcmVmZXJlbmNlIHRvIHRoZSBzY2FsZSBzZXR0aW5ncwoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7VUlFbGVtZW50U2V0dGluZ3N9IF9zZXR0aW5ncwoJKi8JCglwLl9zZXR0aW5ncyA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJmYWNlIGl0ZW0gd2UncmUgc2NhbGluZwoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IF9pdGVtCgkqLwoJcC5faXRlbSA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIG9yaWdpbmFsIHNjcmVlbiB0aGUgaXRlbSB3YXMgZGVzaWduZWQgZm9yCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtTY3JlZW5TZXR0aW5nc30gX2Rlc2lnbmVkU2NyZWVuCgkqLwoJcC5fZGVzaWduZWRTY3JlZW4gPSBudWxsOwoJCgkvKioKCSogIEFkanVzdCB0aGUgaXRlbSBzY2FsZSBhbmQgcG9zaXRpb24sIHRvIHJlZmxlY3QgbmV3IHNjcmVlbgoJKiAgQG1ldGhvZCByZXNpemUKCSogIEBwYXJhbSB7U2NyZWVuU2V0dGluZ3N9IG5ld1NjcmVlbiBUaGUgY3VycmVudCBzY3JlZW4gc2V0dGluZ3MKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKG5ld1NjcmVlbikKCXsKCQl2YXIgb3ZlcmFsbFNjYWxlID0gbmV3U2NyZWVuLmhlaWdodCAvIHRoaXMuX2Rlc2lnbmVkU2NyZWVuLmhlaWdodDsKCQl2YXIgcHBpU2NhbGUgPSBuZXdTY3JlZW4ucHBpIC8gdGhpcy5fZGVzaWduZWRTY3JlZW4ucHBpOwoJCXZhciBsZXR0ZXJCb3hXaWR0aCA9IChuZXdTY3JlZW4ud2lkdGggLSB0aGlzLl9kZXNpZ25lZFNjcmVlbi53aWR0aCAqIG92ZXJhbGxTY2FsZSkgLyAyOwoKCQkvLyBTY2FsZSBpdGVtIHRvIHRoZSBvdmVyYWxsU2NhbGUgdG8gbWF0Y2ggcmVzdCBvZiB0aGUgYXBwLCAKCQkvLyB0aGVuIGNsYW1wIGl0cyBwaHlzaWNhbCBzaXplIGFzIHNwZWNpZmllZCAKCQkvLyB0aGVuIHNldCB0aGUgaXRlbSdzIHNjYWxlIHRvIGJlIGNvcnJlY3QgLSB0aGUgc2NyZWVuIGlzIG5vdCBzY2FsZWQKCgkJLy9GdWxsIG1hdGg6CgkJLyp2YXIgcGh5c2ljYWxTY2FsZTpOdW1iZXIgPSBvdmVyYWxsU2NhbGUgLyBwcGlTY2FsZTsKCQl2YXIgaXRlbVNjYWxlOk51bWJlciA9IE1hdGhVdGlscy5jbGFtcChwaHlzaWNhbFNjYWxlLCBtaW5TY2FsZSwgbWF4U2NhbGUpIC8gcGh5c2ljYWxTY2FsZSAqIG92ZXJhbGxTY2FsZTsqLwoKCQkvL09wdGltaXplZCBtYXRoOgoJCXZhciBpdGVtU2NhbGUgPSBvdmVyYWxsU2NhbGUgLyBwcGlTY2FsZTsKCQlpZih0aGlzLl9zZXR0aW5ncy5taW5TY2FsZSAmJiBpdGVtU2NhbGUgPCB0aGlzLl9zZXR0aW5ncy5taW5TY2FsZSkKCQkJaXRlbVNjYWxlID0gdGhpcy5fc2V0dGluZ3MubWluU2NhbGU7CgkJZWxzZSBpZih0aGlzLl9zZXR0aW5ncy5tYXhTY2FsZSAmJiBpdGVtU2NhbGUgPiB0aGlzLl9zZXR0aW5ncy5tYXhTY2FsZSkKCQkJaXRlbVNjYWxlID0gdGhpcy5fc2V0dGluZ3MubWF4U2NhbGU7CgkJaXRlbVNjYWxlICo9IHBwaVNjYWxlOwoKCQlpZih0cnVlKQoJCXsKCQkJdGhpcy5faXRlbS5zY2FsZS54ID0gdGhpcy5vcmlnU2NhbGVYICogaXRlbVNjYWxlOwoJCQl0aGlzLl9pdGVtLnNjYWxlLnkgPSB0aGlzLm9yaWdTY2FsZVkgKiBpdGVtU2NhbGU7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuX2l0ZW0uc2NhbGVYID0gdGhpcy5vcmlnU2NhbGVYICogaXRlbVNjYWxlOwoJCQl0aGlzLl9pdGVtLnNjYWxlWSA9IHRoaXMub3JpZ1NjYWxlWSAqIGl0ZW1TY2FsZTsKCQl9CgoJCS8vIHBvc2l0aW9uaW5nCgkJdmFyIG07CgoJCS8vIHZlcnRpY2FsIG1vdmUKCQltID0gdGhpcy5vcmlnTWFyZ2luVmVydCAqIG92ZXJhbGxTY2FsZTsKCQkKCQkKCQlzd2l0Y2godGhpcy5fc2V0dGluZ3MudmVydEFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9UT1A6CgkJCXsKCQkJCWlmKHRydWUpCgkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gbSAtIHRoaXMub3JpZ0JvdW5kcy55ICogaXRlbVNjYWxlOwoJCQkJZWxzZQoJCQkJCXRoaXMuX2l0ZW0ueSA9IG0gLSB0aGlzLm9yaWdCb3VuZHMueSAqIGl0ZW1TY2FsZTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOgoJCQl7CgkJCQlpZih0cnVlKQoJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueSA9IG5ld1NjcmVlbi5oZWlnaHQgKiAwLjUgLSBtOwoJCQkJZWxzZQoJCQkJCXRoaXMuX2l0ZW0ueSA9IG5ld1NjcmVlbi5oZWlnaHQgKiAwLjUgLSBtOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSBVSVNjYWxlci5BTElHTl9CT1RUT006CgkJCXsKCQkJCWlmKHRydWUpCgkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gbmV3U2NyZWVuLmhlaWdodCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMuYm90dG9tICogaXRlbVNjYWxlOwoJCQkJZWxzZQoJCQkJCXRoaXMuX2l0ZW0ueSA9IG5ld1NjcmVlbi5oZWlnaHQgLSBtIC0gdGhpcy5vcmlnQm91bmRzLmJvdHRvbSAqIGl0ZW1TY2FsZTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQkvLyBob3Jpem9udGFsIG1vdmUKCQltID0gdGhpcy5vcmlnTWFyZ2luSG9yaSAqIG92ZXJhbGxTY2FsZTsKCQkKCQlzd2l0Y2godGhpcy5fc2V0dGluZ3MuaG9yaUFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9MRUZUOgoJCQl7CgkJCQlpZih0aGlzLl9zZXR0aW5ncy50aXRsZVNhZmUpCgkJCQl7CgkJCQkJaWYodHJ1ZSkKCQkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gbGV0dGVyQm94V2lkdGggKyBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGU7CgkJCQkJZWxzZQoJCQkJCQl0aGlzLl9pdGVtLnggPSBsZXR0ZXJCb3hXaWR0aCArIG0gLSB0aGlzLm9yaWdCb3VuZHMueCAqIGl0ZW1TY2FsZTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQlpZih0cnVlKQoJCQkJCQl0aGlzLl9pdGVtLnBvc2l0aW9uLnggPSBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGU7CgkJCQkJZWxzZQoJCQkJCQl0aGlzLl9pdGVtLnggPSBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGU7CgkJCQl9CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKCQkJewoJCQkJaWYodGhpcy5fc2V0dGluZ3MuY2VudGVyZWRIb3Jpem9udGFsbHkpCgkJCQl7CgkJCQkJaWYodHJ1ZSkKCQkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2l0ZW0ud2lkdGgpICogMC41OwoJCQkJCWVsc2UKCQkJCQkJdGhpcy5faXRlbS54ID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2l0ZW0ud2lkdGgpICogMC41OwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCWlmKHRydWUpCgkJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueCA9IG5ld1NjcmVlbi53aWR0aCAqIDAuNSAtIG07CgkJCQkJZWxzZQoJCQkJCQl0aGlzLl9pdGVtLnggPSBuZXdTY3JlZW4ud2lkdGggKiAwLjUgLSBtOwoJCQkJfQoJCQkJYnJlYWs7CgkJCX0JCgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fUklHSFQ6CgkJCXsKCQkJCWlmKHRoaXMuX3NldHRpbmdzLnRpdGxlU2FmZSkKCQkJCXsKCQkJCQlpZih0cnVlKQoJCQkJCQl0aGlzLl9pdGVtLnBvc2l0aW9uLnggPSBuZXdTY3JlZW4ud2lkdGggLSBsZXR0ZXJCb3hXaWR0aCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMucmlnaHQgKiBpdGVtU2NhbGU7CgkJCQkJZWxzZQoJCQkJCQl0aGlzLl9pdGVtLnggPSBuZXdTY3JlZW4ud2lkdGggLSBsZXR0ZXJCb3hXaWR0aCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMucmlnaHQgKiBpdGVtU2NhbGU7CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJaWYodHJ1ZSkKCQkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gbmV3U2NyZWVuLndpZHRoIC0gbSAtIHRoaXMub3JpZ0JvdW5kcy5yaWdodCAqIGl0ZW1TY2FsZTsKCQkJCQllbHNlCgkJCQkJCXRoaXMuX2l0ZW0ueCA9IG5ld1NjcmVlbi53aWR0aCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMucmlnaHQgKiBpdGVtU2NhbGU7CgkJCQl9CgkJCQlicmVhazsKCQkJfQkJCgkJfQoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoaXMgaXRlbSwgZG9uJ3QgdXNlIGFmdGVyIHRoaXMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLm9yaWdCb3VuZHMgPSBudWxsOwoJCXRoaXMuX2l0ZW0gPSBudWxsOwoJCXRoaXMuX3NldHRpbmdzID0gbnVsbDsKCQl0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuVUlFbGVtZW50ID0gVUlFbGVtZW50Owp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIFRoZSBVSSBJdGVtIFNldHRpbmdzIHdoaWNoIGlzIHRoZSBwb3NpdGlvbmluZyBzZXR0aW5ncyB1c2VkIHRvIGFkanVzdCBlYWNoIGVsZW1lbnQKCSogIEBtb2R1bGUgY2xvdWRraWQKCSogIEBjbGFzcyBVSUVsZW1lbnRTZXR0aW5ncwoJKi8KCXZhciBVSUVsZW1lbnRTZXR0aW5ncyA9IGZ1bmN0aW9uKCl7fTsKCQoJLy8gUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUKCXZhciBwID0gVUlFbGVtZW50U2V0dGluZ3MucHJvdG90eXBlID0ge307CgkKCS8qKiAKCSogIFdoYXQgdmVydGljYWwgc2NyZWVuIGxvY2F0aW9uIHRoZSBpdGVtIHNob3VsZCBiZSBhbGlnbmVkIHRvOiAidG9wIiwgImNlbnRlciIsICJib3R0b20iCgkqICBAcHJvcGVydHkge1N0cmluZ30gdmVydEFsaWduCgkqLwoJcC52ZXJ0QWxpZ24gPSBudWxsOwoKCS8qKiAKCSogIFdoYXQgaG9yaXpvbnRhbCBzY3JlZW4gbG9jYXRpb24gdGhlIGl0ZW0gc2hvdWxkIGJlIGFsaWduZWQgdG86ICJsZWZ0IiwgImNlbnRlciIsICJyaWdodCIKCSogIEBwcm9wZXJ0eSB7U3RyaW5nfSBob3JpQWxpZ24KCSovCglwLmhvcmlBbGlnbiA9IG51bGw7CgoJLyoqIAoJKiAgSWYgdGhpcyBlbGVtZW50IHNob3VsZCBiZSBhbGlnbmVkIHRvIHRoZSB0aXRsZSBzYWZlIGFyZWEsIG5vdCB0aGUgYWN0dWFsIHNjcmVlbiAKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gdGl0bGVTYWZlCgkqICBAZGVmYXVsdCBmYWxzZQoJKi8KCXAudGl0bGVTYWZlID0gZmFsc2U7CgoJLyoqIAoJKiAgTWF4aW11bSBzY2FsZSBhbGxvd2VkIGluIHBoeXNpY2FsIHNpemUgCgkqICBAcHJvcGVydHkge051bWJlcn0gbWF4U2NhbGUKCSogIEBkZWZhdWx0IDEKCSovCglwLm1heFNjYWxlID0gMTsKCgkvKiogCgkqICBNaW5pbXVtIHNjYWxlIGFsbG93ZWQgaW4gcGh5c2ljYWwgc2l6ZSAKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBtaW5TY2FsZQoJKiAgQGRlZmF1bHQgMQoJKi8KCXAubWluU2NhbGUgPSAxOwoJCgkvKioKCSogIElmIHRoZSBVSSBlbGVtZW50IGlzIGNlbnRlcmVkIGhvcml6b250YWxseQoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBjZW50ZXJlZEhvcml6b250YWxseQoJKiAgQGRlZmF1bHQgZmFsc2UKCSovCglwLmNlbnRlcmVkSG9yaXpvbnRhbGx5ID0gZmFsc2U7CgkKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5VSUVsZW1lbnRTZXR0aW5ncyA9IFVJRWxlbWVudFNldHRpbmdzOwp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvLyBDbGFzcyBpbXBvcnRzCgl2YXIgVUlFbGVtZW50U2V0dGluZ3MgPSBjbG91ZGtpZC5VSUVsZW1lbnRTZXR0aW5ncywKCQlVSUVsZW1lbnQgPSBjbG91ZGtpZC5VSUVsZW1lbnQsCgkJU2NyZWVuU2V0dGluZ3MgPSBjbG91ZGtpZC5TY3JlZW5TZXR0aW5nczsKCgkvKioKCSogICBUaGUgVUkgc2NhbGUgaXMgcmVzcG9uc2libGUgZm9yIHNjYWxpbmcgVUkgY29tcG9uZW50cwoJKiAgIHRvIGhlbHAgZWFzeSB0aGUgYnVyZGVuIG9mIGRpZmZlcmVudCBkZXZpY2UgYXNwZWN0IHJhdGlvcwoJKgoJKiAgQG1vZHVsZSBjbG91ZGtpZAoJKiAgQGNsYXNzIFVJU2NhbGVyCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudCBUaGUgVUkgZGlzcGxheSBjb250YWluZXIKCSogIEBwYXJhbSB7TnVtYmVyfSBkZXNpZ25lZFdpZHRoIFRoZSBkZXNpZ25lZCB3aWR0aCBvZiB0aGUgVUkKCSogIEBwYXJhbSB7TnVtYmVyfSBkZXNpZ25lZEhlaWdodCBUaGUgZGVzaWduZWQgaGVpZ2h0IG9mIHRoZSBVSQoJKiAgQHBhcmFtIHtOdW1iZXJ9IGRlc2lnbmVkUFBJIFRoZSBkZXNpZ25lZCBQUEkgb2YgdGhlIFVJCgkqLwoJdmFyIFVJU2NhbGVyID0gZnVuY3Rpb24ocGFyZW50LCBkZXNpZ25lZFdpZHRoLCBkZXNpZ25lZEhlaWdodCwgZGVzaWduZWRQUEkpCgl7CgkJdGhpcy5fcGFyZW50ID0gcGFyZW50OwoJCXRoaXMuX2l0ZW1zID0gW107CgkJdGhpcy5fZGVzaWduZWRTY3JlZW4gPSBuZXcgU2NyZWVuU2V0dGluZ3MoZGVzaWduZWRXaWR0aCwgZGVzaWduZWRIZWlnaHQsIGRlc2lnbmVkUFBJKTsKCX07CgkKCS8vIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlCgl2YXIgcCA9IFVJU2NhbGVyLnByb3RvdHlwZSA9IHt9OwoJCQkJCgkvKiogCgkqICBUaGUgY3VycmVudCBzY3JlZW4gc2V0dGluZ3MgCgkqICBAcHJvcGVydHkge1NjcmVlblNldHRpbmdzfSBjdXJyZW50U2NyZWVuCgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBjdXJyZW50U2NyZWVuID0gbmV3IFNjcmVlblNldHRpbmdzKDAsIDAsIDApOwoJCgkvKiogCgkqICBJZiB0aGUgc2NyZWVuc2l6ZSBoYXMgYmVlbiBzZXQgCgkqICBAcHJvcGVydHkge0Jvb2xlYW59IGluaXRpYWxpemVkCgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBpbml0aWFsaXplZCA9IGZhbHNlOwoJCgkvKiogCgkqICBUaGUgVUkgZGlzcGxheSBvYmplY3QgdG8gdXBkYXRlIAoJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fFBJWEkuRGlzcGxheU9iamVjdH0gX3BhcmVudAoJKiAgQHByaXZhdGUKCSovCglwLl9wYXJlbnQgPSBudWxsOwoJCgkvKiogCgkqICBUaGUgc2NyZWVuIHNldHRpbmdzIG9iamVjdCwgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgZGVzaWduZWQgc2l6ZSAKCSogIEBwcm9wZXJ0eSB7U2NyZWVuU2V0dGluZ3N9IF9kZXNpZ25lZFNjcmVlbgoJKiAgQHByaXZhdGUKCSovCglwLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CgkKCS8qKiAKCSogIFRoZSBjb25maWd1cmF0aW9uIGZvciBlYWNoIGl0ZW1zCgkqICBAcHJvcGVydHkge0FycmF5fSBfaXRlbXMKCSogIEBwcml2YXRlCgkqLwoJcC5faXRlbXMgPSBudWxsOwoJCgkvKioKCSogIFZlcnRpY2FsbHkgYWxpZ24gdG8gdGhlIHRvcAoJKiAgQHByb3BlcnR5IHtTdHJpbmd9IEFMSUdOX1RPUAoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJ0b3AiCgkqLwoJVUlTY2FsZXIuQUxJR05fVE9QID0gInRvcCI7CgoJLyoqCgkqICBWZXJ0aWNhbGx5IGFsaWduIHRvIHRoZSBib3R0b20KCSogIEBwcm9wZXJ0eSB7U3RyaW5nfSBBTElHTl9CT1RUT00KCSogIEBzdGF0aWMKCSogIEBmaW5hbAoJKiAgQHJlYWRPbmx5CgkqICBAZGVmYXVsdCAiYm90dG9tIgoJKi8KCVVJU2NhbGVyLkFMSUdOX0JPVFRPTSA9ICJib3R0b20iOwoKCS8qKgoJKiAgSG9yaXpvbnRhbGx5IGFsaWduIHRvIHRoZSBsZWZ0CgkqICBAcHJvcGVydHkge1N0cmluZ30gQUxJR05fTEVGVAoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJsZWZ0IgoJKi8KCVVJU2NhbGVyLkFMSUdOX0xFRlQgPSAibGVmdCI7CgoJLyoqCgkqICBIb3Jpem9udGFsbHkgYWxpZ24gdG8gdGhlIHJpZ2h0CgkqICBAcHJvcGVydHkge1N0cmluZ30gQUxJR05fUklHSFQKCSogIEBzdGF0aWMKCSogIEBmaW5hbAoJKiAgQHJlYWRPbmx5CgkqICBAZGVmYXVsdCAicmlnaHQiCgkqLwoJVUlTY2FsZXIuQUxJR05fUklHSFQgPSAicmlnaHQiOwoKCS8qKgoJKiAgVmVydGljYWxseSBvciBob3Jpem9udGFsbHkgYWxpZ24gdG8gdGhlIGNlbnRlcgoJKiAgQHByb3BlcnR5IHtTdHJpbmd9IEFMSUdOX0NFTlRFUgoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJjZW50ZXIiCgkqLwoJVUlTY2FsZXIuQUxJR05fQ0VOVEVSID0gImNlbnRlciI7CgkKCS8qKgoJKiAgQ3JlYXRlIHRoZSBzY2FsZXIgZnJvbSBKU09OIGRhdGEKCSogIEBtZXRob2QgZnJvbUpTT04KCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudCBUaGUgVUkgZGlzcGxheSBjb250YWluZXIKCSogIEBwYXJhbSB7T2JqZWN0fSBqc29uU2V0dGluZ3MgVGhlIGpzb24gb2YgdGhlIGRlc2lnbmVkIHNldHRpbmdzIHtkZXNpZ25lZFdpZHRoOjgwMCwgZGVzaWduZWRIZWlnaHQ6NjAwLCBkZXNpZ25lZFBQSTo3Mn0KCSogIEBwYXJhbSB7T2JqZWN0fSBqc29uSXRlbXMgVGhlIGpzb24gaXRlbXMgb2JqZWN0IHdoZXJlIHRoZSBrZXlzIGFyZSB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgb24gdGhlIHBhcmVudCBhbmQgdGhlIHZhbHVlCgkqICAgICAgICAgaXMgYW4gb2JqZWN0IHdpdGgga2V5cyBvZiAidGl0bGVTYWZlIiwgIm1pblNjYWxlIiwgIm1heFNjYWxlIiwgImNlbnRlckhvcml6b250YWxseSIsICJhbGlnbiIKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW2ltbWVkaWF0ZURlc3Ryb3k9dHJ1ZV0gSWYgd2Ugc2hvdWxkIGltbWVkaWF0ZWx5IGNsZWFudXAgdGhlIFVJU2NhbGVyIGFmdGVyIHNjYWxpbmcgaXRlbXMKCSogIEByZXR1cm4ge1VJU2NhbGVyfSBUaGUgc2NhbGVyIG9iamVjdCB0aGF0IGNhbiBiZSByZXVzZWQKCSovCglVSVNjYWxlci5mcm9tSlNPTiA9IGZ1bmN0aW9uKHBhcmVudCwganNvblNldHRpbmdzLCBqc29uSXRlbXMsIGltbWVkaWF0ZURlc3Ryb3kpCgl7CgkJaWYgKHR5cGVvZiBpbW1lZGlhdGVEZXN0cm95ICE9ICJib29sZWFuIikgaW1tZWRpYXRlRGVzdHJveSA9IHRydWU7CgkJCQoJCXZhciBzY2FsZXIgPSBuZXcgVUlTY2FsZXIoCgkJCXBhcmVudCwgCgkJCWpzb25TZXR0aW5ncy5kZXNpZ25lZFdpZHRoLAoJCQlqc29uU2V0dGluZ3MuZGVzaWduZWRIZWlnaHQsCgkJCWpzb25TZXR0aW5ncy5kZXNpZ25lZFBQSQoJCSk7CgkJCgkJLy8gVGVtcCB2YXJpYWJsZXMKCQl2YXIgaXRlbSwgaSwgYWxpZ24sIHZlcnRBbGlnbiwgaG9yaUFsaWduOwoJCQoJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIGl0ZW1zIGFuZCByZWdpc3RlcgoJCS8vIGVhY2ggZHBlbmRpbmcgb24gdGhlIHNldHRpbmdzCgkJZm9yKGkgaW4ganNvbkl0ZW1zKQoJCXsKCQkJaXRlbSA9IGpzb25JdGVtc1tpXTsKCQkJCgkJCWlmIChpdGVtLmFsaWduKQoJCQl7CgkJCQlhbGlnbiA9IGl0ZW0uYWxpZ24uc3BsaXQoIi0iKTsKCQkJCXZlcnRBbGlnbiA9IGFsaWduWzBdOwoJCQkJaG9yaUFsaWduID0gYWxpZ25bMV07CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQl2ZXJ0QWxpZ24gPSBBTElHTl9DRU5URVI7CgkJCQlob3JpQWxpZ24gPSBBTElHTl9DRU5URVI7CgkJCX0KCQkJc2NhbGVyLmFkZCgKCQkJCXBhcmVudFtpXSwgCgkJCQl2ZXJ0QWxpZ24sCgkJCQlob3JpQWxpZ24sCgkJCQlpdGVtLnRpdGxlU2FmZSB8fCBmYWxzZSwKCQkJCWl0ZW0ubWluU2NhbGUgfHwgTmFOLAoJCQkJaXRlbS5tYXhTY2FsZSB8fCBOYU4sCgkJCQlpdGVtLmNlbnRlcmVkSG9yaXpvbnRhbGx5IHx8IGZhbHNlCgkJCSk7CgkJfQoJCQoJCS8vIFNjYWxlIHRoZSBpdGVtcwoJCXNjYWxlci5yZXNpemUoKTsKCQkKCQlpZiAoaW1tZWRpYXRlRGVzdHJveSkKCQl7CgkJCXNjYWxlci5kZXN0cm95KCk7CgkJfQoJCXJldHVybiBzY2FsZXI7Cgl9OwoJCgkvKioKCSogICBTZXQgdGhlIGN1cnJlbnQgc2NyZWVuIHNldHRpbmdzLiBJZiB0aGUgc3RhZ2Ugc2l6ZSBjaGFuZ2VzIGF0IGFsbCwgcmUtY2FsbCB0aGlzIGZ1bmN0aW9uCgkqICAgQG1ldGhvZCBpbml0CgkqICAgQHN0YXRpYwoJKiAgIEBwYXJhbSB7TnVtYmVyfSBzY3JlZW5XaWR0aCBUaGUgZnVsbHNjcmVlbiB3aWR0aAoJKiAgIEBwYXJhbSB7TnVtYmVyfSBzY3JlZW5IZWlnaHQgVGhlIGZ1bGxzY3JlZW4gaGVpZ2h0CgkqICAgQHBhcmFtIHtOdW1iZXJ9IHNjcmVlblBQSSBUaGUgc2NyZWVuIHJlc29sdXRpb24gZGVuc2l0eQoJKi8KCVVJU2NhbGVyLmluaXQgPSBmdW5jdGlvbihzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0LCBzY3JlZW5QUEkpCgl7CgkJY3VycmVudFNjcmVlbi53aWR0aCA9IHNjcmVlbldpZHRoOwoJCWN1cnJlbnRTY3JlZW4uaGVpZ2h0ID0gc2NyZWVuSGVpZ2h0OwoJCWN1cnJlbnRTY3JlZW4ucHBpID0gc2NyZWVuUFBJOwoJCWluaXRpYWxpemVkID0gdHJ1ZTsKCX07CgoJLyoqCgkqICBHZXQgdGhlIGN1cnJlbnQgc2NhbGUgb2YgdGhlIHNjcmVlbgoJKiAgQG1ldGhvZCBnZXRTY2FsZQoJKiAgQHJldHVybiB7TnVtYmVyfSBUaGUgY3VycmVudCBzdGFnZSBzY2FsZQoJKi8KCXAuZ2V0U2NhbGUgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIGN1cnJlbnRTY3JlZW4uaGVpZ2h0IC8gdGhpcy5fZGVzaWduZWRTY3JlZW4uaGVpZ2h0OwoJfTsKCQoJLyoqCgkqICAgTWFudWFsbHkgYWRkIGFuIGl0ZW0gCgkqICAgQG1ldGhvZCBhZGQKCSogICBAcGFyYW0ge2NyZWF0ZWpzLkRpc3BsYXlPYmplY3R8UElYSS5EaXNwbGF5T2JqZWN0fSBpdGVtIFRoZSBkaXNwbGF5IG9iamVjdCBpdGVtIHRvIGFkZAoJKiAgIEBwYXJhbSB7U3RyaW5nfSBbdmVydEFsaWduPSJjZW50ZXIiXSBUaGUgdmVydGljYWwgYWxpZ24gb2YgdGhlIGl0ZW0gKGNlZmF1bHQgaXMgY2VudGVyKQoJKiAgIEBwYXJhbSB7U3RyaW5nfSBbaG9yaUFsaWduPSJjZW50ZXIiXSBUaGUgaG9yaXpvbnRhbCBhbGlnbiBvZiB0aGUgaXRlbSAoZGVmYXVsdCBpcyBjZW50ZXIpCgkqICAgQHBhcmFtIHtCb29sZWFufSBbdGl0bGVTYWZlPWZhbHNlXSBJZiB0aGUgaXRlbSBuZWVkcyB0byBiZSBpbiB0aGUgdGl0bGUgc2FmZSBhcmVhIChkZWZhdWx0IGlzIGZhbHNlKQoJKiAgIEBwYXJhbSB7TnVtYmVyfSBbbWluU2NhbGU9MV0gVGhlIG1pbmltdW0gc2NhbGUgYW1vdW50IChkZWZhdWx0LCBzY2FsZXMgdGhlIHNhbWUgc2l6ZSBhcyB0aGUgc3RhZ2UpCgkqICAgQHBhcmFtIHtOdW1iZXJ9IFttYXhTY2FsZT0xXSBUaGUgbWF4aW11bSBzY2FsZSBhbW91bnQgKGRlZmF1bHQsIHNjYWxlcyB0aGUgc2FtZSBzaXplIGFzIHRoZSBzdGFnZSkKCSogICBAcGFyYW0ge0Jvb2xlYW59IFtjZW50ZXJlZEhvcml6b250YWxseT1mYWxzZV0gTWFrZXMgc3VyZSB0aGF0IHRoZSBjZW50ZXIgb2YgdGhlIG9iamVjdCB3YXMgYXQgdGhlIGNlbnRlciBvZiB0aGUgc2NyZWVuLCBhc3N1bWluZyBhbiBvcmlnaW4gYXQgdGhlIHRvcCBsZWZ0IG9mIHRoZSBvYmplY3QKCSovCglwLmFkZCA9IGZ1bmN0aW9uKGl0ZW0sIHZlcnRBbGlnbiwgaG9yaUFsaWduLCB0aXRsZVNhZmUsIG1pblNjYWxlLCBtYXhTY2FsZSwgY2VudGVyZWRIb3Jpem9udGFsbHkpCgl7CgkJLy8gQ3JlYXRlIHRoZSBpdGVtIHNldHRpbmdzCgkJdmFyIHMgPSBuZXcgVUlFbGVtZW50U2V0dGluZ3MoKTsKCQkKCQlzLnZlcnRBbGlnbiA9IHZlcnRBbGlnbiB8fCBVSVNjYWxlci5BTElHTl9DRU5URVI7CgkJcy5ob3JpQWxpZ24gPSBob3JpQWxpZ24gfHwgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOwoJCXMudGl0bGVTYWZlID0gKHR5cGVvZiB0aXRsZVNhZmUgIT0gImJvb2xlYW4iKSA/IGZhbHNlIDogdGl0bGVTYWZlOwoJCXMubWF4U2NhbGUgPSAodHlwZW9mIG1heFNjYWxlICE9ICJudW1iZXIiKSA/IE5hTiA6IG1heFNjYWxlOwoJCXMubWluU2NhbGUgPSAodHlwZW9mIG1pblNjYWxlICE9ICJudW1iZXIiKSA/IE5hTiA6IG1pblNjYWxlOwoJCXMuY2VudGVyZWRIb3Jpem9udGFsbHkgPSBjZW50ZXJlZEhvcml6b250YWxseSB8fCBmYWxzZTsKCQkJCQoJCXRoaXMuX2l0ZW1zLnB1c2gobmV3IFVJRWxlbWVudChpdGVtLCBzLCB0aGlzLl9kZXNpZ25lZFNjcmVlbikpOwoJfTsKCQoJLyoqCgkqICAgU2NhbGUgYSBzaW5nbGUgYmFja2dyb3VuZCBpbWFnZSBhY2NvcmRpbmcgdG8gdGhlIFVJU2NhbGVyLndpZHRoIGFuZCBoZWlnaHQKCSogICBAbWV0aG9kIHJlc2l6ZUJhY2tncm91bmQKCSogICBAc3RhdGljCgkqICAgQHBhcmFtIHtjcmVhdGVqcy5CaXRtYXB8UElYSS5CaXRtYXB9IFRoZSBiaXRtYXAgdG8gc2NhbGUKCSovCglVSVNjYWxlci5yZXNpemVCYWNrZ3JvdW5kID0gZnVuY3Rpb24oYml0bWFwKQoJewoJCWlmICghaW5pdGlhbGl6ZWQpIHJldHVybjsKCQkKCQl2YXIgaCwgdywgc2NhbGU7CgkJaWYodHJ1ZSkKCQl7CgkJCWggPSBiaXRtYXAuaGVpZ2h0IC8gYml0bWFwLnNjYWxlLnk7CgkJCXcgPSBiaXRtYXAud2lkdGggLyBiaXRtYXAuc2NhbGUueDsKCgkJCS8vc2NhbGUgdGhlIGJhY2tncm91bmQKCQkJc2NhbGUgPSBjdXJyZW50U2NyZWVuLmhlaWdodCAvIGg7CgkJCWJpdG1hcC5zY2FsZS54ID0gYml0bWFwLnNjYWxlLnkgPSBzY2FsZTsKCQkJCgkJCS8vY2VudGVyIHRoZSBiYWNrZ3JvdW5kCgkJCWJpdG1hcC5wb3NpdGlvbi54ID0gKGN1cnJlbnRTY3JlZW4ud2lkdGggLSBiaXRtYXAud2lkdGgpICogMC41OwoJCX0KCQllbHNlIGlmKGZhbHNlKQoJCXsKCQkJaCA9IGJpdG1hcC5pbWFnZS5oZWlnaHQ7CgkJCXcgPSBiaXRtYXAuaW1hZ2Uud2lkdGg7CgoJCQkvL3NjYWxlIHRoZSBiYWNrZ3JvdW5kCgkJCXNjYWxlID0gY3VycmVudFNjcmVlbi5oZWlnaHQgLyBoOwoJCQliaXRtYXAuc2NhbGVYID0gYml0bWFwLnNjYWxlWSA9IHNjYWxlOwoJCQkKCQkJLy9jZW50ZXIgdGhlIGJhY2tncm91bmQKCQkJYml0bWFwLnggPSAoY3VycmVudFNjcmVlbi53aWR0aCAtIHcgKiBzY2FsZSkgKiAwLjU7CgkJfQoJfTsKCQoJLyoqCgkqICBDb252ZW5pZW5jZSBmdW5jdGlvbiB0byBzY2FsZSBhIGNvbGxlY3Rpb24gb2YgYmFja2dyb3VuZHMKCSogIEBtZXRob2QgcmVzaXplQmFja2dyb3VuZHMKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7QXJyYXl9IGJpdG1hcHMgVGhlIGNvbGxlY3Rpb24gb2YgYml0bWFwIGltYWdlcwoJKi8KCVVJU2NhbGVyLnJlc2l6ZUJhY2tncm91bmRzID0gZnVuY3Rpb24oYml0bWFwcykKCXsKCQlmb3IodmFyIGkgPSAwLCBsZW4gPSBiaXRtYXBzLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCXsKCQkJVUlTY2FsZXIucmVzaXplQmFja2dyb3VuZChiaXRtYXBzW2ldKTsKCQl9Cgl9OwoJCgkvKioKCSogIFNjYWxlIHRoZSBVSSBpdGVtcyB0aGF0IGhhdmUgYmVlbiByZWdpc3RlcmVkIHRvIHRoZSBjdXJyZW50IHNjcmVlbgoJKiAgQG1ldGhvZCByZXNpemUKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAodGhpcy5faXRlbXMubGVuZ3RoID4gMCkKCQl7CgkJCWZvcih2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2l0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCQl7CgkJCQl0aGlzLl9pdGVtc1tpXS5yZXNpemUoY3VycmVudFNjcmVlbik7CgkJCX0KCQl9Cgl9OwoJCgkvKioKCSogIERlc3Ryb3kgdGhlIHNjYWxlciBvYmplY3QKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAodGhpcy5faXRlbXMubGVuZ3RoID4gMCkKCQl7CgkJCWZvcih2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2l0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCQl7CgkJCQl0aGlzLl9pdGVtc1tpXS5kZXN0cm95KCk7CgkJCX0KCQl9CgkJCgkJdGhpcy5fcGFyZW50ID0gbnVsbDsKCQl0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CgkJdGhpcy5faXRlbXMgPSBudWxsOwoJfTsKCQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLlVJU2NhbGVyID0gVUlTY2FsZXI7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpIHsKCQoJInVzZSBzdHJpY3QiOwoKCS8qKgoJKiAgW1BJWEktb25seV0gQXNzZXQgTWFuYWdlciBpcyByZXNwb25zaWJsZSBmb3IgbWFuYWdpbmcgZGlmZmVyZW50IHJlc29sdXRpb25zIG9mIGFzc2V0cyBhbmQgc3ByaXRlc2hlZXRzCgkqICBiYXNlZCBvbiB0aGUgcmVzb2x1dGlvbiBvZiB0aGUgc3RhZ2UuIFRoaXMgaXMgYSBoZWxwZnVsIG9wdGltaXphdGlvbiBmb3IgUElYSSB3aGljaCBzb21lIGxvdy1oYXJkd2FyZQoJKiAgZGV2aWNlcyBoYXZlIGEgcHJvYmxlbSBrZWVwaW5nIHVwIHdpdGguCgkqCgkqICBAY2xhc3MgQXNzZXRNYW5hZ2VyIChQSVhJKQoJKi8KCXZhciBBc3NldE1hbmFnZXIgPSB7fTsKCQoJLyoqIAoJKiAgRGljdGlvbmFyeSBvZiBzY2FsZXMgYnkgYXNzZXQgaWQgCgkqICBAcHJvcGVydHkge09iamVjdH0gc2NhbGVzCgkqICBAZmluYWwKCSogIEBzdGF0aWMKCSovCglBc3NldE1hbmFnZXIuc2NhbGVzID0gbnVsbDsKCgkvKioKCSogIFRoZSBhdmFpbGFibGUgc2l6ZSBkZWZpbml0aW9ucywgZS5nLiwgeyJtYXhTaXplIjo0MDAsICJvcmRlciI6IFsidGlueSIsICJzZCJdfQoJKiAgQHByb3BlcnR5IHtBcnJheX0gc2l6ZXMKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJdmFyIHNpemVzID0gbnVsbDsKCgkvKiogCgkqICBEaWN0aW9uYXJ5IG9mIGFzc2V0cyBieSBhc3NldCBpZCAKCSogIEBwcm9wZXJ0eSB7T2JqZWN0fSBhc3NldHMKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJdmFyIGFzc2V0cyA9IG51bGw7CgoJLyoqIAoJKiAgVGhlIGNhY2hlIG9mIGFzc2V0IHVybCBwYXRocwoJKiAgQHByb3BlcnR5IHtPYmplY3R9IGFzc2V0VXJsQ2FjaGUKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJdmFyIGFzc2V0VXJsQ2FjaGUgPSBudWxsOwoKCS8qKiAKCSogIFRoZSBzY2FsaW5nIHZhbHVlIGZvciBlYWNoIGFzc2V0IHNpemUgaWQsIGUuZy4sIHsic2QiIDogMSwgInRpbnkiIDogMn0KCSogIEBwcm9wZXJ0eSB7T2JqZWN0fSBzY2FsZXMKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJdmFyIHNjYWxlcyA9IG51bGw7CgoJLyoqCgkqICBUaGUgcGF0aHMgdG8gZWFjaCByZXNvbHV0aW9uIGZvbGRlciwgZS5nLiwgeyJzZCI6ImltYWdlcy9zZC8iLCAidGlueSI6ImltYWdlcy90aW55LyJ9CgkqICBAcHJvcGVydHkge09iamVjdH0gcGF0aHMKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJdmFyIHBhdGhzID0gbnVsbDsKCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIHBlcmZlcnJlZCBzaXplIHRvIGxvYWQKCSogIEBwcm9wZXJ0eSB7QXJyYXl9IHNpemVPcmRlcgoJKiAgQHByaXZhdGUKCSogIEBzdGF0aWMKCSovCgl2YXIgc2l6ZU9yZGVyID0gbnVsbDsKCgkvKioKCSogIElmIHdlIHNob3VsZCB1c2UgbG93IGhhcmR3YXJlLCBpZiB3ZSBrbm93IHdlJ3JlIG9uIGEgc2xvdyBkZXZpY2UKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gbG93SFcKCSogIEBzdGF0aWMKCSovCglBc3NldE1hbmFnZXIubG93SFcgPSBmYWxzZTsKCQoJLyoqCgkqICBJbml0aWFsaXplIHRoZSBhc3NldCBtYW5hZ2VyCgkqICBAbWV0aG9kIGluaXQKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGNvbmZpZ3VyYXRpb24gZmlsZSB3aGljaCBjb250YWlucyBrZXlzIGZvciAicGF0aCIsICJzY2FsZSIsICJzaXppbmciLCAiYXNzZXRzIgoJKiAgQHBhcmFtIHtOdW1iZXJ9IHdpZHRoIFRoZSBzdGFnZSB3aWR0aAoJKiAgQHBhcmFtIHtOdW1iZXJ9IGhlaWdodCBUaGUgc3RhZ2UgaGVpZ2h0CgkqLwoJQXNzZXRNYW5hZ2VyLmluaXQgPSBmdW5jdGlvbihjb25maWcsIHdpZHRoLCBoZWlnaHQpCgl7CgkJQXNzZXRNYW5hZ2VyLnNjYWxlcyA9IHt9OwoJCWFzc2V0cyA9IGNvbmZpZy5hc3NldHM7CgkJYXNzZXRVcmxDYWNoZSA9IHt9OwoJCXBhdGhzID0gY29uZmlnLnBhdGg7CgkJc2l6ZXMgPSBjb25maWcuc2l6aW5nOwoJCXNjYWxlcyA9IGNvbmZpZy5zY2FsZTsKCQlwaWNrU2NhbGUod2lkdGgsIGhlaWdodCk7Cgl9OwoJCgkvKioKCSogIEdldCB0aGUgYWxpYXMgb2YgdGhlIHByZWZlcnJlZCBzaXplIHRvIHVzZQoJKiAgQG1ldGhvZCBnZXRQcmVmZXJyZWRTaXplCgkqICBAc3RhdGljCgkqICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBhbGlhcyBmb3IgdGhlIHByZWZlcnJlZCBzaXplCgkqLwoJQXNzZXRNYW5hZ2VyLmdldFByZWZlcnJlZFNpemUgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIHNpemVPcmRlclswXTsKCX07CgkKCS8qKgoJKiAgR2V0IHRoZSBwcmVmZXJyZWQgc2NhbGUgYW1vdW50CgkqICBAbWV0aG9kIGdldFByZWZlcnJlZFNjYWxlCgkqICBAc3RhdGljCgkqICBAcmV0dXJuIHtOdW1iZXJ9IFRoZSBzY2FsZSBhbW91bnQgYXNzb2NpYXRlZCB3aXRoIHRoZSBwcmVmZXJyZWQgc2l6ZQoJKi8KCUFzc2V0TWFuYWdlci5nZXRQcmVmZXJyZWRTY2FsZSA9IGZ1bmN0aW9uKCkKCXsKCQlyZXR1cm4gc2NhbGVzW3NpemVPcmRlclswXV07Cgl9OwoJCgkvKioKCSogIFBpY2sgdGhlIHByZWZlcnJlZCBzY2FsZSBiYXNlZCBvbiB0aGUgc2NyZWVuIHJlc29sdXRpb24KCSogIEBtZXRob2QgcGlja1NjYWxlCgkqICBAcHJpdmF0ZQoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtOdW1iZXJ9IHdpZHRoIFRoZSBzdGFnZSB3aWR0aAoJKiAgQHBhcmFtIHtOdW1iZXJ9IGhlaWdodCBUaGUgc3RhZ2UgaGVpZ2h0CgkqLwoJdmFyIHBpY2tTY2FsZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCgl7CgkJdmFyIG1pblNpemUgPSB3aWR0aCA8IGhlaWdodCA/IHdpZHRoIDogaGVpZ2h0OwoJCXZhciBzOwoJCWZvcih2YXIgaSA9IHNpemVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKQoJCXsKCQkJaWYoc2l6ZXNbaV0ubWF4U2l6ZSA+IG1pblNpemUpCgkJCQlzID0gc2l6ZXNbaV07CgkJCWVsc2UJCgkJCQlicmVhazsKCQl9CgkJc2l6ZU9yZGVyID0gcy5vcmRlcjsKCX07CgkKCS8qKgoJKiAgR2V0IGEgYXNzZXQgdXJsIGJ5IGFzc2V0IGlkCgkqICBAbWV0aG9kIGdldFVybAoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IGFzc2V0SWQgVGhlIHVuaXF1ZSBhc3NldCBrZHkKCSovCglBc3NldE1hbmFnZXIuZ2V0VXJsID0gZnVuY3Rpb24oYXNzZXRJZCkKCXsKCQl2YXIgYSA9IGFzc2V0c1thc3NldElkXTsKCQlpZighYSkgcmV0dXJuIG51bGw7CgkJCgkJaWYoYXNzZXRVcmxDYWNoZVthc3NldElkXSkKCQkJcmV0dXJuIGFzc2V0VXJsQ2FjaGVbYXNzZXRJZF07CgkJCgkJdmFyIHVybDsKCQlpZihhLmFuaW0pCgkJewoJCQl1cmwgPSBhc3NldFVybENhY2hlW2Fzc2V0SWRdID0gcGF0aHMuYW5pbSArIGEuc3JjOwoJCQlyZXR1cm4gdXJsOwoJCX0KCgkJaWYoQXNzZXRNYW5hZ2VyLmxvd0hXICYmIGEubG93SFcpCgkJewoJCQlBc3NldE1hbmFnZXIuc2NhbGVzW2Fzc2V0SWRdID0gc2NhbGVzW2EubG93SFddOwoJCQl1cmwgPSBhc3NldFVybENhY2hlW2Fzc2V0SWRdID0gcGF0aHNbYS5sb3dIV10gKyBhLnNyYzsKCQkJcmV0dXJuIHVybDsKCQl9CgkJCgkJZm9yKHZhciBpID0gMDsgaSA8IHNpemVPcmRlci5sZW5ndGg7ICsraSkKCQl7CgkJCXZhciB0eXBlSWQgPSBzaXplT3JkZXJbaV07CgkJCWlmKGFbdHlwZUlkXSkKCQkJewoJCQkJQXNzZXRNYW5hZ2VyLnNjYWxlc1thc3NldElkXSA9IHNjYWxlc1t0eXBlSWRdOwoJCQkJdXJsID0gYXNzZXRVcmxDYWNoZVthc3NldElkXSA9IHBhdGhzW3R5cGVJZF0gKyBhLnNyYzsKCQkJCXJldHVybiB1cmw7CgkJCX0KCQl9CgkJcmV0dXJuIG51bGw7Cgl9OwoJCgkvKioKCSogIFVubG9hZCBhbiBhc3NldAoJKiAgQG1ldGhvZCB1bmxvYWQKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7QXJyYXl8U3RyaW5nfSBhc3NldE9yQXNzZXQgVGhlIGNvbGxlY3Rpb24gb2YgYXNzZXRzIG9yIHNpbmdsZSBhc3NldCBpZAoJKi8KCUFzc2V0TWFuYWdlci51bmxvYWQgPSBmdW5jdGlvbihhc3NldE9yQXNzZXRzKQoJewoJCWlmKGFzc2V0T3JBc3NldHMgaW5zdGFuY2VvZiBBcnJheSkKCQl7CgkJCWZvcih2YXIgaSA9IGFzc2V0T3JBc3NldHMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpCgkJCXsKCQkJCXZhciBpZCA9IGFzc2V0T3JBc3NldHNbaV07CgkJCQl1bmxvYWRBc3NldChpZCk7CgkJCX0KCQl9CgkJZWxzZS8vc3RyaW5nCgkJewoJCQl1bmxvYWRBc3NldChhc3NldE9yQXNzZXRzKTsKCQl9Cgl9OwoKCS8qKgoJKiAgVW5sb2FkIGFuIGFzc2V0CgkqICBAbWV0aG9kIHVubG9hZEFzc2V0CgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKiAgQHBhcmFtIHtTdHJpbmd9IGFzc2V0IFRoZSBhc3NldCBpZCB0byB1bmxvYWQKCSovCgl2YXIgdW5sb2FkQXNzZXQgPSBmdW5jdGlvbihhc3NldCkKCXsKCQlpZighYXNzZXRVcmxDYWNoZVthc3NldF0pIHJldHVybjsvL2lmIHRoaXMgZG9lc24ndCBleGlzdCwgdGhlbiBpdCB3YXNuJ3QgbG9hZGVkCgkJdmFyIGEgPSBhc3NldHNbYXNzZXRdOwoJCWlmKCFhKSByZXR1cm47Ly9hc3NldCBuZXZlciBleGlzdGVkIGluIHRoZSBtYXN0ZXIgbGlzdAoJCWlmKGEuYW5pbSkgcmV0dXJuOy8vZG9uJ3QgdW5sb2FkIHRoZXNlLCB0aGV5IGFyZSBwcmV0dHkgc21hbGwKCQlpZihhLmlzRm9udCkKCQl7CgkJCWlmKFBJWEkuQml0bWFwVGV4dC5mb250c1thc3NldF0pCgkJCQlkZWxldGUgUElYSS5CaXRtYXBUZXh0LmZvbnRzW2Fzc2V0XTsKCQl9CgkJLy9hbnl0aGluZyBlbHNlIGlzIGEgdGV4dHVyZQoJCVBJWEkuVGV4dHVyZS5kZXN0cm95VGV4dHVyZShhc3NldFVybENhY2hlW2Fzc2V0XSk7CgkJZGVsZXRlIEFzc2V0TWFuYWdlci5zY2FsZXNbYXNzZXRdOwoJCWRlbGV0ZSBhc3NldFVybENhY2hlW2Fzc2V0XTsKCX07CgoJLyoqCgkqICBHZXQgdGhlIGNvbGxlY3Rpb24gb2YgYXNzZXRzIHRoYXQgYXJlIGFsc28gYW5pbWF0aW9ucwoJKiAgQG1ldGhvZCBnZXRBbmltcwoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtPYmplY3R9IGFuaW1zIFRoZSBkaWN0aW9uYXJ5IG9mIGFuaW1hdGlvbiBhc3NldHMKCSogIEBwYXJhbSB7aW50fSBbbWF4RGlnaXRzPTRdIE1heGltdW0gbnVtYmVyIG9mIGRpZ2l0cywgbGlrZSA0IGZvciBhbiBhbmltYXRpb24gZXhwb3J0ZWQgYXMgYW5pbV8wMDAxLnBuZwoJKiAgQHBhcmFtIHtPYmplY3R9IFtvdXRPYmpdIElmIGFscmVhZHkgdXNpbmcgYW4gcmV0dXJuIG9iamVjdAoJKiAgQHJldHVybiB7T2JqZWN0fSBBbiBjb2xsZWN0aW9uIG9mIFBJWEkuVGV4dHVyZXMgZm9yIGVhY2ggYW5pbWF0aW9uIGlkIHN1aXRhYmxlIGZvciB1c2UgaW4gUElYSS5Nb3ZpZUNsaXAKCSovCglBc3NldE1hbmFnZXIuZ2V0QW5pbXMgPSBmdW5jdGlvbihhbmltcywgbWF4RGlnaXRzLCBvdXRPYmopCgl7CgkJaWYobWF4RGlnaXRzID09PSB1bmRlZmluZWQpCgkJCW1heERpZ2l0cyA9IDQ7CgkJaWYobWF4RGlnaXRzIDwgMCkKCQkJbWF4RGlnaXRzID0gMDsKCQl2YXIgemVyb3MgPSBbXTsKCQl2YXIgY29tcGFyZXMgPSBbXTsKCQl2YXIgaSwgYzsKCQlmb3IoaSA9IDE7IGkgPCBtYXhEaWdpdHM7ICsraSkKCQl7CgkJCXZhciBzID0gIiI7CgkJCWMgPSAxOwoJCQlmb3IodmFyIGogPSAwOyBqIDwgaTsgKytqKQoJCQl7CgkJCQlzICs9ICIwIjsKCQkJCWMgKj0gMTA7CgkJCX0KCQkJemVyb3MudW5zaGlmdChzKTsKCQkJY29tcGFyZXMucHVzaChjKTsKCQl9CgkJdmFyIGNvbXBhcmVMZW5ndGggPSBjb21wYXJlcy5sZW5ndGg7CgkJCgkJdmFyIHJ0bkRpY3QgPSBvdXRPYmogfHwge307CgkJdmFyIGZyb21GcmFtZSA9IFBJWEkuVGV4dHVyZS5mcm9tRnJhbWU7CgkJdmFyIHByZXZUZXgsIGxlbjsKCQlmb3IodmFyIGEgaW4gYW5pbXMpCgkJewoJCQl2YXIgZGF0YSA9IGFuaW1zW2FdOwoJCQl2YXIgbGlzdCA9IFtdOwoKCQkJZm9yKGkgPSBkYXRhLm51bWJlck1pbiwgbGVuID0gZGF0YS5udW1iZXJNYXg7IGkgPD0gbGVuOyArK2kpCgkJCXsKCQkJCXZhciBudW0gPSBudWxsOwoJCQkJZm9yKGMgPSAwOyBjIDwgY29tcGFyZUxlbmd0aDsgKytjKQoJCQkJewoJCQkJCWlmKGkgPCBjb21wYXJlc1tjXSkKCQkJCQl7CgkJCQkJCW51bSA9IHplcm9zW2NdICsgaTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJaWYoIW51bSkKCQkJCQludW0gPSBpLnRvU3RyaW5nKCk7CgkJCQkKCQkJCS8vSWYgdGhlIHRleHR1cmUgZG9lc24ndCBleGlzdCwgdXNlIHRoZSBwcmV2aW91cyB0ZXh0dXJlIC0gdGhpcyBzaG91bGQgYWxsb3cgdXMgdG8gdXNlIGZld2VyIHRleHR1cmVzCgkJCQkvL3RoYXQgYXJlIGluIGZhY3QgdGhlIHNhbWUsIGlmIHdlIGNhbiBmaW5kIGFuIGVhc3kgd2F5IHRvIGltcHJvdmUgdGhlIHNwcml0ZXNoZWV0IGZvcm1hdCBmb3IgdGhhdCBwdXJwb3NlCgkJCQl2YXIgdGV4TmFtZSA9IGRhdGEubmFtZS5yZXBsYWNlKCIjIiwgbnVtKTsKCQkJCXZhciB0ZXggPSBmcm9tRnJhbWUodGV4TmFtZSwgdHJ1ZSk7CgkJCQlpZih0ZXgpCgkJCQkJcHJldlRleCA9IHRleDsKCQkJCWxpc3QucHVzaChwcmV2VGV4KTsKCQkJfQoJCQlydG5EaWN0W2FdID0gbGlzdDsKCQl9CgkJcmV0dXJuIHJ0bkRpY3Q7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWVzcGFjZQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLkFzc2V0TWFuYWdlciA9IEFzc2V0TWFuYWdlcjsKfSgpKTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 15:39:30 GMT",
                    "Content-Length": "117525",
                    "Date": "Thu, 06 Nov 2014 15:39:34 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}