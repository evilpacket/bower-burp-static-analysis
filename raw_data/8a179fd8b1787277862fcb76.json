{
    "url": "http://localhost:9999/david-driscoll/thrust/example/spa/spa.example.compiled.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statement:<ul><li>location.replace(location.href.replace(/(javascript:|#).*$/, '') + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/david-driscoll/thrust/example/spa/spa.example.compiled.js",
                "path": "/david-driscoll/thrust/example/spa/spa.example.compiled.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kYXZpZC1kcmlzY29sbC90aHJ1c3QvZXhhbXBsZS9zcGEvc3BhLmV4YW1wbGUuY29tcGlsZWQuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTAwNzU0OQ0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KRGF0ZTogU2F0LCAwOCBOb3YgMjAxNCAyMDowNToyOCBHTVQNCkxhc3QtTW9kaWZpZWQ6IFNhdCwgMDggTm92IDIwMTQgMjA6MDU6MjcgR01UDQoNCgovKiEKICogTG8tRGFzaCB2MC40LjEgPGh0dHA6Ly9sb2Rhc2guY29tPgogKiBDb3B5cmlnaHQgMjAxMiBKb2huLURhdmlkIERhbHRvbiA8aHR0cDovL2FsbHlvdWNhbmxlZXQuY29tLz4KICogQmFzZWQgb24gVW5kZXJzY29yZS5qcyAxLjMuMywgY29weXJpZ2h0IDIwMDktMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgogKiA8aHR0cDovL2RvY3VtZW50Y2xvdWQuZ2l0aHViLmNvbS91bmRlcnNjb3JlPgogKiBBdmFpbGFibGUgdW5kZXIgTUlUIGxpY2Vuc2UgPGh0dHA6Ly9sb2Rhc2guY29tL2xpY2Vuc2U+CiAqLwo7KGZ1bmN0aW9uKHdpbmRvdywgdW5kZWZpbmVkKSB7CiAgCgogIC8qKgogICAqIFVzZWQgdG8gY2FjaGUgdGhlIGxhc3QgYF8udGVtcGxhdGVTZXR0aW5ncy5ldmFsdWF0ZWAgZGVsaW1pdGVyIHRvIGF2b2lkCiAgICogdW5uZWNlc3NhcmlseSBhc3NpZ25pbmcgYHJlRXZhbHVhdGVEZWxpbWl0ZXJgIGEgbmV3IGdlbmVyYXRlZCByZWdleHAuCiAgICogQXNzaWduZWQgaW4gYF8udGVtcGxhdGVgLgogICAqLwogIHZhciBsYXN0RXZhbHVhdGVEZWxpbWl0ZXI7CgogIC8qKgogICAqIFVzZWQgdG8gY2FjaGUgdGhlIGxhc3QgdGVtcGxhdGUgYG9wdGlvbnMudmFyaWFibGVgIHRvIGF2b2lkIHVubmVjZXNzYXJpbHkKICAgKiBhc3NpZ25pbmcgYHJlRG91YmxlVmFyaWFibGVgIGEgbmV3IGdlbmVyYXRlZCByZWdleHAuIEFzc2lnbmVkIGluIGBfLnRlbXBsYXRlYC4KICAgKi8KICB2YXIgbGFzdFZhcmlhYmxlOwoKICAvKioKICAgKiBVc2VkIHRvIG1hdGNoIHBvdGVudGlhbGx5IGluY29ycmVjdCBkYXRhIG9iamVjdCByZWZlcmVuY2VzLCBsaWtlIGBvYmoub2JqYCwKICAgKiBpbiBjb21waWxlZCB0ZW1wbGF0ZXMuIEFzc2lnbmVkIGluIGBfLnRlbXBsYXRlYC4KICAgKi8KICB2YXIgcmVEb3VibGVWYXJpYWJsZTsKCiAgLyoqCiAgICogVXNlZCB0byBtYXRjaCAiZXZhbHVhdGUiIGRlbGltaXRlcnMsIGluY2x1ZGluZyBpbnRlcm5hbCBkZWxpbWl0ZXJzLAogICAqIGluIHRlbXBsYXRlIHRleHQuIEFzc2lnbmVkIGluIGBfLnRlbXBsYXRlYC4KICAgKi8KICB2YXIgcmVFdmFsdWF0ZURlbGltaXRlcjsKCiAgLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlIGBleHBvcnRzYCAqLwogIHZhciBmcmVlRXhwb3J0cyA9IHR5cGVvZiBleHBvcnRzID09ICdvYmplY3QnICYmIGV4cG9ydHMgJiYKICAgICh0eXBlb2YgZ2xvYmFsID09ICdvYmplY3QnICYmIGdsb2JhbCAmJiBnbG9iYWwgPT0gZ2xvYmFsLmdsb2JhbCAmJiAod2luZG93ID0gZ2xvYmFsKSwgZXhwb3J0cyk7CgogIC8qKiBOYXRpdmUgcHJvdG90eXBlIHNob3J0Y3V0cyAqLwogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLAogICAgICBPYmplY3RQcm90byA9IE9iamVjdC5wcm90b3R5cGU7CgogIC8qKiBVc2VkIHRvIGdlbmVyYXRlIHVuaXF1ZSBJRHMgKi8KICB2YXIgaWRDb3VudGVyID0gMDsKCiAgLyoqIFVzZWQgdG8gcmVzdG9yZSB0aGUgb3JpZ2luYWwgYF9gIHJlZmVyZW5jZSBpbiBgbm9Db25mbGljdGAgKi8KICB2YXIgb2xkRGFzaCA9IHdpbmRvdy5fOwoKICAvKiogVXNlZCB0byBkZXRlY3QgZGVsaW1pdGVyIHZhbHVlcyB0aGF0IHNob3VsZCBiZSBwcm9jZXNzZWQgYnkgYHRva2VuaXplRXZhbHVhdGVgICovCiAgdmFyIHJlQ29tcGxleERlbGltaXRlciA9IC9bLSs9IX4qJSZePD58eyhcL118XFtcRHxcYig/OmRlbGV0ZXxpbnxpbnN0YW5jZW9mfG5ld3x0eXBlb2Z8dm9pZClcYi87CgogIC8qKiBVc2VkIHRvIG1hdGNoIGVtcHR5IHN0cmluZyBsaXRlcmFscyBpbiBjb21waWxlZCB0ZW1wbGF0ZSBzb3VyY2UgKi8KICB2YXIgcmVFbXB0eVN0cmluZ0xlYWRpbmcgPSAvXGJfX3AgXCs9ICcnOy9nLAogICAgICByZUVtcHR5U3RyaW5nTWlkZGxlID0gL1xiKF9fcCBcKz0pICcnIFwrL2csCiAgICAgIHJlRW1wdHlTdHJpbmdUcmFpbGluZyA9IC8oX19lXCguKj9cKXxcYl9fdFwpKSBcK1xuJyc7L2c7CgogIC8qKiBVc2VkIHRvIGluc2VydCB0aGUgZGF0YSBvYmplY3QgdmFyaWFibGUgaW50byBjb21waWxlZCB0ZW1wbGF0ZSBzb3VyY2UgKi8KICB2YXIgcmVJbnNlcnRWYXJpYWJsZSA9IC8oPzpfX2V8X190ID0gKVwoXHMqKD8hW1xkXHMiJ118dGhpc1wuKS9nOwoKICAvKiogVXNlZCB0byBkZXRlY3QgaWYgYSBtZXRob2QgaXMgbmF0aXZlICovCiAgdmFyIHJlTmF0aXZlID0gUmVnRXhwKCdeJyArCiAgICAoT2JqZWN0UHJvdG8udmFsdWVPZiArICcnKQogICAgICAucmVwbGFjZSgvWy4qKz9ePSE6JHt9KCl8W1xdXC9cXF0vZywgJ1xcJCYnKQogICAgICAucmVwbGFjZSgvdmFsdWVPZnxmb3IgW15cXV0rL2csICcuKz8nKSArICckJwogICk7CgogIC8qKiBVc2VkIHRvIG1hdGNoIHRva2VucyBpbiB0ZW1wbGF0ZSB0ZXh0ICovCiAgdmFyIHJlVG9rZW4gPSAvX190b2tlbl9fKFxkKykvZzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggdW5lc2NhcGVkIGNoYXJhY3RlcnMgaW4gc3RyaW5ncyBmb3IgaW5jbHVzaW9uIGluIEhUTUwgKi8KICB2YXIgcmVVbmVzY2FwZWRIdG1sID0gL1smPCInXS9nOwoKICAvKiogVXNlZCB0byBtYXRjaCB1bmVzY2FwZWQgY2hhcmFjdGVycyBpbiBjb21waWxlZCBzdHJpbmcgbGl0ZXJhbHMgKi8KICB2YXIgcmVVbmVzY2FwZWRTdHJpbmcgPSAvWydcblxyXHRcdTIwMjhcdTIwMjlcXF0vZzsKCiAgLyoqIFVzZWQgdG8gZml4IHRoZSBKU2NyaXB0IFtbRG9udEVudW1dXSBidWcgKi8KICB2YXIgc2hhZG93ZWQgPSBbCiAgICAnY29uc3RydWN0b3InLCAnaGFzT3duUHJvcGVydHknLCAnaXNQcm90b3R5cGVPZicsICdwcm9wZXJ0eUlzRW51bWVyYWJsZScsCiAgICAndG9Mb2NhbGVTdHJpbmcnLCAndG9TdHJpbmcnLCAndmFsdWVPZicKICBdOwoKICAvKiogVXNlZCB0byBtYWtlIHRlbXBsYXRlIHNvdXJjZVVSTHMgZWFzaWVyIHRvIGlkZW50aWZ5ICovCiAgdmFyIHRlbXBsYXRlQ291bnRlciA9IDA7CgogIC8qKiBVc2VkIHRvIHJlcGxhY2UgdGVtcGxhdGUgZGVsaW1pdGVycyAqLwogIHZhciB0b2tlbiA9ICdfX3Rva2VuX18nOwoKICAvKiogVXNlZCB0byBzdG9yZSB0b2tlbml6ZWQgdGVtcGxhdGUgdGV4dCBzbmlwcGV0cyAqLwogIHZhciB0b2tlbml6ZWQgPSBbXTsKCiAgLyoqIE5hdGl2ZSBtZXRob2Qgc2hvcnRjdXRzICovCiAgdmFyIGNvbmNhdCA9IEFycmF5UHJvdG8uY29uY2F0LAogICAgICBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdFByb3RvLmhhc093blByb3BlcnR5LAogICAgICBwdXNoID0gQXJyYXlQcm90by5wdXNoLAogICAgICBwcm9wZXJ0eUlzRW51bWVyYWJsZSA9IE9iamVjdFByb3RvLnByb3BlcnR5SXNFbnVtZXJhYmxlLAogICAgICBzbGljZSA9IEFycmF5UHJvdG8uc2xpY2UsCiAgICAgIHRvU3RyaW5nID0gT2JqZWN0UHJvdG8udG9TdHJpbmc7CgogIC8qIE5hdGl2ZSBtZXRob2Qgc2hvcnRjdXRzIGZvciBtZXRob2RzIHdpdGggdGhlIHNhbWUgbmFtZSBhcyBvdGhlciBgbG9kYXNoYCBtZXRob2RzICovCiAgdmFyIG5hdGl2ZUJpbmQgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUJpbmQgPSBzbGljZS5iaW5kKSAmJiBuYXRpdmVCaW5kLAogICAgICBuYXRpdmVJc0FycmF5ID0gcmVOYXRpdmUudGVzdChuYXRpdmVJc0FycmF5ID0gQXJyYXkuaXNBcnJheSkgJiYgbmF0aXZlSXNBcnJheSwKICAgICAgbmF0aXZlSXNGaW5pdGUgPSB3aW5kb3cuaXNGaW5pdGUsCiAgICAgIG5hdGl2ZUtleXMgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUtleXMgPSBPYmplY3Qua2V5cykgJiYgbmF0aXZlS2V5czsKCiAgLyoqIGBPYmplY3QjdG9TdHJpbmdgIHJlc3VsdCBzaG9ydGN1dHMgKi8KICB2YXIgYXJyYXlDbGFzcyA9ICdbb2JqZWN0IEFycmF5XScsCiAgICAgIGJvb2xDbGFzcyA9ICdbb2JqZWN0IEJvb2xlYW5dJywKICAgICAgZGF0ZUNsYXNzID0gJ1tvYmplY3QgRGF0ZV0nLAogICAgICBmdW5jQ2xhc3MgPSAnW29iamVjdCBGdW5jdGlvbl0nLAogICAgICBudW1iZXJDbGFzcyA9ICdbb2JqZWN0IE51bWJlcl0nLAogICAgICByZWdleHBDbGFzcyA9ICdbb2JqZWN0IFJlZ0V4cF0nLAogICAgICBzdHJpbmdDbGFzcyA9ICdbb2JqZWN0IFN0cmluZ10nOwoKICAvKiogVGltZXIgc2hvcnRjdXRzICovCiAgdmFyIGNsZWFyVGltZW91dCA9IHdpbmRvdy5jbGVhclRpbWVvdXQsCiAgICAgIHNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dDsKCiAgLyoqCiAgICogRGV0ZWN0IHRoZSBKU2NyaXB0IFtbRG9udEVudW1dXSBidWc6CiAgICogSW4gSUUgPCA5IGFuIG9iamVjdHMgb3duIHByb3BlcnRpZXMsIHNoYWRvd2luZyBub24tZW51bWVyYWJsZSBvbmVzLCBhcmUKICAgKiBtYWRlIG5vbi1lbnVtZXJhYmxlIGFzIHdlbGwuCiAgICovCiAgdmFyIGhhc0RvbnRFbnVtQnVnID0gIXByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoeyAndmFsdWVPZic6IDAgfSwgJ3ZhbHVlT2YnKTsKCiAgLyoqIERldGVjdCBpZiBgQXJyYXkjc2xpY2VgIGNhbm5vdCBiZSB1c2VkIHRvIGNvbnZlcnQgc3RyaW5ncyB0byBhcnJheXMgKE9wZXJhIDwgMTAuNTIpICovCiAgdmFyIG5vQXJyYXlTbGljZU9uU3RyaW5ncyA9IHNsaWNlLmNhbGwoJ3gnKVswXSAhPSAneCc7CgogIC8qKgogICAqIERldGVjdCBsYWNrIG9mIHN1cHBvcnQgZm9yIGFjY2Vzc2luZyBzdHJpbmcgY2hhcmFjdGVycyBieSBpbmRleDoKICAgKiBJRSA8IDggY2FuJ3QgYWNjZXNzIGNoYXJhY3RlcnMgYnkgaW5kZXggYW5kIElFIDggY2FuIG9ubHkgYWNjZXNzCiAgICogY2hhcmFjdGVycyBieSBpbmRleCBvbiBzdHJpbmcgbGl0ZXJhbHMuCiAgICovCiAgdmFyIG5vQ2hhckJ5SW5kZXggPSAoJ3gnWzBdICsgT2JqZWN0KCd4JylbMF0pICE9ICd4eCc7CgogIC8qIERldGVjdCBpZiBgRnVuY3Rpb24jYmluZGAgZXhpc3RzIGFuZCBpcyBpbmZlcnJlZCB0byBiZSBmYXN0IChhbGwgYnV0IFY4KSAqLwogIHZhciBpc0JpbmRGYXN0ID0gbmF0aXZlQmluZCAmJiAvXG58T3BlcmEvLnRlc3QobmF0aXZlQmluZCArIHRvU3RyaW5nLmNhbGwod2luZG93Lm9wZXJhKSk7CgogIC8qIERldGVjdCBpZiBgT2JqZWN0LmtleXNgIGV4aXN0cyBhbmQgaXMgaW5mZXJyZWQgdG8gYmUgZmFzdCAoVjgsIE9wZXJhLCBJRSkgKi8KICB2YXIgaXNLZXlzRmFzdCA9IG5hdGl2ZUtleXMgJiYgL14uKyR8dHJ1ZS8udGVzdChuYXRpdmVLZXlzICsgISF3aW5kb3cuYXR0YWNoRXZlbnQpOwoKICAvKiogRGV0ZWN0IGlmIHNvdXJjZVVSTCBzeW50YXggaXMgdXNhYmxlIHdpdGhvdXQgZXJyb3JpbmcgKi8KICB0cnkgewogICAgLy8gQWRvYmUncyBhbmQgTmFyd2hhbCdzIEpTIGVuZ2luZXMgd2lsbCBlcnJvcgogICAgdmFyIHVzZVNvdXJjZVVSTCA9IChGdW5jdGlvbignLy9AJykoKSwgdHJ1ZSk7CiAgfSBjYXRjaChlKXsgfQoKICAvKioKICAgKiBVc2VkIHRvIGVzY2FwZSBjaGFyYWN0ZXJzIGZvciBpbmNsdXNpb24gaW4gSFRNTC4KICAgKiBUaGUgYD5gIGFuZCBgL2AgY2hhcmFjdGVycyBkb24ndCByZXF1aXJlIGVzY2FwaW5nIGluIEhUTUwgYW5kIGhhdmUgbm8KICAgKiBzcGVjaWFsIG1lYW5pbmcgdW5sZXNzIHRoZXkncmUgcGFydCBvZiBhIHRhZyBvciBhbiB1bnF1b3RlZCBhdHRyaWJ1dGUgdmFsdWUKICAgKiBodHRwOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9hbWJpZ3VvdXMtYW1wZXJzYW5kcyAoc2VtaS1yZWxhdGVkIGZ1biBmYWN0KQogICAqLwogIHZhciBodG1sRXNjYXBlcyA9IHsKICAgICcmJzogJyZhbXA7JywKICAgICc8JzogJyZsdDsnLAogICAgJyInOiAnJnF1b3Q7JywKICAgICInIjogJyYjeDI3OycKICB9OwoKICAvKiogVXNlZCB0byBkZXRlcm1pbmUgaWYgdmFsdWVzIGFyZSBvZiB0aGUgbGFuZ3VhZ2UgdHlwZSBPYmplY3QgKi8KICB2YXIgb2JqZWN0VHlwZXMgPSB7CiAgICAnYm9vbGVhbic6IGZhbHNlLAogICAgJ2Z1bmN0aW9uJzogdHJ1ZSwKICAgICdvYmplY3QnOiB0cnVlLAogICAgJ251bWJlcic6IGZhbHNlLAogICAgJ3N0cmluZyc6IGZhbHNlLAogICAgJ3VuZGVmaW5lZCc6IGZhbHNlCiAgfTsKCiAgLyoqIFVzZWQgdG8gZXNjYXBlIGNoYXJhY3RlcnMgZm9yIGluY2x1c2lvbiBpbiBjb21waWxlZCBzdHJpbmcgbGl0ZXJhbHMgKi8KICB2YXIgc3RyaW5nRXNjYXBlcyA9IHsKICAgICdcXCc6ICdcXCcsCiAgICAiJyI6ICInIiwKICAgICdcbic6ICduJywKICAgICdccic6ICdyJywKICAgICdcdCc6ICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogVGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAqCiAgICogQG5hbWUgXwogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwIGluIGEgYExvRGFzaGAgaW5zdGFuY2UuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhIGBMb0Rhc2hgIGluc3RhbmNlLgogICAqLwogIGZ1bmN0aW9uIGxvZGFzaCh2YWx1ZSkgewogICAgLy8gYWxsb3cgaW52b2tpbmcgYGxvZGFzaGAgd2l0aG91dCB0aGUgYG5ld2Agb3BlcmF0b3IKICAgIHJldHVybiBuZXcgTG9EYXNoKHZhbHVlKTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBgTG9EYXNoYCBpbnN0YW5jZSB0aGF0IHdyYXBzIGEgdmFsdWUgdG8gYWxsb3cgY2hhaW5pbmcuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwLgogICAqLwogIGZ1bmN0aW9uIExvRGFzaCh2YWx1ZSkgewogICAgLy8gZXhpdCBlYXJseSBpZiBhbHJlYWR5IHdyYXBwZWQKICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5fd3JhcHBlZCkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICB0aGlzLl93cmFwcGVkID0gdmFsdWU7CiAgfQoKICAvKioKICAgKiBCeSBkZWZhdWx0LCBMby1EYXNoIHVzZXMgZW1iZWRkZWQgUnVieSAoRVJCKSBzdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLAogICAqIGNoYW5nZSB0aGUgZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQHR5cGUgT2JqZWN0CiAgICovCiAgbG9kYXNoLnRlbXBsYXRlU2V0dGluZ3MgPSB7CgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGRldGVjdCBgZGF0YWAgcHJvcGVydHkgdmFsdWVzIHRvIGJlIEhUTUwtZXNjYXBlZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgKiBAdHlwZSBSZWdFeHAKICAgICAqLwogICAgJ2VzY2FwZSc6IC88JS0oW1xzXFNdKz8pJT4vZywKCiAgICAvKioKICAgICAqIFVzZWQgdG8gZGV0ZWN0IGNvZGUgdG8gYmUgZXZhbHVhdGVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICovCiAgICAnZXZhbHVhdGUnOiAvPCUoW1xzXFNdKz8pJT4vZywKCiAgICAvKioKICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gaW5qZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICovCiAgICAnaW50ZXJwb2xhdGUnOiAvPCU9KFtcc1xTXSs/KSU+L2csCgogICAgLyoqCiAgICAgKiBVc2VkIHRvIHJlZmVyZW5jZSB0aGUgZGF0YSBvYmplY3QgaW4gdGhlIHRlbXBsYXRlIHRleHQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgU3RyaW5nCiAgICAgKi8KICAgICd2YXJpYWJsZSc6ICdvYmonCiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIFRoZSB0ZW1wbGF0ZSB1c2VkIHRvIGNyZWF0ZSBpdGVyYXRvciBmdW5jdGlvbnMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JlY3R9IGRhdGEgVGhlIGRhdGEgb2JqZWN0IHVzZWQgdG8gcG9wdWxhdGUgdGhlIHRleHQuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgaW50ZXJwb2xhdGVkIHRleHQuCiAgICovCiAgdmFyIGl0ZXJhdG9yVGVtcGxhdGUgPSB0ZW1wbGF0ZSgKICAgIC8vIGNvbmRpdGlvbmFsIHN0cmljdCBtb2RlCiAgICc8JSBpZiAodXNlU3RyaWN0KSB7ICU+XCd1c2Ugc3RyaWN0XCc7XG48JSB9ICU+JyArCgogICAgLy8gdGhlIGBpdGVyYXRlZWAgbWF5IGJlIHJlYXNzaWduZWQgYnkgdGhlIGB0b3BgIHNuaXBwZXQKICAgICd2YXIgaW5kZXgsIGl0ZXJhdGVlID0gPCU9IGZpcnN0QXJnICU+LCAnICsKICAgIC8vIGFzc2lnbiB0aGUgYHJlc3VsdGAgdmFyaWFibGUgYW4gaW5pdGlhbCB2YWx1ZQogICAgJ3Jlc3VsdDwlIGlmIChpbml0KSB7ICU+ID0gPCU9IGluaXQgJT48JSB9ICU+O1xuJyArCiAgICAvLyBhZGQgY29kZSB0byBleGl0IGVhcmx5IG9yIGRvIHNvIGlmIHRoZSBmaXJzdCBhcmd1bWVudCBpcyBmYWxzZXkKICAgICc8JT0gZXhpdCAlPjtcbicgKwogICAgLy8gYWRkIGNvZGUgYWZ0ZXIgdGhlIGV4aXQgc25pcHBldCBidXQgYmVmb3JlIHRoZSBpdGVyYXRpb24gYnJhbmNoZXMKICAgICc8JT0gdG9wICU+O1xuJyArCgogICAgLy8gdGhlIGZvbGxvd2luZyBicmFuY2ggaXMgZm9yIGl0ZXJhdGluZyBhcnJheXMgYW5kIGFycmF5LWxpa2Ugb2JqZWN0cwogICAgJzwlIGlmIChhcnJheUJyYW5jaCkgeyAlPicgKwogICAgJ3ZhciBsZW5ndGggPSBpdGVyYXRlZS5sZW5ndGg7IGluZGV4ID0gLTE7JyArCiAgICAnICA8JSBpZiAob2JqZWN0QnJhbmNoKSB7ICU+XG5pZiAobGVuZ3RoID09PSBsZW5ndGggPj4+IDApIHs8JSB9ICU+JyArCgogICAgLy8gYWRkIHN1cHBvcnQgZm9yIGFjY2Vzc2luZyBzdHJpbmcgY2hhcmFjdGVycyBieSBpbmRleCBpZiBuZWVkZWQKICAgICcgIDwlIGlmIChub0NoYXJCeUluZGV4KSB7ICU+XG4nICsKICAgICcgIGlmICh0b1N0cmluZy5jYWxsKGl0ZXJhdGVlKSA9PSBzdHJpbmdDbGFzcykge1xuJyArCiAgICAnICAgIGl0ZXJhdGVlID0gaXRlcmF0ZWUuc3BsaXQoXCdcJylcbicgKwogICAgJyAgfScgKwogICAgJyAgPCUgfSAlPlxuJyArCgogICAgJyAgPCU9IGFycmF5QnJhbmNoLmJlZm9yZUxvb3AgJT47XG4nICsKICAgICcgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7XG4nICsKICAgICcgICAgPCU9IGFycmF5QnJhbmNoLmluTG9vcCAlPlxuJyArCiAgICAnICB9JyArCiAgICAnICA8JSBpZiAob2JqZWN0QnJhbmNoKSB7ICU+XG59PCUgfSAlPicgKwogICAgJzwlIH0gJT4nICsKCiAgICAvLyB0aGUgZm9sbG93aW5nIGJyYW5jaCBpcyBmb3IgaXRlcmF0aW5nIGFuIG9iamVjdCdzIG93bi9pbmhlcml0ZWQgcHJvcGVydGllcwogICAgJzwlIGlmIChvYmplY3RCcmFuY2gpIHsgJT4nICsKICAgICcgIDwlIGlmIChhcnJheUJyYW5jaCkgeyAlPlxuZWxzZSB7PCUgfSAlPicgKwogICAgJyAgPCUgaWYgKCFoYXNEb250RW51bUJ1ZykgeyAlPlxuJyArCiAgICAnICB2YXIgc2tpcFByb3RvID0gdHlwZW9mIGl0ZXJhdGVlID09IFwnZnVuY3Rpb25cJyAmJiBcbicgKwogICAgJyAgICBwcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGl0ZXJhdGVlLCBcJ3Byb3RvdHlwZVwnKTtcbicgKwogICAgJyAgPCUgfSAlPicgKwoKICAgIC8vIGl0ZXJhdGUgb3duIHByb3BlcnRpZXMgdXNpbmcgYE9iamVjdC5rZXlzYCBpZiBpdCdzIGZhc3QKICAgICcgIDwlIGlmIChpc0tleXNGYXN0ICYmIHVzZUhhcykgeyAlPlxuJyArCiAgICAnICB2YXIgcHJvcHMgPSBuYXRpdmVLZXlzKGl0ZXJhdGVlKSxcbicgKwogICAgJyAgICAgIHByb3BJbmRleCA9IC0xLFxuJyArCiAgICAnICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoO1xuXG4nICsKICAgICcgIDwlPSBvYmplY3RCcmFuY2guYmVmb3JlTG9vcCAlPjtcbicgKwogICAgJyAgd2hpbGUgKCsrcHJvcEluZGV4IDwgbGVuZ3RoKSB7XG4nICsKICAgICcgICAgaW5kZXggPSBwcm9wc1twcm9wSW5kZXhdO1xuJyArCiAgICAnICAgIGlmICghKHNraXBQcm90byAmJiBpbmRleCA9PSBcJ3Byb3RvdHlwZVwnKSkge1xuJyArCiAgICAnICAgICAgPCU9IG9iamVjdEJyYW5jaC5pbkxvb3AgJT5cbicgKwogICAgJyAgICB9XG4nICsKICAgICcgIH0nICsKCiAgICAvLyBlbHNlIHVzaW5nIGEgZm9yLWluIGxvb3AKICAgICcgIDwlIH0gZWxzZSB7ICU+XG4nICsKICAgICcgIDwlPSBvYmplY3RCcmFuY2guYmVmb3JlTG9vcCAlPjtcbicgKwogICAgJyAgZm9yIChpbmRleCBpbiBpdGVyYXRlZSkgeycgKwogICAgJyAgICA8JSBpZiAoaGFzRG9udEVudW1CdWcpIHsgJT5cbicgKwogICAgJyAgICA8JSAgIGlmICh1c2VIYXMpIHsgJT5pZiAoaGFzT3duUHJvcGVydHkuY2FsbChpdGVyYXRlZSwgaW5kZXgpKSB7XG4gIDwlIH0gJT4nICsKICAgICcgICAgPCU9IG9iamVjdEJyYW5jaC5pbkxvb3AgJT47XG4nICsKICAgICcgICAgPCUgICBpZiAodXNlSGFzKSB7ICU+fTwlIH0gJT4nICsKICAgICcgICAgPCUgfSBlbHNlIHsgJT5cbicgKwoKICAgIC8vIEZpcmVmb3ggPCAzLjYsIE9wZXJhID4gOS41MCAtIE9wZXJhIDwgMTEuNjAsIGFuZCBTYWZhcmkgPCA1LjEKICAgIC8vIChpZiB0aGUgcHJvdG90eXBlIG9yIGEgcHJvcGVydHkgb24gdGhlIHByb3RvdHlwZSBoYXMgYmVlbiBzZXQpCiAgICAvLyBpbmNvcnJlY3RseSBzZXRzIGEgZnVuY3Rpb24ncyBgcHJvdG90eXBlYCBwcm9wZXJ0eSBbW0VudW1lcmFibGVdXQogICAgLy8gdmFsdWUgdG8gYHRydWVgLiBCZWNhdXNlIG9mIHRoaXMgTG8tRGFzaCBzdGFuZGFyZGl6ZXMgb24gc2tpcHBpbmcKICAgIC8vIHRoZSB0aGUgYHByb3RvdHlwZWAgcHJvcGVydHkgb2YgZnVuY3Rpb25zIHJlZ2FyZGxlc3Mgb2YgaXRzCiAgICAvLyBbW0VudW1lcmFibGVdXSB2YWx1ZS4KICAgICcgICAgaWYgKCEoc2tpcFByb3RvICYmIGluZGV4ID09IFwncHJvdG90eXBlXCcpPCUgaWYgKHVzZUhhcykgeyAlPiAmJlxuJyArCiAgICAnICAgICAgICBoYXNPd25Qcm9wZXJ0eS5jYWxsKGl0ZXJhdGVlLCBpbmRleCk8JSB9ICU+KSB7XG4nICsKICAgICcgICAgICA8JT0gb2JqZWN0QnJhbmNoLmluTG9vcCAlPlxuJyArCiAgICAnICAgIH0nICsKICAgICcgICAgPCUgfSAlPlxuJyArCiAgICAnICB9JyArCiAgICAnICA8JSB9ICU+JyArCgogICAgLy8gQmVjYXVzZSBJRSA8IDkgY2FuJ3Qgc2V0IHRoZSBgW1tFbnVtZXJhYmxlXV1gIGF0dHJpYnV0ZSBvZiBhbgogICAgLy8gZXhpc3RpbmcgcHJvcGVydHkgYW5kIHRoZSBgY29uc3RydWN0b3JgIHByb3BlcnR5IG9mIGEgcHJvdG90eXBlCiAgICAvLyBkZWZhdWx0cyB0byBub24tZW51bWVyYWJsZSwgTG8tRGFzaCBza2lwcyB0aGUgYGNvbnN0cnVjdG9yYAogICAgLy8gcHJvcGVydHkgd2hlbiBpdCBpbmZlcnMgaXQncyBpdGVyYXRpbmcgb3ZlciBhIGBwcm90b3R5cGVgIG9iamVjdC4KICAgICcgIDwlIGlmIChoYXNEb250RW51bUJ1ZykgeyAlPlxuXG4nICsKICAgICcgIHZhciBjdG9yID0gaXRlcmF0ZWUuY29uc3RydWN0b3I7XG4nICsKICAgICcgICAgPCUgZm9yICh2YXIgayA9IDA7IGsgPCA3OyBrKyspIHsgJT5cbicgKwogICAgJyAgaW5kZXggPSBcJzwlPSBzaGFkb3dlZFtrXSAlPlwnO1xuJyArCiAgICAnICBpZiAoPCUnICsKICAgICcgICAgICBpZiAoc2hhZG93ZWRba10gPT0gXCdjb25zdHJ1Y3RvclwnKSB7JyArCiAgICAnICAgICAgICAlPiEoY3RvciAmJiBjdG9yLnByb3RvdHlwZSA9PT0gaXRlcmF0ZWUpICYmIDwlJyArCiAgICAnICAgICAgfSAlPmhhc093blByb3BlcnR5LmNhbGwoaXRlcmF0ZWUsIGluZGV4KSkge1xuJyArCiAgICAnICAgIDwlPSBvYmplY3RCcmFuY2guaW5Mb29wICU+XG4nICsKICAgICcgIH0nICsKICAgICcgICAgPCUgfSAlPicgKwogICAgJyAgPCUgfSAlPicgKwogICAgJyAgPCUgaWYgKGFycmF5QnJhbmNoKSB7ICU+XG59PCUgfSAlPicgKwogICAgJzwlIH0gJT5cbicgKwoKICAgIC8vIGFkZCBjb2RlIHRvIHRoZSBib3R0b20gb2YgdGhlIGl0ZXJhdGlvbiBmdW5jdGlvbgogICAgJzwlPSBib3R0b20gJT47XG4nICsKICAgIC8vIGZpbmFsbHksIHJldHVybiB0aGUgYHJlc3VsdGAKICAgICdyZXR1cm4gcmVzdWx0JwogICk7CgogIC8qKgogICAqIFJldXNhYmxlIGl0ZXJhdG9yIG9wdGlvbnMgc2hhcmVkIGJ5CiAgICogYGV2ZXJ5YCwgYGZpbHRlcmAsIGBmaW5kYCwgYGZvckVhY2hgLCBgZm9ySW5gLCBgZm9yT3duYCwgYGdyb3VwQnlgLCBgbWFwYCwKICAgKiBgcmVqZWN0YCwgYHNvbWVgLCBhbmQgYHNvcnRCeWAuCiAgICovCiAgdmFyIGJhc2VJdGVyYXRvck9wdGlvbnMgPSB7CiAgICAnYXJncyc6ICdjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZycsCiAgICAnaW5pdCc6ICdjb2xsZWN0aW9uJywKICAgICd0b3AnOgogICAgICAnaWYgKCFjYWxsYmFjaykge1xuJyArCiAgICAgICcgIGNhbGxiYWNrID0gaWRlbnRpdHlcbicgKwogICAgICAnfVxuJyArCiAgICAgICdlbHNlIGlmICh0aGlzQXJnKSB7XG4nICsKICAgICAgJyAgY2FsbGJhY2sgPSBpdGVyYXRvckJpbmQoY2FsbGJhY2ssIHRoaXNBcmcpXG4nICsKICAgICAgJ30nLAogICAgJ2luTG9vcCc6ICdjYWxsYmFjayhpdGVyYXRlZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKScKICB9OwoKICAvKiogUmV1c2FibGUgaXRlcmF0b3Igb3B0aW9ucyBmb3IgYGV2ZXJ5YCBhbmQgYHNvbWVgICovCiAgdmFyIGV2ZXJ5SXRlcmF0b3JPcHRpb25zID0gewogICAgJ2luaXQnOiAndHJ1ZScsCiAgICAnaW5Mb29wJzogJ2lmICghY2FsbGJhY2soaXRlcmF0ZWVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikpIHJldHVybiAhcmVzdWx0JwogIH07CgogIC8qKiBSZXVzYWJsZSBpdGVyYXRvciBvcHRpb25zIGZvciBgZGVmYXVsdHNgIGFuZCBgZXh0ZW5kYCAqLwogIHZhciBleHRlbmRJdGVyYXRvck9wdGlvbnMgPSB7CiAgICAndXNlSGFzJzogZmFsc2UsCiAgICAndXNlU3RyaWN0JzogZmFsc2UsCiAgICAnYXJncyc6ICdvYmplY3QnLAogICAgJ2luaXQnOiAnb2JqZWN0JywKICAgICd0b3AnOgogICAgICAnZm9yICh2YXIgaXRlcmF0ZWVJbmRleCA9IDEsIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7IGl0ZXJhdGVlSW5kZXggPCBsZW5ndGg7IGl0ZXJhdGVlSW5kZXgrKykge1xuJyArCiAgICAgICcgIGl0ZXJhdGVlID0gYXJndW1lbnRzW2l0ZXJhdGVlSW5kZXhdO1xuJyArCiAgICAgIChoYXNEb250RW51bUJ1ZyA/ICcgIGlmIChpdGVyYXRlZSkgeycgOiAnJyksCiAgICAnaW5Mb29wJzogJ3Jlc3VsdFtpbmRleF0gPSBpdGVyYXRlZVtpbmRleF0nLAogICAgJ2JvdHRvbSc6IChoYXNEb250RW51bUJ1ZyA/ICcgIH1cbicgOiAnJykgKyAnfScKICB9OwoKICAvKiogUmV1c2FibGUgaXRlcmF0b3Igb3B0aW9ucyBmb3IgYGZpbHRlcmAgYW5kIGByZWplY3RgICovCiAgdmFyIGZpbHRlckl0ZXJhdG9yT3B0aW9ucyA9IHsKICAgICdpbml0JzogJ1tdJywKICAgICdpbkxvb3AnOiAnY2FsbGJhY2soaXRlcmF0ZWVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikgJiYgcmVzdWx0LnB1c2goaXRlcmF0ZWVbaW5kZXhdKScKICB9OwoKICAvKiogUmV1c2FibGUgaXRlcmF0b3Igb3B0aW9ucyBmb3IgYGZpbmRgLCBgZm9yRWFjaGAsIGBmb3JJbmAsIGFuZCBgZm9yT3duYCAqLwogIHZhciBmb3JFYWNoSXRlcmF0b3JPcHRpb25zID0gewogICAgJ3RvcCc6ICdpZiAodGhpc0FyZykgY2FsbGJhY2sgPSBpdGVyYXRvckJpbmQoY2FsbGJhY2ssIHRoaXNBcmcpJwogIH07CgogIC8qKiBSZXVzYWJsZSBpdGVyYXRvciBvcHRpb25zIGZvciBgZm9ySW5gIGFuZCBgZm9yT3duYCAqLwogIHZhciBmb3JPd25JdGVyYXRvck9wdGlvbnMgPSB7CiAgICAnaW5Mb29wJzogewogICAgICAnb2JqZWN0JzogYmFzZUl0ZXJhdG9yT3B0aW9ucy5pbkxvb3AKICAgIH0KICB9OwoKICAvKiogUmV1c2FibGUgaXRlcmF0b3Igb3B0aW9ucyBmb3IgYGludm9rZWAsIGBtYXBgLCBgcGx1Y2tgLCBhbmQgYHNvcnRCeWAgKi8KICB2YXIgbWFwSXRlcmF0b3JPcHRpb25zID0gewogICAgJ2luaXQnOiAnJywKICAgICdleGl0JzogJ2lmICghY29sbGVjdGlvbikgcmV0dXJuIFtdJywKICAgICdiZWZvcmVMb29wJzogewogICAgICAnYXJyYXknOiAgJ3Jlc3VsdCA9IEFycmF5KGxlbmd0aCknLAogICAgICAnb2JqZWN0JzogJ3Jlc3VsdCA9ICcgKyAoaXNLZXlzRmFzdCA/ICdBcnJheShsZW5ndGgpJyA6ICdbXScpCiAgICB9LAogICAgJ2luTG9vcCc6IHsKICAgICAgJ2FycmF5JzogICdyZXN1bHRbaW5kZXhdID0gY2FsbGJhY2soaXRlcmF0ZWVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbiknLAogICAgICAnb2JqZWN0JzogJ3Jlc3VsdCcgKyAoaXNLZXlzRmFzdCA/ICdbcHJvcEluZGV4XSA9ICcgOiAnLnB1c2gnKSArICcoY2FsbGJhY2soaXRlcmF0ZWVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikpJwogICAgfQogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGVzIGNvbXBpbGVkIGl0ZXJhdGlvbiBmdW5jdGlvbnMuIFRoZSBpdGVyYXRpb24gZnVuY3Rpb24gd2lsbCBiZSBjcmVhdGVkCiAgICogdG8gaXRlcmF0ZSBvdmVyIG9ubHkgb2JqZWN0cyBpZiB0aGUgZmlyc3QgYXJndW1lbnQgb2YgYG9wdGlvbnMuYXJnc2AgaXMKICAgKiAib2JqZWN0IiBvciBgb3B0aW9ucy5pbkxvb3AuYXJyYXlgIGlzIGZhbHNleS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zMSwgb3B0aW9uczIsIC4uLl0gVGhlIGNvbXBpbGUgb3B0aW9ucyBvYmplY3RzLgogICAqCiAgICogIHVzZUhhcyAtIEEgYm9vbGVhbiB0byBzcGVjaWZ5IHdoZXRoZXIgb3Igbm90IHRvIHVzZSBgaGFzT3duUHJvcGVydHlgIGNoZWNrcwogICAqICAgaW4gdGhlIG9iamVjdCBsb29wLgogICAqCiAgICogIHVzZVN0cmljdCAtIEEgYm9vbGVhbiB0byBzcGVjaWZ5IHdoZXRoZXIgb3Igbm90IHRvIGluY2x1ZGUgdGhlIEVTNQogICAqICAgInVzZSBzdHJpY3QiIGRpcmVjdGl2ZS4KICAgKgogICAqICBhcmdzIC0gQSBzdHJpbmcgb2YgY29tbWEgc2VwYXJhdGVkIGFyZ3VtZW50cyB0aGUgaXRlcmF0aW9uIGZ1bmN0aW9uIHdpbGwKICAgKiAgIGFjY2VwdC4KICAgKgogICAqICBpbml0IC0gQSBzdHJpbmcgdG8gc3BlY2lmeSB0aGUgaW5pdGlhbCB2YWx1ZSBvZiB0aGUgYHJlc3VsdGAgdmFyaWFibGUuCiAgICoKICAgKiAgZXhpdCAtIEEgc3RyaW5nIG9mIGNvZGUgdG8gdXNlIGluIHBsYWNlIG9mIHRoZSBkZWZhdWx0IGV4aXQtZWFybHkgY2hlY2sKICAgKiAgIG9mIGBpZiAoIWFyZ3VtZW50c1swXSkgcmV0dXJuIHJlc3VsdGAuCiAgICoKICAgKiAgdG9wIC0gQSBzdHJpbmcgb2YgY29kZSB0byBleGVjdXRlIGFmdGVyIHRoZSBleGl0LWVhcmx5IGNoZWNrIGJ1dCBiZWZvcmUKICAgKiAgIHRoZSBpdGVyYXRpb24gYnJhbmNoZXMuCiAgICoKICAgKiAgYmVmb3JlTG9vcCAtIEEgc3RyaW5nIG9yIG9iamVjdCBjb250YWluaW5nIGFuICJhcnJheSIgb3IgIm9iamVjdCIgcHJvcGVydHkKICAgKiAgIG9mIGNvZGUgdG8gZXhlY3V0ZSBiZWZvcmUgdGhlIGFycmF5IG9yIG9iamVjdCBsb29wcy4KICAgKgogICAqICBpbkxvb3AgLSBBIHN0cmluZyBvciBvYmplY3QgY29udGFpbmluZyBhbiAiYXJyYXkiIG9yICJvYmplY3QiIHByb3BlcnR5CiAgICogICBvZiBjb2RlIHRvIGV4ZWN1dGUgaW4gdGhlIGFycmF5IG9yIG9iamVjdCBsb29wcy4KICAgKgogICAqICBib3R0b20gLSBBIHN0cmluZyBvZiBjb2RlIHRvIGV4ZWN1dGUgYWZ0ZXIgdGhlIGl0ZXJhdGlvbiBicmFuY2hlcyBidXQKICAgKiAgIGJlZm9yZSB0aGUgYHJlc3VsdGAgaXMgcmV0dXJuZWQuCiAgICoKICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZUl0ZXJhdG9yKCkgewogICAgdmFyIG9iamVjdCwKICAgICAgICBwcm9wLAogICAgICAgIHZhbHVlLAogICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDsKCiAgICAvLyBtZXJnZSBvcHRpb25zIGludG8gYSB0ZW1wbGF0ZSBkYXRhIG9iamVjdAogICAgdmFyIGRhdGEgPSB7CiAgICAgICdib3R0b20nOiAnJywKICAgICAgJ2V4aXQnOiAnJywKICAgICAgJ2luaXQnOiAnJywKICAgICAgJ3RvcCc6ICcnLAogICAgICAnYXJyYXlCcmFuY2gnOiB7ICdiZWZvcmVMb29wJzogJycgfSwKICAgICAgJ29iamVjdEJyYW5jaCc6IHsgJ2JlZm9yZUxvb3AnOiAnJyB9CiAgICB9OwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIG9iamVjdCA9IGFyZ3VtZW50c1tpbmRleF07CiAgICAgIGZvciAocHJvcCBpbiBvYmplY3QpIHsKICAgICAgICB2YWx1ZSA9ICh2YWx1ZSA9IG9iamVjdFtwcm9wXSkgPT0gbnVsbCA/ICcnIDogdmFsdWU7CiAgICAgICAgLy8ga2VlcCB0aGlzIHJlZ2V4cCBleHBsaWNpdCBmb3IgdGhlIGJ1aWxkIHByZS1wcm9jZXNzCiAgICAgICAgaWYgKC9iZWZvcmVMb29wfGluTG9vcC8udGVzdChwcm9wKSkgewogICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJykgewogICAgICAgICAgICB2YWx1ZSA9IHsgJ2FycmF5JzogdmFsdWUsICdvYmplY3QnOiB2YWx1ZSB9OwogICAgICAgICAgfQogICAgICAgICAgZGF0YS5hcnJheUJyYW5jaFtwcm9wXSA9IHZhbHVlLmFycmF5OwogICAgICAgICAgZGF0YS5vYmplY3RCcmFuY2hbcHJvcF0gPSB2YWx1ZS5vYmplY3Q7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRhdGFbcHJvcF0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIHNldCBhZGRpdGlvbmFsIHRlbXBsYXRlIGBkYXRhYCB2YWx1ZXMKICAgIHZhciBhcmdzID0gZGF0YS5hcmdzLAogICAgICAgIGZpcnN0QXJnID0gL15bXixdKy8uZXhlYyhhcmdzKVswXTsKCiAgICBkYXRhLmZpcnN0QXJnID0gZmlyc3RBcmc7CiAgICBkYXRhLmhhc0RvbnRFbnVtQnVnID0gaGFzRG9udEVudW1CdWc7CiAgICBkYXRhLmlzS2V5c0Zhc3QgPSBpc0tleXNGYXN0OwogICAgZGF0YS5zaGFkb3dlZCA9IHNoYWRvd2VkOwogICAgZGF0YS51c2VIYXMgPSBkYXRhLnVzZUhhcyAhPT0gZmFsc2U7CiAgICBkYXRhLnVzZVN0cmljdCA9IGRhdGEudXNlU3RyaWN0ICE9PSBmYWxzZTsKCiAgICBpZiAoISgnbm9DaGFyQnlJbmRleCcgaW4gZGF0YSkpIHsKICAgICAgZGF0YS5ub0NoYXJCeUluZGV4ID0gbm9DaGFyQnlJbmRleDsKICAgIH0KICAgIGlmICghZGF0YS5leGl0KSB7CiAgICAgIGRhdGEuZXhpdCA9ICdpZiAoIScgKyBmaXJzdEFyZyArICcpIHJldHVybiByZXN1bHQnOwogICAgfQogICAgaWYgKGZpcnN0QXJnICE9ICdjb2xsZWN0aW9uJyB8fCAhZGF0YS5hcnJheUJyYW5jaC5pbkxvb3ApIHsKICAgICAgZGF0YS5hcnJheUJyYW5jaCA9IG51bGw7CiAgICB9CiAgICAvLyBjcmVhdGUgdGhlIGZ1bmN0aW9uIGZhY3RvcnkKICAgIHZhciBmYWN0b3J5ID0gRnVuY3Rpb24oCiAgICAgICAgJ2FycmF5Q2xhc3MsIGJpbmQsIGNvbXBhcmVBc2NlbmRpbmcsIGZ1bmNDbGFzcywgaGFzT3duUHJvcGVydHksIGlkZW50aXR5LCAnICsKICAgICAgICAnaXRlcmF0b3JCaW5kLCBvYmplY3RUeXBlcywgbmF0aXZlS2V5cywgcHJvcGVydHlJc0VudW1lcmFibGUsIHNsaWNlLCAnICsKICAgICAgICAnc3RyaW5nQ2xhc3MsIHRvU3RyaW5nJywKICAgICAgJ3JldHVybiBmdW5jdGlvbignICsgYXJncyArICcpIHtcbicgKyBpdGVyYXRvclRlbXBsYXRlKGRhdGEpICsgJ1xufScKICAgICk7CiAgICAvLyByZXR1cm4gdGhlIGNvbXBpbGVkIGZ1bmN0aW9uCiAgICByZXR1cm4gZmFjdG9yeSgKICAgICAgYXJyYXlDbGFzcywgYmluZCwgY29tcGFyZUFzY2VuZGluZywgZnVuY0NsYXNzLCBoYXNPd25Qcm9wZXJ0eSwgaWRlbnRpdHksCiAgICAgIGl0ZXJhdG9yQmluZCwgb2JqZWN0VHlwZXMsIG5hdGl2ZUtleXMsIHByb3BlcnR5SXNFbnVtZXJhYmxlLCBzbGljZSwKICAgICAgc3RyaW5nQ2xhc3MsIHRvU3RyaW5nCiAgICApOwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgc29ydEJ5YCB0byBjb21wYXJlIHRyYW5zZm9ybWVkIHZhbHVlcyBvZiBgY29sbGVjdGlvbmAsIHNvcnRpbmcKICAgKiB0aGVtIGluIGFzY2VuZGluZyBvcmRlci4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IGEgVGhlIG9iamVjdCB0byBjb21wYXJlIHRvIGBiYC4KICAgKiBAcGFyYW0ge09iamVjdH0gYiBUaGUgb2JqZWN0IHRvIGNvbXBhcmUgdG8gYGFgLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgYC0xYCBpZiBgYWAgPCBgYmAsIGAwYCBpZiBgYWAgPT0gYGJgLCBvciBgMWAgaWYgYGFgID4gYGJgLgogICAqLwogIGZ1bmN0aW9uIGNvbXBhcmVBc2NlbmRpbmcoYSwgYikgewogICAgYSA9IGEuY3JpdGVyaWE7CiAgICBiID0gYi5jcml0ZXJpYTsKCiAgICBpZiAoYSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiAxOwogICAgfQogICAgaWYgKGIgPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgICByZXR1cm4gYSA8IGIgPyAtMSA6IGEgPiBiID8gMSA6IDA7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGB0ZW1wbGF0ZWAgdG8gcmVwbGFjZSB0b2tlbnMgd2l0aCB0aGVpciBjb3JyZXNwb25kaW5nIGNvZGUgc25pcHBldHMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCB0b2tlbi4KICAgKiBAcGFyYW0ge1N0cmluZ30gaW5kZXggVGhlIGB0b2tlbml6ZWRgIGluZGV4IG9mIHRoZSBjb2RlIHNuaXBwZXQuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgY29kZSBzbmlwcGV0LgogICAqLwogIGZ1bmN0aW9uIGRldG9rZW5pemUobWF0Y2gsIGluZGV4KSB7CiAgICByZXR1cm4gdG9rZW5pemVkW2luZGV4XTsKICB9CgogIC8qKgogICAqIFVzZWQgYnkgYHRlbXBsYXRlYCB0byBlc2NhcGUgY2hhcmFjdGVycyBmb3IgaW5jbHVzaW9uIGluIGNvbXBpbGVkCiAgICogc3RyaW5nIGxpdGVyYWxzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge1N0cmluZ30gbWF0Y2ggVGhlIG1hdGNoZWQgY2hhcmFjdGVyIHRvIGVzY2FwZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIGNoYXJhY3Rlci4KICAgKi8KICBmdW5jdGlvbiBlc2NhcGVTdHJpbmdDaGFyKG1hdGNoKSB7CiAgICByZXR1cm4gJ1xcJyArIHN0cmluZ0VzY2FwZXNbbWF0Y2hdOwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgZXNjYXBlYCB0byBlc2NhcGUgY2hhcmFjdGVycyBmb3IgaW5jbHVzaW9uIGluIEhUTUwuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCBjaGFyYWN0ZXIgdG8gZXNjYXBlLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIGVzY2FwZWQgY2hhcmFjdGVyLgogICAqLwogIGZ1bmN0aW9uIGVzY2FwZUh0bWxDaGFyKG1hdGNoKSB7CiAgICByZXR1cm4gaHRtbEVzY2FwZXNbbWF0Y2hdOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgaW52b2tlcyBgZnVuY2Agd2l0aCB0aGUgYHRoaXNgCiAgICogYmluZGluZyBvZiBgdGhpc0FyZ2AgYW5kIHRoZSBhcmd1bWVudHMgKHZhbHVlLCBpbmRleCwgb2JqZWN0KS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gYmluZC4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBmdW5jYC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgKi8KICBmdW5jdGlvbiBpdGVyYXRvckJpbmQoZnVuYywgdGhpc0FyZykgewogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpc0FyZywgdmFsdWUsIGluZGV4LCBvYmplY3QpOwogICAgfTsKICB9CgogIC8qKgogICAqIEEgbm8tb3BlcmF0aW9uIGZ1bmN0aW9uLgogICAqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBub29wKCkgewogICAgLy8gbm8gb3BlcmF0aW9uIHBlcmZvcm1lZAogIH0KCiAgLyoqCiAgICogQSBzaGltIGltcGxlbWVudGF0aW9uIG9mIGBPYmplY3Qua2V5c2AgdGhhdCBwcm9kdWNlcyBhbiBhcnJheSBvZiB0aGUgZ2l2ZW4KICAgKiBvYmplY3QncyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0eSBuYW1lcy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IG5hbWVzLgogICAqLwogIHZhciBzaGltS2V5cyA9IGNyZWF0ZUl0ZXJhdG9yKHsKICAgICdhcmdzJzogJ29iamVjdCcsCiAgICAnZXhpdCc6ICdpZiAoIShvYmplY3QgJiYgb2JqZWN0VHlwZXNbdHlwZW9mIG9iamVjdF0pKSB0aHJvdyBUeXBlRXJyb3IoKScsCiAgICAnaW5pdCc6ICdbXScsCiAgICAnaW5Mb29wJzogJ3Jlc3VsdC5wdXNoKGluZGV4KScKICB9KTsKCiAgLyoqCiAgICogVXNlZCBieSBgdGVtcGxhdGVgIHRvIHJlcGxhY2UgImVzY2FwZSIgdGVtcGxhdGUgZGVsaW1pdGVycyB3aXRoIHRva2Vucy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIHRlbXBsYXRlIGRlbGltaXRlci4KICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUgVGhlIGRlbGltaXRlciB2YWx1ZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIGEgdG9rZW4uCiAgICovCiAgZnVuY3Rpb24gdG9rZW5pemVFc2NhcGUobWF0Y2gsIHZhbHVlKSB7CiAgICBpZiAocmVDb21wbGV4RGVsaW1pdGVyLnRlc3QodmFsdWUpKSB7CiAgICAgIHJldHVybiAnPGUlLScgKyB2YWx1ZSArICclPic7CiAgICB9CiAgICB2YXIgaW5kZXggPSB0b2tlbml6ZWQubGVuZ3RoOwogICAgdG9rZW5pemVkW2luZGV4XSA9ICInICtcbl9fZSgiICsgdmFsdWUgKyAiKSArXG4nIjsKICAgIHJldHVybiB0b2tlbiArIGluZGV4OwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgdGVtcGxhdGVgIHRvIHJlcGxhY2UgImV2YWx1YXRlIiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBvciBjb21wbGV4CiAgICogImVzY2FwZSIgYW5kICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVycywgd2l0aCB0b2tlbnMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCB0ZW1wbGF0ZSBkZWxpbWl0ZXIuCiAgICogQHBhcmFtIHtTdHJpbmd9IHZhbHVlIFRoZSBkZWxpbWl0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtTdHJpbmd9IGVzY2FwZVZhbHVlIFRoZSAiZXNjYXBlIiBkZWxpbWl0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtTdHJpbmd9IGludGVycG9sYXRlVmFsdWUgVGhlICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVyIHZhbHVlLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgYSB0b2tlbi4KICAgKi8KICBmdW5jdGlvbiB0b2tlbml6ZUV2YWx1YXRlKG1hdGNoLCB2YWx1ZSwgZXNjYXBlVmFsdWUsIGludGVycG9sYXRlVmFsdWUpIHsKICAgIHZhciBpbmRleCA9IHRva2VuaXplZC5sZW5ndGg7CiAgICBpZiAodmFsdWUpIHsKICAgICAgdG9rZW5pemVkW2luZGV4XSA9ICInO1xuIiArIHZhbHVlICsgIjtcbl9fcCArPSAnIgogICAgfSBlbHNlIGlmIChlc2NhcGVWYWx1ZSkgewogICAgICB0b2tlbml6ZWRbaW5kZXhdID0gIicgK1xuX19lKCIgKyBlc2NhcGVWYWx1ZSArICIpICtcbiciOwogICAgfSBlbHNlIGlmIChpbnRlcnBvbGF0ZVZhbHVlKSB7CiAgICAgIHRva2VuaXplZFtpbmRleF0gPSAiJyArXG4oKF9fdCA9ICgiICsgaW50ZXJwb2xhdGVWYWx1ZSArICIpKSA9PSBudWxsID8gJycgOiBfX3QpICtcbiciOwogICAgfQogICAgcmV0dXJuIHRva2VuICsgaW5kZXg7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGB0ZW1wbGF0ZWAgdG8gcmVwbGFjZSAiaW50ZXJwb2xhdGUiIHRlbXBsYXRlIGRlbGltaXRlcnMgd2l0aCB0b2tlbnMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCB0ZW1wbGF0ZSBkZWxpbWl0ZXIuCiAgICogQHBhcmFtIHtTdHJpbmd9IHZhbHVlIFRoZSBkZWxpbWl0ZXIgdmFsdWUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyBhIHRva2VuLgogICAqLwogIGZ1bmN0aW9uIHRva2VuaXplSW50ZXJwb2xhdGUobWF0Y2gsIHZhbHVlKSB7CiAgICBpZiAocmVDb21wbGV4RGVsaW1pdGVyLnRlc3QodmFsdWUpKSB7CiAgICAgIHJldHVybiAnPGUlPScgKyB2YWx1ZSArICclPic7CiAgICB9CiAgICB2YXIgaW5kZXggPSB0b2tlbml6ZWQubGVuZ3RoOwogICAgdG9rZW5pemVkW2luZGV4XSA9ICInICtcbigoX190ID0gKCIgKyB2YWx1ZSArICIpKSA9PSBudWxsID8gJycgOiBfX3QpICtcbiciOwogICAgcmV0dXJuIHRva2VuICsgaW5kZXg7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGEgZ2l2ZW4gYHRhcmdldGAgdmFsdWUgaXMgcHJlc2VudCBpbiBhIGBjb2xsZWN0aW9uYCB1c2luZyBzdHJpY3QKICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgaW5jbHVkZQogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtNaXhlZH0gdGFyZ2V0IFRoZSB2YWx1ZSB0byBjaGVjayBmb3IuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB0YXJnZXRgIHZhbHVlIGlzIGZvdW5kLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uY29udGFpbnMoWzEsIDIsIDNdLCAzKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmNvbnRhaW5zKHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sICdtb2UnKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmNvbnRhaW5zKCdjdXJseScsICd1cicpOwogICAqIC8vID0+IHRydWUKICAgKi8KICB2YXIgY29udGFpbnMgPSBjcmVhdGVJdGVyYXRvcih7CiAgICAnYXJncyc6ICdjb2xsZWN0aW9uLCB0YXJnZXQnLAogICAgJ2luaXQnOiAnZmFsc2UnLAogICAgJ25vQ2hhckJ5SW5kZXgnOiBmYWxzZSwKICAgICdiZWZvcmVMb29wJzogewogICAgICAnYXJyYXknOiAnaWYgKHRvU3RyaW5nLmNhbGwoaXRlcmF0ZWUpID09IHN0cmluZ0NsYXNzKSByZXR1cm4gY29sbGVjdGlvbi5pbmRleE9mKHRhcmdldCkgPiAtMScKICAgIH0sCiAgICAnaW5Mb29wJzogJ2lmIChpdGVyYXRlZVtpbmRleF0gPT09IHRhcmdldCkgcmV0dXJuIHRydWUnCiAgfSk7CgogIC8qKgogICAqIENoZWNrcyBpZiB0aGUgYGNhbGxiYWNrYCByZXR1cm5zIGEgdHJ1dGh5IHZhbHVlIGZvciAqKmFsbCoqIGVsZW1lbnRzIG9mIGEKICAgKiBgY29sbGVjdGlvbmAuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIDMKICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBhbGwKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYWxsIHZhbHVlcyBwYXNzIHRoZSBjYWxsYmFjayBjaGVjaywgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmV2ZXJ5KFt0cnVlLCAxLCBudWxsLCAneWVzJ10sIEJvb2xlYW4pOwogICAqIC8vID0+IGZhbHNlCiAgICovCiAgdmFyIGV2ZXJ5ID0gY3JlYXRlSXRlcmF0b3IoYmFzZUl0ZXJhdG9yT3B0aW9ucywgZXZlcnlJdGVyYXRvck9wdGlvbnMpOwoKICAvKioKICAgKiBFeGFtaW5lcyBlYWNoIHZhbHVlIGluIGEgYGNvbGxlY3Rpb25gLCByZXR1cm5pbmcgYW4gYXJyYXkgb2YgYWxsIHZhbHVlcyB0aGUKICAgKiBgY2FsbGJhY2tgIHJldHVybnMgdHJ1dGh5IGZvci4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZAogICAqIGludm9rZWQgd2l0aCAzIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIHNlbGVjdAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiB2YWx1ZXMgdGhhdCBwYXNzZWQgY2FsbGJhY2sgY2hlY2suCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBldmVucyA9IF8uZmlsdGVyKFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAqIC8vID0+IFsyLCA0LCA2XQogICAqLwogIHZhciBmaWx0ZXIgPSBjcmVhdGVJdGVyYXRvcihiYXNlSXRlcmF0b3JPcHRpb25zLCBmaWx0ZXJJdGVyYXRvck9wdGlvbnMpOwoKICAvKioKICAgKiBFeGFtaW5lcyBlYWNoIHZhbHVlIGluIGEgYGNvbGxlY3Rpb25gLCByZXR1cm5pbmcgdGhlIGZpcnN0IG9uZSB0aGUgYGNhbGxiYWNrYAogICAqIHJldHVybnMgdHJ1dGh5IGZvci4gVGhlIGZ1bmN0aW9uIHJldHVybnMgYXMgc29vbiBhcyBpdCBmaW5kcyBhbiBhY2NlcHRhYmxlCiAgICogdmFsdWUsIGFuZCBkb2VzIG5vdCBpdGVyYXRlIG92ZXIgdGhlIGVudGlyZSBgY29sbGVjdGlvbmAuIFRoZSBgY2FsbGJhY2tgIGlzCiAgICogYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggMyBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBkZXRlY3QKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2suCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSB2YWx1ZSB0aGF0IHBhc3NlZCB0aGUgY2FsbGJhY2sgY2hlY2ssIGVsc2UgYHVuZGVmaW5lZGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBldmVuID0gXy5maW5kKFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAqIC8vID0+IDIKICAgKi8KICB2YXIgZmluZCA9IGNyZWF0ZUl0ZXJhdG9yKGJhc2VJdGVyYXRvck9wdGlvbnMsIGZvckVhY2hJdGVyYXRvck9wdGlvbnMsIHsKICAgICdpbml0JzogJycsCiAgICAnaW5Mb29wJzogJ2lmIChjYWxsYmFjayhpdGVyYXRlZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSkgcmV0dXJuIGl0ZXJhdGVlW2luZGV4XScKICB9KTsKCiAgLyoqCiAgICogSXRlcmF0ZXMgb3ZlciBhIGBjb2xsZWN0aW9uYCwgZXhlY3V0aW5nIHRoZSBgY2FsbGJhY2tgIGZvciBlYWNoIHZhbHVlIGluIHRoZQogICAqIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggMwogICAqIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGVhY2gKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2suCiAgICogQHJldHVybnMge0FycmF5fE9iamVjdH0gUmV0dXJucyB0aGUgYGNvbGxlY3Rpb25gLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfKFsxLCAyLCAzXSkuZm9yRWFjaChhbGVydCkuam9pbignLCcpOwogICAqIC8vID0+IGFsZXJ0cyBlYWNoIG51bWJlciBhbmQgcmV0dXJucyAnMSwyLDMnCiAgICoKICAgKiBfLmZvckVhY2goeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSwgYWxlcnQpOwogICAqIC8vID0+IGFsZXJ0cyBlYWNoIG51bWJlciAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgdmFyIGZvckVhY2ggPSBjcmVhdGVJdGVyYXRvcihiYXNlSXRlcmF0b3JPcHRpb25zLCBmb3JFYWNoSXRlcmF0b3JPcHRpb25zKTsKCiAgLyoqCiAgICogU3BsaXRzIGBjb2xsZWN0aW9uYCBpbnRvIHNldHMsIGdyb3VwZWQgYnkgdGhlIHJlc3VsdCBvZiBydW5uaW5nIGVhY2ggdmFsdWUKICAgKiB0aHJvdWdoIGBjYWxsYmFja2AuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoCiAgICogMyBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4gVGhlIGBjYWxsYmFja2AgYXJndW1lbnQgbWF5CiAgICogYWxzbyBiZSB0aGUgbmFtZSBvZiBhIHByb3BlcnR5IHRvIGdyb3VwIGJ5LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uIG9yCiAgICogIHByb3BlcnR5IG5hbWUgdG8gZ3JvdXAgYnkuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYW4gb2JqZWN0IG9mIGdyb3VwZWQgdmFsdWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmdyb3VwQnkoWzEuMywgMi4xLCAyLjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguZmxvb3IobnVtKTsgfSk7CiAgICogLy8gPT4geyAnMSc6IFsxLjNdLCAnMic6IFsyLjEsIDIuNF0gfQogICAqCiAgICogXy5ncm91cEJ5KFsxLjMsIDIuMSwgMi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiB0aGlzLmZsb29yKG51bSk7IH0sIE1hdGgpOwogICAqIC8vID0+IHsgJzEnOiBbMS4zXSwgJzInOiBbMi4xLCAyLjRdIH0KICAgKgogICAqIF8uZ3JvdXBCeShbJ29uZScsICd0d28nLCAndGhyZWUnXSwgJ2xlbmd0aCcpOwogICAqIC8vID0+IHsgJzMnOiBbJ29uZScsICd0d28nXSwgJzUnOiBbJ3RocmVlJ10gfQogICAqLwogIHZhciBncm91cEJ5ID0gY3JlYXRlSXRlcmF0b3IoYmFzZUl0ZXJhdG9yT3B0aW9ucywgewogICAgJ2luaXQnOiAne30nLAogICAgJ3RvcCc6CiAgICAgICd2YXIgcHJvcCwgaXNGdW5jID0gdHlwZW9mIGNhbGxiYWNrID09IFwnZnVuY3Rpb25cJztcbicgKwogICAgICAnaWYgKGlzRnVuYyAmJiB0aGlzQXJnKSBjYWxsYmFjayA9IGl0ZXJhdG9yQmluZChjYWxsYmFjaywgdGhpc0FyZyknLAogICAgJ2luTG9vcCc6CiAgICAgICdwcm9wID0gaXNGdW5jXG4nICsKICAgICAgJyAgPyBjYWxsYmFjayhpdGVyYXRlZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKVxuJyArCiAgICAgICcgIDogaXRlcmF0ZWVbaW5kZXhdW2NhbGxiYWNrXTtcbicgKwogICAgICAnKGhhc093blByb3BlcnR5LmNhbGwocmVzdWx0LCBwcm9wKSA/IHJlc3VsdFtwcm9wXSA6IHJlc3VsdFtwcm9wXSA9IFtdKS5wdXNoKGl0ZXJhdGVlW2luZGV4XSknCiAgfSk7CgogIC8qKgogICAqIEludm9rZXMgdGhlIG1ldGhvZCBuYW1lZCBieSBgbWV0aG9kTmFtZWAgb24gZWFjaCBlbGVtZW50IGluIHRoZSBgY29sbGVjdGlvbmAuCiAgICogQWRkaXRpb25hbCBhcmd1bWVudHMgd2lsbCBiZSBwYXNzZWQgdG8gZWFjaCBpbnZva2VkIG1ldGhvZC4gSWYgYG1ldGhvZE5hbWVgCiAgICogaXMgYSBmdW5jdGlvbiBpdCB3aWxsIGJlIGludm9rZWQgZm9yLCBhbmQgYHRoaXNgIGJvdW5kIHRvLCBlYWNoIGVsZW1lbnQKICAgKiBpbiB0aGUgYGNvbGxlY3Rpb25gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kTmFtZSBUaGUgbmFtZSBvZiB0aGUgbWV0aG9kIHRvIGludm9rZSBvcgogICAqICB0aGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIG1ldGhvZCB3aXRoLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiB2YWx1ZXMgcmV0dXJuZWQgZnJvbSBlYWNoIGludm9rZWQgbWV0aG9kLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmludm9rZShbWzUsIDEsIDddLCBbMywgMiwgMV1dLCAnc29ydCcpOwogICAqIC8vID0+IFtbMSwgNSwgN10sIFsxLCAyLCAzXV0KICAgKgogICAqIF8uaW52b2tlKFsxMjMsIDQ1Nl0sIFN0cmluZy5wcm90b3R5cGUuc3BsaXQsICcnKTsKICAgKiAvLyA9PiBbWycxJywgJzInLCAnMyddLCBbJzQnLCAnNScsICc2J11dCiAgICovCiAgdmFyIGludm9rZSA9IGNyZWF0ZUl0ZXJhdG9yKG1hcEl0ZXJhdG9yT3B0aW9ucywgewogICAgJ2FyZ3MnOiAnY29sbGVjdGlvbiwgbWV0aG9kTmFtZScsCiAgICAndG9wJzoKICAgICAgJ3ZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLFxuJyArCiAgICAgICcgICAgaXNGdW5jID0gdHlwZW9mIG1ldGhvZE5hbWUgPT0gXCdmdW5jdGlvblwnJywKICAgICdpbkxvb3AnOiB7CiAgICAgICdhcnJheSc6CiAgICAgICAgJ3Jlc3VsdFtpbmRleF0gPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSknICsKICAgICAgICAnLmFwcGx5KGl0ZXJhdGVlW2luZGV4XSwgYXJncyknLAogICAgICAnb2JqZWN0JzoKICAgICAgICAncmVzdWx0JyArIChpc0tleXNGYXN0ID8gJ1twcm9wSW5kZXhdID0gJyA6ICcucHVzaCcpICsKICAgICAgICAnKChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKS5hcHBseShpdGVyYXRlZVtpbmRleF0sIGFyZ3MpKScKICAgIH0KICB9KTsKCiAgLyoqCiAgICogUHJvZHVjZXMgYSBuZXcgYXJyYXkgb2YgdmFsdWVzIGJ5IG1hcHBpbmcgZWFjaCBlbGVtZW50IGluIHRoZSBgY29sbGVjdGlvbmAKICAgKiB0aHJvdWdoIGEgdHJhbnNmb3JtYXRpb24gYGNhbGxiYWNrYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgCiAgICogYW5kIGludm9rZWQgd2l0aCAzIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGNvbGxlY3QKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdmFsdWVzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFjay4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5tYXAoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAqIDM7IH0pOwogICAqIC8vID0+IFszLCA2LCA5XQogICAqCiAgICogXy5tYXAoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiAzOyB9KTsKICAgKiAvLyA9PiBbMywgNiwgOV0gKG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkKQogICAqLwogIHZhciBtYXAgPSBjcmVhdGVJdGVyYXRvcihiYXNlSXRlcmF0b3JPcHRpb25zLCBtYXBJdGVyYXRvck9wdGlvbnMpOwoKICAvKioKICAgKiBSZXRyaWV2ZXMgdGhlIHZhbHVlIG9mIGEgc3BlY2lmaWVkIHByb3BlcnR5IGZyb20gYWxsIGVsZW1lbnRzIGluCiAgICogdGhlIGBjb2xsZWN0aW9uYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBwbHVjay4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgdmFsdWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICogICB7ICduYW1lJzogJ2xhcnJ5JywgJ2FnZSc6IDUwIH0sCiAgICogICB7ICduYW1lJzogJ2N1cmx5JywgJ2FnZSc6IDYwIH0KICAgKiBdOwogICAqCiAgICogXy5wbHVjayhzdG9vZ2VzLCAnbmFtZScpOwogICAqIC8vID0+IFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10KICAgKi8KICB2YXIgcGx1Y2sgPSBjcmVhdGVJdGVyYXRvcihtYXBJdGVyYXRvck9wdGlvbnMsIHsKICAgICdhcmdzJzogJ2NvbGxlY3Rpb24sIHByb3BlcnR5JywKICAgICdpbkxvb3AnOiB7CiAgICAgICdhcnJheSc6ICAncmVzdWx0W2luZGV4XSA9IGl0ZXJhdGVlW2luZGV4XVtwcm9wZXJ0eV0nLAogICAgICAnb2JqZWN0JzogJ3Jlc3VsdCcgKyAoaXNLZXlzRmFzdCA/ICdbcHJvcEluZGV4XSA9ICcgOiAnLnB1c2gnKSArICcoaXRlcmF0ZWVbaW5kZXhdW3Byb3BlcnR5XSknCiAgICB9CiAgfSk7CgogIC8qKgogICAqIEJvaWxzIGRvd24gYSBgY29sbGVjdGlvbmAgdG8gYSBzaW5nbGUgdmFsdWUuIFRoZSBpbml0aWFsIHN0YXRlIG9mIHRoZQogICAqIHJlZHVjdGlvbiBpcyBgYWNjdW11bGF0b3JgIGFuZCBlYWNoIHN1Y2Nlc3NpdmUgc3RlcCBvZiBpdCBzaG91bGQgYmUgcmV0dXJuZWQKICAgKiBieSB0aGUgYGNhbGxiYWNrYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggNAogICAqIGFyZ3VtZW50czsgZm9yIGFycmF5cyB0aGV5IGFyZSAoYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGZvbGRsLCBpbmplY3QKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYWNjdW11bGF0b3JdIEluaXRpYWwgdmFsdWUgb2YgdGhlIGFjY3VtdWxhdG9yLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3VtID0gXy5yZWR1Y2UoWzEsIDIsIDNdLCBmdW5jdGlvbihtZW1vLCBudW0pIHsgcmV0dXJuIG1lbW8gKyBudW07IH0pOwogICAqIC8vID0+IDYKICAgKi8KICB2YXIgcmVkdWNlID0gY3JlYXRlSXRlcmF0b3IoewogICAgJ2FyZ3MnOiAnY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnJywKICAgICdpbml0JzogJ2FjY3VtdWxhdG9yJywKICAgICd0b3AnOgogICAgICAndmFyIG5vYWNjdW0gPSBhcmd1bWVudHMubGVuZ3RoIDwgMztcbicgKwogICAgICAnaWYgKHRoaXNBcmcpIGNhbGxiYWNrID0gaXRlcmF0b3JCaW5kKGNhbGxiYWNrLCB0aGlzQXJnKScsCiAgICAnYmVmb3JlTG9vcCc6IHsKICAgICAgJ2FycmF5JzogJ2lmIChub2FjY3VtKSByZXN1bHQgPSBjb2xsZWN0aW9uWysraW5kZXhdJwogICAgfSwKICAgICdpbkxvb3AnOiB7CiAgICAgICdhcnJheSc6CiAgICAgICAgJ3Jlc3VsdCA9IGNhbGxiYWNrKHJlc3VsdCwgaXRlcmF0ZWVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbiknLAogICAgICAnb2JqZWN0JzoKICAgICAgICAncmVzdWx0ID0gbm9hY2N1bVxuJyArCiAgICAgICAgJyAgPyAobm9hY2N1bSA9IGZhbHNlLCBpdGVyYXRlZVtpbmRleF0pXG4nICsKICAgICAgICAnICA6IGNhbGxiYWNrKHJlc3VsdCwgaXRlcmF0ZWVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbiknCiAgICB9CiAgfSk7CgogIC8qKgogICAqIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIGBfLnJlZHVjZWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZm9sZHIKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYWNjdW11bGF0b3JdIEluaXRpYWwgdmFsdWUgb2YgdGhlIGFjY3VtdWxhdG9yLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbGlzdCA9IFtbMCwgMV0sIFsyLCAzXSwgWzQsIDVdXTsKICAgKiB2YXIgZmxhdCA9IF8ucmVkdWNlUmlnaHQobGlzdCwgZnVuY3Rpb24oYSwgYikgeyByZXR1cm4gYS5jb25jYXQoYik7IH0sIFtdKTsKICAgKiAvLyA9PiBbNCwgNSwgMiwgMywgMCwgMV0KICAgKi8KICBmdW5jdGlvbiByZWR1Y2VSaWdodChjb2xsZWN0aW9uLCBjYWxsYmFjaywgYWNjdW11bGF0b3IsIHRoaXNBcmcpIHsKICAgIGlmICghY29sbGVjdGlvbikgewogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgdmFyIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoLAogICAgICAgIG5vYWNjdW0gPSBhcmd1bWVudHMubGVuZ3RoIDwgMzsKCiAgICBpZih0aGlzQXJnKSB7CiAgICAgIGNhbGxiYWNrID0gaXRlcmF0b3JCaW5kKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIH0KICAgIGlmIChsZW5ndGggPT09IGxlbmd0aCA+Pj4gMCkgewogICAgICB2YXIgaXRlcmF0ZWUgPSBub0NoYXJCeUluZGV4ICYmIHRvU3RyaW5nLmNhbGwoY29sbGVjdGlvbikgPT0gc3RyaW5nQ2xhc3MKICAgICAgICA/IGNvbGxlY3Rpb24uc3BsaXQoJycpCiAgICAgICAgOiBjb2xsZWN0aW9uOwoKICAgICAgaWYgKGxlbmd0aCAmJiBub2FjY3VtKSB7CiAgICAgICAgYWNjdW11bGF0b3IgPSBpdGVyYXRlZVstLWxlbmd0aF07CiAgICAgIH0KICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgYWNjdW11bGF0b3IgPSBjYWxsYmFjayhhY2N1bXVsYXRvciwgaXRlcmF0ZWVbbGVuZ3RoXSwgbGVuZ3RoLCBjb2xsZWN0aW9uKTsKICAgICAgfQogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgdmFyIHByb3AsCiAgICAgICAgcHJvcHMgPSBrZXlzKGNvbGxlY3Rpb24pOwoKICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKICAgIGlmIChsZW5ndGggJiYgbm9hY2N1bSkgewogICAgICBhY2N1bXVsYXRvciA9IGNvbGxlY3Rpb25bcHJvcHNbLS1sZW5ndGhdXTsKICAgIH0KICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICBwcm9wID0gcHJvcHNbbGVuZ3RoXTsKICAgICAgYWNjdW11bGF0b3IgPSBjYWxsYmFjayhhY2N1bXVsYXRvciwgY29sbGVjdGlvbltwcm9wXSwgcHJvcCwgY29sbGVjdGlvbik7CiAgICB9CiAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgfQoKICAvKioKICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uZmlsdGVyYCwgdGhpcyBtZXRob2QgcmV0dXJucyB0aGUgdmFsdWVzIG9mIGEKICAgKiBgY29sbGVjdGlvbmAgdGhhdCBgY2FsbGJhY2tgIGRvZXMgKipub3QqKiByZXR1cm4gdHJ1dGh5IGZvci4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiB2YWx1ZXMgdGhhdCBkaWQgKipub3QqKiBwYXNzIHRoZSBjYWxsYmFjayBjaGVjay4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIG9kZHMgPSBfLnJlamVjdChbMSwgMiwgMywgNCwgNSwgNl0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICUgMiA9PSAwOyB9KTsKICAgKiAvLyA9PiBbMSwgMywgNV0KICAgKi8KICB2YXIgcmVqZWN0ID0gY3JlYXRlSXRlcmF0b3IoYmFzZUl0ZXJhdG9yT3B0aW9ucywgZmlsdGVySXRlcmF0b3JPcHRpb25zLCB7CiAgICAnaW5Mb29wJzogJyEnICsgZmlsdGVySXRlcmF0b3JPcHRpb25zLmluTG9vcAogIH0pOwoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIGBjYWxsYmFja2AgcmV0dXJucyBhIHRydXRoeSB2YWx1ZSBmb3IgKiphbnkqKiBlbGVtZW50IG9mIGEKICAgKiBgY29sbGVjdGlvbmAuIFRoZSBmdW5jdGlvbiByZXR1cm5zIGFzIHNvb24gYXMgaXQgZmluZHMgcGFzc2luZyB2YWx1ZSwgYW5kCiAgICogZG9lcyBub3QgaXRlcmF0ZSBvdmVyIHRoZSBlbnRpcmUgYGNvbGxlY3Rpb25gLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0bwogICAqIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIDMgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgYW55CiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFueSB2YWx1ZSBwYXNzZXMgdGhlIGNhbGxiYWNrIGNoZWNrLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uc29tZShbbnVsbCwgMCwgJ3llcycsIGZhbHNlXSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIHZhciBzb21lID0gY3JlYXRlSXRlcmF0b3IoYmFzZUl0ZXJhdG9yT3B0aW9ucywgZXZlcnlJdGVyYXRvck9wdGlvbnMsIHsKICAgICdpbml0JzogJ2ZhbHNlJywKICAgICdpbkxvb3AnOiBldmVyeUl0ZXJhdG9yT3B0aW9ucy5pbkxvb3AucmVwbGFjZSgnIScsICcnKQogIH0pOwoKCiAgLyoqCiAgICogUHJvZHVjZXMgYSBuZXcgc29ydGVkIGFycmF5LCBzb3J0ZWQgaW4gYXNjZW5kaW5nIG9yZGVyIGJ5IHRoZSByZXN1bHRzIG9mCiAgICogcnVubmluZyBlYWNoIGVsZW1lbnQgb2YgYGNvbGxlY3Rpb25gIHRocm91Z2ggYSB0cmFuc2Zvcm1hdGlvbiBgY2FsbGJhY2tgLgogICAqIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIDMgYXJndW1lbnRzOwogICAqICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4gVGhlIGBjYWxsYmFja2AgYXJndW1lbnQgbWF5IGFsc28gYmUgdGhlCiAgICogbmFtZSBvZiBhIHByb3BlcnR5IHRvIHNvcnQgYnkgKGUuZy4gJ2xlbmd0aCcpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uIG9yCiAgICogIHByb3BlcnR5IG5hbWUgdG8gc29ydCBieS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2suCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHNvcnRlZCB2YWx1ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uc29ydEJ5KFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBNYXRoLnNpbihudW0pOyB9KTsKICAgKiAvLyA9PiBbMywgMSwgMl0KICAgKgogICAqIF8uc29ydEJ5KFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiB0aGlzLnNpbihudW0pOyB9LCBNYXRoKTsKICAgKiAvLyA9PiBbMywgMSwgMl0KICAgKgogICAqIF8uc29ydEJ5KFsnbGFycnknLCAnYnJlbmRhbicsICdtb2UnXSwgJ2xlbmd0aCcpOwogICAqIC8vID0+IFsnbW9lJywgJ2xhcnJ5JywgJ2JyZW5kYW4nXQogICAqLwogIHZhciBzb3J0QnkgPSBjcmVhdGVJdGVyYXRvcihiYXNlSXRlcmF0b3JPcHRpb25zLCBtYXBJdGVyYXRvck9wdGlvbnMsIHsKICAgICd0b3AnOgogICAgICAnaWYgKHR5cGVvZiBjYWxsYmFjayA9PSBcJ3N0cmluZ1wnKSB7XG4nICsKICAgICAgJyAgdmFyIHByb3AgPSBjYWxsYmFjaztcbicgKwogICAgICAnICBjYWxsYmFjayA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24pIHsgcmV0dXJuIGNvbGxlY3Rpb25bcHJvcF0gfVxuJyArCiAgICAgICd9XG4nICsKICAgICAgJ2Vsc2UgaWYgKHRoaXNBcmcpIHtcbicgKwogICAgICAnICBjYWxsYmFjayA9IGl0ZXJhdG9yQmluZChjYWxsYmFjaywgdGhpc0FyZylcbicgKwogICAgICAnfScsCiAgICAnaW5Mb29wJzogewogICAgICAnYXJyYXknOgogICAgICAgICdyZXN1bHRbaW5kZXhdID0ge1xuJyArCiAgICAgICAgJyAgY3JpdGVyaWE6IGNhbGxiYWNrKGl0ZXJhdGVlW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pLFxuJyArCiAgICAgICAgJyAgdmFsdWU6IGl0ZXJhdGVlW2luZGV4XVxuJyArCiAgICAgICAgJ30nLAogICAgICAnb2JqZWN0JzoKICAgICAgICAncmVzdWx0JyArIChpc0tleXNGYXN0ID8gJ1twcm9wSW5kZXhdID0gJyA6ICcucHVzaCcpICsgJyh7XG4nICsKICAgICAgICAnICBjcml0ZXJpYTogY2FsbGJhY2soaXRlcmF0ZWVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbiksXG4nICsKICAgICAgICAnICB2YWx1ZTogaXRlcmF0ZWVbaW5kZXhdXG4nICsKICAgICAgICAnfSknCiAgICB9LAogICAgJ2JvdHRvbSc6CiAgICAgICdyZXN1bHQuc29ydChjb21wYXJlQXNjZW5kaW5nKTtcbicgKwogICAgICAnbGVuZ3RoID0gcmVzdWx0Lmxlbmd0aDtcbicgKwogICAgICAnd2hpbGUgKGxlbmd0aC0tKSB7XG4nICsKICAgICAgJyAgcmVzdWx0W2xlbmd0aF0gPSByZXN1bHRbbGVuZ3RoXS52YWx1ZVxuJyArCiAgICAgICd9JwogIH0pOwoKICAvKioKICAgKiBDb252ZXJ0cyB0aGUgYGNvbGxlY3Rpb25gLCBpbnRvIGFuIGFycmF5LiBVc2VmdWwgZm9yIGNvbnZlcnRpbmcgdGhlCiAgICogYGFyZ3VtZW50c2Agb2JqZWN0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGNvbnZlcnQuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBuZXcgY29udmVydGVkIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiAoZnVuY3Rpb24oKSB7IHJldHVybiBfLnRvQXJyYXkoYXJndW1lbnRzKS5zbGljZSgxKTsgfSkoMSwgMiwgMywgNCk7CiAgICogLy8gPT4gWzIsIDMsIDRdCiAgICovCiAgZnVuY3Rpb24gdG9BcnJheShjb2xsZWN0aW9uKSB7CiAgICBpZiAoIWNvbGxlY3Rpb24pIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQogICAgaWYgKGNvbGxlY3Rpb24udG9BcnJheSAmJiB0b1N0cmluZy5jYWxsKGNvbGxlY3Rpb24udG9BcnJheSkgPT0gZnVuY0NsYXNzKSB7CiAgICAgIHJldHVybiBjb2xsZWN0aW9uLnRvQXJyYXkoKTsKICAgIH0KICAgIHZhciBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKICAgIGlmIChsZW5ndGggPT09IGxlbmd0aCA+Pj4gMCkgewogICAgICByZXR1cm4gKG5vQXJyYXlTbGljZU9uU3RyaW5ncyA/IHRvU3RyaW5nLmNhbGwoY29sbGVjdGlvbikgPT0gc3RyaW5nQ2xhc3MgOiB0eXBlb2YgY29sbGVjdGlvbiA9PSAnc3RyaW5nJykKICAgICAgICA/IGNvbGxlY3Rpb24uc3BsaXQoJycpCiAgICAgICAgOiBzbGljZS5jYWxsKGNvbGxlY3Rpb24pOwogICAgfQogICAgcmV0dXJuIHZhbHVlcyhjb2xsZWN0aW9uKTsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBQcm9kdWNlcyBhIG5ldyBhcnJheSB3aXRoIGFsbCBmYWxzZXkgdmFsdWVzIG9mIGBhcnJheWAgcmVtb3ZlZC4gVGhlIHZhbHVlcwogICAqIGBmYWxzZWAsIGBudWxsYCwgYDBgLCBgIiJgLCBgdW5kZWZpbmVkYCBhbmQgYE5hTmAgYXJlIGFsbCBmYWxzZXkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGNvbXBhY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGZpbHRlcmVkIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmNvbXBhY3QoWzAsIDEsIGZhbHNlLCAyLCAnJywgM10pOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqLwogIGZ1bmN0aW9uIGNvbXBhY3QoYXJyYXkpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBpZiAoYXJyYXlbaW5kZXhdKSB7CiAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlbaW5kZXhdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFByb2R1Y2VzIGEgbmV3IGFycmF5IG9mIGBhcnJheWAgdmFsdWVzIG5vdCBwcmVzZW50IGluIHRoZSBvdGhlciBhcnJheXMKICAgKiB1c2luZyBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheTEsIGFycmF5MiwgLi4uXSBBcnJheXMgdG8gY2hlY2suCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGBhcnJheWAgdmFsdWVzIG5vdCBwcmVzZW50IGluIHRoZQogICAqICBvdGhlciBhcnJheXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZGlmZmVyZW5jZShbMSwgMiwgMywgNCwgNV0sIFs1LCAyLCAxMF0pOwogICAqIC8vID0+IFsxLCAzLCA0XQogICAqLwogIGZ1bmN0aW9uIGRpZmZlcmVuY2UoYXJyYXkpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICBmbGF0dGVuZWQgPSBjb25jYXQuYXBwbHkocmVzdWx0LCBhcmd1bWVudHMpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGlmIChpbmRleE9mKGZsYXR0ZW5lZCwgYXJyYXlbaW5kZXhdLCBsZW5ndGgpIDwgMCkgewogICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2luZGV4XSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBHZXRzIHRoZSBmaXJzdCB2YWx1ZSBvZiB0aGUgYGFycmF5YC4gUGFzcyBgbmAgdG8gcmV0dXJuIHRoZSBmaXJzdCBgbmAgdmFsdWVzCiAgICogb2YgdGhlIGBhcnJheWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgaGVhZCwgdGFrZQogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtuXSBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIHJldHVybi4KICAgKiBAcGFyYW0ge09iamVjdH0gW2d1YXJkXSBJbnRlcm5hbGx5IHVzZWQgdG8gYWxsb3cgdGhpcyBtZXRob2QgdG8gd29yayB3aXRoCiAgICogIG90aGVycyBsaWtlIGBfLm1hcGAgd2l0aG91dCB1c2luZyB0aGVpciBjYWxsYmFjayBgaW5kZXhgIGFyZ3VtZW50IGZvciBgbmAuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBmaXJzdCB2YWx1ZSBvciBhbiBhcnJheSBvZiB0aGUgZmlyc3QgYG5gIHZhbHVlcwogICAqICBvZiBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmZpcnN0KFs1LCA0LCAzLCAyLCAxXSk7CiAgICogLy8gPT4gNQogICAqLwogIGZ1bmN0aW9uIGZpcnN0KGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5KSB7CiAgICAgIHJldHVybiAobiA9PSBudWxsIHx8IGd1YXJkKSA/IGFycmF5WzBdIDogc2xpY2UuY2FsbChhcnJheSwgMCwgbik7CiAgICB9CiAgfQoKICAvKioKICAgKiBGbGF0dGVucyBhIG5lc3RlZCBhcnJheSAodGhlIG5lc3RpbmcgY2FuIGJlIHRvIGFueSBkZXB0aCkuIElmIGBzaGFsbG93YCBpcwogICAqIHRydXRoeSwgYGFycmF5YCB3aWxsIG9ubHkgYmUgZmxhdHRlbmVkIGEgc2luZ2xlIGxldmVsLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBjb21wYWN0LgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gc2hhbGxvdyBBIGZsYWcgdG8gaW5kaWNhdGUgb25seSBmbGF0dGVuaW5nIGEgc2luZ2xlIGxldmVsLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBmbGF0dGVuZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZmxhdHRlbihbMSwgWzJdLCBbMywgW1s0XV1dXSk7CiAgICogLy8gPT4gWzEsIDIsIDMsIDRdOwogICAqCiAgICogXy5mbGF0dGVuKFsxLCBbMl0sIFszLCBbWzRdXV1dLCB0cnVlKTsKICAgKiAvLyA9PiBbMSwgMiwgMywgW1s0XV1dOwogICAqLwogIGZ1bmN0aW9uIGZsYXR0ZW4oYXJyYXksIHNoYWxsb3cpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciB2YWx1ZSwKICAgICAgICBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgcHVzaC5hcHBseShyZXN1bHQsIHNoYWxsb3cgPyB2YWx1ZSA6IGZsYXR0ZW4odmFsdWUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBHZXRzIHRoZSBpbmRleCBhdCB3aGljaCB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBgdmFsdWVgIGlzIGZvdW5kIHVzaW5nCiAgICogc3RyaWN0IGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4gSWYgdGhlIGBhcnJheWAgaXMgYWxyZWFkeQogICAqIHNvcnRlZCwgcGFzc2luZyBgdHJ1ZWAgZm9yIGBpc1NvcnRlZGAgd2lsbCBydW4gYSBmYXN0ZXIgYmluYXJ5IHNlYXJjaC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEBwYXJhbSB7Qm9vbGVhbnxOdW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHN0YXJ0IHNlYXJjaGluZyBmcm9tIG9yCiAgICogIGB0cnVlYCB0byBwZXJmb3JtIGEgYmluYXJ5IHNlYXJjaCBvbiBhIHNvcnRlZCBgYXJyYXlgLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIpOwogICAqIC8vID0+IDEKICAgKgogICAqIF8uaW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIsIDMpOwogICAqIC8vID0+IDQKICAgKgogICAqIF8uaW5kZXhPZihbMSwgMSwgMiwgMiwgMywgM10sIDIsIHRydWUpOwogICAqIC8vID0+IDIKICAgKi8KICBmdW5jdGlvbiBpbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICBpZiAoIWFycmF5KSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICBpZiAoZnJvbUluZGV4KSB7CiAgICAgIGlmICh0eXBlb2YgZnJvbUluZGV4ID09ICdudW1iZXInKSB7CiAgICAgICAgaW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IE1hdGgubWF4KDAsIGxlbmd0aCArIGZyb21JbmRleCkgOiBmcm9tSW5kZXgpIC0gMTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbmRleCA9IHNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuIGFycmF5W2luZGV4XSA9PT0gdmFsdWUgPyBpbmRleCA6IC0xOwogICAgICB9CiAgICB9CiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBpZiAoYXJyYXlbaW5kZXhdID09PSB2YWx1ZSkgewogICAgICAgIHJldHVybiBpbmRleDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xOwogIH0KCiAgLyoqCiAgICogR2V0cyBhbGwgYnV0IHRoZSBsYXN0IHZhbHVlIG9mIGBhcnJheWAuIFBhc3MgYG5gIHRvIGV4Y2x1ZGUgdGhlIGxhc3QgYG5gCiAgICogdmFsdWVzIGZyb20gdGhlIHJlc3VsdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtuXSBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIHJldHVybi4KICAgKiBAcGFyYW0ge09iamVjdH0gW2d1YXJkXSBJbnRlcm5hbGx5IHVzZWQgdG8gYWxsb3cgdGhpcyBtZXRob2QgdG8gd29yayB3aXRoCiAgICogIG90aGVycyBsaWtlIGBfLm1hcGAgd2l0aG91dCB1c2luZyB0aGVpciBjYWxsYmFjayBgaW5kZXhgIGFyZ3VtZW50IGZvciBgbmAuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGFsbCBidXQgdGhlIGxhc3QgdmFsdWUgb3IgYG5gIHZhbHVlcyBvZiBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmluaXRpYWwoWzMsIDIsIDFdKTsKICAgKiAvLyA9PiBbMywgMl0KICAgKi8KICBmdW5jdGlvbiBpbml0aWFsKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgLSgobiA9PSBudWxsIHx8IGd1YXJkKSA/IDEgOiBuKSk7CiAgfQoKICAvKioKICAgKiBDb21wdXRlcyB0aGUgaW50ZXJzZWN0aW9uIG9mIGFsbCB0aGUgcGFzc2VkLWluIGFycmF5cy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXkxLCBhcnJheTIsIC4uLl0gQXJyYXlzIHRvIHByb2Nlc3MuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMsIGluIG9yZGVyLCB0aGF0IGFyZQogICAqICBwcmVzZW50IGluICoqYWxsKiogb2YgdGhlIGFycmF5cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pbnRlcnNlY3Rpb24oWzEsIDIsIDNdLCBbMTAxLCAyLCAxLCAxMF0sIFsyLCAxXSk7CiAgICogLy8gPT4gWzEsIDJdCiAgICovCiAgZnVuY3Rpb24gaW50ZXJzZWN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBpZiAoIWFycmF5KSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICB2YXIgdmFsdWUsCiAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGgsCiAgICAgICAgb3RoZXJzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAoaW5kZXhPZihyZXN1bHQsIHZhbHVlKSA8IDAgJiYKICAgICAgICAgIGV2ZXJ5KG90aGVycywgZnVuY3Rpb24ob3RoZXIpIHsgcmV0dXJuIGluZGV4T2Yob3RoZXIsIHZhbHVlKSA+IC0xOyB9KSkgewogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIGxhc3QgdmFsdWUgb2YgdGhlIGBhcnJheWAuIFBhc3MgYG5gIHRvIHJldHVybiB0aGUgbGFzeSBgbmAgdmFsdWVzCiAgICogb2YgdGhlIGBhcnJheWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAqIEBwYXJhbSB7TnVtYmVyfSBbbl0gVGhlIG51bWJlciBvZiBlbGVtZW50cyB0byByZXR1cm4uCiAgICogQHBhcmFtIHtPYmplY3R9IFtndWFyZF0gSW50ZXJuYWxseSB1c2VkIHRvIGFsbG93IHRoaXMgbWV0aG9kIHRvIHdvcmsgd2l0aAogICAqICBvdGhlcnMgbGlrZSBgXy5tYXBgIHdpdGhvdXQgdXNpbmcgdGhlaXIgY2FsbGJhY2sgYGluZGV4YCBhcmd1bWVudCBmb3IgYG5gLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgbGFzdCB2YWx1ZSBvciBhbiBhcnJheSBvZiB0aGUgbGFzdCBgbmAgdmFsdWVzCiAgICogIG9mIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubGFzdChbMywgMiwgMV0pOwogICAqIC8vID0+IDEKICAgKi8KICBmdW5jdGlvbiBsYXN0KGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5KSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgIHJldHVybiAobiA9PSBudWxsIHx8IGd1YXJkKSA/IGFycmF5W2xlbmd0aCAtIDFdIDogc2xpY2UuY2FsbChhcnJheSwgLW4gfHwgbGVuZ3RoKTsKICAgIH0KICB9CgogIC8qKgogICAqIEdldHMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSBsYXN0IG9jY3VycmVuY2Ugb2YgYHZhbHVlYCBpcyBmb3VuZCB1c2luZwogICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcGFyYW0ge051bWJlcn0gW2Zyb21JbmRleD1hcnJheS5sZW5ndGgtMV0gVGhlIGluZGV4IHRvIHN0YXJ0IHNlYXJjaGluZyBmcm9tLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyKTsKICAgKiAvLyA9PiA0CiAgICoKICAgKiBfLmxhc3RJbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMiwgMyk7CiAgICogLy8gPT4gMQogICAqLwogIGZ1bmN0aW9uIGxhc3RJbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICBpZiAoIWFycmF5KSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIHZhciBpbmRleCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChmcm9tSW5kZXggJiYgdHlwZW9mIGZyb21JbmRleCA9PSAnbnVtYmVyJykgewogICAgICBpbmRleCA9IChmcm9tSW5kZXggPCAwID8gTWF0aC5tYXgoMCwgaW5kZXggKyBmcm9tSW5kZXgpIDogTWF0aC5taW4oZnJvbUluZGV4LCBpbmRleCAtIDEpKSArIDE7CiAgICB9CiAgICB3aGlsZSAoaW5kZXgtLSkgewogICAgICBpZiAoYXJyYXlbaW5kZXhdID09PSB2YWx1ZSkgewogICAgICAgIHJldHVybiBpbmRleDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xOwogIH0KCiAgLyoqCiAgICogUmV0cmlldmVzIHRoZSBtYXhpbXVtIHZhbHVlIG9mIGFuIGBhcnJheWAuIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLAogICAqIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGVhY2ggdmFsdWUgaW4gdGhlIGBhcnJheWAgdG8gZ2VuZXJhdGUgdGhlCiAgICogY3JpdGVyaW9uIGJ5IHdoaWNoIHRoZSB2YWx1ZSBpcyByYW5rZWQuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvCiAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggMyBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIG1heGltdW0gdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiBfLm1heChzdG9vZ2VzLCBmdW5jdGlvbihzdG9vZ2UpIHsgcmV0dXJuIHN0b29nZS5hZ2U7IH0pOwogICAqIC8vID0+IHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfTsKICAgKi8KICBmdW5jdGlvbiBtYXgoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgY29tcHV0ZWQgPSAtSW5maW5pdHksCiAgICAgICAgcmVzdWx0ID0gY29tcHV0ZWQ7CgogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgdmFyIGN1cnJlbnQsCiAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgaWYgKCFjYWxsYmFjaykgewogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGlmIChhcnJheVtpbmRleF0gPiByZXN1bHQpIHsKICAgICAgICAgIHJlc3VsdCA9IGFycmF5W2luZGV4XTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGlmICh0aGlzQXJnKSB7CiAgICAgIGNhbGxiYWNrID0gaXRlcmF0b3JCaW5kKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIH0KICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGN1cnJlbnQgPSBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSk7CiAgICAgIGlmIChjdXJyZW50ID4gY29tcHV0ZWQpIHsKICAgICAgICBjb21wdXRlZCA9IGN1cnJlbnQ7CiAgICAgICAgcmVzdWx0ID0gYXJyYXlbaW5kZXhdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogUmV0cmlldmVzIHRoZSBtaW5pbXVtIHZhbHVlIG9mIGFuIGBhcnJheWAuIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLAogICAqIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGVhY2ggdmFsdWUgaW4gdGhlIGBhcnJheWAgdG8gZ2VuZXJhdGUgdGhlCiAgICogY3JpdGVyaW9uIGJ5IHdoaWNoIHRoZSB2YWx1ZSBpcyByYW5rZWQuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYAogICAqIGFuZCBpbnZva2VkIHdpdGggMyBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIG1pbmltdW0gdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubWluKFsxMCwgNSwgMTAwLCAyLCAxMDAwXSk7CiAgICogLy8gPT4gMgogICAqLwogIGZ1bmN0aW9uIG1pbihhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBjb21wdXRlZCA9IEluZmluaXR5LAogICAgICAgIHJlc3VsdCA9IGNvbXB1dGVkOwoKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciBjdXJyZW50LAogICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBpZiAoYXJyYXlbaW5kZXhdIDwgcmVzdWx0KSB7CiAgICAgICAgICByZXN1bHQgPSBhcnJheVtpbmRleF07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBpZiAodGhpc0FyZykgewogICAgICBjYWxsYmFjayA9IGl0ZXJhdG9yQmluZChjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9CiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBjdXJyZW50ID0gY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpOwogICAgICBpZiAoY3VycmVudCA8IGNvbXB1dGVkKSB7CiAgICAgICAgY29tcHV0ZWQgPSBjdXJyZW50OwogICAgICAgIHJlc3VsdCA9IGFycmF5W2luZGV4XTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgbnVtYmVycyAocG9zaXRpdmUgYW5kL29yIG5lZ2F0aXZlKSBwcm9ncmVzc2luZyBmcm9tCiAgICogYHN0YXJ0YCB1cCB0byBidXQgbm90IGluY2x1ZGluZyBgc3RvcGAuIFRoaXMgbWV0aG9kIGlzIGEgcG9ydCBvZiBQeXRob24ncwogICAqIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge051bWJlcn0gW3N0YXJ0PTBdIFRoZSBzdGFydCBvZiB0aGUgcmFuZ2UuCiAgICogQHBhcmFtIHtOdW1iZXJ9IGVuZCBUaGUgZW5kIG9mIHRoZSByYW5nZS4KICAgKiBAcGFyYW0ge051bWJlcn0gW3N0ZXA9MV0gVGhlIHZhbHVlIHRvIGluY3JlbWVudCBvciBkZXNjcmVtZW50IGJ5LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyByYW5nZSBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5yYW5nZSgxMCk7CiAgICogLy8gPT4gWzAsIDEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDldCiAgICoKICAgKiBfLnJhbmdlKDEsIDExKTsKICAgKiAvLyA9PiBbMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTBdCiAgICoKICAgKiBfLnJhbmdlKDAsIDMwLCA1KTsKICAgKiAvLyA9PiBbMCwgNSwgMTAsIDE1LCAyMCwgMjVdCiAgICoKICAgKiBfLnJhbmdlKDAsIC0xMCwgLTEpOwogICAqIC8vID0+IFswLCAtMSwgLTIsIC0zLCAtNCwgLTUsIC02LCAtNywgLTgsIC05XQogICAqCiAgICogXy5yYW5nZSgwKTsKICAgKiAvLyA9PiBbXQogICAqLwogIGZ1bmN0aW9uIHJhbmdlKHN0YXJ0LCBlbmQsIHN0ZXApIHsKICAgIHN0ZXAgfHwgKHN0ZXAgPSAxKTsKICAgIGlmIChlbmQgPT0gbnVsbCkgewogICAgICBlbmQgPSBzdGFydCB8fCAwOwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICAvLyB1c2UgYEFycmF5KGxlbmd0aClgIHNvIFY4IHdpbGwgYXZvaWQgdGhlIHNsb3dlciAiZGljdGlvbmFyeSIgbW9kZQogICAgLy8gaHR0cDovL3d3dy55b3V0dWJlLmNvbS93YXRjaD92PVhBcUlwR1U4WlprI3Q9MTZtMjdzCiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBNYXRoLm1heCgwLCBNYXRoLmNlaWwoKGVuZCAtIHN0YXJ0KSAvIHN0ZXApKSwKICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBzdGFydDsKICAgICAgc3RhcnQgKz0gc3RlcDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uaW5pdGlhbGAsIHRoaXMgbWV0aG9kIGdldHMgYWxsIGJ1dCB0aGUgZmlyc3QgdmFsdWUgb2YKICAgKiBgYXJyYXlgLiBQYXNzIGBuYCB0byBleGNsdWRlIHRoZSBmaXJzdCBgbmAgdmFsdWVzIGZyb20gdGhlIHJlc3VsdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyB0YWlsCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgKiBAcGFyYW0ge051bWJlcn0gW25dIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLgogICAqIEBwYXJhbSB7T2JqZWN0fSBbZ3VhcmRdIEludGVybmFsbHkgdXNlZCB0byBhbGxvdyB0aGlzIG1ldGhvZCB0byB3b3JrIHdpdGgKICAgKiAgb3RoZXJzIGxpa2UgYF8ubWFwYCB3aXRob3V0IHVzaW5nIHRoZWlyIGNhbGxiYWNrIGBpbmRleGAgYXJndW1lbnQgZm9yIGBuYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYWxsIGJ1dCB0aGUgZmlyc3QgdmFsdWUgb3IgYG5gIHZhbHVlcyBvZiBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnJlc3QoWzMsIDIsIDFdKTsKICAgKiAvLyA9PiBbMiwgMV0KICAgKi8KICBmdW5jdGlvbiByZXN0KGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgKG4gPT0gbnVsbCB8fCBndWFyZCkgPyAxIDogbik7CiAgfQoKICAvKioKICAgKiBQcm9kdWNlcyBhIG5ldyBhcnJheSBvZiBzaHVmZmxlZCBgYXJyYXlgIHZhbHVlcywgdXNpbmcgYSB2ZXJzaW9uIG9mIHRoZQogICAqIEZpc2hlci1ZYXRlcyBzaHVmZmxlLiBTZWUgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9GaXNoZXItWWF0ZXNfc2h1ZmZsZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2h1ZmZsZS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgc2h1ZmZsZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uc2h1ZmZsZShbMSwgMiwgMywgNCwgNSwgNl0pOwogICAqIC8vID0+IFs0LCAxLCA2LCAzLCA1LCAyXQogICAqLwogIGZ1bmN0aW9uIHNodWZmbGUoYXJyYXkpIHsKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQogICAgdmFyIHJhbmQsCiAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGgsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByYW5kID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGluZGV4ICsgMSkpOwogICAgICByZXN1bHRbaW5kZXhdID0gcmVzdWx0W3JhbmRdOwogICAgICByZXN1bHRbcmFuZF0gPSBhcnJheVtpbmRleF07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogVXNlcyBhIGJpbmFyeSBzZWFyY2ggdG8gZGV0ZXJtaW5lIHRoZSBzbWFsbGVzdCBpbmRleCBhdCB3aGljaCB0aGUgYHZhbHVlYAogICAqIHNob3VsZCBiZSBpbnNlcnRlZCBpbnRvIGBhcnJheWAgaW4gb3JkZXIgdG8gbWFpbnRhaW4gdGhlIHNvcnQgb3JkZXIgb2YgdGhlCiAgICogc29ydGVkIGBhcnJheWAuIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLCBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBgdmFsdWVgIGFuZAogICAqIGVhY2ggZWxlbWVudCBpbiBgYXJyYXlgIHRvIGNvbXB1dGUgdGhlaXIgc29ydCByYW5raW5nLiBUaGUgYGNhbGxiYWNrYCBpcwogICAqIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIDEgYXJndW1lbnQ7ICh2YWx1ZSkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZXZhbHVhdGUuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSB2YWx1ZSBzaG91bGQgYmUgaW5zZXJ0ZWQKICAgKiAgaW50byBgYXJyYXlgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnNvcnRlZEluZGV4KFsyMCwgMzAsIDQwXSwgMzUpOwogICAqIC8vID0+IDIKICAgKgogICAqIHZhciBkaWN0ID0gewogICAqICAgJ3dvcmRUb051bWJlcic6IHsgJ3R3ZW50eSc6IDIwLCAndGhpcnR5JzogMzAsICd0aGlydHktZml2ZSc6IDM1LCAnZm91cnR5JzogNDAgfQogICAqIH07CiAgICoKICAgKiBfLnNvcnRlZEluZGV4KFsndHdlbnR5JywgJ3RoaXJ0eScsICdmb3VydHknXSwgJ3RoaXJ0eS1maXZlJywgZnVuY3Rpb24od29yZCkgewogICAqICAgcmV0dXJuIGRpY3Qud29yZFRvTnVtYmVyW3dvcmRdOwogICAqIH0pOwogICAqIC8vID0+IDIKICAgKgogICAqIF8uc29ydGVkSW5kZXgoWyd0d2VudHknLCAndGhpcnR5JywgJ2ZvdXJ0eSddLCAndGhpcnR5LWZpdmUnLCBmdW5jdGlvbih3b3JkKSB7CiAgICogICByZXR1cm4gdGhpcy53b3JkVG9OdW1iZXJbd29yZF07CiAgICogfSwgZGljdCk7CiAgICogLy8gPT4gMgogICAqLwogIGZ1bmN0aW9uIHNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICB2YXIgbWlkLAogICAgICAgIGxvdyA9IDAsCiAgICAgICAgaGlnaCA9IGFycmF5Lmxlbmd0aDsKCiAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgaWYgKHRoaXNBcmcpIHsKICAgICAgICBjYWxsYmFjayA9IGJpbmQoY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICB9CiAgICAgIHZhbHVlID0gY2FsbGJhY2sodmFsdWUpOwogICAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICAgIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgICBjYWxsYmFjayhhcnJheVttaWRdKSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgICAgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICAgIGFycmF5W21pZF0gPCB2YWx1ZSA/IGxvdyA9IG1pZCArIDEgOiBoaWdoID0gbWlkOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbG93OwogIH0KCiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIHVuaW9uIG9mIHRoZSBwYXNzZWQtaW4gYXJyYXlzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheTEsIGFycmF5MiwgLi4uXSBBcnJheXMgdG8gcHJvY2Vzcy4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdW5pcXVlIHZhbHVlcywgaW4gb3JkZXIsIHRoYXQgYXJlCiAgICogIHByZXNlbnQgaW4gb25lIG9yIG1vcmUgb2YgdGhlIGFycmF5cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy51bmlvbihbMSwgMiwgM10sIFsxMDEsIDIsIDEsIDEwXSwgWzIsIDFdKTsKICAgKiAvLyA9PiBbMSwgMiwgMywgMTAxLCAxMF0KICAgKi8KICBmdW5jdGlvbiB1bmlvbigpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIHJlc3VsdCA9IFtdLAogICAgICAgIGZsYXR0ZW5lZCA9IGNvbmNhdC5hcHBseShyZXN1bHQsIGFyZ3VtZW50cyksCiAgICAgICAgbGVuZ3RoID0gZmxhdHRlbmVkLmxlbmd0aDsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBpZiAoaW5kZXhPZihyZXN1bHQsIGZsYXR0ZW5lZFtpbmRleF0pIDwgMCkgewogICAgICAgIHJlc3VsdC5wdXNoKGZsYXR0ZW5lZFtpbmRleF0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogUHJvZHVjZXMgYSBkdXBsaWNhdGUtdmFsdWUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBgYXJyYXlgIHVzaW5nIHN0cmljdCBlcXVhbGl0eQogICAqIGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4gSWYgdGhlIGBhcnJheWAgaXMgYWxyZWFkeSBzb3J0ZWQsIHBhc3NpbmcgYHRydWVgCiAgICogZm9yIGBpc1NvcnRlZGAgd2lsbCBydW4gYSBmYXN0ZXIgYWxnb3JpdGhtLiBJZiBgY2FsbGJhY2tgIGlzIHBhc3NlZCwKICAgKiBlYWNoIHZhbHVlIG9mIGBhcnJheWAgaXMgcGFzc2VkIHRocm91Z2ggYSB0cmFuc2Zvcm1hdGlvbiBgY2FsbGJhY2tgIGJlZm9yZQogICAqIHVuaXF1ZW5lc3MgaXMgY29tcHV0ZWQuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZAogICAqIHdpdGggMyBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyB1bmlxdWUKICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHByb2Nlc3MuCiAgICogQHBhcmFtIHtCb29sZWFufSBbaXNTb3J0ZWQ9ZmFsc2VdIEEgZmxhZyB0byBpbmRpY2F0ZSB0aGF0IHRoZSBgYXJyYXlgIGlzIGFscmVhZHkgc29ydGVkLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBkdXBsaWNhdGUtdmFsdWUtZnJlZSBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy51bmlxKFsxLCAyLCAxLCAzLCAxXSk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICoKICAgKiBfLnVuaXEoWzEsIDEsIDIsIDIsIDNdLCB0cnVlKTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKgogICAqIF8udW5pcShbMSwgMiwgMS41LCAzLCAyLjVdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguZmxvb3IobnVtKTsgfSk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICoKICAgKiBfLnVuaXEoWzEsIDIsIDEuNSwgMywgMi41XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiB0aGlzLmZsb29yKG51bSk7IH0sIE1hdGgpOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqLwogIGZ1bmN0aW9uIHVuaXEoYXJyYXksIGlzU29ydGVkLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgdmFyIGNvbXB1dGVkLAogICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgIHNlZW4gPSBbXTsKCiAgICAvLyBqdWdnbGUgYXJndW1lbnRzCiAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpc0FyZyA9IGNhbGxiYWNrOwogICAgICBjYWxsYmFjayA9IGlzU29ydGVkOwogICAgICBpc1NvcnRlZCA9IGZhbHNlOwogICAgfQogICAgaWYgKCFjYWxsYmFjaykgewogICAgICBjYWxsYmFjayA9IGlkZW50aXR5OwogICAgfSBlbHNlIGlmICh0aGlzQXJnKSB7CiAgICAgIGNhbGxiYWNrID0gaXRlcmF0b3JCaW5kKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIH0KICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGNvbXB1dGVkID0gY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpOwogICAgICBpZiAoaXNTb3J0ZWQKICAgICAgICAgICAgPyAhaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSBjb21wdXRlZAogICAgICAgICAgICA6IGluZGV4T2Yoc2VlbiwgY29tcHV0ZWQpIDwgMAogICAgICAgICAgKSB7CiAgICAgICAgc2Vlbi5wdXNoKGNvbXB1dGVkKTsKICAgICAgICByZXN1bHQucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogUHJvZHVjZXMgYSBuZXcgYXJyYXkgd2l0aCBhbGwgb2NjdXJyZW5jZXMgb2YgdGhlIHBhc3NlZCB2YWx1ZXMgcmVtb3ZlZCB1c2luZwogICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGZpbHRlci4KICAgKiBAcGFyYW0ge01peGVkfSBbdmFsdWUxLCB2YWx1ZTIsIC4uLl0gVmFsdWVzIHRvIHJlbW92ZS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgZmlsdGVyZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ud2l0aG91dChbMSwgMiwgMSwgMCwgMywgMSwgNF0sIDAsIDEpOwogICAqIC8vID0+IFsyLCAzLCA0XQogICAqLwogIGZ1bmN0aW9uIHdpdGhvdXQoYXJyYXkpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBpZiAoaW5kZXhPZihhcmd1bWVudHMsIGFycmF5W2luZGV4XSwgMSkgPCAwKSB7CiAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlbaW5kZXhdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIE1lcmdlcyB0aGUgZWxlbWVudHMgb2YgZWFjaCBhcnJheSBhdCB0aGVpciBjb3JyZXNwb25kaW5nIGluZGV4ZXMuIFVzZWZ1bCBmb3IKICAgKiBzZXBhcmF0ZSBkYXRhIHNvdXJjZXMgdGhhdCBhcmUgY29vcmRpbmF0ZWQgdGhyb3VnaCBtYXRjaGluZyBhcnJheSBpbmRleGVzLgogICAqIEZvciBhIG1hdHJpeCBvZiBuZXN0ZWQgYXJyYXlzLCBgXy56aXAuYXBwbHkoLi4uKWAgY2FuIHRyYW5zcG9zZSB0aGUgbWF0cml4CiAgICogaW4gYSBzaW1pbGFyIGZhc2hpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5MSwgYXJyYXkyLCAuLi5dIEFycmF5cyB0byBwcm9jZXNzLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBtZXJnZWQgYXJyYXlzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnppcChbJ21vZScsICdsYXJyeScsICdjdXJseSddLCBbMzAsIDQwLCA1MF0sIFt0cnVlLCBmYWxzZSwgZmFsc2VdKTsKICAgKiAvLyA9PiBbWydtb2UnLCAzMCwgdHJ1ZV0sIFsnbGFycnknLCA0MCwgZmFsc2VdLCBbJ2N1cmx5JywgNTAsIGZhbHNlXV0KICAgKi8KICBmdW5jdGlvbiB6aXAoYXJyYXkpIHsKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gbWF4KHBsdWNrKGFyZ3VtZW50cywgJ2xlbmd0aCcpKSwKICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBwbHVjayhhcmd1bWVudHMsIGluZGV4KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBNZXJnZXMgYW4gYXJyYXkgb2YgYGtleXNgIGFuZCBhbiBhcnJheSBvZiBgdmFsdWVzYCBpbnRvIGEgc2luZ2xlIG9iamVjdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBrZXlzIFRoZSBhcnJheSBvZiBrZXlzLgogICAqIEBwYXJhbSB7QXJyYXl9IFt2YWx1ZXM9W11dIFRoZSBhcnJheSBvZiB2YWx1ZXMuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3QgY29tcG9zZWQgb2YgdGhlIGdpdmVuIGtleXMgYW5kCiAgICogIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnppcE9iamVjdChbJ21vZScsICdsYXJyeScsICdjdXJseSddLCBbMzAsIDQwLCA1MF0pOwogICAqIC8vID0+IHsgJ21vZSc6IDMwLCAnbGFycnknOiA0MCwgJ2N1cmx5JzogNTAgfQogICAqLwogIGZ1bmN0aW9uIHppcE9iamVjdChrZXlzLCB2YWx1ZXMpIHsKICAgIGlmICgha2V5cykgewogICAgICByZXR1cm4ge307CiAgICB9CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBrZXlzLmxlbmd0aCwKICAgICAgICByZXN1bHQgPSB7fTsKCiAgICB2YWx1ZXMgfHwgKHZhbHVlcyA9IFtdKTsKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJlc3VsdFtrZXlzW2luZGV4XV0gPSB2YWx1ZXNbaW5kZXhdOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGZ1bmN0aW9uIHRoYXQgaXMgcmVzdHJpY3RlZCB0byBleGVjdXRpbmcgb25seSBhZnRlciBpdCBpcwogICAqIGNhbGxlZCBgbmAgdGltZXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtOdW1iZXJ9IG4gVGhlIG51bWJlciBvZiB0aW1lcyB0aGUgZnVuY3Rpb24gbXVzdCBiZSBjYWxsZWQgYmVmb3JlCiAgICogaXQgaXMgZXhlY3V0ZWQuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgcmVzdHJpY3RlZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHJlbmRlck5vdGVzID0gXy5hZnRlcihub3Rlcy5sZW5ndGgsIHJlbmRlcik7CiAgICogXy5mb3JFYWNoKG5vdGVzLCBmdW5jdGlvbihub3RlKSB7CiAgICogICBub3RlLmFzeW5jU2F2ZSh7ICdzdWNjZXNzJzogcmVuZGVyTm90ZXMgfSk7CiAgICogfSk7CiAgICogLy8gYHJlbmRlck5vdGVzYCBpcyBydW4gb25jZSwgYWZ0ZXIgYWxsIG5vdGVzIGhhdmUgc2F2ZWQKICAgKi8KICBmdW5jdGlvbiBhZnRlcihuLCBmdW5jKSB7CiAgICBpZiAobiA8IDEpIHsKICAgICAgcmV0dXJuIGZ1bmMoKTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKC0tbiA8IDEpIHsKICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgaW52b2tlcyBgZnVuY2Agd2l0aCB0aGUgYHRoaXNgCiAgICogYmluZGluZyBvZiBgdGhpc0FyZ2AgYW5kIHByZXBlbmRzIGFueSBhZGRpdGlvbmFsIGBiaW5kYCBhcmd1bWVudHMgdG8gdGhvc2UKICAgKiBwYXNzZWQgdG8gdGhlIGJvdW5kIGZ1bmN0aW9uLiBMYXp5IGRlZmluZWQgbWV0aG9kcyBtYXkgYmUgYm91bmQgYnkgcGFzc2luZwogICAqIHRoZSBvYmplY3QgdGhleSBhcmUgYm91bmQgdG8gYXMgYGZ1bmNgIGFuZCB0aGUgbWV0aG9kIG5hbWUgYXMgYHRoaXNBcmdgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fSBmdW5jIFRoZSBmdW5jdGlvbiB0byBiaW5kIG9yIHRoZSBvYmplY3QgdGhlIG1ldGhvZCBiZWxvbmdzIHRvLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgIG9yIHRoZSBtZXRob2QgbmFtZS4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgYm91bmQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIC8vIGJhc2ljIGJpbmQKICAgKiB2YXIgZnVuYyA9IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICogfTsKICAgKgogICAqIGZ1bmMgPSBfLmJpbmQoZnVuYywgeyAnbmFtZSc6ICdtb2UnIH0sICdoaScpOwogICAqIGZ1bmMoKTsKICAgKiAvLyA9PiAnaGkgbW9lJwogICAqCiAgICogLy8gbGF6eSBiaW5kCiAgICogdmFyIG9iamVjdCA9IHsKICAgKiAgICduYW1lJzogJ21vZScsCiAgICogICAnZ3JlZXQnOiBmdW5jdGlvbihncmVldGluZykgewogICAqICAgICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICogICB9CiAgICogfTsKICAgKgogICAqIHZhciBmdW5jID0gXy5iaW5kKG9iamVjdCwgJ2dyZWV0JywgJ2hpJyk7CiAgICogZnVuYygpOwogICAqIC8vID0+ICdoaSBtb2UnCiAgICoKICAgKiBvYmplY3QuZ3JlZXQgPSBmdW5jdGlvbihncmVldGluZykgewogICAqICAgcmV0dXJuIGdyZWV0aW5nICsgJywgJyArIHRoaXMubmFtZSArICchJzsKICAgKiB9OwogICAqCiAgICogZnVuYygpOwogICAqIC8vID0+ICdoaSwgbW9lIScKICAgKi8KICBmdW5jdGlvbiBiaW5kKGZ1bmMsIHRoaXNBcmcpIHsKICAgIHZhciBtZXRob2ROYW1lLAogICAgICAgIGlzRnVuYyA9IHRvU3RyaW5nLmNhbGwoZnVuYykgPT0gZnVuY0NsYXNzOwoKICAgIC8vIGp1Z2dsZSBhcmd1bWVudHMKICAgIGlmICghaXNGdW5jKSB7CiAgICAgIG1ldGhvZE5hbWUgPSB0aGlzQXJnOwogICAgICB0aGlzQXJnID0gZnVuYzsKICAgIH0KICAgIC8vIHVzZSBgRnVuY3Rpb24jYmluZGAgaWYgaXQgZXhpc3RzIGFuZCBpcyBmYXN0CiAgICAvLyAoaW4gVjggYEZ1bmN0aW9uI2JpbmRgIGlzIHNsb3dlciBleGNlcHQgd2hlbiBwYXJ0aWFsbHkgYXBwbGllZCkKICAgIGVsc2UgaWYgKGlzQmluZEZhc3QgfHwgKG5hdGl2ZUJpbmQgJiYgYXJndW1lbnRzLmxlbmd0aCA+IDIpKSB7CiAgICAgIHJldHVybiBuYXRpdmVCaW5kLmNhbGwuYXBwbHkobmF0aXZlQmluZCwgYXJndW1lbnRzKTsKICAgIH0KCiAgICB2YXIgcGFydGlhbEFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgogICAgZnVuY3Rpb24gYm91bmQoKSB7CiAgICAgIC8vIGBGdW5jdGlvbiNiaW5kYCBzcGVjCiAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDE1LjMuNC41CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgdGhpc0JpbmRpbmcgPSB0aGlzQXJnOwoKICAgICAgaWYgKCFpc0Z1bmMpIHsKICAgICAgICBmdW5jID0gdGhpc0FyZ1ttZXRob2ROYW1lXTsKICAgICAgfQogICAgICBpZiAocGFydGlhbEFyZ3MubGVuZ3RoKSB7CiAgICAgICAgYXJncyA9IGFyZ3MubGVuZ3RoCiAgICAgICAgICA/IGNvbmNhdC5hcHBseShwYXJ0aWFsQXJncywgYXJncykKICAgICAgICAgIDogcGFydGlhbEFyZ3M7CiAgICAgIH0KICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkgewogICAgICAgIC8vIGdldCBgZnVuY2AgaW5zdGFuY2UgaWYgYGJvdW5kYCBpcyBpbnZva2VkIGluIGEgYG5ld2AgZXhwcmVzc2lvbgogICAgICAgIG5vb3AucHJvdG90eXBlID0gZnVuYy5wcm90b3R5cGU7CiAgICAgICAgdGhpc0JpbmRpbmcgPSBuZXcgbm9vcDsKCiAgICAgICAgLy8gbWltaWMgdGhlIGNvbnN0cnVjdG9yJ3MgYHJldHVybmAgYmVoYXZpb3IKICAgICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxMy4yLjIKICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdCAmJiBvYmplY3RUeXBlc1t0eXBlb2YgcmVzdWx0XQogICAgICAgICAgPyByZXN1bHQKICAgICAgICAgIDogdGhpc0JpbmRpbmcKICAgICAgfQogICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CiAgICB9CiAgICByZXR1cm4gYm91bmQ7CiAgfQoKICAvKioKICAgKiBCaW5kcyBtZXRob2RzIG9uIGBvYmplY3RgIHRvIGBvYmplY3RgLCBvdmVyd3JpdGluZyB0aGUgZXhpc3RpbmcgbWV0aG9kLgogICAqIElmIG5vIG1ldGhvZCBuYW1lcyBhcmUgcHJvdmlkZWQsIGFsbCB0aGUgZnVuY3Rpb24gcHJvcGVydGllcyBvZiBgb2JqZWN0YAogICAqIHdpbGwgYmUgYm91bmQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGJpbmQgYW5kIGFzc2lnbiB0aGUgYm91bmQgbWV0aG9kcyB0by4KICAgKiBAcGFyYW0ge1N0cmluZ30gW21ldGhvZE5hbWUxLCBtZXRob2ROYW1lMiwgLi4uXSBNZXRob2QgbmFtZXMgb24gdGhlIG9iamVjdCB0byBiaW5kLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGBvYmplY3RgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgYnV0dG9uVmlldyA9IHsKICAgKiAgJ2xhYmVsJzogJ2xvZGFzaCcsCiAgICogICdvbkNsaWNrJzogZnVuY3Rpb24oKSB7IGFsZXJ0KCdjbGlja2VkOiAnICsgdGhpcy5sYWJlbCk7IH0KICAgKiB9OwogICAqCiAgICogXy5iaW5kQWxsKGJ1dHRvblZpZXcpOwogICAqIGpRdWVyeSgnI2xvZGFzaF9idXR0b24nKS5vbignY2xpY2snLCBidXR0b25WaWV3Lm9uQ2xpY2spOwogICAqIC8vID0+IFdoZW4gdGhlIGJ1dHRvbiBpcyBjbGlja2VkLCBgdGhpcy5sYWJlbGAgd2lsbCBoYXZlIHRoZSBjb3JyZWN0IHZhbHVlCiAgICovCiAgdmFyIGJpbmRBbGwgPSBjcmVhdGVJdGVyYXRvcih7CiAgICAndXNlSGFzJzogZmFsc2UsCiAgICAndXNlU3RyaWN0JzogZmFsc2UsCiAgICAnYXJncyc6ICdvYmplY3QnLAogICAgJ2luaXQnOiAnb2JqZWN0JywKICAgICd0b3AnOgogICAgICAndmFyIGZ1bmNzID0gYXJndW1lbnRzLFxuJyArCiAgICAgICcgICAgbGVuZ3RoID0gZnVuY3MubGVuZ3RoO1xuJyArCiAgICAgICdpZiAobGVuZ3RoID4gMSkge1xuJyArCiAgICAgICcgIGZvciAodmFyIGluZGV4ID0gMTsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspXG4nICsKICAgICAgJyAgICByZXN1bHRbZnVuY3NbaW5kZXhdXSA9IGJpbmQocmVzdWx0W2Z1bmNzW2luZGV4XV0sIHJlc3VsdCk7XG4nICsKICAgICAgJyAgcmV0dXJuIHJlc3VsdFxuJyArCiAgICAgICd9JywKICAgICdpbkxvb3AnOgogICAgICAnaWYgKHRvU3RyaW5nLmNhbGwocmVzdWx0W2luZGV4XSkgPT0gZnVuY0NsYXNzKScgKwogICAgICAnIHJlc3VsdFtpbmRleF0gPSBiaW5kKHJlc3VsdFtpbmRleF0sIHJlc3VsdCknCiAgfSk7CgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgdGhlIHBhc3NlZCBmdW5jdGlvbnMsCiAgICogd2hlcmUgZWFjaCBmdW5jdGlvbiBjb25zdW1lcyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgICogSW4gbWF0aCB0ZXJtcywgY29tcG9zaW5nIHRoZSBmdW5jdGlvbnMgYGYoKWAsIGBnKClgLCBhbmQgYGgoKWAgcHJvZHVjZXMgYGYoZyhoKCkpKWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2Z1bmMxLCBmdW5jMiwgLi4uXSBGdW5jdGlvbnMgdG8gY29tcG9zZS4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBjb21wb3NlZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24obmFtZSkgeyByZXR1cm4gJ2hpOiAnICsgbmFtZTsgfTsKICAgKiB2YXIgZXhjbGFpbSA9IGZ1bmN0aW9uKHN0YXRlbWVudCkgeyByZXR1cm4gc3RhdGVtZW50ICsgJyEnOyB9OwogICAqIHZhciB3ZWxjb21lID0gXy5jb21wb3NlKGV4Y2xhaW0sIGdyZWV0KTsKICAgKiB3ZWxjb21lKCdtb2UnKTsKICAgKiAvLyA9PiAnaGk6IG1vZSEnCiAgICovCiAgZnVuY3Rpb24gY29tcG9zZSgpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBsZW5ndGggPSBmdW5jcy5sZW5ndGg7CgogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2xlbmd0aF0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgZnVuY3Rpb24gdGhhdCB3aWxsIGRlbGF5IHRoZSBleGVjdXRpb24gb2YgYGZ1bmNgIHVudGlsIGFmdGVyCiAgICogYHdhaXRgIG1pbGxpc2Vjb25kcyBoYXZlIGVsYXBzZWQgc2luY2UgdGhlIGxhc3QgdGltZSBpdCB3YXMgaW52b2tlZC4gUGFzcwogICAqIGB0cnVlYCBmb3IgYGltbWVkaWF0ZWAgdG8gY2F1c2UgZGVib3VuY2UgdG8gaW52b2tlIGBmdW5jYCBvbiB0aGUgbGVhZGluZywKICAgKiBpbnN0ZWFkIG9mIHRoZSB0cmFpbGluZywgZWRnZSBvZiB0aGUgYHdhaXRgIHRpbWVvdXQuIFN1YnNlcXVlbnQgY2FsbHMgdG8KICAgKiB0aGUgZGVib3VuY2VkIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGxhc3QgYGZ1bmNgIGNhbGwuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVib3VuY2UuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkuCiAgICogQHBhcmFtIHtCb29sZWFufSBpbW1lZGlhdGUgQSBmbGFnIHRvIGluZGljYXRlIGV4ZWN1dGlvbiBpcyBvbiB0aGUgbGVhZGluZwogICAqICBlZGdlIG9mIHRoZSB0aW1lb3V0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGRlYm91bmNlZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGxhenlMYXlvdXQgPSBfLmRlYm91bmNlKGNhbGN1bGF0ZUxheW91dCwgMzAwKTsKICAgKiBqUXVlcnkod2luZG93KS5vbigncmVzaXplJywgbGF6eUxheW91dCk7CiAgICovCiAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICB2YXIgYXJncywKICAgICAgICByZXN1bHQsCiAgICAgICAgdGhpc0FyZywKICAgICAgICB0aW1lb3V0SWQ7CgogICAgZnVuY3Rpb24gZGVsYXllZCgpIHsKICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgaWYgKCFpbW1lZGlhdGUpIHsKICAgICAgICBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXNJbW1lZGlhdGUgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXRJZDsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdGhpc0FyZyA9IHRoaXM7CgogICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgdGltZW91dElkID0gc2V0VGltZW91dChkZWxheWVkLCB3YWl0KTsKCiAgICAgIGlmIChpc0ltbWVkaWF0ZSkgewogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKICAvKioKICAgKiBFeGVjdXRlcyB0aGUgYGZ1bmNgIGZ1bmN0aW9uIGFmdGVyIGB3YWl0YCBtaWxsaXNlY29uZHMuIEFkZGl0aW9uYWwgYXJndW1lbnRzCiAgICogYXJlIHBhc3NlZCB0byBgZnVuY2Agd2hlbiBpdCBpcyBpbnZva2VkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlbGF5LgogICAqIEBwYXJhbSB7TnVtYmVyfSB3YWl0IFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIGRlbGF5IGV4ZWN1dGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbYXJnMSwgYXJnMiwgLi4uXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBmdW5jdGlvbiB3aXRoLgogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgdGhlIGBzZXRUaW1lb3V0YCB0aW1lb3V0IGlkLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbG9nID0gXy5iaW5kKGNvbnNvbGUubG9nLCBjb25zb2xlKTsKICAgKiBfLmRlbGF5KGxvZywgMTAwMCwgJ2xvZ2dlZCBsYXRlcicpOwogICAqIC8vID0+ICdsb2dnZWQgbGF0ZXInIChBcHBlYXJzIGFmdGVyIG9uZSBzZWNvbmQuKQogICAqLwogIGZ1bmN0aW9uIGRlbGF5KGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHJldHVybiBmdW5jLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7IH0sIHdhaXQpOwogIH0KCiAgLyoqCiAgICogRGVmZXJzIGV4ZWN1dGluZyB0aGUgYGZ1bmNgIGZ1bmN0aW9uIHVudGlsIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzIGNsZWFyZWQuCiAgICogQWRkaXRpb25hbCBhcmd1bWVudHMgYXJlIHBhc3NlZCB0byBgZnVuY2Agd2hlbiBpdCBpcyBpbnZva2VkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlZmVyLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIGZ1bmN0aW9uIHdpdGguCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgYHNldFRpbWVvdXRgIHRpbWVvdXQgaWQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZGVmZXIoZnVuY3Rpb24oKSB7IGFsZXJ0KCdkZWZlcnJlZCcpOyB9KTsKICAgKiAvLyByZXR1cm5zIGZyb20gdGhlIGZ1bmN0aW9uIGJlZm9yZSBgYWxlcnRgIGlzIGNhbGxlZAogICAqLwogIGZ1bmN0aW9uIGRlZmVyKGZ1bmMpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHJldHVybiBmdW5jLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7IH0sIDEpOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBmdW5jdGlvbiB0aGF0IG1lbW9pemVzIHRoZSByZXN1bHQgb2YgYGZ1bmNgLiBJZiBgcmVzb2x2ZXJgIGlzCiAgICogcGFzc2VkLCBpdCB3aWxsIGJlIHVzZWQgdG8gZGV0ZXJtaW5lIHRoZSBjYWNoZSBrZXkgZm9yIHN0b3JpbmcgdGhlIHJlc3VsdAogICAqIGJhc2VkIG9uIHRoZSBhcmd1bWVudHMgcGFzc2VkIHRvIHRoZSBtZW1vaXplZCBmdW5jdGlvbi4gQnkgZGVmYXVsdCwgdGhlIGZpcnN0CiAgICogYXJndW1lbnQgcGFzc2VkIHRvIHRoZSBtZW1vaXplZCBmdW5jdGlvbiBpcyB1c2VkIGFzIHRoZSBjYWNoZSBrZXkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gaGF2ZSBpdHMgb3V0cHV0IG1lbW9pemVkLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtyZXNvbHZlcl0gQSBmdW5jdGlvbiB1c2VkIHRvIHJlc29sdmUgdGhlIGNhY2hlIGtleS4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBtZW1vaXppbmcgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBmaWJvbmFjY2kgPSBfLm1lbW9pemUoZnVuY3Rpb24obikgewogICAqICAgcmV0dXJuIG4gPCAyID8gbiA6IGZpYm9uYWNjaShuIC0gMSkgKyBmaWJvbmFjY2kobiAtIDIpOwogICAqIH0pOwogICAqLwogIGZ1bmN0aW9uIG1lbW9pemUoZnVuYywgcmVzb2x2ZXIpIHsKICAgIHZhciBjYWNoZSA9IHt9OwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgcHJvcCA9IHJlc29sdmVyID8gcmVzb2x2ZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGFyZ3VtZW50c1swXTsKICAgICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoY2FjaGUsIHByb3ApCiAgICAgICAgPyBjYWNoZVtwcm9wXQogICAgICAgIDogKGNhY2hlW3Byb3BdID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGZ1bmN0aW9uIHRoYXQgaXMgcmVzdHJpY3RlZCB0byBvbmUgZXhlY3V0aW9uLiBSZXBlYXQgY2FsbHMgdG8KICAgKiB0aGUgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHZhbHVlIG9mIHRoZSBmaXJzdCBjYWxsLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHJlc3RyaWN0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHJlc3RyaWN0ZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBpbml0aWFsaXplID0gXy5vbmNlKGNyZWF0ZUFwcGxpY2F0aW9uKTsKICAgKiBpbml0aWFsaXplKCk7CiAgICogaW5pdGlhbGl6ZSgpOwogICAqIC8vIEFwcGxpY2F0aW9uIGlzIG9ubHkgY3JlYXRlZCBvbmNlLgogICAqLwogIGZ1bmN0aW9uIG9uY2UoZnVuYykgewogICAgdmFyIHJlc3VsdCwKICAgICAgICByYW4gPSBmYWxzZTsKCiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyYW4pIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHJhbiA9IHRydWU7CiAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBpbnZva2VzIGBmdW5jYCB3aXRoIGFueSBhZGRpdGlvbmFsCiAgICogYHBhcnRpYWxgIGFyZ3VtZW50cyBwcmVwZW5kZWQgdG8gdGhvc2UgcGFzc2VkIHRvIHRoZSBwYXJ0aWFsbHkgYXBwbGllZAogICAqIGZ1bmN0aW9uLiBUaGlzIG1ldGhvZCBpcyBzaW1pbGFyIGBiaW5kYCwgZXhjZXB0IGl0IGRvZXMgKipub3QqKiBhbHRlciB0aGUKICAgKiBgdGhpc2AgYmluZGluZy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBwYXJ0aWFsbHkgYXBwbHkgYXJndW1lbnRzIHRvLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcsIG5hbWUpIHsgcmV0dXJuIGdyZWV0aW5nICsgJzogJyArIG5hbWU7IH07CiAgICogdmFyIGhpID0gXy5wYXJ0aWFsKGdyZWV0LCAnaGknKTsKICAgKiBoaSgnbW9lJyk7CiAgICogLy8gPT4gJ2hpOiBtb2UnCiAgICovCiAgZnVuY3Rpb24gcGFydGlhbChmdW5jKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwKICAgICAgICBhcmdzTGVuZ3RoID0gYXJncy5sZW5ndGg7CgogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgcmVzdWx0LAogICAgICAgICAgb3RoZXJzID0gYXJndW1lbnRzOwoKICAgICAgaWYgKG90aGVycy5sZW5ndGgpIHsKICAgICAgICBhcmdzLmxlbmd0aCA9IGFyZ3NMZW5ndGg7CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBvdGhlcnMpOwogICAgICB9CiAgICAgIHJlc3VsdCA9IGFyZ3MubGVuZ3RoID09IDEgPyBmdW5jLmNhbGwodGhpcywgYXJnc1swXSkgOiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICBhcmdzLmxlbmd0aCA9IGFyZ3NMZW5ndGg7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBmdW5jdGlvbiB0aGF0LCB3aGVuIGV4ZWN1dGVkLCB3aWxsIG9ubHkgY2FsbCB0aGUgYGZ1bmNgCiAgICogZnVuY3Rpb24gYXQgbW9zdCBvbmNlIHBlciBldmVyeSBgd2FpdGAgbWlsbGlzZWNvbmRzLiBJZiB0aGUgdGhyb3R0bGVkCiAgICogZnVuY3Rpb24gaXMgaW52b2tlZCBtb3JlIHRoYW4gb25jZSBkdXJpbmcgdGhlIGB3YWl0YCB0aW1lb3V0LCBgZnVuY2Agd2lsbAogICAqIGFsc28gYmUgY2FsbGVkIG9uIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0LiBTdWJzZXF1ZW50IGNhbGxzIHRvIHRoZQogICAqIHRocm90dGxlZCBmdW5jdGlvbiB3aWxsIHJldHVybiB0aGUgcmVzdWx0IG9mIHRoZSBsYXN0IGBmdW5jYCBjYWxsLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHRocm90dGxlLgogICAqIEBwYXJhbSB7TnVtYmVyfSB3YWl0IFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHRocm90dGxlIGV4ZWN1dGlvbnMgdG8uCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgdGhyb3R0bGVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgdGhyb3R0bGVkID0gXy50aHJvdHRsZSh1cGRhdGVQb3NpdGlvbiwgMTAwKTsKICAgKiBqUXVlcnkod2luZG93KS5vbignc2Nyb2xsJywgdGhyb3R0bGVkKTsKICAgKi8KICBmdW5jdGlvbiB0aHJvdHRsZShmdW5jLCB3YWl0KSB7CiAgICB2YXIgYXJncywKICAgICAgICByZXN1bHQsCiAgICAgICAgdGhpc0FyZywKICAgICAgICB0aW1lb3V0SWQsCiAgICAgICAgbGFzdENhbGxlZCA9IDA7CgogICAgZnVuY3Rpb24gdHJhaWxpbmdDYWxsKCkgewogICAgICBsYXN0Q2FsbGVkID0gbmV3IERhdGU7CiAgICAgIHRpbWVvdXRJZCA9IG51bGw7CiAgICAgIGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbm93ID0gbmV3IERhdGUsCiAgICAgICAgICByZW1haW4gPSB3YWl0IC0gKG5vdyAtIGxhc3RDYWxsZWQpOwoKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdGhpc0FyZyA9IHRoaXM7CgogICAgICBpZiAocmVtYWluIDw9IDApIHsKICAgICAgICBsYXN0Q2FsbGVkID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoIXRpbWVvdXRJZCkgewogICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQodHJhaWxpbmdDYWxsLCByZW1haW4pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlIGEgbmV3IGZ1bmN0aW9uIHRoYXQgcGFzc2VzIHRoZSBgZnVuY2AgZnVuY3Rpb24gdG8gdGhlIGB3cmFwcGVyYAogICAqIGZ1bmN0aW9uIGFzIGl0cyBmaXJzdCBhcmd1bWVudC4gQWRkaXRpb25hbCBhcmd1bWVudHMgYXJlIGFwcGVuZGVkIHRvIHRob3NlCiAgICogcGFzc2VkIHRvIHRoZSBgd3JhcHBlcmAgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gd3JhcC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSB3cmFwcGVyIFRoZSB3cmFwcGVyIGZ1bmN0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBhcHBlbmQgdG8gdGhvc2UgcGFzc2VkIHRvIHRoZSB3cmFwcGVyLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgaGVsbG8gPSBmdW5jdGlvbihuYW1lKSB7IHJldHVybiAnaGVsbG86ICcgKyBuYW1lOyB9OwogICAqIGhlbGxvID0gXy53cmFwKGhlbGxvLCBmdW5jdGlvbihmdW5jKSB7CiAgICogICByZXR1cm4gJ2JlZm9yZSwgJyArIGZ1bmMoJ21vZScpICsgJywgYWZ0ZXInOwogICAqIH0pOwogICAqIGhlbGxvKCk7CiAgICogLy8gPT4gJ2JlZm9yZSwgaGVsbG86IG1vZSwgYWZ0ZXInCiAgICovCiAgZnVuY3Rpb24gd3JhcChmdW5jLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gW2Z1bmNdOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgfQogICAgICByZXR1cm4gd3JhcHBlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH07CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogQ3JlYXRlIGEgc2hhbGxvdyBjbG9uZSBvZiB0aGUgYHZhbHVlYC4gQW55IG5lc3RlZCBvYmplY3RzIG9yIGFycmF5cyB3aWxsIGJlCiAgICogYXNzaWduZWQgYnkgcmVmZXJlbmNlIGFuZCBub3QgY2xvbmVkLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2xvbmUuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBjbG9uZWQgYHZhbHVlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5jbG9uZSh7ICduYW1lJzogJ21vZScgfSk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnIH07CiAgICovCiAgZnVuY3Rpb24gY2xvbmUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAmJiBvYmplY3RUeXBlc1t0eXBlb2YgdmFsdWVdCiAgICAgID8gKGlzQXJyYXkodmFsdWUpID8gdmFsdWUuc2xpY2UoKSA6IGV4dGVuZCh7fSwgdmFsdWUpKQogICAgICA6IHZhbHVlOwogIH0KCiAgLyoqCiAgICogQXNzaWducyBtaXNzaW5nIHByb3BlcnRpZXMgb24gYG9iamVjdGAgd2l0aCBkZWZhdWx0IHZhbHVlcyBmcm9tIHRoZSBkZWZhdWx0cwogICAqIG9iamVjdHMuIE9uY2UgYSBwcm9wZXJ0eSBpcyBzZXQsIGFkZGl0aW9uYWwgZGVmYXVsdHMgb2YgdGhlIHNhbWUgcHJvcGVydHkKICAgKiB3aWxsIGJlIGlnbm9yZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBwb3B1bGF0ZS4KICAgKiBAcGFyYW0ge09iamVjdH0gW2RlZmF1bHRzMSwgZGVmYXVsdHMyLCAuLi5dIFRoZSBkZWZhdWx0cyBvYmplY3RzIHRvIGFwcGx5IHRvIGBvYmplY3RgLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBpY2VDcmVhbSA9IHsgJ2ZsYXZvcic6ICdjaG9jb2xhdGUnIH07CiAgICogXy5kZWZhdWx0cyhpY2VDcmVhbSwgeyAnZmxhdm9yJzogJ3ZhbmlsbGEnLCAnc3ByaW5rbGVzJzogJ3JhaW5ib3cnIH0pOwogICAqIC8vID0+IHsgJ2ZsYXZvcic6ICdjaG9jb2xhdGUnLCAnc3ByaW5rbGVzJzogJ3JhaW5ib3cnIH0KICAgKi8KICB2YXIgZGVmYXVsdHMgPSBjcmVhdGVJdGVyYXRvcihleHRlbmRJdGVyYXRvck9wdGlvbnMsIHsKICAgICdpbkxvb3AnOiAnaWYgKHJlc3VsdFtpbmRleF0gPT0gbnVsbCkgJyArIGV4dGVuZEl0ZXJhdG9yT3B0aW9ucy5pbkxvb3AKICB9KTsKCiAgLyoqCiAgICogQ29waWVzIGVudW1lcmFibGUgcHJvcGVydGllcyBmcm9tIHRoZSBzb3VyY2Ugb2JqZWN0cyB0byB0aGUgYGRlc3RpbmF0aW9uYCBvYmplY3QuCiAgICogU3Vic2VxdWVudCBzb3VyY2VzIHdpbGwgb3ZlcndyaXRlIHByb3BlcnkgYXNzaWdubWVudHMgb2YgcHJldmlvdXMgc291cmNlcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBbc291cmNlMSwgc291cmNlMiwgLi4uXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmV4dGVuZCh7ICduYW1lJzogJ21vZScgfSwgeyAnYWdlJzogNDAgfSk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfQogICAqLwogIHZhciBleHRlbmQgPSBjcmVhdGVJdGVyYXRvcihleHRlbmRJdGVyYXRvck9wdGlvbnMpOwoKICAvKioKICAgKiBJdGVyYXRlcyBvdmVyIGBvYmplY3RgJ3Mgb3duIGFuZCBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLCBleGVjdXRpbmcKICAgKiB0aGUgYGNhbGxiYWNrYCBmb3IgZWFjaCBwcm9wZXJ0eS4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZAogICAqIGludm9rZWQgd2l0aCAzIGFyZ3VtZW50czsgKHZhbHVlLCBrZXksIG9iamVjdCkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBgb2JqZWN0YC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogZnVuY3Rpb24gRG9nKG5hbWUpIHsKICAgKiAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICogfQogICAqCiAgICogRG9nLnByb3RvdHlwZS5iYXJrID0gZnVuY3Rpb24oKSB7CiAgICogICBhbGVydCgnV29vZiwgd29vZiEnKTsKICAgKiB9OwogICAqCiAgICogXy5mb3JJbihuZXcgRG9nKCdEYWdueScpLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICogICBhbGVydChrZXkpOwogICAqIH0pOwogICAqIC8vID0+IGFsZXJ0cyAnbmFtZScgYW5kICdiYXJrJyAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgdmFyIGZvckluID0gY3JlYXRlSXRlcmF0b3IoYmFzZUl0ZXJhdG9yT3B0aW9ucywgZm9yRWFjaEl0ZXJhdG9yT3B0aW9ucywgZm9yT3duSXRlcmF0b3JPcHRpb25zLCB7CiAgICAndXNlSGFzJzogZmFsc2UKICB9KTsKCiAgLyoqCiAgICogSXRlcmF0ZXMgb3ZlciBgb2JqZWN0YCdzIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMsIGV4ZWN1dGluZyB0aGUgYGNhbGxiYWNrYAogICAqIGZvciBlYWNoIHByb3BlcnR5LiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCAzCiAgICogYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGBvYmplY3RgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmZvck93bih7ICcwJzogJ3plcm8nLCAnMSc6ICdvbmUnLCAnbGVuZ3RoJzogMiB9LCBmdW5jdGlvbihudW0sIGtleSkgewogICAqICAgYWxlcnQoa2V5KTsKICAgKiB9KTsKICAgKiAvLyA9PiBhbGVydHMgJzAnLCAnMScsIGFuZCAnbGVuZ3RoJyAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgdmFyIGZvck93biA9IGNyZWF0ZUl0ZXJhdG9yKGJhc2VJdGVyYXRvck9wdGlvbnMsIGZvckVhY2hJdGVyYXRvck9wdGlvbnMsIGZvck93bkl0ZXJhdG9yT3B0aW9ucyk7CgogIC8qKgogICAqIFByb2R1Y2VzIGEgc29ydGVkIGFycmF5IG9mIHRoZSBlbnVtZXJhYmxlIHByb3BlcnRpZXMsIG93biBhbmQgaW5oZXJpdGVkLAogICAqIG9mIGBvYmplY3RgIHRoYXQgaGF2ZSBmdW5jdGlvbiB2YWx1ZXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgbWV0aG9kcwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IG5hbWVzIHRoYXQgaGF2ZSBmdW5jdGlvbiB2YWx1ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZnVuY3Rpb25zKF8pOwogICAqIC8vID0+IFsnYWxsJywgJ2FueScsICdiaW5kJywgJ2JpbmRBbGwnLCAnY2xvbmUnLCAnY29tcGFjdCcsICdjb21wb3NlJywgLi4uXQogICAqLwogIHZhciBmdW5jdGlvbnMgPSBjcmVhdGVJdGVyYXRvcih7CiAgICAndXNlSGFzJzogZmFsc2UsCiAgICAnYXJncyc6ICdvYmplY3QnLAogICAgJ2luaXQnOiAnW10nLAogICAgJ2luTG9vcCc6ICdpZiAodG9TdHJpbmcuY2FsbChpdGVyYXRlZVtpbmRleF0pID09IGZ1bmNDbGFzcykgcmVzdWx0LnB1c2goaW5kZXgpJywKICAgICdib3R0b20nOiAncmVzdWx0LnNvcnQoKScKICB9KTsKCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBzcGVjaWZpZWQgb2JqZWN0IGBwcm9wZXJ0eWAgZXhpc3RzIGFuZCBpcyBhIGRpcmVjdCBwcm9wZXJ0eSwKICAgKiBpbnN0ZWFkIG9mIGFuIGluaGVyaXRlZCBwcm9wZXJ0eS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGNoZWNrLgogICAqIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eSBUaGUgcHJvcGVydHkgdG8gY2hlY2sgZm9yLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBrZXkgaXMgYSBkaXJlY3QgcHJvcGVydHksIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5oYXMoeyAnYSc6IDEsICdiJzogMiwgJ2MnOiAzIH0sICdiJyk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGhhcyhvYmplY3QsIHByb3BlcnR5KSB7CiAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIHByb3BlcnR5KTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGBhcmd1bWVudHNgIG9iamVjdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBgYXJndW1lbnRzYCBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogKGZ1bmN0aW9uKCkgeyByZXR1cm4gXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpOyB9KSgxLCAyLCAzKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzQXJndW1lbnRzKFsxLCAyLCAzXSk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICB2YXIgaXNBcmd1bWVudHMgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09ICdbb2JqZWN0IEFyZ3VtZW50c10nOwogIH07CiAgLy8gZmFsbGJhY2sgZm9yIGJyb3dzZXIgbGlrZSBJRSA8IDkgd2hpY2ggZGV0ZWN0IGBhcmd1bWVudHNgIGFzIGBbb2JqZWN0IE9iamVjdF1gCiAgaWYgKCFpc0FyZ3VtZW50cyhhcmd1bWVudHMpKSB7CiAgICBpc0FyZ3VtZW50cyA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiAhISh2YWx1ZSAmJiBoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCAnY2FsbGVlJykpOwogICAgfTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGFycmF5LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGFuIGFycmF5LCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8uaXNBcnJheShhcmd1bWVudHMpOyB9KSgpOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmlzQXJyYXkoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgdmFyIGlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gYXJyYXlDbGFzczsKICB9OwoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIGJvb2xlYW4gKGB0cnVlYCBvciBgZmFsc2VgKSB2YWx1ZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIGJvb2xlYW4gdmFsdWUsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0Jvb2xlYW4obnVsbCk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gYm9vbENsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBkYXRlLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgZGF0ZSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRGF0ZShuZXcgRGF0ZSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzRGF0ZSh2YWx1ZSkgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGRhdGVDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRWxlbWVudChkb2N1bWVudC5ib2R5KTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNFbGVtZW50KHZhbHVlKSB7CiAgICByZXR1cm4gISEodmFsdWUgJiYgdmFsdWUubm9kZVR5cGUgPT0gMSk7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBlbXB0eS4gQXJyYXlzIG9yIHN0cmluZ3Mgd2l0aCBhIGxlbmd0aCBvZiBgMGAgYW5kCiAgICogb2JqZWN0cyB3aXRoIG5vIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYXJlIGNvbnNpZGVyZWQgImVtcHR5Ii4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgZW1wdHksIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0VtcHR5KFsxLCAyLCAzXSk7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNFbXB0eSh7fSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc0VtcHR5KCcnKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgdmFyIGlzRW1wdHkgPSBjcmVhdGVJdGVyYXRvcih7CiAgICAnYXJncyc6ICd2YWx1ZScsCiAgICAnaW5pdCc6ICd0cnVlJywKICAgICd0b3AnOgogICAgICAndmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwodmFsdWUpO1xuJyArCiAgICAgICdpZiAoY2xhc3NOYW1lID09IGFycmF5Q2xhc3MgfHwgY2xhc3NOYW1lID09IHN0cmluZ0NsYXNzKSByZXR1cm4gIXZhbHVlLmxlbmd0aCcsCiAgICAnaW5Mb29wJzogewogICAgICAnb2JqZWN0JzogJ3JldHVybiBmYWxzZScKICAgIH0KICB9KTsKCiAgLyoqCiAgICogUGVyZm9ybXMgYSBkZWVwIGNvbXBhcmlzb24gYmV0d2VlbiB0d28gdmFsdWVzIHRvIGRldGVybWluZSBpZiB0aGV5IGFyZQogICAqIGVxdWl2YWxlbnQgdG8gZWFjaCBvdGhlci4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gYSBUaGUgdmFsdWUgdG8gY29tcGFyZS4KICAgKiBAcGFyYW0ge01peGVkfSBiIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja10gSW50ZXJuYWxseSB1c2VkIHRvIGtlZXAgdHJhY2sgb2YgInNlZW4iIG9iamVjdHMgdG8KICAgKiAgYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcy4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHZhbHVlcyBhcmUgZXF1dmFsZW50LCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBtb2UgPSB7ICduYW1lJzogJ21vZScsICdsdWNreU51bWJlcnMnOiBbMTMsIDI3LCAzNF0gfTsKICAgKiB2YXIgY2xvbmUgPSB7ICduYW1lJzogJ21vZScsICdsdWNreU51bWJlcnMnOiBbMTMsIDI3LCAzNF0gfTsKICAgKgogICAqIG1vZSA9PSBjbG9uZTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0VxdWFsKG1vZSwgY2xvbmUpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc0VxdWFsKGEsIGIsIHN0YWNrKSB7CiAgICBzdGFjayB8fCAoc3RhY2sgPSBbXSk7CgogICAgLy8gZXhpdCBlYXJseSBmb3IgaWRlbnRpY2FsIHZhbHVlcwogICAgaWYgKGEgPT09IGIpIHsKICAgICAgLy8gdHJlYXQgYCswYCB2cy4gYC0wYCBhcyBub3QgZXF1YWwKICAgICAgcmV0dXJuIGEgIT09IDAgfHwgKDEgLyBhID09IDEgLyBiKTsKICAgIH0KICAgIC8vIGEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYHVuZGVmaW5lZCA9PSBudWxsYAogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHsKICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICB9CiAgICAvLyB1bndyYXAgYW55IHdyYXBwZWQgb2JqZWN0cwogICAgaWYgKGEuX2NoYWluKSB7CiAgICAgIGEgPSBhLl93cmFwcGVkOwogICAgfQogICAgaWYgKGIuX2NoYWluKSB7CiAgICAgIGIgPSBiLl93cmFwcGVkOwogICAgfQogICAgLy8gaW52b2tlIGEgY3VzdG9tIGBpc0VxdWFsYCBtZXRob2QgaWYgb25lIGlzIHByb3ZpZGVkCiAgICBpZiAoYS5pc0VxdWFsICYmIHRvU3RyaW5nLmNhbGwoYS5pc0VxdWFsKSA9PSBmdW5jQ2xhc3MpIHsKICAgICAgcmV0dXJuIGEuaXNFcXVhbChiKTsKICAgIH0KICAgIGlmIChiLmlzRXF1YWwgJiYgdG9TdHJpbmcuY2FsbChiLmlzRXF1YWwpID09IGZ1bmNDbGFzcykgewogICAgICByZXR1cm4gYi5pc0VxdWFsKGEpOwogICAgfQogICAgLy8gY29tcGFyZSBbW0NsYXNzXV0gbmFtZXMKICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpOwogICAgaWYgKGNsYXNzTmFtZSAhPSB0b1N0cmluZy5jYWxsKGIpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIC8vIHN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlCiAgICAgIGNhc2Ugc3RyaW5nQ2xhc3M6CiAgICAgICAgLy8gcHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3QgaW5zdGFuY2VzIGFyZSBlcXVpdmFsZW50OwogICAgICAgIC8vIHRodXMsIGAnNSdgIGlzIHF1aXZhbGVudCB0byBgbmV3IFN0cmluZygnNScpYAogICAgICAgIHJldHVybiBhID09IFN0cmluZyhiKTsKCiAgICAgIGNhc2UgbnVtYmVyQ2xhc3M6CiAgICAgICAgLy8gdHJlYXQgYE5hTmAgdnMuIGBOYU5gIGFzIGVxdWFsCiAgICAgICAgcmV0dXJuIGEgIT0gK2EKICAgICAgICAgID8gYiAhPSArYgogICAgICAgICAgLy8gYnV0IHRyZWF0IGArMGAgdnMuIGAtMGAgYXMgbm90IGVxdWFsCiAgICAgICAgICA6IChhID09IDAgPyAoMSAvIGEgPT0gMSAvIGIpIDogYSA9PSArYik7CgogICAgICBjYXNlIGJvb2xDbGFzczoKICAgICAgY2FzZSBkYXRlQ2xhc3M6CiAgICAgICAgLy8gY29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHZhbHVlcywgZGF0ZXMgdG8gbWlsbGlzZWNvbmRzIGFuZAogICAgICAgIC8vIGJvb2xlYW5zIHRvIDEgb3IgMDsgdHJlYXQgaW52YWxpZCBkYXRlcyBjb2VyY2VkIHRvIGBOYU5gIGFzIG5vdCBlcXVhbAogICAgICAgIHJldHVybiArYSA9PSArYjsKCiAgICAgIC8vIHJlZ2V4cHMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyIHNvdXJjZSBhbmQgZmxhZ3MKICAgICAgY2FzZSByZWdleHBDbGFzczoKICAgICAgICByZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYKICAgICAgICAgICAgICAgYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYKICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYKICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvLyBBc3N1bWUgZXF1YWxpdHkgZm9yIGN5Y2xpYyBzdHJ1Y3R1cmVzLiBUaGUgYWxnb3JpdGhtIGZvciBkZXRlY3RpbmcgY3ljbGljCiAgICAvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KICAgIHZhciBsZW5ndGggPSBzdGFjay5sZW5ndGg7CiAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgLy8gTGluZWFyIHNlYXJjaC4gUGVyZm9ybWFuY2UgaXMgaW52ZXJzZWx5IHByb3BvcnRpb25hbCB0byB0aGUgbnVtYmVyIG9mCiAgICAgIC8vIHVuaXF1ZSBuZXN0ZWQgc3RydWN0dXJlcy4KICAgICAgaWYgKHN0YWNrW2xlbmd0aF0gPT0gYSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CgogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcmVzdWx0ID0gdHJ1ZSwKICAgICAgICBzaXplID0gMDsKCiAgICAvLyBhZGQgdGhlIGZpcnN0IGNvbGxlY3Rpb24gdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzCiAgICBzdGFjay5wdXNoKGEpOwoKICAgIC8vIHJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyBhbmQgYXJyYXlzCiAgICBpZiAoY2xhc3NOYW1lID09IGFycmF5Q2xhc3MpIHsKICAgICAgLy8gY29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkKICAgICAgc2l6ZSA9IGEubGVuZ3RoOwogICAgICByZXN1bHQgPSBzaXplID09IGIubGVuZ3RoOwoKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIGRlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMKICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBpc0VxdWFsKGFbc2l6ZV0sIGJbc2l6ZV0sIHN0YWNrKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBvYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQKICAgICAgaWYgKCdjb25zdHJ1Y3RvcicgaW4gYSAhPSAnY29uc3RydWN0b3InIGluIGIgfHwgYS5jb25zdHJ1Y3RvciAhPSBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIGRlZXAgY29tcGFyZSBvYmplY3RzLgogICAgICBmb3IgKHZhciBwcm9wIGluIGEpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChhLCBwcm9wKSkgewogICAgICAgICAgLy8gY291bnQgdGhlIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgLy8gZGVlcCBjb21wYXJlIGVhY2ggcHJvcGVydHkgdmFsdWUuCiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHByb3ApICYmIGlzRXF1YWwoYVtwcm9wXSwgYltwcm9wXSwgc3RhY2spKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gZW5zdXJlIGJvdGggb2JqZWN0cyBoYXZlIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzCiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICBmb3IgKHByb3AgaW4gYikgewogICAgICAgICAgLy8gQWRvYmUncyBKUyBlbmdpbmUsIGVtYmVkZGVkIGluIGFwcGxpY2F0aW9ucyBsaWtlIEluRGVzaWduLCBoYXMgYQogICAgICAgICAgLy8gYnVnIHRoYXQgY2F1c2VzIGAhc2l6ZS0tYCB0byB0aHJvdyBhbiBlcnJvciBzbyBpdCBtdXN0IGJlIHdyYXBwZWQKICAgICAgICAgIC8vIGluIHBhcmVudGhlc2VzLgogICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2RvY3VtZW50Y2xvdWQvdW5kZXJzY29yZS9pc3N1ZXMvMzU1CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChiLCBwcm9wKSAmJiAhKHNpemUtLSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9ICFzaXplOwogICAgICB9CiAgICAgIC8vIGhhbmRsZSBKU2NyaXB0IFtbRG9udEVudW1dXSBidWcKICAgICAgaWYgKHJlc3VsdCAmJiBoYXNEb250RW51bUJ1ZykgewogICAgICAgIHdoaWxlICgrK2luZGV4IDwgNykgewogICAgICAgICAgcHJvcCA9IHNoYWRvd2VkW2luZGV4XTsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGEsIHByb3ApKSB7CiAgICAgICAgICAgIGlmICghKHJlc3VsdCA9IGhhc093blByb3BlcnR5LmNhbGwoYiwgcHJvcCkgJiYgaXNFcXVhbChhW3Byb3BdLCBiW3Byb3BdLCBzdGFjaykpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIHJlbW92ZSB0aGUgZmlyc3QgY29sbGVjdGlvbiBmcm9tIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgc3RhY2sucG9wKCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBmaW5pdGUgbnVtYmVyLgogICAqIE5vdGU6IFRoaXMgaXMgbm90IHRoZSBzYW1lIGFzIG5hdGl2ZSBgaXNGaW5pdGVgLCB3aGljaCB3aWxsIHJldHVybiB0cnVlIGZvcgogICAqIGJvb2xlYW5zIGFuZCBvdGhlciB2YWx1ZXMuIFNlZSBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS4xLjIuNS4KICAgKgogICAqIEBkZXByZWNhdGVkCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgZmluaXRlIG51bWJlciwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRmluaXRlKC0xMDEpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNGaW5pdGUoJzEwJyk7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNGaW5pdGUoSW5maW5pdHkpOwogICAqIC8vID0+IGZhbHNlCiAgICovCiAgZnVuY3Rpb24gaXNGaW5pdGUodmFsdWUpIHsKICAgIHJldHVybiBuYXRpdmVJc0Zpbml0ZSh2YWx1ZSkgJiYgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gbnVtYmVyQ2xhc3M7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgZnVuY3Rpb24sIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc0Z1bmN0aW9uKCcnLmNvbmNhdCk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBmdW5jQ2xhc3M7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyB0aGUgbGFuZ3VhZ2UgdHlwZSBvZiBPYmplY3QuCiAgICogKGUuZy4gYXJyYXlzLCBmdW5jdGlvbnMsIG9iamVjdHMsIHJlZ2V4cHMsIGBuZXcgTnVtYmVyKDApYCwgYW5kIGBuZXcgU3RyaW5nKCcnKWApCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYW4gb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNPYmplY3Qoe30pOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNPYmplY3QoMSk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgLy8gY2hlY2sgaWYgdGhlIHZhbHVlIGlzIHRoZSBFQ01BU2NyaXB0IGxhbmd1YWdlIHR5cGUgb2YgT2JqZWN0CiAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3g4CiAgICByZXR1cm4gdmFsdWUgJiYgb2JqZWN0VHlwZXNbdHlwZW9mIHZhbHVlXTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGBOYU5gLgogICAqIE5vdGU6IFRoaXMgaXMgbm90IHRoZSBzYW1lIGFzIG5hdGl2ZSBgaXNOYU5gLCB3aGljaCB3aWxsIHJldHVybiB0cnVlIGZvcgogICAqIGB1bmRlZmluZWRgIGFuZCBvdGhlciB2YWx1ZXMuIFNlZSBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS4xLjIuNC4KICAgKgogICAqIEBkZXByZWNhdGVkCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGBOYU5gLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNOYU4oTmFOKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzTmFOKG5ldyBOdW1iZXIoTmFOKSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogaXNOYU4odW5kZWZpbmVkKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzTmFOKHVuZGVmaW5lZCk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc05hTih2YWx1ZSkgewogICAgLy8gYE5hTmAgYXMgYSBwcmltaXRpdmUgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBpcyBub3QgZXF1YWwgdG8gaXRzZWxmCiAgICAvLyAocGVyZm9ybSB0aGUgW1tDbGFzc11dIGNoZWNrIGZpcnN0IHRvIGF2b2lkIGVycm9ycyB3aXRoIHNvbWUgaG9zdCBvYmplY3RzIGluIElFKQogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IG51bWJlckNsYXNzICYmIHZhbHVlICE9ICt2YWx1ZQogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYG51bGxgLgogICAqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYG51bGxgLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNOdWxsKG51bGwpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNOdWxsKHVuZGVmaW5lZCk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc051bGwodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgbnVtYmVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgbnVtYmVyLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNOdW1iZXIoOC40ICogNTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBudW1iZXJDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgcmVndWxhciBleHByZXNzaW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgcmVndWxhciBleHByZXNzaW9uLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNSZWdFeHAoL21vZS8pOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc1JlZ0V4cCh2YWx1ZSkgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IHJlZ2V4cENsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBzdHJpbmcuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBzdHJpbmcsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc1N0cmluZygnbW9lJyk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gc3RyaW5nQ2xhc3M7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgdW5kZWZpbmVkYC4KICAgKgogICAqIEBkZXByZWNhdGVkCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGB1bmRlZmluZWRgLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNVbmRlZmluZWQodm9pZCAwKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNVbmRlZmluZWQodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkOwogIH0KCiAgLyoqCiAgICogUHJvZHVjZXMgYW4gYXJyYXkgb2Ygb2JqZWN0YCdzIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IG5hbWVzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ua2V5cyh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgKiAvLyA9PiBbJ29uZScsICd0d28nLCAndGhyZWUnXSAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgdmFyIGtleXMgPSAhbmF0aXZlS2V5cyA/IHNoaW1LZXlzIDogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAvLyBhdm9pZCBpdGVyYXRpbmcgb3ZlciB0aGUgYHByb3RvdHlwZWAgcHJvcGVydHkKICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09ICdmdW5jdGlvbicgJiYgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChvYmplY3QsICdwcm90b3R5cGUnKQogICAgICA/IHNoaW1LZXlzKG9iamVjdCkKICAgICAgOiBuYXRpdmVLZXlzKG9iamVjdCk7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2YgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLiBQcm9wZXJ0eSBuYW1lcyBtYXkKICAgKiBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzIG9mIHByb3BlcnR5IG5hbWVzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcGx1Y2suCiAgICogQHBhcmFtIHtPYmplY3R9IFtwcm9wMSwgcHJvcDIsIC4uLl0gVGhlIHByb3BlcnRpZXMgdG8gcGljay4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgcGlja2VkIHByb3BlcnRpZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ucGljayh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCwgJ3VzZXJpZCc6ICdtb2UxJyB9LCAnbmFtZScsICdhZ2UnKTsKICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9CiAgICovCiAgZnVuY3Rpb24gcGljayhvYmplY3QpIHsKICAgIHZhciBwcm9wLAogICAgICAgIGluZGV4ID0gMCwKICAgICAgICBwcm9wcyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBhcmd1bWVudHMpLAogICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICByZXN1bHQgPSB7fTsKCiAgICAvLyBzdGFydCBgaW5kZXhgIGF0IGAxYCB0byBza2lwIGBvYmplY3RgCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBwcm9wID0gcHJvcHNbaW5kZXhdOwogICAgICBpZiAocHJvcCBpbiBvYmplY3QpIHsKICAgICAgICByZXN1bHRbcHJvcF0gPSBvYmplY3RbcHJvcF07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBHZXRzIHRoZSBzaXplIG9mIGB2YWx1ZWAgYnkgcmV0dXJuaW5nIGB2YWx1ZS5sZW5ndGhgIGlmIGB2YWx1ZWAgaXMgYSBzdHJpbmcKICAgKiBvciBhcnJheSwgb3IgdGhlIG51bWJlciBvZiBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIGlmIGB2YWx1ZWAgaXMgYW4gb2JqZWN0LgogICAqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gdmFsdWUgVGhlIHZhbHVlIHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyBgdmFsdWUubGVuZ3RoYCBpZiBgdmFsdWVgIGlzIGEgc3RyaW5nIG9yIGFycmF5LAogICAqICBvciB0aGUgbnVtYmVyIG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgaWYgYHZhbHVlYCBpcyBhbiBvYmplY3QuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uc2l6ZShbMSwgMl0pOwogICAqIC8vID0+IDIKICAgKgogICAqIF8uc2l6ZSh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgKiAvLyA9PiAzCiAgICoKICAgKiBfLnNpemUoJ2N1cmx5Jyk7CiAgICogLy8gPT4gNQogICAqLwogIGZ1bmN0aW9uIHNpemUodmFsdWUpIHsKICAgIGlmICghdmFsdWUpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICB2YXIgbGVuZ3RoID0gdmFsdWUubGVuZ3RoOwogICAgcmV0dXJuIGxlbmd0aCA9PT0gbGVuZ3RoID4+PiAwID8gdmFsdWUubGVuZ3RoIDoga2V5cyh2YWx1ZSkubGVuZ3RoOwogIH0KCiAgLyoqCiAgICogUHJvZHVjZXMgYW4gYXJyYXkgb2YgYG9iamVjdGAncyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0eSB2YWx1ZXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBwcm9wZXJ0eSB2YWx1ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8udmFsdWVzKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0pOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqLwogIHZhciB2YWx1ZXMgPSBjcmVhdGVJdGVyYXRvcih7CiAgICAnYXJncyc6ICdvYmplY3QnLAogICAgJ2luaXQnOiAnW10nLAogICAgJ2luTG9vcCc6ICdyZXN1bHQucHVzaChpdGVyYXRlZVtpbmRleF0pJwogIH0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogRXNjYXBlcyBhIHN0cmluZyBmb3IgaW5jbHVzaW9uIGluIEhUTUwsIHJlcGxhY2luZyBgJmAsIGA8YCwgYCJgLCBhbmQgYCdgCiAgICogY2hhcmFjdGVycy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gZXNjYXBlLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIGVzY2FwZWQgc3RyaW5nLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmVzY2FwZSgnQ3VybHksIExhcnJ5ICYgTW9lJyk7CiAgICogLy8gPT4gIkN1cmx5LCBMYXJyeSAmYW1wOyBNb2UiCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlKHN0cmluZykgewogICAgcmV0dXJuIHN0cmluZyA9PSBudWxsID8gJycgOiAoc3RyaW5nICsgJycpLnJlcGxhY2UocmVVbmVzY2FwZWRIdG1sLCBlc2NhcGVIdG1sQ2hhcik7CiAgfQoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIHJldHVybnMgdGhlIGZpcnN0IGFyZ3VtZW50IHBhc3NlZCB0byBpdC4KICAgKiBOb3RlOiBJdCBpcyB1c2VkIHRocm91Z2hvdXQgTG8tRGFzaCBhcyBhIGRlZmF1bHQgY2FsbGJhY2suCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgQW55IHZhbHVlLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyBgdmFsdWVgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbW9lID0geyAnbmFtZSc6ICdtb2UnIH07CiAgICogbW9lID09PSBfLmlkZW50aXR5KG1vZSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlkZW50aXR5KHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQoKICAvKioKICAgKiBBZGRzIGZ1bmN0aW9ucyBwcm9wZXJ0aWVzIG9mIGBvYmplY3RgIHRvIHRoZSBgbG9kYXNoYCBmdW5jdGlvbiBhbmQgY2hhaW5hYmxlCiAgICogd3JhcHBlci4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3Qgb2YgZnVuY3Rpb24gcHJvcGVydGllcyB0byBhZGQgdG8gYGxvZGFzaGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ubWl4aW4oewogICAqICAgJ2NhcGl0YWxpemUnOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgKiAgICAgcmV0dXJuIHN0cmluZy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0cmluZy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAqICAgfQogICAqIH0pOwogICAqCiAgICogXy5jYXBpdGFsaXplKCdjdXJseScpOwogICAqIC8vID0+ICdDdXJseScKICAgKgogICAqIF8oJ2xhcnJ5JykuY2FwaXRhbGl6ZSgpOwogICAqIC8vID0+ICdMYXJyeScKICAgKi8KICBmdW5jdGlvbiBtaXhpbihvYmplY3QpIHsKICAgIGZvckVhY2goZnVuY3Rpb25zKG9iamVjdCksIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBsb2Rhc2hbbWV0aG9kTmFtZV0gPSBvYmplY3RbbWV0aG9kTmFtZV07CgogICAgICBMb0Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbdGhpcy5fd3JhcHBlZF07CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlc3VsdCA9IGZ1bmMuYXBwbHkobG9kYXNoLCBhcmdzKTsKICAgICAgICBpZiAodGhpcy5fY2hhaW4pIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBMb0Rhc2gocmVzdWx0KTsKICAgICAgICAgIHJlc3VsdC5fY2hhaW4gPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfSk7CiAgfQoKICAvKioKICAgKiBSZXZlcnRzIHRoZSAnXycgdmFyaWFibGUgdG8gaXRzIHByZXZpb3VzIHZhbHVlIGFuZCByZXR1cm5zIGEgcmVmZXJlbmNlIHRvCiAgICogdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBsb2Rhc2ggPSBfLm5vQ29uZmxpY3QoKTsKICAgKi8KICBmdW5jdGlvbiBub0NvbmZsaWN0KCkgewogICAgd2luZG93Ll8gPSBvbGREYXNoOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvKioKICAgKiBSZXNvbHZlcyB0aGUgdmFsdWUgb2YgYHByb3BlcnR5YCBvbiBgb2JqZWN0YC4gSWYgYHByb3BlcnR5YCBpcyBhIGZ1bmN0aW9uCiAgICogaXQgd2lsbCBiZSBpbnZva2VkIGFuZCBpdHMgcmVzdWx0IHJldHVybmVkLCBlbHNlIHRoZSBwcm9wZXJ0eSB2YWx1ZSBpcwogICAqIHJldHVybmVkLiBJZiBgb2JqZWN0YCBpcyBmYWxzZXksIHRoZW4gYG51bGxgIGlzIHJldHVybmVkLgogICAqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBnZXQgdGhlIHJlc3VsdCBvZi4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIHJlc29sdmVkIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgb2JqZWN0ID0gewogICAqICAgJ2NoZWVzZSc6ICdjcnVtcGV0cycsCiAgICogICAnc3R1ZmYnOiBmdW5jdGlvbigpIHsKICAgKiAgICAgcmV0dXJuICdub25zZW5zZSc7CiAgICogICB9CiAgICogfTsKICAgKgogICAqIF8ucmVzdWx0KG9iamVjdCwgJ2NoZWVzZScpOwogICAqIC8vID0+ICdjcnVtcGV0cycKICAgKgogICAqIF8ucmVzdWx0KG9iamVjdCwgJ3N0dWZmJyk7CiAgICogLy8gPT4gJ25vbnNlbnNlJwogICAqLwogIGZ1bmN0aW9uIHJlc3VsdChvYmplY3QsIHByb3BlcnR5KSB7CiAgICAvLyBiYXNlZCBvbiBCYWNrYm9uZSdzIHByaXZhdGUgYGdldFZhbHVlYCBmdW5jdGlvbgogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2RvY3VtZW50Y2xvdWQvYmFja2JvbmUvYmxvYi8wLjkuMi9iYWNrYm9uZS5qcyNMMTQxOS0xNDI0CiAgICBpZiAoIW9iamVjdCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gZnVuY0NsYXNzID8gb2JqZWN0W3Byb3BlcnR5XSgpIDogdmFsdWU7CiAgfQoKICAvKioKICAgKiBBIG1pY3JvLXRlbXBsYXRpbmcgbWV0aG9kIHRoYXQgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzCiAgICogd2hpdGVzcGFjZSwgYW5kIGNvcnJlY3RseSBlc2NhcGVzIHF1b3RlcyB3aXRoaW4gaW50ZXJwb2xhdGVkIGNvZGUuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIHRlbXBsYXRlIHRleHQuCiAgICogQHBhcmFtIHtPYmVjdH0gZGF0YSBUaGUgZGF0YSBvYmplY3QgdXNlZCB0byBwb3B1bGF0ZSB0aGUgdGV4dC4KICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBUaGUgb3B0aW9ucyBvYmplY3QuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufFN0cmluZ30gUmV0dXJucyBhIGNvbXBpbGVkIGZ1bmN0aW9uIHdoZW4gbm8gYGRhdGFgIG9iamVjdAogICAqICBpcyBnaXZlbiwgZWxzZSBpdCByZXR1cm5zIHRoZSBpbnRlcnBvbGF0ZWQgdGV4dC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogLy8gdXNpbmcgY29tcGlsZWQgdGVtcGxhdGUKICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCdoZWxsbzogPCU9IG5hbWUgJT4nKTsKICAgKiBjb21waWxlZCh7ICduYW1lJzogJ21vZScgfSk7CiAgICogLy8gPT4gJ2hlbGxvOiBtb2UnCiAgICoKICAgKiB2YXIgbGlzdCA9ICc8JSBfLmZvckVhY2gocGVvcGxlLCBmdW5jdGlvbihuYW1lKSB7ICU+IDxsaT48JT0gbmFtZSAlPjwvbGk+IDwlIH0pOyAlPic7CiAgICogXy50ZW1wbGF0ZShsaXN0LCB7ICdwZW9wbGUnOiBbJ21vZScsICdjdXJseScsICdsYXJyeSddIH0pOwogICAqIC8vID0+ICc8bGk+bW9lPC9saT48bGk+Y3VybHk8L2xpPjxsaT5sYXJyeTwvbGk+JwogICAqCiAgICogdmFyIHRlbXBsYXRlID0gXy50ZW1wbGF0ZSgnPGI+PCUtIHZhbHVlICU+PC9iPicpOwogICAqIHRlbXBsYXRlKHsgJ3ZhbHVlJzogJzxzY3JpcHQ+JyB9KTsKICAgKiAvLyA9PiAnPGI+Jmx0O3NjcmlwdD48L2I+JwogICAqCiAgICogLy8gdXNpbmcgYHByaW50YAogICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJzwlIHByaW50KCJIZWxsbyAiICsgZXBpdGhldCk7ICU+Jyk7CiAgICogY29tcGlsZWQoeyAnZXBpdGhldCc6ICdzdG9vZ2UnIH0pOwogICAqIC8vID0+ICdIZWxsbyBzdG9vZ2UuJwogICAqCiAgICogLy8gdXNpbmcgY3VzdG9tIHRlbXBsYXRlIHNldHRpbmdzCiAgICogXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAqICAgJ2ludGVycG9sYXRlJzogL1x7XHsoLis/KVx9XH0vZwogICAqIH07CiAgICoKICAgKiB2YXIgdGVtcGxhdGUgPSBfLnRlbXBsYXRlKCdIZWxsbyB7eyBuYW1lIH19IScpOwogICAqIHRlbXBsYXRlKHsgJ25hbWUnOiAnTXVzdGFjaGUnIH0pOwogICAqIC8vID0+ICdIZWxsbyBNdXN0YWNoZSEnCiAgICoKICAgKiAvLyB1c2luZyB0aGUgYHZhcmlhYmxlYCBvcHRpb24KICAgKiBfLnRlbXBsYXRlKCc8JT0gZGF0YS5oYXNXaXRoICU+JywgeyAnaGFzV2l0aCc6ICdubycgfSwgeyAndmFyaWFibGUnOiAnZGF0YScgfSk7CiAgICogLy8gPT4gJ25vJwogICAqCiAgICogLy8gdXNpbmcgdGhlIGBzb3VyY2VgIHByb3BlcnR5CiAgICogPHNjcmlwdD4KICAgKiAgIEpTVC5wcm9qZWN0ID0gPCU9IF8udGVtcGxhdGUoanN0VGV4dCkuc291cmNlICU+OwogICAqIDwvc2NyaXB0PgogICAqLwogIGZ1bmN0aW9uIHRlbXBsYXRlKHRleHQsIGRhdGEsIG9wdGlvbnMpIHsKICAgIC8vIGJhc2VkIG9uIEpvaG4gUmVzaWcncyBgdG1wbGAgaW1wbGVtZW50YXRpb24KICAgIC8vIGh0dHA6Ly9lam9obi5vcmcvYmxvZy9qYXZhc2NyaXB0LW1pY3JvLXRlbXBsYXRpbmcvCiAgICAvLyBhbmQgTGF1cmEgRG9rdG9yb3ZhJ3MgZG9ULmpzCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vb2xhZG8vZG9UCiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoKICAgIHZhciBpc0V2YWx1YXRpbmcsCiAgICAgICAgcmVzdWx0LAogICAgICAgIGVzY2FwZURlbGltaXRlciA9IG9wdGlvbnMuZXNjYXBlLAogICAgICAgIGV2YWx1YXRlRGVsaW1pdGVyID0gb3B0aW9ucy5ldmFsdWF0ZSwKICAgICAgICBpbnRlcnBvbGF0ZURlbGltaXRlciA9IG9wdGlvbnMuaW50ZXJwb2xhdGUsCiAgICAgICAgc2V0dGluZ3MgPSBsb2Rhc2gudGVtcGxhdGVTZXR0aW5ncywKICAgICAgICB2YXJpYWJsZSA9IG9wdGlvbnMudmFyaWFibGU7CgogICAgLy8gdXNlIGRlZmF1bHQgc2V0dGluZ3MgaWYgbm8gb3B0aW9ucyBvYmplY3QgaXMgcHJvdmlkZWQKICAgIGlmIChlc2NhcGVEZWxpbWl0ZXIgPT0gbnVsbCkgewogICAgICBlc2NhcGVEZWxpbWl0ZXIgPSBzZXR0aW5ncy5lc2NhcGU7CiAgICB9CiAgICBpZiAoZXZhbHVhdGVEZWxpbWl0ZXIgPT0gbnVsbCkgewogICAgICBldmFsdWF0ZURlbGltaXRlciA9IHNldHRpbmdzLmV2YWx1YXRlOwogICAgfQogICAgaWYgKGludGVycG9sYXRlRGVsaW1pdGVyID09IG51bGwpIHsKICAgICAgaW50ZXJwb2xhdGVEZWxpbWl0ZXIgPSBzZXR0aW5ncy5pbnRlcnBvbGF0ZTsKICAgIH0KCiAgICAvLyB0b2tlbml6ZSBkZWxpbWl0ZXJzIHRvIGF2b2lkIGVzY2FwaW5nIHRoZW0KICAgIGlmIChlc2NhcGVEZWxpbWl0ZXIpIHsKICAgICAgdGV4dCA9IHRleHQucmVwbGFjZShlc2NhcGVEZWxpbWl0ZXIsIHRva2VuaXplRXNjYXBlKTsKICAgIH0KICAgIGlmIChpbnRlcnBvbGF0ZURlbGltaXRlcikgewogICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKGludGVycG9sYXRlRGVsaW1pdGVyLCB0b2tlbml6ZUludGVycG9sYXRlKTsKICAgIH0KICAgIGlmIChldmFsdWF0ZURlbGltaXRlciAhPSBsYXN0RXZhbHVhdGVEZWxpbWl0ZXIpIHsKICAgICAgLy8gZ2VuZXJhdGUgYHJlRXZhbHVhdGVEZWxpbWl0ZXJgIHRvIG1hdGNoIGBfLnRlbXBsYXRlU2V0dGluZ3MuZXZhbHVhdGVgCiAgICAgIC8vIGFuZCBpbnRlcm5hbCBgPGUlLSAlPmAsIGA8ZSU9ICU+YCBkZWxpbWl0ZXJzCiAgICAgIGxhc3RFdmFsdWF0ZURlbGltaXRlciA9IGV2YWx1YXRlRGVsaW1pdGVyOwogICAgICByZUV2YWx1YXRlRGVsaW1pdGVyID0gUmVnRXhwKAogICAgICAgIChldmFsdWF0ZURlbGltaXRlciA/IGV2YWx1YXRlRGVsaW1pdGVyLnNvdXJjZSA6ICcoJF4pJykgKwogICAgICAgICd8PGUlLShbXFxzXFxTXSs/KSU+fDxlJT0oW1xcc1xcU10rPyklPicKICAgICAgLCAnZycpOwogICAgfQogICAgaXNFdmFsdWF0aW5nID0gdG9rZW5pemVkLmxlbmd0aDsKICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UocmVFdmFsdWF0ZURlbGltaXRlciwgdG9rZW5pemVFdmFsdWF0ZSk7CiAgICBpc0V2YWx1YXRpbmcgPSBpc0V2YWx1YXRpbmcgIT0gdG9rZW5pemVkLmxlbmd0aDsKCiAgICAvLyBlc2NhcGUgY2hhcmFjdGVycyB0aGF0IGNhbm5vdCBiZSBpbmNsdWRlZCBpbiBzdHJpbmcgbGl0ZXJhbHMgYW5kCiAgICAvLyBkZXRva2VuaXplIGRlbGltaXRlciBjb2RlIHNuaXBwZXRzCiAgICB0ZXh0ID0gIl9fcCArPSAnIiArIHRleHQKICAgICAgLnJlcGxhY2UocmVVbmVzY2FwZWRTdHJpbmcsIGVzY2FwZVN0cmluZ0NoYXIpCiAgICAgIC5yZXBsYWNlKHJlVG9rZW4sIGRldG9rZW5pemUpICsgIic7XG4iOwoKICAgIC8vIGNsZWFyIHN0b3JlZCBjb2RlIHNuaXBwZXRzCiAgICB0b2tlbml6ZWQubGVuZ3RoID0gMDsKCiAgICAvLyBpZiBgb3B0aW9ucy52YXJpYWJsZWAgaXMgbm90IHNwZWNpZmllZCBhbmQgdGhlIHRlbXBsYXRlIGNvbnRhaW5zICJldmFsdWF0ZSIKICAgIC8vIGRlbGltaXRlcnMsIHdyYXAgYSB3aXRoLXN0YXRlbWVudCBhcm91bmQgdGhlIGdlbmVyYXRlZCBjb2RlIHRvIGFkZCB0aGUKICAgIC8vIGRhdGEgb2JqZWN0IHRvIHRoZSB0b3Agb2YgdGhlIHNjb3BlIGNoYWluCiAgICBpZiAoIXZhcmlhYmxlKSB7CiAgICAgIHZhcmlhYmxlID0gc2V0dGluZ3MudmFyaWFibGUgfHwgbGFzdFZhcmlhYmxlIHx8ICdvYmonOwoKICAgICAgaWYgKGlzRXZhbHVhdGluZykgewogICAgICAgIHRleHQgPSAnd2l0aCAoJyArIHZhcmlhYmxlICsgJykge1xuJyArIHRleHQgKyAnXG59XG4nOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIGlmICh2YXJpYWJsZSAhPSBsYXN0VmFyaWFibGUpIHsKICAgICAgICAgIC8vIGdlbmVyYXRlIGByZURvdWJsZVZhcmlhYmxlYCB0byBtYXRjaCByZWZlcmVuY2VzIGxpa2UgYG9iai5vYmpgIGluc2lkZQogICAgICAgICAgLy8gdHJhbnNmb3JtZWQgImVzY2FwZSIgYW5kICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVycwogICAgICAgICAgbGFzdFZhcmlhYmxlID0gdmFyaWFibGU7CiAgICAgICAgICByZURvdWJsZVZhcmlhYmxlID0gUmVnRXhwKCcoXFwoXFxzKiknICsgdmFyaWFibGUgKyAnXFwuJyArIHZhcmlhYmxlICsgJ1xcYicsICdnJyk7CiAgICAgICAgfQogICAgICAgIC8vIGF2b2lkIGEgd2l0aC1zdGF0ZW1lbnQgYnkgcHJlcGVuZGluZyBkYXRhIG9iamVjdCByZWZlcmVuY2VzIHRvIHByb3BlcnR5IG5hbWVzCiAgICAgICAgdGV4dCA9IHRleHQKICAgICAgICAgIC5yZXBsYWNlKHJlSW5zZXJ0VmFyaWFibGUsICckJicgKyB2YXJpYWJsZSArICcuJykKICAgICAgICAgIC5yZXBsYWNlKHJlRG91YmxlVmFyaWFibGUsICckMV9fZCcpOwogICAgICB9CiAgICB9CgogICAgLy8gY2xlYW51cCBjb2RlIGJ5IHN0cmlwcGluZyBlbXB0eSBzdHJpbmdzCiAgICB0ZXh0ID0gKCBpc0V2YWx1YXRpbmcgPyB0ZXh0LnJlcGxhY2UocmVFbXB0eVN0cmluZ0xlYWRpbmcsICcnKSA6IHRleHQpCiAgICAgIC5yZXBsYWNlKHJlRW1wdHlTdHJpbmdNaWRkbGUsICckMScpCiAgICAgIC5yZXBsYWNlKHJlRW1wdHlTdHJpbmdUcmFpbGluZywgJyQxOycpOwoKICAgIC8vIGZyYW1lIGNvZGUgYXMgdGhlIGZ1bmN0aW9uIGJvZHkKICAgIHRleHQgPSAnZnVuY3Rpb24oJyArIHZhcmlhYmxlICsgJykge1xuJyArCiAgICAgIHZhcmlhYmxlICsgJyB8fCAoJyArIHZhcmlhYmxlICsgJyA9IHt9KTtcbicgKwogICAgICAndmFyIF9fdCwgX19wID0gXCdcJywgX19lID0gXy5lc2NhcGUnICsKICAgICAgKGlzRXZhbHVhdGluZwogICAgICAgID8gJywgX19qID0gQXJyYXkucHJvdG90eXBlLmpvaW47XG4nICsKICAgICAgICAgICdmdW5jdGlvbiBwcmludCgpIHsgX19wICs9IF9fai5jYWxsKGFyZ3VtZW50cywgXCdcJykgfVxuJwogICAgICAgIDogJywgX19kID0gJyArIHZhcmlhYmxlICsgJy4nICsgdmFyaWFibGUgKyAnIHx8ICcgKyB2YXJpYWJsZSArICc7XG4nCiAgICAgICkgKwogICAgICB0ZXh0ICsKICAgICAgJ3JldHVybiBfX3Bcbn0nOwoKICAgIC8vIGFkZCBhIHNvdXJjZVVSTCBmb3IgZWFzaWVyIGRlYnVnZ2luZwogICAgLy8gaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAgaWYgKHVzZVNvdXJjZVVSTCkgewogICAgICB0ZXh0ICs9ICdcbi8vQCBzb3VyY2VVUkw9L2xvZGFzaC90ZW1wbGF0ZS9zb3VyY2VbJyArICh0ZW1wbGF0ZUNvdW50ZXIrKykgKyAnXSc7CiAgICB9CgogICAgdHJ5IHsKICAgICAgcmVzdWx0ID0gRnVuY3Rpb24oJ18nLCAncmV0dXJuICcgKyB0ZXh0KShsb2Rhc2gpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHJlc3VsdCA9IGZ1bmN0aW9uKCkgeyB0aHJvdyBlOyB9OwogICAgfQoKICAgIGlmIChkYXRhKSB7CiAgICAgIHJldHVybiByZXN1bHQoZGF0YSk7CiAgICB9CiAgICAvLyBwcm92aWRlIHRoZSBjb21waWxlZCBmdW5jdGlvbidzIHNvdXJjZSB2aWEgaXRzIGB0b1N0cmluZ2AgbWV0aG9kLCBpbgogICAgLy8gc3VwcG9ydGVkIGVudmlyb25tZW50cywgb3IgdGhlIGBzb3VyY2VgIHByb3BlcnR5IGFzIGEgY29udmVuaWVuY2UgZm9yCiAgICAvLyBidWlsZCB0aW1lIHByZWNvbXBpbGF0aW9uCiAgICByZXN1bHQuc291cmNlID0gdGV4dDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBFeGVjdXRlcyB0aGUgYGNhbGxiYWNrYCBmdW5jdGlvbiBgbmAgdGltZXMuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvCiAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggMSBhcmd1bWVudDsgKGluZGV4KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge051bWJlcn0gbiBUaGUgbnVtYmVyIG9mIHRpbWVzIHRvIGV4ZWN1dGUgdGhlIGNhbGxiYWNrLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2suCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8udGltZXMoMywgZnVuY3Rpb24oKSB7IGdlbmllLmdyYW50V2lzaCgpOyB9KTsKICAgKiAvLyA9PiBjYWxscyBgZ2VuaWUuZ3JhbnRXaXNoKClgIDMgdGltZXMKICAgKgogICAqIF8udGltZXMoMywgZnVuY3Rpb24oKSB7IHRoaXMuZ3JhbnRXaXNoKCk7IH0sIGdlbmllKTsKICAgKiAvLyA9PiBhbHNvIGNhbGxzIGBnZW5pZS5ncmFudFdpc2goKWAgMyB0aW1lcwogICAqLwogIGZ1bmN0aW9uIHRpbWVzKG4sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgaW5kZXggPSAtMTsKICAgIGlmICh0aGlzQXJnKSB7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbikgewogICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc0FyZywgaW5kZXgpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB3aGlsZSAoKytpbmRleCA8IG4pIHsKICAgICAgICBjYWxsYmFjayhpbmRleCk7CiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAqIEdlbmVyYXRlcyBhIHVuaXF1ZSBpZC4gSWYgYHByZWZpeGAgaXMgcGFzc2VkLCB0aGUgaWQgd2lsbCBiZSBhcHBlbmRlZCB0byBpdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gW3ByZWZpeF0gVGhlIHZhbHVlIHRvIHByZWZpeCB0aGUgaWQgd2l0aC4KICAgKiBAcmV0dXJucyB7TnVtYmVyfFN0cmluZ30gUmV0dXJucyBhIG51bWVyaWMgaWQgaWYgbm8gcHJlZml4IGlzIHBhc3NlZCwgZWxzZQogICAqICBhIHN0cmluZyBpZCBtYXkgYmUgcmV0dXJuZWQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8udW5pcXVlSWQoJ2NvbnRhY3RfJyk7CiAgICogLy8gPT4gJ2NvbnRhY3RfMTA0JwogICAqLwogIGZ1bmN0aW9uIHVuaXF1ZUlkKHByZWZpeCkgewogICAgdmFyIGlkID0gaWRDb3VudGVyKys7CiAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBXcmFwcyB0aGUgdmFsdWUgaW4gYSBgbG9kYXNoYCB3cmFwcGVyIG9iamVjdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIHdyYXBwZXIgb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICogICB7ICduYW1lJzogJ2xhcnJ5JywgJ2FnZSc6IDUwIH0sCiAgICogICB7ICduYW1lJzogJ2N1cmx5JywgJ2FnZSc6IDYwIH0KICAgKiBdOwogICAqCiAgICogdmFyIHlvdW5nZXN0ID0gXy5jaGFpbihzdG9vZ2VzKQogICAqICAgICAuc29ydEJ5KGZ1bmN0aW9uKHN0b29nZSkgeyByZXR1cm4gc3Rvb2dlLmFnZTsgfSkKICAgKiAgICAgLm1hcChmdW5jdGlvbihzdG9vZ2UpIHsgcmV0dXJuIHN0b29nZS5uYW1lICsgJyBpcyAnICsgc3Rvb2dlLmFnZTsgfSkKICAgKiAgICAgLmZpcnN0KCkKICAgKiAgICAgLnZhbHVlKCk7CiAgICogLy8gPT4gJ21vZSBpcyA0MCcKICAgKi8KICBmdW5jdGlvbiBjaGFpbih2YWx1ZSkgewogICAgdmFsdWUgPSBuZXcgTG9EYXNoKHZhbHVlKTsKICAgIHZhbHVlLl9jaGFpbiA9IHRydWU7CiAgICByZXR1cm4gdmFsdWU7CiAgfQoKICAvKioKICAgKiBJbnZva2VzIGBpbnRlcmNlcHRvcmAgd2l0aCB0aGUgYHZhbHVlYCBhcyB0aGUgZmlyc3QgYXJndW1lbnQsIGFuZCB0aGVuCiAgICogcmV0dXJucyBgdmFsdWVgLiBUaGUgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kIGNoYWluLAogICAqIGluIG9yZGVyIHRvIHBlcmZvcm0gb3BlcmF0aW9ucyBvbiBpbnRlcm1lZGlhdGUgcmVzdWx0cyB3aXRoaW4gdGhlIGNoYWluLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENoYWluaW5nCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYGNhbGxiYWNrYC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpbnRlcmNlcHRvciBUaGUgZnVuY3Rpb24gdG8gaW52b2tlLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyBgdmFsdWVgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmNoYWluKFsxLDIsMywyMDBdKQogICAqICAuZmlsdGVyKGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICUgMiA9PSAwOyB9KQogICAqICAudGFwKGFsZXJ0KQogICAqICAubWFwKGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICogbnVtIH0pCiAgICogIC52YWx1ZSgpOwogICAqIC8vID0+IC8vIFsyLCAyMDBdIChhbGVydGVkKQogICAqIC8vID0+IFs0LCA0MDAwMF0KICAgKi8KICBmdW5jdGlvbiB0YXAodmFsdWUsIGludGVyY2VwdG9yKSB7CiAgICBpbnRlcmNlcHRvcih2YWx1ZSk7CiAgICByZXR1cm4gdmFsdWU7CiAgfQoKICAvKioKICAgKiBFbmFibGVzIG1ldGhvZCBjaGFpbmluZyBvbiB0aGUgd3JhcHBlciBvYmplY3QuCiAgICoKICAgKiBAbmFtZSBjaGFpbgogICAqIEBkZXByZWNhdGVkCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIHdyYXBwZXIgb2JqZWN0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfKFsxLCAyLCAzXSkudmFsdWUoKTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKi8KICBmdW5jdGlvbiB3cmFwcGVyQ2hhaW4oKSB7CiAgICB0aGlzLl9jaGFpbiA9IHRydWU7CiAgICByZXR1cm4gdGhpczsKICB9CgogIC8qKgogICAqIEV4dHJhY3RzIHRoZSB3cmFwcGVkIHZhbHVlLgogICAqCiAgICogQG5hbWUgdmFsdWUKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgd3JhcHBlZCB2YWx1ZS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXyhbMSwgMiwgM10pLnZhbHVlKCk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICovCiAgZnVuY3Rpb24gd3JhcHBlclZhbHVlKCkgewogICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogVGhlIHNlbWFudGljIHZlcnNpb24gbnVtYmVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQHR5cGUgU3RyaW5nCiAgICovCiAgbG9kYXNoLlZFUlNJT04gPSAnMC40LjEnOwoKICAvLyBhc3NpZ24gc3RhdGljIG1ldGhvZHMKICBsb2Rhc2guYWZ0ZXIgPSBhZnRlcjsKICBsb2Rhc2guYmluZCA9IGJpbmQ7CiAgbG9kYXNoLmJpbmRBbGwgPSBiaW5kQWxsOwogIGxvZGFzaC5jaGFpbiA9IGNoYWluOwogIGxvZGFzaC5jbG9uZSA9IGNsb25lOwogIGxvZGFzaC5jb21wYWN0ID0gY29tcGFjdDsKICBsb2Rhc2guY29tcG9zZSA9IGNvbXBvc2U7CiAgbG9kYXNoLmNvbnRhaW5zID0gY29udGFpbnM7CiAgbG9kYXNoLmRlYm91bmNlID0gZGVib3VuY2U7CiAgbG9kYXNoLmRlZmF1bHRzID0gZGVmYXVsdHM7CiAgbG9kYXNoLmRlZmVyID0gZGVmZXI7CiAgbG9kYXNoLmRlbGF5ID0gZGVsYXk7CiAgbG9kYXNoLmRpZmZlcmVuY2UgPSBkaWZmZXJlbmNlOwogIGxvZGFzaC5lc2NhcGUgPSBlc2NhcGU7CiAgbG9kYXNoLmV2ZXJ5ID0gZXZlcnk7CiAgbG9kYXNoLmV4dGVuZCA9IGV4dGVuZDsKICBsb2Rhc2guZmlsdGVyID0gZmlsdGVyOwogIGxvZGFzaC5maW5kID0gZmluZDsKICBsb2Rhc2guZmlyc3QgPSBmaXJzdDsKICBsb2Rhc2guZmxhdHRlbiA9IGZsYXR0ZW47CiAgbG9kYXNoLmZvckVhY2ggPSBmb3JFYWNoOwogIGxvZGFzaC5mb3JJbiA9IGZvckluOwogIGxvZGFzaC5mb3JPd24gPSBmb3JPd247CiAgbG9kYXNoLmZ1bmN0aW9ucyA9IGZ1bmN0aW9uczsKICBsb2Rhc2guZ3JvdXBCeSA9IGdyb3VwQnk7CiAgbG9kYXNoLmhhcyA9IGhhczsKICBsb2Rhc2guaWRlbnRpdHkgPSBpZGVudGl0eTsKICBsb2Rhc2guaW5kZXhPZiA9IGluZGV4T2Y7CiAgbG9kYXNoLmluaXRpYWwgPSBpbml0aWFsOwogIGxvZGFzaC5pbnRlcnNlY3Rpb24gPSBpbnRlcnNlY3Rpb247CiAgbG9kYXNoLmludm9rZSA9IGludm9rZTsKICBsb2Rhc2guaXNBcmd1bWVudHMgPSBpc0FyZ3VtZW50czsKICBsb2Rhc2guaXNBcnJheSA9IGlzQXJyYXk7CiAgbG9kYXNoLmlzQm9vbGVhbiA9IGlzQm9vbGVhbjsKICBsb2Rhc2guaXNEYXRlID0gaXNEYXRlOwogIGxvZGFzaC5pc0VsZW1lbnQgPSBpc0VsZW1lbnQ7CiAgbG9kYXNoLmlzRW1wdHkgPSBpc0VtcHR5OwogIGxvZGFzaC5pc0VxdWFsID0gaXNFcXVhbDsKICBsb2Rhc2guaXNGaW5pdGUgPSBpc0Zpbml0ZTsKICBsb2Rhc2guaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CiAgbG9kYXNoLmlzTmFOID0gaXNOYU47CiAgbG9kYXNoLmlzTnVsbCA9IGlzTnVsbDsKICBsb2Rhc2guaXNOdW1iZXIgPSBpc051bWJlcjsKICBsb2Rhc2guaXNPYmplY3QgPSBpc09iamVjdDsKICBsb2Rhc2guaXNSZWdFeHAgPSBpc1JlZ0V4cDsKICBsb2Rhc2guaXNTdHJpbmcgPSBpc1N0cmluZzsKICBsb2Rhc2guaXNVbmRlZmluZWQgPSBpc1VuZGVmaW5lZDsKICBsb2Rhc2gua2V5cyA9IGtleXM7CiAgbG9kYXNoLmxhc3QgPSBsYXN0OwogIGxvZGFzaC5sYXN0SW5kZXhPZiA9IGxhc3RJbmRleE9mOwogIGxvZGFzaC5tYXAgPSBtYXA7CiAgbG9kYXNoLm1heCA9IG1heDsKICBsb2Rhc2gubWVtb2l6ZSA9IG1lbW9pemU7CiAgbG9kYXNoLm1pbiA9IG1pbjsKICBsb2Rhc2gubWl4aW4gPSBtaXhpbjsKICBsb2Rhc2gubm9Db25mbGljdCA9IG5vQ29uZmxpY3Q7CiAgbG9kYXNoLm9uY2UgPSBvbmNlOwogIGxvZGFzaC5wYXJ0aWFsID0gcGFydGlhbDsKICBsb2Rhc2gucGljayA9IHBpY2s7CiAgbG9kYXNoLnBsdWNrID0gcGx1Y2s7CiAgbG9kYXNoLnJhbmdlID0gcmFuZ2U7CiAgbG9kYXNoLnJlZHVjZSA9IHJlZHVjZTsKICBsb2Rhc2gucmVkdWNlUmlnaHQgPSByZWR1Y2VSaWdodDsKICBsb2Rhc2gucmVqZWN0ID0gcmVqZWN0OwogIGxvZGFzaC5yZXN0ID0gcmVzdDsKICBsb2Rhc2gucmVzdWx0ID0gcmVzdWx0OwogIGxvZGFzaC5zaHVmZmxlID0gc2h1ZmZsZTsKICBsb2Rhc2guc2l6ZSA9IHNpemU7CiAgbG9kYXNoLnNvbWUgPSBzb21lOwogIGxvZGFzaC5zb3J0QnkgPSBzb3J0Qnk7CiAgbG9kYXNoLnNvcnRlZEluZGV4ID0gc29ydGVkSW5kZXg7CiAgbG9kYXNoLnRhcCA9IHRhcDsKICBsb2Rhc2gudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICBsb2Rhc2gudGhyb3R0bGUgPSB0aHJvdHRsZTsKICBsb2Rhc2gudGltZXMgPSB0aW1lczsKICBsb2Rhc2gudG9BcnJheSA9IHRvQXJyYXk7CiAgbG9kYXNoLnVuaW9uID0gdW5pb247CiAgbG9kYXNoLnVuaXEgPSB1bmlxOwogIGxvZGFzaC51bmlxdWVJZCA9IHVuaXF1ZUlkOwogIGxvZGFzaC52YWx1ZXMgPSB2YWx1ZXM7CiAgbG9kYXNoLndpdGhvdXQgPSB3aXRob3V0OwogIGxvZGFzaC53cmFwID0gd3JhcDsKICBsb2Rhc2guemlwID0gemlwOwogIGxvZGFzaC56aXBPYmplY3QgPSB6aXBPYmplY3Q7CgogIC8vIGFzc2lnbiBhbGlhc2VzCiAgbG9kYXNoLmFsbCA9IGV2ZXJ5OwogIGxvZGFzaC5hbnkgPSBzb21lOwogIGxvZGFzaC5jb2xsZWN0ID0gbWFwOwogIGxvZGFzaC5kZXRlY3QgPSBmaW5kOwogIGxvZGFzaC5lYWNoID0gZm9yRWFjaDsKICBsb2Rhc2guZm9sZGwgPSByZWR1Y2U7CiAgbG9kYXNoLmZvbGRyID0gcmVkdWNlUmlnaHQ7CiAgbG9kYXNoLmhlYWQgPSBmaXJzdDsKICBsb2Rhc2guaW5jbHVkZSA9IGNvbnRhaW5zOwogIGxvZGFzaC5pbmplY3QgPSByZWR1Y2U7CiAgbG9kYXNoLm1ldGhvZHMgPSBmdW5jdGlvbnM7CiAgbG9kYXNoLnNlbGVjdCA9IGZpbHRlcjsKICBsb2Rhc2gudGFpbCA9IHJlc3Q7CiAgbG9kYXNoLnRha2UgPSBmaXJzdDsKICBsb2Rhc2gudW5pcXVlID0gdW5pcTsKCiAgLy8gYWRkIHBzZXVkbyBwcml2YXRlIHByb3BlcnRpZXMgdXNlZCBhbmQgcmVtb3ZlZCBkdXJpbmcgdGhlIGJ1aWxkIHByb2Nlc3MKICBsb2Rhc2guX2l0ZXJhdG9yVGVtcGxhdGUgPSBpdGVyYXRvclRlbXBsYXRlOwogIGxvZGFzaC5fc2hpbUtleXMgPSBzaGltS2V5czsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8vIGFzc2lnbiBwcml2YXRlIGBMb0Rhc2hgIGNvbnN0cnVjdG9yJ3MgcHJvdG90eXBlCiAgTG9EYXNoLnByb3RvdHlwZSA9IGxvZGFzaC5wcm90b3R5cGU7CgogIC8vIGFkZCBhbGwgc3RhdGljIGZ1bmN0aW9ucyB0byBgTG9EYXNoLnByb3RvdHlwZWAKICBtaXhpbihsb2Rhc2gpOwoKICAvLyBhZGQgYExvRGFzaC5wcm90b3R5cGUuY2hhaW5gIGFmdGVyIGNhbGxpbmcgYG1peGluKClgIHRvIGF2b2lkIG92ZXJ3cml0aW5nCiAgLy8gaXQgd2l0aCB0aGUgd3JhcHBlZCBgbG9kYXNoLmNoYWluYAogIExvRGFzaC5wcm90b3R5cGUuY2hhaW4gPSB3cmFwcGVyQ2hhaW47CiAgTG9EYXNoLnByb3RvdHlwZS52YWx1ZSA9IHdyYXBwZXJWYWx1ZTsKCiAgLy8gYWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBmb3JFYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgIHZhciBmdW5jID0gQXJyYXlQcm90b1ttZXRob2ROYW1lXTsKCiAgICBMb0Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX3dyYXBwZWQ7CiAgICAgIGZ1bmMuYXBwbHkodmFsdWUsIGFyZ3VtZW50cyk7CgogICAgICAvLyBJRSBjb21wYXRpYmlsaXR5IG1vZGUgYW5kIElFIDwgOSBoYXZlIGJ1Z2d5IEFycmF5IGBzaGlmdCgpYCBhbmQgYHNwbGljZSgpYAogICAgICAvLyBmdW5jdGlvbnMgdGhhdCBmYWlsIHRvIHJlbW92ZSB0aGUgbGFzdCBlbGVtZW50LCBgdmFsdWVbMF1gLCBvZgogICAgICAvLyBhcnJheS1saWtlIG9iamVjdHMgZXZlbiB0aG91Z2ggdGhlIGBsZW5ndGhgIHByb3BlcnR5IGlzIHNldCB0byBgMGAuCiAgICAgIC8vIFRoZSBgc2hpZnQoKWAgbWV0aG9kIGlzIGJ1Z2d5IGluIElFIDggY29tcGF0aWJpbGl0eSBtb2RlLCB3aGlsZSBgc3BsaWNlKClgCiAgICAgIC8vIGlzIGJ1Z2d5IHJlZ2FyZGxlc3Mgb2YgbW9kZSBpbiBJRSA8IDkgYW5kIGJ1Z2d5IGluIGNvbXBhdGliaWxpdHkgbW9kZSBpbiBJRSA5LgogICAgICBpZiAodmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgZGVsZXRlIHZhbHVlWzBdOwogICAgICB9CiAgICAgIGlmICh0aGlzLl9jaGFpbikgewogICAgICAgIHZhbHVlID0gbmV3IExvRGFzaCh2YWx1ZSk7CiAgICAgICAgdmFsdWUuX2NoYWluID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogIH0pOwoKICAvLyBhZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBmb3JFYWNoKFsnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgdmFyIGZ1bmMgPSBBcnJheVByb3RvW21ldGhvZE5hbWVdOwoKICAgIExvRGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5fd3JhcHBlZCwKICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodmFsdWUsIGFyZ3VtZW50cyk7CgogICAgICBpZiAodGhpcy5fY2hhaW4pIHsKICAgICAgICByZXN1bHQgPSBuZXcgTG9EYXNoKHJlc3VsdCk7CiAgICAgICAgcmVzdWx0Ll9jaGFpbiA9IHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBleHBvc2UgTG8tRGFzaAogIC8vIHNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMsIGxpa2Ugci5qcywgY2hlY2sgZm9yIHNwZWNpZmljIGNvbmRpdGlvbiBwYXR0ZXJucyBsaWtlIHRoZSBmb2xsb3dpbmc6CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PSAnb2JqZWN0JyAmJiBkZWZpbmUuYW1kKSB7CiAgICAvLyBFeHBvc2UgTG8tRGFzaCB0byB0aGUgZ2xvYmFsIG9iamVjdCBldmVuIHdoZW4gYW4gQU1EIGxvYWRlciBpcyBwcmVzZW50IGluCiAgICAvLyBjYXNlIExvLURhc2ggd2FzIGluamVjdGVkIGJ5IGEgdGhpcmQtcGFydHkgc2NyaXB0IGFuZCBub3QgaW50ZW5kZWQgdG8gYmUKICAgIC8vIGxvYWRlZCBhcyBhIG1vZHVsZS4gVGhlIGdsb2JhbCBhc3NpZ25tZW50IGNhbiBiZSByZXZlcnRlZCBpbiB0aGUgTG8tRGFzaAogICAgLy8gbW9kdWxlIHZpYSBpdHMgYG5vQ29uZmxpY3QoKWAgbWV0aG9kLgogICAgd2luZG93Ll8gPSBsb2Rhc2g7CgogICAgLy8gZGVmaW5lIGFzIGFuIGFub255bW91cyBtb2R1bGUgc28sIHRocm91Z2ggcGF0aCBtYXBwaW5nLCBpdCBjYW4gYmUKICAgIC8vIHJlZmVyZW5jZWQgYXMgdGhlICJ1bmRlcnNjb3JlIiBtb2R1bGUKICAgIGRlZmluZSgnbG9kYXNoJyxbXSxmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGxvZGFzaDsKICAgIH0pOwogIH0KICAvLyBjaGVjayBmb3IgYGV4cG9ydHNgIGFmdGVyIGBkZWZpbmVgIGluIGNhc2UgYSBidWlsZCBvcHRpbWl6ZXIgYWRkcyBhbiBgZXhwb3J0c2Agb2JqZWN0CiAgZWxzZSBpZiAoZnJlZUV4cG9ydHMpIHsKICAgIC8vIGluIE5vZGUuanMgb3IgUmluZ29KUyB2MC44LjArCiAgICBpZiAodHlwZW9mIG1vZHVsZSA9PSAnb2JqZWN0JyAmJiBtb2R1bGUgJiYgbW9kdWxlLmV4cG9ydHMgPT0gZnJlZUV4cG9ydHMpIHsKICAgICAgKG1vZHVsZS5leHBvcnRzID0gbG9kYXNoKS5fID0gbG9kYXNoOwogICAgfQogICAgLy8gaW4gTmFyd2hhbCBvciBSaW5nb0pTIHYwLjcuMC0KICAgIGVsc2UgewogICAgICBmcmVlRXhwb3J0cy5fID0gbG9kYXNoOwogICAgfQogIH0KICBlbHNlIHsKICAgIC8vIGluIGEgYnJvd3NlciBvciBSaGlubwogICAgd2luZG93Ll8gPSBsb2Rhc2g7CiAgfQp9KHRoaXMpKTsKCi8qISBUaHJ1c3QgSlMgRnJhbWV3b3JrIC0gdjAuMS4wIC0gMjAxMi0wOC0yOQoqIHRocnVzdC1ob21lCiogQ29weXJpZ2h0IChjKSAyMDEyIERhdmlkIERyaXNjb2xsOyBMaWNlbnNlZCBNSVQgKi8KCgpkZWZpbmUoJ3RocnVzdC91dGlsL2FycmF5JyxbJ2xvZGFzaCddLCBmdW5jdGlvbiAoXykKewogICAgCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LXV0aWwtYXJyYXkKICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZmlyc3RdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmaXJzdCkKCiAgICBAZm9yIHRocnVzdC11dGlsLWFycmF5CiAgICBAbWV0aG9kIGZpcnN0CiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2ZpcnN0XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZmlyc3QpCgogICAgQG1ldGhvZCBoZWFkCiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2luaXRpYWxdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpbml0aWFsKQoKICAgIEBtZXRob2QgaW5pdGlhbAogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNsYXN0XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jbGFzdCkKCiAgICBAbWV0aG9kIGxhc3QKICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVzdF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3Jlc3QpCgogICAgQG1ldGhvZCB0YWlsCiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3Jlc3RdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyZXN0KQoKICAgIEBtZXRob2QgcmVzdAogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNjb21wYWN0XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jY29tcGFjdCkKCiAgICBAbWV0aG9kIGNvbXBhY3QKICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZmxhdHRlbl0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2ZsYXR0ZW4pCgogICAgQG1ldGhvZCBmbGF0dGVuCiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3dpdGhvdXRdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN3aXRob3V0KQoKICAgIEBtZXRob2Qgd2l0aG91dAogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN1bmlvbl0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3VuaW9uKQoKICAgIEBtZXRob2QgdW5pb24KICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaW50ZXJzZWN0aW9uXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaW50ZXJzZWN0aW9uKQoKICAgIEBtZXRob2QgaW50ZXJzZWN0aW9uCiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2RpZmZlcmVuY2VdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNkaWZmZXJlbmNlKQoKICAgIEBtZXRob2QgZGlmZmVyZW5jZQogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN1bmlxXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdW5pcSkKCiAgICBAbWV0aG9kIHVuaXEKICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdW5pcV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3VuaXEpCgogICAgQG1ldGhvZCB1bmlxdWUKICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jemlwXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jemlwKQoKICAgIEBtZXRob2QgemlwCiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2luZGV4T2ZdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpbmRleE9mKQoKICAgIEBtZXRob2QgaW5kZXhPZgogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNsYXN0SW5kZXhPZl0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2xhc3RJbmRleE9mKQoKICAgIEBtZXRob2QgbGFzdEluZGV4T2YKICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmFuZ2VdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyYW5nZSkKCiAgICBAbWV0aG9kIHJhbmdlCiAgICAqKi8KCiAgICB2YXIgZXhwb3J0cyA9IF8ucGljayhfLCAnZmlyc3QnLCAnaGVhZCcsICdpbml0aWFsJywgJ2xhc3QnLCAndGFpbCcsICdyZXN0JywgJ2NvbXBhY3QnLCAnZmxhdHRlbicsICd3aXRob3V0JywgJ3VuaW9uJywgJ2ludGVyc2VjdGlvbicsICdkaWZmZXJlbmNlJywgJ3VuaXEnLCAndW5pcXVlJywgJ3ppcCcsICdpbmRleE9mJywgJ2xhc3RJbmRleE9mJywgJ3JhbmdlJyk7CiAgICByZXR1cm4gZXhwb3J0czsKfSk7Ci8vLyA8cmVmZXJlbmNlIHBhdGg9ImNvbGxlY3Rpb24uanMiIC8+CmRlZmluZSgndGhydXN0L3V0aWwvY29sbGVjdGlvbicsWydsb2Rhc2gnXSwgZnVuY3Rpb24gKF8pCnsKICAgIAogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC11dGlsLWNvbGxlY3Rpb24KICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2VhY2hdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNlYWNoKQoKICAgIEBmb3IgdGhydXN0LXV0aWwtY29sbGVjdGlvbgogICAgQG1ldGhvZCBlYWNoCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNlYWNoXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZWFjaCkKCiAgICBAbWV0aG9kIGZvckVhY2gKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI21hcF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI21hcCkKCiAgICBAbWV0aG9kIG1hcAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jbWFwXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jbWFwKQoKICAgIEBtZXRob2QgY29sbGVjdAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVkdWNlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVkdWNlKQoKICAgIEBtZXRob2QgcmVkdWNlCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyZWR1Y2VdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyZWR1Y2UpCgogICAgQG1ldGhvZCBpbmplY3QKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3JlZHVjZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3JlZHVjZSkKCiAgICBAbWV0aG9kIGZvbGRsCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyZWR1Y2VSaWdodF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3JlZHVjZVJpZ2h0KQoKICAgIEBtZXRob2QgZm9sZHIKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3JlZHVjZVJpZ2h0XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVkdWNlUmlnaHQpCgogICAgQG1ldGhvZCByZWR1Y2VSaWdodAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZmluZF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2ZpbmQpCgogICAgQG1ldGhvZCBmaW5kCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmaW5kXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZmluZCkKCiAgICBAbWV0aG9kIGRldGVjdAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZmlsdGVyXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZmlsdGVyKQoKICAgIEBtZXRob2QgZmlsdGVyCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmaWx0ZXJdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmaWx0ZXIpCgogICAgQG1ldGhvZCBzZWxlY3QKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3JlamVjdF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3JlamVjdCkKCiAgICBAbWV0aG9kIHJlamVjdAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jYWxsXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jYWxsKQoKICAgIEBtZXRob2QgYWxsCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNhbGxdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNhbGwpCgogICAgQG1ldGhvZCBldmVyeQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jYW55XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jYW55KQoKICAgIEBtZXRob2QgYW55CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNhbnldKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNhbnkpCgogICAgQG1ldGhvZCBzb21lCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpbmNsdWRlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaW5jbHVkZSkKCiAgICBAbWV0aG9kIGluY2x1ZGUKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2luY2x1ZGVdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpbmNsdWRlKQoKICAgIEBtZXRob2QgY29udGFpbnMKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2ludm9rZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2ludm9rZSkKCiAgICBAbWV0aG9kIGludm9rZQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcGx1Y2tdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNwbHVjaykKCiAgICBAbWV0aG9kIHBsdWNrCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNtYXhdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNtYXgpCgogICAgQG1ldGhvZCBtYXgKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI21pbl0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI21pbikKCiAgICBAbWV0aG9kIG1pbgogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jc29ydEJ5XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jc29ydEJ5KQoKICAgIEBtZXRob2Qgc29ydEJ5CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNncm91cEJ5XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZ3JvdXBCeSkKCiAgICBAbWV0aG9kIGdyb3VwQnkKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3NvcnRlZEluZGV4XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jc29ydGVkSW5kZXgpCgogICAgQG1ldGhvZCBzb3J0ZWRJbmRleAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jc2h1ZmZsZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3NodWZmbGUpCgogICAgQG1ldGhvZCBzaHVmZmxlCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN0b0FycmF5XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdG9BcnJheSkKCiAgICBAbWV0aG9kIHRvQXJyYXkKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3NpemVdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNzaXplKQoKICAgIEBtZXRob2Qgc2l6ZQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZXh0ZW5kXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZXh0ZW5kKQoKICAgIEBtZXRob2QgZXh0ZW5kCiAgICAqKi8KCiAgICB2YXIgZXhwb3J0cyA9IF8ucGljayhfLCAnZWFjaCcsICdmb3JFYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdpbmplY3QnLCAnZm9sZGwnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsICdyZWplY3QnLCAnYWxsJywgJ2V2ZXJ5JywgJ2FueScsICdzb21lJywgJ2luY2x1ZGUnLAogICAgICAgICdjb250YWlucycsICdpbnZva2UnLCAncGx1Y2snLCAnbWF4JywgJ21pbicsICdzb3J0QnknLCAnZ3JvdXBCeScsICdzb3J0ZWRJbmRleCcsICdzaHVmZmxlJywgJ3RvQXJyYXknLCAnc2l6ZScsICdleHRlbmQnKTsKICAgIHJldHVybiBleHBvcnRzOwp9KTsKZGVmaW5lKCd0aHJ1c3QvdXRpbC9mdW5jdGlvbicsWydsb2Rhc2gnXSwgZnVuY3Rpb24gKF8pCnsKICAgIAogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC11dGlsLWZ1bmMKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2JpbmRdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNiaW5kKQoKICAgIEBmb3IgdGhydXN0LXV0aWwtZnVuYwogICAgQG1ldGhvZCBiaW5kCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNiaW5kQWxsXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jYmluZEFsbCkKCiAgICBAbWV0aG9kIGJpbmRBbGwKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI21lbW9pemVdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNtZW1vaXplKQoKICAgIEBtZXRob2QgbWVtb2l6ZQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZGVsYXldKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNkZWxheSkKCiAgICBAbWV0aG9kIGRlbGF5CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNkZWZlcl0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2RlZmVyKQoKICAgIEBtZXRob2QgZGVmZXIKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3Rocm90dGxlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdGhyb3R0bGUpCgogICAgQG1ldGhvZCB0aHJvdHRsZQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZGVib3VuY2VdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNkZWJvdW5jZSkKCiAgICBAbWV0aG9kIGRlYm91bmNlCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNvbmNlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jb25jZSkKCiAgICBAbWV0aG9kIG9uY2UKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2FmdGVyXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jYWZ0ZXIpCgogICAgQG1ldGhvZCBhZnRlcgogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jd3JhcF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3dyYXApCgogICAgQG1ldGhvZCB3cmFwCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNjb21wb3NlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jY29tcG9zZSkKCiAgICBAbWV0aG9kIGNvbXBvc2UKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3VuaXF1ZUlkXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdW5pcXVlSWQpCgogICAgQG1ldGhvZCB1bmlxdWVJZAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZXNjYXBlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZXNjYXBlKQoKICAgIEBtZXRob2QgZXNjYXBlCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyZXN1bHRdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyZXN1bHQpCgogICAgQG1ldGhvZCByZXN1bHQKICAgICoqLwoKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBleHBvcnRzID0gXy5waWNrKF8sICdiaW5kJywgJ2JpbmRBbGwnLCAnbWVtb2l6ZScsICdkZWxheScsICdkZWZlcicsICd0aHJvdHRsZScsICdkZWJvdW5jZScsICdvbmNlJywgJ2FmdGVyJywgJ3dyYXAnLCAnY29tcG9zZScsICd1bmlxdWVJZCcsICdlc2NhcGUnLCAncmVzdWx0Jyk7CgogICAgLyoqCiAgICBBIGZ1bmN0aW9uIHRoYXQgZG9lcyBub3RoaW5nLCBvciBubyBvcGVyYXRpb24uICBIZW5jZSB0aGUgbmFtZSBub29wLgoKICAgIEBtZXRob2Qgbm9vcAogICAgKiovCiAgICB2YXIgbm9vcCA9IGV4cG9ydHMubm9vcCA9IGZ1bmN0aW9uICgpIHsgfTsKCiAgICAvKioKICAgIEF0dGVtcHRzIHRvIGludm9rZSwgc2ltaWxhciB0byBfLmludm9rZSwgYnV0IGluIHRoaXMgY2FzZSBpdCB2ZXJpZmllcyB0aGF0IHRoZSBwcm9wZXJ0eSBleGlzdCwKICAgICAgICBhbmQgYWxzbyB2ZXJpZmllcyB0aGF0IGl0IGlzIGEgZnVuY3Rpb24sIGFuZCBub3QgdGhlIG5vb3AgbWV0aG9kIGF2YWlsYWJsZSBpbiB0aHJ1c3QuCgogICAgICAgIFRoZSBpbnRlbnQgaXMgYSBtZXRob2QgdGhhdCBhbGxvd3Mgb3ZlcnJpZGUgb2YgZnVuY3Rpb25zLCB3aXRob3V0IGNyZWF0aW5nIGN1c3RvbSBjb2RlLgoKICAgIEBtZXRob2Qgc2F2ZUludm9rZQogICAgQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbGxlY3Rpb24gVGhlIGNvbnRhaW5lciB0aGF0IGhhcyB0aGUgaXRlbXMKICAgIEBwYXJhbSB7U3RyaW5nfEZ1bmN0aW9ufSBtZXRob2QgVGhlIG1ldGhvZCBuYW1lIG9uIGV2ZXJ5IGl0ZW0sIG9yIHRoZSBtZXRob2QgdG8gaW52b2tlIGFnYWluc3QgZWFjaCBpdGVtLgogICAgQHBhcmFtIHtPYmplY3R9IFthcmdzXSogVGhlIGFkZGl0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgbWV0aG9kLgogICAgKiovCiAgICBleHBvcnRzLnNhZmVJbnZva2UgPSBmdW5jdGlvbiAoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkKICAgIHsKICAgICAgICB2YXIgaW5kZXgsIGl0ZXJhdGVlID0gY29sbGVjdGlvbiwgcmVzdWx0OwogICAgICAgIGlmICghY29sbGVjdGlvbikgcmV0dXJuIFtdOwogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLAogICAgICAgICAgICBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLAogICAgICAgICAgICBtZXRob2RFeGlzdHM7CiAgICAgICAgdmFyIGxlbmd0aCA9IGl0ZXJhdGVlLmxlbmd0aDsgaW5kZXggPSAtMTsKICAgICAgICBpZiAobGVuZ3RoID09PSBsZW5ndGggPj4+IDApCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwogICAgICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzID0gKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pOwogICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzICYmIG1ldGhvZEV4aXN0cyAhPT0gbm9vcCAmJiAocmVzdWx0W2luZGV4XSA9IG1ldGhvZEV4aXN0cy5hcHBseShpdGVyYXRlZVtpbmRleF0sIGFyZ3MpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2tpcFByb3RvID0gdHlwZW9mIGl0ZXJhdGVlID09ICdmdW5jdGlvbicgJiYKICAgICAgICAgICAgICBwcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGl0ZXJhdGVlLCAncHJvdG90eXBlJyk7CgogICAgICAgICAgICB2YXIgcHJvcHMgPSBfLmtleXMoaXRlcmF0ZWUpLAogICAgICAgICAgICAgICAgcHJvcEluZGV4ID0gLTEsCiAgICAgICAgICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CgogICAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwogICAgICAgICAgICB3aGlsZSAoKytwcm9wSW5kZXggPCBsZW5ndGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gcHJvcHNbcHJvcEluZGV4XTsKICAgICAgICAgICAgICAgIGlmICghKHNraXBQcm90byAmJiBpbmRleCA9PSAncHJvdG90eXBlJykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzID0gKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyAmJiBtZXRob2RFeGlzdHMgIT09IG5vb3AgJiYgKHJlc3VsdFtwcm9wSW5kZXhdID0gKChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKS5hcHBseShpdGVyYXRlZVtpbmRleF0sIGFyZ3MpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwoKICAgIC8qKgoJICogQ29uc3RydWN0b3IgdXNlZCB0byBiZWdldCBvYmplY3RzIHRoYXQgd2lyZSBuZWVkcyB0byBjcmVhdGUgdXNpbmcgbmV3LgoJICogQHBhcmFtIGN0b3Ige0Z1bmN0aW9ufSByZWFsIGNvbnN0cnVjdG9yIHRvIGJlIGludm9rZWQKCSAqIEBwYXJhbSBhcmdzIHtBcnJheX0gYXJndW1lbnRzIHRvIGJlIHN1cHBsaWVkIHRvIGN0b3IKCSAqLwogICAgZnVuY3Rpb24gQmVnZXR0ZXIoY3RvciwgYXJncykKICAgIHsKICAgICAgICByZXR1cm4gY3Rvci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KCiAgICAvKioKCSAqIENyZWF0ZXMgYW4gb2JqZWN0IGJ5IGVpdGhlciBpbnZva2luZyBjdG9yIGFzIGEgZnVuY3Rpb24gYW5kIHJldHVybmluZyB0aGUgcmVzdWx0LAoJICogb3IgYnkgY2FsbGluZyBuZXcgY3RvcigpLiAgSXQgdXNlcyBhIHNpbXBsZSBoZXVyaXN0aWMgdG8gdHJ5IHRvIGd1ZXNzIHdoaWNoIGFwcHJvYWNoCgkgKiBpcyB0aGUgInJpZ2h0IiBvbmUuCgkgKgoJICogQHBhcmFtIGN0b3Ige0Z1bmN0aW9ufSBmdW5jdGlvbiBvciBjb25zdHJ1Y3RvciB0byBpbnZva2UKCSAqIEBwYXJhbSBhcmdzIHtBcnJheX0gYXJyYXkgb2YgYXJndW1lbnRzIHRvIHBhc3MgdG8gY3RvciBpbiBlaXRoZXIgY2FzZQoJICoKCSAqIEByZXR1cm5zIFRoZSByZXN1bHQgb2YgaW52b2tpbmcgY3RvciB3aXRoIGFyZ3MsIHdpdGggb3Igd2l0aG91dCBuZXcsIGRlcGVuZGluZyBvbgoJICogdGhlIHN0cmF0ZWd5IHNlbGVjdGVkLgoJICovCiAgICBleHBvcnRzLmluc3RhbnRpYXRlID0gZnVuY3Rpb24gKGN0b3IsIGFyZ3MpCiAgICB7CiAgICAgICAgQmVnZXR0ZXIucHJvdG90eXBlID0gY3Rvci5wcm90b3R5cGU7CiAgICAgICAgQmVnZXR0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY3RvcjsKICAgICAgICB2YXIgYmVnb3R0ZW4gPSBuZXcgQmVnZXR0ZXIoY3RvciwgYXJncyk7CiAgICAgICAgQmVnZXR0ZXIucHJvdG90eXBlID0gdm9pZCAwOwogICAgICAgIHJldHVybiBiZWdvdHRlbjsKICAgIH07CgogICAgcmV0dXJuIGV4cG9ydHM7Cn0pOwpkZWZpbmUoJ3RocnVzdC91dGlsL29iamVjdCcsWydsb2Rhc2gnXSwgZnVuY3Rpb24gKF8pCnsKICAgIAogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC11dGlsLW9iagogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8ja2V5c10oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2tleXMpCgogICAgQGZvciB0aHJ1c3QtdXRpbC1vYmoKICAgIEBtZXRob2Qga2V5cwogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdmFsdWVzXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdmFsdWVzKQoKICAgIEBtZXRob2QgdmFsdWVzCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmdW5jdGlvbnNdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmdW5jdGlvbnMpCgogICAgQG1ldGhvZCBmdW5jdGlvbnMKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2Z1bmN0aW9uc10oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2Z1bmN0aW9ucykKCiAgICBAbWV0aG9kIG1ldGhvZHMKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3BpY2tdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNwaWNrKQoKICAgIEBtZXRob2QgcGljawogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZGVmYXVsdHNdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNkZWZhdWx0cykKCiAgICBAbWV0aG9kIGRlZmF1bHRzCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNjbG9uZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2Nsb25lKQoKICAgIEBtZXRob2QgY2xvbmUKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3RhcF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3RhcCkKCiAgICBAbWV0aG9kIHRhcAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaGFzXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaGFzKQoKICAgIEBtZXRob2QgaGFzCiAgICAqKi8KCiAgICB2YXIgZXhwb3J0cyA9IF8ucGljayhfLCAna2V5cycsICdtZXRob2RzJywgJ2Z1bmN0aW9ucycsICdtZXRob2RzJywgJ3BpY2snLCAnZGVmYXVsdHMnLCAnY2xvbmUnLCAndGFwJywgJ2hhcycpOwoKICAgIC8qKgogICAgSW52ZXJ0cyBhbiBvYmplY3QuICBUaGUga2V5cyBiZWNvbWUgdmFsdWVzLCBhbmQgdGhlIHZhbHVlcyBiZWNvbWUga2V5cy4KICAgIERvZXMgbm90IGRvIGFueSBjb3B5aW5nLgoKICAgIEBtZXRob2QgaW52ZXJ0CiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gaW52ZXJ0LgogICAgQHJldHVybnMge09iamVjdH0gVGhlIGludmVydGVkIG9iamVjdC4KICAgICoqLwoKICAgIHZhciBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgZXhwb3J0cy5pbnZlcnQgPSBmdW5jdGlvbiAob2JqKQogICAgewogICAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgICBmb3IgKHZhciBpIGluIG9iaikKICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG9iaiwgaSkpCiAgICAgICAgICAgICAgICByZXN1bHRbb2JqW2ldXSA9IGk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgICAKICAgIHJldHVybiBleHBvcnRzOwp9KTsKLyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IGxpYiB2MS43LjIKICogaHR0cDovL2pxdWVyeS5jb20vCiAqCiAqIENvcHlyaWdodCAyMDExLCBKb2huIFJlc2lnCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIEluY2x1ZGVzIFNpenpsZS5qcwogKiBodHRwOi8vc2l6emxlanMuY29tLwogKiBDb3B5cmlnaHQgMjAxMSwgVGhlIERvam8gRm91bmRhdGlvbgogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlULCBCU0QsIGFuZCBHUEwgTGljZW5zZXMuCiAqCiAqIERhdGU6IFdlZCBNYXIgMjEgMTI6NDY6MzQgMjAxMiAtMDcwMAogKi8KZGVmaW5lKCd0aHJ1c3QvdXRpbC9saWIvdHlwZScsWyd0aHJ1c3QvdXRpbC9jb2xsZWN0aW9uJ10sCmZ1bmN0aW9uICh1Q29sbGVjdGlvbikKewogICAgCiAgICB2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAogICAgICAgIGNsYXNzMnR5cGUgPSB7fTsKICAgIAogICAgdmFyIHR5cGUgPSBmdW5jdGlvbiAob2JqKQogICAgewogICAgICAgIHJldHVybiBvYmogPT0gbnVsbCA/CiAgICAgICAgICAgIFN0cmluZyhvYmopIDoKICAgICAgICAgICAgY2xhc3MydHlwZVt0b1N0cmluZy5jYWxsKG9iaildIHx8ICJvYmplY3QiOwogICAgfTsKCiAgICB1Q29sbGVjdGlvbi5lYWNoKCJCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0Ii5zcGxpdCgiICIpLCBmdW5jdGlvbiAobmFtZSwgaSkKICAgIHsKICAgICAgICBjbGFzczJ0eXBlWyJbb2JqZWN0ICIgKyBuYW1lICsgIl0iXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgIH0pOwoKICAgIHJldHVybiB7IHR5cGU6IHR5cGUgfTsKfSk7CmRlZmluZSgndGhydXN0L3V0aWwvdHlwZScsWydsb2Rhc2gnLCAnLi9saWIvdHlwZSddLApmdW5jdGlvbiAoXywgdHlwZSkKewogICAgCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LXV0aWwtdHlwZQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNFcXVhbF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzRXF1YWwpCgogICAgQGZvciB0aHJ1c3QtdXRpbC10eXBlCiAgICBAbWV0aG9kIGlzRXF1YWwKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzRW1wdHldKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0VtcHR5KQoKICAgIEBtZXRob2QgaXNFbXB0eQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNFbGVtZW50XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNFbGVtZW50KQoKICAgIEBtZXRob2QgaXNFbGVtZW50CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0FycmF5XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNBcnJheSkKCiAgICBAbWV0aG9kIGlzQXJyYXkKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzT2JqZWN0XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNPYmplY3QpCgogICAgQG1ldGhvZCBpc09iamVjdAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNBcmd1bWVudHNdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0FyZ3VtZW50cykKCiAgICBAbWV0aG9kIGlzQXJndW1lbnRzCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0Z1bmN0aW9uXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNGdW5jdGlvbikKCiAgICBAbWV0aG9kIGlzRnVuY3Rpb24KICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzU3RyaW5nXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNTdHJpbmcpCgogICAgQG1ldGhvZCBpc1N0cmluZwogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNOdW1iZXJdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc051bWJlcikKCiAgICBAbWV0aG9kIGlzTnVtYmVyCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0Zpbml0ZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzRmluaXRlKQoKICAgIEBtZXRob2QgaXNGaW5pdGUKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzQm9vbGVhbl0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzQm9vbGVhbikKCiAgICBAbWV0aG9kIGlzQm9vbGVhbgogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNEYXRlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNEYXRlKQoKICAgIEBtZXRob2QgaXNEYXRlCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc1JlZ0V4cF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzUmVnRXhwKQoKICAgIEBtZXRob2QgaXNSZWdFeHAKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzTmFOXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNOYU4pCgogICAgQG1ldGhvZCBpc05hTgogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNOdWxsXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNOdWxsKQoKICAgIEBtZXRob2QgaXNOdWxsCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc1VuZGVmaW5lZF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzVW5kZWZpbmVkKQoKICAgIEBtZXRob2QgaXNVbmRlZmluZWQKICAgICoqLwoKICAgIHZhciBleHBvcnRzID0gXy5waWNrKF8sICdpc0VxdWFsJywgJ2lzRW1wdHknLCAnaXNFbGVtZW50JywgJ2lzQXJyYXknLCAnaXNPYmplY3QnLCAnaXNBcmd1bWVudHMnLCAnaXNGdW5jdGlvbicsICdpc1N0cmluZycsICdpc051bWJlcicsICdpc0Zpbml0ZScsICdpc0Jvb2xlYW4nLCAnaXNEYXRlJywgJ2lzUmVnRXhwJywgJ2lzTmFOJywgJ2lzTnVsbCcsICdpc1VuZGVmaW5lZCcpOwoKICAgIF8uZXh0ZW5kKGV4cG9ydHMsIHsKICAgICAgICAvKioKICAgICAgICBSZXR1cm5zIHRoZSB0eXBlIG9mIHRoZSBnaXZlbiBPYmplY3QKCiAgICAgICAgTk9URTogY3VycmVudGx5IHRoaXMgdHlwZSBoYXMgYmVlbiBsb2FkZWQgZnJvbSBqUXVlcnkgc291cmNlIGNvZGUuCgogICAgICAgIEBtZXRob2QgdHlwZQogICAgICAgICoqLwogICAgICAgIHR5cGU6IHR5cGUudHlwZSwKICAgICAgICAvKioKICAgICAgICBDaGVja3MgaXMgdGhlIG9iamVjdCBpcyBhcnJheSBsaWtlLCBsaWtlIHRoZSBhcnVndW1lbnRzIG9iamVjdCwgYnV0IG5vdCBhIHN0cmluZywgb2UgYXJyYXkuCiAgICAgICAgalF1ZXJ5IG9iamVjdHMgZm9yIGV4YW1wbGUgd291bGQgcmVwb3J0IGFzIGFycmF5IGxpa2UuCiAgICAgICAgQXMgd2VsbCBhcyBrbm9ja291dCBvYnNlcnZhYmxlIGFycmF5cyByZXBvcnQgYXMgYXJyYXkgbGlrZS4KCiAgICAgICAgQG1ldGhvZCBpc0FycmF5TGlrZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvYmplY3QgdG8gY2hlY2sKICAgICAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSXMgaXQgdHJ1ZSBvciBmYWxzZS4KICAgICAgICAqKi8KICAgICAgICBpc0FycmF5TGlrZTogZnVuY3Rpb24gKG8pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gKG8gJiYgIWV4cG9ydHMuaXNTdHJpbmcobykgJiYgby5sZW5ndGggIT09IHVuZGVmaW5lZCkgfHwgZmFsc2U7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhcnJheSBvciBhcnJheSBsaWtlLgoKICAgICAgICBAbWV0aG9kIGlzQXJyYXlPckFycmF5TGlrZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvYmplY3QgdG8gY2hlY2sKICAgICAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSXMgaXQgdHJ1ZSBvciBmYWxzZS4KICAgICAgICAqKi8KICAgICAgICBpc0FycmF5T3JBcnJheUxpa2U6IGZ1bmN0aW9uIChvKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGV4cG9ydHMuaXNBcnJheShvKSB8fCAoZXhwb3J0cy5pc0FycmF5TGlrZShvKSk7CiAgICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIGV4cG9ydHM7Cn0pOwoKZGVmaW5lKCd0aHJ1c3QvdXRpbC9ndWlkJyxbJy4vdHlwZSddLApmdW5jdGlvbiAodHlwZSkKewogICAgCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LXV0aWwKICAgICoqLwoKICAgIHZhciBTNCA9IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgcmV0dXJuICgoKDEgKyBNYXRoLnJhbmRvbSgpKSAqIDB4MTAwMDApIHwgMCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygxKTsKICAgIH0sCiAgICBndWlkUmVnZXggPSAvXihce3swLDF9KFswLTlhLWZBLUZdKXs4fS0oWzAtOWEtZkEtRl0pezR9LShbMC05YS1mQS1GXSl7NH0tKFswLTlhLWZBLUZdKXs0fS0oWzAtOWEtZkEtRl0pezEyfVx9ezAsMX0pJC8sCiAgICBlbXRwdHlHdWlkID0gJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCc7CgogICAgdmFyIGV4cG9ydHMgPSB7CiAgICAgICAgLyoqCiAgICAgICAgUmV0dXJucyBhIG5ldyBzdWRvIGd1aWQsIGxpbWlhdGlvbnMgaW4gSmF2YVNjcmlwdCBtYWtlIG11c3QgbW9yZSByZWxpYWJsZSBndWlkcyBmYWlybHkgZGlmZmljdWx0IHRvIGNyZWF0ZS4KCiAgICAgICAgQGZvciB0aHJ1c3QtdXRpbAogICAgICAgIEBtZXRob2QgbmV3R3VpZAogICAgICAgIEByZXR1cm5zIHtHdWlkfSBUaGUgbmV3IGd1aWQuCiAgICAgICAgKiovCiAgICAgICAgbmV3R3VpZDogZnVuY3Rpb24gKCkgeyByZXR1cm4gKFM0KCkgKyBTNCgpICsgIi0iICsgUzQoKSArICItIiArIFM0KCkgKyAiLSIgKyBTNCgpICsgIi0iICsgUzQoKSArIFM0KCkgKyBTNCgpKTsgfSwKICAgICAgICAvKioKICAgICAgICBSZXR1cm5zIGFuIGVtcHR5IGd1aWQuCgogICAgICAgIEBtZXRob2QgZW1wdHlHdWlkCiAgICAgICAgQHJldHVybnMge0d1aWR9IFRoZSBlbXRwdHkgZ3VpZC4KICAgICAgICAqKi8KICAgICAgICBlbXB0eUd1aWQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGVtdHB0eUd1aWQ7IH0sCiAgICAgICAgLyoqCiAgICAgICAgQ2hlY2tzIGlmIHRoZSBnaXZlbiBzdHJpbmcgaXMgYSBndWlkLgoKICAgICAgICBAbWV0aG9kIGlzR3VpZAogICAgICAgIEBwYXJhbSB7R3VpZH0gZ3VpZAogICAgICAgIEByZXR1cm5zIHtCb29sZWFufSBJZiB0aGUgZ3VpZCBpcyBhIGd1aWQgb3Igbm90LgogICAgICAgICoqLwogICAgICAgIGlzR3VpZDogZnVuY3Rpb24gKGd1aWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHlwZS5pc1N0cmluZyhndWlkKSA/IGd1aWRSZWdleC50ZXN0KGd1aWQpIDogZmFsc2U7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIEd1aWQgaXMgYW4gRW1wdHkgR3VpZAoKICAgICAgICBAbWV0aG9kIGlzR3VpZEVtcHR5CiAgICAgICAgQHBhcmFtIHtHdWlkfSBndWlkCiAgICAgICAgQHJldHVybnMge0Jvb2xlYW59IElmIHRoZSBndWlkIGlzIGEgZ3VpZCBvciBub3QuCiAgICAgICAgKiovCiAgICAgICAgaXNHdWlkRW1wdHk6IGZ1bmN0aW9uIChndWlkKSB7IHJldHVybiBndWlkID09PSBlbXRwdHlHdWlkOyB9CiAgICB9OwogICAgcmV0dXJuIGV4cG9ydHM7Cn0pOwovKiEKICogalF1ZXJ5IEphdmFTY3JpcHQgbGliIHYxLjcuMgogKiBodHRwOi8vanF1ZXJ5LmNvbS8KICoKICogQ29weXJpZ2h0IDIwMTEsIEpvaG4gUmVzaWcKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogSW5jbHVkZXMgU2l6emxlLmpzCiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqIENvcHlyaWdodCAyMDExLCBUaGUgRG9qbyBGb3VuZGF0aW9uCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQsIEJTRCwgYW5kIEdQTCBMaWNlbnNlcy4KICoKICogRGF0ZTogV2VkIE1hciAyMSAxMjo0NjozNCAyMDEyIC0wNzAwCiAqLwpkZWZpbmUoJ3RocnVzdC91dGlsL2xpYi9wYXJhbScsWyd0aHJ1c3QvdXRpbC9jb2xsZWN0aW9uJywgJ3RocnVzdC91dGlsL3R5cGUnLCAnbW9kdWxlJ10sCmZ1bmN0aW9uICh1Q29sbGVjdGlvbiwgdVR5cGUsIG1vZHVsZSkKewogICAgCiAgICB2YXIgcjIwID0gLyUyMC9nLAogICAgICAgIHJicmFja2V0ID0gL1xbXF0kLzsKICAgIHZhciBwYXJhbSA9IGZ1bmN0aW9uIChhLCB0cmFkaXRpb25hbCkKICAgIHsKICAgICAgICB2YXIgcHJlZml4LAogICAgICAgICAgICBzICAgPSBbXSwKICAgICAgICAgICAgYWRkID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgcmV0dXJuIGl0cyB2YWx1ZQogICAgICAgICAgICAgICAgdmFsdWUgPSB1VHlwZS5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlKCkgOiAodmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUpOwogICAgICAgICAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgICAgIH07CgogICAgICAgIC8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuCiAgICAgICAgaWYgKHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQpCiAgICAgICAgewogICAgICAgICAgICB0cmFkaXRpb25hbCA9ICEhbW9kdWxlLmNvbmZpZygpLnRyYWRpdGlvbmFsRW5jb2Rpbmc7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgICAgIGlmICh1VHlwZS5pc0FycmF5T3JBcnJheUxpa2UoYSkpCiAgICAgICAgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgICAgICAgICAgdUNvbGxlY3Rpb24uZWFjaChhLCBmdW5jdGlvbiAoeCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYWRkKHgubmFtZSwgeC52YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKICAgICAgICAgICAgLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCiAgICAgICAgICAgIGZvciAocHJlZml4IGluIGEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCwgYVtwcmVmaXhdLCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgogICAgICAgIHJldHVybiBzLmpvaW4oIiYiKS5yZXBsYWNlKHIyMCwgIisiKTsKICAgIH07CgogICAgZnVuY3Rpb24gYnVpbGRQYXJhbXMocHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQpCiAgICB7CiAgICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KG9iaikpCiAgICAgICAgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KICAgICAgICAgICAgalF1ZXJ5LmVhY2gob2JqLCBmdW5jdGlvbiAoaSwgdikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRyYWRpdGlvbmFsIHx8IHJicmFja2V0LnRlc3QocHJlZml4KSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCiAgICAgICAgICAgICAgICAgICAgYWRkKHByZWZpeCwgdik7CgogICAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCiAgICAgICAgICAgICAgICAgICAgLy8gbnVtZXJpYyBpbmRleCB0byByZXNvbHZlIGRlc2VyaWFsaXphdGlvbiBhbWJpZ3VpdHkgaXNzdWVzLgogICAgICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCByYWNrIChhcyBvZiAxLjAuMCkgY2FuJ3QgY3VycmVudGx5IGRlc2VyaWFsaXplCiAgICAgICAgICAgICAgICAgICAgLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCiAgICAgICAgICAgICAgICAgICAgLy8gYSBzZXJ2ZXIgZXJyb3IuIFBvc3NpYmxlIGZpeGVzIGFyZSB0byBtb2RpZnkgcmFjaydzCiAgICAgICAgICAgICAgICAgICAgLy8gZGVzZXJpYWxpemF0aW9uIGFsZ29yaXRobSBvciB0byBwcm92aWRlIGFuIG9wdGlvbiBvciBmbGFnCiAgICAgICAgICAgICAgICAgICAgLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgogICAgICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArICh0eXBlb2YgdiA9PT0gIm9iamVjdCIgfHwgalF1ZXJ5LmlzQXJyYXkodikgPyBpIDogIiIpICsgIl0iLCB2LCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgIH0KICAgICAgICBlbHNlIGlmICghdHJhZGl0aW9uYWwgJiYgb2JqICE9IG51bGwgJiYgdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIpCiAgICAgICAgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gb2JqKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXggKyAiWyIgKyBuYW1lICsgIl0iLCBvYmpbbmFtZV0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICB9CgogICAgICAgIH0gZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgogICAgICAgICAgICBhZGQocHJlZml4LCBvYmopOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB7IHBhcmFtOiBwYXJhbSB9Owp9KTsKZGVmaW5lKCd0aHJ1c3QvdXRpbC91cmwnLFsnLi9saWIvcGFyYW0nLCAnbW9kdWxlJ10sCmZ1bmN0aW9uIChwYXJhbSwgbW9kdWxlKQp7CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LXV0aWwtdXJsCiAgICAqKi8KICAgIAogICAgdmFyIHVybFBhdGggICAgICAgICAgPSAobW9kdWxlLmNvbmZpZyAmJiBtb2R1bGUuY29uZmlnKCkucGF0aCB8fCAnJyksCiAgICAgICAgcGF0aCAgICAgICAgICAgICA9IHVybFBhdGgubGFzdEluZGV4T2YoJy8nKSA9PT0gdXJsUGF0aC5sZW5ndGggLSAxID8gdXJsUGF0aC5zdWJzdHJpbmcoMCwgLTEpIDogdXJsUGF0aCwKICAgICAgICBkb3VibGVTbGFzaFJlZ2V4ID0gL1wvXC8vZzsKCiAgICB2YXIgZXhwb3J0cyA9IHsKICAgICAgICAvKioKICAgICAgICBqUXVlcnkgcGFyYW0gbWV0aG9kIHRvIGVuY29kZSBmb3JtIHBhcmFtZXRlcnMuCgogICAgICAgIEBmb3IgdGhydXN0LXV0aWwtdXJsCiAgICAgICAgQG1ldGhvZCBwYXJhbQogICAgICAgICoqLwogICAgICAgIHBhcmFtOiBwYXJhbSwKICAgICAgICAvKioKICAgICAgICBDbGVhbnMgdXAgZG91YmxlIHNsYXNocyBpbiBhIHVybCwgdXNlZCBieSB0aHJ1c3QvZGF0YQoKICAgICAgICBAbWV0aG9kIGNsZWFuVXJsCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGNsZWFuCiAgICAgICAgQHJldHJ1c24ge1N0cmluZ30gVGhlIGNsZWFuZWQgdXJsCiAgICAgICAgKiovCiAgICAgICAgY2xlYW5Vcmw6IGZ1bmN0aW9uICh1cmwpIHsgcmV0dXJuIHVybC5yZXBsYWNlKGRvdWJsZVNsYXNoUmVnZXgsICcvJyk7IH0sCiAgICAgICAgLyoqCiAgICAgICAgQ2hlY2tzIGZvciBleGlzdGFuY2Ugb2YgYXBwbGljYXRpb24gcGF0aCBpbiB0aGUgdXJsLCBvciBodHRwIGlmIHRoZSB1cmwgaXMgc3VwcG9zZWQgdG8gZ28gdG8gYW5vdGhlciBsb2NhdGlvbi4KCiAgICAgICAgQG1ldGhvZCBmaXh1cFVybAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBmaXh1cAogICAgICAgIEByZXRydXNuIHtTdHJpbmd9IFRoZSBmaXhlZCB1cmwKICAgICAgICAqKi8KICAgICAgICBmaXh1cFVybDogZnVuY3Rpb24gKHVybCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh1cmwuaW5kZXhPZignaHR0cCcpID09PSAtMSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHVybC5pbmRleE9mKHVybFBhdGgpID09PSAtMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB1cmwgPSB1cmxQYXRoICsgdXJsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdXJsID0gZXhwb3J0cy5jbGVhblVybChwYXRoICsgdXJsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXJsOwogICAgICAgIH0KICAgIH07CiAgICByZXR1cm4gZXhwb3J0czsKfSk7CmRlZmluZSgndGhydXN0L3V0aWwvc3RyaW5nJyxbXSxmdW5jdGlvbiAoKQp7CiAgICB2YXIgb2JqZWN0Q3VybHlSZWdleCA9IC9ce1x7fFx9XH18XHsoLio/KVx9L2csCiAgICAgICAgbnVtYmVyQ3VybHlSZWdleCA9IC9ce1x7fFx9XH18XHsoXGQrKVx9L2csCiAgICAgICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKICAgICAgICBmb3JtYXQgICAgICAgICAgID0gZnVuY3Rpb24gKHN0cikKICAgICAgICB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdvYmplY3QnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgYSA9IGFyZ3NbMF07CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2Uob2JqZWN0Q3VybHlSZWdleCwgZnVuY3Rpb24gKG0sIG4pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG0gPT0gJ3t7JykgeyByZXR1cm4gJ3snOyB9CiAgICAgICAgICAgICAgICAgICAgaWYgKG0gPT0gJ319JykgeyByZXR1cm4gJ30nOyB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgJiYgYVtuXSB8fCAnJzsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdHIucmVwbGFjZShudW1iZXJDdXJseVJlZ2V4LCBmdW5jdGlvbiAobSwgbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG0gPT0gJ3t7JykgeyByZXR1cm4gJ3snOyB9CiAgICAgICAgICAgICAgICBpZiAobSA9PSAnfX0nKSB7IHJldHVybiAnfSc7IH0KICAgICAgICAgICAgICAgIHJldHVybiBhcmdzW25dIHx8ICcnOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgIFN0cmluZy5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gZm9ybWF0LmFwcGx5KG51bGwsIFt0aGlzXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7IH07CgogICAgcmV0dXJuIHsKICAgICAgICAvKioKICAgICAgICBDIyBzdHlsZSBzdHJpbmcgZm9ybWF0LgoKICAgICAgICBAZm9yIHRocnVzdC11dGlsCiAgICAgICAgQG1ldGhvZCBmb3JtYXQKICAgICAgICAqKi8KICAgICAgICBmb3JtYXQ6IGZvcm1hdCwKICAgICAgICBnZXRNb2R1bGVOYW1lRm9yUGF0aDogZnVuY3Rpb24gKG5hbWUpIHsgcmV0dXJuIChuYW1lLmxhc3RJbmRleE9mKCcvJykgPiAtMSA/IG5hbWUuc3Vic3RyaW5nKG5hbWUubGFzdEluZGV4T2YoJy8nKSArIDEpIDogbmFtZSkucmVwbGFjZSgvXC4vZywgJy0nKTsgfQogICAgfTsKfSk7Ci8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiB3aGVuCiAqIEEgbGlnaHR3ZWlnaHQgQ29tbW9uSlMgUHJvbWlzZXMvQSBhbmQgd2hlbigpIGltcGxlbWVudGF0aW9uCiAqCiAqIHdoZW4gaXMgcGFydCBvZiB0aGUgY3Vqby5qcyBmYW1pbHkgb2YgbGlicmFyaWVzIChodHRwOi8vY3Vqb2pzLmNvbS8pCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZSBhdDoKICogaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICoKICogQHZlcnNpb24gMS4zLjAKICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi93aGVuJyxbXSxmdW5jdGlvbigpIHsKICAgIHZhciBmcmVlemUsIHJlZHVjZUFycmF5LCBzbGljZSwgdW5kZWY7CgogICAgLy8KICAgIC8vIFB1YmxpYyBBUEkKICAgIC8vCgogICAgd2hlbi5kZWZlciAgICAgPSBkZWZlcjsKICAgIHdoZW4ucmVqZWN0ICAgID0gcmVqZWN0OwogICAgd2hlbi5pc1Byb21pc2UgPSBpc1Byb21pc2U7CgogICAgd2hlbi5hbGwgICAgICAgPSBhbGw7CiAgICB3aGVuLnNvbWUgICAgICA9IHNvbWU7CiAgICB3aGVuLmFueSAgICAgICA9IGFueTsKCiAgICB3aGVuLm1hcCAgICAgICA9IG1hcDsKICAgIHdoZW4ucmVkdWNlICAgID0gcmVkdWNlOwoKICAgIHdoZW4uY2hhaW4gICAgID0gY2hhaW47CgogICAgLyoqIE9iamVjdC5mcmVlemUgKi8KICAgIGZyZWV6ZSA9IE9iamVjdC5mcmVlemUgfHwgZnVuY3Rpb24obykgeyByZXR1cm4gbzsgfTsKCiAgICAvKioKICAgICAqIFRydXN0ZWQgUHJvbWlzZSBjb25zdHJ1Y3Rvci4gIEEgUHJvbWlzZSBjcmVhdGVkIGZyb20gdGhpcyBjb25zdHJ1Y3RvciBpcwogICAgICogYSB0cnVzdGVkIHdoZW4uanMgcHJvbWlzZS4gIEFueSBvdGhlciBkdWNrLXR5cGVkIHByb21pc2UgaXMgY29uc2lkZXJlZAogICAgICogdW50cnVzdGVkLgogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICovCiAgICBmdW5jdGlvbiBQcm9taXNlKCkge30KCiAgICBQcm9taXNlLnByb3RvdHlwZSA9IGZyZWV6ZSh7CiAgICAgICAgYWx3YXlzOiBmdW5jdGlvbihhbHdheXNiYWNrLCBwcm9nYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKGFsd2F5c2JhY2ssIGFsd2F5c2JhY2ssIHByb2diYWNrKTsKICAgICAgICB9LAoKICAgICAgICBvdGhlcndpc2U6IGZ1bmN0aW9uKGVycmJhY2spIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudGhlbih1bmRlZiwgZXJyYmFjayk7CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYW4gYWxyZWFkeS1yZXNvbHZlZCBwcm9taXNlIGZvciB0aGUgc3VwcGxpZWQgdmFsdWUKICAgICAqIEBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIGFueXRoaW5nCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgICBmdW5jdGlvbiByZXNvbHZlZCh2YWx1ZSkgewoKICAgICAgICB2YXIgcCA9IG5ldyBQcm9taXNlKCk7CgogICAgICAgIHAudGhlbiA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZShjYWxsYmFjayA/IGNhbGxiYWNrKHZhbHVlKSA6IHZhbHVlKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0ZWQoZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gZnJlZXplKHApOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlIGFuIGFscmVhZHktcmVqZWN0ZWQge0BsaW5rIFByb21pc2V9IHdpdGggdGhlIHN1cHBsaWVkCiAgICAgKiByZWplY3Rpb24gcmVhc29uLgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gcmVhc29uIHJlamVjdGlvbiByZWFzb24KICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlamVjdGVkKHJlYXNvbikgewoKICAgICAgICB2YXIgcCA9IG5ldyBQcm9taXNlKCk7CgogICAgICAgIHAudGhlbiA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBlcnJiYWNrKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXJyYmFjayA/IHByb21pc2UoZXJyYmFjayhyZWFzb24pKSA6IHJlamVjdGVkKHJlYXNvbik7CiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdGVkKGUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGZyZWV6ZShwKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSByZWplY3RlZCBwcm9taXNlIGZvciB0aGUgc3VwcGxpZWQgcHJvbWlzZU9yVmFsdWUuIElmCiAgICAgKiBwcm9taXNlT3JWYWx1ZSBpcyBhIHZhbHVlLCBpdCB3aWxsIGJlIHRoZSByZWplY3Rpb24gdmFsdWUgb2YgdGhlCiAgICAgKiByZXR1cm5lZCBwcm9taXNlLiAgSWYgcHJvbWlzZU9yVmFsdWUgaXMgYSBwcm9taXNlLCBpdHMKICAgICAqIGNvbXBsZXRpb24gdmFsdWUgd2lsbCBiZSB0aGUgcmVqZWN0ZWQgdmFsdWUgb2YgdGhlIHJldHVybmVkIHByb21pc2UKICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZU9yVmFsdWUgeyp9IHRoZSByZWplY3RlZCB2YWx1ZSBvZiB0aGUgcmV0dXJuZWQge0BsaW5rIFByb21pc2V9CiAgICAgKgogICAgICogQHJldHVybiB7UHJvbWlzZX0gcmVqZWN0ZWQge0BsaW5rIFByb21pc2V9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlamVjdChwcm9taXNlT3JWYWx1ZSkgewogICAgICAgIHJldHVybiB3aGVuKHByb21pc2VPclZhbHVlLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gcmVqZWN0ZWQodmFsdWUpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldywgQ29tbW9uSlMgY29tcGxpYW50LCBEZWZlcnJlZCB3aXRoIGZ1bGx5IGlzb2xhdGVkCiAgICAgKiByZXNvbHZlciBhbmQgcHJvbWlzZSBwYXJ0cywgZWl0aGVyIG9yIGJvdGggb2Ygd2hpY2ggbWF5IGJlIGdpdmVuIG91dAogICAgICogc2FmZWx5IHRvIGNvbnN1bWVycy4KICAgICAqIFRoZSBEZWZlcnJlZCBpdHNlbGYgaGFzIHRoZSBmdWxsIEFQSTogcmVzb2x2ZSwgcmVqZWN0LCBwcm9ncmVzcywgYW5kCiAgICAgKiB0aGVuLiBUaGUgcmVzb2x2ZXIgaGFzIHJlc29sdmUsIHJlamVjdCwgYW5kIHByb2dyZXNzLiAgVGhlIHByb21pc2UKICAgICAqIG9ubHkgaGFzIHRoZW4uCiAgICAgKgogICAgICogQG1lbWJlck9mIHdoZW4KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEByZXR1cm5zIHtEZWZlcnJlZH0KICAgICAqLwogICAgZnVuY3Rpb24gZGVmZXIoKSB7CiAgICAgICAgdmFyIGRlZmVycmVkLCBwcm9taXNlLCBsaXN0ZW5lcnMsIHByb2dyZXNzSGFuZGxlcnMsIF90aGVuLCBfcHJvZ3Jlc3MsIGNvbXBsZXRlOwoKICAgICAgICBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICBwcm9ncmVzc0hhbmRsZXJzID0gW107CgogICAgICAgIC8qKgogICAgICAgICAqIFByZS1yZXNvbHV0aW9uIHRoZW4oKSB0aGF0IGFkZHMgdGhlIHN1cHBsaWVkIGNhbGxiYWNrLCBlcnJiYWNrLCBhbmQgcHJvZ2JhY2sKICAgICAgICAgKiBmdW5jdGlvbnMgdG8gdGhlIHJlZ2lzdGVyZWQgbGlzdGVuZXJzCiAgICAgICAgICoKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIFtjYWxsYmFja10ge0Z1bmN0aW9ufSByZXNvbHV0aW9uIGhhbmRsZXIKICAgICAgICAgKiBAcGFyYW0gW2VycmJhY2tdIHtGdW5jdGlvbn0gcmVqZWN0aW9uIGhhbmRsZXIKICAgICAgICAgKiBAcGFyYW0gW3Byb2diYWNrXSB7RnVuY3Rpb259IHByb2dyZXNzIGhhbmRsZXIKICAgICAgICAgKgogICAgICAgICAqIEB0aHJvd3Mge0Vycm9yfSBpZiBhbnkgYXJndW1lbnQgaXMgbm90IG51bGwsIHVuZGVmaW5lZCwgb3IgYSBGdW5jdGlvbgogICAgICAgICAqLwogICAgICAgIF90aGVuID0gZnVuY3Rpb24gdW5yZXNvbHZlZFRoZW4oY2FsbGJhY2ssIGVycmJhY2ssIHByb2diYWNrKSB7CiAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9IGRlZmVyKCk7CgogICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oY2FsbGJhY2ssIGVycmJhY2spCiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZGVmZXJyZWQucmVzb2x2ZSwgZGVmZXJyZWQucmVqZWN0LCBkZWZlcnJlZC5wcm9ncmVzcyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcHJvZ2JhY2sgJiYgcHJvZ3Jlc3NIYW5kbGVycy5wdXNoKHByb2diYWNrKTsKCiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVycyBhIGhhbmRsZXIgZm9yIHRoaXMge0BsaW5rIERlZmVycmVkfSdzIHtAbGluayBQcm9taXNlfS4gIEV2ZW4gdGhvdWdoIGFsbCBhcmd1bWVudHMKICAgICAgICAgKiBhcmUgb3B0aW9uYWwsIGVhY2ggYXJndW1lbnQgdGhhdCAqaXMqIHN1cHBsaWVkIG11c3QgYmUgbnVsbCwgdW5kZWZpbmVkLCBvciBhIEZ1bmN0aW9uLgogICAgICAgICAqIEFueSBvdGhlciB2YWx1ZSB3aWxsIGNhdXNlIGFuIEVycm9yIHRvIGJlIHRocm93bi4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJPZiBQcm9taXNlCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gW2NhbGxiYWNrXSB7RnVuY3Rpb259IHJlc29sdXRpb24gaGFuZGxlcgogICAgICAgICAqIEBwYXJhbSBbZXJyYmFja10ge0Z1bmN0aW9ufSByZWplY3Rpb24gaGFuZGxlcgogICAgICAgICAqIEBwYXJhbSBbcHJvZ2JhY2tdIHtGdW5jdGlvbn0gcHJvZ3Jlc3MgaGFuZGxlcgogICAgICAgICAqCiAgICAgICAgICogQHRocm93cyB7RXJyb3J9IGlmIGFueSBhcmd1bWVudCBpcyBub3QgbnVsbCwgdW5kZWZpbmVkLCBvciBhIEZ1bmN0aW9uCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gdGhlbihjYWxsYmFjaywgZXJyYmFjaywgcHJvZ2JhY2spIHsKICAgICAgICAgICAgcmV0dXJuIF90aGVuKGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9nYmFjayk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBSZXNvbHZlcyB0aGlzIHtAbGluayBEZWZlcnJlZH0ncyB7QGxpbmsgUHJvbWlzZX0gd2l0aCB2YWwgYXMgdGhlCiAgICAgICAgICogcmVzb2x1dGlvbiB2YWx1ZS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJPZiBSZXNvbHZlcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHZhbCBhbnl0aGluZwogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHJlc29sdmUodmFsKSB7CiAgICAgICAgICAgIGNvbXBsZXRlKHJlc29sdmVkKHZhbCkpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogUmVqZWN0cyB0aGlzIHtAbGluayBEZWZlcnJlZH0ncyB7QGxpbmsgUHJvbWlzZX0gd2l0aCBlcnIgYXMgdGhlCiAgICAgICAgICogcmVhc29uLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIFJlc29sdmVyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZXJyIGFueXRoaW5nCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcmVqZWN0KGVycikgewogICAgICAgICAgICBjb21wbGV0ZShyZWplY3RlZChlcnIpKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHBhcmFtIHVwZGF0ZQogICAgICAgICAqLwogICAgICAgIF9wcm9ncmVzcyA9IGZ1bmN0aW9uKHVwZGF0ZSkgewogICAgICAgICAgICB2YXIgcHJvZ3Jlc3MsIGkgPSAwOwogICAgICAgICAgICB3aGlsZSAocHJvZ3Jlc3MgPSBwcm9ncmVzc0hhbmRsZXJzW2krK10pIHByb2dyZXNzKHVwZGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogRW1pdHMgYSBwcm9ncmVzcyB1cGRhdGUgdG8gYWxsIHByb2dyZXNzIG9ic2VydmVycyByZWdpc3RlcmVkIHdpdGgKICAgICAgICAgKiB0aGlzIHtAbGluayBEZWZlcnJlZH0ncyB7QGxpbmsgUHJvbWlzZX0KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJPZiBSZXNvbHZlcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHVwZGF0ZSBhbnl0aGluZwogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHByb2dyZXNzKHVwZGF0ZSkgewogICAgICAgICAgICBfcHJvZ3Jlc3ModXBkYXRlKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFRyYW5zaXRpb24gZnJvbSBwcmUtcmVzb2x1dGlvbiBzdGF0ZSB0byBwb3N0LXJlc29sdXRpb24gc3RhdGUsIG5vdGlmeWluZwogICAgICAgICAqIGFsbCBsaXN0ZW5lcnMgb2YgdGhlIHJlc29sdXRpb24gb3IgcmVqZWN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGNvbXBsZXRlZCB7UHJvbWlzZX0gdGhlIGNvbXBsZXRlZCB2YWx1ZSBvZiB0aGlzIGRlZmVycmVkCiAgICAgICAgICovCiAgICAgICAgY29tcGxldGUgPSBmdW5jdGlvbihjb21wbGV0ZWQpIHsKICAgICAgICAgICAgdmFyIGxpc3RlbmVyLCBpID0gMDsKCiAgICAgICAgICAgIC8vIFJlcGxhY2UgX3RoZW4gd2l0aCBvbmUgdGhhdCBkaXJlY3RseSBub3RpZmllcyB3aXRoIHRoZSByZXN1bHQuCiAgICAgICAgICAgIF90aGVuID0gY29tcGxldGVkLnRoZW47CgogICAgICAgICAgICAvLyBSZXBsYWNlIGNvbXBsZXRlIHNvIHRoYXQgdGhpcyBEZWZlcnJlZCBjYW4gb25seSBiZSBjb21wbGV0ZWQKICAgICAgICAgICAgLy8gb25jZS4gQWxzbyBSZXBsYWNlIF9wcm9ncmVzcywgc28gdGhhdCBzdWJzZXF1ZW50IGF0dGVtcHRzIHRvIGlzc3VlCiAgICAgICAgICAgIC8vIHByb2dyZXNzIHRocm93LgogICAgICAgICAgICBjb21wbGV0ZSA9IF9wcm9ncmVzcyA9IGZ1bmN0aW9uIGFscmVhZHlDb21wbGV0ZWQoKSB7CiAgICAgICAgICAgICAgICAvLyBUT0RPOiBDb25zaWRlciBzaWxlbnRseSByZXR1cm5pbmcgaGVyZSBzbyB0aGF0IHBhcnRpZXMgd2hvCiAgICAgICAgICAgICAgICAvLyBoYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSByZXNvbHZlciBjYW5ub3QgdGVsbCB0aGF0IHRoZSBwcm9taXNlCiAgICAgICAgICAgICAgICAvLyBoYXMgYmVlbiByZXNvbHZlZCB1c2luZyB0cnkvY2F0Y2gKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYWxyZWFkeSBjb21wbGV0ZWQiKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEZyZWUgcHJvZ3Jlc3NIYW5kbGVycyBhcnJheSBzaW5jZSB3ZSdsbCBuZXZlciBpc3N1ZSBwcm9ncmVzcyBldmVudHMKICAgICAgICAgICAgLy8gZm9yIHRoaXMgcHJvbWlzZSBhZ2FpbiBub3cgdGhhdCBpdCdzIGNvbXBsZXRlZAogICAgICAgICAgICBwcm9ncmVzc0hhbmRsZXJzID0gdW5kZWY7CgogICAgICAgICAgICAvLyBOb3RpZnkgbGlzdGVuZXJzCiAgICAgICAgICAgIC8vIFRyYXZlcnNlIGFsbCBsaXN0ZW5lcnMgcmVnaXN0ZXJlZCBkaXJlY3RseSB3aXRoIHRoaXMgRGVmZXJyZWQKCiAgICAgICAgICAgIHdoaWxlIChsaXN0ZW5lciA9IGxpc3RlbmVyc1tpKytdKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcihjb21wbGV0ZWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgZnVsbCBEZWZlcnJlZCBvYmplY3QsIHdpdGggYm90aCB7QGxpbmsgUHJvbWlzZX0gYW5kIHtAbGluayBSZXNvbHZlcn0KICAgICAgICAgKiBwYXJ0cwogICAgICAgICAqIEBjbGFzcyBEZWZlcnJlZAogICAgICAgICAqIEBuYW1lIERlZmVycmVkCiAgICAgICAgICovCiAgICAgICAgZGVmZXJyZWQgPSB7fTsKCiAgICAgICAgLy8gUHJvbWlzZSBhbmQgUmVzb2x2ZXIgcGFydHMKICAgICAgICAvLyBGcmVlemUgUHJvbWlzZSBhbmQgUmVzb2x2ZXIgQVBJcwoKICAgICAgICBwcm9taXNlID0gbmV3IFByb21pc2UoKTsKICAgICAgICBwcm9taXNlLnRoZW4gPSBkZWZlcnJlZC50aGVuID0gdGhlbjsKCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHtAbGluayBQcm9taXNlfSBmb3IgdGhpcyB7QGxpbmsgRGVmZXJyZWR9CiAgICAgICAgICogQG1lbWJlck9mIERlZmVycmVkCiAgICAgICAgICogQG5hbWUgcHJvbWlzZQogICAgICAgICAqIEB0eXBlIHtQcm9taXNlfQogICAgICAgICAqLwogICAgICAgIGRlZmVycmVkLnByb21pc2UgPSBmcmVlemUocHJvbWlzZSk7CgogICAgICAgIC8qKgogICAgICAgICAqIFRoZSB7QGxpbmsgUmVzb2x2ZXJ9IGZvciB0aGlzIHtAbGluayBEZWZlcnJlZH0KICAgICAgICAgKiBAbWVtYmVyT2YgRGVmZXJyZWQKICAgICAgICAgKiBAbmFtZSByZXNvbHZlcgogICAgICAgICAqIEBjbGFzcyBSZXNvbHZlcgogICAgICAgICAqLwogICAgICAgIGRlZmVycmVkLnJlc29sdmVyID0gZnJlZXplKHsKICAgICAgICAgICAgcmVzb2x2ZTogIChkZWZlcnJlZC5yZXNvbHZlICA9IHJlc29sdmUpLAogICAgICAgICAgICByZWplY3Q6ICAgKGRlZmVycmVkLnJlamVjdCAgID0gcmVqZWN0KSwKICAgICAgICAgICAgcHJvZ3Jlc3M6IChkZWZlcnJlZC5wcm9ncmVzcyA9IHByb2dyZXNzKQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZGVmZXJyZWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmVzIGlmIHByb21pc2VPclZhbHVlIGlzIGEgcHJvbWlzZSBvciBub3QuICBVc2VzIHRoZSBmZWF0dXJlCiAgICAgKiB0ZXN0IGZyb20gaHR0cDovL3dpa2kuY29tbW9uanMub3JnL3dpa2kvUHJvbWlzZXMvQSB0byBkZXRlcm1pbmUgaWYKICAgICAqIHByb21pc2VPclZhbHVlIGlzIGEgcHJvbWlzZS4KICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZU9yVmFsdWUgYW55dGhpbmcKICAgICAqCiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBwcm9taXNlT3JWYWx1ZSBpcyBhIHtAbGluayBQcm9taXNlfQogICAgICovCiAgICBmdW5jdGlvbiBpc1Byb21pc2UocHJvbWlzZU9yVmFsdWUpIHsKICAgICAgICByZXR1cm4gcHJvbWlzZU9yVmFsdWUgJiYgdHlwZW9mIHByb21pc2VPclZhbHVlLnRoZW4gPT09ICdmdW5jdGlvbic7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWdpc3RlciBhbiBvYnNlcnZlciBmb3IgYSBwcm9taXNlIG9yIGltbWVkaWF0ZSB2YWx1ZS4KICAgICAqCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBuYW1lIHdoZW4KICAgICAqIEBuYW1lc3BhY2UKICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZU9yVmFsdWUgYW55dGhpbmcKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gY2FsbGJhY2sgdG8gYmUgY2FsbGVkIHdoZW4gcHJvbWlzZU9yVmFsdWUgaXMKICAgICAqICAgc3VjY2Vzc2Z1bGx5IHJlc29sdmVkLiAgSWYgcHJvbWlzZU9yVmFsdWUgaXMgYW4gaW1tZWRpYXRlIHZhbHVlLCBjYWxsYmFjawogICAgICogICB3aWxsIGJlIGludm9rZWQgaW1tZWRpYXRlbHkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbZXJyYmFja10gY2FsbGJhY2sgdG8gYmUgY2FsbGVkIHdoZW4gcHJvbWlzZU9yVmFsdWUgaXMKICAgICAqICAgcmVqZWN0ZWQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJvZ3Jlc3NIYW5kbGVyXSBjYWxsYmFjayB0byBiZSBjYWxsZWQgd2hlbiBwcm9ncmVzcyB1cGRhdGVzCiAgICAgKiAgIGFyZSBpc3N1ZWQgZm9yIHByb21pc2VPclZhbHVlLgogICAgICoKICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBhIG5ldyB7QGxpbmsgUHJvbWlzZX0gdGhhdCB3aWxsIGNvbXBsZXRlIHdpdGggdGhlIHJldHVybgogICAgICogICB2YWx1ZSBvZiBjYWxsYmFjayBvciBlcnJiYWNrIG9yIHRoZSBjb21wbGV0aW9uIHZhbHVlIG9mIHByb21pc2VPclZhbHVlIGlmCiAgICAgKiAgIGNhbGxiYWNrIGFuZC9vciBlcnJiYWNrIGlzIG5vdCBzdXBwbGllZC4KICAgICAqLwogICAgZnVuY3Rpb24gd2hlbihwcm9taXNlT3JWYWx1ZSwgY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzSGFuZGxlcikgewogICAgICAgIC8vIEdldCBhIHByb21pc2UgZm9yIHRoZSBpbnB1dCBwcm9taXNlT3JWYWx1ZQogICAgICAgIC8vIFNlZSBwcm9taXNlKCkKICAgICAgICB2YXIgdHJ1c3RlZFByb21pc2UgPSBwcm9taXNlKHByb21pc2VPclZhbHVlKTsKCiAgICAgICAgLy8gUmVnaXN0ZXIgcHJvbWlzZSBoYW5kbGVycwogICAgICAgIHJldHVybiB0cnVzdGVkUHJvbWlzZS50aGVuKGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc0hhbmRsZXIpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBwcm9taXNlT3JWYWx1ZSBpZiBwcm9taXNlT3JWYWx1ZSBpcyBhIHtAbGluayBQcm9taXNlfSwgYSBuZXcgUHJvbWlzZSBpZgogICAgICogcHJvbWlzZU9yVmFsdWUgaXMgYSBmb3JlaWduIHByb21pc2UsIG9yIGEgbmV3LCBhbHJlYWR5LXJlc29sdmVkIHtAbGluayBQcm9taXNlfQogICAgICogd2hvc2UgcmVzb2x1dGlvbiB2YWx1ZSBpcyBwcm9taXNlT3JWYWx1ZSBpZiBwcm9taXNlT3JWYWx1ZSBpcyBhbiBpbW1lZGlhdGUgdmFsdWUuCiAgICAgKgogICAgICogTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gaXMgbm90IHNhZmUgdG8gZXhwb3J0IHNpbmNlIGl0IHdpbGwgcmV0dXJuIGl0cwogICAgICogaW5wdXQgd2hlbiBwcm9taXNlT3JWYWx1ZSBpcyBhIHtAbGluayBQcm9taXNlfQogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIHByb21pc2VPclZhbHVlIGFueXRoaW5nCiAgICAgKgogICAgICogQHJldHVybnMgR3VhcmFudGVlZCB0byByZXR1cm4gYSB0cnVzdGVkIFByb21pc2UuICBJZiBwcm9taXNlT3JWYWx1ZSBpcyBhIHdoZW4uanMge0BsaW5rIFByb21pc2V9CiAgICAgKiAgIHJldHVybnMgcHJvbWlzZU9yVmFsdWUsIG90aGVyd2lzZSwgcmV0dXJucyBhIG5ldywgYWxyZWFkeS1yZXNvbHZlZCwgd2hlbi5qcyB7QGxpbmsgUHJvbWlzZX0KICAgICAqICAgd2hvc2UgcmVzb2x1dGlvbiB2YWx1ZSBpczoKICAgICAqICAgKiB0aGUgcmVzb2x1dGlvbiB2YWx1ZSBvZiBwcm9taXNlT3JWYWx1ZSBpZiBpdCdzIGEgZm9yZWlnbiBwcm9taXNlLCBvcgogICAgICogICAqIHByb21pc2VPclZhbHVlIGlmIGl0J3MgYSB2YWx1ZQogICAgICovCiAgICBmdW5jdGlvbiBwcm9taXNlKHByb21pc2VPclZhbHVlKSB7CiAgICAgICAgdmFyIHByb21pc2UsIGRlZmVycmVkOwoKICAgICAgICBpZihwcm9taXNlT3JWYWx1ZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICAgICAgLy8gSXQncyBhIHdoZW4uanMgcHJvbWlzZSwgc28gd2UgdHJ1c3QgaXQKICAgICAgICAgICAgcHJvbWlzZSA9IHByb21pc2VPclZhbHVlOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJdCdzIG5vdCBhIHdoZW4uanMgcHJvbWlzZS4gIENoZWNrIHRvIHNlZSBpZiBpdCdzIGEgZm9yZWlnbiBwcm9taXNlCiAgICAgICAgICAgIC8vIG9yIGEgdmFsdWUuCgogICAgICAgICAgICBkZWZlcnJlZCA9IGRlZmVyKCk7CiAgICAgICAgICAgIGlmKGlzUHJvbWlzZShwcm9taXNlT3JWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIC8vIEl0J3MgYSBjb21wbGlhbnQgcHJvbWlzZSwgYnV0IHdlIGRvbid0IGtub3cgd2hlcmUgaXQgY2FtZSBmcm9tLAogICAgICAgICAgICAgICAgLy8gc28gd2UgZG9uJ3QgdHJ1c3QgaXRzIGltcGxlbWVudGF0aW9uIGVudGlyZWx5LiAgSW50cm9kdWNlIGEgdHJ1c3RlZAogICAgICAgICAgICAgICAgLy8gbWlkZGxlbWFuIHdoZW4uanMgcHJvbWlzZQoKICAgICAgICAgICAgICAgIC8vIElNUE9SVEFOVDogVGhpcyBpcyB0aGUgb25seSBwbGFjZSB3aGVuLmpzIHNob3VsZCBldmVyIGNhbGwgLnRoZW4oKSBvbgogICAgICAgICAgICAgICAgLy8gYW4gdW50cnVzdGVkIHByb21pc2UuCiAgICAgICAgICAgICAgICBwcm9taXNlT3JWYWx1ZS50aGVuKGRlZmVycmVkLnJlc29sdmUsIGRlZmVycmVkLnJlamVjdCwgZGVmZXJyZWQucHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2U7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSXQncyBhIHZhbHVlLCBub3QgYSBwcm9taXNlLiAgQ3JlYXRlIGFuIGFscmVhZHktcmVzb2x2ZWQgcHJvbWlzZQogICAgICAgICAgICAgICAgLy8gZm9yIGl0LgogICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShwcm9taXNlT3JWYWx1ZSk7CiAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHdoZW4gaG93TWFueSBvZiB0aGUgc3VwcGxpZWQgcHJvbWlzZXNPclZhbHVlcwogICAgICogaGF2ZSByZXNvbHZlZC4gVGhlIHJlc29sdXRpb24gdmFsdWUgb2YgdGhlIHJldHVybmVkIHByb21pc2Ugd2lsbCBiZSBhbiBhcnJheSBvZgogICAgICogbGVuZ3RoIGhvd01hbnkgY29udGFpbmluZyB0aGUgcmVzb2x1dGlvbnMgdmFsdWVzIG9mIHRoZSB0cmlnZ2VyaW5nIHByb21pc2VzT3JWYWx1ZXMuCiAgICAgKgogICAgICogQG1lbWJlck9mIHdoZW4KICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZXNPclZhbHVlcyB7QXJyYXl9IGFycmF5IG9mIGFueXRoaW5nLCBtYXkgY29udGFpbiBhIG1peAogICAgICogICAgICBvZiB7QGxpbmsgUHJvbWlzZX1zIGFuZCB2YWx1ZXMKICAgICAqIEBwYXJhbSBob3dNYW55CiAgICAgKiBAcGFyYW0gW2NhbGxiYWNrXQogICAgICogQHBhcmFtIFtlcnJiYWNrXQogICAgICogQHBhcmFtIFtwcm9ncmVzc0hhbmRsZXJdCiAgICAgKgogICAgICogQHJldHVybnMge1Byb21pc2V9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHNvbWUocHJvbWlzZXNPclZhbHVlcywgaG93TWFueSwgY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzSGFuZGxlcikgewoKICAgICAgICBjaGVja0NhbGxiYWNrcygyLCBhcmd1bWVudHMpOwoKICAgICAgICByZXR1cm4gd2hlbihwcm9taXNlc09yVmFsdWVzLCBmdW5jdGlvbihwcm9taXNlc09yVmFsdWVzKSB7CgogICAgICAgICAgICB2YXIgdG9SZXNvbHZlLCByZXN1bHRzLCByZXQsIGRlZmVycmVkLCByZXNvbHZlciwgcmVqZWN0ZXIsIGhhbmRsZVByb2dyZXNzLCBsZW4sIGk7CgogICAgICAgICAgICBsZW4gPSBwcm9taXNlc09yVmFsdWVzLmxlbmd0aCA+Pj4gMDsKCiAgICAgICAgICAgIHRvUmVzb2x2ZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKGhvd01hbnksIGxlbikpOwogICAgICAgICAgICByZXN1bHRzID0gW107CiAgICAgICAgICAgIGRlZmVycmVkID0gZGVmZXIoKTsKICAgICAgICAgICAgcmV0ID0gd2hlbihkZWZlcnJlZCwgY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzSGFuZGxlcik7CgogICAgICAgICAgICAvLyBXcmFwcGVyIHNvIHRoYXQgcmVzb2x2ZXIgY2FuIGJlIHJlcGxhY2VkCiAgICAgICAgICAgIGZ1bmN0aW9uIHJlc29sdmUodmFsKSB7CiAgICAgICAgICAgICAgICByZXNvbHZlcih2YWwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBXcmFwcGVyIHNvIHRoYXQgcmVqZWN0ZXIgY2FuIGJlIHJlcGxhY2VkCiAgICAgICAgICAgIGZ1bmN0aW9uIHJlamVjdChlcnIpIHsKICAgICAgICAgICAgICAgIHJlamVjdGVyKGVycik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFdyYXBwZXIgc28gdGhhdCBwcm9ncmVzcyBjYW4gYmUgcmVwbGFjZWQKICAgICAgICAgICAgZnVuY3Rpb24gcHJvZ3Jlc3ModXBkYXRlKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVQcm9ncmVzcyh1cGRhdGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZSgpIHsKICAgICAgICAgICAgICAgIHJlc29sdmVyID0gcmVqZWN0ZXIgPSBoYW5kbGVQcm9ncmVzcyA9IG5vb3A7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5vIGl0ZW1zIGluIHRoZSBpbnB1dCwgcmVzb2x2ZSBpbW1lZGlhdGVseQogICAgICAgICAgICBpZiAoIXRvUmVzb2x2ZSkgewogICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBSZXNvbHZlciBmb3IgcHJvbWlzZXMuICBDYXB0dXJlcyB0aGUgdmFsdWUgYW5kIHJlc29sdmVzCiAgICAgICAgICAgICAgICAvLyB0aGUgcmV0dXJuZWQgcHJvbWlzZSB3aGVuIHRvUmVzb2x2ZSByZWFjaGVzIHplcm8uCiAgICAgICAgICAgICAgICAvLyBPdmVyd3JpdGVzIHJlc29sdmVyIHZhciB3aXRoIGEgbm9vcCBvbmNlIHByb21pc2UgaGFzCiAgICAgICAgICAgICAgICAvLyBiZSByZXNvbHZlZCB0byBjb3ZlciBjYXNlIHdoZXJlIG4gPCBwcm9taXNlcy5sZW5ndGgKICAgICAgICAgICAgICAgIHJlc29sdmVyID0gZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBvcmRlcnMgdGhlIHZhbHVlcyBiYXNlZCBvbiBwcm9taXNlIHJlc29sdXRpb24gb3JkZXIKICAgICAgICAgICAgICAgICAgICAvLyBBbm90aGVyIHN0cmF0ZWd5IHdvdWxkIGJlIHRvIHVzZSB0aGUgb3JpZ2luYWwgcG9zaXRpb24gb2YKICAgICAgICAgICAgICAgICAgICAvLyB0aGUgY29ycmVzcG9uZGluZyBwcm9taXNlLgogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh2YWwpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIS0tdG9SZXNvbHZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzdWx0cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBSZWplY3RlciBmb3IgcHJvbWlzZXMuICBSZWplY3RzIHJldHVybmVkIHByb21pc2UKICAgICAgICAgICAgICAgIC8vIGltbWVkaWF0ZWx5LCBhbmQgb3ZlcndyaXRlcyByZWplY3RlciB2YXIgd2l0aCBhIG5vb3AKICAgICAgICAgICAgICAgIC8vIG9uY2UgcHJvbWlzZSB0byBjb3ZlciBjYXNlIHdoZXJlIG4gPCBwcm9taXNlcy5sZW5ndGguCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBDb25zaWRlciByZWplY3Rpbmcgb25seSB3aGVuIE4gKG9yIHByb21pc2VzLmxlbmd0aCAtIE4/KQogICAgICAgICAgICAgICAgLy8gcHJvbWlzZXMgaGF2ZSBiZWVuIHJlamVjdGVkIGluc3RlYWQgb2Ygb25seSBvbmU/CiAgICAgICAgICAgICAgICByZWplY3RlciA9IGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlKCk7CiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGhhbmRsZVByb2dyZXNzID0gZGVmZXJyZWQucHJvZ3Jlc3M7CgogICAgICAgICAgICAgICAgLy8gVE9ETzogUmVwbGFjZSB3aGlsZSB3aXRoIGZvckVhY2gKICAgICAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoaSBpbiBwcm9taXNlc09yVmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoZW4ocHJvbWlzZXNPclZhbHVlc1tpXSwgcmVzb2x2ZSwgcmVqZWN0LCBwcm9ncmVzcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIGEgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSBvbmx5IG9uY2UgYWxsIHRoZSBzdXBwbGllZCBwcm9taXNlc09yVmFsdWVzCiAgICAgKiBoYXZlIHJlc29sdmVkLiBUaGUgcmVzb2x1dGlvbiB2YWx1ZSBvZiB0aGUgcmV0dXJuZWQgcHJvbWlzZSB3aWxsIGJlIGFuIGFycmF5CiAgICAgKiBjb250YWluaW5nIHRoZSByZXNvbHV0aW9uIHZhbHVlcyBvZiBlYWNoIG9mIHRoZSBwcm9taXNlc09yVmFsdWVzLgogICAgICoKICAgICAqIEBtZW1iZXJPZiB3aGVuCiAgICAgKgogICAgICogQHBhcmFtIHByb21pc2VzT3JWYWx1ZXMge0FycmF5fFByb21pc2V9IGFycmF5IG9mIGFueXRoaW5nLCBtYXkgY29udGFpbiBhIG1peAogICAgICogICAgICBvZiB7QGxpbmsgUHJvbWlzZX1zIGFuZCB2YWx1ZXMKICAgICAqIEBwYXJhbSBbY2FsbGJhY2tdIHtGdW5jdGlvbn0KICAgICAqIEBwYXJhbSBbZXJyYmFja10ge0Z1bmN0aW9ufQogICAgICogQHBhcmFtIFtwcm9ncmVzc0hhbmRsZXJdIHtGdW5jdGlvbn0KICAgICAqCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0KICAgICAqLwogICAgZnVuY3Rpb24gYWxsKHByb21pc2VzT3JWYWx1ZXMsIGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc0hhbmRsZXIpIHsKCiAgICAgICAgY2hlY2tDYWxsYmFja3MoMSwgYXJndW1lbnRzKTsKCiAgICAgICAgcmV0dXJuIHdoZW4ocHJvbWlzZXNPclZhbHVlcywgZnVuY3Rpb24ocHJvbWlzZXNPclZhbHVlcykgewogICAgICAgICAgICByZXR1cm4gX3JlZHVjZShwcm9taXNlc09yVmFsdWVzLCByZWR1Y2VJbnRvQXJyYXksIFtdKTsKICAgICAgICB9KS50aGVuKGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc0hhbmRsZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlZHVjZUludG9BcnJheShjdXJyZW50LCB2YWwsIGkpIHsKICAgICAgICBjdXJyZW50W2ldID0gdmFsOwogICAgICAgIHJldHVybiBjdXJyZW50OwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIGEgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSB3aGVuIGFueSBvbmUgb2YgdGhlIHN1cHBsaWVkIHByb21pc2VzT3JWYWx1ZXMKICAgICAqIGhhcyByZXNvbHZlZC4gVGhlIHJlc29sdXRpb24gdmFsdWUgb2YgdGhlIHJldHVybmVkIHByb21pc2Ugd2lsbCBiZSB0aGUgcmVzb2x1dGlvbgogICAgICogdmFsdWUgb2YgdGhlIHRyaWdnZXJpbmcgcHJvbWlzZU9yVmFsdWUuCiAgICAgKgogICAgICogQG1lbWJlck9mIHdoZW4KICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZXNPclZhbHVlcyB7QXJyYXl8UHJvbWlzZX0gYXJyYXkgb2YgYW55dGhpbmcsIG1heSBjb250YWluIGEgbWl4CiAgICAgKiAgICAgIG9mIHtAbGluayBQcm9taXNlfXMgYW5kIHZhbHVlcwogICAgICogQHBhcmFtIFtjYWxsYmFja10ge0Z1bmN0aW9ufQogICAgICogQHBhcmFtIFtlcnJiYWNrXSB7RnVuY3Rpb259CiAgICAgKiBAcGFyYW0gW3Byb2dyZXNzSGFuZGxlcl0ge0Z1bmN0aW9ufQogICAgICoKICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQogICAgICovCiAgICBmdW5jdGlvbiBhbnkocHJvbWlzZXNPclZhbHVlcywgY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzSGFuZGxlcikgewoKICAgICAgICBmdW5jdGlvbiB1bndyYXBTaW5nbGVSZXN1bHQodmFsKSB7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayA/IGNhbGxiYWNrKHZhbFswXSkgOiB2YWxbMF07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc29tZShwcm9taXNlc09yVmFsdWVzLCAxLCB1bndyYXBTaW5nbGVSZXN1bHQsIGVycmJhY2ssIHByb2dyZXNzSGFuZGxlcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBUcmFkaXRpb25hbCBtYXAgZnVuY3Rpb24sIHNpbWlsYXIgdG8gYEFycmF5LnByb3RvdHlwZS5tYXAoKWAsIGJ1dCBhbGxvd3MKICAgICAqIGlucHV0IHRvIGNvbnRhaW4ge0BsaW5rIFByb21pc2V9cyBhbmQvb3IgdmFsdWVzLCBhbmQgbWFwRnVuYyBtYXkgcmV0dXJuCiAgICAgKiBlaXRoZXIgYSB2YWx1ZSBvciBhIHtAbGluayBQcm9taXNlfQogICAgICoKICAgICAqIEBtZW1iZXJPZiB3aGVuCiAgICAgKgogICAgICogQHBhcmFtIHByb21pc2Uge0FycmF5fFByb21pc2V9IGFycmF5IG9mIGFueXRoaW5nLCBtYXkgY29udGFpbiBhIG1peAogICAgICogICAgICBvZiB7QGxpbmsgUHJvbWlzZX1zIGFuZCB2YWx1ZXMKICAgICAqIEBwYXJhbSBtYXBGdW5jIHtGdW5jdGlvbn0gbWFwcGluZyBmdW5jdGlvbiBtYXBGdW5jKHZhbHVlKSB3aGljaCBtYXkgcmV0dXJuCiAgICAgKiAgICAgIGVpdGhlciBhIHtAbGluayBQcm9taXNlfSBvciB2YWx1ZQogICAgICoKICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBhIHtAbGluayBQcm9taXNlfSB0aGF0IHdpbGwgcmVzb2x2ZSB0byBhbiBhcnJheSBjb250YWluaW5nCiAgICAgKiAgICAgIHRoZSBtYXBwZWQgb3V0cHV0IHZhbHVlcy4KICAgICAqLwogICAgZnVuY3Rpb24gbWFwKHByb21pc2UsIG1hcEZ1bmMpIHsKICAgICAgICByZXR1cm4gd2hlbihwcm9taXNlLCBmdW5jdGlvbihhcnJheSkgewogICAgICAgICAgICByZXR1cm4gX21hcChhcnJheSwgbWFwRnVuYyk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBQcml2YXRlIG1hcCBoZWxwZXIgdG8gbWFwIGFuIGFycmF5IG9mIHByb21pc2VzCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlc09yVmFsdWVzIHtBcnJheX0KICAgICAqIEBwYXJhbSBtYXBGdW5jIHtGdW5jdGlvbn0KICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICAgIGZ1bmN0aW9uIF9tYXAocHJvbWlzZXNPclZhbHVlcywgbWFwRnVuYykgewoKICAgICAgICB2YXIgcmVzdWx0cywgbGVuLCBpOwoKICAgICAgICAvLyBTaW5jZSB3ZSBrbm93IHRoZSByZXN1bHRpbmcgbGVuZ3RoLCB3ZSBjYW4gcHJlYWxsb2NhdGUgdGhlIHJlc3VsdHMKICAgICAgICAvLyBhcnJheSB0byBhdm9pZCBhcnJheSBleHBhbnNpb25zLgogICAgICAgIGxlbiA9IHByb21pc2VzT3JWYWx1ZXMubGVuZ3RoID4+PiAwOwogICAgICAgIHJlc3VsdHMgPSBuZXcgQXJyYXkobGVuKTsKCiAgICAgICAgLy8gU2luY2UgbWFwRnVuYyBtYXkgYmUgYXN5bmMsIGdldCBhbGwgaW52b2NhdGlvbnMgb2YgaXQgaW50byBmbGlnaHQKICAgICAgICAvLyBhc2FwLCBhbmQgdGhlbiB1c2UgcmVkdWNlKCkgdG8gY29sbGVjdCBhbGwgdGhlIHJlc3VsdHMKICAgICAgICBmb3IoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpZihpIGluIHByb21pc2VzT3JWYWx1ZXMpCiAgICAgICAgICAgICAgICByZXN1bHRzW2ldID0gd2hlbihwcm9taXNlc09yVmFsdWVzW2ldLCBtYXBGdW5jKTsKICAgICAgICB9CgogICAgICAgIC8vIENvdWxkIHVzZSBhbGwoKSBoZXJlLCBidXQgdGhhdCB3b3VsZCByZXN1bHQgaW4gYW5vdGhlciBhcnJheQogICAgICAgIC8vIGJlaW5nIGFsbG9jYXRlZCwgaS5lLiBtYXAoKSB3b3VsZCBlbmQgdXAgYWxsb2NhdGluZyAyIGFycmF5cwogICAgICAgIC8vIG9mIHNpemUgbGVuIGluc3RlYWQgb2YganVzdCAxLiAgU2luY2UgYWxsKCkgdXNlcyByZWR1Y2UoKQogICAgICAgIC8vIGFueXdheSwgYXZvaWQgdGhlIGFkZGl0aW9uYWwgYWxsb2NhdGlvbiBieSBjYWxsaW5nIHJlZHVjZQogICAgICAgIC8vIGRpcmVjdGx5LgogICAgICAgIHJldHVybiBfcmVkdWNlKHJlc3VsdHMsIHJlZHVjZUludG9BcnJheSwgcmVzdWx0cyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUcmFkaXRpb25hbCByZWR1Y2UgZnVuY3Rpb24sIHNpbWlsYXIgdG8gYEFycmF5LnByb3RvdHlwZS5yZWR1Y2UoKWAsIGJ1dAogICAgICogaW5wdXQgbWF5IGNvbnRhaW4ge0BsaW5rIFByb21pc2V9cyBhbmQvb3IgdmFsdWVzLCBhbmQgcmVkdWNlRnVuYwogICAgICogbWF5IHJldHVybiBlaXRoZXIgYSB2YWx1ZSBvciBhIHtAbGluayBQcm9taXNlfSwgKmFuZCogaW5pdGlhbFZhbHVlIG1heQogICAgICogYmUgYSB7QGxpbmsgUHJvbWlzZX0gZm9yIHRoZSBzdGFydGluZyB2YWx1ZS4KICAgICAqCiAgICAgKiBAbWVtYmVyT2Ygd2hlbgogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlIHtBcnJheXxQcm9taXNlfSBhcnJheSBvZiBhbnl0aGluZywgbWF5IGNvbnRhaW4gYSBtaXgKICAgICAqICAgICAgb2Yge0BsaW5rIFByb21pc2V9cyBhbmQgdmFsdWVzLiAgTWF5IGFsc28gYmUgYSB7QGxpbmsgUHJvbWlzZX0gZm9yCiAgICAgKiAgICAgIGFuIGFycmF5LgogICAgICogQHBhcmFtIHJlZHVjZUZ1bmMge0Z1bmN0aW9ufSByZWR1Y2UgZnVuY3Rpb24gcmVkdWNlKGN1cnJlbnRWYWx1ZSwgbmV4dFZhbHVlLCBpbmRleCwgdG90YWwpLAogICAgICogICAgICB3aGVyZSB0b3RhbCBpcyB0aGUgdG90YWwgbnVtYmVyIG9mIGl0ZW1zIGJlaW5nIHJlZHVjZWQsIGFuZCB3aWxsIGJlIHRoZSBzYW1lCiAgICAgKiAgICAgIGluIGVhY2ggY2FsbCB0byByZWR1Y2VGdW5jLgogICAgICogQHBhcmFtIGluaXRpYWxWYWx1ZSBzdGFydGluZyB2YWx1ZSwgb3IgYSB7QGxpbmsgUHJvbWlzZX0gZm9yIHRoZSBzdGFydGluZyB2YWx1ZQogICAgICoKICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSB0aGF0IHdpbGwgcmVzb2x2ZSB0byB0aGUgZmluYWwgcmVkdWNlZCB2YWx1ZQogICAgICovCiAgICBmdW5jdGlvbiByZWR1Y2UocHJvbWlzZSwgcmVkdWNlRnVuYywgaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgcmV0dXJuIHdoZW4ocHJvbWlzZSwgZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuIF9yZWR1Y2UuYXBwbHkodW5kZWYsIFthcnJheV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFByaXZhdGUgcmVkdWNlIHRvIHJlZHVjZSBhbiBhcnJheSBvZiBwcm9taXNlcwogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZXNPclZhbHVlcyB7QXJyYXl9CiAgICAgKiBAcGFyYW0gcmVkdWNlRnVuYyB7RnVuY3Rpb259CiAgICAgKiBAcGFyYW0gaW5pdGlhbFZhbHVlIHsqfQogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogICAgZnVuY3Rpb24gX3JlZHVjZShwcm9taXNlc09yVmFsdWVzLCByZWR1Y2VGdW5jLCBpbml0aWFsVmFsdWUpIHsKCiAgICAgICAgdmFyIHRvdGFsLCBhcmdzOwoKICAgICAgICB0b3RhbCA9IHByb21pc2VzT3JWYWx1ZXMubGVuZ3RoOwoKICAgICAgICAvLyBTa2lwIHByb21pc2VzT3JWYWx1ZXMsIHNpbmNlIGl0IHdpbGwgYmUgdXNlZCBhcyAndGhpcycgaW4gdGhlIGNhbGwKICAgICAgICAvLyB0byB0aGUgYWN0dWFsIHJlZHVjZSBlbmdpbmUgYmVsb3cuCgogICAgICAgIC8vIFdyYXAgdGhlIHN1cHBsaWVkIHJlZHVjZUZ1bmMgd2l0aCBvbmUgdGhhdCBoYW5kbGVzIHByb21pc2VzIGFuZCB0aGVuCiAgICAgICAgLy8gZGVsZWdhdGVzIHRvIHRoZSBzdXBwbGllZC4KCiAgICAgICAgYXJncyA9IFsKICAgICAgICAgICAgZnVuY3Rpb24gKGN1cnJlbnQsIHZhbCwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4oY3VycmVudCwgZnVuY3Rpb24gKGMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbih2YWwsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVkdWNlRnVuYyhjLCB2YWx1ZSwgaSwgdG90YWwpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICBdOwoKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIGFyZ3MucHVzaChpbml0aWFsVmFsdWUpOwoKICAgICAgICByZXR1cm4gcmVkdWNlQXJyYXkuYXBwbHkocHJvbWlzZXNPclZhbHVlcywgYXJncyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBFbnN1cmUgdGhhdCByZXNvbHV0aW9uIG9mIHByb21pc2VPclZhbHVlIHdpbGwgY29tcGxldGUgcmVzb2x2ZXIgd2l0aCB0aGUgY29tcGxldGlvbgogICAgICogdmFsdWUgb2YgcHJvbWlzZU9yVmFsdWUsIG9yIGluc3RlYWQgd2l0aCByZXNvbHZlVmFsdWUgaWYgaXQgaXMgcHJvdmlkZWQuCiAgICAgKgogICAgICogQG1lbWJlck9mIHdoZW4KICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZU9yVmFsdWUKICAgICAqIEBwYXJhbSByZXNvbHZlciB7UmVzb2x2ZXJ9CiAgICAgKiBAcGFyYW0gW3Jlc29sdmVWYWx1ZV0gYW55dGhpbmcKICAgICAqCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0KICAgICAqLwogICAgZnVuY3Rpb24gY2hhaW4ocHJvbWlzZU9yVmFsdWUsIHJlc29sdmVyLCByZXNvbHZlVmFsdWUpIHsKICAgICAgICB2YXIgdXNlUmVzb2x2ZVZhbHVlID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CgogICAgICAgIHJldHVybiB3aGVuKHByb21pc2VPclZhbHVlLAogICAgICAgICAgICBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgICAgIGlmKHVzZVJlc29sdmVWYWx1ZSkgdmFsID0gcmVzb2x2ZVZhbHVlOwogICAgICAgICAgICAgICAgcmVzb2x2ZXIucmVzb2x2ZSh2YWwpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgcmVzb2x2ZXIucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdGVkKGUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZXNvbHZlci5wcm9ncmVzcwogICAgICAgICk7CiAgICB9CgogICAgLy8KICAgIC8vIFV0aWxpdHkgZnVuY3Rpb25zCiAgICAvLwoKICAgIC8qKgogICAgICogSGVscGVyIHRoYXQgY2hlY2tzIGFycmF5T2ZDYWxsYmFja3MgdG8gZW5zdXJlIHRoYXQgZWFjaCBlbGVtZW50IGlzIGVpdGhlcgogICAgICogYSBmdW5jdGlvbiwgb3IgbnVsbCBvciB1bmRlZmluZWQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gYXJyYXlPZkNhbGxiYWNrcyB7QXJyYXl9IGFycmF5IHRvIGNoZWNrCiAgICAgKiBAdGhyb3dzIHtFcnJvcn0gaWYgYW55IGVsZW1lbnQgb2YgYXJyYXlPZkNhbGxiYWNrcyBpcyBzb21ldGhpbmcgb3RoZXIgdGhhbgogICAgICogYSBGdW5jdGlvbnMsIG51bGwsIG9yIHVuZGVmaW5lZC4KICAgICAqLwogICAgZnVuY3Rpb24gY2hlY2tDYWxsYmFja3Moc3RhcnQsIGFycmF5T2ZDYWxsYmFja3MpIHsKICAgICAgICB2YXIgYXJnLCBpID0gYXJyYXlPZkNhbGxiYWNrcy5sZW5ndGg7CiAgICAgICAgd2hpbGUoaSA+IHN0YXJ0KSB7CiAgICAgICAgICAgIGFyZyA9IGFycmF5T2ZDYWxsYmFja3NbLS1pXTsKICAgICAgICAgICAgaWYgKGFyZyAhPSBudWxsICYmIHR5cGVvZiBhcmcgIT0gJ2Z1bmN0aW9uJykgdGhyb3cgbmV3IEVycm9yKCdjYWxsYmFjayBpcyBub3QgYSBmdW5jdGlvbicpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIE5vLU9wIGZ1bmN0aW9uIHVzZWQgaW4gbWV0aG9kIHJlcGxhY2VtZW50CiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBmdW5jdGlvbiBub29wKCkge30KCiAgICBzbGljZSA9IFtdLnNsaWNlOwoKICAgIC8vIEVTNSByZWR1Y2UgaW1wbGVtZW50YXRpb24gaWYgbmF0aXZlIG5vdCBhdmFpbGFibGUKICAgIC8vIFNlZTogaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuNC40LjIxIGFzIHRoZXJlIGFyZSBtYW55CiAgICAvLyBzcGVjaWZpY3MgYW5kIGVkZ2UgY2FzZXMuCiAgICByZWR1Y2VBcnJheSA9IFtdLnJlZHVjZSB8fAogICAgICAgIGZ1bmN0aW9uKHJlZHVjZUZ1bmMgLyosIGluaXRpYWxWYWx1ZSAqLykgewogICAgICAgICAgICAvLyBFUzUgZGljdGF0ZXMgdGhhdCByZWR1Y2UubGVuZ3RoID09PSAxCgogICAgICAgICAgICAvLyBUaGlzIGltcGxlbWVudGF0aW9uIGRldmlhdGVzIGZyb20gRVM1IHNwZWMgaW4gdGhlIGZvbGxvd2luZyB3YXlzOgogICAgICAgICAgICAvLyAxLiBJdCBkb2VzIG5vdCBjaGVjayBpZiByZWR1Y2VGdW5jIGlzIGEgQ2FsbGFibGUKCiAgICAgICAgICAgIHZhciBhcnIsIGFyZ3MsIHJlZHVjZWQsIGxlbiwgaTsKCiAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICBhcnIgPSBPYmplY3QodGhpcyk7CiAgICAgICAgICAgIGxlbiA9IGFyci5sZW5ndGggPj4+IDA7CiAgICAgICAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CgogICAgICAgICAgICAvLyBJZiBubyBpbml0aWFsVmFsdWUsIHVzZSBmaXJzdCBpdGVtIG9mIGFycmF5ICh3ZSBrbm93IGxlbmd0aCAhPT0gMCBoZXJlKQogICAgICAgICAgICAvLyBhbmQgYWRqdXN0IGkgdG8gc3RhcnQgYXQgc2Vjb25kIGl0ZW0KICAgICAgICAgICAgaWYoYXJncy5sZW5ndGggPD0gMSkgewogICAgICAgICAgICAgICAgLy8gU2tpcCB0byB0aGUgZmlyc3QgcmVhbCBlbGVtZW50IGluIHRoZSBhcnJheQogICAgICAgICAgICAgICAgZm9yKDs7KSB7CiAgICAgICAgICAgICAgICAgICAgaWYoaSBpbiBhcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVkdWNlZCA9IGFycltpKytdOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIElmIHdlIHJlYWNoZWQgdGhlIGVuZCBvZiB0aGUgYXJyYXkgd2l0aG91dCBmaW5kaW5nIGFueSByZWFsCiAgICAgICAgICAgICAgICAgICAgLy8gZWxlbWVudHMsIGl0J3MgYSBUeXBlRXJyb3IKICAgICAgICAgICAgICAgICAgICBpZigrK2kgPj0gbGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJZiBpbml0aWFsVmFsdWUgcHJvdmlkZWQsIHVzZSBpdAogICAgICAgICAgICAgICAgcmVkdWNlZCA9IGFyZ3NbMV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERvIHRoZSBhY3R1YWwgcmVkdWNlCiAgICAgICAgICAgIGZvcig7aSA8IGxlbjsgKytpKSB7CiAgICAgICAgICAgICAgICAvLyBTa2lwIGhvbGVzCiAgICAgICAgICAgICAgICBpZihpIGluIGFycikKICAgICAgICAgICAgICAgICAgICByZWR1Y2VkID0gcmVkdWNlRnVuYyhyZWR1Y2VkLCBhcnJbaV0sIGksIGFycik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZWR1Y2VkOwogICAgICAgIH07CgogICAgcmV0dXJuIHdoZW47Cn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKICAgID8gZGVmaW5lCiAgICA6IGZ1bmN0aW9uIChmYWN0b3J5KSB7IHR5cGVvZiBtb2R1bGUgIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSkKICAgICAgICA6ICh0aGlzLndoZW4gICAgICA9IGZhY3RvcnkoKSk7CiAgICB9CiAgICAvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCmRlZmluZSgnd2hlbicsIFsnd2hlbi93aGVuJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBUaGlzIGlzIGEgZHJvcC1pbiByZXBsYWNlbWVudCBmb3IgdGhlIHdoZW4gbW9kdWxlIHRoYXQgc2V0cyB1cCBhdXRvbWF0aWMKICogZGVidWcgb3V0cHV0IGZvciBwcm9taXNlcyBjcmVhdGVkIG9yIGNvbnN1bWVkIGJ5IHdoZW4uanMuICBVc2UgdGhpcwogKiBpbnN0ZWFkIG9mIHdoZW4gdG8gaGVscCB3aXRoIGRlYnVnZ2luZy4KICoKICogV0FSTklORzogVGhpcyBtb2R1bGUgKipzaG91bGQgbmV2ZXIqKiBiZSB1c2UgdGhpcyBpbiBhIHByb2R1Y3Rpb24gZW52aXJvbm1lbnQuCiAqIEl0IGV4cG9zZXMgZGV0YWlscyBvZiB0aGUgcHJvbWlzZQogKgogKiBJbiBhbiBBTUQgZW52aXJvbm1lbnQsIHlvdSBjYW4gc2ltcGx5IGNoYW5nZSB5b3VyIHBhdGggb3IgcGFja2FnZSBtYXBwaW5nczoKICoKICogcGF0aHM6IHsKICogICAvLyAnd2hlbic6ICdwYXRoL3RvL3doZW4vd2hlbicKICogICAnd2hlbic6ICdwYXRoL3RvL3doZW4vZGVidWcnCiAqIH0KICoKICogb3IKICoKICogcGFja2FnZXM6IFsKICogICAvLyB7IG5hbWU6ICd3aGVuJywgbG9jYXRpb246ICdwYXRoL3RvL3doZW4nLCBtYWluOiAnd2hlbicgfQogKiAgIHsgbmFtZTogJ3doZW4nLCBsb2NhdGlvbjogJ3BhdGgvdG8vd2hlbicsIG1haW46ICdkZWJ1ZycgfQogKiBdCiAqCiAqIEluIGEgQ29tbW9uSlMgZW52aXJvbm1lbnQsIHlvdSBjYW4gZGlyZWN0bHkgcmVxdWlyZSB0aGlzIG1vZHVsZSB3aGVyZQogKiB5b3Ugd291bGQgbm9ybWFsbHkgcmVxdWlyZSAnd2hlbic6CiAqCiAqIC8vIHZhciB3aGVuID0gcmVxdWlyZSgnd2hlbicpOwogKiB2YXIgd2hlbiA9IHJlcXVpcmUoJ3doZW4vZGVidWcnKTsKICoKICogT3IgeW91IGNhbiB0ZW1wb3JhcmlseSBtb2RpZnkgdGhlIHBhY2thZ2UuanMgdG8gcG9pbnQgbWFpbiBhdCBkZWJ1Zy4KICogRm9yIGV4YW1wbGUsIHdoZW4vcGFja2FnZS5qc29uOgogKgogKiAuLi4KICogIm1haW4iOiAiLi9kZWJ1ZyIKICogLi4uCiAqCiAqIEBhdXRob3IgYnJpYW5AaG92ZXJjcmFmdHN0dWRpb3MuY29tCiAqLwooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9kZWJ1ZycsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKICAgIHZhciBwcm9taXNlSWQsIGZyZWV6ZSwgcGVuZGluZywgZXhjZXB0aW9uc1RvUmV0aHJvdywgdW5kZWY7CgogICAgcHJvbWlzZUlkID0gMDsKICAgIGZyZWV6ZSA9IE9iamVjdC5mcmVlemUgfHwgZnVuY3Rpb24obykgeyByZXR1cm4gbzsgfTsKICAgIHBlbmRpbmcgPSB7fTsKCiAgICBleGNlcHRpb25zVG9SZXRocm93ID0gewogICAgICAgIFJhbmdlRXJyb3I6IDEsCiAgICAgICAgUmVmZXJlbmNlRXJyb3I6IDEsCiAgICAgICAgU3ludGF4RXJyb3I6IDEsCiAgICAgICAgVHlwZUVycm9yOiAxCiAgICB9OwoKICAgIC8qKgogICAgICogU2V0dXAgZGVidWcgb3V0cHV0IGhhbmRsZXJzIGZvciB0aGUgc3VwcGxpZWQgcHJvbWlzZS4KICAgICAqIEBwYXJhbSBwIHtQcm9taXNlfSBBIHRydXN0ZWQgKHdoZW4uanMpIHByb21pc2UKICAgICAqIEByZXR1cm4gcAogICAgICovCiAgICBmdW5jdGlvbiBkZWJ1Z1Byb21pc2UocCkgewogICAgICAgIC8vIFRPRE86IE5lZWQgdG8gZmluZCBhIHdheSBmb3IgcHJvbWlzZXMgcmV0dXJuZWQgYnkgLnRoZW4oKQogICAgICAgIC8vIHRvIGFsc28gYmUgZGVidWcgcHJvbWlzZXMuCiAgICAgICAgcC50aGVuKAogICAgICAgICAgICB1bmRlZiwKICAgICAgICAgICAgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICBpZihwLmlkKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihwLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbb2JqZWN0IFByb21pc2VdIFJFSkVDVEVEOicsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICApOwoKICAgICAgICByZXR1cm4gcDsKICAgIH0KCiAgICBmdW5jdGlvbiB3cmFwQ2FsbGJhY2soY2IpIHsKICAgICAgICBpZih0eXBlb2YgY2IgIT0gJ2Z1bmN0aW9uJykgcmV0dXJuIGNiOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24odikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNiKHYpOwogICAgICAgICAgICB9IGNhdGNoKGVycikgewogICAgICAgICAgICAgICAgaWYoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5uYW1lIGluIGV4Y2VwdGlvbnNUb1JldGhyb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlcnIuc3RhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIuc3RhY2spOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBIZWxwZXIgdG8gZm9ybSBkZWJ1ZyBzdHJpbmcgZm9yIHByb21pc2VzIGRlcGVuZGluZyBvbiB0aGVpcgogICAgICogY3VycmVudCBzdGF0ZQogICAgICogQHBhcmFtIG5hbWUKICAgICAqIEBwYXJhbSBpZAogICAgICogQHBhcmFtIHN0YXR1cwogICAgICogQHBhcmFtIHZhbHVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvU3RyaW5nKG5hbWUsIGlkLCBzdGF0dXMsIHZhbHVlKSB7CiAgICAgICAgdmFyIHMgPSAnW29iamVjdCAnICsgbmFtZSArICcgJyArIGlkICsgJ10gJyArIHN0YXR1czsKICAgICAgICBpZih2YWx1ZSAhPT0gcGVuZGluZykgcyArPSAnOiAnICsgdmFsdWU7CiAgICAgICAgcmV0dXJuIHM7CiAgICB9CgogICAgZnVuY3Rpb24gRigpIHt9CiAgICBmdW5jdGlvbiBiZWdldChvKSB7CiAgICAgICAgRi5wcm90b3R5cGUgPSBvOwogICAgICAgIG8gPSBuZXcgRigpOwogICAgICAgIEYucHJvdG90eXBlID0gdW5kZWY7CgogICAgICAgIHJldHVybiBvOwogICAgfQoKICAgIC8qKgogICAgICogUmVwbGFjZW1lbnQgZm9yIHdoZW4oKSB0aGF0IHNldHMgdXAgZGVidWcgbG9nZ2luZyBvbiB0aGUKICAgICAqIHJldHVybmVkIHByb21pc2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHdoZW5EZWJ1ZygpIHsKICAgICAgICByZXR1cm4gZGVidWdQcm9taXNlKHdoZW4uYXBwbHkobnVsbCwgYXJndW1lbnRzKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXBsYWNlbWVudCBmb3Igd2hlbi5kZWZlcigpIHRoYXQgc2V0cyB1cCBkZWJ1ZyBsb2dnaW5nCiAgICAgKiBvbiB0aGUgY3JlYXRlZCBEZWZlcnJlZCwgaXRzIHJlc29sdmVyLCBhbmQgaXRzIHByb21pc2UuCiAgICAgKiBAcGFyYW0gW2lkXSBhbnl0aGluZyBvcHRpb25hbCBpZGVudGlmaWVyIGZvciB0aGlzIERlZmVycmVkIHRoYXQgd2lsbCBzaG93CiAgICAgKiB1cCBpbiBkZWJ1ZyBvdXRwdXQKICAgICAqIEByZXR1cm4ge0RlZmVycmVkfSBhIERlZmVycmVkIHdpdGggZGVidWcgbG9nZ2luZwogICAgICovCiAgICBmdW5jdGlvbiBkZWZlckRlYnVnKCkgewogICAgICAgIHZhciBkLCBzdGF0dXMsIHZhbHVlLCBvcmlnUmVzb2x2ZSwgb3JpZ1JlamVjdCwgb3JpZ1RoZW4sIGlkOwoKICAgICAgICAvLyBEZWxlZ2F0ZSB0byBjcmVhdGUgYSBEZWZlcnJlZDsKICAgICAgICBkID0gd2hlbi5kZWZlcigpOwoKICAgICAgICBzdGF0dXMgPSAncGVuZGluZyc7CiAgICAgICAgdmFsdWUgPSBwZW5kaW5nOwoKICAgICAgICAvLyBpZiBubyBpZCBwcm92aWRlZCwgZ2VuZXJhdGUgb25lLiAgTm90IHN1cmUgaWYgdGhpcyBpcwogICAgICAgIC8vIHVzZWZ1bCBvciBub3QuCiAgICAgICAgaWQgPSBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdOwogICAgICAgIGlmKGlkID09PSB1bmRlZikgaWQgPSArK3Byb21pc2VJZDsKCiAgICAgICAgLy8gUHJvbWlzZSBhbmQgcmVzb2x2ZXIgYXJlIGZyb3plbiwgc28gaGF2ZSB0byBkZWxlZ2F0ZQogICAgICAgIC8vIGluIG9yZGVyIHRvIHNldHVwIHRvU3RyaW5nKCkgb24gcHJvbWlzZSwgcmVzb2x2ZXIsCiAgICAgICAgLy8gYW5kIGRlZmVycmVkCiAgICAgICAgZC5wcm9taXNlID0gYmVnZXQoZC5wcm9taXNlKTsKICAgICAgICBkLnByb21pc2UudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRvU3RyaW5nKCdQcm9taXNlJywgaWQsIHN0YXR1cywgdmFsdWUpOwogICAgICAgIH07CgogICAgICAgIGQucmVzb2x2ZXIgPSBiZWdldChkLnJlc29sdmVyKTsKICAgICAgICBkLnJlc29sdmVyLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0b1N0cmluZygnUmVzb2x2ZXInLCBpZCwgc3RhdHVzLCB2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgb3JpZ1Jlc29sdmUgPSBkLnJlc29sdmVyLnJlc29sdmU7CiAgICAgICAgZC5yZXNvbHZlID0gZC5yZXNvbHZlci5yZXNvbHZlID0gZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHZhbHVlID0gdmFsOwogICAgICAgICAgICBzdGF0dXMgPSAncmVzb2x2aW5nJzsKLy8gICAgICAgICAgICBjb25zb2xlLmxvZyhkLnJlc29sdmVyLnRvU3RyaW5nKCkpOwogICAgICAgICAgICByZXR1cm4gb3JpZ1Jlc29sdmUuYXBwbHkodW5kZWYsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKCiAgICAgICAgb3JpZ1JlamVjdCA9IGQucmVzb2x2ZXIucmVqZWN0OwogICAgICAgIGQucmVqZWN0ID0gZC5yZXNvbHZlci5yZWplY3QgPSBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgdmFsdWUgPSBlcnI7CiAgICAgICAgICAgIHN0YXR1cyA9ICdSRUpFQ1RJTkcnOwovLyAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZC5yZXNvbHZlci50b1N0cmluZygpKTsKICAgICAgICAgICAgcmV0dXJuIG9yaWdSZWplY3QuYXBwbHkodW5kZWYsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKCiAgICAgICAgZC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdG9TdHJpbmcoJ0RlZmVycmVkJywgaWQsIHN0YXR1cywgdmFsdWUpOwogICAgICAgIH07CgogICAgICAgIC8vIFNldHVwIGZpbmFsIHN0YXRlIGNoYW5nZSBoYW5kbGVycwogICAgICAgIGQudGhlbigKICAgICAgICAgICAgZnVuY3Rpb24odikgeyBzdGF0dXMgPSAncmVzb2x2ZWQnOyByZXR1cm4gdjsgfSwKICAgICAgICAgICAgZnVuY3Rpb24oZSkgeyBzdGF0dXMgPSAnUkVKRUNURUQnOyB0aHJvdyBlOyB9CiAgICAgICAgKTsKCiAgICAgICAgLy8gRXhwZXJpbWVudGluZyB3aXRoIHNldHRpbmcgdXAgd2F5cyB0byBhbHNvIGRlYnVnIHByb21pc2VzIHJldHVybmVkCiAgICAgICAgLy8gYnkgLnRoZW4oKS4gIEFsc28gbmVlZCB0byBmaW5kIGEgd2F5IHRvIGV4dGVuZCB0aGUgaWQgaW4gYSB3YXkgdGhhdAogICAgICAgIC8vIG1ha2VzIGl0IG9idmlvdXMgdGhlIHJldHVybmVkIHByb21pc2UgaXMgTk9UIHRoZSBvcmlnaW5hbCwgYnV0IGlzCiAgICAgICAgLy8gcmVsYXRlZCB0byBpdC0taXQncyBkb3duc3RyZWFtIGluIHRoZSBwcm9taXNlIGNoYWluLgogICAgICAgIG9yaWdUaGVuID0gZC5wcm9taXNlLnRoZW47CiAgICAgICAgZC50aGVuID0gZC5wcm9taXNlLnRoZW4gPSBmdW5jdGlvbihjYiwgZWIsIHBiKSB7CiAgICAgICAgICAgIHZhciBhcmdzLCBwLCBpZDsKCiAgICAgICAgICAgIGlkID0gZC5pZCArICcrJzsKCiAgICAgICAgICAgIGFyZ3MgPSBbXTsKCiAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPiAwKSBhcmdzWzBdID0gd3JhcENhbGxiYWNrKGNiLCBpZCk7CiAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPiAxKSBhcmdzWzFdID0gd3JhcENhbGxiYWNrKGViLCBpZCk7CiAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPiAyKSBhcmdzWzJdID0gd3JhcENhbGxiYWNrKHBiLCBpZCk7CgogICAgICAgICAgICB2YXIgcCA9IG9yaWdUaGVuLmFwcGx5KG51bGwsIGFyZ3MpOwoKICAgICAgICAgICAgcC5pZCA9IGlkOwogICAgICAgICAgICBwID0gYmVnZXQocCk7CiAgICAgICAgICAgIHAudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b1N0cmluZygnUHJvbWlzZScsIHAuaWQsIHN0YXR1cywgdmFsdWUpOwogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2VlIGJlbG93LiBOb3Qgc3VyZSBpZiBkZWJ1ZyBwcm9taXNlcyBzaG91bGQgYmUgZnJvemVuCiAgICAgICAgICAgIHJldHVybiBmcmVlemUocCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gQWRkIGFuIGlkIHRvIGFsbCBkaXJlY3RseSBjcmVhdGVkIHByb21pc2VzLiAgSXQnZCBiZSBncmVhdAogICAgICAgIC8vIHRvIGZpbmQgYSB3YXkgdG8gcHJvcGFnYXRlIHRoaXMgaWQgdG8gcHJvbWlzZSBjcmVhdGVkIGJ5IC50aGVuKCkKICAgICAgICBkLmlkID0gZC5wcm9taXNlLmlkID0gZC5yZXNvbHZlci5pZCA9IGlkOwoKICAgICAgICAvLyBBdHRhY2ggZGVidWcgaGFuZGxlcnMgYWZ0ZXIgdGhlIHN1YnN0aXR1dGUgcHJvbWlzZQogICAgICAgIC8vIGhhcyBiZWVuIHNldHVwLCBzbyB0aGUgaWQgY2FuIGJlIGxvZ2dlZC4KICAgICAgICBkZWJ1Z1Byb21pc2UoZC5wcm9taXNlKTsKCiAgICAgICAgLy8gVE9ETzogU2hvdWxkIHdlIHN0aWxsIGZyZWV6ZSB0aGVzZT8KICAgICAgICAvLyBTZWVtcyBzYWZlciBmb3Igbm93IHRvIGVyciBvbiB0aGUgc2lkZSBvZiBjYXV0aW9uIGFuZCBmcmVlemUgdGhlbSwKICAgICAgICAvLyBidXQgaXQgY291bGQgYmUgdXNlZnVsIHRvIGFsbCB0aGVtIHRvIGJlIG1vZGlmaWVkIGR1cmluZyBkZWJ1Z2dpbmcuCiAgICAgICAgZnJlZXplKGQucHJvbWlzZSk7CiAgICAgICAgZnJlZXplKGQucmVzb2x2ZXIpOwoKICAgICAgICByZXR1cm4gZDsKICAgIH0KCiAgICB3aGVuRGVidWcuZGVmZXIgPSBkZWZlckRlYnVnOwogICAgd2hlbkRlYnVnLmlzUHJvbWlzZSA9IHdoZW4uaXNQcm9taXNlOwoKICAgIC8vIEZvciBlYWNoIG1ldGhvZCB3ZSBoYXZlbid0IGFscmVhZHkgcmVwbGFjZWQsIHJlcGxhY2UgaXQgd2l0aAogICAgLy8gb25lIHRoYXQgc2V0cyB1cCBkZWJ1ZyBsb2dnaW5nIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlCiAgICBmb3IodmFyIHAgaW4gd2hlbikgewogICAgICAgIGlmKHdoZW4uaGFzT3duUHJvcGVydHkocCkgJiYgIShwIGluIHdoZW5EZWJ1ZykpIHsKICAgICAgICAgICAgKGZ1bmN0aW9uKHAsIG9yaWcpIHsKICAgICAgICAgICAgICAgIHdoZW5EZWJ1Z1twXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWJ1Z1Byb21pc2Uob3JpZy5hcHBseSh3aGVuLCBhcmd1bWVudHMpKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pKHAsIHdoZW5bcF0pOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gd2hlbkRlYnVnOwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJwogICAgPyBkZWZpbmUKICAgIDogZnVuY3Rpb24gKGRlcHMsIGZhY3RvcnkpIHsgdHlwZW9mIG1vZHVsZSAhPSAndW5kZWZpbmVkJwogICAgICAgID8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCiAgICAgICAgOiAodGhpcy53aGVuICAgICAgPSBmYWN0b3J5KHRoaXMud2hlbikpOwogICAgfQogICAgLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogYXBwbHkuanMKICogSGVscGVyIGZvciB1c2luZyBhcmd1bWVudHMtYmFzZWQgYW5kIHZhcmlhZGljIGNhbGxiYWNrcyB3aXRoIGFueQogKiB7QGxpbmsgUHJvbWlzZX0gdGhhdCByZXNvbHZlcyB0byBhbiBhcnJheS4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9hcHBseScsW10sZnVuY3Rpb24oKSB7CgogICAgdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKICAgIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGEgZnVuY3Rpb24gdGhhdCB0YWtlcyBpbmRpdmlkdWFsCiAgICAgKiBhcmd1bWVudHMgKGl0IGNhbiBiZSB2YXJpYWRpYywgdG9vKSwgYW5kIHJldHVybnMgYSBuZXcgZnVuY3Rpb24gdGhhdAogICAgICogdGFrZXMgYSBzaW5nbGUgYXJyYXkgYXMgaXRzIG9ubHkgcGFyYW06CiAgICAgKgogICAgICogZnVuY3Rpb24gYXJnQmFzZWQoYSwgYiwgYykgewogICAgICogICByZXR1cm4gYSArIGIgKyBjOwogICAgICogfQogICAgICoKICAgICAqIGFyZ0Jhc2VkKDEsIDIsIDMpOyAvLyA2CiAgICAgKgogICAgICogLy8gQ3JlYXRlIGFuIGFycmF5LWJhc2VkIHZlcnNpb24gb2YgYXJnQmFzZWQKICAgICAqIHZhciBhcnJheUJhc2VkID0gYXBwbHkoYXJnQmFzZWQpOwogICAgICogdmFyIGlucHV0cyA9IFsxLCAyLCAzXTsKICAgICAqCiAgICAgKiBhcnJheUJhc2VkKGlucHV0cyk7IC8vIDYKICAgICAqCiAgICAgKiBXaXRoIHByb21pc2VzOgogICAgICoKICAgICAqIHZhciBkID0gd2hlbi5kZWZlcigpOwogICAgICogZC5wcm9taXNlLnRoZW4oYXJyYXlCYXNlZCk7CiAgICAgKgogICAgICogZC5yZXNvbHZlKFsxLCAyLCAzXSk7IC8vIGFycmF5QmFzZWQgY2FsbGVkIHdpdGggYXJncyAxLCAyLCAzIC0+IDYKICAgICAqCiAgICAgKiBAcGFyYW0gZiB7RnVuY3Rpb259IGFyZ3VtZW50cy1iYXNlZCBmdW5jdGlvbgogICAgICoKICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gYSBuZXcgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGFuIGFycmF5CiAgICAgKi8KICAgIHJldHVybiBmdW5jdGlvbihmKSB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIGFycmF5IHtBcnJheX0gbXVzdCBiZSBhbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gdXNlIHRvIGFwcGx5IHRoZSBvcmlnaW5hbCBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMgdGhlIHJlc3VsdCBvZiBhcHBseWluZyBmIHdpdGggdGhlIGFyZ3VtZW50cyBpbiBhcnJheS4KICAgICAgICAgKi8KICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgICAgICAgLy8gSXQgYmV0dGVyIGJlIGFuIGFycmF5CiAgICAgICAgICAgIGlmKHRvU3RyaW5nLmNhbGwoYXJyYXkpICE9ICdbb2JqZWN0IEFycmF5XScpIHRocm93IG5ldyBFcnJvcignYXBwbHkgY2FsbGVkIHdpdGggbm9uLWFycmF5IGFyZycpOwoKICAgICAgICAgICAgcmV0dXJuIGYuYXBwbHkobnVsbCwgYXJyYXkpOwogICAgICAgIH0KICAgIH07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nCiAgICA/IGRlZmluZQogICAgOiBmdW5jdGlvbiAoZmFjdG9yeSkgeyB0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnCiAgICAgICAgPyAobW9kdWxlLmV4cG9ydHMgID0gZmFjdG9yeSgpKQogICAgICAgIDogKHRoaXMud2hlbl9hcHBseSA9IGZhY3RvcnkoKSk7CiAgICB9CiAgICAvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCgoKLyoqIEBsaWNlbnNlIE1JVCBMaWNlbnNlIChjKSBjb3B5cmlnaHQgQiBDYXZhbGllciAmIEogSGFubiAqLwoKLyoqCiAqIGRlbGF5LmpzCiAqCiAqIEhlbHBlciB0aGF0IHJldHVybnMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgYWZ0ZXIgYSBkZWxheS4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCgooZnVuY3Rpb24oZGVmaW5lKSB7CmRlZmluZSgnd2hlbi9kZWxheScsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKICAgIHZhciB1bmRlZjsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgcHJvbWlzZSB0aGF0IHdpbGwgcmVzb2x2ZSBhZnRlciBhIG1zZWMgZGVsYXkuICBJZiBwcm9taXNlCiAgICAgKiBpcyBzdXBwbGllZCwgdGhlIGRlbGF5IHdpbGwgc3RhcnQgKmFmdGVyKiB0aGUgc3VwcGxpZWQgcHJvbWlzZSBpcyByZXNvbHZlZC4KICAgICAqCiAgICAgKiBVc2FnZToKICAgICAqIC8vIERvIHNvbWV0aGluZyBhZnRlciAxIHNlY29uZCwgc2ltaWxhciB0byB1c2luZyBzZXRUaW1lb3V0CiAgICAgKiBkZWxheSgxMDAwKS50aGVuKGRvU29tZXRoaW5nKTsKICAgICAqIC8vIG9yCiAgICAgKiB3aGVuKGRlbGF5KDEwMDApLCBkb1NvbWV0aGluZyk7CiAgICAgKgogICAgICogLy8gRG8gc29tZXRoaW5nIDEgc2Vjb25kIGFmdGVyIHRyaWdnZXJpbmdQcm9taXNlIHJlc29sdmVzCiAgICAgKiBkZWxheSh0cmlnZ2VyaW5nUHJvbWlzZSwgMTAwMCkudGhlbihkb1NvbWV0aGluZywgaGFuZGxlUmVqZWN0aW9uKTsKICAgICAqIC8vIG9yCiAgICAgKiB3aGVuKGRlbGF5KHRyaWdnZXJpbmdQcm9taXNlLCAxMDAwKSwgZG9Tb21ldGhpbmcsIGhhbmRsZVJlamVjdGlvbik7CiAgICAgKgogICAgICogQHBhcmFtIFtwcm9taXNlXSBhbnl0aGluZyAtIGFueSBwcm9taXNlIG9yIHZhbHVlIGFmdGVyIHdoaWNoIHRoZSBkZWxheSB3aWxsIHN0YXJ0CiAgICAgKiBAcGFyYW0gbXNlYyB7TnVtYmVyfSBkZWxheSBpbiBtaWxsaXNlY29uZHMKICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uIGRlbGF5KHByb21pc2UsIG1zZWMpIHsKICAgICAgICBpZihhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgICAgICAgICBtc2VjID0gcHJvbWlzZSA+Pj4gMDsKICAgICAgICAgICAgcHJvbWlzZSA9IHVuZGVmOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHdoZW4ocHJvbWlzZSwgZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUodmFsKTsKICAgICAgICAgICAgfSwgbXNlYyk7CiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogICAgICAgIH0pOwogICAgfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKICAgID8gZGVmaW5lCiAgICA6IGZ1bmN0aW9uIChkZXBzLCBmYWN0b3J5KSB7IHR5cGVvZiBtb2R1bGUgIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnLi93aGVuJykpKQogICAgICAgIDogKHRoaXMud2hlbl9kZWxheSA9IGZhY3RvcnkodGhpcy53aGVuKSk7CiAgICB9CiAgICAvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCgoKLyoqIEBsaWNlbnNlIE1JVCBMaWNlbnNlIChjKSBjb3B5cmlnaHQgQiBDYXZhbGllciAmIEogSGFubiAqLwoKLyoqCiAqIHRpbWVvdXQuanMKICoKICogSGVscGVyIHRoYXQgcmV0dXJucyBhIHByb21pc2UgdGhhdCByZWplY3RzIGFmdGVyIGEgc3BlY2lmaWVkIHRpbWVvdXQsCiAqIGlmIG5vdCBleHBsaWNpdGx5IHJlc29sdmVkIG9yIHJlamVjdGVkIGJlZm9yZSB0aGF0LgogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL3RpbWVvdXQnLFsnLi93aGVuJ10sIGZ1bmN0aW9uKHdoZW4pIHsKCiAgICB2YXIgdW5kZWY7CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgbmV3IHByb21pc2UgdGhhdCB3aWxsIGF1dG9tYXRpY2FsbHkgcmVqZWN0IGFmdGVyIG1zZWMgaWYKICAgICAqIHRoZSBzdXBwbGllZCBwcm9taXNlIGRvZXNuJ3QgcmVzb2x2ZSBvciByZWplY3QgYmVmb3JlIHRoYXQuCiAgICAgKgogICAgICogVXNhZ2U6CiAgICAgKgogICAgICogdmFyIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgKiAvLyBTZXR1cCBkIGhvd2V2ZXIgeW91IG5lZWQKICAgICAqCiAgICAgKiAvLyByZXR1cm4gYSBuZXcgcHJvbWlzZSB0aGF0IHdpbGwgdGltZW91dCBpZiB3ZSBkb24ndCByZXNvbHZlL3JlamVjdCBmaXJzdAogICAgICogcmV0dXJuIHRpbWVvdXQoZCwgMTAwMCk7CiAgICAgKgogICAgICogQHBhcmFtIHByb21pc2UgYW55dGhpbmcgLSBhbnkgcHJvbWlzZSBvciB2YWx1ZSB0aGF0IHNob3VsZCB0cmlnZ2VyCiAgICAgKiAgdGhlIHJldHVybmVkIHByb21pc2UgdG8gcmVzb2x2ZSBvciByZWplY3QgYmVmb3JlIHRoZSBtc2VjIHRpbWVvdXQKICAgICAqIEBwYXJhbSBtc2VjIHtOdW1iZXJ9IHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzCiAgICAgKgogICAgICogQHJldHVybnMge1Byb21pc2V9CiAgICAgKi8KICAgIHJldHVybiBmdW5jdGlvbiB0aW1lb3V0KHByb21pc2UsIG1zZWMpIHsKICAgICAgICB2YXIgZGVmZXJyZWQsIHRpbWVvdXQ7CgogICAgICAgIGRlZmVycmVkID0gd2hlbi5kZWZlcigpOwoKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiBvblRpbWVvdXQoKSB7CiAgICAgICAgICAgIHRpbWVvdXQgJiYgZGVmZXJyZWQucmVqZWN0KG5ldyBFcnJvcigndGltZWQgb3V0JykpOwogICAgICAgIH0sIG1zZWMpOwoKICAgICAgICBmdW5jdGlvbiBjYW5jZWxUaW1lb3V0KCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgICAgIHRpbWVvdXQgPSB1bmRlZjsKICAgICAgICB9CgogICAgICAgIHdoZW4ocHJvbWlzZSwgZGVmZXJyZWQucmVzb2x2ZSwgZGVmZXJyZWQucmVqZWN0KTsKCiAgICAgICAgcmV0dXJuIGRlZmVycmVkLnRoZW4oCiAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjYW5jZWxUaW1lb3V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICAgICAgY2FuY2VsVGltZW91dCgpOwogICAgICAgICAgICAgICAgdGhyb3cgcmVhc29uOwogICAgICAgICAgICB9CiAgICAgICAgKTsKICAgIH07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nCiAgICA/IGRlZmluZQogICAgOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnCiAgICAgICAgPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJy4vd2hlbicpKSkKICAgICAgICA6ICh0aGlzLndoZW5fdGltZW91dCA9IGZhY3RvcnkodGhpcy53aGVuKSk7CiAgICB9CiAgICAvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCgoKZGVmaW5lKCd0aHJ1c3QvdXRpbC93aGVuJyxbJ3doZW4vZGVidWcnLCAnd2hlbi9hcHBseScsICd3aGVuL2RlbGF5JywgJ3doZW4vdGltZW91dCcsICd0aHJ1c3QvdXRpbC9hcnJheSddLApmdW5jdGlvbiAod2hlbiwgYXBwbHksIGRlbGF5LCB0aW1lb3V0LCB1dGlsKQp7CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LXV0aWwtd2hlbgogICAgKiovCgogICAgLyoqCiAgICB3aGVuLmFwcGx5LCB1c2VkIHRvIGFwcGx5IHdoZW4gcmVzdWx0cyBvdmVyIGEgZnVuY3Rpb24sIHNpbWlsYXIgdG8galF1ZXJ5cyBEZWZlcnJlZC4KICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHldKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHkpCgogICAgQGZvciB0aHJ1c3QtdXRpbC13aGVuCiAgICBAbWV0aG9kIHdoZW4uYXBwbHkKICAgICoqLwogICAgd2hlbi5hcHBseSA9IGFwcGx5LAogICAgLyoqCiAgICB3aGVuLmRlbGF5LCBjcmVhdGVzIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIGluIHggbXMsIHVzaW5nIHNldFRpbWVvdXQuCiAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWRlbGF5XShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWRlbGF5KQoKICAgIEBtZXRob2Qgd2hlbi5kZWxheQogICAgKiovCiAgICB3aGVuLmRlbGF5ID0gZGVsYXk7CiAgICAvKioKICAgIHdoZW4udGltZW91dCwgY3JlYXRlcyBhIHByb21pc2UgdGhhdCB3aWxsIHRpbWVvdXQgaWYgeCBtcyBpZiBub3QgcmVzb2x2ZWQuCiAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXRpbWVvdXRdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tdGltZW91dCkKCiAgICBAbWV0aG9kIHdoZW4udGltZW91dAogICAgKiovCiAgICB3aGVuLnRpbWVvdXQgPSB0aW1lb3V0OwoKICAgIHJldHVybiB7CiAgICAgICAgLyoqCiAgICAgICAgQWNjZXNzIHRvIHdoZW5qcywgdGhlIG1haW4gbGlicmFyeSBmb3IgcHJvbWlzZXMuCgogICAgICAgIEBtZXRob2Qgd2hlbgogICAgICAgICoqLwogICAgICAgIHdoZW46IHdoZW4sCiAgICAgICAgLyoqCiAgICAgICAgRmxhdHRlbiBhbmQgZmlsdGVyIGFycmF5cyBkb3duIHRvIGp1c3QgdGhlIGV4aXN0aW5nIHByb21pc2VzLgoKICAgICAgICBAbWV0aG9kIGZsYXR0ZW5Ub1Byb21pc2VzIAogICAgICAgIEBwYXJhbSB7QXJyYXl9IEFycmF5IHRvIGZsYXR0ZW4sIGFuZCBmaWx0ZXIuCiAgICAgICAgQHJldHVybnMge0FycmF5IG9mIFByb21pc2VzfSAKICAgICAgICAqKi8KICAgICAgICBmbGF0dGVuVG9Qcm9taXNlczogZnVuY3Rpb24gKGFycmF5KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHV0aWwuZmxhdHRlbihhcnJheSkuZmlsdGVyKGZ1bmN0aW9uICh4KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5pc1Byb21pc2UoeCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgfQogICAgfTsKfSk7Ci8qIQogKiBqUXVlcnkgSmF2YVNjcmlwdCBsaWIgdjEuNy4yCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBDb3B5cmlnaHQgMjAxMSwgSm9obiBSZXNpZwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICogQ29weXJpZ2h0IDIwMTEsIFRoZSBEb2pvIEZvdW5kYXRpb24KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCwgQlNELCBhbmQgR1BMIExpY2Vuc2VzLgogKgogKiBEYXRlOiBXZWQgTWFyIDIxIDEyOjQ2OjM0IDIwMTIgLTA3MDAKICovCmRlZmluZSgndGhydXN0L3V0aWwvbGliL2V4dGVuZCcsWyd0aHJ1c3QvdXRpbC9jb2xsZWN0aW9uJywgJ3RocnVzdC91dGlsL3R5cGUnXSwKZnVuY3Rpb24gKHVDb2xsZWN0aW9uLCB1VHlwZSkKewogICAgCiAgICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB2YXIgb3B0aW9ucywgbmFtZSwgc3JjLCBjb3B5LCBjb3B5SXNBcnJheSwgY2xvbmUsCiAgICAgICAgICAgIHRhcmdldCA9IGFyZ3VtZW50c1swXSB8fCB7fSwKICAgICAgICAgICAgaSAgICAgID0gMSwKICAgICAgICAgICAgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwKICAgICAgICAgICAgZGVlcCAgID0gZmFsc2U7CgogICAgICAgIC8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KICAgICAgICBpZiAodHlwZW9mIHRhcmdldCA9PT0gImJvb2xlYW4iKQogICAgICAgIHsKICAgICAgICAgICAgZGVlcCA9IHRhcmdldDsKICAgICAgICAgICAgdGFyZ2V0ID0gYXJndW1lbnRzWzFdIHx8IHt9OwogICAgICAgICAgICAvLyBza2lwIHRoZSBib29sZWFuIGFuZCB0aGUgdGFyZ2V0CiAgICAgICAgICAgIGkgPSAyOwogICAgICAgIH0KCiAgICAgICAgLy8gSGFuZGxlIGNhc2Ugd2hlbiB0YXJnZXQgaXMgYSBzdHJpbmcgb3Igc29tZXRoaW5nIChwb3NzaWJsZSBpbiBkZWVwIGNvcHkpCiAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXQgIT09ICJvYmplY3QiICYmICF1VHlwZS5pc0Z1bmN0aW9uKHRhcmdldCkpCiAgICAgICAgewogICAgICAgICAgICB0YXJnZXQgPSB7fTsKICAgICAgICB9CgogICAgICAgIC8vIGV4dGVuZCBqUXVlcnkgaXRzZWxmIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAogICAgICAgIGlmIChsZW5ndGggPT09IGkpCiAgICAgICAgewogICAgICAgICAgICB0YXJnZXQgPSB0aGlzOwogICAgICAgICAgICAtLWk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgLy8gT25seSBkZWFsIHdpdGggbm9uLW51bGwvdW5kZWZpbmVkIHZhbHVlcwogICAgICAgICAgICBpZiAoKG9wdGlvbnMgPSBhcmd1bWVudHNbaV0pICE9IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QKICAgICAgICAgICAgICAgIGZvciAobmFtZSBpbiBvcHRpb25zKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHNyYyA9IHRhcmdldFtuYW1lXTsKICAgICAgICAgICAgICAgICAgICBjb3B5ID0gb3B0aW9uc1tuYW1lXTsKCiAgICAgICAgICAgICAgICAgICAgLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcAogICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgPT09IGNvcHkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwogICAgICAgICAgICAgICAgICAgIGlmIChkZWVwICYmIGNvcHkgJiYgKHVUeXBlLmlzT2JqZWN0KGNvcHkpIHx8IChjb3B5SXNBcnJheSA9IHVUeXBlLmlzQXJyYXkoY29weSkpKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb3B5SXNBcnJheSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29weUlzQXJyYXkgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb25lID0gc3JjICYmIHVUeXBlLmlzQXJyYXkoc3JjKSA/IHNyYyA6IFtdOwoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb25lID0gc3JjICYmIHVUeXBlLmlzT2JqZWN0KHNyYykgPyBzcmMgOiB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtCiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IGV4dGVuZChkZWVwLCBjbG9uZSwgY29weSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb3B5ICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRbbmFtZV0gPSBjb3B5OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gUmV0dXJuIHRoZSBtb2RpZmllZCBvYmplY3QKICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgfTsKICAgIHJldHVybiB7CiAgICAgICAgYWx0RXh0ZW5kOiBleHRlbmQsCiAgICAgICAgZGVlcENvcHk6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQuYXBwbHkobnVsbCwgW3RydWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgfQogICAgfTsKfSk7CmRlZmluZSgndGhydXN0L3V0aWwvbGliL2NhbWVsY2FzZScsW10sZnVuY3Rpb24oKQp7CiAgICAKICAgIC8vLyA8c3VtbWFyeT4KICAgIC8vLyBJbXBvcnQgalF1ZXJ5cyBjYW1lbGNhc2UgbWV0aG9kLgogICAgLy8vIDwvc3VtbWFyeT4KICAgIC8vLyA8cmV0dXJucz48L3JldHVybnM+CiAgICB2YXIgcm1zUHJlZml4ICA9IC9eLW1zLS8sCiAgICAgICAgcmRhc2hBbHBoYSA9IC8tKFtcZGEtel0pL2dpLAogICAgICAgIGZjYW1lbENhc2UgPSBmdW5jdGlvbiAoYWxsLCBsZXR0ZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gKGxldHRlciArICIiKS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH07CgogICAgdmFyIGV4cG9ydHMgPSB7CiAgICAgICAgY2FtZWxDYXNlOiBmdW5jdGlvbiAoc3RyaW5nKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKHJtc1ByZWZpeCwgIm1zLSIpLnJlcGxhY2UocmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSk7CiAgICAgICAgfSwKICAgICAgICB1bkNhbWVsQ2FzZTogZnVuY3Rpb24gKHN0cikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvKFtBLVpdKS9nLCBmdW5jdGlvbiAoYWxsLCBzKSB7IHJldHVybiAnLScgKyBzLnRvTG93ZXJDYXNlKCk7IH0pOwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIGV4cG9ydHM7Cn0pOwpkZWZpbmUoJ3RocnVzdC91dGlsL21haW4nLFsKICAgICdsb2Rhc2gnLAogICAgLy8jcmVnaW9uIE91ciBNZXRob2RzCiAgICAnLi9hcnJheScsCiAgICAnLi9jb2xsZWN0aW9uJywKICAgICcuL2Z1bmN0aW9uJywKICAgICcuL29iamVjdCcsCiAgICAnLi90eXBlJywKICAgICcuL2d1aWQnLAogICAgJy4vdXJsJywKICAgICcuL3N0cmluZycsCiAgICAnLi93aGVuJywKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIFRoaXJkIFBhcnR5IE1ldGhvZHMKICAgICcuL2xpYi9leHRlbmQnLAogICAgJy4vbGliL2NhbWVsY2FzZScKICAgIC8vI2VuZHJlZ2lvbgpdLApmdW5jdGlvbiAoXywgdUFycmF5LCB1Q29sbGVjdGlvbiwgdUZ1bmN0aW9uLCB1T2JqZWN0LCB1VHlwZSkKewogICAgCiAgICAvKioKICAgIEBjbGFzcyB0aHJ1c3QtdXRpbAogICAgQHVzZXMgdGhydXN0LXV0aWwtYXJyYXkKICAgIEB1c2VzIHRocnVzdC11dGlsLWNvbGxlY3Rpb24KICAgIEB1c2VzIHRocnVzdC11dGlsLWZ1bmMKICAgIEB1c2VzIHRocnVzdC11dGlsLW9iagogICAgQHVzZXMgdGhydXN0LXV0aWwtdHlwZQogICAgQHVzZXMgdGhydXN0LXV0aWwtdXJsCiAgICBAdXNlcyB0aHJ1c3QtdXRpbC13aGVuCiAgICAqKi8KCiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAvLyBCcmluZyBldmVyeXRoaW5nIHRvZ2V0aGVyLgogICAgdmFyIGV4cG9ydHMgPSB1Q29sbGVjdGlvbi5leHRlbmQuYXBwbHkoewogICAgICAgIC8qKgogICAgICAgIFJlZmVyZW5jZSB0byBsb2Rhc2gKICAgICAgICBAcHJvcGVydHkgXwogICAgICAgIEB0eXBlIHtffQogICAgICAgICoqLwogICAgICAgIF86IF8sCiAgICAgICAgLyoqCiAgICAgICAgUmVmZXJlbmNlIHRvIGFycmF5IG1ldGhvZHMKICAgICAgICBAcHJvcGVydHkgYXJyYXkKICAgICAgICBAdHlwZSB7T2JqZWN0fQogICAgICAgICoqLwogICAgICAgIGFycmF5OiB1QXJyYXksCiAgICAgICAgLyoqCiAgICAgICAgUmVmZXJlbmNlIHRvIGNvbGxlY3Rpb24gbWV0aG9kcwogICAgICAgIEBwcm9wZXJ0eSBjb2xsZWN0aW9uCiAgICAgICAgQHR5cGUge09iamVjdH0KICAgICAgICAqKi8KICAgICAgICBjb2xsZWN0aW9uOiB1Q29sbGVjdGlvbiwKICAgICAgICAvKioKICAgICAgICBSZWZlcmVuY2UgdG8gZnVuY3Rpb24gbWV0aG9kcwogICAgICAgIEBwcm9wZXJ0eSBmdW5jdGlvbgogICAgICAgIEB0eXBlIHtPYmplY3R9CiAgICAgICAgKiovCiAgICAgICAgZnVuYzogdUZ1bmN0aW9uLAogICAgICAgIC8qKgogICAgICAgIFJlZmVyZW5jZSB0byBvYmplY3QgbWV0aG9kcwogICAgICAgIEBwcm9wZXJ0eSBvYmoKICAgICAgICBAdHlwZSB7T2JqZWN0fQogICAgICAgICoqLwogICAgICAgIG9iajogdU9iamVjdCwKICAgICAgICAvKioKICAgICAgICBSZWZlcmVuY2UgdG8gdHlwZSBtZXRob2RzCiAgICAgICAgQHByb3BlcnR5IHR5cGUKICAgICAgICBAdHlwZSB7T2JqZWN0fQogICAgICAgICoqLwogICAgICAgIHR5cGU6IHVUeXBlCiAgICB9LCBhcmdzKTsKICAgIHJldHVybiBleHBvcnRzOwp9KTsKZGVmaW5lKCd0aHJ1c3QvdXRpbCcsIFsndGhydXN0L3V0aWwvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgovKiEgVGhydXN0IEpTIEZyYW1ld29yayAtIHYwLjEuMCAtIDIwMTItMDgtMjkKKiB0aHJ1c3QtaG9tZQoqIENvcHlyaWdodCAoYykgMjAxMiBEYXZpZCBEcmlzY29sbDsgTGljZW5zZWQgTUlUICovCgoKZGVmaW5lKCd0aHJ1c3QvaW5zdGFuY2UnLFsndGhydXN0L3V0aWwnXSwKZnVuY3Rpb24odXRpbCkKewogICAgdmFyIHdoZW4gPSB1dGlsLndoZW47CiAgICByZXR1cm4gewogICAgICAgIC8qKgogICAgICAgIFRoZSBhdmFpbGFibGUgdGhydXN0IGluc3RhbmNlcwogICAgICAgIGluZGV4IGJ5IG5hbWUKICAgICAgICAqKi8KICAgICAgICBpbnN0YW5jZXM6IHt9LAogICAgICAgIC8qKgogICAgICAgIFRoZSBsb2FkaW5nIHRodXJzdCBpbnN0YW5jZXMuCiAgICAgICAgaW5kZXggYnkgbmFtZQogICAgICAgICoqLwogICAgICAgIGxvYWRpbmdJbnN0YW5jZXM6IHt9LAogICAgICAgIC8qKgogICAgICAgIEdldHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgIAogICAgICAgIEBtZXRob2QgZ2V0SW5zdGFuY2UKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgICAgICBAcmV0dXJucyB7VGhydXN0fSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgKiovCiAgICAgICAgZ2V0SW5zdGFuY2U6IGZ1bmN0aW9uIChuYW1lKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zdGFuY2VzW25hbWVdIHx8IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgRmV0Y2hzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAgICAgVGhpcyBsb2FkcyBhc3luY3Jvbm91c2x5LCBhcyB0aGUgaW5zdGFuY2UgbWF5IG5vdCBiZSBsb2FkZWQKICAgIAogICAgICAgIEBtZXRob2QgX19mZXRjaEluc3RhbmNlCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwcml2YXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVG8gYSB0aHJ1c3QgaW5zdGFuY2Ugc3BlYwogICAgICAgICoqLwogICAgICAgIGZldGNoSW5zdGFuY2U6IGZ1bmN0aW9uIChuYW1lKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9hZGluZ0luc3RhbmNlc1tuYW1lXSB8fCAodGhpcy5sb2FkaW5nSW5zdGFuY2VzW25hbWVdID0gd2hlbi5kZWZlcigpKTsKICAgICAgICB9CiAgICB9Owp9KTsKZGVmaW5lKCd0aHJ1c3QvY29uZmlnJyxbJy4vaW5zdGFuY2UnXSwKZnVuY3Rpb24gKHRocnVzdEluc3RhbmNlKQp7CiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAc3VibW9kdWxlIGNvbmZpZwogICAgKiovCiAgICAKCiAgICB2YXIgY29uZmlnID0gewogICAgICAgIC8qKgogICAgICAgIFRoaXMgcHJvcGVydHksIHRlbGxzIHRoZSBmcmFtZXdvcmsgaWYgaXQgc2hvdWxkIHRocm93IGVycm9ycyBvciBub3QuCiAgICAgICAgSW4gcHJvZHVjdGlvbiBpdCdzIHJlY29tbWVuZGVkIG5vdCB0byB0aHJvdyBlcnJvcnMsIHRoYXQgd2F5IGlmIGEgY29tcG9uZW50IGZhaWxzCiAgICAgICAgdGhlcmUgaXMgYSBjaGFuY2UgdGhlIGFwcGxpY2F0aW9uIGNhbiBzdGlsbCByZWNvdmVyLgoKICAgICAgICBAZm9yIGNvbmZpZwogICAgICAgIEBwcm9wZXJ0eSB0aHJvd0Vycm9ycwogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgKiovCiAgICAgICAgdGhyb3dFcnJvcnM6IHRydWUsCiAgICAgICAgLyoqCiAgICAgICAgVGVsbHMgdGhlIGZyYW1ld29yayB0byBydW4gaW4gYXN5bmMgbW9kZSwgdGhpcyBtYXkgZGVsYXkgc3RhcnQgdXAsIGJ1dCB3aWxsIG1ha2UgaW1hZ2UgbG9hZGluZyBhbmQgaW5pdGFsIHJ1bm5pbmcgYXBwZWFyIGZhc3Rlci4KCiAgICAgICAgQHByb3BlcnR5IGFzeW5jCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgQGRlZmF1bHQgdHJ1ZQogICAgICAgICoqLwogICAgICAgIGFzeW5jOiB0cnVlLAogICAgICAgIHVybDogewogICAgICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBwcm9wZXJ0eSwgZ2l2ZXMgdGhlIGZyYW1ld29yayBpdCdzIGRlZmF1bHQgcGF0aCwgaWYgZGlmZmVyZW50IHRoYW4gJy8nCiAgICAgICAgICAgIAogICAgICAgICAgICBAcHJvcGVydHkgdXJsLnBhdGgKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICAgIEBkZWZhdWx0ICIvIgogICAgICAgICAgICAqKi8KICAgICAgICAgICAgcGF0aDogJy8nLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBwcm9wZXJ0eSwgdGVsbHMgdGhlIGZyYW1ld29yayBob3cgaXQgc2hvdWxkIGVuY29kZSBhcnJheSBmb3JtIGRhdGEuCiAgICAgICAgICAgIEluIGdlbmVyYWwsIGZvciBBU1AuTkVUIGJhc2VkIGFwcGxpY2F0aW9ucywgdHJhZGl0aW9uYWwgc2hvdWxkIGJlIHRydWUuCiAgICAgICAgICAgIEZvciBSdWJ5L1B5dGhvbiBiYXNlZCBhcHBsaWNhdGlvbnMsIHRoaXMgc2hvdWxkIGJlIGZhbHNlLgogICAgICAgICAgICAKICAgICAgICAgICAgQHByb3BlcnR5IHVybC50cmFkaXRpb25hbEVuY29kaW5nCiAgICAgICAgICAgIEByZWFkT25seQogICAgICAgICAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHRyYWRpdGlvbmFsRW5jb2Rpbmc6IHRydWUKICAgICAgICB9LAogICAgICAgIGxvZzogewogICAgICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBsZW5kcyB0byB0aGUgbG9nIGxldmVsIG9mIHRocnVzdC4KCiAgICAgICAgICAgICAgICBFUlJPUjogMQogICAgICAgICAgICAgICAgV0FSTjogMgogICAgICAgICAgICAgICAgSU5GTzogMwogICAgICAgICAgICAgICAgREVCVUc6IDQKICAgICAgICAgICAgCiAgICAgICAgICAgIEBwcm9wZXJ0eSBsb2cubGV2ZWwKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICAgIEBkZWZhdWx0IDEKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGxldmVsOiA0LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyB0b2dnbGVzIGVuYWJsaW5nIG9uIG9yIG9mZi4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBwcm9wZXJ0eSBsb2cuZW5hYmxlZAogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBlbmFibGVkOiB0cnVlCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBSZXNvbHZlcyB0aGUgZ2l2ZW4gcHJvcGVydGllcyB3aGVuIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRocnVzdAoKICAgICAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAqKi8KICAgICAgICB0aHJ1c3Q6CiAgICAgICAgewogICAgICAgICAgICByZXNvbHZlOiBbJ25hbWUnXSwKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIFBsdWdpbnMgZm9yIHRocnVzdCB0byBsb2FkLCBvdmVycmlkZSB3aXRoIHlvdXIgb3duIHNldCBpZiB5b3UgaGF2ZSBhIGRpZmZlcmVudCBzZXQuCgogICAgICAgIEBwcm9wZXJ0eSBwbHVnaW5zCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0FycmF5fQogICAgICAgICoqLwogICAgICAgIHBsdWdpbnM6IFsKICAgICAgICAgICAgJ3RocnVzdC9kYXRhJywKICAgICAgICAgICAgJ3RocnVzdC9kb20nLAogICAgICAgICAgICAndGhydXN0L3RlbXBsYXRlJywKICAgICAgICAgICAgJ3RocnVzdC9zcGEnLAogICAgICAgIF0sCiAgICAgICAgLyoqCiAgICAgICAgVGhlIHNldCBvZiBtb2R1bGVzIHRvIHByZWxvYWQgd2l0aCB0aGUgaW5pdGFsIHdpcmV1cCBvZiB0aGUgVGhydXN0IGluc3RhbmNlLgoKICAgICAgICBAcHJvcGVydHkgbW9kdWxlcwogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAqKi8KICAgICAgICBtb2R1bGVzOiBbXSwKICAgICAgICAvKioKICAgICAgICBUaGUgc2V0IG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHRocnVzdC9tZWRpYXRvciBwbHVnaW4KCiAgICAgICAgQHByb3BlcnR5IG1lZGlhdG9yCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge09iamVjdH0KICAgICAgICAqKi8KICAgICAgICBtZWRpYXRvcjogewogICAgICAgICAgICAvKioKICAgICAgICAgICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luCiAgICAKICAgICAgICAgICAgQHByb3BlcnR5IHJlc29sdmUKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHJlc29sdmU6IFsnbmFtZSddLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L21lZGlhdG9yLgoKICAgICAgICAgICAgQHByb3BlcnR5IG1lZGlhdG9yLmNvbnZlbnRpb25zCiAgICAgICAgICAgIEByZWFkT25seQogICAgICAgICAgICBAdHlwZSB7QXJyYXl9CiAgICAgICAgICAgICoqLwogICAgICAgICAgICBjb252ZW50aW9uczogWwogICAgICAgICAgICAgICAgJ3RocnVzdC9tZWRpYXRvci9jb252ZW50aW9uL2NvbnRhaW5lcicsCiAgICAgICAgICAgICAgICAndGhydXN0L21lZGlhdG9yL2NvbnZlbnRpb24vc3Vic2NyaXB0aW9uJywKICAgICAgICAgICAgICAgICd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9hdXRvc3RhcnQnLAogICAgICAgICAgICAgICAgJ3RocnVzdC9tZWRpYXRvci9jb252ZW50aW9uL2RlcGVuZGFudC5tb2R1bGVzJwogICAgICAgICAgICBdCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBUaGUgc2V0IG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHRocnVzdC9kb20gcGx1Z2luCgogICAgICAgIEBwcm9wZXJ0eSBkb20KICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7T2JqZWN0fQogICAgICAgICoqLwogICAgICAgIGRvbTogewogICAgICAgICAgICAvKioKICAgICAgICAgICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luCiAgICAKICAgICAgICAgICAgQHByb3BlcnR5IHJlc29sdmUKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHJlc29sdmU6IFsnbmFtZScsICdtZWRpYXRvciddLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L2RvbS4KCiAgICAgICAgICAgIEBwcm9wZXJ0eSBkb20uY29udmVudGlvbnMKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGNvbnZlbnRpb25zOiBbCiAgICAgICAgICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2FjdGlvbicsCiAgICAgICAgICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2NvbnRleHQnLAogICAgICAgICAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9ldmVudCcKICAgICAgICAgICAgICAgIC8vJ3RocnVzdC9kb20vY29udmVudGlvbi9wYWdlLnJlYWR5JwogICAgICAgICAgICBdCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBUaGUgc2V0IG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHRocnVzdC9kYXRhIHBsdWdpbgoKICAgICAgICBAcHJvcGVydHkgZGF0YQogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtPYmplY3R9CiAgICAgICAgKiovCiAgICAgICAgZGF0YTogewogICAgICAgICAgICAvKioKICAgICAgICAgICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luCiAgICAKICAgICAgICAgICAgQHByb3BlcnR5IHJlc29sdmUKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHJlc29sdmU6IFsnbmFtZScsICdtZWRpYXRvcicsICdjZmcnXSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIERlY2lkZXMgaWYgdGhydXN0L2RhdGEgc2hvdWxkIGNhY2hlIHJlcXVlc3RzIG9yIG5vdCwgdXNlZnVsIHRvIGJlIHR1cm5lZCBmb3IgZGVidWdnaW5nLgoKICAgICAgICAgICAgQHByb3BlcnR5IGRhdGEuY2FjaGUKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICBAZGVmYXVsdCB0cnVlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBjYWNoZTogdHJ1ZSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIHN0YXJ0VGltZW91dCBpcyBhIHF1ZXVlaW5nIG1ldGhvZCBidWlsdCBpbnRvIHRocnVzdC9kYXRhLgogICAgICAgICAgICAgICAgVGhlIGNvbmNlcHQgaGVyZSBpcywgdGhhdCB0aGUgY2FsbCB0byBnZXQgZGF0YSwgZG9lc24ndCBpbW1lZGlhdGVseSBmaXJlIHRvIHRoZSBzZXJ2ZXIuCiAgICAgICAgICAgICAgICBJbnN0ZWFkIGl0IHdhaXRzIGZvciBhIHNldCBkdXJhdGlvbiwgdG8gc2VlIGlmIGFueSBvdGhlciByZXF1ZXN0cyBhcmUgbWFkZSBmcm9tIGFueSBvdGhlcgogICAgICAgICAgICAgICAgbW9kdWxlcy4gIFRoaXMgYWxsb3dzIG11bHRpcGxlIGNhbGxzIG9mZiB0byB0aGUgc2VydmVyIHRvIGJlIHN5bmNyb25pemVkLCBhbmQgaGVscHMga2VlcAogICAgICAgICAgICAgICAgVUkgY2hhbmdlcyBkb25lIGFzIHN5bmNyb251c2x5IGFzIHBvc3NpYmxlLCBnaXZpbmcgdGhlIFVJIGEgdW5pZm9ybSBiZWhhdmlvdXIuCgogICAgICAgICAgICBAcHJvcGVydHkgZGF0YS5zdGFydFRpbWVvdXQKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICAgIEBkZWZhdWx0IDUwMAogICAgICAgICAgICAqKi8KICAgICAgICAgICAgc3RhcnRUaW1lb3V0OiAxMDAsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBmaW5pc2hUaW1lb3V0IGlzIGEgcXVldWVpbmcgbWV0aG9kIGJ1aWx0IGludG8gdGhydXN0LmRhdGEKICAgICAgICAgICAgICAgIFRoZSBjb25jZXB0IGhlcmUgaXMgdG8ga2VlcCBvbiB3aXRoIHRoZSBjb25jZXB0IG9mIHN0YXJ0VGltZW91dC4gIElmIGZvciBzb21lIHJlYXNvbiwgb25lCiAgICAgICAgICAgICAgICBvZiB0aGUgaW5pdGFsIHJlcXVlc3RzIGlzIHRha2luZyB0byBsb25nIHRvIGNvbXBsZXRlLCB0aGUgcGx1Z2luIHdpbGwgYWx3YXlzIHJldHVybiB0aGUKICAgICAgICAgICAgICAgIGZpbmlzaGVkIHJlcXVlc3RzIHdpdGhpbiB0aGlzIGFtb3VudCBvZiB0aW1lLiAgVGhlIGNvbmNlcHQga2VlcHMgdGhlIGFwcGxpY2F0aW9uIHdvcmtpbmcsCiAgICAgICAgICAgICAgICBldmVuIHdoZW4gb25lIG9yIG1vcmUgY29tcG9uZW50cyBhcmUgcG90ZW50aWFsbHkgaGF2aW5nIGlzc3Vlcy4KCiAgICAgICAgICAgIEBwcm9wZXJ0eSBkYXRhLmZpbmlzaFRpbWVvdXQKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICAgIEBkZWZhdWx0IDIwMDAKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZpbmlzaFRpbWVvdXQ6IDIwMDAsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgoKICAgICAgICAgICAgQHByb3BlcnR5IGRhdGEuY29udmVudGlvbnMKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGNvbnZlbnRpb25zOiBbCiAgICAgICAgICAgICAgICAndGhydXN0L2RhdGEvY29udmVudGlvbi9zdGFydCcKICAgICAgICAgICAgXQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgVGhlIHNldCBvZiBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSB0aHJ1c3QvdGVtcGxhdGUgcGx1Z2luCgogICAgICAgIEBwcm9wZXJ0eSB0ZW1wbGF0ZQogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtPYmplY3R9CiAgICAgICAgKiovCiAgICAgICAgdGVtcGxhdGU6IHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbgogICAgCiAgICAgICAgICAgIEBwcm9wZXJ0eSByZXNvbHZlCiAgICAgICAgICAgIEByZWFkT25seQogICAgICAgICAgICBAdHlwZSB7QXJyYXl9CiAgICAgICAgICAgICoqLwogICAgICAgICAgICByZXNvbHZlOiBbJ2NmZycsICdkYXRhJ10sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgoKICAgICAgICAgICAgQHByb3BlcnR5IHRlbXBsYXRlLmNvbnZlbnRpb25zCiAgICAgICAgICAgIEByZWFkT25seQogICAgICAgICAgICBAdHlwZSB7QXJyYXl9CiAgICAgICAgICAgICoqLwogICAgICAgICAgICBjb252ZW50aW9uczogWwogICAgICAgICAgICAgICAgJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL3RlbXBsYXRlJywKICAgICAgICAgICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi9rbm9ja291dC5lbmdpbmUnCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBNYXBzIHRoZSBhdmFpbGFibGUgdGVtcGxhdGVzLCB0byB0aGVpciBhcHByb3ByaWF0ZSBtb2R1bGUgbmFtZS4KCiAgICAgICAgICAgICoqcHJlY29tcGlsZWQgaXMgYSBzcGVjaWFsIGNhc2UsIGFuZCB0aG9zZSBtZXRob2RzIGFyZSBleHBlY3RlZCB0byBiZSBjb2RlIGJ1aWx0IGZ1bmN0aW9ucy4KCiAgICAgICAgICAgIEBwcm9wZXJ0eSB0ZW1wbGF0ZS50eXBlcwogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge09iamVjdH0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHR5cGVzOiB7CiAgICAgICAgICAgICAgICAvLydrZW5kbyc6ICdwYXRoL3RvL2tlbmRvJywKICAgICAgICAgICAgICAgICdkb1QnOiAnZG9UJywKICAgICAgICAgICAgICAgICdwcmVjb21waWxlZCc6IHRydWUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIE1hcHMgdGhlIHRlbXBsYXRlIGV2YWx1YXRvcnMsIHNvIHRoYXQgd2hlbiBjcmVhdGluZyBhIHRlbXBsYXRlIGZvciBrbm9ja291dCwgaXQga25vd3MgaG93IHRvIHByb3Blcmx5IG91dHB1dCB0aGUgaW5mb3JtYXRpb24uCgogICAgICAgICAgICBAcHJvcGVydHkgdGVtcGxhdGUuZXZhbHVhdG9ycwogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge09iamVjdH0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGV2YWx1YXRvcnM6IHsKICAgICAgICAgICAgICAgIC8vJ2tlbmRvJzogeyBsZWZ0OiAnIz0nLCByaWdodDogJyMnIH0sCiAgICAgICAgICAgICAgICAnZG9UJzogeyBsZWZ0OiAne3s9ICcsIHJpZ2h0OiAnfX0nIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIFRoZSBkZWZhdWx0IHRlbXBsYXRlIHR5cGUsIHVzZWQgd2hlbiBleHRlbnNpb24gaXNuJ3QgZ2l2ZW4uCgogICAgICAgICAgICBAcHJvcGVydHkgdGVtcGxhdGUuZGVmYXVsdFR5cGUKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICAgIEBkZWZhdWx0ICdkb1QnCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBkZWZhdWx0VHlwZTogJ2RvVCcsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBUaGUgYmFzZSBsb2NhdGlvbiwgcmVsYXRpdmUgdG8gdGhlIGFwcGxpY2F0aW9uIHBhdGggZm9yIHRlbXBsYXRlIGxvY2F0aW9uLgogICAgICAgICAgICBJZiB0ZW1wbGF0ZSBwYXRocyBhcmUgZ2l2ZW4gcmVsYXRpdmUgdG8gYXBwbGljYXRpb24gcGF0aCwgdGhpcyBjYW4gYmUgbGVmdCBlbXB0eS4KCiAgICAgICAgICAgIEBwcm9wZXJ0eSB0ZW1wbGF0ZS5iYXNlVXJsCiAgICAgICAgICAgIEByZWFkT25seQogICAgICAgICAgICBAdHlwZSB7U3RyaW5nfQogICAgICAgICAgICBAZGVmYXVsdCAnJwogICAgICAgICAgICAqKi8KICAgICAgICAgICAgYmFzZVVybDogJycsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBEZWZpbmVzIHRoZSBleHRlbnNpb24gdXNlZCBmb3IgdGVtcGxhdGVzIHN0b3JlZCBvbiB0aGUgc2VydmVyLgoKICAgICAgICAgICAgQHByb3BlcnR5IHRlbXBsYXRlLmV4dGVuc2lvbgogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge1N0cmluZ30KICAgICAgICAgICAgQGRlZmF1bHQgJy50bXBsJwogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZXh0ZW5zaW9uOiAnLnRtcGwnCiAgICAgICAgfSwKICAgICAgICBzcGE6IHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbgogICAgCiAgICAgICAgICAgIEBwcm9wZXJ0eSByZXNvbHZlCiAgICAgICAgICAgIEByZWFkT25seQogICAgICAgICAgICBAdHlwZSB7QXJyYXl9CiAgICAgICAgICAgICoqLwogICAgICAgICAgICByZXNvbHZlOiBbJ2NmZycsICduYW1lJywgJ21lZGlhdG9yJ10sCiAgICAgICAgICAgIGNvbnZlbnRpb25zOiBbCiAgICAgICAgICAgICAgICAndGhydXN0L3NwYS9jb252ZW50aW9uL3N0YXJ0JwogICAgICAgICAgICBdLAogICAgICAgICAgICByb3V0ZXM6IHt9CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKCiAgICBIYW5kbGVzIGZldGNoaW5nIG9mIGEgY3VycmVudCBjb25maWcgZm9yIHRoZSBjdXJyZW50IHRocnVzdCBpbnN0YW5jZSwgb3IgdGhlIGNvbmZpZyBvZiB0aGUgZ2l2ZW4gcGx1Z2luLgogICAgQWRkaW5nIHRoZSA6IGNoYXJhY3RlciByZXF1ZXN0cyBhIHNwZWNpZmljIGNvbmZpZyBwbHVnaW4uCiAgICB0aHJ1c3QvY29uZmlnIWdsb2JhbCA9IHRocnVzdCFnbG9iYWw6Y29uZmlnID0gVGhydXN0IGluc3RhbmNlIGNvbmZpZyBmcm9tIHRoZSBpbnN0YW5jZSBuYW1lZCBnbG9iYWwuCgogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgY29uZmlnLmxvYWQgPSBmdW5jdGlvbiAobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKQogICAgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwKICAgICAgICAgICAgcmVhbE5hbWUgPSBwYXJ0c1swXSwKICAgICAgICAgICAgcGx1Z2luTmFtZSA9IHBhcnRzWzFdIHx8IGZhbHNlOwoKICAgICAgICB2YXIgaW5zdGFuY2VQcm9taXNlID0gdGhydXN0SW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShyZWFsTmFtZSk7CiAgICAgICAgaW5zdGFuY2VQcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcGx1Z2luID0gcGx1Z2luTmFtZSAmJiBjb250ZXh0LmNmZ1twbHVnaW5OYW1lXSB8fCBjb250ZXh0LmNvbmZpZzsKICAgICAgICAgICAgaWYgKCFwbHVnaW4pCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsdWdpbiAiJyArIHBsdWdpbk5hbWUgKyAnIiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgIicgKyByZWFsTmFtZSArICciLicpOwoKICAgICAgICAgICAgbG9hZChwbHVnaW4pOwogICAgICAgIH0pOwogICAgfTsKCiAgICByZXR1cm4gY29uZmlnOwp9KTsKZGVmaW5lKCd0aHJ1c3QvbG9nJyxbJ3RocnVzdC9jb25maWcnLCAndGhydXN0L3V0aWwnXSwKZnVuY3Rpb24gKHRDb25maWcsIHV0aWwpCnsKICAgIC8qKgogICAgICAgIEEgYmFzaWMgbG9nZ2VyIGZvciB0aGUgdGhydXN0IGZyYW1ld29yay4KICAgICAgICBEaXNhYmxlcyBkZWJ1ZyBsb2dnaW5nIHdoZW4gdGhydXN0IGlzIG5vdCBpbiBkZWJ1ZyBtb2RlLgoKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAc3VibW9kdWxlIGxvZwogICAgKiovCiAgICAKICAgIC8vIExvZyBsZXZlbHMKICAgIHZhciBMRVZFTCA9IHsKICAgICAgICBERUJVRzogNCwKICAgICAgICBJTkZPOiAzLAogICAgICAgIFdBUk46IDIsCiAgICAgICAgRVJST1I6IDEKICAgIH07CgogICAgLy8gRGVjbGFyZSBvdXIgdmFyaWFibGVzCiAgICB2YXIgY29uc29sZSAgICAgPSB3aW5kb3cuY29uc29sZSwKICAgICAgICB0aW1lcnMgICAgICA9IHt9LAogICAgICAgIGxvZyAgICAgICAgID0gKGNvbnNvbGUgJiYgY29uc29sZS5sb2cpIHx8IGZhbHNlLAogICAgICAgIHdhcm4gICAgICAgID0gKGNvbnNvbGUgJiYgY29uc29sZS53YXJuKSB8fCBmYWxzZSwKICAgICAgICBpbmZvICAgICAgICA9IChjb25zb2xlICYmIGNvbnNvbGUuaW5mbykgfHwgZmFsc2UsCiAgICAgICAgZXJyb3IgICAgICAgPSAoY29uc29sZSAmJiBjb25zb2xlLmVycm9yKSB8fCBmYWxzZSwKICAgICAgICB0aW1lICAgICAgICA9IChjb25zb2xlICYmIGNvbnNvbGUudGltZSkgfHwgZmFsc2UsCiAgICAgICAgdGltZUVuZCAgICAgPSAoY29uc29sZSAmJiBjb25zb2xlLnRpbWVFbmQpIHx8IGZhbHNlLAogICAgICAgIHNsaWNlICAgICAgID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAogICAgICAgIGNvbmZpZ0xldmVsID0gdENvbmZpZy5sb2cubGV2ZWwgfHwgTEVWRUwuRVJST1IsCiAgICAgICAgbG9nTGV2ZWwgICAgPSBMRVZFTFtjb25maWdMZXZlbF0gfHwgKHR5cGVvZiBjb25maWdMZXZlbCA9PT0gJ3N0cmluZycgJiYgTEVWRUxbY29uZmlnTGV2ZWwudG9VcHBlckNhc2UoKV0pIHx8ICh0eXBlb2YgY29uZmlnTGV2ZWwgID09PSAnbnVtYmVyJyAmJiBjb25maWdMZXZlbCkgfHwgTEVWRUwuRVJST1I7CgogICAgLy8gVmFyaW91cyBsb2dnZXJzIHRvIGhhbmRsZSBJRTgvOSBzdXBwb3J0LgogICAgdmFyIGxvZ1J1bm5lciA9IGZ1bmN0aW9uIChjb25zb2xlTWV0aG9kLCBsb2dUeXBlKQogICAgewogICAgICAgIC8vIFNob3cgbG9ncyB3aGVuIGVuYWJsZWQgb3IgaWYgdGhleSBhcmUgZXJyb3JzCiAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgaWYgKGNvbnNvbGVNZXRob2QpCiAgICAgICAgewogICAgICAgICAgICBpZiAoY29uc29sZU1ldGhvZC5hcHBseSkKICAgICAgICAgICAgICAgIGNvbnNvbGVNZXRob2QuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGNvbnNvbGVNZXRob2QoYXJncyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCFjb25zb2xlTWV0aG9kICYmIGxvZykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChsb2cuYXBwbHkpCiAgICAgICAgICAgICAgICBsb2cuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGxvZyhhcmdzKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgQSBiYXNpYyBsb2dnZXIgZm9yIHRoZSB0aHJ1c3QgZnJhbWV3b3JrLgogICAgICAgIERpc2FibGVzIGRlYnVnIGxvZ2dpbmcgd2hlbiB0aHJ1c3QgaXMgbm90IGluIGRlYnVnIG1vZGUuCgogICAgQGNsYXNzIExvZwogICAgKiovCiAgICB2YXIgTG9nID0gewogICAgICAgIC8qKgogICAgICAgIExvZ3MgYSBkZWJ1ZyB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZAogICAgICAgIAogICAgICAgIEBtZXRob2QgZGVidWcKICAgICAgICAqKi8KICAgICAgICBkZWJ1ZzogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgICAgICBpZiAoIXRDb25maWcubG9nLmVuYWJsZWQpIHJldHVybjsKICAgICAgICAgICAgaWYgKGxvZ0xldmVsID49IExFVkVMLkRFQlVHKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIGFyZ3MudW5zaGlmdChsb2cpOwoKICAgICAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnbG9nJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIExvZ3MgYSBpbmZvIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSBpbmZvIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCgogICAgICAgIEBtZXRob2QgaW5mbwogICAgICAgICoqLwogICAgICAgIGluZm86IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGxvZ2dpbmcgaXMgZGlzYWJsZWQuICBUaGlzIGlzIGFzIGNsb3NlIHRvIG5vb3AgYXMgd2UgY2FuIGdldCwgaW5jYXNlIHRoZXJlIGlzIGEgZGlyZWN0IHJlZmVyZW5jZSB0byB0aGlzIG1ldGhvZC4KICAgICAgICAgICAgaWYgKCF0Q29uZmlnLmxvZy5lbmFibGVkKSByZXR1cm47CiAgICAgICAgICAgIGlmIChsb2dMZXZlbCA+PSBMRVZFTC5JTkZPKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIGFyZ3MudW5zaGlmdChpbmZvKTsKCiAgICAgICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ2luZm8nKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgTG9ncyBhIHdhcm4gdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIHdhcm4gbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KCiAgICAgICAgQG1ldGhvZCB3YXJuCiAgICAgICAgKiovCiAgICAgICAgd2FybjogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgICAgICBpZiAoIXRDb25maWcubG9nLmVuYWJsZWQpIHJldHVybjsKICAgICAgICAgICAgaWYgKGxvZ0xldmVsID49IExFVkVMLldBUk4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgYXJncy51bnNoaWZ0KHdhcm4pOwoKICAgICAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnd2FybicpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBMb2dzIGEgZXJyb3IgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGVycm9yIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCgogICAgICAgIEBtZXRob2QgZXJyb3IKICAgICAgICAqKi8KICAgICAgICBlcnJvcjogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgICAgICBpZiAoIXRDb25maWcubG9nLmVuYWJsZWQpIHJldHVybjsKICAgICAgICAgICAgaWYgKGxvZ0xldmVsID49IExFVkVMLkVSUk9SKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIGFyZ3MudW5zaGlmdChlcnJvcik7CgogICAgICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICdlcnJvcicpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBMb2dzIGEgdGltZSB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgdGltZSBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgoKICAgICAgICBAbWV0aG9kIHRpbWUKICAgICAgICAqKi8KICAgICAgICB0aW1lOiBmdW5jdGlvbiAobWVzc2FnZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgICAgICBpZiAoIXRDb25maWcubG9nLmVuYWJsZWQpIHJldHVybjsKICAgICAgICAgICAgaWYgKGxvZ0xldmVsID49IExFVkVMLkRFQlVHKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aW1lcnNbbWVzc2FnZV0gPSB7IHN0YXJ0OiBuZXcgRGF0ZSgpLmdldFRpbWUoKSB9OwogICAgICAgICAgICAgICAgdmFyIG1zZyA9IHV0aWwuZm9ybWF0KCd7MH06IHRpbWVyIHN0YXJ0ZWQnLCBtZXNzYWdlKSwKICAgICAgICAgICAgICAgICAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgYXJncy51bnNoaWZ0KG1zZyk7CiAgICAgICAgICAgICAgICBhcmdzLnVuc2hpZnQodGltZSk7CgogICAgICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBMb2dzIGEgdGltZUVuZCB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgdGltZUVuZCBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgICAgIENhdXNlcyB0aGUgdGltZXIgdG8gZW5kLCBmb3IgdGhlIGdpdmVuIG1lc3NhZ2UuCgogICAgICAgIEBtZXRob2QgdGltZUVuZAogICAgICAgICoqLwogICAgICAgIHRpbWVFbmQ6IGZ1bmN0aW9uIChtZXNzYWdlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgICAgIGlmICghdENvbmZpZy5sb2cuZW5hYmxlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRpbWVyc1ttZXNzYWdlXS5lbmQgPSBuZXcgRGF0ZS5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICB2YXIgdGltZSA9IHRpbWVyc1ttZXNzYWdlXS5lbmQgLSB0aW1lcnNbbWVzc2FnZV0uc3RhcnQsCiAgICAgICAgICAgICAgICAgICAgbXNnID0gdXRpbC5mb3JtYXQoJ3swfTogezF9bXMnLCBtZXNzYWdlLCB0aW1lKTsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgYXJncy51bnNoaWZ0KG1zZyk7CiAgICAgICAgICAgICAgICBhcmdzLnVuc2hpZnQodGltZUVuZCk7CgogICAgICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gTG9nOwp9KTsKCmRlZmluZSgndGhydXN0L2lnbml0ZScsWydyZXF1aXJlJywgJ3RocnVzdC9jb25maWcnLCAndGhydXN0L3V0aWwnXSwKZnVuY3Rpb24ocmVxdWlyZSwgY29uZmlnLCB1dGlsKQp7CiAgICB2YXIgc2xpY2UgICAgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCiAgICAgICAgaXNBcnJheSAgPSB1dGlsLmlzQXJyYXksCiAgICAgICAgdG9BcnJheSAgPSB1dGlsLnRvQXJyYXksCiAgICAgICAgZWFjaCAgICAgPSB1dGlsLmVhY2gsCiAgICAgICAgbWFwICAgICAgPSB1dGlsLm1hcCwKICAgICAgICBhbnkgICAgICA9IHV0aWwuYW55LAogICAgICAgIGFsbCAgICAgID0gdXRpbC5hbGwsCiAgICAgICAgd2hlbiAgICAgPSB1dGlsLndoZW4sCiAgICAgICAgZXh0ZW5kICAgPSB1dGlsLmV4dGVuZCwKICAgICAgICBmbGF0dGVuICA9IHV0aWwuZmxhdHRlbiwKICAgICAgICBwbHVjayAgICA9IHV0aWwucGx1Y2ssCiAgICAgICAgaXNPYmplY3QgPSB1dGlsLmlzT2JqZWN0LAoKICAgICAgICByZWNvbmNpbGVBcnJheXMgPSBmdW5jdGlvbiAoZnJvbSwgdG8pCiAgICAgICAgewogICAgICAgICAgICBlYWNoKGZyb20sIGZ1bmN0aW9uICh4LCBpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheSh4KSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0b1tpXSA9IHRvQXJyYXkodG9baV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNPYmplY3QoeCkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmVjb25jaWxlQXJyYXlzKHgsIHRvW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAvKioKICAgIENvbnRydWN0cyBhIHdpcmUgc3BlYyBmb3IgdGhydXN0IHRvIGxhdW5jaCBmcm9tLgoKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAc3VibW9kdWxlIGlnbml0ZQogICAgKiovCiAgICByZXR1cm4gewogICAgICAgIC8qd2lyZVN0YWdlT25lOiBmdW5jdGlvbiAoc2V0dGluZ3MpCiAgICAgICAgewogICAgICAgICAgICB2YXIgbG9jYWxDb25maWcgPSB1dGlsLmRlZXBDb3B5KHt9LCBjb25maWcsIHNldHRpbmdzKTsKICAgICAgICAgICAgcmVjb25jaWxlQXJyYXlzKGNvbmZpZywgbG9jYWxDb25maWcpOwoKICAgICAgICAgICAgdmFyIG1hcEFyZ3MgPSBmdW5jdGlvbiAoYXJncykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3MubWFwKGZ1bmN0aW9uICh4KSB7IHJldHVybiB7ICRyZWY6IHggfTsgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgcHJvcGVydGllcyA9IHsKICAgICAgICAgICAgICAgICAgICBfX2NvbnZlbnRpb25zOiBbXQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNwZWMgPSB7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogbG9jYWxDb25maWcubmFtZSB8fCAnZ2xvYmFsJywKICAgICAgICAgICAgICAgICAgICBjZmc6IGxvY2FsQ29uZmlnLAogICAgICAgICAgICAgICAgICAgIHRocnVzdDogewogICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZTogJ3RocnVzdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBtYXBBcmdzKGxvY2FsQ29uZmlnLnRocnVzdC5yZXNvbHZlKQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBwbHVnaW5zOiBbXQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChsb2NhbENvbmZpZy5kZWJ1ZykKICAgICAgICAgICAgICAgIHNwZWMucGx1Z2lucy5wdXNoKHsgbW9kdWxlOiAnd2lyZS9kZWJ1ZycgfSk7CgogICAgICAgICAgICAvLyBMb2FkIGFsbCB0aGUgdGhydXN0LWpzIHBsdWdpbnMsIGRlZmluZWQgaW4gdGhlIGNvbmZpZy4KICAgICAgICAgICAgdmFyIHBsdWdpbnMgPSBsb2NhbENvbmZpZy5wbHVnaW5zOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IHBsdWdpbnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHBsdWdpbnNbaV0sCiAgICAgICAgICAgICAgICAgICAgcGx1Z2luID0gbmFtZTsKCiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHJpbmcobmFtZS5sYXN0SW5kZXhPZignLycpICsgMSk7CgogICAgICAgICAgICAgICAgdmFyIHBsdWdpblNwZWMgPSBzcGVjW25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIGNyZWF0ZTogewogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGU6IHBsdWdpbiwKICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogbWFwQXJncyhsb2NhbENvbmZpZ1tuYW1lXS5yZXNvbHZlKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllczogeyBfX2NvbnZlbnRpb25zOiBbXSB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IHsgJHJlZjogbmFtZSB9OwoKICAgICAgICAgICAgICAgIHZhciBjb252ZW50aW9ucyA9IGxvY2FsQ29uZmlnW25hbWVdLmNvbnZlbnRpb25zOwogICAgICAgICAgICAgICAgZm9yICh2YXIgeiA9IDAsIHpMZW4gPSBjb252ZW50aW9ucy5sZW5ndGg7IHogPCB6TGVuOyB6KyspCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNuYW1lID0gY29udmVudGlvbnNbel0sCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlbnRpb24gPSBjbmFtZTsKICAgICAgICAgICAgICAgICAgICBjbmFtZSA9IG5hbWUgKyAnLWNvbnZlbnRpb24tJyArIGNuYW1lLnN1YnN0cmluZyhjbmFtZS5sYXN0SW5kZXhPZignLycpICsgMSk7CgogICAgICAgICAgICAgICAgICAgIHNwZWNbY25hbWVdID0geyBjcmVhdGU6IGNvbnZlbnRpb24gfTsKICAgICAgICAgICAgICAgICAgICBwbHVnaW5TcGVjLnByb3BlcnRpZXMuX19jb252ZW50aW9ucy5wdXNoKHsgJHJlZjogY25hbWUgfSk7CiAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllcy5fX2NvbnZlbnRpb25zLnB1c2goeyAkcmVmOiBjbmFtZSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHNwZWM7CiAgICAgICAgfSwKICAgICAgICB3aXJlU3RhZ2VUd286IGZ1bmN0aW9uIChzZXR0aW5ncykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBsb2NhbENvbmZpZyA9IHV0aWwuZGVlcENvcHkoe30sIGNvbmZpZywgc2V0dGluZ3MpOwogICAgICAgICAgICByZWNvbmNpbGVBcnJheXMoY29uZmlnLCBsb2NhbENvbmZpZyk7CgogICAgICAgICAgICB2YXIgY2hpbGRTcGVjID0ge307CgogICAgICAgICAgICB2YXIgbW9kdWxlcyA9IGxvY2FsQ29uZmlnLm1vZHVsZXM7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbW9kdWxlcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBtb2R1bGUgPSBtb2R1bGVzW2ldLAogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBtb2R1bGVzW2ldOwoKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVTcGVjID0gY2hpbGRTcGVjW25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIGNyZWF0ZTogewogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGU6ICd0aHJ1c3QvbW9kdWxlJywKICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogW3sgJHJlZjogbW9kdWxlIH0sIHsgY3JlYXRlOiBtb2R1bGUgfSwgbmFtZV0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGluaXQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhydXN0Q3JlYXRlOiBbeyAkcmVmOiAndGhydXN0JyB9XQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBjaGlsZFNwZWM7CiAgICAgICAgfSwqLwogICAgICAgIC8qKgogICAgICAgIENyZWF0ZXMgYSB0aHJ1c3QgaW5zdGFuY2UsIGZyb20gdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIEluY2x1ZGluZyB0aGUgcGx1Z2lucywgYW5kIGdpdmVuIGRlZmF1bHQgbW9kdWxlcy4KCiAgICAgICAgQG1ldGhvZCBzdGF0ZU9uZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGludHMgdG8gcGFzcyBvbnRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UgYmVpbmcgY3JlYXRlZC4KICAgICAgICAqKi8KICAgICAgICBzdGFnZU9uZTogZnVuY3Rpb24gKHNldHRpbmdzKQogICAgICAgIHsKICAgICAgICAgICAgLy8gR2V0IHRoZSBjb25maWd1cmF0aW9uCiAgICAgICAgICAgIHZhciBsb2NhbENvbmZpZyA9IHV0aWwuZGVlcENvcHkoe30sIGNvbmZpZywgc2V0dGluZ3MpLAogICAgICAgICAgICAgICAgZGVmZXIgICAgICAgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIC8vIFJlY29uaWNsZSB0aGUgYXJyYXlzIHNvIHRoZXkgYXJlIHByb3Blcmx5IGFycmF5cwogICAgICAgICAgICByZWNvbmNpbGVBcnJheXMoY29uZmlnLCBsb2NhbENvbmZpZyk7CgogICAgICAgICAgICAvLyBNZWRpYXRvciBpcyBhIHJlcXVpcmVkIHBsdWdpbiwgaW5jbHVkZSBhbGwgdGhlIG90aGVycyBpbiBhZGRpdGlvbiB0byBpdC4KICAgICAgICAgICAgdmFyIHBsdWdpbnMgPSBbJ3RocnVzdC9tZWRpYXRvciddLmNvbmNhdChsb2NhbENvbmZpZy5wbHVnaW5zIHx8IFtdKSwKICAgICAgICAgICAgICAgIC8vIFRoZSBtb2R1bGVzIHRvIGxvYWQKICAgICAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQgPSBbXSwKICAgICAgICAgICAgICAgIC8vIFRoZSBtb2R1bGUgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgIG1vZHVsZXNDb25maWd1cmF0aW9ucyA9IHsgdGhydXN0OiAndGhydXN0JyB9OwoKICAgICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGx1Z2lucywgY3JlYXRpbmcgYSBwcm9wZXIgZGVwZW5kYW5jeSBsaXN0LgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IHBsdWdpbnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcGx1Z2luID0gcGx1Z2luc1tpXSwKICAgICAgICAgICAgICAgICAgICBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLAogICAgICAgICAgICAgICAgICAgIHBsdWdpbkNvbmZpZyA9IGxvY2FsQ29uZmlnW25hbWVdOwoKICAgICAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaChwbHVnaW4pOwogICAgICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoKHBsdWdpbkNvbmZpZy5jb252ZW50aW9ucyB8fCBbXSk7CiAgICAgICAgICAgICAgICBtb2R1bGVzQ29uZmlndXJhdGlvbnNbcGx1Z2luXSA9IHBsdWdpbkNvbmZpZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTmFtZSBhbmQgY2ZnIGFyZSBkZWZhdWx0IHByb3BlcnRpZXMgb2YgdGhlIGNvbmZpZ3VyYXRpb24gY29udGV4dAogICAgICAgICAgICB2YXIgb3JkZXJlZFBsdWdpbnMgPSBbJ25hbWUnLCAnY2ZnJ10sCiAgICAgICAgICAgICAgICAvLyBXZSBsb29wIHRocm91Z2ggdW50aWwgYWxsIHRoZSBwbHVnaW5zIGFyZSBpbiBwcm9wZXIgb3JkZXIuCiAgICAgICAgICAgICAgICByZWxvb3AgPSB0cnVlLAogICAgICAgICAgICAgICAgaUxlbiA9IG1vZHVsZXNUb0xvYWQubGVuZ3RoLAogICAgICAgICAgICAgICAgaSA9IDA7CgogICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBwbHVnaW5zIHVudGlsIHdlIGhhdmUgYSBzZXQgdGhhdCB3aWxsIGxvYWQgaW4gcHJvcGVyIG9yZGVyLgogICAgICAgICAgICB3aGlsZSAoaSA8IGlMZW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBwbHVnaW4KICAgICAgICAgICAgICAgIHZhciBwbHVnaW4gPSBtb2R1bGVzVG9Mb2FkW2ldLAogICAgICAgICAgICAgICAgICAgIC8vIFRoZSBpbXBsaWVkIHBsdWdpbiBuYW1lCiAgICAgICAgICAgICAgICAgICAgbmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxKSwKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgcGx1Z2lucyBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgcGx1Z2luQ29uZmlnID0gbG9jYWxDb25maWdbbmFtZV07CgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHBsdWdpbiBoYXMgdG8gcmVzb2x2ZSBhbnl0aGluZy4KICAgICAgICAgICAgICAgIGlmIChwbHVnaW5Db25maWcucmVzb2x2ZSAmJiBwbHVnaW5Db25maWcucmVzb2x2ZS5sZW5ndGggPiAwICYmICFhbGwocGx1Z2luQ29uZmlnLnJlc29sdmUsCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKHgpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYW55KG9yZGVyZWRQbHVnaW5zLCBmdW5jdGlvbiAoeikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geCA9PT0geiB8fCB4ID09PSB6OwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIFRoZSBtb2R1bGVzIHRvIGxvYWQuCiAgICAgICAgICAgICAgICAgICAgLy8gQWxzbyBpbmNsdWRlcyBhbnkgY29udmVudGlvbnMuCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoLmFwcGx5KG1vZHVsZXNUb0xvYWQsIG1vZHVsZXNUb0xvYWQuc3BsaWNlKGksIDIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyByZW9yZGVyIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgICAgICAgICAgb3JkZXJlZFBsdWdpbnMucHVzaChuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGhlIG1vZHVsZXMgY29uZmlnCiAgICAgICAgICAgIHZhciBtb2R1bGVzID0gbG9jYWxDb25maWcubW9kdWxlcyB8fCBbXTsKICAgICAgICAgICAgLy8gVGhydXN0IGFuZCB0aHJ1c3QvbW9kdWxlIGFsc28gbmVlZCB0byBiZSBsb2FkZWQuCiAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaC5hcHBseShtb2R1bGVzVG9Mb2FkLCBbJ3RocnVzdCcsICd0aHJ1c3QvbW9kdWxlJ10uY29uY2F0KG1vZHVsZXMgfHwgW10pKTsKICAgICAgICAgICAgLy8gRmxhdHRlbiB0aGUgcmVzdWx0YW50IGFycmF5CiAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQgPSBmbGF0dGVuKG1vZHVsZXNUb0xvYWQpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBjb25maWd1cmF0aW9uIHNwZWMKICAgICAgICAgICAgdmFyIHNwZWMgPSB7CiAgICAgICAgICAgICAgICBuYW1lOiBsb2NhbENvbmZpZy5uYW1lIHx8ICdnbG9iYWwnLAogICAgICAgICAgICAgICAgY2ZnOiBsb2NhbENvbmZpZwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gTG9hZCBldmVyeXRoaW5nCiAgICAgICAgICAgIHJlcXVpcmUobW9kdWxlc1RvTG9hZCwgZnVuY3Rpb24gKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gR2V0IHJlYWR5IHRvIGxvb3AKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50UGx1Z2luID0gbnVsbCwgYWxsQ29udmVudGlvbnMgPSBbXTsKCiAgICAgICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBtb2R1bGVzIGJlaW5nIGxvYWRlZAogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBtb2R1bGVzVG9Mb2FkLmxlbmd0aCAtIChtb2R1bGVzLmxlbmd0aCArIDEpOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIEdldCBwbHVnaW4gYW5kIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luID0gbW9kdWxlc1RvTG9hZFtpXSwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbmZpZyA9IG1vZHVsZXNDb25maWd1cmF0aW9uc1twbHVnaW5dOwoKICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBoYXZlIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAgICBpZiAobUNvbmZpZykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvYWQgYSBuZXcgcGx1Z2luLgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luQ2xhc3MgPSBhcmd1bWVudHNbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIHBsdWdpbiBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZSBhbGwgdGhlIHJlcXVpcmVkIGl0ZW1zLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZUl0ZW1zID0gbWFwKG1Db25maWcucmVzb2x2ZSwgZnVuY3Rpb24oeCkgeyByZXR1cm4gc3BlY1t4XTsgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJbnN0YW50aWF0ZSB0aGUgcGx1Z2luCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4gPSBzcGVjW25hbWVdID0gdXRpbC5pbnN0YW50aWF0ZShwbHVnaW5DbGFzcywgcmVzb2x2ZUl0ZW1zKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2V0dXAgdGhlIGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4uX19jb252ZW50aW9ucyA9IFtdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIGFsbCB0aGUgY29udmVudGlvbnMKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChjdXJyZW50UGx1Z2luKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29udmVudGlvbiBpbnRvIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zLnB1c2goYXJndW1lbnRzW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29udmVudGlvbiBpbnRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgICAgICAgICAgICAgICAgIGFsbENvbnZlbnRpb25zLnB1c2goYXJndW1lbnRzW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVGhlIGxhc3QgY3VycmVudCBwbHVnaW4sIHdpbGwgYWx3YXlzIGJlIHRocnVzdC4KICAgICAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4uX19jb252ZW50aW9ucyA9IGFsbENvbnZlbnRpb25zOwoKICAgICAgICAgICAgICAgIC8vIEV4dGVuZCB0aHJ1c3Qgd2l0aCB0aGUgc3BlYwogICAgICAgICAgICAgICAgZXh0ZW5kKGN1cnJlbnRQbHVnaW4sIHNwZWMpOwoKICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgaW5kZXggb2YgdGhlIGdpdmVuIG1vZHVsZXMuCiAgICAgICAgICAgICAgICB2YXIgbW9kdWxlSW5kZXggPSBhcmd1bWVudHMubGVuZ3RoIC0gKG1vZHVsZXMubGVuZ3RoICsgMSksCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1vZHVsZSBjcmVhdGVyIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgTW9kdWxlID0gYXJndW1lbnRzW21vZHVsZUluZGV4XSwKICAgICAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIGRlZmluaXRpb25zCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlRGVmaW5pdGlvbnMgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgbW9kdWxlSW5kZXggKyAxKSwKICAgICAgICAgICAgICAgICAgICAvLyBBc3NpZ24gdGhydXN0CiAgICAgICAgICAgICAgICAgICAgdGhydXN0ID0gY3VycmVudFBsdWdpbjsKCiAgICAgICAgICAgICAgICAvLyBMb29wIG92ZXIgYWxsIHRoZSBtb2R1bGVzCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IG1vZHVsZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgbW9kdWxlIG5hbWUKICAgICAgICAgICAgICAgICAgICB2YXIgbW9kdWxlID0gbW9kdWxlc1tpXSwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBkZWZpbml0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluaXRpb24gPSBtb2R1bGVEZWZpbml0aW9uc1tpXTsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBpbnN0YW5jZQogICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG5ldyBNb2R1bGUodGhydXN0LCBkZWZpbml0aW9uLCBtb2R1bGUpOwogICAgICAgICAgICAgICAgICAgIC8vIEluamVjdCBpdCBpbnRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZS50aHJ1c3RDcmVhdGUodGhydXN0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHNwZWMpOwogICAgICAgICAgICB9LCBkZWZlci5yZWplY3QpOwoKICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgfQogICAgfTsKfSk7CjsoZnVuY3Rpb24oZyl7CgogICAgLy8gc3VtbWFyeTogQSBzaW1wbGUgZmVhdHVyZSBkZXRlY3Rpb24gZnVuY3Rpb24vZnJhbWV3b3JrLgogICAgLy8KICAgIC8vIG5hbWU6IFN0cmluZwogICAgLy8gICAgICBUaGUgbmFtZSBvZiB0aGUgZmVhdHVyZSB0byBkZXRlY3QsIGFzIGRlZmluZWQgYnkgdGhlIG92ZXJhbGwgYGhhc2AgdGVzdHMuCiAgICAvLyAgICAgIFRlc3RzIGNhbiBiZSByZWdpc3RlcmVkIHZpYSBgaGFzLmFkZCh0ZXN0bmFtZSwgdGVzdGZ1bmN0aW9uKWAuCiAgICAvLwogICAgLy8gZXhhbXBsZToKICAgIC8vICAgICAgbXlsaWJyYXJ5LmJpbmQgPSBoYXMoIm5hdGl2ZS1iaW5kIikgPyBmdW5jdGlvbihmbiwgY29udGV4dCl7CiAgICAvLyAgICAgICAgICByZXR1cm4gZm4uYmluZChjb250ZXh0KTsKICAgIC8vICAgICAgfSA6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KXsKICAgIC8vICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgLy8gICAgICAgICAgICAgIGZuLmFwcGx5KGNvbnRleHQsIGFyZ3VtZW50cyk7CiAgICAvLyAgICAgICAgICB9CiAgICAvLyAgICAgIH0KCiAgICB2YXIgTk9OX0hPU1RfVFlQRVMgPSB7ICJib29sZWFuIjogMSwgIm51bWJlciI6IDEsICJzdHJpbmciOiAxLCAidW5kZWZpbmVkIjogMSB9LAogICAgICAgIFZFTkRPUl9QUkVGSVhFUyA9IFsiV2Via2l0IiwgIk1veiIsICJPIiwgIm1zIiwgIktodG1sIl0sCiAgICAgICAgZCA9IGlzSG9zdFR5cGUoZywgImRvY3VtZW50IikgJiYgZy5kb2N1bWVudCwKICAgICAgICBlbCA9IGQgJiYgaXNIb3N0VHlwZShkLCAiY3JlYXRlRWxlbWVudCIpICYmIGQuY3JlYXRlRWxlbWVudCgiRGlWIiksCiAgICAgICAgZnJlZUV4cG9ydHMgPSB0eXBlb2YgZXhwb3J0cyA9PSAib2JqZWN0IiAmJiBleHBvcnRzLAogICAgICAgIGZyZWVNb2R1bGUgPSB0eXBlb2YgbW9kdWxlID09ICJvYmplY3QiICYmIG1vZHVsZSwKICAgICAgICB0ZXN0Q2FjaGUgPSB7fQogICAgOwoKICAgIGZ1bmN0aW9uIGhhcygvKiBTdHJpbmcgKi9uYW1lKXsKICAgICAgICBpZih0eXBlb2YgdGVzdENhY2hlW25hbWVdID09ICJmdW5jdGlvbiIpewogICAgICAgICAgICB0ZXN0Q2FjaGVbbmFtZV0gPSB0ZXN0Q2FjaGVbbmFtZV0oZywgZCwgZWwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGVzdENhY2hlW25hbWVdOyAvLyBCb29sZWFuCiAgICB9CgogICAgZnVuY3Rpb24gYWRkKC8qIFN0cmluZyAqL25hbWUsIC8qIEZ1bmN0aW9uICovdGVzdCwgLyogQm9vbGVhbj8gKi9ub3cpewogICAgICAgIC8vIHN1bW1hcnk6IFJlZ2lzdGVyIGEgbmV3IGZlYXR1cmUgZGV0ZWN0aW9uIHRlc3QgZm9yIHNvbWUgbmFtZWQgZmVhdHVyZQogICAgICAgIC8vCiAgICAgICAgLy8gbmFtZTogU3RyaW5nCiAgICAgICAgLy8gICAgICBUaGUgbmFtZSBvZiB0aGUgZmVhdHVyZSB0byB0ZXN0LgogICAgICAgIC8vCiAgICAgICAgLy8gdGVzdDogRnVuY3Rpb24KICAgICAgICAvLyAgICAgIEEgdGVzdCBmdW5jdGlvbiB0byByZWdpc3Rlci4gSWYgYSBmdW5jdGlvbiwgcXVldWVkIGZvciB0ZXN0aW5nIHVudGlsIGFjdHVhbGx5CiAgICAgICAgLy8gICAgICBuZWVkZWQuIFRoZSB0ZXN0IGZ1bmN0aW9uIHNob3VsZCByZXR1cm4gYSBib29sZWFuIGluZGljYXRpbmcKICAgICAgICAvLyAgICAgIHRoZSBwcmVzZW5jZSBvZiBhIGZlYXR1cmUgb3IgYnVnLgogICAgICAgIC8vCiAgICAgICAgLy8gbm93OiBCb29sZWFuPwogICAgICAgIC8vICAgICAgT3B0aW9uYWwuIE9taXQgaWYgYHRlc3RgIGlzIG5vdCBhIGZ1bmN0aW9uLiBQcm92aWRlcyBhIHdheSB0byBpbW1lZGlhdGVseQogICAgICAgIC8vICAgICAgcnVuIHRoZSB0ZXN0IGFuZCBjYWNoZSB0aGUgcmVzdWx0LgogICAgICAgIC8vIGV4YW1wbGU6CiAgICAgICAgLy8gICAgICBBIHJlZHVuZGFudCB0ZXN0LCB0ZXN0Rm4gd2l0aCBpbW1lZGlhdGUgZXhlY3V0aW9uOgogICAgICAgIC8vICB8ICAgICAgIGhhcy5hZGQoImphdmFzY3JpcHQiLCBmdW5jdGlvbigpeyByZXR1cm4gdHJ1ZTsgfSwgdHJ1ZSk7CiAgICAgICAgLy8KICAgICAgICAvLyBleGFtcGxlOgogICAgICAgIC8vICAgICAgQWdhaW4gd2l0aCB0aGUgcmVkdW5kYW50bmVzcy4gWW91IGNhbiBkbyB0aGlzIGluIHlvdXIgdGVzdHMsIGJ1dCB3ZSBzaG91bGQKICAgICAgICAvLyAgICAgIG5vdCBiZSBkb2luZyB0aGlzIGluIGFueSBpbnRlcm5hbCBoYXMuanMgdGVzdHMKICAgICAgICAvLyAgfCAgICAgICBoYXMuYWRkKCJqYXZhc2NyaXB0IiwgdHJ1ZSk7CiAgICAgICAgLy8KICAgICAgICAvLyBleGFtcGxlOgogICAgICAgIC8vICAgICAgVGhyZWUgdGhpbmdzIGFyZSBwYXNzZWQgdG8gdGhlIHRlc3RGdW5jdGlvbi4gYGdsb2JhbGAsIGBkb2N1bWVudGAsIGFuZCBhIGdlbmVyaWMgZWxlbWVudAogICAgICAgIC8vICAgICAgZnJvbSB3aGljaCB0byB3b3JrIHlvdXIgdGVzdCBzaG91bGQgdGhlIG5lZWQgYXJpc2UuCiAgICAgICAgLy8gIHwgICAgICAgaGFzLmFkZCgiYnVnLWJ5aWQiLCBmdW5jdGlvbihnLCBkLCBlbCl7CiAgICAgICAgLy8gIHwgICAgICAgICAgIC8vIGcgID09IGdsb2JhbCwgdHlwaWNhbGx5IHdpbmRvdywgeWFkZGEgeWFkZGEKICAgICAgICAvLyAgfCAgICAgICAgICAgLy8gZCAgPT0gZG9jdW1lbnQgb2JqZWN0CiAgICAgICAgLy8gIHwgICAgICAgICAgIC8vIGVsID09IHRoZSBnZW5lcmljIGVsZW1lbnQuIGEgYGhhc2AgZWxlbWVudC4KICAgICAgICAvLyAgfCAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBmYWtlIHRlc3QsIGJ5aWQtd2hlbi1mb3JtLWhhcy1uYW1lLW1hdGNoaW5nLWFuLWlkIGlzIHNsaWdodGx5IGxvbmdlcgogICAgICAgIC8vICB8ICAgICAgIH0pOwogICAgICAgIHRlc3RDYWNoZVtuYW1lXSA9IG5vdyA/IHRlc3QoZywgZCwgZWwpIDogdGVzdDsKICAgIH0KCiAgICAvLyBjc3Nwcm9wIGFkYXB0ZWQgZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzU5ODAwOCAodGhhbmtzLCBecGkpCiAgICBmdW5jdGlvbiBjc3Nwcm9wKG5hbWUsIGVsKXsKICAgICAgICB2YXIgc3VwcG9ydGVkID0gZmFsc2UsCiAgICAgICAgICAgIGNhcGl0YWxpemVkID0gbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSksCiAgICAgICAgICAgIGxlbmd0aCA9IFZFTkRPUl9QUkVGSVhFUy5sZW5ndGgsCiAgICAgICAgICAgIHN0eWxlID0gZWwuc3R5bGU7CgogICAgICAgIGlmKHR5cGVvZiBzdHlsZVtuYW1lXSA9PSAic3RyaW5nIil7CiAgICAgICAgICAgIHN1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHdoaWxlKGxlbmd0aC0tKXsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBzdHlsZVtWRU5ET1JfUFJFRklYRVNbbGVuZ3RoXSArIGNhcGl0YWxpemVkXSA9PSAic3RyaW5nIil7CiAgICAgICAgICAgICAgICAgICAgc3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwcG9ydGVkOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFyRWxlbWVudChlbCl7CiAgICAgICAgaWYoZWwpewogICAgICAgICAgICB3aGlsZShlbC5sYXN0Q2hpbGQpewogICAgICAgICAgICAgICAgZWwucmVtb3ZlQ2hpbGQoZWwubGFzdENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZWw7CiAgICB9CgogICAgLy8gSG9zdCBvYmplY3RzIGNhbiByZXR1cm4gdHlwZSB2YWx1ZXMgdGhhdCBhcmUgZGlmZmVyZW50IGZyb20gdGhlaXIgYWN0dWFsCiAgICAvLyBkYXRhIHR5cGUuIFRoZSBvYmplY3RzIHdlIGFyZSBjb25jZXJuZWQgd2l0aCB1c3VhbGx5IHJldHVybiBub24tcHJpbWl0aXZlCiAgICAvLyB0eXBlcyBvZiBvYmplY3QsIGZ1bmN0aW9uLCBvciB1bmtub3duLgogICAgZnVuY3Rpb24gaXNIb3N0VHlwZShvYmplY3QsIHByb3BlcnR5KXsKICAgICAgICB2YXIgdHlwZSA9IHR5cGVvZiBvYmplY3RbcHJvcGVydHldOwogICAgICAgIHJldHVybiB0eXBlID09ICJvYmplY3QiID8gISFvYmplY3RbcHJvcGVydHldIDogIU5PTl9IT1NUX1RZUEVTW3R5cGVdOwogICAgfQoKICAgICAgICBoYXMuYWRkID0gYWRkOwogICAgaGFzLmNsZWFyRWxlbWVudCA9IGNsZWFyRWxlbWVudDsKICAgIGhhcy5jc3Nwcm9wID0gY3NzcHJvcDsKICAgIGhhcy5pc0hvc3RUeXBlID0gaXNIb3N0VHlwZTsKICAgIGhhcy5fdGVzdHMgPSB0ZXN0Q2FjaGU7CgogICAgaGFzLmFkZCgiZG9tIiwgZnVuY3Rpb24oZywgZCwgZWwpewogICAgICAgIHJldHVybiBkICYmIGVsICYmIGlzSG9zdFR5cGUoZywgImxvY2F0aW9uIikgJiYgaXNIb3N0VHlwZShkLCAiZG9jdW1lbnRFbGVtZW50IikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShkLCAiZ2V0RWxlbWVudEJ5SWQiKSAmJiBpc0hvc3RUeXBlKGQsICJnZXRFbGVtZW50c0J5TmFtZSIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZCwgImdldEVsZW1lbnRzQnlUYWdOYW1lIikgJiYgaXNIb3N0VHlwZShkLCAiY3JlYXRlQ29tbWVudCIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZCwgImNyZWF0ZUVsZW1lbnQiKSAmJiBpc0hvc3RUeXBlKGQsICJjcmVhdGVUZXh0Tm9kZSIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZWwsICJhcHBlbmRDaGlsZCIpICYmIGlzSG9zdFR5cGUoZWwsICJpbnNlcnRCZWZvcmUiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGVsLCAicmVtb3ZlQ2hpbGQiKSAmJiBpc0hvc3RUeXBlKGVsLCAiZ2V0QXR0cmlidXRlIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShlbCwgInNldEF0dHJpYnV0ZSIpICYmIGlzSG9zdFR5cGUoZWwsICJyZW1vdmVBdHRyaWJ1dGUiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGVsLCAic3R5bGUiKSAmJiB0eXBlb2YgZWwuc3R5bGUuY3NzVGV4dCA9PSAic3RyaW5nIjsKICAgIH0pOwoKICAgIC8vIFN0b3AgcmVwZWF0IGJhY2tncm91bmQtaW1hZ2UgcmVxdWVzdHMgYW5kIHJlZHVjZSBtZW1vcnkgY29uc3VtcHRpb24gaW4gSUU2IFNQMQogICAgLy8gaHR0cDovL21pc3RlcnBpeGVsLmJsb2dzcG90LmNvbS8yMDA2LzA5L2ZvcmVuc2ljLWFuYWx5c2lzLW9mLWllNi5odG1sCiAgICAvLyBodHRwOi8vYmxvZ3MubXNkbi5jb20vYi9jd2lsc28vYXJjaGl2ZS8yMDA2LzExLzA3L2llLXJlLWRvd25sb2FkaW5nLWJhY2tncm91bmQtaW1hZ2VzLmFzcHg/UGFnZUluZGV4PTEKICAgIC8vIGh0dHA6Ly9zdXBwb3J0Lm1pY3Jvc29mdC5jb20va2IvODIzNzI3CiAgICB0cnl7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwogICAgfWNhdGNoKGUpe30KCiAgICAvLyBFeHBvc2UgaGFzKCkKICAgIC8vIHNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMsIGxpa2Ugci5qcywgY2hlY2sgZm9yIHNwZWNpZmljIGNvbmRpdGlvbiBwYXR0ZXJucyBsaWtlIHRoZSBmb2xsb3dpbmc6CiAgICBpZih0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGRlZmluZS5hbWQgPT0gIm9iamVjdCIgJiYgZGVmaW5lLmFtZCl7CiAgICAgICAgZGVmaW5lKCJoYXMiLFtdLCBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gaGFzOwogICAgICAgIH0pOwogICAgfQogICAgLy8gY2hlY2sgZm9yIGBleHBvcnRzYCBhZnRlciBgZGVmaW5lYCBpbiBjYXNlIGEgYnVpbGQgb3B0aW1pemVyIGFkZHMgYW4gYGV4cG9ydHNgIG9iamVjdAogICAgZWxzZSBpZihmcmVlRXhwb3J0cyl7CiAgICAgICAgLy8gaW4gTm9kZS5qcyBvciBSaW5nb0pTIHYwLjguMCsKICAgICAgICBpZihmcmVlTW9kdWxlICYmIGZyZWVNb2R1bGUuZXhwb3J0cyA9PSBmcmVlRXhwb3J0cyl7CiAgICAgICAgICAoZnJlZU1vZHVsZS5leHBvcnRzID0gaGFzKS5oYXMgPSBoYXM7CiAgICAgICAgfQogICAgICAgIC8vIGluIE5hcndoYWwgb3IgUmluZ29KUyB2MC43LjAtCiAgICAgICAgZWxzZXsKICAgICAgICAgIGZyZWVFeHBvcnRzLmhhcyA9IGhhczsKICAgICAgICB9CiAgICB9CiAgICAvLyBpbiBhIGJyb3dzZXIgb3IgUmhpbm8KICAgIGVsc2V7CiAgICAgICAgLy8gdXNlIHNxdWFyZSBicmFja2V0IG5vdGF0aW9uIHNvIENsb3N1cmUgQ29tcGlsZXIgd29uJ3QgbXVuZ2UgYGhhc2AKICAgICAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL2Nsb3N1cmUvY29tcGlsZXIvZG9jcy9hcGktdHV0b3JpYWwzLmh0bWwjZXhwb3J0CiAgICAgICAgZ1siaGFzIl0gPSBoYXM7CiAgICB9Cn0pKHRoaXMpOwoKZGVmaW5lKCd0aHJ1c3QvbW9kdWxlJyxbJ3RocnVzdC91dGlsJywgJ3RocnVzdC9sb2cnLCAnaGFzJ10sCmZ1bmN0aW9uICh1dGlsLCBsb2csIGhhcykKewogICAgdmFyIHR5cGUgPSB1dGlsLnR5cGUsCiAgICAgICAgZm9ybWF0ID0gdXRpbC5mb3JtYXQsCiAgICAgICAgaXNPYmplY3QgPSB1dGlsLmlzT2JqZWN0LAogICAgICAgIGV4dGVuZCA9IHV0aWwuZXh0ZW5kLAogICAgICAgIHdoZW4gPSB1dGlsLndoZW4sCiAgICAgICAgdGhydXN0Q2FjaGUgPSB7fSwKICAgICAgICAvKioKICAgICAgICBNb3ZlcyBhbGwgcHJvcGVydGllcywgdGhhdCBzaG91bGQgZXhpc3Qgb3V0c2lkZSBvZiB0aGUgbW9kdWxlLCBpbnRvIGEgcHJpdmF0ZSBvYmplY3QgZm9yIGhvbGRpbmcuCgogICAgICAgIEBtZXRob2QgbW92ZVRvVGhydXN0Q2FjaGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmcm9tIE9iamVjdCB0byBleHRyYWN0IGl0ZW1zIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gdG8gT2JqZWN0IHRvIHBsYWNlIGl0ZW1zIG9uCiAgICAgICAgQHBhcmFtIHtBcnJheX0gbGlzdCBJdGVtcyB0byBtb3ZlIGZyb20gdG8gdGhlIG90aGVyIG9iamVjdAogICAgICAgICoqLwogICAgICAgIG1vdmVUb1RocnVzdENhY2hlID0gZnVuY3Rpb24gKGZyb20sIHRvLCBsaXN0KQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBsaXN0Lmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdG9bbGlzdFtpXV0gPSBmcm9tW2xpc3RbaV1dOwogICAgICAgICAgICAgICAgZGVsZXRlIGZyb21bbGlzdFtpXV07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGdldEV2ZW50TmFtZXNwYWNlID0gZnVuY3Rpb24gKG5hbWUsIHByZWZpeCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghcHJlZml4KSBwcmVmaXggPSAnbW9kdWxlLSc7IHJldHVybiAnLicgKyAobmFtZSA9PT0gJ2dsb2JhbCcgPyAnZ2xvYmFsJyA6IHByZWZpeCArIG5hbWUucmVwbGFjZSgvXC4vZywgJy0nKSk7CiAgICAgICAgfSwKICAgICAgICBfX29wdGlvbmFsTWV0aG9kcyA9IFsgICAgIC8vIE9wdGlvbmFsIG1ldGhvZHMgdGhhdCBtYXkgYmUgb24gYSBtb2R1bGUKICAgICAgICAgICAgJ3N0YXJ0JywKICAgICAgICAgICAgJ3N0b3AnLAogICAgICAgICAgICAncmVhZHknCiAgICAgICAgXTsKCiAgICAvKioKICAgIFRoZSBtb2R1bGUgaXMgdGhlIGhlYXJ0IG9mIHRoZSB0aHJ1c3QsIGV2ZXJ5IG1vZHVsZSBnZXRzIG9uZSBmYWNhZGUgcGVyIG1vZHVsZS4KCiAgICBAY2xhc3MgTW9kdWxlCiAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgIEBwYXJhbSB7T2JqZWN0fSBkZWYgVGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICBAcGFyYW0ge1N0cmluZ30gW25hbWVdIFRoZSBtb2R1bGUgbmFtZS4KICAgICoqLwogICAgdmFyIE1vZHVsZSA9IGZ1bmN0aW9uICgvKiAkcmVmICovIHRocnVzdCwgZGVmLCBuYW1lKQogICAgewogICAgICAgIG5hbWUgPSB0aGlzLm5hbWUgPSAobmFtZSB8fCBkZWYubmFtZSk7CiAgICAgICAgdmFyIG1pZCA9IHRoaXMubWlkID0gdGhydXN0Lm5hbWUgKyAnOicgKyBuYW1lOwogICAgICAgIHRoaXMuaW5zdGFuY2UgPSBleHRlbmQoZGVmLCB0aHJ1c3RDYWNoZVttaWRdICYmIHRocnVzdENhY2hlW21pZF0uaW5zdGFuY2UgfHwge30pOwogICAgICAgIHRoaXMuaW5zdGFuY2UubmFtZSA9ICh0aGlzLmluc3RhbmNlLm5hbWUgfHwgbmFtZSk7CiAgICAgICAgdGhpcy5pbnN0YW5jZS5taWQgPSBtaWQ7CgogICAgICAgIGlmICghdGhpcy5pbnN0YW5jZS5uYW1lKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FsbCBNb2R1bGVzIG11c3QgaGF2ZSBhIG5hbWUhJyk7CgogICAgICAgIC8vIE1vZHVsZXMgbXVzdCBoYXZlIGFuIGluaXQgbWV0aG9kIGFuZCBhIGRlc3Ryb3kgbWV0aG9kLCBpdCdzIHVwIHRvIHRoZSBtb2R1bGUgZGV2ZWxvcGVyIHRvIHBvcHVsYXRlIHRoZXNlIG1ldGhvZHMuCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSB0aHJ1c3QuX19yZXF1aXJlZE1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICBpZiAoIWRlZlt0aHJ1c3QuX19yZXF1aXJlZE1ldGhvZHNbaV1dKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnUmVxdWlyZWQgInswfSIgbWV0aG9kIG5vdCBmb3VuZCBvbiBtb2R1bGUgInsxfSIhJywgdGhydXN0Ll9fcmVxdWlyZWRNZXRob2RzW2ldLCBuYW1lKSk7CgogICAgICAgIC8vIElmIHRoZSBtb2R1bGUgbmFtZSBpcyB1bmRlZmluZWQsIGJyaW5nIHRoZSBuYW1lIGludG8gdGhlIG1vZHVsZS4KICAgICAgICBpZiAodHlwZW9mIGRlZi5uYW1lID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgZGVmLm5hbWUgPSBuYW1lOwoKICAgICAgICB2YXIgdGhydXN0TW9kdWxlID0gdGhydXN0Q2FjaGVbbWlkXSA9IGV4dGVuZCh0aHJ1c3RDYWNoZVttaWRdIHx8IHt9ICwgewogICAgICAgICAgICBfc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgIG5hbWU6IHV0aWwuZ2V0TW9kdWxlTmFtZUZvclBhdGgobmFtZSksCiAgICAgICAgICAgIG1vZHVsZTogdGhpcwogICAgICAgIH0pOwoKICAgICAgICB2YXIgZmFjYWRlcyA9IHRocnVzdE1vZHVsZS5mYWNhZGVzIHx8ICh0aHJ1c3RNb2R1bGUuZmFjYWRlcyA9IHt9KTsKICAgICAgICBpZiAoIXRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSkgdGhydXN0Ll9fY29udmVudGlvblBsdWNrUHJvcGVydGllc0NhY2hlID0gdXRpbC5mbGF0dGVuKHV0aWwucGx1Y2sodGhydXN0Ll9fY29udmVudGlvbnMgfHwgW10sICdwcm9wZXJ0aWVzJykpOwoKICAgICAgICAvLyBNb3ZlIGFsbCBzcGVjaWFsIHByb3BlcnRpZXMgb2ZmIHRvIHRoZSB0aHJ1c3QncyBpbnRlcm5hbCBtZXRob2QuCiAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlLCB0aHJ1c3QuX19yZXF1aXJlZE1ldGhvZHMpOwogICAgICAgIG1vdmVUb1RocnVzdENhY2hlKHRoaXMuaW5zdGFuY2UsIHRocnVzdE1vZHVsZSwgX19vcHRpb25hbE1ldGhvZHMpOwogICAgICAgIG1vdmVUb1RocnVzdENhY2hlKHRoaXMuaW5zdGFuY2UsIHRocnVzdE1vZHVsZSwgdGhydXN0Ll9fY29udmVudGlvblBsdWNrUHJvcGVydGllc0NhY2hlKTsKCiAgICAgICAgdXRpbC5zYWZlSW52b2tlKHRocnVzdCwgJ2NyZWF0ZUZhY2FkZScsIHRocnVzdCwgdGhpcy5pbnN0YW5jZSwgZmFjYWRlcyk7CgogICAgICAgIHRoaXMuX19uYW1lc3BhY2UgPSBnZXRFdmVudE5hbWVzcGFjZSh0aGlzLmluc3RhbmNlLm5hbWUpOwoKICAgICAgICB0aGlzLnRocnVzdCA9IHRocnVzdDsKICAgIH07CgogICAgdmFyIGNhbGxGYWNhZGVNZXRob2RzID0gZnVuY3Rpb24gKG1ldGhvZCwgbWlkKQogICAgewogICAgICAgIHZhciByZXN1bHRzID0gW107CiAgICAgICAgZm9yICh2YXIgaSBpbiB0aHJ1c3RDYWNoZVttaWRdLmZhY2FkZXMpCiAgICAgICAgewogICAgICAgICAgICB2YXIgbW9kdWxlQ2FjaGUgPSB0aHJ1c3RDYWNoZVttaWRdLAogICAgICAgICAgICAgICAgZmFjYWRlID0gbW9kdWxlQ2FjaGUuZmFjYWRlc1tpXTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCd0aHJ1c3QvbW9kdWxlOiBDYWxsaW5nIGZhY2FkZSAiezB9IiB7MX0oKScsIGksIG1ldGhvZCkpOwogICAgICAgICAgICBpZiAoZmFjYWRlW21ldGhvZF0gJiYgaXNPYmplY3QoZmFjYWRlKSkKICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChmYWNhZGVbbWV0aG9kXS5jYWxsKGZhY2FkZSwgdGhydXN0Q2FjaGVbbWlkXS5tb2R1bGUpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9OwoKICAgIE1vZHVsZS5wcm90b3R5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgR2V0dGVyL1NldHRlciBmb3IgY29udmVudGlvbiBtZXRob2RzLgogICAgICAgIEdldHMgdGhlIHZhbHVlIGNvbnZlbnRpb24gcHJvcGVydHkgKGRlZmluZWQgaW4gdGhlIHByb3BlcnRpZXMgYXJyYXkgb2YgYSBmYWNhZGUpLgogICAgICAgIFNldHMgdGhlIHZhbHVlIG9mIGEgY29udmVudGlvbiBwcm9wZXJ0eSAoZm9yIHN0b3JpbmcgY29udmVudGlvbiBjb25maWd1cmF0aW9uKQoKICAgICAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIGdldCBvciBzZXQKICAgICAgICBAcGFyYW0ge29iamVjdH0gW3ZhbHVlXSBUaGUgdmFsdWUgdG8gc2V0CiAgICAgICAgQG1ldGhvZCBjb252ZW50aW9uCiAgICAgICAgQHJldHVybnMge09iamVjdH0gVGhlIHZhbGF1ZS4KICAgICAgICAqKi8KICAgICAgICBjb252ZW50aW9uOiBmdW5jdGlvbiAocHJvcGVydHksIHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRocnVzdENhY2hlW3RoaXMubWlkXVtwcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhydXN0Q2FjaGVbdGhpcy5taWRdW3Byb3BlcnR5XTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIEluamVjdHMgdGhpcyBtb2R1bGUgaW50byB0aGUgZ2l2ZW4gdGhydXN0IGluc3RhbmNlLgoKICAgICAgICBAbWV0aG9kIHRocnVzdENyZWF0ZQogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICAqKi8KICAgICAgICB0aHJ1c3RDcmVhdGU6IGZ1bmN0aW9uICh0aHJ1c3QpCiAgICAgICAgewogICAgICAgICAgICB0aHJ1c3QuX19pbmplY3RNb2R1bGUodGhpcyk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBNYWtlcyBhIGNhbGwgdG8gYWxsIHRoZSBtb2R1bGVzIGZhY2FkZXMKICAgICAgICBUaGUgb3JkZXIgb2YgdGhlIGNhbGwgZGVwZW5kcyBvbiB0aGUgb3JkZXIgcmVxdWlyZWQuCiAgICAgICAgRHVyaW5nIHRoZSBzdGFydHVwIHN0YWdlIChpbml0LCBzdGFydCwgcmVhZHkpIGZhY2FkZXMgYXJlIGNhbGxlZCBmaXJzdC4KICAgICAgICBEdXJpbmcgdGhlIHNodXRkb3duIHN0YXRlIChzdG9wLCBkZXN0cm95KSBmYWNhZGVzIGFyZSBjYWxsZWQgbGFzdC4KICAgICAgICBUaGlzIGFsbG93cyBtb2R1bGVzIHRvIHN0YXJ0dXAgYW5kIHNodXRkb3duIHdpbGwgYWxsIHRoZSB0b29scyBpdCBoYWQgdG8gYmVnaW4gd2l0aC4KCiAgICAgICAgQG1ldGhvZCB0aHJ1c3RDYWxsCiAgICAgICAgQHByb3RlY3RlZAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgdGhlIG1ldGhvZCB0byBjYWxsCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBmYWNhZGVBZnRlciBjYWxscyBmYWNhZGUgbWV0aG9kcyBiZWZvcmUgb3IgYWZ0ZXIgbW9kdWxlIG1ldGhvZC4KICAgICAgICBAcGFyYW0ge0FycmF5fSBhcmdzIEFyZ3MgdG8gYmUgcGFzc2VkIG9udG8gdGhlIG1vZHVsZSBtZXRob2QuCiAgICAgICAgKiovCiAgICAgICAgdGhydXN0Q2FsbDogZnVuY3Rpb24gKG1ldGhvZCwgZmFjYWRlQWZ0ZXIsIGFyZ3MpCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCksCiAgICAgICAgICAgICAgICByZXN1bHRzLAogICAgICAgICAgICAgICAgdGhhdCA9IHRoaXM7CgogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ3RocnVzdC9tb2R1bGU6IENhbGxpbmcgZmFjYWRlcyBmb3IgInswfSInLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgdmFyIG0gPSB0aHJ1c3RDYWNoZVt0aGF0Lm1pZF1bbWV0aG9kXTsKICAgICAgICAgICAgaWYgKCFmYWNhZGVBZnRlcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzdWx0cyA9IGNhbGxGYWNhZGVNZXRob2RzKG1ldGhvZCwgdGhhdC5taWQpOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdHMpCiAgICAgICAgICAgICAgICAgICAgd2hlbi5jaGFpbih3aGVuLmFsbCh1dGlsLmZsYXR0ZW5Ub1Byb21pc2VzKHJlc3VsdHMpKSwgZGVmZXIpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoKTsKCiAgICAgICAgICAgICAgICBpZiAobSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV3RGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgZGVmZXIudGhlbihmdW5jdGlvbiAoKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG0uYXBwbHkodGhhdC5pbnN0YW5jZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGVuLmNoYWluKHdoZW4uYWxsKHV0aWwuZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0KSksIG5ld0RlZmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGVmZXIucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGRlZmVyID0gbmV3RGVmZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgbSA9IHRocnVzdENhY2hlW3RoYXQubWlkXVttZXRob2RdOwogICAgICAgICAgICAgICAgaWYgKG0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cyA9IG0uYXBwbHkodGhhdC5pbnN0YW5jZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdHMpCiAgICAgICAgICAgICAgICAgICAgICAgIHdoZW4uY2hhaW4od2hlbi5hbGwodXRpbC5mbGF0dGVuVG9Qcm9taXNlcyhyZXN1bHRzKSksIGRlZmVyKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKCk7CgogICAgICAgICAgICAgICAgdmFyIG5ld0RlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICAgICAgZGVmZXIudGhlbihmdW5jdGlvbiAoKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBjYWxsRmFjYWRlTWV0aG9kcyhtZXRob2QsIHRoYXQubWlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0KQogICAgICAgICAgICAgICAgICAgICAgICB3aGVuLmNoYWluKHdoZW4uYWxsKHV0aWwuZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0KSksIG5ld0RlZmVyKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0RlZmVyLnJlc29sdmUoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVmZXIgPSBuZXdEZWZlcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBTdGFydCB0aGUgbW9kdWxlLCBpbnNpZGUgdGhlIHRocnVzdCBjb250YWluZXIgaXQgd2FzIGNyZWF0ZWQgb24uCgogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAqKi8KICAgICAgICBzdGFydDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhhdC50aHJ1c3Quc3RhcnQodGhhdC5uYW1lKTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIFN0b3AgdGhlIG1vZHVsZSwgaW5zaWRlIHRoZSB0aHJ1c3QgY29udGFpbmVyIGl0IHdhcyBjcmVhdGVkIG9uLgoKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhhdC50aHJ1c3Quc3RvcCh0aGF0Lm5hbWUpOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCgogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIG1vZHVsZSBpbnN0YW5jZQoKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIE1vZHVsZS5sb2FkID0gZnVuY3Rpb24gKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykKICAgIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksCiAgICAgICAgICAgIGluc3RhbmNlTmFtZSA9IHBhcnRzWzBdLAogICAgICAgICAgICBtb2R1bGVOYW1lID0gcGFydHNbMV07CgogICAgICAgIHJlcXVpcmUoWyd0aHJ1c3QhJyArIGluc3RhbmNlTmFtZV0sIGZ1bmN0aW9uICh0aHJ1c3QpCiAgICAgICAgewogICAgICAgICAgICB2YXIgbW9kdWxlID0gdGhydXN0Lm1vZHVsZXNbbW9kdWxlTmFtZV07CiAgICAgICAgICAgIGlmICghbW9kdWxlKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnTW9kdWxlICJ7MH0iIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiezF9Ii4nLCBtb2R1bGVOYW1lLCBpbnN0YW5jZU5hbWUpKTsKCiAgICAgICAgICAgIGxvYWQobW9kdWxlKTsKICAgICAgICB9KTsKICAgIH07CgogICAgTW9kdWxlLnRocnVzdENhY2hlID0gdGhydXN0Q2FjaGU7CgogICAgcmV0dXJuIE1vZHVsZTsKfSk7Ci8qKgogKiBAbGljZW5zZSBSZXF1aXJlSlMgZG9tUmVhZHkgMi4wLjAgQ29weXJpZ2h0IChjKSAyMDEwLTIwMTIsIFRoZSBEb2pvIEZvdW5kYXRpb24gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICogQXZhaWxhYmxlIHZpYSB0aGUgTUlUIG9yIG5ldyBCU0QgbGljZW5zZS4KICogc2VlOiBodHRwOi8vZ2l0aHViLmNvbS9yZXF1aXJlanMvZG9tUmVhZHkgZm9yIGRldGFpbHMKICovCi8qanNsaW50ICovCi8qZ2xvYmFsIHJlcXVpcmU6IGZhbHNlLCBkZWZpbmU6IGZhbHNlLCByZXF1aXJlanM6IGZhbHNlLAogIHdpbmRvdzogZmFsc2UsIGNsZWFySW50ZXJ2YWw6IGZhbHNlLCBkb2N1bWVudDogZmFsc2UsCiAgc2VsZjogZmFsc2UsIHNldEludGVydmFsOiBmYWxzZSAqLwoKCmRlZmluZSgnZG9tUmVhZHknLFtdLGZ1bmN0aW9uICgpIHsKICAgIAoKICAgIHZhciBpc0Jyb3dzZXIgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuZG9jdW1lbnQsCiAgICAgICAgaXNQYWdlTG9hZGVkID0gIWlzQnJvd3NlciwKICAgICAgICBkb2MgPSBpc0Jyb3dzZXIgPyBkb2N1bWVudCA6IG51bGwsCiAgICAgICAgcmVhZHlDYWxscyA9IFtdLAogICAgICAgIGlzVG9wLCB0ZXN0RGl2LCBzY3JvbGxJbnRlcnZhbElkOwoKICAgIGZ1bmN0aW9uIHJ1bkNhbGxiYWNrcyhjYWxsYmFja3MpIHsKICAgICAgICB2YXIgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY2FsbGJhY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrc1tpXShkb2MpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjYWxsUmVhZHkoKSB7CiAgICAgICAgdmFyIGNhbGxiYWNrcyA9IHJlYWR5Q2FsbHM7CgogICAgICAgIGlmIChpc1BhZ2VMb2FkZWQpIHsKICAgICAgICAgICAgLy9DYWxsIHRoZSBET00gcmVhZHkgY2FsbGJhY2tzCiAgICAgICAgICAgIGlmIChjYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZWFkeUNhbGxzID0gW107CiAgICAgICAgICAgICAgICBydW5DYWxsYmFja3MoY2FsbGJhY2tzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgdGhlIHBhZ2UgYXMgbG9hZGVkLgogICAgICovCiAgICBmdW5jdGlvbiBwYWdlTG9hZGVkKCkgewogICAgICAgIGlmICghaXNQYWdlTG9hZGVkKSB7CiAgICAgICAgICAgIGlzUGFnZUxvYWRlZCA9IHRydWU7CiAgICAgICAgICAgIGlmIChzY3JvbGxJbnRlcnZhbElkKSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHNjcm9sbEludGVydmFsSWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjYWxsUmVhZHkoKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKGlzQnJvd3NlcikgewogICAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgIC8vU3RhbmRhcmRzLiBIb29yYXkhIEFzc3VtcHRpb24gaGVyZSB0aGF0IGlmIHN0YW5kYXJkcyBiYXNlZCwKICAgICAgICAgICAgLy9pdCBrbm93cyBhYm91dCBET01Db250ZW50TG9hZGVkLgogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgcGFnZUxvYWRlZCwgZmFsc2UpOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIHBhZ2VMb2FkZWQsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgaWYgKHdpbmRvdy5hdHRhY2hFdmVudCkgewogICAgICAgICAgICB3aW5kb3cuYXR0YWNoRXZlbnQoIm9ubG9hZCIsIHBhZ2VMb2FkZWQpOwoKICAgICAgICAgICAgdGVzdERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaXNUb3AgPSB3aW5kb3cuZnJhbWVFbGVtZW50ID09PSBudWxsOwogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CgogICAgICAgICAgICAvL0RPTUNvbnRlbnRMb2FkZWQgYXBwcm94aW1hdGlvbiB0aGF0IHVzZXMgYSBkb1Njcm9sbCwgYXMgZm91bmQgYnkKICAgICAgICAgICAgLy9EaWVnbyBQZXJpbmk6IGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvLAogICAgICAgICAgICAvL2J1dCBtb2RpZmllZCBieSBvdGhlciBjb250cmlidXRvcnMsIGluY2x1ZGluZyBqZGFsdG9uCiAgICAgICAgICAgIGlmICh0ZXN0RGl2LmRvU2Nyb2xsICYmIGlzVG9wICYmIHdpbmRvdy5leHRlcm5hbCkgewogICAgICAgICAgICAgICAgc2Nyb2xsSW50ZXJ2YWxJZCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB0ZXN0RGl2LmRvU2Nyb2xsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VMb2FkZWQoKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICAgICAgfSwgMzApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL0NoZWNrIGlmIGRvY3VtZW50IGFscmVhZHkgY29tcGxldGUsIGFuZCBpZiBzbywganVzdCB0cmlnZ2VyIHBhZ2UgbG9hZAogICAgICAgIC8vbGlzdGVuZXJzLiBMYXRlc3Qgd2Via2l0IGJyb3dzZXJzIGFsc28gdXNlICJpbnRlcmFjdGl2ZSIsIGFuZAogICAgICAgIC8vd2lsbCBmaXJlIHRoZSBvbkRPTUNvbnRlbnRMb2FkZWQgYmVmb3JlICJpbnRlcmFjdGl2ZSIgYnV0IG5vdCBhZnRlcgogICAgICAgIC8vZW50ZXJpbmcgImludGVyYWN0aXZlIiBvciAiY29tcGxldGUiLiBNb3JlIGRldGFpbHM6CiAgICAgICAgLy9odHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL3RoZS1lbmQuaHRtbCN0aGUtZW5kCiAgICAgICAgLy9odHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM2NjU1NjEvZG9jdW1lbnQtcmVhZHlzdGF0ZS1vZi1pbnRlcmFjdGl2ZS12cy1vbmRvbWNvbnRlbnRsb2FkZWQKICAgICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiB8fAogICAgICAgICAgICBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiaW50ZXJhY3RpdmUiKSB7CiAgICAgICAgICAgIHBhZ2VMb2FkZWQoKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqIFNUQVJUIE9GIFBVQkxJQyBBUEkgKiovCgogICAgLyoqCiAgICAgKiBSZWdpc3RlcnMgYSBjYWxsYmFjayBmb3IgRE9NIHJlYWR5LiBJZiBET00gaXMgYWxyZWFkeSByZWFkeSwgdGhlCiAgICAgKiBjYWxsYmFjayBpcyBjYWxsZWQgaW1tZWRpYXRlbHkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogICAgICovCiAgICBmdW5jdGlvbiBkb21SZWFkeShjYWxsYmFjaykgewogICAgICAgIGlmIChpc1BhZ2VMb2FkZWQpIHsKICAgICAgICAgICAgY2FsbGJhY2soZG9jKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWFkeUNhbGxzLnB1c2goY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZG9tUmVhZHk7CiAgICB9CgogICAgZG9tUmVhZHkudmVyc2lvbiA9ICcyLjAuMCc7CgogICAgLyoqCiAgICAgKiBMb2FkZXIgUGx1Z2luIEFQSSBtZXRob2QKICAgICAqLwogICAgZG9tUmVhZHkubG9hZCA9IGZ1bmN0aW9uIChuYW1lLCByZXEsIG9uTG9hZCwgY29uZmlnKSB7CiAgICAgICAgaWYgKGNvbmZpZy5pc0J1aWxkKSB7CiAgICAgICAgICAgIG9uTG9hZChudWxsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb21SZWFkeShvbkxvYWQpOwogICAgICAgIH0KICAgIH07CgogICAgLyoqIEVORCBPRiBQVUJMSUMgQVBJICoqLwoKICAgIHJldHVybiBkb21SZWFkeTsKfSk7CgpkZWZpbmUoJ3RocnVzdC9tYWluJyxbCiAgICAncmVxdWlyZScsICd0aHJ1c3QvbG9nJywgJ3RocnVzdC91dGlsJywgJ3RocnVzdC9jb25maWcnLCAnLi9pZ25pdGUnLCAndGhydXN0L21vZHVsZScsICdkb21SZWFkeScsICdtb2R1bGUnLCAnLi9pbnN0YW5jZScsICdoYXMnCl0sCmZ1bmN0aW9uIChyZXF1aXJlLCBsb2csIHV0aWwsIHRDb25maWcsIGlnbml0ZVNwZWMsIE1vZHVsZSwgZG9tUmVhZHksIG1vZHVsZSwgdGhydXN0SW5zdGFuY2UsIGhhcykKewogICAgLyoqCiAgICAgICAgVGhlIHRocnVzdCBhcHBsaWNhdGlvbiEKCiAgICBAbW9kdWxlIHRocnVzdAogICAgQG1haW4gdGhydXN0CiAgICAqKi8KICAgIAoKICAgIHZhciBJTklUICAgICAgICAgICA9ICdpbml0JywKICAgICAgICBTVEFSVCAgICAgICAgICA9ICdzdGFydCcsCiAgICAgICAgUkVBRFkgICAgICAgICAgPSAncmVhZHknLAogICAgICAgIFNUT1AgICAgICAgICAgID0gJ3N0b3AnLAogICAgICAgIERFU1RST1kgICAgICAgID0gJ2Rlc3Ryb3knLAogICAgICAgIENPVU5URE9XTiAgICAgID0gJ2NvdW50ZG93bicsCiAgICAgICAgSUdOSVRFICAgICAgICAgPSAnaWduaXRlJywKICAgICAgICBPUkJJVCAgICAgICAgICA9ICdvcmJpdCcsCiAgICAgICAgREVPUkJJVCAgICAgICAgPSAnZGVvcmJpdCcsCiAgICAgICAgU1BMQVNIRE9XTiAgICAgPSAnc3BsYXNoZG93bicsCiAgICAgICAgbWVtb2l6ZSAgICAgICAgPSB1dGlsLm1lbW9pemUsCiAgICAgICAgZWFjaCAgICAgICAgICAgPSB1dGlsLmVhY2gsCiAgICAgICAgbWFwICAgICAgICAgICAgPSB1dGlsLm1hcCwKICAgICAgICB3aGVuICAgICAgICAgICA9IHV0aWwud2hlbiwKICAgICAgICB0eXBlICAgICAgICAgICA9IHV0aWwudHlwZSwKICAgICAgICBpc0FycmF5ICAgICAgICA9IHV0aWwuaXNBcnJheSwKICAgICAgICBzbGljZSAgICAgICAgICA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKICAgICAgICB0b0FycmF5ICAgICAgICA9IHV0aWwudG9BcnJheSwKICAgICAgICBmb3JtYXQgICAgICAgICA9IHV0aWwuZm9ybWF0LAogICAgICAgIHJlc29sdmVNZXRob2RzID0gW0lOSVQsIFNUQVJULCBSRUFEWSwgU1RPUCwgREVTVFJPWV0sCiAgICAgICAgaW5zdGFuY2VzID0gdGhydXN0SW5zdGFuY2UuaW5zdGFuY2VzLAogICAgICAgIGxvYWRpbmdJbnN0YW5jZXMgPSB0aHJ1c3RJbnN0YW5jZS5sb2FkaW5nSW5zdGFuY2VzOwoKICAgIHV0aWwuZGVlcENvcHkodENvbmZpZywgbW9kdWxlLmNvbmZpZygpKTsKCiAgICAvKioKICAgICAgICBUaGUgcHJpbWFyeSB0aHJ1c3QgY2xhc3MuCiAgICAKICAgIEBjbGFzcyBUaHJ1c3QKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhpcyB0aHJ1c3QgaW5zdGFuY2UKICAgIEByZXR1cm5zIHtUaHJ1c3R9CiAgICAqKi8KICAgIHZhciBUaHJ1c3QgPSBmdW5jdGlvbiAoLyogJHJlZiAqLyBuYW1lKQogICAgewogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5tb2R1bGVzID0ge307CiAgICAgICAgdGhpcy5mYWlsZWRNb2R1bGVzID0ge307CiAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhuYW1lKTsKICAgIH07CgogICAgLy8jcmVnaW9uIFJ1bm5lciBGYWN0b3JpZXMKICAgIHZhciBydW5SdW5uZXJGYWN0b3J5LCBydW5uZXJGYWN0b3J5LCBhbGxSdW5uZXJGYWN0b3J5OwogICAgcnVuUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkKICAgIHsKICAgICAgICB2YXIgY29udmVudGlvbk1ldGhvZCA9IChtZXRob2QgPT09IFNUT1AgJiYgU1RBUlQpIHx8IChtZXRob2QgPT09IERFU1RST1kgJiYgSU5JVCkgfHwgbWV0aG9kLAogICAgICAgICAgICBjb252ZW50aW9uVmFsdWUgPSAhKG1ldGhvZCA9PT0gU1RPUCB8fCBtZXRob2QgPT09IERFU1RST1kpLAogICAgICAgICAgICB1bnNldFJlYWR5ID0gbWV0aG9kID09PSBTVE9QLAogICAgICAgICAgICBjb252ZW50aW9uQ2hlY2sgPSBjb252ZW50aW9uTWV0aG9kICE9PSBtZXRob2QsCiAgICAgICAgICAgIGNvbnZlbnRpb25OYW1lID0gZm9ybWF0KCd7MH0tc3RhdHVzJywgY29udmVudGlvbk1ldGhvZCksCiAgICAgICAgICAgIHJ1bm5lciA9IHJ1bm5lckZhY3RvcnkobWV0aG9kLCBjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlLCB1bnNldFJlYWR5KSwKICAgICAgICAgICAgbG9nTWVzc2FnZSA9IGZvcm1hdCgoJ1RocnVzdDogezB9aW5nIG1vZHVsZSAie3swfX0iIGZhaWxlZCEnLCBtZXRob2QpKSwKICAgICAgICAgICAgcnVubmluZ01lc3NhZ2UgPSBmb3JtYXQoJ1RocnVzdDogUnVubmluZyB7MH0gZm9yIG1vZHVsZSAie3swfX0iLicsIG1ldGhvZCk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZXMpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmICghaXNBcnJheShuYW1lcykpCiAgICAgICAgICAgICAgICBuYW1lcyA9IFtuYW1lc107CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgICAgcmVzdWx0cyA9IFtdOwogICAgICAgICAgICBlYWNoKG5hbWVzLCBmdW5jdGlvbiAobmFtZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KHJ1bm5pbmdNZXNzYWdlLCBuYW1lKSk7CiAgICAgICAgICAgICAgICB2YXIgbW9kID0gdGhhdC5tb2R1bGVzW25hbWVdOwoKICAgICAgICAgICAgICAgIGlmICghbW9kICYmICF0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IHRvIGZldGNoIHRoZSBtb2R1bGUuCiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuaW5nIHRoZSBwcm9wZXIgZGVmZXIgaW4gaXQncyBwbGFjZQogICAgICAgICAgICAgICAgICAgIHZhciBsb2FkZXJEZWZlciA9IHdoZW4uZGVmZXIoKTsKCiAgICAgICAgICAgICAgICAgICAgcmVxdWlyZShbbmFtZV0sIGZ1bmN0aW9uIChtb2R1bGVEZWZuKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jcmVhdGVNb2R1bGUobW9kdWxlRGVmbi5uYW1lIHx8IG5hbWUsIG1vZHVsZURlZm4pOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHJ1blJ1bm5lckZhY3RvcnkobWV0aG9kKS5hcHBseSh0aGF0LCBbbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbi5jaGFpbih3aGVuLmFsbCh1dGlsLmZsYXR0ZW4ocmVzdWx0KSksIGxvYWRlckRlZmVyKTsKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5mYWlsZWRNb2R1bGVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGVyRGVmZXIucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gobG9hZGVyRGVmZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGNvbnZlbnRpb25DaGVjayAmJiBtb2QuY29udmVudGlvbihjb252ZW50aW9uTmFtZSkpIHx8ICFtb2QuY29udmVudGlvbihjb252ZW50aW9uTmFtZSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRDb25maWcudGhyb3dFcnJvcnMpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVubmVyKHRoYXQsIG5hbWUsIG1vZCwgYXJncykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHJ1bm5lcih0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZXJyb3IoZm9ybWF0KGxvZ01lc3NhZ2UsIG5hbWUpLCBlLCBlLnN0YWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICB9OwogICAgfSk7CgogICAgcnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCwgY29udmVudGlvbk5hbWUsIGNvbnZlbnRpb25WYWx1ZSwgdW5zZXRSZWFkeSkKICAgIHsKICAgICAgICB2YXIgZXZlbnROYW1lID0gZm9ybWF0KCd0aHJ1c3QvbW9kdWxlL3swfScsIG1ldGhvZCksCiAgICAgICAgICAgIGluZm9Gb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogezB9aW5nIG1vZHVsZSAie3swfX0iJywgbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnN1YnN0cmluZygxKSksCiAgICAgICAgICAgIGRlYnVnRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IENhbGxpbmcgbW9kdWxlICJ7ezB9fSIgezB9KCknLCBtZXRob2QpLAogICAgICAgICAgICBjb21wQWZ0ZXIgPSBtZXRob2QgPT09IFNUT1AgfHwgbWV0aG9kID09PSBERVNUUk9ZIHx8IGZhbHNlOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRoYXQsIG5hbWUsIG1vZCwgYXJncykKICAgICAgICB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIG5hbWUpKTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KGNvbnZlbnRpb25OYW1lLCBuYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0Q2FsbChtZXRob2QsIGNvbXBBZnRlciwgYXJncykudGhlbihmdW5jdGlvbiAoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGF0Lm1lZGlhdG9yLmZpcmUoZXZlbnROYW1lLCBuYW1lKTsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKGNvbnZlbnRpb25OYW1lLCBjb252ZW50aW9uVmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKHVuc2V0UmVhZHkpIG1vZC5jb252ZW50aW9uKFJFQURZICsgJy1zdGF0dXMnLCBmYWxzZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9KTsKCiAgICBhbGxSdW5uZXJGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAobWV0aG9kKQogICAgewogICAgICAgIHZhciBpbmZvRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBhbGwgbW9kdWxlcy4uLiBbe3swfX1dJywgbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnN1YnN0cmluZygxKSksCiAgICAgICAgICAgIHBsdXJhbE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvYWxsL3swfScsIG1ldGhvZCksCiAgICAgICAgICAgIGNoZWNrQXV0b1N0YXJ0ID0gbWV0aG9kID09PSBJTklUIHx8IG1ldGhvZCA9PT0gU1RBUlQ7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAodGhhdCkKICAgICAgICB7CiAgICAgICAgICAgIHRoYXQubWVkaWF0b3IuZmlyZShwbHVyYWxOYW1lKTsKICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSB0aGF0Lm1vZHVsZXMsCiAgICAgICAgICAgICAgICByZXN1bHRzID0gW107CgogICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCB1dGlsLm1hcChtb2R1bGVzLCBmdW5jdGlvbih4LCBpKSB7IHJldHVybiB4LmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpICYmIGk7IH0pLmpvaW4oJywgJykpKTsKICAgICAgICAgICAgZWFjaChtb2R1bGVzLCBmdW5jdGlvbiAoeCwgaSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFjaGVja0F1dG9TdGFydCB8fCAoY2hlY2tBdXRvU3RhcnQgJiYgeC5jb252ZW50aW9uKCdhdXRvU3RhcnQnKSkpCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHRoYXRbbWV0aG9kXShpKSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHRoYXQuc3RhcnRpbmdNb2R1bGVzICYmIGNoZWNrQXV0b1N0YXJ0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCB0aGF0LnN0YXJ0aW5nTW9kdWxlcy5qb2luKCcsICcpKSk7CiAgICAgICAgICAgICAgICB0aGF0W21ldGhvZF0odGhhdC5zdGFydGluZ01vZHVsZXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwocmVzdWx0cyk7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIHZhciBmbGF0dGVuV2l0aEFzeW5jID0gZnVuY3Rpb24gKHRoYXQsIGFycikKICAgIHsKICAgICAgICByZXR1cm4gdXRpbC5mbGF0dGVuKGFyci5jb25jYXQodGhhdC5jZmcuYXN5bmMgJiYgW3doZW4uZGVsYXkoMCldIHx8IFtdKSk7CiAgICB9OwogICAgLy8jZW5kcmVnaW9uCiAgICAKICAgIFRocnVzdC5wcm90b3R5cGUgPSBUaHJ1c3QuZm4gPSB7CiAgICAgICAgLyoqCiAgICAgICAgICAgIFJlcXVpcmVkIG1ldGhvZHMsIHRoYXQgZXZlcnkgbW9kdWxlIG11c3QgaW1wbGVtZW50LgogICAgCiAgICAgICAgQHByb3BlcnR5IF9fcmVxdWlyZWRNZXRob2RzCiAgICAgICAgQHByb3RlY3RlZAogICAgICAgICoqLwogICAgICAgIF9fcmVxdWlyZWRNZXRob2RzOiBbICAgICAvLyBSZXF1aXJlZCBtZXRob2RzIHRoYXQgbXVzdCBiZSBvbiBldmVyeSBtb2R1bGUKICAgICAgICAgICAgJ2luaXQnLAogICAgICAgICAgICAnZGVzdHJveScKICAgICAgICBdLAogICAgICAgIF9fY29udmVudGlvbnM6IFtdLAogICAgICAgIC8qKgogICAgICAgICAgICBDcmVhdGVzIGEgbmV3IHRocnVzdCBtb2R1bGUuCgogICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHVuaXF1ZSBtb2R1bGUgbmFtZS4KICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlIFRoZSBtb2R1bGUgZGVmaW50aW9uLgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gcHJlQnVpbGQgSGFzIHRoaXMgbW9kdWxlIGJlZW4gcHJlYnVpbHQsIGluIG90aGVyIHdvcmRzIGhhcyBpdCBiZWVuIGNyZWF0ZWQsIGJ5IHdpcmUuanMgYW5kIG5lZWRzIHRvIGJlIGluamVjdGVkLgogICAgICAgIEByZXR1cm5zIHtNb2R1bGV9IFRoZSBuZXcgbW9kdWxlIGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGNyZWF0ZTogZnVuY3Rpb24gKG5hbWUsIG1vZHVsZSwgcHJlQnVpbHQpCiAgICAgICAgewogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ1RocnVzdDogQ3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mICJ7MH0iJywgbmFtZSkpOwoKICAgICAgICAgICAgdmFyIG9sZE1vZHVsZTsKICAgICAgICAgICAgaWYgKHByZUJ1aWx0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvbGRNb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgICAgICBtb2R1bGUgPSBtb2R1bGUuaW5zdGFuY2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghcHJlQnVpbHQpCiAgICAgICAgICAgICAgICBtb2R1bGUgPSBuZXcgTW9kdWxlKHRoaXMsIG1vZHVsZSwgbmFtZSk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIG1vZHVsZSA9IG9sZE1vZHVsZTsKCiAgICAgICAgICAgIC8vIE1vZHVsZXMgY2Fubm90IGhhdmUgZHVwbGljYXRlIG5hbWVzLCBjaG9vc2UgYSBuZXcgb25lLgogICAgICAgICAgICBpZiAodGhpcy5tb2R1bGVzW21vZHVsZS5uYW1lXSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ0R1cGxpY2F0ZSBtb2R1bGUgbmFtZSAiezB9Ii4nLCBuYW1lKSk7CgogICAgICAgICAgICAvLyBtIGlzIHRoZSBtZWRpYXRvcnMgaW50ZXJuYWwgbW9kdWxlLgogICAgICAgICAgICB0aGlzLm1vZHVsZXNbbW9kdWxlLm5hbWVdID0gbW9kdWxlOwoKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ1RocnVzdDogQ3JlYXRlZCBtb2R1bGUgInswfSInLCBuYW1lKSk7CiAgICAgICAgICAgIC8vIE5vdGlmeSB0aGUgbWVkaWF0b3IgdGhhdCBhIG1vZHVsZSBoYXMgYmVlbiBjcmVhdGVkLgogICAgICAgICAgICB0aGlzLm1lZGlhdG9yLmZpcmUoJ3RocnVzdC9tb2R1bGUvY3JlYXRlJywgbmFtZSk7CgogICAgICAgICAgICBpZiAodGhpcy5tZWRpYXRvci5zdGFydGVkICYmIG1vZHVsZS5jb252ZW50aW9uKCdhdXRvU3RhcnQnKSkKICAgICAgICAgICAgICAgIHRoaXMubWVkaWF0b3Iuc3RhcnQobW9kdWxlLm5hbWUpOwoKICAgICAgICAgICAgcmV0dXJuIG1vZHVsZTsKICAgICAgICB9LAogICAgICAgIC8vI3JlZ2lvbiBHbG9iYWwgUnVubmVycwogICAgICAgIC8qKgogICAgICAgICAgICBCZWdpbnMgdGhlIGNvdW50ZG93biB0byB0aHJ1c3RzIHN0YXJ0LgogICAgICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCgogICAgICAgIEBtZXRob2QgY291bnRkb3duCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGNvdW50ZG93biBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgY291bnRkb3duOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0xhdW5jaCBpbnN0YW5jZSAiezB9IiBpbiA1Li4uIDQuLi4gMy4uLiAyLi4uIDEuLi4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgdXRpbC5zYWZlSW52b2tlKHRoYXQuX19jb252ZW50aW9ucywgQ09VTlRET1dOLCB0aGF0KSwKICAgICAgICAgICAgICAgIHRoYXQuaW5pdCgpCiAgICAgICAgICAgIF0pKQogICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgeyB0aGF0Lm1lZGlhdG9yLmZpcmUoJ3RocnVzdC9pbml0Jyk7IH0pCiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHsgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaGFzIGJlZW4gaW5pdGFsaXplZC4nLCB0aGF0Lm5hbWUpKTsgfSkKICAgICAgICAgICAgICAgIC50aGVuKHRoYXQuaWduaXRlLmJpbmQodGhhdCkpOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICAgIEJlZ2lucyB0aGUgaW5naXRpb24gYXMgdGhydXN0IHN0YXJ0cyB1cC4KICAgICAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgoKICAgICAgICBAbWV0aG9kIGlnbml0ZQogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgaWduaXRlOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0ZpcmluZyByb2NrZXRzIGZvciB0aHVyc3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHV0aWwuc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIElHTklURSwgdGhhdCksCiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0KCkKICAgICAgICAgICAgXSkpCiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L3N0YXJ0Jyk7IH0pCiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIHN0YXJ0ZWQuJywgdGhhdC5uYW1lKSk7IH0pCiAgICAgICAgICAgICAgICAudGhlbih0aGF0Lm9yYml0LmJpbmQodGhhdCkpOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICAgIFRocnVzdCBwcmVwYXJlcyBmb3Igb3JiaXQuCiAgICAgICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbi4KCiAgICAgICAgQG1ldGhvZCBvcmJpdAogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRocnVzdCBpcyBpbiBvcmJpdC4KICAgICAgICAqKi8KICAgICAgICBvcmJpdDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdGaXJpbmcgc3RhZ2UgdHdvIHRocnVzdGVycyBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICB2YXIgZG9tUmVhZHlEZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgZG9tUmVhZHlEZWZlci50aGVuKGZ1bmN0aW9uICgpIHsgdGhhdC5tZWRpYXRvci5maXJlKCd0aHJ1c3QvZG9tL3JlYWR5Jyk7IH0pOwogICAgICAgICAgICBkb21SZWFkeShkb21SZWFkeURlZmVyLnJlc29sdmUpOwoKICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgZG9tUmVhZHlEZWZlci5wcm9taXNlLAogICAgICAgICAgICAgICAgdXRpbC5zYWZlSW52b2tlKHRoYXQuX19jb252ZW50aW9ucywgT1JCSVQsIHRoYXQpCiAgICAgICAgICAgIF0pKS50aGVuKGZ1bmN0aW9uICgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0cnVlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciB0aW1lU3RhcnQgPSB0aGF0LmNvbmZpZy5kZWJ1Zy50aW1lU3RhcnQsCiAgICAgICAgICAgICAgICAgICAgdGltZUVuZCAgICAgICA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0VGltZSAgICAgPSAodGltZUVuZCAtIHRpbWVTdGFydCksCiAgICAgICAgICAgICAgICAgICAgdHRvRGl2ICAgICAgICA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0dG8nKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR0b0RpdikKICAgICAgICAgICAgICAgICAgICAgICAgdHRvRGl2LmlubmVySFRNTCA9IHN0YXJ0VGltZSArICdtcyc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgd2hlbi5hbGwoZmxhdHRlbldpdGhBc3luYyh0aGF0LCBbdGhhdC5yZWFkeSgpXSkpCiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgeyB0aGF0Lm1lZGlhdG9yLmZpcmUoJ3RocnVzdC9yZWFkeScpOyB9KQogICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IHJlYWR5LicsIHRoYXQubmFtZSkpOyB9KQogICAgICAgICAgICAgICAgICAgIC50aGVuKHRoYXQuaW5PcmJpdC5iaW5kKHRoYXQpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBpbk9yYml0OiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LnN0YXJ0ZWQgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKHRydWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aW1lU3RhcnQgPSB0aGF0LmNvbmZpZy5kZWJ1Zy50aW1lU3RhcnQsCiAgICAgICAgICAgICAgICAgICAgdGltZUVuZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KTsKCiAgICAgICAgICAgICAgICBsb2cuaW5mbygnU3RhcnRlZCBpbiAnICsgc3RhcnRUaW1lICsgJ21zJyk7CgogICAgICAgICAgICAgICAgdmFyIHR0ckRpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0dHInKTsKICAgICAgICAgICAgICAgIGlmICh0dHJEaXYpCiAgICAgICAgICAgICAgICAgICAgdHRyRGl2LmlubmVySFRNTCA9IHN0YXJ0VGltZSArICdtcyc7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAgICBCZWdpbnMgdGhlIGRlb3JiaXQgYXMgdGhydXN0IHNodXRkb3duLgogICAgICAgICAgICBTaHV0ZG93biBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgoKICAgICAgICBAbWV0aG9kIGRlb3JiaXQKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5naXRpb24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGRlb3JiaXQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnUmVlbnRlcmluZyBlYXJ0aHMgYXRtb3NwaGVyZSBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlbldpdGhBc3luYyh0aGF0LCBbCiAgICAgICAgICAgICAgICB0aGF0LnN0b3AoKSwKICAgICAgICAgICAgICAgIHV0aWwuc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIERFT1JCSVQsIHRoYXQpCiAgICAgICAgICAgIF0pKQogICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgeyB0aGF0Lm1lZGlhdG9yLmZpcmUoJ3RocnVzdC9zdG9wJyk7IH0pCiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIG5vdyBzdG9wcGVkLicsIHRoYXQubmFtZSkpOyB9KQogICAgICAgICAgICAgICAgLnRoZW4odGhhdC5vcmJpdC5iaW5kKHRoYXQpKTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAgICBCZWdpbnMgdGhlIHNwbGFzaGRvd24gYXMgdGhydXN0IHNodXRkb3duLgogICAgICAgICAgICBTaHV0ZG93biBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgoKICAgICAgICBAbWV0aG9kIHNwbGFzaGRvd24KICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5naXRpb24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIHNwbGFzaGRvd246IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnTGFuZGluZyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBhdGxhbnRpYyBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlbldpdGhBc3luYyh0aGF0LCBbCiAgICAgICAgICAgICAgICB0aGF0LnN0b3AoKSwKICAgICAgICAgICAgICAgIHV0aWwuc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIFNQTEFTSERPV04sIHRoYXQpCiAgICAgICAgICAgIF0pKQogICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgeyB0aGF0Lm1lZGlhdG9yLmZpcmUoJ3RocnVzdC9kZXN0cm95Jyk7IH0pCiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIG5vdyBiZWluZyBkZXN0cm95ZWQnLCB0aGF0Lm5hbWUpKTsgfSk7CiAgICAgICAgICAgIC8vIGRvIGRlc3Ryb3kKICAgICAgICB9LAogICAgICAgIC8vI2VuZHJlZ2lvbgogICAgICAgIC8vI3JlZ2lvbiBNb2R1bGUgcnVubmVycwogICAgICAgIC8qKgogICAgICAgICAgICBCZWdpbnMgdGhlIGluaXRhbGl6YXRpb24gcHJvY2VzcyBmb3IgYSBtb2R1bGUuICBUaGlzIHJ1bnMgYXMgcGFydCBvZiB0aGUKICAgICAgICAgICAgICAgIGNvdW50ZG93biBwaGFzZSwgZHVyaW5nIHN0YXJ0IHVwLCBvciBpbiBvcmRlciwgd2hlbiBjcmVhdGluZyBtb2R1bGVzLgogICAgICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCgogICAgICAgIEBtZXRob2QgaW5pdAogICAgICAgIEBwYXJhbSB7U3RyaW5nfEFycmF5IG9mIFN0cmluZ30gW25hbWVdIFRoZSBuYW1lIG9mIHRoZSBtb2R1bGUuICBJZiBuYW1lIGlzIG51bGwsIGFsbCBtb2R1bGVzCiAgICAgICAgICAgIHRoYXQgcmV0dXJuIHRoZSBwcm9wZXJ0eSBhdXRvU3RhcnQgd2lsbCBiZSBpbml0ZWQuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluaXQgaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGluaXQ6IG1lbW9pemUoZnVuY3Rpb24gKG5hbWUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IElOSVQ7CgogICAgICAgICAgICB2YXIgcmVzdWx0ID0gIW5hbWUgJiYgYWxsUnVubmVyRmFjdG9yeShtZXRob2QpKHRoYXQpOwogICAgICAgICAgICBpZiAocmVzdWx0KQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICAgICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICAgICAgICBpZiAoaXNBcnJheShuYW1lKSkKICAgICAgICAgICAgICAgIHJlc3VsdCA9IG1hcChuYW1lLCBmdW5jdGlvbiAoeCkgeyByZXR1cm4gdGhhdC5pbml0KHgpOyB9KTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgcmVzdWx0ID0gcnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIGFyZ3VtZW50cyk7CgogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwodXRpbC5mbGF0dGVuKHJlc3VsdCkpOwogICAgICAgIH0pLAogICAgICAgIC8qKgogICAgICAgICAgICBCZWdpbnMgdGhlIHN0YXJ0dXAgcHJvY2VzcyBmb3IgYSBtb2R1bGUuICBUaGlzIHJ1bnMgYXMgcGFydCBvZiB0aGUKICAgICAgICAgICAgICAgIGlnbml0ZSBwaGFzZSwgZHVyaW5nIHN0YXJ0IHVwLCBvciBpbiBvcmRlciwgd2hlbiBjcmVhdGluZyBtb2R1bGVzLgogICAgICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCgogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICBAcGFyYW0ge1N0cmluZ3xBcnJheSBvZiBTdHJpbmd9IFtuYW1lXSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlLiAgSWYgbmFtZSBpcyBudWxsLCBhbGwgbW9kdWxlcwogICAgICAgICAgICB0aGF0IHJldHVybiB0aGUgcHJvcGVydHkgYXV0b1N0YXJ0IHdpbGwgYmUgc3RhcnRlZC4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5pdCBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChuYW1lKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBtZXRob2QgPSBTVEFSVDsKCiAgICAgICAgICAgIHZhciByZXN1bHQgPSAhbmFtZSAmJiBhbGxSdW5uZXJGYWN0b3J5KG1ldGhvZCkodGhhdCk7CiAgICAgICAgICAgIGlmIChyZXN1bHQpCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoKICAgICAgICAgICAgaWYgKCFpc0FycmF5KG5hbWUpKQogICAgICAgICAgICAgICAgbmFtZSA9IFtuYW1lXTsKCiAgICAgICAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IG5hbWUubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgbiA9IG5hbWVbaV0sCiAgICAgICAgICAgICAgICAgICAgbW9kID0gdGhhdC5tb2R1bGVzW25dOwoKICAgICAgICAgICAgICAgIGlmICghbW9kKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGl0ZW1zLnB1c2godGhhdC5pbml0LmNhbGwodGhhdCwgW25dLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICghbW9kLmNvbnZlbnRpb24oSU5JVCArICctc3RhdHVzJykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaXRlbXMucHVzaCh0aGF0LmluaXQuY2FsbCh0aGF0LCBbbl0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBzdGFydERlZmVyID0gd2hlbi5kZWZlcigpLAogICAgICAgICAgICAgICAgYXJncyA9IHV0aWwudG9BcnJheShhcmd1bWVudHMpOwogICAgICAgICAgICB3aGVuLmFsbCh1dGlsLmZsYXR0ZW4oaXRlbXMpKS50aGVuKGZ1bmN0aW9uICgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHRzID0gW107CiAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIGFyZ3MpKTsKCiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0c0RlZmVyID0gd2hlbi5hbGwodXRpbC5mbGF0dGVuKHJlc3VsdHMpKTsKICAgICAgICAgICAgICAgIGlmICh0aGF0LnN0YXJ0ZWQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJ1blJlYWR5ID0gZnVuY3Rpb24gKCkgeyB3aGVuLmNoYWluKHRoYXQucmVhZHkuYXBwbHkodGhhdCwgYXJncyksIHN0YXJ0RGVmZXIpOyB9OwogICAgICAgICAgICAgICAgICAgIHJlc3VsdHNEZWZlci50aGVuKHJ1blJlYWR5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB3aGVuLmNoYWluKHJlc3VsdHNEZWZlciwgc3RhcnREZWZlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHN0YXJ0RGVmZXIucHJvbWlzZTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAgICBCZWdpbnMgdGhlIHJlYWR5IHByb2Nlc3MgZm9yIGEgbW9kdWxlLiAgVGhpcyBydW5zIGFzIHBhcnQgb2YgdGhlCiAgICAgICAgICAgICAgICBvcmJpdCBwaGFzZSwgZHVyaW5nIHJlYWR5LCBvciBpbiBvcmRlciwgd2hlbiBjcmVhdGluZyBtb2R1bGVzLgogICAgICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCgogICAgICAgIEBtZXRob2QgcmVhZHkKICAgICAgICBAcGFyYW0ge1N0cmluZ3xBcnJheSBvZiBTdHJpbmd9IFtuYW1lXSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlLiAgSWYgbmFtZSBpcyBudWxsLCBhbGwgbW9kdWxlcwogICAgICAgICAgICB0aGF0IHJldHVybiB0aGUgcHJvcGVydHkgYXV0b1N0YXJ0IHdpbGwgYmUgc3RhcnRlZC4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5pdCBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChuYW1lKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBtZXRob2QgPSBSRUFEWTsKCiAgICAgICAgICAgIHZhciByZXN1bHQgPSAhbmFtZSAmJiBhbGxSdW5uZXJGYWN0b3J5KG1ldGhvZCkodGhhdCk7CiAgICAgICAgICAgIGlmIChyZXN1bHQpCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoKICAgICAgICAgICAgaWYgKCFpc0FycmF5KG5hbWUpKQogICAgICAgICAgICAgICAgbmFtZSA9IFtuYW1lXTsKCiAgICAgICAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IG5hbWUubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgbiA9IG5hbWVbaV0sCiAgICAgICAgICAgICAgICAgICAgbW9kID0gdGhhdC5tb2R1bGVzW25dOwogICAgICAgICAgICAgICAgaWYgKCFtb2QuY29udmVudGlvbihTVEFSVCArICctc3RhdHVzJykgJiYgIXRoYXQuc3RhcnRlZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKHRoYXQuc3RhcnQuYXBwbHkodGhhdCwgW25dLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpdGVtcy5wdXNoKHJ1blJ1bm5lckZhY3RvcnkobWV0aG9kKS5hcHBseSh0aGF0LCBhcmd1bWVudHMpKTsKCiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbCh1dGlsLmZsYXR0ZW4oaXRlbXMpKTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAgICBCZWdpbnMgdGhlIHN0b3AgcHJvY2VzcyBmb3IgYSBtb2R1bGUuICBUaGlzIHJ1bnMgYXMgcGFydCBvZiB0aGUKICAgICAgICAgICAgICAgIGRlb3JiaXQgcGhhc2UsIGR1cmluZyBzdG9wLCBvciBpbiBvcmRlciwgd2hlbiBjcmVhdGluZyBtb2R1bGVzLgogICAgICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCgogICAgICAgIEBtZXRob2Qgc3RvcAogICAgICAgIEBwYXJhbSB7U3RyaW5nfEFycmF5IG9mIFN0cmluZ30gW25hbWVdIFRoZSBuYW1lIG9mIHRoZSBtb2R1bGUuICBJZiBuYW1lIGlzIG51bGwsIGFsbCBtb2R1bGVzCiAgICAgICAgICAgIHdpbGwgYmUgc3RvcHBlZC4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgc3RvcCBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG5hbWUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IFNUT1A7CgogICAgICAgICAgICB2YXIgcmVzdWx0ID0gIW5hbWUgJiYgYWxsUnVubmVyRmFjdG9yeShtZXRob2QpKHRoYXQpOwogICAgICAgICAgICBpZiAocmVzdWx0KQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICAgICAgICAgIGlmICghaXNBcnJheShuYW1lKSkKICAgICAgICAgICAgICAgIG5hbWUgPSBbbmFtZV07CgogICAgICAgICAgICByZXN1bHQgPSBydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgYXJndW1lbnRzKQogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwodXRpbC5mbGF0dGVuKHJlc3VsdCkpOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICAgIEJlZ2lucyB0aGUgZGVzdHJveSBwcm9jZXNzIGZvciBhIG1vZHVsZS4gIFRoaXMgcnVucyBhcyBwYXJ0IG9mIHRoZQogICAgICAgICAgICAgICAgc2xhc2hkb3duIHBoYXNlLCBkdXJpbmcgZGVzdHJveSwgb3IgaW4gb3JkZXIsIHdoZW4gY3JlYXRpbmcgbW9kdWxlcy4KICAgICAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgoKICAgICAgICBAbWV0aG9kIGRlc3Ryb3kKICAgICAgICBAcGFyYW0ge1N0cmluZ3xBcnJheSBvZiBTdHJpbmd9IFtuYW1lXSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlLiAgSWYgbmFtZSBpcyBudWxsLCBhbGwgbW9kdWxlcwogICAgICAgICAgICB3aWxsIGJlIGRlc3Ryb3llZC4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgZGVzdHJveSBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKG5hbWUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IERFU1RST1k7CgogICAgICAgICAgICB2YXIgcmVzdWx0ID0gIW5hbWUgJiYgYWxsUnVubmVyRmFjdG9yeShtZXRob2QpKHRoYXQpOwogICAgICAgICAgICBpZiAocmVzdWx0KQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICAgICAgICAgIGlmICghaXNBcnJheShuYW1lKSkKICAgICAgICAgICAgICAgIG5hbWUgPSBbbmFtZV07CgogICAgICAgICAgICB2YXIgaXRlbXMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBuYW1lLmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG4gPSBuYW1lW2ldLAogICAgICAgICAgICAgICAgICAgIG1vZCA9IHRoYXQubW9kdWxlc1tuXTsKCiAgICAgICAgICAgICAgICBpZiAoIW1vZC5jb252ZW50aW9uKFNUT1AgKyAnLXN0YXR1cycpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGl0ZW1zLnB1c2godGhhdC5zdG9wLmNhbGwodGhhdCwgW25dLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpdGVtcy5wdXNoKHJ1blJ1bm5lckZhY3RvcnkobWV0aG9kKS5hcHBseSh0aGF0LCBhcmd1bWVudHMpKTsKICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKHV0aWwuZmxhdHRlbihpdGVtcykpOwogICAgICAgIH0sCiAgICAgICAgLy8jZW5kcmVnaW9uCiAgICAgICAgLyoqCiAgICAgICAgICAgIEluamVjdHMgYSBwcmVjb25zdHJ1Y3RlZCBtb2R1bGUgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgoKICAgICAgICBAbWV0aG9kIF9faW5qZWN0TW9kdWxlCiAgICAgICAgQHByaXZhdGUKICAgICAgICBAcGFyYW0ge01vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gaW5qZWN0LgogICAgICAgICoqLwogICAgICAgIF9faW5qZWN0TW9kdWxlOiBmdW5jdGlvbiAobW9kdWxlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jcmVhdGUobW9kdWxlLm5hbWUsIG1vZHVsZSwgdHJ1ZSk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBDcmVhdGVzIGEgbW9kdWxlIGZyb20gdGhlIGdpdmVuIGRlZmluaXRpb24gb2JqZWN0LCB3aXRoIHRoZSBnaXZlbiBuYW1lLgoKICAgICAgICBAbWV0aG9kIGNyZWF0ZU1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGVEZWZuIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICAgICoqLwogICAgICAgIGNyZWF0ZU1vZHVsZTogZnVuY3Rpb24gKG5hbWUsIG1vZHVsZURlZm4pCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmICh0aGF0Lm1vZHVsZXNbbmFtZV0pIHJldHVybiB0aGF0Lm1vZHVsZXNbbmFtZV07CgogICAgICAgICAgICB2YXIgbW9kdWxlID0gbmV3IE1vZHVsZSh0aGF0LCBtb2R1bGVEZWZuLCBuYW1lKTsKCiAgICAgICAgICAgIHRoYXQuX19pbmplY3RNb2R1bGUobW9kdWxlKTsKCiAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAgICBJbml0YWxpemVzIGEgbmV3IFRocnVzdCBpbnN0YW5jZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gc2V0dGluZ3MuCgogICAgQG1ldGhvZCBsYXVuY2gKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgbW9kdWxlIHRvIGluamVjdAogICAgKiovCiAgICBUaHJ1c3QubGF1bmNoID0gZnVuY3Rpb24gKHNldHRpbmdzKQogICAgewogICAgICAgIGlmICghc2V0dGluZ3MpCiAgICAgICAgICAgIHNldHRpbmdzID0geyBuYW1lOiAnZ2xvYmFsJyB9OwoKICAgICAgICBpZiAoIXNldHRpbmdzLm5hbWUpCiAgICAgICAgICAgIHNldHRpbmdzLm5hbWUgPSAnZ2xvYmFsJzsKCiAgICAgICAgaWYgKHRydWUpCiAgICAgICAgewogICAgICAgICAgICBzZXR0aW5ncy5kZWJ1ZyA9IHsgdGltZVN0YXJ0OiBuZXcgRGF0ZSgpLmdldFRpbWUoKSB9OwogICAgICAgIH0KCiAgICAgICAgdmFyIHNldHVwRGVmZXIgPSBUaHJ1c3QuX19mZXRjaEluc3RhbmNlKHNldHRpbmdzLm5hbWUpOwoKICAgICAgICBzZXR1cERlZmVyLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3Q7CiAgICAgICAgICAgIHRocnVzdC5zdGFydGluZ01vZHVsZXMgPSBjb250ZXh0LmNmZy5tb2R1bGVzOwogICAgICAgICAgICB0aHJ1c3QuY29uZmlnID0gdGhydXN0LmNmZzsKICAgICAgICAgICAgaW5zdGFuY2VzW3RocnVzdC5uYW1lXSA9IHRocnVzdDsKICAgICAgICAgICAgdGhydXN0LmNvdW50ZG93bigpOwoKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgfSkKICAgICAgICAudGhlbihmdW5jdGlvbiAoY29udGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHdpbmRvdy50aHJ1c3QgPSBjb250ZXh0LnRocnVzdDsKICAgICAgICB9KTsKCiAgICAgICAgd2hlbi5jaGFpbihpZ25pdGVTcGVjLnN0YWdlT25lKHNldHRpbmdzKSwgc2V0dXBEZWZlcik7CgogICAgICAgIHJldHVybiBzZXR1cERlZmVyLnByb21pc2U7CiAgICB9OwoKICAgIC8qKgogICAgR2V0cyBhIG5hbWVkIHRocnVzdCBzdGFuY2UgaWYgaXQgZXhpc3RzLgoKICAgIEBtZXRob2QgZ2V0SW5zdGFuY2UKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICBAcmV0dXJucyB7VGhydXN0fSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAqKi8KICAgIFRocnVzdC5nZXRJbnN0YW5jZSA9IGZ1bmN0aW9uIChuYW1lKQogICAgewogICAgICAgIHJldHVybiB0aHJ1c3RJbnN0YW5jZS5nZXRJbnN0YW5jZShuYW1lKTsKICAgIH07CgogICAgLyoqCiAgICBGZXRjaHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgIFRoaXMgbG9hZHMgYXN5bmNyb25vdXNseSwgYXMgdGhlIGluc3RhbmNlIG1heSBub3QgYmUgbG9hZGVkCgogICAgQG1ldGhvZCBfX2ZldGNoSW5zdGFuY2UKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgQHJldHVybnMge1Byb21pc2V9IFRvIGEgdGhydXN0IGluc3RhbmNlIHNwZWMKICAgICoqLwogICAgVGhydXN0Ll9fZmV0Y2hJbnN0YW5jZSA9IGZ1bmN0aW9uIChuYW1lKQogICAgewogICAgICAgIHJldHVybiB0aHJ1c3RJbnN0YW5jZS5mZXRjaEluc3RhbmNlKG5hbWUpOwogICAgfTsKCiAgICAvKioKICAgIENyZWF0ZXMgYSBuZXcgbW9kdWxlIGFuZCBoYW5kcyBpdCBvZmYgdG8gdGhlIGdpdmVuIGluc3RhbmNlLCBpZiB0aGF0IGluc3RhbmNlIGV4aXN0cy4KCiAgICBAbWV0aG9kIGNyZWF0ZU1vZHVsZQogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlTmFtZSBUaGUgdGhydXN0IGluc3RhbmNlIG5hbWUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZQogICAgQHBhcmFtIHtPYmplY3R9IG1vZHVsZURlZm4gVGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAqKi8KICAgIFRocnVzdC5jcmVhdGVNb2R1bGUgPSBmdW5jdGlvbiAoaW5zdGFuY2VOYW1lLCBuYW1lLCBtb2R1bGVEZWZuKQogICAgewogICAgICAgIHZhciBpbnN0YW5jZSA9IFRocnVzdC5nZXRJbnN0YW5jZShpbnN0YW5jZU5hbWUpOwogICAgICAgIGlmIChpbnN0YW5jZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSBuZXcgTW9kdWxlKHRoYXQsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICBpbnN0YW5jZS5fX2luamVjdE1vZHVsZShtb2R1bGUpOwogICAgICAgICAgICByZXR1cm4gbW9kdWxlOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCgogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIGN1cnJlbnQgdGh1cnN0IGluc3RhbmNlLCBieSBleHBlY3RlZCBuYW1lLgogICAgQWRkaW5nIHRoZSA6IGNoYXJhY3RlciByZXF1ZXN0cyBhIHNwZWNpZmljIHBsdWdpbi4KICAgIHRocnVzdCFnbG9iYWwgPSBUaHJ1c3QgaW5zdGFuY2UKICAgIHRocnVzdCFnbG9iYWw6ZG9tID0gVGhlIHRocnVzdCBkb20gcGx1Z2luIGluc3RhbmNlCgogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgVGhydXN0LmxvYWQgPSBmdW5jdGlvbiAobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKQogICAgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwKICAgICAgICAgICAgcmVhbE5hbWUgPSBwYXJ0c1swXSwKICAgICAgICAgICAgcGx1Z2luTmFtZSA9IHBhcnRzWzFdIHx8ICd0aHJ1c3QnOwoKICAgICAgICB2YXIgaW5zdGFuY2VQcm9taXNlID0gVGhydXN0Ll9fZmV0Y2hJbnN0YW5jZShyZWFsTmFtZSk7CiAgICAgICAgaW5zdGFuY2VQcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcGx1Z2luID0gY29udGV4dFtwbHVnaW5OYW1lXTsKICAgICAgICAgICAgaWYgKCFwbHVnaW4pCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdQbHVnaW4gInswfSIgZG9lcyBub3QgZXhpc3Qgb24gdGhydXN0IGluc3RhbmNlICJ7MX0iLicsIHBsdWdpbk5hbWUsIHJlYWxOYW1lKSk7CgogICAgICAgICAgICBsb2FkKHBsdWdpbik7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIHJldHVybiBUaHJ1c3Q7Cn0pOwoKZGVmaW5lKCd0aHJ1c3QnLCBbJ3RocnVzdC9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2NvbnZlbnRpb24nLFsKICAgICd0aHJ1c3QvdXRpbCcKXSwKZnVuY3Rpb24gKHV0aWwpCnsKICAgIC8qKgogICAgICAgIEEgQ29udmVudGlvbiBhbGxvd3MgdGhydXN0IHRvIGJlIGFzIGV4dGVuZGFibGUgYXMgcG9zc2libGUsIGJ5IGdpdmluZyBleHRlbnNpb24gcG9pbnRzIGF0IGV2ZXJ5IHN0ZXAgYWxvbmcgdGhlIHdheS4KCiAgICBAbW9kdWxlIHRocnVzdAogICAgQHN1Ym1vZHVsZSBjb252ZW50aW9uCiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGUgY29udmVudGlvbiBjbGFzcywgdGFrZXMgYW4gb3ZlcmxvYWRlZCBzZXQgb2YgbWV0aG9kcywgZm9yIGFueSBtZXRob2QgdGhhdCBuZWVkcyB0byBiZSBvdmVybG9hZGVkLgoKICAgIEBjbGFzcyBDb252ZW50aW9uCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7T2JqZWN0fSBtZXRob2RzIEFuIG9iamVjdCBvZiBhcHBsaWNhYmxlIG1ldGhvZHMuCiAgICAqKi8KICAgIHZhciBDb252ZW50aW9uID0gZnVuY3Rpb24gKG1ldGhvZHMpCiAgICB7CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIENvbnZlbnRpb24pKQogICAgICAgICAgICByZXR1cm4gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7CgogICAgICAgIHV0aWwuZXh0ZW5kKHRoaXMsIG1ldGhvZHMpOwogICAgfTsKCiAgICBDb252ZW50aW9uLmZuID0gQ29udmVudGlvbi5wcm90b3R5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICAgIFRoZXNlIHByb3BlcnRpZXMgYXJlIHN0cmlwcGVkIG9mZiBvZiBhbnkgbW9kdWxlLCBhbmQgaGVsZCBpbiBhIHByaXZhdGUgc3BhY2UgZm9yIG90aGVyIGNvbnZlbnRpb24gbWV0aG9kcyB0byB1c2UuCiAgICAgICAgQHByb3BlcnR5IHByb3BlcnRpZXMKICAgICAgICBAb3B0aW9uYWwKICAgICAgICAqKi8KICAgICAgICBwcm9wZXJ0aWVzOiBbXSwKICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIGNyZWF0ZSBvZiBhIG1vZHVsZSwgZ2VuZXJhbGx5IHVzZWQgdG8gY3JlYXRlIGEgZmFjYWRlLCB0aGF0IGlzIHRoZW4gYm91bmQgdG8gdGhlIG1vZHVsZS4KICAgICAgICBAbWV0aG9kIGNyZWF0ZQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcGFyYW0ge01vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgaW5zdGFuY2UuCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgQWxsIHRoZSBmYWNhZGVzIGFscmVhZHkgYXR0YWNoZWQgdG8gdGhlIG1vZHVsZS4KICAgICAgICAqKi8KICAgICAgICBjcmVhdGU6IHV0aWwubm9vcCwKICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IGluaXQgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgaW5pdCBwaGFzZQoKICAgICAgICBAbWV0aG9kIGluaXQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBpbml0OiB1dGlsLm5vb3AsCiAgICAgICAgLyoqCiAgICAgICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBzdGFydCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBzdGFydCBwaGFzZQoKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgc3RhcnQ6IHV0aWwubm9vcCwKICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHJlYWR5IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHJlYWR5IHBoYXNlCgogICAgICAgIEBtZXRob2QgcmVhZHkKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICByZWFkeTogdXRpbC5ub29wLAogICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3Qgc3RvcCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBzdG9wIHBoYXNlCgogICAgICAgIEBtZXRob2Qgc3RvcAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIHN0b3A6IHV0aWwubm9vcCwKICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IGRlc3Ryb3kgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgZGVzdHJveSBwaGFzZQoKICAgICAgICBAbWV0aG9kIGRlc3Ryb3kKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBkZXN0cm95OiB1dGlsLm5vb3AsCiAgICAgICAgLyoqCiAgICAgICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgaW5pdCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGNvdW50ZG93bgogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBjb3VudGRvd246IHV0aWwubm9vcCwKICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBzdGFydCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGlnbml0ZQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBpZ25pdGU6IHV0aWwubm9vcCwKICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSByZWFkeSBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIG9yYml0CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIG9yYml0OiB1dGlsLm5vb3AsCiAgICAgICAgLyoqCiAgICAgICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgc3RvcCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGRlb3JiaXQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZGVvcmJpdDogdXRpbC5ub29wLAogICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIGRlc3Ryb3kgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBzcGxhc2hkb3duCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIHNwbGFzaGRvd246IHV0aWwubm9vcAogICAgfTsKCiAgICByZXR1cm4gQ29udmVudGlvbjsKfSk7CmRlZmluZSgndGhydXN0L2V2ZW50cycsWwogICAgJ3RocnVzdC91dGlsJywgJ3RocnVzdC9sb2cnLCAndGhydXN0L2NvbmZpZycsICdoYXMnCl0sCmZ1bmN0aW9uICh1dGlsLCBsb2csIHRDb25maWcsIGhhcykKewogICAgLyoqCiAgICBUaHJ1c3QgRXZlbnRzIGFyZSBiYXNlZCBvZmYgb2YgdGhlIEJhY2tib25lIGV2ZW50IG1vZGVsLCB3aXRoIHNwZWNpYWwgYWRkaXRpb25zLgoKICAgICogRXZlbnRzIGNhbiBiZSBmaXJlZCBhc3luY3Jvbm91c2x5LgogICAgKiBFdmVudHMgY2FuIGJlIG5hbWVzcGFjZWQuCgogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBzdWJtb2R1bGUgRXZlbnRzCiAgICAqKi8KCiAgICAKICAgIC8vICAgICBCYWNrYm9uZS5qcyAwLjkuMQogICAgLy8gICAgIChjKSAyMDEwLTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KICAgIC8vICAgICBCYWNrYm9uZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICAgIC8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246CiAgICAvLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgogICAgdmFyIHNsaWNlICA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKICAgICAgICBhc3luY0ZpcmUsCiAgICAgICAgbm9vcCAgID0gdXRpbC5ub29wLAogICAgICAgIHdoZW4gICA9IHV0aWwud2hlbiwKICAgICAgICBzaXplICAgPSB1dGlsLnNpemUsCiAgICAgICAgZWFjaCAgID0gdXRpbC5lYWNoLAogICAgICAgIGRlZmVyICA9IHV0aWwuZGVmZXIsCiAgICAgICAgZXh0ZW5kID0gdXRpbC5leHRlbmQsCiAgICAgICAgZm9ybWF0ID0gdXRpbC5mb3JtYXQ7CgogICAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLywgX3RyaWdnZXIsIHRyaWdnZXJDYWxsYmFjaywgdHJpZ2dlckFzeW5jQ2FsbGJhY2ssIHRyaWdnZXJOb2RlcywgQUxMID0gJ2FsbCcsIFNUQVJBTEwgPSAnKmFsbCcsIG5vcm1hbGl6ZUV2ZW50cywgZ2V0TmFtZXNwYWNlRGF0YSwgX29mZlByb2Nlc3NOb2RlOwogICAgLyoqCiAgICBOb3JtYWxpemVzIHRoZSBnaXZlbiBldmVudHMgdG8gdGhlIGV4cGVjdGVkIG5hbWVzcGFjZS4KCiAgICBAbWV0aG9kIG5vcm1hbGl6ZUV2ZW50cwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgVGhlIGV2ZW50cyBkZWxpbWl0ZWQgYnkgYSBzcGFjZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZSBUaGUgbmFtZXNwYWNlLCBpbmNsdWRpbmcgcHJlZml4ZWQgJy4nCiAgICAqKi8KICAgIG5vcm1hbGl6ZUV2ZW50cyA9IGZ1bmN0aW9uIChldmVudHMsIG5hbWVzcGFjZSkKICAgIHsKICAgICAgICBldmVudHMgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBldmVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnRzW2ldID0gZXZlbnRzW2ldICsgbmFtZXNwYWNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnRzLmpvaW4oJyAnKTsKICAgIH07CgogICAgLyoqCiAgICBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCgogICAgQG1ldGhvZCBfdHJpZ2dlcgogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7Qm9vbGVhbn0gYXN5bmMgRmlyZSBldmVudCBhc3luYyBvciBzeW5jCiAgICBAcGFyYW0ge09iamVjdH0gZXZlbnRzIFRoZSBldmVudHMgdG8gYmUgZmlyZWQuCiAgICAgICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICBAcGFyYW0gW2FyZ3NdKiBUaGUgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgY2FsbGJhY2sgbWV0aG9kcy4KICAgIEByZXR1cm5zIElmIGFzeW5jIHRoZW4gcmV0dXJucyBhIFByb21pc2UsIHdoZXJlIHRoZSBmaXJzdCBhcmd1bWVudCBjb250YWlucyBhbGwgdGhlIHJldHVybmVkIHZhbHVlcywgYXMgYW4gYXJyYXkKICAgICAgICAgICAgIElmIHN5bmMgdGhlbiByZXR1cm5zIGFuIGFycmF5IG9mIHRoZSByZXR1cm4gdmFsdWVzLgogICAgICAgICAgICAgSWYgbW9yZSB0aGFuIG9uZSBldmVudCwgcmV0dXJucyBhbiBvYmplY3Qgb2YgYXJyYXlzIG9yIHByb21pc2VzLCB3aXRoIHRoZSBrZXkgZm9yIGVhY2ggZXZlbnQuCiAgICAqKi8KICAgIF90cmlnZ2VyID0gZnVuY3Rpb24gKGFzeW5jLCBldmVudHMpCiAgICB7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBldmVudCwgbm9kZSwgY2FsbHMsIHRhaWwsIGFyZ3MsIGFsbCwgcmVzdCwgbmFtZXNwYWNlLCBvbmNlTm9kZXM7CiAgICAgICAgaWYgKCEoY2FsbHMgPSB0aGlzLl9jYWxsYmFja3MpKSByZXR1cm4gdGhhdDsKICAgICAgICBhbGwgPSBjYWxscy5hbGw7CiAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHJlc3QgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgogICAgICAgIHdoaWxlIChldmVudCA9IGV2ZW50cy5zaGlmdCgpKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKG5vZGUgPSBjYWxsc1tldmVudF0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJOb2Rlcyh0aGF0LCBldmVudCwgYXN5bmMsIG5vZGUsIHJlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID0gYWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyTm9kZXModGhhdCwgQUxMLCBhc3luYywgbm9kZSwgW2V2ZW50XS5jb25jYXQocmVzdCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgIFRyaWdnZXJzIGFsbCBldmVudHMgb24gYSBub2RlLgogICAgQWxzbyB1bmJpbmRzIGFueSBub2RlIHRoYXQgaXMgc2V0IHRvIG9ubHkgYmUgY2FsbGVkIG9uY2UuCgogICAgQG1ldGhvZCB0cmlnZ2VyTm9kZXMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGFpbmVyIGNvbnRleHQuCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGJlIGJvdW5kIG9yIHVuYm91bmQuCiAgICBAcGFyYW0ge0Jvb2xlYW59IGFzeW5jIEZpcmUgZXZlbnQgYXN5bmMgb3Igc3luYwogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0FycmF5fSBhcmdzIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSB0cmlnZ2VyZWQgbm9kZXMKCiAgICAqKi8KICAgIHRyaWdnZXJOb2RlcyA9IGZ1bmN0aW9uICh0aGF0LCBldmVudCwgYXN5bmMsIG5vZGVMaXN0LCBhcmdzKQogICAgewogICAgICAgIHZhciB0YWlsLCBvbmNlTm9kZXMgPSBbXTsKCiAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ3swfTogdHJpZ2dlcmluZyB7MX0gZXZlbnQgInsyfSInLCB0aGF0Ll9fcHViU3ViTmFtZSwgYXN5bmMgJiYgJ2FzeW5jJyB8fCAnJywgZXZlbnQpKTsKCiAgICAgICAgZWFjaChub2RlTGlzdCwgZnVuY3Rpb24gKG5vZGUpCiAgICAgICAgewogICAgICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgICAgICB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHQpICE9PSB0YWlsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyQ2FsbGJhY2soYXN5bmMsIG5vZGUuY2FsbGJhY2ssIG5vZGUuY29udGV4dCB8fCB0aGF0LCBhcmdzKTsKICAgICAgICAgICAgICAgIG5vZGUub25jZSAmJiBvbmNlTm9kZXMucHVzaChub2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmIChvbmNlTm9kZXMubGVuZ3RoKSBlYWNoKG9uY2VOb2RlcywgZnVuY3Rpb24gKHgpIHsgdGhhdC51bnN1YnNjcmliZShldmVudCwgeC5jYWxsYmFjaywgeC5jb250ZXh0LCB4Lm5hbWVzcGFjZSk7IH0pOwogICAgfTsKCiAgICAvKioKICAgIEludm9rZXMgYSB0cmlnZ2VyIGNhbGxiYWNrCgogICAgQG1ldGhvZCB0cmlnZ2VyQ2FsbGJhY2sKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0Jvb2xlYW59IGFzeW5jIEZpcmUgZXZlbnQgYXN5bmMgb3Igc3luYwogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZAogICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNhbGxpbmcgY29udGV4dAogICAgQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGguCiAgICBAcmV0dXJucyB7T2JqZWN0fSBUaGUgcmV0dXJuZWQgdmFsdWUuCiAgICAgICAgRm9yIGFzeW5jIGNhbGxzLCB0aGlzIGlzIGEgcHJvbWlzZQogICAgICAgIEZvciBzeW5jIGNhbGxzIHRoaXMgaXMgdGhlIHZhbHVlIGZyb20gdGhlIG1ldGhvZC4KICAgICoqLwogICAgdHJpZ2dlckNhbGxiYWNrID0gZnVuY3Rpb24gKGFzeW5jLCBjYWxsYmFjaywgY29udGV4dCwgYXJncykKICAgIHsKICAgICAgICBpZiAoYXN5bmMpCiAgICAgICAgewogICAgICAgICAgICBkZWZlcih0cmlnZ2VyQXN5bmNDYWxsYmFjayhjYWxsYmFjaywgY29udGV4dCwgYXJncyksIDApOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0cnkgeyByZXR1cm4gY2FsbGJhY2suYXBwbHkoY29udGV4dCwgYXJncyk7IH0KICAgICAgICAgICAgY2F0Y2ggKGUpIHsgaWYgKHRDb25maWcudGhyb3dFcnJvcnMpIHRocm93IGU7IH0KICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgQ3JlYXRlcyBhbiBhc3luYyBldmVudCBoYW5kbGVyCgogICAgQG1ldGhvZCBhc3luY0V2ZW50RmFjdG9yeQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QKICAgIEBwYXJhbSB7T2JqZWN0fSB0aGF0IFRoZSBjYWxsaW5nIGNvbnRleHQKICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBjYWxsIHRoZSBjYWxsYmFjayB3aXRoLgogICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgY2FsbGJhY2sgZm9yIHRoZSBnaXZlbiBhcmd1bWVudHMuCiAgICAqKi8KICAgIHRyaWdnZXJBc3luY0NhbGxiYWNrID0gZnVuY3Rpb24gKGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKQogICAgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgUmVzdWJzY3JpYmVzIHRvIHRoZSBhcHByb3ByaWF0ZSBldmVudHMKCiAgICBAbWV0aG9kIF9vZmZQcm9jZXNzTm9kZQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSB0aGF0IFRoZSBldmVudCBjb250ZXh0CiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50CiAgICBAcGFyYW0ge09iamVjdH0gbm9kZSBUaGUgbm9kZSBsaW5rZWQgbGlzdC4KICAgIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGV2ZW50IGNhbGxiYWNrIHRvIHVuc3Vic2NyaWJlCiAgICBAcGFyYW0ge09iamVjdH0gW2NvbnRleHRdIFRoZSBldmVudCBjb250ZXh0IHRvIHVuc3Vic2NyaWJlCiAgICBAcGFyYW0ge1N0cmluZ30gW25hbWVzcGFjZV0gVGhlIG5hbWVzcGFjZSB0byB1bnN1YnNjcmliZQogICAgKiovCiAgICBfb2ZmUHJvY2Vzc05vZGUgPSBmdW5jdGlvbiAodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KQogICAgewogICAgICAgIHZhciB0YWlsLCBjYiwgY3R4LCBuczsKICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgIHdoaWxlICgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpCiAgICAgICAgewogICAgICAgICAgICBjYiA9IG5vZGUuY2FsbGJhY2s7CiAgICAgICAgICAgIGN0eCA9IG5vZGUuY29udGV4dDsKICAgICAgICAgICAgbnMgPSBub2RlLm5hbWVzcGFjZTsKICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYiAhPT0gY2FsbGJhY2spIHx8IChjb250ZXh0ICYmIGN0eCAhPT0gY29udGV4dCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQuc3Vic2NyaWJlKGV2ZW50ICsgKG5zICYmICgnLicgKyBucykgfHwgJycpLCBjYiwgY3R4KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICBHZXRzIHRoZSBuYW1lc3BhY2UgaW5mb3JtYXRpb24sIHRoZSByZWFsIGV2ZW50IHRvIHBhc3MgYmFjayBvbnRvIHRoZSBtZXRob2RzLgoKICAgIEBtZXRob2QgZ2V0TmFtZXNwYWNlRGF0YQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudCBUaGUgZXZlbnQgdG8gY2FwdHVyZSBuYW1lc3BhY2UgZGF0YSBmcm9tLgogICAgQHJldHVybnMge09iamVjdH0gQ29udGFpbmluZyBldmVudCBhbmQgbmFtZXNwYWNlLgogICAgKiovCiAgICBnZXROYW1lc3BhY2VEYXRhID0gZnVuY3Rpb24oZXZlbnQpCiAgICB7CiAgICAgICAgdmFyIG5zSW5kZXggPSAoZXZlbnQgfHwgJycpLmluZGV4T2YoJy4nKSwKICAgICAgICAgICAgaGFzTnMgPSBuc0luZGV4ID4gLTEsCiAgICAgICAgICAgIG5hbWVzcGFjZSA9IGhhc05zID8gZXZlbnQuc3Vic3RyaW5nKG5zSW5kZXggKyAxKSA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgZXZlbnQgPSBoYXNOcyA/IGV2ZW50LnN1YnN0cmluZygwLCBuc0luZGV4KSA6IGV2ZW50OwoKICAgICAgICBpZiAobnNJbmRleCA9PT0gMCkKICAgICAgICAgICAgZXZlbnQgPSBTVEFSQUxMOwoKICAgICAgICByZXR1cm4geyBldmVudDogZXZlbnQsIG5hbWVzcGFjZTogbmFtZXNwYWNlIH07CiAgICB9OwoKICAgIC8qKgogICAgVGhydXN0IEV2ZW50cyBhcmUgYmFzZWQgb2ZmIG9mIHRoZSBCYWNrYm9uZSBldmVudCBtb2RlbCwgd2l0aCBzcGVjaWFsIGFkZGl0aW9ucy4KCiAgICAqIEV2ZW50cyBjYW4gYmUgZmlyZWQgYXN5bmNyb25vdXNseS4KICAgICogRXZlbnRzIGNhbiBiZSBuYW1lc3BhY2VkLgoKICAgIEBjbGFzcyBFdmVudHMKICAgICoqLwogICAgdmFyIEV2ZW50cyA9IHsKICAgICAgICAvKioKICAgICAgICBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgICAgICBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KCiAgICAgICAgQG1ldGhvZCBzdWJzY3JpYmUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBvbmNlIENhbGwgdGhpcyBldmVudCBvbmx5IG9uY2UuCiAgICAgICAgQGNoYWluYWJsZQogICAgICAgICoqLwogICAgICAgIHN1YnNjcmliZTogZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIG9uY2UpCiAgICAgICAgewogICAgICAgICAgICB2YXIgY2FsbHMsIGV2ZW50LCBub2RlLCB0YWlsLCBsaXN0LCBuZDsKICAgICAgICAgICAgdGhpcy5fX25hbWVzcGFjZSAmJiAoZXZlbnRzID0gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgdGhpcy5fX25hbWVzcGFjZSkpOwoKICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICAgICAgICBjYWxscyA9IHRoaXMuX2NhbGxiYWNrcyB8fCAodGhpcy5fY2FsbGJhY2tzID0ge30pOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIGFuIGltbXV0YWJsZSBjYWxsYmFjayBsaXN0LCBhbGxvd2luZyB0cmF2ZXJzYWwgZHVyaW5nCiAgICAgICAgICAgIC8vIG1vZGlmaWNhdGlvbi4gIFRoZSB0YWlsIGlzIGFuIGVtcHR5IG9iamVjdCB0aGF0IHdpbGwgYWx3YXlzIGJlIHVzZWQKICAgICAgICAgICAgLy8gYXMgdGhlIG5leHQgbm9kZS4KICAgICAgICAgICAgd2hpbGUgKGV2ZW50ID0gZXZlbnRzLnNoaWZ0KCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5kID0gZ2V0TmFtZXNwYWNlRGF0YShldmVudCk7CiAgICAgICAgICAgICAgICBldmVudCA9IG5kLmV2ZW50OwogICAgICAgICAgICAgICAgbGlzdCA9IGNhbGxzW2V2ZW50XSB8fCAoY2FsbHNbZXZlbnRdID0ge30pOwogICAgICAgICAgICAgICAgbGlzdCA9IGxpc3RbbmQubmFtZXNwYWNlXTsKICAgICAgICAgICAgICAgIG5vZGUgPSBsaXN0ID8gbGlzdC50YWlsIDoge307CiAgICAgICAgICAgICAgICBub2RlLm5leHQgPSB0YWlsID0ge307CiAgICAgICAgICAgICAgICBub2RlLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgICAgICAgbm9kZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgbm9kZS5uYW1lc3BhY2UgPSBuZC5uYW1lc3BhY2U7CiAgICAgICAgICAgICAgICBub2RlLm9uY2UgPSBvbmNlOwogICAgICAgICAgICAgICAgY2FsbHNbZXZlbnRdW25kLm5hbWVzcGFjZV0gPSB7IHRhaWw6IHRhaWwsIG5leHQ6IGxpc3QgPyBsaXN0Lm5leHQgOiBub2RlIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgQmluZCBvbmUgb3IgbW9yZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnRzLCBgZXZlbnRzYCwgdG8gYSBgY2FsbGJhY2tgCiAgICAgICAgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCgogICAgICAgIEVhY2ggZXZlbnQgd2lsbCBvbmx5IGJlIGNhbGxlZCBvbmNlLgoKICAgICAgICBAbWV0aG9kIG9uY2UKICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgQGNoYWluYWJsZQogICAgICAgICoqLwogICAgICAgIG9uY2U6IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlKGV2ZW50cywgb25jZUNhbGxiYWNrLCBjb250ZXh0LCB0cnVlKTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MKICAgICAgICB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgY2FsbGJhY2tzIGZvciB0aGUKICAgICAgICBldmVudC4gSWYgYGV2ZW50YCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZCBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCgogICAgICAgIEBtZXRob2QgdW5zdWJzY3JpYmUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgQGNoYWluYWJsZQogICAgICAgICoqLwogICAgICAgIHVuc3Vic2NyaWJlOiBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBldmVudCwgY2FsbHMsIG5vZGUsIG5kLCBvdXJOcywgbmFtZXNwYWNlLCB0aGF0ID0gdGhpcywgaGFzTnM7CgogICAgICAgICAgICBvdXJOcyA9IHRoYXQuX19uYW1lc3BhY2U7IG91ck5zICYmIChvdXJOcyA9IG91ck5zLnN1YnN0cmluZygxKSk7CiAgICAgICAgICAgIC8vIE5vIGV2ZW50cywgb3IgcmVtb3ZpbmcgKmFsbCogZXZlbnRzLgogICAgICAgICAgICBpZiAoIShjYWxscyA9IHRoYXQuX2NhbGxiYWNrcykpIHJldHVybjsKICAgICAgICAgICAgaWYgKCEoZXZlbnRzIHx8IGNhbGxiYWNrIHx8IGNvbnRleHQpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIW91ck5zKQogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGF0Ll9jYWxsYmFja3M7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNicyA9IHRoYXQuX2NhbGxiYWNrczsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGNicykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYnNbaV1bb3VyTnNdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2l6ZShjYnNbaV0pID09PSAwKSBkZWxldGUgY2JzW2ldOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGF0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggdGhlIGxpc3RlZCBldmVudHMgYW5kIGNvbnRleHRzLCBzcGxpY2luZyB0aGVtIG91dCBvZiB0aGUKICAgICAgICAgICAgLy8gbGlua2VkIGxpc3Qgb2YgY2FsbGJhY2tzIGlmIGFwcHJvcHJpYXRlLgogICAgICAgICAgICBvdXJOcyAmJiAoZXZlbnRzID0gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgdGhhdC5fX25hbWVzcGFjZSkpOwogICAgICAgICAgICBldmVudHMgPSBldmVudHMgPyBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcikgOiBfLmtleXMoY2FsbHMpOwogICAgICAgICAgICB3aGlsZSAoZXZlbnQgPSBldmVudHMuc2hpZnQoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmQgPSBnZXROYW1lc3BhY2VEYXRhKGV2ZW50KTsKICAgICAgICAgICAgICAgIGV2ZW50ID0gbmQuZXZlbnQ7CiAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBuZC5uYW1lc3BhY2U7CiAgICAgICAgICAgICAgICBoYXNOcyA9ICEhbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgaWYgKCFvdXJOcykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChjYWxsc1tldmVudF0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2V2ZW50XVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgaWYgKHNpemUoY2FsbHNbZXZlbnRdKSA9PT0gMCkgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghbm9kZSB8fCAhKGNhbGxiYWNrIHx8IGNvbnRleHQpKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAvKmlmIChldmVudCAhPT0gU1RBUkFMTCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgaWYgKCFub2RlKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0qLwogICAgICAgICAgICAgICAgaWYgKGV2ZW50ICE9PSBTVEFSQUxMICYmICFjYWxsYmFjaykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGV2ZW50ID09PSBBTEwgfHwgIWNhbGxiYWNrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gY2FsbHMpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzTnMpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBpLCBub2RlLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgX29mZlByb2Nlc3NOb2RlKHRoYXQsIGV2ZW50LCBub2RlLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoYXQ7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAgICAgICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgICAgICAgICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIGZpcmUKICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IGV2ZW50cyBUaGUgZXZlbnRzIHRvIGJlIGZpcmVkLgogICAgICAgICAgICAgICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICAgICAgICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgICAgICAgICBAcmV0dXJucyB7QXJyYXkgb2YgVmFsdWVzfSBJZiBtb3JlIHRoYW4gb24gZXZlbnQgaXMgZmlyZWQsIGFuIE9iamVjdCBvZiBBcnJheXMgaXMgcmV0dXJuZWQuCiAgICAgICAgKiovCiAgICAgICAgZmlyZTogZnVuY3Rpb24gKGV2ZW50cykKICAgICAgICB7CiAgICAgICAgICAgIF90cmlnZ2VyLmFwcGx5KHRoaXMsIFtmYWxzZV0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIF9fcHViU3ViTmFtZTogJ0V2ZW50cycsCiAgICAgICAgLyoqCiAgICAgICAgSW5pdCdzIHRoZSBFdmVudCBtb2R1bGUuCiAgICAgICAgVGhpcyBpcyBvbmx5IHJlcXVpcmVkIGlmIHlvdSB3aXNoIHRvIHVzZSBmaXJlLmFzeW5jLCBhbmQgbmFtZXNwYWNpbmcuCgogICAgICAgIEBtZXRob2QgaW5pdEV2ZW50cwogICAgICAgIEBjaGFpbmFibGUKICAgICAgICAqKi8KICAgICAgICBpbml0RXZlbnRzOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5wdWJsaXNoID0gdGhpcy5maXJlID0gRXZlbnRzLmZpcmUuYmluZCh0aGlzKTsKICAgICAgICAgICAgdGhpcy5maXJlLmFzeW5jID0gYXN5bmNGaXJlLmJpbmQodGhpcyk7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cyA9IG5vb3A7CiAgICAgICAgICAgIHRoaXMuX19wdWJTdWJOYW1lID0gdGhpcy5uYW1lIHx8ICdFdmVudHMnOwogICAgICAgICAgICBpZiAodGhpcy5uYW1lICYmICF0aGlzLl9fbmFtZXNwYWNlKSB0aGlzLl9fbmFtZXNwYWNlID0gJy4nICsgdGhpcy5uYW1lOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBFeHRlbmRzIEV2ZW50cyBpbnRvIHRoZSBnaXZlbiBvYmplY3QuCgogICAgICAgIEBtZXRob2QgZXh0ZW5kCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHRvIFRoZSBvYmplY3Qgb3QgZXh0ZW5kIGV2ZW50cyBvbnRvCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBbaW5pdF0gT3B0aW9uYWxseSBpbml0IHRoZSBldmVudHMuCiAgICAgICAgKiovCiAgICAgICAgZXh0ZW5kOiBmdW5jdGlvbiAodG8sIGluaXQpCiAgICAgICAgewogICAgICAgICAgICBleHRlbmQodG8sIEV2ZW50cyk7CiAgICAgICAgICAgIGRlbGV0ZSB0by5leHRlbmQ7CiAgICAgICAgICAgIGluaXQgJiYgdG8uaW5pdEV2ZW50cygpOwogICAgICAgICAgICByZXR1cm4gdG87CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAgICBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgICAgICBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgICAgICByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCgogICAgICAgIGZpcmUuYXN5bmMgcnVucyBpdHMgZXZlbnRzIGltbWVkaWF0ZWx5LgogICAgCiAgICAgICAgQG1ldGhvZCBmaXJlLmFzeW5jCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGV2ZW50cyBUaGUgZXZlbnRzIHRvIGJlIGZpcmVkLgogICAgICAgICAgICBkZWxpbWl0ZWQgYnkgYSBzcGFjZS4KICAgICAgICBAcGFyYW0gW2FyZ3NdKiBUaGUgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgY2FsbGJhY2sgbWV0aG9kcy4KICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7QXJyYXkgb2YgUHJvbWlzZX0gSWYgbW9yZSB0aGFuIG9uIGV2ZW50IGlzIGZpcmVkLCBhbiBPYmplY3Qgb2YgUHJvbWlzZSBBcnJheXMgaXMgcmV0dXJuZWQuCiAgICAqKi8KICAgIC8qKgogICAgICAgIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgICAgIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KCiAgICAgICAgcHVibGlzaC5hc3luYyBydW5zIGl0cyBldmVudHMgaW1tZWRpYXRlbHkuCiAgICAgICAgcHVibGlzaC5hc3luYyBpcyBhbiBhbGlhcyBmb3IgZmlyZS4KICAgIAogICAgICAgIEBtZXRob2QgcHVibGlzaC5hc3luYwogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgICAgICAgICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICAgICAgQHBhcmFtIFthcmdzXSogVGhlIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIGNhbGxiYWNrIG1ldGhvZHMuCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge0FycmF5IG9mIFByb21pc2V9IElmIG1vcmUgdGhhbiBvbiBldmVudCBpcyBmaXJlZCwgYW4gT2JqZWN0IG9mIFByb21pc2UgQXJyYXlzIGlzIHJldHVybmVkLgogICAgKiovCiAgICBhc3luY0ZpcmUgPSBmdW5jdGlvbiAoZXZlbnRzKQogICAgewogICAgICAgIF90cmlnZ2VyLmFwcGx5KHRoaXMsIFt0cnVlXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIC8qKgogICAgICAgIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgICAgIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KCiAgICAgICAgcHVibGlzaCBpcyBhbiBhbGlhcyBmb3IgZmlyZS4KICAgIAogICAgICAgIEBtZXRob2QgcHVibGlzaAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgICAgICAgICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICAgICAgQHBhcmFtIFthcmdzXSogVGhlIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIGNhbGxiYWNrIG1ldGhvZHMuCiAgICAgICAgQHJldHVybnMgSWYgYXN5bmMgdGhlbiByZXR1cm5zIGEgUHJvbWlzZSwgd2hlcmUgdGhlIGZpcnN0IGFyZ3VtZW50IGNvbnRhaW5zIGFsbCB0aGUgcmV0dXJuZWQgdmFsdWVzLCBhcyBhbiBhcnJheQogICAgICAgICAgICAgICAgIElmIHN5bmMgdGhlbiByZXR1cm5zIGFuIGFycmF5IG9mIHRoZSByZXR1cm4gdmFsdWVzLgogICAgICAgICAgICAgICAgIElmIG1vcmUgdGhhbiBvbmUgZXZlbnQsIHJldHVybnMgYW4gb2JqZWN0IG9mIGFycmF5cyBvciBwcm9taXNlcywgd2l0aCB0aGUga2V5IGZvciBlYWNoIGV2ZW50LgogICAgKiovCiAgICBFdmVudHMucHVibGlzaCA9IEV2ZW50cy5maXJlOwoKICAgIHJldHVybiBFdmVudHM7Cn0pOwoKZGVmaW5lKCd0aHJ1c3QvZmFjYWRlJyxbCiAgICAndGhydXN0L3V0aWwnLCAndGhydXN0L21vZHVsZScKXSwKZnVuY3Rpb24gKHV0aWwsIE1vZHVsZSkKewogICAgLyoqCgogICAgVGhlIEZhY2FkZSBtb2R1bGUgb2ZmZXJzIHRoZSBhYmlsaXR5IHRvIGNyZWF0ZSBhbiBpbnRlcmZhY2Ugb3Igc2ltaWxhciBjb25jZXB0LgogICAgV2l0aCB0aGUgRmFjYWRlIGluIHRocnVzdCwgaXQgYWxsb3dzIHlvdSB0byBjYXB0dXJlIGV2ZW50cyBmcm9tIGEgbW9kdWxlLCB3aGVuIGxvYWRlZCB2aWEgY29udmVudGlvbi4KICAgIEZhY2FkZXMgYXJlIG1haW5seSBmb3IgdXNlIGluIHRocnVzdCBwbHVnaW5zLgoKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAc3VibW9kdWxlIEZhY2FkZQogICAgKiovCgogICAgLyoqCiAgICBGYWNhZGVzIGFyZSBtYWlubHkgZm9yIHVzZSBpbiB0aHJ1c3QgcGx1Z2lucy4KCiAgICBGYWNhZGUgaGFzIHRoZXNlIGJ1aWx0IGluIG1ldGhvZHM6CiAgICAqIGluaXQKICAgICogc3RhcnQKICAgICogcmVhZHkKICAgICogc3RvcAogICAgKiBkZXN0cm95CgogICAgQmVoaW5kIHRoZSBzY2VuZXMgdGhlIGZhY2FkZSBtZXRob2RzLCBpbnZva2UgYW55IGNvbnZlbnRpb25zIGxvYWRlZCBmb3IgdGhlIHBsdWdpbi4KCiAgICBAY2xhc3MgRmFjYWRlCiAgICAqKi8KICAgIHZhciB0aHJ1c3RDYWNoZSA9IE1vZHVsZS50aHJ1c3RDYWNoZTsKCiAgICB2YXIgRmFjYWRlLAogICAgICAgIGZvcm1hdCAgICAgICAgICAgPSB1dGlsLmZvcm1hdCwKICAgICAgICBmYWNhZGVNZXRob2RzICAgID0gWydpbml0JywgJ3N0YXJ0JywgJ3JlYWR5JywgJ3N0b3AnLCAnZGVzdHJveSddLAogICAgICAgIGRlZmF1bHRQcm90b3R5cGUgPSB7fSwKCiAgICAgICAgY29udmVudGlvbkZ1bmN0aW9uRmFjdG9yeSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAobW9kdWxlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWVzID0gW107CiAgICAgICAgICAgICAgICBpZiAobW9kdWxlICYmICFtb2R1bGUuY29udmVudGlvbikKICAgICAgICAgICAgICAgICAgICBtb2R1bGUgPSB0aHJ1c3RDYWNoZVttb2R1bGUubWlkXS5tb2R1bGU7CiAgICAgICAgICAgICAgICBpZiAodGhhdC5fX2NvbnZlbnRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIG5hbWUsIHRoYXQsIG1vZHVsZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBtZXRob2RXcmFwID0gZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGYpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgICAgIGYuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9OwogICAgICAgIH07CgogICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBmYWNhZGVNZXRob2RzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgIHsKICAgICAgICB2YXIgbWV0aG9kID0gZmFjYWRlTWV0aG9kc1tpXTsKICAgICAgICBkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0gPSBjb252ZW50aW9uRnVuY3Rpb25GYWN0b3J5KG1ldGhvZCk7CiAgICB9CgogICAgLyoqCiAgICBGYWNhZGUgaW5pdAoKICAgIENhbGxlZCBkdXJpbmcgdGhlIGluaXQgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KCiAgICBAbWV0aG9kIGluaXQKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KCiAgICAvKioKICAgIEZhY2FkZSBzdGFydAoKICAgIENhbGxlZCBkdXJpbmcgdGhlIHN0YXJ0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCgogICAgQG1ldGhvZCBzdGFydAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwoKICAgIC8qKgogICAgRmFjYWRlIHJlYWR5CgogICAgQ2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KCiAgICBAbWV0aG9kIHJlYWR5CiAgICBAcmV0dXJucyBQcm9taXNlIGFueSBmYWNhZGUgbWV0aG9kIG1heSBvcHRpb25hbGx5IHJldHVybiBhIHByb21pc2UgdG8gZGVsYXkgdGhlIHN0YXJ0IG9mIHRoZSBuZXh0IHBoYXNlLgogICAgKiovCgogICAgLyoqCiAgICBGYWNhZGUgc3RvcAoKICAgIENhbGxlZCBkdXJpbmcgdGhlIGluaXQgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KCiAgICBAbWV0aG9kIHN0b3AKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KCiAgICAvKioKICAgIEZhY2FkZSBkZXN0cm95CgogICAgQ2FsbGVkIGR1cmluZyB0aGUgZGVzdHJveSBwaGFzZSBvZiBhIG1vZHVsZSBzdGFydHVwLgoKICAgIEBtZXRob2QgZGVzdHJveQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwoKICAgIHJldHVybiB7CiAgICAgICAgLyoqCiAgICAgICAgQU1EIEFQSQogICAgICAgIGxvYWQKCiAgICAgICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIG1vZHVsZSBpbnN0YW5jZQoKICAgICAgICBAbWV0aG9kIGxvYWQKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgKiovCiAgICAgICAgbG9hZDogZnVuY3Rpb24gKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwKICAgICAgICAgICAgICAgIGluc3RhbmNlTmFtZSA9IHBhcnRzWzBdLAogICAgICAgICAgICAgICAgcGx1Z2luTmFtZSA9IHBhcnRzWzFdLAogICAgICAgICAgICAgICAgbW9kdWxlUGF0aCA9IHBhcnRzWzJdOwoKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZU5hbWUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc3RhbmNlTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICAgICAgaWYgKCFwbHVnaW5OYW1lKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwbHVnaW5OYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgICAgICBpZiAoIW1vZHVsZVBhdGgpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ21vZHVsZVBhdGggaXMgcmVxdWlyZWQhJyk7CgogICAgICAgICAgICByZXF1aXJlKFsndGhydXN0IScgKyBpbnN0YW5jZU5hbWVdLCBmdW5jdGlvbiAodGhydXN0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcGx1Z2luID0gdGhydXN0W3BsdWdpbk5hbWVdOwogICAgICAgICAgICAgICAgaWYgKCFwbHVnaW4pCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnUGx1Z2luICJ7MH0iIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiezF9Ii4nLCBwbHVnaW5OYW1lLCBpbnN0YW5jZU5hbWUpKTsKCiAgICAgICAgICAgICAgICB2YXIga2V5ID0gdGhydXN0Lm5hbWUgKyAnOicgKyBtb2R1bGVQYXRoLAogICAgICAgICAgICAgICAgICAgIHJlYWxOYW1lID0gdXRpbC5nZXRNb2R1bGVOYW1lRm9yUGF0aChtb2R1bGVQYXRoKSwKICAgICAgICAgICAgICAgICAgICB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0gPSB0aHJ1c3RDYWNoZVtrZXldIHx8ICh0aHJ1c3RDYWNoZVtrZXldID0geyBuYW1lOiByZWFsTmFtZSwgbWlkOiBrZXksIGZhY2FkZXM6IHt9LCBpbnN0YW5jZTogeyBuYW1lOiByZWFsTmFtZSB9IH0pOwoKICAgICAgICAgICAgICAgIHZhciBmYWNhZGUgPSBwbHVnaW4uY3JlYXRlRmFjYWRlKHRocnVzdCwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uZmFjYWRlcyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvYWQoZmFjYWRlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBjcmVhdGVGYWNhZGU6IGZ1bmN0aW9uKGluaXRNZXRob2QpCiAgICAgICAgewogICAgICAgICAgICB2YXIgRmFjYWRlID0gZnVuY3Rpb24gKG1vZHVsZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaW5pdE1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gZmFjYWRlTWV0aG9kcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbbWV0aG9kXSAhPT0gZGVmYXVsdFByb3RvdHlwZVttZXRob2RdKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1ttZXRob2RdID0gdXRpbC53cmFwKHRoaXNbbWV0aG9kXSwgbWV0aG9kV3JhcChkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgICAgICAvL3RoaXMuaW5pdChtb2R1bGUpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgRmFjYWRlLmZuID0gRmFjYWRlLnByb3RvdHlwZSA9IHV0aWwuZXh0ZW5kKHsKICAgICAgICAgICAgICAgIHVwZGF0ZUZhY2FkZTogZnVuY3Rpb24gKCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpbml0TWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGRlZmF1bHRQcm90b3R5cGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIEZhY2FkZTsKICAgICAgICB9CiAgICB9Owp9KTsKLyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuOC4wcHJlCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBDb3B5cmlnaHQgKGMpIDIwMTIgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICogQ29weXJpZ2h0IDIwMTIsIFRoZSBEb2pvIEZvdW5kYXRpb24KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCwgQlNELCBhbmQgR1BMIExpY2Vuc2VzLgogKgogKiBEYXRlOiBXZWQgQXVnIDAxIDIwMTIgMDE6NTE6NTIgR01ULTA2MDAgKE1vdW50YWluIERheWxpZ2h0IFRpbWUpCiAqLwooZnVuY3Rpb24oIHdpbmRvdywgdW5kZWZpbmVkICkgewp2YXIKCS8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQoJcm9vdGpRdWVyeSwKCgkvLyBUaGUgZGVmZXJyZWQgdXNlZCBvbiBET00gcmVhZHkKCXJlYWR5TGlzdCwKCgkvLyBVc2UgdGhlIGNvcnJlY3QgZG9jdW1lbnQgYWNjb3JkaW5nbHkgd2l0aCB3aW5kb3cgYXJndW1lbnQgKHNhbmRib3gpCglkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKCWxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uLAoJbmF2aWdhdG9yID0gd2luZG93Lm5hdmlnYXRvciwKCgkvLyBNYXAgb3ZlciBqUXVlcnkgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV9qUXVlcnkgPSB3aW5kb3cualF1ZXJ5LAoKCS8vIE1hcCBvdmVyIHRoZSAkIGluIGNhc2Ugb2Ygb3ZlcndyaXRlCglfJCA9IHdpbmRvdy4kLAoKCS8vIFNhdmUgYSByZWZlcmVuY2UgdG8gc29tZSBjb3JlIG1ldGhvZHMKCWNvcmVfcHVzaCA9IEFycmF5LnByb3RvdHlwZS5wdXNoLAoJY29yZV9zbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKCWNvcmVfaW5kZXhPZiA9IEFycmF5LnByb3RvdHlwZS5pbmRleE9mLAoJY29yZV90b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCgljb3JlX2hhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCgljb3JlX3RyaW0gPSBTdHJpbmcucHJvdG90eXBlLnRyaW0sCgoJLy8gRGVmaW5lIGEgbG9jYWwgY29weSBvZiBqUXVlcnkKCWpRdWVyeSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCApIHsKCQkvLyBUaGUgalF1ZXJ5IG9iamVjdCBpcyBhY3R1YWxseSBqdXN0IHRoZSBpbml0IGNvbnN0cnVjdG9yICdlbmhhbmNlZCcKCQlyZXR1cm4gbmV3IGpRdWVyeS5mbi5pbml0KCBzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeSApOwoJfSwKCgkvLyBVc2VkIGZvciBtYXRjaGluZyBudW1iZXJzCgljb3JlX3BudW0gPSAvW1wtK10/KD86XGQqXC58KVxkKyg/OltlRV1bXC0rXT9cZCt8KS8uc291cmNlLAoKCS8vIFVzZWQgZm9yIGRldGVjdGluZyBhbmQgdHJpbW1pbmcgd2hpdGVzcGFjZQoJY29yZV9ybm90d2hpdGUgPSAvXFMvLAoJY29yZV9yc3BhY2UgPSAvXHMrLywKCgkvLyBJRSBkb2Vzbid0IG1hdGNoIG5vbi1icmVha2luZyBzcGFjZXMgd2l0aCBccwoJcnRyaW0gPSBjb3JlX3Jub3R3aGl0ZS50ZXN0KCJceEEwIikgPyAoL15bXHNceEEwXSt8W1xzXHhBMF0rJC9nKSA6IC9eXHMrfFxzKyQvZywKCgkvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncwoJLy8gUHJpb3JpdGl6ZSAjaWQgb3ZlciA8dGFnPiB0byBhdm9pZCBYU1MgdmlhIGxvY2F0aW9uLmhhc2ggKCM5NTIxKQoJcnF1aWNrRXhwciA9IC9eKD86W14jPF0qKDxbXHdcV10rPilbXj5dKiR8IyhbXHdcLV0qKSQpLywKCgkvLyBNYXRjaCBhIHN0YW5kYWxvbmUgdGFnCglyc2luZ2xlVGFnID0gL148KFx3KylccypcLz8+KD86PFwvXDE+fCkkLywKCgkvLyBKU09OIFJlZ0V4cAoJcnZhbGlkY2hhcnMgPSAvXltcXSw6e31cc10qJC8sCglydmFsaWRicmFjZXMgPSAvKD86Xnw6fCwpKD86XHMqXFspKy9nLAoJcnZhbGlkZXNjYXBlID0gL1xcKD86WyJcXFwvYmZucnRdfHVbXGRhLWZBLUZdezR9KS9nLAoJcnZhbGlkdG9rZW5zID0gLyJbXiJcXFxyXG5dKiJ8dHJ1ZXxmYWxzZXxudWxsfC0/KD86XGRcZCpcLnwpXGQrKD86W2VFXVtcLStdP1xkK3wpL2csCgoJLy8gTWF0Y2hlcyBkYXNoZWQgc3RyaW5nIGZvciBjYW1lbGl6aW5nCglybXNQcmVmaXggPSAvXi1tcy0vLAoJcmRhc2hBbHBoYSA9IC8tKFtcZGEtel0pL2dpLAoKCS8vIFVzZWQgYnkgalF1ZXJ5LmNhbWVsQ2FzZSBhcyBjYWxsYmFjayB0byByZXBsYWNlKCkKCWZjYW1lbENhc2UgPSBmdW5jdGlvbiggYWxsLCBsZXR0ZXIgKSB7CgkJcmV0dXJuICggbGV0dGVyICsgIiIgKS50b1VwcGVyQ2FzZSgpOwoJfSwKCgkvLyBUaGUgcmVhZHkgZXZlbnQgaGFuZGxlciBhbmQgc2VsZiBjbGVhbnVwIG1ldGhvZAoJRE9NQ29udGVudExvYWRlZCA9IGZ1bmN0aW9uKCkgewoJCWlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggIkRPTUNvbnRlbnRMb2FkZWQiLCBET01Db250ZW50TG9hZGVkLCBmYWxzZSApOwoJCQlqUXVlcnkucmVhZHkoKTsKCQl9IGVsc2UgaWYgKCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewoJCQkvLyB3ZSdyZSBoZXJlIGJlY2F1c2UgcmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiBpbiBvbGRJRQoJCQkvLyB3aGljaCBpcyBnb29kIGVub3VnaCBmb3IgdXMgdG8gY2FsbCB0aGUgZG9tIHJlYWR5IQoJCQlkb2N1bWVudC5kZXRhY2hFdmVudCggIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIERPTUNvbnRlbnRMb2FkZWQgKTsKCQkJalF1ZXJ5LnJlYWR5KCk7CgkJfQoJfSwKCgkvLyBbW0NsYXNzXV0gLT4gdHlwZSBwYWlycwoJY2xhc3MydHlwZSA9IHt9OwoKalF1ZXJ5LmZuID0galF1ZXJ5LnByb3RvdHlwZSA9IHsKCWNvbnN0cnVjdG9yOiBqUXVlcnksCglpbml0OiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJvb3RqUXVlcnkgKSB7CgkJdmFyIG1hdGNoLCBlbGVtLCByZXQsIGRvYzsKCgkJLy8gSGFuZGxlICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gSGFuZGxlICQoRE9NRWxlbWVudCkKCQlpZiAoIHNlbGVjdG9yLm5vZGVUeXBlICkgewoJCQl0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBIYW5kbGUgSFRNTCBzdHJpbmdzCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewoJCQlpZiAoIHNlbGVjdG9yLmNoYXJBdCgwKSA9PT0gIjwiICYmIHNlbGVjdG9yLmNoYXJBdCggc2VsZWN0b3IubGVuZ3RoIC0gMSApID09PSAiPiIgJiYgc2VsZWN0b3IubGVuZ3RoID49IDMgKSB7CgkJCQkvLyBBc3N1bWUgdGhhdCBzdHJpbmdzIHRoYXQgc3RhcnQgYW5kIGVuZCB3aXRoIDw+IGFyZSBIVE1MIGFuZCBza2lwIHRoZSByZWdleCBjaGVjawoJCQkJbWF0Y2ggPSBbIG51bGwsIHNlbGVjdG9yLCBudWxsIF07CgoJCQl9IGVsc2UgewoJCQkJbWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoIHNlbGVjdG9yICk7CgkJCX0KCgkJCS8vIE1hdGNoIGh0bWwgb3IgbWFrZSBzdXJlIG5vIGNvbnRleHQgaXMgc3BlY2lmaWVkIGZvciAjaWQKCQkJaWYgKCBtYXRjaCAmJiAobWF0Y2hbMV0gfHwgIWNvbnRleHQpICkgewoKCQkJCS8vIEhBTkRMRTogJChodG1sKSAtPiAkKGFycmF5KQoJCQkJaWYgKCBtYXRjaFsxXSApIHsKCQkJCQljb250ZXh0ID0gY29udGV4dCBpbnN0YW5jZW9mIGpRdWVyeSA/IGNvbnRleHRbMF0gOiBjb250ZXh0OwoJCQkJCWRvYyA9ICggY29udGV4dCAmJiBjb250ZXh0Lm5vZGVUeXBlID8gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgOiBkb2N1bWVudCApOwoKCQkJCQkvLyBzY3JpcHRzIGlzIHRydWUgZm9yIGJhY2stY29tcGF0CgkJCQkJc2VsZWN0b3IgPSBqUXVlcnkucGFyc2VIVE1MKCBtYXRjaFsxXSwgZG9jLCB0cnVlICk7CgkJCQkJaWYgKCByc2luZ2xlVGFnLnRlc3QoIG1hdGNoWzFdICkgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3QoIGNvbnRleHQgKSApIHsKCQkJCQkJdGhpcy5hdHRyLmNhbGwoIHNlbGVjdG9yLCBjb250ZXh0LCB0cnVlICk7CgkJCQkJfQoKCQkJCQlyZXR1cm4galF1ZXJ5Lm1lcmdlKCB0aGlzLCBzZWxlY3RvciApOwoKCQkJCS8vIEhBTkRMRTogJCgjaWQpCgkJCQl9IGVsc2UgewoJCQkJCWVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbWF0Y2hbMl0gKTsKCgkJCQkJLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKCQkJCQkvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCgkJCQkJaWYgKCBlbGVtICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQkJLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIElFIGFuZCBPcGVyYSByZXR1cm4gaXRlbXMKCQkJCQkJLy8gYnkgbmFtZSBpbnN0ZWFkIG9mIElECgkJCQkJCWlmICggZWxlbS5pZCAhPT0gbWF0Y2hbMl0gKSB7CgkJCQkJCQlyZXR1cm4gcm9vdGpRdWVyeS5maW5kKCBzZWxlY3RvciApOwoJCQkJCQl9CgoJCQkJCQkvLyBPdGhlcndpc2UsIHdlIGluamVjdCB0aGUgZWxlbWVudCBkaXJlY3RseSBpbnRvIHRoZSBqUXVlcnkgb2JqZWN0CgkJCQkJCXRoaXMubGVuZ3RoID0gMTsKCQkJCQkJdGhpc1swXSA9IGVsZW07CgkJCQkJfQoKCQkJCQl0aGlzLmNvbnRleHQgPSBkb2N1bWVudDsKCQkJCQl0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9CgoJCQkvLyBIQU5ETEU6ICQoZXhwciwgJCguLi4pKQoJCQl9IGVsc2UgaWYgKCAhY29udGV4dCB8fCBjb250ZXh0LmpxdWVyeSApIHsKCQkJCXJldHVybiAoIGNvbnRleHQgfHwgcm9vdGpRdWVyeSApLmZpbmQoIHNlbGVjdG9yICk7CgoJCQkvLyBIQU5ETEU6ICQoZXhwciwgY29udGV4dCkKCQkJLy8gKHdoaWNoIGlzIGp1c3QgZXF1aXZhbGVudCB0bzogJChjb250ZXh0KS5maW5kKGV4cHIpCgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gdGhpcy5jb25zdHJ1Y3RvciggY29udGV4dCApLmZpbmQoIHNlbGVjdG9yICk7CgkJCX0KCgkJLy8gSEFORExFOiAkKGZ1bmN0aW9uKQoJCS8vIFNob3J0Y3V0IGZvciBkb2N1bWVudCByZWFkeQoJCX0gZWxzZSBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBzZWxlY3RvciApICkgewoJCQlyZXR1cm4gcm9vdGpRdWVyeS5yZWFkeSggc2VsZWN0b3IgKTsKCQl9CgoJCWlmICggc2VsZWN0b3Iuc2VsZWN0b3IgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yLnNlbGVjdG9yOwoJCQl0aGlzLmNvbnRleHQgPSBzZWxlY3Rvci5jb250ZXh0OwoJCX0KCgkJcmV0dXJuIGpRdWVyeS5tYWtlQXJyYXkoIHNlbGVjdG9yLCB0aGlzICk7Cgl9LAoKCS8vIFN0YXJ0IHdpdGggYW4gZW1wdHkgc2VsZWN0b3IKCXNlbGVjdG9yOiAiIiwKCgkvLyBUaGUgY3VycmVudCB2ZXJzaW9uIG9mIGpRdWVyeSBiZWluZyB1c2VkCglqcXVlcnk6ICIxLjguMHByZSIsCgoJLy8gVGhlIGRlZmF1bHQgbGVuZ3RoIG9mIGEgalF1ZXJ5IG9iamVjdCBpcyAwCglsZW5ndGg6IDAsCgoJLy8gVGhlIG51bWJlciBvZiBlbGVtZW50cyBjb250YWluZWQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQKCXNpemU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmxlbmd0aDsKCX0sCgoJdG9BcnJheTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGNvcmVfc2xpY2UuY2FsbCggdGhpcyApOwoJfSwKCgkvLyBHZXQgdGhlIE50aCBlbGVtZW50IGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0IE9SCgkvLyBHZXQgdGhlIHdob2xlIG1hdGNoZWQgZWxlbWVudCBzZXQgYXMgYSBjbGVhbiBhcnJheQoJZ2V0OiBmdW5jdGlvbiggbnVtICkgewoJCXJldHVybiBudW0gPT0gbnVsbCA/CgoJCQkvLyBSZXR1cm4gYSAnY2xlYW4nIGFycmF5CgkJCXRoaXMudG9BcnJheSgpIDoKCgkJCS8vIFJldHVybiBqdXN0IHRoZSBvYmplY3QKCQkJKCBudW0gPCAwID8gdGhpc1sgdGhpcy5sZW5ndGggKyBudW0gXSA6IHRoaXNbIG51bSBdICk7Cgl9LAoKCS8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sKCS8vIChyZXR1cm5pbmcgdGhlIG5ldyBtYXRjaGVkIGVsZW1lbnQgc2V0KQoJcHVzaFN0YWNrOiBmdW5jdGlvbiggZWxlbXMsIG5hbWUsIHNlbGVjdG9yICkgewoKCQkvLyBCdWlsZCBhIG5ldyBqUXVlcnkgbWF0Y2hlZCBlbGVtZW50IHNldAoJCXZhciByZXQgPSBqUXVlcnkubWVyZ2UoIHRoaXMuY29uc3RydWN0b3IoKSwgZWxlbXMgKTsKCgkJLy8gQWRkIHRoZSBvbGQgb2JqZWN0IG9udG8gdGhlIHN0YWNrIChhcyBhIHJlZmVyZW5jZSkKCQlyZXQucHJldk9iamVjdCA9IHRoaXM7CgoJCXJldC5jb250ZXh0ID0gdGhpcy5jb250ZXh0OwoKCQlpZiAoIG5hbWUgPT09ICJmaW5kIiApIHsKCQkJcmV0LnNlbGVjdG9yID0gdGhpcy5zZWxlY3RvciArICggdGhpcy5zZWxlY3RvciA/ICIgIiA6ICIiICkgKyBzZWxlY3RvcjsKCQl9IGVsc2UgaWYgKCBuYW1lICkgewoJCQlyZXQuc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yICsgIi4iICsgbmFtZSArICIoIiArIHNlbGVjdG9yICsgIikiOwoJCX0KCgkJLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBFeGVjdXRlIGEgY2FsbGJhY2sgZm9yIGV2ZXJ5IGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgc2V0LgoJLy8gKFlvdSBjYW4gc2VlZCB0aGUgYXJndW1lbnRzIHdpdGggYW4gYXJyYXkgb2YgYXJncywgYnV0IHRoaXMgaXMKCS8vIG9ubHkgdXNlZCBpbnRlcm5hbGx5LikKCWVhY2g6IGZ1bmN0aW9uKCBjYWxsYmFjaywgYXJncyApIHsKCQlyZXR1cm4galF1ZXJ5LmVhY2goIHRoaXMsIGNhbGxiYWNrLCBhcmdzICk7Cgl9LAoKCXJlYWR5OiBmdW5jdGlvbiggZm4gKSB7CgkJLy8gQWRkIHRoZSBjYWxsYmFjawoJCWpRdWVyeS5yZWFkeS5wcm9taXNlKCkuZG9uZSggZm4gKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVxOiBmdW5jdGlvbiggaSApIHsKCQlpID0gK2k7CgkJcmV0dXJuIGkgPT09IC0xID8KCQkJdGhpcy5zbGljZSggaSApIDoKCQkJdGhpcy5zbGljZSggaSwgaSArIDEgKTsKCX0sCgoJZmlyc3Q6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVxKCAwICk7Cgl9LAoKCWxhc3Q6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVxKCAtMSApOwoJfSwKCglzbGljZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBjb3JlX3NsaWNlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJInNsaWNlIiwgY29yZV9zbGljZS5jYWxsKGFyZ3VtZW50cykuam9pbigiLCIpICk7Cgl9LAoKCW1hcDogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5Lm1hcCh0aGlzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJcmV0dXJuIGNhbGxiYWNrLmNhbGwoIGVsZW0sIGksIGVsZW0gKTsKCQl9KSk7Cgl9LAoKCWVuZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMucHJldk9iamVjdCB8fCB0aGlzLmNvbnN0cnVjdG9yKG51bGwpOwoJfSwKCgkvLyBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuCgkvLyBCZWhhdmVzIGxpa2UgYW4gQXJyYXkncyBtZXRob2QsIG5vdCBsaWtlIGEgalF1ZXJ5IG1ldGhvZC4KCXB1c2g6IGNvcmVfcHVzaCwKCXNvcnQ6IFtdLnNvcnQsCglzcGxpY2U6IFtdLnNwbGljZQp9OwoKLy8gR2l2ZSB0aGUgaW5pdCBmdW5jdGlvbiB0aGUgalF1ZXJ5IHByb3RvdHlwZSBmb3IgbGF0ZXIgaW5zdGFudGlhdGlvbgpqUXVlcnkuZm4uaW5pdC5wcm90b3R5cGUgPSBqUXVlcnkuZm47CgpqUXVlcnkuZXh0ZW5kID0galF1ZXJ5LmZuLmV4dGVuZCA9IGZ1bmN0aW9uKCkgewoJdmFyIG9wdGlvbnMsIG5hbWUsIHNyYywgY29weSwgY29weUlzQXJyYXksIGNsb25lLAoJCXRhcmdldCA9IGFyZ3VtZW50c1swXSB8fCB7fSwKCQlpID0gMSwKCQlsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLAoJCWRlZXAgPSBmYWxzZTsKCgkvLyBIYW5kbGUgYSBkZWVwIGNvcHkgc2l0dWF0aW9uCglpZiAoIHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIiApIHsKCQlkZWVwID0gdGFyZ2V0OwoJCXRhcmdldCA9IGFyZ3VtZW50c1sxXSB8fCB7fTsKCQkvLyBza2lwIHRoZSBib29sZWFuIGFuZCB0aGUgdGFyZ2V0CgkJaSA9IDI7Cgl9CgoJLy8gSGFuZGxlIGNhc2Ugd2hlbiB0YXJnZXQgaXMgYSBzdHJpbmcgb3Igc29tZXRoaW5nIChwb3NzaWJsZSBpbiBkZWVwIGNvcHkpCglpZiAoIHR5cGVvZiB0YXJnZXQgIT09ICJvYmplY3QiICYmICFqUXVlcnkuaXNGdW5jdGlvbih0YXJnZXQpICkgewoJCXRhcmdldCA9IHt9OwoJfQoKCS8vIGV4dGVuZCBqUXVlcnkgaXRzZWxmIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAoJaWYgKCBsZW5ndGggPT09IGkgKSB7CgkJdGFyZ2V0ID0gdGhpczsKCQktLWk7Cgl9CgoJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJLy8gT25seSBkZWFsIHdpdGggbm9uLW51bGwvdW5kZWZpbmVkIHZhbHVlcwoJCWlmICggKG9wdGlvbnMgPSBhcmd1bWVudHNbIGkgXSkgIT0gbnVsbCApIHsKCQkJLy8gRXh0ZW5kIHRoZSBiYXNlIG9iamVjdAoJCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCQlzcmMgPSB0YXJnZXRbIG5hbWUgXTsKCQkJCWNvcHkgPSBvcHRpb25zWyBuYW1lIF07CgoJCQkJLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcAoJCQkJaWYgKCB0YXJnZXQgPT09IGNvcHkgKSB7CgkJCQkJY29udGludWU7CgkJCQl9CgoJCQkJLy8gUmVjdXJzZSBpZiB3ZSdyZSBtZXJnaW5nIHBsYWluIG9iamVjdHMgb3IgYXJyYXlzCgkJCQlpZiAoIGRlZXAgJiYgY29weSAmJiAoIGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvcHkpIHx8IChjb3B5SXNBcnJheSA9IGpRdWVyeS5pc0FycmF5KGNvcHkpKSApICkgewoJCQkJCWlmICggY29weUlzQXJyYXkgKSB7CgkJCQkJCWNvcHlJc0FycmF5ID0gZmFsc2U7CgkJCQkJCWNsb25lID0gc3JjICYmIGpRdWVyeS5pc0FycmF5KHNyYykgPyBzcmMgOiBbXTsKCgkJCQkJfSBlbHNlIHsKCQkJCQkJY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSA/IHNyYyA6IHt9OwoJCQkJCX0KCgkJCQkJLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtCgkJCQkJdGFyZ2V0WyBuYW1lIF0gPSBqUXVlcnkuZXh0ZW5kKCBkZWVwLCBjbG9uZSwgY29weSApOwoKCQkJCS8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMKCQkJCX0gZWxzZSBpZiAoIGNvcHkgIT09IHVuZGVmaW5lZCApIHsKCQkJCQl0YXJnZXRbIG5hbWUgXSA9IGNvcHk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gUmV0dXJuIHRoZSBtb2RpZmllZCBvYmplY3QKCXJldHVybiB0YXJnZXQ7Cn07CgpqUXVlcnkuZXh0ZW5kKHsKCW5vQ29uZmxpY3Q6IGZ1bmN0aW9uKCBkZWVwICkgewoJCWlmICggd2luZG93LiQgPT09IGpRdWVyeSApIHsKCQkJd2luZG93LiQgPSBfJDsKCQl9CgoJCWlmICggZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkgKSB7CgkJCXdpbmRvdy5qUXVlcnkgPSBfalF1ZXJ5OwoJCX0KCgkJcmV0dXJuIGpRdWVyeTsKCX0sCgoJLy8gSXMgdGhlIERPTSByZWFkeSB0byBiZSB1c2VkPyBTZXQgdG8gdHJ1ZSBvbmNlIGl0IG9jY3Vycy4KCWlzUmVhZHk6IGZhbHNlLAoKCS8vIEEgY291bnRlciB0byB0cmFjayBob3cgbWFueSBpdGVtcyB0byB3YWl0IGZvciBiZWZvcmUKCS8vIHRoZSByZWFkeSBldmVudCBmaXJlcy4gU2VlICM2NzgxCglyZWFkeVdhaXQ6IDEsCgoJLy8gSG9sZCAob3IgcmVsZWFzZSkgdGhlIHJlYWR5IGV2ZW50Cglob2xkUmVhZHk6IGZ1bmN0aW9uKCBob2xkICkgewoJCWlmICggaG9sZCApIHsKCQkJalF1ZXJ5LnJlYWR5V2FpdCsrOwoJCX0gZWxzZSB7CgkJCWpRdWVyeS5yZWFkeSggdHJ1ZSApOwoJCX0KCX0sCgoJLy8gSGFuZGxlIHdoZW4gdGhlIERPTSBpcyByZWFkeQoJcmVhZHk6IGZ1bmN0aW9uKCB3YWl0ICkgewoKCQkvLyBBYm9ydCBpZiB0aGVyZSBhcmUgcGVuZGluZyBob2xkcyBvciB3ZSdyZSBhbHJlYWR5IHJlYWR5CgkJaWYgKCB3YWl0ID09PSB0cnVlID8gLS1qUXVlcnkucmVhZHlXYWl0IDogalF1ZXJ5LmlzUmVhZHkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSBib2R5IGV4aXN0cywgYXQgbGVhc3QsIGluIGNhc2UgSUUgZ2V0cyBhIGxpdHRsZSBvdmVyemVhbG91cyAodGlja2V0ICM1NDQzKS4KCQlpZiAoICFkb2N1bWVudC5ib2R5ICkgewoJCQlyZXR1cm4gc2V0VGltZW91dCggalF1ZXJ5LnJlYWR5LCAxICk7CgkJfQoKCQkvLyBSZW1lbWJlciB0aGF0IHRoZSBET00gaXMgcmVhZHkKCQlqUXVlcnkuaXNSZWFkeSA9IHRydWU7CgoJCS8vIElmIGEgbm9ybWFsIERPTSBSZWFkeSBldmVudCBmaXJlZCwgZGVjcmVtZW50LCBhbmQgd2FpdCBpZiBuZWVkIGJlCgkJaWYgKCB3YWl0ICE9PSB0cnVlICYmIC0talF1ZXJ5LnJlYWR5V2FpdCA+IDAgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHRoZXJlIGFyZSBmdW5jdGlvbnMgYm91bmQsIHRvIGV4ZWN1dGUKCQlyZWFkeUxpc3QucmVzb2x2ZVdpdGgoIGRvY3VtZW50LCBbIGpRdWVyeSBdICk7CgoJCS8vIFRyaWdnZXIgYW55IGJvdW5kIHJlYWR5IGV2ZW50cwoJCWlmICggalF1ZXJ5LmZuLnRyaWdnZXIgKSB7CgkJCWpRdWVyeSggZG9jdW1lbnQgKS50cmlnZ2VyKCJyZWFkeSIpLm9mZigicmVhZHkiKTsKCQl9Cgl9LAoKCS8vIFNlZSB0ZXN0L3VuaXQvY29yZS5qcyBmb3IgZGV0YWlscyBjb25jZXJuaW5nIGlzRnVuY3Rpb24uCgkvLyBTaW5jZSB2ZXJzaW9uIDEuMywgRE9NIG1ldGhvZHMgYW5kIGZ1bmN0aW9ucyBsaWtlIGFsZXJ0CgkvLyBhcmVuJ3Qgc3VwcG9ydGVkLiBUaGV5IHJldHVybiBmYWxzZSBvbiBJRSAoIzI5NjgpLgoJaXNGdW5jdGlvbjogZnVuY3Rpb24oIG9iaiApIHsKCQlyZXR1cm4galF1ZXJ5LnR5cGUob2JqKSA9PT0gImZ1bmN0aW9uIjsKCX0sCgoJaXNBcnJheTogQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiYXJyYXkiOwoJfSwKCglpc1dpbmRvdzogZnVuY3Rpb24oIG9iaiApIHsKCQlyZXR1cm4gb2JqICE9IG51bGwgJiYgb2JqID09IG9iai53aW5kb3c7Cgl9LAoKCWlzTnVtZXJpYzogZnVuY3Rpb24oIG9iaiApIHsKCQlyZXR1cm4gIWlzTmFOKCBwYXJzZUZsb2F0KG9iaikgKSAmJiBpc0Zpbml0ZSggb2JqICk7Cgl9LAoKCXR5cGU6IGZ1bmN0aW9uKCBvYmogKSB7CgkJcmV0dXJuIG9iaiA9PSBudWxsID8KCQkJU3RyaW5nKCBvYmogKSA6CgkJCWNsYXNzMnR5cGVbIGNvcmVfdG9TdHJpbmcuY2FsbChvYmopIF0gfHwgIm9iamVjdCI7Cgl9LAoKCWlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CgkJLy8gTXVzdCBiZSBhbiBPYmplY3QuCgkJLy8gQmVjYXVzZSBvZiBJRSwgd2UgYWxzbyBoYXZlIHRvIGNoZWNrIHRoZSBwcmVzZW5jZSBvZiB0aGUgY29uc3RydWN0b3IgcHJvcGVydHkuCgkJLy8gTWFrZSBzdXJlIHRoYXQgRE9NIG5vZGVzIGFuZCB3aW5kb3cgb2JqZWN0cyBkb24ndCBwYXNzIHRocm91Z2gsIGFzIHdlbGwKCQlpZiAoICFvYmogfHwgalF1ZXJ5LnR5cGUob2JqKSAhPT0gIm9iamVjdCIgfHwgb2JqLm5vZGVUeXBlIHx8IGpRdWVyeS5pc1dpbmRvdyggb2JqICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXRyeSB7CgkJCS8vIE5vdCBvd24gY29uc3RydWN0b3IgcHJvcGVydHkgbXVzdCBiZSBPYmplY3QKCQkJaWYgKCBvYmouY29uc3RydWN0b3IgJiYKCQkJCSFjb3JlX2hhc093bi5jYWxsKG9iaiwgImNvbnN0cnVjdG9yIikgJiYKCQkJCSFjb3JlX2hhc093bi5jYWxsKG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsICJpc1Byb3RvdHlwZU9mIikgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9IGNhdGNoICggZSApIHsKCQkJLy8gSUU4LDkgV2lsbCB0aHJvdyBleGNlcHRpb25zIG9uIGNlcnRhaW4gaG9zdCBvYmplY3RzICM5ODk3CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIE93biBwcm9wZXJ0aWVzIGFyZSBlbnVtZXJhdGVkIGZpcnN0bHksIHNvIHRvIHNwZWVkIHVwLAoJCS8vIGlmIGxhc3Qgb25lIGlzIG93biwgdGhlbiBhbGwgcHJvcGVydGllcyBhcmUgb3duLgoKCQl2YXIga2V5OwoJCWZvciAoIGtleSBpbiBvYmogKSB7fQoKCQlyZXR1cm4ga2V5ID09PSB1bmRlZmluZWQgfHwgY29yZV9oYXNPd24uY2FsbCggb2JqLCBrZXkgKTsKCX0sCgoJaXNFbXB0eU9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQl2YXIgbmFtZTsKCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJZXJyb3I6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgbmV3IEVycm9yKCBtc2cgKTsKCX0sCgoJLy8gZGF0YTogc3RyaW5nIG9mIGh0bWwKCS8vIGNvbnRleHQgKG9wdGlvbmFsKTogSWYgc3BlY2lmaWVkLCB0aGUgZnJhZ21lbnQgd2lsbCBiZSBjcmVhdGVkIGluIHRoaXMgY29udGV4dCwgZGVmYXVsdHMgdG8gZG9jdW1lbnQKCS8vIHNjcmlwdHMgKG9wdGlvbmFsKTogSWYgdHJ1ZSwgd2lsbCBpbmNsdWRlIHNjcmlwdHMgcGFzc2VkIGluIHRoZSBodG1sIHN0cmluZwoJcGFyc2VIVE1MOiBmdW5jdGlvbiggZGF0YSwgY29udGV4dCwgc2NyaXB0cyApIHsKCQl2YXIgcGFyc2VkOwoJCWlmICggIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgkJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gImJvb2xlYW4iICkgewoJCQlzY3JpcHRzID0gY29udGV4dDsKCQkJY29udGV4dCA9IDA7CgkJfQoJCWNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwoKCQkvLyBTaW5nbGUgdGFnCgkJaWYgKCAocGFyc2VkID0gcnNpbmdsZVRhZy5leGVjKCBkYXRhICkpICkgewoJCQlyZXR1cm4gWyBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoIHBhcnNlZFsxXSApIF07CgkJfQoKCQlwYXJzZWQgPSBqUXVlcnkuYnVpbGRGcmFnbWVudCggWyBkYXRhIF0sIGNvbnRleHQsIHNjcmlwdHMgPyBudWxsIDogW10gKTsKCQlyZXR1cm4galF1ZXJ5Lm1lcmdlKCBbXSwKCQkJKHBhcnNlZC5jYWNoZWFibGUgPyBqUXVlcnkuY2xvbmUoIHBhcnNlZC5mcmFnbWVudCApIDogcGFyc2VkLmZyYWdtZW50KS5jaGlsZE5vZGVzICk7Cgl9LAoKCXBhcnNlSlNPTjogZnVuY3Rpb24oIGRhdGEgKSB7CgkJaWYgKCAhZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQkvLyBNYWtlIHN1cmUgbGVhZGluZy90cmFpbGluZyB3aGl0ZXNwYWNlIGlzIHJlbW92ZWQgKElFIGNhbid0IGhhbmRsZSBpdCkKCQlkYXRhID0galF1ZXJ5LnRyaW0oIGRhdGEgKTsKCgkJLy8gQXR0ZW1wdCB0byBwYXJzZSB1c2luZyB0aGUgbmF0aXZlIEpTT04gcGFyc2VyIGZpcnN0CgkJaWYgKCB3aW5kb3cuSlNPTiAmJiB3aW5kb3cuSlNPTi5wYXJzZSApIHsKCQkJcmV0dXJuIHdpbmRvdy5KU09OLnBhcnNlKCBkYXRhICk7CgkJfQoKCQkvLyBNYWtlIHN1cmUgdGhlIGluY29taW5nIGRhdGEgaXMgYWN0dWFsIEpTT04KCQkvLyBMb2dpYyBib3Jyb3dlZCBmcm9tIGh0dHA6Ly9qc29uLm9yZy9qc29uMi5qcwoJCWlmICggcnZhbGlkY2hhcnMudGVzdCggZGF0YS5yZXBsYWNlKCBydmFsaWRlc2NhcGUsICJAIiApCgkJCS5yZXBsYWNlKCBydmFsaWR0b2tlbnMsICJdIiApCgkJCS5yZXBsYWNlKCBydmFsaWRicmFjZXMsICIiKSkgKSB7CgoJCQlyZXR1cm4gKCBuZXcgRnVuY3Rpb24oICJyZXR1cm4gIiArIGRhdGEgKSApKCk7CgoJCX0KCQlqUXVlcnkuZXJyb3IoICJJbnZhbGlkIEpTT046ICIgKyBkYXRhICk7Cgl9LAoKCS8vIENyb3NzLWJyb3dzZXIgeG1sIHBhcnNpbmcKCXBhcnNlWE1MOiBmdW5jdGlvbiggZGF0YSApIHsKCQl2YXIgeG1sLCB0bXA7CgkJaWYgKCAhZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCQl0cnkgewoJCQlpZiAoIHdpbmRvdy5ET01QYXJzZXIgKSB7IC8vIFN0YW5kYXJkCgkJCQl0bXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCQl4bWwgPSB0bXAucGFyc2VGcm9tU3RyaW5nKCBkYXRhICwgInRleHQveG1sIiApOwoJCQl9IGVsc2UgeyAvLyBJRQoJCQkJeG1sID0gbmV3IEFjdGl2ZVhPYmplY3QoICJNaWNyb3NvZnQuWE1MRE9NIiApOwoJCQkJeG1sLmFzeW5jID0gImZhbHNlIjsKCQkJCXhtbC5sb2FkWE1MKCBkYXRhICk7CgkJCX0KCQl9IGNhdGNoKCBlICkgewoJCQl4bWwgPSB1bmRlZmluZWQ7CgkJfQoJCWlmICggIXhtbCB8fCAheG1sLmRvY3VtZW50RWxlbWVudCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJwYXJzZXJlcnJvciIgKS5sZW5ndGggKSB7CgkJCWpRdWVyeS5lcnJvciggIkludmFsaWQgWE1MOiAiICsgZGF0YSApOwoJCX0KCQlyZXR1cm4geG1sOwoJfSwKCglub29wOiBmdW5jdGlvbigpIHt9LAoKCS8vIEV2YWx1YXRlcyBhIHNjcmlwdCBpbiBhIGdsb2JhbCBjb250ZXh0CgkvLyBXb3JrYXJvdW5kcyBiYXNlZCBvbiBmaW5kaW5ncyBieSBKaW0gRHJpc2NvbGwKCS8vIGh0dHA6Ly93ZWJsb2dzLmphdmEubmV0L2Jsb2cvZHJpc2NvbGwvYXJjaGl2ZS8yMDA5LzA5LzA4L2V2YWwtamF2YXNjcmlwdC1nbG9iYWwtY29udGV4dAoJZ2xvYmFsRXZhbDogZnVuY3Rpb24oIGRhdGEgKSB7CgkJaWYgKCBkYXRhICYmIGNvcmVfcm5vdHdoaXRlLnRlc3QoIGRhdGEgKSApIHsKCQkJLy8gV2UgdXNlIGV4ZWNTY3JpcHQgb24gSW50ZXJuZXQgRXhwbG9yZXIKCQkJLy8gV2UgdXNlIGFuIGFub255bW91cyBmdW5jdGlvbiBzbyB0aGF0IGNvbnRleHQgaXMgd2luZG93CgkJCS8vIHJhdGhlciB0aGFuIGpRdWVyeSBpbiBGaXJlZm94CgkJCSggd2luZG93LmV4ZWNTY3JpcHQgfHwgZnVuY3Rpb24oIGRhdGEgKSB7CgkJCQl3aW5kb3dbICJldmFsIiBdLmNhbGwoIHdpbmRvdywgZGF0YSApOwoJCQl9ICkoIGRhdGEgKTsKCQl9Cgl9LAoKCS8vIENvbnZlcnQgZGFzaGVkIHRvIGNhbWVsQ2FzZTsgdXNlZCBieSB0aGUgY3NzIGFuZCBkYXRhIG1vZHVsZXMKCS8vIE1pY3Jvc29mdCBmb3Jnb3QgdG8gaHVtcCB0aGVpciB2ZW5kb3IgcHJlZml4ICgjOTU3MikKCWNhbWVsQ2FzZTogZnVuY3Rpb24oIHN0cmluZyApIHsKCQlyZXR1cm4gc3RyaW5nLnJlcGxhY2UoIHJtc1ByZWZpeCwgIm1zLSIgKS5yZXBsYWNlKCByZGFzaEFscGhhLCBmY2FtZWxDYXNlICk7Cgl9LAoKCW5vZGVOYW1lOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQlyZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT09IG5hbWUudG9VcHBlckNhc2UoKTsKCX0sCgoJLy8gYXJncyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJZWFjaDogZnVuY3Rpb24oIG9iaiwgY2FsbGJhY2ssIGFyZ3MgKSB7CgkJdmFyIG5hbWUsCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBvYmoubGVuZ3RoLAoJCQlpc09iaiA9IGxlbmd0aCA9PT0gdW5kZWZpbmVkIHx8IGpRdWVyeS5pc0Z1bmN0aW9uKCBvYmogKTsKCgkJaWYgKCBhcmdzICkgewoJCQlpZiAoIGlzT2JqICkgewoJCQkJZm9yICggbmFtZSBpbiBvYmogKSB7CgkJCQkJaWYgKCBjYWxsYmFjay5hcHBseSggb2JqWyBuYW1lIF0sIGFyZ3MgKSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgKSB7CgkJCQkJaWYgKCBjYWxsYmFjay5hcHBseSggb2JqWyBpKysgXSwgYXJncyApID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCS8vIEEgc3BlY2lhbCwgZmFzdCwgY2FzZSBmb3IgdGhlIG1vc3QgY29tbW9uIHVzZSBvZiBlYWNoCgkJfSBlbHNlIHsKCQkJaWYgKCBpc09iaiApIHsKCQkJCWZvciAoIG5hbWUgaW4gb2JqICkgewoJCQkJCWlmICggY2FsbGJhY2suY2FsbCggb2JqWyBuYW1lIF0sIG5hbWUsIG9ialsgbmFtZSBdICkgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlmb3IgKCA7IGkgPCBsZW5ndGg7ICkgewoJCQkJCWlmICggY2FsbGJhY2suY2FsbCggb2JqWyBpIF0sIGksIG9ialsgaSsrIF0gKSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLy8gVXNlIG5hdGl2ZSBTdHJpbmcudHJpbSBmdW5jdGlvbiB3aGVyZXZlciBwb3NzaWJsZQoJdHJpbTogY29yZV90cmltID8KCQlmdW5jdGlvbiggdGV4dCApIHsKCQkJcmV0dXJuIHRleHQgPT0gbnVsbCA/CgkJCQkiIiA6CgkJCQljb3JlX3RyaW0uY2FsbCggdGV4dCApOwoJCX0gOgoKCQkvLyBPdGhlcndpc2UgdXNlIG91ciBvd24gdHJpbW1pbmcgZnVuY3Rpb25hbGl0eQoJCWZ1bmN0aW9uKCB0ZXh0ICkgewoJCQlyZXR1cm4gdGV4dCA9PSBudWxsID8KCQkJCSIiIDoKCQkJCXRleHQudG9TdHJpbmcoKS5yZXBsYWNlKCBydHJpbSwgIiIgKTsKCQl9LAoKCS8vIHJlc3VsdHMgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1ha2VBcnJheTogZnVuY3Rpb24oIGFyciwgcmVzdWx0cyApIHsKCQl2YXIgdHlwZSwKCQkJcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCBhcnIgIT0gbnVsbCApIHsKCQkJLy8gVGhlIHdpbmRvdywgc3RyaW5ncyAoYW5kIGZ1bmN0aW9ucykgYWxzbyBoYXZlICdsZW5ndGgnCgkJCS8vIFR3ZWFrZWQgbG9naWMgc2xpZ2h0bHkgdG8gaGFuZGxlIEJsYWNrYmVycnkgNC43IFJlZ0V4cCBpc3N1ZXMgIzY5MzAKCQkJdHlwZSA9IGpRdWVyeS50eXBlKCBhcnIgKTsKCgkJCWlmICggYXJyLmxlbmd0aCA9PSBudWxsIHx8IHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGUgPT09ICJmdW5jdGlvbiIgfHwgdHlwZSA9PT0gInJlZ2V4cCIgfHwgalF1ZXJ5LmlzV2luZG93KCBhcnIgKSApIHsKCQkJCWNvcmVfcHVzaC5jYWxsKCByZXQsIGFyciApOwoJCQl9IGVsc2UgewoJCQkJalF1ZXJ5Lm1lcmdlKCByZXQsIGFyciApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyLCBpICkgewoJCXZhciBsZW47CgoJCWlmICggYXJyICkgewoJCQlpZiAoIGNvcmVfaW5kZXhPZiApIHsKCQkJCXJldHVybiBjb3JlX2luZGV4T2YuY2FsbCggYXJyLCBlbGVtLCBpICk7CgkJCX0KCgkJCWxlbiA9IGFyci5sZW5ndGg7CgkJCWkgPSBpID8gaSA8IDAgPyBNYXRoLm1heCggMCwgbGVuICsgaSApIDogaSA6IDA7CgoJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJCS8vIFNraXAgYWNjZXNzaW5nIGluIHNwYXJzZSBhcnJheXMKCQkJCWlmICggaSBpbiBhcnIgJiYgYXJyWyBpIF0gPT09IGVsZW0gKSB7CgkJCQkJcmV0dXJuIGk7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiAtMTsKCX0sCgoJbWVyZ2U6IGZ1bmN0aW9uKCBmaXJzdCwgc2Vjb25kICkgewoJCXZhciBsID0gc2Vjb25kLmxlbmd0aCwKCQkJaSA9IGZpcnN0Lmxlbmd0aCwKCQkJaiA9IDA7CgoJCWlmICggdHlwZW9mIGwgPT09ICJudW1iZXIiICkgewoJCQlmb3IgKCA7IGogPCBsOyBqKysgKSB7CgkJCQlmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGogXTsKCQkJfQoKCQl9IGVsc2UgewoJCQl3aGlsZSAoIHNlY29uZFtqXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJZmlyc3RbIGkrKyBdID0gc2Vjb25kWyBqKysgXTsKCQkJfQoJCX0KCgkJZmlyc3QubGVuZ3RoID0gaTsKCgkJcmV0dXJuIGZpcnN0OwoJfSwKCglncmVwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBpbnYgKSB7CgkJdmFyIHJldFZhbCwKCQkJcmV0ID0gW10sCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBlbGVtcy5sZW5ndGg7CgkJaW52ID0gISFpbnY7CgoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCBvbmx5IHNhdmluZyB0aGUgaXRlbXMKCQkvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgoJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQlyZXRWYWwgPSAhIWNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpICk7CgkJCWlmICggaW52ICE9PSByZXRWYWwgKSB7CgkJCQlyZXQucHVzaCggZWxlbXNbIGkgXSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1hcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgYXJnICkgewoJCXZhciB2YWx1ZSwga2V5LAoJCQlyZXQgPSBbXSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQkJLy8ganF1ZXJ5IG9iamVjdHMgYXJlIHRyZWF0ZWQgYXMgYXJyYXlzCgkJCWlzQXJyYXkgPSBlbGVtcyBpbnN0YW5jZW9mIGpRdWVyeSB8fCBsZW5ndGggIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgbGVuZ3RoID09PSAibnVtYmVyIiAmJiAoICggbGVuZ3RoID4gMCAmJiBlbGVtc1sgMCBdICYmIGVsZW1zWyBsZW5ndGggLTEgXSApIHx8IGxlbmd0aCA9PT0gMCB8fCBqUXVlcnkuaXNBcnJheSggZWxlbXMgKSApIDsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIHRyYW5zbGF0aW5nIGVhY2ggb2YgdGhlIGl0ZW1zIHRvIHRoZWlyCgkJaWYgKCBpc0FycmF5ICkgewoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlyZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgoJCS8vIEdvIHRocm91Z2ggZXZlcnkga2V5IG9uIHRoZSBvYmplY3QsCgkJfSBlbHNlIHsKCQkJZm9yICgga2V5IGluIGVsZW1zICkgewoJCQkJdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGtleSBdLCBrZXksIGFyZyApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlyZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJcmV0dXJuIHJldC5jb25jYXQuYXBwbHkoIFtdLCByZXQgKTsKCX0sCgoJLy8gQSBnbG9iYWwgR1VJRCBjb3VudGVyIGZvciBvYmplY3RzCglndWlkOiAxLAoKCS8vIEJpbmQgYSBmdW5jdGlvbiB0byBhIGNvbnRleHQsIG9wdGlvbmFsbHkgcGFydGlhbGx5IGFwcGx5aW5nIGFueQoJLy8gYXJndW1lbnRzLgoJcHJveHk6IGZ1bmN0aW9uKCBmbiwgY29udGV4dCApIHsKCQl2YXIgdG1wLCBhcmdzLCBwcm94eTsKCgkJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gInN0cmluZyIgKSB7CgkJCXRtcCA9IGZuWyBjb250ZXh0IF07CgkJCWNvbnRleHQgPSBmbjsKCQkJZm4gPSB0bXA7CgkJfQoKCQkvLyBRdWljayBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGFyZ2V0IGlzIGNhbGxhYmxlLCBpbiB0aGUgc3BlYwoJCS8vIHRoaXMgdGhyb3dzIGEgVHlwZUVycm9yLCBidXQgd2Ugd2lsbCBqdXN0IHJldHVybiB1bmRlZmluZWQuCgkJaWYgKCAhalF1ZXJ5LmlzRnVuY3Rpb24oIGZuICkgKSB7CgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoKCQkvLyBTaW11bGF0ZWQgYmluZAoJCWFyZ3MgPSBjb3JlX3NsaWNlLmNhbGwoIGFyZ3VtZW50cywgMiApOwoJCXByb3h5ID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiBmbi5hcHBseSggY29udGV4dCwgYXJncy5jb25jYXQoIGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKSApOwoJCX07CgoJCS8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAoJCXByb3h5Lmd1aWQgPSBmbi5ndWlkID0gZm4uZ3VpZCB8fCBwcm94eS5ndWlkIHx8IGpRdWVyeS5ndWlkKys7CgoJCXJldHVybiBwcm94eTsKCX0sCgoJLy8gTXVsdGlmdW5jdGlvbmFsIG1ldGhvZCB0byBnZXQgYW5kIHNldCB2YWx1ZXMgb2YgYSBjb2xsZWN0aW9uCgkvLyBUaGUgdmFsdWUvcyBjYW4gb3B0aW9uYWxseSBiZSBleGVjdXRlZCBpZiBpdCdzIGEgZnVuY3Rpb24KCWFjY2VzczogZnVuY3Rpb24oIGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcGFzcyApIHsKCQl2YXIgZXhlYywKCQkJYnVsayA9IGtleSA9PSBudWxsLAoJCQlpID0gMCwKCQkJbGVuZ3RoID0gZWxlbXMubGVuZ3RoOwoKCQkvLyBTZXRzIG1hbnkgdmFsdWVzCgkJaWYgKCBrZXkgJiYgdHlwZW9mIGtleSA9PT0gIm9iamVjdCIgKSB7CgkJCWZvciAoIGkgaW4ga2V5ICkgewoJCQkJalF1ZXJ5LmFjY2VzcyggZWxlbXMsIGZuLCBpLCBrZXlbaV0sIDEsIGVtcHR5R2V0LCB2YWx1ZSApOwoJCQl9CgkJCWNoYWluYWJsZSA9IDE7CgoJCS8vIFNldHMgb25lIHZhbHVlCgkJfSBlbHNlIGlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gT3B0aW9uYWxseSwgZnVuY3Rpb24gdmFsdWVzIGdldCBleGVjdXRlZCBpZiBleGVjIGlzIHRydWUKCQkJZXhlYyA9IHBhc3MgPT09IHVuZGVmaW5lZCAmJiBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKTsKCgkJCWlmICggYnVsayApIHsKCQkJCS8vIEJ1bGsgb3BlcmF0aW9ucyBvbmx5IGl0ZXJhdGUgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzCgkJCQlpZiAoIGV4ZWMgKSB7CgkJCQkJZXhlYyA9IGZuOwoJCQkJCWZuID0gZnVuY3Rpb24oIGVsZW0sIGtleSwgdmFsdWUgKSB7CgkJCQkJCXJldHVybiBleGVjLmNhbGwoIGpRdWVyeSggZWxlbSApLCB2YWx1ZSApOwoJCQkJCX07CgoJCQkJLy8gT3RoZXJ3aXNlIHRoZXkgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKCQkJCX0gZWxzZSB7CgkJCQkJZm4uY2FsbCggZWxlbXMsIHZhbHVlICk7CgkJCQkJZm4gPSBudWxsOwoJCQkJfQoJCQl9CgoJCQlpZiAoIGZuICkgewoJCQkJZm9yICg7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCQlmbiggZWxlbXNbaV0sIGtleSwgZXhlYyA/IHZhbHVlLmNhbGwoIGVsZW1zW2ldLCBpLCBmbiggZWxlbXNbaV0sIGtleSApICkgOiB2YWx1ZSwgcGFzcyApOwoJCQkJfQoJCQl9CgoJCQljaGFpbmFibGUgPSAxOwoJCX0KCgkJcmV0dXJuIGNoYWluYWJsZSA/CgkJCWVsZW1zIDoKCgkJCS8vIEdldHMKCQkJYnVsayA/CgkJCQlmbi5jYWxsKCBlbGVtcyApIDoKCQkJCWxlbmd0aCA/IGZuKCBlbGVtc1swXSwga2V5ICkgOiBlbXB0eUdldDsKCX0sCgoJbm93OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJfQp9KTsKCmpRdWVyeS5yZWFkeS5wcm9taXNlID0gZnVuY3Rpb24oIG9iaiApIHsKCWlmICggIXJlYWR5TGlzdCApIHsKCgkJcmVhZHlMaXN0ID0galF1ZXJ5LkRlZmVycmVkKCk7CgoJCS8vIENhdGNoIGNhc2VzIHdoZXJlICQoZG9jdW1lbnQpLnJlYWR5KCkgaXMgY2FsbGVkIGFmdGVyIHRoZQoJCS8vIGJyb3dzZXIgZXZlbnQgaGFzIGFscmVhZHkgb2NjdXJyZWQuCgkJaWYgKCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiIHx8ICggZG9jdW1lbnQucmVhZHlTdGF0ZSAhPT0gImxvYWRpbmciICYmIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgKSApIHsKCQkJLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CgkJCXNldFRpbWVvdXQoIGpRdWVyeS5yZWFkeSwgMSApOwoKCQkvLyBTdGFuZGFyZHMtYmFzZWQgYnJvd3NlcnMgc3VwcG9ydCBET01Db250ZW50TG9hZGVkCgkJfSBlbHNlIGlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKCQkJLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIERPTUNvbnRlbnRMb2FkZWQsIGZhbHNlICk7CgoJCQkvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawoJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggImxvYWQiLCBqUXVlcnkucmVhZHksIGZhbHNlICk7CgoJCS8vIElmIElFIGV2ZW50IG1vZGVsIGlzIHVzZWQKCQl9IGVsc2UgewoJCQkvLyBFbnN1cmUgZmlyaW5nIGJlZm9yZSBvbmxvYWQsIG1heWJlIGxhdGUgYnV0IHNhZmUgYWxzbyBmb3IgaWZyYW1lcwoJCQlkb2N1bWVudC5hdHRhY2hFdmVudCggIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIERPTUNvbnRlbnRMb2FkZWQgKTsKCgkJCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCgkJCXdpbmRvdy5hdHRhY2hFdmVudCggIm9ubG9hZCIsIGpRdWVyeS5yZWFkeSApOwoKCQkJLy8gSWYgSUUgYW5kIG5vdCBhIGZyYW1lCgkJCS8vIGNvbnRpbnVhbGx5IGNoZWNrIHRvIHNlZSBpZiB0aGUgZG9jdW1lbnQgaXMgcmVhZHkKCQkJdmFyIHRvcCA9IGZhbHNlOwoKCQkJdHJ5IHsKCQkJCXRvcCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgPT0gbnVsbCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgkJCX0gY2F0Y2goZSkge30KCgkJCWlmICggdG9wICYmIHRvcC5kb1Njcm9sbCApIHsKCQkJCShmdW5jdGlvbiBkb1Njcm9sbENoZWNrKCkgewoJCQkJCWlmICggIWpRdWVyeS5pc1JlYWR5ICkgewoKCQkJCQkJdHJ5IHsKCQkJCQkJCS8vIFVzZSB0aGUgdHJpY2sgYnkgRGllZ28gUGVyaW5pCgkJCQkJCQkvLyBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwoJCQkJCQkJdG9wLmRvU2Nyb2xsKCJsZWZ0Iik7CgkJCQkJCX0gY2F0Y2goZSkgewoJCQkJCQkJcmV0dXJuIHNldFRpbWVvdXQoIGRvU2Nyb2xsQ2hlY2ssIDUwICk7CgkJCQkJCX0KCgkJCQkJCS8vIGFuZCBleGVjdXRlIGFueSB3YWl0aW5nIGZ1bmN0aW9ucwoJCQkJCQlqUXVlcnkucmVhZHkoKTsKCQkJCQl9CgkJCQl9KSgpOwoJCQl9CgkJfQoJfQoJcmV0dXJuIHJlYWR5TGlzdC5wcm9taXNlKCBvYmogKTsKfTsKCi8vIFBvcHVsYXRlIHRoZSBjbGFzczJ0eXBlIG1hcApqUXVlcnkuZWFjaCgiQm9vbGVhbiBOdW1iZXIgU3RyaW5nIEZ1bmN0aW9uIEFycmF5IERhdGUgUmVnRXhwIE9iamVjdCIuc3BsaXQoIiAiKSwgZnVuY3Rpb24oaSwgbmFtZSkgewoJY2xhc3MydHlwZVsgIltvYmplY3QgIiArIG5hbWUgKyAiXSIgXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKfSk7CgovLyBBbGwgalF1ZXJ5IG9iamVjdHMgc2hvdWxkIHBvaW50IGJhY2sgdG8gdGhlc2UKcm9vdGpRdWVyeSA9IGpRdWVyeShkb2N1bWVudCk7Ci8vIFN0cmluZyB0byBPYmplY3Qgb3B0aW9ucyBmb3JtYXQgY2FjaGUKdmFyIG9wdGlvbnNDYWNoZSA9IHt9OwoKLy8gQ29udmVydCBTdHJpbmctZm9ybWF0dGVkIG9wdGlvbnMgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMgYW5kIHN0b3JlIGluIGNhY2hlCmZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSB7Cgl2YXIgb2JqZWN0ID0gb3B0aW9uc0NhY2hlWyBvcHRpb25zIF0gPSB7fTsKCWpRdWVyeS5lYWNoKCBvcHRpb25zLnNwbGl0KCBjb3JlX3JzcGFjZSApLCBmdW5jdGlvbiggXywgZmxhZyApIHsKCQlvYmplY3RbIGZsYWcgXSA9IHRydWU7Cgl9KTsKCXJldHVybiBvYmplY3Q7Cn0KCi8qCiAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogKgogKglvcHRpb25zOiBhbiBvcHRpb25hbCBsaXN0IG9mIHNwYWNlLXNlcGFyYXRlZCBvcHRpb25zIHRoYXQgd2lsbCBjaGFuZ2UgaG93CiAqCQkJdGhlIGNhbGxiYWNrIGxpc3QgYmVoYXZlcyBvciBhIG1vcmUgdHJhZGl0aW9uYWwgb3B0aW9uIG9iamVjdAogKgogKiBCeSBkZWZhdWx0IGEgY2FsbGJhY2sgbGlzdCB3aWxsIGFjdCBsaWtlIGFuIGV2ZW50IGNhbGxiYWNrIGxpc3QgYW5kIGNhbiBiZQogKiAiZmlyZWQiIG11bHRpcGxlIHRpbWVzLgogKgogKiBQb3NzaWJsZSBvcHRpb25zOgogKgogKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkKICoKICoJbWVtb3J5OgkJCXdpbGwga2VlcCB0cmFjayBvZiBwcmV2aW91cyB2YWx1ZXMgYW5kIHdpbGwgY2FsbCBhbnkgY2FsbGJhY2sgYWRkZWQKICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAqCQkJCQl2YWx1ZXMgKGxpa2UgYSBEZWZlcnJlZCkKICoKICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQogKgogKglzdG9wT25GYWxzZToJaW50ZXJydXB0IGNhbGxpbmdzIHdoZW4gYSBjYWxsYmFjayByZXR1cm5zIGZhbHNlCiAqCiAqLwpqUXVlcnkuQ2FsbGJhY2tzID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJLy8gQ29udmVydCBvcHRpb25zIGZyb20gU3RyaW5nLWZvcm1hdHRlZCB0byBPYmplY3QtZm9ybWF0dGVkIGlmIG5lZWRlZAoJLy8gKHdlIGNoZWNrIGluIGNhY2hlIGZpcnN0KQoJb3B0aW9ucyA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiA/CgkJKCBvcHRpb25zQ2FjaGVbIG9wdGlvbnMgXSB8fCBjcmVhdGVPcHRpb25zKCBvcHRpb25zICkgKSA6CgkJalF1ZXJ5LmV4dGVuZCgge30sIG9wdGlvbnMgKTsKCgl2YXIgLy8gTGFzdCBmaXJlIHZhbHVlIChmb3Igbm9uLWZvcmdldHRhYmxlIGxpc3RzKQoJCW1lbW9yeSwKCQkvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCB3YXMgYWxyZWFkeSBmaXJlZAoJCWZpcmVkLAoJCS8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcKCQlmaXJpbmcsCgkJLy8gRmlyc3QgY2FsbGJhY2sgdG8gZmlyZSAodXNlZCBpbnRlcm5hbGx5IGJ5IGFkZCBhbmQgZmlyZVdpdGgpCgkJZmlyaW5nU3RhcnQsCgkJLy8gRW5kIG9mIHRoZSBsb29wIHdoZW4gZmlyaW5nCgkJZmlyaW5nTGVuZ3RoLAoJCS8vIEluZGV4IG9mIGN1cnJlbnRseSBmaXJpbmcgY2FsbGJhY2sgKG1vZGlmaWVkIGJ5IHJlbW92ZSBpZiBuZWVkZWQpCgkJZmlyaW5nSW5kZXgsCgkJLy8gQWN0dWFsIGNhbGxiYWNrIGxpc3QKCQlsaXN0ID0gW10sCgkJLy8gU3RhY2sgb2YgZmlyZSBjYWxscyBmb3IgcmVwZWF0YWJsZSBsaXN0cwoJCXN0YWNrID0gIW9wdGlvbnMub25jZSAmJiBbXSwKCQkvLyBGaXJlIGNhbGxiYWNrcwoJCWZpcmUgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJbWVtb3J5ID0gb3B0aW9ucy5tZW1vcnkgJiYgZGF0YTsKCQkJZmlyZWQgPSB0cnVlOwoJCQlmaXJpbmdJbmRleCA9IGZpcmluZ1N0YXJ0IHx8IDA7CgkJCWZpcmluZ1N0YXJ0ID0gMDsKCQkJZmlyaW5nTGVuZ3RoID0gbGlzdC5sZW5ndGg7CgkJCWZpcmluZyA9IHRydWU7CgkJCWZvciAoIDsgbGlzdCAmJiBmaXJpbmdJbmRleCA8IGZpcmluZ0xlbmd0aDsgZmlyaW5nSW5kZXgrKyApIHsKCQkJCWlmICggbGlzdFsgZmlyaW5nSW5kZXggXS5hcHBseSggZGF0YVsgMCBdLCBkYXRhWyAxIF0gKSA9PT0gZmFsc2UgJiYgb3B0aW9ucy5zdG9wT25GYWxzZSApIHsKCQkJCQltZW1vcnkgPSBmYWxzZTsgLy8gVG8gcHJldmVudCBmdXJ0aGVyIGNhbGxzIHVzaW5nIGFkZAoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCWZpcmluZyA9IGZhbHNlOwoJCQlpZiAoIGxpc3QgKSB7CgkJCQlpZiAoIHN0YWNrICkgewoJCQkJCWlmICggc3RhY2subGVuZ3RoICkgewoJCQkJCQlmaXJlKCBzdGFjay5zaGlmdCgpICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggbWVtb3J5ICkgewoJCQkJCWxpc3QgPSBbXTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5kaXNhYmxlKCk7CgkJCQl9CgkJCX0KCQl9LAoJCS8vIEFjdHVhbCBDYWxsYmFja3Mgb2JqZWN0CgkJc2VsZiA9IHsKCQkJLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAoJCQlhZGQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBsaXN0ICkgewoJCQkJCS8vIEZpcnN0LCB3ZSBzYXZlIHRoZSBjdXJyZW50IGxlbmd0aAoJCQkJCXZhciBzdGFydCA9IGxpc3QubGVuZ3RoOwoJCQkJCShmdW5jdGlvbiBhZGQoIGFyZ3MgKSB7CgkJCQkJCWpRdWVyeS5lYWNoKCBhcmdzLCBmdW5jdGlvbiggXywgYXJnICkgewoJCQkJCQkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggYXJnICkgJiYgKCAhb3B0aW9ucy51bmlxdWUgfHwgIXNlbGYuaGFzKCBhcmcgKSApICkgewoJCQkJCQkJCWxpc3QucHVzaCggYXJnICk7CgkJCQkJCQl9IGVsc2UgaWYgKCBhcmcgJiYgYXJnLmxlbmd0aCApIHsKCQkJCQkJCQkvLyBJbnNwZWN0IHJlY3Vyc2l2ZWx5CgkJCQkJCQkJYWRkKCBhcmcgKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfSkoIGFyZ3VtZW50cyApOwoJCQkJCS8vIERvIHdlIG5lZWQgdG8gYWRkIHRoZSBjYWxsYmFja3MgdG8gdGhlCgkJCQkJLy8gY3VycmVudCBmaXJpbmcgYmF0Y2g/CgkJCQkJaWYgKCBmaXJpbmcgKSB7CgkJCQkJCWZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwoJCQkJCS8vIFdpdGggbWVtb3J5LCBpZiB3ZSdyZSBub3QgZmlyaW5nIHRoZW4KCQkJCQkvLyB3ZSBzaG91bGQgY2FsbCByaWdodCBhd2F5CgkJCQkJfSBlbHNlIGlmICggbWVtb3J5ICkgewoJCQkJCQlmaXJpbmdTdGFydCA9IHN0YXJ0OwoJCQkJCQlmaXJlKCBtZW1vcnkgKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAoJCQlyZW1vdmU6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBsaXN0ICkgewoJCQkJCWpRdWVyeS5lYWNoKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7CgkJCQkJCXZhciBpbmRleDsKCQkJCQkJd2hpbGUoICggaW5kZXggPSBqUXVlcnkuaW5BcnJheSggYXJnLCBsaXN0LCBpbmRleCApICkgPiAtMSApIHsKCQkJCQkJCWxpc3Quc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJCQkJLy8gSGFuZGxlIGZpcmluZyBpbmRleGVzCgkJCQkJCQlpZiAoIGZpcmluZyApIHsKCQkJCQkJCQlpZiAoIGluZGV4IDw9IGZpcmluZ0xlbmd0aCApIHsKCQkJCQkJCQkJZmlyaW5nTGVuZ3RoLS07CgkJCQkJCQkJfQoJCQkJCQkJCWlmICggaW5kZXggPD0gZmlyaW5nSW5kZXggKSB7CgkJCQkJCQkJCWZpcmluZ0luZGV4LS07CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gQ29udHJvbCBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0CgkJCWhhczogZnVuY3Rpb24oIGZuICkgewoJCQkJcmV0dXJuIGpRdWVyeS5pbkFycmF5KCBmbiwgbGlzdCApID4gLTE7CgkJCX0sCgkJCS8vIFJlbW92ZSBhbGwgY2FsbGJhY2tzIGZyb20gdGhlIGxpc3QKCQkJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCQkJbGlzdCA9IFtdOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIEhhdmUgdGhlIGxpc3QgZG8gbm90aGluZyBhbnltb3JlCgkJCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCQkJbGlzdCA9IHN0YWNrID0gbWVtb3J5ID0gdW5kZWZpbmVkOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIElzIGl0IGRpc2FibGVkPwoJCQlkaXNhYmxlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIWxpc3Q7CgkJCX0sCgkJCS8vIExvY2sgdGhlIGxpc3QgaW4gaXRzIGN1cnJlbnQgc3RhdGUKCQkJbG9jazogZnVuY3Rpb24oKSB7CgkJCQlzdGFjayA9IHVuZGVmaW5lZDsKCQkJCWlmICggIW1lbW9yeSApIHsKCQkJCQlzZWxmLmRpc2FibGUoKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBJcyBpdCBsb2NrZWQ/CgkJCWxvY2tlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIXN0YWNrOwoJCQl9LAoJCQkvLyBDYWxsIGFsbCBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dCBhbmQgYXJndW1lbnRzCgkJCWZpcmVXaXRoOiBmdW5jdGlvbiggY29udGV4dCwgYXJncyApIHsKCQkJCWFyZ3MgPSBhcmdzIHx8IFtdOwoJCQkJYXJncyA9IFsgY29udGV4dCwgYXJncy5zbGljZSA/IGFyZ3Muc2xpY2UoKSA6IGFyZ3MgXTsKCQkJCWlmICggbGlzdCAmJiAoICFmaXJlZCB8fCBzdGFjayApICkgewoJCQkJCWlmICggZmlyaW5nICkgewoJCQkJCQlzdGFjay5wdXNoKCBhcmdzICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJZmlyZSggYXJncyApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBDYWxsIGFsbCB0aGUgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cwoJCQlmaXJlOiBmdW5jdGlvbigpIHsKCQkJCXNlbGYuZmlyZVdpdGgoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIFRvIGtub3cgaWYgdGhlIGNhbGxiYWNrcyBoYXZlIGFscmVhZHkgYmVlbiBjYWxsZWQgYXQgbGVhc3Qgb25jZQoJCQlmaXJlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISFmaXJlZDsKCQkJfQoJCX07CgoJcmV0dXJuIHNlbGY7Cn07CmpRdWVyeS5leHRlbmQoewoKCURlZmVycmVkOiBmdW5jdGlvbiggZnVuYyApIHsKCQl2YXIgdHVwbGVzID0gWwoJCQkJLy8gYWN0aW9uLCBhZGQgbGlzdGVuZXIsIGxpc3RlbmVyIGxpc3QsIGZpbmFsIHN0YXRlCgkJCQlbICJyZXNvbHZlIiwgImRvbmUiLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCAicmVzb2x2ZWQiIF0sCgkJCQlbICJyZWplY3QiLCAiZmFpbCIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZWplY3RlZCIgXSwKCQkJCVsgIm5vdGlmeSIsICJwcm9ncmVzcyIsIGpRdWVyeS5DYWxsYmFja3MoIm1lbW9yeSIpIF0KCQkJXSwKCQkJc3RhdGUgPSAicGVuZGluZyIsCgkJCXByb21pc2UgPSB7CgkJCQlzdGF0ZTogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIHN0YXRlOwoJCQkJfSwKCQkJCWFsd2F5czogZnVuY3Rpb24oKSB7CgkJCQkJZGVmZXJyZWQuZG9uZSggYXJndW1lbnRzICkuZmFpbCggYXJndW1lbnRzICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoJCQkJdGhlbjogZnVuY3Rpb24oIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovICkgewoJCQkJCXZhciBmbnMgPSBhcmd1bWVudHM7CgkJCQkJcmV0dXJuIGpRdWVyeS5EZWZlcnJlZChmdW5jdGlvbiggbmV3RGVmZXIgKSB7CgkJCQkJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsKCQkJCQkJCXZhciBhY3Rpb24gPSB0dXBsZVsgMCBdLAoJCQkJCQkJCWZuID0gZm5zWyBpIF07CgkJCQkJCQkvLyBkZWZlcnJlZFsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdIGZvciBmb3J3YXJkaW5nIGFjdGlvbnMgdG8gbmV3RGVmZXIKCQkJCQkJCWRlZmVycmVkWyB0dXBsZVsxXSBdKCBqUXVlcnkuaXNGdW5jdGlvbiggZm4gKSA/CgkJCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQkJCXZhciByZXR1cm5lZCA9IGZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQkJCQkJaWYgKCByZXR1cm5lZCAmJiBqUXVlcnkuaXNGdW5jdGlvbiggcmV0dXJuZWQucHJvbWlzZSApICkgewoJCQkJCQkJCQkJcmV0dXJuZWQucHJvbWlzZSgpCgkJCQkJCQkJCQkJLmRvbmUoIG5ld0RlZmVyLnJlc29sdmUgKQoJCQkJCQkJCQkJCS5mYWlsKCBuZXdEZWZlci5yZWplY3QgKQoJCQkJCQkJCQkJCS5wcm9ncmVzcyggbmV3RGVmZXIubm90aWZ5ICk7CgkJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCQluZXdEZWZlclsgYWN0aW9uICsgIldpdGgiIF0oIHRoaXMgPT09IGRlZmVycmVkID8gbmV3RGVmZXIgOiB0aGlzLCBbIHJldHVybmVkIF0gKTsKCQkJCQkJCQkJfQoJCQkJCQkJCX0gOgoJCQkJCQkJCW5ld0RlZmVyWyBhY3Rpb24gXQoJCQkJCQkJKTsKCQkJCQkJfSk7CgkJCQkJCWZucyA9IG51bGw7CgkJCQkJfSkucHJvbWlzZSgpOwoJCQkJfSwKCQkJCS8vIEdldCBhIHByb21pc2UgZm9yIHRoaXMgZGVmZXJyZWQKCQkJCS8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QKCQkJCXByb21pc2U6IGZ1bmN0aW9uKCBvYmogKSB7CgkJCQkJcmV0dXJuIHR5cGVvZiBvYmogPT09ICJvYmplY3QiID8galF1ZXJ5LmV4dGVuZCggb2JqLCBwcm9taXNlICkgOiBwcm9taXNlOwoJCQkJfQoJCQl9LAoJCQlkZWZlcnJlZCA9IHt9OwoKCQkvLyBLZWVwIHBpcGUgZm9yIGJhY2stY29tcGF0CgkJcHJvbWlzZS5waXBlID0gcHJvbWlzZS50aGVuOwoKCQkvLyBBZGQgbGlzdC1zcGVjaWZpYyBtZXRob2RzCgkJalF1ZXJ5LmVhY2goIHR1cGxlcywgZnVuY3Rpb24oIGksIHR1cGxlICkgewoJCQl2YXIgbGlzdCA9IHR1cGxlWyAyIF0sCgkJCQlzdGF0ZVN0cmluZyA9IHR1cGxlWyAzIF07CgoJCQkvLyBwcm9taXNlWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gPSBsaXN0LmFkZAoJCQlwcm9taXNlWyB0dXBsZVsxXSBdID0gbGlzdC5hZGQ7CgoJCQkvLyBIYW5kbGUgc3RhdGUKCQkJaWYgKCBzdGF0ZVN0cmluZyApIHsKCQkJCWxpc3QuYWRkKGZ1bmN0aW9uKCkgewoJCQkJCS8vIHN0YXRlID0gWyByZXNvbHZlZCB8IHJlamVjdGVkIF0KCQkJCQlzdGF0ZSA9IHN0YXRlU3RyaW5nOwoKCQkJCS8vIFsgcmVqZWN0X2xpc3QgfCByZXNvbHZlX2xpc3QgXS5kaXNhYmxlOyBwcm9ncmVzc19saXN0LmxvY2sKCQkJCX0sIHR1cGxlc1sgaSBeIDEgXVsgMiBdLmRpc2FibGUsIHR1cGxlc1sgMiBdWyAyIF0ubG9jayApOwoJCQl9CgoJCQkvLyBkZWZlcnJlZFsgcmVzb2x2ZSB8IHJlamVjdCB8IG5vdGlmeSBdID0gbGlzdC5maXJlCgkJCWRlZmVycmVkWyB0dXBsZVswXSBdID0gbGlzdC5maXJlOwoJCQlkZWZlcnJlZFsgdHVwbGVbMF0gKyAiV2l0aCIgXSA9IGxpc3QuZmlyZVdpdGg7CgkJfSk7CgoJCS8vIE1ha2UgdGhlIGRlZmVycmVkIGEgcHJvbWlzZQoJCXByb21pc2UucHJvbWlzZSggZGVmZXJyZWQgKTsKCgkJLy8gQ2FsbCBnaXZlbiBmdW5jIGlmIGFueQoJCWlmICggZnVuYyApIHsKCQkJZnVuYy5jYWxsKCBkZWZlcnJlZCwgZGVmZXJyZWQgKTsKCQl9CgoJCS8vIEFsbCBkb25lIQoJCXJldHVybiBkZWZlcnJlZDsKCX0sCgoJLy8gRGVmZXJyZWQgaGVscGVyCgl3aGVuOiBmdW5jdGlvbiggc3Vib3JkaW5hdGUgLyogLCAuLi4sIHN1Ym9yZGluYXRlTiAqLyApIHsKCQl2YXIgaSA9IDAsCgkJCXJlc29sdmVWYWx1ZXMgPSBjb3JlX3NsaWNlLmNhbGwoIGFyZ3VtZW50cyApLAoJCQlsZW5ndGggPSByZXNvbHZlVmFsdWVzLmxlbmd0aCwKCgkJCS8vIHRoZSBjb3VudCBvZiB1bmNvbXBsZXRlZCBzdWJvcmRpbmF0ZXMKCQkJcmVtYWluaW5nID0gbGVuZ3RoICE9PSAxIHx8ICggc3Vib3JkaW5hdGUgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIHN1Ym9yZGluYXRlLnByb21pc2UgKSApID8gbGVuZ3RoIDogMCwKCgkJCS8vIHRoZSBtYXN0ZXIgRGVmZXJyZWQuIElmIHJlc29sdmVWYWx1ZXMgY29uc2lzdCBvZiBvbmx5IGEgc2luZ2xlIERlZmVycmVkLCBqdXN0IHVzZSB0aGF0LgoJCQlkZWZlcnJlZCA9IHJlbWFpbmluZyA9PT0gMSA/IHN1Ym9yZGluYXRlIDogalF1ZXJ5LkRlZmVycmVkKCksCgoJCQkvLyBVcGRhdGUgZnVuY3Rpb24gZm9yIGJvdGggcmVzb2x2ZSBhbmQgcHJvZ3Jlc3MgdmFsdWVzCgkJCXVwZGF0ZUZ1bmMgPSBmdW5jdGlvbiggaSwgY29udGV4dHMsIHZhbHVlcyApIHsKCQkJCXJldHVybiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQkJY29udGV4dHNbIGkgXSA9IHRoaXM7CgkJCQkJdmFsdWVzWyBpIF0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSA/IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICkgOiB2YWx1ZTsKCQkJCQlpZiggdmFsdWVzID09PSBwcm9ncmVzc1ZhbHVlcyApIHsKCQkJCQkJZGVmZXJyZWQubm90aWZ5V2l0aCggY29udGV4dHMsIHZhbHVlcyApOwoJCQkJCX0gZWxzZSBpZiAoICEoIC0tcmVtYWluaW5nICkgKSB7CgkJCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBjb250ZXh0cywgdmFsdWVzICk7CgkJCQkJfQoJCQkJfTsKCQkJfSwKCgkJCXByb2dyZXNzVmFsdWVzLCBwcm9ncmVzc0NvbnRleHRzLCByZXNvbHZlQ29udGV4dHM7CgoJCS8vIGFkZCBsaXN0ZW5lcnMgdG8gRGVmZXJyZWQgc3Vib3JkaW5hdGVzOyB0cmVhdCBvdGhlcnMgYXMgcmVzb2x2ZWQKCQlpZiAoIGxlbmd0aCA+IDEgKSB7CgkJCXByb2dyZXNzVmFsdWVzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJcHJvZ3Jlc3NDb250ZXh0cyA9IG5ldyBBcnJheSggbGVuZ3RoICk7CgkJCXJlc29sdmVDb250ZXh0cyA9IG5ldyBBcnJheSggbGVuZ3RoICk7CgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJaWYgKCByZXNvbHZlVmFsdWVzWyBpIF0gJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIHJlc29sdmVWYWx1ZXNbIGkgXS5wcm9taXNlICkgKSB7CgkJCQkJcmVzb2x2ZVZhbHVlc1sgaSBdLnByb21pc2UoKQoJCQkJCQkuZG9uZSggdXBkYXRlRnVuYyggaSwgcmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzICkgKQoJCQkJCQkuZmFpbCggZGVmZXJyZWQucmVqZWN0ICkKCQkJCQkJLnByb2dyZXNzKCB1cGRhdGVGdW5jKCBpLCBwcm9ncmVzc0NvbnRleHRzLCBwcm9ncmVzc1ZhbHVlcyApICk7CgkJCQl9IGVsc2UgewoJCQkJCS0tcmVtYWluaW5nOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBpZiB3ZSdyZSBub3Qgd2FpdGluZyBvbiBhbnl0aGluZywgcmVzb2x2ZSB0aGUgbWFzdGVyCgkJaWYgKCAhcmVtYWluaW5nICkgewoJCQlkZWZlcnJlZC5yZXNvbHZlV2l0aCggcmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzICk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfQp9KTsKalF1ZXJ5LnN1cHBvcnQgPSAoZnVuY3Rpb24oKSB7CgoJdmFyIHN1cHBvcnQsCgkJYWxsLAoJCWEsCgkJc2VsZWN0LAoJCW9wdCwKCQlpbnB1dCwKCQlmcmFnbWVudCwKCQlldmVudE5hbWUsCgkJaSwKCQlpc1N1cHBvcnRlZCwKCQljbGlja0ZuLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKCS8vIFByZWxpbWluYXJ5IHRlc3RzCglkaXYuc2V0QXR0cmlidXRlKCAiY2xhc3NOYW1lIiwgInQiICk7CglkaXYuaW5uZXJIVE1MID0gIiAgPGxpbmsvPjx0YWJsZT48L3RhYmxlPjxhIGhyZWY9Jy9hJz5hPC9hPjxpbnB1dCB0eXBlPSdjaGVja2JveCcvPiI7CgoJYWxsID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIik7CglhID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJhIilbIDAgXTsKCWEuc3R5bGUuY3NzVGV4dCA9ICJ0b3A6MXB4O2Zsb2F0OmxlZnQ7b3BhY2l0eTouNSI7CgoJLy8gQ2FuJ3QgZ2V0IGJhc2ljIHRlc3Qgc3VwcG9ydAoJaWYgKCAhYWxsIHx8ICFhbGwubGVuZ3RoIHx8ICFhICkgewoJCXJldHVybiB7fTsKCX0KCgkvLyBGaXJzdCBiYXRjaCBvZiBzdXBwb3J0cyB0ZXN0cwoJc2VsZWN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2VsZWN0Iik7CglvcHQgPSBzZWxlY3QuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpICk7CglpbnB1dCA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaW5wdXQiKVsgMCBdOwoKCXN1cHBvcnQgPSB7CgkJLy8gSUUgc3RyaXBzIGxlYWRpbmcgd2hpdGVzcGFjZSB3aGVuIC5pbm5lckhUTUwgaXMgdXNlZAoJCWxlYWRpbmdXaGl0ZXNwYWNlOiAoIGRpdi5maXJzdENoaWxkLm5vZGVUeXBlID09PSAzICksCgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHRib2R5IGVsZW1lbnRzIGFyZW4ndCBhdXRvbWF0aWNhbGx5IGluc2VydGVkCgkJLy8gSUUgd2lsbCBpbnNlcnQgdGhlbSBpbnRvIGVtcHR5IHRhYmxlcwoJCXRib2R5OiAhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpLmxlbmd0aCwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgbGluayBlbGVtZW50cyBnZXQgc2VyaWFsaXplZCBjb3JyZWN0bHkgYnkgaW5uZXJIVE1MCgkJLy8gVGhpcyByZXF1aXJlcyBhIHdyYXBwZXIgZWxlbWVudCBpbiBJRQoJCWh0bWxTZXJpYWxpemU6ICEhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaW5rIikubGVuZ3RoLAoKCQkvLyBHZXQgdGhlIHN0eWxlIGluZm9ybWF0aW9uIGZyb20gZ2V0QXR0cmlidXRlCgkJLy8gKElFIHVzZXMgLmNzc1RleHQgaW5zdGVhZCkKCQlzdHlsZTogL3RvcC8udGVzdCggYS5nZXRBdHRyaWJ1dGUoInN0eWxlIikgKSwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgVVJMcyBhcmVuJ3QgbWFuaXB1bGF0ZWQKCQkvLyAoSUUgbm9ybWFsaXplcyBpdCBieSBkZWZhdWx0KQoJCWhyZWZOb3JtYWxpemVkOiAoIGEuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIvYSIgKSwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgZWxlbWVudCBvcGFjaXR5IGV4aXN0cwoJCS8vIChJRSB1c2VzIGZpbHRlciBpbnN0ZWFkKQoJCS8vIFVzZSBhIHJlZ2V4IHRvIHdvcmsgYXJvdW5kIGEgV2ViS2l0IGlzc3VlLiBTZWUgIzUxNDUKCQlvcGFjaXR5OiAvXjAuNS8udGVzdCggYS5zdHlsZS5vcGFjaXR5ICksCgoJCS8vIFZlcmlmeSBzdHlsZSBmbG9hdCBleGlzdGVuY2UKCQkvLyAoSUUgdXNlcyBzdHlsZUZsb2F0IGluc3RlYWQgb2YgY3NzRmxvYXQpCgkJY3NzRmxvYXQ6ICEhYS5zdHlsZS5jc3NGbG9hdCwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgaWYgbm8gdmFsdWUgaXMgc3BlY2lmaWVkIGZvciBhIGNoZWNrYm94CgkJLy8gdGhhdCBpdCBkZWZhdWx0cyB0byAib24iLgoJCS8vIChXZWJLaXQgZGVmYXVsdHMgdG8gIiIgaW5zdGVhZCkKCQljaGVja09uOiAoIGlucHV0LnZhbHVlID09PSAib24iICksCgoJCS8vIE1ha2Ugc3VyZSB0aGF0IGEgc2VsZWN0ZWQtYnktZGVmYXVsdCBvcHRpb24gaGFzIGEgd29ya2luZyBzZWxlY3RlZCBwcm9wZXJ0eS4KCQkvLyAoV2ViS2l0IGRlZmF1bHRzIHRvIGZhbHNlIGluc3RlYWQgb2YgdHJ1ZSwgSUUgdG9vLCBpZiBpdCdzIGluIGFuIG9wdGdyb3VwKQoJCW9wdFNlbGVjdGVkOiBvcHQuc2VsZWN0ZWQsCgoJCS8vIFRlc3Qgc2V0QXR0cmlidXRlIG9uIGNhbWVsQ2FzZSBjbGFzcy4gSWYgaXQgd29ya3MsIHdlIG5lZWQgYXR0ckZpeGVzIHdoZW4gZG9pbmcgZ2V0L3NldEF0dHJpYnV0ZSAoaWU2LzcpCgkJZ2V0U2V0QXR0cmlidXRlOiBkaXYuY2xhc3NOYW1lICE9PSAidCIsCgoJCS8vIFRlc3RzIGZvciBlbmN0eXBlIHN1cHBvcnQgb24gYSBmb3JtKCM2NzQzKQoJCWVuY3R5cGU6ICEhZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZm9ybSIpLmVuY3R5cGUsCgoJCS8vIE1ha2VzIHN1cmUgY2xvbmluZyBhbiBodG1sNSBlbGVtZW50IGRvZXMgbm90IGNhdXNlIHByb2JsZW1zCgkJLy8gV2hlcmUgb3V0ZXJIVE1MIGlzIHVuZGVmaW5lZCwgdGhpcyBzdGlsbCB3b3JrcwoJCWh0bWw1Q2xvbmU6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm5hdiIpLmNsb25lTm9kZSggdHJ1ZSApLm91dGVySFRNTCAhPT0gIjw6bmF2PjwvOm5hdj4iLAoKCQkvLyBqUXVlcnkuc3VwcG9ydC5ib3hNb2RlbCBERVBSRUNBVEVEIGluIDEuOCBzaW5jZSB3ZSBkb24ndCBzdXBwb3J0IFF1aXJrcyBNb2RlCgkJYm94TW9kZWw6ICggZG9jdW1lbnQuY29tcGF0TW9kZSA9PT0gIkNTUzFDb21wYXQiICksCgoJCS8vIFdpbGwgYmUgZGVmaW5lZCBsYXRlcgoJCXN1Ym1pdEJ1YmJsZXM6IHRydWUsCgkJY2hhbmdlQnViYmxlczogdHJ1ZSwKCQlmb2N1c2luQnViYmxlczogZmFsc2UsCgkJZGVsZXRlRXhwYW5kbzogdHJ1ZSwKCQlub0Nsb25lRXZlbnQ6IHRydWUsCgkJaW5saW5lQmxvY2tOZWVkc0xheW91dDogZmFsc2UsCgkJc2hyaW5rV3JhcEJsb2NrczogZmFsc2UsCgkJcmVsaWFibGVNYXJnaW5SaWdodDogdHJ1ZSwKCQlib3hTaXppbmdSZWxpYWJsZTogdHJ1ZSwKCQlwaXhlbFBvc2l0aW9uOiBmYWxzZQoJfTsKCgkvLyBNYWtlIHN1cmUgY2hlY2tlZCBzdGF0dXMgaXMgcHJvcGVybHkgY2xvbmVkCglpbnB1dC5jaGVja2VkID0gdHJ1ZTsKCXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgPSBpbnB1dC5jbG9uZU5vZGUoIHRydWUgKS5jaGVja2VkOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKCS8vIChXZWJLaXQgbWFya3MgdGhlbSBhcyBkaXNhYmxlZCkKCXNlbGVjdC5kaXNhYmxlZCA9IHRydWU7CglzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKCgkvLyBUZXN0IHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRlbGV0ZSBhbiBleHBhbmRvIGZyb20gYW4gZWxlbWVudAoJLy8gRmFpbHMgaW4gSW50ZXJuZXQgRXhwbG9yZXIKCXRyeSB7CgkJZGVsZXRlIGRpdi50ZXN0OwoJfSBjYXRjaCggZSApIHsKCQlzdXBwb3J0LmRlbGV0ZUV4cGFuZG8gPSBmYWxzZTsKCX0KCglpZiAoICFkaXYuYWRkRXZlbnRMaXN0ZW5lciAmJiBkaXYuYXR0YWNoRXZlbnQgJiYgZGl2LmZpcmVFdmVudCApIHsKCQlkaXYuYXR0YWNoRXZlbnQoICJvbmNsaWNrIiwgY2xpY2tGbiA9IGZ1bmN0aW9uKCkgewoJCQkvLyBDbG9uaW5nIGEgbm9kZSBzaG91bGRuJ3QgY29weSBvdmVyIGFueQoJCQkvLyBib3VuZCBldmVudCBoYW5kbGVycyAoSUUgZG9lcyB0aGlzKQoJCQlzdXBwb3J0Lm5vQ2xvbmVFdmVudCA9IGZhbHNlOwoJCX0pOwoJCWRpdi5jbG9uZU5vZGUoIHRydWUgKS5maXJlRXZlbnQoIm9uY2xpY2siKTsKCQlkaXYuZGV0YWNoRXZlbnQoICJvbmNsaWNrIiwgY2xpY2tGbiApOwoJfQoKCS8vIENoZWNrIGlmIGEgcmFkaW8gbWFpbnRhaW5zIGl0cyB2YWx1ZQoJLy8gYWZ0ZXIgYmVpbmcgYXBwZW5kZWQgdG8gdGhlIERPTQoJaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJaW5wdXQudmFsdWUgPSAidCI7CglpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgInJhZGlvIiApOwoJc3VwcG9ydC5yYWRpb1ZhbHVlID0gaW5wdXQudmFsdWUgPT09ICJ0IjsKCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJjaGVja2VkIiwgImNoZWNrZWQiICk7CgoJLy8gIzExMjE3IC0gV2ViS2l0IGxvc2VzIGNoZWNrIHdoZW4gdGhlIG5hbWUgaXMgYWZ0ZXIgdGhlIGNoZWNrZWQgYXR0cmlidXRlCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJuYW1lIiwgInQiICk7CgoJZGl2LmFwcGVuZENoaWxkKCBpbnB1dCApOwoJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CglmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2Lmxhc3RDaGlsZCApOwoKCS8vIFdlYktpdCBkb2Vzbid0IGNsb25lIGNoZWNrZWQgc3RhdGUgY29ycmVjdGx5IGluIGZyYWdtZW50cwoJc3VwcG9ydC5jaGVja0Nsb25lID0gZnJhZ21lbnQuY2xvbmVOb2RlKCB0cnVlICkuY2xvbmVOb2RlKCB0cnVlICkubGFzdENoaWxkLmNoZWNrZWQ7CgoJLy8gQ2hlY2sgaWYgYSBkaXNjb25uZWN0ZWQgY2hlY2tib3ggd2lsbCByZXRhaW4gaXRzIGNoZWNrZWQKCS8vIHZhbHVlIG9mIHRydWUgYWZ0ZXIgYXBwZW5kZWQgdG8gdGhlIERPTSAoSUU2LzcpCglzdXBwb3J0LmFwcGVuZENoZWNrZWQgPSBpbnB1dC5jaGVja2VkOwoKCWZyYWdtZW50LnJlbW92ZUNoaWxkKCBpbnB1dCApOwoJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRpdiApOwoKCS8vIFRlY2huaXF1ZSBmcm9tIEp1cml5IFpheXRzZXYKCS8vIGh0dHA6Ly9wZXJmZWN0aW9ua2lsbHMuY29tL2RldGVjdGluZy1ldmVudC1zdXBwb3J0LXdpdGhvdXQtYnJvd3Nlci1zbmlmZmluZy8KCS8vIFdlIG9ubHkgY2FyZSBhYm91dCB0aGUgY2FzZSB3aGVyZSBub24tc3RhbmRhcmQgZXZlbnQgc3lzdGVtcwoJLy8gYXJlIHVzZWQsIG5hbWVseSBpbiBJRS4gU2hvcnQtY2lyY3VpdGluZyBoZXJlIGhlbHBzIHVzIHRvCgkvLyBhdm9pZCBhbiBldmFsIGNhbGwgKGluIHNldEF0dHJpYnV0ZSkgd2hpY2ggY2FuIGNhdXNlIENTUAoJLy8gdG8gZ28gaGF5d2lyZS4gU2VlOiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9TZWN1cml0eS9DU1AKCWlmICggZGl2LmF0dGFjaEV2ZW50ICkgewoJCWZvciAoIGkgaW4gewoJCQlzdWJtaXQ6IHRydWUsCgkJCWNoYW5nZTogdHJ1ZSwKCQkJZm9jdXNpbjogdHJ1ZQoJCX0pIHsKCQkJZXZlbnROYW1lID0gIm9uIiArIGk7CgkJCWlzU3VwcG9ydGVkID0gKCBldmVudE5hbWUgaW4gZGl2ICk7CgkJCWlmICggIWlzU3VwcG9ydGVkICkgewoJCQkJZGl2LnNldEF0dHJpYnV0ZSggZXZlbnROYW1lLCAicmV0dXJuOyIgKTsKCQkJCWlzU3VwcG9ydGVkID0gKCB0eXBlb2YgZGl2WyBldmVudE5hbWUgXSA9PT0gImZ1bmN0aW9uIiApOwoJCQl9CgkJCXN1cHBvcnRbIGkgKyAiQnViYmxlcyIgXSA9IGlzU3VwcG9ydGVkOwoJCX0KCX0KCgkvLyBSdW4gdGVzdHMgdGhhdCBuZWVkIGEgYm9keSBhdCBkb2MgcmVhZHkKCWpRdWVyeShmdW5jdGlvbigpIHsKCQl2YXIgY29udGFpbmVyLCBkaXYsIHRkcywgbWFyZ2luRGl2LAoJCQlkaXZSZXNldCA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjA7ZGlzcGxheTpibG9jaztvdmVyZmxvdzpoaWRkZW47IiwKCQkJYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF07CgoJCWlmICggIWJvZHkgKSB7CgkJCS8vIFJldHVybiBmb3IgZnJhbWVzZXQgZG9jcyB0aGF0IGRvbid0IGhhdmUgYSBib2R5CgkJCXJldHVybjsKCQl9CgoJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCWNvbnRhaW5lci5zdHlsZS5jc3NUZXh0ID0gInZpc2liaWxpdHk6aGlkZGVuO2JvcmRlcjowO3dpZHRoOjA7aGVpZ2h0OjA7cG9zaXRpb246c3RhdGljO3RvcDowO21hcmdpbi10b3A6MXB4IjsKCQlib2R5Lmluc2VydEJlZm9yZSggY29udGFpbmVyLCBib2R5LmZpcnN0Q2hpbGQgKTsKCgkJLy8gQ29uc3RydWN0IHRoZSB0ZXN0IGVsZW1lbnQKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCQljb250YWluZXIuYXBwZW5kQ2hpbGQoIGRpdiApOwoKCQkvLyBDaGVjayBpZiB0YWJsZSBjZWxscyBzdGlsbCBoYXZlIG9mZnNldFdpZHRoL0hlaWdodCB3aGVuIHRoZXkgYXJlIHNldAoJCS8vIHRvIGRpc3BsYXk6bm9uZSBhbmQgdGhlcmUgYXJlIHN0aWxsIG90aGVyIHZpc2libGUgdGFibGUgY2VsbHMgaW4gYQoJCS8vIHRhYmxlIHJvdzsgaWYgc28sIG9mZnNldFdpZHRoL0hlaWdodCBhcmUgbm90IHJlbGlhYmxlIGZvciB1c2Ugd2hlbgoJCS8vIGRldGVybWluaW5nIGlmIGFuIGVsZW1lbnQgaGFzIGJlZW4gaGlkZGVuIGRpcmVjdGx5IHVzaW5nCgkJLy8gZGlzcGxheTpub25lIChpdCBpcyBzdGlsbCBzYWZlIHRvIHVzZSBvZmZzZXRzIGlmIGEgcGFyZW50IGVsZW1lbnQgaXMKCQkvLyBoaWRkZW47IGRvbiBzYWZldHkgZ29nZ2xlcyBhbmQgc2VlIGJ1ZyAjNDUxMiBmb3IgbW9yZSBpbmZvcm1hdGlvbikuCgkJLy8gKG9ubHkgSUUgOCBmYWlscyB0aGlzIHRlc3QpCgkJZGl2LmlubmVySFRNTCA9ICI8dGFibGU+PHRyPjx0ZD48L3RkPjx0ZD50PC90ZD48L3RyPjwvdGFibGU+IjsKCQl0ZHMgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRkIik7CgkJdGRzWyAwIF0uc3R5bGUuY3NzVGV4dCA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjA7ZGlzcGxheTpub25lIjsKCQlpc1N1cHBvcnRlZCA9ICggdGRzWyAwIF0ub2Zmc2V0SGVpZ2h0ID09PSAwICk7CgoJCXRkc1sgMCBdLnN0eWxlLmRpc3BsYXkgPSAiIjsKCQl0ZHNbIDEgXS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKCQkvLyBDaGVjayBpZiBlbXB0eSB0YWJsZSBjZWxscyBzdGlsbCBoYXZlIG9mZnNldFdpZHRoL0hlaWdodAoJCS8vIChJRSA8PSA4IGZhaWwgdGhpcyB0ZXN0KQoJCXN1cHBvcnQucmVsaWFibGVIaWRkZW5PZmZzZXRzID0gaXNTdXBwb3J0ZWQgJiYgKCB0ZHNbIDAgXS5vZmZzZXRIZWlnaHQgPT09IDAgKTsKCgkJLy8gQ2hlY2sgYm94LXNpemluZyBhbmQgbWFyZ2luIGJlaGF2aW9yCgkJZGl2LmlubmVySFRNTCA9ICIiOwoJCWRpdi5zdHlsZS5jc3NUZXh0ID0gImJveC1zaXppbmc6Ym9yZGVyLWJveDstbW96LWJveC1zaXppbmc6Ym9yZGVyLWJveDstd2Via2l0LWJveC1zaXppbmc6Ym9yZGVyLWJveDtwYWRkaW5nOjFweDtib3JkZXI6MXB4O2Rpc3BsYXk6YmxvY2s7d2lkdGg6NHB4O21hcmdpbi10b3A6MSU7cG9zaXRpb246YWJzb2x1dGU7dG9wOjElOyI7CgkJc3VwcG9ydC5ib3hTaXppbmcgPSAoIGRpdi5vZmZzZXRXaWR0aCA9PT0gNCApOwoJCXN1cHBvcnQuZG9lc05vdEluY2x1ZGVNYXJnaW5JbkJvZHlPZmZzZXQgPSAoIGJvZHkub2Zmc2V0VG9wICE9PSAxICk7CgoJCS8vIE5PVEU6IFRvIGFueSBmdXR1cmUgbWFpbnRhaW5lciwgd2luZG93LmdldENvbXB1dGVkU3R5bGUgd2FzIHVzZWQgaGVyZQoJCS8vIGluc3RlYWQgb2YgZ2V0Q29tcHV0ZWRTdHlsZSBiZWNhdXNlIGl0IGdhdmUgYSBiZXR0ZXIgZ3ppcCBzaXplLgoJCS8vIFRoZSBkaWZmZXJlbmNlIGJldHdlZW4gd2luZG93LmdldENvbXB1dGVkU3R5bGUgYW5kIGdldENvbXB1dGVkU3R5bGUgaXMKCQkvLyA3IGJ5dGVzCgkJaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKCQkJc3VwcG9ydC5waXhlbFBvc2l0aW9uID0gKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZGl2LCBudWxsICkgfHwge30gKS50b3AgIT09ICIxJSI7CgkJCXN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUgPSAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBkaXYsIG51bGwgKSB8fCB7IHdpZHRoOiAiNHB4IiB9ICkud2lkdGggPT09ICI0cHgiOwoKCQkJLy8gQ2hlY2sgaWYgZGl2IHdpdGggZXhwbGljaXQgd2lkdGggYW5kIG5vIG1hcmdpbi1yaWdodCBpbmNvcnJlY3RseQoJCQkvLyBnZXRzIGNvbXB1dGVkIG1hcmdpbi1yaWdodCBiYXNlZCBvbiB3aWR0aCBvZiBjb250YWluZXIuIEZvciBtb3JlCgkJCS8vIGluZm8gc2VlIGJ1ZyAjMzMzMwoJCQkvLyBGYWlscyBpbiBXZWJLaXQgYmVmb3JlIEZlYiAyMDExIG5pZ2h0bGllcwoJCQkvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKCQkJbWFyZ2luRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgkJCW1hcmdpbkRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2LnN0eWxlLmNzc1RleHQgPSBkaXZSZXNldDsKCQkJbWFyZ2luRGl2LnN0eWxlLm1hcmdpblJpZ2h0ID0gbWFyZ2luRGl2LnN0eWxlLndpZHRoID0gIjAiOwoJCQlkaXYuc3R5bGUud2lkdGggPSAiMXB4IjsKCQkJZGl2LmFwcGVuZENoaWxkKCBtYXJnaW5EaXYgKTsKCQkJc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ID0KCQkJCSFwYXJzZUZsb2F0KCAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBtYXJnaW5EaXYsIG51bGwgKSB8fCB7fSApLm1hcmdpblJpZ2h0ICk7CgkJfQoKCQlpZiAoIHR5cGVvZiBkaXYuc3R5bGUuem9vbSAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCS8vIENoZWNrIGlmIG5hdGl2ZWx5IGJsb2NrLWxldmVsIGVsZW1lbnRzIGFjdCBsaWtlIGlubGluZS1ibG9jawoJCQkvLyBlbGVtZW50cyB3aGVuIHNldHRpbmcgdGhlaXIgZGlzcGxheSB0byAnaW5saW5lJyBhbmQgZ2l2aW5nCgkJCS8vIHRoZW0gbGF5b3V0CgkJCS8vIChJRSA8IDggZG9lcyB0aGlzKQoJCQlkaXYuaW5uZXJIVE1MID0gIiI7CgkJCWRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2UmVzZXQgKyAid2lkdGg6MXB4O3BhZGRpbmc6MXB4O2Rpc3BsYXk6aW5saW5lO3pvb206MSI7CgkJCXN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCA9ICggZGl2Lm9mZnNldFdpZHRoID09PSAzICk7CgoJCQkvLyBDaGVjayBpZiBlbGVtZW50cyB3aXRoIGxheW91dCBzaHJpbmstd3JhcCB0aGVpciBjaGlsZHJlbgoJCQkvLyAoSUUgNiBkb2VzIHRoaXMpCgkJCWRpdi5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQkJZGl2LnN0eWxlLm92ZXJmbG93ID0gInZpc2libGUiOwoJCQlkaXYuaW5uZXJIVE1MID0gIjxkaXY+PC9kaXY+IjsKCQkJZGl2LmZpcnN0Q2hpbGQuc3R5bGUud2lkdGggPSAiNXB4IjsKCQkJc3VwcG9ydC5zaHJpbmtXcmFwQmxvY2tzID0gKCBkaXYub2Zmc2V0V2lkdGggIT09IDMgKTsKCgkJCWNvbnRhaW5lci5zdHlsZS56b29tID0gMTsKCQl9CgoJCS8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUKCQlib2R5LnJlbW92ZUNoaWxkKCBjb250YWluZXIgKTsKCQljb250YWluZXIgPSBkaXYgPSB0ZHMgPSBtYXJnaW5EaXYgPSBudWxsOwoJfSk7CgoJLy8gTnVsbCBlbGVtZW50cyB0byBhdm9pZCBsZWFrcyBpbiBJRQoJZnJhZ21lbnQucmVtb3ZlQ2hpbGQoIGRpdiApOwoJYWxsID0gYSA9IHNlbGVjdCA9IG9wdCA9IGlucHV0ID0gZnJhZ21lbnQgPSBkaXYgPSBudWxsOwoKCXJldHVybiBzdXBwb3J0Owp9KSgpOwp2YXIgcmJyYWNlID0gL14oPzpcey4qXH18XFsuKlxdKSQvLAoJcm11bHRpRGFzaCA9IC8oW0EtWl0pL2c7CgpqUXVlcnkuZXh0ZW5kKHsKCWNhY2hlOiB7fSwKCglkZWxldGVkSWRzOiBbXSwKCgkvLyBQbGVhc2UgdXNlIHdpdGggY2F1dGlvbgoJdXVpZDogMCwKCgkvLyBVbmlxdWUgZm9yIGVhY2ggY29weSBvZiBqUXVlcnkgb24gdGhlIHBhZ2UKCS8vIE5vbi1kaWdpdHMgcmVtb3ZlZCB0byBtYXRjaCByaW5saW5lalF1ZXJ5CglleHBhbmRvOiAialF1ZXJ5IiArICggalF1ZXJ5LmZuLmpxdWVyeSArIE1hdGgucmFuZG9tKCkgKS5yZXBsYWNlKCAvXEQvZywgIiIgKSwKCgkvLyBUaGUgZm9sbG93aW5nIGVsZW1lbnRzIHRocm93IHVuY2F0Y2hhYmxlIGV4Y2VwdGlvbnMgaWYgeW91CgkvLyBhdHRlbXB0IHRvIGFkZCBleHBhbmRvIHByb3BlcnRpZXMgdG8gdGhlbS4KCW5vRGF0YTogewoJCSJlbWJlZCI6IHRydWUsCgkJLy8gQmFuIGFsbCBvYmplY3RzIGV4Y2VwdCBmb3IgRmxhc2ggKHdoaWNoIGhhbmRsZSBleHBhbmRvcykKCQkib2JqZWN0IjogImNsc2lkOkQyN0NEQjZFLUFFNkQtMTFjZi05NkI4LTQ0NDU1MzU0MDAwMCIsCgkJImFwcGxldCI6IHRydWUKCX0sCgoJaGFzRGF0YTogZnVuY3Rpb24oIGVsZW0gKSB7CgkJZWxlbSA9IGVsZW0ubm9kZVR5cGUgPyBqUXVlcnkuY2FjaGVbIGVsZW1balF1ZXJ5LmV4cGFuZG9dIF0gOiBlbGVtWyBqUXVlcnkuZXhwYW5kbyBdOwoJCXJldHVybiAhIWVsZW0gJiYgIWlzRW1wdHlEYXRhT2JqZWN0KCBlbGVtICk7Cgl9LAoKCWRhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBkYXRhLCBwdnQgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7CgkJaWYgKCAhalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHRoaXNDYWNoZSwgcmV0LAoJCQlpbnRlcm5hbEtleSA9IGpRdWVyeS5leHBhbmRvLAoJCQlnZXRCeU5hbWUgPSB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIsCgoJCQkvLyBXZSBoYXZlIHRvIGhhbmRsZSBET00gbm9kZXMgYW5kIEpTIG9iamVjdHMgZGlmZmVyZW50bHkgYmVjYXVzZSBJRTYtNwoJCQkvLyBjYW4ndCBHQyBvYmplY3QgcmVmZXJlbmNlcyBwcm9wZXJseSBhY3Jvc3MgdGhlIERPTS1KUyBib3VuZGFyeQoJCQlpc05vZGUgPSBlbGVtLm5vZGVUeXBlLAoKCQkJLy8gT25seSBET00gbm9kZXMgbmVlZCB0aGUgZ2xvYmFsIGpRdWVyeSBjYWNoZTsgSlMgb2JqZWN0IGRhdGEgaXMKCQkJLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIG9iamVjdCBzbyBHQyBjYW4gb2NjdXIgYXV0b21hdGljYWxseQoJCQljYWNoZSA9IGlzTm9kZSA/IGpRdWVyeS5jYWNoZSA6IGVsZW0sCgoJCQkvLyBPbmx5IGRlZmluaW5nIGFuIElEIGZvciBKUyBvYmplY3RzIGlmIGl0cyBjYWNoZSBhbHJlYWR5IGV4aXN0cyBhbGxvd3MKCQkJLy8gdGhlIGNvZGUgdG8gc2hvcnRjdXQgb24gdGhlIHNhbWUgcGF0aCBhcyBhIERPTSBub2RlIHdpdGggbm8gY2FjaGUKCQkJaWQgPSBpc05vZGUgPyBlbGVtWyBpbnRlcm5hbEtleSBdIDogZWxlbVsgaW50ZXJuYWxLZXkgXSAmJiBpbnRlcm5hbEtleTsKCgkJLy8gQXZvaWQgZG9pbmcgYW55IG1vcmUgd29yayB0aGFuIHdlIG5lZWQgdG8gd2hlbiB0cnlpbmcgdG8gZ2V0IGRhdGEgb24gYW4KCQkvLyBvYmplY3QgdGhhdCBoYXMgbm8gZGF0YSBhdCBhbGwKCQlpZiAoICghaWQgfHwgIWNhY2hlW2lkXSB8fCAoIXB2dCAmJiAhY2FjaGVbaWRdLmRhdGEpKSAmJiBnZXRCeU5hbWUgJiYgZGF0YSA9PT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoICFpZCApIHsKCQkJLy8gT25seSBET00gbm9kZXMgbmVlZCBhIG5ldyB1bmlxdWUgSUQgZm9yIGVhY2ggZWxlbWVudCBzaW5jZSB0aGVpciBkYXRhCgkJCS8vIGVuZHMgdXAgaW4gdGhlIGdsb2JhbCBjYWNoZQoJCQlpZiAoIGlzTm9kZSApIHsKCQkJCWVsZW1bIGludGVybmFsS2V5IF0gPSBpZCA9IGpRdWVyeS5kZWxldGVkSWRzLnBvcCgpIHx8ICsralF1ZXJ5LnV1aWQ7CgkJCX0gZWxzZSB7CgkJCQlpZCA9IGludGVybmFsS2V5OwoJCQl9CgkJfQoKCQlpZiAoICFjYWNoZVsgaWQgXSApIHsKCQkJY2FjaGVbIGlkIF0gPSB7fTsKCgkJCS8vIEF2b2lkcyBleHBvc2luZyBqUXVlcnkgbWV0YWRhdGEgb24gcGxhaW4gSlMgb2JqZWN0cyB3aGVuIHRoZSBvYmplY3QKCQkJLy8gaXMgc2VyaWFsaXplZCB1c2luZyBKU09OLnN0cmluZ2lmeQoJCQlpZiAoICFpc05vZGUgKSB7CgkJCQljYWNoZVsgaWQgXS50b0pTT04gPSBqUXVlcnkubm9vcDsKCQkJfQoJCX0KCgkJLy8gQW4gb2JqZWN0IGNhbiBiZSBwYXNzZWQgdG8galF1ZXJ5LmRhdGEgaW5zdGVhZCBvZiBhIGtleS92YWx1ZSBwYWlyOyB0aGlzIGdldHMKCQkvLyBzaGFsbG93IGNvcGllZCBvdmVyIG9udG8gdGhlIGV4aXN0aW5nIGNhY2hlCgkJaWYgKCB0eXBlb2YgbmFtZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIG5hbWUgPT09ICJmdW5jdGlvbiIgKSB7CgkJCWlmICggcHZ0ICkgewoJCQkJY2FjaGVbIGlkIF0gPSBqUXVlcnkuZXh0ZW5kKCBjYWNoZVsgaWQgXSwgbmFtZSApOwoJCQl9IGVsc2UgewoJCQkJY2FjaGVbIGlkIF0uZGF0YSA9IGpRdWVyeS5leHRlbmQoIGNhY2hlWyBpZCBdLmRhdGEsIG5hbWUgKTsKCQkJfQoJCX0KCgkJdGhpc0NhY2hlID0gY2FjaGVbIGlkIF07CgoJCS8vIGpRdWVyeSBkYXRhKCkgaXMgc3RvcmVkIGluIGEgc2VwYXJhdGUgb2JqZWN0IGluc2lkZSB0aGUgb2JqZWN0J3MgaW50ZXJuYWwgZGF0YQoJCS8vIGNhY2hlIGluIG9yZGVyIHRvIGF2b2lkIGtleSBjb2xsaXNpb25zIGJldHdlZW4gaW50ZXJuYWwgZGF0YSBhbmQgdXNlci1kZWZpbmVkCgkJLy8gZGF0YS4KCQlpZiAoICFwdnQgKSB7CgkJCWlmICggIXRoaXNDYWNoZS5kYXRhICkgewoJCQkJdGhpc0NhY2hlLmRhdGEgPSB7fTsKCQkJfQoKCQkJdGhpc0NhY2hlID0gdGhpc0NhY2hlLmRhdGE7CgkJfQoKCQlpZiAoIGRhdGEgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpc0NhY2hlWyBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICkgXSA9IGRhdGE7CgkJfQoKCQkvLyBDaGVjayBmb3IgYm90aCBjb252ZXJ0ZWQtdG8tY2FtZWwgYW5kIG5vbi1jb252ZXJ0ZWQgZGF0YSBwcm9wZXJ0eSBuYW1lcwoJCS8vIElmIGEgZGF0YSBwcm9wZXJ0eSB3YXMgc3BlY2lmaWVkCgkJaWYgKCBnZXRCeU5hbWUgKSB7CgoJCQkvLyBGaXJzdCBUcnkgdG8gZmluZCBhcy1pcyBwcm9wZXJ0eSBkYXRhCgkJCXJldCA9IHRoaXNDYWNoZVsgbmFtZSBdOwoKCQkJLy8gVGVzdCBmb3IgbnVsbHx1bmRlZmluZWQgcHJvcGVydHkgZGF0YQoJCQlpZiAoIHJldCA9PSBudWxsICkgewoKCQkJCS8vIFRyeSB0byBmaW5kIHRoZSBjYW1lbENhc2VkIHByb3BlcnR5CgkJCQlyZXQgPSB0aGlzQ2FjaGVbIGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKSBdOwoJCQl9CgkJfSBlbHNlIHsKCQkJcmV0ID0gdGhpc0NhY2hlOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0sCgoJcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHB2dCAvKiBJbnRlcm5hbCBVc2UgT25seSAqLyApIHsKCQlpZiAoICFqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgdGhpc0NhY2hlLCBpLCBsLAoKCQkJaXNOb2RlID0gZWxlbS5ub2RlVHlwZSwKCgkJCS8vIFNlZSBqUXVlcnkuZGF0YSBmb3IgbW9yZSBpbmZvcm1hdGlvbgoJCQljYWNoZSA9IGlzTm9kZSA/IGpRdWVyeS5jYWNoZSA6IGVsZW0sCgkJCWlkID0gaXNOb2RlID8gZWxlbVsgalF1ZXJ5LmV4cGFuZG8gXSA6IGpRdWVyeS5leHBhbmRvOwoKCQkvLyBJZiB0aGVyZSBpcyBhbHJlYWR5IG5vIGNhY2hlIGVudHJ5IGZvciB0aGlzIG9iamVjdCwgdGhlcmUgaXMgbm8KCQkvLyBwdXJwb3NlIGluIGNvbnRpbnVpbmcKCQlpZiAoICFjYWNoZVsgaWQgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBuYW1lICkgewoKCQkJdGhpc0NhY2hlID0gcHZ0ID8gY2FjaGVbIGlkIF0gOiBjYWNoZVsgaWQgXS5kYXRhOwoKCQkJaWYgKCB0aGlzQ2FjaGUgKSB7CgoJCQkJLy8gU3VwcG9ydCBhcnJheSBvciBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIG5hbWVzIGZvciBkYXRhIGtleXMKCQkJCWlmICggIWpRdWVyeS5pc0FycmF5KCBuYW1lICkgKSB7CgoJCQkJCS8vIHRyeSB0aGUgc3RyaW5nIGFzIGEga2V5IGJlZm9yZSBhbnkgbWFuaXB1bGF0aW9uCgkJCQkJaWYgKCBuYW1lIGluIHRoaXNDYWNoZSApIHsKCQkJCQkJbmFtZSA9IFsgbmFtZSBdOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBzcGxpdCB0aGUgY2FtZWwgY2FzZWQgdmVyc2lvbiBieSBzcGFjZXMgdW5sZXNzIGEga2V5IHdpdGggdGhlIHNwYWNlcyBleGlzdHMKCQkJCQkJbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKTsKCQkJCQkJaWYgKCBuYW1lIGluIHRoaXNDYWNoZSApIHsKCQkJCQkJCW5hbWUgPSBbIG5hbWUgXTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW5hbWUgPSBuYW1lLnNwbGl0KCIgIik7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJZm9yICggaSA9IDAsIGwgPSBuYW1lLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCQlkZWxldGUgdGhpc0NhY2hlWyBuYW1lW2ldIF07CgkJCQl9CgoJCQkJLy8gSWYgdGhlcmUgaXMgbm8gZGF0YSBsZWZ0IGluIHRoZSBjYWNoZSwgd2Ugd2FudCB0byBjb250aW51ZQoJCQkJLy8gYW5kIGxldCB0aGUgY2FjaGUgb2JqZWN0IGl0c2VsZiBnZXQgZGVzdHJveWVkCgkJCQlpZiAoICEoIHB2dCA/IGlzRW1wdHlEYXRhT2JqZWN0IDogalF1ZXJ5LmlzRW1wdHlPYmplY3QgKSggdGhpc0NhY2hlICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBTZWUgalF1ZXJ5LmRhdGEgZm9yIG1vcmUgaW5mb3JtYXRpb24KCQlpZiAoICFwdnQgKSB7CgkJCWRlbGV0ZSBjYWNoZVsgaWQgXS5kYXRhOwoKCQkJLy8gRG9uJ3QgZGVzdHJveSB0aGUgcGFyZW50IGNhY2hlIHVubGVzcyB0aGUgaW50ZXJuYWwgZGF0YSBvYmplY3QKCQkJLy8gaGFkIGJlZW4gdGhlIG9ubHkgdGhpbmcgbGVmdCBpbiBpdAoJCQlpZiAoICFpc0VtcHR5RGF0YU9iamVjdCggY2FjaGVbIGlkIF0gKSApIHsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJLy8gRGVzdHJveSB0aGUgY2FjaGUKCQlpZiAoIGlzTm9kZSApIHsKCQkJalF1ZXJ5LmNsZWFuRGF0YSggWyBlbGVtIF0sIHRydWUgKTsKCgkJLy8gVXNlIGRlbGV0ZSB3aGVuIHN1cHBvcnRlZCBmb3IgZXhwYW5kb3Mgb3IgYGNhY2hlYCBpcyBub3QgYSB3aW5kb3cgcGVyIGlzV2luZG93ICgjMTAwODApCgkJfSBlbHNlIGlmICggalF1ZXJ5LnN1cHBvcnQuZGVsZXRlRXhwYW5kbyB8fCBjYWNoZSAhPSBjYWNoZS53aW5kb3cgKSB7CgkJCWRlbGV0ZSBjYWNoZVsgaWQgXTsKCgkJLy8gV2hlbiBhbGwgZWxzZSBmYWlscywgbnVsbAoJCX0gZWxzZSB7CgkJCWNhY2hlWyBpZCBdID0gbnVsbDsKCQl9Cgl9LAoKCS8vIEZvciBpbnRlcm5hbCB1c2Ugb25seS4KCV9kYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsKCQlyZXR1cm4galF1ZXJ5LmRhdGEoIGVsZW0sIG5hbWUsIGRhdGEsIHRydWUgKTsKCX0sCgoJLy8gQSBtZXRob2QgZm9yIGRldGVybWluaW5nIGlmIGEgRE9NIG5vZGUgY2FuIGhhbmRsZSB0aGUgZGF0YSBleHBhbmRvCglhY2NlcHREYXRhOiBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgbm9EYXRhID0gZWxlbS5ub2RlTmFtZSAmJiBqUXVlcnkubm9EYXRhWyBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCgkJLy8gbm9kZXMgYWNjZXB0IGRhdGEgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQ7IHJlamVjdGlvbiBjYW4gYmUgY29uZGl0aW9uYWwKCQlyZXR1cm4gIW5vRGF0YSB8fCBub0RhdGEgIT09IHRydWUgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzaWQiKSA9PT0gbm9EYXRhOwoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJZGF0YTogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIHBhcnRzLCBwYXJ0LCBhdHRyLCBuYW1lLCBsLAoJCQllbGVtID0gdGhpc1swXSwKCQkJaSA9IDAsCgkJCWRhdGEgPSBudWxsOwoKCQkvLyBHZXRzIGFsbCB2YWx1ZXMKCQlpZiAoIGtleSA9PT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMubGVuZ3RoICkgewoJCQkJZGF0YSA9IGpRdWVyeS5kYXRhKCBlbGVtICk7CgoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmICFqUXVlcnkuX2RhdGEoIGVsZW0sICJwYXJzZWRBdHRycyIgKSApIHsKCQkJCQlhdHRyID0gZWxlbS5hdHRyaWJ1dGVzOwoJCQkJCWZvciAoIGwgPSBhdHRyLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCQkJbmFtZSA9IGF0dHJbaV0ubmFtZTsKCgkJCQkJCWlmICggbmFtZS5pbmRleE9mKCAiZGF0YS0iICkgPT09IDAgKSB7CgkJCQkJCQluYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZS5zdWJzdHJpbmcoNSkgKTsKCgkJCQkJCQlkYXRhQXR0ciggZWxlbSwgbmFtZSwgZGF0YVsgbmFtZSBdICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJalF1ZXJ5Ll9kYXRhKCBlbGVtLCAicGFyc2VkQXR0cnMiLCB0cnVlICk7CgkJCQl9CgkJCX0KCgkJCXJldHVybiBkYXRhOwoJCX0KCgkJLy8gU2V0cyBtdWx0aXBsZSB2YWx1ZXMKCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJvYmplY3QiICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSApOwoJCQl9KTsKCQl9CgoJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIsIDIgKTsKCQlwYXJ0c1sxXSA9IHBhcnRzWzFdID8gIi4iICsgcGFydHNbMV0gOiAiIjsKCQlwYXJ0ID0gcGFydHNbMV0gKyAiISI7CgoJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggdmFsdWUgKSB7CgoJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlkYXRhID0gdGhpcy50cmlnZ2VySGFuZGxlciggImdldERhdGEiICsgcGFydCwgWyBwYXJ0c1swXSBdICk7CgoJCQkJLy8gVHJ5IHRvIGZldGNoIGFueSBpbnRlcm5hbGx5IHN0b3JlZCBkYXRhIGZpcnN0CgkJCQlpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtICkgewoJCQkJCWRhdGEgPSBqUXVlcnkuZGF0YSggZWxlbSwga2V5ICk7CgkJCQkJZGF0YSA9IGRhdGFBdHRyKCBlbGVtLCBrZXksIGRhdGEgKTsKCQkJCX0KCgkJCQlyZXR1cm4gZGF0YSA9PT0gdW5kZWZpbmVkICYmIHBhcnRzWzFdID8KCQkJCQl0aGlzLmRhdGEoIHBhcnRzWzBdICkgOgoJCQkJCWRhdGE7CgkJCX0KCgkJCXBhcnRzWzFdID0gdmFsdWU7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0galF1ZXJ5KCB0aGlzICk7CgoJCQkJc2VsZi50cmlnZ2VySGFuZGxlciggInNldERhdGEiICsgcGFydCwgcGFydHMgKTsKCQkJCWpRdWVyeS5kYXRhKCB0aGlzLCBrZXksIHZhbHVlICk7CgkJCQlzZWxmLnRyaWdnZXJIYW5kbGVyKCAiY2hhbmdlRGF0YSIgKyBwYXJ0LCBwYXJ0cyApOwoJCQl9KTsKCQl9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEsIG51bGwsIGZhbHNlICk7Cgl9LAoKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBrZXkgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LnJlbW92ZURhdGEoIHRoaXMsIGtleSApOwoJCX0pOwoJfQp9KTsKCmZ1bmN0aW9uIGRhdGFBdHRyKCBlbGVtLCBrZXksIGRhdGEgKSB7CgkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbnRlcm5hbGx5LCB0cnkgdG8gZmV0Y2ggYW55CgkvLyBkYXRhIGZyb20gdGhlIEhUTUw1IGRhdGEtKiBhdHRyaWJ1dGUKCWlmICggZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgoJCXZhciBuYW1lID0gImRhdGEtIiArIGtleS5yZXBsYWNlKCBybXVsdGlEYXNoLCAiLSQxIiApLnRvTG93ZXJDYXNlKCk7CgoJCWRhdGEgPSBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApOwoKCQlpZiAoIHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiApIHsKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCWRhdGEgPT09ICJmYWxzZSIgPyBmYWxzZSA6CgkJCQlkYXRhID09PSAibnVsbCIgPyBudWxsIDoKCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkrZGF0YSArICIiID09PSBkYXRhID8gK2RhdGEgOgoJCQkJcmJyYWNlLnRlc3QoIGRhdGEgKSA/IGpRdWVyeS5wYXJzZUpTT04oIGRhdGEgKSA6CgkJCQkJZGF0YTsKCQkJfSBjYXRjaCggZSApIHt9CgoJCQkvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKCQkJalF1ZXJ5LmRhdGEoIGVsZW0sIGtleSwgZGF0YSApOwoKCQl9IGVsc2UgewoJCQlkYXRhID0gdW5kZWZpbmVkOwoJCX0KCX0KCglyZXR1cm4gZGF0YTsKfQoKLy8gY2hlY2tzIGEgY2FjaGUgb2JqZWN0IGZvciBlbXB0aW5lc3MKZnVuY3Rpb24gaXNFbXB0eURhdGFPYmplY3QoIG9iaiApIHsKCXZhciBuYW1lOwoJZm9yICggbmFtZSBpbiBvYmogKSB7CgoJCS8vIGlmIHRoZSBwdWJsaWMgZGF0YSBvYmplY3QgaXMgZW1wdHksIHRoZSBwcml2YXRlIGlzIHN0aWxsIGVtcHR5CgkJaWYgKCBuYW1lID09PSAiZGF0YSIgJiYgalF1ZXJ5LmlzRW1wdHlPYmplY3QoIG9ialtuYW1lXSApICkgewoJCQljb250aW51ZTsKCQl9CgkJaWYgKCBuYW1lICE9PSAidG9KU09OIiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0KCglyZXR1cm4gdHJ1ZTsKfQpqUXVlcnkuZXh0ZW5kKHsKCXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSwgZGF0YSApIHsKCQl2YXIgcXVldWU7CgoJCWlmICggZWxlbSApIHsKCQkJdHlwZSA9ICggdHlwZSB8fCAiZngiICkgKyAicXVldWUiOwoJCQlxdWV1ZSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgdHlwZSApOwoKCQkJLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAoJCQlpZiAoIGRhdGEgKSB7CgkJCQlpZiAoICFxdWV1ZSB8fCBqUXVlcnkuaXNBcnJheShkYXRhKSApIHsKCQkJCQlxdWV1ZSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheShkYXRhKSApOwoJCQkJfSBlbHNlIHsKCQkJCQlxdWV1ZS5wdXNoKCBkYXRhICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHF1ZXVlIHx8IFtdOwoJCX0KCX0sCgoJZGVxdWV1ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGUgKSB7CgkJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCgkJdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKCBlbGVtLCB0eXBlICksCgkJCWZuID0gcXVldWUuc2hpZnQoKSwKCQkJaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sIHR5cGUgKSwKCQkJbmV4dCA9IGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5LmRlcXVldWUoIGVsZW0sIHR5cGUgKTsKCQkJfTsKCgkJLy8gSWYgdGhlIGZ4IHF1ZXVlIGlzIGRlcXVldWVkLCBhbHdheXMgcmVtb3ZlIHRoZSBwcm9ncmVzcyBzZW50aW5lbAoJCWlmICggZm4gPT09ICJpbnByb2dyZXNzIiApIHsKCQkJZm4gPSBxdWV1ZS5zaGlmdCgpOwoJCX0KCgkJaWYgKCBmbiApIHsKCgkJCS8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKCQkJLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAoJCQlpZiAoIHR5cGUgPT09ICJmeCIgKSB7CgkJCQlxdWV1ZS51bnNoaWZ0KCAiaW5wcm9ncmVzcyIgKTsKCQkJfQoKCQkJLy8gY2xlYXIgdXAgdGhlIGxhc3QgcXVldWUgc3RvcCBmdW5jdGlvbgoJCQlkZWxldGUgaG9va3Muc3RvcDsKCQkJZm4uY2FsbCggZWxlbSwgbmV4dCwgaG9va3MgKTsKCQl9CgkJaWYgKCAhcXVldWUubGVuZ3RoICYmIGhvb2tzICkgewoJCQlob29rcy5lbXB0eS5maXJlKCk7CgkJfQoJfSwKCgkvLyBub3QgaW50ZW5kZWQgZm9yIHB1YmxpYyBjb25zdW1wdGlvbiAtIGdlbmVyYXRlcyBhIHF1ZXVlSG9va3Mgb2JqZWN0LCBvciByZXR1cm5zIHRoZSBjdXJyZW50IG9uZQoJX3F1ZXVlSG9va3M6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlICkgewoJCXZhciBrZXkgPSB0eXBlICsgInF1ZXVlSG9va3MiOwoJCXJldHVybiBqUXVlcnkuX2RhdGEoIGVsZW0sIGtleSApIHx8IGpRdWVyeS5fZGF0YSggZWxlbSwga2V5LCB7CgkJCWVtcHR5OiBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLmFkZChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeS5yZW1vdmVEYXRhKCBlbGVtLCB0eXBlICsgInF1ZXVlIiwgdHJ1ZSApOwoJCQkJalF1ZXJ5LnJlbW92ZURhdGEoIGVsZW0sIGtleSwgdHJ1ZSApOwoJCQl9KQoJCX0pOwoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJcXVldWU6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCXZhciBzZXR0ZXIgPSAyOwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZGF0YSA9IHR5cGU7CgkJCXR5cGUgPSAiZngiOwoJCQlzZXR0ZXItLTsKCQl9CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlciApIHsKCQkJcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1swXSwgdHlwZSApOwoJCX0KCgkJcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/CgkJCXRoaXMgOgoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIGRhdGEgKTsKCgkJCQkvLyBlbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQoJCQkJalF1ZXJ5Ll9xdWV1ZUhvb2tzKCB0aGlzLCB0eXBlICk7CgoJCQkJaWYgKCB0eXBlID09PSAiZngiICYmIHF1ZXVlWzBdICE9PSAiaW5wcm9ncmVzcyIgKSB7CgkJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQkJCX0KCQkJfSk7Cgl9LAoJZGVxdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQl9KTsKCX0sCgkvLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uCgkvLyBodHRwOi8vYmxpbmRzaWduYWxzLmNvbS9pbmRleC5waHAvMjAwOS8wNy9qcXVlcnktZGVsYXkvCglkZWxheTogZnVuY3Rpb24oIHRpbWUsIHR5cGUgKSB7CgkJdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbIHRpbWUgXSB8fCB0aW1lIDogdGltZTsKCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oIG5leHQsIGhvb2tzICkgewoJCQl2YXIgdGltZW91dCA9IHNldFRpbWVvdXQoIG5leHQsIHRpbWUgKTsKCQkJaG9va3Muc3RvcCA9IGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lb3V0ICk7CgkJCX07CgkJfSk7Cgl9LAoJY2xlYXJRdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCX0sCgkvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlCgkvLyBhcmUgZW1wdGllZCAoZnggaXMgdGhlIHR5cGUgYnkgZGVmYXVsdCkKCXByb21pc2U6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7CgkJdmFyIHRtcCwKCQkJY291bnQgPSAxLAoJCQlkZWZlciA9IGpRdWVyeS5EZWZlcnJlZCgpLAoJCQllbGVtZW50cyA9IHRoaXMsCgkJCWkgPSB0aGlzLmxlbmd0aCwKCQkJcmVzb2x2ZSA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAhKCAtLWNvdW50ICkgKSB7CgkJCQkJZGVmZXIucmVzb2x2ZVdpdGgoIGVsZW1lbnRzLCBbIGVsZW1lbnRzIF0gKTsKCQkJCX0KCQkJfTsKCgkJaWYgKCB0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIgKSB7CgkJCW9iaiA9IHR5cGU7CgkJCXR5cGUgPSB1bmRlZmluZWQ7CgkJfQoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXdoaWxlKCBpLS0gKSB7CgkJCWlmICggKHRtcCA9IGpRdWVyeS5fZGF0YSggZWxlbWVudHNbIGkgXSwgdHlwZSArICJxdWV1ZUhvb2tzIiApKSAmJiB0bXAuZW1wdHkgKSB7CgkJCQljb3VudCsrOwoJCQkJdG1wLmVtcHR5LmFkZCggcmVzb2x2ZSApOwoJCQl9CgkJfQoJCXJlc29sdmUoKTsKCQlyZXR1cm4gZGVmZXIucHJvbWlzZSggb2JqICk7Cgl9Cn0pOwp2YXIgbm9kZUhvb2ssIGJvb2xIb29rLCBmaXhTcGVjaWZpZWQsCglyY2xhc3MgPSAvW1x0XHJcbl0vZywKCXJyZXR1cm4gPSAvXHIvZywKCXJ0eXBlID0gL14oPzpidXR0b258aW5wdXQpJC9pLAoJcmZvY3VzYWJsZSA9IC9eKD86YnV0dG9ufGlucHV0fG9iamVjdHxzZWxlY3R8dGV4dGFyZWEpJC9pLAoJcmNsaWNrYWJsZSA9IC9eYSg/OnJlYXwpJC9pLAoJcmJvb2xlYW4gPSAvXig/OmF1dG9mb2N1c3xhdXRvcGxheXxhc3luY3xjaGVja2VkfGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkfHNlbGVjdGVkKSQvaSwKCWdldFNldEF0dHJpYnV0ZSA9IGpRdWVyeS5zdXBwb3J0LmdldFNldEF0dHJpYnV0ZTsKCmpRdWVyeS5mbi5leHRlbmQoewoJYXR0cjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBqUXVlcnkuYXR0ciwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5yZW1vdmVBdHRyKCB0aGlzLCBuYW1lICk7CgkJfSk7Cgl9LAoKCXByb3A6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwoJfSwKCglyZW1vdmVQcm9wOiBmdW5jdGlvbiggbmFtZSApIHsKCQluYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCS8vIHRyeS9jYXRjaCBoYW5kbGVzIGNhc2VzIHdoZXJlIElFIGJhbGtzIChzdWNoIGFzIHJlbW92aW5nIGEgcHJvcGVydHkgb24gd2luZG93KQoJCQl0cnkgewoJCQkJdGhpc1sgbmFtZSBdID0gdW5kZWZpbmVkOwoJCQkJZGVsZXRlIHRoaXNbIG5hbWUgXTsKCQkJfSBjYXRjaCggZSApIHt9CgkJfSk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzTmFtZXMsIGksIGwsIGVsZW0sCgkJCXNldENsYXNzLCBjLCBjbDsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaiApIHsKCQkJCWpRdWVyeSggdGhpcyApLmFkZENsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lKSApOwoJCQl9KTsKCQl9CgoJCWlmICggdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiApIHsKCQkJY2xhc3NOYW1lcyA9IHZhbHVlLnNwbGl0KCBjb3JlX3JzcGFjZSApOwoKCQkJZm9yICggaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCWVsZW0gPSB0aGlzWyBpIF07CgoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCWlmICggIWVsZW0uY2xhc3NOYW1lICYmIGNsYXNzTmFtZXMubGVuZ3RoID09PSAxICkgewoJCQkJCQllbGVtLmNsYXNzTmFtZSA9IHZhbHVlOwoKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRDbGFzcyA9ICIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiOwoKCQkJCQkJZm9yICggYyA9IDAsIGNsID0gY2xhc3NOYW1lcy5sZW5ndGg7IGMgPCBjbDsgYysrICkgewoJCQkJCQkJaWYgKCAhfnNldENsYXNzLmluZGV4T2YoICIgIiArIGNsYXNzTmFtZXNbIGMgXSArICIgIiApICkgewoJCQkJCQkJCXNldENsYXNzICs9IGNsYXNzTmFtZXNbIGMgXSArICIgIjsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQllbGVtLmNsYXNzTmFtZSA9IGpRdWVyeS50cmltKCBzZXRDbGFzcyApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIHJlbW92ZXMsIGNsYXNzTmFtZSwgZWxlbSwgYywgY2wsIGksIGw7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGogKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5yZW1vdmVDbGFzcyggdmFsdWUuY2FsbCh0aGlzLCBqLCB0aGlzLmNsYXNzTmFtZSkgKTsKCQkJfSk7CgkJfQoJCWlmICggKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHx8IHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCXJlbW92ZXMgPSAoIHZhbHVlIHx8ICIiICkuc3BsaXQoIGNvcmVfcnNwYWNlICk7CgoJCQlmb3IgKCBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJZWxlbSA9IHRoaXNbIGkgXTsKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiBlbGVtLmNsYXNzTmFtZSApIHsKCgkJCQkJY2xhc3NOYW1lID0gKCIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKCByY2xhc3MsICIgIiApOwoKCQkJCQkvLyBsb29wIG92ZXIgZWFjaCBpdGVtIGluIHRoZSByZW1vdmFsIGxpc3QKCQkJCQlmb3IgKCBjID0gMCwgY2wgPSByZW1vdmVzLmxlbmd0aDsgYyA8IGNsOyBjKysgKSB7CgkJCQkJCS8vIFJlbW92ZSB1bnRpbCB0aGVyZSBpcyBub3RoaW5nIHRvIHJlbW92ZSwKCQkJCQkJd2hpbGUgKCBjbGFzc05hbWUuaW5kZXhPZigiICIgKyByZW1vdmVzWyBjIF0gKyAiICIpID4gLTEgKSB7CgkJCQkJCQljbGFzc05hbWUgPSBjbGFzc05hbWUucmVwbGFjZSggIiAiICsgcmVtb3Zlc1sgYyBdICsgIiAiICwgIiAiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJZWxlbS5jbGFzc05hbWUgPSB2YWx1ZSA/IGpRdWVyeS50cmltKCBjbGFzc05hbWUgKSA6ICIiOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSwgc3RhdGVWYWwgKSB7CgkJdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWUsCgkJCWlzQm9vbCA9IHR5cGVvZiBzdGF0ZVZhbCA9PT0gImJvb2xlYW4iOwoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQkJalF1ZXJ5KCB0aGlzICkudG9nZ2xlQ2xhc3MoIHZhbHVlLmNhbGwodGhpcywgaSwgdGhpcy5jbGFzc05hbWUsIHN0YXRlVmFsKSwgc3RhdGVWYWwgKTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHR5cGUgPT09ICJzdHJpbmciICkgewoJCQkJLy8gdG9nZ2xlIGluZGl2aWR1YWwgY2xhc3MgbmFtZXMKCQkJCXZhciBjbGFzc05hbWUsCgkJCQkJaSA9IDAsCgkJCQkJc2VsZiA9IGpRdWVyeSggdGhpcyApLAoJCQkJCXN0YXRlID0gc3RhdGVWYWwsCgkJCQkJY2xhc3NOYW1lcyA9IHZhbHVlLnNwbGl0KCBjb3JlX3JzcGFjZSApOwoKCQkJCXdoaWxlICggKGNsYXNzTmFtZSA9IGNsYXNzTmFtZXNbIGkrKyBdKSApIHsKCQkJCQkvLyBjaGVjayBlYWNoIGNsYXNzTmFtZSBnaXZlbiwgc3BhY2Ugc2VwYXJhdGVkIGxpc3QKCQkJCQlzdGF0ZSA9IGlzQm9vbCA/IHN0YXRlIDogIXNlbGYuaGFzQ2xhc3MoIGNsYXNzTmFtZSApOwoJCQkJCXNlbGZbIHN0YXRlID8gImFkZENsYXNzIiA6ICJyZW1vdmVDbGFzcyIgXSggY2xhc3NOYW1lICk7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKCB0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlID09PSAiYm9vbGVhbiIgKSB7CgkJCQlpZiAoIHRoaXMuY2xhc3NOYW1lICkgewoJCQkJCS8vIHN0b3JlIGNsYXNzTmFtZSBpZiBzZXQKCQkJCQlqUXVlcnkuX2RhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgdGhpcy5jbGFzc05hbWUgKTsKCQkJCX0KCgkJCQkvLyB0b2dnbGUgd2hvbGUgY2xhc3NOYW1lCgkJCQl0aGlzLmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lIHx8IHZhbHVlID09PSBmYWxzZSA/ICIiIDogalF1ZXJ5Ll9kYXRhKCB0aGlzLCAiX19jbGFzc05hbWVfXyIgKSB8fCAiIjsKCQkJfQoJCX0pOwoJfSwKCgloYXNDbGFzczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBjbGFzc05hbWUgPSAiICIgKyBzZWxlY3RvciArICIgIiwKCQkJaSA9IDAsCgkJCWwgPSB0aGlzLmxlbmd0aDsKCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCWlmICggdGhpc1tpXS5ub2RlVHlwZSA9PT0gMSAmJiAoIiAiICsgdGhpc1tpXS5jbGFzc05hbWUgKyAiICIpLnJlcGxhY2UocmNsYXNzLCAiICIpLmluZGV4T2YoIGNsYXNzTmFtZSApID4gLTEgKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCgkJcmV0dXJuIGZhbHNlOwoJfSwKCgl2YWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgaG9va3MsIHJldCwgaXNGdW5jdGlvbiwKCQkJZWxlbSA9IHRoaXNbMF07CgoJCWlmICggIWFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCWlmICggZWxlbSApIHsKCQkJCWhvb2tzID0galF1ZXJ5LnZhbEhvb2tzWyBlbGVtLnR5cGUgXSB8fCBqUXVlcnkudmFsSG9va3NbIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOwoKCQkJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgInZhbHVlIiApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiByZXQ7CgkJCQl9CgoJCQkJcmV0ID0gZWxlbS52YWx1ZTsKCgkJCQlyZXR1cm4gdHlwZW9mIHJldCA9PT0gInN0cmluZyIgPwoJCQkJCS8vIGhhbmRsZSBtb3N0IGNvbW1vbiBzdHJpbmcgY2FzZXMKCQkJCQlyZXQucmVwbGFjZShycmV0dXJuLCAiIikgOgoJCQkJCS8vIGhhbmRsZSBjYXNlcyB3aGVyZSB2YWx1ZSBpcyBudWxsL3VuZGVmIG9yIG51bWJlcgoJCQkJCXJldCA9PSBudWxsID8gIiIgOiByZXQ7CgkJCX0KCgkJCXJldHVybjsKCQl9CgoJCWlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKTsKCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJdmFyIHZhbCwKCQkJCXNlbGYgPSBqUXVlcnkodGhpcyk7CgoJCQlpZiAoIHRoaXMubm9kZVR5cGUgIT09IDEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggaXNGdW5jdGlvbiApIHsKCQkJCXZhbCA9IHZhbHVlLmNhbGwoIHRoaXMsIGksIHNlbGYudmFsKCkgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbCA9IHZhbHVlOwoJCQl9CgoJCQkvLyBUcmVhdCBudWxsL3VuZGVmaW5lZCBhcyAiIjsgY29udmVydCBudW1iZXJzIHRvIHN0cmluZwoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gIiI7CgkJCX0gZWxzZSBpZiAoIHR5cGVvZiB2YWwgPT09ICJudW1iZXIiICkgewoJCQkJdmFsICs9ICIiOwoJCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNBcnJheSggdmFsICkgKSB7CgkJCQl2YWwgPSBqUXVlcnkubWFwKHZhbCwgZnVuY3Rpb24gKCB2YWx1ZSApIHsKCQkJCQlyZXR1cm4gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKyAiIjsKCQkJCX0pOwoJCQl9CgoJCQlob29rcyA9IGpRdWVyeS52YWxIb29rc1sgdGhpcy50eXBlIF0gfHwgalF1ZXJ5LnZhbEhvb2tzWyB0aGlzLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCgkJCS8vIElmIHNldCByZXR1cm5zIHVuZGVmaW5lZCwgZmFsbCBiYWNrIHRvIG5vcm1hbCBzZXR0aW5nCgkJCWlmICggIWhvb2tzIHx8ICEoInNldCIgaW4gaG9va3MpIHx8IGhvb2tzLnNldCggdGhpcywgdmFsLCAidmFsdWUiICkgPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMudmFsdWUgPSB2YWw7CgkJCX0KCQl9KTsKCX0KfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCXZhbEhvb2tzOiB7CgkJb3B0aW9uOiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkvLyBhdHRyaWJ1dGVzLnZhbHVlIGlzIHVuZGVmaW5lZCBpbiBCbGFja2JlcnJ5IDQuNyBidXQKCQkJCS8vIHVzZXMgLnZhbHVlLiBTZWUgIzY5MzIKCQkJCXZhciB2YWwgPSBlbGVtLmF0dHJpYnV0ZXMudmFsdWU7CgkJCQlyZXR1cm4gIXZhbCB8fCB2YWwuc3BlY2lmaWVkID8gZWxlbS52YWx1ZSA6IGVsZW0udGV4dDsKCQkJfQoJCX0sCgkJc2VsZWN0OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgdmFsdWUsIGksIG1heCwgb3B0aW9uLAoJCQkJCWluZGV4ID0gZWxlbS5zZWxlY3RlZEluZGV4LAoJCQkJCXZhbHVlcyA9IFtdLAoJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJb25lID0gZWxlbS50eXBlID09PSAic2VsZWN0LW9uZSI7CgoJCQkJLy8gTm90aGluZyB3YXMgc2VsZWN0ZWQKCQkJCWlmICggaW5kZXggPCAwICkgewoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoKCQkJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHNlbGVjdGVkIG9wdGlvbnMKCQkJCWkgPSBvbmUgPyBpbmRleCA6IDA7CgkJCQltYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aDsKCQkJCWZvciAoIDsgaSA8IG1heDsgaSsrICkgewoJCQkJCW9wdGlvbiA9IG9wdGlvbnNbIGkgXTsKCgkJCQkJLy8gRG9uJ3QgcmV0dXJuIG9wdGlvbnMgdGhhdCBhcmUgZGlzYWJsZWQgb3IgaW4gYSBkaXNhYmxlZCBvcHRncm91cAoJCQkJCWlmICggb3B0aW9uLnNlbGVjdGVkICYmIChqUXVlcnkuc3VwcG9ydC5vcHREaXNhYmxlZCA/ICFvcHRpb24uZGlzYWJsZWQgOiBvcHRpb24uZ2V0QXR0cmlidXRlKCJkaXNhYmxlZCIpID09PSBudWxsKSAmJgoJCQkJCQkJKCFvcHRpb24ucGFyZW50Tm9kZS5kaXNhYmxlZCB8fCAhalF1ZXJ5Lm5vZGVOYW1lKCBvcHRpb24ucGFyZW50Tm9kZSwgIm9wdGdyb3VwIiApKSApIHsKCgkJCQkJCS8vIEdldCB0aGUgc3BlY2lmaWMgdmFsdWUgZm9yIHRoZSBvcHRpb24KCQkJCQkJdmFsdWUgPSBqUXVlcnkoIG9wdGlvbiApLnZhbCgpOwoKCQkJCQkJLy8gV2UgZG9uJ3QgbmVlZCBhbiBhcnJheSBmb3Igb25lIHNlbGVjdHMKCQkJCQkJaWYgKCBvbmUgKSB7CgkJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJCX0KCgkJCQkJCS8vIE11bHRpLVNlbGVjdHMgcmV0dXJuIGFuIGFycmF5CgkJCQkJCXZhbHVlcy5wdXNoKCB2YWx1ZSApOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBGaXhlcyBCdWcgIzI1NTEgLS0gc2VsZWN0LnZhbCgpIGJyb2tlbiBpbiBJRSBhZnRlciBmb3JtLnJlc2V0KCkKCQkJCWlmICggb25lICYmICF2YWx1ZXMubGVuZ3RoICYmIG9wdGlvbnMubGVuZ3RoICkgewoJCQkJCXJldHVybiBqUXVlcnkoIG9wdGlvbnNbIGluZGV4IF0gKS52YWwoKTsKCQkJCX0KCgkJCQlyZXR1cm4gdmFsdWVzOwoJCQl9LAoKCQkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCQl2YXIgdmFsdWVzID0galF1ZXJ5Lm1ha2VBcnJheSggdmFsdWUgKTsKCgkJCQlqUXVlcnkoZWxlbSkuZmluZCgib3B0aW9uIikuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl0aGlzLnNlbGVjdGVkID0galF1ZXJ5LmluQXJyYXkoIGpRdWVyeSh0aGlzKS52YWwoKSwgdmFsdWVzICkgPj0gMDsKCQkJCX0pOwoKCQkJCWlmICggIXZhbHVlcy5sZW5ndGggKSB7CgkJCQkJZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CgkJCQl9CgkJCQlyZXR1cm4gdmFsdWVzOwoJCQl9CgkJfQoJfSwKCglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUsIHBhc3MgKSB7CgkJdmFyIHJldCwgaG9va3MsIG5vdHhtbCwKCQkJblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKCQkvLyBkb24ndCBnZXQvc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBwYXNzICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBqUXVlcnkuZm5bIG5hbWUgXSApICkgewoJCQlyZXR1cm4galF1ZXJ5KCBlbGVtIClbIG5hbWUgXSggdmFsdWUgKTsKCQl9CgoJCS8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkCgkJaWYgKCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09ICJ1bmRlZmluZWQiICkgewoJCQlyZXR1cm4galF1ZXJ5LnByb3AoIGVsZW0sIG5hbWUsIHZhbHVlICk7CgkJfQoKCQlub3R4bWwgPSBuVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKCBlbGVtICk7CgoJCS8vIEFsbCBhdHRyaWJ1dGVzIGFyZSBsb3dlcmNhc2UKCQkvLyBHcmFiIG5lY2Vzc2FyeSBob29rIGlmIG9uZSBpcyBkZWZpbmVkCgkJaWYgKCBub3R4bWwgKSB7CgkJCW5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CgkJCWhvb2tzID0galF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdIHx8ICggcmJvb2xlYW4udGVzdCggbmFtZSApID8gYm9vbEhvb2sgOiBub2RlSG9vayApOwoJCX0KCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoKCQkJaWYgKCB2YWx1ZSA9PT0gbnVsbCApIHsKCQkJCWpRdWVyeS5yZW1vdmVBdHRyKCBlbGVtLCBuYW1lICk7CgkJCQlyZXR1cm47CgoJCQl9IGVsc2UgaWYgKCBob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiBub3R4bWwgJiYgKHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiByZXQ7CgoJCQl9IGVsc2UgewoJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsICIiICsgdmFsdWUgKTsKCQkJCXJldHVybiB2YWx1ZTsKCQkJfQoKCQl9IGVsc2UgaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiBub3R4bWwgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgbmFtZSApKSAhPT0gbnVsbCApIHsKCQkJcmV0dXJuIHJldDsKCgkJfSBlbHNlIHsKCgkJCXJldCA9IGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICk7CgoJCQkvLyBOb24tZXhpc3RlbnQgYXR0cmlidXRlcyByZXR1cm4gbnVsbCwgd2Ugbm9ybWFsaXplIHRvIHVuZGVmaW5lZAoJCQlyZXR1cm4gcmV0ID09PSBudWxsID8KCQkJCXVuZGVmaW5lZCA6CgkJCQlyZXQ7CgkJfQoJfSwKCglyZW1vdmVBdHRyOiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJdmFyIHByb3BOYW1lLCBhdHRyTmFtZXMsIG5hbWUsIGlzQm9vbCwKCQkJaSA9IDA7CgoJCWlmICggdmFsdWUgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCgkJCWF0dHJOYW1lcyA9IHZhbHVlLnNwbGl0KCBjb3JlX3JzcGFjZSApOwoKCQkJZm9yICggOyBpIDwgYXR0ck5hbWVzLmxlbmd0aDsgaSsrICkgewoJCQkJbmFtZSA9IGF0dHJOYW1lc1sgaSBdOwoKCQkJCWlmICggbmFtZSApIHsKCQkJCQlwcm9wTmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCQkJCQlpc0Jvb2wgPSByYm9vbGVhbi50ZXN0KCBuYW1lICk7CgoJCQkJCS8vIFNlZSAjOTY5OSBmb3IgZXhwbGFuYXRpb24gb2YgdGhpcyBhcHByb2FjaCAoc2V0dGluZyBmaXJzdCwgdGhlbiByZW1vdmFsKQoJCQkJCS8vIERvIG5vdCBkbyB0aGlzIGZvciBib29sZWFuIGF0dHJpYnV0ZXMgKHNlZSAjMTA4NzApCgkJCQkJaWYgKCAhaXNCb29sICkgewoJCQkJCQlqUXVlcnkuYXR0ciggZWxlbSwgbmFtZSwgIiIgKTsKCQkJCQl9CgkJCQkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoIGdldFNldEF0dHJpYnV0ZSA/IG5hbWUgOiBwcm9wTmFtZSApOwoKCQkJCQkvLyBTZXQgY29ycmVzcG9uZGluZyBwcm9wZXJ0eSB0byBmYWxzZSBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCgkJCQkJaWYgKCBpc0Jvb2wgJiYgcHJvcE5hbWUgaW4gZWxlbSApIHsKCQkJCQkJZWxlbVsgcHJvcE5hbWUgXSA9IGZhbHNlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0sCgoJYXR0ckhvb2tzOiB7CgkJdHlwZTogewoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCS8vIFdlIGNhbid0IGFsbG93IHRoZSB0eXBlIHByb3BlcnR5IHRvIGJlIGNoYW5nZWQgKHNpbmNlIGl0IGNhdXNlcyBwcm9ibGVtcyBpbiBJRSkKCQkJCWlmICggcnR5cGUudGVzdCggZWxlbS5ub2RlTmFtZSApICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQlqUXVlcnkuZXJyb3IoICJ0eXBlIHByb3BlcnR5IGNhbid0IGJlIGNoYW5nZWQiICk7CgkJCQl9IGVsc2UgaWYgKCAhalF1ZXJ5LnN1cHBvcnQucmFkaW9WYWx1ZSAmJiB2YWx1ZSA9PT0gInJhZGlvIiAmJiBqUXVlcnkubm9kZU5hbWUoZWxlbSwgImlucHV0IikgKSB7CgkJCQkJLy8gU2V0dGluZyB0aGUgdHlwZSBvbiBhIHJhZGlvIGJ1dHRvbiBhZnRlciB0aGUgdmFsdWUgcmVzZXRzIHRoZSB2YWx1ZSBpbiBJRTYtOQoJCQkJCS8vIFJlc2V0IHZhbHVlIHRvIGl0J3MgZGVmYXVsdCBpbiBjYXNlIHR5cGUgaXMgc2V0IGFmdGVyIHZhbHVlCgkJCQkJLy8gVGhpcyBpcyBmb3IgZWxlbWVudCBjcmVhdGlvbgoJCQkJCXZhciB2YWwgPSBlbGVtLnZhbHVlOwoJCQkJCWVsZW0uc2V0QXR0cmlidXRlKCAidHlwZSIsIHZhbHVlICk7CgkJCQkJaWYgKCB2YWwgKSB7CgkJCQkJCWVsZW0udmFsdWUgPSB2YWw7CgkJCQkJfQoJCQkJCXJldHVybiB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0sCgkJLy8gVXNlIHRoZSB2YWx1ZSBwcm9wZXJ0eSBmb3IgYmFjayBjb21wYXQKCQkvLyBVc2UgdGhlIG5vZGVIb29rIGZvciBidXR0b24gZWxlbWVudHMgaW4gSUU2LzcgKCMxOTU0KQoJCXZhbHVlOiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJCQlpZiAoIG5vZGVIb29rICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImJ1dHRvbiIgKSApIHsKCQkJCQlyZXR1cm4gbm9kZUhvb2suZ2V0KCBlbGVtLCBuYW1lICk7CgkJCQl9CgkJCQlyZXR1cm4gbmFtZSBpbiBlbGVtID8KCQkJCQllbGVtLnZhbHVlIDoKCQkJCQludWxsOwoJCQl9LAoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgbmFtZSApIHsKCQkJCWlmICggbm9kZUhvb2sgJiYgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiYnV0dG9uIiApICkgewoJCQkJCXJldHVybiBub2RlSG9vay5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICk7CgkJCQl9CgkJCQkvLyBEb2VzIG5vdCByZXR1cm4gc28gdGhhdCBzZXRBdHRyaWJ1dGUgaXMgYWxzbyB1c2VkCgkJCQllbGVtLnZhbHVlID0gdmFsdWU7CgkJCX0KCQl9Cgl9LAoKCXByb3BGaXg6IHsKCQl0YWJpbmRleDogInRhYkluZGV4IiwKCQlyZWFkb25seTogInJlYWRPbmx5IiwKCQkiZm9yIjogImh0bWxGb3IiLAoJCSJjbGFzcyI6ICJjbGFzc05hbWUiLAoJCW1heGxlbmd0aDogIm1heExlbmd0aCIsCgkJY2VsbHNwYWNpbmc6ICJjZWxsU3BhY2luZyIsCgkJY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCgkJcm93c3BhbjogInJvd1NwYW4iLAoJCWNvbHNwYW46ICJjb2xTcGFuIiwKCQl1c2VtYXA6ICJ1c2VNYXAiLAoJCWZyYW1lYm9yZGVyOiAiZnJhbWVCb3JkZXIiLAoJCWNvbnRlbnRlZGl0YWJsZTogImNvbnRlbnRFZGl0YWJsZSIKCX0sCgoJcHJvcDogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewoJCXZhciByZXQsIGhvb2tzLCBub3R4bWwsCgkJCW5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCgkJLy8gZG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwoJCWlmICggIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKTsKCgkJaWYgKCBub3R4bWwgKSB7CgkJCS8vIEZpeCBuYW1lIGFuZCBhdHRhY2ggaG9va3MKCQkJbmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCQkJaG9va3MgPSBqUXVlcnkucHJvcEhvb2tzWyBuYW1lIF07CgkJfQoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiByZXQ7CgoJCQl9IGVsc2UgewoJCQkJcmV0dXJuICggZWxlbVsgbmFtZSBdID0gdmFsdWUgKTsKCQkJfQoKCQl9IGVsc2UgewoJCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIG5hbWUgKSkgIT09IG51bGwgKSB7CgkJCQlyZXR1cm4gcmV0OwoKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBlbGVtWyBuYW1lIF07CgkJCX0KCQl9Cgl9LAoKCXByb3BIb29rczogewoJCXRhYkluZGV4OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkvLyBlbGVtLnRhYkluZGV4IGRvZXNuJ3QgYWx3YXlzIHJldHVybiB0aGUgY29ycmVjdCB2YWx1ZSB3aGVuIGl0IGhhc24ndCBiZWVuIGV4cGxpY2l0bHkgc2V0CgkJCQkvLyBodHRwOi8vZmx1aWRwcm9qZWN0Lm9yZy9ibG9nLzIwMDgvMDEvMDkvZ2V0dGluZy1zZXR0aW5nLWFuZC1yZW1vdmluZy10YWJpbmRleC12YWx1ZXMtd2l0aC1qYXZhc2NyaXB0LwoJCQkJdmFyIGF0dHJpYnV0ZU5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoInRhYmluZGV4Iik7CgoJCQkJcmV0dXJuIGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQgPwoJCQkJCXBhcnNlSW50KCBhdHRyaWJ1dGVOb2RlLnZhbHVlLCAxMCApIDoKCQkJCQlyZm9jdXNhYmxlLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSB8fCByY2xpY2thYmxlLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSAmJiBlbGVtLmhyZWYgPwoJCQkJCQkwIDoKCQkJCQkJdW5kZWZpbmVkOwoJCQl9CgkJfQoJfQp9KTsKCi8vIEhvb2sgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwpib29sSG9vayA9IHsKCWdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJLy8gQWxpZ24gYm9vbGVhbiBhdHRyaWJ1dGVzIHdpdGggY29ycmVzcG9uZGluZyBwcm9wZXJ0aWVzCgkJLy8gRmFsbCBiYWNrIHRvIGF0dHJpYnV0ZSBwcmVzZW5jZSB3aGVyZSBzb21lIGJvb2xlYW5zIGFyZSBub3Qgc3VwcG9ydGVkCgkJdmFyIGF0dHJOb2RlLAoJCQlwcm9wZXJ0eSA9IGpRdWVyeS5wcm9wKCBlbGVtLCBuYW1lICk7CgkJcmV0dXJuIHByb3BlcnR5ID09PSB0cnVlIHx8IHR5cGVvZiBwcm9wZXJ0eSAhPT0gImJvb2xlYW4iICYmICggYXR0ck5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUobmFtZSkgKSAmJiBhdHRyTm9kZS5ub2RlVmFsdWUgIT09IGZhbHNlID8KCQkJbmFtZS50b0xvd2VyQ2FzZSgpIDoKCQkJdW5kZWZpbmVkOwoJfSwKCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewoJCXZhciBwcm9wTmFtZTsKCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJLy8gUmVtb3ZlIGJvb2xlYW4gYXR0cmlidXRlcyB3aGVuIHNldCB0byBmYWxzZQoJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoJCX0gZWxzZSB7CgkJCS8vIHZhbHVlIGlzIHRydWUgc2luY2Ugd2Uga25vdyBhdCB0aGlzIHBvaW50IGl0J3MgdHlwZSBib29sZWFuIGFuZCBub3QgZmFsc2UKCQkJLy8gU2V0IGJvb2xlYW4gYXR0cmlidXRlcyB0byB0aGUgc2FtZSBuYW1lIGFuZCBzZXQgdGhlIERPTSBwcm9wZXJ0eQoJCQlwcm9wTmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCQkJaWYgKCBwcm9wTmFtZSBpbiBlbGVtICkgewoJCQkJLy8gT25seSBzZXQgdGhlIElETCBzcGVjaWZpY2FsbHkgaWYgaXQgYWxyZWFkeSBleGlzdHMgb24gdGhlIGVsZW1lbnQKCQkJCWVsZW1bIHByb3BOYW1lIF0gPSB0cnVlOwoJCQl9CgoJCQllbGVtLnNldEF0dHJpYnV0ZSggbmFtZSwgbmFtZS50b0xvd2VyQ2FzZSgpICk7CgkJfQoJCXJldHVybiBuYW1lOwoJfQp9OwoKLy8gSUU2LzcgZG8gbm90IHN1cHBvcnQgZ2V0dGluZy9zZXR0aW5nIHNvbWUgYXR0cmlidXRlcyB3aXRoIGdldC9zZXRBdHRyaWJ1dGUKaWYgKCAhZ2V0U2V0QXR0cmlidXRlICkgewoKCWZpeFNwZWNpZmllZCA9IHsKCQluYW1lOiB0cnVlLAoJCWlkOiB0cnVlLAoJCWNvb3JkczogdHJ1ZQoJfTsKCgkvLyBVc2UgdGhpcyBmb3IgYW55IGF0dHJpYnV0ZSBpbiBJRTYvNwoJLy8gVGhpcyBmaXhlcyBhbG1vc3QgZXZlcnkgSUU2LzcgaXNzdWUKCW5vZGVIb29rID0galF1ZXJ5LnZhbEhvb2tzLmJ1dHRvbiA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCQl2YXIgcmV0OwoJCQlyZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKCQkJcmV0dXJuIHJldCAmJiAoIGZpeFNwZWNpZmllZFsgbmFtZSBdID8gcmV0LnZhbHVlICE9PSAiIiA6IHJldC5zcGVjaWZpZWQgKSA/CgkJCQlyZXQudmFsdWUgOgoJCQkJdW5kZWZpbmVkOwoJCX0sCgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7CgkJCS8vIFNldCB0aGUgZXhpc3Rpbmcgb3IgY3JlYXRlIGEgbmV3IGF0dHJpYnV0ZSBub2RlCgkJCXZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKCQkJaWYgKCAhcmV0ICkgewoJCQkJcmV0ID0gZG9jdW1lbnQuY3JlYXRlQXR0cmlidXRlKCBuYW1lICk7CgkJCQllbGVtLnNldEF0dHJpYnV0ZU5vZGUoIHJldCApOwoJCQl9CgkJCXJldHVybiAoIHJldC52YWx1ZSA9IHZhbHVlICsgIiIgKTsKCQl9Cgl9OwoKCS8vIFNldCB3aWR0aCBhbmQgaGVpZ2h0IHRvIGF1dG8gaW5zdGVhZCBvZiAwIG9uIGVtcHR5IHN0cmluZyggQnVnICM4MTUwICkKCS8vIFRoaXMgaXMgZm9yIHJlbW92YWxzCglqUXVlcnkuZWFjaChbICJ3aWR0aCIsICJoZWlnaHQiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJCWpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSA9IGpRdWVyeS5leHRlbmQoIGpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSwgewoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCWlmICggdmFsdWUgPT09ICIiICkgewoJCQkJCWVsZW0uc2V0QXR0cmlidXRlKCBuYW1lLCAiYXV0byIgKTsKCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQl9CgkJCX0KCQl9KTsKCX0pOwoKCS8vIFNldCBjb250ZW50ZWRpdGFibGUgdG8gZmFsc2Ugb24gcmVtb3ZhbHMoIzEwNDI5KQoJLy8gU2V0dGluZyB0byBlbXB0eSBzdHJpbmcgdGhyb3dzIGFuIGVycm9yIGFzIGFuIGludmFsaWQgdmFsdWUKCWpRdWVyeS5hdHRySG9va3MuY29udGVudGVkaXRhYmxlID0gewoJCWdldDogbm9kZUhvb2suZ2V0LAoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewoJCQlpZiAoIHZhbHVlID09PSAiIiApIHsKCQkJCXZhbHVlID0gImZhbHNlIjsKCQkJfQoJCQlub2RlSG9vay5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICk7CgkJfQoJfTsKfQoKCi8vIFNvbWUgYXR0cmlidXRlcyByZXF1aXJlIGEgc3BlY2lhbCBjYWxsIG9uIElFCmlmICggIWpRdWVyeS5zdXBwb3J0LmhyZWZOb3JtYWxpemVkICkgewoJalF1ZXJ5LmVhY2goWyAiaHJlZiIsICJzcmMiLCAid2lkdGgiLCAiaGVpZ2h0IiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCQlqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gPSBqUXVlcnkuZXh0ZW5kKCBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0sIHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSwgMiApOwoJCQkJcmV0dXJuIHJldCA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsKCQkJfQoJCX0pOwoJfSk7Cn0KCmlmICggIWpRdWVyeS5zdXBwb3J0LnN0eWxlICkgewoJalF1ZXJ5LmF0dHJIb29rcy5zdHlsZSA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBSZXR1cm4gdW5kZWZpbmVkIGluIHRoZSBjYXNlIG9mIGVtcHR5IHN0cmluZwoJCQkvLyBOb3JtYWxpemUgdG8gbG93ZXJjYXNlIHNpbmNlIElFIHVwcGVyY2FzZXMgY3NzIHByb3BlcnR5IG5hbWVzCgkJCXJldHVybiBlbGVtLnN0eWxlLmNzc1RleHQudG9Mb3dlckNhc2UoKSB8fCB1bmRlZmluZWQ7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJcmV0dXJuICggZWxlbS5zdHlsZS5jc3NUZXh0ID0gIiIgKyB2YWx1ZSApOwoJCX0KCX07Cn0KCi8vIFNhZmFyaSBtaXMtcmVwb3J0cyB0aGUgZGVmYXVsdCBzZWxlY3RlZCBwcm9wZXJ0eSBvZiBhbiBvcHRpb24KLy8gQWNjZXNzaW5nIHRoZSBwYXJlbnQncyBzZWxlY3RlZEluZGV4IHByb3BlcnR5IGZpeGVzIGl0CmlmICggIWpRdWVyeS5zdXBwb3J0Lm9wdFNlbGVjdGVkICkgewoJalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCA9IGpRdWVyeS5leHRlbmQoIGpRdWVyeS5wcm9wSG9va3Muc2VsZWN0ZWQsIHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoKCQkJaWYgKCBwYXJlbnQgKSB7CgkJCQlwYXJlbnQuc2VsZWN0ZWRJbmRleDsKCgkJCQkvLyBNYWtlIHN1cmUgdGhhdCBpdCBhbHNvIHdvcmtzIHdpdGggb3B0Z3JvdXBzLCBzZWUgIzU3MDEKCQkJCWlmICggcGFyZW50LnBhcmVudE5vZGUgKSB7CgkJCQkJcGFyZW50LnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9KTsKfQoKLy8gSUU2LzcgY2FsbCBlbmN0eXBlIGVuY29kaW5nCmlmICggIWpRdWVyeS5zdXBwb3J0LmVuY3R5cGUgKSB7CglqUXVlcnkucHJvcEZpeC5lbmN0eXBlID0gImVuY29kaW5nIjsKfQoKLy8gUmFkaW9zIGFuZCBjaGVja2JveGVzIGdldHRlci9zZXR0ZXIKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hlY2tPbiApIHsKCWpRdWVyeS5lYWNoKFsgInJhZGlvIiwgImNoZWNrYm94IiBdLCBmdW5jdGlvbigpIHsKCQlqUXVlcnkudmFsSG9va3NbIHRoaXMgXSA9IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBpbiBXZWJraXQgIiIgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiAib24iIGlmIGEgdmFsdWUgaXNuJ3Qgc3BlY2lmaWVkCgkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInZhbHVlIikgPT09IG51bGwgPyAib24iIDogZWxlbS52YWx1ZTsKCQkJfQoJCX07Cgl9KTsKfQpqUXVlcnkuZWFjaChbICJyYWRpbyIsICJjaGVja2JveCIgXSwgZnVuY3Rpb24oKSB7CglqUXVlcnkudmFsSG9va3NbIHRoaXMgXSA9IGpRdWVyeS5leHRlbmQoIGpRdWVyeS52YWxIb29rc1sgdGhpcyBdLCB7CgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCWlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbHVlICkgKSB7CgkJCQlyZXR1cm4gKCBlbGVtLmNoZWNrZWQgPSBqUXVlcnkuaW5BcnJheSggalF1ZXJ5KGVsZW0pLnZhbCgpLCB2YWx1ZSApID49IDAgKTsKCQkJfQoJCX0KCX0pOwp9KTsKdmFyIHJmb3JtRWxlbXMgPSAvXig/OnRleHRhcmVhfGlucHV0fHNlbGVjdCkkL2ksCglydHlwZW5hbWVzcGFjZSA9IC9eKFteXC5dKnwpKD86XC4oLispfCkkLywKCXJob3ZlckhhY2sgPSAvKD86Xnxccylob3ZlcihcLlxTK3wpXGIvLAoJcmtleUV2ZW50ID0gL15rZXkvLAoJcm1vdXNlRXZlbnQgPSAvXig/Om1vdXNlfGNvbnRleHRtZW51KXxjbGljay8sCglyZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywKCWhvdmVySGFjayA9IGZ1bmN0aW9uKCBldmVudHMgKSB7CgkJcmV0dXJuIGpRdWVyeS5ldmVudC5zcGVjaWFsLmhvdmVyID8gZXZlbnRzIDogZXZlbnRzLnJlcGxhY2UoIHJob3ZlckhhY2ssICJtb3VzZWVudGVyJDEgbW91c2VsZWF2ZSQxIiApOwoJfTsKCi8qCiAqIEhlbHBlciBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIGV2ZW50cyAtLSBub3QgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4KICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICovCmpRdWVyeS5ldmVudCA9IHsKCglhZGQ6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlcywgaGFuZGxlciwgZGF0YSwgc2VsZWN0b3IgKSB7CgoJCXZhciBlbGVtRGF0YSwgZXZlbnRIYW5kbGUsIGV2ZW50cywKCQkJdCwgdG5zLCB0eXBlLCBuYW1lc3BhY2VzLCBoYW5kbGVPYmosCgkJCWhhbmRsZU9iakluLCBoYW5kbGVycywgc3BlY2lhbDsKCgkJLy8gRG9uJ3QgYXR0YWNoIGV2ZW50cyB0byBub0RhdGEgb3IgdGV4dC9jb21tZW50IG5vZGVzIChhbGxvdyBwbGFpbiBvYmplY3RzIHRobykKCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCB8fCAhdHlwZXMgfHwgIWhhbmRsZXIgfHwgIShlbGVtRGF0YSA9IGpRdWVyeS5fZGF0YSggZWxlbSApKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIG9iamVjdCBvZiBjdXN0b20gZGF0YSBpbiBsaWV1IG9mIHRoZSBoYW5kbGVyCgkJaWYgKCBoYW5kbGVyLmhhbmRsZXIgKSB7CgkJCWhhbmRsZU9iakluID0gaGFuZGxlcjsKCQkJaGFuZGxlciA9IGhhbmRsZU9iakluLmhhbmRsZXI7CgkJCXNlbGVjdG9yID0gaGFuZGxlT2JqSW4uc2VsZWN0b3I7CgkJfQoKCQkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaGFuZGxlciBoYXMgYSB1bmlxdWUgSUQsIHVzZWQgdG8gZmluZC9yZW1vdmUgaXQgbGF0ZXIKCQlpZiAoICFoYW5kbGVyLmd1aWQgKSB7CgkJCWhhbmRsZXIuZ3VpZCA9IGpRdWVyeS5ndWlkKys7CgkJfQoKCQkvLyBJbml0IHRoZSBlbGVtZW50J3MgZXZlbnQgc3RydWN0dXJlIGFuZCBtYWluIGhhbmRsZXIsIGlmIHRoaXMgaXMgdGhlIGZpcnN0CgkJZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzOwoJCWlmICggIWV2ZW50cyApIHsKCQkJZWxlbURhdGEuZXZlbnRzID0gZXZlbnRzID0ge307CgkJfQoJCWV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlOwoJCWlmICggIWV2ZW50SGFuZGxlICkgewoJCQllbGVtRGF0YS5oYW5kbGUgPSBldmVudEhhbmRsZSA9IGZ1bmN0aW9uKCBlICkgewoJCQkJLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKCQkJCS8vIHdoZW4gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCXJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSAidW5kZWZpbmVkIiAmJiAoIWUgfHwgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCAhPT0gZS50eXBlKSA/CgkJCQkJalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmFwcGx5KCBldmVudEhhbmRsZS5lbGVtLCBhcmd1bWVudHMgKSA6CgkJCQkJdW5kZWZpbmVkOwoJCQl9OwoJCQkvLyBBZGQgZWxlbSBhcyBhIHByb3BlcnR5IG9mIHRoZSBoYW5kbGUgZm4gdG8gcHJldmVudCBhIG1lbW9yeSBsZWFrIHdpdGggSUUgbm9uLW5hdGl2ZSBldmVudHMKCQkJZXZlbnRIYW5kbGUuZWxlbSA9IGVsZW07CgkJfQoKCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlCgkJLy8galF1ZXJ5KC4uLikuYmluZCgibW91c2VvdmVyIG1vdXNlb3V0IiwgZm4pOwoJCXR5cGVzID0galF1ZXJ5LnRyaW0oIGhvdmVySGFjayh0eXBlcykgKS5zcGxpdCggIiAiICk7CgkJZm9yICggdCA9IDA7IHQgPCB0eXBlcy5sZW5ndGg7IHQrKyApIHsKCgkJCXRucyA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWMoIHR5cGVzW3RdICkgfHwgW107CgkJCXR5cGUgPSB0bnNbMV07CgkJCW5hbWVzcGFjZXMgPSAoIHRuc1syXSB8fCAiIiApLnNwbGl0KCAiLiIgKS5zb3J0KCk7CgoJCQkvLyBJZiBldmVudCBjaGFuZ2VzIGl0cyB0eXBlLCB1c2UgdGhlIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMgZm9yIHRoZSBjaGFuZ2VkIHR5cGUKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgoJCQkvLyBJZiBzZWxlY3RvciBkZWZpbmVkLCBkZXRlcm1pbmUgc3BlY2lhbCBldmVudCBhcGkgdHlwZSwgb3RoZXJ3aXNlIGdpdmVuIHR5cGUKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoKCQkJLy8gVXBkYXRlIHNwZWNpYWwgYmFzZWQgb24gbmV3bHkgcmVzZXQgdHlwZQoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCgkJCS8vIGhhbmRsZU9iaiBpcyBwYXNzZWQgdG8gYWxsIGV2ZW50IGhhbmRsZXJzCgkJCWhhbmRsZU9iaiA9IGpRdWVyeS5leHRlbmQoewoJCQkJdHlwZTogdHlwZSwKCQkJCW9yaWdUeXBlOiB0bnNbMV0sCgkJCQlkYXRhOiBkYXRhLAoJCQkJaGFuZGxlcjogaGFuZGxlciwKCQkJCWd1aWQ6IGhhbmRsZXIuZ3VpZCwKCQkJCXNlbGVjdG9yOiBzZWxlY3RvciwKCQkJCW5hbWVzcGFjZTogbmFtZXNwYWNlcy5qb2luKCIuIikKCQkJfSwgaGFuZGxlT2JqSW4gKTsKCgkJCS8vIEluaXQgdGhlIGV2ZW50IGhhbmRsZXIgcXVldWUgaWYgd2UncmUgdGhlIGZpcnN0CgkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF07CgkJCWlmICggIWhhbmRsZXJzICkgewoJCQkJaGFuZGxlcnMgPSBldmVudHNbIHR5cGUgXSA9IFtdOwoJCQkJaGFuZGxlcnMuZGVsZWdhdGVDb3VudCA9IDA7CgoJCQkJLy8gT25seSB1c2UgYWRkRXZlbnRMaXN0ZW5lci9hdHRhY2hFdmVudCBpZiB0aGUgc3BlY2lhbCBldmVudHMgaGFuZGxlciByZXR1cm5zIGZhbHNlCgkJCQlpZiAoICFzcGVjaWFsLnNldHVwIHx8IHNwZWNpYWwuc2V0dXAuY2FsbCggZWxlbSwgZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUgKSA9PT0gZmFsc2UgKSB7CgkJCQkJLy8gQmluZCB0aGUgZ2xvYmFsIGV2ZW50IGhhbmRsZXIgdG8gdGhlIGVsZW1lbnQKCQkJCQlpZiAoIGVsZW0uYWRkRXZlbnRMaXN0ZW5lciApIHsKCQkJCQkJZWxlbS5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBldmVudEhhbmRsZSwgZmFsc2UgKTsKCgkJCQkJfSBlbHNlIGlmICggZWxlbS5hdHRhY2hFdmVudCApIHsKCQkJCQkJZWxlbS5hdHRhY2hFdmVudCggIm9uIiArIHR5cGUsIGV2ZW50SGFuZGxlICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlpZiAoIHNwZWNpYWwuYWRkICkgewoJCQkJc3BlY2lhbC5hZGQuY2FsbCggZWxlbSwgaGFuZGxlT2JqICk7CgoJCQkJaWYgKCAhaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCApIHsKCQkJCQloYW5kbGVPYmouaGFuZGxlci5ndWlkID0gaGFuZGxlci5ndWlkOwoJCQkJfQoJCQl9CgoJCQkvLyBBZGQgdG8gdGhlIGVsZW1lbnQncyBoYW5kbGVyIGxpc3QsIGRlbGVnYXRlcyBpbiBmcm9udAoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJaGFuZGxlcnMuc3BsaWNlKCBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50KyssIDAsIGhhbmRsZU9iaiApOwoJCQl9IGVsc2UgewoJCQkJaGFuZGxlcnMucHVzaCggaGFuZGxlT2JqICk7CgkJCX0KCgkJCS8vIEtlZXAgdHJhY2sgb2Ygd2hpY2ggZXZlbnRzIGhhdmUgZXZlciBiZWVuIHVzZWQsIGZvciBldmVudCBvcHRpbWl6YXRpb24KCQkJalF1ZXJ5LmV2ZW50Lmdsb2JhbFsgdHlwZSBdID0gdHJ1ZTsKCQl9CgoJCS8vIE51bGxpZnkgZWxlbSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcyBpbiBJRQoJCWVsZW0gPSBudWxsOwoJfSwKCglnbG9iYWw6IHt9LAoKCS8vIERldGFjaCBhbiBldmVudCBvciBzZXQgb2YgZXZlbnRzIGZyb20gYW4gZWxlbWVudAoJcmVtb3ZlOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIHNlbGVjdG9yLCBtYXBwZWRUeXBlcyApIHsKCgkJdmFyIHQsIHRucywgdHlwZSwgb3JpZ1R5cGUsIG5hbWVzcGFjZXMsIG9yaWdDb3VudCwKCQkJaiwgZXZlbnRzLCBzcGVjaWFsLCBldmVudFR5cGUsIGhhbmRsZU9iaiwKCQkJZWxlbURhdGEgPSBqUXVlcnkuaGFzRGF0YSggZWxlbSApICYmIGpRdWVyeS5fZGF0YSggZWxlbSApOwoKCQlpZiAoICFlbGVtRGF0YSB8fCAhKGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cykgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIE9uY2UgZm9yIGVhY2ggdHlwZS5uYW1lc3BhY2UgaW4gdHlwZXM7IHR5cGUgbWF5IGJlIG9taXR0ZWQKCQl0eXBlcyA9IGpRdWVyeS50cmltKCBob3ZlckhhY2soIHR5cGVzIHx8ICIiICkgKS5zcGxpdCgiICIpOwoJCWZvciAoIHQgPSAwOyB0IDwgdHlwZXMubGVuZ3RoOyB0KysgKSB7CgkJCXRucyA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWMoIHR5cGVzW3RdICkgfHwgW107CgkJCXR5cGUgPSBvcmlnVHlwZSA9IHRuc1sxXTsKCQkJbmFtZXNwYWNlcyA9IHRuc1syXTsKCgkJCS8vIFVuYmluZCBhbGwgZXZlbnRzIChvbiB0aGlzIG5hbWVzcGFjZSwgaWYgcHJvdmlkZWQpIGZvciB0aGUgZWxlbWVudAoJCQlpZiAoICF0eXBlICkgewoJCQkJZm9yICggdHlwZSBpbiBldmVudHMgKSB7CgkJCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggZWxlbSwgdHlwZSArIHR5cGVzWyB0IF0sIGhhbmRsZXIsIHNlbGVjdG9yLCB0cnVlICk7CgkJCQl9CgkJCQljb250aW51ZTsKCQkJfQoKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgkJCXR5cGUgPSAoIHNlbGVjdG9yPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoJCQlldmVudFR5cGUgPSBldmVudHNbIHR5cGUgXSB8fCBbXTsKCQkJb3JpZ0NvdW50ID0gZXZlbnRUeXBlLmxlbmd0aDsKCQkJbmFtZXNwYWNlcyA9IG5hbWVzcGFjZXMgPyBuZXcgUmVnRXhwKCIoXnxcXC4pIiArIG5hbWVzcGFjZXMuc3BsaXQoIi4iKS5zb3J0KCkuam9pbigiXFwuKD86LipcXC58KSIpICsgIihcXC58JCkiKSA6IG51bGw7CgoJCQkvLyBSZW1vdmUgbWF0Y2hpbmcgZXZlbnRzCgkJCWZvciAoIGogPSAwOyBqIDwgZXZlbnRUeXBlLmxlbmd0aDsgaisrICkgewoJCQkJaGFuZGxlT2JqID0gZXZlbnRUeXBlWyBqIF07CgoJCQkJaWYgKCAoIG1hcHBlZFR5cGVzIHx8IG9yaWdUeXBlID09PSBoYW5kbGVPYmoub3JpZ1R5cGUgKSAmJgoJCQkJCSAoICFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSAmJgoJCQkJCSAoICFuYW1lc3BhY2VzIHx8IG5hbWVzcGFjZXMudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgJiYKCQkJCQkgKCAhc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09IGhhbmRsZU9iai5zZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gIioqIiAmJiBoYW5kbGVPYmouc2VsZWN0b3IgKSApIHsKCQkJCQlldmVudFR5cGUuc3BsaWNlKCBqLS0sIDEgKTsKCgkJCQkJaWYgKCBoYW5kbGVPYmouc2VsZWN0b3IgKSB7CgkJCQkJCWV2ZW50VHlwZS5kZWxlZ2F0ZUNvdW50LS07CgkJCQkJfQoJCQkJCWlmICggc3BlY2lhbC5yZW1vdmUgKSB7CgkJCQkJCXNwZWNpYWwucmVtb3ZlLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIGdlbmVyaWMgZXZlbnQgaGFuZGxlciBpZiB3ZSByZW1vdmVkIHNvbWV0aGluZyBhbmQgbm8gbW9yZSBoYW5kbGVycyBleGlzdAoJCQkvLyAoYXZvaWRzIHBvdGVudGlhbCBmb3IgZW5kbGVzcyByZWN1cnNpb24gZHVyaW5nIHJlbW92YWwgb2Ygc3BlY2lhbCBldmVudCBoYW5kbGVycykKCQkJaWYgKCBldmVudFR5cGUubGVuZ3RoID09PSAwICYmIG9yaWdDb3VudCAhPT0gZXZlbnRUeXBlLmxlbmd0aCApIHsKCQkJCWlmICggIXNwZWNpYWwudGVhcmRvd24gfHwgc3BlY2lhbC50ZWFyZG93bi5jYWxsKCBlbGVtLCBuYW1lc3BhY2VzLCBlbGVtRGF0YS5oYW5kbGUgKSA9PT0gZmFsc2UgKSB7CgkJCQkJalF1ZXJ5LnJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBlbGVtRGF0YS5oYW5kbGUgKTsKCQkJCX0KCgkJCQlkZWxldGUgZXZlbnRzWyB0eXBlIF07CgkJCX0KCQl9CgoJCS8vIFJlbW92ZSB0aGUgZXhwYW5kbyBpZiBpdCdzIG5vIGxvbmdlciB1c2VkCgkJaWYgKCBqUXVlcnkuaXNFbXB0eU9iamVjdCggZXZlbnRzICkgKSB7CgkJCWRlbGV0ZSBlbGVtRGF0YS5oYW5kbGU7CgoJCQkvLyByZW1vdmVEYXRhIGFsc28gY2hlY2tzIGZvciBlbXB0aW5lc3MgYW5kIGNsZWFycyB0aGUgZXhwYW5kbyBpZiBlbXB0eQoJCQkvLyBzbyB1c2UgaXQgaW5zdGVhZCBvZiBkZWxldGUKCQkJalF1ZXJ5LnJlbW92ZURhdGEoIGVsZW0sICJldmVudHMiLCB0cnVlICk7CgkJfQoJfSwKCgkvLyBFdmVudHMgdGhhdCBhcmUgc2FmZSB0byBzaG9ydC1jaXJjdWl0IGlmIG5vIGhhbmRsZXJzIGFyZSBhdHRhY2hlZC4KCS8vIE5hdGl2ZSBET00gZXZlbnRzIHNob3VsZCBub3QgYmUgYWRkZWQsIHRoZXkgbWF5IGhhdmUgaW5saW5lIGhhbmRsZXJzLgoJY3VzdG9tRXZlbnQ6IHsKCQkiZ2V0RGF0YSI6IHRydWUsCgkJInNldERhdGEiOiB0cnVlLAoJCSJjaGFuZ2VEYXRhIjogdHJ1ZQoJfSwKCgl0cmlnZ2VyOiBmdW5jdGlvbiggZXZlbnQsIGRhdGEsIGVsZW0sIG9ubHlIYW5kbGVycyApIHsKCQkvLyBEb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggZWxlbSAmJiAoZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4KSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gRXZlbnQgb2JqZWN0IG9yIGV2ZW50IHR5cGUKCQl2YXIgY2FjaGUsIGV4Y2x1c2l2ZSwgaSwgY3VyLCBvbGQsIG9udHlwZSwgc3BlY2lhbCwgaGFuZGxlLCBldmVudFBhdGgsIGJ1YmJsZVR5cGUsCgkJCXR5cGUgPSBldmVudC50eXBlIHx8IGV2ZW50LAoJCQluYW1lc3BhY2VzID0gW107CgoJCS8vIGZvY3VzL2JsdXIgbW9ycGhzIHRvIGZvY3VzaW4vb3V0OyBlbnN1cmUgd2UncmUgbm90IGZpcmluZyB0aGVtIHJpZ2h0IG5vdwoJCWlmICggcmZvY3VzTW9ycGgudGVzdCggdHlwZSArIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0eXBlLmluZGV4T2YoICIhIiApID49IDAgKSB7CgkJCS8vIEV4Y2x1c2l2ZSBldmVudHMgdHJpZ2dlciBvbmx5IGZvciB0aGUgZXhhY3QgZXZlbnQgKG5vIG5hbWVzcGFjZXMpCgkJCXR5cGUgPSB0eXBlLnNsaWNlKDAsIC0xKTsKCQkJZXhjbHVzaXZlID0gdHJ1ZTsKCQl9CgoJCWlmICggdHlwZS5pbmRleE9mKCAiLiIgKSA+PSAwICkgewoJCQkvLyBOYW1lc3BhY2VkIHRyaWdnZXI7IGNyZWF0ZSBhIHJlZ2V4cCB0byBtYXRjaCBldmVudCB0eXBlIGluIGhhbmRsZSgpCgkJCW5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCIuIik7CgkJCXR5cGUgPSBuYW1lc3BhY2VzLnNoaWZ0KCk7CgkJCW5hbWVzcGFjZXMuc29ydCgpOwoJCX0KCgkJaWYgKCAoIWVsZW0gfHwgalF1ZXJ5LmV2ZW50LmN1c3RvbUV2ZW50WyB0eXBlIF0pICYmICFqUXVlcnkuZXZlbnQuZ2xvYmFsWyB0eXBlIF0gKSB7CgkJCS8vIE5vIGpRdWVyeSBoYW5kbGVycyBmb3IgdGhpcyBldmVudCB0eXBlLCBhbmQgaXQgY2FuJ3QgaGF2ZSBpbmxpbmUgaGFuZGxlcnMKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIEV2ZW50LCBPYmplY3QsIG9yIGp1c3QgYW4gZXZlbnQgdHlwZSBzdHJpbmcKCQlldmVudCA9IHR5cGVvZiBldmVudCA9PT0gIm9iamVjdCIgPwoJCQkvLyBqUXVlcnkuRXZlbnQgb2JqZWN0CgkJCWV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdID8gZXZlbnQgOgoJCQkvLyBPYmplY3QgbGl0ZXJhbAoJCQluZXcgalF1ZXJ5LkV2ZW50KCB0eXBlLCBldmVudCApIDoKCQkJLy8gSnVzdCB0aGUgZXZlbnQgdHlwZSAoc3RyaW5nKQoJCQluZXcgalF1ZXJ5LkV2ZW50KCB0eXBlICk7CgoJCWV2ZW50LnR5cGUgPSB0eXBlOwoJCWV2ZW50LmlzVHJpZ2dlciA9IHRydWU7CgkJZXZlbnQuZXhjbHVzaXZlID0gZXhjbHVzaXZlOwoJCWV2ZW50Lm5hbWVzcGFjZSA9IG5hbWVzcGFjZXMuam9pbiggIi4iICk7CgkJZXZlbnQubmFtZXNwYWNlX3JlID0gZXZlbnQubmFtZXNwYWNlPyBuZXcgUmVnRXhwKCIoXnxcXC4pIiArIG5hbWVzcGFjZXMuam9pbigiXFwuKD86LipcXC58KSIpICsgIihcXC58JCkiKSA6IG51bGw7CgkJb250eXBlID0gdHlwZS5pbmRleE9mKCAiOiIgKSA8IDAgPyAib24iICsgdHlwZSA6ICIiOwoKCQkvLyBIYW5kbGUgYSBnbG9iYWwgdHJpZ2dlcgoJCWlmICggIWVsZW0gKSB7CgoJCQkvLyBUT0RPOiBTdG9wIHRhdW50aW5nIHRoZSBkYXRhIGNhY2hlOyByZW1vdmUgZ2xvYmFsIGV2ZW50cyBhbmQgYWx3YXlzIGF0dGFjaCB0byBkb2N1bWVudAoJCQljYWNoZSA9IGpRdWVyeS5jYWNoZTsKCQkJZm9yICggaSBpbiBjYWNoZSApIHsKCQkJCWlmICggY2FjaGVbIGkgXS5ldmVudHMgJiYgY2FjaGVbIGkgXS5ldmVudHNbIHR5cGUgXSApIHsKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggZXZlbnQsIGRhdGEsIGNhY2hlWyBpIF0uaGFuZGxlLmVsZW0sIHRydWUgKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm47CgkJfQoKCQkvLyBDbGVhbiB1cCB0aGUgZXZlbnQgaW4gY2FzZSBpdCBpcyBiZWluZyByZXVzZWQKCQlldmVudC5yZXN1bHQgPSB1bmRlZmluZWQ7CgkJaWYgKCAhZXZlbnQudGFyZ2V0ICkgewoJCQlldmVudC50YXJnZXQgPSBlbGVtOwoJCX0KCgkJLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAoJCWRhdGEgPSBkYXRhICE9IG51bGwgPyBqUXVlcnkubWFrZUFycmF5KCBkYXRhICkgOiBbXTsKCQlkYXRhLnVuc2hpZnQoIGV2ZW50ICk7CgoJCS8vIEFsbG93IHNwZWNpYWwgZXZlbnRzIHRvIGRyYXcgb3V0c2lkZSB0aGUgbGluZXMKCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQlpZiAoIHNwZWNpYWwudHJpZ2dlciAmJiBzcGVjaWFsLnRyaWdnZXIuYXBwbHkoIGVsZW0sIGRhdGEgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIERldGVybWluZSBldmVudCBwcm9wYWdhdGlvbiBwYXRoIGluIGFkdmFuY2UsIHBlciBXM0MgZXZlbnRzIHNwZWMgKCM5OTUxKQoJCS8vIEJ1YmJsZSB1cCB0byBkb2N1bWVudCwgdGhlbiB0byB3aW5kb3c7IHdhdGNoIGZvciBhIGdsb2JhbCBvd25lckRvY3VtZW50IHZhciAoIzk3MjQpCgkJZXZlbnRQYXRoID0gW1sgZWxlbSwgc3BlY2lhbC5iaW5kVHlwZSB8fCB0eXBlIF1dOwoJCWlmICggIW9ubHlIYW5kbGVycyAmJiAhc3BlY2lhbC5ub0J1YmJsZSAmJiAhalF1ZXJ5LmlzV2luZG93KCBlbGVtICkgKSB7CgoJCQlidWJibGVUeXBlID0gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgfHwgdHlwZTsKCQkJY3VyID0gcmZvY3VzTW9ycGgudGVzdCggYnViYmxlVHlwZSArIHR5cGUgKSA/IGVsZW0gOiBlbGVtLnBhcmVudE5vZGU7CgkJCWZvciAoIG9sZCA9IGVsZW07IGN1cjsgY3VyID0gY3VyLnBhcmVudE5vZGUgKSB7CgkJCQlldmVudFBhdGgucHVzaChbIGN1ciwgYnViYmxlVHlwZSBdKTsKCQkJCW9sZCA9IGN1cjsKCQkJfQoKCQkJLy8gT25seSBhZGQgd2luZG93IGlmIHdlIGdvdCB0byBkb2N1bWVudCAoZS5nLiwgbm90IHBsYWluIG9iaiBvciBkZXRhY2hlZCBET00pCgkJCWlmICggb2xkID09PSAoZWxlbS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50KSApIHsKCQkJCWV2ZW50UGF0aC5wdXNoKFsgb2xkLmRlZmF1bHRWaWV3IHx8IG9sZC5wYXJlbnRXaW5kb3cgfHwgd2luZG93LCBidWJibGVUeXBlIF0pOwoJCQl9CgkJfQoKCQkvLyBGaXJlIGhhbmRsZXJzIG9uIHRoZSBldmVudCBwYXRoCgkJZm9yICggaSA9IDA7IGkgPCBldmVudFBhdGgubGVuZ3RoICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpOyBpKysgKSB7CgoJCQljdXIgPSBldmVudFBhdGhbaV1bMF07CgkJCWV2ZW50LnR5cGUgPSBldmVudFBhdGhbaV1bMV07CgoJCQloYW5kbGUgPSAoIGpRdWVyeS5fZGF0YSggY3VyLCAiZXZlbnRzIiApIHx8IHt9IClbIGV2ZW50LnR5cGUgXSAmJiBqUXVlcnkuX2RhdGEoIGN1ciwgImhhbmRsZSIgKTsKCQkJaWYgKCBoYW5kbGUgKSB7CgkJCQloYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApOwoJCQl9CgkJCS8vIE5vdGUgdGhhdCB0aGlzIGlzIGEgYmFyZSBKUyBmdW5jdGlvbiBhbmQgbm90IGEgalF1ZXJ5IGhhbmRsZXIKCQkJaGFuZGxlID0gb250eXBlICYmIGN1clsgb250eXBlIF07CgkJCWlmICggaGFuZGxlICYmIGpRdWVyeS5hY2NlcHREYXRhKCBjdXIgKSAmJiBoYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApID09PSBmYWxzZSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgkJZXZlbnQudHlwZSA9IHR5cGU7CgoJCS8vIElmIG5vYm9keSBwcmV2ZW50ZWQgdGhlIGRlZmF1bHQgYWN0aW9uLCBkbyBpdCBub3cKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoKCQkJaWYgKCAoIXNwZWNpYWwuX2RlZmF1bHQgfHwgc3BlY2lhbC5fZGVmYXVsdC5hcHBseSggZWxlbS5vd25lckRvY3VtZW50LCBkYXRhICkgPT09IGZhbHNlKSAmJgoJCQkJISh0eXBlID09PSAiY2xpY2siICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImEiICkpICYmIGpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CgoJCQkJLy8gQ2FsbCBhIG5hdGl2ZSBET00gbWV0aG9kIG9uIHRoZSB0YXJnZXQgd2l0aCB0aGUgc2FtZSBuYW1lIG5hbWUgYXMgdGhlIGV2ZW50LgoJCQkJLy8gQ2FuJ3QgdXNlIGFuIC5pc0Z1bmN0aW9uKCkgY2hlY2sgaGVyZSBiZWNhdXNlIElFNi83IGZhaWxzIHRoYXQgdGVzdC4KCQkJCS8vIERvbid0IGRvIGRlZmF1bHQgYWN0aW9ucyBvbiB3aW5kb3csIHRoYXQncyB3aGVyZSBnbG9iYWwgdmFyaWFibGVzIGJlICgjNjE3MCkKCQkJCS8vIElFPDkgZGllcyBvbiBmb2N1cy9ibHVyIHRvIGhpZGRlbiBlbGVtZW50ICgjMTQ4NikKCQkJCWlmICggb250eXBlICYmIGVsZW1bIHR5cGUgXSAmJiAoKHR5cGUgIT09ICJmb2N1cyIgJiYgdHlwZSAhPT0gImJsdXIiKSB8fCBldmVudC50YXJnZXQub2Zmc2V0V2lkdGggIT09IDApICYmICFqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsKCgkJCQkJLy8gRG9uJ3QgcmUtdHJpZ2dlciBhbiBvbkZPTyBldmVudCB3aGVuIHdlIGNhbGwgaXRzIEZPTygpIG1ldGhvZAoJCQkJCW9sZCA9IGVsZW1bIG9udHlwZSBdOwoKCQkJCQlpZiAoIG9sZCApIHsKCQkJCQkJZWxlbVsgb250eXBlIF0gPSBudWxsOwoJCQkJCX0KCgkJCQkJLy8gUHJldmVudCByZS10cmlnZ2VyaW5nIG9mIHRoZSBzYW1lIGV2ZW50LCBzaW5jZSB3ZSBhbHJlYWR5IGJ1YmJsZWQgaXQgYWJvdmUKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdHlwZTsKCQkJCQllbGVtWyB0eXBlIF0oKTsKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdW5kZWZpbmVkOwoKCQkJCQlpZiAoIG9sZCApIHsKCQkJCQkJZWxlbVsgb250eXBlIF0gPSBvbGQ7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCglkaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkvLyBNYWtlIGEgd3JpdGFibGUgalF1ZXJ5LkV2ZW50IGZyb20gdGhlIG5hdGl2ZSBldmVudCBvYmplY3QKCQlldmVudCA9IGpRdWVyeS5ldmVudC5maXgoIGV2ZW50IHx8IHdpbmRvdy5ldmVudCApOwoKCQl2YXIgaSwgaiwgY3VyLCBqcWN1ciwgcmV0LCBzZWxNYXRjaCwgbWF0Y2hlZCwgbWF0Y2hlcywgaGFuZGxlT2JqLCBzZWwsIHJlbGF0ZWQsCgkJCWhhbmRsZXJzID0gKCAoalF1ZXJ5Ll9kYXRhKCB0aGlzLCAiZXZlbnRzIiApIHx8IHt9IClbIGV2ZW50LnR5cGUgXSB8fCBbXSksCgkJCWRlbGVnYXRlQ291bnQgPSBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LAoJCQlhcmdzID0gW10uc2xpY2UuY2FsbCggYXJndW1lbnRzICksCgkJCXJ1bl9hbGwgPSAhZXZlbnQuZXhjbHVzaXZlICYmICFldmVudC5uYW1lc3BhY2UsCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgZXZlbnQudHlwZSBdIHx8IHt9LAoJCQloYW5kbGVyUXVldWUgPSBbXTsKCgkJLy8gVXNlIHRoZSBmaXgtZWQgalF1ZXJ5LkV2ZW50IHJhdGhlciB0aGFuIHRoZSAocmVhZC1vbmx5KSBuYXRpdmUgZXZlbnQKCQlhcmdzWzBdID0gZXZlbnQ7CgkJZXZlbnQuZGVsZWdhdGVUYXJnZXQgPSB0aGlzOwoKCQkvLyBDYWxsIHRoZSBwcmVEaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUsIGFuZCBsZXQgaXQgYmFpbCBpZiBkZXNpcmVkCgkJaWYgKCBzcGVjaWFsLnByZURpc3BhdGNoICYmIHNwZWNpYWwucHJlRGlzcGF0Y2guY2FsbCggdGhpcywgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIERldGVybWluZSBoYW5kbGVycyB0aGF0IHNob3VsZCBydW4gaWYgdGhlcmUgYXJlIGRlbGVnYXRlZCBldmVudHMKCQkvLyBBdm9pZCBub24tbGVmdC1jbGljayBidWJibGluZyBpbiBGaXJlZm94ICgjMzg2MSkKCQlpZiAoIGRlbGVnYXRlQ291bnQgJiYgIShldmVudC5idXR0b24gJiYgZXZlbnQudHlwZSA9PT0gImNsaWNrIikgKSB7CgoJCQkvLyBQcmVnZW5lcmF0ZSBhIHNpbmdsZSBqUXVlcnkgb2JqZWN0IGZvciByZXVzZSB3aXRoIC5pcygpCgkJCWpxY3VyID0galF1ZXJ5KHRoaXMpOwoJCQlqcWN1ci5jb250ZXh0ID0gdGhpczsKCgkJCWZvciAoIGN1ciA9IGV2ZW50LnRhcmdldDsgY3VyICE9IHRoaXM7IGN1ciA9IGN1ci5wYXJlbnROb2RlIHx8IHRoaXMgKSB7CgoJCQkJLy8gRG9uJ3QgcHJvY2VzcyBjbGlja3MgKE9OTFkpIG9uIGRpc2FibGVkIGVsZW1lbnRzICgjNjkxMSwgIzgxNjUsICN4eHh4KQoJCQkJaWYgKCBjdXIuZGlzYWJsZWQgIT09IHRydWUgfHwgZXZlbnQudHlwZSAhPT0gImNsaWNrIiApIHsKCQkJCQlzZWxNYXRjaCA9IHt9OwoJCQkJCW1hdGNoZXMgPSBbXTsKCQkJCQlqcWN1clswXSA9IGN1cjsKCQkJCQlmb3IgKCBpID0gMDsgaSA8IGRlbGVnYXRlQ291bnQ7IGkrKyApIHsKCQkJCQkJaGFuZGxlT2JqID0gaGFuZGxlcnNbIGkgXTsKCQkJCQkJc2VsID0gaGFuZGxlT2JqLnNlbGVjdG9yOwoKCQkJCQkJaWYgKCBzZWxNYXRjaFsgc2VsIF0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJCXNlbE1hdGNoWyBzZWwgXSA9IGpxY3VyLmlzKCBzZWwgKTsKCQkJCQkJfQoJCQkJCQlpZiAoIHNlbE1hdGNoWyBzZWwgXSApIHsKCQkJCQkJCW1hdGNoZXMucHVzaCggaGFuZGxlT2JqICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKCBtYXRjaGVzLmxlbmd0aCApIHsKCQkJCQkJaGFuZGxlclF1ZXVlLnB1c2goeyBlbGVtOiBjdXIsIG1hdGNoZXM6IG1hdGNoZXMgfSk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBBZGQgdGhlIHJlbWFpbmluZyAoZGlyZWN0bHktYm91bmQpIGhhbmRsZXJzCgkJaWYgKCBoYW5kbGVycy5sZW5ndGggPiBkZWxlZ2F0ZUNvdW50ICkgewoJCQloYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IHRoaXMsIG1hdGNoZXM6IGhhbmRsZXJzLnNsaWNlKCBkZWxlZ2F0ZUNvdW50ICkgfSk7CgkJfQoKCQkvLyBSdW4gZGVsZWdhdGVzIGZpcnN0OyB0aGV5IG1heSB3YW50IHRvIHN0b3AgcHJvcGFnYXRpb24gYmVuZWF0aCB1cwoJCWZvciAoIGkgPSAwOyBpIDwgaGFuZGxlclF1ZXVlLmxlbmd0aCAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKTsgaSsrICkgewoJCQltYXRjaGVkID0gaGFuZGxlclF1ZXVlWyBpIF07CgkJCWV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CgoJCQlmb3IgKCBqID0gMDsgaiA8IG1hdGNoZWQubWF0Y2hlcy5sZW5ndGggJiYgIWV2ZW50LmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCk7IGorKyApIHsKCQkJCWhhbmRsZU9iaiA9IG1hdGNoZWQubWF0Y2hlc1sgaiBdOwoKCQkJCS8vIFRyaWdnZXJlZCBldmVudCBtdXN0IGVpdGhlciAxKSBiZSBub24tZXhjbHVzaXZlIGFuZCBoYXZlIG5vIG5hbWVzcGFjZSwgb3IKCQkJCS8vIDIpIGhhdmUgbmFtZXNwYWNlKHMpIGEgc3Vic2V0IG9yIGVxdWFsIHRvIHRob3NlIGluIHRoZSBib3VuZCBldmVudCAoYm90aCBjYW4gaGF2ZSBubyBuYW1lc3BhY2UpLgoJCQkJaWYgKCBydW5fYWxsIHx8ICghZXZlbnQubmFtZXNwYWNlICYmICFoYW5kbGVPYmoubmFtZXNwYWNlKSB8fCBldmVudC5uYW1lc3BhY2VfcmUgJiYgZXZlbnQubmFtZXNwYWNlX3JlLnRlc3QoIGhhbmRsZU9iai5uYW1lc3BhY2UgKSApIHsKCgkJCQkJZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOwoJCQkJCWV2ZW50LmhhbmRsZU9iaiA9IGhhbmRsZU9iajsKCgkJCQkJcmV0ID0gKCAoalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIGhhbmRsZU9iai5vcmlnVHlwZSBdIHx8IHt9KS5oYW5kbGUgfHwgaGFuZGxlT2JqLmhhbmRsZXIgKQoJCQkJCQkJLmFwcGx5KCBtYXRjaGVkLmVsZW0sIGFyZ3MgKTsKCgkJCQkJaWYgKCByZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJCQkJZXZlbnQucmVzdWx0ID0gcmV0OwoJCQkJCQlpZiAoIHJldCA9PT0gZmFsc2UgKSB7CgkJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIENhbGwgdGhlIHBvc3REaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUKCQlpZiAoIHNwZWNpYWwucG9zdERpc3BhdGNoICkgewoJCQlzcGVjaWFsLnBvc3REaXNwYXRjaC5jYWxsKCB0aGlzLCBldmVudCApOwoJCX0KCgkJcmV0dXJuIGV2ZW50LnJlc3VsdDsKCX0sCgoJLy8gSW5jbHVkZXMgc29tZSBldmVudCBwcm9wcyBzaGFyZWQgYnkgS2V5RXZlbnQgYW5kIE1vdXNlRXZlbnQKCS8vICoqKiBhdHRyQ2hhbmdlIGF0dHJOYW1lIHJlbGF0ZWROb2RlIHNyY0VsZW1lbnQgIGFyZSBub3Qgbm9ybWFsaXplZCwgbm9uLVczQywgZGVwcmVjYXRlZCwgd2lsbCBiZSByZW1vdmVkIGluIDEuOCAqKioKCXByb3BzOiAiYXR0ckNoYW5nZSBhdHRyTmFtZSByZWxhdGVkTm9kZSBzcmNFbGVtZW50IGFsdEtleSBidWJibGVzIGNhbmNlbGFibGUgY3RybEtleSBjdXJyZW50VGFyZ2V0IGV2ZW50UGhhc2UgbWV0YUtleSByZWxhdGVkVGFyZ2V0IHNoaWZ0S2V5IHRhcmdldCB0aW1lU3RhbXAgdmlldyB3aGljaCIuc3BsaXQoIiAiKSwKCglmaXhIb29rczoge30sCgoJa2V5SG9va3M6IHsKCQlwcm9wczogImNoYXIgY2hhckNvZGUga2V5IGtleUNvZGUiLnNwbGl0KCIgIiksCgkJZmlsdGVyOiBmdW5jdGlvbiggZXZlbnQsIG9yaWdpbmFsICkgewoKCQkJLy8gQWRkIHdoaWNoIGZvciBrZXkgZXZlbnRzCgkJCWlmICggZXZlbnQud2hpY2ggPT0gbnVsbCApIHsKCQkJCWV2ZW50LndoaWNoID0gb3JpZ2luYWwuY2hhckNvZGUgIT0gbnVsbCA/IG9yaWdpbmFsLmNoYXJDb2RlIDogb3JpZ2luYWwua2V5Q29kZTsKCQkJfQoKCQkJcmV0dXJuIGV2ZW50OwoJCX0KCX0sCgoJbW91c2VIb29rczogewoJCXByb3BzOiAiYnV0dG9uIGJ1dHRvbnMgY2xpZW50WCBjbGllbnRZIGZyb21FbGVtZW50IG9mZnNldFggb2Zmc2V0WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkgdG9FbGVtZW50Ii5zcGxpdCgiICIpLAoJCWZpbHRlcjogZnVuY3Rpb24oIGV2ZW50LCBvcmlnaW5hbCApIHsKCQkJdmFyIGV2ZW50RG9jLCBkb2MsIGJvZHksCgkJCQlidXR0b24gPSBvcmlnaW5hbC5idXR0b24sCgkJCQlmcm9tRWxlbWVudCA9IG9yaWdpbmFsLmZyb21FbGVtZW50OwoKCQkJLy8gQ2FsY3VsYXRlIHBhZ2VYL1kgaWYgbWlzc2luZyBhbmQgY2xpZW50WC9ZIGF2YWlsYWJsZQoJCQlpZiAoIGV2ZW50LnBhZ2VYID09IG51bGwgJiYgb3JpZ2luYWwuY2xpZW50WCAhPSBudWxsICkgewoJCQkJZXZlbnREb2MgPSBldmVudC50YXJnZXQub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudDsKCQkJCWRvYyA9IGV2ZW50RG9jLmRvY3VtZW50RWxlbWVudDsKCQkJCWJvZHkgPSBldmVudERvYy5ib2R5OwoKCQkJCWV2ZW50LnBhZ2VYID0gb3JpZ2luYWwuY2xpZW50WCArICggZG9jICYmIGRvYy5zY3JvbGxMZWZ0IHx8IGJvZHkgJiYgYm9keS5zY3JvbGxMZWZ0IHx8IDAgKSAtICggZG9jICYmIGRvYy5jbGllbnRMZWZ0IHx8IGJvZHkgJiYgYm9keS5jbGllbnRMZWZ0IHx8IDAgKTsKCQkJCWV2ZW50LnBhZ2VZID0gb3JpZ2luYWwuY2xpZW50WSArICggZG9jICYmIGRvYy5zY3JvbGxUb3AgIHx8IGJvZHkgJiYgYm9keS5zY3JvbGxUb3AgIHx8IDAgKSAtICggZG9jICYmIGRvYy5jbGllbnRUb3AgIHx8IGJvZHkgJiYgYm9keS5jbGllbnRUb3AgIHx8IDAgKTsKCQkJfQoKCQkJLy8gQWRkIHJlbGF0ZWRUYXJnZXQsIGlmIG5lY2Vzc2FyeQoJCQlpZiAoICFldmVudC5yZWxhdGVkVGFyZ2V0ICYmIGZyb21FbGVtZW50ICkgewoJCQkJZXZlbnQucmVsYXRlZFRhcmdldCA9IGZyb21FbGVtZW50ID09PSBldmVudC50YXJnZXQgPyBvcmlnaW5hbC50b0VsZW1lbnQgOiBmcm9tRWxlbWVudDsKCQkJfQoKCQkJLy8gQWRkIHdoaWNoIGZvciBjbGljazogMSA9PT0gbGVmdDsgMiA9PT0gbWlkZGxlOyAzID09PSByaWdodAoJCQkvLyBOb3RlOiBidXR0b24gaXMgbm90IG5vcm1hbGl6ZWQsIHNvIGRvbid0IHVzZSBpdAoJCQlpZiAoICFldmVudC53aGljaCAmJiBidXR0b24gIT09IHVuZGVmaW5lZCApIHsKCQkJCWV2ZW50LndoaWNoID0gKCBidXR0b24gJiAxID8gMSA6ICggYnV0dG9uICYgMiA/IDMgOiAoIGJ1dHRvbiAmIDQgPyAyIDogMCApICkgKTsKCQkJfQoKCQkJcmV0dXJuIGV2ZW50OwoJCX0KCX0sCgoJZml4OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudFsgalF1ZXJ5LmV4cGFuZG8gXSApIHsKCQkJcmV0dXJuIGV2ZW50OwoJCX0KCgkJLy8gQ3JlYXRlIGEgd3JpdGFibGUgY29weSBvZiB0aGUgZXZlbnQgb2JqZWN0IGFuZCBub3JtYWxpemUgc29tZSBwcm9wZXJ0aWVzCgkJdmFyIGksIHByb3AsCgkJCW9yaWdpbmFsRXZlbnQgPSBldmVudCwKCQkJZml4SG9vayA9IGpRdWVyeS5ldmVudC5maXhIb29rc1sgZXZlbnQudHlwZSBdIHx8IHt9LAoJCQljb3B5ID0gZml4SG9vay5wcm9wcyA/IHRoaXMucHJvcHMuY29uY2F0KCBmaXhIb29rLnByb3BzICkgOiB0aGlzLnByb3BzOwoKCQlldmVudCA9IGpRdWVyeS5FdmVudCggb3JpZ2luYWxFdmVudCApOwoKCQlmb3IgKCBpID0gY29weS5sZW5ndGg7IGk7ICkgewoJCQlwcm9wID0gY29weVsgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnaW5hbEV2ZW50WyBwcm9wIF07CgkJfQoKCQkvLyBGaXggdGFyZ2V0IHByb3BlcnR5LCBpZiBuZWNlc3NhcnkgKCMxOTI1LCBJRSA2LzcvOCAmIFNhZmFyaTIpCgkJaWYgKCAhZXZlbnQudGFyZ2V0ICkgewoJCQlldmVudC50YXJnZXQgPSBvcmlnaW5hbEV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CgkJfQoKCQkvLyBUYXJnZXQgc2hvdWxkIG5vdCBiZSBhIHRleHQgbm9kZSAoIzUwNCwgU2FmYXJpKQoJCWlmICggZXZlbnQudGFyZ2V0Lm5vZGVUeXBlID09PSAzICkgewoJCQlldmVudC50YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTsKCQl9CgoJCS8vIEZvciBtb3VzZS9rZXkgZXZlbnRzLCBtZXRhS2V5PT1mYWxzZSBpZiBpdCdzIHVuZGVmaW5lZCAoIzMzNjgsICMxMTMyODsgSUU2LzcvOCkKCQlldmVudC5tZXRhS2V5ID0gISFldmVudC5tZXRhS2V5OwoKCQlyZXR1cm4gZml4SG9vay5maWx0ZXI/IGZpeEhvb2suZmlsdGVyKCBldmVudCwgb3JpZ2luYWxFdmVudCApIDogZXZlbnQ7Cgl9LAoKCXNwZWNpYWw6IHsKCQlyZWFkeTogewoJCQkvLyBNYWtlIHN1cmUgdGhlIHJlYWR5IGV2ZW50IGlzIHNldHVwCgkJCXNldHVwOiBqUXVlcnkuYmluZFJlYWR5CgkJfSwKCgkJbG9hZDogewoJCQkvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkCgkJCW5vQnViYmxlOiB0cnVlCgkJfSwKCgkJZm9jdXM6IHsKCQkJZGVsZWdhdGVUeXBlOiAiZm9jdXNpbiIKCQl9LAoJCWJsdXI6IHsKCQkJZGVsZWdhdGVUeXBlOiAiZm9jdXNvdXQiCgkJfSwKCgkJYmVmb3JldW5sb2FkOiB7CgkJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUgKSB7CgkJCQkvLyBXZSBvbmx5IHdhbnQgdG8gZG8gdGhpcyBzcGVjaWFsIGNhc2Ugb24gd2luZG93cwoJCQkJaWYgKCBqUXVlcnkuaXNXaW5kb3coIHRoaXMgKSApIHsKCQkJCQl0aGlzLm9uYmVmb3JldW5sb2FkID0gZXZlbnRIYW5kbGU7CgkJCQl9CgkJCX0sCgoJCQl0ZWFyZG93bjogZnVuY3Rpb24oIG5hbWVzcGFjZXMsIGV2ZW50SGFuZGxlICkgewoJCQkJaWYgKCB0aGlzLm9uYmVmb3JldW5sb2FkID09PSBldmVudEhhbmRsZSApIHsKCQkJCQl0aGlzLm9uYmVmb3JldW5sb2FkID0gbnVsbDsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJc2ltdWxhdGU6IGZ1bmN0aW9uKCB0eXBlLCBlbGVtLCBldmVudCwgYnViYmxlICkgewoJCS8vIFBpZ2d5YmFjayBvbiBhIGRvbm9yIGV2ZW50IHRvIHNpbXVsYXRlIGEgZGlmZmVyZW50IG9uZS4KCQkvLyBGYWtlIG9yaWdpbmFsRXZlbnQgdG8gYXZvaWQgZG9ub3IncyBzdG9wUHJvcGFnYXRpb24sIGJ1dCBpZiB0aGUKCQkvLyBzaW11bGF0ZWQgZXZlbnQgcHJldmVudHMgZGVmYXVsdCB0aGVuIHdlIGRvIHRoZSBzYW1lIG9uIHRoZSBkb25vci4KCQl2YXIgZSA9IGpRdWVyeS5leHRlbmQoCgkJCW5ldyBqUXVlcnkuRXZlbnQoKSwKCQkJZXZlbnQsCgkJCXsgdHlwZTogdHlwZSwKCQkJCWlzU2ltdWxhdGVkOiB0cnVlLAoJCQkJb3JpZ2luYWxFdmVudDoge30KCQkJfQoJCSk7CgkJaWYgKCBidWJibGUgKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCBlLCBudWxsLCBlbGVtICk7CgkJfSBlbHNlIHsKCQkJalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmNhbGwoIGVsZW0sIGUgKTsKCQl9CgkJaWYgKCBlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0KfTsKCi8vIFNvbWUgcGx1Z2lucyBhcmUgdXNpbmcsIGJ1dCBpdCdzIHVuZG9jdW1lbnRlZC9kZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQuCi8vIFRoZSAxLjcgc3BlY2lhbCBldmVudCBpbnRlcmZhY2Ugc2hvdWxkIHByb3ZpZGUgYWxsIHRoZSBob29rcyBuZWVkZWQgbm93LgpqUXVlcnkuZXZlbnQuaGFuZGxlID0galF1ZXJ5LmV2ZW50LmRpc3BhdGNoOwoKalF1ZXJ5LnJlbW92ZUV2ZW50ID0gZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciA/CglmdW5jdGlvbiggZWxlbSwgdHlwZSwgaGFuZGxlICkgewoJCWlmICggZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyICkgewoJCQllbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIoIHR5cGUsIGhhbmRsZSwgZmFsc2UgKTsKCQl9Cgl9IDoKCWZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBoYW5kbGUgKSB7CgkJdmFyIG5hbWUgPSAib24iICsgdHlwZTsKCgkJaWYgKCBlbGVtLmRldGFjaEV2ZW50ICkgewoKCQkJLy8gIzg1NDUsICM3MDU0LCBwcmV2ZW50aW5nIG1lbW9yeSBsZWFrcyBmb3IgY3VzdG9tIGV2ZW50cyBpbiBJRTYtOCDigJMKCQkJLy8gZGV0YWNoRXZlbnQgbmVlZGVkIHByb3BlcnR5IG9uIGVsZW1lbnQsIGJ5IG5hbWUgb2YgdGhhdCBldmVudCwgdG8gcHJvcGVybHkgZXhwb3NlIGl0IHRvIEdDCgkJCWlmICggdHlwZW9mIGVsZW1bIG5hbWUgXSA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCQllbGVtWyBuYW1lIF0gPSBudWxsOwoJCQl9CgoJCQllbGVtLmRldGFjaEV2ZW50KCBuYW1lLCBoYW5kbGUgKTsKCQl9Cgl9OwoKalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24oIHNyYywgcHJvcHMgKSB7CgkvLyBBbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgdGhlICduZXcnIGtleXdvcmQKCWlmICggISh0aGlzIGluc3RhbmNlb2YgalF1ZXJ5LkV2ZW50KSApIHsKCQlyZXR1cm4gbmV3IGpRdWVyeS5FdmVudCggc3JjLCBwcm9wcyApOwoJfQoKCS8vIEV2ZW50IG9iamVjdAoJaWYgKCBzcmMgJiYgc3JjLnR5cGUgKSB7CgkJdGhpcy5vcmlnaW5hbEV2ZW50ID0gc3JjOwoJCXRoaXMudHlwZSA9IHNyYy50eXBlOwoKCQkvLyBFdmVudHMgYnViYmxpbmcgdXAgdGhlIGRvY3VtZW50IG1heSBoYXZlIGJlZW4gbWFya2VkIGFzIHByZXZlbnRlZAoJCS8vIGJ5IGEgaGFuZGxlciBsb3dlciBkb3duIHRoZSB0cmVlOyByZWZsZWN0IHRoZSBjb3JyZWN0IHZhbHVlLgoJCXRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gKCBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fCBzcmMucmV0dXJuVmFsdWUgPT09IGZhbHNlIHx8CgkJCXNyYy5nZXRQcmV2ZW50RGVmYXVsdCAmJiBzcmMuZ2V0UHJldmVudERlZmF1bHQoKSApID8gcmV0dXJuVHJ1ZSA6IHJldHVybkZhbHNlOwoKCS8vIEV2ZW50IHR5cGUKCX0gZWxzZSB7CgkJdGhpcy50eXBlID0gc3JjOwoJfQoKCS8vIFB1dCBleHBsaWNpdGx5IHByb3ZpZGVkIHByb3BlcnRpZXMgb250byB0aGUgZXZlbnQgb2JqZWN0CglpZiAoIHByb3BzICkgewoJCWpRdWVyeS5leHRlbmQoIHRoaXMsIHByb3BzICk7Cgl9CgoJLy8gQ3JlYXRlIGEgdGltZXN0YW1wIGlmIGluY29taW5nIGV2ZW50IGRvZXNuJ3QgaGF2ZSBvbmUKCXRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgalF1ZXJ5Lm5vdygpOwoKCS8vIE1hcmsgaXQgYXMgZml4ZWQKCXRoaXNbIGpRdWVyeS5leHBhbmRvIF0gPSB0cnVlOwp9OwoKZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CglyZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gcmV0dXJuVHJ1ZSgpIHsKCXJldHVybiB0cnVlOwp9CgovLyBqUXVlcnkuRXZlbnQgaXMgYmFzZWQgb24gRE9NMyBFdmVudHMgYXMgc3BlY2lmaWVkIGJ5IHRoZSBFQ01BU2NyaXB0IExhbmd1YWdlIEJpbmRpbmcKLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAwMy9XRC1ET00tTGV2ZWwtMy1FdmVudHMtMjAwMzAzMzEvZWNtYS1zY3JpcHQtYmluZGluZy5odG1sCmpRdWVyeS5FdmVudC5wcm90b3R5cGUgPSB7CglwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSByZXR1cm5UcnVlOwoKCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCQlpZiAoICFlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBpZiBwcmV2ZW50RGVmYXVsdCBleGlzdHMgcnVuIGl0IG9uIHRoZSBvcmlnaW5hbCBldmVudAoJCWlmICggZS5wcmV2ZW50RGVmYXVsdCApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoKCQkvLyBvdGhlcndpc2Ugc2V0IHRoZSByZXR1cm5WYWx1ZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gZmFsc2UgKElFKQoJCX0gZWxzZSB7CgkJCWUucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQl9Cgl9LAoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKCQl0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKCgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgkJaWYgKCAhZSApIHsKCQkJcmV0dXJuOwoJCX0KCQkvLyBpZiBzdG9wUHJvcGFnYXRpb24gZXhpc3RzIHJ1biBpdCBvbiB0aGUgb3JpZ2luYWwgZXZlbnQKCQlpZiAoIGUuc3RvcFByb3BhZ2F0aW9uICkgewoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCQkvLyBvdGhlcndpc2Ugc2V0IHRoZSBjYW5jZWxCdWJibGUgcHJvcGVydHkgb2YgdGhlIG9yaWdpbmFsIGV2ZW50IHRvIHRydWUgKElFKQoJCWUuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCX0sCglzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewoJCXRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCXRoaXMuc3RvcFByb3BhZ2F0aW9uKCk7Cgl9LAoJaXNEZWZhdWx0UHJldmVudGVkOiByZXR1cm5GYWxzZSwKCWlzUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKCWlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZQp9OwoKLy8gQ3JlYXRlIG1vdXNlZW50ZXIvbGVhdmUgZXZlbnRzIHVzaW5nIG1vdXNlb3Zlci9vdXQgYW5kIGV2ZW50LXRpbWUgY2hlY2tzCmpRdWVyeS5lYWNoKHsKCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAoJbW91c2VsZWF2ZTogIm1vdXNlb3V0Igp9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIG9yaWcgXSA9IHsKCQlkZWxlZ2F0ZVR5cGU6IGZpeCwKCQliaW5kVHlwZTogZml4LAoKCQloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHJldCwKCQkJCXRhcmdldCA9IHRoaXMsCgkJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCwKCQkJCWhhbmRsZU9iaiA9IGV2ZW50LmhhbmRsZU9iaiwKCQkJCXNlbGVjdG9yID0gaGFuZGxlT2JqLnNlbGVjdG9yOwoKCQkJLy8gRm9yIG1vdXNlbnRlci9sZWF2ZSBjYWxsIHRoZSBoYW5kbGVyIGlmIHJlbGF0ZWQgaXMgb3V0c2lkZSB0aGUgdGFyZ2V0LgoJCQkvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwoJCQlpZiAoICFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0YXJnZXQgJiYgIWpRdWVyeS5jb250YWlucyggdGFyZ2V0LCByZWxhdGVkICkpICkgewoJCQkJZXZlbnQudHlwZSA9IGhhbmRsZU9iai5vcmlnVHlwZTsKCQkJCXJldCA9IGhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCWV2ZW50LnR5cGUgPSBmaXg7CgkJCX0KCQkJcmV0dXJuIHJldDsKCQl9Cgl9Owp9KTsKCi8vIElFIHN1Ym1pdCBkZWxlZ2F0aW9uCmlmICggIWpRdWVyeS5zdXBwb3J0LnN1Ym1pdEJ1YmJsZXMgKSB7CgoJalF1ZXJ5LmV2ZW50LnNwZWNpYWwuc3VibWl0ID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gT25seSBuZWVkIHRoaXMgZm9yIGRlbGVnYXRlZCBmb3JtIHN1Ym1pdCBldmVudHMKCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJmb3JtIiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBMYXp5LWFkZCBhIHN1Ym1pdCBoYW5kbGVyIHdoZW4gYSBkZXNjZW5kYW50IGZvcm0gbWF5IHBvdGVudGlhbGx5IGJlIHN1Ym1pdHRlZAoJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAiY2xpY2suX3N1Ym1pdCBrZXlwcmVzcy5fc3VibWl0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkvLyBOb2RlIG5hbWUgY2hlY2sgYXZvaWRzIGEgVk1MLXJlbGF0ZWQgY3Jhc2ggaW4gSUUgKCM5ODA3KQoJCQkJdmFyIGVsZW0gPSBlLnRhcmdldCwKCQkJCQlmb3JtID0galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaW5wdXQiICkgfHwgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiYnV0dG9uIiApID8gZWxlbS5mb3JtIDogdW5kZWZpbmVkOwoJCQkJaWYgKCBmb3JtICYmICFqUXVlcnkuX2RhdGEoIGZvcm0sICJfc3VibWl0X2F0dGFjaGVkIiApICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIGZvcm0sICJzdWJtaXQuX3N1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJZXZlbnQuX3N1Ym1pdF9idWJibGUgPSB0cnVlOwoJCQkJCX0pOwoJCQkJCWpRdWVyeS5fZGF0YSggZm9ybSwgIl9zdWJtaXRfYXR0YWNoZWQiLCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCQkvLyByZXR1cm4gdW5kZWZpbmVkIHNpbmNlIHdlIGRvbid0IG5lZWQgYW4gZXZlbnQgbGlzdGVuZXIKCQl9LAoKCQlwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gSWYgZm9ybSB3YXMgc3VibWl0dGVkIGJ5IHRoZSB1c2VyLCBidWJibGUgdGhlIGV2ZW50IHVwIHRoZSB0cmVlCgkJCWlmICggZXZlbnQuX3N1Ym1pdF9idWJibGUgKSB7CgkJCQlkZWxldGUgZXZlbnQuX3N1Ym1pdF9idWJibGU7CgkJCQlpZiAoIHRoaXMucGFyZW50Tm9kZSAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgewoJCQkJCWpRdWVyeS5ldmVudC5zaW11bGF0ZSggInN1Ym1pdCIsIHRoaXMucGFyZW50Tm9kZSwgZXZlbnQsIHRydWUgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJLy8gT25seSBuZWVkIHRoaXMgZm9yIGRlbGVnYXRlZCBmb3JtIHN1Ym1pdCBldmVudHMKCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJmb3JtIiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBSZW1vdmUgZGVsZWdhdGVkIGhhbmRsZXJzOyBjbGVhbkRhdGEgZXZlbnR1YWxseSByZWFwcyBzdWJtaXQgaGFuZGxlcnMgYXR0YWNoZWQgYWJvdmUKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5fc3VibWl0IiApOwoJCX0KCX07Cn0KCi8vIElFIGNoYW5nZSBkZWxlZ2F0aW9uIGFuZCBjaGVja2JveC9yYWRpbyBmaXgKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hhbmdlQnViYmxlcyApIHsKCglqUXVlcnkuZXZlbnQuc3BlY2lhbC5jaGFuZ2UgPSB7CgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJCWlmICggcmZvcm1FbGVtcy50ZXN0KCB0aGlzLm5vZGVOYW1lICkgKSB7CgkJCQkvLyBJRSBkb2Vzbid0IGZpcmUgY2hhbmdlIG9uIGEgY2hlY2svcmFkaW8gdW50aWwgYmx1cjsgdHJpZ2dlciBpdCBvbiBjbGljawoJCQkJLy8gYWZ0ZXIgYSBwcm9wZXJ0eWNoYW5nZS4gRWF0IHRoZSBibHVyLWNoYW5nZSBpbiBzcGVjaWFsLmNoYW5nZS5oYW5kbGUuCgkJCQkvLyBUaGlzIHN0aWxsIGZpcmVzIG9uY2hhbmdlIGEgc2Vjb25kIHRpbWUgZm9yIGNoZWNrL3JhZGlvIGFmdGVyIGJsdXIuCgkJCQlpZiAoIHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiB8fCB0aGlzLnR5cGUgPT09ICJyYWRpbyIgKSB7CgkJCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgInByb3BlcnR5Y2hhbmdlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJCWlmICggZXZlbnQub3JpZ2luYWxFdmVudC5wcm9wZXJ0eU5hbWUgPT09ICJjaGVja2VkIiApIHsKCQkJCQkJCXRoaXMuX2p1c3RfY2hhbmdlZCA9IHRydWU7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAiY2xpY2suX2NoYW5nZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJaWYgKCB0aGlzLl9qdXN0X2NoYW5nZWQgJiYgIWV2ZW50LmlzVHJpZ2dlciApIHsKCQkJCQkJCXRoaXMuX2p1c3RfY2hhbmdlZCA9IGZhbHNlOwoJCQkJCQl9CgkJCQkJCS8vIEFsbG93IHRyaWdnZXJlZCwgc2ltdWxhdGVkIGNoYW5nZSBldmVudHMgKCMxMTUwMCkKCQkJCQkJalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAiY2hhbmdlIiwgdGhpcywgZXZlbnQsIHRydWUgKTsKCQkJCQl9KTsKCQkJCX0KCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQkvLyBEZWxlZ2F0ZWQgZXZlbnQ7IGxhenktYWRkIGEgY2hhbmdlIGhhbmRsZXIgb24gZGVzY2VuZGFudCBpbnB1dHMKCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgImJlZm9yZWFjdGl2YXRlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBlbGVtID0gZS50YXJnZXQ7CgoJCQkJaWYgKCByZm9ybUVsZW1zLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSAmJiAhalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiX2NoYW5nZV9hdHRhY2hlZCIgKSApIHsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCBlbGVtLCAiY2hhbmdlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJCWlmICggdGhpcy5wYXJlbnROb2RlICYmICFldmVudC5pc1NpbXVsYXRlZCAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgewoJCQkJCQkJalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAiY2hhbmdlIiwgdGhpcy5wYXJlbnROb2RlLCBldmVudCwgdHJ1ZSApOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQkJalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiX2NoYW5nZV9hdHRhY2hlZCIsIHRydWUgKTsKCQkJCX0KCQkJfSk7CgkJfSwKCgkJaGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBlbGVtID0gZXZlbnQudGFyZ2V0OwoKCQkJLy8gU3dhbGxvdyBuYXRpdmUgY2hhbmdlIGV2ZW50cyBmcm9tIGNoZWNrYm94L3JhZGlvLCB3ZSBhbHJlYWR5IHRyaWdnZXJlZCB0aGVtIGFib3ZlCgkJCWlmICggdGhpcyAhPT0gZWxlbSB8fCBldmVudC5pc1NpbXVsYXRlZCB8fCBldmVudC5pc1RyaWdnZXIgfHwgKGVsZW0udHlwZSAhPT0gInJhZGlvIiAmJiBlbGVtLnR5cGUgIT09ICJjaGVja2JveCIpICkgewoJCQkJcmV0dXJuIGV2ZW50LmhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5fY2hhbmdlIiApOwoKCQkJcmV0dXJuIHJmb3JtRWxlbXMudGVzdCggdGhpcy5ub2RlTmFtZSApOwoJCX0KCX07Cn0KCi8vIENyZWF0ZSAiYnViYmxpbmciIGZvY3VzIGFuZCBibHVyIGV2ZW50cwppZiAoICFqUXVlcnkuc3VwcG9ydC5mb2N1c2luQnViYmxlcyApIHsKCWpRdWVyeS5lYWNoKHsgZm9jdXM6ICJmb2N1c2luIiwgYmx1cjogImZvY3Vzb3V0IiB9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoKCQkvLyBBdHRhY2ggYSBzaW5nbGUgY2FwdHVyaW5nIGhhbmRsZXIgd2hpbGUgc29tZW9uZSB3YW50cyBmb2N1c2luL2ZvY3Vzb3V0CgkJdmFyIGF0dGFjaGVzID0gMCwKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWpRdWVyeS5ldmVudC5zaW11bGF0ZSggZml4LCBldmVudC50YXJnZXQsIGpRdWVyeS5ldmVudC5maXgoIGV2ZW50ICksIHRydWUgKTsKCQkJfTsKCgkJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIGZpeCBdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGF0dGFjaGVzKysgPT09IDAgKSB7CgkJCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggb3JpZywgaGFuZGxlciwgdHJ1ZSApOwoJCQkJfQoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIC0tYXR0YWNoZXMgPT09IDAgKSB7CgkJCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggb3JpZywgaGFuZGxlciwgdHJ1ZSApOwoJCQkJfQoJCQl9CgkJfTsKCX0pOwp9CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCglvbjogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIC8qSU5URVJOQUwqLyBvbmUgKSB7CgkJdmFyIG9yaWdGbiwgdHlwZTsKCgkJLy8gVHlwZXMgY2FuIGJlIGEgbWFwIG9mIHR5cGVzL2hhbmRsZXJzCgkJaWYgKCB0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiICkgewoJCQkvLyAoIHR5cGVzLU9iamVjdCwgc2VsZWN0b3IsIGRhdGEgKQoJCQlpZiAoIHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgKSB7IC8vICYmIHNlbGVjdG9yICE9IG51bGwKCQkJCS8vICggdHlwZXMtT2JqZWN0LCBkYXRhICkKCQkJCWRhdGEgPSBkYXRhIHx8IHNlbGVjdG9yOwoJCQkJc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJCX0KCQkJZm9yICggdHlwZSBpbiB0eXBlcyApIHsKCQkJCXRoaXMub24oIHR5cGUsIHNlbGVjdG9yLCBkYXRhLCB0eXBlc1sgdHlwZSBdLCBvbmUgKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmICggZGF0YSA9PSBudWxsICYmIGZuID09IG51bGwgKSB7CgkJCS8vICggdHlwZXMsIGZuICkKCQkJZm4gPSBzZWxlY3RvcjsKCQkJZGF0YSA9IHNlbGVjdG9yID0gdW5kZWZpbmVkOwoJCX0gZWxzZSBpZiAoIGZuID09IG51bGwgKSB7CgkJCWlmICggdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJCS8vICggdHlwZXMsIHNlbGVjdG9yLCBmbiApCgkJCQlmbiA9IGRhdGE7CgkJCQlkYXRhID0gdW5kZWZpbmVkOwoJCQl9IGVsc2UgewoJCQkJLy8gKCB0eXBlcywgZGF0YSwgZm4gKQoJCQkJZm4gPSBkYXRhOwoJCQkJZGF0YSA9IHNlbGVjdG9yOwoJCQkJc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJCX0KCQl9CgkJaWYgKCBmbiA9PT0gZmFsc2UgKSB7CgkJCWZuID0gcmV0dXJuRmFsc2U7CgkJfSBlbHNlIGlmICggIWZuICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmICggb25lID09PSAxICkgewoJCQlvcmlnRm4gPSBmbjsKCQkJZm4gPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBDYW4gdXNlIGFuIGVtcHR5IHNldCwgc2luY2UgZXZlbnQgY29udGFpbnMgdGhlIGluZm8KCQkJCWpRdWVyeSgpLm9mZiggZXZlbnQgKTsKCQkJCXJldHVybiBvcmlnRm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9OwoJCQkvLyBVc2Ugc2FtZSBndWlkIHNvIGNhbGxlciBjYW4gcmVtb3ZlIHVzaW5nIG9yaWdGbgoJCQlmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKCBvcmlnRm4uZ3VpZCA9IGpRdWVyeS5ndWlkKysgKTsKCQl9CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGVzLCBmbiwgZGF0YSwgc2VsZWN0b3IgKTsKCQl9KTsKCX0sCglvbmU6IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuICkgewoJCXJldHVybiB0aGlzLm9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAxICk7Cgl9LAoJb2ZmOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBmbiApIHsKCQl2YXIgaGFuZGxlT2JqLCB0eXBlOwoJCWlmICggdHlwZXMgJiYgdHlwZXMucHJldmVudERlZmF1bHQgJiYgdHlwZXMuaGFuZGxlT2JqICkgewoJCQkvLyAoIGV2ZW50ICkgIGRpc3BhdGNoZWQgalF1ZXJ5LkV2ZW50CgkJCWhhbmRsZU9iaiA9IHR5cGVzLmhhbmRsZU9iajsKCQkJalF1ZXJ5KCB0eXBlcy5kZWxlZ2F0ZVRhcmdldCApLm9mZigKCQkJCWhhbmRsZU9iai5uYW1lc3BhY2UgPyBoYW5kbGVPYmoub3JpZ1R5cGUgKyAiLiIgKyBoYW5kbGVPYmoubmFtZXNwYWNlIDogaGFuZGxlT2JqLm9yaWdUeXBlLAoJCQkJaGFuZGxlT2JqLnNlbGVjdG9yLAoJCQkJaGFuZGxlT2JqLmhhbmRsZXIKCQkJKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCWlmICggdHlwZW9mIHR5cGVzID09PSAib2JqZWN0IiApIHsKCQkJLy8gKCB0eXBlcy1vYmplY3QgWywgc2VsZWN0b3JdICkKCQkJZm9yICggdHlwZSBpbiB0eXBlcyApIHsKCQkJCXRoaXMub2ZmKCB0eXBlLCBzZWxlY3RvciwgdHlwZXNbIHR5cGUgXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCQlpZiAoIHNlbGVjdG9yID09PSBmYWxzZSB8fCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJmdW5jdGlvbiIgKSB7CgkJCS8vICggdHlwZXMgWywgZm5dICkKCQkJZm4gPSBzZWxlY3RvcjsKCQkJc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJfQoJCWlmICggZm4gPT09IGZhbHNlICkgewoJCQlmbiA9IHJldHVybkZhbHNlOwoJCX0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCB0eXBlcywgZm4sIHNlbGVjdG9yICk7CgkJfSk7Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBudWxsLCBkYXRhLCBmbiApOwoJfSwKCXVuYmluZDogZnVuY3Rpb24oIHR5cGVzLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vZmYoIHR5cGVzLCBudWxsLCBmbiApOwoJfSwKCglsaXZlOiBmdW5jdGlvbiggdHlwZXMsIGRhdGEsIGZuICkgewoJCWpRdWVyeSggdGhpcy5jb250ZXh0ICkub24oIHR5cGVzLCB0aGlzLnNlbGVjdG9yLCBkYXRhLCBmbiApOwoJCXJldHVybiB0aGlzOwoJfSwKCWRpZTogZnVuY3Rpb24oIHR5cGVzLCBmbiApIHsKCQlqUXVlcnkoIHRoaXMuY29udGV4dCApLm9mZiggdHlwZXMsIHRoaXMuc2VsZWN0b3IgfHwgIioqIiwgZm4gKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZGVsZWdhdGU6IGZ1bmN0aW9uKCBzZWxlY3RvciwgdHlwZXMsIGRhdGEsIGZuICkgewoJCXJldHVybiB0aGlzLm9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuICk7Cgl9LAoJdW5kZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZm4gKSB7CgkJLy8gKCBuYW1lc3BhY2UgKSBvciAoIHNlbGVjdG9yLCB0eXBlcyBbLCBmbl0gKQoJCXJldHVybiBhcmd1bWVudHMubGVuZ3RoID09IDE/IHRoaXMub2ZmKCBzZWxlY3RvciwgIioqIiApIDogdGhpcy5vZmYoIHR5cGVzLCBzZWxlY3RvciwgZm4gKTsKCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIHRoaXMgKTsKCQl9KTsKCX0sCgl0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJaWYgKCB0aGlzWzBdICkgewoJCQlyZXR1cm4galF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIHRoaXNbMF0sIHRydWUgKTsKCQl9Cgl9LAoKCXRvZ2dsZTogZnVuY3Rpb24oIGZuICkgewoJCS8vIFNhdmUgcmVmZXJlbmNlIHRvIGFyZ3VtZW50cyBmb3IgYWNjZXNzIGluIGNsb3N1cmUKCQl2YXIgYXJncyA9IGFyZ3VtZW50cywKCQkJZ3VpZCA9IGZuLmd1aWQgfHwgalF1ZXJ5Lmd1aWQrKywKCQkJaSA9IDAsCgkJCXRvZ2dsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBGaWd1cmUgb3V0IHdoaWNoIGZ1bmN0aW9uIHRvIGV4ZWN1dGUKCQkJCXZhciBsYXN0VG9nZ2xlID0gKCBqUXVlcnkuX2RhdGEoIHRoaXMsICJsYXN0VG9nZ2xlIiArIGZuLmd1aWQgKSB8fCAwICkgJSBpOwoJCQkJalF1ZXJ5Ll9kYXRhKCB0aGlzLCAibGFzdFRvZ2dsZSIgKyBmbi5ndWlkLCBsYXN0VG9nZ2xlICsgMSApOwoKCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IGNsaWNrcyBzdG9wCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCS8vIGFuZCBleGVjdXRlIHRoZSBmdW5jdGlvbgoJCQkJcmV0dXJuIGFyZ3NbIGxhc3RUb2dnbGUgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICkgfHwgZmFsc2U7CgkJCX07CgoJCS8vIGxpbmsgYWxsIHRoZSBmdW5jdGlvbnMsIHNvIGFueSBvZiB0aGVtIGNhbiB1bmJpbmQgdGhpcyBjbGljayBoYW5kbGVyCgkJdG9nZ2xlci5ndWlkID0gZ3VpZDsKCQl3aGlsZSAoIGkgPCBhcmdzLmxlbmd0aCApIHsKCQkJYXJnc1sgaSsrIF0uZ3VpZCA9IGd1aWQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5jbGljayggdG9nZ2xlciApOwoJfSwKCglob3ZlcjogZnVuY3Rpb24oIGZuT3ZlciwgZm5PdXQgKSB7CgkJcmV0dXJuIHRoaXMubW91c2VlbnRlciggZm5PdmVyICkubW91c2VsZWF2ZSggZm5PdXQgfHwgZm5PdmVyICk7Cgl9Cn0pOwoKalF1ZXJ5LmVhY2goICgiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgIiArCgkibW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZWVudGVyIG1vdXNlbGVhdmUgIiArCgkiY2hhbmdlIHNlbGVjdCBzdWJtaXQga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBlcnJvciBjb250ZXh0bWVudSIpLnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoKCS8vIEhhbmRsZSBldmVudCBiaW5kaW5nCglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBkYXRhLCBmbiApIHsKCQlpZiAoIGZuID09IG51bGwgKSB7CgkJCWZuID0gZGF0YTsKCQkJZGF0YSA9IG51bGw7CgkJfQoKCQlyZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDAgPwoJCQl0aGlzLm9uKCBuYW1lLCBudWxsLCBkYXRhLCBmbiApIDoKCQkJdGhpcy50cmlnZ2VyKCBuYW1lICk7Cgl9OwoKCWlmICggcmtleUV2ZW50LnRlc3QoIG5hbWUgKSApIHsKCQlqUXVlcnkuZXZlbnQuZml4SG9va3NbIG5hbWUgXSA9IGpRdWVyeS5ldmVudC5rZXlIb29rczsKCX0KCglpZiAoIHJtb3VzZUV2ZW50LnRlc3QoIG5hbWUgKSApIHsKCQlqUXVlcnkuZXZlbnQuZml4SG9va3NbIG5hbWUgXSA9IGpRdWVyeS5ldmVudC5tb3VzZUhvb2tzOwoJfQp9KTsKLyohCiAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lCiAqICBDb3B5cmlnaHQgMjAxMiwgVGhlIERvam8gRm91bmRhdGlvbgogKiAgUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCwgQlNELCBhbmQgR1BMIExpY2Vuc2VzLgogKiAgTW9yZSBpbmZvcm1hdGlvbjogaHR0cDovL3NpenpsZWpzLmNvbS8KICovCihmdW5jdGlvbiggd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY2FjaGVkcnVucywKCWRpcnJ1bnMsCglzb3J0T3JkZXIsCglzaWJsaW5nQ2hlY2ssCglhc3NlcnRHZXRJZE5vdE5hbWUsCgoJZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCglkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoKCXN0cnVuZGVmaW5lZCA9ICJ1bmRlZmluZWQiLAoJaGFzRHVwbGljYXRlID0gZmFsc2UsCgliYXNlSGFzRHVwbGljYXRlID0gdHJ1ZSwKCWRvbmUgPSAwLAoJc2xpY2UgPSBbXS5zbGljZSwKCXB1c2ggPSBbXS5wdXNoLAoKCWV4cGFuZG8gPSAoICJzaXpjYWNoZSIgKyBNYXRoLnJhbmRvbSgpICkucmVwbGFjZSggIi4iLCAiIiApLAoKCS8vIFJlZ2V4CgoJLy8gV2hpdGVzcGFjZSBjaGFyYWN0ZXJzIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc2VsZWN0b3JzLyN3aGl0ZXNwYWNlCgl3aGl0ZXNwYWNlID0gIltcXHgyMFxcdFxcclxcblxcZl0iLAoJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zeW50YXgvI2NoYXJhY3RlcnMKCWNoYXJhY3RlckVuY29kaW5nID0gIig/OlxcXFwufFstXFx3XXxbXlxceDAwLVxceGEwXSkrIiwKCgkvLyBMb29zZWx5IG1vZGVsZWQgb24gQ1NTIGlkZW50aWZpZXIgY2hhcmFjdGVycwoJLy8gQW4gdW5xdW90ZWQgdmFsdWUgc2hvdWxkIGJlIGEgQ1NTIGlkZW50aWZpZXIgKGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc2VsZWN0b3JzLyNhdHRyaWJ1dGUtc2VsZWN0b3JzKQoJLy8gUHJvcGVyIHN5bnRheDogaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI3ZhbHVlLWRlZi1pZGVudGlmaWVyCglpZGVudGlmaWVyID0gY2hhcmFjdGVyRW5jb2RpbmcucmVwbGFjZSggInciLCAidyMiICksCgoJLy8gQWNjZXB0YWJsZSBvcGVyYXRvcnMgaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNhdHRyaWJ1dGUtc2VsZWN0b3JzCglvcGVyYXRvcnMgPSAiKFsqXiR8IX5dPz0pIiwKCWF0dHJpYnV0ZXMgPSAiXFxbIiArIHdoaXRlc3BhY2UgKyAiKigiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSIgKyB3aGl0ZXNwYWNlICsKCQkiKig/OiIgKyBvcGVyYXRvcnMgKyB3aGl0ZXNwYWNlICsgIiooPzooWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwzfCgiICsgaWRlbnRpZmllciArICIpfCl8KSIgKyB3aGl0ZXNwYWNlICsgIipcXF0iLAoJcHNldWRvcyA9ICI6KCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpKD86XFwoKD86KFsnXCJdKSgoPzpcXFxcLnxbXlxcXFxdKSo/KVxcMnwoKD86W14sXXxcXFxcLHwoPzosKD89W15cXFtdKlxcXSkpfCg/OiwoPz1bXlxcKF0qXFwpKSkpKikpXFwpfCkiLAoJcG9zID0gIjoobnRofGVxfGd0fGx0fGZpcnN0fGxhc3R8ZXZlbnxvZGQpKD86XFwoKFxcZCopXFwpfCkoPz1bXi1dfCQpIiwKCWNvbWJpbmF0b3JzID0gd2hpdGVzcGFjZSArICIqKFtcXHgyMFxcdFxcclxcblxcZj4rfl0pIiArIHdoaXRlc3BhY2UgKyAiKiIsCglncm91cHMgPSAiKD89W15cXHgyMFxcdFxcclxcblxcZl0pKD86XFxcXC58IiArIGF0dHJpYnV0ZXMgKyAifCIgKyBwc2V1ZG9zLnJlcGxhY2UoIDIsIDcgKSArICJ8W15cXFxcKCksXSkrIiwKCgkvLyBMZWFkaW5nIGFuZCBub24tZXNjYXBlZCB0cmFpbGluZyB3aGl0ZXNwYWNlLCBjYXB0dXJpbmcgc29tZSBub24td2hpdGVzcGFjZSBjaGFyYWN0ZXJzIHByZWNlZGluZyB0aGUgbGF0dGVyCglydHJpbSA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiK3woKD86XnxbXlxcXFxdKSg/OlxcXFwuKSopIiArIHdoaXRlc3BhY2UgKyAiKyQiLCAiZyIgKSwKCglyY29tYmluYXRvcnMgPSBuZXcgUmVnRXhwKCAiXiIgKyBjb21iaW5hdG9ycyApLAoKCS8vIEFsbCBzaW1wbGUgKG5vbi1jb21tYSkgc2VsZWN0b3JzLCBleGNsdWRpbmcgaW5zaWduaWZhbnQgdHJhaWxpbmcgd2hpdGVzcGFjZQoJcmdyb3VwcyA9IG5ldyBSZWdFeHAoIGdyb3VwcyArICI/KD89IiArIHdoaXRlc3BhY2UgKyAiKix8JCkiLCAiZyIgKSwKCgkvLyBBIHNlbGVjdG9yLCBvciBldmVyeXRoaW5nIGFmdGVyIGxlYWRpbmcgd2hpdGVzcGFjZQoJLy8gT3B0aW9uYWxseSBmb2xsb3dlZCBpbiBlaXRoZXIgY2FzZSBieSBhICIpIiBmb3IgdGVybWluYXRpbmcgc3ViLXNlbGVjdG9ycwoJcnNlbGVjdG9yID0gbmV3IFJlZ0V4cCggIl4oPzooPyEsKSg/Oig/Ol58LCkiICsgd2hpdGVzcGFjZSArICIqIiArIGdyb3VwcyArICIpKj98IiArIHdoaXRlc3BhY2UgKyAiKiguKj8pKShcXCl8JCkiICksCgoJLy8gQWxsIGNvbWJpbmF0b3JzIGFuZCBzZWxlY3RvciBjb21wb25lbnRzIChhdHRyaWJ1dGUgdGVzdCwgdGFnLCBwc2V1ZG8sIGV0Yy4pLCB0aGUgbGF0dGVyIGFwcGVhcmluZyB0b2dldGhlciB3aGVuIGNvbnNlY3V0aXZlCglydG9rZW5zID0gbmV3IFJlZ0V4cCggZ3JvdXBzLnNsaWNlKCAxOSwgLTYgKSArICJcXHgyMFxcdFxcclxcblxcZj4rfl0pK3wiICsgY29tYmluYXRvcnMsICJnIiApLAoKCS8vIEVhc2lseS1wYXJzZWFibGUvcmV0cmlldmFibGUgSUQgb3IgVEFHIG9yIENMQVNTIHNlbGVjdG9ycwoJcnF1aWNrRXhwciA9IC9eKD86IyhbXHdcLV0rKXwoXHcrKXxcLihbXHdcLV0rKSkkLywKCglyc2libGluZyA9IC9bXHgyMFx0XHJcblxmXSpbK35dLywKCXJlbmRzV2l0aE5vdCA9IC86bm90XCgkLywKCglyaGVhZGVyID0gL2hcZC9pLAoJcmlucHV0cyA9IC9pbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uL2ksCgoJcmJhY2tzbGFzaCA9IC9cXCg/IVxcKS9nLAoKCW1hdGNoRXhwciA9IHsKCQkiSUQiOiBuZXcgUmVnRXhwKCAiXiMoIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksCgkJIkNMQVNTIjogbmV3IFJlZ0V4cCggIl5cXC4oIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksCgkJIk5BTUUiOiBuZXcgUmVnRXhwKCAiXlxcW25hbWU9WydcIl0/KCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpWydcIl0/XFxdIiApLAoJCSJUQUciOiBuZXcgUmVnRXhwKCAiXigiICsgY2hhcmFjdGVyRW5jb2RpbmcucmVwbGFjZSggIlstIiwgIlstXFwqIiApICsgIikiICksCgkJIkFUVFIiOiBuZXcgUmVnRXhwKCAiXiIgKyBhdHRyaWJ1dGVzICksCgkJIlBTRVVETyI6IG5ldyBSZWdFeHAoICJeIiArIHBzZXVkb3MgKSwKCQkiQ0hJTEQiOiBuZXcgUmVnRXhwKCAiXjoob25seXxudGh8bGFzdHxmaXJzdCktY2hpbGQoPzpcXCgiICsgd2hpdGVzcGFjZSArCgkJCSIqKGV2ZW58b2RkfCgoWystXXwpKFxcZCopbnwpIiArIHdoaXRlc3BhY2UgKyAiKig/OihbKy1dfCkiICsgd2hpdGVzcGFjZSArCgkJCSIqKFxcZCspfCkpIiArIHdoaXRlc3BhY2UgKyAiKlxcKXwpIiwgImkiICksCgkJIlBPUyI6IG5ldyBSZWdFeHAoIHBvcywgImlnIiApLAoJCS8vIEZvciB1c2UgaW4gbGlicmFyaWVzIGltcGxlbWVudGluZyAuaXMoKQoJCSJuZWVkc0NvbnRleHQiOiBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIipbPit+XXwiICsgcG9zLCAiaSIgKQoJfSwKCgljbGFzc0NhY2hlID0ge30sCgljYWNoZWRDbGFzc2VzID0gW10sCgljb21waWxlckNhY2hlID0ge30sCgljYWNoZWRTZWxlY3RvcnMgPSBbXSwKCgkvLyBNYXJrIGEgZnVuY3Rpb24gZm9yIHVzZSBpbiBmaWx0ZXJpbmcKCW1hcmtGdW5jdGlvbiA9IGZ1bmN0aW9uKCBmbiApIHsKCQlmbi5zaXp6bGVGaWx0ZXIgPSB0cnVlOwoJCXJldHVybiBmbjsKCX0sCgoJLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBpbnB1dCB0eXBlcwoJY3JlYXRlSW5wdXRGdW5jdGlvbiA9IGZ1bmN0aW9uKCB0eXBlICkgewoJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gQ2hlY2sgdGhlIGlucHV0J3Mgbm9kZU5hbWUgYW5kIHR5cGUKCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09IHR5cGU7CgkJfTsKCX0sCgoJLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBidXR0b25zCgljcmVhdGVCdXR0b25GdW5jdGlvbiA9IGZ1bmN0aW9uKCB0eXBlICkgewoJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiAobmFtZSA9PT0gImlucHV0IiB8fCBuYW1lID09PSAiYnV0dG9uIikgJiYgZWxlbS50eXBlID09PSB0eXBlOwoJCX07Cgl9LAoKCS8vIFVzZWQgZm9yIHRlc3Rpbmcgc29tZXRoaW5nIG9uIGFuIGVsZW1lbnQKCWFzc2VydCA9IGZ1bmN0aW9uKCBmbiApIHsKCQl2YXIgcGFzcyA9IGZhbHNlLAoJCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCQl0cnkgewoJCQlwYXNzID0gZm4oIGRpdiApOwoJCX0gY2F0Y2ggKGUpIHt9CgkJLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKCQlkaXYgPSBudWxsOwoJCXJldHVybiBwYXNzOwoJfSwKCgkvLyBDaGVjayBpZiBhdHRyaWJ1dGVzIHNob3VsZCBiZSByZXRyaWV2ZWQgYnkgYXR0cmlidXRlIG5vZGVzCglhc3NlcnRBdHRyaWJ1dGVzID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJZGl2LmlubmVySFRNTCA9ICI8c2VsZWN0Pjwvc2VsZWN0PiI7CgkJdmFyIHR5cGUgPSB0eXBlb2YgZGl2Lmxhc3RDaGlsZC5nZXRBdHRyaWJ1dGUoIm11bHRpcGxlIik7CgkJLy8gSUU4IHJldHVybnMgYSBzdHJpbmcgZm9yIHNvbWUgYXR0cmlidXRlcyBldmVuIHdoZW4gbm90IHByZXNlbnQKCQlyZXR1cm4gdHlwZSAhPT0gImJvb2xlYW4iICYmIHR5cGUgIT09ICJzdHJpbmciOwoJfSksCgoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudEJ5SWQgcmV0dXJucyBlbGVtZW50cyBieSBuYW1lCgkvLyBDaGVjayBpZiBnZXRFbGVtZW50c0J5TmFtZSBwcml2aWxlZ2VzIGZvcm0gY29udHJvbHMgb3IgcmV0dXJucyBlbGVtZW50cyBieSBJRAoJYXNzZXJ0VXNhYmxlTmFtZSA9IGFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCS8vIEluamVjdCBjb250ZW50CgkJZGl2LmlkID0gZXhwYW5kbyArIDA7CgkJZGl2LmlubmVySFRNTCA9ICI8YSBuYW1lPSciICsgZXhwYW5kbyArICInPjwvYT48ZGl2IG5hbWU9JyIgKyBleHBhbmRvICsgIic+PC9kaXY+IjsKCQlkb2NFbGVtLmluc2VydEJlZm9yZSggZGl2LCBkb2NFbGVtLmZpcnN0Q2hpbGQgKTsKCgkJLy8gVGVzdAoJCXZhciBwYXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUgJiYKCQkJLy8gYnVnZ3kgYnJvd3NlcnMgd2lsbCByZXR1cm4gZmV3ZXIgdGhhbiB0aGUgY29ycmVjdCAyCgkJCWRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKCBleHBhbmRvICkubGVuZ3RoID09PQoJCQkvLyBidWdneSBicm93c2VycyB3aWxsIHJldHVybiBtb3JlIHRoYW4gdGhlIGNvcnJlY3QgMAoJCQkyICsgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoIGV4cGFuZG8gKyAwICkubGVuZ3RoOwoJCWFzc2VydEdldElkTm90TmFtZSA9ICFkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggZXhwYW5kbyApOwoKCQkvLyBDbGVhbnVwCgkJZG9jRWxlbS5yZW1vdmVDaGlsZCggZGl2ICk7CgoJCXJldHVybiBwYXNzOwoJfSksCgoJLy8gQ2hlY2sgaWYgdGhlIGJyb3dzZXIgcmV0dXJucyBvbmx5IGVsZW1lbnRzCgkvLyB3aGVuIGRvaW5nIGdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikKCWFzc2VydFRhZ05hbWVOb0NvbW1lbnRzID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJZGl2LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVDb21tZW50KCIiKSApOwoJCXJldHVybiBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKS5sZW5ndGggPT09IDA7Cgl9KSwKCgkvLyBDaGVjayBpZiBnZXRBdHRyaWJ1dGUgcmV0dXJucyBub3JtYWxpemVkIGhyZWYgYXR0cmlidXRlcwoJYXNzZXJ0SHJlZk5vdE5vcm1hbGl6ZWQgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iOwoJCXJldHVybiBkaXYuZmlyc3RDaGlsZCAmJiB0eXBlb2YgZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlICE9PSBzdHJ1bmRlZmluZWQgJiYKCQkJZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIjIjsKCX0pLAoKCS8vIENoZWNrIGlmIGdldEVsZW1lbnRzQnlDbGFzc05hbWUgY2FuIGJlIHRydXN0ZWQKCWFzc2VydFVzYWJsZUNsYXNzTmFtZSA9IGFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCS8vIE9wZXJhIGNhbid0IGZpbmQgYSBzZWNvbmQgY2xhc3NuYW1lIChpbiA5LjYpCgkJZGl2LmlubmVySFRNTCA9ICI8ZGl2IGNsYXNzPSdoaWRkZW4gZSc+PC9kaXY+PGRpdiBjbGFzcz0naGlkZGVuJz48L2Rpdj4iOwoJCWlmICggIWRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHx8IGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJlIikubGVuZ3RoID09PSAwICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvLyBTYWZhcmkgY2FjaGVzIGNsYXNzIGF0dHJpYnV0ZXMsIGRvZXNuJ3QgY2F0Y2ggY2hhbmdlcyAoaW4gMy4yKQoJCWRpdi5sYXN0Q2hpbGQuY2xhc3NOYW1lID0gImUiOwoJCXJldHVybiBkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiZSIpLmxlbmd0aCAhPT0gMTsKCX0pOwoKdmFyIFNpenpsZSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApIHsKCXJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwoJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7Cgl2YXIgbWF0Y2gsIGVsZW0sIHhtbCwgbSwKCQlub2RlVHlwZSA9IGNvbnRleHQubm9kZVR5cGU7CgoJaWYgKCBub2RlVHlwZSAhPT0gMSAmJiBub2RlVHlwZSAhPT0gOSApIHsKCQlyZXR1cm4gW107Cgl9CgoJaWYgKCAhc2VsZWN0b3IgfHwgdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKCQlyZXR1cm4gcmVzdWx0czsKCX0KCgl4bWwgPSBpc1hNTCggY29udGV4dCApOwoKCWlmICggIXhtbCAmJiAhc2VlZCApIHsKCQlpZiAoIChtYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKSkgKSB7CgkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoIiNJRCIpCgkJCWlmICggKG0gPSBtYXRjaFsxXSkgKSB7CgkJCQlpZiAoIG5vZGVUeXBlID09PSA5ICkgewoJCQkJCWVsZW0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKCBtICk7CgkJCQkJLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKCQkJCQkvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCgkJCQkJaWYgKCBlbGVtICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQkJLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIElFLCBPcGVyYSwgYW5kIFdlYmtpdCByZXR1cm4gaXRlbXMKCQkJCQkJLy8gYnkgbmFtZSBpbnN0ZWFkIG9mIElECgkJCQkJCWlmICggZWxlbS5pZCA9PT0gbSApIHsKCQkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCQkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQkJCX0KCQkJCQl9IGVsc2UgewoJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIENvbnRleHQgaXMgbm90IGEgZG9jdW1lbnQKCQkJCQlpZiAoIGNvbnRleHQub3duZXJEb2N1bWVudCAmJiAoZWxlbSA9IGNvbnRleHQub3duZXJEb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbSApKSAmJgoJCQkJCQljb250YWlucyggY29udGV4dCwgZWxlbSApICYmIGVsZW0uaWQgPT09IG0gKSB7CgkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQl9CgkJCQl9CgoJCQkvLyBTcGVlZC11cDogU2l6emxlKCJUQUciKQoJCQl9IGVsc2UgaWYgKCBtYXRjaFsyXSApIHsKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggc2VsZWN0b3IgKSwgMCkgKTsKCQkJCXJldHVybiByZXN1bHRzOwoKCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiLkNMQVNTIikKCQkJfSBlbHNlIGlmICggKG0gPSBtYXRjaFszXSkgJiYgYXNzZXJ0VXNhYmxlQ2xhc3NOYW1lICYmIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSApIHsKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBtICksIDApICk7CgkJCQlyZXR1cm4gcmVzdWx0czsKCQkJfQoJCX0KCX0KCgkvLyBBbGwgb3RoZXJzCglyZXR1cm4gc2VsZWN0KCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCwgeG1sICk7Cn07Cgp2YXIgRXhwciA9IFNpenpsZS5zZWxlY3RvcnMgPSB7CgoJLy8gQ2FuIGJlIGFkanVzdGVkIGJ5IHRoZSB1c2VyCgljYWNoZUxlbmd0aDogNTAsCgoJbWF0Y2g6IG1hdGNoRXhwciwKCglvcmRlcjogWyAiSUQiLCAiVEFHIiBdLAoKCWF0dHJIYW5kbGU6IHt9LAoKCWNyZWF0ZVBzZXVkbzogbWFya0Z1bmN0aW9uLAoKCWZpbmQ6IHsKCQkiSUQiOiBhc3NlcnRHZXRJZE5vdE5hbWUgPwoJCQlmdW5jdGlvbiggaWQsIGNvbnRleHQsIHhtbCApIHsKCQkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09IHN0cnVuZGVmaW5lZCAmJiAheG1sICkgewoJCQkJCXZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZCggaWQgKTsKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQlyZXR1cm4gbSAmJiBtLnBhcmVudE5vZGUgPyBbbV0gOiBbXTsKCQkJCX0KCQkJfSA6CgkJCWZ1bmN0aW9uKCBpZCwgY29udGV4dCwgeG1sICkgewoJCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gc3RydW5kZWZpbmVkICYmICF4bWwgKSB7CgkJCQkJdmFyIG0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKCBpZCApOwoKCQkJCQlyZXR1cm4gbSA/CgkJCQkJCW0uaWQgPT09IGlkIHx8IHR5cGVvZiBtLmdldEF0dHJpYnV0ZU5vZGUgIT09IHN0cnVuZGVmaW5lZCAmJiBtLmdldEF0dHJpYnV0ZU5vZGUoImlkIikudmFsdWUgPT09IGlkID8KCQkJCQkJCVttXSA6CgkJCQkJCQl1bmRlZmluZWQgOgoJCQkJCQlbXTsKCQkJCX0KCQkJfSwKCgkJIlRBRyI6IGFzc2VydFRhZ05hbWVOb0NvbW1lbnRzID8KCQkJZnVuY3Rpb24oIHRhZywgY29udGV4dCApIHsKCQkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09IHN0cnVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggdGFnICk7CgkJCQl9CgkJCX0gOgoJCQlmdW5jdGlvbiggdGFnLCBjb250ZXh0ICkgewoJCQkJdmFyIHJlc3VsdHMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKTsKCgkJCQkvLyBGaWx0ZXIgb3V0IHBvc3NpYmxlIGNvbW1lbnRzCgkJCQlpZiAoIHRhZyA9PT0gIioiICkgewoJCQkJCXZhciBlbGVtLAoJCQkJCQl0bXAgPSBbXSwKCQkJCQkJaSA9IDA7CgoJCQkJCWZvciAoIDsgKGVsZW0gPSByZXN1bHRzW2ldKTsgaSsrICkgewoJCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCQl0bXAucHVzaCggZWxlbSApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlyZXR1cm4gdG1wOwoJCQkJfQoJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCX0KCX0sCgoJcmVsYXRpdmU6IHsKCQkiPiI6IHsgZGlyOiAicGFyZW50Tm9kZSIsIGZpcnN0OiB0cnVlIH0sCgkJIiAiOiB7IGRpcjogInBhcmVudE5vZGUiIH0sCgkJIisiOiB7IGRpcjogInByZXZpb3VzU2libGluZyIsIGZpcnN0OiB0cnVlIH0sCgkJIn4iOiB7IGRpcjogInByZXZpb3VzU2libGluZyIgfQoJfSwKCglwcmVGaWx0ZXI6IHsKCQkiQVRUUiI6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJbWF0Y2hbMV0gPSBtYXRjaFsxXS5yZXBsYWNlKCByYmFja3NsYXNoLCAiIiApOwoKCQkJLy8gTW92ZSB0aGUgZ2l2ZW4gdmFsdWUgdG8gbWF0Y2hbM10gd2hldGhlciBxdW90ZWQgb3IgdW5xdW90ZWQKCQkJbWF0Y2hbM10gPSAoIG1hdGNoWzRdIHx8IG1hdGNoWzVdIHx8ICIiICkucmVwbGFjZSggcmJhY2tzbGFzaCwgIiIgKTsKCgkJCWlmICggbWF0Y2hbMl0gPT09ICJ+PSIgKSB7CgkJCQltYXRjaFszXSA9ICIgIiArIG1hdGNoWzNdICsgIiAiOwoJCQl9CgoJCQlyZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDQgKTsKCQl9LAoKCQkiQ0hJTEQiOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCS8qIG1hdGNoZXMgZnJvbSBtYXRjaEV4cHIuQ0hJTEQKCQkJCTEgdHlwZSAob25seXxudGh8Li4uKQoJCQkJMiBhcmd1bWVudCAoZXZlbnxvZGR8XGQqfFxkKm4oWystXVxkKyk/fC4uLikKCQkJCTMgeG4tY29tcG9uZW50IG9mIHhuK3kgYXJndW1lbnQgKFsrLV0/XGQqbnwpCgkJCQk0IHNpZ24gb2YgeG4tY29tcG9uZW50CgkJCQk1IHggb2YgeG4tY29tcG9uZW50CgkJCQk2IHNpZ24gb2YgeS1jb21wb25lbnQKCQkJCTcgeSBvZiB5LWNvbXBvbmVudAoJCQkqLwoJCQltYXRjaFsxXSA9IG1hdGNoWzFdLnRvTG93ZXJDYXNlKCk7CgoJCQlpZiAoIG1hdGNoWzFdID09PSAibnRoIiApIHsKCQkJCS8vIG50aC1jaGlsZCByZXF1aXJlcyBhcmd1bWVudAoJCQkJaWYgKCAhbWF0Y2hbMl0gKSB7CgkJCQkJU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwoJCQkJfQoKCQkJCS8vIG51bWVyaWMgeCBhbmQgeSBwYXJhbWV0ZXJzIGZvciBFeHByLmZpbHRlci5DSElMRAoJCQkJLy8gcmVtZW1iZXIgdGhhdCBmYWxzZS90cnVlIGNhc3QgcmVzcGVjdGl2ZWx5IHRvIDAvMQoJCQkJbWF0Y2hbM10gPSArKCBtYXRjaFszXSA/IG1hdGNoWzRdICsgKG1hdGNoWzVdIHx8IDEpIDogMiAqICggbWF0Y2hbMl0gPT09ICJldmVuIiB8fCBtYXRjaFsyXSA9PT0gIm9kZCIgKSApOwoJCQkJbWF0Y2hbNF0gPSArKCAoIG1hdGNoWzZdICsgbWF0Y2hbN10gKSB8fCBtYXRjaFsyXSA9PT0gIm9kZCIgKTsKCgkJCS8vIG90aGVyIHR5cGVzIHByb2hpYml0IGFyZ3VtZW50cwoJCQl9IGVsc2UgaWYgKCBtYXRjaFsyXSApIHsKCQkJCVNpenpsZS5lcnJvciggbWF0Y2hbMF0gKTsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoOwoJCX0sCgoJCSJQU0VVRE8iOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCXZhciBhcmd1bWVudCwKCQkJCXVucXVvdGVkID0gbWF0Y2hbNF07CgoJCQlpZiAoIG1hdGNoRXhwclsiQ0hJTEQiXS50ZXN0KCBtYXRjaFswXSApICkgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJCS8vIFJlbGlucXVpc2ggb3VyIGNsYWltIG9uIGNoYXJhY3RlcnMgaW4gYHVucXVvdGVkYCBmcm9tIGEgY2xvc2luZyBwYXJlbnRoZXNpcyBvbgoJCQlpZiAoIHVucXVvdGVkICYmIChhcmd1bWVudCA9IHJzZWxlY3Rvci5leGVjKCB1bnF1b3RlZCApKSAmJiBhcmd1bWVudC5wb3AoKSApIHsKCgkJCQltYXRjaFswXSA9IG1hdGNoWzBdLnNsaWNlKCAwLCBhcmd1bWVudFswXS5sZW5ndGggLSB1bnF1b3RlZC5sZW5ndGggLSAxICk7CgkJCQl1bnF1b3RlZCA9IGFyZ3VtZW50WzBdLnNsaWNlKCAwLCAtMSApOwoJCQl9CgoJCQkvLyBRdW90ZWQgb3IgdW5xdW90ZWQsIHdlIGhhdmUgdGhlIGZ1bGwgYXJndW1lbnQKCQkJLy8gUmV0dXJuIG9ubHkgY2FwdHVyZXMgbmVlZGVkIGJ5IHRoZSBwc2V1ZG8gZmlsdGVyIG1ldGhvZCAodHlwZSBhbmQgYXJndW1lbnQpCgkJCW1hdGNoLnNwbGljZSggMiwgMywgdW5xdW90ZWQgfHwgbWF0Y2hbM10gKTsKCQkJcmV0dXJuIG1hdGNoOwoJCX0KCX0sCgoJZmlsdGVyOiB7CgkJIklEIjogYXNzZXJ0R2V0SWROb3ROYW1lID8KCQkJZnVuY3Rpb24oIGlkICkgewoJCQkJaWQgPSBpZC5yZXBsYWNlKCByYmFja3NsYXNoLCAiIiApOwoJCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaWQiKSA9PT0gaWQ7CgkJCQl9OwoJCQl9IDoKCQkJZnVuY3Rpb24oIGlkICkgewoJCQkJaWQgPSBpZC5yZXBsYWNlKCByYmFja3NsYXNoLCAiIiApOwoJCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXZhciBub2RlID0gdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gc3RydW5kZWZpbmVkICYmIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKCQkJCQlyZXR1cm4gbm9kZSAmJiBub2RlLnZhbHVlID09PSBpZDsKCQkJCX07CgkJCX0sCgoJCSJUQUciOiBmdW5jdGlvbiggbm9kZU5hbWUgKSB7CgkJCWlmICggbm9kZU5hbWUgPT09ICIqIiApIHsKCQkJCXJldHVybiBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH07CgkJCX0KCQkJbm9kZU5hbWUgPSBub2RlTmFtZS5yZXBsYWNlKCByYmFja3NsYXNoLCAiIiApLnRvTG93ZXJDYXNlKCk7CgoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5vZGVOYW1lOwoJCQl9OwoJCX0sCgoJCSJDTEFTUyI6IGZ1bmN0aW9uKCBjbGFzc05hbWUgKSB7CgkJCXZhciBwYXR0ZXJuID0gY2xhc3NDYWNoZVsgY2xhc3NOYW1lIF07CgkJCWlmICggIXBhdHRlcm4gKSB7CgkJCQlwYXR0ZXJuID0gY2xhc3NDYWNoZVsgY2xhc3NOYW1lIF0gPSBuZXcgUmVnRXhwKCAiKF58IiArIHdoaXRlc3BhY2UgKyAiKSIgKyBjbGFzc05hbWUgKyAiKCIgKyB3aGl0ZXNwYWNlICsgInwkKSIgKTsKCQkJCWNhY2hlZENsYXNzZXMucHVzaCggY2xhc3NOYW1lICk7CgkJCQkvLyBBdm9pZCB0b28gbGFyZ2Ugb2YgYSBjYWNoZQoJCQkJaWYgKCBjYWNoZWRDbGFzc2VzLmxlbmd0aCA+IEV4cHIuY2FjaGVMZW5ndGggKSB7CgkJCQkJZGVsZXRlIGNsYXNzQ2FjaGVbIGNhY2hlZENsYXNzZXMuc2hpZnQoKSBdOwoJCQkJfQoJCQl9CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiBwYXR0ZXJuLnRlc3QoIGVsZW0uY2xhc3NOYW1lIHx8ICh0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgIT09IHN0cnVuZGVmaW5lZCAmJiBlbGVtLmdldEF0dHJpYnV0ZSgiY2xhc3MiKSkgfHwgIiIgKTsKCQkJfTsKCQl9LAoKCQkiQVRUUiI6IGZ1bmN0aW9uKCBuYW1lLCBvcGVyYXRvciwgY2hlY2sgKSB7CgkJCWlmICggIW9wZXJhdG9yICkgewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiBTaXp6bGUuYXR0ciggZWxlbSwgbmFtZSApICE9IG51bGw7CgkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgcmVzdWx0ID0gU2l6emxlLmF0dHIoIGVsZW0sIG5hbWUgKSwKCQkJCQl2YWx1ZSA9IHJlc3VsdCArICIiOwoKCQkJCWlmICggcmVzdWx0ID09IG51bGwgKSB7CgkJCQkJcmV0dXJuIG9wZXJhdG9yID09PSAiIT0iOwoJCQkJfQoKCQkJCXN3aXRjaCAoIG9wZXJhdG9yICkgewoJCQkJCWNhc2UgIj0iOgoJCQkJCQlyZXR1cm4gdmFsdWUgPT09IGNoZWNrOwoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJcmV0dXJuIHZhbHVlICE9PSBjaGVjazsKCQkJCQljYXNlICJePSI6CgkJCQkJCXJldHVybiBjaGVjayAmJiB2YWx1ZS5pbmRleE9mKCBjaGVjayApID09PSAwOwoJCQkJCWNhc2UgIio9IjoKCQkJCQkJcmV0dXJuIGNoZWNrICYmIHZhbHVlLmluZGV4T2YoIGNoZWNrICkgPiAtMTsKCQkJCQljYXNlICIkPSI6CgkJCQkJCXJldHVybiBjaGVjayAmJiB2YWx1ZS5zdWJzdHIoIHZhbHVlLmxlbmd0aCAtIGNoZWNrLmxlbmd0aCApID09PSBjaGVjazsKCQkJCQljYXNlICJ+PSI6CgkJCQkJCXJldHVybiAoICIgIiArIHZhbHVlICsgIiAiICkuaW5kZXhPZiggY2hlY2sgKSA+IC0xOwoJCQkJCWNhc2UgInw9IjoKCQkJCQkJcmV0dXJuIHZhbHVlID09PSBjaGVjayB8fCB2YWx1ZS5zdWJzdHIoIDAsIGNoZWNrLmxlbmd0aCArIDEgKSA9PT0gY2hlY2sgKyAiLSI7CgkJCQl9CgkJCX07CgkJfSwKCgkJIkNISUxEIjogZnVuY3Rpb24oIHR5cGUsIGFyZ3VtZW50LCBmaXJzdCwgbGFzdCApIHsKCgkJCWlmICggdHlwZSA9PT0gIm50aCIgKSB7CgkJCQl2YXIgZG9uZU5hbWUgPSBkb25lKys7CgoJCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXZhciBwYXJlbnQsIGRpZmYsCgkJCQkJCWNvdW50ID0gMCwKCQkJCQkJbm9kZSA9IGVsZW07CgoJCQkJCWlmICggZmlyc3QgPT09IDEgJiYgbGFzdCA9PT0gMCApIHsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoKCQkJCQlwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgoJCQkJCWlmICggcGFyZW50ICYmIChwYXJlbnRbIGV4cGFuZG8gXSAhPT0gZG9uZU5hbWUgfHwgIWVsZW0uc2l6c2V0KSApIHsKCQkJCQkJZm9yICggbm9kZSA9IHBhcmVudC5maXJzdENoaWxkOyBub2RlOyBub2RlID0gbm9kZS5uZXh0U2libGluZyApIHsKCQkJCQkJCWlmICggbm9kZS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJCQlub2RlLnNpenNldCA9ICsrY291bnQ7CgkJCQkJCQkJaWYgKCBub2RlID09PSBlbGVtICkgewoJCQkJCQkJCQlicmVhazsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJCXBhcmVudFsgZXhwYW5kbyBdID0gZG9uZU5hbWU7CgkJCQkJfQoKCQkJCQlkaWZmID0gZWxlbS5zaXpzZXQgLSBsYXN0OwoKCQkJCQlpZiAoIGZpcnN0ID09PSAwICkgewoJCQkJCQlyZXR1cm4gZGlmZiA9PT0gMDsKCgkJCQkJfSBlbHNlIHsKCQkJCQkJcmV0dXJuICggZGlmZiAlIGZpcnN0ID09PSAwICYmIGRpZmYgLyBmaXJzdCA+PSAwICk7CgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIG5vZGUgPSBlbGVtOwoKCQkJCXN3aXRjaCAoIHR5cGUgKSB7CgkJCQkJY2FzZSAib25seSI6CgkJCQkJY2FzZSAiZmlyc3QiOgoJCQkJCQl3aGlsZSAoIChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpICkgewoJCQkJCQkJaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJaWYgKCB0eXBlID09PSAiZmlyc3QiICkgewoJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCX0KCgkJCQkJCW5vZGUgPSBlbGVtOwoKCQkJCQkJLyogZmFsbHMgdGhyb3VnaCAqLwoJCQkJCWNhc2UgImxhc3QiOgoJCQkJCQl3aGlsZSAoIChub2RlID0gbm9kZS5uZXh0U2libGluZykgKSB7CgkJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJfTsKCQl9LAoKCQkiUFNFVURPIjogZnVuY3Rpb24oIHBzZXVkbywgYXJndW1lbnQsIGNvbnRleHQsIHhtbCApIHsKCQkJLy8gcHNldWRvLWNsYXNzIG5hbWVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jcHNldWRvLWNsYXNzZXMKCQkJLy8gUHJpb3JpdGl6ZSBieSBjYXNlIHNlbnNpdGl2aXR5IGluIGNhc2UgY3VzdG9tIHBzZXVkb3MgYXJlIGFkZGVkIHdpdGggdXBwZXJjYXNlIGxldHRlcnMKCQkJdmFyIGZuID0gRXhwci5wc2V1ZG9zWyBwc2V1ZG8gXSB8fCBFeHByLnBzZXVkb3NbIHBzZXVkby50b0xvd2VyQ2FzZSgpIF07CgoJCQlpZiAoICFmbiApIHsKCQkJCVNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIHBzZXVkbzogIiArIHBzZXVkbyApOwoJCQl9CgoJCQkvLyBUaGUgdXNlciBtYXkgc2V0IGZuLnNpenpsZUZpbHRlciB0byBpbmRpY2F0ZQoJCQkvLyB0aGF0IGFyZ3VtZW50cyBhcmUgbmVlZGVkIHRvIGNyZWF0ZSB0aGUgZmlsdGVyIGZ1bmN0aW9uCgkJCS8vIGp1c3QgYXMgU2l6emxlIGRvZXMKCQkJaWYgKCAhZm4uc2l6emxlRmlsdGVyICkgewoJCQkJcmV0dXJuIGZuOwoJCQl9CgoJCQlyZXR1cm4gZm4oIGFyZ3VtZW50LCBjb250ZXh0LCB4bWwgKTsKCQl9Cgl9LAoKCXBzZXVkb3M6IHsKCQkibm90IjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgeG1sICkgewoJCQkvLyBUcmltIHRoZSBzZWxlY3RvciBwYXNzZWQgdG8gY29tcGlsZQoJCQkvLyB0byBhdm9pZCB0cmVhdGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZwoJCQkvLyBzcGFjZXMgYXMgY29tYmluYXRvcnMKCQkJdmFyIG1hdGNoZXIgPSBjb21waWxlKCBzZWxlY3Rvci5yZXBsYWNlKCBydHJpbSwgIiQxIiApLCBjb250ZXh0LCB4bWwgKTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuICFtYXRjaGVyKCBlbGVtICk7CgkJCX07CgkJfSksCgoJCSJlbmFibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZTsKCQl9LAoKCQkiZGlzYWJsZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJImNoZWNrZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gSW4gQ1NTMywgOmNoZWNrZWQgc2hvdWxkIHJldHVybiBib3RoIGNoZWNrZWQgYW5kIHNlbGVjdGVkIGVsZW1lbnRzCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCgkJCXZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAhIWVsZW0uY2hlY2tlZCkgfHwgKG5vZGVOYW1lID09PSAib3B0aW9uIiAmJiAhIWVsZW0uc2VsZWN0ZWQpOwoJCX0sCgoJCSJzZWxlY3RlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CgkJCS8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkKCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQllbGVtLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJfQoKCQkJcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7CgkJfSwKCgkJInBhcmVudCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gIUV4cHIucHNldWRvc1siZW1wdHkiXSggZWxlbSApOwoJCX0sCgoJCSJlbXB0eSI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2VtcHR5LXBzZXVkbwoJCQkvLyA6ZW1wdHkgaXMgb25seSBhZmZlY3RlZCBieSBlbGVtZW50IG5vZGVzIGFuZCBjb250ZW50IG5vZGVzKGluY2x1ZGluZyB0ZXh0KDMpLCBjZGF0YSg0KSksCgkJCS8vICAgbm90IGNvbW1lbnQsIHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb25zLCBvciBvdGhlcnMKCQkJLy8gVGhhbmtzIHRvIERpZWdvIFBlcmluaSBmb3IgdGhlIG5vZGVOYW1lIHNob3J0Y3V0CgkJCS8vICAgR3JlYXRlciB0aGFuICJAIiBtZWFucyBhbHBoYSBjaGFyYWN0ZXJzIChzcGVjaWZpY2FsbHkgbm90IHN0YXJ0aW5nIHdpdGggIiMiIG9yICI/IikKCQkJdmFyIG5vZGVUeXBlOwoJCQllbGVtID0gZWxlbS5maXJzdENoaWxkOwoJCQl3aGlsZSAoIGVsZW0gKSB7CgkJCQlpZiAoIGVsZW0ubm9kZU5hbWUgPiAiQCIgfHwgKG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZSkgPT09IDMgfHwgbm9kZVR5cGUgPT09IDQgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmc7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJImNvbnRhaW5zIjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCB0ZXh0ICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gKCBlbGVtLnRleHRDb250ZW50IHx8IGVsZW0uaW5uZXJUZXh0IHx8IGdldFRleHQoIGVsZW0gKSApLmluZGV4T2YoIHRleHQgKSA+IC0xOwoJCQl9OwoJCX0pLAoKCQkiaGFzIjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIFNpenpsZSggc2VsZWN0b3IsIGVsZW0gKS5sZW5ndGggPiAwOwoJCQl9OwoJCX0pLAoKCQkiaGVhZGVyIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiByaGVhZGVyLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKCQl9LAoKCQkidGV4dCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgdHlwZSwgYXR0cjsKCQkJLy8gSUU2IGFuZCA3IHdpbGwgbWFwIGVsZW0udHlwZSB0byAndGV4dCcgZm9yIG5ldyBIVE1MNSB0eXBlcyAoc2VhcmNoLCBldGMpCgkJCS8vIHVzZSBnZXRBdHRyaWJ1dGUgaW5zdGVhZCB0byB0ZXN0IHRoaXMgY2FzZQoJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmCgkJCQkodHlwZSA9IGVsZW0udHlwZSkgPT09ICJ0ZXh0IiAmJgoJCQkJKCAoYXR0ciA9IGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIikpID09IG51bGwgfHwgYXR0ci50b0xvd2VyQ2FzZSgpID09PSB0eXBlICk7CgkJfSwKCgkJLy8gSW5wdXQgdHlwZXMKCQkicmFkaW8iOiBjcmVhdGVJbnB1dEZ1bmN0aW9uKCJyYWRpbyIpLAoJCSJjaGVja2JveCI6IGNyZWF0ZUlucHV0RnVuY3Rpb24oImNoZWNrYm94IiksCgkJImZpbGUiOiBjcmVhdGVJbnB1dEZ1bmN0aW9uKCJmaWxlIiksCgkJInBhc3N3b3JkIjogY3JlYXRlSW5wdXRGdW5jdGlvbigicGFzc3dvcmQiKSwKCQkiaW1hZ2UiOiBjcmVhdGVJbnB1dEZ1bmN0aW9uKCJpbWFnZSIpLAoKCQkic3VibWl0IjogY3JlYXRlQnV0dG9uRnVuY3Rpb24oInN1Ym1pdCIpLAoJCSJyZXNldCI6IGNyZWF0ZUJ1dHRvbkZ1bmN0aW9uKCJyZXNldCIpLAoKCQkiYnV0dG9uIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gbmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09ICJidXR0b24iIHx8IG5hbWUgPT09ICJidXR0b24iOwoJCX0sCgoJCSJpbnB1dCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gcmlucHV0cy50ZXN0KCBlbGVtLm5vZGVOYW1lICk7CgkJfSwKCgkJImZvY3VzIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBkb2MgPSBlbGVtLm93bmVyRG9jdW1lbnQ7CgkJCXJldHVybiBlbGVtID09PSBkb2MuYWN0aXZlRWxlbWVudCAmJiAoIWRvYy5oYXNGb2N1cyB8fCBkb2MuaGFzRm9jdXMoKSkgJiYgISEoZWxlbS50eXBlIHx8IGVsZW0uaHJlZik7CgkJfSwKCgkJImFjdGl2ZSI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZWxlbS5vd25lckRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CgkJfQoJfSwKCglzZXRGaWx0ZXJzOiB7CgkJImZpcnN0IjogZnVuY3Rpb24oIGVsZW1lbnRzLCBhcmd1bWVudCwgbm90ICkgewoJCQlyZXR1cm4gbm90ID8gZWxlbWVudHMuc2xpY2UoIDEgKSA6IFsgZWxlbWVudHNbMF0gXTsKCQl9LAoKCQkibGFzdCI6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXJndW1lbnQsIG5vdCApIHsKCQkJdmFyIGVsZW0gPSBlbGVtZW50cy5wb3AoKTsKCQkJcmV0dXJuIG5vdCA/IGVsZW1lbnRzIDogWyBlbGVtIF07CgkJfSwKCgkJImV2ZW4iOiBmdW5jdGlvbiggZWxlbWVudHMsIGFyZ3VtZW50LCBub3QgKSB7CgkJCXZhciByZXN1bHRzID0gW10sCgkJCQlpID0gbm90ID8gMSA6IDAsCgkJCQlsZW4gPSBlbGVtZW50cy5sZW5ndGg7CgkJCWZvciAoIDsgaSA8IGxlbjsgaSA9IGkgKyAyICkgewoJCQkJcmVzdWx0cy5wdXNoKCBlbGVtZW50c1tpXSApOwoJCQl9CgkJCXJldHVybiByZXN1bHRzOwoJCX0sCgoJCSJvZGQiOiBmdW5jdGlvbiggZWxlbWVudHMsIGFyZ3VtZW50LCBub3QgKSB7CgkJCXZhciByZXN1bHRzID0gW10sCgkJCQlpID0gbm90ID8gMCA6IDEsCgkJCQlsZW4gPSBlbGVtZW50cy5sZW5ndGg7CgkJCWZvciAoIDsgaSA8IGxlbjsgaSA9IGkgKyAyICkgewoJCQkJcmVzdWx0cy5wdXNoKCBlbGVtZW50c1tpXSApOwoJCQl9CgkJCXJldHVybiByZXN1bHRzOwoJCX0sCgoJCSJsdCI6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXJndW1lbnQsIG5vdCApIHsKCQkJcmV0dXJuIG5vdCA/IGVsZW1lbnRzLnNsaWNlKCArYXJndW1lbnQgKSA6IGVsZW1lbnRzLnNsaWNlKCAwLCArYXJndW1lbnQgKTsKCQl9LAoKCQkiZ3QiOiBmdW5jdGlvbiggZWxlbWVudHMsIGFyZ3VtZW50LCBub3QgKSB7CgkJCXJldHVybiBub3QgPyBlbGVtZW50cy5zbGljZSggMCwgK2FyZ3VtZW50ICsgMSApIDogZWxlbWVudHMuc2xpY2UoICthcmd1bWVudCArIDEgKTsKCQl9LAoKCQkiZXEiOiBmdW5jdGlvbiggZWxlbWVudHMsIGFyZ3VtZW50LCBub3QgKSB7CgkJCXZhciBlbGVtID0gZWxlbWVudHMuc3BsaWNlKCArYXJndW1lbnQsIDEgKTsKCQkJcmV0dXJuIG5vdCA/IGVsZW1lbnRzIDogZWxlbTsKCQl9Cgl9Cn07CgovLyBEZXByZWNhdGVkCkV4cHIuc2V0RmlsdGVyc1sibnRoIl0gPSBFeHByLnNldEZpbHRlcnNbImVxIl07CgovLyBCYWNrLWNvbXBhdApFeHByLmZpbHRlcnMgPSBFeHByLnBzZXVkb3M7CgovLyBJRTYvNyByZXR1cm4gYSBtb2RpZmllZCBocmVmCmlmICggIWFzc2VydEhyZWZOb3ROb3JtYWxpemVkICkgewoJRXhwci5hdHRySGFuZGxlID0gewoJCSJocmVmIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggImhyZWYiLCAyICk7CgkJfSwKCQkidHlwZSI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKTsKCQl9Cgl9Owp9CgovLyBBZGQgZ2V0RWxlbWVudHNCeU5hbWUgaWYgdXNhYmxlCmlmICggYXNzZXJ0VXNhYmxlTmFtZSApIHsKCUV4cHIub3JkZXIucHVzaCgiTkFNRSIpOwoJRXhwci5maW5kWyJOQU1FIl0gPSBmdW5jdGlvbiggbmFtZSwgY29udGV4dCApIHsKCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlOYW1lICE9PSBzdHJ1bmRlZmluZWQgKSB7CgkJCXJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlOYW1lKCBuYW1lICk7CgkJfQoJfTsKfQoKLy8gQWRkIGdldEVsZW1lbnRzQnlDbGFzc05hbWUgaWYgdXNhYmxlCmlmICggYXNzZXJ0VXNhYmxlQ2xhc3NOYW1lICkgewoJRXhwci5vcmRlci5zcGxpY2UoIDEsIDAsICJDTEFTUyIgKTsKCUV4cHIuZmluZFsiQ0xBU1MiXSA9IGZ1bmN0aW9uKCBjbGFzc05hbWUsIGNvbnRleHQsIHhtbCApIHsKCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09IHN0cnVuZGVmaW5lZCAmJiAheG1sICkgewoJCQlyZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBjbGFzc05hbWUgKTsKCQl9Cgl9Owp9CgovLyBJZiBzbGljZSBpcyBub3QgYXZhaWxhYmxlLCBwcm92aWRlIGEgYmFja3VwCnRyeSB7CglzbGljZS5jYWxsKCBkb2NFbGVtLmNoaWxkTm9kZXMsIDAgKVswXS5ub2RlVHlwZTsKfSBjYXRjaCAoIGUgKSB7CglzbGljZSA9IGZ1bmN0aW9uKCBpICkgewoJCXZhciBlbGVtLCByZXN1bHRzID0gW107CgkJZm9yICggOyAoZWxlbSA9IHRoaXNbaV0pOyBpKysgKSB7CgkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX07Cn0KCnZhciBpc1hNTCA9IFNpenpsZS5pc1hNTCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJLy8gZG9jdW1lbnRFbGVtZW50IGlzIHZlcmlmaWVkIGZvciBjYXNlcyB3aGVyZSBpdCBkb2Vzbid0IHlldCBleGlzdAoJLy8gKHN1Y2ggYXMgbG9hZGluZyBpZnJhbWVzIGluIElFIC0gIzQ4MzMpCgl2YXIgZG9jdW1lbnRFbGVtZW50ID0gZWxlbSAmJiAoZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0pLmRvY3VtZW50RWxlbWVudDsKCXJldHVybiBkb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgIT09ICJIVE1MIiA6IGZhbHNlOwp9OwoKLy8gRWxlbWVudCBjb250YWlucyBhbm90aGVyCnZhciBjb250YWlucyA9IFNpenpsZS5jb250YWlucyA9IGRvY0VsZW0uY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwoJZnVuY3Rpb24oIGEsIGIgKSB7CgkJcmV0dXJuICEhKCBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBiICkgJiAxNiApOwoJfSA6Cglkb2NFbGVtLmNvbnRhaW5zID8KCWZ1bmN0aW9uKCBhLCBiICkgewoJCXZhciBhZG93biA9IGEubm9kZVR5cGUgPT09IDkgPyBhLmRvY3VtZW50RWxlbWVudCA6IGEsCgkJCWJ1cCA9IGIucGFyZW50Tm9kZTsKCQlyZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmIGFkb3duLmNvbnRhaW5zICYmIGFkb3duLmNvbnRhaW5zKGJ1cCkgKTsKCX0gOgoJZnVuY3Rpb24oIGEsIGIgKSB7CgkJd2hpbGUgKCAoYiA9IGIucGFyZW50Tm9kZSkgKSB7CgkJCWlmICggYiA9PT0gYSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJCXJldHVybiBmYWxzZTsKCX07CgovKioKICogVXRpbGl0eSBmdW5jdGlvbiBmb3IgcmV0cmlldmluZyB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKICogQHBhcmFtIHtBcnJheXxFbGVtZW50fSBlbGVtCiAqLwp2YXIgZ2V0VGV4dCA9IFNpenpsZS5nZXRUZXh0ID0gZnVuY3Rpb24oIGVsZW0gKSB7Cgl2YXIgbm9kZSwKCQlyZXQgPSAiIiwKCQlpID0gMCwKCQlub2RlVHlwZSA9IGVsZW0ubm9kZVR5cGU7CgoJaWYgKCBub2RlVHlwZSApIHsKCQlpZiAoIG5vZGVUeXBlID09PSAxIHx8IG5vZGVUeXBlID09PSA5IHx8IG5vZGVUeXBlID09PSAxMSApIHsKCQkJLy8gVXNlIHRleHRDb250ZW50IGZvciBlbGVtZW50cwoJCQkvLyBpbm5lclRleHQgdXNhZ2UgcmVtb3ZlZCBmb3IgY29uc2lzdGVuY3kgb2YgbmV3IGxpbmVzIChzZWUgIzExMTUzKQoJCQlpZiAoIHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAic3RyaW5nIiApIHsKCQkJCXJldHVybiBlbGVtLnRleHRDb250ZW50OwoJCQl9IGVsc2UgewoJCQkJLy8gVHJhdmVyc2UgaXRzIGNoaWxkcmVuCgkJCQlmb3IgKCBlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZyApIHsKCQkJCQlyZXQgKz0gZ2V0VGV4dCggZWxlbSApOwoJCQkJfQoJCQl9CgkJfSBlbHNlIGlmICggbm9kZVR5cGUgPT09IDMgfHwgbm9kZVR5cGUgPT09IDQgKSB7CgkJCXJldHVybiBlbGVtLm5vZGVWYWx1ZTsKCQl9CgkJLy8gRG8gbm90IGluY2x1ZGUgY29tbWVudCBvciBwcm9jZXNzaW5nIGluc3RydWN0aW9uIG5vZGVzCgl9IGVsc2UgewoKCQkvLyBJZiBubyBub2RlVHlwZSwgdGhpcyBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheQoJCWZvciAoIDsgKG5vZGUgPSBlbGVtW2ldKTsgaSsrICkgewoJCQkvLyBEbyBub3QgdHJhdmVyc2UgY29tbWVudCBub2RlcwoJCQlyZXQgKz0gZ2V0VGV4dCggbm9kZSApOwoJCX0KCX0KCXJldHVybiByZXQ7Cn07CgpTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJdmFyIGF0dHIsCgkJeG1sID0gaXNYTUwoIGVsZW0gKTsKCglpZiAoICF4bWwgKSB7CgkJbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCX0KCWlmICggRXhwci5hdHRySGFuZGxlWyBuYW1lIF0gKSB7CgkJcmV0dXJuIEV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdKCBlbGVtICk7Cgl9CglpZiAoIGFzc2VydEF0dHJpYnV0ZXMgfHwgeG1sICkgewoJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApOwoJfQoJYXR0ciA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApOwoJcmV0dXJuIGF0dHIgPwoJCXR5cGVvZiBlbGVtWyBuYW1lIF0gPT09ICJib29sZWFuIiA/CgkJCWVsZW1bIG5hbWUgXSA/IG5hbWUgOiBudWxsIDoKCQkJYXR0ci5zcGVjaWZpZWQgPyBhdHRyLnZhbHVlIDogbnVsbCA6CgkJbnVsbDsKfTsKClNpenpsZS5lcnJvciA9IGZ1bmN0aW9uKCBtc2cgKSB7Cgl0aHJvdyBuZXcgRXJyb3IoICJTeW50YXggZXJyb3IsIHVucmVjb2duaXplZCBleHByZXNzaW9uOiAiICsgbXNnICk7Cn07CgovLyBDaGVjayBpZiB0aGUgSmF2YVNjcmlwdCBlbmdpbmUgaXMgdXNpbmcgc29tZSBzb3J0IG9mCi8vIG9wdGltaXphdGlvbiB3aGVyZSBpdCBkb2VzIG5vdCBhbHdheXMgY2FsbCBvdXIgY29tcGFyaXNpb24KLy8gZnVuY3Rpb24uIElmIHRoYXQgaXMgdGhlIGNhc2UsIGRpc2NhcmQgdGhlIGhhc0R1cGxpY2F0ZSB2YWx1ZS4KLy8gICBUaHVzIGZhciB0aGF0IGluY2x1ZGVzIEdvb2dsZSBDaHJvbWUuClswLCAwXS5zb3J0KGZ1bmN0aW9uKCkgewoJcmV0dXJuIChiYXNlSGFzRHVwbGljYXRlID0gMCk7Cn0pOwoKCmlmICggZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiApIHsKCXNvcnRPcmRlciA9IGZ1bmN0aW9uKCBhLCBiICkgewoJCWlmICggYSA9PT0gYiApIHsKCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQkJcmV0dXJuIDA7CgkJfQoKCQlyZXR1cm4gKCAhYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/CgkJCWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gOgoJCQlhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGIpICYgNAoJCSkgPyAtMSA6IDE7Cgl9OwoKfSBlbHNlIHsKCXNvcnRPcmRlciA9IGZ1bmN0aW9uKCBhLCBiICkgewoJCS8vIFRoZSBub2RlcyBhcmUgaWRlbnRpY2FsLCB3ZSBjYW4gZXhpdCBlYXJseQoJCWlmICggYSA9PT0gYiApIHsKCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQkJcmV0dXJuIDA7CgoJCS8vIEZhbGxiYWNrIHRvIHVzaW5nIHNvdXJjZUluZGV4IChpbiBJRSkgaWYgaXQncyBhdmFpbGFibGUgb24gYm90aCBub2RlcwoJCX0gZWxzZSBpZiAoIGEuc291cmNlSW5kZXggJiYgYi5zb3VyY2VJbmRleCApIHsKCQkJcmV0dXJuIGEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4OwoJCX0KCgkJdmFyIGFsLCBibCwKCQkJYXAgPSBbXSwKCQkJYnAgPSBbXSwKCQkJYXVwID0gYS5wYXJlbnROb2RlLAoJCQlidXAgPSBiLnBhcmVudE5vZGUsCgkJCWN1ciA9IGF1cDsKCgkJLy8gSWYgdGhlIG5vZGVzIGFyZSBzaWJsaW5ncyAob3IgaWRlbnRpY2FsKSB3ZSBjYW4gZG8gYSBxdWljayBjaGVjawoJCWlmICggYXVwID09PSBidXAgKSB7CgkJCXJldHVybiBzaWJsaW5nQ2hlY2soIGEsIGIgKTsKCgkJLy8gSWYgbm8gcGFyZW50cyB3ZXJlIGZvdW5kIHRoZW4gdGhlIG5vZGVzIGFyZSBkaXNjb25uZWN0ZWQKCQl9IGVsc2UgaWYgKCAhYXVwICkgewoJCQlyZXR1cm4gLTE7CgoJCX0gZWxzZSBpZiAoICFidXAgKSB7CgkJCXJldHVybiAxOwoJCX0KCgkJLy8gT3RoZXJ3aXNlIHRoZXkncmUgc29tZXdoZXJlIGVsc2UgaW4gdGhlIHRyZWUgc28gd2UgbmVlZAoJCS8vIHRvIGJ1aWxkIHVwIGEgZnVsbCBsaXN0IG9mIHRoZSBwYXJlbnROb2RlcyBmb3IgY29tcGFyaXNvbgoJCXdoaWxlICggY3VyICkgewoJCQlhcC51bnNoaWZ0KCBjdXIgKTsKCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJfQoKCQljdXIgPSBidXA7CgoJCXdoaWxlICggY3VyICkgewoJCQlicC51bnNoaWZ0KCBjdXIgKTsKCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJfQoKCQlhbCA9IGFwLmxlbmd0aDsKCQlibCA9IGJwLmxlbmd0aDsKCgkJLy8gU3RhcnQgd2Fsa2luZyBkb3duIHRoZSB0cmVlIGxvb2tpbmcgZm9yIGEgZGlzY3JlcGFuY3kKCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBhbCAmJiBpIDwgYmw7IGkrKyApIHsKCQkJaWYgKCBhcFtpXSAhPT0gYnBbaV0gKSB7CgkJCQlyZXR1cm4gc2libGluZ0NoZWNrKCBhcFtpXSwgYnBbaV0gKTsKCQkJfQoJCX0KCgkJLy8gV2UgZW5kZWQgc29tZXBsYWNlIHVwIHRoZSB0cmVlIHNvIGRvIGEgc2libGluZyBjaGVjawoJCXJldHVybiBpID09PSBhbCA/CgkJCXNpYmxpbmdDaGVjayggYSwgYnBbaV0sIC0xICkgOgoJCQlzaWJsaW5nQ2hlY2soIGFwW2ldLCBiLCAxICk7Cgl9OwoKCXNpYmxpbmdDaGVjayA9IGZ1bmN0aW9uKCBhLCBiLCByZXQgKSB7CgkJaWYgKCBhID09PSBiICkgewoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJdmFyIGN1ciA9IGEubmV4dFNpYmxpbmc7CgoJCXdoaWxlICggY3VyICkgewoJCQlpZiAoIGN1ciA9PT0gYiApIHsKCQkJCXJldHVybiAtMTsKCQkJfQoKCQkJY3VyID0gY3VyLm5leHRTaWJsaW5nOwoJCX0KCgkJcmV0dXJuIDE7Cgl9Owp9CgovLyBEb2N1bWVudCBzb3J0aW5nIGFuZCByZW1vdmluZyBkdXBsaWNhdGVzClNpenpsZS51bmlxdWVTb3J0ID0gZnVuY3Rpb24oIHJlc3VsdHMgKSB7Cgl2YXIgZWxlbSwKCQlpID0gMTsKCglpZiAoIHNvcnRPcmRlciApIHsKCQloYXNEdXBsaWNhdGUgPSBiYXNlSGFzRHVwbGljYXRlOwoJCXJlc3VsdHMuc29ydCggc29ydE9yZGVyICk7CgoJCWlmICggaGFzRHVwbGljYXRlICkgewoJCQlmb3IgKCA7IChlbGVtID0gcmVzdWx0c1tpXSk7IGkrKyApIHsKCQkJCWlmICggZWxlbSA9PT0gcmVzdWx0c1sgaSAtIDEgXSApIHsKCQkJCQlyZXN1bHRzLnNwbGljZSggaS0tLCAxICk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIHJlc3VsdHM7Cn07CgpmdW5jdGlvbiBtdWx0aXBsZUNvbnRleHRzKCBzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMsIHNlZWQgKSB7Cgl2YXIgaSA9IDAsCgkJbGVuID0gY29udGV4dHMubGVuZ3RoOwoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJU2l6emxlKCBzZWxlY3RvciwgY29udGV4dHNbaV0sIHJlc3VsdHMsIHNlZWQgKTsKCX0KfQoKZnVuY3Rpb24gaGFuZGxlUE9TR3JvdXAoIHNlbGVjdG9yLCBwb3NmaWx0ZXIsIGFyZ3VtZW50LCBjb250ZXh0cywgc2VlZCwgbm90ICkgewoJdmFyIHJlc3VsdHMsCgkJZm4gPSBFeHByLnNldEZpbHRlcnNbIHBvc2ZpbHRlci50b0xvd2VyQ2FzZSgpIF07CgoJaWYgKCAhZm4gKSB7CgkJU2l6emxlLmVycm9yKCBwb3NmaWx0ZXIgKTsKCX0KCglpZiAoIHNlbGVjdG9yIHx8ICEocmVzdWx0cyA9IHNlZWQpICkgewoJCW11bHRpcGxlQ29udGV4dHMoIHNlbGVjdG9yIHx8ICIqIiwgY29udGV4dHMsIChyZXN1bHRzID0gW10pLCBzZWVkICk7Cgl9CgoJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID4gMCA/IGZuKCByZXN1bHRzLCBhcmd1bWVudCwgbm90ICkgOiBbXTsKfQoKZnVuY3Rpb24gaGFuZGxlUE9TKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCwgZ3JvdXBzICkgewoJdmFyIG1hdGNoLCBub3QsIGFuY2hvciwgcmV0LCBlbGVtZW50cywgY3VycmVudENvbnRleHRzLCBwYXJ0LCBsYXN0SW5kZXgsCgkJaSA9IDAsCgkJbGVuID0gZ3JvdXBzLmxlbmd0aCwKCQlycG9zID0gbWF0Y2hFeHByWyJQT1MiXSwKCQkvLyBUaGlzIGlzIGdlbmVyYXRlZCBoZXJlIGluIGNhc2UgbWF0Y2hFeHByWyJQT1MiXSBpcyBleHRlbmRlZAoJCXJwb3Nncm91cHMgPSBuZXcgUmVnRXhwKCAiXiIgKyBycG9zLnNvdXJjZSArICIoPyEiICsgd2hpdGVzcGFjZSArICIpIiwgImkiICksCgkJLy8gVGhpcyBpcyBmb3IgbWFraW5nIHN1cmUgbm9uLXBhcnRpY2lwYXRpbmcKCQkvLyBtYXRjaGluZyBncm91cHMgYXJlIHJlcHJlc2VudGVkIGNyb3NzLWJyb3dzZXIgKElFNi04KQoJCXNldFVuZGVmaW5lZCA9IGZ1bmN0aW9uKCkgewoJCQl2YXIgaSA9IDEsCgkJCQlsZW4gPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKCQkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCQlpZiAoIGFyZ3VtZW50c1tpXSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW1hdGNoW2ldID0gdW5kZWZpbmVkOwoJCQkJfQoJCQl9CgkJfTsKCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkvLyBSZXNldCByZWdleCBpbmRleCB0byAwCgkJcnBvcy5leGVjKCIiKTsKCQlzZWxlY3RvciA9IGdyb3Vwc1tpXTsKCQlyZXQgPSBbXTsKCQlhbmNob3IgPSAwOwoJCWVsZW1lbnRzID0gc2VlZDsKCQl3aGlsZSAoIChtYXRjaCA9IHJwb3MuZXhlYyggc2VsZWN0b3IgKSkgKSB7CgkJCWxhc3RJbmRleCA9IHJwb3MubGFzdEluZGV4ID0gbWF0Y2guaW5kZXggKyBtYXRjaFswXS5sZW5ndGg7CgkJCWlmICggbGFzdEluZGV4ID4gYW5jaG9yICkgewoJCQkJcGFydCA9IHNlbGVjdG9yLnNsaWNlKCBhbmNob3IsIG1hdGNoLmluZGV4ICk7CgkJCQlhbmNob3IgPSBsYXN0SW5kZXg7CgkJCQljdXJyZW50Q29udGV4dHMgPSBbIGNvbnRleHQgXTsKCgkJCQlpZiAoIHJjb21iaW5hdG9ycy50ZXN0KHBhcnQpICkgewoJCQkJCWlmICggZWxlbWVudHMgKSB7CgkJCQkJCWN1cnJlbnRDb250ZXh0cyA9IGVsZW1lbnRzOwoJCQkJCX0KCQkJCQllbGVtZW50cyA9IHNlZWQ7CgkJCQl9CgoJCQkJaWYgKCAobm90ID0gcmVuZHNXaXRoTm90LnRlc3QoIHBhcnQgKSkgKSB7CgkJCQkJcGFydCA9IHBhcnQuc2xpY2UoIDAsIC01ICkucmVwbGFjZSggcmNvbWJpbmF0b3JzLCAiJCYqIiApOwoJCQkJfQoKCQkJCWlmICggbWF0Y2gubGVuZ3RoID4gMSApIHsKCQkJCQltYXRjaFswXS5yZXBsYWNlKCBycG9zZ3JvdXBzLCBzZXRVbmRlZmluZWQgKTsKCQkJCX0KCQkJCWVsZW1lbnRzID0gaGFuZGxlUE9TR3JvdXAoIHBhcnQsIG1hdGNoWzFdLCBtYXRjaFsyXSwgY3VycmVudENvbnRleHRzLCBlbGVtZW50cywgbm90ICk7CgkJCX0KCQl9CgoJCWlmICggZWxlbWVudHMgKSB7CgkJCXJldCA9IHJldC5jb25jYXQoIGVsZW1lbnRzICk7CgoJCQlpZiAoIChwYXJ0ID0gc2VsZWN0b3Iuc2xpY2UoIGFuY2hvciApKSAmJiBwYXJ0ICE9PSAiKSIgKSB7CgkJCQltdWx0aXBsZUNvbnRleHRzKCBwYXJ0LCByZXQsIHJlc3VsdHMsIHNlZWQgKTsKCQkJfSBlbHNlIHsKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHJldCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJU2l6emxlKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApOwoJCX0KCX0KCgkvLyBEbyBub3Qgc29ydCBpZiB0aGlzIGlzIGEgc2luZ2xlIGZpbHRlcgoJcmV0dXJuIGxlbiA9PT0gMSA/IHJlc3VsdHMgOiBTaXp6bGUudW5pcXVlU29ydCggcmVzdWx0cyApOwp9CgpmdW5jdGlvbiB0b2tlbml6ZSggc2VsZWN0b3IsIGNvbnRleHQsIHhtbCApIHsKCXZhciB0b2tlbnMsIHNvRmFyLCB0eXBlLAoJCWdyb3VwcyA9IFtdLAoJCWkgPSAwLAoKCQkvLyBDYXRjaCBvYnZpb3VzIHNlbGVjdG9yIGlzc3VlczogdGVybWluYWwgIikiOyBub25lbXB0eSBmYWxsYmFjayBtYXRjaAoJCS8vIHJzZWxlY3RvciBuZXZlciBmYWlscyB0byBtYXRjaCAqc29tZXRoaW5nKgoJCW1hdGNoID0gcnNlbGVjdG9yLmV4ZWMoIHNlbGVjdG9yICksCgkJbWF0Y2hlZCA9ICFtYXRjaC5wb3AoKSAmJiAhbWF0Y2gucG9wKCksCgkJc2VsZWN0b3JHcm91cHMgPSBtYXRjaGVkICYmIHNlbGVjdG9yLm1hdGNoKCByZ3JvdXBzICkgfHwgWyIiXSwKCgkJcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyLAoJCWZpbHRlcnMgPSBFeHByLmZpbHRlciwKCQljaGVja0NvbnRleHQgPSAheG1sICYmIGNvbnRleHQgIT09IGRvY3VtZW50OwoKCWZvciAoIDsgKHNvRmFyID0gc2VsZWN0b3JHcm91cHNbaV0pICE9IG51bGwgJiYgbWF0Y2hlZDsgaSsrICkgewoJCWdyb3Vwcy5wdXNoKCB0b2tlbnMgPSBbXSApOwoKCQkvLyBOZWVkIHRvIG1ha2Ugc3VyZSB3ZSdyZSB3aXRoaW4gYSBuYXJyb3dlciBjb250ZXh0IGlmIG5lY2Vzc2FyeQoJCS8vIEFkZGluZyBhIGRlc2NlbmRhbnQgY29tYmluYXRvciB3aWxsIGdlbmVyYXRlIHdoYXQgaXMgbmVlZGVkCgkJaWYgKCBjaGVja0NvbnRleHQgKSB7CgkJCXNvRmFyID0gIiAiICsgc29GYXI7CgkJfQoKCQl3aGlsZSAoIHNvRmFyICkgewoJCQltYXRjaGVkID0gZmFsc2U7CgoJCQkvLyBDb21iaW5hdG9ycwoJCQlpZiAoIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApKSApIHsKCQkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoWzBdLmxlbmd0aCApOwoKCQkJCS8vIENhc3QgZGVzY2VuZGFudCBjb21iaW5hdG9ycyB0byBzcGFjZQoJCQkJbWF0Y2hlZCA9IHRva2Vucy5wdXNoKHsgcGFydDogbWF0Y2gucG9wKCkucmVwbGFjZSggcnRyaW0sICIgIiApLCBjYXB0dXJlczogbWF0Y2ggfSk7CgkJCX0KCgkJCS8vIEZpbHRlcnMKCQkJZm9yICggdHlwZSBpbiBmaWx0ZXJzICkgewoJCQkJaWYgKCAobWF0Y2ggPSBtYXRjaEV4cHJbIHR5cGUgXS5leGVjKCBzb0ZhciApKSAmJiAoIXByZUZpbHRlcnNbIHR5cGUgXSB8fAoJCQkJCShtYXRjaCA9IHByZUZpbHRlcnNbIHR5cGUgXSggbWF0Y2gsIGNvbnRleHQsIHhtbCApKSApICkgewoKCQkJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaC5zaGlmdCgpLmxlbmd0aCApOwoJCQkJCW1hdGNoZWQgPSB0b2tlbnMucHVzaCh7IHBhcnQ6IHR5cGUsIGNhcHR1cmVzOiBtYXRjaCB9KTsKCQkJCX0KCQkJfQoKCQkJaWYgKCAhbWF0Y2hlZCApIHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQoKCWlmICggIW1hdGNoZWQgKSB7CgkJU2l6emxlLmVycm9yKCBzZWxlY3RvciApOwoJfQoKCXJldHVybiBncm91cHM7Cn0KCmZ1bmN0aW9uIGFkZENvbWJpbmF0b3IoIG1hdGNoZXIsIGNvbWJpbmF0b3IsIGNvbnRleHQgKSB7Cgl2YXIgZGlyID0gY29tYmluYXRvci5kaXIsCgkJZG9uZU5hbWUgPSBkb25lKys7CgoJaWYgKCAhbWF0Y2hlciApIHsKCQkvLyBJZiB0aGVyZSBpcyBubyBtYXRjaGVyIHRvIGNoZWNrLCBjaGVjayBhZ2FpbnN0IHRoZSBjb250ZXh0CgkJbWF0Y2hlciA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gY29udGV4dDsKCQl9OwoJfQoJcmV0dXJuIGNvbWJpbmF0b3IuZmlyc3QgPwoJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0ICkgewoJCQl3aGlsZSAoIChlbGVtID0gZWxlbVsgZGlyIF0pICkgewoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCXJldHVybiBtYXRjaGVyKCBlbGVtLCBjb250ZXh0ICkgJiYgZWxlbTsKCQkJCX0KCQkJfQoJCX0gOgoJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0ICkgewoJCQl2YXIgY2FjaGUsCgkJCQlkaXJrZXkgPSBkb25lTmFtZSArICIuIiArIGRpcnJ1bnMsCgkJCQljYWNoZWRrZXkgPSBkaXJrZXkgKyAiLiIgKyBjYWNoZWRydW5zOwoJCQl3aGlsZSAoIChlbGVtID0gZWxlbVsgZGlyIF0pICkgewoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCWlmICggKGNhY2hlID0gZWxlbVsgZXhwYW5kbyBdKSA9PT0gY2FjaGVka2V5ICkgewoJCQkJCQlyZXR1cm4gZWxlbS5zaXpzZXQ7CgkJCQkJfSBlbHNlIGlmICggdHlwZW9mIGNhY2hlID09PSAic3RyaW5nIiAmJiBjYWNoZS5pbmRleE9mKGRpcmtleSkgPT09IDAgKSB7CgkJCQkJCWlmICggZWxlbS5zaXpzZXQgKSB7CgkJCQkJCQlyZXR1cm4gZWxlbTsKCQkJCQkJfQoJCQkJCX0gZWxzZSB7CgkJCQkJCWVsZW1bIGV4cGFuZG8gXSA9IGNhY2hlZGtleTsKCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0ICkgKSB7CgkJCQkJCQllbGVtLnNpenNldCA9IHRydWU7CgkJCQkJCQlyZXR1cm4gZWxlbTsKCQkJCQkJfQoJCQkJCQllbGVtLnNpenNldCA9IGZhbHNlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX07Cn0KCmZ1bmN0aW9uIGFkZE1hdGNoZXIoIGhpZ2hlciwgZGVlcGVyICkgewoJcmV0dXJuIGhpZ2hlciA/CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQgKSB7CgkJCXZhciByZXN1bHQgPSBkZWVwZXIoIGVsZW0sIGNvbnRleHQgKTsKCQkJcmV0dXJuIHJlc3VsdCAmJiBoaWdoZXIoIHJlc3VsdCA9PT0gdHJ1ZSA/IGVsZW0gOiByZXN1bHQsIGNvbnRleHQgKTsKCQl9IDoKCQlkZWVwZXI7Cn0KCi8vIFsiVEFHIiwgIj4iLCAiSUQiLCAiICIsICJDTEFTUyJdCmZ1bmN0aW9uIG1hdGNoZXJGcm9tVG9rZW5zKCB0b2tlbnMsIGNvbnRleHQsIHhtbCApIHsKCXZhciB0b2tlbiwgbWF0Y2hlciwKCQlpID0gMDsKCglmb3IgKCA7ICh0b2tlbiA9IHRva2Vuc1tpXSk7IGkrKyApIHsKCQlpZiAoIEV4cHIucmVsYXRpdmVbIHRva2VuLnBhcnQgXSApIHsKCQkJbWF0Y2hlciA9IGFkZENvbWJpbmF0b3IoIG1hdGNoZXIsIEV4cHIucmVsYXRpdmVbIHRva2VuLnBhcnQgXSwgY29udGV4dCApOwoJCX0gZWxzZSB7CgkJCXRva2VuLmNhcHR1cmVzLnB1c2goIGNvbnRleHQsIHhtbCApOwoJCQltYXRjaGVyID0gYWRkTWF0Y2hlciggbWF0Y2hlciwgRXhwci5maWx0ZXJbIHRva2VuLnBhcnQgXS5hcHBseSggbnVsbCwgdG9rZW4uY2FwdHVyZXMgKSApOwoJCX0KCX0KCglyZXR1cm4gbWF0Y2hlcjsKfQoKZnVuY3Rpb24gbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBtYXRjaGVycyApIHsKCXJldHVybiBmdW5jdGlvbiggZWxlbSwgY29udGV4dCApIHsKCQl2YXIgbWF0Y2hlciwKCQkJaiA9IDA7CgkJZm9yICggOyAobWF0Y2hlciA9IG1hdGNoZXJzW2pdKTsgaisrICkgewoJCQlpZiAoIG1hdGNoZXIoZWxlbSwgY29udGV4dCkgKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9Owp9Cgp2YXIgY29tcGlsZSA9IFNpenpsZS5jb21waWxlID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCB4bWwgKSB7Cgl2YXIgdG9rZW5zLCBncm91cCwgaSwKCQljYWNoZWQgPSBjb21waWxlckNhY2hlWyBzZWxlY3RvciBdOwoKCS8vIFJldHVybiBhIGNhY2hlZCBncm91cCBmdW5jdGlvbiBpZiBhbHJlYWR5IGdlbmVyYXRlZCAoY29udGV4dCBkZXBlbmRlbnQpCglpZiAoIGNhY2hlZCAmJiBjYWNoZWQuY29udGV4dCA9PT0gY29udGV4dCApIHsKCQlyZXR1cm4gY2FjaGVkOwoJfQoKCS8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAoJZ3JvdXAgPSB0b2tlbml6ZSggc2VsZWN0b3IsIGNvbnRleHQsIHhtbCApOwoJZm9yICggaSA9IDA7ICh0b2tlbnMgPSBncm91cFtpXSk7IGkrKyApIHsKCQlncm91cFtpXSA9IG1hdGNoZXJGcm9tVG9rZW5zKCB0b2tlbnMsIGNvbnRleHQsIHhtbCApOwoJfQoKCS8vIENhY2hlIHRoZSBjb21waWxlZCBmdW5jdGlvbgoJY2FjaGVkID0gY29tcGlsZXJDYWNoZVsgc2VsZWN0b3IgXSA9IG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyggZ3JvdXAgKTsKCWNhY2hlZC5jb250ZXh0ID0gY29udGV4dDsKCWNhY2hlZC5ydW5zID0gY2FjaGVkLmRpcnJ1bnMgPSAwOwoJY2FjaGVkU2VsZWN0b3JzLnB1c2goIHNlbGVjdG9yICk7CgkvLyBFbnN1cmUgb25seSB0aGUgbW9zdCByZWNlbnQgYXJlIGNhY2hlZAoJaWYgKCBjYWNoZWRTZWxlY3RvcnMubGVuZ3RoID4gRXhwci5jYWNoZUxlbmd0aCApIHsKCQlkZWxldGUgY29tcGlsZXJDYWNoZVsgY2FjaGVkU2VsZWN0b3JzLnNoaWZ0KCkgXTsKCX0KCXJldHVybiBjYWNoZWQ7Cn07CgpTaXp6bGUubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBlbGVtZW50cyApIHsKCXJldHVybiBTaXp6bGUoIGV4cHIsIG51bGwsIG51bGwsIGVsZW1lbnRzICk7Cn07CgpTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIGVsZW0sIGV4cHIgKSB7CglyZXR1cm4gU2l6emxlKCBleHByLCBudWxsLCBudWxsLCBbIGVsZW0gXSApLmxlbmd0aCA+IDA7Cn07Cgp2YXIgc2VsZWN0ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkLCB4bWwgKSB7CgkvLyBSZW1vdmUgZXhjZXNzaXZlIHdoaXRlc3BhY2UKCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSggcnRyaW0sICIkMSIgKTsKCXZhciBlbGVtZW50cywgbWF0Y2hlciwgaSwgbGVuLCBlbGVtLCB0b2tlbiwKCQl0eXBlLCBmaW5kQ29udGV4dCwgbm90VG9rZW5zLAoJCW1hdGNoID0gc2VsZWN0b3IubWF0Y2goIHJncm91cHMgKSwKCQl0b2tlbnMgPSBzZWxlY3Rvci5tYXRjaCggcnRva2VucyApLAoJCWNvbnRleHROb2RlVHlwZSA9IGNvbnRleHQubm9kZVR5cGU7CgoJLy8gUE9TIGhhbmRsaW5nCglpZiAoIG1hdGNoRXhwclsiUE9TIl0udGVzdChzZWxlY3RvcikgKSB7CgkJcmV0dXJuIGhhbmRsZVBPUyggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQsIG1hdGNoICk7Cgl9CgoJaWYgKCBzZWVkICkgewoJCWVsZW1lbnRzID0gc2xpY2UuY2FsbCggc2VlZCwgMCApOwoKCS8vIFRvIG1haW50YWluIGRvY3VtZW50IG9yZGVyLCBvbmx5IG5hcnJvdyB0aGUKCS8vIHNldCBpZiB0aGVyZSBpcyBvbmUgZ3JvdXAKCX0gZWxzZSBpZiAoIG1hdGNoICYmIG1hdGNoLmxlbmd0aCA9PT0gMSApIHsKCgkJLy8gVGFrZSBhIHNob3J0Y3V0IGFuZCBzZXQgdGhlIGNvbnRleHQgaWYgdGhlIHJvb3Qgc2VsZWN0b3IgaXMgYW4gSUQKCQlpZiAoIHRva2Vucy5sZW5ndGggPiAxICYmIGNvbnRleHROb2RlVHlwZSA9PT0gOSAmJiAheG1sICYmCgkJCQkobWF0Y2ggPSBtYXRjaEV4cHJbIklEIl0uZXhlYyggdG9rZW5zWzBdICkpICkgewoKCQkJY29udGV4dCA9IEV4cHIuZmluZFsiSUQiXSggbWF0Y2hbMV0sIGNvbnRleHQsIHhtbCApWzBdOwoJCQlpZiAoICFjb250ZXh0ICkgewoJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCX0KCgkJCXNlbGVjdG9yID0gc2VsZWN0b3Iuc2xpY2UoIHRva2Vucy5zaGlmdCgpLmxlbmd0aCApOwoJCX0KCgkJZmluZENvbnRleHQgPSAoIChtYXRjaCA9IHJzaWJsaW5nLmV4ZWMoIHRva2Vuc1swXSApKSAmJiAhbWF0Y2guaW5kZXggJiYgY29udGV4dC5wYXJlbnROb2RlICkgfHwgY29udGV4dDsKCgkJLy8gR2V0IHRoZSBsYXN0IHRva2VuLCBleGNsdWRpbmcgOm5vdAoJCW5vdFRva2VucyA9IHRva2Vucy5wb3AoKTsKCQl0b2tlbiA9IG5vdFRva2Vucy5zcGxpdCgiOm5vdCIpWzBdOwoKCQlmb3IgKCBpID0gMCwgbGVuID0gRXhwci5vcmRlci5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKCQkJdHlwZSA9IEV4cHIub3JkZXJbaV07CgoJCQlpZiAoIChtYXRjaCA9IG1hdGNoRXhwclsgdHlwZSBdLmV4ZWMoIHRva2VuICkpICkgewoJCQkJZWxlbWVudHMgPSBFeHByLmZpbmRbIHR5cGUgXSggKG1hdGNoWzFdIHx8ICIiKS5yZXBsYWNlKCByYmFja3NsYXNoLCAiIiApLCBmaW5kQ29udGV4dCwgeG1sICk7CgoJCQkJaWYgKCBlbGVtZW50cyA9PSBudWxsICkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCWlmICggdG9rZW4gPT09IG5vdFRva2VucyApIHsKCQkJCQlzZWxlY3RvciA9IHNlbGVjdG9yLnNsaWNlKCAwLCBzZWxlY3Rvci5sZW5ndGggLSBub3RUb2tlbnMubGVuZ3RoICkgKwoJCQkJCQl0b2tlbi5yZXBsYWNlKCBtYXRjaEV4cHJbIHR5cGUgXSwgIiIgKTsKCgkJCQkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoZWxlbWVudHMsIDApICk7CgkJCQkJfQoJCQkJfQoJCQkJYnJlYWs7CgkJCX0KCQl9Cgl9CgoJLy8gT25seSBsb29wIG92ZXIgdGhlIGdpdmVuIGVsZW1lbnRzIG9uY2UKCS8vIElmIHNlbGVjdG9yIGlzIGVtcHR5LCB3ZSdyZSBhbHJlYWR5IGRvbmUKCWlmICggc2VsZWN0b3IgKSB7CgkJbWF0Y2hlciA9IGNvbXBpbGUoIHNlbGVjdG9yLCBjb250ZXh0LCB4bWwgKTsKCQlkaXJydW5zID0gbWF0Y2hlci5kaXJydW5zKys7CgoJCWlmICggZWxlbWVudHMgPT0gbnVsbCApIHsKCQkJZWxlbWVudHMgPSBFeHByLmZpbmRbIlRBRyJdKCAiKiIsIChyc2libGluZy50ZXN0KCBzZWxlY3RvciApICYmIGNvbnRleHQucGFyZW50Tm9kZSkgfHwgY29udGV4dCApOwoJCX0KCQlmb3IgKCBpID0gMDsgKGVsZW0gPSBlbGVtZW50c1tpXSk7IGkrKyApIHsKCQkJY2FjaGVkcnVucyA9IG1hdGNoZXIucnVucysrOwoJCQlpZiAoIG1hdGNoZXIoZWxlbSwgY29udGV4dCkgKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZW0gKTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gcmVzdWx0czsKfTsKCmlmICggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCApIHsKCShmdW5jdGlvbigpIHsKCQl2YXIgZGlzY29ubmVjdGVkTWF0Y2gsCgkJCW9sZFNlbGVjdCA9IHNlbGVjdCwKCQkJcmVzY2FwZSA9IC8nfFxcL2csCgkJCXJhdHRyaWJ1dGVRdW90ZXMgPSAvXD1bXHgyMFx0XHJcblxmXSooW14nIlxdXSopW1x4MjBcdFxyXG5cZl0qXF0vZywKCQkJcmJ1Z2d5UVNBID0gW10sCgkJCS8vIG1hdGNoZXNTZWxlY3Rvcig6YWN0aXZlKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoSUU5L09wZXJhIDExLjUpCgkJCS8vIEEgc3VwcG9ydCB0ZXN0IHdvdWxkIHJlcXVpcmUgdG9vIG11Y2ggY29kZSAod291bGQgaW5jbHVkZSBkb2N1bWVudCByZWFkeSkKCQkJLy8ganVzdCBza2lwIG1hdGNoZXNTZWxlY3RvciBmb3IgOmFjdGl2ZQoJCQlyYnVnZ3lNYXRjaGVzID0gWyI6YWN0aXZlIl0sCgkJCW1hdGNoZXMgPSBkb2NFbGVtLm1hdGNoZXNTZWxlY3RvciB8fAoJCQkJZG9jRWxlbS5tb3pNYXRjaGVzU2VsZWN0b3IgfHwKCQkJCWRvY0VsZW0ud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8CgkJCQlkb2NFbGVtLm9NYXRjaGVzU2VsZWN0b3IgfHwKCQkJCWRvY0VsZW0ubXNNYXRjaGVzU2VsZWN0b3I7CgoJCS8vIEJ1aWxkIFFTQSByZWdleAoJCS8vIFJlZ2V4IHN0cmF0ZWd5IGFkb3B0ZWQgZnJvbSBEaWVnbyBQZXJpbmkKCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQkJZGl2LmlubmVySFRNTCA9ICI8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ+PC9vcHRpb24+PC9zZWxlY3Q+IjsKCgkJCS8vIElFOCAtIFNvbWUgYm9vbGVhbiBhdHRyaWJ1dGVzIGFyZSBub3QgdHJlYXRlZCBjb3JyZWN0bHkKCQkJaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIltzZWxlY3RlZF0iKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooPzpjaGVja2VkfGRpc2FibGVkfGlzbWFwfG11bHRpcGxlfHJlYWRvbmx5fHNlbGVjdGVkfHZhbHVlKSIgKTsKCQkJfQoKCQkJLy8gV2Via2l0L09wZXJhIC0gOmNoZWNrZWQgc2hvdWxkIHJldHVybiBzZWxlY3RlZCBvcHRpb24gZWxlbWVudHMKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKCQkJLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIChkbyBub3QgcHV0IHRlc3RzIGFmdGVyIHRoaXMgb25lKQoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiOmNoZWNrZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCgiOmNoZWNrZWQiKTsKCQkJfQoJCX0pOwoKCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCgkJCS8vIE9wZXJhIDEwLTEyL0lFOSAtIF49ICQ9ICo9IGFuZCBlbXB0eSB2YWx1ZXMKCQkJLy8gU2hvdWxkIG5vdCBzZWxlY3QgYW55dGhpbmcKCQkJZGl2LmlubmVySFRNTCA9ICI8cCB0ZXN0PScnPjwvcD4iOwoJCQlpZiAoIGRpdi5xdWVyeVNlbGVjdG9yQWxsKCJbdGVzdF49JyddIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJbKl4kXT0iICsgd2hpdGVzcGFjZSArICIqKD86XCJcInwnJykiICk7CgkJCX0KCgkJCS8vIEZGIDMuNSAtIDplbmFibGVkLzpkaXNhYmxlZCBhbmQgaGlkZGVuIGVsZW1lbnRzIChoaWRkZW4gZWxlbWVudHMgYXJlIHN0aWxsIGVuYWJsZWQpCgkJCS8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSAoZG8gbm90IHB1dCB0ZXN0cyBhZnRlciB0aGlzIG9uZSkKCQkJZGl2LmlubmVySFRNTCA9ICI8aW5wdXQgdHlwZT0naGlkZGVuJz4iOwoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiOmVuYWJsZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCgiOmVuYWJsZWQiLCAiOmRpc2FibGVkIik7CgkJCX0KCQl9KTsKCgkJcmJ1Z2d5UVNBID0gcmJ1Z2d5UVNBLmxlbmd0aCAmJiBuZXcgUmVnRXhwKCByYnVnZ3lRU0Euam9pbigifCIpICk7CgoJCXNlbGVjdCA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCwgeG1sICkgewoJCQkvLyBPbmx5IHVzZSBxdWVyeVNlbGVjdG9yQWxsIHdoZW4gbm90IGZpbHRlcmluZywKCQkJLy8gd2hlbiB0aGlzIGlzIG5vdCB4bWwsCgkJCS8vIGFuZCB3aGVuIG5vIFFTQSBidWdzIGFwcGx5CgkJCWlmICggIXNlZWQgJiYgIXhtbCAmJiAoIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3QoIHNlbGVjdG9yICkpICkgewoJCQkJaWYgKCBjb250ZXh0Lm5vZGVUeXBlID09PSA5ICkgewoJCQkJCXRyeSB7CgkJCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKCBzZWxlY3RvciApLCAwKSApOwoJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQl9IGNhdGNoKHFzYUVycm9yKSB7fQoJCQkJLy8gcVNBIHdvcmtzIHN0cmFuZ2VseSBvbiBFbGVtZW50LXJvb3RlZCBxdWVyaWVzCgkJCQkvLyBXZSBjYW4gd29yayBhcm91bmQgdGhpcyBieSBzcGVjaWZ5aW5nIGFuIGV4dHJhIElEIG9uIHRoZSByb290CgkJCQkvLyBhbmQgd29ya2luZyB1cCBmcm9tIHRoZXJlIChUaGFua3MgdG8gQW5kcmV3IER1cG9udCBmb3IgdGhlIHRlY2huaXF1ZSkKCQkJCS8vIElFIDggZG9lc24ndCB3b3JrIG9uIG9iamVjdCBlbGVtZW50cwoJCQkJfSBlbHNlIGlmICggY29udGV4dC5ub2RlVHlwZSA9PT0gMSAmJiBjb250ZXh0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJvYmplY3QiICkgewoJCQkJCXZhciBvbGQgPSBjb250ZXh0LmdldEF0dHJpYnV0ZSgiaWQiKSwKCQkJCQkJbmlkID0gb2xkIHx8IGV4cGFuZG8sCgkJCQkJCW5ld0NvbnRleHQgPSByc2libGluZy50ZXN0KCBzZWxlY3RvciApICYmIGNvbnRleHQucGFyZW50Tm9kZSB8fCBjb250ZXh0OwoKCQkJCQlpZiAoIG9sZCApIHsKCQkJCQkJbmlkID0gbmlkLnJlcGxhY2UoIHJlc2NhcGUsICJcXCQmIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWNvbnRleHQuc2V0QXR0cmlidXRlKCAiaWQiLCBuaWQgKTsKCQkJCQl9CgoJCQkJCXRyeSB7CgkJCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoIG5ld0NvbnRleHQucXVlcnlTZWxlY3RvckFsbCgKCQkJCQkJCXNlbGVjdG9yLnJlcGxhY2UoIHJncm91cHMsICJbaWQ9JyIgKyBuaWQgKyAiJ10gJCYiICkKCQkJCQkJKSwgMCApICk7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0gY2F0Y2gocXNhRXJyb3IpIHsKCQkJCQl9IGZpbmFsbHkgewoJCQkJCQlpZiAoICFvbGQgKSB7CgkJCQkJCQljb250ZXh0LnJlbW92ZUF0dHJpYnV0ZSgiaWQiKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIG9sZFNlbGVjdCggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQsIHhtbCApOwoJCX07CgoJCWlmICggbWF0Y2hlcyApIHsKCQkJYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJCQkvLyBDaGVjayB0byBzZWUgaWYgaXQncyBwb3NzaWJsZSB0byBkbyBtYXRjaGVzU2VsZWN0b3IKCQkJCS8vIG9uIGEgZGlzY29ubmVjdGVkIG5vZGUgKElFIDkpCgkJCQlkaXNjb25uZWN0ZWRNYXRjaCA9IG1hdGNoZXMuY2FsbCggZGl2LCAiZGl2IiApOwoKCQkJCS8vIFRoaXMgc2hvdWxkIGZhaWwgd2l0aCBhbiBleGNlcHRpb24KCQkJCS8vIEdlY2tvIGRvZXMgbm90IGVycm9yLCByZXR1cm5zIGZhbHNlIGluc3RlYWQKCQkJCXRyeSB7CgkJCQkJbWF0Y2hlcy5jYWxsKCBkaXYsICJbdGVzdCE9JyddOnNpenpsZSIgKTsKCQkJCQlyYnVnZ3lNYXRjaGVzLnB1c2goIEV4cHIubWF0Y2guUFNFVURPICk7CgkJCQl9IGNhdGNoICggZSApIHt9CgkJCX0pOwoKCQkJLy8gcmJ1Z2d5TWF0Y2hlcyBhbHdheXMgY29udGFpbnMgOmFjdGl2ZSwgc28gbm8gbmVlZCBmb3IgYSBsZW5ndGggY2hlY2sKCQkJcmJ1Z2d5TWF0Y2hlcyA9IC8qIHJidWdneU1hdGNoZXMubGVuZ3RoICYmICovIG5ldyBSZWdFeHAoIHJidWdneU1hdGNoZXMuam9pbigifCIpICk7CgoJCQlTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIGVsZW0sIGV4cHIgKSB7CgkJCQkvLyBNYWtlIHN1cmUgdGhhdCBhdHRyaWJ1dGUgc2VsZWN0b3JzIGFyZSBxdW90ZWQKCQkJCWV4cHIgPSBleHByLnJlcGxhY2UoIHJhdHRyaWJ1dGVRdW90ZXMsICI9JyQxJ10iICk7CgoJCQkJLy8gcmJ1Z2d5TWF0Y2hlcyBhbHdheXMgY29udGFpbnMgOmFjdGl2ZSwgc28gbm8gbmVlZCBmb3IgYW4gZXhpc3RlbmNlIGNoZWNrCgkJCQlpZiAoICFpc1hNTCggZWxlbSApICYmICFyYnVnZ3lNYXRjaGVzLnRlc3QoIGV4cHIgKSAmJiAoIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3QoIGV4cHIgKSkgKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIHJldCA9IG1hdGNoZXMuY2FsbCggZWxlbSwgZXhwciApOwoKCQkJCQkJLy8gSUUgOSdzIG1hdGNoZXNTZWxlY3RvciByZXR1cm5zIGZhbHNlIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwoJCQkJCQlpZiAoIHJldCB8fCBkaXNjb25uZWN0ZWRNYXRjaCB8fAoJCQkJCQkJCS8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50CgkJCQkJCQkJLy8gZnJhZ21lbnQgaW4gSUUgOQoJCQkJCQkJCWVsZW0uZG9jdW1lbnQgJiYgZWxlbS5kb2N1bWVudC5ub2RlVHlwZSAhPT0gMTEgKSB7CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9CgkJCQkJfSBjYXRjaChlKSB7fQoJCQkJfQoKCQkJCXJldHVybiBTaXp6bGUoIGV4cHIsIG51bGwsIG51bGwsIFsgZWxlbSBdICkubGVuZ3RoID4gMDsKCQkJfTsKCQl9Cgl9KSgpOwp9CgovLyBPdmVycmlkZSBzaXp6bGUgYXR0cmlidXRlIHJldHJpZXZhbApTaXp6bGUuYXR0ciA9IGpRdWVyeS5hdHRyOwpqUXVlcnkuZmluZCA9IFNpenpsZTsKalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwpqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIucHNldWRvczsKalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwpqUXVlcnkudGV4dCA9IFNpenpsZS5nZXRUZXh0OwpqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CmpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKCgp9KSggd2luZG93ICk7CnZhciBydW50aWwgPSAvVW50aWwkLywKCXJwYXJlbnRzcHJldiA9IC9eKD86cGFyZW50c3xwcmV2KD86VW50aWx8QWxsKSkvLAoJaXNTaW1wbGUgPSAvXi5bXjojXFtcLixdKiQvLAoJcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dCwKCS8vIG1ldGhvZHMgZ3VhcmFudGVlZCB0byBwcm9kdWNlIGEgdW5pcXVlIHNldCB3aGVuIHN0YXJ0aW5nIGZyb20gYSB1bmlxdWUgc2V0CglndWFyYW50ZWVkVW5pcXVlID0gewoJCWNoaWxkcmVuOiB0cnVlLAoJCWNvbnRlbnRzOiB0cnVlLAoJCW5leHQ6IHRydWUsCgkJcHJldjogdHJ1ZQoJfTsKCmpRdWVyeS5mbi5leHRlbmQoewoJZmluZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBpLCBsLCBsZW5ndGgsIG4sIHIsIHJldCwKCQkJc2VsZiA9IHRoaXM7CgoJCWlmICggdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGpRdWVyeSggc2VsZWN0b3IgKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlmb3IgKCBpID0gMCwgbCA9IHNlbGYubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCWlmICggalF1ZXJ5LmNvbnRhaW5zKCBzZWxmWyBpIF0sIHRoaXMgKSApIHsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldCA9IHRoaXMucHVzaFN0YWNrKCAiIiwgImZpbmQiLCBzZWxlY3RvciApOwoKCQlmb3IgKCBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQlsZW5ndGggPSByZXQubGVuZ3RoOwoJCQlqUXVlcnkuZmluZCggc2VsZWN0b3IsIHRoaXNbaV0sIHJldCApOwoKCQkJaWYgKCBpID4gMCApIHsKCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSByZXN1bHRzIGFyZSB1bmlxdWUKCQkJCWZvciAoIG4gPSBsZW5ndGg7IG4gPCByZXQubGVuZ3RoOyBuKysgKSB7CgkJCQkJZm9yICggciA9IDA7IHIgPCBsZW5ndGg7IHIrKyApIHsKCQkJCQkJaWYgKCByZXRbcl0gPT09IHJldFtuXSApIHsKCQkJCQkJCXJldC5zcGxpY2Uobi0tLCAxKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCgloYXM6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJdmFyIGksCgkJCXRhcmdldHMgPSBqUXVlcnkoIHRhcmdldCwgdGhpcyApLAoJCQlsZW4gPSB0YXJnZXRzLmxlbmd0aDsKCgkJcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQkJaWYgKCBqUXVlcnkuY29udGFpbnMoIHRoaXMsIHRhcmdldHNbaV0gKSApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJfQoJCX0pOwoJfSwKCglub3Q6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciwgZmFsc2UpLCAibm90Iiwgc2VsZWN0b3IpOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciwgdHJ1ZSksICJmaWx0ZXIiLCBzZWxlY3RvciApOwoJfSwKCglpczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiAhIXNlbGVjdG9yICYmICgKCQkJdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiA/CgkJCQkvLyBJZiB0aGlzIGlzIGEgcG9zaXRpb25hbC9yZWxhdGl2ZSBzZWxlY3RvciwgY2hlY2sgbWVtYmVyc2hpcCBpbiB0aGUgcmV0dXJuZWQgc2V0CgkJCQkvLyBzbyAkKCJwOmZpcnN0IikuaXMoInA6bGFzdCIpIHdvbid0IHJldHVybiB0cnVlIGZvciBhIGRvYyB3aXRoIHR3byAicCIuCgkJCQlybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9yICkgPwoJCQkJCWpRdWVyeSggc2VsZWN0b3IsIHRoaXMuY29udGV4dCApLmluZGV4KCB0aGlzWzBdICkgPj0gMCA6CgkJCQkJalF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIHRoaXMgKS5sZW5ndGggPiAwIDoKCQkJCXRoaXMuZmlsdGVyKCBzZWxlY3RvciApLmxlbmd0aCA+IDAgKTsKCX0sCgoJY2xvc2VzdDogZnVuY3Rpb24oIHNlbGVjdG9ycywgY29udGV4dCApIHsKCQl2YXIgY3VyLAoJCQlpID0gMCwKCQkJbCA9IHRoaXMubGVuZ3RoLAoJCQlyZXQgPSBbXSwKCQkJcG9zID0gcm5lZWRzQ29udGV4dC50ZXN0KCBzZWxlY3RvcnMgKSB8fCB0eXBlb2Ygc2VsZWN0b3JzICE9PSAic3RyaW5nIiA/CgkJCQlqUXVlcnkoIHNlbGVjdG9ycywgY29udGV4dCB8fCB0aGlzLmNvbnRleHQgKSA6CgkJCQkwOwoKCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCWN1ciA9IHRoaXNbaV07CgoJCQl3aGlsZSAoIGN1ciAmJiBjdXIub3duZXJEb2N1bWVudCAmJiBjdXIgIT09IGNvbnRleHQgJiYgY3VyLm5vZGVUeXBlICE9PSAxMSApIHsKCQkJCWlmICggcG9zID8gcG9zLmluZGV4KGN1cikgPiAtMSA6IGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihjdXIsIHNlbGVjdG9ycykgKSB7CgkJCQkJcmV0LnB1c2goIGN1ciApOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJCX0KCQl9CgoJCXJldCA9IHJldC5sZW5ndGggPiAxID8galF1ZXJ5LnVuaXF1ZSggcmV0ICkgOiByZXQ7CgoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggcmV0LCAiY2xvc2VzdCIsIHNlbGVjdG9ycyApOwoJfSwKCgkvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluCgkvLyB0aGUgbWF0Y2hlZCBzZXQgb2YgZWxlbWVudHMKCWluZGV4OiBmdW5jdGlvbiggZWxlbSApIHsKCgkJLy8gTm8gYXJndW1lbnQsIHJldHVybiBpbmRleCBpbiBwYXJlbnQKCQlpZiAoICFlbGVtICkgewoJCQlyZXR1cm4gKCB0aGlzWzBdICYmIHRoaXNbMF0ucGFyZW50Tm9kZSApID8gdGhpcy5wcmV2QWxsKCkubGVuZ3RoIDogLTE7CgkJfQoKCQkvLyBpbmRleCBpbiBzZWxlY3RvcgoJCWlmICggdHlwZW9mIGVsZW0gPT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4galF1ZXJ5LmluQXJyYXkoIHRoaXNbMF0sIGpRdWVyeSggZWxlbSApICk7CgkJfQoKCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQlyZXR1cm4galF1ZXJ5LmluQXJyYXkoCgkJCS8vIElmIGl0IHJlY2VpdmVzIGEgalF1ZXJ5IG9iamVjdCwgdGhlIGZpcnN0IGVsZW1lbnQgaXMgdXNlZAoJCQllbGVtLmpxdWVyeSA/IGVsZW1bMF0gOiBlbGVtLCB0aGlzICk7Cgl9LAoKCWFkZDogZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCXZhciBzZXQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciID8KCQkJCWpRdWVyeSggc2VsZWN0b3IsIGNvbnRleHQgKSA6CgkJCQlqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciAmJiBzZWxlY3Rvci5ub2RlVHlwZSA/IFsgc2VsZWN0b3IgXSA6IHNlbGVjdG9yICksCgkJCWFsbCA9IGpRdWVyeS5tZXJnZSggdGhpcy5nZXQoKSwgc2V0ICk7CgoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggaXNEaXNjb25uZWN0ZWQoIHNldFswXSApIHx8IGlzRGlzY29ubmVjdGVkKCBhbGxbMF0gKSA/CgkJCWFsbCA6CgkJCWpRdWVyeS51bmlxdWUoIGFsbCApICk7Cgl9LAoKCWFkZEJhY2s6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPwoJCQl0aGlzLnByZXZPYmplY3QgOiB0aGlzLnByZXZPYmplY3QuZmlsdGVyKHNlbGVjdG9yKQoJCSk7Cgl9Cn0pOwoKalF1ZXJ5LmZuLmFuZFNlbGYgPSBqUXVlcnkuZm4uYWRkQmFjazsKCi8vIEEgcGFpbmZ1bGx5IHNpbXBsZSBjaGVjayB0byBzZWUgaWYgYW4gZWxlbWVudCBpcyBkaXNjb25uZWN0ZWQKLy8gZnJvbSBhIGRvY3VtZW50IChzaG91bGQgYmUgaW1wcm92ZWQsIHdoZXJlIGZlYXNpYmxlKS4KZnVuY3Rpb24gaXNEaXNjb25uZWN0ZWQoIG5vZGUgKSB7CglyZXR1cm4gIW5vZGUgfHwgIW5vZGUucGFyZW50Tm9kZSB8fCBub2RlLnBhcmVudE5vZGUubm9kZVR5cGUgPT09IDExOwp9CgpmdW5jdGlvbiBzaWJsaW5nKCBjdXIsIGRpciApIHsKCWRvIHsKCQljdXIgPSBjdXJbIGRpciBdOwoJfSB3aGlsZSAoIGN1ciAmJiBjdXIubm9kZVR5cGUgIT09IDEgKTsKCglyZXR1cm4gY3VyOwp9CgpqUXVlcnkuZWFjaCh7CglwYXJlbnQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgkJcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKCX0sCglwYXJlbnRzOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInBhcmVudE5vZGUiICk7Cgl9LAoJcGFyZW50c1VudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwYXJlbnROb2RlIiwgdW50aWwgKTsKCX0sCgluZXh0OiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gc2libGluZyggZWxlbSwgIm5leHRTaWJsaW5nIiApOwoJfSwKCXByZXY6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5nKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOwoJfSwKCW5leHRBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAibmV4dFNpYmxpbmciICk7Cgl9LAoJcHJldkFsbDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7Cgl9LAoJbmV4dFVudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJuZXh0U2libGluZyIsIHVudGlsICk7Cgl9LAoJcHJldlVudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciLCB1bnRpbCApOwoJfSwKCXNpYmxpbmdzOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LnNpYmxpbmcoICggZWxlbS5wYXJlbnROb2RlIHx8IHt9ICkuZmlyc3RDaGlsZCwgZWxlbSApOwoJfSwKCWNoaWxkcmVuOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LnNpYmxpbmcoIGVsZW0uZmlyc3RDaGlsZCApOwoJfSwKCWNvbnRlbnRzOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaWZyYW1lIiApID8KCQkJZWxlbS5jb250ZW50RG9jdW1lbnQgfHwgZWxlbS5jb250ZW50V2luZG93LmRvY3VtZW50IDoKCQkJalF1ZXJ5Lm1lcmdlKCBbXSwgZWxlbS5jaGlsZE5vZGVzICk7Cgl9Cn0sIGZ1bmN0aW9uKCBuYW1lLCBmbiApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHVudGlsLCBzZWxlY3RvciApIHsKCQl2YXIgcmV0ID0galF1ZXJ5Lm1hcCggdGhpcywgZm4sIHVudGlsICk7CgoJCWlmICggIXJ1bnRpbC50ZXN0KCBuYW1lICkgKSB7CgkJCXNlbGVjdG9yID0gdW50aWw7CgkJfQoKCQlpZiAoIHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CgkJCXJldCA9IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCByZXQgKTsKCQl9CgoJCXJldCA9IHRoaXMubGVuZ3RoID4gMSAmJiAhZ3VhcmFudGVlZFVuaXF1ZVsgbmFtZSBdID8galF1ZXJ5LnVuaXF1ZSggcmV0ICkgOiByZXQ7CgoJCWlmICggdGhpcy5sZW5ndGggPiAxICYmIHJwYXJlbnRzcHJldi50ZXN0KCBuYW1lICkgKSB7CgkJCXJldCA9IHJldC5yZXZlcnNlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHJldCwgbmFtZSwgY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKS5qb2luKCIsIikgKTsKCX07Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CglmaWx0ZXI6IGZ1bmN0aW9uKCBleHByLCBlbGVtcywgbm90ICkgewoJCWlmICggbm90ICkgewoJCQlleHByID0gIjpub3QoIiArIGV4cHIgKyAiKSI7CgkJfQoKCQlyZXR1cm4gZWxlbXMubGVuZ3RoID09PSAxID8KCQkJalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGVsZW1zWzBdLCBleHByKSA/IFsgZWxlbXNbMF0gXSA6IFtdIDoKCQkJalF1ZXJ5LmZpbmQubWF0Y2hlcyhleHByLCBlbGVtcyk7Cgl9LAoKCWRpcjogZnVuY3Rpb24oIGVsZW0sIGRpciwgdW50aWwgKSB7CgkJdmFyIG1hdGNoZWQgPSBbXSwKCQkJY3VyID0gZWxlbVsgZGlyIF07CgoJCXdoaWxlICggY3VyICYmIGN1ci5ub2RlVHlwZSAhPT0gOSAmJiAodW50aWwgPT09IHVuZGVmaW5lZCB8fCBjdXIubm9kZVR5cGUgIT09IDEgfHwgIWpRdWVyeSggY3VyICkuaXMoIHVudGlsICkpICkgewoJCQlpZiAoIGN1ci5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCW1hdGNoZWQucHVzaCggY3VyICk7CgkJCX0KCQkJY3VyID0gY3VyW2Rpcl07CgkJfQoJCXJldHVybiBtYXRjaGVkOwoJfSwKCglzaWJsaW5nOiBmdW5jdGlvbiggbiwgZWxlbSApIHsKCQl2YXIgciA9IFtdOwoKCQlmb3IgKCA7IG47IG4gPSBuLm5leHRTaWJsaW5nICkgewoJCQlpZiAoIG4ubm9kZVR5cGUgPT09IDEgJiYgbiAhPT0gZWxlbSApIHsKCQkJCXIucHVzaCggbiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcjsKCX0KfSk7CgovLyBJbXBsZW1lbnQgdGhlIGlkZW50aWNhbCBmdW5jdGlvbmFsaXR5IGZvciBmaWx0ZXIgYW5kIG5vdApmdW5jdGlvbiB3aW5ub3coIGVsZW1lbnRzLCBxdWFsaWZpZXIsIGtlZXAgKSB7CgoJLy8gQ2FuJ3QgcGFzcyBudWxsIG9yIHVuZGVmaW5lZCB0byBpbmRleE9mIGluIEZpcmVmb3ggNAoJLy8gU2V0IHRvIDAgdG8gc2tpcCBzdHJpbmcgY2hlY2sKCXF1YWxpZmllciA9IHF1YWxpZmllciB8fCAwOwoKCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHF1YWxpZmllciApICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXZhciByZXRWYWwgPSAhIXF1YWxpZmllci5jYWxsKCBlbGVtLCBpLCBlbGVtICk7CgkJCXJldHVybiByZXRWYWwgPT09IGtlZXA7CgkJfSk7CgoJfSBlbHNlIGlmICggcXVhbGlmaWVyLm5vZGVUeXBlICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiAoIGVsZW0gPT09IHF1YWxpZmllciApID09PSBrZWVwOwoJCX0pOwoKCX0gZWxzZSBpZiAoIHR5cGVvZiBxdWFsaWZpZXIgPT09ICJzdHJpbmciICkgewoJCXZhciBmaWx0ZXJlZCA9IGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDE7CgkJfSk7CgoJCWlmICggaXNTaW1wbGUudGVzdCggcXVhbGlmaWVyICkgKSB7CgkJCXJldHVybiBqUXVlcnkuZmlsdGVyKHF1YWxpZmllciwgZmlsdGVyZWQsICFrZWVwKTsKCQl9IGVsc2UgewoJCQlxdWFsaWZpZXIgPSBqUXVlcnkuZmlsdGVyKCBxdWFsaWZpZXIsIGZpbHRlcmVkICk7CgkJfQoJfQoKCXJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJcmV0dXJuICggalF1ZXJ5LmluQXJyYXkoIGVsZW0sIHF1YWxpZmllciApID49IDAgKSA9PT0ga2VlcDsKCX0pOwp9CmZ1bmN0aW9uIGNyZWF0ZVNhZmVGcmFnbWVudCggZG9jdW1lbnQgKSB7Cgl2YXIgbGlzdCA9IG5vZGVOYW1lcy5zcGxpdCggInwiICksCglzYWZlRnJhZyA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCglpZiAoIHNhZmVGcmFnLmNyZWF0ZUVsZW1lbnQgKSB7CgkJd2hpbGUgKCBsaXN0Lmxlbmd0aCApIHsKCQkJc2FmZUZyYWcuY3JlYXRlRWxlbWVudCgKCQkJCWxpc3QucG9wKCkKCQkJKTsKCQl9Cgl9CglyZXR1cm4gc2FmZUZyYWc7Cn0KCnZhciBub2RlTmFtZXMgPSAiYWJicnxhcnRpY2xlfGFzaWRlfGF1ZGlvfGJkaXxjYW52YXN8ZGF0YXxkYXRhbGlzdHxkZXRhaWxzfGZpZ2NhcHRpb258ZmlndXJlfGZvb3RlcnwiICsKCQkiaGVhZGVyfGhncm91cHxtYXJrfG1ldGVyfG5hdnxvdXRwdXR8cHJvZ3Jlc3N8c2VjdGlvbnxzdW1tYXJ5fHRpbWV8dmlkZW8iLAoJcmlubGluZWpRdWVyeSA9IC8galF1ZXJ5XGQrPSIoPzpudWxsfFxkKykiL2csCglybGVhZGluZ1doaXRlc3BhY2UgPSAvXlxzKy8sCglyeGh0bWxUYWcgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbXHc6XSspW14+XSopXC8+L2dpLAoJcnRhZ05hbWUgPSAvPChbXHc6XSspLywKCXJ0Ym9keSA9IC88dGJvZHkvaSwKCXJodG1sID0gLzx8JiM/XHcrOy8sCglybm9Jbm5lcmh0bWwgPSAvPCg/OnNjcmlwdHxzdHlsZXxsaW5rKS9pLAoJcm5vY2FjaGUgPSAvPCg/OnNjcmlwdHxvYmplY3R8ZW1iZWR8b3B0aW9ufHN0eWxlKS9pLAoJcm5vc2hpbWNhY2hlID0gbmV3IFJlZ0V4cCgiPCg/OiIgKyBub2RlTmFtZXMgKyAiKVtcXHMvPl0iLCAiaSIpLAoJcmNoZWNrYWJsZVR5cGUgPSAvXig/OmNoZWNrYm94fHJhZGlvKSQvLAoJLy8gY2hlY2tlZD0iY2hlY2tlZCIgb3IgY2hlY2tlZAoJcmNoZWNrZWQgPSAvY2hlY2tlZFxzKig/OltePV18PVxzKi5jaGVja2VkLikvaSwKCXJzY3JpcHRUeXBlID0gL1wvKGphdmF8ZWNtYSlzY3JpcHQvaSwKCXJjbGVhblNjcmlwdCA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8XC1cLSl8W1xdXC1dezJ9PlxzKiQvZywKCXdyYXBNYXAgPSB7CgkJb3B0aW9uOiBbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXSwKCQlsZWdlbmQ6IFsgMSwgIjxmaWVsZHNldD4iLCAiPC9maWVsZHNldD4iIF0sCgkJdGhlYWQ6IFsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0sCgkJdHI6IFsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0sCgkJdGQ6IFsgMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iIF0sCgkJY29sOiBbIDIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+IiBdLAoJCWFyZWE6IFsgMSwgIjxtYXA+IiwgIjwvbWFwPiIgXSwKCQlfZGVmYXVsdDogWyAwLCAiIiwgIiIgXQoJfSwKCXNhZmVGcmFnbWVudCA9IGNyZWF0ZVNhZmVGcmFnbWVudCggZG9jdW1lbnQgKSwKCWZyYWdtZW50RGl2ID0gc2FmZUZyYWdtZW50LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSApOwoKd3JhcE1hcC5vcHRncm91cCA9IHdyYXBNYXAub3B0aW9uOwp3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwp3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKCi8vIElFNi04IGNhbid0IHNlcmlhbGl6ZSBsaW5rLCBzY3JpcHQsIHN0eWxlLCBvciBhbnkgaHRtbDUgKE5vU2NvcGUpIHRhZ3MsCi8vIHVubGVzcyB3cmFwcGVkIGluIGEgZGl2IHdpdGggbm9uLWJyZWFraW5nIGNoYXJhY3RlcnMgaW4gZnJvbnQgb2YgaXQuCmlmICggIWpRdWVyeS5zdXBwb3J0Lmh0bWxTZXJpYWxpemUgKSB7Cgl3cmFwTWFwLl9kZWZhdWx0ID0gWyAxLCAiWDxkaXY+IiwgIjwvZGl2PiIgXTsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7Cgl0ZXh0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwoJCQkJalF1ZXJ5LnRleHQoIHRoaXMgKSA6CgkJCQl0aGlzLmVtcHR5KCkuYXBwZW5kKCAoIHRoaXNbMF0gJiYgdGhpc1swXS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50ICkuY3JlYXRlVGV4dE5vZGUoIHZhbHVlICkgKTsKCQl9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCApOwoJfSwKCgl3cmFwQWxsOiBmdW5jdGlvbiggaHRtbCApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJalF1ZXJ5KHRoaXMpLndyYXBBbGwoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwoJCQl9KTsKCQl9CgoJCWlmICggdGhpc1swXSApIHsKCQkJLy8gVGhlIGVsZW1lbnRzIHRvIHdyYXAgdGhlIHRhcmdldCBhcm91bmQKCQkJdmFyIHdyYXAgPSBqUXVlcnkoIGh0bWwsIHRoaXNbMF0ub3duZXJEb2N1bWVudCApLmVxKDApLmNsb25lKHRydWUpOwoKCQkJaWYgKCB0aGlzWzBdLnBhcmVudE5vZGUgKSB7CgkJCQl3cmFwLmluc2VydEJlZm9yZSggdGhpc1swXSApOwoJCQl9CgoJCQl3cmFwLm1hcChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gdGhpczsKCgkJCQl3aGlsZSAoIGVsZW0uZmlyc3RDaGlsZCAmJiBlbGVtLmZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsKCQkJCX0KCgkJCQlyZXR1cm4gZWxlbTsKCQkJfSkuYXBwZW5kKCB0aGlzICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcElubmVyOiBmdW5jdGlvbiggaHRtbCApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJalF1ZXJ5KHRoaXMpLndyYXBJbm5lciggaHRtbC5jYWxsKHRoaXMsIGkpICk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSBqUXVlcnkoIHRoaXMgKSwKCQkJCWNvbnRlbnRzID0gc2VsZi5jb250ZW50cygpOwoKCQkJaWYgKCBjb250ZW50cy5sZW5ndGggKSB7CgkJCQljb250ZW50cy53cmFwQWxsKCBodG1sICk7CgoJCQl9IGVsc2UgewoJCQkJc2VsZi5hcHBlbmQoIGh0bWwgKTsKCQkJfQoJCX0pOwoJfSwKCgl3cmFwOiBmdW5jdGlvbiggaHRtbCApIHsKCQl2YXIgaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICk7CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQlqUXVlcnkoIHRoaXMgKS53cmFwQWxsKCBpc0Z1bmN0aW9uID8gaHRtbC5jYWxsKHRoaXMsIGkpIDogaHRtbCApOwoJCX0pOwoJfSwKCgl1bndyYXA6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnBhcmVudCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggIWpRdWVyeS5ub2RlTmFtZSggdGhpcywgImJvZHkiICkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5yZXBsYWNlV2l0aCggdGhpcy5jaGlsZE5vZGVzICk7CgkJCX0KCQl9KS5lbmQoKTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIHRydWUsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgKSB7CgkJCQl0aGlzLmFwcGVuZENoaWxkKCBlbGVtICk7CgkJCX0KCQl9KTsKCX0sCgoJcHJlcGVuZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCB0cnVlLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExICkgewoJCQkJdGhpcy5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMuZmlyc3RDaGlsZCApOwoJCQl9CgkJfSk7Cgl9LAoKCWJlZm9yZTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhaXNEaXNjb25uZWN0ZWQoIHRoaXNbMF0gKSApIHsKCQkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmYWxzZSwgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzICk7CgkJCX0pOwoJCX0KCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl2YXIgc2V0ID0galF1ZXJ5LmNsZWFuKCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkubWVyZ2UoIHNldCwgdGhpcyApLCAiYmVmb3JlIiwgdGhpcy5zZWxlY3RvciApOwoJCX0KCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKCkgewoJCWlmICggIWlzRGlzY29ubmVjdGVkKCB0aGlzWzBdICkgKSB7CgkJCXJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgZmFsc2UsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5uZXh0U2libGluZyApOwoJCQl9KTsKCQl9CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdmFyIHNldCA9IGpRdWVyeS5jbGVhbiggYXJndW1lbnRzICk7CgkJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5Lm1lcmdlKCB0aGlzLCBzZXQgKSwgImFmdGVyIiwgdGhpcy5zZWxlY3RvciApOwoJCX0KCX0sCgoJLy8ga2VlcERhdGEgaXMgZm9yIGludGVybmFsIHVzZSBvbmx5LS1kbyBub3QgZG9jdW1lbnQKCXJlbW92ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCBrZWVwRGF0YSApIHsKCQl2YXIgZWxlbSwKCQkJaSA9IDA7CgoJCWZvciAoIDsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCWlmICggIXNlbGVjdG9yIHx8IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCBbIGVsZW0gXSApLmxlbmd0aCApIHsKCQkJCWlmICggIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpICk7CgkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggWyBlbGVtIF0gKTsKCQkJCX0KCgkJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQllbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGVsZW0gKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSwKCQkJaSA9IDA7CgoJCWZvciAoIDsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCS8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwoJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQlqUXVlcnkuY2xlYW5EYXRhKCBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgKTsKCQkJfQoKCQkJLy8gUmVtb3ZlIGFueSByZW1haW5pbmcgbm9kZXMKCQkJd2hpbGUgKCBlbGVtLmZpcnN0Q2hpbGQgKSB7CgkJCQllbGVtLnJlbW92ZUNoaWxkKCBlbGVtLmZpcnN0Q2hpbGQgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbiggZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJZGF0YUFuZEV2ZW50cyA9IGRhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGZhbHNlIDogZGF0YUFuZEV2ZW50czsKCQlkZWVwRGF0YUFuZEV2ZW50cyA9IGRlZXBEYXRhQW5kRXZlbnRzID09IG51bGwgPyBkYXRhQW5kRXZlbnRzIDogZGVlcERhdGFBbmRFdmVudHM7CgoJCXJldHVybiB0aGlzLm1hcCggZnVuY3Rpb24gKCkgewoJCQlyZXR1cm4galF1ZXJ5LmNsb25lKCB0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApOwoJCX0pOwoJfSwKCglodG1sOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIGVsZW0gPSB0aGlzWzBdIHx8IHt9LAoJCQkJaSA9IDAsCgkJCQlsID0gdGhpcy5sZW5ndGg7CgoJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMSA/CgkJCQkJZWxlbS5pbm5lckhUTUwucmVwbGFjZSggcmlubGluZWpRdWVyeSwgIiIgKSA6CgkJCQkJdW5kZWZpbmVkOwoJCQl9CgoJCQkvLyBTZWUgaWYgd2UgY2FuIHRha2UgYSBzaG9ydGN1dCBhbmQganVzdCB1c2UgaW5uZXJIVE1MCgkJCWlmICggdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAhcm5vSW5uZXJodG1sLnRlc3QoIHZhbHVlICkgJiYKCQkJCSggalF1ZXJ5LnN1cHBvcnQuaHRtbFNlcmlhbGl6ZSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoIHZhbHVlICkgICkgJiYKCQkJCSggalF1ZXJ5LnN1cHBvcnQubGVhZGluZ1doaXRlc3BhY2UgfHwgIXJsZWFkaW5nV2hpdGVzcGFjZS50ZXN0KCB2YWx1ZSApICkgJiYKCQkJCSF3cmFwTWFwWyAoIHJ0YWdOYW1lLmV4ZWMoIHZhbHVlICkgfHwgWyIiLCAiIl0gKVsxXS50b0xvd2VyQ2FzZSgpIF0gKSB7CgoJCQkJdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCByeGh0bWxUYWcsICI8JDE+PC8kMj4iICk7CgoJCQkJdHJ5IHsKCQkJCQlmb3IgKDsgaSA8IGw7IGkrKyApIHsKCQkJCQkJLy8gUmVtb3ZlIGVsZW1lbnQgbm9kZXMgYW5kIHByZXZlbnQgbWVtb3J5IGxlYWtzCgkJCQkJCWVsZW0gPSB0aGlzW2ldIHx8IHt9OwoJCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCQlqUXVlcnkuY2xlYW5EYXRhKCBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCAiKiIgKSApOwoJCQkJCQkJZWxlbS5pbm5lckhUTUwgPSB2YWx1ZTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJZWxlbSA9IDA7CgoJCQkJLy8gSWYgdXNpbmcgaW5uZXJIVE1MIHRocm93cyBhbiBleGNlcHRpb24sIHVzZSB0aGUgZmFsbGJhY2sgbWV0aG9kCgkJCQl9IGNhdGNoKGUpIHt9CgkJCX0KCgkJCWlmICggZWxlbSApIHsKCQkJCXRoaXMuZW1wdHkoKS5hcHBlbmQoIHZhbHVlICk7CgkJCX0KCQl9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCApOwoJfSwKCglyZXBsYWNlV2l0aDogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggIWlzRGlzY29ubmVjdGVkKCB0aGlzWzBdICkgKSB7CgkJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBlbGVtZW50cyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBET00gYmVmb3JlIHRoZXkgYXJlIGluc2VydGVkCgkJCS8vIHRoaXMgY2FuIGhlbHAgZml4IHJlcGxhY2luZyBhIHBhcmVudCB3aXRoIGNoaWxkIGVsZW1lbnRzCgkJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJCQl2YXIgc2VsZiA9IGpRdWVyeSh0aGlzKSwgb2xkID0gc2VsZi5odG1sKCk7CgkJCQkJc2VsZi5yZXBsYWNlV2l0aCggdmFsdWUuY2FsbCggdGhpcywgaSwgb2xkICkgKTsKCQkJCX0pOwoJCQl9CgoJCQlpZiAoIHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIgKSB7CgkJCQl2YWx1ZSA9IGpRdWVyeSggdmFsdWUgKS5kZXRhY2goKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBuZXh0ID0gdGhpcy5uZXh0U2libGluZywKCQkJCQlwYXJlbnQgPSB0aGlzLnBhcmVudE5vZGU7CgoJCQkJalF1ZXJ5KCB0aGlzICkucmVtb3ZlKCk7CgoJCQkJaWYgKCBuZXh0ICkgewoJCQkJCWpRdWVyeShuZXh0KS5iZWZvcmUoIHZhbHVlICk7CgkJCQl9IGVsc2UgewoJCQkJCWpRdWVyeShwYXJlbnQpLmFwcGVuZCggdmFsdWUgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGhpcy5sZW5ndGggPwoJCQl0aGlzLnB1c2hTdGFjayggalF1ZXJ5KGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlKCkgOiB2YWx1ZSksICJyZXBsYWNlV2l0aCIsIHZhbHVlICkgOgoJCQl0aGlzOwoJfSwKCglkZXRhY2g6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmUoIHNlbGVjdG9yLCB0cnVlICk7Cgl9LAoKCWRvbU1hbmlwOiBmdW5jdGlvbiggYXJncywgdGFibGUsIGNhbGxiYWNrICkgewoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJYXJncyA9IFtdLmNvbmNhdC5hcHBseSggW10sIGFyZ3MgKTsKCgkJdmFyIHJlc3VsdHMsIGZpcnN0LCBmcmFnbWVudCwgaU5vQ2xvbmUsCgkJCWkgPSAwLAoJCQl2YWx1ZSA9IGFyZ3NbMF0sCgkJCXNjcmlwdHMgPSBbXSwKCQkJbCA9IHRoaXMubGVuZ3RoOwoKCQkvLyBXZSBjYW4ndCBjbG9uZU5vZGUgZnJhZ21lbnRzIHRoYXQgY29udGFpbiBjaGVja2VkLCBpbiBXZWJLaXQKCQlpZiAoICFqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lICYmIGwgPiAxICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgcmNoZWNrZWQudGVzdCggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeSh0aGlzKS5kb21NYW5pcCggYXJncywgdGFibGUsIGNhbGxiYWNrICk7CgkJCX0pOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgkJCQlhcmdzWzBdID0gdmFsdWUuY2FsbCggdGhpcywgaSwgdGFibGUgPyBzZWxmLmh0bWwoKSA6IHVuZGVmaW5lZCApOwoJCQkJc2VsZi5kb21NYW5pcCggYXJncywgdGFibGUsIGNhbGxiYWNrICk7CgkJCX0pOwoJCX0KCgkJaWYgKCB0aGlzWzBdICkgewoJCQlyZXN1bHRzID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoIGFyZ3MsIHRoaXMsIHNjcmlwdHMgKTsKCQkJZnJhZ21lbnQgPSByZXN1bHRzLmZyYWdtZW50OwoJCQlmaXJzdCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CgoJCQlpZiAoIGZyYWdtZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxICkgewoJCQkJZnJhZ21lbnQgPSBmaXJzdDsKCQkJfQoKCQkJaWYgKCBmaXJzdCApIHsKCQkJCXRhYmxlID0gdGFibGUgJiYgalF1ZXJ5Lm5vZGVOYW1lKCBmaXJzdCwgInRyIiApOwoKCQkJCS8vIFVzZSB0aGUgb3JpZ2luYWwgZnJhZ21lbnQgZm9yIHRoZSBsYXN0IGl0ZW0gaW5zdGVhZCBvZiB0aGUgZmlyc3QgYmVjYXVzZSBpdCBjYW4gZW5kIHVwCgkJCQkvLyBiZWluZyBlbXB0aWVkIGluY29ycmVjdGx5IGluIGNlcnRhaW4gc2l0dWF0aW9ucyAoIzgwNzApLgoJCQkJLy8gRnJhZ21lbnRzIGZyb20gdGhlIGZyYWdtZW50IGNhY2hlIG11c3QgYWx3YXlzIGJlIGNsb25lZCBhbmQgbmV2ZXIgdXNlZCBpbiBwbGFjZS4KCQkJCWZvciAoIGlOb0Nsb25lID0gcmVzdWx0cy5jYWNoZWFibGUgfHwgbCAtIDE7IGkgPCBsOyBpKysgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCgKCQkJCQkJdGFibGUgJiYgalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzW2ldLCAidGFibGUiICkgPwoJCQkJCQkJZmluZE9yQXBwZW5kKCB0aGlzW2ldLCAidGJvZHkiICkgOgoJCQkJCQkJdGhpc1tpXSwKCQkJCQkJaSA9PT0gaU5vQ2xvbmUgPwoJCQkJCQkJZnJhZ21lbnQgOgoJCQkJCQkJalF1ZXJ5LmNsb25lKCBmcmFnbWVudCwgdHJ1ZSwgdHJ1ZSApCgkJCQkJKTsKCQkJCX0KCQkJfQoKCQkJLy8gRml4ICMxMTgwOTogQXZvaWQgbGVha2luZyBtZW1vcnkKCQkJZnJhZ21lbnQgPSBmaXJzdCA9IG51bGw7CgoJCQlpZiAoIHNjcmlwdHMubGVuZ3RoICkgewoJCQkJalF1ZXJ5LmVhY2goIHNjcmlwdHMsIGZ1bmN0aW9uKCBpLCBlbGVtICkgewoJCQkJCWlmICggZWxlbS5zcmMgKSB7CgkJCQkJCWlmICggalF1ZXJ5LmFqYXggKSB7CgkJCQkJCQlqUXVlcnkuYWpheCh7CgkJCQkJCQkJdXJsOiBlbGVtLnNyYywKCQkJCQkJCQl0eXBlOiAiR0VUIiwKCQkJCQkJCQlkYXRhVHlwZTogInNjcmlwdCIsCgkJCQkJCQkJYXN5bmM6IGZhbHNlLAoJCQkJCQkJCWdsb2JhbDogZmFsc2UsCgkJCQkJCQkJInRocm93cyI6IHRydWUKCQkJCQkJCX0pOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJalF1ZXJ5LmVycm9yKCJubyBhamF4Iik7CgkJCQkJCX0KCQkJCQl9IGVsc2UgewoJCQkJCQlqUXVlcnkuZ2xvYmFsRXZhbCggKCBlbGVtLnRleHQgfHwgZWxlbS50ZXh0Q29udGVudCB8fCBlbGVtLmlubmVySFRNTCB8fCAiIiApLnJlcGxhY2UoIHJjbGVhblNjcmlwdCwgIiIgKSApOwoJCQkJCX0KCgkJCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQkJCWVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggZWxlbSApOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgpmdW5jdGlvbiBmaW5kT3JBcHBlbmQoIGVsZW0sIHRhZyApIHsKCXJldHVybiBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKVswXSB8fCBlbGVtLmFwcGVuZENoaWxkKCBlbGVtLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCggdGFnICkgKTsKfQoKZnVuY3Rpb24gY2xvbmVDb3B5RXZlbnQoIHNyYywgZGVzdCApIHsKCglpZiAoIGRlc3Qubm9kZVR5cGUgIT09IDEgfHwgIWpRdWVyeS5oYXNEYXRhKCBzcmMgKSApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHR5cGUsIGksIGwsCgkJb2xkRGF0YSA9IGpRdWVyeS5fZGF0YSggc3JjICksCgkJY3VyRGF0YSA9IGpRdWVyeS5fZGF0YSggZGVzdCwgb2xkRGF0YSApLAoJCWV2ZW50cyA9IG9sZERhdGEuZXZlbnRzOwoKCWlmICggZXZlbnRzICkgewoJCWRlbGV0ZSBjdXJEYXRhLmhhbmRsZTsKCQljdXJEYXRhLmV2ZW50cyA9IHt9OwoKCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJZm9yICggaSA9IDAsIGwgPSBldmVudHNbIHR5cGUgXS5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQlqUXVlcnkuZXZlbnQuYWRkKCBkZXN0LCB0eXBlLCBldmVudHNbIHR5cGUgXVsgaSBdICk7CgkJCX0KCQl9Cgl9CgoJLy8gbWFrZSB0aGUgY2xvbmVkIHB1YmxpYyBkYXRhIG9iamVjdCBhIGNvcHkgZnJvbSB0aGUgb3JpZ2luYWwKCWlmICggY3VyRGF0YS5kYXRhICkgewoJCWN1ckRhdGEuZGF0YSA9IGpRdWVyeS5leHRlbmQoIHt9LCBjdXJEYXRhLmRhdGEgKTsKCX0KfQoKZnVuY3Rpb24gY2xvbmVGaXhBdHRyaWJ1dGVzKCBzcmMsIGRlc3QgKSB7Cgl2YXIgbm9kZU5hbWU7CgoJLy8gV2UgZG8gbm90IG5lZWQgdG8gZG8gYW55dGhpbmcgZm9yIG5vbi1FbGVtZW50cwoJaWYgKCBkZXN0Lm5vZGVUeXBlICE9PSAxICkgewoJCXJldHVybjsKCX0KCgkvLyBjbGVhckF0dHJpYnV0ZXMgcmVtb3ZlcyB0aGUgYXR0cmlidXRlcywgd2hpY2ggd2UgZG9uJ3Qgd2FudCwKCS8vIGJ1dCBhbHNvIHJlbW92ZXMgdGhlIGF0dGFjaEV2ZW50IGV2ZW50cywgd2hpY2ggd2UgKmRvKiB3YW50CglpZiAoIGRlc3QuY2xlYXJBdHRyaWJ1dGVzICkgewoJCWRlc3QuY2xlYXJBdHRyaWJ1dGVzKCk7Cgl9CgoJLy8gbWVyZ2VBdHRyaWJ1dGVzLCBpbiBjb250cmFzdCwgb25seSBtZXJnZXMgYmFjayBvbiB0aGUKCS8vIG9yaWdpbmFsIGF0dHJpYnV0ZXMsIG5vdCB0aGUgZXZlbnRzCglpZiAoIGRlc3QubWVyZ2VBdHRyaWJ1dGVzICkgewoJCWRlc3QubWVyZ2VBdHRyaWJ1dGVzKCBzcmMgKTsKCX0KCglub2RlTmFtZSA9IGRlc3Qubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCglpZiAoIG5vZGVOYW1lID09PSAib2JqZWN0IiApIHsKCQkvLyBJRTYtMTAgaW1wcm9wZXJseSBjbG9uZXMgY2hpbGRyZW4gb2Ygb2JqZWN0IGVsZW1lbnRzIHVzaW5nIGNsYXNzaWQuCgkJLy8gSUUxMCB0aHJvd3MgTm9Nb2RpZmljYXRpb25BbGxvd2VkRXJyb3IgaWYgcGFyZW50IGlzIG51bGwsICMxMjEzMi4KCQlpZiAoIGRlc3QucGFyZW50Tm9kZSApIHsKCQkJZGVzdC5vdXRlckhUTUwgPSBzcmMub3V0ZXJIVE1MOwoJCX0KCgkJLy8gVGhpcyBwYXRoIGFwcGVhcnMgdW5hdm9pZGFibGUgZm9yIElFOS4gV2hlbiBjbG9uaW5nIGFuIG9iamVjdAoJCS8vIGVsZW1lbnQgaW4gSUU5LCB0aGUgb3V0ZXJIVE1MIHN0cmF0ZWd5IGFib3ZlIGlzIG5vdCBzdWZmaWNpZW50LgoJCS8vIElmIHRoZSBzcmMgaGFzIGlubmVySFRNTCBhbmQgdGhlIGRlc3RpbmF0aW9uIGRvZXMgbm90LAoJCS8vIGNvcHkgdGhlIHNyYy5pbm5lckhUTUwgaW50byB0aGUgZGVzdC5pbm5lckhUTUwuICMxMDMyNAoJCWlmICggalF1ZXJ5LnN1cHBvcnQuaHRtbDVDbG9uZSAmJiAoc3JjLmlubmVySFRNTCAmJiAhalF1ZXJ5LnRyaW0oZGVzdC5pbm5lckhUTUwpKSApIHsKCQkJZGVzdC5pbm5lckhUTUwgPSBzcmMuaW5uZXJIVE1MOwoJCX0KCgl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiAmJiByY2hlY2thYmxlVHlwZS50ZXN0KCBzcmMudHlwZSApICkgewoJCS8vIElFNi04IGZhaWxzIHRvIHBlcnNpc3QgdGhlIGNoZWNrZWQgc3RhdGUgb2YgYSBjbG9uZWQgY2hlY2tib3gKCQkvLyBvciByYWRpbyBidXR0b24uIFdvcnNlLCBJRTYtNyBmYWlsIHRvIGdpdmUgdGhlIGNsb25lZCBlbGVtZW50CgkJLy8gYSBjaGVja2VkIGFwcGVhcmFuY2UgaWYgdGhlIGRlZmF1bHRDaGVja2VkIHZhbHVlIGlzbid0IGFsc28gc2V0CgoJCWRlc3QuZGVmYXVsdENoZWNrZWQgPSBkZXN0LmNoZWNrZWQgPSBzcmMuY2hlY2tlZDsKCgkJLy8gSUU2LTcgZ2V0IGNvbmZ1c2VkIGFuZCBlbmQgdXAgc2V0dGluZyB0aGUgdmFsdWUgb2YgYSBjbG9uZWQKCQkvLyBjaGVja2JveC9yYWRpbyBidXR0b24gdG8gYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgIm9uIgoJCWlmICggZGVzdC52YWx1ZSAhPT0gc3JjLnZhbHVlICkgewoJCQlkZXN0LnZhbHVlID0gc3JjLnZhbHVlOwoJCX0KCgkvLyBJRTYtOCBmYWlscyB0byByZXR1cm4gdGhlIHNlbGVjdGVkIG9wdGlvbiB0byB0aGUgZGVmYXVsdCBzZWxlY3RlZAoJLy8gc3RhdGUgd2hlbiBjbG9uaW5nIG9wdGlvbnMKCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAib3B0aW9uIiApIHsKCQlkZXN0LnNlbGVjdGVkID0gc3JjLmRlZmF1bHRTZWxlY3RlZDsKCgkvLyBJRTYtOCBmYWlscyB0byBzZXQgdGhlIGRlZmF1bHRWYWx1ZSB0byB0aGUgY29ycmVjdCB2YWx1ZSB3aGVuCgkvLyBjbG9uaW5nIG90aGVyIHR5cGVzIG9mIGlucHV0IGZpZWxkcwoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgfHwgbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIgKSB7CgkJZGVzdC5kZWZhdWx0VmFsdWUgPSBzcmMuZGVmYXVsdFZhbHVlOwoKCS8vIElFIGJsYW5rcyBjb250ZW50cyB3aGVuIGNsb25pbmcgc2NyaXB0cwoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJzY3JpcHQiICYmIGRlc3QudGV4dCAhPT0gc3JjLnRleHQgKSB7CgkJZGVzdC50ZXh0ID0gc3JjLnRleHQ7Cgl9CgoJLy8gRXZlbnQgZGF0YSBnZXRzIHJlZmVyZW5jZWQgaW5zdGVhZCBvZiBjb3BpZWQgaWYgdGhlIGV4cGFuZG8KCS8vIGdldHMgY29waWVkIHRvbwoJZGVzdC5yZW1vdmVBdHRyaWJ1dGUoIGpRdWVyeS5leHBhbmRvICk7Cn0KCmpRdWVyeS5idWlsZEZyYWdtZW50ID0gZnVuY3Rpb24oIGFyZ3MsIGNvbnRleHQsIHNjcmlwdHMgKSB7Cgl2YXIgZnJhZ21lbnQsIGNhY2hlYWJsZSwgY2FjaGVoaXQsCgkJZmlyc3QgPSBhcmdzWyAwIF07CgoJLy8gU2V0IGNvbnRleHQgZnJvbSB3aGF0IG1heSBjb21lIGluIGFzIHVuZGVmaW5lZCBvciBhIGpRdWVyeSBjb2xsZWN0aW9uIG9yIGEgbm9kZQoJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7Cgljb250ZXh0ID0gKGNvbnRleHRbMF0gfHwgY29udGV4dCkub3duZXJEb2N1bWVudCB8fCBjb250ZXh0WzBdIHx8IGNvbnRleHQ7CgoJLy8gRW5zdXJlIHRoYXQgYW4gYXR0ciBvYmplY3QgZG9lc24ndCBpbmNvcnJlY3RseSBzdGFuZCBpbiBhcyBhIGRvY3VtZW50IG9iamVjdAoJLy8gQ2hyb21lIGFuZCBGaXJlZm94IHNlZW0gdG8gYWxsb3cgdGhpcyB0byBvY2N1ciBhbmQgd2lsbCB0aHJvdyBleGNlcHRpb24KCS8vIEZpeGVzICM4OTUwCglpZiAoIHR5cGVvZiBjb250ZXh0LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQgPT09ICJ1bmRlZmluZWQiICkgewoJCWNvbnRleHQgPSBkb2N1bWVudDsKCX0KCgkvLyBPbmx5IGNhY2hlICJzbWFsbCIgKDEvMiBLQikgSFRNTCBzdHJpbmdzIHRoYXQgYXJlIGFzc29jaWF0ZWQgd2l0aCB0aGUgbWFpbiBkb2N1bWVudAoJLy8gQ2xvbmluZyBvcHRpb25zIGxvc2VzIHRoZSBzZWxlY3RlZCBzdGF0ZSwgc28gZG9uJ3QgY2FjaGUgdGhlbQoJLy8gSUUgNiBkb2Vzbid0IGxpa2UgaXQgd2hlbiB5b3UgcHV0IDxvYmplY3Q+IG9yIDxlbWJlZD4gZWxlbWVudHMgaW4gYSBmcmFnbWVudAoJLy8gQWxzbywgV2ViS2l0IGRvZXMgbm90IGNsb25lICdjaGVja2VkJyBhdHRyaWJ1dGVzIG9uIGNsb25lTm9kZSwgc28gZG9uJ3QgY2FjaGUKCS8vIExhc3RseSwgSUU2LDcsOCB3aWxsIG5vdCBjb3JyZWN0bHkgcmV1c2UgY2FjaGVkIGZyYWdtZW50cyB0aGF0IHdlcmUgY3JlYXRlZCBmcm9tIHVua25vd24gZWxlbXMgIzEwNTAxCglpZiAoIGFyZ3MubGVuZ3RoID09PSAxICYmIHR5cGVvZiBmaXJzdCA9PT0gInN0cmluZyIgJiYgZmlyc3QubGVuZ3RoIDwgNTEyICYmIGNvbnRleHQgPT09IGRvY3VtZW50ICYmCgkJZmlyc3QuY2hhckF0KDApID09PSAiPCIgJiYgIXJub2NhY2hlLnRlc3QoIGZpcnN0ICkgJiYKCQkoalF1ZXJ5LnN1cHBvcnQuY2hlY2tDbG9uZSB8fCAhcmNoZWNrZWQudGVzdCggZmlyc3QgKSkgJiYKCQkoalF1ZXJ5LnN1cHBvcnQuaHRtbDVDbG9uZSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoIGZpcnN0ICkpICkgewoKCQkvLyBNYXJrIGNhY2hlYWJsZSBhbmQgbG9vayBmb3IgYSBoaXQKCQljYWNoZWFibGUgPSB0cnVlOwoJCWZyYWdtZW50ID0galF1ZXJ5LmZyYWdtZW50c1sgZmlyc3QgXTsKCQljYWNoZWhpdCA9IGZyYWdtZW50ICE9PSB1bmRlZmluZWQ7Cgl9CgoJaWYgKCAhZnJhZ21lbnQgKSB7CgkJZnJhZ21lbnQgPSBjb250ZXh0LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCQlqUXVlcnkuY2xlYW4oIGFyZ3MsIGNvbnRleHQsIGZyYWdtZW50LCBzY3JpcHRzICk7CgoJCS8vIFVwZGF0ZSB0aGUgY2FjaGUsIGJ1dCBvbmx5IHN0b3JlIGZhbHNlCgkJLy8gdW5sZXNzIHRoaXMgaXMgYSBzZWNvbmQgcGFyc2luZyBvZiB0aGUgc2FtZSBjb250ZW50CgkJaWYgKCBjYWNoZWFibGUgKSB7CgkJCWpRdWVyeS5mcmFnbWVudHNbIGZpcnN0IF0gPSBjYWNoZWhpdCAmJiBmcmFnbWVudDsKCQl9Cgl9CgoJcmV0dXJuIHsgZnJhZ21lbnQ6IGZyYWdtZW50LCBjYWNoZWFibGU6IGNhY2hlYWJsZSB9Owp9OwoKalF1ZXJ5LmZyYWdtZW50cyA9IHt9OwoKalF1ZXJ5LmVhY2goewoJYXBwZW5kVG86ICJhcHBlbmQiLAoJcHJlcGVuZFRvOiAicHJlcGVuZCIsCglpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAoJaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCglyZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCn0sIGZ1bmN0aW9uKCBuYW1lLCBvcmlnaW5hbCApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBlbGVtcywKCQkJaSA9IDAsCgkJCXJldCA9IFtdLAoJCQlpbnNlcnQgPSBqUXVlcnkoIHNlbGVjdG9yICksCgkJCWwgPSBpbnNlcnQubGVuZ3RoLAoJCQlwYXJlbnQgPSB0aGlzLmxlbmd0aCA9PT0gMSAmJiB0aGlzWzBdLnBhcmVudE5vZGU7CgoJCWlmICggKHBhcmVudCA9PSBudWxsIHx8IHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgPT09IDExICYmIHBhcmVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSkgJiYgbCA9PT0gMSApIHsKCQkJaW5zZXJ0WyBvcmlnaW5hbCBdKCB0aGlzWzBdICk7CgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCWVsZW1zID0gKCBpID4gMCA/IHRoaXMuY2xvbmUodHJ1ZSkgOiB0aGlzICkuZ2V0KCk7CgkJCQlqUXVlcnkoIGluc2VydFtpXSApWyBvcmlnaW5hbCBdKCBlbGVtcyApOwoJCQkJcmV0ID0gcmV0LmNvbmNhdCggZWxlbXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQsIG5hbWUsIGluc2VydC5zZWxlY3RvciApOwoJCX0KCX07Cn0pOwoKZnVuY3Rpb24gZ2V0QWxsKCBlbGVtICkgewoJaWYgKCB0eXBlb2YgZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgKSB7CgkJcmV0dXJuIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoICIqIiApOwoKCX0gZWxzZSBpZiAoIHR5cGVvZiBlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwgIT09ICJ1bmRlZmluZWQiICkgewoJCXJldHVybiBlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwoICIqIiApOwoKCX0gZWxzZSB7CgkJcmV0dXJuIFtdOwoJfQp9CgovLyBVc2VkIGluIGNsZWFuLCBmaXhlcyB0aGUgZGVmYXVsdENoZWNrZWQgcHJvcGVydHkKZnVuY3Rpb24gZml4RGVmYXVsdENoZWNrZWQoIGVsZW0gKSB7CglpZiAoIHJjaGVja2FibGVUeXBlLnRlc3QoIGVsZW0udHlwZSApICkgewoJCWVsZW0uZGVmYXVsdENoZWNrZWQgPSBlbGVtLmNoZWNrZWQ7Cgl9Cn0KCmpRdWVyeS5leHRlbmQoewoJY2xvbmU6IGZ1bmN0aW9uKCBlbGVtLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQl2YXIgc3JjRWxlbWVudHMsCgkJCWRlc3RFbGVtZW50cywKCQkJaSwKCQkJY2xvbmU7CgoJCWlmICggalF1ZXJ5LnN1cHBvcnQuaHRtbDVDbG9uZSB8fCBqUXVlcnkuaXNYTUxEb2MoZWxlbSkgfHwgIXJub3NoaW1jYWNoZS50ZXN0KCAiPCIgKyBlbGVtLm5vZGVOYW1lICsgIj4iICkgKSB7CgkJCWNsb25lID0gZWxlbS5jbG9uZU5vZGUoIHRydWUgKTsKCgkJLy8gSUU8PTggZG9lcyBub3QgcHJvcGVybHkgY2xvbmUgZGV0YWNoZWQsIHVua25vd24gZWxlbWVudCBub2RlcwoJCX0gZWxzZSB7CgkJCWZyYWdtZW50RGl2LmlubmVySFRNTCA9IGVsZW0ub3V0ZXJIVE1MOwoJCQlmcmFnbWVudERpdi5yZW1vdmVDaGlsZCggY2xvbmUgPSBmcmFnbWVudERpdi5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICghalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUV2ZW50IHx8ICFqUXVlcnkuc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCkgJiYKCQkJCShlbGVtLm5vZGVUeXBlID09PSAxIHx8IGVsZW0ubm9kZVR5cGUgPT09IDExKSAmJiAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pICkgewoJCQkvLyBJRSBjb3BpZXMgZXZlbnRzIGJvdW5kIHZpYSBhdHRhY2hFdmVudCB3aGVuIHVzaW5nIGNsb25lTm9kZS4KCQkJLy8gQ2FsbGluZyBkZXRhY2hFdmVudCBvbiB0aGUgY2xvbmUgd2lsbCBhbHNvIHJlbW92ZSB0aGUgZXZlbnRzCgkJCS8vIGZyb20gdGhlIG9yaWdpbmFsLiBJbiBvcmRlciB0byBnZXQgYXJvdW5kIHRoaXMsIHdlIHVzZSBzb21lCgkJCS8vIHByb3ByaWV0YXJ5IG1ldGhvZHMgdG8gY2xlYXIgdGhlIGV2ZW50cy4gVGhhbmtzIHRvIE1vb1Rvb2xzCgkJCS8vIGd1eXMgZm9yIHRoaXMgaG90bmVzcy4KCgkJCWNsb25lRml4QXR0cmlidXRlcyggZWxlbSwgY2xvbmUgKTsKCgkJCS8vIFVzaW5nIFNpenpsZSBoZXJlIGlzIGNyYXp5IHNsb3csIHNvIHdlIHVzZSBnZXRFbGVtZW50c0J5VGFnTmFtZSBpbnN0ZWFkCgkJCXNyY0VsZW1lbnRzID0gZ2V0QWxsKCBlbGVtICk7CgkJCWRlc3RFbGVtZW50cyA9IGdldEFsbCggY2xvbmUgKTsKCgkJCS8vIFdlaXJkIGl0ZXJhdGlvbiBiZWNhdXNlIElFIHdpbGwgcmVwbGFjZSB0aGUgbGVuZ3RoIHByb3BlcnR5CgkJCS8vIHdpdGggYW4gZWxlbWVudCBpZiB5b3UgYXJlIGNsb25pbmcgdGhlIGJvZHkgYW5kIG9uZSBvZiB0aGUKCQkJLy8gZWxlbWVudHMgb24gdGhlIHBhZ2UgaGFzIGEgbmFtZSBvciBpZCBvZiAibGVuZ3RoIgoJCQlmb3IgKCBpID0gMDsgc3JjRWxlbWVudHNbaV07ICsraSApIHsKCQkJCS8vIEVuc3VyZSB0aGF0IHRoZSBkZXN0aW5hdGlvbiBub2RlIGlzIG5vdCBudWxsOyBGaXhlcyAjOTU4NwoJCQkJaWYgKCBkZXN0RWxlbWVudHNbaV0gKSB7CgkJCQkJY2xvbmVGaXhBdHRyaWJ1dGVzKCBzcmNFbGVtZW50c1tpXSwgZGVzdEVsZW1lbnRzW2ldICk7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKCQlpZiAoIGRhdGFBbmRFdmVudHMgKSB7CgkJCWNsb25lQ29weUV2ZW50KCBlbGVtLCBjbG9uZSApOwoKCQkJaWYgKCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQkJCXNyY0VsZW1lbnRzID0gZ2V0QWxsKCBlbGVtICk7CgkJCQlkZXN0RWxlbWVudHMgPSBnZXRBbGwoIGNsb25lICk7CgoJCQkJZm9yICggaSA9IDA7IHNyY0VsZW1lbnRzW2ldOyArK2kgKSB7CgkJCQkJY2xvbmVDb3B5RXZlbnQoIHNyY0VsZW1lbnRzW2ldLCBkZXN0RWxlbWVudHNbaV0gKTsKCQkJCX0KCQkJfQoJCX0KCgkJc3JjRWxlbWVudHMgPSBkZXN0RWxlbWVudHMgPSBudWxsOwoKCQkvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbiggZWxlbXMsIGNvbnRleHQsIGZyYWdtZW50LCBzY3JpcHRzICkgewoJCXZhciBqLCBzYWZlLCBlbGVtLCB0YWcsIHdyYXAsIGRlcHRoLCBkaXYsIGhhc0JvZHksIHRib2R5LCBsZW4sIGhhbmRsZVNjcmlwdCwganNUYWdzLAoJCQlpID0gMCwKCQkJcmV0ID0gW107CgoJCS8vIEVuc3VyZSB0aGF0IGNvbnRleHQgaXMgYSBkb2N1bWVudAoJCWlmICggIWNvbnRleHQgfHwgdHlwZW9mIGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCWNvbnRleHQgPSBkb2N1bWVudDsKCQl9CgoJCS8vIFVzZSB0aGUgYWxyZWFkeS1jcmVhdGVkIHNhZmUgZnJhZ21lbnQgaWYgY29udGV4dCBwZXJtaXRzCgkJZm9yICggc2FmZSA9IGNvbnRleHQgPT09IGRvY3VtZW50ICYmIHNhZmVGcmFnbWVudDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQlpZiAoIHR5cGVvZiBlbGVtID09PSAibnVtYmVyIiApIHsKCQkJCWVsZW0gKz0gIiI7CgkJCX0KCgkJCWlmICggIWVsZW0gKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gQ29udmVydCBodG1sIHN0cmluZyBpbnRvIERPTSBub2RlcwoJCQlpZiAoIHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiApIHsKCQkJCWlmICggIXJodG1sLnRlc3QoIGVsZW0gKSApIHsKCQkJCQllbGVtID0gY29udGV4dC5jcmVhdGVUZXh0Tm9kZSggZWxlbSApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBFbnN1cmUgYSBzYWZlIGNvbnRhaW5lciBpbiB3aGljaCB0byByZW5kZXIgdGhlIGh0bWwKCQkJCQlzYWZlID0gc2FmZSB8fCBjcmVhdGVTYWZlRnJhZ21lbnQoIGNvbnRleHQgKTsKCQkJCQlkaXYgPSBkaXYgfHwgc2FmZS5hcHBlbmRDaGlsZCggY29udGV4dC5jcmVhdGVFbGVtZW50KCJkaXYiKSApOwoKCQkJCQkvLyBGaXggIlhIVE1MIi1zdHlsZSB0YWdzIGluIGFsbCBicm93c2VycwoJCQkJCWVsZW0gPSBlbGVtLnJlcGxhY2UocnhodG1sVGFnLCAiPCQxPjwvJDI+Iik7CgoJCQkJCS8vIEdvIHRvIGh0bWwgYW5kIGJhY2ssIHRoZW4gcGVlbCBvZmYgZXh0cmEgd3JhcHBlcnMKCQkJCQl0YWcgPSAoIHJ0YWdOYW1lLmV4ZWMoIGVsZW0gKSB8fCBbIiIsICIiXSApWzFdLnRvTG93ZXJDYXNlKCk7CgkJCQkJd3JhcCA9IHdyYXBNYXBbIHRhZyBdIHx8IHdyYXBNYXAuX2RlZmF1bHQ7CgkJCQkJZGVwdGggPSB3cmFwWzBdOwoJCQkJCWRpdi5pbm5lckhUTUwgPSB3cmFwWzFdICsgZWxlbSArIHdyYXBbMl07CgoJCQkJCS8vIE1vdmUgdG8gdGhlIHJpZ2h0IGRlcHRoCgkJCQkJd2hpbGUgKCBkZXB0aC0tICkgewoJCQkJCQlkaXYgPSBkaXYubGFzdENoaWxkOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIElFJ3MgYXV0b2luc2VydGVkIDx0Ym9keT4gZnJvbSB0YWJsZSBmcmFnbWVudHMKCQkJCQlpZiAoICFqUXVlcnkuc3VwcG9ydC50Ym9keSApIHsKCgkJCQkJCS8vIFN0cmluZyB3YXMgYSA8dGFibGU+LCAqbWF5KiBoYXZlIHNwdXJpb3VzIDx0Ym9keT4KCQkJCQkJaGFzQm9keSA9IHJ0Ym9keS50ZXN0KGVsZW0pOwoJCQkJCQkJdGJvZHkgPSB0YWcgPT09ICJ0YWJsZSIgJiYgIWhhc0JvZHkgPwoJCQkJCQkJCWRpdi5maXJzdENoaWxkICYmIGRpdi5maXJzdENoaWxkLmNoaWxkTm9kZXMgOgoKCQkJCQkJCQkvLyBTdHJpbmcgd2FzIGEgYmFyZSA8dGhlYWQ+IG9yIDx0Zm9vdD4KCQkJCQkJCQl3cmFwWzFdID09PSAiPHRhYmxlPiIgJiYgIWhhc0JvZHkgPwoJCQkJCQkJCQlkaXYuY2hpbGROb2RlcyA6CgkJCQkJCQkJCVtdOwoKCQkJCQkJZm9yICggaiA9IHRib2R5Lmxlbmd0aCAtIDE7IGogPj0gMCA7IC0taiApIHsKCQkJCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCB0Ym9keVsgaiBdLCAidGJvZHkiICkgJiYgIXRib2R5WyBqIF0uY2hpbGROb2Rlcy5sZW5ndGggKSB7CgkJCQkJCQkJdGJvZHlbIGogXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0Ym9keVsgaiBdICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIElFIGNvbXBsZXRlbHkga2lsbHMgbGVhZGluZyB3aGl0ZXNwYWNlIHdoZW4gaW5uZXJIVE1MIGlzIHVzZWQKCQkJCQlpZiAoICFqUXVlcnkuc3VwcG9ydC5sZWFkaW5nV2hpdGVzcGFjZSAmJiBybGVhZGluZ1doaXRlc3BhY2UudGVzdCggZWxlbSApICkgewoJCQkJCQlkaXYuaW5zZXJ0QmVmb3JlKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBybGVhZGluZ1doaXRlc3BhY2UuZXhlYyhlbGVtKVswXSApLCBkaXYuZmlyc3RDaGlsZCApOwoJCQkJCX0KCgkJCQkJZWxlbSA9IGRpdi5jaGlsZE5vZGVzOwoKCQkJCQkvLyBSZW1lbWJlciB0aGUgdG9wLWxldmVsIGNvbnRhaW5lciBmb3IgcHJvcGVyIGNsZWFudXAKCQkJCQlkaXYgPSBzYWZlLmxhc3RDaGlsZDsKCQkJCX0KCQkJfQoKCQkJaWYgKCBlbGVtLm5vZGVUeXBlICkgewoJCQkJcmV0LnB1c2goIGVsZW0gKTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IGpRdWVyeS5tZXJnZSggcmV0LCBlbGVtICk7CgkJCX0KCQl9CgoJCS8vIEZpeCAjMTEzNTY6IENsZWFyIGVsZW1lbnRzIGZyb20gc2FmZUZyYWdtZW50CgkJaWYgKCBkaXYgKSB7CgkJCXNhZmUucmVtb3ZlQ2hpbGQoIGRpdiApOwoJCQllbGVtID0gZGl2ID0gc2FmZSA9IG51bGw7CgkJfQoKCQkvLyBSZXNldCBkZWZhdWx0Q2hlY2tlZCBmb3IgYW55IHJhZGlvcyBhbmQgY2hlY2tib3hlcwoJCS8vIGFib3V0IHRvIGJlIGFwcGVuZGVkIHRvIHRoZSBET00gaW4gSUUgNi83ICgjODA2MCkKCQlpZiAoICFqUXVlcnkuc3VwcG9ydC5hcHBlbmRDaGVja2VkICkgewoJCQlmb3IgKCBpID0gMDsgKGVsZW0gPSByZXRbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaW5wdXQiICkgKSB7CgkJCQkJZml4RGVmYXVsdENoZWNrZWQoIGVsZW0gKTsKCQkJCX0gZWxzZSBpZiAoIHR5cGVvZiBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSAidW5kZWZpbmVkIiApIHsKCQkJCQlqUXVlcnkuZ3JlcCggZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaW5wdXQiKSwgZml4RGVmYXVsdENoZWNrZWQgKTsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gQXBwZW5kIGVsZW1lbnRzIHRvIGEgcHJvdmlkZWQgZG9jdW1lbnQgZnJhZ21lbnQKCQlpZiAoIGZyYWdtZW50ICkgewoJCQkvLyBTcGVjaWFsIGhhbmRsaW5nIG9mIGVhY2ggc2NyaXB0IGVsZW1lbnQKCQkJaGFuZGxlU2NyaXB0ID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkvLyBDaGVjayBpZiB3ZSBjb25zaWRlciBpdCBleGVjdXRhYmxlCgkJCQlpZiAoICFlbGVtLnR5cGUgfHwgcnNjcmlwdFR5cGUudGVzdCggZWxlbS50eXBlICkgKSB7CgkJCQkJLy8gRGV0YWNoIHRoZSBzY3JpcHQgYW5kIHN0b3JlIGl0IGluIHRoZSBzY3JpcHRzIGFycmF5IChpZiBwcm92aWRlZCkgb3IgdGhlIGZyYWdtZW50CgkJCQkJLy8gUmV0dXJuIHRydXRoeSB0byBpbmRpY2F0ZSB0aGF0IGl0IGhhcyBiZWVuIGhhbmRsZWQKCQkJCQlyZXR1cm4gc2NyaXB0cyA/CgkJCQkJCXNjcmlwdHMucHVzaCggZWxlbS5wYXJlbnROb2RlID8gZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBlbGVtICkgOiBlbGVtICkgOgoJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZWxlbSApOwoJCQkJfQoJCQl9OwoKCQkJZm9yICggaSA9IDA7IChlbGVtID0gcmV0W2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCQkvLyBDaGVjayBpZiB3ZSdyZSBkb25lIGFmdGVyIGhhbmRsaW5nIGFuIGV4ZWN1dGFibGUgc2NyaXB0CgkJCQlpZiAoICEoIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgInNjcmlwdCIgKSAmJiBoYW5kbGVTY3JpcHQoIGVsZW0gKSApICkgewoJCQkJCS8vIEFwcGVuZCB0byBmcmFnbWVudCBhbmQgaGFuZGxlIGVtYmVkZGVkIHNjcmlwdHMKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZWxlbSApOwoJCQkJCWlmICggdHlwZW9mIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICkgewoJCQkJCQkvLyBoYW5kbGVTY3JpcHQgYWx0ZXJzIHRoZSBET00sIHNvIHVzZSBqUXVlcnkubWVyZ2UgdG8gZW5zdXJlIHNuYXBzaG90IGl0ZXJhdGlvbgoJCQkJCQlqc1RhZ3MgPSBqUXVlcnkuZ3JlcCggalF1ZXJ5Lm1lcmdlKCBbXSwgZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0IikgKSwgaGFuZGxlU2NyaXB0ICk7CgoJCQkJCQkvLyBTcGxpY2UgdGhlIHNjcmlwdHMgaW50byByZXQgYWZ0ZXIgdGhlaXIgZm9ybWVyIGFuY2VzdG9yIGFuZCBhZHZhbmNlIG91ciBpbmRleCBiZXlvbmQgdGhlbQoJCQkJCQlyZXQuc3BsaWNlLmFwcGx5KCByZXQsIFtpICsgMSwgMF0uY29uY2F0KCBqc1RhZ3MgKSApOwoJCQkJCQlpICs9IGpzVGFncy5sZW5ndGg7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCgljbGVhbkRhdGE6IGZ1bmN0aW9uKCBlbGVtcywgLyogaW50ZXJuYWwgKi8gYWNjZXB0RGF0YSApIHsKCQl2YXIgZGF0YSwgaWQsIGVsZW0sIHR5cGUsCgkJCWkgPSAwLAoJCQlpbnRlcm5hbEtleSA9IGpRdWVyeS5leHBhbmRvLAoJCQljYWNoZSA9IGpRdWVyeS5jYWNoZSwKCQkJZGVsZXRlRXhwYW5kbyA9IGpRdWVyeS5zdXBwb3J0LmRlbGV0ZUV4cGFuZG8sCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbDsKCgkJZm9yICggOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgoJCQlpZiAoIGFjY2VwdERhdGEgfHwgalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsKCgkJCQlpZCA9IGVsZW1bIGludGVybmFsS2V5IF07CgkJCQlkYXRhID0gaWQgJiYgY2FjaGVbIGlkIF07CgoJCQkJaWYgKCBkYXRhICkgewoJCQkJCWlmICggZGF0YS5ldmVudHMgKSB7CgkJCQkJCWZvciAoIHR5cGUgaW4gZGF0YS5ldmVudHMgKSB7CgkJCQkJCQlpZiAoIHNwZWNpYWxbIHR5cGUgXSApIHsKCQkJCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICk7CgoJCQkJCQkJLy8gVGhpcyBpcyBhIHNob3J0Y3V0IHRvIGF2b2lkIGpRdWVyeS5ldmVudC5yZW1vdmUncyBvdmVyaGVhZAoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlqUXVlcnkucmVtb3ZlRXZlbnQoIGVsZW0sIHR5cGUsIGRhdGEuaGFuZGxlICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBjYWNoZSBvbmx5IGlmIGl0IHdhcyBub3QgYWxyZWFkeSByZW1vdmVkIGJ5IGpRdWVyeS5ldmVudC5yZW1vdmUKCQkJCQlpZiAoIGNhY2hlWyBpZCBdICkgewoKCQkJCQkJZGVsZXRlIGNhY2hlWyBpZCBdOwoKCQkJCQkJLy8gSUUgZG9lcyBub3QgYWxsb3cgdXMgdG8gZGVsZXRlIGV4cGFuZG8gcHJvcGVydGllcyBmcm9tIG5vZGVzLAoJCQkJCQkvLyBub3IgZG9lcyBpdCBoYXZlIGEgcmVtb3ZlQXR0cmlidXRlIGZ1bmN0aW9uIG9uIERvY3VtZW50IG5vZGVzOwoJCQkJCQkvLyB3ZSBtdXN0IGhhbmRsZSBhbGwgb2YgdGhlc2UgY2FzZXMKCQkJCQkJaWYgKCBkZWxldGVFeHBhbmRvICkgewoJCQkJCQkJZGVsZXRlIGVsZW1bIGludGVybmFsS2V5IF07CgoJCQkJCQl9IGVsc2UgaWYgKCBlbGVtLnJlbW92ZUF0dHJpYnV0ZSApIHsKCQkJCQkJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCBpbnRlcm5hbEtleSApOwoKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWVsZW1bIGludGVybmFsS2V5IF0gPSBudWxsOwoJCQkJCQl9CgoJCQkJCQlqUXVlcnkuZGVsZXRlZElkcy5wdXNoKCBpZCApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KfSk7Ci8vIExpbWl0IHNjb3BlIHBvbGx1dGlvbiBmcm9tIGFueSBkZXByZWNhdGVkIEFQSQooZnVuY3Rpb24oKSB7Cgp2YXIgbWF0Y2hlZCwgYnJvd3NlcjsKCi8vIFVzZSBvZiBqUXVlcnkuYnJvd3NlciBpcyBmcm93bmVkIHVwb24uCi8vIE1vcmUgZGV0YWlsczogaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS5icm93c2VyCi8vIGpRdWVyeS51YU1hdGNoIG1haW50YWluZWQgZm9yIGJhY2stY29tcGF0CmpRdWVyeS51YU1hdGNoID0gZnVuY3Rpb24oIHVhICkgewoJdWEgPSB1YS50b0xvd2VyQ2FzZSgpOwoKCXZhciBtYXRjaCA9IC8oY2hyb21lKVsgXC9dKFtcdy5dKykvLmV4ZWMoIHVhICkgfHwKCQkvKHdlYmtpdClbIFwvXShbXHcuXSspLy5leGVjKCB1YSApIHx8CgkJLyhvcGVyYSkoPzouKnZlcnNpb258KVsgXC9dKFtcdy5dKykvLmV4ZWMoIHVhICkgfHwKCQkvKG1zaWUpIChbXHcuXSspLy5leGVjKCB1YSApIHx8CgkJdWEuaW5kZXhPZigiY29tcGF0aWJsZSIpIDwgMCAmJiAvKG1vemlsbGEpKD86Lio/IHJ2OihbXHcuXSspfCkvLmV4ZWMoIHVhICkgfHwKCQlbXTsKCglyZXR1cm4gewoJCWJyb3dzZXI6IG1hdGNoWyAxIF0gfHwgIiIsCgkJdmVyc2lvbjogbWF0Y2hbIDIgXSB8fCAiMCIKCX07Cn07CgptYXRjaGVkID0galF1ZXJ5LnVhTWF0Y2goIG5hdmlnYXRvci51c2VyQWdlbnQgKTsKYnJvd3NlciA9IHt9OwoKaWYgKCBtYXRjaGVkLmJyb3dzZXIgKSB7Cglicm93c2VyWyBtYXRjaGVkLmJyb3dzZXIgXSA9IHRydWU7Cglicm93c2VyLnZlcnNpb24gPSBtYXRjaGVkLnZlcnNpb247Cn0KCi8vIERlcHJlY2F0ZWQsIHVzZSBqUXVlcnkuYnJvd3Nlci53ZWJraXQgaW5zdGVhZAovLyBNYWludGFpbmVkIGZvciBiYWNrLWNvbXBhdCBvbmx5CmlmICggYnJvd3Nlci53ZWJraXQgKSB7Cglicm93c2VyLnNhZmFyaSA9IHRydWU7Cn0KCmpRdWVyeS5icm93c2VyID0gYnJvd3NlcjsKCmpRdWVyeS5zdWIgPSBmdW5jdGlvbigpIHsKCWZ1bmN0aW9uIGpRdWVyeVN1Yiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJcmV0dXJuIG5ldyBqUXVlcnlTdWIuZm4uaW5pdCggc2VsZWN0b3IsIGNvbnRleHQgKTsKCX0KCWpRdWVyeS5leHRlbmQoIHRydWUsIGpRdWVyeVN1YiwgdGhpcyApOwoJalF1ZXJ5U3ViLnN1cGVyY2xhc3MgPSB0aGlzOwoJalF1ZXJ5U3ViLmZuID0galF1ZXJ5U3ViLnByb3RvdHlwZSA9IHRoaXMoKTsKCWpRdWVyeVN1Yi5mbi5jb25zdHJ1Y3RvciA9IGpRdWVyeVN1YjsKCWpRdWVyeVN1Yi5zdWIgPSB0aGlzLnN1YjsKCWpRdWVyeVN1Yi5mbi5pbml0ID0gZnVuY3Rpb24gaW5pdCggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJaWYgKCBjb250ZXh0ICYmIGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgJiYgIShjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5U3ViKSApIHsKCQkJY29udGV4dCA9IGpRdWVyeVN1YiggY29udGV4dCApOwoJCX0KCgkJcmV0dXJuIGpRdWVyeS5mbi5pbml0LmNhbGwoIHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCByb290alF1ZXJ5U3ViICk7Cgl9OwoJalF1ZXJ5U3ViLmZuLmluaXQucHJvdG90eXBlID0galF1ZXJ5U3ViLmZuOwoJdmFyIHJvb3RqUXVlcnlTdWIgPSBqUXVlcnlTdWIoZG9jdW1lbnQpOwoJcmV0dXJuIGpRdWVyeVN1YjsKfTsKCQp9KSgpOwp2YXIgY3VyQ1NTLCBpZnJhbWUsIGlmcmFtZURvYywKCXJhbHBoYSA9IC9hbHBoYVwoW14pXSpcKS9pLAoJcm9wYWNpdHkgPSAvb3BhY2l0eT0oW14pXSopLywKCXJwb3NpdGlvbiA9IC9eKHRvcHxyaWdodHxib3R0b218bGVmdCkkLywKCXJtYXJnaW4gPSAvXm1hcmdpbi8sCglybnVtc3BsaXQgPSBuZXcgUmVnRXhwKCAiXigiICsgY29yZV9wbnVtICsgIikoLiopJCIsICJpIiApLAoJcm51bW5vbnB4ID0gbmV3IFJlZ0V4cCggIl4oIiArIGNvcmVfcG51bSArICIpKD8hcHgpW2EteiVdKyQiLCAiaSIgKSwKCXJyZWxOdW0gPSBuZXcgUmVnRXhwKCAiXihbLStdKT0oIiArIGNvcmVfcG51bSArICIpIiwgImkiICksCgllbGVtZGlzcGxheSA9IHt9LAoKCWNzc1Nob3cgPSB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCB2aXNpYmlsaXR5OiAiaGlkZGVuIiwgZGlzcGxheTogImJsb2NrIiB9LAoJY3NzTm9ybWFsVHJhbnNmb3JtID0gewoJCWxldHRlclNwYWNpbmc6IDAsCgkJZm9udFdlaWdodDogNDAwLAoJCWxpbmVIZWlnaHQ6IDEKCX0sCgoJY3NzRXhwYW5kID0gWyAiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0IiBdLAoJY3NzUHJlZml4ZXMgPSBbICJXZWJraXQiLCAiTyIsICJNb3oiLCAibXMiIF0sCgoJZXZlbnRzVG9nZ2xlID0galF1ZXJ5LmZuLnRvZ2dsZTsKCi8vIHJldHVybiBhIGNzcyBwcm9wZXJ0eSBtYXBwZWQgdG8gYSBwb3RlbnRpYWxseSB2ZW5kb3IgcHJlZml4ZWQgcHJvcGVydHkKZnVuY3Rpb24gdmVuZG9yUHJvcE5hbWUoIHN0eWxlLCBuYW1lICkgewoKCS8vIHNob3J0Y3V0IGZvciBuYW1lcyB0aGF0IGFyZSBub3QgdmVuZG9yIHByZWZpeGVkCglpZiAoIG5hbWUgaW4gc3R5bGUgKSB7CgkJcmV0dXJuIG5hbWU7Cgl9CgoJLy8gY2hlY2sgZm9yIHZlbmRvciBwcmVmaXhlZCBuYW1lcwoJdmFyIGNhcE5hbWUgPSBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwKCQlvcmlnTmFtZSA9IG5hbWUsCgkJaSA9IGNzc1ByZWZpeGVzLmxlbmd0aDsKCgl3aGlsZSAoIGktLSApIHsKCQluYW1lID0gY3NzUHJlZml4ZXNbIGkgXSArIGNhcE5hbWU7CgkJaWYgKCBuYW1lIGluIHN0eWxlICkgewoJCQlyZXR1cm4gbmFtZTsKCQl9Cgl9CgoJcmV0dXJuIG9yaWdOYW1lOwp9CgpmdW5jdGlvbiBpc0hpZGRlbiggZWxlbSwgZWwgKSB7CgllbGVtID0gZWwgfHwgZWxlbTsKCXJldHVybiBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSA9PT0gIm5vbmUiIHx8ICFqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApOwp9CgpmdW5jdGlvbiBzaG93SGlkZSggZWxlbWVudHMsIHNob3cgKSB7Cgl2YXIgZWxlbSwgZGlzcGxheSwKCQl2YWx1ZXMgPSBbXSwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwoKCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwoJCWlmICggIWVsZW0uc3R5bGUgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQl2YWx1ZXNbIGluZGV4IF0gPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiApOwoJCWlmICggc2hvdyApIHsKCQkJLy8gUmVzZXQgdGhlIGlubGluZSBkaXNwbGF5IG9mIHRoaXMgZWxlbWVudCB0byBsZWFybiBpZiBpdCBpcwoJCQkvLyBiZWluZyBoaWRkZW4gYnkgY2FzY2FkZWQgcnVsZXMgb3Igbm90CgkJCWlmICggIXZhbHVlc1sgaW5kZXggXSAmJiBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIiApIHsKCQkJCWVsZW0uc3R5bGUuZGlzcGxheSA9ICIiOwoJCQl9CgoJCQkvLyBTZXQgZWxlbWVudHMgd2hpY2ggaGF2ZSBiZWVuIG92ZXJyaWRkZW4gd2l0aCBkaXNwbGF5OiBub25lCgkJCS8vIGluIGEgc3R5bGVzaGVldCB0byB3aGF0ZXZlciB0aGUgZGVmYXVsdCBicm93c2VyIHN0eWxlIGlzCgkJCS8vIGZvciBzdWNoIGFuIGVsZW1lbnQKCQkJaWYgKCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmIGlzSGlkZGVuKCBlbGVtICkgKSB7CgkJCQl2YWx1ZXNbIGluZGV4IF0gPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiwgY3NzX2RlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpICk7CgkJCX0KCQl9IGVsc2UgewoJCQlkaXNwbGF5ID0gY3VyQ1NTKCBlbGVtLCAiZGlzcGxheSIgKTsKCgkJCWlmICggIXZhbHVlc1sgaW5kZXggXSAmJiBkaXNwbGF5ICE9PSAibm9uZSIgKSB7CgkJCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiwgZGlzcGxheSApOwoJCQl9CgkJfQoJfQoKCS8vIFNldCB0aGUgZGlzcGxheSBvZiBtb3N0IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wCgkvLyB0byBhdm9pZCB0aGUgY29uc3RhbnQgcmVmbG93Cglmb3IgKCBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCWVsZW0gPSBlbGVtZW50c1sgaW5kZXggXTsKCQlpZiAoICFlbGVtLnN0eWxlICkgewoJCQljb250aW51ZTsKCQl9CgkJaWYgKCAhc2hvdyB8fCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIiB8fCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICkgewoJCQllbGVtLnN0eWxlLmRpc3BsYXkgPSBzaG93ID8gdmFsdWVzWyBpbmRleCBdIHx8ICIiIDogIm5vbmUiOwoJCX0KCX0KCglyZXR1cm4gZWxlbWVudHM7Cn0KCmpRdWVyeS5mbi5leHRlbmQoewoJY3NzOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSApIHsKCQkJcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPwoJCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCBuYW1lLCB2YWx1ZSApIDoKCQkJCWpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKTsKCQl9LCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsKCX0sCglzaG93OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gc2hvd0hpZGUoIHRoaXMsIHRydWUgKTsKCX0sCgloaWRlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gc2hvd0hpZGUoIHRoaXMgKTsKCX0sCgl0b2dnbGU6IGZ1bmN0aW9uKCBzdGF0ZSwgZm4yICkgewoJCXZhciBib29sID0gdHlwZW9mIHN0YXRlID09PSAiYm9vbGVhbiI7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHN0YXRlICkgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIGZuMiApICkgewoJCQlyZXR1cm4gZXZlbnRzVG9nZ2xlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggYm9vbCA/IHN0YXRlIDogaXNIaWRkZW4oIHRoaXMgKSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnNob3coKTsKCQkJfSBlbHNlIHsKCQkJCWpRdWVyeSggdGhpcyApLmhpZGUoKTsKCQkJfQoJCX0pOwoJfQp9KTsKCmpRdWVyeS5leHRlbmQoewoJLy8gQWRkIGluIHN0eWxlIHByb3BlcnR5IGhvb2tzIGZvciBvdmVycmlkaW5nIHRoZSBkZWZhdWx0CgkvLyBiZWhhdmlvciBvZiBnZXR0aW5nIGFuZCBzZXR0aW5nIGEgc3R5bGUgcHJvcGVydHkKCWNzc0hvb2tzOiB7CgkJb3BhY2l0eTogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQkJLy8gV2Ugc2hvdWxkIGFsd2F5cyBnZXQgYSBudW1iZXIgYmFjayBmcm9tIG9wYWNpdHkKCQkJCQl2YXIgcmV0ID0gY3VyQ1NTKCBlbGVtLCAib3BhY2l0eSIgKTsKCQkJCQlyZXR1cm4gcmV0ID09PSAiIiA/ICIxIiA6IHJldDsKCgkJCQl9CgkJCX0KCQl9Cgl9LAoKCS8vIEV4Y2x1ZGUgdGhlIGZvbGxvd2luZyBjc3MgcHJvcGVydGllcyB0byBhZGQgcHgKCWNzc051bWJlcjogewoJCSJmaWxsT3BhY2l0eSI6IHRydWUsCgkJImZvbnRXZWlnaHQiOiB0cnVlLAoJCSJsaW5lSGVpZ2h0IjogdHJ1ZSwKCQkib3BhY2l0eSI6IHRydWUsCgkJIm9ycGhhbnMiOiB0cnVlLAoJCSJ3aWRvd3MiOiB0cnVlLAoJCSJ6SW5kZXgiOiB0cnVlLAoJCSJ6b29tIjogdHJ1ZQoJfSwKCgkvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCgkvLyBzZXR0aW5nIG9yIGdldHRpbmcgdGhlIHZhbHVlCgljc3NQcm9wczogewoJCS8vIG5vcm1hbGl6ZSBmbG9hdCBjc3MgcHJvcGVydHkKCQkiZmxvYXQiOiBqUXVlcnkuc3VwcG9ydC5jc3NGbG9hdCA/ICJjc3NGbG9hdCIgOiAic3R5bGVGbG9hdCIKCX0sCgoJLy8gR2V0IGFuZCBzZXQgdGhlIHN0eWxlIHByb3BlcnR5IG9uIGEgRE9NIE5vZGUKCXN0eWxlOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUsIGV4dHJhICkgewoJCS8vIERvbid0IHNldCBzdHlsZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggIWVsZW0gfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4IHx8ICFlbGVtLnN0eWxlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKCQl2YXIgcmV0LCB0eXBlLCBob29rcywKCQkJb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICksCgkJCXN0eWxlID0gZWxlbS5zdHlsZTsKCgkJbmFtZSA9IGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSB8fCAoIGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSA9IHZlbmRvclByb3BOYW1lKCBzdHlsZSwgb3JpZ05hbWUgKSApOwoKCQkvLyBnZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uCgkJLy8gZm9sbG93ZWQgYnkgdGhlIHVucHJlZml4ZWQgdmVyc2lvbgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKCQkvLyBDaGVjayBpZiB3ZSdyZSBzZXR0aW5nIGEgdmFsdWUKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCXR5cGUgPSB0eXBlb2YgdmFsdWU7CgoJCQkvLyBjb252ZXJ0IHJlbGF0aXZlIG51bWJlciBzdHJpbmdzICgrPSBvciAtPSkgdG8gcmVsYXRpdmUgbnVtYmVycy4gIzczNDUKCQkJaWYgKCB0eXBlID09PSAic3RyaW5nIiAmJiAocmV0ID0gcnJlbE51bS5leGVjKCB2YWx1ZSApKSApIHsKCQkJCXZhbHVlID0gKCByZXRbMV0gKyAxICkgKiByZXRbMl0gKyBwYXJzZUZsb2F0KCBqUXVlcnkuY3NzKCBlbGVtLCBuYW1lICkgKTsKCQkJCS8vIEZpeGVzIGJ1ZyAjOTIzNwoJCQkJdHlwZSA9ICJudW1iZXIiOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhhdCBOYU4gYW5kIG51bGwgdmFsdWVzIGFyZW4ndCBzZXQuIFNlZTogIzcxMTYKCQkJaWYgKCB2YWx1ZSA9PSBudWxsIHx8IHR5cGUgPT09ICJudW1iZXIiICYmIGlzTmFOKCB2YWx1ZSApICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiBhIG51bWJlciB3YXMgcGFzc2VkIGluLCBhZGQgJ3B4JyB0byB0aGUgKGV4Y2VwdCBmb3IgY2VydGFpbiBDU1MgcHJvcGVydGllcykKCQkJaWYgKCB0eXBlID09PSAibnVtYmVyIiAmJiAhalF1ZXJ5LmNzc051bWJlclsgb3JpZ05hbWUgXSApIHsKCQkJCXZhbHVlICs9ICJweCI7CgkJCX0KCgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQsIHVzZSB0aGF0IHZhbHVlLCBvdGhlcndpc2UganVzdCBzZXQgdGhlIHNwZWNpZmllZCB2YWx1ZQoJCQlpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCAodmFsdWUgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBleHRyYSApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gV3JhcHBlZCB0byBwcmV2ZW50IElFIGZyb20gdGhyb3dpbmcgZXJyb3JzIHdoZW4gJ2ludmFsaWQnIHZhbHVlcyBhcmUgcHJvdmlkZWQKCQkJCS8vIEZpeGVzIGJ1ZyAjNTUwOQoJCQkJdHJ5IHsKCQkJCQlzdHlsZVsgbmFtZSBdID0gdmFsdWU7CgkJCQl9IGNhdGNoKGUpIHt9CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIG5vbi1jb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCgkJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgZmFsc2UsIGV4dHJhICkpICE9PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gcmV0OwoJCQl9CgoJCQkvLyBPdGhlcndpc2UganVzdCBnZXQgdGhlIHZhbHVlIGZyb20gdGhlIHN0eWxlIG9iamVjdAoJCQlyZXR1cm4gc3R5bGVbIG5hbWUgXTsKCQl9Cgl9LAoKCWNzczogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIG51bWVyaWMsIGV4dHJhICkgewoJCXZhciB2YWwsIG51bSwgaG9va3MsCgkJCW9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApOwoKCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKCQluYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdIHx8ICggalF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIGVsZW0uc3R5bGUsIG9yaWdOYW1lICkgKTsKCgkJLy8gZ2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbgoJCS8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdIHx8IGpRdWVyeS5jc3NIb29rc1sgb3JpZ05hbWUgXTsKCgkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICkgewoJCQl2YWwgPSBob29rcy5nZXQoIGVsZW0sIHRydWUsIGV4dHJhICk7CgkJfQoKCQkvLyBPdGhlcndpc2UsIGlmIGEgd2F5IHRvIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZXhpc3RzLCB1c2UgdGhhdAoJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CgkJCXZhbCA9IGN1ckNTUyggZWxlbSwgbmFtZSApOwoJCX0KCgkJLy9jb252ZXJ0ICJub3JtYWwiIHRvIGNvbXB1dGVkIHZhbHVlCgkJaWYgKCB2YWwgPT09ICJub3JtYWwiICYmIG5hbWUgaW4gY3NzTm9ybWFsVHJhbnNmb3JtICkgewoJCQl2YWwgPSBjc3NOb3JtYWxUcmFuc2Zvcm1bIG5hbWUgXTsKCQl9CgoJCS8vIFJldHVybiwgY29udmVydGluZyB0byBudW1iZXIgaWYgZm9yY2VkIG9yIGEgcXVhbGlmaWVyIHdhcyBwcm92aWRlZCBhbmQgdmFsIGxvb2tzIG51bWVyaWMKCQlpZiAoIG51bWVyaWMgfHwgZXh0cmEgIT09IHVuZGVmaW5lZCApIHsKCQkJbnVtID0gcGFyc2VGbG9hdCggdmFsICk7CgkJCXJldHVybiBudW1lcmljIHx8IGpRdWVyeS5pc051bWVyaWMoIG51bSApID8gbnVtIHx8IDAgOiB2YWw7CgkJfQoJCXJldHVybiB2YWw7Cgl9LAoKCS8vIEEgbWV0aG9kIGZvciBxdWlja2x5IHN3YXBwaW5nIGluL291dCBDU1MgcHJvcGVydGllcyB0byBnZXQgY29ycmVjdCBjYWxjdWxhdGlvbnMKCXN3YXA6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQl2YXIgcmV0LCBuYW1lLAoJCQlvbGQgPSB7fTsKCgkJLy8gUmVtZW1iZXIgdGhlIG9sZCB2YWx1ZXMsIGFuZCBpbnNlcnQgdGhlIG5ldyBvbmVzCgkJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCQlvbGRbIG5hbWUgXSA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKCQkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb3B0aW9uc1sgbmFtZSBdOwoJCX0KCgkJcmV0ID0gY2FsbGJhY2suY2FsbCggZWxlbSApOwoKCQkvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCWVsZW0uc3R5bGVbIG5hbWUgXSA9IG9sZFsgbmFtZSBdOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KfSk7CgovLyBOT1RFOiBUbyBhbnkgZnV0dXJlIG1haW50YWluZXIsIHdlJ3ZlIHVzZWQgYm90aCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZQovLyBhbmQgZ2V0Q29tcHV0ZWRTdHlsZSBoZXJlIHRvIHByb2R1Y2UgYSBiZXR0ZXIgZ3ppcCBzaXplCmlmICggd2luZG93LmdldENvbXB1dGVkU3R5bGUgKSB7CgljdXJDU1MgPSBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQl2YXIgcmV0LCB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLAoJCQljb21wdXRlZCA9IGdldENvbXB1dGVkU3R5bGUoIGVsZW0sIG51bGwgKSwKCQkJc3R5bGUgPSBlbGVtLnN0eWxlOwoKCQlpZiAoIGNvbXB1dGVkICkgewoKCQkJcmV0ID0gY29tcHV0ZWRbIG5hbWUgXTsKCQkJaWYgKCByZXQgPT09ICIiICYmICFqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGVsZW0gKSApIHsKCQkJCXJldCA9IGpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSApOwoJCQl9CgoJCQkvLyBBIHRyaWJ1dGUgdG8gdGhlICJhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzIgoJCQkvLyBDaHJvbWUgPCAxNyBhbmQgU2FmYXJpIDUuMCB1c2VzICJjb21wdXRlZCB2YWx1ZSIgaW5zdGVhZCBvZiAidXNlZCB2YWx1ZSIgZm9yIG1hcmdpbi1yaWdodAoJCQkvLyBTYWZhcmkgNS4xLjcgKGF0IGxlYXN0KSByZXR1cm5zIHBlcmNlbnRhZ2UgZm9yIGEgbGFyZ2VyIHNldCBvZiB2YWx1ZXMsIGJ1dCB3aWR0aCBzZWVtcyB0byBiZSByZWxpYWJseSBwaXhlbHMKCQkJLy8gdGhpcyBpcyBhZ2FpbnN0IHRoZSBDU1NPTSBkcmFmdCBzcGVjOiBodHRwOi8vZGV2LnczLm9yZy9jc3N3Zy9jc3NvbS8jcmVzb2x2ZWQtdmFsdWVzCgkJCWlmICggcm51bW5vbnB4LnRlc3QoIHJldCApICYmIHJtYXJnaW4udGVzdCggbmFtZSApICkgewoJCQkJd2lkdGggPSBzdHlsZS53aWR0aDsKCQkJCW1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CgkJCQltYXhXaWR0aCA9IHN0eWxlLm1heFdpZHRoOwoKCQkJCXN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsKCQkJCXJldCA9IGNvbXB1dGVkLndpZHRoOwoKCQkJCXN0eWxlLndpZHRoID0gd2lkdGg7CgkJCQlzdHlsZS5taW5XaWR0aCA9IG1pbldpZHRoOwoJCQkJc3R5bGUubWF4V2lkdGggPSBtYXhXaWR0aDsKCQkJfQoJCX0KCgkJcmV0dXJuIHJldDsKCX07Cn0gZWxzZSBpZiAoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jdXJyZW50U3R5bGUgKSB7CgljdXJDU1MgPSBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQl2YXIgbGVmdCwgcnNMZWZ0LAoJCQlyZXQgPSBlbGVtLmN1cnJlbnRTdHlsZSAmJiBlbGVtLmN1cnJlbnRTdHlsZVsgbmFtZSBdLAoJCQlzdHlsZSA9IGVsZW0uc3R5bGU7CgoJCS8vIEF2b2lkIHNldHRpbmcgcmV0IHRvIGVtcHR5IHN0cmluZyBoZXJlCgkJLy8gc28gd2UgZG9uJ3QgZGVmYXVsdCB0byBhdXRvCgkJaWYgKCByZXQgPT0gbnVsbCAmJiBzdHlsZSAmJiBzdHlsZVsgbmFtZSBdICkgewoJCQlyZXQgPSBzdHlsZVsgbmFtZSBdOwoJCX0KCgkJLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcwoJCS8vIGh0dHA6Ly9lcmlrLmVhZS5uZXQvYXJjaGl2ZXMvMjAwNy8wNy8yNy8xOC41NC4xNS8jY29tbWVudC0xMDIyOTEKCgkJLy8gSWYgd2UncmUgbm90IGRlYWxpbmcgd2l0aCBhIHJlZ3VsYXIgcGl4ZWwgbnVtYmVyCgkJLy8gYnV0IGEgbnVtYmVyIHRoYXQgaGFzIGEgd2VpcmQgZW5kaW5nLCB3ZSBuZWVkIHRvIGNvbnZlcnQgaXQgdG8gcGl4ZWxzCgkJLy8gYnV0IG5vdCBwb3NpdGlvbiBjc3MgYXR0cmlidXRlcywgYXMgdGhvc2UgYXJlIHByb3BvcnRpb25hbCB0byB0aGUgcGFyZW50IGVsZW1lbnQgaW5zdGVhZAoJCS8vIGFuZCB3ZSBjYW4ndCBtZWFzdXJlIHRoZSBwYXJlbnQgaW5zdGVhZCBiZWNhdXNlIGl0IG1pZ2h0IHRyaWdnZXIgYSAic3RhY2tpbmcgZG9sbHMiIHByb2JsZW0KCQlpZiAoIHJudW1ub25weC50ZXN0KCByZXQgKSAmJiAhcnBvc2l0aW9uLnRlc3QoIG5hbWUgKSApIHsKCgkJCS8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKCQkJbGVmdCA9IHN0eWxlLmxlZnQ7CgkJCXJzTGVmdCA9IGVsZW0ucnVudGltZVN0eWxlICYmIGVsZW0ucnVudGltZVN0eWxlLmxlZnQ7CgoJCQkvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CgkJCWlmICggcnNMZWZ0ICkgewoJCQkJZWxlbS5ydW50aW1lU3R5bGUubGVmdCA9IGVsZW0uY3VycmVudFN0eWxlLmxlZnQ7CgkJCX0KCQkJc3R5bGUubGVmdCA9IG5hbWUgPT09ICJmb250U2l6ZSIgPyAiMWVtIiA6IHJldDsKCQkJcmV0ID0gc3R5bGUucGl4ZWxMZWZ0ICsgInB4IjsKCgkJCS8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMKCQkJc3R5bGUubGVmdCA9IGxlZnQ7CgkJCWlmICggcnNMZWZ0ICkgewoJCQkJZWxlbS5ydW50aW1lU3R5bGUubGVmdCA9IHJzTGVmdDsKCQkJfQoJCX0KCgkJcmV0dXJuIHJldCA9PT0gIiIgPyAiYXV0byIgOiByZXQ7Cgl9Owp9CgpmdW5jdGlvbiBzZXRQb3NpdGl2ZU51bWJlciggZWxlbSwgdmFsdWUsIHN1YnRyYWN0ICkgewoJdmFyIG1hdGNoZXMgPSBybnVtc3BsaXQuZXhlYyggdmFsdWUgKTsKCXJldHVybiBtYXRjaGVzID8KCQkJTWF0aC5tYXgoIDAsIG1hdGNoZXNbIDEgXSAtICggc3VidHJhY3QgfHwgMCApICkgKyAoIG1hdGNoZXNbIDIgXSB8fCAicHgiICkgOgoJCQl2YWx1ZTsKfQoKZnVuY3Rpb24gYXVnbWVudFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhLCBpc0JvcmRlckJveCApIHsKCXZhciBpID0gZXh0cmEgPT09ICggaXNCb3JkZXJCb3ggPyAiYm9yZGVyIiA6ICJjb250ZW50IiApID8KCQkvLyBJZiB3ZSBhbHJlYWR5IGhhdmUgdGhlIHJpZ2h0IG1lYXN1cmVtZW50LCBhdm9pZCBhdWdtZW50YXRpb24KCQk0IDoKCQkvLyBPdGhlcndpc2UgaW5pdGlhbGl6ZSBmb3IgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbCBwcm9wZXJ0aWVzCgkJbmFtZSA9PT0gIndpZHRoIiA/IDEgOiAwLAoKCQl2YWwgPSAwOwoKCWZvciAoIDsgaSA8IDQ7IGkgKz0gMiApIHsKCQkvLyBib3RoIGJveCBtb2RlbHMgZXhjbHVkZSBtYXJnaW4sIHNvIGFkZCBpdCBpZiB3ZSB3YW50IGl0CgkJaWYgKCBleHRyYSA9PT0gIm1hcmdpbiIgKSB7CgkJCS8vIHdlIHVzZSBqUXVlcnkuY3NzIGluc3RlYWQgb2YgY3VyQ1NTIGhlcmUKCQkJLy8gYmVjYXVzZSBvZiB0aGUgcmVsaWFibGVNYXJnaW5SaWdodCBDU1MgaG9vayEKCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sIGV4dHJhICsgY3NzRXhwYW5kWyBpIF0sIHRydWUgKTsKCQl9CgoJCS8vIEZyb20gdGhpcyBwb2ludCBvbiB3ZSB1c2UgY3VyQ1NTIGZvciBtYXhpbXVtIHBlcmZvcm1hbmNlIChyZWxldmFudCBpbiBhbmltYXRpb25zKQoJCWlmICggaXNCb3JkZXJCb3ggKSB7CgkJCS8vIGJvcmRlci1ib3ggaW5jbHVkZXMgcGFkZGluZywgc28gcmVtb3ZlIGl0IGlmIHdlIHdhbnQgY29udGVudAoJCQlpZiAoIGV4dHJhID09PSAiY29udGVudCIgKSB7CgkJCQl2YWwgLT0gcGFyc2VGbG9hdCggY3VyQ1NTKCBlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbIGkgXSApICkgfHwgMDsKCQkJfQoKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgYm9yZGVyIG5vciBtYXJnaW4sIHNvIHJlbW92ZSBib3JkZXIKCQkJaWYgKCBleHRyYSAhPT0gIm1hcmdpbiIgKSB7CgkJCQl2YWwgLT0gcGFyc2VGbG9hdCggY3VyQ1NTKCBlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIiApICkgfHwgMDsKCQkJfQoJCX0gZWxzZSB7CgkJCS8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGNvbnRlbnQsIHNvIGFkZCBwYWRkaW5nCgkJCXZhbCArPSBwYXJzZUZsb2F0KCBjdXJDU1MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdICkgKSB8fCAwOwoKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCBub3IgcGFkZGluZywgc28gYWRkIGJvcmRlcgoJCQlpZiAoIGV4dHJhICE9PSAicGFkZGluZyIgKSB7CgkJCQl2YWwgKz0gcGFyc2VGbG9hdCggY3VyQ1NTKCBlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIiApICkgfHwgMDsKCQkJfQoJCX0KCX0KCglyZXR1cm4gdmFsOwp9CgpmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApIHsKCgkvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQoJdmFyIHZhbCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsCgkJdmFsdWVJc0JvcmRlckJveCA9IHRydWUsCgkJaXNCb3JkZXJCb3ggPSBqUXVlcnkuc3VwcG9ydC5ib3hTaXppbmcgJiYgalF1ZXJ5LmNzcyggZWxlbSwgImJveFNpemluZyIgKSA9PT0gImJvcmRlci1ib3giOwoKCWlmICggdmFsIDw9IDAgKSB7CgkJLy8gRmFsbCBiYWNrIHRvIGNvbXB1dGVkIHRoZW4gdW5jb21wdXRlZCBjc3MgaWYgbmVjZXNzYXJ5CgkJdmFsID0gY3VyQ1NTKCBlbGVtLCBuYW1lICk7CgkJaWYgKCB2YWwgPCAwIHx8IHZhbCA9PSBudWxsICkgewoJCQl2YWwgPSBlbGVtLnN0eWxlWyBuYW1lIF07CgkJfQoKCQkvLyBDb21wdXRlZCB1bml0IGlzIG5vdCBwaXhlbHMuIFN0b3AgaGVyZSBhbmQgcmV0dXJuLgoJCWlmICggcm51bW5vbnB4LnRlc3QodmFsKSApIHsKCQkJcmV0dXJuIHZhbDsKCQl9CgoJCS8vIHdlIG5lZWQgdGhlIGNoZWNrIGZvciBzdHlsZSBpbiBjYXNlIGEgYnJvd3NlciB3aGljaCByZXR1cm5zIHVucmVsaWFibGUgdmFsdWVzCgkJLy8gZm9yIGdldENvbXB1dGVkU3R5bGUgc2lsZW50bHkgZmFsbHMgYmFjayB0byB0aGUgcmVsaWFibGUgZWxlbS5zdHlsZQoJCXZhbHVlSXNCb3JkZXJCb3ggPSBpc0JvcmRlckJveCAmJiAoIGpRdWVyeS5zdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlIHx8IHZhbCA9PT0gZWxlbS5zdHlsZVsgbmFtZSBdICk7CgoJCS8vIE5vcm1hbGl6ZSAiIiwgYXV0bywgYW5kIHByZXBhcmUgZm9yIGV4dHJhCgkJdmFsID0gcGFyc2VGbG9hdCggdmFsICkgfHwgMDsKCX0KCgkvLyB1c2UgdGhlIGFjdGl2ZSBib3gtc2l6aW5nIG1vZGVsIHRvIGFkZC9zdWJ0cmFjdCBpcnJlbGV2YW50IHN0eWxlcwoJcmV0dXJuICggdmFsICsKCQlhdWdtZW50V2lkdGhPckhlaWdodCgKCQkJZWxlbSwKCQkJbmFtZSwKCQkJZXh0cmEgfHwgKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICksCgkJCXZhbHVlSXNCb3JkZXJCb3gKCQkpCgkpICsgInB4IjsKfQoKCi8vIFRyeSB0byBkZXRlcm1pbmUgdGhlIGRlZmF1bHQgZGlzcGxheSB2YWx1ZSBvZiBhbiBlbGVtZW50CmZ1bmN0aW9uIGNzc19kZWZhdWx0RGlzcGxheSggbm9kZU5hbWUgKSB7CglpZiAoIGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdICkgewoJCXJldHVybiBlbGVtZGlzcGxheVsgbm9kZU5hbWUgXTsKCX0KCgl2YXIgZWxlbSA9IGpRdWVyeSggIjwiICsgbm9kZU5hbWUgKyAiPiIgKS5hcHBlbmRUbyggZG9jdW1lbnQuYm9keSApLAoJCWRpc3BsYXkgPSBlbGVtLmNzcygiZGlzcGxheSIpOwoJZWxlbS5yZW1vdmUoKTsKCgkvLyBJZiB0aGUgc2ltcGxlIHdheSBmYWlscywKCS8vIGdldCBlbGVtZW50J3MgcmVhbCBkZWZhdWx0IGRpc3BsYXkgYnkgYXR0YWNoaW5nIGl0IHRvIGEgdGVtcCBpZnJhbWUKCWlmICggZGlzcGxheSA9PT0gIm5vbmUiIHx8IGRpc3BsYXkgPT09ICIiICkgewoJCS8vIFVzZSB0aGUgYWxyZWFkeS1jcmVhdGVkIGlmcmFtZSBpZiBwb3NzaWJsZQoJCWlmcmFtZSA9IGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoCgkJCWlmcmFtZSB8fCBqUXVlcnkuZXh0ZW5kKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpZnJhbWUiKSwgewoJCQkJZnJhbWVCb3JkZXI6IDAsCgkJCQl3aWR0aDogMCwKCQkJCWhlaWdodDogMAoJCQl9KQoJCSk7CgoJCS8vIENyZWF0ZSBhIGNhY2hlYWJsZSBjb3B5IG9mIHRoZSBpZnJhbWUgZG9jdW1lbnQgb24gZmlyc3QgY2FsbC4KCQkvLyBJRSBhbmQgT3BlcmEgd2lsbCBhbGxvdyB1cyB0byByZXVzZSB0aGUgaWZyYW1lRG9jIHdpdGhvdXQgcmUtd3JpdGluZyB0aGUgZmFrZSBIVE1MCgkJLy8gZG9jdW1lbnQgdG8gaXQ7IFdlYktpdCAmIEZpcmVmb3ggd29uJ3QgYWxsb3cgcmV1c2luZyB0aGUgaWZyYW1lIGRvY3VtZW50LgoJCWlmICggIWlmcmFtZURvYyB8fCAhaWZyYW1lLmNyZWF0ZUVsZW1lbnQgKSB7CgkJCWlmcmFtZURvYyA9ICggaWZyYW1lLmNvbnRlbnRXaW5kb3cgfHwgaWZyYW1lLmNvbnRlbnREb2N1bWVudCApLmRvY3VtZW50OwoJCQlpZnJhbWVEb2Mud3JpdGUoIjwhZG9jdHlwZSBodG1sPjxodG1sPjxib2R5PiIpOwoJCQlpZnJhbWVEb2MuY2xvc2UoKTsKCQl9CgoJCWVsZW0gPSBpZnJhbWVEb2MuYm9keS5hcHBlbmRDaGlsZCggaWZyYW1lRG9jLmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpICk7CgoJCWRpc3BsYXkgPSBjdXJDU1MoIGVsZW0sICJkaXNwbGF5IiApOwoJCWRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoIGlmcmFtZSApOwoJfQoKCS8vIFN0b3JlIHRoZSBjb3JyZWN0IGRlZmF1bHQgZGlzcGxheQoJZWxlbWRpc3BsYXlbIG5vZGVOYW1lIF0gPSBkaXNwbGF5OwoKCXJldHVybiBkaXNwbGF5Owp9CgpqUXVlcnkuZWFjaChbICJoZWlnaHQiLCAid2lkdGgiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJalF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gPSB7CgkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQsIGV4dHJhICkgewoJCQlpZiAoIGNvbXB1dGVkICkgewoJCQkJaWYgKCBlbGVtLm9mZnNldFdpZHRoICE9PSAwIHx8IGN1ckNTUyggZWxlbSwgImRpc3BsYXkiICkgIT09ICJub25lIiApIHsKCQkJCQlyZXR1cm4gZ2V0V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEgKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIGpRdWVyeS5zd2FwKCBlbGVtLCBjc3NTaG93LCBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9LAoKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgZXh0cmEgKSB7CgkJCXJldHVybiBzZXRQb3NpdGl2ZU51bWJlciggZWxlbSwgdmFsdWUsIGV4dHJhID8KCQkJCWF1Z21lbnRXaWR0aE9ySGVpZ2h0KAoJCQkJCWVsZW0sCgkJCQkJbmFtZSwKCQkJCQlleHRyYSwKCQkJCQlqUXVlcnkuc3VwcG9ydC5ib3hTaXppbmcgJiYgalF1ZXJ5LmNzcyggZWxlbSwgImJveFNpemluZyIgKSA9PT0gImJvcmRlci1ib3giCgkJCQkpIDogMAoJCQkpOwoJCX0KCX07Cn0pOwoKaWYgKCAhalF1ZXJ5LnN1cHBvcnQub3BhY2l0eSApIHsKCWpRdWVyeS5jc3NIb29rcy5vcGFjaXR5ID0gewoJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkvLyBJRSB1c2VzIGZpbHRlcnMgZm9yIG9wYWNpdHkKCQkJcmV0dXJuIHJvcGFjaXR5LnRlc3QoIChjb21wdXRlZCAmJiBlbGVtLmN1cnJlbnRTdHlsZSA/IGVsZW0uY3VycmVudFN0eWxlLmZpbHRlciA6IGVsZW0uc3R5bGUuZmlsdGVyKSB8fCAiIiApID8KCQkJCSggMC4wMSAqIHBhcnNlRmxvYXQoIFJlZ0V4cC4kMSApICkgKyAiIiA6CgkJCQljb21wdXRlZCA/ICIxIiA6ICIiOwoJCX0sCgoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQl2YXIgc3R5bGUgPSBlbGVtLnN0eWxlLAoJCQkJY3VycmVudFN0eWxlID0gZWxlbS5jdXJyZW50U3R5bGUsCgkJCQlvcGFjaXR5ID0galF1ZXJ5LmlzTnVtZXJpYyggdmFsdWUgKSA/ICJhbHBoYShvcGFjaXR5PSIgKyB2YWx1ZSAqIDEwMCArICIpIiA6ICIiLAoJCQkJZmlsdGVyID0gY3VycmVudFN0eWxlICYmIGN1cnJlbnRTdHlsZS5maWx0ZXIgfHwgc3R5bGUuZmlsdGVyIHx8ICIiOwoKCQkJLy8gSUUgaGFzIHRyb3VibGUgd2l0aCBvcGFjaXR5IGlmIGl0IGRvZXMgbm90IGhhdmUgbGF5b3V0CgkJCS8vIEZvcmNlIGl0IGJ5IHNldHRpbmcgdGhlIHpvb20gbGV2ZWwKCQkJc3R5bGUuem9vbSA9IDE7CgoJCQkvLyBpZiBzZXR0aW5nIG9wYWNpdHkgdG8gMSwgYW5kIG5vIG90aGVyIGZpbHRlcnMgZXhpc3QgLSBhdHRlbXB0IHRvIHJlbW92ZSBmaWx0ZXIgYXR0cmlidXRlICM2NjUyCgkJCWlmICggdmFsdWUgPj0gMSAmJiBqUXVlcnkudHJpbSggZmlsdGVyLnJlcGxhY2UoIHJhbHBoYSwgIiIgKSApID09PSAiIiApIHsKCgkJCQkvLyBTZXR0aW5nIHN0eWxlLmZpbHRlciB0byBudWxsLCAiIiAmICIgIiBzdGlsbCBsZWF2ZSAiZmlsdGVyOiIgaW4gdGhlIGNzc1RleHQKCQkJCS8vIGlmICJmaWx0ZXI6IiBpcyBwcmVzZW50IGF0IGFsbCwgY2xlYXJUeXBlIGlzIGRpc2FibGVkLCB3ZSB3YW50IHRvIGF2b2lkIHRoaXMKCQkJCS8vIHN0eWxlLnJlbW92ZUF0dHJpYnV0ZSBpcyBJRSBPbmx5LCBidXQgc28gYXBwYXJlbnRseSBpcyB0aGlzIGNvZGUgcGF0aC4uLgoJCQkJc3R5bGUucmVtb3ZlQXR0cmlidXRlKCAiZmlsdGVyIiApOwoKCQkJCS8vIGlmIHRoZXJlIHRoZXJlIGlzIG5vIGZpbHRlciBzdHlsZSBhcHBsaWVkIGluIGEgY3NzIHJ1bGUsIHdlIGFyZSBkb25lCgkJCQlpZiAoIGN1cnJlbnRTdHlsZSAmJiAhY3VycmVudFN0eWxlLmZpbHRlciApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIG90aGVyd2lzZSwgc2V0IG5ldyBmaWx0ZXIgdmFsdWVzCgkJCXN0eWxlLmZpbHRlciA9IHJhbHBoYS50ZXN0KCBmaWx0ZXIgKSA/CgkJCQlmaWx0ZXIucmVwbGFjZSggcmFscGhhLCBvcGFjaXR5ICkgOgoJCQkJZmlsdGVyICsgIiAiICsgb3BhY2l0eTsKCQl9Cgl9Owp9CgovLyBUaGVzZSBob29rcyBjYW5ub3QgYmUgYWRkZWQgdW50aWwgRE9NIHJlYWR5IGJlY2F1c2UgdGhlIHN1cHBvcnQgdGVzdAovLyBmb3IgaXQgaXMgbm90IHJ1biB1bnRpbCBhZnRlciBET00gcmVhZHkKalF1ZXJ5KGZ1bmN0aW9uKCkgewoJaWYgKCAhalF1ZXJ5LnN1cHBvcnQucmVsaWFibGVNYXJnaW5SaWdodCApIHsKCQlqUXVlcnkuY3NzSG9va3MubWFyZ2luUmlnaHQgPSB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkJLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CgkJCQkvLyBXb3JrIGFyb3VuZCBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIGVsZW1lbnQgZGlzcGxheSB0byBpbmxpbmUtYmxvY2sKCQkJCXJldHVybiBqUXVlcnkuc3dhcCggZWxlbSwgeyAiZGlzcGxheSI6ICJpbmxpbmUtYmxvY2siIH0sIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQkJCXJldHVybiBjdXJDU1MoIGVsZW0sICJtYXJnaW5SaWdodCIgKTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCX07Cgl9CgoJLy8gV2Via2l0IGJ1ZzogaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTI5MDg0CgkvLyBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgcGVyY2VudCB3aGVuIHNwZWNpZmllZCBmb3IgdG9wL2xlZnQvYm90dG9tL3JpZ2h0CgkvLyByYXRoZXIgdGhhbiBtYWtlIHRoZSBjc3MgbW9kdWxlIGRlcGVuZCBvbiB0aGUgb2Zmc2V0IG1vZHVsZSwgd2UganVzdCBjaGVjayBmb3IgaXQgaGVyZQoJaWYgKCAhalF1ZXJ5LnN1cHBvcnQucGl4ZWxQb3NpdGlvbiAmJiBqUXVlcnkuZm4ucG9zaXRpb24gKSB7CgkJalF1ZXJ5LmVhY2goIFsgInRvcCIsICJsZWZ0IiBdLCBmdW5jdGlvbiggaSwgcHJvcCApIHsKCQkJalF1ZXJ5LmNzc0hvb2tzWyBwcm9wIF0gPSB7CgkJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQkJCQlpZiAoIGNvbXB1dGVkICkgewoJCQkJCQl2YXIgcmV0ID0gY3VyQ1NTKCBlbGVtLCBwcm9wICk7CgkJCQkJCS8vIGlmIGN1ckNTUyByZXR1cm5zIHBlcmNlbnRhZ2UsIGZhbGxiYWNrIHRvIG9mZnNldAoJCQkJCQlyZXR1cm4gcm51bW5vbnB4LnRlc3QoIHJldCApID8galF1ZXJ5KCBlbGVtICkucG9zaXRpb24oKVsgcHJvcCBdICsgInB4IiA6IHJldDsKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7Cgl9Cgp9KTsKCmlmICggalF1ZXJ5LmV4cHIgJiYgalF1ZXJ5LmV4cHIuZmlsdGVycyApIHsKCWpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICggZWxlbS5vZmZzZXRXaWR0aCA9PT0gMCAmJiBlbGVtLm9mZnNldEhlaWdodCA9PT0gMCApIHx8ICghalF1ZXJ5LnN1cHBvcnQucmVsaWFibGVIaWRkZW5PZmZzZXRzICYmICgoZWxlbS5zdHlsZSAmJiBlbGVtLnN0eWxlLmRpc3BsYXkpIHx8IGN1ckNTUyggZWxlbSwgImRpc3BsYXkiICkpID09PSAibm9uZSIpOwoJfTsKCglqUXVlcnkuZXhwci5maWx0ZXJzLnZpc2libGUgPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gIWpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuKCBlbGVtICk7Cgl9Owp9CgovLyBUaGVzZSBob29rcyBhcmUgdXNlZCBieSBhbmltYXRlIHRvIGV4cGFuZCBwcm9wZXJ0aWVzCmpRdWVyeS5lYWNoKHsKCW1hcmdpbjogIiIsCglwYWRkaW5nOiAiIiwKCWJvcmRlcjogIldpZHRoIgp9LCBmdW5jdGlvbiggcHJlZml4LCBzdWZmaXggKSB7CglqUXVlcnkuY3NzSG9va3NbIHByZWZpeCArIHN1ZmZpeCBdID0gewoJCWV4cGFuZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgaSwKCgkJCQkvLyBhc3N1bWVzIGEgc2luZ2xlIG51bWJlciBpZiBub3QgYSBzdHJpbmcKCQkJCXBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIgIikgOiBbIHZhbHVlIF0sCgkJCQlleHBhbmRlZCA9IHt9OwoKCQkJZm9yICggaSA9IDA7IGkgPCA0OyBpKysgKSB7CgkJCQlleHBhbmRlZFsgcHJlZml4ICsgY3NzRXhwYW5kWyBpIF0gKyBzdWZmaXggXSA9CgkJCQkJcGFydHNbIGkgXSB8fCBwYXJ0c1sgaSAtIDIgXSB8fCBwYXJ0c1sgMCBdOwoJCQl9CgoJCQlyZXR1cm4gZXhwYW5kZWQ7CgkJfQoJfTsKCglpZiAoICFybWFyZ2luLnRlc3QoIHByZWZpeCApICkgewoJCWpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0uc2V0ID0gc2V0UG9zaXRpdmVOdW1iZXI7Cgl9Cn0pOwp2YXIgcjIwID0gLyUyMC9nLAoJcmJyYWNrZXQgPSAvXFtcXSQvLAoJckNSTEYgPSAvXHI/XG4vZywKCXJpbnB1dCA9IC9eKD86Y29sb3J8ZGF0ZXxkYXRldGltZXxkYXRldGltZS1sb2NhbHxlbWFpbHxoaWRkZW58bW9udGh8bnVtYmVyfHBhc3N3b3JkfHJhbmdlfHNlYXJjaHx0ZWx8dGV4dHx0aW1lfHVybHx3ZWVrKSQvaSwKCXJzZWxlY3RUZXh0YXJlYSA9IC9eKD86c2VsZWN0fHRleHRhcmVhKS9pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglzZXJpYWxpemU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBqUXVlcnkucGFyYW0oIHRoaXMuc2VyaWFsaXplQXJyYXkoKSApOwoJfSwKCXNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KCB0aGlzLmVsZW1lbnRzICkgOiB0aGlzOwoJCX0pCgkJLmZpbHRlcihmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy5uYW1lICYmICF0aGlzLmRpc2FibGVkICYmCgkJCQkoIHRoaXMuY2hlY2tlZCB8fCByc2VsZWN0VGV4dGFyZWEudGVzdCggdGhpcy5ub2RlTmFtZSApIHx8CgkJCQkJcmlucHV0LnRlc3QoIHRoaXMudHlwZSApICk7CgkJfSkKCQkubWFwKGZ1bmN0aW9uKCBpLCBlbGVtICl7CgkJCXZhciB2YWwgPSBqUXVlcnkoIHRoaXMgKS52YWwoKTsKCgkJCXJldHVybiB2YWwgPT0gbnVsbCA/CgkJCQludWxsIDoKCQkJCWpRdWVyeS5pc0FycmF5KCB2YWwgKSA/CgkJCQkJalF1ZXJ5Lm1hcCggdmFsLCBmdW5jdGlvbiggdmFsLCBpICl7CgkJCQkJCXJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsKCQkJCQl9KSA6CgkJCQkJeyBuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWwucmVwbGFjZSggckNSTEYsICJcclxuIiApIH07CgkJfSkuZ2V0KCk7Cgl9Cn0pOwoKLy9TZXJpYWxpemUgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cyBvciBhIHNldCBvZgovL2tleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwpqUXVlcnkucGFyYW0gPSBmdW5jdGlvbiggYSwgdHJhZGl0aW9uYWwgKSB7Cgl2YXIgcHJlZml4LAoJCXMgPSBbXSwKCQlhZGQgPSBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJLy8gSWYgdmFsdWUgaXMgYSBmdW5jdGlvbiwgaW52b2tlIGl0IGFuZCByZXR1cm4gaXRzIHZhbHVlCgkJCXZhbHVlID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgPyB2YWx1ZSgpIDogKCB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSApOwoJCQlzWyBzLmxlbmd0aCBdID0gZW5jb2RlVVJJQ29tcG9uZW50KCBrZXkgKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCggdmFsdWUgKTsKCQl9OwoKCS8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuCglpZiAoIHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQgKSB7CgkJdHJhZGl0aW9uYWwgPSBqUXVlcnkuYWpheFNldHRpbmdzICYmIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWw7Cgl9CgoJLy8gSWYgYW4gYXJyYXkgd2FzIHBhc3NlZCBpbiwgYXNzdW1lIHRoYXQgaXQgaXMgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cy4KCWlmICggalF1ZXJ5LmlzQXJyYXkoIGEgKSB8fCAoIGEuanF1ZXJ5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdCggYSApICkgKSB7CgkJLy8gU2VyaWFsaXplIHRoZSBmb3JtIGVsZW1lbnRzCgkJalF1ZXJ5LmVhY2goIGEsIGZ1bmN0aW9uKCkgewoJCQlhZGQoIHRoaXMubmFtZSwgdGhpcy52YWx1ZSApOwoJCX0pOwoKCX0gZWxzZSB7CgkJLy8gSWYgdHJhZGl0aW9uYWwsIGVuY29kZSB0aGUgIm9sZCIgd2F5ICh0aGUgd2F5IDEuMy4yIG9yIG9sZGVyCgkJLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCgkJZm9yICggcHJlZml4IGluIGEgKSB7CgkJCWJ1aWxkUGFyYW1zKCBwcmVmaXgsIGFbIHByZWZpeCBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoJfQoKCS8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KCXJldHVybiBzLmpvaW4oICImIiApLnJlcGxhY2UoIHIyMCwgIisiICk7Cn07CgpmdW5jdGlvbiBidWlsZFBhcmFtcyggcHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQgKSB7Cgl2YXIgbmFtZTsKCglpZiAoIGpRdWVyeS5pc0FycmF5KCBvYmogKSApIHsKCQkvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KCQlqUXVlcnkuZWFjaCggb2JqLCBmdW5jdGlvbiggaSwgdiApIHsKCQkJaWYgKCB0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KCBwcmVmaXggKSApIHsKCQkJCS8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KCQkJCWFkZCggcHJlZml4LCB2ICk7CgoJCQl9IGVsc2UgewoJCQkJLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCgkJCQkvLyBudW1lcmljIGluZGV4IHRvIHJlc29sdmUgZGVzZXJpYWxpemF0aW9uIGFtYmlndWl0eSBpc3N1ZXMuCgkJCQkvLyBOb3RlIHRoYXQgcmFjayAoYXMgb2YgMS4wLjApIGNhbid0IGN1cnJlbnRseSBkZXNlcmlhbGl6ZQoJCQkJLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCgkJCQkvLyBhIHNlcnZlciBlcnJvci4gUG9zc2libGUgZml4ZXMgYXJlIHRvIG1vZGlmeSByYWNrJ3MKCQkJCS8vIGRlc2VyaWFsaXphdGlvbiBhbGdvcml0aG0gb3IgdG8gcHJvdmlkZSBhbiBvcHRpb24gb3IgZmxhZwoJCQkJLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgoJCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArICggdHlwZW9mIHYgPT09ICJvYmplY3QiID8gaSA6ICIiICkgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQkJfQoJCX0pOwoKCX0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZSggb2JqICkgPT09ICJvYmplY3QiICkgewoJCS8vIFNlcmlhbGl6ZSBvYmplY3QgaXRlbS4KCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialsgbmFtZSBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoKCX0gZWxzZSB7CgkJLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgoJCWFkZCggcHJlZml4LCBvYmogKTsKCX0KfQp2YXIgLy8gRG9jdW1lbnQgbG9jYXRpb24KCWFqYXhMb2NhdGlvbiwKCS8vIERvY3VtZW50IGxvY2F0aW9uIHNlZ21lbnRzCglhamF4TG9jUGFydHMsCgoJcmhhc2ggPSAvIy4qJC8sCglyaGVhZGVycyA9IC9eKC4qPyk6WyBcdF0qKFteXHJcbl0qKVxyPyQvbWcsIC8vIElFIGxlYXZlcyBhbiBcciBjaGFyYWN0ZXIgYXQgRU9MCgkvLyAjNzY1MywgIzgxMjUsICM4MTUyOiBsb2NhbCBwcm90b2NvbCBkZXRlY3Rpb24KCXJsb2NhbFByb3RvY29sID0gL14oPzphYm91dHxhcHB8YXBwXC1zdG9yYWdlfC4rXC1leHRlbnNpb258ZmlsZXxyZXN8d2lkZ2V0KTokLywKCXJub0NvbnRlbnQgPSAvXig/OkdFVHxIRUFEKSQvLAoJcnByb3RvY29sID0gL15cL1wvLywKCXJxdWVyeSA9IC9cPy8sCglyc2NyaXB0ID0gLzxzY3JpcHRcYltePF0qKD86KD8hPFwvc2NyaXB0Pik8W148XSopKjxcL3NjcmlwdD4vZ2ksCglydHMgPSAvKFs/Jl0pXz1bXiZdKi8sCglydXJsID0gL14oW1x3XCtcLlwtXSs6KSg/OlwvXC8oW15cLz8jOl0qKSg/OjooXGQrKXwpfCkvLAoKCS8vIEtlZXAgYSBjb3B5IG9mIHRoZSBvbGQgbG9hZCBtZXRob2QKCV9sb2FkID0galF1ZXJ5LmZuLmxvYWQsCgoJLyogUHJlZmlsdGVycwoJICogMSkgVGhleSBhcmUgdXNlZnVsIHRvIGludHJvZHVjZSBjdXN0b20gZGF0YVR5cGVzIChzZWUgYWpheC9qc29ucC5qcyBmb3IgYW4gZXhhbXBsZSkKCSAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6CgkgKiAgICAtIEJFRk9SRSBhc2tpbmcgZm9yIGEgdHJhbnNwb3J0CgkgKiAgICAtIEFGVEVSIHBhcmFtIHNlcmlhbGl6YXRpb24gKHMuZGF0YSBpcyBhIHN0cmluZyBpZiBzLnByb2Nlc3NEYXRhIGlzIHRydWUpCgkgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlCgkgKiA0KSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAoJICogNSkgZXhlY3V0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gY29udGludWUgZG93biB0byAiKiIgaWYgbmVlZGVkCgkgKi8KCXByZWZpbHRlcnMgPSB7fSwKCgkvKiBUcmFuc3BvcnRzIGJpbmRpbmdzCgkgKiAxKSBrZXkgaXMgdGhlIGRhdGFUeXBlCgkgKiAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAoJICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZAoJICovCgl0cmFuc3BvcnRzID0ge30sCgoJLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCglhbGxUeXBlcyA9IFsiKi8iXSArIFsiKiJdOwoKLy8gIzgxMzgsIElFIG1heSB0aHJvdyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKLy8gYSBmaWVsZCBmcm9tIHdpbmRvdy5sb2NhdGlvbiBpZiBkb2N1bWVudC5kb21haW4gaGFzIGJlZW4gc2V0CnRyeSB7CglhamF4TG9jYXRpb24gPSBsb2NhdGlvbi5ocmVmOwp9IGNhdGNoKCBlICkgewoJLy8gVXNlIHRoZSBocmVmIGF0dHJpYnV0ZSBvZiBhbiBBIGVsZW1lbnQKCS8vIHNpbmNlIElFIHdpbGwgbW9kaWZ5IGl0IGdpdmVuIGRvY3VtZW50LmxvY2F0aW9uCglhamF4TG9jYXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKTsKCWFqYXhMb2NhdGlvbi5ocmVmID0gIiI7CglhamF4TG9jYXRpb24gPSBhamF4TG9jYXRpb24uaHJlZjsKfQoKLy8gU2VnbWVudCBsb2NhdGlvbiBpbnRvIHBhcnRzCmFqYXhMb2NQYXJ0cyA9IHJ1cmwuZXhlYyggYWpheExvY2F0aW9uLnRvTG93ZXJDYXNlKCkgKSB8fCBbXTsKCi8vIEJhc2UgImNvbnN0cnVjdG9yIiBmb3IgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIgYW5kIGpRdWVyeS5hamF4VHJhbnNwb3J0CmZ1bmN0aW9uIGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlICkgewoKCS8vIGRhdGFUeXBlRXhwcmVzc2lvbiBpcyBvcHRpb25hbCBhbmQgZGVmYXVsdHMgdG8gIioiCglyZXR1cm4gZnVuY3Rpb24oIGRhdGFUeXBlRXhwcmVzc2lvbiwgZnVuYyApIHsKCgkJaWYgKCB0eXBlb2YgZGF0YVR5cGVFeHByZXNzaW9uICE9PSAic3RyaW5nIiApIHsKCQkJZnVuYyA9IGRhdGFUeXBlRXhwcmVzc2lvbjsKCQkJZGF0YVR5cGVFeHByZXNzaW9uID0gIioiOwoJCX0KCgkJdmFyIGRhdGFUeXBlLCBsaXN0LCBwbGFjZUJlZm9yZSwKCQkJZGF0YVR5cGVzID0gZGF0YVR5cGVFeHByZXNzaW9uLnRvTG93ZXJDYXNlKCkuc3BsaXQoIGNvcmVfcnNwYWNlICksCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBkYXRhVHlwZXMubGVuZ3RoOwoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBmdW5jICkgKSB7CgkJCS8vIEZvciBlYWNoIGRhdGFUeXBlIGluIHRoZSBkYXRhVHlwZUV4cHJlc3Npb24KCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlkYXRhVHlwZSA9IGRhdGFUeXBlc1sgaSBdOwoJCQkJLy8gV2UgY29udHJvbCBpZiB3ZSdyZSBhc2tlZCB0byBhZGQgYmVmb3JlCgkJCQkvLyBhbnkgZXhpc3RpbmcgZWxlbWVudAoJCQkJcGxhY2VCZWZvcmUgPSAvXlwrLy50ZXN0KCBkYXRhVHlwZSApOwoJCQkJaWYgKCBwbGFjZUJlZm9yZSApIHsKCQkJCQlkYXRhVHlwZSA9IGRhdGFUeXBlLnN1YnN0ciggMSApIHx8ICIqIjsKCQkJCX0KCQkJCWxpc3QgPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW107CgkJCQkvLyB0aGVuIHdlIGFkZCB0byB0aGUgc3RydWN0dXJlIGFjY29yZGluZ2x5CgkJCQlsaXN0WyBwbGFjZUJlZm9yZSA/ICJ1bnNoaWZ0IiA6ICJwdXNoIiBdKCBmdW5jICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMKZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiwKCQlkYXRhVHlwZSAvKiBpbnRlcm5hbCAqLywgaW5zcGVjdGVkIC8qIGludGVybmFsICovICkgewoKCWRhdGFUeXBlID0gZGF0YVR5cGUgfHwgb3B0aW9ucy5kYXRhVHlwZXNbIDAgXTsKCWluc3BlY3RlZCA9IGluc3BlY3RlZCB8fCB7fTsKCglpbnNwZWN0ZWRbIGRhdGFUeXBlIF0gPSB0cnVlOwoKCXZhciBzZWxlY3Rpb24sCgkJbGlzdCA9IHN0cnVjdHVyZVsgZGF0YVR5cGUgXSwKCQlpID0gMCwKCQlsZW5ndGggPSBsaXN0ID8gbGlzdC5sZW5ndGggOiAwLAoJCWV4ZWN1dGVPbmx5ID0gKCBzdHJ1Y3R1cmUgPT09IHByZWZpbHRlcnMgKTsKCglmb3IgKCA7IGkgPCBsZW5ndGggJiYgKCBleGVjdXRlT25seSB8fCAhc2VsZWN0aW9uICk7IGkrKyApIHsKCQlzZWxlY3Rpb24gPSBsaXN0WyBpIF0oIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIgKTsKCQkvLyBJZiB3ZSBnb3QgcmVkaXJlY3RlZCB0byBhbm90aGVyIGRhdGFUeXBlCgkJLy8gd2UgdHJ5IHRoZXJlIGlmIGV4ZWN1dGluZyBvbmx5IGFuZCBub3QgZG9uZSBhbHJlYWR5CgkJaWYgKCB0eXBlb2Ygc2VsZWN0aW9uID09PSAic3RyaW5nIiApIHsKCQkJaWYgKCAhZXhlY3V0ZU9ubHkgfHwgaW5zcGVjdGVkWyBzZWxlY3Rpb24gXSApIHsKCQkJCXNlbGVjdGlvbiA9IHVuZGVmaW5lZDsKCQkJfSBlbHNlIHsKCQkJCW9wdGlvbnMuZGF0YVR5cGVzLnVuc2hpZnQoIHNlbGVjdGlvbiApOwoJCQkJc2VsZWN0aW9uID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoCgkJCQkJCXN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiwgc2VsZWN0aW9uLCBpbnNwZWN0ZWQgKTsKCQkJfQoJCX0KCX0KCS8vIElmIHdlJ3JlIG9ubHkgZXhlY3V0aW5nIG9yIG5vdGhpbmcgd2FzIHNlbGVjdGVkCgkvLyB3ZSB0cnkgdGhlIGNhdGNoYWxsIGRhdGFUeXBlIGlmIG5vdCBkb25lIGFscmVhZHkKCWlmICggKCBleGVjdXRlT25seSB8fCAhc2VsZWN0aW9uICkgJiYgIWluc3BlY3RlZFsgIioiIF0gKSB7CgkJc2VsZWN0aW9uID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoCgkJCQlzdHJ1Y3R1cmUsIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIsICIqIiwgaW5zcGVjdGVkICk7Cgl9CgkvLyB1bm5lY2Vzc2FyeSB3aGVuIG9ubHkgZXhlY3V0aW5nIChwcmVmaWx0ZXJzKQoJLy8gYnV0IGl0J2xsIGJlIGlnbm9yZWQgYnkgdGhlIGNhbGxlciBpbiB0aGF0IGNhc2UKCXJldHVybiBzZWxlY3Rpb247Cn0KCi8vIEEgc3BlY2lhbCBleHRlbmQgZm9yIGFqYXggb3B0aW9ucwovLyB0aGF0IHRha2VzICJmbGF0IiBvcHRpb25zIChub3QgdG8gYmUgZGVlcCBleHRlbmRlZCkKLy8gRml4ZXMgIzk4ODcKZnVuY3Rpb24gYWpheEV4dGVuZCggdGFyZ2V0LCBzcmMgKSB7Cgl2YXIga2V5LCBkZWVwLAoJCWZsYXRPcHRpb25zID0galF1ZXJ5LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsKCWZvciAoIGtleSBpbiBzcmMgKSB7CgkJaWYgKCBzcmNbIGtleSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCSggZmxhdE9wdGlvbnNbIGtleSBdID8gdGFyZ2V0IDogKCBkZWVwIHx8ICggZGVlcCA9IHt9ICkgKSApWyBrZXkgXSA9IHNyY1sga2V5IF07CgkJfQoJfQoJaWYgKCBkZWVwICkgewoJCWpRdWVyeS5leHRlbmQoIHRydWUsIHRhcmdldCwgZGVlcCApOwoJfQp9CgpqUXVlcnkuZm4ubG9hZCA9IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcywgY2FsbGJhY2sgKSB7CglpZiAoIHR5cGVvZiB1cmwgIT09ICJzdHJpbmciICYmIF9sb2FkICkgewoJCXJldHVybiBfbG9hZC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7Cgl9CgoJLy8gRG9uJ3QgZG8gYSByZXF1ZXN0IGlmIG5vIGVsZW1lbnRzIGFyZSBiZWluZyByZXF1ZXN0ZWQKCWlmICggIXRoaXMubGVuZ3RoICkgewoJCXJldHVybiB0aGlzOwoJfQoKCXZhciBzZWxlY3RvciwgdHlwZSwgcmVzcG9uc2UsCgkJc2VsZiA9IHRoaXMsCgkJb2ZmID0gdXJsLmluZGV4T2YoIiAiKTsKCglpZiAoIG9mZiA+PSAwICkgewoJCXNlbGVjdG9yID0gdXJsLnNsaWNlKCBvZmYsIHVybC5sZW5ndGggKTsKCQl1cmwgPSB1cmwuc2xpY2UoIDAsIG9mZiApOwoJfQoKCS8vIElmIGl0J3MgYSBmdW5jdGlvbgoJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcGFyYW1zICkgKSB7CgoJCS8vIFdlIGFzc3VtZSB0aGF0IGl0J3MgdGhlIGNhbGxiYWNrCgkJY2FsbGJhY2sgPSBwYXJhbXM7CgkJcGFyYW1zID0gdW5kZWZpbmVkOwoKCS8vIE90aGVyd2lzZSwgYnVpbGQgYSBwYXJhbSBzdHJpbmcKCX0gZWxzZSBpZiAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgewoJCXR5cGUgPSAiUE9TVCI7Cgl9CgoJLy8gUmVxdWVzdCB0aGUgcmVtb3RlIGRvY3VtZW50CglqUXVlcnkuYWpheCh7CgkJdXJsOiB1cmwsCgoJCS8vIGlmICJ0eXBlIiB2YXJpYWJsZSBpcyB1bmRlZmluZWQsIHRoZW4gIkdFVCIgbWV0aG9kIHdpbGwgYmUgdXNlZAoJCXR5cGU6IHR5cGUsCgkJZGF0YVR5cGU6ICJodG1sIiwKCQlkYXRhOiBwYXJhbXMsCgkJY29tcGxldGU6IGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJc2VsZi5lYWNoKCBjYWxsYmFjaywgcmVzcG9uc2UgfHwgWyBqcVhIUi5yZXNwb25zZVRleHQsIHN0YXR1cywganFYSFIgXSApOwoJCQl9CgkJfQoJfSkuZG9uZShmdW5jdGlvbiggcmVzcG9uc2VUZXh0ICkgewoKCQkvLyBTYXZlIHJlc3BvbnNlIGZvciB1c2UgaW4gY29tcGxldGUgY2FsbGJhY2sKCQlyZXNwb25zZSA9IGFyZ3VtZW50czsKCgkJLy8gU2VlIGlmIGEgc2VsZWN0b3Igd2FzIHNwZWNpZmllZAoJCXNlbGYuaHRtbCggc2VsZWN0b3IgPwoKCQkJLy8gQ3JlYXRlIGEgZHVtbXkgZGl2IHRvIGhvbGQgdGhlIHJlc3VsdHMKCQkJalF1ZXJ5KCI8ZGl2PiIpCgoJCQkJLy8gaW5qZWN0IHRoZSBjb250ZW50cyBvZiB0aGUgZG9jdW1lbnQgaW4sIHJlbW92aW5nIHRoZSBzY3JpcHRzCgkJCQkvLyB0byBhdm9pZCBhbnkgJ1Blcm1pc3Npb24gRGVuaWVkJyBlcnJvcnMgaW4gSUUKCQkJCS5hcHBlbmQoIHJlc3BvbnNlVGV4dC5yZXBsYWNlKCByc2NyaXB0LCAiIiApICkKCgkJCQkvLyBMb2NhdGUgdGhlIHNwZWNpZmllZCBlbGVtZW50cwoJCQkJLmZpbmQoIHNlbGVjdG9yICkgOgoKCQkJLy8gSWYgbm90LCBqdXN0IGluamVjdCB0aGUgZnVsbCByZXN1bHQKCQkJcmVzcG9uc2VUZXh0ICk7CgoJfSk7CgoJcmV0dXJuIHRoaXM7Cn07CgovLyBBdHRhY2ggYSBidW5jaCBvZiBmdW5jdGlvbnMgZm9yIGhhbmRsaW5nIGNvbW1vbiBBSkFYIGV2ZW50cwpqUXVlcnkuZWFjaCggImFqYXhTdGFydCBhamF4U3RvcCBhamF4Q29tcGxldGUgYWpheEVycm9yIGFqYXhTdWNjZXNzIGFqYXhTZW5kIi5zcGxpdCggIiAiICksIGZ1bmN0aW9uKCBpLCBvICl7CglqUXVlcnkuZm5bIG8gXSA9IGZ1bmN0aW9uKCBmICl7CgkJcmV0dXJuIHRoaXMub24oIG8sIGYgKTsKCX07Cn0pOwoKalF1ZXJ5LmVhY2goIFsgImdldCIsICJwb3N0IiBdLCBmdW5jdGlvbiggaSwgbWV0aG9kICkgewoJalF1ZXJ5WyBtZXRob2QgXSA9IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIGNhbGxiYWNrLCB0eXBlICkgewoJCS8vIHNoaWZ0IGFyZ3VtZW50cyBpZiBkYXRhIGFyZ3VtZW50IHdhcyBvbWl0dGVkCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggZGF0YSApICkgewoJCQl0eXBlID0gdHlwZSB8fCBjYWxsYmFjazsKCQkJY2FsbGJhY2sgPSBkYXRhOwoJCQlkYXRhID0gdW5kZWZpbmVkOwoJCX0KCgkJcmV0dXJuIGpRdWVyeS5hamF4KHsKCQkJdHlwZTogbWV0aG9kLAoJCQl1cmw6IHVybCwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2ssCgkJCWRhdGFUeXBlOiB0eXBlCgkJfSk7Cgl9Owp9KTsKCmpRdWVyeS5leHRlbmQoewoKCWdldFNjcmlwdDogZnVuY3Rpb24oIHVybCwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIGpRdWVyeS5nZXQoIHVybCwgdW5kZWZpbmVkLCBjYWxsYmFjaywgInNjcmlwdCIgKTsKCX0sCgoJZ2V0SlNPTjogZnVuY3Rpb24oIHVybCwgZGF0YSwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIGpRdWVyeS5nZXQoIHVybCwgZGF0YSwgY2FsbGJhY2ssICJqc29uIiApOwoJfSwKCgkvLyBDcmVhdGVzIGEgZnVsbCBmbGVkZ2VkIHNldHRpbmdzIG9iamVjdCBpbnRvIHRhcmdldAoJLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgoJLy8gSWYgdGFyZ2V0IGlzIG9taXR0ZWQsIHdyaXRlcyBpbnRvIGFqYXhTZXR0aW5ncy4KCWFqYXhTZXR1cDogZnVuY3Rpb24oIHRhcmdldCwgc2V0dGluZ3MgKSB7CgkJaWYgKCBzZXR0aW5ncyApIHsKCQkJLy8gQnVpbGRpbmcgYSBzZXR0aW5ncyBvYmplY3QKCQkJYWpheEV4dGVuZCggdGFyZ2V0LCBqUXVlcnkuYWpheFNldHRpbmdzICk7CgkJfSBlbHNlIHsKCQkJLy8gRXh0ZW5kaW5nIGFqYXhTZXR0aW5ncwoJCQlzZXR0aW5ncyA9IHRhcmdldDsKCQkJdGFyZ2V0ID0galF1ZXJ5LmFqYXhTZXR0aW5nczsKCQl9CgkJYWpheEV4dGVuZCggdGFyZ2V0LCBzZXR0aW5ncyApOwoJCXJldHVybiB0YXJnZXQ7Cgl9LAoKCWFqYXhTZXR0aW5nczogewoJCXVybDogYWpheExvY2F0aW9uLAoJCWlzTG9jYWw6IHJsb2NhbFByb3RvY29sLnRlc3QoIGFqYXhMb2NQYXJ0c1sgMSBdICksCgkJZ2xvYmFsOiB0cnVlLAoJCXR5cGU6ICJHRVQiLAoJCWNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04IiwKCQlwcm9jZXNzRGF0YTogdHJ1ZSwKCQlhc3luYzogdHJ1ZSwKCQkvKgoJCXRpbWVvdXQ6IDAsCgkJZGF0YTogbnVsbCwKCQlkYXRhVHlwZTogbnVsbCwKCQl1c2VybmFtZTogbnVsbCwKCQlwYXNzd29yZDogbnVsbCwKCQljYWNoZTogbnVsbCwKCQl0aHJvd3M6IGZhbHNlLAoJCXRyYWRpdGlvbmFsOiBmYWxzZSwKCQloZWFkZXJzOiB7fSwKCQkqLwoKCQlhY2NlcHRzOiB7CgkJCXhtbDogImFwcGxpY2F0aW9uL3htbCwgdGV4dC94bWwiLAoJCQlodG1sOiAidGV4dC9odG1sIiwKCQkJdGV4dDogInRleHQvcGxhaW4iLAoJCQlqc29uOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0IiwKCQkJIioiOiBhbGxUeXBlcwoJCX0sCgoJCWNvbnRlbnRzOiB7CgkJCXhtbDogL3htbC8sCgkJCWh0bWw6IC9odG1sLywKCQkJanNvbjogL2pzb24vCgkJfSwKCgkJcmVzcG9uc2VGaWVsZHM6IHsKCQkJeG1sOiAicmVzcG9uc2VYTUwiLAoJCQl0ZXh0OiAicmVzcG9uc2VUZXh0IgoJCX0sCgoJCS8vIExpc3Qgb2YgZGF0YSBjb252ZXJ0ZXJzCgkJLy8gMSkga2V5IGZvcm1hdCBpcyAic291cmNlX3R5cGUgZGVzdGluYXRpb25fdHlwZSIgKGEgc2luZ2xlIHNwYWNlIGluLWJldHdlZW4pCgkJLy8gMikgdGhlIGNhdGNoYWxsIHN5bWJvbCAiKiIgY2FuIGJlIHVzZWQgZm9yIHNvdXJjZV90eXBlCgkJY29udmVydGVyczogewoKCQkJLy8gQ29udmVydCBhbnl0aGluZyB0byB0ZXh0CgkJCSIqIHRleHQiOiB3aW5kb3cuU3RyaW5nLAoKCQkJLy8gVGV4dCB0byBodG1sICh0cnVlID0gbm8gdHJhbnNmb3JtYXRpb24pCgkJCSJ0ZXh0IGh0bWwiOiB0cnVlLAoKCQkJLy8gRXZhbHVhdGUgdGV4dCBhcyBhIGpzb24gZXhwcmVzc2lvbgoJCQkidGV4dCBqc29uIjogalF1ZXJ5LnBhcnNlSlNPTiwKCgkJCS8vIFBhcnNlIHRleHQgYXMgeG1sCgkJCSJ0ZXh0IHhtbCI6IGpRdWVyeS5wYXJzZVhNTAoJCX0sCgoJCS8vIEZvciBvcHRpb25zIHRoYXQgc2hvdWxkbid0IGJlIGRlZXAgZXh0ZW5kZWQ6CgkJLy8geW91IGNhbiBhZGQgeW91ciBvd24gY3VzdG9tIG9wdGlvbnMgaGVyZSBpZgoJCS8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCgkJLy8gZGVlcCBleHRlbmRlZCAoc2VlIGFqYXhFeHRlbmQpCgkJZmxhdE9wdGlvbnM6IHsKCQkJY29udGV4dDogdHJ1ZSwKCQkJdXJsOiB0cnVlCgkJfQoJfSwKCglhamF4UHJlZmlsdGVyOiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHByZWZpbHRlcnMgKSwKCWFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cyApLAoKCS8vIE1haW4gbWV0aG9kCglhamF4OiBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoKCQkvLyBJZiB1cmwgaXMgYW4gb2JqZWN0LCBzaW11bGF0ZSBwcmUtMS41IHNpZ25hdHVyZQoJCWlmICggdHlwZW9mIHVybCA9PT0gIm9iamVjdCIgKSB7CgkJCW9wdGlvbnMgPSB1cmw7CgkJCXVybCA9IHVuZGVmaW5lZDsKCQl9CgoJCS8vIEZvcmNlIG9wdGlvbnMgdG8gYmUgYW4gb2JqZWN0CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgoJCXZhciAvLyBpZk1vZGlmaWVkIGtleQoJCQlpZk1vZGlmaWVkS2V5LAoJCQkvLyBSZXNwb25zZSBoZWFkZXJzCgkJCXJlc3BvbnNlSGVhZGVyc1N0cmluZywKCQkJcmVzcG9uc2VIZWFkZXJzLAoJCQkvLyB0cmFuc3BvcnQKCQkJdHJhbnNwb3J0LAoJCQkvLyB0aW1lb3V0IGhhbmRsZQoJCQl0aW1lb3V0VGltZXIsCgkJCS8vIENyb3NzLWRvbWFpbiBkZXRlY3Rpb24gdmFycwoJCQlwYXJ0cywKCQkJLy8gVG8ga25vdyBpZiBnbG9iYWwgZXZlbnRzIGFyZSB0byBiZSBkaXNwYXRjaGVkCgkJCWZpcmVHbG9iYWxzLAoJCQkvLyBMb29wIHZhcmlhYmxlCgkJCWksCgkJCS8vIENyZWF0ZSB0aGUgZmluYWwgb3B0aW9ucyBvYmplY3QKCQkJcyA9IGpRdWVyeS5hamF4U2V0dXAoIHt9LCBvcHRpb25zICksCgkJCS8vIENhbGxiYWNrcyBjb250ZXh0CgkJCWNhbGxiYWNrQ29udGV4dCA9IHMuY29udGV4dCB8fCBzLAoJCQkvLyBDb250ZXh0IGZvciBnbG9iYWwgZXZlbnRzCgkJCS8vIEl0J3MgdGhlIGNhbGxiYWNrQ29udGV4dCBpZiBvbmUgd2FzIHByb3ZpZGVkIGluIHRoZSBvcHRpb25zCgkJCS8vIGFuZCBpZiBpdCdzIGEgRE9NIG5vZGUgb3IgYSBqUXVlcnkgY29sbGVjdGlvbgoJCQlnbG9iYWxFdmVudENvbnRleHQgPSBjYWxsYmFja0NvbnRleHQgIT09IHMgJiYKCQkJCSggY2FsbGJhY2tDb250ZXh0Lm5vZGVUeXBlIHx8IGNhbGxiYWNrQ29udGV4dCBpbnN0YW5jZW9mIGpRdWVyeSApID8KCQkJCQkJalF1ZXJ5KCBjYWxsYmFja0NvbnRleHQgKSA6IGpRdWVyeS5ldmVudCwKCQkJLy8gRGVmZXJyZWRzCgkJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksCgkJCWNvbXBsZXRlRGVmZXJyZWQgPSBqUXVlcnkuQ2FsbGJhY2tzKCAib25jZSBtZW1vcnkiICksCgkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCgkJCXN0YXR1c0NvZGUgPSBzLnN0YXR1c0NvZGUgfHwge30sCgkJCS8vIEhlYWRlcnMgKHRoZXkgYXJlIHNlbnQgYWxsIGF0IG9uY2UpCgkJCXJlcXVlc3RIZWFkZXJzID0ge30sCgkJCXJlcXVlc3RIZWFkZXJzTmFtZXMgPSB7fSwKCQkJLy8gVGhlIGpxWEhSIHN0YXRlCgkJCXN0YXRlID0gMCwKCQkJLy8gRGVmYXVsdCBhYm9ydCBtZXNzYWdlCgkJCXN0ckFib3J0ID0gImNhbmNlbGVkIiwKCQkJLy8gRmFrZSB4aHIKCQkJanFYSFIgPSB7CgoJCQkJcmVhZHlTdGF0ZTogMCwKCgkJCQkvLyBDYWNoZXMgdGhlIGhlYWRlcgoJCQkJc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCQkJCWlmICggIXN0YXRlICkgewoJCQkJCQl2YXIgbG5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CgkJCQkJCW5hbWUgPSByZXF1ZXN0SGVhZGVyc05hbWVzWyBsbmFtZSBdID0gcmVxdWVzdEhlYWRlcnNOYW1lc1sgbG5hbWUgXSB8fCBuYW1lOwoJCQkJCQlyZXF1ZXN0SGVhZGVyc1sgbmFtZSBdID0gdmFsdWU7CgkJCQkJfQoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCgkJCQkvLyBSYXcgc3RyaW5nCgkJCQlnZXRBbGxSZXNwb25zZUhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBzdGF0ZSA9PT0gMiA/IHJlc3BvbnNlSGVhZGVyc1N0cmluZyA6IG51bGw7CgkJCQl9LAoKCQkJCS8vIEJ1aWxkcyBoZWFkZXJzIGhhc2h0YWJsZSBpZiBuZWVkZWQKCQkJCWdldFJlc3BvbnNlSGVhZGVyOiBmdW5jdGlvbigga2V5ICkgewoJCQkJCXZhciBtYXRjaDsKCQkJCQlpZiAoIHN0YXRlID09PSAyICkgewoJCQkJCQlpZiAoICFyZXNwb25zZUhlYWRlcnMgKSB7CgkJCQkJCQlyZXNwb25zZUhlYWRlcnMgPSB7fTsKCQkJCQkJCXdoaWxlKCAoIG1hdGNoID0gcmhlYWRlcnMuZXhlYyggcmVzcG9uc2VIZWFkZXJzU3RyaW5nICkgKSApIHsKCQkJCQkJCQlyZXNwb25zZUhlYWRlcnNbIG1hdGNoWzFdLnRvTG93ZXJDYXNlKCkgXSA9IG1hdGNoWyAyIF07CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJbWF0Y2ggPSByZXNwb25zZUhlYWRlcnNbIGtleS50b0xvd2VyQ2FzZSgpIF07CgkJCQkJfQoJCQkJCXJldHVybiBtYXRjaCA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IG1hdGNoOwoJCQkJfSwKCgkJCQkvLyBPdmVycmlkZXMgcmVzcG9uc2UgY29udGVudC10eXBlIGhlYWRlcgoJCQkJb3ZlcnJpZGVNaW1lVHlwZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJCQkJaWYgKCAhc3RhdGUgKSB7CgkJCQkJCXMubWltZVR5cGUgPSB0eXBlOwoJCQkJCX0KCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0sCgoJCQkJLy8gQ2FuY2VsIHRoZSByZXF1ZXN0CgkJCQlhYm9ydDogZnVuY3Rpb24oIHN0YXR1c1RleHQgKSB7CgkJCQkJc3RhdHVzVGV4dCA9IHN0YXR1c1RleHQgfHwgc3RyQWJvcnQ7CgkJCQkJaWYgKCB0cmFuc3BvcnQgKSB7CgkJCQkJCXRyYW5zcG9ydC5hYm9ydCggc3RhdHVzVGV4dCApOwoJCQkJCX0KCQkJCQlkb25lKCAwLCBzdGF0dXNUZXh0ICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9CgkJCX07CgoJCS8vIENhbGxiYWNrIGZvciB3aGVuIGV2ZXJ5dGhpbmcgaXMgZG9uZQoJCS8vIEl0IGlzIGRlZmluZWQgaGVyZSBiZWNhdXNlIGpzbGludCBjb21wbGFpbnMgaWYgaXQgaXMgZGVjbGFyZWQKCQkvLyBhdCB0aGUgZW5kIG9mIHRoZSBmdW5jdGlvbiAod2hpY2ggd291bGQgYmUgbW9yZSBsb2dpY2FsIGFuZCByZWFkYWJsZSkKCQlmdW5jdGlvbiBkb25lKCBzdGF0dXMsIG5hdGl2ZVN0YXR1c1RleHQsIHJlc3BvbnNlcywgaGVhZGVycyApIHsKCQkJdmFyIGlzU3VjY2Vzcywgc3VjY2VzcywgZXJyb3IsIHJlc3BvbnNlLCBtb2RpZmllZCwKCQkJCXN0YXR1c1RleHQgPSBuYXRpdmVTdGF0dXNUZXh0OwoKCQkJLy8gQ2FsbGVkIG9uY2UKCQkJaWYgKCBzdGF0ZSA9PT0gMiApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gU3RhdGUgaXMgImRvbmUiIG5vdwoJCQlzdGF0ZSA9IDI7CgoJCQkvLyBDbGVhciB0aW1lb3V0IGlmIGl0IGV4aXN0cwoJCQlpZiAoIHRpbWVvdXRUaW1lciApIHsKCQkJCWNsZWFyVGltZW91dCggdGltZW91dFRpbWVyICk7CgkJCX0KCgkJCS8vIERlcmVmZXJlbmNlIHRyYW5zcG9ydCBmb3IgZWFybHkgZ2FyYmFnZSBjb2xsZWN0aW9uCgkJCS8vIChubyBtYXR0ZXIgaG93IGxvbmcgdGhlIGpxWEhSIG9iamVjdCB3aWxsIGJlIHVzZWQpCgkJCXRyYW5zcG9ydCA9IHVuZGVmaW5lZDsKCgkJCS8vIENhY2hlIHJlc3BvbnNlIGhlYWRlcnMKCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nID0gaGVhZGVycyB8fCAiIjsKCgkJCS8vIFNldCByZWFkeVN0YXRlCgkJCWpxWEhSLnJlYWR5U3RhdGUgPSBzdGF0dXMgPiAwID8gNCA6IDA7CgoJCQkvLyBHZXQgcmVzcG9uc2UgZGF0YQoJCQlpZiAoIHJlc3BvbnNlcyApIHsKCQkJCXJlc3BvbnNlID0gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApOwoJCQl9CgoJCQkvLyBJZiBzdWNjZXNzZnVsLCBoYW5kbGUgdHlwZSBjaGFpbmluZwoJCQlpZiAoIHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0ICkgewoKCQkJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCgkJCQlpZiAoIHMuaWZNb2RpZmllZCApIHsKCgkJCQkJbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiTGFzdC1Nb2RpZmllZCIpOwoJCQkJCWlmICggbW9kaWZpZWQgKSB7CgkJCQkJCWpRdWVyeS5sYXN0TW9kaWZpZWRbIGlmTW9kaWZpZWRLZXkgXSA9IG1vZGlmaWVkOwoJCQkJCX0KCQkJCQltb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJFdGFnIik7CgkJCQkJaWYgKCBtb2RpZmllZCApIHsKCQkJCQkJalF1ZXJ5LmV0YWdbIGlmTW9kaWZpZWRLZXkgXSA9IG1vZGlmaWVkOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBJZiBub3QgbW9kaWZpZWQKCQkJCWlmICggc3RhdHVzID09PSAzMDQgKSB7CgoJCQkJCXN0YXR1c1RleHQgPSAibm90bW9kaWZpZWQiOwoJCQkJCWlzU3VjY2VzcyA9IHRydWU7CgoJCQkJLy8gSWYgd2UgaGF2ZSBkYXRhCgkJCQl9IGVsc2UgewoKCQkJCQlpc1N1Y2Nlc3MgPSBhamF4Q29udmVydCggcywgcmVzcG9uc2UgKTsKCQkJCQlzdGF0dXNUZXh0ID0gaXNTdWNjZXNzLnN0YXRlOwoJCQkJCXN1Y2Nlc3MgPSBpc1N1Y2Nlc3MuZGF0YTsKCQkJCQllcnJvciA9IGlzU3VjY2Vzcy5lcnJvcjsKCQkJCQlpc1N1Y2Nlc3MgPSAhZXJyb3I7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQkvLyBXZSBleHRyYWN0IGVycm9yIGZyb20gc3RhdHVzVGV4dAoJCQkJLy8gdGhlbiBub3JtYWxpemUgc3RhdHVzVGV4dCBhbmQgc3RhdHVzIGZvciBub24tYWJvcnRzCgkJCQllcnJvciA9IHN0YXR1c1RleHQ7CgkJCQlpZiAoICFzdGF0dXNUZXh0IHx8IHN0YXR1cyApIHsKCQkJCQlzdGF0dXNUZXh0ID0gImVycm9yIjsKCQkJCQlpZiAoIHN0YXR1cyA8IDAgKSB7CgkJCQkJCXN0YXR1cyA9IDA7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBTZXQgZGF0YSBmb3IgdGhlIGZha2UgeGhyIG9iamVjdAoJCQlqcVhIUi5zdGF0dXMgPSBzdGF0dXM7CgkJCWpxWEhSLnN0YXR1c1RleHQgPSAiIiArICggbmF0aXZlU3RhdHVzVGV4dCB8fCBzdGF0dXNUZXh0ICk7CgoJCQkvLyBTdWNjZXNzL0Vycm9yCgkJCWlmICggaXNTdWNjZXNzICkgewoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBzdWNjZXNzLCBzdGF0dXNUZXh0LCBqcVhIUiBdICk7CgkJCX0gZWxzZSB7CgkJCQlkZWZlcnJlZC5yZWplY3RXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsganFYSFIsIHN0YXR1c1RleHQsIGVycm9yIF0gKTsKCQkJfQoKCQkJLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKCQkJanFYSFIuc3RhdHVzQ29kZSggc3RhdHVzQ29kZSApOwoJCQlzdGF0dXNDb2RlID0gdW5kZWZpbmVkOwoKCQkJaWYgKCBmaXJlR2xvYmFscyApIHsKCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheCIgKyAoIGlzU3VjY2VzcyA/ICJTdWNjZXNzIiA6ICJFcnJvciIgKSwKCQkJCQkJWyBqcVhIUiwgcywgaXNTdWNjZXNzID8gc3VjY2VzcyA6IGVycm9yIF0gKTsKCQkJfQoKCQkJLy8gQ29tcGxldGUKCQkJY29tcGxldGVEZWZlcnJlZC5maXJlV2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0IF0gKTsKCgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhDb21wbGV0ZSIsIFsganFYSFIsIHMgXSApOwoJCQkJLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCgkJCQlpZiAoICEoIC0talF1ZXJ5LmFjdGl2ZSApICkgewoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCAiYWpheFN0b3AiICk7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIEF0dGFjaCBkZWZlcnJlZHMKCQlkZWZlcnJlZC5wcm9taXNlKCBqcVhIUiApOwoJCWpxWEhSLnN1Y2Nlc3MgPSBqcVhIUi5kb25lOwoJCWpxWEhSLmVycm9yID0ganFYSFIuZmFpbDsKCQlqcVhIUi5jb21wbGV0ZSA9IGNvbXBsZXRlRGVmZXJyZWQuYWRkOwoKCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCWpxWEhSLnN0YXR1c0NvZGUgPSBmdW5jdGlvbiggbWFwICkgewoJCQlpZiAoIG1hcCApIHsKCQkJCXZhciB0bXA7CgkJCQlpZiAoIHN0YXRlIDwgMiApIHsKCQkJCQlmb3IgKCB0bXAgaW4gbWFwICkgewoJCQkJCQlzdGF0dXNDb2RlWyB0bXAgXSA9IFsgc3RhdHVzQ29kZVt0bXBdLCBtYXBbdG1wXSBdOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdG1wID0gbWFwWyBqcVhIUi5zdGF0dXMgXTsKCQkJCQlqcVhIUi5hbHdheXMoIHRtcCApOwoJCQkJfQoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX07CgoJCS8vIFJlbW92ZSBoYXNoIGNoYXJhY3RlciAoIzc1MzE6IGFuZCBzdHJpbmcgcHJvbW90aW9uKQoJCS8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKCM1ODY2OiBJRTcgaXNzdWUgd2l0aCBwcm90b2NvbC1sZXNzIHVybHMpCgkJLy8gV2UgYWxzbyB1c2UgdGhlIHVybCBwYXJhbWV0ZXIgaWYgYXZhaWxhYmxlCgkJcy51cmwgPSAoICggdXJsIHx8IHMudXJsICkgKyAiIiApLnJlcGxhY2UoIHJoYXNoLCAiIiApLnJlcGxhY2UoIHJwcm90b2NvbCwgYWpheExvY1BhcnRzWyAxIF0gKyAiLy8iICk7CgoJCS8vIEV4dHJhY3QgZGF0YVR5cGVzIGxpc3QKCQlzLmRhdGFUeXBlcyA9IGpRdWVyeS50cmltKCBzLmRhdGFUeXBlIHx8ICIqIiApLnRvTG93ZXJDYXNlKCkuc3BsaXQoIGNvcmVfcnNwYWNlICk7CgoJCS8vIERldGVybWluZSBpZiBhIGNyb3NzLWRvbWFpbiByZXF1ZXN0IGlzIGluIG9yZGVyCgkJaWYgKCBzLmNyb3NzRG9tYWluID09IG51bGwgKSB7CgkJCXBhcnRzID0gcnVybC5leGVjKCBzLnVybC50b0xvd2VyQ2FzZSgpICk7CgkJCXMuY3Jvc3NEb21haW4gPSAhISggcGFydHMgJiYKCQkJCSggcGFydHNbIDEgXSAhPSBhamF4TG9jUGFydHNbIDEgXSB8fCBwYXJ0c1sgMiBdICE9IGFqYXhMb2NQYXJ0c1sgMiBdIHx8CgkJCQkJKCBwYXJ0c1sgMyBdIHx8ICggcGFydHNbIDEgXSA9PT0gImh0dHA6IiA/IDgwIDogNDQzICkgKSAhPQoJCQkJCQkoIGFqYXhMb2NQYXJ0c1sgMyBdIHx8ICggYWpheExvY1BhcnRzWyAxIF0gPT09ICJodHRwOiIgPyA4MCA6IDQ0MyApICkgKQoJCQkpOwoJCX0KCgkJLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCgkJaWYgKCBzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAic3RyaW5nIiApIHsKCQkJcy5kYXRhID0galF1ZXJ5LnBhcmFtKCBzLmRhdGEsIHMudHJhZGl0aW9uYWwgKTsKCQl9CgoJCS8vIEFwcGx5IHByZWZpbHRlcnMKCQlpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycywgcywgb3B0aW9ucywganFYSFIgKTsKCgkJLy8gSWYgcmVxdWVzdCB3YXMgYWJvcnRlZCBpbnNpZGUgYSBwcmVmaWx0ZXIsIHN0b3AgdGhlcmUKCQlpZiAoIHN0YXRlID09PSAyICkgewoJCQlyZXR1cm4ganFYSFI7CgkJfQoKCQkvLyBXZSBjYW4gZmlyZSBnbG9iYWwgZXZlbnRzIGFzIG9mIG5vdyBpZiBhc2tlZCB0bwoJCWZpcmVHbG9iYWxzID0gcy5nbG9iYWw7CgoJCS8vIFVwcGVyY2FzZSB0aGUgdHlwZQoJCXMudHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwoKCQkvLyBEZXRlcm1pbmUgaWYgcmVxdWVzdCBoYXMgY29udGVudAoJCXMuaGFzQ29udGVudCA9ICFybm9Db250ZW50LnRlc3QoIHMudHlwZSApOwoKCQkvLyBXYXRjaCBmb3IgYSBuZXcgc2V0IG9mIHJlcXVlc3RzCgkJaWYgKCBmaXJlR2xvYmFscyAmJiBqUXVlcnkuYWN0aXZlKysgPT09IDAgKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCAiYWpheFN0YXJ0IiApOwoJCX0KCgkJLy8gTW9yZSBvcHRpb25zIGhhbmRsaW5nIGZvciByZXF1ZXN0cyB3aXRoIG5vIGNvbnRlbnQKCQlpZiAoICFzLmhhc0NvbnRlbnQgKSB7CgoJCQkvLyBJZiBkYXRhIGlzIGF2YWlsYWJsZSwgYXBwZW5kIGRhdGEgdG8gdXJsCgkJCWlmICggcy5kYXRhICkgewoJCQkJcy51cmwgKz0gKCBycXVlcnkudGVzdCggcy51cmwgKSA/ICImIiA6ICI/IiApICsgcy5kYXRhOwoJCQkJLy8gIzk2ODI6IHJlbW92ZSBkYXRhIHNvIHRoYXQgaXQncyBub3QgdXNlZCBpbiBhbiBldmVudHVhbCByZXRyeQoJCQkJZGVsZXRlIHMuZGF0YTsKCQkJfQoKCQkJLy8gR2V0IGlmTW9kaWZpZWRLZXkgYmVmb3JlIGFkZGluZyB0aGUgYW50aS1jYWNoZSBwYXJhbWV0ZXIKCQkJaWZNb2RpZmllZEtleSA9IHMudXJsOwoKCQkJLy8gQWRkIGFudGktY2FjaGUgaW4gdXJsIGlmIG5lZWRlZAoJCQlpZiAoIHMuY2FjaGUgPT09IGZhbHNlICkgewoKCQkJCXZhciB0cyA9IGpRdWVyeS5ub3coKSwKCQkJCQkvLyB0cnkgcmVwbGFjaW5nIF89IGlmIGl0IGlzIHRoZXJlCgkJCQkJcmV0ID0gcy51cmwucmVwbGFjZSggcnRzLCAiJDFfPSIgKyB0cyApOwoKCQkJCS8vIGlmIG5vdGhpbmcgd2FzIHJlcGxhY2VkLCBhZGQgdGltZXN0YW1wIHRvIHRoZSBlbmQKCQkJCXMudXJsID0gcmV0ICsgKCAoIHJldCA9PT0gcy51cmwgKSA/ICggcnF1ZXJ5LnRlc3QoIHMudXJsICkgPyAiJiIgOiAiPyIgKSArICJfPSIgKyB0cyA6ICIiICk7CgkJCX0KCQl9CgoJCS8vIFNldCB0aGUgY29ycmVjdCBoZWFkZXIsIGlmIGRhdGEgaXMgYmVpbmcgc2VudAoJCWlmICggcy5kYXRhICYmIHMuaGFzQ29udGVudCAmJiBzLmNvbnRlbnRUeXBlICE9PSBmYWxzZSB8fCBvcHRpb25zLmNvbnRlbnRUeXBlICkgewoJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiQ29udGVudC1UeXBlIiwgcy5jb250ZW50VHlwZSApOwoJCX0KCgkJLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KCQlpZiAoIHMuaWZNb2RpZmllZCApIHsKCQkJaWZNb2RpZmllZEtleSA9IGlmTW9kaWZpZWRLZXkgfHwgcy51cmw7CgkJCWlmICggalF1ZXJ5Lmxhc3RNb2RpZmllZFsgaWZNb2RpZmllZEtleSBdICkgewoJCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU1vZGlmaWVkLVNpbmNlIiwgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgaWZNb2RpZmllZEtleSBdICk7CgkJCX0KCQkJaWYgKCBqUXVlcnkuZXRhZ1sgaWZNb2RpZmllZEtleSBdICkgewoJCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU5vbmUtTWF0Y2giLCBqUXVlcnkuZXRhZ1sgaWZNb2RpZmllZEtleSBdICk7CgkJCX0KCQl9CgoJCS8vIFNldCB0aGUgQWNjZXB0cyBoZWFkZXIgZm9yIHRoZSBzZXJ2ZXIsIGRlcGVuZGluZyBvbiB0aGUgZGF0YVR5cGUKCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkiQWNjZXB0IiwKCQkJcy5kYXRhVHlwZXNbIDAgXSAmJiBzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWzBdIF0gPwoJCQkJcy5hY2NlcHRzWyBzLmRhdGFUeXBlc1swXSBdICsgKCBzLmRhdGFUeXBlc1sgMCBdICE9PSAiKiIgPyAiLCAiICsgYWxsVHlwZXMgKyAiOyBxPTAuMDEiIDogIiIgKSA6CgkJCQlzLmFjY2VwdHNbICIqIiBdCgkJKTsKCgkJLy8gQ2hlY2sgZm9yIGhlYWRlcnMgb3B0aW9uCgkJZm9yICggaSBpbiBzLmhlYWRlcnMgKSB7CgkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIGksIHMuaGVhZGVyc1sgaSBdICk7CgkJfQoKCQkvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0CgkJaWYgKCBzLmJlZm9yZVNlbmQgJiYgKCBzLmJlZm9yZVNlbmQuY2FsbCggY2FsbGJhY2tDb250ZXh0LCBqcVhIUiwgcyApID09PSBmYWxzZSB8fCBzdGF0ZSA9PT0gMiApICkgewoJCQkJLy8gQWJvcnQgaWYgbm90IGRvbmUgYWxyZWFkeSBhbmQgcmV0dXJuCgkJCQlyZXR1cm4ganFYSFIuYWJvcnQoKTsKCgkJfQoKCQkvLyBhYm9ydGluZyBpcyBubyBsb25nZXIgYSBjYW5jZWxsYXRpb24KCQlzdHJBYm9ydCA9ICJhYm9ydCI7CgoJCS8vIEluc3RhbGwgY2FsbGJhY2tzIG9uIGRlZmVycmVkcwoJCWZvciAoIGkgaW4geyBzdWNjZXNzOiAxLCBlcnJvcjogMSwgY29tcGxldGU6IDEgfSApIHsKCQkJanFYSFJbIGkgXSggc1sgaSBdICk7CgkJfQoKCQkvLyBHZXQgdHJhbnNwb3J0CgkJdHJhbnNwb3J0ID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHRyYW5zcG9ydHMsIHMsIG9wdGlvbnMsIGpxWEhSICk7CgoJCS8vIElmIG5vIHRyYW5zcG9ydCwgd2UgYXV0by1hYm9ydAoJCWlmICggIXRyYW5zcG9ydCApIHsKCQkJZG9uZSggLTEsICJObyBUcmFuc3BvcnQiICk7CgkJfSBlbHNlIHsKCQkJanFYSFIucmVhZHlTdGF0ZSA9IDE7CgkJCS8vIFNlbmQgZ2xvYmFsIGV2ZW50CgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhTZW5kIiwgWyBqcVhIUiwgcyBdICk7CgkJCX0KCQkJLy8gVGltZW91dAoJCQlpZiAoIHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCApIHsKCQkJCXRpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCl7CgkJCQkJanFYSFIuYWJvcnQoICJ0aW1lb3V0IiApOwoJCQkJfSwgcy50aW1lb3V0ICk7CgkJCX0KCgkJCXRyeSB7CgkJCQlzdGF0ZSA9IDE7CgkJCQl0cmFuc3BvcnQuc2VuZCggcmVxdWVzdEhlYWRlcnMsIGRvbmUgKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQoJCQkJaWYgKCBzdGF0ZSA8IDIgKSB7CgkJCQkJZG9uZSggLTEsIGUgKTsKCQkJCS8vIFNpbXBseSByZXRocm93IG90aGVyd2lzZQoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyBlOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4ganFYSFI7Cgl9LAoKCS8vIENvdW50ZXIgZm9yIGhvbGRpbmcgdGhlIG51bWJlciBvZiBhY3RpdmUgcXVlcmllcwoJYWN0aXZlOiAwLAoKCS8vIExhc3QtTW9kaWZpZWQgaGVhZGVyIGNhY2hlIGZvciBuZXh0IHJlcXVlc3QKCWxhc3RNb2RpZmllZDoge30sCglldGFnOiB7fQoKfSk7CgovKiBIYW5kbGVzIHJlc3BvbnNlcyB0byBhbiBhamF4IHJlcXVlc3Q6CiAqIC0gc2V0cyBhbGwgcmVzcG9uc2VYWFggZmllbGRzIGFjY29yZGluZ2x5CiAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAqIC0gcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogKi8KZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApIHsKCgl2YXIgY3QsIHR5cGUsIGZpbmFsRGF0YVR5cGUsIGZpcnN0RGF0YVR5cGUsCgkJY29udGVudHMgPSBzLmNvbnRlbnRzLAoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLAoJCXJlc3BvbnNlRmllbGRzID0gcy5yZXNwb25zZUZpZWxkczsKCgkvLyBGaWxsIHJlc3BvbnNlWFhYIGZpZWxkcwoJZm9yICggdHlwZSBpbiByZXNwb25zZUZpZWxkcyApIHsKCQlpZiAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewoJCQlqcVhIUlsgcmVzcG9uc2VGaWVsZHNbdHlwZV0gXSA9IHJlc3BvbnNlc1sgdHlwZSBdOwoJCX0KCX0KCgkvLyBSZW1vdmUgYXV0byBkYXRhVHlwZSBhbmQgZ2V0IGNvbnRlbnQtdHlwZSBpbiB0aGUgcHJvY2VzcwoJd2hpbGUoIGRhdGFUeXBlc1sgMCBdID09PSAiKiIgKSB7CgkJZGF0YVR5cGVzLnNoaWZ0KCk7CgkJaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgewoJCQljdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoICJjb250ZW50LXR5cGUiICk7CgkJfQoJfQoKCS8vIENoZWNrIGlmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGtub3duIGNvbnRlbnQtdHlwZQoJaWYgKCBjdCApIHsKCQlmb3IgKCB0eXBlIGluIGNvbnRlbnRzICkgewoJCQlpZiAoIGNvbnRlbnRzWyB0eXBlIF0gJiYgY29udGVudHNbIHR5cGUgXS50ZXN0KCBjdCApICkgewoJCQkJZGF0YVR5cGVzLnVuc2hpZnQoIHR5cGUgKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQoKCS8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQoJaWYgKCBkYXRhVHlwZXNbIDAgXSBpbiByZXNwb25zZXMgKSB7CgkJZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1sgMCBdOwoJfSBlbHNlIHsKCQkvLyBUcnkgY29udmVydGlibGUgZGF0YVR5cGVzCgkJZm9yICggdHlwZSBpbiByZXNwb25zZXMgKSB7CgkJCWlmICggIWRhdGFUeXBlc1sgMCBdIHx8IHMuY29udmVydGVyc1sgdHlwZSArICIgIiArIGRhdGFUeXBlc1swXSBdICkgewoJCQkJZmluYWxEYXRhVHlwZSA9IHR5cGU7CgkJCQlicmVhazsKCQkJfQoJCQlpZiAoICFmaXJzdERhdGFUeXBlICkgewoJCQkJZmlyc3REYXRhVHlwZSA9IHR5cGU7CgkJCX0KCQl9CgkJLy8gT3IganVzdCB1c2UgZmlyc3Qgb25lCgkJZmluYWxEYXRhVHlwZSA9IGZpbmFsRGF0YVR5cGUgfHwgZmlyc3REYXRhVHlwZTsKCX0KCgkvLyBJZiB3ZSBmb3VuZCBhIGRhdGFUeXBlCgkvLyBXZSBhZGQgdGhlIGRhdGFUeXBlIHRvIHRoZSBsaXN0IGlmIG5lZWRlZAoJLy8gYW5kIHJldHVybiB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQoJaWYgKCBmaW5hbERhdGFUeXBlICkgewoJCWlmICggZmluYWxEYXRhVHlwZSAhPT0gZGF0YVR5cGVzWyAwIF0gKSB7CgkJCWRhdGFUeXBlcy51bnNoaWZ0KCBmaW5hbERhdGFUeXBlICk7CgkJfQoJCXJldHVybiByZXNwb25zZXNbIGZpbmFsRGF0YVR5cGUgXTsKCX0KfQoKLy8gQ2hhaW4gY29udmVyc2lvbnMgZ2l2ZW4gdGhlIHJlcXVlc3QgYW5kIHRoZSBvcmlnaW5hbCByZXNwb25zZQpmdW5jdGlvbiBhamF4Q29udmVydCggcywgcmVzcG9uc2UgKSB7CgoJdmFyIGNvbnYsIGNvbnYyLCBjdXJyZW50LCB0bXAsCgkJLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLnNsaWNlKCksCgkJcHJldiA9IGRhdGFUeXBlc1sgMCBdLAoJCWNvbnZlcnRlcnMgPSB7fSwKCQlpID0gMDsKCgkvLyBBcHBseSB0aGUgZGF0YUZpbHRlciBpZiBwcm92aWRlZAoJaWYgKCBzLmRhdGFGaWx0ZXIgKSB7CgkJcmVzcG9uc2UgPSBzLmRhdGFGaWx0ZXIoIHJlc3BvbnNlLCBzLmRhdGFUeXBlICk7Cgl9CgoJLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzCglpZiAoIGRhdGFUeXBlc1sgMSBdICkgewoJCWZvciAoIGNvbnYgaW4gcy5jb252ZXJ0ZXJzICkgewoJCQljb252ZXJ0ZXJzWyBjb252LnRvTG93ZXJDYXNlKCkgXSA9IHMuY29udmVydGVyc1sgY29udiBdOwoJCX0KCX0KCgkvLyBDb252ZXJ0IHRvIGVhY2ggc2VxdWVudGlhbCBkYXRhVHlwZSwgdG9sZXJhdGluZyBsaXN0IG1vZGlmaWNhdGlvbgoJZm9yICggOyAoY3VycmVudCA9IGRhdGFUeXBlc1srK2ldKTsgKSB7CgoJCS8vIFRoZXJlJ3Mgb25seSB3b3JrIHRvIGRvIGlmIGN1cnJlbnQgZGF0YVR5cGUgaXMgbm9uLWF1dG8KCQlpZiAoIGN1cnJlbnQgIT09ICIqIiApIHsKCgkJCS8vIENvbnZlcnQgcmVzcG9uc2UgaWYgcHJldiBkYXRhVHlwZSBpcyBub24tYXV0byBhbmQgZGlmZmVycyBmcm9tIGN1cnJlbnQKCQkJaWYgKCBwcmV2ICE9PSAiKiIgJiYgcHJldiAhPT0gY3VycmVudCApIHsKCgkJCQkvLyBTZWVrIGEgZGlyZWN0IGNvbnZlcnRlcgoJCQkJY29udiA9IGNvbnZlcnRlcnNbIHByZXYgKyAiICIgKyBjdXJyZW50IF0gfHwgY29udmVydGVyc1sgIiogIiArIGN1cnJlbnQgXTsKCgkJCQkvLyBJZiBub25lIGZvdW5kLCBzZWVrIGEgcGFpcgoJCQkJaWYgKCAhY29udiApIHsKCQkJCQlmb3IgKCBjb252MiBpbiBjb252ZXJ0ZXJzICkgewoKCQkJCQkJLy8gSWYgY29udjIgb3V0cHV0cyBjdXJyZW50CgkJCQkJCXRtcCA9IGNvbnYyLnNwbGl0KCIgIik7CgkJCQkJCWlmICggdG1wWyAxIF0gPT09IGN1cnJlbnQgKSB7CgoJCQkJCQkJLy8gSWYgcHJldiBjYW4gYmUgY29udmVydGVkIHRvIGFjY2VwdGVkIGlucHV0CgkJCQkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIHRtcFsgMCBdIF0gfHwKCQkJCQkJCQljb252ZXJ0ZXJzWyAiKiAiICsgdG1wWyAwIF0gXTsKCQkJCQkJCWlmICggY29udiApIHsKCQkJCQkJCQkvLyBDb25kZW5zZSBlcXVpdmFsZW5jZSBjb252ZXJ0ZXJzCgkJCQkJCQkJaWYgKCBjb252ID09PSB0cnVlICkgewoJCQkJCQkJCQljb252ID0gY29udmVydGVyc1sgY29udjIgXTsKCgkJCQkJCQkJLy8gT3RoZXJ3aXNlLCBpbnNlcnQgdGhlIGludGVybWVkaWF0ZSBkYXRhVHlwZQoJCQkJCQkJCX0gZWxzZSBpZiAoIGNvbnZlcnRlcnNbIGNvbnYyIF0gIT09IHRydWUgKSB7CgkJCQkJCQkJCWN1cnJlbnQgPSB0bXBbIDAgXTsKCQkJCQkJCQkJZGF0YVR5cGVzLnNwbGljZSggaS0tLCAwLCBjdXJyZW50ICk7CgkJCQkJCQkJfQoKCQkJCQkJCQlicmVhazsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBBcHBseSBjb252ZXJ0ZXIgKGlmIG5vdCBhbiBlcXVpdmFsZW5jZSkKCQkJCWlmICggY29udiAhPT0gdHJ1ZSApIHsKCgkJCQkJLy8gVW5sZXNzIGVycm9ycyBhcmUgYWxsb3dlZCB0byBidWJibGUsIGNhdGNoIGFuZCByZXR1cm4gdGhlbQoJCQkJCWlmICggY29udiAmJiBzWyJ0aHJvd3MiXSApIHsKCQkJCQkJcmVzcG9uc2UgPSBjb252KCByZXNwb25zZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CgkJCQkJCX0gY2F0Y2ggKCBlICkgewoJCQkJCQkJcmV0dXJuIHsgc3RhdGU6ICJwYXJzZXJlcnJvciIsIGVycm9yOiBjb252ID8gZSA6ICJObyBjb252ZXJzaW9uIGZyb20gIiArIHByZXYgKyAiIHRvICIgKyBjdXJyZW50IH07CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIFVwZGF0ZSBwcmV2IGZvciBuZXh0IGl0ZXJhdGlvbgoJCQlwcmV2ID0gY3VycmVudDsKCQl9Cgl9CgoJcmV0dXJuIHsgc3RhdGU6ICJzdWNjZXNzIiwgZGF0YTogcmVzcG9uc2UgfTsKfQp2YXIgb2xkQ2FsbGJhY2tzID0gW10sCglycXVlc3Rpb24gPSAvXD8vLAoJcmpzb25wID0gLyg9KVw/KD89JnwkKXxcP1w/LywKCW5vbmNlID0galF1ZXJ5Lm5vdygpOwoKLy8gRGVmYXVsdCBqc29ucCBzZXR0aW5ncwpqUXVlcnkuYWpheFNldHVwKHsKCWpzb25wOiAiY2FsbGJhY2siLAoJanNvbnBDYWxsYmFjazogZnVuY3Rpb24oKSB7CgkJdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8ICggalF1ZXJ5LmV4cGFuZG8gKyAiXyIgKyAoIG5vbmNlKysgKSApOwoJCXRoaXNbIGNhbGxiYWNrIF0gPSB0cnVlOwoJCXJldHVybiBjYWxsYmFjazsKCX0KfSk7CgovLyBEZXRlY3QsIG5vcm1hbGl6ZSBvcHRpb25zIGFuZCBpbnN0YWxsIGNhbGxiYWNrcyBmb3IganNvbnAgcmVxdWVzdHMKalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoICJqc29uIGpzb25wIiwgZnVuY3Rpb24oIHMsIG9yaWdpbmFsU2V0dGluZ3MsIGpxWEhSICkgewoKCXZhciBjYWxsYmFja05hbWUsIG92ZXJ3cml0dGVuLCByZXNwb25zZUNvbnRhaW5lciwKCQlkYXRhID0gcy5kYXRhLAoJCXVybCA9IHMudXJsLAoJCWhhc0NhbGxiYWNrID0gcy5qc29ucCAhPT0gZmFsc2UsCgkJcmVwbGFjZUluVXJsID0gaGFzQ2FsbGJhY2sgJiYgcmpzb25wLnRlc3QoIHVybCApLAoJCXJlcGxhY2VJbkRhdGEgPSBoYXNDYWxsYmFjayAmJiAhcmVwbGFjZUluVXJsICYmIHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiAmJgoJCQkhKCBzLmNvbnRlbnRUeXBlIHx8ICIiICkuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgJiYKCQkJcmpzb25wLnRlc3QoIGRhdGEgKTsKCgkvLyBIYW5kbGUgaWZmIHRoZSBleHBlY3RlZCBkYXRhIHR5cGUgaXMgImpzb25wIiBvciB3ZSBoYXZlIGEgcGFyYW1ldGVyIHRvIHNldAoJaWYgKCBzLmRhdGFUeXBlc1sgMCBdID09PSAianNvbnAiIHx8IHJlcGxhY2VJblVybCB8fCByZXBsYWNlSW5EYXRhICkgewoKCQkvLyBHZXQgY2FsbGJhY2sgbmFtZSwgcmVtZW1iZXJpbmcgcHJlZXhpc3RpbmcgdmFsdWUgYXNzb2NpYXRlZCB3aXRoIGl0CgkJY2FsbGJhY2tOYW1lID0gcy5qc29ucENhbGxiYWNrID0galF1ZXJ5LmlzRnVuY3Rpb24oIHMuanNvbnBDYWxsYmFjayApID8KCQkJcy5qc29ucENhbGxiYWNrKCkgOgoJCQlzLmpzb25wQ2FsbGJhY2s7CgkJb3ZlcndyaXR0ZW4gPSB3aW5kb3dbIGNhbGxiYWNrTmFtZSBdOwoKCQkvLyBJbnNlcnQgY2FsbGJhY2sgaW50byB1cmwgb3IgZm9ybSBkYXRhCgkJaWYgKCByZXBsYWNlSW5VcmwgKSB7CgkJCXMudXJsID0gdXJsLnJlcGxhY2UoIHJqc29ucCwgIiQxIiArIGNhbGxiYWNrTmFtZSApOwoJCX0gZWxzZSBpZiAoIHJlcGxhY2VJbkRhdGEgKSB7CgkJCXMuZGF0YSA9IGRhdGEucmVwbGFjZSggcmpzb25wLCAiJDEiICsgY2FsbGJhY2tOYW1lICk7CgkJfSBlbHNlIGlmICggaGFzQ2FsbGJhY2sgKSB7CgkJCXMudXJsICs9ICggcnF1ZXN0aW9uLnRlc3QoIHVybCApID8gIiYiIDogIj8iICkgKyBzLmpzb25wICsgIj0iICsgY2FsbGJhY2tOYW1lOwoJCX0KCgkJLy8gVXNlIGRhdGEgY29udmVydGVyIHRvIHJldHJpZXZlIGpzb24gYWZ0ZXIgc2NyaXB0IGV4ZWN1dGlvbgoJCXMuY29udmVydGVyc1sic2NyaXB0IGpzb24iXSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFyZXNwb25zZUNvbnRhaW5lciApIHsKCQkJCWpRdWVyeS5lcnJvciggY2FsbGJhY2tOYW1lICsgIiB3YXMgbm90IGNhbGxlZCIgKTsKCQkJfQoJCQlyZXR1cm4gcmVzcG9uc2VDb250YWluZXJbIDAgXTsKCQl9OwoKCQkvLyBmb3JjZSBqc29uIGRhdGFUeXBlCgkJcy5kYXRhVHlwZXNbIDAgXSA9ICJqc29uIjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFjawoJCXdpbmRvd1sgY2FsbGJhY2tOYW1lIF0gPSBmdW5jdGlvbigpIHsKCQkJcmVzcG9uc2VDb250YWluZXIgPSBhcmd1bWVudHM7CgkJfTsKCgkJLy8gQ2xlYW4tdXAgZnVuY3Rpb24gKGZpcmVzIGFmdGVyIGNvbnZlcnRlcnMpCgkJanFYSFIuYWx3YXlzKGZ1bmN0aW9uKCkgewoJCQkvLyBSZXN0b3JlIHByZWV4aXN0aW5nIHZhbHVlCgkJCXdpbmRvd1sgY2FsbGJhY2tOYW1lIF0gPSBvdmVyd3JpdHRlbjsKCgkJCS8vIFNhdmUgYmFjayBhcyBmcmVlCgkJCWlmICggc1sgY2FsbGJhY2tOYW1lIF0gKSB7CgkJCQkvLyBtYWtlIHN1cmUgdGhhdCByZS11c2luZyB0aGUgb3B0aW9ucyBkb2Vzbid0IHNjcmV3IHRoaW5ncyBhcm91bmQKCQkJCXMuanNvbnBDYWxsYmFjayA9IG9yaWdpbmFsU2V0dGluZ3MuanNvbnBDYWxsYmFjazsKCgkJCQkvLyBzYXZlIHRoZSBjYWxsYmFjayBuYW1lIGZvciBmdXR1cmUgdXNlCgkJCQlvbGRDYWxsYmFja3MucHVzaCggY2FsbGJhY2tOYW1lICk7CgkJCX0KCgkJCS8vIENhbGwgaWYgaXQgd2FzIGEgZnVuY3Rpb24gYW5kIHdlIGhhdmUgYSByZXNwb25zZQoJCQlpZiAoIHJlc3BvbnNlQ29udGFpbmVyICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBvdmVyd3JpdHRlbiApICkgewoJCQkJb3ZlcndyaXR0ZW4oIHJlc3BvbnNlQ29udGFpbmVyWyAwIF0gKTsKCQkJfQoKCQkJcmVzcG9uc2VDb250YWluZXIgPSBvdmVyd3JpdHRlbiA9IHVuZGVmaW5lZDsKCQl9KTsKCgkJLy8gRGVsZWdhdGUgdG8gc2NyaXB0CgkJcmV0dXJuICJzY3JpcHQiOwoJfQp9KTsKLy8gSW5zdGFsbCBzY3JpcHQgZGF0YVR5cGUKalF1ZXJ5LmFqYXhTZXR1cCh7CglhY2NlcHRzOiB7CgkJc2NyaXB0OiAidGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9lY21hc2NyaXB0LCBhcHBsaWNhdGlvbi94LWVjbWFzY3JpcHQiCgl9LAoJY29udGVudHM6IHsKCQlzY3JpcHQ6IC9qYXZhc2NyaXB0fGVjbWFzY3JpcHQvCgl9LAoJY29udmVydGVyczogewoJCSJ0ZXh0IHNjcmlwdCI6IGZ1bmN0aW9uKCB0ZXh0ICkgewoJCQlqUXVlcnkuZ2xvYmFsRXZhbCggdGV4dCApOwoJCQlyZXR1cm4gdGV4dDsKCQl9Cgl9Cn0pOwoKLy8gSGFuZGxlIGNhY2hlJ3Mgc3BlY2lhbCBjYXNlIGFuZCBnbG9iYWwKalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoICJzY3JpcHQiLCBmdW5jdGlvbiggcyApIHsKCWlmICggcy5jYWNoZSA9PT0gdW5kZWZpbmVkICkgewoJCXMuY2FjaGUgPSBmYWxzZTsKCX0KCWlmICggcy5jcm9zc0RvbWFpbiApIHsKCQlzLnR5cGUgPSAiR0VUIjsKCQlzLmdsb2JhbCA9IGZhbHNlOwoJfQp9KTsKCi8vIEJpbmQgc2NyaXB0IHRhZyBoYWNrIHRyYW5zcG9ydApqUXVlcnkuYWpheFRyYW5zcG9ydCggInNjcmlwdCIsIGZ1bmN0aW9uKHMpIHsKCgkvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIHJlcXVlc3RzCglpZiAoIHMuY3Jvc3NEb21haW4gKSB7CgoJCXZhciBzY3JpcHQsCgkJCWhlYWQgPSBkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAiaGVhZCIgKVswXSB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgoJCXJldHVybiB7CgoJCQlzZW5kOiBmdW5jdGlvbiggXywgY2FsbGJhY2sgKSB7CgoJCQkJc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNjcmlwdCIgKTsKCgkJCQlzY3JpcHQuYXN5bmMgPSAiYXN5bmMiOwoKCQkJCWlmICggcy5zY3JpcHRDaGFyc2V0ICkgewoJCQkJCXNjcmlwdC5jaGFyc2V0ID0gcy5zY3JpcHRDaGFyc2V0OwoJCQkJfQoKCQkJCXNjcmlwdC5zcmMgPSBzLnVybDsKCgkJCQkvLyBBdHRhY2ggaGFuZGxlcnMgZm9yIGFsbCBicm93c2VycwoJCQkJc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiggXywgaXNBYm9ydCApIHsKCgkJCQkJaWYgKCBpc0Fib3J0IHx8ICFzY3JpcHQucmVhZHlTdGF0ZSB8fCAvbG9hZGVkfGNvbXBsZXRlLy50ZXN0KCBzY3JpcHQucmVhZHlTdGF0ZSApICkgewoKCQkJCQkJLy8gSGFuZGxlIG1lbW9yeSBsZWFrIGluIElFCgkJCQkJCXNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKCgkJCQkJCS8vIFJlbW92ZSB0aGUgc2NyaXB0CgkJCQkJCWlmICggaGVhZCAmJiBzY3JpcHQucGFyZW50Tm9kZSApIHsKCQkJCQkJCWhlYWQucmVtb3ZlQ2hpbGQoIHNjcmlwdCApOwoJCQkJCQl9CgoJCQkJCQkvLyBEZXJlZmVyZW5jZSB0aGUgc2NyaXB0CgkJCQkJCXNjcmlwdCA9IHVuZGVmaW5lZDsKCgkJCQkJCS8vIENhbGxiYWNrIGlmIG5vdCBhYm9ydAoJCQkJCQlpZiAoICFpc0Fib3J0ICkgewoJCQkJCQkJY2FsbGJhY2soIDIwMCwgInN1Y2Nlc3MiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9OwoJCQkJLy8gVXNlIGluc2VydEJlZm9yZSBpbnN0ZWFkIG9mIGFwcGVuZENoaWxkICB0byBjaXJjdW12ZW50IGFuIElFNiBidWcuCgkJCQkvLyBUaGlzIGFyaXNlcyB3aGVuIGEgYmFzZSBub2RlIGlzIHVzZWQgKCMyNzA5IGFuZCAjNDM3OCkuCgkJCQloZWFkLmluc2VydEJlZm9yZSggc2NyaXB0LCBoZWFkLmZpcnN0Q2hpbGQgKTsKCQkJfSwKCgkJCWFib3J0OiBmdW5jdGlvbigpIHsKCQkJCWlmICggc2NyaXB0ICkgewoJCQkJCXNjcmlwdC5vbmxvYWQoIDAsIDEgKTsKCQkJCX0KCQkJfQoJCX07Cgl9Cn0pOwp2YXIgeGhyQ2FsbGJhY2tzLAoJLy8gIzUyODA6IEludGVybmV0IEV4cGxvcmVyIHdpbGwga2VlcCBjb25uZWN0aW9ucyBhbGl2ZSBpZiB3ZSBkb24ndCBhYm9ydCBvbiB1bmxvYWQKCXhock9uVW5sb2FkQWJvcnQgPSB3aW5kb3cuQWN0aXZlWE9iamVjdCA/IGZ1bmN0aW9uKCkgewoJCS8vIEFib3J0IGFsbCBwZW5kaW5nIHJlcXVlc3RzCgkJZm9yICggdmFyIGtleSBpbiB4aHJDYWxsYmFja3MgKSB7CgkJCXhockNhbGxiYWNrc1sga2V5IF0oIDAsIDEgKTsKCQl9Cgl9IDogZmFsc2UsCgl4aHJJZCA9IDA7CgovLyBGdW5jdGlvbnMgdG8gY3JlYXRlIHhocnMKZnVuY3Rpb24gY3JlYXRlU3RhbmRhcmRYSFIoKSB7Cgl0cnkgewoJCXJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7Cgl9IGNhdGNoKCBlICkge30KfQoKZnVuY3Rpb24gY3JlYXRlQWN0aXZlWEhSKCkgewoJdHJ5IHsKCQlyZXR1cm4gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KCAiTWljcm9zb2Z0LlhNTEhUVFAiICk7Cgl9IGNhdGNoKCBlICkge30KfQoKLy8gQ3JlYXRlIHRoZSByZXF1ZXN0IG9iamVjdAovLyAoVGhpcyBpcyBzdGlsbCBhdHRhY2hlZCB0byBhamF4U2V0dGluZ3MgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkpCmpRdWVyeS5hamF4U2V0dGluZ3MueGhyID0gd2luZG93LkFjdGl2ZVhPYmplY3QgPwoJLyogTWljcm9zb2Z0IGZhaWxlZCB0byBwcm9wZXJseQoJICogaW1wbGVtZW50IHRoZSBYTUxIdHRwUmVxdWVzdCBpbiBJRTcgKGNhbid0IHJlcXVlc3QgbG9jYWwgZmlsZXMpLAoJICogc28gd2UgdXNlIHRoZSBBY3RpdmVYT2JqZWN0IHdoZW4gaXQgaXMgYXZhaWxhYmxlCgkgKiBBZGRpdGlvbmFsbHkgWE1MSHR0cFJlcXVlc3QgY2FuIGJlIGRpc2FibGVkIGluIElFNy9JRTggc28KCSAqIHdlIG5lZWQgYSBmYWxsYmFjay4KCSAqLwoJZnVuY3Rpb24oKSB7CgkJcmV0dXJuICF0aGlzLmlzTG9jYWwgJiYgY3JlYXRlU3RhbmRhcmRYSFIoKSB8fCBjcmVhdGVBY3RpdmVYSFIoKTsKCX0gOgoJLy8gRm9yIGFsbCBvdGhlciBicm93c2VycywgdXNlIHRoZSBzdGFuZGFyZCBYTUxIdHRwUmVxdWVzdCBvYmplY3QKCWNyZWF0ZVN0YW5kYXJkWEhSOwoKLy8gRGV0ZXJtaW5lIHN1cHBvcnQgcHJvcGVydGllcwooZnVuY3Rpb24oIHhociApIHsKCWpRdWVyeS5leHRlbmQoIGpRdWVyeS5zdXBwb3J0LCB7CgkJYWpheDogISF4aHIsCgkJY29yczogISF4aHIgJiYgKCAid2l0aENyZWRlbnRpYWxzIiBpbiB4aHIgKQoJfSk7Cn0pKCBqUXVlcnkuYWpheFNldHRpbmdzLnhocigpICk7CgovLyBDcmVhdGUgdHJhbnNwb3J0IGlmIHRoZSBicm93c2VyIGNhbiBwcm92aWRlIGFuIHhocgppZiAoIGpRdWVyeS5zdXBwb3J0LmFqYXggKSB7CgoJalF1ZXJ5LmFqYXhUcmFuc3BvcnQoZnVuY3Rpb24oIHMgKSB7CgkJLy8gQ3Jvc3MgZG9tYWluIG9ubHkgYWxsb3dlZCBpZiBzdXBwb3J0ZWQgdGhyb3VnaCBYTUxIdHRwUmVxdWVzdAoJCWlmICggIXMuY3Jvc3NEb21haW4gfHwgalF1ZXJ5LnN1cHBvcnQuY29ycyApIHsKCgkJCXZhciBjYWxsYmFjazsKCgkJCXJldHVybiB7CgkJCQlzZW5kOiBmdW5jdGlvbiggaGVhZGVycywgY29tcGxldGUgKSB7CgoJCQkJCS8vIEdldCBhIG5ldyB4aHIKCQkJCQl2YXIgaGFuZGxlLCBpLAoJCQkJCQl4aHIgPSBzLnhocigpOwoKCQkJCQkvLyBPcGVuIHRoZSBzb2NrZXQKCQkJCQkvLyBQYXNzaW5nIG51bGwgdXNlcm5hbWUsIGdlbmVyYXRlcyBhIGxvZ2luIHBvcHVwIG9uIE9wZXJhICgjMjg2NSkKCQkJCQlpZiAoIHMudXNlcm5hbWUgKSB7CgkJCQkJCXhoci5vcGVuKCBzLnR5cGUsIHMudXJsLCBzLmFzeW5jLCBzLnVzZXJuYW1lLCBzLnBhc3N3b3JkICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJeGhyLm9wZW4oIHMudHlwZSwgcy51cmwsIHMuYXN5bmMgKTsKCQkJCQl9CgoJCQkJCS8vIEFwcGx5IGN1c3RvbSBmaWVsZHMgaWYgcHJvdmlkZWQKCQkJCQlpZiAoIHMueGhyRmllbGRzICkgewoJCQkJCQlmb3IgKCBpIGluIHMueGhyRmllbGRzICkgewoJCQkJCQkJeGhyWyBpIF0gPSBzLnhockZpZWxkc1sgaSBdOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkCgkJCQkJaWYgKCBzLm1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlICkgewoJCQkJCQl4aHIub3ZlcnJpZGVNaW1lVHlwZSggcy5taW1lVHlwZSApOwoJCQkJCX0KCgkJCQkJLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXIKCQkJCQkvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCgkJCQkJLy8gYWtpbiB0byBhIGppZ3NhdyBwdXp6bGUsIHdlIHNpbXBseSBuZXZlciBzZXQgaXQgdG8gYmUgc3VyZS4KCQkJCQkvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkKCQkJCQkvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KCQkJCQlpZiAoICFzLmNyb3NzRG9tYWluICYmICFoZWFkZXJzWyJYLVJlcXVlc3RlZC1XaXRoIl0gKSB7CgkJCQkJCWhlYWRlcnNbICJYLVJlcXVlc3RlZC1XaXRoIiBdID0gIlhNTEh0dHBSZXF1ZXN0IjsKCQkJCQl9CgoJCQkJCS8vIE5lZWQgYW4gZXh0cmEgdHJ5L2NhdGNoIGZvciBjcm9zcyBkb21haW4gcmVxdWVzdHMgaW4gRmlyZWZveCAzCgkJCQkJdHJ5IHsKCQkJCQkJZm9yICggaSBpbiBoZWFkZXJzICkgewoJCQkJCQkJeGhyLnNldFJlcXVlc3RIZWFkZXIoIGksIGhlYWRlcnNbIGkgXSApOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCggXyApIHt9CgoJCQkJCS8vIERvIHNlbmQgdGhlIHJlcXVlc3QKCQkJCQkvLyBUaGlzIG1heSByYWlzZSBhbiBleGNlcHRpb24gd2hpY2ggaXMgYWN0dWFsbHkKCQkJCQkvLyBoYW5kbGVkIGluIGpRdWVyeS5hamF4IChzbyBubyB0cnkvY2F0Y2ggaGVyZSkKCQkJCQl4aHIuc2VuZCggKCBzLmhhc0NvbnRlbnQgJiYgcy5kYXRhICkgfHwgbnVsbCApOwoKCQkJCQkvLyBMaXN0ZW5lcgoJCQkJCWNhbGxiYWNrID0gZnVuY3Rpb24oIF8sIGlzQWJvcnQgKSB7CgoJCQkJCQl2YXIgc3RhdHVzLAoJCQkJCQkJc3RhdHVzVGV4dCwKCQkJCQkJCXJlc3BvbnNlSGVhZGVycywKCQkJCQkJCXJlc3BvbnNlcywKCQkJCQkJCXhtbDsKCgkJCQkJCS8vIEZpcmVmb3ggdGhyb3dzIGV4Y2VwdGlvbnMgd2hlbiBhY2Nlc3NpbmcgcHJvcGVydGllcwoJCQkJCQkvLyBvZiBhbiB4aHIgd2hlbiBhIG5ldHdvcmsgZXJyb3Igb2NjdXJyZWQKCQkJCQkJLy8gaHR0cDovL2hlbHBmdWwua25vYnMtZGlhbHMuY29tL2luZGV4LnBocC9Db21wb25lbnRfcmV0dXJuZWRfZmFpbHVyZV9jb2RlOl8weDgwMDQwMTExXyhOU19FUlJPUl9OT1RfQVZBSUxBQkxFKQoJCQkJCQl0cnkgewoKCQkJCQkJCS8vIFdhcyBuZXZlciBjYWxsZWQgYW5kIGlzIGFib3J0ZWQgb3IgY29tcGxldGUKCQkJCQkJCWlmICggY2FsbGJhY2sgJiYgKCBpc0Fib3J0IHx8IHhoci5yZWFkeVN0YXRlID09PSA0ICkgKSB7CgoJCQkJCQkJCS8vIE9ubHkgY2FsbGVkIG9uY2UKCQkJCQkJCQljYWxsYmFjayA9IHVuZGVmaW5lZDsKCgkJCQkJCQkJLy8gRG8gbm90IGtlZXAgYXMgYWN0aXZlIGFueW1vcmUKCQkJCQkJCQlpZiAoIGhhbmRsZSApIHsKCQkJCQkJCQkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGpRdWVyeS5ub29wOwoJCQkJCQkJCQlpZiAoIHhock9uVW5sb2FkQWJvcnQgKSB7CgkJCQkJCQkJCQlkZWxldGUgeGhyQ2FsbGJhY2tzWyBoYW5kbGUgXTsKCQkJCQkJCQkJfQoJCQkJCQkJCX0KCgkJCQkJCQkJLy8gSWYgaXQncyBhbiBhYm9ydAoJCQkJCQkJCWlmICggaXNBYm9ydCApIHsKCQkJCQkJCQkJLy8gQWJvcnQgaXQgbWFudWFsbHkgaWYgbmVlZGVkCgkJCQkJCQkJCWlmICggeGhyLnJlYWR5U3RhdGUgIT09IDQgKSB7CgkJCQkJCQkJCQl4aHIuYWJvcnQoKTsKCQkJCQkJCQkJfQoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCXN0YXR1cyA9IHhoci5zdGF0dXM7CgkJCQkJCQkJCXJlc3BvbnNlSGVhZGVycyA9IHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKTsKCQkJCQkJCQkJcmVzcG9uc2VzID0ge307CgkJCQkJCQkJCXhtbCA9IHhoci5yZXNwb25zZVhNTDsKCgkJCQkJCQkJCS8vIENvbnN0cnVjdCByZXNwb25zZSBsaXN0CgkJCQkJCQkJCWlmICggeG1sICYmIHhtbC5kb2N1bWVudEVsZW1lbnQgLyogIzQ5NTggKi8gKSB7CgkJCQkJCQkJCQlyZXNwb25zZXMueG1sID0geG1sOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQkvLyBXaGVuIHJlcXVlc3RpbmcgYmluYXJ5IGRhdGEsIElFNi05IHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uCgkJCQkJCQkJCS8vIG9uIGFueSBhdHRlbXB0IHRvIGFjY2VzcyByZXNwb25zZVRleHQgKCMxMTQyNikKCQkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJCXJlc3BvbnNlcy50ZXh0ID0geGhyLnJlc3BvbnNlVGV4dDsKCQkJCQkJCQkJfSBjYXRjaCggXyApIHsKCQkJCQkJCQkJfQoKCQkJCQkJCQkJLy8gRmlyZWZveCB0aHJvd3MgYW4gZXhjZXB0aW9uIHdoZW4gYWNjZXNzaW5nCgkJCQkJCQkJCS8vIHN0YXR1c1RleHQgZm9yIGZhdWx0eSBjcm9zcy1kb21haW4gcmVxdWVzdHMKCQkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJCXN0YXR1c1RleHQgPSB4aHIuc3RhdHVzVGV4dDsKCQkJCQkJCQkJfSBjYXRjaCggZSApIHsKCQkJCQkJCQkJCS8vIFdlIG5vcm1hbGl6ZSB3aXRoIFdlYmtpdCBnaXZpbmcgYW4gZW1wdHkgc3RhdHVzVGV4dAoJCQkJCQkJCQkJc3RhdHVzVGV4dCA9ICIiOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQkvLyBGaWx0ZXIgc3RhdHVzIGZvciBub24gc3RhbmRhcmQgYmVoYXZpb3JzCgoJCQkJCQkJCQkvLyBJZiB0aGUgcmVxdWVzdCBpcyBsb2NhbCBhbmQgd2UgaGF2ZSBkYXRhOiBhc3N1bWUgYSBzdWNjZXNzCgkJCQkJCQkJCS8vIChzdWNjZXNzIHdpdGggbm8gZGF0YSB3b24ndCBnZXQgbm90aWZpZWQsIHRoYXQncyB0aGUgYmVzdCB3ZQoJCQkJCQkJCQkvLyBjYW4gZG8gZ2l2ZW4gY3VycmVudCBpbXBsZW1lbnRhdGlvbnMpCgkJCQkJCQkJCWlmICggIXN0YXR1cyAmJiBzLmlzTG9jYWwgJiYgIXMuY3Jvc3NEb21haW4gKSB7CgkJCQkJCQkJCQlzdGF0dXMgPSByZXNwb25zZXMudGV4dCA/IDIwMCA6IDQwNDsKCQkJCQkJCQkJLy8gSUUgLSAjMTQ1MDogc29tZXRpbWVzIHJldHVybnMgMTIyMyB3aGVuIGl0IHNob3VsZCBiZSAyMDQKCQkJCQkJCQkJfSBlbHNlIGlmICggc3RhdHVzID09PSAxMjIzICkgewoJCQkJCQkJCQkJc3RhdHVzID0gMjA0OwoJCQkJCQkJCQl9CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9IGNhdGNoKCBmaXJlZm94QWNjZXNzRXhjZXB0aW9uICkgewoJCQkJCQkJaWYgKCAhaXNBYm9ydCApIHsKCQkJCQkJCQljb21wbGV0ZSggLTEsIGZpcmVmb3hBY2Nlc3NFeGNlcHRpb24gKTsKCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJLy8gQ2FsbCBjb21wbGV0ZSBpZiBuZWVkZWQKCQkJCQkJaWYgKCByZXNwb25zZXMgKSB7CgkJCQkJCQljb21wbGV0ZSggc3RhdHVzLCBzdGF0dXNUZXh0LCByZXNwb25zZXMsIHJlc3BvbnNlSGVhZGVycyApOwoJCQkJCQl9CgkJCQkJfTsKCgkJCQkJaWYgKCAhcy5hc3luYyApIHsKCQkJCQkJLy8gaWYgd2UncmUgaW4gc3luYyBtb2RlIHdlIGZpcmUgdGhlIGNhbGxiYWNrCgkJCQkJCWNhbGxiYWNrKCk7CgkJCQkJfSBlbHNlIGlmICggeGhyLnJlYWR5U3RhdGUgPT09IDQgKSB7CgkJCQkJCS8vIChJRTYgJiBJRTcpIGlmIGl0J3MgaW4gY2FjaGUgYW5kIGhhcyBiZWVuCgkJCQkJCS8vIHJldHJpZXZlZCBkaXJlY3RseSB3ZSBuZWVkIHRvIGZpcmUgdGhlIGNhbGxiYWNrCgkJCQkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJaGFuZGxlID0gKyt4aHJJZDsKCQkJCQkJaWYgKCB4aHJPblVubG9hZEFib3J0ICkgewoJCQkJCQkJLy8gQ3JlYXRlIHRoZSBhY3RpdmUgeGhycyBjYWxsYmFja3MgbGlzdCBpZiBuZWVkZWQKCQkJCQkJCS8vIGFuZCBhdHRhY2ggdGhlIHVubG9hZCBoYW5kbGVyCgkJCQkJCQlpZiAoICF4aHJDYWxsYmFja3MgKSB7CgkJCQkJCQkJeGhyQ2FsbGJhY2tzID0ge307CgkJCQkJCQkJalF1ZXJ5KCB3aW5kb3cgKS51bmxvYWQoIHhock9uVW5sb2FkQWJvcnQgKTsKCQkJCQkJCX0KCQkJCQkJCS8vIEFkZCB0byBsaXN0IG9mIGFjdGl2ZSB4aHJzIGNhbGxiYWNrcwoJCQkJCQkJeGhyQ2FsbGJhY2tzWyBoYW5kbGUgXSA9IGNhbGxiYWNrOwoJCQkJCQl9CgkJCQkJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBjYWxsYmFjazsKCQkJCQl9CgkJCQl9LAoKCQkJCWFib3J0OiBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCQljYWxsYmFjaygwLDEpOwoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9Cgl9KTsKfQp2YXIgZnhOb3csIHRpbWVySWQsCglyZnh0eXBlcyA9IC9eKD86dG9nZ2xlfHNob3d8aGlkZSkkLywKCXJmeG51bSA9IG5ldyBSZWdFeHAoICJeKD86KFstK10pPXwpKCIgKyBjb3JlX3BudW0gKyAiKShbYS16JV0qKSQiLCAiaSIgKSwKCXJydW4gPSAvcXVldWVIb29rcyQvLAoJYW5pbWF0aW9uUHJlZmlsdGVycyA9IFsgZGVmYXVsdFByZWZpbHRlciBdLAoJdHdlZW5lcnMgPSB7CgkJIioiOiBbZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCQl2YXIgZW5kLCB1bml0LCBwcmV2U2NhbGUsCgkJCQl0d2VlbiA9IHRoaXMuY3JlYXRlVHdlZW4oIHByb3AsIHZhbHVlICksCgkJCQlwYXJ0cyA9IHJmeG51bS5leGVjKCB2YWx1ZSApLAoJCQkJdGFyZ2V0ID0gdHdlZW4uY3VyKCksCgkJCQlzdGFydCA9ICt0YXJnZXQgfHwgMCwKCQkJCXNjYWxlID0gMTsKCgkJCWlmICggcGFydHMgKSB7CgkJCQllbmQgPSArcGFydHNbMl07CgkJCQl1bml0ID0gcGFydHNbM10gfHwgKCBqUXVlcnkuY3NzTnVtYmVyWyBwcm9wIF0gPyAiIiA6ICJweCIgKTsKCgkJCQkvLyBXZSBuZWVkIHRvIGNvbXB1dGUgc3RhcnRpbmcgdmFsdWUKCQkJCWlmICggdW5pdCAhPT0gInB4IiAmJiBzdGFydCApIHsKCQkJCQkvLyBJdGVyYXRpdmVseSBhcHByb3hpbWF0ZSBmcm9tIGEgbm9uemVybyBzdGFydGluZyBwb2ludAoJCQkJCS8vIFByZWZlciB0aGUgY3VycmVudCBwcm9wZXJ0eSwgYmVjYXVzZSB0aGlzIHByb2Nlc3Mgd2lsbCBiZSB0cml2aWFsIGlmIGl0IHVzZXMgdGhlIHNhbWUgdW5pdHMKCQkJCQkvLyBGYWxsYmFjayB0byBlbmQgb3IgYSBzaW1wbGUgY29uc3RhbnQKCQkJCQlzdGFydCA9IGpRdWVyeS5jc3MoIHR3ZWVuLmVsZW0sIHByb3AsIHRydWUgKSB8fCBlbmQgfHwgMTsKCgkJCQkJZG8gewoJCQkJCQkvLyBJZiBwcmV2aW91cyBpdGVyYXRpb24gemVyb2VkIG91dCwgZG91YmxlIHVudGlsIHdlIGdldCAqc29tZXRoaW5nKgoJCQkJCQkvLyBVc2UgYSBzdHJpbmcgZm9yIGRvdWJsaW5nIGZhY3RvciBzbyB3ZSBkb24ndCBhY2NpZGVudGFsbHkgc2VlIHNjYWxlIGFzIHVuY2hhbmdlZCBiZWxvdwoJCQkJCQlwcmV2U2NhbGUgPSBzY2FsZSA9IHNjYWxlIHx8ICIuNSI7CgoJCQkJCQkvLyBBZGp1c3QgYW5kIGFwcGx5CgkJCQkJCXN0YXJ0ID0gc3RhcnQgLyBzY2FsZTsKCQkJCQkJalF1ZXJ5LnN0eWxlKCB0d2Vlbi5lbGVtLCBwcm9wLCBzdGFydCArIHVuaXQgKTsKCgkJCQkJCS8vIFVwZGF0ZSBzY2FsZSwgdG9sZXJhdGluZyB6ZXJvZXMgZnJvbSB0d2Vlbi5jdXIoKQoJCQkJCQlzY2FsZSA9IHR3ZWVuLmN1cigpIC8gdGFyZ2V0OwoKCQkJCQkvLyBTdG9wIGxvb3BpbmcgaWYgd2UndmUgaGl0IHRoZSBtYXJrIG9yIHNjYWxlIGlzIHVuY2hhbmdlZAoJCQkJCX0gd2hpbGUgKCBzY2FsZSAhPT0gMSAmJiBzY2FsZSAhPT0gcHJldlNjYWxlICk7CgkJCQl9CgoJCQkJdHdlZW4udW5pdCA9IHVuaXQ7CgkJCQl0d2Vlbi5zdGFydCA9IHN0YXJ0OwoJCQkJLy8gSWYgYSArPS8tPSB0b2tlbiB3YXMgcHJvdmlkZWQsIHdlJ3JlIGRvaW5nIGEgcmVsYXRpdmUgYW5pbWF0aW9uCgkJCQl0d2Vlbi5lbmQgPSBwYXJ0c1sxXSA/IHN0YXJ0ICsgKCBwYXJ0c1sxXSArIDEgKSAqIGVuZCA6IGVuZDsKCQkJfQoJCQlyZXR1cm4gdHdlZW47CgkJfV0KCX07CgovLyBBbmltYXRpb25zIGNyZWF0ZWQgc3luY2hyb25vdXNseSB3aWxsIHJ1biBzeW5jaHJvbm91c2x5CmZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgewoJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQlmeE5vdyA9IHVuZGVmaW5lZDsKCX0sIDAgKTsKCXJldHVybiAoIGZ4Tm93ID0galF1ZXJ5Lm5vdygpICk7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVR3ZWVucyggYW5pbWF0aW9uLCBwcm9wcyApIHsKCWpRdWVyeS5lYWNoKCBwcm9wcywgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciBjb2xsZWN0aW9uID0gKCB0d2VlbmVyc1sgcHJvcCBdIHx8IFtdICkuY29uY2F0KCB0d2VlbmVyc1sgIioiIF0gKSwKCQkJaW5kZXggPSAwLAoJCQlsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCQlpZiAoIGNvbGxlY3Rpb25bIGluZGV4IF0uY2FsbCggYW5pbWF0aW9uLCBwcm9wLCB2YWx1ZSApICkgewoKCQkJCS8vIHdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb3BlcnR5CgkJCQlyZXR1cm47CgkJCX0KCQl9Cgl9KTsKfQoKZnVuY3Rpb24gQW5pbWF0aW9uKCBlbGVtLCBwcm9wZXJ0aWVzLCBvcHRpb25zICkgewoJdmFyIHJlc3VsdCwKCQlpbmRleCA9IDAsCgkJdHdlZW5lckluZGV4ID0gMCwKCQlsZW5ndGggPSBhbmltYXRpb25QcmVmaWx0ZXJzLmxlbmd0aCwKCQlkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLmFsd2F5cyggZnVuY3Rpb24oKSB7CgkJCS8vIGRvbid0IG1hdGNoIGVsZW0gaW4gdGhlIDphbmltYXRlZCBzZWxlY3RvcgoJCQlkZWxldGUgdGljay5lbGVtOwoJCX0pLAoJCXRpY2sgPSBmdW5jdGlvbigpIHsKCQkJdmFyIGN1cnJlbnRUaW1lID0gZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKCQkJCXJlbWFpbmluZyA9IE1hdGgubWF4KCAwLCBhbmltYXRpb24uc3RhcnRUaW1lICsgYW5pbWF0aW9uLmR1cmF0aW9uIC0gY3VycmVudFRpbWUgKSwKCQkJCXBlcmNlbnQgPSAxIC0gKCByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCApLAoJCQkJaW5kZXggPSAwLAoJCQkJbGVuZ3RoID0gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGg7CgoJCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQkJCWFuaW1hdGlvbi50d2VlbnNbIGluZGV4IF0ucnVuKCBwZXJjZW50ICk7CgkJCX0KCgkJCWRlZmVycmVkLm5vdGlmeVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBwZXJjZW50LCByZW1haW5pbmcgXSk7CgoJCQlpZiAoIHBlcmNlbnQgPCAxICYmIGxlbmd0aCApIHsKCQkJCXJldHVybiByZW1haW5pbmc7CgkJCX0gZWxzZSB7CgkJCQlkZWZlcnJlZC5yZXNvbHZlV2l0aCggZWxlbSwgWyBhbmltYXRpb24gXSApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCQlhbmltYXRpb24gPSBkZWZlcnJlZC5wcm9taXNlKHsKCQkJZWxlbTogZWxlbSwKCQkJcHJvcHM6IGpRdWVyeS5leHRlbmQoIHt9LCBwcm9wZXJ0aWVzICksCgkJCW9wdHM6IGpRdWVyeS5leHRlbmQoIHRydWUsIHsgc3BlY2lhbEVhc2luZzoge30gfSwgb3B0aW9ucyApLAoJCQlvcmlnaW5hbFByb3BlcnRpZXM6IHByb3BlcnRpZXMsCgkJCW9yaWdpbmFsT3B0aW9uczogb3B0aW9ucywKCQkJc3RhcnRUaW1lOiBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAoJCQlkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbiwKCQkJdHdlZW5zOiBbXSwKCQkJY3JlYXRlVHdlZW46IGZ1bmN0aW9uKCBwcm9wLCBlbmQsIGVhc2luZyApIHsKCQkJCXZhciB0d2VlbiA9IGpRdWVyeS5Ud2VlbiggZWxlbSwgYW5pbWF0aW9uLm9wdHMsIHByb3AsIGVuZCwKCQkJCQkJYW5pbWF0aW9uLm9wdHMuc3BlY2lhbEVhc2luZ1sgcHJvcCBdIHx8IGFuaW1hdGlvbi5vcHRzLmVhc2luZyApOwoJCQkJYW5pbWF0aW9uLnR3ZWVucy5wdXNoKCB0d2VlbiApOwoJCQkJcmV0dXJuIHR3ZWVuOwoJCQl9LAoJCQlzdG9wOiBmdW5jdGlvbiggZ290b0VuZCApIHsKCQkJCXZhciBpbmRleCA9IDAsCgkJCQkJLy8gaWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBlbmQsIHdlIHdhbnQgdG8gcnVuIGFsbCB0aGUgdHdlZW5zCgkJCQkJLy8gb3RoZXJ3aXNlIHdlIHNraXAgdGhpcyBwYXJ0CgkJCQkJbGVuZ3RoID0gZ290b0VuZCA/IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoIDogMDsKCgkJCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggMSApOwoJCQkJfQoKCQkJCS8vIHJlc29sdmUgd2hlbiB3ZSBwbGF5ZWQgdGhlIGxhc3QgZnJhbWUKCQkJCS8vIG90aGVyd2lzZSwgcmVqZWN0CgkJCQlpZiAoIGdvdG9FbmQgKSB7CgkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIGdvdG9FbmQgXSApOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCQl9KSwKCQlwcm9wcyA9IGFuaW1hdGlvbi5wcm9wczsKCglwcm9wRmlsdGVyKCBwcm9wcywgYW5pbWF0aW9uLm9wdHMuc3BlY2lhbEVhc2luZyApOwoKCWZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCXJlc3VsdCA9IGFuaW1hdGlvblByZWZpbHRlcnNbIGluZGV4IF0uY2FsbCggYW5pbWF0aW9uLCBlbGVtLCBwcm9wcywgYW5pbWF0aW9uLm9wdHMgKTsKCQlpZiAoIHJlc3VsdCApIHsKCQkJcmV0dXJuIHJlc3VsdDsKCQl9Cgl9CgoJY3JlYXRlVHdlZW5zKCBhbmltYXRpb24sIHByb3BzICk7CgoJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggYW5pbWF0aW9uLm9wdHMuc3RhcnQgKSApIHsKCQlhbmltYXRpb24ub3B0cy5zdGFydC5jYWxsKCBlbGVtLCBhbmltYXRpb24gKTsKCX0KCglqUXVlcnkuZngudGltZXIoCgkJalF1ZXJ5LmV4dGVuZCggdGljaywgewoJCQlhbmltOiBhbmltYXRpb24sCgkJCXF1ZXVlOiBhbmltYXRpb24ub3B0cy5xdWV1ZSwKCQkJZWxlbTogZWxlbQoJCX0pCgkpOwoKCS8vIGF0dGFjaCBjYWxsYmFja3MgZnJvbSBvcHRpb25zCglyZXR1cm4gYW5pbWF0aW9uLnByb2dyZXNzKCBhbmltYXRpb24ub3B0cy5wcm9ncmVzcyApCgkJLmRvbmUoIGFuaW1hdGlvbi5vcHRzLmRvbmUsIGFuaW1hdGlvbi5vcHRzLmNvbXBsZXRlICkKCQkuZmFpbCggYW5pbWF0aW9uLm9wdHMuZmFpbCApCgkJLmFsd2F5cyggYW5pbWF0aW9uLm9wdHMuYWx3YXlzICk7Cn0KCmZ1bmN0aW9uIHByb3BGaWx0ZXIoIHByb3BzLCBzcGVjaWFsRWFzaW5nICkgewoJdmFyIGluZGV4LCBuYW1lLCBlYXNpbmcsIHZhbHVlLCBob29rczsKCgkvLyBjYW1lbENhc2UsIHNwZWNpYWxFYXNpbmcgYW5kIGV4cGFuZCBjc3NIb29rIHBhc3MKCWZvciAoIGluZGV4IGluIHByb3BzICkgewoJCW5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBpbmRleCApOwoJCWVhc2luZyA9IHNwZWNpYWxFYXNpbmdbIG5hbWUgXTsKCQl2YWx1ZSA9IHByb3BzWyBpbmRleCBdOwoJCWlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbHVlICkgKSB7CgkJCWVhc2luZyA9IHZhbHVlWyAxIF07CgkJCXZhbHVlID0gcHJvcHNbIGluZGV4IF0gPSB2YWx1ZVsgMCBdOwoJCX0KCgkJaWYgKCBpbmRleCAhPT0gbmFtZSApIHsKCQkJcHJvcHNbIG5hbWUgXSA9IHZhbHVlOwoJCQlkZWxldGUgcHJvcHNbIGluZGV4IF07CgkJfQoKCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdOwoJCWlmICggaG9va3MgJiYgImV4cGFuZCIgaW4gaG9va3MgKSB7CgkJCXZhbHVlID0gaG9va3MuZXhwYW5kKCB2YWx1ZSApOwoJCQlkZWxldGUgcHJvcHNbIG5hbWUgXTsKCgkJCS8vIG5vdCBxdWl0ZSAkLmV4dGVuZCwgdGhpcyB3b250IG92ZXJ3cml0ZSBrZXlzIGFscmVhZHkgcHJlc2VudC4KCQkJLy8gYWxzbyAtIHJldXNpbmcgJ2luZGV4JyBmcm9tIGFib3ZlIGJlY2F1c2Ugd2UgaGF2ZSB0aGUgY29ycmVjdCAibmFtZSIKCQkJZm9yICggaW5kZXggaW4gdmFsdWUgKSB7CgkJCQlpZiAoICEoIGluZGV4IGluIHByb3BzICkgKSB7CgkJCQkJcHJvcHNbIGluZGV4IF0gPSB2YWx1ZVsgaW5kZXggXTsKCQkJCQlzcGVjaWFsRWFzaW5nWyBpbmRleCBdID0gZWFzaW5nOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJc3BlY2lhbEVhc2luZ1sgbmFtZSBdID0gZWFzaW5nOwoJCX0KCX0KfQoKalF1ZXJ5LkFuaW1hdGlvbiA9IGpRdWVyeS5leHRlbmQoIEFuaW1hdGlvbiwgewoKCXR3ZWVuZXI6IGZ1bmN0aW9uKCBwcm9wcywgY2FsbGJhY2sgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcHJvcHMgKSApIHsKCQkJY2FsbGJhY2sgPSBwcm9wczsKCQkJcHJvcHMgPSBbICIqIiBdOwoJCX0gZWxzZSB7CgkJCXByb3BzID0gcHJvcHMuc3BsaXQoIiAiKTsKCQl9CgoJCXZhciBwcm9wLAoJCQlpbmRleCA9IDAsCgkJCWxlbmd0aCA9IHByb3BzLmxlbmd0aDsKCgkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCXByb3AgPSBwcm9wc1sgaW5kZXggXTsKCQkJdHdlZW5lcnNbIHByb3AgXSA9IHR3ZWVuZXJzWyBwcm9wIF0gfHwgW107CgkJCXR3ZWVuZXJzWyBwcm9wIF0udW5zaGlmdCggY2FsbGJhY2sgKTsKCQl9Cgl9LAoKCXByZWZpbHRlcjogZnVuY3Rpb24oIGNhbGxiYWNrLCBwcmVwZW5kICkgewoJCWlmICggcHJlcGVuZCApIHsKCQkJYW5pbWF0aW9uUHJlZmlsdGVycy51bnNoaWZ0KCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWFuaW1hdGlvblByZWZpbHRlcnMucHVzaCggY2FsbGJhY2sgKTsKCQl9Cgl9Cn0pOwoKZnVuY3Rpb24gZGVmYXVsdFByZWZpbHRlciggZWxlbSwgcHJvcHMsIG9wdHMgKSB7Cgl2YXIgaW5kZXgsIHByb3AsIHZhbHVlLCBsZW5ndGgsIGRhdGFTaG93LCB0d2VlbiwgaG9va3MsIG9sZGZpcmUsCgkJYW5pbSA9IHRoaXMsCgkJc3R5bGUgPSBlbGVtLnN0eWxlLAoJCW9yaWcgPSB7fSwKCQloYW5kbGVkID0gW10sCgkJaGlkZGVuID0gZWxlbS5ub2RlVHlwZSAmJiBpc0hpZGRlbiggZWxlbSApOwoKCS8vIGhhbmRsZSBxdWV1ZTogZmFsc2UgcHJvbWlzZXMKCWlmICggIW9wdHMucXVldWUgKSB7CgkJaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sICJmeCIgKTsKCQlpZiAoIGhvb2tzLnVucXVldWVkID09IG51bGwgKSB7CgkJCWhvb2tzLnVucXVldWVkID0gMDsKCQkJb2xkZmlyZSA9IGhvb2tzLmVtcHR5LmZpcmU7CgkJCWhvb2tzLmVtcHR5LmZpcmUgPSBmdW5jdGlvbigpIHsKCQkJCWlmICggIWhvb2tzLnVucXVldWVkICkgewoJCQkJCW9sZGZpcmUoKTsKCQkJCX0KCQkJfTsKCQl9CgkJaG9va3MudW5xdWV1ZWQrKzsKCgkJYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCS8vIGRvaW5nIHRoaXMgbWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wbGV0ZSBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkCgkJCS8vIGJlZm9yZSB0aGlzIGNvbXBsZXRlcwoJCQlhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJCWhvb2tzLnVucXVldWVkLS07CgkJCQlpZiAoICFqUXVlcnkucXVldWUoIGVsZW0sICJmeCIgKS5sZW5ndGggKSB7CgkJCQkJaG9va3MuZW1wdHkuZmlyZSgpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCX0KCgkvLyBoZWlnaHQvd2lkdGggb3ZlcmZsb3cgcGFzcwoJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmICggImhlaWdodCIgaW4gcHJvcHMgfHwgIndpZHRoIiBpbiBwcm9wcyApICkgewoJCS8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAoJCS8vIFJlY29yZCBhbGwgMyBvdmVyZmxvdyBhdHRyaWJ1dGVzIGJlY2F1c2UgSUUgZG9lcyBub3QKCQkvLyBjaGFuZ2UgdGhlIG92ZXJmbG93IGF0dHJpYnV0ZSB3aGVuIG92ZXJmbG93WCBhbmQKCQkvLyBvdmVyZmxvd1kgYXJlIHNldCB0byB0aGUgc2FtZSB2YWx1ZQoJCW9wdHMub3ZlcmZsb3cgPSBbIHN0eWxlLm92ZXJmbG93LCBzdHlsZS5vdmVyZmxvd1gsIHN0eWxlLm92ZXJmbG93WSBdOwoKCQkvLyBTZXQgZGlzcGxheSBwcm9wZXJ0eSB0byBpbmxpbmUtYmxvY2sgZm9yIGhlaWdodC93aWR0aAoJCS8vIGFuaW1hdGlvbnMgb24gaW5saW5lIGVsZW1lbnRzIHRoYXQgYXJlIGhhdmluZyB3aWR0aC9oZWlnaHQgYW5pbWF0ZWQKCQlpZiAoIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAiaW5saW5lIiAmJgoJCQkJalF1ZXJ5LmNzcyggZWxlbSwgImZsb2F0IiApID09PSAibm9uZSIgKSB7CgoJCQkvLyBpbmxpbmUtbGV2ZWwgZWxlbWVudHMgYWNjZXB0IGlubGluZS1ibG9jazsKCQkJLy8gYmxvY2stbGV2ZWwgZWxlbWVudHMgbmVlZCB0byBiZSBpbmxpbmUgd2l0aCBsYXlvdXQKCQkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCB8fCBjc3NfZGVmYXVsdERpc3BsYXkoIGVsZW0ubm9kZU5hbWUgKSA9PT0gImlubGluZSIgKSB7CgkJCQlzdHlsZS5kaXNwbGF5ID0gImlubGluZS1ibG9jayI7CgoJCQl9IGVsc2UgewoJCQkJc3R5bGUuem9vbSA9IDE7CgkJCX0KCQl9Cgl9CgoJaWYgKCBvcHRzLm92ZXJmbG93ICkgewoJCXN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CgkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuc2hyaW5rV3JhcEJsb2NrcyApIHsKCQkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgewoJCQkJc3R5bGUub3ZlcmZsb3cgPSBvcHRzLm92ZXJmbG93WyAwIF07CgkJCQlzdHlsZS5vdmVyZmxvd1ggPSBvcHRzLm92ZXJmbG93WyAxIF07CgkJCQlzdHlsZS5vdmVyZmxvd1kgPSBvcHRzLm92ZXJmbG93WyAyIF07CgkJCX0pOwoJCX0KCX0KCgoJLy8gc2hvdy9oaWRlIHBhc3MKCWZvciAoIGluZGV4IGluIHByb3BzICkgewoJCXZhbHVlID0gcHJvcHNbIGluZGV4IF07CgkJaWYgKCByZnh0eXBlcy5leGVjKCB2YWx1ZSApICkgewoJCQlkZWxldGUgcHJvcHNbIGluZGV4IF07CgkJCWlmICggdmFsdWUgPT09ICggaGlkZGVuID8gImhpZGUiIDogInNob3ciICkgKSB7CgkJCQljb250aW51ZTsKCQkJfQoJCQloYW5kbGVkLnB1c2goIGluZGV4ICk7CgkJfQoJfQoKCWxlbmd0aCA9IGhhbmRsZWQubGVuZ3RoOwoJaWYgKCBsZW5ndGggKSB7CgkJZGF0YVNob3cgPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJmeHNob3ciICkgfHwgalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiZnhzaG93Iiwge30gKTsKCQlpZiAoIGhpZGRlbiApIHsKCQkJalF1ZXJ5KCBlbGVtICkuc2hvdygpOwoJCX0gZWxzZSB7CgkJCWFuaW0uZG9uZShmdW5jdGlvbigpIHsKCQkJCWpRdWVyeSggZWxlbSApLmhpZGUoKTsKCQkJfSk7CgkJfQoJCWFuaW0uZG9uZShmdW5jdGlvbigpIHsKCQkJdmFyIHByb3A7CgkJCWpRdWVyeS5yZW1vdmVEYXRhKCBlbGVtLCAiZnhzaG93IiwgdHJ1ZSApOwoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AsIG9yaWdbIHByb3AgXSApOwoJCQl9CgkJfSk7CgkJZm9yICggaW5kZXggPSAwIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCQlwcm9wID0gaGFuZGxlZFsgaW5kZXggXTsKCQkJdHdlZW4gPSBhbmltLmNyZWF0ZVR3ZWVuKCBwcm9wLCBoaWRkZW4gPyBkYXRhU2hvd1sgcHJvcCBdIDogMCApOwoJCQlvcmlnWyBwcm9wIF0gPSBkYXRhU2hvd1sgcHJvcCBdIHx8IGpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCApOwoKCQkJaWYgKCAhKCBwcm9wIGluIGRhdGFTaG93ICkgKSB7CgkJCQlkYXRhU2hvd1sgcHJvcCBdID0gdHdlZW4uc3RhcnQ7CgkJCQlpZiAoIGhpZGRlbiApIHsKCQkJCQl0d2Vlbi5lbmQgPSB0d2Vlbi5zdGFydDsKCQkJCQl0d2Vlbi5zdGFydCA9IHByb3AgPT09ICJ3aWR0aCIgfHwgcHJvcCA9PT0gImhlaWdodCIgPyAxIDogMDsKCQkJCX0KCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gVHdlZW4oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nICkgewoJcmV0dXJuIG5ldyBUd2Vlbi5wcm90b3R5cGUuaW5pdCggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKTsKfQpqUXVlcnkuVHdlZW4gPSBUd2VlbjsKClR3ZWVuLnByb3RvdHlwZSA9IHsKCWNvbnN0cnVjdG9yOiBUd2VlbiwKCWluaXQ6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZywgdW5pdCApIHsKCQl0aGlzLmVsZW0gPSBlbGVtOwoJCXRoaXMucHJvcCA9IHByb3A7CgkJdGhpcy5lYXNpbmcgPSBlYXNpbmcgfHwgInN3aW5nIjsKCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwoJCXRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCk7CgkJdGhpcy5lbmQgPSBlbmQ7CgkJdGhpcy51bml0ID0gdW5pdCB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApOwoJfSwKCWN1cjogZnVuY3Rpb24oKSB7CgkJdmFyIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCgkJcmV0dXJuIGhvb2tzICYmIGhvb2tzLmdldCA/CgkJCWhvb2tzLmdldCggdGhpcyApIDoKCQkJVHdlZW4ucHJvcEhvb2tzLl9kZWZhdWx0LmdldCggdGhpcyApOwoJfSwKCXJ1bjogZnVuY3Rpb24oIHBlcmNlbnQgKSB7CgkJdmFyIGVhc2VkLAoJCQlob29rcyA9IFR3ZWVuLnByb3BIb29rc1sgdGhpcy5wcm9wIF07CgoJCXRoaXMucG9zID0gZWFzZWQgPSBqUXVlcnkuZWFzaW5nWyB0aGlzLmVhc2luZyBdKCBwZXJjZW50LCB0aGlzLm9wdGlvbnMuZHVyYXRpb24gKiBwZXJjZW50LCAwLCAxLCB0aGlzLm9wdGlvbnMuZHVyYXRpb24gKTsKCQl0aGlzLm5vdyA9ICggdGhpcy5lbmQgLSB0aGlzLnN0YXJ0ICkgKiBlYXNlZCArIHRoaXMuc3RhcnQ7CgoJCWlmICggdGhpcy5vcHRpb25zLnN0ZXAgKSB7CgkJCXRoaXMub3B0aW9ucy5zdGVwLmNhbGwoIHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMgKTsKCQl9CgoJCWlmICggaG9va3MgJiYgaG9va3Muc2V0ICkgewoJCQlob29rcy5zZXQoIHRoaXMgKTsKCQl9IGVsc2UgewoJCQlUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuc2V0KCB0aGlzICk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQp9OwoKVHdlZW4ucHJvdG90eXBlLmluaXQucHJvdG90eXBlID0gVHdlZW4ucHJvdG90eXBlOwoKVHdlZW4ucHJvcEhvb2tzID0gewoJX2RlZmF1bHQ6IHsKCQlnZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKCQkJdmFyIHJlc3VsdDsKCgkJCWlmICggdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdICE9IG51bGwgJiYKCQkJCSghdHdlZW4uZWxlbS5zdHlsZSB8fCB0d2Vlbi5lbGVtLnN0eWxlWyB0d2Vlbi5wcm9wIF0gPT0gbnVsbCkgKSB7CgkJCQlyZXR1cm4gdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdOwoJCQl9CgoJCQkvLyBwYXNzaW5nIGFueSB2YWx1ZSBhcyBhIDR0aCBwYXJhbWV0ZXIgdG8gLmNzcyB3aWxsIGF1dG9tYXRpY2FsbHkKCQkJLy8gYXR0ZW1wdCBhIHBhcnNlRmxvYXQgYW5kIGZhbGxiYWNrIHRvIGEgc3RyaW5nIGlmIHRoZSBwYXJzZSBmYWlscwoJCQkvLyBzbywgc2ltcGxlIHZhbHVlcyBzdWNoIGFzICIxMHB4IiBhcmUgcGFyc2VkIHRvIEZsb2F0LgoJCQkvLyBjb21wbGV4IHZhbHVlcyBzdWNoIGFzICJyb3RhdGUoMXJhZCkiIGFyZSByZXR1cm5lZCBhcyBpcy4KCQkJcmVzdWx0ID0galF1ZXJ5LmNzcyggdHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgZmFsc2UsICIiICk7CgkJCS8vIEVtcHR5IHN0cmluZ3MsIG51bGwsIHVuZGVmaW5lZCBhbmQgImF1dG8iIGFyZSBjb252ZXJ0ZWQgdG8gMC4KCQkJcmV0dXJuICFyZXN1bHQgfHwgcmVzdWx0ID09PSAiYXV0byIgPyAwIDogcmVzdWx0OwoJCX0sCgkJc2V0OiBmdW5jdGlvbiggdHdlZW4gKSB7CgkJCS8vIHVzZSBzdGVwIGhvb2sgZm9yIGJhY2sgY29tcGF0IC0gdXNlIGNzc0hvb2sgaWYgaXRzIHRoZXJlIC0gdXNlIC5zdHlsZSBpZiBpdHMKCQkJLy8gYXZhaWxhYmxlIGFuZCB1c2UgcGxhaW4gcHJvcGVydGllcyB3aGVyZSBhdmFpbGFibGUKCQkJaWYgKCBqUXVlcnkuZnguc3RlcFsgdHdlZW4ucHJvcCBdICkgewoJCQkJalF1ZXJ5LmZ4LnN0ZXBbIHR3ZWVuLnByb3AgXSggdHdlZW4gKTsKCQkJfSBlbHNlIGlmICggdHdlZW4uZWxlbS5zdHlsZSAmJiAoIHR3ZWVuLmVsZW0uc3R5bGVbIGpRdWVyeS5jc3NQcm9wc1sgdHdlZW4ucHJvcCBdIF0gIT0gbnVsbCB8fCBqUXVlcnkuY3NzSG9va3NbIHR3ZWVuLnByb3AgXSApICkgewoJCQkJalF1ZXJ5LnN0eWxlKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCB0d2Vlbi5ub3cgKyB0d2Vlbi51bml0ICk7CgkJCX0gZWxzZSB7CgkJCQl0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gPSB0d2Vlbi5ub3c7CgkJCX0KCQl9Cgl9Cn07CgovLyBSZW1vdmUgaW4gMi4wIC0gdGhpcyBzdXBwb3J0cyBJRTgncyBwYW5pYyBiYXNlZCBhcHByb2FjaAovLyB0byBzZXR0aW5nIHRoaW5ncyBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKClR3ZWVuLnByb3BIb29rcy5zY3JvbGxUb3AgPSBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9IHsKCXNldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCWlmICggdHdlZW4uZWxlbS5ub2RlVHlwZSAmJiB0d2Vlbi5lbGVtLnBhcmVudE5vZGUgKSB7CgkJCXR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsKCQl9Cgl9Cn07CgpqUXVlcnkuZWFjaChbICJ0b2dnbGUiLCAic2hvdyIsICJoaWRlIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCXZhciBjc3NGbiA9IGpRdWVyeS5mblsgbmFtZSBdOwoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHNwZWVkID09IG51bGwgfHwgdHlwZW9mIHNwZWVkID09PSAiYm9vbGVhbiIgfHwKCQkJLy8gc3BlY2lhbCBjaGVjayBmb3IgLnRvZ2dsZSggaGFuZGxlciwgaGFuZGxlciwgLi4uICkKCQkJKCAhaSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggc3BlZWQgKSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggZWFzaW5nICkgKSA/CgkJCWNzc0ZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSA6CgkJCXRoaXMuYW5pbWF0ZSggZ2VuRngoIG5hbWUsIHRydWUgKSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX07Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglmYWRlVG86IGZ1bmN0aW9uKCBzcGVlZCwgdG8sIGVhc2luZywgY2FsbGJhY2sgKSB7CgoJCS8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAoJCXJldHVybiB0aGlzLmZpbHRlciggaXNIaWRkZW4gKS5jc3MoICJvcGFjaXR5IiwgMCApLnNob3coKQoKCQkJLy8gYW5pbWF0ZSB0byB0aGUgdmFsdWUgc3BlY2lmaWVkCgkJCS5lbmQoKS5hbmltYXRlKHsgb3BhY2l0eTogdG8gfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX0sCglhbmltYXRlOiBmdW5jdGlvbiggcHJvcCwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJdmFyIGVtcHR5ID0galF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3AgKSwKCQkJb3B0YWxsID0galF1ZXJ5LnNwZWVkKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApLAoJCQlkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gT3BlcmF0ZSBvbiBhIGNvcHkgb2YgcHJvcCBzbyBwZXItcHJvcGVydHkgZWFzaW5nIHdvbid0IGJlIGxvc3QKCQkJCXZhciBhbmltID0gQW5pbWF0aW9uKCB0aGlzLCBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcCApLCBvcHRhbGwgKTsKCgkJCQkvLyBFbXB0eSBhbmltYXRpb25zIHJlc29sdmUgaW1tZWRpYXRlbHkKCQkJCWlmICggZW1wdHkgKSB7CgkJCQkJYW5pbS5zdG9wKCB0cnVlICk7CgkJCQl9CgkJCX07CgoJCXJldHVybiBlbXB0eSB8fCBvcHRhbGwucXVldWUgPT09IGZhbHNlID8KCQkJdGhpcy5lYWNoKCBkb0FuaW1hdGlvbiApIDoKCQkJdGhpcy5xdWV1ZSggb3B0YWxsLnF1ZXVlLCBkb0FuaW1hdGlvbiApOwoJfSwKCXN0b3A6IGZ1bmN0aW9uKCB0eXBlLCBjbGVhclF1ZXVlLCBnb3RvRW5kICkgewoJCXZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiggaG9va3MgKSB7CgkJCXZhciBzdG9wID0gaG9va3Muc3RvcDsKCQkJZGVsZXRlIGhvb2tzLnN0b3A7CgkJCXN0b3AoIGdvdG9FbmQgKTsKCQl9OwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZ290b0VuZCA9IGNsZWFyUXVldWU7CgkJCWNsZWFyUXVldWUgPSB0eXBlOwoJCQl0eXBlID0gdW5kZWZpbmVkOwoJCX0KCQlpZiAoIGNsZWFyUXVldWUgJiYgdHlwZSAhPT0gZmFsc2UgKSB7CgkJCXRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBkZXF1ZXVlID0gdHJ1ZSwKCQkJCWluZGV4ID0gdHlwZSAhPSBudWxsICYmIHR5cGUgKyAicXVldWVIb29rcyIsCgkJCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCQkJZGF0YSA9IGpRdWVyeS5fZGF0YSggdGhpcyApOwoKCQkJaWYgKCBpbmRleCApIHsKCQkJCWlmICggZGF0YVsgaW5kZXggXSAmJiBkYXRhWyBpbmRleCBdLnN0b3AgKSB7CgkJCQkJc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlmb3IgKCBpbmRleCBpbiBkYXRhICkgewoJCQkJCWlmICggZGF0YVsgaW5kZXggXSAmJiBkYXRhWyBpbmRleCBdLnN0b3AgJiYgcnJ1bi50ZXN0KCBpbmRleCApICkgewoJCQkJCQlzdG9wUXVldWUoIGRhdGFbIGluZGV4IF0gKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCWZvciAoIGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTsgKSB7CgkJCQlpZiAoIHRpbWVyc1sgaW5kZXggXS5lbGVtID09PSB0aGlzICYmICh0eXBlID09IG51bGwgfHwgdGltZXJzWyBpbmRleCBdLnF1ZXVlID09PSB0eXBlKSApIHsKCQkJCQl0aW1lcnNbIGluZGV4IF0uYW5pbS5zdG9wKCBnb3RvRW5kICk7CgkJCQkJZGVxdWV1ZSA9IGZhbHNlOwoJCQkJCXRpbWVycy5zcGxpY2UoIGluZGV4LCAxICk7CgkJCQl9CgkJCX0KCgkJCS8vIHN0YXJ0IHRoZSBuZXh0IGluIHRoZSBxdWV1ZSBpZiB0aGUgbGFzdCBzdGVwIHdhc24ndCBmb3JjZWQKCQkJLy8gdGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaCB3aWxsIGRlcXVldWUKCQkJLy8gYnV0IG9ubHkgaWYgdGhleSB3ZXJlIGdvdG9FbmQKCQkJaWYgKCBkZXF1ZXVlIHx8ICFnb3RvRW5kICkgewoJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQkJfQoJCX0pOwoJfQp9KTsKCi8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCmZ1bmN0aW9uIGdlbkZ4KCB0eXBlLCBpbmNsdWRlV2lkdGggKSB7Cgl2YXIgd2hpY2gsCgkJYXR0cnMgPSB7IGhlaWdodDogdHlwZSB9LAoJCWkgPSAwOwoKCS8vIGlmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywKCS8vIGlmIHdlIGRvbid0IGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKCWZvciggOyBpIDwgNCA7IGkgKz0gMiAtIGluY2x1ZGVXaWR0aCApIHsKCQl3aGljaCA9IGNzc0V4cGFuZFsgaSBdOwoJCWF0dHJzWyAibWFyZ2luIiArIHdoaWNoIF0gPSBhdHRyc1sgInBhZGRpbmciICsgd2hpY2ggXSA9IHR5cGU7Cgl9CgoJaWYgKCBpbmNsdWRlV2lkdGggKSB7CgkJYXR0cnMub3BhY2l0eSA9IGF0dHJzLndpZHRoID0gdHlwZTsKCX0KCglyZXR1cm4gYXR0cnM7Cn0KCi8vIEdlbmVyYXRlIHNob3J0Y3V0cyBmb3IgY3VzdG9tIGFuaW1hdGlvbnMKalF1ZXJ5LmVhY2goewoJc2xpZGVEb3duOiBnZW5GeCgic2hvdyIpLAoJc2xpZGVVcDogZ2VuRngoImhpZGUiKSwKCXNsaWRlVG9nZ2xlOiBnZW5GeCgidG9nZ2xlIiksCglmYWRlSW46IHsgb3BhY2l0eTogInNob3ciIH0sCglmYWRlT3V0OiB7IG9wYWNpdHk6ICJoaWRlIiB9LAoJZmFkZVRvZ2dsZTogeyBvcGFjaXR5OiAidG9nZ2xlIiB9Cn0sIGZ1bmN0aW9uKCBuYW1lLCBwcm9wcyApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewoJCXJldHVybiB0aGlzLmFuaW1hdGUoIHByb3BzLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwoJfTsKfSk7CgpqUXVlcnkuc3BlZWQgPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgZm4gKSB7Cgl2YXIgb3B0ID0gc3BlZWQgJiYgdHlwZW9mIHNwZWVkID09PSAib2JqZWN0IiA/IGpRdWVyeS5leHRlbmQoIHt9LCBzcGVlZCApIDogewoJCWNvbXBsZXRlOiBmbiB8fCAhZm4gJiYgZWFzaW5nIHx8CgkJCWpRdWVyeS5pc0Z1bmN0aW9uKCBzcGVlZCApICYmIHNwZWVkLAoJCWR1cmF0aW9uOiBzcGVlZCwKCQllYXNpbmc6IGZuICYmIGVhc2luZyB8fCBlYXNpbmcgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKCBlYXNpbmcgKSAmJiBlYXNpbmcKCX07CgoJb3B0LmR1cmF0aW9uID0galF1ZXJ5LmZ4Lm9mZiA/IDAgOiB0eXBlb2Ygb3B0LmR1cmF0aW9uID09PSAibnVtYmVyIiA/IG9wdC5kdXJhdGlvbiA6CgkJb3B0LmR1cmF0aW9uIGluIGpRdWVyeS5meC5zcGVlZHMgPyBqUXVlcnkuZnguc3BlZWRzWyBvcHQuZHVyYXRpb24gXSA6IGpRdWVyeS5meC5zcGVlZHMuX2RlZmF1bHQ7CgoJLy8gbm9ybWFsaXplIG9wdC5xdWV1ZSAtIHRydWUvdW5kZWZpbmVkL251bGwgLT4gImZ4IgoJaWYgKCBvcHQucXVldWUgPT0gbnVsbCB8fCBvcHQucXVldWUgPT09IHRydWUgKSB7CgkJb3B0LnF1ZXVlID0gImZ4IjsKCX0KCgkvLyBRdWV1ZWluZwoJb3B0Lm9sZCA9IG9wdC5jb21wbGV0ZTsKCglvcHQuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBvcHQub2xkICkgKSB7CgkJCW9wdC5vbGQuY2FsbCggdGhpcyApOwoJCX0KCgkJaWYgKCBvcHQucXVldWUgKSB7CgkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCBvcHQucXVldWUgKTsKCQl9Cgl9OwoKCXJldHVybiBvcHQ7Cn07CgpqUXVlcnkuZWFzaW5nID0gewoJbGluZWFyOiBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gcDsKCX0sCglzd2luZzogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIDAuNSAtIE1hdGguY29zKCBwKk1hdGguUEkgKSAvIDI7Cgl9Cn07CgpqUXVlcnkudGltZXJzID0gW107CmpRdWVyeS5meCA9IFR3ZWVuLnByb3RvdHlwZS5pbml0OwpqUXVlcnkuZngudGljayA9IGZ1bmN0aW9uKCkgewoJdmFyIHRpbWVyLAoJCXRpbWVycyA9IGpRdWVyeS50aW1lcnMsCgkJaSA9IDA7CgoJZm9yICggOyBpIDwgdGltZXJzLmxlbmd0aDsgaSsrICkgewoJCXRpbWVyID0gdGltZXJzWyBpIF07CgkJLy8gQ2hlY2tzIHRoZSB0aW1lciBoYXMgbm90IGFscmVhZHkgYmVlbiByZW1vdmVkCgkJaWYgKCAhdGltZXIoKSAmJiB0aW1lcnNbIGkgXSA9PT0gdGltZXIgKSB7CgkJCXRpbWVycy5zcGxpY2UoIGktLSwgMSApOwoJCX0KCX0KCglpZiAoICF0aW1lcnMubGVuZ3RoICkgewoJCWpRdWVyeS5meC5zdG9wKCk7Cgl9Cn07CgpqUXVlcnkuZngudGltZXIgPSBmdW5jdGlvbiggdGltZXIgKSB7CglpZiAoIHRpbWVyKCkgJiYgalF1ZXJ5LnRpbWVycy5wdXNoKCB0aW1lciApICYmICF0aW1lcklkICkgewoJCXRpbWVySWQgPSBzZXRJbnRlcnZhbCggalF1ZXJ5LmZ4LnRpY2ssIGpRdWVyeS5meC5pbnRlcnZhbCApOwoJfQp9OwoKalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7CgpqUXVlcnkuZnguc3RvcCA9IGZ1bmN0aW9uKCkgewoJY2xlYXJJbnRlcnZhbCggdGltZXJJZCApOwoJdGltZXJJZCA9IG51bGw7Cn07CgpqUXVlcnkuZnguc3BlZWRzID0gewoJc2xvdzogNjAwLAoJZmFzdDogMjAwLAoJLy8gRGVmYXVsdCBzcGVlZAoJX2RlZmF1bHQ6IDQwMAp9OwoKLy8gQmFjayBDb21wYXQgPDEuOCBleHRlbnNpb24gcG9pbnQKalF1ZXJ5LmZ4LnN0ZXAgPSB7fTsKCmlmICggalF1ZXJ5LmV4cHIgJiYgalF1ZXJ5LmV4cHIuZmlsdGVycyApIHsKCWpRdWVyeS5leHByLmZpbHRlcnMuYW5pbWF0ZWQgPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoalF1ZXJ5LnRpbWVycywgZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKCQl9KS5sZW5ndGg7Cgl9Owp9CnZhciBycm9vdCA9IC9eKD86Ym9keXxodG1sKSQvaTsKCmpRdWVyeS5mbi5vZmZzZXQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQlyZXR1cm4gb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8KCQkJdGhpcyA6CgkJCXRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeS5vZmZzZXQuc2V0T2Zmc2V0KCB0aGlzLCBvcHRpb25zLCBpICk7CgkJCX0pOwoJfQoKCXZhciBib3gsIGRvY0VsZW0sIGJvZHksIHdpbiwgY2xpZW50VG9wLCBjbGllbnRMZWZ0LCBzY3JvbGxUb3AsIHNjcm9sbExlZnQsIHRvcCwgbGVmdCwKCQllbGVtID0gdGhpc1sgMCBdLAoJCWRvYyA9IGVsZW0gJiYgZWxlbS5vd25lckRvY3VtZW50OwoKCWlmICggIWRvYyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAoYm9keSA9IGRvYy5ib2R5KSA9PT0gZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5Lm9mZnNldC5ib2R5T2Zmc2V0KCBlbGVtICk7Cgl9CgoJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQ7CgoJLy8gTWFrZSBzdXJlIHdlJ3JlIG5vdCBkZWFsaW5nIHdpdGggYSBkaXNjb25uZWN0ZWQgRE9NIG5vZGUKCWlmICggIWpRdWVyeS5jb250YWlucyggZG9jRWxlbSwgZWxlbSApICkgewoJCXJldHVybiB7IHRvcDogMCwgbGVmdDogMCB9OwoJfQoKCWJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7Cgl3aW4gPSBnZXRXaW5kb3coIGRvYyApOwoJY2xpZW50VG9wICA9IGRvY0VsZW0uY2xpZW50VG9wICB8fCBib2R5LmNsaWVudFRvcCAgfHwgMDsKCWNsaWVudExlZnQgPSBkb2NFbGVtLmNsaWVudExlZnQgfHwgYm9keS5jbGllbnRMZWZ0IHx8IDA7CglzY3JvbGxUb3AgID0gd2luLnBhZ2VZT2Zmc2V0IHx8IGRvY0VsZW0uc2Nyb2xsVG9wOwoJc2Nyb2xsTGVmdCA9IHdpbi5wYWdlWE9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbExlZnQ7Cgl0b3AgID0gYm94LnRvcCAgKyBzY3JvbGxUb3AgIC0gY2xpZW50VG9wOwoJbGVmdCA9IGJveC5sZWZ0ICsgc2Nyb2xsTGVmdCAtIGNsaWVudExlZnQ7CgoJcmV0dXJuIHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfTsKfTsKCmpRdWVyeS5vZmZzZXQgPSB7CgoJYm9keU9mZnNldDogZnVuY3Rpb24oIGJvZHkgKSB7CgkJdmFyIHRvcCA9IGJvZHkub2Zmc2V0VG9wLAoJCQlsZWZ0ID0gYm9keS5vZmZzZXRMZWZ0OwoKCQlpZiAoIGpRdWVyeS5zdXBwb3J0LmRvZXNOb3RJbmNsdWRlTWFyZ2luSW5Cb2R5T2Zmc2V0ICkgewoJCQl0b3AgICs9IHBhcnNlRmxvYXQoIGpRdWVyeS5jc3MoYm9keSwgIm1hcmdpblRvcCIpICkgfHwgMDsKCQkJbGVmdCArPSBwYXJzZUZsb2F0KCBqUXVlcnkuY3NzKGJvZHksICJtYXJnaW5MZWZ0IikgKSB8fCAwOwoJCX0KCgkJcmV0dXJuIHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfTsKCX0sCgoJc2V0T2Zmc2V0OiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgaSApIHsKCQl2YXIgcG9zaXRpb24gPSBqUXVlcnkuY3NzKCBlbGVtLCAicG9zaXRpb24iICk7CgoJCS8vIHNldCBwb3NpdGlvbiBmaXJzdCwgaW4tY2FzZSB0b3AvbGVmdCBhcmUgc2V0IGV2ZW4gb24gc3RhdGljIGVsZW0KCQlpZiAoIHBvc2l0aW9uID09PSAic3RhdGljIiApIHsKCQkJZWxlbS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CgkJfQoKCQl2YXIgY3VyRWxlbSA9IGpRdWVyeSggZWxlbSApLAoJCQljdXJPZmZzZXQgPSBjdXJFbGVtLm9mZnNldCgpLAoJCQljdXJDU1NUb3AgPSBqUXVlcnkuY3NzKCBlbGVtLCAidG9wIiApLAoJCQljdXJDU1NMZWZ0ID0galF1ZXJ5LmNzcyggZWxlbSwgImxlZnQiICksCgkJCWNhbGN1bGF0ZVBvc2l0aW9uID0gKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApICYmIGpRdWVyeS5pbkFycmF5KCJhdXRvIiwgW2N1ckNTU1RvcCwgY3VyQ1NTTGVmdF0pID4gLTEsCgkJCXByb3BzID0ge30sIGN1clBvc2l0aW9uID0ge30sIGN1clRvcCwgY3VyTGVmdDsKCgkJLy8gbmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIgdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCgkJaWYgKCBjYWxjdWxhdGVQb3NpdGlvbiApIHsKCQkJY3VyUG9zaXRpb24gPSBjdXJFbGVtLnBvc2l0aW9uKCk7CgkJCWN1clRvcCA9IGN1clBvc2l0aW9uLnRvcDsKCQkJY3VyTGVmdCA9IGN1clBvc2l0aW9uLmxlZnQ7CgkJfSBlbHNlIHsKCQkJY3VyVG9wID0gcGFyc2VGbG9hdCggY3VyQ1NTVG9wICkgfHwgMDsKCQkJY3VyTGVmdCA9IHBhcnNlRmxvYXQoIGN1ckNTU0xlZnQgKSB8fCAwOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggb3B0aW9ucyApICkgewoJCQlvcHRpb25zID0gb3B0aW9ucy5jYWxsKCBlbGVtLCBpLCBjdXJPZmZzZXQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy50b3AgIT0gbnVsbCApIHsKCQkJcHJvcHMudG9wID0gKCBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKSArIGN1clRvcDsKCQl9CgkJaWYgKCBvcHRpb25zLmxlZnQgIT0gbnVsbCApIHsKCQkJcHJvcHMubGVmdCA9ICggb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKSArIGN1ckxlZnQ7CgkJfQoKCQlpZiAoICJ1c2luZyIgaW4gb3B0aW9ucyApIHsKCQkJb3B0aW9ucy51c2luZy5jYWxsKCBlbGVtLCBwcm9wcyApOwoJCX0gZWxzZSB7CgkJCWN1ckVsZW0uY3NzKCBwcm9wcyApOwoJCX0KCX0KfTsKCgpqUXVlcnkuZm4uZXh0ZW5kKHsKCglwb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpc1swXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGVsZW0gPSB0aGlzWzBdLAoKCQkvLyBHZXQgKnJlYWwqIG9mZnNldFBhcmVudAoJCW9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50KCksCgoJCS8vIEdldCBjb3JyZWN0IG9mZnNldHMKCQlvZmZzZXQgICAgICAgPSB0aGlzLm9mZnNldCgpLAoJCXBhcmVudE9mZnNldCA9IHJyb290LnRlc3Qob2Zmc2V0UGFyZW50WzBdLm5vZGVOYW1lKSA/IHsgdG9wOiAwLCBsZWZ0OiAwIH0gOiBvZmZzZXRQYXJlbnQub2Zmc2V0KCk7CgoJCS8vIFN1YnRyYWN0IGVsZW1lbnQgbWFyZ2lucwoJCS8vIG5vdGU6IHdoZW4gYW4gZWxlbWVudCBoYXMgbWFyZ2luOiBhdXRvIHRoZSBvZmZzZXRMZWZ0IGFuZCBtYXJnaW5MZWZ0CgkJLy8gYXJlIHRoZSBzYW1lIGluIFNhZmFyaSBjYXVzaW5nIG9mZnNldC5sZWZ0IHRvIGluY29ycmVjdGx5IGJlIDAKCQlvZmZzZXQudG9wICAtPSBwYXJzZUZsb2F0KCBqUXVlcnkuY3NzKGVsZW0sICJtYXJnaW5Ub3AiKSApIHx8IDA7CgkJb2Zmc2V0LmxlZnQgLT0gcGFyc2VGbG9hdCggalF1ZXJ5LmNzcyhlbGVtLCAibWFyZ2luTGVmdCIpICkgfHwgMDsKCgkJLy8gQWRkIG9mZnNldFBhcmVudCBib3JkZXJzCgkJcGFyZW50T2Zmc2V0LnRvcCAgKz0gcGFyc2VGbG9hdCggalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnRbMF0sICJib3JkZXJUb3BXaWR0aCIpICkgfHwgMDsKCQlwYXJlbnRPZmZzZXQubGVmdCArPSBwYXJzZUZsb2F0KCBqUXVlcnkuY3NzKG9mZnNldFBhcmVudFswXSwgImJvcmRlckxlZnRXaWR0aCIpICkgfHwgMDsKCgkJLy8gU3VidHJhY3QgdGhlIHR3byBvZmZzZXRzCgkJcmV0dXJuIHsKCQkJdG9wOiAgb2Zmc2V0LnRvcCAgLSBwYXJlbnRPZmZzZXQudG9wLAoJCQlsZWZ0OiBvZmZzZXQubGVmdCAtIHBhcmVudE9mZnNldC5sZWZ0CgkJfTsKCX0sCgoJb2Zmc2V0UGFyZW50OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKSB7CgkJCXZhciBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCB8fCBkb2N1bWVudC5ib2R5OwoJCQl3aGlsZSAoIG9mZnNldFBhcmVudCAmJiAoIXJyb290LnRlc3Qob2Zmc2V0UGFyZW50Lm5vZGVOYW1lKSAmJiBqUXVlcnkuY3NzKG9mZnNldFBhcmVudCwgInBvc2l0aW9uIikgPT09ICJzdGF0aWMiKSApIHsKCQkJCW9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CgkJCX0KCQkJcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2N1bWVudC5ib2R5OwoJCX0pOwoJfQp9KTsKCgovLyBDcmVhdGUgc2Nyb2xsTGVmdCBhbmQgc2Nyb2xsVG9wIG1ldGhvZHMKalF1ZXJ5LmVhY2goIHtzY3JvbGxMZWZ0OiAicGFnZVhPZmZzZXQiLCBzY3JvbGxUb3A6ICJwYWdlWU9mZnNldCJ9LCBmdW5jdGlvbiggbWV0aG9kLCBwcm9wICkgewoJdmFyIHRvcCA9IC9ZLy50ZXN0KCBwcm9wICk7CgoJalF1ZXJ5LmZuWyBtZXRob2QgXSA9IGZ1bmN0aW9uKCB2YWwgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBtZXRob2QsIHZhbCApIHsKCQkJdmFyIHdpbiA9IGdldFdpbmRvdyggZWxlbSApOwoKCQkJaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiB3aW4gPyAocHJvcCBpbiB3aW4pID8gd2luWyBwcm9wIF0gOgoJCQkJCXdpbi5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbIG1ldGhvZCBdIDoKCQkJCQllbGVtWyBtZXRob2QgXTsKCQkJfQoKCQkJaWYgKCB3aW4gKSB7CgkJCQl3aW4uc2Nyb2xsVG8oCgkJCQkJIXRvcCA/IHZhbCA6IGpRdWVyeSggd2luICkuc2Nyb2xsTGVmdCgpLAoJCQkJCSB0b3AgPyB2YWwgOiBqUXVlcnkoIHdpbiApLnNjcm9sbFRvcCgpCgkJCQkpOwoKCQkJfSBlbHNlIHsKCQkJCWVsZW1bIG1ldGhvZCBdID0gdmFsOwoJCQl9CgkJfSwgbWV0aG9kLCB2YWwsIGFyZ3VtZW50cy5sZW5ndGgsIG51bGwgKTsKCX07Cn0pOwoKZnVuY3Rpb24gZ2V0V2luZG93KCBlbGVtICkgewoJcmV0dXJuIGpRdWVyeS5pc1dpbmRvdyggZWxlbSApID8KCQllbGVtIDoKCQllbGVtLm5vZGVUeXBlID09PSA5ID8KCQkJZWxlbS5kZWZhdWx0VmlldyB8fCBlbGVtLnBhcmVudFdpbmRvdyA6CgkJCWZhbHNlOwp9Ci8vIENyZWF0ZSBpbm5lckhlaWdodCwgaW5uZXJXaWR0aCwgaGVpZ2h0LCB3aWR0aCwgb3V0ZXJIZWlnaHQgYW5kIG91dGVyV2lkdGggbWV0aG9kcwpqUXVlcnkuZWFjaCggeyBIZWlnaHQ6ICJoZWlnaHQiLCBXaWR0aDogIndpZHRoIiB9LCBmdW5jdGlvbiggbmFtZSwgdHlwZSApIHsKCWpRdWVyeS5lYWNoKCB7IHBhZGRpbmc6ICJpbm5lciIgKyBuYW1lLCBjb250ZW50OiB0eXBlLCAiIjogIm91dGVyIiArIG5hbWUgfSwgZnVuY3Rpb24oIGRlZmF1bHRFeHRyYSwgZnVuY05hbWUgKSB7CgkJLy8gbWFyZ2luIGlzIG9ubHkgZm9yIG91dGVySGVpZ2h0LCBvdXRlcldpZHRoCgkJalF1ZXJ5LmZuWyBmdW5jTmFtZSBdID0gZnVuY3Rpb24oIG1hcmdpbiwgdmFsdWUgKSB7CgkJCXZhciBjaGFpbmFibGUgPSBhcmd1bWVudHMubGVuZ3RoICYmICggZGVmYXVsdEV4dHJhIHx8IHR5cGVvZiBtYXJnaW4gIT09ICJib29sZWFuIiApLAoJCQkJZXh0cmEgPSBkZWZhdWx0RXh0cmEgfHwgKCBtYXJnaW4gPT09IHRydWUgfHwgdmFsdWUgPT09IHRydWUgPyAibWFyZ2luIiA6ICJib3JkZXIiICk7CgoJCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIHR5cGUsIHZhbHVlICkgewoJCQkJdmFyIGRvYzsKCgkJCQlpZiAoIGpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoJCQkJCS8vIEFzIG9mIDUvOC8yMDEyIHRoaXMgd2lsbCB5aWVsZCBpbmNvcnJlY3QgcmVzdWx0cyBmb3IgTW9iaWxlIFNhZmFyaSwgYnV0IHRoZXJlCgkJCQkJLy8gaXNuJ3QgYSB3aG9sZSBsb3Qgd2UgY2FuIGRvLiBTZWUgcHVsbCByZXF1ZXN0IGF0IHRoaXMgVVJMIGZvciBkaXNjdXNzaW9uOgoJCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNzY0CgkJCQkJcmV0dXJuIGVsZW0uZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyAiY2xpZW50IiArIG5hbWUgXTsKCQkJCX0KCgkJCQkvLyBHZXQgZG9jdW1lbnQgd2lkdGggb3IgaGVpZ2h0CgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDkgKSB7CgkJCQkJZG9jID0gZWxlbS5kb2N1bWVudEVsZW1lbnQ7CgoJCQkJCS8vIEVpdGhlciBzY3JvbGxbV2lkdGgvSGVpZ2h0XSBvciBvZmZzZXRbV2lkdGgvSGVpZ2h0XSBvciBjbGllbnRbV2lkdGgvSGVpZ2h0XSwgd2hpY2hldmVyIGlzIGdyZWF0ZXN0CgkJCQkJLy8gdW5mb3J0dW5hdGVseSwgdGhpcyBjYXVzZXMgYnVnICMzODM4IGluIElFNi84IG9ubHksIGJ1dCB0aGVyZSBpcyBjdXJyZW50bHkgbm8gZ29vZCwgc21hbGwgd2F5IHRvIGZpeCBpdC4KCQkJCQlyZXR1cm4gTWF0aC5tYXgoCgkJCQkJCWVsZW0uYm9keVsgInNjcm9sbCIgKyBuYW1lIF0sIGRvY1sgInNjcm9sbCIgKyBuYW1lIF0sCgkJCQkJCWVsZW0uYm9keVsgIm9mZnNldCIgKyBuYW1lIF0sIGRvY1sgIm9mZnNldCIgKyBuYW1lIF0sCgkJCQkJCWRvY1sgImNsaWVudCIgKyBuYW1lIF0KCQkJCQkpOwoJCQkJfQoKCQkJCXJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8KCQkJCQkvLyBHZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50LCByZXF1ZXN0aW5nIGJ1dCBub3QgZm9yY2luZyBwYXJzZUZsb2F0CgkJCQkJalF1ZXJ5LmNzcyggZWxlbSwgdHlwZSwgdmFsdWUsIGV4dHJhICkgOgoKCQkJCQkvLyBTZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CgkJCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEgKTsKCQkJfSwgdHlwZSwgY2hhaW5hYmxlID8gbWFyZ2luIDogdW5kZWZpbmVkLCBjaGFpbmFibGUgKTsKCQl9OwoJfSk7Cn0pOwovLyBFeHBvc2UgalF1ZXJ5IHRvIHRoZSBnbG9iYWwgb2JqZWN0CndpbmRvdy5qUXVlcnkgPSB3aW5kb3cuJCA9IGpRdWVyeTsKCi8vIEV4cG9zZSBqUXVlcnkgYXMgYW4gQU1EIG1vZHVsZSwgYnV0IG9ubHkgZm9yIEFNRCBsb2FkZXJzIHRoYXQKLy8gdW5kZXJzdGFuZCB0aGUgaXNzdWVzIHdpdGggbG9hZGluZyBtdWx0aXBsZSB2ZXJzaW9ucyBvZiBqUXVlcnkKLy8gaW4gYSBwYWdlIHRoYXQgYWxsIG1pZ2h0IGNhbGwgZGVmaW5lKCkuIFRoZSBsb2FkZXIgd2lsbCBpbmRpY2F0ZQovLyB0aGV5IGhhdmUgc3BlY2lhbCBhbGxvd2FuY2VzIGZvciBtdWx0aXBsZSBqUXVlcnkgdmVyc2lvbnMgYnkKLy8gc3BlY2lmeWluZyBkZWZpbmUuYW1kLmpRdWVyeSA9IHRydWUuIFJlZ2lzdGVyIGFzIGEgbmFtZWQgbW9kdWxlLAovLyBzaW5jZSBqUXVlcnkgY2FuIGJlIGNvbmNhdGVuYXRlZCB3aXRoIG90aGVyIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsCi8vIGJ1dCBub3QgdXNlIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQgdW5kZXJzdGFuZHMgYW5vbnltb3VzCi8vIEFNRCBtb2R1bGVzLiBBIG5hbWVkIEFNRCBpcyBzYWZlc3QgYW5kIG1vc3Qgcm9idXN0IHdheSB0byByZWdpc3Rlci4KLy8gTG93ZXJjYXNlIGpxdWVyeSBpcyB1c2VkIGJlY2F1c2UgQU1EIG1vZHVsZSBuYW1lcyBhcmUgZGVyaXZlZCBmcm9tCi8vIGZpbGUgbmFtZXMsIGFuZCBqUXVlcnkgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGEgbG93ZXJjYXNlIGZpbGUgbmFtZS4KLy8gRG8gdGhpcyBhZnRlciBjcmVhdGluZyB0aGUgZ2xvYmFsIHNvIHRoYXQgaWYgYW4gQU1EIG1vZHVsZSB3YW50cyB0byBjYWxsCi8vIG5vQ29uZmxpY3QgdG8gaGlkZSB0aGlzIHZlcnNpb24gb2YgalF1ZXJ5LCBpdCB3aWxsIHdvcmsuCmlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICYmIGRlZmluZS5hbWQualF1ZXJ5ICkgewoJZGVmaW5lKCAianF1ZXJ5IiwgW10sIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGpRdWVyeTsgfSApOwp9Cgp9KSggd2luZG93ICk7CgovLwovLyBzaG93ZG93bi5qcyAtLSBBIGphdmFzY3JpcHQgcG9ydCBvZiBNYXJrZG93bi4KLy8KLy8gQ29weXJpZ2h0IChjKSAyMDA3IEpvaG4gRnJhc2VyLgovLwovLyBPcmlnaW5hbCBNYXJrZG93biBDb3B5cmlnaHQgKGMpIDIwMDQtMjAwNSBKb2huIEdydWJlcgovLyAgIDxodHRwOi8vZGFyaW5nZmlyZWJhbGwubmV0L3Byb2plY3RzL21hcmtkb3duLz4KLy8KLy8gUmVkaXN0cmlidXRhYmxlIHVuZGVyIGEgQlNELXN0eWxlIG9wZW4gc291cmNlIGxpY2Vuc2UuCi8vIFNlZSBsaWNlbnNlLnR4dCBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KLy8KLy8gVGhlIGZ1bGwgc291cmNlIGRpc3RyaWJ1dGlvbiBpcyBhdDoKLy8KLy8JCQkJQSBBIEwKLy8JCQkJVCBDIEEKLy8JCQkJVCBLIEIKLy8KLy8gICA8aHR0cDovL3d3dy5hdHRhY2tsYWIubmV0Lz4KLy8KLy8KLy8gV2hlcmV2ZXIgcG9zc2libGUsIFNob3dkb3duIGlzIGEgc3RyYWlnaHQsIGxpbmUtYnktbGluZSBwb3J0Ci8vIG9mIHRoZSBQZXJsIHZlcnNpb24gb2YgTWFya2Rvd24uCi8vCi8vIFRoaXMgaXMgbm90IGEgbm9ybWFsIHBhcnNlciBkZXNpZ247IGl0J3MgYmFzaWNhbGx5IGp1c3QgYQovLyBzZXJpZXMgb2Ygc3RyaW5nIHN1YnN0aXR1dGlvbnMuICBJdCdzIGhhcmQgdG8gcmVhZCBhbmQKLy8gbWFpbnRhaW4gdGhpcyB3YXksICBidXQga2VlcGluZyBTaG93ZG93biBjbG9zZSB0byB0aGUgb3JpZ2luYWwKLy8gZGVzaWduIG1ha2VzIGl0IGVhc2llciB0byBwb3J0IG5ldyBmZWF0dXJlcy4KLy8KLy8gTW9yZSBpbXBvcnRhbnRseSwgU2hvd2Rvd24gYmVoYXZlcyBsaWtlIG1hcmtkb3duLnBsIGluIG1vc3QKLy8gZWRnZSBjYXNlcy4gIFNvIHdlYiBhcHBsaWNhdGlvbnMgY2FuIGRvIGNsaWVudC1zaWRlIHByZXZpZXcKLy8gaW4gSmF2YXNjcmlwdCwgYW5kIHRoZW4gYnVpbGQgaWRlbnRpY2FsIEhUTUwgb24gdGhlIHNlcnZlci4KLy8KLy8gVGhpcyBwb3J0IG5lZWRzIHRoZSBuZXcgUmVnRXhwIGZ1bmN0aW9uYWxpdHkgb2YgRUNNQSAyNjIsCi8vIDNyZCBFZGl0aW9uIChpLmUuIEphdmFzY3JpcHQgMS41KS4gIE1vc3QgbW9kZXJuIHdlYiBicm93c2VycwovLyBzaG91bGQgZG8gZmluZS4gIEV2ZW4gd2l0aCB0aGUgbmV3IHJlZ3VsYXIgZXhwcmVzc2lvbiBmZWF0dXJlcywKLy8gV2UgZG8gYSBsb3Qgb2Ygd29yayB0byBlbXVsYXRlIFBlcmwncyByZWdleCBmdW5jdGlvbmFsaXR5LgovLyBUaGUgdHJpY2t5IGNoYW5nZXMgaW4gdGhpcyBmaWxlIG1vc3RseSBoYXZlIHRoZSAiYXR0YWNrbGFiOiIKLy8gbGFiZWwuICBNYWpvciBvciBzZWxmLWV4cGxhbmF0b3J5IGNoYW5nZXMgZG9uJ3QuCi8vCi8vIFNtYXJ0IGRpZmYgdG9vbHMgbGlrZSBBcmF4aXMgTWVyZ2Ugd2lsbCBiZSBhYmxlIHRvIG1hdGNoIHVwCi8vIHRoaXMgZmlsZSB3aXRoIG1hcmtkb3duLnBsIGluIGEgdXNlZnVsIHdheS4gIEEgbGl0dGxlIHR3ZWFraW5nCi8vIGhlbHBzOiBpbiBhIGNvcHkgb2YgbWFya2Rvd24ucGwsIHJlcGxhY2UgIiMiIHdpdGggIi8vIiBhbmQKLy8gcmVwbGFjZSAiJHRleHQiIHdpdGggInRleHQiLiAgQmUgc3VyZSB0byBpZ25vcmUgd2hpdGVzcGFjZQovLyBhbmQgbGluZSBlbmRpbmdzLgovLwovLwovLyBTaG93ZG93biB1c2FnZToKLy8KLy8gICB2YXIgdGV4dCA9ICJNYXJrZG93biAqcm9ja3MqLiI7Ci8vCi8vICAgdmFyIGNvbnZlcnRlciA9IG5ldyBTaG93ZG93bi5jb252ZXJ0ZXIoKTsKLy8gICB2YXIgaHRtbCA9IGNvbnZlcnRlci5tYWtlSHRtbCh0ZXh0KTsKLy8KLy8gICBhbGVydChodG1sKTsKLy8KLy8gTm90ZTogbW92ZSB0aGUgc2FtcGxlIGNvZGUgdG8gdGhlIGJvdHRvbSBvZiB0aGlzCi8vIGZpbGUgYmVmb3JlIHVuY29tbWVudGluZyBpdC4KLy8KLy8KLy8gU2hvd2Rvd24gbmFtZXNwYWNlCi8vCnZhciBTaG93ZG93bj17fTtTaG93ZG93bi5jb252ZXJ0ZXI9ZnVuY3Rpb24oKXt2YXIgYSxiLGMsZD0wO3RoaXMubWFrZUh0bWw9ZnVuY3Rpb24oZCl7cmV0dXJuIGE9bmV3IEFycmF5LGI9bmV3IEFycmF5LGM9bmV3IEFycmF5LGQ9ZC5yZXBsYWNlKC9+L2csIn5UIiksZD1kLnJlcGxhY2UoL1wkL2csIn5EIiksZD1kLnJlcGxhY2UoL1xyXG4vZywiXG4iKSxkPWQucmVwbGFjZSgvXHIvZywiXG4iKSxkPSJcblxuIitkKyJcblxuIixkPUYoZCksZD1kLnJlcGxhY2UoL15bIFx0XSskL21nLCIiKSxkPWYoZCksZD1lKGQpLGQ9aChkKSxkPUQoZCksZD1kLnJlcGxhY2UoL35EL2csIiQkIiksZD1kLnJlcGxhY2UoL35UL2csIn4iKSxkfTt2YXIgZT1mdW5jdGlvbihjKXt2YXIgYz1jLnJlcGxhY2UoL15bIF17MCwzfVxbKC4rKVxdOlsgXHRdKlxuP1sgXHRdKjw/KFxTKz8pPj9bIFx0XSpcbj9bIFx0XSooPzooXG4qKVsiKF0oLis/KVsiKV1bIFx0XSopPyg/OlxuK3xcWikvZ20sZnVuY3Rpb24oYyxkLGUsZixnKXtyZXR1cm4gZD1kLnRvTG93ZXJDYXNlKCksYVtkXT16KGUpLGY/ZitnOihnJiYoYltkXT1nLnJlcGxhY2UoLyIvZywiJnF1b3Q7IikpLCIiKX0pO3JldHVybiBjfSxmPWZ1bmN0aW9uKGEpe2E9YS5yZXBsYWNlKC9cbi9nLCJcblxuIik7dmFyIGI9InB8ZGl2fGhbMS02XXxibG9ja3F1b3RlfHByZXx0YWJsZXxkbHxvbHx1bHxzY3JpcHR8bm9zY3JpcHR8Zm9ybXxmaWVsZHNldHxpZnJhbWV8bWF0aHxpbnN8ZGVsIixjPSJwfGRpdnxoWzEtNl18YmxvY2txdW90ZXxwcmV8dGFibGV8ZGx8b2x8dWx8c2NyaXB0fG5vc2NyaXB0fGZvcm18ZmllbGRzZXR8aWZyYW1lfG1hdGgiO3JldHVybiBhPWEucmVwbGFjZSgvXig8KHB8ZGl2fGhbMS02XXxibG9ja3F1b3RlfHByZXx0YWJsZXxkbHxvbHx1bHxzY3JpcHR8bm9zY3JpcHR8Zm9ybXxmaWVsZHNldHxpZnJhbWV8bWF0aHxpbnN8ZGVsKVxiW15ccl0qP1xuPFwvXDI+WyBcdF0qKD89XG4rKSkvZ20sZyksYT1hLnJlcGxhY2UoL14oPChwfGRpdnxoWzEtNl18YmxvY2txdW90ZXxwcmV8dGFibGV8ZGx8b2x8dWx8c2NyaXB0fG5vc2NyaXB0fGZvcm18ZmllbGRzZXR8aWZyYW1lfG1hdGgpXGJbXlxyXSo/Lio8XC9cMj5bIFx0XSooPz1cbispXG4pL2dtLGcpLGE9YS5yZXBsYWNlKC8oXG5bIF17MCwzfSg8KGhyKVxiKFtePD5dKSo/XC8/PilbIFx0XSooPz1cbnsyLH0pKS9nLGcpLGE9YS5yZXBsYWNlKC8oXG5cblsgXXswLDN9PCEoLS1bXlxyXSo/LS1ccyopKz5bIFx0XSooPz1cbnsyLH0pKS9nLGcpLGE9YS5yZXBsYWNlKC8oPzpcblxuKShbIF17MCwzfSg/OjwoWz8lXSlbXlxyXSo/XDI+KVsgXHRdKig/PVxuezIsfSkpL2csZyksYT1hLnJlcGxhY2UoL1xuXG4vZywiXG4iKSxhfSxnPWZ1bmN0aW9uKGEsYil7dmFyIGQ9YjtyZXR1cm4gZD1kLnJlcGxhY2UoL1xuXG4vZywiXG4iKSxkPWQucmVwbGFjZSgvXlxuLywiIiksZD1kLnJlcGxhY2UoL1xuKyQvZywiIiksZD0iXG5cbn5LIisoYy5wdXNoKGQpLTEpKyJLXG5cbiIsZH0saD1mdW5jdGlvbihhKXthPW8oYSk7dmFyIGI9dCgiPGhyIC8+Iik7cmV0dXJuIGE9YS5yZXBsYWNlKC9eWyBdezAsMn0oWyBdP1wqWyBdPyl7Myx9WyBcdF0qJC9nbSxiKSxhPWEucmVwbGFjZSgvXlsgXXswLDJ9KFsgXT9cLVsgXT8pezMsfVsgXHRdKiQvZ20sYiksYT1hLnJlcGxhY2UoL15bIF17MCwyfShbIF0/XF9bIF0/KXszLH1bIFx0XSokL2dtLGIpLGE9cShhKSxhPXMoYSksYT1yKGEpLGE9eChhKSxhPWYoYSksYT15KGEpLGF9LGk9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9dShhKSxhPWooYSksYT1BKGEpLGE9bShhKSxhPWsoYSksYT1CKGEpLGE9eihhKSxhPXcoYSksYT1hLnJlcGxhY2UoLyAgK1xuL2csIiA8YnIgLz5cbiIpLGF9LGo9ZnVuY3Rpb24oYSl7dmFyIGI9Lyg8W2EtelwvISRdKCJbXiJdKiJ8J1teJ10qJ3xbXiciPl0pKj58PCEoLS0uKj8tLVxzKikrPikvZ2k7cmV0dXJuIGE9YS5yZXBsYWNlKGIsZnVuY3Rpb24oYSl7dmFyIGI9YS5yZXBsYWNlKC8oLik8XC8/Y29kZT4oPz0uKS9nLCIkMWAiKTtyZXR1cm4gYj1HKGIsIlxcYCpfIiksYn0pLGF9LGs9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC8oXFsoKD86XFtbXlxdXSpcXXxbXlxbXF1dKSopXF1bIF0/KD86XG5bIF0qKT9cWyguKj8pXF0pKCkoKSgpKCkvZyxsKSxhPWEucmVwbGFjZSgvKFxbKCg/OlxbW15cXV0qXF18W15cW1xdXSkqKVxdXChbIFx0XSooKTw/KC4qPyk+P1sgXHRdKigoWyciXSkoLio/KVw2WyBcdF0qKT9cKSkvZyxsKSxhPWEucmVwbGFjZSgvKFxbKFteXFtcXV0rKVxdKSgpKCkoKSgpKCkvZyxsKSxhfSxsPWZ1bmN0aW9uKGMsZCxlLGYsZyxoLGksail7aj09dW5kZWZpbmVkJiYoaj0iIik7dmFyIGs9ZCxsPWUsbT1mLnRvTG93ZXJDYXNlKCksbj1nLG89ajtpZihuPT0iIil7bT09IiImJihtPWwudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC8gP1xuL2csIiAiKSksbj0iIyIrbTtpZihhW21dIT11bmRlZmluZWQpbj1hW21dLGJbbV0hPXVuZGVmaW5lZCYmKG89YlttXSk7ZWxzZXtpZighKGsuc2VhcmNoKC9cKFxzKlwpJC9tKT4tMSkpcmV0dXJuIGs7bj0iIn19bj1HKG4sIipfIik7dmFyIHA9JzxhIGhyZWY9IicrbisnIic7cmV0dXJuIG8hPSIiJiYobz1vLnJlcGxhY2UoLyIvZywiJnF1b3Q7Iiksbz1HKG8sIipfIikscCs9JyB0aXRsZT0iJytvKyciJykscCs9Ij4iK2wrIjwvYT4iLHB9LG09ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC8oIVxbKC4qPylcXVsgXT8oPzpcblsgXSopP1xbKC4qPylcXSkoKSgpKCkoKS9nLG4pLGE9YS5yZXBsYWNlKC8oIVxbKC4qPylcXVxzP1woWyBcdF0qKCk8PyhcUys/KT4/WyBcdF0qKChbJyJdKSguKj8pXDZbIFx0XSopP1wpKS9nLG4pLGF9LG49ZnVuY3Rpb24oYyxkLGUsZixnLGgsaSxqKXt2YXIgaz1kLGw9ZSxtPWYudG9Mb3dlckNhc2UoKSxuPWcsbz1qO298fChvPSIiKTtpZihuPT0iIil7bT09IiImJihtPWwudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC8gP1xuL2csIiAiKSksbj0iIyIrbTtpZihhW21dPT11bmRlZmluZWQpcmV0dXJuIGs7bj1hW21dLGJbbV0hPXVuZGVmaW5lZCYmKG89YlttXSl9bD1sLnJlcGxhY2UoLyIvZywiJnF1b3Q7Iiksbj1HKG4sIipfIik7dmFyIHA9JzxpbWcgc3JjPSInK24rJyIgYWx0PSInK2wrJyInO3JldHVybiBvPW8ucmVwbGFjZSgvIi9nLCImcXVvdDsiKSxvPUcobywiKl8iKSxwKz0nIHRpdGxlPSInK28rJyInLHArPSIgLz4iLHB9LG89ZnVuY3Rpb24oYSl7ZnVuY3Rpb24gYihhKXtyZXR1cm4gYS5yZXBsYWNlKC9bXlx3XS9nLCIiKS50b0xvd2VyQ2FzZSgpfXJldHVybiBhPWEucmVwbGFjZSgvXiguKylbIFx0XSpcbj0rWyBcdF0qXG4rL2dtLGZ1bmN0aW9uKGEsYyl7cmV0dXJuIHQoJzxoMSBpZD0iJytiKGMpKyciPicraShjKSsiPC9oMT4iKX0pLGE9YS5yZXBsYWNlKC9eKC4rKVsgXHRdKlxuLStbIFx0XSpcbisvZ20sZnVuY3Rpb24oYSxjKXtyZXR1cm4gdCgnPGgyIGlkPSInK2IoYykrJyI+JytpKGMpKyI8L2gyPiIpfSksYT1hLnJlcGxhY2UoL14oXCN7MSw2fSlbIFx0XSooLis/KVsgXHRdKlwjKlxuKy9nbSxmdW5jdGlvbihhLGMsZCl7dmFyIGU9Yy5sZW5ndGg7cmV0dXJuIHQoIjxoIitlKycgaWQ9IicrYihkKSsnIj4nK2koZCkrIjwvaCIrZSsiPiIpfSksYX0scCxxPWZ1bmN0aW9uKGEpe2ErPSJ+MCI7dmFyIGI9L14oKFsgXXswLDN9KFsqKy1dfFxkK1suXSlbIFx0XSspW15ccl0rPyh+MHxcbnsyLH0oPz1cUykoPyFbIFx0XSooPzpbKistXXxcZCtbLl0pWyBcdF0rKSkpL2dtO3JldHVybiBkP2E9YS5yZXBsYWNlKGIsZnVuY3Rpb24oYSxiLGMpe3ZhciBkPWIsZT1jLnNlYXJjaCgvWyorLV0vZyk+LTE/InVsIjoib2wiO2Q9ZC5yZXBsYWNlKC9cbnsyLH0vZywiXG5cblxuIik7dmFyIGY9cChkKTtyZXR1cm4gZj1mLnJlcGxhY2UoL1xzKyQvLCIiKSxmPSI8IitlKyI+IitmKyI8LyIrZSsiPlxuIixmfSk6KGI9LyhcblxufF5cbj8pKChbIF17MCwzfShbKistXXxcZCtbLl0pWyBcdF0rKVteXHJdKz8ofjB8XG57Mix9KD89XFMpKD8hWyBcdF0qKD86WyorLV18XGQrWy5dKVsgXHRdKykpKS9nLGE9YS5yZXBsYWNlKGIsZnVuY3Rpb24oYSxiLGMsZCl7dmFyIGU9YixmPWMsZz1kLnNlYXJjaCgvWyorLV0vZyk+LTE/InVsIjoib2wiLGY9Zi5yZXBsYWNlKC9cbnsyLH0vZywiXG5cblxuIiksaD1wKGYpO3JldHVybiBoPWUrIjwiK2crIj5cbiIraCsiPC8iK2crIj5cbiIsaH0pKSxhPWEucmVwbGFjZSgvfjAvLCIiKSxhfTtwPWZ1bmN0aW9uKGEpe3JldHVybiBkKyssYT1hLnJlcGxhY2UoL1xuezIsfSQvLCJcbiIpLGErPSJ+MCIsYT1hLnJlcGxhY2UoLyhcbik/KF5bIFx0XSopKFsqKy1dfFxkK1suXSlbIFx0XSsoW15ccl0rPyhcbnsxLDJ9KSkoPz1cbioofjB8XDIoWyorLV18XGQrWy5dKVsgXHRdKykpL2dtLGZ1bmN0aW9uKGEsYixjLGQsZSl7dmFyIGY9ZSxnPWIsaj1jO3JldHVybiBnfHxmLnNlYXJjaCgvXG57Mix9Lyk+LTE/Zj1oKEUoZikpOihmPXEoRShmKSksZj1mLnJlcGxhY2UoL1xuJC8sIiIpLGY9aShmKSksIjxsaT4iK2YrIjwvbGk+XG4ifSksYT1hLnJlcGxhY2UoL34wL2csIiIpLGQtLSxhfTt2YXIgcj1mdW5jdGlvbihhKXtyZXR1cm4gYSs9In4wIixhPWEucmVwbGFjZSgvKD86XG5cbnxeKSgoPzooPzpbIF17NH18XHQpLipcbispKykoXG4qWyBdezAsM31bXiBcdFxuXXwoPz1+MCkpL2csZnVuY3Rpb24oYSxiLGMpe3ZhciBkPWIsZT1jO3JldHVybiBkPXYoRShkKSksZD1GKGQpLGQ9ZC5yZXBsYWNlKC9eXG4rL2csIiIpLGQ9ZC5yZXBsYWNlKC9cbiskL2csIiIpLGQ9IjxwcmU+PGNvZGU+IitkKyJcbjwvY29kZT48L3ByZT4iLHQoZCkrZX0pLGE9YS5yZXBsYWNlKC9+MC8sIiIpLGF9LHM9ZnVuY3Rpb24oYSl7cmV0dXJuIGErPSJ+MCIsYT1hLnJlcGxhY2UoL1xuYGBgKC4qKVxuKFteYF0rKVxuYGBgL2csZnVuY3Rpb24oYSxiLGMpe3ZhciBkPWIsZT1jO3JldHVybiBlPXYoZSksZT1GKGUpLGU9ZS5yZXBsYWNlKC9eXG4rL2csIiIpLGU9ZS5yZXBsYWNlKC9cbiskL2csIiIpLGU9IjxwcmU+PGNvZGUgY2xhc3M9IitkKyI+IitlKyJcbjwvY29kZT48L3ByZT4iLHQoZSl9KSxhPWEucmVwbGFjZSgvfjAvLCIiKSxhfSx0PWZ1bmN0aW9uKGEpe3JldHVybiBhPWEucmVwbGFjZSgvKF5cbit8XG4rJCkvZywiIiksIlxuXG5+SyIrKGMucHVzaChhKS0xKSsiS1xuXG4ifSx1PWZ1bmN0aW9uKGEpe3JldHVybiBhPWEucmVwbGFjZSgvKF58W15cXF0pKGArKShbXlxyXSo/W15gXSlcMig/IWApL2dtLGZ1bmN0aW9uKGEsYixjLGQsZSl7dmFyIGY9ZDtyZXR1cm4gZj1mLnJlcGxhY2UoL14oWyBcdF0qKS9nLCIiKSxmPWYucmVwbGFjZSgvWyBcdF0qJC9nLCIiKSxmPXYoZiksYisiPGNvZGU+IitmKyI8L2NvZGU+In0pLGF9LHY9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC8mL2csIiZhbXA7IiksYT1hLnJlcGxhY2UoLzwvZywiJmx0OyIpLGE9YS5yZXBsYWNlKC8+L2csIiZndDsiKSxhPUcoYSwiKl97fVtdXFwiLCExKSxhfSx3PWZ1bmN0aW9uKGEpe3JldHVybiBhPWEucmVwbGFjZSgvKFwqXCp8X18pKD89XFMpKFteXHJdKj9cU1sqX10qKVwxL2csIjxzdHJvbmc+JDI8L3N0cm9uZz4iKSxhPWEucmVwbGFjZSgvKFwqfF8pKD89XFMpKFteXHJdKj9cUylcMS9nLCI8ZW0+JDI8L2VtPiIpLGF9LHg9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC8oKF5bIFx0XSo+WyBcdF0/LitcbiguK1xuKSpcbiopKykvZ20sZnVuY3Rpb24oYSxiKXt2YXIgYz1iO3JldHVybiBjPWMucmVwbGFjZSgvXlsgXHRdKj5bIFx0XT8vZ20sIn4wIiksYz1jLnJlcGxhY2UoL34wL2csIiIpLGM9Yy5yZXBsYWNlKC9eWyBcdF0rJC9nbSwiIiksYz1oKGMpLGM9Yy5yZXBsYWNlKC8oXnxcbikvZywiJDEgICIpLGM9Yy5yZXBsYWNlKC8oXHMqPHByZT5bXlxyXSs/PFwvcHJlPikvZ20sZnVuY3Rpb24oYSxiKXt2YXIgYz1iO3JldHVybiBjPWMucmVwbGFjZSgvXiAgL21nLCJ+MCIpLGM9Yy5yZXBsYWNlKC9+MC9nLCIiKSxjfSksdCgiPGJsb2NrcXVvdGU+XG4iK2MrIlxuPC9ibG9ja3F1b3RlPiIpfSksYX0seT1mdW5jdGlvbihhKXthPWEucmVwbGFjZSgvXlxuKy9nLCIiKSxhPWEucmVwbGFjZSgvXG4rJC9nLCIiKTt2YXIgYj1hLnNwbGl0KC9cbnsyLH0vZyksZD1uZXcgQXJyYXksZT1iLmxlbmd0aDtmb3IodmFyIGY9MDtmPGU7ZisrKXt2YXIgZz1iW2ZdO2cuc2VhcmNoKC9+SyhcZCspSy9nKT49MD9kLnB1c2goZyk6Zy5zZWFyY2goL1xTLyk+PTAmJihnPWkoZyksZz1nLnJlcGxhY2UoL14oWyBcdF0qKS9nLCI8cD4iKSxnKz0iPC9wPiIsZC5wdXNoKGcpKX1lPWQubGVuZ3RoO2Zvcih2YXIgZj0wO2Y8ZTtmKyspd2hpbGUoZFtmXS5zZWFyY2goL35LKFxkKylLLyk+PTApe3ZhciBoPWNbUmVnRXhwLiQxXTtoPWgucmVwbGFjZSgvXCQvZywiJCQkJCIpLGRbZl09ZFtmXS5yZXBsYWNlKC9+S1xkK0svLGgpfXJldHVybiBkLmpvaW4oIlxuXG4iKX0sej1mdW5jdGlvbihhKXtyZXR1cm4gYT1hLnJlcGxhY2UoLyYoPyEjP1t4WF0/KD86WzAtOWEtZkEtRl0rfFx3Kyk7KS9nLCImYW1wOyIpLGE9YS5yZXBsYWNlKC88KD8hW2EtelwvP1wkIV0pL2dpLCImbHQ7IiksYX0sQT1mdW5jdGlvbihhKXtyZXR1cm4gYT1hLnJlcGxhY2UoL1xcKFxcKS9nLEgpLGE9YS5yZXBsYWNlKC9cXChbYCpfe31cW1xdKCk+IystLiFdKS9nLEgpLGF9LEI9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC88KChodHRwcz98ZnRwfGRpY3QpOlteJyI+XHNdKyk+L2dpLCc8YSBocmVmPSIkMSI+JDE8L2E+JyksYT1hLnJlcGxhY2UoLzwoPzptYWlsdG86KT8oWy0uXHddK1xAWy1hLXowLTldKyhcLlstYS16MC05XSspKlwuW2Etel0rKT4vZ2ksZnVuY3Rpb24oYSxiKXtyZXR1cm4gQyhEKGIpKX0pLGF9LEM9ZnVuY3Rpb24oYSl7ZnVuY3Rpb24gYihhKXt2YXIgYj0iMDEyMzQ1Njc4OUFCQ0RFRiIsYz1hLmNoYXJDb2RlQXQoMCk7cmV0dXJuIGIuY2hhckF0KGM+PjQpK2IuY2hhckF0KGMmMTUpfXZhciBjPVtmdW5jdGlvbihhKXtyZXR1cm4iJiMiK2EuY2hhckNvZGVBdCgwKSsiOyJ9LGZ1bmN0aW9uKGEpe3JldHVybiImI3giK2IoYSkrIjsifSxmdW5jdGlvbihhKXtyZXR1cm4gYX1dO3JldHVybiBhPSJtYWlsdG86IithLGE9YS5yZXBsYWNlKC8uL2csZnVuY3Rpb24oYSl7aWYoYT09IkAiKWE9Y1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqMildKGEpO2Vsc2UgaWYoYSE9IjoiKXt2YXIgYj1NYXRoLnJhbmRvbSgpO2E9Yj4uOT9jWzJdKGEpOmI+LjQ1P2NbMV0oYSk6Y1swXShhKX1yZXR1cm4gYX0pLGE9JzxhIGhyZWY9IicrYSsnIj4nK2ErIjwvYT4iLGE9YS5yZXBsYWNlKC8iPi4rOi9nLCciPicpLGF9LEQ9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC9+RShcZCspRS9nLGZ1bmN0aW9uKGEsYil7dmFyIGM9cGFyc2VJbnQoYik7cmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoYyl9KSxhfSxFPWZ1bmN0aW9uKGEpe3JldHVybiBhPWEucmVwbGFjZSgvXihcdHxbIF17MSw0fSkvZ20sIn4wIiksYT1hLnJlcGxhY2UoL34wL2csIiIpLGF9LEY9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC9cdCg/PVx0KS9nLCIgICAgIiksYT1hLnJlcGxhY2UoL1x0L2csIn5BfkIiKSxhPWEucmVwbGFjZSgvfkIoLis/KX5BL2csZnVuY3Rpb24oYSxiLGMpe3ZhciBkPWIsZT00LWQubGVuZ3RoJTQ7Zm9yKHZhciBmPTA7ZjxlO2YrKylkKz0iICI7cmV0dXJuIGR9KSxhPWEucmVwbGFjZSgvfkEvZywiICAgICIpLGE9YS5yZXBsYWNlKC9+Qi9nLCIiKSxhfSxHPWZ1bmN0aW9uKGEsYixjKXt2YXIgZD0iKFsiK2IucmVwbGFjZSgvKFtcW1xdXFxdKS9nLCJcXCQxIikrIl0pIjtjJiYoZD0iXFxcXCIrZCk7dmFyIGU9bmV3IFJlZ0V4cChkLCJnIik7cmV0dXJuIGE9YS5yZXBsYWNlKGUsSCksYX0sSD1mdW5jdGlvbihhLGIpe3ZhciBjPWIuY2hhckNvZGVBdCgwKTtyZXR1cm4ifkUiK2MrIkUifX0sdHlwZW9mIGV4cG9ydHMhPSJ1bmRlZmluZWQiJiYoZXhwb3J0cz1TaG93ZG93bik7CmRlZmluZSgic2hvd2Rvd24iLCAoZnVuY3Rpb24gKGdsb2JhbCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZ2xvYmFsLlNob3dkb3duOwogICAgfQp9KHRoaXMpKSk7CgpkZWZpbmUoJ21haW4nLFsndGhydXN0JywgJ2pxdWVyeScsICdzaG93ZG93biddLApmdW5jdGlvbihUaHJ1c3QsICQsIFNob3dkb3duKQp7CiAgICB2YXIgY29udmVydGVyID0gbmV3IFNob3dkb3duLmNvbnZlcnRlcigpOwogICAgJChmdW5jdGlvbiAoKQogICAgewogICAgICAgICQoZG9jdW1lbnQuYm9keSkuZGVsZWdhdGUoJ2FbcmVsPXBvcG92ZXJdJywgJ21vdXNlb3ZlcicsIGZ1bmN0aW9uIChlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyICR0aGlzID0gJCh0aGlzKTsKICAgICAgICAgICAgaWYgKCEkdGhpcy5kYXRhKCdwb3BvdmVyJykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBjb250ZW50ID0gJHRoaXMuZGF0YSgnY29udGVudCcpOwogICAgICAgICAgICAgICAgY29udGVudCA9IGNvbnZlcnRlci5tYWtlSHRtbChjb250ZW50LnJlcGxhY2UoL1xcbi9nLCAnXG4nKSk7CiAgICAgICAgICAgICAgICAkdGhpcy5hdHRyKCdkYXRhLWNvbnRlbnQnLCBjb250ZW50KTsKICAgICAgICAgICAgICAgIGlmICghJHRoaXMuYXR0cigndGl0bGUnKSkKICAgICAgICAgICAgICAgICAgICAkdGhpcy5hdHRyKCd0aXRsZScsICR0aGlzLnRleHQoKSk7CiAgICAgICAgICAgICAgICAkKHRoaXMpLnBvcG92ZXIoKS5wb3BvdmVyKCdzaG93Jyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgJChkb2N1bWVudC5ib2R5KS5kZWxlZ2F0ZSgnYVtyZWw9cG9wb3Zlcl0nLCAnY2xpY2snLCBmdW5jdGlvbiAoZSkKICAgICAgICB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKQogICAgICAgIH0pOwogICAgfSk7CgogICAgVGhydXN0LmxhdW5jaCgpOwp9KTsKLyoqIEBsaWNlbnNlIE1JVCBMaWNlbnNlIChjKSBjb3B5cmlnaHQgQiBDYXZhbGllciAmIEogSGFubiAqLwoKLyoqCiAqIGFvcAogKiBBc3BlY3QgT3JpZW50ZWQgUHJvZ3JhbW1pbmcgZm9yIEphdmFzY3JpcHQKICoKICogYW9wIGlzIHBhcnQgb2YgdGhlIGN1am8uanMgZmFtaWx5IG9mIGxpYnJhcmllcyAoaHR0cDovL2N1am9qcy5jb20vKQogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UgYXQ6CiAqIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwCiAqCiAqIEB2ZXJzaW9uIDAuNS4zCiAqLwooZnVuY3Rpb24gKGRlZmluZSkgewpkZWZpbmUoJ2FvcCcsW10sZnVuY3Rpb24gKCkgewoKCXZhciBhcCwgcHJlcGVuZCwgYXBwZW5kLCBzbGljZSwgaXNBcnJheSwgZnJlZXplOwoKCWZyZWV6ZSA9IE9iamVjdC5mcmVlemUgfHwgZnVuY3Rpb24gKG8pIHsgcmV0dXJuIG87IH07CgoJYXAgICAgICA9IEFycmF5LnByb3RvdHlwZTsKCXByZXBlbmQgPSBhcC51bnNoaWZ0OwoJYXBwZW5kICA9IGFwLnB1c2g7CglzbGljZSAgID0gYXAuc2xpY2U7CgoJaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24oaXQpIHsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGl0KSA9PSAnW29iamVjdCBBcnJheV0nOwoJfTsKCgkvKioKCSAqIEhlbHBlciB0byBjb252ZXJ0IGFyZ3VtZW50cyB0byBhbiBhcnJheQoJICogQHBhcmFtIGEge0FyZ3VtZW50c30gYXJndW1lbnRzCgkgKiBAcmV0dXJuIHtBcnJheX0KCSAqLwoJZnVuY3Rpb24gYXJnc1RvQXJyYXkoYSkgewoJCXJldHVybiBzbGljZS5jYWxsKGEpOwoJfQoKCWZ1bmN0aW9uIGZvckVhY2goYXJyYXksIGZ1bmMpIHsKCQlmb3IgKHZhciBpID0gMCwgbGVuID0gYXJyYXkubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKCQkJZnVuYyhhcnJheVtpXSk7CgkJfQoJfQoKCWZ1bmN0aW9uIGZvckVhY2hSZXZlcnNlKGFycmF5LCBmdW5jKSB7CgkJZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CgkJCWZ1bmMoYXJyYXlbaV0pOwoJCX0KCX0KCgl2YXIgaXRlcmF0b3JzID0gewoJCSAgIC8vIEJlZm9yZSB1c2VzIHJldmVyc2UgaXRlcmF0aW9uCgkJICAgYmVmb3JlOiBmb3JFYWNoUmV2ZXJzZQoJICAgfTsKCgkvLyBBbGwgb3RoZXIgYWR2aWNlIHR5cGVzIHVzZSBmb3J3YXJkIGl0ZXJhdGlvbgoJLy8gQXJvdW5kIGlzIGEgc3BlY2lhbCBjYXNlIHRoYXQgdXNlcyByZWN1cnNpb24gcmF0aGVyIHRoYW4KCS8vIGl0ZXJhdGlvbi4gIFNlZSBBZHZpc29yLl9jYWxsQXJvdW5kQWR2aWNlCglpdGVyYXRvcnMub24KCQk9IGl0ZXJhdG9ycy5hZnRlclJldHVybmluZwoJCT0gaXRlcmF0b3JzLmFmdGVyVGhyb3dpbmcKCQk9IGl0ZXJhdG9ycy5hZnRlcgoJCT0gZm9yRWFjaDsKCglmdW5jdGlvbiBwcm9jZWVkQWxyZWFkeUNhbGxlZCgpIHsgdGhyb3cgbmV3IEVycm9yKCJwcm9jZWVkKCkgbWF5IG9ubHkgYmUgY2FsbGVkIG9uY2UiKTsgfQoKCWZ1bmN0aW9uIEFkdmlzb3IodGFyZ2V0LCBmdW5jKSB7CgoJCXZhciBvcmlnLCBhZHZpc29yLCBhZHZpc2VkOwoKCQl0aGlzLnRhcmdldCA9IHRhcmdldDsKCQl0aGlzLmZ1bmMgPSBmdW5jOwoJCSAgIHRoaXMuYXNwZWN0cyA9IFtdOwoKCQlvcmlnID0gdGhpcy5vcmlnID0gdGFyZ2V0W2Z1bmNdOwoJCWFkdmlzb3IgPSB0aGlzOwoKCQlhZHZpc2VkID0gdGhpcy5hZHZpc2VkID0gZnVuY3Rpb24oKSB7CgkJCXZhciBjb250ZXh0LCBhcmdzLCByZXN1bHQsIGFmdGVyVHlwZSwgZXhjZXB0aW9uOwoKCQkJICAgY29udGV4dCA9IHRoaXM7CgoJCQlmdW5jdGlvbiBjYWxsT3JpZyhhcmdzKSB7CgkJCQl2YXIgcmVzdWx0ID0gb3JpZy5hcHBseShjb250ZXh0LCBhcmdzKTsKCQkJCWFkdmlzb3IuX2NhbGxTaW1wbGVBZHZpY2UoJ29uJywgY29udGV4dCwgYXJncyk7CgoJCQkJcmV0dXJuIHJlc3VsdDsKCQkJfQoKCQkJZnVuY3Rpb24gY2FsbEFmdGVyKGFmdGVyVHlwZSwgYXJncykgewoJCQkJYWR2aXNvci5fY2FsbFNpbXBsZUFkdmljZShhZnRlclR5cGUsIGNvbnRleHQsIGFyZ3MpOwoJCQl9CgoJCQlhcmdzID0gYXJnc1RvQXJyYXkoYXJndW1lbnRzKTsKCQkJYWZ0ZXJUeXBlID0gJ2FmdGVyUmV0dXJuaW5nJzsKCgkJCWFkdmlzb3IuX2NhbGxTaW1wbGVBZHZpY2UoJ2JlZm9yZScsIGNvbnRleHQsIGFyZ3MpOwoKCQkJdHJ5IHsKCQkJCXJlc3VsdCA9IGFkdmlzb3IuX2NhbGxBcm91bmRBZHZpY2UoY29udGV4dCwgZnVuYywgYXJncywgY2FsbE9yaWcpOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXJlc3VsdCA9IGV4Y2VwdGlvbiA9IGU7CgkJCQkgICAvLyBTd2l0Y2ggdG8gYWZ0ZXJUaHJvd2luZwoJCQkJYWZ0ZXJUeXBlID0gJ2FmdGVyVGhyb3dpbmcnOwoJCQkgICB9CgoJCQlhcmdzID0gW3Jlc3VsdF07CgoJCQljYWxsQWZ0ZXIoYWZ0ZXJUeXBlLCBhcmdzKTsKCQkJY2FsbEFmdGVyKCdhZnRlcicsIGFyZ3MpOwoKCQkJaWYoZXhjZXB0aW9uKSB7CgkJCQl0aHJvdyBleGNlcHRpb247CgkJCX0KCgkJCXJldHVybiByZXN1bHQ7CgkJfTsKCgkJYWR2aXNlZC5fYWR2aXNvciA9IHRoaXM7Cgl9CgoJQWR2aXNvci5wcm90b3R5cGUgPSB7CgoJCSAgIC8qKgoJCQkqIEludm9rZSBhbGwgYWR2aWNlIGZ1bmN0aW9ucyBpbiB0aGUgc3VwcGxpZWQgY29udGV4dCwgd2l0aCB0aGUgc3VwcGxpZWQgYXJncwoJCQkqCgkJCSogQHBhcmFtIGFkdmljZVR5cGUKCQkJKiBAcGFyYW0gY29udGV4dAoJCQkqIEBwYXJhbSBhcmdzCgkJCSovCgkJX2NhbGxTaW1wbGVBZHZpY2U6IGZ1bmN0aW9uKGFkdmljZVR5cGUsIGNvbnRleHQsIGFyZ3MpIHsKCgkJCS8vIGJlZm9yZSBhZHZpY2UgcnVucyBMSUZPLCBmcm9tIG1vc3QtcmVjZW50bHkgYWRkZWQgdG8gbGVhc3QtcmVjZW50bHkgYWRkZWQuCgkJCS8vIEFsbCBvdGhlciBhZHZpY2UgaXMgRklGTwoJCQl2YXIgaXRlcmF0b3IgPSBpdGVyYXRvcnNbYWR2aWNlVHlwZV07CgoJCQkgICBpdGVyYXRvcih0aGlzLmFzcGVjdHMsIGZ1bmN0aW9uKGFzcGVjdCkgewoJCQkJICAgdmFyIGFkdmljZSA9IGFzcGVjdFthZHZpY2VUeXBlXTsKCQkJCSAgIGFkdmljZSAmJiBhZHZpY2UuYXBwbHkoY29udGV4dCwgYXJncyk7CgkJCSAgIH0pOwoJCX0sCgoJCS8qKgoJCSAqIEludm9rZSBhbGwgYXJvdW5kIGFkdmljZSBhbmQgdGhlbiB0aGUgb3JpZ2luYWwgbWV0aG9kCgkJICoKCQkgKiBAcGFyYW0gY29udGV4dAoJCSAqIEBwYXJhbSBtZXRob2QKCQkgKiBAcGFyYW0gYXJncwoJCSAqIEBwYXJhbSBvcmlnCgkJICovCgkJX2NhbGxBcm91bmRBZHZpY2U6IGZ1bmN0aW9uIChjb250ZXh0LCBtZXRob2QsIGFyZ3MsIG9yaWcpIHsKCQkJdmFyIGxlbiwgYXNwZWN0czsKCgkJCWFzcGVjdHMgPSB0aGlzLmFzcGVjdHM7CgkJCWxlbiA9IGFzcGVjdHMubGVuZ3RoOwoKCQkJLyoqCgkJCSAqIENhbGwgdGhlIG5leHQgZnVuY3Rpb24gaW4gdGhlIGFyb3VuZCBjaGFpbiwgd2hpY2ggd2lsbCBlaXRoZXIgYmUgYW5vdGhlciBhcm91bmQKCQkJICogYWR2aWNlLCBvciB0aGUgb3JpZyBtZXRob2QuCgkJCSAqIEBwYXJhbSBpIHtOdW1iZXJ9IGluZGV4IG9mIHRoZSBhcm91bmQgYWR2aWNlCgkJCSAqIEBwYXJhbSBhcmdzIHtBcnJheX0gYXJndW1lbnRzIHdpdGggd2l0aCB0byBjYWxsIHRoZSBuZXh0IGFyb3VuZCBhZHZpY2UKCQkJICovCgkJCWZ1bmN0aW9uIGNhbGxOZXh0KGksIGFyZ3MpIHsKCQkJCXZhciBhc3BlY3Q7CgkJCQkvLyBTa2lwIHRvIG5leHQgYXNwZWN0IHRoYXQgaGFzIGFyb3VuZCBhZHZpY2UKCQkJCXdoaWxlIChpID49IDAgJiYgKGFzcGVjdCA9IGFzcGVjdHNbaV0pICYmIHR5cGVvZiBhc3BlY3QuYXJvdW5kICE9PSAnZnVuY3Rpb24nKSAtLWk7CgoJCQkJLy8gSWYgd2UgZXhoYXVzdGVkIGFsbCBhc3BlY3RzLCBmaW5hbGx5IGNhbGwgdGhlIG9yaWdpbmFsCgkJCQkvLyBPdGhlcndpc2UsIGlmIHdlIGZvdW5kIGFub3RoZXIgYXJvdW5kLCBjYWxsIGl0CgkJCQlyZXR1cm4gKGkgPCAwKSA/IG9yaWcuY2FsbChjb250ZXh0LCBhcmdzKSA6IGNhbGxBcm91bmQoYXNwZWN0LmFyb3VuZCwgaSwgYXJncyk7CgkJCX0KCgkJCWZ1bmN0aW9uIGNhbGxBcm91bmQoYXJvdW5kLCBpLCBhcmdzKSB7CgkJCQl2YXIgcHJvY2VlZCwgam9pbnBvaW50OwoKCQkJCS8qKgoJCQkJICogQ3JlYXRlIHByb2NlZWQgZnVuY3Rpb24gdGhhdCBjYWxscyB0aGUgbmV4dCBhcm91bmQgYWR2aWNlLCBvciB0aGUgb3JpZ2luYWwuICBPdmVyd3JpdGVzIGl0c2VsZiBzbyB0aGF0IGl0IGNhbiBvbmx5IGJlIGNhbGxlZCBvbmNlLgoJCQkJICogQHBhcmFtIFthcmdzXSB7QXJyYXl9IG9wdGlvbmFsIGFyZ3VtZW50cyB0byB1c2UgaW5zdGVhZCBvZiB0aGUgb3JpZ2luYWwgYXJndW1lbnRzCgkJCQkgKi8KCQkJCXByb2NlZWQgPSBmdW5jdGlvbiAoYXJncykgewoJCQkJCXByb2NlZWQgPSBwcm9jZWVkQWxyZWFkeUNhbGxlZDsKCQkJCQlyZXR1cm4gY2FsbE5leHQoaSAtIDEsIGFyZ3MpOwoJCQkJfTsKCgkJCQkvLyBKb2lucG9pbnQgaXMgaW1tdXRhYmxlCgkJCQlqb2lucG9pbnQgPSBmcmVlemUoewoJCQkJCXRhcmdldDogY29udGV4dCwKCQkJCQltZXRob2Q6IG1ldGhvZCwKCQkJCQlhcmdzOiBhcmdzLAoJCQkJCXByb2NlZWQ6IGZ1bmN0aW9uICgvKiBuZXdBcmdzICovKSB7CgkJCQkJCS8vIGlmIG5ldyBhcmd1bWVudHMgd2VyZSBwcm92aWRlZCwgdXNlIHRoZW0KCQkJCQkJcmV0dXJuIHByb2NlZWQoYXJndW1lbnRzLmxlbmd0aCA+IDAgPyBhcmdzVG9BcnJheShhcmd1bWVudHMpIDogYXJncyk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gQ2FsbCBzdXBwbGllZCBhcm91bmQgYWR2aWNlIGZ1bmN0aW9uCgkJCQlyZXR1cm4gYXJvdW5kLmNhbGwoY29udGV4dCwgam9pbnBvaW50KTsKCQkJfQoKCQkJcmV0dXJuIGNhbGxOZXh0KGxlbiAtIDEsIGFyZ3MpOwoJCX0sCgoJCS8qKgoJCSAqIEFkZHMgdGhlIHN1cHBsaWVkIGFzcGVjdCB0byB0aGUgYWR2aXNlZCB0YXJnZXQgbWV0aG9kCgkJICoKCQkgKiBAcGFyYW0gYXNwZWN0CgkJICovCgkJYWRkOiBmdW5jdGlvbihhc3BlY3QpIHsKCgkJCXZhciBhc3BlY3RzLCBhZHZpc29yOwoKCQkJYWR2aXNvciA9IHRoaXM7CgkJCWFzcGVjdHMgPSBhZHZpc29yLmFzcGVjdHM7CgoJCQlhc3BlY3RzLnB1c2goYXNwZWN0KTsKCgkJCXJldHVybiB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uICgpIHsKCQkJCQlmb3IgKHZhciBpID0gYXNwZWN0cy5sZW5ndGg7IGkgPj0gMDsgLS1pKSB7CgkJCQkJCWlmIChhc3BlY3RzW2ldID09PSBhc3BlY3QpIHsKCQkJCQkJCWFzcGVjdHMuc3BsaWNlKGksIDEpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIElmIHRoZXJlIGFyZSBubyBhc3BlY3RzIGxlZnQsIHJlc3RvcmUgdGhlIG9yaWdpbmFsIG1ldGhvZAoJCQkJCWlmICghYXNwZWN0cy5sZW5ndGgpIHsKCQkJCQkJYWR2aXNvci5yZW1vdmUoKTsKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSwKCgkJLyoqCgkJICogUmVtb3ZlcyB0aGUgQWR2aXNvciBhbmQgdGh1cywgYWxsIGFzcGVjdHMgZnJvbSB0aGUgYWR2aXNlZCB0YXJnZXQgbWV0aG9kLCBhbmQKCQkgKiByZXN0b3JlcyB0aGUgb3JpZ2luYWwgdGFyZ2V0IG1ldGhvZCwgY29weWluZyBiYWNrIGFsbCBwcm9wZXJ0aWVzIHRoYXQgbWF5IGhhdmUKCQkgKiBiZWVuIGFkZGVkIG9yIHVwZGF0ZWQgb24gdGhlIGFkdmlzZWQgZnVuY3Rpb24uCgkJICovCgkJcmVtb3ZlOiBmdW5jdGlvbiAoKSB7CgkJCWRlbGV0ZSB0aGlzLmFkdmlzZWQuX2Fkdmlzb3I7CgkJCXRoaXMudGFyZ2V0W3RoaXMuZnVuY10gPSB0aGlzLm9yaWc7CgkJfQoJfTsKCgkvLyBSZXR1cm5zIHRoZSBhZHZpc29yIGZvciB0aGUgdGFyZ2V0IG9iamVjdC1mdW5jdGlvbiBwYWlyLiAgQSBuZXcgYWR2aXNvcgoJLy8gd2lsbCBiZSBjcmVhdGVkIGlmIG9uZSBkb2VzIG5vdCBhbHJlYWR5IGV4aXN0LgoJQWR2aXNvci5nZXQgPSBmdW5jdGlvbih0YXJnZXQsIGZ1bmMpIHsKCQlpZighKGZ1bmMgaW4gdGFyZ2V0KSkgcmV0dXJuOwoKCQl2YXIgYWR2aXNvciwgYWR2aXNlZDsKCgkJYWR2aXNlZCA9IHRhcmdldFtmdW5jXTsKCgkJaWYodHlwZW9mIGFkdmlzZWQgIT09ICdmdW5jdGlvbicpIHRocm93IG5ldyBFcnJvcignQWR2aWNlIGNhbiBvbmx5IGJlIGFwcGxpZWQgdG8gZnVuY3Rpb25zOiAnICsgZnVuYyk7CgoJCWFkdmlzb3IgPSBhZHZpc2VkLl9hZHZpc29yOwoJCWlmKCFhZHZpc29yKSB7CgkJCWFkdmlzb3IgPSBuZXcgQWR2aXNvcih0YXJnZXQsIGZ1bmMpOwoJCQl0YXJnZXRbZnVuY10gPSBhZHZpc29yLmFkdmlzZWQ7CgkJfQoKCQlyZXR1cm4gYWR2aXNvcjsKCX07CgoJZnVuY3Rpb24gYWRkQXNwZWN0VG9NZXRob2QodGFyZ2V0LCBtZXRob2QsIGFzcGVjdCkgewoJCXZhciBhZHZpc29yID0gQWR2aXNvci5nZXQodGFyZ2V0LCBtZXRob2QpOwoKCQlyZXR1cm4gYWR2aXNvciAmJiBhZHZpc29yLmFkZChhc3BlY3QpOwoJfQoKCWZ1bmN0aW9uIGFkZEFzcGVjdFRvQWxsKHRhcmdldCwgbWV0aG9kQXJyYXksIGFzcGVjdCkgewoJCXZhciByZW1vdmVycywgYWRkZWQsIGYsIGk7CgoJCXJlbW92ZXJzID0gW107CgkJaSA9IDA7CgkJd2hpbGUoKGYgPSBtZXRob2RBcnJheVtpKytdKSkgewoJCQkgICBhZGRlZCA9IGFkZEFzcGVjdFRvTWV0aG9kKHRhcmdldCwgZiwgYXNwZWN0KTsKCQkJICAgYWRkZWQgJiYgcmVtb3ZlcnMucHVzaChhZGRlZCk7CgkJfQoKCQlyZXR1cm4gewoJCQkgICByZW1vdmU6IGZ1bmN0aW9uKCkgewoJCQkJICAgZm9yICh2YXIgaSA9IHJlbW92ZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CgkJCQkJICAgcmVtb3ZlcnNbaV0ucmVtb3ZlKCk7CgkJCQkgICB9CgkJCSAgIH0KCQkgICB9OwoJICAgfQoKCWZ1bmN0aW9uIGFkZEFzcGVjdCh0YXJnZXQsIHBvaW50Y3V0LCBhc3BlY3QpIHsKCQkvLyBwb2ludGN1dCBjYW4gYmU6IHN0cmluZywgQXJyYXkgb2Ygc3RyaW5ncywgUmVnRXhwLCBGdW5jdGlvbih0YXJnZXRPYmplY3QpOiBBcnJheSBvZiBzdHJpbmdzCgkJLy8gYWR2aWNlIGNhbiBiZTogb2JqZWN0LCBGdW5jdGlvbih0YXJnZXRPYmplY3QsIHRhcmdldE1ldGhvZE5hbWUpCgoJCXZhciBwb2ludGN1dFR5cGUsIHJlbW92ZTsKCgkJICAgdGFyZ2V0ID0gZmluZFRhcmdldCh0YXJnZXQpOwoKCQlpZiAoaXNBcnJheShwb2ludGN1dCkpIHsKCQkJcmVtb3ZlID0gYWRkQXNwZWN0VG9BbGwodGFyZ2V0LCBwb2ludGN1dCwgYXNwZWN0KTsKCgkJfSBlbHNlIHsKCQkJcG9pbnRjdXRUeXBlID0gdHlwZW9mIHBvaW50Y3V0OwoKCQkJaWYgKHBvaW50Y3V0VHlwZSA9PT0gJ3N0cmluZycpIHsKCQkJCWlmICh0eXBlb2YgdGFyZ2V0W3BvaW50Y3V0XSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJlbW92ZSA9IGFkZEFzcGVjdFRvTWV0aG9kKHRhcmdldCwgcG9pbnRjdXQsIGFzcGVjdCk7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKHBvaW50Y3V0VHlwZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJcmVtb3ZlID0gYWRkQXNwZWN0VG9BbGwodGFyZ2V0LCBwb2ludGN1dCh0YXJnZXQpLCBhc3BlY3QpOwoKCQkJfSBlbHNlIHsKCQkJCS8vIEFzc3VtZSB0aGUgcG9pbnRjdXQgaXMgYSBSZWdFeHAKCQkJCWZvciAodmFyIHAgaW4gdGFyZ2V0KSB7CgkJCQkJLy8gVE9ETzogRGVjaWRlIHdoZXRoZXIgaGFzT3duUHJvcGVydHkgaXMgY29ycmVjdCBoZXJlCgkJCQkJLy8gT25seSBhcHBseSB0byBvd24gcHJvcGVydGllcyB0aGF0IGFyZSBmdW5jdGlvbnMsIGFuZCBtYXRjaCB0aGUgcG9pbnRjdXQgcmVnZXhwCgkJCQkJaWYgKHR5cGVvZiB0YXJnZXRbcF0gPT09ICdmdW5jdGlvbicgJiYgcG9pbnRjdXQudGVzdChwKSkgewoJCQkJCQkvLyBpZihvYmplY3QuaGFzT3duUHJvcGVydHkocCkgJiYgdHlwZW9mIG9iamVjdFtwXSA9PT0gJ2Z1bmN0aW9uJyAmJiBwb2ludGN1dC50ZXN0KHApKSB7CgkJCQkJCXJlbW92ZSA9IGFkZEFzcGVjdFRvTWV0aG9kKHRhcmdldCwgcCwgYXNwZWN0KTsKCgkJCQkJfQoJCQkJfQoKCQkJfQoJCX0KCgkJcmV0dXJuIHJlbW92ZTsKCgl9CgoJZnVuY3Rpb24gZmluZFRhcmdldCh0YXJnZXQpIHsKCQlyZXR1cm4gdGFyZ2V0LnByb3RvdHlwZSB8fCB0YXJnZXQ7Cgl9CgoJLy8gQ3JlYXRlIGFuIEFQSSBmdW5jdGlvbiBmb3IgdGhlIHNwZWNpZmllZCBhZHZpY2UgdHlwZQoJZnVuY3Rpb24gYWR2aWNlQXBpKHR5cGUpIHsKCQlyZXR1cm4gZnVuY3Rpb24odGFyZ2V0LCBmdW5jLCBhZHZpY2VGdW5jKSB7CgkJCXZhciBhc3BlY3QgPSB7fTsKCQkJYXNwZWN0W3R5cGVdID0gYWR2aWNlRnVuYzsKCgkJCXJldHVybiBhZGRBc3BlY3QodGFyZ2V0LCBmdW5jLCBhc3BlY3QpOwoJCX07Cgl9CgoJLy8gUHVibGljIEFQSQoJcmV0dXJuIHsKCQkvLyBHZW5lcmFsIGFkZCBhc3BlY3QKCQkvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIHJlbW92ZSB0aGUgbmV3bHktYWRkZWQgYXNwZWN0CgkJYWRkOiAgICAgICAgICAgIGFkZEFzcGVjdCwKCgkJLy8gQWRkIGEgc2luZ2xlLCBzcGVjaWZpYyB0eXBlIG9mIGFkdmljZQoJCS8vIHJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmVtb3ZlIHRoZSBuZXdseS1hZGRlZCBhZHZpY2UKCQliZWZvcmU6ICAgICAgICAgYWR2aWNlQXBpKCdiZWZvcmUnKSwKCQlhcm91bmQ6ICAgICAgICAgYWR2aWNlQXBpKCdhcm91bmQnKSwKCQlvbjogICAgICAgICAgICAgYWR2aWNlQXBpKCdvbicpLAoJCWFmdGVyUmV0dXJuaW5nOiBhZHZpY2VBcGkoJ2FmdGVyUmV0dXJuaW5nJyksCgkJYWZ0ZXJUaHJvd2luZzogIGFkdmljZUFwaSgnYWZ0ZXJUaHJvd2luZycpLAoJCWFmdGVyOiAgICAgICAgICBhZHZpY2VBcGkoJ2FmdGVyJykKCX07Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nCgk/IGRlZmluZQoJOiBmdW5jdGlvbiAoZmFjdG9yeSkgewoJdHlwZW9mIG1vZHVsZSAhPSAndW5kZWZpbmVkJwoJCT8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpKQoJCTogKHRoaXMuYW9wID0gZmFjdG9yeSgpKTsKCX0KCS8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKLy8gS25vY2tvdXQgSmF2YVNjcmlwdCBsaWJyYXJ5IHYyLjEuMAovLyAoYykgU3RldmVuIFNhbmRlcnNvbiAtIGh0dHA6Ly9rbm9ja291dGpzLmNvbS8KLy8gTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCihmdW5jdGlvbih3aW5kb3csZG9jdW1lbnQsbmF2aWdhdG9yLHVuZGVmaW5lZCl7CnZhciBERUJVRz10cnVlOwohZnVuY3Rpb24oZmFjdG9yeSkgewogICAgLy8gU3VwcG9ydCB0aHJlZSBtb2R1bGUgbG9hZGluZyBzY2VuYXJpb3MKICAgIGlmICh0eXBlb2YgcmVxdWlyZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAvLyBbMV0gQ29tbW9uSlMvTm9kZS5qcwogICAgICAgIHZhciB0YXJnZXQgPSBtb2R1bGVbJ2V4cG9ydHMnXSB8fCBleHBvcnRzOyAvLyBtb2R1bGUuZXhwb3J0cyBpcyBmb3IgTm9kZS5qcwogICAgICAgIGZhY3RvcnkodGFyZ2V0KTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmVbJ2FtZCddKSB7CiAgICAgICAgLy8gWzJdIEFNRCBhbm9ueW1vdXMgbW9kdWxlCiAgICAgICAgZGVmaW5lKCdrbm9ja291dCcsWydleHBvcnRzJ10sIGZhY3RvcnkpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBbM10gTm8gbW9kdWxlIGxvYWRlciAocGxhaW4gPHNjcmlwdD4gdGFnKSAtIHB1dCBkaXJlY3RseSBpbiBnbG9iYWwgbmFtZXNwYWNlCiAgICAgICAgZmFjdG9yeSh3aW5kb3dbJ2tvJ10gPSB7fSk7CiAgICB9Cn0oZnVuY3Rpb24oa29FeHBvcnRzKXsKLy8gSW50ZXJuYWxseSwgYWxsIEtPIG9iamVjdHMgYXJlIGF0dGFjaGVkIHRvIGtvRXhwb3J0cyAoZXZlbiB0aGUgbm9uLWV4cG9ydGVkIG9uZXMgd2hvc2UgbmFtZXMgd2lsbCBiZSBtaW5pZmllZCBieSB0aGUgY2xvc3VyZSBjb21waWxlcikuCi8vIEluIHRoZSBmdXR1cmUsIHRoZSBmb2xsb3dpbmcgImtvIiB2YXJpYWJsZSBtYXkgYmUgbWFkZSBkaXN0aW5jdCBmcm9tICJrb0V4cG9ydHMiIHNvIHRoYXQgcHJpdmF0ZSBvYmplY3RzIGFyZSBub3QgZXh0ZXJuYWxseSByZWFjaGFibGUuCnZhciBrbyA9IHR5cGVvZiBrb0V4cG9ydHMgIT09ICd1bmRlZmluZWQnID8ga29FeHBvcnRzIDoge307Ci8vIEdvb2dsZSBDbG9zdXJlIENvbXBpbGVyIGhlbHBlcnMgKHVzZWQgb25seSB0byBtYWtlIHRoZSBtaW5pZmllZCBmaWxlIHNtYWxsZXIpCmtvLmV4cG9ydFN5bWJvbCA9IGZ1bmN0aW9uKGtvUGF0aCwgb2JqZWN0KSB7CiAgICB2YXIgdG9rZW5zID0ga29QYXRoLnNwbGl0KCIuIik7CgogICAgLy8gSW4gdGhlIGZ1dHVyZSwgImtvIiBtYXkgYmVjb21lIGRpc3RpbmN0IGZyb20gImtvRXhwb3J0cyIgKHNvIHRoYXQgbm9uLWV4cG9ydGVkIG9iamVjdHMgYXJlIG5vdCByZWFjaGFibGUpCiAgICAvLyBBdCB0aGF0IHBvaW50LCAidGFyZ2V0IiB3b3VsZCBiZSBzZXQgdG86ICh0eXBlb2Yga29FeHBvcnRzICE9PSAidW5kZWZpbmVkIiA/IGtvRXhwb3J0cyA6IGtvKQogICAgdmFyIHRhcmdldCA9IGtvOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aCAtIDE7IGkrKykKICAgICAgICB0YXJnZXQgPSB0YXJnZXRbdG9rZW5zW2ldXTsKICAgIHRhcmdldFt0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdXSA9IG9iamVjdDsKfTsKa28uZXhwb3J0UHJvcGVydHkgPSBmdW5jdGlvbihvd25lciwgcHVibGljTmFtZSwgb2JqZWN0KSB7CiAgb3duZXJbcHVibGljTmFtZV0gPSBvYmplY3Q7Cn07CmtvLnZlcnNpb24gPSAiMi4xLjAiOwoKa28uZXhwb3J0U3ltYm9sKCd2ZXJzaW9uJywga28udmVyc2lvbik7CmtvLnV0aWxzID0gbmV3IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgc3RyaW5nVHJpbVJlZ2V4ID0gL14oXHN8XHUwMEEwKSt8KFxzfFx1MDBBMCkrJC9nOwoKICAgIC8vIFJlcHJlc2VudCB0aGUga25vd24gZXZlbnQgdHlwZXMgaW4gYSBjb21wYWN0IHdheSwgdGhlbiBhdCBydW50aW1lIHRyYW5zZm9ybSBpdCBpbnRvIGEgaGFzaCB3aXRoIGV2ZW50IG5hbWUgYXMga2V5IChmb3IgZmFzdCBsb29rdXApCiAgICB2YXIga25vd25FdmVudHMgPSB7fSwga25vd25FdmVudFR5cGVzQnlFdmVudE5hbWUgPSB7fTsKICAgIHZhciBrZXlFdmVudFR5cGVOYW1lID0gL0ZpcmVmb3hcLzIvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpID8gJ0tleWJvYXJkRXZlbnQnIDogJ1VJRXZlbnRzJzsKICAgIGtub3duRXZlbnRzW2tleUV2ZW50VHlwZU5hbWVdID0gWydrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJ107CiAgICBrbm93bkV2ZW50c1snTW91c2VFdmVudHMnXSA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsICdtb3VzZWVudGVyJywgJ21vdXNlbGVhdmUnXTsKICAgIGZvciAodmFyIGV2ZW50VHlwZSBpbiBrbm93bkV2ZW50cykgewogICAgICAgIHZhciBrbm93bkV2ZW50c0ZvclR5cGUgPSBrbm93bkV2ZW50c1tldmVudFR5cGVdOwogICAgICAgIGlmIChrbm93bkV2ZW50c0ZvclR5cGUubGVuZ3RoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0ga25vd25FdmVudHNGb3JUeXBlLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lW2tub3duRXZlbnRzRm9yVHlwZVtpXV0gPSBldmVudFR5cGU7CiAgICAgICAgfQogICAgfQogICAgdmFyIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudCA9IHsgJ3Byb3BlcnR5Y2hhbmdlJzogdHJ1ZSB9OyAvLyBXb3JrYXJvdW5kIGZvciBhbiBJRTkgaXNzdWUgLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzQwNgoKICAgIC8vIERldGVjdCBJRSB2ZXJzaW9ucyBmb3IgYnVnIHdvcmthcm91bmRzICh1c2VzIElFIGNvbmRpdGlvbmFscywgbm90IFVBIHN0cmluZywgZm9yIHJvYnVzdG5lc3MpCiAgICB2YXIgaWVWZXJzaW9uID0gKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB2ZXJzaW9uID0gMywgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksIGlFbGVtcyA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaScpOwoKICAgICAgICAvLyBLZWVwIGNvbnN0cnVjdGluZyBjb25kaXRpb25hbCBIVE1MIGJsb2NrcyB1bnRpbCB3ZSBoaXQgb25lIHRoYXQgcmVzb2x2ZXMgdG8gYW4gZW1wdHkgZnJhZ21lbnQKICAgICAgICB3aGlsZSAoCiAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSAnPCEtLVtpZiBndCBJRSAnICsgKCsrdmVyc2lvbikgKyAnXT48aT48L2k+PCFbZW5kaWZdLS0+JywKICAgICAgICAgICAgaUVsZW1zWzBdCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gdmVyc2lvbiA+IDQgPyB2ZXJzaW9uIDogdW5kZWZpbmVkOwogICAgfSgpKTsKICAgIHZhciBpc0llNiA9IGllVmVyc2lvbiA9PT0gNiwKICAgICAgICBpc0llNyA9IGllVmVyc2lvbiA9PT0gNzsKCiAgICBmdW5jdGlvbiBpc0NsaWNrT25DaGVja2FibGVFbGVtZW50KGVsZW1lbnQsIGV2ZW50VHlwZSkgewogICAgICAgIGlmICgoa28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpICE9PSAiaW5wdXQiKSB8fCAhZWxlbWVudC50eXBlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGV2ZW50VHlwZS50b0xvd2VyQ2FzZSgpICE9ICJjbGljayIpIHJldHVybiBmYWxzZTsKICAgICAgICB2YXIgaW5wdXRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgIHJldHVybiAoaW5wdXRUeXBlID09ICJjaGVja2JveCIpIHx8IChpbnB1dFR5cGUgPT0gInJhZGlvIik7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBmaWVsZHNJbmNsdWRlZFdpdGhKc29uUG9zdDogWydhdXRoZW50aWNpdHlfdG9rZW4nLCAvXl9fUmVxdWVzdFZlcmlmaWNhdGlvblRva2VuKF8uKik/JC9dLAoKICAgICAgICBhcnJheUZvckVhY2g6IGZ1bmN0aW9uIChhcnJheSwgYWN0aW9uKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgYWN0aW9uKGFycmF5W2ldKTsKICAgICAgICB9LAoKICAgICAgICBhcnJheUluZGV4T2Y6IGZ1bmN0aW9uIChhcnJheSwgaXRlbSkgewogICAgICAgICAgICBpZiAodHlwZW9mIEFycmF5LnByb3RvdHlwZS5pbmRleE9mID09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChhcnJheSwgaXRlbSk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgaWYgKGFycmF5W2ldID09PSBpdGVtKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfSwKCiAgICAgICAgYXJyYXlGaXJzdDogZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUsIHByZWRpY2F0ZU93bmVyKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZS5jYWxsKHByZWRpY2F0ZU93bmVyLCBhcnJheVtpXSkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5W2ldOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9LAoKICAgICAgICBhcnJheVJlbW92ZUl0ZW06IGZ1bmN0aW9uIChhcnJheSwgaXRlbVRvUmVtb3ZlKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihhcnJheSwgaXRlbVRvUmVtb3ZlKTsKICAgICAgICAgICAgaWYgKGluZGV4ID49IDApCiAgICAgICAgICAgICAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0sCgogICAgICAgIGFycmF5R2V0RGlzdGluY3RWYWx1ZXM6IGZ1bmN0aW9uIChhcnJheSkgewogICAgICAgICAgICBhcnJheSA9IGFycmF5IHx8IFtdOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuYXJyYXlJbmRleE9mKHJlc3VsdCwgYXJyYXlbaV0pIDwgMCkKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChhcnJheVtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheU1hcDogZnVuY3Rpb24gKGFycmF5LCBtYXBwaW5nKSB7CiAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChtYXBwaW5nKGFycmF5W2ldKSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAgYXJyYXlGaWx0ZXI6IGZ1bmN0aW9uIChhcnJheSwgcHJlZGljYXRlKSB7CiAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAocHJlZGljYXRlKGFycmF5W2ldKSkKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChhcnJheVtpXSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAgYXJyYXlQdXNoQWxsOiBmdW5jdGlvbiAoYXJyYXksIHZhbHVlc1RvUHVzaCkgewogICAgICAgICAgICBpZiAodmFsdWVzVG9QdXNoIGluc3RhbmNlb2YgQXJyYXkpCiAgICAgICAgICAgICAgICBhcnJheS5wdXNoLmFwcGx5KGFycmF5LCB2YWx1ZXNUb1B1c2gpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHZhbHVlc1RvUHVzaC5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZXNUb1B1c2hbaV0pOwogICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgfSwKCiAgICAgICAgZXh0ZW5kOiBmdW5jdGlvbiAodGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgICAgICAgZm9yKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgICAgIGlmKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgfSwKCiAgICAgICAgZW1wdHlEb21Ob2RlOiBmdW5jdGlvbiAoZG9tTm9kZSkgewogICAgICAgICAgICB3aGlsZSAoZG9tTm9kZS5maXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKGRvbU5vZGUuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBtb3ZlQ2xlYW5lZE5vZGVzVG9Db250YWluZXJFbGVtZW50OiBmdW5jdGlvbihub2RlcykgewogICAgICAgICAgICAvLyBFbnN1cmUgaXQncyBhIHJlYWwgYXJyYXksIGFzIHdlJ3JlIGFib3V0IHRvIHJlcGFyZW50IHRoZSBub2RlcyBhbmQKICAgICAgICAgICAgLy8gd2UgZG9uJ3Qgd2FudCB0aGUgdW5kZXJseWluZyBjb2xsZWN0aW9uIHRvIGNoYW5nZSB3aGlsZSB3ZSdyZSBkb2luZyB0aGF0LgogICAgICAgICAgICB2YXIgbm9kZXNBcnJheSA9IGtvLnV0aWxzLm1ha2VBcnJheShub2Rlcyk7CgogICAgICAgICAgICB2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbm9kZXNBcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIGtvLmNsZWFuTm9kZShub2Rlc0FycmF5W2ldKTsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChub2Rlc0FycmF5W2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGFpbmVyOwogICAgICAgIH0sCgogICAgICAgIHNldERvbU5vZGVDaGlsZHJlbjogZnVuY3Rpb24gKGRvbU5vZGUsIGNoaWxkTm9kZXMpIHsKICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKGRvbU5vZGUpOwogICAgICAgICAgICBpZiAoY2hpbGROb2RlcykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBjaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBkb21Ob2RlLmFwcGVuZENoaWxkKGNoaWxkTm9kZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcmVwbGFjZURvbU5vZGVzOiBmdW5jdGlvbiAobm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5LCBuZXdOb2Rlc0FycmF5KSB7CiAgICAgICAgICAgIHZhciBub2Rlc1RvUmVwbGFjZUFycmF5ID0gbm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gW25vZGVUb1JlcGxhY2VPck5vZGVBcnJheV0gOiBub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXk7CiAgICAgICAgICAgIGlmIChub2Rlc1RvUmVwbGFjZUFycmF5Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBpbnNlcnRpb25Qb2ludCA9IG5vZGVzVG9SZXBsYWNlQXJyYXlbMF07CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gaW5zZXJ0aW9uUG9pbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbmV3Tm9kZXNBcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShuZXdOb2Rlc0FycmF5W2ldLCBpbnNlcnRpb25Qb2ludCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzVG9SZXBsYWNlQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAga28ucmVtb3ZlTm9kZShub2Rlc1RvUmVwbGFjZUFycmF5W2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZTogZnVuY3Rpb24gKG9wdGlvbk5vZGUsIGlzU2VsZWN0ZWQpIHsKICAgICAgICAgICAgLy8gSUU2IHNvbWV0aW1lcyB0aHJvd3MgInVua25vd24gZXJyb3IiIGlmIHlvdSB0cnkgdG8gd3JpdGUgdG8gLnNlbGVjdGVkIGRpcmVjdGx5LCB3aGVyZWFzIEZpcmVmb3ggc3RydWdnbGVzIHdpdGggc2V0QXR0cmlidXRlLiBQaWNrIG9uZSBiYXNlZCBvbiBicm93c2VyLgogICAgICAgICAgICBpZiAobmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJNU0lFIDYiKSA+PSAwKQogICAgICAgICAgICAgICAgb3B0aW9uTm9kZS5zZXRBdHRyaWJ1dGUoInNlbGVjdGVkIiwgaXNTZWxlY3RlZCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIG9wdGlvbk5vZGUuc2VsZWN0ZWQgPSBpc1NlbGVjdGVkOwogICAgICAgIH0sCgogICAgICAgIHN0cmluZ1RyaW06IGZ1bmN0aW9uIChzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIChzdHJpbmcgfHwgIiIpLnJlcGxhY2Uoc3RyaW5nVHJpbVJlZ2V4LCAiIik7CiAgICAgICAgfSwKCiAgICAgICAgc3RyaW5nVG9rZW5pemU6IGZ1bmN0aW9uIChzdHJpbmcsIGRlbGltaXRlcikgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIHZhciB0b2tlbnMgPSAoc3RyaW5nIHx8ICIiKS5zcGxpdChkZWxpbWl0ZXIpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHRva2Vucy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciB0cmltbWVkID0ga28udXRpbHMuc3RyaW5nVHJpbSh0b2tlbnNbaV0pOwogICAgICAgICAgICAgICAgaWYgKHRyaW1tZWQgIT09ICIiKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHRyaW1tZWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAgc3RyaW5nU3RhcnRzV2l0aDogZnVuY3Rpb24gKHN0cmluZywgc3RhcnRzV2l0aCkgewogICAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcgfHwgIiI7CiAgICAgICAgICAgIGlmIChzdGFydHNXaXRoLmxlbmd0aCA+IHN0cmluZy5sZW5ndGgpCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmcuc3Vic3RyaW5nKDAsIHN0YXJ0c1dpdGgubGVuZ3RoKSA9PT0gc3RhcnRzV2l0aDsKICAgICAgICB9LAoKICAgICAgICBidWlsZEV2YWxXaXRoaW5TY29wZUZ1bmN0aW9uOiBmdW5jdGlvbiAoZXhwcmVzc2lvbiwgc2NvcGVMZXZlbHMpIHsKICAgICAgICAgICAgLy8gQnVpbGQgdGhlIHNvdXJjZSBmb3IgYSBmdW5jdGlvbiB0aGF0IGV2YWx1YXRlcyAiZXhwcmVzc2lvbiIKICAgICAgICAgICAgLy8gRm9yIGVhY2ggc2NvcGUgdmFyaWFibGUsIGFkZCBhbiBleHRyYSBsZXZlbCBvZiAid2l0aCIgbmVzdGluZwogICAgICAgICAgICAvLyBFeGFtcGxlIHJlc3VsdDogd2l0aChzY1sxXSkgeyB3aXRoKHNjWzBdKSB7IHJldHVybiAoZXhwcmVzc2lvbikgfSB9CiAgICAgICAgICAgIHZhciBmdW5jdGlvbkJvZHkgPSAicmV0dXJuICgiICsgZXhwcmVzc2lvbiArICIpIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzY29wZUxldmVsczsgaSsrKSB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbkJvZHkgPSAid2l0aChzY1siICsgaSArICJdKSB7ICIgKyBmdW5jdGlvbkJvZHkgKyAiIH0gIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCJzYyIsIGZ1bmN0aW9uQm9keSk7CiAgICAgICAgfSwKCiAgICAgICAgZG9tTm9kZUlzQ29udGFpbmVkQnk6IGZ1bmN0aW9uIChub2RlLCBjb250YWluZWRCeU5vZGUpIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lZEJ5Tm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikKICAgICAgICAgICAgICAgIHJldHVybiAoY29udGFpbmVkQnlOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpID09IDE2OwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PSBjb250YWluZWRCeU5vZGUpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICBkb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQ6IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21Ob2RlSXNDb250YWluZWRCeShub2RlLCBub2RlLm93bmVyRG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIHRhZ05hbWVMb3dlcjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICAvLyBGb3IgSFRNTCBlbGVtZW50cywgdGFnTmFtZSB3aWxsIGFsd2F5cyBiZSB1cHBlciBjYXNlOyBmb3IgWEhUTUwgZWxlbWVudHMsIGl0J2xsIGJlIGxvd2VyIGNhc2UuCiAgICAgICAgICAgIC8vIFBvc3NpYmxlIGZ1dHVyZSBvcHRpbWl6YXRpb246IElmIHdlIGtub3cgaXQncyBhbiBlbGVtZW50IGZyb20gYW4gWEhUTUwgZG9jdW1lbnQgKG5vdCBIVE1MKSwKICAgICAgICAgICAgLy8gd2UgZG9uJ3QgbmVlZCB0byBkbyB0aGUgLnRvTG93ZXJDYXNlKCkgYXMgaXQgd2lsbCBhbHdheXMgYmUgbG93ZXIgY2FzZSBhbnl3YXkuCiAgICAgICAgICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQudGFnTmFtZSAmJiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICB9LAoKICAgICAgICByZWdpc3RlckV2ZW50SGFuZGxlcjogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50VHlwZSwgaGFuZGxlcikgewogICAgICAgICAgICB2YXIgbXVzdFVzZUF0dGFjaEV2ZW50ID0gaWVWZXJzaW9uICYmIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudFtldmVudFR5cGVdOwogICAgICAgICAgICBpZiAoIW11c3RVc2VBdHRhY2hFdmVudCAmJiB0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRm9yIGNsaWNrIGV2ZW50cyBvbiBjaGVja2JveGVzLCBqUXVlcnkgaW50ZXJmZXJlcyB3aXRoIHRoZSBldmVudCBoYW5kbGluZyBpbiBhbiBhd2t3YXJkIHdheToKICAgICAgICAgICAgICAgICAgICAvLyBpdCB0b2dnbGVzIHRoZSBlbGVtZW50IGNoZWNrZWQgc3RhdGUgKmFmdGVyKiB0aGUgY2xpY2sgZXZlbnQgaGFuZGxlcnMgcnVuLCB3aGVyZWFzIG5hdGl2ZQogICAgICAgICAgICAgICAgICAgIC8vIGNsaWNrIGV2ZW50cyB0b2dnbGUgdGhlIGNoZWNrZWQgc3RhdGUgKmJlZm9yZSogdGhlIGV2ZW50IGhhbmRsZXIuCiAgICAgICAgICAgICAgICAgICAgLy8gRml4IHRoaXMgYnkgaW50ZWNlcHRpbmcgdGhlIGhhbmRsZXIgYW5kIGFwcGx5aW5nIHRoZSBjb3JyZWN0IGNoZWNrZWRuZXNzIGJlZm9yZSBpdCBydW5zLgogICAgICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEhhbmRsZXIgPSBoYW5kbGVyOwogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZXZlbnREYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqUXVlcnlTdXBwbGllZENoZWNrZWRTdGF0ZSA9IHRoaXMuY2hlY2tlZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50RGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IGV2ZW50RGF0YS5jaGVja2VkU3RhdGVCZWZvcmVFdmVudCAhPT0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxIYW5kbGVyLmNhbGwodGhpcywgZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrZWQgPSBqUXVlcnlTdXBwbGllZENoZWNrZWRTdGF0ZTsgLy8gUmVzdG9yZSB0aGUgc3RhdGUgalF1ZXJ5IGFwcGxpZWQKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW1lbnQpWydiaW5kJ10oZXZlbnRUeXBlLCBoYW5kbGVyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghbXVzdFVzZUF0dGFjaEV2ZW50ICYmIHR5cGVvZiBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQuYXR0YWNoRXZlbnQgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KCJvbiIgKyBldmVudFR5cGUsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBhZGRFdmVudExpc3RlbmVyIG9yIGF0dGFjaEV2ZW50Iik7CiAgICAgICAgfSwKCiAgICAgICAgdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIGlmICghKGVsZW1lbnQgJiYgZWxlbWVudC5ub2RlVHlwZSkpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImVsZW1lbnQgbXVzdCBiZSBhIERPTSBub2RlIHdoZW4gY2FsbGluZyB0cmlnZ2VyRXZlbnQiKTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnREYXRhID0gW107CiAgICAgICAgICAgICAgICBpZiAoaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV29yayBhcm91bmQgdGhlIGpRdWVyeSAiY2xpY2sgZXZlbnRzIG9uIGNoZWNrYm94ZXMiIGlzc3VlIGRlc2NyaWJlZCBhYm92ZSBieSBzdG9yaW5nIHRoZSBvcmlnaW5hbCBjaGVja2VkIHN0YXRlIGJlZm9yZSB0cmlnZ2VyaW5nIHRoZSBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgZXZlbnREYXRhLnB1c2goeyBjaGVja2VkU3RhdGVCZWZvcmVFdmVudDogZWxlbWVudC5jaGVja2VkIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW1lbnQpWyd0cmlnZ2VyJ10oZXZlbnRUeXBlLCBldmVudERhdGEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFdmVudCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQuZGlzcGF0Y2hFdmVudCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50Q2F0ZWdvcnkgPSBrbm93bkV2ZW50VHlwZXNCeUV2ZW50TmFtZVtldmVudFR5cGVdIHx8ICJIVE1MRXZlbnRzIjsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChldmVudENhdGVnb3J5KTsKICAgICAgICAgICAgICAgICAgICBldmVudC5pbml0RXZlbnQoZXZlbnRUeXBlLCB0cnVlLCB0cnVlLCB3aW5kb3csIDAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHN1cHBsaWVkIGVsZW1lbnQgZG9lc24ndCBzdXBwb3J0IGRpc3BhdGNoRXZlbnQiKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZWxlbWVudC5maXJlRXZlbnQgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIC8vIFVubGlrZSBvdGhlciBicm93c2VycywgSUUgZG9lc24ndCBjaGFuZ2UgdGhlIGNoZWNrZWQgc3RhdGUgb2YgY2hlY2tib3hlcy9yYWRpb2J1dHRvbnMgd2hlbiB5b3UgdHJpZ2dlciB0aGVpciAiY2xpY2siIGV2ZW50CiAgICAgICAgICAgICAgICAvLyBzbyB0byBtYWtlIGl0IGNvbnNpc3RlbnQsIHdlJ2xsIGRvIGl0IG1hbnVhbGx5IGhlcmUKICAgICAgICAgICAgICAgIGlmIChpc0NsaWNrT25DaGVja2FibGVFbGVtZW50KGVsZW1lbnQsIGV2ZW50VHlwZSkpCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gZWxlbWVudC5jaGVja2VkICE9PSB0cnVlOwogICAgICAgICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoIm9uIiArIGV2ZW50VHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCB0cmlnZ2VyaW5nIGV2ZW50cyIpOwogICAgICAgIH0sCgogICAgICAgIHVud3JhcE9ic2VydmFibGU6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4ga28uaXNPYnNlcnZhYmxlKHZhbHVlKSA/IHZhbHVlKCkgOiB2YWx1ZTsKICAgICAgICB9LAoKICAgICAgICB0b2dnbGVEb21Ob2RlQ3NzQ2xhc3M6IGZ1bmN0aW9uIChub2RlLCBjbGFzc05hbWUsIHNob3VsZEhhdmVDbGFzcykgewogICAgICAgICAgICB2YXIgY3VycmVudENsYXNzTmFtZXMgPSAobm9kZS5jbGFzc05hbWUgfHwgIiIpLnNwbGl0KC9ccysvKTsKICAgICAgICAgICAgdmFyIGhhc0NsYXNzID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGN1cnJlbnRDbGFzc05hbWVzLCBjbGFzc05hbWUpID49IDA7CgogICAgICAgICAgICBpZiAoc2hvdWxkSGF2ZUNsYXNzICYmICFoYXNDbGFzcykgewogICAgICAgICAgICAgICAgbm9kZS5jbGFzc05hbWUgKz0gKGN1cnJlbnRDbGFzc05hbWVzWzBdID8gIiAiIDogIiIpICsgY2xhc3NOYW1lOwogICAgICAgICAgICB9IGVsc2UgaWYgKGhhc0NsYXNzICYmICFzaG91bGRIYXZlQ2xhc3MpIHsKICAgICAgICAgICAgICAgIHZhciBuZXdDbGFzc05hbWUgPSAiIjsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY3VycmVudENsYXNzTmFtZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRDbGFzc05hbWVzW2ldICE9IGNsYXNzTmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgbmV3Q2xhc3NOYW1lICs9IGN1cnJlbnRDbGFzc05hbWVzW2ldICsgIiAiOwogICAgICAgICAgICAgICAgbm9kZS5jbGFzc05hbWUgPSBrby51dGlscy5zdHJpbmdUcmltKG5ld0NsYXNzTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXRUZXh0Q29udGVudDogZnVuY3Rpb24oZWxlbWVudCwgdGV4dENvbnRlbnQpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh0ZXh0Q29udGVudCk7CiAgICAgICAgICAgIGlmICgodmFsdWUgPT09IG51bGwpIHx8ICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSkKICAgICAgICAgICAgICAgIHZhbHVlID0gIiI7CgogICAgICAgICAgICAnaW5uZXJUZXh0JyBpbiBlbGVtZW50ID8gZWxlbWVudC5pbm5lclRleHQgPSB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogZWxlbWVudC50ZXh0Q29udGVudCA9IHZhbHVlOwoKICAgICAgICAgICAgaWYgKGllVmVyc2lvbiA+PSA5KSB7CiAgICAgICAgICAgICAgICAvLyBCZWxpZXZlIGl0IG9yIG5vdCwgdGhpcyBhY3R1YWxseSBmaXhlcyBhbiBJRTkgcmVuZGVyaW5nIGJ1ZwogICAgICAgICAgICAgICAgLy8gKFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzIwOSkKICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IGVsZW1lbnQuc3R5bGUuZGlzcGxheTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGVuc3VyZVNlbGVjdEVsZW1lbnRJc1JlbmRlcmVkQ29ycmVjdGx5OiBmdW5jdGlvbihzZWxlY3RFbGVtZW50KSB7CiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFOSByZW5kZXJpbmcgYnVnIC0gaXQgZG9lc24ndCByZWxpYWJseSBkaXNwbGF5IGFsbCB0aGUgdGV4dCBpbiBkeW5hbWljYWxseS1hZGRlZCBzZWxlY3QgYm94ZXMgdW5sZXNzIHlvdSBmb3JjZSBpdCB0byByZS1yZW5kZXIgYnkgdXBkYXRpbmcgdGhlIHdpZHRoLgogICAgICAgICAgICAvLyAoU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMzEyLCBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzU5MDg0OTQvc2VsZWN0LW9ubHktc2hvd3MtZmlyc3QtY2hhci1vZi1zZWxlY3RlZC1vcHRpb24pCiAgICAgICAgICAgIGlmIChpZVZlcnNpb24gPj0gOSkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsV2lkdGggPSBzZWxlY3RFbGVtZW50LnN0eWxlLndpZHRoOwogICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5zdHlsZS53aWR0aCA9IDA7CiAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnN0eWxlLndpZHRoID0gb3JpZ2luYWxXaWR0aDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHJhbmdlOiBmdW5jdGlvbiAobWluLCBtYXgpIHsKICAgICAgICAgICAgbWluID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtaW4pOwogICAgICAgICAgICBtYXggPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG1heCk7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IG1pbjsgaSA8PSBtYXg7IGkrKykKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGkpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIG1ha2VBcnJheTogZnVuY3Rpb24oYXJyYXlMaWtlT2JqZWN0KSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheUxpa2VPYmplY3QubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChhcnJheUxpa2VPYmplY3RbaV0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIGlzSWU2IDogaXNJZTYsCiAgICAgICAgaXNJZTcgOiBpc0llNywKICAgICAgICBpZVZlcnNpb24gOiBpZVZlcnNpb24sCgogICAgICAgIGdldEZvcm1GaWVsZHM6IGZ1bmN0aW9uKGZvcm0sIGZpZWxkTmFtZSkgewogICAgICAgICAgICB2YXIgZmllbGRzID0ga28udXRpbHMubWFrZUFycmF5KGZvcm0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoImlucHV0IikpLmNvbmNhdChrby51dGlscy5tYWtlQXJyYXkoZm9ybS5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGV4dGFyZWEiKSkpOwogICAgICAgICAgICB2YXIgaXNNYXRjaGluZ0ZpZWxkID0gKHR5cGVvZiBmaWVsZE5hbWUgPT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uKGZpZWxkKSB7IHJldHVybiBmaWVsZC5uYW1lID09PSBmaWVsZE5hbWUgfQogICAgICAgICAgICAgICAgOiBmdW5jdGlvbihmaWVsZCkgeyByZXR1cm4gZmllbGROYW1lLnRlc3QoZmllbGQubmFtZSkgfTsgLy8gVHJlYXQgZmllbGROYW1lIGFzIHJlZ2V4IG9yIG9iamVjdCBjb250YWluaW5nIHByZWRpY2F0ZQogICAgICAgICAgICB2YXIgbWF0Y2hlcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gZmllbGRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaGluZ0ZpZWxkKGZpZWxkc1tpXSkpCiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKGZpZWxkc1tpXSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBtYXRjaGVzOwogICAgICAgIH0sCgogICAgICAgIHBhcnNlSnNvbjogZnVuY3Rpb24gKGpzb25TdHJpbmcpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBqc29uU3RyaW5nID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBqc29uU3RyaW5nID0ga28udXRpbHMuc3RyaW5nVHJpbShqc29uU3RyaW5nKTsKICAgICAgICAgICAgICAgIGlmIChqc29uU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5KU09OICYmIHdpbmRvdy5KU09OLnBhcnNlKSAvLyBVc2UgbmF0aXZlIHBhcnNpbmcgd2hlcmUgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aW5kb3cuSlNPTi5wYXJzZShqc29uU3RyaW5nKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKG5ldyBGdW5jdGlvbigicmV0dXJuICIgKyBqc29uU3RyaW5nKSkoKTsgLy8gRmFsbGJhY2sgb24gbGVzcyBzYWZlIHBhcnNpbmcgZm9yIG9sZGVyIGJyb3dzZXJzCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgc3RyaW5naWZ5SnNvbjogZnVuY3Rpb24gKGRhdGEsIHJlcGxhY2VyLCBzcGFjZSkgeyAgIC8vIHJlcGxhY2VyIGFuZCBzcGFjZSBhcmUgb3B0aW9uYWwKICAgICAgICAgICAgaWYgKCh0eXBlb2YgSlNPTiA9PSAidW5kZWZpbmVkIikgfHwgKHR5cGVvZiBKU09OLnN0cmluZ2lmeSA9PSAidW5kZWZpbmVkIikpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIEpTT04uc3RyaW5naWZ5KCkuIFNvbWUgYnJvd3NlcnMgKGUuZy4sIElFIDwgOCkgZG9uJ3Qgc3VwcG9ydCBpdCBuYXRpdmVseSwgYnV0IHlvdSBjYW4gb3ZlcmNvbWUgdGhpcyBieSBhZGRpbmcgYSBzY3JpcHQgcmVmZXJlbmNlIHRvIGpzb24yLmpzLCBkb3dubG9hZGFibGUgZnJvbSBodHRwOi8vd3d3Lmpzb24ub3JnL2pzb24yLmpzIik7CiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGEpLCByZXBsYWNlciwgc3BhY2UpOwogICAgICAgIH0sCgogICAgICAgIHBvc3RKc29uOiBmdW5jdGlvbiAodXJsT3JGb3JtLCBkYXRhLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICB2YXIgcGFyYW1zID0gb3B0aW9uc1sncGFyYW1zJ10gfHwge307CiAgICAgICAgICAgIHZhciBpbmNsdWRlRmllbGRzID0gb3B0aW9uc1snaW5jbHVkZUZpZWxkcyddIHx8IHRoaXMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3Q7CiAgICAgICAgICAgIHZhciB1cmwgPSB1cmxPckZvcm07CgogICAgICAgICAgICAvLyBJZiB3ZSB3ZXJlIGdpdmVuIGEgZm9ybSwgdXNlIGl0cyAnYWN0aW9uJyBVUkwgYW5kIHBpY2sgb3V0IGFueSByZXF1ZXN0ZWQgZmllbGQgdmFsdWVzCiAgICAgICAgICAgIGlmKCh0eXBlb2YgdXJsT3JGb3JtID09ICdvYmplY3QnKSAmJiAoa28udXRpbHMudGFnTmFtZUxvd2VyKHVybE9yRm9ybSkgPT09ICJmb3JtIikpIHsKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEZvcm0gPSB1cmxPckZvcm07CiAgICAgICAgICAgICAgICB1cmwgPSBvcmlnaW5hbEZvcm0uYWN0aW9uOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGluY2x1ZGVGaWVsZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmllbGRzID0ga28udXRpbHMuZ2V0Rm9ybUZpZWxkcyhvcmlnaW5hbEZvcm0sIGluY2x1ZGVGaWVsZHNbaV0pOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSBmaWVsZHMubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0pCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtc1tmaWVsZHNbal0ubmFtZV0gPSBmaWVsZHNbal0udmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRhdGEgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGEpOwogICAgICAgICAgICB2YXIgZm9ybSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImZvcm0iKTsKICAgICAgICAgICAgZm9ybS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICBmb3JtLmFjdGlvbiA9IHVybDsKICAgICAgICAgICAgZm9ybS5tZXRob2QgPSAicG9zdCI7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgICAgICAgICAgaW5wdXQubmFtZSA9IGtleTsKICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0ga28udXRpbHMuc3RyaW5naWZ5SnNvbihrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGFba2V5XSkpOwogICAgICAgICAgICAgICAgZm9ybS5hcHBlbmRDaGlsZChpbnB1dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHBhcmFtcykgewogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICAgICAgICAgIGlucHV0Lm5hbWUgPSBrZXk7CiAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IHBhcmFtc1trZXldOwogICAgICAgICAgICAgICAgZm9ybS5hcHBlbmRDaGlsZChpbnB1dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmb3JtKTsKICAgICAgICAgICAgb3B0aW9uc1snc3VibWl0dGVyJ10gPyBvcHRpb25zWydzdWJtaXR0ZXInXShmb3JtKSA6IGZvcm0uc3VibWl0KCk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyBmb3JtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZm9ybSk7IH0sIDApOwogICAgICAgIH0KICAgIH0KfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMnLCBrby51dGlscyk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGb3JFYWNoJywga28udXRpbHMuYXJyYXlGb3JFYWNoKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUZpcnN0Jywga28udXRpbHMuYXJyYXlGaXJzdCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGaWx0ZXInLCBrby51dGlscy5hcnJheUZpbHRlcik7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlHZXREaXN0aW5jdFZhbHVlcycsIGtvLnV0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5SW5kZXhPZicsIGtvLnV0aWxzLmFycmF5SW5kZXhPZik7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlNYXAnLCBrby51dGlscy5hcnJheU1hcCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlQdXNoQWxsJywga28udXRpbHMuYXJyYXlQdXNoQWxsKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheVJlbW92ZUl0ZW0nLCBrby51dGlscy5hcnJheVJlbW92ZUl0ZW0pOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmV4dGVuZCcsIGtvLnV0aWxzLmV4dGVuZCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3QnLCBrby51dGlscy5maWVsZHNJbmNsdWRlZFdpdGhKc29uUG9zdCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZ2V0Rm9ybUZpZWxkcycsIGtvLnV0aWxzLmdldEZvcm1GaWVsZHMpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnBvc3RKc29uJywga28udXRpbHMucG9zdEpzb24pOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnBhcnNlSnNvbicsIGtvLnV0aWxzLnBhcnNlSnNvbik7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXInLCBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcik7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuc3RyaW5naWZ5SnNvbicsIGtvLnV0aWxzLnN0cmluZ2lmeUpzb24pOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnJhbmdlJywga28udXRpbHMucmFuZ2UpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcycsIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMudHJpZ2dlckV2ZW50Jywga28udXRpbHMudHJpZ2dlckV2ZW50KTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy51bndyYXBPYnNlcnZhYmxlJywga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSk7CgppZiAoIUZ1bmN0aW9uLnByb3RvdHlwZVsnYmluZCddKSB7CiAgICAvLyBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCBpcyBhIHN0YW5kYXJkIHBhcnQgb2YgRUNNQVNjcmlwdCA1dGggRWRpdGlvbiAoRGVjZW1iZXIgMjAwOSwgaHR0cDovL3d3dy5lY21hLWludGVybmF0aW9uYWwub3JnL3B1YmxpY2F0aW9ucy9maWxlcy9FQ01BLVNUL0VDTUEtMjYyLnBkZikKICAgIC8vIEluIGNhc2UgdGhlIGJyb3dzZXIgZG9lc24ndCBpbXBsZW1lbnQgaXQgbmF0aXZlbHksIHByb3ZpZGUgYSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uLiBUaGlzIGltcGxlbWVudGF0aW9uIGlzIGJhc2VkIG9uIHRoZSBvbmUgaW4gcHJvdG90eXBlLmpzCiAgICBGdW5jdGlvbi5wcm90b3R5cGVbJ2JpbmQnXSA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgICB2YXIgb3JpZ2luYWxGdW5jdGlvbiA9IHRoaXMsIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLCBvYmplY3QgPSBhcmdzLnNoaWZ0KCk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsRnVuY3Rpb24uYXBwbHkob2JqZWN0LCBhcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgfTsKICAgIH07Cn0KCmtvLnV0aWxzLmRvbURhdGEgPSBuZXcgKGZ1bmN0aW9uICgpIHsKICAgIHZhciB1bmlxdWVJZCA9IDA7CiAgICB2YXIgZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZSA9ICJfX2tvX18iICsgKG5ldyBEYXRlKS5nZXRUaW1lKCk7CiAgICB2YXIgZGF0YVN0b3JlID0ge307CiAgICByZXR1cm4gewogICAgICAgIGdldDogZnVuY3Rpb24gKG5vZGUsIGtleSkgewogICAgICAgICAgICB2YXIgYWxsRGF0YUZvck5vZGUgPSBrby51dGlscy5kb21EYXRhLmdldEFsbChub2RlLCBmYWxzZSk7CiAgICAgICAgICAgIHJldHVybiBhbGxEYXRhRm9yTm9kZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogYWxsRGF0YUZvck5vZGVba2V5XTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gKG5vZGUsIGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCBhY3R1YWxseSBjcmVhdGUgYSBuZXcgZG9tRGF0YSBrZXkgaWYgd2UgYXJlIGFjdHVhbGx5IGRlbGV0aW5nIGEgdmFsdWUKICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5kb21EYXRhLmdldEFsbChub2RlLCBmYWxzZSkgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFsbERhdGFGb3JOb2RlID0ga28udXRpbHMuZG9tRGF0YS5nZXRBbGwobm9kZSwgdHJ1ZSk7CiAgICAgICAgICAgIGFsbERhdGFGb3JOb2RlW2tleV0gPSB2YWx1ZTsKICAgICAgICB9LAogICAgICAgIGdldEFsbDogZnVuY3Rpb24gKG5vZGUsIGNyZWF0ZUlmTm90Rm91bmQpIHsKICAgICAgICAgICAgdmFyIGRhdGFTdG9yZUtleSA9IG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV07CiAgICAgICAgICAgIHZhciBoYXNFeGlzdGluZ0RhdGFTdG9yZSA9IGRhdGFTdG9yZUtleSAmJiAoZGF0YVN0b3JlS2V5ICE9PSAibnVsbCIpOwogICAgICAgICAgICBpZiAoIWhhc0V4aXN0aW5nRGF0YVN0b3JlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWNyZWF0ZUlmTm90Rm91bmQpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGRhdGFTdG9yZUtleSA9IG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV0gPSAia28iICsgdW5pcXVlSWQrKzsKICAgICAgICAgICAgICAgIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldID0ge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRhdGFTdG9yZVtkYXRhU3RvcmVLZXldOwogICAgICAgIH0sCiAgICAgICAgY2xlYXI6IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHZhciBkYXRhU3RvcmVLZXkgPSBub2RlW2RhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICBpZiAoZGF0YVN0b3JlS2V5KSB7CiAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVN0b3JlW2RhdGFTdG9yZUtleV07CiAgICAgICAgICAgICAgICBub2RlW2RhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tRGF0YScsIGtvLnV0aWxzLmRvbURhdGEpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbURhdGEuY2xlYXInLCBrby51dGlscy5kb21EYXRhLmNsZWFyKTsgLy8gRXhwb3J0aW5nIG9ubHkgc28gc3BlY3MgY2FuIGNsZWFyIHVwIGFmdGVyIHRoZW1zZWx2ZXMgZnVsbHkKCmtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbCA9IG5ldyAoZnVuY3Rpb24gKCkgewogICAgdmFyIGRvbURhdGFLZXkgPSAiX19rb19kb21Ob2RlRGlzcG9zYWxfXyIgKyAobmV3IERhdGUpLmdldFRpbWUoKTsKICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXMgPSB7IDE6IHRydWUsIDg6IHRydWUsIDk6IHRydWUgfTsgICAgICAgLy8gRWxlbWVudCwgQ29tbWVudCwgRG9jdW1lbnQKICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXNXaXRoRGVzY2VuZGFudHMgPSB7IDE6IHRydWUsIDk6IHRydWUgfTsgLy8gRWxlbWVudCwgRG9jdW1lbnQKCiAgICBmdW5jdGlvbiBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBjcmVhdGVJZk5vdEZvdW5kKSB7CiAgICAgICAgdmFyIGFsbERpc3Bvc2VDYWxsYmFja3MgPSBrby51dGlscy5kb21EYXRhLmdldChub2RlLCBkb21EYXRhS2V5KTsKICAgICAgICBpZiAoKGFsbERpc3Bvc2VDYWxsYmFja3MgPT09IHVuZGVmaW5lZCkgJiYgY3JlYXRlSWZOb3RGb3VuZCkgewogICAgICAgICAgICBhbGxEaXNwb3NlQ2FsbGJhY2tzID0gW107CiAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGRvbURhdGFLZXksIGFsbERpc3Bvc2VDYWxsYmFja3MpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWxsRGlzcG9zZUNhbGxiYWNrczsKICAgIH0KICAgIGZ1bmN0aW9uIGRlc3Ryb3lDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUpIHsKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChub2RlLCBkb21EYXRhS2V5LCB1bmRlZmluZWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFuU2luZ2xlTm9kZShub2RlKSB7CiAgICAgICAgLy8gUnVuIGFsbCB0aGUgZGlzcG9zZSBjYWxsYmFja3MKICAgICAgICB2YXIgY2FsbGJhY2tzID0gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgZmFsc2UpOwogICAgICAgIGlmIChjYWxsYmFja3MpIHsKICAgICAgICAgICAgY2FsbGJhY2tzID0gY2FsbGJhY2tzLnNsaWNlKDApOyAvLyBDbG9uZSwgYXMgdGhlIGFycmF5IG1heSBiZSBtb2RpZmllZCBkdXJpbmcgaXRlcmF0aW9uICh0eXBpY2FsbHksIGNhbGxiYWNrcyB3aWxsIHJlbW92ZSB0aGVtc2VsdmVzKQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXShub2RlKTsKICAgICAgICB9CgogICAgICAgIC8vIEFsc28gZXJhc2UgdGhlIERPTSBkYXRhCiAgICAgICAga28udXRpbHMuZG9tRGF0YS5jbGVhcihub2RlKTsKCiAgICAgICAgLy8gU3BlY2lhbCBzdXBwb3J0IGZvciBqUXVlcnkgaGVyZSBiZWNhdXNlIGl0J3Mgc28gY29tbW9ubHkgdXNlZC4KICAgICAgICAvLyBNYW55IGpRdWVyeSBwbHVnaW5zIChpbmNsdWRpbmcganF1ZXJ5LnRtcGwpIHN0b3JlIGRhdGEgdXNpbmcgalF1ZXJ5J3MgZXF1aXZhbGVudCBvZiBkb21EYXRhCiAgICAgICAgLy8gc28gbm90aWZ5IGl0IHRvIHRlYXIgZG93biBhbnkgcmVzb3VyY2VzIGFzc29jaWF0ZWQgd2l0aCB0aGUgbm9kZSAmIGRlc2NlbmRhbnRzIGhlcmUuCiAgICAgICAgaWYgKCh0eXBlb2YgalF1ZXJ5ID09ICJmdW5jdGlvbiIpICYmICh0eXBlb2YgalF1ZXJ5WydjbGVhbkRhdGEnXSA9PSAiZnVuY3Rpb24iKSkKICAgICAgICAgICAgalF1ZXJ5WydjbGVhbkRhdGEnXShbbm9kZV0pOwoKICAgICAgICAvLyBBbHNvIGNsZWFyIGFueSBpbW1lZGlhdGUtY2hpbGQgY29tbWVudCBub2RlcywgYXMgdGhlc2Ugd291bGRuJ3QgaGF2ZSBiZWVuIGZvdW5kIGJ5CiAgICAgICAgLy8gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIGluIGNsZWFuTm9kZSgpIChjb21tZW50IG5vZGVzIGFyZW4ndCBlbGVtZW50cykKICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKQogICAgICAgICAgICBjbGVhbkltbWVkaWF0ZUNvbW1lbnRUeXBlQ2hpbGRyZW4obm9kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYW5JbW1lZGlhdGVDb21tZW50VHlwZUNoaWxkcmVuKG5vZGVXaXRoQ2hpbGRyZW4pIHsKICAgICAgICB2YXIgY2hpbGQsIG5leHRDaGlsZCA9IG5vZGVXaXRoQ2hpbGRyZW4uZmlyc3RDaGlsZDsKICAgICAgICB3aGlsZSAoY2hpbGQgPSBuZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkID0gY2hpbGQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIGlmIChjaGlsZC5ub2RlVHlwZSA9PT0gOCkKICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShjaGlsZCk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgYWRkRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYWxsYmFjayBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICAgICAgZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgdHJ1ZSkucHVzaChjYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrc0NvbGxlY3Rpb24gPSBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBmYWxzZSk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja3NDb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVJlbW92ZUl0ZW0oY2FsbGJhY2tzQ29sbGVjdGlvbiwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc0NvbGxlY3Rpb24ubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICAgICAgZGVzdHJveUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBjbGVhbk5vZGUgOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIC8vIEZpcnN0IGNsZWFuIHRoaXMgbm9kZSwgd2hlcmUgYXBwbGljYWJsZQogICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzW25vZGUubm9kZVR5cGVdKSB7CiAgICAgICAgICAgICAgICBjbGVhblNpbmdsZU5vZGUobm9kZSk7CgogICAgICAgICAgICAgICAgLy8gLi4uIHRoZW4gaXRzIGRlc2NlbmRhbnRzLCB3aGVyZSBhcHBsaWNhYmxlCiAgICAgICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xvbmUgdGhlIGRlc2NlbmRhbnRzIGxpc3QgaW4gY2FzZSBpdCBjaGFuZ2VzIGR1cmluZyBpdGVyYXRpb24KICAgICAgICAgICAgICAgICAgICB2YXIgZGVzY2VuZGFudHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZGVzY2VuZGFudHMsIG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBkZXNjZW5kYW50cy5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShkZXNjZW5kYW50c1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICByZW1vdmVOb2RlIDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBrby5jbGVhbk5vZGUobm9kZSk7CiAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7CiAgICAgICAgfQogICAgfQp9KSgpOwprby5jbGVhbk5vZGUgPSBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuY2xlYW5Ob2RlOyAvLyBTaG9ydGhhbmQgbmFtZSBmb3IgY29udmVuaWVuY2UKa28ucmVtb3ZlTm9kZSA9IGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVOb2RlOyAvLyBTaG9ydGhhbmQgbmFtZSBmb3IgY29udmVuaWVuY2UKa28uZXhwb3J0U3ltYm9sKCdjbGVhbk5vZGUnLCBrby5jbGVhbk5vZGUpOwprby5leHBvcnRTeW1ib2woJ3JlbW92ZU5vZGUnLCBrby5yZW1vdmVOb2RlKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwnLCBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbU5vZGVEaXNwb3NhbC5hZGREaXNwb3NlQ2FsbGJhY2snLCBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlRGlzcG9zZUNhbGxiYWNrJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjayk7CihmdW5jdGlvbiAoKSB7CiAgICB2YXIgbGVhZGluZ0NvbW1lbnRSZWdleCA9IC9eKFxzKik8IS0tKC4qPyktLT4vOwoKICAgIGZ1bmN0aW9uIHNpbXBsZUh0bWxQYXJzZShodG1sKSB7CiAgICAgICAgLy8gQmFzZWQgb24galF1ZXJ5J3MgImNsZWFuIiBmdW5jdGlvbiwgYnV0IG9ubHkgYWNjb3VudGluZyBmb3IgdGFibGUtcmVsYXRlZCBlbGVtZW50cy4KICAgICAgICAvLyBJZiB5b3UgaGF2ZSByZWZlcmVuY2VkIGpRdWVyeSwgdGhpcyB3b24ndCBiZSB1c2VkIGFueXdheSAtIEtPIHdpbGwgdXNlIGpRdWVyeSdzICJjbGVhbiIgZnVuY3Rpb24gZGlyZWN0bHkKCiAgICAgICAgLy8gTm90ZSB0aGF0IHRoZXJlJ3Mgc3RpbGwgYW4gaXNzdWUgaW4gSUUgPCA5IHdoZXJlYnkgaXQgd2lsbCBkaXNjYXJkIGNvbW1lbnQgbm9kZXMgdGhhdCBhcmUgdGhlIGZpcnN0IGNoaWxkIG9mCiAgICAgICAgLy8gYSBkZXNjZW5kYW50IG5vZGUuIEZvciBleGFtcGxlOiAiPGRpdj48IS0tIG15Y29tbWVudCAtLT5hYmM8L2Rpdj4iIHdpbGwgZ2V0IHBhcnNlZCBhcyAiPGRpdj5hYmM8L2Rpdj4iCiAgICAgICAgLy8gVGhpcyB3b24ndCBhZmZlY3QgYW55b25lIHdobyBoYXMgcmVmZXJlbmNlZCBqUXVlcnksIGFuZCB0aGVyZSdzIGFsd2F5cyB0aGUgd29ya2Fyb3VuZCBvZiBpbnNlcnRpbmcgYSBkdW1teSBub2RlCiAgICAgICAgLy8gKHBvc3NpYmx5IGEgdGV4dCBub2RlKSBpbiBmcm9udCBvZiB0aGUgY29tbWVudC4gU28sIEtPIGRvZXMgbm90IGF0dGVtcHQgdG8gd29ya2Fyb3VuZCB0aGlzIElFIGlzc3VlIGF1dG9tYXRpY2FsbHkgYXQgcHJlc2VudC4KCiAgICAgICAgLy8gVHJpbSB3aGl0ZXNwYWNlLCBvdGhlcndpc2UgaW5kZXhPZiB3b24ndCB3b3JrIGFzIGV4cGVjdGVkCiAgICAgICAgdmFyIHRhZ3MgPSBrby51dGlscy5zdHJpbmdUcmltKGh0bWwpLnRvTG93ZXJDYXNlKCksIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKICAgICAgICAvLyBGaW5kcyB0aGUgZmlyc3QgbWF0Y2ggZnJvbSB0aGUgbGVmdCBjb2x1bW4sIGFuZCByZXR1cm5zIHRoZSBjb3JyZXNwb25kaW5nICJ3cmFwIiBkYXRhIGZyb20gdGhlIHJpZ2h0IGNvbHVtbgogICAgICAgIHZhciB3cmFwID0gdGFncy5tYXRjaCgvXjwodGhlYWR8dGJvZHl8dGZvb3QpLykgICAgICAgICAgICAgICYmIFsxLCAiPHRhYmxlPiIsICI8L3RhYmxlPiJdIHx8CiAgICAgICAgICAgICAgICAgICAhdGFncy5pbmRleE9mKCI8dHIiKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgWzIsICI8dGFibGU+PHRib2R5PiIsICI8L3Rib2R5PjwvdGFibGU+Il0gfHwKICAgICAgICAgICAgICAgICAgICghdGFncy5pbmRleE9mKCI8dGQiKSB8fCAhdGFncy5pbmRleE9mKCI8dGgiKSkgICAmJiBbMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iXSB8fAogICAgICAgICAgICAgICAgICAgLyogYW55dGhpbmcgZWxzZSAqLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFswLCAiIiwgIiJdOwoKICAgICAgICAvLyBHbyB0byBodG1sIGFuZCBiYWNrLCB0aGVuIHBlZWwgb2ZmIGV4dHJhIHdyYXBwZXJzCiAgICAgICAgLy8gTm90ZSB0aGF0IHdlIGFsd2F5cyBwcmVmaXggd2l0aCBzb21lIGR1bW15IHRleHQsIGJlY2F1c2Ugb3RoZXJ3aXNlLCBJRTw5IHdpbGwgc3RyaXAgb3V0IGxlYWRpbmcgY29tbWVudCBub2RlcyBpbiBkZXNjZW5kYW50cy4gVG90YWwgbWFkbmVzcy4KICAgICAgICB2YXIgbWFya3VwID0gImlnbm9yZWQ8ZGl2PiIgKyB3cmFwWzFdICsgaHRtbCArIHdyYXBbMl0gKyAiPC9kaXY+IjsKICAgICAgICBpZiAodHlwZW9mIHdpbmRvd1snaW5uZXJTaGl2J10gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBkaXYuYXBwZW5kQ2hpbGQod2luZG93Wydpbm5lclNoaXYnXShtYXJrdXApKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gbWFya3VwOwogICAgICAgIH0KCiAgICAgICAgLy8gTW92ZSB0byB0aGUgcmlnaHQgZGVwdGgKICAgICAgICB3aGlsZSAod3JhcFswXS0tKQogICAgICAgICAgICBkaXYgPSBkaXYubGFzdENoaWxkOwoKICAgICAgICByZXR1cm4ga28udXRpbHMubWFrZUFycmF5KGRpdi5sYXN0Q2hpbGQuY2hpbGROb2Rlcyk7CiAgICB9CgogICAgZnVuY3Rpb24galF1ZXJ5SHRtbFBhcnNlKGh0bWwpIHsKICAgICAgICB2YXIgZWxlbXMgPSBqUXVlcnlbJ2NsZWFuJ10oW2h0bWxdKTsKCiAgICAgICAgLy8gQXMgb2YgalF1ZXJ5IDEuNy4xLCBqUXVlcnkgcGFyc2VzIHRoZSBIVE1MIGJ5IGFwcGVuZGluZyBpdCB0byBzb21lIGR1bW15IHBhcmVudCBub2RlcyBoZWxkIGluIGFuIGluLW1lbW9yeSBkb2N1bWVudCBmcmFnbWVudC4KICAgICAgICAvLyBVbmZvcnR1bmF0ZWx5LCBpdCBuZXZlciBjbGVhcnMgdGhlIGR1bW15IHBhcmVudCBub2RlcyBmcm9tIHRoZSBkb2N1bWVudCBmcmFnbWVudCwgc28gaXQgbGVha3MgbWVtb3J5IG92ZXIgdGltZS4KICAgICAgICAvLyBGaXggdGhpcyBieSBmaW5kaW5nIHRoZSB0b3AtbW9zdCBkdW1teSBwYXJlbnQgZWxlbWVudCwgYW5kIGRldGFjaGluZyBpdCBmcm9tIGl0cyBvd25lciBmcmFnbWVudC4KICAgICAgICBpZiAoZWxlbXMgJiYgZWxlbXNbMF0pIHsKICAgICAgICAgICAgLy8gRmluZCB0aGUgdG9wLW1vc3QgcGFyZW50IGVsZW1lbnQgdGhhdCdzIGEgZGlyZWN0IGNoaWxkIG9mIGEgZG9jdW1lbnQgZnJhZ21lbnQKICAgICAgICAgICAgdmFyIGVsZW0gPSBlbGVtc1swXTsKICAgICAgICAgICAgd2hpbGUgKGVsZW0ucGFyZW50Tm9kZSAmJiBlbGVtLnBhcmVudE5vZGUubm9kZVR5cGUgIT09IDExIC8qIGkuZS4sIERvY3VtZW50RnJhZ21lbnQgKi8pCiAgICAgICAgICAgICAgICBlbGVtID0gZWxlbS5wYXJlbnROb2RlOwogICAgICAgICAgICAvLyAuLi4gdGhlbiBkZXRhY2ggaXQKICAgICAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkKICAgICAgICAgICAgICAgIGVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbGVtczsKICAgIH0KCiAgICBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudCA9IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIGpRdWVyeSAhPSAndW5kZWZpbmVkJyA/IGpRdWVyeUh0bWxQYXJzZShodG1sKSAgIC8vIEFzIGJlbG93LCBiZW5lZml0IGZyb20galF1ZXJ5J3Mgb3B0aW1pc2F0aW9ucyB3aGVyZSBwb3NzaWJsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogc2ltcGxlSHRtbFBhcnNlKGh0bWwpOyAgLy8gLi4uIG90aGVyd2lzZSwgdGhpcyBzaW1wbGUgbG9naWMgd2lsbCBkbyBpbiBtb3N0IGNvbW1vbiBjYXNlcy4KICAgIH07CgogICAga28udXRpbHMuc2V0SHRtbCA9IGZ1bmN0aW9uKG5vZGUsIGh0bWwpIHsKICAgICAgICBrby51dGlscy5lbXB0eURvbU5vZGUobm9kZSk7CgogICAgICAgIGlmICgoaHRtbCAhPT0gbnVsbCkgJiYgKGh0bWwgIT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBodG1sICE9ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgaHRtbCA9IGh0bWwudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIC8vIGpRdWVyeSBjb250YWlucyBhIGxvdCBvZiBzb3BoaXN0aWNhdGVkIGNvZGUgdG8gcGFyc2UgYXJiaXRyYXJ5IEhUTUwgZnJhZ21lbnRzLAogICAgICAgICAgICAvLyBmb3IgZXhhbXBsZSA8dHI+IGVsZW1lbnRzIHdoaWNoIGFyZSBub3Qgbm9ybWFsbHkgYWxsb3dlZCB0byBleGlzdCBvbiB0aGVpciBvd24uCiAgICAgICAgICAgIC8vIElmIHlvdSd2ZSByZWZlcmVuY2VkIGpRdWVyeSB3ZSdsbCB1c2UgdGhhdCByYXRoZXIgdGhhbiBkdXBsaWNhdGluZyBpdHMgY29kZS4KICAgICAgICAgICAgaWYgKHR5cGVvZiBqUXVlcnkgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGpRdWVyeShub2RlKVsnaHRtbCddKGh0bWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gLi4uIG90aGVyd2lzZSwgdXNlIEtPJ3Mgb3duIHBhcnNpbmcgbG9naWMuCiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkTm9kZXMgPSBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudChodG1sKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyc2VkTm9kZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChwYXJzZWROb2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUh0bWxGcmFnbWVudCcsIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXRIdG1sJywga28udXRpbHMuc2V0SHRtbCk7Cgprby5tZW1vaXphdGlvbiA9IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgbWVtb3MgPSB7fTsKCiAgICBmdW5jdGlvbiByYW5kb21NYXg4SGV4Q2hhcnMoKSB7CiAgICAgICAgcmV0dXJuICgoKDEgKyBNYXRoLnJhbmRvbSgpKSAqIDB4MTAwMDAwMDAwKSB8IDApLnRvU3RyaW5nKDE2KS5zdWJzdHJpbmcoMSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbUlkKCkgewogICAgICAgIHJldHVybiByYW5kb21NYXg4SGV4Q2hhcnMoKSArIHJhbmRvbU1heDhIZXhDaGFycygpOwogICAgfQogICAgZnVuY3Rpb24gZmluZE1lbW9Ob2Rlcyhyb290Tm9kZSwgYXBwZW5kVG9BcnJheSkgewogICAgICAgIGlmICghcm9vdE5vZGUpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAocm9vdE5vZGUubm9kZVR5cGUgPT0gOCkgewogICAgICAgICAgICB2YXIgbWVtb0lkID0ga28ubWVtb2l6YXRpb24ucGFyc2VNZW1vVGV4dChyb290Tm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICBpZiAobWVtb0lkICE9IG51bGwpCiAgICAgICAgICAgICAgICBhcHBlbmRUb0FycmF5LnB1c2goeyBkb21Ob2RlOiByb290Tm9kZSwgbWVtb0lkOiBtZW1vSWQgfSk7CiAgICAgICAgfSBlbHNlIGlmIChyb290Tm9kZS5ub2RlVHlwZSA9PSAxKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gcm9vdE5vZGUuY2hpbGROb2RlcywgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgZmluZE1lbW9Ob2RlcyhjaGlsZE5vZGVzW2ldLCBhcHBlbmRUb0FycmF5KTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBtZW1vaXplOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgY2FuIG9ubHkgcGFzcyBhIGZ1bmN0aW9uIHRvIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoKSIpOwogICAgICAgICAgICB2YXIgbWVtb0lkID0gZ2VuZXJhdGVSYW5kb21JZCgpOwogICAgICAgICAgICBtZW1vc1ttZW1vSWRdID0gY2FsbGJhY2s7CiAgICAgICAgICAgIHJldHVybiAiPCEtLVtrb19tZW1vOiIgKyBtZW1vSWQgKyAiXS0tPiI7CiAgICAgICAgfSwKCiAgICAgICAgdW5tZW1vaXplOiBmdW5jdGlvbiAobWVtb0lkLCBjYWxsYmFja1BhcmFtcykgewogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBtZW1vc1ttZW1vSWRdOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGRuJ3QgZmluZCBhbnkgbWVtbyB3aXRoIElEICIgKyBtZW1vSWQgKyAiLiBQZXJoYXBzIGl0J3MgYWxyZWFkeSBiZWVuIHVubWVtb2l6ZWQuIik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShudWxsLCBjYWxsYmFja1BhcmFtcyB8fCBbXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGx5IHsgZGVsZXRlIG1lbW9zW21lbW9JZF07IH0KICAgICAgICB9LAoKICAgICAgICB1bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHM6IGZ1bmN0aW9uIChkb21Ob2RlLCBleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpIHsKICAgICAgICAgICAgdmFyIG1lbW9zID0gW107CiAgICAgICAgICAgIGZpbmRNZW1vTm9kZXMoZG9tTm9kZSwgbWVtb3MpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG1lbW9zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBtZW1vc1tpXS5kb21Ob2RlOwogICAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkUGFyYW1zID0gW25vZGVdOwogICAgICAgICAgICAgICAgaWYgKGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSkKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoY29tYmluZWRQYXJhbXMsIGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSk7CiAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemUobWVtb3NbaV0ubWVtb0lkLCBjb21iaW5lZFBhcmFtcyk7CiAgICAgICAgICAgICAgICBub2RlLm5vZGVWYWx1ZSA9ICIiOyAvLyBOZXV0ZXIgdGhpcyBub2RlIHNvIHdlIGRvbid0IHRyeSB0byB1bm1lbW9pemUgaXQgYWdhaW4KICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOyAvLyBJZiBwb3NzaWJsZSwgZXJhc2UgaXQgdG90YWxseSAobm90IGFsd2F5cyBwb3NzaWJsZSAtIHNvbWVvbmUgZWxzZSBtaWdodCBqdXN0IGhvbGQgYSByZWZlcmVuY2UgdG8gaXQgdGhlbiBjYWxsIHVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cyBhZ2FpbikKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHBhcnNlTWVtb1RleHQ6IGZ1bmN0aW9uIChtZW1vVGV4dCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBtZW1vVGV4dC5tYXRjaCgvXlxba29fbWVtb1w6KC4qPylcXSQvKTsKICAgICAgICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsOwogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uJywga28ubWVtb2l6YXRpb24pOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi5tZW1vaXplKTsKa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemUpOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQnLCBrby5tZW1vaXphdGlvbi5wYXJzZU1lbW9UZXh0KTsKa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMpOwprby5leHRlbmRlcnMgPSB7CiAgICAndGhyb3R0bGUnOiBmdW5jdGlvbih0YXJnZXQsIHRpbWVvdXQpIHsKICAgICAgICAvLyBUaHJvdHRsaW5nIG1lYW5zIHR3byB0aGluZ3M6CgogICAgICAgIC8vICgxKSBGb3IgZGVwZW5kZW50IG9ic2VydmFibGVzLCB3ZSB0aHJvdHRsZSAqZXZhbHVhdGlvbnMqIHNvIHRoYXQsIG5vIG1hdHRlciBob3cgZmFzdCBpdHMgZGVwZW5kZW5jaWVzCiAgICAgICAgLy8gICAgIG5vdGlmeSB1cGRhdGVzLCB0aGUgdGFyZ2V0IGRvZXNuJ3QgcmUtZXZhbHVhdGUgKGFuZCBoZW5jZSBkb2Vzbid0IG5vdGlmeSkgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKICAgICAgICB0YXJnZXRbJ3Rocm90dGxlRXZhbHVhdGlvbiddID0gdGltZW91dDsKCiAgICAgICAgLy8gKDIpIEZvciB3cml0YWJsZSB0YXJnZXRzIChvYnNlcnZhYmxlcywgb3Igd3JpdGFibGUgZGVwZW5kZW50IG9ic2VydmFibGVzKSwgd2UgdGhyb3R0bGUgKndyaXRlcyoKICAgICAgICAvLyAgICAgc28gdGhlIHRhcmdldCBjYW5ub3QgY2hhbmdlIHZhbHVlIHN5bmNocm9ub3VzbHkgb3IgZmFzdGVyIHRoYW4gYSBjZXJ0YWluIHJhdGUKICAgICAgICB2YXIgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICAgIHJldHVybiBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKHsKICAgICAgICAgICAgJ3JlYWQnOiB0YXJnZXQsCiAgICAgICAgICAgICd3cml0ZSc6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQod3JpdGVUaW1lb3V0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCiAgICAnbm90aWZ5JzogZnVuY3Rpb24odGFyZ2V0LCBub3RpZnlXaGVuKSB7CiAgICAgICAgdGFyZ2V0WyJlcXVhbGl0eUNvbXBhcmVyIl0gPSBub3RpZnlXaGVuID09ICJhbHdheXMiCiAgICAgICAgICAgID8gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZSB9IC8vIFRyZWF0IGFsbCB2YWx1ZXMgYXMgbm90IGVxdWFsCiAgICAgICAgICAgIDoga28ub2JzZXJ2YWJsZVsiZm4iXVsiZXF1YWxpdHlDb21wYXJlciJdOwogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9Cn07CgpmdW5jdGlvbiBhcHBseUV4dGVuZGVycyhyZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKICAgIHZhciB0YXJnZXQgPSB0aGlzOwogICAgaWYgKHJlcXVlc3RlZEV4dGVuZGVycykgewogICAgICAgIGZvciAodmFyIGtleSBpbiByZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKICAgICAgICAgICAgdmFyIGV4dGVuZGVySGFuZGxlciA9IGtvLmV4dGVuZGVyc1trZXldOwogICAgICAgICAgICBpZiAodHlwZW9mIGV4dGVuZGVySGFuZGxlciA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBleHRlbmRlckhhbmRsZXIodGFyZ2V0LCByZXF1ZXN0ZWRFeHRlbmRlcnNba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdGFyZ2V0Owp9Cgprby5leHBvcnRTeW1ib2woJ2V4dGVuZGVycycsIGtvLmV4dGVuZGVycyk7Cgprby5zdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAodGFyZ2V0LCBjYWxsYmFjaywgZGlzcG9zZUNhbGxiYWNrKSB7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrID0gZGlzcG9zZUNhbGxiYWNrOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2Rpc3Bvc2UnLCB0aGlzLmRpc3Bvc2UpOwp9Owprby5zdWJzY3JpcHRpb24ucHJvdG90eXBlLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmlzRGlzcG9zZWQgPSB0cnVlOwogICAgdGhpcy5kaXNwb3NlQ2FsbGJhY2soKTsKfTsKCmtvLnN1YnNjcmliYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTsKCiAgICBrby51dGlscy5leHRlbmQodGhpcywga28uc3Vic2NyaWJhYmxlWydmbiddKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KHRoaXMsICdzdWJzY3JpYmUnLCB0aGlzLnN1YnNjcmliZSk7CiAgICBrby5leHBvcnRQcm9wZXJ0eSh0aGlzLCAnZXh0ZW5kJywgdGhpcy5leHRlbmQpOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2dldFN1YnNjcmlwdGlvbnNDb3VudCcsIHRoaXMuZ2V0U3Vic2NyaXB0aW9uc0NvdW50KTsKfQoKdmFyIGRlZmF1bHRFdmVudCA9ICJjaGFuZ2UiOwoKa28uc3Vic2NyaWJhYmxlWydmbiddID0gewogICAgc3Vic2NyaWJlOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrVGFyZ2V0LCBldmVudCkgewogICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgZGVmYXVsdEV2ZW50OwogICAgICAgIHZhciBib3VuZENhbGxiYWNrID0gY2FsbGJhY2tUYXJnZXQgPyBjYWxsYmFjay5iaW5kKGNhbGxiYWNrVGFyZ2V0KSA6IGNhbGxiYWNrOwoKICAgICAgICB2YXIgc3Vic2NyaXB0aW9uID0gbmV3IGtvLnN1YnNjcmlwdGlvbih0aGlzLCBib3VuZENhbGxiYWNrLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbSh0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSwgc3Vic2NyaXB0aW9uKTsKICAgICAgICB9LmJpbmQodGhpcykpOwoKICAgICAgICBpZiAoIXRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdKQogICAgICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSA9IFtdOwogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLnB1c2goc3Vic2NyaXB0aW9uKTsKICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uOwogICAgfSwKCiAgICAibm90aWZ5U3Vic2NyaWJlcnMiOiBmdW5jdGlvbiAodmFsdWVUb05vdGlmeSwgZXZlbnQpIHsKICAgICAgICBldmVudCA9IGV2ZW50IHx8IGRlZmF1bHRFdmVudDsKICAgICAgICBpZiAodGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0pIHsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLnNsaWNlKDApLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgICAgICAgICAvLyBJbiBjYXNlIGEgc3Vic2NyaXB0aW9uIHdhcyBkaXNwb3NlZCBkdXJpbmcgdGhlIGFycmF5Rm9yRWFjaCBjeWNsZSwgY2hlY2sKICAgICAgICAgICAgICAgIC8vIGZvciBpc0Rpc3Bvc2VkIG9uIGVhY2ggc3Vic2NyaXB0aW9uIGJlZm9yZSBpbnZva2luZyBpdHMgY2FsbGJhY2sKICAgICAgICAgICAgICAgIGlmIChzdWJzY3JpcHRpb24gJiYgKHN1YnNjcmlwdGlvbi5pc0Rpc3Bvc2VkICE9PSB0cnVlKSkKICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24uY2FsbGJhY2sodmFsdWVUb05vdGlmeSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sCgogICAgZ2V0U3Vic2NyaXB0aW9uc0NvdW50OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHRvdGFsID0gMDsKICAgICAgICBmb3IgKHZhciBldmVudE5hbWUgaW4gdGhpcy5fc3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICBpZiAodGhpcy5fc3Vic2NyaXB0aW9ucy5oYXNPd25Qcm9wZXJ0eShldmVudE5hbWUpKQogICAgICAgICAgICAgICAgdG90YWwgKz0gdGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudE5hbWVdLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRvdGFsOwogICAgfSwKCiAgICBleHRlbmQ6IGFwcGx5RXh0ZW5kZXJzCn07CgoKa28uaXNTdWJzY3JpYmFibGUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHsKICAgIHJldHVybiB0eXBlb2YgaW5zdGFuY2Uuc3Vic2NyaWJlID09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGluc3RhbmNlWyJub3RpZnlTdWJzY3JpYmVycyJdID09ICJmdW5jdGlvbiI7Cn07Cgprby5leHBvcnRTeW1ib2woJ3N1YnNjcmliYWJsZScsIGtvLnN1YnNjcmliYWJsZSk7CmtvLmV4cG9ydFN5bWJvbCgnaXNTdWJzY3JpYmFibGUnLCBrby5pc1N1YnNjcmliYWJsZSk7Cgprby5kZXBlbmRlbmN5RGV0ZWN0aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBfZnJhbWVzID0gW107CgogICAgcmV0dXJuIHsKICAgICAgICBiZWdpbjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIF9mcmFtZXMucHVzaCh7IGNhbGxiYWNrOiBjYWxsYmFjaywgZGlzdGluY3REZXBlbmRlbmNpZXM6W10gfSk7CiAgICAgICAgfSwKCiAgICAgICAgZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIF9mcmFtZXMucG9wKCk7CiAgICAgICAgfSwKCiAgICAgICAgcmVnaXN0ZXJEZXBlbmRlbmN5OiBmdW5jdGlvbiAoc3Vic2NyaWJhYmxlKSB7CiAgICAgICAgICAgIGlmICgha28uaXNTdWJzY3JpYmFibGUoc3Vic2NyaWJhYmxlKSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiT25seSBzdWJzY3JpYmFibGUgdGhpbmdzIGNhbiBhY3QgYXMgZGVwZW5kZW5jaWVzIik7CiAgICAgICAgICAgIGlmIChfZnJhbWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciB0b3BGcmFtZSA9IF9mcmFtZXNbX2ZyYW1lcy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YodG9wRnJhbWUuZGlzdGluY3REZXBlbmRlbmNpZXMsIHN1YnNjcmliYWJsZSkgPj0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB0b3BGcmFtZS5kaXN0aW5jdERlcGVuZGVuY2llcy5wdXNoKHN1YnNjcmliYWJsZSk7CiAgICAgICAgICAgICAgICB0b3BGcmFtZS5jYWxsYmFjayhzdWJzY3JpYmFibGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfSkoKTsKdmFyIHByaW1pdGl2ZVR5cGVzID0geyAndW5kZWZpbmVkJzp0cnVlLCAnYm9vbGVhbic6dHJ1ZSwgJ251bWJlcic6dHJ1ZSwgJ3N0cmluZyc6dHJ1ZSB9OwoKa28ub2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChpbml0aWFsVmFsdWUpIHsKICAgIHZhciBfbGF0ZXN0VmFsdWUgPSBpbml0aWFsVmFsdWU7CgogICAgZnVuY3Rpb24gb2JzZXJ2YWJsZSgpIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gV3JpdGUKCiAgICAgICAgICAgIC8vIElnbm9yZSB3cml0ZXMgaWYgdGhlIHZhbHVlIGhhc24ndCBjaGFuZ2VkCiAgICAgICAgICAgIGlmICgoIW9ic2VydmFibGVbJ2VxdWFsaXR5Q29tcGFyZXInXSkgfHwgIW9ic2VydmFibGVbJ2VxdWFsaXR5Q29tcGFyZXInXShfbGF0ZXN0VmFsdWUsIGFyZ3VtZW50c1swXSkpIHsKICAgICAgICAgICAgICAgIG9ic2VydmFibGUudmFsdWVXaWxsTXV0YXRlKCk7CiAgICAgICAgICAgICAgICBfbGF0ZXN0VmFsdWUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgICAgICBpZiAoREVCVUcpIG9ic2VydmFibGUuX2xhdGVzdFZhbHVlID0gX2xhdGVzdFZhbHVlOwogICAgICAgICAgICAgICAgb2JzZXJ2YWJsZS52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsgLy8gUGVybWl0cyBjaGFpbmVkIGFzc2lnbm1lbnRzCiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICAvLyBSZWFkCiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24ucmVnaXN0ZXJEZXBlbmRlbmN5KG9ic2VydmFibGUpOyAvLyBUaGUgY2FsbGVyIG9ubHkgbmVlZHMgdG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyBpZiB0aGV5IGRpZCBhICJyZWFkIiBvcGVyYXRpb24KICAgICAgICAgICAgcmV0dXJuIF9sYXRlc3RWYWx1ZTsKICAgICAgICB9CiAgICB9CiAgICBpZiAoREVCVUcpIG9ic2VydmFibGUuX2xhdGVzdFZhbHVlID0gX2xhdGVzdFZhbHVlOwogICAga28uc3Vic2NyaWJhYmxlLmNhbGwob2JzZXJ2YWJsZSk7CiAgICBvYnNlcnZhYmxlLnZhbHVlSGFzTXV0YXRlZCA9IGZ1bmN0aW9uICgpIHsgb2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUpOyB9CiAgICBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSA9IGZ1bmN0aW9uICgpIHsgb2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUsICJiZWZvcmVDaGFuZ2UiKTsgfQogICAga28udXRpbHMuZXh0ZW5kKG9ic2VydmFibGUsIGtvLm9ic2VydmFibGVbJ2ZuJ10pOwoKICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICJ2YWx1ZUhhc011dGF0ZWQiLCBvYnNlcnZhYmxlLnZhbHVlSGFzTXV0YXRlZCk7CiAgICBrby5leHBvcnRQcm9wZXJ0eShvYnNlcnZhYmxlLCAidmFsdWVXaWxsTXV0YXRlIiwgb2JzZXJ2YWJsZS52YWx1ZVdpbGxNdXRhdGUpOwoKICAgIHJldHVybiBvYnNlcnZhYmxlOwp9Cgprby5vYnNlcnZhYmxlWydmbiddID0gewogICAgImVxdWFsaXR5Q29tcGFyZXIiOiBmdW5jdGlvbiB2YWx1ZXNBcmVQcmltaXRpdmVBbmRFcXVhbChhLCBiKSB7CiAgICAgICAgdmFyIG9sZFZhbHVlSXNQcmltaXRpdmUgPSAoYSA9PT0gbnVsbCkgfHwgKHR5cGVvZihhKSBpbiBwcmltaXRpdmVUeXBlcyk7CiAgICAgICAgcmV0dXJuIG9sZFZhbHVlSXNQcmltaXRpdmUgPyAoYSA9PT0gYikgOiBmYWxzZTsKICAgIH0KfTsKCnZhciBwcm90b1Byb3BlcnR5ID0ga28ub2JzZXJ2YWJsZS5wcm90b1Byb3BlcnR5ID0gIl9fa29fcHJvdG9fXyI7CmtvLm9ic2VydmFibGVbJ2ZuJ11bcHJvdG9Qcm9wZXJ0eV0gPSBrby5vYnNlcnZhYmxlOwoKa28uaGFzUHJvdG90eXBlID0gZnVuY3Rpb24oaW5zdGFuY2UsIHByb3RvdHlwZSkgewogICAgaWYgKChpbnN0YW5jZSA9PT0gbnVsbCkgfHwgKGluc3RhbmNlID09PSB1bmRlZmluZWQpIHx8IChpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0gdW5kZWZpbmVkKSkgcmV0dXJuIGZhbHNlOwogICAgaWYgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSBwcm90b3R5cGUpIHJldHVybiB0cnVlOwogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSwgcHJvdG90eXBlKTsgLy8gV2FsayB0aGUgcHJvdG90eXBlIGNoYWluCn07Cgprby5pc09ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHsKICAgIHJldHVybiBrby5oYXNQcm90b3R5cGUoaW5zdGFuY2UsIGtvLm9ic2VydmFibGUpOwp9CmtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgLy8gT2JzZXJ2YWJsZQogICAgaWYgKCh0eXBlb2YgaW5zdGFuY2UgPT0gImZ1bmN0aW9uIikgJiYgaW5zdGFuY2VbcHJvdG9Qcm9wZXJ0eV0gPT09IGtvLm9ic2VydmFibGUpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAvLyBXcml0ZWFibGUgZGVwZW5kZW50IG9ic2VydmFibGUKICAgIGlmICgodHlwZW9mIGluc3RhbmNlID09ICJmdW5jdGlvbiIpICYmIChpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSkgJiYgKGluc3RhbmNlLmhhc1dyaXRlRnVuY3Rpb24pKQogICAgICAgIHJldHVybiB0cnVlOwogICAgLy8gQW55dGhpbmcgZWxzZQogICAgcmV0dXJuIGZhbHNlOwp9CgoKa28uZXhwb3J0U3ltYm9sKCdvYnNlcnZhYmxlJywga28ub2JzZXJ2YWJsZSk7CmtvLmV4cG9ydFN5bWJvbCgnaXNPYnNlcnZhYmxlJywga28uaXNPYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc1dyaXRlYWJsZU9ic2VydmFibGUnLCBrby5pc1dyaXRlYWJsZU9ic2VydmFibGUpOwprby5vYnNlcnZhYmxlQXJyYXkgPSBmdW5jdGlvbiAoaW5pdGlhbFZhbHVlcykgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewogICAgICAgIC8vIFplcm8tcGFyYW1ldGVyIGNvbnN0cnVjdG9yIGluaXRpYWxpemVzIHRvIGVtcHR5IGFycmF5CiAgICAgICAgaW5pdGlhbFZhbHVlcyA9IFtdOwogICAgfQogICAgaWYgKChpbml0aWFsVmFsdWVzICE9PSBudWxsKSAmJiAoaW5pdGlhbFZhbHVlcyAhPT0gdW5kZWZpbmVkKSAmJiAhKCdsZW5ndGgnIGluIGluaXRpYWxWYWx1ZXMpKQogICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGFyZ3VtZW50IHBhc3NlZCB3aGVuIGluaXRpYWxpemluZyBhbiBvYnNlcnZhYmxlIGFycmF5IG11c3QgYmUgYW4gYXJyYXksIG9yIG51bGwsIG9yIHVuZGVmaW5lZC4iKTsKCiAgICB2YXIgcmVzdWx0ID0ga28ub2JzZXJ2YWJsZShpbml0aWFsVmFsdWVzKTsKICAgIGtvLnV0aWxzLmV4dGVuZChyZXN1bHQsIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXSk7CiAgICByZXR1cm4gcmVzdWx0Owp9Cgprby5vYnNlcnZhYmxlQXJyYXlbJ2ZuJ10gPSB7CiAgICAncmVtb3ZlJzogZnVuY3Rpb24gKHZhbHVlT3JQcmVkaWNhdGUpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcygpOwogICAgICAgIHZhciByZW1vdmVkVmFsdWVzID0gW107CiAgICAgICAgdmFyIHByZWRpY2F0ZSA9IHR5cGVvZiB2YWx1ZU9yUHJlZGljYXRlID09ICJmdW5jdGlvbiIgPyB2YWx1ZU9yUHJlZGljYXRlIDogZnVuY3Rpb24gKHZhbHVlKSB7IHJldHVybiB2YWx1ZSA9PT0gdmFsdWVPclByZWRpY2F0ZTsgfTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVuZGVybHlpbmdBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB1bmRlcmx5aW5nQXJyYXlbaV07CiAgICAgICAgICAgIGlmIChwcmVkaWNhdGUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAocmVtb3ZlZFZhbHVlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVtb3ZlZFZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJlbW92ZWRWYWx1ZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZW1vdmVkVmFsdWVzOwogICAgfSwKCiAgICAncmVtb3ZlQWxsJzogZnVuY3Rpb24gKGFycmF5T2ZWYWx1ZXMpIHsKICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIHplcm8gYXJncywgd2UgcmVtb3ZlIGV2ZXJ5dGhpbmcKICAgICAgICBpZiAoYXJyYXlPZlZhbHVlcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CiAgICAgICAgICAgIHZhciBhbGxWYWx1ZXMgPSB1bmRlcmx5aW5nQXJyYXkuc2xpY2UoMCk7CiAgICAgICAgICAgIHRoaXMudmFsdWVXaWxsTXV0YXRlKCk7CiAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheS5zcGxpY2UoMCwgdW5kZXJseWluZ0FycmF5Lmxlbmd0aCk7CiAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgICAgIHJldHVybiBhbGxWYWx1ZXM7CiAgICAgICAgfQogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byByZW1vdmUKICAgICAgICBpZiAoIWFycmF5T2ZWYWx1ZXMpCiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICByZXR1cm4gdGhpc1sncmVtb3ZlJ10oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YoYXJyYXlPZlZhbHVlcywgdmFsdWUpID49IDA7CiAgICAgICAgfSk7CiAgICB9LAoKICAgICdkZXN0cm95JzogZnVuY3Rpb24gKHZhbHVlT3JQcmVkaWNhdGUpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcygpOwogICAgICAgIHZhciBwcmVkaWNhdGUgPSB0eXBlb2YgdmFsdWVPclByZWRpY2F0ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWVPclByZWRpY2F0ZSA6IGZ1bmN0aW9uICh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgPT09IHZhbHVlT3JQcmVkaWNhdGU7IH07CiAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICBmb3IgKHZhciBpID0gdW5kZXJseWluZ0FycmF5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHVuZGVybHlpbmdBcnJheVtpXTsKICAgICAgICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSkpCiAgICAgICAgICAgICAgICB1bmRlcmx5aW5nQXJyYXlbaV1bIl9kZXN0cm95Il0gPSB0cnVlOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwogICAgfSwKCiAgICAnZGVzdHJveUFsbCc6IGZ1bmN0aW9uIChhcnJheU9mVmFsdWVzKSB7CiAgICAgICAgLy8gSWYgeW91IHBhc3NlZCB6ZXJvIGFyZ3MsIHdlIGRlc3Ryb3kgZXZlcnl0aGluZwogICAgICAgIGlmIChhcnJheU9mVmFsdWVzID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgIHJldHVybiB0aGlzWydkZXN0cm95J10oZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlIH0pOwoKICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIGFuIGFyZywgd2UgaW50ZXJwcmV0IGl0IGFzIGFuIGFycmF5IG9mIGVudHJpZXMgdG8gZGVzdHJveQogICAgICAgIGlmICghYXJyYXlPZlZhbHVlcykKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIHJldHVybiB0aGlzWydkZXN0cm95J10oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YoYXJyYXlPZlZhbHVlcywgdmFsdWUpID49IDA7CiAgICAgICAgfSk7CiAgICB9LAoKICAgICdpbmRleE9mJzogZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcygpOwogICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YodW5kZXJseWluZ0FycmF5LCBpdGVtKTsKICAgIH0sCgogICAgJ3JlcGxhY2UnOiBmdW5jdGlvbihvbGRJdGVtLCBuZXdJdGVtKSB7CiAgICAgICAgdmFyIGluZGV4ID0gdGhpc1snaW5kZXhPZiddKG9sZEl0ZW0pOwogICAgICAgIGlmIChpbmRleCA+PSAwKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWVXaWxsTXV0YXRlKCk7CiAgICAgICAgICAgIHRoaXMoKVtpbmRleF0gPSBuZXdJdGVtOwogICAgICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwogICAgICAgIH0KICAgIH0KfQoKLy8gUG9wdWxhdGUga28ub2JzZXJ2YWJsZUFycmF5LmZuIHdpdGggcmVhZC93cml0ZSBmdW5jdGlvbnMgZnJvbSBuYXRpdmUgYXJyYXlzCmtvLnV0aWxzLmFycmF5Rm9yRWFjaChbInBvcCIsICJwdXNoIiwgInJldmVyc2UiLCAic2hpZnQiLCAic29ydCIsICJzcGxpY2UiLCAidW5zaGlmdCJdLCBmdW5jdGlvbiAobWV0aG9kTmFtZSkgewogICAga28ub2JzZXJ2YWJsZUFycmF5WydmbiddW21ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CiAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICB2YXIgbWV0aG9kQ2FsbFJlc3VsdCA9IHVuZGVybHlpbmdBcnJheVttZXRob2ROYW1lXS5hcHBseSh1bmRlcmx5aW5nQXJyYXksIGFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICByZXR1cm4gbWV0aG9kQ2FsbFJlc3VsdDsKICAgIH07Cn0pOwoKLy8gUG9wdWxhdGUga28ub2JzZXJ2YWJsZUFycmF5LmZuIHdpdGggcmVhZC1vbmx5IGZ1bmN0aW9ucyBmcm9tIG5hdGl2ZSBhcnJheXMKa28udXRpbHMuYXJyYXlGb3JFYWNoKFsic2xpY2UiXSwgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgIGtvLm9ic2VydmFibGVBcnJheVsnZm4nXVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcygpOwogICAgICAgIHJldHVybiB1bmRlcmx5aW5nQXJyYXlbbWV0aG9kTmFtZV0uYXBwbHkodW5kZXJseWluZ0FycmF5LCBhcmd1bWVudHMpOwogICAgfTsKfSk7Cgprby5leHBvcnRTeW1ib2woJ29ic2VydmFibGVBcnJheScsIGtvLm9ic2VydmFibGVBcnJheSk7CmtvLmRlcGVuZGVudE9ic2VydmFibGUgPSBmdW5jdGlvbiAoZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0LCBvcHRpb25zKSB7CiAgICB2YXIgX2xhdGVzdFZhbHVlLAogICAgICAgIF9oYXNCZWVuRXZhbHVhdGVkID0gZmFsc2UsCiAgICAgICAgX2lzQmVpbmdFdmFsdWF0ZWQgPSBmYWxzZSwKICAgICAgICByZWFkRnVuY3Rpb24gPSBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9uczsKCiAgICBpZiAocmVhZEZ1bmN0aW9uICYmIHR5cGVvZiByZWFkRnVuY3Rpb24gPT0gIm9iamVjdCIpIHsKICAgICAgICAvLyBTaW5nbGUtcGFyYW1ldGVyIHN5bnRheCAtIGV2ZXJ5dGhpbmcgaXMgb24gdGhpcyAib3B0aW9ucyIgcGFyYW0KICAgICAgICBvcHRpb25zID0gcmVhZEZ1bmN0aW9uOwogICAgICAgIHJlYWRGdW5jdGlvbiA9IG9wdGlvbnNbInJlYWQiXTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gTXVsdGktcGFyYW1ldGVyIHN5bnRheCAtIGNvbnN0cnVjdCB0aGUgb3B0aW9ucyBhY2NvcmRpbmcgdG8gdGhlIHBhcmFtcyBwYXNzZWQKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBpZiAoIXJlYWRGdW5jdGlvbikKICAgICAgICAgICAgcmVhZEZ1bmN0aW9uID0gb3B0aW9uc1sicmVhZCJdOwogICAgfQogICAgLy8gQnkgaGVyZSwgIm9wdGlvbnMiIGlzIGFsd2F5cyBub24tbnVsbAogICAgaWYgKHR5cGVvZiByZWFkRnVuY3Rpb24gIT0gImZ1bmN0aW9uIikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhc3MgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBrby5jb21wdXRlZCIpOwoKICAgIHZhciB3cml0ZUZ1bmN0aW9uID0gb3B0aW9uc1sid3JpdGUiXTsKICAgIGlmICghZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpCiAgICAgICAgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQgPSBvcHRpb25zWyJvd25lciJdOwoKICAgIHZhciBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzID0gW107CiAgICBmdW5jdGlvbiBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCkgewogICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7CiAgICAgICAgfSk7CiAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcyA9IFtdOwogICAgfQogICAgdmFyIGRpc3Bvc2UgPSBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzOwoKICAgIC8vIEJ1aWxkICJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQiIGFuZCAiZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkQ2FsbGJhY2siIG9wdGlvbiB2YWx1ZXMKICAgIC8vIChOb3RlOiAiZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIiBvcHRpb24gYm90aCBwcm9hY3RpdmVseSBkaXNwb3NlcyBhcyBzb29uIGFzIHRoZSBub2RlIGlzIHJlbW92ZWQgdXNpbmcga28ucmVtb3ZlTm9kZSgpLAogICAgLy8gcGx1cyBhZGRzIGEgImRpc3Bvc2VXaGVuIiBjYWxsYmFjayB0aGF0LCBvbiBlYWNoIGV2YWx1YXRpb24sIGRpc3Bvc2VzIGlmIHRoZSBub2RlIHdhcyByZW1vdmVkIGJ5IHNvbWUgb3RoZXIgbWVhbnMuKQogICAgdmFyIGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCA9ICh0eXBlb2Ygb3B0aW9uc1siZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIl0gPT0gIm9iamVjdCIpID8gb3B0aW9uc1siZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIl0gOiBudWxsOwogICAgdmFyIGRpc3Bvc2VXaGVuID0gb3B0aW9uc1siZGlzcG9zZVdoZW4iXSB8fCBmdW5jdGlvbigpIHsgcmV0dXJuIGZhbHNlOyB9OwogICAgaWYgKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCkgewogICAgICAgIGRpc3Bvc2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZURpc3Bvc2VDYWxsYmFjayhkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQsIGFyZ3VtZW50cy5jYWxsZWUpOwogICAgICAgICAgICBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCk7CiAgICAgICAgfTsKICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCwgZGlzcG9zZSk7CiAgICAgICAgdmFyIGV4aXN0aW5nRGlzcG9zZVdoZW5GdW5jdGlvbiA9IGRpc3Bvc2VXaGVuOwogICAgICAgIGRpc3Bvc2VXaGVuID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQpIHx8IGV4aXN0aW5nRGlzcG9zZVdoZW5GdW5jdGlvbigpOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgZXZhbHVhdGlvblRpbWVvdXRJbnN0YW5jZSA9IG51bGw7CiAgICBmdW5jdGlvbiBldmFsdWF0ZVBvc3NpYmx5QXN5bmMoKSB7CiAgICAgICAgdmFyIHRocm90dGxlRXZhbHVhdGlvblRpbWVvdXQgPSBkZXBlbmRlbnRPYnNlcnZhYmxlWyd0aHJvdHRsZUV2YWx1YXRpb24nXTsKICAgICAgICBpZiAodGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCAmJiB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ID49IDApIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UpOwogICAgICAgICAgICBldmFsdWF0aW9uVGltZW91dEluc3RhbmNlID0gc2V0VGltZW91dChldmFsdWF0ZUltbWVkaWF0ZSwgdGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCk7CiAgICAgICAgfSBlbHNlCiAgICAgICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZXZhbHVhdGVJbW1lZGlhdGUoKSB7CiAgICAgICAgaWYgKF9pc0JlaW5nRXZhbHVhdGVkKSB7CiAgICAgICAgICAgIC8vIElmIHRoZSBldmFsdWF0aW9uIG9mIGEga28uY29tcHV0ZWQgY2F1c2VzIHNpZGUgZWZmZWN0cywgaXQncyBwb3NzaWJsZSB0aGF0IGl0IHdpbGwgdHJpZ2dlciBpdHMgb3duIHJlLWV2YWx1YXRpb24uCiAgICAgICAgICAgIC8vIFRoaXMgaXMgbm90IGRlc2lyYWJsZSAoaXQncyBoYXJkIGZvciBhIGRldmVsb3BlciB0byByZWFsaXNlIGEgY2hhaW4gb2YgZGVwZW5kZW5jaWVzIG1pZ2h0IGNhdXNlIHRoaXMsIGFuZCB0aGV5IGFsbW9zdAogICAgICAgICAgICAvLyBjZXJ0YWlubHkgZGlkbid0IGludGVuZCBpbmZpbml0ZSByZS1ldmFsdWF0aW9ucykuIFNvLCBmb3IgcHJlZGljdGFiaWxpdHksIHdlIHNpbXBseSBwcmV2ZW50IGtvLmNvbXB1dGVkcyBmcm9tIGNhdXNpbmcKICAgICAgICAgICAgLy8gdGhlaXIgb3duIHJlLWV2YWx1YXRpb24uIEZ1cnRoZXIgZGlzY3Vzc2lvbiBhdCBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvcHVsbC8zODcKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gRG9uJ3QgZGlzcG9zZSBvbiBmaXJzdCBldmFsdWF0aW9uLCBiZWNhdXNlIHRoZSAiZGlzcG9zZVdoZW4iIGNhbGxiYWNrIG1pZ2h0CiAgICAgICAgLy8gZS5nLiwgZGlzcG9zZSB3aGVuIHRoZSBhc3NvY2lhdGVkIERPTSBlbGVtZW50IGlzbid0IGluIHRoZSBkb2MsIGFuZCBpdCdzIG5vdAogICAgICAgIC8vIGdvaW5nIHRvIGJlIGluIHRoZSBkb2MgdW50aWwgKmFmdGVyKiB0aGUgZmlyc3QgZXZhbHVhdGlvbgogICAgICAgIGlmIChfaGFzQmVlbkV2YWx1YXRlZCAmJiBkaXNwb3NlV2hlbigpKSB7CiAgICAgICAgICAgIGRpc3Bvc2UoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgX2lzQmVpbmdFdmFsdWF0ZWQgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIEluaXRpYWxseSwgd2UgYXNzdW1lIHRoYXQgbm9uZSBvZiB0aGUgc3Vic2NyaXB0aW9ucyBhcmUgc3RpbGwgYmVpbmcgdXNlZCAoaS5lLiwgYWxsIGFyZSBjYW5kaWRhdGVzIGZvciBkaXNwb3NhbCkuCiAgICAgICAgICAgIC8vIFRoZW4sIGR1cmluZyBldmFsdWF0aW9uLCB3ZSBjcm9zcyBvZmYgYW55IHRoYXQgYXJlIGluIGZhY3Qgc3RpbGwgYmVpbmcgdXNlZC4KICAgICAgICAgICAgdmFyIGRpc3Bvc2FsQ2FuZGlkYXRlcyA9IGtvLnV0aWxzLmFycmF5TWFwKF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMsIGZ1bmN0aW9uKGl0ZW0pIHtyZXR1cm4gaXRlbS50YXJnZXQ7fSk7CgogICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmJlZ2luKGZ1bmN0aW9uKHN1YnNjcmliYWJsZSkgewogICAgICAgICAgICAgICAgdmFyIGluT2xkOwogICAgICAgICAgICAgICAgaWYgKChpbk9sZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihkaXNwb3NhbENhbmRpZGF0ZXMsIHN1YnNjcmliYWJsZSkpID49IDApCiAgICAgICAgICAgICAgICAgICAgZGlzcG9zYWxDYW5kaWRhdGVzW2luT2xkXSA9IHVuZGVmaW5lZDsgLy8gRG9uJ3Qgd2FudCB0byBkaXNwb3NlIHRoaXMgc3Vic2NyaXB0aW9uLCBhcyBpdCdzIHN0aWxsIGJlaW5nIHVzZWQKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLnB1c2goc3Vic2NyaWJhYmxlLnN1YnNjcmliZShldmFsdWF0ZVBvc3NpYmx5QXN5bmMpKTsgLy8gQnJhbmQgbmV3IHN1YnNjcmlwdGlvbiAtIGFkZCBpdAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHJlYWRGdW5jdGlvbi5jYWxsKGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0KTsKCiAgICAgICAgICAgIC8vIEZvciBlYWNoIHN1YnNjcmlwdGlvbiBubyBsb25nZXIgYmVpbmcgdXNlZCwgcmVtb3ZlIGl0IGZyb20gdGhlIGFjdGl2ZSBzdWJzY3JpcHRpb25zIGxpc3QgYW5kIGRpc3Bvc2UgaXQKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGRpc3Bvc2FsQ2FuZGlkYXRlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgaWYgKGRpc3Bvc2FsQ2FuZGlkYXRlc1tpXSkKICAgICAgICAgICAgICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLnNwbGljZShpLCAxKVswXS5kaXNwb3NlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX2hhc0JlZW5FdmFsdWF0ZWQgPSB0cnVlOwoKICAgICAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUsICJiZWZvcmVDaGFuZ2UiKTsKICAgICAgICAgICAgX2xhdGVzdFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIGlmIChERUJVRykgZGVwZW5kZW50T2JzZXJ2YWJsZS5fbGF0ZXN0VmFsdWUgPSBfbGF0ZXN0VmFsdWU7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5lbmQoKTsKICAgICAgICB9CgogICAgICAgIGRlcGVuZGVudE9ic2VydmFibGVbIm5vdGlmeVN1YnNjcmliZXJzIl0oX2xhdGVzdFZhbHVlKTsKICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IGZhbHNlOwoKICAgIH0KCiAgICBmdW5jdGlvbiBkZXBlbmRlbnRPYnNlcnZhYmxlKCkgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBzZXQuYXBwbHkoZGVwZW5kZW50T2JzZXJ2YWJsZSwgYXJndW1lbnRzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZ2V0KCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNldCgpIHsKICAgICAgICBpZiAodHlwZW9mIHdyaXRlRnVuY3Rpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgLy8gV3JpdGluZyBhIHZhbHVlCiAgICAgICAgICAgIHdyaXRlRnVuY3Rpb24uYXBwbHkoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQsIGFyZ3VtZW50cyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgd3JpdGUgYSB2YWx1ZSB0byBhIGtvLmNvbXB1dGVkIHVubGVzcyB5b3Ugc3BlY2lmeSBhICd3cml0ZScgb3B0aW9uLiBJZiB5b3Ugd2lzaCB0byByZWFkIHRoZSBjdXJyZW50IHZhbHVlLCBkb24ndCBwYXNzIGFueSBwYXJhbWV0ZXJzLiIpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgLy8gUmVhZGluZyB0aGUgdmFsdWUKICAgICAgICBpZiAoIV9oYXNCZWVuRXZhbHVhdGVkKQogICAgICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSgpOwogICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24ucmVnaXN0ZXJEZXBlbmRlbmN5KGRlcGVuZGVudE9ic2VydmFibGUpOwogICAgICAgIHJldHVybiBfbGF0ZXN0VmFsdWU7CiAgICB9CgogICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5nZXREZXBlbmRlbmNpZXNDb3VudCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMubGVuZ3RoOyB9OwogICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5oYXNXcml0ZUZ1bmN0aW9uID0gdHlwZW9mIG9wdGlvbnNbIndyaXRlIl0gPT09ICJmdW5jdGlvbiI7CiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7IGRpc3Bvc2UoKTsgfTsKCiAgICBrby5zdWJzY3JpYmFibGUuY2FsbChkZXBlbmRlbnRPYnNlcnZhYmxlKTsKICAgIGtvLnV0aWxzLmV4dGVuZChkZXBlbmRlbnRPYnNlcnZhYmxlLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddKTsKCiAgICBpZiAob3B0aW9uc1snZGVmZXJFdmFsdWF0aW9uJ10gIT09IHRydWUpCiAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKCiAgICBrby5leHBvcnRQcm9wZXJ0eShkZXBlbmRlbnRPYnNlcnZhYmxlLCAnZGlzcG9zZScsIGRlcGVuZGVudE9ic2VydmFibGUuZGlzcG9zZSk7CiAgICBrby5leHBvcnRQcm9wZXJ0eShkZXBlbmRlbnRPYnNlcnZhYmxlLCAnZ2V0RGVwZW5kZW5jaWVzQ291bnQnLCBkZXBlbmRlbnRPYnNlcnZhYmxlLmdldERlcGVuZGVuY2llc0NvdW50KTsKCiAgICByZXR1cm4gZGVwZW5kZW50T2JzZXJ2YWJsZTsKfTsKCmtvLmlzQ29tcHV0ZWQgPSBmdW5jdGlvbihpbnN0YW5jZSkgewogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7Cn07Cgp2YXIgcHJvdG9Qcm9wID0ga28ub2JzZXJ2YWJsZS5wcm90b1Byb3BlcnR5OyAvLyA9PSAiX19rb19wcm90b19fIgprby5kZXBlbmRlbnRPYnNlcnZhYmxlW3Byb3RvUHJvcF0gPSBrby5vYnNlcnZhYmxlOwoKa28uZGVwZW5kZW50T2JzZXJ2YWJsZVsnZm4nXSA9IHt9Owprby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddW3Byb3RvUHJvcF0gPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlOwoKa28uZXhwb3J0U3ltYm9sKCdkZXBlbmRlbnRPYnNlcnZhYmxlJywga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7CmtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWQnLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsgLy8gTWFrZSAia28uY29tcHV0ZWQiIGFuIGFsaWFzIGZvciAia28uZGVwZW5kZW50T2JzZXJ2YWJsZSIKa28uZXhwb3J0U3ltYm9sKCdpc0NvbXB1dGVkJywga28uaXNDb21wdXRlZCk7CgooZnVuY3Rpb24oKSB7CiAgICB2YXIgbWF4TmVzdGVkT2JzZXJ2YWJsZURlcHRoID0gMTA7IC8vIEVzY2FwZSB0aGUgKHVubGlrZWx5KSBwYXRoYWxvZ2ljYWwgY2FzZSB3aGVyZSBhbiBvYnNlcnZhYmxlJ3MgY3VycmVudCB2YWx1ZSBpcyBpdHNlbGYgKG9yIHNpbWlsYXIgcmVmZXJlbmNlIGN5Y2xlKQoKICAgIGtvLnRvSlMgPSBmdW5jdGlvbihyb290T2JqZWN0KSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaGVuIGNhbGxpbmcga28udG9KUywgcGFzcyB0aGUgb2JqZWN0IHlvdSB3YW50IHRvIGNvbnZlcnQuIik7CgogICAgICAgIC8vIFdlIGp1c3QgdW53cmFwIGV2ZXJ5dGhpbmcgYXQgZXZlcnkgbGV2ZWwgaW4gdGhlIG9iamVjdCBncmFwaAogICAgICAgIHJldHVybiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIGZ1bmN0aW9uKHZhbHVlVG9NYXApIHsKICAgICAgICAgICAgLy8gTG9vcCBiZWNhdXNlIGFuIG9ic2VydmFibGUncyB2YWx1ZSBtaWdodCBpbiB0dXJuIGJlIGFub3RoZXIgb2JzZXJ2YWJsZSB3cmFwcGVyCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrby5pc09ic2VydmFibGUodmFsdWVUb01hcCkgJiYgKGkgPCBtYXhOZXN0ZWRPYnNlcnZhYmxlRGVwdGgpOyBpKyspCiAgICAgICAgICAgICAgICB2YWx1ZVRvTWFwID0gdmFsdWVUb01hcCgpOwogICAgICAgICAgICByZXR1cm4gdmFsdWVUb01hcDsKICAgICAgICB9KTsKICAgIH07CgogICAga28udG9KU09OID0gZnVuY3Rpb24ocm9vdE9iamVjdCwgcmVwbGFjZXIsIHNwYWNlKSB7ICAgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCiAgICAgICAgdmFyIHBsYWluSmF2YVNjcmlwdE9iamVjdCA9IGtvLnRvSlMocm9vdE9iamVjdCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnN0cmluZ2lmeUpzb24ocGxhaW5KYXZhU2NyaXB0T2JqZWN0LCByZXBsYWNlciwgc3BhY2UpOwogICAgfTsKCiAgICBmdW5jdGlvbiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIG1hcElucHV0Q2FsbGJhY2ssIHZpc2l0ZWRPYmplY3RzKSB7CiAgICAgICAgdmlzaXRlZE9iamVjdHMgPSB2aXNpdGVkT2JqZWN0cyB8fCBuZXcgb2JqZWN0TG9va3VwKCk7CgogICAgICAgIHJvb3RPYmplY3QgPSBtYXBJbnB1dENhbGxiYWNrKHJvb3RPYmplY3QpOwogICAgICAgIHZhciBjYW5IYXZlUHJvcGVydGllcyA9ICh0eXBlb2Ygcm9vdE9iamVjdCA9PSAib2JqZWN0IikgJiYgKHJvb3RPYmplY3QgIT09IG51bGwpICYmIChyb290T2JqZWN0ICE9PSB1bmRlZmluZWQpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBEYXRlKSk7CiAgICAgICAgaWYgKCFjYW5IYXZlUHJvcGVydGllcykKICAgICAgICAgICAgcmV0dXJuIHJvb3RPYmplY3Q7CgogICAgICAgIHZhciBvdXRwdXRQcm9wZXJ0aWVzID0gcm9vdE9iamVjdCBpbnN0YW5jZW9mIEFycmF5ID8gW10gOiB7fTsKICAgICAgICB2aXNpdGVkT2JqZWN0cy5zYXZlKHJvb3RPYmplY3QsIG91dHB1dFByb3BlcnRpZXMpOwoKICAgICAgICB2aXNpdFByb3BlcnRpZXNPckFycmF5RW50cmllcyhyb290T2JqZWN0LCBmdW5jdGlvbihpbmRleGVyKSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eVZhbHVlID0gbWFwSW5wdXRDYWxsYmFjayhyb290T2JqZWN0W2luZGV4ZXJdKTsKCiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHByb3BlcnR5VmFsdWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJvcGVydGllc1tpbmRleGVyXSA9IHByb3BlcnR5VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNseU1hcHBlZFZhbHVlID0gdmlzaXRlZE9iamVjdHMuZ2V0KHByb3BlcnR5VmFsdWUpOwogICAgICAgICAgICAgICAgICAgIG91dHB1dFByb3BlcnRpZXNbaW5kZXhlcl0gPSAocHJldmlvdXNseU1hcHBlZFZhbHVlICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgID8gcHJldmlvdXNseU1hcHBlZFZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIDogbWFwSnNPYmplY3RHcmFwaChwcm9wZXJ0eVZhbHVlLCBtYXBJbnB1dENhbGxiYWNrLCB2aXNpdGVkT2JqZWN0cyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIG91dHB1dFByb3BlcnRpZXM7CiAgICB9CgogICAgZnVuY3Rpb24gdmlzaXRQcm9wZXJ0aWVzT3JBcnJheUVudHJpZXMocm9vdE9iamVjdCwgdmlzaXRvckNhbGxiYWNrKSB7CiAgICAgICAgaWYgKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvb3RPYmplY3QubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2soaSk7CgogICAgICAgICAgICAvLyBGb3IgYXJyYXlzLCBhbHNvIHJlc3BlY3QgdG9KU09OIHByb3BlcnR5IGZvciBjdXN0b20gbWFwcGluZ3MgKGZpeGVzICMyNzgpCiAgICAgICAgICAgIGlmICh0eXBlb2Ygcm9vdE9iamVjdFsndG9KU09OJ10gPT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgIHZpc2l0b3JDYWxsYmFjaygndG9KU09OJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlOYW1lIGluIHJvb3RPYmplY3QpCiAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2socHJvcGVydHlOYW1lKTsKICAgICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIG9iamVjdExvb2t1cCgpIHsKICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICB0aGlzLnNhdmUgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGtleXMsIGtleSk7CiAgICAgICAgICAgIGlmIChleGlzdGluZ0luZGV4ID49IDApCiAgICAgICAgICAgICAgICB2YWx1ZXNbZXhpc3RpbmdJbmRleF0gPSB2YWx1ZTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5nZXQgPSBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nSW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2Yoa2V5cywga2V5KTsKICAgICAgICAgICAgcmV0dXJuIChleGlzdGluZ0luZGV4ID49IDApID8gdmFsdWVzW2V4aXN0aW5nSW5kZXhdIDogdW5kZWZpbmVkOwogICAgICAgIH07CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd0b0pTJywga28udG9KUyk7CmtvLmV4cG9ydFN5bWJvbCgndG9KU09OJywga28udG9KU09OKTsKKGZ1bmN0aW9uICgpIHsKICAgIHZhciBoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5ID0gJ19fa29fX2hhc0RvbURhdGFPcHRpb25WYWx1ZV9fJzsKCiAgICAvLyBOb3JtYWxseSwgU0VMRUNUIGVsZW1lbnRzIGFuZCB0aGVpciBPUFRJT05zIGNhbiBvbmx5IHRha2UgdmFsdWUgb2YgdHlwZSAnc3RyaW5nJyAoYmVjYXVzZSB0aGUgdmFsdWVzCiAgICAvLyBhcmUgc3RvcmVkIG9uIERPTSBhdHRyaWJ1dGVzKS4ga28uc2VsZWN0RXh0ZW5zaW9ucyBwcm92aWRlcyBhIHdheSBmb3IgU0VMRUNUcy9PUFRJT05zIHRvIGhhdmUgdmFsdWVzCiAgICAvLyB0aGF0IGFyZSBhcmJpdHJhcnkgb2JqZWN0cy4gVGhpcyBpcyB2ZXJ5IGNvbnZlbmllbnQgd2hlbiBpbXBsZW1lbnRpbmcgdGhpbmdzIGxpa2UgY2FzY2FkaW5nIGRyb3Bkb3ducy4KICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMgPSB7CiAgICAgICAgcmVhZFZhbHVlIDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewogICAgICAgICAgICAgICAgY2FzZSAnb3B0aW9uJzoKICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9PT0gdHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpOwogICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5zZWxlY3RlZEluZGV4ID49IDAgPyBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50Lm9wdGlvbnNbZWxlbWVudC5zZWxlY3RlZEluZGV4XSkgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgd3JpdGVWYWx1ZTogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICAgICAgc3dpdGNoIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ29wdGlvbic6CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICAgICAgICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQoZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzLm9wdGlvbnMub3B0aW9uVmFsdWVEb21EYXRhS2V5LCB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0RvbURhdGFFeHBhbmRvUHJvcGVydHkgaW4gZWxlbWVudCkgeyAvLyBJRSA8PSA4IHRocm93cyBlcnJvcnMgaWYgeW91IGRlbGV0ZSBub24tZXhpc3RlbnQgcHJvcGVydGllcyBmcm9tIGEgRE9NIG5vZGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcmUgYXJiaXRyYXJ5IG9iamVjdCB1c2luZyBEb21EYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnMub3B0aW9ucy5vcHRpb25WYWx1ZURvbURhdGFLZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eV0gPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwZWNpYWwgdHJlYXRtZW50IG9mIG51bWJlcnMgaXMganVzdCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eS4gS08gMS4yLjEgd3JvdGUgbnVtZXJpY2FsIHZhbHVlcyB0byBlbGVtZW50LnZhbHVlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgPyB2YWx1ZSA6ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gZWxlbWVudC5vcHRpb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50Lm9wdGlvbnNbaV0pID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNlbGVjdGVkSW5kZXggPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGlmICgodmFsdWUgPT09IG51bGwpIHx8ICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSkKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAiIjsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zJywga28uc2VsZWN0RXh0ZW5zaW9ucyk7CmtvLmV4cG9ydFN5bWJvbCgnc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUnLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZSk7CmtvLmV4cG9ydFN5bWJvbCgnc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlJywga28uc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlKTsKCmtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciByZXN0b3JlQ2FwdHVyZWRUb2tlbnNSZWdleCA9IC9cQGtvX3Rva2VuXyhcZCspXEAvZzsKICAgIHZhciBqYXZhU2NyaXB0QXNzaWdubWVudFRhcmdldCA9IC9eW1xfJGEtel1bXF8kYS16MC05XSooXFsuKj9cXSkqKFwuW1xfJGEtel1bXF8kYS16MC05XSooXFsuKj9cXSkqKSokL2k7CiAgICB2YXIgamF2YVNjcmlwdFJlc2VydmVkV29yZHMgPSBbInRydWUiLCAiZmFsc2UiXTsKCiAgICBmdW5jdGlvbiByZXN0b3JlVG9rZW5zKHN0cmluZywgdG9rZW5zKSB7CiAgICAgICAgdmFyIHByZXZWYWx1ZSA9IG51bGw7CiAgICAgICAgd2hpbGUgKHN0cmluZyAhPSBwcmV2VmFsdWUpIHsgLy8gS2VlcCByZXN0b3JpbmcgdG9rZW5zIHVudGlsIGl0IG5vIGxvbmdlciBtYWtlcyBhIGRpZmZlcmVuY2UgKHRoZXkgbWF5IGJlIG5lc3RlZCkKICAgICAgICAgICAgcHJldlZhbHVlID0gc3RyaW5nOwogICAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShyZXN0b3JlQ2FwdHVyZWRUb2tlbnNSZWdleCwgZnVuY3Rpb24gKG1hdGNoLCB0b2tlbkluZGV4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW5zW3Rva2VuSW5kZXhdOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgIH0KCiAgICBmdW5jdGlvbiBpc1dyaXRlYWJsZVZhbHVlKGV4cHJlc3Npb24pIHsKICAgICAgICBpZiAoa28udXRpbHMuYXJyYXlJbmRleE9mKGphdmFTY3JpcHRSZXNlcnZlZFdvcmRzLCBrby51dGlscy5zdHJpbmdUcmltKGV4cHJlc3Npb24pLnRvTG93ZXJDYXNlKCkpID49IDApCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICByZXR1cm4gZXhwcmVzc2lvbi5tYXRjaChqYXZhU2NyaXB0QXNzaWdubWVudFRhcmdldCkgIT09IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gZW5zdXJlUXVvdGVkKGtleSkgewogICAgICAgIHZhciB0cmltbWVkS2V5ID0ga28udXRpbHMuc3RyaW5nVHJpbShrZXkpOwogICAgICAgIHN3aXRjaCAodHJpbW1lZEtleS5sZW5ndGggJiYgdHJpbW1lZEtleS5jaGFyQXQoMCkpIHsKICAgICAgICAgICAgY2FzZSAiJyI6CiAgICAgICAgICAgIGNhc2UgJyInOgogICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiAiJyIgKyB0cmltbWVkS2V5ICsgIiciOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIGJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yczogW10sCgogICAgICAgIHBhcnNlT2JqZWN0TGl0ZXJhbDogZnVuY3Rpb24ob2JqZWN0TGl0ZXJhbFN0cmluZykgewogICAgICAgICAgICAvLyBBIGZ1bGwgdG9rZW5pc2VyK2xleGVyIHdvdWxkIGFkZCB0b28gbXVjaCB3ZWlnaHQgdG8gdGhpcyBsaWJyYXJ5LCBzbyBoZXJlJ3MgYSBzaW1wbGUgcGFyc2VyCiAgICAgICAgICAgIC8vIHRoYXQgaXMgc3VmZmljaWVudCBqdXN0IHRvIHNwbGl0IGFuIG9iamVjdCBsaXRlcmFsIHN0cmluZyBpbnRvIGEgc2V0IG9mIHRvcC1sZXZlbCBrZXktdmFsdWUgcGFpcnMKCiAgICAgICAgICAgIHZhciBzdHIgPSBrby51dGlscy5zdHJpbmdUcmltKG9iamVjdExpdGVyYWxTdHJpbmcpOwogICAgICAgICAgICBpZiAoc3RyLmxlbmd0aCA8IDMpCiAgICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgIGlmIChzdHIuY2hhckF0KDApID09PSAieyIpLy8gSWdub3JlIGFueSBicmFjZXMgc3Vycm91bmRpbmcgdGhlIHdob2xlIG9iamVjdCBsaXRlcmFsCiAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyaW5nKDEsIHN0ci5sZW5ndGggLSAxKTsKCiAgICAgICAgICAgIC8vIFB1bGwgb3V0IGFueSBzdHJpbmcgbGl0ZXJhbHMgYW5kIHJlZ2V4IGxpdGVyYWxzCiAgICAgICAgICAgIHZhciB0b2tlbnMgPSBbXTsKICAgICAgICAgICAgdmFyIHRva2VuU3RhcnQgPSBudWxsLCB0b2tlbkVuZENoYXI7CiAgICAgICAgICAgIGZvciAodmFyIHBvc2l0aW9uID0gMDsgcG9zaXRpb24gPCBzdHIubGVuZ3RoOyBwb3NpdGlvbisrKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IHN0ci5jaGFyQXQocG9zaXRpb24pOwogICAgICAgICAgICAgICAgaWYgKHRva2VuU3RhcnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnIic6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIiciOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICIvIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuU3RhcnQgPSBwb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuRW5kQ2hhciA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChjID09IHRva2VuRW5kQ2hhcikgJiYgKHN0ci5jaGFyQXQocG9zaXRpb24gLSAxKSAhPT0gIlxcIikpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBzdHIuc3Vic3RyaW5nKHRva2VuU3RhcnQsIHBvc2l0aW9uICsgMSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHZhciByZXBsYWNlbWVudCA9ICJAa29fdG9rZW5fIiArICh0b2tlbnMubGVuZ3RoIC0gMSkgKyAiQCI7CiAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygwLCB0b2tlblN0YXJ0KSArIHJlcGxhY2VtZW50ICsgc3RyLnN1YnN0cmluZyhwb3NpdGlvbiArIDEpOwogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uIC09ICh0b2tlbi5sZW5ndGggLSByZXBsYWNlbWVudC5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgIHRva2VuU3RhcnQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOZXh0IHB1bGwgb3V0IGJhbGFuY2VkIHBhcmVuLCBicmFjZSwgYW5kIGJyYWNrZXQgYmxvY2tzCiAgICAgICAgICAgIHRva2VuU3RhcnQgPSBudWxsOwogICAgICAgICAgICB0b2tlbkVuZENoYXIgPSBudWxsOwogICAgICAgICAgICB2YXIgdG9rZW5EZXB0aCA9IDAsIHRva2VuU3RhcnRDaGFyID0gbnVsbDsKICAgICAgICAgICAgZm9yICh2YXIgcG9zaXRpb24gPSAwOyBwb3NpdGlvbiA8IHN0ci5sZW5ndGg7IHBvc2l0aW9uKyspIHsKICAgICAgICAgICAgICAgIHZhciBjID0gc3RyLmNoYXJBdChwb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAodG9rZW5TdGFydCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoYykgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJ7IjogdG9rZW5TdGFydCA9IHBvc2l0aW9uOyB0b2tlblN0YXJ0Q2hhciA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbkVuZENoYXIgPSAifSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiKCI6IHRva2VuU3RhcnQgPSBwb3NpdGlvbjsgdG9rZW5TdGFydENoYXIgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gIikiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIlsiOiB0b2tlblN0YXJ0ID0gcG9zaXRpb247IHRva2VuU3RhcnRDaGFyID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuRW5kQ2hhciA9ICJdIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYyA9PT0gdG9rZW5TdGFydENoYXIpCiAgICAgICAgICAgICAgICAgICAgdG9rZW5EZXB0aCsrOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoYyA9PT0gdG9rZW5FbmRDaGFyKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5EZXB0aC0tOwogICAgICAgICAgICAgICAgICAgIGlmICh0b2tlbkRlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHN0ci5zdWJzdHJpbmcodG9rZW5TdGFydCwgcG9zaXRpb24gKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVwbGFjZW1lbnQgPSAiQGtvX3Rva2VuXyIgKyAodG9rZW5zLmxlbmd0aCAtIDEpICsgIkAiOwogICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyaW5nKDAsIHRva2VuU3RhcnQpICsgcmVwbGFjZW1lbnQgKyBzdHIuc3Vic3RyaW5nKHBvc2l0aW9uICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uIC09ICh0b2tlbi5sZW5ndGggLSByZXBsYWNlbWVudC5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICB0b2tlblN0YXJ0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5vdyB3ZSBjYW4gc2FmZWx5IHNwbGl0IG9uIGNvbW1hcyB0byBnZXQgdGhlIGtleS92YWx1ZSBwYWlycwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIHZhciBrZXlWYWx1ZVBhaXJzID0gc3RyLnNwbGl0KCIsIik7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0ga2V5VmFsdWVQYWlycy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBwYWlyID0ga2V5VmFsdWVQYWlyc1tpXTsKICAgICAgICAgICAgICAgIHZhciBjb2xvblBvcyA9IHBhaXIuaW5kZXhPZigiOiIpOwogICAgICAgICAgICAgICAgaWYgKChjb2xvblBvcyA+IDApICYmIChjb2xvblBvcyA8IHBhaXIubGVuZ3RoIC0gMSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gcGFpci5zdWJzdHJpbmcoMCwgY29sb25Qb3MpOwogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHBhaXIuc3Vic3RyaW5nKGNvbG9uUG9zICsgMSk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goeyAna2V5JzogcmVzdG9yZVRva2VucyhrZXksIHRva2VucyksICd2YWx1ZSc6IHJlc3RvcmVUb2tlbnModmFsdWUsIHRva2VucykgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHsgJ3Vua25vd24nOiByZXN0b3JlVG9rZW5zKHBhaXIsIHRva2VucykgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBpbnNlcnRQcm9wZXJ0eUFjY2Vzc29yc0ludG9Kc29uOiBmdW5jdGlvbiAob2JqZWN0TGl0ZXJhbFN0cmluZ09yS2V5VmFsdWVBcnJheSkgewogICAgICAgICAgICB2YXIga2V5VmFsdWVBcnJheSA9IHR5cGVvZiBvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5ID09PSAic3RyaW5nIgogICAgICAgICAgICAgICAgPyBrby5qc29uRXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwob2JqZWN0TGl0ZXJhbFN0cmluZ09yS2V5VmFsdWVBcnJheSkKICAgICAgICAgICAgICAgIDogb2JqZWN0TGl0ZXJhbFN0cmluZ09yS2V5VmFsdWVBcnJheTsKICAgICAgICAgICAgdmFyIHJlc3VsdFN0cmluZ3MgPSBbXSwgcHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MgPSBbXTsKCiAgICAgICAgICAgIHZhciBrZXlWYWx1ZUVudHJ5OwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsga2V5VmFsdWVFbnRyeSA9IGtleVZhbHVlQXJyYXlbaV07IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHJlc3VsdFN0cmluZ3MubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2goIiwiKTsKCiAgICAgICAgICAgICAgICBpZiAoa2V5VmFsdWVFbnRyeVsna2V5J10pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcXVvdGVkS2V5ID0gZW5zdXJlUXVvdGVkKGtleVZhbHVlRW50cnlbJ2tleSddKSwgdmFsID0ga2V5VmFsdWVFbnRyeVsndmFsdWUnXTsKICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2gocXVvdGVkS2V5KTsKICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2goIjoiKTsKICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2godmFsKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzV3JpdGVhYmxlVmFsdWUoa28udXRpbHMuc3RyaW5nVHJpbSh2YWwpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLnB1c2goIiwgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLnB1c2gocXVvdGVkS2V5ICsgIiA6IGZ1bmN0aW9uKF9fa29fdmFsdWUpIHsgIiArIHZhbCArICIgPSBfX2tvX3ZhbHVlOyB9Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXlWYWx1ZUVudHJ5Wyd1bmtub3duJ10pIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmdzLnB1c2goa2V5VmFsdWVFbnRyeVsndW5rbm93biddKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNvbWJpbmVkUmVzdWx0ID0gcmVzdWx0U3RyaW5ncy5qb2luKCIiKTsKICAgICAgICAgICAgaWYgKHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBhbGxQcm9wZXJ0eUFjY2Vzc29ycyA9IHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmpvaW4oIiIpOwogICAgICAgICAgICAgICAgY29tYmluZWRSZXN1bHQgPSBjb21iaW5lZFJlc3VsdCArICIsICdfa29fcHJvcGVydHlfd3JpdGVycycgOiB7ICIgKyBhbGxQcm9wZXJ0eUFjY2Vzc29ycyArICIgfSAiOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gY29tYmluZWRSZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAga2V5VmFsdWVBcnJheUNvbnRhaW5zS2V5OiBmdW5jdGlvbihrZXlWYWx1ZUFycmF5LCBrZXkpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZUFycmF5Lmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLnN0cmluZ1RyaW0oa2V5VmFsdWVBcnJheVtpXVsna2V5J10pID09IGtleSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8vIEludGVybmFsLCBwcml2YXRlIEtPIHV0aWxpdHkgZm9yIHVwZGF0aW5nIG1vZGVsIHByb3BlcnRpZXMgZnJvbSB3aXRoaW4gYmluZGluZ3MKICAgICAgICAvLyBwcm9wZXJ0eTogICAgICAgICAgICBJZiB0aGUgcHJvcGVydHkgYmVpbmcgdXBkYXRlZCBpcyAob3IgbWlnaHQgYmUpIGFuIG9ic2VydmFibGUsIHBhc3MgaXQgaGVyZQogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIElmIGl0IHR1cm5zIG91dCB0byBiZSBhIHdyaXRhYmxlIG9ic2VydmFibGUsIGl0IHdpbGwgYmUgd3JpdHRlbiB0byBkaXJlY3RseQogICAgICAgIC8vIGFsbEJpbmRpbmdzQWNjZXNzb3I6IEFsbCBiaW5kaW5ncyBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gY29udGV4dC4KICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICBUaGlzIHdpbGwgYmUgc2VhcmNoZWQgZm9yIGEgJ19rb19wcm9wZXJ0eV93cml0ZXJzJyBwcm9wZXJ0eSBpbiBjYXNlIHlvdSdyZSB3cml0aW5nIHRvIGEgbm9uLW9ic2VydmFibGUKICAgICAgICAvLyBrZXk6ICAgICAgICAgICAgICAgICBUaGUga2V5IGlkZW50aWZ5aW5nIHRoZSBwcm9wZXJ0eSB0byBiZSB3cml0dGVuLiBFeGFtcGxlOiBmb3IgeyBoYXNGb2N1czogbXlWYWx1ZSB9LCB3cml0ZSB0byAnbXlWYWx1ZScgYnkgc3BlY2lmeWluZyB0aGUga2V5ICdoYXNGb2N1cycKICAgICAgICAvLyB2YWx1ZTogICAgICAgICAgICAgICBUaGUgdmFsdWUgdG8gYmUgd3JpdHRlbgogICAgICAgIC8vIGNoZWNrSWZEaWZmZXJlbnQ6ICAgIElmIHRydWUsIGFuZCBpZiB0aGUgcHJvcGVydHkgYmVpbmcgd3JpdHRlbiBpcyBhIHdyaXRhYmxlIG9ic2VydmFibGUsIHRoZSB2YWx1ZSB3aWxsIG9ubHkgYmUgd3JpdHRlbiBpZgogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIGl0IGlzICE9PSBleGlzdGluZyB2YWx1ZSBvbiB0aGF0IHdyaXRhYmxlIG9ic2VydmFibGUKICAgICAgICB3cml0ZVZhbHVlVG9Qcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHksIGFsbEJpbmRpbmdzQWNjZXNzb3IsIGtleSwgdmFsdWUsIGNoZWNrSWZEaWZmZXJlbnQpIHsKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eSB8fCAha28uaXNXcml0ZWFibGVPYnNlcnZhYmxlKHByb3BlcnR5KSkgewogICAgICAgICAgICAgICAgdmFyIHByb3BXcml0ZXJzID0gYWxsQmluZGluZ3NBY2Nlc3NvcigpWydfa29fcHJvcGVydHlfd3JpdGVycyddOwogICAgICAgICAgICAgICAgaWYgKHByb3BXcml0ZXJzICYmIHByb3BXcml0ZXJzW2tleV0pCiAgICAgICAgICAgICAgICAgICAgcHJvcFdyaXRlcnNba2V5XSh2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWNoZWNrSWZEaWZmZXJlbnQgfHwgcHJvcGVydHkoKSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgIHByb3BlcnR5KHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ2pzb25FeHByZXNzaW9uUmV3cml0aW5nJywga28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcpOwprby5leHBvcnRTeW1ib2woJ2pzb25FeHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9ycycsIGtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9ycyk7CmtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsJywga28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKTsKa28uZXhwb3J0U3ltYm9sKCdqc29uRXhwcmVzc2lvblJld3JpdGluZy5pbnNlcnRQcm9wZXJ0eUFjY2Vzc29yc0ludG9Kc29uJywga28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcuaW5zZXJ0UHJvcGVydHlBY2Nlc3NvcnNJbnRvSnNvbik7CihmdW5jdGlvbigpIHsKICAgIC8vICJWaXJ0dWFsIGVsZW1lbnRzIiBpcyBhbiBhYnN0cmFjdGlvbiBvbiB0b3Agb2YgdGhlIHVzdWFsIERPTSBBUEkgd2hpY2ggdW5kZXJzdGFuZHMgdGhlIG5vdGlvbiB0aGF0IGNvbW1lbnQgbm9kZXMKICAgIC8vIG1heSBiZSB1c2VkIHRvIHJlcHJlc2VudCBoaWVyYXJjaHkgKGluIGFkZGl0aW9uIHRvIHRoZSBET00ncyBuYXR1cmFsIGhpZXJhcmNoeSkuCiAgICAvLyBJZiB5b3UgY2FsbCB0aGUgRE9NLW1hbmlwdWxhdGluZyBmdW5jdGlvbnMgb24ga28udmlydHVhbEVsZW1lbnRzLCB5b3Ugd2lsbCBiZSBhYmxlIHRvIHJlYWQgYW5kIHdyaXRlIHRoZSBzdGF0ZQogICAgLy8gb2YgdGhhdCB2aXJ0dWFsIGhpZXJhcmNoeQogICAgLy8KICAgIC8vIFRoZSBwb2ludCBvZiBhbGwgdGhpcyBpcyB0byBzdXBwb3J0IGNvbnRhaW5lcmxlc3MgdGVtcGxhdGVzIChlLmcuLCA8IS0tIGtvIGZvcmVhY2g6c29tZUNvbGxlY3Rpb24gLS0+YmxhaDwhLS0gL2tvIC0tPikKICAgIC8vIHdpdGhvdXQgaGF2aW5nIHRvIHNjYXR0ZXIgc3BlY2lhbCBjYXNlcyBhbGwgb3ZlciB0aGUgYmluZGluZyBhbmQgdGVtcGxhdGluZyBjb2RlLgoKICAgIC8vIElFIDkgY2Fubm90IHJlbGlhYmx5IHJlYWQgdGhlICJub2RlVmFsdWUiIHByb3BlcnR5IG9mIGEgY29tbWVudCBub2RlIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xODYpCiAgICAvLyBidXQgaXQgZG9lcyBnaXZlIHRoZW0gYSBub25zdGFuZGFyZCBhbHRlcm5hdGl2ZSBwcm9wZXJ0eSBjYWxsZWQgInRleHQiIHRoYXQgaXQgY2FuIHJlYWQgcmVsaWFibHkuIE90aGVyIGJyb3dzZXJzIGRvbid0IGhhdmUgdGhhdCBwcm9wZXJ0eS4KICAgIC8vIFNvLCB1c2Ugbm9kZS50ZXh0IHdoZXJlIGF2YWlsYWJsZSwgYW5kIG5vZGUubm9kZVZhbHVlIGVsc2V3aGVyZQogICAgdmFyIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCJ0ZXN0IikudGV4dCA9PT0gIjwhLS10ZXN0LS0+IjsKCiAgICB2YXIgc3RhcnRDb21tZW50UmVnZXggPSBjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gL148IS0tXHMqa29ccysoLipcOi4qKVxzKi0tPiQvIDogL15ccyprb1xzKyguKlw6LiopXHMqJC87CiAgICB2YXIgZW5kQ29tbWVudFJlZ2V4ID0gICBjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gL148IS0tXHMqXC9rb1xzKi0tPiQvIDogL15ccypcL2tvXHMqJC87CiAgICB2YXIgaHRtbFRhZ3NXaXRoT3B0aW9uYWxseUNsb3NpbmdDaGlsZHJlbiA9IHsgJ3VsJzogdHJ1ZSwgJ29sJzogdHJ1ZSB9OwoKICAgIGZ1bmN0aW9uIGlzU3RhcnRDb21tZW50KG5vZGUpIHsKICAgICAgICByZXR1cm4gKG5vZGUubm9kZVR5cGUgPT0gOCkgJiYgKGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyBub2RlLnRleHQgOiBub2RlLm5vZGVWYWx1ZSkubWF0Y2goc3RhcnRDb21tZW50UmVnZXgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzRW5kQ29tbWVudChub2RlKSB7CiAgICAgICAgcmV0dXJuIChub2RlLm5vZGVUeXBlID09IDgpICYmIChjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gbm9kZS50ZXh0IDogbm9kZS5ub2RlVmFsdWUpLm1hdGNoKGVuZENvbW1lbnRSZWdleCk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VmlydHVhbENoaWxkcmVuKHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKSB7CiAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gc3RhcnRDb21tZW50OwogICAgICAgIHZhciBkZXB0aCA9IDE7CiAgICAgICAgdmFyIGNoaWxkcmVuID0gW107CiAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgaWYgKGlzRW5kQ29tbWVudChjdXJyZW50Tm9kZSkpIHsKICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjaGlsZHJlbi5wdXNoKGN1cnJlbnROb2RlKTsKCiAgICAgICAgICAgIGlmIChpc1N0YXJ0Q29tbWVudChjdXJyZW50Tm9kZSkpCiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgIH0KICAgICAgICBpZiAoIWFsbG93VW5iYWxhbmNlZCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCBjbG9zaW5nIGNvbW1lbnQgdGFnIHRvIG1hdGNoOiAiICsgc3RhcnRDb21tZW50Lm5vZGVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKSB7CiAgICAgICAgdmFyIGFsbFZpcnR1YWxDaGlsZHJlbiA9IGdldFZpcnR1YWxDaGlsZHJlbihzdGFydENvbW1lbnQsIGFsbG93VW5iYWxhbmNlZCk7CiAgICAgICAgaWYgKGFsbFZpcnR1YWxDaGlsZHJlbikgewogICAgICAgICAgICBpZiAoYWxsVmlydHVhbENoaWxkcmVuLmxlbmd0aCA+IDApCiAgICAgICAgICAgICAgICByZXR1cm4gYWxsVmlydHVhbENoaWxkcmVuW2FsbFZpcnR1YWxDaGlsZHJlbi5sZW5ndGggLSAxXS5uZXh0U2libGluZzsKICAgICAgICAgICAgcmV0dXJuIHN0YXJ0Q29tbWVudC5uZXh0U2libGluZzsKICAgICAgICB9IGVsc2UKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIE11c3QgaGF2ZSBubyBtYXRjaGluZyBlbmQgY29tbWVudCwgYW5kIGFsbG93VW5iYWxhbmNlZCBpcyB0cnVlCiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VW5iYWxhbmNlZENoaWxkVGFncyhub2RlKSB7CiAgICAgICAgLy8gZS5nLiwgZnJvbSA8ZGl2Pk9LPC9kaXY+PCEtLSBrbyBibGFoIC0tPjxzcGFuPkFub3RoZXI8L3NwYW4+LCByZXR1cm5zOiA8IS0tIGtvIGJsYWggLS0+PHNwYW4+QW5vdGhlcjwvc3Bhbj4KICAgICAgICAvLyAgICAgICBmcm9tIDxkaXY+T0s8L2Rpdj48IS0tIC9rbyAtLT48IS0tIC9rbyAtLT4sICAgICAgICAgICAgIHJldHVybnM6IDwhLS0gL2tvIC0tPjwhLS0gL2tvIC0tPgogICAgICAgIHZhciBjaGlsZE5vZGUgPSBub2RlLmZpcnN0Q2hpbGQsIGNhcHR1cmVSZW1haW5pbmcgPSBudWxsOwogICAgICAgIGlmIChjaGlsZE5vZGUpIHsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgaWYgKGNhcHR1cmVSZW1haW5pbmcpICAgICAgICAgICAgICAgICAgIC8vIFdlIGFscmVhZHkgaGl0IGFuIHVuYmFsYW5jZWQgbm9kZSBhbmQgYXJlIG5vdyBqdXN0IHNjb29waW5nIHVwIGFsbCBzdWJzZXF1ZW50IG5vZGVzCiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZVJlbWFpbmluZy5wdXNoKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChpc1N0YXJ0Q29tbWVudChjaGlsZE5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoaW5nRW5kQ29tbWVudCA9IGdldE1hdGNoaW5nRW5kQ29tbWVudChjaGlsZE5vZGUsIC8qIGFsbG93VW5iYWxhbmNlZDogKi8gdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoaW5nRW5kQ29tbWVudCkgICAgICAgICAgICAgLy8gSXQncyBhIGJhbGFuY2VkIHRhZywgc28gc2tpcCBpbW1lZGlhdGVseSB0byB0aGUgZW5kIG9mIHRoaXMgdmlydHVhbCBzZXQKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlID0gbWF0Y2hpbmdFbmRDb21tZW50OwogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZVJlbWFpbmluZyA9IFtjaGlsZE5vZGVdOyAvLyBJdCdzIHVuYmFsYW5jZWQsIHNvIHN0YXJ0IGNhcHR1cmluZyBmcm9tIHRoaXMgcG9pbnQKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFbmRDb21tZW50KGNoaWxkTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nID0gW2NoaWxkTm9kZV07ICAgICAvLyBJdCdzIHVuYmFsYW5jZWQgKGlmIGl0IHdhc24ndCwgd2UnZCBoYXZlIHNraXBwZWQgb3ZlciBpdCBhbHJlYWR5KSwgc28gc3RhcnQgY2FwdHVyaW5nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYXB0dXJlUmVtYWluaW5nOwogICAgfQoKICAgIGtvLnZpcnR1YWxFbGVtZW50cyA9IHsKICAgICAgICBhbGxvd2VkQmluZGluZ3M6IHt9LAoKICAgICAgICBjaGlsZE5vZGVzOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBpc1N0YXJ0Q29tbWVudChub2RlKSA/IGdldFZpcnR1YWxDaGlsZHJlbihub2RlKSA6IG5vZGUuY2hpbGROb2RlczsKICAgICAgICB9LAoKICAgICAgICBlbXB0eU5vZGU6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKICAgICAgICAgICAgICAgIGtvLnV0aWxzLmVtcHR5RG9tTm9kZShub2RlKTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdmlydHVhbENoaWxkcmVuID0ga28udmlydHVhbEVsZW1lbnRzLmNoaWxkTm9kZXMobm9kZSk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHZpcnR1YWxDaGlsZHJlbi5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICAgICAga28ucmVtb3ZlTm9kZSh2aXJ0dWFsQ2hpbGRyZW5baV0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgc2V0RG9tTm9kZUNoaWxkcmVuOiBmdW5jdGlvbihub2RlLCBjaGlsZE5vZGVzKSB7CiAgICAgICAgICAgIGlmICghaXNTdGFydENvbW1lbnQobm9kZSkpCiAgICAgICAgICAgICAgICBrby51dGlscy5zZXREb21Ob2RlQ2hpbGRyZW4obm9kZSwgY2hpbGROb2Rlcyk7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShub2RlKTsKICAgICAgICAgICAgICAgIHZhciBlbmRDb21tZW50Tm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7IC8vIE11c3QgYmUgdGhlIG5leHQgc2libGluZywgYXMgd2UganVzdCBlbXB0aWVkIHRoZSBjaGlsZHJlbgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBjaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBlbmRDb21tZW50Tm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShjaGlsZE5vZGVzW2ldLCBlbmRDb21tZW50Tm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBwcmVwZW5kOiBmdW5jdGlvbihjb250YWluZXJOb2RlLCBub2RlVG9QcmVwZW5kKSB7CiAgICAgICAgICAgIGlmICghaXNTdGFydENvbW1lbnQoY29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgICAgIGlmIChjb250YWluZXJOb2RlLmZpcnN0Q2hpbGQpCiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyTm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvUHJlcGVuZCwgY29udGFpbmVyTm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmFwcGVuZENoaWxkKG5vZGVUb1ByZXBlbmQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gU3RhcnQgY29tbWVudHMgbXVzdCBhbHdheXMgaGF2ZSBhIHBhcmVudCBhbmQgYXQgbGVhc3Qgb25lIGZvbGxvd2luZyBzaWJsaW5nICh0aGUgZW5kIGNvbW1lbnQpCiAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb1ByZXBlbmQsIGNvbnRhaW5lck5vZGUubmV4dFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgaW5zZXJ0QWZ0ZXI6IGZ1bmN0aW9uKGNvbnRhaW5lck5vZGUsIG5vZGVUb0luc2VydCwgaW5zZXJ0QWZ0ZXJOb2RlKSB7CiAgICAgICAgICAgIGlmICghaXNTdGFydENvbW1lbnQoY29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgICAgIC8vIEluc2VydCBhZnRlciBpbnNlcnRpb24gcG9pbnQKICAgICAgICAgICAgICAgIGlmIChpbnNlcnRBZnRlck5vZGUubmV4dFNpYmxpbmcpCiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyTm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUubmV4dFNpYmxpbmcpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuYXBwZW5kQ2hpbGQobm9kZVRvSW5zZXJ0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIENoaWxkcmVuIG9mIHN0YXJ0IGNvbW1lbnRzIG11c3QgYWx3YXlzIGhhdmUgYSBwYXJlbnQgYW5kIGF0IGxlYXN0IG9uZSBmb2xsb3dpbmcgc2libGluZyAodGhlIGVuZCBjb21tZW50KQogICAgICAgICAgICAgICAgY29udGFpbmVyTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShub2RlVG9JbnNlcnQsIGluc2VydEFmdGVyTm9kZS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBmaXJzdENoaWxkOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIGlmICghaXNTdGFydENvbW1lbnQobm9kZSkpCiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgICBpZiAoIW5vZGUubmV4dFNpYmxpbmcgfHwgaXNFbmRDb21tZW50KG5vZGUubmV4dFNpYmxpbmcpKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwogICAgICAgIH0sCgogICAgICAgIG5leHRTaWJsaW5nOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIGlmIChpc1N0YXJ0Q29tbWVudChub2RlKSkKICAgICAgICAgICAgICAgIG5vZGUgPSBnZXRNYXRjaGluZ0VuZENvbW1lbnQobm9kZSk7CiAgICAgICAgICAgIGlmIChub2RlLm5leHRTaWJsaW5nICYmIGlzRW5kQ29tbWVudChub2RlLm5leHRTaWJsaW5nKSkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKICAgICAgICB9LAoKICAgICAgICB2aXJ0dWFsTm9kZUJpbmRpbmdWYWx1ZTogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICB2YXIgcmVnZXhNYXRjaCA9IGlzU3RhcnRDb21tZW50KG5vZGUpOwogICAgICAgICAgICByZXR1cm4gcmVnZXhNYXRjaCA/IHJlZ2V4TWF0Y2hbMV0gOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIG5vcm1hbGlzZVZpcnR1YWxFbGVtZW50RG9tU3RydWN0dXJlOiBmdW5jdGlvbihlbGVtZW50VmVyaWZpZWQpIHsKICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xNTUKICAgICAgICAgICAgLy8gKElFIDw9IDggb3IgSUUgOSBxdWlya3MgbW9kZSBwYXJzZXMgeW91ciBIVE1MIHdlaXJkbHksIHRyZWF0aW5nIGNsb3NpbmcgPC9saT4gdGFncyBhcyBpZiB0aGV5IGRvbid0IGV4aXN0LCB0aGVyZWJ5IG1vdmluZyBjb21tZW50IG5vZGVzCiAgICAgICAgICAgIC8vIHRoYXQgYXJlIGRpcmVjdCBkZXNjZW5kYW50cyBvZiA8dWw+IGludG8gdGhlIHByZWNlZGluZyA8bGk+KQogICAgICAgICAgICBpZiAoIWh0bWxUYWdzV2l0aE9wdGlvbmFsbHlDbG9zaW5nQ2hpbGRyZW5ba28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnRWZXJpZmllZCldKQogICAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gU2NhbiBpbW1lZGlhdGUgY2hpbGRyZW4gdG8gc2VlIGlmIHRoZXkgY29udGFpbiB1bmJhbGFuY2VkIGNvbW1lbnQgdGFncy4gSWYgdGhleSBkbywgdGhvc2UgY29tbWVudCB0YWdzCiAgICAgICAgICAgIC8vIG11c3QgYmUgaW50ZW5kZWQgdG8gYXBwZWFyICphZnRlciogdGhhdCBjaGlsZCwgc28gbW92ZSB0aGVtIHRoZXJlLgogICAgICAgICAgICB2YXIgY2hpbGROb2RlID0gZWxlbWVudFZlcmlmaWVkLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZE5vZGUpIHsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGROb2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1bmJhbGFuY2VkVGFncyA9IGdldFVuYmFsYW5jZWRDaGlsZFRhZ3MoY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVuYmFsYW5jZWRUYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGaXggdXAgdGhlIERPTSBieSBtb3ZpbmcgdGhlIHVuYmFsYW5jZWQgdGFncyB0byB3aGVyZSB0aGV5IG1vc3QgbGlrZWx5IHdlcmUgaW50ZW5kZWQgdG8gYmUgcGxhY2VkIC0gKmFmdGVyKiB0aGUgY2hpbGQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlVG9JbnNlcnRCZWZvcmUgPSBjaGlsZE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVuYmFsYW5jZWRUYWdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVUb0luc2VydEJlZm9yZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFZlcmlmaWVkLmluc2VydEJlZm9yZSh1bmJhbGFuY2VkVGFnc1tpXSwgbm9kZVRvSW5zZXJ0QmVmb3JlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRWZXJpZmllZC5hcHBlbmRDaGlsZCh1bmJhbGFuY2VkVGFnc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IHdoaWxlIChjaGlsZE5vZGUgPSBjaGlsZE5vZGUubmV4dFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfSkoKTsKa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMnLCBrby52aXJ0dWFsRWxlbWVudHMpOwprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3MnLCBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzKTsKa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlJywga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZSk7Ci8va28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZCcsIGtvLnZpcnR1YWxFbGVtZW50cy5maXJzdENoaWxkKTsgICAgIC8vIGZpcnN0Q2hpbGQgaXMgbm90IG1pbmlmaWVkCmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmluc2VydEFmdGVyJywga28udmlydHVhbEVsZW1lbnRzLmluc2VydEFmdGVyKTsKLy9rby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZycsIGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyk7ICAgLy8gbmV4dFNpYmxpbmcgaXMgbm90IG1pbmlmaWVkCmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLnByZXBlbmQnLCBrby52aXJ0dWFsRWxlbWVudHMucHJlcGVuZCk7CmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbicsIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4pOwooZnVuY3Rpb24oKSB7CiAgICB2YXIgZGVmYXVsdEJpbmRpbmdBdHRyaWJ1dGVOYW1lID0gImRhdGEtYmluZCI7CgogICAga28uYmluZGluZ1Byb3ZpZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5iaW5kaW5nQ2FjaGUgPSB7fTsKICAgIH07CgogICAga28udXRpbHMuZXh0ZW5kKGtvLmJpbmRpbmdQcm92aWRlci5wcm90b3R5cGUsIHsKICAgICAgICAnbm9kZUhhc0JpbmRpbmdzJzogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZVR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgMTogcmV0dXJuIG5vZGUuZ2V0QXR0cmlidXRlKGRlZmF1bHRCaW5kaW5nQXR0cmlidXRlTmFtZSkgIT0gbnVsbDsgICAvLyBFbGVtZW50CiAgICAgICAgICAgICAgICBjYXNlIDg6IHJldHVybiBrby52aXJ0dWFsRWxlbWVudHMudmlydHVhbE5vZGVCaW5kaW5nVmFsdWUobm9kZSkgIT0gbnVsbDsgLy8gQ29tbWVudCBub2RlCiAgICAgICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAnZ2V0QmluZGluZ3MnOiBmdW5jdGlvbihub2RlLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICB2YXIgYmluZGluZ3NTdHJpbmcgPSB0aGlzWydnZXRCaW5kaW5nc1N0cmluZyddKG5vZGUsIGJpbmRpbmdDb250ZXh0KTsKICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmdzU3RyaW5nID8gdGhpc1sncGFyc2VCaW5kaW5nc1N0cmluZyddKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCkgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gaXMgb25seSB1c2VkIGludGVybmFsbHkgYnkgdGhpcyBkZWZhdWx0IHByb3ZpZGVyLgogICAgICAgIC8vIEl0J3Mgbm90IHBhcnQgb2YgdGhlIGludGVyZmFjZSBkZWZpbml0aW9uIGZvciBhIGdlbmVyYWwgYmluZGluZyBwcm92aWRlci4KICAgICAgICAnZ2V0QmluZGluZ3NTdHJpbmcnOiBmdW5jdGlvbihub2RlLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZVR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgMTogcmV0dXJuIG5vZGUuZ2V0QXR0cmlidXRlKGRlZmF1bHRCaW5kaW5nQXR0cmlidXRlTmFtZSk7ICAgLy8gRWxlbWVudAogICAgICAgICAgICAgICAgY2FzZSA4OiByZXR1cm4ga28udmlydHVhbEVsZW1lbnRzLnZpcnR1YWxOb2RlQmluZGluZ1ZhbHVlKG5vZGUpOyAvLyBDb21tZW50IG5vZGUKICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBpcyBvbmx5IHVzZWQgaW50ZXJuYWxseSBieSB0aGlzIGRlZmF1bHQgcHJvdmlkZXIuCiAgICAgICAgLy8gSXQncyBub3QgcGFydCBvZiB0aGUgaW50ZXJmYWNlIGRlZmluaXRpb24gZm9yIGEgZ2VuZXJhbCBiaW5kaW5nIHByb3ZpZGVyLgogICAgICAgICdwYXJzZUJpbmRpbmdzU3RyaW5nJzogZnVuY3Rpb24oYmluZGluZ3NTdHJpbmcsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB2YXIgdmlld01vZGVsID0gYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sCiAgICAgICAgICAgICAgICAgICAgc2NvcGVzID0gKHR5cGVvZiB2aWV3TW9kZWwgPT0gJ29iamVjdCcgJiYgdmlld01vZGVsICE9IG51bGwpID8gW3ZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRdIDogW2JpbmRpbmdDb250ZXh0XSwKICAgICAgICAgICAgICAgICAgICBiaW5kaW5nRnVuY3Rpb24gPSBjcmVhdGVCaW5kaW5nc1N0cmluZ0V2YWx1YXRvclZpYUNhY2hlKGJpbmRpbmdzU3RyaW5nLCBzY29wZXMubGVuZ3RoLCB0aGlzLmJpbmRpbmdDYWNoZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluZGluZ0Z1bmN0aW9uKHNjb3Blcyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBwYXJzZSBiaW5kaW5ncy5cbk1lc3NhZ2U6ICIgKyBleCArICI7XG5CaW5kaW5ncyB2YWx1ZTogIiArIGJpbmRpbmdzU3RyaW5nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIGtvLmJpbmRpbmdQcm92aWRlclsnaW5zdGFuY2UnXSA9IG5ldyBrby5iaW5kaW5nUHJvdmlkZXIoKTsKCiAgICBmdW5jdGlvbiBjcmVhdGVCaW5kaW5nc1N0cmluZ0V2YWx1YXRvclZpYUNhY2hlKGJpbmRpbmdzU3RyaW5nLCBzY29wZXNDb3VudCwgY2FjaGUpIHsKICAgICAgICB2YXIgY2FjaGVLZXkgPSBzY29wZXNDb3VudCArICdfJyArIGJpbmRpbmdzU3RyaW5nOwogICAgICAgIHJldHVybiBjYWNoZVtjYWNoZUtleV0KICAgICAgICAgICAgfHwgKGNhY2hlW2NhY2hlS2V5XSA9IGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yKGJpbmRpbmdzU3RyaW5nLCBzY29wZXNDb3VudCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yKGJpbmRpbmdzU3RyaW5nLCBzY29wZXNDb3VudCkgewogICAgICAgIHZhciByZXdyaXR0ZW5CaW5kaW5ncyA9ICIgeyAiICsga28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcuaW5zZXJ0UHJvcGVydHlBY2Nlc3NvcnNJbnRvSnNvbihiaW5kaW5nc1N0cmluZykgKyAiIH0gIjsKICAgICAgICByZXR1cm4ga28udXRpbHMuYnVpbGRFdmFsV2l0aGluU2NvcGVGdW5jdGlvbihyZXdyaXR0ZW5CaW5kaW5ncywgc2NvcGVzQ291bnQpOwogICAgfQp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCdiaW5kaW5nUHJvdmlkZXInLCBrby5iaW5kaW5nUHJvdmlkZXIpOwooZnVuY3Rpb24gKCkgewogICAga28uYmluZGluZ0hhbmRsZXJzID0ge307CgogICAga28uYmluZGluZ0NvbnRleHQgPSBmdW5jdGlvbihkYXRhSXRlbSwgcGFyZW50QmluZGluZ0NvbnRleHQpIHsKICAgICAgICBpZiAocGFyZW50QmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAga28udXRpbHMuZXh0ZW5kKHRoaXMsIHBhcmVudEJpbmRpbmdDb250ZXh0KTsgLy8gSW5oZXJpdCAkcm9vdCBhbmQgYW55IGN1c3RvbSBwcm9wZXJ0aWVzCiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRDb250ZXh0J10gPSBwYXJlbnRCaW5kaW5nQ29udGV4dDsKICAgICAgICAgICAgdGhpc1snJHBhcmVudCddID0gcGFyZW50QmluZGluZ0NvbnRleHRbJyRkYXRhJ107CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10gPSAocGFyZW50QmluZGluZ0NvbnRleHRbJyRwYXJlbnRzJ10gfHwgW10pLnNsaWNlKDApOwogICAgICAgICAgICB0aGlzWyckcGFyZW50cyddLnVuc2hpZnQodGhpc1snJHBhcmVudCddKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzWyckcGFyZW50cyddID0gW107CiAgICAgICAgICAgIHRoaXNbJyRyb290J10gPSBkYXRhSXRlbTsKICAgICAgICB9CiAgICAgICAgdGhpc1snJGRhdGEnXSA9IGRhdGFJdGVtOwogICAgfQogICAga28uYmluZGluZ0NvbnRleHQucHJvdG90eXBlWydjcmVhdGVDaGlsZENvbnRleHQnXSA9IGZ1bmN0aW9uIChkYXRhSXRlbSkgewogICAgICAgIHJldHVybiBuZXcga28uYmluZGluZ0NvbnRleHQoZGF0YUl0ZW0sIHRoaXMpOwogICAgfTsKICAgIGtvLmJpbmRpbmdDb250ZXh0LnByb3RvdHlwZVsnZXh0ZW5kJ10gPSBmdW5jdGlvbihwcm9wZXJ0aWVzKSB7CiAgICAgICAgdmFyIGNsb25lID0ga28udXRpbHMuZXh0ZW5kKG5ldyBrby5iaW5kaW5nQ29udGV4dCgpLCB0aGlzKTsKICAgICAgICByZXR1cm4ga28udXRpbHMuZXh0ZW5kKGNsb25lLCBwcm9wZXJ0aWVzKTsKICAgIH07CgogICAgZnVuY3Rpb24gdmFsaWRhdGVUaGF0QmluZGluZ0lzQWxsb3dlZEZvclZpcnR1YWxFbGVtZW50cyhiaW5kaW5nTmFtZSkgewogICAgICAgIHZhciB2YWxpZGF0b3IgPSBrby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzW2JpbmRpbmdOYW1lXTsKICAgICAgICBpZiAoIXZhbGlkYXRvcikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYmluZGluZyAnIiArIGJpbmRpbmdOYW1lICsgIicgY2Fubm90IGJlIHVzZWQgd2l0aCB2aXJ0dWFsIGVsZW1lbnRzIikKICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50c0ludGVybmFsICh2aWV3TW9kZWwsIGVsZW1lbnRPclZpcnR1YWxFbGVtZW50LCBiaW5kaW5nQ29udGV4dHNNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkgewogICAgICAgIHZhciBjdXJyZW50Q2hpbGQsIG5leHRJblF1ZXVlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudE9yVmlydHVhbEVsZW1lbnQpOwogICAgICAgIHdoaWxlIChjdXJyZW50Q2hpbGQgPSBuZXh0SW5RdWV1ZSkgewogICAgICAgICAgICAvLyBLZWVwIGEgcmVjb3JkIG9mIHRoZSBuZXh0IGNoaWxkICpiZWZvcmUqIGFwcGx5aW5nIGJpbmRpbmdzLCBpbiBjYXNlIHRoZSBiaW5kaW5nIHJlbW92ZXMgdGhlIGN1cnJlbnQgY2hpbGQgZnJvbSBpdHMgcG9zaXRpb24KICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcoY3VycmVudENoaWxkKTsKICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvTm9kZUFuZERlc2NlbmRhbnRzSW50ZXJuYWwodmlld01vZGVsLCBjdXJyZW50Q2hpbGQsIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gYXBwbHlCaW5kaW5nc1RvTm9kZUFuZERlc2NlbmRhbnRzSW50ZXJuYWwgKHZpZXdNb2RlbCwgbm9kZVZlcmlmaWVkLCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgdmFyIHNob3VsZEJpbmREZXNjZW5kYW50cyA9IHRydWU7CgogICAgICAgIC8vIFBlcmYgb3B0aW1pc2F0aW9uOiBBcHBseSBiaW5kaW5ncyBvbmx5IGlmLi4uCiAgICAgICAgLy8gKDEpIFdlIG5lZWQgdG8gc3RvcmUgdGhlIGJpbmRpbmcgY29udGV4dCBvbiB0aGlzIG5vZGUgKGJlY2F1c2UgaXQgbWF5IGRpZmZlciBmcm9tIHRoZSBET00gcGFyZW50IG5vZGUncyBiaW5kaW5nIGNvbnRleHQpCiAgICAgICAgLy8gICAgIE5vdGUgdGhhdCB3ZSBjYW4ndCBzdG9yZSBiaW5kaW5nIGNvbnRleHRzIG9uIG5vbi1lbGVtZW50cyAoZS5nLiwgdGV4dCBub2RlcyksIGFzIElFIGRvZXNuJ3QgYWxsb3cgZXhwYW5kbyBwcm9wZXJ0aWVzIGZvciB0aG9zZQogICAgICAgIC8vICgyKSBJdCBtaWdodCBoYXZlIGJpbmRpbmdzIChlLmcuLCBpdCBoYXMgYSBkYXRhLWJpbmQgYXR0cmlidXRlLCBvciBpdCdzIGEgbWFya2VyIGZvciBhIGNvbnRhaW5lcmxlc3MgdGVtcGxhdGUpCiAgICAgICAgdmFyIGlzRWxlbWVudCA9IChub2RlVmVyaWZpZWQubm9kZVR5cGUgPT09IDEpOwogICAgICAgIGlmIChpc0VsZW1lbnQpIC8vIFdvcmthcm91bmQgSUUgPD0gOCBIVE1MIHBhcnNpbmcgd2VpcmRuZXNzCiAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5ub3JtYWxpc2VWaXJ0dWFsRWxlbWVudERvbVN0cnVjdHVyZShub2RlVmVyaWZpZWQpOwoKICAgICAgICB2YXIgc2hvdWxkQXBwbHlCaW5kaW5ncyA9IChpc0VsZW1lbnQgJiYgYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkgICAgICAgICAgICAgLy8gQ2FzZSAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHx8IGtvLmJpbmRpbmdQcm92aWRlclsnaW5zdGFuY2UnXVsnbm9kZUhhc0JpbmRpbmdzJ10obm9kZVZlcmlmaWVkKTsgICAgICAgLy8gQ2FzZSAoMikKICAgICAgICBpZiAoc2hvdWxkQXBwbHlCaW5kaW5ncykKICAgICAgICAgICAgc2hvdWxkQmluZERlc2NlbmRhbnRzID0gYXBwbHlCaW5kaW5nc1RvTm9kZUludGVybmFsKG5vZGVWZXJpZmllZCwgbnVsbCwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KS5zaG91bGRCaW5kRGVzY2VuZGFudHM7CgogICAgICAgIGlmIChzaG91bGRCaW5kRGVzY2VuZGFudHMpIHsKICAgICAgICAgICAgLy8gV2UncmUgcmVjdXJzaW5nIGF1dG9tYXRpY2FsbHkgaW50byAocmVhbCBvciB2aXJ0dWFsKSBjaGlsZCBub2RlcyB3aXRob3V0IGNoYW5naW5nIGJpbmRpbmcgY29udGV4dHMuIFNvLAogICAgICAgICAgICAvLyAgKiBGb3IgY2hpbGRyZW4gb2YgYSAqcmVhbCogZWxlbWVudCwgdGhlIGJpbmRpbmcgY29udGV4dCBpcyBjZXJ0YWlubHkgdGhlIHNhbWUgYXMgb24gdGhlaXIgRE9NIC5wYXJlbnROb2RlLAogICAgICAgICAgICAvLyAgICBoZW5jZSBiaW5kaW5nQ29udGV4dHNNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCBpcyBmYWxzZQogICAgICAgICAgICAvLyAgKiBGb3IgY2hpbGRyZW4gb2YgYSAqdmlydHVhbCogZWxlbWVudCwgd2UgY2FuJ3QgYmUgc3VyZS4gRXZhbHVhdGluZyAucGFyZW50Tm9kZSBvbiB0aG9zZSBjaGlsZHJlbiBtYXkKICAgICAgICAgICAgLy8gICAgc2tpcCBvdmVyIGFueSBudW1iZXIgb2YgaW50ZXJtZWRpYXRlIHZpcnR1YWwgZWxlbWVudHMsIGFueSBvZiB3aGljaCBtaWdodCBkZWZpbmUgYSBjdXN0b20gYmluZGluZyBjb250ZXh0LAogICAgICAgICAgICAvLyAgICBoZW5jZSBiaW5kaW5nQ29udGV4dHNNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCBpcyB0cnVlCiAgICAgICAgICAgIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwodmlld01vZGVsLCBub2RlVmVyaWZpZWQsIC8qIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50OiAqLyAhaXNFbGVtZW50KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gYXBwbHlCaW5kaW5nc1RvTm9kZUludGVybmFsIChub2RlLCBiaW5kaW5ncywgdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCwgYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkgewogICAgICAgIC8vIE5lZWQgdG8gYmUgc3VyZSB0aGF0IGluaXRzIGFyZSBvbmx5IHJ1biBvbmNlLCBhbmQgdXBkYXRlcyBuZXZlciBydW4gdW50aWwgYWxsIHRoZSBpbml0cyBoYXZlIGJlZW4gcnVuCiAgICAgICAgdmFyIGluaXRQaGFzZSA9IDA7IC8vIDAgPSBiZWZvcmUgYWxsIGluaXRzLCAxID0gZHVyaW5nIGluaXRzLCAyID0gYWZ0ZXIgYWxsIGluaXRzCgogICAgICAgIC8vIEVhY2ggdGltZSB0aGUgZGVwZW5kZW50T2JzZXJ2YWJsZSBpcyBldmFsdWF0ZWQgKGFmdGVyIGRhdGEgY2hhbmdlcyksCiAgICAgICAgLy8gdGhlIGJpbmRpbmcgYXR0cmlidXRlIGlzIHJlcGFyc2VkIHNvIHRoYXQgaXQgY2FuIHBpY2sgb3V0IHRoZSBjb3JyZWN0CiAgICAgICAgLy8gbW9kZWwgcHJvcGVydGllcyBpbiB0aGUgY29udGV4dCBvZiB0aGUgY2hhbmdlZCBkYXRhLgogICAgICAgIC8vIERPTSBldmVudCBjYWxsYmFja3MgbmVlZCB0byBiZSBhYmxlIHRvIGFjY2VzcyB0aGlzIGNoYW5nZWQgZGF0YSwKICAgICAgICAvLyBzbyB3ZSBuZWVkIGEgc2luZ2xlIHBhcnNlZEJpbmRpbmdzIHZhcmlhYmxlIChzaGFyZWQgYnkgYWxsIGNhbGxiYWNrcwogICAgICAgIC8vIGFzc29jaWF0ZWQgd2l0aCB0aGlzIG5vZGUncyBiaW5kaW5ncykgdGhhdCBhbGwgdGhlIGNsb3N1cmVzIGNhbiBhY2Nlc3MuCiAgICAgICAgdmFyIHBhcnNlZEJpbmRpbmdzOwogICAgICAgIGZ1bmN0aW9uIG1ha2VWYWx1ZUFjY2Vzc29yKGJpbmRpbmdLZXkpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsgcmV0dXJuIHBhcnNlZEJpbmRpbmdzW2JpbmRpbmdLZXldIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGFyc2VkQmluZGluZ3NBY2Nlc3NvcigpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcnNlZEJpbmRpbmdzOwogICAgICAgIH0KCiAgICAgICAgdmFyIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzOwogICAgICAgIGtvLmRlcGVuZGVudE9ic2VydmFibGUoCiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3ZSBoYXZlIGEgbm9ubnVsbCBiaW5kaW5nIGNvbnRleHQgdG8gd29yayB3aXRoCiAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0NvbnRleHRJbnN0YW5jZSA9IHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQgJiYgKHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQgaW5zdGFuY2VvZiBrby5iaW5kaW5nQ29udGV4dCkKICAgICAgICAgICAgICAgICAgICA/IHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQKICAgICAgICAgICAgICAgICAgICA6IG5ldyBrby5iaW5kaW5nQ29udGV4dChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpKTsKICAgICAgICAgICAgICAgIHZhciB2aWV3TW9kZWwgPSBiaW5kaW5nQ29udGV4dEluc3RhbmNlWyckZGF0YSddOwoKICAgICAgICAgICAgICAgIC8vIE9wdGltaXphdGlvbjogRG9uJ3Qgc3RvcmUgdGhlIGJpbmRpbmcgY29udGV4dCBvbiB0aGlzIG5vZGUgaWYgaXQncyBkZWZpbml0ZWx5IHRoZSBzYW1lIGFzIG9uIG5vZGUucGFyZW50Tm9kZSwgYmVjYXVzZQogICAgICAgICAgICAgICAgLy8gd2UgY2FuIGVhc2lseSByZWNvdmVyIGl0IGp1c3QgYnkgc2Nhbm5pbmcgdXAgdGhlIG5vZGUncyBhbmNlc3RvcnMgaW4gdGhlIERPTQogICAgICAgICAgICAgICAgLy8gKG5vdGU6IGhlcmUsIHBhcmVudCBub2RlIG1lYW5zICJyZWFsIERPTSBwYXJlbnQiIG5vdCAidmlydHVhbCBwYXJlbnQiLCBhcyB0aGVyZSdzIG5vIE8oMSkgd2F5IHRvIGZpbmQgdGhlIHZpcnR1YWwgcGFyZW50KQogICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlKG5vZGUsIGJpbmRpbmdDb250ZXh0SW5zdGFuY2UpOwoKICAgICAgICAgICAgICAgIC8vIFVzZSBldmFsdWF0ZWRCaW5kaW5ncyBpZiBnaXZlbiwgb3RoZXJ3aXNlIGZhbGwgYmFjayBvbiBhc2tpbmcgdGhlIGJpbmRpbmdzIHByb3ZpZGVyIHRvIGdpdmUgdXMgc29tZSBiaW5kaW5ncwogICAgICAgICAgICAgICAgdmFyIGV2YWx1YXRlZEJpbmRpbmdzID0gKHR5cGVvZiBiaW5kaW5ncyA9PSAiZnVuY3Rpb24iKSA/IGJpbmRpbmdzKCkgOiBiaW5kaW5nczsKICAgICAgICAgICAgICAgIHBhcnNlZEJpbmRpbmdzID0gZXZhbHVhdGVkQmluZGluZ3MgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydnZXRCaW5kaW5ncyddKG5vZGUsIGJpbmRpbmdDb250ZXh0SW5zdGFuY2UpOwoKICAgICAgICAgICAgICAgIGlmIChwYXJzZWRCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgIC8vIEZpcnN0IHJ1biBhbGwgdGhlIGluaXRzLCBzbyBiaW5kaW5ncyBjYW4gcmVnaXN0ZXIgZm9yIG5vdGlmaWNhdGlvbiBvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRQaGFzZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbml0UGhhc2UgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBiaW5kaW5nS2V5IGluIHBhcnNlZEJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nICYmIG5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVUaGF0QmluZGluZ0lzQWxsb3dlZEZvclZpcnR1YWxFbGVtZW50cyhiaW5kaW5nS2V5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZyAmJiB0eXBlb2YgYmluZGluZ1siaW5pdCJdID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlckluaXRGbiA9IGJpbmRpbmdbImluaXQiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdFJlc3VsdCA9IGhhbmRsZXJJbml0Rm4obm9kZSwgbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIHBhcnNlZEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgYmluZGluZyBoYW5kbGVyIGNsYWltcyB0byBjb250cm9sIGRlc2NlbmRhbnQgYmluZGluZ3MsIG1ha2UgYSBub3RlIG9mIHRoaXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5pdFJlc3VsdCAmJiBpbml0UmVzdWx0Wydjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNdWx0aXBsZSBiaW5kaW5ncyAoIiArIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzICsgIiBhbmQgIiArIGJpbmRpbmdLZXkgKyAiKSBhcmUgdHJ5aW5nIHRvIGNvbnRyb2wgZGVzY2VuZGFudCBiaW5kaW5ncyBvZiB0aGUgc2FtZSBlbGVtZW50LiBZb3UgY2Fubm90IHVzZSB0aGVzZSBiaW5kaW5ncyB0b2dldGhlciBvbiB0aGUgc2FtZSBlbGVtZW50LiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9IGJpbmRpbmdLZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRQaGFzZSA9IDI7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyAuLi4gdGhlbiBydW4gYWxsIHRoZSB1cGRhdGVzLCB3aGljaCBtaWdodCB0cmlnZ2VyIGNoYW5nZXMgZXZlbiBvbiB0aGUgZmlyc3QgZXZhbHVhdGlvbgogICAgICAgICAgICAgICAgICAgIGlmIChpbml0UGhhc2UgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYmluZGluZ0tleSBpbiBwYXJzZWRCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBrby5iaW5kaW5nSGFuZGxlcnNbYmluZGluZ0tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZyAmJiB0eXBlb2YgYmluZGluZ1sidXBkYXRlIl0gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyVXBkYXRlRm4gPSBiaW5kaW5nWyJ1cGRhdGUiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyVXBkYXRlRm4obm9kZSwgbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSksIHBhcnNlZEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHsgJ2Rpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCcgOiBub2RlIH0KICAgICAgICApOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzaG91bGRCaW5kRGVzY2VuZGFudHM6IGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzID09PSB1bmRlZmluZWQKICAgICAgICB9OwogICAgfTsKCiAgICB2YXIgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5ID0gIl9fa29fYmluZGluZ0NvbnRleHRfXyI7CiAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUgPSBmdW5jdGlvbiAobm9kZSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAyKQogICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChub2RlLCBzdG9yZWRCaW5kaW5nQ29udGV4dERvbURhdGFLZXksIGJpbmRpbmdDb250ZXh0KTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21EYXRhLmdldChub2RlLCBzdG9yZWRCaW5kaW5nQ29udGV4dERvbURhdGFLZXkpOwogICAgfQoKICAgIGtvLmFwcGx5QmluZGluZ3NUb05vZGUgPSBmdW5jdGlvbiAobm9kZSwgYmluZGluZ3MsIHZpZXdNb2RlbCkgewogICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSAvLyBJZiBpdCdzIGFuIGVsZW1lbnQsIHdvcmthcm91bmQgSUUgPD0gOCBIVE1MIHBhcnNpbmcgd2VpcmRuZXNzCiAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5ub3JtYWxpc2VWaXJ0dWFsRWxlbWVudERvbVN0cnVjdHVyZShub2RlKTsKICAgICAgICByZXR1cm4gYXBwbHlCaW5kaW5nc1RvTm9kZUludGVybmFsKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWwsIHRydWUpOwogICAgfTsKCiAgICBrby5hcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cyA9IGZ1bmN0aW9uKHZpZXdNb2RlbCwgcm9vdE5vZGUpIHsKICAgICAgICBpZiAocm9vdE5vZGUubm9kZVR5cGUgPT09IDEgfHwgcm9vdE5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwodmlld01vZGVsLCByb290Tm9kZSwgdHJ1ZSk7CiAgICB9OwoKICAgIGtvLmFwcGx5QmluZGluZ3MgPSBmdW5jdGlvbiAodmlld01vZGVsLCByb290Tm9kZSkgewogICAgICAgIGlmIChyb290Tm9kZSAmJiAocm9vdE5vZGUubm9kZVR5cGUgIT09IDEpICYmIChyb290Tm9kZS5ub2RlVHlwZSAhPT0gOCkpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigia28uYXBwbHlCaW5kaW5nczogZmlyc3QgcGFyYW1ldGVyIHNob3VsZCBiZSB5b3VyIHZpZXcgbW9kZWw7IHNlY29uZCBwYXJhbWV0ZXIgc2hvdWxkIGJlIGEgRE9NIG5vZGUiKTsKICAgICAgICByb290Tm9kZSA9IHJvb3ROb2RlIHx8IHdpbmRvdy5kb2N1bWVudC5ib2R5OyAvLyBNYWtlICJyb290Tm9kZSIgcGFyYW1ldGVyIG9wdGlvbmFsCgogICAgICAgIGFwcGx5QmluZGluZ3NUb05vZGVBbmREZXNjZW5kYW50c0ludGVybmFsKHZpZXdNb2RlbCwgcm9vdE5vZGUsIHRydWUpOwogICAgfTsKCiAgICAvLyBSZXRyaWV2aW5nIGJpbmRpbmcgY29udGV4dCBmcm9tIGFyYml0cmFyeSBub2RlcwogICAga28uY29udGV4dEZvciA9IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvLyBXZSBjYW4gb25seSBkbyBzb21ldGhpbmcgbWVhbmluZ2Z1bCBmb3IgZWxlbWVudHMgYW5kIGNvbW1lbnQgbm9kZXMgKGluIHBhcnRpY3VsYXIsIG5vdCB0ZXh0IG5vZGVzLCBhcyBJRSBjYW4ndCBzdG9yZSBkb21kYXRhIGZvciB0aGVtKQogICAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkgewogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0ga28uc3RvcmVkQmluZGluZ0NvbnRleHRGb3JOb2RlKG5vZGUpOwogICAgICAgICAgICAgICAgaWYgKGNvbnRleHQpIHJldHVybiBjb250ZXh0OwogICAgICAgICAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkgcmV0dXJuIGtvLmNvbnRleHRGb3Iobm9kZS5wYXJlbnROb2RlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfTsKICAgIGtvLmRhdGFGb3IgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgdmFyIGNvbnRleHQgPSBrby5jb250ZXh0Rm9yKG5vZGUpOwogICAgICAgIHJldHVybiBjb250ZXh0ID8gY29udGV4dFsnJGRhdGEnXSA6IHVuZGVmaW5lZDsKICAgIH07CgogICAga28uZXhwb3J0U3ltYm9sKCdiaW5kaW5nSGFuZGxlcnMnLCBrby5iaW5kaW5nSGFuZGxlcnMpOwogICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzJywga28uYXBwbHlCaW5kaW5ncyk7CiAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzJywga28uYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHMpOwogICAga28uZXhwb3J0U3ltYm9sKCdhcHBseUJpbmRpbmdzVG9Ob2RlJywga28uYXBwbHlCaW5kaW5nc1RvTm9kZSk7CiAgICBrby5leHBvcnRTeW1ib2woJ2NvbnRleHRGb3InLCBrby5jb250ZXh0Rm9yKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnZGF0YUZvcicsIGtvLmRhdGFGb3IpOwp9KSgpOwovLyBGb3IgY2VydGFpbiBjb21tb24gZXZlbnRzIChjdXJyZW50bHkganVzdCAnY2xpY2snKSwgYWxsb3cgYSBzaW1wbGlmaWVkIGRhdGEtYmluZGluZyBzeW50YXgKLy8gZS5nLiBjbGljazpoYW5kbGVyIGluc3RlYWQgb2YgdGhlIHVzdWFsIGZ1bGwtbGVuZ3RoIGV2ZW50OntjbGljazpoYW5kbGVyfQp2YXIgZXZlbnRIYW5kbGVyc1dpdGhTaG9ydGN1dHMgPSBbJ2NsaWNrJ107CmtvLnV0aWxzLmFycmF5Rm9yRWFjaChldmVudEhhbmRsZXJzV2l0aFNob3J0Y3V0cywgZnVuY3Rpb24oZXZlbnROYW1lKSB7CiAgICBrby5iaW5kaW5nSGFuZGxlcnNbZXZlbnROYW1lXSA9IHsKICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCkgewogICAgICAgICAgICB2YXIgbmV3VmFsdWVBY2Nlc3NvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgICAgICAgICAgIHJlc3VsdFtldmVudE5hbWVdID0gdmFsdWVBY2Nlc3NvcigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1snZXZlbnQnXVsnaW5pdCddLmNhbGwodGhpcywgZWxlbWVudCwgbmV3VmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsKTsKICAgICAgICB9CiAgICB9Cn0pOwoKCmtvLmJpbmRpbmdIYW5kbGVyc1snZXZlbnQnXSA9IHsKICAgICdpbml0JyA6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpIHsKICAgICAgICB2YXIgZXZlbnRzVG9IYW5kbGUgPSB2YWx1ZUFjY2Vzc29yKCkgfHwge307CiAgICAgICAgZm9yKHZhciBldmVudE5hbWVPdXRzaWRlQ2xvc3VyZSBpbiBldmVudHNUb0hhbmRsZSkgewogICAgICAgICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnROYW1lID0gZXZlbnROYW1lT3V0c2lkZUNsb3N1cmU7IC8vIFNlcGFyYXRlIHZhcmlhYmxlIHRvIGJlIGNhcHR1cmVkIGJ5IGV2ZW50IGhhbmRsZXIgY2xvc3VyZQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBldmVudE5hbWUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudE5hbWUsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlclJldHVyblZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlckZ1bmN0aW9uID0gdmFsdWVBY2Nlc3NvcigpW2V2ZW50TmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaGFuZGxlckZ1bmN0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWxsQmluZGluZ3MgPSBhbGxCaW5kaW5nc0FjY2Vzc29yKCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGFrZSBhbGwgdGhlIGV2ZW50IGFyZ3MsIGFuZCBwcmVmaXggd2l0aCB0aGUgdmlld21vZGVsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJnc0ZvckhhbmRsZXIgPSBrby51dGlscy5tYWtlQXJyYXkoYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NGb3JIYW5kbGVyLnVuc2hpZnQodmlld01vZGVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXJSZXR1cm5WYWx1ZSA9IGhhbmRsZXJGdW5jdGlvbi5hcHBseSh2aWV3TW9kZWwsIGFyZ3NGb3JIYW5kbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYW5kbGVyUmV0dXJuVmFsdWUgIT09IHRydWUpIHsgLy8gTm9ybWFsbHkgd2Ugd2FudCB0byBwcmV2ZW50IGRlZmF1bHQgYWN0aW9uLiBEZXZlbG9wZXIgY2FuIG92ZXJyaWRlIHRoaXMgYmUgZXhwbGljaXRseSByZXR1cm5pbmcgdHJ1ZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYnViYmxlID0gYWxsQmluZGluZ3NbZXZlbnROYW1lICsgJ0J1YmJsZSddICE9PSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFidWJibGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pKCk7CiAgICAgICAgfQogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWydzdWJtaXQnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCkgewogICAgICAgIGlmICh0eXBlb2YgdmFsdWVBY2Nlc3NvcigpICE9ICJmdW5jdGlvbiIpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHZhbHVlIGZvciBhIHN1Ym1pdCBiaW5kaW5nIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJzdWJtaXQiLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGhhbmRsZXJSZXR1cm5WYWx1ZTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpOwogICAgICAgICAgICB0cnkgeyBoYW5kbGVyUmV0dXJuVmFsdWUgPSB2YWx1ZS5jYWxsKHZpZXdNb2RlbCwgZWxlbWVudCk7IH0KICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICBpZiAoaGFuZGxlclJldHVyblZhbHVlICE9PSB0cnVlKSB7IC8vIE5vcm1hbGx5IHdlIHdhbnQgdG8gcHJldmVudCBkZWZhdWx0IGFjdGlvbi4gRGV2ZWxvcGVyIGNhbiBvdmVycmlkZSB0aGlzIGJlIGV4cGxpY2l0bHkgcmV0dXJuaW5nIHRydWUuCiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KQogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWyd2aXNpYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgdmFyIGlzQ3VycmVudGx5VmlzaWJsZSA9ICEoZWxlbWVudC5zdHlsZS5kaXNwbGF5ID09ICJub25lIik7CiAgICAgICAgaWYgKHZhbHVlICYmICFpc0N1cnJlbnRseVZpc2libGUpCiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICAgIGVsc2UgaWYgKCghdmFsdWUpICYmIGlzQ3VycmVudGx5VmlzaWJsZSkKICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgfQp9Cgprby5iaW5kaW5nSGFuZGxlcnNbJ2VuYWJsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIGlmICh2YWx1ZSAmJiBlbGVtZW50LmRpc2FibGVkKQogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgiZGlzYWJsZWQiKTsKICAgICAgICBlbHNlIGlmICgoIXZhbHVlKSAmJiAoIWVsZW1lbnQuZGlzYWJsZWQpKQogICAgICAgICAgICBlbGVtZW50LmRpc2FibGVkID0gdHJ1ZTsKICAgIH0KfTsKCmtvLmJpbmRpbmdIYW5kbGVyc1snZGlzYWJsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAga28uYmluZGluZ0hhbmRsZXJzWydlbmFibGUnXVsndXBkYXRlJ10oZWxlbWVudCwgZnVuY3Rpb24oKSB7IHJldHVybiAha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIH0pOwogICAgfQp9OwoKZnVuY3Rpb24gZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBtb2RlbFZhbHVlLCBwcmVmZXJNb2RlbFZhbHVlKSB7CiAgICBpZiAocHJlZmVyTW9kZWxWYWx1ZSkgewogICAgICAgIGlmIChtb2RlbFZhbHVlICE9PSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KSkKICAgICAgICAgICAga28uc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlKGVsZW1lbnQsIG1vZGVsVmFsdWUpOwogICAgfQoKICAgIC8vIE5vIG1hdHRlciB3aGljaCBkaXJlY3Rpb24gd2UncmUgc3luY2luZyBpbiwgd2Ugd2FudCB0aGUgZW5kIHJlc3VsdCB0byBiZSBlcXVhbGl0eSBiZXR3ZWVuIGRyb3Bkb3duIHZhbHVlIGFuZCBtb2RlbCB2YWx1ZS4KICAgIC8vIElmIHRoZXkgYXJlbid0IGVxdWFsLCBlaXRoZXIgd2UgcHJlZmVyIHRoZSBkcm9wZG93biB2YWx1ZSwgb3IgdGhlIG1vZGVsIHZhbHVlIGNvdWxkbid0IGJlIHJlcHJlc2VudGVkLCBzbyBlaXRoZXIgd2F5LAogICAgLy8gY2hhbmdlIHRoZSBtb2RlbCB2YWx1ZSB0byBtYXRjaCB0aGUgZHJvcGRvd24uCiAgICBpZiAobW9kZWxWYWx1ZSAhPT0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCkpCiAgICAgICAga28udXRpbHMudHJpZ2dlckV2ZW50KGVsZW1lbnQsICJjaGFuZ2UiKTsKfTsKCmtvLmJpbmRpbmdIYW5kbGVyc1sndmFsdWUnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IpIHsKICAgICAgICAvLyBBbHdheXMgY2F0Y2ggImNoYW5nZSIgZXZlbnQ7IHBvc3NpYmx5IG90aGVyIGV2ZW50cyB0b28gaWYgYXNrZWQKICAgICAgICB2YXIgZXZlbnRzVG9DYXRjaCA9IFsiY2hhbmdlIl07CiAgICAgICAgdmFyIHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2ggPSBhbGxCaW5kaW5nc0FjY2Vzc29yKClbInZhbHVlVXBkYXRlIl07CiAgICAgICAgaWYgKHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2gpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID09ICJzdHJpbmciKSAvLyBBbGxvdyBib3RoIGluZGl2aWR1YWwgZXZlbnQgbmFtZXMsIGFuZCBhcnJheXMgb2YgZXZlbnQgbmFtZXMKICAgICAgICAgICAgICAgIHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2ggPSBbcmVxdWVzdGVkRXZlbnRzVG9DYXRjaF07CiAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UHVzaEFsbChldmVudHNUb0NhdGNoLCByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoKTsKICAgICAgICAgICAgZXZlbnRzVG9DYXRjaCA9IGtvLnV0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMoZXZlbnRzVG9DYXRjaCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgdmFsdWVVcGRhdGVIYW5kbGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpOwogICAgICAgICAgICB2YXIgZWxlbWVudFZhbHVlID0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCk7CiAgICAgICAgICAgIGtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICd2YWx1ZScsIGVsZW1lbnRWYWx1ZSwgLyogY2hlY2tJZkRpZmZlcmVudDogKi8gdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzEyMgogICAgICAgIC8vIElFIGRvZXNuJ3QgZmlyZSAiY2hhbmdlIiBldmVudHMgb24gdGV4dGJveGVzIGlmIHRoZSB1c2VyIHNlbGVjdHMgYSB2YWx1ZSBmcm9tIGl0cyBhdXRvY29tcGxldGUgbGlzdAogICAgICAgIHZhciBpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgPSBrby51dGlscy5pZVZlcnNpb24gJiYgZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImlucHV0IiAmJiBlbGVtZW50LnR5cGUgPT0gInRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGVsZW1lbnQuYXV0b2NvbXBsZXRlICE9ICJvZmYiICYmICghZWxlbWVudC5mb3JtIHx8IGVsZW1lbnQuZm9ybS5hdXRvY29tcGxldGUgIT0gIm9mZiIpOwogICAgICAgIGlmIChpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgJiYga28udXRpbHMuYXJyYXlJbmRleE9mKGV2ZW50c1RvQ2F0Y2gsICJwcm9wZXJ0eWNoYW5nZSIpID09IC0xKSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eUNoYW5nZWRGaXJlZCA9IGZhbHNlOwogICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAicHJvcGVydHljaGFuZ2UiLCBmdW5jdGlvbiAoKSB7IHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gdHJ1ZSB9KTsKICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImJsdXIiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUNoYW5nZWRGaXJlZCkgewogICAgICAgICAgICAgICAgICAgIHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVVcGRhdGVIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGV2ZW50c1RvQ2F0Y2gsIGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgICAgICAgICAvLyBUaGUgc3ludGF4ICJhZnRlcjxldmVudG5hbWU+IiBtZWFucyAicnVuIHRoZSBoYW5kbGVyIGFzeW5jaHJvbm91c2x5IGFmdGVyIHRoZSBldmVudCIKICAgICAgICAgICAgLy8gVGhpcyBpcyB1c2VmdWwsIGZvciBleGFtcGxlLCB0byBjYXRjaCAia2V5ZG93biIgZXZlbnRzIGFmdGVyIHRoZSBicm93c2VyIGhhcyB1cGRhdGVkIHRoZSBjb250cm9sCiAgICAgICAgICAgIC8vIChvdGhlcndpc2UsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKHRoaXMpIHdpbGwgcmVjZWl2ZSB0aGUgY29udHJvbCdzIHZhbHVlICpiZWZvcmUqIHRoZSBrZXkgZXZlbnQpCiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdmFsdWVVcGRhdGVIYW5kbGVyOwogICAgICAgICAgICBpZiAoa28udXRpbHMuc3RyaW5nU3RhcnRzV2l0aChldmVudE5hbWUsICJhZnRlciIpKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24oKSB7IHNldFRpbWVvdXQodmFsdWVVcGRhdGVIYW5kbGVyLCAwKSB9OwogICAgICAgICAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnN1YnN0cmluZygiYWZ0ZXIiLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnROYW1lLCBoYW5kbGVyKTsKICAgICAgICB9KTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWVJc1NlbGVjdE9wdGlvbiA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSA9PT0gInNlbGVjdCI7CiAgICAgICAgdmFyIG5ld1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBlbGVtZW50VmFsdWUgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KTsKICAgICAgICB2YXIgdmFsdWVIYXNDaGFuZ2VkID0gKG5ld1ZhbHVlICE9IGVsZW1lbnRWYWx1ZSk7CgogICAgICAgIC8vIEphdmFTY3JpcHQncyAwID09ICIiIGJlaGF2aW91cyBpcyB1bmZvcnR1bmF0ZSBoZXJlIGFzIGl0IHByZXZlbnRzIHdyaXRpbmcgMCB0byBhbiBlbXB0eSB0ZXh0IGJveCAobG9vc2UgZXF1YWxpdHkgc3VnZ2VzdHMgdGhlIHZhbHVlcyBhcmUgdGhlIHNhbWUpLgogICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gZG8gYSBzdHJpY3QgZXF1YWxpdHkgY29tcGFyaXNvbiBhcyB0aGF0IGlzIG1vcmUgY29uZnVzaW5nIGZvciBkZXZlbG9wZXJzIGluIGNlcnRhaW4gY2FzZXMsIHNvIHdlIHNwZWNpZmljYWxseSBzcGVjaWFsIGNhc2UgMCAhPSAiIiBoZXJlLgogICAgICAgIGlmICgobmV3VmFsdWUgPT09IDApICYmIChlbGVtZW50VmFsdWUgIT09IDApICYmIChlbGVtZW50VmFsdWUgIT09ICIwIikpCiAgICAgICAgICAgIHZhbHVlSGFzQ2hhbmdlZCA9IHRydWU7CgogICAgICAgIGlmICh2YWx1ZUhhc0NoYW5nZWQpIHsKICAgICAgICAgICAgdmFyIGFwcGx5VmFsdWVBY3Rpb24gPSBmdW5jdGlvbiAoKSB7IGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSk7IH07CiAgICAgICAgICAgIGFwcGx5VmFsdWVBY3Rpb24oKTsKCiAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFNiBidWc6IEl0IHdvbid0IHJlbGlhYmx5IGFwcGx5IHZhbHVlcyB0byBTRUxFQ1Qgbm9kZXMgZHVyaW5nIHRoZSBzYW1lIGV4ZWN1dGlvbiB0aHJlYWQKICAgICAgICAgICAgLy8gcmlnaHQgYWZ0ZXIgeW91J3ZlIGNoYW5nZWQgdGhlIHNldCBvZiBPUFRJT04gbm9kZXMgb24gaXQuIFNvIGZvciB0aGF0IG5vZGUgdHlwZSwgd2UnbGwgc2NoZWR1bGUgYSBzZWNvbmQgdGhyZWFkCiAgICAgICAgICAgIC8vIHRvIGFwcGx5IHRoZSB2YWx1ZSBhcyB3ZWxsLgogICAgICAgICAgICB2YXIgYWxzb0FwcGx5QXN5bmNocm9ub3VzbHkgPSB2YWx1ZUlzU2VsZWN0T3B0aW9uOwogICAgICAgICAgICBpZiAoYWxzb0FwcGx5QXN5bmNocm9ub3VzbHkpCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGFwcGx5VmFsdWVBY3Rpb24sIDApOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgeW91IHRyeSB0byBzZXQgYSBtb2RlbCB2YWx1ZSB0aGF0IGNhbid0IGJlIHJlcHJlc2VudGVkIGluIGFuIGFscmVhZHktcG9wdWxhdGVkIGRyb3Bkb3duLCByZWplY3QgdGhhdCBjaGFuZ2UsCiAgICAgICAgLy8gYmVjYXVzZSB5b3UncmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBhIG1vZGVsIHZhbHVlIHRoYXQgZGlzYWdyZWVzIHdpdGggYSB2aXNpYmxlIFVJIHNlbGVjdGlvbi4KICAgICAgICBpZiAodmFsdWVJc1NlbGVjdE9wdGlvbiAmJiAoZWxlbWVudC5sZW5ndGggPiAwKSkKICAgICAgICAgICAgZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSwgLyogcHJlZmVyTW9kZWxWYWx1ZSAqLyBmYWxzZSk7CiAgICB9Cn07Cgprby5iaW5kaW5nSGFuZGxlcnNbJ29wdGlvbnMnXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJzZWxlY3QiKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm9wdGlvbnMgYmluZGluZyBhcHBsaWVzIG9ubHkgdG8gU0VMRUNUIGVsZW1lbnRzIik7CgogICAgICAgIHZhciBzZWxlY3RXYXNQcmV2aW91c2x5RW1wdHkgPSBlbGVtZW50Lmxlbmd0aCA9PSAwOwogICAgICAgIHZhciBwcmV2aW91c1NlbGVjdGVkVmFsdWVzID0ga28udXRpbHMuYXJyYXlNYXAoa28udXRpbHMuYXJyYXlGaWx0ZXIoZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS50YWdOYW1lICYmIChrby51dGlscy50YWdOYW1lTG93ZXIobm9kZSkgPT09ICJvcHRpb24iKSAmJiBub2RlLnNlbGVjdGVkOwogICAgICAgIH0pLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkgfHwgbm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudDsKICAgICAgICB9KTsKICAgICAgICB2YXIgcHJldmlvdXNTY3JvbGxUb3AgPSBlbGVtZW50LnNjcm9sbFRvcDsKCiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0gZWxlbWVudC52YWx1ZTsKCiAgICAgICAgLy8gUmVtb3ZlIGFsbCBleGlzdGluZyA8b3B0aW9uPnMuCiAgICAgICAgLy8gTmVlZCB0byB1c2UgLnJlbW92ZSgpIHJhdGhlciB0aGFuIC5yZW1vdmVDaGlsZCgpIGZvciA8b3B0aW9uPnMgb3RoZXJ3aXNlIElFIGJlaGF2ZXMgb2RkbHkgKGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTM0KQogICAgICAgIHdoaWxlIChlbGVtZW50Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAga28uY2xlYW5Ob2RlKGVsZW1lbnQub3B0aW9uc1swXSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlKDApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZS5sZW5ndGggIT0gIm51bWJlciIpCiAgICAgICAgICAgICAgICB2YWx1ZSA9IFt2YWx1ZV07CiAgICAgICAgICAgIGlmIChhbGxCaW5kaW5nc1snb3B0aW9uc0NhcHRpb24nXSkgewogICAgICAgICAgICAgICAgdmFyIG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpOwogICAgICAgICAgICAgICAga28udXRpbHMuc2V0SHRtbChvcHRpb24sIGFsbEJpbmRpbmdzWydvcHRpb25zQ2FwdGlvbiddKTsKICAgICAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShvcHRpb24sIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKG9wdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSB2YWx1ZS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBhIHZhbHVlIHRvIHRoZSBvcHRpb24gZWxlbWVudAogICAgICAgICAgICAgICAgdmFyIG9wdGlvblZhbHVlID0gdHlwZW9mIGFsbEJpbmRpbmdzWydvcHRpb25zVmFsdWUnXSA9PSAic3RyaW5nIiA/IHZhbHVlW2ldW2FsbEJpbmRpbmdzWydvcHRpb25zVmFsdWUnXV0gOiB2YWx1ZVtpXTsKICAgICAgICAgICAgICAgIG9wdGlvblZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvcHRpb25WYWx1ZSk7CiAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCBvcHRpb25WYWx1ZSk7CgogICAgICAgICAgICAgICAgLy8gQXBwbHkgc29tZSB0ZXh0IHRvIHRoZSBvcHRpb24gZWxlbWVudAogICAgICAgICAgICAgICAgdmFyIG9wdGlvbnNUZXh0VmFsdWUgPSBhbGxCaW5kaW5nc1snb3B0aW9uc1RleHQnXTsKICAgICAgICAgICAgICAgIHZhciBvcHRpb25UZXh0OwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zVGV4dFZhbHVlID09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uVGV4dCA9IG9wdGlvbnNUZXh0VmFsdWUodmFsdWVbaV0pOyAvLyBHaXZlbiBhIGZ1bmN0aW9uOyBydW4gaXQgYWdhaW5zdCB0aGUgZGF0YSB2YWx1ZQogICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIG9wdGlvbnNUZXh0VmFsdWUgPT0gInN0cmluZyIpCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uVGV4dCA9IHZhbHVlW2ldW29wdGlvbnNUZXh0VmFsdWVdOyAvLyBHaXZlbiBhIHN0cmluZzsgdHJlYXQgaXQgYXMgYSBwcm9wZXJ0eSBuYW1lIG9uIHRoZSBkYXRhIHZhbHVlCiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uVGV4dCA9IG9wdGlvblZhbHVlOyAgICAgICAgICAgICAgICAgLy8gR2l2ZW4gbm8gb3B0aW9uc1RleHQgYXJnOyB1c2UgdGhlIGRhdGEgdmFsdWUgaXRzZWxmCiAgICAgICAgICAgICAgICBpZiAoKG9wdGlvblRleHQgPT09IG51bGwpIHx8IChvcHRpb25UZXh0ID09PSB1bmRlZmluZWQpKQogICAgICAgICAgICAgICAgICAgIG9wdGlvblRleHQgPSAiIjsKCiAgICAgICAgICAgICAgICBrby51dGlscy5zZXRUZXh0Q29udGVudChvcHRpb24sIG9wdGlvblRleHQpOwoKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQob3B0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU2IGRvZXNuJ3QgbGlrZSB1cyB0byBhc3NpZ24gc2VsZWN0aW9uIHRvIE9QVElPTiBub2RlcyBiZWZvcmUgdGhleSdyZSBhZGRlZCB0byB0aGUgZG9jdW1lbnQuCiAgICAgICAgICAgIC8vIFRoYXQncyB3aHkgd2UgZmlyc3QgYWRkZWQgdGhlbSB3aXRob3V0IHNlbGVjdGlvbi4gTm93IGl0J3MgdGltZSB0byBzZXQgdGhlIHNlbGVjdGlvbi4KICAgICAgICAgICAgdmFyIG5ld09wdGlvbnMgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJvcHRpb24iKTsKICAgICAgICAgICAgdmFyIGNvdW50U2VsZWN0aW9uc1JldGFpbmVkID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBuZXdPcHRpb25zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmFycmF5SW5kZXhPZihwcmV2aW91c1NlbGVjdGVkVmFsdWVzLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShuZXdPcHRpb25zW2ldKSkgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZShuZXdPcHRpb25zW2ldLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBjb3VudFNlbGVjdGlvbnNSZXRhaW5lZCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50LnNjcm9sbFRvcCA9IHByZXZpb3VzU2Nyb2xsVG9wOwoKICAgICAgICAgICAgaWYgKHNlbGVjdFdhc1ByZXZpb3VzbHlFbXB0eSAmJiAoJ3ZhbHVlJyBpbiBhbGxCaW5kaW5ncykpIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBjb25zaXN0ZW5jeSBiZXR3ZWVuIG1vZGVsIHZhbHVlIGFuZCBzZWxlY3RlZCBvcHRpb24uCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZHJvcGRvd24gaXMgYmVpbmcgcG9wdWxhdGVkIGZvciB0aGUgZmlyc3QgdGltZSBoZXJlIChvciB3YXMgb3RoZXJ3aXNlIHByZXZpb3VzbHkgZW1wdHkpLAogICAgICAgICAgICAgICAgLy8gdGhlIGRyb3Bkb3duIHNlbGVjdGlvbiBzdGF0ZSBpcyBtZWFuaW5nbGVzcywgc28gd2UgcHJlc2VydmUgdGhlIG1vZGVsIHZhbHVlLgogICAgICAgICAgICAgICAgZW5zdXJlRHJvcGRvd25TZWxlY3Rpb25Jc0NvbnNpc3RlbnRXaXRoTW9kZWxWYWx1ZShlbGVtZW50LCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFsbEJpbmRpbmdzWyd2YWx1ZSddKSwgLyogcHJlZmVyTW9kZWxWYWx1ZSAqLyB0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgSUU5IGJ1ZwogICAgICAgICAgICBrby51dGlscy5lbnN1cmVTZWxlY3RFbGVtZW50SXNSZW5kZXJlZENvcnJlY3RseShlbGVtZW50KTsKICAgICAgICB9CiAgICB9Cn07CmtvLmJpbmRpbmdIYW5kbGVyc1snb3B0aW9ucyddLm9wdGlvblZhbHVlRG9tRGF0YUtleSA9ICdfX2tvLm9wdGlvblZhbHVlRG9tRGF0YV9fJzsKCmtvLmJpbmRpbmdIYW5kbGVyc1snc2VsZWN0ZWRPcHRpb25zJ10gPSB7CiAgICBnZXRTZWxlY3RlZFZhbHVlc0Zyb21TZWxlY3ROb2RlOiBmdW5jdGlvbiAoc2VsZWN0Tm9kZSkgewogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICB2YXIgbm9kZXMgPSBzZWxlY3ROb2RlLmNoaWxkTm9kZXM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBub2Rlcy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBub2Rlc1tpXSwgdGFnTmFtZSA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcihub2RlKTsKICAgICAgICAgICAgaWYgKHRhZ05hbWUgPT0gIm9wdGlvbiIgJiYgbm9kZS5zZWxlY3RlZCkKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG5vZGUpKTsKICAgICAgICAgICAgZWxzZSBpZiAodGFnTmFtZSA9PSAib3B0Z3JvdXAiKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZWN0ZWRWYWx1ZXNGcm9tT3B0R3JvdXAgPSBrby5iaW5kaW5nSGFuZGxlcnNbJ3NlbGVjdGVkT3B0aW9ucyddLmdldFNlbGVjdGVkVmFsdWVzRnJvbVNlbGVjdE5vZGUobm9kZSk7CiAgICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmFwcGx5KHJlc3VsdCwgW3Jlc3VsdC5sZW5ndGgsIDBdLmNvbmNhdChzZWxlY3RlZFZhbHVlc0Zyb21PcHRHcm91cCkpOyAvLyBBZGQgbmV3IGVudHJpZXMgdG8gZXhpc3RpbmcgJ3Jlc3VsdCcgaW5zdGFuY2UKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IpIHsKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiY2hhbmdlIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgIHZhciB2YWx1ZVRvV3JpdGUgPSBrby5iaW5kaW5nSGFuZGxlcnNbJ3NlbGVjdGVkT3B0aW9ucyddLmdldFNlbGVjdGVkVmFsdWVzRnJvbVNlbGVjdE5vZGUodGhpcyk7CiAgICAgICAgICAgIGtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KHZhbHVlLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCAndmFsdWUnLCB2YWx1ZVRvV3JpdGUpOwogICAgICAgIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT0gInNlbGVjdCIpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidmFsdWVzIGJpbmRpbmcgYXBwbGllcyBvbmx5IHRvIFNFTEVDVCBlbGVtZW50cyIpOwoKICAgICAgICB2YXIgbmV3VmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgaWYgKG5ld1ZhbHVlICYmIHR5cGVvZiBuZXdWYWx1ZS5sZW5ndGggPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgdmFyIG5vZGVzID0gZWxlbWVudC5jaGlsZE5vZGVzOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBub2Rlc1tpXTsKICAgICAgICAgICAgICAgIGlmIChrby51dGlscy50YWdOYW1lTG93ZXIobm9kZSkgPT09ICJvcHRpb24iKQogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZShub2RlLCBrby51dGlscy5hcnJheUluZGV4T2YobmV3VmFsdWUsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG5vZGUpKSA+PSAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfTsKCmtvLmJpbmRpbmdIYW5kbGVyc1sndGV4dCddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAga28udXRpbHMuc2V0VGV4dENvbnRlbnQoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcigpKTsKICAgIH0KfTsKCmtvLmJpbmRpbmdIYW5kbGVyc1snaHRtbCddID0gewogICAgJ2luaXQnOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBQcmV2ZW50IGJpbmRpbmcgb24gdGhlIGR5bmFtaWNhbGx5LWluamVjdGVkIEhUTUwgKGFzIGRldmVsb3BlcnMgYXJlIHVubGlrZWx5IHRvIGV4cGVjdCB0aGF0LCBhbmQgaXQgaGFzIHNlY3VyaXR5IGltcGxpY2F0aW9ucykKICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CiAgICB9LAogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIGtvLnV0aWxzLnNldEh0bWwoZWxlbWVudCwgdmFsdWUpOwogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWydjc3MnXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpIHx8IHt9KTsKICAgICAgICBmb3IgKHZhciBjbGFzc05hbWUgaW4gdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjbGFzc05hbWUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHZhciBzaG91bGRIYXZlQ2xhc3MgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW2NsYXNzTmFtZV0pOwogICAgICAgICAgICAgICAga28udXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSwgc2hvdWxkSGF2ZUNsYXNzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfTsKCmtvLmJpbmRpbmdIYW5kbGVyc1snc3R5bGUnXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpIHx8IHt9KTsKICAgICAgICBmb3IgKHZhciBzdHlsZU5hbWUgaW4gdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBzdHlsZU5hbWUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZVtzdHlsZU5hbWVdKTsKICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGVbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWUgfHwgIiI7IC8vIEVtcHR5IHN0cmluZyByZW1vdmVzIHRoZSB2YWx1ZSwgd2hlcmVhcyBudWxsL3VuZGVmaW5lZCBoYXZlIG5vIGVmZmVjdAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgaWYgKHZhbHVlQWNjZXNzb3IoKSkgewogICAgICAgICAgICBlbGVtZW50Lm5hbWUgPSAia29fdW5pcXVlXyIgKyAoKytrby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXS5jdXJyZW50SW5kZXgpOwoKICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBJRSA2LzcgaXNzdWUKICAgICAgICAgICAgLy8gLSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzE5NwogICAgICAgICAgICAvLyAtIGh0dHA6Ly93d3cubWF0dHM0MTEuY29tL3Bvc3Qvc2V0dGluZ190aGVfbmFtZV9hdHRyaWJ1dGVfaW5faWVfZG9tLwogICAgICAgICAgICBpZiAoa28udXRpbHMuaXNJZTYgfHwga28udXRpbHMuaXNJZTcpCiAgICAgICAgICAgICAgICBlbGVtZW50Lm1lcmdlQXR0cmlidXRlcyhkb2N1bWVudC5jcmVhdGVFbGVtZW50KCI8aW5wdXQgbmFtZT0nIiArIGVsZW1lbnQubmFtZSArICInLz4iKSwgZmFsc2UpOwogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ10uY3VycmVudEluZGV4ID0gMDsKCmtvLmJpbmRpbmdIYW5kbGVyc1snY2hlY2tlZCddID0gewogICAgJ2luaXQnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIHZhciB1cGRhdGVIYW5kbGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZVRvV3JpdGU7CiAgICAgICAgICAgIGlmIChlbGVtZW50LnR5cGUgPT0gImNoZWNrYm94IikgewogICAgICAgICAgICAgICAgdmFsdWVUb1dyaXRlID0gZWxlbWVudC5jaGVja2VkOwogICAgICAgICAgICB9IGVsc2UgaWYgKChlbGVtZW50LnR5cGUgPT0gInJhZGlvIikgJiYgKGVsZW1lbnQuY2hlY2tlZCkpIHsKICAgICAgICAgICAgICAgIHZhbHVlVG9Xcml0ZSA9IGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm47IC8vICJjaGVja2VkIiBiaW5kaW5nIG9ubHkgcmVzcG9uZHMgdG8gY2hlY2tib3hlcyBhbmQgc2VsZWN0ZWQgcmFkaW8gYnV0dG9ucwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKICAgICAgICAgICAgaWYgKChlbGVtZW50LnR5cGUgPT0gImNoZWNrYm94IikgJiYgKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobW9kZWxWYWx1ZSkgaW5zdGFuY2VvZiBBcnJheSkpIHsKICAgICAgICAgICAgICAgIC8vIEZvciBjaGVja2JveGVzIGJvdW5kIHRvIGFuIGFycmF5LCB3ZSBhZGQvcmVtb3ZlIHRoZSBjaGVja2JveCB2YWx1ZSB0byB0aGF0IGFycmF5CiAgICAgICAgICAgICAgICAvLyBUaGlzIHdvcmtzIGZvciBib3RoIG9ic2VydmFibGUgYW5kIG5vbi1vYnNlcnZhYmxlIGFycmF5cwogICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nRW50cnlJbmRleCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG1vZGVsVmFsdWUpLCBlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LmNoZWNrZWQgJiYgKGV4aXN0aW5nRW50cnlJbmRleCA8IDApKQogICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUucHVzaChlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKCghZWxlbWVudC5jaGVja2VkKSAmJiAoZXhpc3RpbmdFbnRyeUluZGV4ID49IDApKQogICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUuc3BsaWNlKGV4aXN0aW5nRW50cnlJbmRleCwgMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBrby5qc29uRXhwcmVzc2lvblJld3JpdGluZy53cml0ZVZhbHVlVG9Qcm9wZXJ0eShtb2RlbFZhbHVlLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCAnY2hlY2tlZCcsIHZhbHVlVG9Xcml0ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJjbGljayIsIHVwZGF0ZUhhbmRsZXIpOwoKICAgICAgICAvLyBJRSA2IHdvbid0IGFsbG93IHJhZGlvIGJ1dHRvbnMgdG8gYmUgc2VsZWN0ZWQgdW5sZXNzIHRoZXkgaGF2ZSBhIG5hbWUKICAgICAgICBpZiAoKGVsZW1lbnQudHlwZSA9PSAicmFkaW8iKSAmJiAhZWxlbWVudC5uYW1lKQogICAgICAgICAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXVsnaW5pdCddKGVsZW1lbnQsIGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZSB9KTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgogICAgICAgIGlmIChlbGVtZW50LnR5cGUgPT0gImNoZWNrYm94IikgewogICAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICAgICAgLy8gV2hlbiBib3VuZCB0byBhbiBhcnJheSwgdGhlIGNoZWNrYm94IGJlaW5nIGNoZWNrZWQgcmVwcmVzZW50cyBpdHMgdmFsdWUgYmVpbmcgcHJlc2VudCBpbiB0aGF0IGFycmF5CiAgICAgICAgICAgICAgICBlbGVtZW50LmNoZWNrZWQgPSBrby51dGlscy5hcnJheUluZGV4T2YodmFsdWUsIGVsZW1lbnQudmFsdWUpID49IDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBXaGVuIGJvdW5kIHRvIGFueXRoaW5nIG90aGVyIHZhbHVlIChub3QgYW4gYXJyYXkpLCB0aGUgY2hlY2tib3ggYmVpbmcgY2hlY2tlZCByZXByZXNlbnRzIHRoZSB2YWx1ZSBiZWluZyB0cnVlaXNoCiAgICAgICAgICAgICAgICBlbGVtZW50LmNoZWNrZWQgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC50eXBlID09ICJyYWRpbyIpIHsKICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gKGVsZW1lbnQudmFsdWUgPT0gdmFsdWUpOwogICAgICAgIH0KICAgIH0KfTsKCnZhciBhdHRySHRtbFRvSmF2YXNjcmlwdE1hcCA9IHsgJ2NsYXNzJzogJ2NsYXNzTmFtZScsICdmb3InOiAnaHRtbEZvcicgfTsKa28uYmluZGluZ0hhbmRsZXJzWydhdHRyJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKSB8fCB7fTsKICAgICAgICBmb3IgKHZhciBhdHRyTmFtZSBpbiB2YWx1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGF0dHJOYW1lID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB2YXIgYXR0clZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZVthdHRyTmFtZV0pOwoKICAgICAgICAgICAgICAgIC8vIFRvIGNvdmVyIGNhc2VzIGxpa2UgImF0dHI6IHsgY2hlY2tlZDpzb21lUHJvcCB9Iiwgd2Ugd2FudCB0byByZW1vdmUgdGhlIGF0dHJpYnV0ZSBlbnRpcmVseQogICAgICAgICAgICAgICAgLy8gd2hlbiBzb21lUHJvcCBpcyBhICJubyB2YWx1ZSItbGlrZSB2YWx1ZSAoc3RyaWN0bHkgbnVsbCwgZmFsc2UsIG9yIHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIC8vIChiZWNhdXNlIHRoZSBhYnNlbmNlIG9mIHRoZSAiY2hlY2tlZCIgYXR0ciBpcyBob3cgdG8gbWFyayBhbiBlbGVtZW50IGFzIG5vdCBjaGVja2VkLCBldGMuKQogICAgICAgICAgICAgICAgdmFyIHRvUmVtb3ZlID0gKGF0dHJWYWx1ZSA9PT0gZmFsc2UpIHx8IChhdHRyVmFsdWUgPT09IG51bGwpIHx8IChhdHRyVmFsdWUgPT09IHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICBpZiAodG9SZW1vdmUpCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpOwoKICAgICAgICAgICAgICAgIC8vIEluIElFIDw9IDcgYW5kIElFOCBRdWlya3MgTW9kZSwgeW91IGhhdmUgdG8gdXNlIHRoZSBKYXZhc2NyaXB0IHByb3BlcnR5IG5hbWUgaW5zdGVhZCBvZiB0aGUKICAgICAgICAgICAgICAgIC8vIEhUTUwgYXR0cmlidXRlIG5hbWUgZm9yIGNlcnRhaW4gYXR0cmlidXRlcy4gSUU4IFN0YW5kYXJkcyBNb2RlIHN1cHBvcnRzIHRoZSBjb3JyZWN0IGJlaGF2aW9yLAogICAgICAgICAgICAgICAgLy8gYnV0IGluc3RlYWQgb2YgZmlndXJpbmcgb3V0IHRoZSBtb2RlLCB3ZSdsbCBqdXN0IHNldCB0aGUgYXR0cmlidXRlIHRocm91Z2ggdGhlIEphdmFzY3JpcHQKICAgICAgICAgICAgICAgIC8vIHByb3BlcnR5IGZvciBJRSA8PSA4LgogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmllVmVyc2lvbiA8PSA4ICYmIGF0dHJOYW1lIGluIGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSBhdHRySHRtbFRvSmF2YXNjcmlwdE1hcFthdHRyTmFtZV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHRvUmVtb3ZlKQogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W2F0dHJOYW1lXSA9IGF0dHJWYWx1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRvUmVtb3ZlKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGF0dHJWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfTsKCmtvLmJpbmRpbmdIYW5kbGVyc1snaGFzZm9jdXMnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIHZhciB3cml0ZVZhbHVlID0gZnVuY3Rpb24odmFsdWVUb1dyaXRlKSB7CiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpOwogICAgICAgICAgICBrby5qc29uRXhwcmVzc2lvblJld3JpdGluZy53cml0ZVZhbHVlVG9Qcm9wZXJ0eShtb2RlbFZhbHVlLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCAnaGFzZm9jdXMnLCB2YWx1ZVRvV3JpdGUsIHRydWUpOwogICAgICAgIH07CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3VzIiwgZnVuY3Rpb24oKSB7IHdyaXRlVmFsdWUodHJ1ZSkgfSk7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3VzaW4iLCBmdW5jdGlvbigpIHsgd3JpdGVWYWx1ZSh0cnVlKSB9KTsgLy8gRm9yIElFCiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImJsdXIiLCAgZnVuY3Rpb24oKSB7IHdyaXRlVmFsdWUoZmFsc2UpIH0pOwogICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJmb2N1c291dCIsICBmdW5jdGlvbigpIHsgd3JpdGVWYWx1ZShmYWxzZSkgfSk7IC8vIEZvciBJRQogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgIHZhbHVlID8gZWxlbWVudC5mb2N1cygpIDogZWxlbWVudC5ibHVyKCk7CiAgICAgICAga28udXRpbHMudHJpZ2dlckV2ZW50KGVsZW1lbnQsIHZhbHVlID8gImZvY3VzaW4iIDogImZvY3Vzb3V0Iik7IC8vIEZvciBJRSwgd2hpY2ggZG9lc24ndCByZWxpYWJseSBmaXJlICJmb2N1cyIgb3IgImJsdXIiIGV2ZW50cyBzeW5jaHJvbm91c2x5CiAgICB9Cn07CgovLyAid2l0aDogc29tZUV4cHJlc3Npb24iIGlzIGVxdWl2YWxlbnQgdG8gInRlbXBsYXRlOiB7IGlmOiBzb21lRXhwcmVzc2lvbiwgZGF0YTogc29tZUV4cHJlc3Npb24gfSIKa28uYmluZGluZ0hhbmRsZXJzWyd3aXRoJ10gPSB7CiAgICBtYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yOiBmdW5jdGlvbih2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgeyB2YXIgdmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7IHJldHVybiB7ICdpZic6IHZhbHVlLCAnZGF0YSc6IHZhbHVlLCAndGVtcGxhdGVFbmdpbmUnOiBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSB9IH07CiAgICB9LAogICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXVsnaW5pdCddKGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVyc1snd2l0aCddLm1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3IodmFsdWVBY2Nlc3NvcikpOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXVsndXBkYXRlJ10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWyd3aXRoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCk7CiAgICB9Cn07CmtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yc1snd2l0aCddID0gZmFsc2U7IC8vIENhbid0IHJld3JpdGUgY29udHJvbCBmbG93IGJpbmRpbmdzCmtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ3dpdGgnXSA9IHRydWU7CgovLyAiaWY6IHNvbWVFeHByZXNzaW9uIiBpcyBlcXVpdmFsZW50IHRvICJ0ZW1wbGF0ZTogeyBpZjogc29tZUV4cHJlc3Npb24gfSIKa28uYmluZGluZ0hhbmRsZXJzWydpZiddID0gewogICAgbWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3NvcjogZnVuY3Rpb24odmFsdWVBY2Nlc3NvcikgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsgcmV0dXJuIHsgJ2lmJzogdmFsdWVBY2Nlc3NvcigpLCAndGVtcGxhdGVFbmdpbmUnOiBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSB9IH07CiAgICB9LAogICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXVsnaW5pdCddKGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVyc1snaWYnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpKTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbJ3RlbXBsYXRlJ11bJ3VwZGF0ZSddKGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVyc1snaWYnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KTsKICAgIH0KfTsKa28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWydpZiddID0gZmFsc2U7IC8vIENhbid0IHJld3JpdGUgY29udHJvbCBmbG93IGJpbmRpbmdzCmtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ2lmJ10gPSB0cnVlOwoKLy8gImlmbm90OiBzb21lRXhwcmVzc2lvbiIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgaWZub3Q6IHNvbWVFeHByZXNzaW9uIH0iCmtvLmJpbmRpbmdIYW5kbGVyc1snaWZub3QnXSA9IHsKICAgIG1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3I6IGZ1bmN0aW9uKHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7IHJldHVybiB7ICdpZm5vdCc6IHZhbHVlQWNjZXNzb3IoKSwgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UgfSB9OwogICAgfSwKICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbJ3RlbXBsYXRlJ11bJ2luaXQnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2lmbm90J10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSk7CiAgICB9LAogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWyd1cGRhdGUnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2lmbm90J10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCk7CiAgICB9Cn07CmtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yc1snaWZub3QnXSA9IGZhbHNlOyAvLyBDYW4ndCByZXdyaXRlIGNvbnRyb2wgZmxvdyBiaW5kaW5ncwprby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWydpZm5vdCddID0gdHJ1ZTsKCi8vICJmb3JlYWNoOiBzb21lRXhwcmVzc2lvbiIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgZm9yZWFjaDogc29tZUV4cHJlc3Npb24gfSIKLy8gImZvcmVhY2g6IHsgZGF0YTogc29tZUV4cHJlc3Npb24sIGFmdGVyQWRkOiBteWZuIH0iIGlzIGVxdWl2YWxlbnQgdG8gInRlbXBsYXRlOiB7IGZvcmVhY2g6IHNvbWVFeHByZXNzaW9uLCBhZnRlckFkZDogbXlmbiB9Igprby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXSA9IHsKICAgIG1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3I6IGZ1bmN0aW9uKHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiaW5kaW5nVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgogICAgICAgICAgICAvLyBJZiBiaW5kaW5nVmFsdWUgaXMgdGhlIGFycmF5LCBqdXN0IHBhc3MgaXQgb24gaXRzIG93bgogICAgICAgICAgICBpZiAoKCFiaW5kaW5nVmFsdWUpIHx8IHR5cGVvZiBiaW5kaW5nVmFsdWUubGVuZ3RoID09ICJudW1iZXIiKQogICAgICAgICAgICAgICAgcmV0dXJuIHsgJ2ZvcmVhY2gnOiBiaW5kaW5nVmFsdWUsICd0ZW1wbGF0ZUVuZ2luZSc6IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlIH07CgogICAgICAgICAgICAvLyBJZiBiaW5kaW5nVmFsdWUuZGF0YSBpcyB0aGUgYXJyYXksIHByZXNlcnZlIGFsbCByZWxldmFudCBvcHRpb25zCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnZm9yZWFjaCc6IGJpbmRpbmdWYWx1ZVsnZGF0YSddLAogICAgICAgICAgICAgICAgJ2luY2x1ZGVEZXN0cm95ZWQnOiBiaW5kaW5nVmFsdWVbJ2luY2x1ZGVEZXN0cm95ZWQnXSwKICAgICAgICAgICAgICAgICdhZnRlckFkZCc6IGJpbmRpbmdWYWx1ZVsnYWZ0ZXJBZGQnXSwKICAgICAgICAgICAgICAgICdiZWZvcmVSZW1vdmUnOiBiaW5kaW5nVmFsdWVbJ2JlZm9yZVJlbW92ZSddLAogICAgICAgICAgICAgICAgJ2FmdGVyUmVuZGVyJzogYmluZGluZ1ZhbHVlWydhZnRlclJlbmRlciddLAogICAgICAgICAgICAgICAgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UKICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgfSwKICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbJ3RlbXBsYXRlJ11bJ2luaXQnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpKTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbJ3RlbXBsYXRlJ11bJ3VwZGF0ZSddKGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVyc1snZm9yZWFjaCddLm1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3IodmFsdWVBY2Nlc3NvciksIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpOwogICAgfQp9Owprby5qc29uRXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbJ2ZvcmVhY2gnXSA9IGZhbHNlOyAvLyBDYW4ndCByZXdyaXRlIGNvbnRyb2wgZmxvdyBiaW5kaW5ncwprby52aXJ0dWFsRWxlbWVudHMuYWxsb3dlZEJpbmRpbmdzWydmb3JlYWNoJ10gPSB0cnVlOwovLyBJZiB5b3Ugd2FudCB0byBtYWtlIGEgY3VzdG9tIHRlbXBsYXRlIGVuZ2luZSwKLy8KLy8gWzFdIEluaGVyaXQgZnJvbSB0aGlzIGNsYXNzIChsaWtlIGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lIGRvZXMpCi8vIFsyXSBPdmVycmlkZSAncmVuZGVyVGVtcGxhdGVTb3VyY2UnLCBzdXBwbHlpbmcgYSBmdW5jdGlvbiB3aXRoIHRoaXMgc2lnbmF0dXJlOgovLwovLyAgICAgICAgZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewovLyAgICAgICAgICAgIC8vIC0gdGVtcGxhdGVTb3VyY2UudGV4dCgpIGlzIHRoZSB0ZXh0IG9mIHRoZSB0ZW1wbGF0ZSB5b3Ugc2hvdWxkIHJlbmRlcgovLyAgICAgICAgICAgIC8vIC0gYmluZGluZ0NvbnRleHQuJGRhdGEgaXMgdGhlIGRhdGEgeW91IHNob3VsZCBwYXNzIGludG8gdGhlIHRlbXBsYXRlCi8vICAgICAgICAgICAgLy8gICAtIHlvdSBtaWdodCBhbHNvIHdhbnQgdG8gbWFrZSBiaW5kaW5nQ29udGV4dC4kcGFyZW50LCBiaW5kaW5nQ29udGV4dC4kcGFyZW50cywKLy8gICAgICAgICAgICAvLyAgICAgYW5kIGJpbmRpbmdDb250ZXh0LiRyb290IGF2YWlsYWJsZSBpbiB0aGUgdGVtcGxhdGUgdG9vCi8vICAgICAgICAgICAgLy8gLSBvcHRpb25zIGdpdmVzIHlvdSBhY2Nlc3MgdG8gYW55IG90aGVyIHByb3BlcnRpZXMgc2V0IG9uICJkYXRhLWJpbmQ6IHsgdGVtcGxhdGU6IG9wdGlvbnMgfSIKLy8gICAgICAgICAgICAvLwovLyAgICAgICAgICAgIC8vIFJldHVybiB2YWx1ZTogYW4gYXJyYXkgb2YgRE9NIG5vZGVzCi8vICAgICAgICB9Ci8vCi8vIFszXSBPdmVycmlkZSAnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJywgc3VwcGx5aW5nIGEgZnVuY3Rpb24gd2l0aCB0aGlzIHNpZ25hdHVyZToKLy8KLy8gICAgICAgIGZ1bmN0aW9uIChzY3JpcHQpIHsKLy8gICAgICAgICAgICAvLyBSZXR1cm4gdmFsdWU6IFdoYXRldmVyIHN5bnRheCBtZWFucyAiRXZhbHVhdGUgdGhlIEphdmFTY3JpcHQgc3RhdGVtZW50ICdzY3JpcHQnIGFuZCBvdXRwdXQgdGhlIHJlc3VsdCIKLy8gICAgICAgICAgICAvLyAgICAgICAgICAgICAgIEZvciBleGFtcGxlLCB0aGUganF1ZXJ5LnRtcGwgdGVtcGxhdGUgZW5naW5lIGNvbnZlcnRzICdzb21lU2NyaXB0JyB0byAnJHsgc29tZVNjcmlwdCB9JwovLyAgICAgICAgfQovLwovLyAgICAgVGhpcyBpcyBvbmx5IG5lY2Vzc2FyeSBpZiB5b3Ugd2FudCB0byBhbGxvdyBkYXRhLWJpbmQgYXR0cmlidXRlcyB0byByZWZlcmVuY2UgYXJiaXRyYXJ5IHRlbXBsYXRlIHZhcmlhYmxlcy4KLy8gICAgIElmIHlvdSBkb24ndCB3YW50IHRvIGFsbG93IHRoYXQsIHlvdSBjYW4gc2V0IHRoZSBwcm9wZXJ0eSAnYWxsb3dUZW1wbGF0ZVJld3JpdGluZycgdG8gZmFsc2UgKGxpa2Uga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUgZG9lcykKLy8gICAgIGFuZCB0aGVuIHlvdSBkb24ndCBuZWVkIHRvIG92ZXJyaWRlICdjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snLgoKa28udGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7IH07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIk92ZXJyaWRlIHJlbmRlclRlbXBsYXRlU291cmNlIik7Cn07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jayddID0gZnVuY3Rpb24gKHNjcmlwdCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJPdmVycmlkZSBjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2siKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsnbWFrZVRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbih0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkgewogICAgLy8gTmFtZWQgdGVtcGxhdGUKICAgIGlmICh0eXBlb2YgdGVtcGxhdGUgPT0gInN0cmluZyIpIHsKICAgICAgICB0ZW1wbGF0ZURvY3VtZW50ID0gdGVtcGxhdGVEb2N1bWVudCB8fCBkb2N1bWVudDsKICAgICAgICB2YXIgZWxlbSA9IHRlbXBsYXRlRG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGVtcGxhdGUpOwogICAgICAgIGlmICghZWxlbSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCB0ZW1wbGF0ZSB3aXRoIElEICIgKyB0ZW1wbGF0ZSk7CiAgICAgICAgcmV0dXJuIG5ldyBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudChlbGVtKTsKICAgIH0gZWxzZSBpZiAoKHRlbXBsYXRlLm5vZGVUeXBlID09IDEpIHx8ICh0ZW1wbGF0ZS5ub2RlVHlwZSA9PSA4KSkgewogICAgICAgIC8vIEFub255bW91cyB0ZW1wbGF0ZQogICAgICAgIHJldHVybiBuZXcga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKHRlbXBsYXRlKTsKICAgIH0gZWxzZQogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biB0ZW1wbGF0ZSB0eXBlOiAiICsgdGVtcGxhdGUpOwp9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZW5kZXJUZW1wbGF0ZSddID0gZnVuY3Rpb24gKHRlbXBsYXRlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgdGVtcGxhdGVEb2N1bWVudCkgewogICAgdmFyIHRlbXBsYXRlU291cmNlID0gdGhpc1snbWFrZVRlbXBsYXRlU291cmNlJ10odGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpOwogICAgcmV0dXJuIHRoaXNbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10odGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsnaXNUZW1wbGF0ZVJld3JpdHRlbiddID0gZnVuY3Rpb24gKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAvLyBTa2lwIHJld3JpdGluZyBpZiByZXF1ZXN0ZWQKICAgIGlmICh0aGlzWydhbGxvd1RlbXBsYXRlUmV3cml0aW5nJ10gPT09IGZhbHNlKQogICAgICAgIHJldHVybiB0cnVlOwoKICAgIC8vIFBlcmYgb3B0aW1pc2F0aW9uIC0gc2VlIGJlbG93CiAgICB2YXIgdGVtcGxhdGVJc0luRXh0ZXJuYWxEb2N1bWVudCA9IHRlbXBsYXRlRG9jdW1lbnQgJiYgdGVtcGxhdGVEb2N1bWVudCAhPSBkb2N1bWVudDsKICAgIGlmICghdGVtcGxhdGVJc0luRXh0ZXJuYWxEb2N1bWVudCAmJiB0aGlzLmtub3duUmV3cml0dGVuVGVtcGxhdGVzICYmIHRoaXMua25vd25SZXdyaXR0ZW5UZW1wbGF0ZXNbdGVtcGxhdGVdKQogICAgICAgIHJldHVybiB0cnVlOwoKICAgIHJldHVybiB0aGlzWydtYWtlVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudClbJ2RhdGEnXSgiaXNSZXdyaXR0ZW4iKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmV3cml0ZVRlbXBsYXRlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIHJld3JpdGVyQ2FsbGJhY2ssIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIHZhciB0ZW1wbGF0ZVNvdXJjZSA9IHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgIHZhciByZXdyaXR0ZW4gPSByZXdyaXRlckNhbGxiYWNrKHRlbXBsYXRlU291cmNlWyd0ZXh0J10oKSk7CiAgICB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKHJld3JpdHRlbik7CiAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCJpc1Jld3JpdHRlbiIsIHRydWUpOwoKICAgIC8vIFBlcmYgb3B0aW1pc2F0aW9uIC0gZm9yIG5hbWVkIHRlbXBsYXRlcywgdHJhY2sgd2hpY2ggb25lcyBoYXZlIGJlZW4gcmV3cml0dGVuIHNvIHdlIGNhbgogICAgLy8gYW5zd2VyICdpc1RlbXBsYXRlUmV3cml0dGVuJyAqd2l0aG91dCogaGF2aW5nIHRvIHVzZSBnZXRFbGVtZW50QnlJZCAod2hpY2ggaXMgc2xvdyBvbiBJRSA8IDgpCiAgICAvLwogICAgLy8gTm90ZSB0aGF0IHdlIG9ubHkgY2FjaGUgdGhlIHN0YXR1cyBmb3IgdGVtcGxhdGVzIGluIHRoZSBtYWluIGRvY3VtZW50LCBiZWNhdXNlIGNhY2hpbmcgb24gYSBwZXItZG9jCiAgICAvLyBiYXNpcyBjb21wbGljYXRlcyB0aGUgaW1wbGVtZW50YXRpb24gZXhjZXNzaXZlbHkuIEluIGEgZnV0dXJlIHZlcnNpb24gb2YgS08sIHdlIHdpbGwgbGlrZWx5IHJlbW92ZQogICAgLy8gdGhpcyAnaXNSZXdyaXR0ZW4nIGNhY2hlIGVudGlyZWx5IGFueXdheSwgYmVjYXVzZSB0aGUgYmVuZWZpdCBpcyBleHRyZW1lbHkgbWlub3IgYW5kIG9ubHkgYXBwbGllcwogICAgLy8gdG8gcmV3cml0YWJsZSB0ZW1wbGF0ZXMsIHdoaWNoIGFyZSBwcmV0dHkgbXVjaCBkZXByZWNhdGVkIHNpbmNlIEtPIDIuMC4KICAgIHZhciB0ZW1wbGF0ZUlzSW5FeHRlcm5hbERvY3VtZW50ID0gdGVtcGxhdGVEb2N1bWVudCAmJiB0ZW1wbGF0ZURvY3VtZW50ICE9IGRvY3VtZW50OwogICAgaWYgKCF0ZW1wbGF0ZUlzSW5FeHRlcm5hbERvY3VtZW50ICYmIHR5cGVvZiB0ZW1wbGF0ZSA9PSAic3RyaW5nIikgewogICAgICAgIHRoaXMua25vd25SZXdyaXR0ZW5UZW1wbGF0ZXMgPSB0aGlzLmtub3duUmV3cml0dGVuVGVtcGxhdGVzIHx8IHt9OwogICAgICAgIHRoaXMua25vd25SZXdyaXR0ZW5UZW1wbGF0ZXNbdGVtcGxhdGVdID0gdHJ1ZTsKICAgIH0KfTsKCmtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVFbmdpbmUnLCBrby50ZW1wbGF0ZUVuZ2luZSk7Cgprby50ZW1wbGF0ZVJld3JpdGluZyA9IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgbWVtb2l6ZURhdGFCaW5kaW5nQXR0cmlidXRlU3ludGF4UmVnZXggPSAvKDxbYS16XStcZCooXHMrKD8hZGF0YS1iaW5kPSlbYS16MC05XC1dKyg9KFwiW15cIl0qXCJ8XCdbXlwnXSpcJykpPykqXHMrKWRhdGEtYmluZD0oWyInXSkoW1xzXFNdKj8pXDUvZ2k7CiAgICB2YXIgbWVtb2l6ZVZpcnR1YWxDb250YWluZXJCaW5kaW5nU3ludGF4UmVnZXggPSAvPCEtLVxzKmtvXGJccyooW1xzXFNdKj8pXHMqLS0+L2c7CgogICAgZnVuY3Rpb24gdmFsaWRhdGVEYXRhQmluZFZhbHVlc0ZvclJld3JpdGluZyhrZXlWYWx1ZUFycmF5KSB7CiAgICAgICAgdmFyIGFsbFZhbGlkYXRvcnMgPSBrby5qc29uRXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnM7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZUFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBrZXlWYWx1ZUFycmF5W2ldWydrZXknXTsKICAgICAgICAgICAgaWYgKGFsbFZhbGlkYXRvcnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgdmFyIHZhbGlkYXRvciA9IGFsbFZhbGlkYXRvcnNba2V5XTsKCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbGlkYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBwb3NzaWJsZUVycm9yTWVzc2FnZSA9IHZhbGlkYXRvcihrZXlWYWx1ZUFycmF5W2ldWyd2YWx1ZSddKTsKICAgICAgICAgICAgICAgICAgICBpZiAocG9zc2libGVFcnJvck1lc3NhZ2UpCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihwb3NzaWJsZUVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF2YWxpZGF0b3IpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgdGVtcGxhdGUgZW5naW5lIGRvZXMgbm90IHN1cHBvcnQgdGhlICciICsga2V5ICsgIicgYmluZGluZyB3aXRoaW4gaXRzIHRlbXBsYXRlcyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSwgdGFnVG9SZXRhaW4sIHRlbXBsYXRlRW5naW5lKSB7CiAgICAgICAgdmFyIGRhdGFCaW5kS2V5VmFsdWVBcnJheSA9IGtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChkYXRhQmluZEF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGRhdGFCaW5kS2V5VmFsdWVBcnJheSk7CiAgICAgICAgdmFyIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgPSBrby5qc29uRXhwcmVzc2lvblJld3JpdGluZy5pbnNlcnRQcm9wZXJ0eUFjY2Vzc29yc0ludG9Kc29uKGRhdGFCaW5kS2V5VmFsdWVBcnJheSk7CgogICAgICAgIC8vIEZvciBubyBvYnZpb3VzIHJlYXNvbiwgT3BlcmEgZmFpbHMgdG8gZXZhbHVhdGUgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSB1bmxlc3MgaXQncyB3cmFwcGVkIGluIGFuIGFkZGl0aW9uYWwKICAgICAgICAvLyBhbm9ueW1vdXMgZnVuY3Rpb24sIGV2ZW4gdGhvdWdoIE9wZXJhJ3MgYnVpbHQtaW4gZGVidWdnZXIgY2FuIGV2YWx1YXRlIGl0IGFueXdheS4gTm8gb3RoZXIgYnJvd3NlciByZXF1aXJlcyB0aGlzCiAgICAgICAgLy8gZXh0cmEgaW5kaXJlY3Rpb24uCiAgICAgICAgdmFyIGFwcGx5QmluZGluZ3NUb05leHRTaWJsaW5nU2NyaXB0ID0gImtvLnRlbXBsYXRlUmV3cml0aW5nLmFwcGx5TWVtb2l6ZWRCaW5kaW5nc1RvTmV4dFNpYmxpbmcoZnVuY3Rpb24oKSB7IFwKICAgICAgICAgICAgcmV0dXJuIChmdW5jdGlvbigpIHsgcmV0dXJuIHsgIiArIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgKyAiIH0gfSkoKSBcCiAgICAgICAgfSkiOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZUVuZ2luZVsnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10oYXBwbHlCaW5kaW5nc1RvTmV4dFNpYmxpbmdTY3JpcHQpICsgdGFnVG9SZXRhaW47CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBlbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuOiBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRW5naW5lLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAgICAgICAgIGlmICghdGVtcGxhdGVFbmdpbmVbJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkpCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUVuZ2luZVsncmV3cml0ZVRlbXBsYXRlJ10odGVtcGxhdGUsIGZ1bmN0aW9uIChodG1sU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnRlbXBsYXRlUmV3cml0aW5nLm1lbW9pemVCaW5kaW5nQXR0cmlidXRlU3ludGF4KGh0bWxTdHJpbmcsIHRlbXBsYXRlRW5naW5lKTsKICAgICAgICAgICAgICAgIH0sIHRlbXBsYXRlRG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIG1lbW9pemVCaW5kaW5nQXR0cmlidXRlU3ludGF4OiBmdW5jdGlvbiAoaHRtbFN0cmluZywgdGVtcGxhdGVFbmdpbmUpIHsKICAgICAgICAgICAgcmV0dXJuIGh0bWxTdHJpbmcucmVwbGFjZShtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzZdLCAvKiB0YWdUb1JldGFpbjogKi8gYXJndW1lbnRzWzFdLCB0ZW1wbGF0ZUVuZ2luZSk7CiAgICAgICAgICAgIH0pLnJlcGxhY2UobWVtb2l6ZVZpcnR1YWxDb250YWluZXJCaW5kaW5nU3ludGF4UmVnZXgsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzFdLCAvKiB0YWdUb1JldGFpbjogKi8gIjwhLS0ga28gLS0+IiwgdGVtcGxhdGVFbmdpbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBhcHBseU1lbW9pemVkQmluZGluZ3NUb05leHRTaWJsaW5nOiBmdW5jdGlvbiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoZnVuY3Rpb24gKGRvbU5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tTm9kZS5uZXh0U2libGluZykKICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlKGRvbU5vZGUubmV4dFNpYmxpbmcsIGJpbmRpbmdzLCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVSZXdyaXRpbmcnLCBrby50ZW1wbGF0ZVJld3JpdGluZyk7CmtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVSZXdyaXRpbmcuYXBwbHlNZW1vaXplZEJpbmRpbmdzVG9OZXh0U2libGluZycsIGtvLnRlbXBsYXRlUmV3cml0aW5nLmFwcGx5TWVtb2l6ZWRCaW5kaW5nc1RvTmV4dFNpYmxpbmcpOyAvLyBFeHBvcnRlZCBvbmx5IGJlY2F1c2UgaXQgaGFzIHRvIGJlIHJlZmVyZW5jZWQgYnkgc3RyaW5nIGxvb2t1cCBmcm9tIHdpdGhpbiByZXdyaXR0ZW4gdGVtcGxhdGUKKGZ1bmN0aW9uKCkgewogICAgLy8gQSB0ZW1wbGF0ZSBzb3VyY2UgcmVwcmVzZW50cyBhIHJlYWQvd3JpdGUgd2F5IG9mIGFjY2Vzc2luZyBhIHRlbXBsYXRlLiBUaGlzIGlzIHRvIGVsaW1pbmF0ZSB0aGUgbmVlZCBmb3IgdGVtcGxhdGUgbG9hZGluZy9zYXZpbmcKICAgIC8vIGxvZ2ljIHRvIGJlIGR1cGxpY2F0ZWQgaW4gZXZlcnkgdGVtcGxhdGUgZW5naW5lIChhbmQgbWVhbnMgdGhleSBjYW4gYWxsIHdvcmsgd2l0aCBhbm9ueW1vdXMgdGVtcGxhdGVzLCBldGMuKQogICAgLy8KICAgIC8vIFR3byBhcmUgcHJvdmlkZWQgYnkgZGVmYXVsdDoKICAgIC8vICAxLiBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCAgICAgICAtIHJlYWRzL3dyaXRlcyB0aGUgdGV4dCBjb250ZW50IG9mIGFuIGFyYml0cmFyeSBET00gZWxlbWVudAogICAgLy8gIDIuIGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNFbGVtZW50IC0gdXNlcyBrby51dGlscy5kb21EYXRhIHRvIHJlYWQvd3JpdGUgdGV4dCAqYXNzb2NpYXRlZCogd2l0aCB0aGUgRE9NIGVsZW1lbnQsIGJ1dAogICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aG91dCByZWFkaW5nL3dyaXRpbmcgdGhlIGFjdHVhbCBlbGVtZW50IHRleHQgY29udGVudCwgc2luY2UgaXQgd2lsbCBiZSBvdmVyd3JpdHRlbgogICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCB0aGUgcmVuZGVyZWQgdGVtcGxhdGUgb3V0cHV0LgogICAgLy8gWW91IGNhbiBpbXBsZW1lbnQgeW91ciBvd24gdGVtcGxhdGUgc291cmNlIGlmIHlvdSB3YW50IHRvIGZldGNoL3N0b3JlIHRlbXBsYXRlcyBzb21ld2hlcmUgb3RoZXIgdGhhbiBpbiBET00gZWxlbWVudHMuCiAgICAvLyBUZW1wbGF0ZSBzb3VyY2VzIG5lZWQgdG8gaGF2ZSB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uczoKICAgIC8vICAgdGV4dCgpICAgICAgICAgICAgIC0gcmV0dXJucyB0aGUgdGVtcGxhdGUgdGV4dCBmcm9tIHlvdXIgc3RvcmFnZSBsb2NhdGlvbgogICAgLy8gICB0ZXh0KHZhbHVlKSAgICAgICAgLSB3cml0ZXMgdGhlIHN1cHBsaWVkIHRlbXBsYXRlIHRleHQgdG8geW91ciBzdG9yYWdlIGxvY2F0aW9uCiAgICAvLyAgIGRhdGEoa2V5KSAgICAgICAgICAgIC0gcmVhZHMgdmFsdWVzIHN0b3JlZCB1c2luZyBkYXRhKGtleSwgdmFsdWUpIC0gc2VlIGJlbG93CiAgICAvLyAgIGRhdGEoa2V5LCB2YWx1ZSkgICAgLSBhc3NvY2lhdGVzICJ2YWx1ZSIgd2l0aCB0aGlzIHRlbXBsYXRlIGFuZCB0aGUga2V5ICJrZXkiLiBJcyB1c2VkIHRvIHN0b3JlIGluZm9ybWF0aW9uIGxpa2UgImlzUmV3cml0dGVuIi4KICAgIC8vCiAgICAvLyBPcHRpb25hbGx5LCB0ZW1wbGF0ZSBzb3VyY2VzIGNhbiBhbHNvIGhhdmUgdGhlIGZvbGxvd2luZyBmdW5jdGlvbnM6CiAgICAvLyAgIG5vZGVzKCkgICAgICAgICAgICAtIHJldHVybnMgYSBET00gZWxlbWVudCBjb250YWluaW5nIHRoZSBub2RlcyBvZiB0aGlzIHRlbXBsYXRlLCB3aGVyZSBhdmFpbGFibGUKICAgIC8vICAgbm9kZXModmFsdWUpICAgICAgIC0gd3JpdGVzIHRoZSBnaXZlbiBET00gZWxlbWVudCB0byB5b3VyIHN0b3JhZ2UgbG9jYXRpb24KICAgIC8vIElmIGEgRE9NIGVsZW1lbnQgaXMgYXZhaWxhYmxlIGZvciBhIGdpdmVuIHRlbXBsYXRlIHNvdXJjZSwgdGVtcGxhdGUgZW5naW5lcyBhcmUgZW5jb3VyYWdlZCB0byB1c2UgaXQgaW4gcHJlZmVyZW5jZSBvdmVyIHRleHQoKQogICAgLy8gZm9yIGltcHJvdmVkIHNwZWVkLiBIb3dldmVyLCBhbGwgdGVtcGxhdGVTb3VyY2VzIG11c3Qgc3VwcGx5IHRleHQoKSBldmVuIGlmIHRoZXkgZG9uJ3Qgc3VwcGx5IG5vZGVzKCkuCiAgICAvLwogICAgLy8gT25jZSB5b3UndmUgaW1wbGVtZW50ZWQgYSB0ZW1wbGF0ZVNvdXJjZSwgbWFrZSB5b3VyIHRlbXBsYXRlIGVuZ2luZSB1c2UgaXQgYnkgc3ViY2xhc3Npbmcgd2hhdGV2ZXIgdGVtcGxhdGUgZW5naW5lIHlvdSB3ZXJlCiAgICAvLyB1c2luZyBhbmQgb3ZlcnJpZGluZyAibWFrZVRlbXBsYXRlU291cmNlIiB0byByZXR1cm4gYW4gaW5zdGFuY2Ugb2YgeW91ciBjdXN0b20gdGVtcGxhdGUgc291cmNlLgoKICAgIGtvLnRlbXBsYXRlU291cmNlcyA9IHt9OwoKICAgIC8vIC0tLS0ga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQgLS0tLS0KCiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICB0aGlzLmRvbUVsZW1lbnQgPSBlbGVtZW50OwogICAgfQoKICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50LnByb3RvdHlwZVsndGV4dCddID0gZnVuY3Rpb24oLyogdmFsdWVUb1dyaXRlICovKSB7CiAgICAgICAgdmFyIHRhZ05hbWVMb3dlciA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcih0aGlzLmRvbUVsZW1lbnQpLAogICAgICAgICAgICBlbGVtQ29udGVudHNQcm9wZXJ0eSA9IHRhZ05hbWVMb3dlciA9PT0gInNjcmlwdCIgPyAidGV4dCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB0YWdOYW1lTG93ZXIgPT09ICJ0ZXh0YXJlYSIgPyAidmFsdWUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogImlubmVySFRNTCI7CgogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tRWxlbWVudFtlbGVtQ29udGVudHNQcm9wZXJ0eV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgaWYgKGVsZW1Db250ZW50c1Byb3BlcnR5ID09PSAiaW5uZXJIVE1MIikKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldEh0bWwodGhpcy5kb21FbGVtZW50LCB2YWx1ZVRvV3JpdGUpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB0aGlzLmRvbUVsZW1lbnRbZWxlbUNvbnRlbnRzUHJvcGVydHldID0gdmFsdWVUb1dyaXRlOwogICAgICAgIH0KICAgIH07CgogICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWydkYXRhJ10gPSBmdW5jdGlvbihrZXkgLyosIHZhbHVlVG9Xcml0ZSAqLykgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHJldHVybiBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsICJ0ZW1wbGF0ZVNvdXJjZURhdGFfIiArIGtleSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCAidGVtcGxhdGVTb3VyY2VEYXRhXyIgKyBrZXksIGFyZ3VtZW50c1sxXSk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyAtLS0tIGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZSAtLS0tLQogICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlcyBhcmUgbm9ybWFsbHkgc2F2ZWQvcmV0cmlldmVkIGFzIERPTSBub2RlcyB0aHJvdWdoICJub2RlcyIuCiAgICAvLyBGb3IgY29tcGF0aWJpbGl0eSwgeW91IGNhbiBhbHNvIHJlYWQgInRleHQiOyBpdCB3aWxsIGJlIHNlcmlhbGl6ZWQgZnJvbSB0aGUgbm9kZXMgb24gZGVtYW5kLgogICAgLy8gV3JpdGluZyB0byAidGV4dCIgaXMgc3RpbGwgc3VwcG9ydGVkLCBidXQgdGhlbiB0aGUgdGVtcGxhdGUgZGF0YSB3aWxsIG5vdCBiZSBhdmFpbGFibGUgYXMgRE9NIG5vZGVzLgoKICAgIHZhciBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5ID0gIl9fa29fYW5vbl90ZW1wbGF0ZV9fIjsKICAgIGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZSA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICB0aGlzLmRvbUVsZW1lbnQgPSBlbGVtZW50OwogICAgfQogICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCgpOwogICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlLnByb3RvdHlwZVsndGV4dCddID0gZnVuY3Rpb24oLyogdmFsdWVUb1dyaXRlICovKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICB2YXIgdGVtcGxhdGVEYXRhID0ga28udXRpbHMuZG9tRGF0YS5nZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5KSB8fCB7fTsKICAgICAgICAgICAgaWYgKHRlbXBsYXRlRGF0YS50ZXh0RGF0YSA9PT0gdW5kZWZpbmVkICYmIHRlbXBsYXRlRGF0YS5jb250YWluZXJEYXRhKQogICAgICAgICAgICAgICAgdGVtcGxhdGVEYXRhLnRleHREYXRhID0gdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGEuaW5uZXJIVE1MOwogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGVEYXRhLnRleHREYXRhOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB2YWx1ZVRvV3JpdGUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KHRoaXMuZG9tRWxlbWVudCwgYW5vbnltb3VzVGVtcGxhdGVzRG9tRGF0YUtleSwge3RleHREYXRhOiB2YWx1ZVRvV3JpdGV9KTsKICAgICAgICB9CiAgICB9OwogICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWydub2RlcyddID0gZnVuY3Rpb24oLyogdmFsdWVUb1dyaXRlICovKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICB2YXIgdGVtcGxhdGVEYXRhID0ga28udXRpbHMuZG9tRGF0YS5nZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5KSB8fCB7fTsKICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlRGF0YS5jb250YWluZXJEYXRhOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB2YWx1ZVRvV3JpdGUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KHRoaXMuZG9tRWxlbWVudCwgYW5vbnltb3VzVGVtcGxhdGVzRG9tRGF0YUtleSwge2NvbnRhaW5lckRhdGE6IHZhbHVlVG9Xcml0ZX0pOwogICAgICAgIH0KICAgIH07CgogICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMnLCBrby50ZW1wbGF0ZVNvdXJjZXMpOwogICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCcsIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50KTsKICAgIGtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlJywga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKTsKfSkoKTsKKGZ1bmN0aW9uICgpIHsKICAgIHZhciBfdGVtcGxhdGVFbmdpbmU7CiAgICBrby5zZXRUZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZUVuZ2luZSkgewogICAgICAgIGlmICgodGVtcGxhdGVFbmdpbmUgIT0gdW5kZWZpbmVkKSAmJiAhKHRlbXBsYXRlRW5naW5lIGluc3RhbmNlb2Yga28udGVtcGxhdGVFbmdpbmUpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRlbXBsYXRlRW5naW5lIG11c3QgaW5oZXJpdCBmcm9tIGtvLnRlbXBsYXRlRW5naW5lIik7CiAgICAgICAgX3RlbXBsYXRlRW5naW5lID0gdGVtcGxhdGVFbmdpbmU7CiAgICB9CgogICAgZnVuY3Rpb24gaW52b2tlRm9yRWFjaE5vZGVPckNvbW1lbnRJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgbm9kZSwgbmV4dEluUXVldWUgPSBmaXJzdE5vZGUsIGZpcnN0T3V0T2ZSYW5nZU5vZGUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcobGFzdE5vZGUpOwogICAgICAgIHdoaWxlIChuZXh0SW5RdWV1ZSAmJiAoKG5vZGUgPSBuZXh0SW5RdWV1ZSkgIT09IGZpcnN0T3V0T2ZSYW5nZU5vZGUpKSB7CiAgICAgICAgICAgIG5leHRJblF1ZXVlID0ga28udmlydHVhbEVsZW1lbnRzLm5leHRTaWJsaW5nKG5vZGUpOwogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSB8fCBub2RlLm5vZGVUeXBlID09PSA4KQogICAgICAgICAgICAgICAgYWN0aW9uKG5vZGUpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhY3RpdmF0ZUJpbmRpbmdzT25Db250aW51b3VzTm9kZUFycmF5KGNvbnRpbnVvdXNOb2RlQXJyYXksIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgLy8gVG8gYmUgdXNlZCBvbiBhbnkgbm9kZXMgdGhhdCBoYXZlIGJlZW4gcmVuZGVyZWQgYnkgYSB0ZW1wbGF0ZSBhbmQgaGF2ZSBiZWVuIGluc2VydGVkIGludG8gc29tZSBwYXJlbnQgZWxlbWVudAogICAgICAgIC8vIFdhbGtzIHRocm91Z2ggY29udGludW91c05vZGVBcnJheSAod2hpY2ggKm11c3QqIGJlIGNvbnRpbnVvdXMsIGkuZS4sIGFuIHVuaW50ZXJydXB0ZWQgc2VxdWVuY2Ugb2Ygc2libGluZyBub2RlcywgYmVjYXVzZQogICAgICAgIC8vIHRoZSBhbGdvcml0aG0gZm9yIHdhbGtpbmcgdGhlbSByZWxpZXMgb24gdGhpcyksIGFuZCBmb3IgZWFjaCB0b3AtbGV2ZWwgaXRlbSBpbiB0aGUgdmlydHVhbC1lbGVtZW50IHNlbnNlLAogICAgICAgIC8vICgxKSBEb2VzIGEgcmVndWxhciAiYXBwbHlCaW5kaW5ncyIgdG8gYXNzb2NpYXRlIGJpbmRpbmdDb250ZXh0IHdpdGggdGhpcyBub2RlIGFuZCB0byBhY3RpdmF0ZSBhbnkgbm9uLW1lbW9pemVkIGJpbmRpbmdzCiAgICAgICAgLy8gKDIpIFVubWVtb2l6ZXMgYW55IG1lbW9zIGluIHRoZSBET00gc3VidHJlZSAoZS5nLiwgdG8gYWN0aXZhdGUgYmluZGluZ3MgdGhhdCBoYWQgYmVlbiBtZW1vaXplZCBkdXJpbmcgdGVtcGxhdGUgcmV3cml0aW5nKQoKICAgICAgICBpZiAoY29udGludW91c05vZGVBcnJheS5sZW5ndGgpIHsKICAgICAgICAgICAgdmFyIGZpcnN0Tm9kZSA9IGNvbnRpbnVvdXNOb2RlQXJyYXlbMF0sIGxhc3ROb2RlID0gY29udGludW91c05vZGVBcnJheVtjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCAtIDFdOwoKICAgICAgICAgICAgLy8gTmVlZCB0byBhcHBseUJpbmRpbmdzICpiZWZvcmUqIHVubWVtb3ppYXRpb24sIGJlY2F1c2UgdW5tZW1vaXphdGlvbiBtaWdodCBpbnRyb2R1Y2UgZXh0cmEgbm9kZXMgKHRoYXQgd2UgZG9uJ3Qgd2FudCB0byByZS1iaW5kKQogICAgICAgICAgICAvLyB3aGVyZWFzIGEgcmVndWxhciBhcHBseUJpbmRpbmdzIHdvbid0IGludHJvZHVjZSBuZXcgbWVtb2l6ZWQgbm9kZXMKICAgICAgICAgICAgaW52b2tlRm9yRWFjaE5vZGVPckNvbW1lbnRJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzKGJpbmRpbmdDb250ZXh0LCBub2RlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGludm9rZUZvckVhY2hOb2RlT3JDb21tZW50SW5Db250aW51b3VzUmFuZ2UoZmlyc3ROb2RlLCBsYXN0Tm9kZSwgZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAga28ubWVtb2l6YXRpb24udW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzKG5vZGUsIFtiaW5kaW5nQ29udGV4dF0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Rmlyc3ROb2RlRnJvbVBvc3NpYmxlQXJyYXkobm9kZU9yTm9kZUFycmF5KSB7CiAgICAgICAgcmV0dXJuIG5vZGVPck5vZGVBcnJheS5ub2RlVHlwZSA/IG5vZGVPck5vZGVBcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBub2RlT3JOb2RlQXJyYXkubGVuZ3RoID4gMCA/IG5vZGVPck5vZGVBcnJheVswXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4ZWN1dGVUZW1wbGF0ZSh0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlck1vZGUsIHRlbXBsYXRlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgIHZhciBmaXJzdFRhcmdldE5vZGUgPSB0YXJnZXROb2RlT3JOb2RlQXJyYXkgJiYgZ2V0Rmlyc3ROb2RlRnJvbVBvc3NpYmxlQXJyYXkodGFyZ2V0Tm9kZU9yTm9kZUFycmF5KTsKICAgICAgICB2YXIgdGVtcGxhdGVEb2N1bWVudCA9IGZpcnN0VGFyZ2V0Tm9kZSAmJiBmaXJzdFRhcmdldE5vZGUub3duZXJEb2N1bWVudDsKICAgICAgICB2YXIgdGVtcGxhdGVFbmdpbmVUb1VzZSA9IChvcHRpb25zWyd0ZW1wbGF0ZUVuZ2luZSddIHx8IF90ZW1wbGF0ZUVuZ2luZSk7CiAgICAgICAga28udGVtcGxhdGVSZXdyaXRpbmcuZW5zdXJlVGVtcGxhdGVJc1Jld3JpdHRlbih0ZW1wbGF0ZSwgdGVtcGxhdGVFbmdpbmVUb1VzZSwgdGVtcGxhdGVEb2N1bWVudCk7CiAgICAgICAgdmFyIHJlbmRlcmVkTm9kZXNBcnJheSA9IHRlbXBsYXRlRW5naW5lVG9Vc2VbJ3JlbmRlclRlbXBsYXRlJ10odGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0ZW1wbGF0ZURvY3VtZW50KTsKCiAgICAgICAgLy8gTG9vc2VseSBjaGVjayByZXN1bHQgaXMgYW4gYXJyYXkgb2YgRE9NIG5vZGVzCiAgICAgICAgaWYgKCh0eXBlb2YgcmVuZGVyZWROb2Rlc0FycmF5Lmxlbmd0aCAhPSAibnVtYmVyIikgfHwgKHJlbmRlcmVkTm9kZXNBcnJheS5sZW5ndGggPiAwICYmIHR5cGVvZiByZW5kZXJlZE5vZGVzQXJyYXlbMF0ubm9kZVR5cGUgIT0gIm51bWJlciIpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRlbXBsYXRlIGVuZ2luZSBtdXN0IHJldHVybiBhbiBhcnJheSBvZiBET00gbm9kZXMiKTsKCiAgICAgICAgdmFyIGhhdmVBZGRlZE5vZGVzVG9QYXJlbnQgPSBmYWxzZTsKICAgICAgICBzd2l0Y2ggKHJlbmRlck1vZGUpIHsKICAgICAgICAgICAgY2FzZSAicmVwbGFjZUNoaWxkcmVuIjoKICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4odGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJlZE5vZGVzQXJyYXkpOwogICAgICAgICAgICAgICAgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAicmVwbGFjZU5vZGUiOgogICAgICAgICAgICAgICAga28udXRpbHMucmVwbGFjZURvbU5vZGVzKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyZWROb2Rlc0FycmF5KTsKICAgICAgICAgICAgICAgIGhhdmVBZGRlZE5vZGVzVG9QYXJlbnQgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlnbm9yZVRhcmdldE5vZGUiOiBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biByZW5kZXJNb2RlOiAiICsgcmVuZGVyTW9kZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCkgewogICAgICAgICAgICBhY3RpdmF0ZUJpbmRpbmdzT25Db250aW51b3VzTm9kZUFycmF5KHJlbmRlcmVkTm9kZXNBcnJheSwgYmluZGluZ0NvbnRleHQpOwogICAgICAgICAgICBpZiAob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSkKICAgICAgICAgICAgICAgIG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10ocmVuZGVyZWROb2Rlc0FycmF5LCBiaW5kaW5nQ29udGV4dFsnJGRhdGEnXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVuZGVyZWROb2Rlc0FycmF5OwogICAgfQoKICAgIGtvLnJlbmRlclRlbXBsYXRlID0gZnVuY3Rpb24gKHRlbXBsYXRlLCBkYXRhT3JCaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgdGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJNb2RlKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgaWYgKChvcHRpb25zWyd0ZW1wbGF0ZUVuZ2luZSddIHx8IF90ZW1wbGF0ZUVuZ2luZSkgPT0gdW5kZWZpbmVkKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNldCBhIHRlbXBsYXRlIGVuZ2luZSBiZWZvcmUgY2FsbGluZyByZW5kZXJUZW1wbGF0ZSIpOwogICAgICAgIHJlbmRlck1vZGUgPSByZW5kZXJNb2RlIHx8ICJyZXBsYWNlQ2hpbGRyZW4iOwoKICAgICAgICBpZiAodGFyZ2V0Tm9kZU9yTm9kZUFycmF5KSB7CiAgICAgICAgICAgIHZhciBmaXJzdFRhcmdldE5vZGUgPSBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheSh0YXJnZXROb2RlT3JOb2RlQXJyYXkpOwoKICAgICAgICAgICAgdmFyIHdoZW5Ub0Rpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7IHJldHVybiAoIWZpcnN0VGFyZ2V0Tm9kZSkgfHwgIWtvLnV0aWxzLmRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudChmaXJzdFRhcmdldE5vZGUpOyB9OyAvLyBQYXNzaXZlIGRpc3Bvc2FsIChvbiBuZXh0IGV2YWx1YXRpb24pCiAgICAgICAgICAgIHZhciBhY3RpdmVseURpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCA9IChmaXJzdFRhcmdldE5vZGUgJiYgcmVuZGVyTW9kZSA9PSAicmVwbGFjZU5vZGUiKSA/IGZpcnN0VGFyZ2V0Tm9kZS5wYXJlbnROb2RlIDogZmlyc3RUYXJnZXROb2RlOwoKICAgICAgICAgICAgcmV0dXJuIGtvLmRlcGVuZGVudE9ic2VydmFibGUoIC8vIFNvIHRoZSBET00gaXMgYXV0b21hdGljYWxseSB1cGRhdGVkIHdoZW4gYW55IGRlcGVuZGVuY3kgY2hhbmdlcwogICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB3ZSd2ZSBnb3QgYSBwcm9wZXIgYmluZGluZyBjb250ZXh0IHRvIHdvcmsgd2l0aAogICAgICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nQ29udGV4dCA9IChkYXRhT3JCaW5kaW5nQ29udGV4dCAmJiAoZGF0YU9yQmluZGluZ0NvbnRleHQgaW5zdGFuY2VvZiBrby5iaW5kaW5nQ29udGV4dCkpCiAgICAgICAgICAgICAgICAgICAgICAgID8gZGF0YU9yQmluZGluZ0NvbnRleHQKICAgICAgICAgICAgICAgICAgICAgICAgOiBuZXcga28uYmluZGluZ0NvbnRleHQoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhT3JCaW5kaW5nQ29udGV4dCkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBTdXBwb3J0IHNlbGVjdGluZyB0ZW1wbGF0ZSBhcyBhIGZ1bmN0aW9uIG9mIHRoZSBkYXRhIGJlaW5nIHJlbmRlcmVkCiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHR5cGVvZih0ZW1wbGF0ZSkgPT0gJ2Z1bmN0aW9uJyA/IHRlbXBsYXRlKGJpbmRpbmdDb250ZXh0WyckZGF0YSddKSA6IHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGVOYW1lLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlck1vZGUgPT0gInJlcGxhY2VOb2RlIikgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXROb2RlT3JOb2RlQXJyYXkgPSByZW5kZXJlZE5vZGVzQXJyYXk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB7ICdkaXNwb3NlV2hlbic6IHdoZW5Ub0Rpc3Bvc2UsICdkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQnOiBhY3RpdmVseURpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCB9CiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gV2UgZG9uJ3QgeWV0IGhhdmUgYSBET00gbm9kZSB0byBldmFsdWF0ZSwgc28gdXNlIGEgbWVtbyBhbmQgcmVuZGVyIHRoZSB0ZW1wbGF0ZSBsYXRlciB3aGVuIHRoZXJlIGlzIGEgRE9NIG5vZGUKICAgICAgICAgICAgcmV0dXJuIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoZnVuY3Rpb24gKGRvbU5vZGUpIHsKICAgICAgICAgICAgICAgIGtvLnJlbmRlclRlbXBsYXRlKHRlbXBsYXRlLCBkYXRhT3JCaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgZG9tTm9kZSwgInJlcGxhY2VOb2RlIik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CgogICAga28ucmVuZGVyVGVtcGxhdGVGb3JFYWNoID0gZnVuY3Rpb24gKHRlbXBsYXRlLCBhcnJheU9yT2JzZXJ2YWJsZUFycmF5LCBvcHRpb25zLCB0YXJnZXROb2RlLCBwYXJlbnRCaW5kaW5nQ29udGV4dCkgewogICAgICAgIC8vIFNpbmNlIHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcgYWx3YXlzIGNhbGxzIGV4ZWN1dGVUZW1wbGF0ZUZvckFycmF5SXRlbSBhbmQgdGhlbgogICAgICAgIC8vIGFjdGl2YXRlQmluZGluZ3NDYWxsYmFjayBmb3IgYWRkZWQgaXRlbXMsIHdlIGNhbiBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IGluIHRoZSBmb3JtZXIgdG8gdXNlIGluIHRoZSBsYXR0ZXIuCiAgICAgICAgdmFyIGFycmF5SXRlbUNvbnRleHQ7CgogICAgICAgIC8vIFRoaXMgd2lsbCBiZSBjYWxsZWQgYnkgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyB0byBnZXQgdGhlIG5vZGVzIHRvIGFkZCB0byB0YXJnZXROb2RlCiAgICAgICAgdmFyIGV4ZWN1dGVUZW1wbGF0ZUZvckFycmF5SXRlbSA9IGZ1bmN0aW9uIChhcnJheVZhbHVlLCBpbmRleCkgewogICAgICAgICAgICAvLyBTdXBwb3J0IHNlbGVjdGluZyB0ZW1wbGF0ZSBhcyBhIGZ1bmN0aW9uIG9mIHRoZSBkYXRhIGJlaW5nIHJlbmRlcmVkCiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZU5hbWUgPSB0eXBlb2YodGVtcGxhdGUpID09ICdmdW5jdGlvbicgPyB0ZW1wbGF0ZShhcnJheVZhbHVlKSA6IHRlbXBsYXRlOwogICAgICAgICAgICBhcnJheUl0ZW1Db250ZXh0ID0gcGFyZW50QmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXJyYXlWYWx1ZSkpOwogICAgICAgICAgICBhcnJheUl0ZW1Db250ZXh0WyckaW5kZXgnXSA9IGluZGV4OwogICAgICAgICAgICByZXR1cm4gZXhlY3V0ZVRlbXBsYXRlKG51bGwsICJpZ25vcmVUYXJnZXROb2RlIiwgdGVtcGxhdGVOYW1lLCBhcnJheUl0ZW1Db250ZXh0LCBvcHRpb25zKTsKICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyBoYXMgYWRkZWQgbm9kZXMgdG8gdGFyZ2V0Tm9kZQogICAgICAgIHZhciBhY3RpdmF0ZUJpbmRpbmdzQ2FsbGJhY2sgPSBmdW5jdGlvbihhcnJheVZhbHVlLCBhZGRlZE5vZGVzQXJyYXksIGluZGV4KSB7CiAgICAgICAgICAgIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkoYWRkZWROb2Rlc0FycmF5LCBhcnJheUl0ZW1Db250ZXh0KTsKICAgICAgICAgICAgaWYgKG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10pCiAgICAgICAgICAgICAgICBvcHRpb25zWydhZnRlclJlbmRlciddKGFkZGVkTm9kZXNBcnJheSwgYXJyYXlWYWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGtvLmRlcGVuZGVudE9ic2VydmFibGUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdW53cmFwcGVkQXJyYXkgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFycmF5T3JPYnNlcnZhYmxlQXJyYXkpIHx8IFtdOwogICAgICAgICAgICBpZiAodHlwZW9mIHVud3JhcHBlZEFycmF5Lmxlbmd0aCA9PSAidW5kZWZpbmVkIikgLy8gQ29lcmNlIHNpbmdsZSB2YWx1ZSBpbnRvIGFycmF5CiAgICAgICAgICAgICAgICB1bndyYXBwZWRBcnJheSA9IFt1bndyYXBwZWRBcnJheV07CgogICAgICAgICAgICAvLyBGaWx0ZXIgb3V0IGFueSBlbnRyaWVzIG1hcmtlZCBhcyBkZXN0cm95ZWQKICAgICAgICAgICAgdmFyIGZpbHRlcmVkQXJyYXkgPSBrby51dGlscy5hcnJheUZpbHRlcih1bndyYXBwZWRBcnJheSwgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnNbJ2luY2x1ZGVEZXN0cm95ZWQnXSB8fCBpdGVtID09PSB1bmRlZmluZWQgfHwgaXRlbSA9PT0gbnVsbCB8fCAha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShpdGVtWydfZGVzdHJveSddKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBrby51dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nKHRhcmdldE5vZGUsIGZpbHRlcmVkQXJyYXksIGV4ZWN1dGVUZW1wbGF0ZUZvckFycmF5SXRlbSwgb3B0aW9ucywgYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrKTsKCiAgICAgICAgfSwgbnVsbCwgeyAnZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkJzogdGFyZ2V0Tm9kZSB9KTsKICAgIH07CgogICAgdmFyIHRlbXBsYXRlU3Vic2NyaXB0aW9uRG9tRGF0YUtleSA9ICdfX2tvX190ZW1wbGF0ZVN1YnNjcmlwdGlvbkRvbURhdGFLZXlfXyc7CiAgICBmdW5jdGlvbiBkaXNwb3NlT2xkU3Vic2NyaXB0aW9uQW5kU3RvcmVOZXdPbmUoZWxlbWVudCwgbmV3U3Vic2NyaXB0aW9uKSB7CiAgICAgICAgdmFyIG9sZFN1YnNjcmlwdGlvbiA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIHRlbXBsYXRlU3Vic2NyaXB0aW9uRG9tRGF0YUtleSk7CiAgICAgICAgaWYgKG9sZFN1YnNjcmlwdGlvbiAmJiAodHlwZW9mKG9sZFN1YnNjcmlwdGlvbi5kaXNwb3NlKSA9PSAnZnVuY3Rpb24nKSkKICAgICAgICAgICAgb2xkU3Vic2NyaXB0aW9uLmRpc3Bvc2UoKTsKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCB0ZW1wbGF0ZVN1YnNjcmlwdGlvbkRvbURhdGFLZXksIG5ld1N1YnNjcmlwdGlvbik7CiAgICB9CgogICAga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddID0gewogICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgICAgICAvLyBTdXBwb3J0IGFub255bW91cyB0ZW1wbGF0ZXMKICAgICAgICAgICAgdmFyIGJpbmRpbmdWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKICAgICAgICAgICAgaWYgKCh0eXBlb2YgYmluZGluZ1ZhbHVlICE9ICJzdHJpbmciKSAmJiAoIWJpbmRpbmdWYWx1ZVsnbmFtZSddKSAmJiAoZWxlbWVudC5ub2RlVHlwZSA9PSAxIHx8IGVsZW1lbnQubm9kZVR5cGUgPT0gOCkpIHsKICAgICAgICAgICAgICAgIC8vIEl0J3MgYW4gYW5vbnltb3VzIHRlbXBsYXRlIC0gc3RvcmUgdGhlIGVsZW1lbnQgY29udGVudHMsIHRoZW4gY2xlYXIgdGhlIGVsZW1lbnQKICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZU5vZGVzID0gZWxlbWVudC5ub2RlVHlwZSA9PSAxID8gZWxlbWVudC5jaGlsZE5vZGVzIDoga28udmlydHVhbEVsZW1lbnRzLmNoaWxkTm9kZXMoZWxlbWVudCksCiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyID0ga28udXRpbHMubW92ZUNsZWFuZWROb2Rlc1RvQ29udGFpbmVyRWxlbWVudCh0ZW1wbGF0ZU5vZGVzKTsgLy8gVGhpcyBhbHNvIHJlbW92ZXMgdGhlIG5vZGVzIGZyb20gdGhlaXIgY3VycmVudCBwYXJlbnQKICAgICAgICAgICAgICAgIG5ldyBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUoZWxlbWVudClbJ25vZGVzJ10oY29udGFpbmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CiAgICAgICAgfSwKICAgICAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgdmFyIGJpbmRpbmdWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZTsKICAgICAgICAgICAgdmFyIHNob3VsZERpc3BsYXkgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBiaW5kaW5nVmFsdWUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHRlbXBsYXRlTmFtZSA9IGJpbmRpbmdWYWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRlbXBsYXRlTmFtZSA9IGJpbmRpbmdWYWx1ZVsnbmFtZSddOwoKICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQgImlmIi8iaWZub3QiIGNvbmRpdGlvbnMKICAgICAgICAgICAgICAgIGlmICgnaWYnIGluIGJpbmRpbmdWYWx1ZSkKICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gc2hvdWxkRGlzcGxheSAmJiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGJpbmRpbmdWYWx1ZVsnaWYnXSk7CiAgICAgICAgICAgICAgICBpZiAoJ2lmbm90JyBpbiBiaW5kaW5nVmFsdWUpCiAgICAgICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9IHNob3VsZERpc3BsYXkgJiYgIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYmluZGluZ1ZhbHVlWydpZm5vdCddKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHRlbXBsYXRlU3Vic2NyaXB0aW9uID0gbnVsbDsKCiAgICAgICAgICAgIGlmICgodHlwZW9mIGJpbmRpbmdWYWx1ZSA9PT0gJ29iamVjdCcpICYmICgnZm9yZWFjaCcgaW4gYmluZGluZ1ZhbHVlKSkgeyAvLyBOb3RlOiBjYW4ndCB1c2UgJ2luJyBvcGVyYXRvciBvbiBzdHJpbmdzCiAgICAgICAgICAgICAgICAvLyBSZW5kZXIgb25jZSBmb3IgZWFjaCBkYXRhIHBvaW50ICh0cmVhdGluZyBkYXRhIHNldCBhcyBlbXB0eSBpZiBzaG91bGREaXNwbGF5PT1mYWxzZSkKICAgICAgICAgICAgICAgIHZhciBkYXRhQXJyYXkgPSAoc2hvdWxkRGlzcGxheSAmJiBiaW5kaW5nVmFsdWVbJ2ZvcmVhY2gnXSkgfHwgW107CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVN1YnNjcmlwdGlvbiA9IGtvLnJlbmRlclRlbXBsYXRlRm9yRWFjaCh0ZW1wbGF0ZU5hbWUgfHwgZWxlbWVudCwgZGF0YUFycmF5LCAvKiBvcHRpb25zOiAqLyBiaW5kaW5nVmFsdWUsIGVsZW1lbnQsIGJpbmRpbmdDb250ZXh0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGREaXNwbGF5KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVuZGVyIG9uY2UgZm9yIHRoaXMgc2luZ2xlIGRhdGEgcG9pbnQgKG9yIHVzZSB0aGUgdmlld01vZGVsIGlmIG5vIGRhdGEgd2FzIHByb3ZpZGVkKQogICAgICAgICAgICAgICAgICAgIHZhciBpbm5lckJpbmRpbmdDb250ZXh0ID0gKHR5cGVvZiBiaW5kaW5nVmFsdWUgPT0gJ29iamVjdCcpICYmICgnZGF0YScgaW4gYmluZGluZ1ZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICA/IGJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGJpbmRpbmdWYWx1ZVsnZGF0YSddKSkgLy8gR2l2ZW4gYW4gZXhwbGl0aXQgJ2RhdGEnIHZhbHVlLCB3ZSBjcmVhdGUgYSBjaGlsZCBiaW5kaW5nIGNvbnRleHQgZm9yIGl0CiAgICAgICAgICAgICAgICAgICAgICAgIDogYmluZGluZ0NvbnRleHQ7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHaXZlbiBubyBleHBsaWNpdCAnZGF0YScgdmFsdWUsIHdlIHJldGFpbiB0aGUgc2FtZSBiaW5kaW5nIGNvbnRleHQKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVN1YnNjcmlwdGlvbiA9IGtvLnJlbmRlclRlbXBsYXRlKHRlbXBsYXRlTmFtZSB8fCBlbGVtZW50LCBpbm5lckJpbmRpbmdDb250ZXh0LCAvKiBvcHRpb25zOiAqLyBiaW5kaW5nVmFsdWUsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShlbGVtZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSXQgb25seSBtYWtlcyBzZW5zZSB0byBoYXZlIGEgc2luZ2xlIHRlbXBsYXRlIHN1YnNjcmlwdGlvbiBwZXIgZWxlbWVudCAob3RoZXJ3aXNlIHdoaWNoIG9uZSBzaG91bGQgaGF2ZSBpdHMgb3V0cHV0IGRpc3BsYXllZD8pCiAgICAgICAgICAgIGRpc3Bvc2VPbGRTdWJzY3JpcHRpb25BbmRTdG9yZU5ld09uZShlbGVtZW50LCB0ZW1wbGF0ZVN1YnNjcmlwdGlvbik7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGVzIGNhbid0IGJlIHJld3JpdHRlbi4gR2l2ZSBhIG5pY2UgZXJyb3IgbWVzc2FnZSBpZiB5b3UgdHJ5IHRvIGRvIGl0LgogICAga28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWyd0ZW1wbGF0ZSddID0gZnVuY3Rpb24oYmluZGluZ1ZhbHVlKSB7CiAgICAgICAgdmFyIHBhcnNlZEJpbmRpbmdWYWx1ZSA9IGtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChiaW5kaW5nVmFsdWUpOwoKICAgICAgICBpZiAoKHBhcnNlZEJpbmRpbmdWYWx1ZS5sZW5ndGggPT0gMSkgJiYgcGFyc2VkQmluZGluZ1ZhbHVlWzBdWyd1bmtub3duJ10pCiAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBJdCBsb29rcyBsaWtlIGEgc3RyaW5nIGxpdGVyYWwsIG5vdCBhbiBvYmplY3QgbGl0ZXJhbCwgc28gdHJlYXQgaXQgYXMgYSBuYW1lZCB0ZW1wbGF0ZSAod2hpY2ggaXMgYWxsb3dlZCBmb3IgcmV3cml0aW5nKQoKICAgICAgICBpZiAoa28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcua2V5VmFsdWVBcnJheUNvbnRhaW5zS2V5KHBhcnNlZEJpbmRpbmdWYWx1ZSwgIm5hbWUiKSkKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIE5hbWVkIHRlbXBsYXRlcyBjYW4gYmUgcmV3cml0dGVuLCBzbyByZXR1cm4gIm5vIGVycm9yIgogICAgICAgIHJldHVybiAiVGhpcyB0ZW1wbGF0ZSBlbmdpbmUgZG9lcyBub3Qgc3VwcG9ydCBhbm9ueW1vdXMgdGVtcGxhdGVzIG5lc3RlZCB3aXRoaW4gaXRzIHRlbXBsYXRlcyI7CiAgICB9OwoKICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ3RlbXBsYXRlJ10gPSB0cnVlOwp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCdzZXRUZW1wbGF0ZUVuZ2luZScsIGtvLnNldFRlbXBsYXRlRW5naW5lKTsKa28uZXhwb3J0U3ltYm9sKCdyZW5kZXJUZW1wbGF0ZScsIGtvLnJlbmRlclRlbXBsYXRlKTsKCihmdW5jdGlvbiAoKSB7CiAgICAvLyBTaW1wbGUgY2FsY3VsYXRpb24gYmFzZWQgb24gTGV2ZW5zaHRlaW4gZGlzdGFuY2UuCiAgICBmdW5jdGlvbiBjYWxjdWxhdGVFZGl0RGlzdGFuY2VNYXRyaXgob2xkQXJyYXksIG5ld0FycmF5LCBtYXhBbGxvd2VkRGlzdGFuY2UpIHsKICAgICAgICB2YXIgZGlzdGFuY2VzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gbmV3QXJyYXkubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIGRpc3RhbmNlc1tpXSA9IFtdOwoKICAgICAgICAvLyBUb3Agcm93IC0gdHJhbnNmb3JtIG9sZCBhcnJheSBpbnRvIGVtcHR5IGFycmF5IHZpYSBkZWxldGlvbnMKICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IE1hdGgubWluKG9sZEFycmF5Lmxlbmd0aCwgbWF4QWxsb3dlZERpc3RhbmNlKTsgaSA8PSBqOyBpKyspCiAgICAgICAgICAgIGRpc3RhbmNlc1swXVtpXSA9IGk7CgogICAgICAgIC8vIExlZnQgcm93IC0gdHJhbnNmb3JtIGVtcHR5IGFycmF5IGludG8gbmV3IGFycmF5IHZpYSBhZGRpdGlvbnMKICAgICAgICBmb3IgKHZhciBpID0gMSwgaiA9IE1hdGgubWluKG5ld0FycmF5Lmxlbmd0aCwgbWF4QWxsb3dlZERpc3RhbmNlKTsgaSA8PSBqOyBpKyspIHsKICAgICAgICAgICAgZGlzdGFuY2VzW2ldWzBdID0gaTsKICAgICAgICB9CgogICAgICAgIC8vIEZpbGwgb3V0IHRoZSBib2R5IG9mIHRoZSBhcnJheQogICAgICAgIHZhciBvbGRJbmRleCwgb2xkSW5kZXhNYXggPSBvbGRBcnJheS5sZW5ndGgsIG5ld0luZGV4LCBuZXdJbmRleE1heCA9IG5ld0FycmF5Lmxlbmd0aDsKICAgICAgICB2YXIgZGlzdGFuY2VWaWFBZGRpdGlvbiwgZGlzdGFuY2VWaWFEZWxldGlvbjsKICAgICAgICBmb3IgKG9sZEluZGV4ID0gMTsgb2xkSW5kZXggPD0gb2xkSW5kZXhNYXg7IG9sZEluZGV4KyspIHsKICAgICAgICAgICAgdmFyIG5ld0luZGV4TWluRm9yUm93ID0gTWF0aC5tYXgoMSwgb2xkSW5kZXggLSBtYXhBbGxvd2VkRGlzdGFuY2UpOwogICAgICAgICAgICB2YXIgbmV3SW5kZXhNYXhGb3JSb3cgPSBNYXRoLm1pbihuZXdJbmRleE1heCwgb2xkSW5kZXggKyBtYXhBbGxvd2VkRGlzdGFuY2UpOwogICAgICAgICAgICBmb3IgKG5ld0luZGV4ID0gbmV3SW5kZXhNaW5Gb3JSb3c7IG5ld0luZGV4IDw9IG5ld0luZGV4TWF4Rm9yUm93OyBuZXdJbmRleCsrKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkQXJyYXlbb2xkSW5kZXggLSAxXSA9PT0gbmV3QXJyYXlbbmV3SW5kZXggLSAxXSkKICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZXNbbmV3SW5kZXhdW29sZEluZGV4XSA9IGRpc3RhbmNlc1tuZXdJbmRleCAtIDFdW29sZEluZGV4IC0gMV07CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbm9ydGhEaXN0YW5jZSA9IGRpc3RhbmNlc1tuZXdJbmRleCAtIDFdW29sZEluZGV4XSA9PT0gdW5kZWZpbmVkID8gTnVtYmVyLk1BWF9WQUxVRSA6IGRpc3RhbmNlc1tuZXdJbmRleCAtIDFdW29sZEluZGV4XSArIDE7CiAgICAgICAgICAgICAgICAgICAgdmFyIHdlc3REaXN0YW5jZSA9IGRpc3RhbmNlc1tuZXdJbmRleF1bb2xkSW5kZXggLSAxXSA9PT0gdW5kZWZpbmVkID8gTnVtYmVyLk1BWF9WQUxVRSA6IGRpc3RhbmNlc1tuZXdJbmRleF1bb2xkSW5kZXggLSAxXSArIDE7CiAgICAgICAgICAgICAgICAgICAgZGlzdGFuY2VzW25ld0luZGV4XVtvbGRJbmRleF0gPSBNYXRoLm1pbihub3J0aERpc3RhbmNlLCB3ZXN0RGlzdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGlzdGFuY2VzOwogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmRFZGl0U2NyaXB0RnJvbUVkaXREaXN0YW5jZU1hdHJpeChlZGl0RGlzdGFuY2VNYXRyaXgsIG9sZEFycmF5LCBuZXdBcnJheSkgewogICAgICAgIHZhciBvbGRJbmRleCA9IG9sZEFycmF5Lmxlbmd0aDsKICAgICAgICB2YXIgbmV3SW5kZXggPSBuZXdBcnJheS5sZW5ndGg7CiAgICAgICAgdmFyIGVkaXRTY3JpcHQgPSBbXTsKICAgICAgICB2YXIgbWF4RGlzdGFuY2UgPSBlZGl0RGlzdGFuY2VNYXRyaXhbbmV3SW5kZXhdW29sZEluZGV4XTsKICAgICAgICBpZiAobWF4RGlzdGFuY2UgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIG1heEFsbG93ZWREaXN0YW5jZSBtdXN0IGJlIHRvbyBzbWFsbAogICAgICAgIHdoaWxlICgob2xkSW5kZXggPiAwKSB8fCAobmV3SW5kZXggPiAwKSkgewogICAgICAgICAgICB2YXIgbWUgPSBlZGl0RGlzdGFuY2VNYXRyaXhbbmV3SW5kZXhdW29sZEluZGV4XTsKICAgICAgICAgICAgdmFyIGRpc3RhbmNlVmlhQWRkID0gKG5ld0luZGV4ID4gMCkgPyBlZGl0RGlzdGFuY2VNYXRyaXhbbmV3SW5kZXggLSAxXVtvbGRJbmRleF0gOiBtYXhEaXN0YW5jZSArIDE7CiAgICAgICAgICAgIHZhciBkaXN0YW5jZVZpYURlbGV0ZSA9IChvbGRJbmRleCA+IDApID8gZWRpdERpc3RhbmNlTWF0cml4W25ld0luZGV4XVtvbGRJbmRleCAtIDFdIDogbWF4RGlzdGFuY2UgKyAxOwogICAgICAgICAgICB2YXIgZGlzdGFuY2VWaWFSZXRhaW4gPSAobmV3SW5kZXggPiAwKSAmJiAob2xkSW5kZXggPiAwKSA/IGVkaXREaXN0YW5jZU1hdHJpeFtuZXdJbmRleCAtIDFdW29sZEluZGV4IC0gMV0gOiBtYXhEaXN0YW5jZSArIDE7CiAgICAgICAgICAgIGlmICgoZGlzdGFuY2VWaWFBZGQgPT09IHVuZGVmaW5lZCkgfHwgKGRpc3RhbmNlVmlhQWRkIDwgbWUgLSAxKSkgZGlzdGFuY2VWaWFBZGQgPSBtYXhEaXN0YW5jZSArIDE7CiAgICAgICAgICAgIGlmICgoZGlzdGFuY2VWaWFEZWxldGUgPT09IHVuZGVmaW5lZCkgfHwgKGRpc3RhbmNlVmlhRGVsZXRlIDwgbWUgLSAxKSkgZGlzdGFuY2VWaWFEZWxldGUgPSBtYXhEaXN0YW5jZSArIDE7CiAgICAgICAgICAgIGlmIChkaXN0YW5jZVZpYVJldGFpbiA8IG1lIC0gMSkgZGlzdGFuY2VWaWFSZXRhaW4gPSBtYXhEaXN0YW5jZSArIDE7CgogICAgICAgICAgICBpZiAoKGRpc3RhbmNlVmlhQWRkIDw9IGRpc3RhbmNlVmlhRGVsZXRlKSAmJiAoZGlzdGFuY2VWaWFBZGQgPCBkaXN0YW5jZVZpYVJldGFpbikpIHsKICAgICAgICAgICAgICAgIGVkaXRTY3JpcHQucHVzaCh7IHN0YXR1czogImFkZGVkIiwgdmFsdWU6IG5ld0FycmF5W25ld0luZGV4IC0gMV0gfSk7CiAgICAgICAgICAgICAgICBuZXdJbmRleC0tOwogICAgICAgICAgICB9IGVsc2UgaWYgKChkaXN0YW5jZVZpYURlbGV0ZSA8IGRpc3RhbmNlVmlhQWRkKSAmJiAoZGlzdGFuY2VWaWFEZWxldGUgPCBkaXN0YW5jZVZpYVJldGFpbikpIHsKICAgICAgICAgICAgICAgIGVkaXRTY3JpcHQucHVzaCh7IHN0YXR1czogImRlbGV0ZWQiLCB2YWx1ZTogb2xkQXJyYXlbb2xkSW5kZXggLSAxXSB9KTsKICAgICAgICAgICAgICAgIG9sZEluZGV4LS07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlZGl0U2NyaXB0LnB1c2goeyBzdGF0dXM6ICJyZXRhaW5lZCIsIHZhbHVlOiBvbGRBcnJheVtvbGRJbmRleCAtIDFdIH0pOwogICAgICAgICAgICAgICAgbmV3SW5kZXgtLTsKICAgICAgICAgICAgICAgIG9sZEluZGV4LS07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVkaXRTY3JpcHQucmV2ZXJzZSgpOwogICAgfQoKICAgIGtvLnV0aWxzLmNvbXBhcmVBcnJheXMgPSBmdW5jdGlvbiAob2xkQXJyYXksIG5ld0FycmF5LCBtYXhFZGl0c1RvQ29uc2lkZXIpIHsKICAgICAgICBpZiAobWF4RWRpdHNUb0NvbnNpZGVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmNvbXBhcmVBcnJheXMob2xkQXJyYXksIG5ld0FycmF5LCAxKSAgICAgICAgICAgICAgICAgLy8gRmlyc3QgY29uc2lkZXIgbGlrZWx5IGNhc2Ugd2hlcmUgdGhlcmUgaXMgYXQgbW9zdCBvbmUgZWRpdCAodmVyeSBmYXN0KQogICAgICAgICAgICAgICAgfHwga28udXRpbHMuY29tcGFyZUFycmF5cyhvbGRBcnJheSwgbmV3QXJyYXksIDEwKSAgICAgICAgICAgICAgICAvLyBJZiB0aGF0IGZhaWxzLCBhY2NvdW50IGZvciBhIGZhaXIgbnVtYmVyIG9mIGNoYW5nZXMgd2hpbGUgc3RpbGwgYmVpbmcgZmFzdAogICAgICAgICAgICAgICAgfHwga28udXRpbHMuY29tcGFyZUFycmF5cyhvbGRBcnJheSwgbmV3QXJyYXksIE51bWJlci5NQVhfVkFMVUUpOyAvLyBVbHRpbWF0ZWx5IGdpdmUgdGhlIHJpZ2h0IGFuc3dlciwgZXZlbiB0aG91Z2ggaXQgbWF5IHRha2UgYSBsb25nIHRpbWUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvbGRBcnJheSA9IG9sZEFycmF5IHx8IFtdOwogICAgICAgICAgICBuZXdBcnJheSA9IG5ld0FycmF5IHx8IFtdOwogICAgICAgICAgICB2YXIgZWRpdERpc3RhbmNlTWF0cml4ID0gY2FsY3VsYXRlRWRpdERpc3RhbmNlTWF0cml4KG9sZEFycmF5LCBuZXdBcnJheSwgbWF4RWRpdHNUb0NvbnNpZGVyKTsKICAgICAgICAgICAgcmV0dXJuIGZpbmRFZGl0U2NyaXB0RnJvbUVkaXREaXN0YW5jZU1hdHJpeChlZGl0RGlzdGFuY2VNYXRyaXgsIG9sZEFycmF5LCBuZXdBcnJheSk7CiAgICAgICAgfQogICAgfTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuY29tcGFyZUFycmF5cycsIGtvLnV0aWxzLmNvbXBhcmVBcnJheXMpOwoKKGZ1bmN0aW9uICgpIHsKICAgIC8vIE9iamVjdGl2ZToKICAgIC8vICogR2l2ZW4gYW4gaW5wdXQgYXJyYXksIGEgY29udGFpbmVyIERPTSBub2RlLCBhbmQgYSBmdW5jdGlvbiBmcm9tIGFycmF5IGVsZW1lbnRzIHRvIGFycmF5cyBvZiBET00gbm9kZXMsCiAgICAvLyAgIG1hcCB0aGUgYXJyYXkgZWxlbWVudHMgdG8gYXJyYXlzIG9mIERPTSBub2RlcywgY29uY2F0ZW5hdGUgdG9nZXRoZXIgYWxsIHRoZXNlIGFycmF5cywgYW5kIHVzZSB0aGVtIHRvIHBvcHVsYXRlIHRoZSBjb250YWluZXIgRE9NIG5vZGUKICAgIC8vICogTmV4dCB0aW1lIHdlJ3JlIGdpdmVuIHRoZSBzYW1lIGNvbWJpbmF0aW9uIG9mIHRoaW5ncyAod2l0aCB0aGUgYXJyYXkgcG9zc2libHkgaGF2aW5nIG11dGF0ZWQpLCB1cGRhdGUgdGhlIGNvbnRhaW5lciBET00gbm9kZQogICAgLy8gICBzbyB0aGF0IGl0cyBjaGlsZHJlbiBpcyBhZ2FpbiB0aGUgY29uY2F0ZW5hdGlvbiBvZiB0aGUgbWFwcGluZ3Mgb2YgdGhlIGFycmF5IGVsZW1lbnRzLCBidXQgZG9uJ3QgcmUtbWFwIGFueSBhcnJheSBlbGVtZW50cyB0aGF0IHdlCiAgICAvLyAgIHByZXZpb3VzbHkgbWFwcGVkIC0gcmV0YWluIHRob3NlIG5vZGVzLCBhbmQganVzdCBpbnNlcnQvZGVsZXRlIG90aGVyIG9uZXMKCiAgICAvLyAiY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzIiB3aWxsIGJlIGludm9rZWQgYWZ0ZXIgYW55ICJtYXBwaW5nIi1nZW5lcmF0ZWQgbm9kZXMgYXJlIGluc2VydGVkIGludG8gdGhlIGNvbnRhaW5lciBub2RlCiAgICAvLyBZb3UgY2FuIHVzZSB0aGlzLCBmb3IgZXhhbXBsZSwgdG8gYWN0aXZhdGUgYmluZGluZ3Mgb24gdGhvc2Ugbm9kZXMuCgogICAgZnVuY3Rpb24gZml4VXBWaXJ0dWFsRWxlbWVudHMoY29udGlndW91c05vZGVBcnJheSkgewogICAgICAgIC8vIEVuc3VyZXMgdGhhdCBjb250aWd1b3VzTm9kZUFycmF5IHJlYWxseSAqaXMqIGFuIGFycmF5IG9mIGNvbnRpZ3VvdXMgc2libGluZ3MsIGV2ZW4gaWYgc29tZSBvZiB0aGUgaW50ZXJpb3IKICAgICAgICAvLyBvbmVzIGhhdmUgY2hhbmdlZCBzaW5jZSB5b3VyIGFycmF5IHdhcyBmaXJzdCBidWlsdCAoZS5nLiwgYmVjYXVzZSB5b3VyIGFycmF5IGNvbnRhaW5zIHZpcnR1YWwgZWxlbWVudHMsIGFuZAogICAgICAgIC8vIHRoZWlyIHZpcnR1YWwgY2hpbGRyZW4gY2hhbmdlZCB3aGVuIGJpbmRpbmcgd2FzIGFwcGxpZWQgdG8gdGhlbSkuCiAgICAgICAgLy8gVGhpcyBpcyBuZWVkZWQgc28gdGhhdCB3ZSBjYW4gcmVsaWFibHkgcmVtb3ZlIG9yIHVwZGF0ZSB0aGUgbm9kZXMgY29ycmVzcG9uZGluZyB0byBhIGdpdmVuIGFycmF5IGl0ZW0KCiAgICAgICAgaWYgKGNvbnRpZ3VvdXNOb2RlQXJyYXkubGVuZ3RoID4gMikgewogICAgICAgICAgICAvLyBCdWlsZCB1cCB0aGUgYWN0dWFsIG5ldyBjb250aWd1b3VzIG5vZGUgc2V0CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY29udGlndW91c05vZGVBcnJheVswXSwgbGFzdCA9IGNvbnRpZ3VvdXNOb2RlQXJyYXlbY29udGlndW91c05vZGVBcnJheS5sZW5ndGggLSAxXSwgbmV3Q29udGlndW91c1NldCA9IFtjdXJyZW50XTsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IGxhc3QpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50Lm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50KSAvLyBXb24ndCBoYXBwZW4sIGV4Y2VwdCBpZiB0aGUgZGV2ZWxvcGVyIGhhcyBtYW51YWxseSByZW1vdmVkIHNvbWUgRE9NIGVsZW1lbnRzICh0aGVuIHdlJ3JlIGluIGFuIHVuZGVmaW5lZCBzY2VuYXJpbykKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBuZXdDb250aWd1b3VzU2V0LnB1c2goY3VycmVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIC4uLiB0aGVuIG11dGF0ZSB0aGUgaW5wdXQgYXJyYXkgdG8gbWF0Y2ggdGhpcy4KICAgICAgICAgICAgLy8gKFRoZSBmb2xsb3dpbmcgbGluZSByZXBsYWNlcyB0aGUgY29udGVudHMgb2YgY29udGlndW91c05vZGVBcnJheSB3aXRoIG5ld0NvbnRpZ3VvdXNTZXQpCiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYXBwbHkoY29udGlndW91c05vZGVBcnJheSwgWzAsIGNvbnRpZ3VvdXNOb2RlQXJyYXkubGVuZ3RoXS5jb25jYXQobmV3Q29udGlndW91c1NldCkpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGNvbnRhaW5lck5vZGUsIG1hcHBpbmcsIHZhbHVlVG9NYXAsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgaW5kZXgpIHsKICAgICAgICAvLyBNYXAgdGhpcyBhcnJheSB2YWx1ZSBpbnNpZGUgYSBkZXBlbmRlbnRPYnNlcnZhYmxlIHNvIHdlIHJlLW1hcCB3aGVuIGFueSBkZXBlbmRlbmN5IGNoYW5nZXMKICAgICAgICB2YXIgbWFwcGVkTm9kZXMgPSBbXTsKICAgICAgICB2YXIgZGVwZW5kZW50T2JzZXJ2YWJsZSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBuZXdNYXBwZWROb2RlcyA9IG1hcHBpbmcodmFsdWVUb01hcCwgaW5kZXgpIHx8IFtdOwoKICAgICAgICAgICAgLy8gT24gc3Vic2VxdWVudCBldmFsdWF0aW9ucywganVzdCByZXBsYWNlIHRoZSBwcmV2aW91c2x5LWluc2VydGVkIERPTSBub2RlcwogICAgICAgICAgICBpZiAobWFwcGVkTm9kZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgZml4VXBWaXJ0dWFsRWxlbWVudHMobWFwcGVkTm9kZXMpOwogICAgICAgICAgICAgICAga28udXRpbHMucmVwbGFjZURvbU5vZGVzKG1hcHBlZE5vZGVzLCBuZXdNYXBwZWROb2Rlcyk7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKQogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2Rlcyh2YWx1ZVRvTWFwLCBuZXdNYXBwZWROb2Rlcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJlcGxhY2UgdGhlIGNvbnRlbnRzIG9mIHRoZSBtYXBwZWROb2RlcyBhcnJheSwgdGhlcmVieSB1cGRhdGluZyB0aGUgcmVjb3JkCiAgICAgICAgICAgIC8vIG9mIHdoaWNoIG5vZGVzIHdvdWxkIGJlIGRlbGV0ZWQgaWYgdmFsdWVUb01hcCB3YXMgaXRzZWxmIGxhdGVyIHJlbW92ZWQKICAgICAgICAgICAgbWFwcGVkTm9kZXMuc3BsaWNlKDAsIG1hcHBlZE5vZGVzLmxlbmd0aCk7CiAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UHVzaEFsbChtYXBwZWROb2RlcywgbmV3TWFwcGVkTm9kZXMpOwogICAgICAgIH0sIG51bGwsIHsgJ2Rpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCc6IGNvbnRhaW5lck5vZGUsICdkaXNwb3NlV2hlbic6IGZ1bmN0aW9uKCkgeyByZXR1cm4gKG1hcHBlZE5vZGVzLmxlbmd0aCA9PSAwKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KG1hcHBlZE5vZGVzWzBdKSB9IH0pOwogICAgICAgIHJldHVybiB7IG1hcHBlZE5vZGVzIDogbWFwcGVkTm9kZXMsIGRlcGVuZGVudE9ic2VydmFibGUgOiBkZXBlbmRlbnRPYnNlcnZhYmxlIH07CiAgICB9CgogICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0RG9tRGF0YUtleSA9ICJzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nX2xhc3RNYXBwaW5nUmVzdWx0IjsKCiAgICBrby51dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nID0gZnVuY3Rpb24gKGRvbU5vZGUsIGFycmF5LCBtYXBwaW5nLCBvcHRpb25zLCBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMpIHsKICAgICAgICAvLyBDb21wYXJlIHRoZSBwcm92aWRlZCBhcnJheSBhZ2FpbnN0IHRoZSBwcmV2aW91cyBvbmUKICAgICAgICBhcnJheSA9IGFycmF5IHx8IFtdOwogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgIHZhciBpc0ZpcnN0RXhlY3V0aW9uID0ga28udXRpbHMuZG9tRGF0YS5nZXQoZG9tTm9kZSwgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5KSA9PT0gdW5kZWZpbmVkOwogICAgICAgIHZhciBsYXN0TWFwcGluZ1Jlc3VsdCA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGRvbU5vZGUsIGxhc3RNYXBwaW5nUmVzdWx0RG9tRGF0YUtleSkgfHwgW107CiAgICAgICAgdmFyIGxhc3RBcnJheSA9IGtvLnV0aWxzLmFycmF5TWFwKGxhc3RNYXBwaW5nUmVzdWx0LCBmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5hcnJheUVudHJ5OyB9KTsKICAgICAgICB2YXIgZWRpdFNjcmlwdCA9IGtvLnV0aWxzLmNvbXBhcmVBcnJheXMobGFzdEFycmF5LCBhcnJheSk7CgogICAgICAgIC8vIEJ1aWxkIHRoZSBuZXcgbWFwcGluZyByZXN1bHQKICAgICAgICB2YXIgbmV3TWFwcGluZ1Jlc3VsdCA9IFtdOwogICAgICAgIHZhciBsYXN0TWFwcGluZ1Jlc3VsdEluZGV4ID0gMDsKICAgICAgICB2YXIgbm9kZXNUb0RlbGV0ZSA9IFtdOwogICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwogICAgICAgIHZhciBub2Rlc0FkZGVkID0gW107CiAgICAgICAgdmFyIGluc2VydEFmdGVyTm9kZSA9IG51bGw7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBlZGl0U2NyaXB0Lmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICBzd2l0Y2ggKGVkaXRTY3JpcHRbaV0uc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlICJyZXRhaW5lZCI6CiAgICAgICAgICAgICAgICAgICAgLy8gSnVzdCBrZWVwIHRoZSBpbmZvcm1hdGlvbiAtIGRvbid0IHRvdWNoIHRoZSBub2RlcwogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhVG9SZXRhaW4gPSBsYXN0TWFwcGluZ1Jlc3VsdFtsYXN0TWFwcGluZ1Jlc3VsdEluZGV4XTsKICAgICAgICAgICAgICAgICAgICBkYXRhVG9SZXRhaW4uaW5kZXhPYnNlcnZhYmxlKG5ld01hcHBpbmdSZXN1bHRJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgbmV3TWFwcGluZ1Jlc3VsdEluZGV4ID0gbmV3TWFwcGluZ1Jlc3VsdC5wdXNoKGRhdGFUb1JldGFpbik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFUb1JldGFpbi5kb21Ob2Rlcy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnRBZnRlck5vZGUgPSBkYXRhVG9SZXRhaW4uZG9tTm9kZXNbZGF0YVRvUmV0YWluLmRvbU5vZGVzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgICAgIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICJkZWxldGVkIjoKICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIHRyYWNraW5nIGNoYW5nZXMgdG8gdGhlIG1hcHBpbmcgZm9yIHRoZXNlIG5vZGVzCiAgICAgICAgICAgICAgICAgICAgbGFzdE1hcHBpbmdSZXN1bHRbbGFzdE1hcHBpbmdSZXN1bHRJbmRleF0uZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKCk7CgogICAgICAgICAgICAgICAgICAgIC8vIFF1ZXVlIHRoZXNlIG5vZGVzIGZvciBsYXRlciByZW1vdmFsCiAgICAgICAgICAgICAgICAgICAgZml4VXBWaXJ0dWFsRWxlbWVudHMobGFzdE1hcHBpbmdSZXN1bHRbbGFzdE1hcHBpbmdSZXN1bHRJbmRleF0uZG9tTm9kZXMpOwogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChsYXN0TWFwcGluZ1Jlc3VsdFtsYXN0TWFwcGluZ1Jlc3VsdEluZGV4XS5kb21Ob2RlcywgZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb0RlbGV0ZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiBub2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBpLAogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBlZGl0U2NyaXB0W2ldLnZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnRBZnRlck5vZGUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICJhZGRlZCI6CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlVG9NYXAgPSBlZGl0U2NyaXB0W2ldLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHZhciBpbmRleE9ic2VydmFibGUgPSBrby5vYnNlcnZhYmxlKG5ld01hcHBpbmdSZXN1bHRJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hcERhdGEgPSBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGRvbU5vZGUsIG1hcHBpbmcsIHZhbHVlVG9NYXAsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgaW5kZXhPYnNlcnZhYmxlKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFwcGVkTm9kZXMgPSBtYXBEYXRhLm1hcHBlZE5vZGVzOwoKICAgICAgICAgICAgICAgICAgICAvLyBPbiB0aGUgZmlyc3QgZXZhbHVhdGlvbiwgaW5zZXJ0IHRoZSBub2RlcyBhdCB0aGUgY3VycmVudCBpbnNlcnRpb24gcG9pbnQKICAgICAgICAgICAgICAgICAgICBuZXdNYXBwaW5nUmVzdWx0SW5kZXggPSBuZXdNYXBwaW5nUmVzdWx0LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBhcnJheUVudHJ5OiBlZGl0U2NyaXB0W2ldLnZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICBkb21Ob2RlczogbWFwcGVkTm9kZXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGU6IG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZSwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhPYnNlcnZhYmxlOiBpbmRleE9ic2VydmFibGUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBub2RlSW5kZXggPSAwLCBub2RlSW5kZXhNYXggPSBtYXBwZWROb2Rlcy5sZW5ndGg7IG5vZGVJbmRleCA8IG5vZGVJbmRleE1heDsgbm9kZUluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBtYXBwZWROb2Rlc1tub2RlSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc0FkZGVkLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IG5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6IGksCiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGVkaXRTY3JpcHRbaV0udmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnNlcnRBZnRlck5vZGUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zZXJ0ICJub2RlIiAodGhlIG5ld2x5LWNyZWF0ZWQgbm9kZSkgYXMgZG9tTm9kZSdzIGZpcnN0IGNoaWxkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMucHJlcGVuZChkb21Ob2RlLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluc2VydCAibm9kZSIgaW50byAiZG9tTm9kZSIgaW1tZWRpYXRlbHkgYWZ0ZXIgImluc2VydEFmdGVyTm9kZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5pbnNlcnRBZnRlcihkb21Ob2RlLCBub2RlLCBpbnNlcnRBZnRlck5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydEFmdGVyTm9kZSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMpCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2Rlcyh2YWx1ZVRvTWFwLCBtYXBwZWROb2RlcywgaW5kZXhPYnNlcnZhYmxlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKG5vZGVzVG9EZWxldGUsIGZ1bmN0aW9uIChub2RlKSB7IGtvLmNsZWFuTm9kZShub2RlLmVsZW1lbnQpIH0pOwoKICAgICAgICB2YXIgaW52b2tlZEJlZm9yZVJlbW92ZUNhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgaWYgKCFpc0ZpcnN0RXhlY3V0aW9uKSB7CiAgICAgICAgICAgIGlmIChvcHRpb25zWydhZnRlckFkZCddKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGVzQWRkZWQubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc1snYWZ0ZXJBZGQnXShub2Rlc0FkZGVkW2ldLmVsZW1lbnQsIG5vZGVzQWRkZWRbaV0uaW5kZXgsIG5vZGVzQWRkZWRbaV0udmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zWydiZWZvcmVSZW1vdmUnXSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2Rlc1RvRGVsZXRlLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgIG9wdGlvbnNbJ2JlZm9yZVJlbW92ZSddKG5vZGVzVG9EZWxldGVbaV0uZWxlbWVudCwgbm9kZXNUb0RlbGV0ZVtpXS5pbmRleCwgbm9kZXNUb0RlbGV0ZVtpXS52YWx1ZSk7CiAgICAgICAgICAgICAgICBpbnZva2VkQmVmb3JlUmVtb3ZlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghaW52b2tlZEJlZm9yZVJlbW92ZUNhbGxiYWNrICYmIG5vZGVzVG9EZWxldGUubGVuZ3RoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXNUb0RlbGV0ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBub2Rlc1RvRGVsZXRlW2ldLmVsZW1lbnQ7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5wYXJlbnROb2RlKQogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gU3RvcmUgYSBjb3B5IG9mIHRoZSBhcnJheSBpdGVtcyB3ZSBqdXN0IGNvbnNpZGVyZWQgc28gd2UgY2FuIGRpZmZlcmVuY2UgaXQgbmV4dCB0aW1lCiAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQoZG9tTm9kZSwgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5LCBuZXdNYXBwaW5nUmVzdWx0KTsKICAgIH0KfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZycsIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcpOwprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXNbJ2FsbG93VGVtcGxhdGVSZXdyaXRpbmcnXSA9IGZhbHNlOwp9Cgprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGUgPSBuZXcga28udGVtcGxhdGVFbmdpbmUoKTsKa28ubmF0aXZlVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgdmFyIHVzZU5vZGVzSWZBdmFpbGFibGUgPSAhKGtvLnV0aWxzLmllVmVyc2lvbiA8IDkpLCAvLyBJRTw5IGNsb25lTm9kZSBkb2Vzbid0IHdvcmsgcHJvcGVybHkKICAgICAgICB0ZW1wbGF0ZU5vZGVzRnVuYyA9IHVzZU5vZGVzSWZBdmFpbGFibGUgPyB0ZW1wbGF0ZVNvdXJjZVsnbm9kZXMnXSA6IG51bGwsCiAgICAgICAgdGVtcGxhdGVOb2RlcyA9IHRlbXBsYXRlTm9kZXNGdW5jID8gdGVtcGxhdGVTb3VyY2VbJ25vZGVzJ10oKSA6IG51bGw7CgogICAgaWYgKHRlbXBsYXRlTm9kZXMpIHsKICAgICAgICByZXR1cm4ga28udXRpbHMubWFrZUFycmF5KHRlbXBsYXRlTm9kZXMuY2xvbmVOb2RlKHRydWUpLmNoaWxkTm9kZXMpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgdGVtcGxhdGVUZXh0ID0gdGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpOwogICAgICAgIHJldHVybiBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudCh0ZW1wbGF0ZVRleHQpOwogICAgfQp9OwoKa28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UgPSBuZXcga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUoKTsKa28uc2V0VGVtcGxhdGVFbmdpbmUoa28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UpOwoKa28uZXhwb3J0U3ltYm9sKCduYXRpdmVUZW1wbGF0ZUVuZ2luZScsIGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lKTsKKGZ1bmN0aW9uKCkgewogICAga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIERldGVjdCB3aGljaCB2ZXJzaW9uIG9mIGpxdWVyeS10bXBsIHlvdSdyZSB1c2luZy4gVW5mb3J0dW5hdGVseSBqcXVlcnktdG1wbAogICAgICAgIC8vIGRvZXNuJ3QgZXhwb3NlIGEgdmVyc2lvbiBudW1iZXIsIHNvIHdlIGhhdmUgdG8gaW5mZXIgaXQuCiAgICAgICAgLy8gTm90ZSB0aGF0IGFzIG9mIEtub2Nrb3V0IDEuMywgd2Ugb25seSBzdXBwb3J0IGpRdWVyeS50bXBsIDEuMC4wcHJlIGFuZCBsYXRlciwKICAgICAgICAvLyB3aGljaCBLTyBpbnRlcm5hbGx5IHJlZmVycyB0byBhcyB2ZXJzaW9uICIyIiwgc28gb2xkZXIgdmVyc2lvbnMgYXJlIG5vIGxvbmdlciBkZXRlY3RlZC4KICAgICAgICB2YXIgalF1ZXJ5VG1wbFZlcnNpb24gPSB0aGlzLmpRdWVyeVRtcGxWZXJzaW9uID0gKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoKHR5cGVvZihqUXVlcnkpID09ICJ1bmRlZmluZWQiKSB8fCAhKGpRdWVyeVsndG1wbCddKSkKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAvLyBTaW5jZSBpdCBleHBvc2VzIG5vIG9mZmljaWFsIHZlcnNpb24gbnVtYmVyLCB3ZSB1c2Ugb3VyIG93biBudW1iZXJpbmcgc3lzdGVtLiBUbyBiZSB1cGRhdGVkIGFzIGpxdWVyeS10bXBsIGV2b2x2ZXMuCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5Wyd0bXBsJ11bJ3RhZyddWyd0bXBsJ11bJ29wZW4nXS50b1N0cmluZygpLmluZGV4T2YoJ19fJykgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIFNpbmNlIDEuMC4wcHJlLCBjdXN0b20gdGFncyBzaG91bGQgYXBwZW5kIG1hcmt1cCB0byBhbiBhcnJheSBjYWxsZWQgIl9fIgogICAgICAgICAgICAgICAgICAgIHJldHVybiAyOyAvLyBGaW5hbCB2ZXJzaW9uIG9mIGpxdWVyeS50bXBsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZXgpIHsgLyogQXBwYXJlbnRseSBub3QgdGhlIHZlcnNpb24gd2Ugd2VyZSBsb29raW5nIGZvciAqLyB9CgogICAgICAgICAgICByZXR1cm4gMTsgLy8gQW55IG9sZGVyIHZlcnNpb24gdGhhdCB3ZSBkb24ndCBzdXBwb3J0CiAgICAgICAgfSkoKTsKCiAgICAgICAgZnVuY3Rpb24gZW5zdXJlSGFzUmVmZXJlbmNlZEpRdWVyeVRlbXBsYXRlcygpIHsKICAgICAgICAgICAgaWYgKGpRdWVyeVRtcGxWZXJzaW9uIDwgMikKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiWW91ciB2ZXJzaW9uIG9mIGpRdWVyeS50bXBsIGlzIHRvbyBvbGQuIFBsZWFzZSB1cGdyYWRlIHRvIGpRdWVyeS50bXBsIDEuMC4wcHJlIG9yIGxhdGVyLiIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKGNvbXBpbGVkVGVtcGxhdGUsIGRhdGEsIGpRdWVyeVRlbXBsYXRlT3B0aW9ucykgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5Wyd0bXBsJ10oY29tcGlsZWRUZW1wbGF0ZSwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKTsKICAgICAgICB9CgogICAgICAgIHRoaXNbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbih0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICAgIGVuc3VyZUhhc1JlZmVyZW5jZWRKUXVlcnlUZW1wbGF0ZXMoKTsKCiAgICAgICAgICAgIC8vIEVuc3VyZSB3ZSBoYXZlIHN0b3JlZCBhIHByZWNvbXBpbGVkIHZlcnNpb24gb2YgdGhpcyB0ZW1wbGF0ZSAoZG9uJ3Qgd2FudCB0byByZXBhcnNlIG9uIGV2ZXJ5IHJlbmRlcikKICAgICAgICAgICAgdmFyIHByZWNvbXBpbGVkID0gdGVtcGxhdGVTb3VyY2VbJ2RhdGEnXSgncHJlY29tcGlsZWQnKTsKICAgICAgICAgICAgaWYgKCFwcmVjb21waWxlZCkgewogICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlVGV4dCA9IHRlbXBsYXRlU291cmNlWyd0ZXh0J10oKSB8fCAiIjsKICAgICAgICAgICAgICAgIC8vIFdyYXAgaW4gIndpdGgoJHdoYXRldmVyLmtvQmluZGluZ0NvbnRleHQpIHsgLi4uIH0iCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVRleHQgPSAie3trb193aXRoICRpdGVtLmtvQmluZGluZ0NvbnRleHR9fSIgKyB0ZW1wbGF0ZVRleHQgKyAie3sva29fd2l0aH19IjsKCiAgICAgICAgICAgICAgICBwcmVjb21waWxlZCA9IGpRdWVyeVsndGVtcGxhdGUnXShudWxsLCB0ZW1wbGF0ZVRleHQpOwogICAgICAgICAgICAgICAgdGVtcGxhdGVTb3VyY2VbJ2RhdGEnXSgncHJlY29tcGlsZWQnLCBwcmVjb21waWxlZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkYXRhID0gW2JpbmRpbmdDb250ZXh0WyckZGF0YSddXTsgLy8gUHJld3JhcCB0aGUgZGF0YSBpbiBhbiBhcnJheSB0byBzdG9wIGpxdWVyeS50bXBsIGZyb20gdHJ5aW5nIHRvIHVud3JhcCBhbnkgYXJyYXlzCiAgICAgICAgICAgIHZhciBqUXVlcnlUZW1wbGF0ZU9wdGlvbnMgPSBqUXVlcnlbJ2V4dGVuZCddKHsgJ2tvQmluZGluZ0NvbnRleHQnOiBiaW5kaW5nQ29udGV4dCB9LCBvcHRpb25zWyd0ZW1wbGF0ZU9wdGlvbnMnXSk7CgogICAgICAgICAgICB2YXIgcmVzdWx0Tm9kZXMgPSBleGVjdXRlVGVtcGxhdGUocHJlY29tcGlsZWQsIGRhdGEsIGpRdWVyeVRlbXBsYXRlT3B0aW9ucyk7CiAgICAgICAgICAgIHJlc3VsdE5vZGVzWydhcHBlbmRUbyddKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsgLy8gVXNpbmcgImFwcGVuZFRvIiBmb3JjZXMgalF1ZXJ5L2pRdWVyeS50bXBsIHRvIHBlcmZvcm0gbmVjZXNzYXJ5IGNsZWFudXAgd29yawoKICAgICAgICAgICAgalF1ZXJ5WydmcmFnbWVudHMnXSA9IHt9OyAvLyBDbGVhciBqUXVlcnkncyBmcmFnbWVudCBjYWNoZSB0byBhdm9pZCBhIG1lbW9yeSBsZWFrIGFmdGVyIGEgbGFyZ2UgbnVtYmVyIG9mIHRlbXBsYXRlIHJlbmRlcnMKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdE5vZGVzOwogICAgICAgIH07CgogICAgICAgIHRoaXNbJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jayddID0gZnVuY3Rpb24oc2NyaXB0KSB7CiAgICAgICAgICAgIHJldHVybiAie3trb19jb2RlICgoZnVuY3Rpb24oKSB7IHJldHVybiAiICsgc2NyaXB0ICsgIiB9KSgpKSB9fSI7CiAgICAgICAgfTsKCiAgICAgICAgdGhpc1snYWRkVGVtcGxhdGUnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlTmFtZSwgdGVtcGxhdGVNYXJrdXApIHsKICAgICAgICAgICAgZG9jdW1lbnQud3JpdGUoIjxzY3JpcHQgdHlwZT0ndGV4dC9odG1sJyBpZD0nIiArIHRlbXBsYXRlTmFtZSArICInPiIgKyB0ZW1wbGF0ZU1hcmt1cCArICI8L3NjcmlwdD4iKTsKICAgICAgICB9OwoKICAgICAgICBpZiAoalF1ZXJ5VG1wbFZlcnNpb24gPiAwKSB7CiAgICAgICAgICAgIGpRdWVyeVsndG1wbCddWyd0YWcnXVsna29fY29kZSddID0gewogICAgICAgICAgICAgICAgb3BlbjogIl9fLnB1c2goJDEgfHwgJycpOyIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgalF1ZXJ5Wyd0bXBsJ11bJ3RhZyddWydrb193aXRoJ10gPSB7CiAgICAgICAgICAgICAgICBvcGVuOiAid2l0aCgkMSkgeyIsCiAgICAgICAgICAgICAgICBjbG9zZTogIn0gIgogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH07CgogICAga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpOwoKICAgIC8vIFVzZSB0aGlzIG9uZSBieSBkZWZhdWx0ICpvbmx5IGlmIGpxdWVyeS50bXBsIGlzIHJlZmVyZW5jZWQqCiAgICB2YXIganF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lSW5zdGFuY2UgPSBuZXcga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lKCk7CiAgICBpZiAoanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lSW5zdGFuY2UualF1ZXJ5VG1wbFZlcnNpb24gPiAwKQogICAgICAgIGtvLnNldFRlbXBsYXRlRW5naW5lKGpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZUluc3RhbmNlKTsKCiAgICBrby5leHBvcnRTeW1ib2woJ2pxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZScsIGtvLmpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZSk7Cn0pKCk7Cn0pOwp9KSh3aW5kb3csZG9jdW1lbnQsbmF2aWdhdG9yKTsKCi8qKgogKiBAbGljZW5zZSBSZXF1aXJlSlMgdGV4dCAyLjAuMSBDb3B5cmlnaHQgKGMpIDIwMTAtMjAxMiwgVGhlIERvam8gRm91bmRhdGlvbiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKiBBdmFpbGFibGUgdmlhIHRoZSBNSVQgb3IgbmV3IEJTRCBsaWNlbnNlLgogKiBzZWU6IGh0dHA6Ly9naXRodWIuY29tL3JlcXVpcmVqcy90ZXh0IGZvciBkZXRhaWxzCiAqLwovKmpzbGludCByZWdleHA6IHRydWUgKi8KLypnbG9iYWwgcmVxdWlyZTogZmFsc2UsIFhNTEh0dHBSZXF1ZXN0OiBmYWxzZSwgQWN0aXZlWE9iamVjdDogZmFsc2UsCiAgZGVmaW5lOiBmYWxzZSwgd2luZG93OiBmYWxzZSwgcHJvY2VzczogZmFsc2UsIFBhY2thZ2VzOiBmYWxzZSwKICBqYXZhOiBmYWxzZSwgbG9jYXRpb246IGZhbHNlICovCgpkZWZpbmUoJ3RleHQnLFsnbW9kdWxlJ10sIGZ1bmN0aW9uIChtb2R1bGUpIHsKICAgIAoKICAgIHZhciBwcm9nSWRzID0gWydNc3htbDIuWE1MSFRUUCcsICdNaWNyb3NvZnQuWE1MSFRUUCcsICdNc3htbDIuWE1MSFRUUC40LjAnXSwKICAgICAgICB4bWxSZWdFeHAgPSAvXlxzKjxcP3htbChccykrdmVyc2lvbj1bXCdcIl0oXGQpKi4oXGQpKltcJ1wiXShccykqXD8+L2ltLAogICAgICAgIGJvZHlSZWdFeHAgPSAvPGJvZHlbXj5dKj5ccyooW1xzXFNdKylccyo8XC9ib2R5Pi9pbSwKICAgICAgICBoYXNMb2NhdGlvbiA9IHR5cGVvZiBsb2NhdGlvbiAhPT0gJ3VuZGVmaW5lZCcgJiYgbG9jYXRpb24uaHJlZiwKICAgICAgICBkZWZhdWx0UHJvdG9jb2wgPSBoYXNMb2NhdGlvbiAmJiBsb2NhdGlvbi5wcm90b2NvbCAmJiBsb2NhdGlvbi5wcm90b2NvbC5yZXBsYWNlKC9cOi8sICcnKSwKICAgICAgICBkZWZhdWx0SG9zdE5hbWUgPSBoYXNMb2NhdGlvbiAmJiBsb2NhdGlvbi5ob3N0bmFtZSwKICAgICAgICBkZWZhdWx0UG9ydCA9IGhhc0xvY2F0aW9uICYmIChsb2NhdGlvbi5wb3J0IHx8IHVuZGVmaW5lZCksCiAgICAgICAgYnVpbGRNYXAgPSBbXSwKICAgICAgICBtYXN0ZXJDb25maWcgPSAobW9kdWxlLmNvbmZpZyAmJiBtb2R1bGUuY29uZmlnKCkpIHx8IHt9LAogICAgICAgIHRleHQsIGZzOwoKICAgIHRleHQgPSB7CiAgICAgICAgdmVyc2lvbjogJzIuMC4xJywKCiAgICAgICAgc3RyaXA6IGZ1bmN0aW9uIChjb250ZW50KSB7CiAgICAgICAgICAgIC8vU3RyaXBzIDw/eG1sIC4uLj8+IGRlY2xhcmF0aW9ucyBzbyB0aGF0IGV4dGVybmFsIFNWRyBhbmQgWE1MCiAgICAgICAgICAgIC8vZG9jdW1lbnRzIGNhbiBiZSBhZGRlZCB0byBhIGRvY3VtZW50IHdpdGhvdXQgd29ycnkuIEFsc28sIGlmIHRoZSBzdHJpbmcKICAgICAgICAgICAgLy9pcyBhbiBIVE1MIGRvY3VtZW50LCBvbmx5IHRoZSBwYXJ0IGluc2lkZSB0aGUgYm9keSB0YWcgaXMgcmV0dXJuZWQuCiAgICAgICAgICAgIGlmIChjb250ZW50KSB7CiAgICAgICAgICAgICAgICBjb250ZW50ID0gY29udGVudC5yZXBsYWNlKHhtbFJlZ0V4cCwgIiIpOwogICAgICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBjb250ZW50Lm1hdGNoKGJvZHlSZWdFeHApOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoZXMpIHsKICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gbWF0Y2hlc1sxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnRlbnQgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGVudDsKICAgICAgICB9LAoKICAgICAgICBqc0VzY2FwZTogZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRlbnQucmVwbGFjZSgvKFsnXFxdKS9nLCAnXFwkMScpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1xmXS9nLCAiXFxmIikKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXGJdL2csICJcXGIiKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcbl0vZywgIlxcbiIpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1x0XS9nLCAiXFx0IikKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXHJdL2csICJcXHIiKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcdTIwMjhdL2csICJcXHUyMDI4IikKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXHUyMDI5XS9nLCAiXFx1MjAyOSIpOwogICAgICAgIH0sCgogICAgICAgIGNyZWF0ZVhocjogbWFzdGVyQ29uZmlnLmNyZWF0ZVhociB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vV291bGQgbG92ZSB0byBkdW1wIHRoZSBBY3RpdmVYIGNyYXAgaW4gaGVyZS4gTmVlZCBJRSA2IHRvIGRpZSBmaXJzdC4KICAgICAgICAgICAgdmFyIHhociwgaSwgcHJvZ0lkOwogICAgICAgICAgICBpZiAodHlwZW9mIFhNTEh0dHBSZXF1ZXN0ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBBY3RpdmVYT2JqZWN0ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDM7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgIHByb2dJZCA9IHByb2dJZHNbaV07CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgeGhyID0gbmV3IEFjdGl2ZVhPYmplY3QocHJvZ0lkKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7fQoKICAgICAgICAgICAgICAgICAgICBpZiAoeGhyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dJZHMgPSBbcHJvZ0lkXTsgIC8vIHNvIGZhc3RlciBuZXh0IHRpbWUKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4geGhyOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFBhcnNlcyBhIHJlc291cmNlIG5hbWUgaW50byBpdHMgY29tcG9uZW50IHBhcnRzLiBSZXNvdXJjZSBuYW1lcwogICAgICAgICAqIGxvb2sgbGlrZTogbW9kdWxlL25hbWUuZXh0IXN0cmlwLCB3aGVyZSB0aGUgIXN0cmlwIHBhcnQgaXMKICAgICAgICAgKiBvcHRpb25hbC4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgcmVzb3VyY2UgbmFtZQogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHdpdGggcHJvcGVydGllcyAibW9kdWxlTmFtZSIsICJleHQiIGFuZCAic3RyaXAiCiAgICAgICAgICogd2hlcmUgc3RyaXAgaXMgYSBib29sZWFuLgogICAgICAgICAqLwogICAgICAgIHBhcnNlTmFtZTogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIHN0cmlwID0gZmFsc2UsIGluZGV4ID0gbmFtZS5pbmRleE9mKCIuIiksCiAgICAgICAgICAgICAgICBtb2ROYW1lID0gbmFtZS5zdWJzdHJpbmcoMCwgaW5kZXgpLAogICAgICAgICAgICAgICAgZXh0ID0gbmFtZS5zdWJzdHJpbmcoaW5kZXggKyAxLCBuYW1lLmxlbmd0aCk7CgogICAgICAgICAgICBpbmRleCA9IGV4dC5pbmRleE9mKCIhIik7CiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIC8vUHVsbCBvZmYgdGhlIHN0cmlwIGFyZy4KICAgICAgICAgICAgICAgIHN0cmlwID0gZXh0LnN1YnN0cmluZyhpbmRleCArIDEsIGV4dC5sZW5ndGgpOwogICAgICAgICAgICAgICAgc3RyaXAgPSBzdHJpcCA9PT0gInN0cmlwIjsKICAgICAgICAgICAgICAgIGV4dCA9IGV4dC5zdWJzdHJpbmcoMCwgaW5kZXgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgbW9kdWxlTmFtZTogbW9kTmFtZSwKICAgICAgICAgICAgICAgIGV4dDogZXh0LAogICAgICAgICAgICAgICAgc3RyaXA6IHN0cmlwCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgeGRSZWdFeHA6IC9eKChcdyspXDopP1wvXC8oW15cL1xcXSspLywKCiAgICAgICAgLyoqCiAgICAgICAgICogSXMgYW4gVVJMIG9uIGFub3RoZXIgZG9tYWluLiBPbmx5IHdvcmtzIGZvciBicm93c2VyIHVzZSwgcmV0dXJucwogICAgICAgICAqIGZhbHNlIGluIG5vbi1icm93c2VyIGVudmlyb25tZW50cy4gT25seSB1c2VkIHRvIGtub3cgaWYgYW4KICAgICAgICAgKiBvcHRpbWl6ZWQgLmpzIHZlcnNpb24gb2YgYSB0ZXh0IHJlc291cmNlIHNob3VsZCBiZSBsb2FkZWQKICAgICAgICAgKiBpbnN0ZWFkLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwKICAgICAgICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgdXNlWGhyOiBmdW5jdGlvbiAodXJsLCBwcm90b2NvbCwgaG9zdG5hbWUsIHBvcnQpIHsKICAgICAgICAgICAgdmFyIG1hdGNoID0gdGV4dC54ZFJlZ0V4cC5leGVjKHVybCksCiAgICAgICAgICAgICAgICB1UHJvdG9jb2wsIHVIb3N0TmFtZSwgdVBvcnQ7CiAgICAgICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVQcm90b2NvbCA9IG1hdGNoWzJdOwogICAgICAgICAgICB1SG9zdE5hbWUgPSBtYXRjaFszXTsKCiAgICAgICAgICAgIHVIb3N0TmFtZSA9IHVIb3N0TmFtZS5zcGxpdCgnOicpOwogICAgICAgICAgICB1UG9ydCA9IHVIb3N0TmFtZVsxXTsKICAgICAgICAgICAgdUhvc3ROYW1lID0gdUhvc3ROYW1lWzBdOwoKICAgICAgICAgICAgcmV0dXJuICghdVByb3RvY29sIHx8IHVQcm90b2NvbCA9PT0gcHJvdG9jb2wpICYmCiAgICAgICAgICAgICAgICAgICAoIXVIb3N0TmFtZSB8fCB1SG9zdE5hbWUudG9Mb3dlckNhc2UoKSA9PT0gaG9zdG5hbWUudG9Mb3dlckNhc2UoKSkgJiYKICAgICAgICAgICAgICAgICAgICgoIXVQb3J0ICYmICF1SG9zdE5hbWUpIHx8IHVQb3J0ID09PSBwb3J0KTsKICAgICAgICB9LAoKICAgICAgICBmaW5pc2hMb2FkOiBmdW5jdGlvbiAobmFtZSwgc3RyaXAsIGNvbnRlbnQsIG9uTG9hZCkgewogICAgICAgICAgICBjb250ZW50ID0gc3RyaXAgPyB0ZXh0LnN0cmlwKGNvbnRlbnQpIDogY29udGVudDsKICAgICAgICAgICAgaWYgKG1hc3RlckNvbmZpZy5pc0J1aWxkKSB7CiAgICAgICAgICAgICAgICBidWlsZE1hcFtuYW1lXSA9IGNvbnRlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb25Mb2FkKGNvbnRlbnQpOwogICAgICAgIH0sCgogICAgICAgIGxvYWQ6IGZ1bmN0aW9uIChuYW1lLCByZXEsIG9uTG9hZCwgY29uZmlnKSB7CiAgICAgICAgICAgIC8vTmFtZSBoYXMgZm9ybWF0OiBzb21lLm1vZHVsZS5maWxleHQhc3RyaXAKICAgICAgICAgICAgLy9UaGUgc3RyaXAgcGFydCBpcyBvcHRpb25hbC4KICAgICAgICAgICAgLy9pZiBzdHJpcCBpcyBwcmVzZW50LCB0aGVuIHRoYXQgbWVhbnMgb25seSBnZXQgdGhlIHN0cmluZyBjb250ZW50cwogICAgICAgICAgICAvL2luc2lkZSBhIGJvZHkgdGFnIGluIGFuIEhUTUwgc3RyaW5nLiBGb3IgWE1ML1NWRyBjb250ZW50IGl0IG1lYW5zCiAgICAgICAgICAgIC8vcmVtb3ZpbmcgdGhlIDw/eG1sIC4uLj8+IGRlY2xhcmF0aW9ucyBzbyB0aGUgY29udGVudCBjYW4gYmUgaW5zZXJ0ZWQKICAgICAgICAgICAgLy9pbnRvIHRoZSBjdXJyZW50IGRvYyB3aXRob3V0IHByb2JsZW1zLgoKICAgICAgICAgICAgLy8gRG8gbm90IGJvdGhlciB3aXRoIHRoZSB3b3JrIGlmIGEgYnVpbGQgYW5kIHRleHQgd2lsbAogICAgICAgICAgICAvLyBub3QgYmUgaW5saW5lZC4KICAgICAgICAgICAgaWYgKGNvbmZpZy5pc0J1aWxkICYmICFjb25maWcuaW5saW5lVGV4dCkgewogICAgICAgICAgICAgICAgb25Mb2FkKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1hc3RlckNvbmZpZy5pc0J1aWxkID0gY29uZmlnLmlzQnVpbGQ7CgogICAgICAgICAgICB2YXIgcGFyc2VkID0gdGV4dC5wYXJzZU5hbWUobmFtZSksCiAgICAgICAgICAgICAgICBub25TdHJpcE5hbWUgPSBwYXJzZWQubW9kdWxlTmFtZSArICcuJyArIHBhcnNlZC5leHQsCiAgICAgICAgICAgICAgICB1cmwgPSByZXEudG9Vcmwobm9uU3RyaXBOYW1lKSwKICAgICAgICAgICAgICAgIHVzZVhociA9IChtYXN0ZXJDb25maWcudXNlWGhyKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgdGV4dC51c2VYaHI7CgogICAgICAgICAgICAvL0xvYWQgdGhlIHRleHQuIFVzZSBYSFIgaWYgcG9zc2libGUgYW5kIGluIGEgYnJvd3Nlci4KICAgICAgICAgICAgaWYgKCFoYXNMb2NhdGlvbiB8fCB1c2VYaHIodXJsLCBkZWZhdWx0UHJvdG9jb2wsIGRlZmF1bHRIb3N0TmFtZSwgZGVmYXVsdFBvcnQpKSB7CiAgICAgICAgICAgICAgICB0ZXh0LmdldCh1cmwsIGZ1bmN0aW9uIChjb250ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGV4dC5maW5pc2hMb2FkKG5hbWUsIHBhcnNlZC5zdHJpcCwgY29udGVudCwgb25Mb2FkKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAob25Mb2FkLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9uTG9hZC5lcnJvcihlcnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy9OZWVkIHRvIGZldGNoIHRoZSByZXNvdXJjZSBhY3Jvc3MgZG9tYWlucy4gQXNzdW1lCiAgICAgICAgICAgICAgICAvL3RoZSByZXNvdXJjZSBoYXMgYmVlbiBvcHRpbWl6ZWQgaW50byBhIEpTIG1vZHVsZS4gRmV0Y2gKICAgICAgICAgICAgICAgIC8vYnkgdGhlIG1vZHVsZSBuYW1lICsgZXh0ZW5zaW9uLCBidXQgZG8gbm90IGluY2x1ZGUgdGhlCiAgICAgICAgICAgICAgICAvLyFzdHJpcCBwYXJ0IHRvIGF2b2lkIGZpbGUgc3lzdGVtIGlzc3Vlcy4KICAgICAgICAgICAgICAgIHJlcShbbm9uU3RyaXBOYW1lXSwgZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0LmZpbmlzaExvYWQocGFyc2VkLm1vZHVsZU5hbWUgKyAnLicgKyBwYXJzZWQuZXh0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZWQuc3RyaXAsIGNvbnRlbnQsIG9uTG9hZCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHdyaXRlOiBmdW5jdGlvbiAocGx1Z2luTmFtZSwgbW9kdWxlTmFtZSwgd3JpdGUsIGNvbmZpZykgewogICAgICAgICAgICBpZiAoYnVpbGRNYXAuaGFzT3duUHJvcGVydHkobW9kdWxlTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBjb250ZW50ID0gdGV4dC5qc0VzY2FwZShidWlsZE1hcFttb2R1bGVOYW1lXSk7CiAgICAgICAgICAgICAgICB3cml0ZS5hc01vZHVsZShwbHVnaW5OYW1lICsgIiEiICsgbW9kdWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZpbmUoZnVuY3Rpb24gKCkgeyByZXR1cm4gJyIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIic7fSk7XG4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHdyaXRlRmlsZTogZnVuY3Rpb24gKHBsdWdpbk5hbWUsIG1vZHVsZU5hbWUsIHJlcSwgd3JpdGUsIGNvbmZpZykgewogICAgICAgICAgICB2YXIgcGFyc2VkID0gdGV4dC5wYXJzZU5hbWUobW9kdWxlTmFtZSksCiAgICAgICAgICAgICAgICBub25TdHJpcE5hbWUgPSBwYXJzZWQubW9kdWxlTmFtZSArICcuJyArIHBhcnNlZC5leHQsCiAgICAgICAgICAgICAgICAvL1VzZSBhICcuanMnIGZpbGUgbmFtZSBzbyB0aGF0IGl0IGluZGljYXRlcyBpdCBpcyBhCiAgICAgICAgICAgICAgICAvL3NjcmlwdCB0aGF0IGNhbiBiZSBsb2FkZWQgYWNyb3NzIGRvbWFpbnMuCiAgICAgICAgICAgICAgICBmaWxlTmFtZSA9IHJlcS50b1VybChwYXJzZWQubW9kdWxlTmFtZSArICcuJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZWQuZXh0KSArICcuanMnOwoKICAgICAgICAgICAgLy9MZXZlcmFnZSBvd24gbG9hZCgpIG1ldGhvZCB0byBsb2FkIHBsdWdpbiB2YWx1ZSwgYnV0IG9ubHkKICAgICAgICAgICAgLy93cml0ZSBvdXQgdmFsdWVzIHRoYXQgZG8gbm90IGhhdmUgdGhlIHN0cmlwIGFyZ3VtZW50LAogICAgICAgICAgICAvL3RvIGF2b2lkIGFueSBwb3RlbnRpYWwgaXNzdWVzIHdpdGggISBpbiBmaWxlIG5hbWVzLgogICAgICAgICAgICB0ZXh0LmxvYWQobm9uU3RyaXBOYW1lLCByZXEsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgLy9Vc2Ugb3duIHdyaXRlKCkgbWV0aG9kIHRvIGNvbnN0cnVjdCBmdWxsIG1vZHVsZSB2YWx1ZS4KICAgICAgICAgICAgICAgIC8vQnV0IG5lZWQgdG8gY3JlYXRlIHNoZWxsIHRoYXQgdHJhbnNsYXRlcyB3cml0ZUZpbGUncwogICAgICAgICAgICAgICAgLy93cml0ZSgpIHRvIHRoZSByaWdodCBpbnRlcmZhY2UuCiAgICAgICAgICAgICAgICB2YXIgdGV4dFdyaXRlID0gZnVuY3Rpb24gKGNvbnRlbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdyaXRlKGZpbGVOYW1lLCBjb250ZW50cyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdGV4dFdyaXRlLmFzTW9kdWxlID0gZnVuY3Rpb24gKG1vZHVsZU5hbWUsIGNvbnRlbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdyaXRlLmFzTW9kdWxlKG1vZHVsZU5hbWUsIGZpbGVOYW1lLCBjb250ZW50cyk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHRleHQud3JpdGUocGx1Z2luTmFtZSwgbm9uU3RyaXBOYW1lLCB0ZXh0V3JpdGUsIGNvbmZpZyk7CiAgICAgICAgICAgIH0sIGNvbmZpZyk7CiAgICAgICAgfQogICAgfTsKCiAgICBpZiAodHlwZW9mIHByb2Nlc3MgIT09ICJ1bmRlZmluZWQiICYmCiAgICAgICAgICAgICBwcm9jZXNzLnZlcnNpb25zICYmCiAgICAgICAgICAgICAhIXByb2Nlc3MudmVyc2lvbnMubm9kZSkgewogICAgICAgIC8vVXNpbmcgc3BlY2lhbCByZXF1aXJlLm5vZGVSZXF1aXJlLCBzb21ldGhpbmcgYWRkZWQgYnkgci5qcy4KICAgICAgICBmcyA9IHJlcXVpcmUubm9kZVJlcXVpcmUoJ2ZzJyk7CgogICAgICAgIHRleHQuZ2V0ID0gZnVuY3Rpb24gKHVybCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpbGUgPSBmcy5yZWFkRmlsZVN5bmModXJsLCAndXRmOCcpOwogICAgICAgICAgICAvL1JlbW92ZSBCT00gKEJ5dGUgTWFyayBPcmRlcikgZnJvbSB1dGY4IGZpbGVzIGlmIGl0IGlzIHRoZXJlLgogICAgICAgICAgICBpZiAoZmlsZS5pbmRleE9mKCdcdUZFRkYnKSA9PT0gMCkgewogICAgICAgICAgICAgICAgZmlsZSA9IGZpbGUuc3Vic3RyaW5nKDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrKGZpbGUpOwogICAgICAgIH07CiAgICB9IGVsc2UgaWYgKHRleHQuY3JlYXRlWGhyKCkpIHsKICAgICAgICB0ZXh0LmdldCA9IGZ1bmN0aW9uICh1cmwsIGNhbGxiYWNrLCBlcnJiYWNrKSB7CiAgICAgICAgICAgIHZhciB4aHIgPSB0ZXh0LmNyZWF0ZVhocigpOwogICAgICAgICAgICB4aHIub3BlbignR0VUJywgdXJsLCB0cnVlKTsKCiAgICAgICAgICAgIC8vQWxsb3cgb3ZlcnJpZGVzIHNwZWNpZmllZCBpbiBjb25maWcKICAgICAgICAgICAgaWYgKG1hc3RlckNvbmZpZy5vblhocikgewogICAgICAgICAgICAgICAgbWFzdGVyQ29uZmlnLm9uWGhyKHhociwgdXJsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uIChldnQpIHsKICAgICAgICAgICAgICAgIHZhciBzdGF0dXMsIGVycjsKICAgICAgICAgICAgICAgIC8vRG8gbm90IGV4cGxpY2l0bHkgaGFuZGxlIGVycm9ycywgdGhvc2Ugc2hvdWxkIGJlCiAgICAgICAgICAgICAgICAvL3Zpc2libGUgdmlhIGNvbnNvbGUgb3V0cHV0IGluIHRoZSBicm93c2VyLgogICAgICAgICAgICAgICAgaWYgKHhoci5yZWFkeVN0YXRlID09PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdHVzID0geGhyLnN0YXR1czsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHVzID4gMzk5ICYmIHN0YXR1cyA8IDYwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAvL0FuIGh0dHAgNHh4IG9yIDV4eCBlcnJvci4gU2lnbmFsIGFuIGVycm9yLgogICAgICAgICAgICAgICAgICAgICAgICBlcnIgPSBuZXcgRXJyb3IodXJsICsgJyBIVFRQIHN0YXR1czogJyArIHN0YXR1cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVyci54aHIgPSB4aHI7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycmJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHhoci5zZW5kKG51bGwpOwogICAgICAgIH07CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBQYWNrYWdlcyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAvL1doeSBKYXZhLCB3aHkgaXMgdGhpcyBzbyBhd2t3YXJkPwogICAgICAgIHRleHQuZ2V0ID0gZnVuY3Rpb24gKHVybCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGVuY29kaW5nID0gInV0Zi04IiwKICAgICAgICAgICAgICAgIGZpbGUgPSBuZXcgamF2YS5pby5GaWxlKHVybCksCiAgICAgICAgICAgICAgICBsaW5lU2VwYXJhdG9yID0gamF2YS5sYW5nLlN5c3RlbS5nZXRQcm9wZXJ0eSgibGluZS5zZXBhcmF0b3IiKSwKICAgICAgICAgICAgICAgIGlucHV0ID0gbmV3IGphdmEuaW8uQnVmZmVyZWRSZWFkZXIobmV3IGphdmEuaW8uSW5wdXRTdHJlYW1SZWFkZXIobmV3IGphdmEuaW8uRmlsZUlucHV0U3RyZWFtKGZpbGUpLCBlbmNvZGluZykpLAogICAgICAgICAgICAgICAgc3RyaW5nQnVmZmVyLCBsaW5lLAogICAgICAgICAgICAgICAgY29udGVudCA9ICcnOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc3RyaW5nQnVmZmVyID0gbmV3IGphdmEubGFuZy5TdHJpbmdCdWZmZXIoKTsKICAgICAgICAgICAgICAgIGxpbmUgPSBpbnB1dC5yZWFkTGluZSgpOwoKICAgICAgICAgICAgICAgIC8vIEJ5dGUgT3JkZXIgTWFyayAoQk9NKSAtIFRoZSBVbmljb2RlIFN0YW5kYXJkLCB2ZXJzaW9uIDMuMCwgcGFnZSAzMjQKICAgICAgICAgICAgICAgIC8vIGh0dHA6Ly93d3cudW5pY29kZS5vcmcvZmFxL3V0Zl9ib20uaHRtbAoKICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCB3aGVuIHdlIHVzZSB1dGYtOCwgdGhlIEJPTSBzaG91bGQgYXBwZWFyIGFzICJFRiBCQiBCRiIsIGJ1dCBpdCBkb2Vzbid0IGR1ZSB0byB0aGlzIGJ1ZyBpbiB0aGUgSkRLOgogICAgICAgICAgICAgICAgLy8gaHR0cDovL2J1Z3Muc3VuLmNvbS9idWdkYXRhYmFzZS92aWV3X2J1Zy5kbz9idWdfaWQ9NDUwODA1OAogICAgICAgICAgICAgICAgaWYgKGxpbmUgJiYgbGluZS5sZW5ndGgoKSAmJiBsaW5lLmNoYXJBdCgwKSA9PT0gMHhmZWZmKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRWF0IHRoZSBCT00sIHNpbmNlIHdlJ3ZlIGFscmVhZHkgZm91bmQgdGhlIGVuY29kaW5nIG9uIHRoaXMgZmlsZSwKICAgICAgICAgICAgICAgICAgICAvLyBhbmQgd2UgcGxhbiB0byBjb25jYXRlbmF0aW5nIHRoaXMgYnVmZmVyIHdpdGggb3RoZXJzOyB0aGUgQk9NIHNob3VsZAogICAgICAgICAgICAgICAgICAgIC8vIG9ubHkgYXBwZWFyIGF0IHRoZSB0b3Agb2YgYSBmaWxlLgogICAgICAgICAgICAgICAgICAgIGxpbmUgPSBsaW5lLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzdHJpbmdCdWZmZXIuYXBwZW5kKGxpbmUpOwoKICAgICAgICAgICAgICAgIHdoaWxlICgobGluZSA9IGlucHV0LnJlYWRMaW5lKCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3RyaW5nQnVmZmVyLmFwcGVuZChsaW5lU2VwYXJhdG9yKTsKICAgICAgICAgICAgICAgICAgICBzdHJpbmdCdWZmZXIuYXBwZW5kKGxpbmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy9NYWtlIHN1cmUgd2UgcmV0dXJuIGEgSmF2YVNjcmlwdCBzdHJpbmcgYW5kIG5vdCBhIEphdmEgc3RyaW5nLgogICAgICAgICAgICAgICAgY29udGVudCA9IFN0cmluZyhzdHJpbmdCdWZmZXIudG9TdHJpbmcoKSk7IC8vU3RyaW5nCiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBpbnB1dC5jbG9zZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrKGNvbnRlbnQpOwogICAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIHRleHQ7Cn0pOwoKLyoqCiAqIEBsaWNlbnNlIFJlcXVpcmVKUyBpMThuIDIuMC4xIENvcHlyaWdodCAoYykgMjAxMC0yMDEyLCBUaGUgRG9qbyBGb3VuZGF0aW9uIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqIEF2YWlsYWJsZSB2aWEgdGhlIE1JVCBvciBuZXcgQlNEIGxpY2Vuc2UuCiAqIHNlZTogaHR0cDovL2dpdGh1Yi5jb20vcmVxdWlyZWpzL2kxOG4gZm9yIGRldGFpbHMKICovCi8qanNsaW50IHJlZ2V4cDogdHJ1ZSAqLwovKmdsb2JhbCByZXF1aXJlOiBmYWxzZSwgbmF2aWdhdG9yOiBmYWxzZSwgZGVmaW5lOiBmYWxzZSAqLwoKLyoqCiAqIFRoaXMgcGx1Z2luIGhhbmRsZXMgaTE4biEgcHJlZml4ZWQgbW9kdWxlcy4gSXQgZG9lcyB0aGUgZm9sbG93aW5nOgogKgogKiAxKSBBIHJlZ3VsYXIgbW9kdWxlIGNhbiBoYXZlIGEgZGVwZW5kZW5jeSBvbiBhbiBpMThuIGJ1bmRsZSwgYnV0IHRoZSByZWd1bGFyCiAqIG1vZHVsZSBkb2VzIG5vdCB3YW50IHRvIHNwZWNpZnkgd2hhdCBsb2NhbGUgdG8gbG9hZC4gU28gaXQganVzdCBzcGVjaWZpZXMKICogdGhlIHRvcC1sZXZlbCBidW5kbGUsIGxpa2UgImkxOG4hbmxzL2NvbG9ycyIuCiAqCiAqIFRoaXMgcGx1Z2luIHdpbGwgbG9hZCB0aGUgaTE4biBidW5kbGUgYXQgbmxzL2NvbG9ycywgc2VlIHRoYXQgaXQgaXMgYSByb290L21hc3RlcgogKiBidW5kbGUgc2luY2UgaXQgZG9lcyBub3QgaGF2ZSBhIGxvY2FsZSBpbiBpdHMgbmFtZS4gSXQgd2lsbCB0aGVuIHRyeSB0byBmaW5kCiAqIHRoZSBiZXN0IG1hdGNoIGxvY2FsZSBhdmFpbGFibGUgaW4gdGhhdCBtYXN0ZXIgYnVuZGxlLCB0aGVuIHJlcXVlc3QgYWxsIHRoZQogKiBsb2NhbGUgcGllY2VzIGZvciB0aGF0IGJlc3QgbWF0Y2ggbG9jYWxlLiBGb3IgaW5zdGFuY2UsIGlmIHRoZSBsb2NhbGUgaXMgImVuLXVzIiwKICogdGhlbiB0aGUgcGx1Z2luIHdpbGwgYXNrIGZvciB0aGUgImVuLXVzIiwgImVuIiBhbmQgInJvb3QiIGJ1bmRsZXMgdG8gYmUgbG9hZGVkCiAqIChidXQgb25seSBpZiB0aGV5IGFyZSBzcGVjaWZpZWQgb24gdGhlIG1hc3RlciBidW5kbGUpLgogKgogKiBPbmNlIGFsbCB0aGUgYnVuZGxlcyBmb3IgdGhlIGxvY2FsZSBwaWVjZXMgbG9hZCwgdGhlbiBpdCBtaXhlcyBpbiBhbGwgdGhvc2UKICogbG9jYWxlIHBpZWNlcyBpbnRvIGVhY2ggb3RoZXIsIHRoZW4gZmluYWxseSBzZXRzIHRoZSBjb250ZXh0LmRlZmluZWQgdmFsdWUKICogZm9yIHRoZSBubHMvY29sb3JzIGJ1bmRsZSB0byBiZSB0aGF0IG1peGVkIGluIGxvY2FsZS4KICoKICogMikgQSByZWd1bGFyIG1vZHVsZSBzcGVjaWZpZXMgYSBzcGVjaWZpYyBsb2NhbGUgdG8gbG9hZC4gRm9yIGluc3RhbmNlLAogKiBpMThuIW5scy9mci1mci9jb2xvcnMuIEluIHRoaXMgY2FzZSwgdGhlIHBsdWdpbiBuZWVkcyB0byBsb2FkIHRoZSBtYXN0ZXIgYnVuZGxlCiAqIGZpcnN0LCBhdCBubHMvY29sb3JzLCB0aGVuIGZpZ3VyZSBvdXQgd2hhdCB0aGUgYmVzdCBtYXRjaCBsb2NhbGUgaXMgZm9yIGZyLWZyLAogKiBzaW5jZSBtYXliZSBvbmx5IGZyIG9yIGp1c3Qgcm9vdCBpcyBkZWZpbmVkIGZvciB0aGF0IGxvY2FsZS4gT25jZSB0aGF0IGJlc3QKICogZml0IGlzIGZvdW5kLCBhbGwgb2YgaXRzIGxvY2FsZSBwaWVjZXMgbmVlZCB0byBoYXZlIHRoZWlyIGJ1bmRsZXMgbG9hZGVkLgogKgogKiBPbmNlIGFsbCB0aGUgYnVuZGxlcyBmb3IgdGhlIGxvY2FsZSBwaWVjZXMgbG9hZCwgdGhlbiBpdCBtaXhlcyBpbiBhbGwgdGhvc2UKICogbG9jYWxlIHBpZWNlcyBpbnRvIGVhY2ggb3RoZXIsIHRoZW4gZmluYWxseSBzZXRzIHRoZSBjb250ZXh0LmRlZmluZWQgdmFsdWUKICogZm9yIHRoZSBubHMvZnItZnIvY29sb3JzIGJ1bmRsZSB0byBiZSB0aGF0IG1peGVkIGluIGxvY2FsZS4KICovCihmdW5jdGlvbiAoKSB7CiAgICAKCiAgICAvL3JlZ2V4cCBmb3IgcmVjb25zdHJ1Y3RpbmcgdGhlIG1hc3RlciBidW5kbGUgbmFtZSBmcm9tIHBhcnRzIG9mIHRoZSByZWdleHAgbWF0Y2gKICAgIC8vbmxzUmVnRXhwLmV4ZWMoImZvby9iYXIvYmF6L25scy9lbi1jYS9mb28iKSBnaXZlczoKICAgIC8vWyJmb28vYmFyL2Jhei9ubHMvZW4tY2EvZm9vIiwgImZvby9iYXIvYmF6L25scy8iLCAiLyIsICIvIiwgImVuLWNhIiwgImZvbyJdCiAgICAvL25sc1JlZ0V4cC5leGVjKCJmb28vYmFyL2Jhei9ubHMvZm9vIikgZ2l2ZXM6CiAgICAvL1siZm9vL2Jhci9iYXovbmxzL2ZvbyIsICJmb28vYmFyL2Jhei9ubHMvIiwgIi8iLCAiLyIsICJmb28iLCAiIl0KICAgIC8vc28sIGlmIG1hdGNoWzVdIGlzIGJsYW5rLCBpdCBtZWFucyB0aGlzIGlzIHRoZSB0b3AgYnVuZGxlIGRlZmluaXRpb24uCiAgICB2YXIgbmxzUmVnRXhwID0gLyheLiooXnxcLylubHMoXC98JCkpKFteXC9dKilcLz8oW15cL10qKS87CgogICAgLy9IZWxwZXIgZnVuY3Rpb24gdG8gYXZvaWQgcmVwZWF0aW5nIGNvZGUuIExvdHMgb2YgYXJndW1lbnRzIGluIHRoZQogICAgLy9kZXNpcmUgdG8gc3RheSBmdW5jdGlvbmFsIGFuZCBzdXBwb3J0IFJlcXVpcmVKUyBjb250ZXh0cyB3aXRob3V0IGhhdmluZwogICAgLy90byBrbm93IGFib3V0IHRoZSBSZXF1aXJlSlMgY29udGV4dHMuCiAgICBmdW5jdGlvbiBhZGRQYXJ0KGxvY2FsZSwgbWFzdGVyLCBuZWVkZWQsIHRvTG9hZCwgcHJlZml4LCBzdWZmaXgpIHsKICAgICAgICBpZiAobWFzdGVyW2xvY2FsZV0pIHsKICAgICAgICAgICAgbmVlZGVkLnB1c2gobG9jYWxlKTsKICAgICAgICAgICAgaWYgKG1hc3Rlcltsb2NhbGVdID09PSB0cnVlIHx8IG1hc3Rlcltsb2NhbGVdID09PSAxKSB7CiAgICAgICAgICAgICAgICB0b0xvYWQucHVzaChwcmVmaXggKyBsb2NhbGUgKyAnLycgKyBzdWZmaXgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGFkZElmRXhpc3RzKHJlcSwgbG9jYWxlLCB0b0xvYWQsIHByZWZpeCwgc3VmZml4KSB7CiAgICAgICAgdmFyIGZ1bGxOYW1lID0gcHJlZml4ICsgbG9jYWxlICsgJy8nICsgc3VmZml4OwogICAgICAgIGlmIChyZXF1aXJlLl9maWxlRXhpc3RzKHJlcS50b1VybChmdWxsTmFtZSkpKSB7CiAgICAgICAgICAgIHRvTG9hZC5wdXNoKGZ1bGxOYW1lKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTaW1wbGUgZnVuY3Rpb24gdG8gbWl4IGluIHByb3BlcnRpZXMgZnJvbSBzb3VyY2UgaW50byB0YXJnZXQsCiAgICAgKiBidXQgb25seSBpZiB0YXJnZXQgZG9lcyBub3QgYWxyZWFkeSBoYXZlIGEgcHJvcGVydHkgb2YgdGhlIHNhbWUgbmFtZS4KICAgICAqIFRoaXMgaXMgbm90IHJvYnVzdCBpbiBJRSBmb3IgdHJhbnNmZXJyaW5nIG1ldGhvZHMgdGhhdCBtYXRjaAogICAgICogT2JqZWN0LnByb3RvdHlwZSBuYW1lcywgYnV0IHRoZSB1c2VzIG9mIG1peGluIGhlcmUgc2VlbSB1bmxpa2VseSB0bwogICAgICogdHJpZ2dlciBhIHByb2JsZW0gcmVsYXRlZCB0byB0aGF0LgogICAgICovCiAgICBmdW5jdGlvbiBtaXhpbih0YXJnZXQsIHNvdXJjZSwgZm9yY2UpIHsKICAgICAgICB2YXIgcHJvcDsKICAgICAgICBmb3IgKHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICAgIGlmIChzb3VyY2UuaGFzT3duUHJvcGVydHkocHJvcCkgJiYgKCF0YXJnZXQuaGFzT3duUHJvcGVydHkocHJvcCkgfHwgZm9yY2UpKSB7CiAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNvdXJjZVtwcm9wXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIG1peGluKHRhcmdldFtwcm9wXSwgc291cmNlW3Byb3BdLCBmb3JjZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZGVmaW5lKCdpMThuJyxbJ21vZHVsZSddLCBmdW5jdGlvbiAobW9kdWxlKSB7CiAgICAgICAgdmFyIG1hc3RlckNvbmZpZyA9IG1vZHVsZS5jb25maWcoKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmVyc2lvbjogJzIuMC4xJywKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENhbGxlZCB3aGVuIGEgZGVwZW5kZW5jeSBuZWVkcyB0byBiZSBsb2FkZWQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBsb2FkOiBmdW5jdGlvbiAobmFtZSwgcmVxLCBvbkxvYWQsIGNvbmZpZykgewogICAgICAgICAgICAgICAgY29uZmlnID0gY29uZmlnIHx8IHt9OwoKICAgICAgICAgICAgICAgIGlmIChjb25maWcubG9jYWxlKSB7CiAgICAgICAgICAgICAgICAgICAgbWFzdGVyQ29uZmlnLmxvY2FsZSA9IGNvbmZpZy5sb2NhbGU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIG1hc3Rlck5hbWUsCiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBubHNSZWdFeHAuZXhlYyhuYW1lKSwKICAgICAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaFsxXSwKICAgICAgICAgICAgICAgICAgICBsb2NhbGUgPSBtYXRjaFs0XSwKICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSBtYXRjaFs1XSwKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxvY2FsZS5zcGxpdCgiLSIpLAogICAgICAgICAgICAgICAgICAgIHRvTG9hZCA9IFtdLAogICAgICAgICAgICAgICAgICAgIHZhbHVlID0ge30sCiAgICAgICAgICAgICAgICAgICAgaSwgcGFydCwgY3VycmVudCA9ICIiOwoKICAgICAgICAgICAgICAgIC8vSWYgbWF0Y2hbNV0gaXMgYmxhbmssIGl0IG1lYW5zIHRoaXMgaXMgdGhlIHRvcCBidW5kbGUgZGVmaW5pdGlvbiwKICAgICAgICAgICAgICAgIC8vc28gaXQgZG9lcyBub3QgaGF2ZSB0byBiZSBoYW5kbGVkLiBMb2NhbGUtc3BlY2lmaWMgcmVxdWVzdHMKICAgICAgICAgICAgICAgIC8vd2lsbCBoYXZlIGEgbWF0Y2hbNF0gdmFsdWUgYnV0IG5vIG1hdGNoWzVdCiAgICAgICAgICAgICAgICBpZiAobWF0Y2hbNV0pIHsKICAgICAgICAgICAgICAgICAgICAvL2xvY2FsZS1zcGVjaWZpYyBidW5kbGUKICAgICAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaFsxXTsKICAgICAgICAgICAgICAgICAgICBtYXN0ZXJOYW1lID0gcHJlZml4ICsgc3VmZml4OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvL1RvcC1sZXZlbCBidW5kbGUuCiAgICAgICAgICAgICAgICAgICAgbWFzdGVyTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgc3VmZml4ID0gbWF0Y2hbNF07CiAgICAgICAgICAgICAgICAgICAgbG9jYWxlID0gbWFzdGVyQ29uZmlnLmxvY2FsZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWxvY2FsZSkgewogICAgICAgICAgICAgICAgICAgICAgICBsb2NhbGUgPSBtYXN0ZXJDb25maWcubG9jYWxlID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBuYXZpZ2F0b3IgPT09ICJ1bmRlZmluZWQiID8gInJvb3QiIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChuYXZpZ2F0b3IubGFuZ3VhZ2UgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYXZpZ2F0b3IudXNlckxhbmd1YWdlIHx8ICJyb290IikudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsb2NhbGUuc3BsaXQoIi0iKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmlzQnVpbGQpIHsKICAgICAgICAgICAgICAgICAgICAvL0NoZWNrIGZvciBleGlzdGVuY2Ugb2YgYWxsIGxvY2FsZSBwb3NzaWJsZSBmaWxlcyBhbmQKICAgICAgICAgICAgICAgICAgICAvL3JlcXVpcmUgdGhlbSBpZiBleGlzdC4KICAgICAgICAgICAgICAgICAgICB0b0xvYWQucHVzaChtYXN0ZXJOYW1lKTsKICAgICAgICAgICAgICAgICAgICBhZGRJZkV4aXN0cyhyZXEsICJyb290IiwgdG9Mb2FkLCBwcmVmaXgsIHN1ZmZpeCk7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSBwYXJ0c1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAoY3VycmVudCA/ICItIiA6ICIiKSArIHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZElmRXhpc3RzKHJlcSwgY3VycmVudCwgdG9Mb2FkLCBwcmVmaXgsIHN1ZmZpeCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXEodG9Mb2FkLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9uTG9hZCgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvL0ZpcnN0LCBmZXRjaCB0aGUgbWFzdGVyIGJ1bmRsZSwgaXQga25vd3Mgd2hhdCBsb2NhbGVzIGFyZSBhdmFpbGFibGUuCiAgICAgICAgICAgICAgICAgICAgcmVxKFttYXN0ZXJOYW1lXSwgZnVuY3Rpb24gKG1hc3RlcikgewogICAgICAgICAgICAgICAgICAgICAgICAvL0ZpZ3VyZSBvdXQgdGhlIGJlc3QgZml0CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZWVkZWQgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQ7CgogICAgICAgICAgICAgICAgICAgICAgICAvL0Fsd2F5cyBhbGxvdyBmb3Igcm9vdCwgdGhlbiBkbyB0aGUgcmVzdCBvZiB0aGUgbG9jYWxlIHBhcnRzLgogICAgICAgICAgICAgICAgICAgICAgICBhZGRQYXJ0KCJyb290IiwgbWFzdGVyLCBuZWVkZWQsIHRvTG9hZCwgcHJlZml4LCBzdWZmaXgpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSBwYXJ0c1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgKz0gKGN1cnJlbnQgPyAiLSIgOiAiIikgKyBwYXJ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkUGFydChjdXJyZW50LCBtYXN0ZXIsIG5lZWRlZCwgdG9Mb2FkLCBwcmVmaXgsIHN1ZmZpeCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vTG9hZCBhbGwgdGhlIHBhcnRzIG1pc3NpbmcuCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcSh0b0xvYWQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpLCBwYXJ0QnVuZGxlLCBwYXJ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gbmVlZGVkLmxlbmd0aCAtIDE7IGkgPiAtMSAmJiBuZWVkZWRbaV07IGktLSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSBuZWVkZWRbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydEJ1bmRsZSA9IG1hc3RlcltwYXJ0XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFydEJ1bmRsZSA9PT0gdHJ1ZSB8fCBwYXJ0QnVuZGxlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRCdW5kbGUgPSByZXEocHJlZml4ICsgcGFydCArICcvJyArIHN1ZmZpeCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1peGluKHZhbHVlLCBwYXJ0QnVuZGxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL0FsbCBkb25lLCBub3RpZnkgdGhlIGxvYWRlci4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTG9hZCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0pOwp9KCkpOwoKLy8gZG9ULmpzCi8vIDIwMTEsIExhdXJhIERva3Rvcm92YSwgaHR0cHM6Ly9naXRodWIuY29tL29sYWRvL2RvVAovLwovLyBkb1QuanMgaXMgYW4gb3BlbiBzb3VyY2UgY29tcG9uZW50IG9mIGh0dHA6Ly9iZWJlZG8uY29tCi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KLy8KKGZ1bmN0aW9uKCkgewoJCgoJdmFyIGRvVCA9IHsKCQl2ZXJzaW9uOiAnMC4yLjAnLAoJCXRlbXBsYXRlU2V0dGluZ3M6IHsKCQkJZXZhbHVhdGU6ICAgIC9ce1x7KFtcc1xTXSs/KVx9XH0vZywKCQkJaW50ZXJwb2xhdGU6IC9ce1x7PShbXHNcU10rPylcfVx9L2csCgkJCWVuY29kZTogICAgICAvXHtceyEoW1xzXFNdKz8pXH1cfS9nLAoJCQl1c2U6ICAgICAgICAgL1x7XHsjKFtcc1xTXSs/KVx9XH0vZywKCQkJZGVmaW5lOiAgICAgIC9ce1x7IyNccyooW1x3XC4kXSspXHMqKFw6fD0pKFtcc1xTXSs/KSNcfVx9L2csCgkJCWNvbmRpdGlvbmFsOiAvXHtce1w/KFw/KT9ccyooW1xzXFNdKj8pXHMqXH1cfS9nLAoJCQlpdGVyYXRlOiAgICAgL1x7XHt+XHMqKD86XH1cfXwoW1xzXFNdKz8pXHMqXDpccyooW1x3JF0rKVxzKig/Olw6XHMqKFtcdyRdKykpP1xzKlx9XH0pL2csCgkJCXZhcm5hbWU6ICdpdCcsCgkJCXN0cmlwOiB0cnVlLAoJCQlhcHBlbmQ6IHRydWUsCgkJCXNlbGZjb250YWluZWQ6IGZhbHNlCgkJfSwKCQl0ZW1wbGF0ZTogdW5kZWZpbmVkLCAvL2ZuLCBjb21waWxlIHRlbXBsYXRlCgkJY29tcGlsZTogIHVuZGVmaW5lZCAgLy9mbiwgZm9yIGV4cHJlc3MKCX07CgoJdmFyIGdsb2JhbCA9IChmdW5jdGlvbigpeyByZXR1cm4gdGhpcyB8fCAoMCxldmFsKSgndGhpcycpOyB9KCkpOwoKCWlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewoJCW1vZHVsZS5leHBvcnRzID0gZG9UOwoJfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKCQlkZWZpbmUoJ2RvVCcsW10sZnVuY3Rpb24oKXtyZXR1cm4gZG9UO30pOwoJfSBlbHNlIHsKCQlnbG9iYWwuZG9UID0gZG9UOwoJfQoKCWZ1bmN0aW9uIGVuY29kZUhUTUxTb3VyY2UoKSB7CgkJdmFyIGVuY29kZUhUTUxSdWxlcyA9IHsgIiYiOiAiJiMzODsiLCAiPCI6ICImIzYwOyIsICI+IjogIiYjNjI7IiwgJyInOiAnJiMzNDsnLCAiJyI6ICcmIzM5OycsICIvIjogJyYjNDc7JyB9LAoJCQltYXRjaEhUTUwgPSAvJig/ISM/XHcrOyl8PHw+fCJ8J3xcLy9nOwoJCXJldHVybiBmdW5jdGlvbihjb2RlKSB7CgkJCXJldHVybiBjb2RlID8gY29kZS50b1N0cmluZygpLnJlcGxhY2UobWF0Y2hIVE1MLCBmdW5jdGlvbihtKSB7cmV0dXJuIGVuY29kZUhUTUxSdWxlc1ttXSB8fCBtO30pIDogY29kZTsKCQl9OwoJfQoJZ2xvYmFsLmVuY29kZUhUTUwgPSBlbmNvZGVIVE1MU291cmNlKCk7CgoJdmFyIHN0YXJ0ZW5kID0gewoJCWFwcGVuZDogeyBzdGFydDogIicrKCIsICAgICAgZW5kOiAiKSsnIiwgICAgICBzdGFydGVuY29kZTogIicrZW5jb2RlSFRNTCgiIH0sCgkJc3BsaXQ6ICB7IHN0YXJ0OiAiJztvdXQrPSgiLCBlbmQ6ICIpO291dCs9JyIsIHN0YXJ0ZW5jb2RlOiAiJztvdXQrPWVuY29kZUhUTUwoIn0KCX0sIHNraXAgPSAvJF4vOwoKCWZ1bmN0aW9uIHJlc29sdmVEZWZzKGMsIGJsb2NrLCBkZWYpIHsKCQlyZXR1cm4gKCh0eXBlb2YgYmxvY2sgPT09ICdzdHJpbmcnKSA/IGJsb2NrIDogYmxvY2sudG9TdHJpbmcoKSkKCQkucmVwbGFjZShjLmRlZmluZSB8fCBza2lwLCBmdW5jdGlvbihtLCBjb2RlLCBhc3NpZ24sIHZhbHVlKSB7CgkJCWlmIChjb2RlLmluZGV4T2YoJ2RlZi4nKSA9PT0gMCkgewoJCQkJY29kZSA9IGNvZGUuc3Vic3RyaW5nKDQpOwoJCQl9CgkJCWlmICghKGNvZGUgaW4gZGVmKSkgewoJCQkJaWYgKGFzc2lnbiA9PT0gJzonKSB7CgkJCQkJZGVmW2NvZGVdPSB2YWx1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJZXZhbCgiZGVmWyciK2NvZGUrIiddPSIgKyB2YWx1ZSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuICcnOwoJCX0pCgkJLnJlcGxhY2UoYy51c2UgfHwgc2tpcCwgZnVuY3Rpb24obSwgY29kZSkgewoJCQl2YXIgdiA9IGV2YWwoY29kZSk7CgkJCXJldHVybiB2ID8gcmVzb2x2ZURlZnMoYywgdiwgZGVmKSA6IHY7CgkJfSk7Cgl9CgoJZnVuY3Rpb24gdW5lc2NhcGUoY29kZSkgewoJCXJldHVybiBjb2RlLnJlcGxhY2UoL1xcKCd8XFwpL2csICIkMSIpLnJlcGxhY2UoL1tcclx0XG5dL2csICcgJyk7Cgl9CgoJZG9ULnRlbXBsYXRlID0gZnVuY3Rpb24odG1wbCwgYywgZGVmKSB7CgkJYyA9IGMgfHwgZG9ULnRlbXBsYXRlU2V0dGluZ3M7CgkJdmFyIGNzZSA9IGMuYXBwZW5kID8gc3RhcnRlbmQuYXBwZW5kIDogc3RhcnRlbmQuc3BsaXQsIHN0ciwgbmVlZGh0bWxlbmNvZGUsIHNpZD0wLCBpbmR2OwoKCQlpZiAoYy51c2UgfHwgYy5kZWZpbmUpIHsKCQkJdmFyIG9sZGRlZiA9IGdsb2JhbC5kZWY7IGdsb2JhbC5kZWYgPSBkZWYgfHwge307IC8vIHdvcmthcm91bmQgbWluaWZpZXJzCgkJCXN0ciA9IHJlc29sdmVEZWZzKGMsIHRtcGwsIGdsb2JhbC5kZWYpOwoJCQlnbG9iYWwuZGVmID0gb2xkZGVmOwoJCX0gZWxzZSBzdHIgPSB0bXBsOwoKCQlzdHIgPSAoInZhciBvdXQ9JyIgKyAoYy5zdHJpcCA/IHN0ci5yZXBsYWNlKC8oXnxccnxcbilcdCogK3wgK1x0KihccnxcbnwkKS9nLCcgJykKCQkJCQkucmVwbGFjZSgvXHJ8XG58XHR8XC9cKltcc1xTXSo/XCpcLy9nLCcnKTogc3RyKQoJCQkucmVwbGFjZSgvJ3xcXC9nLCAnXFwkJicpCgkJCS5yZXBsYWNlKGMuaW50ZXJwb2xhdGUgfHwgc2tpcCwgZnVuY3Rpb24obSwgY29kZSkgewoJCQkJcmV0dXJuIGNzZS5zdGFydCArIHVuZXNjYXBlKGNvZGUpICsgY3NlLmVuZDsKCQkJfSkKCQkJLnJlcGxhY2UoYy5lbmNvZGUgfHwgc2tpcCwgZnVuY3Rpb24obSwgY29kZSkgewoJCQkJbmVlZGh0bWxlbmNvZGUgPSB0cnVlOwoJCQkJcmV0dXJuIGNzZS5zdGFydGVuY29kZSArIHVuZXNjYXBlKGNvZGUpICsgY3NlLmVuZDsKCQkJfSkKCQkJLnJlcGxhY2UoYy5jb25kaXRpb25hbCB8fCBza2lwLCBmdW5jdGlvbihtLCBlbHNlY2FzZSwgY29kZSkgewoJCQkJcmV0dXJuIGVsc2VjYXNlID8KCQkJCQkoY29kZSA/ICInO31lbHNlIGlmKCIgKyB1bmVzY2FwZShjb2RlKSArICIpe291dCs9JyIgOiAiJzt9ZWxzZXtvdXQrPSciKSA6CgkJCQkJKGNvZGUgPyAiJztpZigiICsgdW5lc2NhcGUoY29kZSkgKyAiKXtvdXQrPSciIDogIic7fW91dCs9JyIpOwoJCQl9KQoJCQkucmVwbGFjZShjLml0ZXJhdGUgfHwgc2tpcCwgZnVuY3Rpb24obSwgaXRlcmF0ZSwgdm5hbWUsIGluYW1lKSB7CgkJCQlpZiAoIWl0ZXJhdGUpIHJldHVybiAiJzt9IH0gb3V0Kz0nIjsKCQkJCXNpZCs9MTsgaW5kdj1pbmFtZSB8fCAiaSIrc2lkOyBpdGVyYXRlPXVuZXNjYXBlKGl0ZXJhdGUpOwoJCQkJcmV0dXJuICInO3ZhciBhcnIiK3NpZCsiPSIraXRlcmF0ZSsiO2lmKGFyciIrc2lkKyIpe3ZhciAiK3ZuYW1lKyIsIitpbmR2KyI9LTEsbCIrc2lkKyI9YXJyIitzaWQrIi5sZW5ndGgtMTt3aGlsZSgiK2luZHYrIjxsIitzaWQrIil7IgoJCQkJCSt2bmFtZSsiPWFyciIrc2lkKyJbIitpbmR2KyIrPTFdO291dCs9JyI7CgkJCX0pCgkJCS5yZXBsYWNlKGMuZXZhbHVhdGUgfHwgc2tpcCwgZnVuY3Rpb24obSwgY29kZSkgewoJCQkJcmV0dXJuICInOyIgKyB1bmVzY2FwZShjb2RlKSArICJvdXQrPSciOwoJCQl9KQoJCQkrICInO3JldHVybiBvdXQ7IikKCQkJLnJlcGxhY2UoL1xuL2csICdcXG4nKS5yZXBsYWNlKC9cdC9nLCAnXFx0JykucmVwbGFjZSgvXHIvZywgJ1xccicpCgkJCS5yZXBsYWNlKC8oXHN8O3x9fF58eylvdXRcKz0nJzsvZywgJyQxJykucmVwbGFjZSgvXCsnJy9nLCAnJykKCQkJLnJlcGxhY2UoLyhcc3w7fH18Xnx7KW91dFwrPScnXCsvZywnJDFvdXQrPScpOwoKCQlpZiAobmVlZGh0bWxlbmNvZGUgJiYgYy5zZWxmY29udGFpbmVkKSB7CgkJCXN0ciA9ICJ2YXIgZW5jb2RlSFRNTD0oIiArIGVuY29kZUhUTUxTb3VyY2UudG9TdHJpbmcoKSArICIoKSk7IiArIHN0cjsKCQl9CgkJdHJ5IHsKCQkJcmV0dXJuIG5ldyBGdW5jdGlvbihjLnZhcm5hbWUsIHN0cik7CgkJfSBjYXRjaCAoZSkgewoJCQlpZiAodHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnKSBjb25zb2xlLmxvZygiQ291bGQgbm90IGNyZWF0ZSBhIHRlbXBsYXRlIGZ1bmN0aW9uOiAiICsgc3RyKTsKCQkJdGhyb3cgZTsKCQl9Cgl9OwoKCWRvVC5jb21waWxlID0gZnVuY3Rpb24odG1wbCwgZGVmKSB7CgkJcmV0dXJuIGRvVC50ZW1wbGF0ZSh0bXBsLCBudWxsLCBkZWYpOwoJfTsKfSgpKTsKCi8qIQogKiBEYXZpcyAtIGh0dHA6Ly9kYXZpc2pzLmNvbSAtIEphdmFTY3JpcHQgUm91dGluZyAtIDAuOS4yCiAqIENvcHlyaWdodCAoQykgMjAxMSBPbGl2ZXIgTmlnaHRpbmdhbGUKICogTUlUIExpY2Vuc2VkCiAqLwo7Ci8qKgogKiBDb252aW5pZW5jZSBtZXRob2QgZm9yIGluc3RhbnRpYXRpbmcgYSBuZXcgRGF2aXMgYXBwIGFuZCBjb25maWd1cmluZyBpdCB0byB1c2UgdGhlIHBhc3NlZAogKiByb3V0ZXMgYW5kIHN1YnNjcmlwdGlvbnMuCiAqCiAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZyBBIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBydW4gd2l0aCBhIG5ld2x5IGNyZWF0ZWQgRGF2aXMuQXBwIGFzIGl0cyBjb250ZXh0LAogKiBzaG91bGQgYmUgdXNlZCB0byBzZXQgdXAgYXBwIHJvdXRlcywgc3Vic2NyaXB0aW9ucyBhbmQgc2V0dGluZ3MgZXRjLgogKiBAbmFtZXNwYWNlCiAqIEByZXR1cm5zIHtEYXZpcy5BcHB9CiAqLwpEYXZpcyA9IGZ1bmN0aW9uIChjb25maWcpIHsKICB2YXIgYXBwID0gbmV3IERhdmlzLkFwcAogIGNvbmZpZyAmJiBjb25maWcuY2FsbChhcHApCiAgRGF2aXMuJChmdW5jdGlvbiAoKSB7IGFwcC5zdGFydCgpIH0pCiAgcmV0dXJuIGFwcAp9OwoKLyoqCiAqIFN0b3JlcyB0aGUgRE9NIGxpYnJhcnkgdGhhdCBEYXZpcyB3aWxsIHVzZS4gIENhbiBiZSBvdmVycmlkZW4gdG8gdXNlIGxpYnJhcmllcyBvdGhlciB0aGFuIGpRdWVyeS4KICovCmlmICh3aW5kb3cualF1ZXJ5KSB7CiAgRGF2aXMuJCA9IGpRdWVyeQp9IGVsc2UgewogIERhdmlzLiQgPSBudWxsCn07CgovKioKICogQ2hlY2tzIHdoZXRoZXIgRGF2aXMgaXMgc3VwcG9ydGVkIGluIHRoZSBjdXJyZW50IGJyb3dzZXIKICoKICogQHJldHVybnMge0Jvb2xlYW59CiAqLwpEYXZpcy5zdXBwb3J0ZWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuICh0eXBlb2Ygd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlID09ICdmdW5jdGlvbicpCn0KCi8qIQogKiBBIGZ1bmN0aW9uIHRoYXQgZG9lcyBub3RoaW5nLCB1c2VkIGFzIGEgZGVmYXVsdCBwYXJhbSBmb3IgYW55IGNhbGxiYWNrcy4KICogCiAqIEBwcml2YXRlCiAqIEByZXR1cm5zIHtGdW5jdGlvbn0KICovCkRhdmlzLm5vb3AgPSBmdW5jdGlvbiAoKSB7fQoKLyoqCiAqIE1ldGhvZCB0byBleHRlbmQgdGhlIERhdmlzIGxpYnJhcnkgd2l0aCBhbiBleHRlbnNpb24uCiAqCiAqIEFuIGV4dGVuc2lvbiBpcyBqdXN0IGEgZnVuY3Rpb24gdGhhdCB3aWxsIG1vZGlmeSB0aGUgRGF2aXMgZnJhbWV3b3JrIGluIHNvbWUgd2F5LAogKiBmb3IgZXhhbXBsZSBjaGFuZ2luZyBob3cgdGhlIHJvdXRpbmcgd29ya3Mgb3IgYWRqdXN0aW5nIHdoZXJlIERhdmlzIHRoaW5rcyBpdCBpcyBzdXBwb3J0ZWQuCiAqCiAqIEV4YW1wbGU6CiAqICAgICBEYXZpcy5leHRlbmQoRGF2aXMuaGFzaEJhc2VkUm91dGluZykKICoKICogQHBhcmFtIHtGdW5jdGlvbn0gZXh0ZW5zaW9uIHRoZSBmdW5jdGlvbiB0aGF0IHdpbGwgZXh0ZW5kIERhdmlzCiAqCiAqLwpEYXZpcy5leHRlbmQgPSBmdW5jdGlvbiAoZXh0ZW5zaW9uKSB7CiAgZXh0ZW5zaW9uKERhdmlzKQp9CgovKiEKICogdGhlIHZlcnNpb24KICovCkRhdmlzLnZlcnNpb24gPSAiMC45LjIiOy8qIQogKiBEYXZpcyAtIHV0aWxzCiAqIENvcHlyaWdodCAoQykgMjAxMSBPbGl2ZXIgTmlnaHRpbmdhbGUKICogTUlUIExpY2Vuc2VkCiAqLwoKLyohCiAqIEEgbW9kdWxlIHRoYXQgcHJvdmlkZXMgd3JhcHBlcnMgYXJvdW5kIG1vZGVybiBKYXZhU2NyaXB0IHNvIHRoYXQgbmF0aXZlIGltcGxlbWVudGF0aW9ucyBhcmUgdXNlZAogKiB3aGVyZWV2ZXIgcG9zc2libGUgYW5kIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb25zIGFyZSB1c2VkIGluIHRob3NlIGJyb3dzZXJzIHRoYXQgZG8gbm90IG5hdGl2ZWx5CiAqIHN1cHBvcnQgdGhlbS4KICovCkRhdmlzLnV0aWxzID0gKGZ1bmN0aW9uICgpIHsKCiAgLyohCiAgICogQSB3cmFwcGVyIGFyb3VuZCBuYXRpdmUgQXJyYXkucHJvdG90eXBlLmV2ZXJ5LgogICAqCiAgICogRmFsbHMgYmFjayB0byBhIHB1cmUgSmF2YVNjcmlwdCBpbXBsZW1lbnRhdGlvbiBpbiBicm93c2VycyB0aGF0IGRvIG5vdCBzdXBwb3J0IEFycmF5LnByb3RvdHlwZS5ldmVyeS4KICAgKiBGb3IgbW9yZSBkZXRhaWxzIHNlZSB0aGUgZnVsbCBkb2NzIG9uIE1EQyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9BcnJheS9ldmVyeQogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge2FycmF5fSB0aGUgYXJyYXkgdG8gbG9vcCB0aHJvdWdoCiAgICogQHBhcmFtIHtmbn0gdGhlIGZ1bmN0aW9uIHRvIHRoYXQgcGVyZm9ybXMgdGhlIGV2ZXJ5IGNoZWNrCiAgICogQHBhcmFtIHt0aGlzcH0gYW4gb3B0aW9uYWwgcGFyYW0gdGhhdCB3aWxsIGJlIHNldCBhcyBmbidzIHRoaXMgdmFsdWUKICAgKiBAcmV0dXJucyB7QXJyYXl9CiAgICovCiAgaWYgKEFycmF5LnByb3RvdHlwZS5ldmVyeSkgewogICAgdmFyIGV2ZXJ5ID0gZnVuY3Rpb24gKGFycmF5LCBmbikgewogICAgICByZXR1cm4gYXJyYXkuZXZlcnkoZm4sIGFyZ3VtZW50c1syXSkKICAgIH0KICB9IGVsc2UgewogICAgdmFyIGV2ZXJ5ID0gZnVuY3Rpb24gKGFycmF5LCBmbikgewogICAgICBpZiAoYXJyYXkgPT09IHZvaWQgMCB8fCBhcnJheSA9PT0gbnVsbCkgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwogICAgICB2YXIgdCA9IE9iamVjdChhcnJheSk7CiAgICAgIHZhciBsZW4gPSB0Lmxlbmd0aCA+Pj4gMDsKICAgICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwoKICAgICAgdmFyIHRoaXNwID0gYXJndW1lbnRzWzJdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKGkgaW4gdCAmJiAhZm4uY2FsbCh0aGlzcCwgdFtpXSwgaSwgdCkpIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgLyohCiAgICogQSB3cmFwcGVyIGFyb3VuZCBuYXRpdmUgQXJyYXkucHJvdG90eXBlLmZvckVhY2guCiAgICoKICAgKiBGYWxscyBiYWNrIHRvIGEgcHVyZSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIGluIGJyb3dzZXJzIHRoYXQgZG8gbm90IHN1cHBvcnQgQXJyYXkucHJvdG90eXBlLmZvckVhY2guCiAgICogRm9yIG1vcmUgZGV0YWlscyBzZWUgdGhlIGZ1bGwgZG9jcyBvbiBNREMgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvZm9yRWFjaAogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge2FycmF5fSB0aGUgYXJyYXkgdG8gbG9vcCB0aHJvdWdoCiAgICogQHBhcmFtIHtmbn0gdGhlIGZ1bmN0aW9uIHRvIGFwcGx5IHRvIGV2ZXJ5IGVsZW1lbnQgb2YgdGhlIGFycmF5CiAgICogQHBhcmFtIHt0aGlzcH0gYW4gb3B0aW9uYWwgcGFyYW0gdGhhdCB3aWxsIGJlIHNldCBhcyBmbidzIHRoaXMgdmFsdWUKICAgKiBAcmV0dXJucyB7QXJyYXl9CiAgICovCiAgaWYgKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKSB7CiAgICB2YXIgZm9yRWFjaCA9IGZ1bmN0aW9uIChhcnJheSwgZm4pIHsKICAgICAgcmV0dXJuIGFycmF5LmZvckVhY2goZm4sIGFyZ3VtZW50c1syXSkKICAgIH0KICB9IGVsc2UgewogICAgdmFyIGZvckVhY2ggPSBmdW5jdGlvbiAoYXJyYXksIGZuKSB7CiAgICAgIGlmIChhcnJheSA9PT0gdm9pZCAwIHx8IGFycmF5ID09PSBudWxsKSB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICAgIHZhciB0ID0gT2JqZWN0KGFycmF5KTsKICAgICAgdmFyIGxlbiA9IHQubGVuZ3RoID4+PiAwOwogICAgICBpZiAodHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iKSB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICAgIAoKICAgICAgdmFyIHRoaXNwID0gYXJndW1lbnRzWzJdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKGkgaW4gdCkgZm4uY2FsbCh0aGlzcCwgdFtpXSwgaSwgdCk7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgLyohCiAgICogQSB3cmFwcGVyIGFyb3VuZCBuYXRpdmUgQXJyYXkucHJvdG90eXBlLmZpbHRlci4KICAgKiBGYWxscyBiYWNrIHRvIGEgcHVyZSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIGluIGJyb3dzZXJzIHRoYXQgZG8gbm90IHN1cHBvcnQgQXJyYXkucHJvdG90eXBlLmZpbHRlci4KICAgKiBGb3IgbW9yZSBkZXRhaWxzIHNlZSB0aGUgZnVsbCBkb2NzIG9uIE1EQyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9BcnJheS9maWx0ZXIKICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHthcnJheX0gdGhlIGFycmF5IHRvIGZpbHRlcgogICAqIEBwYXJhbSB7Zm59IHRoZSBmdW5jdGlvbiB0byBkbyB0aGUgZmlsdGVyaW5nCiAgICogQHBhcmFtIHt0aGlzcH0gYW4gb3B0aW9uYWwgcGFyYW0gdGhhdCB3aWxsIGJlIHNldCBhcyBmbidzIHRoaXMgdmFsdWUKICAgKiBAcmV0dXJucyB7QXJyYXl9CiAgICovCiAgaWYgKEFycmF5LnByb3RvdHlwZS5maWx0ZXIpIHsKICAgIHZhciBmaWx0ZXIgPSBmdW5jdGlvbiAoYXJyYXksIGZuKSB7CiAgICAgIHJldHVybiBhcnJheS5maWx0ZXIoZm4sIGFyZ3VtZW50c1syXSkKICAgIH0KICB9IGVsc2UgewogICAgdmFyIGZpbHRlciA9IGZ1bmN0aW9uKGFycmF5LCBmbikgewogICAgICBpZiAoYXJyYXkgPT09IHZvaWQgMCB8fCBhcnJheSA9PT0gbnVsbCkgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwogICAgICB2YXIgdCA9IE9iamVjdChhcnJheSk7CiAgICAgIHZhciBsZW4gPSB0Lmxlbmd0aCA+Pj4gMDsKICAgICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwogICAgICAKCiAgICAgIHZhciByZXMgPSBbXTsKICAgICAgdmFyIHRoaXNwID0gYXJndW1lbnRzWzJdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKGkgaW4gdCkgewogICAgICAgICAgdmFyIHZhbCA9IHRbaV07IC8vIGluIGNhc2UgZm4gbXV0YXRlcyB0aGlzCiAgICAgICAgICBpZiAoZm4uY2FsbCh0aGlzcCwgdmFsLCBpLCB0KSkgcmVzLnB1c2godmFsKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXM7CiAgICB9OwogIH07CgogIC8qIQogICAqIEEgd3JhcHBlciBhcm91bmQgbmF0aXZlIEFycmF5LnByb3RvdHlwZS5tYXAuCiAgICogRmFsbHMgYmFjayB0byBhIHB1cmUgSmF2YVNjcmlwdCBpbXBsZW1lbnRhdGlvbiBpbiBicm93c2VycyB0aGF0IGRvIG5vdCBzdXBwb3J0IEFycmF5LnByb3RvdHlwZS5tYXAuCiAgICogRm9yIG1vcmUgZGV0YWlscyBzZWUgdGhlIGZ1bGwgZG9jcyBvbiBNREMgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvbWFwCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7YXJyYXl9IHRoZSBhcnJheSB0byBtYXAKICAgKiBAcGFyYW0ge2ZufSB0aGUgZnVuY3Rpb24gdG8gZG8gdGhlIG1hcHBpbmcKICAgKiBAcGFyYW0ge3RoaXNwfSBhbiBvcHRpb25hbCBwYXJhbSB0aGF0IHdpbGwgYmUgc2V0IGFzIGZuJ3MgdGhpcyB2YWx1ZQogICAqIEByZXR1cm5zIHtBcnJheX0KICAgKi8KCiAgaWYgKEFycmF5LnByb3RvdHlwZS5tYXApIHsKICAgIHZhciBtYXAgPSBmdW5jdGlvbiAoYXJyYXksIGZuKSB7CiAgICAgIHJldHVybiBhcnJheS5tYXAoZm4sIGFyZ3VtZW50c1syXSkKICAgIH0KICB9IGVsc2UgewogICAgdmFyIG1hcCA9IGZ1bmN0aW9uKGFycmF5LCBmbikgewogICAgICBpZiAoYXJyYXkgPT09IHZvaWQgMCB8fCBhcnJheSA9PT0gbnVsbCkKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CgogICAgICB2YXIgdCA9IE9iamVjdChhcnJheSk7CiAgICAgIHZhciBsZW4gPSB0Lmxlbmd0aCA+Pj4gMDsKICAgICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CgogICAgICB2YXIgcmVzID0gbmV3IEFycmF5KGxlbik7CiAgICAgIHZhciB0aGlzcCA9IGFyZ3VtZW50c1syXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmIChpIGluIHQpCiAgICAgICAgICByZXNbaV0gPSBmbi5jYWxsKHRoaXNwLCB0W2ldLCBpLCB0KTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlczsKICAgIH07CiAgfTsKCiAgLyohCiAgICogQSBjb252aW5pZW5jZSBmdW5jdGlvbiBmb3IgY29udmVydGluZyBhcmd1bWVudHMgdG8gYSBwcm9wZXIgYXJyYXkKICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHthcmdzfSBhIGZ1bmN0aW9ucyBhcmd1bWVudHMKICAgKiBAcGFyYW0ge3N0YXJ0fSBhbiBpbnRlZ2VyIGF0IHdoaWNoIHRvIHN0YXJ0IGNvbnZlcnRpbmcgdGhlIGFyZ3VtZW50cyB0byBhbiBhcnJheQogICAqIEByZXR1cm5zIHtBcnJheX0KICAgKi8KICB2YXIgdG9BcnJheSA9IGZ1bmN0aW9uIChhcmdzLCBzdGFydCkgewogICAgdmFyIHN0YXJ0ID0gc3RhcnQgfHwgMAogICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3MsIHN0YXJ0KQogIH0KCiAgLyohCiAgICogRXhwb3NpbmcgdGhlIHB1YmxpYyBpbnRlcmZhY2UgdG8gdGhlIFV0aWxzIG1vZHVsZQogICAqIEBwcml2YXRlCiAgICovCiAgcmV0dXJuIHsKICAgIGV2ZXJ5OiBldmVyeSwKICAgIGZvckVhY2g6IGZvckVhY2gsCiAgICBmaWx0ZXI6IGZpbHRlciwKICAgIHRvQXJyYXk6IHRvQXJyYXksCiAgICBtYXA6IG1hcAogIH0KfSkoKQoKLyohCiAqIERhdmlzIC0gbGlzdGVuZXIKICogQ29weXJpZ2h0IChDKSAyMDExIE9saXZlciBOaWdodGluZ2FsZQogKiBNSVQgTGljZW5zZWQKICovCgovKioKICogQSBtb2R1bGUgdG8gYmluZCB0byBsaW5rIGNsaWNrcyBhbmQgZm9ybSBzdWJtaXRzIGFuZCB0dXJuIHdoYXQgd291bGQgbm9ybWFsbHkgYmUgaHR0cCByZXF1ZXN0cwogKiBpbnRvIGluc3RhbmNlcyBvZiBEYXZpcy5SZXF1ZXN0LiAgVGhlc2UgcmVxdWVzdCBvYmplY3RzIGFyZSB0aGVuIHB1c2hlZCBvbnRvIHRoZSBoaXN0b3J5IHN0YWNrCiAqIHVzaW5nIHRoZSBEYXZpcy5oaXN0b3J5IG1vZHVsZS4KICoKICogVGhpcyBtb2R1bGUgdXNlcyBEYXZpcy4kLCB3aGljaCBieSBkZWZ1YWx0IGlzIGpRdWVyeSBmb3IgaXRzIGV2ZW50IGJpbmRpbmcgYW5kIGV2ZW50IG9iamVjdCBub3JtYWxpemF0aW9uLgogKiBUbyB1c2UgRGF2aXMgd2l0aCBhbnksIG9yIG5vLCBKYXZhU2NyaXB0IGZyYW1ld29yayBiZSBzdXJlIHRvIHByb3ZpZGUgc3VwcG9ydCBmb3IgYWxsIHRoZSBtZXRob2RzIGNhbGxlZAogKiBvbiBEYXZpcy4kLgogKgogKiBAbW9kdWxlCiAqLwpEYXZpcy5saXN0ZW5lciA9IGZ1bmN0aW9uICgpIHsKCiAgLyohCiAgICogTWV0aG9kcyB0byBjaGVjayB3aGV0aGVyIGFuIGVsZW1lbnQgaGFzIGFuIGhyZWYgb3IgYWN0aW9uIHRoYXQgaXMgbG9jYWwgdG8gdGhpcyBwYWdlCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgb3JpZ2luQ2hlY2tzID0gewogICAgQTogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGVsZW0uaG9zdCAhPT0gd2luZG93LmxvY2F0aW9uLmhvc3QgfHwgZWxlbS5wcm90b2NvbCAhPT0gd2luZG93LmxvY2F0aW9uLnByb3RvY29sCiAgICB9LAoKICAgIEZPUk06IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHZhciBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpCiAgICAgIGEuaHJlZiA9IGVsZW0uYWN0aW9uCiAgICAgIHJldHVybiB0aGlzLkEoYSkKICAgIH0KICB9CgogIC8qIQogICAqIENoZWNrcyB3aGV0aGVyIHRoZSB0YXJnZXQgb2YgYSBjbGljayBvciBzdWJtaXQgZXZlbnQgaGFzIGFuIGhyZWYgb3IgYWN0aW9uIHRoYXQgaXMgbG9jYWwgdG8gdGhlCiAgICogY3VycmVudCBwYWdlLiAgT25seSBsaW5rcyBvciB0YXJnZXRzIHdpdGggbG9jYWwgaHJlZnMgb3IgYWN0aW9ucyB3aWxsIGJlIGhhbmRsZWQgYnkgZGF2aXMsIGFsbAogICAqIG90aGVycyB3aWxsIGJlIGlnbm9yZWQuCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgZGlmZmVyZW50T3JpZ2luID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgIGlmICghb3JpZ2luQ2hlY2tzW2VsZW0ubm9kZU5hbWUudG9VcHBlckNhc2UoKV0pIHJldHVybiB0cnVlIC8vIHRoZSBlbGVtIGlzIG5laXRoZXIgYSBsaW5rIG9yIGEgZm9ybQogICAgcmV0dXJuIG9yaWdpbkNoZWNrc1tlbGVtLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCldKGVsZW0pCiAgfQoKICAvKiEKICAgKiBBIGhhbmRsZXIgdGhhdCBjcmVhdGVzIGEgbmV3IERhdmlzLlJlcXVlc3QgYW5kIHB1c2hlcyBpdCBvbnRvIHRoZSBoaXN0b3J5IHN0YWNrIHVzaW5nIERhdmlzLmhpc3RvcnkuCiAgICogCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gdGFyZ2V0RXh0cmFjdG9yIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSBldmVudCB0YXJnZXQgalF1ZXJ5IG9iamVjdCBhbmQgc2hvdWxkIHJldHVybiBhbiBvYmplY3Qgd2l0aCBwYXRoLCB0aXRsZSBhbmQgbWV0aG9kLgogICAqIEBwcml2YXRlCiAgICovCiAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiAodGFyZ2V0RXh0cmFjdG9yKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIGlmIChkaWZmZXJlbnRPcmlnaW4odGhpcykpIHJldHVybiB0cnVlCiAgICAgIHZhciByZXF1ZXN0ID0gbmV3IERhdmlzLlJlcXVlc3QgKHRhcmdldEV4dHJhY3Rvci5jYWxsKERhdmlzLiQodGhpcykpKTsKICAgICAgRGF2aXMubG9jYXRpb24uYXNzaWduKHJlcXVlc3QpCiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpCiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKICB9OwoKICAvKiEKICAgKiBBIGhhbmRsZXIgc3BlY2lhbGl6ZWQgZm9yIGNsaWNrIGV2ZW50cy4gIEdldHMgdGhlIHJlcXVlc3QgZGV0YWlscyBmcm9tIGEgbGluayBlbGVtCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgY2xpY2tIYW5kbGVyID0gaGFuZGxlcihmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMKICAgIHJldHVybiB7CiAgICAgIG1ldGhvZDogJ2dldCcsCiAgICAgIGZ1bGxQYXRoOiB0aGlzLmF0dHIoJ2hyZWYnKSwKICAgICAgdGl0bGU6IHRoaXMuYXR0cigndGl0bGUnKSwKICAgICAgZGVsZWdhdGVUb1NlcnZlcjogZnVuY3Rpb24gKCkgewogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSA9IHNlbGYuYXR0cignaHJlZicpCiAgICAgIH0KICAgIH07CiAgfSk7CgogIC8qIQogICAqIERlY29kZXMgdGhlIHVybCwgaW5jbHVkaW5nICsgY2hhcmFjdGVycy4KICAgKiBAcHJpdmF0ZQogICAqLwogIHZhciBkZWNvZGVVcmwgPSBmdW5jdGlvbiAoc3RyKSB7CiAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHN0ci5yZXBsYWNlKC9cKy9nLCAnJTIwJykpCiAgfTsKCiAgLyohCiAgICogQSBoYW5kbGVyIHNwZWNpYWxpemVkIGZvciBzdWJtaXQgZXZlbnRzLiAgR2V0cyB0aGUgcmVxdWVzdCBkZXRhaWxzIGZyb20gYSBmb3JtIGVsZW0KICAgKiBAcHJpdmF0ZQogICAqLwogIHZhciBzdWJtaXRIYW5kbGVyID0gaGFuZGxlcihmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMKICAgIHJldHVybiB7CiAgICAgIG1ldGhvZDogdGhpcy5hdHRyKCdtZXRob2QnKSwKICAgICAgZnVsbFBhdGg6IGRlY29kZVVybCh0aGlzLnNlcmlhbGl6ZSgpID8gW3RoaXMuYXR0cignYWN0aW9uJyksIHRoaXMuc2VyaWFsaXplKCldLmpvaW4oIj8iKSA6IHRoaXMuYXR0cignYWN0aW9uJykpLAogICAgICB0aXRsZTogdGhpcy5hdHRyKCd0aXRsZScpLAogICAgICBkZWxlZ2F0ZVRvU2VydmVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5zdWJtaXQoKQogICAgICB9CiAgICB9OwogIH0pOwoKICAvKioKICAgKiBCaW5kcyB0byBib3RoIGxpbmsgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pdHMgdXNpbmcgalF1ZXJ5J3MgZGVsZWFnYXRlLgogICAqCiAgICogV2lsbCBjYXRjaCBhbGwgY3VycmVudCBhbmQgZnV0dXJlIGxpbmtzIGFuZCBmb3Jtcy4gIFVzZXMgdGhlIGFwcHMgc2V0dGluZ3MgZm9yIHRoZSBzZWxlY3RvciB0byB1c2UgZm9yIGxpbmtzIGFuZCBmb3JtcwogICAqIAogICAqIEBzZWUgRGF2aXMuQXBwLnNldHRpbmdzCiAgICogQG1lbWJlck9mIGxpc3RlbmVyCiAgICovCiAgdGhpcy5saXN0ZW4gPSBmdW5jdGlvbiAoKSB7CiAgICBEYXZpcy4kKGRvY3VtZW50KS5kZWxlZ2F0ZSh0aGlzLnNldHRpbmdzLmZvcm1TZWxlY3RvciwgJ3N1Ym1pdCcsIHN1Ym1pdEhhbmRsZXIpCiAgICBEYXZpcy4kKGRvY3VtZW50KS5kZWxlZ2F0ZSh0aGlzLnNldHRpbmdzLmxpbmtTZWxlY3RvciwgJ2NsaWNrJywgY2xpY2tIYW5kbGVyKQogIH0KCiAgLyoqCiAgICogVW5iaW5kcyBhbGwgY2xpY2sgYW5kIHN1Ym1pdCBoYW5kbGVycyB0aGF0IHdlcmUgYXR0YXRjaGVkIHdpdGggbGlzdGVuLgogICAqCiAgICogV2lsbCBlZmVjdGl2bGV5IHN0b3AgdGhlIGN1cnJlbnQgYXBwIGZyb20gcHJvY2Vzc2luZyBhbnkgcmVxdWVzdHMgYW5kIGFsbCBsaW5rcyBhbmQgZm9ybXMgd2lsbCBoYXZlIHRoZWlyIGRlZmF1bHQKICAgKiBiZWhhdmlvdXIgcmVzdG9yZWQuCiAgICoKICAgKiBAc2VlIERhdmlzLkFwcC5zZXR0aW5ncwogICAqIEBtZW1iZXJPZiBsaXN0ZW5lcgogICAqLwogIHRoaXMudW5saXN0ZW4gPSBmdW5jdGlvbiAoKSB7CiAgICBEYXZpcy4kKGRvY3VtZW50KS51bmRlbGVnYXRlKHRoaXMuc2V0dGluZ3MubGlua1NlbGVjdG9yLCAnY2xpY2snLCBjbGlja0hhbmRsZXIpCiAgICBEYXZpcy4kKGRvY3VtZW50KS51bmRlbGVnYXRlKHRoaXMuc2V0dGluZ3MuZm9ybVNlbGVjdG9yLCAnc3VibWl0Jywgc3VibWl0SGFuZGxlcikKICB9Cn0KLyohCiAqIERhdmlzIC0gZXZlbnQKICogQ29weXJpZ2h0IChDKSAyMDExIE9saXZlciBOaWdodGluZ2FsZQogKiBNSVQgTGljZW5zZWQKICovCgogLyoqCiAgKiBBIHBsdWdpbiB0aGF0IGFkZHMgYmFzaWMgZXZlbnQgY2FwYWJpbGl0aWVzIHRvIGEgRGF2aXMgYXBwLCBpdCBpcyBpbmNsdWRlZCBieSBkZWZhdWx0LgogICoKICAqIEBtb2R1bGUKICAqLwpEYXZpcy5ldmVudCA9IGZ1bmN0aW9uICgpIHsKCiAgLyohCiAgICogY2FsbGJhY2sgc3RvcmFnZQogICAqLwogIHZhciBjYWxsYmFja3MgPSB7fQoKICAvKioKICAgKiBCaW5kcyBhIGNhbGxiYWNrIHRvIGEgbmFtZWQgZXZlbnQuCiAgICoKICAgKiBUaGUgZm9sbG93aW5nIGV2ZW50cyBhcmUgdHJpZ2dlcmVkIGludGVybmFsbHkgYnkgRGF2aXMgYW5kIGNhbiBiZSBib3VuZCB0bwogICAqCiAgICogICogc3RhcnQgOiBUcmlnZ2VyZWQgd2hlbiB0aGUgYXBwbGljYXRpb24gaXMgc3RhcnRlZAogICAqICAqIGxvb2t1cFJvdXRlIDogVHJpZ2dlcmVkIGJlZm9yZSBsb29raW5nIHVwIGEgcm91dGUuIFRoZSByZXF1ZXN0IGJlaW5nIGxvb2tlZCB1cCBpcyBwYXNzZWQgYXMgYW4gYXJndW1lbnQKICAgKiAgKiBydW5Sb3V0ZSA6IFRyaWdnZXJlZCBiZWZvcmUgcnVubmluZyBhIHJvdXRlLiBUaGUgcmVxdWVzdCBhbmQgcm91dGUgYmVpbmcgcnVuIGFyZSBwYXNzZWQgYXMgYXJndW1lbnRzCiAgICogICogcm91dGVOb3RGb3VuZCA6IFRyaWdnZXJlZCBpZiBubyByb3V0ZSBmb3IgdGhlIGN1cnJlbnQgcmVxdWVzdCBjYW4gYmUgZm91bmQuIFRoZSBjdXJyZW50IHJlcXVlc3QgaXMgcGFzc2VkIGFzIGFuIGFydWdtZW50CiAgICogICogcmVxdWVzdEhhbHRlZCA6IFRyaWdnZXJlZCB3aGVuIGEgYmVmb3JlIGZpbHRlciBoYWx0cyB0aGUgY3VycmVudCByZXF1ZXN0LiBUaGUgY3VycmVudCByZXF1ZXN0IGlzIHBhc3NlZCBhcyBhbiBhcmd1bWVudAogICAqICAqIHVuc3VwcG9ydGVkIDogVHJpZ2dlcmVkIHdoZW4gc3RhcnRpbmcgYSBEYXZpcyBhcHAgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGh0bWw1IHB1c2hTdGF0ZQogICAqCiAgICogRXhhbXBsZQogICAqCiAgICogICAgIGFwcC5iaW5kKCdydW5Sb3V0ZScsIGZ1bmN0aW9uICgpIHsKICAgKiAgICAgICBjb25zb2xlLmxvZygnYWJvdXQgdG8gcnVuIGEgcm91dGUnKQogICAqICAgICB9KQogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50IGV2ZW50IG5hbWUKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBjYWxsYmFjawogICAqIEBtZW1iZXJPZiBldmVudAogICAqLwogIHRoaXMuYmluZCA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgIChjYWxsYmFja3NbZXZlbnRdID0gY2FsbGJhY2tzW2V2ZW50XSB8fCBbXSkucHVzaChmbik7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBUcmlnZ2VycyBhbiBldmVudCB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQgZXZlbnQgbmFtZQogICAqIEBwYXJhbSB7TWl4ZWR9IC4uLgogICAqIEBtZW1iZXJPZiBldmVudAogICAqLwogIHRoaXMudHJpZ2dlciA9IGZ1bmN0aW9uIChldmVudCkgewogICAgdmFyIGFyZ3MgPSBEYXZpcy51dGlscy50b0FycmF5KGFyZ3VtZW50cywgMSksCiAgICAgICAgaGFuZGxlcnMgPSBjYWxsYmFja3NbZXZlbnRdOwoKICAgIGlmICghaGFuZGxlcnMpIHJldHVybiB0aGlzCgogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGhhbmRsZXJzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGhhbmRsZXJzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpCiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfTsKfQovKiEKICogRGF2aXMgLSBsb2dnZXIKICogQ29weXJpZ2h0IChDKSAyMDExIE9saXZlciBOaWdodGluZ2FsZQogKiBNSVQgTGljZW5zZWQKICovCgovKioKICogQSBwbHVnaW4gZm9yIGVuaGFuY2luZyB0aGUgc3RhbmRhcmQgbG9nZ2luZyBhdmFpbGFibGUgdGhyb3VnaCB0aGUgY29uc29sZSBvYmplY3QuCiAqIEF1dG9tYXRpY2FsbHkgaW5jbHVkZWQgaW4gYWxsIERhdmlzIGFwcHMuCiAqCiAqIEdlbmVyYXRlcyBsb2cgbWVzc2FnZXMgb2YgdmFyeWluZyBzZXZlcml0eSBpbiB0aGUgZm9ybWF0CiAqCiAqIGBbU3VuIEphbiAyMyAyMDExIDE2OjE1OjIxIEdNVCswMDAwIChHTVQpXSA8bWVzc2FnZT5gCiAqCiAqIEBtb2R1bGUKICovCkRhdmlzLmxvZ2dlciA9IGZ1bmN0aW9uICgpIHsKCiAgLyohCiAgICogR2VuZXJhdGluZyB0aGUgdGltZXN0YW1wIHBvcnRpb24gb2YgdGhlIGxvZyBtZXNzYWdlCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiB0aW1lc3RhbXAoKXsKICAgIHJldHVybiAiWyIgKyBEYXRlKCkgKyAiXSI7CiAgfQoKICAvKiEKICAgKiBQdXNoaW5nIHRoZSB0aW1lc3RhbXAgb250byB0aGUgZnJvbnQgb2YgdGhlIGFyZ3VtZW50cyB0byBsb2cKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHByZXBBcmdzKGFyZ3MpIHsKICAgIHZhciBhID0gRGF2aXMudXRpbHMudG9BcnJheShhcmdzKQogICAgYS51bnNoaWZ0KHRpbWVzdGFtcCgpKQogICAgcmV0dXJuIGEuam9pbignICcpOwogIH0KCiAgdmFyIGxvZ1R5cGUgPSBmdW5jdGlvbiAobG9nTGV2ZWwpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh3aW5kb3cuY29uc29sZSkgY29uc29sZVtsb2dMZXZlbF0ocHJlcEFyZ3MoYXJndW1lbnRzKSk7CiAgICB9CiAgfQoKCiAgLyoqCiAgICogUHJpbnRzIGFuIGVycm9yIG1lc3NhZ2UgdG8gdGhlIGNvbnNvbGUgaWYgdGhlIGNvbnNvbGUgaXMgYXZhaWxhYmxlLgogICAqCiAgICogQHBhcmFtcyB7U3RyaW5nfSBBbGwgYXJndW1lbnRzIGFyZSBjb21iaW5lZCBhbmQgbG9nZ2VkIHRvIHRoZSBjb25zb2xlLgogICAqIEBtZW1iZXJPZiBsb2dnZXIKICAgKi8KICAgdmFyIGVycm9yID0gbG9nVHlwZSgnZXJyb3InKQoKICAvKioKICAgKiBQcmludHMgYW4gaW5mbyBtZXNzYWdlIHRvIHRoZSBjb25zb2xlIGlmIHRoZSBjb25zb2xlIGlzIGF2YWlsYWJsZS4KICAgKgogICAqIEBwYXJhbXMge1N0cmluZ30gQWxsIGFyZ3VtZW50cyBhcmUgY29tYmluZWQgYW5kIGxvZ2dlZCB0byB0aGUgY29uc29sZS4KICAgKiBAbWVtYmVyT2YgbG9nZ2VyCiAgICovCiAgIHZhciBpbmZvID0gbG9nVHlwZSgnaW5mbycpCgogIC8qKgogICAqIFByaW50cyBhIHdhcm5pbmcgbWVzc2FnZSB0byB0aGUgY29uc29sZSBpZiB0aGUgY29uc29sZSBpcyBhdmFpbGFibGUuCiAgICoKICAgKiBAcGFyYW1zIHtTdHJpbmd9IEFsbCBhcmd1bWVudHMgYXJlIGNvbWJpbmVkIGFuZCBsb2dnZWQgdG8gdGhlIGNvbnNvbGUuCiAgICogQG1lbWJlck9mIGxvZ2dlcgogICAqLwogICB2YXIgd2FybiA9IGxvZ1R5cGUoJ3dhcm4nKQoKICAvKiEKICAgKiBFeHBvc2VzIHRoZSBwdWJsaWMgbWV0aG9kcyBvZiB0aGUgbW9kdWxlCiAgICogQHByaXZhdGUKICAgKi8KICB0aGlzLmxvZ2dlciA9IHsKICAgIGVycm9yOiBlcnJvciwKICAgIGluZm86IGluZm8sCiAgICB3YXJuOiB3YXJuCiAgfQp9LyohCiAqIERhdmlzIC0gUm91dGUKICogQ29weXJpZ2h0IChDKSAyMDExIE9saXZlciBOaWdodGluZ2FsZQogKiBNSVQgTGljZW5zZWQKICovCgpEYXZpcy5Sb3V0ZSA9IChmdW5jdGlvbiAoKSB7CgogIHZhciBwYXRoTmFtZVJlZ2V4ID0gLzooW1x3XGRdKykvZzsKICB2YXIgcGF0aE5hbWVSZXBsYWNlbWVudCA9ICIoW15cL10rKSI7CgogIHZhciBzcGxhdE5hbWVSZWdleCA9IC9cKihbXHdcZF0rKS9nOwogIHZhciBzcGxhdE5hbWVSZXBsYWNlbWVudCA9ICIoLiopIjsKCiAgdmFyIG5hbWVSZWdleCA9IC9bOnxcKl0oW1x3XGRdKykvZwoKLyoqCiAqIERhdmlzLlJvdXRlcyBhcmUgdGhlIG1haW4gcGFydCBvZiBhIERhdmlzIGFwcGxpY2F0aW9uLiAgVGhleSBjb25zaXN0IG9mIGFuIEhUVFAgbWV0aG9kLCBhIHBhdGgKICogYW5kIGEgY2FsbGJhY2sgZnVuY3Rpb24uICBXaGVuIGEgbGluayBvciBhIGZvcm0gdGhhdCBEYXZpcyBoYXMgYm91bmQgdG8gYXJlIGNsaWNrZWQgb3Igc3VibWl0dGVkCiAqIGEgcmVxdWVzdCBpcyBwdXNoZWQgb24gdGhlIGhpc3Rvcnkgc3RhY2sgYW5kIGEgcm91dGUgdGhhdCBtYXRjaGVzIHRoZSBwYXRoIGFuZCBtZXRob2Qgb2YgdGhlCiAqIGdlbmVyYXRlZCByZXF1ZXN0IGlzIHJ1bi4KICoKICogVGhlIHBhdGggZm9yIHRoZSByb3V0ZSBjYW4gY29uc2lzdCBvZiBwbGFjZWhvbGRlcnMgZm9yIGF0dHJpYnV0ZXMsIHRoZXNlIHdpbGwgdGhlbiBiZSBhdmFpbGFibGUKICogb24gdGhlIHJlcXVlc3QuICBTaW1wbGUgdmFyaWFibGVzIHNob3VsZCBiZSBwcmVmaXhlZCB3aXRoIGEgY29sYW4sIGFuZCBmb3Igc3BsYXQgc3R5bGUgcGFyYW1zIHVzZQogKiBhbiBhc3Rlcmlzay4KICoKICogSW5zaWRlIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAndGhpcycgaXMgYm91bmQgdG8gdGhlIHJlcXVlc3QuCiAqCiAqIEV4YW1wbGU6CiAqCiAqICAgICB2YXIgcm91dGUgPSBuZXcgRGF2aXMuUm91dGUgKCdnZXQnLCAnL2Zvby86aWQnLCBmdW5jdGlvbiAocmVxKSB7CiAqICAgICAgIHZhciBpZCA9IHJlcS5wYXJhbXNbJ2lkJ10KICogICAgICAgLy8gZG8gc29tZXRoaW5nIGludGVyZXN0aW5nIQogKiAgICAgfSkKICoKICogICAgIHZhciByb3V0ZSA9IG5ldyBEYXZpcy5Sb3V0ZSAoJ2dldCcsICcvZm9vLypzcGxhdCcsIGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgdmFyIGlkID0gcmVxLnBhcmFtc1snc3BsYXQnXQogKiAgICAgICAvLyBzcGxhdCB3aWxsIGNvbnRhaW4gZXZlcnl0aGluZyBhZnRlciB0aGUgL2Zvby8gaW4gdGhlIHBhdGguCiAqICAgICB9KQogKgogKiBZb3UgY2FuIGluY2x1ZGUgYW55IG51bWJlciBvZiByb3V0ZSBsZXZlbCAnbWlkZGxld2FyZScgd2hlbiBkZWZpbmluZyByb3V0ZXMuICBUaGVzZSBtaWRkbGV3YXJlcyBhcmUKICogcnVuIGluIG9yZGVyIGFuZCBuZWVkIHRvIGV4cGxpY2l0bHkgY2FsbCB0aGUgbmV4dCBoYW5kbGVyIGluIHRoZSBzdGFjay4gIFVzaW5nIHJvdXRlIG1pZGRsZXdhcmUgYWxsb3dzCiAqIHlvdSB0byBzaGFyZSBjb21tb24gbG9naWMgYmV0d2VlbiByb3V0ZXMgYW5kIGlzIGFsc28gYSBnb29kIHBsYWNlIHRvIGxvYWQgYW55IGRhdGEgb3IgZG8gYW55IGFzeW5jIGNhbGxzCiAqIGtlZXBpbmcgeW91ciBtYWluIGhhbmRsZXIgc2ltcGxlIGFuZCBmb2N1c2VkLgogKgogKiBFeGFtcGxlOgogKgogKiAgICAgdmFyIGxvYWRVc2VyID0gZnVuY3Rpb24gKHJlcSwgbmV4dCkgewogKiAgICAgICAkLmdldCgnL3VzZXJzL2N1cnJlbnQnLCBmdW5jdGlvbiAodXNlcikgewogKiAgICAgICAgIHJlcS51c2VyID0gdXNlcgogKiAgICAgICAgIG5leHQocmVxKQogKiAgICAgICB9KQogKiAgICAgfQogKgogKiAgICAgdmFyIHJvdXRlID0gbmV3IERhdmlzLlJvdXRlICgnZ2V0JywgJy9mb28vOmlkJywgbG9hZFVzZXIsIGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgcmVuZGVyVXNlcihyZXEudXNlcikKICogICAgIH0pCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge1N0cmluZ30gbWV0aG9kIFRoaXMgc2hvdWxkIGJlIG9uZSBvZiBlaXRoZXIgJ2dldCcsICdwb3N0JywgJ3B1dCcsICdkZWxldGUnLCAnYmVmb3JlJywgJ2FmdGVyJyBvciAnc3RhdGUnCiAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoaXMgc3RyaW5nIGNhbiBjb250YWluIHBsYWNlIGhvbGRlcnMgZm9yIHZhcmlhYmxlcywgZS5nLiAnL3VzZXIvOmlkJyBvciAnL3VzZXIvKnNwbGF0JwogKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBPbmUgb3IgbW9yZSBjYWxsYmFja3MgdGhhdCB3aWxsIGJlIGNhbGxlZCBpbiBvcmRlciB3aGVuIGEgcmVxdWVzdCBtYXRjaGluZyBib3RoIHRoZSBwYXRoIGFuZCBtZXRob2QgaXMgdHJpZ2dlcmVkLgogKi8KICB2YXIgUm91dGUgPSBmdW5jdGlvbiAobWV0aG9kLCBwYXRoLCBoYW5kbGVycykgewogICAgdmFyIGNvbnZlcnRQYXRoVG9SZWdFeHAgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghKHBhdGggaW5zdGFuY2VvZiBSZWdFeHApKSB7CiAgICAgICAgdmFyIHN0ciA9IHBhdGgKICAgICAgICAgIC5yZXBsYWNlKHBhdGhOYW1lUmVnZXgsIHBhdGhOYW1lUmVwbGFjZW1lbnQpCiAgICAgICAgICAucmVwbGFjZShzcGxhdE5hbWVSZWdleCwgc3BsYXROYW1lUmVwbGFjZW1lbnQpOwoKICAgICAgICAvLyBNb3N0IGJyb3dzZXJzIHdpbGwgcmVzZXQgdGhpcyB0byB6ZXJvIGFmdGVyIGEgcmVwbGFjZSBjYWxsLiAgSUUgd2lsbAogICAgICAgIC8vIHNldCBpdCB0byB0aGUgaW5kZXggb2YgdGhlIGxhc3QgbWF0Y2hlZCBjaGFyYWN0ZXIuCiAgICAgICAgcGF0aC5sYXN0SW5kZXggPSAwOwoKICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cCgiXiIgKyBzdHIgKyAiJCIsICJnaSIpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBwYXRoOwogICAgICB9OwogICAgfTsKCiAgICB2YXIgY29udmVydE1ldGhvZFRvUmVnRXhwID0gZnVuY3Rpb24gKCkgewogICAgICBpZiAoIShtZXRob2QgaW5zdGFuY2VvZiBSZWdFeHApKSB7CiAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoIl4iICsgbWV0aG9kICsgIiQiLCAiaSIpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBtZXRob2QKICAgICAgfTsKICAgIH0KCiAgICB2YXIgY2FwdHVyZVBhdGhQYXJhbU5hbWVzID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgbmFtZXMgPSBbXSwgYTsKICAgICAgd2hpbGUgKChhID0gbmFtZVJlZ2V4LmV4ZWMocGF0aCkpKSBuYW1lcy5wdXNoKGFbMV0pOwogICAgICByZXR1cm4gbmFtZXM7CiAgICB9OwoKICAgIHRoaXMucGFyYW1OYW1lcyA9IGNhcHR1cmVQYXRoUGFyYW1OYW1lcygpOwogICAgdGhpcy5wYXRoID0gY29udmVydFBhdGhUb1JlZ0V4cCgpOwogICAgdGhpcy5tZXRob2QgPSBjb252ZXJ0TWV0aG9kVG9SZWdFeHAoKTsKCiAgICBpZiAodHlwZW9mIGhhbmRsZXJzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMuaGFuZGxlcnMgPSBbaGFuZGxlcnNdCiAgICB9IGVsc2UgewogICAgICB0aGlzLmhhbmRsZXJzID0gaGFuZGxlcnM7CiAgICB9CiAgfQoKICAvKioKICAgKiBUZXN0cyB3aGV0aGVyIG9yIG5vdCBhIHJvdXRlIG1hdGNoZXMgYSBwYXJ0aWN1bGFyIHJlcXVlc3QuCiAgICoKICAgKiBFeGFtcGxlOgogICAqCiAgICogICAgIHJvdXRlLm1hdGNoKCdnZXQnLCAnL2Zvby8xMicpCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gbWV0aG9kIHRoZSBtZXRob2QgdG8gbWF0Y2ggYWdhaW5zdAogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIHRoZSBwYXRoIHRvIG1hdGNoIGFnYWluc3QKICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0KICAgKi8KICBSb3V0ZS5wcm90b3R5cGUubWF0Y2ggPSBmdW5jdGlvbiAobWV0aG9kLCBwYXRoKSB7CiAgICB0aGlzLnJlc2V0KCk7CiAgICByZXR1cm4gKHRoaXMubWV0aG9kLnRlc3QobWV0aG9kKSkgJiYgKHRoaXMucGF0aC50ZXN0KHBhdGgpKQogIH0KCiAgLyoqCiAgICogUmVzZXRzIHRoZSBSZWdFeHBzIGZvciBtZXRob2QgYW5kIHBhdGgKICAgKi8KICBSb3V0ZS5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLm1ldGhvZC5sYXN0SW5kZXggPSAwOwogICAgdGhpcy5wYXRoLmxhc3RJbmRleCA9IDA7CiAgfQoKICAvKioKICAgKiBSdW5zIHRoZSBjYWxsYmFjayBhc3NvY2lhdGVkIHdpdGggYSBwYXJ0aWN1bGFyIHJvdXRlIGFnYWluc3QgdGhlIHBhc3NlZCByZXF1ZXN0LgogICAqCiAgICogQW55IG5hbWVkIHBhcmFtcyBpbiB0aGUgcmVxdWVzdCBwYXRoIGFyZSBleHRyYWN0ZWQsIGFzIHBlciB0aGUgcm91dGVzIHBhdGgsIGFuZAogICAqIGFkZGVkIG9udG8gdGhlIHJlcXVlc3RzIHBhcmFtcyBvYmplY3QuCiAgICoKICAgKiBFeGFtcGxlOgogICAqCiAgICogICAgIHJvdXRlLnJ1bihyZXF1ZXN0KQogICAqCiAgICogQHBhcmFtcyB7RGF2aXMuUmVxdWVzdH0gcmVxdWVzdAogICAqIEByZXR1cm5zIHtPYmplY3R9IHdoYXRldmVyIHRoZSByb3V0ZXMgY2FsbGJhY2sgcmV0dXJucwogICAqLwogIFJvdXRlLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAocmVxdWVzdCkgewogICAgdGhpcy5yZXNldCgpOwogICAgdmFyIG1hdGNoZXMgPSB0aGlzLnBhdGguZXhlYyhyZXF1ZXN0LnBhdGgpOwogICAgaWYgKG1hdGNoZXMpIHsKICAgICAgbWF0Y2hlcy5zaGlmdCgpOwogICAgICBmb3IgKHZhciBpPTA7IGkgPCBtYXRjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVxdWVzdC5wYXJhbXNbdGhpcy5wYXJhbU5hbWVzW2ldXSA9IG1hdGNoZXNbaV07CiAgICAgIH07CiAgICB9OwoKICAgIHZhciBoYW5kbGVycyA9IERhdmlzLnV0aWxzLm1hcCh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbiAoaGFuZGxlciwgaSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKHJlcSkgewogICAgICAgIHJldHVybiBoYW5kbGVyLmNhbGwocmVxLCByZXEsIGhhbmRsZXJzW2krMV0pCiAgICAgIH0KICAgIH0pCgogICAgcmV0dXJuIGhhbmRsZXJzWzBdKHJlcXVlc3QpCiAgfQoKICAvKioKICAgKiBDb252ZXJ0cyB0aGUgcm91dGUgdG8gYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgaXRzZWxmIGJ5IGNvbWJpbmluZyB0aGUgbWV0aG9kIGFuZCBwYXRoCiAgICogYXR0cmlidXRlcy4KICAgKgogICAqIEByZXR1cm5zIHtTdHJpbmd9IHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgcm91dGUKICAgKi8KICBSb3V0ZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gW3RoaXMubWV0aG9kLCB0aGlzLnBhdGhdLmpvaW4oJyAnKTsKICB9CgogIC8qIQogICAqIGV4cG9zaW5nIHRoZSBjb25zdHJ1Y3RvcgogICAqIEBwcml2YXRlCiAgICovCiAgcmV0dXJuIFJvdXRlOwp9KSgpCi8qIQogKiBEYXZpcyAtIHJvdXRlcgogKiBDb3B5cmlnaHQgKEMpIDIwMTEgT2xpdmVyIE5pZ2h0aW5nYWxlCiAqIE1JVCBMaWNlbnNlZAogKi8KCi8qKgogKiBBIGRlY29yYXRvciB0aGF0IGFkZHMgY29udmluaWVuY2UgbWV0aG9kcyB0byBhIERhdmlzLkFwcCBmb3IgZWFzaWx5IGNyZWF0aW5nIGluc3RhbmNlcwogKiBvZiBEYXZpcy5Sb3V0ZSBhbmQgbG9va2luZyB1cCByb3V0ZXMgZm9yIGEgcGFydGljdWxhciByZXF1ZXN0LgogKgogKiBQcm92aWRlcyBnZXQsIHBvc3QgcHV0IGFuZCBkZWxldGUgbWV0aG9kIHNob3J0Y3V0cyBmb3IgY3JlYXRpbmcgaW5zdGFuY2VzIG9mIERhdmlzLlJvdXRlcwogKiB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIG1ldGhvZC4gIFRoaXMgYWxsb3dzIHNpbXBsZSBSRVNUIHN0eWxlZCByb3V0aW5nIGZvciBhIGNsaWVudCBzaWRlCiAqIEphdmFTY3JpcHQgYXBwbGljYXRpb24uCiAqCiAqICMjIyBFeGFtcGxlCiAqCiAqICAgICBhcHAuZ2V0KCcvZm9vLzppZCcsIGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgLy8gZ2V0IHRoZSBmb28gd2l0aCBpZCA9IHJlcS5wYXJhbXNbJ2lkJ10KICogICAgIH0pCiAqICAgICAKICogICAgIGFwcC5wb3N0KCcvZm9vJywgZnVuY3Rpb24gKHJlcSkgewogKiAgICAgICAvLyBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgZm9vIHdpdGggcmVxLnBhcmFtcwogKiAgICAgfSkKICogICAgIAogKiAgICAgYXBwLnB1dCgnL2Zvby86aWQnLCBmdW5jdGlvbiAocmVxKSB7CiAqICAgICAgIC8vIHVwZGF0ZSB0aGUgaW5zdGFuY2Ugb2YgZm9vIHdpdGggaWQgPSByZXEucGFyYW1zWydpZCddCiAqICAgICB9KQogKiAgICAgCiAqICAgICBhcHAuZGVsKCcvZm9vLzppZCcsIGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgLy8gZGVsZXRlIHRoZSBpbnN0YW5jZSBvZiBmb28gd2l0aCBpZCA9IHJlcS5wYXJhbXNbJ2lkJ10KICogICAgIH0pCiAqCiAqIEFzIHdlbGwgYXMgcHJvdmlkaW5nIGNvbnZpbmllbmNlIG1ldGhvZHMgZm9yIGNyZWF0aW5nIGluc3RhbmNlcyBvZiBEYXZpcy5Sb3V0ZXMgdGhlIHJvdXRlcgogKiBhbHNvIHByb3ZpZGVzIG1ldGhvZHMgZm9yIGNyZWF0aW5nIHNwZWNpYWwgaW5zdGFuY2VzIG9mIHJvdXRlcyBjYWxsZWQgZmlsdGVycy4gIEJlZm9yZSBmaWx0ZXJzCiAqIHJ1biBiZWZvcmUgYW55IG1hdGNoaW5nIHJvdXRlIGlzIHJ1biwgYW5kIGFmdGVyIGZpbHRlcnMgcnVuIGFmdGVyIGFueSBtYXRjaGVkIHJvdXRlIGhhcyBydW4uCiAqIEEgYmVmb3JlIGZpbHRlciBjYW4gcmV0dXJuIGZhbHNlIHRvIGhhbHQgdGhlIHJ1bm5pbmcgb2YgYW55IG1hdGNoZWQgcm91dGVzIG9yIG90aGVyIGJlZm9yZSBmaWx0ZXJzLgogKgogKiBBIGZpbHRlciBjYW4gdGFrZSBhbiBvcHRpb25hbCBwYXRoIHRvIG1hdGNoIG9uLCBvciB3aXRob3V0IGEgcGF0aCB3aWxsIG1hdGNoIGV2ZXJ5IHJlcXVlc3QuCiAqCiAqICMjIyBFeGFtcGxlCiAqCiAqICAgICBhcHAuYmVmb3JlKCcvZm9vLzppZCcsIGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgLy8gd2lsbCBvbmx5IHJ1biBiZWZvcmUgcmVxdWVzdCBtYXRjaGluZyAnL2Zvby86aWQnCiAqICAgICB9KQogKiAgICAgCiAqICAgICBhcHAuYmVmb3JlKGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgLy8gd2lsbCBydW4gYmVmb3JlIGFsbCByb3V0ZXMKICogICAgIH0pCiAqICAgICAKICogICAgIGFwcC5hZnRlcignL2Zvby86aWQnLCBmdW5jdGlvbiAocmVxKSB7CiAqICAgICAgIC8vIHdpbGwgb25seSBydW4gYWZ0ZXIgcm91dGVzIG1hdGNoaW5nICcvZm9vLzppZCcKICogICAgIH0pCiAqICAgICAKICogICAgIGFwcC5hZnRlcihmdW5jdGlvbiAocmVxKSB7CiAqICAgICAgIC8vIHdpbGwgcnVuIGFmdGVyIGFsbCByb3V0ZXMKICogICAgIH0pCiAqCiAqIEFub3RoZXIgc3BlY2lhbCBraW5kIG9mIHJvdXRlLCBjYWxsZWQgc3RhdGUgcm91dGVzLCBhcmUgYWxzbyBnZW5lcmF0ZWQgdXNpbmcgdGhlIHJvdXRlci4gIFN0YXRlIHJvdXRlcwogKiBhcmUgZm9yIHJlcXVlc3RzIHRoYXQgd2lsbCBub3QgY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UgbG9jYXRpb24uICBJbnN0ZWFkIHRoZSBwYWdlIGxvY2F0aW9uIHdpbGwgcmVtYWluCiAqIHRoZSBzYW1lIGJ1dCB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgcGFnZSBoYXMgY2hhbmdlZC4gIFRoaXMgYWxsb3dzIGZvciBzdGF0ZXMgd2hpY2ggdGhlIHNlcnZlciB3aWxsIG5vdAogKiBiZSBleHBlY3RlZCB0byBrbm93IGFib3V0IGFuZCBzdXBwb3J0LgogKgogKiAjIyMgRXhhbXBsZQogKgogKiAgICAgYXBwLnN0YXRlKCcvZm9vLzppZCcsIGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgLy8gd2lsbCBydW4gd2hlbiB0aGUgYXBwIHRyYW5zaXRpb25zIGludG8gdGhlICcvZm9vLzppZCcgc3RhdGUuCiAqICAgICB9KQogKgogKiBVc2luZyB0aGUgYHRyYW5zYCBtZXRob2QgYW4gYXBwIGNhbiB0cmFuc2l0aW9uIHRvIHRoZXNlIGtpbmQgb2Ygc3RhdGVzIHdpdGhvdXQgY2hhbmdpbmcgdGhlIHVybCBsb2NhdGlvbi4KICoKICogRm9yIGNvbnZpbmllbmNlIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCB3aXRoaW4gYSBjb21tb24gYmFzZSBzY29wZSwgdGhpcyBpcyB1c2VmdWwgZm9yIGtlZXBpbmcgeW91ciByb3V0ZQogKiBkZWZpbml0aW9ucyBzaW1wbGVyIGFuZCBEUlllci4gIEEgc2NvcGUgY2FuIGVpdGhlciBjb3ZlciB0aGUgd2hvbGUgYXBwLCBvciBqdXN0IGEgc3Vic2V0IG9mIHRoZSByb3V0ZXMuCiAqCiAqICMjIyBFeGFtcGxlCiAqCiAqICAgICBhcHAuc2NvcGUoJy9mb28nLCBmdW5jdGlvbiAoKSB7CiAqICAgICAgIHRoaXMuZ2V0KCcvOmlkJywgZnVuY3Rpb24gKCkgewogKiAgICAgICAgIC8vIHdpbGwgcnVuIGZvciByb3V0ZXMgdGhhdCBtYXRjaCAnL2Zvby86aWQnCiAqICAgICAgIH0pCiAqICAgICB9KQogKgogKiBAbW9kdWxlCiAqLwpEYXZpcy5yb3V0ZXIgPSBmdW5jdGlvbiAoKSB7CgogIC8qKgogICAqIExvdyBsZXZlbCBtZXRob2QgZm9yIGFkZGluZyByb3V0ZXMgdG8geW91ciBhcHBsaWNhdGlvbi4KICAgKgogICAqIElmIGNhbGxlZCB3aXRoIGp1c3QgYSBtZXRob2Qgd2lsbCByZXR1cm4gYSBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbiB0aGF0IGNhbiBjcmVhdGUgcm91dGVzIHdpdGgKICAgKiB0aGF0IG1ldGhvZC4gIFRoaXMgaXMgdXNlZCBpbnRlcm5hbGx5IHRvIHByb3ZpZGUgc2hvcnRjdXRzIGZvciBnZXQsIHBvc3QsIHB1dCwgZGVsZXRlIGFuZCBzdGF0ZQogICAqIHJvdXRlcy4KICAgKgogICAqIFlvdSBub3JtYWxseSB3YW50IHRvIHVzZSB0aGUgaGlnaGVyIGxldmVsIG1ldGhvZHMgc3VjaCBhcyBnZXQgYW5kIHBvc3QsIGJ1dCB0aGlzIGNhbiBiZSB1c2VmdWwgZm9yIGV4dGVuZGluZwogICAqIERhdmlzIHRvIHdvcmsgd2l0aCBvdGhlciBraW5kcyBvZiByZXF1ZXN0cy4KICAgKgogICAqIEV4YW1wbGU6CiAgICoKICAgKiAgICAgYXBwLnJvdXRlKCdnZXQnLCAnL2ZvbycsIGZ1bmN0aW9uIChyZXEpIHsKICAgKiAgICAgICAvLyB3aWxsIHJ1biB3aGVuIGEgZ2V0IHJlcXVlc3QgaXMgbWFkZSB0byAnL2ZvbycKICAgKiAgICAgfSkKICAgKgogICAqICAgICBhcHAucGF0Y2ggPSBhcHAucm91dGUoJ3BhdGNoJykgLy8gd2lsbCByZXR1cm4gYSBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIHRvIGhhbmRsZSByZXF1ZXN0cyB3aXRoIG1ldGhvZCBvZiBwYXRjaC4KICAgKiAgICAgYXBwLnBhdGNoKCcvYmFyJywgZnVuY3Rpb24gKHJlcSkgewogICAqICAgICAgIC8vIHdpbGwgcnVuIHdoZW4gYSBwYXRjaCByZXF1ZXN0IGlzIG1hZGUgdG8gJy9iYXInCiAgICogICAgIH0pCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gbWV0aG9kIFRoZSBtZXRob2QgZm9yIHRoaXMgcm91dGUuCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGggVGhlIHBhdGggZm9yIHRoaXMgcm91dGUuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaGFuZGxlciBUaGUgaGFuZGxlciBmb3IgdGhpcyByb3V0ZSwgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgcmVxdWVzdCB0aGF0IHRyaWdnZXJlZCB0aGUgcm91dGUuCiAgICogQHJldHVybnMge0RhdmlzLlJvdXRlfSB0aGUgcm91dGUgdGhhdCBoYXMganVzdCBiZWVuIGNyZWF0ZWQgYW5kIGFkZGVkIHRvIHRoZSByb3V0ZSBsaXN0LgogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKi8KICB0aGlzLnJvdXRlID0gZnVuY3Rpb24gKG1ldGhvZCwgcGF0aCkgewogICAgdmFyIGNyZWF0ZVJvdXRlID0gZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgdmFyIGhhbmRsZXJzID0gRGF2aXMudXRpbHMudG9BcnJheShhcmd1bWVudHMsIDEpLAogICAgICAgICAgc2NvcGUgPSBzY29wZVBhdGhzLmpvaW4oJycpLAogICAgICAgICAgcm91dGUgPSBuZXcgRGF2aXMuUm91dGUgKG1ldGhvZCwgc2NvcGUgKyBwYXRoLCBoYW5kbGVycykKCiAgICAgIHJvdXRlQ29sbGVjdGlvbi5wdXNoKHJvdXRlKQogICAgICByZXR1cm4gcm91dGUKICAgIH0KCiAgICByZXR1cm4gKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgPyBjcmVhdGVSb3V0ZSA6IGNyZWF0ZVJvdXRlLmFwcGx5KHRoaXMsIERhdmlzLnV0aWxzLnRvQXJyYXkoYXJndW1lbnRzLCAxKSkKICB9CgogIC8qKgogICAqIEEgY29udmluaWVuY2Ugd3JhcHBlciBhcm91bmQgYGFwcC5yb3V0ZWAgZm9yIGNyZWF0aW5nIGdldCByb3V0ZXMuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgcGF0aCBmb3IgdGhpcyByb3V0ZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBoYW5kbGVyIGZvciB0aGlzIHJvdXRlLCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSByZXF1ZXN0IHRoYXQgdHJpZ2dlcmVkIHRoZSByb3V0ZS4KICAgKiBAcmV0dXJucyB7RGF2aXMuUm91dGV9IHRoZSByb3V0ZSB0aGF0IGhhcyBqdXN0IGJlZW4gY3JlYXRlZCBhbmQgYWRkZWQgdG8gdGhlIHJvdXRlIGxpc3QuCiAgICogQHNlZSBEYXZpcy5yb3V0ZXIucm91dGUKICAgKiBAbWVtYmVyT2Ygcm91dGVyCiAgICovCiAgdGhpcy5nZXQgID0gdGhpcy5yb3V0ZSgnZ2V0JykKCiAgLyoqCiAgICogQSBjb252aW5pZW5jZSB3cmFwcGVyIGFyb3VuZCBgYXBwLnJvdXRlYCBmb3IgY3JlYXRpbmcgcG9zdCByb3V0ZXMuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgcGF0aCBmb3IgdGhpcyByb3V0ZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBoYW5kbGVyIGZvciB0aGlzIHJvdXRlLCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSByZXF1ZXN0IHRoYXQgdHJpZ2dlcmVkIHRoZSByb3V0ZS4KICAgKiBAcmV0dXJucyB7RGF2aXMuUm91dGV9IHRoZSByb3V0ZSB0aGF0IGhhcyBqdXN0IGJlZW4gY3JlYXRlZCBhbmQgYWRkZWQgdG8gdGhlIHJvdXRlIGxpc3QuCiAgICogQHNlZSBEYXZpcy5yb3V0ZXIucm91dGUKICAgKiBAbWVtYmVyT2Ygcm91dGVyCiAgICovCiAgdGhpcy5wb3N0ID0gdGhpcy5yb3V0ZSgncG9zdCcpCgogIC8qKgogICAqIEEgY29udmluaWVuY2Ugd3JhcHBlciBhcm91bmQgYGFwcC5yb3V0ZWAgZm9yIGNyZWF0aW5nIHB1dCByb3V0ZXMuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgcGF0aCBmb3IgdGhpcyByb3V0ZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBoYW5kbGVyIGZvciB0aGlzIHJvdXRlLCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSByZXF1ZXN0IHRoYXQgdHJpZ2dlcmVkIHRoZSByb3V0ZS4KICAgKiBAcmV0dXJucyB7RGF2aXMuUm91dGV9IHRoZSByb3V0ZSB0aGF0IGhhcyBqdXN0IGJlZW4gY3JlYXRlZCBhbmQgYWRkZWQgdG8gdGhlIHJvdXRlIGxpc3QuCiAgICogQHNlZSBEYXZpcy5yb3V0ZXIucm91dGUKICAgKiBAbWVtYmVyT2Ygcm91dGVyCiAgICovCiAgdGhpcy5wdXQgID0gdGhpcy5yb3V0ZSgncHV0JykKCiAgLyoqCiAgICogQSBjb252aW5pZW5jZSB3cmFwcGVyIGFyb3VuZCBgYXBwLnJvdXRlYCBmb3IgY3JlYXRpbmcgZGVsZXRlIHJvdXRlcy4KICAgKgogICAqIGRlbGV0ZSBpcyBhIHJlc2VydmVkIHdvcmQgaW4gamF2YXNjcmlwdCBzbyB1c2UgdGhlIGBkZWxgIG1ldGhvZCB3aGVuIGNyZWF0aW5nIGEgRGF2aXMuUm91dGUgd2l0aCBhIG1ldGhvZCBvZiBkZWxldGUuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgcGF0aCBmb3IgdGhpcyByb3V0ZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBoYW5kbGVyIGZvciB0aGlzIHJvdXRlLCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSByZXF1ZXN0IHRoYXQgdHJpZ2dlcmVkIHRoZSByb3V0ZS4KICAgKiBAcmV0dXJucyB7RGF2aXMuUm91dGV9IHRoZSByb3V0ZSB0aGF0IGhhcyBqdXN0IGJlZW4gY3JlYXRlZCBhbmQgYWRkZWQgdG8gdGhlIHJvdXRlIGxpc3QuCiAgICogQHNlZSBEYXZpcy5yb3V0ZXIucm91dGUKICAgKiBAbWVtYmVyT2Ygcm91dGVyCiAgICovCiAgdGhpcy5kZWwgID0gdGhpcy5yb3V0ZSgnZGVsZXRlJykKCiAgLyoqCiAgICogQWRkcyBhIHN0YXRlIHJvdXRlIGludG8gdGhlIGFwcHMgcm91dGUgY29sbGVjdGlvbi4KICAgKgogICAqIFRoZXNlIHNwZWNpYWwga2luZCBvZiByb3V0ZXMgYXJlIG5vdCB0cmlnZ2VyZWQgYnkgY2xpY2tpbmcgbGlua3Mgb3Igc3VibWl0dGluZyBmb3JtcywgaW5zdGVhZCB0aGV5CiAgICogYXJlIHRyaWdnZXJlZCBtYW51YWxseSBieSBjYWxsaW5nIGB0cmFuc2AuCiAgICoKICAgKiBSb3V0ZXMgYWRkZWQgdXNpbmcgdGhlIHN0YXRlIG1ldGhvZCBhY3QgaW4gdGhlIHNhbWUgd2F5IGFzIG90aGVyIHJvdXRlcyBleGNlcHQgdGhhdCB0aGV5IGdlbmVyYXRlCiAgICogYSByb3V0ZSB0aGF0IGlzIGxpc3RlbmluZyBmb3IgcmVxdWVzdHMgdGhhdCB3aWxsIG5vdCBjaGFuZ2UgdGhlIHBhZ2UgbG9jYXRpb24uCiAgICoKICAgKiBFeGFtcGxlOgogICAqCiAgICogICAgIGFwcC5zdGF0ZSgnL2Zvby86aWQnLCBmdW5jdGlvbiAocmVxKSB7CiAgICogICAgICAgLy8gd2lsbCBydW4gd2hlbiB0aGUgYXBwIHRyYW5zaXRpb25zIGludG8gdGhlICcvZm9vLzppZCcgc3RhdGUuCiAgICogICAgIH0pCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgcGF0aCBmb3IgdGhpcyByb3V0ZSwgdGhpcyB3aWxsIG5ldmVyIGJlIHNlZW4gaW4gdGhlIHVybCBiYXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaGFuZGxlciBUaGUgaGFuZGxlciBmb3IgdGhpcyByb3V0ZSwgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgcmVxdWVzdCB0aGF0IHRyaWdnZXJlZCB0aGUgcm91dGUKICAgKiBAbWVtYmVyT2Ygcm91dGVyCiAgICoKICAgKi8KICB0aGlzLnN0YXRlID0gdGhpcy5yb3V0ZSgnc3RhdGUnKTsKCiAgLyoqCiAgICogTW9kaWZpZXMgdGhlIHNjb3BlIG9mIHRoZSByb3V0ZXIuCiAgICoKICAgKiBJZiB5b3UgaGF2ZSBtYW55IHJvdXRlcyB0aGF0IHNoYXJlIGEgY29tbW9uIHBhdGggcHJlZml4IHlvdSBjYW4gdXNlIHNjb3BlIHRvIHJlZHVjZSByZXBlYXRpbmcKICAgKiB0aGF0IHBhdGggcHJlZml4LgogICAqCiAgICogWW91IGNhbiB1c2UgYHNjb3BlYCBpbiB0d28gd2F5cywgZmlyc3RseSB5b3UgY2FuIHNldCB0aGUgc2NvcGUgZm9yIHRoZSB3aG9sZSBhcHAgYnkgY2FsbGluZyBzY29wZQogICAqIGJlZm9yZSBkZWZpbmluZyByb3V0ZXMuICBZb3UgY2FuIGFsc28gcHJvdmlkZSBhIGZ1bmN0aW9uIHRvIHRoZSBzY29wZSBtZXRob2QsIGFuZCB0aGUgc2NvcGUgd2lsbAogICAqIG9ubHkgYXBwbHkgdG8gdGhvc2Ugcm91dGVzIGRlZmluZWQgd2l0aGluIHRoaXMgZnVuY3Rpb24uIEl0IGlzICBhbHNvIHBvc3NpYmxlIHRvIG5lc3Qgc2NvcGVzIHdpdGhpbgogICAqIG90aGVyIHNjb3Blcy4KICAgKgogICAqIEV4YW1wbGUKICAgKgogICAqICAgICAvLyB1c2luZyBzY29wZSB3aXRoIGEgZnVuY3Rpb24KICAgKiAgICAgYXBwLnNjb3BlKCcvZm9vJywgZnVuY3Rpb24gKCkgewogICAqICAgICAgIHRoaXMuZ2V0KCcvYmFyJywgZnVuY3Rpb24gKHJlcSkgewogICAqICAgICAgICAgLy8gdGhpcyByb3V0ZSB3aWxsIGhhdmUgYSBwYXRoIG9mICcvZm9vL2JhcicKICAgKiAgICAgICB9KQogICAqICAgICB9KQogICAqCiAgICogICAgIC8vIHNldHRpbmcgYSBnbG9iYWwgc2NvcGUgZm9yIHRoZSByZXN0IG9mIHRoZSBhcHBsaWNhdGlvbgogICAqICAgICBhcHAuc2NvcGUoJy9iYXInKQogICAqCiAgICogICAgIC8vIHVzaW5nIHNjb3BlIHdpdGggYSBmdW5jdGlvbgogICAqICAgICBhcHAuc2NvcGUoJy9mb28nLCBmdW5jdGlvbiAoKSB7CiAgICogICAgICAgdGhpcy5zY29wZSgnL2JhcicsIGZ1bmN0aW9uICgpIHsKICAgKiAgICAgICAgIHRoaXMuZ2V0KCcvYmF6JywgZnVuY3Rpb24gKHJlcSkgewogICAqICAgICAgICAgICAvLyB0aGlzIHJvdXRlIHdpbGwgaGF2ZSBhIHBhdGggb2YgJy9mb28vYmFyL2JheicKICAgKiAgICAgICAgIH0pCiAgICogICAgICAgfSkKICAgKiAgICAgfSkKICAgKgogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgcHJlZml4IHRvIHVzZSBhcyB0aGUgc2NvcGUKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBBIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCB3aXRoIHRoZSByb3V0ZXIgYXMgaXRzIGNvbnRleHQgYW5kIHRoZSBwYXRoCiAgICogYXMgYSBwcmVmaXgKICAgKgogICAqLwogIHRoaXMuc2NvcGUgPSBmdW5jdGlvbiAocGF0aCwgZm4pIHsKICAgIHNjb3BlUGF0aHMucHVzaChwYXRoKQogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgcmV0dXJuCgogICAgZm4uY2FsbCh0aGlzLCB0aGlzKQogICAgc2NvcGVQYXRocy5wb3AoKQogIH0KCiAgLyoqCiAgICogVHJhbnNpdGlvbnMgdGhlIGFwcCBpbnRvIHRoZSBzdGF0ZSBpZGVudGlmaWVkIGJ5IHRoZSBwYXNzZWQgcGF0aCBwYXJhbWV0ZXIuCiAgICoKICAgKiBUaGlzIGFsbG93cyB0aGUgYXBwIHRvIGVudGVyIHN0YXRlcyB3aXRob3V0IGNoYW5naW5nIHRoZSBwYWdlIHBhdGggdGhyb3VnaCBhIGxpbmsgY2xpY2sgb3IgZm9ybSBzdWJtaXQuIAogICAqIElmIHRoZXJlIGFyZSBoYW5kbGVycyByZWdpc3RlcmVkIGZvciB0aGlzIHN0YXRlLCBhZGRlZCBieSB0aGUgYHN0YXRlYCBtZXRob2QsIHRoZXkgd2lsbCBiZSB0cmlnZ2VyZWQuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBnZW5lcmF0ZXMgYSByZXF1ZXN0IHdpdGggYSBtZXRob2Qgb2YgJ3N0YXRlJywgaW4gYWxsIG90aGVyIHdheXMgdGhpcyByZXF1ZXN0IGlzIGlkZW50aWNhbAogICAqIHRvIHRob3NlIHRoYXQgYXJlIGdlbmVyYXRlZCB3aGVuIGNsaWNraW5nIGxpbmtzIGV0Yy4KICAgKgogICAqIFN0YXRlcyB0cmFuc2l0aW9uZWQgdG8gdXNpbmcgdGhpcyBtZXRob2Qgd2lsbCBub3QgYmUgYWJsZSB0byBiZSByZXZpc2l0ZWQgZGlyZWN0bHkgd2l0aCBhIHBhZ2UgbG9hZCBhcwogICAqIHRoZXJlIGlzIG5vIHVybCB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlLgogICAqCiAgICogQW4gb3B0aW9uYWwgc2Vjb25kIHBhcmFtZXRlciBjYW4gYmUgcGFzc2VkIHdoaWNoIHdpbGwgYmUgYXZhaWxhYmxlIHRvIGFueSBoYW5kbGVycyBpbiB0aGUgcmVxdWVzdHMKICAgKiBwYXJhbXMgb2JqZWN0LgogICAqCiAgICogRXhhbXBsZQogICAqCiAgICogICAgIGFwcC50cmFucygnL2Zvby8xJykKICAgKiAgICAgCiAgICogICAgIGFwcC50cmFucygnL2Zvby8xJywgewogICAqICAgICAgICJiYXIiOiAiYmF6IgogICAqICAgICB9KQogICAqICAgICAKICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwYXRoIHRoYXQgcmVwcmVzZW50cyB0aGlzIHN0YXRlLiAgVGhpcyB3aWxsIG5vdCBiZSBzZWVuIGluIHRoZSB1cmwgYmFyLgogICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIEFueSBhZGRpdGlvbmFsIGRhdGEgdGhhdCBzaG91bGQgYmUgc2VudCB3aXRoIHRoZSByZXF1ZXN0IGFzIHBhcmFtcy4KICAgKiBAbWVtYmVyT2Ygcm91dGVyCiAgICovCiAgdGhpcy50cmFucyA9IGZ1bmN0aW9uIChwYXRoLCBkYXRhKSB7CiAgICBpZiAoZGF0YSkgewogICAgICB2YXIgZnVsbFBhdGggPSBbcGF0aCwgZGVjb2RlVVJJQ29tcG9uZW50KERhdmlzLiQucGFyYW0oZGF0YSkpXS5qb2luKCc/JykKICAgIH0gZWxzZSB7CiAgICAgIHZhciBmdWxsUGF0aCA9IHBhdGgKICAgIH07CgogICAgdmFyIHJlcSA9IG5ldyBEYXZpcy5SZXF1ZXN0KHsKICAgICAgbWV0aG9kOiAnc3RhdGUnLAogICAgICBmdWxsUGF0aDogZnVsbFBhdGgsCiAgICAgIHRpdGxlOiAnJwogICAgfSkKCiAgICBEYXZpcy5sb2NhdGlvbi5hc3NpZ24ocmVxKQogIH0KCiAgLyohCiAgICogR2VuZXJhdGluZyBjb252aW5pZW5jZSBtZXRob2RzIGZvciBjcmVhdGluZyBmaWx0ZXJzIHVzaW5nIERhdmlzLlJvdXRlcyBhbmQgbWV0aG9kcyB0bwogICAqIGxvb2t1cCBmaWx0ZXJzLgogICAqLwogIHRoaXMuZmlsdGVyID0gZnVuY3Rpb24gKGZpbHRlck5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBtZXRob2QgPSAvLisvOwoKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICAgIHZhciBwYXRoID0gLy4rLzsKICAgICAgICB2YXIgaGFuZGxlciA9IGFyZ3VtZW50c1swXTsKICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDIpIHsKICAgICAgICB2YXIgcGF0aCA9IGFyZ3VtZW50c1swXTsKICAgICAgICB2YXIgaGFuZGxlciA9IGFyZ3VtZW50c1sxXTsKICAgICAgfTsKCiAgICAgIHZhciByb3V0ZSA9IG5ldyBEYXZpcy5Sb3V0ZSAobWV0aG9kLCBwYXRoLCBoYW5kbGVyKQogICAgICBmaWx0ZXJDb2xsZWN0aW9uW2ZpbHRlck5hbWVdLnB1c2gocm91dGUpOwogICAgICByZXR1cm4gcm91dGUKICAgIH0KICB9CgogIHRoaXMubG9va3VwRmlsdGVyID0gZnVuY3Rpb24gKGZpbHRlclR5cGUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAobWV0aG9kLCBwYXRoKSB7CiAgICAgIHJldHVybiBEYXZpcy51dGlscy5maWx0ZXIoZmlsdGVyQ29sbGVjdGlvbltmaWx0ZXJUeXBlXSwgZnVuY3Rpb24gKHJvdXRlKSB7CiAgICAgICAgcmV0dXJuIHJvdXRlLm1hdGNoKG1ldGhvZCwgcGF0aCkKICAgICAgfSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBBIGNvbnZpbmllbmNlIHdyYXBwZXIgYXJvdW5kIGBhcHAuZmlsdGVyYCBmb3IgY3JlYXRpbmcgYmVmb3JlIGZpbHRlcnMuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgb3B0aW9ubCBwYXRoIGZvciB0aGlzIGZpbHRlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBoYW5kbGVyIGZvciB0aGlzIGZpbHRlciwgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgcmVxdWVzdCB0aGF0IHRyaWdnZXJlZCB0aGUgcm91dGUuCiAgICogQHJldHVybnMge0RhdmlzLlJvdXRlfSB0aGUgcm91dGUgdGhhdCBoYXMganVzdCBiZWVuIGNyZWF0ZWQgYW5kIGFkZGVkIHRvIHRoZSByb3V0ZSBsaXN0LgogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKi8KICB0aGlzLmJlZm9yZSA9IHRoaXMuZmlsdGVyKCdiZWZvcmUnKQoKICAvKioKICAgKiBBIGNvbnZpbmllbmNlIHdyYXBwZXIgYXJvdW5kIGBhcHAuZmlsdGVyYCBmb3IgY3JlYXRpbmcgYWZ0ZXIgZmlsdGVycy4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBvcHRpb25sIHBhdGggZm9yIHRoaXMgZmlsdGVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIGhhbmRsZXIgZm9yIHRoaXMgZmlsdGVyLCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSByZXF1ZXN0IHRoYXQgdHJpZ2dlcmVkIHRoZSByb3V0ZS4KICAgKiBAcmV0dXJucyB7RGF2aXMuUm91dGV9IHRoZSByb3V0ZSB0aGF0IGhhcyBqdXN0IGJlZW4gY3JlYXRlZCBhbmQgYWRkZWQgdG8gdGhlIHJvdXRlIGxpc3QuCiAgICogQG1lbWJlck9mIHJvdXRlcgogICAqLwogIHRoaXMuYWZ0ZXIgPSB0aGlzLmZpbHRlcignYWZ0ZXInKQoKICAvKioKICAgKiBBIGNvbnZpbmllbmNlIHdyYXBwZXIgYXJvdW5kIGBhcHAubG9va3VwRmlsdGVyYCBmb3IgbG9va2luZyB1cCBiZWZvcmUgZmlsdGVycy4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBvcHRpb25sIHBhdGggZm9yIHRoaXMgZmlsdGVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIGhhbmRsZXIgZm9yIHRoaXMgZmlsdGVyLCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSByZXF1ZXN0IHRoYXQgdHJpZ2dlcmVkIHRoZSByb3V0ZS4KICAgKiBAcmV0dXJucyB7RGF2aXMuUm91dGV9IHRoZSByb3V0ZSB0aGF0IGhhcyBqdXN0IGJlZW4gY3JlYXRlZCBhbmQgYWRkZWQgdG8gdGhlIHJvdXRlIGxpc3QuCiAgICogQG1lbWJlck9mIHJvdXRlcgogICAqLwogIHRoaXMubG9va3VwQmVmb3JlRmlsdGVyID0gdGhpcy5sb29rdXBGaWx0ZXIoJ2JlZm9yZScpCgogIC8qKgogICAqIEEgY29udmluaWVuY2Ugd3JhcHBlciBhcm91bmQgYGFwcC5sb29rdXBGaWx0ZXJgIGZvciBsb29raW5nIHVwIGFmdGVyIGZpbHRlcnMuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgb3B0aW9ubCBwYXRoIGZvciB0aGlzIGZpbHRlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBoYW5kbGVyIGZvciB0aGlzIGZpbHRlciwgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgcmVxdWVzdCB0aGF0IHRyaWdnZXJlZCB0aGUgcm91dGUuCiAgICogQHJldHVybnMge0RhdmlzLlJvdXRlfSB0aGUgcm91dGUgdGhhdCBoYXMganVzdCBiZWVuIGNyZWF0ZWQgYW5kIGFkZGVkIHRvIHRoZSByb3V0ZSBsaXN0LgogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKi8KICB0aGlzLmxvb2t1cEFmdGVyRmlsdGVyICA9IHRoaXMubG9va3VwRmlsdGVyKCdhZnRlcicpCgogIC8qIQogICAqIGNvbGxlY3Rpb25zIG9mIHJvdXRlcyBhbmQgZmlsdGVycwogICAqIEBwcml2YXRlCiAgICovCiAgdmFyIHJvdXRlQ29sbGVjdGlvbiA9IFtdOwogIHZhciBmaWx0ZXJDb2xsZWN0aW9uID0gewogICAgYmVmb3JlOiBbXSwKICAgIGFmdGVyOiBbXQogIH07CiAgdmFyIHNjb3BlUGF0aHMgPSBbXQoKICAvKioKICAgKiBMb29rcyBmb3IgdGhlIGZpcnN0IHJvdXRlIHRoYXQgbWF0Y2hlcyB0aGUgbWV0aG9kIGFuZCBwYXRoIGZyb20gYSByZXF1ZXN0LgogICAqIFdpbGwgb25seSBmaW5kIGFuZCByZXR1cm4gdGhlIGZpcnN0IG1hdGNoZWQgcm91dGUuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gbWV0aG9kIHRoZSBtZXRob2QgdG8gdXNlIHdoZW4gbG9va2luZyB1cCBhIHJvdXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGggdGhlIHBhdGggdG8gdXNlIHdoZW4gbG9va2luZyB1cCBhIHJvdXRlCiAgICogQHJldHVybnMge0RhdmlzLlJvdXRlfSByb3V0ZQogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKi8KICB0aGlzLmxvb2t1cFJvdXRlID0gZnVuY3Rpb24gKG1ldGhvZCwgcGF0aCkgewogICAgcmV0dXJuIERhdmlzLnV0aWxzLmZpbHRlcihyb3V0ZUNvbGxlY3Rpb24sIGZ1bmN0aW9uIChyb3V0ZSkgewogICAgICByZXR1cm4gcm91dGUubWF0Y2gobWV0aG9kLCBwYXRoKQogICAgfSlbMF07CiAgfTsKfQovKiEKICogRGF2aXMgLSBoaXN0b3J5CiAqIENvcHlyaWdodCAoQykgMjAxMSBPbGl2ZXIgTmlnaHRpbmdhbGUKICogTUlUIExpY2Vuc2VkCiAqLwoKLyoqCiAqIEEgbW9kdWxlIHRvIG5vcm1hbGl6ZSBhbmQgZW5oYW5jZSB0aGUgd2luZG93LnB1c2hTdGF0ZSBtZXRob2QgYW5kIHdpbmRvdy5vbnBvcHN0YXRlIGV2ZW50LgogKgogKiBBZGRzIHRoZSBhYmlsaXR5IHRvIGJpbmQgdG8gd2hlbmV2ZXIgYSBuZXcgc3RhdGUgaXMgcHVzaGVkIG9udG8gdGhlIGhpc3Rvcnkgc3RhY2sgYW5kIG5vcm1hbGl6ZXMKICogYm90aCBvZiB0aGVzZSBldmVudHMgaW50byBhbiBvbkNoYW5nZSBldmVudC4KICoKICogQG1vZHVsZQogKi8KRGF2aXMuaGlzdG9yeSA9IChmdW5jdGlvbiAoKSB7CgogIC8qIQogICAqIHN0b3JhZ2UgZm9yIHRoZSBwdXNoIHN0YXRlIGhhbmRsZXJzCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgcHVzaFN0YXRlSGFuZGxlcnMgPSBbXTsKCiAgLyohCiAgICoga2VlcCB0cmFjayBvZiB3aGV0aGVyIG9yIG5vdCB3ZWJraXQgbGlrZSBicm93c2VycyBoYXZlIGZpcmVkIHRoZWlyIGluaXRpYWwKICAgKiBwYWdlIGxvYWQgcG9wc3RhdGUKICAgKiBAcHJpdmF0ZQogICAqLwogIHZhciBwb3BwZWQgPSBmYWxzZQoKICAvKiEKICAgKiBtZXRob2QgdG8gY2hlY2sgd2hldGhlciBvciBub3QgdGhpcyBpcyB0aGUgZmlyc3QgcG9wIHN0YXRlIGV2ZW50IHJlY2VpdmVkCiAgICogQHByaXZhdGUKICAgKi8KICAgZnVuY3Rpb24gaGFzUG9wcGVkICgpIHsKICAgICByZXR1cm4gISF3aW5kb3cuaGlzdG9yeS5zdGF0ZSB8fCBwb3BwZWQKICAgfQoKICAvKiEKICAgKiBBZGQgYSBoYW5kbGVyIHRvIHRoZSBwdXNoIHN0YXRlIGV2ZW50LiAgVGhpcyBldmVudCBpcyBub3QgYSBuYXRpdmUgZXZlbnQgYnV0IGlzIGZpcmVkCiAgICogZXZlcnkgdGltZSBhIGNhbGwgdG8gcHVzaFN0YXRlIGlzIGNhbGxlZC4KICAgKiAKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBvblB1c2hTdGF0ZShoYW5kbGVyKSB7CiAgICBwdXNoU3RhdGVIYW5kbGVycy5wdXNoKGhhbmRsZXIpOwogIH07CgogIC8qIQogICAqIFNpbXBsZSB3cmFwcGVyIGZvciB0aGUgbmF0aXZlIG9ucG9wc3RhdGUgZXZlbnQuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBvblBvcFN0YXRlKGhhbmRsZXIpIHsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIGhhbmRsZXIsIHRydWUpOwogIH07CgogIC8qIQogICAqIHJldHVybnMgYSBoYW5kbGVyIHRoYXQgd3JhcHMgdGhlIG5hdGl2ZSBldmVudCBnaXZlbiBvbnBvcHN0YXRlLgogICAqIFdoZW4gdGhlIHBhZ2UgZmlyc3QgbG9hZHMgb3IgZ29pbmcgYmFjayB0byBhIHRpbWUgaW4gdGhlIGhpc3RvcnkgdGhhdCB3YXMgbm90IGFkZGVkCiAgICogYnkgcHVzaFN0YXRlIHRoZSBldmVudC5zdGF0ZSBvYmplY3Qgd2lsbCBiZSBudWxsLiAgVGhpcyBnZW5lcmF0ZXMgYSByZXF1ZXN0IGZvciB0aGUgY3VycmVudAogICAqIGxvY2F0aW9uIGluIHRob3NlIGNhc2VzCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiB3cmFwcGVkKGhhbmRsZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgaWYgKGV2ZW50LnN0YXRlICYmIGV2ZW50LnN0YXRlLl9kYXZpcykgewogICAgICAgIGhhbmRsZXIobmV3IERhdmlzLlJlcXVlc3QoZXZlbnQuc3RhdGUuX2RhdmlzKSkKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaGFzUG9wcGVkKCkpIGhhbmRsZXIoRGF2aXMuUmVxdWVzdC5mb3JQYWdlTG9hZCgpKQogICAgICB9OwogICAgICBwb3BwZWQgPSB0cnVlCiAgICB9CiAgfQoKICAvKiEKICAgKiBwcm92aWRlIGEgd3JhcHBlciBmb3IgYW55IGRhdGEgdGhhdCBpcyBnb2luZyB0byBiZSBwdXNoZWQgaW50byB0aGUgaGlzdG9yeSBzdGFjay4gIEFsbAogICAqIGRhdGEgaXMgd3JhcHBlZCBpbiBhICJfZGF2aXMiIG5hbWVzcGFjZS4KICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHdyYXBTdGF0ZURhdGEoZGF0YSkgewogICAgcmV0dXJuIHsiX2RhdmlzIjogZGF0YX0KICB9CgogIC8qKgogICAqIEJpbmQgdG8gdGhlIGhpc3Rvcnkgb24gY2hhbmdlIGV2ZW50LgogICAqCiAgICogVGhpcyBpcyBub3QgYSBuYXRpdmUgZXZlbnQgYnV0IGlzIGZpcmVkIGFueSB0aW1lIGEgbmV3IHN0YXRlIGlzIHB1c2hlZCBvbnRvIHRoZSBoaXN0b3J5IHN0YWNrLAogICAqIHRoZSBjdXJyZW50IGhpc3RvcnkgaXMgcmVwbGFjZWQgb3IgYSBzdGF0ZSBpcyBwb3BwZWQgb2ZmIHRoZSBoaXN0b3J5IHN0YWNrLgogICAqIFRoZSBoYW5kbGVyIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdpdGggYSByZXF1ZXN0IHBhcmFtIHdoaWNoIGlzIGFuIGluc3RhbmNlIG9mIERhdmlzLlJlcXVlc3QuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBvbiBwdXNoIGFuZCBwb3Agc3RhdGUuCiAgICogQHNlZSBEYXZpcy5SZXF1ZXN0CiAgICogQG1lbWJlck9mIGhpc3RvcnkKICAgKi8KICBmdW5jdGlvbiBvbkNoYW5nZShoYW5kbGVyKSB7CiAgICBvblB1c2hTdGF0ZShoYW5kbGVyKTsKICAgIG9uUG9wU3RhdGUod3JhcHBlZChoYW5kbGVyKSk7CiAgfTsKCiAgLyohCiAgICogcmV0dXJucyBhIGZ1bmN0aW9uIGZvciBtYW5pcHVsYXRpbmcgdGhlIGhpc3Rvcnkgc3RhdGUgYW5kIG9wdGlvbmFsbHkgY2FsbGluZyBhbnkgYXNzb2NpYXRlZAogICAqIHB1c2hTdGF0ZUhhbmRsZXJzCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gbWV0aG9kTmFtZSB0aGUgbmFtZSBvZiB0aGUgbWV0aG9kIHRvIG1hbmlwdWxhdGUgdGhlIGhpc3Rvcnkgc3RhdGUgd2l0aC4KICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGNoYW5nZVN0YXRlV2l0aCAobWV0aG9kTmFtZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uIChyZXF1ZXN0LCBvcHRzKSB7CiAgICAgIGhpc3RvcnlbbWV0aG9kTmFtZV0od3JhcFN0YXRlRGF0YShyZXF1ZXN0LnRvSlNPTigpKSwgcmVxdWVzdC50aXRsZSwgcmVxdWVzdC5sb2NhdGlvbigpKTsKICAgICAgaWYgKG9wdHMgJiYgb3B0cy5zaWxlbnQpIHJldHVybgogICAgICBEYXZpcy51dGlscy5mb3JFYWNoKHB1c2hTdGF0ZUhhbmRsZXJzLCBmdW5jdGlvbiAoaGFuZGxlcikgewogICAgICAgIGhhbmRsZXIocmVxdWVzdCk7CiAgICAgIH0pOwogICAgfQogIH0KCiAgLyoqCiAgICogUHVzaGVzIGEgcmVxdWVzdCBvbnRvIHRoZSBoaXN0b3J5IHN0YWNrLgogICAqCiAgICogVGhpcyBpcyB1c2VkIGludGVybmFsbHkgYnkgRGF2aXMgdG8gcHVzaCBhIG5ldyByZXF1ZXN0CiAgICogcmVzdWx0aW5nIGZyb20gZWl0aGVyIGEgZm9ybSBzdWJtaXQgb3IgYSBsaW5rIGNsaWNrIG9udG8gdGhlIGhpc3Rvcnkgc3RhY2ssIGl0IHdpbGwgYWxzbyB0cmlnZ2VyCiAgICogdGhlIG9ucHVzaHN0YXRlIGV2ZW50LgogICAqCiAgICogQW4gaW5zdGFuY2Ugb2YgRGF2aXMuUmVxdWVzdCBpcyBleHBlY3RlZCB0byBiZSBwYXNzZWQsIGhvd2V2ZXIgYW55IG9iamVjdCB0aGF0IGhhcyBhIHRpdGxlCiAgICogYW5kIGEgcGF0aCBwcm9wZXJ0eSB3aWxsIGFsc28gYmUgYWNjZXB0ZWQuCiAgICoKICAgKiBAcGFyYW0ge0RhdmlzLlJlcXVlc3R9IHJlcXVlc3QgdGhlIGxvY2F0aW9uIHRvIGJlIGFzc2luZ2VkIGFzIHRoZSBjdXJyZW50IGxvY2F0aW9uLgogICAqIEBtZW1iZXJPZiBoaXN0b3J5CiAgICovCiAgdmFyIGFzc2lnbiA9IGNoYW5nZVN0YXRlV2l0aCgncHVzaFN0YXRlJykKCiAgLyoqCiAgICogUmVwbGFjZSB0aGUgY3VycmVudCBzdGF0ZSBvbiB0aGUgaGlzdG9yeSBzdGFjay4KICAgKgogICAqIFRoaXMgaXMgdXNlZCBpbnRlcm5hbGx5IGJ5IERhdmlzIHdoZW4gcGVyZm9ybWluZyBhIHJlZGlyZWN0LiAgVGhpcyB3aWxsIHRyaWdnZXIgYW4gb25wdXNoc3RhdGUgZXZlbnQuCiAgICoKICAgKiBBbiBpbnN0YW5jZSBvZiBEYXZpcy5SZXF1ZXN0IGlzIGV4cGVjdGVkIHRvIGJlIHBhc3NlZCwgaG93ZXZlciBhbnkgb2JqZWN0IHRoYXQgaGFzIGEgdGl0bGUKICAgKiBhbmQgYSBwYXRoIHByb3BlcnR5IHdpbGwgYWxzbyBiZSBhY2NlcHRlZC4KICAgKgogICAqIEBwYXJhbSB7RGF2aXMuUmVxdWVzdH0gcmVxdWVzdCB0aGUgbG9jYXRpb24gdG8gcmVwbGFjZSB0aGUgY3VycmVudCBsb2NhdGlvbiB3aXRoLgogICAqIEBtZW1iZXJPZiBoaXN0b3J5CiAgICovCiAgdmFyIHJlcGxhY2UgPSBjaGFuZ2VTdGF0ZVdpdGgoJ3JlcGxhY2VTdGF0ZScpCgogIC8qKgogICAqIFJldHVybnMgdGhlIGN1cnJlbnQgbG9jYXRpb24gZm9yIHRoZSBhcHBsaWNhdGlvbi4KICAgKgogICAqIERhdmlzLmxvY2F0aW9uIGRlbGVnYXRlcyB0byB0aGlzIG1ldGhvZCBmb3IgZ2V0dGluZyB0aGUgYXBwcyBjdXJyZW50IGxvY2F0aW9uLgogICAqCiAgICogQG1lbWJlck9mIGhpc3RvcnkKICAgKi8KICBmdW5jdGlvbiBjdXJyZW50KCkgewogICAgcmV0dXJuIHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSArICh3aW5kb3cubG9jYXRpb24uc2VhcmNoID8gd2luZG93LmxvY2F0aW9uLnNlYXJjaCA6ICcnKQogIH0KCiAgLyohCiAgICogRXhwb3NpbmcgdGhlIHB1YmxpYyBtZXRob2RzIG9mIHRoaXMgbW9kdWxlCiAgICogQHByaXZhdGUKICAgKi8KICByZXR1cm4gewogICAgb25DaGFuZ2U6IG9uQ2hhbmdlLAogICAgY3VycmVudDogY3VycmVudCwKICAgIGFzc2lnbjogYXNzaWduLAogICAgcmVwbGFjZTogcmVwbGFjZQogIH0KfSkoKQovKiEKICogRGF2aXMgLSBsb2NhdGlvbgogKiBDb3B5cmlnaHQgKEMpIDIwMTEgT2xpdmVyIE5pZ2h0aW5nYWxlCiAqIE1JVCBMaWNlbnNlZAogKi8KCi8qKgogKiBBIG1vZHVsZSB0aGF0IGFjdHMgYXMgYSBkZWxlZ2F0b3IgdG8gYW55IGxvY2F0aW9uRGVsZWdhdGUgaW1wbGVtZW50YXRpb24uICBUaGlzIGFic3RyYWN0cyB0aGUgZGV0YWlscyBvZgogKiB3aGF0IGlzIGJlaW5nIHVzZWQgZm9yIHRoZSBhcHBzIHJvdXRpbmcgYXdheSBmcm9tIHRoZSByZXN0IG9mIHRoZSBsaWJyYXJ5LiAgVGhpcyBhbGxvd3MgYW55IGtpbmQgb2Ygcm91dGluZwogKiBUbyBiZSB1c2VkIHdpdGggRGF2aXMgYXMgbG9uZyBhcyBpdCBjYW4gcmVzcG9uZCBhcHByb3ByaWF0bHkgdG8gdGhlIGdpdmVuIGRlbGVnYXRlIG1ldGhvZHMuCiAqCiAqIEEgcm91dGluZyBtb2R1bGUgbXVzdCByZXNwb25kIHRvIHRoZSBmb2xsb3dpbmcgbWV0aG9kcwogKgogKiAgKiBfX2N1cnJlbnRfXyA6IFNob3VsZCByZXR1cm4gdGhlIGN1cnJlbnQgbG9jYXRpb24gZm9yIHRoZSBhcHAKICogICogX19hc3NpZ25fXyA6IFNob3VsZCBzZXQgdGhlIGN1cnJlbnQgbG9jYXRpb24gb2YgdGhlIGFwcCBiYXNlZCBvbiB0aGUgbG9jYXRpb24gb2YgdGhlIHBhc3NlZCByZXF1ZXN0LgogKiAgKiBfX3JlcGxhY2VfXyA6IFNob3VsZCBhdCBsZWFzdCBjaGFuZ2UgdGhlIGN1cnJlbnQgbG9jYXRpb24gdG8gdGhlIGxvY2F0aW9uIG9mIHRoZSBwYXNzZWQgcmVxdWVzdCwgZm9yIGZ1bGwgY29tcGF0aWJpbGl0eSBpdCBzaG91bGQgbm90IGFkZCBhbnkgZXh0cmEgaXRlbXMgaW4gdGhlIGhpc3Rvcnkgc3RhY2suCiAqICAqIF9fb25DaGFuZ2VfXyA6IFNob3VsZCBhZGQgY2FsYmFja3MgdGhhdCB3aWxsIGJlIGZpcmVkIHdoZW5ldmVyIHRoZSBsb2NhdGlvbiBpcyBjaGFuZ2VkLgogKgogKiBAbW9kdWxlCiAqCiAqLwpEYXZpcy5sb2NhdGlvbiA9IChmdW5jdGlvbiAoKSB7CgogIC8qIQogICAqIEJ5IGRlZmF1bHQgdGhlIERhdmlzIHVzZXMgdGhlIERhdmlzLmhpc3RvcnkgbW9kdWxlIGZvciBpdHMgcm91dGluZywgdGhpcyBnaXZlcyBIVE1MNSBiYXNlZCBwdXNoU3RhdGUgcm91dGluZwogICAqIHdoaWNoIGlzIHByZWZlcnJhYmxlIG92ZXIgbG9jYXRpb24uaGFzaCBiYXNlZCByb3V0aW5nLgogICAqLwogIHZhciBsb2NhdGlvbkRlbGVnYXRlID0gRGF2aXMuaGlzdG9yeQoKICAvKioKICAgKiBTZXRzIHRoZSBjdXJyZW50IGxvY2F0aW9uIGRlbGVnYXRlLgogICAqCiAgICogVGhlIHBhc3NlZCBkZWxlZ2F0ZSB3aWxsIGJlIHVzZWQgZm9yIGFsbCBEYXZpcyBhcHBzLiAgVGhlIGRlbGVnYXRlCiAgICogbXVzdCByZXNwb25kIHRvIHRoZSBmb2xsb3dpbmcgZm91ciBtZXRob2RzIGBjdXJyZW50YCwgYGFzc2lnbmAsIGByZXBsYWNlYCAmIGBvbkNoYW5nZWAuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gdGhlIGxvY2F0aW9uIGRlbGVnYXRlIHRvIHVzZS4KICAgKiBAbWVtYmVyT2YgbG9jYXRpb24KICAgKi8KICBmdW5jdGlvbiBzZXRMb2NhdGlvbkRlbGVnYXRlKGRlbGVnYXRlKSB7CiAgICBsb2NhdGlvbkRlbGVnYXRlID0gZGVsZWdhdGUKICB9CgogIC8qKgogICAqIERlbGVnYXRlcyB0byB0aGUgbG9jYXRpb25EZWxlZ2F0ZS5jdXJyZW50IG1ldGhvZC4KICAgKgogICAqIFRoaXMgc2hvdWxkIHJldHVybiB0aGUgY3VycmVudCBsb2NhdGlvbiBvZiB0aGUgYXBwLgogICAqCiAgICogQG1lbWJlck9mIGxvY2F0aW9uCiAgICovCiAgZnVuY3Rpb24gY3VycmVudCgpIHsKICAgIHJldHVybiBsb2NhdGlvbkRlbGVnYXRlLmN1cnJlbnQoKQogIH0KCiAgLyohCiAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHdoaWNoIHNlbmRzIHRoZSBsb2NhdGlvbiBkZWxlZ2F0ZSB0aGUgcGFzc2VkIG1lc3NhZ2UgbmFtZS4KICAgKiBJdCBoYW5kbGVzIGNvbnZlcnRpbmcgYSBzdHJpbmcgcGF0aCB0byBhbiBhY3R1YWwgcmVxdWVzdAogICAqCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBhIGZ1bmN0aW9uIHRoYXQgY2FsbHMgdGhlIGxvY2F0aW9uIGRlbGVnYXRlIHdpdGggdGhlIHN1cHBsaWVkIG1ldGhvZCBuYW1lCiAgICogQG1lbWJlck9mIGxvY2F0aW9uCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBzZW5kTG9jYXRpb25EZWxlZ2F0ZSAobWV0aG9kTmFtZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uIChyZXEpIHsKICAgICAgaWYgKHR5cGVvZiByZXEgPT0gJ3N0cmluZycpIHJlcSA9IG5ldyBEYXZpcy5SZXF1ZXN0IChyZXEpCiAgICAgIGxvY2F0aW9uRGVsZWdhdGVbbWV0aG9kTmFtZV0ocmVxKQogICAgfQogIH0KCiAgLyoqCiAgICogRGVsZWdhdGVzIHRvIHRoZSBsb2NhdGlvbkRlbGVnYXRlLmFzc2lnbiBtZXRob2QuCiAgICoKICAgKiBUaGlzIHNob3VsZCBzZXQgdGhlIGN1cnJlbnQgbG9jYXRpb24gZm9yIHRoZSBhcHAgdG8gdGhhdCBvZiB0aGUgcGFzc2VkIHJlcXVlc3Qgb2JqZWN0LgogICAqCiAgICogQ2FuIHRha2UgZWl0aGVyIGEgRGF2aXMuUmVxdWVzdCBvciBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIHBhdGggb2YgdGhlIHJlcXVlc3QgdG8gYXNzaWduLgogICAqCiAgICoKICAgKgogICAqIEBwYXJhbSB7UmVxdWVzdH0gcmVxIHRoZSByZXF1ZXN0IHRvIHJlcGxhY2UgdGhlIGN1cnJlbnQgbG9jYXRpb24gd2l0aCwgZWl0aGVyIGEgc3RyaW5nIG9yIGEgRGF2aXMuUmVxdWVzdC4KICAgKiBAc2VlIERhdmlzLlJlcXVlc3QKICAgKiBAbWVtYmVyT2YgbG9jYXRpb24KICAgKi8KICB2YXIgYXNzaWduID0gc2VuZExvY2F0aW9uRGVsZWdhdGUoJ2Fzc2lnbicpCgogIC8qKgogICAqIERlbGVnYXRlcyB0byB0aGUgbG9jYXRpb25EZWxlZ2F0ZS5yZXBsYWNlIG1ldGhvZC4KICAgKgogICAqIFRoaXMgc2hvdWxkIHJlcGxhY2UgdGhlIGN1cnJlbnQgbG9jYXRpb24gd2l0aCB0aGF0IG9mIHRoZSBwYXNzZWQgcmVxdWVzdC4KICAgKiBJZGVhbGx5IGl0IHNob3VsZCBub3QgY3JlYXRlIGEgbmV3IGVudHJ5IGluIHRoZSBicm93c2VycyBoaXN0b3J5LgogICAqCiAgICogQ2FuIHRha2UgZWl0aGVyIGEgRGF2aXMuUmVxdWVzdCBvciBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIHBhdGggb2YgdGhlIHJlcXVlc3QgdG8gYXNzaWduLgogICAqCiAgICogQHBhcmFtIHtSZXF1ZXN0fSByZXEgdGhlIHJlcXVlc3QgdG8gcmVwbGFjZSB0aGUgY3VycmVudCBsb2NhdGlvbiB3aXRoLCBlaXRoZXIgYSBzdHJpbmcgb3IgYSBEYXZpcy5SZXF1ZXN0LgogICAqIEBzZWUgRGF2aXMuUmVxdWVzdAogICAqIEBtZW1iZXJPZiBsb2NhdGlvbgogICAqLwogIHZhciByZXBsYWNlID0gc2VuZExvY2F0aW9uRGVsZWdhdGUoJ3JlcGxhY2UnKQoKICAvKioKICAgKiBEZWxlZ2F0ZXMgdG8gdGhlIGxvY2F0aW9uRGVsZWdhdGUub25DaGFuZ2UgbWV0aG9kLgogICAqCiAgICogVGhpcyBzaG91bGQgYWRkIGEgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGNhbGxlZCBhbnkgdGltZSB0aGUgbG9jYXRpb24gY2hhbmdlcy4KICAgKiBUaGUgaGFuZGxlciBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aXRoIGEgcmVxdWVzdCBwYXJhbSB3aGljaCBpcyBhbiBpbnN0YW5jZSBvZiBEYXZpcy5SZXF1ZXN0LgogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaGFuZGxlciBjYWxsYmFjayBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gbG9jYXRpb24gY2huYWdlLgogICAqIEBzZWUgRGF2aXMuUmVxdWVzdAogICAqIEBtZW1iZXJPZiBsb2NhdGlvbgogICAqCiAgICovCiAgZnVuY3Rpb24gb25DaGFuZ2UoaGFuZGxlcikgewogICAgbG9jYXRpb25EZWxlZ2F0ZS5vbkNoYW5nZShoYW5kbGVyKQogIH0KCiAgLyohCiAgICogRXhwb3NpbmcgdGhlIHB1YmxpYyBtZXRob2RzIG9mIHRoaXMgbW9kdWxlCiAgICogQHByaXZhdGUKICAgKi8KICByZXR1cm4gewogICAgc2V0TG9jYXRpb25EZWxlZ2F0ZTogc2V0TG9jYXRpb25EZWxlZ2F0ZSwKICAgIGN1cnJlbnQ6IGN1cnJlbnQsCiAgICBhc3NpZ246IGFzc2lnbiwKICAgIHJlcGxhY2U6IHJlcGxhY2UsCiAgICBvbkNoYW5nZTogb25DaGFuZ2UKICB9Cn0pKCkvKiEKICogRGF2aXMgLSBSZXF1ZXN0CiAqIENvcHlyaWdodCAoQykgMjAxMSBPbGl2ZXIgTmlnaHRpbmdhbGUKICogTUlUIExpY2Vuc2VkCiAqLwoKRGF2aXMuUmVxdWVzdCA9IChmdW5jdGlvbiAoKSB7CgovKioKICogRGF2aXMuUmVxdWVzdHMgYXJlIGNyZWF0ZWQgZnJvbSBjbGljayBhbmQgc3VibWl0IGV2ZW50cy4gIERhdmlzLlJlcXVlc3RzIGFyZSBwYXNzZWQgdG8gRGF2aXMuUm91dGVzCiAqIGFuZCBhcmUgc3RvcmVkIGluIHRoZSBoaXN0b3J5IHN0YWNrLiAgVGhleSBhcmUgaW5zdGFudGlhdGVkIGJ5IHRoZSBEYXZpcy5saXN0ZW5lciBtb2R1bGUuCiAqCiAqIEEgcmVxdWVzdCB3aWxsIGhhdmUgYSBwYXJhbXMgb2JqZWN0IHdoaWNoIHdpbGwgY29udGFpbiBhbGwgcXVlcnkgcGFyYW1zIGFuZCBmb3JtIHBhcmFtcywgYW55IG5hbWVkCiAqIHBhcmFtcyBpbiBhIHJvdXRlcyBwYXRoIHdpbGwgYWxzbyBiZSBhZGRlZCB0byB0aGUgcmVxdWVzdHMgcGFyYW1zIG9iamVjdC4gIEFsc28gaW5jbHVkZWQgaXMgc3VwcG9ydAogKiBmb3IgcmFpbHMgc3R5bGUgbmVzdGVkIGZvcm0gcGFyYW1zLgogKgogKiBCeSBkZWZhdWx0IHRoZSByZXF1ZXN0IG1ldGhvZCB3aWxsIGJlIHRha2VuIGZyb20gdGhlIG1ldGhvZCBhdHRyaWJ1dGUgZm9yIGZvcm1zIG9yIHdpbGwgYmUgZGVmYXVsdGVkCiAqIHRvICdnZXQnIGZvciBsaW5rcywgaG93ZXZlciB0aGVyZSBpcyBzdXBwb3J0IGZvciB1c2luZyBhIGhpZGRlbiBmaWVsZCBjYWxsZWQgX21ldGhvZCBpbiB5b3VyIGZvcm1zCiAqIHRvIHNldCB0aGUgY29ycmVjdCByZXFldXN0IG1ldGhvZC4KICoKICogU2ltcGxlIGdldCByZXF1ZXN0cyBjYW4gYmUgY3JlYXRlZCBieSBqdXN0IHBhc3NpbmcgYSBwYXRoIHdoZW4gaW5pdGlhbGl6aW5nIGEgcmVxdWVzdCwgdG8gc2V0IHRoZSBtZXRob2QKICogb3IgdGl0bGUgeW91IGhhdmUgdG8gcGFzcyBpbiBhbiBvYmplY3QuCiAqCiAqIEV4YW1wbGUKICoKICogICAgIHZhciByZXF1ZXN0ID0gbmV3IERhdmlzLlJlcXVlc3QgKCIvZm9vLzEyIikKICoKICogICAgIHZhciByZXF1ZXN0ID0gbmV3IERhdmlzLlJlcXVlc3QgKCIvZm9vLzEyIiwge3RpdGxlOiAnZm9vJywgbWV0aG9kOiAnUE9TVCd9KQogKiAgICAgCiAqICAgICB2YXIgcmVxdWVzdCA9IG5ldyBEYXZpcy5SZXF1ZXN0KHsKICogICAgICAgdGl0bGU6ICJmb28iLAogKiAgICAgICBmdWxsUGF0aDogIi9mb28vMTIiLAogKiAgICAgICBtZXRob2Q6ICJnZXQiCiAqICAgICB9KQogKgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtTdHJpbmd9IGZ1bGxQYXRoCiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIEFuIG9wdGlvbmFsIG9iamVjdCB3aXRoIGEgdGl0bGUgb3IgbWV0aG9kIHByb3BydHkKICoKICovCiAgdmFyIFJlcXVlc3QgPSBmdW5jdGlvbiAoZnVsbFBhdGgsIG9wdHMpIHsKICAgIGlmICh0eXBlb2YgZnVsbFBhdGggPT0gJ29iamVjdCcpIHsKICAgICAgb3B0cyA9IGZ1bGxQYXRoCiAgICAgIGZ1bGxQYXRoID0gb3B0cy5mdWxsUGF0aAogICAgICBkZWxldGUgb3B0cy5mdWxsUGF0aAogICAgfQoKICAgIHZhciByYXcgPSBEYXZpcy4kLmV4dGVuZCh7fSwgewogICAgICB0aXRsZTogIiIsCiAgICAgIGZ1bGxQYXRoOiBmdWxsUGF0aCwKICAgICAgbWV0aG9kOiAiZ2V0IgogICAgfSwgb3B0cykKCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLnJhdyA9IHJhdzsKICAgIHRoaXMucGFyYW1zID0ge307CiAgICB0aGlzLnRpdGxlID0gcmF3LnRpdGxlOwogICAgdGhpcy5xdWVyeVN0cmluZyA9IHJhdy5mdWxsUGF0aC5zcGxpdCgiPyIpWzFdOwogICAgdGhpcy5fc3RhbGVDYWxsYmFjayA9IGZ1bmN0aW9uICgpIHt9OwoKICAgIGlmICh0aGlzLnF1ZXJ5U3RyaW5nKSB7CiAgICAgIERhdmlzLnV0aWxzLmZvckVhY2godGhpcy5xdWVyeVN0cmluZy5zcGxpdCgiJiIpLCBmdW5jdGlvbiAoa2V5dmFsKSB7CiAgICAgICAgdmFyIHBhcmFtTmFtZSA9IGtleXZhbC5zcGxpdCgiPSIpWzBdLAogICAgICAgICAgICBwYXJhbVZhbHVlID0ga2V5dmFsLnNwbGl0KCI9IilbMV0sCiAgICAgICAgICAgIG5lc3RlZFBhcmFtUmVnZXggPSAvXihcdyspXFsoXHcrKT9cXShcW1xdKT8vLAogICAgICAgICAgICBuZXN0ZWQ7CiAgICAgICAgaWYgKG5lc3RlZCA9IG5lc3RlZFBhcmFtUmVnZXguZXhlYyhwYXJhbU5hbWUpKSB7CiAgICAgICAgICB2YXIgcGFyYW1QYXJlbnQgPSBuZXN0ZWRbMV07CiAgICAgICAgICB2YXIgcGFyYW1OYW1lID0gbmVzdGVkWzJdOwogICAgICAgICAgdmFyIGlzQXJyYXkgPSAhIW5lc3RlZFszXTsKICAgICAgICAgIHZhciBwYXJlbnRQYXJhbXMgPSBzZWxmLnBhcmFtc1twYXJhbVBhcmVudF0gfHwge307CgogICAgICAgICAgaWYgKGlzQXJyYXkpIHsKICAgICAgICAgICAgcGFyZW50UGFyYW1zW3BhcmFtTmFtZV0gPSBwYXJlbnRQYXJhbXNbcGFyYW1OYW1lXSB8fCBbXTsKICAgICAgICAgICAgcGFyZW50UGFyYW1zW3BhcmFtTmFtZV0ucHVzaChkZWNvZGVVUklDb21wb25lbnQocGFyYW1WYWx1ZSkpOwogICAgICAgICAgICBzZWxmLnBhcmFtc1twYXJhbVBhcmVudF0gPSBwYXJlbnRQYXJhbXM7CiAgICAgICAgICB9IGVsc2UgaWYgKCFwYXJhbU5hbWUgJiYgIWlzQXJyYXkpIHsKICAgICAgICAgICAgcGFyZW50UGFyYW1zID0gc2VsZi5wYXJhbXNbcGFyYW1QYXJlbnRdIHx8IFtdCiAgICAgICAgICAgIHBhcmVudFBhcmFtcy5wdXNoKGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVZhbHVlKSkKICAgICAgICAgICAgc2VsZi5wYXJhbXNbcGFyYW1QYXJlbnRdID0gcGFyZW50UGFyYW1zCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYXJlbnRQYXJhbXNbcGFyYW1OYW1lXSA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVZhbHVlKTsKICAgICAgICAgICAgc2VsZi5wYXJhbXNbcGFyYW1QYXJlbnRdID0gcGFyZW50UGFyYW1zOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLnBhcmFtc1twYXJhbU5hbWVdID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtVmFsdWUpOwogICAgICAgIH07CgogICAgICB9KTsKICAgIH07CgogICAgcmF3LmZ1bGxQYXRoID0gcmF3LmZ1bGxQYXRoLnJlcGxhY2UoL15odHRwcz86XC9cLy4rP1wvLywgJy8nKTsKCiAgICB0aGlzLm1ldGhvZCA9ICh0aGlzLnBhcmFtcy5fbWV0aG9kIHx8IHJhdy5tZXRob2QpLnRvTG93ZXJDYXNlKCk7CgogICAgdGhpcy5wYXRoID0gcmF3LmZ1bGxQYXRoCiAgICAgIC5yZXBsYWNlKC9cPy4rJC8sICIiKSAgLy8gUmVtb3ZlIHRoZSBxdWVyeSBzdHJpbmcKICAgICAgLnJlcGxhY2UoL15odHRwcz86XC9cL1teXC9dKy8sICIiKTsgLy8gUmVtb3ZlIHRoZSBwcm90b2NvbCBhbmQgaG9zdCBwYXJ0cwogIAogICAgdGhpcy5mdWxsUGF0aCA9IHJhdy5mdWxsUGF0aDsKCiAgICB0aGlzLmRlbGVnYXRlVG9TZXJ2ZXIgPSByYXcuZGVsZWdhdGVUb1NlcnZlciB8fCBEYXZpcy5ub29wOwogICAgdGhpcy5pc0ZvclBhZ2VMb2FkID0gcmF3LmZvclBhZ2VMb2FkIHx8IGZhbHNlOwoKICAgIGlmIChSZXF1ZXN0LnByZXYpIFJlcXVlc3QucHJldi5tYWtlU3RhbGUodGhpcyk7CiAgICBSZXF1ZXN0LnByZXYgPSB0aGlzOwoKICB9OwoKICAvKioKICAgKiBSZWRpcmVjdHMgdGhlIGN1cnJlbnQgcmVxdWVzdCB0byBhIG5ldyBsb2NhdGlvbi4KICAgKgogICAqIENhbGxpbmcgcmVkaXJlY3Qgb24gYW4gaW5zdGFuY2Ugb2YgRGF2aXMuUmVxdWVzdCB3aWxsIGNyZWF0ZSBhIG5ldyByZXF1ZXN0IHVzaW5nIHRoZSBwYXRoIGFuZAogICAqIHRpdGxlIG9mIHRoZSBjdXJyZW50IHJlcXVlc3QuIFJlZGlyZWN0ZWQgcmVxdWVzdHMgYWx3YXlzIGhhdmUgYSBtZXRob2Qgb2YgJ2dldCcuCiAgICoKICAgKiBUaGUgcmVxdWVzdCBjcmVhdGVkIHdpbGwgcmVwbGFjZSB0aGUgY3VycmVudCByZXF1ZXN0IGluIHRoZSBoaXN0b3J5IHN0YWNrLiAgUmVkaXJlY3QgaXMgbW9zdAogICAqIG9mdGVuIHVzZWZ1bCBpbnNpZGUgYSBoYW5kbGVyIGZvciBhIGZvcm0gc3VibWl0LiAgQWZ0ZXIgc3VjY2VzZnVsbHkgaGFuZGxpbmcgdGhlIGZvcm0gdGhlIGFwcAogICAqIGNhbiByZWRpcmVjdCB0byBhbm90aGVyIHBhdGguICBUaGlzIG1lYW5zIHRoYXQgdGhlIGN1cnJlbnQgZm9ybSB3aWxsIG5vdCBiZSByZS1zdWJtaXR0ZWQgaWYKICAgKiBuYXZpZ2F0aW5nIHRocm91Z2ggdGhlIGhpc3Rvcnkgd2l0aCB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbnMgYmVjYXVzZSB0aGUgcmVxdWVzdCB0aGF0IHRoZQogICAqIHN1Ym1pdCBnZW5lcmF0ZWQgaGFzIGJlZW4gcmVwbGFjZWQgaW4gdGhlIGhpc3Rvcnkgc3RhY2suCiAgICoKICAgKiBFeGFtcGxlCiAgICoKICAgKiAgICAgdGhpcy5wb3N0KCcvZm9vJywgZnVuY3Rpb24gKHJlcSkgewogICAqICAgICAgIHByb2Nlc3NGb3JtUmVxdWVzdChyZXEucGFyYW1zKSAgLy8gZG8gc29tZXRoaW5nIHdpdGggdGhlIGZvcm0gcmVxdWVzdAogICAqICAgICAgIHJlcS5yZWRpcmVjdCgnL2JhcicpOwogICAqICAgICB9KQogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGggVGhlIHBhdGggdG8gcmVkaXJlY3QgdGhlIGN1cnJlbnQgcmVxdWVzdCB0bwogICAqIEBtZW1iZXJPZiBSZXF1ZXN0CiAgICovCiAgUmVxdWVzdC5wcm90b3R5cGUucmVkaXJlY3QgPSBmdW5jdGlvbiAocGF0aCkgewogICAgRGF2aXMubG9jYXRpb24ucmVwbGFjZShuZXcgUmVxdWVzdCAoewogICAgICBtZXRob2Q6ICdnZXQnLAogICAgICBmdWxsUGF0aDogcGF0aCwKICAgICAgdGl0bGU6IHRoaXMudGl0bGUKICAgIH0pKTsKICB9OwoKICAvKioKICAgKiBBZGRzIGEgY2FsbGJhY2sgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIHJlcXVlc3QgaXMgc3RhbGUuCiAgICogQSByZXF1ZXN0IGJlY29tZXMgc3RhbGUgd2hlbiBpdCBpcyBubyBsb25nZXIgdGhlIGN1cnJlbnQgcmVxdWVzdCwgdGhpcyBub3JtYWxseSBvY2N1cnMgd2hlbiBhCiAgICogbmV3IHJlcXVlc3QgaXMgdHJpZ2dlcmVkLiAgQSByZXF1ZXN0IGNhbiBiZSBtYXJrZWQgYXMgc3RhbGUgbWFudWFsbHkgaWYgcmVxdWlyZWQuICBUaGUgY2FsbGJhY2sKICAgKiBwYXNzZWQgdG8gd2hlblN0YWxlIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIG5ldyByZXF1ZXN0IHRoYXQgaXMgbWFraW5nIHRoZSBjdXJyZW50IHJlcXVlc3Qgc3RhbGUuCiAgICoKICAgKiBVc2UgdGhlIHdoZW5TdGFsZSBjYWxsYmFjayB0byAndGVhcmRvd24nIHRoZSBvYmplY3RzIHJlcXVpcmVkIGZvciB0aGUgY3VycmVudCByb3V0ZSwgdGhpcyBnaXZlcwogICAqIGEgY2hhbmNlIGZvciB2aWV3cyB0byBoaWRlIHRoZW1zZWx2ZXMgYW5kIHVuYmluZCBhbnkgZXZlbnQgaGFuZGxlcnMgZXRjLgogICAqCiAgICogRXhhbXBsZQogICAqCiAgICogICAgIHRoaXMuZ2V0KCcvZm9vJywgZnVuY3Rpb24gKHJlcSkgewogICAqICAgICAgIHZhciBmb29WaWV3ID0gbmV3IEZvb1ZpZXcgKCkKICAgKiAgICAgICBmb29WaWV3LnJlbmRlcigpIC8vIGRpc3BsYXkgdGhlIGZvbyB2aWV3CiAgICogICAgICAgcmVxLndoZW5TdGFsZShmdW5jdGlvbiAobmV4dFJlcSkgewogICAqICAgICAgICAgZm9vVmlldy5yZW1vdmUoKSAvLyBzdG9wIGRpc3BsYXlpbmcgZm9vIHZpZXcgYW5kIHVuYmluZCBhbnkgZXZlbnRzCiAgICogICAgICAgfSkKICAgKiAgICAgfSkKICAgKgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIEEgc2luZ2xlIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgcmVxdWVzdCBiZWNvbWVzIHN0YWxlLgogICAqIEBtZW1iZXJPZiBSZXF1ZXN0CiAgICoKICAgKi8KICBSZXF1ZXN0LnByb3RvdHlwZS53aGVuU3RhbGUgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgIHRoaXMuX3N0YWxlQ2FsbGJhY2sgPSBjYWxsYmFjazsKICB9CgogIC8qKgogICAqIE1hcmsgdGhlIHJlcXVlc3QgYXMgc3RhbGUuCiAgICoKICAgKiBUaGlzIHdpbGwgY2F1c2UgdGhlIHdoZW5TdGFsZSBjYWxsYmFjayB0byBiZSBjYWxsZWQuCiAgICoKICAgKiBAcGFyYW0ge0RhdmlzLlJlcXVlc3R9IHJlcSBUaGUgbmV4dCByZXF1ZXN0IHRoYXQgaGFzIGJlZW4gcmVjaWV2ZWQuCiAgICogQG1lbWJlck9mIFJlcXVlc3QKICAgKi8KICBSZXF1ZXN0LnByb3RvdHlwZS5tYWtlU3RhbGUgPSBmdW5jdGlvbiAocmVxKSB7CiAgICB0aGlzLl9zdGFsZUNhbGxiYWNrLmNhbGwocmVxLCByZXEpOwogIH0KCiAgLyoqCiAgICogUmV0dXJucyB0aGUgbG9jYXRpb24gb3IgcGF0aCB0aGF0IHNob3VsZCBiZSBwdXNoZWQgb250byB0aGUgaGlzdG9yeSBzdGFjay4gCiAgICoKICAgKiBGb3IgZ2V0IHJlcXVlc3RzIHRoaXMgd2lsbCBiZSB0aGUgc2FtZSBhcyB0aGUgcGF0aCwgZm9yIHBvc3QsIHB1dCwgZGVsZXRlIGFuZCBzdGF0ZSByZXF1ZXN0cyB0aGlzIHdpbGwKICAgKiBiZSBibGFuayBhcyBubyBsb2NhdGlvbiBzaG91bGQgYmUgcHVzaGVkIG9udG8gdGhlIGhpc3Rvcnkgc3RhY2suCiAgICoKICAgKiBAcmV0dXJucyB7U3RyaW5nfSBzdHJpbmcgVGhlIGxvY2F0aW9uIHRoYXQgdGhlIHVybCBiYXIgc2hvdWxkIGRpc3BsYXkgYW5kIHNob3VsZCBiZSBwdXNoZWQgb250byB0aGUgaGlzdG9yeSBzdGFjayBmb3IgdGhpcyByZXF1ZXN0LgogICAqIEBtZW1iZXJPZiBSZXF1ZXN0CiAgICovCiAgUmVxdWVzdC5wcm90b3R5cGUubG9jYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gKHRoaXMubWV0aG9kID09PSAnZ2V0JykgPyB0aGlzLmZ1bGxQYXRoIDogJycKICB9CgogIC8qKgogICAqIENvbnZlcnRzIHRoZSByZXF1ZXN0IHRvIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIGl0c2VsZiBieSBjb21iaW5pbmcgdGhlIG1ldGhvZCBhbmQgZnVsbFBhdGgKICAgKiBhdHRyaWJ1dGVzLgogICAqCiAgICogQHJldHVybnMge1N0cmluZ30gc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICogQG1lbWJlck9mIFJlcXVlc3QKICAgKi8KICBSZXF1ZXN0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBbdGhpcy5tZXRob2QudG9VcHBlckNhc2UoKSwgdGhpcy5wYXRoXS5qb2luKCIgIikKICB9OwoKICAvKioKICAgKiBDb252ZXJ0cyB0aGUgcmVxdWVzdCB0byBhIHBsYWluIG9iamVjdCB3aGljaCBjYW4gYmUgY29udmVydGVkIHRvIGEgSlNPTiBzdHJpbmcuCiAgICoKICAgKiBVc2VkIHdoZW4gcHVzaGluZyBhIHJlcXVlc3Qgb250byB0aGUgaGlzdG9yeSBzdGFjay4KICAgKgogICAqIEByZXR1cm5zIHtPYmplY3R9IGEgcGxhaW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoZSByZXF1ZXN0LgogICAqIEBtZW1iZXJPZiBSZXF1ZXN0CiAgICovCiAgUmVxdWVzdC5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHsKICAgICAgdGl0bGU6IHRoaXMucmF3LnRpdGxlLAogICAgICBmdWxsUGF0aDogdGhpcy5yYXcuZnVsbFBhdGgsCiAgICAgIG1ldGhvZDogdGhpcy5yYXcubWV0aG9kCiAgICB9CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IHJlcXVlc3QgZm9yIHRoZSBwYWdlIG9uIHBhZ2UgbG9hZC4KICAgKgogICAqIFRoaXMgaXMgcmVxdWlyZWQgYmVjYXVzZSB1c3VhbGx5IHJlcXVlc3RzIGFyZSBnZW5lcmF0ZWQgZnJvbSBjbGlja2luZyBsaW5rcyBvciBzdWJtaXR0aW5nIGZvcm1zCiAgICogaG93ZXZlciB0aGlzIGRvZXNuJ3QgaGFwcGVuIG9uIGEgcGFnZSBsb2FkIGJ1dCBzaG91bGQgc3RpbGwgYmUgY29uc2lkZXJlZCBhIHJlcXVlc3QgdGhhdCB0aGUgCiAgICogSmF2YVNjcmlwdCBhcHAgc2hvdWxkIGhhbmRsZS4KICAgKgogICAqIEByZXR1cm5zIHtEYXZpcy5SZXF1ZXN0fSBBIHJlcXVlc3QgcmVwcmVzZW50aW5nIHRoZSBjdXJyZW50IHBhZ2UgbG9hZGluZy4KICAgKiBAbWVtYmVyT2YgUmVxdWVzdAogICAqLwogIFJlcXVlc3QuZm9yUGFnZUxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMgKHsKICAgICAgbWV0aG9kOiAnZ2V0JywKICAgICAgLy8gZnVsbFBhdGg6IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSwKICAgICAgZnVsbFBhdGg6IERhdmlzLmxvY2F0aW9uLmN1cnJlbnQoKSwKICAgICAgdGl0bGU6IGRvY3VtZW50LnRpdGxlLAogICAgICBmb3JQYWdlTG9hZDogdHJ1ZQogICAgfSk7CiAgfQoKICAvKiEKICAgKiBTdG9yZXMgdGhlIGxhc3QgcmVxdWVzdAogICAqIEBwcml2YXRlCiAgICovCiAgUmVxdWVzdC5wcmV2ID0gbnVsbAoKICByZXR1cm4gUmVxdWVzdAoKfSkoKQovKiEKICogRGF2aXMgLSBBcHAKICogQ29weXJpZ2h0IChDKSAyMDExIE9saXZlciBOaWdodGluZ2FsZQogKiBNSVQgTGljZW5zZWQKICovCgpEYXZpcy5BcHAgPSAoZnVuY3Rpb24gKCkgewoKICAvKioKICAgKiBDb25zdHJ1Y3RvciBmb3IgRGF2aXMuQXBwCiAgICoKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcmV0dXJucyB7RGF2aXMuQXBwfQogICAqLwogIGZ1bmN0aW9uIEFwcCgpIHsKICAgIHRoaXMucnVubmluZyA9IGZhbHNlOwogICAgdGhpcy5ib3VuZFRvSW50ZXJuYWxFdmVudHMgPSBmYWxzZTsKCiAgICB0aGlzLnVzZShEYXZpcy5saXN0ZW5lcikKICAgIHRoaXMudXNlKERhdmlzLmV2ZW50KQogICAgdGhpcy51c2UoRGF2aXMucm91dGVyKQogICAgdGhpcy51c2UoRGF2aXMubG9nZ2VyKQogIH07CgogIC8qKgogICAqIEEgY29udmluaWVuY2UgZnVuY3Rpb24gZm9yIGNoYW5naW5nIHRoZSBhcHBzIGRlZmF1bHQgc2V0dGluZ3MuCiAgICoKICAgKiBTaG91bGQgYmUgdXNlZCBiZWZvcmUgc3RhcnRpbmcgdGhlIGFwcCB0byBlbnN1cmUgYW55IG5ldyBzZXR0aW5ncwogICAqIGFyZSBwaWNrZWQgdXAgYW5kIHVzZWQuCiAgICoKICAgKiBFeGFtcGxlOgogICAqCiAgICogICAgIGFwcC5jb25maWd1cmUoZnVuY3Rpb24gKGNvbmZpZykgewogICAqICAgICAgIGNvbmZpZy5saW5rU2VsZWN0b3IgPSAnYS5kYXZpcycKICAgKiAgICAgICBjb25maWcuZm9ybVNlbGVjdG9yID0gJ2Zvcm0uZGF2aXMnCiAgICogICAgIH0pCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25maWcgVGhpcyBmdW5jdGlvbiB3aWxsIGJlIGV4ZWN1dGVkIHdpdGggdGhlIGNvbnRleHQgYm91bmQgdG8gdGhlIGFwcHMgc2V0dGluZyBvYmplY3QsIHRoaXMgd2lsbCBhbHNvIGJlIHBhc3NlZCBhcyB0aGUgZmlyc3QgYXJndW1lbnQgdG8gdGhlIGZ1bmN0aW9uLgogICAqLwogIEFwcC5wcm90b3R5cGUuY29uZmlndXJlID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICBjb25maWcuY2FsbCh0aGlzLnNldHRpbmdzLCB0aGlzLnNldHRpbmdzKTsKICB9OwoKICAvKioKICAgKiBNZXRob2QgdG8gaW5jbHVkZSBhIHBsdWdpbiBpbiB0aGlzIGFwcC4KICAgKgogICAqIEEgcGx1Z2luIGlzIGp1c3QgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkIGluIHRoZSBjb250ZXh0IG9mIHRoZSBhcHAuCiAgICoKICAgKiBFeGFtcGxlOgogICAqICAgICBhcHAudXNlKERhdmlzLnRpdGxlKQogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gcGx1Z2luIFRoZSBwbHVnaW4gdG8gdXNlCiAgICoKICAgKi8KICBBcHAucHJvdG90eXBlLnVzZSA9IGZ1bmN0aW9uKHBsdWdpbikgewogICAgcGx1Z2luLmFwcGx5KHRoaXMsIERhdmlzLnV0aWxzLnRvQXJyYXkoYXJndW1lbnRzLCAxKSkKICB9OwoKICAvKioKICAgKiBNZXRob2QgdG8gYWRkIGhlbHBlciBwcm9wZXJ0aWVzIHRvIGFsbCByZXF1ZXN0cyBpbiB0aGUgYXBwbGljYXRpb24uCiAgICoKICAgKiBIZWxwZXJzIHdpbGwgYmUgYWRkZWQgdG8gdGhlIERhdmlzLlJlcXVlc3QucHJvdG90eXBlLiAgQ2FyZSBzaG91bGQgYmUgdGFrZW4gbm90IHRvIG92ZXJyaWRlIGFueSBleGlzdGluZyBEYXZpcy5SZXF1ZXN0CiAgICogbWV0aG9kcy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBoZWxwZXJzIEFuIG9iamVjdCBjb250YWluaW5nIGhlbHBlcnMgdG8gbWl4aW4gdG8gdGhlIHJlcXVlc3QKICAgKi8KICBBcHAucHJvdG90eXBlLmhlbHBlcnMgPSBmdW5jdGlvbihoZWxwZXJzKSB7CiAgICBmb3IgKHByb3BlcnR5IGluIGhlbHBlcnMpIHsKICAgICAgaWYgKGhlbHBlcnMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpKSBEYXZpcy5SZXF1ZXN0LnByb3RvdHlwZVtwcm9wZXJ0eV0gPSBoZWxwZXJzW3Byb3BlcnR5XQogICAgfQogIH07CgogIC8qKgogICAqIFNldHRpbmdzIGZvciB0aGUgYXBwLiAgVGhlc2UgbWF5IGJlIG92ZXJyaWRlbiBkaXJlY3RseSBvciBieSB1c2luZyB0aGUgY29uZmlndXJlCiAgICogY29udmluaWVuY2UgbWV0aG9kLgogICAqCiAgICogYGxpbmtTZWxlY3RvcmAgaXMgdGhlIGpxdWVyeSBzZWxlY3RvciBmb3IgYWxsIHRoZSBsaW5rcyBvbiB0aGUgcGFnZSB0aGF0IHlvdSB3YW50CiAgICogRGF2aXMgdG8gcmVzcG9uZCB0by4gIFRoZXNlIGxpbmtzIHdpbGwgbm90IHRyaWdnZXIgYSBub3JtYWwgaHR0cCByZXF1ZXN0LgogICAqCiAgICogYGZvcm1TZWxlY3RvcmAgaXMgc2ltaWxhciB0byBsaW5rIHNlbGVjdG9yIGJ1dCBmb3IgYWxsIHRoZSBmb3JtcyB0aGF0IGRhdmlzIHdpbGwgYmluZCB0bwogICAqCiAgICogYHRocm93RXJyb3JzYCBkZWNpZGVzIHdoZXRoZXIgb3Igbm90IGFueSBlcnJvcnMgd2lsbCBiZSBjYXVndGggYnkgRGF2aXMuICBJZiB0aGlzIGlzIHNldCB0byB0cnVlCiAgICogZXJyb3JzIHdpbGwgYmUgdGhyb3duIHNvIHRoYXQgdGhlIHJlcXVlc3Qgd2lsbCBub3QgYmUgaGFuZGxlZCBieSBKYXZhU2NyaXB0LCB0aGUgc2VydmVyIHdpbGwgaGF2ZQogICAqIHRvIHByb3ZpZGUgYSByZXNwb25zZS4gIFdoZW4gc2V0IHRvIGZhbHNlIGVycm9ycyBpbiBhIHJvdXRlIHdpbGwgYmUgY2F1Z2h0IGFuZCB0aGUgc2VydmVyIHdpbGwgbm90CiAgICogcmVjZWl2ZSB0aGUgcmVxdWVzdC4KICAgKgogICAqIGBoYW5kbGVSb3V0ZU5vdEZvdW5kYCBkZXRlcm1pbmVzIHdoZXRoZXIgb3Igbm90IERhdmlzIHNob3VsZCBoYW5kbGUgcmVxdWVzdHMgd2hlbiB0aGVyZSBpcyBubyBtYXRjaGluZwogICAqIHJvdXRlLiAgSWYgc2V0IHRvIGZhbHNlIERhdmlzIHdpbGwgYWxsb3cgdGhlIHJlcXVlc3QgdG8gYmUgcGFzc2VkIHRvIHlvdXIgc2VydmVyIHRvIGhhbmRsZSBpZiBubyBtYXRjaGluZwogICAqIHJvdXRlIGNhbiBiZSBmb3VuZC4KICAgKgogICAqIGBnZW5lcmF0ZVJlcXVlc3RPblBhZ2VMb2FkYCBkZXRlcm1pbmVzIHdoZXRoZXIgYSByZXF1ZXN0IHNob3VsZCBiZSBnZW5lcmF0ZWQgZm9yIHRoZSBpbml0aWFsIHBhZ2UgbG9hZC4KICAgKiBieSBkZWZhdWx0IHRoaXMgaXMgc2V0IHRvIGZhbHNlLiBBIERhdmlzLlJlcXVlc3Qgd2lsbCBub3QgYmUgZ2VuZXJhdGVkIHdpdGggdGhlIHBhdGggb2YgdGhlIGN1cnJlbnQKICAgKiBwYWdlLiAgU2V0dGluZyB0aGlzIHRvIHRydWUgd2lsbCBjYXVzZSBhIHJlcXVlc3QgdG8gYmUgcGFzc2VkIHRvIHlvdXIgYXBwIGZvciB0aGUgaW5pdGFsIHBhZ2UgbG9hZC4KICAgKgogICAqIEBzZWUgI2NvbmZpZ3VyZQogICAqLwoKICBBcHAucHJvdG90eXBlLnNldHRpbmdzID0gewogICAgbGlua1NlbGVjdG9yOiAnYScsCiAgICBmb3JtU2VsZWN0b3I6ICdmb3JtJywKICAgIHRocm93RXJyb3JzOiB0cnVlLAogICAgaGFuZGxlUm91dGVOb3RGb3VuZDogZmFsc2UsCiAgICBnZW5lcmF0ZVJlcXVlc3RPblBhZ2VMb2FkOiBmYWxzZQogIH07CgogIC8qKgogICAqIFN0YXJ0cyB0aGUgYXBwJ3Mgcm91dGluZy4KICAgKgogICAqIEFwcHMgY3JlYXRlZCB1c2luZyB0aGUgY29udmluaWVuY2UgRGF2aXMoKSBmdW5jdGlvbiBhcmUgYXV0b21hdGljYWxseSBzdGFydGVkLgogICAqCiAgICogU3RhcnRpbmcgdGhlIGFwcCBiaW5kcyBhbGwgbGlua3MgYW5kIGZvcm1zLCBzbyBjbGlja3MgYW5kIHN1Ym1pdHMKICAgKiBjcmVhdGUgRGF2aXMgcmVxdWVzdHMgdGhhdCB3aWxsIGJlIHB1c2hlZCBvbnRvIHRoZSBicm93c2VycyBoaXN0b3J5IHN0YWNrLiAgQnJvd3NlciBoaXN0b3J5IGNoYW5nZQogICAqIGV2ZW50cyB3aWxsIGJlIHBpY2tlZCB1cCBhbmQgdGhlIHJlcXVlc3QgdGhhdCBjYXVzZWQgdGhlIGNoYW5nZSB3aWxsIGJlIG1hdGNoZWQgYWdhaW5zdCB0aGUgYXBwcwogICAqIHJvdXRlcyBhbmQgZmlsdGVycy4KICAgKi8KICAgQXBwLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgaWYgKHRoaXMucnVubmluZykgcmV0dXJuCgogICAgaWYgKCFEYXZpcy5zdXBwb3J0ZWQoKSkgewogICAgICB0aGlzLnRyaWdnZXIoJ3Vuc3VwcG9ydGVkJykKICAgICAgcmV0dXJuCiAgICB9OwoKICAgIHZhciBydW5GaWx0ZXJXaXRoID0gZnVuY3Rpb24gKHJlcXVlc3QpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChmaWx0ZXIpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gZmlsdGVyLnJ1bihyZXF1ZXN0LCByZXF1ZXN0KTsKICAgICAgICByZXR1cm4gKHR5cGVvZiByZXN1bHQgPT09ICJ1bmRlZmluZWQiIHx8IHJlc3VsdCk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgYmVmb3JlRmlsdGVyc1Bhc3MgPSBmdW5jdGlvbiAocmVxdWVzdCkgewogICAgICByZXR1cm4gRGF2aXMudXRpbHMuZXZlcnkoCiAgICAgICAgc2VsZi5sb29rdXBCZWZvcmVGaWx0ZXIocmVxdWVzdC5tZXRob2QsIHJlcXVlc3QucGF0aCksCiAgICAgICAgcnVuRmlsdGVyV2l0aChyZXF1ZXN0KQogICAgICApCiAgICB9CgogICAgdmFyIGhhbmRsZVJlcXVlc3QgPSBmdW5jdGlvbiAocmVxdWVzdCkgewogICAgICBpZiAoYmVmb3JlRmlsdGVyc1Bhc3MocmVxdWVzdCkpIHsKICAgICAgICBzZWxmLnRyaWdnZXIoJ2xvb2t1cFJvdXRlJywgcmVxdWVzdCkKICAgICAgICB2YXIgcm91dGUgPSBzZWxmLmxvb2t1cFJvdXRlKHJlcXVlc3QubWV0aG9kLCByZXF1ZXN0LnBhdGgpOwogICAgICAgIGlmIChyb3V0ZSkgewogICAgICAgICAgc2VsZi50cmlnZ2VyKCdydW5Sb3V0ZScsIHJlcXVlc3QsIHJvdXRlKTsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICByb3V0ZS5ydW4ocmVxdWVzdCkKICAgICAgICAgICAgc2VsZi50cmlnZ2VyKCdyb3V0ZUNvbXBsZXRlJywgcmVxdWVzdCwgcm91dGUpCiAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBzZWxmLnRyaWdnZXIoJ3JvdXRlRXJyb3InLCByZXF1ZXN0LCByb3V0ZSwgZXJyb3IpCiAgICAgICAgICB9CgogICAgICAgICAgRGF2aXMudXRpbHMuZXZlcnkoCiAgICAgICAgICAgIHNlbGYubG9va3VwQWZ0ZXJGaWx0ZXIocmVxdWVzdC5tZXRob2QsIHJlcXVlc3QucGF0aCksCiAgICAgICAgICAgIHJ1bkZpbHRlcldpdGgocmVxdWVzdCkKICAgICAgICAgICk7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLnRyaWdnZXIoJ3JvdXRlTm90Rm91bmQnLCByZXF1ZXN0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZi50cmlnZ2VyKCdyZXF1ZXN0SGFsdGVkJywgcmVxdWVzdCkKICAgICAgfQogICAgfQoKICAgIHZhciBiaW5kVG9JbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZgogICAgICAgIC5iaW5kKCdydW5Sb3V0ZScsIGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJydW5Sb3V0ZTogIiArIHJlcXVlc3QudG9TdHJpbmcoKSk7CiAgICAgICAgfSkKICAgICAgICAuYmluZCgncm91dGVOb3RGb3VuZCcsIGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICAgICAgICBpZiAoIXNlbGYuc2V0dGluZ3MuaGFuZGxlUm91dGVOb3RGb3VuZCAmJiAhcmVxdWVzdC5pc0ZvclBhZ2VMb2FkKSB7CiAgICAgICAgICAgIHNlbGYuc3RvcCgpCiAgICAgICAgICAgIHJlcXVlc3QuZGVsZWdhdGVUb1NlcnZlcigpCiAgICAgICAgICB9OwogICAgICAgICAgc2VsZi5sb2dnZXIud2Fybigicm91dGVOb3RGb3VuZDogIiArIHJlcXVlc3QudG9TdHJpbmcoKSk7CiAgICAgICAgfSkKICAgICAgICAuYmluZCgnc3RhcnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJhcHBsaWNhdGlvbiBzdGFydGVkIikKICAgICAgICB9KQogICAgICAgIC5iaW5kKCdzdG9wJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiYXBwbGljYXRpb24gc3RvcHBlZCIpCiAgICAgICAgfSkKICAgICAgICAuYmluZCgncm91dGVFcnJvcicsIGZ1bmN0aW9uIChyZXF1ZXN0LCByb3V0ZSwgZXJyb3IpIHsKICAgICAgICAgIGlmIChzZWxmLnNldHRpbmdzLnRocm93RXJyb3JzKSB0aHJvdyhlcnJvcikKICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGVycm9yLm1lc3NhZ2UsIGVycm9yLnN0YWNrKQogICAgICAgIH0pOwoKICAgICAgRGF2aXMubG9jYXRpb24ub25DaGFuZ2UoZnVuY3Rpb24gKHJlcSkgewogICAgICAgIGhhbmRsZVJlcXVlc3QocmVxKQogICAgICB9KTsKCiAgICAgIHNlbGYuYm91bmRUb0ludGVybmFsRXZlbnRzID0gdHJ1ZQogICAgfQoKICAgIGlmICghdGhpcy5ib3VuZFRvSW50ZXJuYWxFdmVudHMpIGJpbmRUb0ludGVybmFsRXZlbnRzKCkKCiAgICB0aGlzLmxpc3RlbigpOwogICAgdGhpcy50cmlnZ2VyKCdzdGFydCcpCiAgICB0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKICAgIGlmICh0aGlzLnNldHRpbmdzLmdlbmVyYXRlUmVxdWVzdE9uUGFnZUxvYWQpIGhhbmRsZVJlcXVlc3QoRGF2aXMuUmVxdWVzdC5mb3JQYWdlTG9hZCgpKQoKICB9OwoKICAvKioKICAgKiBTdG9wcyB0aGUgYXBwJ3Mgcm91dGluZy4KICAgKgogICAqIFN0b3BzIHRoZSBhcHAgbGlzdGVuaW5nIHRvIGNsaWNrcyBhbmQgc3VibWl0cyBvbiBhbGwgZm9ybXMgYW5kIGxpbmtzIGZvdW5kIHVzaW5nIHRoZSBjdXJyZW50CiAgICogYXBwcyBzZXR0aW5ncy4KICAgKi8KICBBcHAucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMudW5saXN0ZW4oKTsKICAgIHRoaXMudHJpZ2dlcignc3RvcCcpCiAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZQogIH07CgogIHJldHVybiBBcHA7Cn0pKCkKOwpkZWZpbmUoImRhdmlzIiwgWyJqcXVlcnkiXSwgKGZ1bmN0aW9uIChnbG9iYWwpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGdsb2JhbC5EYXZpczsKICAgIH0KfSh0aGlzKSkpOwoKLy8gICAgIEJhY2tib25lLmpzIDAuOS4yCgovLyAgICAgKGMpIDIwMTAtMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKCihmdW5jdGlvbigpewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBnbG9iYWwgb2JqZWN0IChgd2luZG93YCBpbiB0aGUgYnJvd3NlciwgYGdsb2JhbGAKICAvLyBvbiB0aGUgc2VydmVyKS4KICB2YXIgcm9vdCA9IHRoaXM7CgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlLCBzbyB0aGF0IGl0IGNhbiBiZQogIC8vIHJlc3RvcmVkIGxhdGVyIG9uLCBpZiBgbm9Db25mbGljdGAgaXMgdXNlZC4KICB2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7CgogIC8vIENyZWF0ZSBhIGxvY2FsIHJlZmVyZW5jZSB0byBzcGxpY2UuCiAgdmFyIHNwbGljZSA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2U7CgogIC8vIFRoZSB0b3AtbGV2ZWwgbmFtZXNwYWNlLiBBbGwgcHVibGljIEJhY2tib25lIGNsYXNzZXMgYW5kIG1vZHVsZXMgd2lsbAogIC8vIGJlIGF0dGFjaGVkIHRvIHRoaXMuIEV4cG9ydGVkIGZvciBib3RoIENvbW1vbkpTIGFuZCB0aGUgYnJvd3Nlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcwLjkuMic7CgogIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4KICB2YXIgXyA9IHJvb3QuXzsKICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBvciBFbmRlciBvd25zIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9IHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlcjsKCiAgLy8gUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCiAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgogIEJhY2tib25lLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgogIC8vIHdpbGwgZmFrZSBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7CgogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncwogIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgogIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrIGZ1bmN0aW9ucwogIC8vIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgogICAgLy8gQmluZCBvbmUgb3IgbW9yZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnRzLCBgZXZlbnRzYCwgdG8gYSBgY2FsbGJhY2tgCiAgICAvLyBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KICAgIG9uOiBmdW5jdGlvbihldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciBjYWxscywgZXZlbnQsIGxpc3Q7CiAgICAgIGlmICghY2FsbGJhY2spIHJldHVybiB0aGlzOwoKICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBjYWxscyA9IHRoaXMuX2NhbGxiYWNrcyB8fCAodGhpcy5fY2FsbGJhY2tzID0ge30pOwoKICAgICAgd2hpbGUgKGV2ZW50ID0gZXZlbnRzLnNoaWZ0KCkpIHsKICAgICAgICBsaXN0ID0gY2FsbHNbZXZlbnRdIHx8IChjYWxsc1tldmVudF0gPSBbXSk7CiAgICAgICAgbGlzdC5wdXNoKGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MKICAgIC8vIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MgZm9yIHRoZQogICAgLy8gZXZlbnQuIElmIGBldmVudHNgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgIG9mZjogZnVuY3Rpb24oZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICB2YXIgZXZlbnQsIGNhbGxzLCBsaXN0LCBpOwoKICAgICAgLy8gTm8gZXZlbnRzLCBvciByZW1vdmluZyAqYWxsKiBldmVudHMuCiAgICAgIGlmICghKGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzKSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghKGV2ZW50cyB8fCBjYWxsYmFjayB8fCBjb250ZXh0KSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9jYWxsYmFja3M7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIGV2ZW50cyA9IGV2ZW50cyA/IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKSA6IF8ua2V5cyhjYWxscyk7CgogICAgICAvLyBMb29wIHRocm91Z2ggdGhlIGNhbGxiYWNrIGxpc3QsIHNwbGljaW5nIHdoZXJlIGFwcHJvcHJpYXRlLgogICAgICB3aGlsZSAoZXZlbnQgPSBldmVudHMuc2hpZnQoKSkgewogICAgICAgIGlmICghKGxpc3QgPSBjYWxsc1tldmVudF0pIHx8ICEoY2FsbGJhY2sgfHwgY29udGV4dCkpIHsKICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGZvciAoaSA9IGxpc3QubGVuZ3RoIC0gMjsgaSA+PSAwOyBpIC09IDIpIHsKICAgICAgICAgIGlmICghKGNhbGxiYWNrICYmIGxpc3RbaV0gIT09IGNhbGxiYWNrIHx8IGNvbnRleHQgJiYgbGlzdFtpICsgMV0gIT09IGNvbnRleHQpKSB7CiAgICAgICAgICAgIGxpc3Quc3BsaWNlKGksIDIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgLy8gcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgIC8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgIC8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KICAgIHRyaWdnZXI6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgICB2YXIgZXZlbnQsIGNhbGxzLCBsaXN0LCBpLCBsZW5ndGgsIGFyZ3MsIGFsbCwgcmVzdDsKICAgICAgaWYgKCEoY2FsbHMgPSB0aGlzLl9jYWxsYmFja3MpKSByZXR1cm4gdGhpczsKCiAgICAgIHJlc3QgPSBbXTsKICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwoKICAgICAgLy8gRmlsbCB1cCBgcmVzdGAgd2l0aCB0aGUgY2FsbGJhY2sgYXJndW1lbnRzLiAgU2luY2Ugd2UncmUgb25seSBjb3B5aW5nCiAgICAgIC8vIHRoZSB0YWlsIG9mIGBhcmd1bWVudHNgLCBhIGxvb3AgaXMgbXVjaCBmYXN0ZXIgdGhhbiBBcnJheSNzbGljZS4KICAgICAgZm9yIChpID0gMSwgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdFtpIC0gMV0gPSBhcmd1bWVudHNbaV07CiAgICAgIH0KCiAgICAgIC8vIEZvciBlYWNoIGV2ZW50LCB3YWxrIHRocm91Z2ggdGhlIGxpc3Qgb2YgY2FsbGJhY2tzIHR3aWNlLCBmaXJzdCB0bwogICAgICAvLyB0cmlnZ2VyIHRoZSBldmVudCwgdGhlbiB0byB0cmlnZ2VyIGFueSBgImFsbCJgIGNhbGxiYWNrcy4KICAgICAgd2hpbGUgKGV2ZW50ID0gZXZlbnRzLnNoaWZ0KCkpIHsKICAgICAgICAvLyBDb3B5IGNhbGxiYWNrIGxpc3RzIHRvIHByZXZlbnQgbW9kaWZpY2F0aW9uLgogICAgICAgIGlmIChhbGwgPSBjYWxscy5hbGwpIGFsbCA9IGFsbC5zbGljZSgpOwogICAgICAgIGlmIChsaXN0ID0gY2FsbHNbZXZlbnRdKSBsaXN0ID0gbGlzdC5zbGljZSgpOwoKICAgICAgICAvLyBFeGVjdXRlIGV2ZW50IGNhbGxiYWNrcy4KICAgICAgICBpZiAobGlzdCkgewogICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbGlzdC5sZW5ndGg7IGkgPCBsZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICBsaXN0W2ldLmFwcGx5KGxpc3RbaSArIDFdIHx8IHRoaXMsIHJlc3QpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRXhlY3V0ZSAiYWxsIiBjYWxsYmFja3MuCiAgICAgICAgaWYgKGFsbCkgewogICAgICAgICAgYXJncyA9IFtldmVudF0uY29uY2F0KHJlc3QpOwogICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gYWxsLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgIGFsbFtpXS5hcHBseShhbGxbaSArIDFdIHx8IHRoaXMsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogIH07CgogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CiAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsLCB3aXRoIGRlZmluZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGRlZmF1bHRzOwogICAgYXR0cmlidXRlcyB8fCAoYXR0cmlidXRlcyA9IHt9KTsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuY29sbGVjdGlvbikgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wYXJzZSkgYXR0cmlidXRlcyA9IHRoaXMucGFyc2UoYXR0cmlidXRlcyk7CiAgICBpZiAoZGVmYXVsdHMgPSBnZXRWYWx1ZSh0aGlzLCAnZGVmYXVsdHMnKSkgewogICAgICBhdHRyaWJ1dGVzID0gXy5leHRlbmQoe30sIGRlZmF1bHRzLCBhdHRyaWJ1dGVzKTsKICAgIH0KICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgdGhpcy5fZXNjYXBlZEF0dHJpYnV0ZXMgPSB7fTsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnYycpOwogICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICB0aGlzLl9zaWxlbnQgPSB7fTsKICAgIHRoaXMuX3BlbmRpbmcgPSB7fTsKICAgIHRoaXMuc2V0KGF0dHJpYnV0ZXMsIHtzaWxlbnQ6IHRydWV9KTsKICAgIC8vIFJlc2V0IGNoYW5nZSB0cmFja2luZy4KICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgdGhpcy5fc2lsZW50ID0ge307CiAgICB0aGlzLl9wZW5kaW5nID0ge307CiAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIHNpbGVudGx5IGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgdGltZQogICAgLy8gYGNoYW5nZWAgd2FzIGNhbGxlZC4gIFdpbGwgYmVjb21lIHBlbmRpbmcgYXR0cmlidXRlcyBvbiB0aGUgbmV4dCBjYWxsLgogICAgX3NpbGVudDogbnVsbCwKCiAgICAvLyBBIGhhc2ggb2YgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgJ2NoYW5nZSdgIGV2ZW50CiAgICAvLyBiZWdhbi4KICAgIF9wZW5kaW5nOiBudWxsLAoKICAgIC8vIFRoZSBkZWZhdWx0IG5hbWUgZm9yIHRoZSBKU09OIGBpZGAgYXR0cmlidXRlIGlzIGAiaWQiYC4gTW9uZ29EQiBhbmQKICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KICAgIGlkQXR0cmlidXRlOiAnaWQnLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewogICAgICB2YXIgaHRtbDsKICAgICAgaWYgKGh0bWwgPSB0aGlzLl9lc2NhcGVkQXR0cmlidXRlc1thdHRyXSkgcmV0dXJuIGh0bWw7CiAgICAgIHZhciB2YWwgPSB0aGlzLmdldChhdHRyKTsKICAgICAgcmV0dXJuIHRoaXMuX2VzY2FwZWRBdHRyaWJ1dGVzW2F0dHJdID0gXy5lc2NhcGUodmFsID09IG51bGwgPyAnJyA6ICcnICsgdmFsKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgIHVubGVzcwogICAgLy8geW91IGNob29zZSB0byBzaWxlbmNlIGl0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycywgYXR0ciwgdmFsOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmIChfLmlzT2JqZWN0KGtleSkgfHwga2V5ID09IG51bGwpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXR0cnMgPSB7fTsKICAgICAgICBhdHRyc1trZXldID0gdmFsdWU7CiAgICAgIH0KCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgaWYgKCFhdHRycykgcmV0dXJuIHRoaXM7CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSBhdHRycyA9IGF0dHJzLmF0dHJpYnV0ZXM7CiAgICAgIGlmIChvcHRpb25zLnVuc2V0KSBmb3IgKGF0dHIgaW4gYXR0cnMpIGF0dHJzW2F0dHJdID0gdm9pZCAwOwoKICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCiAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgogICAgICBpZiAodGhpcy5pZEF0dHJpYnV0ZSBpbiBhdHRycykgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwoKICAgICAgdmFyIGNoYW5nZXMgPSBvcHRpb25zLmNoYW5nZXMgPSB7fTsKICAgICAgdmFyIG5vdyA9IHRoaXMuYXR0cmlidXRlczsKICAgICAgdmFyIGVzY2FwZWQgPSB0aGlzLl9lc2NhcGVkQXR0cmlidXRlczsKICAgICAgdmFyIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgfHwge307CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUuLi4KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CgogICAgICAgIC8vIElmIHRoZSBuZXcgYW5kIGN1cnJlbnQgdmFsdWUgZGlmZmVyLCByZWNvcmQgdGhlIGNoYW5nZS4KICAgICAgICBpZiAoIV8uaXNFcXVhbChub3dbYXR0cl0sIHZhbCkgfHwgKG9wdGlvbnMudW5zZXQgJiYgXy5oYXMobm93LCBhdHRyKSkpIHsKICAgICAgICAgIGRlbGV0ZSBlc2NhcGVkW2F0dHJdOwogICAgICAgICAgKG9wdGlvbnMuc2lsZW50ID8gdGhpcy5fc2lsZW50IDogY2hhbmdlcylbYXR0cl0gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgICBvcHRpb25zLnVuc2V0ID8gZGVsZXRlIG5vd1thdHRyXSA6IG5vd1thdHRyXSA9IHZhbDsKCiAgICAgICAgLy8gSWYgdGhlIG5ldyBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLCByZWNvcmQgdGhlIGNoYW5nZS4gIElmIG5vdCwKICAgICAgICAvLyB0aGVuIHJlbW92ZSBjaGFuZ2VzIGZvciB0aGlzIGF0dHJpYnV0ZS4KICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpIHx8IChfLmhhcyhub3csIGF0dHIpICE9PSBfLmhhcyhwcmV2LCBhdHRyKSkpIHsKICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMuX3BlbmRpbmdbYXR0cl0gPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwogICAgICAgICAgZGVsZXRlIHRoaXMuX3BlbmRpbmdbYXR0cl07CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBGaXJlIHRoZSBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy5jaGFuZ2Uob3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgLy8gdG8gc2lsZW5jZSBpdC4gYHVuc2V0YCBpcyBhIG5vb3AgaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KTsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIG51bGwsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgIHVubGVzcyB5b3UgY2hvb3NlCiAgICAvLyB0byBzaWxlbmNlIGl0LgogICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KTsKICAgICAgcmV0dXJuIHRoaXMuc2V0KF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKSwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUKICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgeGhyKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgb3B0aW9ucy5lcnJvciA9IEJhY2tib25lLndyYXBFcnJvcihvcHRpb25zLmVycm9yLCBtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncwogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBjdXJyZW50LCBkb25lOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCgia2V5IiwgdmFsdWUpYCBhbmQgYCh7a2V5OiB2YWx1ZX0pYCAtc3R5bGUgY2FsbHMuCiAgICAgIGlmIChfLmlzT2JqZWN0KGtleSkgfHwga2V5ID09IG51bGwpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXR0cnMgPSB7fTsKICAgICAgICBhdHRyc1trZXldID0gdmFsdWU7CiAgICAgIH0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgogICAgICAvLyBJZiB3ZSdyZSAid2FpdCItaW5nIHRvIHNldCBjaGFuZ2VkIGF0dHJpYnV0ZXMsIHZhbGlkYXRlIGVhcmx5LgogICAgICBpZiAob3B0aW9ucy53YWl0KSB7CiAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBjdXJyZW50ID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICB9CgogICAgICAvLyBSZWd1bGFyIHNhdmVzIGBzZXRgIGF0dHJpYnV0ZXMgYmVmb3JlIHBlcnNpc3RpbmcgdG8gdGhlIHNlcnZlci4KICAgICAgdmFyIHNpbGVudE9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3NpbGVudDogdHJ1ZX0pOwogICAgICBpZiAoYXR0cnMgJiYgIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zLndhaXQgPyBzaWxlbnRPcHRpb25zIDogb3B0aW9ucykpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIC8vIERvIG5vdCBwZXJzaXN0IGludmFsaWQgbW9kZWxzLgogICAgICBpZiAoIWF0dHJzICYmICF0aGlzLmlzVmFsaWQoKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwLCBzdGF0dXMsIHhocikgewogICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgIHZhciBzZXJ2ZXJBdHRycyA9IG1vZGVsLnBhcnNlKHJlc3AsIHhocik7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwogICAgICAgIGlmICghbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgLy8gRmluaXNoIGNvbmZpZ3VyaW5nIGFuZCBzZW5kaW5nIHRoZSBBamF4IHJlcXVlc3QuCiAgICAgIG9wdGlvbnMuZXJyb3IgPSBCYWNrYm9uZS53cmFwRXJyb3Iob3B0aW9ucy5lcnJvciwgbW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogJ3VwZGF0ZScsIHRoaXMsIG9wdGlvbnMpOwoKICAgICAgLy8gV2hlbiB1c2luZyBgd2FpdGAsIHJlc2V0IGF0dHJpYnV0ZXMgdG8gb3JpZ2luYWwgdmFsdWVzIHVubGVzcwogICAgICAvLyBgc3VjY2Vzc2AgaGFzIGJlZW4gY2FsbGVkIGFscmVhZHkuCiAgICAgIGlmICghZG9uZSAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICB0aGlzLmNsZWFyKHNpbGVudE9wdGlvbnMpOwogICAgICAgIHRoaXMuc2V0KGN1cnJlbnQsIHNpbGVudE9wdGlvbnMpOwogICAgICB9CgogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoKICAgICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoIW1vZGVsLmlzTmV3KCkpIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBvcHRpb25zLmVycm9yID0gQmFja2JvbmUud3JhcEVycm9yKG9wdGlvbnMuZXJyb3IsIG1vZGVsLCBvcHRpb25zKTsKICAgICAgdmFyIHhociA9IHRoaXMuc3luYygnZGVsZXRlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBkZXN0cm95KCk7CiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQogICAgLy8gdXNpbmcgQmFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAogICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KICAgIHVybDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBiYXNlID0gZ2V0VmFsdWUodGhpcywgJ3VybFJvb3QnKSB8fCBnZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24sICd1cmwnKSB8fCB1cmxFcnJvcigpOwogICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsKICAgICAgcmV0dXJuIGJhc2UgKyAoYmFzZS5jaGFyQXQoYmFzZS5sZW5ndGggLSAxKSA9PT0gJy8nID8gJycgOiAnLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIHRoZSBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYHNldGAgb24KICAgIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCB4aHIpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDYWxsIHRoaXMgbWV0aG9kIHRvIG1hbnVhbGx5IGZpcmUgYSBgImNoYW5nZSJgIGV2ZW50IGZvciB0aGlzIG1vZGVsIGFuZAogICAgLy8gYSBgImNoYW5nZTphdHRyaWJ1dGUiYCBldmVudCBmb3IgZWFjaCBjaGFuZ2VkIGF0dHJpYnV0ZS4KICAgIC8vIENhbGxpbmcgdGhpcyB3aWxsIGNhdXNlIGFsbCBvYmplY3RzIG9ic2VydmluZyB0aGUgbW9kZWwgdG8gdXBkYXRlLgogICAgY2hhbmdlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBjaGFuZ2luZyA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IHRydWU7CgogICAgICAvLyBTaWxlbnQgY2hhbmdlcyBiZWNvbWUgcGVuZGluZyBjaGFuZ2VzLgogICAgICBmb3IgKHZhciBhdHRyIGluIHRoaXMuX3NpbGVudCkgdGhpcy5fcGVuZGluZ1thdHRyXSA9IHRydWU7CgogICAgICAvLyBTaWxlbnQgY2hhbmdlcyBhcmUgdHJpZ2dlcmVkLgogICAgICB2YXIgY2hhbmdlcyA9IF8uZXh0ZW5kKHt9LCBvcHRpb25zLmNoYW5nZXMsIHRoaXMuX3NpbGVudCk7CiAgICAgIHRoaXMuX3NpbGVudCA9IHt9OwogICAgICBmb3IgKHZhciBhdHRyIGluIGNoYW5nZXMpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgYXR0ciwgdGhpcywgdGhpcy5nZXQoYXR0ciksIG9wdGlvbnMpOwogICAgICB9CiAgICAgIGlmIChjaGFuZ2luZykgcmV0dXJuIHRoaXM7CgogICAgICAvLyBDb250aW51ZSBmaXJpbmcgYCJjaGFuZ2UiYCBldmVudHMgd2hpbGUgdGhlcmUgYXJlIHBlbmRpbmcgY2hhbmdlcy4KICAgICAgd2hpbGUgKCFfLmlzRW1wdHkodGhpcy5fcGVuZGluZykpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nID0ge307CiAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICAvLyBQZW5kaW5nIGFuZCBzaWxlbnQgY2hhbmdlcyBzdGlsbCByZW1haW4uCiAgICAgICAgZm9yICh2YXIgYXR0ciBpbiB0aGlzLmNoYW5nZWQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wZW5kaW5nW2F0dHJdIHx8IHRoaXMuX3NpbGVudFthdHRyXSkgY29udGludWU7CiAgICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwogICAgICAgIH0KICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIG1vZGVsIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgIH0sCgogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlLCBvbGQgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuIEl0J3Mgb25seSBwb3NzaWJsZSB0bwogICAgLy8gZ2V0IGludG8gYW4gKmludmFsaWQqIHN0YXRlIGlmIHlvdSdyZSB1c2luZyBzaWxlbnQgY2hhbmdlcy4KICAgIGlzVmFsaWQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIXRoaXMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgbW9kZWwgYXR0cmlidXRlcywKICAgIC8vIHJldHVybmluZyBgdHJ1ZWAgaWYgYWxsIGlzIHdlbGwuIElmIGEgc3BlY2lmaWMgYGVycm9yYCBjYWxsYmFjayBoYXMKICAgIC8vIGJlZW4gcGFzc2VkLCBjYWxsIHRoYXQgaW5zdGVhZCBvZiBmaXJpbmcgdGhlIGdlbmVyYWwgYCJlcnJvciJgIGV2ZW50LgogICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucy5zaWxlbnQgfHwgIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0ZShhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmVycm9yKSB7CiAgICAgICAgb3B0aW9ucy5lcnJvcih0aGlzLCBlcnJvciwgb3B0aW9ucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIHRoaXMsIGVycm9yLCBvcHRpb25zKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBQcm92aWRlcyBhIHN0YW5kYXJkIGNvbGxlY3Rpb24gY2xhc3MgZm9yIG91ciBzZXRzIG9mIG1vZGVscywgb3JkZXJlZAogIC8vIG9yIHVub3JkZXJlZC4gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIHtzaWxlbnQ6IHRydWUsIHBhcnNlOiBvcHRpb25zLnBhcnNlfSk7CiAgfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4gUGFzcyAqKnNpbGVudCoqIHRvIGF2b2lkCiAgICAvLyBmaXJpbmcgdGhlIGBhZGRgIGV2ZW50IGZvciBldmVyeSBuZXcgbW9kZWwuCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgaSwgaW5kZXgsIGxlbmd0aCwgbW9kZWwsIGNpZCwgaWQsIGNpZHMgPSB7fSwgaWRzID0ge30sIGR1cHMgPSBbXTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgbW9kZWxzID0gXy5pc0FycmF5KG1vZGVscykgPyBtb2RlbHMuc2xpY2UoKSA6IFttb2RlbHNdOwoKICAgICAgLy8gQmVnaW4gYnkgdHVybmluZyBiYXJlIG9iamVjdHMgaW50byBtb2RlbCByZWZlcmVuY2VzLCBhbmQgcHJldmVudGluZwogICAgICAvLyBpbnZhbGlkIG1vZGVscyBvciBkdXBsaWNhdGUgbW9kZWxzIGZyb20gYmVpbmcgYWRkZWQuCiAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGlmICghKG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsc1tpXSwgb3B0aW9ucykpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbid0IGFkZCBhbiBpbnZhbGlkIG1vZGVsIHRvIGEgY29sbGVjdGlvbiIpOwogICAgICAgIH0KICAgICAgICBjaWQgPSBtb2RlbC5jaWQ7CiAgICAgICAgaWQgPSBtb2RlbC5pZDsKICAgICAgICBpZiAoY2lkc1tjaWRdIHx8IHRoaXMuX2J5Q2lkW2NpZF0gfHwgKChpZCAhPSBudWxsKSAmJiAoaWRzW2lkXSB8fCB0aGlzLl9ieUlkW2lkXSkpKSB7CiAgICAgICAgICBkdXBzLnB1c2goaSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgY2lkc1tjaWRdID0gaWRzW2lkXSA9IG1vZGVsOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcy4KICAgICAgaSA9IGR1cHMubGVuZ3RoOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgZHVwc1tpXSA9IG1vZGVscy5zcGxpY2UoZHVwc1tpXSwgMSlbMF07CiAgICAgIH0KCiAgICAgIC8vIExpc3RlbiB0byBhZGRlZCBtb2RlbHMnIGV2ZW50cywgYW5kIGluZGV4IG1vZGVscyBmb3IgbG9va3VwIGJ5CiAgICAgIC8vIGBpZGAgYW5kIGJ5IGBjaWRgLgogICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBtb2RlbHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAobW9kZWwgPSBtb2RlbHNbaV0pLm9uKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOwogICAgICAgIHRoaXMuX2J5Q2lkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQoKICAgICAgLy8gSW5zZXJ0IG1vZGVscyBpbnRvIHRoZSBjb2xsZWN0aW9uLCByZS1zb3J0aW5nIGlmIG5lZWRlZCwgYW5kIHRyaWdnZXJpbmcKICAgICAgLy8gYGFkZGAgZXZlbnRzIHVubGVzcyBzaWxlbmNlZC4KICAgICAgdGhpcy5sZW5ndGggKz0gbGVuZ3RoOwogICAgICBpbmRleCA9IG9wdGlvbnMuYXQgIT0gbnVsbCA/IG9wdGlvbnMuYXQgOiB0aGlzLm1vZGVscy5sZW5ndGg7CiAgICAgIHNwbGljZS5hcHBseSh0aGlzLm1vZGVscywgW2luZGV4LCAwXS5jb25jYXQobW9kZWxzKSk7CgogICAgICAvLyBNZXJnZSBpbiBkdXBsaWNhdGUgbW9kZWxzLgogICAgICBpZiAob3B0aW9ucy5tZXJnZSkgewogICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IGR1cHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChtb2RlbCA9IHRoaXMuX2J5SWRbZHVwc1tpXS5pZF0pIG1vZGVsLnNldChkdXBzW2ldLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmICh0aGlzLmNvbXBhcmF0b3IgJiYgb3B0aW9ucy5hdCA9PSBudWxsKSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgaWYgKG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsKICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIWNpZHNbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIGNvbnRpbnVlOwogICAgICAgIG9wdGlvbnMuaW5kZXggPSBpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4gUGFzcyBzaWxlbnQgdG8gYXZvaWQKICAgIC8vIGZpcmluZyB0aGUgYHJlbW92ZWAgZXZlbnQgZm9yIGV2ZXJ5IG1vZGVsIHJlbW92ZWQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSB0aGlzLmdldEJ5Q2lkKG1vZGVsc1tpXSkgfHwgdGhpcy5nZXQobW9kZWxzW2ldKTsKICAgICAgICBpZiAoIW1vZGVsKSBjb250aW51ZTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5pZF07CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5Q2lkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHRoaXMuYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogMH0sIG9wdGlvbnMpKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKGJlZ2luLCBlbmQpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzLnNsaWNlKGJlZ2luLCBlbmQpOwogICAgfSwKCiAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCiAgICBnZXQ6IGZ1bmN0aW9uKGlkKSB7CiAgICAgIGlmIChpZCA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtpZC5pZCAhPSBudWxsID8gaWQuaWQgOiBpZF07CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBjbGllbnQgaWQuCiAgICBnZXRCeUNpZDogZnVuY3Rpb24oY2lkKSB7CiAgICAgIHJldHVybiBjaWQgJiYgdGhpcy5fYnlDaWRbY2lkLmNpZCB8fCBjaWRdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YgYGZpbHRlcmAuCiAgICB3aGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKICAgICAgdmFyIGJvdW5kQ29tcGFyYXRvciA9IF8uYmluZCh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICBpZiAodGhpcy5jb21wYXJhdG9yLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHRoaXMubW9kZWxzID0gdGhpcy5zb3J0QnkoYm91bmRDb21wYXJhdG9yKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm1vZGVscy5zb3J0KGJvdW5kQ29tcGFyYXRvcik7CiAgICAgIH0KICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLm1hcCh0aGlzLm1vZGVscywgZnVuY3Rpb24obW9kZWwpeyByZXR1cm4gbW9kZWwuZ2V0KGF0dHIpOyB9KTsKICAgIH0sCgogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG1vZGVscyAgfHwgKG1vZGVscyA9IFtdKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0pOwogICAgICB9CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGBhZGQ6IHRydWVgIGlzIHBhc3NlZCwgYXBwZW5kcyB0aGUKICAgIC8vIG1vZGVscyB0byB0aGUgY29sbGVjdGlvbiBpbnN0ZWFkIG9mIHJlc2V0dGluZy4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgICBjb2xsZWN0aW9uW29wdGlvbnMuYWRkID8gJ2FkZCcgOiAncmVzZXQnXShjb2xsZWN0aW9uLnBhcnNlKHJlc3AsIHhociksIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICBvcHRpb25zLmVycm9yID0gQmFja2JvbmUud3JhcEVycm9yKG9wdGlvbnMuZXJyb3IsIGNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICB2YXIgY29sbCA9IHRoaXM7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGNvbGwuYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCByZXNwLCBvcHRpb25zKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY29sbC5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgaXQgdGhyb3VnaC4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCB4aHIpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5tb2RlbHMpOwogICAgfSwKCiAgICAvLyBQcm94eSB0byBfJ3MgY2hhaW4uIENhbid0IGJlIHByb3hpZWQgdGhlIHNhbWUgd2F5IHRoZSByZXN0IG9mIHRoZQogICAgLy8gdW5kZXJzY29yZSBtZXRob2RzIGFyZSBwcm94aWVkIGJlY2F1c2UgaXQgcmVsaWVzIG9uIHRoZSB1bmRlcnNjb3JlCiAgICAvLyBjb25zdHJ1Y3Rvci4KICAgIGNoYWluOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8odGhpcy5tb2RlbHMpLmNoYWluKCk7CiAgICB9LAoKICAgIC8vIFJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24gaXMgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICB0aGlzLl9ieUlkICA9IHt9OwogICAgICB0aGlzLl9ieUNpZCA9IHt9OwogICAgfSwKCiAgICAvLyBQcmVwYXJlIGEgbW9kZWwgb3IgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIGJlIGFkZGVkIHRvIHRoaXMgY29sbGVjdGlvbi4KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CiAgICAgICAgaWYgKCFhdHRycy5jb2xsZWN0aW9uKSBhdHRycy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgIH0KICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgb3B0aW9ucy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIG1vZGVsID0gbmV3IHRoaXMubW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICBpZiAoIW1vZGVsLl92YWxpZGF0ZShtb2RlbC5hdHRyaWJ1dGVzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byByZW1vdmUgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ3JlZHVjZScsICdyZWR1Y2VSaWdodCcsICdmaW5kJywKICAgICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsICdyZWplY3QnLCAnZXZlcnknLCAnYWxsJywgJ3NvbWUnLCAnYW55JywKICAgICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsICdtYXgnLCAnbWluJywgJ3NvcnRCeScsICdzb3J0ZWRJbmRleCcsCiAgICAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2luaXRpYWwnLCAncmVzdCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnaW5kZXhPZicsCiAgICAnc2h1ZmZsZScsICdsYXN0SW5kZXhPZicsICdpc0VtcHR5JywgJ2dyb3VwQnknXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBbdGhpcy5tb2RlbHNdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuUm91dGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQogIC8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCiAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5yb3V0ZXMpIHRoaXMucm91dGVzID0gb3B0aW9ucy5yb3V0ZXM7CiAgICB0aGlzLl9iaW5kUm91dGVzKCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCiAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KICB2YXIgbmFtZWRQYXJhbSAgICA9IC86XHcrL2c7CiAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bLVtcXXt9KCkrPy4sXFxeJHwjXHNdL2c7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkgfHwgKEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeSk7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgXy5iaW5kKGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSB0aGlzLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwogICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwogICAgICAgIEJhY2tib25lLmhpc3RvcnkudHJpZ2dlcigncm91dGUnLCB0aGlzLCBuYW1lLCBhcmdzKTsKICAgICAgfSwgdGhpcykpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgogICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CiAgICAgIHZhciByb3V0ZXMgPSBbXTsKICAgICAgZm9yICh2YXIgcm91dGUgaW4gdGhpcy5yb3V0ZXMpIHsKICAgICAgICByb3V0ZXMudW5zaGlmdChbcm91dGUsIHRoaXMucm91dGVzW3JvdXRlXV0pOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gcm91dGVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHRoaXMucm91dGUocm91dGVzW2ldWzBdLCByb3V0ZXNbaV1bMV0sIHRoaXNbcm91dGVzW2ldWzFdXSk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKICAgIC8vIGFnYWluc3QgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaC4KICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbihyb3V0ZSkgewogICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShuYW1lZFBhcmFtLCAnKFteXC9dKyknKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyguKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIHBhcmFtZXRlcnMuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICByZXR1cm4gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5IaXN0b3J5CiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBVUkwgZnJhZ21lbnRzLiBJZiB0aGUKICAvLyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgYG9uaGFzaGNoYW5nZWAsIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KICB2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmhhbmRsZXJzID0gW107CiAgICBfLmJpbmRBbGwodGhpcywgJ2NoZWNrVXJsJyk7CiAgICB0aGlzLmxvY2F0aW9uID0gb3B0aW9ucyAmJiBvcHRpb25zLmxvY2F0aW9uIHx8IHJvb3QubG9jYXRpb247CiAgICB0aGlzLmhpc3RvcnkgPSBvcHRpb25zICYmIG9wdGlvbnMuaGlzdG9yeSB8fCByb290Lmhpc3Rvcnk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBjbGVhbmluZyBsZWFkaW5nIGhhc2hlcyBhbmQgc2xhc2hlcyAuCiAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBkZXRlY3RpbmcgTVNJRS4KICB2YXIgaXNFeHBsb3JlciA9IC9tc2llIFtcdy5dKy87CgogIC8vIENhY2hlZCByZWdleCBmb3IgcmVtb3ZpbmcgYSB0cmFpbGluZyBzbGFzaC4KICB2YXIgdHJhaWxpbmdTbGFzaCA9IC9cLyQvOwoKICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCiAgICAvLyB0d2VudHkgdGltZXMgYSBzZWNvbmQuCiAgICBpbnRlcnZhbDogNTAsCgogICAgLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwogICAgLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCiAgICBnZXRIYXNoOiBmdW5jdGlvbih3aW5kb3cpIHsKICAgICAgdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAogICAgLy8gdGhlIGhhc2gsIG9yIHRoZSBvdmVycmlkZS4KICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbihmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsKICAgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UgfHwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5sb2NhdGlvbi5wYXRobmFtZTsKICAgICAgICAgIHZhciByb290ID0gdGhpcy5vcHRpb25zLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc3Vic3RyKHJvb3QubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChmcmFnbWVudC5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKSk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHt9LCB7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwogICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSAgPSAhIXRoaXMub3B0aW9ucy5wdXNoU3RhdGU7CiAgICAgIHRoaXMuX2hhc1B1c2hTdGF0ZSAgICA9ICEhKHRoaXMub3B0aW9ucy5wdXNoU3RhdGUgJiYgdGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5wdXNoU3RhdGUpOwogICAgICB2YXIgZnJhZ21lbnQgICAgICAgICAgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIHZhciBkb2NNb2RlICAgICAgICAgICA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgdmFyIG9sZElFICAgICAgICAgICAgID0gKGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpKTsKCiAgICAgIC8vIE5vcm1hbGl6ZSByb290IHRvIGFsd2F5cyBpbmNsdWRlIHRyYWlsaW5nIHNsYXNoCiAgICAgIGlmICghdHJhaWxpbmdTbGFzaC50ZXN0KHRoaXMub3B0aW9ucy5yb290KSkgdGhpcy5vcHRpb25zLnJvb3QgKz0gJy8nOwoKICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuaWZyYW1lID0gQmFja2JvbmUuJCgnPGlmcmFtZSBzcmM9ImphdmFzY3JpcHQ6MCIgdGFiaW5kZXg9Ii0xIiAvPicpLmhpZGUoKS5hcHBlbmRUbygnYm9keScpWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgdGhpcy5uYXZpZ2F0ZShmcmFnbWVudCk7CiAgICAgIH0KCiAgICAgIC8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSBvciBoYXNoZXMsIGFuZCB3aGV0aGVyCiAgICAgIC8vICdvbmhhc2hjaGFuZ2UnIGlzIHN1cHBvcnRlZCwgZGV0ZXJtaW5lIGhvdyB3ZSBjaGVjayB0aGUgVVJMIHN0YXRlLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLmJpbmQoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmICgnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cpICYmICFvbGRJRSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5iaW5kKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CiAgICAgIHZhciBhdFJvb3QgPSAobG9jLnBhdGhuYW1lLnJlcGxhY2UoL1teL10kLywgJyQmLycpID09PSB0aGlzLm9wdGlvbnMucm9vdCkgJiYgIWxvYy5zZWFyY2g7CgogICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQgYnJvd3NlciwKICAgICAgLy8gYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSAmJiAhdGhpcy5faGFzUHVzaFN0YXRlICYmICFhdFJvb3QpIHsKICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5vcHRpb25zLnJvb3QgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgIC8vIFJldHVybiBpbW1lZGlhdGVseSBhcyBicm93c2VyIHdpbGwgZG8gcmVkaXJlY3QgdG8gbmV3IHVybAogICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgLy8gaW4gYSBicm93c2VyIHdoZXJlIGl0IGNvdWxkIGJlIGBwdXNoU3RhdGVgLWJhc2VkIGluc3RlYWQuLi4KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c1B1c2hTdGF0ZSAmJiB0aGlzLl9oYXNQdXNoU3RhdGUgJiYgYXRSb290ICYmIGxvYy5oYXNoKSB7CiAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCBsb2MucHJvdG9jb2wgKyAnLy8nICsgbG9jLmhvc3QgKyB0aGlzLm9wdGlvbnMucm9vdCArIHRoaXMuZnJhZ21lbnQpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykudW5iaW5kKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLnVuYmluZCgnaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKSB8fCB0aGlzLmxvYWRVcmwodGhpcy5nZXRIYXNoKCkpOwogICAgfSwKCiAgICAvLyBBdHRlbXB0IHRvIGxvYWQgdGhlIGN1cnJlbnQgVVJMIGZyYWdtZW50LiBJZiBhIHJvdXRlIHN1Y2NlZWRzIHdpdGggYQogICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKICAgIC8vIHJldHVybnMgYGZhbHNlYC4KICAgIGxvYWRVcmw6IGZ1bmN0aW9uKGZyYWdtZW50T3ZlcnJpZGUpIHsKICAgICAgdmFyIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnRPdmVycmlkZSk7CiAgICAgIHZhciBtYXRjaGVkID0gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7CiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBtYXRjaGVkOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiBvcHRpb25zfTsKICAgICAgdmFyIGZyYWcgPSAoZnJhZ21lbnQgfHwgJycpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZykgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZzsKICAgICAgdmFyIHVybCA9IChmcmFnLmluZGV4T2YodGhpcy5vcHRpb25zLnJvb3QpICE9PSAwID8gdGhpcy5vcHRpb25zLnJvb3QgOiAnJykgKyBmcmFnOwoKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgogICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZywgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWcgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CiAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAvLyB3YW50IHRoaXMuCiAgICAgICAgICBpZighb3B0aW9ucy5yZXBsYWNlKSB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWcsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgfQoKICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCiAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpICsgJyMnICsgZnJhZ21lbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIGxvY2F0aW9uLmhhc2ggPSBmcmFnbWVudDsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgIHRoaXMuX2NvbmZpZ3VyZShvcHRpb25zIHx8IHt9KTsKICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogIH07CgogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLgogIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KICB2YXIgdmlld09wdGlvbnMgPSBbJ21vZGVsJywgJ2NvbGxlY3Rpb24nLCAnZWwnLCAnaWQnLCAnYXR0cmlidXRlcycsICdjbGFzc05hbWUnLCAndGFnTmFtZSddOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuVmlldyoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoVmlldy5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIFZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCiAgICB0YWdOYW1lOiAnZGl2JywKCiAgICAvLyBqUXVlcnkgZGVsZWdhdGUgZm9yIGVsZW1lbnQgbG9va3VwLCBzY29wZWQgdG8gRE9NIGVsZW1lbnRzIHdpdGhpbiB0aGUKICAgIC8vIGN1cnJlbnQgdmlldy4gVGhpcyBzaG91bGQgYmUgcHJlZmVyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgZnJvbSB0aGUgRE9NLiBOb3RlIHRoYXQgdGhlIHZpZXcgaXNuJ3QgcHJlc2VudCBpbiB0aGUKICAgIC8vIERPTSBieSBkZWZhdWx0LCBzbyBjYWxsaW5nIHRoaXMgbWV0aG9kIG1heSBiZSBhIG5vLW9wLgogICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwucmVtb3ZlKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBGb3Igc21hbGwgYW1vdW50cyBvZiBET00gRWxlbWVudHMsIHdoZXJlIGEgZnVsbC1ibG93biB0ZW1wbGF0ZSBpc24ndAogICAgLy8gbmVlZGVkLCB1c2UgKiptYWtlKiogdG8gbWFudWZhY3R1cmUgZWxlbWVudHMsIG9uZSBhdCBhIHRpbWUuCiAgICAvLwogICAgLy8gICAgIHZhciBlbCA9IHRoaXMubWFrZSgnbGknLCB7J2NsYXNzJzogJ3Jvdyd9LCB0aGlzLm1vZGVsLmVzY2FwZSgndGl0bGUnKSk7CiAgICAvLwogICAgbWFrZTogZnVuY3Rpb24odGFnTmFtZSwgYXR0cmlidXRlcywgY29udGVudCkgewogICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOwogICAgICBpZiAoYXR0cmlidXRlcykgQmFja2JvbmUuJChlbCkuYXR0cihhdHRyaWJ1dGVzKTsKICAgICAgaWYgKGNvbnRlbnQgIT0gbnVsbCkgQmFja2JvbmUuJChlbCkuaHRtbChjb250ZW50KTsKICAgICAgcmV0dXJuIGVsOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gZ2V0VmFsdWUodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybjsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIHRocm93IG5ldyBFcnJvcignTWV0aG9kICInICsgZXZlbnRzW2tleV0gKyAnIiBkb2VzIG5vdCBleGlzdCcpOwogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5iaW5kKGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kZWwuZGVsZWdhdGUoc2VsZWN0b3IsIGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnVuYmluZCgnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgIH0sCgogICAgLy8gUGVyZm9ybXMgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbiBvZiBhIFZpZXcgd2l0aCBhIHNldCBvZiBvcHRpb25zLgogICAgLy8gS2V5cyB3aXRoIHNwZWNpYWwgbWVhbmluZyAqKG1vZGVsLCBjb2xsZWN0aW9uLCBpZCwgY2xhc3NOYW1lKSosIGFyZQogICAgLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIHZpZXcuCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzLm9wdGlvbnMpIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2aWV3T3B0aW9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIgYXR0ciA9IHZpZXdPcHRpb25zW2ldOwogICAgICAgIGlmIChvcHRpb25zW2F0dHJdKSB0aGlzW2F0dHJdID0gb3B0aW9uc1thdHRyXTsKICAgICAgfQogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfSwKCiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdAogICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQogICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgIHZhciBhdHRycyA9IF8uZXh0ZW5kKHt9LCBnZXRWYWx1ZSh0aGlzLCAnYXR0cmlidXRlcycpKTsKICAgICAgICBpZiAodGhpcy5pZCkgYXR0cnMuaWQgPSBnZXRWYWx1ZSh0aGlzLCAnaWQnKTsKICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gZ2V0VmFsdWUodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgIHRoaXMuc2V0RWxlbWVudCh0aGlzLm1ha2UoZ2V0VmFsdWUodGhpcywgJ3RhZ05hbWUnKSwgYXR0cnMpLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KHRoaXMuZWwsIGZhbHNlKTsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gVGhlIHNlbGYtcHJvcGFnYXRpbmcgZXh0ZW5kIGZ1bmN0aW9uIHRoYXQgQmFja2JvbmUgY2xhc3NlcyB1c2UuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIGNsYXNzUHJvcHMpIHsKICAgIHJldHVybiBpbmhlcml0cyh0aGlzLCBwcm90b1Byb3BzLCBjbGFzc1Byb3BzKTsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgYW5kIHZpZXcuCiAgTW9kZWwuZXh0ZW5kID0gQ29sbGVjdGlvbi5leHRlbmQgPSBSb3V0ZXIuZXh0ZW5kID0gVmlldy5leHRlbmQgPSBleHRlbmQ7CgogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ2RlbGV0ZSc6ICdERUxFVEUnLAogICAgJ3JlYWQnOiAgICdHRVQnCiAgfTsKCiAgLy8gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiB0byBjaGFuZ2UgdGhlIG1hbm5lciBpbiB3aGljaCBCYWNrYm9uZSBwZXJzaXN0cwogIC8vIG1vZGVscyB0byB0aGUgc2VydmVyLiBZb3Ugd2lsbCBiZSBwYXNzZWQgdGhlIHR5cGUgb2YgcmVxdWVzdCwgYW5kIHRoZQogIC8vIG1vZGVsIGluIHF1ZXN0aW9uLiBCeSBkZWZhdWx0LCBtYWtlcyBhIFJFU1RmdWwgQWpheCByZXF1ZXN0CiAgLy8gdG8gdGhlIG1vZGVsJ3MgYHVybCgpYC4gU29tZSBwb3NzaWJsZSBjdXN0b21pemF0aW9ucyBjb3VsZCBiZToKICAvLwogIC8vICogVXNlIGBzZXRUaW1lb3V0YCB0byBiYXRjaCByYXBpZC1maXJlIHVwZGF0ZXMgaW50byBhIHNpbmdsZSByZXF1ZXN0LgogIC8vICogU2VuZCB1cCB0aGUgbW9kZWxzIGFzIFhNTCBpbnN0ZWFkIG9mIEpTT04uCiAgLy8gKiBQZXJzaXN0IG1vZGVscyB2aWEgV2ViU29ja2V0cyBpbnN0ZWFkIG9mIEFqYXguCiAgLy8KICAvLyBUdXJuIG9uIGBCYWNrYm9uZS5lbXVsYXRlSFRUUGAgaW4gb3JkZXIgdG8gc2VuZCBgUFVUYCBhbmQgYERFTEVURWAgcmVxdWVzdHMKICAvLyBhcyBgUE9TVGAsIHdpdGggYSBgX21ldGhvZGAgcGFyYW1ldGVyIGNvbnRhaW5pbmcgdGhlIHRydWUgSFRUUCBtZXRob2QsCiAgLy8gYXMgd2VsbCBhcyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgYm9keSBhcyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAogIC8vIGluc3RlYWQgb2YgYGFwcGxpY2F0aW9uL2pzb25gIHdpdGggdGhlIG1vZGVsIGluIGEgcGFyYW0gbmFtZWQgYG1vZGVsYC4KICAvLyBVc2VmdWwgd2hlbiBpbnRlcmZhY2luZyB3aXRoIHNlcnZlci1zaWRlIGxhbmd1YWdlcyBsaWtlICoqUEhQKiogdGhhdCBtYWtlCiAgLy8gaXQgZGlmZmljdWx0IHRvIHJlYWQgdGhlIGJvZHkgb2YgYFBVVGAgcmVxdWVzdHMuCiAgQmFja2JvbmUuc3luYyA9IGZ1bmN0aW9uKG1ldGhvZCwgbW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciB0eXBlID0gbWV0aG9kTWFwW21ldGhvZF07CgogICAgLy8gRGVmYXVsdCBvcHRpb25zLCB1bmxlc3Mgc3BlY2lmaWVkLgogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAvLyBEZWZhdWx0IEpTT04tcmVxdWVzdCBvcHRpb25zLgogICAgdmFyIHBhcmFtcyA9IHt0eXBlOiB0eXBlLCBkYXRhVHlwZTogJ2pzb24nfTsKCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIGEgVVJMLgogICAgaWYgKCFvcHRpb25zLnVybCkgewogICAgICBwYXJhbXMudXJsID0gZ2V0VmFsdWUobW9kZWwsICd1cmwnKSB8fCB1cmxFcnJvcigpOwogICAgfQoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgdGhlIGFwcHJvcHJpYXRlIHJlcXVlc3QgZGF0YS4KICAgIGlmICghb3B0aW9ucy5kYXRhICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScpKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShtb2RlbCk7CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KICAgIGlmIChCYWNrYm9uZS5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChCYWNrYm9uZS5lbXVsYXRlSFRUUCkgewogICAgICBpZiAodHlwZSA9PT0gJ1BVVCcgfHwgdHlwZSA9PT0gJ0RFTEVURScpIHsKICAgICAgICBpZiAoQmFja2JvbmUuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICAgIHBhcmFtcy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgIH07CiAgICAgIH0KICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFCYWNrYm9uZS5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMucHJvY2Vzc0RhdGEgPSBmYWxzZTsKICAgIH0KCiAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLgogICAgcmV0dXJuIEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gU2V0IHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGBCYWNrYm9uZS5hamF4YCB0byBwcm94eSB0aHJvdWdoIHRvIGAkYC4KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gV3JhcCBhbiBvcHRpb25hbCBlcnJvciBjYWxsYmFjayB3aXRoIGEgZmFsbGJhY2sgZXJyb3IgZXZlbnQuCiAgQmFja2JvbmUud3JhcEVycm9yID0gZnVuY3Rpb24ob25FcnJvciwgb3JpZ2luYWxNb2RlbCwgb3B0aW9ucykgewogICAgcmV0dXJuIGZ1bmN0aW9uKG1vZGVsLCByZXNwKSB7CiAgICAgIHJlc3AgPSBtb2RlbCA9PT0gb3JpZ2luYWxNb2RlbCA/IHJlc3AgOiBtb2RlbDsKICAgICAgaWYgKG9uRXJyb3IpIHsKICAgICAgICBvbkVycm9yKG9yaWdpbmFsTW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIG9yaWdpbmFsTW9kZWwudHJpZ2dlcignZXJyb3InLCBvcmlnaW5hbE1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfQogICAgfTsKICB9OwoKICAvLyBIZWxwZXJzCiAgLy8gLS0tLS0tLQoKICAvLyBTaGFyZWQgZW1wdHkgY29uc3RydWN0b3IgZnVuY3Rpb24gdG8gYWlkIGluIHByb3RvdHlwZS1jaGFpbiBjcmVhdGlvbi4KICB2YXIgY3RvciA9IGZ1bmN0aW9uKCl7fTsKCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCiAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogIHZhciBpbmhlcml0cyA9IGZ1bmN0aW9uKHBhcmVudCwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBjaGlsZDsKCiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBwcm90b1Byb3BzLmhhc093blByb3BlcnR5KCdjb25zdHJ1Y3RvcicpKSB7CiAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CiAgICB9CgogICAgLy8gSW5oZXJpdCBjbGFzcyAoc3RhdGljKSBwcm9wZXJ0aWVzIGZyb20gcGFyZW50LgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCk7CgogICAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKICAgIC8vIGBwYXJlbnRgJ3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7CiAgICBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOwoKICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAogICAgLy8gaWYgc3VwcGxpZWQuCiAgICBpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCiAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgIGlmIChzdGF0aWNQcm9wcykgXy5leHRlbmQoY2hpbGQsIHN0YXRpY1Byb3BzKTsKCiAgICAvLyBDb3JyZWN0bHkgc2V0IGNoaWxkJ3MgYHByb3RvdHlwZS5jb25zdHJ1Y3RvcmAuCiAgICBjaGlsZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjaGlsZDsKCiAgICAvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkIGxhdGVyLgogICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgICByZXR1cm4gY2hpbGQ7CiAgfTsKCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGdldCBhIHZhbHVlIGZyb20gYSBCYWNrYm9uZSBvYmplY3QgYXMgYSBwcm9wZXJ0eQogIC8vIG9yIGFzIGEgZnVuY3Rpb24uCiAgdmFyIGdldFZhbHVlID0gZnVuY3Rpb24ob2JqZWN0LCBwcm9wKSB7CiAgICBpZiAoIShvYmplY3QgJiYgb2JqZWN0W3Byb3BdKSkgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKG9iamVjdFtwcm9wXSkgPyBvYmplY3RbcHJvcF0oKSA6IG9iamVjdFtwcm9wXTsKICB9OwoKICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCiAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsKICB9OwoKfSkuY2FsbCh0aGlzKTsKCmRlZmluZSgiYmFja2JvbmUiLCBbImxvZGFzaCIsImpxdWVyeSJdLCAoZnVuY3Rpb24gKGdsb2JhbCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZ2xvYmFsLkJhY2tib25lOwogICAgfQp9KHRoaXMpKSk7CgovKiEgVGhydXN0IEpTIEZyYW1ld29yayAtIHYwLjEuMCAtIDIwMTItMDgtMjkKKiB0aHJ1c3QtaG9tZQoqIENvcHlyaWdodCAoYykgMjAxMiBEYXZpZCBEcmlzY29sbDsgTGljZW5zZWQgTUlUICovCgoKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvbWFpbicsWwogICAgJ3RocnVzdC91dGlsJywgJ3RocnVzdC9sb2cnLCAndGhydXN0L2V2ZW50cycsICd0aHJ1c3QvZmFjYWRlJwpdLApmdW5jdGlvbiAodXRpbCwgbG9nLCBFdmVudHMsIGZhY2FkZSkKewogICAgCiAgICAvLyBWYXJpYWJsZSBkZWNsYXJhdGlvbi4KICAgIHZhciBmb3JtYXQgID0gdXRpbC5mb3JtYXQsICAgLy8gc3RyaW5nIGZvcm1hdCBtZXRob2QKICAgICAgICBleHRlbmQgID0gdXRpbC5leHRlbmQsICAgLy8gb2JqZWN0IGV4dGVuc2lvbiBtZXRob2QKICAgICAgICB0eXBlICAgID0gdXRpbC50eXBlLCAgICAgICAvLyBvYmplY3QgdHlwZSBtZXRob2QKICAgICAgICB3aGVuICAgID0gdXRpbC53aGVuLAogICAgICAgIG1lbW9pemUgPSB1dGlsLm1lbW9pemUsCiAgICAgICAgbWVkaWF0b3IsCiAgICAgICAgc2xpY2UgICA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCiAgICAvLyNyZWdpb24gRmFjYWRlCiAgICAvKioKICAgIENyZWF0ZXMgYSBuZXcgbWVkaWF0b3IgZmFjYWRlIGZvciB0aGUgZ2l2ZW4gbW9kdWxlLgoKICAgIEBjbGFzcyB0aHJ1c3QtbWVkaWF0b3ItTWVkaWF0b3JGYWNhZGUKICAgICoqLwogICAgdmFyIE1lZGlhdG9yRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kdWxlLCBwYXJlbnQpCiAgICB7CiAgICAgICAgdGhpcy5uYW1lICAgICAgICAgID0gbW9kdWxlLm5hbWU7CiAgICAgICAgdGhpcy5tb2R1bGUgICAgICAgID0gbW9kdWxlOwogICAgICAgIHRoaXMucGFyZW50ICAgICAgICA9IHBhcmVudDsKICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICB0aGlzLl9jYWxsYmFja3MgICAgPSBwYXJlbnQuX2NhbGxiYWNrczsKICAgICAgICB0aGlzLmluaXRFdmVudHMoKTsKICAgIH0pOwogICAgdXRpbC5leHRlbmQoTWVkaWF0b3JGYWNhZGUuZm4sIEV2ZW50cyk7CgogICAgLyoqCiAgICBEdXJpbmcgdGhlIHN0YXJ0IG9mIGEgbWVkaWF0b3IgZmFjYWRlLCBzdGFydCBjcmVhdGVzIHRoZSBpbnRlcm5hbCBzdWJzY3JpcHRpb25zIGFycmF5LgoKICAgIEBmb3IgdGhydXN0LW1lZGlhdG9yLU1lZGlhdG9yRmFjYWRlCiAgICBAbWV0aG9kIHN0YXJ0CiAgICAqKi8KICAgIE1lZGlhdG9yRmFjYWRlLmZuLmluaXQgPSBNZWRpYXRvckZhY2FkZS5mbi5zdGFydCA9IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgaWYgKCF0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMpCiAgICAgICAgICAgIHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucyA9IFtdOwogICAgfTsKCiAgICBNZWRpYXRvckZhY2FkZS5mbi5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkKICAgIHsKICAgICAgICB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMucHVzaCh7IGV2ZW50czogZXZlbnRzLCBjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQgfSk7CiAgICAgICAgRXZlbnRzLnN1YnNjcmliZS5jYWxsKHRoaXMsIGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgfTsKCiAgICBNZWRpYXRvckZhY2FkZS5mbi5zdG9wID0gZnVuY3Rpb24gKGZhY2FkZSkKICAgIHsKICAgICAgICB2YXIgbW9kdWxlID0gZmFjYWRlLm1vZHVsZTsKCiAgICAgICAgaWYgKHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucykKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBzdWIgPSB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnNbaV07CiAgICAgICAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKHN1Yi5ldmVudHMsIHN1Yi5jYWxsYmFjaywgc3ViLmNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnM7CiAgICAgICAgfQogICAgfQoKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8gT3VyIGRlZmF1bHQgbmFtZXNwYWNlIHByZWZpeC4KCiAgICAvKioKICAgIE1lZGlhdG9yIGNsYXNzLgogICAgVGhpcyBjcmVhdGVzIGEgaW5zdGFuY2Ugb2YgdGhlIG1lZGlhdG9yLCBmb3IgdXNlIGluc2lkZSB0aHJ1c3QuCgogICAgQGNsYXNzIHRocnVzdC1tZWRpYXRvci1NZWRpYXRvcgogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIG1lZGlhdG9yLgogICAgKiovCiAgICB2YXIgTWVkaWF0b3IgPSBmdW5jdGlvbiAoLyogJHJlZiAqLyBuYW1lKQogICAgewogICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBNZWRpYXRvcikpCiAgICAgICAgICAgIHJldHVybiBuZXcgTWVkaWF0b3IobmFtZSk7CgogICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICB0aGF0Lm5hbWUgPSBuYW1lOwogICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQoJ01lZGlhdG9yOiBDcmVhdGluZyBuZXcgTWVkaWF0b3IgezB9JywgbmFtZSkpOwoKICAgICAgICB0aGF0LmluaXRFdmVudHMoKTsKCiAgICAgICAgdGhhdC5zdWJzY3JpYmUoJ3RocnVzdC9yZWFkeScsIGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICBsb2cuaW5mbygnTWVkaWF0b3I6IFJlYWR5IScpOwogICAgICAgIH0pOwoKICAgICAgICB0aGF0LnN1YnNjcmliZSgndGhydXN0L25hdmlnYXRlJywgZnVuY3Rpb24gKHBhdGgpCiAgICAgICAgewogICAgICAgICAgICBpZiAocGF0aCA9PT0gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lKQogICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpOwogICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSB1dGlsLmZpeHVwVXJsKHBhdGgpOwogICAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgTWVkaWF0b3JQcm90b3R5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyBNZWRpYXRvckZhY2FkZSwgYmFzZWQgb24gdGhlIGdpdmVuIG1vZHVsZS4KCiAgICAgICAgQGZvciB0aHJ1c3QtbWVkaWF0b3ItTWVkaWF0b3IKICAgICAgICBAbWV0aG9kIGNyZWF0ZUZhY2FkZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGVEZWZuIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yLgogICAgICAgICoqLwogICAgICAgIGNyZWF0ZUZhY2FkZTogZnVuY3Rpb24gKHRocnVzdCwgbW9kdWxlLCBmYWNhZGVzKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKG1vZHVsZS5tZWRpYXRvciAmJiAhKGZhY2FkZXMubWVkaWF0b3IgaW5zdGFuY2VvZiBNZWRpYXRvckZhY2FkZSkpIHRocm93IG5ldyBFcnJvcignIm1lZGlhdG9yIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CgogICAgICAgICAgICB2YXIgbWVkaWF0b3I7CiAgICAgICAgICAgIGlmIChmYWNhZGVzLm1lZGlhdG9yKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLnVwZGF0ZUZhY2FkZShtb2R1bGUsIHRoaXMpOwogICAgICAgICAgICAgICAgbWVkaWF0b3IgPSBmYWNhZGVzLm1lZGlhdG9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWVkaWF0b3IgPSBmYWNhZGVzLm1lZGlhdG9yID0gbW9kdWxlLm1lZGlhdG9yID0gbmV3IE1lZGlhdG9yRmFjYWRlKG1vZHVsZSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1lZGlhdG9yOwogICAgICAgIH0KICAgIH07CgogICAgdXRpbC5leHRlbmQoTWVkaWF0b3JQcm90b3R5cGUsIEV2ZW50cyk7CgogICAgLy8gRXh0ZW5kIG91ciBwcm90b3R5cGUgdG8gaW5jbHVkZSB0aGUgcHJvdG90eXBlIGdlbmVyYXRlZCBhYm92ZS4KICAgIE1lZGlhdG9yLnByb3RvdHlwZSA9IE1lZGlhdG9yLmZuID0gTWVkaWF0b3JQcm90b3R5cGU7CgogICAgcmV0dXJuIE1lZGlhdG9yOwp9KTsKCmRlZmluZSgndGhydXN0L21lZGlhdG9yJywgWyd0aHJ1c3QvbWVkaWF0b3IvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9tZWRpYXRvci9jb252ZW50aW9uL2F1dG9zdGFydCcsWyd0aHJ1c3QvY29udmVudGlvbiddLApmdW5jdGlvbiAoQ29udmVudGlvbikKewogICAgLyoqCiAgICBTaW1wbGUgbWVkaWF0b3IgY29udmVudGlvbiB0byBjYXB0dXJlIHRoZSBhdXRvU3RhcnQgcHJvcGVydHkgb24gYSBtb2R1bGUuCgogICAgVGhlIGF1dG9TdGFydCBwcm9wZXJ0eSwgaW5kaWNhdGVzIHRoYXQgdGhlIG1vZHVsZSBzaG91bGQgYXV0b21hdGljYWxseSBzdGFydCB3aXRoIHRoZSB0aHJ1c3QgaW5zdGFuY2UsIG9yIHdoZW4gaXQgaXMgYWRkZWQgdG8gdGhlIHRocnVzdCBpbnN0YW5jZS4KCiAgICBAbW9kdWxlIHRocnVzdC1tZWRpYXRvci1jb252ZW50aW9uCiAgICAqKi8KCiAgICAvKioKICAgIFRoZSBhdXRvU3RhcnQgcHJvcGVydHksIGluZGljYXRlcyB0aGF0IHRoZSBtb2R1bGUgc2hvdWxkIGF1dG9tYXRpY2FsbHkgc3RhcnQgd2l0aCB0aGUgdGhydXN0IGluc3RhbmNlLCBvciB3aGVuIGl0IGlzIGFkZGVkIHRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UuCgogICAgQGZvciB0aHJ1c3QtbWVkaWF0b3ItY29udmVudGlvbgogICAgQHByb3BlcnR5IGF1dG9TdGFydAogICAgKiovCiAgICByZXR1cm4gbmV3IENvbnZlbnRpb24oewogICAgICAgIHByb3BlcnRpZXM6IFsnYXV0b1N0YXJ0J10KICAgIH0pOwp9KTsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9jb250YWluZXInLFsndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwKZnVuY3Rpb24gKENvbnZlbnRpb24sIHV0aWwpCnsKICAgIC8qKgogICAgU2ltcGxlIG1lZGlhdG9yIGNvbnZlbnRpb24gdG8gY2FwdHVyZSB0aGUgY29udGFpbmVyIHByb3BlcnR5IG9uIGEgbW9kdWxlLgoKICAgIFdoZW5ldmVyIGFub3RoZXIgbW9kdWxlLCB0cmllcyB0byBsb2FkIHdpdGggdGhlIHNhbWUgY29udGFpbmVyLCB0aGUgY3VycmVudCBtb2R1bGUgd2lsbCBiZSBzdG9wcGVkLCBhbmQgdGhlIG5ldyBvbmUgd2lsbCBsb2FkIHRvIHRha2UgaXQncyBwbGFjZS4KCiAgICBAbW9kdWxlIHRocnVzdC1tZWRpYXRvci1jb252ZW50aW9uCiAgICAqKi8KCiAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgICAgIGFueUNvbnRhaW5lcjogJ3RocnVzdC9tZWRpYXRvci9jb252ZW50aW9uL2NvbnRhaW5lci9hbnknLAogICAgICAgICAgICBjaGFuZ2VDb250YWluZXI6ICd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9jb250YWluZXIvY2hhbmdlJwogICAgICAgIH0sCiAgICAgICAgYW55ICAgICAgID0gdXRpbC5hbnksCiAgICAgICAgQ09OVEFJTkVSID0gJ2NvbnRhaW5lcicsCiAgICAgICAgU1RBUlQgICAgID0gJ3N0YXJ0LXN0YXR1cycsCiAgICAgICAgZGVmZXIgICAgID0gdXRpbC5kZWZlciwKICAgICAgICBiaW5kICAgICAgPSB1dGlsLmJpbmQ7CgogICAgLyoqCiAgICBTaW1wbGUgbWVkaWF0b3IgY29udmVudGlvbiB0byBjYXB0dXJlIHRoZSBjb250YWluZXIgcHJvcGVydHkgb24gYSBtb2R1bGUuCgogICAgV2hlbmV2ZXIgYW5vdGhlciBtb2R1bGUsIHRyaWVzIHRvIGxvYWQgd2l0aCB0aGUgc2FtZSBjb250YWluZXIsIHRoZSBjdXJyZW50IG1vZHVsZSB3aWxsIGJlIHN0b3BwZWQsIGFuZCB0aGUgbmV3IG9uZSB3aWxsIGxvYWQgdG8gdGFrZSBpdCdzIHBsYWNlLgoKICAgIEBmb3IgdGhydXN0LW1lZGlhdG9yLWNvbnZlbnRpb24KICAgIEBwcm9wZXJ0eSBjb250YWluZXIKICAgICoqLwogICAgcmV0dXJuIG5ldyBDb252ZW50aW9uKHsKICAgICAgICBwcm9wZXJ0aWVzOiBbQ09OVEFJTkVSXSwKICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uIChtb2R1bGUsIGNvbnRhaW5lcikKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb250YWluZXJWYWx1ZSA9IG1vZHVsZS5jb252ZW50aW9uKENPTlRBSU5FUik7CiAgICAgICAgICAgIGlmIChjb250YWluZXJWYWx1ZSAmJiBjb250YWluZXIgJiYgY29udGFpbmVyVmFsdWUgPT09IGNvbnRhaW5lcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG1vZHVsZS5jb252ZW50aW9uKFNUQVJUKSkKICAgICAgICAgICAgICAgICAgICBkZWZlcihtb2R1bGUuc3RvcC5iaW5kKG1vZHVsZSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKGZhY2FkZSwgbW9kdWxlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLAogICAgICAgICAgICAgICAgY29udGFpbmVyVmFsdWUgPSBtb2R1bGUuY29udmVudGlvbihDT05UQUlORVIpOwogICAgICAgICAgICBpZiAoY29udGFpbmVyVmFsdWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZhY2FkZS5maXJlKGV2ZW50LmNoYW5nZUNvbnRhaW5lciwgY29udGFpbmVyVmFsdWUpOwogICAgICAgICAgICAgICAgLy8gRmFjYWRlIHN1YnNjcmlwdGlvbnMgZ2V0IHVuc3Vic2NyaWJlZCB3aGVuIHN0b3BwaW5nIGEgbW9kdWxlLCBzbyB3ZSBuZWVkIHRvIHJlc3Vic2NyaWJlIGV2ZXJ5IHRpbWUgaGVyZS4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgcHJvYmFibHkgYmV0dGVyLCBhcyB0aGUgZXZlbnRzIHdpbGwgYmUgbGVzcyBjaGF0dHkuCiAgICAgICAgICAgICAgICBmYWNhZGUuc3Vic2NyaWJlKGV2ZW50LmNoYW5nZUNvbnRhaW5lciwgYmluZCh0aGF0LmNoYW5nZSwgdGhhdCwgbW9kdWxlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChmYWNhZGUpCiAgICAgICAgewogICAgICAgIH0KICAgIH0pOwp9KTsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nLFsKICAgICd0aHJ1c3QvY29udmVudGlvbicsCiAgICAndGhydXN0L3V0aWwnLAogICAgJ3RocnVzdC9ldmVudHMnCl0sCmZ1bmN0aW9uIChDb252ZW50aW9uLCB1dGlsLCBFdmVudHMpCnsKICAgIC8qKgogICAgVGhlIGZhY2FkZSBjb252ZW50aW9uLCBjcmVhdGVzIHRoZSBtZWRpYXRvciBmYWNhZGUgZm9yIGVhY2ggbW9kdWxlLgoKICAgIEBtb2R1bGUgdGhydXN0LW1lZGlhdG9yLWNvbnZlbnRpb24KICAgICoqLwogICAgdmFyIFNVQlNDUklQVElPTlMgPSAnc3Vic2NyaXB0aW9ucycsCiAgICAgICAgaXNGdW5jdGlvbiAgICA9IHV0aWwuaXNGdW5jdGlvbiwKICAgICAgICBpc1N0cmluZyAgICAgID0gdXRpbC5pc1N0cmluZywKICAgICAgICBpc0FycmF5ICAgICAgID0gdXRpbC5pc0FycmF5OwoKICAgIC8qKgogICAgVGhlIHN1YnNjcmlwdGlvbiBwcm9wZXJ0eSBkZWZpbmVzLCBwcmVkZWZpbmVkIHN1YnNjcmlwdGlvbnMgZm9yIGEgbW9kdWxlLgoKICAgIEJ5IGRlZmF1bHQgdGhlIGNvbnRleHQgb2YgdGhlIHN1YnNjcmlwdGlvbiBtZXRob2QsIHdoZW4gcnVuLCB3aWxsIGJlIHlvdXIgbW9kdWxlLAogICAgICAgIGl0IGNhbiBiZSBvcHRpb25hbGx5IGRlZmluZWQgYnkgcGFzc2luZyBpbiBhbiBhcnJheS4KICAgIAogICAgQmFzaWMgdXNhZ2U6CgogICAgICAgIHN1YnNjcmlwdGlvbjogewogICAgICAgICAgICAnZXZlbnQtbmFtZTEnOiBteU1ldGhvZEhlcmUsCiAgICAgICAgICAgICdldmVudC1uYW1lMic6ICdtZXRob2REZWZpbmVkT25UaGVNb2R1bGUnLAogICAgICAgICAgICAnZXZlbnQtbmFtZTMnOiBbbXlNZXRob2RIZXJlLCBteU1ldGhvZENvbnRleHRdLAogICAgICAgICAgICAnZXZlbnQtbmFtZTQnOiBbJ21ldGhvbmREZWZpbmVkT25UaGVNb2R1bGUnLCBteU1ldGhvZENvbnRleHRdCiAgICAgICAgfQoKICAgIEBmb3IgdGhydXN0LW1lZGlhdG9yLWNvbnZlbnRpb24KICAgIEBwcm9wZXJ0eSBzdWJzY3JpcHRpb25zCiAgICAqKi8KICAgIHJldHVybiBuZXcgQ29udmVudGlvbih7CiAgICAgICAgcHJvcGVydGllczogW1NVQlNDUklQVElPTlNdLAogICAgICAgIHN0YXJ0OiBmdW5jdGlvbiAoZmFjYWRlLCBtb2R1bGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IG1vZHVsZS5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpOwoKICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbnMgJiYgIXN1YnNjcmlwdGlvbnMuX3N1YnNjcmlwdGlvbnNTZXQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG1vZHVsZS5pbnN0YW5jZTsKICAgICAgICAgICAgICAgIGZvciAodmFyIHN1YnNjcmlwdGlvbiBpbiBzdWJzY3JpcHRpb25zKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZpbml0aW9uID0gc3Vic2NyaXB0aW9uc1tzdWJzY3JpcHRpb25dOwogICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGRlZmluaXRpb24pKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvbiA9IFtzdWJzY3JpcHRpb24sIGRlZmluaXRpb24sIG1vZHVsZUluc3RhbmNlXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNTdHJpbmcoZGVmaW5pdGlvbikpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZpbml0aW9uID0gW3N1YnNjcmlwdGlvbiwgbW9kdWxlSW5zdGFuY2VbZGVmaW5pdGlvbl0sIG1vZHVsZUluc3RhbmNlXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNBcnJheShkZWZpbml0aW9uKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhkZWZpbml0aW9uWzBdKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvblswXSA9IG1vZHVsZUluc3RhbmNlW2RlZmluaXRpb25bMF1dOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluaXRpb24udW5zaGlmdChzdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmYWNhZGUuc3Vic2NyaWJlLmFwcGx5KGZhY2FkZSwgZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtb2R1bGUuY29udmVudGlvbihTVUJTQ1JJUFRJT05TKS5fc3Vic2NyaXB0aW9uc1NldCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChmYWNhZGUsIG1vZHVsZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb25zID0gbW9kdWxlLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUyk7CgogICAgICAgICAgICBpZiAoc3Vic2NyaXB0aW9ucyAmJiBzdWJzY3JpcHRpb25zLl9zdWJzY3JpcHRpb25zU2V0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtb2R1bGUuY29udmVudGlvbihTVUJTQ1JJUFRJT05TKS5fc3Vic2NyaXB0aW9uc1NldCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7Cn0pOwovKiEgVGhydXN0IEpTIEZyYW1ld29yayAtIHYwLjEuMCAtIDIwMTItMDgtMjkKKiB0aHJ1c3QtaG9tZQoqIENvcHlyaWdodCAoYykgMjAxMiBEYXZpZCBEcmlzY29sbDsgTGljZW5zZWQgTUlUICovCgoKLyoqCgpAbW9kdWxlIHRocnVzdC1kYXRhIApAc3VibW9kdWxlIGV2ZW50cwoqKi8KZGVmaW5lKCd0aHJ1c3QvZGF0YS9ldmVudC50eXBlcycsewogICAgLyoqCiAgICBUaGUgKip0aHJ1c3QvZGF0YS93YWl0KiogZXZlbnQgaXMgZmlyZWQgb25jZSBhIGRhdGEgY2FsbCBpcyBtYWRlLgoKICAgIEBldmVudCB0aHJ1c3QvZGF0YS93YWl0CiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICAqKi8KICAgIHdhaXQ6ICd0aHJ1c3QvZGF0YS93YWl0JywKICAgIC8qKgogICAgVGhlICoqdGhydXN0L2RhdGEvc3RhcnQqKiBldmVudCBpcyBmaXJlZCB0aGUgcXVldWUgaXMgc3RhcnRlZC4KCiAgICBAZXZlbnQgdGhydXN0L2RhdGEvc3RhcnQKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgb3V0Z29pbmcgY2FsbCBjb3VudAogICAgKiovCiAgICBzdGFydDogJ3RocnVzdC9kYXRhL3N0YXJ0JywKICAgIC8qKgogICAgVGhlICoqdGhydXN0L2RhdGEvc3RhdHVzKiogZXZlbnQgaXMgZmlyZWQgZm9yIGV2ZXJ5IGl0ZW0gdGhhdCByZXR1cm5zIGZyb20gdGhlIHF1ZXVlLgoKICAgIE5PVEU6IEl0IGlzIGVudGlyZWx5IHBvc3NpYmxlIGZvciAqKnRocnVzdC9kYXRhL3N0YXR1cyoqIHRvIGJlIGNhbGxlZCBhZnRlciAqKnRocnVzdC9kYXRhL3N0b3AqKiBpZiBzZXZlcmFsCiAgICAgICAgY2FsbHMgdGFrZSB0byBsb25nIHRvIGNvbXBsZXRlLiAgVGhpcyBpcyBpbnRlbmRlZCwgYW5kIHBvdGVudGlhbGx5IHVzZWZ1bCBpbmZvcm1hdGlvbi4KCiAgICBAZXZlbnQgdGhydXN0L2RhdGEvc3RhdHVzCiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICBAcGFyYW0ge051bWJlcn0gY291bnQgVGhlIGN1cnJlbnQgY29tcGxldGVkIGNhbGwgY291bnQgZm9yIHRoaXMgcXVldWUuCiAgICAqKi8KICAgIHN0YXR1czogJ3RocnVzdC9kYXRhL3N0YXR1cycsCiAgICAvKioKICAgIFRoZSAqKnRocnVzdC9kYXRhL3N0b3AqKiBldmVudCBpcyBmaXJlZCB3aGVuIGFsbCBpdGVtcyBpbiB0aGUgcXVldWUgcmV0dXJuLCBvciB0aGUgZmluaXNoZWRUaW1lb3V0IHNldHRpbmcgZWxhcHNlcy4KCiAgICBAZXZlbnQgdGhydXN0L2RhdGEvc3RvcAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXJ5SWQgVGhlIGludGVybmFsIGlkIG9mIHRoZSBvdXRib3VuZCBxdWV1ZS4KICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBvdXRib3VuZCBldmVudCBxdWV1ZSAoR2V0L1Bvc3QvZXRjKQogICAgQHBhcmFtIHtOdW1iZXJ9IGNvdW50IFRoZSAoY3VycmVudCkgY29tcGxldGVkIGNhbGwgY291bnQgZm9yIHRoaXMgcXVldWUuCiAgICAqKi8KICAgIHN0b3A6ICd0aHJ1c3QvZGF0YS9zdG9wJywKICAgIGV2ZW50OiB7CiAgICAgICAgLyoqCiAgICAgICAgVGhlICoqdGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmQqKiBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgoKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmQKICAgICAgICAqKi8KICAgICAgICBiZWZvcmVTZW5kOiAndGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmQnLAogICAgICAgIC8qKgogICAgICAgIFRoZSAqKnRocnVzdC9kYXRhL2V2ZW50L3N0YXJ0KiogZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N0YXJ0CiAgICAgICAgKiovCiAgICAgICAgc3RhcnQ6ICd0aHJ1c3QvZGF0YS9ldmVudC9zdGFydCcsCiAgICAgICAgLyoqCiAgICAgICAgVGhlICoqdGhydXN0L2RhdGEvZXZlbnQvc2VuZCoqIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCgogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9zZW5kCiAgICAgICAgKiovCiAgICAgICAgc2VuZDogJ3RocnVzdC9kYXRhL2V2ZW50L3NlbmQnLAogICAgICAgIC8qKgogICAgICAgIFRoZSAqKnRocnVzdC9kYXRhL2V2ZW50L2Vycm9yKiogZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L2Vycm9yCiAgICAgICAgKiovCiAgICAgICAgZXJyb3I6ICd0aHJ1c3QvZGF0YS9ldmVudC9lcnJvcicsCiAgICAgICAgLyoqCiAgICAgICAgVGhlICoqdGhydXN0L2RhdGEvZXZlbnQvc3VjY2VzcyoqIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCgogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9zdWNjZXNzCiAgICAgICAgKiovCiAgICAgICAgc3VjY2VzczogJ3RocnVzdC9kYXRhL2V2ZW50L3N1Y2VzcycsCiAgICAgICAgLyoqCiAgICAgICAgVGhlICoqdGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUqKiBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgoKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUKICAgICAgICAqKi8KICAgICAgICBjb21wbGV0ZTogJ3RocnVzdC9kYXRhL2V2ZW50L2NvbXBsZXRlJywKICAgICAgICAvKioKICAgICAgICBUaGUgKip0aHJ1c3QvZGF0YS9ldmVudC9zdG9wKiogZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N0b3AKICAgICAgICAqKi8KICAgICAgICBzdG9wOiAndGhydXN0L2RhdGEvZXZlbnQvc3RvcCcKICAgIH0KfSk7CmRlZmluZSgndGhydXN0L2RhdGEvZXZlbnQuZmFjdG9yeScsWyd0aHJ1c3QvdXRpbCcsICcuL2V2ZW50LnR5cGVzJ10sCmZ1bmN0aW9uKHV0aWwsIGV2ZW50VHlwZXMpCnsKICAgIAogICAgdmFyIGNhbWVsQ2FzZSAgPSB1dGlsLmNhbWVsQ2FzZSwKICAgICAgICBmb3JtYXQgICAgID0gdXRpbC5mb3JtYXQsCiAgICAgICAgZGF0YUV2ZW50cyA9IGV2ZW50VHlwZXNbJ2V2ZW50J10sCiAgICAgICAgc2xpY2UgICAgICA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCiAgICB2YXIgZXZlbnRIYW5kbGVycyA9IHsgICAgLy8gU3VwcG9ydGVkIGV2ZW50IGhhbmRsZXJzCiAgICAgICAgJ2JlZm9yZS1zZW5kJyA6IHRydWUsCiAgICAgICAgJ3NlbmQnICAgICAgICA6IHRydWUsCiAgICAgICAgJ2Vycm9yJyAgICAgICA6IHRydWUsCiAgICAgICAgJ3N1Y2Nlc3MnICAgICA6IHRydWUsCiAgICAgICAgJ2NvbXBsZXRlJyAgICA6IHRydWUsCiAgICAgICAgJ3N0YXJ0JyAgICAgICA6IHRydWUsCiAgICAgICAgJ3N0b3AnICAgICAgICA6IHRydWUKICAgIH07CgogICAgdmFyIGJlZm9yZVNlbmRNZXRob2QgPSBmdW5jdGlvbiAoanFYSFIsIHNldHRpbmdzKQogICAgewogICAgICAgIHRoaXMuZmlyZShkYXRhRXZlbnRzWydiZWZvcmVTZW5kJ10sIGpxWEhSLCBzZXR0aW5ncyk7CiAgICB9OwoKICAgIHZhciBldmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoZXZlbnQpICAgIC8vIENyZWF0ZSBhIG5ldyBldmVudCBtZXRob2QuCiAgICB7CiAgICAgICAgdmFyIGV2dCA9IGRhdGFFdmVudHNbZXZlbnRdOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChldnQpOwogICAgICAgICAgICB0aGlzLmZpcmUuYXBwbHkodGhpcy5maXJlLmFzeW5jLCBhcmdzKTsKICAgICAgICB9OwogICAgfTsKCiAgICB2YXIgbm9ybWFsaXplRXZlbnRzID0gZnVuY3Rpb24gKGV2dHMpICAgIC8vIE5vcm1hbGl6ZSBldmVudHMKICAgIHsKICAgICAgICBldnRzID0gZXZ0cy5zcGxpdCgnICcpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gZXZ0cy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAoIWV2ZW50SGFuZGxlcnNbZXZ0c1tpXV0pCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdFdmVudCAiezB9IiBpcyBub3QgYSB2YWxpZCBkYXRhIGV2ZW50JywgZXZ0c1tpXSkpOwogICAgICAgICAgICBldnRzW2ldID0gZGF0YUV2ZW50c1tldnRzW2ldXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2dHMuam9pbignICcpOwogICAgfTsKCiAgICB2YXIgc2VuZEV2ZW50RmFjdG9yeSA9IGZ1bmN0aW9uIChpKQogICAgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXZlbnQsIGpxWEhSLCBzZXR0aW5ncykKICAgICAgICB7CiAgICAgICAgICAgIGlmICghc2V0dGluZ3MuX19tZWRpYXRvcl9kYXRhX2ZpcmVkX18pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGpxWEhSLmFib3J0KCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCwgYWxsIGFqYXggY2FsbHMgbXVzdCBwYXNzIHRocm91Z2ggdGhydXN0LWRhdGEuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXZlbnRGYWN0b3J5KGkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgICBpbml0OiBmdW5jdGlvbihqRG9jKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBldmVudEhhbmRsZXJzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIganFFdnQgPSAnYWpheC0nICsgaSwKICAgICAgICAgICAgICAgICAgICBtZXRob2QgPSBldmVudEZhY3RvcnkoaSk7CgogICAgICAgICAgICAgICAgaWYgKGkgPT09ICdzZW5kJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2QgPSBzZW5kRXZlbnRGYWN0b3J5KGkpLmJpbmQodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBqRG9jLm9uKGNhbWVsQ2FzZShqcUV2dCkgKyB0aGlzLm5hbWVzcGFjZSwgbWV0aG9kKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYmVmb3JlU2VuZE1ldGhvZDogYmVmb3JlU2VuZE1ldGhvZCwKICAgIH07Cn0pOwpkZWZpbmUoJ3RocnVzdC9kYXRhL3Jlc3BvbnNlLnF1ZXVlJyxbJ2pxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvY29uZmlnJywgJ3RocnVzdC9sb2cnLCAnLi9ldmVudC50eXBlcyddLApmdW5jdGlvbihqUXVlcnksIHV0aWwsIGNvbmZpZywgbG9nLCBldmVudFR5cGVzKQp7CiAgICB2YXIgc2xpY2UgICAgICAgICAgICAgID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAogICAgICAgIGZvcm1hdCAgICAgICAgICAgICA9IHV0aWwuZm9ybWF0LAogICAgICAgIGV4dGVuZCAgICAgICAgICAgICA9IHV0aWwuZXh0ZW5kLAogICAgICAgIHdoZW4gICAgICAgICAgICAgICA9IHV0aWwud2hlbiwKICAgICAgICB1aWQgICAgICAgICAgICAgICAgPSB1dGlsLnVuaXF1ZUlkLAogICAgICAgIGFqYXggICAgICAgICAgICAgICA9IGpRdWVyeS5hamF4LAogICAgICAgIGRhdGFFdmVudFdhaXQgICAgICA9IGV2ZW50VHlwZXNbJ3dhaXQnXSwKICAgICAgICBkYXRhRXZlbnRTdGFydCAgICAgPSBldmVudFR5cGVzWydzdGFydCddLAogICAgICAgIGRhdGFFdmVudFN0b3AgICAgICA9IGV2ZW50VHlwZXNbJ3N0b3AnXSwKICAgICAgICBkYXRhRXZlbnRTdGF0dXMgICAgPSBldmVudFR5cGVzWydzdGF0dXMnXSwKICAgICAgICBxdWV1ZSAgICAgICAgICAgICAgPSB7fSwKICAgICAgICB1cGRhdGVYSFJJbnRlcm5hbHMgPSBmdW5jdGlvbiAoZGZvLCB4aHIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFkZm8uX3hocikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkZm8uX3hociA9IHhocjsKICAgICAgICAgICAgICAgICAgICBkZm8uZ2V0QWxsUmVzcG9uc2VIZWFkZXJzID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gZGZvLl94aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7IH07CiAgICAgICAgICAgICAgICAgICAgZGZvLmdldFJlc3BvbnNlSGVhZGVyID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gZGZvLl94aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzZ2V0UmVzcG9uc2VIZWFkZXIoKTsgfTsKICAgICAgICAgICAgICAgICAgICBkZm8uYWJvcnQgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBkZm8uX3hoci5hYm9ydCgpOyB9OwogICAgICAgICAgICAgICAgICAgIGRmby5zZXRSZXF1ZXN0SGVhZGVyID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7IHJldHVybiBkZm8uX3hoci5zZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIHZhbHVlKTsgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBkZm8ucmVzcG9uc2VUZXh0ID0geGhyLnJlc3BvbnNlVGV4dDsKICAgICAgICAgICAgICAgIGRmby5yZXNwb25zZVhNTCA9IHhoci5yZXNwb25zZVhNTDsKICAgICAgICAgICAgICAgIGRmby5yZWFkeVN0YXRlID0geGhyLnJlYWR5U3RhdGU7CiAgICAgICAgICAgICAgICBkZm8uc3RhdHVzID0geGhyLnN0YXR1czsKICAgICAgICAgICAgICAgIGRmby5zdGF0dXNUZXh0ID0geGhyLnN0YXR1c1RleHQ7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBhcmd1bWVudFJlc29sdmVyID0gZnVuY3Rpb24gKG1ldGhvZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWV0aG9kKHV0aWwudG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgIGRlZmVyQ29udHJvbGxlckl0ZW1DYWxsYmFjayA9IGZ1bmN0aW9uIChmdW5jKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpcywgYXJndW1lbnRzWzBdWzBdKTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgIHZhciBSZXNwb25zZVF1ZXVlID0gZnVuY3Rpb24gKG1vZHVsZSwgc3RhcnRUaW1lb3V0LCBmaW5pc2hUaW1lb3V0KQogICAgewogICAgICAgIHRoaXMuc3RhcnRUaW1lb3V0ID0gc3RhcnRUaW1lb3V0OwogICAgICAgIHRoaXMuZmluaXNoVGltZW91dCA9IGZpbmlzaFRpbWVvdXQ7CiAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICB9OwoKICAgIFJlc3BvbnNlUXVldWUucHJvdG90eXBlID0gewogICAgICAgIGFkZFRvUXVldWU6IGZ1bmN0aW9uICh0eXBlLCB1cmwsIG9wdGlvbnMpCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGZvICA9IHdoZW4uZGVmZXIoKSwKICAgICAgICAgICAgICAgIHRoYXQgPSB0aGlzOwoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuYmVmb3JlU2VuZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgICAgICAgICAgICBkZm8ucHJvZ3Jlc3MoZnVuY3Rpb24gKGV2ZW50VHlwZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnRUeXBlICYmIGV2ZW50VHlwZSA9PSAnYmVmb3JlLXNlbmQnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQuYXBwbHkoYmVmb3JlU2VuZCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5iZWZvcmVTZW5kOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy5jb21wbGV0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZGZvLmFsd2F5cyhvcHRpb25zLmNvbXBsZXRlKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLmNvbXBsZXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLnN1Y2Nlc3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGRmby50aGVuKG9wdGlvbnMuc3VjY2Vzcyk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5zdWNjZXNzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy5lcnJvcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZGZvLm90aGVyd2lzZShvcHRpb25zLmVycm9yKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLmVycm9yOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaGFzUXVldWUgPSAhIXF1ZXVlW3R5cGVdLAogICAgICAgICAgICAgICAgbGlzdCA9IHF1ZXVlW3R5cGVdIHx8IChxdWV1ZVt0eXBlXSA9IHt9KSwKICAgICAgICAgICAgICAgIHRhaWwgPSBsaXN0LnRhaWwgfHwgKGxpc3QudGFpbCA9IGxpc3QubmV4dCA9IHt9KTsKCiAgICAgICAgICAgIGV4dGVuZCh0YWlsLCB7IHVybDogdXJsLCBvcHRpb25zOiBvcHRpb25zLCBkZm86IGRmbyB9KTsKICAgICAgICAgICAgbGlzdC50YWlsID0gdGFpbC5uZXh0ID0ge307CgogICAgICAgICAgICBpZiAoIWhhc1F1ZXVlKQogICAgICAgICAgICAgICAgd2hlbi5kZWxheSh0aGF0LnN0YXJ0VGltZW91dCkudGhlbih0aGF0LnByb2Nlc3ModHlwZSkpOwoKICAgICAgICAgICAgcmV0dXJuIGRmby5wcm9taXNlOwogICAgICAgIH0sCiAgICAgICAgcHJvY2VzczogZnVuY3Rpb24gKHR5cGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50ICA9IHF1ZXVlW3R5cGVdLAogICAgICAgICAgICAgICAgbm9kZSAgICA9IHBhcmVudCwKICAgICAgICAgICAgICAgIHRoYXQgICAgPSB0aGlzLAogICAgICAgICAgICAgICAgcXVlcnlJZCA9IHVpZCgnZHEnKTsKCiAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RhdGFbezB9XTogQ3JlYXRpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFdhaXQsIHF1ZXJ5SWQsIHR5cGUpOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RhdGFbezB9XTogUHJvY2Vzc2luZyBxdWV1ZSBmb3IgdHlwZSAiezF9IicsIHRoYXQubmFtZXNwYWNlLCB0eXBlKSk7CiAgICAgICAgICAgICAgICB2YXIgd2hlblF1ZXVlID0gW10sIGRlZmVyQ29udHJvbGxlciA9IHdoZW4uZGVmZXIoKSwgcmV0dXJuQ291bnQgPSAwOwoKICAgICAgICAgICAgICAgIGRlZmVyQ29udHJvbGxlci50aGVuKGZ1bmN0aW9uICgpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBGaW5pc2hpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICAgICAgICAgIHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50U3RvcCwgcXVlcnlJZCwgdHlwZSwgcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgZGVsZXRlIHF1ZXVlW3R5cGVdOwoKICAgICAgICAgICAgICAgIHZhciB0YWlsID0gbm9kZS50YWlsLAogICAgICAgICAgICAgICAgICAgIHN0YXR1c0NhbGxiYWNrID0gZnVuY3Rpb24gKCkgeyB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFN0YXR1cywgcXVlcnlJZCwgdHlwZSwgKytyZXR1cm5Db3VudCk7IH07CiAgICAgICAgICAgICAgICB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHQpICE9PSB0YWlsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBkZm8gPSBub2RlLmRmbywKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucyA9IGV4dGVuZCh7fSwgbm9kZS5vcHRpb25zKSwKICAgICAgICAgICAgICAgICAgICAgICAgeGhyRGZvID0gd2hlbi5kZWZlcigpLAogICAgICAgICAgICAgICAgICAgICAgICB4aHIgPSBub2RlLnhociA9IGFqYXgobm9kZS51cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcih4aHJEZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoeGhyRGZvLnJlamVjdCkpOwoKICAgICAgICAgICAgICAgICAgICB4aHJEZm8udGhlbihzdGF0dXNDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgd2hlblF1ZXVlLnB1c2goeGhyKTsKCiAgICAgICAgICAgICAgICAgICAgd2hlbi5hbGwoW3hockRmbywgZGVmZXJDb250cm9sbGVyLnByb21pc2VdLCB3aGVuLmFwcGx5KGRmby5yZXNvbHZlKSwgd2hlbi5hcHBseShkZm8ucmVqZWN0KSwgdXBkYXRlWEhSSW50ZXJuYWxzKGRmbywgeGhyKSk7CgogICAgICAgICAgICAgICAgICAgIGRmby5wcm9ncmVzcygnYmVmb3JlLXNlbmQnLCBbZGZvLCBvcHRpb25zXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRTdGFydCwgcXVlcnlJZCwgdHlwZSwgd2hlblF1ZXVlLmxlbmd0aCk7CgogICAgICAgICAgICAgICAgd2hlbi5hbnkoW3doZW4uYWxsKHdoZW5RdWV1ZSksIHdoZW4uZGVsYXkodGhhdC5maW5pc2hUaW1lb3V0KV0sIGRlZmVyQ29udHJvbGxlci5yZXNvbHZlLCBkZWZlckNvbnRyb2xsZXIucmVzb2x2ZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gUmVzcG9uc2VRdWV1ZTsKfSk7CmRlZmluZSgndGhydXN0L2RhdGEvbWFpbicsWwogICAgJ2pxdWVyeScsCiAgICAndGhydXN0L3V0aWwnLAogICAgJ3RocnVzdC9sb2cnLAogICAgJ3RocnVzdC9jb25maWcnLAogICAgJy4vZXZlbnQuZmFjdG9yeScsCiAgICAnLi9yZXNwb25zZS5xdWV1ZScsCiAgICAndGhydXN0L2V2ZW50cycsCiAgICAndGhydXN0L2ZhY2FkZScsCiAgICAnLi9ldmVudC50eXBlcycKXSwKZnVuY3Rpb24gKGpRdWVyeSwgdXRpbCwgbG9nLCBjb25maWcsIGV2ZW50RmFjdG9yeSwgUmVzcG9uc2VRdWV1ZSwgZXZlbnRzLCBmYWNhZGUsIGV2ZW50VHlwZXMpCnsKICAgIAogICAgLy8gVmFyaWFibGUgZGVjbGFyYXRpb24uCiAgICB2YXIgZm9ybWF0ICAgICAgICAgID0gdXRpbC5mb3JtYXQsCiAgICAgICAgZXh0ZW5kICAgICAgICAgID0gdXRpbC5leHRlbmQsCiAgICAgICAgdHlwZSAgICAgICAgICAgID0gdXRpbC50eXBlLAogICAgICAgIHdoZW4gICAgICAgICAgICA9IHV0aWwud2hlbiwKICAgICAgICBzbGljZSAgICAgICAgICAgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCiAgICAgICAgYWpheCAgICAgICAgICAgID0galF1ZXJ5LmFqYXgsCiAgICAgICAgdWlkICAgICAgICAgICAgID0gdXRpbC51bmlxdWVJZCwKICAgICAgICBkYXRhQ2FjaGUgICAgICAgPSB7fSwKICAgICAgICBkYXRhRXZlbnRXYWl0ICAgPSBldmVudFR5cGVzWyd3YWl0J10sCiAgICAgICAgZGF0YUV2ZW50U3RhcnQgID0gZXZlbnRUeXBlc1snc3RhcnQnXSwKICAgICAgICBkYXRhRXZlbnRTdG9wICAgPSBldmVudFR5cGVzWydzdG9wJ10sCiAgICAgICAgZGF0YUV2ZW50U3RhdHVzID0gZXZlbnRUeXBlc1snc3RhdHVzJ10sCiAgICAgICAgZGVmYXVsdHMgICAgICAgID0gewogICAgICAgICAgICBjYWNoZSAgICAgICAgICAgICAgICAgIDogY29uZmlnLmRhdGEuY2FjaGUsCiAgICAgICAgICAgIGJlZm9yZVNlbmQgICAgICAgICAgICAgOiBldmVudEZhY3RvcnkuYmVmb3JlU2VuZE1ldGhvZCwKICAgICAgICAgICAgY29udGVudFR5cGUgICAgICAgICAgICA6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgdHlwZSAgICAgICAgICAgICAgICAgICA6ICdQT1NUJywKICAgICAgICAgICAgdXJsICAgICAgICAgICAgICAgICAgICA6ICcnLAogICAgICAgICAgICBkYXRhICAgICAgICAgICAgICAgICAgIDogJycsCiAgICAgICAgICAgIGRhdGFUeXBlICAgICAgICAgICAgICAgOiAnanNvbicsCiAgICAgICAgICAgIF9fbWVkaWF0b3JfZGF0YV9maXJlZF9fOiB0cnVlCiAgICAgICAgfTsKCiAgICBqUXVlcnkuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsID0gISFjb25maWcudXJsLnRyYWRpdGlvbmFsRW5jb2Rpbmc7CgogICAgdmFyIGpEb2MgPSBqUXVlcnkoZG9jdW1lbnQpOwoKICAgIGV2ZW50RmFjdG9yeS5pbml0KGpEb2MpOwogICAgLy8jcmVnaW9uIERhdGFGYWNhZGUKICAgIHZhciBEYXRhRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kdWxlLCBwYXJlbnQpCiAgICB7CiAgICAgICAgdGhpcy5uYW1lID0gbW9kdWxlLm5hbWUgKyAnLWRhdGEnOwogICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IHBhcmVudC5fY2FsbGJhY2tzOwogICAgICAgIHRoaXMucmVzcG9uc2VRdWV1ZSA9IHBhcmVudC5yZXNwb25zZVF1ZXVlOwogICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgfSk7CiAgICB1dGlsLmV4dGVuZChEYXRhRmFjYWRlLmZuLCBldmVudHMpOwogICAgLy8jZW5kcmVnaW9uCgogICAgdmFyIERhdGEgPSBmdW5jdGlvbiAoLyogJHJlZiAqLyBuYW1lLCAvKiAkcmVmICovIG1lZGlhdG9yLCAvKiAkcmVmICovIGNvbmZpZykKICAgIHsKICAgICAgICAvLyBFbmZvcmNlIG5ldwogICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBEYXRhKSkKICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRhKG5hbWUsIG1lZGlhdG9yKTsKCiAgICAgICAgaWYgKCFuYW1lKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGE6IG1vZHVsZSBuYW1lIG11c3QgYmUgZGVmaW5lZC4nKTsKCiAgICAgICAgdGhpcy5yZXNwb25zZVF1ZXVlID0gbmV3IFJlc3BvbnNlUXVldWUodGhpcywgY29uZmlnLmRhdGEuc3RhcnRUaW1lb3V0LCBjb25maWcuZGF0YS5maW5pc2hUaW1lb3V0KTsKCiAgICAgICAgbG9nLmRlYnVnKCdEYXRhOiBDcmVhdGluZyBuZXcgRGF0YScpOwoKICAgICAgICB0aGlzLm1lZGlhdG9yID0gbWVkaWF0b3I7CiAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gdGhpcy5tZWRpYXRvci5fY2FsbGJhY2tzOwogICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgfTsKCiAgICB2YXIgRGF0YU1ldGhvZHMgPSB7CiAgICAgICAgY3JlYXRlRmFjYWRlOiBmdW5jdGlvbiAodGhydXN0LCBtb2R1bGUsIGZhY2FkZXMpCiAgICAgICAgewogICAgICAgICAgICBpZiAobW9kdWxlLmRhdGEgJiYgIShmYWNhZGVzLmRhdGEgaW5zdGFuY2VvZiBEYXRhRmFjYWRlKSkgdGhyb3cgbmV3IEVycm9yKCciZGF0YSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eScpOwoKICAgICAgICAgICAgdmFyIGRhdGE7CiAgICAgICAgICAgIGlmIChmYWNhZGVzLmRhdGEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMuZGF0YS51cGRhdGVGYWNhZGUobW9kdWxlLCB0aGlzKTsKICAgICAgICAgICAgICAgIGRhdGEgPSBmYWNhZGVzLmRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkYXRhID0gZmFjYWRlcy5kYXRhID0gbW9kdWxlLmRhdGEgPSBuZXcgRGF0YUZhY2FkZShtb2R1bGUsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgIH0sCiAgICB9OwoKICAgIHZhciBEYXRhUHJvdG90eXBlID0gewogICAgICAgIGdldERhdGE6IGZ1bmN0aW9uICh1cmwsIGRhdGEsIHNldHRpbmdzKQogICAgICAgIHsKICAgICAgICAgICAgc2V0dGluZ3MgPSAhc2V0dGluZ3MgPyB7IGRhdGE6IGRhdGEgfSA6IGV4dGVuZChzZXR0aW5ncywgeyBkYXRhOiBkYXRhIH0pOwogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQodXJsLCBzZXR0aW5ncyk7CiAgICAgICAgfSwKICAgICAgICBwb3N0RGF0YTogZnVuY3Rpb24gKHVybCwgZGF0YSwgc2V0dGluZ3MpCiAgICAgICAgewogICAgICAgICAgICBzZXR0aW5ncyA9ICFzZXR0aW5ncyA/IHsgZGF0YTogSlNPTi5zdHJpbmdpZnkoZGF0YSkgfSA6IGV4dGVuZChzZXR0aW5ncywgeyBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKSB9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zdCh1cmwsIHNldHRpbmdzKTsKICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MsIGp1bXBRdWV1ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHVybCA9PT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLnVybCAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICBpZiAodXJsID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHVybCBpcyBkZWZpbmVkJyk7CgogICAgICAgICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgZXh0ZW5kKHNldHRpbmdzIHx8IHt9LCB7IHR5cGU6ICdnZXQnIH0pLCBqdW1wUXVldWUpOwogICAgICAgIH0sCiAgICAgICAgcG9zdDogZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MsIGp1bXBRdWV1ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHVybCA9PT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLnVybCAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICBpZiAodXJsID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHVybCBpcyBkZWZpbmVkJyk7CgogICAgICAgICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgZXh0ZW5kKHNldHRpbmdzIHx8IHt9LCB7IHR5cGU6ICdwb3N0JyB9KSwganVtcFF1ZXVlKTsKICAgICAgICB9LAogICAgICAgIGFkZFRvQ2FjaGU6IGZ1bmN0aW9uIChjYWNoZU9iamVjdHMpCiAgICAgICAgewogICAgICAgICAgICBpZiAoY2FjaGVPYmplY3RzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjYWNoZU9iamVjdHMuZm9yRWFjaChmdW5jdGlvbiAoeCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkYXRhQ2FjaGVbeC5VcmxdID0geC5Kc29uOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFqYXg6IGZ1bmN0aW9uICh1cmwsIHNldHRpbmdzLCBqdW1wUXVldWUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG9wdGlvbnMsIHR5cGUsIGJlZm9yZVNlbmQ7CiAgICAgICAgICAgIGxvZy5pbmZvKGZvcm1hdCgnRGF0YVt7MH1dOiBGZXRjaGluZyBkYXRhIGZyb20gInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdXJsKSk7CgogICAgICAgICAgICBpZiAoc2V0dGluZ3MgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdXJsID09PSAnb2JqZWN0JykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB1cmw7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFzZXR0aW5ncykKICAgICAgICAgICAgICAgIHNldHRpbmdzID0ge307CgogICAgICAgICAgICBpZiAodXJsID09PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MudXJsICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CgoKICAgICAgICAgICAgdXJsID0gdXRpbC5maXh1cFVybCh1cmwpOwoKICAgICAgICAgICAgdmFyIG1vZHVsZSA9ICh0aGF0Lm1vZHVsZSAmJiB0aGF0Lm1vZHVsZS5tb2R1bGUpOwogICAgICAgICAgICBpZiAoanVtcFF1ZXVlICYmIHRoYXQuX2Zhc3RBamF4UGVybWlzc2lvbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGRmbyA9IHdoZW4uZGVmZXIoKTsKCiAgICAgICAgICAgICAgICB2YXIgcXVlcnlJZCA9IHVpZCgnZHEnKTsKICAgICAgICAgICAgICAgIHR5cGUgPSBzZXR0aW5ncy50eXBlLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgICAgICAgdGhhdC5maXJlKGRhdGFFdmVudFdhaXQsIHF1ZXJ5SWQsIHR5cGUpOwogICAgICAgICAgICAgICAgdGhhdC5maXJlKGRhdGFFdmVudFN0YXJ0LCBxdWVyeUlkLCB0eXBlLCAxKTsKCiAgICAgICAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHt9LCB7IGJlZm9yZVNlbmQ6IGV2ZW50RmFjdG9yeS5iZWZvcmVTZW5kTWV0aG9kIH0sIGRlZmF1bHRzLCBzZXR0aW5ncyk7CgogICAgICAgICAgICAgICAgdmFyIHhociA9IGFqYXgodXJsLCBvcHRpb25zKS5hbHdheXMoZnVuY3Rpb24gKCkgeyB0aGF0LmZpcmUoZGF0YUV2ZW50U3RhdHVzLCBxdWVyeUlkLCB0eXBlLCAxKTsgdGhhdC5maXJlKGRhdGFFdmVudFN0b3AsIHF1ZXJ5SWQsIHR5cGUsIDEpOyB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB3aGVuKHhocik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoe30sIGRlZmF1bHRzLCBzZXR0aW5ncywgeyBiZWZvcmVTZW5kOiBldmVudEZhY3RvcnkuYmVmb3JlU2VuZE1ldGhvZCB9KTsKCiAgICAgICAgICAgIHR5cGUgPSBvcHRpb25zLnR5cGUudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3BvbnNlUXVldWUuYWRkVG9RdWV1ZSh0eXBlLCB1cmwsIG9wdGlvbnMpOwogICAgICAgIH0KICAgIH07CgogICAgdXRpbC5leHRlbmQoRGF0YUZhY2FkZS5mbiwgRGF0YVByb3RvdHlwZSk7CgogICAgRGF0YS5wcm90b3R5cGUgPSBEYXRhLmZuID0gdXRpbC5leHRlbmQoe30sIERhdGFNZXRob2RzLCBEYXRhUHJvdG90eXBlLCBldmVudHMpOwoKICAgIC8vIFRha2UgYSBob2xkIG9mIGpRdWVyeS4uLiB0aGlzIGlzIHN1cmUgdG8gYmUgY29udHJhdmVzaWFsLgogICAgalF1ZXJ5LmFqYXggPSBEYXRhLmFqYXg7CgogICAgcmV0dXJuIERhdGE7Cn0pOwoKZGVmaW5lKCd0aHJ1c3QvZGF0YScsIFsndGhydXN0L2RhdGEvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9kYXRhL2NvbnZlbnRpb24vc3RhcnQnLFsndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwKZnVuY3Rpb24gKENvbnZlbnRpb24sIHV0aWwpCnsKICAgIHZhciB3aGVuID0gdXRpbC53aGVuOwogICAgdmFyIHdoZW5RdWV1ZSA9IFtdLAogICAgICAgIHdhaXRDYWxsYmFjayA9IGZ1bmN0aW9uICh1aWQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmVyLnVpZCA9IHVpZDsKCiAgICAgICAgICAgIHdoZW5RdWV1ZS5wdXNoKHsgdWlkOiB1aWQsIHJlc29sdmVyOiBkZWZlci5yZXNvbHZlciB9KTsKICAgICAgICB9LAogICAgICAgIHN0b3BDYWxsYmFjayA9IGZ1bmN0aW9uICh1aWQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgaXRlbSA9IHV0aWwuZmluZCh3aGVuUXVldWUsIGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LnVpZCA9PT0gdWlkOyB9KTsKICAgICAgICAgICAgd2hlblF1ZXVlID0gdXRpbC53aXRob3V0KHdoZW5RdWV1ZSwgaXRlbSk7CgogICAgICAgICAgICBpdGVtLnJlc29sdmVyLnJlc29sdmUoKTsKICAgICAgICB9OwoKICAgIC8qKgogICAgVGhlIGRhdGEgc3RhcnQgY29udmVudGlvbiwgZGVsYXlzIHRocnVzdHMgcmVhZHkgKG9yYml0KSBldmVudCwgdW50aWwgYSBzZXQgdGltZW91dCwgb3IgYWxsIHRoZSBjYWxscyByZXR1cm4uCgogICAgVGhpcyBhbGxvd3MgdGhlIFVJIHRvIGFwcGVhciBhcyBpZiBpdCB3YXMgYWx3YXlzIGZ1bGx5IGJ1aWx0LCBpZiBzaG93biBhZnRlciByZWFkeSByZXR1cm5zLgoKICAgIEBtb2R1bGUgdGhydXN0LWRhdGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LWRhdGEtY29udmVudGlvbi1zdGFydAogICAgKiovCiAgICByZXR1cm4gbmV3IENvbnZlbnRpb24oewogICAgICAgIGNvdW50ZG93bjogZnVuY3Rpb24odGhydXN0KQogICAgICAgIHsKICAgICAgICAgICAgLy8gU3Vic2NyaWJlIHRvIHRoZSB3YWl0IGFuZCBzdG9wIGV2ZW50cwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3N0b3AnLCBzdG9wQ2FsbGJhY2spOwogICAgICAgIH0sCiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpCiAgICAgICAgewogICAgICAgICAgICAvLyBVbnN1YnNjcmliZSBmcm9tIHRoZSB3YWl0IGFuZCBzdG9wIGV2ZW50cwogICAgICAgICAgICB0aHJ1c3QuZGF0YS51bnN1YnNjcmliZSgndGhydXN0L2RhdGEvd2FpdCcsIHdhaXRDYWxsYmFjayk7CiAgICAgICAgICAgIHRocnVzdC5kYXRhLnVuc3Vic2NyaWJlKCd0aHJ1c3QvZGF0YS9zdG9wJywgc3RvcENhbGxiYWNrKTsKCiAgICAgICAgICAgIC8vIGRlZmVyIHVudGlsIGFueSBvZiB0aGUgZXZlbnRzIHRoYXQgd2VyZSBjYXB0dXJlZCBhcmUgcmVzb2x2ZWQsIG9yIHRoZSBkZWxheSBwYXNzZXMuCiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgcmV0dXJuIHdoZW4uYW55KFt3aGVuLmFsbCh3aGVuUXVldWUpLCB3aGVuLmRlbGF5KHRocnVzdC5jZmcuZGF0YS5maW5pc2hUaW1lb3V0KV0sIGRlZmVyLnJlc29sdmUsIGRlZmVyLnJlc29sdmUpOwogICAgICAgIH0KICAgIH0pOwp9KTsKLyohIFRocnVzdCBKUyBGcmFtZXdvcmsgLSB2MC4xLjAgLSAyMDEyLTA4LTI5CiogdGhydXN0LWhvbWUKKiBDb3B5cmlnaHQgKGMpIDIwMTIgRGF2aWQgRHJpc2NvbGw7IExpY2Vuc2VkIE1JVCAqLwoKCmRlZmluZSgndGhydXN0L2RvbS9qcXVlcnkuaW50ZXJmYWNlJyxbJ2pxdWVyeSddLApmdW5jdGlvbiAoalF1ZXJ5KQp7CiAgICB2YXIgalF1ZXJ5TWV0aG9kc1RvSWdub3JlID0gWydjb25zdHJ1Y3RvcicsICdpbml0JywgJ3NlbGVjdG9yJywgJ2pxdWVyeScsICdyZWFkeScsICdleHRlbmQnLCAncXVldWUnLCAnZGVxdWV1ZScsICdjbGVhclF1ZXVlJywgJ3Byb21pc2UnLCAnYmluZCcsICd1bmJpbmQnLCAnbGl2ZScsICdkaWUnLCAnZGVsZWdhdGUnLCAndW5kZWxlZ2F0ZScsICdibHVyJywgJ2ZvY3VzJywgJ2ZvY3VzaW4nLCAnZm9jdXNvdXQnLCAnbG9hZCcsICdyZXNpemUnLCAnc2Nyb2xsJywgJ3VubG9hZCcsICdjbGljaycsICdkYmxjbGljaycsICdtb3VzZWRvd24nLCAnbW91c2V1cCcsICdtb3VzZW1vdmUnLCAnbW91c2VvdmVyJywgJ21vdXNlb3V0JywgJ21vdXNlZW50ZXInLCAnbW91c2VsZWF2ZScsICdjaGFuZ2UnLCAnc2VsZWN0JywgJ3N1Ym1pdCcsICdrZXlkb3duJywgJ2tleXByZXNzJywgJ2tleXVwJywgJ2Vycm9yJywgJ2RvbU1hbmlwJywgJ3NlcmlhbGl6ZScsICdzZXJpYWxpemVBcnJheScsICdhamF4U3RhcnQnLCAnYWpheFN0b3AnLCAnYWpheENvbXBsZXRlJywgJ2FqYXhFcnJvcicsICdhamF4U3VjY2VzcycsICdhamF4U2VuZCcsICdfdG9nZ2xlJywgJ2ZhZGVUbycsICdzdG9wJywgJ3NsaWRlRG93bicsICdzbGlkZVVwJywgJ3NsaWRlVG9nZ2xlJywgJ2ZhZGVJbicsICdmYWRlT3V0JywgJ2ZhZGVUb2dnbGUnLCAvKiBUaGVzZSBtZXRob2RzIGFyZSBoZXJlIGJlY2F1c2Ugd2UgYnVpbGQgYSBjdXN0b20gb25lIHRoYXQgZG9lcyB0aGUgam9iIHdpdGggbmFtZSBzcGFjZWQgZXZlbnRzICovJ29uJywgJ29mZicsICdvbmUnXSwKICAgICAgICBzbGljZSAgICAgICAgICAgICAgICAgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CgogICAgLy8jcmVnaW9uIGpRdWVyeSBJbnRlcmZhY2UgTGF5ZXIKICAgIHZhciB1cGRhdGVJbnRlcm5hbHMgPSBmdW5jdGlvbiAoc2VsZWN0b3IpCiAgICB7CiAgICAgICAgaWYgKHNlbGVjdG9yKQogICAgICAgICAgICB0aGlzLl9jb250ZXh0ID0galF1ZXJ5KHNlbGVjdG9yKTsKICAgICAgICB0aGlzLmNvbnRleHQgPSB0aGlzLl9jb250ZXh0LmNvbnRleHQ7CiAgICAgICAgdGhpcy5zZWxlY3RvciA9IHRoaXMuX2NvbnRleHQuc2VsZWN0b3I7CgogICAgICAgIC8vIExhemlseSByZW1vdmUgbWlzc2luZyBzdWRvLWFycmF5IGVsZW1lbnRzLgogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmxlbmd0aCB8fCAwLCBpTGVuID0gdGhpcy5fY29udGV4dC5jb250ZXh0OyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICBkZWxldGUgdGhpc1tpXTsKCiAgICAgICAgdGhpcy5sZW5ndGggPSB0aGlzLl9jb250ZXh0Lmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICB0aGlzW2ldID0gdGhpcy5fY29udGV4dFtpXTsKICAgIH07CgogICAgdmFyIGluaXRDb250ZXh0ID0gZnVuY3Rpb24gKGNvbnRleHQpCiAgICB7CiAgICAgICAgLy8gSWYgdGhlIGNvbnRleHQgaXMgYSBqUXVlcnkgY29udGV4dCwgcmVmZXJlbmNlIHRoYXQuCiAgICAgICAgLy8gSWYgaXQgaXNuJ3QgYSBqUXVlcnkgY29udGV4dCwgcnVuIGl0IHRocm91Z2ggalF1ZXJ5LgogICAgICAgIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dCA6IGpRdWVyeShjb250ZXh0KTsKCiAgICAgICAgLy8gS2VlcCBhIGNhY2hlIG9mIGFsbCBkb20gc2VsZWN0b3JzLCBmb3IgY2xlYW4gdXAgbGF0ZXIuCiAgICAgICAgLy9pZiAodGhpcy5fcGFyZW50RG9tICYmIHRoaXMuX3BhcmVudERvbSAhPT0gdGhpcykgdGhpcy5fcGFyZW50RG9tLl9pbnRlcm5hbFF1ZXJpZXMucHVzaCh0aGlzKTsKCiAgICAgICAgLy8gVXBkYXRlIHRoZSBpbnRlcm5hbHMgdG8gbWF0Y2ggdGhlIG1pbWljaW5nIG9mIGpRdWVyeS4KICAgICAgICB1cGRhdGVJbnRlcm5hbHMuY2FsbCh0aGlzKTsKICAgIH07CgogICAgdmFyIHNvbWVGaWx0ZXIgPSBmdW5jdGlvbiAoaSkgeyByZXR1cm4gZnVuY3Rpb24gKGUsIGluZGV4KSB7IHJldHVybiBlID09PSBpOyB9OyB9LAogICAgLy8gV3JhcHMgYSBqUXVlcnkgbWV0aG9kLCB3aXRoIG91ciBvd24gdmVyc2lvbiBvZiBpdC4KICAgICAgICBtZXRob2RGYWN0b3J5ID0gZnVuY3Rpb24gKG1ldGhvZCwgRG9tRmFjYWRlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gUmV0dXJucyBhIG1ldGhvZCwgdGhhdCB1bndyYXBzIGFueSBEb21GYWNhZGUgZmFjYWRlIG9iamVjdHMKICAgICAgICAgICAgLy8gVGhlbiBpdCBoYW5kcyBpdCBvZmYgdG8galF1ZXJ5LgogICAgICAgICAgICAvLyBBbmFseXNpbmcgdGhlIHJlc3BvbnNlLCB3ZSBkZWNpZGUgaWYgalF1ZXJ5IGdhdmUgdXMgb25lIG9mIHRoZSBmb2xsb3dpbmc6CiAgICAgICAgICAgIC8vICAgICAgICBBIGpRdWVyeSBpbnN0YW5jZSwgdGhlbiB3ZSBkZWNpZGUgaWYgaXQgaXM6CiAgICAgICAgICAgIC8vICAgICAgICAgICAgYSBuZXcgaW5zdGFuY2UsIGVnIC5jaGlsZHJlbigpCiAgICAgICAgICAgIC8vICAgICAgICAgICAgdGhlIHNhbWUgaW5zdGFuY2UsIGVnIC5jc3MoKQogICAgICAgICAgICAvLyAgICAgICAgUmV0dXJuZWQgZGF0YSwgZWcgLnBvc2l0aW9uKCkgb3IgLmlzKCkKICAgICAgICAgICAgLy8gICAgICAgICAgICBSZXR1cm4gdGhhdCBkYXRhLgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gU2VhcmNoIGFsbCBhcmd1bWVudHMsIGlmIHdlIGZpbmQgYSBEb21GYWNhZGUsIHVud3JhcCBpdCB0byB0aGUgalF1ZXJ5IGNvbnRleHQuCiAgICAgICAgICAgICAgICAvLyBqUXVlcnkgZG9lc250IHVuZGVyc3RhbmQgRG9tRmFjYWRlIHdyYXBwZXJzLCBpdCBvbmx5IHVuZGVyc3RhbmRzIGpRdWVyeS4KICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBhcmdzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgICAgICAgICAgICAgICAgICBpZiAoYXJnc1tpXSBpbnN0YW5jZW9mIERvbUZhY2FkZSkKICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tpXSA9IGFyZ3NbaV0uX2NvbnRleHQ7CgogICAgICAgICAgICAgICAgLy8gQ2FwdHVyZSB0aGUgcmV0dXJuIHZhbHVlIGZvciBhbmFseXNpcyBhbmQgcGFzcyBpdCBhbG9uZyB0byB0aGUgaW50ZXJuYWwgalF1ZXJ5IGNvbnRleHQgYW5kIGl0cyBtZXRob2QuCiAgICAgICAgICAgICAgICAvLyBDYWxsIGluIHBsYWNlIGFzIGlmIGl0IHdlcmUgY2FsbGVkIG5vcm1hbGx5LgogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRleHQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IHRoaXMuX2NvbnRleHRbbWV0aG9kXS5hcHBseSh0aGlzLl9jb250ZXh0LCBhcmdzKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHJldHVybiB2YWx1ZSBpcyBhIGpRdWVyeSBpbnN0YW5jZQogICAgICAgICAgICAgICAgICAgIGlmIChyZXQgaW5zdGFuY2VvZiBqUXVlcnkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBpdCdzIHRoZSBzYW1lIGluc3RhbmNlLCB0aGVuIHdlIGp1c3QgdXBkYXRlIHRoZSBpbnRlcm5hbHMsIGFuZCByZXR1cm4gb3Vyc2VsZi4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldC5zZWxlY3RvciA9PT0gdGhpcy5zZWxlY3RvciAmJiByZXQuY29udGV4dCA9PT0gdGhpcy5jb250ZXh0KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVJbnRlcm5hbHMuY2FsbCh0aGlzLCByZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgaXQgaXMgYSBuZXcgaW5zdGFuY2UsIHJldHVybiBhIG5ldyBmYWNhZGUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEb21GYWNhZGUodGhpcy5tb2R1bGUsIHRoaXMsIHJldCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIFJlZ2FyZGxlc3MgdXBkYXRlIG91ciBpbnRlcm5hbHMuCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlSW50ZXJuYWxzLmNhbGwodGhpcyk7CiAgICAgICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSByZXR1cm4gdmFsdWUsIGZvciBhIG1ldGhvZCBsaWtlIC5pcygpIG9yIC5wb3NpdGlpb24oKQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICB2YXIgdXBkYXRlUHJvdG90eXBlID0gZnVuY3Rpb24gKHByb3RvLCBEb21GYWNhZGUpCiAgICB7CiAgICAgICAgLy8gV3JhcCBqUXVlcnkgYW5kIGZpbHRlciBvdXQgbWV0aG9kcyB3ZSBkbyBub3Qgd2FudCBhbnlvbmUgdXNpbmcKICAgICAgICAvLyBXZSBhbHNvIGZpbHRlciBvdXQgbWV0aG9kcyB0aGF0IHdlIG92ZXJyaWRlLCBsaWtlIC5vbiBhbmQgLm9mZgogICAgICAgIGZvciAodmFyIGkgaW4galF1ZXJ5LmZuKQogICAgICAgICAgICBpZiAoT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwoalF1ZXJ5LmZuLCBpKSAmJiAhcHJvdG9baV0gJiYgIWpRdWVyeU1ldGhvZHNUb0lnbm9yZS5zb21lKHNvbWVGaWx0ZXIoaSkpKQogICAgICAgICAgICAgICAgcHJvdG9baV0gPSBtZXRob2RGYWN0b3J5KGksIERvbUZhY2FkZSk7CiAgICAgICAgcHJvdG8uJCA9IHByb3RvLmZpbmQ7CiAgICB9OwogICAgLy8jZW5kcmVnaW9uCgogICAgcmV0dXJuIHsKICAgICAgICB1cGRhdGVJbnRlcm5hbHM6IHVwZGF0ZUludGVybmFscywKICAgICAgICB1cGRhdGVQcm90b3R5cGU6IHVwZGF0ZVByb3RvdHlwZSwKICAgICAgICBpbml0Q29udGV4dCAgICA6IGluaXRDb250ZXh0CiAgICB9Owp9KTsKZGVmaW5lKCd0aHJ1c3QvZG9tL21haW4nLFsKICAgICdqcXVlcnknLAogICAgJ3RocnVzdC91dGlsJywKICAgICd0aHJ1c3QvbG9nJywKICAgICcuL2pxdWVyeS5pbnRlcmZhY2UnLAogICAgJ3RocnVzdC9mYWNhZGUnLAogICAgJ3RocnVzdC9ldmVudHMnCl0sCmZ1bmN0aW9uIChqUXVlcnksIHV0aWwsIGxvZywgalF1ZXJ5SW50ZXJmYWNlLCBmYWNhZGUsIGV2ZW50cykKewogICAgCiAgICAvLyNyZWdpb24gVmFyaWFibGUgZGVjbGFyYXRpb24KICAgIHZhciBmb3JtYXQgICAgICAgICAgPSB1dGlsLmZvcm1hdCwKICAgICAgICBleHRlbmQgICAgICAgICAgPSB1dGlsLmV4dGVuZCwKICAgICAgICB0eXBlICAgICAgICAgICAgPSB1dGlsLnR5cGUsCiAgICAgICAgcHJveHkgICAgICAgICAgID0gdXRpbC5wcm94eSwKICAgICAgICBoYXNPd24gICAgICAgICAgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAogICAgICAgIGlzT2JqZWN0ICAgICAgICA9IHV0aWwuaXNTaW1wbGVPYmplY3QsCiAgICAgICAgc2xpY2UgICAgICAgICAgID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAogICAgICAgIHdoZW4gICAgICAgICAgICA9IHV0aWwud2hlbiwKICAgICAgICBpbml0Q29udGV4dCAgICAgPSBqUXVlcnlJbnRlcmZhY2UuaW5pdENvbnRleHQsCiAgICAgICAgdXBkYXRlSW50ZXJuYWxzID0galF1ZXJ5SW50ZXJmYWNlLnVwZGF0ZUludGVybmFscywKICAgICAgICB1cGRhdGVQcm90b3R5cGUgPSBqUXVlcnlJbnRlcmZhY2UudXBkYXRlUHJvdG90eXBlLAogICAgICAgIERvbSwgRG9tTWV0aG9kcywgRG9tUHJvdG90eXBlOwogICAgLy8jZW5kcmVnaW9uCgogICAgLy8jcmVnaW9uIERhdGFGYWNhZGUKICAgIHZhciBEb21GYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCwgY29udGV4dCwgZmFrZSkKICAgIHsKICAgICAgICB0aGlzLm5hbWUgPSBwYXJlbnQubmFtZTsKICAgICAgICAvL3RoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgIC8vdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CiAgICAgICAgLy90aGlzLl9jYWxsYmFja3MgPSBwYXJlbnQuX2NhbGxiYWNrczsKICAgICAgICAvL3RoaXMuaW5pdEV2ZW50cygpOwoKICAgICAgICAvLyBXZSdyZSBidWlsZGluZyBhIGRvbSBzZWxlY3RvciwgYWthIGpxdWVyeSB3cmFwcGVyCiAgICAgICAgaWYgKGNvbnRleHQgJiYgZmFrZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIFJlZmVyZW5jZSB0aGUgcGFyZW50IG1vZHVsZS4KICAgICAgICAgICAgdGhpcy5fcGFyZW50RG9tID0gcGFyZW50Ll9wYXJlbnREb207CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJlbnREb20pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIEluaXQgdGhlIGNvbnRleHQKICAgICAgICAgICAgICAgIGluaXRDb250ZXh0LmNhbGwodGhpcywgY29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgbG9nLmRlYnVnKCdEb206IENyZWF0aW5nIG5ldyBEb20gZmFjYWRlJyk7CiAgICAgICAgICAgIHRoaXMuX3BhcmVudERvbSAgID0gdGhpczsKICAgICAgICAgICAgdGhpcy5fcm9vdENvbnRleHQgPSB0cnVlOwoKICAgICAgICAgICAgdGhpcy5jaGFuZ2VDb250ZXh0KGRvY3VtZW50KTsKCiAgICAgICAgICAgIGNyZWF0ZUZhY2FkZSh0aGlzKTsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMgPSBbXTsKICAgICAgICB9CiAgICB9KTsKICAgIHV0aWwuZXh0ZW5kKERvbUZhY2FkZS5mbiwgewogICAgICAgIGluaXQ6IGZ1bmN0aW9uIChmYWtlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMgPSB0aGlzLl9pbnRlcm5hbEV2ZW50cyB8fCBbXTsKICAgICAgICAgICAgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IEluaXRhbGl6aW5nIHsxfURvbSBmYWNhZGUnLCB0aGlzLm5hbWVzcGFjZSwgZmFrZSA/ICdmYWtlICcgOiAnJykpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIHN0YXJ0OiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IFN0YXJ0aW5nIERvbSBmYWNhZGUnLCB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBTdG9wcGluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lc3BhY2UpKTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLl9pbnRlcm5hbEV2ZW50cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX2ludGVybmFsRXZlbnRzW2ldOwogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgdGhpcy5jaGFuZ2VDb250ZXh0KHN1Yi5jb250ZXh0KTsKICAgICAgICAgICAgICAgIHRoaXMub2ZmLmFwcGx5KHRoaXMsICh1dGlsLmlzQXJyYXkoc3ViKSkgPyBzdWIgOiAodXRpbC5pc0FycmF5KHN1Yi5hcmdzKSkgPyBzdWIuYXJncyA6IFtdKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9yb290Q29udGV4dCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IERlc3Ryb3lpbmcgRG9tIGZhY2FkZScsIHRoaXMubmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5faW50ZXJuYWxFdmVudHM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2NvbnRleHQgPSBudWxsOwogICAgICAgICAgICBkZWxldGUgdGhpcy5fY29udGV4dDsKICAgICAgICB9CiAgICB9KTsKICAgIC8vI2VuZHJlZ2lvbgoKICAgIHZhciBjcmVhdGVGYWNhZGUgPSBmdW5jdGlvbiAoZG9tKQogICAgewogICAgICAgIGlmICghZG9tLnF1ZXJ5KQogICAgICAgICAgICBkb20ucXVlcnkgPSBmdW5jdGlvbiAoY29udGV4dCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0ICE9PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERvbUZhY2FkZShkb20ubW9kdWxlLCBkb20sIGNvbnRleHQsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRvbTsKICAgICAgICAgICAgfS5iaW5kKGRvbSk7CiAgICAgICAgcmV0dXJuIGRvbS5xdWVyeTsKICAgIH07CgogICAgLy8gVGhpcyBtZXRob2QgdXBkYXRlcyB0aGUgaW50ZXJuYWxzLCB0byBtaW1pYyBqUXVlcnkKICAgIHZhciBub3JtYWxpemVFdmVudHMgPSBmdW5jdGlvbiAoZXZlbnRzLCBuYW1lc3BhY2UpCiAgICB7CiAgICAgICAgLy8vIDxzdW1tYXJ5Pk5vcm1hbGl6ZXMgZXZlbnRzIHRvIHRha2Ugb24gdGhlIG5hbWVzcGFjZSBvZiB0aGUgcGFyZW50Ljwvc3VtbWFyeT4KICAgICAgICBpZiAoaXNPYmplY3QoZXZlbnRzKSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIEhhbmRsZXMga2V5IHZhbHVlIHBhcmlzIG9mIGV2ZW50cyB0byBoYW5kbGVycy4KICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBldmVudHMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGV2ZW50c1tpICsgbmFtZXNwYWNlXSA9IGV2ZW50c1tpXTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gSGFuZGxlIGFic2Vuc2Ugb2YgYW4gZXZlbnQsIHBhc3Mgb3VyIG5hbWVzcGFjZS4KICAgICAgICAgICAgaWYgKCFldmVudHMpCiAgICAgICAgICAgICAgICByZXR1cm4gbmFtZXNwYWNlOwoKICAgICAgICAgICAgLy8gU3BsaXQgdGhlIGV2ZW50cyB1cAogICAgICAgICAgICBldmVudHMgPSBldmVudHMuc3BsaXQoJyAnKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBldmVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBBZGQgb3VyIGN1c3RvbSBldmVudHMKICAgICAgICAgICAgICAgIGV2ZW50cy5wdXNoKGV2ZW50c1tpXSArIG5hbWVzcGFjZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gR3JhYiB0aGUgbmV3IGhhbGYgb2YgdGhlIGFycmF5IHRoYXQgd2UgY2FyZSBhb3V0LgogICAgICAgICAgICByZXR1cm4gZXZlbnRzLnNsaWNlKGV2ZW50cy5sZW5ndGggLyAyKS5qb2luKCcgJyk7CiAgICAgICAgfQogICAgfTsKCiAgICBEb21Qcm90b3R5cGUgPSB7CiAgICAgICAgY2hhbmdlQ29udGV4dDogZnVuY3Rpb24gKHNlbGVjdG9yKQogICAgICAgIHsKICAgICAgICAgICAgbG9nLmluZm8oZm9ybWF0KCdEb21bezB9XTogQ2hhbmdpbmcgRG9tIGNvbnRleHQnLCB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgICAgICB1cGRhdGVJbnRlcm5hbHMuY2FsbCh0aGlzLCBzZWxlY3Rvcik7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgb246IGZ1bmN0aW9uIChldmVudHMpCiAgICAgICAgewogICAgICAgICAgICBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogQmluZGluZyBldmVudHMuLi4nLCB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJnc1swXSA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoaXMubmFtZXNwYWNlKTsKICAgICAgICAgICAgdGhpcy5fY29udGV4dC5vbi5hcHBseSh0aGlzLl9jb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICBvbmU6IGZ1bmN0aW9uIChldmVudHMpCiAgICAgICAgewogICAgICAgICAgICBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogQmluZGluZyBvbmUgZXZlbnRzLi4uJywgdGhpcy5uYW1lc3BhY2UpKTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3NbMF0gPSBub3JtYWxpemVFdmVudHMoZXZlbnRzLCB0aGlzLm5hbWVzcGFjZSk7CiAgICAgICAgICAgIHRoaXMuX2NvbnRleHQub25lLmFwcGx5KHRoaXMuX2NvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIG9mZjogZnVuY3Rpb24gKGV2ZW50cykKICAgICAgICB7CiAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBVbmJpbmRpbmcgZXZlbnRzLi4uJywgdGhpcy5uYW1lc3BhY2UpKTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3NbMF0gPSBub3JtYWxpemVFdmVudHMoZXZlbnRzLCB0aGlzLm5hbWVzcGFjZSk7CiAgICAgICAgICAgIHRoaXMuX2NvbnRleHQub24uYXBwbHkodGhpcy5fY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgIH07CgogICAgdXBkYXRlUHJvdG90eXBlKERvbVByb3RvdHlwZSwgRG9tRmFjYWRlKTsKICAgIHV0aWwuZXh0ZW5kKERvbUZhY2FkZS5mbiwgRG9tUHJvdG90eXBlKTsKICAgIERvbUZhY2FkZS5mbi4kID0gRG9tRmFjYWRlLmZuLmZpbmQ7CgogICAgLy8jcmVnaW9uIERvbQogICAgRG9tID0gZnVuY3Rpb24gKC8qICRyZWYgKi8gbmFtZSwgLyogJHJlZiAqLyBtZWRpYXRvcikKICAgIHsKICAgICAgICAvLy8gPHN1bW1hcnk+VGhlIERvbTwvc3VtbWFyeT4KICAgICAgICAvLyBFbmZvcmNlIG5ldwogICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBEb20pKQogICAgICAgICAgICByZXR1cm4gbmV3IERvbShuYW1lLCBtZWRpYXRvcik7CgogICAgICAgIGlmICghbmFtZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb206IG1vZHVsZSBuYW1lIG11c3QgYmUgZGVmaW5lZC4nKTsKCiAgICAgICAgbG9nLmRlYnVnKCdEYXRhOiBDcmVhdGluZyBuZXcgRGF0YScpOwoKICAgICAgICB0aGlzLm1lZGlhdG9yID0gbWVkaWF0b3I7CiAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gdGhpcy5tZWRpYXRvci5fY2FsbGJhY2tzOwogICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CgogICAgICAgIC8qdGhpcy5fcGFyZW50RG9tID0gdGhpczsKICAgICAgICB0aGlzLl9yb290Q29udGV4dCA9IHRydWU7CgogICAgICAgIGNyZWF0ZUZhY2FkZSh0aGlzKTsKICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cyA9IFtdOwogICAgICAgIHRoaXMuY2hhbmdlQ29udGV4dChkb2N1bWVudCk7Ki8KICAgIH07CgogICAgRG9tLnByb3RvdHlwZSA9IERvbS5mbiA9IHV0aWwuZXh0ZW5kKHt9LCBEb21Qcm90b3R5cGUsCiAgICB7CiAgICAgICAgY3JlYXRlRmFjYWRlOiBmdW5jdGlvbiAodGhydXN0LCBtb2R1bGUsIGZhY2FkZXMpCiAgICAgICAgewogICAgICAgICAgICBpZiAobW9kdWxlLmRvbSAmJiAhKGZhY2FkZXMuZG9tIGluc3RhbmNlb2YgRG9tRmFjYWRlKSkgdGhyb3cgbmV3IEVycm9yKCciZG9tIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CgogICAgICAgICAgICB2YXIgZG9tOwogICAgICAgICAgICBpZiAoZmFjYWRlcy5kb20pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMuZG9tLnVwZGF0ZUZhY2FkZShtb2R1bGUsIHRoaXMsIGRvY3VtZW50KTsKICAgICAgICAgICAgICAgIGRvbSA9IGZhY2FkZXMuZG9tOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZG9tID0gZmFjYWRlcy5kb20gPSBuZXcgRG9tRmFjYWRlKG1vZHVsZSwgdGhpcywgZG9jdW1lbnQpOwogICAgICAgICAgICAgICAgbW9kdWxlLmRvbSA9IG1vZHVsZS4kID0gZG9tLnF1ZXJ5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkb207CiAgICAgICAgfQogICAgfSwgZXZlbnRzKTsKCiAgICAvLyNlbmRyZWdpb24KCiAgICByZXR1cm4gRG9tOwp9KTsKCmRlZmluZSgndGhydXN0L2RvbScsIFsndGhydXN0L2RvbS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2FjdGlvbicsWwogICAgJ3RocnVzdC9jb252ZW50aW9uJywKICAgICd0aHJ1c3QvdXRpbCcsCiAgICAnanF1ZXJ5JwpdLApmdW5jdGlvbiAoQ29udmVudGlvbiwgdXRpbCwgJCkKewogICAgdmFyIGZvcm1hdCAgICAgPSB1dGlsLmZvcm1hdCwKICAgICAgICBBQ1RJT05TICAgID0gJ2FjdGlvbnMnLAogICAgICAgIFNUUklORyAgICAgPSAnc3RyaW5nJywKICAgICAgICBpc0Z1bmN0aW9uID0gdXRpbC5pc0Z1bmN0aW9uLAogICAgICAgIGlzU3RyaW5nICAgPSB1dGlsLmlzU3RyaW5nLAogICAgICAgIGlzQXJyYXkgICAgPSB1dGlsLmlzQXJyYXk7CgogICAgdmFyIGFjdGlvbkhhbmRsZXJzID0gewogICAgICAgIF9yZWdpc3RyYXRpb25zOiB7fSwKICAgICAgICByZWdpc3RlcjogZnVuY3Rpb24gKGV2ZW50TmFtZSwgYWNpb25OYW1lLCBoYW5kbGVyLCBjb250ZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZiAoIXRoYXQuX3JlZ2lzdHJhdGlvbnNbZXZlbnROYW1lXSkKICAgICAgICAgICAgICAgIHRoYXQuX3JlZ2lzdHJhdGlvbnNbZXZlbnROYW1lXSA9IHt9OwoKICAgICAgICAgICAgaWYgKCF0aGF0Ll9yZWdpc3RyYXRpb25zW2V2ZW50TmFtZV1bYWNpb25OYW1lXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhhdC5fcmVnaXN0cmF0aW9uc1tldmVudE5hbWVdW2FjaW9uTmFtZV0gPSBoYW5kbGVyOwogICAgICAgICAgICAgICAgaWYgKGNvbnRleHQpIHRoYXQuX3JlZ2lzdHJhdGlvbnNbZXZlbnROYW1lXVthY2lvbk5hbWVdLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ1RoZSBhY3Rpb24gezF9IGhhbmRsZXIgInswfSIgaGFzIGFscmVhZHkgYmVlbiB0YWtlbiEnLCBhY2lvbk5hbWUsIGV2ZW50TmFtZSkpOwogICAgICAgIH0sCiAgICAgICAgdW5yZWdpc3RlcjogZnVuY3Rpb24gKGV2ZW50TmFtZSwgYWNpb25OYW1lKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZiAodGhhdC5fcmVnaXN0cmF0aW9uc1tldmVudE5hbWVdICYmIHRoYXQuX3JlZ2lzdHJhdGlvbnNbZXZlbnROYW1lXVthY2lvbk5hbWVdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGF0Ll9yZWdpc3RyYXRpb25zW2V2ZW50TmFtZV1bYWNpb25OYW1lXSA9IG51bGw7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhhdC5fcmVnaXN0cmF0aW9uc1tldmVudE5hbWVdW2FjaW9uTmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNhbGxiYWNrRm9yOiBmdW5jdGlvbiAoZXZlbnROYW1lLCByZXR1cm5SZXN1bHRzKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgYWN0aW9uQXR0cmlidXRlID0gJ2RhdGEtYWN0aW9uLScgKyBldmVudE5hbWUsCiAgICAgICAgICAgICAgICByZXR1cm5SZXN1bHRzRGVmaW5lZCA9IHR5cGVvZiByZXR1cm5SZXN1bHRzICE9PSAndW5kZWZpbmVkJzsKCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlVmFsdWUgPSAkKHRoaXMpLmF0dHIoYWN0aW9uQXR0cmlidXRlKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlVmFsdWUgPT09IFNUUklORykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWV0aG9kID0gdGhhdC5fcmVnaXN0cmF0aW9uc1tldmVudE5hbWVdW2F0dHJpYnV0ZVZhbHVlXTsKICAgICAgICAgICAgICAgICAgICBpZiAobWV0aG9kKQogICAgICAgICAgICAgICAgICAgICAgICBtZXRob2QuYXBwbHkobWV0aG9kLmNvbnRleHQgfHwgdGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmV0dXJuUmVzdWx0c0RlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5SZXN1bHRzOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9OwoKICAgIHJldHVybiBuZXcgQ29udmVudGlvbih7CiAgICAgICAgcHJvcGVydGllczogW0FDVElPTlNdLAogICAgICAgIGlnbml0ZTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgJCh3aW5kb3cuZG9jdW1lbnQuYm9keSkub24oJ2NsaWNrLmFjdGlvbnMnLCAnYSwgYnV0dG9uLCBpbnB1dFt0eXBlPSJidXR0b24iXSwgaW5wdXRbdHlwZT0ic3VibWl0Il0nLCBhY3Rpb25IYW5kbGVycy5jYWxsYmFja0ZvcignY2xpY2snLCBmYWxzZSkpOwogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChmYWNhZGUsIG1vZHVsZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kdWxlLmNvbnZlbnRpb24oQUNUSU9OUyksCiAgICAgICAgICAgICAgICBkb20gPSBmYWNhZGUsCiAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZSA9IG1vZHVsZS5pbnN0YW5jZTsKCiAgICAgICAgICAgIGlmIChhY3Rpb25zKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBhY3Rpb25FdmVudCBpbiBhY3Rpb25zKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb25Db2xsZWN0aW9uID0gYWN0aW9uc1thY3Rpb25FdmVudF07CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYWN0aW9uTmFtZSBpbiBhY3Rpb25Db2xsZWN0aW9uKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGFjdGlvbkNvbGxlY3Rpb25bYWN0aW9uTmFtZV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oYWN0aW9uKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IFthY3Rpb25FdmVudCwgYWN0aW9uTmFtZSwgYWN0aW9uXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpc1N0cmluZyhhY3Rpb24pKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gW2FjdGlvbkV2ZW50LCBhY3Rpb25OYW1lLCBtb2R1bGVJbnN0YW5jZVthY3Rpb25dXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpc0FycmF5KGFjdGlvbikpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGFjdGlvblswXSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IFthY3Rpb25FdmVudCwgYWN0aW9uTmFtZV0uY29uY2F0KGFjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpc1N0cmluZyhhY3Rpb25bMF0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvblswXSA9IG1vZHVsZUluc3RhbmNlW2FjdGlvblswXV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IFthY3Rpb25FdmVudCwgYWN0aW9uTmFtZV0uY29uY2F0KGFjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uSGFuZGxlcnMucmVnaXN0ZXIuYXBwbHkoYWN0aW9uSGFuZGxlcnMsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKGZhY2FkZSwgbW9kdWxlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGRvbSA9IGZhY2FkZSwKICAgICAgICAgICAgICAgIGFjdGlvbnMgPSBtb2R1bGUuY29udmVudGlvbihBQ1RJT05TKSwKICAgICAgICAgICAgICAgIG1vZHVsZUluc3RhbmNlID0gbW9kdWxlLmluc3RhbmNlLAogICAgICAgICAgICAgICAgZG9tID0gZmFjYWRlLmRvbTsKCiAgICAgICAgICAgIGlmIChhY3Rpb25zKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBhY3Rpb25FdmVudCBpbiBhY3Rpb25zKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb25Db2xsZWN0aW9uID0gYWN0aW9uc1thY3Rpb25FdmVudF07CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYWN0aW9uTmFtZSBpbiBhY3Rpb25Db2xsZWN0aW9uKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uSGFuZGxlcnMudW5yZWdpc3RlcihhY3Rpb25FdmVudCwgYWN0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7Cn0pOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9jb250ZXh0JyxbJ3RocnVzdC9jb252ZW50aW9uJywgJy4uL2pxdWVyeS5pbnRlcmZhY2UnXSwKZnVuY3Rpb24gKENvbnZlbnRpb24sIGpRdWVyeUludGVyZmFjZSkKewogICAgdmFyIENPTlRFWFQgICAgICAgICA9ICdjb250ZXh0JywKICAgICAgICB1cGRhdGVJbnRlcm5hbHMgPSBqUXVlcnlJbnRlcmZhY2UudXBkYXRlSW50ZXJuYWxzOwoKICAgIHJldHVybiBuZXcgQ29udmVudGlvbih7CiAgICAgICAgcHJvcGVydGllczogW0NPTlRFWFRdLAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAoZmFjYWRlLCBtb2R1bGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IG1vZHVsZS5jb252ZW50aW9uKENPTlRFWFQpLAogICAgICAgICAgICAgICAgZG9tICAgICA9IGZhY2FkZTsKCiAgICAgICAgICAgIGlmIChjb250ZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1cGRhdGVJbnRlcm5hbHMuY2FsbChkb20sIGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7Cn0pOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9ldmVudCcsWwogICAgJ3RocnVzdC9jb252ZW50aW9uJywKICAgICd0aHJ1c3QvdXRpbCcKXSwKZnVuY3Rpb24gKENvbnZlbnRpb24sIHV0aWwpCnsKICAgIHZhciBDT05URVhUICAgID0gJ2NvbnRleHQnLAogICAgICAgIEVWRU5UUyAgICAgPSAnZXZlbnRzJywKICAgICAgICBpc0Z1bmN0aW9uID0gdXRpbC5pc0Z1bmN0aW9uLAogICAgICAgIGlzU3RyaW5nICAgPSB1dGlsLmlzU3RyaW5nLAogICAgICAgIGlzQXJyYXkgICAgPSB1dGlsLmlzQXJyYXk7CgogICAgcmV0dXJuIG5ldyBDb252ZW50aW9uKHsKICAgICAgICBwcm9wZXJ0aWVzOiBbRVZFTlRTXSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKGZhY2FkZSwgbW9kdWxlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyAgICAgICAgICA9IG1vZHVsZS5jb252ZW50aW9uKEVWRU5UUyksCiAgICAgICAgICAgICAgICBvcHRpb25hbENvbnRleHQgPSBtb2R1bGUuY29udmVudGlvbihDT05URVhUKSwKICAgICAgICAgICAgICAgIGRvbSAgICAgICAgICAgICA9IG9wdGlvbmFsQ29udGV4dCA/IGZhY2FkZS5xdWVyeShvcHRpb25hbENvbnRleHQpIDogZmFjYWRlLAogICAgICAgICAgICAgICAgbW9kdWxlSW5zdGFuY2UgID0gbW9kdWxlLmluc3RhbmNlOwoKICAgICAgICAgICAgaWYgKGV2ZW50cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZpbml0aW9uID0gZXZlbnRzW2V2ZW50XSwKICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50OwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihkZWZpbml0aW9uKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudCA9IFtldmVudCwgZGVmaW5pdGlvbl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZXZlbnQgbWV0aG9kIGlzIGEgc3RyaW5nLCB3ZSBzZWFyY2ggdG8gdmVyaWZ5IHRoYXQgbW9kdWxlIG1ldGhvZCBleGlzdHMgb24gdGhlIGdpdmVuIG1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgdGhlbiBiaW5kIGl0LCB3aXRoIHRoZSBwcm9wZXIgY29udGV4dC4KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpc1N0cmluZyhkZWZpbml0aW9uKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudCA9IFtldmVudCwgbW9kdWxlSW5zdGFuY2VbZGVmaW5pdGlvbl1dOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIGV2ZW50IG1vZHVsZSBpcyBhbiBhcnJheSwgd2UgYXBwbHkgdGhlIGFycmF5IGFzIGlmIGl0IHdlcmUgYSBkaXJlY3QgY2FsbCB0byBzdWJzY3JpYmUsIGJ5IHB1c2hpbmcgdGhlIGV2ZW50IG5hbWUgb24gdGhlIGZyb250LgogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzQXJyYXkoZGVmaW5pdGlvbikpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnQgPSBkZWZpbml0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGRlZmluaXRpb24ubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoZGVmaW5pdGlvbltpXSkgJiYgbW9kdWxlSW5zdGFuY2VbZGVmaW5pdGlvbltpXV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvbltpXSA9IG1vZHVsZUluc3RhbmNlW2RlZmluaXRpb25baV1dOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudC51bnNoaWZ0KDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBDYWxsIHRoZSBvbiBtZXRob2QsIHdpdGggb3VyIGFyZ3VtZW50cy4KICAgICAgICAgICAgICAgICAgICBkb20ub24uYXBwbHkoZG9tLCBiaW5kRXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy9TYXZlIGEgcmVmZXJlbmNlIG9mIHRoZSBjb250ZXh0LCBmb3IgbGF0ZXIgdW5iaW5kaW5nLgogICAgICAgICAgICAgICAgZXZlbnRzLmNvbnRleHQgPSBkb20uX2NvbnRleHRbMF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChmYWNhZGUsIG1vZHVsZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSBtb2R1bGUuY29udmVudGlvbihFVkVOVFMpLAogICAgICAgICAgICAgICAgZG9tID0gZmFjYWRlOwoKICAgICAgICAgICAgaWYgKGV2ZW50cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZG9tLmNoYW5nZUNvbnRleHQoZXZlbnRzLmNvbnRleHQpOwogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50cy5jb250ZXh0OwoKICAgICAgICAgICAgICAgIGlmIChkb20uX2NvbnRleHQpCiAgICAgICAgICAgICAgICAgICAgZG9tLm9mZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7Cn0pOwovKiEgVGhydXN0IEpTIEZyYW1ld29yayAtIHYwLjEuMCAtIDIwMTItMDgtMjkKKiB0aHJ1c3QtaG9tZQoqIENvcHlyaWdodCAoYykgMjAxMiBEYXZpZCBEcmlzY29sbDsgTGljZW5zZWQgTUlUICovCgoKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvbWFpbicsWwogICAgJ3JlcXVpcmUnLAogICAgJ3RocnVzdC91dGlsJywKICAgICd0aHJ1c3QvZGF0YScsCiAgICAndGhydXN0L2xvZycsCiAgICAndGhydXN0L2NvbmZpZycsCiAgICAnZG9tUmVhZHknLAogICAgJ2xvZGFzaCcsCiAgICAndGhydXN0L2ZhY2FkZScKXSwKICAgIGZ1bmN0aW9uIChyZXF1aXJlLCB1dGlsLCB0RGF0YSwgbG9nLCBjb25maWcsIGRvbVJlYWR5LCBfLCBmYWNhZGUpCiAgICB7CiAgICAgICAgdmFyIExPTkcgICAgICAgID0gJ2xvbmcnLAogICAgICAgICAgICBTSE9SVCAgICAgICA9ICdzaG9ydCcsCiAgICAgICAgICAgIElEICAgICAgICAgID0gJ2lkJywKICAgICAgICAgICAgdGVtcGxhdGVzICAgPSB7CiAgICAgICAgICAgICAgICBsb25nOiB7fSwKICAgICAgICAgICAgICAgIHNob3J0OiB7fSwKICAgICAgICAgICAgICAgIGlkOiB7fQogICAgICAgICAgICB9LAogICAgICAgICAgICBkZWVwQ29weSAgICA9IHV0aWwuZGVlcENvcHksCiAgICAgICAgICAgIGZvcm1hdCAgICAgID0gdXRpbC5mb3JtYXQsCiAgICAgICAgICAgIGVhY2ggICAgICAgID0gdXRpbC5lYWNoLAogICAgICAgICAgICB3aGVuICAgICAgICA9IHV0aWwud2hlbiwKICAgICAgICAgICAgbWVtb2l6ZSAgICAgPSB1dGlsLm1lbW9pemUsCiAgICAgICAgICAgIGdldExvbmdOYW1lID0gZnVuY3Rpb24gKG5hbWUsIHR5cGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIHJldHVybiAodGhhdC5zaG9ydE5hbWUobmFtZSkgKyAnLicgKyAodHlwZSB8fCB0aGF0LmRlZmF1bHRUeXBlKSArIHRoYXQuZXh0ZW5zaW9uKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRTaG9ydE5hbWUgPSBmdW5jdGlvbiAobmFtZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwucmVkdWNlKHRoYXQudGVtcGxhdGVUeXBlcywgZnVuY3Rpb24gKG1lbW8sIHgpIHsgcmV0dXJuIG1lbW8ucmVwbGFjZSgnLicgKyB4LnRvTG93ZXJDYXNlKCkgKyB0aGF0LmV4dGVuc2lvbiwgJycpOyB9LCBuYW1lLnRvTG93ZXJDYXNlKCkpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldFRlbXBsYXRlSWQgPSBmdW5jdGlvbiAobmFtZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2hvcnROYW1lKG5hbWUpLnJlcGxhY2UoL1wvL2csICctJyk7CiAgICAgICAgICAgIH07CgogICAgICAgIHZhciBUZW1wbGF0ZSA9IGZ1bmN0aW9uICgvKiAkcmVmICovIGNvbmZpZywgLyogJHJlZiAqLyBkYXRhKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgICAgICAgICAgID0gdGhpczsKICAgICAgICAgICAgY29uZmlnICAgICAgICAgICAgID0gY29uZmlnLnRlbXBsYXRlOwogICAgICAgICAgICB0aGF0LmV4dGVuc2lvbiAgICAgPSBjb25maWcuZXh0ZW5zaW9uOwogICAgICAgICAgICB0aGF0LnRlbXBsYXRlUGF0aHMgPSBjb25maWcudHlwZXM7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVUeXBlcyA9IHV0aWwubWFwKGNvbmZpZy50eXBlcywgZnVuY3Rpb24gKHgsIGkpIHsgcmV0dXJuIGkgfSk7CiAgICAgICAgICAgIHRoYXQuYmFzZVVybCAgICAgICA9IGNvbmZpZy5iYXNlVXJsOwogICAgICAgICAgICB0aGF0LmRlZmF1bHRUeXBlICAgPSBjb25maWcuZGVmYXVsdFR5cGU7CiAgICAgICAgICAgIHRoYXQuZXZhbHVhdG9ycyAgICA9IGNvbmZpZy5ldmFsdWF0b3JzOwogICAgICAgICAgICB0aGF0LnRlbXBsYXRlcyAgICAgPSBkZWVwQ29weSh7fSwgdGVtcGxhdGVzKTsKICAgICAgICAgICAgdGhhdC5sb25nTmFtZSAgICAgID0gbWVtb2l6ZShnZXRMb25nTmFtZS5iaW5kKHRoYXQpKTsKICAgICAgICAgICAgdGhhdC5zaG9ydE5hbWUgICAgID0gbWVtb2l6ZShnZXRTaG9ydE5hbWUuYmluZCh0aGF0KSk7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVJZCAgICA9IG1lbW9pemUoZ2V0VGVtcGxhdGVJZC5iaW5kKHRoYXQpKTsKICAgICAgICAgICAgdGhhdC5lbmdpbmVzICAgICAgID0ge307CiAgICAgICAgICAgIHRoYXQuZGF0YSAgICAgICAgICA9IGRhdGE7CgogICAgICAgICAgICByZXF1aXJlKFsodGhhdC50ZW1wbGF0ZVBhdGhzW2NvbmZpZy5kZWZhdWx0VHlwZV0gfHwgJ3RocnVzdC90ZW1wbGF0ZS8nICsgY29uZmlnLmRlZmF1bHRUeXBlKV0sIGZ1bmN0aW9uIChlbmdpbmUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQuZW5naW5lc1tjb25maWcuZGVmYXVsdFR5cGVdID0gZW5naW5lOwoKICAgICAgICAgICAgICAgIGRvbVJlYWR5KGZ1bmN0aW9uICgpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgXyhkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0JykpCiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24oeCkgeyByZXR1cm4gISF4LmdldEF0dHJpYnV0ZSgnZGF0YS10ZW1wbGF0ZScpOyB9KQogICAgICAgICAgICAgICAgICAgICAgICAuZm9yRWFjaCh0aGF0LmNyZWF0ZUZyb21Eb21Ob2RlLmJpbmQodGhhdCkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAobmFtZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gbnVsbCwgdGhhdCA9IHRoaXMsIHRlbXBsYXRlcyA9IHRoYXQudGVtcGxhdGVzOwogICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlID0gdGVtcGxhdGVzW0xPTkddW3RoYXQubG9uZ05hbWUobmFtZSldKQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRlbXBsYXRlID0gdGVtcGxhdGVzW1NIT1JUXVt0aGF0LnNob3J0TmFtZShuYW1lKV0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVtcGxhdGUgPSB0ZW1wbGF0ZXNbSURdW3RoYXQudGVtcGxhdGVJZChuYW1lKV0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChuYW1lLCB0eXBlLCBjb21waWxlZFRlbXBsYXRlLCBodG1sKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgc2hvcnROYW1lID0gdGhhdC5zaG9ydE5hbWUobmFtZSksCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVJZCA9IHRoYXQudGVtcGxhdGVJZChuYW1lKSwKICAgICAgICAgICAgICAgICAgICBsb25nTmFtZSA9IHRoYXQubG9uZ05hbWUobmFtZSwgdHlwZSksCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVzID0gdGhhdC50ZW1wbGF0ZXM7CgogICAgICAgICAgICAgICAgdGVtcGxhdGVzW0xPTkddW2xvbmdOYW1lXSA9IHRlbXBsYXRlc1tTSE9SVF1bc2hvcnROYW1lXSA9IHRlbXBsYXRlc1tJRF1bdGVtcGxhdGVJZF0gPSB7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICBzaG9ydE5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgaWQ6IHRlbXBsYXRlSWQsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICAgICAgICBodG1sOiBodG1sLAogICAgICAgICAgICAgICAgICAgIGNvbXBpbGVkOiBjb21waWxlZFRlbXBsYXRlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAogICAgICAgICAgICBoYXM6IGZ1bmN0aW9uIChuYW1lKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICByZXR1cm4gISF0aGF0LmdldChuYW1lKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYXBwZW5kOiBmdW5jdGlvbiAobmFtZSwgdHlwZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgLy8gQXBwZW5kIHRvIGRvbT8KICAgICAgICAgICAgICAgIC8vIElzIHRoaXMgcmVhbGx5IG5lZWRlZC4uLiBpdCBpcyBuZWVkZWQgZm9yIGtub2Nrb3V0IHRvIGdyYWIgdGVtcGxhdGVzIGJ5IGRlZmF1bHQsCiAgICAgICAgICAgICAgICAvLyAgICAgIGJ1dCBrbm9ja291dCBjYW4gYmUgY2hhbmdlZCwgaW4gaG93IGl0IGdldHMgdGVtcGxhdGVzLgogICAgICAgICAgICAgICAgLy8gICAgICBHcmFudGVkIGtub2Nrb3V0IHN0aWxsIG5lZWRzIHRoZSBpZCB0byBleGlzdCwgbWF5YmUgdGhlIGJlc3QgdGhpbmcgaXMgdG8gYWRkIHRoZSBlbXB0eSBkaXYsCiAgICAgICAgICAgICAgICAvLyAgICAgIGlmIGl0IGRvZXNuJ3QgZXhpc3QsIGZvciBrbm9ja291dCBzdXBwb3J0LgogICAgICAgICAgICAgICAgZG9tUmVhZHkoZnVuY3Rpb24gKCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoYXQudGVtcGxhdGVJZChuYW1lKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFlbGVtZW50KQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5pZCA9IHRoYXQudGVtcGxhdGVJZChuYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC50eXBlID0gZm9ybWF0KCd0ZXh0L3gtezB9LXRlbXBsYXRlJywgdHlwZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RhdGEtdHlwZScsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnZGF0YS10ZW1wbGF0ZScsIHRoYXQuc2hvcnROYW1lKG5hbWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGVyaGFwcyBhZGQgdGhlIHRleHQgbm9kZSBjb250ZW50IGZvciB0aGUgdGVtcGxhdGUgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlbGVtZW50KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBuZXdUZW1wbGF0ZTogZnVuY3Rpb24gKG5hbWUsIHR5cGUsIGh0bWwsIGVuZ2luZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCB0ZW1wbGF0ZSA9IHRoYXQuZ2V0KG5hbWUpOwogICAgICAgICAgICAgICAgaWYgKCF0ZW1wbGF0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PSAncHJlY29tcGlsZWQnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5zZXQobmFtZSwgdHlwZSwgaHRtbCwgaHRtbC50b1N0cmluZygpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGVuZFRlbXBsYXRlKHRoYXQubG9uZ05hbWUobmFtZSksIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGluZ01ldGhvZDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21waWxlZFRlbXBsYXRlID0gdGhpcy5jb21waWxlKGh0bWwsIGVuZ2luZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuc2V0KG5hbWUsIHR5cGUsIGNvbXBpbGVkVGVtcGxhdGUsIGh0bWwpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmFwcGVuZCh0aGF0LmxvbmdOYW1lKG5hbWUpLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vaWYgKGRlZmVycmVkKQogICAgICAgICAgICAgICAgICAgIC8vICAgIGRlZmVycmVkLnJlc29sdmUodGVtcGxhdGUuY29tcGlsZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQuZ2V0KG5hbWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbihodG1sLCBlbmdpbmUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmICghZW5naW5lKQogICAgICAgICAgICAgICAgICAgIGVuZ2luZSA9IHRoYXQuZW5naW5lc1t0aGF0LmRlZmF1bHRUeXBlXTsKCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVuZ2luZSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0aW5nTWV0aG9kID0gZW5naW5lOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIGVuZ2luZS50ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0aW5nTWV0aG9kID0gZW5naW5lLnRlbXBsYXRlOwoKICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0aW5nTWV0aG9kKGh0bWwpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBmZXRjaDogZnVuY3Rpb24gKG5hbWUsIHR5cGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICB0eXBlID0gdHlwZSB8fCB0aGF0LmRlZmF1bHRUeXBlLAogICAgICAgICAgICAgICAgICAgIHNob3J0TmFtZSA9IHRoYXQuc2hvcnROYW1lKG5hbWUpLAogICAgICAgICAgICAgICAgICAgIGxvbmdOYW1lID0gdGhhdC5sb25nTmFtZShuYW1lLCB0eXBlKSwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CgogICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlID0gdGhhdC5nZXQobmFtZSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhhdC5kYXRhLmdldCh0aGF0LmJhc2VVcmwgKyBsb25nTmFtZSwgeyBjb250ZW50VHlwZTogJ3RleHQvcGxhaW4nLCBkYXRhVHlwZTogJ3RleHQnIH0pLnRoZW4od2hlbi5hcHBseShmdW5jdGlvbiAoZGF0YSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PSAncHJlY29tcGlsZWQnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGF0LmVuZ2luZXNbdHlwZV0pCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoYXQubmV3VGVtcGxhdGUobmFtZSwgdHlwZSwgZGF0YSwgdGhhdC5lbmdpbmVzW3R5cGVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZShbKHRoYXQudGVtcGxhdGVQYXRoc1t0eXBlXSB8fCAndGhydXN0L3RlbXBsYXRlLycgKyB0eXBlKV0sIGZ1bmN0aW9uIChlbmdpbmUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5lbmdpbmVzW3R5cGVdID0gZW5naW5lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoYXQubmV3VGVtcGxhdGUobmFtZSwgdHlwZSwgZGF0YSwgZW5naW5lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSksIGRlZmVyLnJlamVjdCk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNyZWF0ZUZyb21Eb21Ob2RlOiAgZnVuY3Rpb24gKGVsZW1lbnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGxvZy5pbmZvKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXRlbXBsYXRlJyksCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdHlwZScpLAogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudGV4dCk7CgogICAgICAgICAgICAgICAgdGhhdC5uZXdUZW1wbGF0ZSgKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10ZW1wbGF0ZScpLAogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXR5cGUnKSwKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnRleHQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgVGVtcGxhdGVGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG1vZHVsZS5uYW1lICsgJy10ZW1wbGF0ZSc7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CgogICAgICAgICAgICB1dGlsLmV4dGVuZCh0aGlzLCB7CiAgICAgICAgICAgICAgICBmZXRjaDogcGFyZW50LmZldGNoLmJpbmQocGFyZW50KSwKICAgICAgICAgICAgICAgIGdldDogcGFyZW50LmdldC5iaW5kKHBhcmVudCksCiAgICAgICAgICAgICAgICBoYXM6IHBhcmVudC5oYXMuYmluZChwYXJlbnQpCiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKCiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IGZ1bmN0aW9uICh0aHJ1c3QsIG1vZHVsZSwgZmFjYWRlcykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZUluc3RhbmNlID0gdGhydXN0LnRlbXBsYXRlOwoKICAgICAgICAgICAgZmFjYWRlcy50ZW1wbGF0ZSA9IG5ldyBUZW1wbGF0ZUZhY2FkZShtb2R1bGUsIHRoaXMpOwogICAgICAgICAgICBtb2R1bGUudGVtcGxhdGVzID0gewogICAgICAgICAgICAgICAgZmV0Y2g6IHRlbXBsYXRlSW5zdGFuY2UuZmV0Y2guYmluZCh0ZW1wbGF0ZUluc3RhbmNlKSwKICAgICAgICAgICAgICAgIGdldDogdGVtcGxhdGVJbnN0YW5jZS5nZXQuYmluZCh0ZW1wbGF0ZUluc3RhbmNlKSwKICAgICAgICAgICAgICAgIGhhczogdGVtcGxhdGVJbnN0YW5jZS5oYXMuYmluZCh0ZW1wbGF0ZUluc3RhbmNlKQogICAgICAgICAgICB9OwogICAgICAgIH07CgogICAgICAgIHJldHVybiBUZW1wbGF0ZTsKICAgIH0pOwpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZScsIFsndGhydXN0L3RlbXBsYXRlL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi90ZW1wbGF0ZScsWyd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLApmdW5jdGlvbiAoQ29udmVudGlvbiwgdXRpbCkKewogICAgdmFyIFRFTVBMQVRFUyA9ICd0ZW1wbGF0ZXMnLAogICAgICAgIHdoZW4gPSB1dGlsLndoZW4sCiAgICAgICAgZWFjaCA9IHV0aWwuZWFjaCwKICAgICAgICBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAogICAgICAgIGZpbmQgPSB1dGlsLmZpbmQ7CgogICAgcmV0dXJuIG5ldyBDb252ZW50aW9uKHsKICAgICAgICBwcm9wZXJ0aWVzOiBbVEVNUExBVEVTXSwKICAgICAgICBpbml0OiBmdW5jdGlvbihmYWNhZGUsIG1vZHVsZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKCiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZXMgPSBtb2R1bGUuY29udmVudGlvbihURU1QTEFURVMpLAogICAgICAgICAgICAgICAgaW52ZXJ0ZWRUZW1wbGF0ZXMgPSB1dGlsLmludmVydCh0ZW1wbGF0ZXMpLAogICAgICAgICAgICAgICAgbW9kdWxlSW5zdGFuY2UgPSBtb2R1bGUuaW5zdGFuY2U7CgogICAgICAgICAgICBpZiAodGVtcGxhdGVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmYWNhZGUuZGVmZXJzID0gW107CiAgICAgICAgICAgICAgICBlYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24odGVtcGxhdGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBmYWNhZGUuZGVmZXJzLnB1c2goZmFjYWRlLmZldGNoKHRlbXBsYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmYWNhZGUuZGVmZXJzID0gd2hlbi5hbGwoZmFjYWRlLmRlZmVycykudGhlbihmdW5jdGlvbiAobG9hZGVkVGVtcGxhdGVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gaW52ZXJ0ZWRUZW1wbGF0ZXMpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwoaW52ZXJ0ZWRUZW1wbGF0ZXMsIGkpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBmaW5kKGxvYWRlZFRlbXBsYXRlcywgZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHguc2hvcnROYW1lID09PSBpIHx8IHgubmFtZSA9PT0gaTsgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZS50ZW1wbGF0ZXNbaV0gPSB0ZW1wbGF0ZS5jb21waWxlZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKGZhY2FkZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWNhZGUuZGVmZXJzIHx8IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICB9KTsKfSk7CmRlZmluZSgndGhydXN0L3RlbXBsYXRlL2NvbnZlbnRpb24va25vY2tvdXQuZW5naW5lJyxbJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJ2tub2Nrb3V0J10sCmZ1bmN0aW9uIChDb252ZW50aW9uLCB1dGlsLCBrbykKewogICAgdmFyIHdoZW4gPSB1dGlsLndoZW4sCiAgICAgICAgZWFjaCA9IHV0aWwuZWFjaCwKICAgICAgICBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAogICAgICAgIGZpbmQgPSB1dGlsLmZpbmQsCiAgICAgICAga25vY2tvdXRUZW1wbGF0ZXMgPSB7fTsKCiAgICB2YXIgaW5pdEtub2Nrb3V0SW50ZWdyYXRpb24gPSBmdW5jdGlvbiAodGVtcGxhdGVNYW5hZ2VyKQogICAgewogICAgICAgIHZhciB0aHJ1c3RUZW1wbGF0ZVNvdXJjZSA9IGtvLnRlbXBsYXRlU291cmNlcy50aHJ1c3RUZW1wbGF0ZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICB9OwoKICAgICAgICB0aHJ1c3RUZW1wbGF0ZVNvdXJjZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgIHRleHQ6IGZ1bmN0aW9uICgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQudGVtcGxhdGUuaHRtbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmh0bWwgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ1RocnVzdCBUZW1wbGF0ZSBkb2VzIG5vdCBzdXBwb3J0IHJld3JpdGluZy4uLicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAoa2V5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICBpZiAoIXRoYXQudGVtcGxhdGUuZGF0YSkgdGhhdC50ZW1wbGF0ZS5kYXRhID0ge307CiAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0LnRlbXBsYXRlLmRhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmRhdGFba2V5XSA9IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vIEJlZ2luIGludGVncmF0aW9uIG9mIHRlbXBsYXRlIHBsdWdpbiwgd2l0aCBLbm9ja291dC4KICAgICAgICB2YXIgb2xkRW5naW5lID0ga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2U7CgogICAgICAgIHZhciBjb252ZW50aW9uVGVtcGxhdGVFbmdpbmUgPSBrby5jb252ZW50aW9uVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7IH0KICAgICAgICBjb252ZW50aW9uVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlID0ga28udXRpbHMuZXh0ZW5kKG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpLAogICAgICAgIHsKICAgICAgICAgICAgcmVuZGVyVGVtcGxhdGVTb3VyY2U6IGZ1bmN0aW9uICh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZVNvdXJjZS50ZW1wbGF0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdG9ycyA9IHRoaXMuZXZhbHVhdG9yczsKICAgICAgICAgICAgICAgICAgICBpZiAoIWV2YWx1YXRvcnMpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV2YWx1YXRvcnMgPSBldmFsdWF0b3JzID0gdGVtcGxhdGVNYW5hZ2VyLmV2YWx1YXRvcnNbdGVtcGxhdGVNYW5hZ2VyLmRlZmF1bHRUeXBlXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBwcmVjb21waWxlZCA9IHRlbXBsYXRlU291cmNlWydkYXRhJ10oJ3ByZWNvbXBpbGVkJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwcmVjb21waWxlZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0gdGVtcGxhdGVNYW5hZ2VyLmNvbXBpbGUoJ3t7IHdpdGgoJGRhdGEpIHsgfX0gJyArIHRlbXBsYXRlU291cmNlLnRleHQoKSArICIge3sgfSB9fSIpOwogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFJ1biB0aGUgdGVtcGxhdGUgYW5kIHBhcnNlIGl0cyBvdXRwdXQgaW50byBhbiBhcnJheSBvZiBET00gZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRNYXJrdXAgPSB0ZW1wbGF0ZVNvdXJjZS50ZW1wbGF0ZS5jb21waWxlZChiaW5kaW5nQ29udGV4dCkucmVwbGFjZSgvXHMrL2csICIgIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KHJlbmRlcmVkTWFya3VwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gb2xkRW5naW5lLnJlbmRlclRlbXBsYXRlU291cmNlLmFwcGx5KG9sZEVuZ2luZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrOiBmdW5jdGlvbiAoc2NyaXB0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuZXZhbHVhdG9yQ2FjaGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2YWx1YXRvcnMgPSB0ZW1wbGF0ZU1hbmFnZXIuZXZhbHVhdG9yc1t0ZW1wbGF0ZU1hbmFnZXIuZGVmYXVsdFR5cGVdOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdG9yQ2FjaGUgPSBldmFsdWF0b3JzLmxlZnQgKyBzY3JpcHQgKyBldmFsdWF0b3JzLnJpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdG9yQ2FjaGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1ha2VUZW1wbGF0ZVNvdXJjZTogZnVuY3Rpb24gKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBOYW1lZCB0ZW1wbGF0ZQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PSAic3RyaW5nIikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGVmaW5pdGlvbiA9IHRlbXBsYXRlTWFuYWdlci5nZXQodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgIGlmIChkZWZpbml0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IHRocnVzdFRlbXBsYXRlU291cmNlKGRlZmluaXRpb24pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBvbGRFbmdpbmUubWFrZVRlbXBsYXRlU291cmNlLmFwcGx5KG9sZEVuZ2luZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBrby5zZXRUZW1wbGF0ZUVuZ2luZShuZXcga28uY29udmVudGlvblRlbXBsYXRlRW5naW5lKCkpOwogICAgfTsKCiAgICByZXR1cm4gbmV3IENvbnZlbnRpb24oewogICAgICAgIGNvdW50ZG93bjogZnVuY3Rpb24gKHRocnVzdCkKICAgICAgICB7CiAgICAgICAgICAgIGluaXRLbm9ja291dEludGVncmF0aW9uKHRocnVzdC50ZW1wbGF0ZSk7CiAgICAgICAgfQogICAgfSk7Cn0pOwovKiEgVGhydXN0IEpTIEZyYW1ld29yayAtIHYwLjEuMCAtIDIwMTItMDgtMjkKKiB0aHJ1c3QtaG9tZQoqIENvcHlyaWdodCAoYykgMjAxMiBEYXZpZCBEcmlzY29sbDsgTGljZW5zZWQgTUlUICovCgoKZGVmaW5lKCd0aHJ1c3Qvc3BhL21haW4nLFsKICAgICdyZXF1aXJlJywKICAgICd0aHJ1c3QnLAogICAgJ3RocnVzdC91dGlsJywKICAgICd0aHJ1c3QvbG9nJywKICAgICdkYXZpcycsCiAgICAnanF1ZXJ5JywKICAgICdkb21SZWFkeScKXSwKZnVuY3Rpb24gKHJlcXVpcmUsIFRocnVzdCwgdXRpbCwgbG9nLCBEYXZpcywgalF1ZXJ5LCBkb21SZWFkeSkKewogICAgdmFyIGVhY2ggICAgICAgPSB1dGlsLmVhY2gsCiAgICAgICAgaXNTdHJpbmcgICA9IHV0aWwuaXNTdHJpbmcsCiAgICAgICAgaXNBcnJheSAgICA9IHV0aWwuaXNBcnJheSwKICAgICAgICBpc0Z1bmN0aW9uID0gdXRpbC5pc0Z1bmN0aW9uLAogICAgICAgIGlzT2JqZWN0ICAgPSB1dGlsLmlzT2JqZWN0LAogICAgICAgIGV4dGVuZCAgICAgPSB1dGlsLmV4dGVuZCwKICAgICAgICBvbmNlICAgICAgID0gdXRpbC5vbmNlLAogICAgICAgIHdoZW4gICAgICAgPSB1dGlsLndoZW4sCiAgICAgICAgYmluZCAgICAgICA9IHV0aWwuYmluZCwKICAgICAgICBpbnZva2UgICAgID0gdXRpbC5pbnZva2UsCiAgICAgICAgcGx1Y2sgICAgICA9IHV0aWwucGx1Y2ssCiAgICAgICAgbWFwICAgICAgICA9IHV0aWwubWFwLAogICAgICAgIGRlZmVyICAgICAgPSB1dGlsLmRlZmVyLAogICAgICAgIG1lbW9pemUgICAgPSB1dGlsLm1lbW9pemUsCiAgICAgICAgdG9BcnJheSAgICA9IHV0aWwudG9BcnJheSwKICAgICAgICBTVEFSVCAgICAgID0gJ3N0YXJ0JzsKCiAgICB2YXIgU2luZ2xlUGFnZUFwcCA9IGZ1bmN0aW9uICgvKiAkcmVmICovIGNvbmZpZywgLyogJHJlZiA6IG5hbWUgKi8gaW5zdGFuY2VOYW1lLCAvKiAkcmVmICovIG1lZGlhdG9yKQogICAgewogICAgICAgIC8vIE5lZWQgdG8gYnVpbGQgYSBzaGltIGZvciB0aGUgalF1ZXJ5IG1ldGhvZHMgRGF2aXMgbmVlZHMuCiAgICAgICAgaWYgKCFEYXZpcy4kKSBEYXZpcy4kID0galF1ZXJ5OwoKICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgdGhhdC5iYXNlVXJsID0gY29uZmlnLnVybC5wYXRoICsgJy8nOwoKICAgICAgICBjb25maWcgPSBjb25maWcuc3BhOwoKICAgICAgICB0aGF0LnRocnVzdEluc3RhbmNlTmFtZSA9IGluc3RhbmNlTmFtZTsKICAgICAgICB0aGF0LnJvdXRlciA9IG5ldyBEYXZpcy5BcHA7CiAgICAgICAgdGhhdC5yb3V0ZXIuY29uZmlndXJlKGZ1bmN0aW9uIChjb25maWcpCiAgICAgICAgewogICAgICAgICAgICBjb25maWcuZ2VuZXJhdGVSZXF1ZXN0T25QYWdlTG9hZCA9IHRydWU7CiAgICAgICAgfSkKCiAgICAgICAgdGhhdC5sb2FkUm91dGVzKGNvbmZpZy5yb3V0ZXMpOwogICAgICAgIAogICAgICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jLmFwcGx5KG1lZGlhdG9yLCBbZXZlbnRdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgfTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gRm9yd2FyZCBldmVudHMKICAgICAgICAvLyBUZWNobmljYWxseSB3ZSBzaG91bGQgd3JhcCBjZXJ0aWFuIHBhcnRzIG9mIHRoZSBldmVudHMsIHRvIG9mZmVyIGEgY29tbW9uIGFwaSB0aGF0IHdvbid0IHNoaWZ0LgogICAgICAgIHRoYXQucm91dGVyLmJpbmQoJ3N0YXJ0JywgZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3N0YXJ0JykpOwogICAgICAgIHRoYXQucm91dGVyLmJpbmQoJ2xvb2t1cFJvdXRlJywgZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL2xvb2t1cCcpKTsKICAgICAgICB0aGF0LnJvdXRlci5iaW5kKCdydW5Sb3V0ZScsIGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9ydW4nKSk7CiAgICAgICAgdGhhdC5yb3V0ZXIuYmluZCgncm91dGVOb3RGb3VuZCcsIGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9ub3Rmb3VuZCcpKTsKICAgICAgICB0aGF0LnJvdXRlci5iaW5kKCdyZXF1ZXN0SGFsdGVkJywgZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JlcXVlc3QvaGFsdCcpKTsKICAgICAgICB0aGF0LnJvdXRlci5iaW5kKCd1bnN1cHBvcnRlZCcsIGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS91bnN1cHBvcnRlZCcpKTsKICAgIH07CgogICAgU2luZ2xlUGFnZUFwcC5wcm90b3R5cGUgPSB7CiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoYXQucm91dGVyLnN0YXJ0KCk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBMb2FkcyByb3V0ZXMgaW50byB0aGUgc3BhIGluc3RhbmNlCgogICAgICAgIFJvdXRlcyBjYW4gYmUgaW4gMyBmb3JtcwoKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJy9wYXRoL3RvLzpmb28nOiAncGF0aC90by9tb2R1bGUnLAogICAgICAgICAgICAgICAgJy9wYXRoL3RvLzpiYXInOiBbJ3BhdGgvdG8vbW9kdWxlMScsICdwYXRoL3RvL21vZHVsZTInXSwKICAgICAgICAgICAgICAgICcvcGF0aC90by86ZmInOiB7IHBhdGg6ICdwYXRoL3RvL21vZHVsZScsIGFyZ3M6IFsnYXJncycsICd0bycsICdoYW5kIG9mZiB0byBzdGFydCddIH0KICAgICAgICAgICAgICAgICcvcGF0aC90by86Zm9vLzpiYXInOiBmdW5jdGlvbigpeyAgY3VzdG9tIGhhbmRsZXIgfQogICAgICAgICAgICB9CgogICAgICAgIEBtZXRob2QgbG9hZFJvdXRlcwogICAgICAgIEBwYXJhbSB7T2JqZWN0fSByb3V0ZXMgT2JqZWN0IG9mIHJvdXRlcy4KICAgICAgICAqKi8KICAgICAgICBsb2FkUm91dGVzOiBmdW5jdGlvbiAocm91dGVzKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBlYWNoKHJvdXRlcywgZnVuY3Rpb24gKHZhbHVlLCByb3V0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHJlYWxSb3V0ZSA9IHV0aWwuZml4dXBVcmwodGhhdC5iYXNlVXJsICsgcm91dGUpOwogICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoYXQucm91dGVyLmdldChyZWFsUm91dGUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAvLyBSdW4gY3VzdG9tIGZ1bmN0aW9uIGluIGRhdmlzLgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLyplbHNlIGlmIChpc0FycmF5KHZhbHVlKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcm91dGVSZXN1bHQgPSBtYXAodmFsdWUsIHRoYXQuX19wcm9jZXNzUm91dGUpOwoKICAgICAgICAgICAgICAgICAgICB0aGF0LnJvdXRlci5nZXQocmVhbFJvdXRlLCBmdW5jdGlvbiAocmVxKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW52b2tlKHJvdXRlUmVzdWx0LCAnY2InLCByZXEpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICB3aGVuLmFsbChwbHVjayhyb3V0ZVJlc3VsdCwgJ3Byb21pc2UnKSkKICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oYmluZCh0aGF0LnN0YXJ0TW9kdWxlcywgdGhhdCwgbWFwKHZhbHVlLCBmdW5jdGlvbih4KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNPYmplY3QoeCkgJiYgeC5hcmdzIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB9KSkpOwogICAgICAgICAgICAgICAgfSovCiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJvdXRlUmVzdWx0ID0gdGhhdC5fX3Byb2Nlc3NSb3V0ZSh2YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgIHRoYXQucm91dGVyLmdldChyZWFsUm91dGUsIHJvdXRlUmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICAvL3JvdXRlUmVzdWx0LnByb21pc2UudGhlbihiaW5kKHRoYXQuc3RhcnRNb2R1bGVzLCB0aGF0LCB2YWx1ZS5hcmdzIHx8IFtdKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgUHJvY2VzcyBlYWNoIHJvdXRlIG5vZGUgZGVwZW5kaW5nIGlmIGl0IGlzIGFuIG9iamVjdCBvciBzdHJpbmcuCgogICAgICAgIEBtZXRob2QgX19wcm9jZXNzUm91dGUKICAgICAgICBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZhbHVlIFRoZSBtb2R1bGUgb3IgbW9kdWxlICsgYXJncyB0byBwcm9jZXNzLgogICAgICAgICoqLwogICAgICAgIF9fcHJvY2Vzc1JvdXRlOiBmdW5jdGlvbih2YWx1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgIGFyZ3MgPSB2YWx1ZS5hcmdzIHx8IFtdOwoKICAgICAgICAgICAgaWYgKGlzT2JqZWN0KHZhbHVlKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQucm91dGVHZXRNb2R1bGVGYWN0b3J5KHZhbHVlLnBhdGgsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RyaW5nKHZhbHVlKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQucm91dGVHZXRNb2R1bGVGYWN0b3J5KHZhbHVlLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgQ3JlYXRlcyBhIG1ldGhvZCB0aGF0IGlzIGhhbmRlZCBvZmYgdG8gdGhlIHJvdXRlcgogICAgICAgIFdoZW4gdGhlIHJvdXRlIGludm9rZXMgdGhhdCBtb2R1bGUsIGl0IHdpbGwgYXN5bmNyb25vdXNseSBsb2FkIHRoZSBnaXZlbiBtb2R1bGUsIGFuZCByZXR1cm4gYSBwcm9taXNlIGZvciB0aGUgcmVzdWx0LgoKICAgICAgICBAbWV0aG9kIHJvdXRlR2V0TW9kdWxlRmFjdG9yeQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2R1bGVQYXRoIFRoZSBwYXRoIHRvIHRoZSBtb2R1bGUKICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSB0aGVtTWV0aG9kIFRoZSBtZXRob2QgdGhhdCBpcyBjYWxsZWQsIGFmdGVyIHRoZSBmdW5jdGlvbiBpcyByZXNvbHZlZC4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgZm9yIHdoZW4gdGhlIG1vZHVsZSBnZXRzIGxvYWRlZC4KICAgICAgICAqKi8KICAgICAgICByb3V0ZUdldE1vZHVsZUZhY3Rvcnk6IGZ1bmN0aW9uIChtb2R1bGVQYXRoLCBhcmdzKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChyZXEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBtcDsKICAgICAgICAgICAgICAgIGlmIChtb2R1bGVQYXRoLmluZGV4T2YoJzonKSA+IC0xKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1wID0gdXRpbC5yZWR1Y2UocmVxLnBhcmFtcywgZnVuY3Rpb24gKG1lbW8sIHBhcmFtLCBpKSB7IHJldHVybiBtZW1vLnJlcGxhY2UoJzonICsgaSwgcGFyYW0udG9Mb3dlckNhc2UoKSk7IH0sIG1vZHVsZVBhdGgpOwogICAgICAgICAgICAgICAgICAgIGlmIChtcC5sYXN0SW5kZXhPZignLicpID4gLTEpCiAgICAgICAgICAgICAgICAgICAgICAgIG1wID0gbXAuc3Vic3RyaW5nKDAsIG1wLmxhc3RJbmRleE9mKCcuJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhhdC5zdGFydE1vZHVsZXMoYXJncywgbXApOwogICAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgU3RhcnRzIHRoZSBnaXZlbiBtb2R1bGVzLCBpZiBvbmx5IG9uZSBtb2R1bGUgaXMgcGFzc2VkIGluLCBpdCB3aWxsIHN0YXJ0IHRoYXQgaW5kaXZpZHVhbGx5LgoKICAgICAgICBAbWV0aG9kIHN0YXJ0TW9kdWxlcwogICAgICAgIEBwYXJhbSB7QXJyYXkgb2YgT2JqZWN0fSBhcmdzIHRvIHBhc3Mgb250byB0aHJ1c3QncyBzdGFydCBtZXRob2QuCiAgICAgICAgQHBhcmFtIHtBcnJheSBvZiBNb2R1bGV8TW9kdWxlfSBtb2R1bGVzIFRoZSBtb2R1bGVzIHRvIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgc3RhcnRNb2R1bGVzOiBmdW5jdGlvbiAoYXJncywgbW9kdWxlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwoKICAgICAgICAgICAgaWYgKCF0aGF0LnRocnVzdCkKICAgICAgICAgICAgICAgIHRoYXQudGhydXN0ID0gVGhydXN0LmdldEluc3RhbmNlKHRoYXQudGhydXN0SW5zdGFuY2VOYW1lKTsKCiAgICAgICAgICAgIGlmIChpc0FycmF5KG1vZHVsZSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVhY2gobW9kdWxlLCBmdW5jdGlvbiAoeCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcihmdW5jdGlvbiAoKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGF0LnRocnVzdC5zdGFydC5hcHBseSh0aGF0LnRocnVzdCwgW3hdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhhdC50aHJ1c3Quc3RhcnRlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudGhydXN0LnJlYWR5KHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhhdC50aHJ1c3Quc3RhcnQuYXBwbHkodGhhdC50aHJ1c3QsIFttb2R1bGVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgICAgICBpZiAoIXRoYXQudGhydXN0LnN0YXJ0ZWQpCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICgpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRocnVzdC5yZWFkeShtb2R1bGUpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHRoYXQuc3RhcnRpbmdNb2R1bGVQcm9taXNlID0gW3Byb21pc2VdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gU2luZ2xlUGFnZUFwcDsKfSk7CmRlZmluZSgndGhydXN0L3NwYScsIFsndGhydXN0L3NwYS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L3NwYS9jb252ZW50aW9uL3N0YXJ0JyxbJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sCmZ1bmN0aW9uIChDb252ZW50aW9uLCB1dGlsKQp7CiAgICByZXR1cm4gbmV3IENvbnZlbnRpb24oewogICAgICAgIG9yYml0OiBmdW5jdGlvbiAodGhydXN0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHJvdXRlciA9IHRocnVzdC5zcGE7CiAgICAgICAgICAgIHJvdXRlci5zdGFydCgpOwoKICAgICAgICAgICAgcmV0dXJuIHRocnVzdC5zcGEuc3RhcnRpbmdNb2R1bGVQcm9taXNlIHx8IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICB9KTsKfSk7CmRlZmluZSgna29iLW1vZGVsL3V0aWwnLFsnbG9kYXNoJywgJ2tub2Nrb3V0JywgJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKF8sIGtvLCBleHBvcnRzKQp7CiAgICB2YXIgaXNPYmplY3QgPSBfLmlzT2JqZWN0LAogICAgICAgIGlzQXJyYXkgPSBfLmlzQXJyYXksCiAgICAgICAgaXNGb3JjZWRPYmplY3QgPSBfLm1lbW9pemUoZnVuY3Rpb24gKGtleSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBrZXkuaW5kZXhPZignXycpID09PSAwICYmIGtleS5sYXN0SW5kZXhPZignXycpID09PSAoa2V5Lmxlbmd0aCAtIDEpOwogICAgICAgIH0pLAogICAgICAgIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgdW53cmFwT2JzZXJ2YWJsZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGU7CiAgICAvLyBOb3QgZXhhY3RseSBhIGdyZWF0IGFzc3VtcHRpb24sIGJ1dCBmb3IgbGFyZ2UgbGlzdHMsIHdlIG5lZWQgYSBxdWljayB3YXkgdG8gaWRlbnRpZnkgaWYgdGhleSBhcmUgZm9yY2VkLgoKICAgIGV4cG9ydHMuaXNGb3JjZWRPYmplY3QgPSBpc0ZvcmNlZE9iamVjdDsKCiAgICBleHBvcnRzLmlzRm9yY2VkT2JqZWN0SGFzaCA9IGZ1bmN0aW9uICh2YWx1ZSkKICAgIHsKICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpICYmIGlzT2JqZWN0KHZhbHVlKSkKICAgICAgICAgICAgZm9yICh2YXIgeCBpbiB2YWx1ZSkKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgeCA9PT0gJ3N0cmluZycgJiYgaXNGb3JjZWRPYmplY3QoeCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICBleHBvcnRzLmlzT2JqZWN0T3JPYmplY3RPYnNlcnZhYmxlID0gZnVuY3Rpb24gKHByb3ApCiAgICB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuaXNGb3JjZWRPYmplY3RIYXNoKHVud3JhcE9ic2VydmFibGUocHJvcCkpOwogICAgfTsKCiAgICBleHBvcnRzLmlzQXJyYXlPckFycmF5T2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChwcm9wKQogICAgewogICAgICAgIHJldHVybiBpc0FycmF5KHVud3JhcE9ic2VydmFibGUocHJvcCkpOwogICAgfTsKCiAgICB2YXIgX19rb1BhdGhNYXAgPSB7fSwKICAgICAgICBfX3Byb3BQYXRoTWFwID0ge30sCiAgICAgICAgX19jbGFzc1BhdGhNYXAgPSB7fSwKICAgICAgICBrb1JlZ2V4ID0gL1tcLnxcW10vZywKICAgICAgICByaWdodEJyYWNrZXRSZWdleCA9IC9cXS9nOwoKICAgIGV4cG9ydHMua25vY2tvdXRQYXRoID0gZnVuY3Rpb24gKGtleSkKICAgIHsKICAgICAgICBpZiAoX19wcm9wUGF0aE1hcFtrZXldKSByZXR1cm4gX19wcm9wUGF0aE1hcFtrZXldOwoKICAgICAgICB2YXIga29QYXRoID0ga2V5LnJlcGxhY2Uoa29SZWdleCwgJ18nKS5yZXBsYWNlKHJpZ2h0QnJhY2tldFJlZ2V4LCAnJyk7CiAgICAgICAgaWYgKCFfX2tvUGF0aE1hcFtrb1BhdGhdKQogICAgICAgIHsKICAgICAgICAgICAgX19rb1BhdGhNYXBba29QYXRoXSA9IGtleTsKICAgICAgICAgICAgcmV0dXJuIChfX3Byb3BQYXRoTWFwW2tleV0gPSBrb1BhdGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4ga29QYXRoOwogICAgfTsKCiAgICBleHBvcnRzLnByb3BlcnR5UGF0aCA9IGZ1bmN0aW9uIChrb1BhdGgpCiAgICB7CiAgICAgICAgcmV0dXJuIF9fa29QYXRoTWFwW2tvUGF0aF07CiAgICB9OwoKICAgIGV4cG9ydHMuY2xhc3NQYXRoID0gXy5tZW1vaXplKGZ1bmN0aW9uIChwYXRoKQogICAgewogICAgICAgIHJldHVybiAnLicgKyBwYXRoLnJlcGxhY2Uoa29SZWdleCwgJy0nKS5yZXBsYWNlKHJpZ2h0QnJhY2tldFJlZ2V4LCAnJykudG9Mb3dlckNhc2UoKTsKICAgIH0pOwoKICAgIGV4cG9ydHMuZmluZEFsbENoYW5nZWRQcm9wZXJ0aWVzID0gZnVuY3Rpb24gKGN1cnJlbnQsIG9sZCkKICAgIHsKICAgICAgICB2YXIgcHJvcGVydGllcyA9IHt9LCBpOwogICAgICAgIGZvciAoaSBpbiBjdXJyZW50KQogICAgICAgICAgICBpZiAoIXByb3BlcnRpZXNbaV0gJiYgaGFzT3duLmNhbGwoY3VycmVudCwgaSkpCiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzW2ldID0gdHJ1ZTsKCiAgICAgICAgZm9yIChpIGluIG9sZCkKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0aWVzW2ldICYmIGhhc093bi5jYWxsKG9sZCwgaSkpCiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzW2ldID0gdHJ1ZTsKCiAgICAgICAgdmFyIHZhbHVlcyA9IHt9OwogICAgICAgIGZvciAoaSBpbiBwcm9wZXJ0aWVzKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGNWYWwgPSB1bndyYXBPYnNlcnZhYmxlKGN1cnJlbnRbaV0pLAogICAgICAgICAgICAgICAgb1ZhbCA9IHVud3JhcE9ic2VydmFibGUob2xkW2ldKSwKICAgICAgICAgICAgICAgIGNUbyA9IGlzT2JqZWN0KGNWYWwpLAogICAgICAgICAgICAgICAgY1RhID0gaXNBcnJheShjVmFsKSwKICAgICAgICAgICAgICAgIG9UbyA9IGlzT2JqZWN0KG9WYWwpLAogICAgICAgICAgICAgICAgb1RhID0gaXNBcnJheShvVmFsKTsKCiAgICAgICAgICAgIGlmIChjVG8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvVG8pCiAgICAgICAgICAgICAgICAgICAgdmFsdWVzW2ldID0gZXhwb3J0cy5maW5kQWxsQ2hhbmdlZFByb3BlcnRpZXMoY1ZhbCwgb1ZhbCk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgdmFsdWVzW2ldID0gY1ZhbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChjVGEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvVGEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKGNWYWwsIGkpKQogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbaV0gPSBleHBvcnRzLmZpbmRBbGxDaGFuZ2VkUHJvcGVydGllcyhjVmFsLCBvVmFsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbaV0gPSBjVmFsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGNWYWwgIT09IG9WYWwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbHVlc1tpXSA9IGNWYWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH07CgogICAgZXhwb3J0cy5kZWVwQ2xvbmUgPSBmdW5jdGlvbiAob2JqKQogICAgewogICAgICAgIGlmICghXy5pc09iamVjdChvYmopIHx8IF8uaXNGdW5jdGlvbihvYmopKSByZXR1cm4gb2JqOwogICAgICAgIGlmIChfLmlzRGF0ZShvYmopKSByZXR1cm4gbmV3IERhdGUob2JqLmdldFRpbWUoKSk7CiAgICAgICAgaWYgKF8uaXNSZWdFeHAob2JqKSkgcmV0dXJuIG5ldyBSZWdFeHAob2JqLnNvdXJjZSwgb2JqLnRvU3RyaW5nKCkucmVwbGFjZSgvLipcLy8sICIiKSk7CiAgICAgICAgdmFyIGlzQXJyID0gKF8uaXNBcnJheShvYmopIHx8IF8uaXNBcmd1bWVudHMob2JqKSk7CiAgICAgICAgdmFyIGZ1bmMgPSBmdW5jdGlvbiAobWVtbywgdmFsdWUsIGtleSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0FycikKICAgICAgICAgICAgICAgIG1lbW8ucHVzaChfLmNsb25lKHZhbHVlLCB0cnVlKSk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIG1lbW9ba2V5XSA9IF8uY2xvbmUodmFsdWUsIHRydWUpOwogICAgICAgICAgICByZXR1cm4gbWVtbzsKICAgICAgICB9OwogICAgICAgIHJldHVybiBfLnJlZHVjZShvYmosIGZ1bmMsIGlzQXJyID8gW10gOiB7fSk7CiAgICB9Owp9KTsKZGVmaW5lKCdrb2ItbW9kZWwvbW9kZWwuYmFzZScsWwogICAgJ2JhY2tib25lJywKICAgICdrbm9ja291dCcsCiAgICAnbG9kYXNoJywKICAgICcuL3V0aWwnLApdLApmdW5jdGlvbiAoQmFja2JvbmUsIGtvLCBfLCB1dGlsKQp7CiAgICAKICAgIHZhciBleHRlbmQgPSBfLmV4dGVuZCwKICAgICAgICBfX21vZGVscyA9IHt9LAogICAgICAgIF9fdmlld01vZGVscyA9IHt9LAogICAgICAgIF9fb3JpZ2luYWxTdGF0ZSA9IHt9LAogICAgICAgIGlzT2JqZWN0ID0gXy5pc09iamVjdCwKICAgICAgICBpc0FycmF5ID0gXy5pc0FycmF5LAogICAgICAgIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgdW53cmFwT2JzZXJ2YWJsZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUsCiAgICAgICAgLy8gTm90IGV4YWN0bHkgYSBncmVhdCBhc3N1bXB0aW9uLCBidXQgZm9yIGxhcmdlIGxpc3RzLCB3ZSBuZWVkIGEgcXVpY2sgd2F5IHRvIGlkZW50aWZ5IGlmIHRoZXkgYXJlIGZvcmNlZC4KICAgICAgICBpc09iamVjdE9yT2JqZWN0T2JzZXJ2YWJsZSA9IHV0aWwuaXNPYmplY3RPck9iamVjdE9ic2VydmFibGUsCiAgICAgICAgaXNBcnJheU9yQXJyYXlPYnNlcnZhYmxlID0gdXRpbC5pc0FycmF5T3JBcnJheU9ic2VydmFibGU7CgogICAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGdldCBhIHZhbHVlIGZyb20gYSBCYWNrYm9uZSBvYmplY3QgYXMgYSB0aGlzLl9fcHJvcGVydHkKICAgIC8vIG9yIGFzIGEgZnVuY3Rpb24uCiAgICB2YXIgZ2V0VmFsdWUgPSBmdW5jdGlvbiAob2JqZWN0LCBwcm9wKQogICAgewogICAgICAgIGlmICghKG9iamVjdCAmJiBvYmplY3RbcHJvcF0pKSByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKG9iamVjdFtwcm9wXSkgPyBvYmplY3RbcHJvcF0oKSA6IG9iamVjdFtwcm9wXTsKICAgIH07CgogICAgdmFyIF9uZXdWYWx1ZUdlbmVyYXRvclN1YnNjcmlwdGlvbiA9IGZ1bmN0aW9uIChwYXRoLCBuZXdWYWwsIHBhcmVudCkKICAgIHsKICAgICAgICByZXR1cm4gKGZ1bmN0aW9uICh2YWx1ZSkKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gdmFsdWUubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoISh2YWx1ZVtpXSBpbnN0YW5jZW9mIHRoaXMuY29uc3RydWN0b3IpKQogICAgICAgICAgICAgICAgICAgIHZhbHVlW2ldID0gbmV3IHRoaXMuY29uc3RydWN0b3IodmFsdWVbaV0sIHVuZGVmaW5lZCwgcGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgcGF0aCwgdGhpcywgbmV3VmFsKCkpOwogICAgICAgIH0pLmJpbmQodGhpcyk7CiAgICB9OwoKICAgIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogICAgdmFyIEtub2Nrb3V0TW9kZWxCYXNlID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKHsKICAgICAgICBfX2RlZXBDbG9uZTogZnVuY3Rpb24ob2JqKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsKICAgICAgICB9LAogICAgICAgIF9fcHJvcGVydHk6CiAgICAgICAgewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChvYmosIHBhdGgpIHsgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsgfSwKICAgICAgICAgICAgaGFzOiBmdW5jdGlvbiAob2JqLCBwYXRoKSB7IHRocm93IG5ldyBFcnJvcignTllJJyk7IH0sCiAgICAgICAgICAgIGdldFBhcmVudDogZnVuY3Rpb24gKG9iaiwgcGF0aCkgeyB0aHJvdyBuZXcgRXJyb3IoJ05ZSScpOyB9LAogICAgICAgICAgICBsYXN0OiBmdW5jdGlvbiAob2JqLCBwYXRoKSB7IHRocm93IG5ldyBFcnJvcignTllJJyk7IH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKG9iaiwgcGF0aCwgdmFsdWUpIHsgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsgfSwKICAgICAgICAgICAgZGVsOiBmdW5jdGlvbiAob2JqLCBwYXRoKSB7IHRocm93IG5ldyBFcnJvcignTllJJyk7IH0sCiAgICAgICAgICAgIGJ1aWxkOiBmdW5jdGlvbiAob2JqLCBwYXRoKSB7IHRocm93IG5ldyBFcnJvcignTllJJyk7IH0sCiAgICAgICAgICAgIGdldFByb3BlcnRpZXM6IGZ1bmN0aW9uIChvYmosIGxlYWZzLCBwcmVmaXgpIHsgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsgfSwKICAgICAgICAgICAgZmluZEFsbENoYW5nZWRQcm9wZXJ0aWVzOiBmdW5jdGlvbiAoY3VycmVudCwgb2xkKSB7IHRocm93IG5ldyBFcnJvcignTllJJyk7IH0KICAgICAgICB9LAogICAgICAgIF9fYnVpbGRFcnJvck1lc3NhZ2VzOiBmdW5jdGlvbihwYXJlbnQpCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05ZSScpOwogICAgICAgIH0sCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKGF0dHJpYnV0ZXMsIG9wdGlvbnMsIHBhcmVudCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZXJyb3JNZXNzYWdlcykgdGhpcy5lcnJvck1lc3NhZ2VzID0gdGhpcy5fX2J1aWxkRXJyb3JNZXNzYWdlcyhwYXJlbnQpOwogICAgICAgICAgICB0aGlzLl9wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IHRoaXMuX19kZWVwQ2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKCiAgICAgICAgICAgIHRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAgICAgaW5pdDogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICB9LAogICAgICAgIHRvSlNPTjogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRvSnNvbigpOwogICAgICAgIH0sCiAgICAgICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgICAgIHRvSnNvbjogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IHRoaXMuX19wcm9wZXJ0eS5nZXRQcm9wZXJ0aWVzKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgICAgIHZhciBqc29uID0ge307CiAgICAgICAgICAgIGZvciAodmFyIHBhdGggaW4gcHJvcHMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwcm9wID0gdW53cmFwT2JzZXJ2YWJsZShwcm9wc1twYXRoXSksIHZhbHVlID0gcHJvcDsKCiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3RPck9iamVjdE9ic2VydmFibGUocHJvcCkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB7fTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHByb3ApCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChwcm9wLCBpKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlW2ldID0gcHJvcFtpXS50b0pzb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzQXJyYXlPckFycmF5T2JzZXJ2YWJsZShwcm9wKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gcHJvcC5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnB1c2gocHJvcFtpXS50b0pzb24oKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fX3Byb3BlcnR5LnNldChqc29uLCBwYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGpzb247CiAgICAgICAgfSwKICAgICAgICBwYXJlbnQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyZW50OwogICAgICAgIH0sCiAgICAgICAgLy8gR2V0IHRoZSB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAocGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX19wcm9wZXJ0eS5nZXQodGhpcy5hdHRyaWJ1dGVzLCBwYXRoIHx8ICcnKTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgLy8gR2V0IHRoZSBIVE1MLWVzY2FwZWQgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgICAgIGVzY2FwZTogZnVuY3Rpb24gKHBhdGgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgaHRtbDsKICAgICAgICAgICAgaWYgKGh0bWwgPSB0aGlzLl9fcHJvcGVydHkuZ2V0KHRoaXMuX2VzY2FwZWRBdHRyaWJ1dGVzLCBwYXRoKSkgcmV0dXJuIGh0bWw7CiAgICAgICAgICAgIHZhciB2YWwgPSB0aGlzLmdldChwYXRoKTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IF8uZXNjYXBlKHZhbCA9PSBudWxsID8gJycgOiAnJyArIHZhbCk7CiAgICAgICAgICAgIHRoaXMuX19wcm9wZXJ0eS5zZXQodGhpcy5fZXNjYXBlZEF0dHJpYnV0ZXMsIHBhdGgsIHJlc3VsdCk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKICAgICAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgICAgICBoYXM6IGZ1bmN0aW9uIChwYXRoKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19wcm9wZXJ0eS5oYXModGhpcy5hdHRyaWJ1dGVzLCBwYXRoIHx8ICcnKTsKICAgICAgICB9LAogICAgICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcyBvbiB0aGUgb2JqZWN0LCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MKICAgICAgICAvLyB5b3UgY2hvb3NlIHRvIHNpbGVuY2UgaXQuCiAgICAgICAgc2V0OiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgb3B0aW9ucykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBhdHRycywgYXR0ciwgdmFsOwogICAgICAgICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgICAgICAgaWYgKF8uaXNPYmplY3Qoa2V5KSB8fCBrZXkgPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBhdHRycyA9IHt9OwogICAgICAgICAgICAgICAgdGhpcy5fX3Byb3BlcnR5LmJ1aWxkKGF0dHJzLCBrZXkpW3RoaXMuX19wcm9wZXJ0eS5sYXN0KGF0dHJzLCBrZXkpXSA9IHZhbHVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFeHRyYWN0IGF0dHJpYnV0ZXMgYW5kIG9wdGlvbnMuCiAgICAgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgICAgICAgIGlmICghYXR0cnMpIHJldHVybiB0aGlzOwogICAgICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiB0aGlzLmNvbnN0cnVjdG9yKSBhdHRycyA9IGF0dHJzLmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIGlmIChvcHRpb25zLnVuc2V0KSBmb3IgKGF0dHIgaW4gYXR0cnMpIGF0dHJzW2F0dHJdID0gdm9pZCAwOwoKICAgICAgICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCiAgICAgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgogICAgICAgICAgICBpZiAodGhpcy5fX3Byb3BlcnR5LmhhcyhhdHRycywgdGhpcy5pZEF0dHJpYnV0ZSkpIHRoaXMuaWQgPSB0aGlzLl9fcHJvcGVydHkuZ2V0KGF0dHJzLCB0aGlzLmlkQXR0cmlidXRlKTsKCiAgICAgICAgICAgIHZhciBjaGFuZ2VzID0gb3B0aW9ucy5jaGFuZ2VzID0ge30sCiAgICAgICAgICAgICAgICBub3cgPSB0aGlzLmF0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICBlc2NhcGVkID0gdGhpcy5fZXNjYXBlZEF0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICBwcmV2ID0gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIHx8IHt9OwoKICAgICAgICAgICAgdmFyIHBhdGhzID0gdGhpcy5fX3Byb3BlcnR5LmdldFByb3BlcnRpZXMoYXR0cnMpOwoKICAgICAgICAgICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLi4uCiAgICAgICAgICAgIGZvciAodmFyIHBhdGggaW4gcGF0aHMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwcm9wID0gcGF0aHNbcGF0aF0sCiAgICAgICAgICAgICAgICAgICAgcE5vdyA9IHRoaXMuX19wcm9wZXJ0eS5idWlsZChub3csIHBhdGgpLAogICAgICAgICAgICAgICAgICAgIHBQcmV2ID0gdGhpcy5fX3Byb3BlcnR5LmdldFBhcmVudChwcmV2LCBwYXRoKSwKICAgICAgICAgICAgICAgICAgICBwQ2hhbmdlcyA9IHRoaXMuX19wcm9wZXJ0eS5idWlsZChjaGFuZ2VzLCBwYXRoKSwKICAgICAgICAgICAgICAgICAgICBwRXNjYXBlZCA9IHRoaXMuX19wcm9wZXJ0eS5idWlsZChlc2NhcGVkLCBwYXRoKSwKICAgICAgICAgICAgICAgICAgICBhdHRyID0gdGhpcy5fX3Byb3BlcnR5Lmxhc3QoYXR0cnMsIHBhdGgpLAogICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuX19wcm9wZXJ0eS5nZXQoYXR0cnMsIHBhdGgpOwoKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdE9yT2JqZWN0T2JzZXJ2YWJsZShwcm9wKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudW5zZXQgPyBkZWxldGUgcE5vd1thdHRyXSA6IHBOb3dbYXR0cl0gPSAocE5vd1thdHRyXSB8fCBrby5vYnNlcnZhYmxlKHt9KSk7CgogICAgICAgICAgICAgICAgICAgIHZhciBuZXdWYWwgPSBwTm93W2F0dHJdOwogICAgICAgICAgICAgICAgICAgIHZhciB1bmRlcmx5aW5nTmV3VmFsID0gbmV3VmFsKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiB2YWwpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwodmFsLCBpKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHV2ID0gdW5kZXJseWluZ05ld1ZhbFtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1diAmJiB1diBpbnN0YW5jZW9mIHRoaXMuY29uc3RydWN0b3IpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXYuc2V0KHZhbFtpXSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHYgPSB2YWxbaV0gaW5zdGFuY2VvZiB0aGlzLmNvbnN0cnVjdG9yID8gdmFsW2ldIDogbmV3IHRoaXMuY29uc3RydWN0b3IodmFsW2ldLCB1bmRlZmluZWQsIHBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5kZXJseWluZ05ld1ZhbFtpXSA9IHY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhbCA9IG5ld1ZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzQXJyYXlPckFycmF5T2JzZXJ2YWJsZShwcm9wKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudW5zZXQgPyBkZWxldGUgcE5vd1thdHRyXSA6IHBOb3dbYXR0cl0gPSAocE5vd1thdHRyXSB8fCBrby5vYnNlcnZhYmxlQXJyYXkoW10pKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1ZhbCA9IHBOb3dbYXR0cl07CiAgICAgICAgICAgICAgICAgICAgdmFyIHVuZGVybHlpbmdOZXdWYWwgPSBuZXdWYWwoKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IHZhbC5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXYgPSB1bmRlcmx5aW5nTmV3VmFsW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodXYgJiYgdXYgaW5zdGFuY2VvZiB0aGlzLmNvbnN0cnVjdG9yKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1di5zZXQodmFsW2ldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2ID0gdmFsW2ldIGluc3RhbmNlb2YgdGhpcy5jb25zdHJ1Y3RvciA/IHZhbFtpXSA6IG5ldyB0aGlzLmNvbnN0cnVjdG9yKHZhbFtpXSwgdW5kZWZpbmVkLCBwYXJlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3VmFsLnB1c2godik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIG5ld1ZhbC5zdWJzY3JpYmUoX25ld1ZhbHVlR2VuZXJhdG9yU3Vic2NyaXB0aW9uLmNhbGwodGhpcywgcGF0aCwgbmV3VmFsLCBwYXJlbnQpKTsKCiAgICAgICAgICAgICAgICAgICAgdmFsID0gbmV3VmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy51bnNldCA/IGRlbGV0ZSBwTm93W2F0dHJdIDogcE5vd1thdHRyXSA9IHZhbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgbmV3IGFuZCBjdXJyZW50IHZhbHVlIGRpZmZlciwgcmVjb3JkIHRoZSBjaGFuZ2UuCiAgICAgICAgICAgICAgICBpZiAoIV8uaXNFcXVhbChwTm93W2F0dHJdLCB2YWwpIHx8IChvcHRpb25zLnVuc2V0ICYmIF8uaGFzKHBOb3csIGF0dHIpKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgcEVzY2FwZWRbYXR0cl07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fX3Byb3BlcnR5LnNldCgob3B0aW9ucy5zaWxlbnQgPyB0aGlzLl9zaWxlbnQgOiBjaGFuZ2VzKSwgcGF0aCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSWYgdGhlIG5ldyBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLCByZWNvcmQgdGhlIGNoYW5nZS4gIElmIG5vdCwKICAgICAgICAgICAgICAgIC8vIHRoZW4gcmVtb3ZlIGNoYW5nZXMgZm9yIHRoaXMgYXR0cmlidXRlLgogICAgICAgICAgICAgICAgaWYgKCFfLmlzRXF1YWwocFByZXZbYXR0cl0sIHZhbCkgfHwgKF8uaGFzKHBOb3csIGF0dHIpICE9PSBfLmhhcyhwUHJldiwgYXR0cikpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX19wcm9wZXJ0eS5zZXQodGhpcy5jaGFuZ2VkLCBwYXRoLCB2YWwpOwogICAgICAgICAgICAgICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMuX19wcm9wZXJ0eS5zZXQodGhpcy5fcGVuZGluZywgcGF0aCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fX3Byb3BlcnR5LmRlbCh0aGlzLmNoYW5nZWQsIHBhdGgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX19wcm9wZXJ0eS5kZWwodGhpcy5fcGVuZGluZywgcGF0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZpcmUgdGhlIGAiY2hhbmdlImAgZXZlbnRzLgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLmNoYW5nZShvcHRpb25zKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICByZXNldDogZnVuY3Rpb24gKG9wdGlvbnMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zZXQodGhpcy5fX2RlZXBDbG9uZSh0aGlzLl9vcmlnaW5hbEF0dHJpYnV0ZXMpLCBvcHRpb25zKTsKICAgICAgICB9LAogICAgICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCiAgICAgICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAgICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgICAgICBzYXZlOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgb3B0aW9ucykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBhdHRycywgY3VycmVudDsKICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGtleSkgfHwga2V5ID09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgICAgICAgICAgb3B0aW9ucyA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYXR0cnMgPSB7fTsKICAgICAgICAgICAgICAgIHRoaXMuX19wcm9wZXJ0eS5idWlsZChhdHRycywga2V5KVt0aGlzLl9fcHJvcGVydHkubGFzdChhdHRycywga2V5KV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgICAgICAgIGlmIChvcHRpb25zLndhaXQpIGN1cnJlbnQgPSB0aGlzLl9fZGVlcENsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgICAgIHZhciBzaWxlbnRPcHRpb25zID0gZXh0ZW5kKHt9LCBvcHRpb25zLCB7IHNpbGVudDogdHJ1ZSB9KTsKICAgICAgICAgICAgaWYgKGF0dHJzICYmICF0aGlzLnNldChhdHRycywgb3B0aW9ucy53YWl0ID8gc2lsZW50T3B0aW9ucyA6IG9wdGlvbnMpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgICAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uIChyZXNwLCBzdGF0dXMsIHhocikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgeGhyKTsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgICAgICAgICBpZiAoIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChzdWNjZXNzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MobW9kZWwsIHJlc3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG9wdGlvbnMuZXJyb3IgPSBCYWNrYm9uZS53cmFwRXJyb3Iob3B0aW9ucy5lcnJvciwgbW9kZWwsIG9wdGlvbnMpOwogICAgICAgICAgICB2YXIgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiAndXBkYXRlJzsKICAgICAgICAgICAgdmFyIHhociA9ICh0aGlzLnN5bmMgfHwgQmFja2JvbmUuc3luYykuY2FsbCh0aGlzLCBtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAob3B0aW9ucy53YWl0KSB0aGlzLnNldChjdXJyZW50LCBzaWxlbnRPcHRpb25zKTsKICAgICAgICAgICAgcmV0dXJuIHhocjsKICAgICAgICB9LAoKICAgICAgICAvLyBDYWxsIHRoaXMgbWV0aG9kIHRvIG1hbnVhbGx5IGZpcmUgYSBgImNoYW5nZSJgIGV2ZW50IGZvciB0aGlzIG1vZGVsIGFuZAogICAgICAgIC8vIGEgYCJjaGFuZ2U6YXR0cmlidXRlImAgZXZlbnQgZm9yIGVhY2ggY2hhbmdlZCBhdHRyaWJ1dGUuCiAgICAgICAgLy8gQ2FsbGluZyB0aGlzIHdpbGwgY2F1c2UgYWxsIG9iamVjdHMgb2JzZXJ2aW5nIHRoZSBtb2RlbCB0byB1cGRhdGUuCiAgICAgICAgY2hhbmdlOiBmdW5jdGlvbiAob3B0aW9ucykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9jaGFuZ2luZyB8fCAhdGhpcy5oYXNDaGFuZ2VkKCkpIHJldHVybiB0aGlzOwogICAgICAgICAgICB0aGlzLl9jaGFuZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX21vcmVDaGFuZ2VzID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHRyaWdnZXIgPSBmdW5jdGlvbiAoY2hhbmdlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHBhdGhzID0gdGhpcy5fX3Byb3BlcnR5LmdldFByb3BlcnRpZXMoY2hhbmdlZCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBwYXRoIGluIHBhdGhzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGFuZ2UgPSB0aGlzLl9fcHJvcGVydHkuZ2V0KGNoYW5nZWQsIHBhdGgpOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgcGF0aCwgdGhpcywgY2hhbmdlLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgdHJpZ2dlci5jYWxsKHRoaXMsIHRoaXMuX2NoYW5nZWQpOwogICAgICAgICAgICB3aGlsZSAodGhpcy5fbW9yZUNoYW5nZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX21vcmVDaGFuZ2VzID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IHRoaXMuX19kZWVwQ2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2NoYW5nZWQ7CiAgICAgICAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgICAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uIChwYXRoKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLl9jaGFuZ2VkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NoYW5nZWQgJiYgdGhpcy5fX3Byb3BlcnR5Lmhhcyh0aGlzLl9jaGFuZ2VkLCBwYXRoIHx8ICcnKTsKICAgICAgICB9LAoKICAgICAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAgICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAgICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgICAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24gKGRpZmYpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IHRoaXMuX19kZWVwQ2xvbmUodGhpcy5fY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19wcm9wZXJ0eS5maW5kQWxsQ2hhbmdlZFByb3BlcnRpZXModGhpcy5hdHRyaWJ1dGVzLCBkaWZmKTsKICAgICAgICB9LAoKICAgICAgICBnZXRDaGFuZ2VzOiBmdW5jdGlvbiAob3B0aW9ucywgY2hlY2tBZ2FpbnN0KQogICAgICAgIHsKICAgICAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSovCiAgICAgICAgICAgIHZhciByZXRPYmogPSB7fSwKICAgICAgICAgICAgICAgIHBhdGhzID0gdGhpcy5fX3Byb3BlcnR5LmdldFByb3BlcnRpZXModGhpcy5hdHRyaWJ1dGVzKSwKICAgICAgICAgICAgICAgIGhhc0FkZGl0aW9uYWxWYWx1ZXMgPSBmYWxzZSwKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9LAogICAgICAgICAgICAgICAgcmVxdWlyZWRQcm9wZXJ0aWVzID0gb3B0aW9ucy5yZXF1aXJlZCB8fCB7fSwKICAgICAgICAgICAgICAgIGNvbXBsZXRlQXJyYXkgPSBvcHRpb25zLmNvbXBsZXRlQXJyYXkgfHwge30sCiAgICAgICAgICAgICAgICBwYXJ0aWFsQXJyYXkgPSBvcHRpb25zLnBhcnRpYWxBcnJheSB8fCB7fTsKCiAgICAgICAgICAgIHZhciBoYXNQYXJ0aWFsQXJyYXlPcHRpb24gPSBfLnNpemUocGFydGlhbEFycmF5KSA+IDAsCiAgICAgICAgICAgICAgICBoYXNDb21wbGV0ZUFycmF5T3B0aW9uID0gXy5zaXplKGNvbXBsZXRlQXJyYXkpID4gMDsKCiAgICAgICAgICAgIGZvciAodmFyIHBhdGggaW4gcGF0aHMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHBhdGhzW3BhdGhdLAogICAgICAgICAgICAgICAgICAgIG9WYWx1ZSA9IHRoaXMuX19wcm9wZXJ0eS5nZXQoY2hlY2tBZ2FpbnN0IHx8IHRoaXMuX29yaWdpbmFsQXR0cmlidXRlcywgcGF0aCk7CgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIG9ic2VydmFibGVBcnJheQogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0T3JPYmplY3RPYnNlcnZhYmxlKHZhbHVlKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVud3JhcE9ic2VydmFibGUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIG9WYWx1ZSA9IHVud3JhcE9ic2VydmFibGUob1ZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIG9iaiA9IHt9OwogICAgICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbE9iamVjdCA9IHt9OwogICAgICAgICAgICAgICAgICAgIHZhciBvYmplY3RIYXNNdXRhdGVkID0gIW9WYWx1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAob1ZhbHVlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgJiYgXy5mb3JFYWNoKHZhbHVlLCBmdW5jdGlvbiAoeCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB4Lm9yaWdpbmFsS2V5ICE9PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbE9iamVjdFt4Lm9yaWdpbmFsS2V5XSA9IG9WYWx1ZVt4Lm9yaWdpbmFsS2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3RIYXNNdXRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHZhbHVlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHZhbHVlLCBpKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlYWxWYWx1ZSA9IHZhbHVlW2ldLCBjaGFuZ2VzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZWFsVmFsdWUub3JpZ2luYWxLZXkgIT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZXMgPSByZWFsVmFsdWUuZ2V0Q2hhbmdlcyhvcHRpb25zLCBvcmlnaW5hbE9iamVjdFtyZWFsVmFsdWUub3JpZ2luYWxLZXldIHx8IHt9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VzID0gcmVhbFZhbHVlLmdldENoYW5nZXMob3B0aW9ucywge30pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGFuZ2VzICYmICFfLmlzRW1wdHkoY2hhbmdlcykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2ldID0gY2hhbmdlczsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoKF8uc2l6ZShvYmopID4gMCB8fCBvYmplY3RIYXNNdXRhdGVkKSAmJiAoaGFzQWRkaXRpb25hbFZhbHVlcyA9IHRydWUpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fX3Byb3BlcnR5LnNldChyZXRPYmosIHBhdGgsIG9iaik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNBcnJheU9yQXJyYXlPYnNlcnZhYmxlKHZhbHVlKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVud3JhcE9ic2VydmFibGUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIG9WYWx1ZSA9IHVud3JhcE9ic2VydmFibGUob1ZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGFyciA9IFtdOwogICAgICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEFycmF5ID0ge307CiAgICAgICAgICAgICAgICAgICAgdmFyIGFycmF5SGFzTXV0YXRlZCA9ICFvVmFsdWUgfHwgKG9WYWx1ZS5sZW5ndGggPiAwICYmIHZhbHVlLmxlbmd0aCA8IG9WYWx1ZS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgIGlmIChvVmFsdWUpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSAmJiB2YWx1ZS5mb3JFYWNoKGZ1bmN0aW9uICh4KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHgub3JpZ2luYWxJbmRleCAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxBcnJheVt4Lm9yaWdpbmFsSW5kZXhdID0gb1ZhbHVlW3gub3JpZ2luYWxJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlIYXNNdXRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IHZhbHVlLmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWFsVmFsdWUgPSB2YWx1ZVtpXSwgY2hhbmdlczsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZWFsVmFsdWUub3JpZ2luYWxJbmRleCAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZXMgPSByZWFsVmFsdWUuZ2V0Q2hhbmdlcyhvcHRpb25zLCBvcmlnaW5hbEFycmF5W3JlYWxWYWx1ZS5vcmlnaW5hbEluZGV4XSB8fCB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VzID0gcmVhbFZhbHVlLmdldENoYW5nZXMob3B0aW9ucywge30pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJyYXlIYXNNdXRhdGVkKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzQ29tcGxldGVBcnJheU9wdGlvbiAmJiBfLmFueShjb21wbGV0ZUFycmF5LCBmdW5jdGlvbiAoeCkgeyByZXR1cm4gcGF0aC5pbmRleE9mKHgpID4gLTE7IH0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZXMgPSByZWFsVmFsdWUudG9Kc29uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXNQYXJ0aWFsQXJyYXlPcHRpb24gJiYgXy5hbGwocGFydGlhbEFycmF5LCBmdW5jdGlvbiAoeCkgeyByZXR1cm4gcGF0aC5pbmRleE9mKHgpID09PSAtMTsgfSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlcyA9IHJlYWxWYWx1ZS50b0pzb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYW5nZXMgJiYgIV8uaXNFbXB0eShjaGFuZ2VzKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKGNoYW5nZXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoKGFyci5sZW5ndGggPiAwIHx8IGFycmF5SGFzTXV0YXRlZCkgJiYgKGhhc0FkZGl0aW9uYWxWYWx1ZXMgPSB0cnVlKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX19wcm9wZXJ0eS5zZXQocmV0T2JqLCBwYXRoLCBhcnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBUb3RhbCBhYnVzZSBvZiBhbiBpZiBzdGF0ZW1lbnQKICAgICAgICAgICAgICAgICAgICBpZiAoKHZhbHVlICE9IG9WYWx1ZSAmJiAoaGFzQWRkaXRpb25hbFZhbHVlcyA9IHRydWUpKSB8fCByZXF1aXJlZFByb3BlcnRpZXMgJiYgcmVxdWlyZWRQcm9wZXJ0aWVzW3BhdGhdKQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9fcHJvcGVydHkuc2V0KHJldE9iaiwgcGF0aCwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNBZGRpdGlvbmFsVmFsdWVzKQogICAgICAgICAgICAgICAgcmV0dXJuIHJldE9iajsKICAgICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgIH0sCgogICAgICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgICAgIHByZXZpb3VzOiBmdW5jdGlvbiAocGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19wcm9wZXJ0eS5nZXQodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzLCBwYXRoIHx8ICcnKTsKICAgICAgICB9LAoKICAgICAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgICAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZGVlcENsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIG1vZGVsIGlzIGN1cnJlbnRseSBpbiBhIHZhbGlkIHN0YXRlLiBJdCdzIG9ubHkgcG9zc2libGUgdG8KICAgICAgICAvLyBnZXQgaW50byBhbiAqaW52YWxpZCogc3RhdGUgaWYgeW91J3JlIHVzaW5nIHNpbGVudCBjaGFuZ2VzLgogICAgICAgIGlzVmFsaWQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gIXRoaXMudmFsaWRhdGUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgICB9LAoKICAgICAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IGEgc2V0IG9mIGluY29taW5nIGF0dHJpYnV0ZXMsIHJldHVybmluZyBgdHJ1ZWAKICAgICAgICAvLyBpZiBhbGwgaXMgd2VsbC4gSWYgYSBzcGVjaWZpYyBgZXJyb3JgIGNhbGxiYWNrIGhhcyBiZWVuIHBhc3NlZCwKICAgICAgICAvLyBjYWxsIHRoYXQgaW5zdGVhZCBvZiBmaXJpbmcgdGhlIGdlbmVyYWwgYCJlcnJvciJgIGV2ZW50LgogICAgICAgIF92YWxpZGF0ZTogZnVuY3Rpb24gKGF0dHJzLCBvcHRpb25zKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMuc2lsZW50IHx8ICF0aGlzLnZhbGlkYXRlKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgYXR0cnMgPSBleHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZXJyb3IpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMuZXJyb3IodGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIHRoaXMsIGVycm9yLCBvcHRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICAvLyBDYWxsIHRoZSBrbyBiaW5kaW5ncy4KICAgICAgICBhcHBseUJpbmRpbmdzOiBmdW5jdGlvbiAodG8pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4ga28uYXBwbHlCaW5kaW5ncyh0aGlzLmdldFZpZXdNb2RlbCgpLCB0byk7CiAgICAgICAgfSwKICAgIH0pOwoKICAgIEtub2Nrb3V0TW9kZWxCYXNlLnByb3RvdHlwZS5nZXRWaWV3TW9kZWwgPSBmdW5jdGlvbiAob3B0aW9ucykKICAgIHsKICAgICAgICBpZiAoX192aWV3TW9kZWxzW3RoaXMuY2lkXSkKICAgICAgICAgICAgcmV0dXJuIF9fdmlld01vZGVsc1t0aGlzLmNpZF07CgogICAgICAgIHJldHVybiAoX192aWV3TW9kZWxzW3RoaXMuY2lkXSA9IG5ldyB0aGlzLnZpZXdNb2RlbENvbnN0cnVjdG9yKHRoaXMsIG9wdGlvbnMpKTsKICAgIH07CgogICAgS25vY2tvdXRNb2RlbEJhc2UuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwoKICAgIEtub2Nrb3V0TW9kZWxCYXNlLnByb3RvdHlwZS50b0pTT04gPSBLbm9ja291dE1vZGVsQmFzZS5wcm90b3R5cGUudG9Kc29uOwoKICAgIEtub2Nrb3V0TW9kZWxCYXNlLmdldE1vZGVsID0gZnVuY3Rpb24gKGNpZCkKICAgIHsKICAgICAgICByZXR1cm4gX19tb2RlbHNbY2lkXTsKICAgIH07CgogICAgS25vY2tvdXRNb2RlbEJhc2UuX19tb2RlbHMgPSBfX21vZGVsczsKICAgIEtub2Nrb3V0TW9kZWxCYXNlLl9fdmlld01vZGVscyA9IF9fdmlld01vZGVsczsKCiAgICByZXR1cm4gS25vY2tvdXRNb2RlbEJhc2U7Cn0pOwoKZGVmaW5lKCdrb2ItbW9kZWwvdmlld21vZGVsLmJhc2UnLFsKICAgICcuL21vZGVsLmJhc2UnLAogICAgJ2tub2Nrb3V0JywKICAgICdsb2Rhc2gnLAogICAgJy4vdXRpbCcKXSwKZnVuY3Rpb24gKEtub2Nrb3V0TW9kZWxCYXNlLCBrbywgXywgdXRpbCkKewogICAgCiAgICB2YXIgZXh0ZW5kID0gXy5leHRlbmQsCiAgICAgICAga25vY2tvdXRQYXRoID0gdXRpbC5rbm9ja291dFBhdGgsCiAgICAgICAgX19tb2RlbHMgPSBLbm9ja291dE1vZGVsQmFzZS5fX21vZGVscywKICAgICAgICBfX3ZpZXdNb2RlbHMgPSBLbm9ja291dE1vZGVsQmFzZS5fX3ZpZXdNb2RlbHMsCiAgICAgICAgX19vcmlnaW5hbFN0YXRlID0ge30sCiAgICAgICAgdW53cmFwT2JzZXJ2YWJsZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUsCiAgICAgICAgaXNBcnJheSA9IF8uaXNBcnJheSwKICAgICAgICBpc1N0cmluZyA9IF8uaXNTdHJpbmcsCiAgICAgICAgaXNFcXVhbCA9IF8uaXNFcXVhbCwKICAgICAgICBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLAogICAgICAgIGVhY2ggPSBfLmVhY2gsCiAgICAgICAgaXNPYmplY3RPck9iamVjdE9ic2VydmFibGUgPSB1dGlsLmlzT2JqZWN0T3JPYmplY3RPYnNlcnZhYmxlLAogICAgICAgIGlzQXJyYXlPckFycmF5T2JzZXJ2YWJsZSA9IHV0aWwuaXNBcnJheU9yQXJyYXlPYnNlcnZhYmxlOwoKICAgIHZhciBLbm9ja291dFZpZXdNb2RlbEJhc2UgPSBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpCiAgICB7CiAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSovCiAgICAgICAgLy8gZmV0Y2ggYWxsIHRoZSBsZWFmIG5vZGVzIGZvciB0aGUgbW9kZWwuCiAgICAgICAgdmFyIHByb3BlcnRpZXMgPSB0aGlzLmdldFByb3BlcnRpZXMobW9kZWwuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaWQgPSBtb2RlbC5jaWQ7CiAgICAgICAgX19tb2RlbHNbbW9kZWwuY2lkXSA9IG1vZGVsOwoKICAgICAgICB2YXIgbW9kZWxIYXNFcnJvck1lc3NhZ2VzID0gISFtb2RlbC5lcnJvck1lc3NhZ2VzOwogICAgICAgIGlmIChtb2RlbEhhc0Vycm9yTWVzc2FnZXMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnN1bW1hcnkgPSBtb2RlbC5lcnJvck1lc3NhZ2VzLmdldEVycm9yT2JzZXJ2YWJsZSgnc3VtbWFyeScpOwogICAgICAgICAgICB0aGlzLnN1bW1hcnkuaGFzRXJyb3JzID0gdGhpcy5zdW1tYXJ5LmVycm9ycy5oYXNFcnJvcnM7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBwYXRoIGluIHByb3BlcnRpZXMpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvcCA9IHVud3JhcE9ic2VydmFibGUocHJvcGVydGllc1twYXRoXSksCiAgICAgICAgICAgICAgICBrb1BhdGggPSBrbm9ja291dFBhdGgocGF0aCksCiAgICAgICAgICAgICAgICBiaW5kUGF0aCA9ICdjaGFuZ2U6JyArIHBhdGgsCiAgICAgICAgICAgICAgICBsYXN0SW5kZXggPSAtMSwKICAgICAgICAgICAgICAgIG9ic2VydmFibGU7CgogICAgICAgICAgICBpZiAoaXNPYmplY3RPck9iamVjdE9ic2VydmFibGUocHJvcCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBvYnNlcnZhYmxlVmFsdWUgPSB7fTsKICAgICAgICAgICAgICAgIG9ic2VydmFibGUgPSB0aGlzW2tvUGF0aF0gPSBrby5vYnNlcnZhYmxlKG9ic2VydmFibGVWYWx1ZSk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHByb3ApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHByb3AsIGkpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN1YktvUGF0aCA9IGtub2Nrb3V0UGF0aChpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BNb2RlbCA9IHByb3BbaV0sIHByb3BWaWV3TW9kZWwgPSBwcm9wTW9kZWwuZ2V0Vmlld01vZGVsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BWaWV3TW9kZWwub3JpZ2luYWxLZXkgPSBwcm9wTW9kZWwub3JpZ2luYWxLZXkgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZhYmxlVmFsdWVbc3ViS29QYXRoXSA9IHByb3BWaWV3TW9kZWw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGlzQXJyYXlPckFycmF5T2JzZXJ2YWJsZShwcm9wKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb2JzZXJ2YWJsZSA9IHRoaXNba29QYXRoXSA9IGtvLm9ic2VydmFibGVBcnJheShbXSk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IHByb3AubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBwcm9wTW9kZWwgPSBwcm9wW2ldLCBwcm9wVmlld01vZGVsID0gcHJvcE1vZGVsLmdldFZpZXdNb2RlbCgpOwogICAgICAgICAgICAgICAgICAgIHByb3BWaWV3TW9kZWwub3JpZ2luYWxJbmRleCA9IHByb3BNb2RlbC5vcmlnaW5hbEluZGV4ID0gaTsKICAgICAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnB1c2gocHJvcFZpZXdNb2RlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtb2RlbC5iaW5kKGJpbmRQYXRoLCB1cGRhdGVfdm1PYnNlcnZhYmxlQXJyYXlfZnJvbV9tT2JzZXJ2YWJsZUFycmF5RmFjdG9yeShvYnNlcnZhYmxlKSk7CiAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnN1YnNjcmliZSh1cGRhdGVfbU9ic2VydmFibGVBcnJheV9mcm9tX3ZtT2JzZXJ2YWJsZUFycmF5X2ZhY3RvcnkobW9kZWwsIHBhdGgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9ic2VydmFibGUgPSB0aGlzW2tvUGF0aF0gPSBrby5vYnNlcnZhYmxlKHR5cGVvZiBwcm9wID09PSAndW5kZWZpbmVkJyA/ICcnIDogcHJvcCk7CiAgICAgICAgICAgICAgICBtb2RlbC5iaW5kKGJpbmRQYXRoLCB1cGRhdGVfdm1PYnNlcnZhYmxlX2Zyb21fbVZhbHVlX2ZhY3Rvcnkob2JzZXJ2YWJsZSkpOwogICAgICAgICAgICAgICAgb2JzZXJ2YWJsZS5zdWJzY3JpYmUodXBkYXRlX21WYWx1ZV9mcm9tX3ZtT2JzZXJ2YWJsZV9mYWN0b3J5KG1vZGVsLCBwYXRoKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChtb2RlbEhhc0Vycm9yTWVzc2FnZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9ic2VydmFibGUuZXJyb3JzID0gbW9kZWwuZXJyb3JNZXNzYWdlcy5nZXRFcnJvck9ic2VydmFibGUocGF0aCk7CiAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLmhhc0Vycm9ycyA9IG9ic2VydmFibGUuZXJyb3JzLmhhc0Vycm9yczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5taXJyb3JQYXRocykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgZWFjaChvcHRpb25zLm1pcnJvclBhdGhzLCBmdW5jdGlvbiAobWlycm9yUGF0aCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoa29QYXRoLmluZGV4T2YobWlycm9yUGF0aCkgPT09IGtvUGF0aC5sZW5ndGggLSBtaXJyb3JQYXRoLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdFtrb1BhdGguc3Vic3RyaW5nKDAsIGtvUGF0aC5sZW5ndGggLSBtaXJyb3JQYXRoLmxlbmd0aCldID0gb2JzZXJ2YWJsZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICB2YXIgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgIGV4dGVuZChLbm9ja291dFZpZXdNb2RlbEJhc2UucHJvdG90eXBlLCB7CiAgICAgICAgZ2V0UHJvcGVydGllczogZnVuY3Rpb24gKG9iaikKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTllJJyk7CiAgICAgICAgfSwKICAgICAgICBnZXRNb2RlbDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBfX21vZGVsc1t0aGlzLmNpZF07CiAgICAgICAgfSwKICAgICAgICBwYXJlbnQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgbSA9IHRoaXMuZ2V0TW9kZWwoKTsKICAgICAgICAgICAgcmV0dXJuIG0uX3BhcmVudCAmJiBfX3ZpZXdNb2RlbHNbbS5fcGFyZW50LmNpZF07CiAgICAgICAgfSwKICAgICAgICBjbG9uZTogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldE1vZGVsKCkuY2xvbmUoKS5nZXRWaWV3TW9kZWwoKTsKICAgICAgICB9LAogICAgICAgIHN0b3JlOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIG9zID0gX19vcmlnaW5hbFN0YXRlW3RoaXMuY2lkXSA9IHt9OwoKICAgICAgICAgICAgZm9yICh2YXIgaSBpbiB0aGlzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwodGhpcywgaSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gdW53cmFwT2JzZXJ2YWJsZSh0aGlzW2ldKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdiA9IG9zW2ldID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIHogPSAwLCB6TGVuID0gdmFsdWUubGVuZ3RoOyB6IDwgekxlbjsgeisrKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWVbel0gaW5zdGFuY2VvZiB0aGlzLmNvbnN0cnVjdG9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlW3pdLnN0b3JlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdi5wdXNoKHZhbHVlW3pdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBvc1tpXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmV2ZXJ0OiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHN0YXRlID0gX19vcmlnaW5hbFN0YXRlW3RoaXMuY2lkXTsKICAgICAgICAgICAgaWYgKHN0YXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHN0YXRlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbCh0aGlzLCBpKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHN0YXRlW2ldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyVGhpcyA9IHVud3JhcE9ic2VydmFibGUodGhpc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyVGhpcy5zcGxpY2UoMCwgdmFyVGhpcy5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgeiA9IDAsIHpMZW4gPSB2YWx1ZS5sZW5ndGg7IHogPCB6TGVuOyB6KyspCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyVGhpcy5wdXNoKHZhbHVlW3pdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZVt6XS5yZXZlcnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKHRoaXNbaV0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7IH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY29tbWl0OiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgZGVsZXRlIF9fb3JpZ2luYWxTdGF0ZVt0aGlzLmNpZF07CiAgICAgICAgfSwKICAgICAgICAvLyBDYWxsIHRoZSBrbyBiaW5kaW5ncy4KICAgICAgICBhcHBseUJpbmRpbmdzOiBmdW5jdGlvbiAodG8pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4ga28uYXBwbHlCaW5kaW5ncyh0aGlzLCB0byk7CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICBNYXBzIHRoZSBjaGFuZ2VzIGZyb20gb25lIGFycmF5IG9udG8gdGhlIG90aGVyIGFycmF5LgogICAgQXR0ZW1wdGluZyB0byB0cmFjayBzaW1wbGUgb3BlcmF0aW9ucywgbGlrZSBpbnNlcnRzIG9yIHNwbGljZXMsIHdvcnNlIGNhc2UgdGhlIGVudGlyZSBhcnJheSBlbXB0aWVkIGFuZCByZWJ1aWx0LgogICAgVGhlIGxhc3Qgb3BlcmF0aW9uIGNvdWxkIHVzZSBzb21lIFRMQyBzbyB0aGF0IGl0J3Mgbm90IGFzIGV4cGVuc2l2ZSBpZiB0aGUgYXJyYXkgaXMgdmVyeSBsYXJnZS4KCiAgICBAbWV0aG9kIG9ic2VydmFibGVBcnJheVN1YnNjcmlwdGlvbkJpbmRlcgogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7a28ub2JzZXJ2YWJsZUFycmF5IHwgQXJyYXl9IHRhcmdldEFycmF5IFRoZSBhcnJheSB0aGF0IGlzIHRoZSB0YXJnZXQgb2YgdGhlIGNoYW5nZXMuCiAgICBAcGFyYW0ge2tvLm9ic2VydmFibGVBcnJheSB8IEFycmF5fSByZWZlcmVuY2VBcnJheSBUaGUgYXJyYXkgdGhhdCBpcyB0aGUgcmVmZXJlbmNlIGFycmF5IHdpdGggY2hhbmdlcy4KICAgIEBwYXJhbSB7RnVjbnRpb259IG5ld0NhbGxiYWNrIFRoZSBjYWxsYmFjayB0aGF0IGlzIGlzc3VlZCwgdG8gY3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIHRoZSBpdGVtIGluIHRoZSBhcnJheS4gIFRoaW5rIGNyZWF0ZSBhIG5ldyBjbGFzcywgZ2l2ZW4gdGhlIGlucHV0LgogICAgQHBhcmFtIHtTdHJpbmd9IHJlZmVyZW5jZU1vZGVsQWNjZXNzb3IgVGhlIG1vZGVsIGFjY2Vzc29yIGZvciB0aGUgcmVmZXJlbmNlIGFycmF5LiAgV2lsbCByZXR1cm4gYW4gb2JqZWN0IHRoYXQgaXMgY29tcGF0YWJsZSB3aXRoIHRoZSB0YXJnZXQgYXJyYXkgd2hlbiBpbnZva2VkLgogICAgQHBhcmFtIHtTdHJpbmd9IHRhcmdldE1vZGVsQWNjZXNzb3IgVGhlIG1vZGVsIGFjY2Vzc29yIGZvciB0aGUgdGFyZ2V0IGFycmF5LiBXaWxsIHJldHVybiBhbiBvYmplY3QgdGhhdCBpcyBjb21wYXRhYmxlIHdpdGggdGhlIHJlZmVyZW5jZSBhcnJheSB3aGVuIGludm9rZWQuCiAgICAqKi8KICAgIHZhciBvYnNlcnZhYmxlQXJyYXlTdWJzY3JpcHRpb25CaW5kZXIgPSBmdW5jdGlvbiAodGFyZ2V0QXJyYXksIHJlZmVyZW5jZUFycmF5LCBuZXdDYWxsYmFjaywgcmVmZXJlbmNlTW9kZWxBY2Nlc3NvciwgdGFyZ2V0TW9kZWxBY2Nlc3NvcikKICAgIHsKICAgICAgICAvKmpzaGludCBsb29wZnVuYzp0cnVlKi8KICAgICAgICByZWZlcmVuY2VBcnJheSA9IHVud3JhcE9ic2VydmFibGUocmVmZXJlbmNlQXJyYXkpOwogICAgICAgIHZhciB0YXJnZXQgPSB1bndyYXBPYnNlcnZhYmxlKHRhcmdldEFycmF5KTsKCiAgICAgICAgLy8gRXZlbnQgZmlyZXMgd2hlbiBzb21ldGhpbmcgY2hhbmdlcyB3aGVuIHRoZSBhcnJheSBpcyBhZGRlZCBvciByZW1vdmVkLgogICAgICAgIC8vIENoYW5nZSBpbiB0aGUgcGFyZW50IGFycmF5LCBnZXQgdHJhbnNsYXRlZCB0byB0aGUgYmFja2JvbmUgbW9kZWwuCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSByZWZlcmVuY2VBcnJheS5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB2YXIgbyA9IHJlZmVyZW5jZUFycmF5W2ldLAogICAgICAgICAgICAgICAgdCA9IHRhcmdldFtpXTsKICAgICAgICAgICAgLy8gSW5zZXJ0CiAgICAgICAgICAgIGlmICh0ID09PSB1bmRlZmluZWQgfHwgIXQuY2lkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBuZXdDYWxsYmFjayhvKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXRNb2RlbEFjY2Vzc29yKQogICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZUFycmF5W2ldID0gbmV3VmFsdWVbdGFyZ2V0TW9kZWxBY2Nlc3Nvcl0oKTsKICAgICAgICAgICAgICAgIHRhcmdldEFycmF5LnNwbGljZShpLCAwLCBuZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gRGVsZXRlCiAgICAgICAgICAgIGVsc2UgaWYgKHRhcmdldC5sZW5ndGggPiByZWZlcmVuY2VBcnJheS5sZW5ndGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBjaWRzID0gcmVmZXJlbmNlQXJyYXkubWFwKGZ1bmN0aW9uIChpdGVtKSB7IHJldHVybiBpdGVtLmNpZDsgfSk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciB6ID0gdGFyZ2V0Lmxlbmd0aCAtIDE7IHogPj0gMDsgei0tKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBpdGVtID0gdGFyZ2V0W3pdOwogICAgICAgICAgICAgICAgICAgIGlmICghY2lkcy5zb21lKGZ1bmN0aW9uIChpdCkgeyByZXR1cm4gaXQgPT09IGl0ZW0uY2lkOyB9KSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldEFycmF5LnNwbGljZSh6LCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFBvdGVudGlhbGx5IGNvbXBsZXggbW92ZSwganVzdCByZWJ1aWxkIGFycmF5IHdpdGggcmVmZXJlbmNlIG1vZGVscy4KICAgICAgICAgICAgZWxzZSBpZiAodGFyZ2V0W2ldLmNpZCAhPT0gby5jaWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhcmdldC5zcGxpY2UoMCwgdGFyZ2V0Lmxlbmd0aCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciB6ID0gMCwgekxlbiA9IHJlZmVyZW5jZUFycmF5Lmxlbmd0aDsgeiA8IHpMZW47IHorKykKICAgICAgICAgICAgICAgICAgICB0YXJnZXQucHVzaChyZWZlcmVuY2VBcnJheVt6XVtyZWZlcmVuY2VNb2RlbEFjY2Vzc29yXSgpKTsKICAgICAgICAgICAgICAgIC8vIFRhcmdldCBhcnJheSBpcyBvYnNlcnZhYmxlCiAgICAgICAgICAgICAgICB0YXJnZXRBcnJheS5ub3RpZnlTdWJzY3JpYmVycyAmJiB0YXJnZXRBcnJheS5ub3RpZnlTdWJzY3JpYmVycyh0YXJnZXQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJlZmVyZW5jZUFycmF5Lmxlbmd0aCA9PT0gMCAmJiB0YXJnZXQubGVuZ3RoID4gMCkKICAgICAgICAgICAgdGFyZ2V0QXJyYXkuc3BsaWNlKDAsIHRhcmdldC5sZW5ndGgpOwogICAgfTsKCiAgICAvKioKICAgIFVwZGF0ZXMgdGhlIHZpZXcgbW9kZWwgb2JzZXJ2YWJsZSBhcnJheSwgZnJvbSB0aGUgbW9kZWwgb2JzZXJ2YWJsZSBhcnJheS4KCiAgICBAbWV0aG9kIHVwZGF0ZV92bU9ic2VydmFibGVBcnJheV9mcm9tX21PYnNlcnZhYmxlQXJyYXlGYWN0b3J5CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtrby5vYnNlcnZhYmxlQXJyYXl9IG9ic2VydmFibGVBcnJheSBUaGUgb2JzZXJ2YWJsZSBpdGVtLgogICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgc3Vic2NyaXB0aW9uIG1ldGhvZCB0byBiZSB1c2VkIHdoZW4gdXBkYXRpbmcgdGhlIGFycmF5IG9uIHRoZSBtb2RlbCBzaWRlCiAgICAqKi8KICAgIHZhciB1cGRhdGVfdm1PYnNlcnZhYmxlQXJyYXlfZnJvbV9tT2JzZXJ2YWJsZUFycmF5RmFjdG9yeSA9IGZ1bmN0aW9uIChvYnNlcnZhYmxlQXJyYXkpCiAgICB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChwYXRoLCB2YWwpCiAgICAgICAgewogICAgICAgICAgICBvYnNlcnZhYmxlQXJyYXlTdWJzY3JpcHRpb25CaW5kZXIob2JzZXJ2YWJsZUFycmF5LCB2YWwsIGZ1bmN0aW9uIChvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gby5nZXRWaWV3TW9kZWwoKTsKICAgICAgICAgICAgfSwgJ2dldFZpZXdNb2RlbCcpOwogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgVXBkYXRlcyB0aGUgbW9kZWwgb2JzZXJ2YWJsZSBhcnJheSwgZnJvbSB0aGUgdmlldyBtb2RlbCBvYnNlcnZhYmxlIGFycmF5LgoKICAgIEBtZXRob2QgdXBkYXRlX21PYnNlcnZhYmxlQXJyYXlfZnJvbV92bU9ic2VydmFibGVBcnJheV9mYWN0b3J5CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtLbm9ja291dE1vZGVsQmFzZX0gbW9kZWwgVGhlIGNvIG1vZGVsCiAgICBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgcGF0aCB0byB0aGUgb2JzZXJ2YWJsZSBhcnJheQogICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgc3Vic2NyaXB0aW9uIG1ldGhvZCB0byBiZSB1c2VkIHdoZW4gdXBkYXRpbmcgdGhlIGFycmF5IG9uIHRoZSB2aWV3IG1vZGVsIHNpZGUKICAgICoqLwogICAgdmFyIHVwZGF0ZV9tT2JzZXJ2YWJsZUFycmF5X2Zyb21fdm1PYnNlcnZhYmxlQXJyYXlfZmFjdG9yeSA9IGZ1bmN0aW9uIChtb2RlbCwgcGF0aCkKICAgIHsKICAgICAgICB2YXIgcGFyZW50Q2lkID0gbW9kZWwuY2lkLAogICAgICAgICAgICBvYnNlcnZhYmxlQXJyYXkgPSBtb2RlbC5nZXQocGF0aCk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsKQogICAgICAgIHsKICAgICAgICAgICAgb2JzZXJ2YWJsZUFycmF5U3Vic2NyaXB0aW9uQmluZGVyKG9ic2VydmFibGVBcnJheSwgdmFsLCBmdW5jdGlvbiAobykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG8gaW5zdGFuY2VvZiBtb2RlbC5jb25zdHJ1Y3RvcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvID0gby5nZXRNb2RlbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG8gPSBuZXcgbW9kZWwuY29uc3RydWN0b3IobywgdW5kZWZpbmVkLCBfX21vZGVsc1twYXJlbnRDaWRdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgICAgICB9LCAnZ2V0TW9kZWwnLCAnZ2V0Vmlld01vZGVsJyk7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICBVcGRhdGVzIHRoZSB2aWV3IG1vZGVsIG9ic2VydmFibGUgdmFsdWUgZnJvbSB0aGUgbW9kZWwgdmFsdWUKCiAgICBAbWV0aG9kIHVwZGF0ZV92bU9ic2VydmFibGVfZnJvbV9tVmFsdWVfZmFjdG9yeQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7a28ub2JzZXJ2YWJsZX0gb2JzZXJ2YWJsZSBUaGUgb2JzZXJ2YWJsZSB2YWx1ZSB0byBiZSB1cGRhdGVkLCBpZiByZXF1aXJlZC4KICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIHN1YnNjcmlwdGlvbiBtZXRob2QgdG8gYmUgdXNlZCB3aGVuIHVwZGF0aW5nIHRoZSBvYnNlcnZhYmxlIG9uIHRoZSB2aWV3IG1vZGVsIHNpZGUKICAgICoqLwogICAgdmFyIHVwZGF0ZV92bU9ic2VydmFibGVfZnJvbV9tVmFsdWVfZmFjdG9yeSA9IGZ1bmN0aW9uIChvYnNlcnZhYmxlKQogICAgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAocGF0aCwgdmFsKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc0VxdWFsKG9ic2VydmFibGUoKSwgdmFsKSkgb2JzZXJ2YWJsZSh2YWwpOwogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgVXBkYXRlcyB0aGUgdmlldyBtb2RlbCBvYnNlcnZhYmxlIHZhbHVlIGZyb20gdGhlIG1vZGVsIHZhbHVlCgogICAgQG1ldGhvZCB1cGRhdGVfbVZhbHVlX2Zyb21fdm1PYnNlcnZhYmxlX2ZhY3RvcnkKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0tub2Nrb3V0TW9kZWxCYXNlfSBtb2RlbCBUaGUgY28gbW9kZWwKICAgIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwYXRoIHRvIHRoZSBvYnNlcnZhYmxlIGFycmF5CiAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBzdWJzY3JpcHRpb24gbWV0aG9kIHRvIGJlIHVzZWQgd2hlbiB1cGRhdGluZyB0aGUgdmFsdWUgb24gdGhlIG1vZGVsIHNpZGUKICAgICoqLwogICAgdmFyIHVwZGF0ZV9tVmFsdWVfZnJvbV92bU9ic2VydmFibGVfZmFjdG9yeSA9IGZ1bmN0aW9uIChtb2RlbCwgcGF0aCkKICAgIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNFcXVhbChtb2RlbC5nZXQocGF0aCksIHZhbCkpCiAgICAgICAgICAgICAgICBtb2RlbC5zZXQocGF0aCwgdmFsKTsKICAgICAgICB9OwogICAgfTsKCiAgICBLbm9ja291dFZpZXdNb2RlbEJhc2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gS25vY2tvdXRWaWV3TW9kZWxCYXNlOwogICAgS25vY2tvdXRWaWV3TW9kZWxCYXNlLmV4dGVuZCA9IEtub2Nrb3V0TW9kZWxCYXNlLmV4dGVuZDsKCiAgICByZXR1cm4gS25vY2tvdXRWaWV3TW9kZWxCYXNlOwp9KTsKCmRlZmluZSgna29iLW1vZGVsL3NpbXBsZS92aWV3bW9kZWwnLFsnLi4vdmlld21vZGVsLmJhc2UnXSwKZnVuY3Rpb24gKEtub2Nrb3V0Vmlld01vZGVsQmFzZSkKewogICAgdmFyIFNpbXBsZUtub2Nrb3V0Vmlld01vZGVsID0gS25vY2tvdXRWaWV3TW9kZWxCYXNlLmV4dGVuZCh7CiAgICAgICAgZ2V0UHJvcGVydGllczogZnVuY3Rpb24gKGF0dHJzKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgICAgIH0sCiAgICB9KTsKICAgIFNpbXBsZUtub2Nrb3V0Vmlld01vZGVsLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFNpbXBsZUtub2Nrb3V0Vmlld01vZGVsOwoKICAgIHJldHVybiBTaW1wbGVLbm9ja291dFZpZXdNb2RlbDsKfSk7CgpkZWZpbmUoJ2tvYi1tb2RlbC9lcnJvcnMuYmFzZScsWydiYWNrYm9uZScsICdsb2Rhc2gnLCAna25vY2tvdXQnXSwKZnVuY3Rpb24oQmFja2JvbmUsIF8sIGtvKQp7CiAgICB2YXIgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLAogICAgICAgIGlzQXJyYXkgPSBfLmlzQXJyYXksCiAgICAgICAgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCiAgICAvKgogICAgICAgIERlZmF1bHQgZXh0ZW5kZXIgZm9yIGVycm9ycywgYWxsb3dzIGZvciBiZXR0ZXIgb3ZlcmFsbCBwZXJmb3JtYW5jZSBpbiBkZXRlY3RpbmcgaWYgdGhlcmUgYXJlIGVycm9ycy4KICAgICovCiAgICBrby5leHRlbmRlcnNbJ2Vycm9ycyddID0gZnVuY3Rpb24gKHRhcmdldCkKICAgIHsKICAgICAgICB2YXIgaGFzRXJyb3JzID0gdGFyZ2V0Lmhhc0Vycm9ycyA9IGtvLm9ic2VydmFibGUoZmFsc2UpOwogICAgICAgIHRhcmdldC5zdWJzY3JpYmUoZnVuY3Rpb24gKHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgdGFyZ2V0Lmhhc0Vycm9ycyghISh2YWx1ZSAmJiB2YWx1ZS5sZW5ndGgpKTsKICAgICAgICB9KTsKICAgIH07CgogICAgdmFyIEVycm9yQ29udGFpbmVyQmFzZSA9IGZ1bmN0aW9uIChwYXJlbnQpCiAgICB7CiAgICAgICAgdGhpcy5oYXNoID0gewogICAgICAgICAgICBzdW1tYXJ5OiBrby5vYnNlcnZhYmxlKCkKICAgICAgICB9OwogICAgICAgIHRoaXMuaGFzaC5zdW1tYXJ5LmV4dGVuZCh7IGVycm9yczogdHJ1ZSB9KTsKICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgIH07CgogICAgdmFyIGhhbmRsZUFkZE1lc3NhZ2VBcnJheSA9IGZ1bmN0aW9uIChjb250YWluZXIsIHBhdGgsIG1lc3NhZ2UsIHR5cGUpCiAgICB7CiAgICAgICAgaWYgKGlzQXJyYXkobWVzc2FnZSkpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciB6ID0gMCwgekxlbiA9IG1lc3NhZ2UubGVuZ3RoOyB6IDwgekxlbjsgeisrKQogICAgICAgICAgICAgICAgdGhpcy5hZGRNZXNzYWdlKHBhdGgsIG1lc3NhZ2Vbel0sIHR5cGUpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFkZE1lc3NhZ2UocGF0aCwgbWVzc2FnZSwgdHlwZSk7CiAgICAgICAgfQogICAgfTsKCiAgICBFcnJvckNvbnRhaW5lckJhc2UucHJvdG90eXBlID0gewogICAgICAgIGdldFByb3BlcnR5OiBmdW5jdGlvbiAob2JqLCBwYXRoKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsKICAgICAgICB9LAogICAgICAgIHNldFByb3BlcnR5OiBmdW5jdGlvbiAob2JqLCBwYXRoLCB2YWx1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTllJJyk7CiAgICAgICAgfSwKICAgICAgICBnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihvYmopCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05ZSScpOwogICAgICAgIH0sCiAgICAgICAgYWRkTWVzc2FnZXM6IGZ1bmN0aW9uIChwcm9wZXJ0eVBhdGgsIGVycm9yc0NvbGxlY3Rpb24sIHR5cGUpCiAgICAgICAgewogICAgICAgICAgICBpZiAoaXNTdHJpbmcocHJvcGVydHlQYXRoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaGFuZGxlQWRkTWVzc2FnZUFycmF5KHRoaXMsIHByb3BlcnR5UGF0aCwgZXJyb3JzQ29sbGVjdGlvbiwgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0eXBlID0gZXJyb3JzQ29sbGVjdGlvbjsKICAgICAgICAgICAgICAgIGVycm9yc0NvbGxlY3Rpb24gPSBwcm9wZXJ0eVBhdGg7CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiB0aGlzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbCh0aGlzLCBpKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gdGhpc1tpXS5lcnJvcnM7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUFkZE1lc3NhZ2VBcnJheSh0aGlzLCBpLCBtZXNzYWdlLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGdldEVycm9yT2JzZXJ2YWJsZTogZnVuY3Rpb24gKHByb3BlcnR5UGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFByb3BlcnR5KHRoaXMuaGFzaCwgcHJvcGVydHlQYXRoKTsKICAgICAgICB9LAogICAgICAgIGNyZWF0ZUVycm9yT2JzZXJ2YWJsZTogZnVuY3Rpb24gKHByb3BlcnR5UGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBvYnNlcnZhYmxlQXJyYXkgPSBrby5vYnNlcnZhYmxlQXJyYXkoW10pOwogICAgICAgICAgICB0aGlzLnNldFByb3BlcnR5KHRoaXMuaGFzaCwgcHJvcGVydHlQYXRoLCBvYnNlcnZhYmxlQXJyYXkpOwogICAgICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZUFycmF5OwogICAgICAgIH0sCiAgICAgICAgZ2V0T3JDcmVhdGVFcnJvck9ic2VydmFibGU6IGZ1bmN0aW9uIChwcm9wZXJ0eVBhdGgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgb2JzZXJ2YWJsZUFycmF5ID0gdGhpcy5nZXRFcnJvck9ic2VydmFibGUocHJvcGVydHlQYXRoKTsKICAgICAgICAgICAgaWYgKCFvYnNlcnZhYmxlQXJyYXkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9ic2VydmFibGVBcnJheSA9IHRoaXMuY3JlYXRlRXJyb3JPYnNlcnZhYmxlKHByb3BlcnR5UGF0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG9ic2VydmFibGVBcnJheTsKICAgICAgICB9LAogICAgICAgIGFkZE1lc3NhZ2U6IGZ1bmN0aW9uIChwcm9wZXJ0eVBhdGgsIG1lc3NhZ2UsIHR5cGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgLy8gTmVlZHMgdG8gYmUgY29uZmlndXJhYmxlIGluIHRoZSBjYXNlIG9mIGEgc2hhcmVkIHByZWZpeCBtb2RlbCBpdGVtLi4uLj8/CiAgICAgICAgICAgICAgICAvL2Vycm9ycyA9IHRoaXNbcGF0aF0gfHwgdGhpc1twYXRoICsgdmFsdWVLb1BhdGhdLAogICAgICAgICAgICAgICAgZXJyb3JzID0gdGhpcy5nZXRPckNyZWF0ZUVycm9yT2JzZXJ2YWJsZShwcm9wZXJ0eVBhdGgpOwoKICAgICAgICAgICAgaWYgKGVycm9ycy5fc3Vic2NyaXB0aW9ucy5jaGFuZ2UubGVuZ3RoIDwgMikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5UGF0aCA9PT0gJ3N1bW1hcnknKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50LmFkZE1lc3NhZ2UoJ3N1bW1hcnknLCBtZXNzYWdlLCB0eXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZE1lc3NhZ2UoJ3N1bW1hcnknLCBtZXNzYWdlLCB0eXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGVycm9ycygpLmV2ZXJ5KGZ1bmN0aW9uICh4KSB7IHJldHVybiB4Lm1lc3NhZ2UgIT09IG1lc3NhZ2U7IH0pKQogICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goeyBtZXNzYWdlOiBtZXNzYWdlLCB0eXBlOiB0eXBlIH0pOwogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlTWVzc2FnZXM6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgbGlzdCA9IHRoaXMuZ2V0UHJvcGVydGllcyh0aGlzLmhhc2gpOwogICAgICAgICAgICBmb3IgKHZhciBpIGluIGxpc3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvcnMgPSBsaXN0W2ldOwogICAgICAgICAgICAgICAgZXJyb3JzICYmIGVycm9ycy5zcGxpY2UoMCwgZXJyb3JzKCkubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlTWVzc2FnZTogZnVuY3Rpb24gKHByb3BlcnR5UGF0aCwgbWVzc2FnZSwgdHlwZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciAvLyBOZWVkcyB0byBiZSBjb25maWd1cmFibGUgaW4gdGhlIGNhc2Ugb2YgYSBzaGFyZWQgcHJlZml4IG1vZGVsIGl0ZW0uLi4uPz8KICAgICAgICAgICAgICAgIC8vZXJyb3JzID0gdGhpc1twYXRoXSB8fCB0aGlzW3BhdGggKyB2YWx1ZUtvUGF0aF0sCiAgICAgICAgICAgICAgICBlcnJvcnNPYnNlcnZhYmxlID0gdGhpcy5nZXRPckNyZWF0ZUVycm9yT2JzZXJ2YWJsZShwcm9wZXJ0eVBhdGgpOwoKICAgICAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IGVycm9yc09ic2VydmFibGUoKTsKICAgICAgICAgICAgaWYgKHVuZGVybHlpbmdBcnJheS5sZW5ndGggPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gdW5kZXJseWluZ0FycmF5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh1bmRlcmx5aW5nQXJyYXlbaV0ubWVzc2FnZSA9PT0gbWVzc2FnZSB8fCAoIW1lc3NhZ2UgJiYgdW5kZXJseWluZ0FycmF5W2ldLnR5cGUgPT0gdHlwZSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnNPYnNlcnZhYmxlLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBnZXRNZXNzYWdlczogZnVuY3Rpb24gKHByb3BlcnR5UGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2V0RXJyb3JPYnNlcnZhYmxlKHByb3BlcnR5UGF0aCk7CiAgICAgICAgfQogICAgfTsKCiAgICBFcnJvckNvbnRhaW5lckJhc2UuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwoKICAgIHJldHVybiBFcnJvckNvbnRhaW5lckJhc2U7Cn0pOwpkZWZpbmUoJ2tvYi1tb2RlbC9zaW1wbGUvZXJyb3JzJyxbJy4uL2Vycm9ycy5iYXNlJ10sCmZ1bmN0aW9uIChFcnJvckNvbnRhaW5lckJhc2UpCnsKICAgIHZhciBTaW1wbGVFcnJvckNvbnRhaW5lciA9IEVycm9yQ29udGFpbmVyQmFzZS5leHRlbmQoewogICAgICAgIGdldFByb3BlcnR5OiBmdW5jdGlvbiAob2JqLCBwYXRoKSB7IHJldHVybiBvYmpbcGF0aF07IH0sCiAgICAgICAgc2V0UHJvcGVydHk6IGZ1bmN0aW9uIChvYmosIHBhdGgsIHZhbHVlKSB7IHJldHVybiAob2JqW3BhdGhdID0gdmFsdWUpOyB9LAogICAgICAgIGdldFByb3BlcnRpZXM6IGZ1bmN0aW9uIChvYmopIHsgcmV0dXJuIG9iajsgfQogICAgfSk7CgogICAgcmV0dXJuIFNpbXBsZUVycm9yQ29udGFpbmVyOwp9KTsKZGVmaW5lKCdrb2ItbW9kZWwvc2ltcGxlL21vZGVsJyxbCiAgICAnLi4vbW9kZWwuYmFzZScsCiAgICAnLi92aWV3bW9kZWwnLAogICAgJ2xvZGFzaCcsCiAgICAnLi9lcnJvcnMnLAogICAgJy4uL3V0aWwnCl0sCmZ1bmN0aW9uIChLbm9ja291dE1vZGVsQmFzZSwgU2ltcGxlS25vY2tvdXRWaWV3TW9kZWwsIF8sIEVycm9ycywgdXRpbCkKewogICAgCgogICAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuCiAgICB2YXIgU2ltcGxlS25vY2tvdXRNb2RlbCA9IEtub2Nrb3V0TW9kZWxCYXNlLmV4dGVuZCh7CiAgICAgICAgX19kZWVwQ2xvbmU6IGZ1bmN0aW9uKG9iaikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBfLmNsb25lKG9iaik7CiAgICAgICAgfSwKICAgICAgICBfX3Byb3BlcnR5OgogICAgICAgIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAob2JqLCBwYXRoKSB7IHJldHVybiBvYmpbcGF0aF07IH0sCiAgICAgICAgICAgIGhhczogZnVuY3Rpb24gKG9iaiwgcGF0aCkgeyByZXR1cm4gISFvYmpbcGF0aF07IH0sCiAgICAgICAgICAgIGdldFBhcmVudDogZnVuY3Rpb24gKG9iaiwgcGF0aCkgeyByZXR1cm4gb2JqOyB9LAogICAgICAgICAgICBsYXN0OiBmdW5jdGlvbiAob2JqLCBwYXRoKSB7IHJldHVybiBwYXRoOyB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChvYmosIHBhdGgsIHZhbHVlKSB7IHJldHVybiAob2JqW3BhdGhdID0gdmFsdWUpOyB9LAogICAgICAgICAgICBkZWw6IGZ1bmN0aW9uIChvYmosIHBhdGgpIHsgZGVsZXRlIG9ialtwYXRoXTsgfSwKICAgICAgICAgICAgYnVpbGQ6IGZ1bmN0aW9uIChvYmosIHBhdGgpIHsgcmV0dXJuIG9iajsgfSwKICAgICAgICAgICAgZ2V0UHJvcGVydGllczogZnVuY3Rpb24gKG9iaiwgbGVhZnMsIHByZWZpeCkgeyByZXR1cm4gb2JqOyB9LAogICAgICAgICAgICBmaW5kQWxsQ2hhbmdlZFByb3BlcnRpZXM6IHV0aWwuZmluZEFsbENoYW5nZWRQcm9wZXJ0aWVzCiAgICAgICAgfSwKICAgICAgICBfX2J1aWxkRXJyb3JNZXNzYWdlczogZnVuY3Rpb24gKHBhcmVudCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBuZXcgRXJyb3JzKHBhcmVudCAmJiBwYXJlbnQuZXJyb3JNZXNzYWdlcyk7CiAgICAgICAgfSwKICAgICAgICB2aWV3TW9kZWxDb25zdHJ1Y3RvcjogU2ltcGxlS25vY2tvdXRWaWV3TW9kZWwKICAgIH0pOwoKICAgIC8vU2ltcGxlS25vY2tvdXRNb2RlbC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBTaW1wbGVLbm9ja291dE1vZGVsOwoKICAgIHJldHVybiBTaW1wbGVLbm9ja291dE1vZGVsOwp9KTsKCmRlZmluZSgna29iLW1vZGVsL3NpbXBsZS9tYWluJyxbJy4vbW9kZWwnLCAnLi92aWV3bW9kZWwnXSwKZnVuY3Rpb24gKFNpbXBsZUtub2Nrb3V0TW9kZWwsIFNpbXBsZUtub2Nrb3V0Vmlld01vZGVsKQp7CiAgICByZXR1cm4gewogICAgICAgIE1vZGVsOiBTaW1wbGVLbm9ja291dE1vZGVsLAogICAgICAgIFZpZXdNb2RlbDogU2ltcGxlS25vY2tvdXRWaWV3TW9kZWwKICAgIH07Cn0pOwpkZWZpbmUoJ2tvYi1tb2RlbC9zaW1wbGUnLCBbJ2tvYi1tb2RlbC9zaW1wbGUvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ2tvYi1tb2RlbC9jb21wbGV4L3Byb3BlcnR5LmhlbHBlcnMnLFsnbG9kYXNoJywgJ2tub2Nrb3V0JywgJy4uL3V0aWwnXSwKZnVuY3Rpb24gKF8sIGtvLCB1dGlsKQp7CiAgICB2YXIgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKICAgICAgICBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLAogICAgICAgIHVud3JhcE9ic2VydmFibGUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlLAogICAgICAgIGlzT2JqZWN0ID0gXy5pc09iamVjdCwKICAgICAgICBpc0FycmF5ID0gXy5pc0FycmF5LAogICAgICAgIHByb3BlcnR5T2JqZWN0Q2FjaGUgPSB7fSwKICAgICAgICBfX2tvUGF0aE1hcCA9IHt9LAogICAgICAgIF9fcHJvcFBhdGhNYXAgPSB7fSwKICAgICAgICBpc0ZvcmNlZE9iamVjdCA9IHV0aWwuaXNGb3JjZWRPYmplY3QsCiAgICAgICAgc3F1YXJlQnJhY2tldFJlZ2V4ID0gL1xbKC4qPylcXS9pZywKICAgICAgICBkb3RSZWdleCA9IC9cLi9nLAogICAgICAgIGNvbW1hUmVnZXggPSAvLC9nLAogICAgICAgIHVuZGVyc2NvcmVSZWdleCA9IC9fL2csCiAgICAgICAgY29tcGxleFJlcGxhY21lbnRNZXRob2QgPSBmdW5jdGlvbiAobSwgdikgeyByZXR1cm4gJy4nICsgdi5yZXBsYWNlKGRvdFJlZ2V4LCAnLCcpOyB9LAogICAgICAgIGdldFBhdGhzID0gZnVuY3Rpb24gKHBhdGgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcGF0aHMgPSBwYXRoLnJlcGxhY2Uoc3F1YXJlQnJhY2tldFJlZ2V4LCBjb21wbGV4UmVwbGFjbWVudE1ldGhvZCkuc3BsaXQoJy4nKTsKICAgICAgICAgICAgaWYgKHBhdGhzWzBdID09IG51bGwgfHwgcGF0aHNbMF0gPT09ICcnKQogICAgICAgICAgICAgICAgcGF0aHMuc2hpZnQoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBwYXRocy5sZW5ndGg7IGkgPCBpTGVuIDsgaSsrKQogICAgICAgICAgICAgICAgcGF0aHNbaV0gPSBwYXRoc1tpXS5yZXBsYWNlKGNvbW1hUmVnZXgsICcuJyk7CiAgICAgICAgICAgIHJldHVybiBwYXRoczsKICAgICAgICB9LAogICAgICAgIGdldFN0cmljdFBhdGggPSBmdW5jdGlvbiAocGF0aHMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gJ1snICsgcGF0aHMuam9pbignXVsnKSArICddJzsKICAgICAgICB9LAogICAgICAgIGdldFBhdGhBbmREcm9wID0gZnVuY3Rpb24gKHBhdGgsIGRyb3ApCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGRyb3AgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICAgICAgZHJvcCA9IDE7CgogICAgICAgICAgICB2YXIgcGF0aHMgPSBnZXRQYXRocyhwYXRoKTsKICAgICAgICAgICAgcGF0aHMgPSBwYXRocy5zbGljZSgwLCAtKGRyb3ApKTsKCiAgICAgICAgICAgIHJldHVybiBnZXRTdHJpY3RQYXRoKHBhdGhzKTsKICAgICAgICB9OwoKICAgIHZhciBuYXZpZ2F0ZU9iamVjdCA9IGZ1bmN0aW9uIChvYmosIHBhdGgpCiAgICB7CiAgICAgICAgdmFyIHBhdGhzID0gZ2V0UGF0aHMocGF0aCksIG1hdGNoID0gZmFsc2UsCiAgICAgICAgICAgIHBhdGhNYXRjaCA9ICcnOwoKICAgICAgICB3aGlsZSAob2JqICYmIChwYXRoID0gcGF0aHMuc2hpZnQoKSkpCiAgICAgICAgewogICAgICAgICAgICBpZiAocGF0aCBpbiBvYmogJiYgKChtYXRjaCA9IHRydWUpKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb2JqID0gb2JqW3BhdGhdOwogICAgICAgICAgICAgICAgcGF0aE1hdGNoID0gcGF0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICgoIShtYXRjaCA9IGZhbHNlKSkgJiYgcGF0aHMubGVuZ3RoID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcGF0aHMudW5zaGlmdChwYXRoICsgJy4nICsgcGF0aHMuc2hpZnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAocGF0aHMubGVuZ3RoID09PSAwICYmIG1hdGNoID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcGF0aE1hdGNoID0gcGF0aDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgbWF0Y2g6IG1hdGNoLCBvYmo6IG9iaiwgcGF0aE1hdGNoOiBwYXRoTWF0Y2ggfTsKICAgIH07CgogICAgdmFyIHByb3BlcnR5ID0gewogICAgICAgIG5hdmlnYXRlT2JqZWN0OiBuYXZpZ2F0ZU9iamVjdCwKICAgICAgICBnZXRQYXRoczogZ2V0UGF0aHMsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAob2JqLCBwYXRoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG5hdmlnYXRlT2JqZWN0KG9iaiwgcGF0aCk7CgogICAgICAgICAgICByZXR1cm4gKHJlc3VsdC5tYXRjaCA/IHJlc3VsdC5vYmogOiBmYWxzZSk7CiAgICAgICAgfSwKICAgICAgICBoYXM6IGZ1bmN0aW9uIChvYmosIHBhdGgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gbmF2aWdhdGVPYmplY3Qob2JqLCBwYXRoKTsKCiAgICAgICAgICAgIHJldHVybiByZXN1bHQubWF0Y2g7CiAgICAgICAgfSwKICAgICAgICBnZXRQYXJlbnQ6IGZ1bmN0aW9uIChvYmosIHBhdGgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcGF0aCA9IGdldFBhdGhBbmREcm9wKHBhdGgsIDEpOwoKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG5hdmlnYXRlT2JqZWN0KG9iaiwgcGF0aCk7CgogICAgICAgICAgICByZXR1cm4gcmVzdWx0Lm9iajsKICAgICAgICB9LAogICAgICAgIGxhc3Q6IGZ1bmN0aW9uIChvYmosIHBhdGgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gbmF2aWdhdGVPYmplY3Qob2JqLCBwYXRoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wYXRoTWF0Y2g7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChvYmosIHBhdGgsIHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5idWlsZChvYmosIHBhdGgpW3RoaXMubGFzdChvYmosIHBhdGgpXSA9IHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgZGVsOiBmdW5jdGlvbihvYmosIHBhdGgpCiAgICAgICAgewogICAgICAgICAgICBkZWxldGUgdGhpcy5idWlsZChvYmosIHBhdGgpW3RoaXMubGFzdChvYmosIHBhdGgpXTsKICAgICAgICB9LAogICAgICAgIC8qY29weTogZnVuY3Rpb24gKGZyb20sIHRvLCBwYXRoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zZXQodG8sIHBhdGgsIHRoaXMuZ2V0KGZyb20sIHBhdGgpKTsKICAgICAgICB9LCovCiAgICAgICAgYnVpbGQ6IGZ1bmN0aW9uIChvYmosIHBhdGgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcGF0aHMgPSBnZXRQYXRocyhnZXRQYXRoQW5kRHJvcChwYXRoLCAxKSk7CgogICAgICAgICAgICBpZiAoIXRoaXMuaGFzKG9iaiwgcGF0aCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdoaWxlIChwYXRoID0gcGF0aHMuc2hpZnQoKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIW9ialtwYXRoXSkKICAgICAgICAgICAgICAgICAgICAgICAgb2JqW3BhdGhdID0ge307CiAgICAgICAgICAgICAgICAgICAgb2JqID0gb2JqW3BhdGhdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFBhcmVudChvYmosIHBhdGgpOwogICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgIH0sCiAgICAgICAgZ2V0QWxsTGVhZnM6IGZ1bmN0aW9uIChvYmosIGxlYWZzLCBwcmVmaXgpCiAgICAgICAgewogICAgICAgICAgICBsZWFmcyA9IGxlYWZzIHx8IHt9OwogICAgICAgICAgICBmb3IgKHZhciBpIGluIG9iaikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG8gPSB1bndyYXBPYnNlcnZhYmxlKG9ialtpXSksIHAgPSBpOwoKICAgICAgICAgICAgICAgIGlmIChpLmluZGV4T2YoJy4nKSA+IC0xKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHAgPSAocHJlZml4IHx8ICcnKSArICdbJyArIGkgKyAnXSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcCA9IHByZWZpeCA/IHByZWZpeCArICcuJyArIGkgOiBpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChpc0ZvcmNlZE9iamVjdChpKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWxlYWZzW3ByZWZpeF0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxlYWZzW3ByZWZpeF0gPSB7fTsKICAgICAgICAgICAgICAgICAgICBsZWFmc1twcmVmaXhdW2ldID0gdGhpcy5nZXRBbGxMZWFmcyhvKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFpc0FycmF5KG8pICYmIGlzT2JqZWN0KG8pKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0QWxsTGVhZnMobywgbGVhZnMsIHApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNBcnJheShvKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBsZWFmc1twXSA9IG87CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbGVhZnNbcF0gPSBvOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWFmczsKICAgICAgICB9LAogICAgICAgIGZpbmRBbGxDaGFuZ2VkUHJvcGVydGllczogdXRpbC5maW5kQWxsQ2hhbmdlZFByb3BlcnRpZXMKICAgIH07CgogICAgcmV0dXJuIHByb3BlcnR5Owp9KTsKZGVmaW5lKCdrb2ItbW9kZWwvY29tcGxleC92aWV3bW9kZWwnLFsnLi4vdmlld21vZGVsLmJhc2UnLCAnLi9wcm9wZXJ0eS5oZWxwZXJzJ10sCmZ1bmN0aW9uIChLbm9ja291dFZpZXdNb2RlbEJhc2UsIHByb3BlcnR5SGVscGVycykKewogICAgdmFyIENvbXBsZXhLbm9ja291dFZpZXdNb2RlbCA9IEtub2Nrb3V0Vmlld01vZGVsQmFzZS5leHRlbmQoewogICAgICAgIGdldFByb3BlcnRpZXM6IGZ1bmN0aW9uIChhdHRycykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUhlbHBlcnMuZ2V0QWxsTGVhZnMoYXR0cnMpOwogICAgICAgIH0KICAgIH0pOwogICAgQ29tcGxleEtub2Nrb3V0Vmlld01vZGVsLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvbXBsZXhLbm9ja291dFZpZXdNb2RlbDsKCiAgICByZXR1cm4gQ29tcGxleEtub2Nrb3V0Vmlld01vZGVsOwp9KTsKCmRlZmluZSgna29iLW1vZGVsL2NvbXBsZXgvZXJyb3JzJyxbJy4uL2Vycm9ycy5iYXNlJywgJy4vcHJvcGVydHkuaGVscGVycyddLApmdW5jdGlvbiAoRXJyb3JDb250YWluZXJCYXNlLCBwcm9wZXJ0eUhlbHBlcnMpCnsKICAgIHZhciBDb21wbGV4RXJyb3JDb250YWluZXIgPSBFcnJvckNvbnRhaW5lckJhc2UuZXh0ZW5kKHsKICAgICAgICBnZXRQcm9wZXJ0eTogcHJvcGVydHlIZWxwZXJzLmdldCwKICAgICAgICBzZXRQcm9wZXJ0eTogcHJvcGVydHlIZWxwZXJzLnNldCwKICAgICAgICBnZXRQcm9wZXJ0aWVzOiBwcm9wZXJ0eUhlbHBlcnMuZ2V0QWxsTGVhZnMKICAgIH0pOwoKICAgIHJldHVybiBDb21wbGV4RXJyb3JDb250YWluZXI7Cn0pOwpkZWZpbmUoJ2tvYi1tb2RlbC9jb21wbGV4L21vZGVsJyxbCiAgICAnLi4vbW9kZWwuYmFzZScsCiAgICAnLi9wcm9wZXJ0eS5oZWxwZXJzJywKICAgICcuL3ZpZXdtb2RlbCcsCiAgICAnbG9kYXNoJywKICAgICcuL2Vycm9ycycsCiAgICAnLi4vdXRpbCcKXSwKZnVuY3Rpb24gKEtub2Nrb3V0TW9kZWxCYXNlLCBwcm9wZXJ0eUhlbHBlcnMsIENvbXBsZXhLbm9ja291dFZpZXdNb2RlbCwgXywgRXJyb3JzLCB1dGlsKQp7CiAgICAKCiAgICB2YXIgZGVlcENsb25lID0gdXRpbC5kZWVwQ2xvbmU7CiAgICAKICAgIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogICAgdmFyIENvbXBsZXhLbm9ja291dE1vZGVsID0gS25vY2tvdXRNb2RlbEJhc2UuZXh0ZW5kKHsKICAgICAgICBfX2RlZXBDbG9uZTogZnVuY3Rpb24ob2JqKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlZXBDbG9uZShvYmopOwogICAgICAgIH0sCiAgICAgICAgX19wcm9wZXJ0eToKICAgICAgICB7CiAgICAgICAgICAgIGdldDogcHJvcGVydHlIZWxwZXJzLmdldCwKICAgICAgICAgICAgaGFzOiBwcm9wZXJ0eUhlbHBlcnMuaGFzLAogICAgICAgICAgICBnZXRQYXJlbnQ6IHByb3BlcnR5SGVscGVycy5nZXRQYXJlbnQsCiAgICAgICAgICAgIGxhc3Q6IHByb3BlcnR5SGVscGVycy5sYXN0LAogICAgICAgICAgICBzZXQ6IHByb3BlcnR5SGVscGVycy5zZXQsCiAgICAgICAgICAgIGRlbDogcHJvcGVydHlIZWxwZXJzLmRlbCwKICAgICAgICAgICAgYnVpbGQ6IHByb3BlcnR5SGVscGVycy5idWlsZCwKICAgICAgICAgICAgZ2V0UHJvcGVydGllczogZnVuY3Rpb24gKCkgeyByZXR1cm4gcHJvcGVydHlIZWxwZXJzLmdldEFsbExlYWZzLmFwcGx5KHByb3BlcnR5SGVscGVycywgYXJndW1lbnRzKTsgfSwKICAgICAgICAgICAgZmluZEFsbENoYW5nZWRQcm9wZXJ0aWVzOiBwcm9wZXJ0eUhlbHBlcnMuZmluZEFsbENoYW5nZWRQcm9wZXJ0aWVzCiAgICAgICAgfSwKICAgICAgICBfX2J1aWxkRXJyb3JNZXNzYWdlczogZnVuY3Rpb24gKHBhcmVudCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBuZXcgRXJyb3JzKHBhcmVudCAmJiBwYXJlbnQuZXJyb3JNZXNzYWdlcyk7CiAgICAgICAgfSwKICAgICAgICB2aWV3TW9kZWxDb25zdHJ1Y3RvcjogQ29tcGxleEtub2Nrb3V0Vmlld01vZGVsCiAgICB9KTsKCiAgICAvL0NvbXBsZXhLbm9ja291dE1vZGVsLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvbXBsZXhLbm9ja291dE1vZGVsOwoKICAgIHJldHVybiBDb21wbGV4S25vY2tvdXRNb2RlbDsKfSk7CgpkZWZpbmUoJ2tvYi1tb2RlbC9jb21wbGV4L21haW4nLFsnLi9tb2RlbCcsICcuL3ZpZXdtb2RlbCddLApmdW5jdGlvbiAoQ29tcGxleEtub2Nrb3V0TW9kZWwsIENvbXBsZXhLbm9ja291dFZpZXdNb2RlbCkKewogICAgcmV0dXJuIHsKICAgICAgICBNb2RlbDogQ29tcGxleEtub2Nrb3V0TW9kZWwsCiAgICAgICAgVmlld01vZGVsOiBDb21wbGV4S25vY2tvdXRWaWV3TW9kZWwKICAgIH07Cn0pOwpkZWZpbmUoJ2tvYi1tb2RlbC9jb21wbGV4JywgWydrb2ItbW9kZWwvY29tcGxleC9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgna29iLW1vZGVsL21haW4nLFsna29iLW1vZGVsL3NpbXBsZScsICdrb2ItbW9kZWwvY29tcGxleCddLApmdW5jdGlvbiAoU2ltcGxlLCBDb21wbGV4KQp7CiAgICByZXR1cm4gewogICAgICAgIFNpbXBsZUtub2Nrb3V0TW9kZWw6IFNpbXBsZS5Nb2RlbCwKICAgICAgICBDb21wbGV4S25vY2tvdXRNb2RlbDogQ29tcGxleC5Nb2RlbCwKICAgICAgICBTaW1wbGVLbm9ja291dFZpZXdNb2RlbDogU2ltcGxlLlZpZXdNb2RlbCwKICAgICAgICBDb21wbGV4S25vY2tvdXRWaWV3TW9kZWw6IENvbXBsZXguVmlld01vZGVsCiAgICB9Owp9KTsKZGVmaW5lKCdrb2ItbW9kZWwnLCBbJ2tvYi1tb2RlbC9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgnYWNjb3VudC5jb250cm9scy9hY2NvdW50LmNvbnRyb2xzJyxbJ2tvYi1tb2RlbCcsICd0aHJ1c3QvdXRpbCddLApmdW5jdGlvbihLbm9ja291dEJhY2tib25lLCB1dGlsKQp7CiAgICB2YXIgYWNjb3VudERhdGFQcm9taXNlLAogICAgICAgIHdoZW4gPSB1dGlsLndoZW47CgogICAgcmV0dXJuIHsKICAgICAgICB0ZW1wbGF0ZXM6IFsKICAgICAgICAgICAgJ2FjdGlvbmxpbmsnLAogICAgICAgICAgICAnYWNjb3VudC5jb250cm9scy9hY2NvdW50LmNvbnRyb2xzJwogICAgICAgIF0sCiAgICAgICAgY29udGV4dDogJyN1c2VyLWNvbnRyb2xzJywKICAgICAgICBhdXRvU3RhcnQ6IHRydWUsCiAgICAgICAgaW5pdDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIEdldCBvdXIgZGF0YSBmcm9tIHRoZSBzZXJ2ZXIgb3Igc2VydmljZS4KICAgICAgICAgICAgYWNjb3VudERhdGFQcm9taXNlID0gdGhpcy5kYXRhLmdldCgnYWNjb3VudC5jb250cm9scy9hY2NvdW50LmNvbnRyb2xzLmpzb24nKQogICAgICAgICAgICAgICAgLnRoZW4od2hlbi5hcHBseSh0aGlzLmJ1aWxkTW9kZWwuYmluZCh0aGlzKSkpOwogICAgICAgIH0sCiAgICAgICAgYnVpbGRNb2RlbDogZnVuY3Rpb24oZGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBuZXcgS25vY2tvdXRCYWNrYm9uZS5TaW1wbGVLbm9ja291dE1vZGVsKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZGVzdHJveTogdXRpbC5ub29wLAogICAgICAgIHN0YXJ0OiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICB9LAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy4kKCkuYWRkQ2xhc3MoJ2J0bi1ncm91cCBwdWxsLXJpZ2h0Jyk7CiAgICAgICAgICAgIHRoaXMuJCgpLmh0bWwodGhpcy50ZW1wbGF0ZXNbJ2FjY291bnQuY29udHJvbHMvYWNjb3VudC5jb250cm9scyddKCkpOwogICAgICAgICAgICAvLyBIb2xkIHJlYWR5IHVudGlsIG91ciBkYXRhIGNvbWVzIGJhY2suCiAgICAgICAgICAgIHJldHVybiBhY2NvdW50RGF0YVByb21pc2UudGhlbih0aGlzLmFwcGx5QmluZGluZ3MuYmluZCh0aGlzKSk7CiAgICAgICAgfSwKICAgICAgICBhcHBseUJpbmRpbmdzOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb2RlbC5nZXRWaWV3TW9kZWwoKS5hcHBseUJpbmRpbmdzKHRoaXMuJCgpWzBdKTsKICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgIH0KICAgIH07Cn0pOwpkZWZpbmUoJ21lbnUvbWVudScsWydrb2ItbW9kZWwnLCAndGhydXN0L3V0aWwnXSwKZnVuY3Rpb24gKEtub2Nrb3V0QmFja2JvbmUsIHV0aWwpCnsKICAgIHZhciBtZW51RGF0YVByb21pc2UsCiAgICAgICAgbWVudVJlYWR5UHJvbWlzZSwKICAgICAgICB3aGVuID0gdXRpbC53aGVuOwoKICAgIHJldHVybiB7CiAgICAgICAgdGVtcGxhdGVzOiBbCiAgICAgICAgICAgICdhY3Rpb25saW5rJywKICAgICAgICAgICAgJ21lbnUvbWVudScKICAgICAgICBdLAogICAgICAgIGNvbnRleHQ6ICcjbWFpbi1tZW51JywKICAgICAgICBhdXRvU3RhcnQ6IHRydWUsCiAgICAgICAgc3Vic2NyaXB0aW9uczogewogICAgICAgICAgICAndGhydXN0L3NwYS9yb3V0ZS9ydW4nOiBmdW5jdGlvbiAocmVxdWVzdCwgcm91dGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIG1lbnVSZWFkeVByb21pc2UudGhlbihmdW5jdGlvbiAoKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoYXQuJCgpLiQoJ3VsJykKICAgICAgICAgICAgICAgICAgICAgICAgLmNoaWxkcmVuKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnYWN0aXZlJykKICAgICAgICAgICAgICAgICAgICAgICAgLmZpbmQoJ1tocmVmJD0iJyArIHJlcXVlc3QucGFyYW1zLnBhdGggKyAnIl0nKQogICAgICAgICAgICAgICAgICAgICAgICAucGFyZW50KCkuYWRkQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGluaXQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICAvLyBHZXQgb3VyIGRhdGEgZnJvbSB0aGUgc2VydmVyIG9yIHNlcnZpY2UuCiAgICAgICAgICAgIG1lbnVEYXRhUHJvbWlzZSA9IHRoaXMuZGF0YS5nZXQoJ21lbnUvbWVudS5qc29uJykKICAgICAgICAgICAgICAgIC50aGVuKHdoZW4uYXBwbHkodGhpcy5idWlsZE1vZGVsLmJpbmQodGhpcykpKTsKICAgICAgICB9LAogICAgICAgIGJ1aWxkTW9kZWw6IGZ1bmN0aW9uIChkYXRhKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb2RlbCA9IG5ldyBLbm9ja291dEJhY2tib25lLlNpbXBsZUtub2Nrb3V0TW9kZWwoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiB1dGlsLm5vb3AsCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICBtZW51UmVhZHlQcm9taXNlID0gd2hlbi5kZWZlcigpOwogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLiQoKS5hZGRDbGFzcygnbmF2LWNvbGxhcHNlJyk7CiAgICAgICAgICAgIHRoaXMuJCgpLmh0bWwodGhpcy50ZW1wbGF0ZXNbJ21lbnUvbWVudSddKCkpOwogICAgICAgICAgICAvLyBIb2xkIHJlYWR5IHVudGlsIG91ciBkYXRhIGNvbWVzIGJhY2suCiAgICAgICAgICAgIHJldHVybiBtZW51RGF0YVByb21pc2UudGhlbih0aGlzLmFwcGx5QmluZGluZ3MuYmluZCh0aGlzKSk7CiAgICAgICAgfSwKICAgICAgICBhcHBseUJpbmRpbmdzOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb2RlbC5nZXRWaWV3TW9kZWwoKS5hcHBseUJpbmRpbmdzKHRoaXMuJCgpWzBdKTsKCiAgICAgICAgICAgIG1lbnVSZWFkeVByb21pc2UucmVzb2x2ZSgpOwogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgfQogICAgfTsKfSk7Ci8vLyA8cmVmZXJlbmNlIHBhdGg9InNpZGUuanMiIC8+CmRlZmluZSgnbWVudS9zaWRlJyxbJ2tvYi1tb2RlbCcsICd0aHJ1c3QvdXRpbCddLApmdW5jdGlvbiAoS25vY2tvdXRCYWNrYm9uZSwgdXRpbCkKewogICAgdmFyIG1lbnVEYXRhUHJvbWlzZSwKICAgICAgICBtZW51UmVhZHlQcm9taXNlLAogICAgICAgIHdoZW4gPSB1dGlsLndoZW47CgogICAgcmV0dXJuIHsKICAgICAgICB0ZW1wbGF0ZXM6IFsKICAgICAgICAgICAgJ2FjdGlvbmxpbmsnLAogICAgICAgICAgICAnbWVudS9zaWRlJywKICAgICAgICAgICAgJ21lbnUvc2lkZS5oZWFkZXInCiAgICAgICAgXSwKICAgICAgICBjb250ZXh0OiAnI3NpZGUtbWVudScsCiAgICAgICAgYXV0b1N0YXJ0OiB0cnVlLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICAvLyBHZXQgb3VyIGRhdGEgZnJvbSB0aGUgc2VydmVyIG9yIHNlcnZpY2UuCiAgICAgICAgICAgIG1lbnVEYXRhUHJvbWlzZSA9IHRoaXMuZGF0YS5nZXQoJ21lbnUvc2lkZS5qc29uJykKICAgICAgICAgICAgICAgIC50aGVuKHdoZW4uYXBwbHkodGhpcy5idWlsZE1vZGVsLmJpbmQodGhpcykpKTsKICAgICAgICB9LAogICAgICAgIGJ1aWxkTW9kZWw6IGZ1bmN0aW9uIChkYXRhKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb2RlbCA9IG5ldyBLbm9ja291dEJhY2tib25lLlNpbXBsZUtub2Nrb3V0TW9kZWwoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiB1dGlsLm5vb3AsCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICBtZW51UmVhZHlQcm9taXNlID0gd2hlbi5kZWZlcigpOwogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLiQoKS5hZGRDbGFzcygnbmF2LWNvbGxhcHNlJyk7CiAgICAgICAgICAgIHRoaXMuJCgpLmh0bWwodGhpcy50ZW1wbGF0ZXNbJ21lbnUvc2lkZSddKCkpOwogICAgICAgICAgICAvLyBIb2xkIHJlYWR5IHVudGlsIG91ciBkYXRhIGNvbWVzIGJhY2suCiAgICAgICAgICAgIHJldHVybiBtZW51RGF0YVByb21pc2UudGhlbih0aGlzLmFwcGx5QmluZGluZ3MuYmluZCh0aGlzKSk7CiAgICAgICAgfSwKICAgICAgICBhcHBseUJpbmRpbmdzOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb2RlbC5nZXRWaWV3TW9kZWwoKS5hcHBseUJpbmRpbmdzKHRoaXMuJCgpWzBdKTsKCiAgICAgICAgICAgIG1lbnVSZWFkeVByb21pc2UucmVzb2x2ZSgpOwogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgfQogICAgfTsKfSk7CmRlZmluZSgncmVhZHknLFsndGhydXN0L3V0aWwnXSwKZnVuY3Rpb24gKHV0aWwpCnsKICAgIHJldHVybiB7CiAgICAgICAgc3Vic2NyaXB0aW9uczogewogICAgICAgICAgICAndGhydXN0L3JlYWR5JzogZnVuY3Rpb24gKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgdGhhdC4kKCkucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTsKICAgICAgICAgICAgfSwKICAgICAgICB9LAogICAgICAgIGNvbnRleHQ6ICdib2R5JywKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7IH0sCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgeyB9LAogICAgICAgIGF1dG9TdGFydDogdHJ1ZQogICAgfTsKfSk7",
                "body": "Ci8qIQogKiBMby1EYXNoIHYwLjQuMSA8aHR0cDovL2xvZGFzaC5jb20+CiAqIENvcHlyaWdodCAyMDEyIEpvaG4tRGF2aWQgRGFsdG9uIDxodHRwOi8vYWxseW91Y2FubGVldC5jb20vPgogKiBCYXNlZCBvbiBVbmRlcnNjb3JlLmpzIDEuMy4zLCBjb3B5cmlnaHQgMjAwOS0yMDEyIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBJbmMuCiAqIDxodHRwOi8vZG9jdW1lbnRjbG91ZC5naXRodWIuY29tL3VuZGVyc2NvcmU+CiAqIEF2YWlsYWJsZSB1bmRlciBNSVQgbGljZW5zZSA8aHR0cDovL2xvZGFzaC5jb20vbGljZW5zZT4KICovCjsoZnVuY3Rpb24od2luZG93LCB1bmRlZmluZWQpIHsKICAKCiAgLyoqCiAgICogVXNlZCB0byBjYWNoZSB0aGUgbGFzdCBgXy50ZW1wbGF0ZVNldHRpbmdzLmV2YWx1YXRlYCBkZWxpbWl0ZXIgdG8gYXZvaWQKICAgKiB1bm5lY2Vzc2FyaWx5IGFzc2lnbmluZyBgcmVFdmFsdWF0ZURlbGltaXRlcmAgYSBuZXcgZ2VuZXJhdGVkIHJlZ2V4cC4KICAgKiBBc3NpZ25lZCBpbiBgXy50ZW1wbGF0ZWAuCiAgICovCiAgdmFyIGxhc3RFdmFsdWF0ZURlbGltaXRlcjsKCiAgLyoqCiAgICogVXNlZCB0byBjYWNoZSB0aGUgbGFzdCB0ZW1wbGF0ZSBgb3B0aW9ucy52YXJpYWJsZWAgdG8gYXZvaWQgdW5uZWNlc3NhcmlseQogICAqIGFzc2lnbmluZyBgcmVEb3VibGVWYXJpYWJsZWAgYSBuZXcgZ2VuZXJhdGVkIHJlZ2V4cC4gQXNzaWduZWQgaW4gYF8udGVtcGxhdGVgLgogICAqLwogIHZhciBsYXN0VmFyaWFibGU7CgogIC8qKgogICAqIFVzZWQgdG8gbWF0Y2ggcG90ZW50aWFsbHkgaW5jb3JyZWN0IGRhdGEgb2JqZWN0IHJlZmVyZW5jZXMsIGxpa2UgYG9iai5vYmpgLAogICAqIGluIGNvbXBpbGVkIHRlbXBsYXRlcy4gQXNzaWduZWQgaW4gYF8udGVtcGxhdGVgLgogICAqLwogIHZhciByZURvdWJsZVZhcmlhYmxlOwoKICAvKioKICAgKiBVc2VkIHRvIG1hdGNoICJldmFsdWF0ZSIgZGVsaW1pdGVycywgaW5jbHVkaW5nIGludGVybmFsIGRlbGltaXRlcnMsCiAgICogaW4gdGVtcGxhdGUgdGV4dC4gQXNzaWduZWQgaW4gYF8udGVtcGxhdGVgLgogICAqLwogIHZhciByZUV2YWx1YXRlRGVsaW1pdGVyOwoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYGV4cG9ydHNgICovCiAgdmFyIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMgPT0gJ29iamVjdCcgJiYgZXhwb3J0cyAmJgogICAgKHR5cGVvZiBnbG9iYWwgPT0gJ29iamVjdCcgJiYgZ2xvYmFsICYmIGdsb2JhbCA9PSBnbG9iYWwuZ2xvYmFsICYmICh3aW5kb3cgPSBnbG9iYWwpLCBleHBvcnRzKTsKCiAgLyoqIE5hdGl2ZSBwcm90b3R5cGUgc2hvcnRjdXRzICovCiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsCiAgICAgIE9iamVjdFByb3RvID0gT2JqZWN0LnByb3RvdHlwZTsKCiAgLyoqIFVzZWQgdG8gZ2VuZXJhdGUgdW5pcXVlIElEcyAqLwogIHZhciBpZENvdW50ZXIgPSAwOwoKICAvKiogVXNlZCB0byByZXN0b3JlIHRoZSBvcmlnaW5hbCBgX2AgcmVmZXJlbmNlIGluIGBub0NvbmZsaWN0YCAqLwogIHZhciBvbGREYXNoID0gd2luZG93Ll87CgogIC8qKiBVc2VkIHRvIGRldGVjdCBkZWxpbWl0ZXIgdmFsdWVzIHRoYXQgc2hvdWxkIGJlIHByb2Nlc3NlZCBieSBgdG9rZW5pemVFdmFsdWF0ZWAgKi8KICB2YXIgcmVDb21wbGV4RGVsaW1pdGVyID0gL1stKz0hfiolJl48Pnx7KFwvXXxcW1xEfFxiKD86ZGVsZXRlfGlufGluc3RhbmNlb2Z8bmV3fHR5cGVvZnx2b2lkKVxiLzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggZW1wdHkgc3RyaW5nIGxpdGVyYWxzIGluIGNvbXBpbGVkIHRlbXBsYXRlIHNvdXJjZSAqLwogIHZhciByZUVtcHR5U3RyaW5nTGVhZGluZyA9IC9cYl9fcCBcKz0gJyc7L2csCiAgICAgIHJlRW1wdHlTdHJpbmdNaWRkbGUgPSAvXGIoX19wIFwrPSkgJycgXCsvZywKICAgICAgcmVFbXB0eVN0cmluZ1RyYWlsaW5nID0gLyhfX2VcKC4qP1wpfFxiX190XCkpIFwrXG4nJzsvZzsKCiAgLyoqIFVzZWQgdG8gaW5zZXJ0IHRoZSBkYXRhIG9iamVjdCB2YXJpYWJsZSBpbnRvIGNvbXBpbGVkIHRlbXBsYXRlIHNvdXJjZSAqLwogIHZhciByZUluc2VydFZhcmlhYmxlID0gLyg/Ol9fZXxfX3QgPSApXChccyooPyFbXGRccyInXXx0aGlzXC4pL2c7CgogIC8qKiBVc2VkIHRvIGRldGVjdCBpZiBhIG1ldGhvZCBpcyBuYXRpdmUgKi8KICB2YXIgcmVOYXRpdmUgPSBSZWdFeHAoJ14nICsKICAgIChPYmplY3RQcm90by52YWx1ZU9mICsgJycpCiAgICAgIC5yZXBsYWNlKC9bLiorP149IToke30oKXxbXF1cL1xcXS9nLCAnXFwkJicpCiAgICAgIC5yZXBsYWNlKC92YWx1ZU9mfGZvciBbXlxdXSsvZywgJy4rPycpICsgJyQnCiAgKTsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggdG9rZW5zIGluIHRlbXBsYXRlIHRleHQgKi8KICB2YXIgcmVUb2tlbiA9IC9fX3Rva2VuX18oXGQrKS9nOwoKICAvKiogVXNlZCB0byBtYXRjaCB1bmVzY2FwZWQgY2hhcmFjdGVycyBpbiBzdHJpbmdzIGZvciBpbmNsdXNpb24gaW4gSFRNTCAqLwogIHZhciByZVVuZXNjYXBlZEh0bWwgPSAvWyY8IiddL2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIHVuZXNjYXBlZCBjaGFyYWN0ZXJzIGluIGNvbXBpbGVkIHN0cmluZyBsaXRlcmFscyAqLwogIHZhciByZVVuZXNjYXBlZFN0cmluZyA9IC9bJ1xuXHJcdFx1MjAyOFx1MjAyOVxcXS9nOwoKICAvKiogVXNlZCB0byBmaXggdGhlIEpTY3JpcHQgW1tEb250RW51bV1dIGJ1ZyAqLwogIHZhciBzaGFkb3dlZCA9IFsKICAgICdjb25zdHJ1Y3RvcicsICdoYXNPd25Qcm9wZXJ0eScsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywKICAgICd0b0xvY2FsZVN0cmluZycsICd0b1N0cmluZycsICd2YWx1ZU9mJwogIF07CgogIC8qKiBVc2VkIHRvIG1ha2UgdGVtcGxhdGUgc291cmNlVVJMcyBlYXNpZXIgdG8gaWRlbnRpZnkgKi8KICB2YXIgdGVtcGxhdGVDb3VudGVyID0gMDsKCiAgLyoqIFVzZWQgdG8gcmVwbGFjZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzICovCiAgdmFyIHRva2VuID0gJ19fdG9rZW5fXyc7CgogIC8qKiBVc2VkIHRvIHN0b3JlIHRva2VuaXplZCB0ZW1wbGF0ZSB0ZXh0IHNuaXBwZXRzICovCiAgdmFyIHRva2VuaXplZCA9IFtdOwoKICAvKiogTmF0aXZlIG1ldGhvZCBzaG9ydGN1dHMgKi8KICB2YXIgY29uY2F0ID0gQXJyYXlQcm90by5jb25jYXQsCiAgICAgIGhhc093blByb3BlcnR5ID0gT2JqZWN0UHJvdG8uaGFzT3duUHJvcGVydHksCiAgICAgIHB1c2ggPSBBcnJheVByb3RvLnB1c2gsCiAgICAgIHByb3BlcnR5SXNFbnVtZXJhYmxlID0gT2JqZWN0UHJvdG8ucHJvcGVydHlJc0VudW1lcmFibGUsCiAgICAgIHNsaWNlID0gQXJyYXlQcm90by5zbGljZSwKICAgICAgdG9TdHJpbmcgPSBPYmplY3RQcm90by50b1N0cmluZzsKCiAgLyogTmF0aXZlIG1ldGhvZCBzaG9ydGN1dHMgZm9yIG1ldGhvZHMgd2l0aCB0aGUgc2FtZSBuYW1lIGFzIG90aGVyIGBsb2Rhc2hgIG1ldGhvZHMgKi8KICB2YXIgbmF0aXZlQmluZCA9IHJlTmF0aXZlLnRlc3QobmF0aXZlQmluZCA9IHNsaWNlLmJpbmQpICYmIG5hdGl2ZUJpbmQsCiAgICAgIG5hdGl2ZUlzQXJyYXkgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUlzQXJyYXkgPSBBcnJheS5pc0FycmF5KSAmJiBuYXRpdmVJc0FycmF5LAogICAgICBuYXRpdmVJc0Zpbml0ZSA9IHdpbmRvdy5pc0Zpbml0ZSwKICAgICAgbmF0aXZlS2V5cyA9IHJlTmF0aXZlLnRlc3QobmF0aXZlS2V5cyA9IE9iamVjdC5rZXlzKSAmJiBuYXRpdmVLZXlzOwoKICAvKiogYE9iamVjdCN0b1N0cmluZ2AgcmVzdWx0IHNob3J0Y3V0cyAqLwogIHZhciBhcnJheUNsYXNzID0gJ1tvYmplY3QgQXJyYXldJywKICAgICAgYm9vbENsYXNzID0gJ1tvYmplY3QgQm9vbGVhbl0nLAogICAgICBkYXRlQ2xhc3MgPSAnW29iamVjdCBEYXRlXScsCiAgICAgIGZ1bmNDbGFzcyA9ICdbb2JqZWN0IEZ1bmN0aW9uXScsCiAgICAgIG51bWJlckNsYXNzID0gJ1tvYmplY3QgTnVtYmVyXScsCiAgICAgIHJlZ2V4cENsYXNzID0gJ1tvYmplY3QgUmVnRXhwXScsCiAgICAgIHN0cmluZ0NsYXNzID0gJ1tvYmplY3QgU3RyaW5nXSc7CgogIC8qKiBUaW1lciBzaG9ydGN1dHMgKi8KICB2YXIgY2xlYXJUaW1lb3V0ID0gd2luZG93LmNsZWFyVGltZW91dCwKICAgICAgc2V0VGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0OwoKICAvKioKICAgKiBEZXRlY3QgdGhlIEpTY3JpcHQgW1tEb250RW51bV1dIGJ1ZzoKICAgKiBJbiBJRSA8IDkgYW4gb2JqZWN0cyBvd24gcHJvcGVydGllcywgc2hhZG93aW5nIG5vbi1lbnVtZXJhYmxlIG9uZXMsIGFyZQogICAqIG1hZGUgbm9uLWVudW1lcmFibGUgYXMgd2VsbC4KICAgKi8KICB2YXIgaGFzRG9udEVudW1CdWcgPSAhcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbCh7ICd2YWx1ZU9mJzogMCB9LCAndmFsdWVPZicpOwoKICAvKiogRGV0ZWN0IGlmIGBBcnJheSNzbGljZWAgY2Fubm90IGJlIHVzZWQgdG8gY29udmVydCBzdHJpbmdzIHRvIGFycmF5cyAoT3BlcmEgPCAxMC41MikgKi8KICB2YXIgbm9BcnJheVNsaWNlT25TdHJpbmdzID0gc2xpY2UuY2FsbCgneCcpWzBdICE9ICd4JzsKCiAgLyoqCiAgICogRGV0ZWN0IGxhY2sgb2Ygc3VwcG9ydCBmb3IgYWNjZXNzaW5nIHN0cmluZyBjaGFyYWN0ZXJzIGJ5IGluZGV4OgogICAqIElFIDwgOCBjYW4ndCBhY2Nlc3MgY2hhcmFjdGVycyBieSBpbmRleCBhbmQgSUUgOCBjYW4gb25seSBhY2Nlc3MKICAgKiBjaGFyYWN0ZXJzIGJ5IGluZGV4IG9uIHN0cmluZyBsaXRlcmFscy4KICAgKi8KICB2YXIgbm9DaGFyQnlJbmRleCA9ICgneCdbMF0gKyBPYmplY3QoJ3gnKVswXSkgIT0gJ3h4JzsKCiAgLyogRGV0ZWN0IGlmIGBGdW5jdGlvbiNiaW5kYCBleGlzdHMgYW5kIGlzIGluZmVycmVkIHRvIGJlIGZhc3QgKGFsbCBidXQgVjgpICovCiAgdmFyIGlzQmluZEZhc3QgPSBuYXRpdmVCaW5kICYmIC9cbnxPcGVyYS8udGVzdChuYXRpdmVCaW5kICsgdG9TdHJpbmcuY2FsbCh3aW5kb3cub3BlcmEpKTsKCiAgLyogRGV0ZWN0IGlmIGBPYmplY3Qua2V5c2AgZXhpc3RzIGFuZCBpcyBpbmZlcnJlZCB0byBiZSBmYXN0IChWOCwgT3BlcmEsIElFKSAqLwogIHZhciBpc0tleXNGYXN0ID0gbmF0aXZlS2V5cyAmJiAvXi4rJHx0cnVlLy50ZXN0KG5hdGl2ZUtleXMgKyAhIXdpbmRvdy5hdHRhY2hFdmVudCk7CgogIC8qKiBEZXRlY3QgaWYgc291cmNlVVJMIHN5bnRheCBpcyB1c2FibGUgd2l0aG91dCBlcnJvcmluZyAqLwogIHRyeSB7CiAgICAvLyBBZG9iZSdzIGFuZCBOYXJ3aGFsJ3MgSlMgZW5naW5lcyB3aWxsIGVycm9yCiAgICB2YXIgdXNlU291cmNlVVJMID0gKEZ1bmN0aW9uKCcvL0AnKSgpLCB0cnVlKTsKICB9IGNhdGNoKGUpeyB9CgogIC8qKgogICAqIFVzZWQgdG8gZXNjYXBlIGNoYXJhY3RlcnMgZm9yIGluY2x1c2lvbiBpbiBIVE1MLgogICAqIFRoZSBgPmAgYW5kIGAvYCBjaGFyYWN0ZXJzIGRvbid0IHJlcXVpcmUgZXNjYXBpbmcgaW4gSFRNTCBhbmQgaGF2ZSBubwogICAqIHNwZWNpYWwgbWVhbmluZyB1bmxlc3MgdGhleSdyZSBwYXJ0IG9mIGEgdGFnIG9yIGFuIHVucXVvdGVkIGF0dHJpYnV0ZSB2YWx1ZQogICAqIGh0dHA6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2FtYmlndW91cy1hbXBlcnNhbmRzIChzZW1pLXJlbGF0ZWQgZnVuIGZhY3QpCiAgICovCiAgdmFyIGh0bWxFc2NhcGVzID0gewogICAgJyYnOiAnJmFtcDsnLAogICAgJzwnOiAnJmx0OycsCiAgICAnIic6ICcmcXVvdDsnLAogICAgIiciOiAnJiN4Mjc7JwogIH07CgogIC8qKiBVc2VkIHRvIGRldGVybWluZSBpZiB2YWx1ZXMgYXJlIG9mIHRoZSBsYW5ndWFnZSB0eXBlIE9iamVjdCAqLwogIHZhciBvYmplY3RUeXBlcyA9IHsKICAgICdib29sZWFuJzogZmFsc2UsCiAgICAnZnVuY3Rpb24nOiB0cnVlLAogICAgJ29iamVjdCc6IHRydWUsCiAgICAnbnVtYmVyJzogZmFsc2UsCiAgICAnc3RyaW5nJzogZmFsc2UsCiAgICAndW5kZWZpbmVkJzogZmFsc2UKICB9OwoKICAvKiogVXNlZCB0byBlc2NhcGUgY2hhcmFjdGVycyBmb3IgaW5jbHVzaW9uIGluIGNvbXBpbGVkIHN0cmluZyBsaXRlcmFscyAqLwogIHZhciBzdHJpbmdFc2NhcGVzID0gewogICAgJ1xcJzogJ1xcJywKICAgICInIjogIiciLAogICAgJ1xuJzogJ24nLAogICAgJ1xyJzogJ3InLAogICAgJ1x0JzogJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBUaGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICoKICAgKiBAbmFtZSBfCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAgaW4gYSBgTG9EYXNoYCBpbnN0YW5jZS4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGEgYExvRGFzaGAgaW5zdGFuY2UuCiAgICovCiAgZnVuY3Rpb24gbG9kYXNoKHZhbHVlKSB7CiAgICAvLyBhbGxvdyBpbnZva2luZyBgbG9kYXNoYCB3aXRob3V0IHRoZSBgbmV3YCBvcGVyYXRvcgogICAgcmV0dXJuIG5ldyBMb0Rhc2godmFsdWUpOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIGBMb0Rhc2hgIGluc3RhbmNlIHRoYXQgd3JhcHMgYSB2YWx1ZSB0byBhbGxvdyBjaGFpbmluZy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAuCiAgICovCiAgZnVuY3Rpb24gTG9EYXNoKHZhbHVlKSB7CiAgICAvLyBleGl0IGVhcmx5IGlmIGFscmVhZHkgd3JhcHBlZAogICAgaWYgKHZhbHVlICYmIHZhbHVlLl93cmFwcGVkKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIHRoaXMuX3dyYXBwZWQgPSB2YWx1ZTsKICB9CgogIC8qKgogICAqIEJ5IGRlZmF1bHQsIExvLURhc2ggdXNlcyBlbWJlZGRlZCBSdWJ5IChFUkIpIHN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsCiAgICogY2hhbmdlIHRoZSBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAdHlwZSBPYmplY3QKICAgKi8KICBsb2Rhc2gudGVtcGxhdGVTZXR0aW5ncyA9IHsKCiAgICAvKioKICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gYmUgSFRNTC1lc2NhcGVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICovCiAgICAnZXNjYXBlJzogLzwlLShbXHNcU10rPyklPi9nLAoKICAgIC8qKgogICAgICogVXNlZCB0byBkZXRlY3QgY29kZSB0byBiZSBldmFsdWF0ZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgUmVnRXhwCiAgICAgKi8KICAgICdldmFsdWF0ZSc6IC88JShbXHNcU10rPyklPi9nLAoKICAgIC8qKgogICAgICogVXNlZCB0byBkZXRlY3QgYGRhdGFgIHByb3BlcnR5IHZhbHVlcyB0byBpbmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICogQHR5cGUgUmVnRXhwCiAgICAgKi8KICAgICdpbnRlcnBvbGF0ZSc6IC88JT0oW1xzXFNdKz8pJT4vZywKCiAgICAvKioKICAgICAqIFVzZWQgdG8gcmVmZXJlbmNlIHRoZSBkYXRhIG9iamVjdCBpbiB0aGUgdGVtcGxhdGUgdGV4dC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAqLwogICAgJ3ZhcmlhYmxlJzogJ29iaicKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogVGhlIHRlbXBsYXRlIHVzZWQgdG8gY3JlYXRlIGl0ZXJhdG9yIGZ1bmN0aW9ucy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmVjdH0gZGF0YSBUaGUgZGF0YSBvYmplY3QgdXNlZCB0byBwb3B1bGF0ZSB0aGUgdGV4dC4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBpbnRlcnBvbGF0ZWQgdGV4dC4KICAgKi8KICB2YXIgaXRlcmF0b3JUZW1wbGF0ZSA9IHRlbXBsYXRlKAogICAgLy8gY29uZGl0aW9uYWwgc3RyaWN0IG1vZGUKICAgJzwlIGlmICh1c2VTdHJpY3QpIHsgJT5cJ3VzZSBzdHJpY3RcJztcbjwlIH0gJT4nICsKCiAgICAvLyB0aGUgYGl0ZXJhdGVlYCBtYXkgYmUgcmVhc3NpZ25lZCBieSB0aGUgYHRvcGAgc25pcHBldAogICAgJ3ZhciBpbmRleCwgaXRlcmF0ZWUgPSA8JT0gZmlyc3RBcmcgJT4sICcgKwogICAgLy8gYXNzaWduIHRoZSBgcmVzdWx0YCB2YXJpYWJsZSBhbiBpbml0aWFsIHZhbHVlCiAgICAncmVzdWx0PCUgaWYgKGluaXQpIHsgJT4gPSA8JT0gaW5pdCAlPjwlIH0gJT47XG4nICsKICAgIC8vIGFkZCBjb2RlIHRvIGV4aXQgZWFybHkgb3IgZG8gc28gaWYgdGhlIGZpcnN0IGFyZ3VtZW50IGlzIGZhbHNleQogICAgJzwlPSBleGl0ICU+O1xuJyArCiAgICAvLyBhZGQgY29kZSBhZnRlciB0aGUgZXhpdCBzbmlwcGV0IGJ1dCBiZWZvcmUgdGhlIGl0ZXJhdGlvbiBicmFuY2hlcwogICAgJzwlPSB0b3AgJT47XG4nICsKCiAgICAvLyB0aGUgZm9sbG93aW5nIGJyYW5jaCBpcyBmb3IgaXRlcmF0aW5nIGFycmF5cyBhbmQgYXJyYXktbGlrZSBvYmplY3RzCiAgICAnPCUgaWYgKGFycmF5QnJhbmNoKSB7ICU+JyArCiAgICAndmFyIGxlbmd0aCA9IGl0ZXJhdGVlLmxlbmd0aDsgaW5kZXggPSAtMTsnICsKICAgICcgIDwlIGlmIChvYmplY3RCcmFuY2gpIHsgJT5cbmlmIChsZW5ndGggPT09IGxlbmd0aCA+Pj4gMCkgezwlIH0gJT4nICsKCiAgICAvLyBhZGQgc3VwcG9ydCBmb3IgYWNjZXNzaW5nIHN0cmluZyBjaGFyYWN0ZXJzIGJ5IGluZGV4IGlmIG5lZWRlZAogICAgJyAgPCUgaWYgKG5vQ2hhckJ5SW5kZXgpIHsgJT5cbicgKwogICAgJyAgaWYgKHRvU3RyaW5nLmNhbGwoaXRlcmF0ZWUpID09IHN0cmluZ0NsYXNzKSB7XG4nICsKICAgICcgICAgaXRlcmF0ZWUgPSBpdGVyYXRlZS5zcGxpdChcJ1wnKVxuJyArCiAgICAnICB9JyArCiAgICAnICA8JSB9ICU+XG4nICsKCiAgICAnICA8JT0gYXJyYXlCcmFuY2guYmVmb3JlTG9vcCAlPjtcbicgKwogICAgJyAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHtcbicgKwogICAgJyAgICA8JT0gYXJyYXlCcmFuY2guaW5Mb29wICU+XG4nICsKICAgICcgIH0nICsKICAgICcgIDwlIGlmIChvYmplY3RCcmFuY2gpIHsgJT5cbn08JSB9ICU+JyArCiAgICAnPCUgfSAlPicgKwoKICAgIC8vIHRoZSBmb2xsb3dpbmcgYnJhbmNoIGlzIGZvciBpdGVyYXRpbmcgYW4gb2JqZWN0J3Mgb3duL2luaGVyaXRlZCBwcm9wZXJ0aWVzCiAgICAnPCUgaWYgKG9iamVjdEJyYW5jaCkgeyAlPicgKwogICAgJyAgPCUgaWYgKGFycmF5QnJhbmNoKSB7ICU+XG5lbHNlIHs8JSB9ICU+JyArCiAgICAnICA8JSBpZiAoIWhhc0RvbnRFbnVtQnVnKSB7ICU+XG4nICsKICAgICcgIHZhciBza2lwUHJvdG8gPSB0eXBlb2YgaXRlcmF0ZWUgPT0gXCdmdW5jdGlvblwnICYmIFxuJyArCiAgICAnICAgIHByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoaXRlcmF0ZWUsIFwncHJvdG90eXBlXCcpO1xuJyArCiAgICAnICA8JSB9ICU+JyArCgogICAgLy8gaXRlcmF0ZSBvd24gcHJvcGVydGllcyB1c2luZyBgT2JqZWN0LmtleXNgIGlmIGl0J3MgZmFzdAogICAgJyAgPCUgaWYgKGlzS2V5c0Zhc3QgJiYgdXNlSGFzKSB7ICU+XG4nICsKICAgICcgIHZhciBwcm9wcyA9IG5hdGl2ZUtleXMoaXRlcmF0ZWUpLFxuJyArCiAgICAnICAgICAgcHJvcEluZGV4ID0gLTEsXG4nICsKICAgICcgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7XG5cbicgKwogICAgJyAgPCU9IG9iamVjdEJyYW5jaC5iZWZvcmVMb29wICU+O1xuJyArCiAgICAnICB3aGlsZSAoKytwcm9wSW5kZXggPCBsZW5ndGgpIHtcbicgKwogICAgJyAgICBpbmRleCA9IHByb3BzW3Byb3BJbmRleF07XG4nICsKICAgICcgICAgaWYgKCEoc2tpcFByb3RvICYmIGluZGV4ID09IFwncHJvdG90eXBlXCcpKSB7XG4nICsKICAgICcgICAgICA8JT0gb2JqZWN0QnJhbmNoLmluTG9vcCAlPlxuJyArCiAgICAnICAgIH1cbicgKwogICAgJyAgfScgKwoKICAgIC8vIGVsc2UgdXNpbmcgYSBmb3ItaW4gbG9vcAogICAgJyAgPCUgfSBlbHNlIHsgJT5cbicgKwogICAgJyAgPCU9IG9iamVjdEJyYW5jaC5iZWZvcmVMb29wICU+O1xuJyArCiAgICAnICBmb3IgKGluZGV4IGluIGl0ZXJhdGVlKSB7JyArCiAgICAnICAgIDwlIGlmIChoYXNEb250RW51bUJ1ZykgeyAlPlxuJyArCiAgICAnICAgIDwlICAgaWYgKHVzZUhhcykgeyAlPmlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGl0ZXJhdGVlLCBpbmRleCkpIHtcbiAgPCUgfSAlPicgKwogICAgJyAgICA8JT0gb2JqZWN0QnJhbmNoLmluTG9vcCAlPjtcbicgKwogICAgJyAgICA8JSAgIGlmICh1c2VIYXMpIHsgJT59PCUgfSAlPicgKwogICAgJyAgICA8JSB9IGVsc2UgeyAlPlxuJyArCgogICAgLy8gRmlyZWZveCA8IDMuNiwgT3BlcmEgPiA5LjUwIC0gT3BlcmEgPCAxMS42MCwgYW5kIFNhZmFyaSA8IDUuMQogICAgLy8gKGlmIHRoZSBwcm90b3R5cGUgb3IgYSBwcm9wZXJ0eSBvbiB0aGUgcHJvdG90eXBlIGhhcyBiZWVuIHNldCkKICAgIC8vIGluY29ycmVjdGx5IHNldHMgYSBmdW5jdGlvbidzIGBwcm90b3R5cGVgIHByb3BlcnR5IFtbRW51bWVyYWJsZV1dCiAgICAvLyB2YWx1ZSB0byBgdHJ1ZWAuIEJlY2F1c2Ugb2YgdGhpcyBMby1EYXNoIHN0YW5kYXJkaXplcyBvbiBza2lwcGluZwogICAgLy8gdGhlIHRoZSBgcHJvdG90eXBlYCBwcm9wZXJ0eSBvZiBmdW5jdGlvbnMgcmVnYXJkbGVzcyBvZiBpdHMKICAgIC8vIFtbRW51bWVyYWJsZV1dIHZhbHVlLgogICAgJyAgICBpZiAoIShza2lwUHJvdG8gJiYgaW5kZXggPT0gXCdwcm90b3R5cGVcJyk8JSBpZiAodXNlSGFzKSB7ICU+ICYmXG4nICsKICAgICcgICAgICAgIGhhc093blByb3BlcnR5LmNhbGwoaXRlcmF0ZWUsIGluZGV4KTwlIH0gJT4pIHtcbicgKwogICAgJyAgICAgIDwlPSBvYmplY3RCcmFuY2guaW5Mb29wICU+XG4nICsKICAgICcgICAgfScgKwogICAgJyAgICA8JSB9ICU+XG4nICsKICAgICcgIH0nICsKICAgICcgIDwlIH0gJT4nICsKCiAgICAvLyBCZWNhdXNlIElFIDwgOSBjYW4ndCBzZXQgdGhlIGBbW0VudW1lcmFibGVdXWAgYXR0cmlidXRlIG9mIGFuCiAgICAvLyBleGlzdGluZyBwcm9wZXJ0eSBhbmQgdGhlIGBjb25zdHJ1Y3RvcmAgcHJvcGVydHkgb2YgYSBwcm90b3R5cGUKICAgIC8vIGRlZmF1bHRzIHRvIG5vbi1lbnVtZXJhYmxlLCBMby1EYXNoIHNraXBzIHRoZSBgY29uc3RydWN0b3JgCiAgICAvLyBwcm9wZXJ0eSB3aGVuIGl0IGluZmVycyBpdCdzIGl0ZXJhdGluZyBvdmVyIGEgYHByb3RvdHlwZWAgb2JqZWN0LgogICAgJyAgPCUgaWYgKGhhc0RvbnRFbnVtQnVnKSB7ICU+XG5cbicgKwogICAgJyAgdmFyIGN0b3IgPSBpdGVyYXRlZS5jb25zdHJ1Y3RvcjtcbicgKwogICAgJyAgICA8JSBmb3IgKHZhciBrID0gMDsgayA8IDc7IGsrKykgeyAlPlxuJyArCiAgICAnICBpbmRleCA9IFwnPCU9IHNoYWRvd2VkW2tdICU+XCc7XG4nICsKICAgICcgIGlmICg8JScgKwogICAgJyAgICAgIGlmIChzaGFkb3dlZFtrXSA9PSBcJ2NvbnN0cnVjdG9yXCcpIHsnICsKICAgICcgICAgICAgICU+IShjdG9yICYmIGN0b3IucHJvdG90eXBlID09PSBpdGVyYXRlZSkgJiYgPCUnICsKICAgICcgICAgICB9ICU+aGFzT3duUHJvcGVydHkuY2FsbChpdGVyYXRlZSwgaW5kZXgpKSB7XG4nICsKICAgICcgICAgPCU9IG9iamVjdEJyYW5jaC5pbkxvb3AgJT5cbicgKwogICAgJyAgfScgKwogICAgJyAgICA8JSB9ICU+JyArCiAgICAnICA8JSB9ICU+JyArCiAgICAnICA8JSBpZiAoYXJyYXlCcmFuY2gpIHsgJT5cbn08JSB9ICU+JyArCiAgICAnPCUgfSAlPlxuJyArCgogICAgLy8gYWRkIGNvZGUgdG8gdGhlIGJvdHRvbSBvZiB0aGUgaXRlcmF0aW9uIGZ1bmN0aW9uCiAgICAnPCU9IGJvdHRvbSAlPjtcbicgKwogICAgLy8gZmluYWxseSwgcmV0dXJuIHRoZSBgcmVzdWx0YAogICAgJ3JldHVybiByZXN1bHQnCiAgKTsKCiAgLyoqCiAgICogUmV1c2FibGUgaXRlcmF0b3Igb3B0aW9ucyBzaGFyZWQgYnkKICAgKiBgZXZlcnlgLCBgZmlsdGVyYCwgYGZpbmRgLCBgZm9yRWFjaGAsIGBmb3JJbmAsIGBmb3JPd25gLCBgZ3JvdXBCeWAsIGBtYXBgLAogICAqIGByZWplY3RgLCBgc29tZWAsIGFuZCBgc29ydEJ5YC4KICAgKi8KICB2YXIgYmFzZUl0ZXJhdG9yT3B0aW9ucyA9IHsKICAgICdhcmdzJzogJ2NvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnJywKICAgICdpbml0JzogJ2NvbGxlY3Rpb24nLAogICAgJ3RvcCc6CiAgICAgICdpZiAoIWNhbGxiYWNrKSB7XG4nICsKICAgICAgJyAgY2FsbGJhY2sgPSBpZGVudGl0eVxuJyArCiAgICAgICd9XG4nICsKICAgICAgJ2Vsc2UgaWYgKHRoaXNBcmcpIHtcbicgKwogICAgICAnICBjYWxsYmFjayA9IGl0ZXJhdG9yQmluZChjYWxsYmFjaywgdGhpc0FyZylcbicgKwogICAgICAnfScsCiAgICAnaW5Mb29wJzogJ2NhbGxiYWNrKGl0ZXJhdGVlW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pJwogIH07CgogIC8qKiBSZXVzYWJsZSBpdGVyYXRvciBvcHRpb25zIGZvciBgZXZlcnlgIGFuZCBgc29tZWAgKi8KICB2YXIgZXZlcnlJdGVyYXRvck9wdGlvbnMgPSB7CiAgICAnaW5pdCc6ICd0cnVlJywKICAgICdpbkxvb3AnOiAnaWYgKCFjYWxsYmFjayhpdGVyYXRlZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSkgcmV0dXJuICFyZXN1bHQnCiAgfTsKCiAgLyoqIFJldXNhYmxlIGl0ZXJhdG9yIG9wdGlvbnMgZm9yIGBkZWZhdWx0c2AgYW5kIGBleHRlbmRgICovCiAgdmFyIGV4dGVuZEl0ZXJhdG9yT3B0aW9ucyA9IHsKICAgICd1c2VIYXMnOiBmYWxzZSwKICAgICd1c2VTdHJpY3QnOiBmYWxzZSwKICAgICdhcmdzJzogJ29iamVjdCcsCiAgICAnaW5pdCc6ICdvYmplY3QnLAogICAgJ3RvcCc6CiAgICAgICdmb3IgKHZhciBpdGVyYXRlZUluZGV4ID0gMSwgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDsgaXRlcmF0ZWVJbmRleCA8IGxlbmd0aDsgaXRlcmF0ZWVJbmRleCsrKSB7XG4nICsKICAgICAgJyAgaXRlcmF0ZWUgPSBhcmd1bWVudHNbaXRlcmF0ZWVJbmRleF07XG4nICsKICAgICAgKGhhc0RvbnRFbnVtQnVnID8gJyAgaWYgKGl0ZXJhdGVlKSB7JyA6ICcnKSwKICAgICdpbkxvb3AnOiAncmVzdWx0W2luZGV4XSA9IGl0ZXJhdGVlW2luZGV4XScsCiAgICAnYm90dG9tJzogKGhhc0RvbnRFbnVtQnVnID8gJyAgfVxuJyA6ICcnKSArICd9JwogIH07CgogIC8qKiBSZXVzYWJsZSBpdGVyYXRvciBvcHRpb25zIGZvciBgZmlsdGVyYCBhbmQgYHJlamVjdGAgKi8KICB2YXIgZmlsdGVySXRlcmF0b3JPcHRpb25zID0gewogICAgJ2luaXQnOiAnW10nLAogICAgJ2luTG9vcCc6ICdjYWxsYmFjayhpdGVyYXRlZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSAmJiByZXN1bHQucHVzaChpdGVyYXRlZVtpbmRleF0pJwogIH07CgogIC8qKiBSZXVzYWJsZSBpdGVyYXRvciBvcHRpb25zIGZvciBgZmluZGAsIGBmb3JFYWNoYCwgYGZvckluYCwgYW5kIGBmb3JPd25gICovCiAgdmFyIGZvckVhY2hJdGVyYXRvck9wdGlvbnMgPSB7CiAgICAndG9wJzogJ2lmICh0aGlzQXJnKSBjYWxsYmFjayA9IGl0ZXJhdG9yQmluZChjYWxsYmFjaywgdGhpc0FyZyknCiAgfTsKCiAgLyoqIFJldXNhYmxlIGl0ZXJhdG9yIG9wdGlvbnMgZm9yIGBmb3JJbmAgYW5kIGBmb3JPd25gICovCiAgdmFyIGZvck93bkl0ZXJhdG9yT3B0aW9ucyA9IHsKICAgICdpbkxvb3AnOiB7CiAgICAgICdvYmplY3QnOiBiYXNlSXRlcmF0b3JPcHRpb25zLmluTG9vcAogICAgfQogIH07CgogIC8qKiBSZXVzYWJsZSBpdGVyYXRvciBvcHRpb25zIGZvciBgaW52b2tlYCwgYG1hcGAsIGBwbHVja2AsIGFuZCBgc29ydEJ5YCAqLwogIHZhciBtYXBJdGVyYXRvck9wdGlvbnMgPSB7CiAgICAnaW5pdCc6ICcnLAogICAgJ2V4aXQnOiAnaWYgKCFjb2xsZWN0aW9uKSByZXR1cm4gW10nLAogICAgJ2JlZm9yZUxvb3AnOiB7CiAgICAgICdhcnJheSc6ICAncmVzdWx0ID0gQXJyYXkobGVuZ3RoKScsCiAgICAgICdvYmplY3QnOiAncmVzdWx0ID0gJyArIChpc0tleXNGYXN0ID8gJ0FycmF5KGxlbmd0aCknIDogJ1tdJykKICAgIH0sCiAgICAnaW5Mb29wJzogewogICAgICAnYXJyYXknOiAgJ3Jlc3VsdFtpbmRleF0gPSBjYWxsYmFjayhpdGVyYXRlZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKScsCiAgICAgICdvYmplY3QnOiAncmVzdWx0JyArIChpc0tleXNGYXN0ID8gJ1twcm9wSW5kZXhdID0gJyA6ICcucHVzaCcpICsgJyhjYWxsYmFjayhpdGVyYXRlZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSknCiAgICB9CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgY29tcGlsZWQgaXRlcmF0aW9uIGZ1bmN0aW9ucy4gVGhlIGl0ZXJhdGlvbiBmdW5jdGlvbiB3aWxsIGJlIGNyZWF0ZWQKICAgKiB0byBpdGVyYXRlIG92ZXIgb25seSBvYmplY3RzIGlmIHRoZSBmaXJzdCBhcmd1bWVudCBvZiBgb3B0aW9ucy5hcmdzYCBpcwogICAqICJvYmplY3QiIG9yIGBvcHRpb25zLmluTG9vcC5hcnJheWAgaXMgZmFsc2V5LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnMxLCBvcHRpb25zMiwgLi4uXSBUaGUgY29tcGlsZSBvcHRpb25zIG9iamVjdHMuCiAgICoKICAgKiAgdXNlSGFzIC0gQSBib29sZWFuIHRvIHNwZWNpZnkgd2hldGhlciBvciBub3QgdG8gdXNlIGBoYXNPd25Qcm9wZXJ0eWAgY2hlY2tzCiAgICogICBpbiB0aGUgb2JqZWN0IGxvb3AuCiAgICoKICAgKiAgdXNlU3RyaWN0IC0gQSBib29sZWFuIHRvIHNwZWNpZnkgd2hldGhlciBvciBub3QgdG8gaW5jbHVkZSB0aGUgRVM1CiAgICogICAidXNlIHN0cmljdCIgZGlyZWN0aXZlLgogICAqCiAgICogIGFyZ3MgLSBBIHN0cmluZyBvZiBjb21tYSBzZXBhcmF0ZWQgYXJndW1lbnRzIHRoZSBpdGVyYXRpb24gZnVuY3Rpb24gd2lsbAogICAqICAgYWNjZXB0LgogICAqCiAgICogIGluaXQgLSBBIHN0cmluZyB0byBzcGVjaWZ5IHRoZSBpbml0aWFsIHZhbHVlIG9mIHRoZSBgcmVzdWx0YCB2YXJpYWJsZS4KICAgKgogICAqICBleGl0IC0gQSBzdHJpbmcgb2YgY29kZSB0byB1c2UgaW4gcGxhY2Ugb2YgdGhlIGRlZmF1bHQgZXhpdC1lYXJseSBjaGVjawogICAqICAgb2YgYGlmICghYXJndW1lbnRzWzBdKSByZXR1cm4gcmVzdWx0YC4KICAgKgogICAqICB0b3AgLSBBIHN0cmluZyBvZiBjb2RlIHRvIGV4ZWN1dGUgYWZ0ZXIgdGhlIGV4aXQtZWFybHkgY2hlY2sgYnV0IGJlZm9yZQogICAqICAgdGhlIGl0ZXJhdGlvbiBicmFuY2hlcy4KICAgKgogICAqICBiZWZvcmVMb29wIC0gQSBzdHJpbmcgb3Igb2JqZWN0IGNvbnRhaW5pbmcgYW4gImFycmF5IiBvciAib2JqZWN0IiBwcm9wZXJ0eQogICAqICAgb2YgY29kZSB0byBleGVjdXRlIGJlZm9yZSB0aGUgYXJyYXkgb3Igb2JqZWN0IGxvb3BzLgogICAqCiAgICogIGluTG9vcCAtIEEgc3RyaW5nIG9yIG9iamVjdCBjb250YWluaW5nIGFuICJhcnJheSIgb3IgIm9iamVjdCIgcHJvcGVydHkKICAgKiAgIG9mIGNvZGUgdG8gZXhlY3V0ZSBpbiB0aGUgYXJyYXkgb3Igb2JqZWN0IGxvb3BzLgogICAqCiAgICogIGJvdHRvbSAtIEEgc3RyaW5nIG9mIGNvZGUgdG8gZXhlY3V0ZSBhZnRlciB0aGUgaXRlcmF0aW9uIGJyYW5jaGVzIGJ1dAogICAqICAgYmVmb3JlIHRoZSBgcmVzdWx0YCBpcyByZXR1cm5lZC4KICAgKgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgY29tcGlsZWQgZnVuY3Rpb24uCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlSXRlcmF0b3IoKSB7CiAgICB2YXIgb2JqZWN0LAogICAgICAgIHByb3AsCiAgICAgICAgdmFsdWUsCiAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwoKICAgIC8vIG1lcmdlIG9wdGlvbnMgaW50byBhIHRlbXBsYXRlIGRhdGEgb2JqZWN0CiAgICB2YXIgZGF0YSA9IHsKICAgICAgJ2JvdHRvbSc6ICcnLAogICAgICAnZXhpdCc6ICcnLAogICAgICAnaW5pdCc6ICcnLAogICAgICAndG9wJzogJycsCiAgICAgICdhcnJheUJyYW5jaCc6IHsgJ2JlZm9yZUxvb3AnOiAnJyB9LAogICAgICAnb2JqZWN0QnJhbmNoJzogeyAnYmVmb3JlTG9vcCc6ICcnIH0KICAgIH07CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgb2JqZWN0ID0gYXJndW1lbnRzW2luZGV4XTsKICAgICAgZm9yIChwcm9wIGluIG9iamVjdCkgewogICAgICAgIHZhbHVlID0gKHZhbHVlID0gb2JqZWN0W3Byb3BdKSA9PSBudWxsID8gJycgOiB2YWx1ZTsKICAgICAgICAvLyBrZWVwIHRoaXMgcmVnZXhwIGV4cGxpY2l0IGZvciB0aGUgYnVpbGQgcHJlLXByb2Nlc3MKICAgICAgICBpZiAoL2JlZm9yZUxvb3B8aW5Mb29wLy50ZXN0KHByb3ApKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHZhbHVlID0geyAnYXJyYXknOiB2YWx1ZSwgJ29iamVjdCc6IHZhbHVlIH07CiAgICAgICAgICB9CiAgICAgICAgICBkYXRhLmFycmF5QnJhbmNoW3Byb3BdID0gdmFsdWUuYXJyYXk7CiAgICAgICAgICBkYXRhLm9iamVjdEJyYW5jaFtwcm9wXSA9IHZhbHVlLm9iamVjdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGF0YVtwcm9wXSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gc2V0IGFkZGl0aW9uYWwgdGVtcGxhdGUgYGRhdGFgIHZhbHVlcwogICAgdmFyIGFyZ3MgPSBkYXRhLmFyZ3MsCiAgICAgICAgZmlyc3RBcmcgPSAvXlteLF0rLy5leGVjKGFyZ3MpWzBdOwoKICAgIGRhdGEuZmlyc3RBcmcgPSBmaXJzdEFyZzsKICAgIGRhdGEuaGFzRG9udEVudW1CdWcgPSBoYXNEb250RW51bUJ1ZzsKICAgIGRhdGEuaXNLZXlzRmFzdCA9IGlzS2V5c0Zhc3Q7CiAgICBkYXRhLnNoYWRvd2VkID0gc2hhZG93ZWQ7CiAgICBkYXRhLnVzZUhhcyA9IGRhdGEudXNlSGFzICE9PSBmYWxzZTsKICAgIGRhdGEudXNlU3RyaWN0ID0gZGF0YS51c2VTdHJpY3QgIT09IGZhbHNlOwoKICAgIGlmICghKCdub0NoYXJCeUluZGV4JyBpbiBkYXRhKSkgewogICAgICBkYXRhLm5vQ2hhckJ5SW5kZXggPSBub0NoYXJCeUluZGV4OwogICAgfQogICAgaWYgKCFkYXRhLmV4aXQpIHsKICAgICAgZGF0YS5leGl0ID0gJ2lmICghJyArIGZpcnN0QXJnICsgJykgcmV0dXJuIHJlc3VsdCc7CiAgICB9CiAgICBpZiAoZmlyc3RBcmcgIT0gJ2NvbGxlY3Rpb24nIHx8ICFkYXRhLmFycmF5QnJhbmNoLmluTG9vcCkgewogICAgICBkYXRhLmFycmF5QnJhbmNoID0gbnVsbDsKICAgIH0KICAgIC8vIGNyZWF0ZSB0aGUgZnVuY3Rpb24gZmFjdG9yeQogICAgdmFyIGZhY3RvcnkgPSBGdW5jdGlvbigKICAgICAgICAnYXJyYXlDbGFzcywgYmluZCwgY29tcGFyZUFzY2VuZGluZywgZnVuY0NsYXNzLCBoYXNPd25Qcm9wZXJ0eSwgaWRlbnRpdHksICcgKwogICAgICAgICdpdGVyYXRvckJpbmQsIG9iamVjdFR5cGVzLCBuYXRpdmVLZXlzLCBwcm9wZXJ0eUlzRW51bWVyYWJsZSwgc2xpY2UsICcgKwogICAgICAgICdzdHJpbmdDbGFzcywgdG9TdHJpbmcnLAogICAgICAncmV0dXJuIGZ1bmN0aW9uKCcgKyBhcmdzICsgJykge1xuJyArIGl0ZXJhdG9yVGVtcGxhdGUoZGF0YSkgKyAnXG59JwogICAgKTsKICAgIC8vIHJldHVybiB0aGUgY29tcGlsZWQgZnVuY3Rpb24KICAgIHJldHVybiBmYWN0b3J5KAogICAgICBhcnJheUNsYXNzLCBiaW5kLCBjb21wYXJlQXNjZW5kaW5nLCBmdW5jQ2xhc3MsIGhhc093blByb3BlcnR5LCBpZGVudGl0eSwKICAgICAgaXRlcmF0b3JCaW5kLCBvYmplY3RUeXBlcywgbmF0aXZlS2V5cywgcHJvcGVydHlJc0VudW1lcmFibGUsIHNsaWNlLAogICAgICBzdHJpbmdDbGFzcywgdG9TdHJpbmcKICAgICk7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBzb3J0QnlgIHRvIGNvbXBhcmUgdHJhbnNmb3JtZWQgdmFsdWVzIG9mIGBjb2xsZWN0aW9uYCwgc29ydGluZwogICAqIHRoZW0gaW4gYXNjZW5kaW5nIG9yZGVyLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gYSBUaGUgb2JqZWN0IHRvIGNvbXBhcmUgdG8gYGJgLgogICAqIEBwYXJhbSB7T2JqZWN0fSBiIFRoZSBvYmplY3QgdG8gY29tcGFyZSB0byBgYWAuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyBgLTFgIGlmIGBhYCA8IGBiYCwgYDBgIGlmIGBhYCA9PSBgYmAsIG9yIGAxYCBpZiBgYWAgPiBgYmAuCiAgICovCiAgZnVuY3Rpb24gY29tcGFyZUFzY2VuZGluZyhhLCBiKSB7CiAgICBhID0gYS5jcml0ZXJpYTsKICAgIGIgPSBiLmNyaXRlcmlhOwoKICAgIGlmIChhID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIDE7CiAgICB9CiAgICBpZiAoYiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIHJldHVybiBhIDwgYiA/IC0xIDogYSA+IGIgPyAxIDogMDsKICB9CgogIC8qKgogICAqIFVzZWQgYnkgYHRlbXBsYXRlYCB0byByZXBsYWNlIHRva2VucyB3aXRoIHRoZWlyIGNvcnJlc3BvbmRpbmcgY29kZSBzbmlwcGV0cy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIHRva2VuLgogICAqIEBwYXJhbSB7U3RyaW5nfSBpbmRleCBUaGUgYHRva2VuaXplZGAgaW5kZXggb2YgdGhlIGNvZGUgc25pcHBldC4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIHRoZSBjb2RlIHNuaXBwZXQuCiAgICovCiAgZnVuY3Rpb24gZGV0b2tlbml6ZShtYXRjaCwgaW5kZXgpIHsKICAgIHJldHVybiB0b2tlbml6ZWRbaW5kZXhdOwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgdGVtcGxhdGVgIHRvIGVzY2FwZSBjaGFyYWN0ZXJzIGZvciBpbmNsdXNpb24gaW4gY29tcGlsZWQKICAgKiBzdHJpbmcgbGl0ZXJhbHMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7U3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCBjaGFyYWN0ZXIgdG8gZXNjYXBlLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgdGhlIGVzY2FwZWQgY2hhcmFjdGVyLgogICAqLwogIGZ1bmN0aW9uIGVzY2FwZVN0cmluZ0NoYXIobWF0Y2gpIHsKICAgIHJldHVybiAnXFwnICsgc3RyaW5nRXNjYXBlc1ttYXRjaF07CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBlc2NhcGVgIHRvIGVzY2FwZSBjaGFyYWN0ZXJzIGZvciBpbmNsdXNpb24gaW4gSFRNTC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlSHRtbENoYXIobWF0Y2gpIHsKICAgIHJldHVybiBodG1sRXNjYXBlc1ttYXRjaF07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBpbnZva2VzIGBmdW5jYCB3aXRoIHRoZSBgdGhpc2AKICAgKiBiaW5kaW5nIG9mIGB0aGlzQXJnYCBhbmQgdGhlIGFyZ3VtZW50cyAodmFsdWUsIGluZGV4LCBvYmplY3QpLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBiaW5kLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIGl0ZXJhdG9yQmluZChmdW5jLCB0aGlzQXJnKSB7CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUsIGluZGV4LCBvYmplY3QpIHsKICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCk7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQSBuby1vcGVyYXRpb24gZnVuY3Rpb24uCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICAvLyBubyBvcGVyYXRpb24gcGVyZm9ybWVkCiAgfQoKICAvKioKICAgKiBBIHNoaW0gaW1wbGVtZW50YXRpb24gb2YgYE9iamVjdC5rZXlzYCB0aGF0IHByb2R1Y2VzIGFuIGFycmF5IG9mIHRoZSBnaXZlbgogICAqIG9iamVjdCdzIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IG5hbWVzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICovCiAgdmFyIHNoaW1LZXlzID0gY3JlYXRlSXRlcmF0b3IoewogICAgJ2FyZ3MnOiAnb2JqZWN0JywKICAgICdleGl0JzogJ2lmICghKG9iamVjdCAmJiBvYmplY3RUeXBlc1t0eXBlb2Ygb2JqZWN0XSkpIHRocm93IFR5cGVFcnJvcigpJywKICAgICdpbml0JzogJ1tdJywKICAgICdpbkxvb3AnOiAncmVzdWx0LnB1c2goaW5kZXgpJwogIH0pOwoKICAvKioKICAgKiBVc2VkIGJ5IGB0ZW1wbGF0ZWAgdG8gcmVwbGFjZSAiZXNjYXBlIiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzIHdpdGggdG9rZW5zLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge1N0cmluZ30gbWF0Y2ggVGhlIG1hdGNoZWQgdGVtcGxhdGUgZGVsaW1pdGVyLgogICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgZGVsaW1pdGVyIHZhbHVlLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybnMgYSB0b2tlbi4KICAgKi8KICBmdW5jdGlvbiB0b2tlbml6ZUVzY2FwZShtYXRjaCwgdmFsdWUpIHsKICAgIGlmIChyZUNvbXBsZXhEZWxpbWl0ZXIudGVzdCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuICc8ZSUtJyArIHZhbHVlICsgJyU+JzsKICAgIH0KICAgIHZhciBpbmRleCA9IHRva2VuaXplZC5sZW5ndGg7CiAgICB0b2tlbml6ZWRbaW5kZXhdID0gIicgK1xuX19lKCIgKyB2YWx1ZSArICIpICtcbiciOwogICAgcmV0dXJuIHRva2VuICsgaW5kZXg7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGB0ZW1wbGF0ZWAgdG8gcmVwbGFjZSAiZXZhbHVhdGUiIHRlbXBsYXRlIGRlbGltaXRlcnMsIG9yIGNvbXBsZXgKICAgKiAiZXNjYXBlIiBhbmQgImludGVycG9sYXRlIiBkZWxpbWl0ZXJzLCB3aXRoIHRva2Vucy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIHRlbXBsYXRlIGRlbGltaXRlci4KICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUgVGhlIGRlbGltaXRlciB2YWx1ZS4KICAgKiBAcGFyYW0ge1N0cmluZ30gZXNjYXBlVmFsdWUgVGhlICJlc2NhcGUiIGRlbGltaXRlciB2YWx1ZS4KICAgKiBAcGFyYW0ge1N0cmluZ30gaW50ZXJwb2xhdGVWYWx1ZSBUaGUgImludGVycG9sYXRlIiBkZWxpbWl0ZXIgdmFsdWUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyBhIHRva2VuLgogICAqLwogIGZ1bmN0aW9uIHRva2VuaXplRXZhbHVhdGUobWF0Y2gsIHZhbHVlLCBlc2NhcGVWYWx1ZSwgaW50ZXJwb2xhdGVWYWx1ZSkgewogICAgdmFyIGluZGV4ID0gdG9rZW5pemVkLmxlbmd0aDsKICAgIGlmICh2YWx1ZSkgewogICAgICB0b2tlbml6ZWRbaW5kZXhdID0gIic7XG4iICsgdmFsdWUgKyAiO1xuX19wICs9ICciCiAgICB9IGVsc2UgaWYgKGVzY2FwZVZhbHVlKSB7CiAgICAgIHRva2VuaXplZFtpbmRleF0gPSAiJyArXG5fX2UoIiArIGVzY2FwZVZhbHVlICsgIikgK1xuJyI7CiAgICB9IGVsc2UgaWYgKGludGVycG9sYXRlVmFsdWUpIHsKICAgICAgdG9rZW5pemVkW2luZGV4XSA9ICInICtcbigoX190ID0gKCIgKyBpbnRlcnBvbGF0ZVZhbHVlICsgIikpID09IG51bGwgPyAnJyA6IF9fdCkgK1xuJyI7CiAgICB9CiAgICByZXR1cm4gdG9rZW4gKyBpbmRleDsKICB9CgogIC8qKgogICAqIFVzZWQgYnkgYHRlbXBsYXRlYCB0byByZXBsYWNlICJpbnRlcnBvbGF0ZSIgdGVtcGxhdGUgZGVsaW1pdGVycyB3aXRoIHRva2Vucy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIHRlbXBsYXRlIGRlbGltaXRlci4KICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUgVGhlIGRlbGltaXRlciB2YWx1ZS4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXR1cm5zIGEgdG9rZW4uCiAgICovCiAgZnVuY3Rpb24gdG9rZW5pemVJbnRlcnBvbGF0ZShtYXRjaCwgdmFsdWUpIHsKICAgIGlmIChyZUNvbXBsZXhEZWxpbWl0ZXIudGVzdCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuICc8ZSU9JyArIHZhbHVlICsgJyU+JzsKICAgIH0KICAgIHZhciBpbmRleCA9IHRva2VuaXplZC5sZW5ndGg7CiAgICB0b2tlbml6ZWRbaW5kZXhdID0gIicgK1xuKChfX3QgPSAoIiArIHZhbHVlICsgIikpID09IG51bGwgPyAnJyA6IF9fdCkgK1xuJyI7CiAgICByZXR1cm4gdG9rZW4gKyBpbmRleDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDaGVja3MgaWYgYSBnaXZlbiBgdGFyZ2V0YCB2YWx1ZSBpcyBwcmVzZW50IGluIGEgYGNvbGxlY3Rpb25gIHVzaW5nIHN0cmljdAogICAqIGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBpbmNsdWRlCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge01peGVkfSB0YXJnZXQgVGhlIHZhbHVlIHRvIGNoZWNrIGZvci4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHRhcmdldGAgdmFsdWUgaXMgZm91bmQsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5jb250YWlucyhbMSwgMiwgM10sIDMpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uY29udGFpbnMoeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwgJ21vZScpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uY29udGFpbnMoJ2N1cmx5JywgJ3VyJyk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIHZhciBjb250YWlucyA9IGNyZWF0ZUl0ZXJhdG9yKHsKICAgICdhcmdzJzogJ2NvbGxlY3Rpb24sIHRhcmdldCcsCiAgICAnaW5pdCc6ICdmYWxzZScsCiAgICAnbm9DaGFyQnlJbmRleCc6IGZhbHNlLAogICAgJ2JlZm9yZUxvb3AnOiB7CiAgICAgICdhcnJheSc6ICdpZiAodG9TdHJpbmcuY2FsbChpdGVyYXRlZSkgPT0gc3RyaW5nQ2xhc3MpIHJldHVybiBjb2xsZWN0aW9uLmluZGV4T2YodGFyZ2V0KSA+IC0xJwogICAgfSwKICAgICdpbkxvb3AnOiAnaWYgKGl0ZXJhdGVlW2luZGV4XSA9PT0gdGFyZ2V0KSByZXR1cm4gdHJ1ZScKICB9KTsKCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBgY2FsbGJhY2tgIHJldHVybnMgYSB0cnV0aHkgdmFsdWUgZm9yICoqYWxsKiogZWxlbWVudHMgb2YgYQogICAqIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggMwogICAqIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGFsbAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbGwgdmFsdWVzIHBhc3MgdGhlIGNhbGxiYWNrIGNoZWNrLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZXZlcnkoW3RydWUsIDEsIG51bGwsICd5ZXMnXSwgQm9vbGVhbik7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICB2YXIgZXZlcnkgPSBjcmVhdGVJdGVyYXRvcihiYXNlSXRlcmF0b3JPcHRpb25zLCBldmVyeUl0ZXJhdG9yT3B0aW9ucyk7CgogIC8qKgogICAqIEV4YW1pbmVzIGVhY2ggdmFsdWUgaW4gYSBgY29sbGVjdGlvbmAsIHJldHVybmluZyBhbiBhcnJheSBvZiBhbGwgdmFsdWVzIHRoZQogICAqIGBjYWxsYmFja2AgcmV0dXJucyB0cnV0aHkgZm9yLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICogaW52b2tlZCB3aXRoIDMgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgc2VsZWN0CiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2suCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHZhbHVlcyB0aGF0IHBhc3NlZCBjYWxsYmFjayBjaGVjay4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGV2ZW5zID0gXy5maWx0ZXIoWzEsIDIsIDMsIDQsIDUsIDZdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAlIDIgPT0gMDsgfSk7CiAgICogLy8gPT4gWzIsIDQsIDZdCiAgICovCiAgdmFyIGZpbHRlciA9IGNyZWF0ZUl0ZXJhdG9yKGJhc2VJdGVyYXRvck9wdGlvbnMsIGZpbHRlckl0ZXJhdG9yT3B0aW9ucyk7CgogIC8qKgogICAqIEV4YW1pbmVzIGVhY2ggdmFsdWUgaW4gYSBgY29sbGVjdGlvbmAsIHJldHVybmluZyB0aGUgZmlyc3Qgb25lIHRoZSBgY2FsbGJhY2tgCiAgICogcmV0dXJucyB0cnV0aHkgZm9yLiBUaGUgZnVuY3Rpb24gcmV0dXJucyBhcyBzb29uIGFzIGl0IGZpbmRzIGFuIGFjY2VwdGFibGUKICAgKiB2YWx1ZSwgYW5kIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciB0aGUgZW50aXJlIGBjb2xsZWN0aW9uYC4gVGhlIGBjYWxsYmFja2AgaXMKICAgKiBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCAzIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIGRldGVjdAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIHZhbHVlIHRoYXQgcGFzc2VkIHRoZSBjYWxsYmFjayBjaGVjaywgZWxzZSBgdW5kZWZpbmVkYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGV2ZW4gPSBfLmZpbmQoWzEsIDIsIDMsIDQsIDUsIDZdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAlIDIgPT0gMDsgfSk7CiAgICogLy8gPT4gMgogICAqLwogIHZhciBmaW5kID0gY3JlYXRlSXRlcmF0b3IoYmFzZUl0ZXJhdG9yT3B0aW9ucywgZm9yRWFjaEl0ZXJhdG9yT3B0aW9ucywgewogICAgJ2luaXQnOiAnJywKICAgICdpbkxvb3AnOiAnaWYgKGNhbGxiYWNrKGl0ZXJhdGVlW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pKSByZXR1cm4gaXRlcmF0ZWVbaW5kZXhdJwogIH0pOwoKICAvKioKICAgKiBJdGVyYXRlcyBvdmVyIGEgYGNvbGxlY3Rpb25gLCBleGVjdXRpbmcgdGhlIGBjYWxsYmFja2AgZm9yIGVhY2ggdmFsdWUgaW4gdGhlCiAgICogYGNvbGxlY3Rpb25gLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCAzCiAgICogYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZWFjaAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7QXJyYXl8T2JqZWN0fSBSZXR1cm5zIHRoZSBgY29sbGVjdGlvbmAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8oWzEsIDIsIDNdKS5mb3JFYWNoKGFsZXJ0KS5qb2luKCcsJyk7CiAgICogLy8gPT4gYWxlcnRzIGVhY2ggbnVtYmVyIGFuZCByZXR1cm5zICcxLDIsMycKICAgKgogICAqIF8uZm9yRWFjaCh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9LCBhbGVydCk7CiAgICogLy8gPT4gYWxlcnRzIGVhY2ggbnVtYmVyIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICB2YXIgZm9yRWFjaCA9IGNyZWF0ZUl0ZXJhdG9yKGJhc2VJdGVyYXRvck9wdGlvbnMsIGZvckVhY2hJdGVyYXRvck9wdGlvbnMpOwoKICAvKioKICAgKiBTcGxpdHMgYGNvbGxlY3Rpb25gIGludG8gc2V0cywgZ3JvdXBlZCBieSB0aGUgcmVzdWx0IG9mIHJ1bm5pbmcgZWFjaCB2YWx1ZQogICAqIHRocm91Z2ggYGNhbGxiYWNrYC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGgKICAgKiAzIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLiBUaGUgYGNhbGxiYWNrYCBhcmd1bWVudCBtYXkKICAgKiBhbHNvIGJlIHRoZSBuYW1lIG9mIGEgcHJvcGVydHkgdG8gZ3JvdXAgYnkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24gb3IKICAgKiAgcHJvcGVydHkgbmFtZSB0byBncm91cCBieS4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2suCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3Qgb2YgZ3JvdXBlZCB2YWx1ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZ3JvdXBCeShbMS4zLCAyLjEsIDIuNF0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gTWF0aC5mbG9vcihudW0pOyB9KTsKICAgKiAvLyA9PiB7ICcxJzogWzEuM10sICcyJzogWzIuMSwgMi40XSB9CiAgICoKICAgKiBfLmdyb3VwQnkoWzEuMywgMi4xLCAyLjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICogLy8gPT4geyAnMSc6IFsxLjNdLCAnMic6IFsyLjEsIDIuNF0gfQogICAqCiAgICogXy5ncm91cEJ5KFsnb25lJywgJ3R3bycsICd0aHJlZSddLCAnbGVuZ3RoJyk7CiAgICogLy8gPT4geyAnMyc6IFsnb25lJywgJ3R3byddLCAnNSc6IFsndGhyZWUnXSB9CiAgICovCiAgdmFyIGdyb3VwQnkgPSBjcmVhdGVJdGVyYXRvcihiYXNlSXRlcmF0b3JPcHRpb25zLCB7CiAgICAnaW5pdCc6ICd7fScsCiAgICAndG9wJzoKICAgICAgJ3ZhciBwcm9wLCBpc0Z1bmMgPSB0eXBlb2YgY2FsbGJhY2sgPT0gXCdmdW5jdGlvblwnO1xuJyArCiAgICAgICdpZiAoaXNGdW5jICYmIHRoaXNBcmcpIGNhbGxiYWNrID0gaXRlcmF0b3JCaW5kKGNhbGxiYWNrLCB0aGlzQXJnKScsCiAgICAnaW5Mb29wJzoKICAgICAgJ3Byb3AgPSBpc0Z1bmNcbicgKwogICAgICAnICA/IGNhbGxiYWNrKGl0ZXJhdGVlW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pXG4nICsKICAgICAgJyAgOiBpdGVyYXRlZVtpbmRleF1bY2FsbGJhY2tdO1xuJyArCiAgICAgICcoaGFzT3duUHJvcGVydHkuY2FsbChyZXN1bHQsIHByb3ApID8gcmVzdWx0W3Byb3BdIDogcmVzdWx0W3Byb3BdID0gW10pLnB1c2goaXRlcmF0ZWVbaW5kZXhdKScKICB9KTsKCiAgLyoqCiAgICogSW52b2tlcyB0aGUgbWV0aG9kIG5hbWVkIGJ5IGBtZXRob2ROYW1lYCBvbiBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYC4KICAgKiBBZGRpdGlvbmFsIGFyZ3VtZW50cyB3aWxsIGJlIHBhc3NlZCB0byBlYWNoIGludm9rZWQgbWV0aG9kLiBJZiBgbWV0aG9kTmFtZWAKICAgKiBpcyBhIGZ1bmN0aW9uIGl0IHdpbGwgYmUgaW52b2tlZCBmb3IsIGFuZCBgdGhpc2AgYm91bmQgdG8sIGVhY2ggZWxlbWVudAogICAqIGluIHRoZSBgY29sbGVjdGlvbmAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2ROYW1lIFRoZSBuYW1lIG9mIHRoZSBtZXRob2QgdG8gaW52b2tlIG9yCiAgICogIHRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGludm9rZSB0aGUgbWV0aG9kIHdpdGguCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHZhbHVlcyByZXR1cm5lZCBmcm9tIGVhY2ggaW52b2tlZCBtZXRob2QuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaW52b2tlKFtbNSwgMSwgN10sIFszLCAyLCAxXV0sICdzb3J0Jyk7CiAgICogLy8gPT4gW1sxLCA1LCA3XSwgWzEsIDIsIDNdXQogICAqCiAgICogXy5pbnZva2UoWzEyMywgNDU2XSwgU3RyaW5nLnByb3RvdHlwZS5zcGxpdCwgJycpOwogICAqIC8vID0+IFtbJzEnLCAnMicsICczJ10sIFsnNCcsICc1JywgJzYnXV0KICAgKi8KICB2YXIgaW52b2tlID0gY3JlYXRlSXRlcmF0b3IobWFwSXRlcmF0b3JPcHRpb25zLCB7CiAgICAnYXJncyc6ICdjb2xsZWN0aW9uLCBtZXRob2ROYW1lJywKICAgICd0b3AnOgogICAgICAndmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMiksXG4nICsKICAgICAgJyAgICBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSBcJ2Z1bmN0aW9uXCcnLAogICAgJ2luTG9vcCc6IHsKICAgICAgJ2FycmF5JzoKICAgICAgICAncmVzdWx0W2luZGV4XSA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKScgKwogICAgICAgICcuYXBwbHkoaXRlcmF0ZWVbaW5kZXhdLCBhcmdzKScsCiAgICAgICdvYmplY3QnOgogICAgICAgICdyZXN1bHQnICsgKGlzS2V5c0Zhc3QgPyAnW3Byb3BJbmRleF0gPSAnIDogJy5wdXNoJykgKwogICAgICAgICcoKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pLmFwcGx5KGl0ZXJhdGVlW2luZGV4XSwgYXJncykpJwogICAgfQogIH0pOwoKICAvKioKICAgKiBQcm9kdWNlcyBhIG5ldyBhcnJheSBvZiB2YWx1ZXMgYnkgbWFwcGluZyBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYAogICAqIHRocm91Z2ggYSB0cmFuc2Zvcm1hdGlvbiBgY2FsbGJhY2tgLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AKICAgKiBhbmQgaW52b2tlZCB3aXRoIDMgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgY29sbGVjdAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiB2YWx1ZXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLm1hcChbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICogMzsgfSk7CiAgICogLy8gPT4gWzMsIDYsIDldCiAgICoKICAgKiBfLm1hcCh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9LCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAqIDM7IH0pOwogICAqIC8vID0+IFszLCA2LCA5XSAob3JkZXIgaXMgbm90IGd1YXJhbnRlZWQpCiAgICovCiAgdmFyIG1hcCA9IGNyZWF0ZUl0ZXJhdG9yKGJhc2VJdGVyYXRvck9wdGlvbnMsIG1hcEl0ZXJhdG9yT3B0aW9ucyk7CgogIC8qKgogICAqIFJldHJpZXZlcyB0aGUgdmFsdWUgb2YgYSBzcGVjaWZpZWQgcHJvcGVydHkgZnJvbSBhbGwgZWxlbWVudHMgaW4KICAgKiB0aGUgYGNvbGxlY3Rpb25gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIHBsdWNrLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBwcm9wZXJ0eSB2YWx1ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiBfLnBsdWNrKHN0b29nZXMsICduYW1lJyk7CiAgICogLy8gPT4gWydtb2UnLCAnbGFycnknLCAnY3VybHknXQogICAqLwogIHZhciBwbHVjayA9IGNyZWF0ZUl0ZXJhdG9yKG1hcEl0ZXJhdG9yT3B0aW9ucywgewogICAgJ2FyZ3MnOiAnY29sbGVjdGlvbiwgcHJvcGVydHknLAogICAgJ2luTG9vcCc6IHsKICAgICAgJ2FycmF5JzogICdyZXN1bHRbaW5kZXhdID0gaXRlcmF0ZWVbaW5kZXhdW3Byb3BlcnR5XScsCiAgICAgICdvYmplY3QnOiAncmVzdWx0JyArIChpc0tleXNGYXN0ID8gJ1twcm9wSW5kZXhdID0gJyA6ICcucHVzaCcpICsgJyhpdGVyYXRlZVtpbmRleF1bcHJvcGVydHldKScKICAgIH0KICB9KTsKCiAgLyoqCiAgICogQm9pbHMgZG93biBhIGBjb2xsZWN0aW9uYCB0byBhIHNpbmdsZSB2YWx1ZS4gVGhlIGluaXRpYWwgc3RhdGUgb2YgdGhlCiAgICogcmVkdWN0aW9uIGlzIGBhY2N1bXVsYXRvcmAgYW5kIGVhY2ggc3VjY2Vzc2l2ZSBzdGVwIG9mIGl0IHNob3VsZCBiZSByZXR1cm5lZAogICAqIGJ5IHRoZSBgY2FsbGJhY2tgLiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCA0CiAgICogYXJndW1lbnRzOyBmb3IgYXJyYXlzIHRoZXkgYXJlIChhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAYWxpYXMgZm9sZGwsIGluamVjdAogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthY2N1bXVsYXRvcl0gSW5pdGlhbCB2YWx1ZSBvZiB0aGUgYWNjdW11bGF0b3IuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgYWNjdW11bGF0ZWQgdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdW0gPSBfLnJlZHVjZShbMSwgMiwgM10sIGZ1bmN0aW9uKG1lbW8sIG51bSkgeyByZXR1cm4gbWVtbyArIG51bTsgfSk7CiAgICogLy8gPT4gNgogICAqLwogIHZhciByZWR1Y2UgPSBjcmVhdGVJdGVyYXRvcih7CiAgICAnYXJncyc6ICdjb2xsZWN0aW9uLCBjYWxsYmFjaywgYWNjdW11bGF0b3IsIHRoaXNBcmcnLAogICAgJ2luaXQnOiAnYWNjdW11bGF0b3InLAogICAgJ3RvcCc6CiAgICAgICd2YXIgbm9hY2N1bSA9IGFyZ3VtZW50cy5sZW5ndGggPCAzO1xuJyArCiAgICAgICdpZiAodGhpc0FyZykgY2FsbGJhY2sgPSBpdGVyYXRvckJpbmQoY2FsbGJhY2ssIHRoaXNBcmcpJywKICAgICdiZWZvcmVMb29wJzogewogICAgICAnYXJyYXknOiAnaWYgKG5vYWNjdW0pIHJlc3VsdCA9IGNvbGxlY3Rpb25bKytpbmRleF0nCiAgICB9LAogICAgJ2luTG9vcCc6IHsKICAgICAgJ2FycmF5JzoKICAgICAgICAncmVzdWx0ID0gY2FsbGJhY2socmVzdWx0LCBpdGVyYXRlZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKScsCiAgICAgICdvYmplY3QnOgogICAgICAgICdyZXN1bHQgPSBub2FjY3VtXG4nICsKICAgICAgICAnICA/IChub2FjY3VtID0gZmFsc2UsIGl0ZXJhdGVlW2luZGV4XSlcbicgKwogICAgICAgICcgIDogY2FsbGJhY2socmVzdWx0LCBpdGVyYXRlZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKScKICAgIH0KICB9KTsKCiAgLyoqCiAgICogVGhlIHJpZ2h0LWFzc29jaWF0aXZlIHZlcnNpb24gb2YgYF8ucmVkdWNlYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBmb2xkcgogICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fFN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthY2N1bXVsYXRvcl0gSW5pdGlhbCB2YWx1ZSBvZiB0aGUgYWNjdW11bGF0b3IuCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgYWNjdW11bGF0ZWQgdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBsaXN0ID0gW1swLCAxXSwgWzIsIDNdLCBbNCwgNV1dOwogICAqIHZhciBmbGF0ID0gXy5yZWR1Y2VSaWdodChsaXN0LCBmdW5jdGlvbihhLCBiKSB7IHJldHVybiBhLmNvbmNhdChiKTsgfSwgW10pOwogICAqIC8vID0+IFs0LCA1LCAyLCAzLCAwLCAxXQogICAqLwogIGZ1bmN0aW9uIHJlZHVjZVJpZ2h0KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCBhY2N1bXVsYXRvciwgdGhpc0FyZykgewogICAgaWYgKCFjb2xsZWN0aW9uKSB7CiAgICAgIHJldHVybiBhY2N1bXVsYXRvcjsKICAgIH0KCiAgICB2YXIgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGgsCiAgICAgICAgbm9hY2N1bSA9IGFyZ3VtZW50cy5sZW5ndGggPCAzOwoKICAgIGlmKHRoaXNBcmcpIHsKICAgICAgY2FsbGJhY2sgPSBpdGVyYXRvckJpbmQoY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgfQogICAgaWYgKGxlbmd0aCA9PT0gbGVuZ3RoID4+PiAwKSB7CiAgICAgIHZhciBpdGVyYXRlZSA9IG5vQ2hhckJ5SW5kZXggJiYgdG9TdHJpbmcuY2FsbChjb2xsZWN0aW9uKSA9PSBzdHJpbmdDbGFzcwogICAgICAgID8gY29sbGVjdGlvbi5zcGxpdCgnJykKICAgICAgICA6IGNvbGxlY3Rpb247CgogICAgICBpZiAobGVuZ3RoICYmIG5vYWNjdW0pIHsKICAgICAgICBhY2N1bXVsYXRvciA9IGl0ZXJhdGVlWy0tbGVuZ3RoXTsKICAgICAgfQogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICBhY2N1bXVsYXRvciA9IGNhbGxiYWNrKGFjY3VtdWxhdG9yLCBpdGVyYXRlZVtsZW5ndGhdLCBsZW5ndGgsIGNvbGxlY3Rpb24pOwogICAgICB9CiAgICAgIHJldHVybiBhY2N1bXVsYXRvcjsKICAgIH0KCiAgICB2YXIgcHJvcCwKICAgICAgICBwcm9wcyA9IGtleXMoY29sbGVjdGlvbik7CgogICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwogICAgaWYgKGxlbmd0aCAmJiBub2FjY3VtKSB7CiAgICAgIGFjY3VtdWxhdG9yID0gY29sbGVjdGlvbltwcm9wc1stLWxlbmd0aF1dOwogICAgfQogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIHByb3AgPSBwcm9wc1tsZW5ndGhdOwogICAgICBhY2N1bXVsYXRvciA9IGNhbGxiYWNrKGFjY3VtdWxhdG9yLCBjb2xsZWN0aW9uW3Byb3BdLCBwcm9wLCBjb2xsZWN0aW9uKTsKICAgIH0KICAgIHJldHVybiBhY2N1bXVsYXRvcjsKICB9CgogIC8qKgogICAqIFRoZSBvcHBvc2l0ZSBvZiBgXy5maWx0ZXJgLCB0aGlzIG1ldGhvZCByZXR1cm5zIHRoZSB2YWx1ZXMgb2YgYQogICAqIGBjb2xsZWN0aW9uYCB0aGF0IGBjYWxsYmFja2AgZG9lcyAqKm5vdCoqIHJldHVybiB0cnV0aHkgZm9yLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2suCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHZhbHVlcyB0aGF0IGRpZCAqKm5vdCoqIHBhc3MgdGhlIGNhbGxiYWNrIGNoZWNrLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgb2RkcyA9IF8ucmVqZWN0KFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAqIC8vID0+IFsxLCAzLCA1XQogICAqLwogIHZhciByZWplY3QgPSBjcmVhdGVJdGVyYXRvcihiYXNlSXRlcmF0b3JPcHRpb25zLCBmaWx0ZXJJdGVyYXRvck9wdGlvbnMsIHsKICAgICdpbkxvb3AnOiAnIScgKyBmaWx0ZXJJdGVyYXRvck9wdGlvbnMuaW5Mb29wCiAgfSk7CgogIC8qKgogICAqIENoZWNrcyBpZiB0aGUgYGNhbGxiYWNrYCByZXR1cm5zIGEgdHJ1dGh5IHZhbHVlIGZvciAqKmFueSoqIGVsZW1lbnQgb2YgYQogICAqIGBjb2xsZWN0aW9uYC4gVGhlIGZ1bmN0aW9uIHJldHVybnMgYXMgc29vbiBhcyBpdCBmaW5kcyBwYXNzaW5nIHZhbHVlLCBhbmQKICAgKiBkb2VzIG5vdCBpdGVyYXRlIG92ZXIgdGhlIGVudGlyZSBgY29sbGVjdGlvbmAuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvCiAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggMyBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBhbnkKICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYW55IHZhbHVlIHBhc3NlcyB0aGUgY2FsbGJhY2sgY2hlY2ssIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5zb21lKFtudWxsLCAwLCAneWVzJywgZmFsc2VdKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgdmFyIHNvbWUgPSBjcmVhdGVJdGVyYXRvcihiYXNlSXRlcmF0b3JPcHRpb25zLCBldmVyeUl0ZXJhdG9yT3B0aW9ucywgewogICAgJ2luaXQnOiAnZmFsc2UnLAogICAgJ2luTG9vcCc6IGV2ZXJ5SXRlcmF0b3JPcHRpb25zLmluTG9vcC5yZXBsYWNlKCchJywgJycpCiAgfSk7CgoKICAvKioKICAgKiBQcm9kdWNlcyBhIG5ldyBzb3J0ZWQgYXJyYXksIHNvcnRlZCBpbiBhc2NlbmRpbmcgb3JkZXIgYnkgdGhlIHJlc3VsdHMgb2YKICAgKiBydW5uaW5nIGVhY2ggZWxlbWVudCBvZiBgY29sbGVjdGlvbmAgdGhyb3VnaCBhIHRyYW5zZm9ybWF0aW9uIGBjYWxsYmFja2AuCiAgICogVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggMyBhcmd1bWVudHM7CiAgICogKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLiBUaGUgYGNhbGxiYWNrYCBhcmd1bWVudCBtYXkgYWxzbyBiZSB0aGUKICAgKiBuYW1lIG9mIGEgcHJvcGVydHkgdG8gc29ydCBieSAoZS5nLiAnbGVuZ3RoJykuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24gb3IKICAgKiAgcHJvcGVydHkgbmFtZSB0byBzb3J0IGJ5LgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2Ygc29ydGVkIHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5zb3J0QnkoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguc2luKG51bSk7IH0pOwogICAqIC8vID0+IFszLCAxLCAyXQogICAqCiAgICogXy5zb3J0QnkoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuc2luKG51bSk7IH0sIE1hdGgpOwogICAqIC8vID0+IFszLCAxLCAyXQogICAqCiAgICogXy5zb3J0QnkoWydsYXJyeScsICdicmVuZGFuJywgJ21vZSddLCAnbGVuZ3RoJyk7CiAgICogLy8gPT4gWydtb2UnLCAnbGFycnknLCAnYnJlbmRhbiddCiAgICovCiAgdmFyIHNvcnRCeSA9IGNyZWF0ZUl0ZXJhdG9yKGJhc2VJdGVyYXRvck9wdGlvbnMsIG1hcEl0ZXJhdG9yT3B0aW9ucywgewogICAgJ3RvcCc6CiAgICAgICdpZiAodHlwZW9mIGNhbGxiYWNrID09IFwnc3RyaW5nXCcpIHtcbicgKwogICAgICAnICB2YXIgcHJvcCA9IGNhbGxiYWNrO1xuJyArCiAgICAgICcgIGNhbGxiYWNrID0gZnVuY3Rpb24oY29sbGVjdGlvbikgeyByZXR1cm4gY29sbGVjdGlvbltwcm9wXSB9XG4nICsKICAgICAgJ31cbicgKwogICAgICAnZWxzZSBpZiAodGhpc0FyZykge1xuJyArCiAgICAgICcgIGNhbGxiYWNrID0gaXRlcmF0b3JCaW5kKGNhbGxiYWNrLCB0aGlzQXJnKVxuJyArCiAgICAgICd9JywKICAgICdpbkxvb3AnOiB7CiAgICAgICdhcnJheSc6CiAgICAgICAgJ3Jlc3VsdFtpbmRleF0gPSB7XG4nICsKICAgICAgICAnICBjcml0ZXJpYTogY2FsbGJhY2soaXRlcmF0ZWVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbiksXG4nICsKICAgICAgICAnICB2YWx1ZTogaXRlcmF0ZWVbaW5kZXhdXG4nICsKICAgICAgICAnfScsCiAgICAgICdvYmplY3QnOgogICAgICAgICdyZXN1bHQnICsgKGlzS2V5c0Zhc3QgPyAnW3Byb3BJbmRleF0gPSAnIDogJy5wdXNoJykgKyAnKHtcbicgKwogICAgICAgICcgIGNyaXRlcmlhOiBjYWxsYmFjayhpdGVyYXRlZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSxcbicgKwogICAgICAgICcgIHZhbHVlOiBpdGVyYXRlZVtpbmRleF1cbicgKwogICAgICAgICd9KScKICAgIH0sCiAgICAnYm90dG9tJzoKICAgICAgJ3Jlc3VsdC5zb3J0KGNvbXBhcmVBc2NlbmRpbmcpO1xuJyArCiAgICAgICdsZW5ndGggPSByZXN1bHQubGVuZ3RoO1xuJyArCiAgICAgICd3aGlsZSAobGVuZ3RoLS0pIHtcbicgKwogICAgICAnICByZXN1bHRbbGVuZ3RoXSA9IHJlc3VsdFtsZW5ndGhdLnZhbHVlXG4nICsKICAgICAgJ30nCiAgfSk7CgogIC8qKgogICAqIENvbnZlcnRzIHRoZSBgY29sbGVjdGlvbmAsIGludG8gYW4gYXJyYXkuIFVzZWZ1bCBmb3IgY29udmVydGluZyB0aGUKICAgKiBgYXJndW1lbnRzYCBvYmplY3QuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gY29udmVydC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBjb252ZXJ0ZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpOyB9KSgxLCAyLCAzLCA0KTsKICAgKiAvLyA9PiBbMiwgMywgNF0KICAgKi8KICBmdW5jdGlvbiB0b0FycmF5KGNvbGxlY3Rpb24pIHsKICAgIGlmICghY29sbGVjdGlvbikgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICBpZiAoY29sbGVjdGlvbi50b0FycmF5ICYmIHRvU3RyaW5nLmNhbGwoY29sbGVjdGlvbi50b0FycmF5KSA9PSBmdW5jQ2xhc3MpIHsKICAgICAgcmV0dXJuIGNvbGxlY3Rpb24udG9BcnJheSgpOwogICAgfQogICAgdmFyIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwogICAgaWYgKGxlbmd0aCA9PT0gbGVuZ3RoID4+PiAwKSB7CiAgICAgIHJldHVybiAobm9BcnJheVNsaWNlT25TdHJpbmdzID8gdG9TdHJpbmcuY2FsbChjb2xsZWN0aW9uKSA9PSBzdHJpbmdDbGFzcyA6IHR5cGVvZiBjb2xsZWN0aW9uID09ICdzdHJpbmcnKQogICAgICAgID8gY29sbGVjdGlvbi5zcGxpdCgnJykKICAgICAgICA6IHNsaWNlLmNhbGwoY29sbGVjdGlvbik7CiAgICB9CiAgICByZXR1cm4gdmFsdWVzKGNvbGxlY3Rpb24pOwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIFByb2R1Y2VzIGEgbmV3IGFycmF5IHdpdGggYWxsIGZhbHNleSB2YWx1ZXMgb2YgYGFycmF5YCByZW1vdmVkLiBUaGUgdmFsdWVzCiAgICogYGZhbHNlYCwgYG51bGxgLCBgMGAsIGAiImAsIGB1bmRlZmluZWRgIGFuZCBgTmFOYCBhcmUgYWxsIGZhbHNleS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gY29tcGFjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgZmlsdGVyZWQgYXJyYXkuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uY29tcGFjdChbMCwgMSwgZmFsc2UsIDIsICcnLCAzXSk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICovCiAgZnVuY3Rpb24gY29tcGFjdChhcnJheSkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGlmIChhcnJheVtpbmRleF0pIHsKICAgICAgICByZXN1bHQucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogUHJvZHVjZXMgYSBuZXcgYXJyYXkgb2YgYGFycmF5YCB2YWx1ZXMgbm90IHByZXNlbnQgaW4gdGhlIG90aGVyIGFycmF5cwogICAqIHVzaW5nIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHByb2Nlc3MuCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5MSwgYXJyYXkyLCAuLi5dIEFycmF5cyB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgYGFycmF5YCB2YWx1ZXMgbm90IHByZXNlbnQgaW4gdGhlCiAgICogIG90aGVyIGFycmF5cy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5kaWZmZXJlbmNlKFsxLCAyLCAzLCA0LCA1XSwgWzUsIDIsIDEwXSk7CiAgICogLy8gPT4gWzEsIDMsIDRdCiAgICovCiAgZnVuY3Rpb24gZGlmZmVyZW5jZShhcnJheSkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoLAogICAgICAgIGZsYXR0ZW5lZCA9IGNvbmNhdC5hcHBseShyZXN1bHQsIGFyZ3VtZW50cyk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgaWYgKGluZGV4T2YoZmxhdHRlbmVkLCBhcnJheVtpbmRleF0sIGxlbmd0aCkgPCAwKSB7CiAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlbaW5kZXhdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIGZpcnN0IHZhbHVlIG9mIHRoZSBgYXJyYXlgLiBQYXNzIGBuYCB0byByZXR1cm4gdGhlIGZpcnN0IGBuYCB2YWx1ZXMKICAgKiBvZiB0aGUgYGFycmF5YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBoZWFkLCB0YWtlCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgKiBAcGFyYW0ge051bWJlcn0gW25dIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLgogICAqIEBwYXJhbSB7T2JqZWN0fSBbZ3VhcmRdIEludGVybmFsbHkgdXNlZCB0byBhbGxvdyB0aGlzIG1ldGhvZCB0byB3b3JrIHdpdGgKICAgKiAgb3RoZXJzIGxpa2UgYF8ubWFwYCB3aXRob3V0IHVzaW5nIHRoZWlyIGNhbGxiYWNrIGBpbmRleGAgYXJndW1lbnQgZm9yIGBuYC4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGZpcnN0IHZhbHVlIG9yIGFuIGFycmF5IG9mIHRoZSBmaXJzdCBgbmAgdmFsdWVzCiAgICogIG9mIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZmlyc3QoWzUsIDQsIDMsIDIsIDFdKTsKICAgKiAvLyA9PiA1CiAgICovCiAgZnVuY3Rpb24gZmlyc3QoYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkpIHsKICAgICAgcmV0dXJuIChuID09IG51bGwgfHwgZ3VhcmQpID8gYXJyYXlbMF0gOiBzbGljZS5jYWxsKGFycmF5LCAwLCBuKTsKICAgIH0KICB9CgogIC8qKgogICAqIEZsYXR0ZW5zIGEgbmVzdGVkIGFycmF5ICh0aGUgbmVzdGluZyBjYW4gYmUgdG8gYW55IGRlcHRoKS4gSWYgYHNoYWxsb3dgIGlzCiAgICogdHJ1dGh5LCBgYXJyYXlgIHdpbGwgb25seSBiZSBmbGF0dGVuZWQgYSBzaW5nbGUgbGV2ZWwuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGNvbXBhY3QuCiAgICogQHBhcmFtIHtCb29sZWFufSBzaGFsbG93IEEgZmxhZyB0byBpbmRpY2F0ZSBvbmx5IGZsYXR0ZW5pbmcgYSBzaW5nbGUgbGV2ZWwuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGZsYXR0ZW5lZCBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5mbGF0dGVuKFsxLCBbMl0sIFszLCBbWzRdXV1dKTsKICAgKiAvLyA9PiBbMSwgMiwgMywgNF07CiAgICoKICAgKiBfLmZsYXR0ZW4oWzEsIFsyXSwgWzMsIFtbNF1dXV0sIHRydWUpOwogICAqIC8vID0+IFsxLCAyLCAzLCBbWzRdXV07CiAgICovCiAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSwgc2hhbGxvdykgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgdmFyIHZhbHVlLAogICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdCwgc2hhbGxvdyA/IHZhbHVlIDogZmxhdHRlbih2YWx1ZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGB2YWx1ZWAgaXMgZm91bmQgdXNpbmcKICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiB0aGUgYGFycmF5YCBpcyBhbHJlYWR5CiAgICogc29ydGVkLCBwYXNzaW5nIGB0cnVlYCBmb3IgYGlzU29ydGVkYCB3aWxsIHJ1biBhIGZhc3RlciBiaW5hcnkgc2VhcmNoLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICogQHBhcmFtIHtCb29sZWFufE51bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc3RhcnQgc2VhcmNoaW5nIGZyb20gb3IKICAgKiAgYHRydWVgIHRvIHBlcmZvcm0gYSBiaW5hcnkgc2VhcmNoIG9uIGEgc29ydGVkIGBhcnJheWAuCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUgb3IgYC0xYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMik7CiAgICogLy8gPT4gMQogICAqCiAgICogXy5pbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMiwgMyk7CiAgICogLy8gPT4gNAogICAqCiAgICogXy5pbmRleE9mKFsxLCAxLCAyLCAyLCAzLCAzXSwgMiwgdHJ1ZSk7CiAgICogLy8gPT4gMgogICAqLwogIGZ1bmN0aW9uIGluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgIGlmIChmcm9tSW5kZXgpIHsKICAgICAgaWYgKHR5cGVvZiBmcm9tSW5kZXggPT0gJ251bWJlcicpIHsKICAgICAgICBpbmRleCA9IChmcm9tSW5kZXggPCAwID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgZnJvbUluZGV4KSA6IGZyb21JbmRleCkgLSAxOwogICAgICB9IGVsc2UgewogICAgICAgIGluZGV4ID0gc29ydGVkSW5kZXgoYXJyYXksIHZhbHVlKTsKICAgICAgICByZXR1cm4gYXJyYXlbaW5kZXhdID09PSB2YWx1ZSA/IGluZGV4IDogLTE7CiAgICAgIH0KICAgIH0KICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGlmIChhcnJheVtpbmRleF0gPT09IHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQoKICAvKioKICAgKiBHZXRzIGFsbCBidXQgdGhlIGxhc3QgdmFsdWUgb2YgYGFycmF5YC4gUGFzcyBgbmAgdG8gZXhjbHVkZSB0aGUgbGFzdCBgbmAKICAgKiB2YWx1ZXMgZnJvbSB0aGUgcmVzdWx0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgKiBAcGFyYW0ge051bWJlcn0gW25dIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLgogICAqIEBwYXJhbSB7T2JqZWN0fSBbZ3VhcmRdIEludGVybmFsbHkgdXNlZCB0byBhbGxvdyB0aGlzIG1ldGhvZCB0byB3b3JrIHdpdGgKICAgKiAgb3RoZXJzIGxpa2UgYF8ubWFwYCB3aXRob3V0IHVzaW5nIHRoZWlyIGNhbGxiYWNrIGBpbmRleGAgYXJndW1lbnQgZm9yIGBuYC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYWxsIGJ1dCB0aGUgbGFzdCB2YWx1ZSBvciBgbmAgdmFsdWVzIG9mIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaW5pdGlhbChbMywgMiwgMV0pOwogICAqIC8vID0+IFszLCAyXQogICAqLwogIGZ1bmN0aW9uIGluaXRpYWwoYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoIWFycmF5KSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCAtKChuID09IG51bGwgfHwgZ3VhcmQpID8gMSA6IG4pKTsKICB9CgogIC8qKgogICAqIENvbXB1dGVzIHRoZSBpbnRlcnNlY3Rpb24gb2YgYWxsIHRoZSBwYXNzZWQtaW4gYXJyYXlzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheTEsIGFycmF5MiwgLi4uXSBBcnJheXMgdG8gcHJvY2Vzcy4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdW5pcXVlIHZhbHVlcywgaW4gb3JkZXIsIHRoYXQgYXJlCiAgICogIHByZXNlbnQgaW4gKiphbGwqKiBvZiB0aGUgYXJyYXlzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmludGVyc2VjdGlvbihbMSwgMiwgM10sIFsxMDEsIDIsIDEsIDEwXSwgWzIsIDFdKTsKICAgKiAvLyA9PiBbMSwgMl0KICAgKi8KICBmdW5jdGlvbiBpbnRlcnNlY3Rpb24oYXJyYXkpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciB2YWx1ZSwKICAgICAgICBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICBvdGhlcnMgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgIGlmIChpbmRleE9mKHJlc3VsdCwgdmFsdWUpIDwgMCAmJgogICAgICAgICAgZXZlcnkob3RoZXJzLCBmdW5jdGlvbihvdGhlcikgeyByZXR1cm4gaW5kZXhPZihvdGhlciwgdmFsdWUpID4gLTE7IH0pKSB7CiAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogR2V0cyB0aGUgbGFzdCB2YWx1ZSBvZiB0aGUgYGFycmF5YC4gUGFzcyBgbmAgdG8gcmV0dXJuIHRoZSBsYXN5IGBuYCB2YWx1ZXMKICAgKiBvZiB0aGUgYGFycmF5YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICogQHBhcmFtIHtOdW1iZXJ9IFtuXSBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIHJldHVybi4KICAgKiBAcGFyYW0ge09iamVjdH0gW2d1YXJkXSBJbnRlcm5hbGx5IHVzZWQgdG8gYWxsb3cgdGhpcyBtZXRob2QgdG8gd29yayB3aXRoCiAgICogIG90aGVycyBsaWtlIGBfLm1hcGAgd2l0aG91dCB1c2luZyB0aGVpciBjYWxsYmFjayBgaW5kZXhgIGFyZ3VtZW50IGZvciBgbmAuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSBsYXN0IHZhbHVlIG9yIGFuIGFycmF5IG9mIHRoZSBsYXN0IGBuYCB2YWx1ZXMKICAgKiAgb2YgYGFycmF5YC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5sYXN0KFszLCAyLCAxXSk7CiAgICogLy8gPT4gMQogICAqLwogIGZ1bmN0aW9uIGxhc3QoYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgcmV0dXJuIChuID09IG51bGwgfHwgZ3VhcmQpID8gYXJyYXlbbGVuZ3RoIC0gMV0gOiBzbGljZS5jYWxsKGFycmF5LCAtbiB8fCBsZW5ndGgpOwogICAgfQogIH0KCiAgLyoqCiAgICogR2V0cyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIGxhc3Qgb2NjdXJyZW5jZSBvZiBgdmFsdWVgIGlzIGZvdW5kIHVzaW5nCiAgICogc3RyaWN0IGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEBwYXJhbSB7TnVtYmVyfSBbZnJvbUluZGV4PWFycmF5Lmxlbmd0aC0xXSBUaGUgaW5kZXggdG8gc3RhcnQgc2VhcmNoaW5nIGZyb20uCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUgb3IgYC0xYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5sYXN0SW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIpOwogICAqIC8vID0+IDQKICAgKgogICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyLCAzKTsKICAgKiAvLyA9PiAxCiAgICovCiAgZnVuY3Rpb24gbGFzdEluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgIGlmICghYXJyYXkpIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogICAgdmFyIGluZGV4ID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGZyb21JbmRleCAmJiB0eXBlb2YgZnJvbUluZGV4ID09ICdudW1iZXInKSB7CiAgICAgIGluZGV4ID0gKGZyb21JbmRleCA8IDAgPyBNYXRoLm1heCgwLCBpbmRleCArIGZyb21JbmRleCkgOiBNYXRoLm1pbihmcm9tSW5kZXgsIGluZGV4IC0gMSkpICsgMTsKICAgIH0KICAgIHdoaWxlIChpbmRleC0tKSB7CiAgICAgIGlmIChhcnJheVtpbmRleF0gPT09IHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQoKICAvKioKICAgKiBSZXRyaWV2ZXMgdGhlIG1heGltdW0gdmFsdWUgb2YgYW4gYGFycmF5YC4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsCiAgICogaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IgZWFjaCB2YWx1ZSBpbiB0aGUgYGFycmF5YCB0byBnZW5lcmF0ZSB0aGUKICAgKiBjcml0ZXJpb24gYnkgd2hpY2ggdGhlIHZhbHVlIGlzIHJhbmtlZC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8KICAgKiBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCAzIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgbWF4aW11bSB2YWx1ZS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIHN0b29nZXMgPSBbCiAgICogICB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LAogICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9LAogICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICogXTsKICAgKgogICAqIF8ubWF4KHN0b29nZXMsIGZ1bmN0aW9uKHN0b29nZSkgeyByZXR1cm4gc3Rvb2dlLmFnZTsgfSk7CiAgICogLy8gPT4geyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9OwogICAqLwogIGZ1bmN0aW9uIG1heChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBjb21wdXRlZCA9IC1JbmZpbml0eSwKICAgICAgICByZXN1bHQgPSBjb21wdXRlZDsKCiAgICBpZiAoIWFycmF5KSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICB2YXIgY3VycmVudCwKICAgICAgICBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKGFycmF5W2luZGV4XSA+IHJlc3VsdCkgewogICAgICAgICAgcmVzdWx0ID0gYXJyYXlbaW5kZXhdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgaWYgKHRoaXNBcmcpIHsKICAgICAgY2FsbGJhY2sgPSBpdGVyYXRvckJpbmQoY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgfQogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgY3VycmVudCA9IGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KTsKICAgICAgaWYgKGN1cnJlbnQgPiBjb21wdXRlZCkgewogICAgICAgIGNvbXB1dGVkID0gY3VycmVudDsKICAgICAgICByZXN1bHQgPSBhcnJheVtpbmRleF07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBSZXRyaWV2ZXMgdGhlIG1pbmltdW0gdmFsdWUgb2YgYW4gYGFycmF5YC4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsCiAgICogaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IgZWFjaCB2YWx1ZSBpbiB0aGUgYGFycmF5YCB0byBnZW5lcmF0ZSB0aGUKICAgKiBjcml0ZXJpb24gYnkgd2hpY2ggdGhlIHZhbHVlIGlzIHJhbmtlZC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgCiAgICogYW5kIGludm9rZWQgd2l0aCAzIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgbWluaW11bSB2YWx1ZS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5taW4oWzEwLCA1LCAxMDAsIDIsIDEwMDBdKTsKICAgKiAvLyA9PiAyCiAgICovCiAgZnVuY3Rpb24gbWluKGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgdmFyIGNvbXB1dGVkID0gSW5maW5pdHksCiAgICAgICAgcmVzdWx0ID0gY29tcHV0ZWQ7CgogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgdmFyIGN1cnJlbnQsCiAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgaWYgKCFjYWxsYmFjaykgewogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGlmIChhcnJheVtpbmRleF0gPCByZXN1bHQpIHsKICAgICAgICAgIHJlc3VsdCA9IGFycmF5W2luZGV4XTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGlmICh0aGlzQXJnKSB7CiAgICAgIGNhbGxiYWNrID0gaXRlcmF0b3JCaW5kKGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgIH0KICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGN1cnJlbnQgPSBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSk7CiAgICAgIGlmIChjdXJyZW50IDwgY29tcHV0ZWQpIHsKICAgICAgICBjb21wdXRlZCA9IGN1cnJlbnQ7CiAgICAgICAgcmVzdWx0ID0gYXJyYXlbaW5kZXhdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiBudW1iZXJzIChwb3NpdGl2ZSBhbmQvb3IgbmVnYXRpdmUpIHByb2dyZXNzaW5nIGZyb20KICAgKiBgc3RhcnRgIHVwIHRvIGJ1dCBub3QgaW5jbHVkaW5nIGBzdG9wYC4gVGhpcyBtZXRob2QgaXMgYSBwb3J0IG9mIFB5dGhvbidzCiAgICogYHJhbmdlKClgIGZ1bmN0aW9uLiBTZWUgaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7TnVtYmVyfSBbc3RhcnQ9MF0gVGhlIHN0YXJ0IG9mIHRoZSByYW5nZS4KICAgKiBAcGFyYW0ge051bWJlcn0gZW5kIFRoZSBlbmQgb2YgdGhlIHJhbmdlLgogICAqIEBwYXJhbSB7TnVtYmVyfSBbc3RlcD0xXSBUaGUgdmFsdWUgdG8gaW5jcmVtZW50IG9yIGRlc2NyZW1lbnQgYnkuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IHJhbmdlIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnJhbmdlKDEwKTsKICAgKiAvLyA9PiBbMCwgMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOV0KICAgKgogICAqIF8ucmFuZ2UoMSwgMTEpOwogICAqIC8vID0+IFsxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAxMF0KICAgKgogICAqIF8ucmFuZ2UoMCwgMzAsIDUpOwogICAqIC8vID0+IFswLCA1LCAxMCwgMTUsIDIwLCAyNV0KICAgKgogICAqIF8ucmFuZ2UoMCwgLTEwLCAtMSk7CiAgICogLy8gPT4gWzAsIC0xLCAtMiwgLTMsIC00LCAtNSwgLTYsIC03LCAtOCwgLTldCiAgICoKICAgKiBfLnJhbmdlKDApOwogICAqIC8vID0+IFtdCiAgICovCiAgZnVuY3Rpb24gcmFuZ2Uoc3RhcnQsIGVuZCwgc3RlcCkgewogICAgc3RlcCB8fCAoc3RlcCA9IDEpOwogICAgaWYgKGVuZCA9PSBudWxsKSB7CiAgICAgIGVuZCA9IHN0YXJ0IHx8IDA7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIC8vIHVzZSBgQXJyYXkobGVuZ3RoKWAgc28gVjggd2lsbCBhdm9pZCB0aGUgc2xvd2VyICJkaWN0aW9uYXJ5IiBtb2RlCiAgICAvLyBodHRwOi8vd3d3LnlvdXR1YmUuY29tL3dhdGNoP3Y9WEFxSXBHVThaWmsjdD0xNm0yN3MKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IE1hdGgubWF4KDAsIE1hdGguY2VpbCgoZW5kIC0gc3RhcnQpIC8gc3RlcCkpLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIFRoZSBvcHBvc2l0ZSBvZiBgXy5pbml0aWFsYCwgdGhpcyBtZXRob2QgZ2V0cyBhbGwgYnV0IHRoZSBmaXJzdCB2YWx1ZSBvZgogICAqIGBhcnJheWAuIFBhc3MgYG5gIHRvIGV4Y2x1ZGUgdGhlIGZpcnN0IGBuYCB2YWx1ZXMgZnJvbSB0aGUgcmVzdWx0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIHRhaWwKICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAqIEBwYXJhbSB7TnVtYmVyfSBbbl0gVGhlIG51bWJlciBvZiBlbGVtZW50cyB0byByZXR1cm4uCiAgICogQHBhcmFtIHtPYmplY3R9IFtndWFyZF0gSW50ZXJuYWxseSB1c2VkIHRvIGFsbG93IHRoaXMgbWV0aG9kIHRvIHdvcmsgd2l0aAogICAqICBvdGhlcnMgbGlrZSBgXy5tYXBgIHdpdGhvdXQgdXNpbmcgdGhlaXIgY2FsbGJhY2sgYGluZGV4YCBhcmd1bWVudCBmb3IgYG5gLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbGwgYnV0IHRoZSBmaXJzdCB2YWx1ZSBvciBgbmAgdmFsdWVzIG9mIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8ucmVzdChbMywgMiwgMV0pOwogICAqIC8vID0+IFsyLCAxXQogICAqLwogIGZ1bmN0aW9uIHJlc3QoYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoIWFycmF5KSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAobiA9PSBudWxsIHx8IGd1YXJkKSA/IDEgOiBuKTsKICB9CgogIC8qKgogICAqIFByb2R1Y2VzIGEgbmV3IGFycmF5IG9mIHNodWZmbGVkIGBhcnJheWAgdmFsdWVzLCB1c2luZyBhIHZlcnNpb24gb2YgdGhlCiAgICogRmlzaGVyLVlhdGVzIHNodWZmbGUuIFNlZSBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Zpc2hlci1ZYXRlc19zaHVmZmxlLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzaHVmZmxlLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBzaHVmZmxlZCBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5zaHVmZmxlKFsxLCAyLCAzLCA0LCA1LCA2XSk7CiAgICogLy8gPT4gWzQsIDEsIDYsIDMsIDUsIDJdCiAgICovCiAgZnVuY3Rpb24gc2h1ZmZsZShhcnJheSkgewogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICB2YXIgcmFuZCwKICAgICAgICBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJhbmQgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoaW5kZXggKyAxKSk7CiAgICAgIHJlc3VsdFtpbmRleF0gPSByZXN1bHRbcmFuZF07CiAgICAgIHJlc3VsdFtyYW5kXSA9IGFycmF5W2luZGV4XTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBVc2VzIGEgYmluYXJ5IHNlYXJjaCB0byBkZXRlcm1pbmUgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoIHRoZSBgdmFsdWVgCiAgICogc2hvdWxkIGJlIGluc2VydGVkIGludG8gYGFycmF5YCBpbiBvcmRlciB0byBtYWludGFpbiB0aGUgc29ydCBvcmRlciBvZiB0aGUKICAgKiBzb3J0ZWQgYGFycmF5YC4gSWYgYGNhbGxiYWNrYCBpcyBwYXNzZWQsIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGB2YWx1ZWAgYW5kCiAgICogZWFjaCBlbGVtZW50IGluIGBhcnJheWAgdG8gY29tcHV0ZSB0aGVpciBzb3J0IHJhbmtpbmcuIFRoZSBgY2FsbGJhY2tgIGlzCiAgICogYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggMSBhcmd1bWVudDsgKHZhbHVlKS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBldmFsdWF0ZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2suCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIHZhbHVlIHNob3VsZCBiZSBpbnNlcnRlZAogICAqICBpbnRvIGBhcnJheWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uc29ydGVkSW5kZXgoWzIwLCAzMCwgNDBdLCAzNSk7CiAgICogLy8gPT4gMgogICAqCiAgICogdmFyIGRpY3QgPSB7CiAgICogICAnd29yZFRvTnVtYmVyJzogeyAndHdlbnR5JzogMjAsICd0aGlydHknOiAzMCwgJ3RoaXJ0eS1maXZlJzogMzUsICdmb3VydHknOiA0MCB9CiAgICogfTsKICAgKgogICAqIF8uc29ydGVkSW5kZXgoWyd0d2VudHknLCAndGhpcnR5JywgJ2ZvdXJ0eSddLCAndGhpcnR5LWZpdmUnLCBmdW5jdGlvbih3b3JkKSB7CiAgICogICByZXR1cm4gZGljdC53b3JkVG9OdW1iZXJbd29yZF07CiAgICogfSk7CiAgICogLy8gPT4gMgogICAqCiAgICogXy5zb3J0ZWRJbmRleChbJ3R3ZW50eScsICd0aGlydHknLCAnZm91cnR5J10sICd0aGlydHktZml2ZScsIGZ1bmN0aW9uKHdvcmQpIHsKICAgKiAgIHJldHVybiB0aGlzLndvcmRUb051bWJlclt3b3JkXTsKICAgKiB9LCBkaWN0KTsKICAgKiAvLyA9PiAyCiAgICovCiAgZnVuY3Rpb24gc29ydGVkSW5kZXgoYXJyYXksIHZhbHVlLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIHZhciBtaWQsCiAgICAgICAgbG93ID0gMCwKICAgICAgICBoaWdoID0gYXJyYXkubGVuZ3RoOwoKICAgIGlmIChjYWxsYmFjaykgewogICAgICBpZiAodGhpc0FyZykgewogICAgICAgIGNhbGxiYWNrID0gYmluZChjYWxsYmFjaywgdGhpc0FyZyk7CiAgICAgIH0KICAgICAgdmFsdWUgPSBjYWxsYmFjayh2YWx1ZSk7CiAgICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgICAgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICAgIGNhbGxiYWNrKGFycmF5W21pZF0pIDwgdmFsdWUgPyBsb3cgPSBtaWQgKyAxIDogaGlnaCA9IG1pZDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgICBtaWQgPSAobG93ICsgaGlnaCkgPj4+IDE7CiAgICAgICAgYXJyYXlbbWlkXSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBsb3c7CiAgfQoKICAvKioKICAgKiBDb21wdXRlcyB0aGUgdW5pb24gb2YgdGhlIHBhc3NlZC1pbiBhcnJheXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5MSwgYXJyYXkyLCAuLi5dIEFycmF5cyB0byBwcm9jZXNzLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiB1bmlxdWUgdmFsdWVzLCBpbiBvcmRlciwgdGhhdCBhcmUKICAgKiAgcHJlc2VudCBpbiBvbmUgb3IgbW9yZSBvZiB0aGUgYXJyYXlzLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnVuaW9uKFsxLCAyLCAzXSwgWzEwMSwgMiwgMSwgMTBdLCBbMiwgMV0pOwogICAqIC8vID0+IFsxLCAyLCAzLCAxMDEsIDEwXQogICAqLwogIGZ1bmN0aW9uIHVuaW9uKCkgewogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgcmVzdWx0ID0gW10sCiAgICAgICAgZmxhdHRlbmVkID0gY29uY2F0LmFwcGx5KHJlc3VsdCwgYXJndW1lbnRzKSwKICAgICAgICBsZW5ndGggPSBmbGF0dGVuZWQubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGlmIChpbmRleE9mKHJlc3VsdCwgZmxhdHRlbmVkW2luZGV4XSkgPCAwKSB7CiAgICAgICAgcmVzdWx0LnB1c2goZmxhdHRlbmVkW2luZGV4XSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBQcm9kdWNlcyBhIGR1cGxpY2F0ZS12YWx1ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGBhcnJheWAgdXNpbmcgc3RyaWN0IGVxdWFsaXR5CiAgICogZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiB0aGUgYGFycmF5YCBpcyBhbHJlYWR5IHNvcnRlZCwgcGFzc2luZyBgdHJ1ZWAKICAgKiBmb3IgYGlzU29ydGVkYCB3aWxsIHJ1biBhIGZhc3RlciBhbGdvcml0aG0uIElmIGBjYWxsYmFja2AgaXMgcGFzc2VkLAogICAqIGVhY2ggdmFsdWUgb2YgYGFycmF5YCBpcyBwYXNzZWQgdGhyb3VnaCBhIHRyYW5zZm9ybWF0aW9uIGBjYWxsYmFja2AgYmVmb3JlCiAgICogdW5pcXVlbmVzcyBpcyBjb21wdXRlZC4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkCiAgICogd2l0aCAzIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGFsaWFzIHVuaXF1ZQogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcHJvY2Vzcy4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtpc1NvcnRlZD1mYWxzZV0gQSBmbGFnIHRvIGluZGljYXRlIHRoYXQgdGhlIGBhcnJheWAgaXMgYWxyZWFkeSBzb3J0ZWQuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIGR1cGxpY2F0ZS12YWx1ZS1mcmVlIGFycmF5LgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLnVuaXEoWzEsIDIsIDEsIDMsIDFdKTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKgogICAqIF8udW5pcShbMSwgMSwgMiwgMiwgM10sIHRydWUpOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqCiAgICogXy51bmlxKFsxLCAyLCAxLjUsIDMsIDIuNV0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gTWF0aC5mbG9vcihudW0pOyB9KTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKgogICAqIF8udW5pcShbMSwgMiwgMS41LCAzLCAyLjVdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICovCiAgZnVuY3Rpb24gdW5pcShhcnJheSwgaXNTb3J0ZWQsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBpZiAoIWFycmF5KSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICB2YXIgY29tcHV0ZWQsCiAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGgsCiAgICAgICAgc2VlbiA9IFtdOwoKICAgIC8vIGp1Z2dsZSBhcmd1bWVudHMKICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aGlzQXJnID0gY2FsbGJhY2s7CiAgICAgIGNhbGxiYWNrID0gaXNTb3J0ZWQ7CiAgICAgIGlzU29ydGVkID0gZmFsc2U7CiAgICB9CiAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgIGNhbGxiYWNrID0gaWRlbnRpdHk7CiAgICB9IGVsc2UgaWYgKHRoaXNBcmcpIHsKICAgICAgY2FsbGJhY2sgPSBpdGVyYXRvckJpbmQoY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgfQogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgY29tcHV0ZWQgPSBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSk7CiAgICAgIGlmIChpc1NvcnRlZAogICAgICAgICAgICA/ICFpbmRleCB8fCBzZWVuW3NlZW4ubGVuZ3RoIC0gMV0gIT09IGNvbXB1dGVkCiAgICAgICAgICAgIDogaW5kZXhPZihzZWVuLCBjb21wdXRlZCkgPCAwCiAgICAgICAgICApIHsKICAgICAgICBzZWVuLnB1c2goY29tcHV0ZWQpOwogICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2luZGV4XSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBQcm9kdWNlcyBhIG5ldyBhcnJheSB3aXRoIGFsbCBvY2N1cnJlbmNlcyBvZiB0aGUgcGFzc2VkIHZhbHVlcyByZW1vdmVkIHVzaW5nCiAgICogc3RyaWN0IGVxdWFsaXR5IGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gZmlsdGVyLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt2YWx1ZTEsIHZhbHVlMiwgLi4uXSBWYWx1ZXMgdG8gcmVtb3ZlLgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBmaWx0ZXJlZCBhcnJheS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy53aXRob3V0KFsxLCAyLCAxLCAwLCAzLCAxLCA0XSwgMCwgMSk7CiAgICogLy8gPT4gWzIsIDMsIDRdCiAgICovCiAgZnVuY3Rpb24gd2l0aG91dChhcnJheSkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIGlmIChpbmRleE9mKGFyZ3VtZW50cywgYXJyYXlbaW5kZXhdLCAxKSA8IDApIHsKICAgICAgICByZXN1bHQucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgICogTWVyZ2VzIHRoZSBlbGVtZW50cyBvZiBlYWNoIGFycmF5IGF0IHRoZWlyIGNvcnJlc3BvbmRpbmcgaW5kZXhlcy4gVXNlZnVsIGZvcgogICAqIHNlcGFyYXRlIGRhdGEgc291cmNlcyB0aGF0IGFyZSBjb29yZGluYXRlZCB0aHJvdWdoIG1hdGNoaW5nIGFycmF5IGluZGV4ZXMuCiAgICogRm9yIGEgbWF0cml4IG9mIG5lc3RlZCBhcnJheXMsIGBfLnppcC5hcHBseSguLi4pYCBjYW4gdHJhbnNwb3NlIHRoZSBtYXRyaXgKICAgKiBpbiBhIHNpbWlsYXIgZmFzaGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBBcnJheXMKICAgKiBAcGFyYW0ge0FycmF5fSBbYXJyYXkxLCBhcnJheTIsIC4uLl0gQXJyYXlzIHRvIHByb2Nlc3MuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIG1lcmdlZCBhcnJheXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uemlwKFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10sIFszMCwgNDAsIDUwXSwgW3RydWUsIGZhbHNlLCBmYWxzZV0pOwogICAqIC8vID0+IFtbJ21vZScsIDMwLCB0cnVlXSwgWydsYXJyeScsIDQwLCBmYWxzZV0sIFsnY3VybHknLCA1MCwgZmFsc2VdXQogICAqLwogIGZ1bmN0aW9uIHppcChhcnJheSkgewogICAgaWYgKCFhcnJheSkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBtYXgocGx1Y2soYXJndW1lbnRzLCAnbGVuZ3RoJykpLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2luZGV4XSA9IHBsdWNrKGFyZ3VtZW50cywgaW5kZXgpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIE1lcmdlcyBhbiBhcnJheSBvZiBga2V5c2AgYW5kIGFuIGFycmF5IG9mIGB2YWx1ZXNgIGludG8gYSBzaW5nbGUgb2JqZWN0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEFycmF5cwogICAqIEBwYXJhbSB7QXJyYXl9IGtleXMgVGhlIGFycmF5IG9mIGtleXMuCiAgICogQHBhcmFtIHtBcnJheX0gW3ZhbHVlcz1bXV0gVGhlIGFycmF5IG9mIHZhbHVlcy4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgZ2l2ZW4ga2V5cyBhbmQKICAgKiAgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uemlwT2JqZWN0KFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10sIFszMCwgNDAsIDUwXSk7CiAgICogLy8gPT4geyAnbW9lJzogMzAsICdsYXJyeSc6IDQwLCAnY3VybHknOiA1MCB9CiAgICovCiAgZnVuY3Rpb24gemlwT2JqZWN0KGtleXMsIHZhbHVlcykgewogICAgaWYgKCFrZXlzKSB7CiAgICAgIHJldHVybiB7fTsKICAgIH0KICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGtleXMubGVuZ3RoLAogICAgICAgIHJlc3VsdCA9IHt9OwoKICAgIHZhbHVlcyB8fCAodmFsdWVzID0gW10pOwogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0W2tleXNbaW5kZXhdXSA9IHZhbHVlc1tpbmRleF07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgZnVuY3Rpb24gdGhhdCBpcyByZXN0cmljdGVkIHRvIGV4ZWN1dGluZyBvbmx5IGFmdGVyIGl0IGlzCiAgICogY2FsbGVkIGBuYCB0aW1lcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge051bWJlcn0gbiBUaGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBmdW5jdGlvbiBtdXN0IGJlIGNhbGxlZCBiZWZvcmUKICAgKiBpdCBpcyBleGVjdXRlZC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byByZXN0cmljdC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgcmVuZGVyTm90ZXMgPSBfLmFmdGVyKG5vdGVzLmxlbmd0aCwgcmVuZGVyKTsKICAgKiBfLmZvckVhY2gobm90ZXMsIGZ1bmN0aW9uKG5vdGUpIHsKICAgKiAgIG5vdGUuYXN5bmNTYXZlKHsgJ3N1Y2Nlc3MnOiByZW5kZXJOb3RlcyB9KTsKICAgKiB9KTsKICAgKiAvLyBgcmVuZGVyTm90ZXNgIGlzIHJ1biBvbmNlLCBhZnRlciBhbGwgbm90ZXMgaGF2ZSBzYXZlZAogICAqLwogIGZ1bmN0aW9uIGFmdGVyKG4sIGZ1bmMpIHsKICAgIGlmIChuIDwgMSkgewogICAgICByZXR1cm4gZnVuYygpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoLS1uIDwgMSkgewogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBpbnZva2VzIGBmdW5jYCB3aXRoIHRoZSBgdGhpc2AKICAgKiBiaW5kaW5nIG9mIGB0aGlzQXJnYCBhbmQgcHJlcGVuZHMgYW55IGFkZGl0aW9uYWwgYGJpbmRgIGFyZ3VtZW50cyB0byB0aG9zZQogICAqIHBhc3NlZCB0byB0aGUgYm91bmQgZnVuY3Rpb24uIExhenkgZGVmaW5lZCBtZXRob2RzIG1heSBiZSBib3VuZCBieSBwYXNzaW5nCiAgICogdGhlIG9iamVjdCB0aGV5IGFyZSBib3VuZCB0byBhcyBgZnVuY2AgYW5kIHRoZSBtZXRob2QgbmFtZSBhcyBgdGhpc0FyZ2AuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R9IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGJpbmQgb3IgdGhlIG9iamVjdCB0aGUgbWV0aG9kIGJlbG9uZ3MgdG8uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgZnVuY2Agb3IgdGhlIG1ldGhvZCBuYW1lLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogLy8gYmFzaWMgYmluZAogICAqIHZhciBmdW5jID0gZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgKiAgIHJldHVybiBncmVldGluZyArICcgJyArIHRoaXMubmFtZTsKICAgKiB9OwogICAqCiAgICogZnVuYyA9IF8uYmluZChmdW5jLCB7ICduYW1lJzogJ21vZScgfSwgJ2hpJyk7CiAgICogZnVuYygpOwogICAqIC8vID0+ICdoaSBtb2UnCiAgICoKICAgKiAvLyBsYXp5IGJpbmQKICAgKiB2YXIgb2JqZWN0ID0gewogICAqICAgJ25hbWUnOiAnbW9lJywKICAgKiAgICdncmVldCc6IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICogICAgIHJldHVybiBncmVldGluZyArICcgJyArIHRoaXMubmFtZTsKICAgKiAgIH0KICAgKiB9OwogICAqCiAgICogdmFyIGZ1bmMgPSBfLmJpbmQob2JqZWN0LCAnZ3JlZXQnLCAnaGknKTsKICAgKiBmdW5jKCk7CiAgICogLy8gPT4gJ2hpIG1vZScKICAgKgogICAqIG9iamVjdC5ncmVldCA9IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnLCAnICsgdGhpcy5uYW1lICsgJyEnOwogICAqIH07CiAgICoKICAgKiBmdW5jKCk7CiAgICogLy8gPT4gJ2hpLCBtb2UhJwogICAqLwogIGZ1bmN0aW9uIGJpbmQoZnVuYywgdGhpc0FyZykgewogICAgdmFyIG1ldGhvZE5hbWUsCiAgICAgICAgaXNGdW5jID0gdG9TdHJpbmcuY2FsbChmdW5jKSA9PSBmdW5jQ2xhc3M7CgogICAgLy8ganVnZ2xlIGFyZ3VtZW50cwogICAgaWYgKCFpc0Z1bmMpIHsKICAgICAgbWV0aG9kTmFtZSA9IHRoaXNBcmc7CiAgICAgIHRoaXNBcmcgPSBmdW5jOwogICAgfQogICAgLy8gdXNlIGBGdW5jdGlvbiNiaW5kYCBpZiBpdCBleGlzdHMgYW5kIGlzIGZhc3QKICAgIC8vIChpbiBWOCBgRnVuY3Rpb24jYmluZGAgaXMgc2xvd2VyIGV4Y2VwdCB3aGVuIHBhcnRpYWxseSBhcHBsaWVkKQogICAgZWxzZSBpZiAoaXNCaW5kRmFzdCB8fCAobmF0aXZlQmluZCAmJiBhcmd1bWVudHMubGVuZ3RoID4gMikpIHsKICAgICAgcmV0dXJuIG5hdGl2ZUJpbmQuY2FsbC5hcHBseShuYXRpdmVCaW5kLCBhcmd1bWVudHMpOwogICAgfQoKICAgIHZhciBwYXJ0aWFsQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKCiAgICBmdW5jdGlvbiBib3VuZCgpIHsKICAgICAgLy8gYEZ1bmN0aW9uI2JpbmRgIHNwZWMKICAgICAgLy8gaHR0cDovL2VzNS5naXRodWIuY29tLyN4MTUuMy40LjUKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICB0aGlzQmluZGluZyA9IHRoaXNBcmc7CgogICAgICBpZiAoIWlzRnVuYykgewogICAgICAgIGZ1bmMgPSB0aGlzQXJnW21ldGhvZE5hbWVdOwogICAgICB9CiAgICAgIGlmIChwYXJ0aWFsQXJncy5sZW5ndGgpIHsKICAgICAgICBhcmdzID0gYXJncy5sZW5ndGgKICAgICAgICAgID8gY29uY2F0LmFwcGx5KHBhcnRpYWxBcmdzLCBhcmdzKQogICAgICAgICAgOiBwYXJ0aWFsQXJnczsKICAgICAgfQogICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIGJvdW5kKSB7CiAgICAgICAgLy8gZ2V0IGBmdW5jYCBpbnN0YW5jZSBpZiBgYm91bmRgIGlzIGludm9rZWQgaW4gYSBgbmV3YCBleHByZXNzaW9uCiAgICAgICAgbm9vcC5wcm90b3R5cGUgPSBmdW5jLnByb3RvdHlwZTsKICAgICAgICB0aGlzQmluZGluZyA9IG5ldyBub29wOwoKICAgICAgICAvLyBtaW1pYyB0aGUgY29uc3RydWN0b3IncyBgcmV0dXJuYCBiZWhhdmlvcgogICAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDEzLjIuMgogICAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmVzdWx0ICYmIG9iamVjdFR5cGVzW3R5cGVvZiByZXN1bHRdCiAgICAgICAgICA/IHJlc3VsdAogICAgICAgICAgOiB0aGlzQmluZGluZwogICAgICB9CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgIH0KICAgIHJldHVybiBib3VuZDsKICB9CgogIC8qKgogICAqIEJpbmRzIG1ldGhvZHMgb24gYG9iamVjdGAgdG8gYG9iamVjdGAsIG92ZXJ3cml0aW5nIHRoZSBleGlzdGluZyBtZXRob2QuCiAgICogSWYgbm8gbWV0aG9kIG5hbWVzIGFyZSBwcm92aWRlZCwgYWxsIHRoZSBmdW5jdGlvbiBwcm9wZXJ0aWVzIG9mIGBvYmplY3RgCiAgICogd2lsbCBiZSBib3VuZC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gYmluZCBhbmQgYXNzaWduIHRoZSBib3VuZCBtZXRob2RzIHRvLgogICAqIEBwYXJhbSB7U3RyaW5nfSBbbWV0aG9kTmFtZTEsIG1ldGhvZE5hbWUyLCAuLi5dIE1ldGhvZCBuYW1lcyBvbiB0aGUgb2JqZWN0IHRvIGJpbmQuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgYG9iamVjdGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBidXR0b25WaWV3ID0gewogICAqICAnbGFiZWwnOiAnbG9kYXNoJywKICAgKiAgJ29uQ2xpY2snOiBmdW5jdGlvbigpIHsgYWxlcnQoJ2NsaWNrZWQ6ICcgKyB0aGlzLmxhYmVsKTsgfQogICAqIH07CiAgICoKICAgKiBfLmJpbmRBbGwoYnV0dG9uVmlldyk7CiAgICogalF1ZXJ5KCcjbG9kYXNoX2J1dHRvbicpLm9uKCdjbGljaycsIGJ1dHRvblZpZXcub25DbGljayk7CiAgICogLy8gPT4gV2hlbiB0aGUgYnV0dG9uIGlzIGNsaWNrZWQsIGB0aGlzLmxhYmVsYCB3aWxsIGhhdmUgdGhlIGNvcnJlY3QgdmFsdWUKICAgKi8KICB2YXIgYmluZEFsbCA9IGNyZWF0ZUl0ZXJhdG9yKHsKICAgICd1c2VIYXMnOiBmYWxzZSwKICAgICd1c2VTdHJpY3QnOiBmYWxzZSwKICAgICdhcmdzJzogJ29iamVjdCcsCiAgICAnaW5pdCc6ICdvYmplY3QnLAogICAgJ3RvcCc6CiAgICAgICd2YXIgZnVuY3MgPSBhcmd1bWVudHMsXG4nICsKICAgICAgJyAgICBsZW5ndGggPSBmdW5jcy5sZW5ndGg7XG4nICsKICAgICAgJ2lmIChsZW5ndGggPiAxKSB7XG4nICsKICAgICAgJyAgZm9yICh2YXIgaW5kZXggPSAxOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKylcbicgKwogICAgICAnICAgIHJlc3VsdFtmdW5jc1tpbmRleF1dID0gYmluZChyZXN1bHRbZnVuY3NbaW5kZXhdXSwgcmVzdWx0KTtcbicgKwogICAgICAnICByZXR1cm4gcmVzdWx0XG4nICsKICAgICAgJ30nLAogICAgJ2luTG9vcCc6CiAgICAgICdpZiAodG9TdHJpbmcuY2FsbChyZXN1bHRbaW5kZXhdKSA9PSBmdW5jQ2xhc3MpJyArCiAgICAgICcgcmVzdWx0W2luZGV4XSA9IGJpbmQocmVzdWx0W2luZGV4XSwgcmVzdWx0KScKICB9KTsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiB0aGUgcGFzc2VkIGZ1bmN0aW9ucywKICAgKiB3aGVyZSBlYWNoIGZ1bmN0aW9uIGNvbnN1bWVzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICAgKiBJbiBtYXRoIHRlcm1zLCBjb21wb3NpbmcgdGhlIGZ1bmN0aW9ucyBgZigpYCwgYGcoKWAsIGFuZCBgaCgpYCBwcm9kdWNlcyBgZihnKGgoKSkpYC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbZnVuYzEsIGZ1bmMyLCAuLi5dIEZ1bmN0aW9ucyB0byBjb21wb3NlLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGNvbXBvc2VkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZ3JlZXQgPSBmdW5jdGlvbihuYW1lKSB7IHJldHVybiAnaGk6ICcgKyBuYW1lOyB9OwogICAqIHZhciBleGNsYWltID0gZnVuY3Rpb24oc3RhdGVtZW50KSB7IHJldHVybiBzdGF0ZW1lbnQgKyAnISc7IH07CiAgICogdmFyIHdlbGNvbWUgPSBfLmNvbXBvc2UoZXhjbGFpbSwgZ3JlZXQpOwogICAqIHdlbGNvbWUoJ21vZScpOwogICAqIC8vID0+ICdoaTogbW9lIScKICAgKi8KICBmdW5jdGlvbiBjb21wb3NlKCkgewogICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgIGxlbmd0aCA9IGZ1bmNzLmxlbmd0aDsKCiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbbGVuZ3RoXS5hcHBseSh0aGlzLCBhcmdzKV07CiAgICAgIH0KICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICB9OwogIH0KCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBmdW5jdGlvbiB0aGF0IHdpbGwgZGVsYXkgdGhlIGV4ZWN1dGlvbiBvZiBgZnVuY2AgdW50aWwgYWZ0ZXIKICAgKiBgd2FpdGAgbWlsbGlzZWNvbmRzIGhhdmUgZWxhcHNlZCBzaW5jZSB0aGUgbGFzdCB0aW1lIGl0IHdhcyBpbnZva2VkLiBQYXNzCiAgICogYHRydWVgIGZvciBgaW1tZWRpYXRlYCB0byBjYXVzZSBkZWJvdW5jZSB0byBpbnZva2UgYGZ1bmNgIG9uIHRoZSBsZWFkaW5nLAogICAqIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLCBlZGdlIG9mIHRoZSBgd2FpdGAgdGltZW91dC4gU3Vic2VxdWVudCBjYWxscyB0bwogICAqIHRoZSBkZWJvdW5jZWQgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgbGFzdCBgZnVuY2AgY2FsbC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBkZWJvdW5jZS4KICAgKiBAcGFyYW0ge051bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byBkZWxheS4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IGltbWVkaWF0ZSBBIGZsYWcgdG8gaW5kaWNhdGUgZXhlY3V0aW9uIGlzIG9uIHRoZSBsZWFkaW5nCiAgICogIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZGVib3VuY2VkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgbGF6eUxheW91dCA9IF8uZGVib3VuY2UoY2FsY3VsYXRlTGF5b3V0LCAzMDApOwogICAqIGpRdWVyeSh3aW5kb3cpLm9uKCdyZXNpemUnLCBsYXp5TGF5b3V0KTsKICAgKi8KICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciBhcmdzLAogICAgICAgIHJlc3VsdCwKICAgICAgICB0aGlzQXJnLAogICAgICAgIHRpbWVvdXRJZDsKCiAgICBmdW5jdGlvbiBkZWxheWVkKCkgewogICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICBpZiAoIWltbWVkaWF0ZSkgewogICAgICAgIGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpc0ltbWVkaWF0ZSA9IGltbWVkaWF0ZSAmJiAhdGltZW91dElkOwogICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICB0aGlzQXJnID0gdGhpczsKCiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGRlbGF5ZWQsIHdhaXQpOwoKICAgICAgaWYgKGlzSW1tZWRpYXRlKSB7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIC8qKgogICAqIEV4ZWN1dGVzIHRoZSBgZnVuY2AgZnVuY3Rpb24gYWZ0ZXIgYHdhaXRgIG1pbGxpc2Vjb25kcy4gQWRkaXRpb25hbCBhcmd1bWVudHMKICAgKiBhcmUgcGFzc2VkIHRvIGBmdW5jYCB3aGVuIGl0IGlzIGludm9rZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVsYXkuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkgZXhlY3V0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFthcmcxLCBhcmcyLCAuLi5dIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIGZ1bmN0aW9uIHdpdGguCiAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyB0aGUgYHNldFRpbWVvdXRgIHRpbWVvdXQgaWQuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBsb2cgPSBfLmJpbmQoY29uc29sZS5sb2csIGNvbnNvbGUpOwogICAqIF8uZGVsYXkobG9nLCAxMDAwLCAnbG9nZ2VkIGxhdGVyJyk7CiAgICogLy8gPT4gJ2xvZ2dlZCBsYXRlcicgKEFwcGVhcnMgYWZ0ZXIgb25lIHNlY29uZC4pCiAgICovCiAgZnVuY3Rpb24gZGVsYXkoZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpIHsgcmV0dXJuIGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsgfSwgd2FpdCk7CiAgfQoKICAvKioKICAgKiBEZWZlcnMgZXhlY3V0aW5nIHRoZSBgZnVuY2AgZnVuY3Rpb24gdW50aWwgdGhlIGN1cnJlbnQgY2FsbCBzdGFjayBoYXMgY2xlYXJlZC4KICAgKiBBZGRpdGlvbmFsIGFyZ3VtZW50cyBhcmUgcGFzc2VkIHRvIGBmdW5jYCB3aGVuIGl0IGlzIGludm9rZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVmZXIuCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGludm9rZSB0aGUgZnVuY3Rpb24gd2l0aC4KICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIHRoZSBgc2V0VGltZW91dGAgdGltZW91dCBpZC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5kZWZlcihmdW5jdGlvbigpIHsgYWxlcnQoJ2RlZmVycmVkJyk7IH0pOwogICAqIC8vIHJldHVybnMgZnJvbSB0aGUgZnVuY3Rpb24gYmVmb3JlIGBhbGVydGAgaXMgY2FsbGVkCiAgICovCiAgZnVuY3Rpb24gZGVmZXIoZnVuYykgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpIHsgcmV0dXJuIGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsgfSwgMSk7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGZ1bmN0aW9uIHRoYXQgbWVtb2l6ZXMgdGhlIHJlc3VsdCBvZiBgZnVuY2AuIElmIGByZXNvbHZlcmAgaXMKICAgKiBwYXNzZWQsIGl0IHdpbGwgYmUgdXNlZCB0byBkZXRlcm1pbmUgdGhlIGNhY2hlIGtleSBmb3Igc3RvcmluZyB0aGUgcmVzdWx0CiAgICogYmFzZWQgb24gdGhlIGFyZ3VtZW50cyBwYXNzZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uLiBCeSBkZWZhdWx0LCB0aGUgZmlyc3QKICAgKiBhcmd1bWVudCBwYXNzZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uIGlzIHVzZWQgYXMgdGhlIGNhY2hlIGtleS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBoYXZlIGl0cyBvdXRwdXQgbWVtb2l6ZWQuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3Jlc29sdmVyXSBBIGZ1bmN0aW9uIHVzZWQgdG8gcmVzb2x2ZSB0aGUgY2FjaGUga2V5LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IG1lbW9pemluZyBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGZpYm9uYWNjaSA9IF8ubWVtb2l6ZShmdW5jdGlvbihuKSB7CiAgICogICByZXR1cm4gbiA8IDIgPyBuIDogZmlib25hY2NpKG4gLSAxKSArIGZpYm9uYWNjaShuIC0gMik7CiAgICogfSk7CiAgICovCiAgZnVuY3Rpb24gbWVtb2l6ZShmdW5jLCByZXNvbHZlcikgewogICAgdmFyIGNhY2hlID0ge307CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwcm9wID0gcmVzb2x2ZXIgPyByZXNvbHZlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogYXJndW1lbnRzWzBdOwogICAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChjYWNoZSwgcHJvcCkKICAgICAgICA/IGNhY2hlW3Byb3BdCiAgICAgICAgOiAoY2FjaGVbcHJvcF0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgZnVuY3Rpb24gdGhhdCBpcyByZXN0cmljdGVkIHRvIG9uZSBleGVjdXRpb24uIFJlcGVhdCBjYWxscyB0bwogICAqIHRoZSBmdW5jdGlvbiB3aWxsIHJldHVybiB0aGUgdmFsdWUgb2YgdGhlIGZpcnN0IGNhbGwuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgcmVzdHJpY3RlZCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGluaXRpYWxpemUgPSBfLm9uY2UoY3JlYXRlQXBwbGljYXRpb24pOwogICAqIGluaXRpYWxpemUoKTsKICAgKiBpbml0aWFsaXplKCk7CiAgICogLy8gQXBwbGljYXRpb24gaXMgb25seSBjcmVhdGVkIG9uY2UuCiAgICovCiAgZnVuY3Rpb24gb25jZShmdW5jKSB7CiAgICB2YXIgcmVzdWx0LAogICAgICAgIHJhbiA9IGZhbHNlOwoKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHJhbikgewogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgcmFuID0gdHJ1ZTsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggYW55IGFkZGl0aW9uYWwKICAgKiBgcGFydGlhbGAgYXJndW1lbnRzIHByZXBlbmRlZCB0byB0aG9zZSBwYXNzZWQgdG8gdGhlIHBhcnRpYWxseSBhcHBsaWVkCiAgICogZnVuY3Rpb24uIFRoaXMgbWV0aG9kIGlzIHNpbWlsYXIgYGJpbmRgLCBleGNlcHQgaXQgZG9lcyAqKm5vdCoqIGFsdGVyIHRoZQogICAqIGB0aGlzYCBiaW5kaW5nLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIHBhcnRpYWxseSBhcHBseSBhcmd1bWVudHMgdG8uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHBhcnRpYWxseSBhcHBsaWVkIGZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICoKICAgKiB2YXIgZ3JlZXQgPSBmdW5jdGlvbihncmVldGluZywgbmFtZSkgeyByZXR1cm4gZ3JlZXRpbmcgKyAnOiAnICsgbmFtZTsgfTsKICAgKiB2YXIgaGkgPSBfLnBhcnRpYWwoZ3JlZXQsICdoaScpOwogICAqIGhpKCdtb2UnKTsKICAgKiAvLyA9PiAnaGk6IG1vZScKICAgKi8KICBmdW5jdGlvbiBwYXJ0aWFsKGZ1bmMpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLAogICAgICAgIGFyZ3NMZW5ndGggPSBhcmdzLmxlbmd0aDsKCiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciByZXN1bHQsCiAgICAgICAgICBvdGhlcnMgPSBhcmd1bWVudHM7CgogICAgICBpZiAob3RoZXJzLmxlbmd0aCkgewogICAgICAgIGFyZ3MubGVuZ3RoID0gYXJnc0xlbmd0aDsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIG90aGVycyk7CiAgICAgIH0KICAgICAgcmVzdWx0ID0gYXJncy5sZW5ndGggPT0gMSA/IGZ1bmMuY2FsbCh0aGlzLCBhcmdzWzBdKSA6IGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICAgIGFyZ3MubGVuZ3RoID0gYXJnc0xlbmd0aDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGZ1bmN0aW9uIHRoYXQsIHdoZW4gZXhlY3V0ZWQsIHdpbGwgb25seSBjYWxsIHRoZSBgZnVuY2AKICAgKiBmdW5jdGlvbiBhdCBtb3N0IG9uY2UgcGVyIGV2ZXJ5IGB3YWl0YCBtaWxsaXNlY29uZHMuIElmIHRoZSB0aHJvdHRsZWQKICAgKiBmdW5jdGlvbiBpcyBpbnZva2VkIG1vcmUgdGhhbiBvbmNlIGR1cmluZyB0aGUgYHdhaXRgIHRpbWVvdXQsIGBmdW5jYCB3aWxsCiAgICogYWxzbyBiZSBjYWxsZWQgb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuIFN1YnNlcXVlbnQgY2FsbHMgdG8gdGhlCiAgICogdGhyb3R0bGVkIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGxhc3QgYGZ1bmNgIGNhbGwuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gdGhyb3R0bGUuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gdGhyb3R0bGUgZXhlY3V0aW9ucyB0by4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyB0aHJvdHRsZWQgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciB0aHJvdHRsZWQgPSBfLnRocm90dGxlKHVwZGF0ZVBvc2l0aW9uLCAxMDApOwogICAqIGpRdWVyeSh3aW5kb3cpLm9uKCdzY3JvbGwnLCB0aHJvdHRsZWQpOwogICAqLwogIGZ1bmN0aW9uIHRocm90dGxlKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzLAogICAgICAgIHJlc3VsdCwKICAgICAgICB0aGlzQXJnLAogICAgICAgIHRpbWVvdXRJZCwKICAgICAgICBsYXN0Q2FsbGVkID0gMDsKCiAgICBmdW5jdGlvbiB0cmFpbGluZ0NhbGwoKSB7CiAgICAgIGxhc3RDYWxsZWQgPSBuZXcgRGF0ZTsKICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSwKICAgICAgICAgIHJlbWFpbiA9IHdhaXQgLSAobm93IC0gbGFzdENhbGxlZCk7CgogICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICB0aGlzQXJnID0gdGhpczsKCiAgICAgIGlmIChyZW1haW4gPD0gMCkgewogICAgICAgIGxhc3RDYWxsZWQgPSBub3c7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgfQogICAgICBlbHNlIGlmICghdGltZW91dElkKSB7CiAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dCh0cmFpbGluZ0NhbGwsIHJlbWFpbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKICAvKioKICAgKiBDcmVhdGUgYSBuZXcgZnVuY3Rpb24gdGhhdCBwYXNzZXMgdGhlIGBmdW5jYCBmdW5jdGlvbiB0byB0aGUgYHdyYXBwZXJgCiAgICogZnVuY3Rpb24gYXMgaXRzIGZpcnN0IGFyZ3VtZW50LiBBZGRpdGlvbmFsIGFyZ3VtZW50cyBhcmUgYXBwZW5kZWQgdG8gdGhvc2UKICAgKiBwYXNzZWQgdG8gdGhlIGB3cmFwcGVyYCBmdW5jdGlvbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byB3cmFwLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IHdyYXBwZXIgVGhlIHdyYXBwZXIgZnVuY3Rpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW2FyZzEsIGFyZzIsIC4uLl0gQXJndW1lbnRzIHRvIGFwcGVuZCB0byB0aG9zZSBwYXNzZWQgdG8gdGhlIHdyYXBwZXIuCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBoZWxsbyA9IGZ1bmN0aW9uKG5hbWUpIHsgcmV0dXJuICdoZWxsbzogJyArIG5hbWU7IH07CiAgICogaGVsbG8gPSBfLndyYXAoaGVsbG8sIGZ1bmN0aW9uKGZ1bmMpIHsKICAgKiAgIHJldHVybiAnYmVmb3JlLCAnICsgZnVuYygnbW9lJykgKyAnLCBhZnRlcic7CiAgICogfSk7CiAgICogaGVsbG8oKTsKICAgKiAvLyA9PiAnYmVmb3JlLCBoZWxsbzogbW9lLCBhZnRlcicKICAgKi8KICBmdW5jdGlvbiB3cmFwKGZ1bmMsIHdyYXBwZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbZnVuY107CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICAgIHJldHVybiB3cmFwcGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfTsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBDcmVhdGUgYSBzaGFsbG93IGNsb25lIG9mIHRoZSBgdmFsdWVgLiBBbnkgbmVzdGVkIG9iamVjdHMgb3IgYXJyYXlzIHdpbGwgYmUKICAgKiBhc3NpZ25lZCBieSByZWZlcmVuY2UgYW5kIG5vdCBjbG9uZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjbG9uZS4KICAgKiBAcmV0dXJucyB7TWl4ZWR9IFJldHVybnMgdGhlIGNsb25lZCBgdmFsdWVgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmNsb25lKHsgJ25hbWUnOiAnbW9lJyB9KTsKICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfTsKICAgKi8KICBmdW5jdGlvbiBjbG9uZSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICYmIG9iamVjdFR5cGVzW3R5cGVvZiB2YWx1ZV0KICAgICAgPyAoaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZS5zbGljZSgpIDogZXh0ZW5kKHt9LCB2YWx1ZSkpCiAgICAgIDogdmFsdWU7CiAgfQoKICAvKioKICAgKiBBc3NpZ25zIG1pc3NpbmcgcHJvcGVydGllcyBvbiBgb2JqZWN0YCB3aXRoIGRlZmF1bHQgdmFsdWVzIGZyb20gdGhlIGRlZmF1bHRzCiAgICogb2JqZWN0cy4gT25jZSBhIHByb3BlcnR5IGlzIHNldCwgYWRkaXRpb25hbCBkZWZhdWx0cyBvZiB0aGUgc2FtZSBwcm9wZXJ0eQogICAqIHdpbGwgYmUgaWdub3JlZC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHBvcHVsYXRlLgogICAqIEBwYXJhbSB7T2JqZWN0fSBbZGVmYXVsdHMxLCBkZWZhdWx0czIsIC4uLl0gVGhlIGRlZmF1bHRzIG9iamVjdHMgdG8gYXBwbHkgdG8gYG9iamVjdGAuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGljZUNyZWFtID0geyAnZmxhdm9yJzogJ2Nob2NvbGF0ZScgfTsKICAgKiBfLmRlZmF1bHRzKGljZUNyZWFtLCB7ICdmbGF2b3InOiAndmFuaWxsYScsICdzcHJpbmtsZXMnOiAncmFpbmJvdycgfSk7CiAgICogLy8gPT4geyAnZmxhdm9yJzogJ2Nob2NvbGF0ZScsICdzcHJpbmtsZXMnOiAncmFpbmJvdycgfQogICAqLwogIHZhciBkZWZhdWx0cyA9IGNyZWF0ZUl0ZXJhdG9yKGV4dGVuZEl0ZXJhdG9yT3B0aW9ucywgewogICAgJ2luTG9vcCc6ICdpZiAocmVzdWx0W2luZGV4XSA9PSBudWxsKSAnICsgZXh0ZW5kSXRlcmF0b3JPcHRpb25zLmluTG9vcAogIH0pOwoKICAvKioKICAgKiBDb3BpZXMgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIGZyb20gdGhlIHNvdXJjZSBvYmplY3RzIHRvIHRoZSBgZGVzdGluYXRpb25gIG9iamVjdC4KICAgKiBTdWJzZXF1ZW50IHNvdXJjZXMgd2lsbCBvdmVyd3JpdGUgcHJvcGVyeSBhc3NpZ25tZW50cyBvZiBwcmV2aW91cyBzb3VyY2VzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICogQHBhcmFtIHtPYmplY3R9IFtzb3VyY2UxLCBzb3VyY2UyLCAuLi5dIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZXh0ZW5kKHsgJ25hbWUnOiAnbW9lJyB9LCB7ICdhZ2UnOiA0MCB9KTsKICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9CiAgICovCiAgdmFyIGV4dGVuZCA9IGNyZWF0ZUl0ZXJhdG9yKGV4dGVuZEl0ZXJhdG9yT3B0aW9ucyk7CgogIC8qKgogICAqIEl0ZXJhdGVzIG92ZXIgYG9iamVjdGAncyBvd24gYW5kIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMsIGV4ZWN1dGluZwogICAqIHRoZSBgY2FsbGJhY2tgIGZvciBlYWNoIHByb3BlcnR5LiBUaGUgYGNhbGxiYWNrYCBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICogaW52b2tlZCB3aXRoIDMgYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICogQHBhcmFtIHtNaXhlZH0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGBvYmplY3RgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBmdW5jdGlvbiBEb2cobmFtZSkgewogICAqICAgdGhpcy5uYW1lID0gbmFtZTsKICAgKiB9CiAgICoKICAgKiBEb2cucHJvdG90eXBlLmJhcmsgPSBmdW5jdGlvbigpIHsKICAgKiAgIGFsZXJ0KCdXb29mLCB3b29mIScpOwogICAqIH07CiAgICoKICAgKiBfLmZvckluKG5ldyBEb2coJ0RhZ255JyksIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgKiAgIGFsZXJ0KGtleSk7CiAgICogfSk7CiAgICogLy8gPT4gYWxlcnRzICduYW1lJyBhbmQgJ2JhcmsnIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICB2YXIgZm9ySW4gPSBjcmVhdGVJdGVyYXRvcihiYXNlSXRlcmF0b3JPcHRpb25zLCBmb3JFYWNoSXRlcmF0b3JPcHRpb25zLCBmb3JPd25JdGVyYXRvck9wdGlvbnMsIHsKICAgICd1c2VIYXMnOiBmYWxzZQogIH0pOwoKICAvKioKICAgKiBJdGVyYXRlcyBvdmVyIGBvYmplY3RgJ3Mgb3duIGVudW1lcmFibGUgcHJvcGVydGllcywgZXhlY3V0aW5nIHRoZSBgY2FsbGJhY2tgCiAgICogZm9yIGVhY2ggcHJvcGVydHkuIFRoZSBgY2FsbGJhY2tgIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIDMKICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwga2V5LCBvYmplY3QpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgKiBAcGFyYW0ge01peGVkfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2suCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgYG9iamVjdGAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZm9yT3duKHsgJzAnOiAnemVybycsICcxJzogJ29uZScsICdsZW5ndGgnOiAyIH0sIGZ1bmN0aW9uKG51bSwga2V5KSB7CiAgICogICBhbGVydChrZXkpOwogICAqIH0pOwogICAqIC8vID0+IGFsZXJ0cyAnMCcsICcxJywgYW5kICdsZW5ndGgnIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICB2YXIgZm9yT3duID0gY3JlYXRlSXRlcmF0b3IoYmFzZUl0ZXJhdG9yT3B0aW9ucywgZm9yRWFjaEl0ZXJhdG9yT3B0aW9ucywgZm9yT3duSXRlcmF0b3JPcHRpb25zKTsKCiAgLyoqCiAgICogUHJvZHVjZXMgYSBzb3J0ZWQgYXJyYXkgb2YgdGhlIGVudW1lcmFibGUgcHJvcGVydGllcywgb3duIGFuZCBpbmhlcml0ZWQsCiAgICogb2YgYG9iamVjdGAgdGhhdCBoYXZlIGZ1bmN0aW9uIHZhbHVlcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBhbGlhcyBtZXRob2RzCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMgdGhhdCBoYXZlIGZ1bmN0aW9uIHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5mdW5jdGlvbnMoXyk7CiAgICogLy8gPT4gWydhbGwnLCAnYW55JywgJ2JpbmQnLCAnYmluZEFsbCcsICdjbG9uZScsICdjb21wYWN0JywgJ2NvbXBvc2UnLCAuLi5dCiAgICovCiAgdmFyIGZ1bmN0aW9ucyA9IGNyZWF0ZUl0ZXJhdG9yKHsKICAgICd1c2VIYXMnOiBmYWxzZSwKICAgICdhcmdzJzogJ29iamVjdCcsCiAgICAnaW5pdCc6ICdbXScsCiAgICAnaW5Mb29wJzogJ2lmICh0b1N0cmluZy5jYWxsKGl0ZXJhdGVlW2luZGV4XSkgPT0gZnVuY0NsYXNzKSByZXN1bHQucHVzaChpbmRleCknLAogICAgJ2JvdHRvbSc6ICdyZXN1bHQuc29ydCgpJwogIH0pOwoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgYHByb3BlcnR5YCBleGlzdHMgYW5kIGlzIGEgZGlyZWN0IHByb3BlcnR5LAogICAqIGluc3RlYWQgb2YgYW4gaW5oZXJpdGVkIHByb3BlcnR5LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gY2hlY2suCiAgICogQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBjaGVjayBmb3IuCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGtleSBpcyBhIGRpcmVjdCBwcm9wZXJ0eSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmhhcyh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgJ2InKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaGFzKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwgcHJvcGVydHkpOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYW4gYGFyZ3VtZW50c2Agb2JqZWN0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGFuIGBhcmd1bWVudHNgIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAoZnVuY3Rpb24oKSB7IHJldHVybiBfLmlzQXJndW1lbnRzKGFyZ3VtZW50cyk7IH0pKDEsIDIsIDMpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNBcmd1bWVudHMoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIHZhciBpc0FyZ3VtZW50cyA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gJ1tvYmplY3QgQXJndW1lbnRzXSc7CiAgfTsKICAvLyBmYWxsYmFjayBmb3IgYnJvd3NlciBsaWtlIElFIDwgOSB3aGljaCBkZXRlY3QgYGFyZ3VtZW50c2AgYXMgYFtvYmplY3QgT2JqZWN0XWAKICBpZiAoIWlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIGlzQXJndW1lbnRzID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuICEhKHZhbHVlICYmIGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsICdjYWxsZWUnKSk7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYW4gYXJyYXkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYW4gYXJyYXksIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogKGZ1bmN0aW9uKCkgeyByZXR1cm4gXy5pc0FycmF5KGFyZ3VtZW50cyk7IH0pKCk7CiAgICogLy8gPT4gZmFsc2UKICAgKgogICAqIF8uaXNBcnJheShbMSwgMiwgM10pOwogICAqIC8vID0+IHRydWUKICAgKi8KICB2YXIgaXNBcnJheSA9IG5hdGl2ZUlzQXJyYXkgfHwgZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBhcnJheUNsYXNzOwogIH07CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgYm9vbGVhbiAoYHRydWVgIG9yIGBmYWxzZWApIHZhbHVlLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgYm9vbGVhbiB2YWx1ZSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzQm9vbGVhbihudWxsKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzQm9vbGVhbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSB0cnVlIHx8IHZhbHVlID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBib29sQ2xhc3M7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIGRhdGUuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBkYXRlLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNEYXRlKG5ldyBEYXRlKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNEYXRlKHZhbHVlKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gZGF0ZUNsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIERPTSBlbGVtZW50LCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNFbGVtZW50KGRvY3VtZW50LmJvZHkpOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc0VsZW1lbnQodmFsdWUpIHsKICAgIHJldHVybiAhISh2YWx1ZSAmJiB2YWx1ZS5ub2RlVHlwZSA9PSAxKTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGVtcHR5LiBBcnJheXMgb3Igc3RyaW5ncyB3aXRoIGEgbGVuZ3RoIG9mIGAwYCBhbmQKICAgKiBvYmplY3RzIHdpdGggbm8gb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBhcmUgY29uc2lkZXJlZCAiZW1wdHkiLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxTdHJpbmd9IHZhbHVlIFRoZSB2YWx1ZSB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBlbXB0eSwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRW1wdHkoWzEsIDIsIDNdKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0VtcHR5KHt9KTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBfLmlzRW1wdHkoJycpOwogICAqIC8vID0+IHRydWUKICAgKi8KICB2YXIgaXNFbXB0eSA9IGNyZWF0ZUl0ZXJhdG9yKHsKICAgICdhcmdzJzogJ3ZhbHVlJywKICAgICdpbml0JzogJ3RydWUnLAogICAgJ3RvcCc6CiAgICAgICd2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbCh2YWx1ZSk7XG4nICsKICAgICAgJ2lmIChjbGFzc05hbWUgPT0gYXJyYXlDbGFzcyB8fCBjbGFzc05hbWUgPT0gc3RyaW5nQ2xhc3MpIHJldHVybiAhdmFsdWUubGVuZ3RoJywKICAgICdpbkxvb3AnOiB7CiAgICAgICdvYmplY3QnOiAncmV0dXJuIGZhbHNlJwogICAgfQogIH0pOwoKICAvKioKICAgKiBQZXJmb3JtcyBhIGRlZXAgY29tcGFyaXNvbiBiZXR3ZWVuIHR3byB2YWx1ZXMgdG8gZGV0ZXJtaW5lIGlmIHRoZXkgYXJlCiAgICogZXF1aXZhbGVudCB0byBlYWNoIG90aGVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgKiBAcGFyYW0ge01peGVkfSBhIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAqIEBwYXJhbSB7TWl4ZWR9IGIgVGhlIG90aGVyIHZhbHVlIHRvIGNvbXBhcmUuCiAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrXSBJbnRlcm5hbGx5IHVzZWQgdG8ga2VlcCB0cmFjayBvZiAic2VlbiIgb2JqZWN0cyB0bwogICAqICBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VzLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdmFsdWVzIGFyZSBlcXV2YWxlbnQsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIG1vZSA9IHsgJ25hbWUnOiAnbW9lJywgJ2x1Y2t5TnVtYmVycyc6IFsxMywgMjcsIDM0XSB9OwogICAqIHZhciBjbG9uZSA9IHsgJ25hbWUnOiAnbW9lJywgJ2x1Y2t5TnVtYmVycyc6IFsxMywgMjcsIDM0XSB9OwogICAqCiAgICogbW9lID09IGNsb25lOwogICAqIC8vID0+IGZhbHNlCiAgICoKICAgKiBfLmlzRXF1YWwobW9lLCBjbG9uZSk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzRXF1YWwoYSwgYiwgc3RhY2spIHsKICAgIHN0YWNrIHx8IChzdGFjayA9IFtdKTsKCiAgICAvLyBleGl0IGVhcmx5IGZvciBpZGVudGljYWwgdmFsdWVzCiAgICBpZiAoYSA9PT0gYikgewogICAgICAvLyB0cmVhdCBgKzBgIHZzLiBgLTBgIGFzIG5vdCBlcXVhbAogICAgICByZXR1cm4gYSAhPT0gMCB8fCAoMSAvIGEgPT0gMSAvIGIpOwogICAgfQogICAgLy8gYSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgdW5kZWZpbmVkID09IG51bGxgCiAgICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgewogICAgICByZXR1cm4gYSA9PT0gYjsKICAgIH0KICAgIC8vIHVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzCiAgICBpZiAoYS5fY2hhaW4pIHsKICAgICAgYSA9IGEuX3dyYXBwZWQ7CiAgICB9CiAgICBpZiAoYi5fY2hhaW4pIHsKICAgICAgYiA9IGIuX3dyYXBwZWQ7CiAgICB9CiAgICAvLyBpbnZva2UgYSBjdXN0b20gYGlzRXF1YWxgIG1ldGhvZCBpZiBvbmUgaXMgcHJvdmlkZWQKICAgIGlmIChhLmlzRXF1YWwgJiYgdG9TdHJpbmcuY2FsbChhLmlzRXF1YWwpID09IGZ1bmNDbGFzcykgewogICAgICByZXR1cm4gYS5pc0VxdWFsKGIpOwogICAgfQogICAgaWYgKGIuaXNFcXVhbCAmJiB0b1N0cmluZy5jYWxsKGIuaXNFcXVhbCkgPT0gZnVuY0NsYXNzKSB7CiAgICAgIHJldHVybiBiLmlzRXF1YWwoYSk7CiAgICB9CiAgICAvLyBjb21wYXJlIFtbQ2xhc3NdXSBuYW1lcwogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CiAgICBpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgLy8gc3RyaW5ncywgbnVtYmVycywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUKICAgICAgY2FzZSBzdHJpbmdDbGFzczoKICAgICAgICAvLyBwcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCBpbnN0YW5jZXMgYXJlIGVxdWl2YWxlbnQ7CiAgICAgICAgLy8gdGh1cywgYCc1J2AgaXMgcXVpdmFsZW50IHRvIGBuZXcgU3RyaW5nKCc1JylgCiAgICAgICAgcmV0dXJuIGEgPT0gU3RyaW5nKGIpOwoKICAgICAgY2FzZSBudW1iZXJDbGFzczoKICAgICAgICAvLyB0cmVhdCBgTmFOYCB2cy4gYE5hTmAgYXMgZXF1YWwKICAgICAgICByZXR1cm4gYSAhPSArYQogICAgICAgICAgPyBiICE9ICtiCiAgICAgICAgICAvLyBidXQgdHJlYXQgYCswYCB2cy4gYC0wYCBhcyBub3QgZXF1YWwKICAgICAgICAgIDogKGEgPT0gMCA/ICgxIC8gYSA9PSAxIC8gYikgOiBhID09ICtiKTsKCiAgICAgIGNhc2UgYm9vbENsYXNzOgogICAgICBjYXNlIGRhdGVDbGFzczoKICAgICAgICAvLyBjb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWVyaWMgdmFsdWVzLCBkYXRlcyB0byBtaWxsaXNlY29uZHMgYW5kCiAgICAgICAgLy8gYm9vbGVhbnMgdG8gMSBvciAwOyB0cmVhdCBpbnZhbGlkIGRhdGVzIGNvZXJjZWQgdG8gYE5hTmAgYXMgbm90IGVxdWFsCiAgICAgICAgcmV0dXJuICthID09ICtiOwoKICAgICAgLy8gcmVnZXhwcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIgc291cmNlIGFuZCBmbGFncwogICAgICBjYXNlIHJlZ2V4cENsYXNzOgogICAgICAgIHJldHVybiBhLnNvdXJjZSA9PSBiLnNvdXJjZSAmJgogICAgICAgICAgICAgICBhLmdsb2JhbCA9PSBiLmdsb2JhbCAmJgogICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PSBiLm11bHRpbGluZSAmJgogICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT0gYi5pZ25vcmVDYXNlOwogICAgfQogICAgaWYgKHR5cGVvZiBhICE9ICdvYmplY3QnIHx8IHR5cGVvZiBiICE9ICdvYmplY3QnKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8vIEFzc3VtZSBlcXVhbGl0eSBmb3IgY3ljbGljIHN0cnVjdHVyZXMuIFRoZSBhbGdvcml0aG0gZm9yIGRldGVjdGluZyBjeWNsaWMKICAgIC8vIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMSBzZWN0aW9uIDE1LjEyLjMsIGFic3RyYWN0IG9wZXJhdGlvbiBgSk9gLgogICAgdmFyIGxlbmd0aCA9IHN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoc3RhY2tbbGVuZ3RoXSA9PSBhKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICByZXN1bHQgPSB0cnVlLAogICAgICAgIHNpemUgPSAwOwoKICAgIC8vIGFkZCB0aGUgZmlyc3QgY29sbGVjdGlvbiB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMKICAgIHN0YWNrLnB1c2goYSk7CgogICAgLy8gcmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMKICAgIGlmIChjbGFzc05hbWUgPT0gYXJyYXlDbGFzcykgewogICAgICAvLyBjb21wYXJlIGFycmF5IGxlbmd0aHMgdG8gZGV0ZXJtaW5lIGlmIGEgZGVlcCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeQogICAgICBzaXplID0gYS5sZW5ndGg7CiAgICAgIHJlc3VsdCA9IHNpemUgPT0gYi5sZW5ndGg7CgogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgLy8gZGVlcCBjb21wYXJlIHRoZSBjb250ZW50cywgaWdub3Jpbmcgbm9uLW51bWVyaWMgcHJvcGVydGllcwogICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9IGlzRXF1YWwoYVtzaXplXSwgYltzaXplXSwgc3RhY2spKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIG9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudAogICAgICBpZiAoJ2NvbnN0cnVjdG9yJyBpbiBhICE9ICdjb25zdHJ1Y3RvcicgaW4gYiB8fCBhLmNvbnN0cnVjdG9yICE9IGIuY29uc3RydWN0b3IpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gZGVlcCBjb21wYXJlIG9iamVjdHMuCiAgICAgIGZvciAodmFyIHByb3AgaW4gYSkgewogICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGEsIHByb3ApKSB7CiAgICAgICAgICAvLyBjb3VudCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgICAgICBzaXplKys7CiAgICAgICAgICAvLyBkZWVwIGNvbXBhcmUgZWFjaCBwcm9wZXJ0eSB2YWx1ZS4KICAgICAgICAgIGlmICghKHJlc3VsdCA9IGhhc093blByb3BlcnR5LmNhbGwoYiwgcHJvcCkgJiYgaXNFcXVhbChhW3Byb3BdLCBiW3Byb3BdLCBzdGFjaykpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBlbnN1cmUgYm90aCBvYmplY3RzIGhhdmUgdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIGZvciAocHJvcCBpbiBiKSB7CiAgICAgICAgICAvLyBBZG9iZSdzIEpTIGVuZ2luZSwgZW1iZWRkZWQgaW4gYXBwbGljYXRpb25zIGxpa2UgSW5EZXNpZ24sIGhhcyBhCiAgICAgICAgICAvLyBidWcgdGhhdCBjYXVzZXMgYCFzaXplLS1gIHRvIHRocm93IGFuIGVycm9yIHNvIGl0IG11c3QgYmUgd3JhcHBlZAogICAgICAgICAgLy8gaW4gcGFyZW50aGVzZXMuCiAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vZG9jdW1lbnRjbG91ZC91bmRlcnNjb3JlL2lzc3Vlcy8zNTUKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHByb3ApICYmICEoc2l6ZS0tKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgICAgLy8gaGFuZGxlIEpTY3JpcHQgW1tEb250RW51bV1dIGJ1ZwogICAgICBpZiAocmVzdWx0ICYmIGhhc0RvbnRFbnVtQnVnKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCA3KSB7CiAgICAgICAgICBwcm9wID0gc2hhZG93ZWRbaW5kZXhdOwogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoYSwgcHJvcCkpIHsKICAgICAgICAgICAgaWYgKCEocmVzdWx0ID0gaGFzT3duUHJvcGVydHkuY2FsbChiLCBwcm9wKSAmJiBpc0VxdWFsKGFbcHJvcF0sIGJbcHJvcF0sIHN0YWNrKSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gcmVtb3ZlIHRoZSBmaXJzdCBjb2xsZWN0aW9uIGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzCiAgICBzdGFjay5wb3AoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIGZpbml0ZSBudW1iZXIuCiAgICogTm90ZTogVGhpcyBpcyBub3QgdGhlIHNhbWUgYXMgbmF0aXZlIGBpc0Zpbml0ZWAsIHdoaWNoIHdpbGwgcmV0dXJuIHRydWUgZm9yCiAgICogYm9vbGVhbnMgYW5kIG90aGVyIHZhbHVlcy4gU2VlIGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDE1LjEuMi41LgogICAqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBmaW5pdGUgbnVtYmVyLCBlbHNlIGBmYWxzZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uaXNGaW5pdGUoLTEwMSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc0Zpbml0ZSgnMTAnKTsKICAgKiAvLyA9PiBmYWxzZQogICAqCiAgICogXy5pc0Zpbml0ZShJbmZpbml0eSk7CiAgICogLy8gPT4gZmFsc2UKICAgKi8KICBmdW5jdGlvbiBpc0Zpbml0ZSh2YWx1ZSkgewogICAgcmV0dXJuIG5hdGl2ZUlzRmluaXRlKHZhbHVlKSAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBudW1iZXJDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBmdW5jdGlvbiwgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzRnVuY3Rpb24oJycuY29uY2F0KTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGZ1bmNDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIHRoZSBsYW5ndWFnZSB0eXBlIG9mIE9iamVjdC4KICAgKiAoZS5nLiBhcnJheXMsIGZ1bmN0aW9ucywgb2JqZWN0cywgcmVnZXhwcywgYG5ldyBOdW1iZXIoMClgLCBhbmQgYG5ldyBTdHJpbmcoJycpYCkKICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc09iamVjdCh7fSk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc09iamVjdCgxKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICAvLyBjaGVjayBpZiB0aGUgdmFsdWUgaXMgdGhlIEVDTUFTY3JpcHQgbGFuZ3VhZ2UgdHlwZSBvZiBPYmplY3QKICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDgKICAgIHJldHVybiB2YWx1ZSAmJiBvYmplY3RUeXBlc1t0eXBlb2YgdmFsdWVdOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYE5hTmAuCiAgICogTm90ZTogVGhpcyBpcyBub3QgdGhlIHNhbWUgYXMgbmF0aXZlIGBpc05hTmAsIHdoaWNoIHdpbGwgcmV0dXJuIHRydWUgZm9yCiAgICogYHVuZGVmaW5lZGAgYW5kIG90aGVyIHZhbHVlcy4gU2VlIGh0dHA6Ly9lczUuZ2l0aHViLmNvbS8jeDE1LjEuMi40LgogICAqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYE5hTmAsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc05hTihOYU4pOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNOYU4obmV3IE51bWJlcihOYU4pKTsKICAgKiAvLyA9PiB0cnVlCiAgICoKICAgKiBpc05hTih1bmRlZmluZWQpOwogICAqIC8vID0+IHRydWUKICAgKgogICAqIF8uaXNOYU4odW5kZWZpbmVkKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzTmFOKHZhbHVlKSB7CiAgICAvLyBgTmFOYCBhcyBhIHByaW1pdGl2ZSBpcyB0aGUgb25seSB2YWx1ZSB0aGF0IGlzIG5vdCBlcXVhbCB0byBpdHNlbGYKICAgIC8vIChwZXJmb3JtIHRoZSBbW0NsYXNzXV0gY2hlY2sgZmlyc3QgdG8gYXZvaWQgZXJyb3JzIHdpdGggc29tZSBob3N0IG9iamVjdHMgaW4gSUUpCiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gbnVtYmVyQ2xhc3MgJiYgdmFsdWUgIT0gK3ZhbHVlCiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgbnVsbGAuCiAgICoKICAgKiBAZGVwcmVjYXRlZAogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBgbnVsbGAsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc051bGwobnVsbCk7CiAgICogLy8gPT4gdHJ1ZQogICAqCiAgICogXy5pc051bGwodW5kZWZpbmVkKTsKICAgKiAvLyA9PiBmYWxzZQogICAqLwogIGZ1bmN0aW9uIGlzTnVsbCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSBudWxsOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBudW1iZXIuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBudW1iZXIsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc051bWJlcig4LjQgKiA1OwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSkgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IG51bWJlckNsYXNzOwogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24sIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc1JlZ0V4cCgvbW9lLyk7CiAgICogLy8gPT4gdHJ1ZQogICAqLwogIGZ1bmN0aW9uIGlzUmVnRXhwKHZhbHVlKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gcmVnZXhwQ2xhc3M7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIHN0cmluZy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIHN0cmluZywgZWxzZSBgZmFsc2VgLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfLmlzU3RyaW5nKCdtb2UnKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaXNTdHJpbmcodmFsdWUpIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBzdHJpbmdDbGFzczsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGB1bmRlZmluZWRgLgogICAqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYHVuZGVmaW5lZGAsIGVsc2UgYGZhbHNlYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5pc1VuZGVmaW5lZCh2b2lkIDApOwogICAqIC8vID0+IHRydWUKICAgKi8KICBmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQ7CiAgfQoKICAvKioKICAgKiBQcm9kdWNlcyBhbiBhcnJheSBvZiBvYmplY3RgJ3Mgb3duIGVudW1lcmFibGUgcHJvcGVydHkgbmFtZXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5rZXlzKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0pOwogICAqIC8vID0+IFsnb25lJywgJ3R3bycsICd0aHJlZSddIChvcmRlciBpcyBub3QgZ3VhcmFudGVlZCkKICAgKi8KICB2YXIga2V5cyA9ICFuYXRpdmVLZXlzID8gc2hpbUtleXMgOiBmdW5jdGlvbihvYmplY3QpIHsKICAgIC8vIGF2b2lkIGl0ZXJhdGluZyBvdmVyIHRoZSBgcHJvdG90eXBlYCBwcm9wZXJ0eQogICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT0gJ2Z1bmN0aW9uJyAmJiBwcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKG9iamVjdCwgJ3Byb3RvdHlwZScpCiAgICAgID8gc2hpbUtleXMob2JqZWN0KQogICAgICA6IG5hdGl2ZUtleXMob2JqZWN0KTsKICB9OwoKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgc3BlY2lmaWVkIHByb3BlcnRpZXMuIFByb3BlcnR5IG5hbWVzIG1heQogICAqIGJlIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcyBhcnJheXMgb2YgcHJvcGVydHkgbmFtZXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBwbHVjay4KICAgKiBAcGFyYW0ge09iamVjdH0gW3Byb3AxLCBwcm9wMiwgLi4uXSBUaGUgcHJvcGVydGllcyB0byBwaWNrLgogICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIHRoZSBwaWNrZWQgcHJvcGVydGllcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5waWNrKHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwLCAndXNlcmlkJzogJ21vZTEnIH0sICduYW1lJywgJ2FnZScpOwogICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0KICAgKi8KICBmdW5jdGlvbiBwaWNrKG9iamVjdCkgewogICAgdmFyIHByb3AsCiAgICAgICAgaW5kZXggPSAwLAogICAgICAgIHByb3BzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIGFyZ3VtZW50cyksCiAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgIHJlc3VsdCA9IHt9OwoKICAgIC8vIHN0YXJ0IGBpbmRleGAgYXQgYDFgIHRvIHNraXAgYG9iamVjdGAKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHByb3AgPSBwcm9wc1tpbmRleF07CiAgICAgIGlmIChwcm9wIGluIG9iamVjdCkgewogICAgICAgIHJlc3VsdFtwcm9wXSA9IG9iamVjdFtwcm9wXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEdldHMgdGhlIHNpemUgb2YgYHZhbHVlYCBieSByZXR1cm5pbmcgYHZhbHVlLmxlbmd0aGAgaWYgYHZhbHVlYCBpcyBhIHN0cmluZwogICAqIG9yIGFycmF5LCBvciB0aGUgbnVtYmVyIG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgaWYgYHZhbHVlYCBpcyBhbiBvYmplY3QuCiAgICoKICAgKiBAZGVwcmVjYXRlZAogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8U3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIGB2YWx1ZS5sZW5ndGhgIGlmIGB2YWx1ZWAgaXMgYSBzdHJpbmcgb3IgYXJyYXksCiAgICogIG9yIHRoZSBudW1iZXIgb2Ygb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBpZiBgdmFsdWVgIGlzIGFuIG9iamVjdC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5zaXplKFsxLCAyXSk7CiAgICogLy8gPT4gMgogICAqCiAgICogXy5zaXplKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0pOwogICAqIC8vID0+IDMKICAgKgogICAqIF8uc2l6ZSgnY3VybHknKTsKICAgKiAvLyA9PiA1CiAgICovCiAgZnVuY3Rpb24gc2l6ZSh2YWx1ZSkgewogICAgaWYgKCF2YWx1ZSkgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIHZhciBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CiAgICByZXR1cm4gbGVuZ3RoID09PSBsZW5ndGggPj4+IDAgPyB2YWx1ZS5sZW5ndGggOiBrZXlzKHZhbHVlKS5sZW5ndGg7CiAgfQoKICAvKioKICAgKiBQcm9kdWNlcyBhbiBhcnJheSBvZiBgb2JqZWN0YCdzIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IHZhbHVlcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHByb3BlcnR5IHZhbHVlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy52YWx1ZXMoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSk7CiAgICogLy8gPT4gWzEsIDIsIDNdCiAgICovCiAgdmFyIHZhbHVlcyA9IGNyZWF0ZUl0ZXJhdG9yKHsKICAgICdhcmdzJzogJ29iamVjdCcsCiAgICAnaW5pdCc6ICdbXScsCiAgICAnaW5Mb29wJzogJ3Jlc3VsdC5wdXNoKGl0ZXJhdGVlW2luZGV4XSknCiAgfSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBFc2NhcGVzIGEgc3RyaW5nIGZvciBpbmNsdXNpb24gaW4gSFRNTCwgcmVwbGFjaW5nIGAmYCwgYDxgLCBgImAsIGFuZCBgJ2AKICAgKiBjaGFyYWN0ZXJzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyB0byBlc2NhcGUuCiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBzdHJpbmcuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uZXNjYXBlKCdDdXJseSwgTGFycnkgJiBNb2UnKTsKICAgKiAvLyA9PiAiQ3VybHksIExhcnJ5ICZhbXA7IE1vZSIKICAgKi8KICBmdW5jdGlvbiBlc2NhcGUoc3RyaW5nKSB7CiAgICByZXR1cm4gc3RyaW5nID09IG51bGwgPyAnJyA6IChzdHJpbmcgKyAnJykucmVwbGFjZShyZVVuZXNjYXBlZEh0bWwsIGVzY2FwZUh0bWxDaGFyKTsKICB9CgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gcmV0dXJucyB0aGUgZmlyc3QgYXJndW1lbnQgcGFzc2VkIHRvIGl0LgogICAqIE5vdGU6IEl0IGlzIHVzZWQgdGhyb3VnaG91dCBMby1EYXNoIGFzIGEgZGVmYXVsdCBjYWxsYmFjay4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBBbnkgdmFsdWUuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBtb2UgPSB7ICduYW1lJzogJ21vZScgfTsKICAgKiBtb2UgPT09IF8uaWRlbnRpdHkobW9lKTsKICAgKiAvLyA9PiB0cnVlCiAgICovCiAgZnVuY3Rpb24gaWRlbnRpdHkodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CgogIC8qKgogICAqIEFkZHMgZnVuY3Rpb25zIHByb3BlcnRpZXMgb2YgYG9iamVjdGAgdG8gdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uIGFuZCBjaGFpbmFibGUKICAgKiB3cmFwcGVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCBvZiBmdW5jdGlvbiBwcm9wZXJ0aWVzIHRvIGFkZCB0byBgbG9kYXNoYC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy5taXhpbih7CiAgICogICAnY2FwaXRhbGl6ZSc6IGZ1bmN0aW9uKHN0cmluZykgewogICAqICAgICByZXR1cm4gc3RyaW5nLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyaW5nLnNsaWNlKDEpLnRvTG93ZXJDYXNlKCk7CiAgICogICB9CiAgICogfSk7CiAgICoKICAgKiBfLmNhcGl0YWxpemUoJ2N1cmx5Jyk7CiAgICogLy8gPT4gJ0N1cmx5JwogICAqCiAgICogXygnbGFycnknKS5jYXBpdGFsaXplKCk7CiAgICogLy8gPT4gJ0xhcnJ5JwogICAqLwogIGZ1bmN0aW9uIG1peGluKG9iamVjdCkgewogICAgZm9yRWFjaChmdW5jdGlvbnMob2JqZWN0KSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGxvZGFzaFttZXRob2ROYW1lXSA9IG9iamVjdFttZXRob2ROYW1lXTsKCiAgICAgIExvRGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShsb2Rhc2gsIGFyZ3MpOwogICAgICAgIGlmICh0aGlzLl9jaGFpbikgewogICAgICAgICAgcmVzdWx0ID0gbmV3IExvRGFzaChyZXN1bHQpOwogICAgICAgICAgcmVzdWx0Ll9jaGFpbiA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9KTsKICB9CgogIC8qKgogICAqIFJldmVydHMgdGhlICdfJyB2YXJpYWJsZSB0byBpdHMgcHJldmlvdXMgdmFsdWUgYW5kIHJldHVybnMgYSByZWZlcmVuY2UgdG8KICAgKiB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBgbG9kYXNoYCBmdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqCiAgICogdmFyIGxvZGFzaCA9IF8ubm9Db25mbGljdCgpOwogICAqLwogIGZ1bmN0aW9uIG5vQ29uZmxpY3QoKSB7CiAgICB3aW5kb3cuXyA9IG9sZERhc2g7CiAgICByZXR1cm4gdGhpczsKICB9CgogIC8qKgogICAqIFJlc29sdmVzIHRoZSB2YWx1ZSBvZiBgcHJvcGVydHlgIG9uIGBvYmplY3RgLiBJZiBgcHJvcGVydHlgIGlzIGEgZnVuY3Rpb24KICAgKiBpdCB3aWxsIGJlIGludm9rZWQgYW5kIGl0cyByZXN1bHQgcmV0dXJuZWQsIGVsc2UgdGhlIHByb3BlcnR5IHZhbHVlIGlzCiAgICogcmV0dXJuZWQuIElmIGBvYmplY3RgIGlzIGZhbHNleSwgdGhlbiBgbnVsbGAgaXMgcmV0dXJuZWQuCiAgICoKICAgKiBAZGVwcmVjYXRlZAogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIGdldCB0aGUgcmVzdWx0IG9mLgogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgcmVzb2x2ZWQgdmFsdWUuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBvYmplY3QgPSB7CiAgICogICAnY2hlZXNlJzogJ2NydW1wZXRzJywKICAgKiAgICdzdHVmZic6IGZ1bmN0aW9uKCkgewogICAqICAgICByZXR1cm4gJ25vbnNlbnNlJzsKICAgKiAgIH0KICAgKiB9OwogICAqCiAgICogXy5yZXN1bHQob2JqZWN0LCAnY2hlZXNlJyk7CiAgICogLy8gPT4gJ2NydW1wZXRzJwogICAqCiAgICogXy5yZXN1bHQob2JqZWN0LCAnc3R1ZmYnKTsKICAgKiAvLyA9PiAnbm9uc2Vuc2UnCiAgICovCiAgZnVuY3Rpb24gcmVzdWx0KG9iamVjdCwgcHJvcGVydHkpIHsKICAgIC8vIGJhc2VkIG9uIEJhY2tib25lJ3MgcHJpdmF0ZSBgZ2V0VmFsdWVgIGZ1bmN0aW9uCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vZG9jdW1lbnRjbG91ZC9iYWNrYm9uZS9ibG9iLzAuOS4yL2JhY2tib25lLmpzI0wxNDE5LTE0MjQKICAgIGlmICghb2JqZWN0KSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBmdW5jQ2xhc3MgPyBvYmplY3RbcHJvcGVydHldKCkgOiB2YWx1ZTsKICB9CgogIC8qKgogICAqIEEgbWljcm8tdGVtcGxhdGluZyBtZXRob2QgdGhhdCBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMKICAgKiB3aGl0ZXNwYWNlLCBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge1N0cmluZ30gdGV4dCBUaGUgdGVtcGxhdGUgdGV4dC4KICAgKiBAcGFyYW0ge09iZWN0fSBkYXRhIFRoZSBkYXRhIG9iamVjdCB1c2VkIHRvIHBvcHVsYXRlIHRoZSB0ZXh0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIG9iamVjdC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb258U3RyaW5nfSBSZXR1cm5zIGEgY29tcGlsZWQgZnVuY3Rpb24gd2hlbiBubyBgZGF0YWAgb2JqZWN0CiAgICogIGlzIGdpdmVuLCBlbHNlIGl0IHJldHVybnMgdGhlIGludGVycG9sYXRlZCB0ZXh0LgogICAqIEBleGFtcGxlCiAgICoKICAgKiAvLyB1c2luZyBjb21waWxlZCB0ZW1wbGF0ZQogICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJ2hlbGxvOiA8JT0gbmFtZSAlPicpOwogICAqIGNvbXBpbGVkKHsgJ25hbWUnOiAnbW9lJyB9KTsKICAgKiAvLyA9PiAnaGVsbG86IG1vZScKICAgKgogICAqIHZhciBsaXN0ID0gJzwlIF8uZm9yRWFjaChwZW9wbGUsIGZ1bmN0aW9uKG5hbWUpIHsgJT4gPGxpPjwlPSBuYW1lICU+PC9saT4gPCUgfSk7ICU+JzsKICAgKiBfLnRlbXBsYXRlKGxpc3QsIHsgJ3Blb3BsZSc6IFsnbW9lJywgJ2N1cmx5JywgJ2xhcnJ5J10gfSk7CiAgICogLy8gPT4gJzxsaT5tb2U8L2xpPjxsaT5jdXJseTwvbGk+PGxpPmxhcnJ5PC9saT4nCiAgICoKICAgKiB2YXIgdGVtcGxhdGUgPSBfLnRlbXBsYXRlKCc8Yj48JS0gdmFsdWUgJT48L2I+Jyk7CiAgICogdGVtcGxhdGUoeyAndmFsdWUnOiAnPHNjcmlwdD4nIH0pOwogICAqIC8vID0+ICc8Yj4mbHQ7c2NyaXB0PjwvYj4nCiAgICoKICAgKiAvLyB1c2luZyBgcHJpbnRgCiAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnPCUgcHJpbnQoIkhlbGxvICIgKyBlcGl0aGV0KTsgJT4nKTsKICAgKiBjb21waWxlZCh7ICdlcGl0aGV0JzogJ3N0b29nZScgfSk7CiAgICogLy8gPT4gJ0hlbGxvIHN0b29nZS4nCiAgICoKICAgKiAvLyB1c2luZyBjdXN0b20gdGVtcGxhdGUgc2V0dGluZ3MKICAgKiBfLnRlbXBsYXRlU2V0dGluZ3MgPSB7CiAgICogICAnaW50ZXJwb2xhdGUnOiAvXHtceyguKz8pXH1cfS9nCiAgICogfTsKICAgKgogICAqIHZhciB0ZW1wbGF0ZSA9IF8udGVtcGxhdGUoJ0hlbGxvIHt7IG5hbWUgfX0hJyk7CiAgICogdGVtcGxhdGUoeyAnbmFtZSc6ICdNdXN0YWNoZScgfSk7CiAgICogLy8gPT4gJ0hlbGxvIE11c3RhY2hlIScKICAgKgogICAqIC8vIHVzaW5nIHRoZSBgdmFyaWFibGVgIG9wdGlvbgogICAqIF8udGVtcGxhdGUoJzwlPSBkYXRhLmhhc1dpdGggJT4nLCB7ICdoYXNXaXRoJzogJ25vJyB9LCB7ICd2YXJpYWJsZSc6ICdkYXRhJyB9KTsKICAgKiAvLyA9PiAnbm8nCiAgICoKICAgKiAvLyB1c2luZyB0aGUgYHNvdXJjZWAgcHJvcGVydHkKICAgKiA8c2NyaXB0PgogICAqICAgSlNULnByb2plY3QgPSA8JT0gXy50ZW1wbGF0ZShqc3RUZXh0KS5zb3VyY2UgJT47CiAgICogPC9zY3JpcHQ+CiAgICovCiAgZnVuY3Rpb24gdGVtcGxhdGUodGV4dCwgZGF0YSwgb3B0aW9ucykgewogICAgLy8gYmFzZWQgb24gSm9obiBSZXNpZydzIGB0bXBsYCBpbXBsZW1lbnRhdGlvbgogICAgLy8gaHR0cDovL2Vqb2huLm9yZy9ibG9nL2phdmFzY3JpcHQtbWljcm8tdGVtcGxhdGluZy8KICAgIC8vIGFuZCBMYXVyYSBEb2t0b3JvdmEncyBkb1QuanMKICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9vbGFkby9kb1QKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgdmFyIGlzRXZhbHVhdGluZywKICAgICAgICByZXN1bHQsCiAgICAgICAgZXNjYXBlRGVsaW1pdGVyID0gb3B0aW9ucy5lc2NhcGUsCiAgICAgICAgZXZhbHVhdGVEZWxpbWl0ZXIgPSBvcHRpb25zLmV2YWx1YXRlLAogICAgICAgIGludGVycG9sYXRlRGVsaW1pdGVyID0gb3B0aW9ucy5pbnRlcnBvbGF0ZSwKICAgICAgICBzZXR0aW5ncyA9IGxvZGFzaC50ZW1wbGF0ZVNldHRpbmdzLAogICAgICAgIHZhcmlhYmxlID0gb3B0aW9ucy52YXJpYWJsZTsKCiAgICAvLyB1c2UgZGVmYXVsdCBzZXR0aW5ncyBpZiBubyBvcHRpb25zIG9iamVjdCBpcyBwcm92aWRlZAogICAgaWYgKGVzY2FwZURlbGltaXRlciA9PSBudWxsKSB7CiAgICAgIGVzY2FwZURlbGltaXRlciA9IHNldHRpbmdzLmVzY2FwZTsKICAgIH0KICAgIGlmIChldmFsdWF0ZURlbGltaXRlciA9PSBudWxsKSB7CiAgICAgIGV2YWx1YXRlRGVsaW1pdGVyID0gc2V0dGluZ3MuZXZhbHVhdGU7CiAgICB9CiAgICBpZiAoaW50ZXJwb2xhdGVEZWxpbWl0ZXIgPT0gbnVsbCkgewogICAgICBpbnRlcnBvbGF0ZURlbGltaXRlciA9IHNldHRpbmdzLmludGVycG9sYXRlOwogICAgfQoKICAgIC8vIHRva2VuaXplIGRlbGltaXRlcnMgdG8gYXZvaWQgZXNjYXBpbmcgdGhlbQogICAgaWYgKGVzY2FwZURlbGltaXRlcikgewogICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKGVzY2FwZURlbGltaXRlciwgdG9rZW5pemVFc2NhcGUpOwogICAgfQogICAgaWYgKGludGVycG9sYXRlRGVsaW1pdGVyKSB7CiAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoaW50ZXJwb2xhdGVEZWxpbWl0ZXIsIHRva2VuaXplSW50ZXJwb2xhdGUpOwogICAgfQogICAgaWYgKGV2YWx1YXRlRGVsaW1pdGVyICE9IGxhc3RFdmFsdWF0ZURlbGltaXRlcikgewogICAgICAvLyBnZW5lcmF0ZSBgcmVFdmFsdWF0ZURlbGltaXRlcmAgdG8gbWF0Y2ggYF8udGVtcGxhdGVTZXR0aW5ncy5ldmFsdWF0ZWAKICAgICAgLy8gYW5kIGludGVybmFsIGA8ZSUtICU+YCwgYDxlJT0gJT5gIGRlbGltaXRlcnMKICAgICAgbGFzdEV2YWx1YXRlRGVsaW1pdGVyID0gZXZhbHVhdGVEZWxpbWl0ZXI7CiAgICAgIHJlRXZhbHVhdGVEZWxpbWl0ZXIgPSBSZWdFeHAoCiAgICAgICAgKGV2YWx1YXRlRGVsaW1pdGVyID8gZXZhbHVhdGVEZWxpbWl0ZXIuc291cmNlIDogJygkXiknKSArCiAgICAgICAgJ3w8ZSUtKFtcXHNcXFNdKz8pJT58PGUlPShbXFxzXFxTXSs/KSU+JwogICAgICAsICdnJyk7CiAgICB9CiAgICBpc0V2YWx1YXRpbmcgPSB0b2tlbml6ZWQubGVuZ3RoOwogICAgdGV4dCA9IHRleHQucmVwbGFjZShyZUV2YWx1YXRlRGVsaW1pdGVyLCB0b2tlbml6ZUV2YWx1YXRlKTsKICAgIGlzRXZhbHVhdGluZyA9IGlzRXZhbHVhdGluZyAhPSB0b2tlbml6ZWQubGVuZ3RoOwoKICAgIC8vIGVzY2FwZSBjaGFyYWN0ZXJzIHRoYXQgY2Fubm90IGJlIGluY2x1ZGVkIGluIHN0cmluZyBsaXRlcmFscyBhbmQKICAgIC8vIGRldG9rZW5pemUgZGVsaW1pdGVyIGNvZGUgc25pcHBldHMKICAgIHRleHQgPSAiX19wICs9ICciICsgdGV4dAogICAgICAucmVwbGFjZShyZVVuZXNjYXBlZFN0cmluZywgZXNjYXBlU3RyaW5nQ2hhcikKICAgICAgLnJlcGxhY2UocmVUb2tlbiwgZGV0b2tlbml6ZSkgKyAiJztcbiI7CgogICAgLy8gY2xlYXIgc3RvcmVkIGNvZGUgc25pcHBldHMKICAgIHRva2VuaXplZC5sZW5ndGggPSAwOwoKICAgIC8vIGlmIGBvcHRpb25zLnZhcmlhYmxlYCBpcyBub3Qgc3BlY2lmaWVkIGFuZCB0aGUgdGVtcGxhdGUgY29udGFpbnMgImV2YWx1YXRlIgogICAgLy8gZGVsaW1pdGVycywgd3JhcCBhIHdpdGgtc3RhdGVtZW50IGFyb3VuZCB0aGUgZ2VuZXJhdGVkIGNvZGUgdG8gYWRkIHRoZQogICAgLy8gZGF0YSBvYmplY3QgdG8gdGhlIHRvcCBvZiB0aGUgc2NvcGUgY2hhaW4KICAgIGlmICghdmFyaWFibGUpIHsKICAgICAgdmFyaWFibGUgPSBzZXR0aW5ncy52YXJpYWJsZSB8fCBsYXN0VmFyaWFibGUgfHwgJ29iaic7CgogICAgICBpZiAoaXNFdmFsdWF0aW5nKSB7CiAgICAgICAgdGV4dCA9ICd3aXRoICgnICsgdmFyaWFibGUgKyAnKSB7XG4nICsgdGV4dCArICdcbn1cbic7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgaWYgKHZhcmlhYmxlICE9IGxhc3RWYXJpYWJsZSkgewogICAgICAgICAgLy8gZ2VuZXJhdGUgYHJlRG91YmxlVmFyaWFibGVgIHRvIG1hdGNoIHJlZmVyZW5jZXMgbGlrZSBgb2JqLm9iamAgaW5zaWRlCiAgICAgICAgICAvLyB0cmFuc2Zvcm1lZCAiZXNjYXBlIiBhbmQgImludGVycG9sYXRlIiBkZWxpbWl0ZXJzCiAgICAgICAgICBsYXN0VmFyaWFibGUgPSB2YXJpYWJsZTsKICAgICAgICAgIHJlRG91YmxlVmFyaWFibGUgPSBSZWdFeHAoJyhcXChcXHMqKScgKyB2YXJpYWJsZSArICdcXC4nICsgdmFyaWFibGUgKyAnXFxiJywgJ2cnKTsKICAgICAgICB9CiAgICAgICAgLy8gYXZvaWQgYSB3aXRoLXN0YXRlbWVudCBieSBwcmVwZW5kaW5nIGRhdGEgb2JqZWN0IHJlZmVyZW5jZXMgdG8gcHJvcGVydHkgbmFtZXMKICAgICAgICB0ZXh0ID0gdGV4dAogICAgICAgICAgLnJlcGxhY2UocmVJbnNlcnRWYXJpYWJsZSwgJyQmJyArIHZhcmlhYmxlICsgJy4nKQogICAgICAgICAgLnJlcGxhY2UocmVEb3VibGVWYXJpYWJsZSwgJyQxX19kJyk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBjbGVhbnVwIGNvZGUgYnkgc3RyaXBwaW5nIGVtcHR5IHN0cmluZ3MKICAgIHRleHQgPSAoIGlzRXZhbHVhdGluZyA/IHRleHQucmVwbGFjZShyZUVtcHR5U3RyaW5nTGVhZGluZywgJycpIDogdGV4dCkKICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ01pZGRsZSwgJyQxJykKICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ1RyYWlsaW5nLCAnJDE7Jyk7CgogICAgLy8gZnJhbWUgY29kZSBhcyB0aGUgZnVuY3Rpb24gYm9keQogICAgdGV4dCA9ICdmdW5jdGlvbignICsgdmFyaWFibGUgKyAnKSB7XG4nICsKICAgICAgdmFyaWFibGUgKyAnIHx8ICgnICsgdmFyaWFibGUgKyAnID0ge30pO1xuJyArCiAgICAgICd2YXIgX190LCBfX3AgPSBcJ1wnLCBfX2UgPSBfLmVzY2FwZScgKwogICAgICAoaXNFdmFsdWF0aW5nCiAgICAgICAgPyAnLCBfX2ogPSBBcnJheS5wcm90b3R5cGUuam9pbjtcbicgKwogICAgICAgICAgJ2Z1bmN0aW9uIHByaW50KCkgeyBfX3AgKz0gX19qLmNhbGwoYXJndW1lbnRzLCBcJ1wnKSB9XG4nCiAgICAgICAgOiAnLCBfX2QgPSAnICsgdmFyaWFibGUgKyAnLicgKyB2YXJpYWJsZSArICcgfHwgJyArIHZhcmlhYmxlICsgJztcbicKICAgICAgKSArCiAgICAgIHRleHQgKwogICAgICAncmV0dXJuIF9fcFxufSc7CgogICAgLy8gYWRkIGEgc291cmNlVVJMIGZvciBlYXNpZXIgZGVidWdnaW5nCiAgICAvLyBodHRwOi8vd3d3Lmh0bWw1cm9ja3MuY29tL2VuL3R1dG9yaWFscy9kZXZlbG9wZXJ0b29scy9zb3VyY2VtYXBzLyN0b2Mtc291cmNldXJsCiAgICBpZiAodXNlU291cmNlVVJMKSB7CiAgICAgIHRleHQgKz0gJ1xuLy9AIHNvdXJjZVVSTD0vbG9kYXNoL3RlbXBsYXRlL3NvdXJjZVsnICsgKHRlbXBsYXRlQ291bnRlcisrKSArICddJzsKICAgIH0KCiAgICB0cnkgewogICAgICByZXN1bHQgPSBGdW5jdGlvbignXycsICdyZXR1cm4gJyArIHRleHQpKGxvZGFzaCk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgcmVzdWx0ID0gZnVuY3Rpb24oKSB7IHRocm93IGU7IH07CiAgICB9CgogICAgaWYgKGRhdGEpIHsKICAgICAgcmV0dXJuIHJlc3VsdChkYXRhKTsKICAgIH0KICAgIC8vIHByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uJ3Mgc291cmNlIHZpYSBpdHMgYHRvU3RyaW5nYCBtZXRob2QsIGluCiAgICAvLyBzdXBwb3J0ZWQgZW52aXJvbm1lbnRzLCBvciB0aGUgYHNvdXJjZWAgcHJvcGVydHkgYXMgYSBjb252ZW5pZW5jZSBmb3IKICAgIC8vIGJ1aWxkIHRpbWUgcHJlY29tcGlsYXRpb24KICAgIHJlc3VsdC5zb3VyY2UgPSB0ZXh0OwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIEV4ZWN1dGVzIHRoZSBgY2FsbGJhY2tgIGZ1bmN0aW9uIGBuYCB0aW1lcy4gVGhlIGBjYWxsYmFja2AgaXMgYm91bmQgdG8KICAgKiBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCAxIGFyZ3VtZW50OyAoaW5kZXgpLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7TnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgdGltZXMgdG8gZXhlY3V0ZSB0aGUgY2FsbGJhY2suCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAqIEBwYXJhbSB7TWl4ZWR9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjay4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy50aW1lcygzLCBmdW5jdGlvbigpIHsgZ2VuaWUuZ3JhbnRXaXNoKCk7IH0pOwogICAqIC8vID0+IGNhbGxzIGBnZW5pZS5ncmFudFdpc2goKWAgMyB0aW1lcwogICAqCiAgICogXy50aW1lcygzLCBmdW5jdGlvbigpIHsgdGhpcy5ncmFudFdpc2goKTsgfSwgZ2VuaWUpOwogICAqIC8vID0+IGFsc28gY2FsbHMgYGdlbmllLmdyYW50V2lzaCgpYCAzIHRpbWVzCiAgICovCiAgZnVuY3Rpb24gdGltZXMobiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIHZhciBpbmRleCA9IC0xOwogICAgaWYgKHRoaXNBcmcpIHsKICAgICAgd2hpbGUgKCsraW5kZXggPCBuKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzQXJnLCBpbmRleCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbikgewogICAgICAgIGNhbGxiYWNrKGluZGV4KTsKICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICogR2VuZXJhdGVzIGEgdW5pcXVlIGlkLiBJZiBgcHJlZml4YCBpcyBwYXNzZWQsIHRoZSBpZCB3aWxsIGJlIGFwcGVuZGVkIHRvIGl0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAqIEBwYXJhbSB7U3RyaW5nfSBbcHJlZml4XSBUaGUgdmFsdWUgdG8gcHJlZml4IHRoZSBpZCB3aXRoLgogICAqIEByZXR1cm5zIHtOdW1iZXJ8U3RyaW5nfSBSZXR1cm5zIGEgbnVtZXJpYyBpZCBpZiBubyBwcmVmaXggaXMgcGFzc2VkLCBlbHNlCiAgICogIGEgc3RyaW5nIGlkIG1heSBiZSByZXR1cm5lZC4KICAgKiBAZXhhbXBsZQogICAqCiAgICogXy51bmlxdWVJZCgnY29udGFjdF8nKTsKICAgKiAvLyA9PiAnY29udGFjdF8xMDQnCiAgICovCiAgZnVuY3Rpb24gdW5pcXVlSWQocHJlZml4KSB7CiAgICB2YXIgaWQgPSBpZENvdW50ZXIrKzsKICAgIHJldHVybiBwcmVmaXggPyBwcmVmaXggKyBpZCA6IGlkOwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIFdyYXBzIHRoZSB2YWx1ZSBpbiBhIGBsb2Rhc2hgIHdyYXBwZXIgb2JqZWN0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENoYWluaW5nCiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAuCiAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgd3JhcHBlciBvYmplY3QuCiAgICogQGV4YW1wbGUKICAgKgogICAqIHZhciBzdG9vZ2VzID0gWwogICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgKiAgIHsgJ25hbWUnOiAnY3VybHknLCAnYWdlJzogNjAgfQogICAqIF07CiAgICoKICAgKiB2YXIgeW91bmdlc3QgPSBfLmNoYWluKHN0b29nZXMpCiAgICogICAgIC5zb3J0QnkoZnVuY3Rpb24oc3Rvb2dlKSB7IHJldHVybiBzdG9vZ2UuYWdlOyB9KQogICAqICAgICAubWFwKGZ1bmN0aW9uKHN0b29nZSkgeyByZXR1cm4gc3Rvb2dlLm5hbWUgKyAnIGlzICcgKyBzdG9vZ2UuYWdlOyB9KQogICAqICAgICAuZmlyc3QoKQogICAqICAgICAudmFsdWUoKTsKICAgKiAvLyA9PiAnbW9lIGlzIDQwJwogICAqLwogIGZ1bmN0aW9uIGNoYWluKHZhbHVlKSB7CiAgICB2YWx1ZSA9IG5ldyBMb0Rhc2godmFsdWUpOwogICAgdmFsdWUuX2NoYWluID0gdHJ1ZTsKICAgIHJldHVybiB2YWx1ZTsKICB9CgogIC8qKgogICAqIEludm9rZXMgYGludGVyY2VwdG9yYCB3aXRoIHRoZSBgdmFsdWVgIGFzIHRoZSBmaXJzdCBhcmd1bWVudCwgYW5kIHRoZW4KICAgKiByZXR1cm5zIGB2YWx1ZWAuIFRoZSBwdXJwb3NlIG9mIHRoaXMgbWV0aG9kIGlzIHRvICJ0YXAgaW50byIgYSBtZXRob2QgY2hhaW4sCiAgICogaW4gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbiB0aGUgY2hhaW4uCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgY2FsbGJhY2tgLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGludGVyY2VwdG9yIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8uY2hhaW4oWzEsMiwzLDIwMF0pCiAgICogIC5maWx0ZXIoZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pCiAgICogIC50YXAoYWxlcnQpCiAgICogIC5tYXAoZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiBudW0gfSkKICAgKiAgLnZhbHVlKCk7CiAgICogLy8gPT4gLy8gWzIsIDIwMF0gKGFsZXJ0ZWQpCiAgICogLy8gPT4gWzQsIDQwMDAwXQogICAqLwogIGZ1bmN0aW9uIHRhcCh2YWx1ZSwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKHZhbHVlKTsKICAgIHJldHVybiB2YWx1ZTsKICB9CgogIC8qKgogICAqIEVuYWJsZXMgbWV0aG9kIGNoYWluaW5nIG9uIHRoZSB3cmFwcGVyIG9iamVjdC4KICAgKgogICAqIEBuYW1lIGNoYWluCiAgICogQGRlcHJlY2F0ZWQKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAqIEByZXR1cm5zIHtNaXhlZH0gUmV0dXJucyB0aGUgd3JhcHBlciBvYmplY3QuCiAgICogQGV4YW1wbGUKICAgKgogICAqIF8oWzEsIDIsIDNdKS52YWx1ZSgpOwogICAqIC8vID0+IFsxLCAyLCAzXQogICAqLwogIGZ1bmN0aW9uIHdyYXBwZXJDaGFpbigpIHsKICAgIHRoaXMuX2NoYWluID0gdHJ1ZTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgLyoqCiAgICogRXh0cmFjdHMgdGhlIHdyYXBwZWQgdmFsdWUuCiAgICoKICAgKiBAbmFtZSB2YWx1ZQogICAqIEBtZW1iZXJPZiBfCiAgICogQGNhdGVnb3J5IENoYWluaW5nCiAgICogQHJldHVybnMge01peGVkfSBSZXR1cm5zIHRoZSB3cmFwcGVkIHZhbHVlLgogICAqIEBleGFtcGxlCiAgICoKICAgKiBfKFsxLCAyLCAzXSkudmFsdWUoKTsKICAgKiAvLyA9PiBbMSwgMiwgM10KICAgKi8KICBmdW5jdGlvbiB3cmFwcGVyVmFsdWUoKSB7CiAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBUaGUgc2VtYW50aWMgdmVyc2lvbiBudW1iZXIuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAdHlwZSBTdHJpbmcKICAgKi8KICBsb2Rhc2guVkVSU0lPTiA9ICcwLjQuMSc7CgogIC8vIGFzc2lnbiBzdGF0aWMgbWV0aG9kcwogIGxvZGFzaC5hZnRlciA9IGFmdGVyOwogIGxvZGFzaC5iaW5kID0gYmluZDsKICBsb2Rhc2guYmluZEFsbCA9IGJpbmRBbGw7CiAgbG9kYXNoLmNoYWluID0gY2hhaW47CiAgbG9kYXNoLmNsb25lID0gY2xvbmU7CiAgbG9kYXNoLmNvbXBhY3QgPSBjb21wYWN0OwogIGxvZGFzaC5jb21wb3NlID0gY29tcG9zZTsKICBsb2Rhc2guY29udGFpbnMgPSBjb250YWluczsKICBsb2Rhc2guZGVib3VuY2UgPSBkZWJvdW5jZTsKICBsb2Rhc2guZGVmYXVsdHMgPSBkZWZhdWx0czsKICBsb2Rhc2guZGVmZXIgPSBkZWZlcjsKICBsb2Rhc2guZGVsYXkgPSBkZWxheTsKICBsb2Rhc2guZGlmZmVyZW5jZSA9IGRpZmZlcmVuY2U7CiAgbG9kYXNoLmVzY2FwZSA9IGVzY2FwZTsKICBsb2Rhc2guZXZlcnkgPSBldmVyeTsKICBsb2Rhc2guZXh0ZW5kID0gZXh0ZW5kOwogIGxvZGFzaC5maWx0ZXIgPSBmaWx0ZXI7CiAgbG9kYXNoLmZpbmQgPSBmaW5kOwogIGxvZGFzaC5maXJzdCA9IGZpcnN0OwogIGxvZGFzaC5mbGF0dGVuID0gZmxhdHRlbjsKICBsb2Rhc2guZm9yRWFjaCA9IGZvckVhY2g7CiAgbG9kYXNoLmZvckluID0gZm9ySW47CiAgbG9kYXNoLmZvck93biA9IGZvck93bjsKICBsb2Rhc2guZnVuY3Rpb25zID0gZnVuY3Rpb25zOwogIGxvZGFzaC5ncm91cEJ5ID0gZ3JvdXBCeTsKICBsb2Rhc2guaGFzID0gaGFzOwogIGxvZGFzaC5pZGVudGl0eSA9IGlkZW50aXR5OwogIGxvZGFzaC5pbmRleE9mID0gaW5kZXhPZjsKICBsb2Rhc2guaW5pdGlhbCA9IGluaXRpYWw7CiAgbG9kYXNoLmludGVyc2VjdGlvbiA9IGludGVyc2VjdGlvbjsKICBsb2Rhc2guaW52b2tlID0gaW52b2tlOwogIGxvZGFzaC5pc0FyZ3VtZW50cyA9IGlzQXJndW1lbnRzOwogIGxvZGFzaC5pc0FycmF5ID0gaXNBcnJheTsKICBsb2Rhc2guaXNCb29sZWFuID0gaXNCb29sZWFuOwogIGxvZGFzaC5pc0RhdGUgPSBpc0RhdGU7CiAgbG9kYXNoLmlzRWxlbWVudCA9IGlzRWxlbWVudDsKICBsb2Rhc2guaXNFbXB0eSA9IGlzRW1wdHk7CiAgbG9kYXNoLmlzRXF1YWwgPSBpc0VxdWFsOwogIGxvZGFzaC5pc0Zpbml0ZSA9IGlzRmluaXRlOwogIGxvZGFzaC5pc0Z1bmN0aW9uID0gaXNGdW5jdGlvbjsKICBsb2Rhc2guaXNOYU4gPSBpc05hTjsKICBsb2Rhc2guaXNOdWxsID0gaXNOdWxsOwogIGxvZGFzaC5pc051bWJlciA9IGlzTnVtYmVyOwogIGxvZGFzaC5pc09iamVjdCA9IGlzT2JqZWN0OwogIGxvZGFzaC5pc1JlZ0V4cCA9IGlzUmVnRXhwOwogIGxvZGFzaC5pc1N0cmluZyA9IGlzU3RyaW5nOwogIGxvZGFzaC5pc1VuZGVmaW5lZCA9IGlzVW5kZWZpbmVkOwogIGxvZGFzaC5rZXlzID0ga2V5czsKICBsb2Rhc2gubGFzdCA9IGxhc3Q7CiAgbG9kYXNoLmxhc3RJbmRleE9mID0gbGFzdEluZGV4T2Y7CiAgbG9kYXNoLm1hcCA9IG1hcDsKICBsb2Rhc2gubWF4ID0gbWF4OwogIGxvZGFzaC5tZW1vaXplID0gbWVtb2l6ZTsKICBsb2Rhc2gubWluID0gbWluOwogIGxvZGFzaC5taXhpbiA9IG1peGluOwogIGxvZGFzaC5ub0NvbmZsaWN0ID0gbm9Db25mbGljdDsKICBsb2Rhc2gub25jZSA9IG9uY2U7CiAgbG9kYXNoLnBhcnRpYWwgPSBwYXJ0aWFsOwogIGxvZGFzaC5waWNrID0gcGljazsKICBsb2Rhc2gucGx1Y2sgPSBwbHVjazsKICBsb2Rhc2gucmFuZ2UgPSByYW5nZTsKICBsb2Rhc2gucmVkdWNlID0gcmVkdWNlOwogIGxvZGFzaC5yZWR1Y2VSaWdodCA9IHJlZHVjZVJpZ2h0OwogIGxvZGFzaC5yZWplY3QgPSByZWplY3Q7CiAgbG9kYXNoLnJlc3QgPSByZXN0OwogIGxvZGFzaC5yZXN1bHQgPSByZXN1bHQ7CiAgbG9kYXNoLnNodWZmbGUgPSBzaHVmZmxlOwogIGxvZGFzaC5zaXplID0gc2l6ZTsKICBsb2Rhc2guc29tZSA9IHNvbWU7CiAgbG9kYXNoLnNvcnRCeSA9IHNvcnRCeTsKICBsb2Rhc2guc29ydGVkSW5kZXggPSBzb3J0ZWRJbmRleDsKICBsb2Rhc2gudGFwID0gdGFwOwogIGxvZGFzaC50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogIGxvZGFzaC50aHJvdHRsZSA9IHRocm90dGxlOwogIGxvZGFzaC50aW1lcyA9IHRpbWVzOwogIGxvZGFzaC50b0FycmF5ID0gdG9BcnJheTsKICBsb2Rhc2gudW5pb24gPSB1bmlvbjsKICBsb2Rhc2gudW5pcSA9IHVuaXE7CiAgbG9kYXNoLnVuaXF1ZUlkID0gdW5pcXVlSWQ7CiAgbG9kYXNoLnZhbHVlcyA9IHZhbHVlczsKICBsb2Rhc2gud2l0aG91dCA9IHdpdGhvdXQ7CiAgbG9kYXNoLndyYXAgPSB3cmFwOwogIGxvZGFzaC56aXAgPSB6aXA7CiAgbG9kYXNoLnppcE9iamVjdCA9IHppcE9iamVjdDsKCiAgLy8gYXNzaWduIGFsaWFzZXMKICBsb2Rhc2guYWxsID0gZXZlcnk7CiAgbG9kYXNoLmFueSA9IHNvbWU7CiAgbG9kYXNoLmNvbGxlY3QgPSBtYXA7CiAgbG9kYXNoLmRldGVjdCA9IGZpbmQ7CiAgbG9kYXNoLmVhY2ggPSBmb3JFYWNoOwogIGxvZGFzaC5mb2xkbCA9IHJlZHVjZTsKICBsb2Rhc2guZm9sZHIgPSByZWR1Y2VSaWdodDsKICBsb2Rhc2guaGVhZCA9IGZpcnN0OwogIGxvZGFzaC5pbmNsdWRlID0gY29udGFpbnM7CiAgbG9kYXNoLmluamVjdCA9IHJlZHVjZTsKICBsb2Rhc2gubWV0aG9kcyA9IGZ1bmN0aW9uczsKICBsb2Rhc2guc2VsZWN0ID0gZmlsdGVyOwogIGxvZGFzaC50YWlsID0gcmVzdDsKICBsb2Rhc2gudGFrZSA9IGZpcnN0OwogIGxvZGFzaC51bmlxdWUgPSB1bmlxOwoKICAvLyBhZGQgcHNldWRvIHByaXZhdGUgcHJvcGVydGllcyB1c2VkIGFuZCByZW1vdmVkIGR1cmluZyB0aGUgYnVpbGQgcHJvY2VzcwogIGxvZGFzaC5faXRlcmF0b3JUZW1wbGF0ZSA9IGl0ZXJhdG9yVGVtcGxhdGU7CiAgbG9kYXNoLl9zaGltS2V5cyA9IHNoaW1LZXlzOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLy8gYXNzaWduIHByaXZhdGUgYExvRGFzaGAgY29uc3RydWN0b3IncyBwcm90b3R5cGUKICBMb0Rhc2gucHJvdG90eXBlID0gbG9kYXNoLnByb3RvdHlwZTsKCiAgLy8gYWRkIGFsbCBzdGF0aWMgZnVuY3Rpb25zIHRvIGBMb0Rhc2gucHJvdG90eXBlYAogIG1peGluKGxvZGFzaCk7CgogIC8vIGFkZCBgTG9EYXNoLnByb3RvdHlwZS5jaGFpbmAgYWZ0ZXIgY2FsbGluZyBgbWl4aW4oKWAgdG8gYXZvaWQgb3ZlcndyaXRpbmcKICAvLyBpdCB3aXRoIHRoZSB3cmFwcGVkIGBsb2Rhc2guY2hhaW5gCiAgTG9EYXNoLnByb3RvdHlwZS5jaGFpbiA9IHdyYXBwZXJDaGFpbjsKICBMb0Rhc2gucHJvdG90eXBlLnZhbHVlID0gd3JhcHBlclZhbHVlOwoKICAvLyBhZGQgYWxsIG11dGF0b3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIGZvckVhY2goWydwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgdmFyIGZ1bmMgPSBBcnJheVByb3RvW21ldGhvZE5hbWVdOwoKICAgIExvRGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5fd3JhcHBlZDsKICAgICAgZnVuYy5hcHBseSh2YWx1ZSwgYXJndW1lbnRzKTsKCiAgICAgIC8vIElFIGNvbXBhdGliaWxpdHkgbW9kZSBhbmQgSUUgPCA5IGhhdmUgYnVnZ3kgQXJyYXkgYHNoaWZ0KClgIGFuZCBgc3BsaWNlKClgCiAgICAgIC8vIGZ1bmN0aW9ucyB0aGF0IGZhaWwgdG8gcmVtb3ZlIHRoZSBsYXN0IGVsZW1lbnQsIGB2YWx1ZVswXWAsIG9mCiAgICAgIC8vIGFycmF5LWxpa2Ugb2JqZWN0cyBldmVuIHRob3VnaCB0aGUgYGxlbmd0aGAgcHJvcGVydHkgaXMgc2V0IHRvIGAwYC4KICAgICAgLy8gVGhlIGBzaGlmdCgpYCBtZXRob2QgaXMgYnVnZ3kgaW4gSUUgOCBjb21wYXRpYmlsaXR5IG1vZGUsIHdoaWxlIGBzcGxpY2UoKWAKICAgICAgLy8gaXMgYnVnZ3kgcmVnYXJkbGVzcyBvZiBtb2RlIGluIElFIDwgOSBhbmQgYnVnZ3kgaW4gY29tcGF0aWJpbGl0eSBtb2RlIGluIElFIDkuCiAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICBkZWxldGUgdmFsdWVbMF07CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX2NoYWluKSB7CiAgICAgICAgdmFsdWUgPSBuZXcgTG9EYXNoKHZhbHVlKTsKICAgICAgICB2YWx1ZS5fY2hhaW4gPSB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH07CiAgfSk7CgogIC8vIGFkZCBhbGwgYWNjZXNzb3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIGZvckVhY2goWydjb25jYXQnLCAnam9pbicsICdzbGljZSddLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICB2YXIgZnVuYyA9IEFycmF5UHJvdG9bbWV0aG9kTmFtZV07CgogICAgTG9EYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFsdWUgPSB0aGlzLl93cmFwcGVkLAogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh2YWx1ZSwgYXJndW1lbnRzKTsKCiAgICAgIGlmICh0aGlzLl9jaGFpbikgewogICAgICAgIHJlc3VsdCA9IG5ldyBMb0Rhc2gocmVzdWx0KTsKICAgICAgICByZXN1bHQuX2NoYWluID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9KTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8vIGV4cG9zZSBMby1EYXNoCiAgLy8gc29tZSBBTUQgYnVpbGQgb3B0aW1pemVycywgbGlrZSByLmpzLCBjaGVjayBmb3Igc3BlY2lmaWMgY29uZGl0aW9uIHBhdHRlcm5zIGxpa2UgdGhlIGZvbGxvd2luZzoKICBpZiAodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBkZWZpbmUuYW1kID09ICdvYmplY3QnICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEV4cG9zZSBMby1EYXNoIHRvIHRoZSBnbG9iYWwgb2JqZWN0IGV2ZW4gd2hlbiBhbiBBTUQgbG9hZGVyIGlzIHByZXNlbnQgaW4KICAgIC8vIGNhc2UgTG8tRGFzaCB3YXMgaW5qZWN0ZWQgYnkgYSB0aGlyZC1wYXJ0eSBzY3JpcHQgYW5kIG5vdCBpbnRlbmRlZCB0byBiZQogICAgLy8gbG9hZGVkIGFzIGEgbW9kdWxlLiBUaGUgZ2xvYmFsIGFzc2lnbm1lbnQgY2FuIGJlIHJldmVydGVkIGluIHRoZSBMby1EYXNoCiAgICAvLyBtb2R1bGUgdmlhIGl0cyBgbm9Db25mbGljdCgpYCBtZXRob2QuCiAgICB3aW5kb3cuXyA9IGxvZGFzaDsKCiAgICAvLyBkZWZpbmUgYXMgYW4gYW5vbnltb3VzIG1vZHVsZSBzbywgdGhyb3VnaCBwYXRoIG1hcHBpbmcsIGl0IGNhbiBiZQogICAgLy8gcmVmZXJlbmNlZCBhcyB0aGUgInVuZGVyc2NvcmUiIG1vZHVsZQogICAgZGVmaW5lKCdsb2Rhc2gnLFtdLGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbG9kYXNoOwogICAgfSk7CiAgfQogIC8vIGNoZWNrIGZvciBgZXhwb3J0c2AgYWZ0ZXIgYGRlZmluZWAgaW4gY2FzZSBhIGJ1aWxkIG9wdGltaXplciBhZGRzIGFuIGBleHBvcnRzYCBvYmplY3QKICBlbHNlIGlmIChmcmVlRXhwb3J0cykgewogICAgLy8gaW4gTm9kZS5qcyBvciBSaW5nb0pTIHYwLjguMCsKICAgIGlmICh0eXBlb2YgbW9kdWxlID09ICdvYmplY3QnICYmIG1vZHVsZSAmJiBtb2R1bGUuZXhwb3J0cyA9PSBmcmVlRXhwb3J0cykgewogICAgICAobW9kdWxlLmV4cG9ydHMgPSBsb2Rhc2gpLl8gPSBsb2Rhc2g7CiAgICB9CiAgICAvLyBpbiBOYXJ3aGFsIG9yIFJpbmdvSlMgdjAuNy4wLQogICAgZWxzZSB7CiAgICAgIGZyZWVFeHBvcnRzLl8gPSBsb2Rhc2g7CiAgICB9CiAgfQogIGVsc2UgewogICAgLy8gaW4gYSBicm93c2VyIG9yIFJoaW5vCiAgICB3aW5kb3cuXyA9IGxvZGFzaDsKICB9Cn0odGhpcykpOwoKLyohIFRocnVzdCBKUyBGcmFtZXdvcmsgLSB2MC4xLjAgLSAyMDEyLTA4LTI5CiogdGhydXN0LWhvbWUKKiBDb3B5cmlnaHQgKGMpIDIwMTIgRGF2aWQgRHJpc2NvbGw7IExpY2Vuc2VkIE1JVCAqLwoKCmRlZmluZSgndGhydXN0L3V0aWwvYXJyYXknLFsnbG9kYXNoJ10sIGZ1bmN0aW9uIChfKQp7CiAgICAKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QtdXRpbC1hcnJheQogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmaXJzdF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2ZpcnN0KQoKICAgIEBmb3IgdGhydXN0LXV0aWwtYXJyYXkKICAgIEBtZXRob2QgZmlyc3QKICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZmlyc3RdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmaXJzdCkKCiAgICBAbWV0aG9kIGhlYWQKICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaW5pdGlhbF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2luaXRpYWwpCgogICAgQG1ldGhvZCBpbml0aWFsCiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2xhc3RdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNsYXN0KQoKICAgIEBtZXRob2QgbGFzdAogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyZXN0XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVzdCkKCiAgICBAbWV0aG9kIHRhaWwKICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVzdF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3Jlc3QpCgogICAgQG1ldGhvZCByZXN0CiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2NvbXBhY3RdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNjb21wYWN0KQoKICAgIEBtZXRob2QgY29tcGFjdAogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmbGF0dGVuXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZmxhdHRlbikKCiAgICBAbWV0aG9kIGZsYXR0ZW4KICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jd2l0aG91dF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3dpdGhvdXQpCgogICAgQG1ldGhvZCB3aXRob3V0CiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3VuaW9uXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdW5pb24pCgogICAgQG1ldGhvZCB1bmlvbgogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpbnRlcnNlY3Rpb25dKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpbnRlcnNlY3Rpb24pCgogICAgQG1ldGhvZCBpbnRlcnNlY3Rpb24KICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZGlmZmVyZW5jZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2RpZmZlcmVuY2UpCgogICAgQG1ldGhvZCBkaWZmZXJlbmNlCiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3VuaXFdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN1bmlxKQoKICAgIEBtZXRob2QgdW5pcQogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN1bmlxXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdW5pcSkKCiAgICBAbWV0aG9kIHVuaXF1ZQogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN6aXBdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN6aXApCgogICAgQG1ldGhvZCB6aXAKICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgICAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaW5kZXhPZl0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2luZGV4T2YpCgogICAgQG1ldGhvZCBpbmRleE9mCiAgICAqKi8KCiAgICAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICAgICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2xhc3RJbmRleE9mXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jbGFzdEluZGV4T2YpCgogICAgQG1ldGhvZCBsYXN0SW5kZXhPZgogICAgKiovCgogICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyYW5nZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3JhbmdlKQoKICAgIEBtZXRob2QgcmFuZ2UKICAgICoqLwoKICAgIHZhciBleHBvcnRzID0gXy5waWNrKF8sICdmaXJzdCcsICdoZWFkJywgJ2luaXRpYWwnLCAnbGFzdCcsICd0YWlsJywgJ3Jlc3QnLCAnY29tcGFjdCcsICdmbGF0dGVuJywgJ3dpdGhvdXQnLCAndW5pb24nLCAnaW50ZXJzZWN0aW9uJywgJ2RpZmZlcmVuY2UnLCAndW5pcScsICd1bmlxdWUnLCAnemlwJywgJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAncmFuZ2UnKTsKICAgIHJldHVybiBleHBvcnRzOwp9KTsKLy8vIDxyZWZlcmVuY2UgcGF0aD0iY29sbGVjdGlvbi5qcyIgLz4KZGVmaW5lKCd0aHJ1c3QvdXRpbC9jb2xsZWN0aW9uJyxbJ2xvZGFzaCddLCBmdW5jdGlvbiAoXykKewogICAgCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LXV0aWwtY29sbGVjdGlvbgogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZWFjaF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2VhY2gpCgogICAgQGZvciB0aHJ1c3QtdXRpbC1jb2xsZWN0aW9uCiAgICBAbWV0aG9kIGVhY2gKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2VhY2hdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNlYWNoKQoKICAgIEBtZXRob2QgZm9yRWFjaAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jbWFwXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jbWFwKQoKICAgIEBtZXRob2QgbWFwCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNtYXBdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNtYXApCgogICAgQG1ldGhvZCBjb2xsZWN0CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyZWR1Y2VdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyZWR1Y2UpCgogICAgQG1ldGhvZCByZWR1Y2UKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3JlZHVjZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3JlZHVjZSkKCiAgICBAbWV0aG9kIGluamVjdAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVkdWNlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVkdWNlKQoKICAgIEBtZXRob2QgZm9sZGwKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3JlZHVjZVJpZ2h0XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVkdWNlUmlnaHQpCgogICAgQG1ldGhvZCBmb2xkcgogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVkdWNlUmlnaHRdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNyZWR1Y2VSaWdodCkKCiAgICBAbWV0aG9kIHJlZHVjZVJpZ2h0CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmaW5kXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZmluZCkKCiAgICBAbWV0aG9kIGZpbmQKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2ZpbmRdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmaW5kKQoKICAgIEBtZXRob2QgZGV0ZWN0CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmaWx0ZXJdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNmaWx0ZXIpCgogICAgQG1ldGhvZCBmaWx0ZXIKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2ZpbHRlcl0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2ZpbHRlcikKCiAgICBAbWV0aG9kIHNlbGVjdAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVqZWN0XShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcmVqZWN0KQoKICAgIEBtZXRob2QgcmVqZWN0CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNhbGxdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNhbGwpCgogICAgQG1ldGhvZCBhbGwKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2FsbF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2FsbCkKCiAgICBAbWV0aG9kIGV2ZXJ5CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNhbnldKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNhbnkpCgogICAgQG1ldGhvZCBhbnkKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2FueV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2FueSkKCiAgICBAbWV0aG9kIHNvbWUKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2luY2x1ZGVdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpbmNsdWRlKQoKICAgIEBtZXRob2QgaW5jbHVkZQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaW5jbHVkZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2luY2x1ZGUpCgogICAgQG1ldGhvZCBjb250YWlucwogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaW52b2tlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaW52b2tlKQoKICAgIEBtZXRob2QgaW52b2tlCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNwbHVja10oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3BsdWNrKQoKICAgIEBtZXRob2QgcGx1Y2sKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI21heF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI21heCkKCiAgICBAbWV0aG9kIG1heAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jbWluXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jbWluKQoKICAgIEBtZXRob2QgbWluCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNzb3J0QnldKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNzb3J0QnkpCgogICAgQG1ldGhvZCBzb3J0QnkKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2dyb3VwQnldKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNncm91cEJ5KQoKICAgIEBtZXRob2QgZ3JvdXBCeQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jc29ydGVkSW5kZXhdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNzb3J0ZWRJbmRleCkKCiAgICBAbWV0aG9kIHNvcnRlZEluZGV4CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNzaHVmZmxlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jc2h1ZmZsZSkKCiAgICBAbWV0aG9kIHNodWZmbGUKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3RvQXJyYXldKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN0b0FycmF5KQoKICAgIEBtZXRob2QgdG9BcnJheQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jc2l6ZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3NpemUpCgogICAgQG1ldGhvZCBzaXplCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNleHRlbmRdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNleHRlbmQpCgogICAgQG1ldGhvZCBleHRlbmQKICAgICoqLwoKICAgIHZhciBleHBvcnRzID0gXy5waWNrKF8sICdlYWNoJywgJ2ZvckVhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2luamVjdCcsICdmb2xkbCcsICdyZWR1Y2VSaWdodCcsICdmb2xkcicsICdmaW5kJywgJ2RldGVjdCcsICdmaWx0ZXInLCAnc2VsZWN0JywgJ3JlamVjdCcsICdhbGwnLCAnZXZlcnknLCAnYW55JywgJ3NvbWUnLCAnaW5jbHVkZScsCiAgICAgICAgJ2NvbnRhaW5zJywgJ2ludm9rZScsICdwbHVjaycsICdtYXgnLCAnbWluJywgJ3NvcnRCeScsICdncm91cEJ5JywgJ3NvcnRlZEluZGV4JywgJ3NodWZmbGUnLCAndG9BcnJheScsICdzaXplJywgJ2V4dGVuZCcpOwogICAgcmV0dXJuIGV4cG9ydHM7Cn0pOwpkZWZpbmUoJ3RocnVzdC91dGlsL2Z1bmN0aW9uJyxbJ2xvZGFzaCddLCBmdW5jdGlvbiAoXykKewogICAgCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LXV0aWwtZnVuYwogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jYmluZF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2JpbmQpCgogICAgQGZvciB0aHJ1c3QtdXRpbC1mdW5jCiAgICBAbWV0aG9kIGJpbmQKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2JpbmRBbGxdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNiaW5kQWxsKQoKICAgIEBtZXRob2QgYmluZEFsbAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jbWVtb2l6ZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI21lbW9pemUpCgogICAgQG1ldGhvZCBtZW1vaXplCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNkZWxheV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2RlbGF5KQoKICAgIEBtZXRob2QgZGVsYXkKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2RlZmVyXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZGVmZXIpCgogICAgQG1ldGhvZCBkZWZlcgogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdGhyb3R0bGVdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN0aHJvdHRsZSkKCiAgICBAbWV0aG9kIHRocm90dGxlCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNkZWJvdW5jZV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2RlYm91bmNlKQoKICAgIEBtZXRob2QgZGVib3VuY2UKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI29uY2VdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNvbmNlKQoKICAgIEBtZXRob2Qgb25jZQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jYWZ0ZXJdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNhZnRlcikKCiAgICBAbWV0aG9kIGFmdGVyCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN3cmFwXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jd3JhcCkKCiAgICBAbWV0aG9kIHdyYXAKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2NvbXBvc2VdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNjb21wb3NlKQoKICAgIEBtZXRob2QgY29tcG9zZQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdW5pcXVlSWRdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN1bmlxdWVJZCkKCiAgICBAbWV0aG9kIHVuaXF1ZUlkCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNlc2NhcGVdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNlc2NhcGUpCgogICAgQG1ldGhvZCBlc2NhcGUKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3Jlc3VsdF0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3Jlc3VsdCkKCiAgICBAbWV0aG9kIHJlc3VsdAogICAgKiovCgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogICAgdmFyIGV4cG9ydHMgPSBfLnBpY2soXywgJ2JpbmQnLCAnYmluZEFsbCcsICdtZW1vaXplJywgJ2RlbGF5JywgJ2RlZmVyJywgJ3Rocm90dGxlJywgJ2RlYm91bmNlJywgJ29uY2UnLCAnYWZ0ZXInLCAnd3JhcCcsICdjb21wb3NlJywgJ3VuaXF1ZUlkJywgJ2VzY2FwZScsICdyZXN1bHQnKTsKCiAgICAvKioKICAgIEEgZnVuY3Rpb24gdGhhdCBkb2VzIG5vdGhpbmcsIG9yIG5vIG9wZXJhdGlvbi4gIEhlbmNlIHRoZSBuYW1lIG5vb3AuCgogICAgQG1ldGhvZCBub29wCiAgICAqKi8KICAgIHZhciBub29wID0gZXhwb3J0cy5ub29wID0gZnVuY3Rpb24gKCkgeyB9OwoKICAgIC8qKgogICAgQXR0ZW1wdHMgdG8gaW52b2tlLCBzaW1pbGFyIHRvIF8uaW52b2tlLCBidXQgaW4gdGhpcyBjYXNlIGl0IHZlcmlmaWVzIHRoYXQgdGhlIHByb3BlcnR5IGV4aXN0LAogICAgICAgIGFuZCBhbHNvIHZlcmlmaWVzIHRoYXQgaXQgaXMgYSBmdW5jdGlvbiwgYW5kIG5vdCB0aGUgbm9vcCBtZXRob2QgYXZhaWxhYmxlIGluIHRocnVzdC4KCiAgICAgICAgVGhlIGludGVudCBpcyBhIG1ldGhvZCB0aGF0IGFsbG93cyBvdmVycmlkZSBvZiBmdW5jdGlvbnMsIHdpdGhvdXQgY3JlYXRpbmcgY3VzdG9tIGNvZGUuCgogICAgQG1ldGhvZCBzYXZlSW52b2tlCiAgICBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29udGFpbmVyIHRoYXQgaGFzIHRoZSBpdGVtcwogICAgQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IG1ldGhvZCBUaGUgbWV0aG9kIG5hbWUgb24gZXZlcnkgaXRlbSwgb3IgdGhlIG1ldGhvZCB0byBpbnZva2UgYWdhaW5zdCBlYWNoIGl0ZW0uCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3NdKiBUaGUgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBtZXRob2QuCiAgICAqKi8KICAgIGV4cG9ydHMuc2FmZUludm9rZSA9IGZ1bmN0aW9uIChjb2xsZWN0aW9uLCBtZXRob2ROYW1lKQogICAgewogICAgICAgIHZhciBpbmRleCwgaXRlcmF0ZWUgPSBjb2xsZWN0aW9uLCByZXN1bHQ7CiAgICAgICAgaWYgKCFjb2xsZWN0aW9uKSByZXR1cm4gW107CiAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMiksCiAgICAgICAgICAgIGlzRnVuYyA9IHR5cGVvZiBtZXRob2ROYW1lID09ICdmdW5jdGlvbicsCiAgICAgICAgICAgIG1ldGhvZEV4aXN0czsKICAgICAgICB2YXIgbGVuZ3RoID0gaXRlcmF0ZWUubGVuZ3RoOyBpbmRleCA9IC0xOwogICAgICAgIGlmIChsZW5ndGggPT09IGxlbmd0aCA+Pj4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSk7CiAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgJiYgbWV0aG9kRXhpc3RzICE9PSBub29wICYmIChyZXN1bHRbaW5kZXhdID0gbWV0aG9kRXhpc3RzLmFwcGx5KGl0ZXJhdGVlW2luZGV4XSwgYXJncykpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHZhciBza2lwUHJvdG8gPSB0eXBlb2YgaXRlcmF0ZWUgPT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgICAgICAgIHByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoaXRlcmF0ZWUsICdwcm90b3R5cGUnKTsKCiAgICAgICAgICAgIHZhciBwcm9wcyA9IF8ua2V5cyhpdGVyYXRlZSksCiAgICAgICAgICAgICAgICBwcm9wSW5kZXggPSAtMSwKICAgICAgICAgICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKCiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlICgrK3Byb3BJbmRleCA8IGxlbmd0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaW5kZXggPSBwcm9wc1twcm9wSW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKCEoc2tpcFByb3RvICYmIGluZGV4ID09ICdwcm90b3R5cGUnKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzICYmIG1ldGhvZEV4aXN0cyAhPT0gbm9vcCAmJiAocmVzdWx0W3Byb3BJbmRleF0gPSAoKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pLmFwcGx5KGl0ZXJhdGVlW2luZGV4XSwgYXJncykpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CgogICAgLyoqCgkgKiBDb25zdHJ1Y3RvciB1c2VkIHRvIGJlZ2V0IG9iamVjdHMgdGhhdCB3aXJlIG5lZWRzIHRvIGNyZWF0ZSB1c2luZyBuZXcuCgkgKiBAcGFyYW0gY3RvciB7RnVuY3Rpb259IHJlYWwgY29uc3RydWN0b3IgdG8gYmUgaW52b2tlZAoJICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcmd1bWVudHMgdG8gYmUgc3VwcGxpZWQgdG8gY3RvcgoJICovCiAgICBmdW5jdGlvbiBCZWdldHRlcihjdG9yLCBhcmdzKQogICAgewogICAgICAgIHJldHVybiBjdG9yLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfQoKICAgIC8qKgoJICogQ3JlYXRlcyBhbiBvYmplY3QgYnkgZWl0aGVyIGludm9raW5nIGN0b3IgYXMgYSBmdW5jdGlvbiBhbmQgcmV0dXJuaW5nIHRoZSByZXN1bHQsCgkgKiBvciBieSBjYWxsaW5nIG5ldyBjdG9yKCkuICBJdCB1c2VzIGEgc2ltcGxlIGhldXJpc3RpYyB0byB0cnkgdG8gZ3Vlc3Mgd2hpY2ggYXBwcm9hY2gKCSAqIGlzIHRoZSAicmlnaHQiIG9uZS4KCSAqCgkgKiBAcGFyYW0gY3RvciB7RnVuY3Rpb259IGZ1bmN0aW9uIG9yIGNvbnN0cnVjdG9yIHRvIGludm9rZQoJICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcnJheSBvZiBhcmd1bWVudHMgdG8gcGFzcyB0byBjdG9yIGluIGVpdGhlciBjYXNlCgkgKgoJICogQHJldHVybnMgVGhlIHJlc3VsdCBvZiBpbnZva2luZyBjdG9yIHdpdGggYXJncywgd2l0aCBvciB3aXRob3V0IG5ldywgZGVwZW5kaW5nIG9uCgkgKiB0aGUgc3RyYXRlZ3kgc2VsZWN0ZWQuCgkgKi8KICAgIGV4cG9ydHMuaW5zdGFudGlhdGUgPSBmdW5jdGlvbiAoY3RvciwgYXJncykKICAgIHsKICAgICAgICBCZWdldHRlci5wcm90b3R5cGUgPSBjdG9yLnByb3RvdHlwZTsKICAgICAgICBCZWdldHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yOwogICAgICAgIHZhciBiZWdvdHRlbiA9IG5ldyBCZWdldHRlcihjdG9yLCBhcmdzKTsKICAgICAgICBCZWdldHRlci5wcm90b3R5cGUgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIGJlZ290dGVuOwogICAgfTsKCiAgICByZXR1cm4gZXhwb3J0czsKfSk7CmRlZmluZSgndGhydXN0L3V0aWwvb2JqZWN0JyxbJ2xvZGFzaCddLCBmdW5jdGlvbiAoXykKewogICAgCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LXV0aWwtb2JqCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNrZXlzXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8ja2V5cykKCiAgICBAZm9yIHRocnVzdC11dGlsLW9iagogICAgQG1ldGhvZCBrZXlzCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN2YWx1ZXNdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyN2YWx1ZXMpCgogICAgQG1ldGhvZCB2YWx1ZXMKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2Z1bmN0aW9uc10oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2Z1bmN0aW9ucykKCiAgICBAbWV0aG9kIGZ1bmN0aW9ucwogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZnVuY3Rpb25zXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jZnVuY3Rpb25zKQoKICAgIEBtZXRob2QgbWV0aG9kcwogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jcGlja10oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3BpY2spCgogICAgQG1ldGhvZCBwaWNrCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNkZWZhdWx0c10oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2RlZmF1bHRzKQoKICAgIEBtZXRob2QgZGVmYXVsdHMKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2Nsb25lXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jY2xvbmUpCgogICAgQG1ldGhvZCBjbG9uZQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdGFwXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdGFwKQoKICAgIEBtZXRob2QgdGFwCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNoYXNdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNoYXMpCgogICAgQG1ldGhvZCBoYXMKICAgICoqLwoKICAgIHZhciBleHBvcnRzID0gXy5waWNrKF8sICdrZXlzJywgJ21ldGhvZHMnLCAnZnVuY3Rpb25zJywgJ21ldGhvZHMnLCAncGljaycsICdkZWZhdWx0cycsICdjbG9uZScsICd0YXAnLCAnaGFzJyk7CgogICAgLyoqCiAgICBJbnZlcnRzIGFuIG9iamVjdC4gIFRoZSBrZXlzIGJlY29tZSB2YWx1ZXMsIGFuZCB0aGUgdmFsdWVzIGJlY29tZSBrZXlzLgogICAgRG9lcyBub3QgZG8gYW55IGNvcHlpbmcuCgogICAgQG1ldGhvZCBpbnZlcnQKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byBpbnZlcnQuCiAgICBAcmV0dXJucyB7T2JqZWN0fSBUaGUgaW52ZXJ0ZWQgb2JqZWN0LgogICAgKiovCgogICAgdmFyIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBleHBvcnRzLmludmVydCA9IGZ1bmN0aW9uIChvYmopCiAgICB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgIGZvciAodmFyIGkgaW4gb2JqKQogICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwob2JqLCBpKSkKICAgICAgICAgICAgICAgIHJlc3VsdFtvYmpbaV1dID0gaTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIAogICAgcmV0dXJuIGV4cG9ydHM7Cn0pOwovKiEKICogalF1ZXJ5IEphdmFTY3JpcHQgbGliIHYxLjcuMgogKiBodHRwOi8vanF1ZXJ5LmNvbS8KICoKICogQ29weXJpZ2h0IDIwMTEsIEpvaG4gUmVzaWcKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogSW5jbHVkZXMgU2l6emxlLmpzCiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqIENvcHlyaWdodCAyMDExLCBUaGUgRG9qbyBGb3VuZGF0aW9uCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQsIEJTRCwgYW5kIEdQTCBMaWNlbnNlcy4KICoKICogRGF0ZTogV2VkIE1hciAyMSAxMjo0NjozNCAyMDEyIC0wNzAwCiAqLwpkZWZpbmUoJ3RocnVzdC91dGlsL2xpYi90eXBlJyxbJ3RocnVzdC91dGlsL2NvbGxlY3Rpb24nXSwKZnVuY3Rpb24gKHVDb2xsZWN0aW9uKQp7CiAgICAKICAgIHZhciB0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCiAgICAgICAgY2xhc3MydHlwZSA9IHt9OwogICAgCiAgICB2YXIgdHlwZSA9IGZ1bmN0aW9uIChvYmopCiAgICB7CiAgICAgICAgcmV0dXJuIG9iaiA9PSBudWxsID8KICAgICAgICAgICAgU3RyaW5nKG9iaikgOgogICAgICAgICAgICBjbGFzczJ0eXBlW3RvU3RyaW5nLmNhbGwob2JqKV0gfHwgIm9iamVjdCI7CiAgICB9OwoKICAgIHVDb2xsZWN0aW9uLmVhY2goIkJvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QiLnNwbGl0KCIgIiksIGZ1bmN0aW9uIChuYW1lLCBpKQogICAgewogICAgICAgIGNsYXNzMnR5cGVbIltvYmplY3QgIiArIG5hbWUgKyAiXSJdID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgfSk7CgogICAgcmV0dXJuIHsgdHlwZTogdHlwZSB9Owp9KTsKZGVmaW5lKCd0aHJ1c3QvdXRpbC90eXBlJyxbJ2xvZGFzaCcsICcuL2xpYi90eXBlJ10sCmZ1bmN0aW9uIChfLCB0eXBlKQp7CiAgICAKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QtdXRpbC10eXBlCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0VxdWFsXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNFcXVhbCkKCiAgICBAZm9yIHRocnVzdC11dGlsLXR5cGUKICAgIEBtZXRob2QgaXNFcXVhbAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNFbXB0eV0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzRW1wdHkpCgogICAgQG1ldGhvZCBpc0VtcHR5CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0VsZW1lbnRdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0VsZW1lbnQpCgogICAgQG1ldGhvZCBpc0VsZW1lbnQKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzQXJyYXldKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0FycmF5KQoKICAgIEBtZXRob2QgaXNBcnJheQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNPYmplY3RdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc09iamVjdCkKCiAgICBAbWV0aG9kIGlzT2JqZWN0CiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0FyZ3VtZW50c10oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzQXJndW1lbnRzKQoKICAgIEBtZXRob2QgaXNBcmd1bWVudHMKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzRnVuY3Rpb25dKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0Z1bmN0aW9uKQoKICAgIEBtZXRob2QgaXNGdW5jdGlvbgogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNTdHJpbmddKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc1N0cmluZykKCiAgICBAbWV0aG9kIGlzU3RyaW5nCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc051bWJlcl0oaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzTnVtYmVyKQoKICAgIEBtZXRob2QgaXNOdW1iZXIKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzRmluaXRlXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNGaW5pdGUpCgogICAgQG1ldGhvZCBpc0Zpbml0ZQogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNCb29sZWFuXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNCb29sZWFuKQoKICAgIEBtZXRob2QgaXNCb29sZWFuCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0RhdGVdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc0RhdGUpCgogICAgQG1ldGhvZCBpc0RhdGUKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzUmVnRXhwXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNSZWdFeHApCgogICAgQG1ldGhvZCBpc1JlZ0V4cAogICAgKiovCgogICAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBhbiB1bmRlcnNjb3JlL2xvZGFzaCBoZWxwZXIuCiAgICBGb3IgZG9jdW1lbnRhdGlvbiBwbGVhc2Ugc2VlIFtodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNOYU5dKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc05hTikKCiAgICBAbWV0aG9kIGlzTmFOCiAgICAqKi8KCiAgICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGFuIHVuZGVyc2NvcmUvbG9kYXNoIGhlbHBlci4KICAgIEZvciBkb2N1bWVudGF0aW9uIHBsZWFzZSBzZWUgW2h0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc051bGxdKGh0dHA6Ly91bmRlcnNjb3JlanMub3JnLyNpc051bGwpCgogICAgQG1ldGhvZCBpc051bGwKICAgICoqLwoKICAgIC8qKgogICAgVGhpcyBtZXRob2QgaXMgYW4gdW5kZXJzY29yZS9sb2Rhc2ggaGVscGVyLgogICAgRm9yIGRvY3VtZW50YXRpb24gcGxlYXNlIHNlZSBbaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI2lzVW5kZWZpbmVkXShodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jaXNVbmRlZmluZWQpCgogICAgQG1ldGhvZCBpc1VuZGVmaW5lZAogICAgKiovCgogICAgdmFyIGV4cG9ydHMgPSBfLnBpY2soXywgJ2lzRXF1YWwnLCAnaXNFbXB0eScsICdpc0VsZW1lbnQnLCAnaXNBcnJheScsICdpc09iamVjdCcsICdpc0FyZ3VtZW50cycsICdpc0Z1bmN0aW9uJywgJ2lzU3RyaW5nJywgJ2lzTnVtYmVyJywgJ2lzRmluaXRlJywgJ2lzQm9vbGVhbicsICdpc0RhdGUnLCAnaXNSZWdFeHAnLCAnaXNOYU4nLCAnaXNOdWxsJywgJ2lzVW5kZWZpbmVkJyk7CgogICAgXy5leHRlbmQoZXhwb3J0cywgewogICAgICAgIC8qKgogICAgICAgIFJldHVybnMgdGhlIHR5cGUgb2YgdGhlIGdpdmVuIE9iamVjdAoKICAgICAgICBOT1RFOiBjdXJyZW50bHkgdGhpcyB0eXBlIGhhcyBiZWVuIGxvYWRlZCBmcm9tIGpRdWVyeSBzb3VyY2UgY29kZS4KCiAgICAgICAgQG1ldGhvZCB0eXBlCiAgICAgICAgKiovCiAgICAgICAgdHlwZTogdHlwZS50eXBlLAogICAgICAgIC8qKgogICAgICAgIENoZWNrcyBpcyB0aGUgb2JqZWN0IGlzIGFycmF5IGxpa2UsIGxpa2UgdGhlIGFydWd1bWVudHMgb2JqZWN0LCBidXQgbm90IGEgc3RyaW5nLCBvZSBhcnJheS4KICAgICAgICBqUXVlcnkgb2JqZWN0cyBmb3IgZXhhbXBsZSB3b3VsZCByZXBvcnQgYXMgYXJyYXkgbGlrZS4KICAgICAgICBBcyB3ZWxsIGFzIGtub2Nrb3V0IG9ic2VydmFibGUgYXJyYXlzIHJlcG9ydCBhcyBhcnJheSBsaWtlLgoKICAgICAgICBAbWV0aG9kIGlzQXJyYXlMaWtlCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB0byBjaGVjawogICAgICAgIEByZXR1cm5zIHtCb29sZWFufSBJcyBpdCB0cnVlIG9yIGZhbHNlLgogICAgICAgICoqLwogICAgICAgIGlzQXJyYXlMaWtlOiBmdW5jdGlvbiAobykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAobyAmJiAhZXhwb3J0cy5pc1N0cmluZyhvKSAmJiBvLmxlbmd0aCAhPT0gdW5kZWZpbmVkKSB8fCBmYWxzZTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIENoZWNrcyBpZiB0aGUgZ2l2ZW4gb2JqZWN0IGlzIGFycmF5IG9yIGFycmF5IGxpa2UuCgogICAgICAgIEBtZXRob2QgaXNBcnJheU9yQXJyYXlMaWtlCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB0byBjaGVjawogICAgICAgIEByZXR1cm5zIHtCb29sZWFufSBJcyBpdCB0cnVlIG9yIGZhbHNlLgogICAgICAgICoqLwogICAgICAgIGlzQXJyYXlPckFycmF5TGlrZTogZnVuY3Rpb24gKG8pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZXhwb3J0cy5pc0FycmF5KG8pIHx8IChleHBvcnRzLmlzQXJyYXlMaWtlKG8pKTsKICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gZXhwb3J0czsKfSk7CgpkZWZpbmUoJ3RocnVzdC91dGlsL2d1aWQnLFsnLi90eXBlJ10sCmZ1bmN0aW9uICh0eXBlKQp7CiAgICAKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QtdXRpbAogICAgKiovCgogICAgdmFyIFM0ID0gZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICByZXR1cm4gKCgoMSArIE1hdGgucmFuZG9tKCkpICogMHgxMDAwMCkgfCAwKS50b1N0cmluZygxNikuc3Vic3RyaW5nKDEpOwogICAgfSwKICAgIGd1aWRSZWdleCA9IC9eKFx7ezAsMX0oWzAtOWEtZkEtRl0pezh9LShbMC05YS1mQS1GXSl7NH0tKFswLTlhLWZBLUZdKXs0fS0oWzAtOWEtZkEtRl0pezR9LShbMC05YS1mQS1GXSl7MTJ9XH17MCwxfSkkLywKICAgIGVtdHB0eUd1aWQgPSAnMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwJzsKCiAgICB2YXIgZXhwb3J0cyA9IHsKICAgICAgICAvKioKICAgICAgICBSZXR1cm5zIGEgbmV3IHN1ZG8gZ3VpZCwgbGltaWF0aW9ucyBpbiBKYXZhU2NyaXB0IG1ha2UgbXVzdCBtb3JlIHJlbGlhYmxlIGd1aWRzIGZhaXJseSBkaWZmaWN1bHQgdG8gY3JlYXRlLgoKICAgICAgICBAZm9yIHRocnVzdC11dGlsCiAgICAgICAgQG1ldGhvZCBuZXdHdWlkCiAgICAgICAgQHJldHVybnMge0d1aWR9IFRoZSBuZXcgZ3VpZC4KICAgICAgICAqKi8KICAgICAgICBuZXdHdWlkOiBmdW5jdGlvbiAoKSB7IHJldHVybiAoUzQoKSArIFM0KCkgKyAiLSIgKyBTNCgpICsgIi0iICsgUzQoKSArICItIiArIFM0KCkgKyAiLSIgKyBTNCgpICsgUzQoKSArIFM0KCkpOyB9LAogICAgICAgIC8qKgogICAgICAgIFJldHVybnMgYW4gZW1wdHkgZ3VpZC4KCiAgICAgICAgQG1ldGhvZCBlbXB0eUd1aWQKICAgICAgICBAcmV0dXJucyB7R3VpZH0gVGhlIGVtdHB0eSBndWlkLgogICAgICAgICoqLwogICAgICAgIGVtcHR5R3VpZDogZnVuY3Rpb24gKCkgeyByZXR1cm4gZW10cHR5R3VpZDsgfSwKICAgICAgICAvKioKICAgICAgICBDaGVja3MgaWYgdGhlIGdpdmVuIHN0cmluZyBpcyBhIGd1aWQuCgogICAgICAgIEBtZXRob2QgaXNHdWlkCiAgICAgICAgQHBhcmFtIHtHdWlkfSBndWlkCiAgICAgICAgQHJldHVybnMge0Jvb2xlYW59IElmIHRoZSBndWlkIGlzIGEgZ3VpZCBvciBub3QuCiAgICAgICAgKiovCiAgICAgICAgaXNHdWlkOiBmdW5jdGlvbiAoZ3VpZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmlzU3RyaW5nKGd1aWQpID8gZ3VpZFJlZ2V4LnRlc3QoZ3VpZCkgOiBmYWxzZTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIENoZWNrcyBpZiB0aGUgR3VpZCBpcyBhbiBFbXB0eSBHdWlkCgogICAgICAgIEBtZXRob2QgaXNHdWlkRW1wdHkKICAgICAgICBAcGFyYW0ge0d1aWR9IGd1aWQKICAgICAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSWYgdGhlIGd1aWQgaXMgYSBndWlkIG9yIG5vdC4KICAgICAgICAqKi8KICAgICAgICBpc0d1aWRFbXB0eTogZnVuY3Rpb24gKGd1aWQpIHsgcmV0dXJuIGd1aWQgPT09IGVtdHB0eUd1aWQ7IH0KICAgIH07CiAgICByZXR1cm4gZXhwb3J0czsKfSk7Ci8qIQogKiBqUXVlcnkgSmF2YVNjcmlwdCBsaWIgdjEuNy4yCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBDb3B5cmlnaHQgMjAxMSwgSm9obiBSZXNpZwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICogQ29weXJpZ2h0IDIwMTEsIFRoZSBEb2pvIEZvdW5kYXRpb24KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCwgQlNELCBhbmQgR1BMIExpY2Vuc2VzLgogKgogKiBEYXRlOiBXZWQgTWFyIDIxIDEyOjQ2OjM0IDIwMTIgLTA3MDAKICovCmRlZmluZSgndGhydXN0L3V0aWwvbGliL3BhcmFtJyxbJ3RocnVzdC91dGlsL2NvbGxlY3Rpb24nLCAndGhydXN0L3V0aWwvdHlwZScsICdtb2R1bGUnXSwKZnVuY3Rpb24gKHVDb2xsZWN0aW9uLCB1VHlwZSwgbW9kdWxlKQp7CiAgICAKICAgIHZhciByMjAgPSAvJTIwL2csCiAgICAgICAgcmJyYWNrZXQgPSAvXFtcXSQvOwogICAgdmFyIHBhcmFtID0gZnVuY3Rpb24gKGEsIHRyYWRpdGlvbmFsKQogICAgewogICAgICAgIHZhciBwcmVmaXgsCiAgICAgICAgICAgIHMgICA9IFtdLAogICAgICAgICAgICBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gSWYgdmFsdWUgaXMgYSBmdW5jdGlvbiwgaW52b2tlIGl0IGFuZCByZXR1cm4gaXRzIHZhbHVlCiAgICAgICAgICAgICAgICB2YWx1ZSA9IHVUeXBlLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUoKSA6ICh2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSk7CiAgICAgICAgICAgICAgICBzW3MubGVuZ3RoXSA9IGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgLy8gU2V0IHRyYWRpdGlvbmFsIHRvIHRydWUgZm9yIGpRdWVyeSA8PSAxLjMuMiBiZWhhdmlvci4KICAgICAgICBpZiAodHJhZGl0aW9uYWwgPT09IHVuZGVmaW5lZCkKICAgICAgICB7CiAgICAgICAgICAgIHRyYWRpdGlvbmFsID0gISFtb2R1bGUuY29uZmlnKCkudHJhZGl0aW9uYWxFbmNvZGluZzsKICAgICAgICB9CgogICAgICAgIC8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCiAgICAgICAgaWYgKHVUeXBlLmlzQXJyYXlPckFycmF5TGlrZShhKSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwogICAgICAgICAgICB1Q29sbGVjdGlvbi5lYWNoKGEsIGZ1bmN0aW9uICh4KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBhZGQoeC5uYW1lLCB4LnZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vIElmIHRyYWRpdGlvbmFsLCBlbmNvZGUgdGhlICJvbGQiIHdheSAodGhlIHdheSAxLjMuMiBvciBvbGRlcgogICAgICAgICAgICAvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KICAgICAgICAgICAgZm9yIChwcmVmaXggaW4gYSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhW3ByZWZpeF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBSZXR1cm4gdGhlIHJlc3VsdGluZyBzZXJpYWxpemF0aW9uCiAgICAgICAgcmV0dXJuIHMuam9pbigiJiIpLnJlcGxhY2UocjIwLCAiKyIpOwogICAgfTsKCiAgICBmdW5jdGlvbiBidWlsZFBhcmFtcyhwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCkKICAgIHsKICAgICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkob2JqKSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSBhcnJheSBpdGVtLgogICAgICAgICAgICBqUXVlcnkuZWFjaChvYmosIGZ1bmN0aW9uIChpLCB2KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdChwcmVmaXgpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgICAgICAgICAgICBhZGQocHJlZml4LCB2KTsKCiAgICAgICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZiBhcnJheSBpdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMKICAgICAgICAgICAgICAgICAgICAvLyBudW1lcmljIGluZGV4IHRvIHJlc29sdmUgZGVzZXJpYWxpemF0aW9uIGFtYmlndWl0eSBpc3N1ZXMuCiAgICAgICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHJhY2sgKGFzIG9mIDEuMC4wKSBjYW4ndCBjdXJyZW50bHkgZGVzZXJpYWxpemUKICAgICAgICAgICAgICAgICAgICAvLyBuZXN0ZWQgYXJyYXlzIHByb3Blcmx5LCBhbmQgYXR0ZW1wdGluZyB0byBkbyBzbyBtYXkgY2F1c2UKICAgICAgICAgICAgICAgICAgICAvLyBhIHNlcnZlciBlcnJvci4gUG9zc2libGUgZml4ZXMgYXJlIHRvIG1vZGlmeSByYWNrJ3MKICAgICAgICAgICAgICAgICAgICAvLyBkZXNlcmlhbGl6YXRpb24gYWxnb3JpdGhtIG9yIHRvIHByb3ZpZGUgYW4gb3B0aW9uIG9yIGZsYWcKICAgICAgICAgICAgICAgICAgICAvLyB0byBmb3JjZSBhcnJheSBzZXJpYWxpemF0aW9uIHRvIGJlIHNoYWxsb3cuCiAgICAgICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgIlsiICsgKHR5cGVvZiB2ID09PSAib2JqZWN0IiB8fCBqUXVlcnkuaXNBcnJheSh2KSA/IGkgOiAiIikgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCF0cmFkaXRpb25hbCAmJiBvYmogIT0gbnVsbCAmJiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IikKICAgICAgICB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSBvYmplY3QgaXRlbS4KICAgICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBvYmopCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialtuYW1lXSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgICAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsgcGFyYW06IHBhcmFtIH07Cn0pOwpkZWZpbmUoJ3RocnVzdC91dGlsL3VybCcsWycuL2xpYi9wYXJhbScsICdtb2R1bGUnXSwKZnVuY3Rpb24gKHBhcmFtLCBtb2R1bGUpCnsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QtdXRpbC11cmwKICAgICoqLwogICAgCiAgICB2YXIgdXJsUGF0aCAgICAgICAgICA9IChtb2R1bGUuY29uZmlnICYmIG1vZHVsZS5jb25maWcoKS5wYXRoIHx8ICcnKSwKICAgICAgICBwYXRoICAgICAgICAgICAgID0gdXJsUGF0aC5sYXN0SW5kZXhPZignLycpID09PSB1cmxQYXRoLmxlbmd0aCAtIDEgPyB1cmxQYXRoLnN1YnN0cmluZygwLCAtMSkgOiB1cmxQYXRoLAogICAgICAgIGRvdWJsZVNsYXNoUmVnZXggPSAvXC9cLy9nOwoKICAgIHZhciBleHBvcnRzID0gewogICAgICAgIC8qKgogICAgICAgIGpRdWVyeSBwYXJhbSBtZXRob2QgdG8gZW5jb2RlIGZvcm0gcGFyYW1ldGVycy4KCiAgICAgICAgQGZvciB0aHJ1c3QtdXRpbC11cmwKICAgICAgICBAbWV0aG9kIHBhcmFtCiAgICAgICAgKiovCiAgICAgICAgcGFyYW06IHBhcmFtLAogICAgICAgIC8qKgogICAgICAgIENsZWFucyB1cCBkb3VibGUgc2xhc2hzIGluIGEgdXJsLCB1c2VkIGJ5IHRocnVzdC9kYXRhCgogICAgICAgIEBtZXRob2QgY2xlYW5VcmwKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gY2xlYW4KICAgICAgICBAcmV0cnVzbiB7U3RyaW5nfSBUaGUgY2xlYW5lZCB1cmwKICAgICAgICAqKi8KICAgICAgICBjbGVhblVybDogZnVuY3Rpb24gKHVybCkgeyByZXR1cm4gdXJsLnJlcGxhY2UoZG91YmxlU2xhc2hSZWdleCwgJy8nKTsgfSwKICAgICAgICAvKioKICAgICAgICBDaGVja3MgZm9yIGV4aXN0YW5jZSBvZiBhcHBsaWNhdGlvbiBwYXRoIGluIHRoZSB1cmwsIG9yIGh0dHAgaWYgdGhlIHVybCBpcyBzdXBwb3NlZCB0byBnbyB0byBhbm90aGVyIGxvY2F0aW9uLgoKICAgICAgICBAbWV0aG9kIGZpeHVwVXJsCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGZpeHVwCiAgICAgICAgQHJldHJ1c24ge1N0cmluZ30gVGhlIGZpeGVkIHVybAogICAgICAgICoqLwogICAgICAgIGZpeHVwVXJsOiBmdW5jdGlvbiAodXJsKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHVybC5pbmRleE9mKCdodHRwJykgPT09IC0xKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodXJsLmluZGV4T2YodXJsUGF0aCkgPT09IC0xKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHVybCA9IHVybFBhdGggKyB1cmw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1cmwgPSBleHBvcnRzLmNsZWFuVXJsKHBhdGggKyB1cmwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgfQogICAgfTsKICAgIHJldHVybiBleHBvcnRzOwp9KTsKZGVmaW5lKCd0aHJ1c3QvdXRpbC9zdHJpbmcnLFtdLGZ1bmN0aW9uICgpCnsKICAgIHZhciBvYmplY3RDdXJseVJlZ2V4ID0gL1x7XHt8XH1cfXxceyguKj8pXH0vZywKICAgICAgICBudW1iZXJDdXJseVJlZ2V4ID0gL1x7XHt8XH1cfXxceyhcZCspXH0vZywKICAgICAgICBzbGljZSAgICAgICAgICAgID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAogICAgICAgIGZvcm1hdCAgICAgICAgICAgPSBmdW5jdGlvbiAoc3RyKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gJ29iamVjdCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBhID0gYXJnc1swXTsKICAgICAgICAgICAgICAgIHJldHVybiBzdHIucmVwbGFjZShvYmplY3RDdXJseVJlZ2V4LCBmdW5jdGlvbiAobSwgbikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAobSA9PSAne3snKSB7IHJldHVybiAneyc7IH0KICAgICAgICAgICAgICAgICAgICBpZiAobSA9PSAnfX0nKSB7IHJldHVybiAnfSc7IH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSAmJiBhW25dIHx8ICcnOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKG51bWJlckN1cmx5UmVnZXgsIGZ1bmN0aW9uIChtLCBuKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAobSA9PSAne3snKSB7IHJldHVybiAneyc7IH0KICAgICAgICAgICAgICAgIGlmIChtID09ICd9fScpIHsgcmV0dXJuICd9JzsgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3Nbbl0gfHwgJyc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgU3RyaW5nLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBmb3JtYXQuYXBwbHkobnVsbCwgW3RoaXNdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsgfTsKCiAgICByZXR1cm4gewogICAgICAgIC8qKgogICAgICAgIEMjIHN0eWxlIHN0cmluZyBmb3JtYXQuCgogICAgICAgIEBmb3IgdGhydXN0LXV0aWwKICAgICAgICBAbWV0aG9kIGZvcm1hdAogICAgICAgICoqLwogICAgICAgIGZvcm1hdDogZm9ybWF0LAogICAgICAgIGdldE1vZHVsZU5hbWVGb3JQYXRoOiBmdW5jdGlvbiAobmFtZSkgeyByZXR1cm4gKG5hbWUubGFzdEluZGV4T2YoJy8nKSA+IC0xID8gbmFtZS5zdWJzdHJpbmcobmFtZS5sYXN0SW5kZXhPZignLycpICsgMSkgOiBuYW1lKS5yZXBsYWNlKC9cLi9nLCAnLScpOyB9CiAgICB9Owp9KTsKLyoqIEBsaWNlbnNlIE1JVCBMaWNlbnNlIChjKSBjb3B5cmlnaHQgQiBDYXZhbGllciAmIEogSGFubiAqLwoKLyoqCiAqIHdoZW4KICogQSBsaWdodHdlaWdodCBDb21tb25KUyBQcm9taXNlcy9BIGFuZCB3aGVuKCkgaW1wbGVtZW50YXRpb24KICoKICogd2hlbiBpcyBwYXJ0IG9mIHRoZSBjdWpvLmpzIGZhbWlseSBvZiBsaWJyYXJpZXMgKGh0dHA6Ly9jdWpvanMuY29tLykKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlIGF0OgogKiBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKgogKiBAdmVyc2lvbiAxLjMuMAogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL3doZW4nLFtdLGZ1bmN0aW9uKCkgewogICAgdmFyIGZyZWV6ZSwgcmVkdWNlQXJyYXksIHNsaWNlLCB1bmRlZjsKCiAgICAvLwogICAgLy8gUHVibGljIEFQSQogICAgLy8KCiAgICB3aGVuLmRlZmVyICAgICA9IGRlZmVyOwogICAgd2hlbi5yZWplY3QgICAgPSByZWplY3Q7CiAgICB3aGVuLmlzUHJvbWlzZSA9IGlzUHJvbWlzZTsKCiAgICB3aGVuLmFsbCAgICAgICA9IGFsbDsKICAgIHdoZW4uc29tZSAgICAgID0gc29tZTsKICAgIHdoZW4uYW55ICAgICAgID0gYW55OwoKICAgIHdoZW4ubWFwICAgICAgID0gbWFwOwogICAgd2hlbi5yZWR1Y2UgICAgPSByZWR1Y2U7CgogICAgd2hlbi5jaGFpbiAgICAgPSBjaGFpbjsKCiAgICAvKiogT2JqZWN0LmZyZWV6ZSAqLwogICAgZnJlZXplID0gT2JqZWN0LmZyZWV6ZSB8fCBmdW5jdGlvbihvKSB7IHJldHVybiBvOyB9OwoKICAgIC8qKgogICAgICogVHJ1c3RlZCBQcm9taXNlIGNvbnN0cnVjdG9yLiAgQSBQcm9taXNlIGNyZWF0ZWQgZnJvbSB0aGlzIGNvbnN0cnVjdG9yIGlzCiAgICAgKiBhIHRydXN0ZWQgd2hlbi5qcyBwcm9taXNlLiAgQW55IG90aGVyIGR1Y2stdHlwZWQgcHJvbWlzZSBpcyBjb25zaWRlcmVkCiAgICAgKiB1bnRydXN0ZWQuCiAgICAgKgogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKi8KICAgIGZ1bmN0aW9uIFByb21pc2UoKSB7fQoKICAgIFByb21pc2UucHJvdG90eXBlID0gZnJlZXplKHsKICAgICAgICBhbHdheXM6IGZ1bmN0aW9uKGFsd2F5c2JhY2ssIHByb2diYWNrKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRoZW4oYWx3YXlzYmFjaywgYWx3YXlzYmFjaywgcHJvZ2JhY2spOwogICAgICAgIH0sCgogICAgICAgIG90aGVyd2lzZTogZnVuY3Rpb24oZXJyYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKHVuZGVmLCBlcnJiYWNrKTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIENyZWF0ZSBhbiBhbHJlYWR5LXJlc29sdmVkIHByb21pc2UgZm9yIHRoZSBzdXBwbGllZCB2YWx1ZQogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgYW55dGhpbmcKICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlc29sdmVkKHZhbHVlKSB7CgogICAgICAgIHZhciBwID0gbmV3IFByb21pc2UoKTsKCiAgICAgICAgcC50aGVuID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlKGNhbGxiYWNrID8gY2FsbGJhY2sodmFsdWUpIDogdmFsdWUpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWplY3RlZChlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBmcmVlemUocCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYW4gYWxyZWFkeS1yZWplY3RlZCB7QGxpbmsgUHJvbWlzZX0gd2l0aCB0aGUgc3VwcGxpZWQKICAgICAqIHJlamVjdGlvbiByZWFzb24uCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSByZWFzb24gcmVqZWN0aW9uIHJlYXNvbgogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogICAgZnVuY3Rpb24gcmVqZWN0ZWQocmVhc29uKSB7CgogICAgICAgIHZhciBwID0gbmV3IFByb21pc2UoKTsKCiAgICAgICAgcC50aGVuID0gZnVuY3Rpb24oY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBlcnJiYWNrID8gcHJvbWlzZShlcnJiYWNrKHJlYXNvbikpIDogcmVqZWN0ZWQocmVhc29uKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0ZWQoZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gZnJlZXplKHApOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIHJlamVjdGVkIHByb21pc2UgZm9yIHRoZSBzdXBwbGllZCBwcm9taXNlT3JWYWx1ZS4gSWYKICAgICAqIHByb21pc2VPclZhbHVlIGlzIGEgdmFsdWUsIGl0IHdpbGwgYmUgdGhlIHJlamVjdGlvbiB2YWx1ZSBvZiB0aGUKICAgICAqIHJldHVybmVkIHByb21pc2UuICBJZiBwcm9taXNlT3JWYWx1ZSBpcyBhIHByb21pc2UsIGl0cwogICAgICogY29tcGxldGlvbiB2YWx1ZSB3aWxsIGJlIHRoZSByZWplY3RlZCB2YWx1ZSBvZiB0aGUgcmV0dXJuZWQgcHJvbWlzZQogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlT3JWYWx1ZSB7Kn0gdGhlIHJlamVjdGVkIHZhbHVlIG9mIHRoZSByZXR1cm5lZCB7QGxpbmsgUHJvbWlzZX0KICAgICAqCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSByZWplY3RlZCB7QGxpbmsgUHJvbWlzZX0KICAgICAqLwogICAgZnVuY3Rpb24gcmVqZWN0KHByb21pc2VPclZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHdoZW4ocHJvbWlzZU9yVmFsdWUsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiByZWplY3RlZCh2YWx1ZSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3LCBDb21tb25KUyBjb21wbGlhbnQsIERlZmVycmVkIHdpdGggZnVsbHkgaXNvbGF0ZWQKICAgICAqIHJlc29sdmVyIGFuZCBwcm9taXNlIHBhcnRzLCBlaXRoZXIgb3IgYm90aCBvZiB3aGljaCBtYXkgYmUgZ2l2ZW4gb3V0CiAgICAgKiBzYWZlbHkgdG8gY29uc3VtZXJzLgogICAgICogVGhlIERlZmVycmVkIGl0c2VsZiBoYXMgdGhlIGZ1bGwgQVBJOiByZXNvbHZlLCByZWplY3QsIHByb2dyZXNzLCBhbmQKICAgICAqIHRoZW4uIFRoZSByZXNvbHZlciBoYXMgcmVzb2x2ZSwgcmVqZWN0LCBhbmQgcHJvZ3Jlc3MuICBUaGUgcHJvbWlzZQogICAgICogb25seSBoYXMgdGhlbi4KICAgICAqCiAgICAgKiBAbWVtYmVyT2Ygd2hlbgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQHJldHVybnMge0RlZmVycmVkfQogICAgICovCiAgICBmdW5jdGlvbiBkZWZlcigpIHsKICAgICAgICB2YXIgZGVmZXJyZWQsIHByb21pc2UsIGxpc3RlbmVycywgcHJvZ3Jlc3NIYW5kbGVycywgX3RoZW4sIF9wcm9ncmVzcywgY29tcGxldGU7CgogICAgICAgIGxpc3RlbmVycyA9IFtdOwogICAgICAgIHByb2dyZXNzSGFuZGxlcnMgPSBbXTsKCiAgICAgICAgLyoqCiAgICAgICAgICogUHJlLXJlc29sdXRpb24gdGhlbigpIHRoYXQgYWRkcyB0aGUgc3VwcGxpZWQgY2FsbGJhY2ssIGVycmJhY2ssIGFuZCBwcm9nYmFjawogICAgICAgICAqIGZ1bmN0aW9ucyB0byB0aGUgcmVnaXN0ZXJlZCBsaXN0ZW5lcnMKICAgICAgICAgKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gW2NhbGxiYWNrXSB7RnVuY3Rpb259IHJlc29sdXRpb24gaGFuZGxlcgogICAgICAgICAqIEBwYXJhbSBbZXJyYmFja10ge0Z1bmN0aW9ufSByZWplY3Rpb24gaGFuZGxlcgogICAgICAgICAqIEBwYXJhbSBbcHJvZ2JhY2tdIHtGdW5jdGlvbn0gcHJvZ3Jlc3MgaGFuZGxlcgogICAgICAgICAqCiAgICAgICAgICogQHRocm93cyB7RXJyb3J9IGlmIGFueSBhcmd1bWVudCBpcyBub3QgbnVsbCwgdW5kZWZpbmVkLCBvciBhIEZ1bmN0aW9uCiAgICAgICAgICovCiAgICAgICAgX3RoZW4gPSBmdW5jdGlvbiB1bnJlc29sdmVkVGhlbihjYWxsYmFjaywgZXJyYmFjaywgcHJvZ2JhY2spIHsKICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gZGVmZXIoKTsKCiAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihjYWxsYmFjaywgZXJyYmFjaykKICAgICAgICAgICAgICAgICAgICAudGhlbihkZWZlcnJlZC5yZXNvbHZlLCBkZWZlcnJlZC5yZWplY3QsIGRlZmVycmVkLnByb2dyZXNzKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBwcm9nYmFjayAmJiBwcm9ncmVzc0hhbmRsZXJzLnB1c2gocHJvZ2JhY2spOwoKICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVnaXN0ZXJzIGEgaGFuZGxlciBmb3IgdGhpcyB7QGxpbmsgRGVmZXJyZWR9J3Mge0BsaW5rIFByb21pc2V9LiAgRXZlbiB0aG91Z2ggYWxsIGFyZ3VtZW50cwogICAgICAgICAqIGFyZSBvcHRpb25hbCwgZWFjaCBhcmd1bWVudCB0aGF0ICppcyogc3VwcGxpZWQgbXVzdCBiZSBudWxsLCB1bmRlZmluZWQsIG9yIGEgRnVuY3Rpb24uCiAgICAgICAgICogQW55IG90aGVyIHZhbHVlIHdpbGwgY2F1c2UgYW4gRXJyb3IgdG8gYmUgdGhyb3duLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIFByb21pc2UKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBbY2FsbGJhY2tdIHtGdW5jdGlvbn0gcmVzb2x1dGlvbiBoYW5kbGVyCiAgICAgICAgICogQHBhcmFtIFtlcnJiYWNrXSB7RnVuY3Rpb259IHJlamVjdGlvbiBoYW5kbGVyCiAgICAgICAgICogQHBhcmFtIFtwcm9nYmFja10ge0Z1bmN0aW9ufSBwcm9ncmVzcyBoYW5kbGVyCiAgICAgICAgICoKICAgICAgICAgKiBAdGhyb3dzIHtFcnJvcn0gaWYgYW55IGFyZ3VtZW50IGlzIG5vdCBudWxsLCB1bmRlZmluZWQsIG9yIGEgRnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiB0aGVuKGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9nYmFjaykgewogICAgICAgICAgICByZXR1cm4gX3RoZW4oY2FsbGJhY2ssIGVycmJhY2ssIHByb2diYWNrKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFJlc29sdmVzIHRoaXMge0BsaW5rIERlZmVycmVkfSdzIHtAbGluayBQcm9taXNlfSB3aXRoIHZhbCBhcyB0aGUKICAgICAgICAgKiByZXNvbHV0aW9uIHZhbHVlLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIFJlc29sdmVyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdmFsIGFueXRoaW5nCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZSh2YWwpIHsKICAgICAgICAgICAgY29tcGxldGUocmVzb2x2ZWQodmFsKSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBSZWplY3RzIHRoaXMge0BsaW5rIERlZmVycmVkfSdzIHtAbGluayBQcm9taXNlfSB3aXRoIGVyciBhcyB0aGUKICAgICAgICAgKiByZWFzb24uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyT2YgUmVzb2x2ZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBlcnIgYW55dGhpbmcKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiByZWplY3QoZXJyKSB7CiAgICAgICAgICAgIGNvbXBsZXRlKHJlamVjdGVkKGVycikpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcGFyYW0gdXBkYXRlCiAgICAgICAgICovCiAgICAgICAgX3Byb2dyZXNzID0gZnVuY3Rpb24odXBkYXRlKSB7CiAgICAgICAgICAgIHZhciBwcm9ncmVzcywgaSA9IDA7CiAgICAgICAgICAgIHdoaWxlIChwcm9ncmVzcyA9IHByb2dyZXNzSGFuZGxlcnNbaSsrXSkgcHJvZ3Jlc3ModXBkYXRlKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBFbWl0cyBhIHByb2dyZXNzIHVwZGF0ZSB0byBhbGwgcHJvZ3Jlc3Mgb2JzZXJ2ZXJzIHJlZ2lzdGVyZWQgd2l0aAogICAgICAgICAqIHRoaXMge0BsaW5rIERlZmVycmVkfSdzIHtAbGluayBQcm9taXNlfQogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIFJlc29sdmVyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdXBkYXRlIGFueXRoaW5nCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcHJvZ3Jlc3ModXBkYXRlKSB7CiAgICAgICAgICAgIF9wcm9ncmVzcyh1cGRhdGUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogVHJhbnNpdGlvbiBmcm9tIHByZS1yZXNvbHV0aW9uIHN0YXRlIHRvIHBvc3QtcmVzb2x1dGlvbiBzdGF0ZSwgbm90aWZ5aW5nCiAgICAgICAgICogYWxsIGxpc3RlbmVycyBvZiB0aGUgcmVzb2x1dGlvbiBvciByZWplY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gY29tcGxldGVkIHtQcm9taXNlfSB0aGUgY29tcGxldGVkIHZhbHVlIG9mIHRoaXMgZGVmZXJyZWQKICAgICAgICAgKi8KICAgICAgICBjb21wbGV0ZSA9IGZ1bmN0aW9uKGNvbXBsZXRlZCkgewogICAgICAgICAgICB2YXIgbGlzdGVuZXIsIGkgPSAwOwoKICAgICAgICAgICAgLy8gUmVwbGFjZSBfdGhlbiB3aXRoIG9uZSB0aGF0IGRpcmVjdGx5IG5vdGlmaWVzIHdpdGggdGhlIHJlc3VsdC4KICAgICAgICAgICAgX3RoZW4gPSBjb21wbGV0ZWQudGhlbjsKCiAgICAgICAgICAgIC8vIFJlcGxhY2UgY29tcGxldGUgc28gdGhhdCB0aGlzIERlZmVycmVkIGNhbiBvbmx5IGJlIGNvbXBsZXRlZAogICAgICAgICAgICAvLyBvbmNlLiBBbHNvIFJlcGxhY2UgX3Byb2dyZXNzLCBzbyB0aGF0IHN1YnNlcXVlbnQgYXR0ZW1wdHMgdG8gaXNzdWUKICAgICAgICAgICAgLy8gcHJvZ3Jlc3MgdGhyb3cuCiAgICAgICAgICAgIGNvbXBsZXRlID0gX3Byb2dyZXNzID0gZnVuY3Rpb24gYWxyZWFkeUNvbXBsZXRlZCgpIHsKICAgICAgICAgICAgICAgIC8vIFRPRE86IENvbnNpZGVyIHNpbGVudGx5IHJldHVybmluZyBoZXJlIHNvIHRoYXQgcGFydGllcyB3aG8KICAgICAgICAgICAgICAgIC8vIGhhdmUgYSByZWZlcmVuY2UgdG8gdGhlIHJlc29sdmVyIGNhbm5vdCB0ZWxsIHRoYXQgdGhlIHByb21pc2UKICAgICAgICAgICAgICAgIC8vIGhhcyBiZWVuIHJlc29sdmVkIHVzaW5nIHRyeS9jYXRjaAogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJhbHJlYWR5IGNvbXBsZXRlZCIpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gRnJlZSBwcm9ncmVzc0hhbmRsZXJzIGFycmF5IHNpbmNlIHdlJ2xsIG5ldmVyIGlzc3VlIHByb2dyZXNzIGV2ZW50cwogICAgICAgICAgICAvLyBmb3IgdGhpcyBwcm9taXNlIGFnYWluIG5vdyB0aGF0IGl0J3MgY29tcGxldGVkCiAgICAgICAgICAgIHByb2dyZXNzSGFuZGxlcnMgPSB1bmRlZjsKCiAgICAgICAgICAgIC8vIE5vdGlmeSBsaXN0ZW5lcnMKICAgICAgICAgICAgLy8gVHJhdmVyc2UgYWxsIGxpc3RlbmVycyByZWdpc3RlcmVkIGRpcmVjdGx5IHdpdGggdGhpcyBEZWZlcnJlZAoKICAgICAgICAgICAgd2hpbGUgKGxpc3RlbmVyID0gbGlzdGVuZXJzW2krK10pIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVyKGNvbXBsZXRlZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxpc3RlbmVycyA9IFtdOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBmdWxsIERlZmVycmVkIG9iamVjdCwgd2l0aCBib3RoIHtAbGluayBQcm9taXNlfSBhbmQge0BsaW5rIFJlc29sdmVyfQogICAgICAgICAqIHBhcnRzCiAgICAgICAgICogQGNsYXNzIERlZmVycmVkCiAgICAgICAgICogQG5hbWUgRGVmZXJyZWQKICAgICAgICAgKi8KICAgICAgICBkZWZlcnJlZCA9IHt9OwoKICAgICAgICAvLyBQcm9taXNlIGFuZCBSZXNvbHZlciBwYXJ0cwogICAgICAgIC8vIEZyZWV6ZSBQcm9taXNlIGFuZCBSZXNvbHZlciBBUElzCgogICAgICAgIHByb21pc2UgPSBuZXcgUHJvbWlzZSgpOwogICAgICAgIHByb21pc2UudGhlbiA9IGRlZmVycmVkLnRoZW4gPSB0aGVuOwoKICAgICAgICAvKioKICAgICAgICAgKiBUaGUge0BsaW5rIFByb21pc2V9IGZvciB0aGlzIHtAbGluayBEZWZlcnJlZH0KICAgICAgICAgKiBAbWVtYmVyT2YgRGVmZXJyZWQKICAgICAgICAgKiBAbmFtZSBwcm9taXNlCiAgICAgICAgICogQHR5cGUge1Byb21pc2V9CiAgICAgICAgICovCiAgICAgICAgZGVmZXJyZWQucHJvbWlzZSA9IGZyZWV6ZShwcm9taXNlKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHtAbGluayBSZXNvbHZlcn0gZm9yIHRoaXMge0BsaW5rIERlZmVycmVkfQogICAgICAgICAqIEBtZW1iZXJPZiBEZWZlcnJlZAogICAgICAgICAqIEBuYW1lIHJlc29sdmVyCiAgICAgICAgICogQGNsYXNzIFJlc29sdmVyCiAgICAgICAgICovCiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZXIgPSBmcmVlemUoewogICAgICAgICAgICByZXNvbHZlOiAgKGRlZmVycmVkLnJlc29sdmUgID0gcmVzb2x2ZSksCiAgICAgICAgICAgIHJlamVjdDogICAoZGVmZXJyZWQucmVqZWN0ICAgPSByZWplY3QpLAogICAgICAgICAgICBwcm9ncmVzczogKGRlZmVycmVkLnByb2dyZXNzID0gcHJvZ3Jlc3MpCiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBkZWZlcnJlZDsKICAgIH0KCiAgICAvKioKICAgICAqIERldGVybWluZXMgaWYgcHJvbWlzZU9yVmFsdWUgaXMgYSBwcm9taXNlIG9yIG5vdC4gIFVzZXMgdGhlIGZlYXR1cmUKICAgICAqIHRlc3QgZnJvbSBodHRwOi8vd2lraS5jb21tb25qcy5vcmcvd2lraS9Qcm9taXNlcy9BIHRvIGRldGVybWluZSBpZgogICAgICogcHJvbWlzZU9yVmFsdWUgaXMgYSBwcm9taXNlLgogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlT3JWYWx1ZSBhbnl0aGluZwogICAgICoKICAgICAqIEByZXR1cm5zIHtCb29sZWFufSB0cnVlIGlmIHByb21pc2VPclZhbHVlIGlzIGEge0BsaW5rIFByb21pc2V9CiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzUHJvbWlzZShwcm9taXNlT3JWYWx1ZSkgewogICAgICAgIHJldHVybiBwcm9taXNlT3JWYWx1ZSAmJiB0eXBlb2YgcHJvbWlzZU9yVmFsdWUudGhlbiA9PT0gJ2Z1bmN0aW9uJzsKICAgIH0KCiAgICAvKioKICAgICAqIFJlZ2lzdGVyIGFuIG9ic2VydmVyIGZvciBhIHByb21pc2Ugb3IgaW1tZWRpYXRlIHZhbHVlLgogICAgICoKICAgICAqIEBmdW5jdGlvbgogICAgICogQG5hbWUgd2hlbgogICAgICogQG5hbWVzcGFjZQogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlT3JWYWx1ZSBhbnl0aGluZwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBjYWxsYmFjayB0byBiZSBjYWxsZWQgd2hlbiBwcm9taXNlT3JWYWx1ZSBpcwogICAgICogICBzdWNjZXNzZnVsbHkgcmVzb2x2ZWQuICBJZiBwcm9taXNlT3JWYWx1ZSBpcyBhbiBpbW1lZGlhdGUgdmFsdWUsIGNhbGxiYWNrCiAgICAgKiAgIHdpbGwgYmUgaW52b2tlZCBpbW1lZGlhdGVseS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtlcnJiYWNrXSBjYWxsYmFjayB0byBiZSBjYWxsZWQgd2hlbiBwcm9taXNlT3JWYWx1ZSBpcwogICAgICogICByZWplY3RlZC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtwcm9ncmVzc0hhbmRsZXJdIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHByb2dyZXNzIHVwZGF0ZXMKICAgICAqICAgYXJlIGlzc3VlZCBmb3IgcHJvbWlzZU9yVmFsdWUuCiAgICAgKgogICAgICogQHJldHVybnMge1Byb21pc2V9IGEgbmV3IHtAbGluayBQcm9taXNlfSB0aGF0IHdpbGwgY29tcGxldGUgd2l0aCB0aGUgcmV0dXJuCiAgICAgKiAgIHZhbHVlIG9mIGNhbGxiYWNrIG9yIGVycmJhY2sgb3IgdGhlIGNvbXBsZXRpb24gdmFsdWUgb2YgcHJvbWlzZU9yVmFsdWUgaWYKICAgICAqICAgY2FsbGJhY2sgYW5kL29yIGVycmJhY2sgaXMgbm90IHN1cHBsaWVkLgogICAgICovCiAgICBmdW5jdGlvbiB3aGVuKHByb21pc2VPclZhbHVlLCBjYWxsYmFjaywgZXJyYmFjaywgcHJvZ3Jlc3NIYW5kbGVyKSB7CiAgICAgICAgLy8gR2V0IGEgcHJvbWlzZSBmb3IgdGhlIGlucHV0IHByb21pc2VPclZhbHVlCiAgICAgICAgLy8gU2VlIHByb21pc2UoKQogICAgICAgIHZhciB0cnVzdGVkUHJvbWlzZSA9IHByb21pc2UocHJvbWlzZU9yVmFsdWUpOwoKICAgICAgICAvLyBSZWdpc3RlciBwcm9taXNlIGhhbmRsZXJzCiAgICAgICAgcmV0dXJuIHRydXN0ZWRQcm9taXNlLnRoZW4oY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzSGFuZGxlcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHByb21pc2VPclZhbHVlIGlmIHByb21pc2VPclZhbHVlIGlzIGEge0BsaW5rIFByb21pc2V9LCBhIG5ldyBQcm9taXNlIGlmCiAgICAgKiBwcm9taXNlT3JWYWx1ZSBpcyBhIGZvcmVpZ24gcHJvbWlzZSwgb3IgYSBuZXcsIGFscmVhZHktcmVzb2x2ZWQge0BsaW5rIFByb21pc2V9CiAgICAgKiB3aG9zZSByZXNvbHV0aW9uIHZhbHVlIGlzIHByb21pc2VPclZhbHVlIGlmIHByb21pc2VPclZhbHVlIGlzIGFuIGltbWVkaWF0ZSB2YWx1ZS4KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgdGhpcyBmdW5jdGlvbiBpcyBub3Qgc2FmZSB0byBleHBvcnQgc2luY2UgaXQgd2lsbCByZXR1cm4gaXRzCiAgICAgKiBpbnB1dCB3aGVuIHByb21pc2VPclZhbHVlIGlzIGEge0BsaW5rIFByb21pc2V9CiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZU9yVmFsdWUgYW55dGhpbmcKICAgICAqCiAgICAgKiBAcmV0dXJucyBHdWFyYW50ZWVkIHRvIHJldHVybiBhIHRydXN0ZWQgUHJvbWlzZS4gIElmIHByb21pc2VPclZhbHVlIGlzIGEgd2hlbi5qcyB7QGxpbmsgUHJvbWlzZX0KICAgICAqICAgcmV0dXJucyBwcm9taXNlT3JWYWx1ZSwgb3RoZXJ3aXNlLCByZXR1cm5zIGEgbmV3LCBhbHJlYWR5LXJlc29sdmVkLCB3aGVuLmpzIHtAbGluayBQcm9taXNlfQogICAgICogICB3aG9zZSByZXNvbHV0aW9uIHZhbHVlIGlzOgogICAgICogICAqIHRoZSByZXNvbHV0aW9uIHZhbHVlIG9mIHByb21pc2VPclZhbHVlIGlmIGl0J3MgYSBmb3JlaWduIHByb21pc2UsIG9yCiAgICAgKiAgICogcHJvbWlzZU9yVmFsdWUgaWYgaXQncyBhIHZhbHVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHByb21pc2UocHJvbWlzZU9yVmFsdWUpIHsKICAgICAgICB2YXIgcHJvbWlzZSwgZGVmZXJyZWQ7CgogICAgICAgIGlmKHByb21pc2VPclZhbHVlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgICAgICAvLyBJdCdzIGEgd2hlbi5qcyBwcm9taXNlLCBzbyB3ZSB0cnVzdCBpdAogICAgICAgICAgICBwcm9taXNlID0gcHJvbWlzZU9yVmFsdWU7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIEl0J3Mgbm90IGEgd2hlbi5qcyBwcm9taXNlLiAgQ2hlY2sgdG8gc2VlIGlmIGl0J3MgYSBmb3JlaWduIHByb21pc2UKICAgICAgICAgICAgLy8gb3IgYSB2YWx1ZS4KCiAgICAgICAgICAgIGRlZmVycmVkID0gZGVmZXIoKTsKICAgICAgICAgICAgaWYoaXNQcm9taXNlKHByb21pc2VPclZhbHVlKSkgewogICAgICAgICAgICAgICAgLy8gSXQncyBhIGNvbXBsaWFudCBwcm9taXNlLCBidXQgd2UgZG9uJ3Qga25vdyB3aGVyZSBpdCBjYW1lIGZyb20sCiAgICAgICAgICAgICAgICAvLyBzbyB3ZSBkb24ndCB0cnVzdCBpdHMgaW1wbGVtZW50YXRpb24gZW50aXJlbHkuICBJbnRyb2R1Y2UgYSB0cnVzdGVkCiAgICAgICAgICAgICAgICAvLyBtaWRkbGVtYW4gd2hlbi5qcyBwcm9taXNlCgogICAgICAgICAgICAgICAgLy8gSU1QT1JUQU5UOiBUaGlzIGlzIHRoZSBvbmx5IHBsYWNlIHdoZW4uanMgc2hvdWxkIGV2ZXIgY2FsbCAudGhlbigpIG9uCiAgICAgICAgICAgICAgICAvLyBhbiB1bnRydXN0ZWQgcHJvbWlzZS4KICAgICAgICAgICAgICAgIHByb21pc2VPclZhbHVlLnRoZW4oZGVmZXJyZWQucmVzb2x2ZSwgZGVmZXJyZWQucmVqZWN0LCBkZWZlcnJlZC5wcm9ncmVzcyk7CiAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJdCdzIGEgdmFsdWUsIG5vdCBhIHByb21pc2UuICBDcmVhdGUgYW4gYWxyZWFkeS1yZXNvbHZlZCBwcm9taXNlCiAgICAgICAgICAgICAgICAvLyBmb3IgaXQuCiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHByb21pc2VPclZhbHVlKTsKICAgICAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBhIHByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUgd2hlbiBob3dNYW55IG9mIHRoZSBzdXBwbGllZCBwcm9taXNlc09yVmFsdWVzCiAgICAgKiBoYXZlIHJlc29sdmVkLiBUaGUgcmVzb2x1dGlvbiB2YWx1ZSBvZiB0aGUgcmV0dXJuZWQgcHJvbWlzZSB3aWxsIGJlIGFuIGFycmF5IG9mCiAgICAgKiBsZW5ndGggaG93TWFueSBjb250YWluaW5nIHRoZSByZXNvbHV0aW9ucyB2YWx1ZXMgb2YgdGhlIHRyaWdnZXJpbmcgcHJvbWlzZXNPclZhbHVlcy4KICAgICAqCiAgICAgKiBAbWVtYmVyT2Ygd2hlbgogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlc09yVmFsdWVzIHtBcnJheX0gYXJyYXkgb2YgYW55dGhpbmcsIG1heSBjb250YWluIGEgbWl4CiAgICAgKiAgICAgIG9mIHtAbGluayBQcm9taXNlfXMgYW5kIHZhbHVlcwogICAgICogQHBhcmFtIGhvd01hbnkKICAgICAqIEBwYXJhbSBbY2FsbGJhY2tdCiAgICAgKiBAcGFyYW0gW2VycmJhY2tdCiAgICAgKiBAcGFyYW0gW3Byb2dyZXNzSGFuZGxlcl0KICAgICAqCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0KICAgICAqLwogICAgZnVuY3Rpb24gc29tZShwcm9taXNlc09yVmFsdWVzLCBob3dNYW55LCBjYWxsYmFjaywgZXJyYmFjaywgcHJvZ3Jlc3NIYW5kbGVyKSB7CgogICAgICAgIGNoZWNrQ2FsbGJhY2tzKDIsIGFyZ3VtZW50cyk7CgogICAgICAgIHJldHVybiB3aGVuKHByb21pc2VzT3JWYWx1ZXMsIGZ1bmN0aW9uKHByb21pc2VzT3JWYWx1ZXMpIHsKCiAgICAgICAgICAgIHZhciB0b1Jlc29sdmUsIHJlc3VsdHMsIHJldCwgZGVmZXJyZWQsIHJlc29sdmVyLCByZWplY3RlciwgaGFuZGxlUHJvZ3Jlc3MsIGxlbiwgaTsKCiAgICAgICAgICAgIGxlbiA9IHByb21pc2VzT3JWYWx1ZXMubGVuZ3RoID4+PiAwOwoKICAgICAgICAgICAgdG9SZXNvbHZlID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oaG93TWFueSwgbGVuKSk7CiAgICAgICAgICAgIHJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgZGVmZXJyZWQgPSBkZWZlcigpOwogICAgICAgICAgICByZXQgPSB3aGVuKGRlZmVycmVkLCBjYWxsYmFjaywgZXJyYmFjaywgcHJvZ3Jlc3NIYW5kbGVyKTsKCiAgICAgICAgICAgIC8vIFdyYXBwZXIgc28gdGhhdCByZXNvbHZlciBjYW4gYmUgcmVwbGFjZWQKICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZSh2YWwpIHsKICAgICAgICAgICAgICAgIHJlc29sdmVyKHZhbCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFdyYXBwZXIgc28gdGhhdCByZWplY3RlciBjYW4gYmUgcmVwbGFjZWQKICAgICAgICAgICAgZnVuY3Rpb24gcmVqZWN0KGVycikgewogICAgICAgICAgICAgICAgcmVqZWN0ZXIoZXJyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gV3JhcHBlciBzbyB0aGF0IHByb2dyZXNzIGNhbiBiZSByZXBsYWNlZAogICAgICAgICAgICBmdW5jdGlvbiBwcm9ncmVzcyh1cGRhdGUpIHsKICAgICAgICAgICAgICAgIGhhbmRsZVByb2dyZXNzKHVwZGF0ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlKCkgewogICAgICAgICAgICAgICAgcmVzb2x2ZXIgPSByZWplY3RlciA9IGhhbmRsZVByb2dyZXNzID0gbm9vcDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTm8gaXRlbXMgaW4gdGhlIGlucHV0LCByZXNvbHZlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIGlmICghdG9SZXNvbHZlKSB7CiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlc29sdmVyIGZvciBwcm9taXNlcy4gIENhcHR1cmVzIHRoZSB2YWx1ZSBhbmQgcmVzb2x2ZXMKICAgICAgICAgICAgICAgIC8vIHRoZSByZXR1cm5lZCBwcm9taXNlIHdoZW4gdG9SZXNvbHZlIHJlYWNoZXMgemVyby4KICAgICAgICAgICAgICAgIC8vIE92ZXJ3cml0ZXMgcmVzb2x2ZXIgdmFyIHdpdGggYSBub29wIG9uY2UgcHJvbWlzZSBoYXMKICAgICAgICAgICAgICAgIC8vIGJlIHJlc29sdmVkIHRvIGNvdmVyIGNhc2Ugd2hlcmUgbiA8IHByb21pc2VzLmxlbmd0aAogICAgICAgICAgICAgICAgcmVzb2x2ZXIgPSBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIG9yZGVycyB0aGUgdmFsdWVzIGJhc2VkIG9uIHByb21pc2UgcmVzb2x1dGlvbiBvcmRlcgogICAgICAgICAgICAgICAgICAgIC8vIEFub3RoZXIgc3RyYXRlZ3kgd291bGQgYmUgdG8gdXNlIHRoZSBvcmlnaW5hbCBwb3NpdGlvbiBvZgogICAgICAgICAgICAgICAgICAgIC8vIHRoZSBjb3JyZXNwb25kaW5nIHByb21pc2UuCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHZhbCk7CgogICAgICAgICAgICAgICAgICAgIGlmICghLS10b1Jlc29sdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8vIFJlamVjdGVyIGZvciBwcm9taXNlcy4gIFJlamVjdHMgcmV0dXJuZWQgcHJvbWlzZQogICAgICAgICAgICAgICAgLy8gaW1tZWRpYXRlbHksIGFuZCBvdmVyd3JpdGVzIHJlamVjdGVyIHZhciB3aXRoIGEgbm9vcAogICAgICAgICAgICAgICAgLy8gb25jZSBwcm9taXNlIHRvIGNvdmVyIGNhc2Ugd2hlcmUgbiA8IHByb21pc2VzLmxlbmd0aC4KICAgICAgICAgICAgICAgIC8vIFRPRE86IENvbnNpZGVyIHJlamVjdGluZyBvbmx5IHdoZW4gTiAob3IgcHJvbWlzZXMubGVuZ3RoIC0gTj8pCiAgICAgICAgICAgICAgICAvLyBwcm9taXNlcyBoYXZlIGJlZW4gcmVqZWN0ZWQgaW5zdGVhZCBvZiBvbmx5IG9uZT8KICAgICAgICAgICAgICAgIHJlamVjdGVyID0gZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgY29tcGxldGUoKTsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaGFuZGxlUHJvZ3Jlc3MgPSBkZWZlcnJlZC5wcm9ncmVzczsKCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBSZXBsYWNlIHdoaWxlIHdpdGggZm9yRWFjaAogICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICBpZihpIGluIHByb21pc2VzT3JWYWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbihwcm9taXNlc09yVmFsdWVzW2ldLCByZXNvbHZlLCByZWplY3QsIHByb2dyZXNzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIG9ubHkgb25jZSBhbGwgdGhlIHN1cHBsaWVkIHByb21pc2VzT3JWYWx1ZXMKICAgICAqIGhhdmUgcmVzb2x2ZWQuIFRoZSByZXNvbHV0aW9uIHZhbHVlIG9mIHRoZSByZXR1cm5lZCBwcm9taXNlIHdpbGwgYmUgYW4gYXJyYXkKICAgICAqIGNvbnRhaW5pbmcgdGhlIHJlc29sdXRpb24gdmFsdWVzIG9mIGVhY2ggb2YgdGhlIHByb21pc2VzT3JWYWx1ZXMuCiAgICAgKgogICAgICogQG1lbWJlck9mIHdoZW4KICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZXNPclZhbHVlcyB7QXJyYXl8UHJvbWlzZX0gYXJyYXkgb2YgYW55dGhpbmcsIG1heSBjb250YWluIGEgbWl4CiAgICAgKiAgICAgIG9mIHtAbGluayBQcm9taXNlfXMgYW5kIHZhbHVlcwogICAgICogQHBhcmFtIFtjYWxsYmFja10ge0Z1bmN0aW9ufQogICAgICogQHBhcmFtIFtlcnJiYWNrXSB7RnVuY3Rpb259CiAgICAgKiBAcGFyYW0gW3Byb2dyZXNzSGFuZGxlcl0ge0Z1bmN0aW9ufQogICAgICoKICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQogICAgICovCiAgICBmdW5jdGlvbiBhbGwocHJvbWlzZXNPclZhbHVlcywgY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzSGFuZGxlcikgewoKICAgICAgICBjaGVja0NhbGxiYWNrcygxLCBhcmd1bWVudHMpOwoKICAgICAgICByZXR1cm4gd2hlbihwcm9taXNlc09yVmFsdWVzLCBmdW5jdGlvbihwcm9taXNlc09yVmFsdWVzKSB7CiAgICAgICAgICAgIHJldHVybiBfcmVkdWNlKHByb21pc2VzT3JWYWx1ZXMsIHJlZHVjZUludG9BcnJheSwgW10pOwogICAgICAgIH0pLnRoZW4oY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzSGFuZGxlcik7CiAgICB9CgogICAgZnVuY3Rpb24gcmVkdWNlSW50b0FycmF5KGN1cnJlbnQsIHZhbCwgaSkgewogICAgICAgIGN1cnJlbnRbaV0gPSB2YWw7CiAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHdoZW4gYW55IG9uZSBvZiB0aGUgc3VwcGxpZWQgcHJvbWlzZXNPclZhbHVlcwogICAgICogaGFzIHJlc29sdmVkLiBUaGUgcmVzb2x1dGlvbiB2YWx1ZSBvZiB0aGUgcmV0dXJuZWQgcHJvbWlzZSB3aWxsIGJlIHRoZSByZXNvbHV0aW9uCiAgICAgKiB2YWx1ZSBvZiB0aGUgdHJpZ2dlcmluZyBwcm9taXNlT3JWYWx1ZS4KICAgICAqCiAgICAgKiBAbWVtYmVyT2Ygd2hlbgogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlc09yVmFsdWVzIHtBcnJheXxQcm9taXNlfSBhcnJheSBvZiBhbnl0aGluZywgbWF5IGNvbnRhaW4gYSBtaXgKICAgICAqICAgICAgb2Yge0BsaW5rIFByb21pc2V9cyBhbmQgdmFsdWVzCiAgICAgKiBAcGFyYW0gW2NhbGxiYWNrXSB7RnVuY3Rpb259CiAgICAgKiBAcGFyYW0gW2VycmJhY2tdIHtGdW5jdGlvbn0KICAgICAqIEBwYXJhbSBbcHJvZ3Jlc3NIYW5kbGVyXSB7RnVuY3Rpb259CiAgICAgKgogICAgICogQHJldHVybnMge1Byb21pc2V9CiAgICAgKi8KICAgIGZ1bmN0aW9uIGFueShwcm9taXNlc09yVmFsdWVzLCBjYWxsYmFjaywgZXJyYmFjaywgcHJvZ3Jlc3NIYW5kbGVyKSB7CgogICAgICAgIGZ1bmN0aW9uIHVud3JhcFNpbmdsZVJlc3VsdCh2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrID8gY2FsbGJhY2sodmFsWzBdKSA6IHZhbFswXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzb21lKHByb21pc2VzT3JWYWx1ZXMsIDEsIHVud3JhcFNpbmdsZVJlc3VsdCwgZXJyYmFjaywgcHJvZ3Jlc3NIYW5kbGVyKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRyYWRpdGlvbmFsIG1hcCBmdW5jdGlvbiwgc2ltaWxhciB0byBgQXJyYXkucHJvdG90eXBlLm1hcCgpYCwgYnV0IGFsbG93cwogICAgICogaW5wdXQgdG8gY29udGFpbiB7QGxpbmsgUHJvbWlzZX1zIGFuZC9vciB2YWx1ZXMsIGFuZCBtYXBGdW5jIG1heSByZXR1cm4KICAgICAqIGVpdGhlciBhIHZhbHVlIG9yIGEge0BsaW5rIFByb21pc2V9CiAgICAgKgogICAgICogQG1lbWJlck9mIHdoZW4KICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZSB7QXJyYXl8UHJvbWlzZX0gYXJyYXkgb2YgYW55dGhpbmcsIG1heSBjb250YWluIGEgbWl4CiAgICAgKiAgICAgIG9mIHtAbGluayBQcm9taXNlfXMgYW5kIHZhbHVlcwogICAgICogQHBhcmFtIG1hcEZ1bmMge0Z1bmN0aW9ufSBtYXBwaW5nIGZ1bmN0aW9uIG1hcEZ1bmModmFsdWUpIHdoaWNoIG1heSByZXR1cm4KICAgICAqICAgICAgZWl0aGVyIGEge0BsaW5rIFByb21pc2V9IG9yIHZhbHVlCiAgICAgKgogICAgICogQHJldHVybnMge1Byb21pc2V9IGEge0BsaW5rIFByb21pc2V9IHRoYXQgd2lsbCByZXNvbHZlIHRvIGFuIGFycmF5IGNvbnRhaW5pbmcKICAgICAqICAgICAgdGhlIG1hcHBlZCBvdXRwdXQgdmFsdWVzLgogICAgICovCiAgICBmdW5jdGlvbiBtYXAocHJvbWlzZSwgbWFwRnVuYykgewogICAgICAgIHJldHVybiB3aGVuKHByb21pc2UsIGZ1bmN0aW9uKGFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiBfbWFwKGFycmF5LCBtYXBGdW5jKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFByaXZhdGUgbWFwIGhlbHBlciB0byBtYXAgYW4gYXJyYXkgb2YgcHJvbWlzZXMKICAgICAqIEBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIHByb21pc2VzT3JWYWx1ZXMge0FycmF5fQogICAgICogQHBhcmFtIG1hcEZ1bmMge0Z1bmN0aW9ufQogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogICAgZnVuY3Rpb24gX21hcChwcm9taXNlc09yVmFsdWVzLCBtYXBGdW5jKSB7CgogICAgICAgIHZhciByZXN1bHRzLCBsZW4sIGk7CgogICAgICAgIC8vIFNpbmNlIHdlIGtub3cgdGhlIHJlc3VsdGluZyBsZW5ndGgsIHdlIGNhbiBwcmVhbGxvY2F0ZSB0aGUgcmVzdWx0cwogICAgICAgIC8vIGFycmF5IHRvIGF2b2lkIGFycmF5IGV4cGFuc2lvbnMuCiAgICAgICAgbGVuID0gcHJvbWlzZXNPclZhbHVlcy5sZW5ndGggPj4+IDA7CiAgICAgICAgcmVzdWx0cyA9IG5ldyBBcnJheShsZW4pOwoKICAgICAgICAvLyBTaW5jZSBtYXBGdW5jIG1heSBiZSBhc3luYywgZ2V0IGFsbCBpbnZvY2F0aW9ucyBvZiBpdCBpbnRvIGZsaWdodAogICAgICAgIC8vIGFzYXAsIGFuZCB0aGVuIHVzZSByZWR1Y2UoKSB0byBjb2xsZWN0IGFsbCB0aGUgcmVzdWx0cwogICAgICAgIGZvcihpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKGkgaW4gcHJvbWlzZXNPclZhbHVlcykKICAgICAgICAgICAgICAgIHJlc3VsdHNbaV0gPSB3aGVuKHByb21pc2VzT3JWYWx1ZXNbaV0sIG1hcEZ1bmMpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ291bGQgdXNlIGFsbCgpIGhlcmUsIGJ1dCB0aGF0IHdvdWxkIHJlc3VsdCBpbiBhbm90aGVyIGFycmF5CiAgICAgICAgLy8gYmVpbmcgYWxsb2NhdGVkLCBpLmUuIG1hcCgpIHdvdWxkIGVuZCB1cCBhbGxvY2F0aW5nIDIgYXJyYXlzCiAgICAgICAgLy8gb2Ygc2l6ZSBsZW4gaW5zdGVhZCBvZiBqdXN0IDEuICBTaW5jZSBhbGwoKSB1c2VzIHJlZHVjZSgpCiAgICAgICAgLy8gYW55d2F5LCBhdm9pZCB0aGUgYWRkaXRpb25hbCBhbGxvY2F0aW9uIGJ5IGNhbGxpbmcgcmVkdWNlCiAgICAgICAgLy8gZGlyZWN0bHkuCiAgICAgICAgcmV0dXJuIF9yZWR1Y2UocmVzdWx0cywgcmVkdWNlSW50b0FycmF5LCByZXN1bHRzKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRyYWRpdGlvbmFsIHJlZHVjZSBmdW5jdGlvbiwgc2ltaWxhciB0byBgQXJyYXkucHJvdG90eXBlLnJlZHVjZSgpYCwgYnV0CiAgICAgKiBpbnB1dCBtYXkgY29udGFpbiB7QGxpbmsgUHJvbWlzZX1zIGFuZC9vciB2YWx1ZXMsIGFuZCByZWR1Y2VGdW5jCiAgICAgKiBtYXkgcmV0dXJuIGVpdGhlciBhIHZhbHVlIG9yIGEge0BsaW5rIFByb21pc2V9LCAqYW5kKiBpbml0aWFsVmFsdWUgbWF5CiAgICAgKiBiZSBhIHtAbGluayBQcm9taXNlfSBmb3IgdGhlIHN0YXJ0aW5nIHZhbHVlLgogICAgICoKICAgICAqIEBtZW1iZXJPZiB3aGVuCiAgICAgKgogICAgICogQHBhcmFtIHByb21pc2Uge0FycmF5fFByb21pc2V9IGFycmF5IG9mIGFueXRoaW5nLCBtYXkgY29udGFpbiBhIG1peAogICAgICogICAgICBvZiB7QGxpbmsgUHJvbWlzZX1zIGFuZCB2YWx1ZXMuICBNYXkgYWxzbyBiZSBhIHtAbGluayBQcm9taXNlfSBmb3IKICAgICAqICAgICAgYW4gYXJyYXkuCiAgICAgKiBAcGFyYW0gcmVkdWNlRnVuYyB7RnVuY3Rpb259IHJlZHVjZSBmdW5jdGlvbiByZWR1Y2UoY3VycmVudFZhbHVlLCBuZXh0VmFsdWUsIGluZGV4LCB0b3RhbCksCiAgICAgKiAgICAgIHdoZXJlIHRvdGFsIGlzIHRoZSB0b3RhbCBudW1iZXIgb2YgaXRlbXMgYmVpbmcgcmVkdWNlZCwgYW5kIHdpbGwgYmUgdGhlIHNhbWUKICAgICAqICAgICAgaW4gZWFjaCBjYWxsIHRvIHJlZHVjZUZ1bmMuCiAgICAgKiBAcGFyYW0gaW5pdGlhbFZhbHVlIHN0YXJ0aW5nIHZhbHVlLCBvciBhIHtAbGluayBQcm9taXNlfSBmb3IgdGhlIHN0YXJ0aW5nIHZhbHVlCiAgICAgKgogICAgICogQHJldHVybnMge1Byb21pc2V9IHRoYXQgd2lsbCByZXNvbHZlIHRvIHRoZSBmaW5hbCByZWR1Y2VkIHZhbHVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlZHVjZShwcm9taXNlLCByZWR1Y2VGdW5jLCBpbml0aWFsVmFsdWUpIHsKICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICByZXR1cm4gd2hlbihwcm9taXNlLCBmdW5jdGlvbihhcnJheSkgewogICAgICAgICAgICByZXR1cm4gX3JlZHVjZS5hcHBseSh1bmRlZiwgW2FycmF5XS5jb25jYXQoYXJncykpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogUHJpdmF0ZSByZWR1Y2UgdG8gcmVkdWNlIGFuIGFycmF5IG9mIHByb21pc2VzCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlc09yVmFsdWVzIHtBcnJheX0KICAgICAqIEBwYXJhbSByZWR1Y2VGdW5jIHtGdW5jdGlvbn0KICAgICAqIEBwYXJhbSBpbml0aWFsVmFsdWUgeyp9CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfQogICAgICovCiAgICBmdW5jdGlvbiBfcmVkdWNlKHByb21pc2VzT3JWYWx1ZXMsIHJlZHVjZUZ1bmMsIGluaXRpYWxWYWx1ZSkgewoKICAgICAgICB2YXIgdG90YWwsIGFyZ3M7CgogICAgICAgIHRvdGFsID0gcHJvbWlzZXNPclZhbHVlcy5sZW5ndGg7CgogICAgICAgIC8vIFNraXAgcHJvbWlzZXNPclZhbHVlcywgc2luY2UgaXQgd2lsbCBiZSB1c2VkIGFzICd0aGlzJyBpbiB0aGUgY2FsbAogICAgICAgIC8vIHRvIHRoZSBhY3R1YWwgcmVkdWNlIGVuZ2luZSBiZWxvdy4KCiAgICAgICAgLy8gV3JhcCB0aGUgc3VwcGxpZWQgcmVkdWNlRnVuYyB3aXRoIG9uZSB0aGF0IGhhbmRsZXMgcHJvbWlzZXMgYW5kIHRoZW4KICAgICAgICAvLyBkZWxlZ2F0ZXMgdG8gdGhlIHN1cHBsaWVkLgoKICAgICAgICBhcmdzID0gWwogICAgICAgICAgICBmdW5jdGlvbiAoY3VycmVudCwgdmFsLCBpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd2hlbihjdXJyZW50LCBmdW5jdGlvbiAoYykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuKHZhbCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWR1Y2VGdW5jKGMsIHZhbHVlLCBpLCB0b3RhbCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIF07CgogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMikgYXJncy5wdXNoKGluaXRpYWxWYWx1ZSk7CgogICAgICAgIHJldHVybiByZWR1Y2VBcnJheS5hcHBseShwcm9taXNlc09yVmFsdWVzLCBhcmdzKTsKICAgIH0KCiAgICAvKioKICAgICAqIEVuc3VyZSB0aGF0IHJlc29sdXRpb24gb2YgcHJvbWlzZU9yVmFsdWUgd2lsbCBjb21wbGV0ZSByZXNvbHZlciB3aXRoIHRoZSBjb21wbGV0aW9uCiAgICAgKiB2YWx1ZSBvZiBwcm9taXNlT3JWYWx1ZSwgb3IgaW5zdGVhZCB3aXRoIHJlc29sdmVWYWx1ZSBpZiBpdCBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBAbWVtYmVyT2Ygd2hlbgogICAgICoKICAgICAqIEBwYXJhbSBwcm9taXNlT3JWYWx1ZQogICAgICogQHBhcmFtIHJlc29sdmVyIHtSZXNvbHZlcn0KICAgICAqIEBwYXJhbSBbcmVzb2x2ZVZhbHVlXSBhbnl0aGluZwogICAgICoKICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQogICAgICovCiAgICBmdW5jdGlvbiBjaGFpbihwcm9taXNlT3JWYWx1ZSwgcmVzb2x2ZXIsIHJlc29sdmVWYWx1ZSkgewogICAgICAgIHZhciB1c2VSZXNvbHZlVmFsdWUgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKCiAgICAgICAgcmV0dXJuIHdoZW4ocHJvbWlzZU9yVmFsdWUsCiAgICAgICAgICAgIGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgaWYodXNlUmVzb2x2ZVZhbHVlKSB2YWwgPSByZXNvbHZlVmFsdWU7CiAgICAgICAgICAgICAgICByZXNvbHZlci5yZXNvbHZlKHZhbCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgICAgICB9LAogICAgICAgICAgICBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICByZXNvbHZlci5yZWplY3QoZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0ZWQoZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlc29sdmVyLnByb2dyZXNzCiAgICAgICAgKTsKICAgIH0KCiAgICAvLwogICAgLy8gVXRpbGl0eSBmdW5jdGlvbnMKICAgIC8vCgogICAgLyoqCiAgICAgKiBIZWxwZXIgdGhhdCBjaGVja3MgYXJyYXlPZkNhbGxiYWNrcyB0byBlbnN1cmUgdGhhdCBlYWNoIGVsZW1lbnQgaXMgZWl0aGVyCiAgICAgKiBhIGZ1bmN0aW9uLCBvciBudWxsIG9yIHVuZGVmaW5lZC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSBhcnJheU9mQ2FsbGJhY2tzIHtBcnJheX0gYXJyYXkgdG8gY2hlY2sKICAgICAqIEB0aHJvd3Mge0Vycm9yfSBpZiBhbnkgZWxlbWVudCBvZiBhcnJheU9mQ2FsbGJhY2tzIGlzIHNvbWV0aGluZyBvdGhlciB0aGFuCiAgICAgKiBhIEZ1bmN0aW9ucywgbnVsbCwgb3IgdW5kZWZpbmVkLgogICAgICovCiAgICBmdW5jdGlvbiBjaGVja0NhbGxiYWNrcyhzdGFydCwgYXJyYXlPZkNhbGxiYWNrcykgewogICAgICAgIHZhciBhcmcsIGkgPSBhcnJheU9mQ2FsbGJhY2tzLmxlbmd0aDsKICAgICAgICB3aGlsZShpID4gc3RhcnQpIHsKICAgICAgICAgICAgYXJnID0gYXJyYXlPZkNhbGxiYWNrc1stLWldOwogICAgICAgICAgICBpZiAoYXJnICE9IG51bGwgJiYgdHlwZW9mIGFyZyAhPSAnZnVuY3Rpb24nKSB0aHJvdyBuZXcgRXJyb3IoJ2NhbGxiYWNrIGlzIG5vdCBhIGZ1bmN0aW9uJyk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogTm8tT3AgZnVuY3Rpb24gdXNlZCBpbiBtZXRob2QgcmVwbGFjZW1lbnQKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7fQoKICAgIHNsaWNlID0gW10uc2xpY2U7CgogICAgLy8gRVM1IHJlZHVjZSBpbXBsZW1lbnRhdGlvbiBpZiBuYXRpdmUgbm90IGF2YWlsYWJsZQogICAgLy8gU2VlOiBodHRwOi8vZXM1LmdpdGh1Yi5jb20vI3gxNS40LjQuMjEgYXMgdGhlcmUgYXJlIG1hbnkKICAgIC8vIHNwZWNpZmljcyBhbmQgZWRnZSBjYXNlcy4KICAgIHJlZHVjZUFycmF5ID0gW10ucmVkdWNlIHx8CiAgICAgICAgZnVuY3Rpb24ocmVkdWNlRnVuYyAvKiwgaW5pdGlhbFZhbHVlICovKSB7CiAgICAgICAgICAgIC8vIEVTNSBkaWN0YXRlcyB0aGF0IHJlZHVjZS5sZW5ndGggPT09IDEKCiAgICAgICAgICAgIC8vIFRoaXMgaW1wbGVtZW50YXRpb24gZGV2aWF0ZXMgZnJvbSBFUzUgc3BlYyBpbiB0aGUgZm9sbG93aW5nIHdheXM6CiAgICAgICAgICAgIC8vIDEuIEl0IGRvZXMgbm90IGNoZWNrIGlmIHJlZHVjZUZ1bmMgaXMgYSBDYWxsYWJsZQoKICAgICAgICAgICAgdmFyIGFyciwgYXJncywgcmVkdWNlZCwgbGVuLCBpOwoKICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgIGFyciA9IE9iamVjdCh0aGlzKTsKICAgICAgICAgICAgbGVuID0gYXJyLmxlbmd0aCA+Pj4gMDsKICAgICAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKCiAgICAgICAgICAgIC8vIElmIG5vIGluaXRpYWxWYWx1ZSwgdXNlIGZpcnN0IGl0ZW0gb2YgYXJyYXkgKHdlIGtub3cgbGVuZ3RoICE9PSAwIGhlcmUpCiAgICAgICAgICAgIC8vIGFuZCBhZGp1c3QgaSB0byBzdGFydCBhdCBzZWNvbmQgaXRlbQogICAgICAgICAgICBpZihhcmdzLmxlbmd0aCA8PSAxKSB7CiAgICAgICAgICAgICAgICAvLyBTa2lwIHRvIHRoZSBmaXJzdCByZWFsIGVsZW1lbnQgaW4gdGhlIGFycmF5CiAgICAgICAgICAgICAgICBmb3IoOzspIHsKICAgICAgICAgICAgICAgICAgICBpZihpIGluIGFycikgewogICAgICAgICAgICAgICAgICAgICAgICByZWR1Y2VkID0gYXJyW2krK107CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgd2UgcmVhY2hlZCB0aGUgZW5kIG9mIHRoZSBhcnJheSB3aXRob3V0IGZpbmRpbmcgYW55IHJlYWwKICAgICAgICAgICAgICAgICAgICAvLyBlbGVtZW50cywgaXQncyBhIFR5cGVFcnJvcgogICAgICAgICAgICAgICAgICAgIGlmKCsraSA+PSBsZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIElmIGluaXRpYWxWYWx1ZSBwcm92aWRlZCwgdXNlIGl0CiAgICAgICAgICAgICAgICByZWR1Y2VkID0gYXJnc1sxXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRG8gdGhlIGFjdHVhbCByZWR1Y2UKICAgICAgICAgICAgZm9yKDtpIDwgbGVuOyArK2kpIHsKICAgICAgICAgICAgICAgIC8vIFNraXAgaG9sZXMKICAgICAgICAgICAgICAgIGlmKGkgaW4gYXJyKQogICAgICAgICAgICAgICAgICAgIHJlZHVjZWQgPSByZWR1Y2VGdW5jKHJlZHVjZWQsIGFycltpXSwgaSwgYXJyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlZHVjZWQ7CiAgICAgICAgfTsKCiAgICByZXR1cm4gd2hlbjsKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJwogICAgPyBkZWZpbmUKICAgIDogZnVuY3Rpb24gKGZhY3RvcnkpIHsgdHlwZW9mIG1vZHVsZSAhPSAndW5kZWZpbmVkJwogICAgICAgID8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpKQogICAgICAgIDogKHRoaXMud2hlbiAgICAgID0gZmFjdG9yeSgpKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKZGVmaW5lKCd3aGVuJywgWyd3aGVuL3doZW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKLyoqIEBsaWNlbnNlIE1JVCBMaWNlbnNlIChjKSBjb3B5cmlnaHQgQiBDYXZhbGllciAmIEogSGFubiAqLwoKLyoqCiAqIFRoaXMgaXMgYSBkcm9wLWluIHJlcGxhY2VtZW50IGZvciB0aGUgd2hlbiBtb2R1bGUgdGhhdCBzZXRzIHVwIGF1dG9tYXRpYwogKiBkZWJ1ZyBvdXRwdXQgZm9yIHByb21pc2VzIGNyZWF0ZWQgb3IgY29uc3VtZWQgYnkgd2hlbi5qcy4gIFVzZSB0aGlzCiAqIGluc3RlYWQgb2Ygd2hlbiB0byBoZWxwIHdpdGggZGVidWdnaW5nLgogKgogKiBXQVJOSU5HOiBUaGlzIG1vZHVsZSAqKnNob3VsZCBuZXZlcioqIGJlIHVzZSB0aGlzIGluIGEgcHJvZHVjdGlvbiBlbnZpcm9ubWVudC4KICogSXQgZXhwb3NlcyBkZXRhaWxzIG9mIHRoZSBwcm9taXNlCiAqCiAqIEluIGFuIEFNRCBlbnZpcm9ubWVudCwgeW91IGNhbiBzaW1wbHkgY2hhbmdlIHlvdXIgcGF0aCBvciBwYWNrYWdlIG1hcHBpbmdzOgogKgogKiBwYXRoczogewogKiAgIC8vICd3aGVuJzogJ3BhdGgvdG8vd2hlbi93aGVuJwogKiAgICd3aGVuJzogJ3BhdGgvdG8vd2hlbi9kZWJ1ZycKICogfQogKgogKiBvcgogKgogKiBwYWNrYWdlczogWwogKiAgIC8vIHsgbmFtZTogJ3doZW4nLCBsb2NhdGlvbjogJ3BhdGgvdG8vd2hlbicsIG1haW46ICd3aGVuJyB9CiAqICAgeyBuYW1lOiAnd2hlbicsIGxvY2F0aW9uOiAncGF0aC90by93aGVuJywgbWFpbjogJ2RlYnVnJyB9CiAqIF0KICoKICogSW4gYSBDb21tb25KUyBlbnZpcm9ubWVudCwgeW91IGNhbiBkaXJlY3RseSByZXF1aXJlIHRoaXMgbW9kdWxlIHdoZXJlCiAqIHlvdSB3b3VsZCBub3JtYWxseSByZXF1aXJlICd3aGVuJzoKICoKICogLy8gdmFyIHdoZW4gPSByZXF1aXJlKCd3aGVuJyk7CiAqIHZhciB3aGVuID0gcmVxdWlyZSgnd2hlbi9kZWJ1ZycpOwogKgogKiBPciB5b3UgY2FuIHRlbXBvcmFyaWx5IG1vZGlmeSB0aGUgcGFja2FnZS5qcyB0byBwb2ludCBtYWluIGF0IGRlYnVnLgogKiBGb3IgZXhhbXBsZSwgd2hlbi9wYWNrYWdlLmpzb246CiAqCiAqIC4uLgogKiAibWFpbiI6ICIuL2RlYnVnIgogKiAuLi4KICoKICogQGF1dGhvciBicmlhbkBob3ZlcmNyYWZ0c3R1ZGlvcy5jb20KICovCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL2RlYnVnJyxbJy4vd2hlbiddLCBmdW5jdGlvbih3aGVuKSB7CgogICAgdmFyIHByb21pc2VJZCwgZnJlZXplLCBwZW5kaW5nLCBleGNlcHRpb25zVG9SZXRocm93LCB1bmRlZjsKCiAgICBwcm9taXNlSWQgPSAwOwogICAgZnJlZXplID0gT2JqZWN0LmZyZWV6ZSB8fCBmdW5jdGlvbihvKSB7IHJldHVybiBvOyB9OwogICAgcGVuZGluZyA9IHt9OwoKICAgIGV4Y2VwdGlvbnNUb1JldGhyb3cgPSB7CiAgICAgICAgUmFuZ2VFcnJvcjogMSwKICAgICAgICBSZWZlcmVuY2VFcnJvcjogMSwKICAgICAgICBTeW50YXhFcnJvcjogMSwKICAgICAgICBUeXBlRXJyb3I6IDEKICAgIH07CgogICAgLyoqCiAgICAgKiBTZXR1cCBkZWJ1ZyBvdXRwdXQgaGFuZGxlcnMgZm9yIHRoZSBzdXBwbGllZCBwcm9taXNlLgogICAgICogQHBhcmFtIHAge1Byb21pc2V9IEEgdHJ1c3RlZCAod2hlbi5qcykgcHJvbWlzZQogICAgICogQHJldHVybiBwCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRlYnVnUHJvbWlzZShwKSB7CiAgICAgICAgLy8gVE9ETzogTmVlZCB0byBmaW5kIGEgd2F5IGZvciBwcm9taXNlcyByZXR1cm5lZCBieSAudGhlbigpCiAgICAgICAgLy8gdG8gYWxzbyBiZSBkZWJ1ZyBwcm9taXNlcy4KICAgICAgICBwLnRoZW4oCiAgICAgICAgICAgIHVuZGVmLAogICAgICAgICAgICBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgIGlmKHAuaWQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKHAudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tvYmplY3QgUHJvbWlzZV0gUkVKRUNURUQ6JywgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICk7CgogICAgICAgIHJldHVybiBwOwogICAgfQoKICAgIGZ1bmN0aW9uIHdyYXBDYWxsYmFjayhjYikgewogICAgICAgIGlmKHR5cGVvZiBjYiAhPSAnZnVuY3Rpb24nKSByZXR1cm4gY2I7CgogICAgICAgIHJldHVybiBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2Iodik7CiAgICAgICAgICAgIH0gY2F0Y2goZXJyKSB7CiAgICAgICAgICAgICAgICBpZihlcnIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZXJyLm5hbWUgaW4gZXhjZXB0aW9uc1RvUmV0aHJvdykgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVyci5zdGFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVyci5zdGFjayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEhlbHBlciB0byBmb3JtIGRlYnVnIHN0cmluZyBmb3IgcHJvbWlzZXMgZGVwZW5kaW5nIG9uIHRoZWlyCiAgICAgKiBjdXJyZW50IHN0YXRlCiAgICAgKiBAcGFyYW0gbmFtZQogICAgICogQHBhcmFtIGlkCiAgICAgKiBAcGFyYW0gc3RhdHVzCiAgICAgKiBAcGFyYW0gdmFsdWUKICAgICAqLwogICAgZnVuY3Rpb24gdG9TdHJpbmcobmFtZSwgaWQsIHN0YXR1cywgdmFsdWUpIHsKICAgICAgICB2YXIgcyA9ICdbb2JqZWN0ICcgKyBuYW1lICsgJyAnICsgaWQgKyAnXSAnICsgc3RhdHVzOwogICAgICAgIGlmKHZhbHVlICE9PSBwZW5kaW5nKSBzICs9ICc6ICcgKyB2YWx1ZTsKICAgICAgICByZXR1cm4gczsKICAgIH0KCiAgICBmdW5jdGlvbiBGKCkge30KICAgIGZ1bmN0aW9uIGJlZ2V0KG8pIHsKICAgICAgICBGLnByb3RvdHlwZSA9IG87CiAgICAgICAgbyA9IG5ldyBGKCk7CiAgICAgICAgRi5wcm90b3R5cGUgPSB1bmRlZjsKCiAgICAgICAgcmV0dXJuIG87CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXBsYWNlbWVudCBmb3Igd2hlbigpIHRoYXQgc2V0cyB1cCBkZWJ1ZyBsb2dnaW5nIG9uIHRoZQogICAgICogcmV0dXJuZWQgcHJvbWlzZS4KICAgICAqLwogICAgZnVuY3Rpb24gd2hlbkRlYnVnKCkgewogICAgICAgIHJldHVybiBkZWJ1Z1Byb21pc2Uod2hlbi5hcHBseShudWxsLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlcGxhY2VtZW50IGZvciB3aGVuLmRlZmVyKCkgdGhhdCBzZXRzIHVwIGRlYnVnIGxvZ2dpbmcKICAgICAqIG9uIHRoZSBjcmVhdGVkIERlZmVycmVkLCBpdHMgcmVzb2x2ZXIsIGFuZCBpdHMgcHJvbWlzZS4KICAgICAqIEBwYXJhbSBbaWRdIGFueXRoaW5nIG9wdGlvbmFsIGlkZW50aWZpZXIgZm9yIHRoaXMgRGVmZXJyZWQgdGhhdCB3aWxsIHNob3cKICAgICAqIHVwIGluIGRlYnVnIG91dHB1dAogICAgICogQHJldHVybiB7RGVmZXJyZWR9IGEgRGVmZXJyZWQgd2l0aCBkZWJ1ZyBsb2dnaW5nCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRlZmVyRGVidWcoKSB7CiAgICAgICAgdmFyIGQsIHN0YXR1cywgdmFsdWUsIG9yaWdSZXNvbHZlLCBvcmlnUmVqZWN0LCBvcmlnVGhlbiwgaWQ7CgogICAgICAgIC8vIERlbGVnYXRlIHRvIGNyZWF0ZSBhIERlZmVycmVkOwogICAgICAgIGQgPSB3aGVuLmRlZmVyKCk7CgogICAgICAgIHN0YXR1cyA9ICdwZW5kaW5nJzsKICAgICAgICB2YWx1ZSA9IHBlbmRpbmc7CgogICAgICAgIC8vIGlmIG5vIGlkIHByb3ZpZGVkLCBnZW5lcmF0ZSBvbmUuICBOb3Qgc3VyZSBpZiB0aGlzIGlzCiAgICAgICAgLy8gdXNlZnVsIG9yIG5vdC4KICAgICAgICBpZCA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoIC0gMV07CiAgICAgICAgaWYoaWQgPT09IHVuZGVmKSBpZCA9ICsrcHJvbWlzZUlkOwoKICAgICAgICAvLyBQcm9taXNlIGFuZCByZXNvbHZlciBhcmUgZnJvemVuLCBzbyBoYXZlIHRvIGRlbGVnYXRlCiAgICAgICAgLy8gaW4gb3JkZXIgdG8gc2V0dXAgdG9TdHJpbmcoKSBvbiBwcm9taXNlLCByZXNvbHZlciwKICAgICAgICAvLyBhbmQgZGVmZXJyZWQKICAgICAgICBkLnByb21pc2UgPSBiZWdldChkLnByb21pc2UpOwogICAgICAgIGQucHJvbWlzZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdG9TdHJpbmcoJ1Byb21pc2UnLCBpZCwgc3RhdHVzLCB2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgZC5yZXNvbHZlciA9IGJlZ2V0KGQucmVzb2x2ZXIpOwogICAgICAgIGQucmVzb2x2ZXIudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRvU3RyaW5nKCdSZXNvbHZlcicsIGlkLCBzdGF0dXMsIHZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBvcmlnUmVzb2x2ZSA9IGQucmVzb2x2ZXIucmVzb2x2ZTsKICAgICAgICBkLnJlc29sdmUgPSBkLnJlc29sdmVyLnJlc29sdmUgPSBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgdmFsdWUgPSB2YWw7CiAgICAgICAgICAgIHN0YXR1cyA9ICdyZXNvbHZpbmcnOwovLyAgICAgICAgICAgIGNvbnNvbGUubG9nKGQucmVzb2x2ZXIudG9TdHJpbmcoKSk7CiAgICAgICAgICAgIHJldHVybiBvcmlnUmVzb2x2ZS5hcHBseSh1bmRlZiwgYXJndW1lbnRzKTsKICAgICAgICB9OwoKICAgICAgICBvcmlnUmVqZWN0ID0gZC5yZXNvbHZlci5yZWplY3Q7CiAgICAgICAgZC5yZWplY3QgPSBkLnJlc29sdmVyLnJlamVjdCA9IGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICB2YWx1ZSA9IGVycjsKICAgICAgICAgICAgc3RhdHVzID0gJ1JFSkVDVElORyc7Ci8vICAgICAgICAgICAgY29uc29sZS5lcnJvcihkLnJlc29sdmVyLnRvU3RyaW5nKCkpOwogICAgICAgICAgICByZXR1cm4gb3JpZ1JlamVjdC5hcHBseSh1bmRlZiwgYXJndW1lbnRzKTsKICAgICAgICB9OwoKICAgICAgICBkLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0b1N0cmluZygnRGVmZXJyZWQnLCBpZCwgc3RhdHVzLCB2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gU2V0dXAgZmluYWwgc3RhdGUgY2hhbmdlIGhhbmRsZXJzCiAgICAgICAgZC50aGVuKAogICAgICAgICAgICBmdW5jdGlvbih2KSB7IHN0YXR1cyA9ICdyZXNvbHZlZCc7IHJldHVybiB2OyB9LAogICAgICAgICAgICBmdW5jdGlvbihlKSB7IHN0YXR1cyA9ICdSRUpFQ1RFRCc7IHRocm93IGU7IH0KICAgICAgICApOwoKICAgICAgICAvLyBFeHBlcmltZW50aW5nIHdpdGggc2V0dGluZyB1cCB3YXlzIHRvIGFsc28gZGVidWcgcHJvbWlzZXMgcmV0dXJuZWQKICAgICAgICAvLyBieSAudGhlbigpLiAgQWxzbyBuZWVkIHRvIGZpbmQgYSB3YXkgdG8gZXh0ZW5kIHRoZSBpZCBpbiBhIHdheSB0aGF0CiAgICAgICAgLy8gbWFrZXMgaXQgb2J2aW91cyB0aGUgcmV0dXJuZWQgcHJvbWlzZSBpcyBOT1QgdGhlIG9yaWdpbmFsLCBidXQgaXMKICAgICAgICAvLyByZWxhdGVkIHRvIGl0LS1pdCdzIGRvd25zdHJlYW0gaW4gdGhlIHByb21pc2UgY2hhaW4uCiAgICAgICAgb3JpZ1RoZW4gPSBkLnByb21pc2UudGhlbjsKICAgICAgICBkLnRoZW4gPSBkLnByb21pc2UudGhlbiA9IGZ1bmN0aW9uKGNiLCBlYiwgcGIpIHsKICAgICAgICAgICAgdmFyIGFyZ3MsIHAsIGlkOwoKICAgICAgICAgICAgaWQgPSBkLmlkICsgJysnOwoKICAgICAgICAgICAgYXJncyA9IFtdOwoKICAgICAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+IDApIGFyZ3NbMF0gPSB3cmFwQ2FsbGJhY2soY2IsIGlkKTsKICAgICAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+IDEpIGFyZ3NbMV0gPSB3cmFwQ2FsbGJhY2soZWIsIGlkKTsKICAgICAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+IDIpIGFyZ3NbMl0gPSB3cmFwQ2FsbGJhY2socGIsIGlkKTsKCiAgICAgICAgICAgIHZhciBwID0gb3JpZ1RoZW4uYXBwbHkobnVsbCwgYXJncyk7CgogICAgICAgICAgICBwLmlkID0gaWQ7CiAgICAgICAgICAgIHAgPSBiZWdldChwKTsKICAgICAgICAgICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRvU3RyaW5nKCdQcm9taXNlJywgcC5pZCwgc3RhdHVzLCB2YWx1ZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZWUgYmVsb3cuIE5vdCBzdXJlIGlmIGRlYnVnIHByb21pc2VzIHNob3VsZCBiZSBmcm96ZW4KICAgICAgICAgICAgcmV0dXJuIGZyZWV6ZShwKTsKICAgICAgICB9OwoKICAgICAgICAvLyBBZGQgYW4gaWQgdG8gYWxsIGRpcmVjdGx5IGNyZWF0ZWQgcHJvbWlzZXMuICBJdCdkIGJlIGdyZWF0CiAgICAgICAgLy8gdG8gZmluZCBhIHdheSB0byBwcm9wYWdhdGUgdGhpcyBpZCB0byBwcm9taXNlIGNyZWF0ZWQgYnkgLnRoZW4oKQogICAgICAgIGQuaWQgPSBkLnByb21pc2UuaWQgPSBkLnJlc29sdmVyLmlkID0gaWQ7CgogICAgICAgIC8vIEF0dGFjaCBkZWJ1ZyBoYW5kbGVycyBhZnRlciB0aGUgc3Vic3RpdHV0ZSBwcm9taXNlCiAgICAgICAgLy8gaGFzIGJlZW4gc2V0dXAsIHNvIHRoZSBpZCBjYW4gYmUgbG9nZ2VkLgogICAgICAgIGRlYnVnUHJvbWlzZShkLnByb21pc2UpOwoKICAgICAgICAvLyBUT0RPOiBTaG91bGQgd2Ugc3RpbGwgZnJlZXplIHRoZXNlPwogICAgICAgIC8vIFNlZW1zIHNhZmVyIGZvciBub3cgdG8gZXJyIG9uIHRoZSBzaWRlIG9mIGNhdXRpb24gYW5kIGZyZWV6ZSB0aGVtLAogICAgICAgIC8vIGJ1dCBpdCBjb3VsZCBiZSB1c2VmdWwgdG8gYWxsIHRoZW0gdG8gYmUgbW9kaWZpZWQgZHVyaW5nIGRlYnVnZ2luZy4KICAgICAgICBmcmVlemUoZC5wcm9taXNlKTsKICAgICAgICBmcmVlemUoZC5yZXNvbHZlcik7CgogICAgICAgIHJldHVybiBkOwogICAgfQoKICAgIHdoZW5EZWJ1Zy5kZWZlciA9IGRlZmVyRGVidWc7CiAgICB3aGVuRGVidWcuaXNQcm9taXNlID0gd2hlbi5pc1Byb21pc2U7CgogICAgLy8gRm9yIGVhY2ggbWV0aG9kIHdlIGhhdmVuJ3QgYWxyZWFkeSByZXBsYWNlZCwgcmVwbGFjZSBpdCB3aXRoCiAgICAvLyBvbmUgdGhhdCBzZXRzIHVwIGRlYnVnIGxvZ2dpbmcgb24gdGhlIHJldHVybmVkIHByb21pc2UKICAgIGZvcih2YXIgcCBpbiB3aGVuKSB7CiAgICAgICAgaWYod2hlbi5oYXNPd25Qcm9wZXJ0eShwKSAmJiAhKHAgaW4gd2hlbkRlYnVnKSkgewogICAgICAgICAgICAoZnVuY3Rpb24ocCwgb3JpZykgewogICAgICAgICAgICAgICAgd2hlbkRlYnVnW3BdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlYnVnUHJvbWlzZShvcmlnLmFwcGx5KHdoZW4sIGFyZ3VtZW50cykpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSkocCwgd2hlbltwXSk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB3aGVuRGVidWc7Cgp9KTsKfSkodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nCiAgICA/IGRlZmluZQogICAgOiBmdW5jdGlvbiAoZGVwcywgZmFjdG9yeSkgeyB0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnCiAgICAgICAgPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJy4vd2hlbicpKSkKICAgICAgICA6ICh0aGlzLndoZW4gICAgICA9IGZhY3RvcnkodGhpcy53aGVuKSk7CiAgICB9CiAgICAvLyBCb2lsZXJwbGF0ZSBmb3IgQU1ELCBOb2RlLCBhbmQgYnJvd3NlciBnbG9iYWwKKTsKCi8qKiBAbGljZW5zZSBNSVQgTGljZW5zZSAoYykgY29weXJpZ2h0IEIgQ2F2YWxpZXIgJiBKIEhhbm4gKi8KCi8qKgogKiBhcHBseS5qcwogKiBIZWxwZXIgZm9yIHVzaW5nIGFyZ3VtZW50cy1iYXNlZCBhbmQgdmFyaWFkaWMgY2FsbGJhY2tzIHdpdGggYW55CiAqIHtAbGluayBQcm9taXNlfSB0aGF0IHJlc29sdmVzIHRvIGFuIGFycmF5LgogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL2FwcGx5JyxbXSxmdW5jdGlvbigpIHsKCiAgICB2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogICAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYSBmdW5jdGlvbiB0aGF0IHRha2VzIGluZGl2aWR1YWwKICAgICAqIGFyZ3VtZW50cyAoaXQgY2FuIGJlIHZhcmlhZGljLCB0b28pLCBhbmQgcmV0dXJucyBhIG5ldyBmdW5jdGlvbiB0aGF0CiAgICAgKiB0YWtlcyBhIHNpbmdsZSBhcnJheSBhcyBpdHMgb25seSBwYXJhbToKICAgICAqCiAgICAgKiBmdW5jdGlvbiBhcmdCYXNlZChhLCBiLCBjKSB7CiAgICAgKiAgIHJldHVybiBhICsgYiArIGM7CiAgICAgKiB9CiAgICAgKgogICAgICogYXJnQmFzZWQoMSwgMiwgMyk7IC8vIDYKICAgICAqCiAgICAgKiAvLyBDcmVhdGUgYW4gYXJyYXktYmFzZWQgdmVyc2lvbiBvZiBhcmdCYXNlZAogICAgICogdmFyIGFycmF5QmFzZWQgPSBhcHBseShhcmdCYXNlZCk7CiAgICAgKiB2YXIgaW5wdXRzID0gWzEsIDIsIDNdOwogICAgICoKICAgICAqIGFycmF5QmFzZWQoaW5wdXRzKTsgLy8gNgogICAgICoKICAgICAqIFdpdGggcHJvbWlzZXM6CiAgICAgKgogICAgICogdmFyIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgKiBkLnByb21pc2UudGhlbihhcnJheUJhc2VkKTsKICAgICAqCiAgICAgKiBkLnJlc29sdmUoWzEsIDIsIDNdKTsgLy8gYXJyYXlCYXNlZCBjYWxsZWQgd2l0aCBhcmdzIDEsIDIsIDMgLT4gNgogICAgICoKICAgICAqIEBwYXJhbSBmIHtGdW5jdGlvbn0gYXJndW1lbnRzLWJhc2VkIGZ1bmN0aW9uCiAgICAgKgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBhIG5ldyBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYW4gYXJyYXkKICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uKGYpIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0gYXJyYXkge0FycmF5fSBtdXN0IGJlIGFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byB1c2UgdG8gYXBwbHkgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB0aGUgcmVzdWx0IG9mIGFwcGx5aW5nIGYgd2l0aCB0aGUgYXJndW1lbnRzIGluIGFycmF5LgogICAgICAgICAqLwogICAgICAgIHJldHVybiBmdW5jdGlvbihhcnJheSkgewogICAgICAgICAgICAvLyBJdCBiZXR0ZXIgYmUgYW4gYXJyYXkKICAgICAgICAgICAgaWYodG9TdHJpbmcuY2FsbChhcnJheSkgIT0gJ1tvYmplY3QgQXJyYXldJykgdGhyb3cgbmV3IEVycm9yKCdhcHBseSBjYWxsZWQgd2l0aCBub24tYXJyYXkgYXJnJyk7CgogICAgICAgICAgICByZXR1cm4gZi5hcHBseShudWxsLCBhcnJheSk7CiAgICAgICAgfQogICAgfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKICAgID8gZGVmaW5lCiAgICA6IGZ1bmN0aW9uIChmYWN0b3J5KSB7IHR5cGVvZiBtb2R1bGUgIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IChtb2R1bGUuZXhwb3J0cyAgPSBmYWN0b3J5KCkpCiAgICAgICAgOiAodGhpcy53aGVuX2FwcGx5ID0gZmFjdG9yeSgpKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogZGVsYXkuanMKICoKICogSGVscGVyIHRoYXQgcmV0dXJucyBhIHByb21pc2UgdGhhdCByZXNvbHZlcyBhZnRlciBhIGRlbGF5LgogKgogKiBAYXV0aG9yIGJyaWFuQGhvdmVyY3JhZnRzdHVkaW9zLmNvbQogKi8KCihmdW5jdGlvbihkZWZpbmUpIHsKZGVmaW5lKCd3aGVuL2RlbGF5JyxbJy4vd2hlbiddLCBmdW5jdGlvbih3aGVuKSB7CgogICAgdmFyIHVuZGVmOwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIGFmdGVyIGEgbXNlYyBkZWxheS4gIElmIHByb21pc2UKICAgICAqIGlzIHN1cHBsaWVkLCB0aGUgZGVsYXkgd2lsbCBzdGFydCAqYWZ0ZXIqIHRoZSBzdXBwbGllZCBwcm9taXNlIGlzIHJlc29sdmVkLgogICAgICoKICAgICAqIFVzYWdlOgogICAgICogLy8gRG8gc29tZXRoaW5nIGFmdGVyIDEgc2Vjb25kLCBzaW1pbGFyIHRvIHVzaW5nIHNldFRpbWVvdXQKICAgICAqIGRlbGF5KDEwMDApLnRoZW4oZG9Tb21ldGhpbmcpOwogICAgICogLy8gb3IKICAgICAqIHdoZW4oZGVsYXkoMTAwMCksIGRvU29tZXRoaW5nKTsKICAgICAqCiAgICAgKiAvLyBEbyBzb21ldGhpbmcgMSBzZWNvbmQgYWZ0ZXIgdHJpZ2dlcmluZ1Byb21pc2UgcmVzb2x2ZXMKICAgICAqIGRlbGF5KHRyaWdnZXJpbmdQcm9taXNlLCAxMDAwKS50aGVuKGRvU29tZXRoaW5nLCBoYW5kbGVSZWplY3Rpb24pOwogICAgICogLy8gb3IKICAgICAqIHdoZW4oZGVsYXkodHJpZ2dlcmluZ1Byb21pc2UsIDEwMDApLCBkb1NvbWV0aGluZywgaGFuZGxlUmVqZWN0aW9uKTsKICAgICAqCiAgICAgKiBAcGFyYW0gW3Byb21pc2VdIGFueXRoaW5nIC0gYW55IHByb21pc2Ugb3IgdmFsdWUgYWZ0ZXIgd2hpY2ggdGhlIGRlbGF5IHdpbGwgc3RhcnQKICAgICAqIEBwYXJhbSBtc2VjIHtOdW1iZXJ9IGRlbGF5IGluIG1pbGxpc2Vjb25kcwogICAgICovCiAgICByZXR1cm4gZnVuY3Rpb24gZGVsYXkocHJvbWlzZSwgbXNlYykgewogICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgIG1zZWMgPSBwcm9taXNlID4+PiAwOwogICAgICAgICAgICBwcm9taXNlID0gdW5kZWY7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gd2hlbihwcm9taXNlLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh2YWwpOwogICAgICAgICAgICB9LCBtc2VjKTsKICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICAgICAgfSk7CiAgICB9OwoKfSk7Cn0pKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJwogICAgPyBkZWZpbmUKICAgIDogZnVuY3Rpb24gKGRlcHMsIGZhY3RvcnkpIHsgdHlwZW9mIG1vZHVsZSAhPSAndW5kZWZpbmVkJwogICAgICAgID8gKG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCcuL3doZW4nKSkpCiAgICAgICAgOiAodGhpcy53aGVuX2RlbGF5ID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogdGltZW91dC5qcwogKgogKiBIZWxwZXIgdGhhdCByZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHJlamVjdHMgYWZ0ZXIgYSBzcGVjaWZpZWQgdGltZW91dCwKICogaWYgbm90IGV4cGxpY2l0bHkgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQgYmVmb3JlIHRoYXQuCiAqCiAqIEBhdXRob3IgYnJpYW5AaG92ZXJjcmFmdHN0dWRpb3MuY29tCiAqLwoKKGZ1bmN0aW9uKGRlZmluZSkgewpkZWZpbmUoJ3doZW4vdGltZW91dCcsWycuL3doZW4nXSwgZnVuY3Rpb24od2hlbikgewoKICAgIHZhciB1bmRlZjsKCiAgICAvKioKICAgICAqIFJldHVybnMgYSBuZXcgcHJvbWlzZSB0aGF0IHdpbGwgYXV0b21hdGljYWxseSByZWplY3QgYWZ0ZXIgbXNlYyBpZgogICAgICogdGhlIHN1cHBsaWVkIHByb21pc2UgZG9lc24ndCByZXNvbHZlIG9yIHJlamVjdCBiZWZvcmUgdGhhdC4KICAgICAqCiAgICAgKiBVc2FnZToKICAgICAqCiAgICAgKiB2YXIgZCA9IHdoZW4uZGVmZXIoKTsKICAgICAqIC8vIFNldHVwIGQgaG93ZXZlciB5b3UgbmVlZAogICAgICoKICAgICAqIC8vIHJldHVybiBhIG5ldyBwcm9taXNlIHRoYXQgd2lsbCB0aW1lb3V0IGlmIHdlIGRvbid0IHJlc29sdmUvcmVqZWN0IGZpcnN0CiAgICAgKiByZXR1cm4gdGltZW91dChkLCAxMDAwKTsKICAgICAqCiAgICAgKiBAcGFyYW0gcHJvbWlzZSBhbnl0aGluZyAtIGFueSBwcm9taXNlIG9yIHZhbHVlIHRoYXQgc2hvdWxkIHRyaWdnZXIKICAgICAqICB0aGUgcmV0dXJuZWQgcHJvbWlzZSB0byByZXNvbHZlIG9yIHJlamVjdCBiZWZvcmUgdGhlIG1zZWMgdGltZW91dAogICAgICogQHBhcmFtIG1zZWMge051bWJlcn0gdGltZW91dCBpbiBtaWxsaXNlY29uZHMKICAgICAqCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0KICAgICAqLwogICAgcmV0dXJuIGZ1bmN0aW9uIHRpbWVvdXQocHJvbWlzZSwgbXNlYykgewogICAgICAgIHZhciBkZWZlcnJlZCwgdGltZW91dDsKCiAgICAgICAgZGVmZXJyZWQgPSB3aGVuLmRlZmVyKCk7CgogICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uIG9uVGltZW91dCgpIHsKICAgICAgICAgICAgdGltZW91dCAmJiBkZWZlcnJlZC5yZWplY3QobmV3IEVycm9yKCd0aW1lZCBvdXQnKSk7CiAgICAgICAgfSwgbXNlYyk7CgogICAgICAgIGZ1bmN0aW9uIGNhbmNlbFRpbWVvdXQoKSB7CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgdGltZW91dCA9IHVuZGVmOwogICAgICAgIH0KCiAgICAgICAgd2hlbihwcm9taXNlLCBkZWZlcnJlZC5yZXNvbHZlLCBkZWZlcnJlZC5yZWplY3QpOwoKICAgICAgICByZXR1cm4gZGVmZXJyZWQudGhlbigKICAgICAgICAgICAgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGNhbmNlbFRpbWVvdXQoKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICAgICAgICBjYW5jZWxUaW1lb3V0KCk7CiAgICAgICAgICAgICAgICB0aHJvdyByZWFzb247CiAgICAgICAgICAgIH0KICAgICAgICApOwogICAgfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKICAgID8gZGVmaW5lCiAgICA6IGZ1bmN0aW9uIChkZXBzLCBmYWN0b3J5KSB7IHR5cGVvZiBtb2R1bGUgIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IChtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnLi93aGVuJykpKQogICAgICAgIDogKHRoaXMud2hlbl90aW1lb3V0ID0gZmFjdG9yeSh0aGlzLndoZW4pKTsKICAgIH0KICAgIC8vIEJvaWxlcnBsYXRlIGZvciBBTUQsIE5vZGUsIGFuZCBicm93c2VyIGdsb2JhbAopOwoKCgpkZWZpbmUoJ3RocnVzdC91dGlsL3doZW4nLFsnd2hlbi9kZWJ1ZycsICd3aGVuL2FwcGx5JywgJ3doZW4vZGVsYXknLCAnd2hlbi90aW1lb3V0JywgJ3RocnVzdC91dGlsL2FycmF5J10sCmZ1bmN0aW9uICh3aGVuLCBhcHBseSwgZGVsYXksIHRpbWVvdXQsIHV0aWwpCnsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QtdXRpbC13aGVuCiAgICAqKi8KCiAgICAvKioKICAgIHdoZW4uYXBwbHksIHVzZWQgdG8gYXBwbHkgd2hlbiByZXN1bHRzIG92ZXIgYSBmdW5jdGlvbiwgc2ltaWxhciB0byBqUXVlcnlzIERlZmVycmVkLgogICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1hcHBseV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1hcHBseSkKCiAgICBAZm9yIHRocnVzdC11dGlsLXdoZW4KICAgIEBtZXRob2Qgd2hlbi5hcHBseQogICAgKiovCiAgICB3aGVuLmFwcGx5ID0gYXBwbHksCiAgICAvKioKICAgIHdoZW4uZGVsYXksIGNyZWF0ZXMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgaW4geCBtcywgdXNpbmcgc2V0VGltZW91dC4KICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tZGVsYXldKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tZGVsYXkpCgogICAgQG1ldGhvZCB3aGVuLmRlbGF5CiAgICAqKi8KICAgIHdoZW4uZGVsYXkgPSBkZWxheTsKICAgIC8qKgogICAgd2hlbi50aW1lb3V0LCBjcmVhdGVzIGEgcHJvbWlzZSB0aGF0IHdpbGwgdGltZW91dCBpZiB4IG1zIGlmIG5vdCByZXNvbHZlZC4KICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tdGltZW91dF0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi10aW1lb3V0KQoKICAgIEBtZXRob2Qgd2hlbi50aW1lb3V0CiAgICAqKi8KICAgIHdoZW4udGltZW91dCA9IHRpbWVvdXQ7CgogICAgcmV0dXJuIHsKICAgICAgICAvKioKICAgICAgICBBY2Nlc3MgdG8gd2hlbmpzLCB0aGUgbWFpbiBsaWJyYXJ5IGZvciBwcm9taXNlcy4KCiAgICAgICAgQG1ldGhvZCB3aGVuCiAgICAgICAgKiovCiAgICAgICAgd2hlbjogd2hlbiwKICAgICAgICAvKioKICAgICAgICBGbGF0dGVuIGFuZCBmaWx0ZXIgYXJyYXlzIGRvd24gdG8ganVzdCB0aGUgZXhpc3RpbmcgcHJvbWlzZXMuCgogICAgICAgIEBtZXRob2QgZmxhdHRlblRvUHJvbWlzZXMgCiAgICAgICAgQHBhcmFtIHtBcnJheX0gQXJyYXkgdG8gZmxhdHRlbiwgYW5kIGZpbHRlci4KICAgICAgICBAcmV0dXJucyB7QXJyYXkgb2YgUHJvbWlzZXN9IAogICAgICAgICoqLwogICAgICAgIGZsYXR0ZW5Ub1Byb21pc2VzOiBmdW5jdGlvbiAoYXJyYXkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdXRpbC5mbGF0dGVuKGFycmF5KS5maWx0ZXIoZnVuY3Rpb24gKHgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmlzUHJvbWlzZSh4KTsKICAgICAgICAgICAgfSkKICAgICAgICB9CiAgICB9Owp9KTsKLyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IGxpYiB2MS43LjIKICogaHR0cDovL2pxdWVyeS5jb20vCiAqCiAqIENvcHlyaWdodCAyMDExLCBKb2huIFJlc2lnCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIEluY2x1ZGVzIFNpenpsZS5qcwogKiBodHRwOi8vc2l6emxlanMuY29tLwogKiBDb3B5cmlnaHQgMjAxMSwgVGhlIERvam8gRm91bmRhdGlvbgogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlULCBCU0QsIGFuZCBHUEwgTGljZW5zZXMuCiAqCiAqIERhdGU6IFdlZCBNYXIgMjEgMTI6NDY6MzQgMjAxMiAtMDcwMAogKi8KZGVmaW5lKCd0aHJ1c3QvdXRpbC9saWIvZXh0ZW5kJyxbJ3RocnVzdC91dGlsL2NvbGxlY3Rpb24nLCAndGhydXN0L3V0aWwvdHlwZSddLApmdW5jdGlvbiAodUNvbGxlY3Rpb24sIHVUeXBlKQp7CiAgICAKICAgIHZhciBleHRlbmQgPSBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHZhciBvcHRpb25zLCBuYW1lLCBzcmMsIGNvcHksIGNvcHlJc0FycmF5LCBjbG9uZSwKICAgICAgICAgICAgdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LAogICAgICAgICAgICBpICAgICAgPSAxLAogICAgICAgICAgICBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgICAgICBkZWVwICAgPSBmYWxzZTsKCiAgICAgICAgLy8gSGFuZGxlIGEgZGVlcCBjb3B5IHNpdHVhdGlvbgogICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIpCiAgICAgICAgewogICAgICAgICAgICBkZWVwID0gdGFyZ2V0OwogICAgICAgICAgICB0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CiAgICAgICAgICAgIC8vIHNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKICAgICAgICAgICAgaSA9IDI7CiAgICAgICAgfQoKICAgICAgICAvLyBIYW5kbGUgY2FzZSB3aGVuIHRhcmdldCBpcyBhIHN0cmluZyBvciBzb21ldGhpbmcgKHBvc3NpYmxlIGluIGRlZXAgY29weSkKICAgICAgICBpZiAodHlwZW9mIHRhcmdldCAhPT0gIm9iamVjdCIgJiYgIXVUeXBlLmlzRnVuY3Rpb24odGFyZ2V0KSkKICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldCA9IHt9OwogICAgICAgIH0KCiAgICAgICAgLy8gZXh0ZW5kIGpRdWVyeSBpdHNlbGYgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCiAgICAgICAgaWYgKGxlbmd0aCA9PT0gaSkKICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldCA9IHRoaXM7CiAgICAgICAgICAgIC0taTsKICAgICAgICB9CgogICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICAvLyBPbmx5IGRlYWwgd2l0aCBub24tbnVsbC91bmRlZmluZWQgdmFsdWVzCiAgICAgICAgICAgIGlmICgob3B0aW9ucyA9IGFyZ3VtZW50c1tpXSkgIT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gRXh0ZW5kIHRoZSBiYXNlIG9iamVjdAogICAgICAgICAgICAgICAgZm9yIChuYW1lIGluIG9wdGlvbnMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc3JjID0gdGFyZ2V0W25hbWVdOwogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBvcHRpb25zW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldCA9PT0gY29weSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gUmVjdXJzZSBpZiB3ZSdyZSBtZXJnaW5nIHBsYWluIG9iamVjdHMgb3IgYXJyYXlzCiAgICAgICAgICAgICAgICAgICAgaWYgKGRlZXAgJiYgY29weSAmJiAodVR5cGUuaXNPYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0gdVR5cGUuaXNBcnJheShjb3B5KSkpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvcHlJc0FycmF5KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3B5SXNBcnJheSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmUgPSBzcmMgJiYgdVR5cGUuaXNBcnJheShzcmMpID8gc3JjIDogW107CgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmUgPSBzcmMgJiYgdVR5cGUuaXNPYmplY3Qoc3JjKSA/IHNyYyA6IHt9OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBOZXZlciBtb3ZlIG9yaWdpbmFsIG9iamVjdHMsIGNsb25lIHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W25hbWVdID0gZXh0ZW5kKGRlZXAsIGNsb25lLCBjb3B5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvcHkgIT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IGNvcHk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9OwogICAgcmV0dXJuIHsKICAgICAgICBhbHRFeHRlbmQ6IGV4dGVuZCwKICAgICAgICBkZWVwQ29weTogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZC5hcHBseShudWxsLCBbdHJ1ZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICB9CiAgICB9Owp9KTsKZGVmaW5lKCd0aHJ1c3QvdXRpbC9saWIvY2FtZWxjYXNlJyxbXSxmdW5jdGlvbigpCnsKICAgIAogICAgLy8vIDxzdW1tYXJ5PgogICAgLy8vIEltcG9ydCBqUXVlcnlzIGNhbWVsY2FzZSBtZXRob2QuCiAgICAvLy8gPC9zdW1tYXJ5PgogICAgLy8vIDxyZXR1cm5zPjwvcmV0dXJucz4KICAgIHZhciBybXNQcmVmaXggID0gL14tbXMtLywKICAgICAgICByZGFzaEFscGhhID0gLy0oW1xkYS16XSkvZ2ksCiAgICAgICAgZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uIChhbGwsIGxldHRlcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAobGV0dGVyICsgIiIpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgfTsKCiAgICB2YXIgZXhwb3J0cyA9IHsKICAgICAgICBjYW1lbENhc2U6IGZ1bmN0aW9uIChzdHJpbmcpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2Uocm1zUHJlZml4LCAibXMtIikucmVwbGFjZShyZGFzaEFscGhhLCBmY2FtZWxDYXNlKTsKICAgICAgICB9LAogICAgICAgIHVuQ2FtZWxDYXNlOiBmdW5jdGlvbiAoc3RyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8oW0EtWl0pL2csIGZ1bmN0aW9uIChhbGwsIHMpIHsgcmV0dXJuICctJyArIHMudG9Mb3dlckNhc2UoKTsgfSk7CiAgICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gZXhwb3J0czsKfSk7CmRlZmluZSgndGhydXN0L3V0aWwvbWFpbicsWwogICAgJ2xvZGFzaCcsCiAgICAvLyNyZWdpb24gT3VyIE1ldGhvZHMKICAgICcuL2FycmF5JywKICAgICcuL2NvbGxlY3Rpb24nLAogICAgJy4vZnVuY3Rpb24nLAogICAgJy4vb2JqZWN0JywKICAgICcuL3R5cGUnLAogICAgJy4vZ3VpZCcsCiAgICAnLi91cmwnLAogICAgJy4vc3RyaW5nJywKICAgICcuL3doZW4nLAogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gVGhpcmQgUGFydHkgTWV0aG9kcwogICAgJy4vbGliL2V4dGVuZCcsCiAgICAnLi9saWIvY2FtZWxjYXNlJwogICAgLy8jZW5kcmVnaW9uCl0sCmZ1bmN0aW9uIChfLCB1QXJyYXksIHVDb2xsZWN0aW9uLCB1RnVuY3Rpb24sIHVPYmplY3QsIHVUeXBlKQp7CiAgICAKICAgIC8qKgogICAgQGNsYXNzIHRocnVzdC11dGlsCiAgICBAdXNlcyB0aHJ1c3QtdXRpbC1hcnJheQogICAgQHVzZXMgdGhydXN0LXV0aWwtY29sbGVjdGlvbgogICAgQHVzZXMgdGhydXN0LXV0aWwtZnVuYwogICAgQHVzZXMgdGhydXN0LXV0aWwtb2JqCiAgICBAdXNlcyB0aHJ1c3QtdXRpbC10eXBlCiAgICBAdXNlcyB0aHJ1c3QtdXRpbC11cmwKICAgIEB1c2VzIHRocnVzdC11dGlsLXdoZW4KICAgICoqLwoKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIC8vIEJyaW5nIGV2ZXJ5dGhpbmcgdG9nZXRoZXIuCiAgICB2YXIgZXhwb3J0cyA9IHVDb2xsZWN0aW9uLmV4dGVuZC5hcHBseSh7CiAgICAgICAgLyoqCiAgICAgICAgUmVmZXJlbmNlIHRvIGxvZGFzaAogICAgICAgIEBwcm9wZXJ0eSBfCiAgICAgICAgQHR5cGUge199CiAgICAgICAgKiovCiAgICAgICAgXzogXywKICAgICAgICAvKioKICAgICAgICBSZWZlcmVuY2UgdG8gYXJyYXkgbWV0aG9kcwogICAgICAgIEBwcm9wZXJ0eSBhcnJheQogICAgICAgIEB0eXBlIHtPYmplY3R9CiAgICAgICAgKiovCiAgICAgICAgYXJyYXk6IHVBcnJheSwKICAgICAgICAvKioKICAgICAgICBSZWZlcmVuY2UgdG8gY29sbGVjdGlvbiBtZXRob2RzCiAgICAgICAgQHByb3BlcnR5IGNvbGxlY3Rpb24KICAgICAgICBAdHlwZSB7T2JqZWN0fQogICAgICAgICoqLwogICAgICAgIGNvbGxlY3Rpb246IHVDb2xsZWN0aW9uLAogICAgICAgIC8qKgogICAgICAgIFJlZmVyZW5jZSB0byBmdW5jdGlvbiBtZXRob2RzCiAgICAgICAgQHByb3BlcnR5IGZ1bmN0aW9uCiAgICAgICAgQHR5cGUge09iamVjdH0KICAgICAgICAqKi8KICAgICAgICBmdW5jOiB1RnVuY3Rpb24sCiAgICAgICAgLyoqCiAgICAgICAgUmVmZXJlbmNlIHRvIG9iamVjdCBtZXRob2RzCiAgICAgICAgQHByb3BlcnR5IG9iagogICAgICAgIEB0eXBlIHtPYmplY3R9CiAgICAgICAgKiovCiAgICAgICAgb2JqOiB1T2JqZWN0LAogICAgICAgIC8qKgogICAgICAgIFJlZmVyZW5jZSB0byB0eXBlIG1ldGhvZHMKICAgICAgICBAcHJvcGVydHkgdHlwZQogICAgICAgIEB0eXBlIHtPYmplY3R9CiAgICAgICAgKiovCiAgICAgICAgdHlwZTogdVR5cGUKICAgIH0sIGFyZ3MpOwogICAgcmV0dXJuIGV4cG9ydHM7Cn0pOwpkZWZpbmUoJ3RocnVzdC91dGlsJywgWyd0aHJ1c3QvdXRpbC9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCi8qISBUaHJ1c3QgSlMgRnJhbWV3b3JrIC0gdjAuMS4wIC0gMjAxMi0wOC0yOQoqIHRocnVzdC1ob21lCiogQ29weXJpZ2h0IChjKSAyMDEyIERhdmlkIERyaXNjb2xsOyBMaWNlbnNlZCBNSVQgKi8KCgpkZWZpbmUoJ3RocnVzdC9pbnN0YW5jZScsWyd0aHJ1c3QvdXRpbCddLApmdW5jdGlvbih1dGlsKQp7CiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHJldHVybiB7CiAgICAgICAgLyoqCiAgICAgICAgVGhlIGF2YWlsYWJsZSB0aHJ1c3QgaW5zdGFuY2VzCiAgICAgICAgaW5kZXggYnkgbmFtZQogICAgICAgICoqLwogICAgICAgIGluc3RhbmNlczoge30sCiAgICAgICAgLyoqCiAgICAgICAgVGhlIGxvYWRpbmcgdGh1cnN0IGluc3RhbmNlcy4KICAgICAgICBpbmRleCBieSBuYW1lCiAgICAgICAgKiovCiAgICAgICAgbG9hZGluZ0luc3RhbmNlczoge30sCiAgICAgICAgLyoqCiAgICAgICAgR2V0cyBhIG5hbWVkIHRocnVzdCBzdGFuY2UgaWYgaXQgZXhpc3RzLgogICAgCiAgICAgICAgQG1ldGhvZCBnZXRJbnN0YW5jZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgICAgIEByZXR1cm5zIHtUaHJ1c3R9IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICAqKi8KICAgICAgICBnZXRJbnN0YW5jZTogZnVuY3Rpb24gKG5hbWUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5pbnN0YW5jZXNbbmFtZV0gfHwgZmFsc2U7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBGZXRjaHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgICAgICBUaGlzIGxvYWRzIGFzeW5jcm9ub3VzbHksIGFzIHRoZSBpbnN0YW5jZSBtYXkgbm90IGJlIGxvYWRlZAogICAgCiAgICAgICAgQG1ldGhvZCBfX2ZldGNoSW5zdGFuY2UKICAgICAgICBAc3RhdGljCiAgICAgICAgQHByaXZhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUbyBhIHRocnVzdCBpbnN0YW5jZSBzcGVjCiAgICAgICAgKiovCiAgICAgICAgZmV0Y2hJbnN0YW5jZTogZnVuY3Rpb24gKG5hbWUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sb2FkaW5nSW5zdGFuY2VzW25hbWVdIHx8ICh0aGlzLmxvYWRpbmdJbnN0YW5jZXNbbmFtZV0gPSB3aGVuLmRlZmVyKCkpOwogICAgICAgIH0KICAgIH07Cn0pOwpkZWZpbmUoJ3RocnVzdC9jb25maWcnLFsnLi9pbnN0YW5jZSddLApmdW5jdGlvbiAodGhydXN0SW5zdGFuY2UpCnsKICAgIC8qKgogICAgUHJvdmlkZXMgdGhydXN0IGNvbmZpZ3VyYXRpb24KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBzdWJtb2R1bGUgY29uZmlnCiAgICAqKi8KICAgIAoKICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgLyoqCiAgICAgICAgVGhpcyBwcm9wZXJ0eSwgdGVsbHMgdGhlIGZyYW1ld29yayBpZiBpdCBzaG91bGQgdGhyb3cgZXJyb3JzIG9yIG5vdC4KICAgICAgICBJbiBwcm9kdWN0aW9uIGl0J3MgcmVjb21tZW5kZWQgbm90IHRvIHRocm93IGVycm9ycywgdGhhdCB3YXkgaWYgYSBjb21wb25lbnQgZmFpbHMKICAgICAgICB0aGVyZSBpcyBhIGNoYW5jZSB0aGUgYXBwbGljYXRpb24gY2FuIHN0aWxsIHJlY292ZXIuCgogICAgICAgIEBmb3IgY29uZmlnCiAgICAgICAgQHByb3BlcnR5IHRocm93RXJyb3JzCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAqKi8KICAgICAgICB0aHJvd0Vycm9yczogdHJ1ZSwKICAgICAgICAvKioKICAgICAgICBUZWxscyB0aGUgZnJhbWV3b3JrIHRvIHJ1biBpbiBhc3luYyBtb2RlLCB0aGlzIG1heSBkZWxheSBzdGFydCB1cCwgYnV0IHdpbGwgbWFrZSBpbWFnZSBsb2FkaW5nIGFuZCBpbml0YWwgcnVubmluZyBhcHBlYXIgZmFzdGVyLgoKICAgICAgICBAcHJvcGVydHkgYXN5bmMKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICBAZGVmYXVsdCB0cnVlCiAgICAgICAgKiovCiAgICAgICAgYXN5bmM6IHRydWUsCiAgICAgICAgdXJsOiB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIHByb3BlcnR5LCBnaXZlcyB0aGUgZnJhbWV3b3JrIGl0J3MgZGVmYXVsdCBwYXRoLCBpZiBkaWZmZXJlbnQgdGhhbiAnLycKICAgICAgICAgICAgCiAgICAgICAgICAgIEBwcm9wZXJ0eSB1cmwucGF0aAogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge1N0cmluZ30KICAgICAgICAgICAgQGRlZmF1bHQgIi8iCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBwYXRoOiAnLycsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIHByb3BlcnR5LCB0ZWxscyB0aGUgZnJhbWV3b3JrIGhvdyBpdCBzaG91bGQgZW5jb2RlIGFycmF5IGZvcm0gZGF0YS4KICAgICAgICAgICAgSW4gZ2VuZXJhbCwgZm9yIEFTUC5ORVQgYmFzZWQgYXBwbGljYXRpb25zLCB0cmFkaXRpb25hbCBzaG91bGQgYmUgdHJ1ZS4KICAgICAgICAgICAgRm9yIFJ1YnkvUHl0aG9uIGJhc2VkIGFwcGxpY2F0aW9ucywgdGhpcyBzaG91bGQgYmUgZmFsc2UuCiAgICAgICAgICAgIAogICAgICAgICAgICBAcHJvcGVydHkgdXJsLnRyYWRpdGlvbmFsRW5jb2RpbmcKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICBAZGVmYXVsdCBmYWxzZQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgdHJhZGl0aW9uYWxFbmNvZGluZzogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgbG9nOiB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIGxlbmRzIHRvIHRoZSBsb2cgbGV2ZWwgb2YgdGhydXN0LgoKICAgICAgICAgICAgICAgIEVSUk9SOiAxCiAgICAgICAgICAgICAgICBXQVJOOiAyCiAgICAgICAgICAgICAgICBJTkZPOiAzCiAgICAgICAgICAgICAgICBERUJVRzogNAogICAgICAgICAgICAKICAgICAgICAgICAgQHByb3BlcnR5IGxvZy5sZXZlbAogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge1N0cmluZ30KICAgICAgICAgICAgQGRlZmF1bHQgMQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgbGV2ZWw6IDQsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIHRvZ2dsZXMgZW5hYmxpbmcgb24gb3Igb2ZmLgogICAgICAgICAgICAKICAgICAgICAgICAgQHByb3BlcnR5IGxvZy5lbmFibGVkCiAgICAgICAgICAgIEByZWFkT25seQogICAgICAgICAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGVuYWJsZWQ6IHRydWUKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhydXN0CgogICAgICAgIEBwcm9wZXJ0eSByZXNvbHZlCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0FycmF5fQogICAgICAgICoqLwogICAgICAgIHRocnVzdDoKICAgICAgICB7CiAgICAgICAgICAgIHJlc29sdmU6IFsnbmFtZSddLAogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgUGx1Z2lucyBmb3IgdGhydXN0IHRvIGxvYWQsIG92ZXJyaWRlIHdpdGggeW91ciBvd24gc2V0IGlmIHlvdSBoYXZlIGEgZGlmZmVyZW50IHNldC4KCiAgICAgICAgQHByb3BlcnR5IHBsdWdpbnMKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7QXJyYXl9CiAgICAgICAgKiovCiAgICAgICAgcGx1Z2luczogWwogICAgICAgICAgICAndGhydXN0L2RhdGEnLAogICAgICAgICAgICAndGhydXN0L2RvbScsCiAgICAgICAgICAgICd0aHJ1c3QvdGVtcGxhdGUnLAogICAgICAgICAgICAndGhydXN0L3NwYScsCiAgICAgICAgXSwKICAgICAgICAvKioKICAgICAgICBUaGUgc2V0IG9mIG1vZHVsZXMgdG8gcHJlbG9hZCB3aXRoIHRoZSBpbml0YWwgd2lyZXVwIG9mIHRoZSBUaHJ1c3QgaW5zdGFuY2UuCgogICAgICAgIEBwcm9wZXJ0eSBtb2R1bGVzCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0FycmF5fQogICAgICAgICoqLwogICAgICAgIG1vZHVsZXM6IFtdLAogICAgICAgIC8qKgogICAgICAgIFRoZSBzZXQgb2YgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgdGhydXN0L21lZGlhdG9yIHBsdWdpbgoKICAgICAgICBAcHJvcGVydHkgbWVkaWF0b3IKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7T2JqZWN0fQogICAgICAgICoqLwogICAgICAgIG1lZGlhdG9yOiB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBSZXNvbHZlcyB0aGUgZ2l2ZW4gcHJvcGVydGllcyB3aGVuIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoZSBwbHVnaW4KICAgIAogICAgICAgICAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge0FycmF5fQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgcmVzb2x2ZTogWyduYW1lJ10sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvbWVkaWF0b3IuCgogICAgICAgICAgICBAcHJvcGVydHkgbWVkaWF0b3IuY29udmVudGlvbnMKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGNvbnZlbnRpb25zOiBbCiAgICAgICAgICAgICAgICAndGhydXN0L21lZGlhdG9yL2NvbnZlbnRpb24vY29udGFpbmVyJywKICAgICAgICAgICAgICAgICd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nLAogICAgICAgICAgICAgICAgJ3RocnVzdC9tZWRpYXRvci9jb252ZW50aW9uL2F1dG9zdGFydCcsCiAgICAgICAgICAgICAgICAndGhydXN0L21lZGlhdG9yL2NvbnZlbnRpb24vZGVwZW5kYW50Lm1vZHVsZXMnCiAgICAgICAgICAgIF0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIFRoZSBzZXQgb2YgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgdGhydXN0L2RvbSBwbHVnaW4KCiAgICAgICAgQHByb3BlcnR5IGRvbQogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtPYmplY3R9CiAgICAgICAgKiovCiAgICAgICAgZG9tOiB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBSZXNvbHZlcyB0aGUgZ2l2ZW4gcHJvcGVydGllcyB3aGVuIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoZSBwbHVnaW4KICAgIAogICAgICAgICAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge0FycmF5fQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgcmVzb2x2ZTogWyduYW1lJywgJ21lZGlhdG9yJ10sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgoKICAgICAgICAgICAgQHByb3BlcnR5IGRvbS5jb252ZW50aW9ucwogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge0FycmF5fQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgY29udmVudGlvbnM6IFsKICAgICAgICAgICAgICAgICd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYWN0aW9uJywKICAgICAgICAgICAgICAgICd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vY29udGV4dCcsCiAgICAgICAgICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JwogICAgICAgICAgICAgICAgLy8ndGhydXN0L2RvbS9jb252ZW50aW9uL3BhZ2UucmVhZHknCiAgICAgICAgICAgIF0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIFRoZSBzZXQgb2YgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgdGhydXN0L2RhdGEgcGx1Z2luCgogICAgICAgIEBwcm9wZXJ0eSBkYXRhCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge09iamVjdH0KICAgICAgICAqKi8KICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBSZXNvbHZlcyB0aGUgZ2l2ZW4gcHJvcGVydGllcyB3aGVuIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoZSBwbHVnaW4KICAgIAogICAgICAgICAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge0FycmF5fQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgcmVzb2x2ZTogWyduYW1lJywgJ21lZGlhdG9yJywgJ2NmZyddLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgRGVjaWRlcyBpZiB0aHJ1c3QvZGF0YSBzaG91bGQgY2FjaGUgcmVxdWVzdHMgb3Igbm90LCB1c2VmdWwgdG8gYmUgdHVybmVkIGZvciBkZWJ1Z2dpbmcuCgogICAgICAgICAgICBAcHJvcGVydHkgZGF0YS5jYWNoZQogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICAgIEBkZWZhdWx0IHRydWUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGNhY2hlOiB0cnVlLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgc3RhcnRUaW1lb3V0IGlzIGEgcXVldWVpbmcgbWV0aG9kIGJ1aWx0IGludG8gdGhydXN0L2RhdGEuCiAgICAgICAgICAgICAgICBUaGUgY29uY2VwdCBoZXJlIGlzLCB0aGF0IHRoZSBjYWxsIHRvIGdldCBkYXRhLCBkb2Vzbid0IGltbWVkaWF0ZWx5IGZpcmUgdG8gdGhlIHNlcnZlci4KICAgICAgICAgICAgICAgIEluc3RlYWQgaXQgd2FpdHMgZm9yIGEgc2V0IGR1cmF0aW9uLCB0byBzZWUgaWYgYW55IG90aGVyIHJlcXVlc3RzIGFyZSBtYWRlIGZyb20gYW55IG90aGVyCiAgICAgICAgICAgICAgICBtb2R1bGVzLiAgVGhpcyBhbGxvd3MgbXVsdGlwbGUgY2FsbHMgb2ZmIHRvIHRoZSBzZXJ2ZXIgdG8gYmUgc3luY3Jvbml6ZWQsIGFuZCBoZWxwcyBrZWVwCiAgICAgICAgICAgICAgICBVSSBjaGFuZ2VzIGRvbmUgYXMgc3luY3JvbnVzbHkgYXMgcG9zc2libGUsIGdpdmluZyB0aGUgVUkgYSB1bmlmb3JtIGJlaGF2aW91ci4KCiAgICAgICAgICAgIEBwcm9wZXJ0eSBkYXRhLnN0YXJ0VGltZW91dAogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge051bWJlcn0KICAgICAgICAgICAgQGRlZmF1bHQgNTAwCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBzdGFydFRpbWVvdXQ6IDEwMCwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIGZpbmlzaFRpbWVvdXQgaXMgYSBxdWV1ZWluZyBtZXRob2QgYnVpbHQgaW50byB0aHJ1c3QuZGF0YQogICAgICAgICAgICAgICAgVGhlIGNvbmNlcHQgaGVyZSBpcyB0byBrZWVwIG9uIHdpdGggdGhlIGNvbmNlcHQgb2Ygc3RhcnRUaW1lb3V0LiAgSWYgZm9yIHNvbWUgcmVhc29uLCBvbmUKICAgICAgICAgICAgICAgIG9mIHRoZSBpbml0YWwgcmVxdWVzdHMgaXMgdGFraW5nIHRvIGxvbmcgdG8gY29tcGxldGUsIHRoZSBwbHVnaW4gd2lsbCBhbHdheXMgcmV0dXJuIHRoZQogICAgICAgICAgICAgICAgZmluaXNoZWQgcmVxdWVzdHMgd2l0aGluIHRoaXMgYW1vdW50IG9mIHRpbWUuICBUaGUgY29uY2VwdCBrZWVwcyB0aGUgYXBwbGljYXRpb24gd29ya2luZywKICAgICAgICAgICAgICAgIGV2ZW4gd2hlbiBvbmUgb3IgbW9yZSBjb21wb25lbnRzIGFyZSBwb3RlbnRpYWxseSBoYXZpbmcgaXNzdWVzLgoKICAgICAgICAgICAgQHByb3BlcnR5IGRhdGEuZmluaXNoVGltZW91dAogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge051bWJlcn0KICAgICAgICAgICAgQGRlZmF1bHQgMjAwMAogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZmluaXNoVGltZW91dDogMjAwMCwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9kb20uCgogICAgICAgICAgICBAcHJvcGVydHkgZGF0YS5jb252ZW50aW9ucwogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge0FycmF5fQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgY29udmVudGlvbnM6IFsKICAgICAgICAgICAgICAgICd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JwogICAgICAgICAgICBdCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBUaGUgc2V0IG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHRocnVzdC90ZW1wbGF0ZSBwbHVnaW4KCiAgICAgICAgQHByb3BlcnR5IHRlbXBsYXRlCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge09iamVjdH0KICAgICAgICAqKi8KICAgICAgICB0ZW1wbGF0ZTogewogICAgICAgICAgICAvKioKICAgICAgICAgICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luCiAgICAKICAgICAgICAgICAgQHByb3BlcnR5IHJlc29sdmUKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHJlc29sdmU6IFsnY2ZnJywgJ2RhdGEnXSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9kb20uCgogICAgICAgICAgICBAcHJvcGVydHkgdGVtcGxhdGUuY29udmVudGlvbnMKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGNvbnZlbnRpb25zOiBbCiAgICAgICAgICAgICAgICAndGhydXN0L3RlbXBsYXRlL2NvbnZlbnRpb24vdGVtcGxhdGUnLAogICAgICAgICAgICAgICAgJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL2tub2Nrb3V0LmVuZ2luZScKICAgICAgICAgICAgXSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIE1hcHMgdGhlIGF2YWlsYWJsZSB0ZW1wbGF0ZXMsIHRvIHRoZWlyIGFwcHJvcHJpYXRlIG1vZHVsZSBuYW1lLgoKICAgICAgICAgICAgKipwcmVjb21waWxlZCBpcyBhIHNwZWNpYWwgY2FzZSwgYW5kIHRob3NlIG1ldGhvZHMgYXJlIGV4cGVjdGVkIHRvIGJlIGNvZGUgYnVpbHQgZnVuY3Rpb25zLgoKICAgICAgICAgICAgQHByb3BlcnR5IHRlbXBsYXRlLnR5cGVzCiAgICAgICAgICAgIEByZWFkT25seQogICAgICAgICAgICBAdHlwZSB7T2JqZWN0fQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgdHlwZXM6IHsKICAgICAgICAgICAgICAgIC8vJ2tlbmRvJzogJ3BhdGgvdG8va2VuZG8nLAogICAgICAgICAgICAgICAgJ2RvVCc6ICdkb1QnLAogICAgICAgICAgICAgICAgJ3ByZWNvbXBpbGVkJzogdHJ1ZQogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgTWFwcyB0aGUgdGVtcGxhdGUgZXZhbHVhdG9ycywgc28gdGhhdCB3aGVuIGNyZWF0aW5nIGEgdGVtcGxhdGUgZm9yIGtub2Nrb3V0LCBpdCBrbm93cyBob3cgdG8gcHJvcGVybHkgb3V0cHV0IHRoZSBpbmZvcm1hdGlvbi4KCiAgICAgICAgICAgIEBwcm9wZXJ0eSB0ZW1wbGF0ZS5ldmFsdWF0b3JzCiAgICAgICAgICAgIEByZWFkT25seQogICAgICAgICAgICBAdHlwZSB7T2JqZWN0fQogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZXZhbHVhdG9yczogewogICAgICAgICAgICAgICAgLy8na2VuZG8nOiB7IGxlZnQ6ICcjPScsIHJpZ2h0OiAnIycgfSwKICAgICAgICAgICAgICAgICdkb1QnOiB7IGxlZnQ6ICd7ez0gJywgcmlnaHQ6ICd9fScgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgVGhlIGRlZmF1bHQgdGVtcGxhdGUgdHlwZSwgdXNlZCB3aGVuIGV4dGVuc2lvbiBpc24ndCBnaXZlbi4KCiAgICAgICAgICAgIEBwcm9wZXJ0eSB0ZW1wbGF0ZS5kZWZhdWx0VHlwZQogICAgICAgICAgICBAcmVhZE9ubHkKICAgICAgICAgICAgQHR5cGUge1N0cmluZ30KICAgICAgICAgICAgQGRlZmF1bHQgJ2RvVCcKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGRlZmF1bHRUeXBlOiAnZG9UJywKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIFRoZSBiYXNlIGxvY2F0aW9uLCByZWxhdGl2ZSB0byB0aGUgYXBwbGljYXRpb24gcGF0aCBmb3IgdGVtcGxhdGUgbG9jYXRpb24uCiAgICAgICAgICAgIElmIHRlbXBsYXRlIHBhdGhzIGFyZSBnaXZlbiByZWxhdGl2ZSB0byBhcHBsaWNhdGlvbiBwYXRoLCB0aGlzIGNhbiBiZSBsZWZ0IGVtcHR5LgoKICAgICAgICAgICAgQHByb3BlcnR5IHRlbXBsYXRlLmJhc2VVcmwKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICAgIEBkZWZhdWx0ICcnCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBiYXNlVXJsOiAnJywKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgIERlZmluZXMgdGhlIGV4dGVuc2lvbiB1c2VkIGZvciB0ZW1wbGF0ZXMgc3RvcmVkIG9uIHRoZSBzZXJ2ZXIuCgogICAgICAgICAgICBAcHJvcGVydHkgdGVtcGxhdGUuZXh0ZW5zaW9uCiAgICAgICAgICAgIEByZWFkT25seQogICAgICAgICAgICBAdHlwZSB7U3RyaW5nfQogICAgICAgICAgICBAZGVmYXVsdCAnLnRtcGwnCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBleHRlbnNpb246ICcudG1wbCcKICAgICAgICB9LAogICAgICAgIHNwYTogewogICAgICAgICAgICAvKioKICAgICAgICAgICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luCiAgICAKICAgICAgICAgICAgQHByb3BlcnR5IHJlc29sdmUKICAgICAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgICAgIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHJlc29sdmU6IFsnY2ZnJywgJ25hbWUnLCAnbWVkaWF0b3InXSwKICAgICAgICAgICAgY29udmVudGlvbnM6IFsKICAgICAgICAgICAgICAgICd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3RhcnQnCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgIHJvdXRlczoge30KICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgQU1EIEFQSQogICAgbG9hZAoKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBjdXJyZW50IGNvbmZpZyBmb3IgdGhlIGN1cnJlbnQgdGhydXN0IGluc3RhbmNlLCBvciB0aGUgY29uZmlnIG9mIHRoZSBnaXZlbiBwbHVnaW4uCiAgICBBZGRpbmcgdGhlIDogY2hhcmFjdGVyIHJlcXVlc3RzIGEgc3BlY2lmaWMgY29uZmlnIHBsdWdpbi4KICAgIHRocnVzdC9jb25maWchZ2xvYmFsID0gdGhydXN0IWdsb2JhbDpjb25maWcgPSBUaHJ1c3QgaW5zdGFuY2UgY29uZmlnIGZyb20gdGhlIGluc3RhbmNlIG5hbWVkIGdsb2JhbC4KCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBjb25maWcubG9hZCA9IGZ1bmN0aW9uIChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpCiAgICB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLAogICAgICAgICAgICByZWFsTmFtZSA9IHBhcnRzWzBdLAogICAgICAgICAgICBwbHVnaW5OYW1lID0gcGFydHNbMV0gfHwgZmFsc2U7CgogICAgICAgIHZhciBpbnN0YW5jZVByb21pc2UgPSB0aHJ1c3RJbnN0YW5jZS5mZXRjaEluc3RhbmNlKHJlYWxOYW1lKTsKICAgICAgICBpbnN0YW5jZVByb21pc2UudGhlbihmdW5jdGlvbiAoY29udGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBwbHVnaW5OYW1lICYmIGNvbnRleHQuY2ZnW3BsdWdpbk5hbWVdIHx8IGNvbnRleHQuY29uZmlnOwogICAgICAgICAgICBpZiAoIXBsdWdpbikKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUGx1Z2luICInICsgcGx1Z2luTmFtZSArICciIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiJyArIHJlYWxOYW1lICsgJyIuJyk7CgogICAgICAgICAgICBsb2FkKHBsdWdpbik7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIHJldHVybiBjb25maWc7Cn0pOwpkZWZpbmUoJ3RocnVzdC9sb2cnLFsndGhydXN0L2NvbmZpZycsICd0aHJ1c3QvdXRpbCddLApmdW5jdGlvbiAodENvbmZpZywgdXRpbCkKewogICAgLyoqCiAgICAgICAgQSBiYXNpYyBsb2dnZXIgZm9yIHRoZSB0aHJ1c3QgZnJhbWV3b3JrLgogICAgICAgIERpc2FibGVzIGRlYnVnIGxvZ2dpbmcgd2hlbiB0aHJ1c3QgaXMgbm90IGluIGRlYnVnIG1vZGUuCgogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBzdWJtb2R1bGUgbG9nCiAgICAqKi8KICAgIAogICAgLy8gTG9nIGxldmVscwogICAgdmFyIExFVkVMID0gewogICAgICAgIERFQlVHOiA0LAogICAgICAgIElORk86IDMsCiAgICAgICAgV0FSTjogMiwKICAgICAgICBFUlJPUjogMQogICAgfTsKCiAgICAvLyBEZWNsYXJlIG91ciB2YXJpYWJsZXMKICAgIHZhciBjb25zb2xlICAgICA9IHdpbmRvdy5jb25zb2xlLAogICAgICAgIHRpbWVycyAgICAgID0ge30sCiAgICAgICAgbG9nICAgICAgICAgPSAoY29uc29sZSAmJiBjb25zb2xlLmxvZykgfHwgZmFsc2UsCiAgICAgICAgd2FybiAgICAgICAgPSAoY29uc29sZSAmJiBjb25zb2xlLndhcm4pIHx8IGZhbHNlLAogICAgICAgIGluZm8gICAgICAgID0gKGNvbnNvbGUgJiYgY29uc29sZS5pbmZvKSB8fCBmYWxzZSwKICAgICAgICBlcnJvciAgICAgICA9IChjb25zb2xlICYmIGNvbnNvbGUuZXJyb3IpIHx8IGZhbHNlLAogICAgICAgIHRpbWUgICAgICAgID0gKGNvbnNvbGUgJiYgY29uc29sZS50aW1lKSB8fCBmYWxzZSwKICAgICAgICB0aW1lRW5kICAgICA9IChjb25zb2xlICYmIGNvbnNvbGUudGltZUVuZCkgfHwgZmFsc2UsCiAgICAgICAgc2xpY2UgICAgICAgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCiAgICAgICAgY29uZmlnTGV2ZWwgPSB0Q29uZmlnLmxvZy5sZXZlbCB8fCBMRVZFTC5FUlJPUiwKICAgICAgICBsb2dMZXZlbCAgICA9IExFVkVMW2NvbmZpZ0xldmVsXSB8fCAodHlwZW9mIGNvbmZpZ0xldmVsID09PSAnc3RyaW5nJyAmJiBMRVZFTFtjb25maWdMZXZlbC50b1VwcGVyQ2FzZSgpXSkgfHwgKHR5cGVvZiBjb25maWdMZXZlbCAgPT09ICdudW1iZXInICYmIGNvbmZpZ0xldmVsKSB8fCBMRVZFTC5FUlJPUjsKCiAgICAvLyBWYXJpb3VzIGxvZ2dlcnMgdG8gaGFuZGxlIElFOC85IHN1cHBvcnQuCiAgICB2YXIgbG9nUnVubmVyID0gZnVuY3Rpb24gKGNvbnNvbGVNZXRob2QsIGxvZ1R5cGUpCiAgICB7CiAgICAgICAgLy8gU2hvdyBsb2dzIHdoZW4gZW5hYmxlZCBvciBpZiB0aGV5IGFyZSBlcnJvcnMKICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICBpZiAoY29uc29sZU1ldGhvZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjb25zb2xlTWV0aG9kLmFwcGx5KQogICAgICAgICAgICAgICAgY29uc29sZU1ldGhvZC5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgY29uc29sZU1ldGhvZChhcmdzKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoIWNvbnNvbGVNZXRob2QgJiYgbG9nKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGxvZy5hcHBseSkKICAgICAgICAgICAgICAgIGxvZy5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgbG9nKGFyZ3MpOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICBBIGJhc2ljIGxvZ2dlciBmb3IgdGhlIHRocnVzdCBmcmFtZXdvcmsuCiAgICAgICAgRGlzYWJsZXMgZGVidWcgbG9nZ2luZyB3aGVuIHRocnVzdCBpcyBub3QgaW4gZGVidWcgbW9kZS4KCiAgICBAY2xhc3MgTG9nCiAgICAqKi8KICAgIHZhciBMb2cgPSB7CiAgICAgICAgLyoqCiAgICAgICAgTG9ncyBhIGRlYnVnIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSBsb2cgbWV0aG9kCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZWJ1ZwogICAgICAgICoqLwogICAgICAgIGRlYnVnOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgICAgIGlmICghdENvbmZpZy5sb2cuZW5hYmxlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgYXJncy51bnNoaWZ0KGxvZyk7CgogICAgICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICdsb2cnKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgTG9ncyBhIGluZm8gdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGluZm8gbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KCiAgICAgICAgQG1ldGhvZCBpbmZvCiAgICAgICAgKiovCiAgICAgICAgaW5mbzogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgICAgICBpZiAoIXRDb25maWcubG9nLmVuYWJsZWQpIHJldHVybjsKICAgICAgICAgICAgaWYgKGxvZ0xldmVsID49IExFVkVMLklORk8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgYXJncy51bnNoaWZ0KGluZm8pOwoKICAgICAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnaW5mbycpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBMb2dzIGEgd2FybiB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgd2FybiBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgoKICAgICAgICBAbWV0aG9kIHdhcm4KICAgICAgICAqKi8KICAgICAgICB3YXJuOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgICAgIGlmICghdENvbmZpZy5sb2cuZW5hYmxlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAobG9nTGV2ZWwgPj0gTEVWRUwuV0FSTikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICBhcmdzLnVuc2hpZnQod2Fybik7CgogICAgICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICd3YXJuJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIExvZ3MgYSBlcnJvciB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgZXJyb3IgbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KCiAgICAgICAgQG1ldGhvZCBlcnJvcgogICAgICAgICoqLwogICAgICAgIGVycm9yOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgICAgIGlmICghdENvbmZpZy5sb2cuZW5hYmxlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAobG9nTGV2ZWwgPj0gTEVWRUwuRVJST1IpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgYXJncy51bnNoaWZ0KGVycm9yKTsKCiAgICAgICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ2Vycm9yJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIExvZ3MgYSB0aW1lIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSB0aW1lIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCgogICAgICAgIEBtZXRob2QgdGltZQogICAgICAgICoqLwogICAgICAgIHRpbWU6IGZ1bmN0aW9uIChtZXNzYWdlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgICAgIGlmICghdENvbmZpZy5sb2cuZW5hYmxlZCkgcmV0dXJuOwogICAgICAgICAgICBpZiAobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRpbWVyc1ttZXNzYWdlXSA9IHsgc3RhcnQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIH07CiAgICAgICAgICAgICAgICB2YXIgbXNnID0gdXRpbC5mb3JtYXQoJ3swfTogdGltZXIgc3RhcnRlZCcsIG1lc3NhZ2UpLAogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICBhcmdzLnVuc2hpZnQobXNnKTsKICAgICAgICAgICAgICAgIGFyZ3MudW5zaGlmdCh0aW1lKTsKCiAgICAgICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIExvZ3MgYSB0aW1lRW5kIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSB0aW1lRW5kIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAgICAgQ2F1c2VzIHRoZSB0aW1lciB0byBlbmQsIGZvciB0aGUgZ2l2ZW4gbWVzc2FnZS4KCiAgICAgICAgQG1ldGhvZCB0aW1lRW5kCiAgICAgICAgKiovCiAgICAgICAgdGltZUVuZDogZnVuY3Rpb24gKG1lc3NhZ2UpCiAgICAgICAgewogICAgICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGxvZ2dpbmcgaXMgZGlzYWJsZWQuICBUaGlzIGlzIGFzIGNsb3NlIHRvIG5vb3AgYXMgd2UgY2FuIGdldCwgaW5jYXNlIHRoZXJlIGlzIGEgZGlyZWN0IHJlZmVyZW5jZSB0byB0aGlzIG1ldGhvZC4KICAgICAgICAgICAgaWYgKCF0Q29uZmlnLmxvZy5lbmFibGVkKSByZXR1cm47CiAgICAgICAgICAgIGlmIChsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGltZXJzW21lc3NhZ2VdLmVuZCA9IG5ldyBEYXRlLmdldFRpbWUoKTsKICAgICAgICAgICAgICAgIHZhciB0aW1lID0gdGltZXJzW21lc3NhZ2VdLmVuZCAtIHRpbWVyc1ttZXNzYWdlXS5zdGFydCwKICAgICAgICAgICAgICAgICAgICBtc2cgPSB1dGlsLmZvcm1hdCgnezB9OiB7MX1tcycsIG1lc3NhZ2UsIHRpbWUpOwogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICBhcmdzLnVuc2hpZnQobXNnKTsKICAgICAgICAgICAgICAgIGFyZ3MudW5zaGlmdCh0aW1lRW5kKTsKCiAgICAgICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIHJldHVybiBMb2c7Cn0pOwoKZGVmaW5lKCd0aHJ1c3QvaWduaXRlJyxbJ3JlcXVpcmUnLCAndGhydXN0L2NvbmZpZycsICd0aHJ1c3QvdXRpbCddLApmdW5jdGlvbihyZXF1aXJlLCBjb25maWcsIHV0aWwpCnsKICAgIHZhciBzbGljZSAgICA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKICAgICAgICBpc0FycmF5ICA9IHV0aWwuaXNBcnJheSwKICAgICAgICB0b0FycmF5ICA9IHV0aWwudG9BcnJheSwKICAgICAgICBlYWNoICAgICA9IHV0aWwuZWFjaCwKICAgICAgICBtYXAgICAgICA9IHV0aWwubWFwLAogICAgICAgIGFueSAgICAgID0gdXRpbC5hbnksCiAgICAgICAgYWxsICAgICAgPSB1dGlsLmFsbCwKICAgICAgICB3aGVuICAgICA9IHV0aWwud2hlbiwKICAgICAgICBleHRlbmQgICA9IHV0aWwuZXh0ZW5kLAogICAgICAgIGZsYXR0ZW4gID0gdXRpbC5mbGF0dGVuLAogICAgICAgIHBsdWNrICAgID0gdXRpbC5wbHVjaywKICAgICAgICBpc09iamVjdCA9IHV0aWwuaXNPYmplY3QsCgogICAgICAgIHJlY29uY2lsZUFycmF5cyA9IGZ1bmN0aW9uIChmcm9tLCB0bykKICAgICAgICB7CiAgICAgICAgICAgIGVhY2goZnJvbSwgZnVuY3Rpb24gKHgsIGkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHgpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRvW2ldID0gdG9BcnJheSh0b1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChpc09iamVjdCh4KSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZWNvbmNpbGVBcnJheXMoeCwgdG9baV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgIC8qKgogICAgQ29udHJ1Y3RzIGEgd2lyZSBzcGVjIGZvciB0aHJ1c3QgdG8gbGF1bmNoIGZyb20uCgogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBzdWJtb2R1bGUgaWduaXRlCiAgICAqKi8KICAgIHJldHVybiB7CiAgICAgICAgLyp3aXJlU3RhZ2VPbmU6IGZ1bmN0aW9uIChzZXR0aW5ncykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBsb2NhbENvbmZpZyA9IHV0aWwuZGVlcENvcHkoe30sIGNvbmZpZywgc2V0dGluZ3MpOwogICAgICAgICAgICByZWNvbmNpbGVBcnJheXMoY29uZmlnLCBsb2NhbENvbmZpZyk7CgogICAgICAgICAgICB2YXIgbWFwQXJncyA9IGZ1bmN0aW9uIChhcmdzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXJncy5tYXAoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHsgJHJlZjogeCB9OyB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBwcm9wZXJ0aWVzID0gewogICAgICAgICAgICAgICAgICAgIF9fY29udmVudGlvbnM6IFtdCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc3BlYyA9IHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiBsb2NhbENvbmZpZy5uYW1lIHx8ICdnbG9iYWwnLAogICAgICAgICAgICAgICAgICAgIGNmZzogbG9jYWxDb25maWcsCiAgICAgICAgICAgICAgICAgICAgdGhydXN0OiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlOiAndGhydXN0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IG1hcEFyZ3MobG9jYWxDb25maWcudGhydXN0LnJlc29sdmUpCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHByb3BlcnRpZXMKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHBsdWdpbnM6IFtdCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGxvY2FsQ29uZmlnLmRlYnVnKQogICAgICAgICAgICAgICAgc3BlYy5wbHVnaW5zLnB1c2goeyBtb2R1bGU6ICd3aXJlL2RlYnVnJyB9KTsKCiAgICAgICAgICAgIC8vIExvYWQgYWxsIHRoZSB0aHJ1c3QtanMgcGx1Z2lucywgZGVmaW5lZCBpbiB0aGUgY29uZmlnLgogICAgICAgICAgICB2YXIgcGx1Z2lucyA9IGxvY2FsQ29uZmlnLnBsdWdpbnM7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gcGx1Z2lucy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gcGx1Z2luc1tpXSwKICAgICAgICAgICAgICAgICAgICBwbHVnaW4gPSBuYW1lOwoKICAgICAgICAgICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cmluZyhuYW1lLmxhc3RJbmRleE9mKCcvJykgKyAxKTsKCiAgICAgICAgICAgICAgICB2YXIgcGx1Z2luU3BlYyA9IHNwZWNbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgY3JlYXRlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZTogcGx1Z2luLAogICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBtYXBBcmdzKGxvY2FsQ29uZmlnW25hbWVdLnJlc29sdmUpCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7IF9fY29udmVudGlvbnM6IFtdIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0geyAkcmVmOiBuYW1lIH07CgogICAgICAgICAgICAgICAgdmFyIGNvbnZlbnRpb25zID0gbG9jYWxDb25maWdbbmFtZV0uY29udmVudGlvbnM7CiAgICAgICAgICAgICAgICBmb3IgKHZhciB6ID0gMCwgekxlbiA9IGNvbnZlbnRpb25zLmxlbmd0aDsgeiA8IHpMZW47IHorKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY25hbWUgPSBjb252ZW50aW9uc1t6XSwKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVudGlvbiA9IGNuYW1lOwogICAgICAgICAgICAgICAgICAgIGNuYW1lID0gbmFtZSArICctY29udmVudGlvbi0nICsgY25hbWUuc3Vic3RyaW5nKGNuYW1lLmxhc3RJbmRleE9mKCcvJykgKyAxKTsKCiAgICAgICAgICAgICAgICAgICAgc3BlY1tjbmFtZV0gPSB7IGNyZWF0ZTogY29udmVudGlvbiB9OwogICAgICAgICAgICAgICAgICAgIHBsdWdpblNwZWMucHJvcGVydGllcy5fX2NvbnZlbnRpb25zLnB1c2goeyAkcmVmOiBjbmFtZSB9KTsKICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzLl9fY29udmVudGlvbnMucHVzaCh7ICRyZWY6IGNuYW1lIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gc3BlYzsKICAgICAgICB9LAogICAgICAgIHdpcmVTdGFnZVR3bzogZnVuY3Rpb24gKHNldHRpbmdzKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvY2FsQ29uZmlnID0gdXRpbC5kZWVwQ29weSh7fSwgY29uZmlnLCBzZXR0aW5ncyk7CiAgICAgICAgICAgIHJlY29uY2lsZUFycmF5cyhjb25maWcsIGxvY2FsQ29uZmlnKTsKCiAgICAgICAgICAgIHZhciBjaGlsZFNwZWMgPSB7fTsKCiAgICAgICAgICAgIHZhciBtb2R1bGVzID0gbG9jYWxDb25maWcubW9kdWxlczsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBtb2R1bGVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG1vZHVsZSA9IG1vZHVsZXNbaV0sCiAgICAgICAgICAgICAgICAgICAgbmFtZSA9IG1vZHVsZXNbaV07CgogICAgICAgICAgICAgICAgdmFyIG1vZHVsZVNwZWMgPSBjaGlsZFNwZWNbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgY3JlYXRlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZTogJ3RocnVzdC9tb2R1bGUnLAogICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBbeyAkcmVmOiBtb2R1bGUgfSwgeyBjcmVhdGU6IG1vZHVsZSB9LCBuYW1lXQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgaW5pdDogewogICAgICAgICAgICAgICAgICAgICAgICB0aHJ1c3RDcmVhdGU6IFt7ICRyZWY6ICd0aHJ1c3QnIH1dCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGNoaWxkU3BlYzsKICAgICAgICB9LCovCiAgICAgICAgLyoqCiAgICAgICAgQ3JlYXRlcyBhIHRocnVzdCBpbnN0YW5jZSwgZnJvbSB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgSW5jbHVkaW5nIHRoZSBwbHVnaW5zLCBhbmQgZ2l2ZW4gZGVmYXVsdCBtb2R1bGVzLgoKICAgICAgICBAbWV0aG9kIHN0YXRlT25lCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW50cyB0byBwYXNzIG9udG8gdGhlIHRocnVzdCBpbnN0YW5jZSBiZWluZyBjcmVhdGVkLgogICAgICAgICoqLwogICAgICAgIHN0YWdlT25lOiBmdW5jdGlvbiAoc2V0dGluZ3MpCiAgICAgICAgewogICAgICAgICAgICAvLyBHZXQgdGhlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgdmFyIGxvY2FsQ29uZmlnID0gdXRpbC5kZWVwQ29weSh7fSwgY29uZmlnLCBzZXR0aW5ncyksCiAgICAgICAgICAgICAgICBkZWZlciAgICAgICA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgLy8gUmVjb25pY2xlIHRoZSBhcnJheXMgc28gdGhleSBhcmUgcHJvcGVybHkgYXJyYXlzCiAgICAgICAgICAgIHJlY29uY2lsZUFycmF5cyhjb25maWcsIGxvY2FsQ29uZmlnKTsKCiAgICAgICAgICAgIC8vIE1lZGlhdG9yIGlzIGEgcmVxdWlyZWQgcGx1Z2luLCBpbmNsdWRlIGFsbCB0aGUgb3RoZXJzIGluIGFkZGl0aW9uIHRvIGl0LgogICAgICAgICAgICB2YXIgcGx1Z2lucyA9IFsndGhydXN0L21lZGlhdG9yJ10uY29uY2F0KGxvY2FsQ29uZmlnLnBsdWdpbnMgfHwgW10pLAogICAgICAgICAgICAgICAgLy8gVGhlIG1vZHVsZXMgdG8gbG9hZAogICAgICAgICAgICAgICAgbW9kdWxlc1RvTG9hZCA9IFtdLAogICAgICAgICAgICAgICAgLy8gVGhlIG1vZHVsZSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgbW9kdWxlc0NvbmZpZ3VyYXRpb25zID0geyB0aHJ1c3Q6ICd0aHJ1c3QnIH07CgogICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBwbHVnaW5zLCBjcmVhdGluZyBhIHByb3BlciBkZXBlbmRhbmN5IGxpc3QuCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gcGx1Z2lucy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwbHVnaW4gPSBwbHVnaW5zW2ldLAogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSksCiAgICAgICAgICAgICAgICAgICAgcGx1Z2luQ29uZmlnID0gbG9jYWxDb25maWdbbmFtZV07CgogICAgICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoKHBsdWdpbik7CiAgICAgICAgICAgICAgICBtb2R1bGVzVG9Mb2FkLnB1c2gocGx1Z2luQ29uZmlnLmNvbnZlbnRpb25zIHx8IFtdKTsKICAgICAgICAgICAgICAgIG1vZHVsZXNDb25maWd1cmF0aW9uc1twbHVnaW5dID0gcGx1Z2luQ29uZmlnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOYW1lIGFuZCBjZmcgYXJlIGRlZmF1bHQgcHJvcGVydGllcyBvZiB0aGUgY29uZmlndXJhdGlvbiBjb250ZXh0CiAgICAgICAgICAgIHZhciBvcmRlcmVkUGx1Z2lucyA9IFsnbmFtZScsICdjZmcnXSwKICAgICAgICAgICAgICAgIC8vIFdlIGxvb3AgdGhyb3VnaCB1bnRpbCBhbGwgdGhlIHBsdWdpbnMgYXJlIGluIHByb3BlciBvcmRlci4KICAgICAgICAgICAgICAgIHJlbG9vcCA9IHRydWUsCiAgICAgICAgICAgICAgICBpTGVuID0gbW9kdWxlc1RvTG9hZC5sZW5ndGgsCiAgICAgICAgICAgICAgICBpID0gMDsKCiAgICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHBsdWdpbnMgdW50aWwgd2UgaGF2ZSBhIHNldCB0aGF0IHdpbGwgbG9hZCBpbiBwcm9wZXIgb3JkZXIuCiAgICAgICAgICAgIHdoaWxlIChpIDwgaUxlbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gVGhlIHBsdWdpbgogICAgICAgICAgICAgICAgdmFyIHBsdWdpbiA9IG1vZHVsZXNUb0xvYWRbaV0sCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGltcGxpZWQgcGx1Z2luIG5hbWUKICAgICAgICAgICAgICAgICAgICBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLAogICAgICAgICAgICAgICAgICAgIC8vIFRoZSBwbHVnaW5zIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAgICBwbHVnaW5Db25maWcgPSBsb2NhbENvbmZpZ1tuYW1lXTsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcGx1Z2luIGhhcyB0byByZXNvbHZlIGFueXRoaW5nLgogICAgICAgICAgICAgICAgaWYgKHBsdWdpbkNvbmZpZy5yZXNvbHZlICYmIHBsdWdpbkNvbmZpZy5yZXNvbHZlLmxlbmd0aCA+IDAgJiYgIWFsbChwbHVnaW5Db25maWcucmVzb2x2ZSwKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoeCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhbnkob3JkZXJlZFBsdWdpbnMsIGZ1bmN0aW9uICh6KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB4ID09PSB6IHx8IHggPT09IHo7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG1vZHVsZXMgdG8gbG9hZC4KICAgICAgICAgICAgICAgICAgICAvLyBBbHNvIGluY2x1ZGVzIGFueSBjb252ZW50aW9ucy4KICAgICAgICAgICAgICAgICAgICBtb2R1bGVzVG9Mb2FkLnB1c2guYXBwbHkobW9kdWxlc1RvTG9hZCwgbW9kdWxlc1RvTG9hZC5zcGxpY2UoaSwgMikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIHJlb3JkZXIgdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgICAgICBvcmRlcmVkUGx1Z2lucy5wdXNoKG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUaGUgbW9kdWxlcyBjb25maWcKICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSBsb2NhbENvbmZpZy5tb2R1bGVzIHx8IFtdOwogICAgICAgICAgICAvLyBUaHJ1c3QgYW5kIHRocnVzdC9tb2R1bGUgYWxzbyBuZWVkIHRvIGJlIGxvYWRlZC4KICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoLmFwcGx5KG1vZHVsZXNUb0xvYWQsIFsndGhydXN0JywgJ3RocnVzdC9tb2R1bGUnXS5jb25jYXQobW9kdWxlcyB8fCBbXSkpOwogICAgICAgICAgICAvLyBGbGF0dGVuIHRoZSByZXN1bHRhbnQgYXJyYXkKICAgICAgICAgICAgbW9kdWxlc1RvTG9hZCA9IGZsYXR0ZW4obW9kdWxlc1RvTG9hZCk7CgogICAgICAgICAgICAvLyBDcmVhdGUgdGhlIGNvbmZpZ3VyYXRpb24gc3BlYwogICAgICAgICAgICB2YXIgc3BlYyA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IGxvY2FsQ29uZmlnLm5hbWUgfHwgJ2dsb2JhbCcsCiAgICAgICAgICAgICAgICBjZmc6IGxvY2FsQ29uZmlnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBMb2FkIGV2ZXJ5dGhpbmcKICAgICAgICAgICAgcmVxdWlyZShtb2R1bGVzVG9Mb2FkLCBmdW5jdGlvbiAoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBHZXQgcmVhZHkgdG8gbG9vcAogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRQbHVnaW4gPSBudWxsLCBhbGxDb252ZW50aW9ucyA9IFtdOwoKICAgICAgICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIG1vZHVsZXMgYmVpbmcgbG9hZGVkCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IG1vZHVsZXNUb0xvYWQubGVuZ3RoIC0gKG1vZHVsZXMubGVuZ3RoICsgMSk7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHBsdWdpbiBhbmQgY29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgICAgIHZhciBwbHVnaW4gPSBtb2R1bGVzVG9Mb2FkW2ldLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29uZmlnID0gbW9kdWxlc0NvbmZpZ3VyYXRpb25zW3BsdWdpbl07CgogICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlIGhhdmUgYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICAgIGlmIChtQ29uZmlnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBhIG5ldyBwbHVnaW4uCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwbHVnaW5DbGFzcyA9IGFyZ3VtZW50c1tpXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgcGx1Z2luIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlIGFsbCB0aGUgcmVxdWlyZWQgaXRlbXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlSXRlbXMgPSBtYXAobUNvbmZpZy5yZXNvbHZlLCBmdW5jdGlvbih4KSB7IHJldHVybiBzcGVjW3hdOyB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluc3RhbnRpYXRlIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFBsdWdpbiA9IHNwZWNbbmFtZV0gPSB1dGlsLmluc3RhbnRpYXRlKHBsdWdpbkNsYXNzLCByZXNvbHZlSXRlbXMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXR1cCB0aGUgY29udmVudGlvbnMKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIExvYWQgYWxsIHRoZSBjb252ZW50aW9ucwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGN1cnJlbnRQbHVnaW4pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIHRoZSBjb252ZW50aW9uIGludG8gdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fY29udmVudGlvbnMucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIHRoZSBjb252ZW50aW9uIGludG8gdGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICAgICAgICAgICAgICAgICAgYWxsQ29udmVudGlvbnMucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBUaGUgbGFzdCBjdXJyZW50IHBsdWdpbiwgd2lsbCBhbHdheXMgYmUgdGhydXN0LgogICAgICAgICAgICAgICAgY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zID0gYWxsQ29udmVudGlvbnM7CgogICAgICAgICAgICAgICAgLy8gRXh0ZW5kIHRocnVzdCB3aXRoIHRoZSBzcGVjCiAgICAgICAgICAgICAgICBleHRlbmQoY3VycmVudFBsdWdpbiwgc3BlYyk7CgogICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBpbmRleCBvZiB0aGUgZ2l2ZW4gbW9kdWxlcy4KICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbmRleCA9IGFyZ3VtZW50cy5sZW5ndGggLSAobW9kdWxlcy5sZW5ndGggKyAxKSwKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgbW9kdWxlIGNyZWF0ZXIgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICBNb2R1bGUgPSBhcmd1bWVudHNbbW9kdWxlSW5kZXhdLAogICAgICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgZGVmaW5pdGlvbnMKICAgICAgICAgICAgICAgICAgICBtb2R1bGVEZWZpbml0aW9ucyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCBtb2R1bGVJbmRleCArIDEpLAogICAgICAgICAgICAgICAgICAgIC8vIEFzc2lnbiB0aHJ1c3QKICAgICAgICAgICAgICAgICAgICB0aHJ1c3QgPSBjdXJyZW50UGx1Z2luOwoKICAgICAgICAgICAgICAgIC8vIExvb3Agb3ZlciBhbGwgdGhlIG1vZHVsZXMKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbW9kdWxlcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBtb2R1bGUgbmFtZQogICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGUgPSBtb2R1bGVzW2ldLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIGRlZmluaXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvbiA9IG1vZHVsZURlZmluaXRpb25zW2ldOwoKICAgICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgdGhlIGluc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUluc3RhbmNlID0gbmV3IE1vZHVsZSh0aHJ1c3QsIGRlZmluaXRpb24sIG1vZHVsZSk7CiAgICAgICAgICAgICAgICAgICAgLy8gSW5qZWN0IGl0IGludG8gdGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgICAgICAgICAgICAgIG1vZHVsZUluc3RhbmNlLnRocnVzdENyZWF0ZSh0aHJ1c3QpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoc3BlYyk7CiAgICAgICAgICAgIH0sIGRlZmVyLnJlamVjdCk7CgogICAgICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgICAgICB9CiAgICB9Owp9KTsKOyhmdW5jdGlvbihnKXsKCiAgICAvLyBzdW1tYXJ5OiBBIHNpbXBsZSBmZWF0dXJlIGRldGVjdGlvbiBmdW5jdGlvbi9mcmFtZXdvcmsuCiAgICAvLwogICAgLy8gbmFtZTogU3RyaW5nCiAgICAvLyAgICAgIFRoZSBuYW1lIG9mIHRoZSBmZWF0dXJlIHRvIGRldGVjdCwgYXMgZGVmaW5lZCBieSB0aGUgb3ZlcmFsbCBgaGFzYCB0ZXN0cy4KICAgIC8vICAgICAgVGVzdHMgY2FuIGJlIHJlZ2lzdGVyZWQgdmlhIGBoYXMuYWRkKHRlc3RuYW1lLCB0ZXN0ZnVuY3Rpb24pYC4KICAgIC8vCiAgICAvLyBleGFtcGxlOgogICAgLy8gICAgICBteWxpYnJhcnkuYmluZCA9IGhhcygibmF0aXZlLWJpbmQiKSA/IGZ1bmN0aW9uKGZuLCBjb250ZXh0KXsKICAgIC8vICAgICAgICAgIHJldHVybiBmbi5iaW5kKGNvbnRleHQpOwogICAgLy8gICAgICB9IDogZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgLy8gICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAvLyAgICAgICAgICAgICAgZm4uYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTsKICAgIC8vICAgICAgICAgIH0KICAgIC8vICAgICAgfQoKICAgIHZhciBOT05fSE9TVF9UWVBFUyA9IHsgImJvb2xlYW4iOiAxLCAibnVtYmVyIjogMSwgInN0cmluZyI6IDEsICJ1bmRlZmluZWQiOiAxIH0sCiAgICAgICAgVkVORE9SX1BSRUZJWEVTID0gWyJXZWJraXQiLCAiTW96IiwgIk8iLCAibXMiLCAiS2h0bWwiXSwKICAgICAgICBkID0gaXNIb3N0VHlwZShnLCAiZG9jdW1lbnQiKSAmJiBnLmRvY3VtZW50LAogICAgICAgIGVsID0gZCAmJiBpc0hvc3RUeXBlKGQsICJjcmVhdGVFbGVtZW50IikgJiYgZC5jcmVhdGVFbGVtZW50KCJEaVYiKSwKICAgICAgICBmcmVlRXhwb3J0cyA9IHR5cGVvZiBleHBvcnRzID09ICJvYmplY3QiICYmIGV4cG9ydHMsCiAgICAgICAgZnJlZU1vZHVsZSA9IHR5cGVvZiBtb2R1bGUgPT0gIm9iamVjdCIgJiYgbW9kdWxlLAogICAgICAgIHRlc3RDYWNoZSA9IHt9CiAgICA7CgogICAgZnVuY3Rpb24gaGFzKC8qIFN0cmluZyAqL25hbWUpewogICAgICAgIGlmKHR5cGVvZiB0ZXN0Q2FjaGVbbmFtZV0gPT0gImZ1bmN0aW9uIil7CiAgICAgICAgICAgIHRlc3RDYWNoZVtuYW1lXSA9IHRlc3RDYWNoZVtuYW1lXShnLCBkLCBlbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0ZXN0Q2FjaGVbbmFtZV07IC8vIEJvb2xlYW4KICAgIH0KCiAgICBmdW5jdGlvbiBhZGQoLyogU3RyaW5nICovbmFtZSwgLyogRnVuY3Rpb24gKi90ZXN0LCAvKiBCb29sZWFuPyAqL25vdyl7CiAgICAgICAgLy8gc3VtbWFyeTogUmVnaXN0ZXIgYSBuZXcgZmVhdHVyZSBkZXRlY3Rpb24gdGVzdCBmb3Igc29tZSBuYW1lZCBmZWF0dXJlCiAgICAgICAgLy8KICAgICAgICAvLyBuYW1lOiBTdHJpbmcKICAgICAgICAvLyAgICAgIFRoZSBuYW1lIG9mIHRoZSBmZWF0dXJlIHRvIHRlc3QuCiAgICAgICAgLy8KICAgICAgICAvLyB0ZXN0OiBGdW5jdGlvbgogICAgICAgIC8vICAgICAgQSB0ZXN0IGZ1bmN0aW9uIHRvIHJlZ2lzdGVyLiBJZiBhIGZ1bmN0aW9uLCBxdWV1ZWQgZm9yIHRlc3RpbmcgdW50aWwgYWN0dWFsbHkKICAgICAgICAvLyAgICAgIG5lZWRlZC4gVGhlIHRlc3QgZnVuY3Rpb24gc2hvdWxkIHJldHVybiBhIGJvb2xlYW4gaW5kaWNhdGluZwogICAgICAgIC8vICAgICAgdGhlIHByZXNlbmNlIG9mIGEgZmVhdHVyZSBvciBidWcuCiAgICAgICAgLy8KICAgICAgICAvLyBub3c6IEJvb2xlYW4/CiAgICAgICAgLy8gICAgICBPcHRpb25hbC4gT21pdCBpZiBgdGVzdGAgaXMgbm90IGEgZnVuY3Rpb24uIFByb3ZpZGVzIGEgd2F5IHRvIGltbWVkaWF0ZWx5CiAgICAgICAgLy8gICAgICBydW4gdGhlIHRlc3QgYW5kIGNhY2hlIHRoZSByZXN1bHQuCiAgICAgICAgLy8gZXhhbXBsZToKICAgICAgICAvLyAgICAgIEEgcmVkdW5kYW50IHRlc3QsIHRlc3RGbiB3aXRoIGltbWVkaWF0ZSBleGVjdXRpb246CiAgICAgICAgLy8gIHwgICAgICAgaGFzLmFkZCgiamF2YXNjcmlwdCIsIGZ1bmN0aW9uKCl7IHJldHVybiB0cnVlOyB9LCB0cnVlKTsKICAgICAgICAvLwogICAgICAgIC8vIGV4YW1wbGU6CiAgICAgICAgLy8gICAgICBBZ2FpbiB3aXRoIHRoZSByZWR1bmRhbnRuZXNzLiBZb3UgY2FuIGRvIHRoaXMgaW4geW91ciB0ZXN0cywgYnV0IHdlIHNob3VsZAogICAgICAgIC8vICAgICAgbm90IGJlIGRvaW5nIHRoaXMgaW4gYW55IGludGVybmFsIGhhcy5qcyB0ZXN0cwogICAgICAgIC8vICB8ICAgICAgIGhhcy5hZGQoImphdmFzY3JpcHQiLCB0cnVlKTsKICAgICAgICAvLwogICAgICAgIC8vIGV4YW1wbGU6CiAgICAgICAgLy8gICAgICBUaHJlZSB0aGluZ3MgYXJlIHBhc3NlZCB0byB0aGUgdGVzdEZ1bmN0aW9uLiBgZ2xvYmFsYCwgYGRvY3VtZW50YCwgYW5kIGEgZ2VuZXJpYyBlbGVtZW50CiAgICAgICAgLy8gICAgICBmcm9tIHdoaWNoIHRvIHdvcmsgeW91ciB0ZXN0IHNob3VsZCB0aGUgbmVlZCBhcmlzZS4KICAgICAgICAvLyAgfCAgICAgICBoYXMuYWRkKCJidWctYnlpZCIsIGZ1bmN0aW9uKGcsIGQsIGVsKXsKICAgICAgICAvLyAgfCAgICAgICAgICAgLy8gZyAgPT0gZ2xvYmFsLCB0eXBpY2FsbHkgd2luZG93LCB5YWRkYSB5YWRkYQogICAgICAgIC8vICB8ICAgICAgICAgICAvLyBkICA9PSBkb2N1bWVudCBvYmplY3QKICAgICAgICAvLyAgfCAgICAgICAgICAgLy8gZWwgPT0gdGhlIGdlbmVyaWMgZWxlbWVudC4gYSBgaGFzYCBlbGVtZW50LgogICAgICAgIC8vICB8ICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGZha2UgdGVzdCwgYnlpZC13aGVuLWZvcm0taGFzLW5hbWUtbWF0Y2hpbmctYW4taWQgaXMgc2xpZ2h0bHkgbG9uZ2VyCiAgICAgICAgLy8gIHwgICAgICAgfSk7CiAgICAgICAgdGVzdENhY2hlW25hbWVdID0gbm93ID8gdGVzdChnLCBkLCBlbCkgOiB0ZXN0OwogICAgfQoKICAgIC8vIGNzc3Byb3AgYWRhcHRlZCBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTk4MDA4ICh0aGFua3MsIF5waSkKICAgIGZ1bmN0aW9uIGNzc3Byb3AobmFtZSwgZWwpewogICAgICAgIHZhciBzdXBwb3J0ZWQgPSBmYWxzZSwKICAgICAgICAgICAgY2FwaXRhbGl6ZWQgPSBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwKICAgICAgICAgICAgbGVuZ3RoID0gVkVORE9SX1BSRUZJWEVTLmxlbmd0aCwKICAgICAgICAgICAgc3R5bGUgPSBlbC5zdHlsZTsKCiAgICAgICAgaWYodHlwZW9mIHN0eWxlW25hbWVdID09ICJzdHJpbmciKXsKICAgICAgICAgICAgc3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgd2hpbGUobGVuZ3RoLS0pewogICAgICAgICAgICAgICAgaWYodHlwZW9mIHN0eWxlW1ZFTkRPUl9QUkVGSVhFU1tsZW5ndGhdICsgY2FwaXRhbGl6ZWRdID09ICJzdHJpbmciKXsKICAgICAgICAgICAgICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdXBwb3J0ZWQ7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYXJFbGVtZW50KGVsKXsKICAgICAgICBpZihlbCl7CiAgICAgICAgICAgIHdoaWxlKGVsLmxhc3RDaGlsZCl7CiAgICAgICAgICAgICAgICBlbC5yZW1vdmVDaGlsZChlbC5sYXN0Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbDsKICAgIH0KCiAgICAvLyBIb3N0IG9iamVjdHMgY2FuIHJldHVybiB0eXBlIHZhbHVlcyB0aGF0IGFyZSBkaWZmZXJlbnQgZnJvbSB0aGVpciBhY3R1YWwKICAgIC8vIGRhdGEgdHlwZS4gVGhlIG9iamVjdHMgd2UgYXJlIGNvbmNlcm5lZCB3aXRoIHVzdWFsbHkgcmV0dXJuIG5vbi1wcmltaXRpdmUKICAgIC8vIHR5cGVzIG9mIG9iamVjdCwgZnVuY3Rpb24sIG9yIHVua25vd24uCiAgICBmdW5jdGlvbiBpc0hvc3RUeXBlKG9iamVjdCwgcHJvcGVydHkpewogICAgICAgIHZhciB0eXBlID0gdHlwZW9mIG9iamVjdFtwcm9wZXJ0eV07CiAgICAgICAgcmV0dXJuIHR5cGUgPT0gIm9iamVjdCIgPyAhIW9iamVjdFtwcm9wZXJ0eV0gOiAhTk9OX0hPU1RfVFlQRVNbdHlwZV07CiAgICB9CgogICAgICAgIGhhcy5hZGQgPSBhZGQ7CiAgICBoYXMuY2xlYXJFbGVtZW50ID0gY2xlYXJFbGVtZW50OwogICAgaGFzLmNzc3Byb3AgPSBjc3Nwcm9wOwogICAgaGFzLmlzSG9zdFR5cGUgPSBpc0hvc3RUeXBlOwogICAgaGFzLl90ZXN0cyA9IHRlc3RDYWNoZTsKCiAgICBoYXMuYWRkKCJkb20iLCBmdW5jdGlvbihnLCBkLCBlbCl7CiAgICAgICAgcmV0dXJuIGQgJiYgZWwgJiYgaXNIb3N0VHlwZShnLCAibG9jYXRpb24iKSAmJiBpc0hvc3RUeXBlKGQsICJkb2N1bWVudEVsZW1lbnQiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGQsICJnZXRFbGVtZW50QnlJZCIpICYmIGlzSG9zdFR5cGUoZCwgImdldEVsZW1lbnRzQnlOYW1lIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShkLCAiZ2V0RWxlbWVudHNCeVRhZ05hbWUiKSAmJiBpc0hvc3RUeXBlKGQsICJjcmVhdGVDb21tZW50IikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShkLCAiY3JlYXRlRWxlbWVudCIpICYmIGlzSG9zdFR5cGUoZCwgImNyZWF0ZVRleHROb2RlIikgJiYKICAgICAgICAgICAgaXNIb3N0VHlwZShlbCwgImFwcGVuZENoaWxkIikgJiYgaXNIb3N0VHlwZShlbCwgImluc2VydEJlZm9yZSIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZWwsICJyZW1vdmVDaGlsZCIpICYmIGlzSG9zdFR5cGUoZWwsICJnZXRBdHRyaWJ1dGUiKSAmJgogICAgICAgICAgICBpc0hvc3RUeXBlKGVsLCAic2V0QXR0cmlidXRlIikgJiYgaXNIb3N0VHlwZShlbCwgInJlbW92ZUF0dHJpYnV0ZSIpICYmCiAgICAgICAgICAgIGlzSG9zdFR5cGUoZWwsICJzdHlsZSIpICYmIHR5cGVvZiBlbC5zdHlsZS5jc3NUZXh0ID09ICJzdHJpbmciOwogICAgfSk7CgogICAgLy8gU3RvcCByZXBlYXQgYmFja2dyb3VuZC1pbWFnZSByZXF1ZXN0cyBhbmQgcmVkdWNlIG1lbW9yeSBjb25zdW1wdGlvbiBpbiBJRTYgU1AxCiAgICAvLyBodHRwOi8vbWlzdGVycGl4ZWwuYmxvZ3Nwb3QuY29tLzIwMDYvMDkvZm9yZW5zaWMtYW5hbHlzaXMtb2YtaWU2Lmh0bWwKICAgIC8vIGh0dHA6Ly9ibG9ncy5tc2RuLmNvbS9iL2N3aWxzby9hcmNoaXZlLzIwMDYvMTEvMDcvaWUtcmUtZG93bmxvYWRpbmctYmFja2dyb3VuZC1pbWFnZXMuYXNweD9QYWdlSW5kZXg9MQogICAgLy8gaHR0cDovL3N1cHBvcnQubWljcm9zb2Z0LmNvbS9rYi84MjM3MjcKICAgIHRyeXsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiQmFja2dyb3VuZEltYWdlQ2FjaGUiLCBmYWxzZSwgdHJ1ZSk7CiAgICB9Y2F0Y2goZSl7fQoKICAgIC8vIEV4cG9zZSBoYXMoKQogICAgLy8gc29tZSBBTUQgYnVpbGQgb3B0aW1pemVycywgbGlrZSByLmpzLCBjaGVjayBmb3Igc3BlY2lmaWMgY29uZGl0aW9uIHBhdHRlcm5zIGxpa2UgdGhlIGZvbGxvd2luZzoKICAgIGlmKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PSAib2JqZWN0IiAmJiBkZWZpbmUuYW1kKXsKICAgICAgICBkZWZpbmUoImhhcyIsW10sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiBoYXM7CiAgICAgICAgfSk7CiAgICB9CiAgICAvLyBjaGVjayBmb3IgYGV4cG9ydHNgIGFmdGVyIGBkZWZpbmVgIGluIGNhc2UgYSBidWlsZCBvcHRpbWl6ZXIgYWRkcyBhbiBgZXhwb3J0c2Agb2JqZWN0CiAgICBlbHNlIGlmKGZyZWVFeHBvcnRzKXsKICAgICAgICAvLyBpbiBOb2RlLmpzIG9yIFJpbmdvSlMgdjAuOC4wKwogICAgICAgIGlmKGZyZWVNb2R1bGUgJiYgZnJlZU1vZHVsZS5leHBvcnRzID09IGZyZWVFeHBvcnRzKXsKICAgICAgICAgIChmcmVlTW9kdWxlLmV4cG9ydHMgPSBoYXMpLmhhcyA9IGhhczsKICAgICAgICB9CiAgICAgICAgLy8gaW4gTmFyd2hhbCBvciBSaW5nb0pTIHYwLjcuMC0KICAgICAgICBlbHNlewogICAgICAgICAgZnJlZUV4cG9ydHMuaGFzID0gaGFzOwogICAgICAgIH0KICAgIH0KICAgIC8vIGluIGEgYnJvd3NlciBvciBSaGlubwogICAgZWxzZXsKICAgICAgICAvLyB1c2Ugc3F1YXJlIGJyYWNrZXQgbm90YXRpb24gc28gQ2xvc3VyZSBDb21waWxlciB3b24ndCBtdW5nZSBgaGFzYAogICAgICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vY2xvc3VyZS9jb21waWxlci9kb2NzL2FwaS10dXRvcmlhbDMuaHRtbCNleHBvcnQKICAgICAgICBnWyJoYXMiXSA9IGhhczsKICAgIH0KfSkodGhpcyk7CgpkZWZpbmUoJ3RocnVzdC9tb2R1bGUnLFsndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICdoYXMnXSwKZnVuY3Rpb24gKHV0aWwsIGxvZywgaGFzKQp7CiAgICB2YXIgdHlwZSA9IHV0aWwudHlwZSwKICAgICAgICBmb3JtYXQgPSB1dGlsLmZvcm1hdCwKICAgICAgICBpc09iamVjdCA9IHV0aWwuaXNPYmplY3QsCiAgICAgICAgZXh0ZW5kID0gdXRpbC5leHRlbmQsCiAgICAgICAgd2hlbiA9IHV0aWwud2hlbiwKICAgICAgICB0aHJ1c3RDYWNoZSA9IHt9LAogICAgICAgIC8qKgogICAgICAgIE1vdmVzIGFsbCBwcm9wZXJ0aWVzLCB0aGF0IHNob3VsZCBleGlzdCBvdXRzaWRlIG9mIHRoZSBtb2R1bGUsIGludG8gYSBwcml2YXRlIG9iamVjdCBmb3IgaG9sZGluZy4KCiAgICAgICAgQG1ldGhvZCBtb3ZlVG9UaHJ1c3RDYWNoZQogICAgICAgIEBwcml2YXRlCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZyb20gT2JqZWN0IHRvIGV4dHJhY3QgaXRlbXMgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSB0byBPYmplY3QgdG8gcGxhY2UgaXRlbXMgb24KICAgICAgICBAcGFyYW0ge0FycmF5fSBsaXN0IEl0ZW1zIHRvIG1vdmUgZnJvbSB0byB0aGUgb3RoZXIgb2JqZWN0CiAgICAgICAgKiovCiAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUgPSBmdW5jdGlvbiAoZnJvbSwgdG8sIGxpc3QpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGxpc3QubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0b1tsaXN0W2ldXSA9IGZyb21bbGlzdFtpXV07CiAgICAgICAgICAgICAgICBkZWxldGUgZnJvbVtsaXN0W2ldXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2V0RXZlbnROYW1lc3BhY2UgPSBmdW5jdGlvbiAobmFtZSwgcHJlZml4KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFwcmVmaXgpIHByZWZpeCA9ICdtb2R1bGUtJzsgcmV0dXJuICcuJyArIChuYW1lID09PSAnZ2xvYmFsJyA/ICdnbG9iYWwnIDogcHJlZml4ICsgbmFtZS5yZXBsYWNlKC9cLi9nLCAnLScpKTsKICAgICAgICB9LAogICAgICAgIF9fb3B0aW9uYWxNZXRob2RzID0gWyAgICAgLy8gT3B0aW9uYWwgbWV0aG9kcyB0aGF0IG1heSBiZSBvbiBhIG1vZHVsZQogICAgICAgICAgICAnc3RhcnQnLAogICAgICAgICAgICAnc3RvcCcsCiAgICAgICAgICAgICdyZWFkeScKICAgICAgICBdOwoKICAgIC8qKgogICAgVGhlIG1vZHVsZSBpcyB0aGUgaGVhcnQgb2YgdGhlIHRocnVzdCwgZXZlcnkgbW9kdWxlIGdldHMgb25lIGZhY2FkZSBwZXIgbW9kdWxlLgoKICAgIEBjbGFzcyBNb2R1bGUKICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgQHBhcmFtIHtPYmplY3R9IGRlZiBUaGUgbW9kdWxlIGRlZmluaXRpb24KICAgIEBwYXJhbSB7U3RyaW5nfSBbbmFtZV0gVGhlIG1vZHVsZSBuYW1lLgogICAgKiovCiAgICB2YXIgTW9kdWxlID0gZnVuY3Rpb24gKC8qICRyZWYgKi8gdGhydXN0LCBkZWYsIG5hbWUpCiAgICB7CiAgICAgICAgbmFtZSA9IHRoaXMubmFtZSA9IChuYW1lIHx8IGRlZi5uYW1lKTsKICAgICAgICB2YXIgbWlkID0gdGhpcy5taWQgPSB0aHJ1c3QubmFtZSArICc6JyArIG5hbWU7CiAgICAgICAgdGhpcy5pbnN0YW5jZSA9IGV4dGVuZChkZWYsIHRocnVzdENhY2hlW21pZF0gJiYgdGhydXN0Q2FjaGVbbWlkXS5pbnN0YW5jZSB8fCB7fSk7CiAgICAgICAgdGhpcy5pbnN0YW5jZS5uYW1lID0gKHRoaXMuaW5zdGFuY2UubmFtZSB8fCBuYW1lKTsKICAgICAgICB0aGlzLmluc3RhbmNlLm1pZCA9IG1pZDsKCiAgICAgICAgaWYgKCF0aGlzLmluc3RhbmNlLm5hbWUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQWxsIE1vZHVsZXMgbXVzdCBoYXZlIGEgbmFtZSEnKTsKCiAgICAgICAgLy8gTW9kdWxlcyBtdXN0IGhhdmUgYW4gaW5pdCBtZXRob2QgYW5kIGEgZGVzdHJveSBtZXRob2QsIGl0J3MgdXAgdG8gdGhlIG1vZHVsZSBkZXZlbG9wZXIgdG8gcG9wdWxhdGUgdGhlc2UgbWV0aG9kcy4KICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IHRocnVzdC5fX3JlcXVpcmVkTWV0aG9kcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgIGlmICghZGVmW3RocnVzdC5fX3JlcXVpcmVkTWV0aG9kc1tpXV0pCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdSZXF1aXJlZCAiezB9IiBtZXRob2Qgbm90IGZvdW5kIG9uIG1vZHVsZSAiezF9IiEnLCB0aHJ1c3QuX19yZXF1aXJlZE1ldGhvZHNbaV0sIG5hbWUpKTsKCiAgICAgICAgLy8gSWYgdGhlIG1vZHVsZSBuYW1lIGlzIHVuZGVmaW5lZCwgYnJpbmcgdGhlIG5hbWUgaW50byB0aGUgbW9kdWxlLgogICAgICAgIGlmICh0eXBlb2YgZGVmLm5hbWUgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICBkZWYubmFtZSA9IG5hbWU7CgogICAgICAgIHZhciB0aHJ1c3RNb2R1bGUgPSB0aHJ1c3RDYWNoZVttaWRdID0gZXh0ZW5kKHRocnVzdENhY2hlW21pZF0gfHwge30gLCB7CiAgICAgICAgICAgIF9zdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgbmFtZTogdXRpbC5nZXRNb2R1bGVOYW1lRm9yUGF0aChuYW1lKSwKICAgICAgICAgICAgbW9kdWxlOiB0aGlzCiAgICAgICAgfSk7CgogICAgICAgIHZhciBmYWNhZGVzID0gdGhydXN0TW9kdWxlLmZhY2FkZXMgfHwgKHRocnVzdE1vZHVsZS5mYWNhZGVzID0ge30pOwogICAgICAgIGlmICghdGhydXN0Ll9fY29udmVudGlvblBsdWNrUHJvcGVydGllc0NhY2hlKSB0aHJ1c3QuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUgPSB1dGlsLmZsYXR0ZW4odXRpbC5wbHVjayh0aHJ1c3QuX19jb252ZW50aW9ucyB8fCBbXSwgJ3Byb3BlcnRpZXMnKSk7CgogICAgICAgIC8vIE1vdmUgYWxsIHNwZWNpYWwgcHJvcGVydGllcyBvZmYgdG8gdGhlIHRocnVzdCdzIGludGVybmFsIG1ldGhvZC4KICAgICAgICBtb3ZlVG9UaHJ1c3RDYWNoZSh0aGlzLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGUsIHRocnVzdC5fX3JlcXVpcmVkTWV0aG9kcyk7CiAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlLCBfX29wdGlvbmFsTWV0aG9kcyk7CiAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlLCB0aHJ1c3QuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUpOwoKICAgICAgICB1dGlsLnNhZmVJbnZva2UodGhydXN0LCAnY3JlYXRlRmFjYWRlJywgdGhydXN0LCB0aGlzLmluc3RhbmNlLCBmYWNhZGVzKTsKCiAgICAgICAgdGhpcy5fX25hbWVzcGFjZSA9IGdldEV2ZW50TmFtZXNwYWNlKHRoaXMuaW5zdGFuY2UubmFtZSk7CgogICAgICAgIHRoaXMudGhydXN0ID0gdGhydXN0OwogICAgfTsKCiAgICB2YXIgY2FsbEZhY2FkZU1ldGhvZHMgPSBmdW5jdGlvbiAobWV0aG9kLCBtaWQpCiAgICB7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICBmb3IgKHZhciBpIGluIHRocnVzdENhY2hlW21pZF0uZmFjYWRlcykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBtb2R1bGVDYWNoZSA9IHRocnVzdENhY2hlW21pZF0sCiAgICAgICAgICAgICAgICBmYWNhZGUgPSBtb2R1bGVDYWNoZS5mYWNhZGVzW2ldOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ3RocnVzdC9tb2R1bGU6IENhbGxpbmcgZmFjYWRlICJ7MH0iIHsxfSgpJywgaSwgbWV0aG9kKSk7CiAgICAgICAgICAgIGlmIChmYWNhZGVbbWV0aG9kXSAmJiBpc09iamVjdChmYWNhZGUpKQogICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGZhY2FkZVttZXRob2RdLmNhbGwoZmFjYWRlLCB0aHJ1c3RDYWNoZVttaWRdLm1vZHVsZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgIH07CgogICAgTW9kdWxlLnByb3RvdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICBHZXR0ZXIvU2V0dGVyIGZvciBjb252ZW50aW9uIG1ldGhvZHMuCiAgICAgICAgR2V0cyB0aGUgdmFsdWUgY29udmVudGlvbiBwcm9wZXJ0eSAoZGVmaW5lZCBpbiB0aGUgcHJvcGVydGllcyBhcnJheSBvZiBhIGZhY2FkZSkuCiAgICAgICAgU2V0cyB0aGUgdmFsdWUgb2YgYSBjb252ZW50aW9uIHByb3BlcnR5IChmb3Igc3RvcmluZyBjb252ZW50aW9uIGNvbmZpZ3VyYXRpb24pCgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eSBUaGUgcHJvcGVydHkgdG8gZ2V0IG9yIHNldAogICAgICAgIEBwYXJhbSB7b2JqZWN0fSBbdmFsdWVdIFRoZSB2YWx1ZSB0byBzZXQKICAgICAgICBAbWV0aG9kIGNvbnZlbnRpb24KICAgICAgICBAcmV0dXJucyB7T2JqZWN0fSBUaGUgdmFsYXVlLgogICAgICAgICoqLwogICAgICAgIGNvbnZlbnRpb246IGZ1bmN0aW9uIChwcm9wZXJ0eSwgdmFsdWUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhydXN0Q2FjaGVbdGhpcy5taWRdW3Byb3BlcnR5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aHJ1c3RDYWNoZVt0aGlzLm1pZF1bcHJvcGVydHldOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgSW5qZWN0cyB0aGlzIG1vZHVsZSBpbnRvIHRoZSBnaXZlbiB0aHJ1c3QgaW5zdGFuY2UuCgogICAgICAgIEBtZXRob2QgdGhydXN0Q3JlYXRlCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIHRocnVzdENyZWF0ZTogZnVuY3Rpb24gKHRocnVzdCkKICAgICAgICB7CiAgICAgICAgICAgIHRocnVzdC5fX2luamVjdE1vZHVsZSh0aGlzKTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIE1ha2VzIGEgY2FsbCB0byBhbGwgdGhlIG1vZHVsZXMgZmFjYWRlcwogICAgICAgIFRoZSBvcmRlciBvZiB0aGUgY2FsbCBkZXBlbmRzIG9uIHRoZSBvcmRlciByZXF1aXJlZC4KICAgICAgICBEdXJpbmcgdGhlIHN0YXJ0dXAgc3RhZ2UgKGluaXQsIHN0YXJ0LCByZWFkeSkgZmFjYWRlcyBhcmUgY2FsbGVkIGZpcnN0LgogICAgICAgIER1cmluZyB0aGUgc2h1dGRvd24gc3RhdGUgKHN0b3AsIGRlc3Ryb3kpIGZhY2FkZXMgYXJlIGNhbGxlZCBsYXN0LgogICAgICAgIFRoaXMgYWxsb3dzIG1vZHVsZXMgdG8gc3RhcnR1cCBhbmQgc2h1dGRvd24gd2lsbCBhbGwgdGhlIHRvb2xzIGl0IGhhZCB0byBiZWdpbiB3aXRoLgoKICAgICAgICBAbWV0aG9kIHRocnVzdENhbGwKICAgICAgICBAcHJvdGVjdGVkCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCB0aGUgbWV0aG9kIHRvIGNhbGwKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IGZhY2FkZUFmdGVyIGNhbGxzIGZhY2FkZSBtZXRob2RzIGJlZm9yZSBvciBhZnRlciBtb2R1bGUgbWV0aG9kLgogICAgICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgQXJncyB0byBiZSBwYXNzZWQgb250byB0aGUgbW9kdWxlIG1ldGhvZC4KICAgICAgICAqKi8KICAgICAgICB0aHJ1c3RDYWxsOiBmdW5jdGlvbiAobWV0aG9kLCBmYWNhZGVBZnRlciwgYXJncykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKSwKICAgICAgICAgICAgICAgIHJlc3VsdHMsCiAgICAgICAgICAgICAgICB0aGF0ID0gdGhpczsKCiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgndGhydXN0L21vZHVsZTogQ2FsbGluZyBmYWNhZGVzIGZvciAiezB9IicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICB2YXIgbSA9IHRocnVzdENhY2hlW3RoYXQubWlkXVttZXRob2RdOwogICAgICAgICAgICBpZiAoIWZhY2FkZUFmdGVyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXN1bHRzID0gY2FsbEZhY2FkZU1ldGhvZHMobWV0aG9kLCB0aGF0Lm1pZCk7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0cykKICAgICAgICAgICAgICAgICAgICB3aGVuLmNoYWluKHdoZW4uYWxsKHV0aWwuZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0cykpLCBkZWZlcik7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSgpOwoKICAgICAgICAgICAgICAgIGlmIChtKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXdEZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICBkZWZlci50aGVuKGZ1bmN0aW9uICgpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gbS5hcHBseSh0aGF0Lmluc3RhbmNlLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoZW4uY2hhaW4od2hlbi5hbGwodXRpbC5mbGF0dGVuVG9Qcm9taXNlcyhyZXN1bHQpKSwgbmV3RGVmZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdEZWZlci5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgZGVmZXIgPSBuZXdEZWZlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBtID0gdGhydXN0Q2FjaGVbdGhhdC5taWRdW21ldGhvZF07CiAgICAgICAgICAgICAgICBpZiAobSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRzID0gbS5hcHBseSh0aGF0Lmluc3RhbmNlLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0cykKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbi5jaGFpbih3aGVuLmFsbCh1dGlsLmZsYXR0ZW5Ub1Byb21pc2VzKHJlc3VsdHMpKSwgZGVmZXIpOwogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoKTsKCiAgICAgICAgICAgICAgICB2YXIgbmV3RGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgICAgICBkZWZlci50aGVuKGZ1bmN0aW9uICgpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxGYWNhZGVNZXRob2RzKG1ldGhvZCwgdGhhdC5taWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHdoZW4uY2hhaW4od2hlbi5hbGwodXRpbC5mbGF0dGVuVG9Qcm9taXNlcyhyZXN1bHQpKSwgbmV3RGVmZXIpOwogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGVmZXIucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBkZWZlciA9IG5ld0RlZmVyOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIFN0YXJ0IHRoZSBtb2R1bGUsIGluc2lkZSB0aGUgdGhydXN0IGNvbnRhaW5lciBpdCB3YXMgY3JlYXRlZCBvbi4KCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIHN0YXJ0OiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LnRocnVzdC5zdGFydCh0aGF0Lm5hbWUpOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgU3RvcCB0aGUgbW9kdWxlLCBpbnNpZGUgdGhlIHRocnVzdCBjb250YWluZXIgaXQgd2FzIGNyZWF0ZWQgb24uCgogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAqKi8KICAgICAgICBzdG9wOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LnRocnVzdC5zdG9wKHRoYXQubmFtZSk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKCiAgICBIYW5kbGVzIGZldGNoaW5nIG9mIGEgbW9kdWxlIGluc3RhbmNlCgogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgTW9kdWxlLmxvYWQgPSBmdW5jdGlvbiAobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKQogICAgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwKICAgICAgICAgICAgaW5zdGFuY2VOYW1lID0gcGFydHNbMF0sCiAgICAgICAgICAgIG1vZHVsZU5hbWUgPSBwYXJ0c1sxXTsKCiAgICAgICAgcmVxdWlyZShbJ3RocnVzdCEnICsgaW5zdGFuY2VOYW1lXSwgZnVuY3Rpb24gKHRocnVzdCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSB0aHJ1c3QubW9kdWxlc1ttb2R1bGVOYW1lXTsKICAgICAgICAgICAgaWYgKCFtb2R1bGUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdNb2R1bGUgInswfSIgZG9lcyBub3QgZXhpc3Qgb24gdGhydXN0IGluc3RhbmNlICJ7MX0iLicsIG1vZHVsZU5hbWUsIGluc3RhbmNlTmFtZSkpOwoKICAgICAgICAgICAgbG9hZChtb2R1bGUpOwogICAgICAgIH0pOwogICAgfTsKCiAgICBNb2R1bGUudGhydXN0Q2FjaGUgPSB0aHJ1c3RDYWNoZTsKCiAgICByZXR1cm4gTW9kdWxlOwp9KTsKLyoqCiAqIEBsaWNlbnNlIFJlcXVpcmVKUyBkb21SZWFkeSAyLjAuMCBDb3B5cmlnaHQgKGMpIDIwMTAtMjAxMiwgVGhlIERvam8gRm91bmRhdGlvbiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKiBBdmFpbGFibGUgdmlhIHRoZSBNSVQgb3IgbmV3IEJTRCBsaWNlbnNlLgogKiBzZWU6IGh0dHA6Ly9naXRodWIuY29tL3JlcXVpcmVqcy9kb21SZWFkeSBmb3IgZGV0YWlscwogKi8KLypqc2xpbnQgKi8KLypnbG9iYWwgcmVxdWlyZTogZmFsc2UsIGRlZmluZTogZmFsc2UsIHJlcXVpcmVqczogZmFsc2UsCiAgd2luZG93OiBmYWxzZSwgY2xlYXJJbnRlcnZhbDogZmFsc2UsIGRvY3VtZW50OiBmYWxzZSwKICBzZWxmOiBmYWxzZSwgc2V0SW50ZXJ2YWw6IGZhbHNlICovCgoKZGVmaW5lKCdkb21SZWFkeScsW10sZnVuY3Rpb24gKCkgewogICAgCgogICAgdmFyIGlzQnJvd3NlciA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5kb2N1bWVudCwKICAgICAgICBpc1BhZ2VMb2FkZWQgPSAhaXNCcm93c2VyLAogICAgICAgIGRvYyA9IGlzQnJvd3NlciA/IGRvY3VtZW50IDogbnVsbCwKICAgICAgICByZWFkeUNhbGxzID0gW10sCiAgICAgICAgaXNUb3AsIHRlc3REaXYsIHNjcm9sbEludGVydmFsSWQ7CgogICAgZnVuY3Rpb24gcnVuQ2FsbGJhY2tzKGNhbGxiYWNrcykgewogICAgICAgIHZhciBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY2FsbGJhY2tzW2ldKGRvYyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNhbGxSZWFkeSgpIHsKICAgICAgICB2YXIgY2FsbGJhY2tzID0gcmVhZHlDYWxsczsKCiAgICAgICAgaWYgKGlzUGFnZUxvYWRlZCkgewogICAgICAgICAgICAvL0NhbGwgdGhlIERPTSByZWFkeSBjYWxsYmFja3MKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJlYWR5Q2FsbHMgPSBbXTsKICAgICAgICAgICAgICAgIHJ1bkNhbGxiYWNrcyhjYWxsYmFja3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgcGFnZSBhcyBsb2FkZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhZ2VMb2FkZWQoKSB7CiAgICAgICAgaWYgKCFpc1BhZ2VMb2FkZWQpIHsKICAgICAgICAgICAgaXNQYWdlTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHNjcm9sbEludGVydmFsSWQpIHsKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc2Nyb2xsSW50ZXJ2YWxJZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhbGxSZWFkeSgpOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAoaXNCcm93c2VyKSB7CiAgICAgICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgLy9TdGFuZGFyZHMuIEhvb3JheSEgQXNzdW1wdGlvbiBoZXJlIHRoYXQgaWYgc3RhbmRhcmRzIGJhc2VkLAogICAgICAgICAgICAvL2l0IGtub3dzIGFib3V0IERPTUNvbnRlbnRMb2FkZWQuCiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBwYWdlTG9hZGVkLCBmYWxzZSk7CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgcGFnZUxvYWRlZCwgZmFsc2UpOwogICAgICAgIH0gZWxzZSBpZiAod2luZG93LmF0dGFjaEV2ZW50KSB7CiAgICAgICAgICAgIHdpbmRvdy5hdHRhY2hFdmVudCgib25sb2FkIiwgcGFnZUxvYWRlZCk7CgogICAgICAgICAgICB0ZXN0RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpc1RvcCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgPT09IG51bGw7CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KCiAgICAgICAgICAgIC8vRE9NQ29udGVudExvYWRlZCBhcHByb3hpbWF0aW9uIHRoYXQgdXNlcyBhIGRvU2Nyb2xsLCBhcyBmb3VuZCBieQogICAgICAgICAgICAvL0RpZWdvIFBlcmluaTogaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8sCiAgICAgICAgICAgIC8vYnV0IG1vZGlmaWVkIGJ5IG90aGVyIGNvbnRyaWJ1dG9ycywgaW5jbHVkaW5nIGpkYWx0b24KICAgICAgICAgICAgaWYgKHRlc3REaXYuZG9TY3JvbGwgJiYgaXNUb3AgJiYgd2luZG93LmV4dGVybmFsKSB7CiAgICAgICAgICAgICAgICBzY3JvbGxJbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlc3REaXYuZG9TY3JvbGwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUxvYWRlZCgpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICAgICAgICB9LCAzMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vQ2hlY2sgaWYgZG9jdW1lbnQgYWxyZWFkeSBjb21wbGV0ZSwgYW5kIGlmIHNvLCBqdXN0IHRyaWdnZXIgcGFnZSBsb2FkCiAgICAgICAgLy9saXN0ZW5lcnMuIExhdGVzdCB3ZWJraXQgYnJvd3NlcnMgYWxzbyB1c2UgImludGVyYWN0aXZlIiwgYW5kCiAgICAgICAgLy93aWxsIGZpcmUgdGhlIG9uRE9NQ29udGVudExvYWRlZCBiZWZvcmUgImludGVyYWN0aXZlIiBidXQgbm90IGFmdGVyCiAgICAgICAgLy9lbnRlcmluZyAiaW50ZXJhY3RpdmUiIG9yICJjb21wbGV0ZSIuIE1vcmUgZGV0YWlsczoKICAgICAgICAvL2h0dHA6Ly9kZXYudzMub3JnL2h0bWw1L3NwZWMvdGhlLWVuZC5odG1sI3RoZS1lbmQKICAgICAgICAvL2h0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzY2NTU2MS9kb2N1bWVudC1yZWFkeXN0YXRlLW9mLWludGVyYWN0aXZlLXZzLW9uZG9tY29udGVudGxvYWRlZAogICAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiIHx8CiAgICAgICAgICAgIGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJpbnRlcmFjdGl2ZSIpIHsKICAgICAgICAgICAgcGFnZUxvYWRlZCgpOwogICAgICAgIH0KICAgIH0KCiAgICAvKiogU1RBUlQgT0YgUFVCTElDIEFQSSAqKi8KCiAgICAvKioKICAgICAqIFJlZ2lzdGVycyBhIGNhbGxiYWNrIGZvciBET00gcmVhZHkuIElmIERPTSBpcyBhbHJlYWR5IHJlYWR5LCB0aGUKICAgICAqIGNhbGxiYWNrIGlzIGNhbGxlZCBpbW1lZGlhdGVseS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRvbVJlYWR5KGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKGlzUGFnZUxvYWRlZCkgewogICAgICAgICAgICBjYWxsYmFjayhkb2MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlYWR5Q2FsbHMucHVzaChjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkb21SZWFkeTsKICAgIH0KCiAgICBkb21SZWFkeS52ZXJzaW9uID0gJzIuMC4wJzsKCiAgICAvKioKICAgICAqIExvYWRlciBQbHVnaW4gQVBJIG1ldGhvZAogICAgICovCiAgICBkb21SZWFkeS5sb2FkID0gZnVuY3Rpb24gKG5hbWUsIHJlcSwgb25Mb2FkLCBjb25maWcpIHsKICAgICAgICBpZiAoY29uZmlnLmlzQnVpbGQpIHsKICAgICAgICAgICAgb25Mb2FkKG51bGwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvbVJlYWR5KG9uTG9hZCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKiogRU5EIE9GIFBVQkxJQyBBUEkgKiovCgogICAgcmV0dXJuIGRvbVJlYWR5Owp9KTsKCmRlZmluZSgndGhydXN0L21haW4nLFsKICAgICdyZXF1aXJlJywgJ3RocnVzdC9sb2cnLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2NvbmZpZycsICcuL2lnbml0ZScsICd0aHJ1c3QvbW9kdWxlJywgJ2RvbVJlYWR5JywgJ21vZHVsZScsICcuL2luc3RhbmNlJywgJ2hhcycKXSwKZnVuY3Rpb24gKHJlcXVpcmUsIGxvZywgdXRpbCwgdENvbmZpZywgaWduaXRlU3BlYywgTW9kdWxlLCBkb21SZWFkeSwgbW9kdWxlLCB0aHJ1c3RJbnN0YW5jZSwgaGFzKQp7CiAgICAvKioKICAgICAgICBUaGUgdGhydXN0IGFwcGxpY2F0aW9uIQoKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAbWFpbiB0aHJ1c3QKICAgICoqLwogICAgCgogICAgdmFyIElOSVQgICAgICAgICAgID0gJ2luaXQnLAogICAgICAgIFNUQVJUICAgICAgICAgID0gJ3N0YXJ0JywKICAgICAgICBSRUFEWSAgICAgICAgICA9ICdyZWFkeScsCiAgICAgICAgU1RPUCAgICAgICAgICAgPSAnc3RvcCcsCiAgICAgICAgREVTVFJPWSAgICAgICAgPSAnZGVzdHJveScsCiAgICAgICAgQ09VTlRET1dOICAgICAgPSAnY291bnRkb3duJywKICAgICAgICBJR05JVEUgICAgICAgICA9ICdpZ25pdGUnLAogICAgICAgIE9SQklUICAgICAgICAgID0gJ29yYml0JywKICAgICAgICBERU9SQklUICAgICAgICA9ICdkZW9yYml0JywKICAgICAgICBTUExBU0hET1dOICAgICA9ICdzcGxhc2hkb3duJywKICAgICAgICBtZW1vaXplICAgICAgICA9IHV0aWwubWVtb2l6ZSwKICAgICAgICBlYWNoICAgICAgICAgICA9IHV0aWwuZWFjaCwKICAgICAgICBtYXAgICAgICAgICAgICA9IHV0aWwubWFwLAogICAgICAgIHdoZW4gICAgICAgICAgID0gdXRpbC53aGVuLAogICAgICAgIHR5cGUgICAgICAgICAgID0gdXRpbC50eXBlLAogICAgICAgIGlzQXJyYXkgICAgICAgID0gdXRpbC5pc0FycmF5LAogICAgICAgIHNsaWNlICAgICAgICAgID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAogICAgICAgIHRvQXJyYXkgICAgICAgID0gdXRpbC50b0FycmF5LAogICAgICAgIGZvcm1hdCAgICAgICAgID0gdXRpbC5mb3JtYXQsCiAgICAgICAgcmVzb2x2ZU1ldGhvZHMgPSBbSU5JVCwgU1RBUlQsIFJFQURZLCBTVE9QLCBERVNUUk9ZXSwKICAgICAgICBpbnN0YW5jZXMgPSB0aHJ1c3RJbnN0YW5jZS5pbnN0YW5jZXMsCiAgICAgICAgbG9hZGluZ0luc3RhbmNlcyA9IHRocnVzdEluc3RhbmNlLmxvYWRpbmdJbnN0YW5jZXM7CgogICAgdXRpbC5kZWVwQ29weSh0Q29uZmlnLCBtb2R1bGUuY29uZmlnKCkpOwoKICAgIC8qKgogICAgICAgIFRoZSBwcmltYXJ5IHRocnVzdCBjbGFzcy4KICAgIAogICAgQGNsYXNzIFRocnVzdAogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGlzIHRocnVzdCBpbnN0YW5jZQogICAgQHJldHVybnMge1RocnVzdH0KICAgICoqLwogICAgdmFyIFRocnVzdCA9IGZ1bmN0aW9uICgvKiAkcmVmICovIG5hbWUpCiAgICB7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLm1vZHVsZXMgPSB7fTsKICAgICAgICB0aGlzLmZhaWxlZE1vZHVsZXMgPSB7fTsKICAgICAgICB0cnVlICYmIGxvZy5pbmZvKG5hbWUpOwogICAgfTsKCiAgICAvLyNyZWdpb24gUnVubmVyIEZhY3RvcmllcwogICAgdmFyIHJ1blJ1bm5lckZhY3RvcnksIHJ1bm5lckZhY3RvcnksIGFsbFJ1bm5lckZhY3Rvcnk7CiAgICBydW5SdW5uZXJGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAobWV0aG9kKQogICAgewogICAgICAgIHZhciBjb252ZW50aW9uTWV0aG9kID0gKG1ldGhvZCA9PT0gU1RPUCAmJiBTVEFSVCkgfHwgKG1ldGhvZCA9PT0gREVTVFJPWSAmJiBJTklUKSB8fCBtZXRob2QsCiAgICAgICAgICAgIGNvbnZlbnRpb25WYWx1ZSA9ICEobWV0aG9kID09PSBTVE9QIHx8IG1ldGhvZCA9PT0gREVTVFJPWSksCiAgICAgICAgICAgIHVuc2V0UmVhZHkgPSBtZXRob2QgPT09IFNUT1AsCiAgICAgICAgICAgIGNvbnZlbnRpb25DaGVjayA9IGNvbnZlbnRpb25NZXRob2QgIT09IG1ldGhvZCwKICAgICAgICAgICAgY29udmVudGlvbk5hbWUgPSBmb3JtYXQoJ3swfS1zdGF0dXMnLCBjb252ZW50aW9uTWV0aG9kKSwKICAgICAgICAgICAgcnVubmVyID0gcnVubmVyRmFjdG9yeShtZXRob2QsIGNvbnZlbnRpb25OYW1lLCBjb252ZW50aW9uVmFsdWUsIHVuc2V0UmVhZHkpLAogICAgICAgICAgICBsb2dNZXNzYWdlID0gZm9ybWF0KCgnVGhydXN0OiB7MH1pbmcgbW9kdWxlICJ7ezB9fSIgZmFpbGVkIScsIG1ldGhvZCkpLAogICAgICAgICAgICBydW5uaW5nTWVzc2FnZSA9IGZvcm1hdCgnVGhydXN0OiBSdW5uaW5nIHswfSBmb3IgbW9kdWxlICJ7ezB9fSIuJywgbWV0aG9kKTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lcykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYgKCFpc0FycmF5KG5hbWVzKSkKICAgICAgICAgICAgICAgIG5hbWVzID0gW25hbWVzXTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksCiAgICAgICAgICAgICAgICByZXN1bHRzID0gW107CiAgICAgICAgICAgIGVhY2gobmFtZXMsIGZ1bmN0aW9uIChuYW1lKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQocnVubmluZ01lc3NhZ2UsIG5hbWUpKTsKICAgICAgICAgICAgICAgIHZhciBtb2QgPSB0aGF0Lm1vZHVsZXNbbmFtZV07CgogICAgICAgICAgICAgICAgaWYgKCFtb2QgJiYgIXRoYXQuZmFpbGVkTW9kdWxlc1tuYW1lXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyB0cnkgdG8gZmV0Y2ggdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm5pbmcgdGhlIHByb3BlciBkZWZlciBpbiBpdCdzIHBsYWNlCiAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRlckRlZmVyID0gd2hlbi5kZWZlcigpOwoKICAgICAgICAgICAgICAgICAgICByZXF1aXJlKFtuYW1lXSwgZnVuY3Rpb24gKG1vZHVsZURlZm4pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmNyZWF0ZU1vZHVsZShtb2R1bGVEZWZuLm5hbWUgfHwgbmFtZSwgbW9kdWxlRGVmbik7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gcnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIFtuYW1lXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICAgICAgICAgICAgICB3aGVuLmNoYWluKHdoZW4uYWxsKHV0aWwuZmxhdHRlbihyZXN1bHQpKSwgbG9hZGVyRGVmZXIpOwogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXJEZWZlci5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChsb2FkZXJEZWZlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICgoY29udmVudGlvbkNoZWNrICYmIG1vZC5jb252ZW50aW9uKGNvbnZlbnRpb25OYW1lKSkgfHwgIW1vZC5jb252ZW50aW9uKGNvbnZlbnRpb25OYW1lKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodENvbmZpZy50aHJvd0Vycm9ycykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChydW5uZXIodGhhdCwgbmFtZSwgbW9kLCBhcmdzKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVubmVyKHRoYXQsIG5hbWUsIG1vZCwgYXJncykpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5lcnJvcihmb3JtYXQobG9nTWVzc2FnZSwgbmFtZSksIGUsIGUuc3RhY2spOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgIH07CiAgICB9KTsKCiAgICBydW5uZXJGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAobWV0aG9kLCBjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlLCB1bnNldFJlYWR5KQogICAgewogICAgICAgIHZhciBldmVudE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvezB9JywgbWV0aG9kKSwKICAgICAgICAgICAgaW5mb0Zvcm1hdCA9IGZvcm1hdCgnVGhydXN0OiB7MH1pbmcgbW9kdWxlICJ7ezB9fSInLCBtZXRob2QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBtZXRob2Quc3Vic3RyaW5nKDEpKSwKICAgICAgICAgICAgZGVidWdGb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogQ2FsbGluZyBtb2R1bGUgInt7MH19IiB7MH0oKScsIG1ldGhvZCksCiAgICAgICAgICAgIGNvbXBBZnRlciA9IG1ldGhvZCA9PT0gU1RPUCB8fCBtZXRob2QgPT09IERFU1RST1kgfHwgZmFsc2U7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAodGhhdCwgbmFtZSwgbW9kLCBhcmdzKQogICAgICAgIHsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoaW5mb0Zvcm1hdCwgbmFtZSkpOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoY29udmVudGlvbk5hbWUsIG5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIG1vZC50aHJ1c3RDYWxsKG1ldGhvZCwgY29tcEFmdGVyLCBhcmdzKS50aGVuKGZ1bmN0aW9uICgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQubWVkaWF0b3IuZmlyZShldmVudE5hbWUsIG5hbWUpOwogICAgICAgICAgICAgICAgbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUsIGNvbnZlbnRpb25WYWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAodW5zZXRSZWFkeSkgbW9kLmNvbnZlbnRpb24oUkVBRFkgKyAnLXN0YXR1cycsIGZhbHNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIGFsbFJ1bm5lckZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChtZXRob2QpCiAgICB7CiAgICAgICAgdmFyIGluZm9Gb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogezB9aW5nIGFsbCBtb2R1bGVzLi4uIFt7ezB9fV0nLCBtZXRob2QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBtZXRob2Quc3Vic3RyaW5nKDEpKSwKICAgICAgICAgICAgcGx1cmFsTmFtZSA9IGZvcm1hdCgndGhydXN0L21vZHVsZS9hbGwvezB9JywgbWV0aG9kKSwKICAgICAgICAgICAgY2hlY2tBdXRvU3RhcnQgPSBtZXRob2QgPT09IElOSVQgfHwgbWV0aG9kID09PSBTVEFSVDsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0aGF0KQogICAgICAgIHsKICAgICAgICAgICAgdGhhdC5tZWRpYXRvci5maXJlKHBsdXJhbE5hbWUpOwogICAgICAgICAgICB2YXIgbW9kdWxlcyA9IHRoYXQubW9kdWxlcywKICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBbXTsKCiAgICAgICAgICAgIHRydWUgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIHV0aWwubWFwKG1vZHVsZXMsIGZ1bmN0aW9uKHgsIGkpIHsgcmV0dXJuIHguY29udmVudGlvbignYXV0b1N0YXJ0JykgJiYgaTsgfSkuam9pbignLCAnKSkpOwogICAgICAgICAgICBlYWNoKG1vZHVsZXMsIGZ1bmN0aW9uICh4LCBpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWNoZWNrQXV0b1N0YXJ0IHx8IChjaGVja0F1dG9TdGFydCAmJiB4LmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSkKICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2godGhhdFttZXRob2RdKGkpKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAodGhhdC5zdGFydGluZ01vZHVsZXMgJiYgY2hlY2tBdXRvU3RhcnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRydWUgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIHRoYXQuc3RhcnRpbmdNb2R1bGVzLmpvaW4oJywgJykpKTsKICAgICAgICAgICAgICAgIHRoYXRbbWV0aG9kXSh0aGF0LnN0YXJ0aW5nTW9kdWxlcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChyZXN1bHRzKTsKICAgICAgICB9OwogICAgfSk7CgogICAgdmFyIGZsYXR0ZW5XaXRoQXN5bmMgPSBmdW5jdGlvbiAodGhhdCwgYXJyKQogICAgewogICAgICAgIHJldHVybiB1dGlsLmZsYXR0ZW4oYXJyLmNvbmNhdCh0aGF0LmNmZy5hc3luYyAmJiBbd2hlbi5kZWxheSgwKV0gfHwgW10pKTsKICAgIH07CiAgICAvLyNlbmRyZWdpb24KICAgIAogICAgVGhydXN0LnByb3RvdHlwZSA9IFRocnVzdC5mbiA9IHsKICAgICAgICAvKioKICAgICAgICAgICAgUmVxdWlyZWQgbWV0aG9kcywgdGhhdCBldmVyeSBtb2R1bGUgbXVzdCBpbXBsZW1lbnQuCiAgICAKICAgICAgICBAcHJvcGVydHkgX19yZXF1aXJlZE1ldGhvZHMKICAgICAgICBAcHJvdGVjdGVkCiAgICAgICAgKiovCiAgICAgICAgX19yZXF1aXJlZE1ldGhvZHM6IFsgICAgIC8vIFJlcXVpcmVkIG1ldGhvZHMgdGhhdCBtdXN0IGJlIG9uIGV2ZXJ5IG1vZHVsZQogICAgICAgICAgICAnaW5pdCcsCiAgICAgICAgICAgICdkZXN0cm95JwogICAgICAgIF0sCiAgICAgICAgX19jb252ZW50aW9uczogW10sCiAgICAgICAgLyoqCiAgICAgICAgICAgIENyZWF0ZXMgYSBuZXcgdGhydXN0IG1vZHVsZS4KCiAgICAgICAgQG1ldGhvZCBjcmVhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdW5pcXVlIG1vZHVsZSBuYW1lLgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGUgVGhlIG1vZHVsZSBkZWZpbnRpb24uCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBwcmVCdWlsZCBIYXMgdGhpcyBtb2R1bGUgYmVlbiBwcmVidWlsdCwgaW4gb3RoZXIgd29yZHMgaGFzIGl0IGJlZW4gY3JlYXRlZCwgYnkgd2lyZS5qcyBhbmQgbmVlZHMgdG8gYmUgaW5qZWN0ZWQuCiAgICAgICAgQHJldHVybnMge01vZHVsZX0gVGhlIG5ldyBtb2R1bGUgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgY3JlYXRlOiBmdW5jdGlvbiAobmFtZSwgbW9kdWxlLCBwcmVCdWlsdCkKICAgICAgICB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnVGhydXN0OiBDcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgInswfSInLCBuYW1lKSk7CgogICAgICAgICAgICB2YXIgb2xkTW9kdWxlOwogICAgICAgICAgICBpZiAocHJlQnVpbHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9sZE1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgICAgIG1vZHVsZSA9IG1vZHVsZS5pbnN0YW5jZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFwcmVCdWlsdCkKICAgICAgICAgICAgICAgIG1vZHVsZSA9IG5ldyBNb2R1bGUodGhpcywgbW9kdWxlLCBuYW1lKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgbW9kdWxlID0gb2xkTW9kdWxlOwoKICAgICAgICAgICAgLy8gTW9kdWxlcyBjYW5ub3QgaGF2ZSBkdXBsaWNhdGUgbmFtZXMsIGNob29zZSBhIG5ldyBvbmUuCiAgICAgICAgICAgIGlmICh0aGlzLm1vZHVsZXNbbW9kdWxlLm5hbWVdKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnRHVwbGljYXRlIG1vZHVsZSBuYW1lICJ7MH0iLicsIG5hbWUpKTsKCiAgICAgICAgICAgIC8vIG0gaXMgdGhlIG1lZGlhdG9ycyBpbnRlcm5hbCBtb2R1bGUuCiAgICAgICAgICAgIHRoaXMubW9kdWxlc1ttb2R1bGUubmFtZV0gPSBtb2R1bGU7CgogICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdCgnVGhydXN0OiBDcmVhdGVkIG1vZHVsZSAiezB9IicsIG5hbWUpKTsKICAgICAgICAgICAgLy8gTm90aWZ5IHRoZSBtZWRpYXRvciB0aGF0IGEgbW9kdWxlIGhhcyBiZWVuIGNyZWF0ZWQuCiAgICAgICAgICAgIHRoaXMubWVkaWF0b3IuZmlyZSgndGhydXN0L21vZHVsZS9jcmVhdGUnLCBuYW1lKTsKCiAgICAgICAgICAgIGlmICh0aGlzLm1lZGlhdG9yLnN0YXJ0ZWQgJiYgbW9kdWxlLmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKQogICAgICAgICAgICAgICAgdGhpcy5tZWRpYXRvci5zdGFydChtb2R1bGUubmFtZSk7CgogICAgICAgICAgICByZXR1cm4gbW9kdWxlOwogICAgICAgIH0sCiAgICAgICAgLy8jcmVnaW9uIEdsb2JhbCBSdW5uZXJzCiAgICAgICAgLyoqCiAgICAgICAgICAgIEJlZ2lucyB0aGUgY291bnRkb3duIHRvIHRocnVzdHMgc3RhcnQuCiAgICAgICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KCiAgICAgICAgQG1ldGhvZCBjb3VudGRvd24KICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgY291bnRkb3duIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBjb3VudGRvd246IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnTGF1bmNoIGluc3RhbmNlICJ7MH0iIGluIDUuLi4gNC4uLiAzLi4uIDIuLi4gMS4uLicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlbldpdGhBc3luYyh0aGF0LCBbCiAgICAgICAgICAgICAgICB1dGlsLnNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBDT1VOVERPV04sIHRoYXQpLAogICAgICAgICAgICAgICAgdGhhdC5pbml0KCkKICAgICAgICAgICAgXSkpCiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L2luaXQnKTsgfSkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgeyB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBoYXMgYmVlbiBpbml0YWxpemVkLicsIHRoYXQubmFtZSkpOyB9KQogICAgICAgICAgICAgICAgLnRoZW4odGhhdC5pZ25pdGUuYmluZCh0aGF0KSk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgICAgQmVnaW5zIHRoZSBpbmdpdGlvbiBhcyB0aHJ1c3Qgc3RhcnRzIHVwLgogICAgICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCgogICAgICAgIEBtZXRob2QgaWduaXRlCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBpZ25pdGU6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRmlyaW5nIHJvY2tldHMgZm9yIHRodXJzdCBpbnN0YW5jZSAiezB9Ii4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgdXRpbC5zYWZlSW52b2tlKHRoYXQuX19jb252ZW50aW9ucywgSUdOSVRFLCB0aGF0KSwKICAgICAgICAgICAgICAgIHRoYXQuc3RhcnQoKQogICAgICAgICAgICBdKSkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsgdGhhdC5tZWRpYXRvci5maXJlKCd0aHJ1c3Qvc3RhcnQnKTsgfSkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaGFzIGJlZW4gc3RhcnRlZC4nLCB0aGF0Lm5hbWUpKTsgfSkKICAgICAgICAgICAgICAgIC50aGVuKHRoYXQub3JiaXQuYmluZCh0aGF0KSk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgICAgVGhydXN0IHByZXBhcmVzIGZvciBvcmJpdC4KICAgICAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLgoKICAgICAgICBAbWV0aG9kIG9yYml0CiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhydXN0IGlzIGluIG9yYml0LgogICAgICAgICoqLwogICAgICAgIG9yYml0OiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0ZpcmluZyBzdGFnZSB0d28gdGhydXN0ZXJzIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHZhciBkb21SZWFkeURlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICBkb21SZWFkeURlZmVyLnRoZW4oZnVuY3Rpb24gKCkgeyB0aGF0Lm1lZGlhdG9yLmZpcmUoJ3RocnVzdC9kb20vcmVhZHknKTsgfSk7CiAgICAgICAgICAgIGRvbVJlYWR5KGRvbVJlYWR5RGVmZXIucmVzb2x2ZSk7CgogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlbldpdGhBc3luYyh0aGF0LCBbCiAgICAgICAgICAgICAgICBkb21SZWFkeURlZmVyLnByb21pc2UsCiAgICAgICAgICAgICAgICB1dGlsLnNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBPUkJJVCwgdGhhdCkKICAgICAgICAgICAgXSkpLnRoZW4oZnVuY3Rpb24gKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRydWUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRpbWVTdGFydCA9IHRoYXQuY29uZmlnLmRlYnVnLnRpbWVTdGFydCwKICAgICAgICAgICAgICAgICAgICB0aW1lRW5kICAgICAgID0gbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICAgICAgc3RhcnRUaW1lICAgICA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KSwKICAgICAgICAgICAgICAgICAgICB0dG9EaXYgICAgICAgID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0bycpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodHRvRGl2KQogICAgICAgICAgICAgICAgICAgICAgICB0dG9EaXYuaW5uZXJIVE1MID0gc3RhcnRUaW1lICsgJ21zJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFt0aGF0LnJlYWR5KCldKSkKICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L3JlYWR5Jyk7IH0pCiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgeyB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBub3cgcmVhZHkuJywgdGhhdC5uYW1lKSk7IH0pCiAgICAgICAgICAgICAgICAgICAgLnRoZW4odGhhdC5pbk9yYml0LmJpbmQodGhhdCkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGluT3JiaXQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoYXQuc3RhcnRlZCA9IHRydWU7CgogICAgICAgICAgICBpZiAodHJ1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRpbWVTdGFydCA9IHRoYXQuY29uZmlnLmRlYnVnLnRpbWVTdGFydCwKICAgICAgICAgICAgICAgICAgICB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gKHRpbWVFbmQgLSB0aW1lU3RhcnQpOwoKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTdGFydGVkIGluICcgKyBzdGFydFRpbWUgKyAnbXMnKTsKCiAgICAgICAgICAgICAgICB2YXIgdHRyRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0cicpOwogICAgICAgICAgICAgICAgaWYgKHR0ckRpdikKICAgICAgICAgICAgICAgICAgICB0dHJEaXYuaW5uZXJIVE1MID0gc3RhcnRUaW1lICsgJ21zJzsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICAgIEJlZ2lucyB0aGUgZGVvcmJpdCBhcyB0aHJ1c3Qgc2h1dGRvd24uCiAgICAgICAgICAgIFNodXRkb3duIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCgogICAgICAgIEBtZXRob2QgZGVvcmJpdAogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZGVvcmJpdDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdSZWVudGVyaW5nIGVhcnRocyBhdG1vc3BoZXJlIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHRoYXQuc3RvcCgpLAogICAgICAgICAgICAgICAgdXRpbC5zYWZlSW52b2tlKHRoYXQuX19jb252ZW50aW9ucywgREVPUkJJVCwgdGhhdCkKICAgICAgICAgICAgXSkpCiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L3N0b3AnKTsgfSkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IHN0b3BwZWQuJywgdGhhdC5uYW1lKSk7IH0pCiAgICAgICAgICAgICAgICAudGhlbih0aGF0Lm9yYml0LmJpbmQodGhhdCkpOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICAgIEJlZ2lucyB0aGUgc3BsYXNoZG93biBhcyB0aHJ1c3Qgc2h1dGRvd24uCiAgICAgICAgICAgIFNodXRkb3duIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCgogICAgICAgIEBtZXRob2Qgc3BsYXNoZG93bgogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgc3BsYXNoZG93bjogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdMYW5kaW5nIGluIHRoZSBtaWRkbGUgb2YgdGhlIGF0bGFudGljIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHRoYXQuc3RvcCgpLAogICAgICAgICAgICAgICAgdXRpbC5zYWZlSW52b2tlKHRoYXQuX19jb252ZW50aW9ucywgU1BMQVNIRE9XTiwgdGhhdCkKICAgICAgICAgICAgXSkpCiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L2Rlc3Ryb3knKTsgfSkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IGJlaW5nIGRlc3Ryb3llZCcsIHRoYXQubmFtZSkpOyB9KTsKICAgICAgICAgICAgLy8gZG8gZGVzdHJveQogICAgICAgIH0sCiAgICAgICAgLy8jZW5kcmVnaW9uCiAgICAgICAgLy8jcmVnaW9uIE1vZHVsZSBydW5uZXJzCiAgICAgICAgLyoqCiAgICAgICAgICAgIEJlZ2lucyB0aGUgaW5pdGFsaXphdGlvbiBwcm9jZXNzIGZvciBhIG1vZHVsZS4gIFRoaXMgcnVucyBhcyBwYXJ0IG9mIHRoZQogICAgICAgICAgICAgICAgY291bnRkb3duIHBoYXNlLCBkdXJpbmcgc3RhcnQgdXAsIG9yIGluIG9yZGVyLCB3aGVuIGNyZWF0aW5nIG1vZHVsZXMuCiAgICAgICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KCiAgICAgICAgQG1ldGhvZCBpbml0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd8QXJyYXkgb2YgU3RyaW5nfSBbbmFtZV0gVGhlIG5hbWUgb2YgdGhlIG1vZHVsZS4gIElmIG5hbWUgaXMgbnVsbCwgYWxsIG1vZHVsZXMKICAgICAgICAgICAgdGhhdCByZXR1cm4gdGhlIHByb3BlcnR5IGF1dG9TdGFydCB3aWxsIGJlIGluaXRlZC4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5pdCBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgaW5pdDogbWVtb2l6ZShmdW5jdGlvbiAobmFtZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgbWV0aG9kID0gSU5JVDsKCiAgICAgICAgICAgIHZhciByZXN1bHQgPSAhbmFtZSAmJiBhbGxSdW5uZXJGYWN0b3J5KG1ldGhvZCkodGhhdCk7CiAgICAgICAgICAgIGlmIChyZXN1bHQpCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoKICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIGlmIChpc0FycmF5KG5hbWUpKQogICAgICAgICAgICAgICAgcmVzdWx0ID0gbWFwKG5hbWUsIGZ1bmN0aW9uICh4KSB7IHJldHVybiB0aGF0LmluaXQoeCk7IH0pOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICByZXN1bHQgPSBydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgYXJndW1lbnRzKTsKCiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbCh1dGlsLmZsYXR0ZW4ocmVzdWx0KSk7CiAgICAgICAgfSksCiAgICAgICAgLyoqCiAgICAgICAgICAgIEJlZ2lucyB0aGUgc3RhcnR1cCBwcm9jZXNzIGZvciBhIG1vZHVsZS4gIFRoaXMgcnVucyBhcyBwYXJ0IG9mIHRoZQogICAgICAgICAgICAgICAgaWduaXRlIHBoYXNlLCBkdXJpbmcgc3RhcnQgdXAsIG9yIGluIG9yZGVyLCB3aGVuIGNyZWF0aW5nIG1vZHVsZXMuCiAgICAgICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgIEBwYXJhbSB7U3RyaW5nfEFycmF5IG9mIFN0cmluZ30gW25hbWVdIFRoZSBuYW1lIG9mIHRoZSBtb2R1bGUuICBJZiBuYW1lIGlzIG51bGwsIGFsbCBtb2R1bGVzCiAgICAgICAgICAgIHRoYXQgcmV0dXJuIHRoZSBwcm9wZXJ0eSBhdXRvU3RhcnQgd2lsbCBiZSBzdGFydGVkLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbml0IGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBzdGFydDogZnVuY3Rpb24gKG5hbWUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IFNUQVJUOwoKICAgICAgICAgICAgdmFyIHJlc3VsdCA9ICFuYW1lICYmIGFsbFJ1bm5lckZhY3RvcnkobWV0aG9kKSh0aGF0KTsKICAgICAgICAgICAgaWYgKHJlc3VsdCkKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CgogICAgICAgICAgICBpZiAoIWlzQXJyYXkobmFtZSkpCiAgICAgICAgICAgICAgICBuYW1lID0gW25hbWVdOwoKICAgICAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbmFtZS5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuID0gbmFtZVtpXSwKICAgICAgICAgICAgICAgICAgICBtb2QgPSB0aGF0Lm1vZHVsZXNbbl07CgogICAgICAgICAgICAgICAgaWYgKCFtb2QpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaXRlbXMucHVzaCh0aGF0LmluaXQuY2FsbCh0aGF0LCBbbl0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFtb2QuY29udmVudGlvbihJTklUICsgJy1zdGF0dXMnKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKHRoYXQuaW5pdC5jYWxsKHRoYXQsIFtuXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIHN0YXJ0RGVmZXIgPSB3aGVuLmRlZmVyKCksCiAgICAgICAgICAgICAgICBhcmdzID0gdXRpbC50b0FycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHdoZW4uYWxsKHV0aWwuZmxhdHRlbihpdGVtcykpLnRoZW4oZnVuY3Rpb24gKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgYXJncykpOwoKICAgICAgICAgICAgICAgIHZhciByZXN1bHRzRGVmZXIgPSB3aGVuLmFsbCh1dGlsLmZsYXR0ZW4ocmVzdWx0cykpOwogICAgICAgICAgICAgICAgaWYgKHRoYXQuc3RhcnRlZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcnVuUmVhZHkgPSBmdW5jdGlvbiAoKSB7IHdoZW4uY2hhaW4odGhhdC5yZWFkeS5hcHBseSh0aGF0LCBhcmdzKSwgc3RhcnREZWZlcik7IH07CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0c0RlZmVyLnRoZW4ocnVuUmVhZHkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHdoZW4uY2hhaW4ocmVzdWx0c0RlZmVyLCBzdGFydERlZmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gc3RhcnREZWZlci5wcm9taXNlOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICAgIEJlZ2lucyB0aGUgcmVhZHkgcHJvY2VzcyBmb3IgYSBtb2R1bGUuICBUaGlzIHJ1bnMgYXMgcGFydCBvZiB0aGUKICAgICAgICAgICAgICAgIG9yYml0IHBoYXNlLCBkdXJpbmcgcmVhZHksIG9yIGluIG9yZGVyLCB3aGVuIGNyZWF0aW5nIG1vZHVsZXMuCiAgICAgICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KCiAgICAgICAgQG1ldGhvZCByZWFkeQogICAgICAgIEBwYXJhbSB7U3RyaW5nfEFycmF5IG9mIFN0cmluZ30gW25hbWVdIFRoZSBuYW1lIG9mIHRoZSBtb2R1bGUuICBJZiBuYW1lIGlzIG51bGwsIGFsbCBtb2R1bGVzCiAgICAgICAgICAgIHRoYXQgcmV0dXJuIHRoZSBwcm9wZXJ0eSBhdXRvU3RhcnQgd2lsbCBiZSBzdGFydGVkLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbml0IGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICByZWFkeTogZnVuY3Rpb24gKG5hbWUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IFJFQURZOwoKICAgICAgICAgICAgdmFyIHJlc3VsdCA9ICFuYW1lICYmIGFsbFJ1bm5lckZhY3RvcnkobWV0aG9kKSh0aGF0KTsKICAgICAgICAgICAgaWYgKHJlc3VsdCkKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CgogICAgICAgICAgICBpZiAoIWlzQXJyYXkobmFtZSkpCiAgICAgICAgICAgICAgICBuYW1lID0gW25hbWVdOwoKICAgICAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbmFtZS5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuID0gbmFtZVtpXSwKICAgICAgICAgICAgICAgICAgICBtb2QgPSB0aGF0Lm1vZHVsZXNbbl07CiAgICAgICAgICAgICAgICBpZiAoIW1vZC5jb252ZW50aW9uKFNUQVJUICsgJy1zdGF0dXMnKSAmJiAhdGhhdC5zdGFydGVkKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGl0ZW1zLnB1c2godGhhdC5zdGFydC5hcHBseSh0aGF0LCBbbl0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGl0ZW1zLnB1c2gocnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIGFyZ3VtZW50cykpOwoKICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKHV0aWwuZmxhdHRlbihpdGVtcykpOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICAgIEJlZ2lucyB0aGUgc3RvcCBwcm9jZXNzIGZvciBhIG1vZHVsZS4gIFRoaXMgcnVucyBhcyBwYXJ0IG9mIHRoZQogICAgICAgICAgICAgICAgZGVvcmJpdCBwaGFzZSwgZHVyaW5nIHN0b3AsIG9yIGluIG9yZGVyLCB3aGVuIGNyZWF0aW5nIG1vZHVsZXMuCiAgICAgICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KCiAgICAgICAgQG1ldGhvZCBzdG9wCiAgICAgICAgQHBhcmFtIHtTdHJpbmd8QXJyYXkgb2YgU3RyaW5nfSBbbmFtZV0gVGhlIG5hbWUgb2YgdGhlIG1vZHVsZS4gIElmIG5hbWUgaXMgbnVsbCwgYWxsIG1vZHVsZXMKICAgICAgICAgICAgd2lsbCBiZSBzdG9wcGVkLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBzdG9wIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBzdG9wOiBmdW5jdGlvbiAobmFtZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgbWV0aG9kID0gU1RPUDsKCiAgICAgICAgICAgIHZhciByZXN1bHQgPSAhbmFtZSAmJiBhbGxSdW5uZXJGYWN0b3J5KG1ldGhvZCkodGhhdCk7CiAgICAgICAgICAgIGlmIChyZXN1bHQpCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoKICAgICAgICAgICAgaWYgKCFpc0FycmF5KG5hbWUpKQogICAgICAgICAgICAgICAgbmFtZSA9IFtuYW1lXTsKCiAgICAgICAgICAgIHJlc3VsdCA9IHJ1blJ1bm5lckZhY3RvcnkobWV0aG9kKS5hcHBseSh0aGF0LCBhcmd1bWVudHMpCiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbCh1dGlsLmZsYXR0ZW4ocmVzdWx0KSk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgICAgQmVnaW5zIHRoZSBkZXN0cm95IHByb2Nlc3MgZm9yIGEgbW9kdWxlLiAgVGhpcyBydW5zIGFzIHBhcnQgb2YgdGhlCiAgICAgICAgICAgICAgICBzbGFzaGRvd24gcGhhc2UsIGR1cmluZyBkZXN0cm95LCBvciBpbiBvcmRlciwgd2hlbiBjcmVhdGluZyBtb2R1bGVzLgogICAgICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCgogICAgICAgIEBtZXRob2QgZGVzdHJveQogICAgICAgIEBwYXJhbSB7U3RyaW5nfEFycmF5IG9mIFN0cmluZ30gW25hbWVdIFRoZSBuYW1lIG9mIHRoZSBtb2R1bGUuICBJZiBuYW1lIGlzIG51bGwsIGFsbCBtb2R1bGVzCiAgICAgICAgICAgIHdpbGwgYmUgZGVzdHJveWVkLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBkZXN0cm95IGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAobmFtZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgbWV0aG9kID0gREVTVFJPWTsKCiAgICAgICAgICAgIHZhciByZXN1bHQgPSAhbmFtZSAmJiBhbGxSdW5uZXJGYWN0b3J5KG1ldGhvZCkodGhhdCk7CiAgICAgICAgICAgIGlmIChyZXN1bHQpCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoKICAgICAgICAgICAgaWYgKCFpc0FycmF5KG5hbWUpKQogICAgICAgICAgICAgICAgbmFtZSA9IFtuYW1lXTsKCiAgICAgICAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IG5hbWUubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgbiA9IG5hbWVbaV0sCiAgICAgICAgICAgICAgICAgICAgbW9kID0gdGhhdC5tb2R1bGVzW25dOwoKICAgICAgICAgICAgICAgIGlmICghbW9kLmNvbnZlbnRpb24oU1RPUCArICctc3RhdHVzJykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaXRlbXMucHVzaCh0aGF0LnN0b3AuY2FsbCh0aGF0LCBbbl0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGl0ZW1zLnB1c2gocnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIGFyZ3VtZW50cykpOwogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwodXRpbC5mbGF0dGVuKGl0ZW1zKSk7CiAgICAgICAgfSwKICAgICAgICAvLyNlbmRyZWdpb24KICAgICAgICAvKioKICAgICAgICAgICAgSW5qZWN0cyBhIHByZWNvbnN0cnVjdGVkIG1vZHVsZSBpbnRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UuCgogICAgICAgIEBtZXRob2QgX19pbmplY3RNb2R1bGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBpbmplY3QuCiAgICAgICAgKiovCiAgICAgICAgX19pbmplY3RNb2R1bGU6IGZ1bmN0aW9uIChtb2R1bGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNyZWF0ZShtb2R1bGUubmFtZSwgbW9kdWxlLCB0cnVlKTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIENyZWF0ZXMgYSBtb2R1bGUgZnJvbSB0aGUgZ2l2ZW4gZGVmaW5pdGlvbiBvYmplY3QsIHdpdGggdGhlIGdpdmVuIG5hbWUuCgogICAgICAgIEBtZXRob2QgY3JlYXRlTW9kdWxlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZHVsZURlZm4gVGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgICAgKiovCiAgICAgICAgY3JlYXRlTW9kdWxlOiBmdW5jdGlvbiAobmFtZSwgbW9kdWxlRGVmbikKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYgKHRoYXQubW9kdWxlc1tuYW1lXSkgcmV0dXJuIHRoYXQubW9kdWxlc1tuYW1lXTsKCiAgICAgICAgICAgIHZhciBtb2R1bGUgPSBuZXcgTW9kdWxlKHRoYXQsIG1vZHVsZURlZm4sIG5hbWUpOwoKICAgICAgICAgICAgdGhhdC5fX2luamVjdE1vZHVsZShtb2R1bGUpOwoKICAgICAgICAgICAgcmV0dXJuIG1vZHVsZTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICAgIEluaXRhbGl6ZXMgYSBuZXcgVGhydXN0IGluc3RhbmNlIGJhc2VkIG9uIHRoZSBnaXZlbiBzZXR0aW5ncy4KCiAgICBAbWV0aG9kIGxhdW5jaAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBtb2R1bGUgdG8gaW5qZWN0CiAgICAqKi8KICAgIFRocnVzdC5sYXVuY2ggPSBmdW5jdGlvbiAoc2V0dGluZ3MpCiAgICB7CiAgICAgICAgaWYgKCFzZXR0aW5ncykKICAgICAgICAgICAgc2V0dGluZ3MgPSB7IG5hbWU6ICdnbG9iYWwnIH07CgogICAgICAgIGlmICghc2V0dGluZ3MubmFtZSkKICAgICAgICAgICAgc2V0dGluZ3MubmFtZSA9ICdnbG9iYWwnOwoKICAgICAgICBpZiAodHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHNldHRpbmdzLmRlYnVnID0geyB0aW1lU3RhcnQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIH07CiAgICAgICAgfQoKICAgICAgICB2YXIgc2V0dXBEZWZlciA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2Uoc2V0dGluZ3MubmFtZSk7CgogICAgICAgIHNldHVwRGVmZXIudGhlbihmdW5jdGlvbiAoY29udGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdDsKICAgICAgICAgICAgdGhydXN0LnN0YXJ0aW5nTW9kdWxlcyA9IGNvbnRleHQuY2ZnLm1vZHVsZXM7CiAgICAgICAgICAgIHRocnVzdC5jb25maWcgPSB0aHJ1c3QuY2ZnOwogICAgICAgICAgICBpbnN0YW5jZXNbdGhydXN0Lm5hbWVdID0gdGhydXN0OwogICAgICAgICAgICB0aHJ1c3QuY291bnRkb3duKCk7CgogICAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChjb250ZXh0KQogICAgICAgIHsKICAgICAgICAgICAgd2luZG93LnRocnVzdCA9IGNvbnRleHQudGhydXN0OwogICAgICAgIH0pOwoKICAgICAgICB3aGVuLmNoYWluKGlnbml0ZVNwZWMuc3RhZ2VPbmUoc2V0dGluZ3MpLCBzZXR1cERlZmVyKTsKCiAgICAgICAgcmV0dXJuIHNldHVwRGVmZXIucHJvbWlzZTsKICAgIH07CgogICAgLyoqCiAgICBHZXRzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCgogICAgQG1ldGhvZCBnZXRJbnN0YW5jZQogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgIEByZXR1cm5zIHtUaHJ1c3R9IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICoqLwogICAgVGhydXN0LmdldEluc3RhbmNlID0gZnVuY3Rpb24gKG5hbWUpCiAgICB7CiAgICAgICAgcmV0dXJuIHRocnVzdEluc3RhbmNlLmdldEluc3RhbmNlKG5hbWUpOwogICAgfTsKCiAgICAvKioKICAgIEZldGNocyBhIG5hbWVkIHRocnVzdCBzdGFuY2UgaWYgaXQgZXhpc3RzLgogICAgVGhpcyBsb2FkcyBhc3luY3Jvbm91c2x5LCBhcyB0aGUgaW5zdGFuY2UgbWF5IG5vdCBiZSBsb2FkZWQKCiAgICBAbWV0aG9kIF9fZmV0Y2hJbnN0YW5jZQogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICBAcmV0dXJucyB7UHJvbWlzZX0gVG8gYSB0aHJ1c3QgaW5zdGFuY2Ugc3BlYwogICAgKiovCiAgICBUaHJ1c3QuX19mZXRjaEluc3RhbmNlID0gZnVuY3Rpb24gKG5hbWUpCiAgICB7CiAgICAgICAgcmV0dXJuIHRocnVzdEluc3RhbmNlLmZldGNoSW5zdGFuY2UobmFtZSk7CiAgICB9OwoKICAgIC8qKgogICAgQ3JlYXRlcyBhIG5ldyBtb2R1bGUgYW5kIGhhbmRzIGl0IG9mZiB0byB0aGUgZ2l2ZW4gaW5zdGFuY2UsIGlmIHRoYXQgaW5zdGFuY2UgZXhpc3RzLgoKICAgIEBtZXRob2QgY3JlYXRlTW9kdWxlCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlRGVmbiBUaGUgbW9kdWxlIGRlZmluaXRpb24KICAgICoqLwogICAgVGhydXN0LmNyZWF0ZU1vZHVsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZU5hbWUsIG5hbWUsIG1vZHVsZURlZm4pCiAgICB7CiAgICAgICAgdmFyIGluc3RhbmNlID0gVGhydXN0LmdldEluc3RhbmNlKGluc3RhbmNlTmFtZSk7CiAgICAgICAgaWYgKGluc3RhbmNlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIG1vZHVsZSA9IG5ldyBNb2R1bGUodGhhdCwgbW9kdWxlRGVmbiwgbmFtZSk7CiAgICAgICAgICAgIGluc3RhbmNlLl9faW5qZWN0TW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKCiAgICBIYW5kbGVzIGZldGNoaW5nIG9mIGEgY3VycmVudCB0aHVyc3QgaW5zdGFuY2UsIGJ5IGV4cGVjdGVkIG5hbWUuCiAgICBBZGRpbmcgdGhlIDogY2hhcmFjdGVyIHJlcXVlc3RzIGEgc3BlY2lmaWMgcGx1Z2luLgogICAgdGhydXN0IWdsb2JhbCA9IFRocnVzdCBpbnN0YW5jZQogICAgdGhydXN0IWdsb2JhbDpkb20gPSBUaGUgdGhydXN0IGRvbSBwbHVnaW4gaW5zdGFuY2UKCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBUaHJ1c3QubG9hZCA9IGZ1bmN0aW9uIChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpCiAgICB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLAogICAgICAgICAgICByZWFsTmFtZSA9IHBhcnRzWzBdLAogICAgICAgICAgICBwbHVnaW5OYW1lID0gcGFydHNbMV0gfHwgJ3RocnVzdCc7CgogICAgICAgIHZhciBpbnN0YW5jZVByb21pc2UgPSBUaHJ1c3QuX19mZXRjaEluc3RhbmNlKHJlYWxOYW1lKTsKICAgICAgICBpbnN0YW5jZVByb21pc2UudGhlbihmdW5jdGlvbiAoY29udGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBjb250ZXh0W3BsdWdpbk5hbWVdOwogICAgICAgICAgICBpZiAoIXBsdWdpbikKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ1BsdWdpbiAiezB9IiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgInsxfSIuJywgcGx1Z2luTmFtZSwgcmVhbE5hbWUpKTsKCiAgICAgICAgICAgIGxvYWQocGx1Z2luKTsKICAgICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIFRocnVzdDsKfSk7CgpkZWZpbmUoJ3RocnVzdCcsIFsndGhydXN0L21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvY29udmVudGlvbicsWwogICAgJ3RocnVzdC91dGlsJwpdLApmdW5jdGlvbiAodXRpbCkKewogICAgLyoqCiAgICAgICAgQSBDb252ZW50aW9uIGFsbG93cyB0aHJ1c3QgdG8gYmUgYXMgZXh0ZW5kYWJsZSBhcyBwb3NzaWJsZSwgYnkgZ2l2aW5nIGV4dGVuc2lvbiBwb2ludHMgYXQgZXZlcnkgc3RlcCBhbG9uZyB0aGUgd2F5LgoKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAc3VibW9kdWxlIGNvbnZlbnRpb24KICAgICoqLwoKICAgIC8qKgogICAgICAgIFRoZSBjb252ZW50aW9uIGNsYXNzLCB0YWtlcyBhbiBvdmVybG9hZGVkIHNldCBvZiBtZXRob2RzLCBmb3IgYW55IG1ldGhvZCB0aGF0IG5lZWRzIHRvIGJlIG92ZXJsb2FkZWQuCgogICAgQGNsYXNzIENvbnZlbnRpb24KICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHtPYmplY3R9IG1ldGhvZHMgQW4gb2JqZWN0IG9mIGFwcGxpY2FibGUgbWV0aG9kcy4KICAgICoqLwogICAgdmFyIENvbnZlbnRpb24gPSBmdW5jdGlvbiAobWV0aG9kcykKICAgIHsKICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgQ29udmVudGlvbikpCiAgICAgICAgICAgIHJldHVybiBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKCiAgICAgICAgdXRpbC5leHRlbmQodGhpcywgbWV0aG9kcyk7CiAgICB9OwoKICAgIENvbnZlbnRpb24uZm4gPSBDb252ZW50aW9uLnByb3RvdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgICAgVGhlc2UgcHJvcGVydGllcyBhcmUgc3RyaXBwZWQgb2ZmIG9mIGFueSBtb2R1bGUsIGFuZCBoZWxkIGluIGEgcHJpdmF0ZSBzcGFjZSBmb3Igb3RoZXIgY29udmVudGlvbiBtZXRob2RzIHRvIHVzZS4KICAgICAgICBAcHJvcGVydHkgcHJvcGVydGllcwogICAgICAgIEBvcHRpb25hbAogICAgICAgICoqLwogICAgICAgIHByb3BlcnRpZXM6IFtdLAogICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgY3JlYXRlIG9mIGEgbW9kdWxlLCBnZW5lcmFsbHkgdXNlZCB0byBjcmVhdGUgYSBmYWNhZGUsIHRoYXQgaXMgdGhlbiBib3VuZCB0byB0aGUgbW9kdWxlLgogICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSBpbnN0YW5jZS4KICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBBbGwgdGhlIGZhY2FkZXMgYWxyZWFkeSBhdHRhY2hlZCB0byB0aGUgbW9kdWxlLgogICAgICAgICoqLwogICAgICAgIGNyZWF0ZTogdXRpbC5ub29wLAogICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3QgaW5pdCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBpbml0IHBoYXNlCgogICAgICAgIEBtZXRob2QgaW5pdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGluaXQ6IHV0aWwubm9vcCwKICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHN0YXJ0IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHN0YXJ0IHBoYXNlCgogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBzdGFydDogdXRpbC5ub29wLAogICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3QgcmVhZHkgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgcmVhZHkgcGhhc2UKCiAgICAgICAgQG1ldGhvZCByZWFkeQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIHJlYWR5OiB1dGlsLm5vb3AsCiAgICAgICAgLyoqCiAgICAgICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBzdG9wIHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHN0b3AgcGhhc2UKCiAgICAgICAgQG1ldGhvZCBzdG9wCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgc3RvcDogdXRpbC5ub29wLAogICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3QgZGVzdHJveSBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBkZXN0cm95IHBoYXNlCgogICAgICAgIEBtZXRob2QgZGVzdHJveQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGRlc3Ryb3k6IHV0aWwubm9vcCwKICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgY291bnRkb3duCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGNvdW50ZG93bjogdXRpbC5ub29wLAogICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHN0YXJ0IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgaWduaXRlCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGlnbml0ZTogdXRpbC5ub29wLAogICAgICAgIC8qKgogICAgICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHJlYWR5IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2Qgb3JiaXQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgb3JiaXQ6IHV0aWwubm9vcCwKICAgICAgICAvKioKICAgICAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBzdG9wIHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgZGVvcmJpdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBkZW9yYml0OiB1dGlsLm5vb3AsCiAgICAgICAgLyoqCiAgICAgICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgZGVzdHJveSBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIHNwbGFzaGRvd24KICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgc3BsYXNoZG93bjogdXRpbC5ub29wCiAgICB9OwoKICAgIHJldHVybiBDb252ZW50aW9uOwp9KTsKZGVmaW5lKCd0aHJ1c3QvZXZlbnRzJyxbCiAgICAndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICd0aHJ1c3QvY29uZmlnJywgJ2hhcycKXSwKZnVuY3Rpb24gKHV0aWwsIGxvZywgdENvbmZpZywgaGFzKQp7CiAgICAvKioKICAgIFRocnVzdCBFdmVudHMgYXJlIGJhc2VkIG9mZiBvZiB0aGUgQmFja2JvbmUgZXZlbnQgbW9kZWwsIHdpdGggc3BlY2lhbCBhZGRpdGlvbnMuCgogICAgKiBFdmVudHMgY2FuIGJlIGZpcmVkIGFzeW5jcm9ub3VzbHkuCiAgICAqIEV2ZW50cyBjYW4gYmUgbmFtZXNwYWNlZC4KCiAgICBAbW9kdWxlIHRocnVzdAogICAgQHN1Ym1vZHVsZSBFdmVudHMKICAgICoqLwoKICAgIAogICAgLy8gICAgIEJhY2tib25lLmpzIDAuOS4xCiAgICAvLyAgICAgKGMpIDIwMTAtMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgogICAgLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogICAgLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKICAgIC8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKCiAgICB2YXIgc2xpY2UgID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAogICAgICAgIGFzeW5jRmlyZSwKICAgICAgICBub29wICAgPSB1dGlsLm5vb3AsCiAgICAgICAgd2hlbiAgID0gdXRpbC53aGVuLAogICAgICAgIHNpemUgICA9IHV0aWwuc2l6ZSwKICAgICAgICBlYWNoICAgPSB1dGlsLmVhY2gsCiAgICAgICAgZGVmZXIgID0gdXRpbC5kZWZlciwKICAgICAgICBleHRlbmQgPSB1dGlsLmV4dGVuZCwKICAgICAgICBmb3JtYXQgPSB1dGlsLmZvcm1hdDsKCiAgICB2YXIgZXZlbnRTcGxpdHRlciA9IC9ccysvLCBfdHJpZ2dlciwgdHJpZ2dlckNhbGxiYWNrLCB0cmlnZ2VyQXN5bmNDYWxsYmFjaywgdHJpZ2dlck5vZGVzLCBBTEwgPSAnYWxsJywgU1RBUkFMTCA9ICcqYWxsJywgbm9ybWFsaXplRXZlbnRzLCBnZXROYW1lc3BhY2VEYXRhLCBfb2ZmUHJvY2Vzc05vZGU7CiAgICAvKioKICAgIE5vcm1hbGl6ZXMgdGhlIGdpdmVuIGV2ZW50cyB0byB0aGUgZXhwZWN0ZWQgbmFtZXNwYWNlLgoKICAgIEBtZXRob2Qgbm9ybWFsaXplRXZlbnRzCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBUaGUgZXZlbnRzIGRlbGltaXRlZCBieSBhIHNwYWNlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZXNwYWNlIFRoZSBuYW1lc3BhY2UsIGluY2x1ZGluZyBwcmVmaXhlZCAnLicKICAgICoqLwogICAgbm9ybWFsaXplRXZlbnRzID0gZnVuY3Rpb24gKGV2ZW50cywgbmFtZXNwYWNlKQogICAgewogICAgICAgIGV2ZW50cyA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGV2ZW50cy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBldmVudHNbaV0gPSBldmVudHNbaV0gKyBuYW1lc3BhY2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBldmVudHMuam9pbignICcpOwogICAgfTsKCiAgICAvKioKICAgIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KCiAgICBAbWV0aG9kIF90cmlnZ2VyCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgICAgICBkZWxpbWl0ZWQgYnkgYSBzcGFjZS4KICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgQHJldHVybnMgSWYgYXN5bmMgdGhlbiByZXR1cm5zIGEgUHJvbWlzZSwgd2hlcmUgdGhlIGZpcnN0IGFyZ3VtZW50IGNvbnRhaW5zIGFsbCB0aGUgcmV0dXJuZWQgdmFsdWVzLCBhcyBhbiBhcnJheQogICAgICAgICAgICAgSWYgc3luYyB0aGVuIHJldHVybnMgYW4gYXJyYXkgb2YgdGhlIHJldHVybiB2YWx1ZXMuCiAgICAgICAgICAgICBJZiBtb3JlIHRoYW4gb25lIGV2ZW50LCByZXR1cm5zIGFuIG9iamVjdCBvZiBhcnJheXMgb3IgcHJvbWlzZXMsIHdpdGggdGhlIGtleSBmb3IgZWFjaCBldmVudC4KICAgICoqLwogICAgX3RyaWdnZXIgPSBmdW5jdGlvbiAoYXN5bmMsIGV2ZW50cykKICAgIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGV2ZW50LCBub2RlLCBjYWxscywgdGFpbCwgYXJncywgYWxsLCByZXN0LCBuYW1lc3BhY2UsIG9uY2VOb2RlczsKICAgICAgICBpZiAoIShjYWxscyA9IHRoaXMuX2NhbGxiYWNrcykpIHJldHVybiB0aGF0OwogICAgICAgIGFsbCA9IGNhbGxzLmFsbDsKICAgICAgICBldmVudHMgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgICAgcmVzdCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKCiAgICAgICAgd2hpbGUgKGV2ZW50ID0gZXZlbnRzLnNoaWZ0KCkpCiAgICAgICAgewogICAgICAgICAgICBpZiAobm9kZSA9IGNhbGxzW2V2ZW50XSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHJpZ2dlck5vZGVzKHRoYXQsIGV2ZW50LCBhc3luYywgbm9kZSwgcmVzdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPSBhbGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJOb2Rlcyh0aGF0LCBBTEwsIGFzeW5jLCBub2RlLCBbZXZlbnRdLmNvbmNhdChyZXN0KSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgVHJpZ2dlcnMgYWxsIGV2ZW50cyBvbiBhIG5vZGUuCiAgICBBbHNvIHVuYmluZHMgYW55IG5vZGUgdGhhdCBpcyBzZXQgdG8gb25seSBiZSBjYWxsZWQgb25jZS4KCiAgICBAbWV0aG9kIHRyaWdnZXJOb2RlcwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSB0aGF0IFRoZSBldmVudCBjb250YWluZXIgY29udGV4dC4KICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudCBUaGUgZXZlbnQgdG8gYmUgYm91bmQgb3IgdW5ib3VuZC4KICAgIEBwYXJhbSB7Qm9vbGVhbn0gYXN5bmMgRmlyZSBldmVudCBhc3luYyBvciBzeW5jCiAgICBAcGFyYW0ge09iamVjdH0gbm9kZSBUaGUgbm9kZSBsaW5rZWQgbGlzdC4KICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIHRyaWdnZXJlZCBub2RlcwoKICAgICoqLwogICAgdHJpZ2dlck5vZGVzID0gZnVuY3Rpb24gKHRoYXQsIGV2ZW50LCBhc3luYywgbm9kZUxpc3QsIGFyZ3MpCiAgICB7CiAgICAgICAgdmFyIHRhaWwsIG9uY2VOb2RlcyA9IFtdOwoKICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdCgnezB9OiB0cmlnZ2VyaW5nIHsxfSBldmVudCAiezJ9IicsIHRoYXQuX19wdWJTdWJOYW1lLCBhc3luYyAmJiAnYXN5bmMnIHx8ICcnLCBldmVudCkpOwoKICAgICAgICBlYWNoKG5vZGVMaXN0LCBmdW5jdGlvbiAobm9kZSkKICAgICAgICB7CiAgICAgICAgICAgIHRhaWwgPSBub2RlLnRhaWw7CiAgICAgICAgICAgIHdoaWxlICgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJDYWxsYmFjayhhc3luYywgbm9kZS5jYWxsYmFjaywgbm9kZS5jb250ZXh0IHx8IHRoYXQsIGFyZ3MpOwogICAgICAgICAgICAgICAgbm9kZS5vbmNlICYmIG9uY2VOb2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYgKG9uY2VOb2Rlcy5sZW5ndGgpIGVhY2gob25jZU5vZGVzLCBmdW5jdGlvbiAoeCkgeyB0aGF0LnVuc3Vic2NyaWJlKGV2ZW50LCB4LmNhbGxiYWNrLCB4LmNvbnRleHQsIHgubmFtZXNwYWNlKTsgfSk7CiAgICB9OwoKICAgIC8qKgogICAgSW52b2tlcyBhIHRyaWdnZXIgY2FsbGJhY2sKCiAgICBAbWV0aG9kIHRyaWdnZXJDYWxsYmFjawogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7Qm9vbGVhbn0gYXN5bmMgRmlyZSBldmVudCBhc3luYyBvciBzeW5jCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kCiAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY2FsbGluZyBjb250ZXh0CiAgICBAcGFyYW0ge0FycmF5fSBhcmdzIFRoZSBhcmd1bWVudHMgdG8gY2FsbCB0aGUgY2FsbGJhY2sgd2l0aC4KICAgIEByZXR1cm5zIHtPYmplY3R9IFRoZSByZXR1cm5lZCB2YWx1ZS4KICAgICAgICBGb3IgYXN5bmMgY2FsbHMsIHRoaXMgaXMgYSBwcm9taXNlCiAgICAgICAgRm9yIHN5bmMgY2FsbHMgdGhpcyBpcyB0aGUgdmFsdWUgZnJvbSB0aGUgbWV0aG9kLgogICAgKiovCiAgICB0cmlnZ2VyQ2FsbGJhY2sgPSBmdW5jdGlvbiAoYXN5bmMsIGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKQogICAgewogICAgICAgIGlmIChhc3luYykKICAgICAgICB7CiAgICAgICAgICAgIGRlZmVyKHRyaWdnZXJBc3luY0NhbGxiYWNrKGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSwgMCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7IHJldHVybiBjYWxsYmFjay5hcHBseShjb250ZXh0LCBhcmdzKTsgfQogICAgICAgICAgICBjYXRjaCAoZSkgeyBpZiAodENvbmZpZy50aHJvd0Vycm9ycykgdGhyb3cgZTsgfQogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICBDcmVhdGVzIGFuIGFzeW5jIGV2ZW50IGhhbmRsZXIKCiAgICBAbWV0aG9kIGFzeW5jRXZlbnRGYWN0b3J5CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZAogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGNhbGxpbmcgY29udGV4dAogICAgQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGguCiAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjYWxsYmFjayBmb3IgdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgICoqLwogICAgdHJpZ2dlckFzeW5jQ2FsbGJhY2sgPSBmdW5jdGlvbiAoY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpCiAgICB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICBSZXN1YnNjcmliZXMgdG8gdGhlIGFwcHJvcHJpYXRlIGV2ZW50cwoKICAgIEBtZXRob2QgX29mZlByb2Nlc3NOb2RlCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGV2ZW50IGNvbnRleHQKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudCBUaGUgZXZlbnQKICAgIEBwYXJhbSB7T2JqZWN0fSBub2RlIFRoZSBub2RlIGxpbmtlZCBsaXN0LgogICAgQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZXZlbnQgY2FsbGJhY2sgdG8gdW5zdWJzY3JpYmUKICAgIEBwYXJhbSB7T2JqZWN0fSBbY29udGV4dF0gVGhlIGV2ZW50IGNvbnRleHQgdG8gdW5zdWJzY3JpYmUKICAgIEBwYXJhbSB7U3RyaW5nfSBbbmFtZXNwYWNlXSBUaGUgbmFtZXNwYWNlIHRvIHVuc3Vic2NyaWJlCiAgICAqKi8KICAgIF9vZmZQcm9jZXNzTm9kZSA9IGZ1bmN0aW9uICh0aGF0LCBldmVudCwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICB7CiAgICAgICAgdmFyIHRhaWwsIGNiLCBjdHgsIG5zOwogICAgICAgIHRhaWwgPSBub2RlLnRhaWw7CiAgICAgICAgd2hpbGUgKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkKICAgICAgICB7CiAgICAgICAgICAgIGNiID0gbm9kZS5jYWxsYmFjazsKICAgICAgICAgICAgY3R4ID0gbm9kZS5jb250ZXh0OwogICAgICAgICAgICBucyA9IG5vZGUubmFtZXNwYWNlOwogICAgICAgICAgICBpZiAoKGNhbGxiYWNrICYmIGNiICE9PSBjYWxsYmFjaykgfHwgKGNvbnRleHQgJiYgY3R4ICE9PSBjb250ZXh0KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoZXZlbnQgKyAobnMgJiYgKCcuJyArIG5zKSB8fCAnJyksIGNiLCBjdHgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgIEdldHMgdGhlIG5hbWVzcGFjZSBpbmZvcm1hdGlvbiwgdGhlIHJlYWwgZXZlbnQgdG8gcGFzcyBiYWNrIG9udG8gdGhlIG1ldGhvZHMuCgogICAgQG1ldGhvZCBnZXROYW1lc3BhY2VEYXRhCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudCB0byBjYXB0dXJlIG5hbWVzcGFjZSBkYXRhIGZyb20uCiAgICBAcmV0dXJucyB7T2JqZWN0fSBDb250YWluaW5nIGV2ZW50IGFuZCBuYW1lc3BhY2UuCiAgICAqKi8KICAgIGdldE5hbWVzcGFjZURhdGEgPSBmdW5jdGlvbihldmVudCkKICAgIHsKICAgICAgICB2YXIgbnNJbmRleCA9IChldmVudCB8fCAnJykuaW5kZXhPZignLicpLAogICAgICAgICAgICBoYXNOcyA9IG5zSW5kZXggPiAtMSwKICAgICAgICAgICAgbmFtZXNwYWNlID0gaGFzTnMgPyBldmVudC5zdWJzdHJpbmcobnNJbmRleCArIDEpIDogdW5kZWZpbmVkLAogICAgICAgICAgICBldmVudCA9IGhhc05zID8gZXZlbnQuc3Vic3RyaW5nKDAsIG5zSW5kZXgpIDogZXZlbnQ7CgogICAgICAgIGlmIChuc0luZGV4ID09PSAwKQogICAgICAgICAgICBldmVudCA9IFNUQVJBTEw7CgogICAgICAgIHJldHVybiB7IGV2ZW50OiBldmVudCwgbmFtZXNwYWNlOiBuYW1lc3BhY2UgfTsKICAgIH07CgogICAgLyoqCiAgICBUaHJ1c3QgRXZlbnRzIGFyZSBiYXNlZCBvZmYgb2YgdGhlIEJhY2tib25lIGV2ZW50IG1vZGVsLCB3aXRoIHNwZWNpYWwgYWRkaXRpb25zLgoKICAgICogRXZlbnRzIGNhbiBiZSBmaXJlZCBhc3luY3Jvbm91c2x5LgogICAgKiBFdmVudHMgY2FuIGJlIG5hbWVzcGFjZWQuCgogICAgQGNsYXNzIEV2ZW50cwogICAgKiovCiAgICB2YXIgRXZlbnRzID0gewogICAgICAgIC8qKgogICAgICAgIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgYGV2ZW50c2AsIHRvIGEgYGNhbGxiYWNrYAogICAgICAgIGZ1bmN0aW9uLiBQYXNzaW5nIGAiYWxsImAgd2lsbCBiaW5kIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgoKICAgICAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IG9uY2UgQ2FsbCB0aGlzIGV2ZW50IG9ubHkgb25jZS4KICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgKiovCiAgICAgICAgc3Vic2NyaWJlOiBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjYWxscywgZXZlbnQsIG5vZGUsIHRhaWwsIGxpc3QsIG5kOwogICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlICYmIChldmVudHMgPSBub3JtYWxpemVFdmVudHMoZXZlbnRzLCB0aGlzLl9fbmFtZXNwYWNlKSk7CgogICAgICAgICAgICBldmVudHMgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgICAgICAgIGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzIHx8ICh0aGlzLl9jYWxsYmFja3MgPSB7fSk7CgogICAgICAgICAgICAvLyBDcmVhdGUgYW4gaW1tdXRhYmxlIGNhbGxiYWNrIGxpc3QsIGFsbG93aW5nIHRyYXZlcnNhbCBkdXJpbmcKICAgICAgICAgICAgLy8gbW9kaWZpY2F0aW9uLiAgVGhlIHRhaWwgaXMgYW4gZW1wdHkgb2JqZWN0IHRoYXQgd2lsbCBhbHdheXMgYmUgdXNlZAogICAgICAgICAgICAvLyBhcyB0aGUgbmV4dCBub2RlLgogICAgICAgICAgICB3aGlsZSAoZXZlbnQgPSBldmVudHMuc2hpZnQoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmQgPSBnZXROYW1lc3BhY2VEYXRhKGV2ZW50KTsKICAgICAgICAgICAgICAgIGV2ZW50ID0gbmQuZXZlbnQ7CiAgICAgICAgICAgICAgICBsaXN0ID0gY2FsbHNbZXZlbnRdIHx8IChjYWxsc1tldmVudF0gPSB7fSk7CiAgICAgICAgICAgICAgICBsaXN0ID0gbGlzdFtuZC5uYW1lc3BhY2VdOwogICAgICAgICAgICAgICAgbm9kZSA9IGxpc3QgPyBsaXN0LnRhaWwgOiB7fTsKICAgICAgICAgICAgICAgIG5vZGUubmV4dCA9IHRhaWwgPSB7fTsKICAgICAgICAgICAgICAgIG5vZGUuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICAgICAgICBub2RlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBub2RlLm5hbWVzcGFjZSA9IG5kLm5hbWVzcGFjZTsKICAgICAgICAgICAgICAgIG5vZGUub25jZSA9IG9uY2U7CiAgICAgICAgICAgICAgICBjYWxsc1tldmVudF1bbmQubmFtZXNwYWNlXSA9IHsgdGFpbDogdGFpbCwgbmV4dDogbGlzdCA/IGxpc3QubmV4dCA6IG5vZGUgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgICAgICBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KCiAgICAgICAgRWFjaCBldmVudCB3aWxsIG9ubHkgYmUgY2FsbGVkIG9uY2UuCgogICAgICAgIEBtZXRob2Qgb25jZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgKiovCiAgICAgICAgb25jZTogZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zdWJzY3JpYmUoZXZlbnRzLCBvbmNlQ2FsbGJhY2ssIGNvbnRleHQsIHRydWUpOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGNhbGxiYWNrcwogICAgICAgIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MgZm9yIHRoZQogICAgICAgIGV2ZW50LiBJZiBgZXZlbnRgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KCiAgICAgICAgQG1ldGhvZCB1bnN1YnNjcmliZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgKiovCiAgICAgICAgdW5zdWJzY3JpYmU6IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGV2ZW50LCBjYWxscywgbm9kZSwgbmQsIG91ck5zLCBuYW1lc3BhY2UsIHRoYXQgPSB0aGlzLCBoYXNOczsKCiAgICAgICAgICAgIG91ck5zID0gdGhhdC5fX25hbWVzcGFjZTsgb3VyTnMgJiYgKG91ck5zID0gb3VyTnMuc3Vic3RyaW5nKDEpKTsKICAgICAgICAgICAgLy8gTm8gZXZlbnRzLCBvciByZW1vdmluZyAqYWxsKiBldmVudHMuCiAgICAgICAgICAgIGlmICghKGNhbGxzID0gdGhhdC5fY2FsbGJhY2tzKSkgcmV0dXJuOwogICAgICAgICAgICBpZiAoIShldmVudHMgfHwgY2FsbGJhY2sgfHwgY29udGV4dCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghb3VyTnMpCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoYXQuX2NhbGxiYWNrczsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2JzID0gdGhhdC5fY2FsbGJhY2tzOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gY2JzKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNic1tpXVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaXplKGNic1tpXSkgPT09IDApIGRlbGV0ZSBjYnNbaV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgbGlzdGVkIGV2ZW50cyBhbmQgY29udGV4dHMsIHNwbGljaW5nIHRoZW0gb3V0IG9mIHRoZQogICAgICAgICAgICAvLyBsaW5rZWQgbGlzdCBvZiBjYWxsYmFja3MgaWYgYXBwcm9wcmlhdGUuCiAgICAgICAgICAgIG91ck5zICYmIChldmVudHMgPSBub3JtYWxpemVFdmVudHMoZXZlbnRzLCB0aGF0Ll9fbmFtZXNwYWNlKSk7CiAgICAgICAgICAgIGV2ZW50cyA9IGV2ZW50cyA/IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKSA6IF8ua2V5cyhjYWxscyk7CiAgICAgICAgICAgIHdoaWxlIChldmVudCA9IGV2ZW50cy5zaGlmdCgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuZCA9IGdldE5hbWVzcGFjZURhdGEoZXZlbnQpOwogICAgICAgICAgICAgICAgZXZlbnQgPSBuZC5ldmVudDsKICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA9IG5kLm5hbWVzcGFjZTsKICAgICAgICAgICAgICAgIGhhc05zID0gISFuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICBpZiAoIW91ck5zKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNhbGxzW2V2ZW50XSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdW291ck5zXTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbHNbZXZlbnRdW291ck5zXTsKICAgICAgICAgICAgICAgICAgICBpZiAoc2l6ZShjYWxsc1tldmVudF0pID09PSAwKSBkZWxldGUgY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFub2RlIHx8ICEoY2FsbGJhY2sgfHwgY29udGV4dCkpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIC8qaWYgKGV2ZW50ICE9PSBTVEFSQUxMKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfSovCiAgICAgICAgICAgICAgICBpZiAoZXZlbnQgIT09IFNUQVJBTEwgJiYgIWNhbGxiYWNrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBldmVudCwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoZXZlbnQgPT09IEFMTCB8fCAhY2FsbGJhY2spCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBjYWxscykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNOcykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX29mZlByb2Nlc3NOb2RlKHRoYXQsIGksIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAgICBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgICAgICAgICAgcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgICAgICAgICAgKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgICAgICAgICByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgZmlyZQogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gZXZlbnRzIFRoZSBldmVudHMgdG8gYmUgZmlyZWQuCiAgICAgICAgICAgICAgICBkZWxpbWl0ZWQgYnkgYSBzcGFjZS4KICAgICAgICAgICAgQHBhcmFtIFthcmdzXSogVGhlIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIGNhbGxiYWNrIG1ldGhvZHMuCiAgICAgICAgICAgIEByZXR1cm5zIHtBcnJheSBvZiBWYWx1ZXN9IElmIG1vcmUgdGhhbiBvbiBldmVudCBpcyBmaXJlZCwgYW4gT2JqZWN0IG9mIEFycmF5cyBpcyByZXR1cm5lZC4KICAgICAgICAqKi8KICAgICAgICBmaXJlOiBmdW5jdGlvbiAoZXZlbnRzKQogICAgICAgIHsKICAgICAgICAgICAgX3RyaWdnZXIuYXBwbHkodGhpcywgW2ZhbHNlXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgX19wdWJTdWJOYW1lOiAnRXZlbnRzJywKICAgICAgICAvKioKICAgICAgICBJbml0J3MgdGhlIEV2ZW50IG1vZHVsZS4KICAgICAgICBUaGlzIGlzIG9ubHkgcmVxdWlyZWQgaWYgeW91IHdpc2ggdG8gdXNlIGZpcmUuYXN5bmMsIGFuZCBuYW1lc3BhY2luZy4KCiAgICAgICAgQG1ldGhvZCBpbml0RXZlbnRzCiAgICAgICAgQGNoYWluYWJsZQogICAgICAgICoqLwogICAgICAgIGluaXRFdmVudHM6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnB1Ymxpc2ggPSB0aGlzLmZpcmUgPSBFdmVudHMuZmlyZS5iaW5kKHRoaXMpOwogICAgICAgICAgICB0aGlzLmZpcmUuYXN5bmMgPSBhc3luY0ZpcmUuYmluZCh0aGlzKTsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzID0gbm9vcDsKICAgICAgICAgICAgdGhpcy5fX3B1YlN1Yk5hbWUgPSB0aGlzLm5hbWUgfHwgJ0V2ZW50cyc7CiAgICAgICAgICAgIGlmICh0aGlzLm5hbWUgJiYgIXRoaXMuX19uYW1lc3BhY2UpIHRoaXMuX19uYW1lc3BhY2UgPSAnLicgKyB0aGlzLm5hbWU7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIEV4dGVuZHMgRXZlbnRzIGludG8gdGhlIGdpdmVuIG9iamVjdC4KCiAgICAgICAgQG1ldGhvZCBleHRlbmQKICAgICAgICBAcGFyYW0ge09iamVjdH0gdG8gVGhlIG9iamVjdCBvdCBleHRlbmQgZXZlbnRzIG9udG8KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IFtpbml0XSBPcHRpb25hbGx5IGluaXQgdGhlIGV2ZW50cy4KICAgICAgICAqKi8KICAgICAgICBleHRlbmQ6IGZ1bmN0aW9uICh0bywgaW5pdCkKICAgICAgICB7CiAgICAgICAgICAgIGV4dGVuZCh0bywgRXZlbnRzKTsKICAgICAgICAgICAgZGVsZXRlIHRvLmV4dGVuZDsKICAgICAgICAgICAgaW5pdCAmJiB0by5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHJldHVybiB0bzsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICAgIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgICAgIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KCiAgICAgICAgZmlyZS5hc3luYyBydW5zIGl0cyBldmVudHMgaW1tZWRpYXRlbHkuCiAgICAKICAgICAgICBAbWV0aG9kIGZpcmUuYXN5bmMKICAgICAgICBAcGFyYW0ge09iamVjdH0gZXZlbnRzIFRoZSBldmVudHMgdG8gYmUgZmlyZWQuCiAgICAgICAgICAgIGRlbGltaXRlZCBieSBhIHNwYWNlLgogICAgICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtBcnJheSBvZiBQcm9taXNlfSBJZiBtb3JlIHRoYW4gb24gZXZlbnQgaXMgZmlyZWQsIGFuIE9iamVjdCBvZiBQcm9taXNlIEFycmF5cyBpcyByZXR1cm5lZC4KICAgICoqLwogICAgLyoqCiAgICAgICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAgICAgcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgICAgICAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAgICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgoKICAgICAgICBwdWJsaXNoLmFzeW5jIHJ1bnMgaXRzIGV2ZW50cyBpbW1lZGlhdGVseS4KICAgICAgICBwdWJsaXNoLmFzeW5jIGlzIGFuIGFsaWFzIGZvciBmaXJlLgogICAgCiAgICAgICAgQG1ldGhvZCBwdWJsaXNoLmFzeW5jCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGV2ZW50cyBUaGUgZXZlbnRzIHRvIGJlIGZpcmVkLgogICAgICAgICAgICBkZWxpbWl0ZWQgYnkgYSBzcGFjZS4KICAgICAgICBAcGFyYW0gW2FyZ3NdKiBUaGUgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgY2FsbGJhY2sgbWV0aG9kcy4KICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7QXJyYXkgb2YgUHJvbWlzZX0gSWYgbW9yZSB0aGFuIG9uIGV2ZW50IGlzIGZpcmVkLCBhbiBPYmplY3Qgb2YgUHJvbWlzZSBBcnJheXMgaXMgcmV0dXJuZWQuCiAgICAqKi8KICAgIGFzeW5jRmlyZSA9IGZ1bmN0aW9uIChldmVudHMpCiAgICB7CiAgICAgICAgX3RyaWdnZXIuYXBwbHkodGhpcywgW3RydWVdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgLyoqCiAgICAgICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAgICAgcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgICAgICAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAgICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgoKICAgICAgICBwdWJsaXNoIGlzIGFuIGFsaWFzIGZvciBmaXJlLgogICAgCiAgICAgICAgQG1ldGhvZCBwdWJsaXNoCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGV2ZW50cyBUaGUgZXZlbnRzIHRvIGJlIGZpcmVkLgogICAgICAgICAgICBkZWxpbWl0ZWQgYnkgYSBzcGFjZS4KICAgICAgICBAcGFyYW0gW2FyZ3NdKiBUaGUgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgY2FsbGJhY2sgbWV0aG9kcy4KICAgICAgICBAcmV0dXJucyBJZiBhc3luYyB0aGVuIHJldHVybnMgYSBQcm9taXNlLCB3aGVyZSB0aGUgZmlyc3QgYXJndW1lbnQgY29udGFpbnMgYWxsIHRoZSByZXR1cm5lZCB2YWx1ZXMsIGFzIGFuIGFycmF5CiAgICAgICAgICAgICAgICAgSWYgc3luYyB0aGVuIHJldHVybnMgYW4gYXJyYXkgb2YgdGhlIHJldHVybiB2YWx1ZXMuCiAgICAgICAgICAgICAgICAgSWYgbW9yZSB0aGFuIG9uZSBldmVudCwgcmV0dXJucyBhbiBvYmplY3Qgb2YgYXJyYXlzIG9yIHByb21pc2VzLCB3aXRoIHRoZSBrZXkgZm9yIGVhY2ggZXZlbnQuCiAgICAqKi8KICAgIEV2ZW50cy5wdWJsaXNoID0gRXZlbnRzLmZpcmU7CgogICAgcmV0dXJuIEV2ZW50czsKfSk7CgpkZWZpbmUoJ3RocnVzdC9mYWNhZGUnLFsKICAgICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbW9kdWxlJwpdLApmdW5jdGlvbiAodXRpbCwgTW9kdWxlKQp7CiAgICAvKioKCiAgICBUaGUgRmFjYWRlIG1vZHVsZSBvZmZlcnMgdGhlIGFiaWxpdHkgdG8gY3JlYXRlIGFuIGludGVyZmFjZSBvciBzaW1pbGFyIGNvbmNlcHQuCiAgICBXaXRoIHRoZSBGYWNhZGUgaW4gdGhydXN0LCBpdCBhbGxvd3MgeW91IHRvIGNhcHR1cmUgZXZlbnRzIGZyb20gYSBtb2R1bGUsIHdoZW4gbG9hZGVkIHZpYSBjb252ZW50aW9uLgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCgogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBzdWJtb2R1bGUgRmFjYWRlCiAgICAqKi8KCiAgICAvKioKICAgIEZhY2FkZXMgYXJlIG1haW5seSBmb3IgdXNlIGluIHRocnVzdCBwbHVnaW5zLgoKICAgIEZhY2FkZSBoYXMgdGhlc2UgYnVpbHQgaW4gbWV0aG9kczoKICAgICogaW5pdAogICAgKiBzdGFydAogICAgKiByZWFkeQogICAgKiBzdG9wCiAgICAqIGRlc3Ryb3kKCiAgICBCZWhpbmQgdGhlIHNjZW5lcyB0aGUgZmFjYWRlIG1ldGhvZHMsIGludm9rZSBhbnkgY29udmVudGlvbnMgbG9hZGVkIGZvciB0aGUgcGx1Z2luLgoKICAgIEBjbGFzcyBGYWNhZGUKICAgICoqLwogICAgdmFyIHRocnVzdENhY2hlID0gTW9kdWxlLnRocnVzdENhY2hlOwoKICAgIHZhciBGYWNhZGUsCiAgICAgICAgZm9ybWF0ICAgICAgICAgICA9IHV0aWwuZm9ybWF0LAogICAgICAgIGZhY2FkZU1ldGhvZHMgICAgPSBbJ2luaXQnLCAnc3RhcnQnLCAncmVhZHknLCAnc3RvcCcsICdkZXN0cm95J10sCiAgICAgICAgZGVmYXVsdFByb3RvdHlwZSA9IHt9LAoKICAgICAgICBjb252ZW50aW9uRnVuY3Rpb25GYWN0b3J5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChtb2R1bGUpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIHZhciByZXR1cm5WYWx1ZXMgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChtb2R1bGUgJiYgIW1vZHVsZS5jb252ZW50aW9uKQogICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IHRocnVzdENhY2hlW21vZHVsZS5taWRdLm1vZHVsZTsKICAgICAgICAgICAgICAgIGlmICh0aGF0Ll9fY29udmVudGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5zYWZlSW52b2tlKHRoYXQuX19jb252ZW50aW9ucywgbmFtZSwgdGhhdCwgbW9kdWxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgIG1ldGhvZFdyYXAgPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZikgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgZi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgewogICAgICAgIHZhciBtZXRob2QgPSBmYWNhZGVNZXRob2RzW2ldOwogICAgICAgIGRlZmF1bHRQcm90b3R5cGVbbWV0aG9kXSA9IGNvbnZlbnRpb25GdW5jdGlvbkZhY3RvcnkobWV0aG9kKTsKICAgIH0KCiAgICAvKioKICAgIEZhY2FkZSBpbml0CgogICAgQ2FsbGVkIGR1cmluZyB0aGUgaW5pdCBwaGFzZSBvZiBhIG1vZHVsZSBzdGFydHVwLgoKICAgIEBtZXRob2QgaW5pdAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwoKICAgIC8qKgogICAgRmFjYWRlIHN0YXJ0CgogICAgQ2FsbGVkIGR1cmluZyB0aGUgc3RhcnQgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KCiAgICBAbWV0aG9kIHN0YXJ0CiAgICBAcmV0dXJucyBQcm9taXNlIGFueSBmYWNhZGUgbWV0aG9kIG1heSBvcHRpb25hbGx5IHJldHVybiBhIHByb21pc2UgdG8gZGVsYXkgdGhlIHN0YXJ0IG9mIHRoZSBuZXh0IHBoYXNlLgogICAgKiovCgogICAgLyoqCiAgICBGYWNhZGUgcmVhZHkKCiAgICBDYWxsZWQgZHVyaW5nIHRoZSByZWFkeSBwaGFzZSBvZiBhIG1vZHVsZSBzdGFydHVwLgoKICAgIEBtZXRob2QgcmVhZHkKICAgIEByZXR1cm5zIFByb21pc2UgYW55IGZhY2FkZSBtZXRob2QgbWF5IG9wdGlvbmFsbHkgcmV0dXJuIGEgcHJvbWlzZSB0byBkZWxheSB0aGUgc3RhcnQgb2YgdGhlIG5leHQgcGhhc2UuCiAgICAqKi8KCiAgICAvKioKICAgIEZhY2FkZSBzdG9wCgogICAgQ2FsbGVkIGR1cmluZyB0aGUgaW5pdCBwaGFzZSBvZiBhIG1vZHVsZSBzdGFydHVwLgoKICAgIEBtZXRob2Qgc3RvcAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwoKICAgIC8qKgogICAgRmFjYWRlIGRlc3Ryb3kKCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCgogICAgQG1ldGhvZCBkZXN0cm95CiAgICBAcmV0dXJucyBQcm9taXNlIGFueSBmYWNhZGUgbWV0aG9kIG1heSBvcHRpb25hbGx5IHJldHVybiBhIHByb21pc2UgdG8gZGVsYXkgdGhlIHN0YXJ0IG9mIHRoZSBuZXh0IHBoYXNlLgogICAgKiovCgogICAgcmV0dXJuIHsKICAgICAgICAvKioKICAgICAgICBBTUQgQVBJCiAgICAgICAgbG9hZAoKICAgICAgICBIYW5kbGVzIGZldGNoaW5nIG9mIGEgbW9kdWxlIGluc3RhbmNlCgogICAgICAgIEBtZXRob2QgbG9hZAogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgICAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICAgICAqKi8KICAgICAgICBsb2FkOiBmdW5jdGlvbiAobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLAogICAgICAgICAgICAgICAgaW5zdGFuY2VOYW1lID0gcGFydHNbMF0sCiAgICAgICAgICAgICAgICBwbHVnaW5OYW1lID0gcGFydHNbMV0sCiAgICAgICAgICAgICAgICBtb2R1bGVQYXRoID0gcGFydHNbMl07CgogICAgICAgICAgICBpZiAoIWluc3RhbmNlTmFtZSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW5zdGFuY2VOYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgICAgICBpZiAoIXBsdWdpbk5hbWUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3BsdWdpbk5hbWUgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgICAgIGlmICghbW9kdWxlUGF0aCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignbW9kdWxlUGF0aCBpcyByZXF1aXJlZCEnKTsKCiAgICAgICAgICAgIHJlcXVpcmUoWyd0aHJ1c3QhJyArIGluc3RhbmNlTmFtZV0sIGZ1bmN0aW9uICh0aHJ1c3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwbHVnaW4gPSB0aHJ1c3RbcGx1Z2luTmFtZV07CiAgICAgICAgICAgICAgICBpZiAoIXBsdWdpbikKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdQbHVnaW4gInswfSIgZG9lcyBub3QgZXhpc3Qgb24gdGhydXN0IGluc3RhbmNlICJ7MX0iLicsIHBsdWdpbk5hbWUsIGluc3RhbmNlTmFtZSkpOwoKICAgICAgICAgICAgICAgIHZhciBrZXkgPSB0aHJ1c3QubmFtZSArICc6JyArIG1vZHVsZVBhdGgsCiAgICAgICAgICAgICAgICAgICAgcmVhbE5hbWUgPSB1dGlsLmdldE1vZHVsZU5hbWVGb3JQYXRoKG1vZHVsZVBhdGgpLAogICAgICAgICAgICAgICAgICAgIHRocnVzdE1vZHVsZUNhY2hlSXRlbSA9IHRocnVzdENhY2hlW2tleV0gfHwgKHRocnVzdENhY2hlW2tleV0gPSB7IG5hbWU6IHJlYWxOYW1lLCBtaWQ6IGtleSwgZmFjYWRlczoge30sIGluc3RhbmNlOiB7IG5hbWU6IHJlYWxOYW1lIH0gfSk7CgogICAgICAgICAgICAgICAgdmFyIGZhY2FkZSA9IHBsdWdpbi5jcmVhdGVGYWNhZGUodGhydXN0LCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9hZChmYWNhZGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGNyZWF0ZUZhY2FkZTogZnVuY3Rpb24oaW5pdE1ldGhvZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBGYWNhZGUgPSBmdW5jdGlvbiAobW9kdWxlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpbml0TWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBmYWNhZGVNZXRob2RzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWV0aG9kID0gZmFjYWRlTWV0aG9kc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1ttZXRob2RdICE9PSBkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzW21ldGhvZF0gPSB1dGlsLndyYXAodGhpc1ttZXRob2RdLCBtZXRob2RXcmFwKGRlZmF1bHRQcm90b3R5cGVbbWV0aG9kXSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgICAgIC8vdGhpcy5pbml0KG1vZHVsZSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBGYWNhZGUuZm4gPSBGYWNhZGUucHJvdG90eXBlID0gdXRpbC5leHRlbmQoewogICAgICAgICAgICAgICAgdXBkYXRlRmFjYWRlOiBmdW5jdGlvbiAoKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGluaXRNZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZGVmYXVsdFByb3RvdHlwZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gRmFjYWRlOwogICAgICAgIH0KICAgIH07Cn0pOwovKiEKICogalF1ZXJ5IEphdmFTY3JpcHQgTGlicmFyeSB2MS44LjBwcmUKICogaHR0cDovL2pxdWVyeS5jb20vCiAqCiAqIENvcHlyaWdodCAoYykgMjAxMiBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIEluY2x1ZGVzIFNpenpsZS5qcwogKiBodHRwOi8vc2l6emxlanMuY29tLwogKiBDb3B5cmlnaHQgMjAxMiwgVGhlIERvam8gRm91bmRhdGlvbgogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlULCBCU0QsIGFuZCBHUEwgTGljZW5zZXMuCiAqCiAqIERhdGU6IFdlZCBBdWcgMDEgMjAxMiAwMTo1MTo1MiBHTVQtMDYwMCAoTW91bnRhaW4gRGF5bGlnaHQgVGltZSkKICovCihmdW5jdGlvbiggd2luZG93LCB1bmRlZmluZWQgKSB7CnZhcgoJLy8gQSBjZW50cmFsIHJlZmVyZW5jZSB0byB0aGUgcm9vdCBqUXVlcnkoZG9jdW1lbnQpCglyb290alF1ZXJ5LAoKCS8vIFRoZSBkZWZlcnJlZCB1c2VkIG9uIERPTSByZWFkeQoJcmVhZHlMaXN0LAoKCS8vIFVzZSB0aGUgY29ycmVjdCBkb2N1bWVudCBhY2NvcmRpbmdseSB3aXRoIHdpbmRvdyBhcmd1bWVudCAoc2FuZGJveCkKCWRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50LAoJbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCgluYXZpZ2F0b3IgPSB3aW5kb3cubmF2aWdhdG9yLAoKCS8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQoJX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksCgoJLy8gTWFwIG92ZXIgdGhlICQgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV8kID0gd2luZG93LiQsCgoJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byBzb21lIGNvcmUgbWV0aG9kcwoJY29yZV9wdXNoID0gQXJyYXkucHJvdG90eXBlLnB1c2gsCgljb3JlX3NsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAoJY29yZV9pbmRleE9mID0gQXJyYXkucHJvdG90eXBlLmluZGV4T2YsCgljb3JlX3RvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywKCWNvcmVfaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKCWNvcmVfdHJpbSA9IFN0cmluZy5wcm90b3R5cGUudHJpbSwKCgkvLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQoJalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCS8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwoJCXJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0LCByb290alF1ZXJ5ICk7Cgl9LAoKCS8vIFVzZWQgZm9yIG1hdGNoaW5nIG51bWJlcnMKCWNvcmVfcG51bSA9IC9bXC0rXT8oPzpcZCpcLnwpXGQrKD86W2VFXVtcLStdP1xkK3wpLy5zb3VyY2UsCgoJLy8gVXNlZCBmb3IgZGV0ZWN0aW5nIGFuZCB0cmltbWluZyB3aGl0ZXNwYWNlCgljb3JlX3Jub3R3aGl0ZSA9IC9cUy8sCgljb3JlX3JzcGFjZSA9IC9ccysvLAoKCS8vIElFIGRvZXNuJ3QgbWF0Y2ggbm9uLWJyZWFraW5nIHNwYWNlcyB3aXRoIFxzCglydHJpbSA9IGNvcmVfcm5vdHdoaXRlLnRlc3QoIlx4QTAiKSA/ICgvXltcc1x4QTBdK3xbXHNceEEwXSskL2cpIDogL15ccyt8XHMrJC9nLAoKCS8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzCgkvLyBQcmlvcml0aXplICNpZCBvdmVyIDx0YWc+IHRvIGF2b2lkIFhTUyB2aWEgbG9jYXRpb24uaGFzaCAoIzk1MjEpCglycXVpY2tFeHByID0gL14oPzpbXiM8XSooPFtcd1xXXSs+KVtePl0qJHwjKFtcd1wtXSopJCkvLAoKCS8vIE1hdGNoIGEgc3RhbmRhbG9uZSB0YWcKCXJzaW5nbGVUYWcgPSAvXjwoXHcrKVxzKlwvPz4oPzo8XC9cMT58KSQvLAoKCS8vIEpTT04gUmVnRXhwCglydmFsaWRjaGFycyA9IC9eW1xdLDp7fVxzXSokLywKCXJ2YWxpZGJyYWNlcyA9IC8oPzpefDp8LCkoPzpccypcWykrL2csCglydmFsaWRlc2NhcGUgPSAvXFwoPzpbIlxcXC9iZm5ydF18dVtcZGEtZkEtRl17NH0pL2csCglydmFsaWR0b2tlbnMgPSAvIlteIlxcXHJcbl0qInx0cnVlfGZhbHNlfG51bGx8LT8oPzpcZFxkKlwufClcZCsoPzpbZUVdW1wtK10/XGQrfCkvZywKCgkvLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKCXJtc1ByZWZpeCA9IC9eLW1zLS8sCglyZGFzaEFscGhhID0gLy0oW1xkYS16XSkvZ2ksCgoJLy8gVXNlZCBieSBqUXVlcnkuY2FtZWxDYXNlIGFzIGNhbGxiYWNrIHRvIHJlcGxhY2UoKQoJZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uKCBhbGwsIGxldHRlciApIHsKCQlyZXR1cm4gKCBsZXR0ZXIgKyAiIiApLnRvVXBwZXJDYXNlKCk7Cgl9LAoKCS8vIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCglET01Db250ZW50TG9hZGVkID0gZnVuY3Rpb24oKSB7CgkJaWYgKCBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyICkgewoJCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIERPTUNvbnRlbnRMb2FkZWQsIGZhbHNlICk7CgkJCWpRdWVyeS5yZWFkeSgpOwoJCX0gZWxzZSBpZiAoIGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgKSB7CgkJCS8vIHdlJ3JlIGhlcmUgYmVjYXVzZSByZWFkeVN0YXRlID09PSAiY29tcGxldGUiIGluIG9sZElFCgkJCS8vIHdoaWNoIGlzIGdvb2QgZW5vdWdoIGZvciB1cyB0byBjYWxsIHRoZSBkb20gcmVhZHkhCgkJCWRvY3VtZW50LmRldGFjaEV2ZW50KCAib25yZWFkeXN0YXRlY2hhbmdlIiwgRE9NQ29udGVudExvYWRlZCApOwoJCQlqUXVlcnkucmVhZHkoKTsKCQl9Cgl9LAoKCS8vIFtbQ2xhc3NdXSAtPiB0eXBlIHBhaXJzCgljbGFzczJ0eXBlID0ge307CgpqUXVlcnkuZm4gPSBqUXVlcnkucHJvdG90eXBlID0gewoJY29uc3RydWN0b3I6IGpRdWVyeSwKCWluaXQ6IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeSApIHsKCQl2YXIgbWF0Y2gsIGVsZW0sIHJldCwgZG9jOwoKCQkvLyBIYW5kbGUgJCgiIiksICQobnVsbCksICQodW5kZWZpbmVkKSwgJChmYWxzZSkKCQlpZiAoICFzZWxlY3RvciApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBIYW5kbGUgJChET01FbGVtZW50KQoJCWlmICggc2VsZWN0b3Iubm9kZVR5cGUgKSB7CgkJCXRoaXMuY29udGV4dCA9IHRoaXNbMF0gPSBzZWxlY3RvcjsKCQkJdGhpcy5sZW5ndGggPSAxOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIEhhbmRsZSBIVE1MIHN0cmluZ3MKCQlpZiAoIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CgkJCWlmICggc2VsZWN0b3IuY2hhckF0KDApID09PSAiPCIgJiYgc2VsZWN0b3IuY2hhckF0KCBzZWxlY3Rvci5sZW5ndGggLSAxICkgPT09ICI+IiAmJiBzZWxlY3Rvci5sZW5ndGggPj0gMyApIHsKCQkJCS8vIEFzc3VtZSB0aGF0IHN0cmluZ3MgdGhhdCBzdGFydCBhbmQgZW5kIHdpdGggPD4gYXJlIEhUTUwgYW5kIHNraXAgdGhlIHJlZ2V4IGNoZWNrCgkJCQltYXRjaCA9IFsgbnVsbCwgc2VsZWN0b3IsIG51bGwgXTsKCgkJCX0gZWxzZSB7CgkJCQltYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKTsKCQkJfQoKCQkJLy8gTWF0Y2ggaHRtbCBvciBtYWtlIHN1cmUgbm8gY29udGV4dCBpcyBzcGVjaWZpZWQgZm9yICNpZAoJCQlpZiAoIG1hdGNoICYmIChtYXRjaFsxXSB8fCAhY29udGV4dCkgKSB7CgoJCQkJLy8gSEFORExFOiAkKGh0bWwpIC0+ICQoYXJyYXkpCgkJCQlpZiAoIG1hdGNoWzFdICkgewoJCQkJCWNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFswXSA6IGNvbnRleHQ7CgkJCQkJZG9jID0gKCBjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IGRvY3VtZW50ICk7CgoJCQkJCS8vIHNjcmlwdHMgaXMgdHJ1ZSBmb3IgYmFjay1jb21wYXQKCQkJCQlzZWxlY3RvciA9IGpRdWVyeS5wYXJzZUhUTUwoIG1hdGNoWzFdLCBkb2MsIHRydWUgKTsKCQkJCQlpZiAoIHJzaW5nbGVUYWcudGVzdCggbWF0Y2hbMV0gKSAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdCggY29udGV4dCApICkgewoJCQkJCQl0aGlzLmF0dHIuY2FsbCggc2VsZWN0b3IsIGNvbnRleHQsIHRydWUgKTsKCQkJCQl9CgoJCQkJCXJldHVybiBqUXVlcnkubWVyZ2UoIHRoaXMsIHNlbGVjdG9yICk7CgoJCQkJLy8gSEFORExFOiAkKCNpZCkKCQkJCX0gZWxzZSB7CgkJCQkJZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFsyXSApOwoKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUgYW5kIE9wZXJhIHJldHVybiBpdGVtcwoJCQkJCQkvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKCQkJCQkJaWYgKCBlbGVtLmlkICE9PSBtYXRjaFsyXSApIHsKCQkJCQkJCXJldHVybiByb290alF1ZXJ5LmZpbmQoIHNlbGVjdG9yICk7CgkJCQkJCX0KCgkJCQkJCS8vIE90aGVyd2lzZSwgd2UgaW5qZWN0IHRoZSBlbGVtZW50IGRpcmVjdGx5IGludG8gdGhlIGpRdWVyeSBvYmplY3QKCQkJCQkJdGhpcy5sZW5ndGggPSAxOwoJCQkJCQl0aGlzWzBdID0gZWxlbTsKCQkJCQl9CgoJCQkJCXRoaXMuY29udGV4dCA9IGRvY3VtZW50OwoJCQkJCXRoaXMuc2VsZWN0b3IgPSBzZWxlY3RvcjsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCgkJCS8vIEhBTkRMRTogJChleHByLCAkKC4uLikpCgkJCX0gZWxzZSBpZiAoICFjb250ZXh0IHx8IGNvbnRleHQuanF1ZXJ5ICkgewoJCQkJcmV0dXJuICggY29udGV4dCB8fCByb290alF1ZXJ5ICkuZmluZCggc2VsZWN0b3IgKTsKCgkJCS8vIEhBTkRMRTogJChleHByLCBjb250ZXh0KQoJCQkvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikKCQkJfSBlbHNlIHsKCQkJCXJldHVybiB0aGlzLmNvbnN0cnVjdG9yKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKTsKCQkJfQoKCQkvLyBIQU5ETEU6ICQoZnVuY3Rpb24pCgkJLy8gU2hvcnRjdXQgZm9yIGRvY3VtZW50IHJlYWR5CgkJfSBlbHNlIGlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHNlbGVjdG9yICkgKSB7CgkJCXJldHVybiByb290alF1ZXJ5LnJlYWR5KCBzZWxlY3RvciApOwoJCX0KCgkJaWYgKCBzZWxlY3Rvci5zZWxlY3RvciAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3Iuc2VsZWN0b3I7CgkJCXRoaXMuY29udGV4dCA9IHNlbGVjdG9yLmNvbnRleHQ7CgkJfQoKCQlyZXR1cm4galF1ZXJ5Lm1ha2VBcnJheSggc2VsZWN0b3IsIHRoaXMgKTsKCX0sCgoJLy8gU3RhcnQgd2l0aCBhbiBlbXB0eSBzZWxlY3RvcgoJc2VsZWN0b3I6ICIiLAoKCS8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKCWpxdWVyeTogIjEuOC4wcHJlIiwKCgkvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDAKCWxlbmd0aDogMCwKCgkvLyBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGNvbnRhaW5lZCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldAoJc2l6ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubGVuZ3RoOwoJfSwKCgl0b0FycmF5OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gY29yZV9zbGljZS5jYWxsKCB0aGlzICk7Cgl9LAoKCS8vIEdldCB0aGUgTnRoIGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQgT1IKCS8vIEdldCB0aGUgd2hvbGUgbWF0Y2hlZCBlbGVtZW50IHNldCBhcyBhIGNsZWFuIGFycmF5CglnZXQ6IGZ1bmN0aW9uKCBudW0gKSB7CgkJcmV0dXJuIG51bSA9PSBudWxsID8KCgkJCS8vIFJldHVybiBhICdjbGVhbicgYXJyYXkKCQkJdGhpcy50b0FycmF5KCkgOgoKCQkJLy8gUmV0dXJuIGp1c3QgdGhlIG9iamVjdAoJCQkoIG51bSA8IDAgPyB0aGlzWyB0aGlzLmxlbmd0aCArIG51bSBdIDogdGhpc1sgbnVtIF0gKTsKCX0sCgoJLy8gVGFrZSBhbiBhcnJheSBvZiBlbGVtZW50cyBhbmQgcHVzaCBpdCBvbnRvIHRoZSBzdGFjawoJLy8gKHJldHVybmluZyB0aGUgbmV3IG1hdGNoZWQgZWxlbWVudCBzZXQpCglwdXNoU3RhY2s6IGZ1bmN0aW9uKCBlbGVtcywgbmFtZSwgc2VsZWN0b3IgKSB7CgoJCS8vIEJ1aWxkIGEgbmV3IGpRdWVyeSBtYXRjaGVkIGVsZW1lbnQgc2V0CgkJdmFyIHJldCA9IGpRdWVyeS5tZXJnZSggdGhpcy5jb25zdHJ1Y3RvcigpLCBlbGVtcyApOwoKCQkvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQoJCXJldC5wcmV2T2JqZWN0ID0gdGhpczsKCgkJcmV0LmNvbnRleHQgPSB0aGlzLmNvbnRleHQ7CgoJCWlmICggbmFtZSA9PT0gImZpbmQiICkgewoJCQlyZXQuc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yICsgKCB0aGlzLnNlbGVjdG9yID8gIiAiIDogIiIgKSArIHNlbGVjdG9yOwoJCX0gZWxzZSBpZiAoIG5hbWUgKSB7CgkJCXJldC5zZWxlY3RvciA9IHRoaXMuc2VsZWN0b3IgKyAiLiIgKyBuYW1lICsgIigiICsgc2VsZWN0b3IgKyAiKSI7CgkJfQoKCQkvLyBSZXR1cm4gdGhlIG5ld2x5LWZvcm1lZCBlbGVtZW50IHNldAoJCXJldHVybiByZXQ7Cgl9LAoKCS8vIEV4ZWN1dGUgYSBjYWxsYmFjayBmb3IgZXZlcnkgZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBzZXQuCgkvLyAoWW91IGNhbiBzZWVkIHRoZSBhcmd1bWVudHMgd2l0aCBhbiBhcnJheSBvZiBhcmdzLCBidXQgdGhpcyBpcwoJLy8gb25seSB1c2VkIGludGVybmFsbHkuKQoJZWFjaDogZnVuY3Rpb24oIGNhbGxiYWNrLCBhcmdzICkgewoJCXJldHVybiBqUXVlcnkuZWFjaCggdGhpcywgY2FsbGJhY2ssIGFyZ3MgKTsKCX0sCgoJcmVhZHk6IGZ1bmN0aW9uKCBmbiApIHsKCQkvLyBBZGQgdGhlIGNhbGxiYWNrCgkJalF1ZXJ5LnJlYWR5LnByb21pc2UoKS5kb25lKCBmbiApOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXE6IGZ1bmN0aW9uKCBpICkgewoJCWkgPSAraTsKCQlyZXR1cm4gaSA9PT0gLTEgPwoJCQl0aGlzLnNsaWNlKCBpICkgOgoJCQl0aGlzLnNsaWNlKCBpLCBpICsgMSApOwoJfSwKCglmaXJzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIDAgKTsKCX0sCgoJbGFzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIC0xICk7Cgl9LAoKCXNsaWNlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGNvcmVfc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLAoJCQkic2xpY2UiLCBjb3JlX3NsaWNlLmNhbGwoYXJndW1lbnRzKS5qb2luKCIsIikgKTsKCX0sCgoJbWFwOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkubWFwKHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCQlyZXR1cm4gY2FsbGJhY2suY2FsbCggZWxlbSwgaSwgZWxlbSApOwoJCX0pKTsKCX0sCgoJZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wcmV2T2JqZWN0IHx8IHRoaXMuY29uc3RydWN0b3IobnVsbCk7Cgl9LAoKCS8vIEZvciBpbnRlcm5hbCB1c2Ugb25seS4KCS8vIEJlaGF2ZXMgbGlrZSBhbiBBcnJheSdzIG1ldGhvZCwgbm90IGxpa2UgYSBqUXVlcnkgbWV0aG9kLgoJcHVzaDogY29yZV9wdXNoLAoJc29ydDogW10uc29ydCwKCXNwbGljZTogW10uc3BsaWNlCn07CgovLyBHaXZlIHRoZSBpbml0IGZ1bmN0aW9uIHRoZSBqUXVlcnkgcHJvdG90eXBlIGZvciBsYXRlciBpbnN0YW50aWF0aW9uCmpRdWVyeS5mbi5pbml0LnByb3RvdHlwZSA9IGpRdWVyeS5mbjsKCmpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24oKSB7Cgl2YXIgb3B0aW9ucywgbmFtZSwgc3JjLCBjb3B5LCBjb3B5SXNBcnJheSwgY2xvbmUsCgkJdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LAoJCWkgPSAxLAoJCWxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCgkJZGVlcCA9IGZhbHNlOwoKCS8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KCWlmICggdHlwZW9mIHRhcmdldCA9PT0gImJvb2xlYW4iICkgewoJCWRlZXAgPSB0YXJnZXQ7CgkJdGFyZ2V0ID0gYXJndW1lbnRzWzFdIHx8IHt9OwoJCS8vIHNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKCQlpID0gMjsKCX0KCgkvLyBIYW5kbGUgY2FzZSB3aGVuIHRhcmdldCBpcyBhIHN0cmluZyBvciBzb21ldGhpbmcgKHBvc3NpYmxlIGluIGRlZXAgY29weSkKCWlmICggdHlwZW9mIHRhcmdldCAhPT0gIm9iamVjdCIgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKHRhcmdldCkgKSB7CgkJdGFyZ2V0ID0ge307Cgl9CgoJLy8gZXh0ZW5kIGpRdWVyeSBpdHNlbGYgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCglpZiAoIGxlbmd0aCA9PT0gaSApIHsKCQl0YXJnZXQgPSB0aGlzOwoJCS0taTsKCX0KCglmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkvLyBPbmx5IGRlYWwgd2l0aCBub24tbnVsbC91bmRlZmluZWQgdmFsdWVzCgkJaWYgKCAob3B0aW9ucyA9IGFyZ3VtZW50c1sgaSBdKSAhPSBudWxsICkgewoJCQkvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CgkJCWZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsKCQkJCXNyYyA9IHRhcmdldFsgbmFtZSBdOwoJCQkJY29weSA9IG9wdGlvbnNbIG5hbWUgXTsKCgkJCQkvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCgkJCQlpZiAoIHRhcmdldCA9PT0gY29weSApIHsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQkvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgcGxhaW4gb2JqZWN0cyBvciBhcnJheXMKCQkJCWlmICggZGVlcCAmJiBjb3B5ICYmICggalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0galF1ZXJ5LmlzQXJyYXkoY29weSkpICkgKSB7CgkJCQkJaWYgKCBjb3B5SXNBcnJheSApIHsKCQkJCQkJY29weUlzQXJyYXkgPSBmYWxzZTsKCQkJCQkJY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzQXJyYXkoc3JjKSA/IHNyYyA6IFtdOwoKCQkJCQl9IGVsc2UgewoJCQkJCQljbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdChzcmMpID8gc3JjIDoge307CgkJCQkJfQoKCQkJCQkvLyBOZXZlciBtb3ZlIG9yaWdpbmFsIG9iamVjdHMsIGNsb25lIHRoZW0KCQkJCQl0YXJnZXRbIG5hbWUgXSA9IGpRdWVyeS5leHRlbmQoIGRlZXAsIGNsb25lLCBjb3B5ICk7CgoJCQkJLy8gRG9uJ3QgYnJpbmcgaW4gdW5kZWZpbmVkIHZhbHVlcwoJCQkJfSBlbHNlIGlmICggY29weSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXRhcmdldFsgbmFtZSBdID0gY29weTsKCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAoJcmV0dXJuIHRhcmdldDsKfTsKCmpRdWVyeS5leHRlbmQoewoJbm9Db25mbGljdDogZnVuY3Rpb24oIGRlZXAgKSB7CgkJaWYgKCB3aW5kb3cuJCA9PT0galF1ZXJ5ICkgewoJCQl3aW5kb3cuJCA9IF8kOwoJCX0KCgkJaWYgKCBkZWVwICYmIHdpbmRvdy5qUXVlcnkgPT09IGpRdWVyeSApIHsKCQkJd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CgkJfQoKCQlyZXR1cm4galF1ZXJ5OwoJfSwKCgkvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgoJaXNSZWFkeTogZmFsc2UsCgoJLy8gQSBjb3VudGVyIHRvIHRyYWNrIGhvdyBtYW55IGl0ZW1zIHRvIHdhaXQgZm9yIGJlZm9yZQoJLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODEKCXJlYWR5V2FpdDogMSwKCgkvLyBIb2xkIChvciByZWxlYXNlKSB0aGUgcmVhZHkgZXZlbnQKCWhvbGRSZWFkeTogZnVuY3Rpb24oIGhvbGQgKSB7CgkJaWYgKCBob2xkICkgewoJCQlqUXVlcnkucmVhZHlXYWl0Kys7CgkJfSBlbHNlIHsKCQkJalF1ZXJ5LnJlYWR5KCB0cnVlICk7CgkJfQoJfSwKCgkvLyBIYW5kbGUgd2hlbiB0aGUgRE9NIGlzIHJlYWR5CglyZWFkeTogZnVuY3Rpb24oIHdhaXQgKSB7CgoJCS8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkKCQlpZiAoIHdhaXQgPT09IHRydWUgPyAtLWpRdWVyeS5yZWFkeVdhaXQgOiBqUXVlcnkuaXNSZWFkeSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gTWFrZSBzdXJlIGJvZHkgZXhpc3RzLCBhdCBsZWFzdCwgaW4gY2FzZSBJRSBnZXRzIGEgbGl0dGxlIG92ZXJ6ZWFsb3VzICh0aWNrZXQgIzU0NDMpLgoJCWlmICggIWRvY3VtZW50LmJvZHkgKSB7CgkJCXJldHVybiBzZXRUaW1lb3V0KCBqUXVlcnkucmVhZHksIDEgKTsKCQl9CgoJCS8vIFJlbWVtYmVyIHRoYXQgdGhlIERPTSBpcyByZWFkeQoJCWpRdWVyeS5pc1JlYWR5ID0gdHJ1ZTsKCgkJLy8gSWYgYSBub3JtYWwgRE9NIFJlYWR5IGV2ZW50IGZpcmVkLCBkZWNyZW1lbnQsIGFuZCB3YWl0IGlmIG5lZWQgYmUKCQlpZiAoIHdhaXQgIT09IHRydWUgJiYgLS1qUXVlcnkucmVhZHlXYWl0ID4gMCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSWYgdGhlcmUgYXJlIGZ1bmN0aW9ucyBib3VuZCwgdG8gZXhlY3V0ZQoJCXJlYWR5TGlzdC5yZXNvbHZlV2l0aCggZG9jdW1lbnQsIFsgalF1ZXJ5IF0gKTsKCgkJLy8gVHJpZ2dlciBhbnkgYm91bmQgcmVhZHkgZXZlbnRzCgkJaWYgKCBqUXVlcnkuZm4udHJpZ2dlciApIHsKCQkJalF1ZXJ5KCBkb2N1bWVudCApLnRyaWdnZXIoInJlYWR5Iikub2ZmKCJyZWFkeSIpOwoJCX0KCX0sCgoJLy8gU2VlIHRlc3QvdW5pdC9jb3JlLmpzIGZvciBkZXRhaWxzIGNvbmNlcm5pbmcgaXNGdW5jdGlvbi4KCS8vIFNpbmNlIHZlcnNpb24gMS4zLCBET00gbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGxpa2UgYWxlcnQKCS8vIGFyZW4ndCBzdXBwb3J0ZWQuIFRoZXkgcmV0dXJuIGZhbHNlIG9uIElFICgjMjk2OCkuCglpc0Z1bmN0aW9uOiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiZnVuY3Rpb24iOwoJfSwKCglpc0FycmF5OiBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uKCBvYmogKSB7CgkJcmV0dXJuIGpRdWVyeS50eXBlKG9iaikgPT09ICJhcnJheSI7Cgl9LAoKCWlzV2luZG93OiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT0gb2JqLndpbmRvdzsKCX0sCgoJaXNOdW1lcmljOiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiAhaXNOYU4oIHBhcnNlRmxvYXQob2JqKSApICYmIGlzRmluaXRlKCBvYmogKTsKCX0sCgoJdHlwZTogZnVuY3Rpb24oIG9iaiApIHsKCQlyZXR1cm4gb2JqID09IG51bGwgPwoJCQlTdHJpbmcoIG9iaiApIDoKCQkJY2xhc3MydHlwZVsgY29yZV90b1N0cmluZy5jYWxsKG9iaikgXSB8fCAib2JqZWN0IjsKCX0sCgoJaXNQbGFpbk9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQkvLyBNdXN0IGJlIGFuIE9iamVjdC4KCQkvLyBCZWNhdXNlIG9mIElFLCB3ZSBhbHNvIGhhdmUgdG8gY2hlY2sgdGhlIHByZXNlbmNlIG9mIHRoZSBjb25zdHJ1Y3RvciBwcm9wZXJ0eS4KCQkvLyBNYWtlIHN1cmUgdGhhdCBET00gbm9kZXMgYW5kIHdpbmRvdyBvYmplY3RzIGRvbid0IHBhc3MgdGhyb3VnaCwgYXMgd2VsbAoJCWlmICggIW9iaiB8fCBqUXVlcnkudHlwZShvYmopICE9PSAib2JqZWN0IiB8fCBvYmoubm9kZVR5cGUgfHwgalF1ZXJ5LmlzV2luZG93KCBvYmogKSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdHJ5IHsKCQkJLy8gTm90IG93biBjb25zdHJ1Y3RvciBwcm9wZXJ0eSBtdXN0IGJlIE9iamVjdAoJCQlpZiAoIG9iai5jb25zdHJ1Y3RvciAmJgoJCQkJIWNvcmVfaGFzT3duLmNhbGwob2JqLCAiY29uc3RydWN0b3IiKSAmJgoJCQkJIWNvcmVfaGFzT3duLmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgImlzUHJvdG90eXBlT2YiKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0gY2F0Y2ggKCBlICkgewoJCQkvLyBJRTgsOSBXaWxsIHRocm93IGV4Y2VwdGlvbnMgb24gY2VydGFpbiBob3N0IG9iamVjdHMgIzk4OTcKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy8gT3duIHByb3BlcnRpZXMgYXJlIGVudW1lcmF0ZWQgZmlyc3RseSwgc28gdG8gc3BlZWQgdXAsCgkJLy8gaWYgbGFzdCBvbmUgaXMgb3duLCB0aGVuIGFsbCBwcm9wZXJ0aWVzIGFyZSBvd24uCgoJCXZhciBrZXk7CgkJZm9yICgga2V5IGluIG9iaiApIHt9CgoJCXJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBjb3JlX2hhc093bi5jYWxsKCBvYmosIGtleSApOwoJfSwKCglpc0VtcHR5T2JqZWN0OiBmdW5jdGlvbiggb2JqICkgewoJCXZhciBuYW1lOwoJCWZvciAoIG5hbWUgaW4gb2JqICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCgllcnJvcjogZnVuY3Rpb24oIG1zZyApIHsKCQl0aHJvdyBuZXcgRXJyb3IoIG1zZyApOwoJfSwKCgkvLyBkYXRhOiBzdHJpbmcgb2YgaHRtbAoJLy8gY29udGV4dCAob3B0aW9uYWwpOiBJZiBzcGVjaWZpZWQsIHRoZSBmcmFnbWVudCB3aWxsIGJlIGNyZWF0ZWQgaW4gdGhpcyBjb250ZXh0LCBkZWZhdWx0cyB0byBkb2N1bWVudAoJLy8gc2NyaXB0cyAob3B0aW9uYWwpOiBJZiB0cnVlLCB3aWxsIGluY2x1ZGUgc2NyaXB0cyBwYXNzZWQgaW4gdGhlIGh0bWwgc3RyaW5nCglwYXJzZUhUTUw6IGZ1bmN0aW9uKCBkYXRhLCBjb250ZXh0LCBzY3JpcHRzICkgewoJCXZhciBwYXJzZWQ7CgkJaWYgKCAhZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCQlpZiAoIHR5cGVvZiBjb250ZXh0ID09PSAiYm9vbGVhbiIgKSB7CgkJCXNjcmlwdHMgPSBjb250ZXh0OwoJCQljb250ZXh0ID0gMDsKCQl9CgkJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJCS8vIFNpbmdsZSB0YWcKCQlpZiAoIChwYXJzZWQgPSByc2luZ2xlVGFnLmV4ZWMoIGRhdGEgKSkgKSB7CgkJCXJldHVybiBbIGNvbnRleHQuY3JlYXRlRWxlbWVudCggcGFyc2VkWzFdICkgXTsKCQl9CgoJCXBhcnNlZCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KCBbIGRhdGEgXSwgY29udGV4dCwgc2NyaXB0cyA/IG51bGwgOiBbXSApOwoJCXJldHVybiBqUXVlcnkubWVyZ2UoIFtdLAoJCQkocGFyc2VkLmNhY2hlYWJsZSA/IGpRdWVyeS5jbG9uZSggcGFyc2VkLmZyYWdtZW50ICkgOiBwYXJzZWQuZnJhZ21lbnQpLmNoaWxkTm9kZXMgKTsKCX0sCgoJcGFyc2VKU09OOiBmdW5jdGlvbiggZGF0YSApIHsKCQlpZiAoICFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIikgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCS8vIE1ha2Ugc3VyZSBsZWFkaW5nL3RyYWlsaW5nIHdoaXRlc3BhY2UgaXMgcmVtb3ZlZCAoSUUgY2FuJ3QgaGFuZGxlIGl0KQoJCWRhdGEgPSBqUXVlcnkudHJpbSggZGF0YSApOwoKCQkvLyBBdHRlbXB0IHRvIHBhcnNlIHVzaW5nIHRoZSBuYXRpdmUgSlNPTiBwYXJzZXIgZmlyc3QKCQlpZiAoIHdpbmRvdy5KU09OICYmIHdpbmRvdy5KU09OLnBhcnNlICkgewoJCQlyZXR1cm4gd2luZG93LkpTT04ucGFyc2UoIGRhdGEgKTsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB0aGUgaW5jb21pbmcgZGF0YSBpcyBhY3R1YWwgSlNPTgoJCS8vIExvZ2ljIGJvcnJvd2VkIGZyb20gaHR0cDovL2pzb24ub3JnL2pzb24yLmpzCgkJaWYgKCBydmFsaWRjaGFycy50ZXN0KCBkYXRhLnJlcGxhY2UoIHJ2YWxpZGVzY2FwZSwgIkAiICkKCQkJLnJlcGxhY2UoIHJ2YWxpZHRva2VucywgIl0iICkKCQkJLnJlcGxhY2UoIHJ2YWxpZGJyYWNlcywgIiIpKSApIHsKCgkJCXJldHVybiAoIG5ldyBGdW5jdGlvbiggInJldHVybiAiICsgZGF0YSApICkoKTsKCgkJfQoJCWpRdWVyeS5lcnJvciggIkludmFsaWQgSlNPTjogIiArIGRhdGEgKTsKCX0sCgoJLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZwoJcGFyc2VYTUw6IGZ1bmN0aW9uKCBkYXRhICkgewoJCXZhciB4bWwsIHRtcDsKCQlpZiAoICFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJCXRyeSB7CgkJCWlmICggd2luZG93LkRPTVBhcnNlciApIHsgLy8gU3RhbmRhcmQKCQkJCXRtcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJCXhtbCA9IHRtcC5wYXJzZUZyb21TdHJpbmcoIGRhdGEgLCAidGV4dC94bWwiICk7CgkJCX0gZWxzZSB7IC8vIElFCgkJCQl4bWwgPSBuZXcgQWN0aXZlWE9iamVjdCggIk1pY3Jvc29mdC5YTUxET00iICk7CgkJCQl4bWwuYXN5bmMgPSAiZmFsc2UiOwoJCQkJeG1sLmxvYWRYTUwoIGRhdGEgKTsKCQkJfQoJCX0gY2F0Y2goIGUgKSB7CgkJCXhtbCA9IHVuZGVmaW5lZDsKCQl9CgkJaWYgKCAheG1sIHx8ICF4bWwuZG9jdW1lbnRFbGVtZW50IHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSggInBhcnNlcmVycm9yIiApLmxlbmd0aCApIHsKCQkJalF1ZXJ5LmVycm9yKCAiSW52YWxpZCBYTUw6ICIgKyBkYXRhICk7CgkJfQoJCXJldHVybiB4bWw7Cgl9LAoKCW5vb3A6IGZ1bmN0aW9uKCkge30sCgoJLy8gRXZhbHVhdGVzIGEgc2NyaXB0IGluIGEgZ2xvYmFsIGNvbnRleHQKCS8vIFdvcmthcm91bmRzIGJhc2VkIG9uIGZpbmRpbmdzIGJ5IEppbSBEcmlzY29sbAoJLy8gaHR0cDovL3dlYmxvZ3MuamF2YS5uZXQvYmxvZy9kcmlzY29sbC9hcmNoaXZlLzIwMDkvMDkvMDgvZXZhbC1qYXZhc2NyaXB0LWdsb2JhbC1jb250ZXh0CglnbG9iYWxFdmFsOiBmdW5jdGlvbiggZGF0YSApIHsKCQlpZiAoIGRhdGEgJiYgY29yZV9ybm90d2hpdGUudGVzdCggZGF0YSApICkgewoJCQkvLyBXZSB1c2UgZXhlY1NjcmlwdCBvbiBJbnRlcm5ldCBFeHBsb3JlcgoJCQkvLyBXZSB1c2UgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgY29udGV4dCBpcyB3aW5kb3cKCQkJLy8gcmF0aGVyIHRoYW4galF1ZXJ5IGluIEZpcmVmb3gKCQkJKCB3aW5kb3cuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbiggZGF0YSApIHsKCQkJCXdpbmRvd1sgImV2YWwiIF0uY2FsbCggd2luZG93LCBkYXRhICk7CgkJCX0gKSggZGF0YSApOwoJCX0KCX0sCgoJLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwoJLy8gTWljcm9zb2Z0IGZvcmdvdCB0byBodW1wIHRoZWlyIHZlbmRvciBwcmVmaXggKCM5NTcyKQoJY2FtZWxDYXNlOiBmdW5jdGlvbiggc3RyaW5nICkgewoJCXJldHVybiBzdHJpbmcucmVwbGFjZSggcm1zUHJlZml4LCAibXMtIiApLnJlcGxhY2UoIHJkYXNoQWxwaGEsIGZjYW1lbENhc2UgKTsKCX0sCgoJbm9kZU5hbWU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9VcHBlckNhc2UoKSA9PT0gbmFtZS50b1VwcGVyQ2FzZSgpOwoJfSwKCgkvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgllYWNoOiBmdW5jdGlvbiggb2JqLCBjYWxsYmFjaywgYXJncyApIHsKCQl2YXIgbmFtZSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IG9iai5sZW5ndGgsCgkJCWlzT2JqID0gbGVuZ3RoID09PSB1bmRlZmluZWQgfHwgalF1ZXJ5LmlzRnVuY3Rpb24oIG9iaiApOwoKCQlpZiAoIGFyZ3MgKSB7CgkJCWlmICggaXNPYmogKSB7CgkJCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJCQlpZiAoIGNhbGxiYWNrLmFwcGx5KCBvYmpbIG5hbWUgXSwgYXJncyApID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggOyBpIDwgbGVuZ3RoOyApIHsKCQkJCQlpZiAoIGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkrKyBdLCBhcmdzICkgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJLy8gQSBzcGVjaWFsLCBmYXN0LCBjYXNlIGZvciB0aGUgbW9zdCBjb21tb24gdXNlIG9mIGVhY2gKCQl9IGVsc2UgewoJCQlpZiAoIGlzT2JqICkgewoJCQkJZm9yICggbmFtZSBpbiBvYmogKSB7CgkJCQkJaWYgKCBjYWxsYmFjay5jYWxsKCBvYmpbIG5hbWUgXSwgbmFtZSwgb2JqWyBuYW1lIF0gKSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgKSB7CgkJCQkJaWYgKCBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpKysgXSApID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvLyBVc2UgbmF0aXZlIFN0cmluZy50cmltIGZ1bmN0aW9uIHdoZXJldmVyIHBvc3NpYmxlCgl0cmltOiBjb3JlX3RyaW0gPwoJCWZ1bmN0aW9uKCB0ZXh0ICkgewoJCQlyZXR1cm4gdGV4dCA9PSBudWxsID8KCQkJCSIiIDoKCQkJCWNvcmVfdHJpbS5jYWxsKCB0ZXh0ICk7CgkJfSA6CgoJCS8vIE90aGVyd2lzZSB1c2Ugb3VyIG93biB0cmltbWluZyBmdW5jdGlvbmFsaXR5CgkJZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiB0ZXh0ID09IG51bGwgPwoJCQkJIiIgOgoJCQkJdGV4dC50b1N0cmluZygpLnJlcGxhY2UoIHJ0cmltLCAiIiApOwoJCX0sCgoJLy8gcmVzdWx0cyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJbWFrZUFycmF5OiBmdW5jdGlvbiggYXJyLCByZXN1bHRzICkgewoJCXZhciB0eXBlLAoJCQlyZXQgPSByZXN1bHRzIHx8IFtdOwoKCQlpZiAoIGFyciAhPSBudWxsICkgewoJCQkvLyBUaGUgd2luZG93LCBzdHJpbmdzIChhbmQgZnVuY3Rpb25zKSBhbHNvIGhhdmUgJ2xlbmd0aCcKCQkJLy8gVHdlYWtlZCBsb2dpYyBzbGlnaHRseSB0byBoYW5kbGUgQmxhY2tiZXJyeSA0LjcgUmVnRXhwIGlzc3VlcyAjNjkzMAoJCQl0eXBlID0galF1ZXJ5LnR5cGUoIGFyciApOwoKCQkJaWYgKCBhcnIubGVuZ3RoID09IG51bGwgfHwgdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZSA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlID09PSAicmVnZXhwIiB8fCBqUXVlcnkuaXNXaW5kb3coIGFyciApICkgewoJCQkJY29yZV9wdXNoLmNhbGwoIHJldCwgYXJyICk7CgkJCX0gZWxzZSB7CgkJCQlqUXVlcnkubWVyZ2UoIHJldCwgYXJyICk7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCWluQXJyYXk6IGZ1bmN0aW9uKCBlbGVtLCBhcnIsIGkgKSB7CgkJdmFyIGxlbjsKCgkJaWYgKCBhcnIgKSB7CgkJCWlmICggY29yZV9pbmRleE9mICkgewoJCQkJcmV0dXJuIGNvcmVfaW5kZXhPZi5jYWxsKCBhcnIsIGVsZW0sIGkgKTsKCQkJfQoKCQkJbGVuID0gYXJyLmxlbmd0aDsKCQkJaSA9IGkgPyBpIDwgMCA/IE1hdGgubWF4KCAwLCBsZW4gKyBpICkgOiBpIDogMDsKCgkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQkJLy8gU2tpcCBhY2Nlc3NpbmcgaW4gc3BhcnNlIGFycmF5cwoJCQkJaWYgKCBpIGluIGFyciAmJiBhcnJbIGkgXSA9PT0gZWxlbSApIHsKCQkJCQlyZXR1cm4gaTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIC0xOwoJfSwKCgltZXJnZTogZnVuY3Rpb24oIGZpcnN0LCBzZWNvbmQgKSB7CgkJdmFyIGwgPSBzZWNvbmQubGVuZ3RoLAoJCQlpID0gZmlyc3QubGVuZ3RoLAoJCQlqID0gMDsKCgkJaWYgKCB0eXBlb2YgbCA9PT0gIm51bWJlciIgKSB7CgkJCWZvciAoIDsgaiA8IGw7IGorKyApIHsKCQkJCWZpcnN0WyBpKysgXSA9IHNlY29uZFsgaiBdOwoJCQl9CgoJCX0gZWxzZSB7CgkJCXdoaWxlICggc2Vjb25kW2pdICE9PSB1bmRlZmluZWQgKSB7CgkJCQlmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGorKyBdOwoJCQl9CgkJfQoKCQlmaXJzdC5sZW5ndGggPSBpOwoKCQlyZXR1cm4gZmlyc3Q7Cgl9LAoKCWdyZXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGludiApIHsKCQl2YXIgcmV0VmFsLAoJCQlyZXQgPSBbXSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aDsKCQlpbnYgPSAhIWludjsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIG9ubHkgc2F2aW5nIHRoZSBpdGVtcwoJCS8vIHRoYXQgcGFzcyB0aGUgdmFsaWRhdG9yIGZ1bmN0aW9uCgkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCXJldFZhbCA9ICEhY2FsbGJhY2soIGVsZW1zWyBpIF0sIGkgKTsKCQkJaWYgKCBpbnYgIT09IHJldFZhbCApIHsKCQkJCXJldC5wdXNoKCBlbGVtc1sgaSBdICk7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCS8vIGFyZyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJbWFwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBhcmcgKSB7CgkJdmFyIHZhbHVlLCBrZXksCgkJCXJldCA9IFtdLAoJCQlpID0gMCwKCQkJbGVuZ3RoID0gZWxlbXMubGVuZ3RoLAoJCQkvLyBqcXVlcnkgb2JqZWN0cyBhcmUgdHJlYXRlZCBhcyBhcnJheXMKCQkJaXNBcnJheSA9IGVsZW1zIGluc3RhbmNlb2YgalF1ZXJ5IHx8IGxlbmd0aCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiICYmICggKCBsZW5ndGggPiAwICYmIGVsZW1zWyAwIF0gJiYgZWxlbXNbIGxlbmd0aCAtMSBdICkgfHwgbGVuZ3RoID09PSAwIHx8IGpRdWVyeS5pc0FycmF5KCBlbGVtcyApICkgOwoKCQkvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXIKCQlpZiAoIGlzQXJyYXkgKSB7CgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSwgYXJnICk7CgoJCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgewoJCQkJCXJldFsgcmV0Lmxlbmd0aCBdID0gdmFsdWU7CgkJCQl9CgkJCX0KCgkJLy8gR28gdGhyb3VnaCBldmVyeSBrZXkgb24gdGhlIG9iamVjdCwKCQl9IGVsc2UgewoJCQlmb3IgKCBrZXkgaW4gZWxlbXMgKSB7CgkJCQl2YWx1ZSA9IGNhbGxiYWNrKCBlbGVtc1sga2V5IF0sIGtleSwgYXJnICk7CgoJCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgewoJCQkJCXJldFsgcmV0Lmxlbmd0aCBdID0gdmFsdWU7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMKCQlyZXR1cm4gcmV0LmNvbmNhdC5hcHBseSggW10sIHJldCApOwoJfSwKCgkvLyBBIGdsb2JhbCBHVUlEIGNvdW50ZXIgZm9yIG9iamVjdHMKCWd1aWQ6IDEsCgoJLy8gQmluZCBhIGZ1bmN0aW9uIHRvIGEgY29udGV4dCwgb3B0aW9uYWxseSBwYXJ0aWFsbHkgYXBwbHlpbmcgYW55CgkvLyBhcmd1bWVudHMuCglwcm94eTogZnVuY3Rpb24oIGZuLCBjb250ZXh0ICkgewoJCXZhciB0bXAsIGFyZ3MsIHByb3h5OwoKCQlpZiAoIHR5cGVvZiBjb250ZXh0ID09PSAic3RyaW5nIiApIHsKCQkJdG1wID0gZm5bIGNvbnRleHQgXTsKCQkJY29udGV4dCA9IGZuOwoJCQlmbiA9IHRtcDsKCQl9CgoJCS8vIFF1aWNrIGNoZWNrIHRvIGRldGVybWluZSBpZiB0YXJnZXQgaXMgY2FsbGFibGUsIGluIHRoZSBzcGVjCgkJLy8gdGhpcyB0aHJvd3MgYSBUeXBlRXJyb3IsIGJ1dCB3ZSB3aWxsIGp1c3QgcmV0dXJuIHVuZGVmaW5lZC4KCQlpZiAoICFqUXVlcnkuaXNGdW5jdGlvbiggZm4gKSApIHsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgoJCS8vIFNpbXVsYXRlZCBiaW5kCgkJYXJncyA9IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzLCAyICk7CgkJcHJveHkgPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIGZuLmFwcGx5KCBjb250ZXh0LCBhcmdzLmNvbmNhdCggY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSApICk7CgkJfTsKCgkJLy8gU2V0IHRoZSBndWlkIG9mIHVuaXF1ZSBoYW5kbGVyIHRvIHRoZSBzYW1lIG9mIG9yaWdpbmFsIGhhbmRsZXIsIHNvIGl0IGNhbiBiZSByZW1vdmVkCgkJcHJveHkuZ3VpZCA9IGZuLmd1aWQgPSBmbi5ndWlkIHx8IHByb3h5Lmd1aWQgfHwgalF1ZXJ5Lmd1aWQrKzsKCgkJcmV0dXJuIHByb3h5OwoJfSwKCgkvLyBNdWx0aWZ1bmN0aW9uYWwgbWV0aG9kIHRvIGdldCBhbmQgc2V0IHZhbHVlcyBvZiBhIGNvbGxlY3Rpb24KCS8vIFRoZSB2YWx1ZS9zIGNhbiBvcHRpb25hbGx5IGJlIGV4ZWN1dGVkIGlmIGl0J3MgYSBmdW5jdGlvbgoJYWNjZXNzOiBmdW5jdGlvbiggZWxlbXMsIGZuLCBrZXksIHZhbHVlLCBjaGFpbmFibGUsIGVtcHR5R2V0LCBwYXNzICkgewoJCXZhciBleGVjLAoJCQlidWxrID0ga2V5ID09IG51bGwsCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBlbGVtcy5sZW5ndGg7CgoJCS8vIFNldHMgbWFueSB2YWx1ZXMKCQlpZiAoIGtleSAmJiB0eXBlb2Yga2V5ID09PSAib2JqZWN0IiApIHsKCQkJZm9yICggaSBpbiBrZXkgKSB7CgkJCQlqUXVlcnkuYWNjZXNzKCBlbGVtcywgZm4sIGksIGtleVtpXSwgMSwgZW1wdHlHZXQsIHZhbHVlICk7CgkJCX0KCQkJY2hhaW5hYmxlID0gMTsKCgkJLy8gU2V0cyBvbmUgdmFsdWUKCQl9IGVsc2UgaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkvLyBPcHRpb25hbGx5LCBmdW5jdGlvbiB2YWx1ZXMgZ2V0IGV4ZWN1dGVkIGlmIGV4ZWMgaXMgdHJ1ZQoJCQlleGVjID0gcGFzcyA9PT0gdW5kZWZpbmVkICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApOwoKCQkJaWYgKCBidWxrICkgewoJCQkJLy8gQnVsayBvcGVyYXRpb25zIG9ubHkgaXRlcmF0ZSB3aGVuIGV4ZWN1dGluZyBmdW5jdGlvbiB2YWx1ZXMKCQkJCWlmICggZXhlYyApIHsKCQkJCQlleGVjID0gZm47CgkJCQkJZm4gPSBmdW5jdGlvbiggZWxlbSwga2V5LCB2YWx1ZSApIHsKCQkJCQkJcmV0dXJuIGV4ZWMuY2FsbCggalF1ZXJ5KCBlbGVtICksIHZhbHVlICk7CgkJCQkJfTsKCgkJCQkvLyBPdGhlcndpc2UgdGhleSBydW4gYWdhaW5zdCB0aGUgZW50aXJlIHNldAoJCQkJfSBlbHNlIHsKCQkJCQlmbi5jYWxsKCBlbGVtcywgdmFsdWUgKTsKCQkJCQlmbiA9IG51bGw7CgkJCQl9CgkJCX0KCgkJCWlmICggZm4gKSB7CgkJCQlmb3IgKDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJCWZuKCBlbGVtc1tpXSwga2V5LCBleGVjID8gdmFsdWUuY2FsbCggZWxlbXNbaV0sIGksIGZuKCBlbGVtc1tpXSwga2V5ICkgKSA6IHZhbHVlLCBwYXNzICk7CgkJCQl9CgkJCX0KCgkJCWNoYWluYWJsZSA9IDE7CgkJfQoKCQlyZXR1cm4gY2hhaW5hYmxlID8KCQkJZWxlbXMgOgoKCQkJLy8gR2V0cwoJCQlidWxrID8KCQkJCWZuLmNhbGwoIGVsZW1zICkgOgoJCQkJbGVuZ3RoID8gZm4oIGVsZW1zWzBdLCBrZXkgKSA6IGVtcHR5R2V0OwoJfSwKCglub3c6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCk7Cgl9Cn0pOwoKalF1ZXJ5LnJlYWR5LnByb21pc2UgPSBmdW5jdGlvbiggb2JqICkgewoJaWYgKCAhcmVhZHlMaXN0ICkgewoKCQlyZWFkeUxpc3QgPSBqUXVlcnkuRGVmZXJyZWQoKTsKCgkJLy8gQ2F0Y2ggY2FzZXMgd2hlcmUgJChkb2N1bWVudCkucmVhZHkoKSBpcyBjYWxsZWQgYWZ0ZXIgdGhlCgkJLy8gYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KCQlpZiAoIGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgfHwgKCBkb2N1bWVudC5yZWFkeVN0YXRlICE9PSAibG9hZGluZyIgJiYgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApICkgewoJCQkvLyBIYW5kbGUgaXQgYXN5bmNocm9ub3VzbHkgdG8gYWxsb3cgc2NyaXB0cyB0aGUgb3Bwb3J0dW5pdHkgdG8gZGVsYXkgcmVhZHkKCQkJc2V0VGltZW91dCggalF1ZXJ5LnJlYWR5LCAxICk7CgoJCS8vIFN0YW5kYXJkcy1iYXNlZCBicm93c2VycyBzdXBwb3J0IERPTUNvbnRlbnRMb2FkZWQKCQl9IGVsc2UgaWYgKCBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyICkgewoJCQkvLyBVc2UgdGhlIGhhbmR5IGV2ZW50IGNhbGxiYWNrCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiwgRE9NQ29udGVudExvYWRlZCwgZmFsc2UgKTsKCgkJCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAibG9hZCIsIGpRdWVyeS5yZWFkeSwgZmFsc2UgKTsKCgkJLy8gSWYgSUUgZXZlbnQgbW9kZWwgaXMgdXNlZAoJCX0gZWxzZSB7CgkJCS8vIEVuc3VyZSBmaXJpbmcgYmVmb3JlIG9ubG9hZCwgbWF5YmUgbGF0ZSBidXQgc2FmZSBhbHNvIGZvciBpZnJhbWVzCgkJCWRvY3VtZW50LmF0dGFjaEV2ZW50KCAib25yZWFkeXN0YXRlY2hhbmdlIiwgRE9NQ29udGVudExvYWRlZCApOwoKCQkJLy8gQSBmYWxsYmFjayB0byB3aW5kb3cub25sb2FkLCB0aGF0IHdpbGwgYWx3YXlzIHdvcmsKCQkJd2luZG93LmF0dGFjaEV2ZW50KCAib25sb2FkIiwgalF1ZXJ5LnJlYWR5ICk7CgoJCQkvLyBJZiBJRSBhbmQgbm90IGEgZnJhbWUKCQkJLy8gY29udGludWFsbHkgY2hlY2sgdG8gc2VlIGlmIHRoZSBkb2N1bWVudCBpcyByZWFkeQoJCQl2YXIgdG9wID0gZmFsc2U7CgoJCQl0cnkgewoJCQkJdG9wID0gd2luZG93LmZyYW1lRWxlbWVudCA9PSBudWxsICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCQkJfSBjYXRjaChlKSB7fQoKCQkJaWYgKCB0b3AgJiYgdG9wLmRvU2Nyb2xsICkgewoJCQkJKGZ1bmN0aW9uIGRvU2Nyb2xsQ2hlY2soKSB7CgkJCQkJaWYgKCAhalF1ZXJ5LmlzUmVhZHkgKSB7CgoJCQkJCQl0cnkgewoJCQkJCQkJLy8gVXNlIHRoZSB0cmljayBieSBEaWVnbyBQZXJpbmkKCQkJCQkJCS8vIGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvCgkJCQkJCQl0b3AuZG9TY3JvbGwoImxlZnQiKTsKCQkJCQkJfSBjYXRjaChlKSB7CgkJCQkJCQlyZXR1cm4gc2V0VGltZW91dCggZG9TY3JvbGxDaGVjaywgNTAgKTsKCQkJCQkJfQoKCQkJCQkJLy8gYW5kIGV4ZWN1dGUgYW55IHdhaXRpbmcgZnVuY3Rpb25zCgkJCQkJCWpRdWVyeS5yZWFkeSgpOwoJCQkJCX0KCQkJCX0pKCk7CgkJCX0KCQl9Cgl9CglyZXR1cm4gcmVhZHlMaXN0LnByb21pc2UoIG9iaiApOwp9OwoKLy8gUG9wdWxhdGUgdGhlIGNsYXNzMnR5cGUgbWFwCmpRdWVyeS5lYWNoKCJCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0Ii5zcGxpdCgiICIpLCBmdW5jdGlvbihpLCBuYW1lKSB7CgljbGFzczJ0eXBlWyAiW29iamVjdCAiICsgbmFtZSArICJdIiBdID0gbmFtZS50b0xvd2VyQ2FzZSgpOwp9KTsKCi8vIEFsbCBqUXVlcnkgb2JqZWN0cyBzaG91bGQgcG9pbnQgYmFjayB0byB0aGVzZQpyb290alF1ZXJ5ID0galF1ZXJ5KGRvY3VtZW50KTsKLy8gU3RyaW5nIHRvIE9iamVjdCBvcHRpb25zIGZvcm1hdCBjYWNoZQp2YXIgb3B0aW9uc0NhY2hlID0ge307CgovLyBDb252ZXJ0IFN0cmluZy1mb3JtYXR0ZWQgb3B0aW9ucyBpbnRvIE9iamVjdC1mb3JtYXR0ZWQgb25lcyBhbmQgc3RvcmUgaW4gY2FjaGUKZnVuY3Rpb24gY3JlYXRlT3B0aW9ucyggb3B0aW9ucyApIHsKCXZhciBvYmplY3QgPSBvcHRpb25zQ2FjaGVbIG9wdGlvbnMgXSA9IHt9OwoJalF1ZXJ5LmVhY2goIG9wdGlvbnMuc3BsaXQoIGNvcmVfcnNwYWNlICksIGZ1bmN0aW9uKCBfLCBmbGFnICkgewoJCW9iamVjdFsgZmxhZyBdID0gdHJ1ZTsKCX0pOwoJcmV0dXJuIG9iamVjdDsKfQoKLyoKICogQ3JlYXRlIGEgY2FsbGJhY2sgbGlzdCB1c2luZyB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6CiAqCiAqCW9wdGlvbnM6IGFuIG9wdGlvbmFsIGxpc3Qgb2Ygc3BhY2Utc2VwYXJhdGVkIG9wdGlvbnMgdGhhdCB3aWxsIGNoYW5nZSBob3cKICoJCQl0aGUgY2FsbGJhY2sgbGlzdCBiZWhhdmVzIG9yIGEgbW9yZSB0cmFkaXRpb25hbCBvcHRpb24gb2JqZWN0CiAqCiAqIEJ5IGRlZmF1bHQgYSBjYWxsYmFjayBsaXN0IHdpbGwgYWN0IGxpa2UgYW4gZXZlbnQgY2FsbGJhY2sgbGlzdCBhbmQgY2FuIGJlCiAqICJmaXJlZCIgbXVsdGlwbGUgdGltZXMuCiAqCiAqIFBvc3NpYmxlIG9wdGlvbnM6CiAqCiAqCW9uY2U6CQkJd2lsbCBlbnN1cmUgdGhlIGNhbGxiYWNrIGxpc3QgY2FuIG9ubHkgYmUgZmlyZWQgb25jZSAobGlrZSBhIERlZmVycmVkKQogKgogKgltZW1vcnk6CQkJd2lsbCBrZWVwIHRyYWNrIG9mIHByZXZpb3VzIHZhbHVlcyBhbmQgd2lsbCBjYWxsIGFueSBjYWxsYmFjayBhZGRlZAogKgkJCQkJYWZ0ZXIgdGhlIGxpc3QgaGFzIGJlZW4gZmlyZWQgcmlnaHQgYXdheSB3aXRoIHRoZSBsYXRlc3QgIm1lbW9yaXplZCIKICoJCQkJCXZhbHVlcyAobGlrZSBhIERlZmVycmVkKQogKgogKgl1bmlxdWU6CQkJd2lsbCBlbnN1cmUgYSBjYWxsYmFjayBjYW4gb25seSBiZSBhZGRlZCBvbmNlIChubyBkdXBsaWNhdGUgaW4gdGhlIGxpc3QpCiAqCiAqCXN0b3BPbkZhbHNlOglpbnRlcnJ1cHQgY2FsbGluZ3Mgd2hlbiBhIGNhbGxiYWNrIHJldHVybnMgZmFsc2UKICoKICovCmpRdWVyeS5DYWxsYmFja3MgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCgkvLyBDb252ZXJ0IG9wdGlvbnMgZnJvbSBTdHJpbmctZm9ybWF0dGVkIHRvIE9iamVjdC1mb3JtYXR0ZWQgaWYgbmVlZGVkCgkvLyAod2UgY2hlY2sgaW4gY2FjaGUgZmlyc3QpCglvcHRpb25zID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciID8KCQkoIG9wdGlvbnNDYWNoZVsgb3B0aW9ucyBdIHx8IGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSApIDoKCQlqUXVlcnkuZXh0ZW5kKCB7fSwgb3B0aW9ucyApOwoKCXZhciAvLyBMYXN0IGZpcmUgdmFsdWUgKGZvciBub24tZm9yZ2V0dGFibGUgbGlzdHMpCgkJbWVtb3J5LAoJCS8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IHdhcyBhbHJlYWR5IGZpcmVkCgkJZmlyZWQsCgkJLy8gRmxhZyB0byBrbm93IGlmIGxpc3QgaXMgY3VycmVudGx5IGZpcmluZwoJCWZpcmluZywKCQkvLyBGaXJzdCBjYWxsYmFjayB0byBmaXJlICh1c2VkIGludGVybmFsbHkgYnkgYWRkIGFuZCBmaXJlV2l0aCkKCQlmaXJpbmdTdGFydCwKCQkvLyBFbmQgb2YgdGhlIGxvb3Agd2hlbiBmaXJpbmcKCQlmaXJpbmdMZW5ndGgsCgkJLy8gSW5kZXggb2YgY3VycmVudGx5IGZpcmluZyBjYWxsYmFjayAobW9kaWZpZWQgYnkgcmVtb3ZlIGlmIG5lZWRlZCkKCQlmaXJpbmdJbmRleCwKCQkvLyBBY3R1YWwgY2FsbGJhY2sgbGlzdAoJCWxpc3QgPSBbXSwKCQkvLyBTdGFjayBvZiBmaXJlIGNhbGxzIGZvciByZXBlYXRhYmxlIGxpc3RzCgkJc3RhY2sgPSAhb3B0aW9ucy5vbmNlICYmIFtdLAoJCS8vIEZpcmUgY2FsbGJhY2tzCgkJZmlyZSA9IGZ1bmN0aW9uKCBkYXRhICkgewoJCQltZW1vcnkgPSBvcHRpb25zLm1lbW9yeSAmJiBkYXRhOwoJCQlmaXJlZCA9IHRydWU7CgkJCWZpcmluZ0luZGV4ID0gZmlyaW5nU3RhcnQgfHwgMDsKCQkJZmlyaW5nU3RhcnQgPSAwOwoJCQlmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsKCQkJZmlyaW5nID0gdHJ1ZTsKCQkJZm9yICggOyBsaXN0ICYmIGZpcmluZ0luZGV4IDwgZmlyaW5nTGVuZ3RoOyBmaXJpbmdJbmRleCsrICkgewoJCQkJaWYgKCBsaXN0WyBmaXJpbmdJbmRleCBdLmFwcGx5KCBkYXRhWyAwIF0sIGRhdGFbIDEgXSApID09PSBmYWxzZSAmJiBvcHRpb25zLnN0b3BPbkZhbHNlICkgewoJCQkJCW1lbW9yeSA9IGZhbHNlOyAvLyBUbyBwcmV2ZW50IGZ1cnRoZXIgY2FsbHMgdXNpbmcgYWRkCgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQkJZmlyaW5nID0gZmFsc2U7CgkJCWlmICggbGlzdCApIHsKCQkJCWlmICggc3RhY2sgKSB7CgkJCQkJaWYgKCBzdGFjay5sZW5ndGggKSB7CgkJCQkJCWZpcmUoIHN0YWNrLnNoaWZ0KCkgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBtZW1vcnkgKSB7CgkJCQkJbGlzdCA9IFtdOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLmRpc2FibGUoKTsKCQkJCX0KCQkJfQoJCX0sCgkJLy8gQWN0dWFsIENhbGxiYWNrcyBvYmplY3QKCQlzZWxmID0gewoJCQkvLyBBZGQgYSBjYWxsYmFjayBvciBhIGNvbGxlY3Rpb24gb2YgY2FsbGJhY2tzIHRvIHRoZSBsaXN0CgkJCWFkZDogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGxpc3QgKSB7CgkJCQkJLy8gRmlyc3QsIHdlIHNhdmUgdGhlIGN1cnJlbnQgbGVuZ3RoCgkJCQkJdmFyIHN0YXJ0ID0gbGlzdC5sZW5ndGg7CgkJCQkJKGZ1bmN0aW9uIGFkZCggYXJncyApIHsKCQkJCQkJalF1ZXJ5LmVhY2goIGFyZ3MsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7CgkJCQkJCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBhcmcgKSAmJiAoICFvcHRpb25zLnVuaXF1ZSB8fCAhc2VsZi5oYXMoIGFyZyApICkgKSB7CgkJCQkJCQkJbGlzdC5wdXNoKCBhcmcgKTsKCQkJCQkJCX0gZWxzZSBpZiAoIGFyZyAmJiBhcmcubGVuZ3RoICkgewoJCQkJCQkJCS8vIEluc3BlY3QgcmVjdXJzaXZlbHkKCQkJCQkJCQlhZGQoIGFyZyApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9KSggYXJndW1lbnRzICk7CgkJCQkJLy8gRG8gd2UgbmVlZCB0byBhZGQgdGhlIGNhbGxiYWNrcyB0byB0aGUKCQkJCQkvLyBjdXJyZW50IGZpcmluZyBiYXRjaD8KCQkJCQlpZiAoIGZpcmluZyApIHsKCQkJCQkJZmlyaW5nTGVuZ3RoID0gbGlzdC5sZW5ndGg7CgkJCQkJLy8gV2l0aCBtZW1vcnksIGlmIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbgoJCQkJCS8vIHdlIHNob3VsZCBjYWxsIHJpZ2h0IGF3YXkKCQkJCQl9IGVsc2UgaWYgKCBtZW1vcnkgKSB7CgkJCQkJCWZpcmluZ1N0YXJ0ID0gc3RhcnQ7CgkJCQkJCWZpcmUoIG1lbW9yeSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBSZW1vdmUgYSBjYWxsYmFjayBmcm9tIHRoZSBsaXN0CgkJCXJlbW92ZTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGxpc3QgKSB7CgkJCQkJalF1ZXJ5LmVhY2goIGFyZ3VtZW50cywgZnVuY3Rpb24oIF8sIGFyZyApIHsKCQkJCQkJdmFyIGluZGV4OwoJCQkJCQl3aGlsZSggKCBpbmRleCA9IGpRdWVyeS5pbkFycmF5KCBhcmcsIGxpc3QsIGluZGV4ICkgKSA+IC0xICkgewoJCQkJCQkJbGlzdC5zcGxpY2UoIGluZGV4LCAxICk7CgkJCQkJCQkvLyBIYW5kbGUgZmlyaW5nIGluZGV4ZXMKCQkJCQkJCWlmICggZmlyaW5nICkgewoJCQkJCQkJCWlmICggaW5kZXggPD0gZmlyaW5nTGVuZ3RoICkgewoJCQkJCQkJCQlmaXJpbmdMZW5ndGgtLTsKCQkJCQkJCQl9CgkJCQkJCQkJaWYgKCBpbmRleCA8PSBmaXJpbmdJbmRleCApIHsKCQkJCQkJCQkJZmlyaW5nSW5kZXgtLTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBDb250cm9sIGlmIGEgZ2l2ZW4gY2FsbGJhY2sgaXMgaW4gdGhlIGxpc3QKCQkJaGFzOiBmdW5jdGlvbiggZm4gKSB7CgkJCQlyZXR1cm4galF1ZXJ5LmluQXJyYXkoIGZuLCBsaXN0ICkgPiAtMTsKCQkJfSwKCQkJLy8gUmVtb3ZlIGFsbCBjYWxsYmFja3MgZnJvbSB0aGUgbGlzdAoJCQllbXB0eTogZnVuY3Rpb24oKSB7CgkJCQlsaXN0ID0gW107CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gSGF2ZSB0aGUgbGlzdCBkbyBub3RoaW5nIGFueW1vcmUKCQkJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJCQlsaXN0ID0gc3RhY2sgPSBtZW1vcnkgPSB1bmRlZmluZWQ7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gSXMgaXQgZGlzYWJsZWQ/CgkJCWRpc2FibGVkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhbGlzdDsKCQkJfSwKCQkJLy8gTG9jayB0aGUgbGlzdCBpbiBpdHMgY3VycmVudCBzdGF0ZQoJCQlsb2NrOiBmdW5jdGlvbigpIHsKCQkJCXN0YWNrID0gdW5kZWZpbmVkOwoJCQkJaWYgKCAhbWVtb3J5ICkgewoJCQkJCXNlbGYuZGlzYWJsZSgpOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIElzIGl0IGxvY2tlZD8KCQkJbG9ja2VkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhc3RhY2s7CgkJCX0sCgkJCS8vIENhbGwgYWxsIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBjb250ZXh0IGFuZCBhcmd1bWVudHMKCQkJZmlyZVdpdGg6IGZ1bmN0aW9uKCBjb250ZXh0LCBhcmdzICkgewoJCQkJYXJncyA9IGFyZ3MgfHwgW107CgkJCQlhcmdzID0gWyBjb250ZXh0LCBhcmdzLnNsaWNlID8gYXJncy5zbGljZSgpIDogYXJncyBdOwoJCQkJaWYgKCBsaXN0ICYmICggIWZpcmVkIHx8IHN0YWNrICkgKSB7CgkJCQkJaWYgKCBmaXJpbmcgKSB7CgkJCQkJCXN0YWNrLnB1c2goIGFyZ3MgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlmaXJlKCBhcmdzICk7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIENhbGwgYWxsIHRoZSBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzCgkJCWZpcmU6IGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5maXJlV2l0aCggdGhpcywgYXJndW1lbnRzICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gVG8ga25vdyBpZiB0aGUgY2FsbGJhY2tzIGhhdmUgYWxyZWFkeSBiZWVuIGNhbGxlZCBhdCBsZWFzdCBvbmNlCgkJCWZpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhIWZpcmVkOwoJCQl9CgkJfTsKCglyZXR1cm4gc2VsZjsKfTsKalF1ZXJ5LmV4dGVuZCh7CgoJRGVmZXJyZWQ6IGZ1bmN0aW9uKCBmdW5jICkgewoJCXZhciB0dXBsZXMgPSBbCgkJCQkvLyBhY3Rpb24sIGFkZCBsaXN0ZW5lciwgbGlzdGVuZXIgbGlzdCwgZmluYWwgc3RhdGUKCQkJCVsgInJlc29sdmUiLCAiZG9uZSIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZXNvbHZlZCIgXSwKCQkJCVsgInJlamVjdCIsICJmYWlsIiwgalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgInJlamVjdGVkIiBdLAoJCQkJWyAibm90aWZ5IiwgInByb2dyZXNzIiwgalF1ZXJ5LkNhbGxiYWNrcygibWVtb3J5IikgXQoJCQldLAoJCQlzdGF0ZSA9ICJwZW5kaW5nIiwKCQkJcHJvbWlzZSA9IHsKCQkJCXN0YXRlOiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gc3RhdGU7CgkJCQl9LAoJCQkJYWx3YXlzOiBmdW5jdGlvbigpIHsKCQkJCQlkZWZlcnJlZC5kb25lKCBhcmd1bWVudHMgKS5mYWlsKCBhcmd1bWVudHMgKTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0sCgkJCQl0aGVuOiBmdW5jdGlvbiggLyogZm5Eb25lLCBmbkZhaWwsIGZuUHJvZ3Jlc3MgKi8gKSB7CgkJCQkJdmFyIGZucyA9IGFyZ3VtZW50czsKCQkJCQlyZXR1cm4galF1ZXJ5LkRlZmVycmVkKGZ1bmN0aW9uKCBuZXdEZWZlciApIHsKCQkJCQkJalF1ZXJ5LmVhY2goIHR1cGxlcywgZnVuY3Rpb24oIGksIHR1cGxlICkgewoJCQkJCQkJdmFyIGFjdGlvbiA9IHR1cGxlWyAwIF0sCgkJCQkJCQkJZm4gPSBmbnNbIGkgXTsKCQkJCQkJCS8vIGRlZmVycmVkWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gZm9yIGZvcndhcmRpbmcgYWN0aW9ucyB0byBuZXdEZWZlcgoJCQkJCQkJZGVmZXJyZWRbIHR1cGxlWzFdIF0oIGpRdWVyeS5pc0Z1bmN0aW9uKCBmbiApID8KCQkJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCQkJdmFyIHJldHVybmVkID0gZm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCQkJCQlpZiAoIHJldHVybmVkICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCByZXR1cm5lZC5wcm9taXNlICkgKSB7CgkJCQkJCQkJCQlyZXR1cm5lZC5wcm9taXNlKCkKCQkJCQkJCQkJCQkuZG9uZSggbmV3RGVmZXIucmVzb2x2ZSApCgkJCQkJCQkJCQkJLmZhaWwoIG5ld0RlZmVyLnJlamVjdCApCgkJCQkJCQkJCQkJLnByb2dyZXNzKCBuZXdEZWZlci5ub3RpZnkgKTsKCQkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJCW5ld0RlZmVyWyBhY3Rpb24gKyAiV2l0aCIgXSggdGhpcyA9PT0gZGVmZXJyZWQgPyBuZXdEZWZlciA6IHRoaXMsIFsgcmV0dXJuZWQgXSApOwoJCQkJCQkJCQl9CgkJCQkJCQkJfSA6CgkJCQkJCQkJbmV3RGVmZXJbIGFjdGlvbiBdCgkJCQkJCQkpOwoJCQkJCQl9KTsKCQkJCQkJZm5zID0gbnVsbDsKCQkJCQl9KS5wcm9taXNlKCk7CgkJCQl9LAoJCQkJLy8gR2V0IGEgcHJvbWlzZSBmb3IgdGhpcyBkZWZlcnJlZAoJCQkJLy8gSWYgb2JqIGlzIHByb3ZpZGVkLCB0aGUgcHJvbWlzZSBhc3BlY3QgaXMgYWRkZWQgdG8gdGhlIG9iamVjdAoJCQkJcHJvbWlzZTogZnVuY3Rpb24oIG9iaiApIHsKCQkJCQlyZXR1cm4gdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKCBvYmosIHByb21pc2UgKSA6IHByb21pc2U7CgkJCQl9CgkJCX0sCgkJCWRlZmVycmVkID0ge307CgoJCS8vIEtlZXAgcGlwZSBmb3IgYmFjay1jb21wYXQKCQlwcm9taXNlLnBpcGUgPSBwcm9taXNlLnRoZW47CgoJCS8vIEFkZCBsaXN0LXNwZWNpZmljIG1ldGhvZHMKCQlqUXVlcnkuZWFjaCggdHVwbGVzLCBmdW5jdGlvbiggaSwgdHVwbGUgKSB7CgkJCXZhciBsaXN0ID0gdHVwbGVbIDIgXSwKCQkJCXN0YXRlU3RyaW5nID0gdHVwbGVbIDMgXTsKCgkJCS8vIHByb21pc2VbIGRvbmUgfCBmYWlsIHwgcHJvZ3Jlc3MgXSA9IGxpc3QuYWRkCgkJCXByb21pc2VbIHR1cGxlWzFdIF0gPSBsaXN0LmFkZDsKCgkJCS8vIEhhbmRsZSBzdGF0ZQoJCQlpZiAoIHN0YXRlU3RyaW5nICkgewoJCQkJbGlzdC5hZGQoZnVuY3Rpb24oKSB7CgkJCQkJLy8gc3RhdGUgPSBbIHJlc29sdmVkIHwgcmVqZWN0ZWQgXQoJCQkJCXN0YXRlID0gc3RhdGVTdHJpbmc7CgoJCQkJLy8gWyByZWplY3RfbGlzdCB8IHJlc29sdmVfbGlzdCBdLmRpc2FibGU7IHByb2dyZXNzX2xpc3QubG9jawoJCQkJfSwgdHVwbGVzWyBpIF4gMSBdWyAyIF0uZGlzYWJsZSwgdHVwbGVzWyAyIF1bIDIgXS5sb2NrICk7CgkJCX0KCgkJCS8vIGRlZmVycmVkWyByZXNvbHZlIHwgcmVqZWN0IHwgbm90aWZ5IF0gPSBsaXN0LmZpcmUKCQkJZGVmZXJyZWRbIHR1cGxlWzBdIF0gPSBsaXN0LmZpcmU7CgkJCWRlZmVycmVkWyB0dXBsZVswXSArICJXaXRoIiBdID0gbGlzdC5maXJlV2l0aDsKCQl9KTsKCgkJLy8gTWFrZSB0aGUgZGVmZXJyZWQgYSBwcm9taXNlCgkJcHJvbWlzZS5wcm9taXNlKCBkZWZlcnJlZCApOwoKCQkvLyBDYWxsIGdpdmVuIGZ1bmMgaWYgYW55CgkJaWYgKCBmdW5jICkgewoJCQlmdW5jLmNhbGwoIGRlZmVycmVkLCBkZWZlcnJlZCApOwoJCX0KCgkJLy8gQWxsIGRvbmUhCgkJcmV0dXJuIGRlZmVycmVkOwoJfSwKCgkvLyBEZWZlcnJlZCBoZWxwZXIKCXdoZW46IGZ1bmN0aW9uKCBzdWJvcmRpbmF0ZSAvKiAsIC4uLiwgc3Vib3JkaW5hdGVOICovICkgewoJCXZhciBpID0gMCwKCQkJcmVzb2x2ZVZhbHVlcyA9IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICksCgkJCWxlbmd0aCA9IHJlc29sdmVWYWx1ZXMubGVuZ3RoLAoKCQkJLy8gdGhlIGNvdW50IG9mIHVuY29tcGxldGVkIHN1Ym9yZGluYXRlcwoJCQlyZW1haW5pbmcgPSBsZW5ndGggIT09IDEgfHwgKCBzdWJvcmRpbmF0ZSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggc3Vib3JkaW5hdGUucHJvbWlzZSApICkgPyBsZW5ndGggOiAwLAoKCQkJLy8gdGhlIG1hc3RlciBEZWZlcnJlZC4gSWYgcmVzb2x2ZVZhbHVlcyBjb25zaXN0IG9mIG9ubHkgYSBzaW5nbGUgRGVmZXJyZWQsIGp1c3QgdXNlIHRoYXQuCgkJCWRlZmVycmVkID0gcmVtYWluaW5nID09PSAxID8gc3Vib3JkaW5hdGUgOiBqUXVlcnkuRGVmZXJyZWQoKSwKCgkJCS8vIFVwZGF0ZSBmdW5jdGlvbiBmb3IgYm90aCByZXNvbHZlIGFuZCBwcm9ncmVzcyB2YWx1ZXMKCQkJdXBkYXRlRnVuYyA9IGZ1bmN0aW9uKCBpLCBjb250ZXh0cywgdmFsdWVzICkgewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCQljb250ZXh0c1sgaSBdID0gdGhpczsKCQkJCQl2YWx1ZXNbIGkgXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSA6IHZhbHVlOwoJCQkJCWlmKCB2YWx1ZXMgPT09IHByb2dyZXNzVmFsdWVzICkgewoJCQkJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBjb250ZXh0cywgdmFsdWVzICk7CgkJCQkJfSBlbHNlIGlmICggISggLS1yZW1haW5pbmcgKSApIHsKCQkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNvbnRleHRzLCB2YWx1ZXMgKTsKCQkJCQl9CgkJCQl9OwoJCQl9LAoKCQkJcHJvZ3Jlc3NWYWx1ZXMsIHByb2dyZXNzQ29udGV4dHMsIHJlc29sdmVDb250ZXh0czsKCgkJLy8gYWRkIGxpc3RlbmVycyB0byBEZWZlcnJlZCBzdWJvcmRpbmF0ZXM7IHRyZWF0IG90aGVycyBhcyByZXNvbHZlZAoJCWlmICggbGVuZ3RoID4gMSApIHsKCQkJcHJvZ3Jlc3NWYWx1ZXMgPSBuZXcgQXJyYXkoIGxlbmd0aCApOwoJCQlwcm9ncmVzc0NvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJcmVzb2x2ZUNvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIHJlc29sdmVWYWx1ZXNbIGkgXSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggcmVzb2x2ZVZhbHVlc1sgaSBdLnByb21pc2UgKSApIHsKCQkJCQlyZXNvbHZlVmFsdWVzWyBpIF0ucHJvbWlzZSgpCgkJCQkJCS5kb25lKCB1cGRhdGVGdW5jKCBpLCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKSApCgkJCQkJCS5mYWlsKCBkZWZlcnJlZC5yZWplY3QgKQoJCQkJCQkucHJvZ3Jlc3MoIHVwZGF0ZUZ1bmMoIGksIHByb2dyZXNzQ29udGV4dHMsIHByb2dyZXNzVmFsdWVzICkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLS1yZW1haW5pbmc7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIGlmIHdlJ3JlIG5vdCB3YWl0aW5nIG9uIGFueXRoaW5nLCByZXNvbHZlIHRoZSBtYXN0ZXIKCQlpZiAoICFyZW1haW5pbmcgKSB7CgkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Cn0pOwpqUXVlcnkuc3VwcG9ydCA9IChmdW5jdGlvbigpIHsKCgl2YXIgc3VwcG9ydCwKCQlhbGwsCgkJYSwKCQlzZWxlY3QsCgkJb3B0LAoJCWlucHV0LAoJCWZyYWdtZW50LAoJCWV2ZW50TmFtZSwKCQlpLAoJCWlzU3VwcG9ydGVkLAoJCWNsaWNrRm4sCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgoJLy8gUHJlbGltaW5hcnkgdGVzdHMKCWRpdi5zZXRBdHRyaWJ1dGUoICJjbGFzc05hbWUiLCAidCIgKTsKCWRpdi5pbm5lckhUTUwgPSAiICA8bGluay8+PHRhYmxlPjwvdGFibGU+PGEgaHJlZj0nL2EnPmE8L2E+PGlucHV0IHR5cGU9J2NoZWNrYm94Jy8+IjsKCglhbGwgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKTsKCWEgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImEiKVsgMCBdOwoJYS5zdHlsZS5jc3NUZXh0ID0gInRvcDoxcHg7ZmxvYXQ6bGVmdDtvcGFjaXR5Oi41IjsKCgkvLyBDYW4ndCBnZXQgYmFzaWMgdGVzdCBzdXBwb3J0CglpZiAoICFhbGwgfHwgIWFsbC5sZW5ndGggfHwgIWEgKSB7CgkJcmV0dXJuIHt9OwoJfQoKCS8vIEZpcnN0IGJhdGNoIG9mIHN1cHBvcnRzIHRlc3RzCglzZWxlY3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzZWxlY3QiKTsKCW9wdCA9IHNlbGVjdC5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIikgKTsKCWlucHV0ID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpWyAwIF07CgoJc3VwcG9ydCA9IHsKCQkvLyBJRSBzdHJpcHMgbGVhZGluZyB3aGl0ZXNwYWNlIHdoZW4gLmlubmVySFRNTCBpcyB1c2VkCgkJbGVhZGluZ1doaXRlc3BhY2U6ICggZGl2LmZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IDMgKSwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGJvZHkgZWxlbWVudHMgYXJlbid0IGF1dG9tYXRpY2FsbHkgaW5zZXJ0ZWQKCQkvLyBJRSB3aWxsIGluc2VydCB0aGVtIGludG8gZW1wdHkgdGFibGVzCgkJdGJvZHk6ICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRib2R5IikubGVuZ3RoLAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBsaW5rIGVsZW1lbnRzIGdldCBzZXJpYWxpemVkIGNvcnJlY3RseSBieSBpbm5lckhUTUwKCQkvLyBUaGlzIHJlcXVpcmVzIGEgd3JhcHBlciBlbGVtZW50IGluIElFCgkJaHRtbFNlcmlhbGl6ZTogISFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpbmsiKS5sZW5ndGgsCgoJCS8vIEdldCB0aGUgc3R5bGUgaW5mb3JtYXRpb24gZnJvbSBnZXRBdHRyaWJ1dGUKCQkvLyAoSUUgdXNlcyAuY3NzVGV4dCBpbnN0ZWFkKQoJCXN0eWxlOiAvdG9wLy50ZXN0KCBhLmdldEF0dHJpYnV0ZSgic3R5bGUiKSApLAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBVUkxzIGFyZW4ndCBtYW5pcHVsYXRlZAoJCS8vIChJRSBub3JtYWxpemVzIGl0IGJ5IGRlZmF1bHQpCgkJaHJlZk5vcm1hbGl6ZWQ6ICggYS5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIi9hIiApLAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBlbGVtZW50IG9wYWNpdHkgZXhpc3RzCgkJLy8gKElFIHVzZXMgZmlsdGVyIGluc3RlYWQpCgkJLy8gVXNlIGEgcmVnZXggdG8gd29yayBhcm91bmQgYSBXZWJLaXQgaXNzdWUuIFNlZSAjNTE0NQoJCW9wYWNpdHk6IC9eMC41Ly50ZXN0KCBhLnN0eWxlLm9wYWNpdHkgKSwKCgkJLy8gVmVyaWZ5IHN0eWxlIGZsb2F0IGV4aXN0ZW5jZQoJCS8vIChJRSB1c2VzIHN0eWxlRmxvYXQgaW5zdGVhZCBvZiBjc3NGbG9hdCkKCQljc3NGbG9hdDogISFhLnN0eWxlLmNzc0Zsb2F0LAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBpZiBubyB2YWx1ZSBpcyBzcGVjaWZpZWQgZm9yIGEgY2hlY2tib3gKCQkvLyB0aGF0IGl0IGRlZmF1bHRzIHRvICJvbiIuCgkJLy8gKFdlYktpdCBkZWZhdWx0cyB0byAiIiBpbnN0ZWFkKQoJCWNoZWNrT246ICggaW5wdXQudmFsdWUgPT09ICJvbiIgKSwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgYSBzZWxlY3RlZC1ieS1kZWZhdWx0IG9wdGlvbiBoYXMgYSB3b3JraW5nIHNlbGVjdGVkIHByb3BlcnR5LgoJCS8vIChXZWJLaXQgZGVmYXVsdHMgdG8gZmFsc2UgaW5zdGVhZCBvZiB0cnVlLCBJRSB0b28sIGlmIGl0J3MgaW4gYW4gb3B0Z3JvdXApCgkJb3B0U2VsZWN0ZWQ6IG9wdC5zZWxlY3RlZCwKCgkJLy8gVGVzdCBzZXRBdHRyaWJ1dGUgb24gY2FtZWxDYXNlIGNsYXNzLiBJZiBpdCB3b3Jrcywgd2UgbmVlZCBhdHRyRml4ZXMgd2hlbiBkb2luZyBnZXQvc2V0QXR0cmlidXRlIChpZTYvNykKCQlnZXRTZXRBdHRyaWJ1dGU6IGRpdi5jbGFzc05hbWUgIT09ICJ0IiwKCgkJLy8gVGVzdHMgZm9yIGVuY3R5cGUgc3VwcG9ydCBvbiBhIGZvcm0oIzY3NDMpCgkJZW5jdHlwZTogISFkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIikuZW5jdHlwZSwKCgkJLy8gTWFrZXMgc3VyZSBjbG9uaW5nIGFuIGh0bWw1IGVsZW1lbnQgZG9lcyBub3QgY2F1c2UgcHJvYmxlbXMKCQkvLyBXaGVyZSBvdXRlckhUTUwgaXMgdW5kZWZpbmVkLCB0aGlzIHN0aWxsIHdvcmtzCgkJaHRtbDVDbG9uZTogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibmF2IikuY2xvbmVOb2RlKCB0cnVlICkub3V0ZXJIVE1MICE9PSAiPDpuYXY+PC86bmF2PiIsCgoJCS8vIGpRdWVyeS5zdXBwb3J0LmJveE1vZGVsIERFUFJFQ0FURUQgaW4gMS44IHNpbmNlIHdlIGRvbid0IHN1cHBvcnQgUXVpcmtzIE1vZGUKCQlib3hNb2RlbDogKCBkb2N1bWVudC5jb21wYXRNb2RlID09PSAiQ1NTMUNvbXBhdCIgKSwKCgkJLy8gV2lsbCBiZSBkZWZpbmVkIGxhdGVyCgkJc3VibWl0QnViYmxlczogdHJ1ZSwKCQljaGFuZ2VCdWJibGVzOiB0cnVlLAoJCWZvY3VzaW5CdWJibGVzOiBmYWxzZSwKCQlkZWxldGVFeHBhbmRvOiB0cnVlLAoJCW5vQ2xvbmVFdmVudDogdHJ1ZSwKCQlpbmxpbmVCbG9ja05lZWRzTGF5b3V0OiBmYWxzZSwKCQlzaHJpbmtXcmFwQmxvY2tzOiBmYWxzZSwKCQlyZWxpYWJsZU1hcmdpblJpZ2h0OiB0cnVlLAoJCWJveFNpemluZ1JlbGlhYmxlOiB0cnVlLAoJCXBpeGVsUG9zaXRpb246IGZhbHNlCgl9OwoKCS8vIE1ha2Ugc3VyZSBjaGVja2VkIHN0YXR1cyBpcyBwcm9wZXJseSBjbG9uZWQKCWlucHV0LmNoZWNrZWQgPSB0cnVlOwoJc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCA9IGlucHV0LmNsb25lTm9kZSggdHJ1ZSApLmNoZWNrZWQ7CgoJLy8gTWFrZSBzdXJlIHRoYXQgdGhlIG9wdGlvbnMgaW5zaWRlIGRpc2FibGVkIHNlbGVjdHMgYXJlbid0IG1hcmtlZCBhcyBkaXNhYmxlZAoJLy8gKFdlYktpdCBtYXJrcyB0aGVtIGFzIGRpc2FibGVkKQoJc2VsZWN0LmRpc2FibGVkID0gdHJ1ZTsKCXN1cHBvcnQub3B0RGlzYWJsZWQgPSAhb3B0LmRpc2FibGVkOwoKCS8vIFRlc3QgdG8gc2VlIGlmIGl0J3MgcG9zc2libGUgdG8gZGVsZXRlIGFuIGV4cGFuZG8gZnJvbSBhbiBlbGVtZW50CgkvLyBGYWlscyBpbiBJbnRlcm5ldCBFeHBsb3JlcgoJdHJ5IHsKCQlkZWxldGUgZGl2LnRlc3Q7Cgl9IGNhdGNoKCBlICkgewoJCXN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9IGZhbHNlOwoJfQoKCWlmICggIWRpdi5hZGRFdmVudExpc3RlbmVyICYmIGRpdi5hdHRhY2hFdmVudCAmJiBkaXYuZmlyZUV2ZW50ICkgewoJCWRpdi5hdHRhY2hFdmVudCggIm9uY2xpY2siLCBjbGlja0ZuID0gZnVuY3Rpb24oKSB7CgkJCS8vIENsb25pbmcgYSBub2RlIHNob3VsZG4ndCBjb3B5IG92ZXIgYW55CgkJCS8vIGJvdW5kIGV2ZW50IGhhbmRsZXJzIChJRSBkb2VzIHRoaXMpCgkJCXN1cHBvcnQubm9DbG9uZUV2ZW50ID0gZmFsc2U7CgkJfSk7CgkJZGl2LmNsb25lTm9kZSggdHJ1ZSApLmZpcmVFdmVudCgib25jbGljayIpOwoJCWRpdi5kZXRhY2hFdmVudCggIm9uY2xpY2siLCBjbGlja0ZuICk7Cgl9CgoJLy8gQ2hlY2sgaWYgYSByYWRpbyBtYWludGFpbnMgaXRzIHZhbHVlCgkvLyBhZnRlciBiZWluZyBhcHBlbmRlZCB0byB0aGUgRE9NCglpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CglpbnB1dC52YWx1ZSA9ICJ0IjsKCWlucHV0LnNldEF0dHJpYnV0ZSggInR5cGUiLCAicmFkaW8iICk7CglzdXBwb3J0LnJhZGlvVmFsdWUgPSBpbnB1dC52YWx1ZSA9PT0gInQiOwoKCWlucHV0LnNldEF0dHJpYnV0ZSggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCgkvLyAjMTEyMTcgLSBXZWJLaXQgbG9zZXMgY2hlY2sgd2hlbiB0aGUgbmFtZSBpcyBhZnRlciB0aGUgY2hlY2tlZCBhdHRyaWJ1dGUKCWlucHV0LnNldEF0dHJpYnV0ZSggIm5hbWUiLCAidCIgKTsKCglkaXYuYXBwZW5kQ2hpbGQoIGlucHV0ICk7CglmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCWZyYWdtZW50LmFwcGVuZENoaWxkKCBkaXYubGFzdENoaWxkICk7CgoJLy8gV2ViS2l0IGRvZXNuJ3QgY2xvbmUgY2hlY2tlZCBzdGF0ZSBjb3JyZWN0bHkgaW4gZnJhZ21lbnRzCglzdXBwb3J0LmNoZWNrQ2xvbmUgPSBmcmFnbWVudC5jbG9uZU5vZGUoIHRydWUgKS5jbG9uZU5vZGUoIHRydWUgKS5sYXN0Q2hpbGQuY2hlY2tlZDsKCgkvLyBDaGVjayBpZiBhIGRpc2Nvbm5lY3RlZCBjaGVja2JveCB3aWxsIHJldGFpbiBpdHMgY2hlY2tlZAoJLy8gdmFsdWUgb2YgdHJ1ZSBhZnRlciBhcHBlbmRlZCB0byB0aGUgRE9NIChJRTYvNykKCXN1cHBvcnQuYXBwZW5kQ2hlY2tlZCA9IGlucHV0LmNoZWNrZWQ7CgoJZnJhZ21lbnQucmVtb3ZlQ2hpbGQoIGlucHV0ICk7CglmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2ICk7CgoJLy8gVGVjaG5pcXVlIGZyb20gSnVyaXkgWmF5dHNldgoJLy8gaHR0cDovL3BlcmZlY3Rpb25raWxscy5jb20vZGV0ZWN0aW5nLWV2ZW50LXN1cHBvcnQtd2l0aG91dC1icm93c2VyLXNuaWZmaW5nLwoJLy8gV2Ugb25seSBjYXJlIGFib3V0IHRoZSBjYXNlIHdoZXJlIG5vbi1zdGFuZGFyZCBldmVudCBzeXN0ZW1zCgkvLyBhcmUgdXNlZCwgbmFtZWx5IGluIElFLiBTaG9ydC1jaXJjdWl0aW5nIGhlcmUgaGVscHMgdXMgdG8KCS8vIGF2b2lkIGFuIGV2YWwgY2FsbCAoaW4gc2V0QXR0cmlidXRlKSB3aGljaCBjYW4gY2F1c2UgQ1NQCgkvLyB0byBnbyBoYXl3aXJlLiBTZWU6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUAoJaWYgKCBkaXYuYXR0YWNoRXZlbnQgKSB7CgkJZm9yICggaSBpbiB7CgkJCXN1Ym1pdDogdHJ1ZSwKCQkJY2hhbmdlOiB0cnVlLAoJCQlmb2N1c2luOiB0cnVlCgkJfSkgewoJCQlldmVudE5hbWUgPSAib24iICsgaTsKCQkJaXNTdXBwb3J0ZWQgPSAoIGV2ZW50TmFtZSBpbiBkaXYgKTsKCQkJaWYgKCAhaXNTdXBwb3J0ZWQgKSB7CgkJCQlkaXYuc2V0QXR0cmlidXRlKCBldmVudE5hbWUsICJyZXR1cm47IiApOwoJCQkJaXNTdXBwb3J0ZWQgPSAoIHR5cGVvZiBkaXZbIGV2ZW50TmFtZSBdID09PSAiZnVuY3Rpb24iICk7CgkJCX0KCQkJc3VwcG9ydFsgaSArICJCdWJibGVzIiBdID0gaXNTdXBwb3J0ZWQ7CgkJfQoJfQoKCS8vIFJ1biB0ZXN0cyB0aGF0IG5lZWQgYSBib2R5IGF0IGRvYyByZWFkeQoJalF1ZXJ5KGZ1bmN0aW9uKCkgewoJCXZhciBjb250YWluZXIsIGRpdiwgdGRzLCBtYXJnaW5EaXYsCgkJCWRpdlJlc2V0ID0gInBhZGRpbmc6MDttYXJnaW46MDtib3JkZXI6MDtkaXNwbGF5OmJsb2NrO292ZXJmbG93OmhpZGRlbjsiLAoJCQlib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXTsKCgkJaWYgKCAhYm9keSApIHsKCQkJLy8gUmV0dXJuIGZvciBmcmFtZXNldCBkb2NzIHRoYXQgZG9uJ3QgaGF2ZSBhIGJvZHkKCQkJcmV0dXJuOwoJCX0KCgkJY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgkJY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAidmlzaWJpbGl0eTpoaWRkZW47Ym9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDtwb3NpdGlvbjpzdGF0aWM7dG9wOjA7bWFyZ2luLXRvcDoxcHgiOwoJCWJvZHkuaW5zZXJ0QmVmb3JlKCBjb250YWluZXIsIGJvZHkuZmlyc3RDaGlsZCApOwoKCQkvLyBDb25zdHJ1Y3QgdGhlIHRlc3QgZWxlbWVudAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCWNvbnRhaW5lci5hcHBlbmRDaGlsZCggZGl2ICk7CgoJCS8vIENoZWNrIGlmIHRhYmxlIGNlbGxzIHN0aWxsIGhhdmUgb2Zmc2V0V2lkdGgvSGVpZ2h0IHdoZW4gdGhleSBhcmUgc2V0CgkJLy8gdG8gZGlzcGxheTpub25lIGFuZCB0aGVyZSBhcmUgc3RpbGwgb3RoZXIgdmlzaWJsZSB0YWJsZSBjZWxscyBpbiBhCgkJLy8gdGFibGUgcm93OyBpZiBzbywgb2Zmc2V0V2lkdGgvSGVpZ2h0IGFyZSBub3QgcmVsaWFibGUgZm9yIHVzZSB3aGVuCgkJLy8gZGV0ZXJtaW5pbmcgaWYgYW4gZWxlbWVudCBoYXMgYmVlbiBoaWRkZW4gZGlyZWN0bHkgdXNpbmcKCQkvLyBkaXNwbGF5Om5vbmUgKGl0IGlzIHN0aWxsIHNhZmUgdG8gdXNlIG9mZnNldHMgaWYgYSBwYXJlbnQgZWxlbWVudCBpcwoJCS8vIGhpZGRlbjsgZG9uIHNhZmV0eSBnb2dnbGVzIGFuZCBzZWUgYnVnICM0NTEyIGZvciBtb3JlIGluZm9ybWF0aW9uKS4KCQkvLyAob25seSBJRSA4IGZhaWxzIHRoaXMgdGVzdCkKCQlkaXYuaW5uZXJIVE1MID0gIjx0YWJsZT48dHI+PHRkPjwvdGQ+PHRkPnQ8L3RkPjwvdHI+PC90YWJsZT4iOwoJCXRkcyA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGQiKTsKCQl0ZHNbIDAgXS5zdHlsZS5jc3NUZXh0ID0gInBhZGRpbmc6MDttYXJnaW46MDtib3JkZXI6MDtkaXNwbGF5Om5vbmUiOwoJCWlzU3VwcG9ydGVkID0gKCB0ZHNbIDAgXS5vZmZzZXRIZWlnaHQgPT09IDAgKTsKCgkJdGRzWyAwIF0uc3R5bGUuZGlzcGxheSA9ICIiOwoJCXRkc1sgMSBdLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgoJCS8vIENoZWNrIGlmIGVtcHR5IHRhYmxlIGNlbGxzIHN0aWxsIGhhdmUgb2Zmc2V0V2lkdGgvSGVpZ2h0CgkJLy8gKElFIDw9IDggZmFpbCB0aGlzIHRlc3QpCgkJc3VwcG9ydC5yZWxpYWJsZUhpZGRlbk9mZnNldHMgPSBpc1N1cHBvcnRlZCAmJiAoIHRkc1sgMCBdLm9mZnNldEhlaWdodCA9PT0gMCApOwoKCQkvLyBDaGVjayBib3gtc2l6aW5nIGFuZCBtYXJnaW4gYmVoYXZpb3IKCQlkaXYuaW5uZXJIVE1MID0gIiI7CgkJZGl2LnN0eWxlLmNzc1RleHQgPSAiYm94LXNpemluZzpib3JkZXItYm94Oy1tb3otYm94LXNpemluZzpib3JkZXItYm94Oy13ZWJraXQtYm94LXNpemluZzpib3JkZXItYm94O3BhZGRpbmc6MXB4O2JvcmRlcjoxcHg7ZGlzcGxheTpibG9jazt3aWR0aDo0cHg7bWFyZ2luLXRvcDoxJTtwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MSU7IjsKCQlzdXBwb3J0LmJveFNpemluZyA9ICggZGl2Lm9mZnNldFdpZHRoID09PSA0ICk7CgkJc3VwcG9ydC5kb2VzTm90SW5jbHVkZU1hcmdpbkluQm9keU9mZnNldCA9ICggYm9keS5vZmZzZXRUb3AgIT09IDEgKTsKCgkJLy8gTk9URTogVG8gYW55IGZ1dHVyZSBtYWludGFpbmVyLCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSB3YXMgdXNlZCBoZXJlCgkJLy8gaW5zdGVhZCBvZiBnZXRDb21wdXRlZFN0eWxlIGJlY2F1c2UgaXQgZ2F2ZSBhIGJldHRlciBnemlwIHNpemUuCgkJLy8gVGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSBhbmQgZ2V0Q29tcHV0ZWRTdHlsZSBpcwoJCS8vIDcgYnl0ZXMKCQlpZiAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlICkgewoJCQlzdXBwb3J0LnBpeGVsUG9zaXRpb24gPSAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBkaXYsIG51bGwgKSB8fCB7fSApLnRvcCAhPT0gIjElIjsKCQkJc3VwcG9ydC5ib3hTaXppbmdSZWxpYWJsZSA9ICggd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGRpdiwgbnVsbCApIHx8IHsgd2lkdGg6ICI0cHgiIH0gKS53aWR0aCA9PT0gIjRweCI7CgoJCQkvLyBDaGVjayBpZiBkaXYgd2l0aCBleHBsaWNpdCB3aWR0aCBhbmQgbm8gbWFyZ2luLXJpZ2h0IGluY29ycmVjdGx5CgkJCS8vIGdldHMgY29tcHV0ZWQgbWFyZ2luLXJpZ2h0IGJhc2VkIG9uIHdpZHRoIG9mIGNvbnRhaW5lci4gRm9yIG1vcmUKCQkJLy8gaW5mbyBzZWUgYnVnICMzMzMzCgkJCS8vIEZhaWxzIGluIFdlYktpdCBiZWZvcmUgRmViIDIwMTEgbmlnaHRsaWVzCgkJCS8vIFdlYktpdCBCdWcgMTMzNDMgLSBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgd3JvbmcgdmFsdWUgZm9yIG1hcmdpbi1yaWdodAoJCQltYXJnaW5EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCQkJbWFyZ2luRGl2LnN0eWxlLmNzc1RleHQgPSBkaXYuc3R5bGUuY3NzVGV4dCA9IGRpdlJlc2V0OwoJCQltYXJnaW5EaXYuc3R5bGUubWFyZ2luUmlnaHQgPSBtYXJnaW5EaXYuc3R5bGUud2lkdGggPSAiMCI7CgkJCWRpdi5zdHlsZS53aWR0aCA9ICIxcHgiOwoJCQlkaXYuYXBwZW5kQ2hpbGQoIG1hcmdpbkRpdiApOwoJCQlzdXBwb3J0LnJlbGlhYmxlTWFyZ2luUmlnaHQgPQoJCQkJIXBhcnNlRmxvYXQoICggd2luZG93LmdldENvbXB1dGVkU3R5bGUoIG1hcmdpbkRpdiwgbnVsbCApIHx8IHt9ICkubWFyZ2luUmlnaHQgKTsKCQl9CgoJCWlmICggdHlwZW9mIGRpdi5zdHlsZS56b29tICE9PSAidW5kZWZpbmVkIiApIHsKCQkJLy8gQ2hlY2sgaWYgbmF0aXZlbHkgYmxvY2stbGV2ZWwgZWxlbWVudHMgYWN0IGxpa2UgaW5saW5lLWJsb2NrCgkJCS8vIGVsZW1lbnRzIHdoZW4gc2V0dGluZyB0aGVpciBkaXNwbGF5IHRvICdpbmxpbmUnIGFuZCBnaXZpbmcKCQkJLy8gdGhlbSBsYXlvdXQKCQkJLy8gKElFIDwgOCBkb2VzIHRoaXMpCgkJCWRpdi5pbm5lckhUTUwgPSAiIjsKCQkJZGl2LnN0eWxlLmNzc1RleHQgPSBkaXZSZXNldCArICJ3aWR0aDoxcHg7cGFkZGluZzoxcHg7ZGlzcGxheTppbmxpbmU7em9vbToxIjsKCQkJc3VwcG9ydC5pbmxpbmVCbG9ja05lZWRzTGF5b3V0ID0gKCBkaXYub2Zmc2V0V2lkdGggPT09IDMgKTsKCgkJCS8vIENoZWNrIGlmIGVsZW1lbnRzIHdpdGggbGF5b3V0IHNocmluay13cmFwIHRoZWlyIGNoaWxkcmVuCgkJCS8vIChJRSA2IGRvZXMgdGhpcykKCQkJZGl2LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwoJCQlkaXYuc3R5bGUub3ZlcmZsb3cgPSAidmlzaWJsZSI7CgkJCWRpdi5pbm5lckhUTUwgPSAiPGRpdj48L2Rpdj4iOwoJCQlkaXYuZmlyc3RDaGlsZC5zdHlsZS53aWR0aCA9ICI1cHgiOwoJCQlzdXBwb3J0LnNocmlua1dyYXBCbG9ja3MgPSAoIGRpdi5vZmZzZXRXaWR0aCAhPT0gMyApOwoKCQkJY29udGFpbmVyLnN0eWxlLnpvb20gPSAxOwoJCX0KCgkJLy8gTnVsbCBlbGVtZW50cyB0byBhdm9pZCBsZWFrcyBpbiBJRQoJCWJvZHkucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoJCWNvbnRhaW5lciA9IGRpdiA9IHRkcyA9IG1hcmdpbkRpdiA9IG51bGw7Cgl9KTsKCgkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFCglmcmFnbWVudC5yZW1vdmVDaGlsZCggZGl2ICk7CglhbGwgPSBhID0gc2VsZWN0ID0gb3B0ID0gaW5wdXQgPSBmcmFnbWVudCA9IGRpdiA9IG51bGw7CgoJcmV0dXJuIHN1cHBvcnQ7Cn0pKCk7CnZhciByYnJhY2UgPSAvXig/Olx7LipcfXxcWy4qXF0pJC8sCglybXVsdGlEYXNoID0gLyhbQS1aXSkvZzsKCmpRdWVyeS5leHRlbmQoewoJY2FjaGU6IHt9LAoKCWRlbGV0ZWRJZHM6IFtdLAoKCS8vIFBsZWFzZSB1c2Ugd2l0aCBjYXV0aW9uCgl1dWlkOiAwLAoKCS8vIFVuaXF1ZSBmb3IgZWFjaCBjb3B5IG9mIGpRdWVyeSBvbiB0aGUgcGFnZQoJLy8gTm9uLWRpZ2l0cyByZW1vdmVkIHRvIG1hdGNoIHJpbmxpbmVqUXVlcnkKCWV4cGFuZG86ICJqUXVlcnkiICsgKCBqUXVlcnkuZm4uanF1ZXJ5ICsgTWF0aC5yYW5kb20oKSApLnJlcGxhY2UoIC9cRC9nLCAiIiApLAoKCS8vIFRoZSBmb2xsb3dpbmcgZWxlbWVudHMgdGhyb3cgdW5jYXRjaGFibGUgZXhjZXB0aW9ucyBpZiB5b3UKCS8vIGF0dGVtcHQgdG8gYWRkIGV4cGFuZG8gcHJvcGVydGllcyB0byB0aGVtLgoJbm9EYXRhOiB7CgkJImVtYmVkIjogdHJ1ZSwKCQkvLyBCYW4gYWxsIG9iamVjdHMgZXhjZXB0IGZvciBGbGFzaCAod2hpY2ggaGFuZGxlIGV4cGFuZG9zKQoJCSJvYmplY3QiOiAiY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwIiwKCQkiYXBwbGV0IjogdHJ1ZQoJfSwKCgloYXNEYXRhOiBmdW5jdGlvbiggZWxlbSApIHsKCQllbGVtID0gZWxlbS5ub2RlVHlwZSA/IGpRdWVyeS5jYWNoZVsgZWxlbVtqUXVlcnkuZXhwYW5kb10gXSA6IGVsZW1bIGpRdWVyeS5leHBhbmRvIF07CgkJcmV0dXJuICEhZWxlbSAmJiAhaXNFbXB0eURhdGFPYmplY3QoIGVsZW0gKTsKCX0sCgoJZGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGRhdGEsIHB2dCAvKiBJbnRlcm5hbCBVc2UgT25seSAqLyApIHsKCQlpZiAoICFqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgdGhpc0NhY2hlLCByZXQsCgkJCWludGVybmFsS2V5ID0galF1ZXJ5LmV4cGFuZG8sCgkJCWdldEJ5TmFtZSA9IHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiwKCgkJCS8vIFdlIGhhdmUgdG8gaGFuZGxlIERPTSBub2RlcyBhbmQgSlMgb2JqZWN0cyBkaWZmZXJlbnRseSBiZWNhdXNlIElFNi03CgkJCS8vIGNhbid0IEdDIG9iamVjdCByZWZlcmVuY2VzIHByb3Blcmx5IGFjcm9zcyB0aGUgRE9NLUpTIGJvdW5kYXJ5CgkJCWlzTm9kZSA9IGVsZW0ubm9kZVR5cGUsCgoJCQkvLyBPbmx5IERPTSBub2RlcyBuZWVkIHRoZSBnbG9iYWwgalF1ZXJ5IGNhY2hlOyBKUyBvYmplY3QgZGF0YSBpcwoJCQkvLyBhdHRhY2hlZCBkaXJlY3RseSB0byB0aGUgb2JqZWN0IHNvIEdDIGNhbiBvY2N1ciBhdXRvbWF0aWNhbGx5CgkJCWNhY2hlID0gaXNOb2RlID8galF1ZXJ5LmNhY2hlIDogZWxlbSwKCgkJCS8vIE9ubHkgZGVmaW5pbmcgYW4gSUQgZm9yIEpTIG9iamVjdHMgaWYgaXRzIGNhY2hlIGFscmVhZHkgZXhpc3RzIGFsbG93cwoJCQkvLyB0aGUgY29kZSB0byBzaG9ydGN1dCBvbiB0aGUgc2FtZSBwYXRoIGFzIGEgRE9NIG5vZGUgd2l0aCBubyBjYWNoZQoJCQlpZCA9IGlzTm9kZSA/IGVsZW1bIGludGVybmFsS2V5IF0gOiBlbGVtWyBpbnRlcm5hbEtleSBdICYmIGludGVybmFsS2V5OwoKCQkvLyBBdm9pZCBkb2luZyBhbnkgbW9yZSB3b3JrIHRoYW4gd2UgbmVlZCB0byB3aGVuIHRyeWluZyB0byBnZXQgZGF0YSBvbiBhbgoJCS8vIG9iamVjdCB0aGF0IGhhcyBubyBkYXRhIGF0IGFsbAoJCWlmICggKCFpZCB8fCAhY2FjaGVbaWRdIHx8ICghcHZ0ICYmICFjYWNoZVtpZF0uZGF0YSkpICYmIGdldEJ5TmFtZSAmJiBkYXRhID09PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIWlkICkgewoJCQkvLyBPbmx5IERPTSBub2RlcyBuZWVkIGEgbmV3IHVuaXF1ZSBJRCBmb3IgZWFjaCBlbGVtZW50IHNpbmNlIHRoZWlyIGRhdGEKCQkJLy8gZW5kcyB1cCBpbiB0aGUgZ2xvYmFsIGNhY2hlCgkJCWlmICggaXNOb2RlICkgewoJCQkJZWxlbVsgaW50ZXJuYWxLZXkgXSA9IGlkID0galF1ZXJ5LmRlbGV0ZWRJZHMucG9wKCkgfHwgKytqUXVlcnkudXVpZDsKCQkJfSBlbHNlIHsKCQkJCWlkID0gaW50ZXJuYWxLZXk7CgkJCX0KCQl9CgoJCWlmICggIWNhY2hlWyBpZCBdICkgewoJCQljYWNoZVsgaWQgXSA9IHt9OwoKCQkJLy8gQXZvaWRzIGV4cG9zaW5nIGpRdWVyeSBtZXRhZGF0YSBvbiBwbGFpbiBKUyBvYmplY3RzIHdoZW4gdGhlIG9iamVjdAoJCQkvLyBpcyBzZXJpYWxpemVkIHVzaW5nIEpTT04uc3RyaW5naWZ5CgkJCWlmICggIWlzTm9kZSApIHsKCQkJCWNhY2hlWyBpZCBdLnRvSlNPTiA9IGpRdWVyeS5ub29wOwoJCQl9CgkJfQoKCQkvLyBBbiBvYmplY3QgY2FuIGJlIHBhc3NlZCB0byBqUXVlcnkuZGF0YSBpbnN0ZWFkIG9mIGEga2V5L3ZhbHVlIHBhaXI7IHRoaXMgZ2V0cwoJCS8vIHNoYWxsb3cgY29waWVkIG92ZXIgb250byB0aGUgZXhpc3RpbmcgY2FjaGUKCQlpZiAoIHR5cGVvZiBuYW1lID09PSAib2JqZWN0IiB8fCB0eXBlb2YgbmFtZSA9PT0gImZ1bmN0aW9uIiApIHsKCQkJaWYgKCBwdnQgKSB7CgkJCQljYWNoZVsgaWQgXSA9IGpRdWVyeS5leHRlbmQoIGNhY2hlWyBpZCBdLCBuYW1lICk7CgkJCX0gZWxzZSB7CgkJCQljYWNoZVsgaWQgXS5kYXRhID0galF1ZXJ5LmV4dGVuZCggY2FjaGVbIGlkIF0uZGF0YSwgbmFtZSApOwoJCQl9CgkJfQoKCQl0aGlzQ2FjaGUgPSBjYWNoZVsgaWQgXTsKCgkJLy8galF1ZXJ5IGRhdGEoKSBpcyBzdG9yZWQgaW4gYSBzZXBhcmF0ZSBvYmplY3QgaW5zaWRlIHRoZSBvYmplY3QncyBpbnRlcm5hbCBkYXRhCgkJLy8gY2FjaGUgaW4gb3JkZXIgdG8gYXZvaWQga2V5IGNvbGxpc2lvbnMgYmV0d2VlbiBpbnRlcm5hbCBkYXRhIGFuZCB1c2VyLWRlZmluZWQKCQkvLyBkYXRhLgoJCWlmICggIXB2dCApIHsKCQkJaWYgKCAhdGhpc0NhY2hlLmRhdGEgKSB7CgkJCQl0aGlzQ2FjaGUuZGF0YSA9IHt9OwoJCQl9CgoJCQl0aGlzQ2FjaGUgPSB0aGlzQ2FjaGUuZGF0YTsKCQl9CgoJCWlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzQ2FjaGVbIGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKSBdID0gZGF0YTsKCQl9CgoJCS8vIENoZWNrIGZvciBib3RoIGNvbnZlcnRlZC10by1jYW1lbCBhbmQgbm9uLWNvbnZlcnRlZCBkYXRhIHByb3BlcnR5IG5hbWVzCgkJLy8gSWYgYSBkYXRhIHByb3BlcnR5IHdhcyBzcGVjaWZpZWQKCQlpZiAoIGdldEJ5TmFtZSApIHsKCgkJCS8vIEZpcnN0IFRyeSB0byBmaW5kIGFzLWlzIHByb3BlcnR5IGRhdGEKCQkJcmV0ID0gdGhpc0NhY2hlWyBuYW1lIF07CgoJCQkvLyBUZXN0IGZvciBudWxsfHVuZGVmaW5lZCBwcm9wZXJ0eSBkYXRhCgkJCWlmICggcmV0ID09IG51bGwgKSB7CgoJCQkJLy8gVHJ5IHRvIGZpbmQgdGhlIGNhbWVsQ2FzZWQgcHJvcGVydHkKCQkJCXJldCA9IHRoaXNDYWNoZVsgalF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApIF07CgkJCX0KCQl9IGVsc2UgewoJCQlyZXQgPSB0aGlzQ2FjaGU7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglyZW1vdmVEYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgcHZ0IC8qIEludGVybmFsIFVzZSBPbmx5ICovICkgewoJCWlmICggIWpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciB0aGlzQ2FjaGUsIGksIGwsCgoJCQlpc05vZGUgPSBlbGVtLm5vZGVUeXBlLAoKCQkJLy8gU2VlIGpRdWVyeS5kYXRhIGZvciBtb3JlIGluZm9ybWF0aW9uCgkJCWNhY2hlID0gaXNOb2RlID8galF1ZXJ5LmNhY2hlIDogZWxlbSwKCQkJaWQgPSBpc05vZGUgPyBlbGVtWyBqUXVlcnkuZXhwYW5kbyBdIDogalF1ZXJ5LmV4cGFuZG87CgoJCS8vIElmIHRoZXJlIGlzIGFscmVhZHkgbm8gY2FjaGUgZW50cnkgZm9yIHRoaXMgb2JqZWN0LCB0aGVyZSBpcyBubwoJCS8vIHB1cnBvc2UgaW4gY29udGludWluZwoJCWlmICggIWNhY2hlWyBpZCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIG5hbWUgKSB7CgoJCQl0aGlzQ2FjaGUgPSBwdnQgPyBjYWNoZVsgaWQgXSA6IGNhY2hlWyBpZCBdLmRhdGE7CgoJCQlpZiAoIHRoaXNDYWNoZSApIHsKCgkJCQkvLyBTdXBwb3J0IGFycmF5IG9yIHNwYWNlIHNlcGFyYXRlZCBzdHJpbmcgbmFtZXMgZm9yIGRhdGEga2V5cwoJCQkJaWYgKCAhalF1ZXJ5LmlzQXJyYXkoIG5hbWUgKSApIHsKCgkJCQkJLy8gdHJ5IHRoZSBzdHJpbmcgYXMgYSBrZXkgYmVmb3JlIGFueSBtYW5pcHVsYXRpb24KCQkJCQlpZiAoIG5hbWUgaW4gdGhpc0NhY2hlICkgewoJCQkJCQluYW1lID0gWyBuYW1lIF07CgkJCQkJfSBlbHNlIHsKCgkJCQkJCS8vIHNwbGl0IHRoZSBjYW1lbCBjYXNlZCB2ZXJzaW9uIGJ5IHNwYWNlcyB1bmxlc3MgYSBrZXkgd2l0aCB0aGUgc3BhY2VzIGV4aXN0cwoJCQkJCQluYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApOwoJCQkJCQlpZiAoIG5hbWUgaW4gdGhpc0NhY2hlICkgewoJCQkJCQkJbmFtZSA9IFsgbmFtZSBdOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbmFtZSA9IG5hbWUuc3BsaXQoIiAiKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQlmb3IgKCBpID0gMCwgbCA9IG5hbWUubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCWRlbGV0ZSB0aGlzQ2FjaGVbIG5hbWVbaV0gXTsKCQkJCX0KCgkJCQkvLyBJZiB0aGVyZSBpcyBubyBkYXRhIGxlZnQgaW4gdGhlIGNhY2hlLCB3ZSB3YW50IHRvIGNvbnRpbnVlCgkJCQkvLyBhbmQgbGV0IHRoZSBjYWNoZSBvYmplY3QgaXRzZWxmIGdldCBkZXN0cm95ZWQKCQkJCWlmICggISggcHZ0ID8gaXNFbXB0eURhdGFPYmplY3QgOiBqUXVlcnkuaXNFbXB0eU9iamVjdCApKCB0aGlzQ2FjaGUgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCQl9CgoJCS8vIFNlZSBqUXVlcnkuZGF0YSBmb3IgbW9yZSBpbmZvcm1hdGlvbgoJCWlmICggIXB2dCApIHsKCQkJZGVsZXRlIGNhY2hlWyBpZCBdLmRhdGE7CgoJCQkvLyBEb24ndCBkZXN0cm95IHRoZSBwYXJlbnQgY2FjaGUgdW5sZXNzIHRoZSBpbnRlcm5hbCBkYXRhIG9iamVjdAoJCQkvLyBoYWQgYmVlbiB0aGUgb25seSB0aGluZyBsZWZ0IGluIGl0CgkJCWlmICggIWlzRW1wdHlEYXRhT2JqZWN0KCBjYWNoZVsgaWQgXSApICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQkvLyBEZXN0cm95IHRoZSBjYWNoZQoJCWlmICggaXNOb2RlICkgewoJCQlqUXVlcnkuY2xlYW5EYXRhKCBbIGVsZW0gXSwgdHJ1ZSApOwoKCQkvLyBVc2UgZGVsZXRlIHdoZW4gc3VwcG9ydGVkIGZvciBleHBhbmRvcyBvciBgY2FjaGVgIGlzIG5vdCBhIHdpbmRvdyBwZXIgaXNXaW5kb3cgKCMxMDA4MCkKCQl9IGVsc2UgaWYgKCBqUXVlcnkuc3VwcG9ydC5kZWxldGVFeHBhbmRvIHx8IGNhY2hlICE9IGNhY2hlLndpbmRvdyApIHsKCQkJZGVsZXRlIGNhY2hlWyBpZCBdOwoKCQkvLyBXaGVuIGFsbCBlbHNlIGZhaWxzLCBudWxsCgkJfSBlbHNlIHsKCQkJY2FjaGVbIGlkIF0gPSBudWxsOwoJCX0KCX0sCgoJLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgoJX2RhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBkYXRhICkgewoJCXJldHVybiBqUXVlcnkuZGF0YSggZWxlbSwgbmFtZSwgZGF0YSwgdHJ1ZSApOwoJfSwKCgkvLyBBIG1ldGhvZCBmb3IgZGV0ZXJtaW5pbmcgaWYgYSBET00gbm9kZSBjYW4gaGFuZGxlIHRoZSBkYXRhIGV4cGFuZG8KCWFjY2VwdERhdGE6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBub0RhdGEgPSBlbGVtLm5vZGVOYW1lICYmIGpRdWVyeS5ub0RhdGFbIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOwoKCQkvLyBub2RlcyBhY2NlcHQgZGF0YSB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZDsgcmVqZWN0aW9uIGNhbiBiZSBjb25kaXRpb25hbAoJCXJldHVybiAhbm9EYXRhIHx8IG5vRGF0YSAhPT0gdHJ1ZSAmJiBlbGVtLmdldEF0dHJpYnV0ZSgiY2xhc3NpZCIpID09PSBub0RhdGE7Cgl9Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglkYXRhOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgcGFydHMsIHBhcnQsIGF0dHIsIG5hbWUsIGwsCgkJCWVsZW0gPSB0aGlzWzBdLAoJCQlpID0gMCwKCQkJZGF0YSA9IG51bGw7CgoJCS8vIEdldHMgYWxsIHZhbHVlcwoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgKSB7CgkJCWlmICggdGhpcy5sZW5ndGggKSB7CgkJCQlkYXRhID0galF1ZXJ5LmRhdGEoIGVsZW0gKTsKCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWpRdWVyeS5fZGF0YSggZWxlbSwgInBhcnNlZEF0dHJzIiApICkgewoJCQkJCWF0dHIgPSBlbGVtLmF0dHJpYnV0ZXM7CgkJCQkJZm9yICggbCA9IGF0dHIubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCQluYW1lID0gYXR0cltpXS5uYW1lOwoKCQkJCQkJaWYgKCBuYW1lLmluZGV4T2YoICJkYXRhLSIgKSA9PT0gMCApIHsKCQkJCQkJCW5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lLnN1YnN0cmluZyg1KSApOwoKCQkJCQkJCWRhdGFBdHRyKCBlbGVtLCBuYW1lLCBkYXRhWyBuYW1lIF0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJwYXJzZWRBdHRycyIsIHRydWUgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGRhdGE7CgkJfQoKCQkvLyBTZXRzIG11bHRpcGxlIHZhbHVlcwoJCWlmICggdHlwZW9mIGtleSA9PT0gIm9iamVjdCIgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZGF0YSggdGhpcywga2V5ICk7CgkJCX0pOwoJCX0KCgkJcGFydHMgPSBrZXkuc3BsaXQoICIuIiwgMiApOwoJCXBhcnRzWzFdID0gcGFydHNbMV0gPyAiLiIgKyBwYXJ0c1sxXSA6ICIiOwoJCXBhcnQgPSBwYXJ0c1sxXSArICIhIjsKCgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCgkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCWRhdGEgPSB0aGlzLnRyaWdnZXJIYW5kbGVyKCAiZ2V0RGF0YSIgKyBwYXJ0LCBbIHBhcnRzWzBdIF0gKTsKCgkJCQkvLyBUcnkgdG8gZmV0Y2ggYW55IGludGVybmFsbHkgc3RvcmVkIGRhdGEgZmlyc3QKCQkJCWlmICggZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0gKSB7CgkJCQkJZGF0YSA9IGpRdWVyeS5kYXRhKCBlbGVtLCBrZXkgKTsKCQkJCQlkYXRhID0gZGF0YUF0dHIoIGVsZW0sIGtleSwgZGF0YSApOwoJCQkJfQoKCQkJCXJldHVybiBkYXRhID09PSB1bmRlZmluZWQgJiYgcGFydHNbMV0gPwoJCQkJCXRoaXMuZGF0YSggcGFydHNbMF0gKSA6CgkJCQkJZGF0YTsKCQkJfQoKCQkJcGFydHNbMV0gPSB2YWx1ZTsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkoIHRoaXMgKTsKCgkJCQlzZWxmLnRyaWdnZXJIYW5kbGVyKCAic2V0RGF0YSIgKyBwYXJ0LCBwYXJ0cyApOwoJCQkJalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSwgdmFsdWUgKTsKCQkJCXNlbGYudHJpZ2dlckhhbmRsZXIoICJjaGFuZ2VEYXRhIiArIHBhcnQsIHBhcnRzICk7CgkJCX0pOwoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSwgbnVsbCwgZmFsc2UgKTsKCX0sCgoJcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGtleSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkucmVtb3ZlRGF0YSggdGhpcywga2V5ICk7CgkJfSk7Cgl9Cn0pOwoKZnVuY3Rpb24gZGF0YUF0dHIoIGVsZW0sIGtleSwgZGF0YSApIHsKCS8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGludGVybmFsbHksIHRyeSB0byBmZXRjaCBhbnkKCS8vIGRhdGEgZnJvbSB0aGUgSFRNTDUgZGF0YS0qIGF0dHJpYnV0ZQoJaWYgKCBkYXRhID09PSB1bmRlZmluZWQgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCgkJdmFyIG5hbWUgPSAiZGF0YS0iICsga2V5LnJlcGxhY2UoIHJtdWx0aURhc2gsICItJDEiICkudG9Mb3dlckNhc2UoKTsKCgkJZGF0YSA9IGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICk7CgoJCWlmICggdHlwZW9mIGRhdGEgPT09ICJzdHJpbmciICkgewoJCQl0cnkgewoJCQkJZGF0YSA9IGRhdGEgPT09ICJ0cnVlIiA/IHRydWUgOgoJCQkJZGF0YSA9PT0gImZhbHNlIiA/IGZhbHNlIDoKCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKCQkJCStkYXRhICsgIiIgPT09IGRhdGEgPyArZGF0YSA6CgkJCQlyYnJhY2UudGVzdCggZGF0YSApID8galF1ZXJ5LnBhcnNlSlNPTiggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlICkge30KCgkJCS8vIE1ha2Ugc3VyZSB3ZSBzZXQgdGhlIGRhdGEgc28gaXQgaXNuJ3QgY2hhbmdlZCBsYXRlcgoJCQlqUXVlcnkuZGF0YSggZWxlbSwga2V5LCBkYXRhICk7CgoJCX0gZWxzZSB7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoJfQoKCXJldHVybiBkYXRhOwp9CgovLyBjaGVja3MgYSBjYWNoZSBvYmplY3QgZm9yIGVtcHRpbmVzcwpmdW5jdGlvbiBpc0VtcHR5RGF0YU9iamVjdCggb2JqICkgewoJdmFyIG5hbWU7Cglmb3IgKCBuYW1lIGluIG9iaiApIHsKCgkJLy8gaWYgdGhlIHB1YmxpYyBkYXRhIG9iamVjdCBpcyBlbXB0eSwgdGhlIHByaXZhdGUgaXMgc3RpbGwgZW1wdHkKCQlpZiAoIG5hbWUgPT09ICJkYXRhIiAmJiBqUXVlcnkuaXNFbXB0eU9iamVjdCggb2JqW25hbWVdICkgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQlpZiAoIG5hbWUgIT09ICJ0b0pTT04iICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfQoKCXJldHVybiB0cnVlOwp9CmpRdWVyeS5leHRlbmQoewoJcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBkYXRhICkgewoJCXZhciBxdWV1ZTsKCgkJaWYgKCBlbGVtICkgewoJCQl0eXBlID0gKCB0eXBlIHx8ICJmeCIgKSArICJxdWV1ZSI7CgkJCXF1ZXVlID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCB0eXBlICk7CgoJCQkvLyBTcGVlZCB1cCBkZXF1ZXVlIGJ5IGdldHRpbmcgb3V0IHF1aWNrbHkgaWYgdGhpcyBpcyBqdXN0IGEgbG9va3VwCgkJCWlmICggZGF0YSApIHsKCQkJCWlmICggIXF1ZXVlIHx8IGpRdWVyeS5pc0FycmF5KGRhdGEpICkgewoJCQkJCXF1ZXVlID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCB0eXBlLCBqUXVlcnkubWFrZUFycmF5KGRhdGEpICk7CgkJCQl9IGVsc2UgewoJCQkJCXF1ZXVlLnB1c2goIGRhdGEgKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcXVldWUgfHwgW107CgkJfQoJfSwKCglkZXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsKCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIGVsZW0sIHR5cGUgKSwKCQkJZm4gPSBxdWV1ZS5zaGlmdCgpLAoJCQlob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyggZWxlbSwgdHlwZSApLAoJCQluZXh0ID0gZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZGVxdWV1ZSggZWxlbSwgdHlwZSApOwoJCQl9OwoKCQkvLyBJZiB0aGUgZnggcXVldWUgaXMgZGVxdWV1ZWQsIGFsd2F5cyByZW1vdmUgdGhlIHByb2dyZXNzIHNlbnRpbmVsCgkJaWYgKCBmbiA9PT0gImlucHJvZ3Jlc3MiICkgewoJCQlmbiA9IHF1ZXVlLnNoaWZ0KCk7CgkJfQoKCQlpZiAoIGZuICkgewoKCQkJLy8gQWRkIGEgcHJvZ3Jlc3Mgc2VudGluZWwgdG8gcHJldmVudCB0aGUgZnggcXVldWUgZnJvbSBiZWluZwoJCQkvLyBhdXRvbWF0aWNhbGx5IGRlcXVldWVkCgkJCWlmICggdHlwZSA9PT0gImZ4IiApIHsKCQkJCXF1ZXVlLnVuc2hpZnQoICJpbnByb2dyZXNzIiApOwoJCQl9CgoJCQkvLyBjbGVhciB1cCB0aGUgbGFzdCBxdWV1ZSBzdG9wIGZ1bmN0aW9uCgkJCWRlbGV0ZSBob29rcy5zdG9wOwoJCQlmbi5jYWxsKCBlbGVtLCBuZXh0LCBob29rcyApOwoJCX0KCQlpZiAoICFxdWV1ZS5sZW5ndGggJiYgaG9va3MgKSB7CgkJCWhvb2tzLmVtcHR5LmZpcmUoKTsKCQl9Cgl9LAoKCS8vIG5vdCBpbnRlbmRlZCBmb3IgcHVibGljIGNvbnN1bXB0aW9uIC0gZ2VuZXJhdGVzIGEgcXVldWVIb29rcyBvYmplY3QsIG9yIHJldHVybnMgdGhlIGN1cnJlbnQgb25lCglfcXVldWVIb29rczogZnVuY3Rpb24oIGVsZW0sIHR5cGUgKSB7CgkJdmFyIGtleSA9IHR5cGUgKyAicXVldWVIb29rcyI7CgkJcmV0dXJuIGpRdWVyeS5fZGF0YSggZWxlbSwga2V5ICkgfHwgalF1ZXJ5Ll9kYXRhKCBlbGVtLCBrZXksIHsKCQkJZW1wdHk6IGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IikuYWRkKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5LnJlbW92ZURhdGEoIGVsZW0sIHR5cGUgKyAicXVldWUiLCB0cnVlICk7CgkJCQlqUXVlcnkucmVtb3ZlRGF0YSggZWxlbSwga2V5LCB0cnVlICk7CgkJCX0pCgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglxdWV1ZTogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJdmFyIHNldHRlciA9IDI7CgoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQlkYXRhID0gdHlwZTsKCQkJdHlwZSA9ICJmeCI7CgkJCXNldHRlci0tOwoJCX0KCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgc2V0dGVyICkgewoJCQlyZXR1cm4galF1ZXJ5LnF1ZXVlKCB0aGlzWzBdLCB0eXBlICk7CgkJfQoKCQlyZXR1cm4gZGF0YSA9PT0gdW5kZWZpbmVkID8KCQkJdGhpcyA6CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSggdGhpcywgdHlwZSwgZGF0YSApOwoKCQkJCS8vIGVuc3VyZSBhIGhvb2tzIGZvciB0aGlzIHF1ZXVlCgkJCQlqUXVlcnkuX3F1ZXVlSG9va3MoIHRoaXMsIHR5cGUgKTsKCgkJCQlpZiAoIHR5cGUgPT09ICJmeCIgJiYgcXVldWVbMF0gIT09ICJpbnByb2dyZXNzIiApIHsKCQkJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgdHlwZSApOwoJCQkJfQoJCQl9KTsKCX0sCglkZXF1ZXVlOiBmdW5jdGlvbiggdHlwZSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgdHlwZSApOwoJCX0pOwoJfSwKCS8vIEJhc2VkIG9mZiBvZiB0aGUgcGx1Z2luIGJ5IENsaW50IEhlbGZlcnMsIHdpdGggcGVybWlzc2lvbi4KCS8vIGh0dHA6Ly9ibGluZHNpZ25hbHMuY29tL2luZGV4LnBocC8yMDA5LzA3L2pxdWVyeS1kZWxheS8KCWRlbGF5OiBmdW5jdGlvbiggdGltZSwgdHlwZSApIHsKCQl0aW1lID0galF1ZXJ5LmZ4ID8galF1ZXJ5LmZ4LnNwZWVkc1sgdGltZSBdIHx8IHRpbWUgOiB0aW1lOwoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXJldHVybiB0aGlzLnF1ZXVlKCB0eXBlLCBmdW5jdGlvbiggbmV4dCwgaG9va3MgKSB7CgkJCXZhciB0aW1lb3V0ID0gc2V0VGltZW91dCggbmV4dCwgdGltZSApOwoJCQlob29rcy5zdG9wID0gZnVuY3Rpb24oKSB7CgkJCQljbGVhclRpbWVvdXQoIHRpbWVvdXQgKTsKCQkJfTsKCQl9KTsKCX0sCgljbGVhclF1ZXVlOiBmdW5jdGlvbiggdHlwZSApIHsKCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSB8fCAiZngiLCBbXSApOwoJfSwKCS8vIEdldCBhIHByb21pc2UgcmVzb2x2ZWQgd2hlbiBxdWV1ZXMgb2YgYSBjZXJ0YWluIHR5cGUKCS8vIGFyZSBlbXB0aWVkIChmeCBpcyB0aGUgdHlwZSBieSBkZWZhdWx0KQoJcHJvbWlzZTogZnVuY3Rpb24oIHR5cGUsIG9iaiApIHsKCQl2YXIgdG1wLAoJCQljb3VudCA9IDEsCgkJCWRlZmVyID0galF1ZXJ5LkRlZmVycmVkKCksCgkJCWVsZW1lbnRzID0gdGhpcywKCQkJaSA9IHRoaXMubGVuZ3RoLAoJCQlyZXNvbHZlID0gZnVuY3Rpb24oKSB7CgkJCQlpZiAoICEoIC0tY291bnQgKSApIHsKCQkJCQlkZWZlci5yZXNvbHZlV2l0aCggZWxlbWVudHMsIFsgZWxlbWVudHMgXSApOwoJCQkJfQoJCQl9OwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJb2JqID0gdHlwZTsKCQkJdHlwZSA9IHVuZGVmaW5lZDsKCQl9CgkJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCgkJd2hpbGUoIGktLSApIHsKCQkJaWYgKCAodG1wID0galF1ZXJ5Ll9kYXRhKCBlbGVtZW50c1sgaSBdLCB0eXBlICsgInF1ZXVlSG9va3MiICkpICYmIHRtcC5lbXB0eSApIHsKCQkJCWNvdW50Kys7CgkJCQl0bXAuZW1wdHkuYWRkKCByZXNvbHZlICk7CgkJCX0KCQl9CgkJcmVzb2x2ZSgpOwoJCXJldHVybiBkZWZlci5wcm9taXNlKCBvYmogKTsKCX0KfSk7CnZhciBub2RlSG9vaywgYm9vbEhvb2ssIGZpeFNwZWNpZmllZCwKCXJjbGFzcyA9IC9bXHRcclxuXS9nLAoJcnJldHVybiA9IC9cci9nLAoJcnR5cGUgPSAvXig/OmJ1dHRvbnxpbnB1dCkkL2ksCglyZm9jdXNhYmxlID0gL14oPzpidXR0b258aW5wdXR8b2JqZWN0fHNlbGVjdHx0ZXh0YXJlYSkkL2ksCglyY2xpY2thYmxlID0gL15hKD86cmVhfCkkL2ksCglyYm9vbGVhbiA9IC9eKD86YXV0b2ZvY3VzfGF1dG9wbGF5fGFzeW5jfGNoZWNrZWR8Y29udHJvbHN8ZGVmZXJ8ZGlzYWJsZWR8aGlkZGVufGxvb3B8bXVsdGlwbGV8b3BlbnxyZWFkb25seXxyZXF1aXJlZHxzY29wZWR8c2VsZWN0ZWQpJC9pLAoJZ2V0U2V0QXR0cmlidXRlID0galF1ZXJ5LnN1cHBvcnQuZ2V0U2V0QXR0cmlidXRlOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglhdHRyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGpRdWVyeS5hdHRyLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsKCX0sCgoJcmVtb3ZlQXR0cjogZnVuY3Rpb24oIG5hbWUgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LnJlbW92ZUF0dHIoIHRoaXMsIG5hbWUgKTsKCQl9KTsKCX0sCgoJcHJvcDogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBqUXVlcnkucHJvcCwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9LAoKCXJlbW92ZVByb3A6IGZ1bmN0aW9uKCBuYW1lICkgewoJCW5hbWUgPSBqUXVlcnkucHJvcEZpeFsgbmFtZSBdIHx8IG5hbWU7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJLy8gdHJ5L2NhdGNoIGhhbmRsZXMgY2FzZXMgd2hlcmUgSUUgYmFsa3MgKHN1Y2ggYXMgcmVtb3ZpbmcgYSBwcm9wZXJ0eSBvbiB3aW5kb3cpCgkJCXRyeSB7CgkJCQl0aGlzWyBuYW1lIF0gPSB1bmRlZmluZWQ7CgkJCQlkZWxldGUgdGhpc1sgbmFtZSBdOwoJCQl9IGNhdGNoKCBlICkge30KCQl9KTsKCX0sCgoJYWRkQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgY2xhc3NOYW1lcywgaSwgbCwgZWxlbSwKCQkJc2V0Q2xhc3MsIGMsIGNsOwoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBqICkgewoJCQkJalF1ZXJ5KCB0aGlzICkuYWRkQ2xhc3MoIHZhbHVlLmNhbGwodGhpcywgaiwgdGhpcy5jbGFzc05hbWUpICk7CgkJCX0pOwoJCX0KCgkJaWYgKCB2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICkgewoJCQljbGFzc05hbWVzID0gdmFsdWUuc3BsaXQoIGNvcmVfcnNwYWNlICk7CgoJCQlmb3IgKCBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJZWxlbSA9IHRoaXNbIGkgXTsKCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJaWYgKCAhZWxlbS5jbGFzc05hbWUgJiYgY2xhc3NOYW1lcy5sZW5ndGggPT09IDEgKSB7CgkJCQkJCWVsZW0uY2xhc3NOYW1lID0gdmFsdWU7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldENsYXNzID0gIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICI7CgoJCQkJCQlmb3IgKCBjID0gMCwgY2wgPSBjbGFzc05hbWVzLmxlbmd0aDsgYyA8IGNsOyBjKysgKSB7CgkJCQkJCQlpZiAoICF+c2V0Q2xhc3MuaW5kZXhPZiggIiAiICsgY2xhc3NOYW1lc1sgYyBdICsgIiAiICkgKSB7CgkJCQkJCQkJc2V0Q2xhc3MgKz0gY2xhc3NOYW1lc1sgYyBdICsgIiAiOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCWVsZW0uY2xhc3NOYW1lID0galF1ZXJ5LnRyaW0oIHNldENsYXNzICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgcmVtb3ZlcywgY2xhc3NOYW1lLCBlbGVtLCBjLCBjbCwgaSwgbDsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaiApIHsKCQkJCWpRdWVyeSggdGhpcyApLnJlbW92ZUNsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lKSApOwoJCQl9KTsKCQl9CgkJaWYgKCAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJcmVtb3ZlcyA9ICggdmFsdWUgfHwgIiIgKS5zcGxpdCggY29yZV9yc3BhY2UgKTsKCgkJCWZvciAoIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQllbGVtID0gdGhpc1sgaSBdOwoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmIGVsZW0uY2xhc3NOYW1lICkgewoKCQkJCQljbGFzc05hbWUgPSAoIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICIpLnJlcGxhY2UoIHJjbGFzcywgIiAiICk7CgoJCQkJCS8vIGxvb3Agb3ZlciBlYWNoIGl0ZW0gaW4gdGhlIHJlbW92YWwgbGlzdAoJCQkJCWZvciAoIGMgPSAwLCBjbCA9IHJlbW92ZXMubGVuZ3RoOyBjIDwgY2w7IGMrKyApIHsKCQkJCQkJLy8gUmVtb3ZlIHVudGlsIHRoZXJlIGlzIG5vdGhpbmcgdG8gcmVtb3ZlLAoJCQkJCQl3aGlsZSAoIGNsYXNzTmFtZS5pbmRleE9mKCIgIiArIHJlbW92ZXNbIGMgXSArICIgIikgPiAtMSApIHsKCQkJCQkJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZS5yZXBsYWNlKCAiICIgKyByZW1vdmVzWyBjIF0gKyAiICIgLCAiICIgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQllbGVtLmNsYXNzTmFtZSA9IHZhbHVlID8galF1ZXJ5LnRyaW0oIGNsYXNzTmFtZSApIDogIiI7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgl0b2dnbGVDbGFzczogZnVuY3Rpb24oIHZhbHVlLCBzdGF0ZVZhbCApIHsKCQl2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZSwKCQkJaXNCb29sID0gdHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiI7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS50b2dnbGVDbGFzcyggdmFsdWUuY2FsbCh0aGlzLCBpLCB0aGlzLmNsYXNzTmFtZSwgc3RhdGVWYWwpLCBzdGF0ZVZhbCApOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggdHlwZSA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyB0b2dnbGUgaW5kaXZpZHVhbCBjbGFzcyBuYW1lcwoJCQkJdmFyIGNsYXNzTmFtZSwKCQkJCQlpID0gMCwKCQkJCQlzZWxmID0galF1ZXJ5KCB0aGlzICksCgkJCQkJc3RhdGUgPSBzdGF0ZVZhbCwKCQkJCQljbGFzc05hbWVzID0gdmFsdWUuc3BsaXQoIGNvcmVfcnNwYWNlICk7CgoJCQkJd2hpbGUgKCAoY2xhc3NOYW1lID0gY2xhc3NOYW1lc1sgaSsrIF0pICkgewoJCQkJCS8vIGNoZWNrIGVhY2ggY2xhc3NOYW1lIGdpdmVuLCBzcGFjZSBzZXBhcmF0ZWQgbGlzdAoJCQkJCXN0YXRlID0gaXNCb29sID8gc3RhdGUgOiAhc2VsZi5oYXNDbGFzcyggY2xhc3NOYW1lICk7CgkJCQkJc2VsZlsgc3RhdGUgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIiBdKCBjbGFzc05hbWUgKTsKCQkJCX0KCgkJCX0gZWxzZSBpZiAoIHR5cGUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGUgPT09ICJib29sZWFuIiApIHsKCQkJCWlmICggdGhpcy5jbGFzc05hbWUgKSB7CgkJCQkJLy8gc3RvcmUgY2xhc3NOYW1lIGlmIHNldAoJCQkJCWpRdWVyeS5fZGF0YSggdGhpcywgIl9fY2xhc3NOYW1lX18iLCB0aGlzLmNsYXNzTmFtZSApOwoJCQkJfQoKCQkJCS8vIHRvZ2dsZSB3aG9sZSBjbGFzc05hbWUKCQkJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUgfHwgdmFsdWUgPT09IGZhbHNlID8gIiIgOiBqUXVlcnkuX2RhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiApIHx8ICIiOwoJCQl9CgkJfSk7Cgl9LAoKCWhhc0NsYXNzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiLAoJCQlpID0gMCwKCQkJbCA9IHRoaXMubGVuZ3RoOwoJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJaWYgKCB0aGlzW2ldLm5vZGVUeXBlID09PSAxICYmICgiICIgKyB0aGlzW2ldLmNsYXNzTmFtZSArICIgIikucmVwbGFjZShyY2xhc3MsICIgIikuaW5kZXhPZiggY2xhc3NOYW1lICkgPiAtMSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCXZhbDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBob29rcywgcmV0LCBpc0Z1bmN0aW9uLAoJCQllbGVtID0gdGhpc1swXTsKCgkJaWYgKCAhYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJaWYgKCBlbGVtICkgewoJCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIGVsZW0udHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgoJCQkJaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCAidmFsdWUiICkpICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHJldDsKCQkJCX0KCgkJCQlyZXQgPSBlbGVtLnZhbHVlOwoKCQkJCXJldHVybiB0eXBlb2YgcmV0ID09PSAic3RyaW5nIiA/CgkJCQkJLy8gaGFuZGxlIG1vc3QgY29tbW9uIHN0cmluZyBjYXNlcwoJCQkJCXJldC5yZXBsYWNlKHJyZXR1cm4sICIiKSA6CgkJCQkJLy8gaGFuZGxlIGNhc2VzIHdoZXJlIHZhbHVlIGlzIG51bGwvdW5kZWYgb3IgbnVtYmVyCgkJCQkJcmV0ID09IG51bGwgPyAiIiA6IHJldDsKCQkJfQoKCQkJcmV0dXJuOwoJCX0KCgkJaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApOwoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgdmFsLAoJCQkJc2VsZiA9IGpRdWVyeSh0aGlzKTsKCgkJCWlmICggdGhpcy5ub2RlVHlwZSAhPT0gMSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBpc0Z1bmN0aW9uICkgewoJCQkJdmFsID0gdmFsdWUuY2FsbCggdGhpcywgaSwgc2VsZi52YWwoKSApOwoJCQl9IGVsc2UgewoJCQkJdmFsID0gdmFsdWU7CgkJCX0KCgkJCS8vIFRyZWF0IG51bGwvdW5kZWZpbmVkIGFzICIiOyBjb252ZXJ0IG51bWJlcnMgdG8gc3RyaW5nCgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSAiIjsKCQkJfSBlbHNlIGlmICggdHlwZW9mIHZhbCA9PT0gIm51bWJlciIgKSB7CgkJCQl2YWwgKz0gIiI7CgkJCX0gZWxzZSBpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWwgKSApIHsKCQkJCXZhbCA9IGpRdWVyeS5tYXAodmFsLCBmdW5jdGlvbiAoIHZhbHVlICkgewoJCQkJCXJldHVybiB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSArICIiOwoJCQkJfSk7CgkJCX0KCgkJCWhvb2tzID0galF1ZXJ5LnZhbEhvb2tzWyB0aGlzLnR5cGUgXSB8fCBqUXVlcnkudmFsSG9va3NbIHRoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOwoKCQkJLy8gSWYgc2V0IHJldHVybnMgdW5kZWZpbmVkLCBmYWxsIGJhY2sgdG8gbm9ybWFsIHNldHRpbmcKCQkJaWYgKCAhaG9va3MgfHwgISgic2V0IiBpbiBob29rcykgfHwgaG9va3Muc2V0KCB0aGlzLCB2YWwsICJ2YWx1ZSIgKSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy52YWx1ZSA9IHZhbDsKCQkJfQoJCX0pOwoJfQp9KTsKCmpRdWVyeS5leHRlbmQoewoJdmFsSG9va3M6IHsKCQlvcHRpb246IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCS8vIGF0dHJpYnV0ZXMudmFsdWUgaXMgdW5kZWZpbmVkIGluIEJsYWNrYmVycnkgNC43IGJ1dAoJCQkJLy8gdXNlcyAudmFsdWUuIFNlZSAjNjkzMgoJCQkJdmFyIHZhbCA9IGVsZW0uYXR0cmlidXRlcy52YWx1ZTsKCQkJCXJldHVybiAhdmFsIHx8IHZhbC5zcGVjaWZpZWQgPyBlbGVtLnZhbHVlIDogZWxlbS50ZXh0OwoJCQl9CgkJfSwKCQlzZWxlY3Q6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciB2YWx1ZSwgaSwgbWF4LCBvcHRpb24sCgkJCQkJaW5kZXggPSBlbGVtLnNlbGVjdGVkSW5kZXgsCgkJCQkJdmFsdWVzID0gW10sCgkJCQkJb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKCQkJCQlvbmUgPSBlbGVtLnR5cGUgPT09ICJzZWxlY3Qtb25lIjsKCgkJCQkvLyBOb3RoaW5nIHdhcyBzZWxlY3RlZAoJCQkJaWYgKCBpbmRleCA8IDAgKSB7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgoJCQkJLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgc2VsZWN0ZWQgb3B0aW9ucwoJCQkJaSA9IG9uZSA/IGluZGV4IDogMDsKCQkJCW1heCA9IG9uZSA/IGluZGV4ICsgMSA6IG9wdGlvbnMubGVuZ3RoOwoJCQkJZm9yICggOyBpIDwgbWF4OyBpKysgKSB7CgkJCQkJb3B0aW9uID0gb3B0aW9uc1sgaSBdOwoKCQkJCQkvLyBEb24ndCByZXR1cm4gb3B0aW9ucyB0aGF0IGFyZSBkaXNhYmxlZCBvciBpbiBhIGRpc2FibGVkIG9wdGdyb3VwCgkJCQkJaWYgKCBvcHRpb24uc2VsZWN0ZWQgJiYgKGpRdWVyeS5zdXBwb3J0Lm9wdERpc2FibGVkID8gIW9wdGlvbi5kaXNhYmxlZCA6IG9wdGlvbi5nZXRBdHRyaWJ1dGUoImRpc2FibGVkIikgPT09IG51bGwpICYmCgkJCQkJCQkoIW9wdGlvbi5wYXJlbnROb2RlLmRpc2FibGVkIHx8ICFqUXVlcnkubm9kZU5hbWUoIG9wdGlvbi5wYXJlbnROb2RlLCAib3B0Z3JvdXAiICkpICkgewoKCQkJCQkJLy8gR2V0IHRoZSBzcGVjaWZpYyB2YWx1ZSBmb3IgdGhlIG9wdGlvbgoJCQkJCQl2YWx1ZSA9IGpRdWVyeSggb3B0aW9uICkudmFsKCk7CgoJCQkJCQkvLyBXZSBkb24ndCBuZWVkIGFuIGFycmF5IGZvciBvbmUgc2VsZWN0cwoJCQkJCQlpZiAoIG9uZSApIHsKCQkJCQkJCXJldHVybiB2YWx1ZTsKCQkJCQkJfQoKCQkJCQkJLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKCQkJCQkJdmFsdWVzLnB1c2goIHZhbHVlICk7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIEZpeGVzIEJ1ZyAjMjU1MSAtLSBzZWxlY3QudmFsKCkgYnJva2VuIGluIElFIGFmdGVyIGZvcm0ucmVzZXQoKQoJCQkJaWYgKCBvbmUgJiYgIXZhbHVlcy5sZW5ndGggJiYgb3B0aW9ucy5sZW5ndGggKSB7CgkJCQkJcmV0dXJuIGpRdWVyeSggb3B0aW9uc1sgaW5kZXggXSApLnZhbCgpOwoJCQkJfQoKCQkJCXJldHVybiB2YWx1ZXM7CgkJCX0sCgoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCXZhciB2YWx1ZXMgPSBqUXVlcnkubWFrZUFycmF5KCB2YWx1ZSApOwoKCQkJCWpRdWVyeShlbGVtKS5maW5kKCJvcHRpb24iKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXRoaXMuc2VsZWN0ZWQgPSBqUXVlcnkuaW5BcnJheSggalF1ZXJ5KHRoaXMpLnZhbCgpLCB2YWx1ZXMgKSA+PSAwOwoJCQkJfSk7CgoJCQkJaWYgKCAhdmFsdWVzLmxlbmd0aCApIHsKCQkJCQllbGVtLnNlbGVjdGVkSW5kZXggPSAtMTsKCQkJCX0KCQkJCXJldHVybiB2YWx1ZXM7CgkJCX0KCQl9Cgl9LAoKCWF0dHI6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSwgcGFzcyApIHsKCQl2YXIgcmV0LCBob29rcywgbm90eG1sLAoJCQluVHlwZSA9IGVsZW0ubm9kZVR5cGU7CgoJCS8vIGRvbid0IGdldC9zZXQgYXR0cmlidXRlcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMKCQlpZiAoICFlbGVtIHx8IG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBhc3MgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIGpRdWVyeS5mblsgbmFtZSBdICkgKSB7CgkJCXJldHVybiBqUXVlcnkoIGVsZW0gKVsgbmFtZSBdKCB2YWx1ZSApOwoJCX0KCgkJLy8gRmFsbGJhY2sgdG8gcHJvcCB3aGVuIGF0dHJpYnV0ZXMgYXJlIG5vdCBzdXBwb3J0ZWQKCQlpZiAoIHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCXJldHVybiBqUXVlcnkucHJvcCggZWxlbSwgbmFtZSwgdmFsdWUgKTsKCQl9CgoJCW5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKTsKCgkJLy8gQWxsIGF0dHJpYnV0ZXMgYXJlIGxvd2VyY2FzZQoJCS8vIEdyYWIgbmVjZXNzYXJ5IGhvb2sgaWYgb25lIGlzIGRlZmluZWQKCQlpZiAoIG5vdHhtbCApIHsKCQkJbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQkJaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gfHwgKCByYm9vbGVhbi50ZXN0KCBuYW1lICkgPyBib29sSG9vayA6IG5vZGVIb29rICk7CgkJfQoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgoJCQlpZiAoIHZhbHVlID09PSBudWxsICkgewoJCQkJalF1ZXJ5LnJlbW92ZUF0dHIoIGVsZW0sIG5hbWUgKTsKCQkJCXJldHVybjsKCgkJCX0gZWxzZSBpZiAoIGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmIG5vdHhtbCAmJiAocmV0ID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgbmFtZSApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHJldDsKCgkJCX0gZWxzZSB7CgkJCQllbGVtLnNldEF0dHJpYnV0ZSggbmFtZSwgIiIgKyB2YWx1ZSApOwoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9CgoJCX0gZWxzZSBpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIG5vdHhtbCAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkpICE9PSBudWxsICkgewoJCQlyZXR1cm4gcmV0OwoKCQl9IGVsc2UgewoKCQkJcmV0ID0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKTsKCgkJCS8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCgkJCXJldHVybiByZXQgPT09IG51bGwgPwoJCQkJdW5kZWZpbmVkIDoKCQkJCXJldDsKCQl9Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQl2YXIgcHJvcE5hbWUsIGF0dHJOYW1lcywgbmFtZSwgaXNCb29sLAoJCQlpID0gMDsKCgkJaWYgKCB2YWx1ZSAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgewoKCQkJYXR0ck5hbWVzID0gdmFsdWUuc3BsaXQoIGNvcmVfcnNwYWNlICk7CgoJCQlmb3IgKCA7IGkgPCBhdHRyTmFtZXMubGVuZ3RoOyBpKysgKSB7CgkJCQluYW1lID0gYXR0ck5hbWVzWyBpIF07CgoJCQkJaWYgKCBuYW1lICkgewoJCQkJCXByb3BOYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoJCQkJCWlzQm9vbCA9IHJib29sZWFuLnRlc3QoIG5hbWUgKTsKCgkJCQkJLy8gU2VlICM5Njk5IGZvciBleHBsYW5hdGlvbiBvZiB0aGlzIGFwcHJvYWNoIChzZXR0aW5nIGZpcnN0LCB0aGVuIHJlbW92YWwpCgkJCQkJLy8gRG8gbm90IGRvIHRoaXMgZm9yIGJvb2xlYW4gYXR0cmlidXRlcyAoc2VlICMxMDg3MCkKCQkJCQlpZiAoICFpc0Jvb2wgKSB7CgkJCQkJCWpRdWVyeS5hdHRyKCBlbGVtLCBuYW1lLCAiIiApOwoJCQkJCX0KCQkJCQllbGVtLnJlbW92ZUF0dHJpYnV0ZSggZ2V0U2V0QXR0cmlidXRlID8gbmFtZSA6IHByb3BOYW1lICk7CgoJCQkJCS8vIFNldCBjb3JyZXNwb25kaW5nIHByb3BlcnR5IHRvIGZhbHNlIGZvciBib29sZWFuIGF0dHJpYnV0ZXMKCQkJCQlpZiAoIGlzQm9vbCAmJiBwcm9wTmFtZSBpbiBlbGVtICkgewoJCQkJCQllbGVtWyBwcm9wTmFtZSBdID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfSwKCglhdHRySG9va3M6IHsKCQl0eXBlOiB7CgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQkJLy8gV2UgY2FuJ3QgYWxsb3cgdGhlIHR5cGUgcHJvcGVydHkgdG8gYmUgY2hhbmdlZCAoc2luY2UgaXQgY2F1c2VzIHByb2JsZW1zIGluIElFKQoJCQkJaWYgKCBydHlwZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCWpRdWVyeS5lcnJvciggInR5cGUgcHJvcGVydHkgY2FuJ3QgYmUgY2hhbmdlZCIgKTsKCQkJCX0gZWxzZSBpZiAoICFqUXVlcnkuc3VwcG9ydC5yYWRpb1ZhbHVlICYmIHZhbHVlID09PSAicmFkaW8iICYmIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAiaW5wdXQiKSApIHsKCQkJCQkvLyBTZXR0aW5nIHRoZSB0eXBlIG9uIGEgcmFkaW8gYnV0dG9uIGFmdGVyIHRoZSB2YWx1ZSByZXNldHMgdGhlIHZhbHVlIGluIElFNi05CgkJCQkJLy8gUmVzZXQgdmFsdWUgdG8gaXQncyBkZWZhdWx0IGluIGNhc2UgdHlwZSBpcyBzZXQgYWZ0ZXIgdmFsdWUKCQkJCQkvLyBUaGlzIGlzIGZvciBlbGVtZW50IGNyZWF0aW9uCgkJCQkJdmFyIHZhbCA9IGVsZW0udmFsdWU7CgkJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgdmFsdWUgKTsKCQkJCQlpZiAoIHZhbCApIHsKCQkJCQkJZWxlbS52YWx1ZSA9IHZhbDsKCQkJCQl9CgkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJfQoJCQl9CgkJfSwKCQkvLyBVc2UgdGhlIHZhbHVlIHByb3BlcnR5IGZvciBiYWNrIGNvbXBhdAoJCS8vIFVzZSB0aGUgbm9kZUhvb2sgZm9yIGJ1dHRvbiBlbGVtZW50cyBpbiBJRTYvNyAoIzE5NTQpCgkJdmFsdWU6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQkJCWlmICggbm9kZUhvb2sgJiYgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiYnV0dG9uIiApICkgewoJCQkJCXJldHVybiBub2RlSG9vay5nZXQoIGVsZW0sIG5hbWUgKTsKCQkJCX0KCQkJCXJldHVybiBuYW1lIGluIGVsZW0gPwoJCQkJCWVsZW0udmFsdWUgOgoJCQkJCW51bGw7CgkJCX0sCgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewoJCQkJaWYgKCBub2RlSG9vayAmJiBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJidXR0b24iICkgKSB7CgkJCQkJcmV0dXJuIG5vZGVIb29rLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKTsKCQkJCX0KCQkJCS8vIERvZXMgbm90IHJldHVybiBzbyB0aGF0IHNldEF0dHJpYnV0ZSBpcyBhbHNvIHVzZWQKCQkJCWVsZW0udmFsdWUgPSB2YWx1ZTsKCQkJfQoJCX0KCX0sCgoJcHJvcEZpeDogewoJCXRhYmluZGV4OiAidGFiSW5kZXgiLAoJCXJlYWRvbmx5OiAicmVhZE9ubHkiLAoJCSJmb3IiOiAiaHRtbEZvciIsCgkJImNsYXNzIjogImNsYXNzTmFtZSIsCgkJbWF4bGVuZ3RoOiAibWF4TGVuZ3RoIiwKCQljZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKCQljZWxscGFkZGluZzogImNlbGxQYWRkaW5nIiwKCQlyb3dzcGFuOiAicm93U3BhbiIsCgkJY29sc3BhbjogImNvbFNwYW4iLAoJCXVzZW1hcDogInVzZU1hcCIsCgkJZnJhbWVib3JkZXI6ICJmcmFtZUJvcmRlciIsCgkJY29udGVudGVkaXRhYmxlOiAiY29udGVudEVkaXRhYmxlIgoJfSwKCglwcm9wOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJdmFyIHJldCwgaG9va3MsIG5vdHhtbCwKCQkJblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKCQkvLyBkb24ndCBnZXQvc2V0IHByb3BlcnRpZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJbm90eG1sID0gblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApOwoKCQlpZiAoIG5vdHhtbCApIHsKCQkJLy8gRml4IG5hbWUgYW5kIGF0dGFjaCBob29rcwoJCQluYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoJCQlob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXTsKCQl9CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCBob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgbmFtZSApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHJldDsKCgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gKCBlbGVtWyBuYW1lIF0gPSB2YWx1ZSApOwoJCQl9CgoJCX0gZWxzZSB7CgkJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgbmFtZSApKSAhPT0gbnVsbCApIHsKCQkJCXJldHVybiByZXQ7CgoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIGVsZW1bIG5hbWUgXTsKCQkJfQoJCX0KCX0sCgoJcHJvcEhvb2tzOiB7CgkJdGFiSW5kZXg6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCS8vIGVsZW0udGFiSW5kZXggZG9lc24ndCBhbHdheXMgcmV0dXJuIHRoZSBjb3JyZWN0IHZhbHVlIHdoZW4gaXQgaGFzbid0IGJlZW4gZXhwbGljaXRseSBzZXQKCQkJCS8vIGh0dHA6Ly9mbHVpZHByb2plY3Qub3JnL2Jsb2cvMjAwOC8wMS8wOS9nZXR0aW5nLXNldHRpbmctYW5kLXJlbW92aW5nLXRhYmluZGV4LXZhbHVlcy13aXRoLWphdmFzY3JpcHQvCgkJCQl2YXIgYXR0cmlidXRlTm9kZSA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgidGFiaW5kZXgiKTsKCgkJCQlyZXR1cm4gYXR0cmlidXRlTm9kZSAmJiBhdHRyaWJ1dGVOb2RlLnNwZWNpZmllZCA/CgkJCQkJcGFyc2VJbnQoIGF0dHJpYnV0ZU5vZGUudmFsdWUsIDEwICkgOgoJCQkJCXJmb2N1c2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApIHx8IHJjbGlja2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApICYmIGVsZW0uaHJlZiA/CgkJCQkJCTAgOgoJCQkJCQl1bmRlZmluZWQ7CgkJCX0KCQl9Cgl9Cn0pOwoKLy8gSG9vayBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCmJvb2xIb29rID0gewoJZ2V0OiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQkvLyBBbGlnbiBib29sZWFuIGF0dHJpYnV0ZXMgd2l0aCBjb3JyZXNwb25kaW5nIHByb3BlcnRpZXMKCQkvLyBGYWxsIGJhY2sgdG8gYXR0cmlidXRlIHByZXNlbmNlIHdoZXJlIHNvbWUgYm9vbGVhbnMgYXJlIG5vdCBzdXBwb3J0ZWQKCQl2YXIgYXR0ck5vZGUsCgkJCXByb3BlcnR5ID0galF1ZXJ5LnByb3AoIGVsZW0sIG5hbWUgKTsKCQlyZXR1cm4gcHJvcGVydHkgPT09IHRydWUgfHwgdHlwZW9mIHByb3BlcnR5ICE9PSAiYm9vbGVhbiIgJiYgKCBhdHRyTm9kZSA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZShuYW1lKSApICYmIGF0dHJOb2RlLm5vZGVWYWx1ZSAhPT0gZmFsc2UgPwoJCQluYW1lLnRvTG93ZXJDYXNlKCkgOgoJCQl1bmRlZmluZWQ7Cgl9LAoJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7CgkJdmFyIHByb3BOYW1lOwoJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoJCQkvLyBSZW1vdmUgYm9vbGVhbiBhdHRyaWJ1dGVzIHdoZW4gc2V0IHRvIGZhbHNlCgkJCWpRdWVyeS5yZW1vdmVBdHRyKCBlbGVtLCBuYW1lICk7CgkJfSBlbHNlIHsKCQkJLy8gdmFsdWUgaXMgdHJ1ZSBzaW5jZSB3ZSBrbm93IGF0IHRoaXMgcG9pbnQgaXQncyB0eXBlIGJvb2xlYW4gYW5kIG5vdCBmYWxzZQoJCQkvLyBTZXQgYm9vbGVhbiBhdHRyaWJ1dGVzIHRvIHRoZSBzYW1lIG5hbWUgYW5kIHNldCB0aGUgRE9NIHByb3BlcnR5CgkJCXByb3BOYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoJCQlpZiAoIHByb3BOYW1lIGluIGVsZW0gKSB7CgkJCQkvLyBPbmx5IHNldCB0aGUgSURMIHNwZWNpZmljYWxseSBpZiBpdCBhbHJlYWR5IGV4aXN0cyBvbiB0aGUgZWxlbWVudAoJCQkJZWxlbVsgcHJvcE5hbWUgXSA9IHRydWU7CgkJCX0KCgkJCWVsZW0uc2V0QXR0cmlidXRlKCBuYW1lLCBuYW1lLnRvTG93ZXJDYXNlKCkgKTsKCQl9CgkJcmV0dXJuIG5hbWU7Cgl9Cn07CgovLyBJRTYvNyBkbyBub3Qgc3VwcG9ydCBnZXR0aW5nL3NldHRpbmcgc29tZSBhdHRyaWJ1dGVzIHdpdGggZ2V0L3NldEF0dHJpYnV0ZQppZiAoICFnZXRTZXRBdHRyaWJ1dGUgKSB7CgoJZml4U3BlY2lmaWVkID0gewoJCW5hbWU6IHRydWUsCgkJaWQ6IHRydWUsCgkJY29vcmRzOiB0cnVlCgl9OwoKCS8vIFVzZSB0aGlzIGZvciBhbnkgYXR0cmlidXRlIGluIElFNi83CgkvLyBUaGlzIGZpeGVzIGFsbW9zdCBldmVyeSBJRTYvNyBpc3N1ZQoJbm9kZUhvb2sgPSBqUXVlcnkudmFsSG9va3MuYnV0dG9uID0gewoJCWdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJCXZhciByZXQ7CgkJCXJldCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApOwoJCQlyZXR1cm4gcmV0ICYmICggZml4U3BlY2lmaWVkWyBuYW1lIF0gPyByZXQudmFsdWUgIT09ICIiIDogcmV0LnNwZWNpZmllZCApID8KCQkJCXJldC52YWx1ZSA6CgkJCQl1bmRlZmluZWQ7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgbmFtZSApIHsKCQkJLy8gU2V0IHRoZSBleGlzdGluZyBvciBjcmVhdGUgYSBuZXcgYXR0cmlidXRlIG5vZGUKCQkJdmFyIHJldCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApOwoJCQlpZiAoICFyZXQgKSB7CgkJCQlyZXQgPSBkb2N1bWVudC5jcmVhdGVBdHRyaWJ1dGUoIG5hbWUgKTsKCQkJCWVsZW0uc2V0QXR0cmlidXRlTm9kZSggcmV0ICk7CgkJCX0KCQkJcmV0dXJuICggcmV0LnZhbHVlID0gdmFsdWUgKyAiIiApOwoJCX0KCX07CgoJLy8gU2V0IHdpZHRoIGFuZCBoZWlnaHQgdG8gYXV0byBpbnN0ZWFkIG9mIDAgb24gZW1wdHkgc3RyaW5nKCBCdWcgIzgxNTAgKQoJLy8gVGhpcyBpcyBmb3IgcmVtb3ZhbHMKCWpRdWVyeS5lYWNoKFsgIndpZHRoIiwgImhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJalF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggalF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdLCB7CgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQkJaWYgKCB2YWx1ZSA9PT0gIiIgKSB7CgkJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsICJhdXRvIiApOwoJCQkJCXJldHVybiB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0pOwoJfSk7CgoJLy8gU2V0IGNvbnRlbnRlZGl0YWJsZSB0byBmYWxzZSBvbiByZW1vdmFscygjMTA0MjkpCgkvLyBTZXR0aW5nIHRvIGVtcHR5IHN0cmluZyB0aHJvd3MgYW4gZXJyb3IgYXMgYW4gaW52YWxpZCB2YWx1ZQoJalF1ZXJ5LmF0dHJIb29rcy5jb250ZW50ZWRpdGFibGUgPSB7CgkJZ2V0OiBub2RlSG9vay5nZXQsCgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7CgkJCWlmICggdmFsdWUgPT09ICIiICkgewoJCQkJdmFsdWUgPSAiZmFsc2UiOwoJCQl9CgkJCW5vZGVIb29rLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKTsKCQl9Cgl9Owp9CgoKLy8gU29tZSBhdHRyaWJ1dGVzIHJlcXVpcmUgYSBzcGVjaWFsIGNhbGwgb24gSUUKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuaHJlZk5vcm1hbGl6ZWQgKSB7CglqUXVlcnkuZWFjaChbICJocmVmIiwgInNyYyIsICJ3aWR0aCIsICJoZWlnaHQiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJCWpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSA9IGpRdWVyeS5leHRlbmQoIGpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSwgewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIHJldCA9IGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lLCAyICk7CgkJCQlyZXR1cm4gcmV0ID09PSBudWxsID8gdW5kZWZpbmVkIDogcmV0OwoJCQl9CgkJfSk7Cgl9KTsKfQoKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuc3R5bGUgKSB7CglqUXVlcnkuYXR0ckhvb2tzLnN0eWxlID0gewoJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCS8vIFJldHVybiB1bmRlZmluZWQgaW4gdGhlIGNhc2Ugb2YgZW1wdHkgc3RyaW5nCgkJCS8vIE5vcm1hbGl6ZSB0byBsb3dlcmNhc2Ugc2luY2UgSUUgdXBwZXJjYXNlcyBjc3MgcHJvcGVydHkgbmFtZXMKCQkJcmV0dXJuIGVsZW0uc3R5bGUuY3NzVGV4dC50b0xvd2VyQ2FzZSgpIHx8IHVuZGVmaW5lZDsKCQl9LAoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQlyZXR1cm4gKCBlbGVtLnN0eWxlLmNzc1RleHQgPSAiIiArIHZhbHVlICk7CgkJfQoJfTsKfQoKLy8gU2FmYXJpIG1pcy1yZXBvcnRzIHRoZSBkZWZhdWx0IHNlbGVjdGVkIHByb3BlcnR5IG9mIGFuIG9wdGlvbgovLyBBY2Nlc3NpbmcgdGhlIHBhcmVudCdzIHNlbGVjdGVkSW5kZXggcHJvcGVydHkgZml4ZXMgaXQKaWYgKCAhalF1ZXJ5LnN1cHBvcnQub3B0U2VsZWN0ZWQgKSB7CglqUXVlcnkucHJvcEhvb2tzLnNlbGVjdGVkID0galF1ZXJ5LmV4dGVuZCggalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCwgewoJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgoJCQlpZiAoIHBhcmVudCApIHsKCQkJCXBhcmVudC5zZWxlY3RlZEluZGV4OwoKCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IGl0IGFsc28gd29ya3Mgd2l0aCBvcHRncm91cHMsIHNlZSAjNTcwMQoJCQkJaWYgKCBwYXJlbnQucGFyZW50Tm9kZSApIHsKCQkJCQlwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwoJCQkJfQoJCQl9CgkJCXJldHVybiBudWxsOwoJCX0KCX0pOwp9CgovLyBJRTYvNyBjYWxsIGVuY3R5cGUgZW5jb2RpbmcKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuZW5jdHlwZSApIHsKCWpRdWVyeS5wcm9wRml4LmVuY3R5cGUgPSAiZW5jb2RpbmciOwp9CgovLyBSYWRpb3MgYW5kIGNoZWNrYm94ZXMgZ2V0dGVyL3NldHRlcgppZiAoICFqUXVlcnkuc3VwcG9ydC5jaGVja09uICkgewoJalF1ZXJ5LmVhY2goWyAicmFkaW8iLCAiY2hlY2tib3giIF0sIGZ1bmN0aW9uKCkgewoJCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdID0gewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIGluIFdlYmtpdCAiIiBpcyByZXR1cm5lZCBpbnN0ZWFkIG9mICJvbiIgaWYgYSB2YWx1ZSBpc24ndCBzcGVjaWZpZWQKCQkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgidmFsdWUiKSA9PT0gbnVsbCA/ICJvbiIgOiBlbGVtLnZhbHVlOwoJCQl9CgkJfTsKCX0pOwp9CmpRdWVyeS5lYWNoKFsgInJhZGlvIiwgImNoZWNrYm94IiBdLCBmdW5jdGlvbigpIHsKCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdID0galF1ZXJ5LmV4dGVuZCggalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0sIHsKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJaWYgKCBqUXVlcnkuaXNBcnJheSggdmFsdWUgKSApIHsKCQkJCXJldHVybiAoIGVsZW0uY2hlY2tlZCA9IGpRdWVyeS5pbkFycmF5KCBqUXVlcnkoZWxlbSkudmFsKCksIHZhbHVlICkgPj0gMCApOwoJCQl9CgkJfQoJfSk7Cn0pOwp2YXIgcmZvcm1FbGVtcyA9IC9eKD86dGV4dGFyZWF8aW5wdXR8c2VsZWN0KSQvaSwKCXJ0eXBlbmFtZXNwYWNlID0gL14oW15cLl0qfCkoPzpcLiguKyl8KSQvLAoJcmhvdmVySGFjayA9IC8oPzpefFxzKWhvdmVyKFwuXFMrfClcYi8sCglya2V5RXZlbnQgPSAvXmtleS8sCglybW91c2VFdmVudCA9IC9eKD86bW91c2V8Y29udGV4dG1lbnUpfGNsaWNrLywKCXJmb2N1c01vcnBoID0gL14oPzpmb2N1c2luZm9jdXN8Zm9jdXNvdXRibHVyKSQvLAoJaG92ZXJIYWNrID0gZnVuY3Rpb24oIGV2ZW50cyApIHsKCQlyZXR1cm4galF1ZXJ5LmV2ZW50LnNwZWNpYWwuaG92ZXIgPyBldmVudHMgOiBldmVudHMucmVwbGFjZSggcmhvdmVySGFjaywgIm1vdXNlZW50ZXIkMSBtb3VzZWxlYXZlJDEiICk7Cgl9OwoKLyoKICogSGVscGVyIGZ1bmN0aW9ucyBmb3IgbWFuYWdpbmcgZXZlbnRzIC0tIG5vdCBwYXJ0IG9mIHRoZSBwdWJsaWMgaW50ZXJmYWNlLgogKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLgogKi8KalF1ZXJ5LmV2ZW50ID0gewoKCWFkZDogZnVuY3Rpb24oIGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBkYXRhLCBzZWxlY3RvciApIHsKCgkJdmFyIGVsZW1EYXRhLCBldmVudEhhbmRsZSwgZXZlbnRzLAoJCQl0LCB0bnMsIHR5cGUsIG5hbWVzcGFjZXMsIGhhbmRsZU9iaiwKCQkJaGFuZGxlT2JqSW4sIGhhbmRsZXJzLCBzcGVjaWFsOwoKCQkvLyBEb24ndCBhdHRhY2ggZXZlbnRzIHRvIG5vRGF0YSBvciB0ZXh0L2NvbW1lbnQgbm9kZXMgKGFsbG93IHBsYWluIG9iamVjdHMgdGhvKQoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4IHx8ICF0eXBlcyB8fCAhaGFuZGxlciB8fCAhKGVsZW1EYXRhID0galF1ZXJ5Ll9kYXRhKCBlbGVtICkpICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYW4gb2JqZWN0IG9mIGN1c3RvbSBkYXRhIGluIGxpZXUgb2YgdGhlIGhhbmRsZXIKCQlpZiAoIGhhbmRsZXIuaGFuZGxlciApIHsKCQkJaGFuZGxlT2JqSW4gPSBoYW5kbGVyOwoJCQloYW5kbGVyID0gaGFuZGxlT2JqSW4uaGFuZGxlcjsKCQkJc2VsZWN0b3IgPSBoYW5kbGVPYmpJbi5zZWxlY3RvcjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBoYW5kbGVyIGhhcyBhIHVuaXF1ZSBJRCwgdXNlZCB0byBmaW5kL3JlbW92ZSBpdCBsYXRlcgoJCWlmICggIWhhbmRsZXIuZ3VpZCApIHsKCQkJaGFuZGxlci5ndWlkID0galF1ZXJ5Lmd1aWQrKzsKCQl9CgoJCS8vIEluaXQgdGhlIGVsZW1lbnQncyBldmVudCBzdHJ1Y3R1cmUgYW5kIG1haW4gaGFuZGxlciwgaWYgdGhpcyBpcyB0aGUgZmlyc3QKCQlldmVudHMgPSBlbGVtRGF0YS5ldmVudHM7CgkJaWYgKCAhZXZlbnRzICkgewoJCQllbGVtRGF0YS5ldmVudHMgPSBldmVudHMgPSB7fTsKCQl9CgkJZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGU7CgkJaWYgKCAhZXZlbnRIYW5kbGUgKSB7CgkJCWVsZW1EYXRhLmhhbmRsZSA9IGV2ZW50SGFuZGxlID0gZnVuY3Rpb24oIGUgKSB7CgkJCQkvLyBEaXNjYXJkIHRoZSBzZWNvbmQgZXZlbnQgb2YgYSBqUXVlcnkuZXZlbnQudHJpZ2dlcigpIGFuZAoJCQkJLy8gd2hlbiBhbiBldmVudCBpcyBjYWxsZWQgYWZ0ZXIgYSBwYWdlIGhhcyB1bmxvYWRlZAoJCQkJcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT09ICJ1bmRlZmluZWQiICYmICghZSB8fCBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUpID8KCQkJCQlqUXVlcnkuZXZlbnQuZGlzcGF0Y2guYXBwbHkoIGV2ZW50SGFuZGxlLmVsZW0sIGFyZ3VtZW50cyApIDoKCQkJCQl1bmRlZmluZWQ7CgkJCX07CgkJCS8vIEFkZCBlbGVtIGFzIGEgcHJvcGVydHkgb2YgdGhlIGhhbmRsZSBmbiB0byBwcmV2ZW50IGEgbWVtb3J5IGxlYWsgd2l0aCBJRSBub24tbmF0aXZlIGV2ZW50cwoJCQlldmVudEhhbmRsZS5lbGVtID0gZWxlbTsKCQl9CgoJCS8vIEhhbmRsZSBtdWx0aXBsZSBldmVudHMgc2VwYXJhdGVkIGJ5IGEgc3BhY2UKCQkvLyBqUXVlcnkoLi4uKS5iaW5kKCJtb3VzZW92ZXIgbW91c2VvdXQiLCBmbik7CgkJdHlwZXMgPSBqUXVlcnkudHJpbSggaG92ZXJIYWNrKHR5cGVzKSApLnNwbGl0KCAiICIgKTsKCQlmb3IgKCB0ID0gMDsgdCA8IHR5cGVzLmxlbmd0aDsgdCsrICkgewoKCQkJdG5zID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKCQkJdHlwZSA9IHRuc1sxXTsKCQkJbmFtZXNwYWNlcyA9ICggdG5zWzJdIHx8ICIiICkuc3BsaXQoICIuIiApLnNvcnQoKTsKCgkJCS8vIElmIGV2ZW50IGNoYW5nZXMgaXRzIHR5cGUsIHVzZSB0aGUgc3BlY2lhbCBldmVudCBoYW5kbGVycyBmb3IgdGhlIGNoYW5nZWQgdHlwZQoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCgkJCS8vIElmIHNlbGVjdG9yIGRlZmluZWQsIGRldGVybWluZSBzcGVjaWFsIGV2ZW50IGFwaSB0eXBlLCBvdGhlcndpc2UgZ2l2ZW4gdHlwZQoJCQl0eXBlID0gKCBzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSApIHx8IHR5cGU7CgoJCQkvLyBVcGRhdGUgc3BlY2lhbCBiYXNlZCBvbiBuZXdseSByZXNldCB0eXBlCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoKCQkJLy8gaGFuZGxlT2JqIGlzIHBhc3NlZCB0byBhbGwgZXZlbnQgaGFuZGxlcnMKCQkJaGFuZGxlT2JqID0galF1ZXJ5LmV4dGVuZCh7CgkJCQl0eXBlOiB0eXBlLAoJCQkJb3JpZ1R5cGU6IHRuc1sxXSwKCQkJCWRhdGE6IGRhdGEsCgkJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQkJZ3VpZDogaGFuZGxlci5ndWlkLAoJCQkJc2VsZWN0b3I6IHNlbGVjdG9yLAoJCQkJbmFtZXNwYWNlOiBuYW1lc3BhY2VzLmpvaW4oIi4iKQoJCQl9LCBoYW5kbGVPYmpJbiApOwoKCQkJLy8gSW5pdCB0aGUgZXZlbnQgaGFuZGxlciBxdWV1ZSBpZiB3ZSdyZSB0aGUgZmlyc3QKCQkJaGFuZGxlcnMgPSBldmVudHNbIHR5cGUgXTsKCQkJaWYgKCAhaGFuZGxlcnMgKSB7CgkJCQloYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdID0gW107CgkJCQloYW5kbGVycy5kZWxlZ2F0ZUNvdW50ID0gMDsKCgkJCQkvLyBPbmx5IHVzZSBhZGRFdmVudExpc3RlbmVyL2F0dGFjaEV2ZW50IGlmIHRoZSBzcGVjaWFsIGV2ZW50cyBoYW5kbGVyIHJldHVybnMgZmFsc2UKCQkJCWlmICggIXNwZWNpYWwuc2V0dXAgfHwgc3BlY2lhbC5zZXR1cC5jYWxsKCBlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSApID09PSBmYWxzZSApIHsKCQkJCQkvLyBCaW5kIHRoZSBnbG9iYWwgZXZlbnQgaGFuZGxlciB0byB0aGUgZWxlbWVudAoJCQkJCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCQkJCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSApOwoKCQkJCQl9IGVsc2UgaWYgKCBlbGVtLmF0dGFjaEV2ZW50ICkgewoJCQkJCQllbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZXZlbnRIYW5kbGUgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCWlmICggc3BlY2lhbC5hZGQgKSB7CgkJCQlzcGVjaWFsLmFkZC5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsKCgkJCQlpZiAoICFoYW5kbGVPYmouaGFuZGxlci5ndWlkICkgewoJCQkJCWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgPSBoYW5kbGVyLmd1aWQ7CgkJCQl9CgkJCX0KCgkJCS8vIEFkZCB0byB0aGUgZWxlbWVudCdzIGhhbmRsZXIgbGlzdCwgZGVsZWdhdGVzIGluIGZyb250CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQloYW5kbGVycy5zcGxpY2UoIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQrKywgMCwgaGFuZGxlT2JqICk7CgkJCX0gZWxzZSB7CgkJCQloYW5kbGVycy5wdXNoKCBoYW5kbGVPYmogKTsKCQkJfQoKCQkJLy8gS2VlcCB0cmFjayBvZiB3aGljaCBldmVudHMgaGF2ZSBldmVyIGJlZW4gdXNlZCwgZm9yIGV2ZW50IG9wdGltaXphdGlvbgoJCQlqUXVlcnkuZXZlbnQuZ2xvYmFsWyB0eXBlIF0gPSB0cnVlOwoJCX0KCgkJLy8gTnVsbGlmeSBlbGVtIHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzIGluIElFCgkJZWxlbSA9IG51bGw7Cgl9LAoKCWdsb2JhbDoge30sCgoJLy8gRGV0YWNoIGFuIGV2ZW50IG9yIHNldCBvZiBldmVudHMgZnJvbSBhbiBlbGVtZW50CglyZW1vdmU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlcywgaGFuZGxlciwgc2VsZWN0b3IsIG1hcHBlZFR5cGVzICkgewoKCQl2YXIgdCwgdG5zLCB0eXBlLCBvcmlnVHlwZSwgbmFtZXNwYWNlcywgb3JpZ0NvdW50LAoJCQlqLCBldmVudHMsIHNwZWNpYWwsIGV2ZW50VHlwZSwgaGFuZGxlT2JqLAoJCQllbGVtRGF0YSA9IGpRdWVyeS5oYXNEYXRhKCBlbGVtICkgJiYgalF1ZXJ5Ll9kYXRhKCBlbGVtICk7CgoJCWlmICggIWVsZW1EYXRhIHx8ICEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZAoJCXR5cGVzID0galF1ZXJ5LnRyaW0oIGhvdmVySGFjayggdHlwZXMgfHwgIiIgKSApLnNwbGl0KCIgIik7CgkJZm9yICggdCA9IDA7IHQgPCB0eXBlcy5sZW5ndGg7IHQrKyApIHsKCQkJdG5zID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKCQkJdHlwZSA9IG9yaWdUeXBlID0gdG5zWzFdOwoJCQluYW1lc3BhY2VzID0gdG5zWzJdOwoKCQkJLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CgkJCWlmICggIXR5cGUgKSB7CgkJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICsgdHlwZXNbIHQgXSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUgKTsKCQkJCX0KCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQkJdHlwZSA9ICggc2VsZWN0b3I/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSApIHx8IHR5cGU7CgkJCWV2ZW50VHlwZSA9IGV2ZW50c1sgdHlwZSBdIHx8IFtdOwoJCQlvcmlnQ291bnQgPSBldmVudFR5cGUubGVuZ3RoOwoJCQluYW1lc3BhY2VzID0gbmFtZXNwYWNlcyA/IG5ldyBSZWdFeHAoIihefFxcLikiICsgbmFtZXNwYWNlcy5zcGxpdCgiLiIpLnNvcnQoKS5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIpIDogbnVsbDsKCgkJCS8vIFJlbW92ZSBtYXRjaGluZyBldmVudHMKCQkJZm9yICggaiA9IDA7IGogPCBldmVudFR5cGUubGVuZ3RoOyBqKysgKSB7CgkJCQloYW5kbGVPYmogPSBldmVudFR5cGVbIGogXTsKCgkJCQlpZiAoICggbWFwcGVkVHlwZXMgfHwgb3JpZ1R5cGUgPT09IGhhbmRsZU9iai5vcmlnVHlwZSApICYmCgkJCQkJICggIWhhbmRsZXIgfHwgaGFuZGxlci5ndWlkID09PSBoYW5kbGVPYmouZ3VpZCApICYmCgkJCQkJICggIW5hbWVzcGFjZXMgfHwgbmFtZXNwYWNlcy50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSAmJgoJCQkJCSAoICFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gaGFuZGxlT2JqLnNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSAiKioiICYmIGhhbmRsZU9iai5zZWxlY3RvciApICkgewoJCQkJCWV2ZW50VHlwZS5zcGxpY2UoIGotLSwgMSApOwoKCQkJCQlpZiAoIGhhbmRsZU9iai5zZWxlY3RvciApIHsKCQkJCQkJZXZlbnRUeXBlLmRlbGVnYXRlQ291bnQtLTsKCQkJCQl9CgkJCQkJaWYgKCBzcGVjaWFsLnJlbW92ZSApIHsKCQkJCQkJc3BlY2lhbC5yZW1vdmUuY2FsbCggZWxlbSwgaGFuZGxlT2JqICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBSZW1vdmUgZ2VuZXJpYyBldmVudCBoYW5kbGVyIGlmIHdlIHJlbW92ZWQgc29tZXRoaW5nIGFuZCBubyBtb3JlIGhhbmRsZXJzIGV4aXN0CgkJCS8vIChhdm9pZHMgcG90ZW50aWFsIGZvciBlbmRsZXNzIHJlY3Vyc2lvbiBkdXJpbmcgcmVtb3ZhbCBvZiBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzKQoJCQlpZiAoIGV2ZW50VHlwZS5sZW5ndGggPT09IDAgJiYgb3JpZ0NvdW50ICE9PSBldmVudFR5cGUubGVuZ3RoICkgewoJCQkJaWYgKCAhc3BlY2lhbC50ZWFyZG93biB8fCBzcGVjaWFsLnRlYXJkb3duLmNhbGwoIGVsZW0sIG5hbWVzcGFjZXMsIGVsZW1EYXRhLmhhbmRsZSApID09PSBmYWxzZSApIHsKCQkJCQlqUXVlcnkucmVtb3ZlRXZlbnQoIGVsZW0sIHR5cGUsIGVsZW1EYXRhLmhhbmRsZSApOwoJCQkJfQoKCQkJCWRlbGV0ZSBldmVudHNbIHR5cGUgXTsKCQkJfQoJCX0KCgkJLy8gUmVtb3ZlIHRoZSBleHBhbmRvIGlmIGl0J3Mgbm8gbG9uZ2VyIHVzZWQKCQlpZiAoIGpRdWVyeS5pc0VtcHR5T2JqZWN0KCBldmVudHMgKSApIHsKCQkJZGVsZXRlIGVsZW1EYXRhLmhhbmRsZTsKCgkJCS8vIHJlbW92ZURhdGEgYWxzbyBjaGVja3MgZm9yIGVtcHRpbmVzcyBhbmQgY2xlYXJzIHRoZSBleHBhbmRvIGlmIGVtcHR5CgkJCS8vIHNvIHVzZSBpdCBpbnN0ZWFkIG9mIGRlbGV0ZQoJCQlqUXVlcnkucmVtb3ZlRGF0YSggZWxlbSwgImV2ZW50cyIsIHRydWUgKTsKCQl9Cgl9LAoKCS8vIEV2ZW50cyB0aGF0IGFyZSBzYWZlIHRvIHNob3J0LWNpcmN1aXQgaWYgbm8gaGFuZGxlcnMgYXJlIGF0dGFjaGVkLgoJLy8gTmF0aXZlIERPTSBldmVudHMgc2hvdWxkIG5vdCBiZSBhZGRlZCwgdGhleSBtYXkgaGF2ZSBpbmxpbmUgaGFuZGxlcnMuCgljdXN0b21FdmVudDogewoJCSJnZXREYXRhIjogdHJ1ZSwKCQkic2V0RGF0YSI6IHRydWUsCgkJImNoYW5nZURhdGEiOiB0cnVlCgl9LAoKCXRyaWdnZXI6IGZ1bmN0aW9uKCBldmVudCwgZGF0YSwgZWxlbSwgb25seUhhbmRsZXJzICkgewoJCS8vIERvbid0IGRvIGV2ZW50cyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJaWYgKCBlbGVtICYmIChlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDgpICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFdmVudCBvYmplY3Qgb3IgZXZlbnQgdHlwZQoJCXZhciBjYWNoZSwgZXhjbHVzaXZlLCBpLCBjdXIsIG9sZCwgb250eXBlLCBzcGVjaWFsLCBoYW5kbGUsIGV2ZW50UGF0aCwgYnViYmxlVHlwZSwKCQkJdHlwZSA9IGV2ZW50LnR5cGUgfHwgZXZlbnQsCgkJCW5hbWVzcGFjZXMgPSBbXTsKCgkJLy8gZm9jdXMvYmx1ciBtb3JwaHMgdG8gZm9jdXNpbi9vdXQ7IGVuc3VyZSB3ZSdyZSBub3QgZmlyaW5nIHRoZW0gcmlnaHQgbm93CgkJaWYgKCByZm9jdXNNb3JwaC50ZXN0KCB0eXBlICsgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHR5cGUuaW5kZXhPZiggIiEiICkgPj0gMCApIHsKCQkJLy8gRXhjbHVzaXZlIGV2ZW50cyB0cmlnZ2VyIG9ubHkgZm9yIHRoZSBleGFjdCBldmVudCAobm8gbmFtZXNwYWNlcykKCQkJdHlwZSA9IHR5cGUuc2xpY2UoMCwgLTEpOwoJCQlleGNsdXNpdmUgPSB0cnVlOwoJCX0KCgkJaWYgKCB0eXBlLmluZGV4T2YoICIuIiApID49IDAgKSB7CgkJCS8vIE5hbWVzcGFjZWQgdHJpZ2dlcjsgY3JlYXRlIGEgcmVnZXhwIHRvIG1hdGNoIGV2ZW50IHR5cGUgaW4gaGFuZGxlKCkKCQkJbmFtZXNwYWNlcyA9IHR5cGUuc3BsaXQoIi4iKTsKCQkJdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsKCQkJbmFtZXNwYWNlcy5zb3J0KCk7CgkJfQoKCQlpZiAoICghZWxlbSB8fCBqUXVlcnkuZXZlbnQuY3VzdG9tRXZlbnRbIHR5cGUgXSkgJiYgIWpRdWVyeS5ldmVudC5nbG9iYWxbIHR5cGUgXSApIHsKCQkJLy8gTm8galF1ZXJ5IGhhbmRsZXJzIGZvciB0aGlzIGV2ZW50IHR5cGUsIGFuZCBpdCBjYW4ndCBoYXZlIGlubGluZSBoYW5kbGVycwoJCQlyZXR1cm47CgkJfQoKCQkvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYW4gRXZlbnQsIE9iamVjdCwgb3IganVzdCBhbiBldmVudCB0eXBlIHN0cmluZwoJCWV2ZW50ID0gdHlwZW9mIGV2ZW50ID09PSAib2JqZWN0IiA/CgkJCS8vIGpRdWVyeS5FdmVudCBvYmplY3QKCQkJZXZlbnRbIGpRdWVyeS5leHBhbmRvIF0gPyBldmVudCA6CgkJCS8vIE9iamVjdCBsaXRlcmFsCgkJCW5ldyBqUXVlcnkuRXZlbnQoIHR5cGUsIGV2ZW50ICkgOgoJCQkvLyBKdXN0IHRoZSBldmVudCB0eXBlIChzdHJpbmcpCgkJCW5ldyBqUXVlcnkuRXZlbnQoIHR5cGUgKTsKCgkJZXZlbnQudHlwZSA9IHR5cGU7CgkJZXZlbnQuaXNUcmlnZ2VyID0gdHJ1ZTsKCQlldmVudC5leGNsdXNpdmUgPSBleGNsdXNpdmU7CgkJZXZlbnQubmFtZXNwYWNlID0gbmFtZXNwYWNlcy5qb2luKCAiLiIgKTsKCQlldmVudC5uYW1lc3BhY2VfcmUgPSBldmVudC5uYW1lc3BhY2U/IG5ldyBSZWdFeHAoIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIpIDogbnVsbDsKCQlvbnR5cGUgPSB0eXBlLmluZGV4T2YoICI6IiApIDwgMCA/ICJvbiIgKyB0eXBlIDogIiI7CgoJCS8vIEhhbmRsZSBhIGdsb2JhbCB0cmlnZ2VyCgkJaWYgKCAhZWxlbSApIHsKCgkJCS8vIFRPRE86IFN0b3AgdGF1bnRpbmcgdGhlIGRhdGEgY2FjaGU7IHJlbW92ZSBnbG9iYWwgZXZlbnRzIGFuZCBhbHdheXMgYXR0YWNoIHRvIGRvY3VtZW50CgkJCWNhY2hlID0galF1ZXJ5LmNhY2hlOwoJCQlmb3IgKCBpIGluIGNhY2hlICkgewoJCQkJaWYgKCBjYWNoZVsgaSBdLmV2ZW50cyAmJiBjYWNoZVsgaSBdLmV2ZW50c1sgdHlwZSBdICkgewoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCBldmVudCwgZGF0YSwgY2FjaGVbIGkgXS5oYW5kbGUuZWxlbSwgdHJ1ZSApOwoJCQkJfQoJCQl9CgkJCXJldHVybjsKCQl9CgoJCS8vIENsZWFuIHVwIHRoZSBldmVudCBpbiBjYXNlIGl0IGlzIGJlaW5nIHJldXNlZAoJCWV2ZW50LnJlc3VsdCA9IHVuZGVmaW5lZDsKCQlpZiAoICFldmVudC50YXJnZXQgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGVsZW07CgkJfQoKCQkvLyBDbG9uZSBhbnkgaW5jb21pbmcgZGF0YSBhbmQgcHJlcGVuZCB0aGUgZXZlbnQsIGNyZWF0aW5nIHRoZSBoYW5kbGVyIGFyZyBsaXN0CgkJZGF0YSA9IGRhdGEgIT0gbnVsbCA/IGpRdWVyeS5tYWtlQXJyYXkoIGRhdGEgKSA6IFtdOwoJCWRhdGEudW5zaGlmdCggZXZlbnQgKTsKCgkJLy8gQWxsb3cgc3BlY2lhbCBldmVudHMgdG8gZHJhdyBvdXRzaWRlIHRoZSBsaW5lcwoJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoJCWlmICggc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseSggZWxlbSwgZGF0YSApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gRGV0ZXJtaW5lIGV2ZW50IHByb3BhZ2F0aW9uIHBhdGggaW4gYWR2YW5jZSwgcGVyIFczQyBldmVudHMgc3BlYyAoIzk5NTEpCgkJLy8gQnViYmxlIHVwIHRvIGRvY3VtZW50LCB0aGVuIHRvIHdpbmRvdzsgd2F0Y2ggZm9yIGEgZ2xvYmFsIG93bmVyRG9jdW1lbnQgdmFyICgjOTcyNCkKCQlldmVudFBhdGggPSBbWyBlbGVtLCBzcGVjaWFsLmJpbmRUeXBlIHx8IHR5cGUgXV07CgkJaWYgKCAhb25seUhhbmRsZXJzICYmICFzcGVjaWFsLm5vQnViYmxlICYmICFqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsKCgkJCWJ1YmJsZVR5cGUgPSBzcGVjaWFsLmRlbGVnYXRlVHlwZSB8fCB0eXBlOwoJCQljdXIgPSByZm9jdXNNb3JwaC50ZXN0KCBidWJibGVUeXBlICsgdHlwZSApID8gZWxlbSA6IGVsZW0ucGFyZW50Tm9kZTsKCQkJZm9yICggb2xkID0gZWxlbTsgY3VyOyBjdXIgPSBjdXIucGFyZW50Tm9kZSApIHsKCQkJCWV2ZW50UGF0aC5wdXNoKFsgY3VyLCBidWJibGVUeXBlIF0pOwoJCQkJb2xkID0gY3VyOwoJCQl9CgoJCQkvLyBPbmx5IGFkZCB3aW5kb3cgaWYgd2UgZ290IHRvIGRvY3VtZW50IChlLmcuLCBub3QgcGxhaW4gb2JqIG9yIGRldGFjaGVkIERPTSkKCQkJaWYgKCBvbGQgPT09IChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpICkgewoJCQkJZXZlbnRQYXRoLnB1c2goWyBvbGQuZGVmYXVsdFZpZXcgfHwgb2xkLnBhcmVudFdpbmRvdyB8fCB3aW5kb3csIGJ1YmJsZVR5cGUgXSk7CgkJCX0KCQl9CgoJCS8vIEZpcmUgaGFuZGxlcnMgb24gdGhlIGV2ZW50IHBhdGgKCQlmb3IgKCBpID0gMDsgaSA8IGV2ZW50UGF0aC5sZW5ndGggJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCk7IGkrKyApIHsKCgkJCWN1ciA9IGV2ZW50UGF0aFtpXVswXTsKCQkJZXZlbnQudHlwZSA9IGV2ZW50UGF0aFtpXVsxXTsKCgkJCWhhbmRsZSA9ICggalF1ZXJ5Ll9kYXRhKCBjdXIsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdICYmIGpRdWVyeS5fZGF0YSggY3VyLCAiaGFuZGxlIiApOwoJCQlpZiAoIGhhbmRsZSApIHsKCQkJCWhhbmRsZS5hcHBseSggY3VyLCBkYXRhICk7CgkJCX0KCQkJLy8gTm90ZSB0aGF0IHRoaXMgaXMgYSBiYXJlIEpTIGZ1bmN0aW9uIGFuZCBub3QgYSBqUXVlcnkgaGFuZGxlcgoJCQloYW5kbGUgPSBvbnR5cGUgJiYgY3VyWyBvbnR5cGUgXTsKCQkJaWYgKCBoYW5kbGUgJiYgalF1ZXJ5LmFjY2VwdERhdGEoIGN1ciApICYmIGhhbmRsZS5hcHBseSggY3VyLCBkYXRhICkgPT09IGZhbHNlICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX0KCQlldmVudC50eXBlID0gdHlwZTsKCgkJLy8gSWYgbm9ib2R5IHByZXZlbnRlZCB0aGUgZGVmYXVsdCBhY3Rpb24sIGRvIGl0IG5vdwoJCWlmICggIW9ubHlIYW5kbGVycyAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgoJCQlpZiAoICghc3BlY2lhbC5fZGVmYXVsdCB8fCBzcGVjaWFsLl9kZWZhdWx0LmFwcGx5KCBlbGVtLm93bmVyRG9jdW1lbnQsIGRhdGEgKSA9PT0gZmFsc2UpICYmCgkJCQkhKHR5cGUgPT09ICJjbGljayIgJiYgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiYSIgKSkgJiYgalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsKCgkJCQkvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgbmFtZSBhcyB0aGUgZXZlbnQuCgkJCQkvLyBDYW4ndCB1c2UgYW4gLmlzRnVuY3Rpb24oKSBjaGVjayBoZXJlIGJlY2F1c2UgSUU2LzcgZmFpbHMgdGhhdCB0ZXN0LgoJCQkJLy8gRG9uJ3QgZG8gZGVmYXVsdCBhY3Rpb25zIG9uIHdpbmRvdywgdGhhdCdzIHdoZXJlIGdsb2JhbCB2YXJpYWJsZXMgYmUgKCM2MTcwKQoJCQkJLy8gSUU8OSBkaWVzIG9uIGZvY3VzL2JsdXIgdG8gaGlkZGVuIGVsZW1lbnQgKCMxNDg2KQoJCQkJaWYgKCBvbnR5cGUgJiYgZWxlbVsgdHlwZSBdICYmICgodHlwZSAhPT0gImZvY3VzIiAmJiB0eXBlICE9PSAiYmx1ciIpIHx8IGV2ZW50LnRhcmdldC5vZmZzZXRXaWR0aCAhPT0gMCkgJiYgIWpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoKCQkJCQkvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCgkJCQkJb2xkID0gZWxlbVsgb250eXBlIF07CgoJCQkJCWlmICggb2xkICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IG51bGw7CgkJCQkJfQoKCQkJCQkvLyBQcmV2ZW50IHJlLXRyaWdnZXJpbmcgb2YgdGhlIHNhbWUgZXZlbnQsIHNpbmNlIHdlIGFscmVhZHkgYnViYmxlZCBpdCBhYm92ZQoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwoJCQkJCWVsZW1bIHR5cGUgXSgpOwoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CgoJCQkJCWlmICggb2xkICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IG9sZDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBldmVudC5yZXN1bHQ7Cgl9LAoKCWRpc3BhdGNoOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCS8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdAoJCWV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgfHwgd2luZG93LmV2ZW50ICk7CgoJCXZhciBpLCBqLCBjdXIsIGpxY3VyLCByZXQsIHNlbE1hdGNoLCBtYXRjaGVkLCBtYXRjaGVzLCBoYW5kbGVPYmosIHNlbCwgcmVsYXRlZCwKCQkJaGFuZGxlcnMgPSAoIChqUXVlcnkuX2RhdGEoIHRoaXMsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdIHx8IFtdKSwKCQkJZGVsZWdhdGVDb3VudCA9IGhhbmRsZXJzLmRlbGVnYXRlQ291bnQsCgkJCWFyZ3MgPSBbXS5zbGljZS5jYWxsKCBhcmd1bWVudHMgKSwKCQkJcnVuX2FsbCA9ICFldmVudC5leGNsdXNpdmUgJiYgIWV2ZW50Lm5hbWVzcGFjZSwKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyBldmVudC50eXBlIF0gfHwge30sCgkJCWhhbmRsZXJRdWV1ZSA9IFtdOwoKCQkvLyBVc2UgdGhlIGZpeC1lZCBqUXVlcnkuRXZlbnQgcmF0aGVyIHRoYW4gdGhlIChyZWFkLW9ubHkpIG5hdGl2ZSBldmVudAoJCWFyZ3NbMF0gPSBldmVudDsKCQlldmVudC5kZWxlZ2F0ZVRhcmdldCA9IHRoaXM7CgoJCS8vIENhbGwgdGhlIHByZURpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZSwgYW5kIGxldCBpdCBiYWlsIGlmIGRlc2lyZWQKCQlpZiAoIHNwZWNpYWwucHJlRGlzcGF0Y2ggJiYgc3BlY2lhbC5wcmVEaXNwYXRjaC5jYWxsKCB0aGlzLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gRGV0ZXJtaW5lIGhhbmRsZXJzIHRoYXQgc2hvdWxkIHJ1biBpZiB0aGVyZSBhcmUgZGVsZWdhdGVkIGV2ZW50cwoJCS8vIEF2b2lkIG5vbi1sZWZ0LWNsaWNrIGJ1YmJsaW5nIGluIEZpcmVmb3ggKCMzODYxKQoJCWlmICggZGVsZWdhdGVDb3VudCAmJiAhKGV2ZW50LmJ1dHRvbiAmJiBldmVudC50eXBlID09PSAiY2xpY2siKSApIHsKCgkJCS8vIFByZWdlbmVyYXRlIGEgc2luZ2xlIGpRdWVyeSBvYmplY3QgZm9yIHJldXNlIHdpdGggLmlzKCkKCQkJanFjdXIgPSBqUXVlcnkodGhpcyk7CgkJCWpxY3VyLmNvbnRleHQgPSB0aGlzOwoKCQkJZm9yICggY3VyID0gZXZlbnQudGFyZ2V0OyBjdXIgIT0gdGhpczsgY3VyID0gY3VyLnBhcmVudE5vZGUgfHwgdGhpcyApIHsKCgkJCQkvLyBEb24ndCBwcm9jZXNzIGNsaWNrcyAoT05MWSkgb24gZGlzYWJsZWQgZWxlbWVudHMgKCM2OTExLCAjODE2NSwgI3h4eHgpCgkJCQlpZiAoIGN1ci5kaXNhYmxlZCAhPT0gdHJ1ZSB8fCBldmVudC50eXBlICE9PSAiY2xpY2siICkgewoJCQkJCXNlbE1hdGNoID0ge307CgkJCQkJbWF0Y2hlcyA9IFtdOwoJCQkJCWpxY3VyWzBdID0gY3VyOwoJCQkJCWZvciAoIGkgPSAwOyBpIDwgZGVsZWdhdGVDb3VudDsgaSsrICkgewoJCQkJCQloYW5kbGVPYmogPSBoYW5kbGVyc1sgaSBdOwoJCQkJCQlzZWwgPSBoYW5kbGVPYmouc2VsZWN0b3I7CgoJCQkJCQlpZiAoIHNlbE1hdGNoWyBzZWwgXSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkJc2VsTWF0Y2hbIHNlbCBdID0ganFjdXIuaXMoIHNlbCApOwoJCQkJCQl9CgkJCQkJCWlmICggc2VsTWF0Y2hbIHNlbCBdICkgewoJCQkJCQkJbWF0Y2hlcy5wdXNoKCBoYW5kbGVPYmogKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIG1hdGNoZXMubGVuZ3RoICkgewoJCQkJCQloYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IGN1ciwgbWF0Y2hlczogbWF0Y2hlcyB9KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIEFkZCB0aGUgcmVtYWluaW5nIChkaXJlY3RseS1ib3VuZCkgaGFuZGxlcnMKCQlpZiAoIGhhbmRsZXJzLmxlbmd0aCA+IGRlbGVnYXRlQ291bnQgKSB7CgkJCWhhbmRsZXJRdWV1ZS5wdXNoKHsgZWxlbTogdGhpcywgbWF0Y2hlczogaGFuZGxlcnMuc2xpY2UoIGRlbGVnYXRlQ291bnQgKSB9KTsKCQl9CgoJCS8vIFJ1biBkZWxlZ2F0ZXMgZmlyc3Q7IHRoZXkgbWF5IHdhbnQgdG8gc3RvcCBwcm9wYWdhdGlvbiBiZW5lYXRoIHVzCgkJZm9yICggaSA9IDA7IGkgPCBoYW5kbGVyUXVldWUubGVuZ3RoICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpOyBpKysgKSB7CgkJCW1hdGNoZWQgPSBoYW5kbGVyUXVldWVbIGkgXTsKCQkJZXZlbnQuY3VycmVudFRhcmdldCA9IG1hdGNoZWQuZWxlbTsKCgkJCWZvciAoIGogPSAwOyBqIDwgbWF0Y2hlZC5tYXRjaGVzLmxlbmd0aCAmJiAhZXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKTsgaisrICkgewoJCQkJaGFuZGxlT2JqID0gbWF0Y2hlZC5tYXRjaGVzWyBqIF07CgoJCQkJLy8gVHJpZ2dlcmVkIGV2ZW50IG11c3QgZWl0aGVyIDEpIGJlIG5vbi1leGNsdXNpdmUgYW5kIGhhdmUgbm8gbmFtZXNwYWNlLCBvcgoJCQkJLy8gMikgaGF2ZSBuYW1lc3BhY2UocykgYSBzdWJzZXQgb3IgZXF1YWwgdG8gdGhvc2UgaW4gdGhlIGJvdW5kIGV2ZW50IChib3RoIGNhbiBoYXZlIG5vIG5hbWVzcGFjZSkuCgkJCQlpZiAoIHJ1bl9hbGwgfHwgKCFldmVudC5uYW1lc3BhY2UgJiYgIWhhbmRsZU9iai5uYW1lc3BhY2UpIHx8IGV2ZW50Lm5hbWVzcGFjZV9yZSAmJiBldmVudC5uYW1lc3BhY2VfcmUudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgewoKCQkJCQlldmVudC5kYXRhID0gaGFuZGxlT2JqLmRhdGE7CgkJCQkJZXZlbnQuaGFuZGxlT2JqID0gaGFuZGxlT2JqOwoKCQkJCQlyZXQgPSAoIChqUXVlcnkuZXZlbnQuc3BlY2lhbFsgaGFuZGxlT2JqLm9yaWdUeXBlIF0gfHwge30pLmhhbmRsZSB8fCBoYW5kbGVPYmouaGFuZGxlciApCgkJCQkJCQkuYXBwbHkoIG1hdGNoZWQuZWxlbSwgYXJncyApOwoKCQkJCQlpZiAoIHJldCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCQlldmVudC5yZXN1bHQgPSByZXQ7CgkJCQkJCWlmICggcmV0ID09PSBmYWxzZSApIHsKCQkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQoJCWlmICggc3BlY2lhbC5wb3N0RGlzcGF0Y2ggKSB7CgkJCXNwZWNpYWwucG9zdERpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICk7CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCgkvLyBJbmNsdWRlcyBzb21lIGV2ZW50IHByb3BzIHNoYXJlZCBieSBLZXlFdmVudCBhbmQgTW91c2VFdmVudAoJLy8gKioqIGF0dHJDaGFuZ2UgYXR0ck5hbWUgcmVsYXRlZE5vZGUgc3JjRWxlbWVudCAgYXJlIG5vdCBub3JtYWxpemVkLCBub24tVzNDLCBkZXByZWNhdGVkLCB3aWxsIGJlIHJlbW92ZWQgaW4gMS44ICoqKgoJcHJvcHM6ICJhdHRyQ2hhbmdlIGF0dHJOYW1lIHJlbGF0ZWROb2RlIHNyY0VsZW1lbnQgYWx0S2V5IGJ1YmJsZXMgY2FuY2VsYWJsZSBjdHJsS2V5IGN1cnJlbnRUYXJnZXQgZXZlbnRQaGFzZSBtZXRhS2V5IHJlbGF0ZWRUYXJnZXQgc2hpZnRLZXkgdGFyZ2V0IHRpbWVTdGFtcCB2aWV3IHdoaWNoIi5zcGxpdCgiICIpLAoKCWZpeEhvb2tzOiB7fSwKCglrZXlIb29rczogewoJCXByb3BzOiAiY2hhciBjaGFyQ29kZSBrZXkga2V5Q29kZSIuc3BsaXQoIiAiKSwKCQlmaWx0ZXI6IGZ1bmN0aW9uKCBldmVudCwgb3JpZ2luYWwgKSB7CgoJCQkvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKCQkJaWYgKCBldmVudC53aGljaCA9PSBudWxsICkgewoJCQkJZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOwoJCQl9CgoJCQlyZXR1cm4gZXZlbnQ7CgkJfQoJfSwKCgltb3VzZUhvb2tzOiB7CgkJcHJvcHM6ICJidXR0b24gYnV0dG9ucyBjbGllbnRYIGNsaWVudFkgZnJvbUVsZW1lbnQgb2Zmc2V0WCBvZmZzZXRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSB0b0VsZW1lbnQiLnNwbGl0KCIgIiksCgkJZmlsdGVyOiBmdW5jdGlvbiggZXZlbnQsIG9yaWdpbmFsICkgewoJCQl2YXIgZXZlbnREb2MsIGRvYywgYm9keSwKCQkJCWJ1dHRvbiA9IG9yaWdpbmFsLmJ1dHRvbiwKCQkJCWZyb21FbGVtZW50ID0gb3JpZ2luYWwuZnJvbUVsZW1lbnQ7CgoJCQkvLyBDYWxjdWxhdGUgcGFnZVgvWSBpZiBtaXNzaW5nIGFuZCBjbGllbnRYL1kgYXZhaWxhYmxlCgkJCWlmICggZXZlbnQucGFnZVggPT0gbnVsbCAmJiBvcmlnaW5hbC5jbGllbnRYICE9IG51bGwgKSB7CgkJCQlldmVudERvYyA9IGV2ZW50LnRhcmdldC5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50OwoJCQkJZG9jID0gZXZlbnREb2MuZG9jdW1lbnRFbGVtZW50OwoJCQkJYm9keSA9IGV2ZW50RG9jLmJvZHk7CgoJCQkJZXZlbnQucGFnZVggPSBvcmlnaW5hbC5jbGllbnRYICsgKCBkb2MgJiYgZG9jLnNjcm9sbExlZnQgfHwgYm9keSAmJiBib2R5LnNjcm9sbExlZnQgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudExlZnQgfHwgYm9keSAmJiBib2R5LmNsaWVudExlZnQgfHwgMCApOwoJCQkJZXZlbnQucGFnZVkgPSBvcmlnaW5hbC5jbGllbnRZICsgKCBkb2MgJiYgZG9jLnNjcm9sbFRvcCAgfHwgYm9keSAmJiBib2R5LnNjcm9sbFRvcCAgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudFRvcCAgfHwgYm9keSAmJiBib2R5LmNsaWVudFRvcCAgfHwgMCApOwoJCQl9CgoJCQkvLyBBZGQgcmVsYXRlZFRhcmdldCwgaWYgbmVjZXNzYXJ5CgkJCWlmICggIWV2ZW50LnJlbGF0ZWRUYXJnZXQgJiYgZnJvbUVsZW1lbnQgKSB7CgkJCQlldmVudC5yZWxhdGVkVGFyZ2V0ID0gZnJvbUVsZW1lbnQgPT09IGV2ZW50LnRhcmdldCA/IG9yaWdpbmFsLnRvRWxlbWVudCA6IGZyb21FbGVtZW50OwoJCQl9CgoJCQkvLyBBZGQgd2hpY2ggZm9yIGNsaWNrOiAxID09PSBsZWZ0OyAyID09PSBtaWRkbGU7IDMgPT09IHJpZ2h0CgkJCS8vIE5vdGU6IGJ1dHRvbiBpcyBub3Qgbm9ybWFsaXplZCwgc28gZG9uJ3QgdXNlIGl0CgkJCWlmICggIWV2ZW50LndoaWNoICYmIGJ1dHRvbiAhPT0gdW5kZWZpbmVkICkgewoJCQkJZXZlbnQud2hpY2ggPSAoIGJ1dHRvbiAmIDEgPyAxIDogKCBidXR0b24gJiAyID8gMyA6ICggYnV0dG9uICYgNCA/IDIgOiAwICkgKSApOwoJCQl9CgoJCQlyZXR1cm4gZXZlbnQ7CgkJfQoJfSwKCglmaXg6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdICkgewoJCQlyZXR1cm4gZXZlbnQ7CgkJfQoKCQkvLyBDcmVhdGUgYSB3cml0YWJsZSBjb3B5IG9mIHRoZSBldmVudCBvYmplY3QgYW5kIG5vcm1hbGl6ZSBzb21lIHByb3BlcnRpZXMKCQl2YXIgaSwgcHJvcCwKCQkJb3JpZ2luYWxFdmVudCA9IGV2ZW50LAoJCQlmaXhIb29rID0galF1ZXJ5LmV2ZW50LmZpeEhvb2tzWyBldmVudC50eXBlIF0gfHwge30sCgkJCWNvcHkgPSBmaXhIb29rLnByb3BzID8gdGhpcy5wcm9wcy5jb25jYXQoIGZpeEhvb2sucHJvcHMgKSA6IHRoaXMucHJvcHM7CgoJCWV2ZW50ID0galF1ZXJ5LkV2ZW50KCBvcmlnaW5hbEV2ZW50ICk7CgoJCWZvciAoIGkgPSBjb3B5Lmxlbmd0aDsgaTsgKSB7CgkJCXByb3AgPSBjb3B5WyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdpbmFsRXZlbnRbIHByb3AgXTsKCQl9CgoJCS8vIEZpeCB0YXJnZXQgcHJvcGVydHksIGlmIG5lY2Vzc2FyeSAoIzE5MjUsIElFIDYvNy84ICYgU2FmYXJpMikKCQlpZiAoICFldmVudC50YXJnZXQgKSB7CgkJCWV2ZW50LnRhcmdldCA9IG9yaWdpbmFsRXZlbnQuc3JjRWxlbWVudCB8fCBkb2N1bWVudDsKCQl9CgoJCS8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCBTYWZhcmkpCgkJaWYgKCBldmVudC50YXJnZXQubm9kZVR5cGUgPT09IDMgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlOwoJCX0KCgkJLy8gRm9yIG1vdXNlL2tleSBldmVudHMsIG1ldGFLZXk9PWZhbHNlIGlmIGl0J3MgdW5kZWZpbmVkICgjMzM2OCwgIzExMzI4OyBJRTYvNy84KQoJCWV2ZW50Lm1ldGFLZXkgPSAhIWV2ZW50Lm1ldGFLZXk7CgoJCXJldHVybiBmaXhIb29rLmZpbHRlcj8gZml4SG9vay5maWx0ZXIoIGV2ZW50LCBvcmlnaW5hbEV2ZW50ICkgOiBldmVudDsKCX0sCgoJc3BlY2lhbDogewoJCXJlYWR5OiB7CgkJCS8vIE1ha2Ugc3VyZSB0aGUgcmVhZHkgZXZlbnQgaXMgc2V0dXAKCQkJc2V0dXA6IGpRdWVyeS5iaW5kUmVhZHkKCQl9LAoKCQlsb2FkOiB7CgkJCS8vIFByZXZlbnQgdHJpZ2dlcmVkIGltYWdlLmxvYWQgZXZlbnRzIGZyb20gYnViYmxpbmcgdG8gd2luZG93LmxvYWQKCQkJbm9CdWJibGU6IHRydWUKCQl9LAoKCQlmb2N1czogewoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c2luIgoJCX0sCgkJYmx1cjogewoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c291dCIKCQl9LAoKCQliZWZvcmV1bmxvYWQ6IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSApIHsKCQkJCS8vIFdlIG9ubHkgd2FudCB0byBkbyB0aGlzIHNwZWNpYWwgY2FzZSBvbiB3aW5kb3dzCgkJCQlpZiAoIGpRdWVyeS5pc1dpbmRvdyggdGhpcyApICkgewoJCQkJCXRoaXMub25iZWZvcmV1bmxvYWQgPSBldmVudEhhbmRsZTsKCQkJCX0KCQkJfSwKCgkJCXRlYXJkb3duOiBmdW5jdGlvbiggbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUgKSB7CgkJCQlpZiAoIHRoaXMub25iZWZvcmV1bmxvYWQgPT09IGV2ZW50SGFuZGxlICkgewoJCQkJCXRoaXMub25iZWZvcmV1bmxvYWQgPSBudWxsOwoJCQkJfQoJCQl9CgkJfQoJfSwKCglzaW11bGF0ZTogZnVuY3Rpb24oIHR5cGUsIGVsZW0sIGV2ZW50LCBidWJibGUgKSB7CgkJLy8gUGlnZ3liYWNrIG9uIGEgZG9ub3IgZXZlbnQgdG8gc2ltdWxhdGUgYSBkaWZmZXJlbnQgb25lLgoJCS8vIEZha2Ugb3JpZ2luYWxFdmVudCB0byBhdm9pZCBkb25vcidzIHN0b3BQcm9wYWdhdGlvbiwgYnV0IGlmIHRoZQoJCS8vIHNpbXVsYXRlZCBldmVudCBwcmV2ZW50cyBkZWZhdWx0IHRoZW4gd2UgZG8gdGhlIHNhbWUgb24gdGhlIGRvbm9yLgoJCXZhciBlID0galF1ZXJ5LmV4dGVuZCgKCQkJbmV3IGpRdWVyeS5FdmVudCgpLAoJCQlldmVudCwKCQkJeyB0eXBlOiB0eXBlLAoJCQkJaXNTaW11bGF0ZWQ6IHRydWUsCgkJCQlvcmlnaW5hbEV2ZW50OiB7fQoJCQl9CgkJKTsKCQlpZiAoIGJ1YmJsZSApIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIGUsIG51bGwsIGVsZW0gKTsKCQl9IGVsc2UgewoJCQlqUXVlcnkuZXZlbnQuZGlzcGF0Y2guY2FsbCggZWxlbSwgZSApOwoJCX0KCQlpZiAoIGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfQp9OwoKLy8gU29tZSBwbHVnaW5zIGFyZSB1c2luZywgYnV0IGl0J3MgdW5kb2N1bWVudGVkL2RlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZC4KLy8gVGhlIDEuNyBzcGVjaWFsIGV2ZW50IGludGVyZmFjZSBzaG91bGQgcHJvdmlkZSBhbGwgdGhlIGhvb2tzIG5lZWRlZCBub3cuCmpRdWVyeS5ldmVudC5oYW5kbGUgPSBqUXVlcnkuZXZlbnQuZGlzcGF0Y2g7CgpqUXVlcnkucmVtb3ZlRXZlbnQgPSBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyID8KCWZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBoYW5kbGUgKSB7CgkJaWYgKCBlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIgKSB7CgkJCWVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgaGFuZGxlLCBmYWxzZSApOwoJCX0KCX0gOgoJZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGhhbmRsZSApIHsKCQl2YXIgbmFtZSA9ICJvbiIgKyB0eXBlOwoKCQlpZiAoIGVsZW0uZGV0YWNoRXZlbnQgKSB7CgoJCQkvLyAjODU0NSwgIzcwNTQsIHByZXZlbnRpbmcgbWVtb3J5IGxlYWtzIGZvciBjdXN0b20gZXZlbnRzIGluIElFNi04IOKAkwoJCQkvLyBkZXRhY2hFdmVudCBuZWVkZWQgcHJvcGVydHkgb24gZWxlbWVudCwgYnkgbmFtZSBvZiB0aGF0IGV2ZW50LCB0byBwcm9wZXJseSBleHBvc2UgaXQgdG8gR0MKCQkJaWYgKCB0eXBlb2YgZWxlbVsgbmFtZSBdID09PSAidW5kZWZpbmVkIiApIHsKCQkJCWVsZW1bIG5hbWUgXSA9IG51bGw7CgkJCX0KCgkJCWVsZW0uZGV0YWNoRXZlbnQoIG5hbWUsIGhhbmRsZSApOwoJCX0KCX07CgpqUXVlcnkuRXZlbnQgPSBmdW5jdGlvbiggc3JjLCBwcm9wcyApIHsKCS8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAoJaWYgKCAhKHRoaXMgaW5zdGFuY2VvZiBqUXVlcnkuRXZlbnQpICkgewoJCXJldHVybiBuZXcgalF1ZXJ5LkV2ZW50KCBzcmMsIHByb3BzICk7Cgl9CgoJLy8gRXZlbnQgb2JqZWN0CglpZiAoIHNyYyAmJiBzcmMudHlwZSApIHsKCQl0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7CgkJdGhpcy50eXBlID0gc3JjLnR5cGU7CgoJCS8vIEV2ZW50cyBidWJibGluZyB1cCB0aGUgZG9jdW1lbnQgbWF5IGhhdmUgYmVlbiBtYXJrZWQgYXMgcHJldmVudGVkCgkJLy8gYnkgYSBoYW5kbGVyIGxvd2VyIGRvd24gdGhlIHRyZWU7IHJlZmxlY3QgdGhlIGNvcnJlY3QgdmFsdWUuCgkJdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSAoIHNyYy5kZWZhdWx0UHJldmVudGVkIHx8IHNyYy5yZXR1cm5WYWx1ZSA9PT0gZmFsc2UgfHwKCQkJc3JjLmdldFByZXZlbnREZWZhdWx0ICYmIHNyYy5nZXRQcmV2ZW50RGVmYXVsdCgpICkgPyByZXR1cm5UcnVlIDogcmV0dXJuRmFsc2U7CgoJLy8gRXZlbnQgdHlwZQoJfSBlbHNlIHsKCQl0aGlzLnR5cGUgPSBzcmM7Cgl9CgoJLy8gUHV0IGV4cGxpY2l0bHkgcHJvdmlkZWQgcHJvcGVydGllcyBvbnRvIHRoZSBldmVudCBvYmplY3QKCWlmICggcHJvcHMgKSB7CgkJalF1ZXJ5LmV4dGVuZCggdGhpcywgcHJvcHMgKTsKCX0KCgkvLyBDcmVhdGUgYSB0aW1lc3RhbXAgaWYgaW5jb21pbmcgZXZlbnQgZG9lc24ndCBoYXZlIG9uZQoJdGhpcy50aW1lU3RhbXAgPSBzcmMgJiYgc3JjLnRpbWVTdGFtcCB8fCBqUXVlcnkubm93KCk7CgoJLy8gTWFyayBpdCBhcyBmaXhlZAoJdGhpc1sgalF1ZXJ5LmV4cGFuZG8gXSA9IHRydWU7Cn07CgpmdW5jdGlvbiByZXR1cm5GYWxzZSgpIHsKCXJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiByZXR1cm5UcnVlKCkgewoJcmV0dXJuIHRydWU7Cn0KCi8vIGpRdWVyeS5FdmVudCBpcyBiYXNlZCBvbiBET00zIEV2ZW50cyBhcyBzcGVjaWZpZWQgYnkgdGhlIEVDTUFTY3JpcHQgTGFuZ3VhZ2UgQmluZGluZwovLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwKalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSA9IHsKCXByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKCQl0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7CgoJCXZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwoJCWlmICggIWUgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIGlmIHByZXZlbnREZWZhdWx0IGV4aXN0cyBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CgkJaWYgKCBlLnByZXZlbnREZWZhdWx0ICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgoJCS8vIG90aGVyd2lzZSBzZXQgdGhlIHJldHVyblZhbHVlIHByb3BlcnR5IG9mIHRoZSBvcmlnaW5hbCBldmVudCB0byBmYWxzZSAoSUUpCgkJfSBlbHNlIHsKCQkJZS5yZXR1cm5WYWx1ZSA9IGZhbHNlOwoJCX0KCX0sCglzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewoJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoKCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCQlpZiAoICFlICkgewoJCQlyZXR1cm47CgkJfQoJCS8vIGlmIHN0b3BQcm9wYWdhdGlvbiBleGlzdHMgcnVuIGl0IG9uIHRoZSBvcmlnaW5hbCBldmVudAoJCWlmICggZS5zdG9wUHJvcGFnYXRpb24gKSB7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJCS8vIG90aGVyd2lzZSBzZXQgdGhlIGNhbmNlbEJ1YmJsZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gdHJ1ZSAoSUUpCgkJZS5jYW5jZWxCdWJibGUgPSB0cnVlOwoJfSwKCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKCX0sCglpc0RlZmF1bHRQcmV2ZW50ZWQ6IHJldHVybkZhbHNlLAoJaXNQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoJaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlCn07CgovLyBDcmVhdGUgbW91c2VlbnRlci9sZWF2ZSBldmVudHMgdXNpbmcgbW91c2VvdmVyL291dCBhbmQgZXZlbnQtdGltZSBjaGVja3MKalF1ZXJ5LmVhY2goewoJbW91c2VlbnRlcjogIm1vdXNlb3ZlciIsCgltb3VzZWxlYXZlOiAibW91c2VvdXQiCn0sIGZ1bmN0aW9uKCBvcmlnLCBmaXggKSB7CglqUXVlcnkuZXZlbnQuc3BlY2lhbFsgb3JpZyBdID0gewoJCWRlbGVnYXRlVHlwZTogZml4LAoJCWJpbmRUeXBlOiBmaXgsCgoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgcmV0LAoJCQkJdGFyZ2V0ID0gdGhpcywKCQkJCXJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0LAoJCQkJaGFuZGxlT2JqID0gZXZlbnQuaGFuZGxlT2JqLAoJCQkJc2VsZWN0b3IgPSBoYW5kbGVPYmouc2VsZWN0b3I7CgoJCQkvLyBGb3IgbW91c2VudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCgkJCS8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CgkJCWlmICggIXJlbGF0ZWQgfHwgKHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhalF1ZXJ5LmNvbnRhaW5zKCB0YXJnZXQsIHJlbGF0ZWQgKSkgKSB7CgkJCQlldmVudC50eXBlID0gaGFuZGxlT2JqLm9yaWdUeXBlOwoJCQkJcmV0ID0gaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJZXZlbnQudHlwZSA9IGZpeDsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX0KCX07Cn0pOwoKLy8gSUUgc3VibWl0IGRlbGVnYXRpb24KaWYgKCAhalF1ZXJ5LnN1cHBvcnQuc3VibWl0QnViYmxlcyApIHsKCglqUXVlcnkuZXZlbnQuc3BlY2lhbC5zdWJtaXQgPSB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkvLyBPbmx5IG5lZWQgdGhpcyBmb3IgZGVsZWdhdGVkIGZvcm0gc3VibWl0IGV2ZW50cwoJCQlpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgImZvcm0iICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIExhenktYWRkIGEgc3VibWl0IGhhbmRsZXIgd2hlbiBhIGRlc2NlbmRhbnQgZm9ybSBtYXkgcG90ZW50aWFsbHkgYmUgc3VibWl0dGVkCgkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsICJjbGljay5fc3VibWl0IGtleXByZXNzLl9zdWJtaXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCS8vIE5vZGUgbmFtZSBjaGVjayBhdm9pZHMgYSBWTUwtcmVsYXRlZCBjcmFzaCBpbiBJRSAoIzk4MDcpCgkJCQl2YXIgZWxlbSA9IGUudGFyZ2V0LAoJCQkJCWZvcm0gPSBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpbnB1dCIgKSB8fCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJidXR0b24iICkgPyBlbGVtLmZvcm0gOiB1bmRlZmluZWQ7CgkJCQlpZiAoIGZvcm0gJiYgIWpRdWVyeS5fZGF0YSggZm9ybSwgIl9zdWJtaXRfYXR0YWNoZWQiICkgKSB7CgkJCQkJalF1ZXJ5LmV2ZW50LmFkZCggZm9ybSwgInN1Ym1pdC5fc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCQlldmVudC5fc3VibWl0X2J1YmJsZSA9IHRydWU7CgkJCQkJfSk7CgkJCQkJalF1ZXJ5Ll9kYXRhKCBmb3JtLCAiX3N1Ym1pdF9hdHRhY2hlZCIsIHRydWUgKTsKCQkJCX0KCQkJfSk7CgkJCS8vIHJldHVybiB1bmRlZmluZWQgc2luY2Ugd2UgZG9uJ3QgbmVlZCBhbiBldmVudCBsaXN0ZW5lcgoJCX0sCgoJCXBvc3REaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBJZiBmb3JtIHdhcyBzdWJtaXR0ZWQgYnkgdGhlIHVzZXIsIGJ1YmJsZSB0aGUgZXZlbnQgdXAgdGhlIHRyZWUKCQkJaWYgKCBldmVudC5fc3VibWl0X2J1YmJsZSApIHsKCQkJCWRlbGV0ZSBldmVudC5fc3VibWl0X2J1YmJsZTsKCQkJCWlmICggdGhpcy5wYXJlbnROb2RlICYmICFldmVudC5pc1RyaWdnZXIgKSB7CgkJCQkJalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAic3VibWl0IiwgdGhpcy5wYXJlbnROb2RlLCBldmVudCwgdHJ1ZSApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBPbmx5IG5lZWQgdGhpcyBmb3IgZGVsZWdhdGVkIGZvcm0gc3VibWl0IGV2ZW50cwoJCQlpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgImZvcm0iICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIFJlbW92ZSBkZWxlZ2F0ZWQgaGFuZGxlcnM7IGNsZWFuRGF0YSBldmVudHVhbGx5IHJlYXBzIHN1Ym1pdCBoYW5kbGVycyBhdHRhY2hlZCBhYm92ZQoJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCAiLl9zdWJtaXQiICk7CgkJfQoJfTsKfQoKLy8gSUUgY2hhbmdlIGRlbGVnYXRpb24gYW5kIGNoZWNrYm94L3JhZGlvIGZpeAppZiAoICFqUXVlcnkuc3VwcG9ydC5jaGFuZ2VCdWJibGVzICkgewoKCWpRdWVyeS5ldmVudC5zcGVjaWFsLmNoYW5nZSA9IHsKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQkJaWYgKCByZm9ybUVsZW1zLnRlc3QoIHRoaXMubm9kZU5hbWUgKSApIHsKCQkJCS8vIElFIGRvZXNuJ3QgZmlyZSBjaGFuZ2Ugb24gYSBjaGVjay9yYWRpbyB1bnRpbCBibHVyOyB0cmlnZ2VyIGl0IG9uIGNsaWNrCgkJCQkvLyBhZnRlciBhIHByb3BlcnR5Y2hhbmdlLiBFYXQgdGhlIGJsdXItY2hhbmdlIGluIHNwZWNpYWwuY2hhbmdlLmhhbmRsZS4KCQkJCS8vIFRoaXMgc3RpbGwgZmlyZXMgb25jaGFuZ2UgYSBzZWNvbmQgdGltZSBmb3IgY2hlY2svcmFkaW8gYWZ0ZXIgYmx1ci4KCQkJCWlmICggdGhpcy50eXBlID09PSAiY2hlY2tib3giIHx8IHRoaXMudHlwZSA9PT0gInJhZGlvIiApIHsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAicHJvcGVydHljaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50LnByb3BlcnR5TmFtZSA9PT0gImNoZWNrZWQiICkgewoJCQkJCQkJdGhpcy5fanVzdF9jaGFuZ2VkID0gdHJ1ZTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsICJjbGljay5fY2hhbmdlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCQlpZiAoIHRoaXMuX2p1c3RfY2hhbmdlZCAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgewoJCQkJCQkJdGhpcy5fanVzdF9jaGFuZ2VkID0gZmFsc2U7CgkJCQkJCX0KCQkJCQkJLy8gQWxsb3cgdHJpZ2dlcmVkLCBzaW11bGF0ZWQgY2hhbmdlIGV2ZW50cyAoIzExNTAwKQoJCQkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoICJjaGFuZ2UiLCB0aGlzLCBldmVudCwgdHJ1ZSApOwoJCQkJCX0pOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCS8vIERlbGVnYXRlZCBldmVudDsgbGF6eS1hZGQgYSBjaGFuZ2UgaGFuZGxlciBvbiBkZXNjZW5kYW50IGlucHV0cwoJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAiYmVmb3JlYWN0aXZhdGUuX2NoYW5nZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIGVsZW0gPSBlLnRhcmdldDsKCgkJCQlpZiAoIHJmb3JtRWxlbXMudGVzdCggZWxlbS5ub2RlTmFtZSApICYmICFqUXVlcnkuX2RhdGEoIGVsZW0sICJfY2hhbmdlX2F0dGFjaGVkIiApICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIGVsZW0sICJjaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgJiYgIWV2ZW50LmlzU2ltdWxhdGVkICYmICFldmVudC5pc1RyaWdnZXIgKSB7CgkJCQkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoICJjaGFuZ2UiLCB0aGlzLnBhcmVudE5vZGUsIGV2ZW50LCB0cnVlICk7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJfY2hhbmdlX2F0dGFjaGVkIiwgdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGVsZW0gPSBldmVudC50YXJnZXQ7CgoJCQkvLyBTd2FsbG93IG5hdGl2ZSBjaGFuZ2UgZXZlbnRzIGZyb20gY2hlY2tib3gvcmFkaW8sIHdlIGFscmVhZHkgdHJpZ2dlcmVkIHRoZW0gYWJvdmUKCQkJaWYgKCB0aGlzICE9PSBlbGVtIHx8IGV2ZW50LmlzU2ltdWxhdGVkIHx8IGV2ZW50LmlzVHJpZ2dlciB8fCAoZWxlbS50eXBlICE9PSAicmFkaW8iICYmIGVsZW0udHlwZSAhPT0gImNoZWNrYm94IikgKSB7CgkJCQlyZXR1cm4gZXZlbnQuaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCAiLl9jaGFuZ2UiICk7CgoJCQlyZXR1cm4gcmZvcm1FbGVtcy50ZXN0KCB0aGlzLm5vZGVOYW1lICk7CgkJfQoJfTsKfQoKLy8gQ3JlYXRlICJidWJibGluZyIgZm9jdXMgYW5kIGJsdXIgZXZlbnRzCmlmICggIWpRdWVyeS5zdXBwb3J0LmZvY3VzaW5CdWJibGVzICkgewoJalF1ZXJ5LmVhY2goeyBmb2N1czogImZvY3VzaW4iLCBibHVyOiAiZm9jdXNvdXQiIH0sIGZ1bmN0aW9uKCBvcmlnLCBmaXggKSB7CgoJCS8vIEF0dGFjaCBhIHNpbmdsZSBjYXB0dXJpbmcgaGFuZGxlciB3aGlsZSBzb21lb25lIHdhbnRzIGZvY3VzaW4vZm9jdXNvdXQKCQl2YXIgYXR0YWNoZXMgPSAwLAoJCQloYW5kbGVyID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCBmaXgsIGV2ZW50LnRhcmdldCwgalF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgKSwgdHJ1ZSApOwoJCQl9OwoKCQlqUXVlcnkuZXZlbnQuc3BlY2lhbFsgZml4IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCWlmICggYXR0YWNoZXMrKyA9PT0gMCApIHsKCQkJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CgkJCQl9CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCWlmICggLS1hdHRhY2hlcyA9PT0gMCApIHsKCQkJCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CgkJCQl9CgkJCX0KCQl9OwoJfSk7Cn0KCmpRdWVyeS5mbi5leHRlbmQoewoKCW9uOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgLypJTlRFUk5BTCovIG9uZSApIHsKCQl2YXIgb3JpZ0ZuLCB0eXBlOwoKCQkvLyBUeXBlcyBjYW4gYmUgYSBtYXAgb2YgdHlwZXMvaGFuZGxlcnMKCQlpZiAoIHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIgKSB7CgkJCS8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApCgkJCWlmICggdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsgLy8gJiYgc2VsZWN0b3IgIT0gbnVsbAoJCQkJLy8gKCB0eXBlcy1PYmplY3QsIGRhdGEgKQoJCQkJZGF0YSA9IGRhdGEgfHwgc2VsZWN0b3I7CgkJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQkJfQoJCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgewoJCQkJdGhpcy5vbiggdHlwZSwgc2VsZWN0b3IsIGRhdGEsIHR5cGVzWyB0eXBlIF0sIG9uZSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKCBkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCApIHsKCQkJLy8gKCB0eXBlcywgZm4gKQoJCQlmbiA9IHNlbGVjdG9yOwoJCQlkYXRhID0gc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJfSBlbHNlIGlmICggZm4gPT0gbnVsbCApIHsKCQkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewoJCQkJLy8gKCB0eXBlcywgc2VsZWN0b3IsIGZuICkKCQkJCWZuID0gZGF0YTsKCQkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJCX0gZWxzZSB7CgkJCQkvLyAoIHR5cGVzLCBkYXRhLCBmbiApCgkJCQlmbiA9IGRhdGE7CgkJCQlkYXRhID0gc2VsZWN0b3I7CgkJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQkJfQoJCX0KCQlpZiAoIGZuID09PSBmYWxzZSApIHsKCQkJZm4gPSByZXR1cm5GYWxzZTsKCQl9IGVsc2UgaWYgKCAhZm4gKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKCBvbmUgPT09IDEgKSB7CgkJCW9yaWdGbiA9IGZuOwoJCQlmbiA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIENhbiB1c2UgYW4gZW1wdHkgc2V0LCBzaW5jZSBldmVudCBjb250YWlucyB0aGUgaW5mbwoJCQkJalF1ZXJ5KCkub2ZmKCBldmVudCApOwoJCQkJcmV0dXJuIG9yaWdGbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJCS8vIFVzZSBzYW1lIGd1aWQgc28gY2FsbGVyIGNhbiByZW1vdmUgdXNpbmcgb3JpZ0ZuCgkJCWZuLmd1aWQgPSBvcmlnRm4uZ3VpZCB8fCAoIG9yaWdGbi5ndWlkID0galF1ZXJ5Lmd1aWQrKyApOwoJCX0KCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgdHlwZXMsIGZuLCBkYXRhLCBzZWxlY3RvciApOwoJCX0pOwoJfSwKCW9uZTogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIDEgKTsKCX0sCglvZmY6IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGZuICkgewoJCXZhciBoYW5kbGVPYmosIHR5cGU7CgkJaWYgKCB0eXBlcyAmJiB0eXBlcy5wcmV2ZW50RGVmYXVsdCAmJiB0eXBlcy5oYW5kbGVPYmogKSB7CgkJCS8vICggZXZlbnQgKSAgZGlzcGF0Y2hlZCBqUXVlcnkuRXZlbnQKCQkJaGFuZGxlT2JqID0gdHlwZXMuaGFuZGxlT2JqOwoJCQlqUXVlcnkoIHR5cGVzLmRlbGVnYXRlVGFyZ2V0ICkub2ZmKAoJCQkJaGFuZGxlT2JqLm5hbWVzcGFjZSA/IGhhbmRsZU9iai5vcmlnVHlwZSArICIuIiArIGhhbmRsZU9iai5uYW1lc3BhY2UgOiBoYW5kbGVPYmoub3JpZ1R5cGUsCgkJCQloYW5kbGVPYmouc2VsZWN0b3IsCgkJCQloYW5kbGVPYmouaGFuZGxlcgoJCQkpOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKCB0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiICkgewoJCQkvLyAoIHR5cGVzLW9iamVjdCBbLCBzZWxlY3Rvcl0gKQoJCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgewoJCQkJdGhpcy5vZmYoIHR5cGUsIHNlbGVjdG9yLCB0eXBlc1sgdHlwZSBdICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfQoJCWlmICggc2VsZWN0b3IgPT09IGZhbHNlIHx8IHR5cGVvZiBzZWxlY3RvciA9PT0gImZ1bmN0aW9uIiApIHsKCQkJLy8gKCB0eXBlcyBbLCBmbl0gKQoJCQlmbiA9IHNlbGVjdG9yOwoJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQl9CgkJaWYgKCBmbiA9PT0gZmFsc2UgKSB7CgkJCWZuID0gcmV0dXJuRmFsc2U7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIHRoaXMsIHR5cGVzLCBmbiwgc2VsZWN0b3IgKTsKCQl9KTsKCX0sCgoJYmluZDogZnVuY3Rpb24oIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIG51bGwsIGRhdGEsIGZuICk7Cgl9LAoJdW5iaW5kOiBmdW5jdGlvbiggdHlwZXMsIGZuICkgewoJCXJldHVybiB0aGlzLm9mZiggdHlwZXMsIG51bGwsIGZuICk7Cgl9LAoKCWxpdmU6IGZ1bmN0aW9uKCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJalF1ZXJ5KCB0aGlzLmNvbnRleHQgKS5vbiggdHlwZXMsIHRoaXMuc2VsZWN0b3IsIGRhdGEsIGZuICk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoJZGllOiBmdW5jdGlvbiggdHlwZXMsIGZuICkgewoJCWpRdWVyeSggdGhpcy5jb250ZXh0ICkub2ZmKCB0eXBlcywgdGhpcy5zZWxlY3RvciB8fCAiKioiLCBmbiApOwoJCXJldHVybiB0aGlzOwoJfSwKCglkZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKTsKCX0sCgl1bmRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBmbiApIHsKCQkvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT0gMT8gdGhpcy5vZmYoIHNlbGVjdG9yLCAiKioiICkgOiB0aGlzLm9mZiggdHlwZXMsIHNlbGVjdG9yLCBmbiApOwoJfSwKCgl0cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgdGhpcyApOwoJCX0pOwoJfSwKCXRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKCQlpZiAoIHRoaXNbMF0gKSB7CgkJCXJldHVybiBqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgdGhpc1swXSwgdHJ1ZSApOwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbiggZm4gKSB7CgkJLy8gU2F2ZSByZWZlcmVuY2UgdG8gYXJndW1lbnRzIGZvciBhY2Nlc3MgaW4gY2xvc3VyZQoJCXZhciBhcmdzID0gYXJndW1lbnRzLAoJCQlndWlkID0gZm4uZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrLAoJCQlpID0gMCwKCQkJdG9nZ2xlciA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIEZpZ3VyZSBvdXQgd2hpY2ggZnVuY3Rpb24gdG8gZXhlY3V0ZQoJCQkJdmFyIGxhc3RUb2dnbGUgPSAoIGpRdWVyeS5fZGF0YSggdGhpcywgImxhc3RUb2dnbGUiICsgZm4uZ3VpZCApIHx8IDAgKSAlIGk7CgkJCQlqUXVlcnkuX2RhdGEoIHRoaXMsICJsYXN0VG9nZ2xlIiArIGZuLmd1aWQsIGxhc3RUb2dnbGUgKyAxICk7CgoJCQkJLy8gTWFrZSBzdXJlIHRoYXQgY2xpY2tzIHN0b3AKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJLy8gYW5kIGV4ZWN1dGUgdGhlIGZ1bmN0aW9uCgkJCQlyZXR1cm4gYXJnc1sgbGFzdFRvZ2dsZSBdLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSB8fCBmYWxzZTsKCQkJfTsKCgkJLy8gbGluayBhbGwgdGhlIGZ1bmN0aW9ucywgc28gYW55IG9mIHRoZW0gY2FuIHVuYmluZCB0aGlzIGNsaWNrIGhhbmRsZXIKCQl0b2dnbGVyLmd1aWQgPSBndWlkOwoJCXdoaWxlICggaSA8IGFyZ3MubGVuZ3RoICkgewoJCQlhcmdzWyBpKysgXS5ndWlkID0gZ3VpZDsKCQl9CgoJCXJldHVybiB0aGlzLmNsaWNrKCB0b2dnbGVyICk7Cgl9LAoKCWhvdmVyOiBmdW5jdGlvbiggZm5PdmVyLCBmbk91dCApIHsKCQlyZXR1cm4gdGhpcy5tb3VzZWVudGVyKCBmbk92ZXIgKS5tb3VzZWxlYXZlKCBmbk91dCB8fCBmbk92ZXIgKTsKCX0KfSk7CgpqUXVlcnkuZWFjaCggKCJibHVyIGZvY3VzIGZvY3VzaW4gZm9jdXNvdXQgbG9hZCByZXNpemUgc2Nyb2xsIHVubG9hZCBjbGljayBkYmxjbGljayAiICsKCSJtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAiICsKCSJjaGFuZ2Ugc2VsZWN0IHN1Ym1pdCBrZXlkb3duIGtleXByZXNzIGtleXVwIGVycm9yIGNvbnRleHRtZW51Iikuc3BsaXQoIiAiKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJLy8gSGFuZGxlIGV2ZW50IGJpbmRpbmcKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGRhdGEsIGZuICkgewoJCWlmICggZm4gPT0gbnVsbCApIHsKCQkJZm4gPSBkYXRhOwoJCQlkYXRhID0gbnVsbDsKCQl9CgoJCXJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMCA/CgkJCXRoaXMub24oIG5hbWUsIG51bGwsIGRhdGEsIGZuICkgOgoJCQl0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCX07CgoJaWYgKCBya2V5RXZlbnQudGVzdCggbmFtZSApICkgewoJCWpRdWVyeS5ldmVudC5maXhIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV2ZW50LmtleUhvb2tzOwoJfQoKCWlmICggcm1vdXNlRXZlbnQudGVzdCggbmFtZSApICkgewoJCWpRdWVyeS5ldmVudC5maXhIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV2ZW50Lm1vdXNlSG9va3M7Cgl9Cn0pOwovKiEKICogU2l6emxlIENTUyBTZWxlY3RvciBFbmdpbmUKICogIENvcHlyaWdodCAyMDEyLCBUaGUgRG9qbyBGb3VuZGF0aW9uCiAqICBSZWxlYXNlZCB1bmRlciB0aGUgTUlULCBCU0QsIGFuZCBHUEwgTGljZW5zZXMuCiAqICBNb3JlIGluZm9ybWF0aW9uOiBodHRwOi8vc2l6emxlanMuY29tLwogKi8KKGZ1bmN0aW9uKCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCnZhciBjYWNoZWRydW5zLAoJZGlycnVucywKCXNvcnRPcmRlciwKCXNpYmxpbmdDaGVjaywKCWFzc2VydEdldElkTm90TmFtZSwKCglkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKCWRvY0VsZW0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgoJc3RydW5kZWZpbmVkID0gInVuZGVmaW5lZCIsCgloYXNEdXBsaWNhdGUgPSBmYWxzZSwKCWJhc2VIYXNEdXBsaWNhdGUgPSB0cnVlLAoJZG9uZSA9IDAsCglzbGljZSA9IFtdLnNsaWNlLAoJcHVzaCA9IFtdLnB1c2gsCgoJZXhwYW5kbyA9ICggInNpemNhY2hlIiArIE1hdGgucmFuZG9tKCkgKS5yZXBsYWNlKCAiLiIsICIiICksCgoJLy8gUmVnZXgKCgkvLyBXaGl0ZXNwYWNlIGNoYXJhY3RlcnMgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI3doaXRlc3BhY2UKCXdoaXRlc3BhY2UgPSAiW1xceDIwXFx0XFxyXFxuXFxmXSIsCgkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXN5bnRheC8jY2hhcmFjdGVycwoJY2hhcmFjdGVyRW5jb2RpbmcgPSAiKD86XFxcXC58Wy1cXHddfFteXFx4MDAtXFx4YTBdKSsiLAoKCS8vIExvb3NlbHkgbW9kZWxlZCBvbiBDU1MgaWRlbnRpZmllciBjaGFyYWN0ZXJzCgkvLyBBbiB1bnF1b3RlZCB2YWx1ZSBzaG91bGQgYmUgYSBDU1MgaWRlbnRpZmllciAoaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMpCgkvLyBQcm9wZXIgc3ludGF4OiBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9zeW5kYXRhLmh0bWwjdmFsdWUtZGVmLWlkZW50aWZpZXIKCWlkZW50aWZpZXIgPSBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCAidyIsICJ3IyIgKSwKCgkvLyBBY2NlcHRhYmxlIG9wZXJhdG9ycyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMKCW9wZXJhdG9ycyA9ICIoWypeJHwhfl0/PSkiLAoJYXR0cmlidXRlcyA9ICJcXFsiICsgd2hpdGVzcGFjZSArICIqKCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpIiArIHdoaXRlc3BhY2UgKwoJCSIqKD86IiArIG9wZXJhdG9ycyArIHdoaXRlc3BhY2UgKyAiKig/OihbJ1wiXSkoKD86XFxcXC58W15cXFxcXSkqPylcXDN8KCIgKyBpZGVudGlmaWVyICsgIil8KXwpIiArIHdoaXRlc3BhY2UgKyAiKlxcXSIsCglwc2V1ZG9zID0gIjooIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikoPzpcXCgoPzooWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwyfCgoPzpbXixdfFxcXFwsfCg/OiwoPz1bXlxcW10qXFxdKSl8KD86LCg/PVteXFwoXSpcXCkpKSkqKSlcXCl8KSIsCglwb3MgPSAiOihudGh8ZXF8Z3R8bHR8Zmlyc3R8bGFzdHxldmVufG9kZCkoPzpcXCgoXFxkKilcXCl8KSg/PVteLV18JCkiLAoJY29tYmluYXRvcnMgPSB3aGl0ZXNwYWNlICsgIiooW1xceDIwXFx0XFxyXFxuXFxmPit+XSkiICsgd2hpdGVzcGFjZSArICIqIiwKCWdyb3VwcyA9ICIoPz1bXlxceDIwXFx0XFxyXFxuXFxmXSkoPzpcXFxcLnwiICsgYXR0cmlidXRlcyArICJ8IiArIHBzZXVkb3MucmVwbGFjZSggMiwgNyApICsgInxbXlxcXFwoKSxdKSsiLAoKCS8vIExlYWRpbmcgYW5kIG5vbi1lc2NhcGVkIHRyYWlsaW5nIHdoaXRlc3BhY2UsIGNhcHR1cmluZyBzb21lIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMgcHJlY2VkaW5nIHRoZSBsYXR0ZXIKCXJ0cmltID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIrfCgoPzpefFteXFxcXF0pKD86XFxcXC4pKikiICsgd2hpdGVzcGFjZSArICIrJCIsICJnIiApLAoKCXJjb21iaW5hdG9ycyA9IG5ldyBSZWdFeHAoICJeIiArIGNvbWJpbmF0b3JzICksCgoJLy8gQWxsIHNpbXBsZSAobm9uLWNvbW1hKSBzZWxlY3RvcnMsIGV4Y2x1ZGluZyBpbnNpZ25pZmFudCB0cmFpbGluZyB3aGl0ZXNwYWNlCglyZ3JvdXBzID0gbmV3IFJlZ0V4cCggZ3JvdXBzICsgIj8oPz0iICsgd2hpdGVzcGFjZSArICIqLHwkKSIsICJnIiApLAoKCS8vIEEgc2VsZWN0b3IsIG9yIGV2ZXJ5dGhpbmcgYWZ0ZXIgbGVhZGluZyB3aGl0ZXNwYWNlCgkvLyBPcHRpb25hbGx5IGZvbGxvd2VkIGluIGVpdGhlciBjYXNlIGJ5IGEgIikiIGZvciB0ZXJtaW5hdGluZyBzdWItc2VsZWN0b3JzCglyc2VsZWN0b3IgPSBuZXcgUmVnRXhwKCAiXig/Oig/ISwpKD86KD86XnwsKSIgKyB3aGl0ZXNwYWNlICsgIioiICsgZ3JvdXBzICsgIikqP3wiICsgd2hpdGVzcGFjZSArICIqKC4qPykpKFxcKXwkKSIgKSwKCgkvLyBBbGwgY29tYmluYXRvcnMgYW5kIHNlbGVjdG9yIGNvbXBvbmVudHMgKGF0dHJpYnV0ZSB0ZXN0LCB0YWcsIHBzZXVkbywgZXRjLiksIHRoZSBsYXR0ZXIgYXBwZWFyaW5nIHRvZ2V0aGVyIHdoZW4gY29uc2VjdXRpdmUKCXJ0b2tlbnMgPSBuZXcgUmVnRXhwKCBncm91cHMuc2xpY2UoIDE5LCAtNiApICsgIlxceDIwXFx0XFxyXFxuXFxmPit+XSkrfCIgKyBjb21iaW5hdG9ycywgImciICksCgoJLy8gRWFzaWx5LXBhcnNlYWJsZS9yZXRyaWV2YWJsZSBJRCBvciBUQUcgb3IgQ0xBU1Mgc2VsZWN0b3JzCglycXVpY2tFeHByID0gL14oPzojKFtcd1wtXSspfChcdyspfFwuKFtcd1wtXSspKSQvLAoKCXJzaWJsaW5nID0gL1tceDIwXHRcclxuXGZdKlsrfl0vLAoJcmVuZHNXaXRoTm90ID0gLzpub3RcKCQvLAoKCXJoZWFkZXIgPSAvaFxkL2ksCglyaW5wdXRzID0gL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24vaSwKCglyYmFja3NsYXNoID0gL1xcKD8hXFwpL2csCgoJbWF0Y2hFeHByID0gewoJCSJJRCI6IG5ldyBSZWdFeHAoICJeIygiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSIgKSwKCQkiQ0xBU1MiOiBuZXcgUmVnRXhwKCAiXlxcLigiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSIgKSwKCQkiTkFNRSI6IG5ldyBSZWdFeHAoICJeXFxbbmFtZT1bJ1wiXT8oIiArIGNoYXJhY3RlckVuY29kaW5nICsgIilbJ1wiXT9cXF0iICksCgkJIlRBRyI6IG5ldyBSZWdFeHAoICJeKCIgKyBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCAiWy0iLCAiWy1cXCoiICkgKyAiKSIgKSwKCQkiQVRUUiI6IG5ldyBSZWdFeHAoICJeIiArIGF0dHJpYnV0ZXMgKSwKCQkiUFNFVURPIjogbmV3IFJlZ0V4cCggIl4iICsgcHNldWRvcyApLAoJCSJDSElMRCI6IG5ldyBSZWdFeHAoICJeOihvbmx5fG50aHxsYXN0fGZpcnN0KS1jaGlsZCg/OlxcKCIgKyB3aGl0ZXNwYWNlICsKCQkJIiooZXZlbnxvZGR8KChbKy1dfCkoXFxkKilufCkiICsgd2hpdGVzcGFjZSArICIqKD86KFsrLV18KSIgKyB3aGl0ZXNwYWNlICsKCQkJIiooXFxkKyl8KSkiICsgd2hpdGVzcGFjZSArICIqXFwpfCkiLCAiaSIgKSwKCQkiUE9TIjogbmV3IFJlZ0V4cCggcG9zLCAiaWciICksCgkJLy8gRm9yIHVzZSBpbiBsaWJyYXJpZXMgaW1wbGVtZW50aW5nIC5pcygpCgkJIm5lZWRzQ29udGV4dCI6IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKls+K35dfCIgKyBwb3MsICJpIiApCgl9LAoKCWNsYXNzQ2FjaGUgPSB7fSwKCWNhY2hlZENsYXNzZXMgPSBbXSwKCWNvbXBpbGVyQ2FjaGUgPSB7fSwKCWNhY2hlZFNlbGVjdG9ycyA9IFtdLAoKCS8vIE1hcmsgYSBmdW5jdGlvbiBmb3IgdXNlIGluIGZpbHRlcmluZwoJbWFya0Z1bmN0aW9uID0gZnVuY3Rpb24oIGZuICkgewoJCWZuLnNpenpsZUZpbHRlciA9IHRydWU7CgkJcmV0dXJuIGZuOwoJfSwKCgkvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGlucHV0IHR5cGVzCgljcmVhdGVJbnB1dEZ1bmN0aW9uID0gZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBDaGVjayB0aGUgaW5wdXQncyBub2RlTmFtZSBhbmQgdHlwZQoJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKCQl9OwoJfSwKCgkvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGJ1dHRvbnMKCWNyZWF0ZUJ1dHRvbkZ1bmN0aW9uID0gZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiBlbGVtLnR5cGUgPT09IHR5cGU7CgkJfTsKCX0sCgoJLy8gVXNlZCBmb3IgdGVzdGluZyBzb21ldGhpbmcgb24gYW4gZWxlbWVudAoJYXNzZXJ0ID0gZnVuY3Rpb24oIGZuICkgewoJCXZhciBwYXNzID0gZmFsc2UsCgkJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCXRyeSB7CgkJCXBhc3MgPSBmbiggZGl2ICk7CgkJfSBjYXRjaCAoZSkge30KCQkvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQoJCWRpdiA9IG51bGw7CgkJcmV0dXJuIHBhc3M7Cgl9LAoKCS8vIENoZWNrIGlmIGF0dHJpYnV0ZXMgc2hvdWxkIGJlIHJldHJpZXZlZCBieSBhdHRyaWJ1dGUgbm9kZXMKCWFzc2VydEF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuaW5uZXJIVE1MID0gIjxzZWxlY3Q+PC9zZWxlY3Q+IjsKCQl2YXIgdHlwZSA9IHR5cGVvZiBkaXYubGFzdENoaWxkLmdldEF0dHJpYnV0ZSgibXVsdGlwbGUiKTsKCQkvLyBJRTggcmV0dXJucyBhIHN0cmluZyBmb3Igc29tZSBhdHRyaWJ1dGVzIGV2ZW4gd2hlbiBub3QgcHJlc2VudAoJCXJldHVybiB0eXBlICE9PSAiYm9vbGVhbiIgJiYgdHlwZSAhPT0gInN0cmluZyI7Cgl9KSwKCgkvLyBDaGVjayBpZiBnZXRFbGVtZW50QnlJZCByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUKCS8vIENoZWNrIGlmIGdldEVsZW1lbnRzQnlOYW1lIHByaXZpbGVnZXMgZm9ybSBjb250cm9scyBvciByZXR1cm5zIGVsZW1lbnRzIGJ5IElECglhc3NlcnRVc2FibGVOYW1lID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJLy8gSW5qZWN0IGNvbnRlbnQKCQlkaXYuaWQgPSBleHBhbmRvICsgMDsKCQlkaXYuaW5uZXJIVE1MID0gIjxhIG5hbWU9JyIgKyBleHBhbmRvICsgIic+PC9hPjxkaXYgbmFtZT0nIiArIGV4cGFuZG8gKyAiJz48L2Rpdj4iOwoJCWRvY0VsZW0uaW5zZXJ0QmVmb3JlKCBkaXYsIGRvY0VsZW0uZmlyc3RDaGlsZCApOwoKCQkvLyBUZXN0CgkJdmFyIHBhc3MgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSAmJgoJCQkvLyBidWdneSBicm93c2VycyB3aWxsIHJldHVybiBmZXdlciB0aGFuIHRoZSBjb3JyZWN0IDIKCQkJZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoIGV4cGFuZG8gKS5sZW5ndGggPT09CgkJCS8vIGJ1Z2d5IGJyb3dzZXJzIHdpbGwgcmV0dXJuIG1vcmUgdGhhbiB0aGUgY29ycmVjdCAwCgkJCTIgKyBkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyArIDAgKS5sZW5ndGg7CgkJYXNzZXJ0R2V0SWROb3ROYW1lID0gIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBleHBhbmRvICk7CgoJCS8vIENsZWFudXAKCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBkaXYgKTsKCgkJcmV0dXJuIHBhc3M7Cgl9KSwKCgkvLyBDaGVjayBpZiB0aGUgYnJvd3NlciByZXR1cm5zIG9ubHkgZWxlbWVudHMKCS8vIHdoZW4gZG9pbmcgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKQoJYXNzZXJ0VGFnTmFtZU5vQ29tbWVudHMgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpICk7CgkJcmV0dXJuIGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpLmxlbmd0aCA9PT0gMDsKCX0pLAoKCS8vIENoZWNrIGlmIGdldEF0dHJpYnV0ZSByZXR1cm5zIG5vcm1hbGl6ZWQgaHJlZiBhdHRyaWJ1dGVzCglhc3NlcnRIcmVmTm90Tm9ybWFsaXplZCA9IGFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCWRpdi5pbm5lckhUTUwgPSAiPGEgaHJlZj0nIyc+PC9hPiI7CgkJcmV0dXJuIGRpdi5maXJzdENoaWxkICYmIHR5cGVvZiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUgIT09IHN0cnVuZGVmaW5lZCAmJgoJCQlkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIiMiOwoJfSksCgoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYW4gYmUgdHJ1c3RlZAoJYXNzZXJ0VXNhYmxlQ2xhc3NOYW1lID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJLy8gT3BlcmEgY2FuJ3QgZmluZCBhIHNlY29uZCBjbGFzc25hbWUgKGluIDkuNikKCQlkaXYuaW5uZXJIVE1MID0gIjxkaXYgY2xhc3M9J2hpZGRlbiBlJz48L2Rpdj48ZGl2IGNsYXNzPSdoaWRkZW4nPjwvZGl2PiI7CgkJaWYgKCAhZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImUiKS5sZW5ndGggPT09IDAgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIFNhZmFyaSBjYWNoZXMgY2xhc3MgYXR0cmlidXRlcywgZG9lc24ndCBjYXRjaCBjaGFuZ2VzIChpbiAzLjIpCgkJZGl2Lmxhc3RDaGlsZC5jbGFzc05hbWUgPSAiZSI7CgkJcmV0dXJuIGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJlIikubGVuZ3RoICE9PSAxOwoJfSk7Cgp2YXIgU2l6emxlID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICkgewoJcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107Cgljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCXZhciBtYXRjaCwgZWxlbSwgeG1sLCBtLAoJCW5vZGVUeXBlID0gY29udGV4dC5ub2RlVHlwZTsKCglpZiAoIG5vZGVUeXBlICE9PSAxICYmIG5vZGVUeXBlICE9PSA5ICkgewoJCXJldHVybiBbXTsKCX0KCglpZiAoICFzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCXJldHVybiByZXN1bHRzOwoJfQoKCXhtbCA9IGlzWE1MKCBjb250ZXh0ICk7CgoJaWYgKCAheG1sICYmICFzZWVkICkgewoJCWlmICggKG1hdGNoID0gcnF1aWNrRXhwci5leGVjKCBzZWxlY3RvciApKSApIHsKCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiI0lEIikKCQkJaWYgKCAobSA9IG1hdGNoWzFdKSApIHsKCQkJCWlmICggbm9kZVR5cGUgPT09IDkgKSB7CgkJCQkJZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIG0gKTsKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUsIE9wZXJhLCBhbmQgV2Via2l0IHJldHVybiBpdGVtcwoJCQkJCQkvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKCQkJCQkJaWYgKCBlbGVtLmlkID09PSBtICkgewoJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQkJfQoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJLy8gQ29udGV4dCBpcyBub3QgYSBkb2N1bWVudAoJCQkJCWlmICggY29udGV4dC5vd25lckRvY3VtZW50ICYmIChlbGVtID0gY29udGV4dC5vd25lckRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtICkpICYmCgkJCQkJCWNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICkgJiYgZWxlbS5pZCA9PT0gbSApIHsKCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCQkJCX0KCgkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoIlRBRyIpCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzJdICkgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2xpY2UuY2FsbChjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCBzZWxlY3RvciApLCAwKSApOwoJCQkJcmV0dXJuIHJlc3VsdHM7CgoJCQkvLyBTcGVlZC11cDogU2l6emxlKCIuQ0xBU1MiKQoJCQl9IGVsc2UgaWYgKCAobSA9IG1hdGNoWzNdKSAmJiBhc3NlcnRVc2FibGVDbGFzc05hbWUgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICkgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2xpY2UuY2FsbChjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIG0gKSwgMCkgKTsKCQkJCXJldHVybiByZXN1bHRzOwoJCQl9CgkJfQoJfQoKCS8vIEFsbCBvdGhlcnMKCXJldHVybiBzZWxlY3QoIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkLCB4bWwgKTsKfTsKCnZhciBFeHByID0gU2l6emxlLnNlbGVjdG9ycyA9IHsKCgkvLyBDYW4gYmUgYWRqdXN0ZWQgYnkgdGhlIHVzZXIKCWNhY2hlTGVuZ3RoOiA1MCwKCgltYXRjaDogbWF0Y2hFeHByLAoKCW9yZGVyOiBbICJJRCIsICJUQUciIF0sCgoJYXR0ckhhbmRsZToge30sCgoJY3JlYXRlUHNldWRvOiBtYXJrRnVuY3Rpb24sCgoJZmluZDogewoJCSJJRCI6IGFzc2VydEdldElkTm90TmFtZSA/CgkJCWZ1bmN0aW9uKCBpZCwgY29udGV4dCwgeG1sICkgewoJCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gc3RydW5kZWZpbmVkICYmICF4bWwgKSB7CgkJCQkJdmFyIG0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKCBpZCApOwoJCQkJCS8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCgkJCQkJLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwoJCQkJCXJldHVybiBtICYmIG0ucGFyZW50Tm9kZSA/IFttXSA6IFtdOwoJCQkJfQoJCQl9IDoKCQkJZnVuY3Rpb24oIGlkLCBjb250ZXh0LCB4bWwgKSB7CgkJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSBzdHJ1bmRlZmluZWQgJiYgIXhtbCApIHsKCQkJCQl2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7CgoJCQkJCXJldHVybiBtID8KCQkJCQkJbS5pZCA9PT0gaWQgfHwgdHlwZW9mIG0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gc3RydW5kZWZpbmVkICYmIG0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKS52YWx1ZSA9PT0gaWQgPwoJCQkJCQkJW21dIDoKCQkJCQkJCXVuZGVmaW5lZCA6CgkJCQkJCVtdOwoJCQkJfQoJCQl9LAoKCQkiVEFHIjogYXNzZXJ0VGFnTmFtZU5vQ29tbWVudHMgPwoJCQlmdW5jdGlvbiggdGFnLCBjb250ZXh0ICkgewoJCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gc3RydW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKTsKCQkJCX0KCQkJfSA6CgkJCWZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CgkJCQl2YXIgcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoKCQkJCS8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMKCQkJCWlmICggdGFnID09PSAiKiIgKSB7CgkJCQkJdmFyIGVsZW0sCgkJCQkJCXRtcCA9IFtdLAoJCQkJCQlpID0gMDsKCgkJCQkJZm9yICggOyAoZWxlbSA9IHJlc3VsdHNbaV0pOyBpKysgKSB7CgkJCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJCXRtcC5wdXNoKCBlbGVtICk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXJldHVybiB0bXA7CgkJCQl9CgkJCQlyZXR1cm4gcmVzdWx0czsKCQkJfQoJfSwKCglyZWxhdGl2ZTogewoJCSI+IjogeyBkaXI6ICJwYXJlbnROb2RlIiwgZmlyc3Q6IHRydWUgfSwKCQkiICI6IHsgZGlyOiAicGFyZW50Tm9kZSIgfSwKCQkiKyI6IHsgZGlyOiAicHJldmlvdXNTaWJsaW5nIiwgZmlyc3Q6IHRydWUgfSwKCQkifiI6IHsgZGlyOiAicHJldmlvdXNTaWJsaW5nIiB9Cgl9LAoKCXByZUZpbHRlcjogewoJCSJBVFRSIjogZnVuY3Rpb24oIG1hdGNoICkgewoJCQltYXRjaFsxXSA9IG1hdGNoWzFdLnJlcGxhY2UoIHJiYWNrc2xhc2gsICIiICk7CgoJCQkvLyBNb3ZlIHRoZSBnaXZlbiB2YWx1ZSB0byBtYXRjaFszXSB3aGV0aGVyIHF1b3RlZCBvciB1bnF1b3RlZAoJCQltYXRjaFszXSA9ICggbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgIiIgKS5yZXBsYWNlKCByYmFja3NsYXNoLCAiIiApOwoKCQkJaWYgKCBtYXRjaFsyXSA9PT0gIn49IiApIHsKCQkJCW1hdGNoWzNdID0gIiAiICsgbWF0Y2hbM10gKyAiICI7CgkJCX0KCgkJCXJldHVybiBtYXRjaC5zbGljZSggMCwgNCApOwoJCX0sCgoJCSJDSElMRCI6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJLyogbWF0Y2hlcyBmcm9tIG1hdGNoRXhwci5DSElMRAoJCQkJMSB0eXBlIChvbmx5fG50aHwuLi4pCgkJCQkyIGFyZ3VtZW50IChldmVufG9kZHxcZCp8XGQqbihbKy1dXGQrKT98Li4uKQoJCQkJMyB4bi1jb21wb25lbnQgb2YgeG4reSBhcmd1bWVudCAoWystXT9cZCpufCkKCQkJCTQgc2lnbiBvZiB4bi1jb21wb25lbnQKCQkJCTUgeCBvZiB4bi1jb21wb25lbnQKCQkJCTYgc2lnbiBvZiB5LWNvbXBvbmVudAoJCQkJNyB5IG9mIHktY29tcG9uZW50CgkJCSovCgkJCW1hdGNoWzFdID0gbWF0Y2hbMV0udG9Mb3dlckNhc2UoKTsKCgkJCWlmICggbWF0Y2hbMV0gPT09ICJudGgiICkgewoJCQkJLy8gbnRoLWNoaWxkIHJlcXVpcmVzIGFyZ3VtZW50CgkJCQlpZiAoICFtYXRjaFsyXSApIHsKCQkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CgkJCQl9CgoJCQkJLy8gbnVtZXJpYyB4IGFuZCB5IHBhcmFtZXRlcnMgZm9yIEV4cHIuZmlsdGVyLkNISUxECgkJCQkvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCgkJCQltYXRjaFszXSA9ICsoIG1hdGNoWzNdID8gbWF0Y2hbNF0gKyAobWF0Y2hbNV0gfHwgMSkgOiAyICogKCBtYXRjaFsyXSA9PT0gImV2ZW4iIHx8IG1hdGNoWzJdID09PSAib2RkIiApICk7CgkJCQltYXRjaFs0XSA9ICsoICggbWF0Y2hbNl0gKyBtYXRjaFs3XSApIHx8IG1hdGNoWzJdID09PSAib2RkIiApOwoKCQkJLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzJdICkgewoJCQkJU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwoJCQl9CgoJCQlyZXR1cm4gbWF0Y2g7CgkJfSwKCgkJIlBTRVVETyI6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJdmFyIGFyZ3VtZW50LAoJCQkJdW5xdW90ZWQgPSBtYXRjaFs0XTsKCgkJCWlmICggbWF0Y2hFeHByWyJDSElMRCJdLnRlc3QoIG1hdGNoWzBdICkgKSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoKCQkJLy8gUmVsaW5xdWlzaCBvdXIgY2xhaW0gb24gY2hhcmFjdGVycyBpbiBgdW5xdW90ZWRgIGZyb20gYSBjbG9zaW5nIHBhcmVudGhlc2lzIG9uCgkJCWlmICggdW5xdW90ZWQgJiYgKGFyZ3VtZW50ID0gcnNlbGVjdG9yLmV4ZWMoIHVucXVvdGVkICkpICYmIGFyZ3VtZW50LnBvcCgpICkgewoKCQkJCW1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoIDAsIGFyZ3VtZW50WzBdLmxlbmd0aCAtIHVucXVvdGVkLmxlbmd0aCAtIDEgKTsKCQkJCXVucXVvdGVkID0gYXJndW1lbnRbMF0uc2xpY2UoIDAsIC0xICk7CgkJCX0KCgkJCS8vIFF1b3RlZCBvciB1bnF1b3RlZCwgd2UgaGF2ZSB0aGUgZnVsbCBhcmd1bWVudAoJCQkvLyBSZXR1cm4gb25seSBjYXB0dXJlcyBuZWVkZWQgYnkgdGhlIHBzZXVkbyBmaWx0ZXIgbWV0aG9kICh0eXBlIGFuZCBhcmd1bWVudCkKCQkJbWF0Y2guc3BsaWNlKCAyLCAzLCB1bnF1b3RlZCB8fCBtYXRjaFszXSApOwoJCQlyZXR1cm4gbWF0Y2g7CgkJfQoJfSwKCglmaWx0ZXI6IHsKCQkiSUQiOiBhc3NlcnRHZXRJZE5vdE5hbWUgPwoJCQlmdW5jdGlvbiggaWQgKSB7CgkJCQlpZCA9IGlkLnJlcGxhY2UoIHJiYWNrc2xhc2gsICIiICk7CgkJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJpZCIpID09PSBpZDsKCQkJCX07CgkJCX0gOgoJCQlmdW5jdGlvbiggaWQgKSB7CgkJCQlpZCA9IGlkLnJlcGxhY2UoIHJiYWNrc2xhc2gsICIiICk7CgkJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwoJCQkJCXJldHVybiBub2RlICYmIG5vZGUudmFsdWUgPT09IGlkOwoJCQkJfTsKCQkJfSwKCgkJIlRBRyI6IGZ1bmN0aW9uKCBub2RlTmFtZSApIHsKCQkJaWYgKCBub2RlTmFtZSA9PT0gIioiICkgewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfTsKCQkJfQoJCQlub2RlTmFtZSA9IG5vZGVOYW1lLnJlcGxhY2UoIHJiYWNrc2xhc2gsICIiICkudG9Mb3dlckNhc2UoKTsKCgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZU5hbWU7CgkJCX07CgkJfSwKCgkJIkNMQVNTIjogZnVuY3Rpb24oIGNsYXNzTmFtZSApIHsKCQkJdmFyIHBhdHRlcm4gPSBjbGFzc0NhY2hlWyBjbGFzc05hbWUgXTsKCQkJaWYgKCAhcGF0dGVybiApIHsKCQkJCXBhdHRlcm4gPSBjbGFzc0NhY2hlWyBjbGFzc05hbWUgXSA9IG5ldyBSZWdFeHAoICIoXnwiICsgd2hpdGVzcGFjZSArICIpIiArIGNsYXNzTmFtZSArICIoIiArIHdoaXRlc3BhY2UgKyAifCQpIiApOwoJCQkJY2FjaGVkQ2xhc3Nlcy5wdXNoKCBjbGFzc05hbWUgKTsKCQkJCS8vIEF2b2lkIHRvbyBsYXJnZSBvZiBhIGNhY2hlCgkJCQlpZiAoIGNhY2hlZENsYXNzZXMubGVuZ3RoID4gRXhwci5jYWNoZUxlbmd0aCApIHsKCQkJCQlkZWxldGUgY2xhc3NDYWNoZVsgY2FjaGVkQ2xhc3Nlcy5zaGlmdCgpIF07CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIHBhdHRlcm4udGVzdCggZWxlbS5jbGFzc05hbWUgfHwgKHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSAhPT0gc3RydW5kZWZpbmVkICYmIGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzcyIpKSB8fCAiIiApOwoJCQl9OwoJCX0sCgoJCSJBVFRSIjogZnVuY3Rpb24oIG5hbWUsIG9wZXJhdG9yLCBjaGVjayApIHsKCQkJaWYgKCAhb3BlcmF0b3IgKSB7CgkJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJcmV0dXJuIFNpenpsZS5hdHRyKCBlbGVtLCBuYW1lICkgIT0gbnVsbDsKCQkJCX07CgkJCX0KCgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciByZXN1bHQgPSBTaXp6bGUuYXR0ciggZWxlbSwgbmFtZSApLAoJCQkJCXZhbHVlID0gcmVzdWx0ICsgIiI7CgoJCQkJaWYgKCByZXN1bHQgPT0gbnVsbCApIHsKCQkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICIhPSI7CgkJCQl9CgoJCQkJc3dpdGNoICggb3BlcmF0b3IgKSB7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCXJldHVybiB2YWx1ZSA9PT0gY2hlY2s7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQlyZXR1cm4gdmFsdWUgIT09IGNoZWNrOwoJCQkJCWNhc2UgIl49IjoKCQkJCQkJcmV0dXJuIGNoZWNrICYmIHZhbHVlLmluZGV4T2YoIGNoZWNrICkgPT09IDA7CgkJCQkJY2FzZSAiKj0iOgoJCQkJCQlyZXR1cm4gY2hlY2sgJiYgdmFsdWUuaW5kZXhPZiggY2hlY2sgKSA+IC0xOwoJCQkJCWNhc2UgIiQ9IjoKCQkJCQkJcmV0dXJuIGNoZWNrICYmIHZhbHVlLnN1YnN0ciggdmFsdWUubGVuZ3RoIC0gY2hlY2subGVuZ3RoICkgPT09IGNoZWNrOwoJCQkJCWNhc2UgIn49IjoKCQkJCQkJcmV0dXJuICggIiAiICsgdmFsdWUgKyAiICIgKS5pbmRleE9mKCBjaGVjayApID4gLTE7CgkJCQkJY2FzZSAifD0iOgoJCQkJCQlyZXR1cm4gdmFsdWUgPT09IGNoZWNrIHx8IHZhbHVlLnN1YnN0ciggMCwgY2hlY2subGVuZ3RoICsgMSApID09PSBjaGVjayArICItIjsKCQkJCX0KCQkJfTsKCQl9LAoKCQkiQ0hJTEQiOiBmdW5jdGlvbiggdHlwZSwgYXJndW1lbnQsIGZpcnN0LCBsYXN0ICkgewoKCQkJaWYgKCB0eXBlID09PSAibnRoIiApIHsKCQkJCXZhciBkb25lTmFtZSA9IGRvbmUrKzsKCgkJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJdmFyIHBhcmVudCwgZGlmZiwKCQkJCQkJY291bnQgPSAwLAoJCQkJCQlub2RlID0gZWxlbTsKCgkJCQkJaWYgKCBmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgoJCQkJCXBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCgkJCQkJaWYgKCBwYXJlbnQgJiYgKHBhcmVudFsgZXhwYW5kbyBdICE9PSBkb25lTmFtZSB8fCAhZWxlbS5zaXpzZXQpICkgewoJCQkJCQlmb3IgKCBub2RlID0gcGFyZW50LmZpcnN0Q2hpbGQ7IG5vZGU7IG5vZGUgPSBub2RlLm5leHRTaWJsaW5nICkgewoJCQkJCQkJaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJCW5vZGUuc2l6c2V0ID0gKytjb3VudDsKCQkJCQkJCQlpZiAoIG5vZGUgPT09IGVsZW0gKSB7CgkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJcGFyZW50WyBleHBhbmRvIF0gPSBkb25lTmFtZTsKCQkJCQl9CgoJCQkJCWRpZmYgPSBlbGVtLnNpenNldCAtIGxhc3Q7CgoJCQkJCWlmICggZmlyc3QgPT09IDAgKSB7CgkJCQkJCXJldHVybiBkaWZmID09PSAwOwoKCQkJCQl9IGVsc2UgewoJCQkJCQlyZXR1cm4gKCBkaWZmICUgZmlyc3QgPT09IDAgJiYgZGlmZiAvIGZpcnN0ID49IDAgKTsKCQkJCQl9CgkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgbm9kZSA9IGVsZW07CgoJCQkJc3dpdGNoICggdHlwZSApIHsKCQkJCQljYXNlICJvbmx5IjoKCQkJCQljYXNlICJmaXJzdCI6CgkJCQkJCXdoaWxlICggKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykgKSB7CgkJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQlpZiAoIHR5cGUgPT09ICJmaXJzdCIgKSB7CgkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJfQoKCQkJCQkJbm9kZSA9IGVsZW07CgoJCQkJCQkvKiBmYWxscyB0aHJvdWdoICovCgkJCQkJY2FzZSAibGFzdCI6CgkJCQkJCXdoaWxlICggKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSApIHsKCQkJCQkJCWlmICggbm9kZS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQl9OwoJCX0sCgoJCSJQU0VVRE8iOiBmdW5jdGlvbiggcHNldWRvLCBhcmd1bWVudCwgY29udGV4dCwgeG1sICkgewoJCQkvLyBwc2V1ZG8tY2xhc3MgbmFtZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNwc2V1ZG8tY2xhc3NlcwoJCQkvLyBQcmlvcml0aXplIGJ5IGNhc2Ugc2Vuc2l0aXZpdHkgaW4gY2FzZSBjdXN0b20gcHNldWRvcyBhcmUgYWRkZWQgd2l0aCB1cHBlcmNhc2UgbGV0dGVycwoJCQl2YXIgZm4gPSBFeHByLnBzZXVkb3NbIHBzZXVkbyBdIHx8IEV4cHIucHNldWRvc1sgcHNldWRvLnRvTG93ZXJDYXNlKCkgXTsKCgkJCWlmICggIWZuICkgewoJCQkJU2l6emxlLmVycm9yKCAidW5zdXBwb3J0ZWQgcHNldWRvOiAiICsgcHNldWRvICk7CgkJCX0KCgkJCS8vIFRoZSB1c2VyIG1heSBzZXQgZm4uc2l6emxlRmlsdGVyIHRvIGluZGljYXRlCgkJCS8vIHRoYXQgYXJndW1lbnRzIGFyZSBuZWVkZWQgdG8gY3JlYXRlIHRoZSBmaWx0ZXIgZnVuY3Rpb24KCQkJLy8ganVzdCBhcyBTaXp6bGUgZG9lcwoJCQlpZiAoICFmbi5zaXp6bGVGaWx0ZXIgKSB7CgkJCQlyZXR1cm4gZm47CgkJCX0KCgkJCXJldHVybiBmbiggYXJndW1lbnQsIGNvbnRleHQsIHhtbCApOwoJCX0KCX0sCgoJcHNldWRvczogewoJCSJub3QiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCB4bWwgKSB7CgkJCS8vIFRyaW0gdGhlIHNlbGVjdG9yIHBhc3NlZCB0byBjb21waWxlCgkJCS8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCgkJCS8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwoJCQl2YXIgbWF0Y2hlciA9IGNvbXBpbGUoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksIGNvbnRleHQsIHhtbCApOwoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gIW1hdGNoZXIoIGVsZW0gKTsKCQkJfTsKCQl9KSwKCgkJImVuYWJsZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IGZhbHNlOwoJCX0sCgoJCSJkaXNhYmxlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gdHJ1ZTsKCQl9LAoKCQkiY2hlY2tlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBJbiBDU1MzLCA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIGJvdGggY2hlY2tlZCBhbmQgc2VsZWN0ZWQgZWxlbWVudHMKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKCQkJdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gKG5vZGVOYW1lID09PSAiaW5wdXQiICYmICEhZWxlbS5jaGVja2VkKSB8fCAobm9kZU5hbWUgPT09ICJvcHRpb24iICYmICEhZWxlbS5zZWxlY3RlZCk7CgkJfSwKCgkJInNlbGVjdGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCS8vIEFjY2Vzc2luZyB0aGlzIHByb3BlcnR5IG1ha2VzIHNlbGVjdGVkLWJ5LWRlZmF1bHQKCQkJLy8gb3B0aW9ucyBpbiBTYWZhcmkgd29yayBwcm9wZXJseQoJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCWVsZW0ucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwoJCQl9CgoJCQlyZXR1cm4gZWxlbS5zZWxlY3RlZCA9PT0gdHJ1ZTsKCQl9LAoKCQkicGFyZW50IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiAhRXhwci5wc2V1ZG9zWyJlbXB0eSJdKCBlbGVtICk7CgkJfSwKCgkJImVtcHR5IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jZW1wdHktcHNldWRvCgkJCS8vIDplbXB0eSBpcyBvbmx5IGFmZmVjdGVkIGJ5IGVsZW1lbnQgbm9kZXMgYW5kIGNvbnRlbnQgbm9kZXMoaW5jbHVkaW5nIHRleHQoMyksIGNkYXRhKDQpKSwKCQkJLy8gICBub3QgY29tbWVudCwgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbnMsIG9yIG90aGVycwoJCQkvLyBUaGFua3MgdG8gRGllZ28gUGVyaW5pIGZvciB0aGUgbm9kZU5hbWUgc2hvcnRjdXQKCQkJLy8gICBHcmVhdGVyIHRoYW4gIkAiIG1lYW5zIGFscGhhIGNoYXJhY3RlcnMgKHNwZWNpZmljYWxseSBub3Qgc3RhcnRpbmcgd2l0aCAiIyIgb3IgIj8iKQoJCQl2YXIgbm9kZVR5cGU7CgkJCWVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7CgkJCXdoaWxlICggZWxlbSApIHsKCQkJCWlmICggZWxlbS5ub2RlTmFtZSA+ICJAIiB8fCAobm9kZVR5cGUgPSBlbGVtLm5vZGVUeXBlKSA9PT0gMyB8fCBub2RlVHlwZSA9PT0gNCApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCQllbGVtID0gZWxlbS5uZXh0U2libGluZzsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoKCQkiY29udGFpbnMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiAoIGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lclRleHQgfHwgZ2V0VGV4dCggZWxlbSApICkuaW5kZXhPZiggdGV4dCApID4gLTE7CgkJCX07CgkJfSksCgoJCSJoYXMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gU2l6emxlKCBzZWxlY3RvciwgZWxlbSApLmxlbmd0aCA+IDA7CgkJCX07CgkJfSksCgoJCSJoZWFkZXIiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIHJoZWFkZXIudGVzdCggZWxlbS5ub2RlTmFtZSApOwoJCX0sCgoJCSJ0ZXh0IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciB0eXBlLCBhdHRyOwoJCQkvLyBJRTYgYW5kIDcgd2lsbCBtYXAgZWxlbS50eXBlIHRvICd0ZXh0JyBmb3IgbmV3IEhUTUw1IHR5cGVzIChzZWFyY2gsIGV0YykKCQkJLy8gdXNlIGdldEF0dHJpYnV0ZSBpbnN0ZWFkIHRvIHRlc3QgdGhpcyBjYXNlCgkJCXJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYKCQkJCSh0eXBlID0gZWxlbS50eXBlKSA9PT0gInRleHQiICYmCgkJCQkoIChhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSkgPT0gbnVsbCB8fCBhdHRyLnRvTG93ZXJDYXNlKCkgPT09IHR5cGUgKTsKCQl9LAoKCQkvLyBJbnB1dCB0eXBlcwoJCSJyYWRpbyI6IGNyZWF0ZUlucHV0RnVuY3Rpb24oInJhZGlvIiksCgkJImNoZWNrYm94IjogY3JlYXRlSW5wdXRGdW5jdGlvbigiY2hlY2tib3giKSwKCQkiZmlsZSI6IGNyZWF0ZUlucHV0RnVuY3Rpb24oImZpbGUiKSwKCQkicGFzc3dvcmQiOiBjcmVhdGVJbnB1dEZ1bmN0aW9uKCJwYXNzd29yZCIpLAoJCSJpbWFnZSI6IGNyZWF0ZUlucHV0RnVuY3Rpb24oImltYWdlIiksCgoJCSJzdWJtaXQiOiBjcmVhdGVCdXR0b25GdW5jdGlvbigic3VibWl0IiksCgkJInJlc2V0IjogY3JlYXRlQnV0dG9uRnVuY3Rpb24oInJlc2V0IiksCgoJCSJidXR0b24iOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImJ1dHRvbiIgfHwgbmFtZSA9PT0gImJ1dHRvbiI7CgkJfSwKCgkJImlucHV0IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiByaW5wdXRzLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKCQl9LAoKCQkiZm9jdXMiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIGRvYyA9IGVsZW0ub3duZXJEb2N1bWVudDsKCQkJcmV0dXJuIGVsZW0gPT09IGRvYy5hY3RpdmVFbGVtZW50ICYmICghZG9jLmhhc0ZvY3VzIHx8IGRvYy5oYXNGb2N1cygpKSAmJiAhIShlbGVtLnR5cGUgfHwgZWxlbS5ocmVmKTsKCQl9LAoKCQkiYWN0aXZlIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtID09PSBlbGVtLm93bmVyRG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCQl9Cgl9LAoKCXNldEZpbHRlcnM6IHsKCQkiZmlyc3QiOiBmdW5jdGlvbiggZWxlbWVudHMsIGFyZ3VtZW50LCBub3QgKSB7CgkJCXJldHVybiBub3QgPyBlbGVtZW50cy5zbGljZSggMSApIDogWyBlbGVtZW50c1swXSBdOwoJCX0sCgoJCSJsYXN0IjogZnVuY3Rpb24oIGVsZW1lbnRzLCBhcmd1bWVudCwgbm90ICkgewoJCQl2YXIgZWxlbSA9IGVsZW1lbnRzLnBvcCgpOwoJCQlyZXR1cm4gbm90ID8gZWxlbWVudHMgOiBbIGVsZW0gXTsKCQl9LAoKCQkiZXZlbiI6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXJndW1lbnQsIG5vdCApIHsKCQkJdmFyIHJlc3VsdHMgPSBbXSwKCQkJCWkgPSBub3QgPyAxIDogMCwKCQkJCWxlbiA9IGVsZW1lbnRzLmxlbmd0aDsKCQkJZm9yICggOyBpIDwgbGVuOyBpID0gaSArIDIgKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZW1lbnRzW2ldICk7CgkJCX0KCQkJcmV0dXJuIHJlc3VsdHM7CgkJfSwKCgkJIm9kZCI6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXJndW1lbnQsIG5vdCApIHsKCQkJdmFyIHJlc3VsdHMgPSBbXSwKCQkJCWkgPSBub3QgPyAwIDogMSwKCQkJCWxlbiA9IGVsZW1lbnRzLmxlbmd0aDsKCQkJZm9yICggOyBpIDwgbGVuOyBpID0gaSArIDIgKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZW1lbnRzW2ldICk7CgkJCX0KCQkJcmV0dXJuIHJlc3VsdHM7CgkJfSwKCgkJImx0IjogZnVuY3Rpb24oIGVsZW1lbnRzLCBhcmd1bWVudCwgbm90ICkgewoJCQlyZXR1cm4gbm90ID8gZWxlbWVudHMuc2xpY2UoICthcmd1bWVudCApIDogZWxlbWVudHMuc2xpY2UoIDAsICthcmd1bWVudCApOwoJCX0sCgoJCSJndCI6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXJndW1lbnQsIG5vdCApIHsKCQkJcmV0dXJuIG5vdCA/IGVsZW1lbnRzLnNsaWNlKCAwLCArYXJndW1lbnQgKyAxICkgOiBlbGVtZW50cy5zbGljZSggK2FyZ3VtZW50ICsgMSApOwoJCX0sCgoJCSJlcSI6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXJndW1lbnQsIG5vdCApIHsKCQkJdmFyIGVsZW0gPSBlbGVtZW50cy5zcGxpY2UoICthcmd1bWVudCwgMSApOwoJCQlyZXR1cm4gbm90ID8gZWxlbWVudHMgOiBlbGVtOwoJCX0KCX0KfTsKCi8vIERlcHJlY2F0ZWQKRXhwci5zZXRGaWx0ZXJzWyJudGgiXSA9IEV4cHIuc2V0RmlsdGVyc1siZXEiXTsKCi8vIEJhY2stY29tcGF0CkV4cHIuZmlsdGVycyA9IEV4cHIucHNldWRvczsKCi8vIElFNi83IHJldHVybiBhIG1vZGlmaWVkIGhyZWYKaWYgKCAhYXNzZXJ0SHJlZk5vdE5vcm1hbGl6ZWQgKSB7CglFeHByLmF0dHJIYW5kbGUgPSB7CgkJImhyZWYiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCAiaHJlZiIsIDIgKTsKCQl9LAoJCSJ0eXBlIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpOwoJCX0KCX07Cn0KCi8vIEFkZCBnZXRFbGVtZW50c0J5TmFtZSBpZiB1c2FibGUKaWYgKCBhc3NlcnRVc2FibGVOYW1lICkgewoJRXhwci5vcmRlci5wdXNoKCJOQU1FIik7CglFeHByLmZpbmRbIk5BTUUiXSA9IGZ1bmN0aW9uKCBuYW1lLCBjb250ZXh0ICkgewoJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeU5hbWUgIT09IHN0cnVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeU5hbWUoIG5hbWUgKTsKCQl9Cgl9Owp9CgovLyBBZGQgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBpZiB1c2FibGUKaWYgKCBhc3NlcnRVc2FibGVDbGFzc05hbWUgKSB7CglFeHByLm9yZGVyLnNwbGljZSggMSwgMCwgIkNMQVNTIiApOwoJRXhwci5maW5kWyJDTEFTUyJdID0gZnVuY3Rpb24oIGNsYXNzTmFtZSwgY29udGV4dCwgeG1sICkgewoJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAhPT0gc3RydW5kZWZpbmVkICYmICF4bWwgKSB7CgkJCXJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIGNsYXNzTmFtZSApOwoJCX0KCX07Cn0KCi8vIElmIHNsaWNlIGlzIG5vdCBhdmFpbGFibGUsIHByb3ZpZGUgYSBiYWNrdXAKdHJ5IHsKCXNsaWNlLmNhbGwoIGRvY0VsZW0uY2hpbGROb2RlcywgMCApWzBdLm5vZGVUeXBlOwp9IGNhdGNoICggZSApIHsKCXNsaWNlID0gZnVuY3Rpb24oIGkgKSB7CgkJdmFyIGVsZW0sIHJlc3VsdHMgPSBbXTsKCQlmb3IgKCA7IChlbGVtID0gdGhpc1tpXSk7IGkrKyApIHsKCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJfQoJCXJldHVybiByZXN1bHRzOwoJfTsKfQoKdmFyIGlzWE1MID0gU2l6emxlLmlzWE1MID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkvLyBkb2N1bWVudEVsZW1lbnQgaXMgdmVyaWZpZWQgZm9yIGNhc2VzIHdoZXJlIGl0IGRvZXNuJ3QgeWV0IGV4aXN0CgkvLyAoc3VjaCBhcyBsb2FkaW5nIGlmcmFtZXMgaW4gSUUgLSAjNDgzMykKCXZhciBkb2N1bWVudEVsZW1lbnQgPSBlbGVtICYmIChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkuZG9jdW1lbnRFbGVtZW50OwoJcmV0dXJuIGRvY3VtZW50RWxlbWVudCA/IGRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPT0gIkhUTUwiIDogZmFsc2U7Cn07CgovLyBFbGVtZW50IGNvbnRhaW5zIGFub3RoZXIKdmFyIGNvbnRhaW5zID0gU2l6emxlLmNvbnRhaW5zID0gZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/CglmdW5jdGlvbiggYSwgYiApIHsKCQlyZXR1cm4gISEoIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGIgKSAmIDE2ICk7Cgl9IDoKCWRvY0VsZW0uY29udGFpbnMgPwoJZnVuY3Rpb24oIGEsIGIgKSB7CgkJdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKCQkJYnVwID0gYi5wYXJlbnROb2RlOwoJCXJldHVybiBhID09PSBidXAgfHwgISEoIGJ1cCAmJiBidXAubm9kZVR5cGUgPT09IDEgJiYgYWRvd24uY29udGFpbnMgJiYgYWRvd24uY29udGFpbnMoYnVwKSApOwoJfSA6CglmdW5jdGlvbiggYSwgYiApIHsKCQl3aGlsZSAoIChiID0gYi5wYXJlbnROb2RlKSApIHsKCQkJaWYgKCBiID09PSBhICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfTsKCi8qKgogKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwogKiBAcGFyYW0ge0FycmF5fEVsZW1lbnR9IGVsZW0KICovCnZhciBnZXRUZXh0ID0gU2l6emxlLmdldFRleHQgPSBmdW5jdGlvbiggZWxlbSApIHsKCXZhciBub2RlLAoJCXJldCA9ICIiLAoJCWkgPSAwLAoJCW5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKCglpZiAoIG5vZGVUeXBlICkgewoJCWlmICggbm9kZVR5cGUgPT09IDEgfHwgbm9kZVR5cGUgPT09IDkgfHwgbm9kZVR5cGUgPT09IDExICkgewoJCQkvLyBVc2UgdGV4dENvbnRlbnQgZm9yIGVsZW1lbnRzCgkJCS8vIGlubmVyVGV4dCB1c2FnZSByZW1vdmVkIGZvciBjb25zaXN0ZW5jeSBvZiBuZXcgbGluZXMgKHNlZSAjMTExNTMpCgkJCWlmICggdHlwZW9mIGVsZW0udGV4dENvbnRlbnQgPT09ICJzdHJpbmciICkgewoJCQkJcmV0dXJuIGVsZW0udGV4dENvbnRlbnQ7CgkJCX0gZWxzZSB7CgkJCQkvLyBUcmF2ZXJzZSBpdHMgY2hpbGRyZW4KCQkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgewoJCQkJCXJldCArPSBnZXRUZXh0KCBlbGVtICk7CgkJCQl9CgkJCX0KCQl9IGVsc2UgaWYgKCBub2RlVHlwZSA9PT0gMyB8fCBub2RlVHlwZSA9PT0gNCApIHsKCQkJcmV0dXJuIGVsZW0ubm9kZVZhbHVlOwoJCX0KCQkvLyBEbyBub3QgaW5jbHVkZSBjb21tZW50IG9yIHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb24gbm9kZXMKCX0gZWxzZSB7CgoJCS8vIElmIG5vIG5vZGVUeXBlLCB0aGlzIGlzIGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5CgkJZm9yICggOyAobm9kZSA9IGVsZW1baV0pOyBpKysgKSB7CgkJCS8vIERvIG5vdCB0cmF2ZXJzZSBjb21tZW50IG5vZGVzCgkJCXJldCArPSBnZXRUZXh0KCBub2RlICk7CgkJfQoJfQoJcmV0dXJuIHJldDsKfTsKClNpenpsZS5hdHRyID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7Cgl2YXIgYXR0ciwKCQl4bWwgPSBpc1hNTCggZWxlbSApOwoKCWlmICggIXhtbCApIHsKCQluYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoJaWYgKCBFeHByLmF0dHJIYW5kbGVbIG5hbWUgXSApIHsKCQlyZXR1cm4gRXhwci5hdHRySGFuZGxlWyBuYW1lIF0oIGVsZW0gKTsKCX0KCWlmICggYXNzZXJ0QXR0cmlidXRlcyB8fCB4bWwgKSB7CgkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICk7Cgl9CglhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICk7CglyZXR1cm4gYXR0ciA/CgkJdHlwZW9mIGVsZW1bIG5hbWUgXSA9PT0gImJvb2xlYW4iID8KCQkJZWxlbVsgbmFtZSBdID8gbmFtZSA6IG51bGwgOgoJCQlhdHRyLnNwZWNpZmllZCA/IGF0dHIudmFsdWUgOiBudWxsIDoKCQludWxsOwp9OwoKU2l6emxlLmVycm9yID0gZnVuY3Rpb24oIG1zZyApIHsKCXRocm93IG5ldyBFcnJvciggIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBtc2cgKTsKfTsKCi8vIENoZWNrIGlmIHRoZSBKYXZhU2NyaXB0IGVuZ2luZSBpcyB1c2luZyBzb21lIHNvcnQgb2YKLy8gb3B0aW1pemF0aW9uIHdoZXJlIGl0IGRvZXMgbm90IGFsd2F5cyBjYWxsIG91ciBjb21wYXJpc2lvbgovLyBmdW5jdGlvbi4gSWYgdGhhdCBpcyB0aGUgY2FzZSwgZGlzY2FyZCB0aGUgaGFzRHVwbGljYXRlIHZhbHVlLgovLyAgIFRodXMgZmFyIHRoYXQgaW5jbHVkZXMgR29vZ2xlIENocm9tZS4KWzAsIDBdLnNvcnQoZnVuY3Rpb24oKSB7CglyZXR1cm4gKGJhc2VIYXNEdXBsaWNhdGUgPSAwKTsKfSk7CgoKaWYgKCBkb2NFbGVtLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICkgewoJc29ydE9yZGVyID0gZnVuY3Rpb24oIGEsIGIgKSB7CgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgoJCXJldHVybiAoICFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIHx8ICFiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8KCQkJYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA6CgkJCWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0CgkJKSA/IC0xIDogMTsKCX07Cgp9IGVsc2UgewoJc29ydE9yZGVyID0gZnVuY3Rpb24oIGEsIGIgKSB7CgkJLy8gVGhlIG5vZGVzIGFyZSBpZGVudGljYWwsIHdlIGNhbiBleGl0IGVhcmx5CgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCgkJLy8gRmFsbGJhY2sgdG8gdXNpbmcgc291cmNlSW5kZXggKGluIElFKSBpZiBpdCdzIGF2YWlsYWJsZSBvbiBib3RoIG5vZGVzCgkJfSBlbHNlIGlmICggYS5zb3VyY2VJbmRleCAmJiBiLnNvdXJjZUluZGV4ICkgewoJCQlyZXR1cm4gYS5zb3VyY2VJbmRleCAtIGIuc291cmNlSW5kZXg7CgkJfQoKCQl2YXIgYWwsIGJsLAoJCQlhcCA9IFtdLAoJCQlicCA9IFtdLAoJCQlhdXAgPSBhLnBhcmVudE5vZGUsCgkJCWJ1cCA9IGIucGFyZW50Tm9kZSwKCQkJY3VyID0gYXVwOwoKCQkvLyBJZiB0aGUgbm9kZXMgYXJlIHNpYmxpbmdzIChvciBpZGVudGljYWwpIHdlIGNhbiBkbyBhIHF1aWNrIGNoZWNrCgkJaWYgKCBhdXAgPT09IGJ1cCApIHsKCQkJcmV0dXJuIHNpYmxpbmdDaGVjayggYSwgYiApOwoKCQkvLyBJZiBubyBwYXJlbnRzIHdlcmUgZm91bmQgdGhlbiB0aGUgbm9kZXMgYXJlIGRpc2Nvbm5lY3RlZAoJCX0gZWxzZSBpZiAoICFhdXAgKSB7CgkJCXJldHVybiAtMTsKCgkJfSBlbHNlIGlmICggIWJ1cCApIHsKCQkJcmV0dXJuIDE7CgkJfQoKCQkvLyBPdGhlcndpc2UgdGhleSdyZSBzb21ld2hlcmUgZWxzZSBpbiB0aGUgdHJlZSBzbyB3ZSBuZWVkCgkJLy8gdG8gYnVpbGQgdXAgYSBmdWxsIGxpc3Qgb2YgdGhlIHBhcmVudE5vZGVzIGZvciBjb21wYXJpc29uCgkJd2hpbGUgKCBjdXIgKSB7CgkJCWFwLnVuc2hpZnQoIGN1ciApOwoJCQljdXIgPSBjdXIucGFyZW50Tm9kZTsKCQl9CgoJCWN1ciA9IGJ1cDsKCgkJd2hpbGUgKCBjdXIgKSB7CgkJCWJwLnVuc2hpZnQoIGN1ciApOwoJCQljdXIgPSBjdXIucGFyZW50Tm9kZTsKCQl9CgoJCWFsID0gYXAubGVuZ3RoOwoJCWJsID0gYnAubGVuZ3RoOwoKCQkvLyBTdGFydCB3YWxraW5nIGRvd24gdGhlIHRyZWUgbG9va2luZyBmb3IgYSBkaXNjcmVwYW5jeQoJCWZvciAoIHZhciBpID0gMDsgaSA8IGFsICYmIGkgPCBibDsgaSsrICkgewoJCQlpZiAoIGFwW2ldICE9PSBicFtpXSApIHsKCQkJCXJldHVybiBzaWJsaW5nQ2hlY2soIGFwW2ldLCBicFtpXSApOwoJCQl9CgkJfQoKCQkvLyBXZSBlbmRlZCBzb21lcGxhY2UgdXAgdGhlIHRyZWUgc28gZG8gYSBzaWJsaW5nIGNoZWNrCgkJcmV0dXJuIGkgPT09IGFsID8KCQkJc2libGluZ0NoZWNrKCBhLCBicFtpXSwgLTEgKSA6CgkJCXNpYmxpbmdDaGVjayggYXBbaV0sIGIsIDEgKTsKCX07CgoJc2libGluZ0NoZWNrID0gZnVuY3Rpb24oIGEsIGIsIHJldCApIHsKCQlpZiAoIGEgPT09IGIgKSB7CgkJCXJldHVybiByZXQ7CgkJfQoKCQl2YXIgY3VyID0gYS5uZXh0U2libGluZzsKCgkJd2hpbGUgKCBjdXIgKSB7CgkJCWlmICggY3VyID09PSBiICkgewoJCQkJcmV0dXJuIC0xOwoJCQl9CgoJCQljdXIgPSBjdXIubmV4dFNpYmxpbmc7CgkJfQoKCQlyZXR1cm4gMTsKCX07Cn0KCi8vIERvY3VtZW50IHNvcnRpbmcgYW5kIHJlbW92aW5nIGR1cGxpY2F0ZXMKU2l6emxlLnVuaXF1ZVNvcnQgPSBmdW5jdGlvbiggcmVzdWx0cyApIHsKCXZhciBlbGVtLAoJCWkgPSAxOwoKCWlmICggc29ydE9yZGVyICkgewoJCWhhc0R1cGxpY2F0ZSA9IGJhc2VIYXNEdXBsaWNhdGU7CgkJcmVzdWx0cy5zb3J0KCBzb3J0T3JkZXIgKTsKCgkJaWYgKCBoYXNEdXBsaWNhdGUgKSB7CgkJCWZvciAoIDsgKGVsZW0gPSByZXN1bHRzW2ldKTsgaSsrICkgewoJCQkJaWYgKCBlbGVtID09PSByZXN1bHRzWyBpIC0gMSBdICkgewoJCQkJCXJlc3VsdHMuc3BsaWNlKCBpLS0sIDEgKTsKCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4gcmVzdWx0czsKfTsKCmZ1bmN0aW9uIG11bHRpcGxlQ29udGV4dHMoIHNlbGVjdG9yLCBjb250ZXh0cywgcmVzdWx0cywgc2VlZCApIHsKCXZhciBpID0gMCwKCQlsZW4gPSBjb250ZXh0cy5sZW5ndGg7Cglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlTaXp6bGUoIHNlbGVjdG9yLCBjb250ZXh0c1tpXSwgcmVzdWx0cywgc2VlZCApOwoJfQp9CgpmdW5jdGlvbiBoYW5kbGVQT1NHcm91cCggc2VsZWN0b3IsIHBvc2ZpbHRlciwgYXJndW1lbnQsIGNvbnRleHRzLCBzZWVkLCBub3QgKSB7Cgl2YXIgcmVzdWx0cywKCQlmbiA9IEV4cHIuc2V0RmlsdGVyc1sgcG9zZmlsdGVyLnRvTG93ZXJDYXNlKCkgXTsKCglpZiAoICFmbiApIHsKCQlTaXp6bGUuZXJyb3IoIHBvc2ZpbHRlciApOwoJfQoKCWlmICggc2VsZWN0b3IgfHwgIShyZXN1bHRzID0gc2VlZCkgKSB7CgkJbXVsdGlwbGVDb250ZXh0cyggc2VsZWN0b3IgfHwgIioiLCBjb250ZXh0cywgKHJlc3VsdHMgPSBbXSksIHNlZWQgKTsKCX0KCglyZXR1cm4gcmVzdWx0cy5sZW5ndGggPiAwID8gZm4oIHJlc3VsdHMsIGFyZ3VtZW50LCBub3QgKSA6IFtdOwp9CgpmdW5jdGlvbiBoYW5kbGVQT1MoIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkLCBncm91cHMgKSB7Cgl2YXIgbWF0Y2gsIG5vdCwgYW5jaG9yLCByZXQsIGVsZW1lbnRzLCBjdXJyZW50Q29udGV4dHMsIHBhcnQsIGxhc3RJbmRleCwKCQlpID0gMCwKCQlsZW4gPSBncm91cHMubGVuZ3RoLAoJCXJwb3MgPSBtYXRjaEV4cHJbIlBPUyJdLAoJCS8vIFRoaXMgaXMgZ2VuZXJhdGVkIGhlcmUgaW4gY2FzZSBtYXRjaEV4cHJbIlBPUyJdIGlzIGV4dGVuZGVkCgkJcnBvc2dyb3VwcyA9IG5ldyBSZWdFeHAoICJeIiArIHJwb3Muc291cmNlICsgIig/ISIgKyB3aGl0ZXNwYWNlICsgIikiLCAiaSIgKSwKCQkvLyBUaGlzIGlzIGZvciBtYWtpbmcgc3VyZSBub24tcGFydGljaXBhdGluZwoJCS8vIG1hdGNoaW5nIGdyb3VwcyBhcmUgcmVwcmVzZW50ZWQgY3Jvc3MtYnJvd3NlciAoSUU2LTgpCgkJc2V0VW5kZWZpbmVkID0gZnVuY3Rpb24oKSB7CgkJCXZhciBpID0gMSwKCQkJCWxlbiA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwoJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJCWlmICggYXJndW1lbnRzW2ldID09PSB1bmRlZmluZWQgKSB7CgkJCQkJbWF0Y2hbaV0gPSB1bmRlZmluZWQ7CgkJCQl9CgkJCX0KCQl9OwoKCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCS8vIFJlc2V0IHJlZ2V4IGluZGV4IHRvIDAKCQlycG9zLmV4ZWMoIiIpOwoJCXNlbGVjdG9yID0gZ3JvdXBzW2ldOwoJCXJldCA9IFtdOwoJCWFuY2hvciA9IDA7CgkJZWxlbWVudHMgPSBzZWVkOwoJCXdoaWxlICggKG1hdGNoID0gcnBvcy5leGVjKCBzZWxlY3RvciApKSApIHsKCQkJbGFzdEluZGV4ID0gcnBvcy5sYXN0SW5kZXggPSBtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aDsKCQkJaWYgKCBsYXN0SW5kZXggPiBhbmNob3IgKSB7CgkJCQlwYXJ0ID0gc2VsZWN0b3Iuc2xpY2UoIGFuY2hvciwgbWF0Y2guaW5kZXggKTsKCQkJCWFuY2hvciA9IGxhc3RJbmRleDsKCQkJCWN1cnJlbnRDb250ZXh0cyA9IFsgY29udGV4dCBdOwoKCQkJCWlmICggcmNvbWJpbmF0b3JzLnRlc3QocGFydCkgKSB7CgkJCQkJaWYgKCBlbGVtZW50cyApIHsKCQkJCQkJY3VycmVudENvbnRleHRzID0gZWxlbWVudHM7CgkJCQkJfQoJCQkJCWVsZW1lbnRzID0gc2VlZDsKCQkJCX0KCgkJCQlpZiAoIChub3QgPSByZW5kc1dpdGhOb3QudGVzdCggcGFydCApKSApIHsKCQkJCQlwYXJ0ID0gcGFydC5zbGljZSggMCwgLTUgKS5yZXBsYWNlKCByY29tYmluYXRvcnMsICIkJioiICk7CgkJCQl9CgoJCQkJaWYgKCBtYXRjaC5sZW5ndGggPiAxICkgewoJCQkJCW1hdGNoWzBdLnJlcGxhY2UoIHJwb3Nncm91cHMsIHNldFVuZGVmaW5lZCApOwoJCQkJfQoJCQkJZWxlbWVudHMgPSBoYW5kbGVQT1NHcm91cCggcGFydCwgbWF0Y2hbMV0sIG1hdGNoWzJdLCBjdXJyZW50Q29udGV4dHMsIGVsZW1lbnRzLCBub3QgKTsKCQkJfQoJCX0KCgkJaWYgKCBlbGVtZW50cyApIHsKCQkJcmV0ID0gcmV0LmNvbmNhdCggZWxlbWVudHMgKTsKCgkJCWlmICggKHBhcnQgPSBzZWxlY3Rvci5zbGljZSggYW5jaG9yICkpICYmIHBhcnQgIT09ICIpIiApIHsKCQkJCW11bHRpcGxlQ29udGV4dHMoIHBhcnQsIHJldCwgcmVzdWx0cywgc2VlZCApOwoJCQl9IGVsc2UgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgcmV0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlTaXp6bGUoIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICk7CgkJfQoJfQoKCS8vIERvIG5vdCBzb3J0IGlmIHRoaXMgaXMgYSBzaW5nbGUgZmlsdGVyCglyZXR1cm4gbGVuID09PSAxID8gcmVzdWx0cyA6IFNpenpsZS51bmlxdWVTb3J0KCByZXN1bHRzICk7Cn0KCmZ1bmN0aW9uIHRva2VuaXplKCBzZWxlY3RvciwgY29udGV4dCwgeG1sICkgewoJdmFyIHRva2Vucywgc29GYXIsIHR5cGUsCgkJZ3JvdXBzID0gW10sCgkJaSA9IDAsCgoJCS8vIENhdGNoIG9idmlvdXMgc2VsZWN0b3IgaXNzdWVzOiB0ZXJtaW5hbCAiKSI7IG5vbmVtcHR5IGZhbGxiYWNrIG1hdGNoCgkJLy8gcnNlbGVjdG9yIG5ldmVyIGZhaWxzIHRvIG1hdGNoICpzb21ldGhpbmcqCgkJbWF0Y2ggPSByc2VsZWN0b3IuZXhlYyggc2VsZWN0b3IgKSwKCQltYXRjaGVkID0gIW1hdGNoLnBvcCgpICYmICFtYXRjaC5wb3AoKSwKCQlzZWxlY3Rvckdyb3VwcyA9IG1hdGNoZWQgJiYgc2VsZWN0b3IubWF0Y2goIHJncm91cHMgKSB8fCBbIiJdLAoKCQlwcmVGaWx0ZXJzID0gRXhwci5wcmVGaWx0ZXIsCgkJZmlsdGVycyA9IEV4cHIuZmlsdGVyLAoJCWNoZWNrQ29udGV4dCA9ICF4bWwgJiYgY29udGV4dCAhPT0gZG9jdW1lbnQ7CgoJZm9yICggOyAoc29GYXIgPSBzZWxlY3Rvckdyb3Vwc1tpXSkgIT0gbnVsbCAmJiBtYXRjaGVkOyBpKysgKSB7CgkJZ3JvdXBzLnB1c2goIHRva2VucyA9IFtdICk7CgoJCS8vIE5lZWQgdG8gbWFrZSBzdXJlIHdlJ3JlIHdpdGhpbiBhIG5hcnJvd2VyIGNvbnRleHQgaWYgbmVjZXNzYXJ5CgkJLy8gQWRkaW5nIGEgZGVzY2VuZGFudCBjb21iaW5hdG9yIHdpbGwgZ2VuZXJhdGUgd2hhdCBpcyBuZWVkZWQKCQlpZiAoIGNoZWNrQ29udGV4dCApIHsKCQkJc29GYXIgPSAiICIgKyBzb0ZhcjsKCQl9CgoJCXdoaWxlICggc29GYXIgKSB7CgkJCW1hdGNoZWQgPSBmYWxzZTsKCgkJCS8vIENvbWJpbmF0b3JzCgkJCWlmICggKG1hdGNoID0gcmNvbWJpbmF0b3JzLmV4ZWMoIHNvRmFyICkpICkgewoJCQkJc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hbMF0ubGVuZ3RoICk7CgoJCQkJLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCgkJCQltYXRjaGVkID0gdG9rZW5zLnB1c2goeyBwYXJ0OiBtYXRjaC5wb3AoKS5yZXBsYWNlKCBydHJpbSwgIiAiICksIGNhcHR1cmVzOiBtYXRjaCB9KTsKCQkJfQoKCQkJLy8gRmlsdGVycwoJCQlmb3IgKCB0eXBlIGluIGZpbHRlcnMgKSB7CgkJCQlpZiAoIChtYXRjaCA9IG1hdGNoRXhwclsgdHlwZSBdLmV4ZWMoIHNvRmFyICkpICYmICghcHJlRmlsdGVyc1sgdHlwZSBdIHx8CgkJCQkJKG1hdGNoID0gcHJlRmlsdGVyc1sgdHlwZSBdKCBtYXRjaCwgY29udGV4dCwgeG1sICkpICkgKSB7CgoJCQkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoLnNoaWZ0KCkubGVuZ3RoICk7CgkJCQkJbWF0Y2hlZCA9IHRva2Vucy5wdXNoKHsgcGFydDogdHlwZSwgY2FwdHVyZXM6IG1hdGNoIH0pOwoJCQkJfQoJCQl9CgoJCQlpZiAoICFtYXRjaGVkICkgewoJCQkJYnJlYWs7CgkJCX0KCQl9Cgl9CgoJaWYgKCAhbWF0Y2hlZCApIHsKCQlTaXp6bGUuZXJyb3IoIHNlbGVjdG9yICk7Cgl9CgoJcmV0dXJuIGdyb3VwczsKfQoKZnVuY3Rpb24gYWRkQ29tYmluYXRvciggbWF0Y2hlciwgY29tYmluYXRvciwgY29udGV4dCApIHsKCXZhciBkaXIgPSBjb21iaW5hdG9yLmRpciwKCQlkb25lTmFtZSA9IGRvbmUrKzsKCglpZiAoICFtYXRjaGVyICkgewoJCS8vIElmIHRoZXJlIGlzIG5vIG1hdGNoZXIgdG8gY2hlY2ssIGNoZWNrIGFnYWluc3QgdGhlIGNvbnRleHQKCQltYXRjaGVyID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtID09PSBjb250ZXh0OwoJCX07Cgl9CglyZXR1cm4gY29tYmluYXRvci5maXJzdCA/CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQgKSB7CgkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJcmV0dXJuIG1hdGNoZXIoIGVsZW0sIGNvbnRleHQgKSAmJiBlbGVtOwoJCQkJfQoJCQl9CgkJfSA6CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQgKSB7CgkJCXZhciBjYWNoZSwKCQkJCWRpcmtleSA9IGRvbmVOYW1lICsgIi4iICsgZGlycnVucywKCQkJCWNhY2hlZGtleSA9IGRpcmtleSArICIuIiArIGNhY2hlZHJ1bnM7CgkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJaWYgKCAoY2FjaGUgPSBlbGVtWyBleHBhbmRvIF0pID09PSBjYWNoZWRrZXkgKSB7CgkJCQkJCXJldHVybiBlbGVtLnNpenNldDsKCQkJCQl9IGVsc2UgaWYgKCB0eXBlb2YgY2FjaGUgPT09ICJzdHJpbmciICYmIGNhY2hlLmluZGV4T2YoZGlya2V5KSA9PT0gMCApIHsKCQkJCQkJaWYgKCBlbGVtLnNpenNldCApIHsKCQkJCQkJCXJldHVybiBlbGVtOwoJCQkJCQl9CgkJCQkJfSBlbHNlIHsKCQkJCQkJZWxlbVsgZXhwYW5kbyBdID0gY2FjaGVka2V5OwoJCQkJCQlpZiAoIG1hdGNoZXIoIGVsZW0sIGNvbnRleHQgKSApIHsKCQkJCQkJCWVsZW0uc2l6c2V0ID0gdHJ1ZTsKCQkJCQkJCXJldHVybiBlbGVtOwoJCQkJCQl9CgkJCQkJCWVsZW0uc2l6c2V0ID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfTsKfQoKZnVuY3Rpb24gYWRkTWF0Y2hlciggaGlnaGVyLCBkZWVwZXIgKSB7CglyZXR1cm4gaGlnaGVyID8KCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCApIHsKCQkJdmFyIHJlc3VsdCA9IGRlZXBlciggZWxlbSwgY29udGV4dCApOwoJCQlyZXR1cm4gcmVzdWx0ICYmIGhpZ2hlciggcmVzdWx0ID09PSB0cnVlID8gZWxlbSA6IHJlc3VsdCwgY29udGV4dCApOwoJCX0gOgoJCWRlZXBlcjsKfQoKLy8gWyJUQUciLCAiPiIsICJJRCIsICIgIiwgIkNMQVNTIl0KZnVuY3Rpb24gbWF0Y2hlckZyb21Ub2tlbnMoIHRva2VucywgY29udGV4dCwgeG1sICkgewoJdmFyIHRva2VuLCBtYXRjaGVyLAoJCWkgPSAwOwoKCWZvciAoIDsgKHRva2VuID0gdG9rZW5zW2ldKTsgaSsrICkgewoJCWlmICggRXhwci5yZWxhdGl2ZVsgdG9rZW4ucGFydCBdICkgewoJCQltYXRjaGVyID0gYWRkQ29tYmluYXRvciggbWF0Y2hlciwgRXhwci5yZWxhdGl2ZVsgdG9rZW4ucGFydCBdLCBjb250ZXh0ICk7CgkJfSBlbHNlIHsKCQkJdG9rZW4uY2FwdHVyZXMucHVzaCggY29udGV4dCwgeG1sICk7CgkJCW1hdGNoZXIgPSBhZGRNYXRjaGVyKCBtYXRjaGVyLCBFeHByLmZpbHRlclsgdG9rZW4ucGFydCBdLmFwcGx5KCBudWxsLCB0b2tlbi5jYXB0dXJlcyApICk7CgkJfQoJfQoKCXJldHVybiBtYXRjaGVyOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoIG1hdGNoZXJzICkgewoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0ICkgewoJCXZhciBtYXRjaGVyLAoJCQlqID0gMDsKCQlmb3IgKCA7IChtYXRjaGVyID0gbWF0Y2hlcnNbal0pOyBqKysgKSB7CgkJCWlmICggbWF0Y2hlcihlbGVtLCBjb250ZXh0KSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJCXJldHVybiBmYWxzZTsKCX07Cn0KCnZhciBjb21waWxlID0gU2l6emxlLmNvbXBpbGUgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHhtbCApIHsKCXZhciB0b2tlbnMsIGdyb3VwLCBpLAoJCWNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbIHNlbGVjdG9yIF07CgoJLy8gUmV0dXJuIGEgY2FjaGVkIGdyb3VwIGZ1bmN0aW9uIGlmIGFscmVhZHkgZ2VuZXJhdGVkIChjb250ZXh0IGRlcGVuZGVudCkKCWlmICggY2FjaGVkICYmIGNhY2hlZC5jb250ZXh0ID09PSBjb250ZXh0ICkgewoJCXJldHVybiBjYWNoZWQ7Cgl9CgoJLy8gR2VuZXJhdGUgYSBmdW5jdGlvbiBvZiByZWN1cnNpdmUgZnVuY3Rpb25zIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2hlY2sgZWFjaCBlbGVtZW50Cglncm91cCA9IHRva2VuaXplKCBzZWxlY3RvciwgY29udGV4dCwgeG1sICk7Cglmb3IgKCBpID0gMDsgKHRva2VucyA9IGdyb3VwW2ldKTsgaSsrICkgewoJCWdyb3VwW2ldID0gbWF0Y2hlckZyb21Ub2tlbnMoIHRva2VucywgY29udGV4dCwgeG1sICk7Cgl9CgoJLy8gQ2FjaGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uCgljYWNoZWQgPSBjb21waWxlckNhY2hlWyBzZWxlY3RvciBdID0gbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBncm91cCApOwoJY2FjaGVkLmNvbnRleHQgPSBjb250ZXh0OwoJY2FjaGVkLnJ1bnMgPSBjYWNoZWQuZGlycnVucyA9IDA7CgljYWNoZWRTZWxlY3RvcnMucHVzaCggc2VsZWN0b3IgKTsKCS8vIEVuc3VyZSBvbmx5IHRoZSBtb3N0IHJlY2VudCBhcmUgY2FjaGVkCglpZiAoIGNhY2hlZFNlbGVjdG9ycy5sZW5ndGggPiBFeHByLmNhY2hlTGVuZ3RoICkgewoJCWRlbGV0ZSBjb21waWxlckNhY2hlWyBjYWNoZWRTZWxlY3RvcnMuc2hpZnQoKSBdOwoJfQoJcmV0dXJuIGNhY2hlZDsKfTsKClNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIGVsZW1lbnRzICkgewoJcmV0dXJuIFNpenpsZSggZXhwciwgbnVsbCwgbnVsbCwgZWxlbWVudHMgKTsKfTsKClNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWxlbSwgZXhwciApIHsKCXJldHVybiBTaXp6bGUoIGV4cHIsIG51bGwsIG51bGwsIFsgZWxlbSBdICkubGVuZ3RoID4gMDsKfTsKCnZhciBzZWxlY3QgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQsIHhtbCApIHsKCS8vIFJlbW92ZSBleGNlc3NpdmUgd2hpdGVzcGFjZQoJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBydHJpbSwgIiQxIiApOwoJdmFyIGVsZW1lbnRzLCBtYXRjaGVyLCBpLCBsZW4sIGVsZW0sIHRva2VuLAoJCXR5cGUsIGZpbmRDb250ZXh0LCBub3RUb2tlbnMsCgkJbWF0Y2ggPSBzZWxlY3Rvci5tYXRjaCggcmdyb3VwcyApLAoJCXRva2VucyA9IHNlbGVjdG9yLm1hdGNoKCBydG9rZW5zICksCgkJY29udGV4dE5vZGVUeXBlID0gY29udGV4dC5ub2RlVHlwZTsKCgkvLyBQT1MgaGFuZGxpbmcKCWlmICggbWF0Y2hFeHByWyJQT1MiXS50ZXN0KHNlbGVjdG9yKSApIHsKCQlyZXR1cm4gaGFuZGxlUE9TKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCwgbWF0Y2ggKTsKCX0KCglpZiAoIHNlZWQgKSB7CgkJZWxlbWVudHMgPSBzbGljZS5jYWxsKCBzZWVkLCAwICk7CgoJLy8gVG8gbWFpbnRhaW4gZG9jdW1lbnQgb3JkZXIsIG9ubHkgbmFycm93IHRoZQoJLy8gc2V0IGlmIHRoZXJlIGlzIG9uZSBncm91cAoJfSBlbHNlIGlmICggbWF0Y2ggJiYgbWF0Y2gubGVuZ3RoID09PSAxICkgewoKCQkvLyBUYWtlIGEgc2hvcnRjdXQgYW5kIHNldCB0aGUgY29udGV4dCBpZiB0aGUgcm9vdCBzZWxlY3RvciBpcyBhbiBJRAoJCWlmICggdG9rZW5zLmxlbmd0aCA+IDEgJiYgY29udGV4dE5vZGVUeXBlID09PSA5ICYmICF4bWwgJiYKCQkJCShtYXRjaCA9IG1hdGNoRXhwclsiSUQiXS5leGVjKCB0b2tlbnNbMF0gKSkgKSB7CgoJCQljb250ZXh0ID0gRXhwci5maW5kWyJJRCJdKCBtYXRjaFsxXSwgY29udGV4dCwgeG1sIClbMF07CgkJCWlmICggIWNvbnRleHQgKSB7CgkJCQlyZXR1cm4gcmVzdWx0czsKCQkJfQoKCQkJc2VsZWN0b3IgPSBzZWxlY3Rvci5zbGljZSggdG9rZW5zLnNoaWZ0KCkubGVuZ3RoICk7CgkJfQoKCQlmaW5kQ29udGV4dCA9ICggKG1hdGNoID0gcnNpYmxpbmcuZXhlYyggdG9rZW5zWzBdICkpICYmICFtYXRjaC5pbmRleCAmJiBjb250ZXh0LnBhcmVudE5vZGUgKSB8fCBjb250ZXh0OwoKCQkvLyBHZXQgdGhlIGxhc3QgdG9rZW4sIGV4Y2x1ZGluZyA6bm90CgkJbm90VG9rZW5zID0gdG9rZW5zLnBvcCgpOwoJCXRva2VuID0gbm90VG9rZW5zLnNwbGl0KCI6bm90IilbMF07CgoJCWZvciAoIGkgPSAwLCBsZW4gPSBFeHByLm9yZGVyLmxlbmd0aDsgaSA8IGxlbjsgaSsrICkgewoJCQl0eXBlID0gRXhwci5vcmRlcltpXTsKCgkJCWlmICggKG1hdGNoID0gbWF0Y2hFeHByWyB0eXBlIF0uZXhlYyggdG9rZW4gKSkgKSB7CgkJCQllbGVtZW50cyA9IEV4cHIuZmluZFsgdHlwZSBdKCAobWF0Y2hbMV0gfHwgIiIpLnJlcGxhY2UoIHJiYWNrc2xhc2gsICIiICksIGZpbmRDb250ZXh0LCB4bWwgKTsKCgkJCQlpZiAoIGVsZW1lbnRzID09IG51bGwgKSB7CgkJCQkJY29udGludWU7CgkJCQl9CgoJCQkJaWYgKCB0b2tlbiA9PT0gbm90VG9rZW5zICkgewoJCQkJCXNlbGVjdG9yID0gc2VsZWN0b3Iuc2xpY2UoIDAsIHNlbGVjdG9yLmxlbmd0aCAtIG5vdFRva2Vucy5sZW5ndGggKSArCgkJCQkJCXRva2VuLnJlcGxhY2UoIG1hdGNoRXhwclsgdHlwZSBdLCAiIiApOwoKCQkJCQlpZiAoICFzZWxlY3RvciApIHsKCQkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2xpY2UuY2FsbChlbGVtZW50cywgMCkgKTsKCQkJCQl9CgkJCQl9CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCgkvLyBPbmx5IGxvb3Agb3ZlciB0aGUgZ2l2ZW4gZWxlbWVudHMgb25jZQoJLy8gSWYgc2VsZWN0b3IgaXMgZW1wdHksIHdlJ3JlIGFscmVhZHkgZG9uZQoJaWYgKCBzZWxlY3RvciApIHsKCQltYXRjaGVyID0gY29tcGlsZSggc2VsZWN0b3IsIGNvbnRleHQsIHhtbCApOwoJCWRpcnJ1bnMgPSBtYXRjaGVyLmRpcnJ1bnMrKzsKCgkJaWYgKCBlbGVtZW50cyA9PSBudWxsICkgewoJCQllbGVtZW50cyA9IEV4cHIuZmluZFsiVEFHIl0oICIqIiwgKHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkgJiYgY29udGV4dC5wYXJlbnROb2RlKSB8fCBjb250ZXh0ICk7CgkJfQoJCWZvciAoIGkgPSAwOyAoZWxlbSA9IGVsZW1lbnRzW2ldKTsgaSsrICkgewoJCQljYWNoZWRydW5zID0gbWF0Y2hlci5ydW5zKys7CgkJCWlmICggbWF0Y2hlcihlbGVtLCBjb250ZXh0KSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCQl9CgkJfQoJfQoKCXJldHVybiByZXN1bHRzOwp9OwoKaWYgKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsICkgewoJKGZ1bmN0aW9uKCkgewoJCXZhciBkaXNjb25uZWN0ZWRNYXRjaCwKCQkJb2xkU2VsZWN0ID0gc2VsZWN0LAoJCQlyZXNjYXBlID0gLyd8XFwvZywKCQkJcmF0dHJpYnV0ZVF1b3RlcyA9IC9cPVtceDIwXHRcclxuXGZdKihbXiciXF1dKilbXHgyMFx0XHJcblxmXSpcXS9nLAoJCQlyYnVnZ3lRU0EgPSBbXSwKCQkJLy8gbWF0Y2hlc1NlbGVjdG9yKDphY3RpdmUpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChJRTkvT3BlcmEgMTEuNSkKCQkJLy8gQSBzdXBwb3J0IHRlc3Qgd291bGQgcmVxdWlyZSB0b28gbXVjaCBjb2RlICh3b3VsZCBpbmNsdWRlIGRvY3VtZW50IHJlYWR5KQoJCQkvLyBqdXN0IHNraXAgbWF0Y2hlc1NlbGVjdG9yIGZvciA6YWN0aXZlCgkJCXJidWdneU1hdGNoZXMgPSBbIjphY3RpdmUiXSwKCQkJbWF0Y2hlcyA9IGRvY0VsZW0ubWF0Y2hlc1NlbGVjdG9yIHx8CgkJCQlkb2NFbGVtLm1vek1hdGNoZXNTZWxlY3RvciB8fAoJCQkJZG9jRWxlbS53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwKCQkJCWRvY0VsZW0ub01hdGNoZXNTZWxlY3RvciB8fAoJCQkJZG9jRWxlbS5tc01hdGNoZXNTZWxlY3RvcjsKCgkJLy8gQnVpbGQgUVNBIHJlZ2V4CgkJLy8gUmVnZXggc3RyYXRlZ3kgYWRvcHRlZCBmcm9tIERpZWdvIFBlcmluaQoJCWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCQlkaXYuaW5uZXJIVE1MID0gIjxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD48L29wdGlvbj48L3NlbGVjdD4iOwoKCQkJLy8gSUU4IC0gU29tZSBib29sZWFuIGF0dHJpYnV0ZXMgYXJlIG5vdCB0cmVhdGVkIGNvcnJlY3RseQoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiW3NlbGVjdGVkXSIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCAiXFxbIiArIHdoaXRlc3BhY2UgKyAiKig/OmNoZWNrZWR8ZGlzYWJsZWR8aXNtYXB8bXVsdGlwbGV8cmVhZG9ubHl8c2VsZWN0ZWR8dmFsdWUpIiApOwoJCQl9CgoJCQkvLyBXZWJraXQvT3BlcmEgLSA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbiBlbGVtZW50cwoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDExL1JFQy1jc3MzLXNlbGVjdG9ycy0yMDExMDkyOS8jY2hlY2tlZAoJCQkvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgKGRvIG5vdCBwdXQgdGVzdHMgYWZ0ZXIgdGhpcyBvbmUpCgkJCWlmICggIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCI6Y2hlY2tlZCIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCI6Y2hlY2tlZCIpOwoJCQl9CgkJfSk7CgoJCWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoKCQkJLy8gT3BlcmEgMTAtMTIvSUU5IC0gXj0gJD0gKj0gYW5kIGVtcHR5IHZhbHVlcwoJCQkvLyBTaG91bGQgbm90IHNlbGVjdCBhbnl0aGluZwoJCQlkaXYuaW5uZXJIVE1MID0gIjxwIHRlc3Q9Jyc+PC9wPiI7CgkJCWlmICggZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIlt0ZXN0Xj0nJ10iKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIlsqXiRdPSIgKyB3aGl0ZXNwYWNlICsgIiooPzpcIlwifCcnKSIgKTsKCQkJfQoKCQkJLy8gRkYgMy41IC0gOmVuYWJsZWQvOmRpc2FibGVkIGFuZCBoaWRkZW4gZWxlbWVudHMgKGhpZGRlbiBlbGVtZW50cyBhcmUgc3RpbGwgZW5hYmxlZCkKCQkJLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIChkbyBub3QgcHV0IHRlc3RzIGFmdGVyIHRoaXMgb25lKQoJCQlkaXYuaW5uZXJIVE1MID0gIjxpbnB1dCB0eXBlPSdoaWRkZW4nPiI7CgkJCWlmICggIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCI6ZW5hYmxlZCIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCI6ZW5hYmxlZCIsICI6ZGlzYWJsZWQiKTsKCQkJfQoJCX0pOwoKCQlyYnVnZ3lRU0EgPSByYnVnZ3lRU0EubGVuZ3RoICYmIG5ldyBSZWdFeHAoIHJidWdneVFTQS5qb2luKCJ8IikgKTsKCgkJc2VsZWN0ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkLCB4bWwgKSB7CgkJCS8vIE9ubHkgdXNlIHF1ZXJ5U2VsZWN0b3JBbGwgd2hlbiBub3QgZmlsdGVyaW5nLAoJCQkvLyB3aGVuIHRoaXMgaXMgbm90IHhtbCwKCQkJLy8gYW5kIHdoZW4gbm8gUVNBIGJ1Z3MgYXBwbHkKCQkJaWYgKCAhc2VlZCAmJiAheG1sICYmICghcmJ1Z2d5UVNBIHx8ICFyYnVnZ3lRU0EudGVzdCggc2VsZWN0b3IgKSkgKSB7CgkJCQlpZiAoIGNvbnRleHQubm9kZVR5cGUgPT09IDkgKSB7CgkJCQkJdHJ5IHsKCQkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2xpY2UuY2FsbChjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoIHNlbGVjdG9yICksIDApICk7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0gY2F0Y2gocXNhRXJyb3IpIHt9CgkJCQkvLyBxU0Egd29ya3Mgc3RyYW5nZWx5IG9uIEVsZW1lbnQtcm9vdGVkIHF1ZXJpZXMKCQkJCS8vIFdlIGNhbiB3b3JrIGFyb3VuZCB0aGlzIGJ5IHNwZWNpZnlpbmcgYW4gZXh0cmEgSUQgb24gdGhlIHJvb3QKCQkJCS8vIGFuZCB3b3JraW5nIHVwIGZyb20gdGhlcmUgKFRoYW5rcyB0byBBbmRyZXcgRHVwb250IGZvciB0aGUgdGVjaG5pcXVlKQoJCQkJLy8gSUUgOCBkb2Vzbid0IHdvcmsgb24gb2JqZWN0IGVsZW1lbnRzCgkJCQl9IGVsc2UgaWYgKCBjb250ZXh0Lm5vZGVUeXBlID09PSAxICYmIGNvbnRleHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm9iamVjdCIgKSB7CgkJCQkJdmFyIG9sZCA9IGNvbnRleHQuZ2V0QXR0cmlidXRlKCJpZCIpLAoJCQkJCQluaWQgPSBvbGQgfHwgZXhwYW5kbywKCQkJCQkJbmV3Q29udGV4dCA9IHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkgJiYgY29udGV4dC5wYXJlbnROb2RlIHx8IGNvbnRleHQ7CgoJCQkJCWlmICggb2xkICkgewoJCQkJCQluaWQgPSBuaWQucmVwbGFjZSggcmVzY2FwZSwgIlxcJCYiICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJY29udGV4dC5zZXRBdHRyaWJ1dGUoICJpZCIsIG5pZCApOwoJCQkJCX0KCgkJCQkJdHJ5IHsKCQkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2xpY2UuY2FsbCggbmV3Q29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKAoJCQkJCQkJc2VsZWN0b3IucmVwbGFjZSggcmdyb3VwcywgIltpZD0nIiArIG5pZCArICInXSAkJiIgKQoJCQkJCQkpLCAwICkgKTsKCQkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQkJfSBjYXRjaChxc2FFcnJvcikgewoJCQkJCX0gZmluYWxseSB7CgkJCQkJCWlmICggIW9sZCApIHsKCQkJCQkJCWNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCJpZCIpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gb2xkU2VsZWN0KCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCwgeG1sICk7CgkJfTsKCgkJaWYgKCBtYXRjaGVzICkgewoJCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQkJCS8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgoJCQkJLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSkKCQkJCWRpc2Nvbm5lY3RlZE1hdGNoID0gbWF0Y2hlcy5jYWxsKCBkaXYsICJkaXYiICk7CgoJCQkJLy8gVGhpcyBzaG91bGQgZmFpbCB3aXRoIGFuIGV4Y2VwdGlvbgoJCQkJLy8gR2Vja28gZG9lcyBub3QgZXJyb3IsIHJldHVybnMgZmFsc2UgaW5zdGVhZAoJCQkJdHJ5IHsKCQkJCQltYXRjaGVzLmNhbGwoIGRpdiwgIlt0ZXN0IT0nJ106c2l6emxlIiApOwoJCQkJCXJidWdneU1hdGNoZXMucHVzaCggRXhwci5tYXRjaC5QU0VVRE8gKTsKCQkJCX0gY2F0Y2ggKCBlICkge30KCQkJfSk7CgoJCQkvLyByYnVnZ3lNYXRjaGVzIGFsd2F5cyBjb250YWlucyA6YWN0aXZlLCBzbyBubyBuZWVkIGZvciBhIGxlbmd0aCBjaGVjawoJCQlyYnVnZ3lNYXRjaGVzID0gLyogcmJ1Z2d5TWF0Y2hlcy5sZW5ndGggJiYgKi8gbmV3IFJlZ0V4cCggcmJ1Z2d5TWF0Y2hlcy5qb2luKCJ8IikgKTsKCgkJCVNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWxlbSwgZXhwciApIHsKCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IGF0dHJpYnV0ZSBzZWxlY3RvcnMgYXJlIHF1b3RlZAoJCQkJZXhwciA9IGV4cHIucmVwbGFjZSggcmF0dHJpYnV0ZVF1b3RlcywgIj0nJDEnXSIgKTsKCgkJCQkvLyByYnVnZ3lNYXRjaGVzIGFsd2F5cyBjb250YWlucyA6YWN0aXZlLCBzbyBubyBuZWVkIGZvciBhbiBleGlzdGVuY2UgY2hlY2sKCQkJCWlmICggIWlzWE1MKCBlbGVtICkgJiYgIXJidWdneU1hdGNoZXMudGVzdCggZXhwciApICYmICghcmJ1Z2d5UVNBIHx8ICFyYnVnZ3lRU0EudGVzdCggZXhwciApKSApIHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgcmV0ID0gbWF0Y2hlcy5jYWxsKCBlbGVtLCBleHByICk7CgoJCQkJCQkvLyBJRSA5J3MgbWF0Y2hlc1NlbGVjdG9yIHJldHVybnMgZmFsc2Ugb24gZGlzY29ubmVjdGVkIG5vZGVzCgkJCQkJCWlmICggcmV0IHx8IGRpc2Nvbm5lY3RlZE1hdGNoIHx8CgkJCQkJCQkJLy8gQXMgd2VsbCwgZGlzY29ubmVjdGVkIG5vZGVzIGFyZSBzYWlkIHRvIGJlIGluIGEgZG9jdW1lbnQKCQkJCQkJCQkvLyBmcmFnbWVudCBpbiBJRSA5CgkJCQkJCQkJZWxlbS5kb2N1bWVudCAmJiBlbGVtLmRvY3VtZW50Lm5vZGVUeXBlICE9PSAxMSApIHsKCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0KCQkJCQl9IGNhdGNoKGUpIHt9CgkJCQl9CgoJCQkJcmV0dXJuIFNpenpsZSggZXhwciwgbnVsbCwgbnVsbCwgWyBlbGVtIF0gKS5sZW5ndGggPiAwOwoJCQl9OwoJCX0KCX0pKCk7Cn0KCi8vIE92ZXJyaWRlIHNpenpsZSBhdHRyaWJ1dGUgcmV0cmlldmFsClNpenpsZS5hdHRyID0galF1ZXJ5LmF0dHI7CmpRdWVyeS5maW5kID0gU2l6emxlOwpqUXVlcnkuZXhwciA9IFNpenpsZS5zZWxlY3RvcnM7CmpRdWVyeS5leHByWyI6Il0gPSBqUXVlcnkuZXhwci5wc2V1ZG9zOwpqUXVlcnkudW5pcXVlID0gU2l6emxlLnVuaXF1ZVNvcnQ7CmpRdWVyeS50ZXh0ID0gU2l6emxlLmdldFRleHQ7CmpRdWVyeS5pc1hNTERvYyA9IFNpenpsZS5pc1hNTDsKalF1ZXJ5LmNvbnRhaW5zID0gU2l6emxlLmNvbnRhaW5zOwoKCn0pKCB3aW5kb3cgKTsKdmFyIHJ1bnRpbCA9IC9VbnRpbCQvLAoJcnBhcmVudHNwcmV2ID0gL14oPzpwYXJlbnRzfHByZXYoPzpVbnRpbHxBbGwpKS8sCglpc1NpbXBsZSA9IC9eLlteOiNcW1wuLF0qJC8sCglybmVlZHNDb250ZXh0ID0galF1ZXJ5LmV4cHIubWF0Y2gubmVlZHNDb250ZXh0LAoJLy8gbWV0aG9kcyBndWFyYW50ZWVkIHRvIHByb2R1Y2UgYSB1bmlxdWUgc2V0IHdoZW4gc3RhcnRpbmcgZnJvbSBhIHVuaXF1ZSBzZXQKCWd1YXJhbnRlZWRVbmlxdWUgPSB7CgkJY2hpbGRyZW46IHRydWUsCgkJY29udGVudHM6IHRydWUsCgkJbmV4dDogdHJ1ZSwKCQlwcmV2OiB0cnVlCgl9OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglmaW5kOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGksIGwsIGxlbmd0aCwgbiwgciwgcmV0LAoJCQlzZWxmID0gdGhpczsKCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4galF1ZXJ5KCBzZWxlY3RvciApLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCWZvciAoIGkgPSAwLCBsID0gc2VsZi5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJaWYgKCBqUXVlcnkuY29udGFpbnMoIHNlbGZbIGkgXSwgdGhpcyApICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0ID0gdGhpcy5wdXNoU3RhY2soICIiLCAiZmluZCIsIHNlbGVjdG9yICk7CgoJCWZvciAoIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCWxlbmd0aCA9IHJldC5sZW5ndGg7CgkJCWpRdWVyeS5maW5kKCBzZWxlY3RvciwgdGhpc1tpXSwgcmV0ICk7CgoJCQlpZiAoIGkgPiAwICkgewoJCQkJLy8gTWFrZSBzdXJlIHRoYXQgdGhlIHJlc3VsdHMgYXJlIHVuaXF1ZQoJCQkJZm9yICggbiA9IGxlbmd0aDsgbiA8IHJldC5sZW5ndGg7IG4rKyApIHsKCQkJCQlmb3IgKCByID0gMDsgciA8IGxlbmd0aDsgcisrICkgewoJCQkJCQlpZiAoIHJldFtyXSA9PT0gcmV0W25dICkgewoJCQkJCQkJcmV0LnNwbGljZShuLS0sIDEpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCWhhczogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgaSwKCQkJdGFyZ2V0cyA9IGpRdWVyeSggdGFyZ2V0LCB0aGlzICksCgkJCWxlbiA9IHRhcmdldHMubGVuZ3RoOwoKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggdGhpcywgdGFyZ2V0c1tpXSApICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQl9CgkJfSk7Cgl9LAoKCW5vdDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggd2lubm93KHRoaXMsIHNlbGVjdG9yLCBmYWxzZSksICJub3QiLCBzZWxlY3Rvcik7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggd2lubm93KHRoaXMsIHNlbGVjdG9yLCB0cnVlKSwgImZpbHRlciIsIHNlbGVjdG9yICk7Cgl9LAoKCWlzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuICEhc2VsZWN0b3IgJiYgKAoJCQl0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciID8KCQkJCS8vIElmIHRoaXMgaXMgYSBwb3NpdGlvbmFsL3JlbGF0aXZlIHNlbGVjdG9yLCBjaGVjayBtZW1iZXJzaGlwIGluIHRoZSByZXR1cm5lZCBzZXQKCQkJCS8vIHNvICQoInA6Zmlyc3QiKS5pcygicDpsYXN0Iikgd29uJ3QgcmV0dXJuIHRydWUgZm9yIGEgZG9jIHdpdGggdHdvICJwIi4KCQkJCXJuZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSA/CgkJCQkJalF1ZXJ5KCBzZWxlY3RvciwgdGhpcy5jb250ZXh0ICkuaW5kZXgoIHRoaXNbMF0gKSA+PSAwIDoKCQkJCQlqUXVlcnkuZmlsdGVyKCBzZWxlY3RvciwgdGhpcyApLmxlbmd0aCA+IDAgOgoJCQkJdGhpcy5maWx0ZXIoIHNlbGVjdG9yICkubGVuZ3RoID4gMCApOwoJfSwKCgljbG9zZXN0OiBmdW5jdGlvbiggc2VsZWN0b3JzLCBjb250ZXh0ICkgewoJCXZhciBjdXIsCgkJCWkgPSAwLAoJCQlsID0gdGhpcy5sZW5ndGgsCgkJCXJldCA9IFtdLAoJCQlwb3MgPSBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9ycyApIHx8IHR5cGVvZiBzZWxlY3RvcnMgIT09ICJzdHJpbmciID8KCQkJCWpRdWVyeSggc2VsZWN0b3JzLCBjb250ZXh0IHx8IHRoaXMuY29udGV4dCApIDoKCQkJCTA7CgoJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJY3VyID0gdGhpc1tpXTsKCgkJCXdoaWxlICggY3VyICYmIGN1ci5vd25lckRvY3VtZW50ICYmIGN1ciAhPT0gY29udGV4dCAmJiBjdXIubm9kZVR5cGUgIT09IDExICkgewoJCQkJaWYgKCBwb3MgPyBwb3MuaW5kZXgoY3VyKSA+IC0xIDogalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGN1ciwgc2VsZWN0b3JzKSApIHsKCQkJCQlyZXQucHVzaCggY3VyICk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCQljdXIgPSBjdXIucGFyZW50Tm9kZTsKCQkJfQoJCX0KCgkJcmV0ID0gcmV0Lmxlbmd0aCA+IDEgPyBqUXVlcnkudW5pcXVlKCByZXQgKSA6IHJldDsKCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQsICJjbG9zZXN0Iiwgc2VsZWN0b3JzICk7Cgl9LAoKCS8vIERldGVybWluZSB0aGUgcG9zaXRpb24gb2YgYW4gZWxlbWVudCB3aXRoaW4KCS8vIHRoZSBtYXRjaGVkIHNldCBvZiBlbGVtZW50cwoJaW5kZXg6IGZ1bmN0aW9uKCBlbGVtICkgewoKCQkvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAoJCWlmICggIWVsZW0gKSB7CgkJCXJldHVybiAoIHRoaXNbMF0gJiYgdGhpc1swXS5wYXJlbnROb2RlICkgPyB0aGlzLnByZXZBbGwoKS5sZW5ndGggOiAtMTsKCQl9CgoJCS8vIGluZGV4IGluIHNlbGVjdG9yCgkJaWYgKCB0eXBlb2YgZWxlbSA9PT0gInN0cmluZyIgKSB7CgkJCXJldHVybiBqUXVlcnkuaW5BcnJheSggdGhpc1swXSwgalF1ZXJ5KCBlbGVtICkgKTsKCQl9CgoJCS8vIExvY2F0ZSB0aGUgcG9zaXRpb24gb2YgdGhlIGRlc2lyZWQgZWxlbWVudAoJCXJldHVybiBqUXVlcnkuaW5BcnJheSgKCQkJLy8gSWYgaXQgcmVjZWl2ZXMgYSBqUXVlcnkgb2JqZWN0LCB0aGUgZmlyc3QgZWxlbWVudCBpcyB1c2VkCgkJCWVsZW0uanF1ZXJ5ID8gZWxlbVswXSA6IGVsZW0sIHRoaXMgKTsKCX0sCgoJYWRkOiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJdmFyIHNldCA9IHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgPwoJCQkJalF1ZXJ5KCBzZWxlY3RvciwgY29udGV4dCApIDoKCQkJCWpRdWVyeS5tYWtlQXJyYXkoIHNlbGVjdG9yICYmIHNlbGVjdG9yLm5vZGVUeXBlID8gWyBzZWxlY3RvciBdIDogc2VsZWN0b3IgKSwKCQkJYWxsID0galF1ZXJ5Lm1lcmdlKCB0aGlzLmdldCgpLCBzZXQgKTsKCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBpc0Rpc2Nvbm5lY3RlZCggc2V0WzBdICkgfHwgaXNEaXNjb25uZWN0ZWQoIGFsbFswXSApID8KCQkJYWxsIDoKCQkJalF1ZXJ5LnVuaXF1ZSggYWxsICkgKTsKCX0sCgoJYWRkQmFjazogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLmFkZCggc2VsZWN0b3IgPT0gbnVsbCA/CgkJCXRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoc2VsZWN0b3IpCgkJKTsKCX0KfSk7CgpqUXVlcnkuZm4uYW5kU2VsZiA9IGpRdWVyeS5mbi5hZGRCYWNrOwoKLy8gQSBwYWluZnVsbHkgc2ltcGxlIGNoZWNrIHRvIHNlZSBpZiBhbiBlbGVtZW50IGlzIGRpc2Nvbm5lY3RlZAovLyBmcm9tIGEgZG9jdW1lbnQgKHNob3VsZCBiZSBpbXByb3ZlZCwgd2hlcmUgZmVhc2libGUpLgpmdW5jdGlvbiBpc0Rpc2Nvbm5lY3RlZCggbm9kZSApIHsKCXJldHVybiAhbm9kZSB8fCAhbm9kZS5wYXJlbnROb2RlIHx8IG5vZGUucGFyZW50Tm9kZS5ub2RlVHlwZSA9PT0gMTE7Cn0KCmZ1bmN0aW9uIHNpYmxpbmcoIGN1ciwgZGlyICkgewoJZG8gewoJCWN1ciA9IGN1clsgZGlyIF07Cgl9IHdoaWxlICggY3VyICYmIGN1ci5ub2RlVHlwZSAhPT0gMSApOwoKCXJldHVybiBjdXI7Cn0KCmpRdWVyeS5lYWNoKHsKCXBhcmVudDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCQlyZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwoJfSwKCXBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicGFyZW50Tm9kZSIgKTsKCX0sCglwYXJlbnRzVW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInBhcmVudE5vZGUiLCB1bnRpbCApOwoJfSwKCW5leHQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5nKCBlbGVtLCAibmV4dFNpYmxpbmciICk7Cgl9LAoJcHJldjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIHNpYmxpbmcoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7Cgl9LAoJbmV4dEFsbDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJuZXh0U2libGluZyIgKTsKCX0sCglwcmV2QWxsOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIgKTsKCX0sCgluZXh0VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgIm5leHRTaWJsaW5nIiwgdW50aWwgKTsKCX0sCglwcmV2VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIsIHVudGlsICk7Cgl9LAoJc2libGluZ3M6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuc2libGluZyggKCBlbGVtLnBhcmVudE5vZGUgfHwge30gKS5maXJzdENoaWxkLCBlbGVtICk7Cgl9LAoJY2hpbGRyZW46IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuc2libGluZyggZWxlbS5maXJzdENoaWxkICk7Cgl9LAoJY29udGVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpZnJhbWUiICkgPwoJCQllbGVtLmNvbnRlbnREb2N1bWVudCB8fCBlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgOgoJCQlqUXVlcnkubWVyZ2UoIFtdLCBlbGVtLmNoaWxkTm9kZXMgKTsKCX0KfSwgZnVuY3Rpb24oIG5hbWUsIGZuICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggdW50aWwsIHNlbGVjdG9yICkgewoJCXZhciByZXQgPSBqUXVlcnkubWFwKCB0aGlzLCBmbiwgdW50aWwgKTsKCgkJaWYgKCAhcnVudGlsLnRlc3QoIG5hbWUgKSApIHsKCQkJc2VsZWN0b3IgPSB1bnRpbDsKCQl9CgoJCWlmICggc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJcmV0ID0galF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIHJldCApOwoJCX0KCgkJcmV0ID0gdGhpcy5sZW5ndGggPiAxICYmICFndWFyYW50ZWVkVW5pcXVlWyBuYW1lIF0gPyBqUXVlcnkudW5pcXVlKCByZXQgKSA6IHJldDsKCgkJaWYgKCB0aGlzLmxlbmd0aCA+IDEgJiYgcnBhcmVudHNwcmV2LnRlc3QoIG5hbWUgKSApIHsKCQkJcmV0ID0gcmV0LnJldmVyc2UoKTsKCQl9CgoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggcmV0LCBuYW1lLCBjb3JlX3NsaWNlLmNhbGwoIGFyZ3VtZW50cyApLmpvaW4oIiwiKSApOwoJfTsKfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCWZpbHRlcjogZnVuY3Rpb24oIGV4cHIsIGVsZW1zLCBub3QgKSB7CgkJaWYgKCBub3QgKSB7CgkJCWV4cHIgPSAiOm5vdCgiICsgZXhwciArICIpIjsKCQl9CgoJCXJldHVybiBlbGVtcy5sZW5ndGggPT09IDEgPwoJCQlqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoZWxlbXNbMF0sIGV4cHIpID8gWyBlbGVtc1swXSBdIDogW10gOgoJCQlqUXVlcnkuZmluZC5tYXRjaGVzKGV4cHIsIGVsZW1zKTsKCX0sCgoJZGlyOiBmdW5jdGlvbiggZWxlbSwgZGlyLCB1bnRpbCApIHsKCQl2YXIgbWF0Y2hlZCA9IFtdLAoJCQljdXIgPSBlbGVtWyBkaXIgXTsKCgkJd2hpbGUgKCBjdXIgJiYgY3VyLm5vZGVUeXBlICE9PSA5ICYmICh1bnRpbCA9PT0gdW5kZWZpbmVkIHx8IGN1ci5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5KCBjdXIgKS5pcyggdW50aWwgKSkgKSB7CgkJCWlmICggY3VyLm5vZGVUeXBlID09PSAxICkgewoJCQkJbWF0Y2hlZC5wdXNoKCBjdXIgKTsKCQkJfQoJCQljdXIgPSBjdXJbZGlyXTsKCQl9CgkJcmV0dXJuIG1hdGNoZWQ7Cgl9LAoKCXNpYmxpbmc6IGZ1bmN0aW9uKCBuLCBlbGVtICkgewoJCXZhciByID0gW107CgoJCWZvciAoIDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcgKSB7CgkJCWlmICggbi5ub2RlVHlwZSA9PT0gMSAmJiBuICE9PSBlbGVtICkgewoJCQkJci5wdXNoKCBuICk7CgkJCX0KCQl9CgoJCXJldHVybiByOwoJfQp9KTsKCi8vIEltcGxlbWVudCB0aGUgaWRlbnRpY2FsIGZ1bmN0aW9uYWxpdHkgZm9yIGZpbHRlciBhbmQgbm90CmZ1bmN0aW9uIHdpbm5vdyggZWxlbWVudHMsIHF1YWxpZmllciwga2VlcCApIHsKCgkvLyBDYW4ndCBwYXNzIG51bGwgb3IgdW5kZWZpbmVkIHRvIGluZGV4T2YgaW4gRmlyZWZveCA0CgkvLyBTZXQgdG8gMCB0byBza2lwIHN0cmluZyBjaGVjawoJcXVhbGlmaWVyID0gcXVhbGlmaWVyIHx8IDA7CgoJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcXVhbGlmaWVyICkgKSB7CgkJcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJdmFyIHJldFZhbCA9ICEhcXVhbGlmaWVyLmNhbGwoIGVsZW0sIGksIGVsZW0gKTsKCQkJcmV0dXJuIHJldFZhbCA9PT0ga2VlcDsKCQl9KTsKCgl9IGVsc2UgaWYgKCBxdWFsaWZpZXIubm9kZVR5cGUgKSB7CgkJcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJcmV0dXJuICggZWxlbSA9PT0gcXVhbGlmaWVyICkgPT09IGtlZXA7CgkJfSk7CgoJfSBlbHNlIGlmICggdHlwZW9mIHF1YWxpZmllciA9PT0gInN0cmluZyIgKSB7CgkJdmFyIGZpbHRlcmVkID0galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMTsKCQl9KTsKCgkJaWYgKCBpc1NpbXBsZS50ZXN0KCBxdWFsaWZpZXIgKSApIHsKCQkJcmV0dXJuIGpRdWVyeS5maWx0ZXIocXVhbGlmaWVyLCBmaWx0ZXJlZCwgIWtlZXApOwoJCX0gZWxzZSB7CgkJCXF1YWxpZmllciA9IGpRdWVyeS5maWx0ZXIoIHF1YWxpZmllciwgZmlsdGVyZWQgKTsKCQl9Cgl9CgoJcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQlyZXR1cm4gKCBqUXVlcnkuaW5BcnJheSggZWxlbSwgcXVhbGlmaWVyICkgPj0gMCApID09PSBrZWVwOwoJfSk7Cn0KZnVuY3Rpb24gY3JlYXRlU2FmZUZyYWdtZW50KCBkb2N1bWVudCApIHsKCXZhciBsaXN0ID0gbm9kZU5hbWVzLnNwbGl0KCAifCIgKSwKCXNhZmVGcmFnID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCWlmICggc2FmZUZyYWcuY3JlYXRlRWxlbWVudCApIHsKCQl3aGlsZSAoIGxpc3QubGVuZ3RoICkgewoJCQlzYWZlRnJhZy5jcmVhdGVFbGVtZW50KAoJCQkJbGlzdC5wb3AoKQoJCQkpOwoJCX0KCX0KCXJldHVybiBzYWZlRnJhZzsKfQoKdmFyIG5vZGVOYW1lcyA9ICJhYmJyfGFydGljbGV8YXNpZGV8YXVkaW98YmRpfGNhbnZhc3xkYXRhfGRhdGFsaXN0fGRldGFpbHN8ZmlnY2FwdGlvbnxmaWd1cmV8Zm9vdGVyfCIgKwoJCSJoZWFkZXJ8aGdyb3VwfG1hcmt8bWV0ZXJ8bmF2fG91dHB1dHxwcm9ncmVzc3xzZWN0aW9ufHN1bW1hcnl8dGltZXx2aWRlbyIsCglyaW5saW5lalF1ZXJ5ID0gLyBqUXVlcnlcZCs9Iig/Om51bGx8XGQrKSIvZywKCXJsZWFkaW5nV2hpdGVzcGFjZSA9IC9eXHMrLywKCXJ4aHRtbFRhZyA9IC88KD8hYXJlYXxicnxjb2x8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbSkoKFtcdzpdKylbXj5dKilcLz4vZ2ksCglydGFnTmFtZSA9IC88KFtcdzpdKykvLAoJcnRib2R5ID0gLzx0Ym9keS9pLAoJcmh0bWwgPSAvPHwmIz9cdys7LywKCXJub0lubmVyaHRtbCA9IC88KD86c2NyaXB0fHN0eWxlfGxpbmspL2ksCglybm9jYWNoZSA9IC88KD86c2NyaXB0fG9iamVjdHxlbWJlZHxvcHRpb258c3R5bGUpL2ksCglybm9zaGltY2FjaGUgPSBuZXcgUmVnRXhwKCI8KD86IiArIG5vZGVOYW1lcyArICIpW1xccy8+XSIsICJpIiksCglyY2hlY2thYmxlVHlwZSA9IC9eKD86Y2hlY2tib3h8cmFkaW8pJC8sCgkvLyBjaGVja2VkPSJjaGVja2VkIiBvciBjaGVja2VkCglyY2hlY2tlZCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLAoJcnNjcmlwdFR5cGUgPSAvXC8oamF2YXxlY21hKXNjcmlwdC9pLAoJcmNsZWFuU2NyaXB0ID0gL15ccyo8ISg/OlxbQ0RBVEFcW3xcLVwtKXxbXF1cLV17Mn0+XHMqJC9nLAoJd3JhcE1hcCA9IHsKCQlvcHRpb246IFsgMSwgIjxzZWxlY3QgbXVsdGlwbGU9J211bHRpcGxlJz4iLCAiPC9zZWxlY3Q+IiBdLAoJCWxlZ2VuZDogWyAxLCAiPGZpZWxkc2V0PiIsICI8L2ZpZWxkc2V0PiIgXSwKCQl0aGVhZDogWyAxLCAiPHRhYmxlPiIsICI8L3RhYmxlPiIgXSwKCQl0cjogWyAyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiIgXSwKCQl0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwKCQljb2w6IFsgMiwgIjx0YWJsZT48dGJvZHk+PC90Ym9keT48Y29sZ3JvdXA+IiwgIjwvY29sZ3JvdXA+PC90YWJsZT4iIF0sCgkJYXJlYTogWyAxLCAiPG1hcD4iLCAiPC9tYXA+IiBdLAoJCV9kZWZhdWx0OiBbIDAsICIiLCAiIiBdCgl9LAoJc2FmZUZyYWdtZW50ID0gY3JlYXRlU2FmZUZyYWdtZW50KCBkb2N1bWVudCApLAoJZnJhZ21lbnREaXYgPSBzYWZlRnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpICk7Cgp3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247CndyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CndyYXBNYXAudGggPSB3cmFwTWFwLnRkOwoKLy8gSUU2LTggY2FuJ3Qgc2VyaWFsaXplIGxpbmssIHNjcmlwdCwgc3R5bGUsIG9yIGFueSBodG1sNSAoTm9TY29wZSkgdGFncywKLy8gdW5sZXNzIHdyYXBwZWQgaW4gYSBkaXYgd2l0aCBub24tYnJlYWtpbmcgY2hhcmFjdGVycyBpbiBmcm9udCBvZiBpdC4KaWYgKCAhalF1ZXJ5LnN1cHBvcnQuaHRtbFNlcmlhbGl6ZSApIHsKCXdyYXBNYXAuX2RlZmF1bHQgPSBbIDEsICJYPGRpdj4iLCAiPC9kaXY+IiBdOwp9CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXRleHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoJCQlyZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/CgkJCQlqUXVlcnkudGV4dCggdGhpcyApIDoKCQkJCXRoaXMuZW1wdHkoKS5hcHBlbmQoICggdGhpc1swXSAmJiB0aGlzWzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQgKS5jcmVhdGVUZXh0Tm9kZSggdmFsdWUgKSApOwoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7Cgl9LAoKCXdyYXBBbGw6IGZ1bmN0aW9uKCBodG1sICkgewoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CgkJCQlqUXVlcnkodGhpcykud3JhcEFsbCggaHRtbC5jYWxsKHRoaXMsIGkpICk7CgkJCX0pOwoJCX0KCgkJaWYgKCB0aGlzWzBdICkgewoJCQkvLyBUaGUgZWxlbWVudHMgdG8gd3JhcCB0aGUgdGFyZ2V0IGFyb3VuZAoJCQl2YXIgd3JhcCA9IGpRdWVyeSggaHRtbCwgdGhpc1swXS5vd25lckRvY3VtZW50ICkuZXEoMCkuY2xvbmUodHJ1ZSk7CgoJCQlpZiAoIHRoaXNbMF0ucGFyZW50Tm9kZSApIHsKCQkJCXdyYXAuaW5zZXJ0QmVmb3JlKCB0aGlzWzBdICk7CgkJCX0KCgkJCXdyYXAubWFwKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSB0aGlzOwoKCQkJCXdoaWxlICggZWxlbS5maXJzdENoaWxkICYmIGVsZW0uZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQllbGVtID0gZWxlbS5maXJzdENoaWxkOwoJCQkJfQoKCQkJCXJldHVybiBlbGVtOwoJCQl9KS5hcHBlbmQoIHRoaXMgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgl3cmFwSW5uZXI6IGZ1bmN0aW9uKCBodG1sICkgewoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CgkJCQlqUXVlcnkodGhpcykud3JhcElubmVyKCBodG1sLmNhbGwodGhpcywgaSkgKTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IGpRdWVyeSggdGhpcyApLAoJCQkJY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CgoJCQlpZiAoIGNvbnRlbnRzLmxlbmd0aCApIHsKCQkJCWNvbnRlbnRzLndyYXBBbGwoIGh0bWwgKTsKCgkJCX0gZWxzZSB7CgkJCQlzZWxmLmFwcGVuZCggaHRtbCApOwoJCQl9CgkJfSk7Cgl9LAoKCXdyYXA6IGZ1bmN0aW9uKCBodG1sICkgewoJCXZhciBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKTsKCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CgkJCWpRdWVyeSggdGhpcyApLndyYXBBbGwoIGlzRnVuY3Rpb24gPyBodG1sLmNhbGwodGhpcywgaSkgOiBodG1sICk7CgkJfSk7Cgl9LAoKCXVud3JhcDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzLCAiYm9keSIgKSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnJlcGxhY2VXaXRoKCB0aGlzLmNoaWxkTm9kZXMgKTsKCQkJfQoJCX0pLmVuZCgpOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgdHJ1ZSwgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWlmICggdGhpcy5ub2RlVHlwZSA9PT0gMSB8fCB0aGlzLm5vZGVUeXBlID09PSAxMSApIHsKCQkJCXRoaXMuYXBwZW5kQ2hpbGQoIGVsZW0gKTsKCQkJfQoJCX0pOwoJfSwKCglwcmVwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIHRydWUsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgKSB7CgkJCQl0aGlzLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5maXJzdENoaWxkICk7CgkJCX0KCQl9KTsKCX0sCgoJYmVmb3JlOiBmdW5jdGlvbigpIHsKCQlpZiAoICFpc0Rpc2Nvbm5lY3RlZCggdGhpc1swXSApICkgewoJCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZhbHNlLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMgKTsKCQkJfSk7CgkJfQoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXZhciBzZXQgPSBqUXVlcnkuY2xlYW4oIGFyZ3VtZW50cyApOwoJCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tZXJnZSggc2V0LCB0aGlzICksICJiZWZvcmUiLCB0aGlzLnNlbGVjdG9yICk7CgkJfQoJfSwKCglhZnRlcjogZnVuY3Rpb24oKSB7CgkJaWYgKCAhaXNEaXNjb25uZWN0ZWQoIHRoaXNbMF0gKSApIHsKCQkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmYWxzZSwgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzLm5leHRTaWJsaW5nICk7CgkJCX0pOwoJCX0KCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl2YXIgc2V0ID0galF1ZXJ5LmNsZWFuKCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkubWVyZ2UoIHRoaXMsIHNldCApLCAiYWZ0ZXIiLCB0aGlzLnNlbGVjdG9yICk7CgkJfQoJfSwKCgkvLyBrZWVwRGF0YSBpcyBmb3IgaW50ZXJuYWwgdXNlIG9ubHktLWRvIG5vdCBkb2N1bWVudAoJcmVtb3ZlOiBmdW5jdGlvbiggc2VsZWN0b3IsIGtlZXBEYXRhICkgewoJCXZhciBlbGVtLAoJCQlpID0gMDsKCgkJZm9yICggOyAoZWxlbSA9IHRoaXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJaWYgKCAhc2VsZWN0b3IgfHwgalF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIFsgZWxlbSBdICkubGVuZ3RoICkgewoJCQkJaWYgKCAha2VlcERhdGEgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQlqUXVlcnkuY2xlYW5EYXRhKCBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgKTsKCQkJCQlqUXVlcnkuY2xlYW5EYXRhKCBbIGVsZW0gXSApOwoJCQkJfQoKCQkJCWlmICggZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCWVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggZWxlbSApOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtLAoJCQlpID0gMDsKCgkJZm9yICggOyAoZWxlbSA9IHRoaXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJLy8gUmVtb3ZlIGVsZW1lbnQgbm9kZXMgYW5kIHByZXZlbnQgbWVtb3J5IGxlYWtzCgkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCWpRdWVyeS5jbGVhbkRhdGEoIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSApOwoJCQl9CgoJCQkvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2RlcwoJCQl3aGlsZSAoIGVsZW0uZmlyc3RDaGlsZCApIHsKCQkJCWVsZW0ucmVtb3ZlQ2hpbGQoIGVsZW0uZmlyc3RDaGlsZCApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2xvbmU6IGZ1bmN0aW9uKCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQlkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOwoJCWRlZXBEYXRhQW5kRXZlbnRzID0gZGVlcERhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGRhdGFBbmRFdmVudHMgOiBkZWVwRGF0YUFuZEV2ZW50czsKCgkJcmV0dXJuIHRoaXMubWFwKCBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBqUXVlcnkuY2xvbmUoIHRoaXMsIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICk7CgkJfSk7Cgl9LAoKCWh0bWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgZWxlbSA9IHRoaXNbMF0gfHwge30sCgkJCQlpID0gMCwKCQkJCWwgPSB0aGlzLmxlbmd0aDsKCgkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxID8KCQkJCQllbGVtLmlubmVySFRNTC5yZXBsYWNlKCByaW5saW5lalF1ZXJ5LCAiIiApIDoKCQkJCQl1bmRlZmluZWQ7CgkJCX0KCgkJCS8vIFNlZSBpZiB3ZSBjYW4gdGFrZSBhIHNob3J0Y3V0IGFuZCBqdXN0IHVzZSBpbm5lckhUTUwKCQkJaWYgKCB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmICFybm9Jbm5lcmh0bWwudGVzdCggdmFsdWUgKSAmJgoJCQkJKCBqUXVlcnkuc3VwcG9ydC5odG1sU2VyaWFsaXplIHx8ICFybm9zaGltY2FjaGUudGVzdCggdmFsdWUgKSAgKSAmJgoJCQkJKCBqUXVlcnkuc3VwcG9ydC5sZWFkaW5nV2hpdGVzcGFjZSB8fCAhcmxlYWRpbmdXaGl0ZXNwYWNlLnRlc3QoIHZhbHVlICkgKSAmJgoJCQkJIXdyYXBNYXBbICggcnRhZ05hbWUuZXhlYyggdmFsdWUgKSB8fCBbIiIsICIiXSApWzFdLnRvTG93ZXJDYXNlKCkgXSApIHsKCgkJCQl2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoIHJ4aHRtbFRhZywgIjwkMT48LyQyPiIgKTsKCgkJCQl0cnkgewoJCQkJCWZvciAoOyBpIDwgbDsgaSsrICkgewoJCQkJCQkvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKCQkJCQkJZWxlbSA9IHRoaXNbaV0gfHwge307CgkJCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJCWpRdWVyeS5jbGVhbkRhdGEoIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoICIqIiApICk7CgkJCQkJCQllbGVtLmlubmVySFRNTCA9IHZhbHVlOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQllbGVtID0gMDsKCgkJCQkvLyBJZiB1c2luZyBpbm5lckhUTUwgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgdXNlIHRoZSBmYWxsYmFjayBtZXRob2QKCQkJCX0gY2F0Y2goZSkge30KCQkJfQoKCQkJaWYgKCBlbGVtICkgewoJCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggdmFsdWUgKTsKCQkJfQoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7Cgl9LAoKCXJlcGxhY2VXaXRoOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJaWYgKCAhaXNEaXNjb25uZWN0ZWQoIHRoaXNbMF0gKSApIHsKCQkJLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGVsZW1lbnRzIGFyZSByZW1vdmVkIGZyb20gdGhlIERPTSBiZWZvcmUgdGhleSBhcmUgaW5zZXJ0ZWQKCQkJLy8gdGhpcyBjYW4gaGVscCBmaXggcmVwbGFjaW5nIGEgcGFyZW50IHdpdGggY2hpbGQgZWxlbWVudHMKCQkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJCXZhciBzZWxmID0galF1ZXJ5KHRoaXMpLCBvbGQgPSBzZWxmLmh0bWwoKTsKCQkJCQlzZWxmLnJlcGxhY2VXaXRoKCB2YWx1ZS5jYWxsKCB0aGlzLCBpLCBvbGQgKSApOwoJCQkJfSk7CgkJCX0KCgkJCWlmICggdHlwZW9mIHZhbHVlICE9PSAic3RyaW5nIiApIHsKCQkJCXZhbHVlID0galF1ZXJ5KCB2YWx1ZSApLmRldGFjaCgpOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIG5leHQgPSB0aGlzLm5leHRTaWJsaW5nLAoJCQkJCXBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKCgkJCQlqUXVlcnkoIHRoaXMgKS5yZW1vdmUoKTsKCgkJCQlpZiAoIG5leHQgKSB7CgkJCQkJalF1ZXJ5KG5leHQpLmJlZm9yZSggdmFsdWUgKTsKCQkJCX0gZWxzZSB7CgkJCQkJalF1ZXJ5KHBhcmVudCkuYXBwZW5kKCB2YWx1ZSApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiB0aGlzLmxlbmd0aCA/CgkJCXRoaXMucHVzaFN0YWNrKCBqUXVlcnkoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlKSwgInJlcGxhY2VXaXRoIiwgdmFsdWUgKSA6CgkJCXRoaXM7Cgl9LAoKCWRldGFjaDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLnJlbW92ZSggc2VsZWN0b3IsIHRydWUgKTsKCX0sCgoJZG9tTWFuaXA6IGZ1bmN0aW9uKCBhcmdzLCB0YWJsZSwgY2FsbGJhY2sgKSB7CgoJCS8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMKCQlhcmdzID0gW10uY29uY2F0LmFwcGx5KCBbXSwgYXJncyApOwoKCQl2YXIgcmVzdWx0cywgZmlyc3QsIGZyYWdtZW50LCBpTm9DbG9uZSwKCQkJaSA9IDAsCgkJCXZhbHVlID0gYXJnc1swXSwKCQkJc2NyaXB0cyA9IFtdLAoJCQlsID0gdGhpcy5sZW5ndGg7CgoJCS8vIFdlIGNhbid0IGNsb25lTm9kZSBmcmFnbWVudHMgdGhhdCBjb250YWluIGNoZWNrZWQsIGluIFdlYktpdAoJCWlmICggIWpRdWVyeS5zdXBwb3J0LmNoZWNrQ2xvbmUgJiYgbCA+IDEgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiByY2hlY2tlZC50ZXN0KCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5KHRoaXMpLmRvbU1hbmlwKCBhcmdzLCB0YWJsZSwgY2FsbGJhY2sgKTsKCQkJfSk7CgkJfQoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CgkJCQl2YXIgc2VsZiA9IGpRdWVyeSh0aGlzKTsKCQkJCWFyZ3NbMF0gPSB2YWx1ZS5jYWxsKCB0aGlzLCBpLCB0YWJsZSA/IHNlbGYuaHRtbCgpIDogdW5kZWZpbmVkICk7CgkJCQlzZWxmLmRvbU1hbmlwKCBhcmdzLCB0YWJsZSwgY2FsbGJhY2sgKTsKCQkJfSk7CgkJfQoKCQlpZiAoIHRoaXNbMF0gKSB7CgkJCXJlc3VsdHMgPSBqUXVlcnkuYnVpbGRGcmFnbWVudCggYXJncywgdGhpcywgc2NyaXB0cyApOwoJCQlmcmFnbWVudCA9IHJlc3VsdHMuZnJhZ21lbnQ7CgkJCWZpcnN0ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCgkJCWlmICggZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgKSB7CgkJCQlmcmFnbWVudCA9IGZpcnN0OwoJCQl9CgoJCQlpZiAoIGZpcnN0ICkgewoJCQkJdGFibGUgPSB0YWJsZSAmJiBqUXVlcnkubm9kZU5hbWUoIGZpcnN0LCAidHIiICk7CgoJCQkJLy8gVXNlIHRoZSBvcmlnaW5hbCBmcmFnbWVudCBmb3IgdGhlIGxhc3QgaXRlbSBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBiZWNhdXNlIGl0IGNhbiBlbmQgdXAKCQkJCS8vIGJlaW5nIGVtcHRpZWQgaW5jb3JyZWN0bHkgaW4gY2VydGFpbiBzaXR1YXRpb25zICgjODA3MCkuCgkJCQkvLyBGcmFnbWVudHMgZnJvbSB0aGUgZnJhZ21lbnQgY2FjaGUgbXVzdCBhbHdheXMgYmUgY2xvbmVkIGFuZCBuZXZlciB1c2VkIGluIHBsYWNlLgoJCQkJZm9yICggaU5vQ2xvbmUgPSByZXN1bHRzLmNhY2hlYWJsZSB8fCBsIC0gMTsgaSA8IGw7IGkrKyApIHsKCQkJCQljYWxsYmFjay5jYWxsKAoJCQkJCQl0YWJsZSAmJiBqUXVlcnkubm9kZU5hbWUoIHRoaXNbaV0sICJ0YWJsZSIgKSA/CgkJCQkJCQlmaW5kT3JBcHBlbmQoIHRoaXNbaV0sICJ0Ym9keSIgKSA6CgkJCQkJCQl0aGlzW2ldLAoJCQkJCQlpID09PSBpTm9DbG9uZSA/CgkJCQkJCQlmcmFnbWVudCA6CgkJCQkJCQlqUXVlcnkuY2xvbmUoIGZyYWdtZW50LCB0cnVlLCB0cnVlICkKCQkJCQkpOwoJCQkJfQoJCQl9CgoJCQkvLyBGaXggIzExODA5OiBBdm9pZCBsZWFraW5nIG1lbW9yeQoJCQlmcmFnbWVudCA9IGZpcnN0ID0gbnVsbDsKCgkJCWlmICggc2NyaXB0cy5sZW5ndGggKSB7CgkJCQlqUXVlcnkuZWFjaCggc2NyaXB0cywgZnVuY3Rpb24oIGksIGVsZW0gKSB7CgkJCQkJaWYgKCBlbGVtLnNyYyApIHsKCQkJCQkJaWYgKCBqUXVlcnkuYWpheCApIHsKCQkJCQkJCWpRdWVyeS5hamF4KHsKCQkJCQkJCQl1cmw6IGVsZW0uc3JjLAoJCQkJCQkJCXR5cGU6ICJHRVQiLAoJCQkJCQkJCWRhdGFUeXBlOiAic2NyaXB0IiwKCQkJCQkJCQlhc3luYzogZmFsc2UsCgkJCQkJCQkJZ2xvYmFsOiBmYWxzZSwKCQkJCQkJCQkidGhyb3dzIjogdHJ1ZQoJCQkJCQkJfSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlqUXVlcnkuZXJyb3IoIm5vIGFqYXgiKTsKCQkJCQkJfQoJCQkJCX0gZWxzZSB7CgkJCQkJCWpRdWVyeS5nbG9iYWxFdmFsKCAoIGVsZW0udGV4dCB8fCBlbGVtLnRleHRDb250ZW50IHx8IGVsZW0uaW5uZXJIVE1MIHx8ICIiICkucmVwbGFjZSggcmNsZWFuU2NyaXB0LCAiIiApICk7CgkJCQkJfQoKCQkJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQkJZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBlbGVtICk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfQp9KTsKCmZ1bmN0aW9uIGZpbmRPckFwcGVuZCggZWxlbSwgdGFnICkgewoJcmV0dXJuIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApWzBdIHx8IGVsZW0uYXBwZW5kQ2hpbGQoIGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCB0YWcgKSApOwp9CgpmdW5jdGlvbiBjbG9uZUNvcHlFdmVudCggc3JjLCBkZXN0ICkgewoKCWlmICggZGVzdC5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5Lmhhc0RhdGEoIHNyYyApICkgewoJCXJldHVybjsKCX0KCgl2YXIgdHlwZSwgaSwgbCwKCQlvbGREYXRhID0galF1ZXJ5Ll9kYXRhKCBzcmMgKSwKCQljdXJEYXRhID0galF1ZXJ5Ll9kYXRhKCBkZXN0LCBvbGREYXRhICksCgkJZXZlbnRzID0gb2xkRGF0YS5ldmVudHM7CgoJaWYgKCBldmVudHMgKSB7CgkJZGVsZXRlIGN1ckRhdGEuaGFuZGxlOwoJCWN1ckRhdGEuZXZlbnRzID0ge307CgoJCWZvciAoIHR5cGUgaW4gZXZlbnRzICkgewoJCQlmb3IgKCBpID0gMCwgbCA9IGV2ZW50c1sgdHlwZSBdLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCWpRdWVyeS5ldmVudC5hZGQoIGRlc3QsIHR5cGUsIGV2ZW50c1sgdHlwZSBdWyBpIF0gKTsKCQkJfQoJCX0KCX0KCgkvLyBtYWtlIHRoZSBjbG9uZWQgcHVibGljIGRhdGEgb2JqZWN0IGEgY29weSBmcm9tIHRoZSBvcmlnaW5hbAoJaWYgKCBjdXJEYXRhLmRhdGEgKSB7CgkJY3VyRGF0YS5kYXRhID0galF1ZXJ5LmV4dGVuZCgge30sIGN1ckRhdGEuZGF0YSApOwoJfQp9CgpmdW5jdGlvbiBjbG9uZUZpeEF0dHJpYnV0ZXMoIHNyYywgZGVzdCApIHsKCXZhciBub2RlTmFtZTsKCgkvLyBXZSBkbyBub3QgbmVlZCB0byBkbyBhbnl0aGluZyBmb3Igbm9uLUVsZW1lbnRzCglpZiAoIGRlc3Qubm9kZVR5cGUgIT09IDEgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIGNsZWFyQXR0cmlidXRlcyByZW1vdmVzIHRoZSBhdHRyaWJ1dGVzLCB3aGljaCB3ZSBkb24ndCB3YW50LAoJLy8gYnV0IGFsc28gcmVtb3ZlcyB0aGUgYXR0YWNoRXZlbnQgZXZlbnRzLCB3aGljaCB3ZSAqZG8qIHdhbnQKCWlmICggZGVzdC5jbGVhckF0dHJpYnV0ZXMgKSB7CgkJZGVzdC5jbGVhckF0dHJpYnV0ZXMoKTsKCX0KCgkvLyBtZXJnZUF0dHJpYnV0ZXMsIGluIGNvbnRyYXN0LCBvbmx5IG1lcmdlcyBiYWNrIG9uIHRoZQoJLy8gb3JpZ2luYWwgYXR0cmlidXRlcywgbm90IHRoZSBldmVudHMKCWlmICggZGVzdC5tZXJnZUF0dHJpYnV0ZXMgKSB7CgkJZGVzdC5tZXJnZUF0dHJpYnV0ZXMoIHNyYyApOwoJfQoKCW5vZGVOYW1lID0gZGVzdC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoKCWlmICggbm9kZU5hbWUgPT09ICJvYmplY3QiICkgewoJCS8vIElFNi0xMCBpbXByb3Blcmx5IGNsb25lcyBjaGlsZHJlbiBvZiBvYmplY3QgZWxlbWVudHMgdXNpbmcgY2xhc3NpZC4KCQkvLyBJRTEwIHRocm93cyBOb01vZGlmaWNhdGlvbkFsbG93ZWRFcnJvciBpZiBwYXJlbnQgaXMgbnVsbCwgIzEyMTMyLgoJCWlmICggZGVzdC5wYXJlbnROb2RlICkgewoJCQlkZXN0Lm91dGVySFRNTCA9IHNyYy5vdXRlckhUTUw7CgkJfQoKCQkvLyBUaGlzIHBhdGggYXBwZWFycyB1bmF2b2lkYWJsZSBmb3IgSUU5LiBXaGVuIGNsb25pbmcgYW4gb2JqZWN0CgkJLy8gZWxlbWVudCBpbiBJRTksIHRoZSBvdXRlckhUTUwgc3RyYXRlZ3kgYWJvdmUgaXMgbm90IHN1ZmZpY2llbnQuCgkJLy8gSWYgdGhlIHNyYyBoYXMgaW5uZXJIVE1MIGFuZCB0aGUgZGVzdGluYXRpb24gZG9lcyBub3QsCgkJLy8gY29weSB0aGUgc3JjLmlubmVySFRNTCBpbnRvIHRoZSBkZXN0LmlubmVySFRNTC4gIzEwMzI0CgkJaWYgKCBqUXVlcnkuc3VwcG9ydC5odG1sNUNsb25lICYmIChzcmMuaW5uZXJIVE1MICYmICFqUXVlcnkudHJpbShkZXN0LmlubmVySFRNTCkpICkgewoJCQlkZXN0LmlubmVySFRNTCA9IHNyYy5pbm5lckhUTUw7CgkJfQoKCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiICYmIHJjaGVja2FibGVUeXBlLnRlc3QoIHNyYy50eXBlICkgKSB7CgkJLy8gSUU2LTggZmFpbHMgdG8gcGVyc2lzdCB0aGUgY2hlY2tlZCBzdGF0ZSBvZiBhIGNsb25lZCBjaGVja2JveAoJCS8vIG9yIHJhZGlvIGJ1dHRvbi4gV29yc2UsIElFNi03IGZhaWwgdG8gZ2l2ZSB0aGUgY2xvbmVkIGVsZW1lbnQKCQkvLyBhIGNoZWNrZWQgYXBwZWFyYW5jZSBpZiB0aGUgZGVmYXVsdENoZWNrZWQgdmFsdWUgaXNuJ3QgYWxzbyBzZXQKCgkJZGVzdC5kZWZhdWx0Q2hlY2tlZCA9IGRlc3QuY2hlY2tlZCA9IHNyYy5jaGVja2VkOwoKCQkvLyBJRTYtNyBnZXQgY29uZnVzZWQgYW5kIGVuZCB1cCBzZXR0aW5nIHRoZSB2YWx1ZSBvZiBhIGNsb25lZAoJCS8vIGNoZWNrYm94L3JhZGlvIGJ1dHRvbiB0byBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiAib24iCgkJaWYgKCBkZXN0LnZhbHVlICE9PSBzcmMudmFsdWUgKSB7CgkJCWRlc3QudmFsdWUgPSBzcmMudmFsdWU7CgkJfQoKCS8vIElFNi04IGZhaWxzIHRvIHJldHVybiB0aGUgc2VsZWN0ZWQgb3B0aW9uIHRvIHRoZSBkZWZhdWx0IHNlbGVjdGVkCgkvLyBzdGF0ZSB3aGVuIGNsb25pbmcgb3B0aW9ucwoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJvcHRpb24iICkgewoJCWRlc3Quc2VsZWN0ZWQgPSBzcmMuZGVmYXVsdFNlbGVjdGVkOwoKCS8vIElFNi04IGZhaWxzIHRvIHNldCB0aGUgZGVmYXVsdFZhbHVlIHRvIHRoZSBjb3JyZWN0IHZhbHVlIHdoZW4KCS8vIGNsb25pbmcgb3RoZXIgdHlwZXMgb2YgaW5wdXQgZmllbGRzCgl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIiApIHsKCQlkZXN0LmRlZmF1bHRWYWx1ZSA9IHNyYy5kZWZhdWx0VmFsdWU7CgoJLy8gSUUgYmxhbmtzIGNvbnRlbnRzIHdoZW4gY2xvbmluZyBzY3JpcHRzCgl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gInNjcmlwdCIgJiYgZGVzdC50ZXh0ICE9PSBzcmMudGV4dCApIHsKCQlkZXN0LnRleHQgPSBzcmMudGV4dDsKCX0KCgkvLyBFdmVudCBkYXRhIGdldHMgcmVmZXJlbmNlZCBpbnN0ZWFkIG9mIGNvcGllZCBpZiB0aGUgZXhwYW5kbwoJLy8gZ2V0cyBjb3BpZWQgdG9vCglkZXN0LnJlbW92ZUF0dHJpYnV0ZSggalF1ZXJ5LmV4cGFuZG8gKTsKfQoKalF1ZXJ5LmJ1aWxkRnJhZ21lbnQgPSBmdW5jdGlvbiggYXJncywgY29udGV4dCwgc2NyaXB0cyApIHsKCXZhciBmcmFnbWVudCwgY2FjaGVhYmxlLCBjYWNoZWhpdCwKCQlmaXJzdCA9IGFyZ3NbIDAgXTsKCgkvLyBTZXQgY29udGV4dCBmcm9tIHdoYXQgbWF5IGNvbWUgaW4gYXMgdW5kZWZpbmVkIG9yIGEgalF1ZXJ5IGNvbGxlY3Rpb24gb3IgYSBub2RlCgljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCWNvbnRleHQgPSAoY29udGV4dFswXSB8fCBjb250ZXh0KS5vd25lckRvY3VtZW50IHx8IGNvbnRleHRbMF0gfHwgY29udGV4dDsKCgkvLyBFbnN1cmUgdGhhdCBhbiBhdHRyIG9iamVjdCBkb2Vzbid0IGluY29ycmVjdGx5IHN0YW5kIGluIGFzIGEgZG9jdW1lbnQgb2JqZWN0CgkvLyBDaHJvbWUgYW5kIEZpcmVmb3ggc2VlbSB0byBhbGxvdyB0aGlzIHRvIG9jY3VyIGFuZCB3aWxsIHRocm93IGV4Y2VwdGlvbgoJLy8gRml4ZXMgIzg5NTAKCWlmICggdHlwZW9mIGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJY29udGV4dCA9IGRvY3VtZW50OwoJfQoKCS8vIE9ubHkgY2FjaGUgInNtYWxsIiAoMS8yIEtCKSBIVE1MIHN0cmluZ3MgdGhhdCBhcmUgYXNzb2NpYXRlZCB3aXRoIHRoZSBtYWluIGRvY3VtZW50CgkvLyBDbG9uaW5nIG9wdGlvbnMgbG9zZXMgdGhlIHNlbGVjdGVkIHN0YXRlLCBzbyBkb24ndCBjYWNoZSB0aGVtCgkvLyBJRSA2IGRvZXNuJ3QgbGlrZSBpdCB3aGVuIHlvdSBwdXQgPG9iamVjdD4gb3IgPGVtYmVkPiBlbGVtZW50cyBpbiBhIGZyYWdtZW50CgkvLyBBbHNvLCBXZWJLaXQgZG9lcyBub3QgY2xvbmUgJ2NoZWNrZWQnIGF0dHJpYnV0ZXMgb24gY2xvbmVOb2RlLCBzbyBkb24ndCBjYWNoZQoJLy8gTGFzdGx5LCBJRTYsNyw4IHdpbGwgbm90IGNvcnJlY3RseSByZXVzZSBjYWNoZWQgZnJhZ21lbnRzIHRoYXQgd2VyZSBjcmVhdGVkIGZyb20gdW5rbm93biBlbGVtcyAjMTA1MDEKCWlmICggYXJncy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGZpcnN0ID09PSAic3RyaW5nIiAmJiBmaXJzdC5sZW5ndGggPCA1MTIgJiYgY29udGV4dCA9PT0gZG9jdW1lbnQgJiYKCQlmaXJzdC5jaGFyQXQoMCkgPT09ICI8IiAmJiAhcm5vY2FjaGUudGVzdCggZmlyc3QgKSAmJgoJCShqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lIHx8ICFyY2hlY2tlZC50ZXN0KCBmaXJzdCApKSAmJgoJCShqUXVlcnkuc3VwcG9ydC5odG1sNUNsb25lIHx8ICFybm9zaGltY2FjaGUudGVzdCggZmlyc3QgKSkgKSB7CgoJCS8vIE1hcmsgY2FjaGVhYmxlIGFuZCBsb29rIGZvciBhIGhpdAoJCWNhY2hlYWJsZSA9IHRydWU7CgkJZnJhZ21lbnQgPSBqUXVlcnkuZnJhZ21lbnRzWyBmaXJzdCBdOwoJCWNhY2hlaGl0ID0gZnJhZ21lbnQgIT09IHVuZGVmaW5lZDsKCX0KCglpZiAoICFmcmFnbWVudCApIHsKCQlmcmFnbWVudCA9IGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoJCWpRdWVyeS5jbGVhbiggYXJncywgY29udGV4dCwgZnJhZ21lbnQsIHNjcmlwdHMgKTsKCgkJLy8gVXBkYXRlIHRoZSBjYWNoZSwgYnV0IG9ubHkgc3RvcmUgZmFsc2UKCQkvLyB1bmxlc3MgdGhpcyBpcyBhIHNlY29uZCBwYXJzaW5nIG9mIHRoZSBzYW1lIGNvbnRlbnQKCQlpZiAoIGNhY2hlYWJsZSApIHsKCQkJalF1ZXJ5LmZyYWdtZW50c1sgZmlyc3QgXSA9IGNhY2hlaGl0ICYmIGZyYWdtZW50OwoJCX0KCX0KCglyZXR1cm4geyBmcmFnbWVudDogZnJhZ21lbnQsIGNhY2hlYWJsZTogY2FjaGVhYmxlIH07Cn07CgpqUXVlcnkuZnJhZ21lbnRzID0ge307CgpqUXVlcnkuZWFjaCh7CglhcHBlbmRUbzogImFwcGVuZCIsCglwcmVwZW5kVG86ICJwcmVwZW5kIiwKCWluc2VydEJlZm9yZTogImJlZm9yZSIsCglpbnNlcnRBZnRlcjogImFmdGVyIiwKCXJlcGxhY2VBbGw6ICJyZXBsYWNlV2l0aCIKfSwgZnVuY3Rpb24oIG5hbWUsIG9yaWdpbmFsICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGVsZW1zLAoJCQlpID0gMCwKCQkJcmV0ID0gW10sCgkJCWluc2VydCA9IGpRdWVyeSggc2VsZWN0b3IgKSwKCQkJbCA9IGluc2VydC5sZW5ndGgsCgkJCXBhcmVudCA9IHRoaXMubGVuZ3RoID09PSAxICYmIHRoaXNbMF0ucGFyZW50Tm9kZTsKCgkJaWYgKCAocGFyZW50ID09IG51bGwgfHwgcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSA9PT0gMTEgJiYgcGFyZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxKSAmJiBsID09PSAxICkgewoJCQlpbnNlcnRbIG9yaWdpbmFsIF0oIHRoaXNbMF0gKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQkJZWxlbXMgPSAoIGkgPiAwID8gdGhpcy5jbG9uZSh0cnVlKSA6IHRoaXMgKS5nZXQoKTsKCQkJCWpRdWVyeSggaW5zZXJ0W2ldIClbIG9yaWdpbmFsIF0oIGVsZW1zICk7CgkJCQlyZXQgPSByZXQuY29uY2F0KCBlbGVtcyApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHJldCwgbmFtZSwgaW5zZXJ0LnNlbGVjdG9yICk7CgkJfQoJfTsKfSk7CgpmdW5jdGlvbiBnZXRBbGwoIGVsZW0gKSB7CglpZiAoIHR5cGVvZiBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSAidW5kZWZpbmVkIiApIHsKCQlyZXR1cm4gZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSggIioiICk7CgoJfSBlbHNlIGlmICggdHlwZW9mIGVsZW0ucXVlcnlTZWxlY3RvckFsbCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJcmV0dXJuIGVsZW0ucXVlcnlTZWxlY3RvckFsbCggIioiICk7CgoJfSBlbHNlIHsKCQlyZXR1cm4gW107Cgl9Cn0KCi8vIFVzZWQgaW4gY2xlYW4sIGZpeGVzIHRoZSBkZWZhdWx0Q2hlY2tlZCBwcm9wZXJ0eQpmdW5jdGlvbiBmaXhEZWZhdWx0Q2hlY2tlZCggZWxlbSApIHsKCWlmICggcmNoZWNrYWJsZVR5cGUudGVzdCggZWxlbS50eXBlICkgKSB7CgkJZWxlbS5kZWZhdWx0Q2hlY2tlZCA9IGVsZW0uY2hlY2tlZDsKCX0KfQoKalF1ZXJ5LmV4dGVuZCh7CgljbG9uZTogZnVuY3Rpb24oIGVsZW0sIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICkgewoJCXZhciBzcmNFbGVtZW50cywKCQkJZGVzdEVsZW1lbnRzLAoJCQlpLAoJCQljbG9uZTsKCgkJaWYgKCBqUXVlcnkuc3VwcG9ydC5odG1sNUNsb25lIHx8IGpRdWVyeS5pc1hNTERvYyhlbGVtKSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoICI8IiArIGVsZW0ubm9kZU5hbWUgKyAiPiIgKSApIHsKCQkJY2xvbmUgPSBlbGVtLmNsb25lTm9kZSggdHJ1ZSApOwoKCQkvLyBJRTw9OCBkb2VzIG5vdCBwcm9wZXJseSBjbG9uZSBkZXRhY2hlZCwgdW5rbm93biBlbGVtZW50IG5vZGVzCgkJfSBlbHNlIHsKCQkJZnJhZ21lbnREaXYuaW5uZXJIVE1MID0gZWxlbS5vdXRlckhUTUw7CgkJCWZyYWdtZW50RGl2LnJlbW92ZUNoaWxkKCBjbG9uZSA9IGZyYWdtZW50RGl2LmZpcnN0Q2hpbGQgKTsKCQl9CgoJCWlmICggKCFqUXVlcnkuc3VwcG9ydC5ub0Nsb25lRXZlbnQgfHwgIWpRdWVyeS5zdXBwb3J0Lm5vQ2xvbmVDaGVja2VkKSAmJgoJCQkJKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgZWxlbS5ub2RlVHlwZSA9PT0gMTEpICYmICFqUXVlcnkuaXNYTUxEb2MoZWxlbSkgKSB7CgkJCS8vIElFIGNvcGllcyBldmVudHMgYm91bmQgdmlhIGF0dGFjaEV2ZW50IHdoZW4gdXNpbmcgY2xvbmVOb2RlLgoJCQkvLyBDYWxsaW5nIGRldGFjaEV2ZW50IG9uIHRoZSBjbG9uZSB3aWxsIGFsc28gcmVtb3ZlIHRoZSBldmVudHMKCQkJLy8gZnJvbSB0aGUgb3JpZ2luYWwuIEluIG9yZGVyIHRvIGdldCBhcm91bmQgdGhpcywgd2UgdXNlIHNvbWUKCQkJLy8gcHJvcHJpZXRhcnkgbWV0aG9kcyB0byBjbGVhciB0aGUgZXZlbnRzLiBUaGFua3MgdG8gTW9vVG9vbHMKCQkJLy8gZ3V5cyBmb3IgdGhpcyBob3RuZXNzLgoKCQkJY2xvbmVGaXhBdHRyaWJ1dGVzKCBlbGVtLCBjbG9uZSApOwoKCQkJLy8gVXNpbmcgU2l6emxlIGhlcmUgaXMgY3Jhenkgc2xvdywgc28gd2UgdXNlIGdldEVsZW1lbnRzQnlUYWdOYW1lIGluc3RlYWQKCQkJc3JjRWxlbWVudHMgPSBnZXRBbGwoIGVsZW0gKTsKCQkJZGVzdEVsZW1lbnRzID0gZ2V0QWxsKCBjbG9uZSApOwoKCQkJLy8gV2VpcmQgaXRlcmF0aW9uIGJlY2F1c2UgSUUgd2lsbCByZXBsYWNlIHRoZSBsZW5ndGggcHJvcGVydHkKCQkJLy8gd2l0aCBhbiBlbGVtZW50IGlmIHlvdSBhcmUgY2xvbmluZyB0aGUgYm9keSBhbmQgb25lIG9mIHRoZQoJCQkvLyBlbGVtZW50cyBvbiB0aGUgcGFnZSBoYXMgYSBuYW1lIG9yIGlkIG9mICJsZW5ndGgiCgkJCWZvciAoIGkgPSAwOyBzcmNFbGVtZW50c1tpXTsgKytpICkgewoJCQkJLy8gRW5zdXJlIHRoYXQgdGhlIGRlc3RpbmF0aW9uIG5vZGUgaXMgbm90IG51bGw7IEZpeGVzICM5NTg3CgkJCQlpZiAoIGRlc3RFbGVtZW50c1tpXSApIHsKCQkJCQljbG9uZUZpeEF0dHJpYnV0ZXMoIHNyY0VsZW1lbnRzW2ldLCBkZXN0RWxlbWVudHNbaV0gKTsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gQ29weSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIHRvIHRoZSBjbG9uZQoJCWlmICggZGF0YUFuZEV2ZW50cyApIHsKCQkJY2xvbmVDb3B5RXZlbnQoIGVsZW0sIGNsb25lICk7CgoJCQlpZiAoIGRlZXBEYXRhQW5kRXZlbnRzICkgewoJCQkJc3JjRWxlbWVudHMgPSBnZXRBbGwoIGVsZW0gKTsKCQkJCWRlc3RFbGVtZW50cyA9IGdldEFsbCggY2xvbmUgKTsKCgkJCQlmb3IgKCBpID0gMDsgc3JjRWxlbWVudHNbaV07ICsraSApIHsKCQkJCQljbG9uZUNvcHlFdmVudCggc3JjRWxlbWVudHNbaV0sIGRlc3RFbGVtZW50c1tpXSApOwoJCQkJfQoJCQl9CgkJfQoKCQlzcmNFbGVtZW50cyA9IGRlc3RFbGVtZW50cyA9IG51bGw7CgoJCS8vIFJldHVybiB0aGUgY2xvbmVkIHNldAoJCXJldHVybiBjbG9uZTsKCX0sCgoJY2xlYW46IGZ1bmN0aW9uKCBlbGVtcywgY29udGV4dCwgZnJhZ21lbnQsIHNjcmlwdHMgKSB7CgkJdmFyIGosIHNhZmUsIGVsZW0sIHRhZywgd3JhcCwgZGVwdGgsIGRpdiwgaGFzQm9keSwgdGJvZHksIGxlbiwgaGFuZGxlU2NyaXB0LCBqc1RhZ3MsCgkJCWkgPSAwLAoJCQlyZXQgPSBbXTsKCgkJLy8gRW5zdXJlIHRoYXQgY29udGV4dCBpcyBhIGRvY3VtZW50CgkJaWYgKCAhY29udGV4dCB8fCB0eXBlb2YgY29udGV4dC5jcmVhdGVEb2N1bWVudEZyYWdtZW50ID09PSAidW5kZWZpbmVkIiApIHsKCQkJY29udGV4dCA9IGRvY3VtZW50OwoJCX0KCgkJLy8gVXNlIHRoZSBhbHJlYWR5LWNyZWF0ZWQgc2FmZSBmcmFnbWVudCBpZiBjb250ZXh0IHBlcm1pdHMKCQlmb3IgKCBzYWZlID0gY29udGV4dCA9PT0gZG9jdW1lbnQgJiYgc2FmZUZyYWdtZW50OyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCWlmICggdHlwZW9mIGVsZW0gPT09ICJudW1iZXIiICkgewoJCQkJZWxlbSArPSAiIjsKCQkJfQoKCQkJaWYgKCAhZWxlbSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQkvLyBDb252ZXJ0IGh0bWwgc3RyaW5nIGludG8gRE9NIG5vZGVzCgkJCWlmICggdHlwZW9mIGVsZW0gPT09ICJzdHJpbmciICkgewoJCQkJaWYgKCAhcmh0bWwudGVzdCggZWxlbSApICkgewoJCQkJCWVsZW0gPSBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBlbGVtICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIEVuc3VyZSBhIHNhZmUgY29udGFpbmVyIGluIHdoaWNoIHRvIHJlbmRlciB0aGUgaHRtbAoJCQkJCXNhZmUgPSBzYWZlIHx8IGNyZWF0ZVNhZmVGcmFnbWVudCggY29udGV4dCApOwoJCQkJCWRpdiA9IGRpdiB8fCBzYWZlLmFwcGVuZENoaWxkKCBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpICk7CgoJCQkJCS8vIEZpeCAiWEhUTUwiLXN0eWxlIHRhZ3MgaW4gYWxsIGJyb3dzZXJzCgkJCQkJZWxlbSA9IGVsZW0ucmVwbGFjZShyeGh0bWxUYWcsICI8JDE+PC8kMj4iKTsKCgkJCQkJLy8gR28gdG8gaHRtbCBhbmQgYmFjaywgdGhlbiBwZWVsIG9mZiBleHRyYSB3cmFwcGVycwoJCQkJCXRhZyA9ICggcnRhZ05hbWUuZXhlYyggZWxlbSApIHx8IFsiIiwgIiJdIClbMV0udG9Mb3dlckNhc2UoKTsKCQkJCQl3cmFwID0gd3JhcE1hcFsgdGFnIF0gfHwgd3JhcE1hcC5fZGVmYXVsdDsKCQkJCQlkZXB0aCA9IHdyYXBbMF07CgkJCQkJZGl2LmlubmVySFRNTCA9IHdyYXBbMV0gKyBlbGVtICsgd3JhcFsyXTsKCgkJCQkJLy8gTW92ZSB0byB0aGUgcmlnaHQgZGVwdGgKCQkJCQl3aGlsZSAoIGRlcHRoLS0gKSB7CgkJCQkJCWRpdiA9IGRpdi5sYXN0Q2hpbGQ7CgkJCQkJfQoKCQkJCQkvLyBSZW1vdmUgSUUncyBhdXRvaW5zZXJ0ZWQgPHRib2R5PiBmcm9tIHRhYmxlIGZyYWdtZW50cwoJCQkJCWlmICggIWpRdWVyeS5zdXBwb3J0LnRib2R5ICkgewoKCQkJCQkJLy8gU3RyaW5nIHdhcyBhIDx0YWJsZT4sICptYXkqIGhhdmUgc3B1cmlvdXMgPHRib2R5PgoJCQkJCQloYXNCb2R5ID0gcnRib2R5LnRlc3QoZWxlbSk7CgkJCQkJCQl0Ym9keSA9IHRhZyA9PT0gInRhYmxlIiAmJiAhaGFzQm9keSA/CgkJCQkJCQkJZGl2LmZpcnN0Q2hpbGQgJiYgZGl2LmZpcnN0Q2hpbGQuY2hpbGROb2RlcyA6CgoJCQkJCQkJCS8vIFN0cmluZyB3YXMgYSBiYXJlIDx0aGVhZD4gb3IgPHRmb290PgoJCQkJCQkJCXdyYXBbMV0gPT09ICI8dGFibGU+IiAmJiAhaGFzQm9keSA/CgkJCQkJCQkJCWRpdi5jaGlsZE5vZGVzIDoKCQkJCQkJCQkJW107CgoJCQkJCQlmb3IgKCBqID0gdGJvZHkubGVuZ3RoIC0gMTsgaiA+PSAwIDsgLS1qICkgewoJCQkJCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRib2R5WyBqIF0sICJ0Ym9keSIgKSAmJiAhdGJvZHlbIGogXS5jaGlsZE5vZGVzLmxlbmd0aCApIHsKCQkJCQkJCQl0Ym9keVsgaiBdLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHRib2R5WyBqIF0gKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gSUUgY29tcGxldGVseSBraWxscyBsZWFkaW5nIHdoaXRlc3BhY2Ugd2hlbiBpbm5lckhUTUwgaXMgdXNlZAoJCQkJCWlmICggIWpRdWVyeS5zdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlICYmIHJsZWFkaW5nV2hpdGVzcGFjZS50ZXN0KCBlbGVtICkgKSB7CgkJCQkJCWRpdi5pbnNlcnRCZWZvcmUoIGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoIHJsZWFkaW5nV2hpdGVzcGFjZS5leGVjKGVsZW0pWzBdICksIGRpdi5maXJzdENoaWxkICk7CgkJCQkJfQoKCQkJCQllbGVtID0gZGl2LmNoaWxkTm9kZXM7CgoJCQkJCS8vIFJlbWVtYmVyIHRoZSB0b3AtbGV2ZWwgY29udGFpbmVyIGZvciBwcm9wZXIgY2xlYW51cAoJCQkJCWRpdiA9IHNhZmUubGFzdENoaWxkOwoJCQkJfQoJCQl9CgoJCQlpZiAoIGVsZW0ubm9kZVR5cGUgKSB7CgkJCQlyZXQucHVzaCggZWxlbSApOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0galF1ZXJ5Lm1lcmdlKCByZXQsIGVsZW0gKTsKCQkJfQoJCX0KCgkJLy8gRml4ICMxMTM1NjogQ2xlYXIgZWxlbWVudHMgZnJvbSBzYWZlRnJhZ21lbnQKCQlpZiAoIGRpdiApIHsKCQkJc2FmZS5yZW1vdmVDaGlsZCggZGl2ICk7CgkJCWVsZW0gPSBkaXYgPSBzYWZlID0gbnVsbDsKCQl9CgoJCS8vIFJlc2V0IGRlZmF1bHRDaGVja2VkIGZvciBhbnkgcmFkaW9zIGFuZCBjaGVja2JveGVzCgkJLy8gYWJvdXQgdG8gYmUgYXBwZW5kZWQgdG8gdGhlIERPTSBpbiBJRSA2LzcgKCM4MDYwKQoJCWlmICggIWpRdWVyeS5zdXBwb3J0LmFwcGVuZENoZWNrZWQgKSB7CgkJCWZvciAoIGkgPSAwOyAoZWxlbSA9IHJldFtpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpbnB1dCIgKSApIHsKCQkJCQlmaXhEZWZhdWx0Q2hlY2tlZCggZWxlbSApOwoJCQkJfSBlbHNlIGlmICggdHlwZW9mIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICkgewoJCQkJCWpRdWVyeS5ncmVwKCBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpLCBmaXhEZWZhdWx0Q2hlY2tlZCApOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBBcHBlbmQgZWxlbWVudHMgdG8gYSBwcm92aWRlZCBkb2N1bWVudCBmcmFnbWVudAoJCWlmICggZnJhZ21lbnQgKSB7CgkJCS8vIFNwZWNpYWwgaGFuZGxpbmcgb2YgZWFjaCBzY3JpcHQgZWxlbWVudAoJCQloYW5kbGVTY3JpcHQgPSBmdW5jdGlvbiggZWxlbSApIHsKCQkJCS8vIENoZWNrIGlmIHdlIGNvbnNpZGVyIGl0IGV4ZWN1dGFibGUKCQkJCWlmICggIWVsZW0udHlwZSB8fCByc2NyaXB0VHlwZS50ZXN0KCBlbGVtLnR5cGUgKSApIHsKCQkJCQkvLyBEZXRhY2ggdGhlIHNjcmlwdCBhbmQgc3RvcmUgaXQgaW4gdGhlIHNjcmlwdHMgYXJyYXkgKGlmIHByb3ZpZGVkKSBvciB0aGUgZnJhZ21lbnQKCQkJCQkvLyBSZXR1cm4gdHJ1dGh5IHRvIGluZGljYXRlIHRoYXQgaXQgaGFzIGJlZW4gaGFuZGxlZAoJCQkJCXJldHVybiBzY3JpcHRzID8KCQkJCQkJc2NyaXB0cy5wdXNoKCBlbGVtLnBhcmVudE5vZGUgPyBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGVsZW0gKSA6IGVsZW0gKSA6CgkJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBlbGVtICk7CgkJCQl9CgkJCX07CgoJCQlmb3IgKCBpID0gMDsgKGVsZW0gPSByZXRbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCS8vIENoZWNrIGlmIHdlJ3JlIGRvbmUgYWZ0ZXIgaGFuZGxpbmcgYW4gZXhlY3V0YWJsZSBzY3JpcHQKCQkJCWlmICggISggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAic2NyaXB0IiApICYmIGhhbmRsZVNjcmlwdCggZWxlbSApICkgKSB7CgkJCQkJLy8gQXBwZW5kIHRvIGZyYWdtZW50IGFuZCBoYW5kbGUgZW1iZWRkZWQgc2NyaXB0cwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBlbGVtICk7CgkJCQkJaWYgKCB0eXBlb2YgZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCQkJCS8vIGhhbmRsZVNjcmlwdCBhbHRlcnMgdGhlIERPTSwgc28gdXNlIGpRdWVyeS5tZXJnZSB0byBlbnN1cmUgc25hcHNob3QgaXRlcmF0aW9uCgkJCQkJCWpzVGFncyA9IGpRdWVyeS5ncmVwKCBqUXVlcnkubWVyZ2UoIFtdLCBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJzY3JpcHQiKSApLCBoYW5kbGVTY3JpcHQgKTsKCgkJCQkJCS8vIFNwbGljZSB0aGUgc2NyaXB0cyBpbnRvIHJldCBhZnRlciB0aGVpciBmb3JtZXIgYW5jZXN0b3IgYW5kIGFkdmFuY2Ugb3VyIGluZGV4IGJleW9uZCB0aGVtCgkJCQkJCXJldC5zcGxpY2UuYXBwbHkoIHJldCwgW2kgKyAxLCAwXS5jb25jYXQoIGpzVGFncyApICk7CgkJCQkJCWkgKz0ganNUYWdzLmxlbmd0aDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCWNsZWFuRGF0YTogZnVuY3Rpb24oIGVsZW1zLCAvKiBpbnRlcm5hbCAqLyBhY2NlcHREYXRhICkgewoJCXZhciBkYXRhLCBpZCwgZWxlbSwgdHlwZSwKCQkJaSA9IDAsCgkJCWludGVybmFsS2V5ID0galF1ZXJ5LmV4cGFuZG8sCgkJCWNhY2hlID0galF1ZXJ5LmNhY2hlLAoJCQlkZWxldGVFeHBhbmRvID0galF1ZXJ5LnN1cHBvcnQuZGVsZXRlRXhwYW5kbywKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsOwoKCQlmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCgkJCWlmICggYWNjZXB0RGF0YSB8fCBqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewoKCQkJCWlkID0gZWxlbVsgaW50ZXJuYWxLZXkgXTsKCQkJCWRhdGEgPSBpZCAmJiBjYWNoZVsgaWQgXTsKCgkJCQlpZiAoIGRhdGEgKSB7CgkJCQkJaWYgKCBkYXRhLmV2ZW50cyApIHsKCQkJCQkJZm9yICggdHlwZSBpbiBkYXRhLmV2ZW50cyApIHsKCQkJCQkJCWlmICggc3BlY2lhbFsgdHlwZSBdICkgewoJCQkJCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKTsKCgkJCQkJCQkvLyBUaGlzIGlzIGEgc2hvcnRjdXQgdG8gYXZvaWQgalF1ZXJ5LmV2ZW50LnJlbW92ZSdzIG92ZXJoZWFkCgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZGF0YS5oYW5kbGUgKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGNhY2hlIG9ubHkgaWYgaXQgd2FzIG5vdCBhbHJlYWR5IHJlbW92ZWQgYnkgalF1ZXJ5LmV2ZW50LnJlbW92ZQoJCQkJCWlmICggY2FjaGVbIGlkIF0gKSB7CgoJCQkJCQlkZWxldGUgY2FjaGVbIGlkIF07CgoJCQkJCQkvLyBJRSBkb2VzIG5vdCBhbGxvdyB1cyB0byBkZWxldGUgZXhwYW5kbyBwcm9wZXJ0aWVzIGZyb20gbm9kZXMsCgkJCQkJCS8vIG5vciBkb2VzIGl0IGhhdmUgYSByZW1vdmVBdHRyaWJ1dGUgZnVuY3Rpb24gb24gRG9jdW1lbnQgbm9kZXM7CgkJCQkJCS8vIHdlIG11c3QgaGFuZGxlIGFsbCBvZiB0aGVzZSBjYXNlcwoJCQkJCQlpZiAoIGRlbGV0ZUV4cGFuZG8gKSB7CgkJCQkJCQlkZWxldGUgZWxlbVsgaW50ZXJuYWxLZXkgXTsKCgkJCQkJCX0gZWxzZSBpZiAoIGVsZW0ucmVtb3ZlQXR0cmlidXRlICkgewoJCQkJCQkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoIGludGVybmFsS2V5ICk7CgoJCQkJCQl9IGVsc2UgewoJCQkJCQkJZWxlbVsgaW50ZXJuYWxLZXkgXSA9IG51bGw7CgkJCQkJCX0KCgkJCQkJCWpRdWVyeS5kZWxldGVkSWRzLnB1c2goIGlkICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQp9KTsKLy8gTGltaXQgc2NvcGUgcG9sbHV0aW9uIGZyb20gYW55IGRlcHJlY2F0ZWQgQVBJCihmdW5jdGlvbigpIHsKCnZhciBtYXRjaGVkLCBicm93c2VyOwoKLy8gVXNlIG9mIGpRdWVyeS5icm93c2VyIGlzIGZyb3duZWQgdXBvbi4KLy8gTW9yZSBkZXRhaWxzOiBodHRwOi8vYXBpLmpxdWVyeS5jb20valF1ZXJ5LmJyb3dzZXIKLy8galF1ZXJ5LnVhTWF0Y2ggbWFpbnRhaW5lZCBmb3IgYmFjay1jb21wYXQKalF1ZXJ5LnVhTWF0Y2ggPSBmdW5jdGlvbiggdWEgKSB7Cgl1YSA9IHVhLnRvTG93ZXJDYXNlKCk7CgoJdmFyIG1hdGNoID0gLyhjaHJvbWUpWyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAoJCS8od2Via2l0KVsgXC9dKFtcdy5dKykvLmV4ZWMoIHVhICkgfHwKCQkvKG9wZXJhKSg/Oi4qdmVyc2lvbnwpWyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAoJCS8obXNpZSkgKFtcdy5dKykvLmV4ZWMoIHVhICkgfHwKCQl1YS5pbmRleE9mKCJjb21wYXRpYmxlIikgPCAwICYmIC8obW96aWxsYSkoPzouKj8gcnY6KFtcdy5dKyl8KS8uZXhlYyggdWEgKSB8fAoJCVtdOwoKCXJldHVybiB7CgkJYnJvd3NlcjogbWF0Y2hbIDEgXSB8fCAiIiwKCQl2ZXJzaW9uOiBtYXRjaFsgMiBdIHx8ICIwIgoJfTsKfTsKCm1hdGNoZWQgPSBqUXVlcnkudWFNYXRjaCggbmF2aWdhdG9yLnVzZXJBZ2VudCApOwpicm93c2VyID0ge307CgppZiAoIG1hdGNoZWQuYnJvd3NlciApIHsKCWJyb3dzZXJbIG1hdGNoZWQuYnJvd3NlciBdID0gdHJ1ZTsKCWJyb3dzZXIudmVyc2lvbiA9IG1hdGNoZWQudmVyc2lvbjsKfQoKLy8gRGVwcmVjYXRlZCwgdXNlIGpRdWVyeS5icm93c2VyLndlYmtpdCBpbnN0ZWFkCi8vIE1haW50YWluZWQgZm9yIGJhY2stY29tcGF0IG9ubHkKaWYgKCBicm93c2VyLndlYmtpdCApIHsKCWJyb3dzZXIuc2FmYXJpID0gdHJ1ZTsKfQoKalF1ZXJ5LmJyb3dzZXIgPSBicm93c2VyOwoKalF1ZXJ5LnN1YiA9IGZ1bmN0aW9uKCkgewoJZnVuY3Rpb24galF1ZXJ5U3ViKCBzZWxlY3RvciwgY29udGV4dCApIHsKCQlyZXR1cm4gbmV3IGpRdWVyeVN1Yi5mbi5pbml0KCBzZWxlY3RvciwgY29udGV4dCApOwoJfQoJalF1ZXJ5LmV4dGVuZCggdHJ1ZSwgalF1ZXJ5U3ViLCB0aGlzICk7CglqUXVlcnlTdWIuc3VwZXJjbGFzcyA9IHRoaXM7CglqUXVlcnlTdWIuZm4gPSBqUXVlcnlTdWIucHJvdG90eXBlID0gdGhpcygpOwoJalF1ZXJ5U3ViLmZuLmNvbnN0cnVjdG9yID0galF1ZXJ5U3ViOwoJalF1ZXJ5U3ViLnN1YiA9IHRoaXMuc3ViOwoJalF1ZXJ5U3ViLmZuLmluaXQgPSBmdW5jdGlvbiBpbml0KCBzZWxlY3RvciwgY29udGV4dCApIHsKCQlpZiAoIGNvbnRleHQgJiYgY29udGV4dCBpbnN0YW5jZW9mIGpRdWVyeSAmJiAhKGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnlTdWIpICkgewoJCQljb250ZXh0ID0galF1ZXJ5U3ViKCBjb250ZXh0ICk7CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmZuLmluaXQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJvb3RqUXVlcnlTdWIgKTsKCX07CglqUXVlcnlTdWIuZm4uaW5pdC5wcm90b3R5cGUgPSBqUXVlcnlTdWIuZm47Cgl2YXIgcm9vdGpRdWVyeVN1YiA9IGpRdWVyeVN1Yihkb2N1bWVudCk7CglyZXR1cm4galF1ZXJ5U3ViOwp9OwoJCn0pKCk7CnZhciBjdXJDU1MsIGlmcmFtZSwgaWZyYW1lRG9jLAoJcmFscGhhID0gL2FscGhhXChbXildKlwpL2ksCglyb3BhY2l0eSA9IC9vcGFjaXR5PShbXildKikvLAoJcnBvc2l0aW9uID0gL14odG9wfHJpZ2h0fGJvdHRvbXxsZWZ0KSQvLAoJcm1hcmdpbiA9IC9ebWFyZ2luLywKCXJudW1zcGxpdCA9IG5ldyBSZWdFeHAoICJeKCIgKyBjb3JlX3BudW0gKyAiKSguKikkIiwgImkiICksCglybnVtbm9ucHggPSBuZXcgUmVnRXhwKCAiXigiICsgY29yZV9wbnVtICsgIikoPyFweClbYS16JV0rJCIsICJpIiApLAoJcnJlbE51bSA9IG5ldyBSZWdFeHAoICJeKFstK10pPSgiICsgY29yZV9wbnVtICsgIikiLCAiaSIgKSwKCWVsZW1kaXNwbGF5ID0ge30sCgoJY3NzU2hvdyA9IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHZpc2liaWxpdHk6ICJoaWRkZW4iLCBkaXNwbGF5OiAiYmxvY2siIH0sCgljc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CgkJbGV0dGVyU3BhY2luZzogMCwKCQlmb250V2VpZ2h0OiA0MDAsCgkJbGluZUhlaWdodDogMQoJfSwKCgljc3NFeHBhbmQgPSBbICJUb3AiLCAiUmlnaHQiLCAiQm90dG9tIiwgIkxlZnQiIF0sCgljc3NQcmVmaXhlcyA9IFsgIldlYmtpdCIsICJPIiwgIk1veiIsICJtcyIgXSwKCglldmVudHNUb2dnbGUgPSBqUXVlcnkuZm4udG9nZ2xlOwoKLy8gcmV0dXJuIGEgY3NzIHByb3BlcnR5IG1hcHBlZCB0byBhIHBvdGVudGlhbGx5IHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQpmdW5jdGlvbiB2ZW5kb3JQcm9wTmFtZSggc3R5bGUsIG5hbWUgKSB7CgoJLy8gc2hvcnRjdXQgZm9yIG5hbWVzIHRoYXQgYXJlIG5vdCB2ZW5kb3IgcHJlZml4ZWQKCWlmICggbmFtZSBpbiBzdHlsZSApIHsKCQlyZXR1cm4gbmFtZTsKCX0KCgkvLyBjaGVjayBmb3IgdmVuZG9yIHByZWZpeGVkIG5hbWVzCgl2YXIgY2FwTmFtZSA9IG5hbWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBuYW1lLnNsaWNlKDEpLAoJCW9yaWdOYW1lID0gbmFtZSwKCQlpID0gY3NzUHJlZml4ZXMubGVuZ3RoOwoKCXdoaWxlICggaS0tICkgewoJCW5hbWUgPSBjc3NQcmVmaXhlc1sgaSBdICsgY2FwTmFtZTsKCQlpZiAoIG5hbWUgaW4gc3R5bGUgKSB7CgkJCXJldHVybiBuYW1lOwoJCX0KCX0KCglyZXR1cm4gb3JpZ05hbWU7Cn0KCmZ1bmN0aW9uIGlzSGlkZGVuKCBlbGVtLCBlbCApIHsKCWVsZW0gPSBlbCB8fCBlbGVtOwoJcmV0dXJuIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAibm9uZSIgfHwgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7Cn0KCmZ1bmN0aW9uIHNob3dIaWRlKCBlbGVtZW50cywgc2hvdyApIHsKCXZhciBlbGVtLCBkaXNwbGF5LAoJCXZhbHVlcyA9IFtdLAoJCWluZGV4ID0gMCwKCQlsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQllbGVtID0gZWxlbWVudHNbIGluZGV4IF07CgkJaWYgKCAhZWxlbS5zdHlsZSApIHsKCQkJY29udGludWU7CgkJfQoJCXZhbHVlc1sgaW5kZXggXSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgIm9sZGRpc3BsYXkiICk7CgkJaWYgKCBzaG93ICkgewoJCQkvLyBSZXNldCB0aGUgaW5saW5lIGRpc3BsYXkgb2YgdGhpcyBlbGVtZW50IHRvIGxlYXJuIGlmIGl0IGlzCgkJCS8vIGJlaW5nIGhpZGRlbiBieSBjYXNjYWRlZCBydWxlcyBvciBub3QKCQkJaWYgKCAhdmFsdWVzWyBpbmRleCBdICYmIGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiICkgewoJCQkJZWxlbS5zdHlsZS5kaXNwbGF5ID0gIiI7CgkJCX0KCgkJCS8vIFNldCBlbGVtZW50cyB3aGljaCBoYXZlIGJlZW4gb3ZlcnJpZGRlbiB3aXRoIGRpc3BsYXk6IG5vbmUKCQkJLy8gaW4gYSBzdHlsZXNoZWV0IHRvIHdoYXRldmVyIHRoZSBkZWZhdWx0IGJyb3dzZXIgc3R5bGUgaXMKCQkJLy8gZm9yIHN1Y2ggYW4gZWxlbWVudAoJCQlpZiAoIGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgJiYgaXNIaWRkZW4oIGVsZW0gKSApIHsKCQkJCXZhbHVlc1sgaW5kZXggXSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgIm9sZGRpc3BsYXkiLCBjc3NfZGVmYXVsdERpc3BsYXkoZWxlbS5ub2RlTmFtZSkgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWRpc3BsYXkgPSBjdXJDU1MoIGVsZW0sICJkaXNwbGF5IiApOwoKCQkJaWYgKCAhdmFsdWVzWyBpbmRleCBdICYmIGRpc3BsYXkgIT09ICJub25lIiApIHsKCQkJCWpRdWVyeS5fZGF0YSggZWxlbSwgIm9sZGRpc3BsYXkiLCBkaXNwbGF5ICk7CgkJCX0KCQl9Cgl9CgoJLy8gU2V0IHRoZSBkaXNwbGF5IG9mIG1vc3Qgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AKCS8vIHRvIGF2b2lkIHRoZSBjb25zdGFudCByZWZsb3cKCWZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwoJCWlmICggIWVsZW0uc3R5bGUgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQlpZiAoICFzaG93IHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgKSB7CgkJCWVsZW0uc3R5bGUuZGlzcGxheSA9IHNob3cgPyB2YWx1ZXNbIGluZGV4IF0gfHwgIiIgOiAibm9uZSI7CgkJfQoJfQoKCXJldHVybiBlbGVtZW50czsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7Cgljc3M6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewoJCQlyZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/CgkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUsIHZhbHVlICkgOgoJCQkJalF1ZXJ5LmNzcyggZWxlbSwgbmFtZSApOwoJCX0sIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwoJfSwKCXNob3c6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzaG93SGlkZSggdGhpcywgdHJ1ZSApOwoJfSwKCWhpZGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzaG93SGlkZSggdGhpcyApOwoJfSwKCXRvZ2dsZTogZnVuY3Rpb24oIHN0YXRlLCBmbjIgKSB7CgkJdmFyIGJvb2wgPSB0eXBlb2Ygc3RhdGUgPT09ICJib29sZWFuIjsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggc3RhdGUgKSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggZm4yICkgKSB7CgkJCXJldHVybiBldmVudHNUb2dnbGUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCBib29sID8gc3RhdGUgOiBpc0hpZGRlbiggdGhpcyApICkgewoJCQkJalF1ZXJ5KCB0aGlzICkuc2hvdygpOwoJCQl9IGVsc2UgewoJCQkJalF1ZXJ5KCB0aGlzICkuaGlkZSgpOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CgkvLyBBZGQgaW4gc3R5bGUgcHJvcGVydHkgaG9va3MgZm9yIG92ZXJyaWRpbmcgdGhlIGRlZmF1bHQKCS8vIGJlaGF2aW9yIG9mIGdldHRpbmcgYW5kIHNldHRpbmcgYSBzdHlsZSBwcm9wZXJ0eQoJY3NzSG9va3M6IHsKCQlvcGFjaXR5OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkJaWYgKCBjb21wdXRlZCApIHsKCQkJCQkvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQoJCQkJCXZhciByZXQgPSBjdXJDU1MoIGVsZW0sICJvcGFjaXR5IiApOwoJCQkJCXJldHVybiByZXQgPT09ICIiID8gIjEiIDogcmV0OwoKCQkJCX0KCQkJfQoJCX0KCX0sCgoJLy8gRXhjbHVkZSB0aGUgZm9sbG93aW5nIGNzcyBwcm9wZXJ0aWVzIHRvIGFkZCBweAoJY3NzTnVtYmVyOiB7CgkJImZpbGxPcGFjaXR5IjogdHJ1ZSwKCQkiZm9udFdlaWdodCI6IHRydWUsCgkJImxpbmVIZWlnaHQiOiB0cnVlLAoJCSJvcGFjaXR5IjogdHJ1ZSwKCQkib3JwaGFucyI6IHRydWUsCgkJIndpZG93cyI6IHRydWUsCgkJInpJbmRleCI6IHRydWUsCgkJInpvb20iOiB0cnVlCgl9LAoKCS8vIEFkZCBpbiBwcm9wZXJ0aWVzIHdob3NlIG5hbWVzIHlvdSB3aXNoIHRvIGZpeCBiZWZvcmUKCS8vIHNldHRpbmcgb3IgZ2V0dGluZyB0aGUgdmFsdWUKCWNzc1Byb3BzOiB7CgkJLy8gbm9ybWFsaXplIGZsb2F0IGNzcyBwcm9wZXJ0eQoJCSJmbG9hdCI6IGpRdWVyeS5zdXBwb3J0LmNzc0Zsb2F0ID8gImNzc0Zsb2F0IiA6ICJzdHlsZUZsb2F0IgoJfSwKCgkvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQoJc3R5bGU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSwgZXh0cmEgKSB7CgkJLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIWVsZW0uc3R5bGUgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQoJCXZhciByZXQsIHR5cGUsIGhvb2tzLAoJCQlvcmlnTmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKSwKCQkJc3R5bGUgPSBlbGVtLnN0eWxlOwoKCQluYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdIHx8ICggalF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIHN0eWxlLCBvcmlnTmFtZSApICk7CgoJCS8vIGdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24KCQkvLyBmb2xsb3dlZCBieSB0aGUgdW5wcmVmaXhlZCB2ZXJzaW9uCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSB8fCBqUXVlcnkuY3NzSG9va3NbIG9yaWdOYW1lIF07CgoJCS8vIENoZWNrIGlmIHdlJ3JlIHNldHRpbmcgYSB2YWx1ZQoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdHlwZSA9IHR5cGVvZiB2YWx1ZTsKCgkJCS8vIGNvbnZlcnQgcmVsYXRpdmUgbnVtYmVyIHN0cmluZ3MgKCs9IG9yIC09KSB0byByZWxhdGl2ZSBudW1iZXJzLiAjNzM0NQoJCQlpZiAoIHR5cGUgPT09ICJzdHJpbmciICYmIChyZXQgPSBycmVsTnVtLmV4ZWMoIHZhbHVlICkpICkgewoJCQkJdmFsdWUgPSAoIHJldFsxXSArIDEgKSAqIHJldFsyXSArIHBhcnNlRmxvYXQoIGpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKSApOwoJCQkJLy8gRml4ZXMgYnVnICM5MjM3CgkJCQl0eXBlID0gIm51bWJlciI7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGF0IE5hTiBhbmQgbnVsbCB2YWx1ZXMgYXJlbid0IHNldC4gU2VlOiAjNzExNgoJCQlpZiAoIHZhbHVlID09IG51bGwgfHwgdHlwZSA9PT0gIm51bWJlciIgJiYgaXNOYU4oIHZhbHVlICkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGEgbnVtYmVyIHdhcyBwYXNzZWQgaW4sIGFkZCAncHgnIHRvIHRoZSAoZXhjZXB0IGZvciBjZXJ0YWluIENTUyBwcm9wZXJ0aWVzKQoJCQlpZiAoIHR5cGUgPT09ICJudW1iZXIiICYmICFqUXVlcnkuY3NzTnVtYmVyWyBvcmlnTmFtZSBdICkgewoJCQkJdmFsdWUgKz0gInB4IjsKCQkJfQoKCQkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCwgdXNlIHRoYXQgdmFsdWUsIG90aGVyd2lzZSBqdXN0IHNldCB0aGUgc3BlY2lmaWVkIHZhbHVlCgkJCWlmICggIWhvb2tzIHx8ICEoInNldCIgaW4gaG9va3MpIHx8ICh2YWx1ZSA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIGV4dHJhICkpICE9PSB1bmRlZmluZWQgKSB7CgkJCQkvLyBXcmFwcGVkIHRvIHByZXZlbnQgSUUgZnJvbSB0aHJvd2luZyBlcnJvcnMgd2hlbiAnaW52YWxpZCcgdmFsdWVzIGFyZSBwcm92aWRlZAoJCQkJLy8gRml4ZXMgYnVnICM1NTA5CgkJCQl0cnkgewoJCQkJCXN0eWxlWyBuYW1lIF0gPSB2YWx1ZTsKCQkJCX0gY2F0Y2goZSkge30KCQkJfQoKCQl9IGVsc2UgewoJCQkvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkIGdldCB0aGUgbm9uLWNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKCQkJaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBmYWxzZSwgZXh0cmEgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiByZXQ7CgkJCX0KCgkJCS8vIE90aGVyd2lzZSBqdXN0IGdldCB0aGUgdmFsdWUgZnJvbSB0aGUgc3R5bGUgb2JqZWN0CgkJCXJldHVybiBzdHlsZVsgbmFtZSBdOwoJCX0KCX0sCgoJY3NzOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgbnVtZXJpYywgZXh0cmEgKSB7CgkJdmFyIHZhbCwgbnVtLCBob29rcywKCQkJb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICk7CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQoJCW5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gfHwgKCBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gPSB2ZW5kb3JQcm9wTmFtZSggZWxlbS5zdHlsZSwgb3JpZ05hbWUgKSApOwoKCQkvLyBnZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uCgkJLy8gZm9sbG93ZWQgYnkgdGhlIHVucHJlZml4ZWQgdmVyc2lvbgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKCQkvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQoJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgKSB7CgkJCXZhbCA9IGhvb2tzLmdldCggZWxlbSwgdHJ1ZSwgZXh0cmEgKTsKCQl9CgoJCS8vIE90aGVyd2lzZSwgaWYgYSB3YXkgdG8gZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBleGlzdHMsIHVzZSB0aGF0CgkJaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsKCQkJdmFsID0gY3VyQ1NTKCBlbGVtLCBuYW1lICk7CgkJfQoKCQkvL2NvbnZlcnQgIm5vcm1hbCIgdG8gY29tcHV0ZWQgdmFsdWUKCQlpZiAoIHZhbCA9PT0gIm5vcm1hbCIgJiYgbmFtZSBpbiBjc3NOb3JtYWxUcmFuc2Zvcm0gKSB7CgkJCXZhbCA9IGNzc05vcm1hbFRyYW5zZm9ybVsgbmFtZSBdOwoJCX0KCgkJLy8gUmV0dXJuLCBjb252ZXJ0aW5nIHRvIG51bWJlciBpZiBmb3JjZWQgb3IgYSBxdWFsaWZpZXIgd2FzIHByb3ZpZGVkIGFuZCB2YWwgbG9va3MgbnVtZXJpYwoJCWlmICggbnVtZXJpYyB8fCBleHRyYSAhPT0gdW5kZWZpbmVkICkgewoJCQludW0gPSBwYXJzZUZsb2F0KCB2YWwgKTsKCQkJcmV0dXJuIG51bWVyaWMgfHwgalF1ZXJ5LmlzTnVtZXJpYyggbnVtICkgPyBudW0gfHwgMCA6IHZhbDsKCQl9CgkJcmV0dXJuIHZhbDsKCX0sCgoJLy8gQSBtZXRob2QgZm9yIHF1aWNrbHkgc3dhcHBpbmcgaW4vb3V0IENTUyBwcm9wZXJ0aWVzIHRvIGdldCBjb3JyZWN0IGNhbGN1bGF0aW9ucwoJc3dhcDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCXZhciByZXQsIG5hbWUsCgkJCW9sZCA9IHt9OwoKCQkvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMKCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCW9sZFsgbmFtZSBdID0gZWxlbS5zdHlsZVsgbmFtZSBdOwoJCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvcHRpb25zWyBuYW1lIF07CgkJfQoKCQlyZXQgPSBjYWxsYmFjay5jYWxsKCBlbGVtICk7CgoJCS8vIFJldmVydCB0aGUgb2xkIHZhbHVlcwoJCWZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsKCQkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb2xkWyBuYW1lIF07CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQp9KTsKCi8vIE5PVEU6IFRvIGFueSBmdXR1cmUgbWFpbnRhaW5lciwgd2UndmUgdXNlZCBib3RoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlCi8vIGFuZCBnZXRDb21wdXRlZFN0eWxlIGhlcmUgdG8gcHJvZHVjZSBhIGJldHRlciBnemlwIHNpemUKaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKCWN1ckNTUyA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXZhciByZXQsIHdpZHRoLCBtaW5XaWR0aCwgbWF4V2lkdGgsCgkJCWNvbXB1dGVkID0gZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApLAoJCQlzdHlsZSA9IGVsZW0uc3R5bGU7CgoJCWlmICggY29tcHV0ZWQgKSB7CgoJCQlyZXQgPSBjb21wdXRlZFsgbmFtZSBdOwoJCQlpZiAoIHJldCA9PT0gIiIgJiYgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZWxlbSApICkgewoJCQkJcmV0ID0galF1ZXJ5LnN0eWxlKCBlbGVtLCBuYW1lICk7CgkJCX0KCgkJCS8vIEEgdHJpYnV0ZSB0byB0aGUgImF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMiCgkJCS8vIENocm9tZSA8IDE3IGFuZCBTYWZhcmkgNS4wIHVzZXMgImNvbXB1dGVkIHZhbHVlIiBpbnN0ZWFkIG9mICJ1c2VkIHZhbHVlIiBmb3IgbWFyZ2luLXJpZ2h0CgkJCS8vIFNhZmFyaSA1LjEuNyAoYXQgbGVhc3QpIHJldHVybnMgcGVyY2VudGFnZSBmb3IgYSBsYXJnZXIgc2V0IG9mIHZhbHVlcywgYnV0IHdpZHRoIHNlZW1zIHRvIGJlIHJlbGlhYmx5IHBpeGVscwoJCQkvLyB0aGlzIGlzIGFnYWluc3QgdGhlIENTU09NIGRyYWZ0IHNwZWM6IGh0dHA6Ly9kZXYudzMub3JnL2Nzc3dnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMKCQkJaWYgKCBybnVtbm9ucHgudGVzdCggcmV0ICkgJiYgcm1hcmdpbi50ZXN0KCBuYW1lICkgKSB7CgkJCQl3aWR0aCA9IHN0eWxlLndpZHRoOwoJCQkJbWluV2lkdGggPSBzdHlsZS5taW5XaWR0aDsKCQkJCW1heFdpZHRoID0gc3R5bGUubWF4V2lkdGg7CgoJCQkJc3R5bGUubWluV2lkdGggPSBzdHlsZS5tYXhXaWR0aCA9IHN0eWxlLndpZHRoID0gcmV0OwoJCQkJcmV0ID0gY29tcHV0ZWQud2lkdGg7CgoJCQkJc3R5bGUud2lkdGggPSB3aWR0aDsKCQkJCXN0eWxlLm1pbldpZHRoID0gbWluV2lkdGg7CgkJCQlzdHlsZS5tYXhXaWR0aCA9IG1heFdpZHRoOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfTsKfSBlbHNlIGlmICggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmN1cnJlbnRTdHlsZSApIHsKCWN1ckNTUyA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXZhciBsZWZ0LCByc0xlZnQsCgkJCXJldCA9IGVsZW0uY3VycmVudFN0eWxlICYmIGVsZW0uY3VycmVudFN0eWxlWyBuYW1lIF0sCgkJCXN0eWxlID0gZWxlbS5zdHlsZTsKCgkJLy8gQXZvaWQgc2V0dGluZyByZXQgdG8gZW1wdHkgc3RyaW5nIGhlcmUKCQkvLyBzbyB3ZSBkb24ndCBkZWZhdWx0IHRvIGF1dG8KCQlpZiAoIHJldCA9PSBudWxsICYmIHN0eWxlICYmIHN0eWxlWyBuYW1lIF0gKSB7CgkJCXJldCA9IHN0eWxlWyBuYW1lIF07CgkJfQoKCQkvLyBGcm9tIHRoZSBhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzCgkJLy8gaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQoKCQkvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKCQkvLyBidXQgYSBudW1iZXIgdGhhdCBoYXMgYSB3ZWlyZCBlbmRpbmcsIHdlIG5lZWQgdG8gY29udmVydCBpdCB0byBwaXhlbHMKCQkvLyBidXQgbm90IHBvc2l0aW9uIGNzcyBhdHRyaWJ1dGVzLCBhcyB0aG9zZSBhcmUgcHJvcG9ydGlvbmFsIHRvIHRoZSBwYXJlbnQgZWxlbWVudCBpbnN0ZWFkCgkJLy8gYW5kIHdlIGNhbid0IG1lYXN1cmUgdGhlIHBhcmVudCBpbnN0ZWFkIGJlY2F1c2UgaXQgbWlnaHQgdHJpZ2dlciBhICJzdGFja2luZyBkb2xscyIgcHJvYmxlbQoJCWlmICggcm51bW5vbnB4LnRlc3QoIHJldCApICYmICFycG9zaXRpb24udGVzdCggbmFtZSApICkgewoKCQkJLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwoJCQlsZWZ0ID0gc3R5bGUubGVmdDsKCQkJcnNMZWZ0ID0gZWxlbS5ydW50aW1lU3R5bGUgJiYgZWxlbS5ydW50aW1lU3R5bGUubGVmdDsKCgkJCS8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQKCQkJaWYgKCByc0xlZnQgKSB7CgkJCQllbGVtLnJ1bnRpbWVTdHlsZS5sZWZ0ID0gZWxlbS5jdXJyZW50U3R5bGUubGVmdDsKCQkJfQoJCQlzdHlsZS5sZWZ0ID0gbmFtZSA9PT0gImZvbnRTaXplIiA/ICIxZW0iIDogcmV0OwoJCQlyZXQgPSBzdHlsZS5waXhlbExlZnQgKyAicHgiOwoKCQkJLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwoJCQlzdHlsZS5sZWZ0ID0gbGVmdDsKCQkJaWYgKCByc0xlZnQgKSB7CgkJCQllbGVtLnJ1bnRpbWVTdHlsZS5sZWZ0ID0gcnNMZWZ0OwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0ID09PSAiIiA/ICJhdXRvIiA6IHJldDsKCX07Cn0KCmZ1bmN0aW9uIHNldFBvc2l0aXZlTnVtYmVyKCBlbGVtLCB2YWx1ZSwgc3VidHJhY3QgKSB7Cgl2YXIgbWF0Y2hlcyA9IHJudW1zcGxpdC5leGVjKCB2YWx1ZSApOwoJcmV0dXJuIG1hdGNoZXMgPwoJCQlNYXRoLm1heCggMCwgbWF0Y2hlc1sgMSBdIC0gKCBzdWJ0cmFjdCB8fCAwICkgKSArICggbWF0Y2hlc1sgMiBdIHx8ICJweCIgKSA6CgkJCXZhbHVlOwp9CgpmdW5jdGlvbiBhdWdtZW50V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEsIGlzQm9yZGVyQm94ICkgewoJdmFyIGkgPSBleHRyYSA9PT0gKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICkgPwoJCS8vIElmIHdlIGFscmVhZHkgaGF2ZSB0aGUgcmlnaHQgbWVhc3VyZW1lbnQsIGF2b2lkIGF1Z21lbnRhdGlvbgoJCTQgOgoJCS8vIE90aGVyd2lzZSBpbml0aWFsaXplIGZvciBob3Jpem9udGFsIG9yIHZlcnRpY2FsIHByb3BlcnRpZXMKCQluYW1lID09PSAid2lkdGgiID8gMSA6IDAsCgoJCXZhbCA9IDA7CgoJZm9yICggOyBpIDwgNDsgaSArPSAyICkgewoJCS8vIGJvdGggYm94IG1vZGVscyBleGNsdWRlIG1hcmdpbiwgc28gYWRkIGl0IGlmIHdlIHdhbnQgaXQKCQlpZiAoIGV4dHJhID09PSAibWFyZ2luIiApIHsKCQkJLy8gd2UgdXNlIGpRdWVyeS5jc3MgaW5zdGVhZCBvZiBjdXJDU1MgaGVyZQoJCQkvLyBiZWNhdXNlIG9mIHRoZSByZWxpYWJsZU1hcmdpblJpZ2h0IENTUyBob29rIQoJCQl2YWwgKz0galF1ZXJ5LmNzcyggZWxlbSwgZXh0cmEgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSApOwoJCX0KCgkJLy8gRnJvbSB0aGlzIHBvaW50IG9uIHdlIHVzZSBjdXJDU1MgZm9yIG1heGltdW0gcGVyZm9ybWFuY2UgKHJlbGV2YW50IGluIGFuaW1hdGlvbnMpCgkJaWYgKCBpc0JvcmRlckJveCApIHsKCQkJLy8gYm9yZGVyLWJveCBpbmNsdWRlcyBwYWRkaW5nLCBzbyByZW1vdmUgaXQgaWYgd2Ugd2FudCBjb250ZW50CgkJCWlmICggZXh0cmEgPT09ICJjb250ZW50IiApIHsKCQkJCXZhbCAtPSBwYXJzZUZsb2F0KCBjdXJDU1MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdICkgKSB8fCAwOwoJCQl9CgoJCQkvLyBhdCB0aGlzIHBvaW50LCBleHRyYSBpc24ndCBib3JkZXIgbm9yIG1hcmdpbiwgc28gcmVtb3ZlIGJvcmRlcgoJCQlpZiAoIGV4dHJhICE9PSAibWFyZ2luIiApIHsKCQkJCXZhbCAtPSBwYXJzZUZsb2F0KCBjdXJDU1MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiICkgKSB8fCAwOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCwgc28gYWRkIHBhZGRpbmcKCQkJdmFsICs9IHBhcnNlRmxvYXQoIGN1ckNTUyggZWxlbSwgInBhZGRpbmciICsgY3NzRXhwYW5kWyBpIF0gKSApIHx8IDA7CgoJCQkvLyBhdCB0aGlzIHBvaW50LCBleHRyYSBpc24ndCBjb250ZW50IG5vciBwYWRkaW5nLCBzbyBhZGQgYm9yZGVyCgkJCWlmICggZXh0cmEgIT09ICJwYWRkaW5nIiApIHsKCQkJCXZhbCArPSBwYXJzZUZsb2F0KCBjdXJDU1MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiICkgKSB8fCAwOwoJCQl9CgkJfQoJfQoKCXJldHVybiB2YWw7Cn0KCmZ1bmN0aW9uIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICkgewoKCS8vIFN0YXJ0IHdpdGggb2Zmc2V0IHByb3BlcnR5LCB3aGljaCBpcyBlcXVpdmFsZW50IHRvIHRoZSBib3JkZXItYm94IHZhbHVlCgl2YXIgdmFsID0gbmFtZSA9PT0gIndpZHRoIiA/IGVsZW0ub2Zmc2V0V2lkdGggOiBlbGVtLm9mZnNldEhlaWdodCwKCQl2YWx1ZUlzQm9yZGVyQm94ID0gdHJ1ZSwKCQlpc0JvcmRlckJveCA9IGpRdWVyeS5zdXBwb3J0LmJveFNpemluZyAmJiBqUXVlcnkuY3NzKCBlbGVtLCAiYm94U2l6aW5nIiApID09PSAiYm9yZGVyLWJveCI7CgoJaWYgKCB2YWwgPD0gMCApIHsKCQkvLyBGYWxsIGJhY2sgdG8gY29tcHV0ZWQgdGhlbiB1bmNvbXB1dGVkIGNzcyBpZiBuZWNlc3NhcnkKCQl2YWwgPSBjdXJDU1MoIGVsZW0sIG5hbWUgKTsKCQlpZiAoIHZhbCA8IDAgfHwgdmFsID09IG51bGwgKSB7CgkJCXZhbCA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKCQl9CgoJCS8vIENvbXB1dGVkIHVuaXQgaXMgbm90IHBpeGVscy4gU3RvcCBoZXJlIGFuZCByZXR1cm4uCgkJaWYgKCBybnVtbm9ucHgudGVzdCh2YWwpICkgewoJCQlyZXR1cm4gdmFsOwoJCX0KCgkJLy8gd2UgbmVlZCB0aGUgY2hlY2sgZm9yIHN0eWxlIGluIGNhc2UgYSBicm93c2VyIHdoaWNoIHJldHVybnMgdW5yZWxpYWJsZSB2YWx1ZXMKCQkvLyBmb3IgZ2V0Q29tcHV0ZWRTdHlsZSBzaWxlbnRseSBmYWxscyBiYWNrIHRvIHRoZSByZWxpYWJsZSBlbGVtLnN0eWxlCgkJdmFsdWVJc0JvcmRlckJveCA9IGlzQm9yZGVyQm94ICYmICggalF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUgfHwgdmFsID09PSBlbGVtLnN0eWxlWyBuYW1lIF0gKTsKCgkJLy8gTm9ybWFsaXplICIiLCBhdXRvLCBhbmQgcHJlcGFyZSBmb3IgZXh0cmEKCQl2YWwgPSBwYXJzZUZsb2F0KCB2YWwgKSB8fCAwOwoJfQoKCS8vIHVzZSB0aGUgYWN0aXZlIGJveC1zaXppbmcgbW9kZWwgdG8gYWRkL3N1YnRyYWN0IGlycmVsZXZhbnQgc3R5bGVzCglyZXR1cm4gKCB2YWwgKwoJCWF1Z21lbnRXaWR0aE9ySGVpZ2h0KAoJCQllbGVtLAoJCQluYW1lLAoJCQlleHRyYSB8fCAoIGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIgKSwKCQkJdmFsdWVJc0JvcmRlckJveAoJCSkKCSkgKyAicHgiOwp9CgoKLy8gVHJ5IHRvIGRldGVybWluZSB0aGUgZGVmYXVsdCBkaXNwbGF5IHZhbHVlIG9mIGFuIGVsZW1lbnQKZnVuY3Rpb24gY3NzX2RlZmF1bHREaXNwbGF5KCBub2RlTmFtZSApIHsKCWlmICggZWxlbWRpc3BsYXlbIG5vZGVOYW1lIF0gKSB7CgkJcmV0dXJuIGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdOwoJfQoKCXZhciBlbGVtID0galF1ZXJ5KCAiPCIgKyBub2RlTmFtZSArICI+IiApLmFwcGVuZFRvKCBkb2N1bWVudC5ib2R5ICksCgkJZGlzcGxheSA9IGVsZW0uY3NzKCJkaXNwbGF5Iik7CgllbGVtLnJlbW92ZSgpOwoKCS8vIElmIHRoZSBzaW1wbGUgd2F5IGZhaWxzLAoJLy8gZ2V0IGVsZW1lbnQncyByZWFsIGRlZmF1bHQgZGlzcGxheSBieSBhdHRhY2hpbmcgaXQgdG8gYSB0ZW1wIGlmcmFtZQoJaWYgKCBkaXNwbGF5ID09PSAibm9uZSIgfHwgZGlzcGxheSA9PT0gIiIgKSB7CgkJLy8gVXNlIHRoZSBhbHJlYWR5LWNyZWF0ZWQgaWZyYW1lIGlmIHBvc3NpYmxlCgkJaWZyYW1lID0gZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCgKCQkJaWZyYW1lIHx8IGpRdWVyeS5leHRlbmQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlmcmFtZSIpLCB7CgkJCQlmcmFtZUJvcmRlcjogMCwKCQkJCXdpZHRoOiAwLAoJCQkJaGVpZ2h0OiAwCgkJCX0pCgkJKTsKCgkJLy8gQ3JlYXRlIGEgY2FjaGVhYmxlIGNvcHkgb2YgdGhlIGlmcmFtZSBkb2N1bWVudCBvbiBmaXJzdCBjYWxsLgoJCS8vIElFIGFuZCBPcGVyYSB3aWxsIGFsbG93IHVzIHRvIHJldXNlIHRoZSBpZnJhbWVEb2Mgd2l0aG91dCByZS13cml0aW5nIHRoZSBmYWtlIEhUTUwKCQkvLyBkb2N1bWVudCB0byBpdDsgV2ViS2l0ICYgRmlyZWZveCB3b24ndCBhbGxvdyByZXVzaW5nIHRoZSBpZnJhbWUgZG9jdW1lbnQuCgkJaWYgKCAhaWZyYW1lRG9jIHx8ICFpZnJhbWUuY3JlYXRlRWxlbWVudCApIHsKCQkJaWZyYW1lRG9jID0gKCBpZnJhbWUuY29udGVudFdpbmRvdyB8fCBpZnJhbWUuY29udGVudERvY3VtZW50ICkuZG9jdW1lbnQ7CgkJCWlmcmFtZURvYy53cml0ZSgiPCFkb2N0eXBlIGh0bWw+PGh0bWw+PGJvZHk+Iik7CgkJCWlmcmFtZURvYy5jbG9zZSgpOwoJCX0KCgkJZWxlbSA9IGlmcmFtZURvYy5ib2R5LmFwcGVuZENoaWxkKCBpZnJhbWVEb2MuY3JlYXRlRWxlbWVudChub2RlTmFtZSkgKTsKCgkJZGlzcGxheSA9IGN1ckNTUyggZWxlbSwgImRpc3BsYXkiICk7CgkJZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCggaWZyYW1lICk7Cgl9CgoJLy8gU3RvcmUgdGhlIGNvcnJlY3QgZGVmYXVsdCBkaXNwbGF5CgllbGVtZGlzcGxheVsgbm9kZU5hbWUgXSA9IGRpc3BsYXk7CgoJcmV0dXJuIGRpc3BsYXk7Cn0KCmpRdWVyeS5lYWNoKFsgImhlaWdodCIsICJ3aWR0aCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CglqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCwgZXh0cmEgKSB7CgkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQlpZiAoIGVsZW0ub2Zmc2V0V2lkdGggIT09IDAgfHwgY3VyQ1NTKCBlbGVtLCAiZGlzcGxheSIgKSAhPT0gIm5vbmUiICkgewoJCQkJCXJldHVybiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4galF1ZXJ5LnN3YXAoIGVsZW0sIGNzc1Nob3csIGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gZ2V0V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEgKTsKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0sCgoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBleHRyYSApIHsKCQkJcmV0dXJuIHNldFBvc2l0aXZlTnVtYmVyKCBlbGVtLCB2YWx1ZSwgZXh0cmEgPwoJCQkJYXVnbWVudFdpZHRoT3JIZWlnaHQoCgkJCQkJZWxlbSwKCQkJCQluYW1lLAoJCQkJCWV4dHJhLAoJCQkJCWpRdWVyeS5zdXBwb3J0LmJveFNpemluZyAmJiBqUXVlcnkuY3NzKCBlbGVtLCAiYm94U2l6aW5nIiApID09PSAiYm9yZGVyLWJveCIKCQkJCSkgOiAwCgkJCSk7CgkJfQoJfTsKfSk7CgppZiAoICFqUXVlcnkuc3VwcG9ydC5vcGFjaXR5ICkgewoJalF1ZXJ5LmNzc0hvb2tzLm9wYWNpdHkgPSB7CgkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7CgkJCS8vIElFIHVzZXMgZmlsdGVycyBmb3Igb3BhY2l0eQoJCQlyZXR1cm4gcm9wYWNpdHkudGVzdCggKGNvbXB1dGVkICYmIGVsZW0uY3VycmVudFN0eWxlID8gZWxlbS5jdXJyZW50U3R5bGUuZmlsdGVyIDogZWxlbS5zdHlsZS5maWx0ZXIpIHx8ICIiICkgPwoJCQkJKCAwLjAxICogcGFyc2VGbG9hdCggUmVnRXhwLiQxICkgKSArICIiIDoKCQkJCWNvbXB1dGVkID8gIjEiIDogIiI7CgkJfSwKCgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCXZhciBzdHlsZSA9IGVsZW0uc3R5bGUsCgkJCQljdXJyZW50U3R5bGUgPSBlbGVtLmN1cnJlbnRTdHlsZSwKCQkJCW9wYWNpdHkgPSBqUXVlcnkuaXNOdW1lcmljKCB2YWx1ZSApID8gImFscGhhKG9wYWNpdHk9IiArIHZhbHVlICogMTAwICsgIikiIDogIiIsCgkJCQlmaWx0ZXIgPSBjdXJyZW50U3R5bGUgJiYgY3VycmVudFN0eWxlLmZpbHRlciB8fCBzdHlsZS5maWx0ZXIgfHwgIiI7CgoJCQkvLyBJRSBoYXMgdHJvdWJsZSB3aXRoIG9wYWNpdHkgaWYgaXQgZG9lcyBub3QgaGF2ZSBsYXlvdXQKCQkJLy8gRm9yY2UgaXQgYnkgc2V0dGluZyB0aGUgem9vbSBsZXZlbAoJCQlzdHlsZS56b29tID0gMTsKCgkJCS8vIGlmIHNldHRpbmcgb3BhY2l0eSB0byAxLCBhbmQgbm8gb3RoZXIgZmlsdGVycyBleGlzdCAtIGF0dGVtcHQgdG8gcmVtb3ZlIGZpbHRlciBhdHRyaWJ1dGUgIzY2NTIKCQkJaWYgKCB2YWx1ZSA+PSAxICYmIGpRdWVyeS50cmltKCBmaWx0ZXIucmVwbGFjZSggcmFscGhhLCAiIiApICkgPT09ICIiICkgewoKCQkJCS8vIFNldHRpbmcgc3R5bGUuZmlsdGVyIHRvIG51bGwsICIiICYgIiAiIHN0aWxsIGxlYXZlICJmaWx0ZXI6IiBpbiB0aGUgY3NzVGV4dAoJCQkJLy8gaWYgImZpbHRlcjoiIGlzIHByZXNlbnQgYXQgYWxsLCBjbGVhclR5cGUgaXMgZGlzYWJsZWQsIHdlIHdhbnQgdG8gYXZvaWQgdGhpcwoJCQkJLy8gc3R5bGUucmVtb3ZlQXR0cmlidXRlIGlzIElFIE9ubHksIGJ1dCBzbyBhcHBhcmVudGx5IGlzIHRoaXMgY29kZSBwYXRoLi4uCgkJCQlzdHlsZS5yZW1vdmVBdHRyaWJ1dGUoICJmaWx0ZXIiICk7CgoJCQkJLy8gaWYgdGhlcmUgdGhlcmUgaXMgbm8gZmlsdGVyIHN0eWxlIGFwcGxpZWQgaW4gYSBjc3MgcnVsZSwgd2UgYXJlIGRvbmUKCQkJCWlmICggY3VycmVudFN0eWxlICYmICFjdXJyZW50U3R5bGUuZmlsdGVyICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gb3RoZXJ3aXNlLCBzZXQgbmV3IGZpbHRlciB2YWx1ZXMKCQkJc3R5bGUuZmlsdGVyID0gcmFscGhhLnRlc3QoIGZpbHRlciApID8KCQkJCWZpbHRlci5yZXBsYWNlKCByYWxwaGEsIG9wYWNpdHkgKSA6CgkJCQlmaWx0ZXIgKyAiICIgKyBvcGFjaXR5OwoJCX0KCX07Cn0KCi8vIFRoZXNlIGhvb2tzIGNhbm5vdCBiZSBhZGRlZCB1bnRpbCBET00gcmVhZHkgYmVjYXVzZSB0aGUgc3VwcG9ydCB0ZXN0Ci8vIGZvciBpdCBpcyBub3QgcnVuIHVudGlsIGFmdGVyIERPTSByZWFkeQpqUXVlcnkoZnVuY3Rpb24oKSB7CglpZiAoICFqUXVlcnkuc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ICkgewoJCWpRdWVyeS5jc3NIb29rcy5tYXJnaW5SaWdodCA9IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7CgkJCQkvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKCQkJCS8vIFdvcmsgYXJvdW5kIGJ5IHRlbXBvcmFyaWx5IHNldHRpbmcgZWxlbWVudCBkaXNwbGF5IHRvIGlubGluZS1ibG9jawoJCQkJcmV0dXJuIGpRdWVyeS5zd2FwKCBlbGVtLCB7ICJkaXNwbGF5IjogImlubGluZS1ibG9jayIgfSwgZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCBjb21wdXRlZCApIHsKCQkJCQkJcmV0dXJuIGN1ckNTUyggZWxlbSwgIm1hcmdpblJpZ2h0IiApOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJfTsKCX0KCgkvLyBXZWJraXQgYnVnOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MjkwODQKCS8vIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyBwZXJjZW50IHdoZW4gc3BlY2lmaWVkIGZvciB0b3AvbGVmdC9ib3R0b20vcmlnaHQKCS8vIHJhdGhlciB0aGFuIG1ha2UgdGhlIGNzcyBtb2R1bGUgZGVwZW5kIG9uIHRoZSBvZmZzZXQgbW9kdWxlLCB3ZSBqdXN0IGNoZWNrIGZvciBpdCBoZXJlCglpZiAoICFqUXVlcnkuc3VwcG9ydC5waXhlbFBvc2l0aW9uICYmIGpRdWVyeS5mbi5wb3NpdGlvbiApIHsKCQlqUXVlcnkuZWFjaCggWyAidG9wIiwgImxlZnQiIF0sIGZ1bmN0aW9uKCBpLCBwcm9wICkgewoJCQlqUXVlcnkuY3NzSG9va3NbIHByb3AgXSA9IHsKCQkJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQkJCXZhciByZXQgPSBjdXJDU1MoIGVsZW0sIHByb3AgKTsKCQkJCQkJLy8gaWYgY3VyQ1NTIHJldHVybnMgcGVyY2VudGFnZSwgZmFsbGJhY2sgdG8gb2Zmc2V0CgkJCQkJCXJldHVybiBybnVtbm9ucHgudGVzdCggcmV0ICkgPyBqUXVlcnkoIGVsZW0gKS5wb3NpdGlvbigpWyBwcm9wIF0gKyAicHgiIDogcmV0OwoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCX0KCn0pOwoKaWYgKCBqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzICkgewoJalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gKCBlbGVtLm9mZnNldFdpZHRoID09PSAwICYmIGVsZW0ub2Zmc2V0SGVpZ2h0ID09PSAwICkgfHwgKCFqUXVlcnkuc3VwcG9ydC5yZWxpYWJsZUhpZGRlbk9mZnNldHMgJiYgKChlbGVtLnN0eWxlICYmIGVsZW0uc3R5bGUuZGlzcGxheSkgfHwgY3VyQ1NTKCBlbGVtLCAiZGlzcGxheSIgKSkgPT09ICJub25lIik7Cgl9OwoKCWpRdWVyeS5leHByLmZpbHRlcnMudmlzaWJsZSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4oIGVsZW0gKTsKCX07Cn0KCi8vIFRoZXNlIGhvb2tzIGFyZSB1c2VkIGJ5IGFuaW1hdGUgdG8gZXhwYW5kIHByb3BlcnRpZXMKalF1ZXJ5LmVhY2goewoJbWFyZ2luOiAiIiwKCXBhZGRpbmc6ICIiLAoJYm9yZGVyOiAiV2lkdGgiCn0sIGZ1bmN0aW9uKCBwcmVmaXgsIHN1ZmZpeCApIHsKCWpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0gPSB7CgkJZXhwYW5kOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciBpLAoKCQkJCS8vIGFzc3VtZXMgYSBzaW5nbGUgbnVtYmVyIGlmIG5vdCBhIHN0cmluZwoJCQkJcGFydHMgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciID8gdmFsdWUuc3BsaXQoIiAiKSA6IFsgdmFsdWUgXSwKCQkJCWV4cGFuZGVkID0ge307CgoJCQlmb3IgKCBpID0gMDsgaSA8IDQ7IGkrKyApIHsKCQkJCWV4cGFuZGVkWyBwcmVmaXggKyBjc3NFeHBhbmRbIGkgXSArIHN1ZmZpeCBdID0KCQkJCQlwYXJ0c1sgaSBdIHx8IHBhcnRzWyBpIC0gMiBdIHx8IHBhcnRzWyAwIF07CgkJCX0KCgkJCXJldHVybiBleHBhbmRlZDsKCQl9Cgl9OwoKCWlmICggIXJtYXJnaW4udGVzdCggcHJlZml4ICkgKSB7CgkJalF1ZXJ5LmNzc0hvb2tzWyBwcmVmaXggKyBzdWZmaXggXS5zZXQgPSBzZXRQb3NpdGl2ZU51bWJlcjsKCX0KfSk7CnZhciByMjAgPSAvJTIwL2csCglyYnJhY2tldCA9IC9cW1xdJC8sCglyQ1JMRiA9IC9ccj9cbi9nLAoJcmlucHV0ID0gL14oPzpjb2xvcnxkYXRlfGRhdGV0aW1lfGRhdGV0aW1lLWxvY2FsfGVtYWlsfGhpZGRlbnxtb250aHxudW1iZXJ8cGFzc3dvcmR8cmFuZ2V8c2VhcmNofHRlbHx0ZXh0fHRpbWV8dXJsfHdlZWspJC9pLAoJcnNlbGVjdFRleHRhcmVhID0gL14oPzpzZWxlY3R8dGV4dGFyZWEpL2k7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXNlcmlhbGl6ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGpRdWVyeS5wYXJhbSggdGhpcy5zZXJpYWxpemVBcnJheSgpICk7Cgl9LAoJc2VyaWFsaXplQXJyYXk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50cyA/IGpRdWVyeS5tYWtlQXJyYXkoIHRoaXMuZWxlbWVudHMgKSA6IHRoaXM7CgkJfSkKCQkuZmlsdGVyKGZ1bmN0aW9uKCl7CgkJCXJldHVybiB0aGlzLm5hbWUgJiYgIXRoaXMuZGlzYWJsZWQgJiYKCQkJCSggdGhpcy5jaGVja2VkIHx8IHJzZWxlY3RUZXh0YXJlYS50ZXN0KCB0aGlzLm5vZGVOYW1lICkgfHwKCQkJCQlyaW5wdXQudGVzdCggdGhpcy50eXBlICkgKTsKCQl9KQoJCS5tYXAoZnVuY3Rpb24oIGksIGVsZW0gKXsKCQkJdmFyIHZhbCA9IGpRdWVyeSggdGhpcyApLnZhbCgpOwoKCQkJcmV0dXJuIHZhbCA9PSBudWxsID8KCQkJCW51bGwgOgoJCQkJalF1ZXJ5LmlzQXJyYXkoIHZhbCApID8KCQkJCQlqUXVlcnkubWFwKCB2YWwsIGZ1bmN0aW9uKCB2YWwsIGkgKXsKCQkJCQkJcmV0dXJuIHsgbmFtZTogZWxlbS5uYW1lLCB2YWx1ZTogdmFsLnJlcGxhY2UoIHJDUkxGLCAiXHJcbiIgKSB9OwoJCQkJCX0pIDoKCQkJCQl7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsKCQl9KS5nZXQoKTsKCX0KfSk7CgovL1NlcmlhbGl6ZSBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzIG9yIGEgc2V0IG9mCi8va2V5L3ZhbHVlcyBpbnRvIGEgcXVlcnkgc3RyaW5nCmpRdWVyeS5wYXJhbSA9IGZ1bmN0aW9uKCBhLCB0cmFkaXRpb25hbCApIHsKCXZhciBwcmVmaXgsCgkJcyA9IFtdLAoJCWFkZCA9IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHJldHVybiBpdHMgdmFsdWUKCQkJdmFsdWUgPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSA/IHZhbHVlKCkgOiAoIHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlICk7CgkJCXNbIHMubGVuZ3RoIF0gPSBlbmNvZGVVUklDb21wb25lbnQoIGtleSApICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KCB2YWx1ZSApOwoJCX07CgoJLy8gU2V0IHRyYWRpdGlvbmFsIHRvIHRydWUgZm9yIGpRdWVyeSA8PSAxLjMuMiBiZWhhdmlvci4KCWlmICggdHJhZGl0aW9uYWwgPT09IHVuZGVmaW5lZCApIHsKCQl0cmFkaXRpb25hbCA9IGpRdWVyeS5hamF4U2V0dGluZ3MgJiYgalF1ZXJ5LmFqYXhTZXR0aW5ncy50cmFkaXRpb25hbDsKCX0KCgkvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgoJaWYgKCBqUXVlcnkuaXNBcnJheSggYSApIHx8ICggYS5qcXVlcnkgJiYgIWpRdWVyeS5pc1BsYWluT2JqZWN0KCBhICkgKSApIHsKCQkvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKCQlqUXVlcnkuZWFjaCggYSwgZnVuY3Rpb24oKSB7CgkJCWFkZCggdGhpcy5uYW1lLCB0aGlzLnZhbHVlICk7CgkJfSk7CgoJfSBlbHNlIHsKCQkvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKCQkvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KCQlmb3IgKCBwcmVmaXggaW4gYSApIHsKCQkJYnVpbGRQYXJhbXMoIHByZWZpeCwgYVsgcHJlZml4IF0sIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQl9Cgl9CgoJLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgoJcmV0dXJuIHMuam9pbiggIiYiICkucmVwbGFjZSggcjIwLCAiKyIgKTsKfTsKCmZ1bmN0aW9uIGJ1aWxkUGFyYW1zKCBwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCApIHsKCXZhciBuYW1lOwoKCWlmICggalF1ZXJ5LmlzQXJyYXkoIG9iaiApICkgewoJCS8vIFNlcmlhbGl6ZSBhcnJheSBpdGVtLgoJCWpRdWVyeS5lYWNoKCBvYmosIGZ1bmN0aW9uKCBpLCB2ICkgewoJCQlpZiAoIHRyYWRpdGlvbmFsIHx8IHJicmFja2V0LnRlc3QoIHByZWZpeCApICkgewoJCQkJLy8gVHJlYXQgZWFjaCBhcnJheSBpdGVtIGFzIGEgc2NhbGFyLgoJCQkJYWRkKCBwcmVmaXgsIHYgKTsKCgkJCX0gZWxzZSB7CgkJCQkvLyBJZiBhcnJheSBpdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMKCQkJCS8vIG51bWVyaWMgaW5kZXggdG8gcmVzb2x2ZSBkZXNlcmlhbGl6YXRpb24gYW1iaWd1aXR5IGlzc3Vlcy4KCQkJCS8vIE5vdGUgdGhhdCByYWNrIChhcyBvZiAxLjAuMCkgY2FuJ3QgY3VycmVudGx5IGRlc2VyaWFsaXplCgkJCQkvLyBuZXN0ZWQgYXJyYXlzIHByb3Blcmx5LCBhbmQgYXR0ZW1wdGluZyB0byBkbyBzbyBtYXkgY2F1c2UKCQkJCS8vIGEgc2VydmVyIGVycm9yLiBQb3NzaWJsZSBmaXhlcyBhcmUgdG8gbW9kaWZ5IHJhY2sncwoJCQkJLy8gZGVzZXJpYWxpemF0aW9uIGFsZ29yaXRobSBvciB0byBwcm92aWRlIGFuIG9wdGlvbiBvciBmbGFnCgkJCQkvLyB0byBmb3JjZSBhcnJheSBzZXJpYWxpemF0aW9uIHRvIGJlIHNoYWxsb3cuCgkJCQlidWlsZFBhcmFtcyggcHJlZml4ICsgIlsiICsgKCB0eXBlb2YgdiA9PT0gIm9iamVjdCIgPyBpIDogIiIgKSArICJdIiwgdiwgdHJhZGl0aW9uYWwsIGFkZCApOwoJCQl9CgkJfSk7CgoJfSBlbHNlIGlmICggIXRyYWRpdGlvbmFsICYmIGpRdWVyeS50eXBlKCBvYmogKSA9PT0gIm9iamVjdCIgKSB7CgkJLy8gU2VyaWFsaXplIG9iamVjdCBpdGVtLgoJCWZvciAoIG5hbWUgaW4gb2JqICkgewoJCQlidWlsZFBhcmFtcyggcHJlZml4ICsgIlsiICsgbmFtZSArICJdIiwgb2JqWyBuYW1lIF0sIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQl9CgoJfSBlbHNlIHsKCQkvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCgkJYWRkKCBwcmVmaXgsIG9iaiApOwoJfQp9CnZhciAvLyBEb2N1bWVudCBsb2NhdGlvbgoJYWpheExvY2F0aW9uLAoJLy8gRG9jdW1lbnQgbG9jYXRpb24gc2VnbWVudHMKCWFqYXhMb2NQYXJ0cywKCglyaGFzaCA9IC8jLiokLywKCXJoZWFkZXJzID0gL14oLio/KTpbIFx0XSooW15cclxuXSopXHI/JC9tZywgLy8gSUUgbGVhdmVzIGFuIFxyIGNoYXJhY3RlciBhdCBFT0wKCS8vICM3NjUzLCAjODEyNSwgIzgxNTI6IGxvY2FsIHByb3RvY29sIGRldGVjdGlvbgoJcmxvY2FsUHJvdG9jb2wgPSAvXig/OmFib3V0fGFwcHxhcHBcLXN0b3JhZ2V8LitcLWV4dGVuc2lvbnxmaWxlfHJlc3x3aWRnZXQpOiQvLAoJcm5vQ29udGVudCA9IC9eKD86R0VUfEhFQUQpJC8sCglycHJvdG9jb2wgPSAvXlwvXC8vLAoJcnF1ZXJ5ID0gL1w/LywKCXJzY3JpcHQgPSAvPHNjcmlwdFxiW148XSooPzooPyE8XC9zY3JpcHQ+KTxbXjxdKikqPFwvc2NyaXB0Pi9naSwKCXJ0cyA9IC8oWz8mXSlfPVteJl0qLywKCXJ1cmwgPSAvXihbXHdcK1wuXC1dKzopKD86XC9cLyhbXlwvPyM6XSopKD86OihcZCspfCl8KS8sCgoJLy8gS2VlcCBhIGNvcHkgb2YgdGhlIG9sZCBsb2FkIG1ldGhvZAoJX2xvYWQgPSBqUXVlcnkuZm4ubG9hZCwKCgkvKiBQcmVmaWx0ZXJzCgkgKiAxKSBUaGV5IGFyZSB1c2VmdWwgdG8gaW50cm9kdWNlIGN1c3RvbSBkYXRhVHlwZXMgKHNlZSBhamF4L2pzb25wLmpzIGZvciBhbiBleGFtcGxlKQoJICogMikgVGhlc2UgYXJlIGNhbGxlZDoKCSAqICAgIC0gQkVGT1JFIGFza2luZyBmb3IgYSB0cmFuc3BvcnQKCSAqICAgIC0gQUZURVIgcGFyYW0gc2VyaWFsaXphdGlvbiAocy5kYXRhIGlzIGEgc3RyaW5nIGlmIHMucHJvY2Vzc0RhdGEgaXMgdHJ1ZSkKCSAqIDMpIGtleSBpcyB0aGUgZGF0YVR5cGUKCSAqIDQpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCgkgKiA1KSBleGVjdXRpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBjb250aW51ZSBkb3duIHRvICIqIiBpZiBuZWVkZWQKCSAqLwoJcHJlZmlsdGVycyA9IHt9LAoKCS8qIFRyYW5zcG9ydHMgYmluZGluZ3MKCSAqIDEpIGtleSBpcyB0aGUgZGF0YVR5cGUKCSAqIDIpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCgkgKiAzKSBzZWxlY3Rpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBnbyB0byAiKiIgaWYgbmVlZGVkCgkgKi8KCXRyYW5zcG9ydHMgPSB7fSwKCgkvLyBBdm9pZCBjb21tZW50LXByb2xvZyBjaGFyIHNlcXVlbmNlICgjMTAwOTgpOyBtdXN0IGFwcGVhc2UgbGludCBhbmQgZXZhZGUgY29tcHJlc3Npb24KCWFsbFR5cGVzID0gWyIqLyJdICsgWyIqIl07CgovLyAjODEzOCwgSUUgbWF5IHRocm93IGFuIGV4Y2VwdGlvbiB3aGVuIGFjY2Vzc2luZwovLyBhIGZpZWxkIGZyb20gd2luZG93LmxvY2F0aW9uIGlmIGRvY3VtZW50LmRvbWFpbiBoYXMgYmVlbiBzZXQKdHJ5IHsKCWFqYXhMb2NhdGlvbiA9IGxvY2F0aW9uLmhyZWY7Cn0gY2F0Y2goIGUgKSB7CgkvLyBVc2UgdGhlIGhyZWYgYXR0cmlidXRlIG9mIGFuIEEgZWxlbWVudAoJLy8gc2luY2UgSUUgd2lsbCBtb2RpZnkgaXQgZ2l2ZW4gZG9jdW1lbnQubG9jYXRpb24KCWFqYXhMb2NhdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJYWpheExvY2F0aW9uLmhyZWYgPSAiIjsKCWFqYXhMb2NhdGlvbiA9IGFqYXhMb2NhdGlvbi5ocmVmOwp9CgovLyBTZWdtZW50IGxvY2F0aW9uIGludG8gcGFydHMKYWpheExvY1BhcnRzID0gcnVybC5leGVjKCBhamF4TG9jYXRpb24udG9Mb3dlckNhc2UoKSApIHx8IFtdOwoKLy8gQmFzZSAiY29uc3RydWN0b3IiIGZvciBqUXVlcnkuYWpheFByZWZpbHRlciBhbmQgalF1ZXJ5LmFqYXhUcmFuc3BvcnQKZnVuY3Rpb24gYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBzdHJ1Y3R1cmUgKSB7CgoJLy8gZGF0YVR5cGVFeHByZXNzaW9uIGlzIG9wdGlvbmFsIGFuZCBkZWZhdWx0cyB0byAiKiIKCXJldHVybiBmdW5jdGlvbiggZGF0YVR5cGVFeHByZXNzaW9uLCBmdW5jICkgewoKCQlpZiAoIHR5cGVvZiBkYXRhVHlwZUV4cHJlc3Npb24gIT09ICJzdHJpbmciICkgewoJCQlmdW5jID0gZGF0YVR5cGVFeHByZXNzaW9uOwoJCQlkYXRhVHlwZUV4cHJlc3Npb24gPSAiKiI7CgkJfQoKCQl2YXIgZGF0YVR5cGUsIGxpc3QsIHBsYWNlQmVmb3JlLAoJCQlkYXRhVHlwZXMgPSBkYXRhVHlwZUV4cHJlc3Npb24udG9Mb3dlckNhc2UoKS5zcGxpdCggY29yZV9yc3BhY2UgKSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGRhdGFUeXBlcy5sZW5ndGg7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGZ1bmMgKSApIHsKCQkJLy8gRm9yIGVhY2ggZGF0YVR5cGUgaW4gdGhlIGRhdGFUeXBlRXhwcmVzc2lvbgoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWRhdGFUeXBlID0gZGF0YVR5cGVzWyBpIF07CgkJCQkvLyBXZSBjb250cm9sIGlmIHdlJ3JlIGFza2VkIHRvIGFkZCBiZWZvcmUKCQkJCS8vIGFueSBleGlzdGluZyBlbGVtZW50CgkJCQlwbGFjZUJlZm9yZSA9IC9eXCsvLnRlc3QoIGRhdGFUeXBlICk7CgkJCQlpZiAoIHBsYWNlQmVmb3JlICkgewoJCQkJCWRhdGFUeXBlID0gZGF0YVR5cGUuc3Vic3RyKCAxICkgfHwgIioiOwoJCQkJfQoJCQkJbGlzdCA9IHN0cnVjdHVyZVsgZGF0YVR5cGUgXSA9IHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXTsKCQkJCS8vIHRoZW4gd2UgYWRkIHRvIHRoZSBzdHJ1Y3R1cmUgYWNjb3JkaW5nbHkKCQkJCWxpc3RbIHBsYWNlQmVmb3JlID8gInVuc2hpZnQiIDogInB1c2giIF0oIGZ1bmMgKTsKCQkJfQoJCX0KCX07Cn0KCi8vIEJhc2UgaW5zcGVjdGlvbiBmdW5jdGlvbiBmb3IgcHJlZmlsdGVycyBhbmQgdHJhbnNwb3J0cwpmdW5jdGlvbiBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSLAoJCWRhdGFUeXBlIC8qIGludGVybmFsICovLCBpbnNwZWN0ZWQgLyogaW50ZXJuYWwgKi8gKSB7CgoJZGF0YVR5cGUgPSBkYXRhVHlwZSB8fCBvcHRpb25zLmRhdGFUeXBlc1sgMCBdOwoJaW5zcGVjdGVkID0gaW5zcGVjdGVkIHx8IHt9OwoKCWluc3BlY3RlZFsgZGF0YVR5cGUgXSA9IHRydWU7CgoJdmFyIHNlbGVjdGlvbiwKCQlsaXN0ID0gc3RydWN0dXJlWyBkYXRhVHlwZSBdLAoJCWkgPSAwLAoJCWxlbmd0aCA9IGxpc3QgPyBsaXN0Lmxlbmd0aCA6IDAsCgkJZXhlY3V0ZU9ubHkgPSAoIHN0cnVjdHVyZSA9PT0gcHJlZmlsdGVycyApOwoKCWZvciAoIDsgaSA8IGxlbmd0aCAmJiAoIGV4ZWN1dGVPbmx5IHx8ICFzZWxlY3Rpb24gKTsgaSsrICkgewoJCXNlbGVjdGlvbiA9IGxpc3RbIGkgXSggb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApOwoJCS8vIElmIHdlIGdvdCByZWRpcmVjdGVkIHRvIGFub3RoZXIgZGF0YVR5cGUKCQkvLyB3ZSB0cnkgdGhlcmUgaWYgZXhlY3V0aW5nIG9ubHkgYW5kIG5vdCBkb25lIGFscmVhZHkKCQlpZiAoIHR5cGVvZiBzZWxlY3Rpb24gPT09ICJzdHJpbmciICkgewoJCQlpZiAoICFleGVjdXRlT25seSB8fCBpbnNwZWN0ZWRbIHNlbGVjdGlvbiBdICkgewoJCQkJc2VsZWN0aW9uID0gdW5kZWZpbmVkOwoJCQl9IGVsc2UgewoJCQkJb3B0aW9ucy5kYXRhVHlwZXMudW5zaGlmdCggc2VsZWN0aW9uICk7CgkJCQlzZWxlY3Rpb24gPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cygKCQkJCQkJc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSLCBzZWxlY3Rpb24sIGluc3BlY3RlZCApOwoJCQl9CgkJfQoJfQoJLy8gSWYgd2UncmUgb25seSBleGVjdXRpbmcgb3Igbm90aGluZyB3YXMgc2VsZWN0ZWQKCS8vIHdlIHRyeSB0aGUgY2F0Y2hhbGwgZGF0YVR5cGUgaWYgbm90IGRvbmUgYWxyZWFkeQoJaWYgKCAoIGV4ZWN1dGVPbmx5IHx8ICFzZWxlY3Rpb24gKSAmJiAhaW5zcGVjdGVkWyAiKiIgXSApIHsKCQlzZWxlY3Rpb24gPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cygKCQkJCXN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiwgIioiLCBpbnNwZWN0ZWQgKTsKCX0KCS8vIHVubmVjZXNzYXJ5IHdoZW4gb25seSBleGVjdXRpbmcgKHByZWZpbHRlcnMpCgkvLyBidXQgaXQnbGwgYmUgaWdub3JlZCBieSB0aGUgY2FsbGVyIGluIHRoYXQgY2FzZQoJcmV0dXJuIHNlbGVjdGlvbjsKfQoKLy8gQSBzcGVjaWFsIGV4dGVuZCBmb3IgYWpheCBvcHRpb25zCi8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQovLyBGaXhlcyAjOTg4NwpmdW5jdGlvbiBhamF4RXh0ZW5kKCB0YXJnZXQsIHNyYyApIHsKCXZhciBrZXksIGRlZXAsCgkJZmxhdE9wdGlvbnMgPSBqUXVlcnkuYWpheFNldHRpbmdzLmZsYXRPcHRpb25zIHx8IHt9OwoJZm9yICgga2V5IGluIHNyYyApIHsKCQlpZiAoIHNyY1sga2V5IF0gIT09IHVuZGVmaW5lZCApIHsKCQkJKCBmbGF0T3B0aW9uc1sga2V5IF0gPyB0YXJnZXQgOiAoIGRlZXAgfHwgKCBkZWVwID0ge30gKSApIClbIGtleSBdID0gc3JjWyBrZXkgXTsKCQl9Cgl9CglpZiAoIGRlZXAgKSB7CgkJalF1ZXJ5LmV4dGVuZCggdHJ1ZSwgdGFyZ2V0LCBkZWVwICk7Cgl9Cn0KCmpRdWVyeS5mbi5sb2FkID0gZnVuY3Rpb24oIHVybCwgcGFyYW1zLCBjYWxsYmFjayApIHsKCWlmICggdHlwZW9mIHVybCAhPT0gInN0cmluZyIgJiYgX2xvYWQgKSB7CgkJcmV0dXJuIF9sb2FkLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCX0KCgkvLyBEb24ndCBkbyBhIHJlcXVlc3QgaWYgbm8gZWxlbWVudHMgYXJlIGJlaW5nIHJlcXVlc3RlZAoJaWYgKCAhdGhpcy5sZW5ndGggKSB7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJdmFyIHNlbGVjdG9yLCB0eXBlLCByZXNwb25zZSwKCQlzZWxmID0gdGhpcywKCQlvZmYgPSB1cmwuaW5kZXhPZigiICIpOwoKCWlmICggb2ZmID49IDAgKSB7CgkJc2VsZWN0b3IgPSB1cmwuc2xpY2UoIG9mZiwgdXJsLmxlbmd0aCApOwoJCXVybCA9IHVybC5zbGljZSggMCwgb2ZmICk7Cgl9CgoJLy8gSWYgaXQncyBhIGZ1bmN0aW9uCglpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwYXJhbXMgKSApIHsKCgkJLy8gV2UgYXNzdW1lIHRoYXQgaXQncyB0aGUgY2FsbGJhY2sKCQljYWxsYmFjayA9IHBhcmFtczsKCQlwYXJhbXMgPSB1bmRlZmluZWQ7CgoJLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZwoJfSBlbHNlIGlmICggdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSB7CgkJdHlwZSA9ICJQT1NUIjsKCX0KCgkvLyBSZXF1ZXN0IHRoZSByZW1vdGUgZG9jdW1lbnQKCWpRdWVyeS5hamF4KHsKCQl1cmw6IHVybCwKCgkJLy8gaWYgInR5cGUiIHZhcmlhYmxlIGlzIHVuZGVmaW5lZCwgdGhlbiAiR0VUIiBtZXRob2Qgd2lsbCBiZSB1c2VkCgkJdHlwZTogdHlwZSwKCQlkYXRhVHlwZTogImh0bWwiLAoJCWRhdGE6IHBhcmFtcywKCQljb21wbGV0ZTogZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CgkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQlzZWxmLmVhY2goIGNhbGxiYWNrLCByZXNwb25zZSB8fCBbIGpxWEhSLnJlc3BvbnNlVGV4dCwgc3RhdHVzLCBqcVhIUiBdICk7CgkJCX0KCQl9Cgl9KS5kb25lKGZ1bmN0aW9uKCByZXNwb25zZVRleHQgKSB7CgoJCS8vIFNhdmUgcmVzcG9uc2UgZm9yIHVzZSBpbiBjb21wbGV0ZSBjYWxsYmFjawoJCXJlc3BvbnNlID0gYXJndW1lbnRzOwoKCQkvLyBTZWUgaWYgYSBzZWxlY3RvciB3YXMgc3BlY2lmaWVkCgkJc2VsZi5odG1sKCBzZWxlY3RvciA/CgoJCQkvLyBDcmVhdGUgYSBkdW1teSBkaXYgdG8gaG9sZCB0aGUgcmVzdWx0cwoJCQlqUXVlcnkoIjxkaXY+IikKCgkJCQkvLyBpbmplY3QgdGhlIGNvbnRlbnRzIG9mIHRoZSBkb2N1bWVudCBpbiwgcmVtb3ZpbmcgdGhlIHNjcmlwdHMKCQkJCS8vIHRvIGF2b2lkIGFueSAnUGVybWlzc2lvbiBEZW5pZWQnIGVycm9ycyBpbiBJRQoJCQkJLmFwcGVuZCggcmVzcG9uc2VUZXh0LnJlcGxhY2UoIHJzY3JpcHQsICIiICkgKQoKCQkJCS8vIExvY2F0ZSB0aGUgc3BlY2lmaWVkIGVsZW1lbnRzCgkJCQkuZmluZCggc2VsZWN0b3IgKSA6CgoJCQkvLyBJZiBub3QsIGp1c3QgaW5qZWN0IHRoZSBmdWxsIHJlc3VsdAoJCQlyZXNwb25zZVRleHQgKTsKCgl9KTsKCglyZXR1cm4gdGhpczsKfTsKCi8vIEF0dGFjaCBhIGJ1bmNoIG9mIGZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgY29tbW9uIEFKQVggZXZlbnRzCmpRdWVyeS5lYWNoKCAiYWpheFN0YXJ0IGFqYXhTdG9wIGFqYXhDb21wbGV0ZSBhamF4RXJyb3IgYWpheFN1Y2Nlc3MgYWpheFNlbmQiLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG8gKXsKCWpRdWVyeS5mblsgbyBdID0gZnVuY3Rpb24oIGYgKXsKCQlyZXR1cm4gdGhpcy5vbiggbywgZiApOwoJfTsKfSk7CgpqUXVlcnkuZWFjaCggWyAiZ2V0IiwgInBvc3QiIF0sIGZ1bmN0aW9uKCBpLCBtZXRob2QgKSB7CglqUXVlcnlbIG1ldGhvZCBdID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgY2FsbGJhY2ssIHR5cGUgKSB7CgkJLy8gc2hpZnQgYXJndW1lbnRzIGlmIGRhdGEgYXJndW1lbnQgd2FzIG9taXR0ZWQKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCXR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwoJCQljYWxsYmFjayA9IGRhdGE7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmFqYXgoewoJCQl0eXBlOiBtZXRob2QsCgkJCXVybDogdXJsLAoJCQlkYXRhOiBkYXRhLAoJCQlzdWNjZXNzOiBjYWxsYmFjaywKCQkJZGF0YVR5cGU6IHR5cGUKCQl9KTsKCX07Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CgoJZ2V0U2NyaXB0OiBmdW5jdGlvbiggdXJsLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCggdXJsLCB1bmRlZmluZWQsIGNhbGxiYWNrLCAic2NyaXB0IiApOwoJfSwKCglnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCggdXJsLCBkYXRhLCBjYWxsYmFjaywgImpzb24iICk7Cgl9LAoKCS8vIENyZWF0ZXMgYSBmdWxsIGZsZWRnZWQgc2V0dGluZ3Mgb2JqZWN0IGludG8gdGFyZ2V0CgkvLyB3aXRoIGJvdGggYWpheFNldHRpbmdzIGFuZCBzZXR0aW5ncyBmaWVsZHMuCgkvLyBJZiB0YXJnZXQgaXMgb21pdHRlZCwgd3JpdGVzIGludG8gYWpheFNldHRpbmdzLgoJYWpheFNldHVwOiBmdW5jdGlvbiggdGFyZ2V0LCBzZXR0aW5ncyApIHsKCQlpZiAoIHNldHRpbmdzICkgewoJCQkvLyBCdWlsZGluZyBhIHNldHRpbmdzIG9iamVjdAoJCQlhamF4RXh0ZW5kKCB0YXJnZXQsIGpRdWVyeS5hamF4U2V0dGluZ3MgKTsKCQl9IGVsc2UgewoJCQkvLyBFeHRlbmRpbmcgYWpheFNldHRpbmdzCgkJCXNldHRpbmdzID0gdGFyZ2V0OwoJCQl0YXJnZXQgPSBqUXVlcnkuYWpheFNldHRpbmdzOwoJCX0KCQlhamF4RXh0ZW5kKCB0YXJnZXQsIHNldHRpbmdzICk7CgkJcmV0dXJuIHRhcmdldDsKCX0sCgoJYWpheFNldHRpbmdzOiB7CgkJdXJsOiBhamF4TG9jYXRpb24sCgkJaXNMb2NhbDogcmxvY2FsUHJvdG9jb2wudGVzdCggYWpheExvY1BhcnRzWyAxIF0gKSwKCQlnbG9iYWw6IHRydWUsCgkJdHlwZTogIkdFVCIsCgkJY29udGVudFR5cGU6ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgiLAoJCXByb2Nlc3NEYXRhOiB0cnVlLAoJCWFzeW5jOiB0cnVlLAoJCS8qCgkJdGltZW91dDogMCwKCQlkYXRhOiBudWxsLAoJCWRhdGFUeXBlOiBudWxsLAoJCXVzZXJuYW1lOiBudWxsLAoJCXBhc3N3b3JkOiBudWxsLAoJCWNhY2hlOiBudWxsLAoJCXRocm93czogZmFsc2UsCgkJdHJhZGl0aW9uYWw6IGZhbHNlLAoJCWhlYWRlcnM6IHt9LAoJCSovCgoJCWFjY2VwdHM6IHsKCQkJeG1sOiAiYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCIsCgkJCWh0bWw6ICJ0ZXh0L2h0bWwiLAoJCQl0ZXh0OiAidGV4dC9wbGFpbiIsCgkJCWpzb246ICJhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L2phdmFzY3JpcHQiLAoJCQkiKiI6IGFsbFR5cGVzCgkJfSwKCgkJY29udGVudHM6IHsKCQkJeG1sOiAveG1sLywKCQkJaHRtbDogL2h0bWwvLAoJCQlqc29uOiAvanNvbi8KCQl9LAoKCQlyZXNwb25zZUZpZWxkczogewoJCQl4bWw6ICJyZXNwb25zZVhNTCIsCgkJCXRleHQ6ICJyZXNwb25zZVRleHQiCgkJfSwKCgkJLy8gTGlzdCBvZiBkYXRhIGNvbnZlcnRlcnMKCQkvLyAxKSBrZXkgZm9ybWF0IGlzICJzb3VyY2VfdHlwZSBkZXN0aW5hdGlvbl90eXBlIiAoYSBzaW5nbGUgc3BhY2UgaW4tYmV0d2VlbikKCQkvLyAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZCBmb3Igc291cmNlX3R5cGUKCQljb252ZXJ0ZXJzOiB7CgoJCQkvLyBDb252ZXJ0IGFueXRoaW5nIHRvIHRleHQKCQkJIiogdGV4dCI6IHdpbmRvdy5TdHJpbmcsCgoJCQkvLyBUZXh0IHRvIGh0bWwgKHRydWUgPSBubyB0cmFuc2Zvcm1hdGlvbikKCQkJInRleHQgaHRtbCI6IHRydWUsCgoJCQkvLyBFdmFsdWF0ZSB0ZXh0IGFzIGEganNvbiBleHByZXNzaW9uCgkJCSJ0ZXh0IGpzb24iOiBqUXVlcnkucGFyc2VKU09OLAoKCQkJLy8gUGFyc2UgdGV4dCBhcyB4bWwKCQkJInRleHQgeG1sIjogalF1ZXJ5LnBhcnNlWE1MCgkJfSwKCgkJLy8gRm9yIG9wdGlvbnMgdGhhdCBzaG91bGRuJ3QgYmUgZGVlcCBleHRlbmRlZDoKCQkvLyB5b3UgY2FuIGFkZCB5b3VyIG93biBjdXN0b20gb3B0aW9ucyBoZXJlIGlmCgkJLy8gYW5kIHdoZW4geW91IGNyZWF0ZSBvbmUgdGhhdCBzaG91bGRuJ3QgYmUKCQkvLyBkZWVwIGV4dGVuZGVkIChzZWUgYWpheEV4dGVuZCkKCQlmbGF0T3B0aW9uczogewoJCQljb250ZXh0OiB0cnVlLAoJCQl1cmw6IHRydWUKCQl9Cgl9LAoKCWFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycyApLAoJYWpheFRyYW5zcG9ydDogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCB0cmFuc3BvcnRzICksCgoJLy8gTWFpbiBtZXRob2QKCWFqYXg6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgoJCS8vIElmIHVybCBpcyBhbiBvYmplY3QsIHNpbXVsYXRlIHByZS0xLjUgc2lnbmF0dXJlCgkJaWYgKCB0eXBlb2YgdXJsID09PSAib2JqZWN0IiApIHsKCQkJb3B0aW9ucyA9IHVybDsKCQkJdXJsID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gRm9yY2Ugb3B0aW9ucyB0byBiZSBhbiBvYmplY3QKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCgkJdmFyIC8vIGlmTW9kaWZpZWQga2V5CgkJCWlmTW9kaWZpZWRLZXksCgkJCS8vIFJlc3BvbnNlIGhlYWRlcnMKCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nLAoJCQlyZXNwb25zZUhlYWRlcnMsCgkJCS8vIHRyYW5zcG9ydAoJCQl0cmFuc3BvcnQsCgkJCS8vIHRpbWVvdXQgaGFuZGxlCgkJCXRpbWVvdXRUaW1lciwKCQkJLy8gQ3Jvc3MtZG9tYWluIGRldGVjdGlvbiB2YXJzCgkJCXBhcnRzLAoJCQkvLyBUbyBrbm93IGlmIGdsb2JhbCBldmVudHMgYXJlIHRvIGJlIGRpc3BhdGNoZWQKCQkJZmlyZUdsb2JhbHMsCgkJCS8vIExvb3AgdmFyaWFibGUKCQkJaSwKCQkJLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdAoJCQlzID0galF1ZXJ5LmFqYXhTZXR1cCgge30sIG9wdGlvbnMgKSwKCQkJLy8gQ2FsbGJhY2tzIGNvbnRleHQKCQkJY2FsbGJhY2tDb250ZXh0ID0gcy5jb250ZXh0IHx8IHMsCgkJCS8vIENvbnRleHQgZm9yIGdsb2JhbCBldmVudHMKCQkJLy8gSXQncyB0aGUgY2FsbGJhY2tDb250ZXh0IGlmIG9uZSB3YXMgcHJvdmlkZWQgaW4gdGhlIG9wdGlvbnMKCQkJLy8gYW5kIGlmIGl0J3MgYSBET00gbm9kZSBvciBhIGpRdWVyeSBjb2xsZWN0aW9uCgkJCWdsb2JhbEV2ZW50Q29udGV4dCA9IGNhbGxiYWNrQ29udGV4dCAhPT0gcyAmJgoJCQkJKCBjYWxsYmFja0NvbnRleHQubm9kZVR5cGUgfHwgY2FsbGJhY2tDb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ICkgPwoJCQkJCQlqUXVlcnkoIGNhbGxiYWNrQ29udGV4dCApIDogalF1ZXJ5LmV2ZW50LAoJCQkvLyBEZWZlcnJlZHMKCQkJZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKSwKCQkJY29tcGxldGVEZWZlcnJlZCA9IGpRdWVyeS5DYWxsYmFja3MoICJvbmNlIG1lbW9yeSIgKSwKCQkJLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKCQkJc3RhdHVzQ29kZSA9IHMuc3RhdHVzQ29kZSB8fCB7fSwKCQkJLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkKCQkJcmVxdWVzdEhlYWRlcnMgPSB7fSwKCQkJcmVxdWVzdEhlYWRlcnNOYW1lcyA9IHt9LAoJCQkvLyBUaGUganFYSFIgc3RhdGUKCQkJc3RhdGUgPSAwLAoJCQkvLyBEZWZhdWx0IGFib3J0IG1lc3NhZ2UKCQkJc3RyQWJvcnQgPSAiY2FuY2VsZWQiLAoJCQkvLyBGYWtlIHhocgoJCQlqcVhIUiA9IHsKCgkJCQlyZWFkeVN0YXRlOiAwLAoKCQkJCS8vIENhY2hlcyB0aGUgaGVhZGVyCgkJCQlzZXRSZXF1ZXN0SGVhZGVyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJCQkJaWYgKCAhc3RhdGUgKSB7CgkJCQkJCXZhciBsbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQkJCQkJbmFtZSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbIGxuYW1lIF0gPSByZXF1ZXN0SGVhZGVyc05hbWVzWyBsbmFtZSBdIHx8IG5hbWU7CgkJCQkJCXJlcXVlc3RIZWFkZXJzWyBuYW1lIF0gPSB2YWx1ZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIFJhdyBzdHJpbmcKCQkJCWdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIHN0YXRlID09PSAyID8gcmVzcG9uc2VIZWFkZXJzU3RyaW5nIDogbnVsbDsKCQkJCX0sCgoJCQkJLy8gQnVpbGRzIGhlYWRlcnMgaGFzaHRhYmxlIGlmIG5lZWRlZAoJCQkJZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uKCBrZXkgKSB7CgkJCQkJdmFyIG1hdGNoOwoJCQkJCWlmICggc3RhdGUgPT09IDIgKSB7CgkJCQkJCWlmICggIXJlc3BvbnNlSGVhZGVycyApIHsKCQkJCQkJCXJlc3BvbnNlSGVhZGVycyA9IHt9OwoJCQkJCQkJd2hpbGUoICggbWF0Y2ggPSByaGVhZGVycy5leGVjKCByZXNwb25zZUhlYWRlcnNTdHJpbmcgKSApICkgewoJCQkJCQkJCXJlc3BvbnNlSGVhZGVyc1sgbWF0Y2hbMV0udG9Mb3dlckNhc2UoKSBdID0gbWF0Y2hbIDIgXTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQltYXRjaCA9IHJlc3BvbnNlSGVhZGVyc1sga2V5LnRvTG93ZXJDYXNlKCkgXTsKCQkJCQl9CgkJCQkJcmV0dXJuIG1hdGNoID09PSB1bmRlZmluZWQgPyBudWxsIDogbWF0Y2g7CgkJCQl9LAoKCQkJCS8vIE92ZXJyaWRlcyByZXNwb25zZSBjb250ZW50LXR5cGUgaGVhZGVyCgkJCQlvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiggdHlwZSApIHsKCQkJCQlpZiAoICFzdGF0ZSApIHsKCQkJCQkJcy5taW1lVHlwZSA9IHR5cGU7CgkJCQkJfQoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCgkJCQkvLyBDYW5jZWwgdGhlIHJlcXVlc3QKCQkJCWFib3J0OiBmdW5jdGlvbiggc3RhdHVzVGV4dCApIHsKCQkJCQlzdGF0dXNUZXh0ID0gc3RhdHVzVGV4dCB8fCBzdHJBYm9ydDsKCQkJCQlpZiAoIHRyYW5zcG9ydCApIHsKCQkJCQkJdHJhbnNwb3J0LmFib3J0KCBzdGF0dXNUZXh0ICk7CgkJCQkJfQoJCQkJCWRvbmUoIDAsIHN0YXR1c1RleHQgKTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCQkJfTsKCgkJLy8gQ2FsbGJhY2sgZm9yIHdoZW4gZXZlcnl0aGluZyBpcyBkb25lCgkJLy8gSXQgaXMgZGVmaW5lZCBoZXJlIGJlY2F1c2UganNsaW50IGNvbXBsYWlucyBpZiBpdCBpcyBkZWNsYXJlZAoJCS8vIGF0IHRoZSBlbmQgb2YgdGhlIGZ1bmN0aW9uICh3aGljaCB3b3VsZCBiZSBtb3JlIGxvZ2ljYWwgYW5kIHJlYWRhYmxlKQoJCWZ1bmN0aW9uIGRvbmUoIHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzICkgewoJCQl2YXIgaXNTdWNjZXNzLCBzdWNjZXNzLCBlcnJvciwgcmVzcG9uc2UsIG1vZGlmaWVkLAoJCQkJc3RhdHVzVGV4dCA9IG5hdGl2ZVN0YXR1c1RleHQ7CgoJCQkvLyBDYWxsZWQgb25jZQoJCQlpZiAoIHN0YXRlID09PSAyICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTdGF0ZSBpcyAiZG9uZSIgbm93CgkJCXN0YXRlID0gMjsKCgkJCS8vIENsZWFyIHRpbWVvdXQgaWYgaXQgZXhpc3RzCgkJCWlmICggdGltZW91dFRpbWVyICkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lb3V0VGltZXIgKTsKCQkJfQoKCQkJLy8gRGVyZWZlcmVuY2UgdHJhbnNwb3J0IGZvciBlYXJseSBnYXJiYWdlIGNvbGxlY3Rpb24KCQkJLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkKCQkJdHJhbnNwb3J0ID0gdW5kZWZpbmVkOwoKCQkJLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycwoJCQlyZXNwb25zZUhlYWRlcnNTdHJpbmcgPSBoZWFkZXJzIHx8ICIiOwoKCQkJLy8gU2V0IHJlYWR5U3RhdGUKCQkJanFYSFIucmVhZHlTdGF0ZSA9IHN0YXR1cyA+IDAgPyA0IDogMDsKCgkJCS8vIEdldCByZXNwb25zZSBkYXRhCgkJCWlmICggcmVzcG9uc2VzICkgewoJCQkJcmVzcG9uc2UgPSBhamF4SGFuZGxlUmVzcG9uc2VzKCBzLCBqcVhIUiwgcmVzcG9uc2VzICk7CgkJCX0KCgkJCS8vIElmIHN1Y2Nlc3NmdWwsIGhhbmRsZSB0eXBlIGNoYWluaW5nCgkJCWlmICggc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDAgfHwgc3RhdHVzID09PSAzMDQgKSB7CgoJCQkJLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KCQkJCWlmICggcy5pZk1vZGlmaWVkICkgewoKCQkJCQltb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIik7CgkJCQkJaWYgKCBtb2RpZmllZCApIHsKCQkJCQkJalF1ZXJ5Lmxhc3RNb2RpZmllZFsgaWZNb2RpZmllZEtleSBdID0gbW9kaWZpZWQ7CgkJCQkJfQoJCQkJCW1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkV0YWciKTsKCQkJCQlpZiAoIG1vZGlmaWVkICkgewoJCQkJCQlqUXVlcnkuZXRhZ1sgaWZNb2RpZmllZEtleSBdID0gbW9kaWZpZWQ7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIElmIG5vdCBtb2RpZmllZAoJCQkJaWYgKCBzdGF0dXMgPT09IDMwNCApIHsKCgkJCQkJc3RhdHVzVGV4dCA9ICJub3Rtb2RpZmllZCI7CgkJCQkJaXNTdWNjZXNzID0gdHJ1ZTsKCgkJCQkvLyBJZiB3ZSBoYXZlIGRhdGEKCQkJCX0gZWxzZSB7CgoJCQkJCWlzU3VjY2VzcyA9IGFqYXhDb252ZXJ0KCBzLCByZXNwb25zZSApOwoJCQkJCXN0YXR1c1RleHQgPSBpc1N1Y2Nlc3Muc3RhdGU7CgkJCQkJc3VjY2VzcyA9IGlzU3VjY2Vzcy5kYXRhOwoJCQkJCWVycm9yID0gaXNTdWNjZXNzLmVycm9yOwoJCQkJCWlzU3VjY2VzcyA9ICFlcnJvcjsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCS8vIFdlIGV4dHJhY3QgZXJyb3IgZnJvbSBzdGF0dXNUZXh0CgkJCQkvLyB0aGVuIG5vcm1hbGl6ZSBzdGF0dXNUZXh0IGFuZCBzdGF0dXMgZm9yIG5vbi1hYm9ydHMKCQkJCWVycm9yID0gc3RhdHVzVGV4dDsKCQkJCWlmICggIXN0YXR1c1RleHQgfHwgc3RhdHVzICkgewoJCQkJCXN0YXR1c1RleHQgPSAiZXJyb3IiOwoJCQkJCWlmICggc3RhdHVzIDwgMCApIHsKCQkJCQkJc3RhdHVzID0gMDsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIFNldCBkYXRhIGZvciB0aGUgZmFrZSB4aHIgb2JqZWN0CgkJCWpxWEhSLnN0YXR1cyA9IHN0YXR1czsKCQkJanFYSFIuc3RhdHVzVGV4dCA9ICIiICsgKCBuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQgKTsKCgkJCS8vIFN1Y2Nlc3MvRXJyb3IKCQkJaWYgKCBpc1N1Y2Nlc3MgKSB7CgkJCQlkZWZlcnJlZC5yZXNvbHZlV2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIHN1Y2Nlc3MsIHN0YXR1c1RleHQsIGpxWEhSIF0gKTsKCQkJfSBlbHNlIHsKCQkJCWRlZmVycmVkLnJlamVjdFdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBqcVhIUiwgc3RhdHVzVGV4dCwgZXJyb3IgXSApOwoJCQl9CgoJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQlqcVhIUi5zdGF0dXNDb2RlKCBzdGF0dXNDb2RlICk7CgkJCXN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CgoJCQlpZiAoIGZpcmVHbG9iYWxzICkgewoJCQkJZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoICJhamF4IiArICggaXNTdWNjZXNzID8gIlN1Y2Nlc3MiIDogIkVycm9yIiApLAoJCQkJCQlbIGpxWEhSLCBzLCBpc1N1Y2Nlc3MgPyBzdWNjZXNzIDogZXJyb3IgXSApOwoJCQl9CgoJCQkvLyBDb21wbGV0ZQoJCQljb21wbGV0ZURlZmVycmVkLmZpcmVXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsganFYSFIsIHN0YXR1c1RleHQgXSApOwoKCQkJaWYgKCBmaXJlR2xvYmFscyApIHsKCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheENvbXBsZXRlIiwgWyBqcVhIUiwgcyBdICk7CgkJCQkvLyBIYW5kbGUgdGhlIGdsb2JhbCBBSkFYIGNvdW50ZXIKCQkJCWlmICggISggLS1qUXVlcnkuYWN0aXZlICkgKSB7CgkJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoICJhamF4U3RvcCIgKTsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gQXR0YWNoIGRlZmVycmVkcwoJCWRlZmVycmVkLnByb21pc2UoIGpxWEhSICk7CgkJanFYSFIuc3VjY2VzcyA9IGpxWEhSLmRvbmU7CgkJanFYSFIuZXJyb3IgPSBqcVhIUi5mYWlsOwoJCWpxWEhSLmNvbXBsZXRlID0gY29tcGxldGVEZWZlcnJlZC5hZGQ7CgoJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCgkJanFYSFIuc3RhdHVzQ29kZSA9IGZ1bmN0aW9uKCBtYXAgKSB7CgkJCWlmICggbWFwICkgewoJCQkJdmFyIHRtcDsKCQkJCWlmICggc3RhdGUgPCAyICkgewoJCQkJCWZvciAoIHRtcCBpbiBtYXAgKSB7CgkJCQkJCXN0YXR1c0NvZGVbIHRtcCBdID0gWyBzdGF0dXNDb2RlW3RtcF0sIG1hcFt0bXBdIF07CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl0bXAgPSBtYXBbIGpxWEhSLnN0YXR1cyBdOwoJCQkJCWpxWEhSLmFsd2F5cyggdG1wICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfTsKCgkJLy8gUmVtb3ZlIGhhc2ggY2hhcmFjdGVyICgjNzUzMTogYW5kIHN0cmluZyBwcm9tb3Rpb24pCgkJLy8gQWRkIHByb3RvY29sIGlmIG5vdCBwcm92aWRlZCAoIzU4NjY6IElFNyBpc3N1ZSB3aXRoIHByb3RvY29sLWxlc3MgdXJscykKCQkvLyBXZSBhbHNvIHVzZSB0aGUgdXJsIHBhcmFtZXRlciBpZiBhdmFpbGFibGUKCQlzLnVybCA9ICggKCB1cmwgfHwgcy51cmwgKSArICIiICkucmVwbGFjZSggcmhhc2gsICIiICkucmVwbGFjZSggcnByb3RvY29sLCBhamF4TG9jUGFydHNbIDEgXSArICIvLyIgKTsKCgkJLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdAoJCXMuZGF0YVR5cGVzID0galF1ZXJ5LnRyaW0oIHMuZGF0YVR5cGUgfHwgIioiICkudG9Mb3dlckNhc2UoKS5zcGxpdCggY29yZV9yc3BhY2UgKTsKCgkJLy8gRGV0ZXJtaW5lIGlmIGEgY3Jvc3MtZG9tYWluIHJlcXVlc3QgaXMgaW4gb3JkZXIKCQlpZiAoIHMuY3Jvc3NEb21haW4gPT0gbnVsbCApIHsKCQkJcGFydHMgPSBydXJsLmV4ZWMoIHMudXJsLnRvTG93ZXJDYXNlKCkgKTsKCQkJcy5jcm9zc0RvbWFpbiA9ICEhKCBwYXJ0cyAmJgoJCQkJKCBwYXJ0c1sgMSBdICE9IGFqYXhMb2NQYXJ0c1sgMSBdIHx8IHBhcnRzWyAyIF0gIT0gYWpheExvY1BhcnRzWyAyIF0gfHwKCQkJCQkoIHBhcnRzWyAzIF0gfHwgKCBwYXJ0c1sgMSBdID09PSAiaHR0cDoiID8gODAgOiA0NDMgKSApICE9CgkJCQkJCSggYWpheExvY1BhcnRzWyAzIF0gfHwgKCBhamF4TG9jUGFydHNbIDEgXSA9PT0gImh0dHA6IiA/IDgwIDogNDQzICkgKSApCgkJCSk7CgkJfQoKCQkvLyBDb252ZXJ0IGRhdGEgaWYgbm90IGFscmVhZHkgYSBzdHJpbmcKCQlpZiAoIHMuZGF0YSAmJiBzLnByb2Nlc3NEYXRhICYmIHR5cGVvZiBzLmRhdGEgIT09ICJzdHJpbmciICkgewoJCQlzLmRhdGEgPSBqUXVlcnkucGFyYW0oIHMuZGF0YSwgcy50cmFkaXRpb25hbCApOwoJCX0KCgkJLy8gQXBwbHkgcHJlZmlsdGVycwoJCWluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBwcmVmaWx0ZXJzLCBzLCBvcHRpb25zLCBqcVhIUiApOwoKCQkvLyBJZiByZXF1ZXN0IHdhcyBhYm9ydGVkIGluc2lkZSBhIHByZWZpbHRlciwgc3RvcCB0aGVyZQoJCWlmICggc3RhdGUgPT09IDIgKSB7CgkJCXJldHVybiBqcVhIUjsKCQl9CgoJCS8vIFdlIGNhbiBmaXJlIGdsb2JhbCBldmVudHMgYXMgb2Ygbm93IGlmIGFza2VkIHRvCgkJZmlyZUdsb2JhbHMgPSBzLmdsb2JhbDsKCgkJLy8gVXBwZXJjYXNlIHRoZSB0eXBlCgkJcy50eXBlID0gcy50eXBlLnRvVXBwZXJDYXNlKCk7CgoJCS8vIERldGVybWluZSBpZiByZXF1ZXN0IGhhcyBjb250ZW50CgkJcy5oYXNDb250ZW50ID0gIXJub0NvbnRlbnQudGVzdCggcy50eXBlICk7CgoJCS8vIFdhdGNoIGZvciBhIG5ldyBzZXQgb2YgcmVxdWVzdHMKCQlpZiAoIGZpcmVHbG9iYWxzICYmIGpRdWVyeS5hY3RpdmUrKyA9PT0gMCApIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoICJhamF4U3RhcnQiICk7CgkJfQoKCQkvLyBNb3JlIG9wdGlvbnMgaGFuZGxpbmcgZm9yIHJlcXVlc3RzIHdpdGggbm8gY29udGVudAoJCWlmICggIXMuaGFzQ29udGVudCApIHsKCgkJCS8vIElmIGRhdGEgaXMgYXZhaWxhYmxlLCBhcHBlbmQgZGF0YSB0byB1cmwKCQkJaWYgKCBzLmRhdGEgKSB7CgkJCQlzLnVybCArPSAoIHJxdWVyeS50ZXN0KCBzLnVybCApID8gIiYiIDogIj8iICkgKyBzLmRhdGE7CgkJCQkvLyAjOTY4MjogcmVtb3ZlIGRhdGEgc28gdGhhdCBpdCdzIG5vdCB1c2VkIGluIGFuIGV2ZW50dWFsIHJldHJ5CgkJCQlkZWxldGUgcy5kYXRhOwoJCQl9CgoJCQkvLyBHZXQgaWZNb2RpZmllZEtleSBiZWZvcmUgYWRkaW5nIHRoZSBhbnRpLWNhY2hlIHBhcmFtZXRlcgoJCQlpZk1vZGlmaWVkS2V5ID0gcy51cmw7CgoJCQkvLyBBZGQgYW50aS1jYWNoZSBpbiB1cmwgaWYgbmVlZGVkCgkJCWlmICggcy5jYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQkJdmFyIHRzID0galF1ZXJ5Lm5vdygpLAoJCQkJCS8vIHRyeSByZXBsYWNpbmcgXz0gaWYgaXQgaXMgdGhlcmUKCQkJCQlyZXQgPSBzLnVybC5yZXBsYWNlKCBydHMsICIkMV89IiArIHRzICk7CgoJCQkJLy8gaWYgbm90aGluZyB3YXMgcmVwbGFjZWQsIGFkZCB0aW1lc3RhbXAgdG8gdGhlIGVuZAoJCQkJcy51cmwgPSByZXQgKyAoICggcmV0ID09PSBzLnVybCApID8gKCBycXVlcnkudGVzdCggcy51cmwgKSA/ICImIiA6ICI/IiApICsgIl89IiArIHRzIDogIiIgKTsKCQkJfQoJCX0KCgkJLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CgkJaWYgKCBzLmRhdGEgJiYgcy5oYXNDb250ZW50ICYmIHMuY29udGVudFR5cGUgIT09IGZhbHNlIHx8IG9wdGlvbnMuY29udGVudFR5cGUgKSB7CgkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoICJDb250ZW50LVR5cGUiLCBzLmNvbnRlbnRUeXBlICk7CgkJfQoKCQkvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgoJCWlmICggcy5pZk1vZGlmaWVkICkgewoJCQlpZk1vZGlmaWVkS2V5ID0gaWZNb2RpZmllZEtleSB8fCBzLnVybDsKCQkJaWYgKCBqUXVlcnkubGFzdE1vZGlmaWVkWyBpZk1vZGlmaWVkS2V5IF0gKSB7CgkJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiSWYtTW9kaWZpZWQtU2luY2UiLCBqUXVlcnkubGFzdE1vZGlmaWVkWyBpZk1vZGlmaWVkS2V5IF0gKTsKCQkJfQoJCQlpZiAoIGpRdWVyeS5ldGFnWyBpZk1vZGlmaWVkS2V5IF0gKSB7CgkJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiSWYtTm9uZS1NYXRjaCIsIGpRdWVyeS5ldGFnWyBpZk1vZGlmaWVkS2V5IF0gKTsKCQkJfQoJCX0KCgkJLy8gU2V0IHRoZSBBY2NlcHRzIGhlYWRlciBmb3IgdGhlIHNlcnZlciwgZGVwZW5kaW5nIG9uIHRoZSBkYXRhVHlwZQoJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoCgkJCSJBY2NlcHQiLAoJCQlzLmRhdGFUeXBlc1sgMCBdICYmIHMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbMF0gXSA/CgkJCQlzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWzBdIF0gKyAoIHMuZGF0YVR5cGVzWyAwIF0gIT09ICIqIiA/ICIsICIgKyBhbGxUeXBlcyArICI7IHE9MC4wMSIgOiAiIiApIDoKCQkJCXMuYWNjZXB0c1sgIioiIF0KCQkpOwoKCQkvLyBDaGVjayBmb3IgaGVhZGVycyBvcHRpb24KCQlmb3IgKCBpIGluIHMuaGVhZGVycyApIHsKCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggaSwgcy5oZWFkZXJzWyBpIF0gKTsKCQl9CgoJCS8vIEFsbG93IGN1c3RvbSBoZWFkZXJzL21pbWV0eXBlcyBhbmQgZWFybHkgYWJvcnQKCQlpZiAoIHMuYmVmb3JlU2VuZCAmJiAoIHMuYmVmb3JlU2VuZC5jYWxsKCBjYWxsYmFja0NvbnRleHQsIGpxWEhSLCBzICkgPT09IGZhbHNlIHx8IHN0YXRlID09PSAyICkgKSB7CgkJCQkvLyBBYm9ydCBpZiBub3QgZG9uZSBhbHJlYWR5IGFuZCByZXR1cm4KCQkJCXJldHVybiBqcVhIUi5hYm9ydCgpOwoKCQl9CgoJCS8vIGFib3J0aW5nIGlzIG5vIGxvbmdlciBhIGNhbmNlbGxhdGlvbgoJCXN0ckFib3J0ID0gImFib3J0IjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFja3Mgb24gZGVmZXJyZWRzCgkJZm9yICggaSBpbiB7IHN1Y2Nlc3M6IDEsIGVycm9yOiAxLCBjb21wbGV0ZTogMSB9ICkgewoJCQlqcVhIUlsgaSBdKCBzWyBpIF0gKTsKCQl9CgoJCS8vIEdldCB0cmFuc3BvcnQKCQl0cmFuc3BvcnQgPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cywgcywgb3B0aW9ucywganFYSFIgKTsKCgkJLy8gSWYgbm8gdHJhbnNwb3J0LCB3ZSBhdXRvLWFib3J0CgkJaWYgKCAhdHJhbnNwb3J0ICkgewoJCQlkb25lKCAtMSwgIk5vIFRyYW5zcG9ydCIgKTsKCQl9IGVsc2UgewoJCQlqcVhIUi5yZWFkeVN0YXRlID0gMTsKCQkJLy8gU2VuZCBnbG9iYWwgZXZlbnQKCQkJaWYgKCBmaXJlR2xvYmFscyApIHsKCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheFNlbmQiLCBbIGpxWEhSLCBzIF0gKTsKCQkJfQoJCQkvLyBUaW1lb3V0CgkJCWlmICggcy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwICkgewoJCQkJdGltZW91dFRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKXsKCQkJCQlqcVhIUi5hYm9ydCggInRpbWVvdXQiICk7CgkJCQl9LCBzLnRpbWVvdXQgKTsKCQkJfQoKCQkJdHJ5IHsKCQkJCXN0YXRlID0gMTsKCQkJCXRyYW5zcG9ydC5zZW5kKCByZXF1ZXN0SGVhZGVycywgZG9uZSApOwoJCQl9IGNhdGNoIChlKSB7CgkJCQkvLyBQcm9wYWdhdGUgZXhjZXB0aW9uIGFzIGVycm9yIGlmIG5vdCBkb25lCgkJCQlpZiAoIHN0YXRlIDwgMiApIHsKCQkJCQlkb25lKCAtMSwgZSApOwoJCQkJLy8gU2ltcGx5IHJldGhyb3cgb3RoZXJ3aXNlCgkJCQl9IGVsc2UgewoJCQkJCXRocm93IGU7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBqcVhIUjsKCX0sCgoJLy8gQ291bnRlciBmb3IgaG9sZGluZyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSBxdWVyaWVzCglhY3RpdmU6IDAsCgoJLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdAoJbGFzdE1vZGlmaWVkOiB7fSwKCWV0YWc6IHt9Cgp9KTsKCi8qIEhhbmRsZXMgcmVzcG9uc2VzIHRvIGFuIGFqYXggcmVxdWVzdDoKICogLSBzZXRzIGFsbCByZXNwb25zZVhYWCBmaWVsZHMgYWNjb3JkaW5nbHkKICogLSBmaW5kcyB0aGUgcmlnaHQgZGF0YVR5cGUgKG1lZGlhdGVzIGJldHdlZW4gY29udGVudC10eXBlIGFuZCBleHBlY3RlZCBkYXRhVHlwZSkKICogLSByZXR1cm5zIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAqLwpmdW5jdGlvbiBhamF4SGFuZGxlUmVzcG9uc2VzKCBzLCBqcVhIUiwgcmVzcG9uc2VzICkgewoKCXZhciBjdCwgdHlwZSwgZmluYWxEYXRhVHlwZSwgZmlyc3REYXRhVHlwZSwKCQljb250ZW50cyA9IHMuY29udGVudHMsCgkJZGF0YVR5cGVzID0gcy5kYXRhVHlwZXMsCgkJcmVzcG9uc2VGaWVsZHMgPSBzLnJlc3BvbnNlRmllbGRzOwoKCS8vIEZpbGwgcmVzcG9uc2VYWFggZmllbGRzCglmb3IgKCB0eXBlIGluIHJlc3BvbnNlRmllbGRzICkgewoJCWlmICggdHlwZSBpbiByZXNwb25zZXMgKSB7CgkJCWpxWEhSWyByZXNwb25zZUZpZWxkc1t0eXBlXSBdID0gcmVzcG9uc2VzWyB0eXBlIF07CgkJfQoJfQoKCS8vIFJlbW92ZSBhdXRvIGRhdGFUeXBlIGFuZCBnZXQgY29udGVudC10eXBlIGluIHRoZSBwcm9jZXNzCgl3aGlsZSggZGF0YVR5cGVzWyAwIF0gPT09ICIqIiApIHsKCQlkYXRhVHlwZXMuc2hpZnQoKTsKCQlpZiAoIGN0ID09PSB1bmRlZmluZWQgKSB7CgkJCWN0ID0gcy5taW1lVHlwZSB8fCBqcVhIUi5nZXRSZXNwb25zZUhlYWRlciggImNvbnRlbnQtdHlwZSIgKTsKCQl9Cgl9CgoJLy8gQ2hlY2sgaWYgd2UncmUgZGVhbGluZyB3aXRoIGEga25vd24gY29udGVudC10eXBlCglpZiAoIGN0ICkgewoJCWZvciAoIHR5cGUgaW4gY29udGVudHMgKSB7CgkJCWlmICggY29udGVudHNbIHR5cGUgXSAmJiBjb250ZW50c1sgdHlwZSBdLnRlc3QoIGN0ICkgKSB7CgkJCQlkYXRhVHlwZXMudW5zaGlmdCggdHlwZSApOwoJCQkJYnJlYWs7CgkJCX0KCQl9Cgl9CgoJLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIGhhdmUgYSByZXNwb25zZSBmb3IgdGhlIGV4cGVjdGVkIGRhdGFUeXBlCglpZiAoIGRhdGFUeXBlc1sgMCBdIGluIHJlc3BvbnNlcyApIHsKCQlmaW5hbERhdGFUeXBlID0gZGF0YVR5cGVzWyAwIF07Cgl9IGVsc2UgewoJCS8vIFRyeSBjb252ZXJ0aWJsZSBkYXRhVHlwZXMKCQlmb3IgKCB0eXBlIGluIHJlc3BvbnNlcyApIHsKCQkJaWYgKCAhZGF0YVR5cGVzWyAwIF0gfHwgcy5jb252ZXJ0ZXJzWyB0eXBlICsgIiAiICsgZGF0YVR5cGVzWzBdIF0gKSB7CgkJCQlmaW5hbERhdGFUeXBlID0gdHlwZTsKCQkJCWJyZWFrOwoJCQl9CgkJCWlmICggIWZpcnN0RGF0YVR5cGUgKSB7CgkJCQlmaXJzdERhdGFUeXBlID0gdHlwZTsKCQkJfQoJCX0KCQkvLyBPciBqdXN0IHVzZSBmaXJzdCBvbmUKCQlmaW5hbERhdGFUeXBlID0gZmluYWxEYXRhVHlwZSB8fCBmaXJzdERhdGFUeXBlOwoJfQoKCS8vIElmIHdlIGZvdW5kIGEgZGF0YVR5cGUKCS8vIFdlIGFkZCB0aGUgZGF0YVR5cGUgdG8gdGhlIGxpc3QgaWYgbmVlZGVkCgkvLyBhbmQgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCglpZiAoIGZpbmFsRGF0YVR5cGUgKSB7CgkJaWYgKCBmaW5hbERhdGFUeXBlICE9PSBkYXRhVHlwZXNbIDAgXSApIHsKCQkJZGF0YVR5cGVzLnVuc2hpZnQoIGZpbmFsRGF0YVR5cGUgKTsKCQl9CgkJcmV0dXJuIHJlc3BvbnNlc1sgZmluYWxEYXRhVHlwZSBdOwoJfQp9CgovLyBDaGFpbiBjb252ZXJzaW9ucyBnaXZlbiB0aGUgcmVxdWVzdCBhbmQgdGhlIG9yaWdpbmFsIHJlc3BvbnNlCmZ1bmN0aW9uIGFqYXhDb252ZXJ0KCBzLCByZXNwb25zZSApIHsKCgl2YXIgY29udiwgY29udjIsIGN1cnJlbnQsIHRtcCwKCQkvLyBXb3JrIHdpdGggYSBjb3B5IG9mIGRhdGFUeXBlcyBpbiBjYXNlIHdlIG5lZWQgdG8gbW9kaWZ5IGl0IGZvciBjb252ZXJzaW9uCgkJZGF0YVR5cGVzID0gcy5kYXRhVHlwZXMuc2xpY2UoKSwKCQlwcmV2ID0gZGF0YVR5cGVzWyAwIF0sCgkJY29udmVydGVycyA9IHt9LAoJCWkgPSAwOwoKCS8vIEFwcGx5IHRoZSBkYXRhRmlsdGVyIGlmIHByb3ZpZGVkCglpZiAoIHMuZGF0YUZpbHRlciApIHsKCQlyZXNwb25zZSA9IHMuZGF0YUZpbHRlciggcmVzcG9uc2UsIHMuZGF0YVR5cGUgKTsKCX0KCgkvLyBDcmVhdGUgY29udmVydGVycyBtYXAgd2l0aCBsb3dlcmNhc2VkIGtleXMKCWlmICggZGF0YVR5cGVzWyAxIF0gKSB7CgkJZm9yICggY29udiBpbiBzLmNvbnZlcnRlcnMgKSB7CgkJCWNvbnZlcnRlcnNbIGNvbnYudG9Mb3dlckNhc2UoKSBdID0gcy5jb252ZXJ0ZXJzWyBjb252IF07CgkJfQoJfQoKCS8vIENvbnZlcnQgdG8gZWFjaCBzZXF1ZW50aWFsIGRhdGFUeXBlLCB0b2xlcmF0aW5nIGxpc3QgbW9kaWZpY2F0aW9uCglmb3IgKCA7IChjdXJyZW50ID0gZGF0YVR5cGVzWysraV0pOyApIHsKCgkJLy8gVGhlcmUncyBvbmx5IHdvcmsgdG8gZG8gaWYgY3VycmVudCBkYXRhVHlwZSBpcyBub24tYXV0bwoJCWlmICggY3VycmVudCAhPT0gIioiICkgewoKCQkJLy8gQ29udmVydCByZXNwb25zZSBpZiBwcmV2IGRhdGFUeXBlIGlzIG5vbi1hdXRvIGFuZCBkaWZmZXJzIGZyb20gY3VycmVudAoJCQlpZiAoIHByZXYgIT09ICIqIiAmJiBwcmV2ICE9PSBjdXJyZW50ICkgewoKCQkJCS8vIFNlZWsgYSBkaXJlY3QgY29udmVydGVyCgkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIGN1cnJlbnQgXSB8fCBjb252ZXJ0ZXJzWyAiKiAiICsgY3VycmVudCBdOwoKCQkJCS8vIElmIG5vbmUgZm91bmQsIHNlZWsgYSBwYWlyCgkJCQlpZiAoICFjb252ICkgewoJCQkJCWZvciAoIGNvbnYyIGluIGNvbnZlcnRlcnMgKSB7CgoJCQkJCQkvLyBJZiBjb252MiBvdXRwdXRzIGN1cnJlbnQKCQkJCQkJdG1wID0gY29udjIuc3BsaXQoIiAiKTsKCQkJCQkJaWYgKCB0bXBbIDEgXSA9PT0gY3VycmVudCApIHsKCgkJCQkJCQkvLyBJZiBwcmV2IGNhbiBiZSBjb252ZXJ0ZWQgdG8gYWNjZXB0ZWQgaW5wdXQKCQkJCQkJCWNvbnYgPSBjb252ZXJ0ZXJzWyBwcmV2ICsgIiAiICsgdG1wWyAwIF0gXSB8fAoJCQkJCQkJCWNvbnZlcnRlcnNbICIqICIgKyB0bXBbIDAgXSBdOwoJCQkJCQkJaWYgKCBjb252ICkgewoJCQkJCQkJCS8vIENvbmRlbnNlIGVxdWl2YWxlbmNlIGNvbnZlcnRlcnMKCQkJCQkJCQlpZiAoIGNvbnYgPT09IHRydWUgKSB7CgkJCQkJCQkJCWNvbnYgPSBjb252ZXJ0ZXJzWyBjb252MiBdOwoKCQkJCQkJCQkvLyBPdGhlcndpc2UsIGluc2VydCB0aGUgaW50ZXJtZWRpYXRlIGRhdGFUeXBlCgkJCQkJCQkJfSBlbHNlIGlmICggY29udmVydGVyc1sgY29udjIgXSAhPT0gdHJ1ZSApIHsKCQkJCQkJCQkJY3VycmVudCA9IHRtcFsgMCBdOwoJCQkJCQkJCQlkYXRhVHlwZXMuc3BsaWNlKCBpLS0sIDAsIGN1cnJlbnQgKTsKCQkJCQkJCQl9CgoJCQkJCQkJCWJyZWFrOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCS8vIEFwcGx5IGNvbnZlcnRlciAoaWYgbm90IGFuIGVxdWl2YWxlbmNlKQoJCQkJaWYgKCBjb252ICE9PSB0cnVlICkgewoKCQkJCQkvLyBVbmxlc3MgZXJyb3JzIGFyZSBhbGxvd2VkIHRvIGJ1YmJsZSwgY2F0Y2ggYW5kIHJldHVybiB0aGVtCgkJCQkJaWYgKCBjb252ICYmIHNbInRocm93cyJdICkgewoJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCXJlc3BvbnNlID0gY29udiggcmVzcG9uc2UgKTsKCQkJCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQkJCQlyZXR1cm4geyBzdGF0ZTogInBhcnNlcmVycm9yIiwgZXJyb3I6IGNvbnYgPyBlIDogIk5vIGNvbnZlcnNpb24gZnJvbSAiICsgcHJldiArICIgdG8gIiArIGN1cnJlbnQgfTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gVXBkYXRlIHByZXYgZm9yIG5leHQgaXRlcmF0aW9uCgkJCXByZXYgPSBjdXJyZW50OwoJCX0KCX0KCglyZXR1cm4geyBzdGF0ZTogInN1Y2Nlc3MiLCBkYXRhOiByZXNwb25zZSB9Owp9CnZhciBvbGRDYWxsYmFja3MgPSBbXSwKCXJxdWVzdGlvbiA9IC9cPy8sCglyanNvbnAgPSAvKD0pXD8oPz0mfCQpfFw/XD8vLAoJbm9uY2UgPSBqUXVlcnkubm93KCk7CgovLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCmpRdWVyeS5hamF4U2V0dXAoewoJanNvbnA6ICJjYWxsYmFjayIsCglqc29ucENhbGxiYWNrOiBmdW5jdGlvbigpIHsKCQl2YXIgY2FsbGJhY2sgPSBvbGRDYWxsYmFja3MucG9wKCkgfHwgKCBqUXVlcnkuZXhwYW5kbyArICJfIiArICggbm9uY2UrKyApICk7CgkJdGhpc1sgY2FsbGJhY2sgXSA9IHRydWU7CgkJcmV0dXJuIGNhbGxiYWNrOwoJfQp9KTsKCi8vIERldGVjdCwgbm9ybWFsaXplIG9wdGlvbnMgYW5kIGluc3RhbGwgY2FsbGJhY2tzIGZvciBqc29ucCByZXF1ZXN0cwpqUXVlcnkuYWpheFByZWZpbHRlciggImpzb24ganNvbnAiLCBmdW5jdGlvbiggcywgb3JpZ2luYWxTZXR0aW5ncywganFYSFIgKSB7CgoJdmFyIGNhbGxiYWNrTmFtZSwgb3ZlcndyaXR0ZW4sIHJlc3BvbnNlQ29udGFpbmVyLAoJCWRhdGEgPSBzLmRhdGEsCgkJdXJsID0gcy51cmwsCgkJaGFzQ2FsbGJhY2sgPSBzLmpzb25wICE9PSBmYWxzZSwKCQlyZXBsYWNlSW5VcmwgPSBoYXNDYWxsYmFjayAmJiByanNvbnAudGVzdCggdXJsICksCgkJcmVwbGFjZUluRGF0YSA9IGhhc0NhbGxiYWNrICYmICFyZXBsYWNlSW5VcmwgJiYgdHlwZW9mIGRhdGEgPT09ICJzdHJpbmciICYmCgkJCSEoIHMuY29udGVudFR5cGUgfHwgIiIgKS5pbmRleE9mKCJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiKSAmJgoJCQlyanNvbnAudGVzdCggZGF0YSApOwoKCS8vIEhhbmRsZSBpZmYgdGhlIGV4cGVjdGVkIGRhdGEgdHlwZSBpcyAianNvbnAiIG9yIHdlIGhhdmUgYSBwYXJhbWV0ZXIgdG8gc2V0CglpZiAoIHMuZGF0YVR5cGVzWyAwIF0gPT09ICJqc29ucCIgfHwgcmVwbGFjZUluVXJsIHx8IHJlcGxhY2VJbkRhdGEgKSB7CgoJCS8vIEdldCBjYWxsYmFjayBuYW1lLCByZW1lbWJlcmluZyBwcmVleGlzdGluZyB2YWx1ZSBhc3NvY2lhdGVkIHdpdGggaXQKCQljYWxsYmFja05hbWUgPSBzLmpzb25wQ2FsbGJhY2sgPSBqUXVlcnkuaXNGdW5jdGlvbiggcy5qc29ucENhbGxiYWNrICkgPwoJCQlzLmpzb25wQ2FsbGJhY2soKSA6CgkJCXMuanNvbnBDYWxsYmFjazsKCQlvdmVyd3JpdHRlbiA9IHdpbmRvd1sgY2FsbGJhY2tOYW1lIF07CgoJCS8vIEluc2VydCBjYWxsYmFjayBpbnRvIHVybCBvciBmb3JtIGRhdGEKCQlpZiAoIHJlcGxhY2VJblVybCApIHsKCQkJcy51cmwgPSB1cmwucmVwbGFjZSggcmpzb25wLCAiJDEiICsgY2FsbGJhY2tOYW1lICk7CgkJfSBlbHNlIGlmICggcmVwbGFjZUluRGF0YSApIHsKCQkJcy5kYXRhID0gZGF0YS5yZXBsYWNlKCByanNvbnAsICIkMSIgKyBjYWxsYmFja05hbWUgKTsKCQl9IGVsc2UgaWYgKCBoYXNDYWxsYmFjayApIHsKCQkJcy51cmwgKz0gKCBycXVlc3Rpb24udGVzdCggdXJsICkgPyAiJiIgOiAiPyIgKSArIHMuanNvbnAgKyAiPSIgKyBjYWxsYmFja05hbWU7CgkJfQoKCQkvLyBVc2UgZGF0YSBjb252ZXJ0ZXIgdG8gcmV0cmlldmUganNvbiBhZnRlciBzY3JpcHQgZXhlY3V0aW9uCgkJcy5jb252ZXJ0ZXJzWyJzY3JpcHQganNvbiJdID0gZnVuY3Rpb24oKSB7CgkJCWlmICggIXJlc3BvbnNlQ29udGFpbmVyICkgewoJCQkJalF1ZXJ5LmVycm9yKCBjYWxsYmFja05hbWUgKyAiIHdhcyBub3QgY2FsbGVkIiApOwoJCQl9CgkJCXJldHVybiByZXNwb25zZUNvbnRhaW5lclsgMCBdOwoJCX07CgoJCS8vIGZvcmNlIGpzb24gZGF0YVR5cGUKCQlzLmRhdGFUeXBlc1sgMCBdID0gImpzb24iOwoKCQkvLyBJbnN0YWxsIGNhbGxiYWNrCgkJd2luZG93WyBjYWxsYmFja05hbWUgXSA9IGZ1bmN0aW9uKCkgewoJCQlyZXNwb25zZUNvbnRhaW5lciA9IGFyZ3VtZW50czsKCQl9OwoKCQkvLyBDbGVhbi11cCBmdW5jdGlvbiAoZmlyZXMgYWZ0ZXIgY29udmVydGVycykKCQlqcVhIUi5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCS8vIFJlc3RvcmUgcHJlZXhpc3RpbmcgdmFsdWUKCQkJd2luZG93WyBjYWxsYmFja05hbWUgXSA9IG92ZXJ3cml0dGVuOwoKCQkJLy8gU2F2ZSBiYWNrIGFzIGZyZWUKCQkJaWYgKCBzWyBjYWxsYmFja05hbWUgXSApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHJlLXVzaW5nIHRoZSBvcHRpb25zIGRvZXNuJ3Qgc2NyZXcgdGhpbmdzIGFyb3VuZAoJCQkJcy5qc29ucENhbGxiYWNrID0gb3JpZ2luYWxTZXR0aW5ncy5qc29ucENhbGxiYWNrOwoKCQkJCS8vIHNhdmUgdGhlIGNhbGxiYWNrIG5hbWUgZm9yIGZ1dHVyZSB1c2UKCQkJCW9sZENhbGxiYWNrcy5wdXNoKCBjYWxsYmFja05hbWUgKTsKCQkJfQoKCQkJLy8gQ2FsbCBpZiBpdCB3YXMgYSBmdW5jdGlvbiBhbmQgd2UgaGF2ZSBhIHJlc3BvbnNlCgkJCWlmICggcmVzcG9uc2VDb250YWluZXIgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIG92ZXJ3cml0dGVuICkgKSB7CgkJCQlvdmVyd3JpdHRlbiggcmVzcG9uc2VDb250YWluZXJbIDAgXSApOwoJCQl9CgoJCQlyZXNwb25zZUNvbnRhaW5lciA9IG92ZXJ3cml0dGVuID0gdW5kZWZpbmVkOwoJCX0pOwoKCQkvLyBEZWxlZ2F0ZSB0byBzY3JpcHQKCQlyZXR1cm4gInNjcmlwdCI7Cgl9Cn0pOwovLyBJbnN0YWxsIHNjcmlwdCBkYXRhVHlwZQpqUXVlcnkuYWpheFNldHVwKHsKCWFjY2VwdHM6IHsKCQlzY3JpcHQ6ICJ0ZXh0L2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2VjbWFzY3JpcHQsIGFwcGxpY2F0aW9uL3gtZWNtYXNjcmlwdCIKCX0sCgljb250ZW50czogewoJCXNjcmlwdDogL2phdmFzY3JpcHR8ZWNtYXNjcmlwdC8KCX0sCgljb252ZXJ0ZXJzOiB7CgkJInRleHQgc2NyaXB0IjogZnVuY3Rpb24oIHRleHQgKSB7CgkJCWpRdWVyeS5nbG9iYWxFdmFsKCB0ZXh0ICk7CgkJCXJldHVybiB0ZXh0OwoJCX0KCX0KfSk7CgovLyBIYW5kbGUgY2FjaGUncyBzcGVjaWFsIGNhc2UgYW5kIGdsb2JhbApqUXVlcnkuYWpheFByZWZpbHRlciggInNjcmlwdCIsIGZ1bmN0aW9uKCBzICkgewoJaWYgKCBzLmNhY2hlID09PSB1bmRlZmluZWQgKSB7CgkJcy5jYWNoZSA9IGZhbHNlOwoJfQoJaWYgKCBzLmNyb3NzRG9tYWluICkgewoJCXMudHlwZSA9ICJHRVQiOwoJCXMuZ2xvYmFsID0gZmFsc2U7Cgl9Cn0pOwoKLy8gQmluZCBzY3JpcHQgdGFnIGhhY2sgdHJhbnNwb3J0CmpRdWVyeS5hamF4VHJhbnNwb3J0KCAic2NyaXB0IiwgZnVuY3Rpb24ocykgewoKCS8vIFRoaXMgdHJhbnNwb3J0IG9ubHkgZGVhbHMgd2l0aCBjcm9zcyBkb21haW4gcmVxdWVzdHMKCWlmICggcy5jcm9zc0RvbWFpbiApIHsKCgkJdmFyIHNjcmlwdCwKCQkJaGVhZCA9IGRvY3VtZW50LmhlYWQgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJoZWFkIiApWzBdIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJcmV0dXJuIHsKCgkJCXNlbmQ6IGZ1bmN0aW9uKCBfLCBjYWxsYmFjayApIHsKCgkJCQlzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic2NyaXB0IiApOwoKCQkJCXNjcmlwdC5hc3luYyA9ICJhc3luYyI7CgoJCQkJaWYgKCBzLnNjcmlwdENoYXJzZXQgKSB7CgkJCQkJc2NyaXB0LmNoYXJzZXQgPSBzLnNjcmlwdENoYXJzZXQ7CgkJCQl9CgoJCQkJc2NyaXB0LnNyYyA9IHMudXJsOwoKCQkJCS8vIEF0dGFjaCBoYW5kbGVycyBmb3IgYWxsIGJyb3dzZXJzCgkJCQlzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCBfLCBpc0Fib3J0ICkgewoKCQkJCQlpZiAoIGlzQWJvcnQgfHwgIXNjcmlwdC5yZWFkeVN0YXRlIHx8IC9sb2FkZWR8Y29tcGxldGUvLnRlc3QoIHNjcmlwdC5yZWFkeVN0YXRlICkgKSB7CgoJCQkJCQkvLyBIYW5kbGUgbWVtb3J5IGxlYWsgaW4gSUUKCQkJCQkJc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoKCQkJCQkJLy8gUmVtb3ZlIHRoZSBzY3JpcHQKCQkJCQkJaWYgKCBoZWFkICYmIHNjcmlwdC5wYXJlbnROb2RlICkgewoJCQkJCQkJaGVhZC5yZW1vdmVDaGlsZCggc2NyaXB0ICk7CgkJCQkJCX0KCgkJCQkJCS8vIERlcmVmZXJlbmNlIHRoZSBzY3JpcHQKCQkJCQkJc2NyaXB0ID0gdW5kZWZpbmVkOwoKCQkJCQkJLy8gQ2FsbGJhY2sgaWYgbm90IGFib3J0CgkJCQkJCWlmICggIWlzQWJvcnQgKSB7CgkJCQkJCQljYWxsYmFjayggMjAwLCAic3VjY2VzcyIgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX07CgkJCQkvLyBVc2UgaW5zZXJ0QmVmb3JlIGluc3RlYWQgb2YgYXBwZW5kQ2hpbGQgIHRvIGNpcmN1bXZlbnQgYW4gSUU2IGJ1Zy4KCQkJCS8vIFRoaXMgYXJpc2VzIHdoZW4gYSBiYXNlIG5vZGUgaXMgdXNlZCAoIzI3MDkgYW5kICM0Mzc4KS4KCQkJCWhlYWQuaW5zZXJ0QmVmb3JlKCBzY3JpcHQsIGhlYWQuZmlyc3RDaGlsZCApOwoJCQl9LAoKCQkJYWJvcnQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBzY3JpcHQgKSB7CgkJCQkJc2NyaXB0Lm9ubG9hZCggMCwgMSApOwoJCQkJfQoJCQl9CgkJfTsKCX0KfSk7CnZhciB4aHJDYWxsYmFja3MsCgkvLyAjNTI4MDogSW50ZXJuZXQgRXhwbG9yZXIgd2lsbCBrZWVwIGNvbm5lY3Rpb25zIGFsaXZlIGlmIHdlIGRvbid0IGFib3J0IG9uIHVubG9hZAoJeGhyT25VbmxvYWRBYm9ydCA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ID8gZnVuY3Rpb24oKSB7CgkJLy8gQWJvcnQgYWxsIHBlbmRpbmcgcmVxdWVzdHMKCQlmb3IgKCB2YXIga2V5IGluIHhockNhbGxiYWNrcyApIHsKCQkJeGhyQ2FsbGJhY2tzWyBrZXkgXSggMCwgMSApOwoJCX0KCX0gOiBmYWxzZSwKCXhocklkID0gMDsKCi8vIEZ1bmN0aW9ucyB0byBjcmVhdGUgeGhycwpmdW5jdGlvbiBjcmVhdGVTdGFuZGFyZFhIUigpIHsKCXRyeSB7CgkJcmV0dXJuIG5ldyB3aW5kb3cuWE1MSHR0cFJlcXVlc3QoKTsKCX0gY2F0Y2goIGUgKSB7fQp9CgpmdW5jdGlvbiBjcmVhdGVBY3RpdmVYSFIoKSB7Cgl0cnkgewoJCXJldHVybiBuZXcgd2luZG93LkFjdGl2ZVhPYmplY3QoICJNaWNyb3NvZnQuWE1MSFRUUCIgKTsKCX0gY2F0Y2goIGUgKSB7fQp9CgovLyBDcmVhdGUgdGhlIHJlcXVlc3Qgb2JqZWN0Ci8vIChUaGlzIGlzIHN0aWxsIGF0dGFjaGVkIHRvIGFqYXhTZXR0aW5ncyBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSkKalF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIgPSB3aW5kb3cuQWN0aXZlWE9iamVjdCA/CgkvKiBNaWNyb3NvZnQgZmFpbGVkIHRvIHByb3Blcmx5CgkgKiBpbXBsZW1lbnQgdGhlIFhNTEh0dHBSZXF1ZXN0IGluIElFNyAoY2FuJ3QgcmVxdWVzdCBsb2NhbCBmaWxlcyksCgkgKiBzbyB3ZSB1c2UgdGhlIEFjdGl2ZVhPYmplY3Qgd2hlbiBpdCBpcyBhdmFpbGFibGUKCSAqIEFkZGl0aW9uYWxseSBYTUxIdHRwUmVxdWVzdCBjYW4gYmUgZGlzYWJsZWQgaW4gSUU3L0lFOCBzbwoJICogd2UgbmVlZCBhIGZhbGxiYWNrLgoJICovCglmdW5jdGlvbigpIHsKCQlyZXR1cm4gIXRoaXMuaXNMb2NhbCAmJiBjcmVhdGVTdGFuZGFyZFhIUigpIHx8IGNyZWF0ZUFjdGl2ZVhIUigpOwoJfSA6CgkvLyBGb3IgYWxsIG90aGVyIGJyb3dzZXJzLCB1c2UgdGhlIHN0YW5kYXJkIFhNTEh0dHBSZXF1ZXN0IG9iamVjdAoJY3JlYXRlU3RhbmRhcmRYSFI7CgovLyBEZXRlcm1pbmUgc3VwcG9ydCBwcm9wZXJ0aWVzCihmdW5jdGlvbiggeGhyICkgewoJalF1ZXJ5LmV4dGVuZCggalF1ZXJ5LnN1cHBvcnQsIHsKCQlhamF4OiAhIXhociwKCQljb3JzOiAhIXhociAmJiAoICJ3aXRoQ3JlZGVudGlhbHMiIGluIHhociApCgl9KTsKfSkoIGpRdWVyeS5hamF4U2V0dGluZ3MueGhyKCkgKTsKCi8vIENyZWF0ZSB0cmFuc3BvcnQgaWYgdGhlIGJyb3dzZXIgY2FuIHByb3ZpZGUgYW4geGhyCmlmICggalF1ZXJ5LnN1cHBvcnQuYWpheCApIHsKCglqUXVlcnkuYWpheFRyYW5zcG9ydChmdW5jdGlvbiggcyApIHsKCQkvLyBDcm9zcyBkb21haW4gb25seSBhbGxvd2VkIGlmIHN1cHBvcnRlZCB0aHJvdWdoIFhNTEh0dHBSZXF1ZXN0CgkJaWYgKCAhcy5jcm9zc0RvbWFpbiB8fCBqUXVlcnkuc3VwcG9ydC5jb3JzICkgewoKCQkJdmFyIGNhbGxiYWNrOwoKCQkJcmV0dXJuIHsKCQkJCXNlbmQ6IGZ1bmN0aW9uKCBoZWFkZXJzLCBjb21wbGV0ZSApIHsKCgkJCQkJLy8gR2V0IGEgbmV3IHhocgoJCQkJCXZhciBoYW5kbGUsIGksCgkJCQkJCXhociA9IHMueGhyKCk7CgoJCQkJCS8vIE9wZW4gdGhlIHNvY2tldAoJCQkJCS8vIFBhc3NpbmcgbnVsbCB1c2VybmFtZSwgZ2VuZXJhdGVzIGEgbG9naW4gcG9wdXAgb24gT3BlcmEgKCMyODY1KQoJCQkJCWlmICggcy51c2VybmFtZSApIHsKCQkJCQkJeGhyLm9wZW4oIHMudHlwZSwgcy51cmwsIHMuYXN5bmMsIHMudXNlcm5hbWUsIHMucGFzc3dvcmQgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl4aHIub3Blbiggcy50eXBlLCBzLnVybCwgcy5hc3luYyApOwoJCQkJCX0KCgkJCQkJLy8gQXBwbHkgY3VzdG9tIGZpZWxkcyBpZiBwcm92aWRlZAoJCQkJCWlmICggcy54aHJGaWVsZHMgKSB7CgkJCQkJCWZvciAoIGkgaW4gcy54aHJGaWVsZHMgKSB7CgkJCQkJCQl4aHJbIGkgXSA9IHMueGhyRmllbGRzWyBpIF07CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIE92ZXJyaWRlIG1pbWUgdHlwZSBpZiBuZWVkZWQKCQkJCQlpZiAoIHMubWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUgKSB7CgkJCQkJCXhoci5vdmVycmlkZU1pbWVUeXBlKCBzLm1pbWVUeXBlICk7CgkJCQkJfQoKCQkJCQkvLyBYLVJlcXVlc3RlZC1XaXRoIGhlYWRlcgoJCQkJCS8vIEZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMsIHNlZWluZyBhcyBjb25kaXRpb25zIGZvciBhIHByZWZsaWdodCBhcmUKCQkJCQkvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgoJCQkJCS8vIChpdCBjYW4gYWx3YXlzIGJlIHNldCBvbiBhIHBlci1yZXF1ZXN0IGJhc2lzIG9yIGV2ZW4gdXNpbmcgYWpheFNldHVwKQoJCQkJCS8vIEZvciBzYW1lLWRvbWFpbiByZXF1ZXN0cywgd29uJ3QgY2hhbmdlIGhlYWRlciBpZiBhbHJlYWR5IHByb3ZpZGVkLgoJCQkJCWlmICggIXMuY3Jvc3NEb21haW4gJiYgIWhlYWRlcnNbIlgtUmVxdWVzdGVkLVdpdGgiXSApIHsKCQkJCQkJaGVhZGVyc1sgIlgtUmVxdWVzdGVkLVdpdGgiIF0gPSAiWE1MSHR0cFJlcXVlc3QiOwoJCQkJCX0KCgkJCQkJLy8gTmVlZCBhbiBleHRyYSB0cnkvY2F0Y2ggZm9yIGNyb3NzIGRvbWFpbiByZXF1ZXN0cyBpbiBGaXJlZm94IDMKCQkJCQl0cnkgewoJCQkJCQlmb3IgKCBpIGluIGhlYWRlcnMgKSB7CgkJCQkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlciggaSwgaGVhZGVyc1sgaSBdICk7CgkJCQkJCX0KCQkJCQl9IGNhdGNoKCBfICkge30KCgkJCQkJLy8gRG8gc2VuZCB0aGUgcmVxdWVzdAoJCQkJCS8vIFRoaXMgbWF5IHJhaXNlIGFuIGV4Y2VwdGlvbiB3aGljaCBpcyBhY3R1YWxseQoJCQkJCS8vIGhhbmRsZWQgaW4galF1ZXJ5LmFqYXggKHNvIG5vIHRyeS9jYXRjaCBoZXJlKQoJCQkJCXhoci5zZW5kKCAoIHMuaGFzQ29udGVudCAmJiBzLmRhdGEgKSB8fCBudWxsICk7CgoJCQkJCS8vIExpc3RlbmVyCgkJCQkJY2FsbGJhY2sgPSBmdW5jdGlvbiggXywgaXNBYm9ydCApIHsKCgkJCQkJCXZhciBzdGF0dXMsCgkJCQkJCQlzdGF0dXNUZXh0LAoJCQkJCQkJcmVzcG9uc2VIZWFkZXJzLAoJCQkJCQkJcmVzcG9uc2VzLAoJCQkJCQkJeG1sOwoKCQkJCQkJLy8gRmlyZWZveCB0aHJvd3MgZXhjZXB0aW9ucyB3aGVuIGFjY2Vzc2luZyBwcm9wZXJ0aWVzCgkJCQkJCS8vIG9mIGFuIHhociB3aGVuIGEgbmV0d29yayBlcnJvciBvY2N1cnJlZAoJCQkJCQkvLyBodHRwOi8vaGVscGZ1bC5rbm9icy1kaWFscy5jb20vaW5kZXgucGhwL0NvbXBvbmVudF9yZXR1cm5lZF9mYWlsdXJlX2NvZGU6XzB4ODAwNDAxMTFfKE5TX0VSUk9SX05PVF9BVkFJTEFCTEUpCgkJCQkJCXRyeSB7CgoJCQkJCQkJLy8gV2FzIG5ldmVyIGNhbGxlZCBhbmQgaXMgYWJvcnRlZCBvciBjb21wbGV0ZQoJCQkJCQkJaWYgKCBjYWxsYmFjayAmJiAoIGlzQWJvcnQgfHwgeGhyLnJlYWR5U3RhdGUgPT09IDQgKSApIHsKCgkJCQkJCQkJLy8gT25seSBjYWxsZWQgb25jZQoJCQkJCQkJCWNhbGxiYWNrID0gdW5kZWZpbmVkOwoKCQkJCQkJCQkvLyBEbyBub3Qga2VlcCBhcyBhY3RpdmUgYW55bW9yZQoJCQkJCQkJCWlmICggaGFuZGxlICkgewoJCQkJCQkJCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0galF1ZXJ5Lm5vb3A7CgkJCQkJCQkJCWlmICggeGhyT25VbmxvYWRBYm9ydCApIHsKCQkJCQkJCQkJCWRlbGV0ZSB4aHJDYWxsYmFja3NbIGhhbmRsZSBdOwoJCQkJCQkJCQl9CgkJCQkJCQkJfQoKCQkJCQkJCQkvLyBJZiBpdCdzIGFuIGFib3J0CgkJCQkJCQkJaWYgKCBpc0Fib3J0ICkgewoJCQkJCQkJCQkvLyBBYm9ydCBpdCBtYW51YWxseSBpZiBuZWVkZWQKCQkJCQkJCQkJaWYgKCB4aHIucmVhZHlTdGF0ZSAhPT0gNCApIHsKCQkJCQkJCQkJCXhoci5hYm9ydCgpOwoJCQkJCQkJCQl9CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJc3RhdHVzID0geGhyLnN0YXR1czsKCQkJCQkJCQkJcmVzcG9uc2VIZWFkZXJzID0geGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpOwoJCQkJCQkJCQlyZXNwb25zZXMgPSB7fTsKCQkJCQkJCQkJeG1sID0geGhyLnJlc3BvbnNlWE1MOwoKCQkJCQkJCQkJLy8gQ29uc3RydWN0IHJlc3BvbnNlIGxpc3QKCQkJCQkJCQkJaWYgKCB4bWwgJiYgeG1sLmRvY3VtZW50RWxlbWVudCAvKiAjNDk1OCAqLyApIHsKCQkJCQkJCQkJCXJlc3BvbnNlcy54bWwgPSB4bWw7CgkJCQkJCQkJCX0KCgkJCQkJCQkJCS8vIFdoZW4gcmVxdWVzdGluZyBiaW5hcnkgZGF0YSwgSUU2LTkgd2lsbCB0aHJvdyBhbiBleGNlcHRpb24KCQkJCQkJCQkJLy8gb24gYW55IGF0dGVtcHQgdG8gYWNjZXNzIHJlc3BvbnNlVGV4dCAoIzExNDI2KQoJCQkJCQkJCQl0cnkgewoJCQkJCQkJCQkJcmVzcG9uc2VzLnRleHQgPSB4aHIucmVzcG9uc2VUZXh0OwoJCQkJCQkJCQl9IGNhdGNoKCBfICkgewoJCQkJCQkJCQl9CgoJCQkJCQkJCQkvLyBGaXJlZm94IHRocm93cyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKCQkJCQkJCQkJLy8gc3RhdHVzVGV4dCBmb3IgZmF1bHR5IGNyb3NzLWRvbWFpbiByZXF1ZXN0cwoJCQkJCQkJCQl0cnkgewoJCQkJCQkJCQkJc3RhdHVzVGV4dCA9IHhoci5zdGF0dXNUZXh0OwoJCQkJCQkJCQl9IGNhdGNoKCBlICkgewoJCQkJCQkJCQkJLy8gV2Ugbm9ybWFsaXplIHdpdGggV2Via2l0IGdpdmluZyBhbiBlbXB0eSBzdGF0dXNUZXh0CgkJCQkJCQkJCQlzdGF0dXNUZXh0ID0gIiI7CgkJCQkJCQkJCX0KCgkJCQkJCQkJCS8vIEZpbHRlciBzdGF0dXMgZm9yIG5vbiBzdGFuZGFyZCBiZWhhdmlvcnMKCgkJCQkJCQkJCS8vIElmIHRoZSByZXF1ZXN0IGlzIGxvY2FsIGFuZCB3ZSBoYXZlIGRhdGE6IGFzc3VtZSBhIHN1Y2Nlc3MKCQkJCQkJCQkJLy8gKHN1Y2Nlc3Mgd2l0aCBubyBkYXRhIHdvbid0IGdldCBub3RpZmllZCwgdGhhdCdzIHRoZSBiZXN0IHdlCgkJCQkJCQkJCS8vIGNhbiBkbyBnaXZlbiBjdXJyZW50IGltcGxlbWVudGF0aW9ucykKCQkJCQkJCQkJaWYgKCAhc3RhdHVzICYmIHMuaXNMb2NhbCAmJiAhcy5jcm9zc0RvbWFpbiApIHsKCQkJCQkJCQkJCXN0YXR1cyA9IHJlc3BvbnNlcy50ZXh0ID8gMjAwIDogNDA0OwoJCQkJCQkJCQkvLyBJRSAtICMxNDUwOiBzb21ldGltZXMgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAoJCQkJCQkJCQl9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDEyMjMgKSB7CgkJCQkJCQkJCQlzdGF0dXMgPSAyMDQ7CgkJCQkJCQkJCX0KCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0gY2F0Y2goIGZpcmVmb3hBY2Nlc3NFeGNlcHRpb24gKSB7CgkJCQkJCQlpZiAoICFpc0Fib3J0ICkgewoJCQkJCQkJCWNvbXBsZXRlKCAtMSwgZmlyZWZveEFjY2Vzc0V4Y2VwdGlvbiApOwoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQkvLyBDYWxsIGNvbXBsZXRlIGlmIG5lZWRlZAoJCQkJCQlpZiAoIHJlc3BvbnNlcyApIHsKCQkJCQkJCWNvbXBsZXRlKCBzdGF0dXMsIHN0YXR1c1RleHQsIHJlc3BvbnNlcywgcmVzcG9uc2VIZWFkZXJzICk7CgkJCQkJCX0KCQkJCQl9OwoKCQkJCQlpZiAoICFzLmFzeW5jICkgewoJCQkJCQkvLyBpZiB3ZSdyZSBpbiBzeW5jIG1vZGUgd2UgZmlyZSB0aGUgY2FsbGJhY2sKCQkJCQkJY2FsbGJhY2soKTsKCQkJCQl9IGVsc2UgaWYgKCB4aHIucmVhZHlTdGF0ZSA9PT0gNCApIHsKCQkJCQkJLy8gKElFNiAmIElFNykgaWYgaXQncyBpbiBjYWNoZSBhbmQgaGFzIGJlZW4KCQkJCQkJLy8gcmV0cmlldmVkIGRpcmVjdGx5IHdlIG5lZWQgdG8gZmlyZSB0aGUgY2FsbGJhY2sKCQkJCQkJc2V0VGltZW91dCggY2FsbGJhY2ssIDAgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQloYW5kbGUgPSArK3hocklkOwoJCQkJCQlpZiAoIHhock9uVW5sb2FkQWJvcnQgKSB7CgkJCQkJCQkvLyBDcmVhdGUgdGhlIGFjdGl2ZSB4aHJzIGNhbGxiYWNrcyBsaXN0IGlmIG5lZWRlZAoJCQkJCQkJLy8gYW5kIGF0dGFjaCB0aGUgdW5sb2FkIGhhbmRsZXIKCQkJCQkJCWlmICggIXhockNhbGxiYWNrcyApIHsKCQkJCQkJCQl4aHJDYWxsYmFja3MgPSB7fTsKCQkJCQkJCQlqUXVlcnkoIHdpbmRvdyApLnVubG9hZCggeGhyT25VbmxvYWRBYm9ydCApOwoJCQkJCQkJfQoJCQkJCQkJLy8gQWRkIHRvIGxpc3Qgb2YgYWN0aXZlIHhocnMgY2FsbGJhY2tzCgkJCQkJCQl4aHJDYWxsYmFja3NbIGhhbmRsZSBdID0gY2FsbGJhY2s7CgkJCQkJCX0KCQkJCQkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGNhbGxiYWNrOwoJCQkJCX0KCQkJCX0sCgoJCQkJYWJvcnQ6IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCWNhbGxiYWNrKDAsMSk7CgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0KCX0pOwp9CnZhciBmeE5vdywgdGltZXJJZCwKCXJmeHR5cGVzID0gL14oPzp0b2dnbGV8c2hvd3xoaWRlKSQvLAoJcmZ4bnVtID0gbmV3IFJlZ0V4cCggIl4oPzooWy0rXSk9fCkoIiArIGNvcmVfcG51bSArICIpKFthLXolXSopJCIsICJpIiApLAoJcnJ1biA9IC9xdWV1ZUhvb2tzJC8sCglhbmltYXRpb25QcmVmaWx0ZXJzID0gWyBkZWZhdWx0UHJlZmlsdGVyIF0sCgl0d2VlbmVycyA9IHsKCQkiKiI6IFtmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJCXZhciBlbmQsIHVuaXQsIHByZXZTY2FsZSwKCQkJCXR3ZWVuID0gdGhpcy5jcmVhdGVUd2VlbiggcHJvcCwgdmFsdWUgKSwKCQkJCXBhcnRzID0gcmZ4bnVtLmV4ZWMoIHZhbHVlICksCgkJCQl0YXJnZXQgPSB0d2Vlbi5jdXIoKSwKCQkJCXN0YXJ0ID0gK3RhcmdldCB8fCAwLAoJCQkJc2NhbGUgPSAxOwoKCQkJaWYgKCBwYXJ0cyApIHsKCQkJCWVuZCA9ICtwYXJ0c1syXTsKCQkJCXVuaXQgPSBwYXJ0c1szXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApOwoKCQkJCS8vIFdlIG5lZWQgdG8gY29tcHV0ZSBzdGFydGluZyB2YWx1ZQoJCQkJaWYgKCB1bml0ICE9PSAicHgiICYmIHN0YXJ0ICkgewoJCQkJCS8vIEl0ZXJhdGl2ZWx5IGFwcHJveGltYXRlIGZyb20gYSBub256ZXJvIHN0YXJ0aW5nIHBvaW50CgkJCQkJLy8gUHJlZmVyIHRoZSBjdXJyZW50IHByb3BlcnR5LCBiZWNhdXNlIHRoaXMgcHJvY2VzcyB3aWxsIGJlIHRyaXZpYWwgaWYgaXQgdXNlcyB0aGUgc2FtZSB1bml0cwoJCQkJCS8vIEZhbGxiYWNrIHRvIGVuZCBvciBhIHNpbXBsZSBjb25zdGFudAoJCQkJCXN0YXJ0ID0galF1ZXJ5LmNzcyggdHdlZW4uZWxlbSwgcHJvcCwgdHJ1ZSApIHx8IGVuZCB8fCAxOwoKCQkJCQlkbyB7CgkJCQkJCS8vIElmIHByZXZpb3VzIGl0ZXJhdGlvbiB6ZXJvZWQgb3V0LCBkb3VibGUgdW50aWwgd2UgZ2V0ICpzb21ldGhpbmcqCgkJCQkJCS8vIFVzZSBhIHN0cmluZyBmb3IgZG91YmxpbmcgZmFjdG9yIHNvIHdlIGRvbid0IGFjY2lkZW50YWxseSBzZWUgc2NhbGUgYXMgdW5jaGFuZ2VkIGJlbG93CgkJCQkJCXByZXZTY2FsZSA9IHNjYWxlID0gc2NhbGUgfHwgIi41IjsKCgkJCQkJCS8vIEFkanVzdCBhbmQgYXBwbHkKCQkJCQkJc3RhcnQgPSBzdGFydCAvIHNjYWxlOwoJCQkJCQlqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHByb3AsIHN0YXJ0ICsgdW5pdCApOwoKCQkJCQkJLy8gVXBkYXRlIHNjYWxlLCB0b2xlcmF0aW5nIHplcm9lcyBmcm9tIHR3ZWVuLmN1cigpCgkJCQkJCXNjYWxlID0gdHdlZW4uY3VyKCkgLyB0YXJnZXQ7CgoJCQkJCS8vIFN0b3AgbG9vcGluZyBpZiB3ZSd2ZSBoaXQgdGhlIG1hcmsgb3Igc2NhbGUgaXMgdW5jaGFuZ2VkCgkJCQkJfSB3aGlsZSAoIHNjYWxlICE9PSAxICYmIHNjYWxlICE9PSBwcmV2U2NhbGUgKTsKCQkJCX0KCgkJCQl0d2Vlbi51bml0ID0gdW5pdDsKCQkJCXR3ZWVuLnN0YXJ0ID0gc3RhcnQ7CgkJCQkvLyBJZiBhICs9Ly09IHRva2VuIHdhcyBwcm92aWRlZCwgd2UncmUgZG9pbmcgYSByZWxhdGl2ZSBhbmltYXRpb24KCQkJCXR3ZWVuLmVuZCA9IHBhcnRzWzFdID8gc3RhcnQgKyAoIHBhcnRzWzFdICsgMSApICogZW5kIDogZW5kOwoJCQl9CgkJCXJldHVybiB0d2VlbjsKCQl9XQoJfTsKCi8vIEFuaW1hdGlvbnMgY3JlYXRlZCBzeW5jaHJvbm91c2x5IHdpbGwgcnVuIHN5bmNocm9ub3VzbHkKZnVuY3Rpb24gY3JlYXRlRnhOb3coKSB7CglzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCWZ4Tm93ID0gdW5kZWZpbmVkOwoJfSwgMCApOwoJcmV0dXJuICggZnhOb3cgPSBqUXVlcnkubm93KCkgKTsKfQoKZnVuY3Rpb24gY3JlYXRlVHdlZW5zKCBhbmltYXRpb24sIHByb3BzICkgewoJalF1ZXJ5LmVhY2goIHByb3BzLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJdmFyIGNvbGxlY3Rpb24gPSAoIHR3ZWVuZXJzWyBwcm9wIF0gfHwgW10gKS5jb25jYXQoIHR3ZWVuZXJzWyAiKiIgXSApLAoJCQlpbmRleCA9IDAsCgkJCWxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoJCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJCWlmICggY29sbGVjdGlvblsgaW5kZXggXS5jYWxsKCBhbmltYXRpb24sIHByb3AsIHZhbHVlICkgKSB7CgoJCQkJLy8gd2UncmUgZG9uZSB3aXRoIHRoaXMgcHJvcGVydHkKCQkJCXJldHVybjsKCQkJfQoJCX0KCX0pOwp9CgpmdW5jdGlvbiBBbmltYXRpb24oIGVsZW0sIHByb3BlcnRpZXMsIG9wdGlvbnMgKSB7Cgl2YXIgcmVzdWx0LAoJCWluZGV4ID0gMCwKCQl0d2VlbmVySW5kZXggPSAwLAoJCWxlbmd0aCA9IGFuaW1hdGlvblByZWZpbHRlcnMubGVuZ3RoLAoJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCkuYWx3YXlzKCBmdW5jdGlvbigpIHsKCQkJLy8gZG9uJ3QgbWF0Y2ggZWxlbSBpbiB0aGUgOmFuaW1hdGVkIHNlbGVjdG9yCgkJCWRlbGV0ZSB0aWNrLmVsZW07CgkJfSksCgkJdGljayA9IGZ1bmN0aW9uKCkgewoJCQl2YXIgY3VycmVudFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAoJCQkJcmVtYWluaW5nID0gTWF0aC5tYXgoIDAsIGFuaW1hdGlvbi5zdGFydFRpbWUgKyBhbmltYXRpb24uZHVyYXRpb24gLSBjdXJyZW50VGltZSApLAoJCQkJcGVyY2VudCA9IDEgLSAoIHJlbWFpbmluZyAvIGFuaW1hdGlvbi5kdXJhdGlvbiB8fCAwICksCgkJCQlpbmRleCA9IDAsCgkJCQlsZW5ndGggPSBhbmltYXRpb24udHdlZW5zLmxlbmd0aDsKCgkJCWZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCQkJYW5pbWF0aW9uLnR3ZWVuc1sgaW5kZXggXS5ydW4oIHBlcmNlbnQgKTsKCQkJfQoKCQkJZGVmZXJyZWQubm90aWZ5V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIHBlcmNlbnQsIHJlbWFpbmluZyBdKTsKCgkJCWlmICggcGVyY2VudCA8IDEgJiYgbGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbWFpbmluZzsKCQkJfSBlbHNlIHsKCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiBdICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoJCWFuaW1hdGlvbiA9IGRlZmVycmVkLnByb21pc2UoewoJCQllbGVtOiBlbGVtLAoJCQlwcm9wczogalF1ZXJ5LmV4dGVuZCgge30sIHByb3BlcnRpZXMgKSwKCQkJb3B0czogalF1ZXJ5LmV4dGVuZCggdHJ1ZSwgeyBzcGVjaWFsRWFzaW5nOiB7fSB9LCBvcHRpb25zICksCgkJCW9yaWdpbmFsUHJvcGVydGllczogcHJvcGVydGllcywKCQkJb3JpZ2luYWxPcHRpb25zOiBvcHRpb25zLAoJCQlzdGFydFRpbWU6IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCgkJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAoJCQl0d2VlbnM6IFtdLAoJCQljcmVhdGVUd2VlbjogZnVuY3Rpb24oIHByb3AsIGVuZCwgZWFzaW5nICkgewoJCQkJdmFyIHR3ZWVuID0galF1ZXJ5LlR3ZWVuKCBlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLAoJCQkJCQlhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nWyBwcm9wIF0gfHwgYW5pbWF0aW9uLm9wdHMuZWFzaW5nICk7CgkJCQlhbmltYXRpb24udHdlZW5zLnB1c2goIHR3ZWVuICk7CgkJCQlyZXR1cm4gdHdlZW47CgkJCX0sCgkJCXN0b3A6IGZ1bmN0aW9uKCBnb3RvRW5kICkgewoJCQkJdmFyIGluZGV4ID0gMCwKCQkJCQkvLyBpZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGVuZCwgd2Ugd2FudCB0byBydW4gYWxsIHRoZSB0d2VlbnMKCQkJCQkvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKCQkJCQlsZW5ndGggPSBnb3RvRW5kID8gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGggOiAwOwoKCQkJCWZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCQkJCWFuaW1hdGlvbi50d2VlbnNbIGluZGV4IF0ucnVuKCAxICk7CgkJCQl9CgoJCQkJLy8gcmVzb2x2ZSB3aGVuIHdlIHBsYXllZCB0aGUgbGFzdCBmcmFtZQoJCQkJLy8gb3RoZXJ3aXNlLCByZWplY3QKCQkJCWlmICggZ290b0VuZCApIHsKCQkJCQlkZWZlcnJlZC5yZXNvbHZlV2l0aCggZWxlbSwgWyBhbmltYXRpb24sIGdvdG9FbmQgXSApOwoJCQkJfSBlbHNlIHsKCQkJCQlkZWZlcnJlZC5yZWplY3RXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgZ290b0VuZCBdICk7CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfQoJCX0pLAoJCXByb3BzID0gYW5pbWF0aW9uLnByb3BzOwoKCXByb3BGaWx0ZXIoIHByb3BzLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nICk7CgoJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJcmVzdWx0ID0gYW5pbWF0aW9uUHJlZmlsdGVyc1sgaW5kZXggXS5jYWxsKCBhbmltYXRpb24sIGVsZW0sIHByb3BzLCBhbmltYXRpb24ub3B0cyApOwoJCWlmICggcmVzdWx0ICkgewoJCQlyZXR1cm4gcmVzdWx0OwoJCX0KCX0KCgljcmVhdGVUd2VlbnMoIGFuaW1hdGlvbiwgcHJvcHMgKTsKCglpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBhbmltYXRpb24ub3B0cy5zdGFydCApICkgewoJCWFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoIGVsZW0sIGFuaW1hdGlvbiApOwoJfQoKCWpRdWVyeS5meC50aW1lcigKCQlqUXVlcnkuZXh0ZW5kKCB0aWNrLCB7CgkJCWFuaW06IGFuaW1hdGlvbiwKCQkJcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlLAoJCQllbGVtOiBlbGVtCgkJfSkKCSk7CgoJLy8gYXR0YWNoIGNhbGxiYWNrcyBmcm9tIG9wdGlvbnMKCXJldHVybiBhbmltYXRpb24ucHJvZ3Jlc3MoIGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzICkKCQkuZG9uZSggYW5pbWF0aW9uLm9wdHMuZG9uZSwgYW5pbWF0aW9uLm9wdHMuY29tcGxldGUgKQoJCS5mYWlsKCBhbmltYXRpb24ub3B0cy5mYWlsICkKCQkuYWx3YXlzKCBhbmltYXRpb24ub3B0cy5hbHdheXMgKTsKfQoKZnVuY3Rpb24gcHJvcEZpbHRlciggcHJvcHMsIHNwZWNpYWxFYXNpbmcgKSB7Cgl2YXIgaW5kZXgsIG5hbWUsIGVhc2luZywgdmFsdWUsIGhvb2tzOwoKCS8vIGNhbWVsQ2FzZSwgc3BlY2lhbEVhc2luZyBhbmQgZXhwYW5kIGNzc0hvb2sgcGFzcwoJZm9yICggaW5kZXggaW4gcHJvcHMgKSB7CgkJbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIGluZGV4ICk7CgkJZWFzaW5nID0gc3BlY2lhbEVhc2luZ1sgbmFtZSBdOwoJCXZhbHVlID0gcHJvcHNbIGluZGV4IF07CgkJaWYgKCBqUXVlcnkuaXNBcnJheSggdmFsdWUgKSApIHsKCQkJZWFzaW5nID0gdmFsdWVbIDEgXTsKCQkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyAwIF07CgkJfQoKCQlpZiAoIGluZGV4ICE9PSBuYW1lICkgewoJCQlwcm9wc1sgbmFtZSBdID0gdmFsdWU7CgkJCWRlbGV0ZSBwcm9wc1sgaW5kZXggXTsKCQl9CgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF07CgkJaWYgKCBob29rcyAmJiAiZXhwYW5kIiBpbiBob29rcyApIHsKCQkJdmFsdWUgPSBob29rcy5leHBhbmQoIHZhbHVlICk7CgkJCWRlbGV0ZSBwcm9wc1sgbmFtZSBdOwoKCQkJLy8gbm90IHF1aXRlICQuZXh0ZW5kLCB0aGlzIHdvbnQgb3ZlcndyaXRlIGtleXMgYWxyZWFkeSBwcmVzZW50LgoJCQkvLyBhbHNvIC0gcmV1c2luZyAnaW5kZXgnIGZyb20gYWJvdmUgYmVjYXVzZSB3ZSBoYXZlIHRoZSBjb3JyZWN0ICJuYW1lIgoJCQlmb3IgKCBpbmRleCBpbiB2YWx1ZSApIHsKCQkJCWlmICggISggaW5kZXggaW4gcHJvcHMgKSApIHsKCQkJCQlwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyBpbmRleCBdOwoJCQkJCXNwZWNpYWxFYXNpbmdbIGluZGV4IF0gPSBlYXNpbmc7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlzcGVjaWFsRWFzaW5nWyBuYW1lIF0gPSBlYXNpbmc7CgkJfQoJfQp9CgpqUXVlcnkuQW5pbWF0aW9uID0galF1ZXJ5LmV4dGVuZCggQW5pbWF0aW9uLCB7CgoJdHdlZW5lcjogZnVuY3Rpb24oIHByb3BzLCBjYWxsYmFjayApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwcm9wcyApICkgewoJCQljYWxsYmFjayA9IHByb3BzOwoJCQlwcm9wcyA9IFsgIioiIF07CgkJfSBlbHNlIHsKCQkJcHJvcHMgPSBwcm9wcy5zcGxpdCgiICIpOwoJCX0KCgkJdmFyIHByb3AsCgkJCWluZGV4ID0gMCwKCQkJbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwoKCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQkJcHJvcCA9IHByb3BzWyBpbmRleCBdOwoJCQl0d2VlbmVyc1sgcHJvcCBdID0gdHdlZW5lcnNbIHByb3AgXSB8fCBbXTsKCQkJdHdlZW5lcnNbIHByb3AgXS51bnNoaWZ0KCBjYWxsYmFjayApOwoJCX0KCX0sCgoJcHJlZmlsdGVyOiBmdW5jdGlvbiggY2FsbGJhY2ssIHByZXBlbmQgKSB7CgkJaWYgKCBwcmVwZW5kICkgewoJCQlhbmltYXRpb25QcmVmaWx0ZXJzLnVuc2hpZnQoIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJYW5pbWF0aW9uUHJlZmlsdGVycy5wdXNoKCBjYWxsYmFjayApOwoJCX0KCX0KfSk7CgpmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKCBlbGVtLCBwcm9wcywgb3B0cyApIHsKCXZhciBpbmRleCwgcHJvcCwgdmFsdWUsIGxlbmd0aCwgZGF0YVNob3csIHR3ZWVuLCBob29rcywgb2xkZmlyZSwKCQlhbmltID0gdGhpcywKCQlzdHlsZSA9IGVsZW0uc3R5bGUsCgkJb3JpZyA9IHt9LAoJCWhhbmRsZWQgPSBbXSwKCQloaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuKCBlbGVtICk7CgoJLy8gaGFuZGxlIHF1ZXVlOiBmYWxzZSBwcm9taXNlcwoJaWYgKCAhb3B0cy5xdWV1ZSApIHsKCQlob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyggZWxlbSwgImZ4IiApOwoJCWlmICggaG9va3MudW5xdWV1ZWQgPT0gbnVsbCApIHsKCQkJaG9va3MudW5xdWV1ZWQgPSAwOwoJCQlvbGRmaXJlID0gaG9va3MuZW1wdHkuZmlyZTsKCQkJaG9va3MuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAhaG9va3MudW5xdWV1ZWQgKSB7CgkJCQkJb2xkZmlyZSgpOwoJCQkJfQoJCQl9OwoJCX0KCQlob29rcy51bnF1ZXVlZCsrOwoKCQlhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJLy8gZG9pbmcgdGhpcyBtYWtlcyBzdXJlIHRoYXQgdGhlIGNvbXBsZXRlIGhhbmRsZXIgd2lsbCBiZSBjYWxsZWQKCQkJLy8gYmVmb3JlIHRoaXMgY29tcGxldGVzCgkJCWFuaW0uYWx3YXlzKGZ1bmN0aW9uKCkgewoJCQkJaG9va3MudW5xdWV1ZWQtLTsKCQkJCWlmICggIWpRdWVyeS5xdWV1ZSggZWxlbSwgImZ4IiApLmxlbmd0aCApIHsKCQkJCQlob29rcy5lbXB0eS5maXJlKCk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJfQoKCS8vIGhlaWdodC93aWR0aCBvdmVyZmxvdyBwYXNzCglpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCAiaGVpZ2h0IiBpbiBwcm9wcyB8fCAid2lkdGgiIGluIHByb3BzICkgKSB7CgkJLy8gTWFrZSBzdXJlIHRoYXQgbm90aGluZyBzbmVha3Mgb3V0CgkJLy8gUmVjb3JkIGFsbCAzIG92ZXJmbG93IGF0dHJpYnV0ZXMgYmVjYXVzZSBJRSBkb2VzIG5vdAoJCS8vIGNoYW5nZSB0aGUgb3ZlcmZsb3cgYXR0cmlidXRlIHdoZW4gb3ZlcmZsb3dYIGFuZAoJCS8vIG92ZXJmbG93WSBhcmUgc2V0IHRvIHRoZSBzYW1lIHZhbHVlCgkJb3B0cy5vdmVyZmxvdyA9IFsgc3R5bGUub3ZlcmZsb3csIHN0eWxlLm92ZXJmbG93WCwgc3R5bGUub3ZlcmZsb3dZIF07CgoJCS8vIFNldCBkaXNwbGF5IHByb3BlcnR5IHRvIGlubGluZS1ibG9jayBmb3IgaGVpZ2h0L3dpZHRoCgkJLy8gYW5pbWF0aW9ucyBvbiBpbmxpbmUgZWxlbWVudHMgdGhhdCBhcmUgaGF2aW5nIHdpZHRoL2hlaWdodCBhbmltYXRlZAoJCWlmICggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgPT09ICJpbmxpbmUiICYmCgkJCQlqUXVlcnkuY3NzKCBlbGVtLCAiZmxvYXQiICkgPT09ICJub25lIiApIHsKCgkJCS8vIGlubGluZS1sZXZlbCBlbGVtZW50cyBhY2NlcHQgaW5saW5lLWJsb2NrOwoJCQkvLyBibG9jay1sZXZlbCBlbGVtZW50cyBuZWVkIHRvIGJlIGlubGluZSB3aXRoIGxheW91dAoJCQlpZiAoICFqUXVlcnkuc3VwcG9ydC5pbmxpbmVCbG9ja05lZWRzTGF5b3V0IHx8IGNzc19kZWZhdWx0RGlzcGxheSggZWxlbS5ub2RlTmFtZSApID09PSAiaW5saW5lIiApIHsKCQkJCXN0eWxlLmRpc3BsYXkgPSAiaW5saW5lLWJsb2NrIjsKCgkJCX0gZWxzZSB7CgkJCQlzdHlsZS56b29tID0gMTsKCQkJfQoJCX0KCX0KCglpZiAoIG9wdHMub3ZlcmZsb3cgKSB7CgkJc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsKCQlpZiAoICFqUXVlcnkuc3VwcG9ydC5zaHJpbmtXcmFwQmxvY2tzICkgewoJCQlhbmltLmRvbmUoZnVuY3Rpb24oKSB7CgkJCQlzdHlsZS5vdmVyZmxvdyA9IG9wdHMub3ZlcmZsb3dbIDAgXTsKCQkJCXN0eWxlLm92ZXJmbG93WCA9IG9wdHMub3ZlcmZsb3dbIDEgXTsKCQkJCXN0eWxlLm92ZXJmbG93WSA9IG9wdHMub3ZlcmZsb3dbIDIgXTsKCQkJfSk7CgkJfQoJfQoKCgkvLyBzaG93L2hpZGUgcGFzcwoJZm9yICggaW5kZXggaW4gcHJvcHMgKSB7CgkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXTsKCQlpZiAoIHJmeHR5cGVzLmV4ZWMoIHZhbHVlICkgKSB7CgkJCWRlbGV0ZSBwcm9wc1sgaW5kZXggXTsKCQkJaWYgKCB2YWx1ZSA9PT0gKCBoaWRkZW4gPyAiaGlkZSIgOiAic2hvdyIgKSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgkJCWhhbmRsZWQucHVzaCggaW5kZXggKTsKCQl9Cgl9CgoJbGVuZ3RoID0gaGFuZGxlZC5sZW5ndGg7CglpZiAoIGxlbmd0aCApIHsKCQlkYXRhU2hvdyA9IGpRdWVyeS5fZGF0YSggZWxlbSwgImZ4c2hvdyIgKSB8fCBqUXVlcnkuX2RhdGEoIGVsZW0sICJmeHNob3ciLCB7fSApOwoJCWlmICggaGlkZGVuICkgewoJCQlqUXVlcnkoIGVsZW0gKS5zaG93KCk7CgkJfSBlbHNlIHsKCQkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5KCBlbGVtICkuaGlkZSgpOwoJCQl9KTsKCQl9CgkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgewoJCQl2YXIgcHJvcDsKCQkJalF1ZXJ5LnJlbW92ZURhdGEoIGVsZW0sICJmeHNob3ciLCB0cnVlICk7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCwgb3JpZ1sgcHJvcCBdICk7CgkJCX0KCQl9KTsKCQlmb3IgKCBpbmRleCA9IDAgOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCXByb3AgPSBoYW5kbGVkWyBpbmRleCBdOwoJCQl0d2VlbiA9IGFuaW0uY3JlYXRlVHdlZW4oIHByb3AsIGhpZGRlbiA/IGRhdGFTaG93WyBwcm9wIF0gOiAwICk7CgkJCW9yaWdbIHByb3AgXSA9IGRhdGFTaG93WyBwcm9wIF0gfHwgalF1ZXJ5LnN0eWxlKCBlbGVtLCBwcm9wICk7CgoJCQlpZiAoICEoIHByb3AgaW4gZGF0YVNob3cgKSApIHsKCQkJCWRhdGFTaG93WyBwcm9wIF0gPSB0d2Vlbi5zdGFydDsKCQkJCWlmICggaGlkZGVuICkgewoJCQkJCXR3ZWVuLmVuZCA9IHR3ZWVuLnN0YXJ0OwoJCQkJCXR3ZWVuLnN0YXJ0ID0gcHJvcCA9PT0gIndpZHRoIiB8fCBwcm9wID09PSAiaGVpZ2h0IiA/IDEgOiAwOwoJCQkJfQoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBUd2VlbiggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKSB7CglyZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyApOwp9CmpRdWVyeS5Ud2VlbiA9IFR3ZWVuOwoKVHdlZW4ucHJvdG90eXBlID0gewoJY29uc3RydWN0b3I6IFR3ZWVuLAoJaW5pdDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0ICkgewoJCXRoaXMuZWxlbSA9IGVsZW07CgkJdGhpcy5wcm9wID0gcHJvcDsKCQl0aGlzLmVhc2luZyA9IGVhc2luZyB8fCAic3dpbmciOwoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgkJdGhpcy5zdGFydCA9IHRoaXMubm93ID0gdGhpcy5jdXIoKTsKCQl0aGlzLmVuZCA9IGVuZDsKCQl0aGlzLnVuaXQgPSB1bml0IHx8ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdID8gIiIgOiAicHgiICk7Cgl9LAoJY3VyOiBmdW5jdGlvbigpIHsKCQl2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbIHRoaXMucHJvcCBdOwoKCQlyZXR1cm4gaG9va3MgJiYgaG9va3MuZ2V0ID8KCQkJaG9va3MuZ2V0KCB0aGlzICkgOgoJCQlUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KCB0aGlzICk7Cgl9LAoJcnVuOiBmdW5jdGlvbiggcGVyY2VudCApIHsKCQl2YXIgZWFzZWQsCgkJCWhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCgkJdGhpcy5wb3MgPSBlYXNlZCA9IGpRdWVyeS5lYXNpbmdbIHRoaXMuZWFzaW5nIF0oIHBlcmNlbnQsIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIHBlcmNlbnQsIDAsIDEsIHRoaXMub3B0aW9ucy5kdXJhdGlvbiApOwoJCXRoaXMubm93ID0gKCB0aGlzLmVuZCAtIHRoaXMuc3RhcnQgKSAqIGVhc2VkICsgdGhpcy5zdGFydDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuc3RlcCApIHsKCQkJdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCggdGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyApOwoJCX0KCgkJaWYgKCBob29rcyAmJiBob29rcy5zZXQgKSB7CgkJCWhvb2tzLnNldCggdGhpcyApOwoJCX0gZWxzZSB7CgkJCVR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5zZXQoIHRoaXMgKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cn07CgpUd2Vlbi5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBUd2Vlbi5wcm90b3R5cGU7CgpUd2Vlbi5wcm9wSG9va3MgPSB7CglfZGVmYXVsdDogewoJCWdldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCQl2YXIgcmVzdWx0OwoKCQkJaWYgKCB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gIT0gbnVsbCAmJgoJCQkJKCF0d2Vlbi5lbGVtLnN0eWxlIHx8IHR3ZWVuLmVsZW0uc3R5bGVbIHR3ZWVuLnByb3AgXSA9PSBudWxsKSApIHsKCQkJCXJldHVybiB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF07CgkJCX0KCgkJCS8vIHBhc3NpbmcgYW55IHZhbHVlIGFzIGEgNHRoIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQoJCQkvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzCgkJCS8vIHNvLCBzaW1wbGUgdmFsdWVzIHN1Y2ggYXMgIjEwcHgiIGFyZSBwYXJzZWQgdG8gRmxvYXQuCgkJCS8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzIGlzLgoJCQlyZXN1bHQgPSBqUXVlcnkuY3NzKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCBmYWxzZSwgIiIgKTsKCQkJLy8gRW1wdHkgc3RyaW5ncywgbnVsbCwgdW5kZWZpbmVkIGFuZCAiYXV0byIgYXJlIGNvbnZlcnRlZCB0byAwLgoJCQlyZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICJhdXRvIiA/IDAgOiByZXN1bHQ7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKCQkJLy8gdXNlIHN0ZXAgaG9vayBmb3IgYmFjayBjb21wYXQgLSB1c2UgY3NzSG9vayBpZiBpdHMgdGhlcmUgLSB1c2UgLnN0eWxlIGlmIGl0cwoJCQkvLyBhdmFpbGFibGUgYW5kIHVzZSBwbGFpbiBwcm9wZXJ0aWVzIHdoZXJlIGF2YWlsYWJsZQoJCQlpZiAoIGpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0gKSB7CgkJCQlqUXVlcnkuZnguc3RlcFsgdHdlZW4ucHJvcCBdKCB0d2VlbiApOwoJCQl9IGVsc2UgaWYgKCB0d2Vlbi5lbGVtLnN0eWxlICYmICggdHdlZW4uZWxlbS5zdHlsZVsgalF1ZXJ5LmNzc1Byb3BzWyB0d2Vlbi5wcm9wIF0gXSAhPSBudWxsIHx8IGpRdWVyeS5jc3NIb29rc1sgdHdlZW4ucHJvcCBdICkgKSB7CgkJCQlqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsIHR3ZWVuLm5vdyArIHR3ZWVuLnVuaXQgKTsKCQkJfSBlbHNlIHsKCQkJCXR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsKCQkJfQoJCX0KCX0KfTsKCi8vIFJlbW92ZSBpbiAyLjAgLSB0aGlzIHN1cHBvcnRzIElFOCdzIHBhbmljIGJhc2VkIGFwcHJvYWNoCi8vIHRvIHNldHRpbmcgdGhpbmdzIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwoKVHdlZW4ucHJvcEhvb2tzLnNjcm9sbFRvcCA9IFR3ZWVuLnByb3BIb29rcy5zY3JvbGxMZWZ0ID0gewoJc2V0OiBmdW5jdGlvbiggdHdlZW4gKSB7CgkJaWYgKCB0d2Vlbi5lbGVtLm5vZGVUeXBlICYmIHR3ZWVuLmVsZW0ucGFyZW50Tm9kZSApIHsKCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93OwoJCX0KCX0KfTsKCmpRdWVyeS5lYWNoKFsgInRvZ2dsZSIsICJzaG93IiwgImhpZGUiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJdmFyIGNzc0ZuID0galF1ZXJ5LmZuWyBuYW1lIF07CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQlyZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICJib29sZWFuIiB8fAoJCQkvLyBzcGVjaWFsIGNoZWNrIGZvciAudG9nZ2xlKCBoYW5kbGVyLCBoYW5kbGVyLCAuLi4gKQoJCQkoICFpICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBzcGVlZCApICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBlYXNpbmcgKSApID8KCQkJY3NzRm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApIDoKCQkJdGhpcy5hbmltYXRlKCBnZW5GeCggbmFtZSwgdHJ1ZSApLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwoJfTsKfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWZhZGVUbzogZnVuY3Rpb24oIHNwZWVkLCB0bywgZWFzaW5nLCBjYWxsYmFjayApIHsKCgkJLy8gc2hvdyBhbnkgaGlkZGVuIGVsZW1lbnRzIGFmdGVyIHNldHRpbmcgb3BhY2l0eSB0byAwCgkJcmV0dXJuIHRoaXMuZmlsdGVyKCBpc0hpZGRlbiApLmNzcyggIm9wYWNpdHkiLCAwICkuc2hvdygpCgoJCQkvLyBhbmltYXRlIHRvIHRoZSB2YWx1ZSBzcGVjaWZpZWQKCQkJLmVuZCgpLmFuaW1hdGUoeyBvcGFjaXR5OiB0byB9LCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwoJfSwKCWFuaW1hdGU6IGZ1bmN0aW9uKCBwcm9wLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQl2YXIgZW1wdHkgPSBqUXVlcnkuaXNFbXB0eU9iamVjdCggcHJvcCApLAoJCQlvcHRhbGwgPSBqUXVlcnkuc3BlZWQoIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICksCgkJCWRvQW5pbWF0aW9uID0gZnVuY3Rpb24oKSB7CgkJCQkvLyBPcGVyYXRlIG9uIGEgY29weSBvZiBwcm9wIHNvIHBlci1wcm9wZXJ0eSBlYXNpbmcgd29uJ3QgYmUgbG9zdAoJCQkJdmFyIGFuaW0gPSBBbmltYXRpb24oIHRoaXMsIGpRdWVyeS5leHRlbmQoIHt9LCBwcm9wICksIG9wdGFsbCApOwoKCQkJCS8vIEVtcHR5IGFuaW1hdGlvbnMgcmVzb2x2ZSBpbW1lZGlhdGVseQoJCQkJaWYgKCBlbXB0eSApIHsKCQkJCQlhbmltLnN0b3AoIHRydWUgKTsKCQkJCX0KCQkJfTsKCgkJcmV0dXJuIGVtcHR5IHx8IG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPwoJCQl0aGlzLmVhY2goIGRvQW5pbWF0aW9uICkgOgoJCQl0aGlzLnF1ZXVlKCBvcHRhbGwucXVldWUsIGRvQW5pbWF0aW9uICk7Cgl9LAoJc3RvcDogZnVuY3Rpb24oIHR5cGUsIGNsZWFyUXVldWUsIGdvdG9FbmQgKSB7CgkJdmFyIHN0b3BRdWV1ZSA9IGZ1bmN0aW9uKCBob29rcyApIHsKCQkJdmFyIHN0b3AgPSBob29rcy5zdG9wOwoJCQlkZWxldGUgaG9va3Muc3RvcDsKCQkJc3RvcCggZ290b0VuZCApOwoJCX07CgoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQlnb3RvRW5kID0gY2xlYXJRdWV1ZTsKCQkJY2xlYXJRdWV1ZSA9IHR5cGU7CgkJCXR5cGUgPSB1bmRlZmluZWQ7CgkJfQoJCWlmICggY2xlYXJRdWV1ZSAmJiB0eXBlICE9PSBmYWxzZSApIHsKCQkJdGhpcy5xdWV1ZSggdHlwZSB8fCAiZngiLCBbXSApOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGRlcXVldWUgPSB0cnVlLAoJCQkJaW5kZXggPSB0eXBlICE9IG51bGwgJiYgdHlwZSArICJxdWV1ZUhvb2tzIiwKCQkJCXRpbWVycyA9IGpRdWVyeS50aW1lcnMsCgkJCQlkYXRhID0galF1ZXJ5Ll9kYXRhKCB0aGlzICk7CgoJCQlpZiAoIGluZGV4ICkgewoJCQkJaWYgKCBkYXRhWyBpbmRleCBdICYmIGRhdGFbIGluZGV4IF0uc3RvcCApIHsKCQkJCQlzdG9wUXVldWUoIGRhdGFbIGluZGV4IF0gKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIGluZGV4IGluIGRhdGEgKSB7CgkJCQkJaWYgKCBkYXRhWyBpbmRleCBdICYmIGRhdGFbIGluZGV4IF0uc3RvcCAmJiBycnVuLnRlc3QoIGluZGV4ICkgKSB7CgkJCQkJCXN0b3BRdWV1ZSggZGF0YVsgaW5kZXggXSApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJZm9yICggaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOyApIHsKCQkJCWlmICggdGltZXJzWyBpbmRleCBdLmVsZW0gPT09IHRoaXMgJiYgKHR5cGUgPT0gbnVsbCB8fCB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUpICkgewoJCQkJCXRpbWVyc1sgaW5kZXggXS5hbmltLnN0b3AoIGdvdG9FbmQgKTsKCQkJCQlkZXF1ZXVlID0gZmFsc2U7CgkJCQkJdGltZXJzLnNwbGljZSggaW5kZXgsIDEgKTsKCQkJCX0KCQkJfQoKCQkJLy8gc3RhcnQgdGhlIG5leHQgaW4gdGhlIHF1ZXVlIGlmIHRoZSBsYXN0IHN0ZXAgd2Fzbid0IGZvcmNlZAoJCQkvLyB0aW1lcnMgY3VycmVudGx5IHdpbGwgY2FsbCB0aGVpciBjb21wbGV0ZSBjYWxsYmFja3MsIHdoaWNoIHdpbGwgZGVxdWV1ZQoJCQkvLyBidXQgb25seSBpZiB0aGV5IHdlcmUgZ290b0VuZAoJCQlpZiAoIGRlcXVldWUgfHwgIWdvdG9FbmQgKSB7CgkJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgdHlwZSApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy8gR2VuZXJhdGUgcGFyYW1ldGVycyB0byBjcmVhdGUgYSBzdGFuZGFyZCBhbmltYXRpb24KZnVuY3Rpb24gZ2VuRngoIHR5cGUsIGluY2x1ZGVXaWR0aCApIHsKCXZhciB3aGljaCwKCQlhdHRycyA9IHsgaGVpZ2h0OiB0eXBlIH0sCgkJaSA9IDA7CgoJLy8gaWYgd2UgaW5jbHVkZSB3aWR0aCwgc3RlcCB2YWx1ZSBpcyAxIHRvIGRvIGFsbCBjc3NFeHBhbmQgdmFsdWVzLAoJLy8gaWYgd2UgZG9uJ3QgaW5jbHVkZSB3aWR0aCwgc3RlcCB2YWx1ZSBpcyAyIHRvIHNraXAgb3ZlciBMZWZ0IGFuZCBSaWdodAoJZm9yKCA7IGkgPCA0IDsgaSArPSAyIC0gaW5jbHVkZVdpZHRoICkgewoJCXdoaWNoID0gY3NzRXhwYW5kWyBpIF07CgkJYXR0cnNbICJtYXJnaW4iICsgd2hpY2ggXSA9IGF0dHJzWyAicGFkZGluZyIgKyB3aGljaCBdID0gdHlwZTsKCX0KCglpZiAoIGluY2x1ZGVXaWR0aCApIHsKCQlhdHRycy5vcGFjaXR5ID0gYXR0cnMud2lkdGggPSB0eXBlOwoJfQoKCXJldHVybiBhdHRyczsKfQoKLy8gR2VuZXJhdGUgc2hvcnRjdXRzIGZvciBjdXN0b20gYW5pbWF0aW9ucwpqUXVlcnkuZWFjaCh7CglzbGlkZURvd246IGdlbkZ4KCJzaG93IiksCglzbGlkZVVwOiBnZW5GeCgiaGlkZSIpLAoJc2xpZGVUb2dnbGU6IGdlbkZ4KCJ0b2dnbGUiKSwKCWZhZGVJbjogeyBvcGFjaXR5OiAic2hvdyIgfSwKCWZhZGVPdXQ6IHsgb3BhY2l0eTogImhpZGUiIH0sCglmYWRlVG9nZ2xlOiB7IG9wYWNpdHk6ICJ0b2dnbGUiIH0KfSwgZnVuY3Rpb24oIG5hbWUsIHByb3BzICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSggcHJvcHMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7Cgl9Owp9KTsKCmpRdWVyeS5zcGVlZCA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBmbiApIHsKCXZhciBvcHQgPSBzcGVlZCAmJiB0eXBlb2Ygc3BlZWQgPT09ICJvYmplY3QiID8galF1ZXJ5LmV4dGVuZCgge30sIHNwZWVkICkgOiB7CgkJY29tcGxldGU6IGZuIHx8ICFmbiAmJiBlYXNpbmcgfHwKCQkJalF1ZXJ5LmlzRnVuY3Rpb24oIHNwZWVkICkgJiYgc3BlZWQsCgkJZHVyYXRpb246IHNwZWVkLAoJCWVhc2luZzogZm4gJiYgZWFzaW5nIHx8IGVhc2luZyAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24oIGVhc2luZyApICYmIGVhc2luZwoJfTsKCglvcHQuZHVyYXRpb24gPSBqUXVlcnkuZngub2ZmID8gMCA6IHR5cGVvZiBvcHQuZHVyYXRpb24gPT09ICJudW1iZXIiID8gb3B0LmR1cmF0aW9uIDoKCQlvcHQuZHVyYXRpb24gaW4galF1ZXJ5LmZ4LnNwZWVkcyA/IGpRdWVyeS5meC5zcGVlZHNbIG9wdC5kdXJhdGlvbiBdIDogalF1ZXJ5LmZ4LnNwZWVkcy5fZGVmYXVsdDsKCgkvLyBub3JtYWxpemUgb3B0LnF1ZXVlIC0gdHJ1ZS91bmRlZmluZWQvbnVsbCAtPiAiZngiCglpZiAoIG9wdC5xdWV1ZSA9PSBudWxsIHx8IG9wdC5xdWV1ZSA9PT0gdHJ1ZSApIHsKCQlvcHQucXVldWUgPSAiZngiOwoJfQoKCS8vIFF1ZXVlaW5nCglvcHQub2xkID0gb3B0LmNvbXBsZXRlOwoKCW9wdC5jb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIG9wdC5vbGQgKSApIHsKCQkJb3B0Lm9sZC5jYWxsKCB0aGlzICk7CgkJfQoKCQlpZiAoIG9wdC5xdWV1ZSApIHsKCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIG9wdC5xdWV1ZSApOwoJCX0KCX07CgoJcmV0dXJuIG9wdDsKfTsKCmpRdWVyeS5lYXNpbmcgPSB7CglsaW5lYXI6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiBwOwoJfSwKCXN3aW5nOiBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gMC41IC0gTWF0aC5jb3MoIHAqTWF0aC5QSSApIC8gMjsKCX0KfTsKCmpRdWVyeS50aW1lcnMgPSBbXTsKalF1ZXJ5LmZ4ID0gVHdlZW4ucHJvdG90eXBlLmluaXQ7CmpRdWVyeS5meC50aWNrID0gZnVuY3Rpb24oKSB7Cgl2YXIgdGltZXIsCgkJdGltZXJzID0galF1ZXJ5LnRpbWVycywKCQlpID0gMDsKCglmb3IgKCA7IGkgPCB0aW1lcnMubGVuZ3RoOyBpKysgKSB7CgkJdGltZXIgPSB0aW1lcnNbIGkgXTsKCQkvLyBDaGVja3MgdGhlIHRpbWVyIGhhcyBub3QgYWxyZWFkeSBiZWVuIHJlbW92ZWQKCQlpZiAoICF0aW1lcigpICYmIHRpbWVyc1sgaSBdID09PSB0aW1lciApIHsKCQkJdGltZXJzLnNwbGljZSggaS0tLCAxICk7CgkJfQoJfQoKCWlmICggIXRpbWVycy5sZW5ndGggKSB7CgkJalF1ZXJ5LmZ4LnN0b3AoKTsKCX0KfTsKCmpRdWVyeS5meC50aW1lciA9IGZ1bmN0aW9uKCB0aW1lciApIHsKCWlmICggdGltZXIoKSAmJiBqUXVlcnkudGltZXJzLnB1c2goIHRpbWVyICkgJiYgIXRpbWVySWQgKSB7CgkJdGltZXJJZCA9IHNldEludGVydmFsKCBqUXVlcnkuZngudGljaywgalF1ZXJ5LmZ4LmludGVydmFsICk7Cgl9Cn07CgpqUXVlcnkuZnguaW50ZXJ2YWwgPSAxMzsKCmpRdWVyeS5meC5zdG9wID0gZnVuY3Rpb24oKSB7CgljbGVhckludGVydmFsKCB0aW1lcklkICk7Cgl0aW1lcklkID0gbnVsbDsKfTsKCmpRdWVyeS5meC5zcGVlZHMgPSB7CglzbG93OiA2MDAsCglmYXN0OiAyMDAsCgkvLyBEZWZhdWx0IHNwZWVkCglfZGVmYXVsdDogNDAwCn07CgovLyBCYWNrIENvbXBhdCA8MS44IGV4dGVuc2lvbiBwb2ludApqUXVlcnkuZnguc3RlcCA9IHt9OwoKaWYgKCBqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzICkgewoJalF1ZXJ5LmV4cHIuZmlsdGVycy5hbmltYXRlZCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChqUXVlcnkudGltZXJzLCBmdW5jdGlvbiggZm4gKSB7CgkJCXJldHVybiBlbGVtID09PSBmbi5lbGVtOwoJCX0pLmxlbmd0aDsKCX07Cn0KdmFyIHJyb290ID0gL14oPzpib2R5fGh0bWwpJC9pOwoKalF1ZXJ5LmZuLm9mZnNldCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCXJldHVybiBvcHRpb25zID09PSB1bmRlZmluZWQgPwoJCQl0aGlzIDoKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQkJalF1ZXJ5Lm9mZnNldC5zZXRPZmZzZXQoIHRoaXMsIG9wdGlvbnMsIGkgKTsKCQkJfSk7Cgl9CgoJdmFyIGJveCwgZG9jRWxlbSwgYm9keSwgd2luLCBjbGllbnRUb3AsIGNsaWVudExlZnQsIHNjcm9sbFRvcCwgc2Nyb2xsTGVmdCwgdG9wLCBsZWZ0LAoJCWVsZW0gPSB0aGlzWyAwIF0sCgkJZG9jID0gZWxlbSAmJiBlbGVtLm93bmVyRG9jdW1lbnQ7CgoJaWYgKCAhZG9jICkgewoJCXJldHVybjsKCX0KCglpZiAoIChib2R5ID0gZG9jLmJvZHkpID09PSBlbGVtICkgewoJCXJldHVybiBqUXVlcnkub2Zmc2V0LmJvZHlPZmZzZXQoIGVsZW0gKTsKCX0KCglkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKCgkvLyBNYWtlIHN1cmUgd2UncmUgbm90IGRlYWxpbmcgd2l0aCBhIGRpc2Nvbm5lY3RlZCBET00gbm9kZQoJaWYgKCAhalF1ZXJ5LmNvbnRhaW5zKCBkb2NFbGVtLCBlbGVtICkgKSB7CgkJcmV0dXJuIHsgdG9wOiAwLCBsZWZ0OiAwIH07Cgl9CgoJYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCXdpbiA9IGdldFdpbmRvdyggZG9jICk7CgljbGllbnRUb3AgID0gZG9jRWxlbS5jbGllbnRUb3AgIHx8IGJvZHkuY2xpZW50VG9wICB8fCAwOwoJY2xpZW50TGVmdCA9IGRvY0VsZW0uY2xpZW50TGVmdCB8fCBib2R5LmNsaWVudExlZnQgfHwgMDsKCXNjcm9sbFRvcCAgPSB3aW4ucGFnZVlPZmZzZXQgfHwgZG9jRWxlbS5zY3JvbGxUb3A7CglzY3JvbGxMZWZ0ID0gd2luLnBhZ2VYT2Zmc2V0IHx8IGRvY0VsZW0uc2Nyb2xsTGVmdDsKCXRvcCAgPSBib3gudG9wICArIHNjcm9sbFRvcCAgLSBjbGllbnRUb3A7CglsZWZ0ID0gYm94LmxlZnQgKyBzY3JvbGxMZWZ0IC0gY2xpZW50TGVmdDsKCglyZXR1cm4geyB0b3A6IHRvcCwgbGVmdDogbGVmdCB9Owp9OwoKalF1ZXJ5Lm9mZnNldCA9IHsKCglib2R5T2Zmc2V0OiBmdW5jdGlvbiggYm9keSApIHsKCQl2YXIgdG9wID0gYm9keS5vZmZzZXRUb3AsCgkJCWxlZnQgPSBib2R5Lm9mZnNldExlZnQ7CgoJCWlmICggalF1ZXJ5LnN1cHBvcnQuZG9lc05vdEluY2x1ZGVNYXJnaW5JbkJvZHlPZmZzZXQgKSB7CgkJCXRvcCAgKz0gcGFyc2VGbG9hdCggalF1ZXJ5LmNzcyhib2R5LCAibWFyZ2luVG9wIikgKSB8fCAwOwoJCQlsZWZ0ICs9IHBhcnNlRmxvYXQoIGpRdWVyeS5jc3MoYm9keSwgIm1hcmdpbkxlZnQiKSApIHx8IDA7CgkJfQoKCQlyZXR1cm4geyB0b3A6IHRvcCwgbGVmdDogbGVmdCB9OwoJfSwKCglzZXRPZmZzZXQ6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBpICkgewoJCXZhciBwb3NpdGlvbiA9IGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKTsKCgkJLy8gc2V0IHBvc2l0aW9uIGZpcnN0LCBpbi1jYXNlIHRvcC9sZWZ0IGFyZSBzZXQgZXZlbiBvbiBzdGF0aWMgZWxlbQoJCWlmICggcG9zaXRpb24gPT09ICJzdGF0aWMiICkgewoJCQllbGVtLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKCQl9CgoJCXZhciBjdXJFbGVtID0galF1ZXJ5KCBlbGVtICksCgkJCWN1ck9mZnNldCA9IGN1ckVsZW0ub2Zmc2V0KCksCgkJCWN1ckNTU1RvcCA9IGpRdWVyeS5jc3MoIGVsZW0sICJ0b3AiICksCgkJCWN1ckNTU0xlZnQgPSBqUXVlcnkuY3NzKCBlbGVtLCAibGVmdCIgKSwKCQkJY2FsY3VsYXRlUG9zaXRpb24gPSAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgJiYgalF1ZXJ5LmluQXJyYXkoImF1dG8iLCBbY3VyQ1NTVG9wLCBjdXJDU1NMZWZ0XSkgPiAtMSwKCQkJcHJvcHMgPSB7fSwgY3VyUG9zaXRpb24gPSB7fSwgY3VyVG9wLCBjdXJMZWZ0OwoKCQkvLyBuZWVkIHRvIGJlIGFibGUgdG8gY2FsY3VsYXRlIHBvc2l0aW9uIGlmIGVpdGhlciB0b3Agb3IgbGVmdCBpcyBhdXRvIGFuZCBwb3NpdGlvbiBpcyBlaXRoZXIgYWJzb2x1dGUgb3IgZml4ZWQKCQlpZiAoIGNhbGN1bGF0ZVBvc2l0aW9uICkgewoJCQljdXJQb3NpdGlvbiA9IGN1ckVsZW0ucG9zaXRpb24oKTsKCQkJY3VyVG9wID0gY3VyUG9zaXRpb24udG9wOwoJCQljdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKCQl9IGVsc2UgewoJCQljdXJUb3AgPSBwYXJzZUZsb2F0KCBjdXJDU1NUb3AgKSB8fCAwOwoJCQljdXJMZWZ0ID0gcGFyc2VGbG9hdCggY3VyQ1NTTGVmdCApIHx8IDA7CgkJfQoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBvcHRpb25zICkgKSB7CgkJCW9wdGlvbnMgPSBvcHRpb25zLmNhbGwoIGVsZW0sIGksIGN1ck9mZnNldCApOwoJCX0KCgkJaWYgKCBvcHRpb25zLnRvcCAhPSBudWxsICkgewoJCQlwcm9wcy50b3AgPSAoIG9wdGlvbnMudG9wIC0gY3VyT2Zmc2V0LnRvcCApICsgY3VyVG9wOwoJCX0KCQlpZiAoIG9wdGlvbnMubGVmdCAhPSBudWxsICkgewoJCQlwcm9wcy5sZWZ0ID0gKCBvcHRpb25zLmxlZnQgLSBjdXJPZmZzZXQubGVmdCApICsgY3VyTGVmdDsKCQl9CgoJCWlmICggInVzaW5nIiBpbiBvcHRpb25zICkgewoJCQlvcHRpb25zLnVzaW5nLmNhbGwoIGVsZW0sIHByb3BzICk7CgkJfSBlbHNlIHsKCQkJY3VyRWxlbS5jc3MoIHByb3BzICk7CgkJfQoJfQp9OwoKCmpRdWVyeS5mbi5leHRlbmQoewoKCXBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzWzBdICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgZWxlbSA9IHRoaXNbMF0sCgoJCS8vIEdldCAqcmVhbCogb2Zmc2V0UGFyZW50CgkJb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQoKSwKCgkJLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwoJCW9mZnNldCAgICAgICA9IHRoaXMub2Zmc2V0KCksCgkJcGFyZW50T2Zmc2V0ID0gcnJvb3QudGVzdChvZmZzZXRQYXJlbnRbMF0ubm9kZU5hbWUpID8geyB0b3A6IDAsIGxlZnQ6IDAgfSA6IG9mZnNldFBhcmVudC5vZmZzZXQoKTsKCgkJLy8gU3VidHJhY3QgZWxlbWVudCBtYXJnaW5zCgkJLy8gbm90ZTogd2hlbiBhbiBlbGVtZW50IGhhcyBtYXJnaW46IGF1dG8gdGhlIG9mZnNldExlZnQgYW5kIG1hcmdpbkxlZnQKCQkvLyBhcmUgdGhlIHNhbWUgaW4gU2FmYXJpIGNhdXNpbmcgb2Zmc2V0LmxlZnQgdG8gaW5jb3JyZWN0bHkgYmUgMAoJCW9mZnNldC50b3AgIC09IHBhcnNlRmxvYXQoIGpRdWVyeS5jc3MoZWxlbSwgIm1hcmdpblRvcCIpICkgfHwgMDsKCQlvZmZzZXQubGVmdCAtPSBwYXJzZUZsb2F0KCBqUXVlcnkuY3NzKGVsZW0sICJtYXJnaW5MZWZ0IikgKSB8fCAwOwoKCQkvLyBBZGQgb2Zmc2V0UGFyZW50IGJvcmRlcnMKCQlwYXJlbnRPZmZzZXQudG9wICArPSBwYXJzZUZsb2F0KCBqUXVlcnkuY3NzKG9mZnNldFBhcmVudFswXSwgImJvcmRlclRvcFdpZHRoIikgKSB8fCAwOwoJCXBhcmVudE9mZnNldC5sZWZ0ICs9IHBhcnNlRmxvYXQoIGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50WzBdLCAiYm9yZGVyTGVmdFdpZHRoIikgKSB8fCAwOwoKCQkvLyBTdWJ0cmFjdCB0aGUgdHdvIG9mZnNldHMKCQlyZXR1cm4gewoJCQl0b3A6ICBvZmZzZXQudG9wICAtIHBhcmVudE9mZnNldC50b3AsCgkJCWxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQKCQl9OwoJfSwKCglvZmZzZXRQYXJlbnQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50IHx8IGRvY3VtZW50LmJvZHk7CgkJCXdoaWxlICggb2Zmc2V0UGFyZW50ICYmICghcnJvb3QudGVzdChvZmZzZXRQYXJlbnQubm9kZU5hbWUpICYmIGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50LCAicG9zaXRpb24iKSA9PT0gInN0YXRpYyIpICkgewoJCQkJb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKCQkJfQoJCQlyZXR1cm4gb2Zmc2V0UGFyZW50IHx8IGRvY3VtZW50LmJvZHk7CgkJfSk7Cgl9Cn0pOwoKCi8vIENyZWF0ZSBzY3JvbGxMZWZ0IGFuZCBzY3JvbGxUb3AgbWV0aG9kcwpqUXVlcnkuZWFjaCgge3Njcm9sbExlZnQ6ICJwYWdlWE9mZnNldCIsIHNjcm9sbFRvcDogInBhZ2VZT2Zmc2V0In0sIGZ1bmN0aW9uKCBtZXRob2QsIHByb3AgKSB7Cgl2YXIgdG9wID0gL1kvLnRlc3QoIHByb3AgKTsKCglqUXVlcnkuZm5bIG1ldGhvZCBdID0gZnVuY3Rpb24oIHZhbCApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIG1ldGhvZCwgdmFsICkgewoJCQl2YXIgd2luID0gZ2V0V2luZG93KCBlbGVtICk7CgoJCQlpZiAoIHZhbCA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHdpbiA/IChwcm9wIGluIHdpbikgPyB3aW5bIHByb3AgXSA6CgkJCQkJd2luLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgbWV0aG9kIF0gOgoJCQkJCWVsZW1bIG1ldGhvZCBdOwoJCQl9CgoJCQlpZiAoIHdpbiApIHsKCQkJCXdpbi5zY3JvbGxUbygKCQkJCQkhdG9wID8gdmFsIDogalF1ZXJ5KCB3aW4gKS5zY3JvbGxMZWZ0KCksCgkJCQkJIHRvcCA/IHZhbCA6IGpRdWVyeSggd2luICkuc2Nyb2xsVG9wKCkKCQkJCSk7CgoJCQl9IGVsc2UgewoJCQkJZWxlbVsgbWV0aG9kIF0gPSB2YWw7CgkJCX0KCQl9LCBtZXRob2QsIHZhbCwgYXJndW1lbnRzLmxlbmd0aCwgbnVsbCApOwoJfTsKfSk7CgpmdW5jdGlvbiBnZXRXaW5kb3coIGVsZW0gKSB7CglyZXR1cm4galF1ZXJ5LmlzV2luZG93KCBlbGVtICkgPwoJCWVsZW0gOgoJCWVsZW0ubm9kZVR5cGUgPT09IDkgPwoJCQllbGVtLmRlZmF1bHRWaWV3IHx8IGVsZW0ucGFyZW50V2luZG93IDoKCQkJZmFsc2U7Cn0KLy8gQ3JlYXRlIGlubmVySGVpZ2h0LCBpbm5lcldpZHRoLCBoZWlnaHQsIHdpZHRoLCBvdXRlckhlaWdodCBhbmQgb3V0ZXJXaWR0aCBtZXRob2RzCmpRdWVyeS5lYWNoKCB7IEhlaWdodDogImhlaWdodCIsIFdpZHRoOiAid2lkdGgiIH0sIGZ1bmN0aW9uKCBuYW1lLCB0eXBlICkgewoJalF1ZXJ5LmVhY2goIHsgcGFkZGluZzogImlubmVyIiArIG5hbWUsIGNvbnRlbnQ6IHR5cGUsICIiOiAib3V0ZXIiICsgbmFtZSB9LCBmdW5jdGlvbiggZGVmYXVsdEV4dHJhLCBmdW5jTmFtZSApIHsKCQkvLyBtYXJnaW4gaXMgb25seSBmb3Igb3V0ZXJIZWlnaHQsIG91dGVyV2lkdGgKCQlqUXVlcnkuZm5bIGZ1bmNOYW1lIF0gPSBmdW5jdGlvbiggbWFyZ2luLCB2YWx1ZSApIHsKCQkJdmFyIGNoYWluYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggJiYgKCBkZWZhdWx0RXh0cmEgfHwgdHlwZW9mIG1hcmdpbiAhPT0gImJvb2xlYW4iICksCgkJCQlleHRyYSA9IGRlZmF1bHRFeHRyYSB8fCAoIG1hcmdpbiA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gdHJ1ZSA/ICJtYXJnaW4iIDogImJvcmRlciIgKTsKCgkJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgdHlwZSwgdmFsdWUgKSB7CgkJCQl2YXIgZG9jOwoKCQkJCWlmICggalF1ZXJ5LmlzV2luZG93KCBlbGVtICkgKSB7CgkJCQkJLy8gQXMgb2YgNS84LzIwMTIgdGhpcyB3aWxsIHlpZWxkIGluY29ycmVjdCByZXN1bHRzIGZvciBNb2JpbGUgU2FmYXJpLCBidXQgdGhlcmUKCQkJCQkvLyBpc24ndCBhIHdob2xlIGxvdCB3ZSBjYW4gZG8uIFNlZSBwdWxsIHJlcXVlc3QgYXQgdGhpcyBVUkwgZm9yIGRpc2N1c3Npb246CgkJCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnkvcHVsbC83NjQKCQkJCQlyZXR1cm4gZWxlbS5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbICJjbGllbnQiICsgbmFtZSBdOwoJCQkJfQoKCQkJCS8vIEdldCBkb2N1bWVudCB3aWR0aCBvciBoZWlnaHQKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCQlkb2MgPSBlbGVtLmRvY3VtZW50RWxlbWVudDsKCgkJCQkJLy8gRWl0aGVyIHNjcm9sbFtXaWR0aC9IZWlnaHRdIG9yIG9mZnNldFtXaWR0aC9IZWlnaHRdIG9yIGNsaWVudFtXaWR0aC9IZWlnaHRdLCB3aGljaGV2ZXIgaXMgZ3JlYXRlc3QKCQkJCQkvLyB1bmZvcnR1bmF0ZWx5LCB0aGlzIGNhdXNlcyBidWcgIzM4MzggaW4gSUU2Lzggb25seSwgYnV0IHRoZXJlIGlzIGN1cnJlbnRseSBubyBnb29kLCBzbWFsbCB3YXkgdG8gZml4IGl0LgoJCQkJCXJldHVybiBNYXRoLm1heCgKCQkJCQkJZWxlbS5ib2R5WyAic2Nyb2xsIiArIG5hbWUgXSwgZG9jWyAic2Nyb2xsIiArIG5hbWUgXSwKCQkJCQkJZWxlbS5ib2R5WyAib2Zmc2V0IiArIG5hbWUgXSwgZG9jWyAib2Zmc2V0IiArIG5hbWUgXSwKCQkJCQkJZG9jWyAiY2xpZW50IiArIG5hbWUgXQoJCQkJCSk7CgkJCQl9CgoJCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwoJCQkJCS8vIEdldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQsIHJlcXVlc3RpbmcgYnV0IG5vdCBmb3JjaW5nIHBhcnNlRmxvYXQKCQkJCQlqUXVlcnkuY3NzKCBlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEgKSA6CgoJCQkJCS8vIFNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKCQkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHR5cGUsIHZhbHVlLCBleHRyYSApOwoJCQl9LCB0eXBlLCBjaGFpbmFibGUgPyBtYXJnaW4gOiB1bmRlZmluZWQsIGNoYWluYWJsZSApOwoJCX07Cgl9KTsKfSk7Ci8vIEV4cG9zZSBqUXVlcnkgdG8gdGhlIGdsb2JhbCBvYmplY3QKd2luZG93LmpRdWVyeSA9IHdpbmRvdy4kID0galF1ZXJ5OwoKLy8gRXhwb3NlIGpRdWVyeSBhcyBhbiBBTUQgbW9kdWxlLCBidXQgb25seSBmb3IgQU1EIGxvYWRlcnMgdGhhdAovLyB1bmRlcnN0YW5kIHRoZSBpc3N1ZXMgd2l0aCBsb2FkaW5nIG11bHRpcGxlIHZlcnNpb25zIG9mIGpRdWVyeQovLyBpbiBhIHBhZ2UgdGhhdCBhbGwgbWlnaHQgY2FsbCBkZWZpbmUoKS4gVGhlIGxvYWRlciB3aWxsIGluZGljYXRlCi8vIHRoZXkgaGF2ZSBzcGVjaWFsIGFsbG93YW5jZXMgZm9yIG11bHRpcGxlIGpRdWVyeSB2ZXJzaW9ucyBieQovLyBzcGVjaWZ5aW5nIGRlZmluZS5hbWQualF1ZXJ5ID0gdHJ1ZS4gUmVnaXN0ZXIgYXMgYSBuYW1lZCBtb2R1bGUsCi8vIHNpbmNlIGpRdWVyeSBjYW4gYmUgY29uY2F0ZW5hdGVkIHdpdGggb3RoZXIgZmlsZXMgdGhhdCBtYXkgdXNlIGRlZmluZSwKLy8gYnV0IG5vdCB1c2UgYSBwcm9wZXIgY29uY2F0ZW5hdGlvbiBzY3JpcHQgdGhhdCB1bmRlcnN0YW5kcyBhbm9ueW1vdXMKLy8gQU1EIG1vZHVsZXMuIEEgbmFtZWQgQU1EIGlzIHNhZmVzdCBhbmQgbW9zdCByb2J1c3Qgd2F5IHRvIHJlZ2lzdGVyLgovLyBMb3dlcmNhc2UganF1ZXJ5IGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZSBkZXJpdmVkIGZyb20KLy8gZmlsZSBuYW1lcywgYW5kIGpRdWVyeSBpcyBub3JtYWxseSBkZWxpdmVyZWQgaW4gYSBsb3dlcmNhc2UgZmlsZSBuYW1lLgovLyBEbyB0aGlzIGFmdGVyIGNyZWF0aW5nIHRoZSBnbG9iYWwgc28gdGhhdCBpZiBhbiBBTUQgbW9kdWxlIHdhbnRzIHRvIGNhbGwKLy8gbm9Db25mbGljdCB0byBoaWRlIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnksIGl0IHdpbGwgd29yay4KaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgJiYgZGVmaW5lLmFtZC5qUXVlcnkgKSB7CglkZWZpbmUoICJqcXVlcnkiLCBbXSwgZnVuY3Rpb24gKCkgeyByZXR1cm4galF1ZXJ5OyB9ICk7Cn0KCn0pKCB3aW5kb3cgKTsKCi8vCi8vIHNob3dkb3duLmpzIC0tIEEgamF2YXNjcmlwdCBwb3J0IG9mIE1hcmtkb3duLgovLwovLyBDb3B5cmlnaHQgKGMpIDIwMDcgSm9obiBGcmFzZXIuCi8vCi8vIE9yaWdpbmFsIE1hcmtkb3duIENvcHlyaWdodCAoYykgMjAwNC0yMDA1IEpvaG4gR3J1YmVyCi8vICAgPGh0dHA6Ly9kYXJpbmdmaXJlYmFsbC5uZXQvcHJvamVjdHMvbWFya2Rvd24vPgovLwovLyBSZWRpc3RyaWJ1dGFibGUgdW5kZXIgYSBCU0Qtc3R5bGUgb3BlbiBzb3VyY2UgbGljZW5zZS4KLy8gU2VlIGxpY2Vuc2UudHh0IGZvciBtb3JlIGluZm9ybWF0aW9uLgovLwovLyBUaGUgZnVsbCBzb3VyY2UgZGlzdHJpYnV0aW9uIGlzIGF0OgovLwovLwkJCQlBIEEgTAovLwkJCQlUIEMgQQovLwkJCQlUIEsgQgovLwovLyAgIDxodHRwOi8vd3d3LmF0dGFja2xhYi5uZXQvPgovLwovLwovLyBXaGVyZXZlciBwb3NzaWJsZSwgU2hvd2Rvd24gaXMgYSBzdHJhaWdodCwgbGluZS1ieS1saW5lIHBvcnQKLy8gb2YgdGhlIFBlcmwgdmVyc2lvbiBvZiBNYXJrZG93bi4KLy8KLy8gVGhpcyBpcyBub3QgYSBub3JtYWwgcGFyc2VyIGRlc2lnbjsgaXQncyBiYXNpY2FsbHkganVzdCBhCi8vIHNlcmllcyBvZiBzdHJpbmcgc3Vic3RpdHV0aW9ucy4gIEl0J3MgaGFyZCB0byByZWFkIGFuZAovLyBtYWludGFpbiB0aGlzIHdheSwgIGJ1dCBrZWVwaW5nIFNob3dkb3duIGNsb3NlIHRvIHRoZSBvcmlnaW5hbAovLyBkZXNpZ24gbWFrZXMgaXQgZWFzaWVyIHRvIHBvcnQgbmV3IGZlYXR1cmVzLgovLwovLyBNb3JlIGltcG9ydGFudGx5LCBTaG93ZG93biBiZWhhdmVzIGxpa2UgbWFya2Rvd24ucGwgaW4gbW9zdAovLyBlZGdlIGNhc2VzLiAgU28gd2ViIGFwcGxpY2F0aW9ucyBjYW4gZG8gY2xpZW50LXNpZGUgcHJldmlldwovLyBpbiBKYXZhc2NyaXB0LCBhbmQgdGhlbiBidWlsZCBpZGVudGljYWwgSFRNTCBvbiB0aGUgc2VydmVyLgovLwovLyBUaGlzIHBvcnQgbmVlZHMgdGhlIG5ldyBSZWdFeHAgZnVuY3Rpb25hbGl0eSBvZiBFQ01BIDI2MiwKLy8gM3JkIEVkaXRpb24gKGkuZS4gSmF2YXNjcmlwdCAxLjUpLiAgTW9zdCBtb2Rlcm4gd2ViIGJyb3dzZXJzCi8vIHNob3VsZCBkbyBmaW5lLiAgRXZlbiB3aXRoIHRoZSBuZXcgcmVndWxhciBleHByZXNzaW9uIGZlYXR1cmVzLAovLyBXZSBkbyBhIGxvdCBvZiB3b3JrIHRvIGVtdWxhdGUgUGVybCdzIHJlZ2V4IGZ1bmN0aW9uYWxpdHkuCi8vIFRoZSB0cmlja3kgY2hhbmdlcyBpbiB0aGlzIGZpbGUgbW9zdGx5IGhhdmUgdGhlICJhdHRhY2tsYWI6IgovLyBsYWJlbC4gIE1ham9yIG9yIHNlbGYtZXhwbGFuYXRvcnkgY2hhbmdlcyBkb24ndC4KLy8KLy8gU21hcnQgZGlmZiB0b29scyBsaWtlIEFyYXhpcyBNZXJnZSB3aWxsIGJlIGFibGUgdG8gbWF0Y2ggdXAKLy8gdGhpcyBmaWxlIHdpdGggbWFya2Rvd24ucGwgaW4gYSB1c2VmdWwgd2F5LiAgQSBsaXR0bGUgdHdlYWtpbmcKLy8gaGVscHM6IGluIGEgY29weSBvZiBtYXJrZG93bi5wbCwgcmVwbGFjZSAiIyIgd2l0aCAiLy8iIGFuZAovLyByZXBsYWNlICIkdGV4dCIgd2l0aCAidGV4dCIuICBCZSBzdXJlIHRvIGlnbm9yZSB3aGl0ZXNwYWNlCi8vIGFuZCBsaW5lIGVuZGluZ3MuCi8vCi8vCi8vIFNob3dkb3duIHVzYWdlOgovLwovLyAgIHZhciB0ZXh0ID0gIk1hcmtkb3duICpyb2NrcyouIjsKLy8KLy8gICB2YXIgY29udmVydGVyID0gbmV3IFNob3dkb3duLmNvbnZlcnRlcigpOwovLyAgIHZhciBodG1sID0gY29udmVydGVyLm1ha2VIdG1sKHRleHQpOwovLwovLyAgIGFsZXJ0KGh0bWwpOwovLwovLyBOb3RlOiBtb3ZlIHRoZSBzYW1wbGUgY29kZSB0byB0aGUgYm90dG9tIG9mIHRoaXMKLy8gZmlsZSBiZWZvcmUgdW5jb21tZW50aW5nIGl0LgovLwovLwovLyBTaG93ZG93biBuYW1lc3BhY2UKLy8KdmFyIFNob3dkb3duPXt9O1Nob3dkb3duLmNvbnZlcnRlcj1mdW5jdGlvbigpe3ZhciBhLGIsYyxkPTA7dGhpcy5tYWtlSHRtbD1mdW5jdGlvbihkKXtyZXR1cm4gYT1uZXcgQXJyYXksYj1uZXcgQXJyYXksYz1uZXcgQXJyYXksZD1kLnJlcGxhY2UoL34vZywiflQiKSxkPWQucmVwbGFjZSgvXCQvZywifkQiKSxkPWQucmVwbGFjZSgvXHJcbi9nLCJcbiIpLGQ9ZC5yZXBsYWNlKC9cci9nLCJcbiIpLGQ9IlxuXG4iK2QrIlxuXG4iLGQ9RihkKSxkPWQucmVwbGFjZSgvXlsgXHRdKyQvbWcsIiIpLGQ9ZihkKSxkPWUoZCksZD1oKGQpLGQ9RChkKSxkPWQucmVwbGFjZSgvfkQvZywiJCQiKSxkPWQucmVwbGFjZSgvflQvZywifiIpLGR9O3ZhciBlPWZ1bmN0aW9uKGMpe3ZhciBjPWMucmVwbGFjZSgvXlsgXXswLDN9XFsoLispXF06WyBcdF0qXG4/WyBcdF0qPD8oXFMrPyk+P1sgXHRdKlxuP1sgXHRdKig/OihcbiopWyIoXSguKz8pWyIpXVsgXHRdKik/KD86XG4rfFxaKS9nbSxmdW5jdGlvbihjLGQsZSxmLGcpe3JldHVybiBkPWQudG9Mb3dlckNhc2UoKSxhW2RdPXooZSksZj9mK2c6KGcmJihiW2RdPWcucmVwbGFjZSgvIi9nLCImcXVvdDsiKSksIiIpfSk7cmV0dXJuIGN9LGY9ZnVuY3Rpb24oYSl7YT1hLnJlcGxhY2UoL1xuL2csIlxuXG4iKTt2YXIgYj0icHxkaXZ8aFsxLTZdfGJsb2NrcXVvdGV8cHJlfHRhYmxlfGRsfG9sfHVsfHNjcmlwdHxub3NjcmlwdHxmb3JtfGZpZWxkc2V0fGlmcmFtZXxtYXRofGluc3xkZWwiLGM9InB8ZGl2fGhbMS02XXxibG9ja3F1b3RlfHByZXx0YWJsZXxkbHxvbHx1bHxzY3JpcHR8bm9zY3JpcHR8Zm9ybXxmaWVsZHNldHxpZnJhbWV8bWF0aCI7cmV0dXJuIGE9YS5yZXBsYWNlKC9eKDwocHxkaXZ8aFsxLTZdfGJsb2NrcXVvdGV8cHJlfHRhYmxlfGRsfG9sfHVsfHNjcmlwdHxub3NjcmlwdHxmb3JtfGZpZWxkc2V0fGlmcmFtZXxtYXRofGluc3xkZWwpXGJbXlxyXSo/XG48XC9cMj5bIFx0XSooPz1cbispKS9nbSxnKSxhPWEucmVwbGFjZSgvXig8KHB8ZGl2fGhbMS02XXxibG9ja3F1b3RlfHByZXx0YWJsZXxkbHxvbHx1bHxzY3JpcHR8bm9zY3JpcHR8Zm9ybXxmaWVsZHNldHxpZnJhbWV8bWF0aClcYlteXHJdKj8uKjxcL1wyPlsgXHRdKig/PVxuKylcbikvZ20sZyksYT1hLnJlcGxhY2UoLyhcblsgXXswLDN9KDwoaHIpXGIoW148Pl0pKj9cLz8+KVsgXHRdKig/PVxuezIsfSkpL2csZyksYT1hLnJlcGxhY2UoLyhcblxuWyBdezAsM308ISgtLVteXHJdKj8tLVxzKikrPlsgXHRdKig/PVxuezIsfSkpL2csZyksYT1hLnJlcGxhY2UoLyg/OlxuXG4pKFsgXXswLDN9KD86PChbPyVdKVteXHJdKj9cMj4pWyBcdF0qKD89XG57Mix9KSkvZyxnKSxhPWEucmVwbGFjZSgvXG5cbi9nLCJcbiIpLGF9LGc9ZnVuY3Rpb24oYSxiKXt2YXIgZD1iO3JldHVybiBkPWQucmVwbGFjZSgvXG5cbi9nLCJcbiIpLGQ9ZC5yZXBsYWNlKC9eXG4vLCIiKSxkPWQucmVwbGFjZSgvXG4rJC9nLCIiKSxkPSJcblxufksiKyhjLnB1c2goZCktMSkrIktcblxuIixkfSxoPWZ1bmN0aW9uKGEpe2E9byhhKTt2YXIgYj10KCI8aHIgLz4iKTtyZXR1cm4gYT1hLnJlcGxhY2UoL15bIF17MCwyfShbIF0/XCpbIF0/KXszLH1bIFx0XSokL2dtLGIpLGE9YS5yZXBsYWNlKC9eWyBdezAsMn0oWyBdP1wtWyBdPyl7Myx9WyBcdF0qJC9nbSxiKSxhPWEucmVwbGFjZSgvXlsgXXswLDJ9KFsgXT9cX1sgXT8pezMsfVsgXHRdKiQvZ20sYiksYT1xKGEpLGE9cyhhKSxhPXIoYSksYT14KGEpLGE9ZihhKSxhPXkoYSksYX0saT1mdW5jdGlvbihhKXtyZXR1cm4gYT11KGEpLGE9aihhKSxhPUEoYSksYT1tKGEpLGE9ayhhKSxhPUIoYSksYT16KGEpLGE9dyhhKSxhPWEucmVwbGFjZSgvICArXG4vZywiIDxiciAvPlxuIiksYX0saj1mdW5jdGlvbihhKXt2YXIgYj0vKDxbYS16XC8hJF0oIlteIl0qInwnW14nXSonfFteJyI+XSkqPnw8ISgtLS4qPy0tXHMqKSs+KS9naTtyZXR1cm4gYT1hLnJlcGxhY2UoYixmdW5jdGlvbihhKXt2YXIgYj1hLnJlcGxhY2UoLyguKTxcLz9jb2RlPig/PS4pL2csIiQxYCIpO3JldHVybiBiPUcoYiwiXFxgKl8iKSxifSksYX0saz1mdW5jdGlvbihhKXtyZXR1cm4gYT1hLnJlcGxhY2UoLyhcWygoPzpcW1teXF1dKlxdfFteXFtcXV0pKilcXVsgXT8oPzpcblsgXSopP1xbKC4qPylcXSkoKSgpKCkoKS9nLGwpLGE9YS5yZXBsYWNlKC8oXFsoKD86XFtbXlxdXSpcXXxbXlxbXF1dKSopXF1cKFsgXHRdKigpPD8oLio/KT4/WyBcdF0qKChbJyJdKSguKj8pXDZbIFx0XSopP1wpKS9nLGwpLGE9YS5yZXBsYWNlKC8oXFsoW15cW1xdXSspXF0pKCkoKSgpKCkoKS9nLGwpLGF9LGw9ZnVuY3Rpb24oYyxkLGUsZixnLGgsaSxqKXtqPT11bmRlZmluZWQmJihqPSIiKTt2YXIgaz1kLGw9ZSxtPWYudG9Mb3dlckNhc2UoKSxuPWcsbz1qO2lmKG49PSIiKXttPT0iIiYmKG09bC50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoLyA/XG4vZywiICIpKSxuPSIjIittO2lmKGFbbV0hPXVuZGVmaW5lZCluPWFbbV0sYlttXSE9dW5kZWZpbmVkJiYobz1iW21dKTtlbHNle2lmKCEoay5zZWFyY2goL1woXHMqXCkkL20pPi0xKSlyZXR1cm4gaztuPSIifX1uPUcobiwiKl8iKTt2YXIgcD0nPGEgaHJlZj0iJytuKyciJztyZXR1cm4gbyE9IiImJihvPW8ucmVwbGFjZSgvIi9nLCImcXVvdDsiKSxvPUcobywiKl8iKSxwKz0nIHRpdGxlPSInK28rJyInKSxwKz0iPiIrbCsiPC9hPiIscH0sbT1mdW5jdGlvbihhKXtyZXR1cm4gYT1hLnJlcGxhY2UoLyghXFsoLio/KVxdWyBdPyg/OlxuWyBdKik/XFsoLio/KVxdKSgpKCkoKSgpL2csbiksYT1hLnJlcGxhY2UoLyghXFsoLio/KVxdXHM/XChbIFx0XSooKTw/KFxTKz8pPj9bIFx0XSooKFsnIl0pKC4qPylcNlsgXHRdKik/XCkpL2csbiksYX0sbj1mdW5jdGlvbihjLGQsZSxmLGcsaCxpLGope3ZhciBrPWQsbD1lLG09Zi50b0xvd2VyQ2FzZSgpLG49ZyxvPWo7b3x8KG89IiIpO2lmKG49PSIiKXttPT0iIiYmKG09bC50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoLyA/XG4vZywiICIpKSxuPSIjIittO2lmKGFbbV09PXVuZGVmaW5lZClyZXR1cm4gaztuPWFbbV0sYlttXSE9dW5kZWZpbmVkJiYobz1iW21dKX1sPWwucmVwbGFjZSgvIi9nLCImcXVvdDsiKSxuPUcobiwiKl8iKTt2YXIgcD0nPGltZyBzcmM9IicrbisnIiBhbHQ9IicrbCsnIic7cmV0dXJuIG89by5yZXBsYWNlKC8iL2csIiZxdW90OyIpLG89RyhvLCIqXyIpLHArPScgdGl0bGU9IicrbysnIicscCs9IiAvPiIscH0sbz1mdW5jdGlvbihhKXtmdW5jdGlvbiBiKGEpe3JldHVybiBhLnJlcGxhY2UoL1teXHddL2csIiIpLnRvTG93ZXJDYXNlKCl9cmV0dXJuIGE9YS5yZXBsYWNlKC9eKC4rKVsgXHRdKlxuPStbIFx0XSpcbisvZ20sZnVuY3Rpb24oYSxjKXtyZXR1cm4gdCgnPGgxIGlkPSInK2IoYykrJyI+JytpKGMpKyI8L2gxPiIpfSksYT1hLnJlcGxhY2UoL14oLispWyBcdF0qXG4tK1sgXHRdKlxuKy9nbSxmdW5jdGlvbihhLGMpe3JldHVybiB0KCc8aDIgaWQ9IicrYihjKSsnIj4nK2koYykrIjwvaDI+Iil9KSxhPWEucmVwbGFjZSgvXihcI3sxLDZ9KVsgXHRdKiguKz8pWyBcdF0qXCMqXG4rL2dtLGZ1bmN0aW9uKGEsYyxkKXt2YXIgZT1jLmxlbmd0aDtyZXR1cm4gdCgiPGgiK2UrJyBpZD0iJytiKGQpKyciPicraShkKSsiPC9oIitlKyI+Iil9KSxhfSxwLHE9ZnVuY3Rpb24oYSl7YSs9In4wIjt2YXIgYj0vXigoWyBdezAsM30oWyorLV18XGQrWy5dKVsgXHRdKylbXlxyXSs/KH4wfFxuezIsfSg/PVxTKSg/IVsgXHRdKig/OlsqKy1dfFxkK1suXSlbIFx0XSspKSkvZ207cmV0dXJuIGQ/YT1hLnJlcGxhY2UoYixmdW5jdGlvbihhLGIsYyl7dmFyIGQ9YixlPWMuc2VhcmNoKC9bKistXS9nKT4tMT8idWwiOiJvbCI7ZD1kLnJlcGxhY2UoL1xuezIsfS9nLCJcblxuXG4iKTt2YXIgZj1wKGQpO3JldHVybiBmPWYucmVwbGFjZSgvXHMrJC8sIiIpLGY9IjwiK2UrIj4iK2YrIjwvIitlKyI+XG4iLGZ9KTooYj0vKFxuXG58XlxuPykoKFsgXXswLDN9KFsqKy1dfFxkK1suXSlbIFx0XSspW15ccl0rPyh+MHxcbnsyLH0oPz1cUykoPyFbIFx0XSooPzpbKistXXxcZCtbLl0pWyBcdF0rKSkpL2csYT1hLnJlcGxhY2UoYixmdW5jdGlvbihhLGIsYyxkKXt2YXIgZT1iLGY9YyxnPWQuc2VhcmNoKC9bKistXS9nKT4tMT8idWwiOiJvbCIsZj1mLnJlcGxhY2UoL1xuezIsfS9nLCJcblxuXG4iKSxoPXAoZik7cmV0dXJuIGg9ZSsiPCIrZysiPlxuIitoKyI8LyIrZysiPlxuIixofSkpLGE9YS5yZXBsYWNlKC9+MC8sIiIpLGF9O3A9ZnVuY3Rpb24oYSl7cmV0dXJuIGQrKyxhPWEucmVwbGFjZSgvXG57Mix9JC8sIlxuIiksYSs9In4wIixhPWEucmVwbGFjZSgvKFxuKT8oXlsgXHRdKikoWyorLV18XGQrWy5dKVsgXHRdKyhbXlxyXSs/KFxuezEsMn0pKSg/PVxuKih+MHxcMihbKistXXxcZCtbLl0pWyBcdF0rKSkvZ20sZnVuY3Rpb24oYSxiLGMsZCxlKXt2YXIgZj1lLGc9YixqPWM7cmV0dXJuIGd8fGYuc2VhcmNoKC9cbnsyLH0vKT4tMT9mPWgoRShmKSk6KGY9cShFKGYpKSxmPWYucmVwbGFjZSgvXG4kLywiIiksZj1pKGYpKSwiPGxpPiIrZisiPC9saT5cbiJ9KSxhPWEucmVwbGFjZSgvfjAvZywiIiksZC0tLGF9O3ZhciByPWZ1bmN0aW9uKGEpe3JldHVybiBhKz0ifjAiLGE9YS5yZXBsYWNlKC8oPzpcblxufF4pKCg/Oig/OlsgXXs0fXxcdCkuKlxuKykrKShcbipbIF17MCwzfVteIFx0XG5dfCg/PX4wKSkvZyxmdW5jdGlvbihhLGIsYyl7dmFyIGQ9YixlPWM7cmV0dXJuIGQ9dihFKGQpKSxkPUYoZCksZD1kLnJlcGxhY2UoL15cbisvZywiIiksZD1kLnJlcGxhY2UoL1xuKyQvZywiIiksZD0iPHByZT48Y29kZT4iK2QrIlxuPC9jb2RlPjwvcHJlPiIsdChkKStlfSksYT1hLnJlcGxhY2UoL34wLywiIiksYX0scz1mdW5jdGlvbihhKXtyZXR1cm4gYSs9In4wIixhPWEucmVwbGFjZSgvXG5gYGAoLiopXG4oW15gXSspXG5gYGAvZyxmdW5jdGlvbihhLGIsYyl7dmFyIGQ9YixlPWM7cmV0dXJuIGU9dihlKSxlPUYoZSksZT1lLnJlcGxhY2UoL15cbisvZywiIiksZT1lLnJlcGxhY2UoL1xuKyQvZywiIiksZT0iPHByZT48Y29kZSBjbGFzcz0iK2QrIj4iK2UrIlxuPC9jb2RlPjwvcHJlPiIsdChlKX0pLGE9YS5yZXBsYWNlKC9+MC8sIiIpLGF9LHQ9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC8oXlxuK3xcbiskKS9nLCIiKSwiXG5cbn5LIisoYy5wdXNoKGEpLTEpKyJLXG5cbiJ9LHU9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC8oXnxbXlxcXSkoYCspKFteXHJdKj9bXmBdKVwyKD8hYCkvZ20sZnVuY3Rpb24oYSxiLGMsZCxlKXt2YXIgZj1kO3JldHVybiBmPWYucmVwbGFjZSgvXihbIFx0XSopL2csIiIpLGY9Zi5yZXBsYWNlKC9bIFx0XSokL2csIiIpLGY9dihmKSxiKyI8Y29kZT4iK2YrIjwvY29kZT4ifSksYX0sdj1mdW5jdGlvbihhKXtyZXR1cm4gYT1hLnJlcGxhY2UoLyYvZywiJmFtcDsiKSxhPWEucmVwbGFjZSgvPC9nLCImbHQ7IiksYT1hLnJlcGxhY2UoLz4vZywiJmd0OyIpLGE9RyhhLCIqX3t9W11cXCIsITEpLGF9LHc9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC8oXCpcKnxfXykoPz1cUykoW15ccl0qP1xTWypfXSopXDEvZywiPHN0cm9uZz4kMjwvc3Ryb25nPiIpLGE9YS5yZXBsYWNlKC8oXCp8XykoPz1cUykoW15ccl0qP1xTKVwxL2csIjxlbT4kMjwvZW0+IiksYX0seD1mdW5jdGlvbihhKXtyZXR1cm4gYT1hLnJlcGxhY2UoLygoXlsgXHRdKj5bIFx0XT8uK1xuKC4rXG4pKlxuKikrKS9nbSxmdW5jdGlvbihhLGIpe3ZhciBjPWI7cmV0dXJuIGM9Yy5yZXBsYWNlKC9eWyBcdF0qPlsgXHRdPy9nbSwifjAiKSxjPWMucmVwbGFjZSgvfjAvZywiIiksYz1jLnJlcGxhY2UoL15bIFx0XSskL2dtLCIiKSxjPWgoYyksYz1jLnJlcGxhY2UoLyhefFxuKS9nLCIkMSAgIiksYz1jLnJlcGxhY2UoLyhccyo8cHJlPlteXHJdKz88XC9wcmU+KS9nbSxmdW5jdGlvbihhLGIpe3ZhciBjPWI7cmV0dXJuIGM9Yy5yZXBsYWNlKC9eICAvbWcsIn4wIiksYz1jLnJlcGxhY2UoL34wL2csIiIpLGN9KSx0KCI8YmxvY2txdW90ZT5cbiIrYysiXG48L2Jsb2NrcXVvdGU+Iil9KSxhfSx5PWZ1bmN0aW9uKGEpe2E9YS5yZXBsYWNlKC9eXG4rL2csIiIpLGE9YS5yZXBsYWNlKC9cbiskL2csIiIpO3ZhciBiPWEuc3BsaXQoL1xuezIsfS9nKSxkPW5ldyBBcnJheSxlPWIubGVuZ3RoO2Zvcih2YXIgZj0wO2Y8ZTtmKyspe3ZhciBnPWJbZl07Zy5zZWFyY2goL35LKFxkKylLL2cpPj0wP2QucHVzaChnKTpnLnNlYXJjaCgvXFMvKT49MCYmKGc9aShnKSxnPWcucmVwbGFjZSgvXihbIFx0XSopL2csIjxwPiIpLGcrPSI8L3A+IixkLnB1c2goZykpfWU9ZC5sZW5ndGg7Zm9yKHZhciBmPTA7ZjxlO2YrKyl3aGlsZShkW2ZdLnNlYXJjaCgvfksoXGQrKUsvKT49MCl7dmFyIGg9Y1tSZWdFeHAuJDFdO2g9aC5yZXBsYWNlKC9cJC9nLCIkJCQkIiksZFtmXT1kW2ZdLnJlcGxhY2UoL35LXGQrSy8saCl9cmV0dXJuIGQuam9pbigiXG5cbiIpfSx6PWZ1bmN0aW9uKGEpe3JldHVybiBhPWEucmVwbGFjZSgvJig/ISM/W3hYXT8oPzpbMC05YS1mQS1GXSt8XHcrKTspL2csIiZhbXA7IiksYT1hLnJlcGxhY2UoLzwoPyFbYS16XC8/XCQhXSkvZ2ksIiZsdDsiKSxhfSxBPWZ1bmN0aW9uKGEpe3JldHVybiBhPWEucmVwbGFjZSgvXFwoXFwpL2csSCksYT1hLnJlcGxhY2UoL1xcKFtgKl97fVxbXF0oKT4jKy0uIV0pL2csSCksYX0sQj1mdW5jdGlvbihhKXtyZXR1cm4gYT1hLnJlcGxhY2UoLzwoKGh0dHBzP3xmdHB8ZGljdCk6W14nIj5cc10rKT4vZ2ksJzxhIGhyZWY9IiQxIj4kMTwvYT4nKSxhPWEucmVwbGFjZSgvPCg/Om1haWx0bzopPyhbLS5cd10rXEBbLWEtejAtOV0rKFwuWy1hLXowLTldKykqXC5bYS16XSspPi9naSxmdW5jdGlvbihhLGIpe3JldHVybiBDKEQoYikpfSksYX0sQz1mdW5jdGlvbihhKXtmdW5jdGlvbiBiKGEpe3ZhciBiPSIwMTIzNDU2Nzg5QUJDREVGIixjPWEuY2hhckNvZGVBdCgwKTtyZXR1cm4gYi5jaGFyQXQoYz4+NCkrYi5jaGFyQXQoYyYxNSl9dmFyIGM9W2Z1bmN0aW9uKGEpe3JldHVybiImIyIrYS5jaGFyQ29kZUF0KDApKyI7In0sZnVuY3Rpb24oYSl7cmV0dXJuIiYjeCIrYihhKSsiOyJ9LGZ1bmN0aW9uKGEpe3JldHVybiBhfV07cmV0dXJuIGE9Im1haWx0bzoiK2EsYT1hLnJlcGxhY2UoLy4vZyxmdW5jdGlvbihhKXtpZihhPT0iQCIpYT1jW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSoyKV0oYSk7ZWxzZSBpZihhIT0iOiIpe3ZhciBiPU1hdGgucmFuZG9tKCk7YT1iPi45P2NbMl0oYSk6Yj4uNDU/Y1sxXShhKTpjWzBdKGEpfXJldHVybiBhfSksYT0nPGEgaHJlZj0iJythKyciPicrYSsiPC9hPiIsYT1hLnJlcGxhY2UoLyI+Lis6L2csJyI+JyksYX0sRD1mdW5jdGlvbihhKXtyZXR1cm4gYT1hLnJlcGxhY2UoL35FKFxkKylFL2csZnVuY3Rpb24oYSxiKXt2YXIgYz1wYXJzZUludChiKTtyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShjKX0pLGF9LEU9ZnVuY3Rpb24oYSl7cmV0dXJuIGE9YS5yZXBsYWNlKC9eKFx0fFsgXXsxLDR9KS9nbSwifjAiKSxhPWEucmVwbGFjZSgvfjAvZywiIiksYX0sRj1mdW5jdGlvbihhKXtyZXR1cm4gYT1hLnJlcGxhY2UoL1x0KD89XHQpL2csIiAgICAiKSxhPWEucmVwbGFjZSgvXHQvZywifkF+QiIpLGE9YS5yZXBsYWNlKC9+QiguKz8pfkEvZyxmdW5jdGlvbihhLGIsYyl7dmFyIGQ9YixlPTQtZC5sZW5ndGglNDtmb3IodmFyIGY9MDtmPGU7ZisrKWQrPSIgIjtyZXR1cm4gZH0pLGE9YS5yZXBsYWNlKC9+QS9nLCIgICAgIiksYT1hLnJlcGxhY2UoL35CL2csIiIpLGF9LEc9ZnVuY3Rpb24oYSxiLGMpe3ZhciBkPSIoWyIrYi5yZXBsYWNlKC8oW1xbXF1cXF0pL2csIlxcJDEiKSsiXSkiO2MmJihkPSJcXFxcIitkKTt2YXIgZT1uZXcgUmVnRXhwKGQsImciKTtyZXR1cm4gYT1hLnJlcGxhY2UoZSxIKSxhfSxIPWZ1bmN0aW9uKGEsYil7dmFyIGM9Yi5jaGFyQ29kZUF0KDApO3JldHVybiJ+RSIrYysiRSJ9fSx0eXBlb2YgZXhwb3J0cyE9InVuZGVmaW5lZCImJihleHBvcnRzPVNob3dkb3duKTsKZGVmaW5lKCJzaG93ZG93biIsIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBnbG9iYWwuU2hvd2Rvd247CiAgICB9Cn0odGhpcykpKTsKCmRlZmluZSgnbWFpbicsWyd0aHJ1c3QnLCAnanF1ZXJ5JywgJ3Nob3dkb3duJ10sCmZ1bmN0aW9uKFRocnVzdCwgJCwgU2hvd2Rvd24pCnsKICAgIHZhciBjb252ZXJ0ZXIgPSBuZXcgU2hvd2Rvd24uY29udmVydGVyKCk7CiAgICAkKGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgJChkb2N1bWVudC5ib2R5KS5kZWxlZ2F0ZSgnYVtyZWw9cG9wb3Zlcl0nLCAnbW91c2VvdmVyJywgZnVuY3Rpb24gKGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpOwogICAgICAgICAgICBpZiAoISR0aGlzLmRhdGEoJ3BvcG92ZXInKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSAkdGhpcy5kYXRhKCdjb250ZW50Jyk7CiAgICAgICAgICAgICAgICBjb250ZW50ID0gY29udmVydGVyLm1ha2VIdG1sKGNvbnRlbnQucmVwbGFjZSgvXFxuL2csICdcbicpKTsKICAgICAgICAgICAgICAgICR0aGlzLmF0dHIoJ2RhdGEtY29udGVudCcsIGNvbnRlbnQpOwogICAgICAgICAgICAgICAgaWYgKCEkdGhpcy5hdHRyKCd0aXRsZScpKQogICAgICAgICAgICAgICAgICAgICR0aGlzLmF0dHIoJ3RpdGxlJywgJHRoaXMudGV4dCgpKTsKICAgICAgICAgICAgICAgICQodGhpcykucG9wb3ZlcigpLnBvcG92ZXIoJ3Nob3cnKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAkKGRvY3VtZW50LmJvZHkpLmRlbGVnYXRlKCdhW3JlbD1wb3BvdmVyXScsICdjbGljaycsIGZ1bmN0aW9uIChlKQogICAgICAgIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgfSk7CiAgICB9KTsKCiAgICBUaHJ1c3QubGF1bmNoKCk7Cn0pOwovKiogQGxpY2Vuc2UgTUlUIExpY2Vuc2UgKGMpIGNvcHlyaWdodCBCIENhdmFsaWVyICYgSiBIYW5uICovCgovKioKICogYW9wCiAqIEFzcGVjdCBPcmllbnRlZCBQcm9ncmFtbWluZyBmb3IgSmF2YXNjcmlwdAogKgogKiBhb3AgaXMgcGFydCBvZiB0aGUgY3Vqby5qcyBmYW1pbHkgb2YgbGlicmFyaWVzIChodHRwOi8vY3Vqb2pzLmNvbS8pCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZSBhdDoKICogaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICoKICogQHZlcnNpb24gMC41LjMKICovCihmdW5jdGlvbiAoZGVmaW5lKSB7CmRlZmluZSgnYW9wJyxbXSxmdW5jdGlvbiAoKSB7CgoJdmFyIGFwLCBwcmVwZW5kLCBhcHBlbmQsIHNsaWNlLCBpc0FycmF5LCBmcmVlemU7CgoJZnJlZXplID0gT2JqZWN0LmZyZWV6ZSB8fCBmdW5jdGlvbiAobykgeyByZXR1cm4gbzsgfTsKCglhcCAgICAgID0gQXJyYXkucHJvdG90eXBlOwoJcHJlcGVuZCA9IGFwLnVuc2hpZnQ7CglhcHBlbmQgID0gYXAucHVzaDsKCXNsaWNlICAgPSBhcC5zbGljZTsKCglpc0FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbihpdCkgewoJCXJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaXQpID09ICdbb2JqZWN0IEFycmF5XSc7Cgl9OwoKCS8qKgoJICogSGVscGVyIHRvIGNvbnZlcnQgYXJndW1lbnRzIHRvIGFuIGFycmF5CgkgKiBAcGFyYW0gYSB7QXJndW1lbnRzfSBhcmd1bWVudHMKCSAqIEByZXR1cm4ge0FycmF5fQoJICovCglmdW5jdGlvbiBhcmdzVG9BcnJheShhKSB7CgkJcmV0dXJuIHNsaWNlLmNhbGwoYSk7Cgl9CgoJZnVuY3Rpb24gZm9yRWFjaChhcnJheSwgZnVuYykgewoJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBhcnJheS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewoJCQlmdW5jKGFycmF5W2ldKTsKCQl9Cgl9CgoJZnVuY3Rpb24gZm9yRWFjaFJldmVyc2UoYXJyYXksIGZ1bmMpIHsKCQlmb3IgKHZhciBpID0gYXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKCQkJZnVuYyhhcnJheVtpXSk7CgkJfQoJfQoKCXZhciBpdGVyYXRvcnMgPSB7CgkJICAgLy8gQmVmb3JlIHVzZXMgcmV2ZXJzZSBpdGVyYXRpb24KCQkgICBiZWZvcmU6IGZvckVhY2hSZXZlcnNlCgkgICB9OwoKCS8vIEFsbCBvdGhlciBhZHZpY2UgdHlwZXMgdXNlIGZvcndhcmQgaXRlcmF0aW9uCgkvLyBBcm91bmQgaXMgYSBzcGVjaWFsIGNhc2UgdGhhdCB1c2VzIHJlY3Vyc2lvbiByYXRoZXIgdGhhbgoJLy8gaXRlcmF0aW9uLiAgU2VlIEFkdmlzb3IuX2NhbGxBcm91bmRBZHZpY2UKCWl0ZXJhdG9ycy5vbgoJCT0gaXRlcmF0b3JzLmFmdGVyUmV0dXJuaW5nCgkJPSBpdGVyYXRvcnMuYWZ0ZXJUaHJvd2luZwoJCT0gaXRlcmF0b3JzLmFmdGVyCgkJPSBmb3JFYWNoOwoKCWZ1bmN0aW9uIHByb2NlZWRBbHJlYWR5Q2FsbGVkKCkgeyB0aHJvdyBuZXcgRXJyb3IoInByb2NlZWQoKSBtYXkgb25seSBiZSBjYWxsZWQgb25jZSIpOyB9CgoJZnVuY3Rpb24gQWR2aXNvcih0YXJnZXQsIGZ1bmMpIHsKCgkJdmFyIG9yaWcsIGFkdmlzb3IsIGFkdmlzZWQ7CgoJCXRoaXMudGFyZ2V0ID0gdGFyZ2V0OwoJCXRoaXMuZnVuYyA9IGZ1bmM7CgkJICAgdGhpcy5hc3BlY3RzID0gW107CgoJCW9yaWcgPSB0aGlzLm9yaWcgPSB0YXJnZXRbZnVuY107CgkJYWR2aXNvciA9IHRoaXM7CgoJCWFkdmlzZWQgPSB0aGlzLmFkdmlzZWQgPSBmdW5jdGlvbigpIHsKCQkJdmFyIGNvbnRleHQsIGFyZ3MsIHJlc3VsdCwgYWZ0ZXJUeXBlLCBleGNlcHRpb247CgoJCQkgICBjb250ZXh0ID0gdGhpczsKCgkJCWZ1bmN0aW9uIGNhbGxPcmlnKGFyZ3MpIHsKCQkJCXZhciByZXN1bHQgPSBvcmlnLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwoJCQkJYWR2aXNvci5fY2FsbFNpbXBsZUFkdmljZSgnb24nLCBjb250ZXh0LCBhcmdzKTsKCgkJCQlyZXR1cm4gcmVzdWx0OwoJCQl9CgoJCQlmdW5jdGlvbiBjYWxsQWZ0ZXIoYWZ0ZXJUeXBlLCBhcmdzKSB7CgkJCQlhZHZpc29yLl9jYWxsU2ltcGxlQWR2aWNlKGFmdGVyVHlwZSwgY29udGV4dCwgYXJncyk7CgkJCX0KCgkJCWFyZ3MgPSBhcmdzVG9BcnJheShhcmd1bWVudHMpOwoJCQlhZnRlclR5cGUgPSAnYWZ0ZXJSZXR1cm5pbmcnOwoKCQkJYWR2aXNvci5fY2FsbFNpbXBsZUFkdmljZSgnYmVmb3JlJywgY29udGV4dCwgYXJncyk7CgoJCQl0cnkgewoJCQkJcmVzdWx0ID0gYWR2aXNvci5fY2FsbEFyb3VuZEFkdmljZShjb250ZXh0LCBmdW5jLCBhcmdzLCBjYWxsT3JpZyk7CgkJCX0gY2F0Y2goZSkgewoJCQkJcmVzdWx0ID0gZXhjZXB0aW9uID0gZTsKCQkJCSAgIC8vIFN3aXRjaCB0byBhZnRlclRocm93aW5nCgkJCQlhZnRlclR5cGUgPSAnYWZ0ZXJUaHJvd2luZyc7CgkJCSAgIH0KCgkJCWFyZ3MgPSBbcmVzdWx0XTsKCgkJCWNhbGxBZnRlcihhZnRlclR5cGUsIGFyZ3MpOwoJCQljYWxsQWZ0ZXIoJ2FmdGVyJywgYXJncyk7CgoJCQlpZihleGNlcHRpb24pIHsKCQkJCXRocm93IGV4Y2VwdGlvbjsKCQkJfQoKCQkJcmV0dXJuIHJlc3VsdDsKCQl9OwoKCQlhZHZpc2VkLl9hZHZpc29yID0gdGhpczsKCX0KCglBZHZpc29yLnByb3RvdHlwZSA9IHsKCgkJICAgLyoqCgkJCSogSW52b2tlIGFsbCBhZHZpY2UgZnVuY3Rpb25zIGluIHRoZSBzdXBwbGllZCBjb250ZXh0LCB3aXRoIHRoZSBzdXBwbGllZCBhcmdzCgkJCSoKCQkJKiBAcGFyYW0gYWR2aWNlVHlwZQoJCQkqIEBwYXJhbSBjb250ZXh0CgkJCSogQHBhcmFtIGFyZ3MKCQkJKi8KCQlfY2FsbFNpbXBsZUFkdmljZTogZnVuY3Rpb24oYWR2aWNlVHlwZSwgY29udGV4dCwgYXJncykgewoKCQkJLy8gYmVmb3JlIGFkdmljZSBydW5zIExJRk8sIGZyb20gbW9zdC1yZWNlbnRseSBhZGRlZCB0byBsZWFzdC1yZWNlbnRseSBhZGRlZC4KCQkJLy8gQWxsIG90aGVyIGFkdmljZSBpcyBGSUZPCgkJCXZhciBpdGVyYXRvciA9IGl0ZXJhdG9yc1thZHZpY2VUeXBlXTsKCgkJCSAgIGl0ZXJhdG9yKHRoaXMuYXNwZWN0cywgZnVuY3Rpb24oYXNwZWN0KSB7CgkJCQkgICB2YXIgYWR2aWNlID0gYXNwZWN0W2FkdmljZVR5cGVdOwoJCQkJICAgYWR2aWNlICYmIGFkdmljZS5hcHBseShjb250ZXh0LCBhcmdzKTsKCQkJICAgfSk7CgkJfSwKCgkJLyoqCgkJICogSW52b2tlIGFsbCBhcm91bmQgYWR2aWNlIGFuZCB0aGVuIHRoZSBvcmlnaW5hbCBtZXRob2QKCQkgKgoJCSAqIEBwYXJhbSBjb250ZXh0CgkJICogQHBhcmFtIG1ldGhvZAoJCSAqIEBwYXJhbSBhcmdzCgkJICogQHBhcmFtIG9yaWcKCQkgKi8KCQlfY2FsbEFyb3VuZEFkdmljZTogZnVuY3Rpb24gKGNvbnRleHQsIG1ldGhvZCwgYXJncywgb3JpZykgewoJCQl2YXIgbGVuLCBhc3BlY3RzOwoKCQkJYXNwZWN0cyA9IHRoaXMuYXNwZWN0czsKCQkJbGVuID0gYXNwZWN0cy5sZW5ndGg7CgoJCQkvKioKCQkJICogQ2FsbCB0aGUgbmV4dCBmdW5jdGlvbiBpbiB0aGUgYXJvdW5kIGNoYWluLCB3aGljaCB3aWxsIGVpdGhlciBiZSBhbm90aGVyIGFyb3VuZAoJCQkgKiBhZHZpY2UsIG9yIHRoZSBvcmlnIG1ldGhvZC4KCQkJICogQHBhcmFtIGkge051bWJlcn0gaW5kZXggb2YgdGhlIGFyb3VuZCBhZHZpY2UKCQkJICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcmd1bWVudHMgd2l0aCB3aXRoIHRvIGNhbGwgdGhlIG5leHQgYXJvdW5kIGFkdmljZQoJCQkgKi8KCQkJZnVuY3Rpb24gY2FsbE5leHQoaSwgYXJncykgewoJCQkJdmFyIGFzcGVjdDsKCQkJCS8vIFNraXAgdG8gbmV4dCBhc3BlY3QgdGhhdCBoYXMgYXJvdW5kIGFkdmljZQoJCQkJd2hpbGUgKGkgPj0gMCAmJiAoYXNwZWN0ID0gYXNwZWN0c1tpXSkgJiYgdHlwZW9mIGFzcGVjdC5hcm91bmQgIT09ICdmdW5jdGlvbicpIC0taTsKCgkJCQkvLyBJZiB3ZSBleGhhdXN0ZWQgYWxsIGFzcGVjdHMsIGZpbmFsbHkgY2FsbCB0aGUgb3JpZ2luYWwKCQkJCS8vIE90aGVyd2lzZSwgaWYgd2UgZm91bmQgYW5vdGhlciBhcm91bmQsIGNhbGwgaXQKCQkJCXJldHVybiAoaSA8IDApID8gb3JpZy5jYWxsKGNvbnRleHQsIGFyZ3MpIDogY2FsbEFyb3VuZChhc3BlY3QuYXJvdW5kLCBpLCBhcmdzKTsKCQkJfQoKCQkJZnVuY3Rpb24gY2FsbEFyb3VuZChhcm91bmQsIGksIGFyZ3MpIHsKCQkJCXZhciBwcm9jZWVkLCBqb2lucG9pbnQ7CgoJCQkJLyoqCgkJCQkgKiBDcmVhdGUgcHJvY2VlZCBmdW5jdGlvbiB0aGF0IGNhbGxzIHRoZSBuZXh0IGFyb3VuZCBhZHZpY2UsIG9yIHRoZSBvcmlnaW5hbC4gIE92ZXJ3cml0ZXMgaXRzZWxmIHNvIHRoYXQgaXQgY2FuIG9ubHkgYmUgY2FsbGVkIG9uY2UuCgkJCQkgKiBAcGFyYW0gW2FyZ3NdIHtBcnJheX0gb3B0aW9uYWwgYXJndW1lbnRzIHRvIHVzZSBpbnN0ZWFkIG9mIHRoZSBvcmlnaW5hbCBhcmd1bWVudHMKCQkJCSAqLwoJCQkJcHJvY2VlZCA9IGZ1bmN0aW9uIChhcmdzKSB7CgkJCQkJcHJvY2VlZCA9IHByb2NlZWRBbHJlYWR5Q2FsbGVkOwoJCQkJCXJldHVybiBjYWxsTmV4dChpIC0gMSwgYXJncyk7CgkJCQl9OwoKCQkJCS8vIEpvaW5wb2ludCBpcyBpbW11dGFibGUKCQkJCWpvaW5wb2ludCA9IGZyZWV6ZSh7CgkJCQkJdGFyZ2V0OiBjb250ZXh0LAoJCQkJCW1ldGhvZDogbWV0aG9kLAoJCQkJCWFyZ3M6IGFyZ3MsCgkJCQkJcHJvY2VlZDogZnVuY3Rpb24gKC8qIG5ld0FyZ3MgKi8pIHsKCQkJCQkJLy8gaWYgbmV3IGFyZ3VtZW50cyB3ZXJlIHByb3ZpZGVkLCB1c2UgdGhlbQoJCQkJCQlyZXR1cm4gcHJvY2VlZChhcmd1bWVudHMubGVuZ3RoID4gMCA/IGFyZ3NUb0FycmF5KGFyZ3VtZW50cykgOiBhcmdzKTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBDYWxsIHN1cHBsaWVkIGFyb3VuZCBhZHZpY2UgZnVuY3Rpb24KCQkJCXJldHVybiBhcm91bmQuY2FsbChjb250ZXh0LCBqb2lucG9pbnQpOwoJCQl9CgoJCQlyZXR1cm4gY2FsbE5leHQobGVuIC0gMSwgYXJncyk7CgkJfSwKCgkJLyoqCgkJICogQWRkcyB0aGUgc3VwcGxpZWQgYXNwZWN0IHRvIHRoZSBhZHZpc2VkIHRhcmdldCBtZXRob2QKCQkgKgoJCSAqIEBwYXJhbSBhc3BlY3QKCQkgKi8KCQlhZGQ6IGZ1bmN0aW9uKGFzcGVjdCkgewoKCQkJdmFyIGFzcGVjdHMsIGFkdmlzb3I7CgoJCQlhZHZpc29yID0gdGhpczsKCQkJYXNwZWN0cyA9IGFkdmlzb3IuYXNwZWN0czsKCgkJCWFzcGVjdHMucHVzaChhc3BlY3QpOwoKCQkJcmV0dXJuIHsKCQkJCXJlbW92ZTogZnVuY3Rpb24gKCkgewoJCQkJCWZvciAodmFyIGkgPSBhc3BlY3RzLmxlbmd0aDsgaSA+PSAwOyAtLWkpIHsKCQkJCQkJaWYgKGFzcGVjdHNbaV0gPT09IGFzcGVjdCkgewoJCQkJCQkJYXNwZWN0cy5zcGxpY2UoaSwgMSk7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gSWYgdGhlcmUgYXJlIG5vIGFzcGVjdHMgbGVmdCwgcmVzdG9yZSB0aGUgb3JpZ2luYWwgbWV0aG9kCgkJCQkJaWYgKCFhc3BlY3RzLmxlbmd0aCkgewoJCQkJCQlhZHZpc29yLnJlbW92ZSgpOwoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9LAoKCQkvKioKCQkgKiBSZW1vdmVzIHRoZSBBZHZpc29yIGFuZCB0aHVzLCBhbGwgYXNwZWN0cyBmcm9tIHRoZSBhZHZpc2VkIHRhcmdldCBtZXRob2QsIGFuZAoJCSAqIHJlc3RvcmVzIHRoZSBvcmlnaW5hbCB0YXJnZXQgbWV0aG9kLCBjb3B5aW5nIGJhY2sgYWxsIHByb3BlcnRpZXMgdGhhdCBtYXkgaGF2ZQoJCSAqIGJlZW4gYWRkZWQgb3IgdXBkYXRlZCBvbiB0aGUgYWR2aXNlZCBmdW5jdGlvbi4KCQkgKi8KCQlyZW1vdmU6IGZ1bmN0aW9uICgpIHsKCQkJZGVsZXRlIHRoaXMuYWR2aXNlZC5fYWR2aXNvcjsKCQkJdGhpcy50YXJnZXRbdGhpcy5mdW5jXSA9IHRoaXMub3JpZzsKCQl9Cgl9OwoKCS8vIFJldHVybnMgdGhlIGFkdmlzb3IgZm9yIHRoZSB0YXJnZXQgb2JqZWN0LWZ1bmN0aW9uIHBhaXIuICBBIG5ldyBhZHZpc29yCgkvLyB3aWxsIGJlIGNyZWF0ZWQgaWYgb25lIGRvZXMgbm90IGFscmVhZHkgZXhpc3QuCglBZHZpc29yLmdldCA9IGZ1bmN0aW9uKHRhcmdldCwgZnVuYykgewoJCWlmKCEoZnVuYyBpbiB0YXJnZXQpKSByZXR1cm47CgoJCXZhciBhZHZpc29yLCBhZHZpc2VkOwoKCQlhZHZpc2VkID0gdGFyZ2V0W2Z1bmNdOwoKCQlpZih0eXBlb2YgYWR2aXNlZCAhPT0gJ2Z1bmN0aW9uJykgdGhyb3cgbmV3IEVycm9yKCdBZHZpY2UgY2FuIG9ubHkgYmUgYXBwbGllZCB0byBmdW5jdGlvbnM6ICcgKyBmdW5jKTsKCgkJYWR2aXNvciA9IGFkdmlzZWQuX2Fkdmlzb3I7CgkJaWYoIWFkdmlzb3IpIHsKCQkJYWR2aXNvciA9IG5ldyBBZHZpc29yKHRhcmdldCwgZnVuYyk7CgkJCXRhcmdldFtmdW5jXSA9IGFkdmlzb3IuYWR2aXNlZDsKCQl9CgoJCXJldHVybiBhZHZpc29yOwoJfTsKCglmdW5jdGlvbiBhZGRBc3BlY3RUb01ldGhvZCh0YXJnZXQsIG1ldGhvZCwgYXNwZWN0KSB7CgkJdmFyIGFkdmlzb3IgPSBBZHZpc29yLmdldCh0YXJnZXQsIG1ldGhvZCk7CgoJCXJldHVybiBhZHZpc29yICYmIGFkdmlzb3IuYWRkKGFzcGVjdCk7Cgl9CgoJZnVuY3Rpb24gYWRkQXNwZWN0VG9BbGwodGFyZ2V0LCBtZXRob2RBcnJheSwgYXNwZWN0KSB7CgkJdmFyIHJlbW92ZXJzLCBhZGRlZCwgZiwgaTsKCgkJcmVtb3ZlcnMgPSBbXTsKCQlpID0gMDsKCQl3aGlsZSgoZiA9IG1ldGhvZEFycmF5W2krK10pKSB7CgkJCSAgIGFkZGVkID0gYWRkQXNwZWN0VG9NZXRob2QodGFyZ2V0LCBmLCBhc3BlY3QpOwoJCQkgICBhZGRlZCAmJiByZW1vdmVycy5wdXNoKGFkZGVkKTsKCQl9CgoJCXJldHVybiB7CgkJCSAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CgkJCQkgICBmb3IgKHZhciBpID0gcmVtb3ZlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKCQkJCQkgICByZW1vdmVyc1tpXS5yZW1vdmUoKTsKCQkJCSAgIH0KCQkJICAgfQoJCSAgIH07CgkgICB9CgoJZnVuY3Rpb24gYWRkQXNwZWN0KHRhcmdldCwgcG9pbnRjdXQsIGFzcGVjdCkgewoJCS8vIHBvaW50Y3V0IGNhbiBiZTogc3RyaW5nLCBBcnJheSBvZiBzdHJpbmdzLCBSZWdFeHAsIEZ1bmN0aW9uKHRhcmdldE9iamVjdCk6IEFycmF5IG9mIHN0cmluZ3MKCQkvLyBhZHZpY2UgY2FuIGJlOiBvYmplY3QsIEZ1bmN0aW9uKHRhcmdldE9iamVjdCwgdGFyZ2V0TWV0aG9kTmFtZSkKCgkJdmFyIHBvaW50Y3V0VHlwZSwgcmVtb3ZlOwoKCQkgICB0YXJnZXQgPSBmaW5kVGFyZ2V0KHRhcmdldCk7CgoJCWlmIChpc0FycmF5KHBvaW50Y3V0KSkgewoJCQlyZW1vdmUgPSBhZGRBc3BlY3RUb0FsbCh0YXJnZXQsIHBvaW50Y3V0LCBhc3BlY3QpOwoKCQl9IGVsc2UgewoJCQlwb2ludGN1dFR5cGUgPSB0eXBlb2YgcG9pbnRjdXQ7CgoJCQlpZiAocG9pbnRjdXRUeXBlID09PSAnc3RyaW5nJykgewoJCQkJaWYgKHR5cGVvZiB0YXJnZXRbcG9pbnRjdXRdID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmVtb3ZlID0gYWRkQXNwZWN0VG9NZXRob2QodGFyZ2V0LCBwb2ludGN1dCwgYXNwZWN0KTsKCQkJCX0KCgkJCX0gZWxzZSBpZiAocG9pbnRjdXRUeXBlID09PSAnZnVuY3Rpb24nKSB7CgkJCQlyZW1vdmUgPSBhZGRBc3BlY3RUb0FsbCh0YXJnZXQsIHBvaW50Y3V0KHRhcmdldCksIGFzcGVjdCk7CgoJCQl9IGVsc2UgewoJCQkJLy8gQXNzdW1lIHRoZSBwb2ludGN1dCBpcyBhIFJlZ0V4cAoJCQkJZm9yICh2YXIgcCBpbiB0YXJnZXQpIHsKCQkJCQkvLyBUT0RPOiBEZWNpZGUgd2hldGhlciBoYXNPd25Qcm9wZXJ0eSBpcyBjb3JyZWN0IGhlcmUKCQkJCQkvLyBPbmx5IGFwcGx5IHRvIG93biBwcm9wZXJ0aWVzIHRoYXQgYXJlIGZ1bmN0aW9ucywgYW5kIG1hdGNoIHRoZSBwb2ludGN1dCByZWdleHAKCQkJCQlpZiAodHlwZW9mIHRhcmdldFtwXSA9PT0gJ2Z1bmN0aW9uJyAmJiBwb2ludGN1dC50ZXN0KHApKSB7CgkJCQkJCS8vIGlmKG9iamVjdC5oYXNPd25Qcm9wZXJ0eShwKSAmJiB0eXBlb2Ygb2JqZWN0W3BdID09PSAnZnVuY3Rpb24nICYmIHBvaW50Y3V0LnRlc3QocCkpIHsKCQkJCQkJcmVtb3ZlID0gYWRkQXNwZWN0VG9NZXRob2QodGFyZ2V0LCBwLCBhc3BlY3QpOwoKCQkJCQl9CgkJCQl9CgoJCQl9CgkJfQoKCQlyZXR1cm4gcmVtb3ZlOwoKCX0KCglmdW5jdGlvbiBmaW5kVGFyZ2V0KHRhcmdldCkgewoJCXJldHVybiB0YXJnZXQucHJvdG90eXBlIHx8IHRhcmdldDsKCX0KCgkvLyBDcmVhdGUgYW4gQVBJIGZ1bmN0aW9uIGZvciB0aGUgc3BlY2lmaWVkIGFkdmljZSB0eXBlCglmdW5jdGlvbiBhZHZpY2VBcGkodHlwZSkgewoJCXJldHVybiBmdW5jdGlvbih0YXJnZXQsIGZ1bmMsIGFkdmljZUZ1bmMpIHsKCQkJdmFyIGFzcGVjdCA9IHt9OwoJCQlhc3BlY3RbdHlwZV0gPSBhZHZpY2VGdW5jOwoKCQkJcmV0dXJuIGFkZEFzcGVjdCh0YXJnZXQsIGZ1bmMsIGFzcGVjdCk7CgkJfTsKCX0KCgkvLyBQdWJsaWMgQVBJCglyZXR1cm4gewoJCS8vIEdlbmVyYWwgYWRkIGFzcGVjdAoJCS8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmVtb3ZlIHRoZSBuZXdseS1hZGRlZCBhc3BlY3QKCQlhZGQ6ICAgICAgICAgICAgYWRkQXNwZWN0LAoKCQkvLyBBZGQgYSBzaW5nbGUsIHNwZWNpZmljIHR5cGUgb2YgYWR2aWNlCgkJLy8gcmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCByZW1vdmUgdGhlIG5ld2x5LWFkZGVkIGFkdmljZQoJCWJlZm9yZTogICAgICAgICBhZHZpY2VBcGkoJ2JlZm9yZScpLAoJCWFyb3VuZDogICAgICAgICBhZHZpY2VBcGkoJ2Fyb3VuZCcpLAoJCW9uOiAgICAgICAgICAgICBhZHZpY2VBcGkoJ29uJyksCgkJYWZ0ZXJSZXR1cm5pbmc6IGFkdmljZUFwaSgnYWZ0ZXJSZXR1cm5pbmcnKSwKCQlhZnRlclRocm93aW5nOiAgYWR2aWNlQXBpKCdhZnRlclRocm93aW5nJyksCgkJYWZ0ZXI6ICAgICAgICAgIGFkdmljZUFwaSgnYWZ0ZXInKQoJfTsKCn0pOwp9KSh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicKCT8gZGVmaW5lCgk6IGZ1bmN0aW9uIChmYWN0b3J5KSB7Cgl0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnCgkJPyAobW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCkpCgkJOiAodGhpcy5hb3AgPSBmYWN0b3J5KCkpOwoJfQoJLy8gQm9pbGVycGxhdGUgZm9yIEFNRCwgTm9kZSwgYW5kIGJyb3dzZXIgZ2xvYmFsCik7CgovLyBLbm9ja291dCBKYXZhU2NyaXB0IGxpYnJhcnkgdjIuMS4wCi8vIChjKSBTdGV2ZW4gU2FuZGVyc29uIC0gaHR0cDovL2tub2Nrb3V0anMuY29tLwovLyBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoKKGZ1bmN0aW9uKHdpbmRvdyxkb2N1bWVudCxuYXZpZ2F0b3IsdW5kZWZpbmVkKXsKdmFyIERFQlVHPXRydWU7CiFmdW5jdGlvbihmYWN0b3J5KSB7CiAgICAvLyBTdXBwb3J0IHRocmVlIG1vZHVsZSBsb2FkaW5nIHNjZW5hcmlvcwogICAgaWYgKHR5cGVvZiByZXF1aXJlID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JykgewogICAgICAgIC8vIFsxXSBDb21tb25KUy9Ob2RlLmpzCiAgICAgICAgdmFyIHRhcmdldCA9IG1vZHVsZVsnZXhwb3J0cyddIHx8IGV4cG9ydHM7IC8vIG1vZHVsZS5leHBvcnRzIGlzIGZvciBOb2RlLmpzCiAgICAgICAgZmFjdG9yeSh0YXJnZXQpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZVsnYW1kJ10pIHsKICAgICAgICAvLyBbMl0gQU1EIGFub255bW91cyBtb2R1bGUKICAgICAgICBkZWZpbmUoJ2tub2Nrb3V0JyxbJ2V4cG9ydHMnXSwgZmFjdG9yeSk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIFszXSBObyBtb2R1bGUgbG9hZGVyIChwbGFpbiA8c2NyaXB0PiB0YWcpIC0gcHV0IGRpcmVjdGx5IGluIGdsb2JhbCBuYW1lc3BhY2UKICAgICAgICBmYWN0b3J5KHdpbmRvd1sna28nXSA9IHt9KTsKICAgIH0KfShmdW5jdGlvbihrb0V4cG9ydHMpewovLyBJbnRlcm5hbGx5LCBhbGwgS08gb2JqZWN0cyBhcmUgYXR0YWNoZWQgdG8ga29FeHBvcnRzIChldmVuIHRoZSBub24tZXhwb3J0ZWQgb25lcyB3aG9zZSBuYW1lcyB3aWxsIGJlIG1pbmlmaWVkIGJ5IHRoZSBjbG9zdXJlIGNvbXBpbGVyKS4KLy8gSW4gdGhlIGZ1dHVyZSwgdGhlIGZvbGxvd2luZyAia28iIHZhcmlhYmxlIG1heSBiZSBtYWRlIGRpc3RpbmN0IGZyb20gImtvRXhwb3J0cyIgc28gdGhhdCBwcml2YXRlIG9iamVjdHMgYXJlIG5vdCBleHRlcm5hbGx5IHJlYWNoYWJsZS4KdmFyIGtvID0gdHlwZW9mIGtvRXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcgPyBrb0V4cG9ydHMgOiB7fTsKLy8gR29vZ2xlIENsb3N1cmUgQ29tcGlsZXIgaGVscGVycyAodXNlZCBvbmx5IHRvIG1ha2UgdGhlIG1pbmlmaWVkIGZpbGUgc21hbGxlcikKa28uZXhwb3J0U3ltYm9sID0gZnVuY3Rpb24oa29QYXRoLCBvYmplY3QpIHsKICAgIHZhciB0b2tlbnMgPSBrb1BhdGguc3BsaXQoIi4iKTsKCiAgICAvLyBJbiB0aGUgZnV0dXJlLCAia28iIG1heSBiZWNvbWUgZGlzdGluY3QgZnJvbSAia29FeHBvcnRzIiAoc28gdGhhdCBub24tZXhwb3J0ZWQgb2JqZWN0cyBhcmUgbm90IHJlYWNoYWJsZSkKICAgIC8vIEF0IHRoYXQgcG9pbnQsICJ0YXJnZXQiIHdvdWxkIGJlIHNldCB0bzogKHR5cGVvZiBrb0V4cG9ydHMgIT09ICJ1bmRlZmluZWQiID8ga29FeHBvcnRzIDoga28pCiAgICB2YXIgdGFyZ2V0ID0ga287CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoIC0gMTsgaSsrKQogICAgICAgIHRhcmdldCA9IHRhcmdldFt0b2tlbnNbaV1dOwogICAgdGFyZ2V0W3Rva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV1dID0gb2JqZWN0Owp9Owprby5leHBvcnRQcm9wZXJ0eSA9IGZ1bmN0aW9uKG93bmVyLCBwdWJsaWNOYW1lLCBvYmplY3QpIHsKICBvd25lcltwdWJsaWNOYW1lXSA9IG9iamVjdDsKfTsKa28udmVyc2lvbiA9ICIyLjEuMCI7Cgprby5leHBvcnRTeW1ib2woJ3ZlcnNpb24nLCBrby52ZXJzaW9uKTsKa28udXRpbHMgPSBuZXcgKGZ1bmN0aW9uICgpIHsKICAgIHZhciBzdHJpbmdUcmltUmVnZXggPSAvXihcc3xcdTAwQTApK3woXHN8XHUwMEEwKSskL2c7CgogICAgLy8gUmVwcmVzZW50IHRoZSBrbm93biBldmVudCB0eXBlcyBpbiBhIGNvbXBhY3Qgd2F5LCB0aGVuIGF0IHJ1bnRpbWUgdHJhbnNmb3JtIGl0IGludG8gYSBoYXNoIHdpdGggZXZlbnQgbmFtZSBhcyBrZXkgKGZvciBmYXN0IGxvb2t1cCkKICAgIHZhciBrbm93bkV2ZW50cyA9IHt9LCBrbm93bkV2ZW50VHlwZXNCeUV2ZW50TmFtZSA9IHt9OwogICAgdmFyIGtleUV2ZW50VHlwZU5hbWUgPSAvRmlyZWZveFwvMi9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCkgPyAnS2V5Ym9hcmRFdmVudCcgOiAnVUlFdmVudHMnOwogICAga25vd25FdmVudHNba2V5RXZlbnRUeXBlTmFtZV0gPSBbJ2tleXVwJywgJ2tleWRvd24nLCAna2V5cHJlc3MnXTsKICAgIGtub3duRXZlbnRzWydNb3VzZUV2ZW50cyddID0gWydjbGljaycsICdkYmxjbGljaycsICdtb3VzZWRvd24nLCAnbW91c2V1cCcsICdtb3VzZW1vdmUnLCAnbW91c2VvdmVyJywgJ21vdXNlb3V0JywgJ21vdXNlZW50ZXInLCAnbW91c2VsZWF2ZSddOwogICAgZm9yICh2YXIgZXZlbnRUeXBlIGluIGtub3duRXZlbnRzKSB7CiAgICAgICAgdmFyIGtub3duRXZlbnRzRm9yVHlwZSA9IGtub3duRXZlbnRzW2V2ZW50VHlwZV07CiAgICAgICAgaWYgKGtub3duRXZlbnRzRm9yVHlwZS5sZW5ndGgpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBrbm93bkV2ZW50c0ZvclR5cGUubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAga25vd25FdmVudFR5cGVzQnlFdmVudE5hbWVba25vd25FdmVudHNGb3JUeXBlW2ldXSA9IGV2ZW50VHlwZTsKICAgICAgICB9CiAgICB9CiAgICB2YXIgZXZlbnRzVGhhdE11c3RCZVJlZ2lzdGVyZWRVc2luZ0F0dGFjaEV2ZW50ID0geyAncHJvcGVydHljaGFuZ2UnOiB0cnVlIH07IC8vIFdvcmthcm91bmQgZm9yIGFuIElFOSBpc3N1ZSAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNDA2CgogICAgLy8gRGV0ZWN0IElFIHZlcnNpb25zIGZvciBidWcgd29ya2Fyb3VuZHMgKHVzZXMgSUUgY29uZGl0aW9uYWxzLCBub3QgVUEgc3RyaW5nLCBmb3Igcm9idXN0bmVzcykKICAgIHZhciBpZVZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHZlcnNpb24gPSAzLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgaUVsZW1zID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpJyk7CgogICAgICAgIC8vIEtlZXAgY29uc3RydWN0aW5nIGNvbmRpdGlvbmFsIEhUTUwgYmxvY2tzIHVudGlsIHdlIGhpdCBvbmUgdGhhdCByZXNvbHZlcyB0byBhbiBlbXB0eSBmcmFnbWVudAogICAgICAgIHdoaWxlICgKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8IS0tW2lmIGd0IElFICcgKyAoKyt2ZXJzaW9uKSArICddPjxpPjwvaT48IVtlbmRpZl0tLT4nLAogICAgICAgICAgICBpRWxlbXNbMF0KICAgICAgICApOwogICAgICAgIHJldHVybiB2ZXJzaW9uID4gNCA/IHZlcnNpb24gOiB1bmRlZmluZWQ7CiAgICB9KCkpOwogICAgdmFyIGlzSWU2ID0gaWVWZXJzaW9uID09PSA2LAogICAgICAgIGlzSWU3ID0gaWVWZXJzaW9uID09PSA3OwoKICAgIGZ1bmN0aW9uIGlzQ2xpY2tPbkNoZWNrYWJsZUVsZW1lbnQoZWxlbWVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgaWYgKChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJpbnB1dCIpIHx8ICFlbGVtZW50LnR5cGUpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoZXZlbnRUeXBlLnRvTG93ZXJDYXNlKCkgIT0gImNsaWNrIikgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBpbnB1dFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgcmV0dXJuIChpbnB1dFR5cGUgPT0gImNoZWNrYm94IikgfHwgKGlucHV0VHlwZSA9PSAicmFkaW8iKTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIGZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OiBbJ2F1dGhlbnRpY2l0eV90b2tlbicsIC9eX19SZXF1ZXN0VmVyaWZpY2F0aW9uVG9rZW4oXy4qKT8kL10sCgogICAgICAgIGFycmF5Rm9yRWFjaDogZnVuY3Rpb24gKGFycmF5LCBhY3Rpb24pIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBhY3Rpb24oYXJyYXlbaV0pOwogICAgICAgIH0sCgogICAgICAgIGFycmF5SW5kZXhPZjogZnVuY3Rpb24gKGFycmF5LCBpdGVtKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFycmF5LCBpdGVtKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICBhcnJheUZpcnN0OiBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSwgcHJlZGljYXRlT3duZXIpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBpZiAocHJlZGljYXRlLmNhbGwocHJlZGljYXRlT3duZXIsIGFycmF5W2ldKSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXlbaV07CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIGFycmF5UmVtb3ZlSXRlbTogZnVuY3Rpb24gKGFycmF5LCBpdGVtVG9SZW1vdmUpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5LCBpdGVtVG9SZW1vdmUpOwogICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkKICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfSwKCiAgICAgICAgYXJyYXlHZXREaXN0aW5jdFZhbHVlczogZnVuY3Rpb24gKGFycmF5KSB7CiAgICAgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YocmVzdWx0LCBhcnJheVtpXSkgPCAwKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIGFycmF5TWFwOiBmdW5jdGlvbiAoYXJyYXksIG1hcHBpbmcpIHsKICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG1hcHBpbmcoYXJyYXlbaV0pKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheUZpbHRlcjogZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbaV0pKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBhcnJheVB1c2hBbGw6IGZ1bmN0aW9uIChhcnJheSwgdmFsdWVzVG9QdXNoKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZXNUb1B1c2ggaW5zdGFuY2VvZiBBcnJheSkKICAgICAgICAgICAgICAgIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIHZhbHVlc1RvUHVzaCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmFsdWVzVG9QdXNoLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlc1RvUHVzaFtpXSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICB9LAoKICAgICAgICBleHRlbmQ6IGZ1bmN0aW9uICh0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICAgICAgICBmb3IodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9LAoKICAgICAgICBlbXB0eURvbU5vZGU6IGZ1bmN0aW9uIChkb21Ob2RlKSB7CiAgICAgICAgICAgIHdoaWxlIChkb21Ob2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIGtvLnJlbW92ZU5vZGUoZG9tTm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG1vdmVDbGVhbmVkTm9kZXNUb0NvbnRhaW5lckVsZW1lbnQ6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICAgICAgICAgIC8vIEVuc3VyZSBpdCdzIGEgcmVhbCBhcnJheSwgYXMgd2UncmUgYWJvdXQgdG8gcmVwYXJlbnQgdGhlIG5vZGVzIGFuZAogICAgICAgICAgICAvLyB3ZSBkb24ndCB3YW50IHRoZSB1bmRlcmx5aW5nIGNvbGxlY3Rpb24gdG8gY2hhbmdlIHdoaWxlIHdlJ3JlIGRvaW5nIHRoYXQuCiAgICAgICAgICAgIHZhciBub2Rlc0FycmF5ID0ga28udXRpbHMubWFrZUFycmF5KG5vZGVzKTsKCiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBub2Rlc0FycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAga28uY2xlYW5Ob2RlKG5vZGVzQXJyYXlbaV0pOwogICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKG5vZGVzQXJyYXlbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250YWluZXI7CiAgICAgICAgfSwKCiAgICAgICAgc2V0RG9tTm9kZUNoaWxkcmVuOiBmdW5jdGlvbiAoZG9tTm9kZSwgY2hpbGROb2RlcykgewogICAgICAgICAgICBrby51dGlscy5lbXB0eURvbU5vZGUoZG9tTm9kZSk7CiAgICAgICAgICAgIGlmIChjaGlsZE5vZGVzKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgICAgIGRvbU5vZGUuYXBwZW5kQ2hpbGQoY2hpbGROb2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICByZXBsYWNlRG9tTm9kZXM6IGZ1bmN0aW9uIChub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXksIG5ld05vZGVzQXJyYXkpIHsKICAgICAgICAgICAgdmFyIG5vZGVzVG9SZXBsYWNlQXJyYXkgPSBub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXkubm9kZVR5cGUgPyBbbm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5XSA6IG5vZGVUb1JlcGxhY2VPck5vZGVBcnJheTsKICAgICAgICAgICAgaWYgKG5vZGVzVG9SZXBsYWNlQXJyYXkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIGluc2VydGlvblBvaW50ID0gbm9kZXNUb1JlcGxhY2VBcnJheVswXTsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBpbnNlcnRpb25Qb2ludC5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBuZXdOb2Rlc0FycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5ld05vZGVzQXJyYXlbaV0sIGluc2VydGlvblBvaW50KTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbm9kZXNUb1JlcGxhY2VBcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKG5vZGVzVG9SZXBsYWNlQXJyYXlbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgc2V0T3B0aW9uTm9kZVNlbGVjdGlvblN0YXRlOiBmdW5jdGlvbiAob3B0aW9uTm9kZSwgaXNTZWxlY3RlZCkgewogICAgICAgICAgICAvLyBJRTYgc29tZXRpbWVzIHRocm93cyAidW5rbm93biBlcnJvciIgaWYgeW91IHRyeSB0byB3cml0ZSB0byAuc2VsZWN0ZWQgZGlyZWN0bHksIHdoZXJlYXMgRmlyZWZveCBzdHJ1Z2dsZXMgd2l0aCBzZXRBdHRyaWJ1dGUuIFBpY2sgb25lIGJhc2VkIG9uIGJyb3dzZXIuCiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIk1TSUUgNiIpID49IDApCiAgICAgICAgICAgICAgICBvcHRpb25Ob2RlLnNldEF0dHJpYnV0ZSgic2VsZWN0ZWQiLCBpc1NlbGVjdGVkKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgb3B0aW9uTm9kZS5zZWxlY3RlZCA9IGlzU2VsZWN0ZWQ7CiAgICAgICAgfSwKCiAgICAgICAgc3RyaW5nVHJpbTogZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gKHN0cmluZyB8fCAiIikucmVwbGFjZShzdHJpbmdUcmltUmVnZXgsICIiKTsKICAgICAgICB9LAoKICAgICAgICBzdHJpbmdUb2tlbml6ZTogZnVuY3Rpb24gKHN0cmluZywgZGVsaW1pdGVyKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgdmFyIHRva2VucyA9IChzdHJpbmcgfHwgIiIpLnNwbGl0KGRlbGltaXRlcik7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdG9rZW5zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHRyaW1tZWQgPSBrby51dGlscy5zdHJpbmdUcmltKHRva2Vuc1tpXSk7CiAgICAgICAgICAgICAgICBpZiAodHJpbW1lZCAhPT0gIiIpCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godHJpbW1lZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBzdHJpbmdTdGFydHNXaXRoOiBmdW5jdGlvbiAoc3RyaW5nLCBzdGFydHNXaXRoKSB7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZyB8fCAiIjsKICAgICAgICAgICAgaWYgKHN0YXJ0c1dpdGgubGVuZ3RoID4gc3RyaW5nLmxlbmd0aCkKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZy5zdWJzdHJpbmcoMCwgc3RhcnRzV2l0aC5sZW5ndGgpID09PSBzdGFydHNXaXRoOwogICAgICAgIH0sCgogICAgICAgIGJ1aWxkRXZhbFdpdGhpblNjb3BlRnVuY3Rpb246IGZ1bmN0aW9uIChleHByZXNzaW9uLCBzY29wZUxldmVscykgewogICAgICAgICAgICAvLyBCdWlsZCB0aGUgc291cmNlIGZvciBhIGZ1bmN0aW9uIHRoYXQgZXZhbHVhdGVzICJleHByZXNzaW9uIgogICAgICAgICAgICAvLyBGb3IgZWFjaCBzY29wZSB2YXJpYWJsZSwgYWRkIGFuIGV4dHJhIGxldmVsIG9mICJ3aXRoIiBuZXN0aW5nCiAgICAgICAgICAgIC8vIEV4YW1wbGUgcmVzdWx0OiB3aXRoKHNjWzFdKSB7IHdpdGgoc2NbMF0pIHsgcmV0dXJuIChleHByZXNzaW9uKSB9IH0KICAgICAgICAgICAgdmFyIGZ1bmN0aW9uQm9keSA9ICJyZXR1cm4gKCIgKyBleHByZXNzaW9uICsgIikiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNjb3BlTGV2ZWxzOyBpKyspIHsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uQm9keSA9ICJ3aXRoKHNjWyIgKyBpICsgIl0pIHsgIiArIGZ1bmN0aW9uQm9keSArICIgfSAiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oInNjIiwgZnVuY3Rpb25Cb2R5KTsKICAgICAgICB9LAoKICAgICAgICBkb21Ob2RlSXNDb250YWluZWRCeTogZnVuY3Rpb24gKG5vZGUsIGNvbnRhaW5lZEJ5Tm9kZSkgewogICAgICAgICAgICBpZiAoY29udGFpbmVkQnlOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKQogICAgICAgICAgICAgICAgcmV0dXJuIChjb250YWluZWRCeU5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24obm9kZSkgJiAxNikgPT0gMTY7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlID09IGNvbnRhaW5lZEJ5Tm9kZSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIGRvbU5vZGVJc0F0dGFjaGVkVG9Eb2N1bWVudDogZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbU5vZGVJc0NvbnRhaW5lZEJ5KG5vZGUsIG5vZGUub3duZXJEb2N1bWVudCk7CiAgICAgICAgfSwKCiAgICAgICAgdGFnTmFtZUxvd2VyOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIC8vIEZvciBIVE1MIGVsZW1lbnRzLCB0YWdOYW1lIHdpbGwgYWx3YXlzIGJlIHVwcGVyIGNhc2U7IGZvciBYSFRNTCBlbGVtZW50cywgaXQnbGwgYmUgbG93ZXIgY2FzZS4KICAgICAgICAgICAgLy8gUG9zc2libGUgZnV0dXJlIG9wdGltaXphdGlvbjogSWYgd2Uga25vdyBpdCdzIGFuIGVsZW1lbnQgZnJvbSBhbiBYSFRNTCBkb2N1bWVudCAobm90IEhUTUwpLAogICAgICAgICAgICAvLyB3ZSBkb24ndCBuZWVkIHRvIGRvIHRoZSAudG9Mb3dlckNhc2UoKSBhcyBpdCB3aWxsIGFsd2F5cyBiZSBsb3dlciBjYXNlIGFueXdheS4KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQgJiYgZWxlbWVudC50YWdOYW1lICYmIGVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0sCgogICAgICAgIHJlZ2lzdGVyRXZlbnRIYW5kbGVyOiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRUeXBlLCBoYW5kbGVyKSB7CiAgICAgICAgICAgIHZhciBtdXN0VXNlQXR0YWNoRXZlbnQgPSBpZVZlcnNpb24gJiYgZXZlbnRzVGhhdE11c3RCZVJlZ2lzdGVyZWRVc2luZ0F0dGFjaEV2ZW50W2V2ZW50VHlwZV07CiAgICAgICAgICAgIGlmICghbXVzdFVzZUF0dGFjaEV2ZW50ICYmIHR5cGVvZiBqUXVlcnkgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGlmIChpc0NsaWNrT25DaGVja2FibGVFbGVtZW50KGVsZW1lbnQsIGV2ZW50VHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBGb3IgY2xpY2sgZXZlbnRzIG9uIGNoZWNrYm94ZXMsIGpRdWVyeSBpbnRlcmZlcmVzIHdpdGggdGhlIGV2ZW50IGhhbmRsaW5nIGluIGFuIGF3a3dhcmQgd2F5OgogICAgICAgICAgICAgICAgICAgIC8vIGl0IHRvZ2dsZXMgdGhlIGVsZW1lbnQgY2hlY2tlZCBzdGF0ZSAqYWZ0ZXIqIHRoZSBjbGljayBldmVudCBoYW5kbGVycyBydW4sIHdoZXJlYXMgbmF0aXZlCiAgICAgICAgICAgICAgICAgICAgLy8gY2xpY2sgZXZlbnRzIHRvZ2dsZSB0aGUgY2hlY2tlZCBzdGF0ZSAqYmVmb3JlKiB0aGUgZXZlbnQgaGFuZGxlci4KICAgICAgICAgICAgICAgICAgICAvLyBGaXggdGhpcyBieSBpbnRlY2VwdGluZyB0aGUgaGFuZGxlciBhbmQgYXBwbHlpbmcgdGhlIGNvcnJlY3QgY2hlY2tlZG5lc3MgYmVmb3JlIGl0IHJ1bnMuCiAgICAgICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsSGFuZGxlciA9IGhhbmRsZXI7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IGZ1bmN0aW9uKGV2ZW50LCBldmVudERhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGpRdWVyeVN1cHBsaWVkQ2hlY2tlZFN0YXRlID0gdGhpcy5jaGVja2VkOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnREYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGVja2VkID0gZXZlbnREYXRhLmNoZWNrZWRTdGF0ZUJlZm9yZUV2ZW50ICE9PSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbEhhbmRsZXIuY2FsbCh0aGlzLCBldmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IGpRdWVyeVN1cHBsaWVkQ2hlY2tlZFN0YXRlOyAvLyBSZXN0b3JlIHRoZSBzdGF0ZSBqUXVlcnkgYXBwbGllZAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBqUXVlcnkoZWxlbWVudClbJ2JpbmQnXShldmVudFR5cGUsIGhhbmRsZXIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFtdXN0VXNlQXR0YWNoRXZlbnQgJiYgdHlwZW9mIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA9PSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgaGFuZGxlciwgZmFsc2UpOwogICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgZWxlbWVudC5hdHRhY2hFdmVudCAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXR0YWNoRXZlbnQoIm9uIiArIGV2ZW50VHlwZSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5jYWxsKGVsZW1lbnQsIGV2ZW50KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IGFkZEV2ZW50TGlzdGVuZXIgb3IgYXR0YWNoRXZlbnQiKTsKICAgICAgICB9LAoKICAgICAgICB0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCBldmVudFR5cGUpIHsKICAgICAgICAgICAgaWYgKCEoZWxlbWVudCAmJiBlbGVtZW50Lm5vZGVUeXBlKSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZWxlbWVudCBtdXN0IGJlIGEgRE9NIG5vZGUgd2hlbiBjYWxsaW5nIHRyaWdnZXJFdmVudCIpOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBqUXVlcnkgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHZhciBldmVudERhdGEgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChpc0NsaWNrT25DaGVja2FibGVFbGVtZW50KGVsZW1lbnQsIGV2ZW50VHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBXb3JrIGFyb3VuZCB0aGUgalF1ZXJ5ICJjbGljayBldmVudHMgb24gY2hlY2tib3hlcyIgaXNzdWUgZGVzY3JpYmVkIGFib3ZlIGJ5IHN0b3JpbmcgdGhlIG9yaWdpbmFsIGNoZWNrZWQgc3RhdGUgYmVmb3JlIHRyaWdnZXJpbmcgdGhlIGhhbmRsZXIKICAgICAgICAgICAgICAgICAgICBldmVudERhdGEucHVzaCh7IGNoZWNrZWRTdGF0ZUJlZm9yZUV2ZW50OiBlbGVtZW50LmNoZWNrZWQgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBqUXVlcnkoZWxlbWVudClbJ3RyaWdnZXInXShldmVudFR5cGUsIGV2ZW50RGF0YSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRvY3VtZW50LmNyZWF0ZUV2ZW50ID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudC5kaXNwYXRjaEV2ZW50ID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRDYXRlZ29yeSA9IGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lW2V2ZW50VHlwZV0gfHwgIkhUTUxFdmVudHMiOwogICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KGV2ZW50Q2F0ZWdvcnkpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudChldmVudFR5cGUsIHRydWUsIHRydWUsIHdpbmRvdywgMCwgMCwgMCwgMCwgMCwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgc3VwcGxpZWQgZWxlbWVudCBkb2Vzbid0IHN1cHBvcnQgZGlzcGF0Y2hFdmVudCIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50LmZpcmVFdmVudCAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgLy8gVW5saWtlIG90aGVyIGJyb3dzZXJzLCBJRSBkb2Vzbid0IGNoYW5nZSB0aGUgY2hlY2tlZCBzdGF0ZSBvZiBjaGVja2JveGVzL3JhZGlvYnV0dG9ucyB3aGVuIHlvdSB0cmlnZ2VyIHRoZWlyICJjbGljayIgZXZlbnQKICAgICAgICAgICAgICAgIC8vIHNvIHRvIG1ha2UgaXQgY29uc2lzdGVudCwgd2UnbGwgZG8gaXQgbWFudWFsbHkgaGVyZQogICAgICAgICAgICAgICAgaWYgKGlzQ2xpY2tPbkNoZWNrYWJsZUVsZW1lbnQoZWxlbWVudCwgZXZlbnRUeXBlKSkKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmNoZWNrZWQgPSBlbGVtZW50LmNoZWNrZWQgIT09IHRydWU7CiAgICAgICAgICAgICAgICBlbGVtZW50LmZpcmVFdmVudCgib24iICsgZXZlbnRUeXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IHRyaWdnZXJpbmcgZXZlbnRzIik7CiAgICAgICAgfSwKCiAgICAgICAgdW53cmFwT2JzZXJ2YWJsZTogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBrby5pc09ic2VydmFibGUodmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIHRvZ2dsZURvbU5vZGVDc3NDbGFzczogZnVuY3Rpb24gKG5vZGUsIGNsYXNzTmFtZSwgc2hvdWxkSGF2ZUNsYXNzKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Q2xhc3NOYW1lcyA9IChub2RlLmNsYXNzTmFtZSB8fCAiIikuc3BsaXQoL1xzKy8pOwogICAgICAgICAgICB2YXIgaGFzQ2xhc3MgPSBrby51dGlscy5hcnJheUluZGV4T2YoY3VycmVudENsYXNzTmFtZXMsIGNsYXNzTmFtZSkgPj0gMDsKCiAgICAgICAgICAgIGlmIChzaG91bGRIYXZlQ2xhc3MgJiYgIWhhc0NsYXNzKSB7CiAgICAgICAgICAgICAgICBub2RlLmNsYXNzTmFtZSArPSAoY3VycmVudENsYXNzTmFtZXNbMF0gPyAiICIgOiAiIikgKyBjbGFzc05hbWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzQ2xhc3MgJiYgIXNob3VsZEhhdmVDbGFzcykgewogICAgICAgICAgICAgICAgdmFyIG5ld0NsYXNzTmFtZSA9ICIiOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjdXJyZW50Q2xhc3NOYW1lcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudENsYXNzTmFtZXNbaV0gIT0gY2xhc3NOYW1lKQogICAgICAgICAgICAgICAgICAgICAgICBuZXdDbGFzc05hbWUgKz0gY3VycmVudENsYXNzTmFtZXNbaV0gKyAiICI7CiAgICAgICAgICAgICAgICBub2RlLmNsYXNzTmFtZSA9IGtvLnV0aWxzLnN0cmluZ1RyaW0obmV3Q2xhc3NOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHNldFRleHRDb250ZW50OiBmdW5jdGlvbihlbGVtZW50LCB0ZXh0Q29udGVudCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHRleHRDb250ZW50KTsKICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSB1bmRlZmluZWQpKQogICAgICAgICAgICAgICAgdmFsdWUgPSAiIjsKCiAgICAgICAgICAgICdpbm5lclRleHQnIGluIGVsZW1lbnQgPyBlbGVtZW50LmlubmVyVGV4dCA9IHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBlbGVtZW50LnRleHRDb250ZW50ID0gdmFsdWU7CgogICAgICAgICAgICBpZiAoaWVWZXJzaW9uID49IDkpIHsKICAgICAgICAgICAgICAgIC8vIEJlbGlldmUgaXQgb3Igbm90LCB0aGlzIGFjdHVhbGx5IGZpeGVzIGFuIElFOSByZW5kZXJpbmcgYnVnCiAgICAgICAgICAgICAgICAvLyAoU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMjA5KQogICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gZWxlbWVudC5zdHlsZS5kaXNwbGF5OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZW5zdXJlU2VsZWN0RWxlbWVudElzUmVuZGVyZWRDb3JyZWN0bHk6IGZ1bmN0aW9uKHNlbGVjdEVsZW1lbnQpIHsKICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgSUU5IHJlbmRlcmluZyBidWcgLSBpdCBkb2Vzbid0IHJlbGlhYmx5IGRpc3BsYXkgYWxsIHRoZSB0ZXh0IGluIGR5bmFtaWNhbGx5LWFkZGVkIHNlbGVjdCBib3hlcyB1bmxlc3MgeW91IGZvcmNlIGl0IHRvIHJlLXJlbmRlciBieSB1cGRhdGluZyB0aGUgd2lkdGguCiAgICAgICAgICAgIC8vIChTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8zMTIsIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTkwODQ5NC9zZWxlY3Qtb25seS1zaG93cy1maXJzdC1jaGFyLW9mLXNlbGVjdGVkLW9wdGlvbikKICAgICAgICAgICAgaWYgKGllVmVyc2lvbiA+PSA5KSB7CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxXaWR0aCA9IHNlbGVjdEVsZW1lbnQuc3R5bGUud2lkdGg7CiAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnN0eWxlLndpZHRoID0gMDsKICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuc3R5bGUud2lkdGggPSBvcmlnaW5hbFdpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcmFuZ2U6IGZ1bmN0aW9uIChtaW4sIG1heCkgewogICAgICAgICAgICBtaW4gPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG1pbik7CiAgICAgICAgICAgIG1heCA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobWF4KTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gbWluOyBpIDw9IG1heDsgaSsrKQogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goaSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAgbWFrZUFycmF5OiBmdW5jdGlvbihhcnJheUxpa2VPYmplY3QpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5TGlrZU9iamVjdC5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5TGlrZU9iamVjdFtpXSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAgaXNJZTYgOiBpc0llNiwKICAgICAgICBpc0llNyA6IGlzSWU3LAogICAgICAgIGllVmVyc2lvbiA6IGllVmVyc2lvbiwKCiAgICAgICAgZ2V0Rm9ybUZpZWxkczogZnVuY3Rpb24oZm9ybSwgZmllbGROYW1lKSB7CiAgICAgICAgICAgIHZhciBmaWVsZHMgPSBrby51dGlscy5tYWtlQXJyYXkoZm9ybS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaW5wdXQiKSkuY29uY2F0KGtvLnV0aWxzLm1ha2VBcnJheShmb3JtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0ZXh0YXJlYSIpKSk7CiAgICAgICAgICAgIHZhciBpc01hdGNoaW5nRmllbGQgPSAodHlwZW9mIGZpZWxkTmFtZSA9PSAnc3RyaW5nJykKICAgICAgICAgICAgICAgID8gZnVuY3Rpb24oZmllbGQpIHsgcmV0dXJuIGZpZWxkLm5hbWUgPT09IGZpZWxkTmFtZSB9CiAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uKGZpZWxkKSB7IHJldHVybiBmaWVsZE5hbWUudGVzdChmaWVsZC5uYW1lKSB9OyAvLyBUcmVhdCBmaWVsZE5hbWUgYXMgcmVnZXggb3Igb2JqZWN0IGNvbnRhaW5pbmcgcHJlZGljYXRlCiAgICAgICAgICAgIHZhciBtYXRjaGVzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBmaWVsZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGlmIChpc01hdGNoaW5nRmllbGQoZmllbGRzW2ldKSkKICAgICAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goZmllbGRzW2ldKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXM7CiAgICAgICAgfSwKCiAgICAgICAgcGFyc2VKc29uOiBmdW5jdGlvbiAoanNvblN0cmluZykgewogICAgICAgICAgICBpZiAodHlwZW9mIGpzb25TdHJpbmcgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGpzb25TdHJpbmcgPSBrby51dGlscy5zdHJpbmdUcmltKGpzb25TdHJpbmcpOwogICAgICAgICAgICAgICAgaWYgKGpzb25TdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LkpTT04gJiYgd2luZG93LkpTT04ucGFyc2UpIC8vIFVzZSBuYXRpdmUgcGFyc2luZyB3aGVyZSBhdmFpbGFibGUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5KU09OLnBhcnNlKGpzb25TdHJpbmcpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAobmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIGpzb25TdHJpbmcpKSgpOyAvLyBGYWxsYmFjayBvbiBsZXNzIHNhZmUgcGFyc2luZyBmb3Igb2xkZXIgYnJvd3NlcnMKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9LAoKICAgICAgICBzdHJpbmdpZnlKc29uOiBmdW5jdGlvbiAoZGF0YSwgcmVwbGFjZXIsIHNwYWNlKSB7ICAgLy8gcmVwbGFjZXIgYW5kIHNwYWNlIGFyZSBvcHRpb25hbAogICAgICAgICAgICBpZiAoKHR5cGVvZiBKU09OID09ICJ1bmRlZmluZWQiKSB8fCAodHlwZW9mIEpTT04uc3RyaW5naWZ5ID09ICJ1bmRlZmluZWQiKSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgSlNPTi5zdHJpbmdpZnkoKS4gU29tZSBicm93c2VycyAoZS5nLiwgSUUgPCA4KSBkb24ndCBzdXBwb3J0IGl0IG5hdGl2ZWx5LCBidXQgeW91IGNhbiBvdmVyY29tZSB0aGlzIGJ5IGFkZGluZyBhIHNjcmlwdCByZWZlcmVuY2UgdG8ganNvbjIuanMsIGRvd25sb2FkYWJsZSBmcm9tIGh0dHA6Ly93d3cuanNvbi5vcmcvanNvbjIuanMiKTsKICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZGF0YSksIHJlcGxhY2VyLCBzcGFjZSk7CiAgICAgICAgfSwKCiAgICAgICAgcG9zdEpzb246IGZ1bmN0aW9uICh1cmxPckZvcm0sIGRhdGEsIG9wdGlvbnMpIHsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICAgIHZhciBwYXJhbXMgPSBvcHRpb25zWydwYXJhbXMnXSB8fCB7fTsKICAgICAgICAgICAgdmFyIGluY2x1ZGVGaWVsZHMgPSBvcHRpb25zWydpbmNsdWRlRmllbGRzJ10gfHwgdGhpcy5maWVsZHNJbmNsdWRlZFdpdGhKc29uUG9zdDsKICAgICAgICAgICAgdmFyIHVybCA9IHVybE9yRm9ybTsKCiAgICAgICAgICAgIC8vIElmIHdlIHdlcmUgZ2l2ZW4gYSBmb3JtLCB1c2UgaXRzICdhY3Rpb24nIFVSTCBhbmQgcGljayBvdXQgYW55IHJlcXVlc3RlZCBmaWVsZCB2YWx1ZXMKICAgICAgICAgICAgaWYoKHR5cGVvZiB1cmxPckZvcm0gPT0gJ29iamVjdCcpICYmIChrby51dGlscy50YWdOYW1lTG93ZXIodXJsT3JGb3JtKSA9PT0gImZvcm0iKSkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsRm9ybSA9IHVybE9yRm9ybTsKICAgICAgICAgICAgICAgIHVybCA9IG9yaWdpbmFsRm9ybS5hY3Rpb247CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gaW5jbHVkZUZpZWxkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgICAgIHZhciBmaWVsZHMgPSBrby51dGlscy5nZXRGb3JtRmllbGRzKG9yaWdpbmFsRm9ybSwgaW5jbHVkZUZpZWxkc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IGZpZWxkcy5sZW5ndGggLSAxOyBqID49IDA7IGotLSkKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2ZpZWxkc1tqXS5uYW1lXSA9IGZpZWxkc1tqXS52YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGF0YSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZGF0YSk7CiAgICAgICAgICAgIHZhciBmb3JtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZm9ybSIpOwogICAgICAgICAgICBmb3JtLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICAgIGZvcm0uYWN0aW9uID0gdXJsOwogICAgICAgICAgICBmb3JtLm1ldGhvZCA9ICJwb3N0IjsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgICAgICBpbnB1dC5uYW1lID0ga2V5OwogICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBrby51dGlscy5zdHJpbmdpZnlKc29uKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZGF0YVtrZXldKSk7CiAgICAgICAgICAgICAgICBmb3JtLmFwcGVuZENoaWxkKGlucHV0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcGFyYW1zKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgICAgICAgICAgaW5wdXQubmFtZSA9IGtleTsKICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gcGFyYW1zW2tleV07CiAgICAgICAgICAgICAgICBmb3JtLmFwcGVuZENoaWxkKGlucHV0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZvcm0pOwogICAgICAgICAgICBvcHRpb25zWydzdWJtaXR0ZXInXSA/IG9wdGlvbnNbJ3N1Ym1pdHRlciddKGZvcm0pIDogZm9ybS5zdWJtaXQoKTsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IGZvcm0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmb3JtKTsgfSwgMCk7CiAgICAgICAgfQogICAgfQp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscycsIGtvLnV0aWxzKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUZvckVhY2gnLCBrby51dGlscy5hcnJheUZvckVhY2gpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5Rmlyc3QnLCBrby51dGlscy5hcnJheUZpcnN0KTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUZpbHRlcicsIGtvLnV0aWxzLmFycmF5RmlsdGVyKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUdldERpc3RpbmN0VmFsdWVzJywga28udXRpbHMuYXJyYXlHZXREaXN0aW5jdFZhbHVlcyk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlJbmRleE9mJywga28udXRpbHMuYXJyYXlJbmRleE9mKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheU1hcCcsIGtvLnV0aWxzLmFycmF5TWFwKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheVB1c2hBbGwnLCBrby51dGlscy5hcnJheVB1c2hBbGwpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmFycmF5UmVtb3ZlSXRlbScsIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbSk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZXh0ZW5kJywga28udXRpbHMuZXh0ZW5kKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5maWVsZHNJbmNsdWRlZFdpdGhKc29uUG9zdCcsIGtvLnV0aWxzLmZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0KTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5nZXRGb3JtRmllbGRzJywga28udXRpbHMuZ2V0Rm9ybUZpZWxkcyk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMucG9zdEpzb24nLCBrby51dGlscy5wb3N0SnNvbik7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMucGFyc2VKc29uJywga28udXRpbHMucGFyc2VKc29uKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcicsIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zdHJpbmdpZnlKc29uJywga28udXRpbHMuc3RyaW5naWZ5SnNvbik7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMucmFuZ2UnLCBrby51dGlscy5yYW5nZSk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzJywga28udXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzKTsKa28uZXhwb3J0U3ltYm9sKCd1dGlscy50cmlnZ2VyRXZlbnQnLCBrby51dGlscy50cmlnZ2VyRXZlbnQpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnVud3JhcE9ic2VydmFibGUnLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKTsKCmlmICghRnVuY3Rpb24ucHJvdG90eXBlWydiaW5kJ10pIHsKICAgIC8vIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kIGlzIGEgc3RhbmRhcmQgcGFydCBvZiBFQ01BU2NyaXB0IDV0aCBFZGl0aW9uIChEZWNlbWJlciAyMDA5LCBodHRwOi8vd3d3LmVjbWEtaW50ZXJuYXRpb25hbC5vcmcvcHVibGljYXRpb25zL2ZpbGVzL0VDTUEtU1QvRUNNQS0yNjIucGRmKQogICAgLy8gSW4gY2FzZSB0aGUgYnJvd3NlciBkb2Vzbid0IGltcGxlbWVudCBpdCBuYXRpdmVseSwgcHJvdmlkZSBhIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24uIFRoaXMgaW1wbGVtZW50YXRpb24gaXMgYmFzZWQgb24gdGhlIG9uZSBpbiBwcm90b3R5cGUuanMKICAgIEZ1bmN0aW9uLnByb3RvdHlwZVsnYmluZCddID0gZnVuY3Rpb24gKG9iamVjdCkgewogICAgICAgIHZhciBvcmlnaW5hbEZ1bmN0aW9uID0gdGhpcywgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyksIG9iamVjdCA9IGFyZ3Muc2hpZnQoKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxGdW5jdGlvbi5hcHBseShvYmplY3QsIGFyZ3MuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgICB9OwogICAgfTsKfQoKa28udXRpbHMuZG9tRGF0YSA9IG5ldyAoZnVuY3Rpb24gKCkgewogICAgdmFyIHVuaXF1ZUlkID0gMDsKICAgIHZhciBkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lID0gIl9fa29fXyIgKyAobmV3IERhdGUpLmdldFRpbWUoKTsKICAgIHZhciBkYXRhU3RvcmUgPSB7fTsKICAgIHJldHVybiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAobm9kZSwga2V5KSB7CiAgICAgICAgICAgIHZhciBhbGxEYXRhRm9yTm9kZSA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0QWxsKG5vZGUsIGZhbHNlKTsKICAgICAgICAgICAgcmV0dXJuIGFsbERhdGFGb3JOb2RlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBhbGxEYXRhRm9yTm9kZVtrZXldOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiAobm9kZSwga2V5LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHdlIGRvbid0IGFjdHVhbGx5IGNyZWF0ZSBhIG5ldyBkb21EYXRhIGtleSBpZiB3ZSBhcmUgYWN0dWFsbHkgZGVsZXRpbmcgYSB2YWx1ZQogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmRvbURhdGEuZ2V0QWxsKG5vZGUsIGZhbHNlKSA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYWxsRGF0YUZvck5vZGUgPSBrby51dGlscy5kb21EYXRhLmdldEFsbChub2RlLCB0cnVlKTsKICAgICAgICAgICAgYWxsRGF0YUZvck5vZGVba2V5XSA9IHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgZ2V0QWxsOiBmdW5jdGlvbiAobm9kZSwgY3JlYXRlSWZOb3RGb3VuZCkgewogICAgICAgICAgICB2YXIgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgdmFyIGhhc0V4aXN0aW5nRGF0YVN0b3JlID0gZGF0YVN0b3JlS2V5ICYmIChkYXRhU3RvcmVLZXkgIT09ICJudWxsIik7CiAgICAgICAgICAgIGlmICghaGFzRXhpc3RpbmdEYXRhU3RvcmUpIHsKICAgICAgICAgICAgICAgIGlmICghY3JlYXRlSWZOb3RGb3VuZCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXSA9ICJrbyIgKyB1bmlxdWVJZCsrOwogICAgICAgICAgICAgICAgZGF0YVN0b3JlW2RhdGFTdG9yZUtleV0gPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGF0YVN0b3JlW2RhdGFTdG9yZUtleV07CiAgICAgICAgfSwKICAgICAgICBjbGVhcjogZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgdmFyIGRhdGFTdG9yZUtleSA9IG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV07CiAgICAgICAgICAgIGlmIChkYXRhU3RvcmVLZXkpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhU3RvcmVbZGF0YVN0b3JlS2V5XTsKICAgICAgICAgICAgICAgIG5vZGVbZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZV0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21EYXRhJywga28udXRpbHMuZG9tRGF0YSk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tRGF0YS5jbGVhcicsIGtvLnV0aWxzLmRvbURhdGEuY2xlYXIpOyAvLyBFeHBvcnRpbmcgb25seSBzbyBzcGVjcyBjYW4gY2xlYXIgdXAgYWZ0ZXIgdGhlbXNlbHZlcyBmdWxseQoKa28udXRpbHMuZG9tTm9kZURpc3Bvc2FsID0gbmV3IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgZG9tRGF0YUtleSA9ICJfX2tvX2RvbU5vZGVEaXNwb3NhbF9fIiArIChuZXcgRGF0ZSkuZ2V0VGltZSgpOwogICAgdmFyIGNsZWFuYWJsZU5vZGVUeXBlcyA9IHsgMTogdHJ1ZSwgODogdHJ1ZSwgOTogdHJ1ZSB9OyAgICAgICAvLyBFbGVtZW50LCBDb21tZW50LCBEb2N1bWVudAogICAgdmFyIGNsZWFuYWJsZU5vZGVUeXBlc1dpdGhEZXNjZW5kYW50cyA9IHsgMTogdHJ1ZSwgOTogdHJ1ZSB9OyAvLyBFbGVtZW50LCBEb2N1bWVudAoKICAgIGZ1bmN0aW9uIGdldERpc3Bvc2VDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUsIGNyZWF0ZUlmTm90Rm91bmQpIHsKICAgICAgICB2YXIgYWxsRGlzcG9zZUNhbGxiYWNrcyA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KG5vZGUsIGRvbURhdGFLZXkpOwogICAgICAgIGlmICgoYWxsRGlzcG9zZUNhbGxiYWNrcyA9PT0gdW5kZWZpbmVkKSAmJiBjcmVhdGVJZk5vdEZvdW5kKSB7CiAgICAgICAgICAgIGFsbERpc3Bvc2VDYWxsYmFja3MgPSBbXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgZG9tRGF0YUtleSwgYWxsRGlzcG9zZUNhbGxiYWNrcyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhbGxEaXNwb3NlQ2FsbGJhY2tzOwogICAgfQogICAgZnVuY3Rpb24gZGVzdHJveUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSkgewogICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIGRvbURhdGFLZXksIHVuZGVmaW5lZCk7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYW5TaW5nbGVOb2RlKG5vZGUpIHsKICAgICAgICAvLyBSdW4gYWxsIHRoZSBkaXNwb3NlIGNhbGxiYWNrcwogICAgICAgIHZhciBjYWxsYmFja3MgPSBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBmYWxzZSk7CiAgICAgICAgaWYgKGNhbGxiYWNrcykgewogICAgICAgICAgICBjYWxsYmFja3MgPSBjYWxsYmFja3Muc2xpY2UoMCk7IC8vIENsb25lLCBhcyB0aGUgYXJyYXkgbWF5IGJlIG1vZGlmaWVkIGR1cmluZyBpdGVyYXRpb24gKHR5cGljYWxseSwgY2FsbGJhY2tzIHdpbGwgcmVtb3ZlIHRoZW1zZWx2ZXMpCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2FsbGJhY2tzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgY2FsbGJhY2tzW2ldKG5vZGUpOwogICAgICAgIH0KCiAgICAgICAgLy8gQWxzbyBlcmFzZSB0aGUgRE9NIGRhdGEKICAgICAgICBrby51dGlscy5kb21EYXRhLmNsZWFyKG5vZGUpOwoKICAgICAgICAvLyBTcGVjaWFsIHN1cHBvcnQgZm9yIGpRdWVyeSBoZXJlIGJlY2F1c2UgaXQncyBzbyBjb21tb25seSB1c2VkLgogICAgICAgIC8vIE1hbnkgalF1ZXJ5IHBsdWdpbnMgKGluY2x1ZGluZyBqcXVlcnkudG1wbCkgc3RvcmUgZGF0YSB1c2luZyBqUXVlcnkncyBlcXVpdmFsZW50IG9mIGRvbURhdGEKICAgICAgICAvLyBzbyBub3RpZnkgaXQgdG8gdGVhciBkb3duIGFueSByZXNvdXJjZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBub2RlICYgZGVzY2VuZGFudHMgaGVyZS4KICAgICAgICBpZiAoKHR5cGVvZiBqUXVlcnkgPT0gImZ1bmN0aW9uIikgJiYgKHR5cGVvZiBqUXVlcnlbJ2NsZWFuRGF0YSddID09ICJmdW5jdGlvbiIpKQogICAgICAgICAgICBqUXVlcnlbJ2NsZWFuRGF0YSddKFtub2RlXSk7CgogICAgICAgIC8vIEFsc28gY2xlYXIgYW55IGltbWVkaWF0ZS1jaGlsZCBjb21tZW50IG5vZGVzLCBhcyB0aGVzZSB3b3VsZG4ndCBoYXZlIGJlZW4gZm91bmQgYnkKICAgICAgICAvLyBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgaW4gY2xlYW5Ob2RlKCkgKGNvbW1lbnQgbm9kZXMgYXJlbid0IGVsZW1lbnRzKQogICAgICAgIGlmIChjbGVhbmFibGVOb2RlVHlwZXNXaXRoRGVzY2VuZGFudHNbbm9kZS5ub2RlVHlwZV0pCiAgICAgICAgICAgIGNsZWFuSW1tZWRpYXRlQ29tbWVudFR5cGVDaGlsZHJlbihub2RlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjbGVhbkltbWVkaWF0ZUNvbW1lbnRUeXBlQ2hpbGRyZW4obm9kZVdpdGhDaGlsZHJlbikgewogICAgICAgIHZhciBjaGlsZCwgbmV4dENoaWxkID0gbm9kZVdpdGhDaGlsZHJlbi5maXJzdENoaWxkOwogICAgICAgIHdoaWxlIChjaGlsZCA9IG5leHRDaGlsZCkgewogICAgICAgICAgICBuZXh0Q2hpbGQgPSBjaGlsZC5uZXh0U2libGluZzsKICAgICAgICAgICAgaWYgKGNoaWxkLm5vZGVUeXBlID09PSA4KQogICAgICAgICAgICAgICAgY2xlYW5TaW5nbGVOb2RlKGNoaWxkKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBhZGREaXNwb3NlQ2FsbGJhY2sgOiBmdW5jdGlvbihub2RlLCBjYWxsYmFjaykgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbGxiYWNrIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICAgICAgICBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCB0cnVlKS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICByZW1vdmVEaXNwb3NlQ2FsbGJhY2sgOiBmdW5jdGlvbihub2RlLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgY2FsbGJhY2tzQ29sbGVjdGlvbiA9IGdldERpc3Bvc2VDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUsIGZhbHNlKTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrc0NvbGxlY3Rpb24pIHsKICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbShjYWxsYmFja3NDb2xsZWN0aW9uLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tzQ29sbGVjdGlvbi5sZW5ndGggPT0gMCkKICAgICAgICAgICAgICAgICAgICBkZXN0cm95Q2FsbGJhY2tzQ29sbGVjdGlvbihub2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGNsZWFuTm9kZSA6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgLy8gRmlyc3QgY2xlYW4gdGhpcyBub2RlLCB3aGVyZSBhcHBsaWNhYmxlCiAgICAgICAgICAgIGlmIChjbGVhbmFibGVOb2RlVHlwZXNbbm9kZS5ub2RlVHlwZV0pIHsKICAgICAgICAgICAgICAgIGNsZWFuU2luZ2xlTm9kZShub2RlKTsKCiAgICAgICAgICAgICAgICAvLyAuLi4gdGhlbiBpdHMgZGVzY2VuZGFudHMsIHdoZXJlIGFwcGxpY2FibGUKICAgICAgICAgICAgICAgIGlmIChjbGVhbmFibGVOb2RlVHlwZXNXaXRoRGVzY2VuZGFudHNbbm9kZS5ub2RlVHlwZV0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDbG9uZSB0aGUgZGVzY2VuZGFudHMgbGlzdCBpbiBjYXNlIGl0IGNoYW5nZXMgZHVyaW5nIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgIHZhciBkZXNjZW5kYW50cyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UHVzaEFsbChkZXNjZW5kYW50cywgbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGRlc2NlbmRhbnRzLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYW5TaW5nbGVOb2RlKGRlc2NlbmRhbnRzW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHJlbW92ZU5vZGUgOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIGtvLmNsZWFuTm9kZShub2RlKTsKICAgICAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkKICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsKICAgICAgICB9CiAgICB9Cn0pKCk7CmtvLmNsZWFuTm9kZSA9IGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5jbGVhbk5vZGU7IC8vIFNob3J0aGFuZCBuYW1lIGZvciBjb252ZW5pZW5jZQprby5yZW1vdmVOb2RlID0ga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLnJlbW92ZU5vZGU7IC8vIFNob3J0aGFuZCBuYW1lIGZvciBjb252ZW5pZW5jZQprby5leHBvcnRTeW1ib2woJ2NsZWFuTm9kZScsIGtvLmNsZWFuTm9kZSk7CmtvLmV4cG9ydFN5bWJvbCgncmVtb3ZlTm9kZScsIGtvLnJlbW92ZU5vZGUpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbU5vZGVEaXNwb3NhbCcsIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbCk7CmtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjaycsIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5hZGREaXNwb3NlQ2FsbGJhY2spOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVEaXNwb3NlQ2FsbGJhY2snLCBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlRGlzcG9zZUNhbGxiYWNrKTsKKGZ1bmN0aW9uICgpIHsKICAgIHZhciBsZWFkaW5nQ29tbWVudFJlZ2V4ID0gL14oXHMqKTwhLS0oLio/KS0tPi87CgogICAgZnVuY3Rpb24gc2ltcGxlSHRtbFBhcnNlKGh0bWwpIHsKICAgICAgICAvLyBCYXNlZCBvbiBqUXVlcnkncyAiY2xlYW4iIGZ1bmN0aW9uLCBidXQgb25seSBhY2NvdW50aW5nIGZvciB0YWJsZS1yZWxhdGVkIGVsZW1lbnRzLgogICAgICAgIC8vIElmIHlvdSBoYXZlIHJlZmVyZW5jZWQgalF1ZXJ5LCB0aGlzIHdvbid0IGJlIHVzZWQgYW55d2F5IC0gS08gd2lsbCB1c2UgalF1ZXJ5J3MgImNsZWFuIiBmdW5jdGlvbiBkaXJlY3RseQoKICAgICAgICAvLyBOb3RlIHRoYXQgdGhlcmUncyBzdGlsbCBhbiBpc3N1ZSBpbiBJRSA8IDkgd2hlcmVieSBpdCB3aWxsIGRpc2NhcmQgY29tbWVudCBub2RlcyB0aGF0IGFyZSB0aGUgZmlyc3QgY2hpbGQgb2YKICAgICAgICAvLyBhIGRlc2NlbmRhbnQgbm9kZS4gRm9yIGV4YW1wbGU6ICI8ZGl2PjwhLS0gbXljb21tZW50IC0tPmFiYzwvZGl2PiIgd2lsbCBnZXQgcGFyc2VkIGFzICI8ZGl2PmFiYzwvZGl2PiIKICAgICAgICAvLyBUaGlzIHdvbid0IGFmZmVjdCBhbnlvbmUgd2hvIGhhcyByZWZlcmVuY2VkIGpRdWVyeSwgYW5kIHRoZXJlJ3MgYWx3YXlzIHRoZSB3b3JrYXJvdW5kIG9mIGluc2VydGluZyBhIGR1bW15IG5vZGUKICAgICAgICAvLyAocG9zc2libHkgYSB0ZXh0IG5vZGUpIGluIGZyb250IG9mIHRoZSBjb21tZW50LiBTbywgS08gZG9lcyBub3QgYXR0ZW1wdCB0byB3b3JrYXJvdW5kIHRoaXMgSUUgaXNzdWUgYXV0b21hdGljYWxseSBhdCBwcmVzZW50LgoKICAgICAgICAvLyBUcmltIHdoaXRlc3BhY2UsIG90aGVyd2lzZSBpbmRleE9mIHdvbid0IHdvcmsgYXMgZXhwZWN0ZWQKICAgICAgICB2YXIgdGFncyA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oaHRtbCkudG9Mb3dlckNhc2UoKSwgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgogICAgICAgIC8vIEZpbmRzIHRoZSBmaXJzdCBtYXRjaCBmcm9tIHRoZSBsZWZ0IGNvbHVtbiwgYW5kIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgIndyYXAiIGRhdGEgZnJvbSB0aGUgcmlnaHQgY29sdW1uCiAgICAgICAgdmFyIHdyYXAgPSB0YWdzLm1hdGNoKC9ePCh0aGVhZHx0Ym9keXx0Zm9vdCkvKSAgICAgICAgICAgICAgJiYgWzEsICI8dGFibGU+IiwgIjwvdGFibGU+Il0gfHwKICAgICAgICAgICAgICAgICAgICF0YWdzLmluZGV4T2YoIjx0ciIpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBbMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iXSB8fAogICAgICAgICAgICAgICAgICAgKCF0YWdzLmluZGV4T2YoIjx0ZCIpIHx8ICF0YWdzLmluZGV4T2YoIjx0aCIpKSAgICYmIFszLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiJdIHx8CiAgICAgICAgICAgICAgICAgICAvKiBhbnl0aGluZyBlbHNlICovICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWzAsICIiLCAiIl07CgogICAgICAgIC8vIEdvIHRvIGh0bWwgYW5kIGJhY2ssIHRoZW4gcGVlbCBvZmYgZXh0cmEgd3JhcHBlcnMKICAgICAgICAvLyBOb3RlIHRoYXQgd2UgYWx3YXlzIHByZWZpeCB3aXRoIHNvbWUgZHVtbXkgdGV4dCwgYmVjYXVzZSBvdGhlcndpc2UsIElFPDkgd2lsbCBzdHJpcCBvdXQgbGVhZGluZyBjb21tZW50IG5vZGVzIGluIGRlc2NlbmRhbnRzLiBUb3RhbCBtYWRuZXNzLgogICAgICAgIHZhciBtYXJrdXAgPSAiaWdub3JlZDxkaXY+IiArIHdyYXBbMV0gKyBodG1sICsgd3JhcFsyXSArICI8L2Rpdj4iOwogICAgICAgIGlmICh0eXBlb2Ygd2luZG93Wydpbm5lclNoaXYnXSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZCh3aW5kb3dbJ2lubmVyU2hpdiddKG1hcmt1cCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSBtYXJrdXA7CiAgICAgICAgfQoKICAgICAgICAvLyBNb3ZlIHRvIHRoZSByaWdodCBkZXB0aAogICAgICAgIHdoaWxlICh3cmFwWzBdLS0pCiAgICAgICAgICAgIGRpdiA9IGRpdi5sYXN0Q2hpbGQ7CgogICAgICAgIHJldHVybiBrby51dGlscy5tYWtlQXJyYXkoZGl2Lmxhc3RDaGlsZC5jaGlsZE5vZGVzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBqUXVlcnlIdG1sUGFyc2UoaHRtbCkgewogICAgICAgIHZhciBlbGVtcyA9IGpRdWVyeVsnY2xlYW4nXShbaHRtbF0pOwoKICAgICAgICAvLyBBcyBvZiBqUXVlcnkgMS43LjEsIGpRdWVyeSBwYXJzZXMgdGhlIEhUTUwgYnkgYXBwZW5kaW5nIGl0IHRvIHNvbWUgZHVtbXkgcGFyZW50IG5vZGVzIGhlbGQgaW4gYW4gaW4tbWVtb3J5IGRvY3VtZW50IGZyYWdtZW50LgogICAgICAgIC8vIFVuZm9ydHVuYXRlbHksIGl0IG5ldmVyIGNsZWFycyB0aGUgZHVtbXkgcGFyZW50IG5vZGVzIGZyb20gdGhlIGRvY3VtZW50IGZyYWdtZW50LCBzbyBpdCBsZWFrcyBtZW1vcnkgb3ZlciB0aW1lLgogICAgICAgIC8vIEZpeCB0aGlzIGJ5IGZpbmRpbmcgdGhlIHRvcC1tb3N0IGR1bW15IHBhcmVudCBlbGVtZW50LCBhbmQgZGV0YWNoaW5nIGl0IGZyb20gaXRzIG93bmVyIGZyYWdtZW50LgogICAgICAgIGlmIChlbGVtcyAmJiBlbGVtc1swXSkgewogICAgICAgICAgICAvLyBGaW5kIHRoZSB0b3AtbW9zdCBwYXJlbnQgZWxlbWVudCB0aGF0J3MgYSBkaXJlY3QgY2hpbGQgb2YgYSBkb2N1bWVudCBmcmFnbWVudAogICAgICAgICAgICB2YXIgZWxlbSA9IGVsZW1zWzBdOwogICAgICAgICAgICB3aGlsZSAoZWxlbS5wYXJlbnROb2RlICYmIGVsZW0ucGFyZW50Tm9kZS5ub2RlVHlwZSAhPT0gMTEgLyogaS5lLiwgRG9jdW1lbnRGcmFnbWVudCAqLykKICAgICAgICAgICAgICAgIGVsZW0gPSBlbGVtLnBhcmVudE5vZGU7CiAgICAgICAgICAgIC8vIC4uLiB0aGVuIGRldGFjaCBpdAogICAgICAgICAgICBpZiAoZWxlbS5wYXJlbnROb2RlKQogICAgICAgICAgICAgICAgZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGVsZW1zOwogICAgfQoKICAgIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50ID0gZnVuY3Rpb24oaHRtbCkgewogICAgICAgIHJldHVybiB0eXBlb2YgalF1ZXJ5ICE9ICd1bmRlZmluZWQnID8galF1ZXJ5SHRtbFBhcnNlKGh0bWwpICAgLy8gQXMgYmVsb3csIGJlbmVmaXQgZnJvbSBqUXVlcnkncyBvcHRpbWlzYXRpb25zIHdoZXJlIHBvc3NpYmxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBzaW1wbGVIdG1sUGFyc2UoaHRtbCk7ICAvLyAuLi4gb3RoZXJ3aXNlLCB0aGlzIHNpbXBsZSBsb2dpYyB3aWxsIGRvIGluIG1vc3QgY29tbW9uIGNhc2VzLgogICAgfTsKCiAgICBrby51dGlscy5zZXRIdG1sID0gZnVuY3Rpb24obm9kZSwgaHRtbCkgewogICAgICAgIGtvLnV0aWxzLmVtcHR5RG9tTm9kZShub2RlKTsKCiAgICAgICAgaWYgKChodG1sICE9PSBudWxsKSAmJiAoaHRtbCAhPT0gdW5kZWZpbmVkKSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGh0bWwgIT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICBodG1sID0gaHRtbC50b1N0cmluZygpOwoKICAgICAgICAgICAgLy8galF1ZXJ5IGNvbnRhaW5zIGEgbG90IG9mIHNvcGhpc3RpY2F0ZWQgY29kZSB0byBwYXJzZSBhcmJpdHJhcnkgSFRNTCBmcmFnbWVudHMsCiAgICAgICAgICAgIC8vIGZvciBleGFtcGxlIDx0cj4gZWxlbWVudHMgd2hpY2ggYXJlIG5vdCBub3JtYWxseSBhbGxvd2VkIHRvIGV4aXN0IG9uIHRoZWlyIG93bi4KICAgICAgICAgICAgLy8gSWYgeW91J3ZlIHJlZmVyZW5jZWQgalF1ZXJ5IHdlJ2xsIHVzZSB0aGF0IHJhdGhlciB0aGFuIGR1cGxpY2F0aW5nIGl0cyBjb2RlLgogICAgICAgICAgICBpZiAodHlwZW9mIGpRdWVyeSAhPSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgalF1ZXJ5KG5vZGUpWydodG1sJ10oaHRtbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAuLi4gb3RoZXJ3aXNlLCB1c2UgS08ncyBvd24gcGFyc2luZyBsb2dpYy4KICAgICAgICAgICAgICAgIHZhciBwYXJzZWROb2RlcyA9IGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KGh0bWwpOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJzZWROb2Rlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKHBhcnNlZE5vZGVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3V0aWxzLnBhcnNlSHRtbEZyYWdtZW50Jywga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQpOwprby5leHBvcnRTeW1ib2woJ3V0aWxzLnNldEh0bWwnLCBrby51dGlscy5zZXRIdG1sKTsKCmtvLm1lbW9pemF0aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBtZW1vcyA9IHt9OwoKICAgIGZ1bmN0aW9uIHJhbmRvbU1heDhIZXhDaGFycygpIHsKICAgICAgICByZXR1cm4gKCgoMSArIE1hdGgucmFuZG9tKCkpICogMHgxMDAwMDAwMDApIHwgMCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygxKTsKICAgIH0KICAgIGZ1bmN0aW9uIGdlbmVyYXRlUmFuZG9tSWQoKSB7CiAgICAgICAgcmV0dXJuIHJhbmRvbU1heDhIZXhDaGFycygpICsgcmFuZG9tTWF4OEhleENoYXJzKCk7CiAgICB9CiAgICBmdW5jdGlvbiBmaW5kTWVtb05vZGVzKHJvb3ROb2RlLCBhcHBlbmRUb0FycmF5KSB7CiAgICAgICAgaWYgKCFyb290Tm9kZSkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIGlmIChyb290Tm9kZS5ub2RlVHlwZSA9PSA4KSB7CiAgICAgICAgICAgIHZhciBtZW1vSWQgPSBrby5tZW1vaXphdGlvbi5wYXJzZU1lbW9UZXh0KHJvb3ROb2RlLm5vZGVWYWx1ZSk7CiAgICAgICAgICAgIGlmIChtZW1vSWQgIT0gbnVsbCkKICAgICAgICAgICAgICAgIGFwcGVuZFRvQXJyYXkucHVzaCh7IGRvbU5vZGU6IHJvb3ROb2RlLCBtZW1vSWQ6IG1lbW9JZCB9KTsKICAgICAgICB9IGVsc2UgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09IDEpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkTm9kZXMgPSByb290Tm9kZS5jaGlsZE5vZGVzLCBqID0gY2hpbGROb2Rlcy5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICAgICAgICAgICAgICBmaW5kTWVtb05vZGVzKGNoaWxkTm9kZXNbaV0sIGFwcGVuZFRvQXJyYXkpOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIG1lbW9pemU6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIllvdSBjYW4gb25seSBwYXNzIGEgZnVuY3Rpb24gdG8ga28ubWVtb2l6YXRpb24ubWVtb2l6ZSgpIik7CiAgICAgICAgICAgIHZhciBtZW1vSWQgPSBnZW5lcmF0ZVJhbmRvbUlkKCk7CiAgICAgICAgICAgIG1lbW9zW21lbW9JZF0gPSBjYWxsYmFjazsKICAgICAgICAgICAgcmV0dXJuICI8IS0tW2tvX21lbW86IiArIG1lbW9JZCArICJdLS0+IjsKICAgICAgICB9LAoKICAgICAgICB1bm1lbW9pemU6IGZ1bmN0aW9uIChtZW1vSWQsIGNhbGxiYWNrUGFyYW1zKSB7CiAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IG1lbW9zW21lbW9JZF07CiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDb3VsZG4ndCBmaW5kIGFueSBtZW1vIHdpdGggSUQgIiArIG1lbW9JZCArICIuIFBlcmhhcHMgaXQncyBhbHJlYWR5IGJlZW4gdW5tZW1vaXplZC4iKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KG51bGwsIGNhbGxiYWNrUGFyYW1zIHx8IFtdKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmFsbHkgeyBkZWxldGUgbWVtb3NbbWVtb0lkXTsgfQogICAgICAgIH0sCgogICAgICAgIHVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50czogZnVuY3Rpb24gKGRvbU5vZGUsIGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSkgewogICAgICAgICAgICB2YXIgbWVtb3MgPSBbXTsKICAgICAgICAgICAgZmluZE1lbW9Ob2Rlcyhkb21Ob2RlLCBtZW1vcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbWVtb3MubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IG1lbW9zW2ldLmRvbU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgY29tYmluZWRQYXJhbXMgPSBbbm9kZV07CiAgICAgICAgICAgICAgICBpZiAoZXh0cmFDYWxsYmFja1BhcmFtc0FycmF5KQogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UHVzaEFsbChjb21iaW5lZFBhcmFtcywgZXh0cmFDYWxsYmFja1BhcmFtc0FycmF5KTsKICAgICAgICAgICAgICAgIGtvLm1lbW9pemF0aW9uLnVubWVtb2l6ZShtZW1vc1tpXS5tZW1vSWQsIGNvbWJpbmVkUGFyYW1zKTsKICAgICAgICAgICAgICAgIG5vZGUubm9kZVZhbHVlID0gIiI7IC8vIE5ldXRlciB0aGlzIG5vZGUgc28gd2UgZG9uJ3QgdHJ5IHRvIHVubWVtb2l6ZSBpdCBhZ2FpbgogICAgICAgICAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkKICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7IC8vIElmIHBvc3NpYmxlLCBlcmFzZSBpdCB0b3RhbGx5IChub3QgYWx3YXlzIHBvc3NpYmxlIC0gc29tZW9uZSBlbHNlIG1pZ2h0IGp1c3QgaG9sZCBhIHJlZmVyZW5jZSB0byBpdCB0aGVuIGNhbGwgdW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzIGFnYWluKQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcGFyc2VNZW1vVGV4dDogZnVuY3Rpb24gKG1lbW9UZXh0KSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG1lbW9UZXh0Lm1hdGNoKC9eXFtrb19tZW1vXDooLio/KVxdJC8pOwogICAgICAgICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IG51bGw7CiAgICAgICAgfQogICAgfTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24nLCBrby5tZW1vaXphdGlvbik7CmtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24ubWVtb2l6ZScsIGtvLm1lbW9pemF0aW9uLm1lbW9pemUpOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnVubWVtb2l6ZScsIGtvLm1lbW9pemF0aW9uLnVubWVtb2l6ZSk7CmtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24ucGFyc2VNZW1vVGV4dCcsIGtvLm1lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQpOwprby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLnVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cycsIGtvLm1lbW9pemF0aW9uLnVubWVtb2l6ZURvbU5vZGVBbmREZXNjZW5kYW50cyk7CmtvLmV4dGVuZGVycyA9IHsKICAgICd0aHJvdHRsZSc6IGZ1bmN0aW9uKHRhcmdldCwgdGltZW91dCkgewogICAgICAgIC8vIFRocm90dGxpbmcgbWVhbnMgdHdvIHRoaW5nczoKCiAgICAgICAgLy8gKDEpIEZvciBkZXBlbmRlbnQgb2JzZXJ2YWJsZXMsIHdlIHRocm90dGxlICpldmFsdWF0aW9ucyogc28gdGhhdCwgbm8gbWF0dGVyIGhvdyBmYXN0IGl0cyBkZXBlbmRlbmNpZXMKICAgICAgICAvLyAgICAgbm90aWZ5IHVwZGF0ZXMsIHRoZSB0YXJnZXQgZG9lc24ndCByZS1ldmFsdWF0ZSAoYW5kIGhlbmNlIGRvZXNuJ3Qgbm90aWZ5KSBmYXN0ZXIgdGhhbiBhIGNlcnRhaW4gcmF0ZQogICAgICAgIHRhcmdldFsndGhyb3R0bGVFdmFsdWF0aW9uJ10gPSB0aW1lb3V0OwoKICAgICAgICAvLyAoMikgRm9yIHdyaXRhYmxlIHRhcmdldHMgKG9ic2VydmFibGVzLCBvciB3cml0YWJsZSBkZXBlbmRlbnQgb2JzZXJ2YWJsZXMpLCB3ZSB0aHJvdHRsZSAqd3JpdGVzKgogICAgICAgIC8vICAgICBzbyB0aGUgdGFyZ2V0IGNhbm5vdCBjaGFuZ2UgdmFsdWUgc3luY2hyb25vdXNseSBvciBmYXN0ZXIgdGhhbiBhIGNlcnRhaW4gcmF0ZQogICAgICAgIHZhciB3cml0ZVRpbWVvdXRJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgcmV0dXJuIGtvLmRlcGVuZGVudE9ic2VydmFibGUoewogICAgICAgICAgICAncmVhZCc6IHRhcmdldCwKICAgICAgICAgICAgJ3dyaXRlJzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh3cml0ZVRpbWVvdXRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB3cml0ZVRpbWVvdXRJbnN0YW5jZSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0KHZhbHVlKTsKICAgICAgICAgICAgICAgIH0sIHRpbWVvdXQpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAoKICAgICdub3RpZnknOiBmdW5jdGlvbih0YXJnZXQsIG5vdGlmeVdoZW4pIHsKICAgICAgICB0YXJnZXRbImVxdWFsaXR5Q29tcGFyZXIiXSA9IG5vdGlmeVdoZW4gPT0gImFsd2F5cyIKICAgICAgICAgICAgPyBmdW5jdGlvbigpIHsgcmV0dXJuIGZhbHNlIH0gLy8gVHJlYXQgYWxsIHZhbHVlcyBhcyBub3QgZXF1YWwKICAgICAgICAgICAgOiBrby5vYnNlcnZhYmxlWyJmbiJdWyJlcXVhbGl0eUNvbXBhcmVyIl07CiAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KfTsKCmZ1bmN0aW9uIGFwcGx5RXh0ZW5kZXJzKHJlcXVlc3RlZEV4dGVuZGVycykgewogICAgdmFyIHRhcmdldCA9IHRoaXM7CiAgICBpZiAocmVxdWVzdGVkRXh0ZW5kZXJzKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHJlcXVlc3RlZEV4dGVuZGVycykgewogICAgICAgICAgICB2YXIgZXh0ZW5kZXJIYW5kbGVyID0ga28uZXh0ZW5kZXJzW2tleV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgZXh0ZW5kZXJIYW5kbGVyID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHRhcmdldCA9IGV4dGVuZGVySGFuZGxlcih0YXJnZXQsIHJlcXVlc3RlZEV4dGVuZGVyc1trZXldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0YXJnZXQ7Cn0KCmtvLmV4cG9ydFN5bWJvbCgnZXh0ZW5kZXJzJywga28uZXh0ZW5kZXJzKTsKCmtvLnN1YnNjcmlwdGlvbiA9IGZ1bmN0aW9uICh0YXJnZXQsIGNhbGxiYWNrLCBkaXNwb3NlQ2FsbGJhY2spIHsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgdGhpcy5kaXNwb3NlQ2FsbGJhY2sgPSBkaXNwb3NlQ2FsbGJhY2s7CiAgICBrby5leHBvcnRQcm9wZXJ0eSh0aGlzLCAnZGlzcG9zZScsIHRoaXMuZGlzcG9zZSk7Cn07CmtvLnN1YnNjcmlwdGlvbi5wcm90b3R5cGUuZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuaXNEaXNwb3NlZCA9IHRydWU7CiAgICB0aGlzLmRpc3Bvc2VDYWxsYmFjaygpOwp9OwoKa28uc3Vic2NyaWJhYmxlID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fc3Vic2NyaXB0aW9ucyA9IHt9OwoKICAgIGtvLnV0aWxzLmV4dGVuZCh0aGlzLCBrby5zdWJzY3JpYmFibGVbJ2ZuJ10pOwogICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ3N1YnNjcmliZScsIHRoaXMuc3Vic2NyaWJlKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KHRoaXMsICdleHRlbmQnLCB0aGlzLmV4dGVuZCk7CiAgICBrby5leHBvcnRQcm9wZXJ0eSh0aGlzLCAnZ2V0U3Vic2NyaXB0aW9uc0NvdW50JywgdGhpcy5nZXRTdWJzY3JpcHRpb25zQ291bnQpOwp9Cgp2YXIgZGVmYXVsdEV2ZW50ID0gImNoYW5nZSI7Cgprby5zdWJzY3JpYmFibGVbJ2ZuJ10gPSB7CiAgICBzdWJzY3JpYmU6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGV2ZW50KSB7CiAgICAgICAgZXZlbnQgPSBldmVudCB8fCBkZWZhdWx0RXZlbnQ7CiAgICAgICAgdmFyIGJvdW5kQ2FsbGJhY2sgPSBjYWxsYmFja1RhcmdldCA/IGNhbGxiYWNrLmJpbmQoY2FsbGJhY2tUYXJnZXQpIDogY2FsbGJhY2s7CgogICAgICAgIHZhciBzdWJzY3JpcHRpb24gPSBuZXcga28uc3Vic2NyaXB0aW9uKHRoaXMsIGJvdW5kQ2FsbGJhY2ssIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlSZW1vdmVJdGVtKHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLCBzdWJzY3JpcHRpb24pOwogICAgICAgIH0uYmluZCh0aGlzKSk7CgogICAgICAgIGlmICghdGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0pCiAgICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdID0gW107CiAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0ucHVzaChzdWJzY3JpcHRpb24pOwogICAgICAgIHJldHVybiBzdWJzY3JpcHRpb247CiAgICB9LAoKICAgICJub3RpZnlTdWJzY3JpYmVycyI6IGZ1bmN0aW9uICh2YWx1ZVRvTm90aWZ5LCBldmVudCkgewogICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgZGVmYXVsdEV2ZW50OwogICAgICAgIGlmICh0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50XSkgewogICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2godGhpcy5fc3Vic2NyaXB0aW9uc1tldmVudF0uc2xpY2UoMCksIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgIC8vIEluIGNhc2UgYSBzdWJzY3JpcHRpb24gd2FzIGRpc3Bvc2VkIGR1cmluZyB0aGUgYXJyYXlGb3JFYWNoIGN5Y2xlLCBjaGVjawogICAgICAgICAgICAgICAgLy8gZm9yIGlzRGlzcG9zZWQgb24gZWFjaCBzdWJzY3JpcHRpb24gYmVmb3JlIGludm9raW5nIGl0cyBjYWxsYmFjawogICAgICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbiAmJiAoc3Vic2NyaXB0aW9uLmlzRGlzcG9zZWQgIT09IHRydWUpKQogICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5jYWxsYmFjayh2YWx1ZVRvTm90aWZ5KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRTdWJzY3JpcHRpb25zQ291bnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdG90YWwgPSAwOwogICAgICAgIGZvciAodmFyIGV2ZW50TmFtZSBpbiB0aGlzLl9zdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9zdWJzY3JpcHRpb25zLmhhc093blByb3BlcnR5KGV2ZW50TmFtZSkpCiAgICAgICAgICAgICAgICB0b3RhbCArPSB0aGlzLl9zdWJzY3JpcHRpb25zW2V2ZW50TmFtZV0ubGVuZ3RoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG90YWw7CiAgICB9LAoKICAgIGV4dGVuZDogYXBwbHlFeHRlbmRlcnMKfTsKCgprby5pc1N1YnNjcmliYWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgcmV0dXJuIHR5cGVvZiBpbnN0YW5jZS5zdWJzY3JpYmUgPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2VbIm5vdGlmeVN1YnNjcmliZXJzIl0gPT0gImZ1bmN0aW9uIjsKfTsKCmtvLmV4cG9ydFN5bWJvbCgnc3Vic2NyaWJhYmxlJywga28uc3Vic2NyaWJhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc1N1YnNjcmliYWJsZScsIGtvLmlzU3Vic2NyaWJhYmxlKTsKCmtvLmRlcGVuZGVuY3lEZXRlY3Rpb24gPSAoZnVuY3Rpb24gKCkgewogICAgdmFyIF9mcmFtZXMgPSBbXTsKCiAgICByZXR1cm4gewogICAgICAgIGJlZ2luOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgX2ZyYW1lcy5wdXNoKHsgY2FsbGJhY2s6IGNhbGxiYWNrLCBkaXN0aW5jdERlcGVuZGVuY2llczpbXSB9KTsKICAgICAgICB9LAoKICAgICAgICBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgX2ZyYW1lcy5wb3AoKTsKICAgICAgICB9LAoKICAgICAgICByZWdpc3RlckRlcGVuZGVuY3k6IGZ1bmN0aW9uIChzdWJzY3JpYmFibGUpIHsKICAgICAgICAgICAgaWYgKCFrby5pc1N1YnNjcmliYWJsZShzdWJzY3JpYmFibGUpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPbmx5IHN1YnNjcmliYWJsZSB0aGluZ3MgY2FuIGFjdCBhcyBkZXBlbmRlbmNpZXMiKTsKICAgICAgICAgICAgaWYgKF9mcmFtZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIHRvcEZyYW1lID0gX2ZyYW1lc1tfZnJhbWVzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmFycmF5SW5kZXhPZih0b3BGcmFtZS5kaXN0aW5jdERlcGVuZGVuY2llcywgc3Vic2NyaWJhYmxlKSA+PSAwKQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIHRvcEZyYW1lLmRpc3RpbmN0RGVwZW5kZW5jaWVzLnB1c2goc3Vic2NyaWJhYmxlKTsKICAgICAgICAgICAgICAgIHRvcEZyYW1lLmNhbGxiYWNrKHN1YnNjcmliYWJsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KSgpOwp2YXIgcHJpbWl0aXZlVHlwZXMgPSB7ICd1bmRlZmluZWQnOnRydWUsICdib29sZWFuJzp0cnVlLCAnbnVtYmVyJzp0cnVlLCAnc3RyaW5nJzp0cnVlIH07Cgprby5vYnNlcnZhYmxlID0gZnVuY3Rpb24gKGluaXRpYWxWYWx1ZSkgewogICAgdmFyIF9sYXRlc3RWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKCiAgICBmdW5jdGlvbiBvYnNlcnZhYmxlKCkgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAvLyBXcml0ZQoKICAgICAgICAgICAgLy8gSWdub3JlIHdyaXRlcyBpZiB0aGUgdmFsdWUgaGFzbid0IGNoYW5nZWQKICAgICAgICAgICAgaWYgKCghb2JzZXJ2YWJsZVsnZXF1YWxpdHlDb21wYXJlciddKSB8fCAhb2JzZXJ2YWJsZVsnZXF1YWxpdHlDb21wYXJlciddKF9sYXRlc3RWYWx1ZSwgYXJndW1lbnRzWzBdKSkgewogICAgICAgICAgICAgICAgb2JzZXJ2YWJsZS52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgICAgIF9sYXRlc3RWYWx1ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgICAgIGlmIChERUJVRykgb2JzZXJ2YWJsZS5fbGF0ZXN0VmFsdWUgPSBfbGF0ZXN0VmFsdWU7CiAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnZhbHVlSGFzTXV0YXRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOyAvLyBQZXJtaXRzIGNoYWluZWQgYXNzaWdubWVudHMKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIC8vIFJlYWQKICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5yZWdpc3RlckRlcGVuZGVuY3kob2JzZXJ2YWJsZSk7IC8vIFRoZSBjYWxsZXIgb25seSBuZWVkcyB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIGlmIHRoZXkgZGlkIGEgInJlYWQiIG9wZXJhdGlvbgogICAgICAgICAgICByZXR1cm4gX2xhdGVzdFZhbHVlOwogICAgICAgIH0KICAgIH0KICAgIGlmIChERUJVRykgb2JzZXJ2YWJsZS5fbGF0ZXN0VmFsdWUgPSBfbGF0ZXN0VmFsdWU7CiAgICBrby5zdWJzY3JpYmFibGUuY2FsbChvYnNlcnZhYmxlKTsKICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSk7IH0KICAgIG9ic2VydmFibGUudmFsdWVXaWxsTXV0YXRlID0gZnVuY3Rpb24gKCkgeyBvYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOyB9CiAgICBrby51dGlscy5leHRlbmQob2JzZXJ2YWJsZSwga28ub2JzZXJ2YWJsZVsnZm4nXSk7CgogICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgInZhbHVlSGFzTXV0YXRlZCIsIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICJ2YWx1ZVdpbGxNdXRhdGUiLCBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSk7CgogICAgcmV0dXJuIG9ic2VydmFibGU7Cn0KCmtvLm9ic2VydmFibGVbJ2ZuJ10gPSB7CiAgICAiZXF1YWxpdHlDb21wYXJlciI6IGZ1bmN0aW9uIHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsKGEsIGIpIHsKICAgICAgICB2YXIgb2xkVmFsdWVJc1ByaW1pdGl2ZSA9IChhID09PSBudWxsKSB8fCAodHlwZW9mKGEpIGluIHByaW1pdGl2ZVR5cGVzKTsKICAgICAgICByZXR1cm4gb2xkVmFsdWVJc1ByaW1pdGl2ZSA/IChhID09PSBiKSA6IGZhbHNlOwogICAgfQp9OwoKdmFyIHByb3RvUHJvcGVydHkgPSBrby5vYnNlcnZhYmxlLnByb3RvUHJvcGVydHkgPSAiX19rb19wcm90b19fIjsKa28ub2JzZXJ2YWJsZVsnZm4nXVtwcm90b1Byb3BlcnR5XSA9IGtvLm9ic2VydmFibGU7Cgprby5oYXNQcm90b3R5cGUgPSBmdW5jdGlvbihpbnN0YW5jZSwgcHJvdG90eXBlKSB7CiAgICBpZiAoKGluc3RhbmNlID09PSBudWxsKSB8fCAoaW5zdGFuY2UgPT09IHVuZGVmaW5lZCkgfHwgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSB1bmRlZmluZWQpKSByZXR1cm4gZmFsc2U7CiAgICBpZiAoaW5zdGFuY2VbcHJvdG9Qcm9wZXJ0eV0gPT09IHByb3RvdHlwZSkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4ga28uaGFzUHJvdG90eXBlKGluc3RhbmNlW3Byb3RvUHJvcGVydHldLCBwcm90b3R5cGUpOyAvLyBXYWxrIHRoZSBwcm90b3R5cGUgY2hhaW4KfTsKCmtvLmlzT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28ub2JzZXJ2YWJsZSk7Cn0Ka28uaXNXcml0ZWFibGVPYnNlcnZhYmxlID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CiAgICAvLyBPYnNlcnZhYmxlCiAgICBpZiAoKHR5cGVvZiBpbnN0YW5jZSA9PSAiZnVuY3Rpb24iKSAmJiBpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0ga28ub2JzZXJ2YWJsZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIC8vIFdyaXRlYWJsZSBkZXBlbmRlbnQgb2JzZXJ2YWJsZQogICAgaWYgKCh0eXBlb2YgaW5zdGFuY2UgPT0gImZ1bmN0aW9uIikgJiYgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKSAmJiAoaW5zdGFuY2UuaGFzV3JpdGVGdW5jdGlvbikpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAvLyBBbnl0aGluZyBlbHNlCiAgICByZXR1cm4gZmFsc2U7Cn0KCgprby5leHBvcnRTeW1ib2woJ29ic2VydmFibGUnLCBrby5vYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdpc09ic2VydmFibGUnLCBrby5pc09ic2VydmFibGUpOwprby5leHBvcnRTeW1ib2woJ2lzV3JpdGVhYmxlT2JzZXJ2YWJsZScsIGtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZSk7CmtvLm9ic2VydmFibGVBcnJheSA9IGZ1bmN0aW9uIChpbml0aWFsVmFsdWVzKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgLy8gWmVyby1wYXJhbWV0ZXIgY29uc3RydWN0b3IgaW5pdGlhbGl6ZXMgdG8gZW1wdHkgYXJyYXkKICAgICAgICBpbml0aWFsVmFsdWVzID0gW107CiAgICB9CiAgICBpZiAoKGluaXRpYWxWYWx1ZXMgIT09IG51bGwpICYmIChpbml0aWFsVmFsdWVzICE9PSB1bmRlZmluZWQpICYmICEoJ2xlbmd0aCcgaW4gaW5pdGlhbFZhbHVlcykpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYXJndW1lbnQgcGFzc2VkIHdoZW4gaW5pdGlhbGl6aW5nIGFuIG9ic2VydmFibGUgYXJyYXkgbXVzdCBiZSBhbiBhcnJheSwgb3IgbnVsbCwgb3IgdW5kZWZpbmVkLiIpOwoKICAgIHZhciByZXN1bHQgPSBrby5vYnNlcnZhYmxlKGluaXRpYWxWYWx1ZXMpOwogICAga28udXRpbHMuZXh0ZW5kKHJlc3VsdCwga28ub2JzZXJ2YWJsZUFycmF5WydmbiddKTsKICAgIHJldHVybiByZXN1bHQ7Cn0KCmtvLm9ic2VydmFibGVBcnJheVsnZm4nXSA9IHsKICAgICdyZW1vdmUnOiBmdW5jdGlvbiAodmFsdWVPclByZWRpY2F0ZSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CiAgICAgICAgdmFyIHJlbW92ZWRWYWx1ZXMgPSBbXTsKICAgICAgICB2YXIgcHJlZGljYXRlID0gdHlwZW9mIHZhbHVlT3JQcmVkaWNhdGUgPT0gImZ1bmN0aW9uIiA/IHZhbHVlT3JQcmVkaWNhdGUgOiBmdW5jdGlvbiAodmFsdWUpIHsgcmV0dXJuIHZhbHVlID09PSB2YWx1ZU9yUHJlZGljYXRlOyB9OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdW5kZXJseWluZ0FycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHVuZGVybHlpbmdBcnJheVtpXTsKICAgICAgICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGlmIChyZW1vdmVkVmFsdWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmFsdWVXaWxsTXV0YXRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZW1vdmVkVmFsdWVzLnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgdW5kZXJseWluZ0FycmF5LnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocmVtb3ZlZFZhbHVlcy5sZW5ndGgpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlbW92ZWRWYWx1ZXM7CiAgICB9LAoKICAgICdyZW1vdmVBbGwnOiBmdW5jdGlvbiAoYXJyYXlPZlZhbHVlcykgewogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgemVybyBhcmdzLCB3ZSByZW1vdmUgZXZlcnl0aGluZwogICAgICAgIGlmIChhcnJheU9mVmFsdWVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IHRoaXMoKTsKICAgICAgICAgICAgdmFyIGFsbFZhbHVlcyA9IHVuZGVybHlpbmdBcnJheS5zbGljZSgwKTsKICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgdW5kZXJseWluZ0FycmF5LnNwbGljZSgwLCB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoKTsKICAgICAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKICAgICAgICAgICAgcmV0dXJuIGFsbFZhbHVlczsKICAgICAgICB9CiAgICAgICAgLy8gSWYgeW91IHBhc3NlZCBhbiBhcmcsIHdlIGludGVycHJldCBpdCBhcyBhbiBhcnJheSBvZiBlbnRyaWVzIHRvIHJlbW92ZQogICAgICAgIGlmICghYXJyYXlPZlZhbHVlcykKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIHJldHVybiB0aGlzWydyZW1vdmUnXShmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZihhcnJheU9mVmFsdWVzLCB2YWx1ZSkgPj0gMDsKICAgICAgICB9KTsKICAgIH0sCgogICAgJ2Rlc3Ryb3knOiBmdW5jdGlvbiAodmFsdWVPclByZWRpY2F0ZSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CiAgICAgICAgdmFyIHByZWRpY2F0ZSA9IHR5cGVvZiB2YWx1ZU9yUHJlZGljYXRlID09ICJmdW5jdGlvbiIgPyB2YWx1ZU9yUHJlZGljYXRlIDogZnVuY3Rpb24gKHZhbHVlKSB7IHJldHVybiB2YWx1ZSA9PT0gdmFsdWVPclByZWRpY2F0ZTsgfTsKICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgIGZvciAodmFyIGkgPSB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdW5kZXJseWluZ0FycmF5W2ldOwogICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkKICAgICAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheVtpXVsiX2Rlc3Ryb3kiXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICB9LAoKICAgICdkZXN0cm95QWxsJzogZnVuY3Rpb24gKGFycmF5T2ZWYWx1ZXMpIHsKICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIHplcm8gYXJncywgd2UgZGVzdHJveSBldmVyeXRoaW5nCiAgICAgICAgaWYgKGFycmF5T2ZWYWx1ZXMgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbigpIHsgcmV0dXJuIHRydWUgfSk7CgogICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byBkZXN0cm95CiAgICAgICAgaWYgKCFhcnJheU9mVmFsdWVzKQogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZihhcnJheU9mVmFsdWVzLCB2YWx1ZSkgPj0gMDsKICAgICAgICB9KTsKICAgIH0sCgogICAgJ2luZGV4T2YnOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZih1bmRlcmx5aW5nQXJyYXksIGl0ZW0pOwogICAgfSwKCiAgICAncmVwbGFjZSc6IGZ1bmN0aW9uKG9sZEl0ZW0sIG5ld0l0ZW0pIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzWydpbmRleE9mJ10ob2xkSXRlbSk7CiAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgICAgdGhpcy52YWx1ZVdpbGxNdXRhdGUoKTsKICAgICAgICAgICAgdGhpcygpW2luZGV4XSA9IG5ld0l0ZW07CiAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CiAgICAgICAgfQogICAgfQp9CgovLyBQb3B1bGF0ZSBrby5vYnNlcnZhYmxlQXJyYXkuZm4gd2l0aCByZWFkL3dyaXRlIGZ1bmN0aW9ucyBmcm9tIG5hdGl2ZSBhcnJheXMKa28udXRpbHMuYXJyYXlGb3JFYWNoKFsicG9wIiwgInB1c2giLCAicmV2ZXJzZSIsICJzaGlmdCIsICJzb3J0IiwgInNwbGljZSIsICJ1bnNoaWZ0Il0sIGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICBrby5vYnNlcnZhYmxlQXJyYXlbJ2ZuJ11bbWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IHRoaXMoKTsKICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwogICAgICAgIHZhciBtZXRob2RDYWxsUmVzdWx0ID0gdW5kZXJseWluZ0FycmF5W21ldGhvZE5hbWVdLmFwcGx5KHVuZGVybHlpbmdBcnJheSwgYXJndW1lbnRzKTsKICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwogICAgICAgIHJldHVybiBtZXRob2RDYWxsUmVzdWx0OwogICAgfTsKfSk7CgovLyBQb3B1bGF0ZSBrby5vYnNlcnZhYmxlQXJyYXkuZm4gd2l0aCByZWFkLW9ubHkgZnVuY3Rpb25zIGZyb20gbmF0aXZlIGFycmF5cwprby51dGlscy5hcnJheUZvckVhY2goWyJzbGljZSJdLCBmdW5jdGlvbiAobWV0aG9kTmFtZSkgewogICAga28ub2JzZXJ2YWJsZUFycmF5WydmbiddW21ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzKCk7CiAgICAgICAgcmV0dXJuIHVuZGVybHlpbmdBcnJheVttZXRob2ROYW1lXS5hcHBseSh1bmRlcmx5aW5nQXJyYXksIGFyZ3VtZW50cyk7CiAgICB9Owp9KTsKCmtvLmV4cG9ydFN5bWJvbCgnb2JzZXJ2YWJsZUFycmF5Jywga28ub2JzZXJ2YWJsZUFycmF5KTsKa28uZGVwZW5kZW50T2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucywgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQsIG9wdGlvbnMpIHsKICAgIHZhciBfbGF0ZXN0VmFsdWUsCiAgICAgICAgX2hhc0JlZW5FdmFsdWF0ZWQgPSBmYWxzZSwKICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IGZhbHNlLAogICAgICAgIHJlYWRGdW5jdGlvbiA9IGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zOwoKICAgIGlmIChyZWFkRnVuY3Rpb24gJiYgdHlwZW9mIHJlYWRGdW5jdGlvbiA9PSAib2JqZWN0IikgewogICAgICAgIC8vIFNpbmdsZS1wYXJhbWV0ZXIgc3ludGF4IC0gZXZlcnl0aGluZyBpcyBvbiB0aGlzICJvcHRpb25zIiBwYXJhbQogICAgICAgIG9wdGlvbnMgPSByZWFkRnVuY3Rpb247CiAgICAgICAgcmVhZEZ1bmN0aW9uID0gb3B0aW9uc1sicmVhZCJdOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBNdWx0aS1wYXJhbWV0ZXIgc3ludGF4IC0gY29uc3RydWN0IHRoZSBvcHRpb25zIGFjY29yZGluZyB0byB0aGUgcGFyYW1zIHBhc3NlZAogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgIGlmICghcmVhZEZ1bmN0aW9uKQogICAgICAgICAgICByZWFkRnVuY3Rpb24gPSBvcHRpb25zWyJyZWFkIl07CiAgICB9CiAgICAvLyBCeSBoZXJlLCAib3B0aW9ucyIgaXMgYWx3YXlzIG5vbi1udWxsCiAgICBpZiAodHlwZW9mIHJlYWRGdW5jdGlvbiAhPSAiZnVuY3Rpb24iKQogICAgICAgIHRocm93IG5ldyBFcnJvcigiUGFzcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIGtvLmNvbXB1dGVkIik7CgogICAgdmFyIHdyaXRlRnVuY3Rpb24gPSBvcHRpb25zWyJ3cml0ZSJdOwogICAgaWYgKCFldmFsdWF0b3JGdW5jdGlvblRhcmdldCkKICAgICAgICBldmFsdWF0b3JGdW5jdGlvblRhcmdldCA9IG9wdGlvbnNbIm93bmVyIl07CgogICAgdmFyIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMgPSBbXTsKICAgIGZ1bmN0aW9uIGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMoKSB7CiAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMsIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pIHsKICAgICAgICAgICAgc3Vic2NyaXB0aW9uLmRpc3Bvc2UoKTsKICAgICAgICB9KTsKICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzID0gW107CiAgICB9CiAgICB2YXIgZGlzcG9zZSA9IGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXM7CgogICAgLy8gQnVpbGQgImRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCIgYW5kICJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWRDYWxsYmFjayIgb3B0aW9uIHZhbHVlcwogICAgLy8gKE5vdGU6ICJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQiIG9wdGlvbiBib3RoIHByb2FjdGl2ZWx5IGRpc3Bvc2VzIGFzIHNvb24gYXMgdGhlIG5vZGUgaXMgcmVtb3ZlZCB1c2luZyBrby5yZW1vdmVOb2RlKCksCiAgICAvLyBwbHVzIGFkZHMgYSAiZGlzcG9zZVdoZW4iIGNhbGxiYWNrIHRoYXQsIG9uIGVhY2ggZXZhbHVhdGlvbiwgZGlzcG9zZXMgaWYgdGhlIG5vZGUgd2FzIHJlbW92ZWQgYnkgc29tZSBvdGhlciBtZWFucy4pCiAgICB2YXIgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkID0gKHR5cGVvZiBvcHRpb25zWyJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQiXSA9PSAib2JqZWN0IikgPyBvcHRpb25zWyJkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQiXSA6IG51bGw7CiAgICB2YXIgZGlzcG9zZVdoZW4gPSBvcHRpb25zWyJkaXNwb3NlV2hlbiJdIHx8IGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH07CiAgICBpZiAoZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkKSB7CiAgICAgICAgZGlzcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlRGlzcG9zZUNhbGxiYWNrKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCwgYXJndW1lbnRzLmNhbGxlZSk7CiAgICAgICAgICAgIGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMoKTsKICAgICAgICB9OwogICAgICAgIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5hZGREaXNwb3NlQ2FsbGJhY2soZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkLCBkaXNwb3NlKTsKICAgICAgICB2YXIgZXhpc3RpbmdEaXNwb3NlV2hlbkZ1bmN0aW9uID0gZGlzcG9zZVdoZW47CiAgICAgICAgZGlzcG9zZVdoZW4gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCkgfHwgZXhpc3RpbmdEaXNwb3NlV2hlbkZ1bmN0aW9uKCk7CiAgICAgICAgfQogICAgfQoKICAgIHZhciBldmFsdWF0aW9uVGltZW91dEluc3RhbmNlID0gbnVsbDsKICAgIGZ1bmN0aW9uIGV2YWx1YXRlUG9zc2libHlBc3luYygpIHsKICAgICAgICB2YXIgdGhyb3R0bGVFdmFsdWF0aW9uVGltZW91dCA9IGRlcGVuZGVudE9ic2VydmFibGVbJ3Rocm90dGxlRXZhbHVhdGlvbiddOwogICAgICAgIGlmICh0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ICYmIHRocm90dGxlRXZhbHVhdGlvblRpbWVvdXQgPj0gMCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQoZXZhbHVhdGlvblRpbWVvdXRJbnN0YW5jZSk7CiAgICAgICAgICAgIGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGV2YWx1YXRlSW1tZWRpYXRlLCB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0KTsKICAgICAgICB9IGVsc2UKICAgICAgICAgICAgZXZhbHVhdGVJbW1lZGlhdGUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBldmFsdWF0ZUltbWVkaWF0ZSgpIHsKICAgICAgICBpZiAoX2lzQmVpbmdFdmFsdWF0ZWQpIHsKICAgICAgICAgICAgLy8gSWYgdGhlIGV2YWx1YXRpb24gb2YgYSBrby5jb21wdXRlZCBjYXVzZXMgc2lkZSBlZmZlY3RzLCBpdCdzIHBvc3NpYmxlIHRoYXQgaXQgd2lsbCB0cmlnZ2VyIGl0cyBvd24gcmUtZXZhbHVhdGlvbi4KICAgICAgICAgICAgLy8gVGhpcyBpcyBub3QgZGVzaXJhYmxlIChpdCdzIGhhcmQgZm9yIGEgZGV2ZWxvcGVyIHRvIHJlYWxpc2UgYSBjaGFpbiBvZiBkZXBlbmRlbmNpZXMgbWlnaHQgY2F1c2UgdGhpcywgYW5kIHRoZXkgYWxtb3N0CiAgICAgICAgICAgIC8vIGNlcnRhaW5seSBkaWRuJ3QgaW50ZW5kIGluZmluaXRlIHJlLWV2YWx1YXRpb25zKS4gU28sIGZvciBwcmVkaWN0YWJpbGl0eSwgd2Ugc2ltcGx5IHByZXZlbnQga28uY29tcHV0ZWRzIGZyb20gY2F1c2luZwogICAgICAgICAgICAvLyB0aGVpciBvd24gcmUtZXZhbHVhdGlvbi4gRnVydGhlciBkaXNjdXNzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzM4NwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBEb24ndCBkaXNwb3NlIG9uIGZpcnN0IGV2YWx1YXRpb24sIGJlY2F1c2UgdGhlICJkaXNwb3NlV2hlbiIgY2FsbGJhY2sgbWlnaHQKICAgICAgICAvLyBlLmcuLCBkaXNwb3NlIHdoZW4gdGhlIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnQgaXNuJ3QgaW4gdGhlIGRvYywgYW5kIGl0J3Mgbm90CiAgICAgICAgLy8gZ29pbmcgdG8gYmUgaW4gdGhlIGRvYyB1bnRpbCAqYWZ0ZXIqIHRoZSBmaXJzdCBldmFsdWF0aW9uCiAgICAgICAgaWYgKF9oYXNCZWVuRXZhbHVhdGVkICYmIGRpc3Bvc2VXaGVuKCkpIHsKICAgICAgICAgICAgZGlzcG9zZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gSW5pdGlhbGx5LCB3ZSBhc3N1bWUgdGhhdCBub25lIG9mIHRoZSBzdWJzY3JpcHRpb25zIGFyZSBzdGlsbCBiZWluZyB1c2VkIChpLmUuLCBhbGwgYXJlIGNhbmRpZGF0ZXMgZm9yIGRpc3Bvc2FsKS4KICAgICAgICAgICAgLy8gVGhlbiwgZHVyaW5nIGV2YWx1YXRpb24sIHdlIGNyb3NzIG9mZiBhbnkgdGhhdCBhcmUgaW4gZmFjdCBzdGlsbCBiZWluZyB1c2VkLgogICAgICAgICAgICB2YXIgZGlzcG9zYWxDYW5kaWRhdGVzID0ga28udXRpbHMuYXJyYXlNYXAoX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcywgZnVuY3Rpb24oaXRlbSkge3JldHVybiBpdGVtLnRhcmdldDt9KTsKCiAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oZnVuY3Rpb24oc3Vic2NyaWJhYmxlKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5PbGQ7CiAgICAgICAgICAgICAgICBpZiAoKGluT2xkID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGRpc3Bvc2FsQ2FuZGlkYXRlcywgc3Vic2NyaWJhYmxlKSkgPj0gMCkKICAgICAgICAgICAgICAgICAgICBkaXNwb3NhbENhbmRpZGF0ZXNbaW5PbGRdID0gdW5kZWZpbmVkOyAvLyBEb24ndCB3YW50IHRvIGRpc3Bvc2UgdGhpcyBzdWJzY3JpcHRpb24sIGFzIGl0J3Mgc3RpbGwgYmVpbmcgdXNlZAogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMucHVzaChzdWJzY3JpYmFibGUuc3Vic2NyaWJlKGV2YWx1YXRlUG9zc2libHlBc3luYykpOyAvLyBCcmFuZCBuZXcgc3Vic2NyaXB0aW9uIC0gYWRkIGl0CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZEZ1bmN0aW9uLmNhbGwoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpOwoKICAgICAgICAgICAgLy8gRm9yIGVhY2ggc3Vic2NyaXB0aW9uIG5vIGxvbmdlciBiZWluZyB1c2VkLCByZW1vdmUgaXQgZnJvbSB0aGUgYWN0aXZlIHN1YnNjcmlwdGlvbnMgbGlzdCBhbmQgZGlzcG9zZSBpdAogICAgICAgICAgICBmb3IgKHZhciBpID0gZGlzcG9zYWxDYW5kaWRhdGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBpZiAoZGlzcG9zYWxDYW5kaWRhdGVzW2ldKQogICAgICAgICAgICAgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMuc3BsaWNlKGksIDEpWzBdLmRpc3Bvc2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfaGFzQmVlbkV2YWx1YXRlZCA9IHRydWU7CgogICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOwogICAgICAgICAgICBfbGF0ZXN0VmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgaWYgKERFQlVHKSBkZXBlbmRlbnRPYnNlcnZhYmxlLl9sYXRlc3RWYWx1ZSA9IF9sYXRlc3RWYWx1ZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmVuZCgpOwogICAgICAgIH0KCiAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUpOwogICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gZmFsc2U7CgogICAgfQoKICAgIGZ1bmN0aW9uIGRlcGVuZGVudE9ic2VydmFibGUoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHNldC5hcHBseShkZXBlbmRlbnRPYnNlcnZhYmxlLCBhcmd1bWVudHMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBnZXQoKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2V0KCkgewogICAgICAgIGlmICh0eXBlb2Ygd3JpdGVGdW5jdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAvLyBXcml0aW5nIGEgdmFsdWUKICAgICAgICAgICAgd3JpdGVGdW5jdGlvbi5hcHBseShldmFsdWF0b3JGdW5jdGlvblRhcmdldCwgYXJndW1lbnRzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB3cml0ZSBhIHZhbHVlIHRvIGEga28uY29tcHV0ZWQgdW5sZXNzIHlvdSBzcGVjaWZ5IGEgJ3dyaXRlJyBvcHRpb24uIElmIHlvdSB3aXNoIHRvIHJlYWQgdGhlIGN1cnJlbnQgdmFsdWUsIGRvbid0IHBhc3MgYW55IHBhcmFtZXRlcnMuIik7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAvLyBSZWFkaW5nIHRoZSB2YWx1ZQogICAgICAgIGlmICghX2hhc0JlZW5FdmFsdWF0ZWQpCiAgICAgICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKCk7CiAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5yZWdpc3RlckRlcGVuZGVuY3koZGVwZW5kZW50T2JzZXJ2YWJsZSk7CiAgICAgICAgcmV0dXJuIF9sYXRlc3RWYWx1ZTsKICAgIH0KCiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmdldERlcGVuZGVuY2llc0NvdW50ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcy5sZW5ndGg7IH07CiAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmhhc1dyaXRlRnVuY3Rpb24gPSB0eXBlb2Ygb3B0aW9uc1sid3JpdGUiXSA9PT0gImZ1bmN0aW9uIjsKICAgIGRlcGVuZGVudE9ic2VydmFibGUuZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgZGlzcG9zZSgpOyB9OwoKICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKGRlcGVuZGVudE9ic2VydmFibGUpOwogICAga28udXRpbHMuZXh0ZW5kKGRlcGVuZGVudE9ic2VydmFibGUsIGtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ10pOwoKICAgIGlmIChvcHRpb25zWydkZWZlckV2YWx1YXRpb24nXSAhPT0gdHJ1ZSkKICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSgpOwoKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdkaXNwb3NlJywgZGVwZW5kZW50T2JzZXJ2YWJsZS5kaXNwb3NlKTsKICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdnZXREZXBlbmRlbmNpZXNDb3VudCcsIGRlcGVuZGVudE9ic2VydmFibGUuZ2V0RGVwZW5kZW5jaWVzQ291bnQpOwoKICAgIHJldHVybiBkZXBlbmRlbnRPYnNlcnZhYmxlOwp9OwoKa28uaXNDb21wdXRlZCA9IGZ1bmN0aW9uKGluc3RhbmNlKSB7CiAgICByZXR1cm4ga28uaGFzUHJvdG90eXBlKGluc3RhbmNlLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsKfTsKCnZhciBwcm90b1Byb3AgPSBrby5vYnNlcnZhYmxlLnByb3RvUHJvcGVydHk7IC8vID09ICJfX2tvX3Byb3RvX18iCmtvLmRlcGVuZGVudE9ic2VydmFibGVbcHJvdG9Qcm9wXSA9IGtvLm9ic2VydmFibGU7Cgprby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddID0ge307CmtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ11bcHJvdG9Qcm9wXSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGU7Cgprby5leHBvcnRTeW1ib2woJ2RlcGVuZGVudE9ic2VydmFibGUnLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsKa28uZXhwb3J0U3ltYm9sKCdjb21wdXRlZCcsIGtvLmRlcGVuZGVudE9ic2VydmFibGUpOyAvLyBNYWtlICJrby5jb21wdXRlZCIgYW4gYWxpYXMgZm9yICJrby5kZXBlbmRlbnRPYnNlcnZhYmxlIgprby5leHBvcnRTeW1ib2woJ2lzQ29tcHV0ZWQnLCBrby5pc0NvbXB1dGVkKTsKCihmdW5jdGlvbigpIHsKICAgIHZhciBtYXhOZXN0ZWRPYnNlcnZhYmxlRGVwdGggPSAxMDsgLy8gRXNjYXBlIHRoZSAodW5saWtlbHkpIHBhdGhhbG9naWNhbCBjYXNlIHdoZXJlIGFuIG9ic2VydmFibGUncyBjdXJyZW50IHZhbHVlIGlzIGl0c2VsZiAob3Igc2ltaWxhciByZWZlcmVuY2UgY3ljbGUpCgogICAga28udG9KUyA9IGZ1bmN0aW9uKHJvb3RPYmplY3QpIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldoZW4gY2FsbGluZyBrby50b0pTLCBwYXNzIHRoZSBvYmplY3QgeW91IHdhbnQgdG8gY29udmVydC4iKTsKCiAgICAgICAgLy8gV2UganVzdCB1bndyYXAgZXZlcnl0aGluZyBhdCBldmVyeSBsZXZlbCBpbiB0aGUgb2JqZWN0IGdyYXBoCiAgICAgICAgcmV0dXJuIG1hcEpzT2JqZWN0R3JhcGgocm9vdE9iamVjdCwgZnVuY3Rpb24odmFsdWVUb01hcCkgewogICAgICAgICAgICAvLyBMb29wIGJlY2F1c2UgYW4gb2JzZXJ2YWJsZSdzIHZhbHVlIG1pZ2h0IGluIHR1cm4gYmUgYW5vdGhlciBvYnNlcnZhYmxlIHdyYXBwZXIKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGtvLmlzT2JzZXJ2YWJsZSh2YWx1ZVRvTWFwKSAmJiAoaSA8IG1heE5lc3RlZE9ic2VydmFibGVEZXB0aCk7IGkrKykKICAgICAgICAgICAgICAgIHZhbHVlVG9NYXAgPSB2YWx1ZVRvTWFwKCk7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZVRvTWFwOwogICAgICAgIH0pOwogICAgfTsKCiAgICBrby50b0pTT04gPSBmdW5jdGlvbihyb290T2JqZWN0LCByZXBsYWNlciwgc3BhY2UpIHsgICAgIC8vIHJlcGxhY2VyIGFuZCBzcGFjZSBhcmUgb3B0aW9uYWwKICAgICAgICB2YXIgcGxhaW5KYXZhU2NyaXB0T2JqZWN0ID0ga28udG9KUyhyb290T2JqZWN0KTsKICAgICAgICByZXR1cm4ga28udXRpbHMuc3RyaW5naWZ5SnNvbihwbGFpbkphdmFTY3JpcHRPYmplY3QsIHJlcGxhY2VyLCBzcGFjZSk7CiAgICB9OwoKICAgIGZ1bmN0aW9uIG1hcEpzT2JqZWN0R3JhcGgocm9vdE9iamVjdCwgbWFwSW5wdXRDYWxsYmFjaywgdmlzaXRlZE9iamVjdHMpIHsKICAgICAgICB2aXNpdGVkT2JqZWN0cyA9IHZpc2l0ZWRPYmplY3RzIHx8IG5ldyBvYmplY3RMb29rdXAoKTsKCiAgICAgICAgcm9vdE9iamVjdCA9IG1hcElucHV0Q2FsbGJhY2socm9vdE9iamVjdCk7CiAgICAgICAgdmFyIGNhbkhhdmVQcm9wZXJ0aWVzID0gKHR5cGVvZiByb290T2JqZWN0ID09ICJvYmplY3QiKSAmJiAocm9vdE9iamVjdCAhPT0gbnVsbCkgJiYgKHJvb3RPYmplY3QgIT09IHVuZGVmaW5lZCkgJiYgKCEocm9vdE9iamVjdCBpbnN0YW5jZW9mIERhdGUpKTsKICAgICAgICBpZiAoIWNhbkhhdmVQcm9wZXJ0aWVzKQogICAgICAgICAgICByZXR1cm4gcm9vdE9iamVjdDsKCiAgICAgICAgdmFyIG91dHB1dFByb3BlcnRpZXMgPSByb290T2JqZWN0IGluc3RhbmNlb2YgQXJyYXkgPyBbXSA6IHt9OwogICAgICAgIHZpc2l0ZWRPYmplY3RzLnNhdmUocm9vdE9iamVjdCwgb3V0cHV0UHJvcGVydGllcyk7CgogICAgICAgIHZpc2l0UHJvcGVydGllc09yQXJyYXlFbnRyaWVzKHJvb3RPYmplY3QsIGZ1bmN0aW9uKGluZGV4ZXIpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnR5VmFsdWUgPSBtYXBJbnB1dENhbGxiYWNrKHJvb3RPYmplY3RbaW5kZXhlcl0pOwoKICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgcHJvcGVydHlWYWx1ZSkgewogICAgICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgICAgICAgICAgICBvdXRwdXRQcm9wZXJ0aWVzW2luZGV4ZXJdID0gcHJvcGVydHlWYWx1ZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICBjYXNlICJ1bmRlZmluZWQiOgogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c2x5TWFwcGVkVmFsdWUgPSB2aXNpdGVkT2JqZWN0cy5nZXQocHJvcGVydHlWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJvcGVydGllc1tpbmRleGVyXSA9IChwcmV2aW91c2x5TWFwcGVkVmFsdWUgIT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICAgICAgPyBwcmV2aW91c2x5TWFwcGVkVmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgOiBtYXBKc09iamVjdEdyYXBoKHByb3BlcnR5VmFsdWUsIG1hcElucHV0Q2FsbGJhY2ssIHZpc2l0ZWRPYmplY3RzKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gb3V0cHV0UHJvcGVydGllczsKICAgIH0KCiAgICBmdW5jdGlvbiB2aXNpdFByb3BlcnRpZXNPckFycmF5RW50cmllcyhyb290T2JqZWN0LCB2aXNpdG9yQ2FsbGJhY2spIHsKICAgICAgICBpZiAocm9vdE9iamVjdCBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcm9vdE9iamVjdC5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIHZpc2l0b3JDYWxsYmFjayhpKTsKCiAgICAgICAgICAgIC8vIEZvciBhcnJheXMsIGFsc28gcmVzcGVjdCB0b0pTT04gcHJvcGVydHkgZm9yIGN1c3RvbSBtYXBwaW5ncyAoZml4ZXMgIzI3OCkKICAgICAgICAgICAgaWYgKHR5cGVvZiByb290T2JqZWN0Wyd0b0pTT04nXSA9PSAnZnVuY3Rpb24nKQogICAgICAgICAgICAgICAgdmlzaXRvckNhbGxiYWNrKCd0b0pTT04nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBwcm9wZXJ0eU5hbWUgaW4gcm9vdE9iamVjdCkKICAgICAgICAgICAgICAgIHZpc2l0b3JDYWxsYmFjayhwcm9wZXJ0eU5hbWUpOwogICAgICAgIH0KICAgIH07CgogICAgZnVuY3Rpb24gb2JqZWN0TG9va3VwKCkgewogICAgICAgIHZhciBrZXlzID0gW107CiAgICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICAgIHRoaXMuc2F2ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nSW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2Yoa2V5cywga2V5KTsKICAgICAgICAgICAgaWYgKGV4aXN0aW5nSW5kZXggPj0gMCkKICAgICAgICAgICAgICAgIHZhbHVlc1tleGlzdGluZ0luZGV4XSA9IHZhbHVlOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgICAgICAgICAgdmFsdWVzLnB1c2godmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB0aGlzLmdldCA9IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICB2YXIgZXhpc3RpbmdJbmRleCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihrZXlzLCBrZXkpOwogICAgICAgICAgICByZXR1cm4gKGV4aXN0aW5nSW5kZXggPj0gMCkgPyB2YWx1ZXNbZXhpc3RpbmdJbmRleF0gOiB1bmRlZmluZWQ7CiAgICAgICAgfTsKICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3RvSlMnLCBrby50b0pTKTsKa28uZXhwb3J0U3ltYm9sKCd0b0pTT04nLCBrby50b0pTT04pOwooZnVuY3Rpb24gKCkgewogICAgdmFyIGhhc0RvbURhdGFFeHBhbmRvUHJvcGVydHkgPSAnX19rb19faGFzRG9tRGF0YU9wdGlvblZhbHVlX18nOwoKICAgIC8vIE5vcm1hbGx5LCBTRUxFQ1QgZWxlbWVudHMgYW5kIHRoZWlyIE9QVElPTnMgY2FuIG9ubHkgdGFrZSB2YWx1ZSBvZiB0eXBlICdzdHJpbmcnIChiZWNhdXNlIHRoZSB2YWx1ZXMKICAgIC8vIGFyZSBzdG9yZWQgb24gRE9NIGF0dHJpYnV0ZXMpLiBrby5zZWxlY3RFeHRlbnNpb25zIHByb3ZpZGVzIGEgd2F5IGZvciBTRUxFQ1RzL09QVElPTnMgdG8gaGF2ZSB2YWx1ZXMKICAgIC8vIHRoYXQgYXJlIGFyYml0cmFyeSBvYmplY3RzLiBUaGlzIGlzIHZlcnkgY29udmVuaWVudCB3aGVuIGltcGxlbWVudGluZyB0aGluZ3MgbGlrZSBjYXNjYWRpbmcgZHJvcGRvd25zLgogICAga28uc2VsZWN0RXh0ZW5zaW9ucyA9IHsKICAgICAgICByZWFkVmFsdWUgOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIHN3aXRjaCAoa28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgICBjYXNlICdvcHRpb24nOgogICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldID09PSB0cnVlKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuZG9tRGF0YS5nZXQoZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzLm9wdGlvbnMub3B0aW9uVmFsdWVEb21EYXRhS2V5KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5nZXRBdHRyaWJ1dGUoInZhbHVlIik7CiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnNlbGVjdGVkSW5kZXggPj0gMCA/IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tlbGVtZW50LnNlbGVjdGVkSW5kZXhdKSA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB3cml0ZVZhbHVlOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewogICAgICAgICAgICAgICAgY2FzZSAnb3B0aW9uJzoKICAgICAgICAgICAgICAgICAgICBzd2l0Y2godHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnMub3B0aW9ucy5vcHRpb25WYWx1ZURvbURhdGFLZXksIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eSBpbiBlbGVtZW50KSB7IC8vIElFIDw9IDggdGhyb3dzIGVycm9ycyBpZiB5b3UgZGVsZXRlIG5vbi1leGlzdGVudCBwcm9wZXJ0aWVzIGZyb20gYSBET00gbm9kZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9yZSBhcmJpdHJhcnkgb2JqZWN0IHVzaW5nIERvbURhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5XSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3BlY2lhbCB0cmVhdG1lbnQgb2YgbnVtYmVycyBpcyBqdXN0IGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LiBLTyAxLjIuMSB3cm90ZSBudW1lcmljYWwgdmFsdWVzIHRvIGVsZW1lbnQudmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiA/IHZhbHVlIDogIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBlbGVtZW50Lm9wdGlvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tpXSkgPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSB1bmRlZmluZWQpKQogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICIiOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3NlbGVjdEV4dGVuc2lvbnMnLCBrby5zZWxlY3RFeHRlbnNpb25zKTsKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZScsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKTsKa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUnLCBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUpOwoKa28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcgPSAoZnVuY3Rpb24gKCkgewogICAgdmFyIHJlc3RvcmVDYXB0dXJlZFRva2Vuc1JlZ2V4ID0gL1xAa29fdG9rZW5fKFxkKylcQC9nOwogICAgdmFyIGphdmFTY3JpcHRBc3NpZ25tZW50VGFyZ2V0ID0gL15bXF8kYS16XVtcXyRhLXowLTldKihcWy4qP1xdKSooXC5bXF8kYS16XVtcXyRhLXowLTldKihcWy4qP1xdKSopKiQvaTsKICAgIHZhciBqYXZhU2NyaXB0UmVzZXJ2ZWRXb3JkcyA9IFsidHJ1ZSIsICJmYWxzZSJdOwoKICAgIGZ1bmN0aW9uIHJlc3RvcmVUb2tlbnMoc3RyaW5nLCB0b2tlbnMpIHsKICAgICAgICB2YXIgcHJldlZhbHVlID0gbnVsbDsKICAgICAgICB3aGlsZSAoc3RyaW5nICE9IHByZXZWYWx1ZSkgeyAvLyBLZWVwIHJlc3RvcmluZyB0b2tlbnMgdW50aWwgaXQgbm8gbG9uZ2VyIG1ha2VzIGEgZGlmZmVyZW5jZSAodGhleSBtYXkgYmUgbmVzdGVkKQogICAgICAgICAgICBwcmV2VmFsdWUgPSBzdHJpbmc7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKHJlc3RvcmVDYXB0dXJlZFRva2Vuc1JlZ2V4LCBmdW5jdGlvbiAobWF0Y2gsIHRva2VuSW5kZXgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b2tlbnNbdG9rZW5JbmRleF07CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzV3JpdGVhYmxlVmFsdWUoZXhwcmVzc2lvbikgewogICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YoamF2YVNjcmlwdFJlc2VydmVkV29yZHMsIGtvLnV0aWxzLnN0cmluZ1RyaW0oZXhwcmVzc2lvbikudG9Mb3dlckNhc2UoKSkgPj0gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiBleHByZXNzaW9uLm1hdGNoKGphdmFTY3JpcHRBc3NpZ25tZW50VGFyZ2V0KSAhPT0gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBlbnN1cmVRdW90ZWQoa2V5KSB7CiAgICAgICAgdmFyIHRyaW1tZWRLZXkgPSBrby51dGlscy5zdHJpbmdUcmltKGtleSk7CiAgICAgICAgc3dpdGNoICh0cmltbWVkS2V5Lmxlbmd0aCAmJiB0cmltbWVkS2V5LmNoYXJBdCgwKSkgewogICAgICAgICAgICBjYXNlICInIjoKICAgICAgICAgICAgY2FzZSAnIic6CiAgICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuICInIiArIHRyaW1tZWRLZXkgKyAiJyI7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzOiBbXSwKCiAgICAgICAgcGFyc2VPYmplY3RMaXRlcmFsOiBmdW5jdGlvbihvYmplY3RMaXRlcmFsU3RyaW5nKSB7CiAgICAgICAgICAgIC8vIEEgZnVsbCB0b2tlbmlzZXIrbGV4ZXIgd291bGQgYWRkIHRvbyBtdWNoIHdlaWdodCB0byB0aGlzIGxpYnJhcnksIHNvIGhlcmUncyBhIHNpbXBsZSBwYXJzZXIKICAgICAgICAgICAgLy8gdGhhdCBpcyBzdWZmaWNpZW50IGp1c3QgdG8gc3BsaXQgYW4gb2JqZWN0IGxpdGVyYWwgc3RyaW5nIGludG8gYSBzZXQgb2YgdG9wLWxldmVsIGtleS12YWx1ZSBwYWlycwoKICAgICAgICAgICAgdmFyIHN0ciA9IGtvLnV0aWxzLnN0cmluZ1RyaW0ob2JqZWN0TGl0ZXJhbFN0cmluZyk7CiAgICAgICAgICAgIGlmIChzdHIubGVuZ3RoIDwgMykKICAgICAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgICAgaWYgKHN0ci5jaGFyQXQoMCkgPT09ICJ7IikvLyBJZ25vcmUgYW55IGJyYWNlcyBzdXJyb3VuZGluZyB0aGUgd2hvbGUgb2JqZWN0IGxpdGVyYWwKICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMSwgc3RyLmxlbmd0aCAtIDEpOwoKICAgICAgICAgICAgLy8gUHVsbCBvdXQgYW55IHN0cmluZyBsaXRlcmFscyBhbmQgcmVnZXggbGl0ZXJhbHMKICAgICAgICAgICAgdmFyIHRva2VucyA9IFtdOwogICAgICAgICAgICB2YXIgdG9rZW5TdGFydCA9IG51bGwsIHRva2VuRW5kQ2hhcjsKICAgICAgICAgICAgZm9yICh2YXIgcG9zaXRpb24gPSAwOyBwb3NpdGlvbiA8IHN0ci5sZW5ndGg7IHBvc2l0aW9uKyspIHsKICAgICAgICAgICAgICAgIHZhciBjID0gc3RyLmNoYXJBdChwb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAodG9rZW5TdGFydCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoYykgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICciJzoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiJyI6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIi8iOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5TdGFydCA9IHBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGMgPT0gdG9rZW5FbmRDaGFyKSAmJiAoc3RyLmNoYXJBdChwb3NpdGlvbiAtIDEpICE9PSAiXFwiKSkgewogICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHN0ci5zdWJzdHJpbmcodG9rZW5TdGFydCwgcG9zaXRpb24gKyAxKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VtZW50ID0gIkBrb190b2tlbl8iICsgKHRva2Vucy5sZW5ndGggLSAxKSArICJAIjsKICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyaW5nKDAsIHRva2VuU3RhcnQpICsgcmVwbGFjZW1lbnQgKyBzdHIuc3Vic3RyaW5nKHBvc2l0aW9uICsgMSk7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gLT0gKHRva2VuLmxlbmd0aCAtIHJlcGxhY2VtZW50Lmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5TdGFydCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5leHQgcHVsbCBvdXQgYmFsYW5jZWQgcGFyZW4sIGJyYWNlLCBhbmQgYnJhY2tldCBibG9ja3MKICAgICAgICAgICAgdG9rZW5TdGFydCA9IG51bGw7CiAgICAgICAgICAgIHRva2VuRW5kQ2hhciA9IG51bGw7CiAgICAgICAgICAgIHZhciB0b2tlbkRlcHRoID0gMCwgdG9rZW5TdGFydENoYXIgPSBudWxsOwogICAgICAgICAgICBmb3IgKHZhciBwb3NpdGlvbiA9IDA7IHBvc2l0aW9uIDwgc3RyLmxlbmd0aDsgcG9zaXRpb24rKykgewogICAgICAgICAgICAgICAgdmFyIGMgPSBzdHIuY2hhckF0KHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIGlmICh0b2tlblN0YXJ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInsiOiB0b2tlblN0YXJ0ID0gcG9zaXRpb247IHRva2VuU3RhcnRDaGFyID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuRW5kQ2hhciA9ICJ9IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICIoIjogdG9rZW5TdGFydCA9IHBvc2l0aW9uOyB0b2tlblN0YXJ0Q2hhciA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbkVuZENoYXIgPSAiKSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiWyI6IHRva2VuU3RhcnQgPSBwb3NpdGlvbjsgdG9rZW5TdGFydENoYXIgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5FbmRDaGFyID0gIl0iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChjID09PSB0b2tlblN0YXJ0Q2hhcikKICAgICAgICAgICAgICAgICAgICB0b2tlbkRlcHRoKys7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChjID09PSB0b2tlbkVuZENoYXIpIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbkRlcHRoLS07CiAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gc3RyLnN1YnN0cmluZyh0b2tlblN0YXJ0LCBwb3NpdGlvbiArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXBsYWNlbWVudCA9ICJAa29fdG9rZW5fIiArICh0b2tlbnMubGVuZ3RoIC0gMSkgKyAiQCI7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgdG9rZW5TdGFydCkgKyByZXBsYWNlbWVudCArIHN0ci5zdWJzdHJpbmcocG9zaXRpb24gKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gLT0gKHRva2VuLmxlbmd0aCAtIHJlcGxhY2VtZW50Lmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuU3RhcnQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTm93IHdlIGNhbiBzYWZlbHkgc3BsaXQgb24gY29tbWFzIHRvIGdldCB0aGUga2V5L3ZhbHVlIHBhaXJzCiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgdmFyIGtleVZhbHVlUGFpcnMgPSBzdHIuc3BsaXQoIiwiKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBrZXlWYWx1ZVBhaXJzLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHBhaXIgPSBrZXlWYWx1ZVBhaXJzW2ldOwogICAgICAgICAgICAgICAgdmFyIGNvbG9uUG9zID0gcGFpci5pbmRleE9mKCI6Iik7CiAgICAgICAgICAgICAgICBpZiAoKGNvbG9uUG9zID4gMCkgJiYgKGNvbG9uUG9zIDwgcGFpci5sZW5ndGggLSAxKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBwYWlyLnN1YnN0cmluZygwLCBjb2xvblBvcyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcGFpci5zdWJzdHJpbmcoY29sb25Qb3MgKyAxKTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh7ICdrZXknOiByZXN0b3JlVG9rZW5zKGtleSwgdG9rZW5zKSwgJ3ZhbHVlJzogcmVzdG9yZVRva2Vucyh2YWx1ZSwgdG9rZW5zKSB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goeyAndW5rbm93bic6IHJlc3RvcmVUb2tlbnMocGFpciwgdG9rZW5zKSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIGluc2VydFByb3BlcnR5QWNjZXNzb3JzSW50b0pzb246IGZ1bmN0aW9uIChvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5KSB7CiAgICAgICAgICAgIHZhciBrZXlWYWx1ZUFycmF5ID0gdHlwZW9mIG9iamVjdExpdGVyYWxTdHJpbmdPcktleVZhbHVlQXJyYXkgPT09ICJzdHJpbmciCiAgICAgICAgICAgICAgICA/IGtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5KQogICAgICAgICAgICAgICAgOiBvYmplY3RMaXRlcmFsU3RyaW5nT3JLZXlWYWx1ZUFycmF5OwogICAgICAgICAgICB2YXIgcmVzdWx0U3RyaW5ncyA9IFtdLCBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncyA9IFtdOwoKICAgICAgICAgICAgdmFyIGtleVZhbHVlRW50cnk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBrZXlWYWx1ZUVudHJ5ID0ga2V5VmFsdWVBcnJheVtpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0U3RyaW5ncy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiLCIpOwoKICAgICAgICAgICAgICAgIGlmIChrZXlWYWx1ZUVudHJ5WydrZXknXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBxdW90ZWRLZXkgPSBlbnN1cmVRdW90ZWQoa2V5VmFsdWVFbnRyeVsna2V5J10pLCB2YWwgPSBrZXlWYWx1ZUVudHJ5Wyd2YWx1ZSddOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaChxdW90ZWRLZXkpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiOiIpOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCh2YWwpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNXcml0ZWFibGVWYWx1ZShrby51dGlscy5zdHJpbmdUcmltKHZhbCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MucHVzaCgiLCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MucHVzaChxdW90ZWRLZXkgKyAiIDogZnVuY3Rpb24oX19rb192YWx1ZSkgeyAiICsgdmFsICsgIiA9IF9fa29fdmFsdWU7IH0iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleVZhbHVlRW50cnlbJ3Vua25vd24nXSkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaChrZXlWYWx1ZUVudHJ5Wyd1bmtub3duJ10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY29tYmluZWRSZXN1bHQgPSByZXN1bHRTdHJpbmdzLmpvaW4oIiIpOwogICAgICAgICAgICBpZiAocHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIGFsbFByb3BlcnR5QWNjZXNzb3JzID0gcHJvcGVydHlBY2Nlc3NvclJlc3VsdFN0cmluZ3Muam9pbigiIik7CiAgICAgICAgICAgICAgICBjb21iaW5lZFJlc3VsdCA9IGNvbWJpbmVkUmVzdWx0ICsgIiwgJ19rb19wcm9wZXJ0eV93cml0ZXJzJyA6IHsgIiArIGFsbFByb3BlcnR5QWNjZXNzb3JzICsgIiB9ICI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBjb21iaW5lZFJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBrZXlWYWx1ZUFycmF5Q29udGFpbnNLZXk6IGZ1bmN0aW9uKGtleVZhbHVlQXJyYXksIGtleSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleVZhbHVlQXJyYXkubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuc3RyaW5nVHJpbShrZXlWYWx1ZUFycmF5W2ldWydrZXknXSkgPT0ga2V5KQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLy8gSW50ZXJuYWwsIHByaXZhdGUgS08gdXRpbGl0eSBmb3IgdXBkYXRpbmcgbW9kZWwgcHJvcGVydGllcyBmcm9tIHdpdGhpbiBiaW5kaW5ncwogICAgICAgIC8vIHByb3BlcnR5OiAgICAgICAgICAgIElmIHRoZSBwcm9wZXJ0eSBiZWluZyB1cGRhdGVkIGlzIChvciBtaWdodCBiZSkgYW4gb2JzZXJ2YWJsZSwgcGFzcyBpdCBoZXJlCiAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgSWYgaXQgdHVybnMgb3V0IHRvIGJlIGEgd3JpdGFibGUgb2JzZXJ2YWJsZSwgaXQgd2lsbCBiZSB3cml0dGVuIHRvIGRpcmVjdGx5CiAgICAgICAgLy8gYWxsQmluZGluZ3NBY2Nlc3NvcjogQWxsIGJpbmRpbmdzIGluIHRoZSBjdXJyZW50IGV4ZWN1dGlvbiBjb250ZXh0LgogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgIFRoaXMgd2lsbCBiZSBzZWFyY2hlZCBmb3IgYSAnX2tvX3Byb3BlcnR5X3dyaXRlcnMnIHByb3BlcnR5IGluIGNhc2UgeW91J3JlIHdyaXRpbmcgdG8gYSBub24tb2JzZXJ2YWJsZQogICAgICAgIC8vIGtleTogICAgICAgICAgICAgICAgIFRoZSBrZXkgaWRlbnRpZnlpbmcgdGhlIHByb3BlcnR5IHRvIGJlIHdyaXR0ZW4uIEV4YW1wbGU6IGZvciB7IGhhc0ZvY3VzOiBteVZhbHVlIH0sIHdyaXRlIHRvICdteVZhbHVlJyBieSBzcGVjaWZ5aW5nIHRoZSBrZXkgJ2hhc0ZvY3VzJwogICAgICAgIC8vIHZhbHVlOiAgICAgICAgICAgICAgIFRoZSB2YWx1ZSB0byBiZSB3cml0dGVuCiAgICAgICAgLy8gY2hlY2tJZkRpZmZlcmVudDogICAgSWYgdHJ1ZSwgYW5kIGlmIHRoZSBwcm9wZXJ0eSBiZWluZyB3cml0dGVuIGlzIGEgd3JpdGFibGUgb2JzZXJ2YWJsZSwgdGhlIHZhbHVlIHdpbGwgb25seSBiZSB3cml0dGVuIGlmCiAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgaXQgaXMgIT09IGV4aXN0aW5nIHZhbHVlIG9uIHRoYXQgd3JpdGFibGUgb2JzZXJ2YWJsZQogICAgICAgIHdyaXRlVmFsdWVUb1Byb3BlcnR5OiBmdW5jdGlvbihwcm9wZXJ0eSwgYWxsQmluZGluZ3NBY2Nlc3Nvciwga2V5LCB2YWx1ZSwgY2hlY2tJZkRpZmZlcmVudCkgewogICAgICAgICAgICBpZiAoIXByb3BlcnR5IHx8ICFrby5pc1dyaXRlYWJsZU9ic2VydmFibGUocHJvcGVydHkpKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJvcFdyaXRlcnMgPSBhbGxCaW5kaW5nc0FjY2Vzc29yKClbJ19rb19wcm9wZXJ0eV93cml0ZXJzJ107CiAgICAgICAgICAgICAgICBpZiAocHJvcFdyaXRlcnMgJiYgcHJvcFdyaXRlcnNba2V5XSkKICAgICAgICAgICAgICAgICAgICBwcm9wV3JpdGVyc1trZXldKHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghY2hlY2tJZkRpZmZlcmVudCB8fCBwcm9wZXJ0eSgpICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgcHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfSkoKTsKCmtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcnLCBrby5qc29uRXhwcmVzc2lvblJld3JpdGluZyk7CmtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzJywga28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzKTsKa28uZXhwb3J0U3ltYm9sKCdqc29uRXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwnLCBrby5qc29uRXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwpOwprby5leHBvcnRTeW1ib2woJ2pzb25FeHByZXNzaW9uUmV3cml0aW5nLmluc2VydFByb3BlcnR5QWNjZXNzb3JzSW50b0pzb24nLCBrby5qc29uRXhwcmVzc2lvblJld3JpdGluZy5pbnNlcnRQcm9wZXJ0eUFjY2Vzc29yc0ludG9Kc29uKTsKKGZ1bmN0aW9uKCkgewogICAgLy8gIlZpcnR1YWwgZWxlbWVudHMiIGlzIGFuIGFic3RyYWN0aW9uIG9uIHRvcCBvZiB0aGUgdXN1YWwgRE9NIEFQSSB3aGljaCB1bmRlcnN0YW5kcyB0aGUgbm90aW9uIHRoYXQgY29tbWVudCBub2RlcwogICAgLy8gbWF5IGJlIHVzZWQgdG8gcmVwcmVzZW50IGhpZXJhcmNoeSAoaW4gYWRkaXRpb24gdG8gdGhlIERPTSdzIG5hdHVyYWwgaGllcmFyY2h5KS4KICAgIC8vIElmIHlvdSBjYWxsIHRoZSBET00tbWFuaXB1bGF0aW5nIGZ1bmN0aW9ucyBvbiBrby52aXJ0dWFsRWxlbWVudHMsIHlvdSB3aWxsIGJlIGFibGUgdG8gcmVhZCBhbmQgd3JpdGUgdGhlIHN0YXRlCiAgICAvLyBvZiB0aGF0IHZpcnR1YWwgaGllcmFyY2h5CiAgICAvLwogICAgLy8gVGhlIHBvaW50IG9mIGFsbCB0aGlzIGlzIHRvIHN1cHBvcnQgY29udGFpbmVybGVzcyB0ZW1wbGF0ZXMgKGUuZy4sIDwhLS0ga28gZm9yZWFjaDpzb21lQ29sbGVjdGlvbiAtLT5ibGFoPCEtLSAva28gLS0+KQogICAgLy8gd2l0aG91dCBoYXZpbmcgdG8gc2NhdHRlciBzcGVjaWFsIGNhc2VzIGFsbCBvdmVyIHRoZSBiaW5kaW5nIGFuZCB0ZW1wbGF0aW5nIGNvZGUuCgogICAgLy8gSUUgOSBjYW5ub3QgcmVsaWFibHkgcmVhZCB0aGUgIm5vZGVWYWx1ZSIgcHJvcGVydHkgb2YgYSBjb21tZW50IG5vZGUgKHNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzE4NikKICAgIC8vIGJ1dCBpdCBkb2VzIGdpdmUgdGhlbSBhIG5vbnN0YW5kYXJkIGFsdGVybmF0aXZlIHByb3BlcnR5IGNhbGxlZCAidGV4dCIgdGhhdCBpdCBjYW4gcmVhZCByZWxpYWJseS4gT3RoZXIgYnJvd3NlcnMgZG9uJ3QgaGF2ZSB0aGF0IHByb3BlcnR5LgogICAgLy8gU28sIHVzZSBub2RlLnRleHQgd2hlcmUgYXZhaWxhYmxlLCBhbmQgbm9kZS5ub2RlVmFsdWUgZWxzZXdoZXJlCiAgICB2YXIgY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA9IGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoInRlc3QiKS50ZXh0ID09PSAiPCEtLXRlc3QtLT4iOwoKICAgIHZhciBzdGFydENvbW1lbnRSZWdleCA9IGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyAvXjwhLS1ccyprb1xzKyguKlw6LiopXHMqLS0+JC8gOiAvXlxzKmtvXHMrKC4qXDouKilccyokLzsKICAgIHZhciBlbmRDb21tZW50UmVnZXggPSAgIGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyAvXjwhLS1ccypcL2tvXHMqLS0+JC8gOiAvXlxzKlwva29ccyokLzsKICAgIHZhciBodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuID0geyAndWwnOiB0cnVlLCAnb2wnOiB0cnVlIH07CgogICAgZnVuY3Rpb24gaXNTdGFydENvbW1lbnQobm9kZSkgewogICAgICAgIHJldHVybiAobm9kZS5ub2RlVHlwZSA9PSA4KSAmJiAoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKS5tYXRjaChzdGFydENvbW1lbnRSZWdleCk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNFbmRDb21tZW50KG5vZGUpIHsKICAgICAgICByZXR1cm4gKG5vZGUubm9kZVR5cGUgPT0gOCkgJiYgKGNvbW1lbnROb2Rlc0hhdmVUZXh0UHJvcGVydHkgPyBub2RlLnRleHQgOiBub2RlLm5vZGVWYWx1ZSkubWF0Y2goZW5kQ29tbWVudFJlZ2V4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRWaXJ0dWFsQ2hpbGRyZW4oc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpIHsKICAgICAgICB2YXIgY3VycmVudE5vZGUgPSBzdGFydENvbW1lbnQ7CiAgICAgICAgdmFyIGRlcHRoID0gMTsKICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICBpZiAoaXNFbmRDb21tZW50KGN1cnJlbnROb2RlKSkgewogICAgICAgICAgICAgICAgZGVwdGgtLTsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goY3VycmVudE5vZGUpOwoKICAgICAgICAgICAgaWYgKGlzU3RhcnRDb21tZW50KGN1cnJlbnROb2RlKSkKICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgfQogICAgICAgIGlmICghYWxsb3dVbmJhbGFuY2VkKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIGNsb3NpbmcgY29tbWVudCB0YWcgdG8gbWF0Y2g6ICIgKyBzdGFydENvbW1lbnQubm9kZVZhbHVlKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRNYXRjaGluZ0VuZENvbW1lbnQoc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpIHsKICAgICAgICB2YXIgYWxsVmlydHVhbENoaWxkcmVuID0gZ2V0VmlydHVhbENoaWxkcmVuKHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKTsKICAgICAgICBpZiAoYWxsVmlydHVhbENoaWxkcmVuKSB7CiAgICAgICAgICAgIGlmIChhbGxWaXJ0dWFsQ2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgIHJldHVybiBhbGxWaXJ0dWFsQ2hpbGRyZW5bYWxsVmlydHVhbENoaWxkcmVuLmxlbmd0aCAtIDFdLm5leHRTaWJsaW5nOwogICAgICAgICAgICByZXR1cm4gc3RhcnRDb21tZW50Lm5leHRTaWJsaW5nOwogICAgICAgIH0gZWxzZQogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gTXVzdCBoYXZlIG5vIG1hdGNoaW5nIGVuZCBjb21tZW50LCBhbmQgYWxsb3dVbmJhbGFuY2VkIGlzIHRydWUKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRVbmJhbGFuY2VkQ2hpbGRUYWdzKG5vZGUpIHsKICAgICAgICAvLyBlLmcuLCBmcm9tIDxkaXY+T0s8L2Rpdj48IS0tIGtvIGJsYWggLS0+PHNwYW4+QW5vdGhlcjwvc3Bhbj4sIHJldHVybnM6IDwhLS0ga28gYmxhaCAtLT48c3Bhbj5Bbm90aGVyPC9zcGFuPgogICAgICAgIC8vICAgICAgIGZyb20gPGRpdj5PSzwvZGl2PjwhLS0gL2tvIC0tPjwhLS0gL2tvIC0tPiwgICAgICAgICAgICAgcmV0dXJuczogPCEtLSAva28gLS0+PCEtLSAva28gLS0+CiAgICAgICAgdmFyIGNoaWxkTm9kZSA9IG5vZGUuZmlyc3RDaGlsZCwgY2FwdHVyZVJlbWFpbmluZyA9IG51bGw7CiAgICAgICAgaWYgKGNoaWxkTm9kZSkgewogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBpZiAoY2FwdHVyZVJlbWFpbmluZykgICAgICAgICAgICAgICAgICAgLy8gV2UgYWxyZWFkeSBoaXQgYW4gdW5iYWxhbmNlZCBub2RlIGFuZCBhcmUgbm93IGp1c3Qgc2Nvb3BpbmcgdXAgYWxsIHN1YnNlcXVlbnQgbm9kZXMKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nLnB1c2goY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RhcnRDb21tZW50KGNoaWxkTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2hpbmdFbmRDb21tZW50ID0gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KGNoaWxkTm9kZSwgLyogYWxsb3dVbmJhbGFuY2VkOiAqLyB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdFbmRDb21tZW50KSAgICAgICAgICAgICAvLyBJdCdzIGEgYmFsYW5jZWQgdGFnLCBzbyBza2lwIGltbWVkaWF0ZWx5IHRvIHRoZSBlbmQgb2YgdGhpcyB2aXJ0dWFsIHNldAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUgPSBtYXRjaGluZ0VuZENvbW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nID0gW2NoaWxkTm9kZV07IC8vIEl0J3MgdW5iYWxhbmNlZCwgc28gc3RhcnQgY2FwdHVyaW5nIGZyb20gdGhpcyBwb2ludAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0VuZENvbW1lbnQoY2hpbGROb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVSZW1haW5pbmcgPSBbY2hpbGROb2RlXTsgICAgIC8vIEl0J3MgdW5iYWxhbmNlZCAoaWYgaXQgd2Fzbid0LCB3ZSdkIGhhdmUgc2tpcHBlZCBvdmVyIGl0IGFscmVhZHkpLCBzbyBzdGFydCBjYXB0dXJpbmcKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhcHR1cmVSZW1haW5pbmc7CiAgICB9CgogICAga28udmlydHVhbEVsZW1lbnRzID0gewogICAgICAgIGFsbG93ZWRCaW5kaW5nczoge30sCgogICAgICAgIGNoaWxkTm9kZXM6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzU3RhcnRDb21tZW50KG5vZGUpID8gZ2V0VmlydHVhbENoaWxkcmVuKG5vZGUpIDogbm9kZS5jaGlsZE5vZGVzOwogICAgICAgIH0sCgogICAgICAgIGVtcHR5Tm9kZTogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQogICAgICAgICAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB2aXJ0dWFsQ2hpbGRyZW4gPSBrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2Rlcyhub2RlKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gdmlydHVhbENoaWxkcmVuLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgICAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKHZpcnR1YWxDaGlsZHJlbltpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXREb21Ob2RlQ2hpbGRyZW46IGZ1bmN0aW9uKG5vZGUsIGNoaWxkTm9kZXMpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbihub2RlLCBjaGlsZE5vZGVzKTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKG5vZGUpOwogICAgICAgICAgICAgICAgdmFyIGVuZENvbW1lbnROb2RlID0gbm9kZS5uZXh0U2libGluZzsgLy8gTXVzdCBiZSB0aGUgbmV4dCBzaWJsaW5nLCBhcyB3ZSBqdXN0IGVtcHRpZWQgdGhlIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgICAgICAgICAgICAgICAgIGVuZENvbW1lbnROb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkTm9kZXNbaV0sIGVuZENvbW1lbnROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHByZXBlbmQ6IGZ1bmN0aW9uKGNvbnRhaW5lck5vZGUsIG5vZGVUb1ByZXBlbmQpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChjb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lck5vZGUuZmlyc3RDaGlsZCkKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmluc2VydEJlZm9yZShub2RlVG9QcmVwZW5kLCBjb250YWluZXJOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuYXBwZW5kQ2hpbGQobm9kZVRvUHJlcGVuZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTdGFydCBjb21tZW50cyBtdXN0IGFsd2F5cyBoYXZlIGEgcGFyZW50IGFuZCBhdCBsZWFzdCBvbmUgZm9sbG93aW5nIHNpYmxpbmcgKHRoZSBlbmQgY29tbWVudCkKICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvUHJlcGVuZCwgY29udGFpbmVyTm9kZS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBpbnNlcnRBZnRlcjogZnVuY3Rpb24oY29udGFpbmVyTm9kZSwgbm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChjb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgLy8gSW5zZXJ0IGFmdGVyIGluc2VydGlvbiBwb2ludAogICAgICAgICAgICAgICAgaWYgKGluc2VydEFmdGVyTm9kZS5uZXh0U2libGluZykKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLmluc2VydEJlZm9yZShub2RlVG9JbnNlcnQsIGluc2VydEFmdGVyTm9kZS5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyTm9kZS5hcHBlbmRDaGlsZChub2RlVG9JbnNlcnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQ2hpbGRyZW4gb2Ygc3RhcnQgY29tbWVudHMgbXVzdCBhbHdheXMgaGF2ZSBhIHBhcmVudCBhbmQgYXQgbGVhc3Qgb25lIGZvbGxvd2luZyBzaWJsaW5nICh0aGUgZW5kIGNvbW1lbnQpCiAgICAgICAgICAgICAgICBjb250YWluZXJOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb0luc2VydCwgaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGZpcnN0Q2hpbGQ6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGlmICghbm9kZS5uZXh0U2libGluZyB8fCBpc0VuZENvbW1lbnQobm9kZS5uZXh0U2libGluZykpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgfSwKCiAgICAgICAgbmV4dFNpYmxpbmc6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgaWYgKGlzU3RhcnRDb21tZW50KG5vZGUpKQogICAgICAgICAgICAgICAgbm9kZSA9IGdldE1hdGNoaW5nRW5kQ29tbWVudChub2RlKTsKICAgICAgICAgICAgaWYgKG5vZGUubmV4dFNpYmxpbmcgJiYgaXNFbmRDb21tZW50KG5vZGUubmV4dFNpYmxpbmcpKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwogICAgICAgIH0sCgogICAgICAgIHZpcnR1YWxOb2RlQmluZGluZ1ZhbHVlOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIHZhciByZWdleE1hdGNoID0gaXNTdGFydENvbW1lbnQobm9kZSk7CiAgICAgICAgICAgIHJldHVybiByZWdleE1hdGNoID8gcmVnZXhNYXRjaFsxXSA6IG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgbm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmU6IGZ1bmN0aW9uKGVsZW1lbnRWZXJpZmllZCkgewogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzE1NQogICAgICAgICAgICAvLyAoSUUgPD0gOCBvciBJRSA5IHF1aXJrcyBtb2RlIHBhcnNlcyB5b3VyIEhUTUwgd2VpcmRseSwgdHJlYXRpbmcgY2xvc2luZyA8L2xpPiB0YWdzIGFzIGlmIHRoZXkgZG9uJ3QgZXhpc3QsIHRoZXJlYnkgbW92aW5nIGNvbW1lbnQgbm9kZXMKICAgICAgICAgICAgLy8gdGhhdCBhcmUgZGlyZWN0IGRlc2NlbmRhbnRzIG9mIDx1bD4gaW50byB0aGUgcHJlY2VkaW5nIDxsaT4pCiAgICAgICAgICAgIGlmICghaHRtbFRhZ3NXaXRoT3B0aW9uYWxseUNsb3NpbmdDaGlsZHJlbltrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudFZlcmlmaWVkKV0pCiAgICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyBTY2FuIGltbWVkaWF0ZSBjaGlsZHJlbiB0byBzZWUgaWYgdGhleSBjb250YWluIHVuYmFsYW5jZWQgY29tbWVudCB0YWdzLiBJZiB0aGV5IGRvLCB0aG9zZSBjb21tZW50IHRhZ3MKICAgICAgICAgICAgLy8gbXVzdCBiZSBpbnRlbmRlZCB0byBhcHBlYXIgKmFmdGVyKiB0aGF0IGNoaWxkLCBzbyBtb3ZlIHRoZW0gdGhlcmUuCiAgICAgICAgICAgIHZhciBjaGlsZE5vZGUgPSBlbGVtZW50VmVyaWZpZWQuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKGNoaWxkTm9kZSkgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZE5vZGUubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVuYmFsYW5jZWRUYWdzID0gZ2V0VW5iYWxhbmNlZENoaWxkVGFncyhjaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5iYWxhbmNlZFRhZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpeCB1cCB0aGUgRE9NIGJ5IG1vdmluZyB0aGUgdW5iYWxhbmNlZCB0YWdzIHRvIHdoZXJlIHRoZXkgbW9zdCBsaWtlbHkgd2VyZSBpbnRlbmRlZCB0byBiZSBwbGFjZWQgLSAqYWZ0ZXIqIHRoZSBjaGlsZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVUb0luc2VydEJlZm9yZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdW5iYWxhbmNlZFRhZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZVRvSW5zZXJ0QmVmb3JlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50VmVyaWZpZWQuaW5zZXJ0QmVmb3JlKHVuYmFsYW5jZWRUYWdzW2ldLCBub2RlVG9JbnNlcnRCZWZvcmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFZlcmlmaWVkLmFwcGVuZENoaWxkKHVuYmFsYW5jZWRUYWdzW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KSgpOwprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cycsIGtvLnZpcnR1YWxFbGVtZW50cyk7CmtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5ncycsIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3MpOwprby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUnLCBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKTsKLy9rby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5maXJzdENoaWxkJywga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQpOyAgICAgLy8gZmlyc3RDaGlsZCBpcyBub3QgbWluaWZpZWQKa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuaW5zZXJ0QWZ0ZXInLCBrby52aXJ0dWFsRWxlbWVudHMuaW5zZXJ0QWZ0ZXIpOwovL2tvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLm5leHRTaWJsaW5nJywga28udmlydHVhbEVsZW1lbnRzLm5leHRTaWJsaW5nKTsgICAvLyBuZXh0U2libGluZyBpcyBub3QgbWluaWZpZWQKa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMucHJlcGVuZCcsIGtvLnZpcnR1YWxFbGVtZW50cy5wcmVwZW5kKTsKa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuJywga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbik7CihmdW5jdGlvbigpIHsKICAgIHZhciBkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUgPSAiZGF0YS1iaW5kIjsKCiAgICBrby5iaW5kaW5nUHJvdmlkZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmJpbmRpbmdDYWNoZSA9IHt9OwogICAgfTsKCiAgICBrby51dGlscy5leHRlbmQoa28uYmluZGluZ1Byb3ZpZGVyLnByb3RvdHlwZSwgewogICAgICAgICdub2RlSGFzQmluZGluZ3MnOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAxOiByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoZGVmYXVsdEJpbmRpbmdBdHRyaWJ1dGVOYW1lKSAhPSBudWxsOyAgIC8vIEVsZW1lbnQKICAgICAgICAgICAgICAgIGNhc2UgODogcmV0dXJuIGtvLnZpcnR1YWxFbGVtZW50cy52aXJ0dWFsTm9kZUJpbmRpbmdWYWx1ZShub2RlKSAhPSBudWxsOyAvLyBDb21tZW50IG5vZGUKICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgICdnZXRCaW5kaW5ncyc6IGZ1bmN0aW9uKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBiaW5kaW5nc1N0cmluZyA9IHRoaXNbJ2dldEJpbmRpbmdzU3RyaW5nJ10obm9kZSwgYmluZGluZ0NvbnRleHQpOwogICAgICAgICAgICByZXR1cm4gYmluZGluZ3NTdHJpbmcgPyB0aGlzWydwYXJzZUJpbmRpbmdzU3RyaW5nJ10oYmluZGluZ3NTdHJpbmcsIGJpbmRpbmdDb250ZXh0KSA6IG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBpcyBvbmx5IHVzZWQgaW50ZXJuYWxseSBieSB0aGlzIGRlZmF1bHQgcHJvdmlkZXIuCiAgICAgICAgLy8gSXQncyBub3QgcGFydCBvZiB0aGUgaW50ZXJmYWNlIGRlZmluaXRpb24gZm9yIGEgZ2VuZXJhbCBiaW5kaW5nIHByb3ZpZGVyLgogICAgICAgICdnZXRCaW5kaW5nc1N0cmluZyc6IGZ1bmN0aW9uKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAxOiByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoZGVmYXVsdEJpbmRpbmdBdHRyaWJ1dGVOYW1lKTsgICAvLyBFbGVtZW50CiAgICAgICAgICAgICAgICBjYXNlIDg6IHJldHVybiBrby52aXJ0dWFsRWxlbWVudHMudmlydHVhbE5vZGVCaW5kaW5nVmFsdWUobm9kZSk7IC8vIENvbW1lbnQgbm9kZQogICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIG9ubHkgdXNlZCBpbnRlcm5hbGx5IGJ5IHRoaXMgZGVmYXVsdCBwcm92aWRlci4KICAgICAgICAvLyBJdCdzIG5vdCBwYXJ0IG9mIHRoZSBpbnRlcmZhY2UgZGVmaW5pdGlvbiBmb3IgYSBnZW5lcmFsIGJpbmRpbmcgcHJvdmlkZXIuCiAgICAgICAgJ3BhcnNlQmluZGluZ3NTdHJpbmcnOiBmdW5jdGlvbihiaW5kaW5nc1N0cmluZywgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHZhciB2aWV3TW9kZWwgPSBiaW5kaW5nQ29udGV4dFsnJGRhdGEnXSwKICAgICAgICAgICAgICAgICAgICBzY29wZXMgPSAodHlwZW9mIHZpZXdNb2RlbCA9PSAnb2JqZWN0JyAmJiB2aWV3TW9kZWwgIT0gbnVsbCkgPyBbdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dF0gOiBbYmluZGluZ0NvbnRleHRdLAogICAgICAgICAgICAgICAgICAgIGJpbmRpbmdGdW5jdGlvbiA9IGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yVmlhQ2FjaGUoYmluZGluZ3NTdHJpbmcsIHNjb3Blcy5sZW5ndGgsIHRoaXMuYmluZGluZ0NhY2hlKTsKICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nRnVuY3Rpb24oc2NvcGVzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIHBhcnNlIGJpbmRpbmdzLlxuTWVzc2FnZTogIiArIGV4ICsgIjtcbkJpbmRpbmdzIHZhbHVlOiAiICsgYmluZGluZ3NTdHJpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddID0gbmV3IGtvLmJpbmRpbmdQcm92aWRlcigpOwoKICAgIGZ1bmN0aW9uIGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yVmlhQ2FjaGUoYmluZGluZ3NTdHJpbmcsIHNjb3Blc0NvdW50LCBjYWNoZSkgewogICAgICAgIHZhciBjYWNoZUtleSA9IHNjb3Blc0NvdW50ICsgJ18nICsgYmluZGluZ3NTdHJpbmc7CiAgICAgICAgcmV0dXJuIGNhY2hlW2NhY2hlS2V5XQogICAgICAgICAgICB8fCAoY2FjaGVbY2FjaGVLZXldID0gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3IoYmluZGluZ3NTdHJpbmcsIHNjb3Blc0NvdW50KSk7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3IoYmluZGluZ3NTdHJpbmcsIHNjb3Blc0NvdW50KSB7CiAgICAgICAgdmFyIHJld3JpdHRlbkJpbmRpbmdzID0gIiB7ICIgKyBrby5qc29uRXhwcmVzc2lvblJld3JpdGluZy5pbnNlcnRQcm9wZXJ0eUFjY2Vzc29yc0ludG9Kc29uKGJpbmRpbmdzU3RyaW5nKSArICIgfSAiOwogICAgICAgIHJldHVybiBrby51dGlscy5idWlsZEV2YWxXaXRoaW5TY29wZUZ1bmN0aW9uKHJld3JpdHRlbkJpbmRpbmdzLCBzY29wZXNDb3VudCk7CiAgICB9Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ2JpbmRpbmdQcm92aWRlcicsIGtvLmJpbmRpbmdQcm92aWRlcik7CihmdW5jdGlvbiAoKSB7CiAgICBrby5iaW5kaW5nSGFuZGxlcnMgPSB7fTsKCiAgICBrby5iaW5kaW5nQ29udGV4dCA9IGZ1bmN0aW9uKGRhdGFJdGVtLCBwYXJlbnRCaW5kaW5nQ29udGV4dCkgewogICAgICAgIGlmIChwYXJlbnRCaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICBrby51dGlscy5leHRlbmQodGhpcywgcGFyZW50QmluZGluZ0NvbnRleHQpOyAvLyBJbmhlcml0ICRyb290IGFuZCBhbnkgY3VzdG9tIHByb3BlcnRpZXMKICAgICAgICAgICAgdGhpc1snJHBhcmVudENvbnRleHQnXSA9IHBhcmVudEJpbmRpbmdDb250ZXh0OwogICAgICAgICAgICB0aGlzWyckcGFyZW50J10gPSBwYXJlbnRCaW5kaW5nQ29udGV4dFsnJGRhdGEnXTsKICAgICAgICAgICAgdGhpc1snJHBhcmVudHMnXSA9IChwYXJlbnRCaW5kaW5nQ29udGV4dFsnJHBhcmVudHMnXSB8fCBbXSkuc2xpY2UoMCk7CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10udW5zaGlmdCh0aGlzWyckcGFyZW50J10pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNbJyRwYXJlbnRzJ10gPSBbXTsKICAgICAgICAgICAgdGhpc1snJHJvb3QnXSA9IGRhdGFJdGVtOwogICAgICAgIH0KICAgICAgICB0aGlzWyckZGF0YSddID0gZGF0YUl0ZW07CiAgICB9CiAgICBrby5iaW5kaW5nQ29udGV4dC5wcm90b3R5cGVbJ2NyZWF0ZUNoaWxkQ29udGV4dCddID0gZnVuY3Rpb24gKGRhdGFJdGVtKSB7CiAgICAgICAgcmV0dXJuIG5ldyBrby5iaW5kaW5nQ29udGV4dChkYXRhSXRlbSwgdGhpcyk7CiAgICB9OwogICAga28uYmluZGluZ0NvbnRleHQucHJvdG90eXBlWydleHRlbmQnXSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpIHsKICAgICAgICB2YXIgY2xvbmUgPSBrby51dGlscy5leHRlbmQobmV3IGtvLmJpbmRpbmdDb250ZXh0KCksIHRoaXMpOwogICAgICAgIHJldHVybiBrby51dGlscy5leHRlbmQoY2xvbmUsIHByb3BlcnRpZXMpOwogICAgfTsKCiAgICBmdW5jdGlvbiB2YWxpZGF0ZVRoYXRCaW5kaW5nSXNBbGxvd2VkRm9yVmlydHVhbEVsZW1lbnRzKGJpbmRpbmdOYW1lKSB7CiAgICAgICAgdmFyIHZhbGlkYXRvciA9IGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbYmluZGluZ05hbWVdOwogICAgICAgIGlmICghdmFsaWRhdG9yKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBiaW5kaW5nICciICsgYmluZGluZ05hbWUgKyAiJyBjYW5ub3QgYmUgdXNlZCB3aXRoIHZpcnR1YWwgZWxlbWVudHMiKQogICAgfQoKICAgIGZ1bmN0aW9uIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwgKHZpZXdNb2RlbCwgZWxlbWVudE9yVmlydHVhbEVsZW1lbnQsIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCwgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZChlbGVtZW50T3JWaXJ0dWFsRWxlbWVudCk7CiAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZCA9IG5leHRJblF1ZXVlKSB7CiAgICAgICAgICAgIC8vIEtlZXAgYSByZWNvcmQgb2YgdGhlIG5leHQgY2hpbGQgKmJlZm9yZSogYXBwbHlpbmcgYmluZGluZ3MsIGluIGNhc2UgdGhlIGJpbmRpbmcgcmVtb3ZlcyB0aGUgY3VycmVudCBjaGlsZCBmcm9tIGl0cyBwb3NpdGlvbgogICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhjdXJyZW50Q2hpbGQpOwogICAgICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIGN1cnJlbnRDaGlsZCwgYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCAodmlld01vZGVsLCBub2RlVmVyaWZpZWQsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpIHsKICAgICAgICB2YXIgc2hvdWxkQmluZERlc2NlbmRhbnRzID0gdHJ1ZTsKCiAgICAgICAgLy8gUGVyZiBvcHRpbWlzYXRpb246IEFwcGx5IGJpbmRpbmdzIG9ubHkgaWYuLi4KICAgICAgICAvLyAoMSkgV2UgbmVlZCB0byBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSAoYmVjYXVzZSBpdCBtYXkgZGlmZmVyIGZyb20gdGhlIERPTSBwYXJlbnQgbm9kZSdzIGJpbmRpbmcgY29udGV4dCkKICAgICAgICAvLyAgICAgTm90ZSB0aGF0IHdlIGNhbid0IHN0b3JlIGJpbmRpbmcgY29udGV4dHMgb24gbm9uLWVsZW1lbnRzIChlLmcuLCB0ZXh0IG5vZGVzKSwgYXMgSUUgZG9lc24ndCBhbGxvdyBleHBhbmRvIHByb3BlcnRpZXMgZm9yIHRob3NlCiAgICAgICAgLy8gKDIpIEl0IG1pZ2h0IGhhdmUgYmluZGluZ3MgKGUuZy4sIGl0IGhhcyBhIGRhdGEtYmluZCBhdHRyaWJ1dGUsIG9yIGl0J3MgYSBtYXJrZXIgZm9yIGEgY29udGFpbmVybGVzcyB0ZW1wbGF0ZSkKICAgICAgICB2YXIgaXNFbGVtZW50ID0gKG5vZGVWZXJpZmllZC5ub2RlVHlwZSA9PT0gMSk7CiAgICAgICAgaWYgKGlzRWxlbWVudCkgLy8gV29ya2Fyb3VuZCBJRSA8PSA4IEhUTUwgcGFyc2luZyB3ZWlyZG5lc3MKICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLm5vcm1hbGlzZVZpcnR1YWxFbGVtZW50RG9tU3RydWN0dXJlKG5vZGVWZXJpZmllZCk7CgogICAgICAgIHZhciBzaG91bGRBcHBseUJpbmRpbmdzID0gKGlzRWxlbWVudCAmJiBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSAgICAgICAgICAgICAvLyBDYXNlICgxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydub2RlSGFzQmluZGluZ3MnXShub2RlVmVyaWZpZWQpOyAgICAgICAvLyBDYXNlICgyKQogICAgICAgIGlmIChzaG91bGRBcHBseUJpbmRpbmdzKQogICAgICAgICAgICBzaG91bGRCaW5kRGVzY2VuZGFudHMgPSBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZVZlcmlmaWVkLCBudWxsLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpLnNob3VsZEJpbmREZXNjZW5kYW50czsKCiAgICAgICAgaWYgKHNob3VsZEJpbmREZXNjZW5kYW50cykgewogICAgICAgICAgICAvLyBXZSdyZSByZWN1cnNpbmcgYXV0b21hdGljYWxseSBpbnRvIChyZWFsIG9yIHZpcnR1YWwpIGNoaWxkIG5vZGVzIHdpdGhvdXQgY2hhbmdpbmcgYmluZGluZyBjb250ZXh0cy4gU28sCiAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICpyZWFsKiBlbGVtZW50LCB0aGUgYmluZGluZyBjb250ZXh0IGlzIGNlcnRhaW5seSB0aGUgc2FtZSBhcyBvbiB0aGVpciBET00gLnBhcmVudE5vZGUsCiAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIGZhbHNlCiAgICAgICAgICAgIC8vICAqIEZvciBjaGlsZHJlbiBvZiBhICp2aXJ0dWFsKiBlbGVtZW50LCB3ZSBjYW4ndCBiZSBzdXJlLiBFdmFsdWF0aW5nIC5wYXJlbnROb2RlIG9uIHRob3NlIGNoaWxkcmVuIG1heQogICAgICAgICAgICAvLyAgICBza2lwIG92ZXIgYW55IG51bWJlciBvZiBpbnRlcm1lZGlhdGUgdmlydHVhbCBlbGVtZW50cywgYW55IG9mIHdoaWNoIG1pZ2h0IGRlZmluZSBhIGN1c3RvbSBiaW5kaW5nIGNvbnRleHQsCiAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIHRydWUKICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIG5vZGVWZXJpZmllZCwgLyogYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQ6ICovICFpc0VsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwgKG5vZGUsIGJpbmRpbmdzLCB2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0LCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CiAgICAgICAgLy8gTmVlZCB0byBiZSBzdXJlIHRoYXQgaW5pdHMgYXJlIG9ubHkgcnVuIG9uY2UsIGFuZCB1cGRhdGVzIG5ldmVyIHJ1biB1bnRpbCBhbGwgdGhlIGluaXRzIGhhdmUgYmVlbiBydW4KICAgICAgICB2YXIgaW5pdFBoYXNlID0gMDsgLy8gMCA9IGJlZm9yZSBhbGwgaW5pdHMsIDEgPSBkdXJpbmcgaW5pdHMsIDIgPSBhZnRlciBhbGwgaW5pdHMKCiAgICAgICAgLy8gRWFjaCB0aW1lIHRoZSBkZXBlbmRlbnRPYnNlcnZhYmxlIGlzIGV2YWx1YXRlZCAoYWZ0ZXIgZGF0YSBjaGFuZ2VzKSwKICAgICAgICAvLyB0aGUgYmluZGluZyBhdHRyaWJ1dGUgaXMgcmVwYXJzZWQgc28gdGhhdCBpdCBjYW4gcGljayBvdXQgdGhlIGNvcnJlY3QKICAgICAgICAvLyBtb2RlbCBwcm9wZXJ0aWVzIGluIHRoZSBjb250ZXh0IG9mIHRoZSBjaGFuZ2VkIGRhdGEuCiAgICAgICAgLy8gRE9NIGV2ZW50IGNhbGxiYWNrcyBuZWVkIHRvIGJlIGFibGUgdG8gYWNjZXNzIHRoaXMgY2hhbmdlZCBkYXRhLAogICAgICAgIC8vIHNvIHdlIG5lZWQgYSBzaW5nbGUgcGFyc2VkQmluZGluZ3MgdmFyaWFibGUgKHNoYXJlZCBieSBhbGwgY2FsbGJhY2tzCiAgICAgICAgLy8gYXNzb2NpYXRlZCB3aXRoIHRoaXMgbm9kZSdzIGJpbmRpbmdzKSB0aGF0IGFsbCB0aGUgY2xvc3VyZXMgY2FuIGFjY2Vzcy4KICAgICAgICB2YXIgcGFyc2VkQmluZGluZ3M7CiAgICAgICAgZnVuY3Rpb24gbWFrZVZhbHVlQWNjZXNzb3IoYmluZGluZ0tleSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgeyByZXR1cm4gcGFyc2VkQmluZGluZ3NbYmluZGluZ0tleV0gfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZWRCaW5kaW5nc0FjY2Vzc29yKCkgewogICAgICAgICAgICByZXR1cm4gcGFyc2VkQmluZGluZ3M7CiAgICAgICAgfQoKICAgICAgICB2YXIgYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3M7CiAgICAgICAga28uZGVwZW5kZW50T2JzZXJ2YWJsZSgKICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgYSBub25udWxsIGJpbmRpbmcgY29udGV4dCB0byB3b3JrIHdpdGgKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nQ29udGV4dEluc3RhbmNlID0gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCAmJiAodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCBpbnN0YW5jZW9mIGtvLmJpbmRpbmdDb250ZXh0KQogICAgICAgICAgICAgICAgICAgID8gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dAogICAgICAgICAgICAgICAgICAgIDogbmV3IGtvLmJpbmRpbmdDb250ZXh0KGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCkpOwogICAgICAgICAgICAgICAgdmFyIHZpZXdNb2RlbCA9IGJpbmRpbmdDb250ZXh0SW5zdGFuY2VbJyRkYXRhJ107CgogICAgICAgICAgICAgICAgLy8gT3B0aW1pemF0aW9uOiBEb24ndCBzdG9yZSB0aGUgYmluZGluZyBjb250ZXh0IG9uIHRoaXMgbm9kZSBpZiBpdCdzIGRlZmluaXRlbHkgdGhlIHNhbWUgYXMgb24gbm9kZS5wYXJlbnROb2RlLCBiZWNhdXNlCiAgICAgICAgICAgICAgICAvLyB3ZSBjYW4gZWFzaWx5IHJlY292ZXIgaXQganVzdCBieSBzY2FubmluZyB1cCB0aGUgbm9kZSdzIGFuY2VzdG9ycyBpbiB0aGUgRE9NCiAgICAgICAgICAgICAgICAvLyAobm90ZTogaGVyZSwgcGFyZW50IG5vZGUgbWVhbnMgInJlYWwgRE9NIHBhcmVudCIgbm90ICJ2aXJ0dWFsIHBhcmVudCIsIGFzIHRoZXJlJ3Mgbm8gTygxKSB3YXkgdG8gZmluZCB0aGUgdmlydHVhbCBwYXJlbnQpCiAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkKICAgICAgICAgICAgICAgICAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUobm9kZSwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgLy8gVXNlIGV2YWx1YXRlZEJpbmRpbmdzIGlmIGdpdmVuLCBvdGhlcndpc2UgZmFsbCBiYWNrIG9uIGFza2luZyB0aGUgYmluZGluZ3MgcHJvdmlkZXIgdG8gZ2l2ZSB1cyBzb21lIGJpbmRpbmdzCiAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdGVkQmluZGluZ3MgPSAodHlwZW9mIGJpbmRpbmdzID09ICJmdW5jdGlvbiIpID8gYmluZGluZ3MoKSA6IGJpbmRpbmdzOwogICAgICAgICAgICAgICAgcGFyc2VkQmluZGluZ3MgPSBldmFsdWF0ZWRCaW5kaW5ncyB8fCBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ11bJ2dldEJpbmRpbmdzJ10obm9kZSwgYmluZGluZ0NvbnRleHRJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgaWYgKHBhcnNlZEJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRmlyc3QgcnVuIGFsbCB0aGUgaW5pdHMsIHNvIGJpbmRpbmdzIGNhbiByZWdpc3RlciBmb3Igbm90aWZpY2F0aW9uIG9uIGNoYW5nZXMKICAgICAgICAgICAgICAgICAgICBpZiAoaW5pdFBoYXNlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRQaGFzZSA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGJpbmRpbmdLZXkgaW4gcGFyc2VkQmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nID0ga28uYmluZGluZ0hhbmRsZXJzW2JpbmRpbmdLZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmcgJiYgbm9kZS5ub2RlVHlwZSA9PT0gOCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZVRoYXRCaW5kaW5nSXNBbGxvd2VkRm9yVmlydHVhbEVsZW1lbnRzKGJpbmRpbmdLZXkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nICYmIHR5cGVvZiBiaW5kaW5nWyJpbml0Il0gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVySW5pdEZuID0gYmluZGluZ1siaW5pdCJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbml0UmVzdWx0ID0gaGFuZGxlckluaXRGbihub2RlLCBtYWtlVmFsdWVBY2Nlc3NvcihiaW5kaW5nS2V5KSwgcGFyc2VkQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dEluc3RhbmNlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhpcyBiaW5kaW5nIGhhbmRsZXIgY2xhaW1zIHRvIGNvbnRyb2wgZGVzY2VuZGFudCBiaW5kaW5ncywgbWFrZSBhIG5vdGUgb2YgdGhpcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbml0UmVzdWx0ICYmIGluaXRSZXN1bHRbJ2NvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzJ10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk11bHRpcGxlIGJpbmRpbmdzICgiICsgYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MgKyAiIGFuZCAiICsgYmluZGluZ0tleSArICIpIGFyZSB0cnlpbmcgdG8gY29udHJvbCBkZXNjZW5kYW50IGJpbmRpbmdzIG9mIHRoZSBzYW1lIGVsZW1lbnQuIFlvdSBjYW5ub3QgdXNlIHRoZXNlIGJpbmRpbmdzIHRvZ2V0aGVyIG9uIHRoZSBzYW1lIGVsZW1lbnQuIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzID0gYmluZGluZ0tleTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaW5pdFBoYXNlID0gMjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIC4uLiB0aGVuIHJ1biBhbGwgdGhlIHVwZGF0ZXMsIHdoaWNoIG1pZ2h0IHRyaWdnZXIgY2hhbmdlcyBldmVuIG9uIHRoZSBmaXJzdCBldmFsdWF0aW9uCiAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRQaGFzZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBiaW5kaW5nS2V5IGluIHBhcnNlZEJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nICYmIHR5cGVvZiBiaW5kaW5nWyJ1cGRhdGUiXSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhhbmRsZXJVcGRhdGVGbiA9IGJpbmRpbmdbInVwZGF0ZSJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXJVcGRhdGVGbihub2RlLCBtYWtlVmFsdWVBY2Nlc3NvcihiaW5kaW5nS2V5KSwgcGFyc2VkQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgeyAnZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkJyA6IG5vZGUgfQogICAgICAgICk7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNob3VsZEJpbmREZXNjZW5kYW50czogYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MgPT09IHVuZGVmaW5lZAogICAgICAgIH07CiAgICB9OwoKICAgIHZhciBzdG9yZWRCaW5kaW5nQ29udGV4dERvbURhdGFLZXkgPSAiX19rb19iaW5kaW5nQ29udGV4dF9fIjsKICAgIGtvLnN0b3JlZEJpbmRpbmdDb250ZXh0Rm9yTm9kZSA9IGZ1bmN0aW9uIChub2RlLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDIpCiAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KG5vZGUsIHN0b3JlZEJpbmRpbmdDb250ZXh0RG9tRGF0YUtleSwgYmluZGluZ0NvbnRleHQpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KG5vZGUsIHN0b3JlZEJpbmRpbmdDb250ZXh0RG9tRGF0YUtleSk7CiAgICB9CgogICAga28uYXBwbHlCaW5kaW5nc1RvTm9kZSA9IGZ1bmN0aW9uIChub2RlLCBiaW5kaW5ncywgdmlld01vZGVsKSB7CiAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIC8vIElmIGl0J3MgYW4gZWxlbWVudCwgd29ya2Fyb3VuZCBJRSA8PSA4IEhUTUwgcGFyc2luZyB3ZWlyZG5lc3MKICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLm5vcm1hbGlzZVZpcnR1YWxFbGVtZW50RG9tU3RydWN0dXJlKG5vZGUpOwogICAgICAgIHJldHVybiBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZSwgYmluZGluZ3MsIHZpZXdNb2RlbCwgdHJ1ZSk7CiAgICB9OwoKICAgIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzID0gZnVuY3Rpb24odmlld01vZGVsLCByb290Tm9kZSkgewogICAgICAgIGlmIChyb290Tm9kZS5ub2RlVHlwZSA9PT0gMSB8fCByb290Tm9kZS5ub2RlVHlwZSA9PT0gOCkKICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHNJbnRlcm5hbCh2aWV3TW9kZWwsIHJvb3ROb2RlLCB0cnVlKTsKICAgIH07CgogICAga28uYXBwbHlCaW5kaW5ncyA9IGZ1bmN0aW9uICh2aWV3TW9kZWwsIHJvb3ROb2RlKSB7CiAgICAgICAgaWYgKHJvb3ROb2RlICYmIChyb290Tm9kZS5ub2RlVHlwZSAhPT0gMSkgJiYgKHJvb3ROb2RlLm5vZGVUeXBlICE9PSA4KSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJrby5hcHBseUJpbmRpbmdzOiBmaXJzdCBwYXJhbWV0ZXIgc2hvdWxkIGJlIHlvdXIgdmlldyBtb2RlbDsgc2Vjb25kIHBhcmFtZXRlciBzaG91bGQgYmUgYSBET00gbm9kZSIpOwogICAgICAgIHJvb3ROb2RlID0gcm9vdE5vZGUgfHwgd2luZG93LmRvY3VtZW50LmJvZHk7IC8vIE1ha2UgInJvb3ROb2RlIiBwYXJhbWV0ZXIgb3B0aW9uYWwKCiAgICAgICAgYXBwbHlCaW5kaW5nc1RvTm9kZUFuZERlc2NlbmRhbnRzSW50ZXJuYWwodmlld01vZGVsLCByb290Tm9kZSwgdHJ1ZSk7CiAgICB9OwoKICAgIC8vIFJldHJpZXZpbmcgYmluZGluZyBjb250ZXh0IGZyb20gYXJiaXRyYXJ5IG5vZGVzCiAgICBrby5jb250ZXh0Rm9yID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgIC8vIFdlIGNhbiBvbmx5IGRvIHNvbWV0aGluZyBtZWFuaW5nZnVsIGZvciBlbGVtZW50cyBhbmQgY29tbWVudCBub2RlcyAoaW4gcGFydGljdWxhciwgbm90IHRleHQgbm9kZXMsIGFzIElFIGNhbid0IHN0b3JlIGRvbWRhdGEgZm9yIHRoZW0pCiAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUobm9kZSk7CiAgICAgICAgICAgICAgICBpZiAoY29udGV4dCkgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKSByZXR1cm4ga28uY29udGV4dEZvcihub2RlLnBhcmVudE5vZGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9OwogICAga28uZGF0YUZvciA9IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICB2YXIgY29udGV4dCA9IGtvLmNvbnRleHRGb3Iobm9kZSk7CiAgICAgICAgcmV0dXJuIGNvbnRleHQgPyBjb250ZXh0WyckZGF0YSddIDogdW5kZWZpbmVkOwogICAgfTsKCiAgICBrby5leHBvcnRTeW1ib2woJ2JpbmRpbmdIYW5kbGVycycsIGtvLmJpbmRpbmdIYW5kbGVycyk7CiAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ3MnLCBrby5hcHBseUJpbmRpbmdzKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHMnLCBrby5hcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cyk7CiAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ3NUb05vZGUnLCBrby5hcHBseUJpbmRpbmdzVG9Ob2RlKTsKICAgIGtvLmV4cG9ydFN5bWJvbCgnY29udGV4dEZvcicsIGtvLmNvbnRleHRGb3IpOwogICAga28uZXhwb3J0U3ltYm9sKCdkYXRhRm9yJywga28uZGF0YUZvcik7Cn0pKCk7Ci8vIEZvciBjZXJ0YWluIGNvbW1vbiBldmVudHMgKGN1cnJlbnRseSBqdXN0ICdjbGljaycpLCBhbGxvdyBhIHNpbXBsaWZpZWQgZGF0YS1iaW5kaW5nIHN5bnRheAovLyBlLmcuIGNsaWNrOmhhbmRsZXIgaW5zdGVhZCBvZiB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9CnZhciBldmVudEhhbmRsZXJzV2l0aFNob3J0Y3V0cyA9IFsnY2xpY2snXTsKa28udXRpbHMuYXJyYXlGb3JFYWNoKGV2ZW50SGFuZGxlcnNXaXRoU2hvcnRjdXRzLCBmdW5jdGlvbihldmVudE5hbWUpIHsKICAgIGtvLmJpbmRpbmdIYW5kbGVyc1tldmVudE5hbWVdID0gewogICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZUFjY2Vzc29yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgcmVzdWx0W2V2ZW50TmFtZV0gPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWydldmVudCddWydpbml0J10uY2FsbCh0aGlzLCBlbGVtZW50LCBuZXdWYWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpOwogICAgICAgIH0KICAgIH0KfSk7CgoKa28uYmluZGluZ0hhbmRsZXJzWydldmVudCddID0gewogICAgJ2luaXQnIDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCkgewogICAgICAgIHZhciBldmVudHNUb0hhbmRsZSA9IHZhbHVlQWNjZXNzb3IoKSB8fCB7fTsKICAgICAgICBmb3IodmFyIGV2ZW50TmFtZU91dHNpZGVDbG9zdXJlIGluIGV2ZW50c1RvSGFuZGxlKSB7CiAgICAgICAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBldmVudE5hbWVPdXRzaWRlQ2xvc3VyZTsgLy8gU2VwYXJhdGUgdmFyaWFibGUgdG8gYmUgY2FwdHVyZWQgYnkgZXZlbnQgaGFuZGxlciBjbG9zdXJlCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50TmFtZSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyUmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyRnVuY3Rpb24gPSB2YWx1ZUFjY2Vzc29yKClbZXZlbnROYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYW5kbGVyRnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUYWtlIGFsbCB0aGUgZXZlbnQgYXJncywgYW5kIHByZWZpeCB3aXRoIHRoZSB2aWV3bW9kZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzRm9ySGFuZGxlciA9IGtvLnV0aWxzLm1ha2VBcnJheShhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc0ZvckhhbmRsZXIudW5zaGlmdCh2aWV3TW9kZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlclJldHVyblZhbHVlID0gaGFuZGxlckZ1bmN0aW9uLmFwcGx5KHZpZXdNb2RlbCwgYXJnc0ZvckhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXJSZXR1cm5WYWx1ZSAhPT0gdHJ1ZSkgeyAvLyBOb3JtYWxseSB3ZSB3YW50IHRvIHByZXZlbnQgZGVmYXVsdCBhY3Rpb24uIERldmVsb3BlciBjYW4gb3ZlcnJpZGUgdGhpcyBiZSBleHBsaWNpdGx5IHJldHVybmluZyB0cnVlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBidWJibGUgPSBhbGxCaW5kaW5nc1tldmVudE5hbWUgKyAnQnViYmxlJ10gIT09IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWJ1YmJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkoKTsKICAgICAgICB9CiAgICB9Cn07Cgprby5iaW5kaW5nSGFuZGxlcnNbJ3N1Ym1pdCddID0gewogICAgJ2luaXQnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsKSB7CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZUFjY2Vzc29yKCkgIT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgdmFsdWUgZm9yIGEgc3VibWl0IGJpbmRpbmcgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgInN1Ym1pdCIsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICB2YXIgaGFuZGxlclJldHVyblZhbHVlOwogICAgICAgICAgICB2YXIgdmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgIHRyeSB7IGhhbmRsZXJSZXR1cm5WYWx1ZSA9IHZhbHVlLmNhbGwodmlld01vZGVsLCBlbGVtZW50KTsgfQogICAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlmIChoYW5kbGVyUmV0dXJuVmFsdWUgIT09IHRydWUpIHsgLy8gTm9ybWFsbHkgd2Ugd2FudCB0byBwcmV2ZW50IGRlZmF1bHQgYWN0aW9uLiBEZXZlbG9wZXIgY2FuIG92ZXJyaWRlIHRoaXMgYmUgZXhwbGljaXRseSByZXR1cm5pbmcgdHJ1ZS4KICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9Cn07Cgprby5iaW5kaW5nSGFuZGxlcnNbJ3Zpc2libGUnXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKICAgICAgICB2YXIgaXNDdXJyZW50bHlWaXNpYmxlID0gIShlbGVtZW50LnN0eWxlLmRpc3BsYXkgPT0gIm5vbmUiKTsKICAgICAgICBpZiAodmFsdWUgJiYgIWlzQ3VycmVudGx5VmlzaWJsZSkKICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gIiI7CiAgICAgICAgZWxzZSBpZiAoKCF2YWx1ZSkgJiYgaXNDdXJyZW50bHlWaXNpYmxlKQogICAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB9Cn0KCmtvLmJpbmRpbmdIYW5kbGVyc1snZW5hYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgaWYgKHZhbHVlICYmIGVsZW1lbnQuZGlzYWJsZWQpCiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJkaXNhYmxlZCIpOwogICAgICAgIGVsc2UgaWYgKCghdmFsdWUpICYmICghZWxlbWVudC5kaXNhYmxlZCkpCiAgICAgICAgICAgIGVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlOwogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWydkaXNhYmxlJ10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ2VuYWJsZSddWyd1cGRhdGUnXShlbGVtZW50LCBmdW5jdGlvbigpIHsgcmV0dXJuICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSkgfSk7CiAgICB9Cn07CgpmdW5jdGlvbiBlbnN1cmVEcm9wZG93blNlbGVjdGlvbklzQ29uc2lzdGVudFdpdGhNb2RlbFZhbHVlKGVsZW1lbnQsIG1vZGVsVmFsdWUsIHByZWZlck1vZGVsVmFsdWUpIHsKICAgIGlmIChwcmVmZXJNb2RlbFZhbHVlKSB7CiAgICAgICAgaWYgKG1vZGVsVmFsdWUgIT09IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpKQogICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUoZWxlbWVudCwgbW9kZWxWYWx1ZSk7CiAgICB9CgogICAgLy8gTm8gbWF0dGVyIHdoaWNoIGRpcmVjdGlvbiB3ZSdyZSBzeW5jaW5nIGluLCB3ZSB3YW50IHRoZSBlbmQgcmVzdWx0IHRvIGJlIGVxdWFsaXR5IGJldHdlZW4gZHJvcGRvd24gdmFsdWUgYW5kIG1vZGVsIHZhbHVlLgogICAgLy8gSWYgdGhleSBhcmVuJ3QgZXF1YWwsIGVpdGhlciB3ZSBwcmVmZXIgdGhlIGRyb3Bkb3duIHZhbHVlLCBvciB0aGUgbW9kZWwgdmFsdWUgY291bGRuJ3QgYmUgcmVwcmVzZW50ZWQsIHNvIGVpdGhlciB3YXksCiAgICAvLyBjaGFuZ2UgdGhlIG1vZGVsIHZhbHVlIHRvIG1hdGNoIHRoZSBkcm9wZG93bi4KICAgIGlmIChtb2RlbFZhbHVlICE9PSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KSkKICAgICAgICBrby51dGlscy50cmlnZ2VyRXZlbnQoZWxlbWVudCwgImNoYW5nZSIpOwp9OwoKa28uYmluZGluZ0hhbmRsZXJzWyd2YWx1ZSddID0gewogICAgJ2luaXQnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIC8vIEFsd2F5cyBjYXRjaCAiY2hhbmdlIiBldmVudDsgcG9zc2libHkgb3RoZXIgZXZlbnRzIHRvbyBpZiBhc2tlZAogICAgICAgIHZhciBldmVudHNUb0NhdGNoID0gWyJjaGFuZ2UiXTsKICAgICAgICB2YXIgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9IGFsbEJpbmRpbmdzQWNjZXNzb3IoKVsidmFsdWVVcGRhdGUiXTsKICAgICAgICBpZiAocmVxdWVzdGVkRXZlbnRzVG9DYXRjaCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2ggPT0gInN0cmluZyIpIC8vIEFsbG93IGJvdGggaW5kaXZpZHVhbCBldmVudCBuYW1lcywgYW5kIGFycmF5cyBvZiBldmVudCBuYW1lcwogICAgICAgICAgICAgICAgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9IFtyZXF1ZXN0ZWRFdmVudHNUb0NhdGNoXTsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlQdXNoQWxsKGV2ZW50c1RvQ2F0Y2gsIHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2gpOwogICAgICAgICAgICBldmVudHNUb0NhdGNoID0ga28udXRpbHMuYXJyYXlHZXREaXN0aW5jdFZhbHVlcyhldmVudHNUb0NhdGNoKTsKICAgICAgICB9CgogICAgICAgIHZhciB2YWx1ZVVwZGF0ZUhhbmRsZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgIHZhciBlbGVtZW50VmFsdWUgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KTsKICAgICAgICAgICAga28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkobW9kZWxWYWx1ZSwgYWxsQmluZGluZ3NBY2Nlc3NvciwgJ3ZhbHVlJywgZWxlbWVudFZhbHVlLCAvKiBjaGVja0lmRGlmZmVyZW50OiAqLyB0cnVlKTsKICAgICAgICB9CgogICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTIyCiAgICAgICAgLy8gSUUgZG9lc24ndCBmaXJlICJjaGFuZ2UiIGV2ZW50cyBvbiB0ZXh0Ym94ZXMgaWYgdGhlIHVzZXIgc2VsZWN0cyBhIHZhbHVlIGZyb20gaXRzIGF1dG9jb21wbGV0ZSBsaXN0CiAgICAgICAgdmFyIGllQXV0b0NvbXBsZXRlSGFja05lZWRlZCA9IGtvLnV0aWxzLmllVmVyc2lvbiAmJiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAiaW5wdXQiICYmIGVsZW1lbnQudHlwZSA9PSAidGV4dCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgZWxlbWVudC5hdXRvY29tcGxldGUgIT0gIm9mZiIgJiYgKCFlbGVtZW50LmZvcm0gfHwgZWxlbWVudC5mb3JtLmF1dG9jb21wbGV0ZSAhPSAib2ZmIik7CiAgICAgICAgaWYgKGllQXV0b0NvbXBsZXRlSGFja05lZWRlZCAmJiBrby51dGlscy5hcnJheUluZGV4T2YoZXZlbnRzVG9DYXRjaCwgInByb3BlcnR5Y2hhbmdlIikgPT0gLTEpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gZmFsc2U7CiAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJwcm9wZXJ0eWNoYW5nZSIsIGZ1bmN0aW9uICgpIHsgcHJvcGVydHlDaGFuZ2VkRmlyZWQgPSB0cnVlIH0pOwogICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiYmx1ciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5Q2hhbmdlZEZpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlDaGFuZ2VkRmlyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB2YWx1ZVVwZGF0ZUhhbmRsZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goZXZlbnRzVG9DYXRjaCwgZnVuY3Rpb24oZXZlbnROYW1lKSB7CiAgICAgICAgICAgIC8vIFRoZSBzeW50YXggImFmdGVyPGV2ZW50bmFtZT4iIG1lYW5zICJydW4gdGhlIGhhbmRsZXIgYXN5bmNocm9ub3VzbHkgYWZ0ZXIgdGhlIGV2ZW50IgogICAgICAgICAgICAvLyBUaGlzIGlzIHVzZWZ1bCwgZm9yIGV4YW1wbGUsIHRvIGNhdGNoICJrZXlkb3duIiBldmVudHMgYWZ0ZXIgdGhlIGJyb3dzZXIgaGFzIHVwZGF0ZWQgdGhlIGNvbnRyb2wKICAgICAgICAgICAgLy8gKG90aGVyd2lzZSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUodGhpcykgd2lsbCByZWNlaXZlIHRoZSBjb250cm9sJ3MgdmFsdWUgKmJlZm9yZSogdGhlIGtleSBldmVudCkKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSB2YWx1ZVVwZGF0ZUhhbmRsZXI7CiAgICAgICAgICAgIGlmIChrby51dGlscy5zdHJpbmdTdGFydHNXaXRoKGV2ZW50TmFtZSwgImFmdGVyIikpIHsKICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBmdW5jdGlvbigpIHsgc2V0VGltZW91dCh2YWx1ZVVwZGF0ZUhhbmRsZXIsIDApIH07CiAgICAgICAgICAgICAgICBldmVudE5hbWUgPSBldmVudE5hbWUuc3Vic3RyaW5nKCJhZnRlciIubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudE5hbWUsIGhhbmRsZXIpOwogICAgICAgIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIHZhciB2YWx1ZUlzU2VsZWN0T3B0aW9uID0ga28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpID09PSAic2VsZWN0IjsKICAgICAgICB2YXIgbmV3VmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgdmFyIGVsZW1lbnRWYWx1ZSA9IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQpOwogICAgICAgIHZhciB2YWx1ZUhhc0NoYW5nZWQgPSAobmV3VmFsdWUgIT0gZWxlbWVudFZhbHVlKTsKCiAgICAgICAgLy8gSmF2YVNjcmlwdCdzIDAgPT0gIiIgYmVoYXZpb3VzIGlzIHVuZm9ydHVuYXRlIGhlcmUgYXMgaXQgcHJldmVudHMgd3JpdGluZyAwIHRvIGFuIGVtcHR5IHRleHQgYm94IChsb29zZSBlcXVhbGl0eSBzdWdnZXN0cyB0aGUgdmFsdWVzIGFyZSB0aGUgc2FtZSkuCiAgICAgICAgLy8gV2UgZG9uJ3Qgd2FudCB0byBkbyBhIHN0cmljdCBlcXVhbGl0eSBjb21wYXJpc29uIGFzIHRoYXQgaXMgbW9yZSBjb25mdXNpbmcgZm9yIGRldmVsb3BlcnMgaW4gY2VydGFpbiBjYXNlcywgc28gd2Ugc3BlY2lmaWNhbGx5IHNwZWNpYWwgY2FzZSAwICE9ICIiIGhlcmUuCiAgICAgICAgaWYgKChuZXdWYWx1ZSA9PT0gMCkgJiYgKGVsZW1lbnRWYWx1ZSAhPT0gMCkgJiYgKGVsZW1lbnRWYWx1ZSAhPT0gIjAiKSkKICAgICAgICAgICAgdmFsdWVIYXNDaGFuZ2VkID0gdHJ1ZTsKCiAgICAgICAgaWYgKHZhbHVlSGFzQ2hhbmdlZCkgewogICAgICAgICAgICB2YXIgYXBwbHlWYWx1ZUFjdGlvbiA9IGZ1bmN0aW9uICgpIHsga28uc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlKGVsZW1lbnQsIG5ld1ZhbHVlKTsgfTsKICAgICAgICAgICAgYXBwbHlWYWx1ZUFjdGlvbigpOwoKICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgSUU2IGJ1ZzogSXQgd29uJ3QgcmVsaWFibHkgYXBwbHkgdmFsdWVzIHRvIFNFTEVDVCBub2RlcyBkdXJpbmcgdGhlIHNhbWUgZXhlY3V0aW9uIHRocmVhZAogICAgICAgICAgICAvLyByaWdodCBhZnRlciB5b3UndmUgY2hhbmdlZCB0aGUgc2V0IG9mIE9QVElPTiBub2RlcyBvbiBpdC4gU28gZm9yIHRoYXQgbm9kZSB0eXBlLCB3ZSdsbCBzY2hlZHVsZSBhIHNlY29uZCB0aHJlYWQKICAgICAgICAgICAgLy8gdG8gYXBwbHkgdGhlIHZhbHVlIGFzIHdlbGwuCiAgICAgICAgICAgIHZhciBhbHNvQXBwbHlBc3luY2hyb25vdXNseSA9IHZhbHVlSXNTZWxlY3RPcHRpb247CiAgICAgICAgICAgIGlmIChhbHNvQXBwbHlBc3luY2hyb25vdXNseSkKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYXBwbHlWYWx1ZUFjdGlvbiwgMCk7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB5b3UgdHJ5IHRvIHNldCBhIG1vZGVsIHZhbHVlIHRoYXQgY2FuJ3QgYmUgcmVwcmVzZW50ZWQgaW4gYW4gYWxyZWFkeS1wb3B1bGF0ZWQgZHJvcGRvd24sIHJlamVjdCB0aGF0IGNoYW5nZSwKICAgICAgICAvLyBiZWNhdXNlIHlvdSdyZSBub3QgYWxsb3dlZCB0byBoYXZlIGEgbW9kZWwgdmFsdWUgdGhhdCBkaXNhZ3JlZXMgd2l0aCBhIHZpc2libGUgVUkgc2VsZWN0aW9uLgogICAgICAgIGlmICh2YWx1ZUlzU2VsZWN0T3B0aW9uICYmIChlbGVtZW50Lmxlbmd0aCA+IDApKQogICAgICAgICAgICBlbnN1cmVEcm9wZG93blNlbGVjdGlvbklzQ29uc2lzdGVudFdpdGhNb2RlbFZhbHVlKGVsZW1lbnQsIG5ld1ZhbHVlLCAvKiBwcmVmZXJNb2RlbFZhbHVlICovIGZhbHNlKTsKICAgIH0KfTsKCmtvLmJpbmRpbmdIYW5kbGVyc1snb3B0aW9ucyddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgaWYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSAhPT0gInNlbGVjdCIpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigib3B0aW9ucyBiaW5kaW5nIGFwcGxpZXMgb25seSB0byBTRUxFQ1QgZWxlbWVudHMiKTsKCiAgICAgICAgdmFyIHNlbGVjdFdhc1ByZXZpb3VzbHlFbXB0eSA9IGVsZW1lbnQubGVuZ3RoID09IDA7CiAgICAgICAgdmFyIHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMgPSBrby51dGlscy5hcnJheU1hcChrby51dGlscy5hcnJheUZpbHRlcihlbGVtZW50LmNoaWxkTm9kZXMsIGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlLnRhZ05hbWUgJiYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihub2RlKSA9PT0gIm9wdGlvbiIpICYmIG5vZGUuc2VsZWN0ZWQ7CiAgICAgICAgfSksIGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShub2RlKSB8fCBub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50OwogICAgICAgIH0pOwogICAgICAgIHZhciBwcmV2aW91c1Njcm9sbFRvcCA9IGVsZW1lbnQuc2Nyb2xsVG9wOwoKICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgdmFyIHNlbGVjdGVkVmFsdWUgPSBlbGVtZW50LnZhbHVlOwoKICAgICAgICAvLyBSZW1vdmUgYWxsIGV4aXN0aW5nIDxvcHRpb24+cy4KICAgICAgICAvLyBOZWVkIHRvIHVzZSAucmVtb3ZlKCkgcmF0aGVyIHRoYW4gLnJlbW92ZUNoaWxkKCkgZm9yIDxvcHRpb24+cyBvdGhlcndpc2UgSUUgYmVoYXZlcyBvZGRseSAoaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xMzQpCiAgICAgICAgd2hpbGUgKGVsZW1lbnQubGVuZ3RoID4gMCkgewogICAgICAgICAgICBrby5jbGVhbk5vZGUoZWxlbWVudC5vcHRpb25zWzBdKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmUoMCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgdmFyIGFsbEJpbmRpbmdzID0gYWxsQmluZGluZ3NBY2Nlc3NvcigpOwogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlLmxlbmd0aCAhPSAibnVtYmVyIikKICAgICAgICAgICAgICAgIHZhbHVlID0gW3ZhbHVlXTsKICAgICAgICAgICAgaWYgKGFsbEJpbmRpbmdzWydvcHRpb25zQ2FwdGlvbiddKSB7CiAgICAgICAgICAgICAgICB2YXIgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIik7CiAgICAgICAgICAgICAgICBrby51dGlscy5zZXRIdG1sKG9wdGlvbiwgYWxsQmluZGluZ3NbJ29wdGlvbnNDYXB0aW9uJ10pOwogICAgICAgICAgICAgICAga28uc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlKG9wdGlvbiwgdW5kZWZpbmVkKTsKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQob3B0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHZhbHVlLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpOwoKICAgICAgICAgICAgICAgIC8vIEFwcGx5IGEgdmFsdWUgdG8gdGhlIG9wdGlvbiBlbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgb3B0aW9uVmFsdWUgPSB0eXBlb2YgYWxsQmluZGluZ3NbJ29wdGlvbnNWYWx1ZSddID09ICJzdHJpbmciID8gdmFsdWVbaV1bYWxsQmluZGluZ3NbJ29wdGlvbnNWYWx1ZSddXSA6IHZhbHVlW2ldOwogICAgICAgICAgICAgICAgb3B0aW9uVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvblZhbHVlKTsKICAgICAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShvcHRpb24sIG9wdGlvblZhbHVlKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBzb21lIHRleHQgdG8gdGhlIG9wdGlvbiBlbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgb3B0aW9uc1RleHRWYWx1ZSA9IGFsbEJpbmRpbmdzWydvcHRpb25zVGV4dCddOwogICAgICAgICAgICAgICAgdmFyIG9wdGlvblRleHQ7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnNUZXh0VmFsdWUgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgICAgICBvcHRpb25UZXh0ID0gb3B0aW9uc1RleHRWYWx1ZSh2YWx1ZVtpXSk7IC8vIEdpdmVuIGEgZnVuY3Rpb247IHJ1biBpdCBhZ2FpbnN0IHRoZSBkYXRhIHZhbHVlCiAgICAgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2Ygb3B0aW9uc1RleHRWYWx1ZSA9PSAic3RyaW5nIikKICAgICAgICAgICAgICAgICAgICBvcHRpb25UZXh0ID0gdmFsdWVbaV1bb3B0aW9uc1RleHRWYWx1ZV07IC8vIEdpdmVuIGEgc3RyaW5nOyB0cmVhdCBpdCBhcyBhIHByb3BlcnR5IG5hbWUgb24gdGhlIGRhdGEgdmFsdWUKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBvcHRpb25UZXh0ID0gb3B0aW9uVmFsdWU7ICAgICAgICAgICAgICAgICAvLyBHaXZlbiBubyBvcHRpb25zVGV4dCBhcmc7IHVzZSB0aGUgZGF0YSB2YWx1ZSBpdHNlbGYKICAgICAgICAgICAgICAgIGlmICgob3B0aW9uVGV4dCA9PT0gbnVsbCkgfHwgKG9wdGlvblRleHQgPT09IHVuZGVmaW5lZCkpCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uVGV4dCA9ICIiOwoKICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldFRleHRDb250ZW50KG9wdGlvbiwgb3B0aW9uVGV4dCk7CgogICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChvcHRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJRTYgZG9lc24ndCBsaWtlIHVzIHRvIGFzc2lnbiBzZWxlY3Rpb24gdG8gT1BUSU9OIG5vZGVzIGJlZm9yZSB0aGV5J3JlIGFkZGVkIHRvIHRoZSBkb2N1bWVudC4KICAgICAgICAgICAgLy8gVGhhdCdzIHdoeSB3ZSBmaXJzdCBhZGRlZCB0aGVtIHdpdGhvdXQgc2VsZWN0aW9uLiBOb3cgaXQncyB0aW1lIHRvIHNldCB0aGUgc2VsZWN0aW9uLgogICAgICAgICAgICB2YXIgbmV3T3B0aW9ucyA9IGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpOwogICAgICAgICAgICB2YXIgY291bnRTZWxlY3Rpb25zUmV0YWluZWQgPSAwOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5ld09wdGlvbnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuYXJyYXlJbmRleE9mKHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG5ld09wdGlvbnNbaV0pKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAga28udXRpbHMuc2V0T3B0aW9uTm9kZVNlbGVjdGlvblN0YXRlKG5ld09wdGlvbnNbaV0sIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGNvdW50U2VsZWN0aW9uc1JldGFpbmVkKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGVsZW1lbnQuc2Nyb2xsVG9wID0gcHJldmlvdXNTY3JvbGxUb3A7CgogICAgICAgICAgICBpZiAoc2VsZWN0V2FzUHJldmlvdXNseUVtcHR5ICYmICgndmFsdWUnIGluIGFsbEJpbmRpbmdzKSkgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIGNvbnNpc3RlbmN5IGJldHdlZW4gbW9kZWwgdmFsdWUgYW5kIHNlbGVjdGVkIG9wdGlvbi4KICAgICAgICAgICAgICAgIC8vIElmIHRoZSBkcm9wZG93biBpcyBiZWluZyBwb3B1bGF0ZWQgZm9yIHRoZSBmaXJzdCB0aW1lIGhlcmUgKG9yIHdhcyBvdGhlcndpc2UgcHJldmlvdXNseSBlbXB0eSksCiAgICAgICAgICAgICAgICAvLyB0aGUgZHJvcGRvd24gc2VsZWN0aW9uIHN0YXRlIGlzIG1lYW5pbmdsZXNzLCBzbyB3ZSBwcmVzZXJ2ZSB0aGUgbW9kZWwgdmFsdWUuCiAgICAgICAgICAgICAgICBlbnN1cmVEcm9wZG93blNlbGVjdGlvbklzQ29uc2lzdGVudFdpdGhNb2RlbFZhbHVlKGVsZW1lbnQsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYWxsQmluZGluZ3NbJ3ZhbHVlJ10pLCAvKiBwcmVmZXJNb2RlbFZhbHVlICovIHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRTkgYnVnCiAgICAgICAgICAgIGtvLnV0aWxzLmVuc3VyZVNlbGVjdEVsZW1lbnRJc1JlbmRlcmVkQ29ycmVjdGx5KGVsZW1lbnQpOwogICAgICAgIH0KICAgIH0KfTsKa28uYmluZGluZ0hhbmRsZXJzWydvcHRpb25zJ10ub3B0aW9uVmFsdWVEb21EYXRhS2V5ID0gJ19fa28ub3B0aW9uVmFsdWVEb21EYXRhX18nOwoKa28uYmluZGluZ0hhbmRsZXJzWydzZWxlY3RlZE9wdGlvbnMnXSA9IHsKICAgIGdldFNlbGVjdGVkVmFsdWVzRnJvbVNlbGVjdE5vZGU6IGZ1bmN0aW9uIChzZWxlY3ROb2RlKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBub2RlcyA9IHNlbGVjdE5vZGUuY2hpbGROb2RlczsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICB2YXIgbm9kZSA9IG5vZGVzW2ldLCB0YWdOYW1lID0ga28udXRpbHMudGFnTmFtZUxvd2VyKG5vZGUpOwogICAgICAgICAgICBpZiAodGFnTmFtZSA9PSAib3B0aW9uIiAmJiBub2RlLnNlbGVjdGVkKQogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goa28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkpOwogICAgICAgICAgICBlbHNlIGlmICh0YWdOYW1lID09ICJvcHRncm91cCIpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlc0Zyb21PcHRHcm91cCA9IGtvLmJpbmRpbmdIYW5kbGVyc1snc2VsZWN0ZWRPcHRpb25zJ10uZ2V0U2VsZWN0ZWRWYWx1ZXNGcm9tU2VsZWN0Tm9kZShub2RlKTsKICAgICAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYXBwbHkocmVzdWx0LCBbcmVzdWx0Lmxlbmd0aCwgMF0uY29uY2F0KHNlbGVjdGVkVmFsdWVzRnJvbU9wdEdyb3VwKSk7IC8vIEFkZCBuZXcgZW50cmllcyB0byBleGlzdGluZyAncmVzdWx0JyBpbnN0YW5jZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAogICAgJ2luaXQnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3NvcikgewogICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJjaGFuZ2UiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGtvLmJpbmRpbmdIYW5kbGVyc1snc2VsZWN0ZWRPcHRpb25zJ10uZ2V0U2VsZWN0ZWRWYWx1ZXNGcm9tU2VsZWN0Tm9kZSh0aGlzKTsKICAgICAgICAgICAga28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkodmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICd2YWx1ZScsIHZhbHVlVG9Xcml0ZSk7CiAgICAgICAgfSk7CiAgICB9LAogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgaWYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSAhPSAic2VsZWN0IikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ2YWx1ZXMgYmluZGluZyBhcHBsaWVzIG9ubHkgdG8gU0VMRUNUIGVsZW1lbnRzIik7CgogICAgICAgIHZhciBuZXdWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKICAgICAgICBpZiAobmV3VmFsdWUgJiYgdHlwZW9mIG5ld1ZhbHVlLmxlbmd0aCA9PSAibnVtYmVyIikgewogICAgICAgICAgICB2YXIgbm9kZXMgPSBlbGVtZW50LmNoaWxkTm9kZXM7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IG5vZGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihub2RlKSA9PT0gIm9wdGlvbiIpCiAgICAgICAgICAgICAgICAgICAga28udXRpbHMuc2V0T3B0aW9uTm9kZVNlbGVjdGlvblN0YXRlKG5vZGUsIGtvLnV0aWxzLmFycmF5SW5kZXhPZihuZXdWYWx1ZSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkpID49IDApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0J10gPSB7CiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBrby51dGlscy5zZXRUZXh0Q29udGVudChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKCkpOwogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWydodG1sJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFByZXZlbnQgYmluZGluZyBvbiB0aGUgZHluYW1pY2FsbHktaW5qZWN0ZWQgSFRNTCAoYXMgZGV2ZWxvcGVycyBhcmUgdW5saWtlbHkgdG8gZXhwZWN0IHRoYXQsIGFuZCBpdCBoYXMgc2VjdXJpdHkgaW1wbGljYXRpb25zKQogICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAga28udXRpbHMuc2V0SHRtbChlbGVtZW50LCB2YWx1ZSk7CiAgICB9Cn07Cgprby5iaW5kaW5nSGFuZGxlcnNbJ2NzcyddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkgfHwge30pOwogICAgICAgIGZvciAodmFyIGNsYXNzTmFtZSBpbiB2YWx1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGNsYXNzTmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIHNob3VsZEhhdmVDbGFzcyA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVbY2xhc3NOYW1lXSk7CiAgICAgICAgICAgICAgICBrby51dGlscy50b2dnbGVEb21Ob2RlQ3NzQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lLCBzaG91bGRIYXZlQ2xhc3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWydzdHlsZSddID0gewogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkgfHwge30pOwogICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiB2YWx1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlTmFtZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIHN0eWxlVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW3N0eWxlTmFtZV0pOwogICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZVtzdHlsZU5hbWVdID0gc3R5bGVWYWx1ZSB8fCAiIjsgLy8gRW1wdHkgc3RyaW5nIHJlbW92ZXMgdGhlIHZhbHVlLCB3aGVyZWFzIG51bGwvdW5kZWZpbmVkIGhhdmUgbm8gZWZmZWN0CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn07Cgprby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXSA9IHsKICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICBpZiAodmFsdWVBY2Nlc3NvcigpKSB7CiAgICAgICAgICAgIGVsZW1lbnQubmFtZSA9ICJrb191bmlxdWVfIiArICgrK2tvLmJpbmRpbmdIYW5kbGVyc1sndW5pcXVlTmFtZSddLmN1cnJlbnRJbmRleCk7CgogICAgICAgICAgICAvLyBXb3JrYXJvdW5kIElFIDYvNyBpc3N1ZQogICAgICAgICAgICAvLyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTk3CiAgICAgICAgICAgIC8vIC0gaHR0cDovL3d3dy5tYXR0czQxMS5jb20vcG9zdC9zZXR0aW5nX3RoZV9uYW1lX2F0dHJpYnV0ZV9pbl9pZV9kb20vCiAgICAgICAgICAgIGlmIChrby51dGlscy5pc0llNiB8fCBrby51dGlscy5pc0llNykKICAgICAgICAgICAgICAgIGVsZW1lbnQubWVyZ2VBdHRyaWJ1dGVzKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIjxpbnB1dCBuYW1lPSciICsgZWxlbWVudC5uYW1lICsgIicvPiIpLCBmYWxzZSk7CiAgICAgICAgfQogICAgfQp9Owprby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXS5jdXJyZW50SW5kZXggPSAwOwoKa28uYmluZGluZ0hhbmRsZXJzWydjaGVja2VkJ10gPSB7CiAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHVwZGF0ZUhhbmRsZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSB7CiAgICAgICAgICAgICAgICB2YWx1ZVRvV3JpdGUgPSBlbGVtZW50LmNoZWNrZWQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVsZW1lbnQudHlwZSA9PSAicmFkaW8iKSAmJiAoZWxlbWVudC5jaGVja2VkKSkgewogICAgICAgICAgICAgICAgdmFsdWVUb1dyaXRlID0gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybjsgLy8gImNoZWNrZWQiIGJpbmRpbmcgb25seSByZXNwb25kcyB0byBjaGVja2JveGVzIGFuZCBzZWxlY3RlZCByYWRpbyBidXR0b25zCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0gdmFsdWVBY2Nlc3NvcigpOwogICAgICAgICAgICBpZiAoKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSAmJiAoa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtb2RlbFZhbHVlKSBpbnN0YW5jZW9mIEFycmF5KSkgewogICAgICAgICAgICAgICAgLy8gRm9yIGNoZWNrYm94ZXMgYm91bmQgdG8gYW4gYXJyYXksIHdlIGFkZC9yZW1vdmUgdGhlIGNoZWNrYm94IHZhbHVlIHRvIHRoYXQgYXJyYXkKICAgICAgICAgICAgICAgIC8vIFRoaXMgd29ya3MgZm9yIGJvdGggb2JzZXJ2YWJsZSBhbmQgbm9uLW9ic2VydmFibGUgYXJyYXlzCiAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmdFbnRyeUluZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUobW9kZWxWYWx1ZSksIGVsZW1lbnQudmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuY2hlY2tlZCAmJiAoZXhpc3RpbmdFbnRyeUluZGV4IDwgMCkpCiAgICAgICAgICAgICAgICAgICAgbW9kZWxWYWx1ZS5wdXNoKGVsZW1lbnQudmFsdWUpOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoKCFlbGVtZW50LmNoZWNrZWQpICYmIChleGlzdGluZ0VudHJ5SW5kZXggPj0gMCkpCiAgICAgICAgICAgICAgICAgICAgbW9kZWxWYWx1ZS5zcGxpY2UoZXhpc3RpbmdFbnRyeUluZGV4LCAxKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICdjaGVja2VkJywgdmFsdWVUb1dyaXRlLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNsaWNrIiwgdXBkYXRlSGFuZGxlcik7CgogICAgICAgIC8vIElFIDYgd29uJ3QgYWxsb3cgcmFkaW8gYnV0dG9ucyB0byBiZSBzZWxlY3RlZCB1bmxlc3MgdGhleSBoYXZlIGEgbmFtZQogICAgICAgIGlmICgoZWxlbWVudC50eXBlID09ICJyYWRpbyIpICYmICFlbGVtZW50Lm5hbWUpCiAgICAgICAgICAgIGtvLmJpbmRpbmdIYW5kbGVyc1sndW5pcXVlTmFtZSddWydpbml0J10oZWxlbWVudCwgZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlIH0pOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewogICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCiAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PSAiY2hlY2tib3giKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAvLyBXaGVuIGJvdW5kIHRvIGFuIGFycmF5LCB0aGUgY2hlY2tib3ggYmVpbmcgY2hlY2tlZCByZXByZXNlbnRzIGl0cyB2YWx1ZSBiZWluZyBwcmVzZW50IGluIHRoYXQgYXJyYXkKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZih2YWx1ZSwgZWxlbWVudC52YWx1ZSkgPj0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFdoZW4gYm91bmQgdG8gYW55dGhpbmcgb3RoZXIgdmFsdWUgKG5vdCBhbiBhcnJheSksIHRoZSBjaGVja2JveCBiZWluZyBjaGVja2VkIHJlcHJlc2VudHMgdGhlIHZhbHVlIGJlaW5nIHRydWVpc2gKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LnR5cGUgPT0gInJhZGlvIikgewogICAgICAgICAgICBlbGVtZW50LmNoZWNrZWQgPSAoZWxlbWVudC52YWx1ZSA9PSB2YWx1ZSk7CiAgICAgICAgfQogICAgfQp9OwoKdmFyIGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwID0geyAnY2xhc3MnOiAnY2xhc3NOYW1lJywgJ2Zvcic6ICdodG1sRm9yJyB9Owprby5iaW5kaW5nSGFuZGxlcnNbJ2F0dHInXSA9IHsKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIHx8IHt9OwogICAgICAgIGZvciAodmFyIGF0dHJOYW1lIGluIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXR0ck5hbWUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlW2F0dHJOYW1lXSk7CgogICAgICAgICAgICAgICAgLy8gVG8gY292ZXIgY2FzZXMgbGlrZSAiYXR0cjogeyBjaGVja2VkOnNvbWVQcm9wIH0iLCB3ZSB3YW50IHRvIHJlbW92ZSB0aGUgYXR0cmlidXRlIGVudGlyZWx5CiAgICAgICAgICAgICAgICAvLyB3aGVuIHNvbWVQcm9wIGlzIGEgIm5vIHZhbHVlIi1saWtlIHZhbHVlIChzdHJpY3RseSBudWxsLCBmYWxzZSwgb3IgdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgLy8gKGJlY2F1c2UgdGhlIGFic2VuY2Ugb2YgdGhlICJjaGVja2VkIiBhdHRyIGlzIGhvdyB0byBtYXJrIGFuIGVsZW1lbnQgYXMgbm90IGNoZWNrZWQsIGV0Yy4pCiAgICAgICAgICAgICAgICB2YXIgdG9SZW1vdmUgPSAoYXR0clZhbHVlID09PSBmYWxzZSkgfHwgKGF0dHJWYWx1ZSA9PT0gbnVsbCkgfHwgKGF0dHJWYWx1ZSA9PT0gdW5kZWZpbmVkKTsKICAgICAgICAgICAgICAgIGlmICh0b1JlbW92ZSkKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7CgogICAgICAgICAgICAgICAgLy8gSW4gSUUgPD0gNyBhbmQgSUU4IFF1aXJrcyBNb2RlLCB5b3UgaGF2ZSB0byB1c2UgdGhlIEphdmFzY3JpcHQgcHJvcGVydHkgbmFtZSBpbnN0ZWFkIG9mIHRoZQogICAgICAgICAgICAgICAgLy8gSFRNTCBhdHRyaWJ1dGUgbmFtZSBmb3IgY2VydGFpbiBhdHRyaWJ1dGVzLiBJRTggU3RhbmRhcmRzIE1vZGUgc3VwcG9ydHMgdGhlIGNvcnJlY3QgYmVoYXZpb3IsCiAgICAgICAgICAgICAgICAvLyBidXQgaW5zdGVhZCBvZiBmaWd1cmluZyBvdXQgdGhlIG1vZGUsIHdlJ2xsIGp1c3Qgc2V0IHRoZSBhdHRyaWJ1dGUgdGhyb3VnaCB0aGUgSmF2YXNjcmlwdAogICAgICAgICAgICAgICAgLy8gcHJvcGVydHkgZm9yIElFIDw9IDguCiAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uIDw9IDggJiYgYXR0ck5hbWUgaW4gYXR0ckh0bWxUb0phdmFzY3JpcHRNYXApIHsKICAgICAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IGF0dHJIdG1sVG9KYXZhc2NyaXB0TWFwW2F0dHJOYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9SZW1vdmUpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbYXR0ck5hbWVdID0gYXR0clZhbHVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdG9SZW1vdmUpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgYXR0clZhbHVlLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKa28uYmluZGluZ0hhbmRsZXJzWydoYXNmb2N1cyddID0gewogICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yKSB7CiAgICAgICAgdmFyIHdyaXRlVmFsdWUgPSBmdW5jdGlvbih2YWx1ZVRvV3JpdGUpIHsKICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgICAgIGtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzQWNjZXNzb3IsICdoYXNmb2N1cycsIHZhbHVlVG9Xcml0ZSwgdHJ1ZSk7CiAgICAgICAgfTsKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXMiLCBmdW5jdGlvbigpIHsgd3JpdGVWYWx1ZSh0cnVlKSB9KTsKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXNpbiIsIGZ1bmN0aW9uKCkgeyB3cml0ZVZhbHVlKHRydWUpIH0pOyAvLyBGb3IgSUUKICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiYmx1ciIsICBmdW5jdGlvbigpIHsgd3JpdGVWYWx1ZShmYWxzZSkgfSk7CiAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3Vzb3V0IiwgIGZ1bmN0aW9uKCkgeyB3cml0ZVZhbHVlKGZhbHNlKSB9KTsgLy8gRm9yIElFCiAgICB9LAogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CiAgICAgICAgdmFsdWUgPyBlbGVtZW50LmZvY3VzKCkgOiBlbGVtZW50LmJsdXIoKTsKICAgICAgICBrby51dGlscy50cmlnZ2VyRXZlbnQoZWxlbWVudCwgdmFsdWUgPyAiZm9jdXNpbiIgOiAiZm9jdXNvdXQiKTsgLy8gRm9yIElFLCB3aGljaCBkb2Vzbid0IHJlbGlhYmx5IGZpcmUgImZvY3VzIiBvciAiYmx1ciIgZXZlbnRzIHN5bmNocm9ub3VzbHkKICAgIH0KfTsKCi8vICJ3aXRoOiBzb21lRXhwcmVzc2lvbiIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgaWY6IHNvbWVFeHByZXNzaW9uLCBkYXRhOiBzb21lRXhwcmVzc2lvbiB9Igprby5iaW5kaW5nSGFuZGxlcnNbJ3dpdGgnXSA9IHsKICAgIG1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3I6IGZ1bmN0aW9uKHZhbHVlQWNjZXNzb3IpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7IHZhciB2YWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsgcmV0dXJuIHsgJ2lmJzogdmFsdWUsICdkYXRhJzogdmFsdWUsICd0ZW1wbGF0ZUVuZ2luZSc6IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlIH0gfTsKICAgIH0sCiAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWydpbml0J10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWyd3aXRoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSk7CiAgICB9LAogICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWyd1cGRhdGUnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ3dpdGgnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KTsKICAgIH0KfTsKa28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWyd3aXRoJ10gPSBmYWxzZTsgLy8gQ2FuJ3QgcmV3cml0ZSBjb250cm9sIGZsb3cgYmluZGluZ3MKa28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5nc1snd2l0aCddID0gdHJ1ZTsKCi8vICJpZjogc29tZUV4cHJlc3Npb24iIGlzIGVxdWl2YWxlbnQgdG8gInRlbXBsYXRlOiB7IGlmOiBzb21lRXhwcmVzc2lvbiB9Igprby5iaW5kaW5nSGFuZGxlcnNbJ2lmJ10gPSB7CiAgICBtYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yOiBmdW5jdGlvbih2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgeyByZXR1cm4geyAnaWYnOiB2YWx1ZUFjY2Vzc29yKCksICd0ZW1wbGF0ZUVuZ2luZSc6IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlIH0gfTsKICAgIH0sCiAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWydpbml0J10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydpZiddLm1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3IodmFsdWVBY2Nlc3NvcikpOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXVsndXBkYXRlJ10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydpZiddLm1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3IodmFsdWVBY2Nlc3NvciksIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpOwogICAgfQp9Owprby5qc29uRXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbJ2lmJ10gPSBmYWxzZTsgLy8gQ2FuJ3QgcmV3cml0ZSBjb250cm9sIGZsb3cgYmluZGluZ3MKa28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5nc1snaWYnXSA9IHRydWU7CgovLyAiaWZub3Q6IHNvbWVFeHByZXNzaW9uIiBpcyBlcXVpdmFsZW50IHRvICJ0ZW1wbGF0ZTogeyBpZm5vdDogc29tZUV4cHJlc3Npb24gfSIKa28uYmluZGluZ0hhbmRsZXJzWydpZm5vdCddID0gewogICAgbWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3NvcjogZnVuY3Rpb24odmFsdWVBY2Nlc3NvcikgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsgcmV0dXJuIHsgJ2lmbm90JzogdmFsdWVBY2Nlc3NvcigpLCAndGVtcGxhdGVFbmdpbmUnOiBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSB9IH07CiAgICB9LAogICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXVsnaW5pdCddKGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVyc1snaWZub3QnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpKTsKICAgIH0sCiAgICAndXBkYXRlJzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbJ3RlbXBsYXRlJ11bJ3VwZGF0ZSddKGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVyc1snaWZub3QnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KTsKICAgIH0KfTsKa28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWydpZm5vdCddID0gZmFsc2U7IC8vIENhbid0IHJld3JpdGUgY29udHJvbCBmbG93IGJpbmRpbmdzCmtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ2lmbm90J10gPSB0cnVlOwoKLy8gImZvcmVhY2g6IHNvbWVFeHByZXNzaW9uIiBpcyBlcXVpdmFsZW50IHRvICJ0ZW1wbGF0ZTogeyBmb3JlYWNoOiBzb21lRXhwcmVzc2lvbiB9IgovLyAiZm9yZWFjaDogeyBkYXRhOiBzb21lRXhwcmVzc2lvbiwgYWZ0ZXJBZGQ6IG15Zm4gfSIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgZm9yZWFjaDogc29tZUV4cHJlc3Npb24sIGFmdGVyQWRkOiBteWZuIH0iCmtvLmJpbmRpbmdIYW5kbGVyc1snZm9yZWFjaCddID0gewogICAgbWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3NvcjogZnVuY3Rpb24odmFsdWVBY2Nlc3NvcikgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGJpbmRpbmdWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCiAgICAgICAgICAgIC8vIElmIGJpbmRpbmdWYWx1ZSBpcyB0aGUgYXJyYXksIGp1c3QgcGFzcyBpdCBvbiBpdHMgb3duCiAgICAgICAgICAgIGlmICgoIWJpbmRpbmdWYWx1ZSkgfHwgdHlwZW9mIGJpbmRpbmdWYWx1ZS5sZW5ndGggPT0gIm51bWJlciIpCiAgICAgICAgICAgICAgICByZXR1cm4geyAnZm9yZWFjaCc6IGJpbmRpbmdWYWx1ZSwgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UgfTsKCiAgICAgICAgICAgIC8vIElmIGJpbmRpbmdWYWx1ZS5kYXRhIGlzIHRoZSBhcnJheSwgcHJlc2VydmUgYWxsIHJlbGV2YW50IG9wdGlvbnMKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICdmb3JlYWNoJzogYmluZGluZ1ZhbHVlWydkYXRhJ10sCiAgICAgICAgICAgICAgICAnaW5jbHVkZURlc3Ryb3llZCc6IGJpbmRpbmdWYWx1ZVsnaW5jbHVkZURlc3Ryb3llZCddLAogICAgICAgICAgICAgICAgJ2FmdGVyQWRkJzogYmluZGluZ1ZhbHVlWydhZnRlckFkZCddLAogICAgICAgICAgICAgICAgJ2JlZm9yZVJlbW92ZSc6IGJpbmRpbmdWYWx1ZVsnYmVmb3JlUmVtb3ZlJ10sCiAgICAgICAgICAgICAgICAnYWZ0ZXJSZW5kZXInOiBiaW5kaW5nVmFsdWVbJ2FmdGVyUmVuZGVyJ10sCiAgICAgICAgICAgICAgICAndGVtcGxhdGVFbmdpbmUnOiBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9LAogICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXVsnaW5pdCddKGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVyc1snZm9yZWFjaCddLm1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3IodmFsdWVBY2Nlc3NvcikpOwogICAgfSwKICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1sndGVtcGxhdGUnXVsndXBkYXRlJ10oZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzWydmb3JlYWNoJ10ubWFrZVRlbXBsYXRlVmFsdWVBY2Nlc3Nvcih2YWx1ZUFjY2Vzc29yKSwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCk7CiAgICB9Cn07CmtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yc1snZm9yZWFjaCddID0gZmFsc2U7IC8vIENhbid0IHJld3JpdGUgY29udHJvbCBmbG93IGJpbmRpbmdzCmtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ2ZvcmVhY2gnXSA9IHRydWU7Ci8vIElmIHlvdSB3YW50IHRvIG1ha2UgYSBjdXN0b20gdGVtcGxhdGUgZW5naW5lLAovLwovLyBbMV0gSW5oZXJpdCBmcm9tIHRoaXMgY2xhc3MgKGxpa2Uga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUgZG9lcykKLy8gWzJdIE92ZXJyaWRlICdyZW5kZXJUZW1wbGF0ZVNvdXJjZScsIHN1cHBseWluZyBhIGZ1bmN0aW9uIHdpdGggdGhpcyBzaWduYXR1cmU6Ci8vCi8vICAgICAgICBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7Ci8vICAgICAgICAgICAgLy8gLSB0ZW1wbGF0ZVNvdXJjZS50ZXh0KCkgaXMgdGhlIHRleHQgb2YgdGhlIHRlbXBsYXRlIHlvdSBzaG91bGQgcmVuZGVyCi8vICAgICAgICAgICAgLy8gLSBiaW5kaW5nQ29udGV4dC4kZGF0YSBpcyB0aGUgZGF0YSB5b3Ugc2hvdWxkIHBhc3MgaW50byB0aGUgdGVtcGxhdGUKLy8gICAgICAgICAgICAvLyAgIC0geW91IG1pZ2h0IGFsc28gd2FudCB0byBtYWtlIGJpbmRpbmdDb250ZXh0LiRwYXJlbnQsIGJpbmRpbmdDb250ZXh0LiRwYXJlbnRzLAovLyAgICAgICAgICAgIC8vICAgICBhbmQgYmluZGluZ0NvbnRleHQuJHJvb3QgYXZhaWxhYmxlIGluIHRoZSB0ZW1wbGF0ZSB0b28KLy8gICAgICAgICAgICAvLyAtIG9wdGlvbnMgZ2l2ZXMgeW91IGFjY2VzcyB0byBhbnkgb3RoZXIgcHJvcGVydGllcyBzZXQgb24gImRhdGEtYmluZDogeyB0ZW1wbGF0ZTogb3B0aW9ucyB9IgovLyAgICAgICAgICAgIC8vCi8vICAgICAgICAgICAgLy8gUmV0dXJuIHZhbHVlOiBhbiBhcnJheSBvZiBET00gbm9kZXMKLy8gICAgICAgIH0KLy8KLy8gWzNdIE92ZXJyaWRlICdjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snLCBzdXBwbHlpbmcgYSBmdW5jdGlvbiB3aXRoIHRoaXMgc2lnbmF0dXJlOgovLwovLyAgICAgICAgZnVuY3Rpb24gKHNjcmlwdCkgewovLyAgICAgICAgICAgIC8vIFJldHVybiB2YWx1ZTogV2hhdGV2ZXIgc3ludGF4IG1lYW5zICJFdmFsdWF0ZSB0aGUgSmF2YVNjcmlwdCBzdGF0ZW1lbnQgJ3NjcmlwdCcgYW5kIG91dHB1dCB0aGUgcmVzdWx0IgovLyAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgRm9yIGV4YW1wbGUsIHRoZSBqcXVlcnkudG1wbCB0ZW1wbGF0ZSBlbmdpbmUgY29udmVydHMgJ3NvbWVTY3JpcHQnIHRvICckeyBzb21lU2NyaXB0IH0nCi8vICAgICAgICB9Ci8vCi8vICAgICBUaGlzIGlzIG9ubHkgbmVjZXNzYXJ5IGlmIHlvdSB3YW50IHRvIGFsbG93IGRhdGEtYmluZCBhdHRyaWJ1dGVzIHRvIHJlZmVyZW5jZSBhcmJpdHJhcnkgdGVtcGxhdGUgdmFyaWFibGVzLgovLyAgICAgSWYgeW91IGRvbid0IHdhbnQgdG8gYWxsb3cgdGhhdCwgeW91IGNhbiBzZXQgdGhlIHByb3BlcnR5ICdhbGxvd1RlbXBsYXRlUmV3cml0aW5nJyB0byBmYWxzZSAobGlrZSBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSBkb2VzKQovLyAgICAgYW5kIHRoZW4geW91IGRvbid0IG5lZWQgdG8gb3ZlcnJpZGUgJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jaycuCgprby50ZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICgpIHsgfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpIHsKICAgIHRocm93IG5ldyBFcnJvcigiT3ZlcnJpZGUgcmVuZGVyVGVtcGxhdGVTb3VyY2UiKTsKfTsKCmtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10gPSBmdW5jdGlvbiAoc2NyaXB0KSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIk92ZXJyaWRlIGNyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jayIpOwp9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydtYWtlVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICAvLyBOYW1lZCB0ZW1wbGF0ZQogICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PSAic3RyaW5nIikgewogICAgICAgIHRlbXBsYXRlRG9jdW1lbnQgPSB0ZW1wbGF0ZURvY3VtZW50IHx8IGRvY3VtZW50OwogICAgICAgIHZhciBlbGVtID0gdGVtcGxhdGVEb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0ZW1wbGF0ZSk7CiAgICAgICAgaWYgKCFlbGVtKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIHRlbXBsYXRlIHdpdGggSUQgIiArIHRlbXBsYXRlKTsKICAgICAgICByZXR1cm4gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50KGVsZW0pOwogICAgfSBlbHNlIGlmICgodGVtcGxhdGUubm9kZVR5cGUgPT0gMSkgfHwgKHRlbXBsYXRlLm5vZGVUeXBlID09IDgpKSB7CiAgICAgICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlCiAgICAgICAgcmV0dXJuIG5ldyBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUodGVtcGxhdGUpOwogICAgfSBlbHNlCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHRlbXBsYXRlIHR5cGU6ICIgKyB0ZW1wbGF0ZSk7Cn07Cgprby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0ZW1wbGF0ZURvY3VtZW50KSB7CiAgICB2YXIgdGVtcGxhdGVTb3VyY2UgPSB0aGlzWydtYWtlVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCk7CiAgICByZXR1cm4gdGhpc1sncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpOwp9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydpc1RlbXBsYXRlUmV3cml0dGVuJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgIC8vIFNraXAgcmV3cml0aW5nIGlmIHJlcXVlc3RlZAogICAgaWYgKHRoaXNbJ2FsbG93VGVtcGxhdGVSZXdyaXRpbmcnXSA9PT0gZmFsc2UpCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgLy8gUGVyZiBvcHRpbWlzYXRpb24gLSBzZWUgYmVsb3cKICAgIHZhciB0ZW1wbGF0ZUlzSW5FeHRlcm5hbERvY3VtZW50ID0gdGVtcGxhdGVEb2N1bWVudCAmJiB0ZW1wbGF0ZURvY3VtZW50ICE9IGRvY3VtZW50OwogICAgaWYgKCF0ZW1wbGF0ZUlzSW5FeHRlcm5hbERvY3VtZW50ICYmIHRoaXMua25vd25SZXdyaXR0ZW5UZW1wbGF0ZXMgJiYgdGhpcy5rbm93blJld3JpdHRlblRlbXBsYXRlc1t0ZW1wbGF0ZV0pCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgcmV0dXJuIHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KVsnZGF0YSddKCJpc1Jld3JpdHRlbiIpOwp9OwoKa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydyZXdyaXRlVGVtcGxhdGUnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgcmV3cml0ZXJDYWxsYmFjaywgdGVtcGxhdGVEb2N1bWVudCkgewogICAgdmFyIHRlbXBsYXRlU291cmNlID0gdGhpc1snbWFrZVRlbXBsYXRlU291cmNlJ10odGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpOwogICAgdmFyIHJld3JpdHRlbiA9IHJld3JpdGVyQ2FsbGJhY2sodGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpKTsKICAgIHRlbXBsYXRlU291cmNlWyd0ZXh0J10ocmV3cml0dGVuKTsKICAgIHRlbXBsYXRlU291cmNlWydkYXRhJ10oImlzUmV3cml0dGVuIiwgdHJ1ZSk7CgogICAgLy8gUGVyZiBvcHRpbWlzYXRpb24gLSBmb3IgbmFtZWQgdGVtcGxhdGVzLCB0cmFjayB3aGljaCBvbmVzIGhhdmUgYmVlbiByZXdyaXR0ZW4gc28gd2UgY2FuCiAgICAvLyBhbnN3ZXIgJ2lzVGVtcGxhdGVSZXdyaXR0ZW4nICp3aXRob3V0KiBoYXZpbmcgdG8gdXNlIGdldEVsZW1lbnRCeUlkICh3aGljaCBpcyBzbG93IG9uIElFIDwgOCkKICAgIC8vCiAgICAvLyBOb3RlIHRoYXQgd2Ugb25seSBjYWNoZSB0aGUgc3RhdHVzIGZvciB0ZW1wbGF0ZXMgaW4gdGhlIG1haW4gZG9jdW1lbnQsIGJlY2F1c2UgY2FjaGluZyBvbiBhIHBlci1kb2MKICAgIC8vIGJhc2lzIGNvbXBsaWNhdGVzIHRoZSBpbXBsZW1lbnRhdGlvbiBleGNlc3NpdmVseS4gSW4gYSBmdXR1cmUgdmVyc2lvbiBvZiBLTywgd2Ugd2lsbCBsaWtlbHkgcmVtb3ZlCiAgICAvLyB0aGlzICdpc1Jld3JpdHRlbicgY2FjaGUgZW50aXJlbHkgYW55d2F5LCBiZWNhdXNlIHRoZSBiZW5lZml0IGlzIGV4dHJlbWVseSBtaW5vciBhbmQgb25seSBhcHBsaWVzCiAgICAvLyB0byByZXdyaXRhYmxlIHRlbXBsYXRlcywgd2hpY2ggYXJlIHByZXR0eSBtdWNoIGRlcHJlY2F0ZWQgc2luY2UgS08gMi4wLgogICAgdmFyIHRlbXBsYXRlSXNJbkV4dGVybmFsRG9jdW1lbnQgPSB0ZW1wbGF0ZURvY3VtZW50ICYmIHRlbXBsYXRlRG9jdW1lbnQgIT0gZG9jdW1lbnQ7CiAgICBpZiAoIXRlbXBsYXRlSXNJbkV4dGVybmFsRG9jdW1lbnQgJiYgdHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CiAgICAgICAgdGhpcy5rbm93blJld3JpdHRlblRlbXBsYXRlcyA9IHRoaXMua25vd25SZXdyaXR0ZW5UZW1wbGF0ZXMgfHwge307CiAgICAgICAgdGhpcy5rbm93blJld3JpdHRlblRlbXBsYXRlc1t0ZW1wbGF0ZV0gPSB0cnVlOwogICAgfQp9OwoKa28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZUVuZ2luZScsIGtvLnRlbXBsYXRlRW5naW5lKTsKCmtvLnRlbXBsYXRlUmV3cml0aW5nID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCA9IC8oPFthLXpdK1xkKihccysoPyFkYXRhLWJpbmQ9KVthLXowLTlcLV0rKD0oXCJbXlwiXSpcInxcJ1teXCddKlwnKSk/KSpccyspZGF0YS1iaW5kPShbIiddKShbXHNcU10qPylcNS9naTsKICAgIHZhciBtZW1vaXplVmlydHVhbENvbnRhaW5lckJpbmRpbmdTeW50YXhSZWdleCA9IC88IS0tXHMqa29cYlxzKihbXHNcU10qPylccyotLT4vZzsKCiAgICBmdW5jdGlvbiB2YWxpZGF0ZURhdGFCaW5kVmFsdWVzRm9yUmV3cml0aW5nKGtleVZhbHVlQXJyYXkpIHsKICAgICAgICB2YXIgYWxsVmFsaWRhdG9ycyA9IGtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yczsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleVZhbHVlQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGtleSA9IGtleVZhbHVlQXJyYXlbaV1bJ2tleSddOwogICAgICAgICAgICBpZiAoYWxsVmFsaWRhdG9ycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsaWRhdG9yID0gYWxsVmFsaWRhdG9yc1trZXldOwoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsaWRhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBvc3NpYmxlRXJyb3JNZXNzYWdlID0gdmFsaWRhdG9yKGtleVZhbHVlQXJyYXlbaV1bJ3ZhbHVlJ10pOwogICAgICAgICAgICAgICAgICAgIGlmIChwb3NzaWJsZUVycm9yTWVzc2FnZSkKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHBvc3NpYmxlRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXZhbGlkYXRvcikgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB0ZW1wbGF0ZSBlbmdpbmUgZG9lcyBub3Qgc3VwcG9ydCB0aGUgJyIgKyBrZXkgKyAiJyBiaW5kaW5nIHdpdGhpbiBpdHMgdGVtcGxhdGVzIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY29uc3RydWN0TWVtb2l6ZWRUYWdSZXBsYWNlbWVudChkYXRhQmluZEF0dHJpYnV0ZVZhbHVlLCB0YWdUb1JldGFpbiwgdGVtcGxhdGVFbmdpbmUpIHsKICAgICAgICB2YXIgZGF0YUJpbmRLZXlWYWx1ZUFycmF5ID0ga28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKGRhdGFCaW5kQXR0cmlidXRlVmFsdWUpOwogICAgICAgIHZhbGlkYXRlRGF0YUJpbmRWYWx1ZXNGb3JSZXdyaXRpbmcoZGF0YUJpbmRLZXlWYWx1ZUFycmF5KTsKICAgICAgICB2YXIgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSA9IGtvLmpzb25FeHByZXNzaW9uUmV3cml0aW5nLmluc2VydFByb3BlcnR5QWNjZXNzb3JzSW50b0pzb24oZGF0YUJpbmRLZXlWYWx1ZUFycmF5KTsKCiAgICAgICAgLy8gRm9yIG5vIG9idmlvdXMgcmVhc29uLCBPcGVyYSBmYWlscyB0byBldmFsdWF0ZSByZXdyaXR0ZW5EYXRhQmluZEF0dHJpYnV0ZVZhbHVlIHVubGVzcyBpdCdzIHdyYXBwZWQgaW4gYW4gYWRkaXRpb25hbAogICAgICAgIC8vIGFub255bW91cyBmdW5jdGlvbiwgZXZlbiB0aG91Z2ggT3BlcmEncyBidWlsdC1pbiBkZWJ1Z2dlciBjYW4gZXZhbHVhdGUgaXQgYW55d2F5LiBObyBvdGhlciBicm93c2VyIHJlcXVpcmVzIHRoaXMKICAgICAgICAvLyBleHRyYSBpbmRpcmVjdGlvbi4KICAgICAgICB2YXIgYXBwbHlCaW5kaW5nc1RvTmV4dFNpYmxpbmdTY3JpcHQgPSAia28udGVtcGxhdGVSZXdyaXRpbmcuYXBwbHlNZW1vaXplZEJpbmRpbmdzVG9OZXh0U2libGluZyhmdW5jdGlvbigpIHsgXAogICAgICAgICAgICByZXR1cm4gKGZ1bmN0aW9uKCkgeyByZXR1cm4geyAiICsgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSArICIgfSB9KSgpIFwKICAgICAgICB9KSI7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlRW5naW5lWydjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snXShhcHBseUJpbmRpbmdzVG9OZXh0U2libGluZ1NjcmlwdCkgKyB0YWdUb1JldGFpbjsKICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIGVuc3VyZVRlbXBsYXRlSXNSZXdyaXR0ZW46IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgdGVtcGxhdGVFbmdpbmUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgICAgICAgICAgaWYgKCF0ZW1wbGF0ZUVuZ2luZVsnaXNUZW1wbGF0ZVJld3JpdHRlbiddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSkKICAgICAgICAgICAgICAgIHRlbXBsYXRlRW5naW5lWydyZXdyaXRlVGVtcGxhdGUnXSh0ZW1wbGF0ZSwgZnVuY3Rpb24gKGh0bWxTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28udGVtcGxhdGVSZXdyaXRpbmcubWVtb2l6ZUJpbmRpbmdBdHRyaWJ1dGVTeW50YXgoaHRtbFN0cmluZywgdGVtcGxhdGVFbmdpbmUpOwogICAgICAgICAgICAgICAgfSwgdGVtcGxhdGVEb2N1bWVudCk7CiAgICAgICAgfSwKCiAgICAgICAgbWVtb2l6ZUJpbmRpbmdBdHRyaWJ1dGVTeW50YXg6IGZ1bmN0aW9uIChodG1sU3RyaW5nLCB0ZW1wbGF0ZUVuZ2luZSkgewogICAgICAgICAgICByZXR1cm4gaHRtbFN0cmluZy5yZXBsYWNlKG1lbW9pemVEYXRhQmluZGluZ0F0dHJpYnV0ZVN5bnRheFJlZ2V4LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY29uc3RydWN0TWVtb2l6ZWRUYWdSZXBsYWNlbWVudCgvKiBkYXRhQmluZEF0dHJpYnV0ZVZhbHVlOiAqLyBhcmd1bWVudHNbNl0sIC8qIHRhZ1RvUmV0YWluOiAqLyBhcmd1bWVudHNbMV0sIHRlbXBsYXRlRW5naW5lKTsKICAgICAgICAgICAgfSkucmVwbGFjZShtZW1vaXplVmlydHVhbENvbnRhaW5lckJpbmRpbmdTeW50YXhSZWdleCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY29uc3RydWN0TWVtb2l6ZWRUYWdSZXBsYWNlbWVudCgvKiBkYXRhQmluZEF0dHJpYnV0ZVZhbHVlOiAqLyBhcmd1bWVudHNbMV0sIC8qIHRhZ1RvUmV0YWluOiAqLyAiPCEtLSBrbyAtLT4iLCB0ZW1wbGF0ZUVuZ2luZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGFwcGx5TWVtb2l6ZWRCaW5kaW5nc1RvTmV4dFNpYmxpbmc6IGZ1bmN0aW9uIChiaW5kaW5ncykgewogICAgICAgICAgICByZXR1cm4ga28ubWVtb2l6YXRpb24ubWVtb2l6ZShmdW5jdGlvbiAoZG9tTm9kZSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIGlmIChkb21Ob2RlLm5leHRTaWJsaW5nKQogICAgICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3NUb05vZGUoZG9tTm9kZS5uZXh0U2libGluZywgYmluZGluZ3MsIGJpbmRpbmdDb250ZXh0KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVJld3JpdGluZycsIGtvLnRlbXBsYXRlUmV3cml0aW5nKTsKa28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVJld3JpdGluZy5hcHBseU1lbW9pemVkQmluZGluZ3NUb05leHRTaWJsaW5nJywga28udGVtcGxhdGVSZXdyaXRpbmcuYXBwbHlNZW1vaXplZEJpbmRpbmdzVG9OZXh0U2libGluZyk7IC8vIEV4cG9ydGVkIG9ubHkgYmVjYXVzZSBpdCBoYXMgdG8gYmUgcmVmZXJlbmNlZCBieSBzdHJpbmcgbG9va3VwIGZyb20gd2l0aGluIHJld3JpdHRlbiB0ZW1wbGF0ZQooZnVuY3Rpb24oKSB7CiAgICAvLyBBIHRlbXBsYXRlIHNvdXJjZSByZXByZXNlbnRzIGEgcmVhZC93cml0ZSB3YXkgb2YgYWNjZXNzaW5nIGEgdGVtcGxhdGUuIFRoaXMgaXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciB0ZW1wbGF0ZSBsb2FkaW5nL3NhdmluZwogICAgLy8gbG9naWMgdG8gYmUgZHVwbGljYXRlZCBpbiBldmVyeSB0ZW1wbGF0ZSBlbmdpbmUgKGFuZCBtZWFucyB0aGV5IGNhbiBhbGwgd29yayB3aXRoIGFub255bW91cyB0ZW1wbGF0ZXMsIGV0Yy4pCiAgICAvLwogICAgLy8gVHdvIGFyZSBwcm92aWRlZCBieSBkZWZhdWx0OgogICAgLy8gIDEuIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ICAgICAgIC0gcmVhZHMvd3JpdGVzIHRoZSB0ZXh0IGNvbnRlbnQgb2YgYW4gYXJiaXRyYXJ5IERPTSBlbGVtZW50CiAgICAvLyAgMi4ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c0VsZW1lbnQgLSB1c2VzIGtvLnV0aWxzLmRvbURhdGEgdG8gcmVhZC93cml0ZSB0ZXh0ICphc3NvY2lhdGVkKiB3aXRoIHRoZSBET00gZWxlbWVudCwgYnV0CiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRob3V0IHJlYWRpbmcvd3JpdGluZyB0aGUgYWN0dWFsIGVsZW1lbnQgdGV4dCBjb250ZW50LCBzaW5jZSBpdCB3aWxsIGJlIG92ZXJ3cml0dGVuCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvdXRwdXQuCiAgICAvLyBZb3UgY2FuIGltcGxlbWVudCB5b3VyIG93biB0ZW1wbGF0ZSBzb3VyY2UgaWYgeW91IHdhbnQgdG8gZmV0Y2gvc3RvcmUgdGVtcGxhdGVzIHNvbWV3aGVyZSBvdGhlciB0aGFuIGluIERPTSBlbGVtZW50cy4KICAgIC8vIFRlbXBsYXRlIHNvdXJjZXMgbmVlZCB0byBoYXZlIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zOgogICAgLy8gICB0ZXh0KCkgICAgICAgICAgICAgLSByZXR1cm5zIHRoZSB0ZW1wbGF0ZSB0ZXh0IGZyb20geW91ciBzdG9yYWdlIGxvY2F0aW9uCiAgICAvLyAgIHRleHQodmFsdWUpICAgICAgICAtIHdyaXRlcyB0aGUgc3VwcGxpZWQgdGVtcGxhdGUgdGV4dCB0byB5b3VyIHN0b3JhZ2UgbG9jYXRpb24KICAgIC8vICAgZGF0YShrZXkpICAgICAgICAgICAgLSByZWFkcyB2YWx1ZXMgc3RvcmVkIHVzaW5nIGRhdGEoa2V5LCB2YWx1ZSkgLSBzZWUgYmVsb3cKICAgIC8vICAgZGF0YShrZXksIHZhbHVlKSAgICAtIGFzc29jaWF0ZXMgInZhbHVlIiB3aXRoIHRoaXMgdGVtcGxhdGUgYW5kIHRoZSBrZXkgImtleSIuIElzIHVzZWQgdG8gc3RvcmUgaW5mb3JtYXRpb24gbGlrZSAiaXNSZXdyaXR0ZW4iLgogICAgLy8KICAgIC8vIE9wdGlvbmFsbHksIHRlbXBsYXRlIHNvdXJjZXMgY2FuIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uczoKICAgIC8vICAgbm9kZXMoKSAgICAgICAgICAgIC0gcmV0dXJucyBhIERPTSBlbGVtZW50IGNvbnRhaW5pbmcgdGhlIG5vZGVzIG9mIHRoaXMgdGVtcGxhdGUsIHdoZXJlIGF2YWlsYWJsZQogICAgLy8gICBub2Rlcyh2YWx1ZSkgICAgICAgLSB3cml0ZXMgdGhlIGdpdmVuIERPTSBlbGVtZW50IHRvIHlvdXIgc3RvcmFnZSBsb2NhdGlvbgogICAgLy8gSWYgYSBET00gZWxlbWVudCBpcyBhdmFpbGFibGUgZm9yIGEgZ2l2ZW4gdGVtcGxhdGUgc291cmNlLCB0ZW1wbGF0ZSBlbmdpbmVzIGFyZSBlbmNvdXJhZ2VkIHRvIHVzZSBpdCBpbiBwcmVmZXJlbmNlIG92ZXIgdGV4dCgpCiAgICAvLyBmb3IgaW1wcm92ZWQgc3BlZWQuIEhvd2V2ZXIsIGFsbCB0ZW1wbGF0ZVNvdXJjZXMgbXVzdCBzdXBwbHkgdGV4dCgpIGV2ZW4gaWYgdGhleSBkb24ndCBzdXBwbHkgbm9kZXMoKS4KICAgIC8vCiAgICAvLyBPbmNlIHlvdSd2ZSBpbXBsZW1lbnRlZCBhIHRlbXBsYXRlU291cmNlLCBtYWtlIHlvdXIgdGVtcGxhdGUgZW5naW5lIHVzZSBpdCBieSBzdWJjbGFzc2luZyB3aGF0ZXZlciB0ZW1wbGF0ZSBlbmdpbmUgeW91IHdlcmUKICAgIC8vIHVzaW5nIGFuZCBvdmVycmlkaW5nICJtYWtlVGVtcGxhdGVTb3VyY2UiIHRvIHJldHVybiBhbiBpbnN0YW5jZSBvZiB5b3VyIGN1c3RvbSB0ZW1wbGF0ZSBzb3VyY2UuCgogICAga28udGVtcGxhdGVTb3VyY2VzID0ge307CgogICAgLy8gLS0tLSBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCAtLS0tLQoKICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9CgogICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICB2YXIgdGFnTmFtZUxvd2VyID0ga28udXRpbHMudGFnTmFtZUxvd2VyKHRoaXMuZG9tRWxlbWVudCksCiAgICAgICAgICAgIGVsZW1Db250ZW50c1Byb3BlcnR5ID0gdGFnTmFtZUxvd2VyID09PSAic2NyaXB0IiA/ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHRhZ05hbWVMb3dlciA9PT0gInRleHRhcmVhIiA/ICJ2YWx1ZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAiaW5uZXJIVE1MIjsKCiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kb21FbGVtZW50W2VsZW1Db250ZW50c1Byb3BlcnR5XTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdmFsdWVUb1dyaXRlID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICBpZiAoZWxlbUNvbnRlbnRzUHJvcGVydHkgPT09ICJpbm5lckhUTUwiKQogICAgICAgICAgICAgICAga28udXRpbHMuc2V0SHRtbCh0aGlzLmRvbUVsZW1lbnQsIHZhbHVlVG9Xcml0ZSk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHRoaXMuZG9tRWxlbWVudFtlbGVtQ29udGVudHNQcm9wZXJ0eV0gPSB2YWx1ZVRvV3JpdGU7CiAgICAgICAgfQogICAgfTsKCiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ2RhdGEnXSA9IGZ1bmN0aW9uKGtleSAvKiwgdmFsdWVUb1dyaXRlICovKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KHRoaXMuZG9tRWxlbWVudCwgInRlbXBsYXRlU291cmNlRGF0YV8iICsga2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsICJ0ZW1wbGF0ZVNvdXJjZURhdGFfIiArIGtleSwgYXJndW1lbnRzWzFdKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIC0tLS0ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlIC0tLS0tCiAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGVzIGFyZSBub3JtYWxseSBzYXZlZC9yZXRyaWV2ZWQgYXMgRE9NIG5vZGVzIHRocm91Z2ggIm5vZGVzIi4KICAgIC8vIEZvciBjb21wYXRpYmlsaXR5LCB5b3UgY2FuIGFsc28gcmVhZCAidGV4dCI7IGl0IHdpbGwgYmUgc2VyaWFsaXplZCBmcm9tIHRoZSBub2RlcyBvbiBkZW1hbmQuCiAgICAvLyBXcml0aW5nIHRvICJ0ZXh0IiBpcyBzdGlsbCBzdXBwb3J0ZWQsIGJ1dCB0aGVuIHRoZSB0ZW1wbGF0ZSBkYXRhIHdpbGwgbm90IGJlIGF2YWlsYWJsZSBhcyBET00gbm9kZXMuCgogICAgdmFyIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkgPSAiX19rb19hbm9uX3RlbXBsYXRlX18iOwogICAga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CiAgICB9CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50KCk7CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwogICAgICAgICAgICBpZiAodGVtcGxhdGVEYXRhLnRleHREYXRhID09PSB1bmRlZmluZWQgJiYgdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGEpCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEudGV4dERhdGEgPSB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YS5pbm5lckhUTUw7CiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZURhdGEudGV4dERhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5LCB7dGV4dERhdGE6IHZhbHVlVG9Xcml0ZX0pOwogICAgICAgIH0KICAgIH07CiAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ25vZGVzJ10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGVEYXRhLmNvbnRhaW5lckRhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5LCB7Y29udGFpbmVyRGF0YTogdmFsdWVUb1dyaXRlfSk7CiAgICAgICAgfQogICAgfTsKCiAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcycsIGtvLnRlbXBsYXRlU291cmNlcyk7CiAgICBrby5leHBvcnRTeW1ib2woJ3RlbXBsYXRlU291cmNlcy5kb21FbGVtZW50Jywga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQpOwogICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUnLCBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUpOwp9KSgpOwooZnVuY3Rpb24gKCkgewogICAgdmFyIF90ZW1wbGF0ZUVuZ2luZTsKICAgIGtvLnNldFRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKHRlbXBsYXRlRW5naW5lKSB7CiAgICAgICAgaWYgKCh0ZW1wbGF0ZUVuZ2luZSAhPSB1bmRlZmluZWQpICYmICEodGVtcGxhdGVFbmdpbmUgaW5zdGFuY2VvZiBrby50ZW1wbGF0ZUVuZ2luZSkpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGVtcGxhdGVFbmdpbmUgbXVzdCBpbmhlcml0IGZyb20ga28udGVtcGxhdGVFbmdpbmUiKTsKICAgICAgICBfdGVtcGxhdGVFbmdpbmUgPSB0ZW1wbGF0ZUVuZ2luZTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnZva2VGb3JFYWNoTm9kZU9yQ29tbWVudEluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGFjdGlvbikgewogICAgICAgIHZhciBub2RlLCBuZXh0SW5RdWV1ZSA9IGZpcnN0Tm9kZSwgZmlyc3RPdXRPZlJhbmdlTm9kZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhsYXN0Tm9kZSk7CiAgICAgICAgd2hpbGUgKG5leHRJblF1ZXVlICYmICgobm9kZSA9IG5leHRJblF1ZXVlKSAhPT0gZmlyc3RPdXRPZlJhbmdlTm9kZSkpIHsKICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxIHx8IG5vZGUubm9kZVR5cGUgPT09IDgpCiAgICAgICAgICAgICAgICBhY3Rpb24obm9kZSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkoY29udGludW91c05vZGVBcnJheSwgYmluZGluZ0NvbnRleHQpIHsKICAgICAgICAvLyBUbyBiZSB1c2VkIG9uIGFueSBub2RlcyB0aGF0IGhhdmUgYmVlbiByZW5kZXJlZCBieSBhIHRlbXBsYXRlIGFuZCBoYXZlIGJlZW4gaW5zZXJ0ZWQgaW50byBzb21lIHBhcmVudCBlbGVtZW50CiAgICAgICAgLy8gV2Fsa3MgdGhyb3VnaCBjb250aW51b3VzTm9kZUFycmF5ICh3aGljaCAqbXVzdCogYmUgY29udGludW91cywgaS5lLiwgYW4gdW5pbnRlcnJ1cHRlZCBzZXF1ZW5jZSBvZiBzaWJsaW5nIG5vZGVzLCBiZWNhdXNlCiAgICAgICAgLy8gdGhlIGFsZ29yaXRobSBmb3Igd2Fsa2luZyB0aGVtIHJlbGllcyBvbiB0aGlzKSwgYW5kIGZvciBlYWNoIHRvcC1sZXZlbCBpdGVtIGluIHRoZSB2aXJ0dWFsLWVsZW1lbnQgc2Vuc2UsCiAgICAgICAgLy8gKDEpIERvZXMgYSByZWd1bGFyICJhcHBseUJpbmRpbmdzIiB0byBhc3NvY2lhdGUgYmluZGluZ0NvbnRleHQgd2l0aCB0aGlzIG5vZGUgYW5kIHRvIGFjdGl2YXRlIGFueSBub24tbWVtb2l6ZWQgYmluZGluZ3MKICAgICAgICAvLyAoMikgVW5tZW1vaXplcyBhbnkgbWVtb3MgaW4gdGhlIERPTSBzdWJ0cmVlIChlLmcuLCB0byBhY3RpdmF0ZSBiaW5kaW5ncyB0aGF0IGhhZCBiZWVuIG1lbW9pemVkIGR1cmluZyB0ZW1wbGF0ZSByZXdyaXRpbmcpCgogICAgICAgIGlmIChjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCkgewogICAgICAgICAgICB2YXIgZmlyc3ROb2RlID0gY29udGludW91c05vZGVBcnJheVswXSwgbGFzdE5vZGUgPSBjb250aW51b3VzTm9kZUFycmF5W2NvbnRpbnVvdXNOb2RlQXJyYXkubGVuZ3RoIC0gMV07CgogICAgICAgICAgICAvLyBOZWVkIHRvIGFwcGx5QmluZGluZ3MgKmJlZm9yZSogdW5tZW1vemlhdGlvbiwgYmVjYXVzZSB1bm1lbW9pemF0aW9uIG1pZ2h0IGludHJvZHVjZSBleHRyYSBub2RlcyAodGhhdCB3ZSBkb24ndCB3YW50IHRvIHJlLWJpbmQpCiAgICAgICAgICAgIC8vIHdoZXJlYXMgYSByZWd1bGFyIGFwcGx5QmluZGluZ3Mgd29uJ3QgaW50cm9kdWNlIG5ldyBtZW1vaXplZCBub2RlcwogICAgICAgICAgICBpbnZva2VGb3JFYWNoTm9kZU9yQ29tbWVudEluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3MoYmluZGluZ0NvbnRleHQsIG5vZGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaW52b2tlRm9yRWFjaE5vZGVPckNvbW1lbnRJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMobm9kZSwgW2JpbmRpbmdDb250ZXh0XSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheShub2RlT3JOb2RlQXJyYXkpIHsKICAgICAgICByZXR1cm4gbm9kZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gbm9kZU9yTm9kZUFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG5vZGVPck5vZGVBcnJheS5sZW5ndGggPiAwID8gbm9kZU9yTm9kZUFycmF5WzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IHRhcmdldE5vZGVPck5vZGVBcnJheSAmJiBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheSh0YXJnZXROb2RlT3JOb2RlQXJyYXkpOwogICAgICAgIHZhciB0ZW1wbGF0ZURvY3VtZW50ID0gZmlyc3RUYXJnZXROb2RlICYmIGZpcnN0VGFyZ2V0Tm9kZS5vd25lckRvY3VtZW50OwogICAgICAgIHZhciB0ZW1wbGF0ZUVuZ2luZVRvVXNlID0gKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKTsKICAgICAgICBrby50ZW1wbGF0ZVJld3JpdGluZy5lbnN1cmVUZW1wbGF0ZUlzUmV3cml0dGVuKHRlbXBsYXRlLCB0ZW1wbGF0ZUVuZ2luZVRvVXNlLCB0ZW1wbGF0ZURvY3VtZW50KTsKICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gdGVtcGxhdGVFbmdpbmVUb1VzZVsncmVuZGVyVGVtcGxhdGUnXSh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpOwoKICAgICAgICAvLyBMb29zZWx5IGNoZWNrIHJlc3VsdCBpcyBhbiBhcnJheSBvZiBET00gbm9kZXMKICAgICAgICBpZiAoKHR5cGVvZiByZW5kZXJlZE5vZGVzQXJyYXkubGVuZ3RoICE9ICJudW1iZXIiKSB8fCAocmVuZGVyZWROb2Rlc0FycmF5Lmxlbmd0aCA+IDAgJiYgdHlwZW9mIHJlbmRlcmVkTm9kZXNBcnJheVswXS5ub2RlVHlwZSAhPSAibnVtYmVyIikpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGVtcGxhdGUgZW5naW5lIG11c3QgcmV0dXJuIGFuIGFycmF5IG9mIERPTSBub2RlcyIpOwoKICAgICAgICB2YXIgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IGZhbHNlOwogICAgICAgIHN3aXRjaCAocmVuZGVyTW9kZSkgewogICAgICAgICAgICBjYXNlICJyZXBsYWNlQ2hpbGRyZW4iOgogICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbih0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlcmVkTm9kZXNBcnJheSk7CiAgICAgICAgICAgICAgICBoYXZlQWRkZWROb2Rlc1RvUGFyZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJyZXBsYWNlTm9kZSI6CiAgICAgICAgICAgICAgICBrby51dGlscy5yZXBsYWNlRG9tTm9kZXModGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJlZE5vZGVzQXJyYXkpOwogICAgICAgICAgICAgICAgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWdub3JlVGFyZ2V0Tm9kZSI6IGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHJlbmRlck1vZGU6ICIgKyByZW5kZXJNb2RlKTsKICAgICAgICB9CgogICAgICAgIGlmIChoYXZlQWRkZWROb2Rlc1RvUGFyZW50KSB7CiAgICAgICAgICAgIGFjdGl2YXRlQmluZGluZ3NPbkNvbnRpbnVvdXNOb2RlQXJyYXkocmVuZGVyZWROb2Rlc0FycmF5LCBiaW5kaW5nQ29udGV4dCk7CiAgICAgICAgICAgIGlmIChvcHRpb25zWydhZnRlclJlbmRlciddKQogICAgICAgICAgICAgICAgb3B0aW9uc1snYWZ0ZXJSZW5kZXInXShyZW5kZXJlZE5vZGVzQXJyYXksIGJpbmRpbmdDb250ZXh0WyckZGF0YSddKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZW5kZXJlZE5vZGVzQXJyYXk7CiAgICB9CgogICAga28ucmVuZGVyVGVtcGxhdGUgPSBmdW5jdGlvbiAodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCB0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlck1vZGUpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBpZiAoKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKSA9PSB1bmRlZmluZWQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0IGEgdGVtcGxhdGUgZW5naW5lIGJlZm9yZSBjYWxsaW5nIHJlbmRlclRlbXBsYXRlIik7CiAgICAgICAgcmVuZGVyTW9kZSA9IHJlbmRlck1vZGUgfHwgInJlcGxhY2VDaGlsZHJlbiI7CgogICAgICAgIGlmICh0YXJnZXROb2RlT3JOb2RlQXJyYXkpIHsKICAgICAgICAgICAgdmFyIGZpcnN0VGFyZ2V0Tm9kZSA9IGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CgogICAgICAgICAgICB2YXIgd2hlblRvRGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICghZmlyc3RUYXJnZXROb2RlKSB8fCAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KGZpcnN0VGFyZ2V0Tm9kZSk7IH07IC8vIFBhc3NpdmUgZGlzcG9zYWwgKG9uIG5leHQgZXZhbHVhdGlvbikKICAgICAgICAgICAgdmFyIGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkID0gKGZpcnN0VGFyZ2V0Tm9kZSAmJiByZW5kZXJNb2RlID09ICJyZXBsYWNlTm9kZSIpID8gZmlyc3RUYXJnZXROb2RlLnBhcmVudE5vZGUgOiBmaXJzdFRhcmdldE5vZGU7CgogICAgICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSggLy8gU28gdGhlIERPTSBpcyBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgd2hlbiBhbnkgZGVwZW5kZW5jeSBjaGFuZ2VzCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlJ3ZlIGdvdCBhIHByb3BlciBiaW5kaW5nIGNvbnRleHQgdG8gd29yayB3aXRoCiAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdDb250ZXh0ID0gKGRhdGFPckJpbmRpbmdDb250ZXh0ICYmIChkYXRhT3JCaW5kaW5nQ29udGV4dCBpbnN0YW5jZW9mIGtvLmJpbmRpbmdDb250ZXh0KSkKICAgICAgICAgICAgICAgICAgICAgICAgPyBkYXRhT3JCaW5kaW5nQ29udGV4dAogICAgICAgICAgICAgICAgICAgICAgICA6IG5ldyBrby5iaW5kaW5nQ29udGV4dChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGFPckJpbmRpbmdDb250ZXh0KSk7CgogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lID0gdHlwZW9mKHRlbXBsYXRlKSA9PSAnZnVuY3Rpb24nID8gdGVtcGxhdGUoYmluZGluZ0NvbnRleHRbJyRkYXRhJ10pIDogdGVtcGxhdGU7CgogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZE5vZGVzQXJyYXkgPSBleGVjdXRlVGVtcGxhdGUodGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJNb2RlLCB0ZW1wbGF0ZU5hbWUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVyTW9kZSA9PSAicmVwbGFjZU5vZGUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldE5vZGVPck5vZGVBcnJheSA9IHJlbmRlcmVkTm9kZXNBcnJheTsKICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RUYXJnZXROb2RlID0gZ2V0Rmlyc3ROb2RlRnJvbVBvc3NpYmxlQXJyYXkodGFyZ2V0Tm9kZU9yTm9kZUFycmF5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgIHsgJ2Rpc3Bvc2VXaGVuJzogd2hlblRvRGlzcG9zZSwgJ2Rpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCc6IGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIH0KICAgICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBXZSBkb24ndCB5ZXQgaGF2ZSBhIERPTSBub2RlIHRvIGV2YWx1YXRlLCBzbyB1c2UgYSBtZW1vIGFuZCByZW5kZXIgdGhlIHRlbXBsYXRlIGxhdGVyIHdoZW4gdGhlcmUgaXMgYSBET00gbm9kZQogICAgICAgICAgICByZXR1cm4ga28ubWVtb2l6YXRpb24ubWVtb2l6ZShmdW5jdGlvbiAoZG9tTm9kZSkgewogICAgICAgICAgICAgICAga28ucmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIGRhdGFPckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCBkb21Ob2RlLCAicmVwbGFjZU5vZGUiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfTsKCiAgICBrby5yZW5kZXJUZW1wbGF0ZUZvckVhY2ggPSBmdW5jdGlvbiAodGVtcGxhdGUsIGFycmF5T3JPYnNlcnZhYmxlQXJyYXksIG9wdGlvbnMsIHRhcmdldE5vZGUsIHBhcmVudEJpbmRpbmdDb250ZXh0KSB7CiAgICAgICAgLy8gU2luY2Ugc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyBhbHdheXMgY2FsbHMgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtIGFuZCB0aGVuCiAgICAgICAgLy8gYWN0aXZhdGVCaW5kaW5nc0NhbGxiYWNrIGZvciBhZGRlZCBpdGVtcywgd2UgY2FuIHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgaW4gdGhlIGZvcm1lciB0byB1c2UgaW4gdGhlIGxhdHRlci4KICAgICAgICB2YXIgYXJyYXlJdGVtQ29udGV4dDsKCiAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCBieSBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIHRvIGdldCB0aGUgbm9kZXMgdG8gYWRkIHRvIHRhcmdldE5vZGUKICAgICAgICB2YXIgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtID0gZnVuY3Rpb24gKGFycmF5VmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKICAgICAgICAgICAgdmFyIHRlbXBsYXRlTmFtZSA9IHR5cGVvZih0ZW1wbGF0ZSkgPT0gJ2Z1bmN0aW9uJyA/IHRlbXBsYXRlKGFycmF5VmFsdWUpIDogdGVtcGxhdGU7CiAgICAgICAgICAgIGFycmF5SXRlbUNvbnRleHQgPSBwYXJlbnRCaW5kaW5nQ29udGV4dFsnY3JlYXRlQ2hpbGRDb250ZXh0J10oa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShhcnJheVZhbHVlKSk7CiAgICAgICAgICAgIGFycmF5SXRlbUNvbnRleHRbJyRpbmRleCddID0gaW5kZXg7CiAgICAgICAgICAgIHJldHVybiBleGVjdXRlVGVtcGxhdGUobnVsbCwgImlnbm9yZVRhcmdldE5vZGUiLCB0ZW1wbGF0ZU5hbWUsIGFycmF5SXRlbUNvbnRleHQsIG9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIGhhcyBhZGRlZCBub2RlcyB0byB0YXJnZXROb2RlCiAgICAgICAgdmFyIGFjdGl2YXRlQmluZGluZ3NDYWxsYmFjayA9IGZ1bmN0aW9uKGFycmF5VmFsdWUsIGFkZGVkTm9kZXNBcnJheSwgaW5kZXgpIHsKICAgICAgICAgICAgYWN0aXZhdGVCaW5kaW5nc09uQ29udGludW91c05vZGVBcnJheShhZGRlZE5vZGVzQXJyYXksIGFycmF5SXRlbUNvbnRleHQpOwogICAgICAgICAgICBpZiAob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSkKICAgICAgICAgICAgICAgIG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10oYWRkZWROb2Rlc0FycmF5LCBhcnJheVZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB1bndyYXBwZWRBcnJheSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXJyYXlPck9ic2VydmFibGVBcnJheSkgfHwgW107CiAgICAgICAgICAgIGlmICh0eXBlb2YgdW53cmFwcGVkQXJyYXkubGVuZ3RoID09ICJ1bmRlZmluZWQiKSAvLyBDb2VyY2Ugc2luZ2xlIHZhbHVlIGludG8gYXJyYXkKICAgICAgICAgICAgICAgIHVud3JhcHBlZEFycmF5ID0gW3Vud3JhcHBlZEFycmF5XTsKCiAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgYW55IGVudHJpZXMgbWFya2VkIGFzIGRlc3Ryb3llZAogICAgICAgICAgICB2YXIgZmlsdGVyZWRBcnJheSA9IGtvLnV0aWxzLmFycmF5RmlsdGVyKHVud3JhcHBlZEFycmF5LCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uc1snaW5jbHVkZURlc3Ryb3llZCddIHx8IGl0ZW0gPT09IHVuZGVmaW5lZCB8fCBpdGVtID09PSBudWxsIHx8ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGl0ZW1bJ19kZXN0cm95J10pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcodGFyZ2V0Tm9kZSwgZmlsdGVyZWRBcnJheSwgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtLCBvcHRpb25zLCBhY3RpdmF0ZUJpbmRpbmdzQ2FsbGJhY2spOwoKICAgICAgICB9LCBudWxsLCB7ICdkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQnOiB0YXJnZXROb2RlIH0pOwogICAgfTsKCiAgICB2YXIgdGVtcGxhdGVTdWJzY3JpcHRpb25Eb21EYXRhS2V5ID0gJ19fa29fX3RlbXBsYXRlU3Vic2NyaXB0aW9uRG9tRGF0YUtleV9fJzsKICAgIGZ1bmN0aW9uIGRpc3Bvc2VPbGRTdWJzY3JpcHRpb25BbmRTdG9yZU5ld09uZShlbGVtZW50LCBuZXdTdWJzY3JpcHRpb24pIHsKICAgICAgICB2YXIgb2xkU3Vic2NyaXB0aW9uID0ga28udXRpbHMuZG9tRGF0YS5nZXQoZWxlbWVudCwgdGVtcGxhdGVTdWJzY3JpcHRpb25Eb21EYXRhS2V5KTsKICAgICAgICBpZiAob2xkU3Vic2NyaXB0aW9uICYmICh0eXBlb2Yob2xkU3Vic2NyaXB0aW9uLmRpc3Bvc2UpID09ICdmdW5jdGlvbicpKQogICAgICAgICAgICBvbGRTdWJzY3JpcHRpb24uZGlzcG9zZSgpOwogICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIHRlbXBsYXRlU3Vic2NyaXB0aW9uRG9tRGF0YUtleSwgbmV3U3Vic2NyaXB0aW9uKTsKICAgIH0KCiAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ3RlbXBsYXRlJ10gPSB7CiAgICAgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQgYW5vbnltb3VzIHRlbXBsYXRlcwogICAgICAgICAgICB2YXIgYmluZGluZ1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgICAgICBpZiAoKHR5cGVvZiBiaW5kaW5nVmFsdWUgIT0gInN0cmluZyIpICYmICghYmluZGluZ1ZhbHVlWyduYW1lJ10pICYmIChlbGVtZW50Lm5vZGVUeXBlID09IDEgfHwgZWxlbWVudC5ub2RlVHlwZSA9PSA4KSkgewogICAgICAgICAgICAgICAgLy8gSXQncyBhbiBhbm9ueW1vdXMgdGVtcGxhdGUgLSBzdG9yZSB0aGUgZWxlbWVudCBjb250ZW50cywgdGhlbiBjbGVhciB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlTm9kZXMgPSBlbGVtZW50Lm5vZGVUeXBlID09IDEgPyBlbGVtZW50LmNoaWxkTm9kZXMgOiBrby52aXJ0dWFsRWxlbWVudHMuY2hpbGROb2RlcyhlbGVtZW50KSwKICAgICAgICAgICAgICAgICAgICBjb250YWluZXIgPSBrby51dGlscy5tb3ZlQ2xlYW5lZE5vZGVzVG9Db250YWluZXJFbGVtZW50KHRlbXBsYXRlTm9kZXMpOyAvLyBUaGlzIGFsc28gcmVtb3ZlcyB0aGUgbm9kZXMgZnJvbSB0aGVpciBjdXJyZW50IHBhcmVudAogICAgICAgICAgICAgICAgbmV3IGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZShlbGVtZW50KVsnbm9kZXMnXShjb250YWluZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKICAgICAgICB9LAogICAgICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICB2YXIgYmluZGluZ1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwogICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lOwogICAgICAgICAgICB2YXIgc2hvdWxkRGlzcGxheSA9IHRydWU7CgogICAgICAgICAgICBpZiAodHlwZW9mIGJpbmRpbmdWYWx1ZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdGVtcGxhdGVOYW1lID0gYmluZGluZ1ZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGVtcGxhdGVOYW1lID0gYmluZGluZ1ZhbHVlWyduYW1lJ107CgogICAgICAgICAgICAgICAgLy8gU3VwcG9ydCAiaWYiLyJpZm5vdCIgY29uZGl0aW9ucwogICAgICAgICAgICAgICAgaWYgKCdpZicgaW4gYmluZGluZ1ZhbHVlKQogICAgICAgICAgICAgICAgICAgIHNob3VsZERpc3BsYXkgPSBzaG91bGREaXNwbGF5ICYmIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYmluZGluZ1ZhbHVlWydpZiddKTsKICAgICAgICAgICAgICAgIGlmICgnaWZub3QnIGluIGJpbmRpbmdWYWx1ZSkKICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gc2hvdWxkRGlzcGxheSAmJiAha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShiaW5kaW5nVmFsdWVbJ2lmbm90J10pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdGVtcGxhdGVTdWJzY3JpcHRpb24gPSBudWxsOwoKICAgICAgICAgICAgaWYgKCh0eXBlb2YgYmluZGluZ1ZhbHVlID09PSAnb2JqZWN0JykgJiYgKCdmb3JlYWNoJyBpbiBiaW5kaW5nVmFsdWUpKSB7IC8vIE5vdGU6IGNhbid0IHVzZSAnaW4nIG9wZXJhdG9yIG9uIHN0cmluZ3MKICAgICAgICAgICAgICAgIC8vIFJlbmRlciBvbmNlIGZvciBlYWNoIGRhdGEgcG9pbnQgKHRyZWF0aW5nIGRhdGEgc2V0IGFzIGVtcHR5IGlmIHNob3VsZERpc3BsYXk9PWZhbHNlKQogICAgICAgICAgICAgICAgdmFyIGRhdGFBcnJheSA9IChzaG91bGREaXNwbGF5ICYmIGJpbmRpbmdWYWx1ZVsnZm9yZWFjaCddKSB8fCBbXTsKICAgICAgICAgICAgICAgIHRlbXBsYXRlU3Vic2NyaXB0aW9uID0ga28ucmVuZGVyVGVtcGxhdGVGb3JFYWNoKHRlbXBsYXRlTmFtZSB8fCBlbGVtZW50LCBkYXRhQXJyYXksIC8qIG9wdGlvbnM6ICovIGJpbmRpbmdWYWx1ZSwgZWxlbWVudCwgYmluZGluZ0NvbnRleHQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHNob3VsZERpc3BsYXkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBSZW5kZXIgb25jZSBmb3IgdGhpcyBzaW5nbGUgZGF0YSBwb2ludCAob3IgdXNlIHRoZSB2aWV3TW9kZWwgaWYgbm8gZGF0YSB3YXMgcHJvdmlkZWQpCiAgICAgICAgICAgICAgICAgICAgdmFyIGlubmVyQmluZGluZ0NvbnRleHQgPSAodHlwZW9mIGJpbmRpbmdWYWx1ZSA9PSAnb2JqZWN0JykgJiYgKCdkYXRhJyBpbiBiaW5kaW5nVmFsdWUpCiAgICAgICAgICAgICAgICAgICAgICAgID8gYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYmluZGluZ1ZhbHVlWydkYXRhJ10pKSAvLyBHaXZlbiBhbiBleHBsaXRpdCAnZGF0YScgdmFsdWUsIHdlIGNyZWF0ZSBhIGNoaWxkIGJpbmRpbmcgY29udGV4dCBmb3IgaXQKICAgICAgICAgICAgICAgICAgICAgICAgOiBiaW5kaW5nQ29udGV4dDsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdpdmVuIG5vIGV4cGxpY2l0ICdkYXRhJyB2YWx1ZSwgd2UgcmV0YWluIHRoZSBzYW1lIGJpbmRpbmcgY29udGV4dAogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlU3Vic2NyaXB0aW9uID0ga28ucmVuZGVyVGVtcGxhdGUodGVtcGxhdGVOYW1lIHx8IGVsZW1lbnQsIGlubmVyQmluZGluZ0NvbnRleHQsIC8qIG9wdGlvbnM6ICovIGJpbmRpbmdWYWx1ZSwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKGVsZW1lbnQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJdCBvbmx5IG1ha2VzIHNlbnNlIHRvIGhhdmUgYSBzaW5nbGUgdGVtcGxhdGUgc3Vic2NyaXB0aW9uIHBlciBlbGVtZW50IChvdGhlcndpc2Ugd2hpY2ggb25lIHNob3VsZCBoYXZlIGl0cyBvdXRwdXQgZGlzcGxheWVkPykKICAgICAgICAgICAgZGlzcG9zZU9sZFN1YnNjcmlwdGlvbkFuZFN0b3JlTmV3T25lKGVsZW1lbnQsIHRlbXBsYXRlU3Vic2NyaXB0aW9uKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIEFub255bW91cyB0ZW1wbGF0ZXMgY2FuJ3QgYmUgcmV3cml0dGVuLiBHaXZlIGEgbmljZSBlcnJvciBtZXNzYWdlIGlmIHlvdSB0cnkgdG8gZG8gaXQuCiAgICBrby5qc29uRXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnNbJ3RlbXBsYXRlJ10gPSBmdW5jdGlvbihiaW5kaW5nVmFsdWUpIHsKICAgICAgICB2YXIgcGFyc2VkQmluZGluZ1ZhbHVlID0ga28uanNvbkV4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsKGJpbmRpbmdWYWx1ZSk7CgogICAgICAgIGlmICgocGFyc2VkQmluZGluZ1ZhbHVlLmxlbmd0aCA9PSAxKSAmJiBwYXJzZWRCaW5kaW5nVmFsdWVbMF1bJ3Vua25vd24nXSkKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIEl0IGxvb2tzIGxpa2UgYSBzdHJpbmcgbGl0ZXJhbCwgbm90IGFuIG9iamVjdCBsaXRlcmFsLCBzbyB0cmVhdCBpdCBhcyBhIG5hbWVkIHRlbXBsYXRlICh3aGljaCBpcyBhbGxvd2VkIGZvciByZXdyaXRpbmcpCgogICAgICAgIGlmIChrby5qc29uRXhwcmVzc2lvblJld3JpdGluZy5rZXlWYWx1ZUFycmF5Q29udGFpbnNLZXkocGFyc2VkQmluZGluZ1ZhbHVlLCAibmFtZSIpKQogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gTmFtZWQgdGVtcGxhdGVzIGNhbiBiZSByZXdyaXR0ZW4sIHNvIHJldHVybiAibm8gZXJyb3IiCiAgICAgICAgcmV0dXJuICJUaGlzIHRlbXBsYXRlIGVuZ2luZSBkb2VzIG5vdCBzdXBwb3J0IGFub255bW91cyB0ZW1wbGF0ZXMgbmVzdGVkIHdpdGhpbiBpdHMgdGVtcGxhdGVzIjsKICAgIH07CgogICAga28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5nc1sndGVtcGxhdGUnXSA9IHRydWU7Cn0pKCk7Cgprby5leHBvcnRTeW1ib2woJ3NldFRlbXBsYXRlRW5naW5lJywga28uc2V0VGVtcGxhdGVFbmdpbmUpOwprby5leHBvcnRTeW1ib2woJ3JlbmRlclRlbXBsYXRlJywga28ucmVuZGVyVGVtcGxhdGUpOwoKKGZ1bmN0aW9uICgpIHsKICAgIC8vIFNpbXBsZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBMZXZlbnNodGVpbiBkaXN0YW5jZS4KICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZUVkaXREaXN0YW5jZU1hdHJpeChvbGRBcnJheSwgbmV3QXJyYXksIG1heEFsbG93ZWREaXN0YW5jZSkgewogICAgICAgIHZhciBkaXN0YW5jZXMgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBuZXdBcnJheS5sZW5ndGg7IGkrKykKICAgICAgICAgICAgZGlzdGFuY2VzW2ldID0gW107CgogICAgICAgIC8vIFRvcCByb3cgLSB0cmFuc2Zvcm0gb2xkIGFycmF5IGludG8gZW1wdHkgYXJyYXkgdmlhIGRlbGV0aW9ucwogICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gTWF0aC5taW4ob2xkQXJyYXkubGVuZ3RoLCBtYXhBbGxvd2VkRGlzdGFuY2UpOyBpIDw9IGo7IGkrKykKICAgICAgICAgICAgZGlzdGFuY2VzWzBdW2ldID0gaTsKCiAgICAgICAgLy8gTGVmdCByb3cgLSB0cmFuc2Zvcm0gZW1wdHkgYXJyYXkgaW50byBuZXcgYXJyYXkgdmlhIGFkZGl0aW9ucwogICAgICAgIGZvciAodmFyIGkgPSAxLCBqID0gTWF0aC5taW4obmV3QXJyYXkubGVuZ3RoLCBtYXhBbGxvd2VkRGlzdGFuY2UpOyBpIDw9IGo7IGkrKykgewogICAgICAgICAgICBkaXN0YW5jZXNbaV1bMF0gPSBpOwogICAgICAgIH0KCiAgICAgICAgLy8gRmlsbCBvdXQgdGhlIGJvZHkgb2YgdGhlIGFycmF5CiAgICAgICAgdmFyIG9sZEluZGV4LCBvbGRJbmRleE1heCA9IG9sZEFycmF5Lmxlbmd0aCwgbmV3SW5kZXgsIG5ld0luZGV4TWF4ID0gbmV3QXJyYXkubGVuZ3RoOwogICAgICAgIHZhciBkaXN0YW5jZVZpYUFkZGl0aW9uLCBkaXN0YW5jZVZpYURlbGV0aW9uOwogICAgICAgIGZvciAob2xkSW5kZXggPSAxOyBvbGRJbmRleCA8PSBvbGRJbmRleE1heDsgb2xkSW5kZXgrKykgewogICAgICAgICAgICB2YXIgbmV3SW5kZXhNaW5Gb3JSb3cgPSBNYXRoLm1heCgxLCBvbGRJbmRleCAtIG1heEFsbG93ZWREaXN0YW5jZSk7CiAgICAgICAgICAgIHZhciBuZXdJbmRleE1heEZvclJvdyA9IE1hdGgubWluKG5ld0luZGV4TWF4LCBvbGRJbmRleCArIG1heEFsbG93ZWREaXN0YW5jZSk7CiAgICAgICAgICAgIGZvciAobmV3SW5kZXggPSBuZXdJbmRleE1pbkZvclJvdzsgbmV3SW5kZXggPD0gbmV3SW5kZXhNYXhGb3JSb3c7IG5ld0luZGV4KyspIHsKICAgICAgICAgICAgICAgIGlmIChvbGRBcnJheVtvbGRJbmRleCAtIDFdID09PSBuZXdBcnJheVtuZXdJbmRleCAtIDFdKQogICAgICAgICAgICAgICAgICAgIGRpc3RhbmNlc1tuZXdJbmRleF1bb2xkSW5kZXhdID0gZGlzdGFuY2VzW25ld0luZGV4IC0gMV1bb2xkSW5kZXggLSAxXTsKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBub3J0aERpc3RhbmNlID0gZGlzdGFuY2VzW25ld0luZGV4IC0gMV1bb2xkSW5kZXhdID09PSB1bmRlZmluZWQgPyBOdW1iZXIuTUFYX1ZBTFVFIDogZGlzdGFuY2VzW25ld0luZGV4IC0gMV1bb2xkSW5kZXhdICsgMTsKICAgICAgICAgICAgICAgICAgICB2YXIgd2VzdERpc3RhbmNlID0gZGlzdGFuY2VzW25ld0luZGV4XVtvbGRJbmRleCAtIDFdID09PSB1bmRlZmluZWQgPyBOdW1iZXIuTUFYX1ZBTFVFIDogZGlzdGFuY2VzW25ld0luZGV4XVtvbGRJbmRleCAtIDFdICsgMTsKICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZXNbbmV3SW5kZXhdW29sZEluZGV4XSA9IE1hdGgubWluKG5vcnRoRGlzdGFuY2UsIHdlc3REaXN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBkaXN0YW5jZXM7CiAgICB9CgogICAgZnVuY3Rpb24gZmluZEVkaXRTY3JpcHRGcm9tRWRpdERpc3RhbmNlTWF0cml4KGVkaXREaXN0YW5jZU1hdHJpeCwgb2xkQXJyYXksIG5ld0FycmF5KSB7CiAgICAgICAgdmFyIG9sZEluZGV4ID0gb2xkQXJyYXkubGVuZ3RoOwogICAgICAgIHZhciBuZXdJbmRleCA9IG5ld0FycmF5Lmxlbmd0aDsKICAgICAgICB2YXIgZWRpdFNjcmlwdCA9IFtdOwogICAgICAgIHZhciBtYXhEaXN0YW5jZSA9IGVkaXREaXN0YW5jZU1hdHJpeFtuZXdJbmRleF1bb2xkSW5kZXhdOwogICAgICAgIGlmIChtYXhEaXN0YW5jZSA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gbWF4QWxsb3dlZERpc3RhbmNlIG11c3QgYmUgdG9vIHNtYWxsCiAgICAgICAgd2hpbGUgKChvbGRJbmRleCA+IDApIHx8IChuZXdJbmRleCA+IDApKSB7CiAgICAgICAgICAgIHZhciBtZSA9IGVkaXREaXN0YW5jZU1hdHJpeFtuZXdJbmRleF1bb2xkSW5kZXhdOwogICAgICAgICAgICB2YXIgZGlzdGFuY2VWaWFBZGQgPSAobmV3SW5kZXggPiAwKSA/IGVkaXREaXN0YW5jZU1hdHJpeFtuZXdJbmRleCAtIDFdW29sZEluZGV4XSA6IG1heERpc3RhbmNlICsgMTsKICAgICAgICAgICAgdmFyIGRpc3RhbmNlVmlhRGVsZXRlID0gKG9sZEluZGV4ID4gMCkgPyBlZGl0RGlzdGFuY2VNYXRyaXhbbmV3SW5kZXhdW29sZEluZGV4IC0gMV0gOiBtYXhEaXN0YW5jZSArIDE7CiAgICAgICAgICAgIHZhciBkaXN0YW5jZVZpYVJldGFpbiA9IChuZXdJbmRleCA+IDApICYmIChvbGRJbmRleCA+IDApID8gZWRpdERpc3RhbmNlTWF0cml4W25ld0luZGV4IC0gMV1bb2xkSW5kZXggLSAxXSA6IG1heERpc3RhbmNlICsgMTsKICAgICAgICAgICAgaWYgKChkaXN0YW5jZVZpYUFkZCA9PT0gdW5kZWZpbmVkKSB8fCAoZGlzdGFuY2VWaWFBZGQgPCBtZSAtIDEpKSBkaXN0YW5jZVZpYUFkZCA9IG1heERpc3RhbmNlICsgMTsKICAgICAgICAgICAgaWYgKChkaXN0YW5jZVZpYURlbGV0ZSA9PT0gdW5kZWZpbmVkKSB8fCAoZGlzdGFuY2VWaWFEZWxldGUgPCBtZSAtIDEpKSBkaXN0YW5jZVZpYURlbGV0ZSA9IG1heERpc3RhbmNlICsgMTsKICAgICAgICAgICAgaWYgKGRpc3RhbmNlVmlhUmV0YWluIDwgbWUgLSAxKSBkaXN0YW5jZVZpYVJldGFpbiA9IG1heERpc3RhbmNlICsgMTsKCiAgICAgICAgICAgIGlmICgoZGlzdGFuY2VWaWFBZGQgPD0gZGlzdGFuY2VWaWFEZWxldGUpICYmIChkaXN0YW5jZVZpYUFkZCA8IGRpc3RhbmNlVmlhUmV0YWluKSkgewogICAgICAgICAgICAgICAgZWRpdFNjcmlwdC5wdXNoKHsgc3RhdHVzOiAiYWRkZWQiLCB2YWx1ZTogbmV3QXJyYXlbbmV3SW5kZXggLSAxXSB9KTsKICAgICAgICAgICAgICAgIG5ld0luZGV4LS07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKGRpc3RhbmNlVmlhRGVsZXRlIDwgZGlzdGFuY2VWaWFBZGQpICYmIChkaXN0YW5jZVZpYURlbGV0ZSA8IGRpc3RhbmNlVmlhUmV0YWluKSkgewogICAgICAgICAgICAgICAgZWRpdFNjcmlwdC5wdXNoKHsgc3RhdHVzOiAiZGVsZXRlZCIsIHZhbHVlOiBvbGRBcnJheVtvbGRJbmRleCAtIDFdIH0pOwogICAgICAgICAgICAgICAgb2xkSW5kZXgtLTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVkaXRTY3JpcHQucHVzaCh7IHN0YXR1czogInJldGFpbmVkIiwgdmFsdWU6IG9sZEFycmF5W29sZEluZGV4IC0gMV0gfSk7CiAgICAgICAgICAgICAgICBuZXdJbmRleC0tOwogICAgICAgICAgICAgICAgb2xkSW5kZXgtLTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZWRpdFNjcmlwdC5yZXZlcnNlKCk7CiAgICB9CgogICAga28udXRpbHMuY29tcGFyZUFycmF5cyA9IGZ1bmN0aW9uIChvbGRBcnJheSwgbmV3QXJyYXksIG1heEVkaXRzVG9Db25zaWRlcikgewogICAgICAgIGlmIChtYXhFZGl0c1RvQ29uc2lkZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4ga28udXRpbHMuY29tcGFyZUFycmF5cyhvbGRBcnJheSwgbmV3QXJyYXksIDEpICAgICAgICAgICAgICAgICAvLyBGaXJzdCBjb25zaWRlciBsaWtlbHkgY2FzZSB3aGVyZSB0aGVyZSBpcyBhdCBtb3N0IG9uZSBlZGl0ICh2ZXJ5IGZhc3QpCiAgICAgICAgICAgICAgICB8fCBrby51dGlscy5jb21wYXJlQXJyYXlzKG9sZEFycmF5LCBuZXdBcnJheSwgMTApICAgICAgICAgICAgICAgIC8vIElmIHRoYXQgZmFpbHMsIGFjY291bnQgZm9yIGEgZmFpciBudW1iZXIgb2YgY2hhbmdlcyB3aGlsZSBzdGlsbCBiZWluZyBmYXN0CiAgICAgICAgICAgICAgICB8fCBrby51dGlscy5jb21wYXJlQXJyYXlzKG9sZEFycmF5LCBuZXdBcnJheSwgTnVtYmVyLk1BWF9WQUxVRSk7IC8vIFVsdGltYXRlbHkgZ2l2ZSB0aGUgcmlnaHQgYW5zd2VyLCBldmVuIHRob3VnaCBpdCBtYXkgdGFrZSBhIGxvbmcgdGltZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9sZEFycmF5ID0gb2xkQXJyYXkgfHwgW107CiAgICAgICAgICAgIG5ld0FycmF5ID0gbmV3QXJyYXkgfHwgW107CiAgICAgICAgICAgIHZhciBlZGl0RGlzdGFuY2VNYXRyaXggPSBjYWxjdWxhdGVFZGl0RGlzdGFuY2VNYXRyaXgob2xkQXJyYXksIG5ld0FycmF5LCBtYXhFZGl0c1RvQ29uc2lkZXIpOwogICAgICAgICAgICByZXR1cm4gZmluZEVkaXRTY3JpcHRGcm9tRWRpdERpc3RhbmNlTWF0cml4KGVkaXREaXN0YW5jZU1hdHJpeCwgb2xkQXJyYXksIG5ld0FycmF5KTsKICAgICAgICB9CiAgICB9Owp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5jb21wYXJlQXJyYXlzJywga28udXRpbHMuY29tcGFyZUFycmF5cyk7CgooZnVuY3Rpb24gKCkgewogICAgLy8gT2JqZWN0aXZlOgogICAgLy8gKiBHaXZlbiBhbiBpbnB1dCBhcnJheSwgYSBjb250YWluZXIgRE9NIG5vZGUsIGFuZCBhIGZ1bmN0aW9uIGZyb20gYXJyYXkgZWxlbWVudHMgdG8gYXJyYXlzIG9mIERPTSBub2RlcywKICAgIC8vICAgbWFwIHRoZSBhcnJheSBlbGVtZW50cyB0byBhcnJheXMgb2YgRE9NIG5vZGVzLCBjb25jYXRlbmF0ZSB0b2dldGhlciBhbGwgdGhlc2UgYXJyYXlzLCBhbmQgdXNlIHRoZW0gdG8gcG9wdWxhdGUgdGhlIGNvbnRhaW5lciBET00gbm9kZQogICAgLy8gKiBOZXh0IHRpbWUgd2UncmUgZ2l2ZW4gdGhlIHNhbWUgY29tYmluYXRpb24gb2YgdGhpbmdzICh3aXRoIHRoZSBhcnJheSBwb3NzaWJseSBoYXZpbmcgbXV0YXRlZCksIHVwZGF0ZSB0aGUgY29udGFpbmVyIERPTSBub2RlCiAgICAvLyAgIHNvIHRoYXQgaXRzIGNoaWxkcmVuIGlzIGFnYWluIHRoZSBjb25jYXRlbmF0aW9uIG9mIHRoZSBtYXBwaW5ncyBvZiB0aGUgYXJyYXkgZWxlbWVudHMsIGJ1dCBkb24ndCByZS1tYXAgYW55IGFycmF5IGVsZW1lbnRzIHRoYXQgd2UKICAgIC8vICAgcHJldmlvdXNseSBtYXBwZWQgLSByZXRhaW4gdGhvc2Ugbm9kZXMsIGFuZCBqdXN0IGluc2VydC9kZWxldGUgb3RoZXIgb25lcwoKICAgIC8vICJjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMiIHdpbGwgYmUgaW52b2tlZCBhZnRlciBhbnkgIm1hcHBpbmciLWdlbmVyYXRlZCBub2RlcyBhcmUgaW5zZXJ0ZWQgaW50byB0aGUgY29udGFpbmVyIG5vZGUKICAgIC8vIFlvdSBjYW4gdXNlIHRoaXMsIGZvciBleGFtcGxlLCB0byBhY3RpdmF0ZSBiaW5kaW5ncyBvbiB0aG9zZSBub2Rlcy4KCiAgICBmdW5jdGlvbiBmaXhVcFZpcnR1YWxFbGVtZW50cyhjb250aWd1b3VzTm9kZUFycmF5KSB7CiAgICAgICAgLy8gRW5zdXJlcyB0aGF0IGNvbnRpZ3VvdXNOb2RlQXJyYXkgcmVhbGx5ICppcyogYW4gYXJyYXkgb2YgY29udGlndW91cyBzaWJsaW5ncywgZXZlbiBpZiBzb21lIG9mIHRoZSBpbnRlcmlvcgogICAgICAgIC8vIG9uZXMgaGF2ZSBjaGFuZ2VkIHNpbmNlIHlvdXIgYXJyYXkgd2FzIGZpcnN0IGJ1aWx0IChlLmcuLCBiZWNhdXNlIHlvdXIgYXJyYXkgY29udGFpbnMgdmlydHVhbCBlbGVtZW50cywgYW5kCiAgICAgICAgLy8gdGhlaXIgdmlydHVhbCBjaGlsZHJlbiBjaGFuZ2VkIHdoZW4gYmluZGluZyB3YXMgYXBwbGllZCB0byB0aGVtKS4KICAgICAgICAvLyBUaGlzIGlzIG5lZWRlZCBzbyB0aGF0IHdlIGNhbiByZWxpYWJseSByZW1vdmUgb3IgdXBkYXRlIHRoZSBub2RlcyBjb3JyZXNwb25kaW5nIHRvIGEgZ2l2ZW4gYXJyYXkgaXRlbQoKICAgICAgICBpZiAoY29udGlndW91c05vZGVBcnJheS5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgIC8vIEJ1aWxkIHVwIHRoZSBhY3R1YWwgbmV3IGNvbnRpZ3VvdXMgbm9kZSBzZXQKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBjb250aWd1b3VzTm9kZUFycmF5WzBdLCBsYXN0ID0gY29udGlndW91c05vZGVBcnJheVtjb250aWd1b3VzTm9kZUFycmF5Lmxlbmd0aCAtIDFdLCBuZXdDb250aWd1b3VzU2V0ID0gW2N1cnJlbnRdOwogICAgICAgICAgICB3aGlsZSAoY3VycmVudCAhPT0gbGFzdCkgewogICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICBpZiAoIWN1cnJlbnQpIC8vIFdvbid0IGhhcHBlbiwgZXhjZXB0IGlmIHRoZSBkZXZlbG9wZXIgaGFzIG1hbnVhbGx5IHJlbW92ZWQgc29tZSBET00gZWxlbWVudHMgKHRoZW4gd2UncmUgaW4gYW4gdW5kZWZpbmVkIHNjZW5hcmlvKQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIG5ld0NvbnRpZ3VvdXNTZXQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gLi4uIHRoZW4gbXV0YXRlIHRoZSBpbnB1dCBhcnJheSB0byBtYXRjaCB0aGlzLgogICAgICAgICAgICAvLyAoVGhlIGZvbGxvd2luZyBsaW5lIHJlcGxhY2VzIHRoZSBjb250ZW50cyBvZiBjb250aWd1b3VzTm9kZUFycmF5IHdpdGggbmV3Q29udGlndW91c1NldCkKICAgICAgICAgICAgQXJyYXkucHJvdG90eXBlLnNwbGljZS5hcHBseShjb250aWd1b3VzTm9kZUFycmF5LCBbMCwgY29udGlndW91c05vZGVBcnJheS5sZW5ndGhdLmNvbmNhdChuZXdDb250aWd1b3VzU2V0KSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1hcE5vZGVBbmRSZWZyZXNoV2hlbkNoYW5nZWQoY29udGFpbmVyTm9kZSwgbWFwcGluZywgdmFsdWVUb01hcCwgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzLCBpbmRleCkgewogICAgICAgIC8vIE1hcCB0aGlzIGFycmF5IHZhbHVlIGluc2lkZSBhIGRlcGVuZGVudE9ic2VydmFibGUgc28gd2UgcmUtbWFwIHdoZW4gYW55IGRlcGVuZGVuY3kgY2hhbmdlcwogICAgICAgIHZhciBtYXBwZWROb2RlcyA9IFtdOwogICAgICAgIHZhciBkZXBlbmRlbnRPYnNlcnZhYmxlID0ga28uZGVwZW5kZW50T2JzZXJ2YWJsZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG5ld01hcHBlZE5vZGVzID0gbWFwcGluZyh2YWx1ZVRvTWFwLCBpbmRleCkgfHwgW107CgogICAgICAgICAgICAvLyBPbiBzdWJzZXF1ZW50IGV2YWx1YXRpb25zLCBqdXN0IHJlcGxhY2UgdGhlIHByZXZpb3VzbHktaW5zZXJ0ZWQgRE9NIG5vZGVzCiAgICAgICAgICAgIGlmIChtYXBwZWROb2Rlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBmaXhVcFZpcnR1YWxFbGVtZW50cyhtYXBwZWROb2Rlcyk7CiAgICAgICAgICAgICAgICBrby51dGlscy5yZXBsYWNlRG9tTm9kZXMobWFwcGVkTm9kZXMsIG5ld01hcHBlZE5vZGVzKTsKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMpCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKHZhbHVlVG9NYXAsIG5ld01hcHBlZE5vZGVzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVwbGFjZSB0aGUgY29udGVudHMgb2YgdGhlIG1hcHBlZE5vZGVzIGFycmF5LCB0aGVyZWJ5IHVwZGF0aW5nIHRoZSByZWNvcmQKICAgICAgICAgICAgLy8gb2Ygd2hpY2ggbm9kZXMgd291bGQgYmUgZGVsZXRlZCBpZiB2YWx1ZVRvTWFwIHdhcyBpdHNlbGYgbGF0ZXIgcmVtb3ZlZAogICAgICAgICAgICBtYXBwZWROb2Rlcy5zcGxpY2UoMCwgbWFwcGVkTm9kZXMubGVuZ3RoKTsKICAgICAgICAgICAga28udXRpbHMuYXJyYXlQdXNoQWxsKG1hcHBlZE5vZGVzLCBuZXdNYXBwZWROb2Rlcyk7CiAgICAgICAgfSwgbnVsbCwgeyAnZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkJzogY29udGFpbmVyTm9kZSwgJ2Rpc3Bvc2VXaGVuJzogZnVuY3Rpb24oKSB7IHJldHVybiAobWFwcGVkTm9kZXMubGVuZ3RoID09IDApIHx8ICFrby51dGlscy5kb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQobWFwcGVkTm9kZXNbMF0pIH0gfSk7CiAgICAgICAgcmV0dXJuIHsgbWFwcGVkTm9kZXMgOiBtYXBwZWROb2RlcywgZGVwZW5kZW50T2JzZXJ2YWJsZSA6IGRlcGVuZGVudE9ic2VydmFibGUgfTsKICAgIH0KCiAgICB2YXIgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5ID0gInNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmdfbGFzdE1hcHBpbmdSZXN1bHQiOwoKICAgIGtvLnV0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcgPSBmdW5jdGlvbiAoZG9tTm9kZSwgYXJyYXksIG1hcHBpbmcsIG9wdGlvbnMsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcykgewogICAgICAgIC8vIENvbXBhcmUgdGhlIHByb3ZpZGVkIGFycmF5IGFnYWluc3QgdGhlIHByZXZpb3VzIG9uZQogICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGlzRmlyc3RFeGVjdXRpb24gPSBrby51dGlscy5kb21EYXRhLmdldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXkpID09PSB1bmRlZmluZWQ7CiAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0ID0ga28udXRpbHMuZG9tRGF0YS5nZXQoZG9tTm9kZSwgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5KSB8fCBbXTsKICAgICAgICB2YXIgbGFzdEFycmF5ID0ga28udXRpbHMuYXJyYXlNYXAobGFzdE1hcHBpbmdSZXN1bHQsIGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LmFycmF5RW50cnk7IH0pOwogICAgICAgIHZhciBlZGl0U2NyaXB0ID0ga28udXRpbHMuY29tcGFyZUFycmF5cyhsYXN0QXJyYXksIGFycmF5KTsKCiAgICAgICAgLy8gQnVpbGQgdGhlIG5ldyBtYXBwaW5nIHJlc3VsdAogICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0ID0gW107CiAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwogICAgICAgIHZhciBub2Rlc1RvRGVsZXRlID0gW107CiAgICAgICAgdmFyIG5ld01hcHBpbmdSZXN1bHRJbmRleCA9IDA7CiAgICAgICAgdmFyIG5vZGVzQWRkZWQgPSBbXTsKICAgICAgICB2YXIgaW5zZXJ0QWZ0ZXJOb2RlID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGVkaXRTY3JpcHQubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgIHN3aXRjaCAoZWRpdFNjcmlwdFtpXS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgIGNhc2UgInJldGFpbmVkIjoKICAgICAgICAgICAgICAgICAgICAvLyBKdXN0IGtlZXAgdGhlIGluZm9ybWF0aW9uIC0gZG9uJ3QgdG91Y2ggdGhlIG5vZGVzCiAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGFUb1JldGFpbiA9IGxhc3RNYXBwaW5nUmVzdWx0W2xhc3RNYXBwaW5nUmVzdWx0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIGRhdGFUb1JldGFpbi5pbmRleE9ic2VydmFibGUobmV3TWFwcGluZ1Jlc3VsdEluZGV4KTsKICAgICAgICAgICAgICAgICAgICBuZXdNYXBwaW5nUmVzdWx0SW5kZXggPSBuZXdNYXBwaW5nUmVzdWx0LnB1c2goZGF0YVRvUmV0YWluKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVRvUmV0YWluLmRvbU5vZGVzLmxlbmd0aCA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydEFmdGVyTm9kZSA9IGRhdGFUb1JldGFpbi5kb21Ob2Rlc1tkYXRhVG9SZXRhaW4uZG9tTm9kZXMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgbGFzdE1hcHBpbmdSZXN1bHRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgImRlbGV0ZWQiOgogICAgICAgICAgICAgICAgICAgIC8vIFN0b3AgdHJhY2tpbmcgY2hhbmdlcyB0byB0aGUgbWFwcGluZyBmb3IgdGhlc2Ugbm9kZXMKICAgICAgICAgICAgICAgICAgICBsYXN0TWFwcGluZ1Jlc3VsdFtsYXN0TWFwcGluZ1Jlc3VsdEluZGV4XS5kZXBlbmRlbnRPYnNlcnZhYmxlLmRpc3Bvc2UoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gUXVldWUgdGhlc2Ugbm9kZXMgZm9yIGxhdGVyIHJlbW92YWwKICAgICAgICAgICAgICAgICAgICBmaXhVcFZpcnR1YWxFbGVtZW50cyhsYXN0TWFwcGluZ1Jlc3VsdFtsYXN0TWFwcGluZ1Jlc3VsdEluZGV4XS5kb21Ob2Rlcyk7CiAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGxhc3RNYXBwaW5nUmVzdWx0W2xhc3RNYXBwaW5nUmVzdWx0SW5kZXhdLmRvbU5vZGVzLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvRGVsZXRlLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IG5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6IGksCiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGVkaXRTY3JpcHRbaV0udmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydEFmdGVyTm9kZSA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgbGFzdE1hcHBpbmdSZXN1bHRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgImFkZGVkIjoKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWVUb01hcCA9IGVkaXRTY3JpcHRbaV0udmFsdWU7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4T2JzZXJ2YWJsZSA9IGtvLm9ic2VydmFibGUobmV3TWFwcGluZ1Jlc3VsdEluZGV4KTsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFwRGF0YSA9IG1hcE5vZGVBbmRSZWZyZXNoV2hlbkNoYW5nZWQoZG9tTm9kZSwgbWFwcGluZywgdmFsdWVUb01hcCwgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzLCBpbmRleE9ic2VydmFibGUpOwogICAgICAgICAgICAgICAgICAgIHZhciBtYXBwZWROb2RlcyA9IG1hcERhdGEubWFwcGVkTm9kZXM7CgogICAgICAgICAgICAgICAgICAgIC8vIE9uIHRoZSBmaXJzdCBldmFsdWF0aW9uLCBpbnNlcnQgdGhlIG5vZGVzIGF0IHRoZSBjdXJyZW50IGluc2VydGlvbiBwb2ludAogICAgICAgICAgICAgICAgICAgIG5ld01hcHBpbmdSZXN1bHRJbmRleCA9IG5ld01hcHBpbmdSZXN1bHQucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5RW50cnk6IGVkaXRTY3JpcHRbaV0udmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGRvbU5vZGVzOiBtYXBwZWROb2RlcywKICAgICAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZTogbWFwRGF0YS5kZXBlbmRlbnRPYnNlcnZhYmxlLAogICAgICAgICAgICAgICAgICAgICAgICBpbmRleE9ic2VydmFibGU6IGluZGV4T2JzZXJ2YWJsZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG5vZGVJbmRleCA9IDAsIG5vZGVJbmRleE1heCA9IG1hcHBlZE5vZGVzLmxlbmd0aDsgbm9kZUluZGV4IDwgbm9kZUluZGV4TWF4OyBub2RlSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IG1hcHBlZE5vZGVzW25vZGVJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVzQWRkZWQucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogbm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogaSwKICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZWRpdFNjcmlwdFtpXS52YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc2VydEFmdGVyTm9kZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbnNlcnQgIm5vZGUiICh0aGUgbmV3bHktY3JlYXRlZCBub2RlKSBhcyBkb21Ob2RlJ3MgZmlyc3QgY2hpbGQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5wcmVwZW5kKGRvbU5vZGUsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zZXJ0ICJub2RlIiBpbnRvICJkb21Ob2RlIiBpbW1lZGlhdGVseSBhZnRlciAiaW5zZXJ0QWZ0ZXJOb2RlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmluc2VydEFmdGVyKGRvbU5vZGUsIG5vZGUsIGluc2VydEFmdGVyTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0QWZ0ZXJOb2RlID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcykKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzKHZhbHVlVG9NYXAsIG1hcHBlZE5vZGVzLCBpbmRleE9ic2VydmFibGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2gobm9kZXNUb0RlbGV0ZSwgZnVuY3Rpb24gKG5vZGUpIHsga28uY2xlYW5Ob2RlKG5vZGUuZWxlbWVudCkgfSk7CgogICAgICAgIHZhciBpbnZva2VkQmVmb3JlUmVtb3ZlQ2FsbGJhY2sgPSBmYWxzZTsKICAgICAgICBpZiAoIWlzRmlyc3RFeGVjdXRpb24pIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnNbJ2FmdGVyQWRkJ10pIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXNBZGRlZC5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICBvcHRpb25zWydhZnRlckFkZCddKG5vZGVzQWRkZWRbaV0uZWxlbWVudCwgbm9kZXNBZGRlZFtpXS5pbmRleCwgbm9kZXNBZGRlZFtpXS52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnNbJ2JlZm9yZVJlbW92ZSddKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGVzVG9EZWxldGUubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc1snYmVmb3JlUmVtb3ZlJ10obm9kZXNUb0RlbGV0ZVtpXS5lbGVtZW50LCBub2Rlc1RvRGVsZXRlW2ldLmluZGV4LCBub2Rlc1RvRGVsZXRlW2ldLnZhbHVlKTsKICAgICAgICAgICAgICAgIGludm9rZWRCZWZvcmVSZW1vdmVDYWxsYmFjayA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFpbnZva2VkQmVmb3JlUmVtb3ZlQ2FsbGJhY2sgJiYgbm9kZXNUb0RlbGV0ZS5sZW5ndGgpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2Rlc1RvRGVsZXRlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IG5vZGVzVG9EZWxldGVbaV0uZWxlbWVudDsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBTdG9yZSBhIGNvcHkgb2YgdGhlIGFycmF5IGl0ZW1zIHdlIGp1c3QgY29uc2lkZXJlZCBzbyB3ZSBjYW4gZGlmZmVyZW5jZSBpdCBuZXh0IHRpbWUKICAgICAgICBrby51dGlscy5kb21EYXRhLnNldChkb21Ob2RlLCBsYXN0TWFwcGluZ1Jlc3VsdERvbURhdGFLZXksIG5ld01hcHBpbmdSZXN1bHQpOwogICAgfQp9KSgpOwoKa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nJywga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyk7CmtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgdGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID0gZmFsc2U7Cn0KCmtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpOwprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CiAgICB2YXIgdXNlTm9kZXNJZkF2YWlsYWJsZSA9ICEoa28udXRpbHMuaWVWZXJzaW9uIDwgOSksIC8vIElFPDkgY2xvbmVOb2RlIGRvZXNuJ3Qgd29yayBwcm9wZXJseQogICAgICAgIHRlbXBsYXRlTm9kZXNGdW5jID0gdXNlTm9kZXNJZkF2YWlsYWJsZSA/IHRlbXBsYXRlU291cmNlWydub2RlcyddIDogbnVsbCwKICAgICAgICB0ZW1wbGF0ZU5vZGVzID0gdGVtcGxhdGVOb2Rlc0Z1bmMgPyB0ZW1wbGF0ZVNvdXJjZVsnbm9kZXMnXSgpIDogbnVsbDsKCiAgICBpZiAodGVtcGxhdGVOb2RlcykgewogICAgICAgIHJldHVybiBrby51dGlscy5tYWtlQXJyYXkodGVtcGxhdGVOb2Rlcy5jbG9uZU5vZGUodHJ1ZSkuY2hpbGROb2Rlcyk7CiAgICB9IGVsc2UgewogICAgICAgIHZhciB0ZW1wbGF0ZVRleHQgPSB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKCk7CiAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KHRlbXBsYXRlVGV4dCk7CiAgICB9Cn07Cgprby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSA9IG5ldyBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSgpOwprby5zZXRUZW1wbGF0ZUVuZ2luZShrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSk7Cgprby5leHBvcnRTeW1ib2woJ25hdGl2ZVRlbXBsYXRlRW5naW5lJywga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUpOwooZnVuY3Rpb24oKSB7CiAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gRGV0ZWN0IHdoaWNoIHZlcnNpb24gb2YganF1ZXJ5LXRtcGwgeW91J3JlIHVzaW5nLiBVbmZvcnR1bmF0ZWx5IGpxdWVyeS10bXBsCiAgICAgICAgLy8gZG9lc24ndCBleHBvc2UgYSB2ZXJzaW9uIG51bWJlciwgc28gd2UgaGF2ZSB0byBpbmZlciBpdC4KICAgICAgICAvLyBOb3RlIHRoYXQgYXMgb2YgS25vY2tvdXQgMS4zLCB3ZSBvbmx5IHN1cHBvcnQgalF1ZXJ5LnRtcGwgMS4wLjBwcmUgYW5kIGxhdGVyLAogICAgICAgIC8vIHdoaWNoIEtPIGludGVybmFsbHkgcmVmZXJzIHRvIGFzIHZlcnNpb24gIjIiLCBzbyBvbGRlciB2ZXJzaW9ucyBhcmUgbm8gbG9uZ2VyIGRldGVjdGVkLgogICAgICAgIHZhciBqUXVlcnlUbXBsVmVyc2lvbiA9IHRoaXMualF1ZXJ5VG1wbFZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICgodHlwZW9mKGpRdWVyeSkgPT0gInVuZGVmaW5lZCIpIHx8ICEoalF1ZXJ5Wyd0bXBsJ10pKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIC8vIFNpbmNlIGl0IGV4cG9zZXMgbm8gb2ZmaWNpYWwgdmVyc2lvbiBudW1iZXIsIHdlIHVzZSBvdXIgb3duIG51bWJlcmluZyBzeXN0ZW0uIFRvIGJlIHVwZGF0ZWQgYXMganF1ZXJ5LXRtcGwgZXZvbHZlcy4KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChqUXVlcnlbJ3RtcGwnXVsndGFnJ11bJ3RtcGwnXVsnb3BlbiddLnRvU3RyaW5nKCkuaW5kZXhPZignX18nKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU2luY2UgMS4wLjBwcmUsIGN1c3RvbSB0YWdzIHNob3VsZCBhcHBlbmQgbWFya3VwIHRvIGFuIGFycmF5IGNhbGxlZCAiX18iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDI7IC8vIEZpbmFsIHZlcnNpb24gb2YganF1ZXJ5LnRtcGwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChleCkgeyAvKiBBcHBhcmVudGx5IG5vdCB0aGUgdmVyc2lvbiB3ZSB3ZXJlIGxvb2tpbmcgZm9yICovIH0KCiAgICAgICAgICAgIHJldHVybiAxOyAvLyBBbnkgb2xkZXIgdmVyc2lvbiB0aGF0IHdlIGRvbid0IHN1cHBvcnQKICAgICAgICB9KSgpOwoKICAgICAgICBmdW5jdGlvbiBlbnN1cmVIYXNSZWZlcmVuY2VkSlF1ZXJ5VGVtcGxhdGVzKCkgewogICAgICAgICAgICBpZiAoalF1ZXJ5VG1wbFZlcnNpb24gPCAyKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3VyIHZlcnNpb24gb2YgalF1ZXJ5LnRtcGwgaXMgdG9vIG9sZC4gUGxlYXNlIHVwZ3JhZGUgdG8galF1ZXJ5LnRtcGwgMS4wLjBwcmUgb3IgbGF0ZXIuIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBleGVjdXRlVGVtcGxhdGUoY29tcGlsZWRUZW1wbGF0ZSwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnlbJ3RtcGwnXShjb21waWxlZFRlbXBsYXRlLCBkYXRhLCBqUXVlcnlUZW1wbGF0ZU9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgdGhpc1sncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgZW5zdXJlSGFzUmVmZXJlbmNlZEpRdWVyeVRlbXBsYXRlcygpOwoKICAgICAgICAgICAgLy8gRW5zdXJlIHdlIGhhdmUgc3RvcmVkIGEgcHJlY29tcGlsZWQgdmVyc2lvbiBvZiB0aGlzIHRlbXBsYXRlIChkb24ndCB3YW50IHRvIHJlcGFyc2Ugb24gZXZlcnkgcmVuZGVyKQogICAgICAgICAgICB2YXIgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcpOwogICAgICAgICAgICBpZiAoIXByZWNvbXBpbGVkKSB7CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVUZXh0ID0gdGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpIHx8ICIiOwogICAgICAgICAgICAgICAgLy8gV3JhcCBpbiAid2l0aCgkd2hhdGV2ZXIua29CaW5kaW5nQ29udGV4dCkgeyAuLi4gfSIKICAgICAgICAgICAgICAgIHRlbXBsYXRlVGV4dCA9ICJ7e2tvX3dpdGggJGl0ZW0ua29CaW5kaW5nQ29udGV4dH19IiArIHRlbXBsYXRlVGV4dCArICJ7ey9rb193aXRofX0iOwoKICAgICAgICAgICAgICAgIHByZWNvbXBpbGVkID0galF1ZXJ5Wyd0ZW1wbGF0ZSddKG51bGwsIHRlbXBsYXRlVGV4dCk7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcsIHByZWNvbXBpbGVkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGRhdGEgPSBbYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dOyAvLyBQcmV3cmFwIHRoZSBkYXRhIGluIGFuIGFycmF5IHRvIHN0b3AganF1ZXJ5LnRtcGwgZnJvbSB0cnlpbmcgdG8gdW53cmFwIGFueSBhcnJheXMKICAgICAgICAgICAgdmFyIGpRdWVyeVRlbXBsYXRlT3B0aW9ucyA9IGpRdWVyeVsnZXh0ZW5kJ10oeyAna29CaW5kaW5nQ29udGV4dCc6IGJpbmRpbmdDb250ZXh0IH0sIG9wdGlvbnNbJ3RlbXBsYXRlT3B0aW9ucyddKTsKCiAgICAgICAgICAgIHZhciByZXN1bHROb2RlcyA9IGV4ZWN1dGVUZW1wbGF0ZShwcmVjb21waWxlZCwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKTsKICAgICAgICAgICAgcmVzdWx0Tm9kZXNbJ2FwcGVuZFRvJ10oZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpOyAvLyBVc2luZyAiYXBwZW5kVG8iIGZvcmNlcyBqUXVlcnkvalF1ZXJ5LnRtcGwgdG8gcGVyZm9ybSBuZWNlc3NhcnkgY2xlYW51cCB3b3JrCgogICAgICAgICAgICBqUXVlcnlbJ2ZyYWdtZW50cyddID0ge307IC8vIENsZWFyIGpRdWVyeSdzIGZyYWdtZW50IGNhY2hlIHRvIGF2b2lkIGEgbWVtb3J5IGxlYWsgYWZ0ZXIgYSBsYXJnZSBudW1iZXIgb2YgdGVtcGxhdGUgcmVuZGVycwogICAgICAgICAgICByZXR1cm4gcmVzdWx0Tm9kZXM7CiAgICAgICAgfTsKCiAgICAgICAgdGhpc1snY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10gPSBmdW5jdGlvbihzY3JpcHQpIHsKICAgICAgICAgICAgcmV0dXJuICJ7e2tvX2NvZGUgKChmdW5jdGlvbigpIHsgcmV0dXJuICIgKyBzY3JpcHQgKyAiIH0pKCkpIH19IjsKICAgICAgICB9OwoKICAgICAgICB0aGlzWydhZGRUZW1wbGF0ZSddID0gZnVuY3Rpb24odGVtcGxhdGVOYW1lLCB0ZW1wbGF0ZU1hcmt1cCkgewogICAgICAgICAgICBkb2N1bWVudC53cml0ZSgiPHNjcmlwdCB0eXBlPSd0ZXh0L2h0bWwnIGlkPSciICsgdGVtcGxhdGVOYW1lICsgIic+IiArIHRlbXBsYXRlTWFya3VwICsgIjwvc2NyaXB0PiIpOwogICAgICAgIH07CgogICAgICAgIGlmIChqUXVlcnlUbXBsVmVyc2lvbiA+IDApIHsKICAgICAgICAgICAgalF1ZXJ5Wyd0bXBsJ11bJ3RhZyddWydrb19jb2RlJ10gPSB7CiAgICAgICAgICAgICAgICBvcGVuOiAiX18ucHVzaCgkMSB8fCAnJyk7IgogICAgICAgICAgICB9OwogICAgICAgICAgICBqUXVlcnlbJ3RtcGwnXVsndGFnJ11bJ2tvX3dpdGgnXSA9IHsKICAgICAgICAgICAgICAgIG9wZW46ICJ3aXRoKCQxKSB7IiwKICAgICAgICAgICAgICAgIGNsb3NlOiAifSAiCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfTsKCiAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlID0gbmV3IGtvLnRlbXBsYXRlRW5naW5lKCk7CgogICAgLy8gVXNlIHRoaXMgb25lIGJ5IGRlZmF1bHQgKm9ubHkgaWYganF1ZXJ5LnRtcGwgaXMgcmVmZXJlbmNlZCoKICAgIHZhciBqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZSA9IG5ldyBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUoKTsKICAgIGlmIChqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZS5qUXVlcnlUbXBsVmVyc2lvbiA+IDApCiAgICAgICAga28uc2V0VGVtcGxhdGVFbmdpbmUoanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lSW5zdGFuY2UpOwoKICAgIGtvLmV4cG9ydFN5bWJvbCgnanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lJywga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lKTsKfSkoKTsKfSk7Cn0pKHdpbmRvdyxkb2N1bWVudCxuYXZpZ2F0b3IpOwoKLyoqCiAqIEBsaWNlbnNlIFJlcXVpcmVKUyB0ZXh0IDIuMC4xIENvcHlyaWdodCAoYykgMjAxMC0yMDEyLCBUaGUgRG9qbyBGb3VuZGF0aW9uIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqIEF2YWlsYWJsZSB2aWEgdGhlIE1JVCBvciBuZXcgQlNEIGxpY2Vuc2UuCiAqIHNlZTogaHR0cDovL2dpdGh1Yi5jb20vcmVxdWlyZWpzL3RleHQgZm9yIGRldGFpbHMKICovCi8qanNsaW50IHJlZ2V4cDogdHJ1ZSAqLwovKmdsb2JhbCByZXF1aXJlOiBmYWxzZSwgWE1MSHR0cFJlcXVlc3Q6IGZhbHNlLCBBY3RpdmVYT2JqZWN0OiBmYWxzZSwKICBkZWZpbmU6IGZhbHNlLCB3aW5kb3c6IGZhbHNlLCBwcm9jZXNzOiBmYWxzZSwgUGFja2FnZXM6IGZhbHNlLAogIGphdmE6IGZhbHNlLCBsb2NhdGlvbjogZmFsc2UgKi8KCmRlZmluZSgndGV4dCcsWydtb2R1bGUnXSwgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgCgogICAgdmFyIHByb2dJZHMgPSBbJ01zeG1sMi5YTUxIVFRQJywgJ01pY3Jvc29mdC5YTUxIVFRQJywgJ01zeG1sMi5YTUxIVFRQLjQuMCddLAogICAgICAgIHhtbFJlZ0V4cCA9IC9eXHMqPFw/eG1sKFxzKSt2ZXJzaW9uPVtcJ1wiXShcZCkqLihcZCkqW1wnXCJdKFxzKSpcPz4vaW0sCiAgICAgICAgYm9keVJlZ0V4cCA9IC88Ym9keVtePl0qPlxzKihbXHNcU10rKVxzKjxcL2JvZHk+L2ltLAogICAgICAgIGhhc0xvY2F0aW9uID0gdHlwZW9mIGxvY2F0aW9uICE9PSAndW5kZWZpbmVkJyAmJiBsb2NhdGlvbi5ocmVmLAogICAgICAgIGRlZmF1bHRQcm90b2NvbCA9IGhhc0xvY2F0aW9uICYmIGxvY2F0aW9uLnByb3RvY29sICYmIGxvY2F0aW9uLnByb3RvY29sLnJlcGxhY2UoL1w6LywgJycpLAogICAgICAgIGRlZmF1bHRIb3N0TmFtZSA9IGhhc0xvY2F0aW9uICYmIGxvY2F0aW9uLmhvc3RuYW1lLAogICAgICAgIGRlZmF1bHRQb3J0ID0gaGFzTG9jYXRpb24gJiYgKGxvY2F0aW9uLnBvcnQgfHwgdW5kZWZpbmVkKSwKICAgICAgICBidWlsZE1hcCA9IFtdLAogICAgICAgIG1hc3RlckNvbmZpZyA9IChtb2R1bGUuY29uZmlnICYmIG1vZHVsZS5jb25maWcoKSkgfHwge30sCiAgICAgICAgdGV4dCwgZnM7CgogICAgdGV4dCA9IHsKICAgICAgICB2ZXJzaW9uOiAnMi4wLjEnLAoKICAgICAgICBzdHJpcDogZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICAgICAgLy9TdHJpcHMgPD94bWwgLi4uPz4gZGVjbGFyYXRpb25zIHNvIHRoYXQgZXh0ZXJuYWwgU1ZHIGFuZCBYTUwKICAgICAgICAgICAgLy9kb2N1bWVudHMgY2FuIGJlIGFkZGVkIHRvIGEgZG9jdW1lbnQgd2l0aG91dCB3b3JyeS4gQWxzbywgaWYgdGhlIHN0cmluZwogICAgICAgICAgICAvL2lzIGFuIEhUTUwgZG9jdW1lbnQsIG9ubHkgdGhlIHBhcnQgaW5zaWRlIHRoZSBib2R5IHRhZyBpcyByZXR1cm5lZC4KICAgICAgICAgICAgaWYgKGNvbnRlbnQpIHsKICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UoeG1sUmVnRXhwLCAiIik7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlcyA9IGNvbnRlbnQubWF0Y2goYm9keVJlZ0V4cCk7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcykgewogICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBtYXRjaGVzWzFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGVudCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZW50OwogICAgICAgIH0sCgogICAgICAgIGpzRXNjYXBlOiBmdW5jdGlvbiAoY29udGVudCkgewogICAgICAgICAgICByZXR1cm4gY29udGVudC5yZXBsYWNlKC8oWydcXF0pL2csICdcXCQxJykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXGZdL2csICJcXGYiKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcYl0vZywgIlxcYiIpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1xuXS9nLCAiXFxuIikKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXHRdL2csICJcXHQiKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tccl0vZywgIlxcciIpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1x1MjAyOF0vZywgIlxcdTIwMjgiKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcdTIwMjldL2csICJcXHUyMDI5Iik7CiAgICAgICAgfSwKCiAgICAgICAgY3JlYXRlWGhyOiBtYXN0ZXJDb25maWcuY3JlYXRlWGhyIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy9Xb3VsZCBsb3ZlIHRvIGR1bXAgdGhlIEFjdGl2ZVggY3JhcCBpbiBoZXJlLiBOZWVkIElFIDYgdG8gZGllIGZpcnN0LgogICAgICAgICAgICB2YXIgeGhyLCBpLCBwcm9nSWQ7CiAgICAgICAgICAgIGlmICh0eXBlb2YgWE1MSHR0cFJlcXVlc3QgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIEFjdGl2ZVhPYmplY3QgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvZ0lkID0gcHJvZ0lkc1tpXTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB4aHIgPSBuZXcgQWN0aXZlWE9iamVjdChwcm9nSWQpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgICAgICAgICAgICAgICAgIGlmICh4aHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ0lkcyA9IFtwcm9nSWRdOyAgLy8gc28gZmFzdGVyIG5leHQgdGltZQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB4aHI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUGFyc2VzIGEgcmVzb3VyY2UgbmFtZSBpbnRvIGl0cyBjb21wb25lbnQgcGFydHMuIFJlc291cmNlIG5hbWVzCiAgICAgICAgICogbG9vayBsaWtlOiBtb2R1bGUvbmFtZS5leHQhc3RyaXAsIHdoZXJlIHRoZSAhc3RyaXAgcGFydCBpcwogICAgICAgICAqIG9wdGlvbmFsLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIHRoZSByZXNvdXJjZSBuYW1lCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gd2l0aCBwcm9wZXJ0aWVzICJtb2R1bGVOYW1lIiwgImV4dCIgYW5kICJzdHJpcCIKICAgICAgICAgKiB3aGVyZSBzdHJpcCBpcyBhIGJvb2xlYW4uCiAgICAgICAgICovCiAgICAgICAgcGFyc2VOYW1lOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgc3RyaXAgPSBmYWxzZSwgaW5kZXggPSBuYW1lLmluZGV4T2YoIi4iKSwKICAgICAgICAgICAgICAgIG1vZE5hbWUgPSBuYW1lLnN1YnN0cmluZygwLCBpbmRleCksCiAgICAgICAgICAgICAgICBleHQgPSBuYW1lLnN1YnN0cmluZyhpbmRleCArIDEsIG5hbWUubGVuZ3RoKTsKCiAgICAgICAgICAgIGluZGV4ID0gZXh0LmluZGV4T2YoIiEiKTsKICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgLy9QdWxsIG9mZiB0aGUgc3RyaXAgYXJnLgogICAgICAgICAgICAgICAgc3RyaXAgPSBleHQuc3Vic3RyaW5nKGluZGV4ICsgMSwgZXh0Lmxlbmd0aCk7CiAgICAgICAgICAgICAgICBzdHJpcCA9IHN0cmlwID09PSAic3RyaXAiOwogICAgICAgICAgICAgICAgZXh0ID0gZXh0LnN1YnN0cmluZygwLCBpbmRleCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBtb2R1bGVOYW1lOiBtb2ROYW1lLAogICAgICAgICAgICAgICAgZXh0OiBleHQsCiAgICAgICAgICAgICAgICBzdHJpcDogc3RyaXAKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICB4ZFJlZ0V4cDogL14oKFx3KylcOik/XC9cLyhbXlwvXFxdKykvLAoKICAgICAgICAvKioKICAgICAgICAgKiBJcyBhbiBVUkwgb24gYW5vdGhlciBkb21haW4uIE9ubHkgd29ya3MgZm9yIGJyb3dzZXIgdXNlLCByZXR1cm5zCiAgICAgICAgICogZmFsc2UgaW4gbm9uLWJyb3dzZXIgZW52aXJvbm1lbnRzLiBPbmx5IHVzZWQgdG8ga25vdyBpZiBhbgogICAgICAgICAqIG9wdGltaXplZCAuanMgdmVyc2lvbiBvZiBhIHRleHQgcmVzb3VyY2Ugc2hvdWxkIGJlIGxvYWRlZAogICAgICAgICAqIGluc3RlYWQuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybAogICAgICAgICAqIEByZXR1cm5zIEJvb2xlYW4KICAgICAgICAgKi8KICAgICAgICB1c2VYaHI6IGZ1bmN0aW9uICh1cmwsIHByb3RvY29sLCBob3N0bmFtZSwgcG9ydCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSB0ZXh0LnhkUmVnRXhwLmV4ZWModXJsKSwKICAgICAgICAgICAgICAgIHVQcm90b2NvbCwgdUhvc3ROYW1lLCB1UG9ydDsKICAgICAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdVByb3RvY29sID0gbWF0Y2hbMl07CiAgICAgICAgICAgIHVIb3N0TmFtZSA9IG1hdGNoWzNdOwoKICAgICAgICAgICAgdUhvc3ROYW1lID0gdUhvc3ROYW1lLnNwbGl0KCc6Jyk7CiAgICAgICAgICAgIHVQb3J0ID0gdUhvc3ROYW1lWzFdOwogICAgICAgICAgICB1SG9zdE5hbWUgPSB1SG9zdE5hbWVbMF07CgogICAgICAgICAgICByZXR1cm4gKCF1UHJvdG9jb2wgfHwgdVByb3RvY29sID09PSBwcm90b2NvbCkgJiYKICAgICAgICAgICAgICAgICAgICghdUhvc3ROYW1lIHx8IHVIb3N0TmFtZS50b0xvd2VyQ2FzZSgpID09PSBob3N0bmFtZS50b0xvd2VyQ2FzZSgpKSAmJgogICAgICAgICAgICAgICAgICAgKCghdVBvcnQgJiYgIXVIb3N0TmFtZSkgfHwgdVBvcnQgPT09IHBvcnQpOwogICAgICAgIH0sCgogICAgICAgIGZpbmlzaExvYWQ6IGZ1bmN0aW9uIChuYW1lLCBzdHJpcCwgY29udGVudCwgb25Mb2FkKSB7CiAgICAgICAgICAgIGNvbnRlbnQgPSBzdHJpcCA/IHRleHQuc3RyaXAoY29udGVudCkgOiBjb250ZW50OwogICAgICAgICAgICBpZiAobWFzdGVyQ29uZmlnLmlzQnVpbGQpIHsKICAgICAgICAgICAgICAgIGJ1aWxkTWFwW25hbWVdID0gY29udGVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBvbkxvYWQoY29udGVudCk7CiAgICAgICAgfSwKCiAgICAgICAgbG9hZDogZnVuY3Rpb24gKG5hbWUsIHJlcSwgb25Mb2FkLCBjb25maWcpIHsKICAgICAgICAgICAgLy9OYW1lIGhhcyBmb3JtYXQ6IHNvbWUubW9kdWxlLmZpbGV4dCFzdHJpcAogICAgICAgICAgICAvL1RoZSBzdHJpcCBwYXJ0IGlzIG9wdGlvbmFsLgogICAgICAgICAgICAvL2lmIHN0cmlwIGlzIHByZXNlbnQsIHRoZW4gdGhhdCBtZWFucyBvbmx5IGdldCB0aGUgc3RyaW5nIGNvbnRlbnRzCiAgICAgICAgICAgIC8vaW5zaWRlIGEgYm9keSB0YWcgaW4gYW4gSFRNTCBzdHJpbmcuIEZvciBYTUwvU1ZHIGNvbnRlbnQgaXQgbWVhbnMKICAgICAgICAgICAgLy9yZW1vdmluZyB0aGUgPD94bWwgLi4uPz4gZGVjbGFyYXRpb25zIHNvIHRoZSBjb250ZW50IGNhbiBiZSBpbnNlcnRlZAogICAgICAgICAgICAvL2ludG8gdGhlIGN1cnJlbnQgZG9jIHdpdGhvdXQgcHJvYmxlbXMuCgogICAgICAgICAgICAvLyBEbyBub3QgYm90aGVyIHdpdGggdGhlIHdvcmsgaWYgYSBidWlsZCBhbmQgdGV4dCB3aWxsCiAgICAgICAgICAgIC8vIG5vdCBiZSBpbmxpbmVkLgogICAgICAgICAgICBpZiAoY29uZmlnLmlzQnVpbGQgJiYgIWNvbmZpZy5pbmxpbmVUZXh0KSB7CiAgICAgICAgICAgICAgICBvbkxvYWQoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWFzdGVyQ29uZmlnLmlzQnVpbGQgPSBjb25maWcuaXNCdWlsZDsKCiAgICAgICAgICAgIHZhciBwYXJzZWQgPSB0ZXh0LnBhcnNlTmFtZShuYW1lKSwKICAgICAgICAgICAgICAgIG5vblN0cmlwTmFtZSA9IHBhcnNlZC5tb2R1bGVOYW1lICsgJy4nICsgcGFyc2VkLmV4dCwKICAgICAgICAgICAgICAgIHVybCA9IHJlcS50b1VybChub25TdHJpcE5hbWUpLAogICAgICAgICAgICAgICAgdXNlWGhyID0gKG1hc3RlckNvbmZpZy51c2VYaHIpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnVzZVhocjsKCiAgICAgICAgICAgIC8vTG9hZCB0aGUgdGV4dC4gVXNlIFhIUiBpZiBwb3NzaWJsZSBhbmQgaW4gYSBicm93c2VyLgogICAgICAgICAgICBpZiAoIWhhc0xvY2F0aW9uIHx8IHVzZVhocih1cmwsIGRlZmF1bHRQcm90b2NvbCwgZGVmYXVsdEhvc3ROYW1lLCBkZWZhdWx0UG9ydCkpIHsKICAgICAgICAgICAgICAgIHRleHQuZ2V0KHVybCwgZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0LmZpbmlzaExvYWQobmFtZSwgcGFyc2VkLnN0cmlwLCBjb250ZW50LCBvbkxvYWQpOwogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgIGlmIChvbkxvYWQuZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb25Mb2FkLmVycm9yKGVycik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvL05lZWQgdG8gZmV0Y2ggdGhlIHJlc291cmNlIGFjcm9zcyBkb21haW5zLiBBc3N1bWUKICAgICAgICAgICAgICAgIC8vdGhlIHJlc291cmNlIGhhcyBiZWVuIG9wdGltaXplZCBpbnRvIGEgSlMgbW9kdWxlLiBGZXRjaAogICAgICAgICAgICAgICAgLy9ieSB0aGUgbW9kdWxlIG5hbWUgKyBleHRlbnNpb24sIGJ1dCBkbyBub3QgaW5jbHVkZSB0aGUKICAgICAgICAgICAgICAgIC8vIXN0cmlwIHBhcnQgdG8gYXZvaWQgZmlsZSBzeXN0ZW0gaXNzdWVzLgogICAgICAgICAgICAgICAgcmVxKFtub25TdHJpcE5hbWVdLCBmdW5jdGlvbiAoY29udGVudCkgewogICAgICAgICAgICAgICAgICAgIHRleHQuZmluaXNoTG9hZChwYXJzZWQubW9kdWxlTmFtZSArICcuJyArIHBhcnNlZC5leHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZC5zdHJpcCwgY29udGVudCwgb25Mb2FkKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgd3JpdGU6IGZ1bmN0aW9uIChwbHVnaW5OYW1lLCBtb2R1bGVOYW1lLCB3cml0ZSwgY29uZmlnKSB7CiAgICAgICAgICAgIGlmIChidWlsZE1hcC5oYXNPd25Qcm9wZXJ0eShtb2R1bGVOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSB0ZXh0LmpzRXNjYXBlKGJ1aWxkTWFwW21vZHVsZU5hbWVdKTsKICAgICAgICAgICAgICAgIHdyaXRlLmFzTW9kdWxlKHBsdWdpbk5hbWUgKyAiISIgKyBtb2R1bGVOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmluZShmdW5jdGlvbiAoKSB7IHJldHVybiAnIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiJzt9KTtcbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgd3JpdGVGaWxlOiBmdW5jdGlvbiAocGx1Z2luTmFtZSwgbW9kdWxlTmFtZSwgcmVxLCB3cml0ZSwgY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwYXJzZWQgPSB0ZXh0LnBhcnNlTmFtZShtb2R1bGVOYW1lKSwKICAgICAgICAgICAgICAgIG5vblN0cmlwTmFtZSA9IHBhcnNlZC5tb2R1bGVOYW1lICsgJy4nICsgcGFyc2VkLmV4dCwKICAgICAgICAgICAgICAgIC8vVXNlIGEgJy5qcycgZmlsZSBuYW1lIHNvIHRoYXQgaXQgaW5kaWNhdGVzIGl0IGlzIGEKICAgICAgICAgICAgICAgIC8vc2NyaXB0IHRoYXQgY2FuIGJlIGxvYWRlZCBhY3Jvc3MgZG9tYWlucy4KICAgICAgICAgICAgICAgIGZpbGVOYW1lID0gcmVxLnRvVXJsKHBhcnNlZC5tb2R1bGVOYW1lICsgJy4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZC5leHQpICsgJy5qcyc7CgogICAgICAgICAgICAvL0xldmVyYWdlIG93biBsb2FkKCkgbWV0aG9kIHRvIGxvYWQgcGx1Z2luIHZhbHVlLCBidXQgb25seQogICAgICAgICAgICAvL3dyaXRlIG91dCB2YWx1ZXMgdGhhdCBkbyBub3QgaGF2ZSB0aGUgc3RyaXAgYXJndW1lbnQsCiAgICAgICAgICAgIC8vdG8gYXZvaWQgYW55IHBvdGVudGlhbCBpc3N1ZXMgd2l0aCAhIGluIGZpbGUgbmFtZXMuCiAgICAgICAgICAgIHRleHQubG9hZChub25TdHJpcE5hbWUsIHJlcSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAvL1VzZSBvd24gd3JpdGUoKSBtZXRob2QgdG8gY29uc3RydWN0IGZ1bGwgbW9kdWxlIHZhbHVlLgogICAgICAgICAgICAgICAgLy9CdXQgbmVlZCB0byBjcmVhdGUgc2hlbGwgdGhhdCB0cmFuc2xhdGVzIHdyaXRlRmlsZSdzCiAgICAgICAgICAgICAgICAvL3dyaXRlKCkgdG8gdGhlIHJpZ2h0IGludGVyZmFjZS4KICAgICAgICAgICAgICAgIHZhciB0ZXh0V3JpdGUgPSBmdW5jdGlvbiAoY29udGVudHMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd3JpdGUoZmlsZU5hbWUsIGNvbnRlbnRzKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0ZXh0V3JpdGUuYXNNb2R1bGUgPSBmdW5jdGlvbiAobW9kdWxlTmFtZSwgY29udGVudHMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd3JpdGUuYXNNb2R1bGUobW9kdWxlTmFtZSwgZmlsZU5hbWUsIGNvbnRlbnRzKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdGV4dC53cml0ZShwbHVnaW5OYW1lLCBub25TdHJpcE5hbWUsIHRleHRXcml0ZSwgY29uZmlnKTsKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICB9CiAgICB9OwoKICAgIGlmICh0eXBlb2YgcHJvY2VzcyAhPT0gInVuZGVmaW5lZCIgJiYKICAgICAgICAgICAgIHByb2Nlc3MudmVyc2lvbnMgJiYKICAgICAgICAgICAgICEhcHJvY2Vzcy52ZXJzaW9ucy5ub2RlKSB7CiAgICAgICAgLy9Vc2luZyBzcGVjaWFsIHJlcXVpcmUubm9kZVJlcXVpcmUsIHNvbWV0aGluZyBhZGRlZCBieSByLmpzLgogICAgICAgIGZzID0gcmVxdWlyZS5ub2RlUmVxdWlyZSgnZnMnKTsKCiAgICAgICAgdGV4dC5nZXQgPSBmdW5jdGlvbiAodXJsLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmlsZSA9IGZzLnJlYWRGaWxlU3luYyh1cmwsICd1dGY4Jyk7CiAgICAgICAgICAgIC8vUmVtb3ZlIEJPTSAoQnl0ZSBNYXJrIE9yZGVyKSBmcm9tIHV0ZjggZmlsZXMgaWYgaXQgaXMgdGhlcmUuCiAgICAgICAgICAgIGlmIChmaWxlLmluZGV4T2YoJ1x1RkVGRicpID09PSAwKSB7CiAgICAgICAgICAgICAgICBmaWxlID0gZmlsZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2soZmlsZSk7CiAgICAgICAgfTsKICAgIH0gZWxzZSBpZiAodGV4dC5jcmVhdGVYaHIoKSkgewogICAgICAgIHRleHQuZ2V0ID0gZnVuY3Rpb24gKHVybCwgY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICAgICAgdmFyIHhociA9IHRleHQuY3JlYXRlWGhyKCk7CiAgICAgICAgICAgIHhoci5vcGVuKCdHRVQnLCB1cmwsIHRydWUpOwoKICAgICAgICAgICAgLy9BbGxvdyBvdmVycmlkZXMgc3BlY2lmaWVkIGluIGNvbmZpZwogICAgICAgICAgICBpZiAobWFzdGVyQ29uZmlnLm9uWGhyKSB7CiAgICAgICAgICAgICAgICBtYXN0ZXJDb25maWcub25YaHIoeGhyLCB1cmwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgICAgICAgdmFyIHN0YXR1cywgZXJyOwogICAgICAgICAgICAgICAgLy9EbyBub3QgZXhwbGljaXRseSBoYW5kbGUgZXJyb3JzLCB0aG9zZSBzaG91bGQgYmUKICAgICAgICAgICAgICAgIC8vdmlzaWJsZSB2aWEgY29uc29sZSBvdXRwdXQgaW4gdGhlIGJyb3dzZXIuCiAgICAgICAgICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT09IDQpIHsKICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSB4aHIuc3RhdHVzOwogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPiAzOTkgJiYgc3RhdHVzIDwgNjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vQW4gaHR0cCA0eHggb3IgNXh4IGVycm9yLiBTaWduYWwgYW4gZXJyb3IuCiAgICAgICAgICAgICAgICAgICAgICAgIGVyciA9IG5ldyBFcnJvcih1cmwgKyAnIEhUVFAgc3RhdHVzOiAnICsgc3RhdHVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyLnhociA9IHhocjsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyYmFjayhlcnIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHhoci5yZXNwb25zZVRleHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgeGhyLnNlbmQobnVsbCk7CiAgICAgICAgfTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIFBhY2thZ2VzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIC8vV2h5IEphdmEsIHdoeSBpcyB0aGlzIHNvIGF3a3dhcmQ/CiAgICAgICAgdGV4dC5nZXQgPSBmdW5jdGlvbiAodXJsLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZW5jb2RpbmcgPSAidXRmLTgiLAogICAgICAgICAgICAgICAgZmlsZSA9IG5ldyBqYXZhLmlvLkZpbGUodXJsKSwKICAgICAgICAgICAgICAgIGxpbmVTZXBhcmF0b3IgPSBqYXZhLmxhbmcuU3lzdGVtLmdldFByb3BlcnR5KCJsaW5lLnNlcGFyYXRvciIpLAogICAgICAgICAgICAgICAgaW5wdXQgPSBuZXcgamF2YS5pby5CdWZmZXJlZFJlYWRlcihuZXcgamF2YS5pby5JbnB1dFN0cmVhbVJlYWRlcihuZXcgamF2YS5pby5GaWxlSW5wdXRTdHJlYW0oZmlsZSksIGVuY29kaW5nKSksCiAgICAgICAgICAgICAgICBzdHJpbmdCdWZmZXIsIGxpbmUsCiAgICAgICAgICAgICAgICBjb250ZW50ID0gJyc7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBzdHJpbmdCdWZmZXIgPSBuZXcgamF2YS5sYW5nLlN0cmluZ0J1ZmZlcigpOwogICAgICAgICAgICAgICAgbGluZSA9IGlucHV0LnJlYWRMaW5lKCk7CgogICAgICAgICAgICAgICAgLy8gQnl0ZSBPcmRlciBNYXJrIChCT00pIC0gVGhlIFVuaWNvZGUgU3RhbmRhcmQsIHZlcnNpb24gMy4wLCBwYWdlIDMyNAogICAgICAgICAgICAgICAgLy8gaHR0cDovL3d3dy51bmljb2RlLm9yZy9mYXEvdXRmX2JvbS5odG1sCgogICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHdoZW4gd2UgdXNlIHV0Zi04LCB0aGUgQk9NIHNob3VsZCBhcHBlYXIgYXMgIkVGIEJCIEJGIiwgYnV0IGl0IGRvZXNuJ3QgZHVlIHRvIHRoaXMgYnVnIGluIHRoZSBKREs6CiAgICAgICAgICAgICAgICAvLyBodHRwOi8vYnVncy5zdW4uY29tL2J1Z2RhdGFiYXNlL3ZpZXdfYnVnLmRvP2J1Z19pZD00NTA4MDU4CiAgICAgICAgICAgICAgICBpZiAobGluZSAmJiBsaW5lLmxlbmd0aCgpICYmIGxpbmUuY2hhckF0KDApID09PSAweGZlZmYpIHsKICAgICAgICAgICAgICAgICAgICAvLyBFYXQgdGhlIEJPTSwgc2luY2Ugd2UndmUgYWxyZWFkeSBmb3VuZCB0aGUgZW5jb2Rpbmcgb24gdGhpcyBmaWxlLAogICAgICAgICAgICAgICAgICAgIC8vIGFuZCB3ZSBwbGFuIHRvIGNvbmNhdGVuYXRpbmcgdGhpcyBidWZmZXIgd2l0aCBvdGhlcnM7IHRoZSBCT00gc2hvdWxkCiAgICAgICAgICAgICAgICAgICAgLy8gb25seSBhcHBlYXIgYXQgdGhlIHRvcCBvZiBhIGZpbGUuCiAgICAgICAgICAgICAgICAgICAgbGluZSA9IGxpbmUuc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHN0cmluZ0J1ZmZlci5hcHBlbmQobGluZSk7CgogICAgICAgICAgICAgICAgd2hpbGUgKChsaW5lID0gaW5wdXQucmVhZExpbmUoKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzdHJpbmdCdWZmZXIuYXBwZW5kKGxpbmVTZXBhcmF0b3IpOwogICAgICAgICAgICAgICAgICAgIHN0cmluZ0J1ZmZlci5hcHBlbmQobGluZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvL01ha2Ugc3VyZSB3ZSByZXR1cm4gYSBKYXZhU2NyaXB0IHN0cmluZyBhbmQgbm90IGEgSmF2YSBzdHJpbmcuCiAgICAgICAgICAgICAgICBjb250ZW50ID0gU3RyaW5nKHN0cmluZ0J1ZmZlci50b1N0cmluZygpKTsgLy9TdHJpbmcKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlucHV0LmNsb3NlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2soY29udGVudCk7CiAgICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gdGV4dDsKfSk7CgovKioKICogQGxpY2Vuc2UgUmVxdWlyZUpTIGkxOG4gMi4wLjEgQ29weXJpZ2h0IChjKSAyMDEwLTIwMTIsIFRoZSBEb2pvIEZvdW5kYXRpb24gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICogQXZhaWxhYmxlIHZpYSB0aGUgTUlUIG9yIG5ldyBCU0QgbGljZW5zZS4KICogc2VlOiBodHRwOi8vZ2l0aHViLmNvbS9yZXF1aXJlanMvaTE4biBmb3IgZGV0YWlscwogKi8KLypqc2xpbnQgcmVnZXhwOiB0cnVlICovCi8qZ2xvYmFsIHJlcXVpcmU6IGZhbHNlLCBuYXZpZ2F0b3I6IGZhbHNlLCBkZWZpbmU6IGZhbHNlICovCgovKioKICogVGhpcyBwbHVnaW4gaGFuZGxlcyBpMThuISBwcmVmaXhlZCBtb2R1bGVzLiBJdCBkb2VzIHRoZSBmb2xsb3dpbmc6CiAqCiAqIDEpIEEgcmVndWxhciBtb2R1bGUgY2FuIGhhdmUgYSBkZXBlbmRlbmN5IG9uIGFuIGkxOG4gYnVuZGxlLCBidXQgdGhlIHJlZ3VsYXIKICogbW9kdWxlIGRvZXMgbm90IHdhbnQgdG8gc3BlY2lmeSB3aGF0IGxvY2FsZSB0byBsb2FkLiBTbyBpdCBqdXN0IHNwZWNpZmllcwogKiB0aGUgdG9wLWxldmVsIGJ1bmRsZSwgbGlrZSAiaTE4biFubHMvY29sb3JzIi4KICoKICogVGhpcyBwbHVnaW4gd2lsbCBsb2FkIHRoZSBpMThuIGJ1bmRsZSBhdCBubHMvY29sb3JzLCBzZWUgdGhhdCBpdCBpcyBhIHJvb3QvbWFzdGVyCiAqIGJ1bmRsZSBzaW5jZSBpdCBkb2VzIG5vdCBoYXZlIGEgbG9jYWxlIGluIGl0cyBuYW1lLiBJdCB3aWxsIHRoZW4gdHJ5IHRvIGZpbmQKICogdGhlIGJlc3QgbWF0Y2ggbG9jYWxlIGF2YWlsYWJsZSBpbiB0aGF0IG1hc3RlciBidW5kbGUsIHRoZW4gcmVxdWVzdCBhbGwgdGhlCiAqIGxvY2FsZSBwaWVjZXMgZm9yIHRoYXQgYmVzdCBtYXRjaCBsb2NhbGUuIEZvciBpbnN0YW5jZSwgaWYgdGhlIGxvY2FsZSBpcyAiZW4tdXMiLAogKiB0aGVuIHRoZSBwbHVnaW4gd2lsbCBhc2sgZm9yIHRoZSAiZW4tdXMiLCAiZW4iIGFuZCAicm9vdCIgYnVuZGxlcyB0byBiZSBsb2FkZWQKICogKGJ1dCBvbmx5IGlmIHRoZXkgYXJlIHNwZWNpZmllZCBvbiB0aGUgbWFzdGVyIGJ1bmRsZSkuCiAqCiAqIE9uY2UgYWxsIHRoZSBidW5kbGVzIGZvciB0aGUgbG9jYWxlIHBpZWNlcyBsb2FkLCB0aGVuIGl0IG1peGVzIGluIGFsbCB0aG9zZQogKiBsb2NhbGUgcGllY2VzIGludG8gZWFjaCBvdGhlciwgdGhlbiBmaW5hbGx5IHNldHMgdGhlIGNvbnRleHQuZGVmaW5lZCB2YWx1ZQogKiBmb3IgdGhlIG5scy9jb2xvcnMgYnVuZGxlIHRvIGJlIHRoYXQgbWl4ZWQgaW4gbG9jYWxlLgogKgogKiAyKSBBIHJlZ3VsYXIgbW9kdWxlIHNwZWNpZmllcyBhIHNwZWNpZmljIGxvY2FsZSB0byBsb2FkLiBGb3IgaW5zdGFuY2UsCiAqIGkxOG4hbmxzL2ZyLWZyL2NvbG9ycy4gSW4gdGhpcyBjYXNlLCB0aGUgcGx1Z2luIG5lZWRzIHRvIGxvYWQgdGhlIG1hc3RlciBidW5kbGUKICogZmlyc3QsIGF0IG5scy9jb2xvcnMsIHRoZW4gZmlndXJlIG91dCB3aGF0IHRoZSBiZXN0IG1hdGNoIGxvY2FsZSBpcyBmb3IgZnItZnIsCiAqIHNpbmNlIG1heWJlIG9ubHkgZnIgb3IganVzdCByb290IGlzIGRlZmluZWQgZm9yIHRoYXQgbG9jYWxlLiBPbmNlIHRoYXQgYmVzdAogKiBmaXQgaXMgZm91bmQsIGFsbCBvZiBpdHMgbG9jYWxlIHBpZWNlcyBuZWVkIHRvIGhhdmUgdGhlaXIgYnVuZGxlcyBsb2FkZWQuCiAqCiAqIE9uY2UgYWxsIHRoZSBidW5kbGVzIGZvciB0aGUgbG9jYWxlIHBpZWNlcyBsb2FkLCB0aGVuIGl0IG1peGVzIGluIGFsbCB0aG9zZQogKiBsb2NhbGUgcGllY2VzIGludG8gZWFjaCBvdGhlciwgdGhlbiBmaW5hbGx5IHNldHMgdGhlIGNvbnRleHQuZGVmaW5lZCB2YWx1ZQogKiBmb3IgdGhlIG5scy9mci1mci9jb2xvcnMgYnVuZGxlIHRvIGJlIHRoYXQgbWl4ZWQgaW4gbG9jYWxlLgogKi8KKGZ1bmN0aW9uICgpIHsKICAgIAoKICAgIC8vcmVnZXhwIGZvciByZWNvbnN0cnVjdGluZyB0aGUgbWFzdGVyIGJ1bmRsZSBuYW1lIGZyb20gcGFydHMgb2YgdGhlIHJlZ2V4cCBtYXRjaAogICAgLy9ubHNSZWdFeHAuZXhlYygiZm9vL2Jhci9iYXovbmxzL2VuLWNhL2ZvbyIpIGdpdmVzOgogICAgLy9bImZvby9iYXIvYmF6L25scy9lbi1jYS9mb28iLCAiZm9vL2Jhci9iYXovbmxzLyIsICIvIiwgIi8iLCAiZW4tY2EiLCAiZm9vIl0KICAgIC8vbmxzUmVnRXhwLmV4ZWMoImZvby9iYXIvYmF6L25scy9mb28iKSBnaXZlczoKICAgIC8vWyJmb28vYmFyL2Jhei9ubHMvZm9vIiwgImZvby9iYXIvYmF6L25scy8iLCAiLyIsICIvIiwgImZvbyIsICIiXQogICAgLy9zbywgaWYgbWF0Y2hbNV0gaXMgYmxhbmssIGl0IG1lYW5zIHRoaXMgaXMgdGhlIHRvcCBidW5kbGUgZGVmaW5pdGlvbi4KICAgIHZhciBubHNSZWdFeHAgPSAvKF4uKihefFwvKW5scyhcL3wkKSkoW15cL10qKVwvPyhbXlwvXSopLzsKCiAgICAvL0hlbHBlciBmdW5jdGlvbiB0byBhdm9pZCByZXBlYXRpbmcgY29kZS4gTG90cyBvZiBhcmd1bWVudHMgaW4gdGhlCiAgICAvL2Rlc2lyZSB0byBzdGF5IGZ1bmN0aW9uYWwgYW5kIHN1cHBvcnQgUmVxdWlyZUpTIGNvbnRleHRzIHdpdGhvdXQgaGF2aW5nCiAgICAvL3RvIGtub3cgYWJvdXQgdGhlIFJlcXVpcmVKUyBjb250ZXh0cy4KICAgIGZ1bmN0aW9uIGFkZFBhcnQobG9jYWxlLCBtYXN0ZXIsIG5lZWRlZCwgdG9Mb2FkLCBwcmVmaXgsIHN1ZmZpeCkgewogICAgICAgIGlmIChtYXN0ZXJbbG9jYWxlXSkgewogICAgICAgICAgICBuZWVkZWQucHVzaChsb2NhbGUpOwogICAgICAgICAgICBpZiAobWFzdGVyW2xvY2FsZV0gPT09IHRydWUgfHwgbWFzdGVyW2xvY2FsZV0gPT09IDEpIHsKICAgICAgICAgICAgICAgIHRvTG9hZC5wdXNoKHByZWZpeCArIGxvY2FsZSArICcvJyArIHN1ZmZpeCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gYWRkSWZFeGlzdHMocmVxLCBsb2NhbGUsIHRvTG9hZCwgcHJlZml4LCBzdWZmaXgpIHsKICAgICAgICB2YXIgZnVsbE5hbWUgPSBwcmVmaXggKyBsb2NhbGUgKyAnLycgKyBzdWZmaXg7CiAgICAgICAgaWYgKHJlcXVpcmUuX2ZpbGVFeGlzdHMocmVxLnRvVXJsKGZ1bGxOYW1lKSkpIHsKICAgICAgICAgICAgdG9Mb2FkLnB1c2goZnVsbE5hbWUpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNpbXBsZSBmdW5jdGlvbiB0byBtaXggaW4gcHJvcGVydGllcyBmcm9tIHNvdXJjZSBpbnRvIHRhcmdldCwKICAgICAqIGJ1dCBvbmx5IGlmIHRhcmdldCBkb2VzIG5vdCBhbHJlYWR5IGhhdmUgYSBwcm9wZXJ0eSBvZiB0aGUgc2FtZSBuYW1lLgogICAgICogVGhpcyBpcyBub3Qgcm9idXN0IGluIElFIGZvciB0cmFuc2ZlcnJpbmcgbWV0aG9kcyB0aGF0IG1hdGNoCiAgICAgKiBPYmplY3QucHJvdG90eXBlIG5hbWVzLCBidXQgdGhlIHVzZXMgb2YgbWl4aW4gaGVyZSBzZWVtIHVubGlrZWx5IHRvCiAgICAgKiB0cmlnZ2VyIGEgcHJvYmxlbSByZWxhdGVkIHRvIHRoYXQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1peGluKHRhcmdldCwgc291cmNlLCBmb3JjZSkgewogICAgICAgIHZhciBwcm9wOwogICAgICAgIGZvciAocHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSAmJiAoIXRhcmdldC5oYXNPd25Qcm9wZXJ0eShwcm9wKSB8fCBmb3JjZSkpIHsKICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc291cmNlW3Byb3BdID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgbWl4aW4odGFyZ2V0W3Byb3BdLCBzb3VyY2VbcHJvcF0sIGZvcmNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBkZWZpbmUoJ2kxOG4nLFsnbW9kdWxlJ10sIGZ1bmN0aW9uIChtb2R1bGUpIHsKICAgICAgICB2YXIgbWFzdGVyQ29uZmlnID0gbW9kdWxlLmNvbmZpZygpOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB2ZXJzaW9uOiAnMi4wLjEnLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQ2FsbGVkIHdoZW4gYSBkZXBlbmRlbmN5IG5lZWRzIHRvIGJlIGxvYWRlZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGxvYWQ6IGZ1bmN0aW9uIChuYW1lLCByZXEsIG9uTG9hZCwgY29uZmlnKSB7CiAgICAgICAgICAgICAgICBjb25maWcgPSBjb25maWcgfHwge307CgogICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5sb2NhbGUpIHsKICAgICAgICAgICAgICAgICAgICBtYXN0ZXJDb25maWcubG9jYWxlID0gY29uZmlnLmxvY2FsZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgbWFzdGVyTmFtZSwKICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IG5sc1JlZ0V4cC5leGVjKG5hbWUpLAogICAgICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoWzFdLAogICAgICAgICAgICAgICAgICAgIGxvY2FsZSA9IG1hdGNoWzRdLAogICAgICAgICAgICAgICAgICAgIHN1ZmZpeCA9IG1hdGNoWzVdLAogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbG9jYWxlLnNwbGl0KCItIiksCiAgICAgICAgICAgICAgICAgICAgdG9Mb2FkID0gW10sCiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB7fSwKICAgICAgICAgICAgICAgICAgICBpLCBwYXJ0LCBjdXJyZW50ID0gIiI7CgogICAgICAgICAgICAgICAgLy9JZiBtYXRjaFs1XSBpcyBibGFuaywgaXQgbWVhbnMgdGhpcyBpcyB0aGUgdG9wIGJ1bmRsZSBkZWZpbml0aW9uLAogICAgICAgICAgICAgICAgLy9zbyBpdCBkb2VzIG5vdCBoYXZlIHRvIGJlIGhhbmRsZWQuIExvY2FsZS1zcGVjaWZpYyByZXF1ZXN0cwogICAgICAgICAgICAgICAgLy93aWxsIGhhdmUgYSBtYXRjaFs0XSB2YWx1ZSBidXQgbm8gbWF0Y2hbNV0KICAgICAgICAgICAgICAgIGlmIChtYXRjaFs1XSkgewogICAgICAgICAgICAgICAgICAgIC8vbG9jYWxlLXNwZWNpZmljIGJ1bmRsZQogICAgICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoWzFdOwogICAgICAgICAgICAgICAgICAgIG1hc3Rlck5hbWUgPSBwcmVmaXggKyBzdWZmaXg7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vVG9wLWxldmVsIGJ1bmRsZS4KICAgICAgICAgICAgICAgICAgICBtYXN0ZXJOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSBtYXRjaFs0XTsKICAgICAgICAgICAgICAgICAgICBsb2NhbGUgPSBtYXN0ZXJDb25maWcubG9jYWxlOwogICAgICAgICAgICAgICAgICAgIGlmICghbG9jYWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsZSA9IG1hc3RlckNvbmZpZy5sb2NhbGUgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZW9mIG5hdmlnYXRvciA9PT0gInVuZGVmaW5lZCIgPyAicm9vdCIgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5hdmlnYXRvci5sYW5ndWFnZSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hdmlnYXRvci51c2VyTGFuZ3VhZ2UgfHwgInJvb3QiKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxvY2FsZS5zcGxpdCgiLSIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChjb25maWcuaXNCdWlsZCkgewogICAgICAgICAgICAgICAgICAgIC8vQ2hlY2sgZm9yIGV4aXN0ZW5jZSBvZiBhbGwgbG9jYWxlIHBvc3NpYmxlIGZpbGVzIGFuZAogICAgICAgICAgICAgICAgICAgIC8vcmVxdWlyZSB0aGVtIGlmIGV4aXN0LgogICAgICAgICAgICAgICAgICAgIHRvTG9hZC5wdXNoKG1hc3Rlck5hbWUpOwogICAgICAgICAgICAgICAgICAgIGFkZElmRXhpc3RzKHJlcSwgInJvb3QiLCB0b0xvYWQsIHByZWZpeCwgc3VmZml4KTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ICs9IChjdXJyZW50ID8gIi0iIDogIiIpICsgcGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkSWZFeGlzdHMocmVxLCBjdXJyZW50LCB0b0xvYWQsIHByZWZpeCwgc3VmZml4KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJlcSh0b0xvYWQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb25Mb2FkKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vRmlyc3QsIGZldGNoIHRoZSBtYXN0ZXIgYnVuZGxlLCBpdCBrbm93cyB3aGF0IGxvY2FsZXMgYXJlIGF2YWlsYWJsZS4KICAgICAgICAgICAgICAgICAgICByZXEoW21hc3Rlck5hbWVdLCBmdW5jdGlvbiAobWFzdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vRmlndXJlIG91dCB0aGUgYmVzdCBmaXQKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5lZWRlZCA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vQWx3YXlzIGFsbG93IGZvciByb290LCB0aGVuIGRvIHRoZSByZXN0IG9mIHRoZSBsb2NhbGUgcGFydHMuCiAgICAgICAgICAgICAgICAgICAgICAgIGFkZFBhcnQoInJvb3QiLCBtYXN0ZXIsIG5lZWRlZCwgdG9Mb2FkLCBwcmVmaXgsIHN1ZmZpeCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAoY3VycmVudCA/ICItIiA6ICIiKSArIHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRQYXJ0KGN1cnJlbnQsIG1hc3RlciwgbmVlZGVkLCB0b0xvYWQsIHByZWZpeCwgc3VmZml4KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy9Mb2FkIGFsbCB0aGUgcGFydHMgbWlzc2luZy4KICAgICAgICAgICAgICAgICAgICAgICAgcmVxKHRvTG9hZCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGksIHBhcnRCdW5kbGUsIHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSBuZWVkZWQubGVuZ3RoIC0gMTsgaSA+IC0xICYmIG5lZWRlZFtpXTsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IG5lZWRlZFtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0QnVuZGxlID0gbWFzdGVyW3BhcnRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0QnVuZGxlID09PSB0cnVlIHx8IHBhcnRCdW5kbGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydEJ1bmRsZSA9IHJlcShwcmVmaXggKyBwYXJ0ICsgJy8nICsgc3VmZml4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWl4aW4odmFsdWUsIHBhcnRCdW5kbGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vQWxsIGRvbmUsIG5vdGlmeSB0aGUgbG9hZGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25Mb2FkKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSk7Cn0oKSk7CgovLyBkb1QuanMKLy8gMjAxMSwgTGF1cmEgRG9rdG9yb3ZhLCBodHRwczovL2dpdGh1Yi5jb20vb2xhZG8vZG9UCi8vCi8vIGRvVC5qcyBpcyBhbiBvcGVuIHNvdXJjZSBjb21wb25lbnQgb2YgaHR0cDovL2JlYmVkby5jb20KLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLwooZnVuY3Rpb24oKSB7CgkKCgl2YXIgZG9UID0gewoJCXZlcnNpb246ICcwLjIuMCcsCgkJdGVtcGxhdGVTZXR0aW5nczogewoJCQlldmFsdWF0ZTogICAgL1x7XHsoW1xzXFNdKz8pXH1cfS9nLAoJCQlpbnRlcnBvbGF0ZTogL1x7XHs9KFtcc1xTXSs/KVx9XH0vZywKCQkJZW5jb2RlOiAgICAgIC9ce1x7IShbXHNcU10rPylcfVx9L2csCgkJCXVzZTogICAgICAgICAvXHtceyMoW1xzXFNdKz8pXH1cfS9nLAoJCQlkZWZpbmU6ICAgICAgL1x7XHsjI1xzKihbXHdcLiRdKylccyooXDp8PSkoW1xzXFNdKz8pI1x9XH0vZywKCQkJY29uZGl0aW9uYWw6IC9ce1x7XD8oXD8pP1xzKihbXHNcU10qPylccypcfVx9L2csCgkJCWl0ZXJhdGU6ICAgICAvXHtce35ccyooPzpcfVx9fChbXHNcU10rPylccypcOlxzKihbXHckXSspXHMqKD86XDpccyooW1x3JF0rKSk/XHMqXH1cfSkvZywKCQkJdmFybmFtZTogJ2l0JywKCQkJc3RyaXA6IHRydWUsCgkJCWFwcGVuZDogdHJ1ZSwKCQkJc2VsZmNvbnRhaW5lZDogZmFsc2UKCQl9LAoJCXRlbXBsYXRlOiB1bmRlZmluZWQsIC8vZm4sIGNvbXBpbGUgdGVtcGxhdGUKCQljb21waWxlOiAgdW5kZWZpbmVkICAvL2ZuLCBmb3IgZXhwcmVzcwoJfTsKCgl2YXIgZ2xvYmFsID0gKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzIHx8ICgwLGV2YWwpKCd0aGlzJyk7IH0oKSk7CgoJaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CgkJbW9kdWxlLmV4cG9ydHMgPSBkb1Q7Cgl9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewoJCWRlZmluZSgnZG9UJyxbXSxmdW5jdGlvbigpe3JldHVybiBkb1Q7fSk7Cgl9IGVsc2UgewoJCWdsb2JhbC5kb1QgPSBkb1Q7Cgl9CgoJZnVuY3Rpb24gZW5jb2RlSFRNTFNvdXJjZSgpIHsKCQl2YXIgZW5jb2RlSFRNTFJ1bGVzID0geyAiJiI6ICImIzM4OyIsICI8IjogIiYjNjA7IiwgIj4iOiAiJiM2MjsiLCAnIic6ICcmIzM0OycsICInIjogJyYjMzk7JywgIi8iOiAnJiM0NzsnIH0sCgkJCW1hdGNoSFRNTCA9IC8mKD8hIz9cdys7KXw8fD58InwnfFwvL2c7CgkJcmV0dXJuIGZ1bmN0aW9uKGNvZGUpIHsKCQkJcmV0dXJuIGNvZGUgPyBjb2RlLnRvU3RyaW5nKCkucmVwbGFjZShtYXRjaEhUTUwsIGZ1bmN0aW9uKG0pIHtyZXR1cm4gZW5jb2RlSFRNTFJ1bGVzW21dIHx8IG07fSkgOiBjb2RlOwoJCX07Cgl9CglnbG9iYWwuZW5jb2RlSFRNTCA9IGVuY29kZUhUTUxTb3VyY2UoKTsKCgl2YXIgc3RhcnRlbmQgPSB7CgkJYXBwZW5kOiB7IHN0YXJ0OiAiJysoIiwgICAgICBlbmQ6ICIpKyciLCAgICAgIHN0YXJ0ZW5jb2RlOiAiJytlbmNvZGVIVE1MKCIgfSwKCQlzcGxpdDogIHsgc3RhcnQ6ICInO291dCs9KCIsIGVuZDogIik7b3V0Kz0nIiwgc3RhcnRlbmNvZGU6ICInO291dCs9ZW5jb2RlSFRNTCgifQoJfSwgc2tpcCA9IC8kXi87CgoJZnVuY3Rpb24gcmVzb2x2ZURlZnMoYywgYmxvY2ssIGRlZikgewoJCXJldHVybiAoKHR5cGVvZiBibG9jayA9PT0gJ3N0cmluZycpID8gYmxvY2sgOiBibG9jay50b1N0cmluZygpKQoJCS5yZXBsYWNlKGMuZGVmaW5lIHx8IHNraXAsIGZ1bmN0aW9uKG0sIGNvZGUsIGFzc2lnbiwgdmFsdWUpIHsKCQkJaWYgKGNvZGUuaW5kZXhPZignZGVmLicpID09PSAwKSB7CgkJCQljb2RlID0gY29kZS5zdWJzdHJpbmcoNCk7CgkJCX0KCQkJaWYgKCEoY29kZSBpbiBkZWYpKSB7CgkJCQlpZiAoYXNzaWduID09PSAnOicpIHsKCQkJCQlkZWZbY29kZV09IHZhbHVlOwoJCQkJfSBlbHNlIHsKCQkJCQlldmFsKCJkZWZbJyIrY29kZSsiJ109IiArIHZhbHVlKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gJyc7CgkJfSkKCQkucmVwbGFjZShjLnVzZSB8fCBza2lwLCBmdW5jdGlvbihtLCBjb2RlKSB7CgkJCXZhciB2ID0gZXZhbChjb2RlKTsKCQkJcmV0dXJuIHYgPyByZXNvbHZlRGVmcyhjLCB2LCBkZWYpIDogdjsKCQl9KTsKCX0KCglmdW5jdGlvbiB1bmVzY2FwZShjb2RlKSB7CgkJcmV0dXJuIGNvZGUucmVwbGFjZSgvXFwoJ3xcXCkvZywgIiQxIikucmVwbGFjZSgvW1xyXHRcbl0vZywgJyAnKTsKCX0KCglkb1QudGVtcGxhdGUgPSBmdW5jdGlvbih0bXBsLCBjLCBkZWYpIHsKCQljID0gYyB8fCBkb1QudGVtcGxhdGVTZXR0aW5nczsKCQl2YXIgY3NlID0gYy5hcHBlbmQgPyBzdGFydGVuZC5hcHBlbmQgOiBzdGFydGVuZC5zcGxpdCwgc3RyLCBuZWVkaHRtbGVuY29kZSwgc2lkPTAsIGluZHY7CgoJCWlmIChjLnVzZSB8fCBjLmRlZmluZSkgewoJCQl2YXIgb2xkZGVmID0gZ2xvYmFsLmRlZjsgZ2xvYmFsLmRlZiA9IGRlZiB8fCB7fTsgLy8gd29ya2Fyb3VuZCBtaW5pZmllcnMKCQkJc3RyID0gcmVzb2x2ZURlZnMoYywgdG1wbCwgZ2xvYmFsLmRlZik7CgkJCWdsb2JhbC5kZWYgPSBvbGRkZWY7CgkJfSBlbHNlIHN0ciA9IHRtcGw7CgoJCXN0ciA9ICgidmFyIG91dD0nIiArIChjLnN0cmlwID8gc3RyLnJlcGxhY2UoLyhefFxyfFxuKVx0KiArfCArXHQqKFxyfFxufCQpL2csJyAnKQoJCQkJCS5yZXBsYWNlKC9ccnxcbnxcdHxcL1wqW1xzXFNdKj9cKlwvL2csJycpOiBzdHIpCgkJCS5yZXBsYWNlKC8nfFxcL2csICdcXCQmJykKCQkJLnJlcGxhY2UoYy5pbnRlcnBvbGF0ZSB8fCBza2lwLCBmdW5jdGlvbihtLCBjb2RlKSB7CgkJCQlyZXR1cm4gY3NlLnN0YXJ0ICsgdW5lc2NhcGUoY29kZSkgKyBjc2UuZW5kOwoJCQl9KQoJCQkucmVwbGFjZShjLmVuY29kZSB8fCBza2lwLCBmdW5jdGlvbihtLCBjb2RlKSB7CgkJCQluZWVkaHRtbGVuY29kZSA9IHRydWU7CgkJCQlyZXR1cm4gY3NlLnN0YXJ0ZW5jb2RlICsgdW5lc2NhcGUoY29kZSkgKyBjc2UuZW5kOwoJCQl9KQoJCQkucmVwbGFjZShjLmNvbmRpdGlvbmFsIHx8IHNraXAsIGZ1bmN0aW9uKG0sIGVsc2VjYXNlLCBjb2RlKSB7CgkJCQlyZXR1cm4gZWxzZWNhc2UgPwoJCQkJCShjb2RlID8gIic7fWVsc2UgaWYoIiArIHVuZXNjYXBlKGNvZGUpICsgIil7b3V0Kz0nIiA6ICInO31lbHNle291dCs9JyIpIDoKCQkJCQkoY29kZSA/ICInO2lmKCIgKyB1bmVzY2FwZShjb2RlKSArICIpe291dCs9JyIgOiAiJzt9b3V0Kz0nIik7CgkJCX0pCgkJCS5yZXBsYWNlKGMuaXRlcmF0ZSB8fCBza2lwLCBmdW5jdGlvbihtLCBpdGVyYXRlLCB2bmFtZSwgaW5hbWUpIHsKCQkJCWlmICghaXRlcmF0ZSkgcmV0dXJuICInO30gfSBvdXQrPSciOwoJCQkJc2lkKz0xOyBpbmR2PWluYW1lIHx8ICJpIitzaWQ7IGl0ZXJhdGU9dW5lc2NhcGUoaXRlcmF0ZSk7CgkJCQlyZXR1cm4gIic7dmFyIGFyciIrc2lkKyI9IitpdGVyYXRlKyI7aWYoYXJyIitzaWQrIil7dmFyICIrdm5hbWUrIiwiK2luZHYrIj0tMSxsIitzaWQrIj1hcnIiK3NpZCsiLmxlbmd0aC0xO3doaWxlKCIraW5kdisiPGwiK3NpZCsiKXsiCgkJCQkJK3ZuYW1lKyI9YXJyIitzaWQrIlsiK2luZHYrIis9MV07b3V0Kz0nIjsKCQkJfSkKCQkJLnJlcGxhY2UoYy5ldmFsdWF0ZSB8fCBza2lwLCBmdW5jdGlvbihtLCBjb2RlKSB7CgkJCQlyZXR1cm4gIic7IiArIHVuZXNjYXBlKGNvZGUpICsgIm91dCs9JyI7CgkJCX0pCgkJCSsgIic7cmV0dXJuIG91dDsiKQoJCQkucmVwbGFjZSgvXG4vZywgJ1xcbicpLnJlcGxhY2UoL1x0L2csICdcXHQnKS5yZXBsYWNlKC9cci9nLCAnXFxyJykKCQkJLnJlcGxhY2UoLyhcc3w7fH18Xnx7KW91dFwrPScnOy9nLCAnJDEnKS5yZXBsYWNlKC9cKycnL2csICcnKQoJCQkucmVwbGFjZSgvKFxzfDt8fXxefHspb3V0XCs9JydcKy9nLCckMW91dCs9Jyk7CgoJCWlmIChuZWVkaHRtbGVuY29kZSAmJiBjLnNlbGZjb250YWluZWQpIHsKCQkJc3RyID0gInZhciBlbmNvZGVIVE1MPSgiICsgZW5jb2RlSFRNTFNvdXJjZS50b1N0cmluZygpICsgIigpKTsiICsgc3RyOwoJCX0KCQl0cnkgewoJCQlyZXR1cm4gbmV3IEZ1bmN0aW9uKGMudmFybmFtZSwgc3RyKTsKCQl9IGNhdGNoIChlKSB7CgkJCWlmICh0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGUubG9nKCJDb3VsZCBub3QgY3JlYXRlIGEgdGVtcGxhdGUgZnVuY3Rpb246ICIgKyBzdHIpOwoJCQl0aHJvdyBlOwoJCX0KCX07CgoJZG9ULmNvbXBpbGUgPSBmdW5jdGlvbih0bXBsLCBkZWYpIHsKCQlyZXR1cm4gZG9ULnRlbXBsYXRlKHRtcGwsIG51bGwsIGRlZik7Cgl9Owp9KCkpOwoKLyohCiAqIERhdmlzIC0gaHR0cDovL2RhdmlzanMuY29tIC0gSmF2YVNjcmlwdCBSb3V0aW5nIC0gMC45LjIKICogQ29weXJpZ2h0IChDKSAyMDExIE9saXZlciBOaWdodGluZ2FsZQogKiBNSVQgTGljZW5zZWQKICovCjsKLyoqCiAqIENvbnZpbmllbmNlIG1ldGhvZCBmb3IgaW5zdGFudGlhdGluZyBhIG5ldyBEYXZpcyBhcHAgYW5kIGNvbmZpZ3VyaW5nIGl0IHRvIHVzZSB0aGUgcGFzc2VkCiAqIHJvdXRlcyBhbmQgc3Vic2NyaXB0aW9ucy4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnIEEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIHJ1biB3aXRoIGEgbmV3bHkgY3JlYXRlZCBEYXZpcy5BcHAgYXMgaXRzIGNvbnRleHQsCiAqIHNob3VsZCBiZSB1c2VkIHRvIHNldCB1cCBhcHAgcm91dGVzLCBzdWJzY3JpcHRpb25zIGFuZCBzZXR0aW5ncyBldGMuCiAqIEBuYW1lc3BhY2UKICogQHJldHVybnMge0RhdmlzLkFwcH0KICovCkRhdmlzID0gZnVuY3Rpb24gKGNvbmZpZykgewogIHZhciBhcHAgPSBuZXcgRGF2aXMuQXBwCiAgY29uZmlnICYmIGNvbmZpZy5jYWxsKGFwcCkKICBEYXZpcy4kKGZ1bmN0aW9uICgpIHsgYXBwLnN0YXJ0KCkgfSkKICByZXR1cm4gYXBwCn07CgovKioKICogU3RvcmVzIHRoZSBET00gbGlicmFyeSB0aGF0IERhdmlzIHdpbGwgdXNlLiAgQ2FuIGJlIG92ZXJyaWRlbiB0byB1c2UgbGlicmFyaWVzIG90aGVyIHRoYW4galF1ZXJ5LgogKi8KaWYgKHdpbmRvdy5qUXVlcnkpIHsKICBEYXZpcy4kID0galF1ZXJ5Cn0gZWxzZSB7CiAgRGF2aXMuJCA9IG51bGwKfTsKCi8qKgogKiBDaGVja3Mgd2hldGhlciBEYXZpcyBpcyBzdXBwb3J0ZWQgaW4gdGhlIGN1cnJlbnQgYnJvd3NlcgogKgogKiBAcmV0dXJucyB7Qm9vbGVhbn0KICovCkRhdmlzLnN1cHBvcnRlZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gKHR5cGVvZiB3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUgPT0gJ2Z1bmN0aW9uJykKfQoKLyohCiAqIEEgZnVuY3Rpb24gdGhhdCBkb2VzIG5vdGhpbmcsIHVzZWQgYXMgYSBkZWZhdWx0IHBhcmFtIGZvciBhbnkgY2FsbGJhY2tzLgogKiAKICogQHByaXZhdGUKICogQHJldHVybnMge0Z1bmN0aW9ufQogKi8KRGF2aXMubm9vcCA9IGZ1bmN0aW9uICgpIHt9CgovKioKICogTWV0aG9kIHRvIGV4dGVuZCB0aGUgRGF2aXMgbGlicmFyeSB3aXRoIGFuIGV4dGVuc2lvbi4KICoKICogQW4gZXh0ZW5zaW9uIGlzIGp1c3QgYSBmdW5jdGlvbiB0aGF0IHdpbGwgbW9kaWZ5IHRoZSBEYXZpcyBmcmFtZXdvcmsgaW4gc29tZSB3YXksCiAqIGZvciBleGFtcGxlIGNoYW5naW5nIGhvdyB0aGUgcm91dGluZyB3b3JrcyBvciBhZGp1c3Rpbmcgd2hlcmUgRGF2aXMgdGhpbmtzIGl0IGlzIHN1cHBvcnRlZC4KICoKICogRXhhbXBsZToKICogICAgIERhdmlzLmV4dGVuZChEYXZpcy5oYXNoQmFzZWRSb3V0aW5nKQogKgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBleHRlbnNpb24gdGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBleHRlbmQgRGF2aXMKICoKICovCkRhdmlzLmV4dGVuZCA9IGZ1bmN0aW9uIChleHRlbnNpb24pIHsKICBleHRlbnNpb24oRGF2aXMpCn0KCi8qIQogKiB0aGUgdmVyc2lvbgogKi8KRGF2aXMudmVyc2lvbiA9ICIwLjkuMiI7LyohCiAqIERhdmlzIC0gdXRpbHMKICogQ29weXJpZ2h0IChDKSAyMDExIE9saXZlciBOaWdodGluZ2FsZQogKiBNSVQgTGljZW5zZWQKICovCgovKiEKICogQSBtb2R1bGUgdGhhdCBwcm92aWRlcyB3cmFwcGVycyBhcm91bmQgbW9kZXJuIEphdmFTY3JpcHQgc28gdGhhdCBuYXRpdmUgaW1wbGVtZW50YXRpb25zIGFyZSB1c2VkCiAqIHdoZXJlZXZlciBwb3NzaWJsZSBhbmQgSmF2YVNjcmlwdCBpbXBsZW1lbnRhdGlvbnMgYXJlIHVzZWQgaW4gdGhvc2UgYnJvd3NlcnMgdGhhdCBkbyBub3QgbmF0aXZlbHkKICogc3VwcG9ydCB0aGVtLgogKi8KRGF2aXMudXRpbHMgPSAoZnVuY3Rpb24gKCkgewoKICAvKiEKICAgKiBBIHdyYXBwZXIgYXJvdW5kIG5hdGl2ZSBBcnJheS5wcm90b3R5cGUuZXZlcnkuCiAgICoKICAgKiBGYWxscyBiYWNrIHRvIGEgcHVyZSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIGluIGJyb3dzZXJzIHRoYXQgZG8gbm90IHN1cHBvcnQgQXJyYXkucHJvdG90eXBlLmV2ZXJ5LgogICAqIEZvciBtb3JlIGRldGFpbHMgc2VlIHRoZSBmdWxsIGRvY3Mgb24gTURDIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L2V2ZXJ5CiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7YXJyYXl9IHRoZSBhcnJheSB0byBsb29wIHRocm91Z2gKICAgKiBAcGFyYW0ge2ZufSB0aGUgZnVuY3Rpb24gdG8gdGhhdCBwZXJmb3JtcyB0aGUgZXZlcnkgY2hlY2sKICAgKiBAcGFyYW0ge3RoaXNwfSBhbiBvcHRpb25hbCBwYXJhbSB0aGF0IHdpbGwgYmUgc2V0IGFzIGZuJ3MgdGhpcyB2YWx1ZQogICAqIEByZXR1cm5zIHtBcnJheX0KICAgKi8KICBpZiAoQXJyYXkucHJvdG90eXBlLmV2ZXJ5KSB7CiAgICB2YXIgZXZlcnkgPSBmdW5jdGlvbiAoYXJyYXksIGZuKSB7CiAgICAgIHJldHVybiBhcnJheS5ldmVyeShmbiwgYXJndW1lbnRzWzJdKQogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgZXZlcnkgPSBmdW5jdGlvbiAoYXJyYXksIGZuKSB7CiAgICAgIGlmIChhcnJheSA9PT0gdm9pZCAwIHx8IGFycmF5ID09PSBudWxsKSB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICAgIHZhciB0ID0gT2JqZWN0KGFycmF5KTsKICAgICAgdmFyIGxlbiA9IHQubGVuZ3RoID4+PiAwOwogICAgICBpZiAodHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iKSB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CgogICAgICB2YXIgdGhpc3AgPSBhcmd1bWVudHNbMl07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoaSBpbiB0ICYmICFmbi5jYWxsKHRoaXNwLCB0W2ldLCBpLCB0KSkgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9OwoKICAvKiEKICAgKiBBIHdyYXBwZXIgYXJvdW5kIG5hdGl2ZSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC4KICAgKgogICAqIEZhbGxzIGJhY2sgdG8gYSBwdXJlIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24gaW4gYnJvd3NlcnMgdGhhdCBkbyBub3Qgc3VwcG9ydCBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC4KICAgKiBGb3IgbW9yZSBkZXRhaWxzIHNlZSB0aGUgZnVsbCBkb2NzIG9uIE1EQyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9BcnJheS9mb3JFYWNoCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7YXJyYXl9IHRoZSBhcnJheSB0byBsb29wIHRocm91Z2gKICAgKiBAcGFyYW0ge2ZufSB0aGUgZnVuY3Rpb24gdG8gYXBwbHkgdG8gZXZlcnkgZWxlbWVudCBvZiB0aGUgYXJyYXkKICAgKiBAcGFyYW0ge3RoaXNwfSBhbiBvcHRpb25hbCBwYXJhbSB0aGF0IHdpbGwgYmUgc2V0IGFzIGZuJ3MgdGhpcyB2YWx1ZQogICAqIEByZXR1cm5zIHtBcnJheX0KICAgKi8KICBpZiAoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpIHsKICAgIHZhciBmb3JFYWNoID0gZnVuY3Rpb24gKGFycmF5LCBmbikgewogICAgICByZXR1cm4gYXJyYXkuZm9yRWFjaChmbiwgYXJndW1lbnRzWzJdKQogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgZm9yRWFjaCA9IGZ1bmN0aW9uIChhcnJheSwgZm4pIHsKICAgICAgaWYgKGFycmF5ID09PSB2b2lkIDAgfHwgYXJyYXkgPT09IG51bGwpIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKICAgICAgdmFyIHQgPSBPYmplY3QoYXJyYXkpOwogICAgICB2YXIgbGVuID0gdC5sZW5ndGggPj4+IDA7CiAgICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKICAgICAgCgogICAgICB2YXIgdGhpc3AgPSBhcmd1bWVudHNbMl07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoaSBpbiB0KSBmbi5jYWxsKHRoaXNwLCB0W2ldLCBpLCB0KTsKICAgICAgfQogICAgfTsKICB9OwoKICAvKiEKICAgKiBBIHdyYXBwZXIgYXJvdW5kIG5hdGl2ZSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLgogICAqIEZhbGxzIGJhY2sgdG8gYSBwdXJlIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24gaW4gYnJvd3NlcnMgdGhhdCBkbyBub3Qgc3VwcG9ydCBBcnJheS5wcm90b3R5cGUuZmlsdGVyLgogICAqIEZvciBtb3JlIGRldGFpbHMgc2VlIHRoZSBmdWxsIGRvY3Mgb24gTURDIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L2ZpbHRlcgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge2FycmF5fSB0aGUgYXJyYXkgdG8gZmlsdGVyCiAgICogQHBhcmFtIHtmbn0gdGhlIGZ1bmN0aW9uIHRvIGRvIHRoZSBmaWx0ZXJpbmcKICAgKiBAcGFyYW0ge3RoaXNwfSBhbiBvcHRpb25hbCBwYXJhbSB0aGF0IHdpbGwgYmUgc2V0IGFzIGZuJ3MgdGhpcyB2YWx1ZQogICAqIEByZXR1cm5zIHtBcnJheX0KICAgKi8KICBpZiAoQXJyYXkucHJvdG90eXBlLmZpbHRlcikgewogICAgdmFyIGZpbHRlciA9IGZ1bmN0aW9uIChhcnJheSwgZm4pIHsKICAgICAgcmV0dXJuIGFycmF5LmZpbHRlcihmbiwgYXJndW1lbnRzWzJdKQogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgZmlsdGVyID0gZnVuY3Rpb24oYXJyYXksIGZuKSB7CiAgICAgIGlmIChhcnJheSA9PT0gdm9pZCAwIHx8IGFycmF5ID09PSBudWxsKSB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICAgIHZhciB0ID0gT2JqZWN0KGFycmF5KTsKICAgICAgdmFyIGxlbiA9IHQubGVuZ3RoID4+PiAwOwogICAgICBpZiAodHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iKSB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICAgIAoKICAgICAgdmFyIHJlcyA9IFtdOwogICAgICB2YXIgdGhpc3AgPSBhcmd1bWVudHNbMl07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoaSBpbiB0KSB7CiAgICAgICAgICB2YXIgdmFsID0gdFtpXTsgLy8gaW4gY2FzZSBmbiBtdXRhdGVzIHRoaXMKICAgICAgICAgIGlmIChmbi5jYWxsKHRoaXNwLCB2YWwsIGksIHQpKSByZXMucHVzaCh2YWwpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJlczsKICAgIH07CiAgfTsKCiAgLyohCiAgICogQSB3cmFwcGVyIGFyb3VuZCBuYXRpdmUgQXJyYXkucHJvdG90eXBlLm1hcC4KICAgKiBGYWxscyBiYWNrIHRvIGEgcHVyZSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIGluIGJyb3dzZXJzIHRoYXQgZG8gbm90IHN1cHBvcnQgQXJyYXkucHJvdG90eXBlLm1hcC4KICAgKiBGb3IgbW9yZSBkZXRhaWxzIHNlZSB0aGUgZnVsbCBkb2NzIG9uIE1EQyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9BcnJheS9tYXAKICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHthcnJheX0gdGhlIGFycmF5IHRvIG1hcAogICAqIEBwYXJhbSB7Zm59IHRoZSBmdW5jdGlvbiB0byBkbyB0aGUgbWFwcGluZwogICAqIEBwYXJhbSB7dGhpc3B9IGFuIG9wdGlvbmFsIHBhcmFtIHRoYXQgd2lsbCBiZSBzZXQgYXMgZm4ncyB0aGlzIHZhbHVlCiAgICogQHJldHVybnMge0FycmF5fQogICAqLwoKICBpZiAoQXJyYXkucHJvdG90eXBlLm1hcCkgewogICAgdmFyIG1hcCA9IGZ1bmN0aW9uIChhcnJheSwgZm4pIHsKICAgICAgcmV0dXJuIGFycmF5Lm1hcChmbiwgYXJndW1lbnRzWzJdKQogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgbWFwID0gZnVuY3Rpb24oYXJyYXksIGZuKSB7CiAgICAgIGlmIChhcnJheSA9PT0gdm9pZCAwIHx8IGFycmF5ID09PSBudWxsKQogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKCiAgICAgIHZhciB0ID0gT2JqZWN0KGFycmF5KTsKICAgICAgdmFyIGxlbiA9IHQubGVuZ3RoID4+PiAwOwogICAgICBpZiAodHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iKQogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKCiAgICAgIHZhciByZXMgPSBuZXcgQXJyYXkobGVuKTsKICAgICAgdmFyIHRoaXNwID0gYXJndW1lbnRzWzJdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKGkgaW4gdCkKICAgICAgICAgIHJlc1tpXSA9IGZuLmNhbGwodGhpc3AsIHRbaV0sIGksIHQpOwogICAgICB9CgogICAgICByZXR1cm4gcmVzOwogICAgfTsKICB9OwoKICAvKiEKICAgKiBBIGNvbnZpbmllbmNlIGZ1bmN0aW9uIGZvciBjb252ZXJ0aW5nIGFyZ3VtZW50cyB0byBhIHByb3BlciBhcnJheQogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge2FyZ3N9IGEgZnVuY3Rpb25zIGFyZ3VtZW50cwogICAqIEBwYXJhbSB7c3RhcnR9IGFuIGludGVnZXIgYXQgd2hpY2ggdG8gc3RhcnQgY29udmVydGluZyB0aGUgYXJndW1lbnRzIHRvIGFuIGFycmF5CiAgICogQHJldHVybnMge0FycmF5fQogICAqLwogIHZhciB0b0FycmF5ID0gZnVuY3Rpb24gKGFyZ3MsIHN0YXJ0KSB7CiAgICB2YXIgc3RhcnQgPSBzdGFydCB8fCAwCiAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJncywgc3RhcnQpCiAgfQoKICAvKiEKICAgKiBFeHBvc2luZyB0aGUgcHVibGljIGludGVyZmFjZSB0byB0aGUgVXRpbHMgbW9kdWxlCiAgICogQHByaXZhdGUKICAgKi8KICByZXR1cm4gewogICAgZXZlcnk6IGV2ZXJ5LAogICAgZm9yRWFjaDogZm9yRWFjaCwKICAgIGZpbHRlcjogZmlsdGVyLAogICAgdG9BcnJheTogdG9BcnJheSwKICAgIG1hcDogbWFwCiAgfQp9KSgpCgovKiEKICogRGF2aXMgLSBsaXN0ZW5lcgogKiBDb3B5cmlnaHQgKEMpIDIwMTEgT2xpdmVyIE5pZ2h0aW5nYWxlCiAqIE1JVCBMaWNlbnNlZAogKi8KCi8qKgogKiBBIG1vZHVsZSB0byBiaW5kIHRvIGxpbmsgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pdHMgYW5kIHR1cm4gd2hhdCB3b3VsZCBub3JtYWxseSBiZSBodHRwIHJlcXVlc3RzCiAqIGludG8gaW5zdGFuY2VzIG9mIERhdmlzLlJlcXVlc3QuICBUaGVzZSByZXF1ZXN0IG9iamVjdHMgYXJlIHRoZW4gcHVzaGVkIG9udG8gdGhlIGhpc3Rvcnkgc3RhY2sKICogdXNpbmcgdGhlIERhdmlzLmhpc3RvcnkgbW9kdWxlLgogKgogKiBUaGlzIG1vZHVsZSB1c2VzIERhdmlzLiQsIHdoaWNoIGJ5IGRlZnVhbHQgaXMgalF1ZXJ5IGZvciBpdHMgZXZlbnQgYmluZGluZyBhbmQgZXZlbnQgb2JqZWN0IG5vcm1hbGl6YXRpb24uCiAqIFRvIHVzZSBEYXZpcyB3aXRoIGFueSwgb3Igbm8sIEphdmFTY3JpcHQgZnJhbWV3b3JrIGJlIHN1cmUgdG8gcHJvdmlkZSBzdXBwb3J0IGZvciBhbGwgdGhlIG1ldGhvZHMgY2FsbGVkCiAqIG9uIERhdmlzLiQuCiAqCiAqIEBtb2R1bGUKICovCkRhdmlzLmxpc3RlbmVyID0gZnVuY3Rpb24gKCkgewoKICAvKiEKICAgKiBNZXRob2RzIHRvIGNoZWNrIHdoZXRoZXIgYW4gZWxlbWVudCBoYXMgYW4gaHJlZiBvciBhY3Rpb24gdGhhdCBpcyBsb2NhbCB0byB0aGlzIHBhZ2UKICAgKiBAcHJpdmF0ZQogICAqLwogIHZhciBvcmlnaW5DaGVja3MgPSB7CiAgICBBOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gZWxlbS5ob3N0ICE9PSB3aW5kb3cubG9jYXRpb24uaG9zdCB8fCBlbGVtLnByb3RvY29sICE9PSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wKICAgIH0sCgogICAgRk9STTogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgdmFyIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJykKICAgICAgYS5ocmVmID0gZWxlbS5hY3Rpb24KICAgICAgcmV0dXJuIHRoaXMuQShhKQogICAgfQogIH0KCiAgLyohCiAgICogQ2hlY2tzIHdoZXRoZXIgdGhlIHRhcmdldCBvZiBhIGNsaWNrIG9yIHN1Ym1pdCBldmVudCBoYXMgYW4gaHJlZiBvciBhY3Rpb24gdGhhdCBpcyBsb2NhbCB0byB0aGUKICAgKiBjdXJyZW50IHBhZ2UuICBPbmx5IGxpbmtzIG9yIHRhcmdldHMgd2l0aCBsb2NhbCBocmVmcyBvciBhY3Rpb25zIHdpbGwgYmUgaGFuZGxlZCBieSBkYXZpcywgYWxsCiAgICogb3RoZXJzIHdpbGwgYmUgaWdub3JlZC4KICAgKiBAcHJpdmF0ZQogICAqLwogIHZhciBkaWZmZXJlbnRPcmlnaW4gPSBmdW5jdGlvbiAoZWxlbSkgewogICAgaWYgKCFvcmlnaW5DaGVja3NbZWxlbS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpXSkgcmV0dXJuIHRydWUgLy8gdGhlIGVsZW0gaXMgbmVpdGhlciBhIGxpbmsgb3IgYSBmb3JtCiAgICByZXR1cm4gb3JpZ2luQ2hlY2tzW2VsZW0ubm9kZU5hbWUudG9VcHBlckNhc2UoKV0oZWxlbSkKICB9CgogIC8qIQogICAqIEEgaGFuZGxlciB0aGF0IGNyZWF0ZXMgYSBuZXcgRGF2aXMuUmVxdWVzdCBhbmQgcHVzaGVzIGl0IG9udG8gdGhlIGhpc3Rvcnkgc3RhY2sgdXNpbmcgRGF2aXMuaGlzdG9yeS4KICAgKiAKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSB0YXJnZXRFeHRyYWN0b3IgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGV2ZW50IHRhcmdldCBqUXVlcnkgb2JqZWN0IGFuZCBzaG91bGQgcmV0dXJuIGFuIG9iamVjdCB3aXRoIHBhdGgsIHRpdGxlIGFuZCBtZXRob2QuCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgaGFuZGxlciA9IGZ1bmN0aW9uICh0YXJnZXRFeHRyYWN0b3IpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgaWYgKGRpZmZlcmVudE9yaWdpbih0aGlzKSkgcmV0dXJuIHRydWUKICAgICAgdmFyIHJlcXVlc3QgPSBuZXcgRGF2aXMuUmVxdWVzdCAodGFyZ2V0RXh0cmFjdG9yLmNhbGwoRGF2aXMuJCh0aGlzKSkpOwogICAgICBEYXZpcy5sb2NhdGlvbi5hc3NpZ24ocmVxdWVzdCkKICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCkKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwogIH07CgogIC8qIQogICAqIEEgaGFuZGxlciBzcGVjaWFsaXplZCBmb3IgY2xpY2sgZXZlbnRzLiAgR2V0cyB0aGUgcmVxdWVzdCBkZXRhaWxzIGZyb20gYSBsaW5rIGVsZW0KICAgKiBAcHJpdmF0ZQogICAqLwogIHZhciBjbGlja0hhbmRsZXIgPSBoYW5kbGVyKGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpcwogICAgcmV0dXJuIHsKICAgICAgbWV0aG9kOiAnZ2V0JywKICAgICAgZnVsbFBhdGg6IHRoaXMuYXR0cignaHJlZicpLAogICAgICB0aXRsZTogdGhpcy5hdHRyKCd0aXRsZScpLAogICAgICBkZWxlZ2F0ZVRvU2VydmVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lID0gc2VsZi5hdHRyKCdocmVmJykKICAgICAgfQogICAgfTsKICB9KTsKCiAgLyohCiAgICogRGVjb2RlcyB0aGUgdXJsLCBpbmNsdWRpbmcgKyBjaGFyYWN0ZXJzLgogICAqIEBwcml2YXRlCiAgICovCiAgdmFyIGRlY29kZVVybCA9IGZ1bmN0aW9uIChzdHIpIHsKICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoc3RyLnJlcGxhY2UoL1wrL2csICclMjAnKSkKICB9OwoKICAvKiEKICAgKiBBIGhhbmRsZXIgc3BlY2lhbGl6ZWQgZm9yIHN1Ym1pdCBldmVudHMuICBHZXRzIHRoZSByZXF1ZXN0IGRldGFpbHMgZnJvbSBhIGZvcm0gZWxlbQogICAqIEBwcml2YXRlCiAgICovCiAgdmFyIHN1Ym1pdEhhbmRsZXIgPSBoYW5kbGVyKGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpcwogICAgcmV0dXJuIHsKICAgICAgbWV0aG9kOiB0aGlzLmF0dHIoJ21ldGhvZCcpLAogICAgICBmdWxsUGF0aDogZGVjb2RlVXJsKHRoaXMuc2VyaWFsaXplKCkgPyBbdGhpcy5hdHRyKCdhY3Rpb24nKSwgdGhpcy5zZXJpYWxpemUoKV0uam9pbigiPyIpIDogdGhpcy5hdHRyKCdhY3Rpb24nKSksCiAgICAgIHRpdGxlOiB0aGlzLmF0dHIoJ3RpdGxlJyksCiAgICAgIGRlbGVnYXRlVG9TZXJ2ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLnN1Ym1pdCgpCiAgICAgIH0KICAgIH07CiAgfSk7CgogIC8qKgogICAqIEJpbmRzIHRvIGJvdGggbGluayBjbGlja3MgYW5kIGZvcm0gc3VibWl0cyB1c2luZyBqUXVlcnkncyBkZWxlYWdhdGUuCiAgICoKICAgKiBXaWxsIGNhdGNoIGFsbCBjdXJyZW50IGFuZCBmdXR1cmUgbGlua3MgYW5kIGZvcm1zLiAgVXNlcyB0aGUgYXBwcyBzZXR0aW5ncyBmb3IgdGhlIHNlbGVjdG9yIHRvIHVzZSBmb3IgbGlua3MgYW5kIGZvcm1zCiAgICogCiAgICogQHNlZSBEYXZpcy5BcHAuc2V0dGluZ3MKICAgKiBAbWVtYmVyT2YgbGlzdGVuZXIKICAgKi8KICB0aGlzLmxpc3RlbiA9IGZ1bmN0aW9uICgpIHsKICAgIERhdmlzLiQoZG9jdW1lbnQpLmRlbGVnYXRlKHRoaXMuc2V0dGluZ3MuZm9ybVNlbGVjdG9yLCAnc3VibWl0Jywgc3VibWl0SGFuZGxlcikKICAgIERhdmlzLiQoZG9jdW1lbnQpLmRlbGVnYXRlKHRoaXMuc2V0dGluZ3MubGlua1NlbGVjdG9yLCAnY2xpY2snLCBjbGlja0hhbmRsZXIpCiAgfQoKICAvKioKICAgKiBVbmJpbmRzIGFsbCBjbGljayBhbmQgc3VibWl0IGhhbmRsZXJzIHRoYXQgd2VyZSBhdHRhdGNoZWQgd2l0aCBsaXN0ZW4uCiAgICoKICAgKiBXaWxsIGVmZWN0aXZsZXkgc3RvcCB0aGUgY3VycmVudCBhcHAgZnJvbSBwcm9jZXNzaW5nIGFueSByZXF1ZXN0cyBhbmQgYWxsIGxpbmtzIGFuZCBmb3JtcyB3aWxsIGhhdmUgdGhlaXIgZGVmYXVsdAogICAqIGJlaGF2aW91ciByZXN0b3JlZC4KICAgKgogICAqIEBzZWUgRGF2aXMuQXBwLnNldHRpbmdzCiAgICogQG1lbWJlck9mIGxpc3RlbmVyCiAgICovCiAgdGhpcy51bmxpc3RlbiA9IGZ1bmN0aW9uICgpIHsKICAgIERhdmlzLiQoZG9jdW1lbnQpLnVuZGVsZWdhdGUodGhpcy5zZXR0aW5ncy5saW5rU2VsZWN0b3IsICdjbGljaycsIGNsaWNrSGFuZGxlcikKICAgIERhdmlzLiQoZG9jdW1lbnQpLnVuZGVsZWdhdGUodGhpcy5zZXR0aW5ncy5mb3JtU2VsZWN0b3IsICdzdWJtaXQnLCBzdWJtaXRIYW5kbGVyKQogIH0KfQovKiEKICogRGF2aXMgLSBldmVudAogKiBDb3B5cmlnaHQgKEMpIDIwMTEgT2xpdmVyIE5pZ2h0aW5nYWxlCiAqIE1JVCBMaWNlbnNlZAogKi8KCiAvKioKICAqIEEgcGx1Z2luIHRoYXQgYWRkcyBiYXNpYyBldmVudCBjYXBhYmlsaXRpZXMgdG8gYSBEYXZpcyBhcHAsIGl0IGlzIGluY2x1ZGVkIGJ5IGRlZmF1bHQuCiAgKgogICogQG1vZHVsZQogICovCkRhdmlzLmV2ZW50ID0gZnVuY3Rpb24gKCkgewoKICAvKiEKICAgKiBjYWxsYmFjayBzdG9yYWdlCiAgICovCiAgdmFyIGNhbGxiYWNrcyA9IHt9CgogIC8qKgogICAqIEJpbmRzIGEgY2FsbGJhY2sgdG8gYSBuYW1lZCBldmVudC4KICAgKgogICAqIFRoZSBmb2xsb3dpbmcgZXZlbnRzIGFyZSB0cmlnZ2VyZWQgaW50ZXJuYWxseSBieSBEYXZpcyBhbmQgY2FuIGJlIGJvdW5kIHRvCiAgICoKICAgKiAgKiBzdGFydCA6IFRyaWdnZXJlZCB3aGVuIHRoZSBhcHBsaWNhdGlvbiBpcyBzdGFydGVkCiAgICogICogbG9va3VwUm91dGUgOiBUcmlnZ2VyZWQgYmVmb3JlIGxvb2tpbmcgdXAgYSByb3V0ZS4gVGhlIHJlcXVlc3QgYmVpbmcgbG9va2VkIHVwIGlzIHBhc3NlZCBhcyBhbiBhcmd1bWVudAogICAqICAqIHJ1blJvdXRlIDogVHJpZ2dlcmVkIGJlZm9yZSBydW5uaW5nIGEgcm91dGUuIFRoZSByZXF1ZXN0IGFuZCByb3V0ZSBiZWluZyBydW4gYXJlIHBhc3NlZCBhcyBhcmd1bWVudHMKICAgKiAgKiByb3V0ZU5vdEZvdW5kIDogVHJpZ2dlcmVkIGlmIG5vIHJvdXRlIGZvciB0aGUgY3VycmVudCByZXF1ZXN0IGNhbiBiZSBmb3VuZC4gVGhlIGN1cnJlbnQgcmVxdWVzdCBpcyBwYXNzZWQgYXMgYW4gYXJ1Z21lbnQKICAgKiAgKiByZXF1ZXN0SGFsdGVkIDogVHJpZ2dlcmVkIHdoZW4gYSBiZWZvcmUgZmlsdGVyIGhhbHRzIHRoZSBjdXJyZW50IHJlcXVlc3QuIFRoZSBjdXJyZW50IHJlcXVlc3QgaXMgcGFzc2VkIGFzIGFuIGFyZ3VtZW50CiAgICogICogdW5zdXBwb3J0ZWQgOiBUcmlnZ2VyZWQgd2hlbiBzdGFydGluZyBhIERhdmlzIGFwcCBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaHRtbDUgcHVzaFN0YXRlCiAgICoKICAgKiBFeGFtcGxlCiAgICoKICAgKiAgICAgYXBwLmJpbmQoJ3J1blJvdXRlJywgZnVuY3Rpb24gKCkgewogICAqICAgICAgIGNvbnNvbGUubG9nKCdhYm91dCB0byBydW4gYSByb3V0ZScpCiAgICogICAgIH0pCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQgZXZlbnQgbmFtZQogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIGNhbGxiYWNrCiAgICogQG1lbWJlck9mIGV2ZW50CiAgICovCiAgdGhpcy5iaW5kID0gZnVuY3Rpb24gKGV2ZW50LCBmbikgewogICAgKGNhbGxiYWNrc1tldmVudF0gPSBjYWxsYmFja3NbZXZlbnRdIHx8IFtdKS5wdXNoKGZuKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIFRyaWdnZXJzIGFuIGV2ZW50IHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudCBldmVudCBuYW1lCiAgICogQHBhcmFtIHtNaXhlZH0gLi4uCiAgICogQG1lbWJlck9mIGV2ZW50CiAgICovCiAgdGhpcy50cmlnZ2VyID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICB2YXIgYXJncyA9IERhdmlzLnV0aWxzLnRvQXJyYXkoYXJndW1lbnRzLCAxKSwKICAgICAgICBoYW5kbGVycyA9IGNhbGxiYWNrc1tldmVudF07CgogICAgaWYgKCFoYW5kbGVycykgcmV0dXJuIHRoaXMKCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaGFuZGxlcnMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgaGFuZGxlcnNbaV0uYXBwbHkodGhpcywgYXJncykKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9Owp9Ci8qIQogKiBEYXZpcyAtIGxvZ2dlcgogKiBDb3B5cmlnaHQgKEMpIDIwMTEgT2xpdmVyIE5pZ2h0aW5nYWxlCiAqIE1JVCBMaWNlbnNlZAogKi8KCi8qKgogKiBBIHBsdWdpbiBmb3IgZW5oYW5jaW5nIHRoZSBzdGFuZGFyZCBsb2dnaW5nIGF2YWlsYWJsZSB0aHJvdWdoIHRoZSBjb25zb2xlIG9iamVjdC4KICogQXV0b21hdGljYWxseSBpbmNsdWRlZCBpbiBhbGwgRGF2aXMgYXBwcy4KICoKICogR2VuZXJhdGVzIGxvZyBtZXNzYWdlcyBvZiB2YXJ5aW5nIHNldmVyaXR5IGluIHRoZSBmb3JtYXQKICoKICogYFtTdW4gSmFuIDIzIDIwMTEgMTY6MTU6MjEgR01UKzAwMDAgKEdNVCldIDxtZXNzYWdlPmAKICoKICogQG1vZHVsZQogKi8KRGF2aXMubG9nZ2VyID0gZnVuY3Rpb24gKCkgewoKICAvKiEKICAgKiBHZW5lcmF0aW5nIHRoZSB0aW1lc3RhbXAgcG9ydGlvbiBvZiB0aGUgbG9nIG1lc3NhZ2UKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHRpbWVzdGFtcCgpewogICAgcmV0dXJuICJbIiArIERhdGUoKSArICJdIjsKICB9CgogIC8qIQogICAqIFB1c2hpbmcgdGhlIHRpbWVzdGFtcCBvbnRvIHRoZSBmcm9udCBvZiB0aGUgYXJndW1lbnRzIHRvIGxvZwogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gcHJlcEFyZ3MoYXJncykgewogICAgdmFyIGEgPSBEYXZpcy51dGlscy50b0FycmF5KGFyZ3MpCiAgICBhLnVuc2hpZnQodGltZXN0YW1wKCkpCiAgICByZXR1cm4gYS5qb2luKCcgJyk7CiAgfQoKICB2YXIgbG9nVHlwZSA9IGZ1bmN0aW9uIChsb2dMZXZlbCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHdpbmRvdy5jb25zb2xlKSBjb25zb2xlW2xvZ0xldmVsXShwcmVwQXJncyhhcmd1bWVudHMpKTsKICAgIH0KICB9CgoKICAvKioKICAgKiBQcmludHMgYW4gZXJyb3IgbWVzc2FnZSB0byB0aGUgY29uc29sZSBpZiB0aGUgY29uc29sZSBpcyBhdmFpbGFibGUuCiAgICoKICAgKiBAcGFyYW1zIHtTdHJpbmd9IEFsbCBhcmd1bWVudHMgYXJlIGNvbWJpbmVkIGFuZCBsb2dnZWQgdG8gdGhlIGNvbnNvbGUuCiAgICogQG1lbWJlck9mIGxvZ2dlcgogICAqLwogICB2YXIgZXJyb3IgPSBsb2dUeXBlKCdlcnJvcicpCgogIC8qKgogICAqIFByaW50cyBhbiBpbmZvIG1lc3NhZ2UgdG8gdGhlIGNvbnNvbGUgaWYgdGhlIGNvbnNvbGUgaXMgYXZhaWxhYmxlLgogICAqCiAgICogQHBhcmFtcyB7U3RyaW5nfSBBbGwgYXJndW1lbnRzIGFyZSBjb21iaW5lZCBhbmQgbG9nZ2VkIHRvIHRoZSBjb25zb2xlLgogICAqIEBtZW1iZXJPZiBsb2dnZXIKICAgKi8KICAgdmFyIGluZm8gPSBsb2dUeXBlKCdpbmZvJykKCiAgLyoqCiAgICogUHJpbnRzIGEgd2FybmluZyBtZXNzYWdlIHRvIHRoZSBjb25zb2xlIGlmIHRoZSBjb25zb2xlIGlzIGF2YWlsYWJsZS4KICAgKgogICAqIEBwYXJhbXMge1N0cmluZ30gQWxsIGFyZ3VtZW50cyBhcmUgY29tYmluZWQgYW5kIGxvZ2dlZCB0byB0aGUgY29uc29sZS4KICAgKiBAbWVtYmVyT2YgbG9nZ2VyCiAgICovCiAgIHZhciB3YXJuID0gbG9nVHlwZSgnd2FybicpCgogIC8qIQogICAqIEV4cG9zZXMgdGhlIHB1YmxpYyBtZXRob2RzIG9mIHRoZSBtb2R1bGUKICAgKiBAcHJpdmF0ZQogICAqLwogIHRoaXMubG9nZ2VyID0gewogICAgZXJyb3I6IGVycm9yLAogICAgaW5mbzogaW5mbywKICAgIHdhcm46IHdhcm4KICB9Cn0vKiEKICogRGF2aXMgLSBSb3V0ZQogKiBDb3B5cmlnaHQgKEMpIDIwMTEgT2xpdmVyIE5pZ2h0aW5nYWxlCiAqIE1JVCBMaWNlbnNlZAogKi8KCkRhdmlzLlJvdXRlID0gKGZ1bmN0aW9uICgpIHsKCiAgdmFyIHBhdGhOYW1lUmVnZXggPSAvOihbXHdcZF0rKS9nOwogIHZhciBwYXRoTmFtZVJlcGxhY2VtZW50ID0gIihbXlwvXSspIjsKCiAgdmFyIHNwbGF0TmFtZVJlZ2V4ID0gL1wqKFtcd1xkXSspL2c7CiAgdmFyIHNwbGF0TmFtZVJlcGxhY2VtZW50ID0gIiguKikiOwoKICB2YXIgbmFtZVJlZ2V4ID0gL1s6fFwqXShbXHdcZF0rKS9nCgovKioKICogRGF2aXMuUm91dGVzIGFyZSB0aGUgbWFpbiBwYXJ0IG9mIGEgRGF2aXMgYXBwbGljYXRpb24uICBUaGV5IGNvbnNpc3Qgb2YgYW4gSFRUUCBtZXRob2QsIGEgcGF0aAogKiBhbmQgYSBjYWxsYmFjayBmdW5jdGlvbi4gIFdoZW4gYSBsaW5rIG9yIGEgZm9ybSB0aGF0IERhdmlzIGhhcyBib3VuZCB0byBhcmUgY2xpY2tlZCBvciBzdWJtaXR0ZWQKICogYSByZXF1ZXN0IGlzIHB1c2hlZCBvbiB0aGUgaGlzdG9yeSBzdGFjayBhbmQgYSByb3V0ZSB0aGF0IG1hdGNoZXMgdGhlIHBhdGggYW5kIG1ldGhvZCBvZiB0aGUKICogZ2VuZXJhdGVkIHJlcXVlc3QgaXMgcnVuLgogKgogKiBUaGUgcGF0aCBmb3IgdGhlIHJvdXRlIGNhbiBjb25zaXN0IG9mIHBsYWNlaG9sZGVycyBmb3IgYXR0cmlidXRlcywgdGhlc2Ugd2lsbCB0aGVuIGJlIGF2YWlsYWJsZQogKiBvbiB0aGUgcmVxdWVzdC4gIFNpbXBsZSB2YXJpYWJsZXMgc2hvdWxkIGJlIHByZWZpeGVkIHdpdGggYSBjb2xhbiwgYW5kIGZvciBzcGxhdCBzdHlsZSBwYXJhbXMgdXNlCiAqIGFuIGFzdGVyaXNrLgogKgogKiBJbnNpZGUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uICd0aGlzJyBpcyBib3VuZCB0byB0aGUgcmVxdWVzdC4KICoKICogRXhhbXBsZToKICoKICogICAgIHZhciByb3V0ZSA9IG5ldyBEYXZpcy5Sb3V0ZSAoJ2dldCcsICcvZm9vLzppZCcsIGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgdmFyIGlkID0gcmVxLnBhcmFtc1snaWQnXQogKiAgICAgICAvLyBkbyBzb21ldGhpbmcgaW50ZXJlc3RpbmchCiAqICAgICB9KQogKgogKiAgICAgdmFyIHJvdXRlID0gbmV3IERhdmlzLlJvdXRlICgnZ2V0JywgJy9mb28vKnNwbGF0JywgZnVuY3Rpb24gKHJlcSkgewogKiAgICAgICB2YXIgaWQgPSByZXEucGFyYW1zWydzcGxhdCddCiAqICAgICAgIC8vIHNwbGF0IHdpbGwgY29udGFpbiBldmVyeXRoaW5nIGFmdGVyIHRoZSAvZm9vLyBpbiB0aGUgcGF0aC4KICogICAgIH0pCiAqCiAqIFlvdSBjYW4gaW5jbHVkZSBhbnkgbnVtYmVyIG9mIHJvdXRlIGxldmVsICdtaWRkbGV3YXJlJyB3aGVuIGRlZmluaW5nIHJvdXRlcy4gIFRoZXNlIG1pZGRsZXdhcmVzIGFyZQogKiBydW4gaW4gb3JkZXIgYW5kIG5lZWQgdG8gZXhwbGljaXRseSBjYWxsIHRoZSBuZXh0IGhhbmRsZXIgaW4gdGhlIHN0YWNrLiAgVXNpbmcgcm91dGUgbWlkZGxld2FyZSBhbGxvd3MKICogeW91IHRvIHNoYXJlIGNvbW1vbiBsb2dpYyBiZXR3ZWVuIHJvdXRlcyBhbmQgaXMgYWxzbyBhIGdvb2QgcGxhY2UgdG8gbG9hZCBhbnkgZGF0YSBvciBkbyBhbnkgYXN5bmMgY2FsbHMKICoga2VlcGluZyB5b3VyIG1haW4gaGFuZGxlciBzaW1wbGUgYW5kIGZvY3VzZWQuCiAqCiAqIEV4YW1wbGU6CiAqCiAqICAgICB2YXIgbG9hZFVzZXIgPSBmdW5jdGlvbiAocmVxLCBuZXh0KSB7CiAqICAgICAgICQuZ2V0KCcvdXNlcnMvY3VycmVudCcsIGZ1bmN0aW9uICh1c2VyKSB7CiAqICAgICAgICAgcmVxLnVzZXIgPSB1c2VyCiAqICAgICAgICAgbmV4dChyZXEpCiAqICAgICAgIH0pCiAqICAgICB9CiAqCiAqICAgICB2YXIgcm91dGUgPSBuZXcgRGF2aXMuUm91dGUgKCdnZXQnLCAnL2Zvby86aWQnLCBsb2FkVXNlciwgZnVuY3Rpb24gKHJlcSkgewogKiAgICAgICByZW5kZXJVc2VyKHJlcS51c2VyKQogKiAgICAgfSkKICoKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgVGhpcyBzaG91bGQgYmUgb25lIG9mIGVpdGhlciAnZ2V0JywgJ3Bvc3QnLCAncHV0JywgJ2RlbGV0ZScsICdiZWZvcmUnLCAnYWZ0ZXInIG9yICdzdGF0ZScKICogQHBhcmFtIHtTdHJpbmd9IHBhdGggVGhpcyBzdHJpbmcgY2FuIGNvbnRhaW4gcGxhY2UgaG9sZGVycyBmb3IgdmFyaWFibGVzLCBlLmcuICcvdXNlci86aWQnIG9yICcvdXNlci8qc3BsYXQnCiAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIE9uZSBvciBtb3JlIGNhbGxiYWNrcyB0aGF0IHdpbGwgYmUgY2FsbGVkIGluIG9yZGVyIHdoZW4gYSByZXF1ZXN0IG1hdGNoaW5nIGJvdGggdGhlIHBhdGggYW5kIG1ldGhvZCBpcyB0cmlnZ2VyZWQuCiAqLwogIHZhciBSb3V0ZSA9IGZ1bmN0aW9uIChtZXRob2QsIHBhdGgsIGhhbmRsZXJzKSB7CiAgICB2YXIgY29udmVydFBhdGhUb1JlZ0V4cCA9IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCEocGF0aCBpbnN0YW5jZW9mIFJlZ0V4cCkpIHsKICAgICAgICB2YXIgc3RyID0gcGF0aAogICAgICAgICAgLnJlcGxhY2UocGF0aE5hbWVSZWdleCwgcGF0aE5hbWVSZXBsYWNlbWVudCkKICAgICAgICAgIC5yZXBsYWNlKHNwbGF0TmFtZVJlZ2V4LCBzcGxhdE5hbWVSZXBsYWNlbWVudCk7CgogICAgICAgIC8vIE1vc3QgYnJvd3NlcnMgd2lsbCByZXNldCB0aGlzIHRvIHplcm8gYWZ0ZXIgYSByZXBsYWNlIGNhbGwuICBJRSB3aWxsCiAgICAgICAgLy8gc2V0IGl0IHRvIHRoZSBpbmRleCBvZiB0aGUgbGFzdCBtYXRjaGVkIGNoYXJhY3Rlci4KICAgICAgICBwYXRoLmxhc3RJbmRleCA9IDA7CgogICAgICAgIHJldHVybiBuZXcgUmVnRXhwKCJeIiArIHN0ciArICIkIiwgImdpIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHBhdGg7CiAgICAgIH07CiAgICB9OwoKICAgIHZhciBjb252ZXJ0TWV0aG9kVG9SZWdFeHAgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghKG1ldGhvZCBpbnN0YW5jZW9mIFJlZ0V4cCkpIHsKICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cCgiXiIgKyBtZXRob2QgKyAiJCIsICJpIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG1ldGhvZAogICAgICB9OwogICAgfQoKICAgIHZhciBjYXB0dXJlUGF0aFBhcmFtTmFtZXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBuYW1lcyA9IFtdLCBhOwogICAgICB3aGlsZSAoKGEgPSBuYW1lUmVnZXguZXhlYyhwYXRoKSkpIG5hbWVzLnB1c2goYVsxXSk7CiAgICAgIHJldHVybiBuYW1lczsKICAgIH07CgogICAgdGhpcy5wYXJhbU5hbWVzID0gY2FwdHVyZVBhdGhQYXJhbU5hbWVzKCk7CiAgICB0aGlzLnBhdGggPSBjb252ZXJ0UGF0aFRvUmVnRXhwKCk7CiAgICB0aGlzLm1ldGhvZCA9IGNvbnZlcnRNZXRob2RUb1JlZ0V4cCgpOwoKICAgIGlmICh0eXBlb2YgaGFuZGxlcnMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy5oYW5kbGVycyA9IFtoYW5kbGVyc10KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuaGFuZGxlcnMgPSBoYW5kbGVyczsKICAgIH0KICB9CgogIC8qKgogICAqIFRlc3RzIHdoZXRoZXIgb3Igbm90IGEgcm91dGUgbWF0Y2hlcyBhIHBhcnRpY3VsYXIgcmVxdWVzdC4KICAgKgogICAqIEV4YW1wbGU6CiAgICoKICAgKiAgICAgcm91dGUubWF0Y2goJ2dldCcsICcvZm9vLzEyJykKICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgdGhlIG1ldGhvZCB0byBtYXRjaCBhZ2FpbnN0CiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGggdGhlIHBhdGggdG8gbWF0Y2ggYWdhaW5zdAogICAqIEByZXR1cm5zIHtCb29sZWFufQogICAqLwogIFJvdXRlLnByb3RvdHlwZS5tYXRjaCA9IGZ1bmN0aW9uIChtZXRob2QsIHBhdGgpIHsKICAgIHRoaXMucmVzZXQoKTsKICAgIHJldHVybiAodGhpcy5tZXRob2QudGVzdChtZXRob2QpKSAmJiAodGhpcy5wYXRoLnRlc3QocGF0aCkpCiAgfQoKICAvKioKICAgKiBSZXNldHMgdGhlIFJlZ0V4cHMgZm9yIG1ldGhvZCBhbmQgcGF0aAogICAqLwogIFJvdXRlLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMubWV0aG9kLmxhc3RJbmRleCA9IDA7CiAgICB0aGlzLnBhdGgubGFzdEluZGV4ID0gMDsKICB9CgogIC8qKgogICAqIFJ1bnMgdGhlIGNhbGxiYWNrIGFzc29jaWF0ZWQgd2l0aCBhIHBhcnRpY3VsYXIgcm91dGUgYWdhaW5zdCB0aGUgcGFzc2VkIHJlcXVlc3QuCiAgICoKICAgKiBBbnkgbmFtZWQgcGFyYW1zIGluIHRoZSByZXF1ZXN0IHBhdGggYXJlIGV4dHJhY3RlZCwgYXMgcGVyIHRoZSByb3V0ZXMgcGF0aCwgYW5kCiAgICogYWRkZWQgb250byB0aGUgcmVxdWVzdHMgcGFyYW1zIG9iamVjdC4KICAgKgogICAqIEV4YW1wbGU6CiAgICoKICAgKiAgICAgcm91dGUucnVuKHJlcXVlc3QpCiAgICoKICAgKiBAcGFyYW1zIHtEYXZpcy5SZXF1ZXN0fSByZXF1ZXN0CiAgICogQHJldHVybnMge09iamVjdH0gd2hhdGV2ZXIgdGhlIHJvdXRlcyBjYWxsYmFjayByZXR1cm5zCiAgICovCiAgUm91dGUucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICB0aGlzLnJlc2V0KCk7CiAgICB2YXIgbWF0Y2hlcyA9IHRoaXMucGF0aC5leGVjKHJlcXVlc3QucGF0aCk7CiAgICBpZiAobWF0Y2hlcykgewogICAgICBtYXRjaGVzLnNoaWZ0KCk7CiAgICAgIGZvciAodmFyIGk9MDsgaSA8IG1hdGNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICByZXF1ZXN0LnBhcmFtc1t0aGlzLnBhcmFtTmFtZXNbaV1dID0gbWF0Y2hlc1tpXTsKICAgICAgfTsKICAgIH07CgogICAgdmFyIGhhbmRsZXJzID0gRGF2aXMudXRpbHMubWFwKHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uIChoYW5kbGVyLCBpKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAocmVxKSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZXIuY2FsbChyZXEsIHJlcSwgaGFuZGxlcnNbaSsxXSkKICAgICAgfQogICAgfSkKCiAgICByZXR1cm4gaGFuZGxlcnNbMF0ocmVxdWVzdCkKICB9CgogIC8qKgogICAqIENvbnZlcnRzIHRoZSByb3V0ZSB0byBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiBpdHNlbGYgYnkgY29tYmluaW5nIHRoZSBtZXRob2QgYW5kIHBhdGgKICAgKiBhdHRyaWJ1dGVzLgogICAqCiAgICogQHJldHVybnMge1N0cmluZ30gc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSByb3V0ZQogICAqLwogIFJvdXRlLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBbdGhpcy5tZXRob2QsIHRoaXMucGF0aF0uam9pbignICcpOwogIH0KCiAgLyohCiAgICogZXhwb3NpbmcgdGhlIGNvbnN0cnVjdG9yCiAgICogQHByaXZhdGUKICAgKi8KICByZXR1cm4gUm91dGU7Cn0pKCkKLyohCiAqIERhdmlzIC0gcm91dGVyCiAqIENvcHlyaWdodCAoQykgMjAxMSBPbGl2ZXIgTmlnaHRpbmdhbGUKICogTUlUIExpY2Vuc2VkCiAqLwoKLyoqCiAqIEEgZGVjb3JhdG9yIHRoYXQgYWRkcyBjb252aW5pZW5jZSBtZXRob2RzIHRvIGEgRGF2aXMuQXBwIGZvciBlYXNpbHkgY3JlYXRpbmcgaW5zdGFuY2VzCiAqIG9mIERhdmlzLlJvdXRlIGFuZCBsb29raW5nIHVwIHJvdXRlcyBmb3IgYSBwYXJ0aWN1bGFyIHJlcXVlc3QuCiAqCiAqIFByb3ZpZGVzIGdldCwgcG9zdCBwdXQgYW5kIGRlbGV0ZSBtZXRob2Qgc2hvcnRjdXRzIGZvciBjcmVhdGluZyBpbnN0YW5jZXMgb2YgRGF2aXMuUm91dGVzCiAqIHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgbWV0aG9kLiAgVGhpcyBhbGxvd3Mgc2ltcGxlIFJFU1Qgc3R5bGVkIHJvdXRpbmcgZm9yIGEgY2xpZW50IHNpZGUKICogSmF2YVNjcmlwdCBhcHBsaWNhdGlvbi4KICoKICogIyMjIEV4YW1wbGUKICoKICogICAgIGFwcC5nZXQoJy9mb28vOmlkJywgZnVuY3Rpb24gKHJlcSkgewogKiAgICAgICAvLyBnZXQgdGhlIGZvbyB3aXRoIGlkID0gcmVxLnBhcmFtc1snaWQnXQogKiAgICAgfSkKICogICAgIAogKiAgICAgYXBwLnBvc3QoJy9mb28nLCBmdW5jdGlvbiAocmVxKSB7CiAqICAgICAgIC8vIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBmb28gd2l0aCByZXEucGFyYW1zCiAqICAgICB9KQogKiAgICAgCiAqICAgICBhcHAucHV0KCcvZm9vLzppZCcsIGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgLy8gdXBkYXRlIHRoZSBpbnN0YW5jZSBvZiBmb28gd2l0aCBpZCA9IHJlcS5wYXJhbXNbJ2lkJ10KICogICAgIH0pCiAqICAgICAKICogICAgIGFwcC5kZWwoJy9mb28vOmlkJywgZnVuY3Rpb24gKHJlcSkgewogKiAgICAgICAvLyBkZWxldGUgdGhlIGluc3RhbmNlIG9mIGZvbyB3aXRoIGlkID0gcmVxLnBhcmFtc1snaWQnXQogKiAgICAgfSkKICoKICogQXMgd2VsbCBhcyBwcm92aWRpbmcgY29udmluaWVuY2UgbWV0aG9kcyBmb3IgY3JlYXRpbmcgaW5zdGFuY2VzIG9mIERhdmlzLlJvdXRlcyB0aGUgcm91dGVyCiAqIGFsc28gcHJvdmlkZXMgbWV0aG9kcyBmb3IgY3JlYXRpbmcgc3BlY2lhbCBpbnN0YW5jZXMgb2Ygcm91dGVzIGNhbGxlZCBmaWx0ZXJzLiAgQmVmb3JlIGZpbHRlcnMKICogcnVuIGJlZm9yZSBhbnkgbWF0Y2hpbmcgcm91dGUgaXMgcnVuLCBhbmQgYWZ0ZXIgZmlsdGVycyBydW4gYWZ0ZXIgYW55IG1hdGNoZWQgcm91dGUgaGFzIHJ1bi4KICogQSBiZWZvcmUgZmlsdGVyIGNhbiByZXR1cm4gZmFsc2UgdG8gaGFsdCB0aGUgcnVubmluZyBvZiBhbnkgbWF0Y2hlZCByb3V0ZXMgb3Igb3RoZXIgYmVmb3JlIGZpbHRlcnMuCiAqCiAqIEEgZmlsdGVyIGNhbiB0YWtlIGFuIG9wdGlvbmFsIHBhdGggdG8gbWF0Y2ggb24sIG9yIHdpdGhvdXQgYSBwYXRoIHdpbGwgbWF0Y2ggZXZlcnkgcmVxdWVzdC4KICoKICogIyMjIEV4YW1wbGUKICoKICogICAgIGFwcC5iZWZvcmUoJy9mb28vOmlkJywgZnVuY3Rpb24gKHJlcSkgewogKiAgICAgICAvLyB3aWxsIG9ubHkgcnVuIGJlZm9yZSByZXF1ZXN0IG1hdGNoaW5nICcvZm9vLzppZCcKICogICAgIH0pCiAqICAgICAKICogICAgIGFwcC5iZWZvcmUoZnVuY3Rpb24gKHJlcSkgewogKiAgICAgICAvLyB3aWxsIHJ1biBiZWZvcmUgYWxsIHJvdXRlcwogKiAgICAgfSkKICogICAgIAogKiAgICAgYXBwLmFmdGVyKCcvZm9vLzppZCcsIGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgLy8gd2lsbCBvbmx5IHJ1biBhZnRlciByb3V0ZXMgbWF0Y2hpbmcgJy9mb28vOmlkJwogKiAgICAgfSkKICogICAgIAogKiAgICAgYXBwLmFmdGVyKGZ1bmN0aW9uIChyZXEpIHsKICogICAgICAgLy8gd2lsbCBydW4gYWZ0ZXIgYWxsIHJvdXRlcwogKiAgICAgfSkKICoKICogQW5vdGhlciBzcGVjaWFsIGtpbmQgb2Ygcm91dGUsIGNhbGxlZCBzdGF0ZSByb3V0ZXMsIGFyZSBhbHNvIGdlbmVyYXRlZCB1c2luZyB0aGUgcm91dGVyLiAgU3RhdGUgcm91dGVzCiAqIGFyZSBmb3IgcmVxdWVzdHMgdGhhdCB3aWxsIG5vdCBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZSBsb2NhdGlvbi4gIEluc3RlYWQgdGhlIHBhZ2UgbG9jYXRpb24gd2lsbCByZW1haW4KICogdGhlIHNhbWUgYnV0IHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLiAgVGhpcyBhbGxvd3MgZm9yIHN0YXRlcyB3aGljaCB0aGUgc2VydmVyIHdpbGwgbm90CiAqIGJlIGV4cGVjdGVkIHRvIGtub3cgYWJvdXQgYW5kIHN1cHBvcnQuCiAqCiAqICMjIyBFeGFtcGxlCiAqCiAqICAgICBhcHAuc3RhdGUoJy9mb28vOmlkJywgZnVuY3Rpb24gKHJlcSkgewogKiAgICAgICAvLyB3aWxsIHJ1biB3aGVuIHRoZSBhcHAgdHJhbnNpdGlvbnMgaW50byB0aGUgJy9mb28vOmlkJyBzdGF0ZS4KICogICAgIH0pCiAqCiAqIFVzaW5nIHRoZSBgdHJhbnNgIG1ldGhvZCBhbiBhcHAgY2FuIHRyYW5zaXRpb24gdG8gdGhlc2Uga2luZCBvZiBzdGF0ZXMgd2l0aG91dCBjaGFuZ2luZyB0aGUgdXJsIGxvY2F0aW9uLgogKgogKiBGb3IgY29udmluaWVuY2Ugcm91dGVzIGNhbiBiZSBkZWZpbmVkIHdpdGhpbiBhIGNvbW1vbiBiYXNlIHNjb3BlLCB0aGlzIGlzIHVzZWZ1bCBmb3Iga2VlcGluZyB5b3VyIHJvdXRlCiAqIGRlZmluaXRpb25zIHNpbXBsZXIgYW5kIERSWWVyLiAgQSBzY29wZSBjYW4gZWl0aGVyIGNvdmVyIHRoZSB3aG9sZSBhcHAsIG9yIGp1c3QgYSBzdWJzZXQgb2YgdGhlIHJvdXRlcy4KICoKICogIyMjIEV4YW1wbGUKICoKICogICAgIGFwcC5zY29wZSgnL2ZvbycsIGZ1bmN0aW9uICgpIHsKICogICAgICAgdGhpcy5nZXQoJy86aWQnLCBmdW5jdGlvbiAoKSB7CiAqICAgICAgICAgLy8gd2lsbCBydW4gZm9yIHJvdXRlcyB0aGF0IG1hdGNoICcvZm9vLzppZCcKICogICAgICAgfSkKICogICAgIH0pCiAqCiAqIEBtb2R1bGUKICovCkRhdmlzLnJvdXRlciA9IGZ1bmN0aW9uICgpIHsKCiAgLyoqCiAgICogTG93IGxldmVsIG1ldGhvZCBmb3IgYWRkaW5nIHJvdXRlcyB0byB5b3VyIGFwcGxpY2F0aW9uLgogICAqCiAgICogSWYgY2FsbGVkIHdpdGgganVzdCBhIG1ldGhvZCB3aWxsIHJldHVybiBhIHBhcnRpYWxseSBhcHBsaWVkIGZ1bmN0aW9uIHRoYXQgY2FuIGNyZWF0ZSByb3V0ZXMgd2l0aAogICAqIHRoYXQgbWV0aG9kLiAgVGhpcyBpcyB1c2VkIGludGVybmFsbHkgdG8gcHJvdmlkZSBzaG9ydGN1dHMgZm9yIGdldCwgcG9zdCwgcHV0LCBkZWxldGUgYW5kIHN0YXRlCiAgICogcm91dGVzLgogICAqCiAgICogWW91IG5vcm1hbGx5IHdhbnQgdG8gdXNlIHRoZSBoaWdoZXIgbGV2ZWwgbWV0aG9kcyBzdWNoIGFzIGdldCBhbmQgcG9zdCwgYnV0IHRoaXMgY2FuIGJlIHVzZWZ1bCBmb3IgZXh0ZW5kaW5nCiAgICogRGF2aXMgdG8gd29yayB3aXRoIG90aGVyIGtpbmRzIG9mIHJlcXVlc3RzLgogICAqCiAgICogRXhhbXBsZToKICAgKgogICAqICAgICBhcHAucm91dGUoJ2dldCcsICcvZm9vJywgZnVuY3Rpb24gKHJlcSkgewogICAqICAgICAgIC8vIHdpbGwgcnVuIHdoZW4gYSBnZXQgcmVxdWVzdCBpcyBtYWRlIHRvICcvZm9vJwogICAqICAgICB9KQogICAqCiAgICogICAgIGFwcC5wYXRjaCA9IGFwcC5yb3V0ZSgncGF0Y2gnKSAvLyB3aWxsIHJldHVybiBhIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHVzZWQgdG8gaGFuZGxlIHJlcXVlc3RzIHdpdGggbWV0aG9kIG9mIHBhdGNoLgogICAqICAgICBhcHAucGF0Y2goJy9iYXInLCBmdW5jdGlvbiAocmVxKSB7CiAgICogICAgICAgLy8gd2lsbCBydW4gd2hlbiBhIHBhdGNoIHJlcXVlc3QgaXMgbWFkZSB0byAnL2JhcicKICAgKiAgICAgfSkKICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgVGhlIG1ldGhvZCBmb3IgdGhpcyByb3V0ZS4KICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgcGF0aCBmb3IgdGhpcyByb3V0ZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBoYW5kbGVyIGZvciB0aGlzIHJvdXRlLCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSByZXF1ZXN0IHRoYXQgdHJpZ2dlcmVkIHRoZSByb3V0ZS4KICAgKiBAcmV0dXJucyB7RGF2aXMuUm91dGV9IHRoZSByb3V0ZSB0aGF0IGhhcyBqdXN0IGJlZW4gY3JlYXRlZCBhbmQgYWRkZWQgdG8gdGhlIHJvdXRlIGxpc3QuCiAgICogQG1lbWJlck9mIHJvdXRlcgogICAqLwogIHRoaXMucm91dGUgPSBmdW5jdGlvbiAobWV0aG9kLCBwYXRoKSB7CiAgICB2YXIgY3JlYXRlUm91dGUgPSBmdW5jdGlvbiAocGF0aCkgewogICAgICB2YXIgaGFuZGxlcnMgPSBEYXZpcy51dGlscy50b0FycmF5KGFyZ3VtZW50cywgMSksCiAgICAgICAgICBzY29wZSA9IHNjb3BlUGF0aHMuam9pbignJyksCiAgICAgICAgICByb3V0ZSA9IG5ldyBEYXZpcy5Sb3V0ZSAobWV0aG9kLCBzY29wZSArIHBhdGgsIGhhbmRsZXJzKQoKICAgICAgcm91dGVDb2xsZWN0aW9uLnB1c2gocm91dGUpCiAgICAgIHJldHVybiByb3V0ZQogICAgfQoKICAgIHJldHVybiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSA/IGNyZWF0ZVJvdXRlIDogY3JlYXRlUm91dGUuYXBwbHkodGhpcywgRGF2aXMudXRpbHMudG9BcnJheShhcmd1bWVudHMsIDEpKQogIH0KCiAgLyoqCiAgICogQSBjb252aW5pZW5jZSB3cmFwcGVyIGFyb3VuZCBgYXBwLnJvdXRlYCBmb3IgY3JlYXRpbmcgZ2V0IHJvdXRlcy4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwYXRoIGZvciB0aGlzIHJvdXRlLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIGhhbmRsZXIgZm9yIHRoaXMgcm91dGUsIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIHJlcXVlc3QgdGhhdCB0cmlnZ2VyZWQgdGhlIHJvdXRlLgogICAqIEByZXR1cm5zIHtEYXZpcy5Sb3V0ZX0gdGhlIHJvdXRlIHRoYXQgaGFzIGp1c3QgYmVlbiBjcmVhdGVkIGFuZCBhZGRlZCB0byB0aGUgcm91dGUgbGlzdC4KICAgKiBAc2VlIERhdmlzLnJvdXRlci5yb3V0ZQogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKi8KICB0aGlzLmdldCAgPSB0aGlzLnJvdXRlKCdnZXQnKQoKICAvKioKICAgKiBBIGNvbnZpbmllbmNlIHdyYXBwZXIgYXJvdW5kIGBhcHAucm91dGVgIGZvciBjcmVhdGluZyBwb3N0IHJvdXRlcy4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwYXRoIGZvciB0aGlzIHJvdXRlLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIGhhbmRsZXIgZm9yIHRoaXMgcm91dGUsIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIHJlcXVlc3QgdGhhdCB0cmlnZ2VyZWQgdGhlIHJvdXRlLgogICAqIEByZXR1cm5zIHtEYXZpcy5Sb3V0ZX0gdGhlIHJvdXRlIHRoYXQgaGFzIGp1c3QgYmVlbiBjcmVhdGVkIGFuZCBhZGRlZCB0byB0aGUgcm91dGUgbGlzdC4KICAgKiBAc2VlIERhdmlzLnJvdXRlci5yb3V0ZQogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKi8KICB0aGlzLnBvc3QgPSB0aGlzLnJvdXRlKCdwb3N0JykKCiAgLyoqCiAgICogQSBjb252aW5pZW5jZSB3cmFwcGVyIGFyb3VuZCBgYXBwLnJvdXRlYCBmb3IgY3JlYXRpbmcgcHV0IHJvdXRlcy4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwYXRoIGZvciB0aGlzIHJvdXRlLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIGhhbmRsZXIgZm9yIHRoaXMgcm91dGUsIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIHJlcXVlc3QgdGhhdCB0cmlnZ2VyZWQgdGhlIHJvdXRlLgogICAqIEByZXR1cm5zIHtEYXZpcy5Sb3V0ZX0gdGhlIHJvdXRlIHRoYXQgaGFzIGp1c3QgYmVlbiBjcmVhdGVkIGFuZCBhZGRlZCB0byB0aGUgcm91dGUgbGlzdC4KICAgKiBAc2VlIERhdmlzLnJvdXRlci5yb3V0ZQogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKi8KICB0aGlzLnB1dCAgPSB0aGlzLnJvdXRlKCdwdXQnKQoKICAvKioKICAgKiBBIGNvbnZpbmllbmNlIHdyYXBwZXIgYXJvdW5kIGBhcHAucm91dGVgIGZvciBjcmVhdGluZyBkZWxldGUgcm91dGVzLgogICAqCiAgICogZGVsZXRlIGlzIGEgcmVzZXJ2ZWQgd29yZCBpbiBqYXZhc2NyaXB0IHNvIHVzZSB0aGUgYGRlbGAgbWV0aG9kIHdoZW4gY3JlYXRpbmcgYSBEYXZpcy5Sb3V0ZSB3aXRoIGEgbWV0aG9kIG9mIGRlbGV0ZS4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwYXRoIGZvciB0aGlzIHJvdXRlLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIGhhbmRsZXIgZm9yIHRoaXMgcm91dGUsIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIHJlcXVlc3QgdGhhdCB0cmlnZ2VyZWQgdGhlIHJvdXRlLgogICAqIEByZXR1cm5zIHtEYXZpcy5Sb3V0ZX0gdGhlIHJvdXRlIHRoYXQgaGFzIGp1c3QgYmVlbiBjcmVhdGVkIGFuZCBhZGRlZCB0byB0aGUgcm91dGUgbGlzdC4KICAgKiBAc2VlIERhdmlzLnJvdXRlci5yb3V0ZQogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKi8KICB0aGlzLmRlbCAgPSB0aGlzLnJvdXRlKCdkZWxldGUnKQoKICAvKioKICAgKiBBZGRzIGEgc3RhdGUgcm91dGUgaW50byB0aGUgYXBwcyByb3V0ZSBjb2xsZWN0aW9uLgogICAqCiAgICogVGhlc2Ugc3BlY2lhbCBraW5kIG9mIHJvdXRlcyBhcmUgbm90IHRyaWdnZXJlZCBieSBjbGlja2luZyBsaW5rcyBvciBzdWJtaXR0aW5nIGZvcm1zLCBpbnN0ZWFkIHRoZXkKICAgKiBhcmUgdHJpZ2dlcmVkIG1hbnVhbGx5IGJ5IGNhbGxpbmcgYHRyYW5zYC4KICAgKgogICAqIFJvdXRlcyBhZGRlZCB1c2luZyB0aGUgc3RhdGUgbWV0aG9kIGFjdCBpbiB0aGUgc2FtZSB3YXkgYXMgb3RoZXIgcm91dGVzIGV4Y2VwdCB0aGF0IHRoZXkgZ2VuZXJhdGUKICAgKiBhIHJvdXRlIHRoYXQgaXMgbGlzdGVuaW5nIGZvciByZXF1ZXN0cyB0aGF0IHdpbGwgbm90IGNoYW5nZSB0aGUgcGFnZSBsb2NhdGlvbi4KICAgKgogICAqIEV4YW1wbGU6CiAgICoKICAgKiAgICAgYXBwLnN0YXRlKCcvZm9vLzppZCcsIGZ1bmN0aW9uIChyZXEpIHsKICAgKiAgICAgICAvLyB3aWxsIHJ1biB3aGVuIHRoZSBhcHAgdHJhbnNpdGlvbnMgaW50byB0aGUgJy9mb28vOmlkJyBzdGF0ZS4KICAgKiAgICAgfSkKICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwYXRoIGZvciB0aGlzIHJvdXRlLCB0aGlzIHdpbGwgbmV2ZXIgYmUgc2VlbiBpbiB0aGUgdXJsIGJhci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBoYW5kbGVyIGZvciB0aGlzIHJvdXRlLCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSByZXF1ZXN0IHRoYXQgdHJpZ2dlcmVkIHRoZSByb3V0ZQogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKgogICAqLwogIHRoaXMuc3RhdGUgPSB0aGlzLnJvdXRlKCdzdGF0ZScpOwoKICAvKioKICAgKiBNb2RpZmllcyB0aGUgc2NvcGUgb2YgdGhlIHJvdXRlci4KICAgKgogICAqIElmIHlvdSBoYXZlIG1hbnkgcm91dGVzIHRoYXQgc2hhcmUgYSBjb21tb24gcGF0aCBwcmVmaXggeW91IGNhbiB1c2Ugc2NvcGUgdG8gcmVkdWNlIHJlcGVhdGluZwogICAqIHRoYXQgcGF0aCBwcmVmaXguCiAgICoKICAgKiBZb3UgY2FuIHVzZSBgc2NvcGVgIGluIHR3byB3YXlzLCBmaXJzdGx5IHlvdSBjYW4gc2V0IHRoZSBzY29wZSBmb3IgdGhlIHdob2xlIGFwcCBieSBjYWxsaW5nIHNjb3BlCiAgICogYmVmb3JlIGRlZmluaW5nIHJvdXRlcy4gIFlvdSBjYW4gYWxzbyBwcm92aWRlIGEgZnVuY3Rpb24gdG8gdGhlIHNjb3BlIG1ldGhvZCwgYW5kIHRoZSBzY29wZSB3aWxsCiAgICogb25seSBhcHBseSB0byB0aG9zZSByb3V0ZXMgZGVmaW5lZCB3aXRoaW4gdGhpcyBmdW5jdGlvbi4gSXQgaXMgIGFsc28gcG9zc2libGUgdG8gbmVzdCBzY29wZXMgd2l0aGluCiAgICogb3RoZXIgc2NvcGVzLgogICAqCiAgICogRXhhbXBsZQogICAqCiAgICogICAgIC8vIHVzaW5nIHNjb3BlIHdpdGggYSBmdW5jdGlvbgogICAqICAgICBhcHAuc2NvcGUoJy9mb28nLCBmdW5jdGlvbiAoKSB7CiAgICogICAgICAgdGhpcy5nZXQoJy9iYXInLCBmdW5jdGlvbiAocmVxKSB7CiAgICogICAgICAgICAvLyB0aGlzIHJvdXRlIHdpbGwgaGF2ZSBhIHBhdGggb2YgJy9mb28vYmFyJwogICAqICAgICAgIH0pCiAgICogICAgIH0pCiAgICoKICAgKiAgICAgLy8gc2V0dGluZyBhIGdsb2JhbCBzY29wZSBmb3IgdGhlIHJlc3Qgb2YgdGhlIGFwcGxpY2F0aW9uCiAgICogICAgIGFwcC5zY29wZSgnL2JhcicpCiAgICoKICAgKiAgICAgLy8gdXNpbmcgc2NvcGUgd2l0aCBhIGZ1bmN0aW9uCiAgICogICAgIGFwcC5zY29wZSgnL2ZvbycsIGZ1bmN0aW9uICgpIHsKICAgKiAgICAgICB0aGlzLnNjb3BlKCcvYmFyJywgZnVuY3Rpb24gKCkgewogICAqICAgICAgICAgdGhpcy5nZXQoJy9iYXonLCBmdW5jdGlvbiAocmVxKSB7CiAgICogICAgICAgICAgIC8vIHRoaXMgcm91dGUgd2lsbCBoYXZlIGEgcGF0aCBvZiAnL2Zvby9iYXIvYmF6JwogICAqICAgICAgICAgfSkKICAgKiAgICAgICB9KQogICAqICAgICB9KQogICAqCiAgICogQG1lbWJlck9mIHJvdXRlcgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwcmVmaXggdG8gdXNlIGFzIHRoZSBzY29wZQogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIEEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIHdpdGggdGhlIHJvdXRlciBhcyBpdHMgY29udGV4dCBhbmQgdGhlIHBhdGgKICAgKiBhcyBhIHByZWZpeAogICAqCiAgICovCiAgdGhpcy5zY29wZSA9IGZ1bmN0aW9uIChwYXRoLCBmbikgewogICAgc2NvcGVQYXRocy5wdXNoKHBhdGgpCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSByZXR1cm4KCiAgICBmbi5jYWxsKHRoaXMsIHRoaXMpCiAgICBzY29wZVBhdGhzLnBvcCgpCiAgfQoKICAvKioKICAgKiBUcmFuc2l0aW9ucyB0aGUgYXBwIGludG8gdGhlIHN0YXRlIGlkZW50aWZpZWQgYnkgdGhlIHBhc3NlZCBwYXRoIHBhcmFtZXRlci4KICAgKgogICAqIFRoaXMgYWxsb3dzIHRoZSBhcHAgdG8gZW50ZXIgc3RhdGVzIHdpdGhvdXQgY2hhbmdpbmcgdGhlIHBhZ2UgcGF0aCB0aHJvdWdoIGEgbGluayBjbGljayBvciBmb3JtIHN1Ym1pdC4gCiAgICogSWYgdGhlcmUgYXJlIGhhbmRsZXJzIHJlZ2lzdGVyZWQgZm9yIHRoaXMgc3RhdGUsIGFkZGVkIGJ5IHRoZSBgc3RhdGVgIG1ldGhvZCwgdGhleSB3aWxsIGJlIHRyaWdnZXJlZC4KICAgKgogICAqIFRoaXMgbWV0aG9kIGdlbmVyYXRlcyBhIHJlcXVlc3Qgd2l0aCBhIG1ldGhvZCBvZiAnc3RhdGUnLCBpbiBhbGwgb3RoZXIgd2F5cyB0aGlzIHJlcXVlc3QgaXMgaWRlbnRpY2FsCiAgICogdG8gdGhvc2UgdGhhdCBhcmUgZ2VuZXJhdGVkIHdoZW4gY2xpY2tpbmcgbGlua3MgZXRjLgogICAqCiAgICogU3RhdGVzIHRyYW5zaXRpb25lZCB0byB1c2luZyB0aGlzIG1ldGhvZCB3aWxsIG5vdCBiZSBhYmxlIHRvIGJlIHJldmlzaXRlZCBkaXJlY3RseSB3aXRoIGEgcGFnZSBsb2FkIGFzCiAgICogdGhlcmUgaXMgbm8gdXJsIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUuCiAgICoKICAgKiBBbiBvcHRpb25hbCBzZWNvbmQgcGFyYW1ldGVyIGNhbiBiZSBwYXNzZWQgd2hpY2ggd2lsbCBiZSBhdmFpbGFibGUgdG8gYW55IGhhbmRsZXJzIGluIHRoZSByZXF1ZXN0cwogICAqIHBhcmFtcyBvYmplY3QuCiAgICoKICAgKiBFeGFtcGxlCiAgICoKICAgKiAgICAgYXBwLnRyYW5zKCcvZm9vLzEnKQogICAqICAgICAKICAgKiAgICAgYXBwLnRyYW5zKCcvZm9vLzEnLCB7CiAgICogICAgICAgImJhciI6ICJiYXoiCiAgICogICAgIH0pCiAgICogICAgIAogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGggVGhlIHBhdGggdGhhdCByZXByZXNlbnRzIHRoaXMgc3RhdGUuICBUaGlzIHdpbGwgbm90IGJlIHNlZW4gaW4gdGhlIHVybCBiYXIuCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgQW55IGFkZGl0aW9uYWwgZGF0YSB0aGF0IHNob3VsZCBiZSBzZW50IHdpdGggdGhlIHJlcXVlc3QgYXMgcGFyYW1zLgogICAqIEBtZW1iZXJPZiByb3V0ZXIKICAgKi8KICB0aGlzLnRyYW5zID0gZnVuY3Rpb24gKHBhdGgsIGRhdGEpIHsKICAgIGlmIChkYXRhKSB7CiAgICAgIHZhciBmdWxsUGF0aCA9IFtwYXRoLCBkZWNvZGVVUklDb21wb25lbnQoRGF2aXMuJC5wYXJhbShkYXRhKSldLmpvaW4oJz8nKQogICAgfSBlbHNlIHsKICAgICAgdmFyIGZ1bGxQYXRoID0gcGF0aAogICAgfTsKCiAgICB2YXIgcmVxID0gbmV3IERhdmlzLlJlcXVlc3QoewogICAgICBtZXRob2Q6ICdzdGF0ZScsCiAgICAgIGZ1bGxQYXRoOiBmdWxsUGF0aCwKICAgICAgdGl0bGU6ICcnCiAgICB9KQoKICAgIERhdmlzLmxvY2F0aW9uLmFzc2lnbihyZXEpCiAgfQoKICAvKiEKICAgKiBHZW5lcmF0aW5nIGNvbnZpbmllbmNlIG1ldGhvZHMgZm9yIGNyZWF0aW5nIGZpbHRlcnMgdXNpbmcgRGF2aXMuUm91dGVzIGFuZCBtZXRob2RzIHRvCiAgICogbG9va3VwIGZpbHRlcnMuCiAgICovCiAgdGhpcy5maWx0ZXIgPSBmdW5jdGlvbiAoZmlsdGVyTmFtZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG1ldGhvZCA9IC8uKy87CgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgdmFyIHBhdGggPSAvLisvOwogICAgICAgIHZhciBoYW5kbGVyID0gYXJndW1lbnRzWzBdOwogICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikgewogICAgICAgIHZhciBwYXRoID0gYXJndW1lbnRzWzBdOwogICAgICAgIHZhciBoYW5kbGVyID0gYXJndW1lbnRzWzFdOwogICAgICB9OwoKICAgICAgdmFyIHJvdXRlID0gbmV3IERhdmlzLlJvdXRlIChtZXRob2QsIHBhdGgsIGhhbmRsZXIpCiAgICAgIGZpbHRlckNvbGxlY3Rpb25bZmlsdGVyTmFtZV0ucHVzaChyb3V0ZSk7CiAgICAgIHJldHVybiByb3V0ZQogICAgfQogIH0KCiAgdGhpcy5sb29rdXBGaWx0ZXIgPSBmdW5jdGlvbiAoZmlsdGVyVHlwZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uIChtZXRob2QsIHBhdGgpIHsKICAgICAgcmV0dXJuIERhdmlzLnV0aWxzLmZpbHRlcihmaWx0ZXJDb2xsZWN0aW9uW2ZpbHRlclR5cGVdLCBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgICByZXR1cm4gcm91dGUubWF0Y2gobWV0aG9kLCBwYXRoKQogICAgICB9KTsKICAgIH0KICB9CgogIC8qKgogICAqIEEgY29udmluaWVuY2Ugd3JhcHBlciBhcm91bmQgYGFwcC5maWx0ZXJgIGZvciBjcmVhdGluZyBiZWZvcmUgZmlsdGVycy4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBvcHRpb25sIHBhdGggZm9yIHRoaXMgZmlsdGVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIGhhbmRsZXIgZm9yIHRoaXMgZmlsdGVyLCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSByZXF1ZXN0IHRoYXQgdHJpZ2dlcmVkIHRoZSByb3V0ZS4KICAgKiBAcmV0dXJucyB7RGF2aXMuUm91dGV9IHRoZSByb3V0ZSB0aGF0IGhhcyBqdXN0IGJlZW4gY3JlYXRlZCBhbmQgYWRkZWQgdG8gdGhlIHJvdXRlIGxpc3QuCiAgICogQG1lbWJlck9mIHJvdXRlcgogICAqLwogIHRoaXMuYmVmb3JlID0gdGhpcy5maWx0ZXIoJ2JlZm9yZScpCgogIC8qKgogICAqIEEgY29udmluaWVuY2Ugd3JhcHBlciBhcm91bmQgYGFwcC5maWx0ZXJgIGZvciBjcmVhdGluZyBhZnRlciBmaWx0ZXJzLgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGggVGhlIG9wdGlvbmwgcGF0aCBmb3IgdGhpcyBmaWx0ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaGFuZGxlciBUaGUgaGFuZGxlciBmb3IgdGhpcyBmaWx0ZXIsIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIHJlcXVlc3QgdGhhdCB0cmlnZ2VyZWQgdGhlIHJvdXRlLgogICAqIEByZXR1cm5zIHtEYXZpcy5Sb3V0ZX0gdGhlIHJvdXRlIHRoYXQgaGFzIGp1c3QgYmVlbiBjcmVhdGVkIGFuZCBhZGRlZCB0byB0aGUgcm91dGUgbGlzdC4KICAgKiBAbWVtYmVyT2Ygcm91dGVyCiAgICovCiAgdGhpcy5hZnRlciA9IHRoaXMuZmlsdGVyKCdhZnRlcicpCgogIC8qKgogICAqIEEgY29udmluaWVuY2Ugd3JhcHBlciBhcm91bmQgYGFwcC5sb29rdXBGaWx0ZXJgIGZvciBsb29raW5nIHVwIGJlZm9yZSBmaWx0ZXJzLgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGggVGhlIG9wdGlvbmwgcGF0aCBmb3IgdGhpcyBmaWx0ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaGFuZGxlciBUaGUgaGFuZGxlciBmb3IgdGhpcyBmaWx0ZXIsIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIHJlcXVlc3QgdGhhdCB0cmlnZ2VyZWQgdGhlIHJvdXRlLgogICAqIEByZXR1cm5zIHtEYXZpcy5Sb3V0ZX0gdGhlIHJvdXRlIHRoYXQgaGFzIGp1c3QgYmVlbiBjcmVhdGVkIGFuZCBhZGRlZCB0byB0aGUgcm91dGUgbGlzdC4KICAgKiBAbWVtYmVyT2Ygcm91dGVyCiAgICovCiAgdGhpcy5sb29rdXBCZWZvcmVGaWx0ZXIgPSB0aGlzLmxvb2t1cEZpbHRlcignYmVmb3JlJykKCiAgLyoqCiAgICogQSBjb252aW5pZW5jZSB3cmFwcGVyIGFyb3VuZCBgYXBwLmxvb2t1cEZpbHRlcmAgZm9yIGxvb2tpbmcgdXAgYWZ0ZXIgZmlsdGVycy4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBvcHRpb25sIHBhdGggZm9yIHRoaXMgZmlsdGVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIGhhbmRsZXIgZm9yIHRoaXMgZmlsdGVyLCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSByZXF1ZXN0IHRoYXQgdHJpZ2dlcmVkIHRoZSByb3V0ZS4KICAgKiBAcmV0dXJucyB7RGF2aXMuUm91dGV9IHRoZSByb3V0ZSB0aGF0IGhhcyBqdXN0IGJlZW4gY3JlYXRlZCBhbmQgYWRkZWQgdG8gdGhlIHJvdXRlIGxpc3QuCiAgICogQG1lbWJlck9mIHJvdXRlcgogICAqLwogIHRoaXMubG9va3VwQWZ0ZXJGaWx0ZXIgID0gdGhpcy5sb29rdXBGaWx0ZXIoJ2FmdGVyJykKCiAgLyohCiAgICogY29sbGVjdGlvbnMgb2Ygcm91dGVzIGFuZCBmaWx0ZXJzCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgcm91dGVDb2xsZWN0aW9uID0gW107CiAgdmFyIGZpbHRlckNvbGxlY3Rpb24gPSB7CiAgICBiZWZvcmU6IFtdLAogICAgYWZ0ZXI6IFtdCiAgfTsKICB2YXIgc2NvcGVQYXRocyA9IFtdCgogIC8qKgogICAqIExvb2tzIGZvciB0aGUgZmlyc3Qgcm91dGUgdGhhdCBtYXRjaGVzIHRoZSBtZXRob2QgYW5kIHBhdGggZnJvbSBhIHJlcXVlc3QuCiAgICogV2lsbCBvbmx5IGZpbmQgYW5kIHJldHVybiB0aGUgZmlyc3QgbWF0Y2hlZCByb3V0ZS4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgdGhlIG1ldGhvZCB0byB1c2Ugd2hlbiBsb29raW5nIHVwIGEgcm91dGUKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCB0aGUgcGF0aCB0byB1c2Ugd2hlbiBsb29raW5nIHVwIGEgcm91dGUKICAgKiBAcmV0dXJucyB7RGF2aXMuUm91dGV9IHJvdXRlCiAgICogQG1lbWJlck9mIHJvdXRlcgogICAqLwogIHRoaXMubG9va3VwUm91dGUgPSBmdW5jdGlvbiAobWV0aG9kLCBwYXRoKSB7CiAgICByZXR1cm4gRGF2aXMudXRpbHMuZmlsdGVyKHJvdXRlQ29sbGVjdGlvbiwgZnVuY3Rpb24gKHJvdXRlKSB7CiAgICAgIHJldHVybiByb3V0ZS5tYXRjaChtZXRob2QsIHBhdGgpCiAgICB9KVswXTsKICB9Owp9Ci8qIQogKiBEYXZpcyAtIGhpc3RvcnkKICogQ29weXJpZ2h0IChDKSAyMDExIE9saXZlciBOaWdodGluZ2FsZQogKiBNSVQgTGljZW5zZWQKICovCgovKioKICogQSBtb2R1bGUgdG8gbm9ybWFsaXplIGFuZCBlbmhhbmNlIHRoZSB3aW5kb3cucHVzaFN0YXRlIG1ldGhvZCBhbmQgd2luZG93Lm9ucG9wc3RhdGUgZXZlbnQuCiAqCiAqIEFkZHMgdGhlIGFiaWxpdHkgdG8gYmluZCB0byB3aGVuZXZlciBhIG5ldyBzdGF0ZSBpcyBwdXNoZWQgb250byB0aGUgaGlzdG9yeSBzdGFjayBhbmQgbm9ybWFsaXplcwogKiBib3RoIG9mIHRoZXNlIGV2ZW50cyBpbnRvIGFuIG9uQ2hhbmdlIGV2ZW50LgogKgogKiBAbW9kdWxlCiAqLwpEYXZpcy5oaXN0b3J5ID0gKGZ1bmN0aW9uICgpIHsKCiAgLyohCiAgICogc3RvcmFnZSBmb3IgdGhlIHB1c2ggc3RhdGUgaGFuZGxlcnMKICAgKiBAcHJpdmF0ZQogICAqLwogIHZhciBwdXNoU3RhdGVIYW5kbGVycyA9IFtdOwoKICAvKiEKICAgKiBrZWVwIHRyYWNrIG9mIHdoZXRoZXIgb3Igbm90IHdlYmtpdCBsaWtlIGJyb3dzZXJzIGhhdmUgZmlyZWQgdGhlaXIgaW5pdGlhbAogICAqIHBhZ2UgbG9hZCBwb3BzdGF0ZQogICAqIEBwcml2YXRlCiAgICovCiAgdmFyIHBvcHBlZCA9IGZhbHNlCgogIC8qIQogICAqIG1ldGhvZCB0byBjaGVjayB3aGV0aGVyIG9yIG5vdCB0aGlzIGlzIHRoZSBmaXJzdCBwb3Agc3RhdGUgZXZlbnQgcmVjZWl2ZWQKICAgKiBAcHJpdmF0ZQogICAqLwogICBmdW5jdGlvbiBoYXNQb3BwZWQgKCkgewogICAgIHJldHVybiAhIXdpbmRvdy5oaXN0b3J5LnN0YXRlIHx8IHBvcHBlZAogICB9CgogIC8qIQogICAqIEFkZCBhIGhhbmRsZXIgdG8gdGhlIHB1c2ggc3RhdGUgZXZlbnQuICBUaGlzIGV2ZW50IGlzIG5vdCBhIG5hdGl2ZSBldmVudCBidXQgaXMgZmlyZWQKICAgKiBldmVyeSB0aW1lIGEgY2FsbCB0byBwdXNoU3RhdGUgaXMgY2FsbGVkLgogICAqIAogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG9uUHVzaFN0YXRlKGhhbmRsZXIpIHsKICAgIHB1c2hTdGF0ZUhhbmRsZXJzLnB1c2goaGFuZGxlcik7CiAgfTsKCiAgLyohCiAgICogU2ltcGxlIHdyYXBwZXIgZm9yIHRoZSBuYXRpdmUgb25wb3BzdGF0ZSBldmVudC4KICAgKgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG9uUG9wU3RhdGUoaGFuZGxlcikgewogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgaGFuZGxlciwgdHJ1ZSk7CiAgfTsKCiAgLyohCiAgICogcmV0dXJucyBhIGhhbmRsZXIgdGhhdCB3cmFwcyB0aGUgbmF0aXZlIGV2ZW50IGdpdmVuIG9ucG9wc3RhdGUuCiAgICogV2hlbiB0aGUgcGFnZSBmaXJzdCBsb2FkcyBvciBnb2luZyBiYWNrIHRvIGEgdGltZSBpbiB0aGUgaGlzdG9yeSB0aGF0IHdhcyBub3QgYWRkZWQKICAgKiBieSBwdXNoU3RhdGUgdGhlIGV2ZW50LnN0YXRlIG9iamVjdCB3aWxsIGJlIG51bGwuICBUaGlzIGdlbmVyYXRlcyBhIHJlcXVlc3QgZm9yIHRoZSBjdXJyZW50CiAgICogbG9jYXRpb24gaW4gdGhvc2UgY2FzZXMKICAgKgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHdyYXBwZWQoaGFuZGxlcikgewogICAgcmV0dXJuIGZ1bmN0aW9uIChldmVudCkgewogICAgICBpZiAoZXZlbnQuc3RhdGUgJiYgZXZlbnQuc3RhdGUuX2RhdmlzKSB7CiAgICAgICAgaGFuZGxlcihuZXcgRGF2aXMuUmVxdWVzdChldmVudC5zdGF0ZS5fZGF2aXMpKQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChoYXNQb3BwZWQoKSkgaGFuZGxlcihEYXZpcy5SZXF1ZXN0LmZvclBhZ2VMb2FkKCkpCiAgICAgIH07CiAgICAgIHBvcHBlZCA9IHRydWUKICAgIH0KICB9CgogIC8qIQogICAqIHByb3ZpZGUgYSB3cmFwcGVyIGZvciBhbnkgZGF0YSB0aGF0IGlzIGdvaW5nIHRvIGJlIHB1c2hlZCBpbnRvIHRoZSBoaXN0b3J5IHN0YWNrLiAgQWxsCiAgICogZGF0YSBpcyB3cmFwcGVkIGluIGEgIl9kYXZpcyIgbmFtZXNwYWNlLgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gd3JhcFN0YXRlRGF0YShkYXRhKSB7CiAgICByZXR1cm4geyJfZGF2aXMiOiBkYXRhfQogIH0KCiAgLyoqCiAgICogQmluZCB0byB0aGUgaGlzdG9yeSBvbiBjaGFuZ2UgZXZlbnQuCiAgICoKICAgKiBUaGlzIGlzIG5vdCBhIG5hdGl2ZSBldmVudCBidXQgaXMgZmlyZWQgYW55IHRpbWUgYSBuZXcgc3RhdGUgaXMgcHVzaGVkIG9udG8gdGhlIGhpc3Rvcnkgc3RhY2ssCiAgICogdGhlIGN1cnJlbnQgaGlzdG9yeSBpcyByZXBsYWNlZCBvciBhIHN0YXRlIGlzIHBvcHBlZCBvZmYgdGhlIGhpc3Rvcnkgc3RhY2suCiAgICogVGhlIGhhbmRsZXIgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2l0aCBhIHJlcXVlc3QgcGFyYW0gd2hpY2ggaXMgYW4gaW5zdGFuY2Ugb2YgRGF2aXMuUmVxdWVzdC4KICAgKgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uIHB1c2ggYW5kIHBvcCBzdGF0ZS4KICAgKiBAc2VlIERhdmlzLlJlcXVlc3QKICAgKiBAbWVtYmVyT2YgaGlzdG9yeQogICAqLwogIGZ1bmN0aW9uIG9uQ2hhbmdlKGhhbmRsZXIpIHsKICAgIG9uUHVzaFN0YXRlKGhhbmRsZXIpOwogICAgb25Qb3BTdGF0ZSh3cmFwcGVkKGhhbmRsZXIpKTsKICB9OwoKICAvKiEKICAgKiByZXR1cm5zIGEgZnVuY3Rpb24gZm9yIG1hbmlwdWxhdGluZyB0aGUgaGlzdG9yeSBzdGF0ZSBhbmQgb3B0aW9uYWxseSBjYWxsaW5nIGFueSBhc3NvY2lhdGVkCiAgICogcHVzaFN0YXRlSGFuZGxlcnMKICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2ROYW1lIHRoZSBuYW1lIG9mIHRoZSBtZXRob2QgdG8gbWFuaXB1bGF0ZSB0aGUgaGlzdG9yeSBzdGF0ZSB3aXRoLgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gY2hhbmdlU3RhdGVXaXRoIChtZXRob2ROYW1lKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKHJlcXVlc3QsIG9wdHMpIHsKICAgICAgaGlzdG9yeVttZXRob2ROYW1lXSh3cmFwU3RhdGVEYXRhKHJlcXVlc3QudG9KU09OKCkpLCByZXF1ZXN0LnRpdGxlLCByZXF1ZXN0LmxvY2F0aW9uKCkpOwogICAgICBpZiAob3B0cyAmJiBvcHRzLnNpbGVudCkgcmV0dXJuCiAgICAgIERhdmlzLnV0aWxzLmZvckVhY2gocHVzaFN0YXRlSGFuZGxlcnMsIGZ1bmN0aW9uIChoYW5kbGVyKSB7CiAgICAgICAgaGFuZGxlcihyZXF1ZXN0KTsKICAgICAgfSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBQdXNoZXMgYSByZXF1ZXN0IG9udG8gdGhlIGhpc3Rvcnkgc3RhY2suCiAgICoKICAgKiBUaGlzIGlzIHVzZWQgaW50ZXJuYWxseSBieSBEYXZpcyB0byBwdXNoIGEgbmV3IHJlcXVlc3QKICAgKiByZXN1bHRpbmcgZnJvbSBlaXRoZXIgYSBmb3JtIHN1Ym1pdCBvciBhIGxpbmsgY2xpY2sgb250byB0aGUgaGlzdG9yeSBzdGFjaywgaXQgd2lsbCBhbHNvIHRyaWdnZXIKICAgKiB0aGUgb25wdXNoc3RhdGUgZXZlbnQuCiAgICoKICAgKiBBbiBpbnN0YW5jZSBvZiBEYXZpcy5SZXF1ZXN0IGlzIGV4cGVjdGVkIHRvIGJlIHBhc3NlZCwgaG93ZXZlciBhbnkgb2JqZWN0IHRoYXQgaGFzIGEgdGl0bGUKICAgKiBhbmQgYSBwYXRoIHByb3BlcnR5IHdpbGwgYWxzbyBiZSBhY2NlcHRlZC4KICAgKgogICAqIEBwYXJhbSB7RGF2aXMuUmVxdWVzdH0gcmVxdWVzdCB0aGUgbG9jYXRpb24gdG8gYmUgYXNzaW5nZWQgYXMgdGhlIGN1cnJlbnQgbG9jYXRpb24uCiAgICogQG1lbWJlck9mIGhpc3RvcnkKICAgKi8KICB2YXIgYXNzaWduID0gY2hhbmdlU3RhdGVXaXRoKCdwdXNoU3RhdGUnKQoKICAvKioKICAgKiBSZXBsYWNlIHRoZSBjdXJyZW50IHN0YXRlIG9uIHRoZSBoaXN0b3J5IHN0YWNrLgogICAqCiAgICogVGhpcyBpcyB1c2VkIGludGVybmFsbHkgYnkgRGF2aXMgd2hlbiBwZXJmb3JtaW5nIGEgcmVkaXJlY3QuICBUaGlzIHdpbGwgdHJpZ2dlciBhbiBvbnB1c2hzdGF0ZSBldmVudC4KICAgKgogICAqIEFuIGluc3RhbmNlIG9mIERhdmlzLlJlcXVlc3QgaXMgZXhwZWN0ZWQgdG8gYmUgcGFzc2VkLCBob3dldmVyIGFueSBvYmplY3QgdGhhdCBoYXMgYSB0aXRsZQogICAqIGFuZCBhIHBhdGggcHJvcGVydHkgd2lsbCBhbHNvIGJlIGFjY2VwdGVkLgogICAqCiAgICogQHBhcmFtIHtEYXZpcy5SZXF1ZXN0fSByZXF1ZXN0IHRoZSBsb2NhdGlvbiB0byByZXBsYWNlIHRoZSBjdXJyZW50IGxvY2F0aW9uIHdpdGguCiAgICogQG1lbWJlck9mIGhpc3RvcnkKICAgKi8KICB2YXIgcmVwbGFjZSA9IGNoYW5nZVN0YXRlV2l0aCgncmVwbGFjZVN0YXRlJykKCiAgLyoqCiAgICogUmV0dXJucyB0aGUgY3VycmVudCBsb2NhdGlvbiBmb3IgdGhlIGFwcGxpY2F0aW9uLgogICAqCiAgICogRGF2aXMubG9jYXRpb24gZGVsZWdhdGVzIHRvIHRoaXMgbWV0aG9kIGZvciBnZXR0aW5nIHRoZSBhcHBzIGN1cnJlbnQgbG9jYXRpb24uCiAgICoKICAgKiBAbWVtYmVyT2YgaGlzdG9yeQogICAqLwogIGZ1bmN0aW9uIGN1cnJlbnQoKSB7CiAgICByZXR1cm4gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lICsgKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2ggPyB3aW5kb3cubG9jYXRpb24uc2VhcmNoIDogJycpCiAgfQoKICAvKiEKICAgKiBFeHBvc2luZyB0aGUgcHVibGljIG1ldGhvZHMgb2YgdGhpcyBtb2R1bGUKICAgKiBAcHJpdmF0ZQogICAqLwogIHJldHVybiB7CiAgICBvbkNoYW5nZTogb25DaGFuZ2UsCiAgICBjdXJyZW50OiBjdXJyZW50LAogICAgYXNzaWduOiBhc3NpZ24sCiAgICByZXBsYWNlOiByZXBsYWNlCiAgfQp9KSgpCi8qIQogKiBEYXZpcyAtIGxvY2F0aW9uCiAqIENvcHlyaWdodCAoQykgMjAxMSBPbGl2ZXIgTmlnaHRpbmdhbGUKICogTUlUIExpY2Vuc2VkCiAqLwoKLyoqCiAqIEEgbW9kdWxlIHRoYXQgYWN0cyBhcyBhIGRlbGVnYXRvciB0byBhbnkgbG9jYXRpb25EZWxlZ2F0ZSBpbXBsZW1lbnRhdGlvbi4gIFRoaXMgYWJzdHJhY3RzIHRoZSBkZXRhaWxzIG9mCiAqIHdoYXQgaXMgYmVpbmcgdXNlZCBmb3IgdGhlIGFwcHMgcm91dGluZyBhd2F5IGZyb20gdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkuICBUaGlzIGFsbG93cyBhbnkga2luZCBvZiByb3V0aW5nCiAqIFRvIGJlIHVzZWQgd2l0aCBEYXZpcyBhcyBsb25nIGFzIGl0IGNhbiByZXNwb25kIGFwcHJvcHJpYXRseSB0byB0aGUgZ2l2ZW4gZGVsZWdhdGUgbWV0aG9kcy4KICoKICogQSByb3V0aW5nIG1vZHVsZSBtdXN0IHJlc3BvbmQgdG8gdGhlIGZvbGxvd2luZyBtZXRob2RzCiAqCiAqICAqIF9fY3VycmVudF9fIDogU2hvdWxkIHJldHVybiB0aGUgY3VycmVudCBsb2NhdGlvbiBmb3IgdGhlIGFwcAogKiAgKiBfX2Fzc2lnbl9fIDogU2hvdWxkIHNldCB0aGUgY3VycmVudCBsb2NhdGlvbiBvZiB0aGUgYXBwIGJhc2VkIG9uIHRoZSBsb2NhdGlvbiBvZiB0aGUgcGFzc2VkIHJlcXVlc3QuCiAqICAqIF9fcmVwbGFjZV9fIDogU2hvdWxkIGF0IGxlYXN0IGNoYW5nZSB0aGUgY3VycmVudCBsb2NhdGlvbiB0byB0aGUgbG9jYXRpb24gb2YgdGhlIHBhc3NlZCByZXF1ZXN0LCBmb3IgZnVsbCBjb21wYXRpYmlsaXR5IGl0IHNob3VsZCBub3QgYWRkIGFueSBleHRyYSBpdGVtcyBpbiB0aGUgaGlzdG9yeSBzdGFjay4KICogICogX19vbkNoYW5nZV9fIDogU2hvdWxkIGFkZCBjYWxiYWNrcyB0aGF0IHdpbGwgYmUgZmlyZWQgd2hlbmV2ZXIgdGhlIGxvY2F0aW9uIGlzIGNoYW5nZWQuCiAqCiAqIEBtb2R1bGUKICoKICovCkRhdmlzLmxvY2F0aW9uID0gKGZ1bmN0aW9uICgpIHsKCiAgLyohCiAgICogQnkgZGVmYXVsdCB0aGUgRGF2aXMgdXNlcyB0aGUgRGF2aXMuaGlzdG9yeSBtb2R1bGUgZm9yIGl0cyByb3V0aW5nLCB0aGlzIGdpdmVzIEhUTUw1IGJhc2VkIHB1c2hTdGF0ZSByb3V0aW5nCiAgICogd2hpY2ggaXMgcHJlZmVycmFibGUgb3ZlciBsb2NhdGlvbi5oYXNoIGJhc2VkIHJvdXRpbmcuCiAgICovCiAgdmFyIGxvY2F0aW9uRGVsZWdhdGUgPSBEYXZpcy5oaXN0b3J5CgogIC8qKgogICAqIFNldHMgdGhlIGN1cnJlbnQgbG9jYXRpb24gZGVsZWdhdGUuCiAgICoKICAgKiBUaGUgcGFzc2VkIGRlbGVnYXRlIHdpbGwgYmUgdXNlZCBmb3IgYWxsIERhdmlzIGFwcHMuICBUaGUgZGVsZWdhdGUKICAgKiBtdXN0IHJlc3BvbmQgdG8gdGhlIGZvbGxvd2luZyBmb3VyIG1ldGhvZHMgYGN1cnJlbnRgLCBgYXNzaWduYCwgYHJlcGxhY2VgICYgYG9uQ2hhbmdlYC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSB0aGUgbG9jYXRpb24gZGVsZWdhdGUgdG8gdXNlLgogICAqIEBtZW1iZXJPZiBsb2NhdGlvbgogICAqLwogIGZ1bmN0aW9uIHNldExvY2F0aW9uRGVsZWdhdGUoZGVsZWdhdGUpIHsKICAgIGxvY2F0aW9uRGVsZWdhdGUgPSBkZWxlZ2F0ZQogIH0KCiAgLyoqCiAgICogRGVsZWdhdGVzIHRvIHRoZSBsb2NhdGlvbkRlbGVnYXRlLmN1cnJlbnQgbWV0aG9kLgogICAqCiAgICogVGhpcyBzaG91bGQgcmV0dXJuIHRoZSBjdXJyZW50IGxvY2F0aW9uIG9mIHRoZSBhcHAuCiAgICoKICAgKiBAbWVtYmVyT2YgbG9jYXRpb24KICAgKi8KICBmdW5jdGlvbiBjdXJyZW50KCkgewogICAgcmV0dXJuIGxvY2F0aW9uRGVsZWdhdGUuY3VycmVudCgpCiAgfQoKICAvKiEKICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gd2hpY2ggc2VuZHMgdGhlIGxvY2F0aW9uIGRlbGVnYXRlIHRoZSBwYXNzZWQgbWVzc2FnZSBuYW1lLgogICAqIEl0IGhhbmRsZXMgY29udmVydGluZyBhIHN0cmluZyBwYXRoIHRvIGFuIGFjdHVhbCByZXF1ZXN0CiAgICoKICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IGEgZnVuY3Rpb24gdGhhdCBjYWxscyB0aGUgbG9jYXRpb24gZGVsZWdhdGUgd2l0aCB0aGUgc3VwcGxpZWQgbWV0aG9kIG5hbWUKICAgKiBAbWVtYmVyT2YgbG9jYXRpb24KICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHNlbmRMb2NhdGlvbkRlbGVnYXRlIChtZXRob2ROYW1lKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKHJlcSkgewogICAgICBpZiAodHlwZW9mIHJlcSA9PSAnc3RyaW5nJykgcmVxID0gbmV3IERhdmlzLlJlcXVlc3QgKHJlcSkKICAgICAgbG9jYXRpb25EZWxlZ2F0ZVttZXRob2ROYW1lXShyZXEpCiAgICB9CiAgfQoKICAvKioKICAgKiBEZWxlZ2F0ZXMgdG8gdGhlIGxvY2F0aW9uRGVsZWdhdGUuYXNzaWduIG1ldGhvZC4KICAgKgogICAqIFRoaXMgc2hvdWxkIHNldCB0aGUgY3VycmVudCBsb2NhdGlvbiBmb3IgdGhlIGFwcCB0byB0aGF0IG9mIHRoZSBwYXNzZWQgcmVxdWVzdCBvYmplY3QuCiAgICoKICAgKiBDYW4gdGFrZSBlaXRoZXIgYSBEYXZpcy5SZXF1ZXN0IG9yIGEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgcGF0aCBvZiB0aGUgcmVxdWVzdCB0byBhc3NpZ24uCiAgICoKICAgKgogICAqCiAgICogQHBhcmFtIHtSZXF1ZXN0fSByZXEgdGhlIHJlcXVlc3QgdG8gcmVwbGFjZSB0aGUgY3VycmVudCBsb2NhdGlvbiB3aXRoLCBlaXRoZXIgYSBzdHJpbmcgb3IgYSBEYXZpcy5SZXF1ZXN0LgogICAqIEBzZWUgRGF2aXMuUmVxdWVzdAogICAqIEBtZW1iZXJPZiBsb2NhdGlvbgogICAqLwogIHZhciBhc3NpZ24gPSBzZW5kTG9jYXRpb25EZWxlZ2F0ZSgnYXNzaWduJykKCiAgLyoqCiAgICogRGVsZWdhdGVzIHRvIHRoZSBsb2NhdGlvbkRlbGVnYXRlLnJlcGxhY2UgbWV0aG9kLgogICAqCiAgICogVGhpcyBzaG91bGQgcmVwbGFjZSB0aGUgY3VycmVudCBsb2NhdGlvbiB3aXRoIHRoYXQgb2YgdGhlIHBhc3NlZCByZXF1ZXN0LgogICAqIElkZWFsbHkgaXQgc2hvdWxkIG5vdCBjcmVhdGUgYSBuZXcgZW50cnkgaW4gdGhlIGJyb3dzZXJzIGhpc3RvcnkuCiAgICoKICAgKiBDYW4gdGFrZSBlaXRoZXIgYSBEYXZpcy5SZXF1ZXN0IG9yIGEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgcGF0aCBvZiB0aGUgcmVxdWVzdCB0byBhc3NpZ24uCiAgICoKICAgKiBAcGFyYW0ge1JlcXVlc3R9IHJlcSB0aGUgcmVxdWVzdCB0byByZXBsYWNlIHRoZSBjdXJyZW50IGxvY2F0aW9uIHdpdGgsIGVpdGhlciBhIHN0cmluZyBvciBhIERhdmlzLlJlcXVlc3QuCiAgICogQHNlZSBEYXZpcy5SZXF1ZXN0CiAgICogQG1lbWJlck9mIGxvY2F0aW9uCiAgICovCiAgdmFyIHJlcGxhY2UgPSBzZW5kTG9jYXRpb25EZWxlZ2F0ZSgncmVwbGFjZScpCgogIC8qKgogICAqIERlbGVnYXRlcyB0byB0aGUgbG9jYXRpb25EZWxlZ2F0ZS5vbkNoYW5nZSBtZXRob2QuCiAgICoKICAgKiBUaGlzIHNob3VsZCBhZGQgYSBjYWxsYmFjayB0aGF0IHdpbGwgYmUgY2FsbGVkIGFueSB0aW1lIHRoZSBsb2NhdGlvbiBjaGFuZ2VzLgogICAqIFRoZSBoYW5kbGVyIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdpdGggYSByZXF1ZXN0IHBhcmFtIHdoaWNoIGlzIGFuIGluc3RhbmNlIG9mIERhdmlzLlJlcXVlc3QuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBsb2NhdGlvbiBjaG5hZ2UuCiAgICogQHNlZSBEYXZpcy5SZXF1ZXN0CiAgICogQG1lbWJlck9mIGxvY2F0aW9uCiAgICoKICAgKi8KICBmdW5jdGlvbiBvbkNoYW5nZShoYW5kbGVyKSB7CiAgICBsb2NhdGlvbkRlbGVnYXRlLm9uQ2hhbmdlKGhhbmRsZXIpCiAgfQoKICAvKiEKICAgKiBFeHBvc2luZyB0aGUgcHVibGljIG1ldGhvZHMgb2YgdGhpcyBtb2R1bGUKICAgKiBAcHJpdmF0ZQogICAqLwogIHJldHVybiB7CiAgICBzZXRMb2NhdGlvbkRlbGVnYXRlOiBzZXRMb2NhdGlvbkRlbGVnYXRlLAogICAgY3VycmVudDogY3VycmVudCwKICAgIGFzc2lnbjogYXNzaWduLAogICAgcmVwbGFjZTogcmVwbGFjZSwKICAgIG9uQ2hhbmdlOiBvbkNoYW5nZQogIH0KfSkoKS8qIQogKiBEYXZpcyAtIFJlcXVlc3QKICogQ29weXJpZ2h0IChDKSAyMDExIE9saXZlciBOaWdodGluZ2FsZQogKiBNSVQgTGljZW5zZWQKICovCgpEYXZpcy5SZXF1ZXN0ID0gKGZ1bmN0aW9uICgpIHsKCi8qKgogKiBEYXZpcy5SZXF1ZXN0cyBhcmUgY3JlYXRlZCBmcm9tIGNsaWNrIGFuZCBzdWJtaXQgZXZlbnRzLiAgRGF2aXMuUmVxdWVzdHMgYXJlIHBhc3NlZCB0byBEYXZpcy5Sb3V0ZXMKICogYW5kIGFyZSBzdG9yZWQgaW4gdGhlIGhpc3Rvcnkgc3RhY2suICBUaGV5IGFyZSBpbnN0YW50aWF0ZWQgYnkgdGhlIERhdmlzLmxpc3RlbmVyIG1vZHVsZS4KICoKICogQSByZXF1ZXN0IHdpbGwgaGF2ZSBhIHBhcmFtcyBvYmplY3Qgd2hpY2ggd2lsbCBjb250YWluIGFsbCBxdWVyeSBwYXJhbXMgYW5kIGZvcm0gcGFyYW1zLCBhbnkgbmFtZWQKICogcGFyYW1zIGluIGEgcm91dGVzIHBhdGggd2lsbCBhbHNvIGJlIGFkZGVkIHRvIHRoZSByZXF1ZXN0cyBwYXJhbXMgb2JqZWN0LiAgQWxzbyBpbmNsdWRlZCBpcyBzdXBwb3J0CiAqIGZvciByYWlscyBzdHlsZSBuZXN0ZWQgZm9ybSBwYXJhbXMuCiAqCiAqIEJ5IGRlZmF1bHQgdGhlIHJlcXVlc3QgbWV0aG9kIHdpbGwgYmUgdGFrZW4gZnJvbSB0aGUgbWV0aG9kIGF0dHJpYnV0ZSBmb3IgZm9ybXMgb3Igd2lsbCBiZSBkZWZhdWx0ZWQKICogdG8gJ2dldCcgZm9yIGxpbmtzLCBob3dldmVyIHRoZXJlIGlzIHN1cHBvcnQgZm9yIHVzaW5nIGEgaGlkZGVuIGZpZWxkIGNhbGxlZCBfbWV0aG9kIGluIHlvdXIgZm9ybXMKICogdG8gc2V0IHRoZSBjb3JyZWN0IHJlcWV1c3QgbWV0aG9kLgogKgogKiBTaW1wbGUgZ2V0IHJlcXVlc3RzIGNhbiBiZSBjcmVhdGVkIGJ5IGp1c3QgcGFzc2luZyBhIHBhdGggd2hlbiBpbml0aWFsaXppbmcgYSByZXF1ZXN0LCB0byBzZXQgdGhlIG1ldGhvZAogKiBvciB0aXRsZSB5b3UgaGF2ZSB0byBwYXNzIGluIGFuIG9iamVjdC4KICoKICogRXhhbXBsZQogKgogKiAgICAgdmFyIHJlcXVlc3QgPSBuZXcgRGF2aXMuUmVxdWVzdCAoIi9mb28vMTIiKQogKgogKiAgICAgdmFyIHJlcXVlc3QgPSBuZXcgRGF2aXMuUmVxdWVzdCAoIi9mb28vMTIiLCB7dGl0bGU6ICdmb28nLCBtZXRob2Q6ICdQT1NUJ30pCiAqICAgICAKICogICAgIHZhciByZXF1ZXN0ID0gbmV3IERhdmlzLlJlcXVlc3QoewogKiAgICAgICB0aXRsZTogImZvbyIsCiAqICAgICAgIGZ1bGxQYXRoOiAiL2Zvby8xMiIsCiAqICAgICAgIG1ldGhvZDogImdldCIKICogICAgIH0pCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge1N0cmluZ30gZnVsbFBhdGgKICogQHBhcmFtIHtPYmplY3R9IG9wdHMgQW4gb3B0aW9uYWwgb2JqZWN0IHdpdGggYSB0aXRsZSBvciBtZXRob2QgcHJvcHJ0eQogKgogKi8KICB2YXIgUmVxdWVzdCA9IGZ1bmN0aW9uIChmdWxsUGF0aCwgb3B0cykgewogICAgaWYgKHR5cGVvZiBmdWxsUGF0aCA9PSAnb2JqZWN0JykgewogICAgICBvcHRzID0gZnVsbFBhdGgKICAgICAgZnVsbFBhdGggPSBvcHRzLmZ1bGxQYXRoCiAgICAgIGRlbGV0ZSBvcHRzLmZ1bGxQYXRoCiAgICB9CgogICAgdmFyIHJhdyA9IERhdmlzLiQuZXh0ZW5kKHt9LCB7CiAgICAgIHRpdGxlOiAiIiwKICAgICAgZnVsbFBhdGg6IGZ1bGxQYXRoLAogICAgICBtZXRob2Q6ICJnZXQiCiAgICB9LCBvcHRzKQoKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHRoaXMucmF3ID0gcmF3OwogICAgdGhpcy5wYXJhbXMgPSB7fTsKICAgIHRoaXMudGl0bGUgPSByYXcudGl0bGU7CiAgICB0aGlzLnF1ZXJ5U3RyaW5nID0gcmF3LmZ1bGxQYXRoLnNwbGl0KCI/IilbMV07CiAgICB0aGlzLl9zdGFsZUNhbGxiYWNrID0gZnVuY3Rpb24gKCkge307CgogICAgaWYgKHRoaXMucXVlcnlTdHJpbmcpIHsKICAgICAgRGF2aXMudXRpbHMuZm9yRWFjaCh0aGlzLnF1ZXJ5U3RyaW5nLnNwbGl0KCImIiksIGZ1bmN0aW9uIChrZXl2YWwpIHsKICAgICAgICB2YXIgcGFyYW1OYW1lID0ga2V5dmFsLnNwbGl0KCI9IilbMF0sCiAgICAgICAgICAgIHBhcmFtVmFsdWUgPSBrZXl2YWwuc3BsaXQoIj0iKVsxXSwKICAgICAgICAgICAgbmVzdGVkUGFyYW1SZWdleCA9IC9eKFx3KylcWyhcdyspP1xdKFxbXF0pPy8sCiAgICAgICAgICAgIG5lc3RlZDsKICAgICAgICBpZiAobmVzdGVkID0gbmVzdGVkUGFyYW1SZWdleC5leGVjKHBhcmFtTmFtZSkpIHsKICAgICAgICAgIHZhciBwYXJhbVBhcmVudCA9IG5lc3RlZFsxXTsKICAgICAgICAgIHZhciBwYXJhbU5hbWUgPSBuZXN0ZWRbMl07CiAgICAgICAgICB2YXIgaXNBcnJheSA9ICEhbmVzdGVkWzNdOwogICAgICAgICAgdmFyIHBhcmVudFBhcmFtcyA9IHNlbGYucGFyYW1zW3BhcmFtUGFyZW50XSB8fCB7fTsKCiAgICAgICAgICBpZiAoaXNBcnJheSkgewogICAgICAgICAgICBwYXJlbnRQYXJhbXNbcGFyYW1OYW1lXSA9IHBhcmVudFBhcmFtc1twYXJhbU5hbWVdIHx8IFtdOwogICAgICAgICAgICBwYXJlbnRQYXJhbXNbcGFyYW1OYW1lXS5wdXNoKGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVZhbHVlKSk7CiAgICAgICAgICAgIHNlbGYucGFyYW1zW3BhcmFtUGFyZW50XSA9IHBhcmVudFBhcmFtczsKICAgICAgICAgIH0gZWxzZSBpZiAoIXBhcmFtTmFtZSAmJiAhaXNBcnJheSkgewogICAgICAgICAgICBwYXJlbnRQYXJhbXMgPSBzZWxmLnBhcmFtc1twYXJhbVBhcmVudF0gfHwgW10KICAgICAgICAgICAgcGFyZW50UGFyYW1zLnB1c2goZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtVmFsdWUpKQogICAgICAgICAgICBzZWxmLnBhcmFtc1twYXJhbVBhcmVudF0gPSBwYXJlbnRQYXJhbXMKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhcmVudFBhcmFtc1twYXJhbU5hbWVdID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtVmFsdWUpOwogICAgICAgICAgICBzZWxmLnBhcmFtc1twYXJhbVBhcmVudF0gPSBwYXJlbnRQYXJhbXM7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYucGFyYW1zW3BhcmFtTmFtZV0gPSBkZWNvZGVVUklDb21wb25lbnQocGFyYW1WYWx1ZSk7CiAgICAgICAgfTsKCiAgICAgIH0pOwogICAgfTsKCiAgICByYXcuZnVsbFBhdGggPSByYXcuZnVsbFBhdGgucmVwbGFjZSgvXmh0dHBzPzpcL1wvLis/XC8vLCAnLycpOwoKICAgIHRoaXMubWV0aG9kID0gKHRoaXMucGFyYW1zLl9tZXRob2QgfHwgcmF3Lm1ldGhvZCkudG9Mb3dlckNhc2UoKTsKCiAgICB0aGlzLnBhdGggPSByYXcuZnVsbFBhdGgKICAgICAgLnJlcGxhY2UoL1w/LiskLywgIiIpICAvLyBSZW1vdmUgdGhlIHF1ZXJ5IHN0cmluZwogICAgICAucmVwbGFjZSgvXmh0dHBzPzpcL1wvW15cL10rLywgIiIpOyAvLyBSZW1vdmUgdGhlIHByb3RvY29sIGFuZCBob3N0IHBhcnRzCiAgCiAgICB0aGlzLmZ1bGxQYXRoID0gcmF3LmZ1bGxQYXRoOwoKICAgIHRoaXMuZGVsZWdhdGVUb1NlcnZlciA9IHJhdy5kZWxlZ2F0ZVRvU2VydmVyIHx8IERhdmlzLm5vb3A7CiAgICB0aGlzLmlzRm9yUGFnZUxvYWQgPSByYXcuZm9yUGFnZUxvYWQgfHwgZmFsc2U7CgogICAgaWYgKFJlcXVlc3QucHJldikgUmVxdWVzdC5wcmV2Lm1ha2VTdGFsZSh0aGlzKTsKICAgIFJlcXVlc3QucHJldiA9IHRoaXM7CgogIH07CgogIC8qKgogICAqIFJlZGlyZWN0cyB0aGUgY3VycmVudCByZXF1ZXN0IHRvIGEgbmV3IGxvY2F0aW9uLgogICAqCiAgICogQ2FsbGluZyByZWRpcmVjdCBvbiBhbiBpbnN0YW5jZSBvZiBEYXZpcy5SZXF1ZXN0IHdpbGwgY3JlYXRlIGEgbmV3IHJlcXVlc3QgdXNpbmcgdGhlIHBhdGggYW5kCiAgICogdGl0bGUgb2YgdGhlIGN1cnJlbnQgcmVxdWVzdC4gUmVkaXJlY3RlZCByZXF1ZXN0cyBhbHdheXMgaGF2ZSBhIG1ldGhvZCBvZiAnZ2V0Jy4KICAgKgogICAqIFRoZSByZXF1ZXN0IGNyZWF0ZWQgd2lsbCByZXBsYWNlIHRoZSBjdXJyZW50IHJlcXVlc3QgaW4gdGhlIGhpc3Rvcnkgc3RhY2suICBSZWRpcmVjdCBpcyBtb3N0CiAgICogb2Z0ZW4gdXNlZnVsIGluc2lkZSBhIGhhbmRsZXIgZm9yIGEgZm9ybSBzdWJtaXQuICBBZnRlciBzdWNjZXNmdWxseSBoYW5kbGluZyB0aGUgZm9ybSB0aGUgYXBwCiAgICogY2FuIHJlZGlyZWN0IHRvIGFub3RoZXIgcGF0aC4gIFRoaXMgbWVhbnMgdGhhdCB0aGUgY3VycmVudCBmb3JtIHdpbGwgbm90IGJlIHJlLXN1Ym1pdHRlZCBpZgogICAqIG5hdmlnYXRpbmcgdGhyb3VnaCB0aGUgaGlzdG9yeSB3aXRoIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9ucyBiZWNhdXNlIHRoZSByZXF1ZXN0IHRoYXQgdGhlCiAgICogc3VibWl0IGdlbmVyYXRlZCBoYXMgYmVlbiByZXBsYWNlZCBpbiB0aGUgaGlzdG9yeSBzdGFjay4KICAgKgogICAqIEV4YW1wbGUKICAgKgogICAqICAgICB0aGlzLnBvc3QoJy9mb28nLCBmdW5jdGlvbiAocmVxKSB7CiAgICogICAgICAgcHJvY2Vzc0Zvcm1SZXF1ZXN0KHJlcS5wYXJhbXMpICAvLyBkbyBzb21ldGhpbmcgd2l0aCB0aGUgZm9ybSByZXF1ZXN0CiAgICogICAgICAgcmVxLnJlZGlyZWN0KCcvYmFyJyk7CiAgICogICAgIH0pCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgcGF0aCB0byByZWRpcmVjdCB0aGUgY3VycmVudCByZXF1ZXN0IHRvCiAgICogQG1lbWJlck9mIFJlcXVlc3QKICAgKi8KICBSZXF1ZXN0LnByb3RvdHlwZS5yZWRpcmVjdCA9IGZ1bmN0aW9uIChwYXRoKSB7CiAgICBEYXZpcy5sb2NhdGlvbi5yZXBsYWNlKG5ldyBSZXF1ZXN0ICh7CiAgICAgIG1ldGhvZDogJ2dldCcsCiAgICAgIGZ1bGxQYXRoOiBwYXRoLAogICAgICB0aXRsZTogdGhpcy50aXRsZQogICAgfSkpOwogIH07CgogIC8qKgogICAqIEFkZHMgYSBjYWxsYmFjayB0byBiZSBjYWxsZWQgd2hlbiB0aGUgcmVxdWVzdCBpcyBzdGFsZS4KICAgKiBBIHJlcXVlc3QgYmVjb21lcyBzdGFsZSB3aGVuIGl0IGlzIG5vIGxvbmdlciB0aGUgY3VycmVudCByZXF1ZXN0LCB0aGlzIG5vcm1hbGx5IG9jY3VycyB3aGVuIGEKICAgKiBuZXcgcmVxdWVzdCBpcyB0cmlnZ2VyZWQuICBBIHJlcXVlc3QgY2FuIGJlIG1hcmtlZCBhcyBzdGFsZSBtYW51YWxseSBpZiByZXF1aXJlZC4gIFRoZSBjYWxsYmFjawogICAqIHBhc3NlZCB0byB3aGVuU3RhbGUgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgbmV3IHJlcXVlc3QgdGhhdCBpcyBtYWtpbmcgdGhlIGN1cnJlbnQgcmVxdWVzdCBzdGFsZS4KICAgKgogICAqIFVzZSB0aGUgd2hlblN0YWxlIGNhbGxiYWNrIHRvICd0ZWFyZG93bicgdGhlIG9iamVjdHMgcmVxdWlyZWQgZm9yIHRoZSBjdXJyZW50IHJvdXRlLCB0aGlzIGdpdmVzCiAgICogYSBjaGFuY2UgZm9yIHZpZXdzIHRvIGhpZGUgdGhlbXNlbHZlcyBhbmQgdW5iaW5kIGFueSBldmVudCBoYW5kbGVycyBldGMuCiAgICoKICAgKiBFeGFtcGxlCiAgICoKICAgKiAgICAgdGhpcy5nZXQoJy9mb28nLCBmdW5jdGlvbiAocmVxKSB7CiAgICogICAgICAgdmFyIGZvb1ZpZXcgPSBuZXcgRm9vVmlldyAoKQogICAqICAgICAgIGZvb1ZpZXcucmVuZGVyKCkgLy8gZGlzcGxheSB0aGUgZm9vIHZpZXcKICAgKiAgICAgICByZXEud2hlblN0YWxlKGZ1bmN0aW9uIChuZXh0UmVxKSB7CiAgICogICAgICAgICBmb29WaWV3LnJlbW92ZSgpIC8vIHN0b3AgZGlzcGxheWluZyBmb28gdmlldyBhbmQgdW5iaW5kIGFueSBldmVudHMKICAgKiAgICAgICB9KQogICAqICAgICB9KQogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgQSBzaW5nbGUgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IGJlY29tZXMgc3RhbGUuCiAgICogQG1lbWJlck9mIFJlcXVlc3QKICAgKgogICAqLwogIFJlcXVlc3QucHJvdG90eXBlLndoZW5TdGFsZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgdGhpcy5fc3RhbGVDYWxsYmFjayA9IGNhbGxiYWNrOwogIH0KCiAgLyoqCiAgICogTWFyayB0aGUgcmVxdWVzdCBhcyBzdGFsZS4KICAgKgogICAqIFRoaXMgd2lsbCBjYXVzZSB0aGUgd2hlblN0YWxlIGNhbGxiYWNrIHRvIGJlIGNhbGxlZC4KICAgKgogICAqIEBwYXJhbSB7RGF2aXMuUmVxdWVzdH0gcmVxIFRoZSBuZXh0IHJlcXVlc3QgdGhhdCBoYXMgYmVlbiByZWNpZXZlZC4KICAgKiBAbWVtYmVyT2YgUmVxdWVzdAogICAqLwogIFJlcXVlc3QucHJvdG90eXBlLm1ha2VTdGFsZSA9IGZ1bmN0aW9uIChyZXEpIHsKICAgIHRoaXMuX3N0YWxlQ2FsbGJhY2suY2FsbChyZXEsIHJlcSk7CiAgfQoKICAvKioKICAgKiBSZXR1cm5zIHRoZSBsb2NhdGlvbiBvciBwYXRoIHRoYXQgc2hvdWxkIGJlIHB1c2hlZCBvbnRvIHRoZSBoaXN0b3J5IHN0YWNrLiAKICAgKgogICAqIEZvciBnZXQgcmVxdWVzdHMgdGhpcyB3aWxsIGJlIHRoZSBzYW1lIGFzIHRoZSBwYXRoLCBmb3IgcG9zdCwgcHV0LCBkZWxldGUgYW5kIHN0YXRlIHJlcXVlc3RzIHRoaXMgd2lsbAogICAqIGJlIGJsYW5rIGFzIG5vIGxvY2F0aW9uIHNob3VsZCBiZSBwdXNoZWQgb250byB0aGUgaGlzdG9yeSBzdGFjay4KICAgKgogICAqIEByZXR1cm5zIHtTdHJpbmd9IHN0cmluZyBUaGUgbG9jYXRpb24gdGhhdCB0aGUgdXJsIGJhciBzaG91bGQgZGlzcGxheSBhbmQgc2hvdWxkIGJlIHB1c2hlZCBvbnRvIHRoZSBoaXN0b3J5IHN0YWNrIGZvciB0aGlzIHJlcXVlc3QuCiAgICogQG1lbWJlck9mIFJlcXVlc3QKICAgKi8KICBSZXF1ZXN0LnByb3RvdHlwZS5sb2NhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAodGhpcy5tZXRob2QgPT09ICdnZXQnKSA/IHRoaXMuZnVsbFBhdGggOiAnJwogIH0KCiAgLyoqCiAgICogQ29udmVydHMgdGhlIHJlcXVlc3QgdG8gYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgaXRzZWxmIGJ5IGNvbWJpbmluZyB0aGUgbWV0aG9kIGFuZCBmdWxsUGF0aAogICAqIGF0dHJpYnV0ZXMuCiAgICoKICAgKiBAcmV0dXJucyB7U3RyaW5nfSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIHJlcXVlc3QKICAgKiBAbWVtYmVyT2YgUmVxdWVzdAogICAqLwogIFJlcXVlc3QucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIFt0aGlzLm1ldGhvZC50b1VwcGVyQ2FzZSgpLCB0aGlzLnBhdGhdLmpvaW4oIiAiKQogIH07CgogIC8qKgogICAqIENvbnZlcnRzIHRoZSByZXF1ZXN0IHRvIGEgcGxhaW4gb2JqZWN0IHdoaWNoIGNhbiBiZSBjb252ZXJ0ZWQgdG8gYSBKU09OIHN0cmluZy4KICAgKgogICAqIFVzZWQgd2hlbiBwdXNoaW5nIGEgcmVxdWVzdCBvbnRvIHRoZSBoaXN0b3J5IHN0YWNrLgogICAqCiAgICogQHJldHVybnMge09iamVjdH0gYSBwbGFpbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhlIHJlcXVlc3QuCiAgICogQG1lbWJlck9mIFJlcXVlc3QKICAgKi8KICBSZXF1ZXN0LnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gewogICAgICB0aXRsZTogdGhpcy5yYXcudGl0bGUsCiAgICAgIGZ1bGxQYXRoOiB0aGlzLnJhdy5mdWxsUGF0aCwKICAgICAgbWV0aG9kOiB0aGlzLnJhdy5tZXRob2QKICAgIH0KICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgcmVxdWVzdCBmb3IgdGhlIHBhZ2Ugb24gcGFnZSBsb2FkLgogICAqCiAgICogVGhpcyBpcyByZXF1aXJlZCBiZWNhdXNlIHVzdWFsbHkgcmVxdWVzdHMgYXJlIGdlbmVyYXRlZCBmcm9tIGNsaWNraW5nIGxpbmtzIG9yIHN1Ym1pdHRpbmcgZm9ybXMKICAgKiBob3dldmVyIHRoaXMgZG9lc24ndCBoYXBwZW4gb24gYSBwYWdlIGxvYWQgYnV0IHNob3VsZCBzdGlsbCBiZSBjb25zaWRlcmVkIGEgcmVxdWVzdCB0aGF0IHRoZSAKICAgKiBKYXZhU2NyaXB0IGFwcCBzaG91bGQgaGFuZGxlLgogICAqCiAgICogQHJldHVybnMge0RhdmlzLlJlcXVlc3R9IEEgcmVxdWVzdCByZXByZXNlbnRpbmcgdGhlIGN1cnJlbnQgcGFnZSBsb2FkaW5nLgogICAqIEBtZW1iZXJPZiBSZXF1ZXN0CiAgICovCiAgUmVxdWVzdC5mb3JQYWdlTG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgdGhpcyAoewogICAgICBtZXRob2Q6ICdnZXQnLAogICAgICAvLyBmdWxsUGF0aDogd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lLAogICAgICBmdWxsUGF0aDogRGF2aXMubG9jYXRpb24uY3VycmVudCgpLAogICAgICB0aXRsZTogZG9jdW1lbnQudGl0bGUsCiAgICAgIGZvclBhZ2VMb2FkOiB0cnVlCiAgICB9KTsKICB9CgogIC8qIQogICAqIFN0b3JlcyB0aGUgbGFzdCByZXF1ZXN0CiAgICogQHByaXZhdGUKICAgKi8KICBSZXF1ZXN0LnByZXYgPSBudWxsCgogIHJldHVybiBSZXF1ZXN0Cgp9KSgpCi8qIQogKiBEYXZpcyAtIEFwcAogKiBDb3B5cmlnaHQgKEMpIDIwMTEgT2xpdmVyIE5pZ2h0aW5nYWxlCiAqIE1JVCBMaWNlbnNlZAogKi8KCkRhdmlzLkFwcCA9IChmdW5jdGlvbiAoKSB7CgogIC8qKgogICAqIENvbnN0cnVjdG9yIGZvciBEYXZpcy5BcHAKICAgKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEByZXR1cm5zIHtEYXZpcy5BcHB9CiAgICovCiAgZnVuY3Rpb24gQXBwKCkgewogICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7CiAgICB0aGlzLmJvdW5kVG9JbnRlcm5hbEV2ZW50cyA9IGZhbHNlOwoKICAgIHRoaXMudXNlKERhdmlzLmxpc3RlbmVyKQogICAgdGhpcy51c2UoRGF2aXMuZXZlbnQpCiAgICB0aGlzLnVzZShEYXZpcy5yb3V0ZXIpCiAgICB0aGlzLnVzZShEYXZpcy5sb2dnZXIpCiAgfTsKCiAgLyoqCiAgICogQSBjb252aW5pZW5jZSBmdW5jdGlvbiBmb3IgY2hhbmdpbmcgdGhlIGFwcHMgZGVmYXVsdCBzZXR0aW5ncy4KICAgKgogICAqIFNob3VsZCBiZSB1c2VkIGJlZm9yZSBzdGFydGluZyB0aGUgYXBwIHRvIGVuc3VyZSBhbnkgbmV3IHNldHRpbmdzCiAgICogYXJlIHBpY2tlZCB1cCBhbmQgdXNlZC4KICAgKgogICAqIEV4YW1wbGU6CiAgICoKICAgKiAgICAgYXBwLmNvbmZpZ3VyZShmdW5jdGlvbiAoY29uZmlnKSB7CiAgICogICAgICAgY29uZmlnLmxpbmtTZWxlY3RvciA9ICdhLmRhdmlzJwogICAqICAgICAgIGNvbmZpZy5mb3JtU2VsZWN0b3IgPSAnZm9ybS5kYXZpcycKICAgKiAgICAgfSkKICAgKgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZyBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgZXhlY3V0ZWQgd2l0aCB0aGUgY29udGV4dCBib3VuZCB0byB0aGUgYXBwcyBzZXR0aW5nIG9iamVjdCwgdGhpcyB3aWxsIGFsc28gYmUgcGFzc2VkIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byB0aGUgZnVuY3Rpb24uCiAgICovCiAgQXBwLnByb3RvdHlwZS5jb25maWd1cmUgPSBmdW5jdGlvbihjb25maWcpIHsKICAgIGNvbmZpZy5jYWxsKHRoaXMuc2V0dGluZ3MsIHRoaXMuc2V0dGluZ3MpOwogIH07CgogIC8qKgogICAqIE1ldGhvZCB0byBpbmNsdWRlIGEgcGx1Z2luIGluIHRoaXMgYXBwLgogICAqCiAgICogQSBwbHVnaW4gaXMganVzdCBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQgaW4gdGhlIGNvbnRleHQgb2YgdGhlIGFwcC4KICAgKgogICAqIEV4YW1wbGU6CiAgICogICAgIGFwcC51c2UoRGF2aXMudGl0bGUpCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwbHVnaW4gVGhlIHBsdWdpbiB0byB1c2UKICAgKgogICAqLwogIEFwcC5wcm90b3R5cGUudXNlID0gZnVuY3Rpb24ocGx1Z2luKSB7CiAgICBwbHVnaW4uYXBwbHkodGhpcywgRGF2aXMudXRpbHMudG9BcnJheShhcmd1bWVudHMsIDEpKQogIH07CgogIC8qKgogICAqIE1ldGhvZCB0byBhZGQgaGVscGVyIHByb3BlcnRpZXMgdG8gYWxsIHJlcXVlc3RzIGluIHRoZSBhcHBsaWNhdGlvbi4KICAgKgogICAqIEhlbHBlcnMgd2lsbCBiZSBhZGRlZCB0byB0aGUgRGF2aXMuUmVxdWVzdC5wcm90b3R5cGUuICBDYXJlIHNob3VsZCBiZSB0YWtlbiBub3QgdG8gb3ZlcnJpZGUgYW55IGV4aXN0aW5nIERhdmlzLlJlcXVlc3QKICAgKiBtZXRob2RzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGhlbHBlcnMgQW4gb2JqZWN0IGNvbnRhaW5pbmcgaGVscGVycyB0byBtaXhpbiB0byB0aGUgcmVxdWVzdAogICAqLwogIEFwcC5wcm90b3R5cGUuaGVscGVycyA9IGZ1bmN0aW9uKGhlbHBlcnMpIHsKICAgIGZvciAocHJvcGVydHkgaW4gaGVscGVycykgewogICAgICBpZiAoaGVscGVycy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIERhdmlzLlJlcXVlc3QucHJvdG90eXBlW3Byb3BlcnR5XSA9IGhlbHBlcnNbcHJvcGVydHldCiAgICB9CiAgfTsKCiAgLyoqCiAgICogU2V0dGluZ3MgZm9yIHRoZSBhcHAuICBUaGVzZSBtYXkgYmUgb3ZlcnJpZGVuIGRpcmVjdGx5IG9yIGJ5IHVzaW5nIHRoZSBjb25maWd1cmUKICAgKiBjb252aW5pZW5jZSBtZXRob2QuCiAgICoKICAgKiBgbGlua1NlbGVjdG9yYCBpcyB0aGUganF1ZXJ5IHNlbGVjdG9yIGZvciBhbGwgdGhlIGxpbmtzIG9uIHRoZSBwYWdlIHRoYXQgeW91IHdhbnQKICAgKiBEYXZpcyB0byByZXNwb25kIHRvLiAgVGhlc2UgbGlua3Mgd2lsbCBub3QgdHJpZ2dlciBhIG5vcm1hbCBodHRwIHJlcXVlc3QuCiAgICoKICAgKiBgZm9ybVNlbGVjdG9yYCBpcyBzaW1pbGFyIHRvIGxpbmsgc2VsZWN0b3IgYnV0IGZvciBhbGwgdGhlIGZvcm1zIHRoYXQgZGF2aXMgd2lsbCBiaW5kIHRvCiAgICoKICAgKiBgdGhyb3dFcnJvcnNgIGRlY2lkZXMgd2hldGhlciBvciBub3QgYW55IGVycm9ycyB3aWxsIGJlIGNhdWd0aCBieSBEYXZpcy4gIElmIHRoaXMgaXMgc2V0IHRvIHRydWUKICAgKiBlcnJvcnMgd2lsbCBiZSB0aHJvd24gc28gdGhhdCB0aGUgcmVxdWVzdCB3aWxsIG5vdCBiZSBoYW5kbGVkIGJ5IEphdmFTY3JpcHQsIHRoZSBzZXJ2ZXIgd2lsbCBoYXZlCiAgICogdG8gcHJvdmlkZSBhIHJlc3BvbnNlLiAgV2hlbiBzZXQgdG8gZmFsc2UgZXJyb3JzIGluIGEgcm91dGUgd2lsbCBiZSBjYXVnaHQgYW5kIHRoZSBzZXJ2ZXIgd2lsbCBub3QKICAgKiByZWNlaXZlIHRoZSByZXF1ZXN0LgogICAqCiAgICogYGhhbmRsZVJvdXRlTm90Rm91bmRgIGRldGVybWluZXMgd2hldGhlciBvciBub3QgRGF2aXMgc2hvdWxkIGhhbmRsZSByZXF1ZXN0cyB3aGVuIHRoZXJlIGlzIG5vIG1hdGNoaW5nCiAgICogcm91dGUuICBJZiBzZXQgdG8gZmFsc2UgRGF2aXMgd2lsbCBhbGxvdyB0aGUgcmVxdWVzdCB0byBiZSBwYXNzZWQgdG8geW91ciBzZXJ2ZXIgdG8gaGFuZGxlIGlmIG5vIG1hdGNoaW5nCiAgICogcm91dGUgY2FuIGJlIGZvdW5kLgogICAqCiAgICogYGdlbmVyYXRlUmVxdWVzdE9uUGFnZUxvYWRgIGRldGVybWluZXMgd2hldGhlciBhIHJlcXVlc3Qgc2hvdWxkIGJlIGdlbmVyYXRlZCBmb3IgdGhlIGluaXRpYWwgcGFnZSBsb2FkLgogICAqIGJ5IGRlZmF1bHQgdGhpcyBpcyBzZXQgdG8gZmFsc2UuIEEgRGF2aXMuUmVxdWVzdCB3aWxsIG5vdCBiZSBnZW5lcmF0ZWQgd2l0aCB0aGUgcGF0aCBvZiB0aGUgY3VycmVudAogICAqIHBhZ2UuICBTZXR0aW5nIHRoaXMgdG8gdHJ1ZSB3aWxsIGNhdXNlIGEgcmVxdWVzdCB0byBiZSBwYXNzZWQgdG8geW91ciBhcHAgZm9yIHRoZSBpbml0YWwgcGFnZSBsb2FkLgogICAqCiAgICogQHNlZSAjY29uZmlndXJlCiAgICovCgogIEFwcC5wcm90b3R5cGUuc2V0dGluZ3MgPSB7CiAgICBsaW5rU2VsZWN0b3I6ICdhJywKICAgIGZvcm1TZWxlY3RvcjogJ2Zvcm0nLAogICAgdGhyb3dFcnJvcnM6IHRydWUsCiAgICBoYW5kbGVSb3V0ZU5vdEZvdW5kOiBmYWxzZSwKICAgIGdlbmVyYXRlUmVxdWVzdE9uUGFnZUxvYWQ6IGZhbHNlCiAgfTsKCiAgLyoqCiAgICogU3RhcnRzIHRoZSBhcHAncyByb3V0aW5nLgogICAqCiAgICogQXBwcyBjcmVhdGVkIHVzaW5nIHRoZSBjb252aW5pZW5jZSBEYXZpcygpIGZ1bmN0aW9uIGFyZSBhdXRvbWF0aWNhbGx5IHN0YXJ0ZWQuCiAgICoKICAgKiBTdGFydGluZyB0aGUgYXBwIGJpbmRzIGFsbCBsaW5rcyBhbmQgZm9ybXMsIHNvIGNsaWNrcyBhbmQgc3VibWl0cwogICAqIGNyZWF0ZSBEYXZpcyByZXF1ZXN0cyB0aGF0IHdpbGwgYmUgcHVzaGVkIG9udG8gdGhlIGJyb3dzZXJzIGhpc3Rvcnkgc3RhY2suICBCcm93c2VyIGhpc3RvcnkgY2hhbmdlCiAgICogZXZlbnRzIHdpbGwgYmUgcGlja2VkIHVwIGFuZCB0aGUgcmVxdWVzdCB0aGF0IGNhdXNlZCB0aGUgY2hhbmdlIHdpbGwgYmUgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBhcHBzCiAgICogcm91dGVzIGFuZCBmaWx0ZXJzLgogICAqLwogICBBcHAucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24oKXsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBpZiAodGhpcy5ydW5uaW5nKSByZXR1cm4KCiAgICBpZiAoIURhdmlzLnN1cHBvcnRlZCgpKSB7CiAgICAgIHRoaXMudHJpZ2dlcigndW5zdXBwb3J0ZWQnKQogICAgICByZXR1cm4KICAgIH07CgogICAgdmFyIHJ1bkZpbHRlcldpdGggPSBmdW5jdGlvbiAocmVxdWVzdCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGZpbHRlcikgewogICAgICAgIHZhciByZXN1bHQgPSBmaWx0ZXIucnVuKHJlcXVlc3QsIHJlcXVlc3QpOwogICAgICAgIHJldHVybiAodHlwZW9mIHJlc3VsdCA9PT0gInVuZGVmaW5lZCIgfHwgcmVzdWx0KTsKICAgICAgfQogICAgfQoKICAgIHZhciBiZWZvcmVGaWx0ZXJzUGFzcyA9IGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICAgIHJldHVybiBEYXZpcy51dGlscy5ldmVyeSgKICAgICAgICBzZWxmLmxvb2t1cEJlZm9yZUZpbHRlcihyZXF1ZXN0Lm1ldGhvZCwgcmVxdWVzdC5wYXRoKSwKICAgICAgICBydW5GaWx0ZXJXaXRoKHJlcXVlc3QpCiAgICAgICkKICAgIH0KCiAgICB2YXIgaGFuZGxlUmVxdWVzdCA9IGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICAgIGlmIChiZWZvcmVGaWx0ZXJzUGFzcyhyZXF1ZXN0KSkgewogICAgICAgIHNlbGYudHJpZ2dlcignbG9va3VwUm91dGUnLCByZXF1ZXN0KQogICAgICAgIHZhciByb3V0ZSA9IHNlbGYubG9va3VwUm91dGUocmVxdWVzdC5tZXRob2QsIHJlcXVlc3QucGF0aCk7CiAgICAgICAgaWYgKHJvdXRlKSB7CiAgICAgICAgICBzZWxmLnRyaWdnZXIoJ3J1blJvdXRlJywgcmVxdWVzdCwgcm91dGUpOwoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJvdXRlLnJ1bihyZXF1ZXN0KQogICAgICAgICAgICBzZWxmLnRyaWdnZXIoJ3JvdXRlQ29tcGxldGUnLCByZXF1ZXN0LCByb3V0ZSkKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIHNlbGYudHJpZ2dlcigncm91dGVFcnJvcicsIHJlcXVlc3QsIHJvdXRlLCBlcnJvcikKICAgICAgICAgIH0KCiAgICAgICAgICBEYXZpcy51dGlscy5ldmVyeSgKICAgICAgICAgICAgc2VsZi5sb29rdXBBZnRlckZpbHRlcihyZXF1ZXN0Lm1ldGhvZCwgcmVxdWVzdC5wYXRoKSwKICAgICAgICAgICAgcnVuRmlsdGVyV2l0aChyZXF1ZXN0KQogICAgICAgICAgKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYudHJpZ2dlcigncm91dGVOb3RGb3VuZCcsIHJlcXVlc3QpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzZWxmLnRyaWdnZXIoJ3JlcXVlc3RIYWx0ZWQnLCByZXF1ZXN0KQogICAgICB9CiAgICB9CgogICAgdmFyIGJpbmRUb0ludGVybmFsRXZlbnRzID0gZnVuY3Rpb24gKCkgewogICAgICBzZWxmCiAgICAgICAgLmJpbmQoJ3J1blJvdXRlJywgZnVuY3Rpb24gKHJlcXVlc3QpIHsKICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oInJ1blJvdXRlOiAiICsgcmVxdWVzdC50b1N0cmluZygpKTsKICAgICAgICB9KQogICAgICAgIC5iaW5kKCdyb3V0ZU5vdEZvdW5kJywgZnVuY3Rpb24gKHJlcXVlc3QpIHsKICAgICAgICAgIGlmICghc2VsZi5zZXR0aW5ncy5oYW5kbGVSb3V0ZU5vdEZvdW5kICYmICFyZXF1ZXN0LmlzRm9yUGFnZUxvYWQpIHsKICAgICAgICAgICAgc2VsZi5zdG9wKCkKICAgICAgICAgICAgcmVxdWVzdC5kZWxlZ2F0ZVRvU2VydmVyKCkKICAgICAgICAgIH07CiAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuKCJyb3V0ZU5vdEZvdW5kOiAiICsgcmVxdWVzdC50b1N0cmluZygpKTsKICAgICAgICB9KQogICAgICAgIC5iaW5kKCdzdGFydCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oImFwcGxpY2F0aW9uIHN0YXJ0ZWQiKQogICAgICAgIH0pCiAgICAgICAgLmJpbmQoJ3N0b3AnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJhcHBsaWNhdGlvbiBzdG9wcGVkIikKICAgICAgICB9KQogICAgICAgIC5iaW5kKCdyb3V0ZUVycm9yJywgZnVuY3Rpb24gKHJlcXVlc3QsIHJvdXRlLCBlcnJvcikgewogICAgICAgICAgaWYgKHNlbGYuc2V0dGluZ3MudGhyb3dFcnJvcnMpIHRocm93KGVycm9yKQogICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZXJyb3IubWVzc2FnZSwgZXJyb3Iuc3RhY2spCiAgICAgICAgfSk7CgogICAgICBEYXZpcy5sb2NhdGlvbi5vbkNoYW5nZShmdW5jdGlvbiAocmVxKSB7CiAgICAgICAgaGFuZGxlUmVxdWVzdChyZXEpCiAgICAgIH0pOwoKICAgICAgc2VsZi5ib3VuZFRvSW50ZXJuYWxFdmVudHMgPSB0cnVlCiAgICB9CgogICAgaWYgKCF0aGlzLmJvdW5kVG9JbnRlcm5hbEV2ZW50cykgYmluZFRvSW50ZXJuYWxFdmVudHMoKQoKICAgIHRoaXMubGlzdGVuKCk7CiAgICB0aGlzLnRyaWdnZXIoJ3N0YXJ0JykKICAgIHRoaXMucnVubmluZyA9IHRydWU7CgogICAgaWYgKHRoaXMuc2V0dGluZ3MuZ2VuZXJhdGVSZXF1ZXN0T25QYWdlTG9hZCkgaGFuZGxlUmVxdWVzdChEYXZpcy5SZXF1ZXN0LmZvclBhZ2VMb2FkKCkpCgogIH07CgogIC8qKgogICAqIFN0b3BzIHRoZSBhcHAncyByb3V0aW5nLgogICAqCiAgICogU3RvcHMgdGhlIGFwcCBsaXN0ZW5pbmcgdG8gY2xpY2tzIGFuZCBzdWJtaXRzIG9uIGFsbCBmb3JtcyBhbmQgbGlua3MgZm91bmQgdXNpbmcgdGhlIGN1cnJlbnQKICAgKiBhcHBzIHNldHRpbmdzLgogICAqLwogIEFwcC5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy51bmxpc3RlbigpOwogICAgdGhpcy50cmlnZ2VyKCdzdG9wJykKICAgIHRoaXMucnVubmluZyA9IGZhbHNlCiAgfTsKCiAgcmV0dXJuIEFwcDsKfSkoKQo7CmRlZmluZSgiZGF2aXMiLCBbImpxdWVyeSJdLCAoZnVuY3Rpb24gKGdsb2JhbCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZ2xvYmFsLkRhdmlzOwogICAgfQp9KHRoaXMpKSk7CgovLyAgICAgQmFja2JvbmUuanMgMC45LjIKCi8vICAgICAoYykgMjAxMC0yMDEyIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBJbmMuCi8vICAgICBCYWNrYm9uZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKLy8gICAgIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZwoKKGZ1bmN0aW9uKCl7CgogIC8vIEluaXRpYWwgU2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIFNhdmUgYSByZWZlcmVuY2UgdG8gdGhlIGdsb2JhbCBvYmplY3QgKGB3aW5kb3dgIGluIHRoZSBicm93c2VyLCBgZ2xvYmFsYAogIC8vIG9uIHRoZSBzZXJ2ZXIpLgogIHZhciByb290ID0gdGhpczsKCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCiAgLy8gQ3JlYXRlIGEgbG9jYWwgcmVmZXJlbmNlIHRvIHNwbGljZS4KICB2YXIgc3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZTsKCiAgLy8gVGhlIHRvcC1sZXZlbCBuYW1lc3BhY2UuIEFsbCBwdWJsaWMgQmFja2JvbmUgY2xhc3NlcyBhbmQgbW9kdWxlcyB3aWxsCiAgLy8gYmUgYXR0YWNoZWQgdG8gdGhpcy4gRXhwb3J0ZWQgZm9yIGJvdGggQ29tbW9uSlMgYW5kIHRoZSBicm93c2VyLgogIHZhciBCYWNrYm9uZTsKICBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICBCYWNrYm9uZSA9IGV4cG9ydHM7CiAgfSBlbHNlIHsKICAgIEJhY2tib25lID0gcm9vdC5CYWNrYm9uZSA9IHt9OwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5LiBLZWVwIGluIHN5bmMgd2l0aCBgcGFja2FnZS5qc29uYC4KICBCYWNrYm9uZS5WRVJTSU9OID0gJzAuOS4yJzsKCiAgLy8gUmVxdWlyZSBVbmRlcnNjb3JlLCBpZiB3ZSdyZSBvbiB0aGUgc2VydmVyLCBhbmQgaXQncyBub3QgYWxyZWFkeSBwcmVzZW50LgogIHZhciBfID0gcm9vdC5fOwogIGlmICghXyAmJiAodHlwZW9mIHJlcXVpcmUgIT09ICd1bmRlZmluZWQnKSkgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsKCiAgLy8gRm9yIEJhY2tib25lJ3MgcHVycG9zZXMsIGpRdWVyeSwgWmVwdG8sIG9yIEVuZGVyIG93bnMgdGhlIGAkYCB2YXJpYWJsZS4KICBCYWNrYm9uZS4kID0gcm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyOwoKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUFVUImAgYW5kIGAiREVMRVRFImAgcmVxdWVzdHMgdmlhIHRoZSBgX21ldGhvZGAgcGFyYW1ldGVyIGFuZAogIC8vIHNldCBhIGBYLUh0dHAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgQmFja2JvbmUuZW11bGF0ZUhUVFAgPSBmYWxzZTsKCiAgLy8gVHVybiBvbiBgZW11bGF0ZUpTT05gIHRvIHN1cHBvcnQgbGVnYWN5IHNlcnZlcnMgdGhhdCBjYW4ndCBkZWFsIHdpdGggZGlyZWN0CiAgLy8gYGFwcGxpY2F0aW9uL2pzb25gIHJlcXVlc3RzIC4uLiB3aWxsIGVuY29kZSB0aGUgYm9keSBhcwogIC8vIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgIGluc3RlYWQgYW5kIHdpbGwgc2VuZCB0aGUgbW9kZWwgaW4gYQogIC8vIGZvcm0gcGFyYW0gbmFtZWQgYG1vZGVsYC4KICBCYWNrYm9uZS5lbXVsYXRlSlNPTiA9IGZhbHNlOwoKICAvLyBCYWNrYm9uZS5FdmVudHMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAogIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sgZnVuY3Rpb25zCiAgLy8gdG8gYW4gZXZlbnQ7IGB0cmlnZ2VyYC1pbmcgYW4gZXZlbnQgZmlyZXMgYWxsIGNhbGxiYWNrcyBpbiBzdWNjZXNzaW9uLgogIC8vCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogIC8vCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCiAgICAvLyBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgIC8vIGZ1bmN0aW9uLiBQYXNzaW5nIGAiYWxsImAgd2lsbCBiaW5kIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgdmFyIGNhbGxzLCBldmVudCwgbGlzdDsKICAgICAgaWYgKCFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CgogICAgICBldmVudHMgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgIGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzIHx8ICh0aGlzLl9jYWxsYmFja3MgPSB7fSk7CgogICAgICB3aGlsZSAoZXZlbnQgPSBldmVudHMuc2hpZnQoKSkgewogICAgICAgIGxpc3QgPSBjYWxsc1tldmVudF0gfHwgKGNhbGxzW2V2ZW50XSA9IFtdKTsKICAgICAgICBsaXN0LnB1c2goY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGNhbGxiYWNrcwogICAgLy8gd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGNhbGxiYWNrcyBmb3IgdGhlCiAgICAvLyBldmVudC4gSWYgYGV2ZW50c2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgYm91bmQgY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgogICAgb2ZmOiBmdW5jdGlvbihldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciBldmVudCwgY2FsbHMsIGxpc3QsIGk7CgogICAgICAvLyBObyBldmVudHMsIG9yIHJlbW92aW5nICphbGwqIGV2ZW50cy4KICAgICAgaWYgKCEoY2FsbHMgPSB0aGlzLl9jYWxsYmFja3MpKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCEoZXZlbnRzIHx8IGNhbGxiYWNrIHx8IGNvbnRleHQpKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2NhbGxiYWNrczsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgZXZlbnRzID0gZXZlbnRzID8gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpIDogXy5rZXlzKGNhbGxzKTsKCiAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgY2FsbGJhY2sgbGlzdCwgc3BsaWNpbmcgd2hlcmUgYXBwcm9wcmlhdGUuCiAgICAgIHdoaWxlIChldmVudCA9IGV2ZW50cy5zaGlmdCgpKSB7CiAgICAgICAgaWYgKCEobGlzdCA9IGNhbGxzW2V2ZW50XSkgfHwgIShjYWxsYmFjayB8fCBjb250ZXh0KSkgewogICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgZm9yIChpID0gbGlzdC5sZW5ndGggLSAyOyBpID49IDA7IGkgLT0gMikgewogICAgICAgICAgaWYgKCEoY2FsbGJhY2sgJiYgbGlzdFtpXSAhPT0gY2FsbGJhY2sgfHwgY29udGV4dCAmJiBsaXN0W2kgKyAxXSAhPT0gY29udGV4dCkpIHsKICAgICAgICAgICAgbGlzdC5zcGxpY2UoaSwgMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIHZhciBldmVudCwgY2FsbHMsIGxpc3QsIGksIGxlbmd0aCwgYXJncywgYWxsLCByZXN0OwogICAgICBpZiAoIShjYWxscyA9IHRoaXMuX2NhbGxiYWNrcykpIHJldHVybiB0aGlzOwoKICAgICAgcmVzdCA9IFtdOwogICAgICBldmVudHMgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CgogICAgICAvLyBGaWxsIHVwIGByZXN0YCB3aXRoIHRoZSBjYWxsYmFjayBhcmd1bWVudHMuICBTaW5jZSB3ZSdyZSBvbmx5IGNvcHlpbmcKICAgICAgLy8gdGhlIHRhaWwgb2YgYGFyZ3VtZW50c2AsIGEgbG9vcCBpcyBtdWNoIGZhc3RlciB0aGFuIEFycmF5I3NsaWNlLgogICAgICBmb3IgKGkgPSAxLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICByZXN0W2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgfQoKICAgICAgLy8gRm9yIGVhY2ggZXZlbnQsIHdhbGsgdGhyb3VnaCB0aGUgbGlzdCBvZiBjYWxsYmFja3MgdHdpY2UsIGZpcnN0IHRvCiAgICAgIC8vIHRyaWdnZXIgdGhlIGV2ZW50LCB0aGVuIHRvIHRyaWdnZXIgYW55IGAiYWxsImAgY2FsbGJhY2tzLgogICAgICB3aGlsZSAoZXZlbnQgPSBldmVudHMuc2hpZnQoKSkgewogICAgICAgIC8vIENvcHkgY2FsbGJhY2sgbGlzdHMgdG8gcHJldmVudCBtb2RpZmljYXRpb24uCiAgICAgICAgaWYgKGFsbCA9IGNhbGxzLmFsbCkgYWxsID0gYWxsLnNsaWNlKCk7CiAgICAgICAgaWYgKGxpc3QgPSBjYWxsc1tldmVudF0pIGxpc3QgPSBsaXN0LnNsaWNlKCk7CgogICAgICAgIC8vIEV4ZWN1dGUgZXZlbnQgY2FsbGJhY2tzLgogICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgIGxpc3RbaV0uYXBwbHkobGlzdFtpICsgMV0gfHwgdGhpcywgcmVzdCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBFeGVjdXRlICJhbGwiIGNhbGxiYWNrcy4KICAgICAgICBpZiAoYWxsKSB7CiAgICAgICAgICBhcmdzID0gW2V2ZW50XS5jb25jYXQocmVzdCk7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBhbGwubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgYWxsW2ldLmFwcGx5KGFsbFtpICsgMV0gfHwgdGhpcywgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgfTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwsIHdpdGggZGVmaW5lZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApCiAgLy8gaXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIGFzc2lnbmVkIGZvciB5b3UuCiAgdmFyIE1vZGVsID0gQmFja2JvbmUuTW9kZWwgPSBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICB2YXIgZGVmYXVsdHM7CiAgICBhdHRyaWJ1dGVzIHx8IChhdHRyaWJ1dGVzID0ge30pOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb2xsZWN0aW9uKSB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnBhcnNlKSBhdHRyaWJ1dGVzID0gdGhpcy5wYXJzZShhdHRyaWJ1dGVzKTsKICAgIGlmIChkZWZhdWx0cyA9IGdldFZhbHVlKHRoaXMsICdkZWZhdWx0cycpKSB7CiAgICAgIGF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgZGVmYXVsdHMsIGF0dHJpYnV0ZXMpOwogICAgfQogICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgICB0aGlzLl9lc2NhcGVkQXR0cmlidXRlcyA9IHt9OwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuX3NpbGVudCA9IHt9OwogICAgdGhpcy5fcGVuZGluZyA9IHt9OwogICAgdGhpcy5zZXQoYXR0cmlidXRlcywge3NpbGVudDogdHJ1ZX0pOwogICAgLy8gUmVzZXQgY2hhbmdlIHRyYWNraW5nLgogICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICB0aGlzLl9zaWxlbnQgPSB7fTsKICAgIHRoaXMuX3BlbmRpbmcgPSB7fTsKICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBBIGhhc2ggb2YgYXR0cmlidXRlcyB0aGF0IGhhdmUgc2lsZW50bHkgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCB0aW1lCiAgICAvLyBgY2hhbmdlYCB3YXMgY2FsbGVkLiAgV2lsbCBiZWNvbWUgcGVuZGluZyBhdHRyaWJ1dGVzIG9uIHRoZSBuZXh0IGNhbGwuCiAgICBfc2lsZW50OiBudWxsLAoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAnY2hhbmdlJ2AgZXZlbnQKICAgIC8vIGJlZ2FuLgogICAgX3BlbmRpbmc6IG51bGwsCgogICAgLy8gVGhlIGRlZmF1bHQgbmFtZSBmb3IgdGhlIEpTT04gYGlkYCBhdHRyaWJ1dGUgaXMgYCJpZCJgLiBNb25nb0RCIGFuZAogICAgLy8gQ291Y2hEQiB1c2VycyBtYXkgd2FudCB0byBzZXQgdGhpcyB0byBgIl9pZCJgLgogICAgaWRBdHRyaWJ1dGU6ICdpZCcsCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBtb2RlbCdzIGBhdHRyaWJ1dGVzYCBvYmplY3QuCiAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCiAgICBzeW5jOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBnZXQ6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1thdHRyXTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBIVE1MLWVzY2FwZWQgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZXNjYXBlOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHZhciBodG1sOwogICAgICBpZiAoaHRtbCA9IHRoaXMuX2VzY2FwZWRBdHRyaWJ1dGVzW2F0dHJdKSByZXR1cm4gaHRtbDsKICAgICAgdmFyIHZhbCA9IHRoaXMuZ2V0KGF0dHIpOwogICAgICByZXR1cm4gdGhpcy5fZXNjYXBlZEF0dHJpYnV0ZXNbYXR0cl0gPSBfLmVzY2FwZSh2YWwgPT0gbnVsbCA/ICcnIDogJycgKyB2YWwpOwogICAgfSwKCiAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgLy8gb3IgdW5kZWZpbmVkLgogICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzCiAgICAvLyB5b3UgY2hvb3NlIHRvIHNpbGVuY2UgaXQuCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBhdHRyLCB2YWw7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKF8uaXNPYmplY3Qoa2V5KSB8fCBrZXkgPT0gbnVsbCkgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhdHRycyA9IHt9OwogICAgICAgIGF0dHJzW2tleV0gPSB2YWx1ZTsKICAgICAgfQoKICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBpZiAoIWF0dHJzKSByZXR1cm4gdGhpczsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIGF0dHJzID0gYXR0cnMuYXR0cmlidXRlczsKICAgICAgaWYgKG9wdGlvbnMudW5zZXQpIGZvciAoYXR0ciBpbiBhdHRycykgYXR0cnNbYXR0cl0gPSB2b2lkIDA7CgogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgICB2YXIgY2hhbmdlcyA9IG9wdGlvbnMuY2hhbmdlcyA9IHt9OwogICAgICB2YXIgbm93ID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgICB2YXIgZXNjYXBlZCA9IHRoaXMuX2VzY2FwZWRBdHRyaWJ1dGVzOwogICAgICB2YXIgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyB8fCB7fTsKCiAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZS4uLgogICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKICAgICAgICB2YWwgPSBhdHRyc1thdHRyXTsKCiAgICAgICAgLy8gSWYgdGhlIG5ldyBhbmQgY3VycmVudCB2YWx1ZSBkaWZmZXIsIHJlY29yZCB0aGUgY2hhbmdlLgogICAgICAgIGlmICghXy5pc0VxdWFsKG5vd1thdHRyXSwgdmFsKSB8fCAob3B0aW9ucy51bnNldCAmJiBfLmhhcyhub3csIGF0dHIpKSkgewogICAgICAgICAgZGVsZXRlIGVzY2FwZWRbYXR0cl07CiAgICAgICAgICAob3B0aW9ucy5zaWxlbnQgPyB0aGlzLl9zaWxlbnQgOiBjaGFuZ2VzKVthdHRyXSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgogICAgICAgIG9wdGlvbnMudW5zZXQgPyBkZWxldGUgbm93W2F0dHJdIDogbm93W2F0dHJdID0gdmFsOwoKICAgICAgICAvLyBJZiB0aGUgbmV3IGFuZCBwcmV2aW91cyB2YWx1ZSBkaWZmZXIsIHJlY29yZCB0aGUgY2hhbmdlLiAgSWYgbm90LAogICAgICAgIC8vIHRoZW4gcmVtb3ZlIGNoYW5nZXMgZm9yIHRoaXMgYXR0cmlidXRlLgogICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkgfHwgKF8uaGFzKG5vdywgYXR0cikgIT09IF8uaGFzKHByZXYsIGF0dHIpKSkgewogICAgICAgICAgdGhpcy5jaGFuZ2VkW2F0dHJdID0gdmFsOwogICAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy5fcGVuZGluZ1thdHRyXSA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgICBkZWxldGUgdGhpcy5fcGVuZGluZ1thdHRyXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEZpcmUgdGhlIGAiY2hhbmdlImAgZXZlbnRzLgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLmNoYW5nZShvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgIHVubGVzcyB5b3UgY2hvb3NlCiAgICAvLyB0byBzaWxlbmNlIGl0LiBgdW5zZXRgIGlzIGEgbm9vcCBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCiAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pOwogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0ciwgbnVsbCwgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UKICAgIC8vIHRvIHNpbGVuY2UgaXQuCiAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pOwogICAgICByZXR1cm4gdGhpcy5zZXQoXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQogICAgLy8gbW9kZWwgZGlmZmVycyBmcm9tIGl0cyBjdXJyZW50IGF0dHJpYnV0ZXMsIHRoZXkgd2lsbCBiZSBvdmVycmlkZW4sCiAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwLCB4aHIpLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICBvcHRpb25zLmVycm9yID0gQmFja2JvbmUud3JhcEVycm9yKG9wdGlvbnMuZXJyb3IsIG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWx1ZSwgb3B0aW9ucykgewogICAgICB2YXIgYXR0cnMsIGN1cnJlbnQsIGRvbmU7CgogICAgICAvLyBIYW5kbGUgYm90aCBgKCJrZXkiLCB2YWx1ZSlgIGFuZCBgKHtrZXk6IHZhbHVlfSlgIC1zdHlsZSBjYWxscy4KICAgICAgaWYgKF8uaXNPYmplY3Qoa2V5KSB8fCBrZXkgPT0gbnVsbCkgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhdHRycyA9IHt9OwogICAgICAgIGF0dHJzW2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCiAgICAgIC8vIElmIHdlJ3JlICJ3YWl0Ii1pbmcgdG8gc2V0IGNoYW5nZWQgYXR0cmlidXRlcywgdmFsaWRhdGUgZWFybHkuCiAgICAgIGlmIChvcHRpb25zLndhaXQpIHsKICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGN1cnJlbnQgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgIH0KCiAgICAgIC8vIFJlZ3VsYXIgc2F2ZXMgYHNldGAgYXR0cmlidXRlcyBiZWZvcmUgcGVyc2lzdGluZyB0byB0aGUgc2VydmVyLgogICAgICB2YXIgc2lsZW50T3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7c2lsZW50OiB0cnVlfSk7CiAgICAgIGlmIChhdHRycyAmJiAhdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMud2FpdCA/IHNpbGVudE9wdGlvbnMgOiBvcHRpb25zKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gRG8gbm90IHBlcnNpc3QgaW52YWxpZCBtb2RlbHMuCiAgICAgIGlmICghYXR0cnMgJiYgIXRoaXMuaXNWYWxpZCgpKSByZXR1cm4gZmFsc2U7CgogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7CiAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgeGhyKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICAvLyBGaW5pc2ggY29uZmlndXJpbmcgYW5kIHNlbmRpbmcgdGhlIEFqYXggcmVxdWVzdC4KICAgICAgb3B0aW9ucy5lcnJvciA9IEJhY2tib25lLndyYXBFcnJvcihvcHRpb25zLmVycm9yLCBtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmModGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiAndXBkYXRlJywgdGhpcywgb3B0aW9ucyk7CgogICAgICAvLyBXaGVuIHVzaW5nIGB3YWl0YCwgcmVzZXQgYXR0cmlidXRlcyB0byBvcmlnaW5hbCB2YWx1ZXMgdW5sZXNzCiAgICAgIC8vIGBzdWNjZXNzYCBoYXMgYmVlbiBjYWxsZWQgYWxyZWFkeS4KICAgICAgaWYgKCFkb25lICYmIG9wdGlvbnMud2FpdCkgewogICAgICAgIHRoaXMuY2xlYXIoc2lsZW50T3B0aW9ucyk7CiAgICAgICAgdGhpcy5zZXQoY3VycmVudCwgc2lsZW50T3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCB8fCBtb2RlbC5pc05ldygpKSBkZXN0cm95KCk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmICghbW9kZWwuaXNOZXcoKSkgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMuZXJyb3IgPSBCYWNrYm9uZS53cmFwRXJyb3Iob3B0aW9ucy5lcnJvciwgbW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBnZXRWYWx1ZSh0aGlzLCAndXJsUm9vdCcpIHx8IGdldFZhbHVlKHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIHhocikgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBBIG1vZGVsIGlzIG5ldyBpZiBpdCBoYXMgbmV2ZXIgYmVlbiBzYXZlZCB0byB0aGUgc2VydmVyLCBhbmQgbGFja3MgYW4gaWQuCiAgICBpc05ldzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlkID09IG51bGw7CiAgICB9LAoKICAgIC8vIENhbGwgdGhpcyBtZXRob2QgdG8gbWFudWFsbHkgZmlyZSBhIGAiY2hhbmdlImAgZXZlbnQgZm9yIHRoaXMgbW9kZWwgYW5kCiAgICAvLyBhIGAiY2hhbmdlOmF0dHJpYnV0ZSJgIGV2ZW50IGZvciBlYWNoIGNoYW5nZWQgYXR0cmlidXRlLgogICAgLy8gQ2FsbGluZyB0aGlzIHdpbGwgY2F1c2UgYWxsIG9iamVjdHMgb2JzZXJ2aW5nIHRoZSBtb2RlbCB0byB1cGRhdGUuCiAgICBjaGFuZ2U6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgdmFyIGNoYW5naW5nID0gdGhpcy5fY2hhbmdpbmc7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gdHJ1ZTsKCiAgICAgIC8vIFNpbGVudCBjaGFuZ2VzIGJlY29tZSBwZW5kaW5nIGNoYW5nZXMuCiAgICAgIGZvciAodmFyIGF0dHIgaW4gdGhpcy5fc2lsZW50KSB0aGlzLl9wZW5kaW5nW2F0dHJdID0gdHJ1ZTsKCiAgICAgIC8vIFNpbGVudCBjaGFuZ2VzIGFyZSB0cmlnZ2VyZWQuCiAgICAgIHZhciBjaGFuZ2VzID0gXy5leHRlbmQoe30sIG9wdGlvbnMuY2hhbmdlcywgdGhpcy5fc2lsZW50KTsKICAgICAgdGhpcy5fc2lsZW50ID0ge307CiAgICAgIGZvciAodmFyIGF0dHIgaW4gY2hhbmdlcykgewogICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBhdHRyLCB0aGlzLCB0aGlzLmdldChhdHRyKSwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKCiAgICAgIC8vIENvbnRpbnVlIGZpcmluZyBgImNoYW5nZSJgIGV2ZW50cyB3aGlsZSB0aGVyZSBhcmUgcGVuZGluZyBjaGFuZ2VzLgogICAgICB3aGlsZSAoIV8uaXNFbXB0eSh0aGlzLl9wZW5kaW5nKSkgewogICAgICAgIHRoaXMuX3BlbmRpbmcgPSB7fTsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIC8vIFBlbmRpbmcgYW5kIHNpbGVudCBjaGFuZ2VzIHN0aWxsIHJlbWFpbi4KICAgICAgICBmb3IgKHZhciBhdHRyIGluIHRoaXMuY2hhbmdlZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BlbmRpbmdbYXR0cl0gfHwgdGhpcy5fc2lsZW50W2F0dHJdKSBjb250aW51ZTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgfQogICAgICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgfQoKICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwogICAgfSwKCiAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CiAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQogICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuCiAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewogICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2UsIG9sZCA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CiAgICAgICAgaWYgKF8uaXNFcXVhbChvbGRbYXR0cl0sICh2YWwgPSBkaWZmW2F0dHJdKSkpIGNvbnRpbnVlOwogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CiAgICAvLyBgImNoYW5nZSJgIGV2ZW50IHdhcyBmaXJlZC4KICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwogICAgLy8gYCJjaGFuZ2UiYCBldmVudC4KICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIENoZWNrIGlmIHRoZSBtb2RlbCBpcyBjdXJyZW50bHkgaW4gYSB2YWxpZCBzdGF0ZS4gSXQncyBvbmx5IHBvc3NpYmxlIHRvCiAgICAvLyBnZXQgaW50byBhbiAqaW52YWxpZCogc3RhdGUgaWYgeW91J3JlIHVzaW5nIHNpbGVudCBjaGFuZ2VzLgogICAgaXNWYWxpZDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAhdGhpcy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gSWYgYSBzcGVjaWZpYyBgZXJyb3JgIGNhbGxiYWNrIGhhcwogICAgLy8gYmVlbiBwYXNzZWQsIGNhbGwgdGhhdCBpbnN0ZWFkIG9mIGZpcmluZyB0aGUgZ2VuZXJhbCBgImVycm9yImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zLnNpbGVudCB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZXJyb3IpIHsKICAgICAgICBvcHRpb25zLmVycm9yKHRoaXMsIGVycm9yLCBvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgdGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkNvbGxlY3Rpb24KICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFByb3ZpZGVzIGEgc3RhbmRhcmQgY29sbGVjdGlvbiBjbGFzcyBmb3Igb3VyIHNldHMgb2YgbW9kZWxzLCBvcmRlcmVkCiAgLy8gb3IgdW5vcmRlcmVkLiBJZiBhIGBjb21wYXJhdG9yYCBpcyBzcGVjaWZpZWQsIHRoZSBDb2xsZWN0aW9uIHdpbGwgbWFpbnRhaW4KICAvLyBpdHMgbW9kZWxzIGluIHNvcnQgb3JkZXIsIGFzIHRoZXkncmUgYWRkZWQgYW5kIHJlbW92ZWQuCiAgdmFyIENvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uID0gZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMubW9kZWwpIHRoaXMubW9kZWwgPSBvcHRpb25zLm1vZGVsOwogICAgaWYgKG9wdGlvbnMuY29tcGFyYXRvciAhPT0gdm9pZCAwKSB0aGlzLmNvbXBhcmF0b3IgPSBvcHRpb25zLmNvbXBhcmF0b3I7CiAgICB0aGlzLl9yZXNldCgpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAobW9kZWxzKSB0aGlzLnJlc2V0KG1vZGVscywge3NpbGVudDogdHJ1ZSwgcGFyc2U6IG9wdGlvbnMucGFyc2V9KTsKICB9OwoKICAvLyBEZWZpbmUgdGhlIENvbGxlY3Rpb24ncyBpbmhlcml0YWJsZSBtZXRob2RzLgogIF8uZXh0ZW5kKENvbGxlY3Rpb24ucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBtb2RlbCBmb3IgYSBjb2xsZWN0aW9uIGlzIGp1c3QgYSAqKkJhY2tib25lLk1vZGVsKiouCiAgICAvLyBUaGlzIHNob3VsZCBiZSBvdmVycmlkZGVuIGluIG1vc3QgY2FzZXMuCiAgICBtb2RlbDogTW9kZWwsCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyBUaGUgSlNPTiByZXByZXNlbnRhdGlvbiBvZiBhIENvbGxlY3Rpb24gaXMgYW4gYXJyYXkgb2YgdGhlCiAgICAvLyBtb2RlbHMnIGF0dHJpYnV0ZXMuCiAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKG1vZGVsKXsgcmV0dXJuIG1vZGVsLnRvSlNPTihvcHRpb25zKTsgfSk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsLCBvciBsaXN0IG9mIG1vZGVscyB0byB0aGUgc2V0LiBQYXNzICoqc2lsZW50KiogdG8gYXZvaWQKICAgIC8vIGZpcmluZyB0aGUgYGFkZGAgZXZlbnQgZm9yIGV2ZXJ5IG5ldyBtb2RlbC4KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBpLCBpbmRleCwgbGVuZ3RoLCBtb2RlbCwgY2lkLCBpZCwgY2lkcyA9IHt9LCBpZHMgPSB7fSwgZHVwcyA9IFtdOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CgogICAgICAvLyBCZWdpbiBieSB0dXJuaW5nIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50aW5nCiAgICAgIC8vIGludmFsaWQgbW9kZWxzIG9yIGR1cGxpY2F0ZSBtb2RlbHMgZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbW9kZWxzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKCEobW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWxzW2ldLCBvcHRpb25zKSkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2FuJ3QgYWRkIGFuIGludmFsaWQgbW9kZWwgdG8gYSBjb2xsZWN0aW9uIik7CiAgICAgICAgfQogICAgICAgIGNpZCA9IG1vZGVsLmNpZDsKICAgICAgICBpZCA9IG1vZGVsLmlkOwogICAgICAgIGlmIChjaWRzW2NpZF0gfHwgdGhpcy5fYnlDaWRbY2lkXSB8fCAoKGlkICE9IG51bGwpICYmIChpZHNbaWRdIHx8IHRoaXMuX2J5SWRbaWRdKSkpIHsKICAgICAgICAgIGR1cHMucHVzaChpKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBjaWRzW2NpZF0gPSBpZHNbaWRdID0gbW9kZWw7CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzLgogICAgICBpID0gZHVwcy5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICBkdXBzW2ldID0gbW9kZWxzLnNwbGljZShkdXBzW2ldLCAxKVswXTsKICAgICAgfQoKICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgLy8gYGlkYCBhbmQgYnkgYGNpZGAuCiAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIChtb2RlbCA9IG1vZGVsc1tpXSkub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICAgICAgdGhpcy5fYnlDaWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CgogICAgICAvLyBJbnNlcnQgbW9kZWxzIGludG8gdGhlIGNvbGxlY3Rpb24sIHJlLXNvcnRpbmcgaWYgbmVlZGVkLCBhbmQgdHJpZ2dlcmluZwogICAgICAvLyBgYWRkYCBldmVudHMgdW5sZXNzIHNpbGVuY2VkLgogICAgICB0aGlzLmxlbmd0aCArPSBsZW5ndGg7CiAgICAgIGluZGV4ID0gb3B0aW9ucy5hdCAhPSBudWxsID8gb3B0aW9ucy5hdCA6IHRoaXMubW9kZWxzLmxlbmd0aDsKICAgICAgc3BsaWNlLmFwcGx5KHRoaXMubW9kZWxzLCBbaW5kZXgsIDBdLmNvbmNhdChtb2RlbHMpKTsKCiAgICAgIC8vIE1lcmdlIGluIGR1cGxpY2F0ZSBtb2RlbHMuCiAgICAgIGlmIChvcHRpb25zLm1lcmdlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gZHVwcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKG1vZGVsID0gdGhpcy5fYnlJZFtkdXBzW2ldLmlkXSkgbW9kZWwuc2V0KGR1cHNbaV0sIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKHRoaXMuY29tcGFyYXRvciAmJiBvcHRpb25zLmF0ID09IG51bGwpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CgogICAgICBpZiAob3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzOwogICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGlmICghY2lkc1sobW9kZWwgPSB0aGlzLm1vZGVsc1tpXSkuY2lkXSkgY29udGludWU7CiAgICAgICAgb3B0aW9ucy5pbmRleCA9IGk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwsIG9yIGEgbGlzdCBvZiBtb2RlbHMgZnJvbSB0aGUgc2V0LiBQYXNzIHNpbGVudCB0byBhdm9pZAogICAgLy8gZmlyaW5nIHRoZSBgcmVtb3ZlYCBldmVudCBmb3IgZXZlcnkgbW9kZWwgcmVtb3ZlZC4KICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIG1vZGVscyA9IF8uaXNBcnJheShtb2RlbHMpID8gbW9kZWxzLnNsaWNlKCkgOiBbbW9kZWxzXTsKICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IHRoaXMuZ2V0QnlDaWQobW9kZWxzW2ldKSB8fCB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlDaWRbbW9kZWwuY2lkXTsKICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHB1c2g6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KHRoaXMubGVuZ3RoIC0gMSk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHNoaWZ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICBzbGljZTogZnVuY3Rpb24oYmVnaW4sIGVuZCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHMuc2xpY2UoYmVnaW4sIGVuZCk7CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgIGdldDogZnVuY3Rpb24oaWQpIHsKICAgICAgaWYgKGlkID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLl9ieUlkW2lkLmlkICE9IG51bGwgPyBpZC5pZCA6IGlkXTsKICAgIH0sCgogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGNsaWVudCBpZC4KICAgIGdldEJ5Q2lkOiBmdW5jdGlvbihjaWQpIHsKICAgICAgcmV0dXJuIGNpZCAmJiB0aGlzLl9ieUNpZFtjaWQuY2lkIHx8IGNpZF07CiAgICB9LAoKICAgIC8vIEdldCB0aGUgbW9kZWwgYXQgdGhlIGdpdmVuIGluZGV4LgogICAgYXQ6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGVsc1tpbmRleF07CiAgICB9LAoKICAgIC8vIFJldHVybiBtb2RlbHMgd2l0aCBtYXRjaGluZyBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIHNpbXBsZSBjYXNlcyBvZiBgZmlsdGVyYC4KICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycykgewogICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIFtdOwogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICAgIGlmIChhdHRyc1trZXldICE9PSBtb2RlbC5nZXQoa2V5KSkgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIEZvcmNlIHRoZSBjb2xsZWN0aW9uIHRvIHJlLXNvcnQgaXRzZWxmLiBZb3UgZG9uJ3QgbmVlZCB0byBjYWxsIHRoaXMgdW5kZXIKICAgIC8vIG5vcm1hbCBjaXJjdW1zdGFuY2VzLCBhcyB0aGUgc2V0IHdpbGwgbWFpbnRhaW4gc29ydCBvcmRlciBhcyBlYWNoIGl0ZW0KICAgIC8vIGlzIGFkZGVkLgogICAgc29ydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBpZiAoIXRoaXMuY29tcGFyYXRvcikgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc29ydCBhIHNldCB3aXRob3V0IGEgY29tcGFyYXRvcicpOwogICAgICB2YXIgYm91bmRDb21wYXJhdG9yID0gXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIGlmICh0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeShib3VuZENvbXBhcmF0b3IpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoYm91bmRDb21wYXJhdG9yKTsKICAgICAgfQogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBQbHVjayBhbiBhdHRyaWJ1dGUgZnJvbSBlYWNoIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgogICAgcGx1Y2s6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8ubWFwKHRoaXMubW9kZWxzLCBmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC5nZXQoYXR0cik7IH0pOwogICAgfSwKCiAgICAvLyBXaGVuIHlvdSBoYXZlIG1vcmUgaXRlbXMgdGhhbiB5b3Ugd2FudCB0byBhZGQgb3IgcmVtb3ZlIGluZGl2aWR1YWxseSwKICAgIC8vIHlvdSBjYW4gcmVzZXQgdGhlIGVudGlyZSBzZXQgd2l0aCBhIG5ldyBsaXN0IG9mIG1vZGVscywgd2l0aG91dCBmaXJpbmcKICAgIC8vIGFueSBgYWRkYCBvciBgcmVtb3ZlYCBldmVudHMuIEZpcmVzIGByZXNldGAgd2hlbiBmaW5pc2hlZC4KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgbW9kZWxzICB8fCAobW9kZWxzID0gW10pOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSk7CiAgICAgIH0KICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYGFkZDogdHJ1ZWAgaXMgcGFzc2VkLCBhcHBlbmRzIHRoZQogICAgLy8gbW9kZWxzIHRvIHRoZSBjb2xsZWN0aW9uIGluc3RlYWQgb2YgcmVzZXR0aW5nLgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwLCBzdGF0dXMsIHhocikgewogICAgICAgIGNvbGxlY3Rpb25bb3B0aW9ucy5hZGQgPyAnYWRkJyA6ICdyZXNldCddKGNvbGxlY3Rpb24ucGFyc2UocmVzcCwgeGhyKSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgY29sbGVjdGlvbi50cmlnZ2VyKCdzeW5jJywgY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG9wdGlvbnMuZXJyb3IgPSBCYWNrYm9uZS53cmFwRXJyb3Iob3B0aW9ucy5lcnJvciwgY29sbGVjdGlvbiwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHZhciBjb2xsID0gdGhpczsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgY29sbC5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24obW9kZWwsIHJlc3AsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBjb2xsLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICBtb2RlbC5zYXZlKG51bGwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gYSBsaXN0IG9mIG1vZGVscyB0byBiZSBhZGRlZCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIHhocikgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByb3h5IHRvIF8ncyBjaGFpbi4gQ2FuJ3QgYmUgcHJveGllZCB0aGUgc2FtZSB3YXkgdGhlIHJlc3Qgb2YgdGhlCiAgICAvLyB1bmRlcnNjb3JlIG1ldGhvZHMgYXJlIHByb3hpZWQgYmVjYXVzZSBpdCByZWxpZXMgb24gdGhlIHVuZGVyc2NvcmUKICAgIC8vIGNvbnN0cnVjdG9yLgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXyh0aGlzLm1vZGVscykuY2hhaW4oKTsKICAgIH0sCgogICAgLy8gUmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbiBpcyByZXNldC4KICAgIF9yZXNldDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzID0gW107CiAgICAgIHRoaXMuX2J5SWQgID0ge307CiAgICAgIHRoaXMuX2J5Q2lkID0ge307CiAgICB9LAoKICAgIC8vIFByZXBhcmUgYSBtb2RlbCBvciBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYWRkZWQgdG8gdGhpcyBjb2xsZWN0aW9uLgogICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKICAgICAgICBpZiAoIWF0dHJzLmNvbGxlY3Rpb24pIGF0dHJzLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICAgIHJldHVybiBhdHRyczsKICAgICAgfQogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwuX3ZhbGlkYXRlKG1vZGVsLmF0dHJpYnV0ZXMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbW92ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgdmFyIG1ldGhvZHMgPSBbJ2ZvckVhY2gnLCAnZWFjaCcsICdtYXAnLCAncmVkdWNlJywgJ3JlZHVjZVJpZ2h0JywgJ2ZpbmQnLAogICAgJ2RldGVjdCcsICdmaWx0ZXInLCAnc2VsZWN0JywgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLAogICAgJ2luY2x1ZGUnLCAnY29udGFpbnMnLCAnaW52b2tlJywgJ21heCcsICdtaW4nLCAnc29ydEJ5JywgJ3NvcnRlZEluZGV4JywKICAgICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaW5pdGlhbCcsICdyZXN0JywgJ2xhc3QnLCAnd2l0aG91dCcsICdpbmRleE9mJywKICAgICdzaHVmZmxlJywgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnZ3JvdXBCeSddOwoKICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBDb2xsZWN0aW9uI21vZGVsc2AuCiAgXy5lYWNoKG1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIFt0aGlzLm1vZGVsc10uY29uY2F0KF8udG9BcnJheShhcmd1bWVudHMpKSk7CiAgICB9OwogIH0pOwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJvdXRlcnMgbWFwIGZhdXgtVVJMcyB0byBhY3Rpb25zLCBhbmQgZmlyZSBldmVudHMgd2hlbiByb3V0ZXMgYXJlCiAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KICB2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKICAvLyBwYXJ0cyBvZiByb3V0ZSBzdHJpbmdzLgogIHZhciBuYW1lZFBhcmFtICAgID0gLzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgID0gL1stW1xde30oKSs/LixcXF4kfCNcc10vZzsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlJvdXRlcioqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoUm91dGVyLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyBNYW51YWxseSBiaW5kIGEgc2luZ2xlIG5hbWVkIHJvdXRlIHRvIGEgY2FsbGJhY2suIEZvciBleGFtcGxlOgogICAgLy8KICAgIC8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsKICAgIC8vICAgICAgIC4uLgogICAgLy8gICAgIH0pOwogICAgLy8KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeSB8fCAoQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5KTsKICAgICAgaWYgKCFfLmlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKICAgICAgaWYgKCFjYWxsYmFjaykgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwogICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBfLmJpbmQoZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgICB2YXIgYXJncyA9IHRoaXMuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHRoaXMsIG5hbWUsIGFyZ3MpOwogICAgICB9LCB0aGlzKSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCiAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKICAgICAgdmFyIHJvdXRlcyA9IFtdOwogICAgICBmb3IgKHZhciByb3V0ZSBpbiB0aGlzLnJvdXRlcykgewogICAgICAgIHJvdXRlcy51bnNoaWZ0KFtyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdXSk7CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSByb3V0ZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZXNbaV1bMF0sIHJvdXRlc1tpXVsxXSwgdGhpc1tyb3V0ZXNbaV1bMV1dKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sICcoW15cL10rKScpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOwogICAgfSwKCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgcGFyYW1ldGVycy4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHJldHVybiByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkhpc3RvcnkKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIFVSTCBmcmFnbWVudHMuIElmIHRoZQogIC8vIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBgb25oYXNoY2hhbmdlYCwgZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKICAgIF8uYmluZEFsbCh0aGlzLCAnY2hlY2tVcmwnKTsKICAgIHRoaXMubG9jYXRpb24gPSBvcHRpb25zICYmIG9wdGlvbnMubG9jYXRpb24gfHwgcm9vdC5sb2NhdGlvbjsKICAgIHRoaXMuaGlzdG9yeSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5oaXN0b3J5IHx8IHJvb3QuaGlzdG9yeTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIGNsZWFuaW5nIGxlYWRpbmcgaGFzaGVzIGFuZCBzbGFzaGVzIC4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL10vOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgogIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgogIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CgogIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgIGludGVydmFsOiA1MCwKCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewogICAgICB2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewogICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lOwogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLm9wdGlvbnMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpKTsKICAgIH0sCgogICAgLy8gU3RhcnQgdGhlIGhhc2ggY2hhbmdlIGhhbmRsaW5nLCByZXR1cm5pbmcgYHRydWVgIGlmIHRoZSBjdXJyZW50IFVSTCBtYXRjaGVzCiAgICAvLyBhbiBleGlzdGluZyByb3V0ZSwgYW5kIGBmYWxzZWAgb3RoZXJ3aXNlLgogICAgc3RhcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKEhpc3Rvcnkuc3RhcnRlZCkgdGhyb3cgbmV3IEVycm9yKCJCYWNrYm9uZS5oaXN0b3J5IGhhcyBhbHJlYWR5IGJlZW4gc3RhcnRlZCIpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSB0cnVlOwoKICAgICAgLy8gRmlndXJlIG91dCB0aGUgaW5pdGlhbCBjb25maWd1cmF0aW9uLiBEbyB3ZSBuZWVkIGFuIGlmcmFtZT8KICAgICAgLy8gSXMgcHVzaFN0YXRlIGRlc2lyZWQgLi4uIGlzIGl0IGF2YWlsYWJsZT8KICAgICAgdGhpcy5vcHRpb25zICAgICAgICAgID0gXy5leHRlbmQoe30sIHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgICB0aGlzLl93YW50c0hhc2hDaGFuZ2UgPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CiAgICAgIHRoaXMuX3dhbnRzUHVzaFN0YXRlICA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKICAgICAgdGhpcy5faGFzUHVzaFN0YXRlICAgID0gISEodGhpcy5vcHRpb25zLnB1c2hTdGF0ZSAmJiB0aGlzLmhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5LnB1c2hTdGF0ZSk7CiAgICAgIHZhciBmcmFnbWVudCAgICAgICAgICA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgdmFyIGRvY01vZGUgICAgICAgICAgID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwogICAgICB2YXIgb2xkSUUgICAgICAgICAgICAgPSAoaXNFeHBsb3Jlci5leGVjKG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSkgJiYgKCFkb2NNb2RlIHx8IGRvY01vZGUgPD0gNykpOwoKICAgICAgLy8gTm9ybWFsaXplIHJvb3QgdG8gYWx3YXlzIGluY2x1ZGUgdHJhaWxpbmcgc2xhc2gKICAgICAgaWYgKCF0cmFpbGluZ1NsYXNoLnRlc3QodGhpcy5vcHRpb25zLnJvb3QpKSB0aGlzLm9wdGlvbnMucm9vdCArPSAnLyc7CgogICAgICBpZiAob2xkSUUgJiYgdGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5pZnJhbWUgPSBCYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiIC8+JykuaGlkZSgpLmFwcGVuZFRvKCdib2R5JylbMF0uY29udGVudFdpbmRvdzsKICAgICAgICB0aGlzLm5hdmlnYXRlKGZyYWdtZW50KTsKICAgICAgfQoKICAgICAgLy8gRGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmUgdXNpbmcgcHVzaFN0YXRlIG9yIGhhc2hlcywgYW5kIHdoZXRoZXIKICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykuYmluZCgncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLmJpbmQoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl9jaGVja1VybEludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5jaGVja1VybCwgdGhpcy5pbnRlcnZhbCk7CiAgICAgIH0KCiAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCiAgICAgIC8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4KICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKICAgICAgdmFyIGF0Um9vdCA9IChsb2MucGF0aG5hbWUucmVwbGFjZSgvW14vXSQvLCAnJCYvJykgPT09IHRoaXMub3B0aW9ucy5yb290KSAmJiAhbG9jLnNlYXJjaDsKCiAgICAgIC8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb2ZmIHdpdGggYSByb3V0ZSBmcm9tIGEgYHB1c2hTdGF0ZWAtZW5hYmxlZCBicm93c2VyLAogICAgICAvLyBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLgogICAgICBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmIHRoaXMuX3dhbnRzUHVzaFN0YXRlICYmICF0aGlzLl9oYXNQdXNoU3RhdGUgJiYgIWF0Um9vdCkgewogICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwogICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLm9wdGlvbnMucm9vdCArIHRoaXMubG9jYXRpb24uc2VhcmNoICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzUHVzaFN0YXRlICYmIHRoaXMuX2hhc1B1c2hTdGF0ZSAmJiBhdFJvb3QgJiYgbG9jLmhhc2gpIHsKICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIGxvYy5wcm90b2NvbCArICcvLycgKyBsb2MuaG9zdCArIHRoaXMub3B0aW9ucy5yb290ICsgdGhpcy5mcmFnbWVudCk7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwogICAgfSwKCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIEJhY2tib25lLiQod2luZG93KS51bmJpbmQoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkudW5iaW5kKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCk7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwogICAgfSwKCiAgICAvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCiAgICAvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLgogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBjYWxsYmFjaykgewogICAgICB0aGlzLmhhbmRsZXJzLnVuc2hpZnQoe3JvdXRlOiByb3V0ZSwgY2FsbGJhY2s6IGNhbGxiYWNrfSk7CiAgICB9LAoKICAgIC8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAogICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCiAgICBjaGVja1VybDogZnVuY3Rpb24oZSkgewogICAgICB2YXIgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsKICAgICAgICBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKTsKICAgICAgfQogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAodGhpcy5pZnJhbWUpIHRoaXMubmF2aWdhdGUoY3VycmVudCk7CiAgICAgIHRoaXMubG9hZFVybCgpIHx8IHRoaXMubG9hZFVybCh0aGlzLmdldEhhc2goKSk7CiAgICB9LAoKICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCiAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAogICAgLy8gcmV0dXJucyBgZmFsc2VgLgogICAgbG9hZFVybDogZnVuY3Rpb24oZnJhZ21lbnRPdmVycmlkZSkgewogICAgICB2YXIgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudE92ZXJyaWRlKTsKICAgICAgdmFyIG1hdGNoZWQgPSBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKICAgICAgICAgIGhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICB9LAoKICAgIC8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUKICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKICAgIC8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgogICAgLy8KICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKICAgIC8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCiAgICAvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIGlmICghSGlzdG9yeS5zdGFydGVkKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zID09PSB0cnVlKSBvcHRpb25zID0ge3RyaWdnZXI6IG9wdGlvbnN9OwogICAgICB2YXIgZnJhZyA9IChmcmFnbWVudCB8fCAnJykucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnKSByZXR1cm47CiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnOwogICAgICB2YXIgdXJsID0gKGZyYWcuaW5kZXhPZih0aGlzLm9wdGlvbnMucm9vdCkgIT09IDAgPyB0aGlzLm9wdGlvbnMucm9vdCA6ICcnKSArIGZyYWc7CgogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCiAgICAgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCiAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnLCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZyAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwogICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZywgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9CgogICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KICAgICAgLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKICAgIH0sCgogICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgewogICAgICBpZiAocmVwbGFjZSkgewogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UobG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJykgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbG9jYXRpb24uaGFzaCA9IGZyYWdtZW50OwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5WaWV3CiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBDcmVhdGluZyBhIEJhY2tib25lLlZpZXcgY3JlYXRlcyBpdHMgaW5pdGlhbCBlbGVtZW50IG91dHNpZGUgb2YgdGhlIERPTSwKICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgogIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgndmlldycpOwogICAgdGhpcy5fY29uZmlndXJlKG9wdGlvbnMgfHwge30pOwogICAgdGhpcy5fZW5zdXJlRWxlbWVudCgpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCiAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC87CgogIC8vIExpc3Qgb2YgdmlldyBvcHRpb25zIHRvIGJlIG1lcmdlZCBhcyBwcm9wZXJ0aWVzLgogIHZhciB2aWV3T3B0aW9ucyA9IFsnbW9kZWwnLCAnY29sbGVjdGlvbicsICdlbCcsICdpZCcsICdhdHRyaWJ1dGVzJywgJ2NsYXNzTmFtZScsICd0YWdOYW1lJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBmcm9tIHRoZSBET00uIE5vdGUgdGhhdCB0aGUgdmlldyBpc24ndCBwcmVzZW50IGluIHRoZQogICAgLy8gRE9NIGJ5IGRlZmF1bHQsIHNvIGNhbGxpbmcgdGhpcyBtZXRob2QgbWF5IGJlIGEgbm8tb3AuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEZvciBzbWFsbCBhbW91bnRzIG9mIERPTSBFbGVtZW50cywgd2hlcmUgYSBmdWxsLWJsb3duIHRlbXBsYXRlIGlzbid0CiAgICAvLyBuZWVkZWQsIHVzZSAqKm1ha2UqKiB0byBtYW51ZmFjdHVyZSBlbGVtZW50cywgb25lIGF0IGEgdGltZS4KICAgIC8vCiAgICAvLyAgICAgdmFyIGVsID0gdGhpcy5tYWtlKCdsaScsIHsnY2xhc3MnOiAncm93J30sIHRoaXMubW9kZWwuZXNjYXBlKCd0aXRsZScpKTsKICAgIC8vCiAgICBtYWtlOiBmdW5jdGlvbih0YWdOYW1lLCBhdHRyaWJ1dGVzLCBjb250ZW50KSB7CiAgICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7CiAgICAgIGlmIChhdHRyaWJ1dGVzKSBCYWNrYm9uZS4kKGVsKS5hdHRyKGF0dHJpYnV0ZXMpOwogICAgICBpZiAoY29udGVudCAhPSBudWxsKSBCYWNrYm9uZS4kKGVsKS5odG1sKGNvbnRlbnQpOwogICAgICByZXR1cm4gZWw7CiAgICB9LAoKICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAogICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJwogICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQogICAgLy8gICAgIH0KICAgIC8vCiAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KICAgIC8vIFVzZXMgZXZlbnQgZGVsZWdhdGlvbiBmb3IgZWZmaWNpZW5jeS4KICAgIC8vIE9taXR0aW5nIHRoZSBzZWxlY3RvciBiaW5kcyB0aGUgZXZlbnQgdG8gYHRoaXMuZWxgLgogICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCiAgICAvLyBub3QgYGNoYW5nZWAsIGBzdWJtaXRgLCBhbmQgYHJlc2V0YCBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpIHsKICAgICAgaWYgKCEoZXZlbnRzIHx8IChldmVudHMgPSBnZXRWYWx1ZSh0aGlzLCAnZXZlbnRzJykpKSkgcmV0dXJuOwogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKICAgICAgICBpZiAoIW1ldGhvZCkgdGhyb3cgbmV3IEVycm9yKCdNZXRob2QgIicgKyBldmVudHNba2V5XSArICciIGRvZXMgbm90IGV4aXN0Jyk7CiAgICAgICAgdmFyIG1hdGNoID0ga2V5Lm1hdGNoKGRlbGVnYXRlRXZlbnRTcGxpdHRlcik7CiAgICAgICAgdmFyIGV2ZW50TmFtZSA9IG1hdGNoWzFdLCBzZWxlY3RvciA9IG1hdGNoWzJdOwogICAgICAgIG1ldGhvZCA9IF8uYmluZChtZXRob2QsIHRoaXMpOwogICAgICAgIGV2ZW50TmFtZSArPSAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwogICAgICAgIGlmIChzZWxlY3RvciA9PT0gJycpIHsKICAgICAgICAgIHRoaXMuJGVsLmJpbmQoZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRlbC5kZWxlZ2F0ZShzZWxlY3RvciwgZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4KICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQogICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwudW5iaW5kKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOwogICAgfSwKCiAgICAvLyBQZXJmb3JtcyB0aGUgaW5pdGlhbCBjb25maWd1cmF0aW9uIG9mIGEgVmlldyB3aXRoIGEgc2V0IG9mIG9wdGlvbnMuCiAgICAvLyBLZXlzIHdpdGggc3BlY2lhbCBtZWFuaW5nICoobW9kZWwsIGNvbGxlY3Rpb24sIGlkLCBjbGFzc05hbWUpKiwgYXJlCiAgICAvLyBhdHRhY2hlZCBkaXJlY3RseSB0byB0aGUgdmlldy4KICAgIF9jb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKHRoaXMub3B0aW9ucykgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZpZXdPcHRpb25zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHZhciBhdHRyID0gdmlld09wdGlvbnNbaV07CiAgICAgICAgaWYgKG9wdGlvbnNbYXR0cl0pIHRoaXNbYXR0cl0gPSBvcHRpb25zW2F0dHJdOwogICAgICB9CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9LAoKICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgogICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIGdldFZhbHVlKHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IGdldFZhbHVlKHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBnZXRWYWx1ZSh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KHRoaXMubWFrZShnZXRWYWx1ZSh0aGlzLCAndGFnTmFtZScpLCBhdHRycyksIGZhbHNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNldEVsZW1lbnQodGhpcy5lbCwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBUaGUgc2VsZi1wcm9wYWdhdGluZyBleHRlbmQgZnVuY3Rpb24gdGhhdCBCYWNrYm9uZSBjbGFzc2VzIHVzZS4KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgY2xhc3NQcm9wcykgewogICAgcmV0dXJuIGluaGVyaXRzKHRoaXMsIHByb3RvUHJvcHMsIGNsYXNzUHJvcHMpOwogIH07CgogIC8vIFNldCB1cCBpbmhlcml0YW5jZSBmb3IgdGhlIG1vZGVsLCBjb2xsZWN0aW9uLCBhbmQgdmlldy4KICBNb2RlbC5leHRlbmQgPSBDb2xsZWN0aW9uLmV4dGVuZCA9IFJvdXRlci5leHRlbmQgPSBWaWV3LmV4dGVuZCA9IGV4dGVuZDsKCiAgLy8gQmFja2JvbmUuc3luYwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCiAgdmFyIG1ldGhvZE1hcCA9IHsKICAgICdjcmVhdGUnOiAnUE9TVCcsCiAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICAgJ0dFVCcKICB9OwoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBnZXRWYWx1ZShtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKCFvcHRpb25zLmRhdGEgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJykpIHsKICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nOwogICAgICBwYXJhbXMuZGF0YSA9IEpTT04uc3RyaW5naWZ5KG1vZGVsKTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBKU09OIGJ5IGVuY29kaW5nIHRoZSByZXF1ZXN0IGludG8gYW4gSFRNTC1mb3JtLgogICAgaWYgKEJhY2tib25lLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOwogICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgaWYgKEJhY2tib25lLmVtdWxhdGVIVFRQKSB7CiAgICAgIGlmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJykgewogICAgICAgIGlmIChCYWNrYm9uZS5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CiAgICAgICAgcGFyYW1zLnR5cGUgPSAnUE9TVCc7CiAgICAgICAgcGFyYW1zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLUhUVFAtTWV0aG9kLU92ZXJyaWRlJywgdHlwZSk7CiAgICAgICAgfTsKICAgICAgfQogICAgfQoKICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIUJhY2tib25lLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIC8vIE1ha2UgdGhlIHJlcXVlc3QsIGFsbG93aW5nIHRoZSB1c2VyIHRvIG92ZXJyaWRlIGFueSBBamF4IG9wdGlvbnMuCiAgICByZXR1cm4gQmFja2JvbmUuYWpheChfLmV4dGVuZChwYXJhbXMsIG9wdGlvbnMpKTsKICB9OwoKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KICBCYWNrYm9uZS53cmFwRXJyb3IgPSBmdW5jdGlvbihvbkVycm9yLCBvcmlnaW5hbE1vZGVsLCBvcHRpb25zKSB7CiAgICByZXR1cm4gZnVuY3Rpb24obW9kZWwsIHJlc3ApIHsKICAgICAgcmVzcCA9IG1vZGVsID09PSBvcmlnaW5hbE1vZGVsID8gcmVzcCA6IG1vZGVsOwogICAgICBpZiAob25FcnJvcikgewogICAgICAgIG9uRXJyb3Iob3JpZ2luYWxNb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3JpZ2luYWxNb2RlbC50cmlnZ2VyKCdlcnJvcicsIG9yaWdpbmFsTW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9CiAgICB9OwogIH07CgogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCgogIC8vIFNoYXJlZCBlbXB0eSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0byBhaWQgaW4gcHJvdG90eXBlLWNoYWluIGNyZWF0aW9uLgogIHZhciBjdG9yID0gZnVuY3Rpb24oKXt9OwoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGluaGVyaXRzID0gZnVuY3Rpb24ocGFyZW50LCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgdmFyIGNoaWxkOwoKICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgIGlmIChwcm90b1Byb3BzICYmIHByb3RvUHJvcHMuaGFzT3duUHJvcGVydHkoJ2NvbnN0cnVjdG9yJykpIHsKICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwogICAgfSBlbHNlIHsKICAgICAgY2hpbGQgPSBmdW5jdGlvbigpeyBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICAgIH0KCiAgICAvLyBJbmhlcml0IGNsYXNzIChzdGF0aWMpIHByb3BlcnRpZXMgZnJvbSBwYXJlbnQuCiAgICBfLmV4dGVuZChjaGlsZCwgcGFyZW50KTsKCiAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgIGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7CgogICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAvLyBpZiBzdXBwbGllZC4KICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgaWYgKHN0YXRpY1Byb3BzKSBfLmV4dGVuZChjaGlsZCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIENvcnJlY3RseSBzZXQgY2hpbGQncyBgcHJvdG90eXBlLmNvbnN0cnVjdG9yYC4KICAgIGNoaWxkLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNoaWxkOwoKICAgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQgbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGEgdmFsdWUgZnJvbSBhIEJhY2tib25lIG9iamVjdCBhcyBhIHByb3BlcnR5CiAgLy8gb3IgYXMgYSBmdW5jdGlvbi4KICB2YXIgZ2V0VmFsdWUgPSBmdW5jdGlvbihvYmplY3QsIHByb3ApIHsKICAgIGlmICghKG9iamVjdCAmJiBvYmplY3RbcHJvcF0pKSByZXR1cm4gbnVsbDsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24ob2JqZWN0W3Byb3BdKSA/IG9iamVjdFtwcm9wXSgpIDogb2JqZWN0W3Byb3BdOwogIH07CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07Cgp9KS5jYWxsKHRoaXMpOwoKZGVmaW5lKCJiYWNrYm9uZSIsIFsibG9kYXNoIiwianF1ZXJ5Il0sIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBnbG9iYWwuQmFja2JvbmU7CiAgICB9Cn0odGhpcykpKTsKCi8qISBUaHJ1c3QgSlMgRnJhbWV3b3JrIC0gdjAuMS4wIC0gMjAxMi0wOC0yOQoqIHRocnVzdC1ob21lCiogQ29weXJpZ2h0IChjKSAyMDEyIERhdmlkIERyaXNjb2xsOyBMaWNlbnNlZCBNSVQgKi8KCgpkZWZpbmUoJ3RocnVzdC9tZWRpYXRvci9tYWluJyxbCiAgICAndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICd0aHJ1c3QvZXZlbnRzJywgJ3RocnVzdC9mYWNhZGUnCl0sCmZ1bmN0aW9uICh1dGlsLCBsb2csIEV2ZW50cywgZmFjYWRlKQp7CiAgICAKICAgIC8vIFZhcmlhYmxlIGRlY2xhcmF0aW9uLgogICAgdmFyIGZvcm1hdCAgPSB1dGlsLmZvcm1hdCwgICAvLyBzdHJpbmcgZm9ybWF0IG1ldGhvZAogICAgICAgIGV4dGVuZCAgPSB1dGlsLmV4dGVuZCwgICAvLyBvYmplY3QgZXh0ZW5zaW9uIG1ldGhvZAogICAgICAgIHR5cGUgICAgPSB1dGlsLnR5cGUsICAgICAgIC8vIG9iamVjdCB0eXBlIG1ldGhvZAogICAgICAgIHdoZW4gICAgPSB1dGlsLndoZW4sCiAgICAgICAgbWVtb2l6ZSA9IHV0aWwubWVtb2l6ZSwKICAgICAgICBtZWRpYXRvciwKICAgICAgICBzbGljZSAgID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKICAgIC8vI3JlZ2lvbiBGYWNhZGUKICAgIC8qKgogICAgQ3JlYXRlcyBhIG5ldyBtZWRpYXRvciBmYWNhZGUgZm9yIHRoZSBnaXZlbiBtb2R1bGUuCgogICAgQGNsYXNzIHRocnVzdC1tZWRpYXRvci1NZWRpYXRvckZhY2FkZQogICAgKiovCiAgICB2YXIgTWVkaWF0b3JGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkKICAgIHsKICAgICAgICB0aGlzLm5hbWUgICAgICAgICAgPSBtb2R1bGUubmFtZTsKICAgICAgICB0aGlzLm1vZHVsZSAgICAgICAgPSBtb2R1bGU7CiAgICAgICAgdGhpcy5wYXJlbnQgICAgICAgID0gcGFyZW50OwogICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgIHRoaXMuX2NhbGxiYWNrcyAgICA9IHBhcmVudC5fY2FsbGJhY2tzOwogICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgfSk7CiAgICB1dGlsLmV4dGVuZChNZWRpYXRvckZhY2FkZS5mbiwgRXZlbnRzKTsKCiAgICAvKioKICAgIER1cmluZyB0aGUgc3RhcnQgb2YgYSBtZWRpYXRvciBmYWNhZGUsIHN0YXJ0IGNyZWF0ZXMgdGhlIGludGVybmFsIHN1YnNjcmlwdGlvbnMgYXJyYXkuCgogICAgQGZvciB0aHJ1c3QtbWVkaWF0b3ItTWVkaWF0b3JGYWNhZGUKICAgIEBtZXRob2Qgc3RhcnQKICAgICoqLwogICAgTWVkaWF0b3JGYWNhZGUuZm4uaW5pdCA9IE1lZGlhdG9yRmFjYWRlLmZuLnN0YXJ0ID0gZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICBpZiAoIXRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucykKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zID0gW107CiAgICB9OwoKICAgIE1lZGlhdG9yRmFjYWRlLmZuLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KQogICAgewogICAgICAgIHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucy5wdXNoKHsgZXZlbnRzOiBldmVudHMsIGNhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCB9KTsKICAgICAgICBFdmVudHMuc3Vic2NyaWJlLmNhbGwodGhpcywgZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICB9OwoKICAgIE1lZGlhdG9yRmFjYWRlLmZuLnN0b3AgPSBmdW5jdGlvbiAoZmFjYWRlKQogICAgewogICAgICAgIHZhciBtb2R1bGUgPSBmYWNhZGUubW9kdWxlOwoKICAgICAgICBpZiAodGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9uc1tpXTsKICAgICAgICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoc3ViLmV2ZW50cywgc3ViLmNhbGxiYWNrLCBzdWIuY29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9uczsKICAgICAgICB9CiAgICB9CgogICAgLy8jZW5kcmVnaW9uCiAgICAvLyBPdXIgZGVmYXVsdCBuYW1lc3BhY2UgcHJlZml4LgoKICAgIC8qKgogICAgTWVkaWF0b3IgY2xhc3MuCiAgICBUaGlzIGNyZWF0ZXMgYSBpbnN0YW5jZSBvZiB0aGUgbWVkaWF0b3IsIGZvciB1c2UgaW5zaWRlIHRocnVzdC4KCiAgICBAY2xhc3MgdGhydXN0LW1lZGlhdG9yLU1lZGlhdG9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbWVkaWF0b3IuCiAgICAqKi8KICAgIHZhciBNZWRpYXRvciA9IGZ1bmN0aW9uICgvKiAkcmVmICovIG5hbWUpCiAgICB7CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIE1lZGlhdG9yKSkKICAgICAgICAgICAgcmV0dXJuIG5ldyBNZWRpYXRvcihuYW1lKTsKCiAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgIHRoYXQubmFtZSA9IG5hbWU7CiAgICAgICAgbG9nLmRlYnVnKGZvcm1hdCgnTWVkaWF0b3I6IENyZWF0aW5nIG5ldyBNZWRpYXRvciB7MH0nLCBuYW1lKSk7CgogICAgICAgIHRoYXQuaW5pdEV2ZW50cygpOwoKICAgICAgICB0aGF0LnN1YnNjcmliZSgndGhydXN0L3JlYWR5JywgZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIGxvZy5pbmZvKCdNZWRpYXRvcjogUmVhZHkhJyk7CiAgICAgICAgfSk7CgogICAgICAgIHRoYXQuc3Vic2NyaWJlKCd0aHJ1c3QvbmF2aWdhdGUnLCBmdW5jdGlvbiAocGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChwYXRoID09PSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUpCiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7CiAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IHV0aWwuZml4dXBVcmwocGF0aCk7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIHZhciBNZWRpYXRvclByb3RvdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IE1lZGlhdG9yRmFjYWRlLCBiYXNlZCBvbiB0aGUgZ2l2ZW4gbW9kdWxlLgoKICAgICAgICBAZm9yIHRocnVzdC1tZWRpYXRvci1NZWRpYXRvcgogICAgICAgIEBtZXRob2QgY3JlYXRlRmFjYWRlCiAgICAgICAgQHBhcmFtIHtNb2R1bGV9IG1vZHVsZURlZm4gVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IuCiAgICAgICAgKiovCiAgICAgICAgY3JlYXRlRmFjYWRlOiBmdW5jdGlvbiAodGhydXN0LCBtb2R1bGUsIGZhY2FkZXMpCiAgICAgICAgewogICAgICAgICAgICBpZiAobW9kdWxlLm1lZGlhdG9yICYmICEoZmFjYWRlcy5tZWRpYXRvciBpbnN0YW5jZW9mIE1lZGlhdG9yRmFjYWRlKSkgdGhyb3cgbmV3IEVycm9yKCcibWVkaWF0b3IiIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKCiAgICAgICAgICAgIHZhciBtZWRpYXRvcjsKICAgICAgICAgICAgaWYgKGZhY2FkZXMubWVkaWF0b3IpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IudXBkYXRlRmFjYWRlKG1vZHVsZSwgdGhpcyk7CiAgICAgICAgICAgICAgICBtZWRpYXRvciA9IGZhY2FkZXMubWVkaWF0b3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtZWRpYXRvciA9IGZhY2FkZXMubWVkaWF0b3IgPSBtb2R1bGUubWVkaWF0b3IgPSBuZXcgTWVkaWF0b3JGYWNhZGUobW9kdWxlLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWVkaWF0b3I7CiAgICAgICAgfQogICAgfTsKCiAgICB1dGlsLmV4dGVuZChNZWRpYXRvclByb3RvdHlwZSwgRXZlbnRzKTsKCiAgICAvLyBFeHRlbmQgb3VyIHByb3RvdHlwZSB0byBpbmNsdWRlIHRoZSBwcm90b3R5cGUgZ2VuZXJhdGVkIGFib3ZlLgogICAgTWVkaWF0b3IucHJvdG90eXBlID0gTWVkaWF0b3IuZm4gPSBNZWRpYXRvclByb3RvdHlwZTsKCiAgICByZXR1cm4gTWVkaWF0b3I7Cn0pOwoKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3InLCBbJ3RocnVzdC9tZWRpYXRvci9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L21lZGlhdG9yL2NvbnZlbnRpb24vYXV0b3N0YXJ0JyxbJ3RocnVzdC9jb252ZW50aW9uJ10sCmZ1bmN0aW9uIChDb252ZW50aW9uKQp7CiAgICAvKioKICAgIFNpbXBsZSBtZWRpYXRvciBjb252ZW50aW9uIHRvIGNhcHR1cmUgdGhlIGF1dG9TdGFydCBwcm9wZXJ0eSBvbiBhIG1vZHVsZS4KCiAgICBUaGUgYXV0b1N0YXJ0IHByb3BlcnR5LCBpbmRpY2F0ZXMgdGhhdCB0aGUgbW9kdWxlIHNob3VsZCBhdXRvbWF0aWNhbGx5IHN0YXJ0IHdpdGggdGhlIHRocnVzdCBpbnN0YW5jZSwgb3Igd2hlbiBpdCBpcyBhZGRlZCB0byB0aGUgdGhydXN0IGluc3RhbmNlLgoKICAgIEBtb2R1bGUgdGhydXN0LW1lZGlhdG9yLWNvbnZlbnRpb24KICAgICoqLwoKICAgIC8qKgogICAgVGhlIGF1dG9TdGFydCBwcm9wZXJ0eSwgaW5kaWNhdGVzIHRoYXQgdGhlIG1vZHVsZSBzaG91bGQgYXV0b21hdGljYWxseSBzdGFydCB3aXRoIHRoZSB0aHJ1c3QgaW5zdGFuY2UsIG9yIHdoZW4gaXQgaXMgYWRkZWQgdG8gdGhlIHRocnVzdCBpbnN0YW5jZS4KCiAgICBAZm9yIHRocnVzdC1tZWRpYXRvci1jb252ZW50aW9uCiAgICBAcHJvcGVydHkgYXV0b1N0YXJ0CiAgICAqKi8KICAgIHJldHVybiBuZXcgQ29udmVudGlvbih7CiAgICAgICAgcHJvcGVydGllczogWydhdXRvU3RhcnQnXQogICAgfSk7Cn0pOwpkZWZpbmUoJ3RocnVzdC9tZWRpYXRvci9jb252ZW50aW9uL2NvbnRhaW5lcicsWyd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLApmdW5jdGlvbiAoQ29udmVudGlvbiwgdXRpbCkKewogICAgLyoqCiAgICBTaW1wbGUgbWVkaWF0b3IgY29udmVudGlvbiB0byBjYXB0dXJlIHRoZSBjb250YWluZXIgcHJvcGVydHkgb24gYSBtb2R1bGUuCgogICAgV2hlbmV2ZXIgYW5vdGhlciBtb2R1bGUsIHRyaWVzIHRvIGxvYWQgd2l0aCB0aGUgc2FtZSBjb250YWluZXIsIHRoZSBjdXJyZW50IG1vZHVsZSB3aWxsIGJlIHN0b3BwZWQsIGFuZCB0aGUgbmV3IG9uZSB3aWxsIGxvYWQgdG8gdGFrZSBpdCdzIHBsYWNlLgoKICAgIEBtb2R1bGUgdGhydXN0LW1lZGlhdG9yLWNvbnZlbnRpb24KICAgICoqLwoKICAgIHZhciBldmVudCA9IHsKICAgICAgICAgICAgYW55Q29udGFpbmVyOiAndGhydXN0L21lZGlhdG9yL2NvbnZlbnRpb24vY29udGFpbmVyL2FueScsCiAgICAgICAgICAgIGNoYW5nZUNvbnRhaW5lcjogJ3RocnVzdC9tZWRpYXRvci9jb252ZW50aW9uL2NvbnRhaW5lci9jaGFuZ2UnCiAgICAgICAgfSwKICAgICAgICBhbnkgICAgICAgPSB1dGlsLmFueSwKICAgICAgICBDT05UQUlORVIgPSAnY29udGFpbmVyJywKICAgICAgICBTVEFSVCAgICAgPSAnc3RhcnQtc3RhdHVzJywKICAgICAgICBkZWZlciAgICAgPSB1dGlsLmRlZmVyLAogICAgICAgIGJpbmQgICAgICA9IHV0aWwuYmluZDsKCiAgICAvKioKICAgIFNpbXBsZSBtZWRpYXRvciBjb252ZW50aW9uIHRvIGNhcHR1cmUgdGhlIGNvbnRhaW5lciBwcm9wZXJ0eSBvbiBhIG1vZHVsZS4KCiAgICBXaGVuZXZlciBhbm90aGVyIG1vZHVsZSwgdHJpZXMgdG8gbG9hZCB3aXRoIHRoZSBzYW1lIGNvbnRhaW5lciwgdGhlIGN1cnJlbnQgbW9kdWxlIHdpbGwgYmUgc3RvcHBlZCwgYW5kIHRoZSBuZXcgb25lIHdpbGwgbG9hZCB0byB0YWtlIGl0J3MgcGxhY2UuCgogICAgQGZvciB0aHJ1c3QtbWVkaWF0b3ItY29udmVudGlvbgogICAgQHByb3BlcnR5IGNvbnRhaW5lcgogICAgKiovCiAgICByZXR1cm4gbmV3IENvbnZlbnRpb24oewogICAgICAgIHByb3BlcnRpZXM6IFtDT05UQUlORVJdLAogICAgICAgIGNoYW5nZTogZnVuY3Rpb24gKG1vZHVsZSwgY29udGFpbmVyKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lclZhbHVlID0gbW9kdWxlLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lclZhbHVlICYmIGNvbnRhaW5lciAmJiBjb250YWluZXJWYWx1ZSA9PT0gY29udGFpbmVyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAobW9kdWxlLmNvbnZlbnRpb24oU1RBUlQpKQogICAgICAgICAgICAgICAgICAgIGRlZmVyKG1vZHVsZS5zdG9wLmJpbmQobW9kdWxlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0YXJ0OiBmdW5jdGlvbiAoZmFjYWRlLCBtb2R1bGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBjb250YWluZXJWYWx1ZSA9IG1vZHVsZS5jb252ZW50aW9uKENPTlRBSU5FUik7CiAgICAgICAgICAgIGlmIChjb250YWluZXJWYWx1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZmFjYWRlLmZpcmUoZXZlbnQuY2hhbmdlQ29udGFpbmVyLCBjb250YWluZXJWYWx1ZSk7CiAgICAgICAgICAgICAgICAvLyBGYWNhZGUgc3Vic2NyaXB0aW9ucyBnZXQgdW5zdWJzY3JpYmVkIHdoZW4gc3RvcHBpbmcgYSBtb2R1bGUsIHNvIHdlIG5lZWQgdG8gcmVzdWJzY3JpYmUgZXZlcnkgdGltZSBoZXJlLgogICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBwcm9iYWJseSBiZXR0ZXIsIGFzIHRoZSBldmVudHMgd2lsbCBiZSBsZXNzIGNoYXR0eS4KICAgICAgICAgICAgICAgIGZhY2FkZS5zdWJzY3JpYmUoZXZlbnQuY2hhbmdlQ29udGFpbmVyLCBiaW5kKHRoYXQuY2hhbmdlLCB0aGF0LCBtb2R1bGUpKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKGZhY2FkZSkKICAgICAgICB7CiAgICAgICAgfQogICAgfSk7Cn0pOwpkZWZpbmUoJ3RocnVzdC9tZWRpYXRvci9jb252ZW50aW9uL3N1YnNjcmlwdGlvbicsWwogICAgJ3RocnVzdC9jb252ZW50aW9uJywKICAgICd0aHJ1c3QvdXRpbCcsCiAgICAndGhydXN0L2V2ZW50cycKXSwKZnVuY3Rpb24gKENvbnZlbnRpb24sIHV0aWwsIEV2ZW50cykKewogICAgLyoqCiAgICBUaGUgZmFjYWRlIGNvbnZlbnRpb24sIGNyZWF0ZXMgdGhlIG1lZGlhdG9yIGZhY2FkZSBmb3IgZWFjaCBtb2R1bGUuCgogICAgQG1vZHVsZSB0aHJ1c3QtbWVkaWF0b3ItY29udmVudGlvbgogICAgKiovCiAgICB2YXIgU1VCU0NSSVBUSU9OUyA9ICdzdWJzY3JpcHRpb25zJywKICAgICAgICBpc0Z1bmN0aW9uICAgID0gdXRpbC5pc0Z1bmN0aW9uLAogICAgICAgIGlzU3RyaW5nICAgICAgPSB1dGlsLmlzU3RyaW5nLAogICAgICAgIGlzQXJyYXkgICAgICAgPSB1dGlsLmlzQXJyYXk7CgogICAgLyoqCiAgICBUaGUgc3Vic2NyaXB0aW9uIHByb3BlcnR5IGRlZmluZXMsIHByZWRlZmluZWQgc3Vic2NyaXB0aW9ucyBmb3IgYSBtb2R1bGUuCgogICAgQnkgZGVmYXVsdCB0aGUgY29udGV4dCBvZiB0aGUgc3Vic2NyaXB0aW9uIG1ldGhvZCwgd2hlbiBydW4sIHdpbGwgYmUgeW91ciBtb2R1bGUsCiAgICAgICAgaXQgY2FuIGJlIG9wdGlvbmFsbHkgZGVmaW5lZCBieSBwYXNzaW5nIGluIGFuIGFycmF5LgogICAgCiAgICBCYXNpYyB1c2FnZToKCiAgICAgICAgc3Vic2NyaXB0aW9uOiB7CiAgICAgICAgICAgICdldmVudC1uYW1lMSc6IG15TWV0aG9kSGVyZSwKICAgICAgICAgICAgJ2V2ZW50LW5hbWUyJzogJ21ldGhvZERlZmluZWRPblRoZU1vZHVsZScsCiAgICAgICAgICAgICdldmVudC1uYW1lMyc6IFtteU1ldGhvZEhlcmUsIG15TWV0aG9kQ29udGV4dF0sCiAgICAgICAgICAgICdldmVudC1uYW1lNCc6IFsnbWV0aG9uZERlZmluZWRPblRoZU1vZHVsZScsIG15TWV0aG9kQ29udGV4dF0KICAgICAgICB9CgogICAgQGZvciB0aHJ1c3QtbWVkaWF0b3ItY29udmVudGlvbgogICAgQHByb3BlcnR5IHN1YnNjcmlwdGlvbnMKICAgICoqLwogICAgcmV0dXJuIG5ldyBDb252ZW50aW9uKHsKICAgICAgICBwcm9wZXJ0aWVzOiBbU1VCU0NSSVBUSU9OU10sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChmYWNhZGUsIG1vZHVsZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb25zID0gbW9kdWxlLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUyk7CgogICAgICAgICAgICBpZiAoc3Vic2NyaXB0aW9ucyAmJiAhc3Vic2NyaXB0aW9ucy5fc3Vic2NyaXB0aW9uc1NldCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG1vZHVsZUluc3RhbmNlID0gbW9kdWxlLmluc3RhbmNlOwogICAgICAgICAgICAgICAgZm9yICh2YXIgc3Vic2NyaXB0aW9uIGluIHN1YnNjcmlwdGlvbnMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlZmluaXRpb24gPSBzdWJzY3JpcHRpb25zW3N1YnNjcmlwdGlvbl07CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGVmaW5pdGlvbikpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZpbml0aW9uID0gW3N1YnNjcmlwdGlvbiwgZGVmaW5pdGlvbiwgbW9kdWxlSW5zdGFuY2VdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpc1N0cmluZyhkZWZpbml0aW9uKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluaXRpb24gPSBbc3Vic2NyaXB0aW9uLCBtb2R1bGVJbnN0YW5jZVtkZWZpbml0aW9uXSwgbW9kdWxlSW5zdGFuY2VdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpc0FycmF5KGRlZmluaXRpb24pKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRlZmluaXRpb25bMF0pKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZpbml0aW9uWzBdID0gbW9kdWxlSW5zdGFuY2VbZGVmaW5pdGlvblswXV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvbi51bnNoaWZ0KHN1YnNjcmlwdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZhY2FkZS5zdWJzY3JpYmUuYXBwbHkoZmFjYWRlLCBkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vZHVsZS5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpLl9zdWJzY3JpcHRpb25zU2V0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKGZhY2FkZSwgbW9kdWxlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHN1YnNjcmlwdGlvbnMgPSBtb2R1bGUuY29udmVudGlvbihTVUJTQ1JJUFRJT05TKTsKCiAgICAgICAgICAgIGlmIChzdWJzY3JpcHRpb25zICYmIHN1YnNjcmlwdGlvbnMuX3N1YnNjcmlwdGlvbnNTZXQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1vZHVsZS5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpLl9zdWJzY3JpcHRpb25zU2V0ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKfSk7Ci8qISBUaHJ1c3QgSlMgRnJhbWV3b3JrIC0gdjAuMS4wIC0gMjAxMi0wOC0yOQoqIHRocnVzdC1ob21lCiogQ29weXJpZ2h0IChjKSAyMDEyIERhdmlkIERyaXNjb2xsOyBMaWNlbnNlZCBNSVQgKi8KCgovKioKCkBtb2R1bGUgdGhydXN0LWRhdGEgCkBzdWJtb2R1bGUgZXZlbnRzCioqLwpkZWZpbmUoJ3RocnVzdC9kYXRhL2V2ZW50LnR5cGVzJyx7CiAgICAvKioKICAgIFRoZSAqKnRocnVzdC9kYXRhL3dhaXQqKiBldmVudCBpcyBmaXJlZCBvbmNlIGEgZGF0YSBjYWxsIGlzIG1hZGUuCgogICAgQGV2ZW50IHRocnVzdC9kYXRhL3dhaXQKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgICoqLwogICAgd2FpdDogJ3RocnVzdC9kYXRhL3dhaXQnLAogICAgLyoqCiAgICBUaGUgKip0aHJ1c3QvZGF0YS9zdGFydCoqIGV2ZW50IGlzIGZpcmVkIHRoZSBxdWV1ZSBpcyBzdGFydGVkLgoKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGFydAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXJ5SWQgVGhlIGludGVybmFsIGlkIG9mIHRoZSBvdXRib3VuZCBxdWV1ZS4KICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBvdXRib3VuZCBldmVudCBxdWV1ZSAoR2V0L1Bvc3QvZXRjKQogICAgQHBhcmFtIHtOdW1iZXJ9IGNvdW50IFRoZSBvdXRnb2luZyBjYWxsIGNvdW50CiAgICAqKi8KICAgIHN0YXJ0OiAndGhydXN0L2RhdGEvc3RhcnQnLAogICAgLyoqCiAgICBUaGUgKip0aHJ1c3QvZGF0YS9zdGF0dXMqKiBldmVudCBpcyBmaXJlZCBmb3IgZXZlcnkgaXRlbSB0aGF0IHJldHVybnMgZnJvbSB0aGUgcXVldWUuCgogICAgTk9URTogSXQgaXMgZW50aXJlbHkgcG9zc2libGUgZm9yICoqdGhydXN0L2RhdGEvc3RhdHVzKiogdG8gYmUgY2FsbGVkIGFmdGVyICoqdGhydXN0L2RhdGEvc3RvcCoqIGlmIHNldmVyYWwKICAgICAgICBjYWxscyB0YWtlIHRvIGxvbmcgdG8gY29tcGxldGUuICBUaGlzIGlzIGludGVuZGVkLCBhbmQgcG90ZW50aWFsbHkgdXNlZnVsIGluZm9ybWF0aW9uLgoKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGF0dXMKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgY3VycmVudCBjb21wbGV0ZWQgY2FsbCBjb3VudCBmb3IgdGhpcyBxdWV1ZS4KICAgICoqLwogICAgc3RhdHVzOiAndGhydXN0L2RhdGEvc3RhdHVzJywKICAgIC8qKgogICAgVGhlICoqdGhydXN0L2RhdGEvc3RvcCoqIGV2ZW50IGlzIGZpcmVkIHdoZW4gYWxsIGl0ZW1zIGluIHRoZSBxdWV1ZSByZXR1cm4sIG9yIHRoZSBmaW5pc2hlZFRpbWVvdXQgc2V0dGluZyBlbGFwc2VzLgoKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdG9wCiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICBAcGFyYW0ge051bWJlcn0gY291bnQgVGhlIChjdXJyZW50KSBjb21wbGV0ZWQgY2FsbCBjb3VudCBmb3IgdGhpcyBxdWV1ZS4KICAgICoqLwogICAgc3RvcDogJ3RocnVzdC9kYXRhL3N0b3AnLAogICAgZXZlbnQ6IHsKICAgICAgICAvKioKICAgICAgICBUaGUgKip0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZCoqIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCgogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZAogICAgICAgICoqLwogICAgICAgIGJlZm9yZVNlbmQ6ICd0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZCcsCiAgICAgICAgLyoqCiAgICAgICAgVGhlICoqdGhydXN0L2RhdGEvZXZlbnQvc3RhcnQqKiBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgoKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvc3RhcnQKICAgICAgICAqKi8KICAgICAgICBzdGFydDogJ3RocnVzdC9kYXRhL2V2ZW50L3N0YXJ0JywKICAgICAgICAvKioKICAgICAgICBUaGUgKip0aHJ1c3QvZGF0YS9ldmVudC9zZW5kKiogZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3NlbmQKICAgICAgICAqKi8KICAgICAgICBzZW5kOiAndGhydXN0L2RhdGEvZXZlbnQvc2VuZCcsCiAgICAgICAgLyoqCiAgICAgICAgVGhlICoqdGhydXN0L2RhdGEvZXZlbnQvZXJyb3IqKiBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgoKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvZXJyb3IKICAgICAgICAqKi8KICAgICAgICBlcnJvcjogJ3RocnVzdC9kYXRhL2V2ZW50L2Vycm9yJywKICAgICAgICAvKioKICAgICAgICBUaGUgKip0aHJ1c3QvZGF0YS9ldmVudC9zdWNjZXNzKiogZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N1Y2Nlc3MKICAgICAgICAqKi8KICAgICAgICBzdWNjZXNzOiAndGhydXN0L2RhdGEvZXZlbnQvc3VjZXNzJywKICAgICAgICAvKioKICAgICAgICBUaGUgKip0aHJ1c3QvZGF0YS9ldmVudC9jb21wbGV0ZSoqIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCgogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9jb21wbGV0ZQogICAgICAgICoqLwogICAgICAgIGNvbXBsZXRlOiAndGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUnLAogICAgICAgIC8qKgogICAgICAgIFRoZSAqKnRocnVzdC9kYXRhL2V2ZW50L3N0b3AqKiBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgoKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvc3RvcAogICAgICAgICoqLwogICAgICAgIHN0b3A6ICd0aHJ1c3QvZGF0YS9ldmVudC9zdG9wJwogICAgfQp9KTsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9ldmVudC5mYWN0b3J5JyxbJ3RocnVzdC91dGlsJywgJy4vZXZlbnQudHlwZXMnXSwKZnVuY3Rpb24odXRpbCwgZXZlbnRUeXBlcykKewogICAgCiAgICB2YXIgY2FtZWxDYXNlICA9IHV0aWwuY2FtZWxDYXNlLAogICAgICAgIGZvcm1hdCAgICAgPSB1dGlsLmZvcm1hdCwKICAgICAgICBkYXRhRXZlbnRzID0gZXZlbnRUeXBlc1snZXZlbnQnXSwKICAgICAgICBzbGljZSAgICAgID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKICAgIHZhciBldmVudEhhbmRsZXJzID0geyAgICAvLyBTdXBwb3J0ZWQgZXZlbnQgaGFuZGxlcnMKICAgICAgICAnYmVmb3JlLXNlbmQnIDogdHJ1ZSwKICAgICAgICAnc2VuZCcgICAgICAgIDogdHJ1ZSwKICAgICAgICAnZXJyb3InICAgICAgIDogdHJ1ZSwKICAgICAgICAnc3VjY2VzcycgICAgIDogdHJ1ZSwKICAgICAgICAnY29tcGxldGUnICAgIDogdHJ1ZSwKICAgICAgICAnc3RhcnQnICAgICAgIDogdHJ1ZSwKICAgICAgICAnc3RvcCcgICAgICAgIDogdHJ1ZQogICAgfTsKCiAgICB2YXIgYmVmb3JlU2VuZE1ldGhvZCA9IGZ1bmN0aW9uIChqcVhIUiwgc2V0dGluZ3MpCiAgICB7CiAgICAgICAgdGhpcy5maXJlKGRhdGFFdmVudHNbJ2JlZm9yZVNlbmQnXSwganFYSFIsIHNldHRpbmdzKTsKICAgIH07CgogICAgdmFyIGV2ZW50RmFjdG9yeSA9IGZ1bmN0aW9uIChldmVudCkgICAgLy8gQ3JlYXRlIGEgbmV3IGV2ZW50IG1ldGhvZC4KICAgIHsKICAgICAgICB2YXIgZXZ0ID0gZGF0YUV2ZW50c1tldmVudF07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGV2dCk7CiAgICAgICAgICAgIHRoaXMuZmlyZS5hcHBseSh0aGlzLmZpcmUuYXN5bmMsIGFyZ3MpOwogICAgICAgIH07CiAgICB9OwoKICAgIHZhciBub3JtYWxpemVFdmVudHMgPSBmdW5jdGlvbiAoZXZ0cykgICAgLy8gTm9ybWFsaXplIGV2ZW50cwogICAgewogICAgICAgIGV2dHMgPSBldnRzLnNwbGl0KCcgJyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBldnRzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICghZXZlbnRIYW5kbGVyc1tldnRzW2ldXSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ0V2ZW50ICJ7MH0iIGlzIG5vdCBhIHZhbGlkIGRhdGEgZXZlbnQnLCBldnRzW2ldKSk7CiAgICAgICAgICAgIGV2dHNbaV0gPSBkYXRhRXZlbnRzW2V2dHNbaV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZ0cy5qb2luKCcgJyk7CiAgICB9OwoKICAgIHZhciBzZW5kRXZlbnRGYWN0b3J5ID0gZnVuY3Rpb24gKGkpCiAgICB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChldmVudCwganFYSFIsIHNldHRpbmdzKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFzZXR0aW5ncy5fX21lZGlhdG9yX2RhdGFfZmlyZWRfXykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAganFYSFIuYWJvcnQoKTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBhYm9ydGVkLCBhbGwgYWpheCBjYWxscyBtdXN0IHBhc3MgdGhyb3VnaCB0aHJ1c3QtZGF0YS4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBldmVudEZhY3RvcnkoaSkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgfTsKCiAgICByZXR1cm4gewogICAgICAgIGluaXQ6IGZ1bmN0aW9uKGpEb2MpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpIGluIGV2ZW50SGFuZGxlcnMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBqcUV2dCA9ICdhamF4LScgKyBpLAogICAgICAgICAgICAgICAgICAgIG1ldGhvZCA9IGV2ZW50RmFjdG9yeShpKTsKCiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gJ3NlbmQnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1ldGhvZCA9IHNlbmRFdmVudEZhY3RvcnkoaSkuYmluZCh0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGpEb2Mub24oY2FtZWxDYXNlKGpxRXZ0KSArIHRoaXMubmFtZXNwYWNlLCBtZXRob2QpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBiZWZvcmVTZW5kTWV0aG9kOiBiZWZvcmVTZW5kTWV0aG9kLAogICAgfTsKfSk7CmRlZmluZSgndGhydXN0L2RhdGEvcmVzcG9uc2UucXVldWUnLFsnanF1ZXJ5JywgJ3RocnVzdC91dGlsJywgJ3RocnVzdC9jb25maWcnLCAndGhydXN0L2xvZycsICcuL2V2ZW50LnR5cGVzJ10sCmZ1bmN0aW9uKGpRdWVyeSwgdXRpbCwgY29uZmlnLCBsb2csIGV2ZW50VHlwZXMpCnsKICAgIHZhciBzbGljZSAgICAgICAgICAgICAgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCiAgICAgICAgZm9ybWF0ICAgICAgICAgICAgID0gdXRpbC5mb3JtYXQsCiAgICAgICAgZXh0ZW5kICAgICAgICAgICAgID0gdXRpbC5leHRlbmQsCiAgICAgICAgd2hlbiAgICAgICAgICAgICAgID0gdXRpbC53aGVuLAogICAgICAgIHVpZCAgICAgICAgICAgICAgICA9IHV0aWwudW5pcXVlSWQsCiAgICAgICAgYWpheCAgICAgICAgICAgICAgID0galF1ZXJ5LmFqYXgsCiAgICAgICAgZGF0YUV2ZW50V2FpdCAgICAgID0gZXZlbnRUeXBlc1snd2FpdCddLAogICAgICAgIGRhdGFFdmVudFN0YXJ0ICAgICA9IGV2ZW50VHlwZXNbJ3N0YXJ0J10sCiAgICAgICAgZGF0YUV2ZW50U3RvcCAgICAgID0gZXZlbnRUeXBlc1snc3RvcCddLAogICAgICAgIGRhdGFFdmVudFN0YXR1cyAgICA9IGV2ZW50VHlwZXNbJ3N0YXR1cyddLAogICAgICAgIHF1ZXVlICAgICAgICAgICAgICA9IHt9LAogICAgICAgIHVwZGF0ZVhIUkludGVybmFscyA9IGZ1bmN0aW9uIChkZm8sIHhocikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWRmby5feGhyKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRmby5feGhyID0geGhyOwogICAgICAgICAgICAgICAgICAgIGRmby5nZXRBbGxSZXNwb25zZUhlYWRlcnMgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBkZm8uX3hoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKTsgfTsKICAgICAgICAgICAgICAgICAgICBkZm8uZ2V0UmVzcG9uc2VIZWFkZXIgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBkZm8uX3hoci5nZXRBbGxSZXNwb25zZUhlYWRlcnNnZXRSZXNwb25zZUhlYWRlcigpOyB9OwogICAgICAgICAgICAgICAgICAgIGRmby5hYm9ydCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGRmby5feGhyLmFib3J0KCk7IH07CiAgICAgICAgICAgICAgICAgICAgZGZvLnNldFJlcXVlc3RIZWFkZXIgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsgcmV0dXJuIGRmby5feGhyLnNldFJlcXVlc3RIZWFkZXIobmFtZSwgdmFsdWUpOyB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGRmby5yZXNwb25zZVRleHQgPSB4aHIucmVzcG9uc2VUZXh0OwogICAgICAgICAgICAgICAgZGZvLnJlc3BvbnNlWE1MID0geGhyLnJlc3BvbnNlWE1MOwogICAgICAgICAgICAgICAgZGZvLnJlYWR5U3RhdGUgPSB4aHIucmVhZHlTdGF0ZTsKICAgICAgICAgICAgICAgIGRmby5zdGF0dXMgPSB4aHIuc3RhdHVzOwogICAgICAgICAgICAgICAgZGZvLnN0YXR1c1RleHQgPSB4aHIuc3RhdHVzVGV4dDsKICAgICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgIGFyZ3VtZW50UmVzb2x2ZXIgPSBmdW5jdGlvbiAobWV0aG9kKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZXRob2QodXRpbC50b0FycmF5KGFyZ3VtZW50cykpOwogICAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgZGVmZXJDb250cm9sbGVySXRlbUNhbGxiYWNrID0gZnVuY3Rpb24gKGZ1bmMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzLCBhcmd1bWVudHNbMF1bMF0pOwogICAgICAgICAgICB9OwogICAgICAgIH07CgogICAgdmFyIFJlc3BvbnNlUXVldWUgPSBmdW5jdGlvbiAobW9kdWxlLCBzdGFydFRpbWVvdXQsIGZpbmlzaFRpbWVvdXQpCiAgICB7CiAgICAgICAgdGhpcy5zdGFydFRpbWVvdXQgPSBzdGFydFRpbWVvdXQ7CiAgICAgICAgdGhpcy5maW5pc2hUaW1lb3V0ID0gZmluaXNoVGltZW91dDsKICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgIH07CgogICAgUmVzcG9uc2VRdWV1ZS5wcm90b3R5cGUgPSB7CiAgICAgICAgYWRkVG9RdWV1ZTogZnVuY3Rpb24gKHR5cGUsIHVybCwgb3B0aW9ucykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZm8gID0gd2hlbi5kZWZlcigpLAogICAgICAgICAgICAgICAgdGhhdCA9IHRoaXM7CgogICAgICAgICAgICBpZiAob3B0aW9ucy5iZWZvcmVTZW5kKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgICAgIGRmby5wcm9ncmVzcyhmdW5jdGlvbiAoZXZlbnRUeXBlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChldmVudFR5cGUgJiYgZXZlbnRUeXBlID09ICdiZWZvcmUtc2VuZCcpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlU2VuZC5hcHBseShiZWZvcmVTZW5kLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbXBsZXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkZm8uYWx3YXlzKG9wdGlvbnMuY29tcGxldGUpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuY29tcGxldGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMuc3VjY2VzcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZGZvLnRoZW4ob3B0aW9ucy5zdWNjZXNzKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLmVycm9yKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkZm8ub3RoZXJ3aXNlKG9wdGlvbnMuZXJyb3IpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuZXJyb3I7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBoYXNRdWV1ZSA9ICEhcXVldWVbdHlwZV0sCiAgICAgICAgICAgICAgICBsaXN0ID0gcXVldWVbdHlwZV0gfHwgKHF1ZXVlW3R5cGVdID0ge30pLAogICAgICAgICAgICAgICAgdGFpbCA9IGxpc3QudGFpbCB8fCAobGlzdC50YWlsID0gbGlzdC5uZXh0ID0ge30pOwoKICAgICAgICAgICAgZXh0ZW5kKHRhaWwsIHsgdXJsOiB1cmwsIG9wdGlvbnM6IG9wdGlvbnMsIGRmbzogZGZvIH0pOwogICAgICAgICAgICBsaXN0LnRhaWwgPSB0YWlsLm5leHQgPSB7fTsKCiAgICAgICAgICAgIGlmICghaGFzUXVldWUpCiAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRoYXQuc3RhcnRUaW1lb3V0KS50aGVuKHRoYXQucHJvY2Vzcyh0eXBlKSk7CgogICAgICAgICAgICByZXR1cm4gZGZvLnByb21pc2U7CiAgICAgICAgfSwKICAgICAgICBwcm9jZXNzOiBmdW5jdGlvbiAodHlwZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgID0gcXVldWVbdHlwZV0sCiAgICAgICAgICAgICAgICBub2RlICAgID0gcGFyZW50LAogICAgICAgICAgICAgICAgdGhhdCAgICA9IHRoaXMsCiAgICAgICAgICAgICAgICBxdWVyeUlkID0gdWlkKCdkcScpOwoKICAgICAgICAgICAgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBDcmVhdGluZyBxdWV1ZSBmb3IgdHlwZSAiezF9IicsIHRoYXQubmFtZXNwYWNlLCB0eXBlKSk7CiAgICAgICAgICAgIHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50V2FpdCwgcXVlcnlJZCwgdHlwZSk7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBQcm9jZXNzaW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgICAgIHZhciB3aGVuUXVldWUgPSBbXSwgZGVmZXJDb250cm9sbGVyID0gd2hlbi5kZWZlcigpLCByZXR1cm5Db3VudCA9IDA7CgogICAgICAgICAgICAgICAgZGVmZXJDb250cm9sbGVyLnRoZW4oZnVuY3Rpb24gKCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBsb2cuZGVidWcoZm9ybWF0KCdEYXRhW3swfV06IEZpbmlzaGluZyBxdWV1ZSBmb3IgdHlwZSAiezF9IicsIHRoYXQubmFtZXNwYWNlLCB0eXBlKSk7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRTdG9wLCBxdWVyeUlkLCB0eXBlLCByZXR1cm5Db3VudCk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBkZWxldGUgcXVldWVbdHlwZV07CgogICAgICAgICAgICAgICAgdmFyIHRhaWwgPSBub2RlLnRhaWwsCiAgICAgICAgICAgICAgICAgICAgc3RhdHVzQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7IHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50U3RhdHVzLCBxdWVyeUlkLCB0eXBlLCArK3JldHVybkNvdW50KTsgfTsKICAgICAgICAgICAgICAgIHdoaWxlICgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRmbyA9IG5vZGUuZGZvLAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHt9LCBub2RlLm9wdGlvbnMpLAogICAgICAgICAgICAgICAgICAgICAgICB4aHJEZm8gPSB3aGVuLmRlZmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHhociA9IG5vZGUueGhyID0gYWpheChub2RlLnVybCwgb3B0aW9ucykudGhlbihhcmd1bWVudFJlc29sdmVyKHhockRmby5yZXNvbHZlKSwgYXJndW1lbnRSZXNvbHZlcih4aHJEZm8ucmVqZWN0KSk7CgogICAgICAgICAgICAgICAgICAgIHhockRmby50aGVuKHN0YXR1c0NhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICB3aGVuUXVldWUucHVzaCh4aHIpOwoKICAgICAgICAgICAgICAgICAgICB3aGVuLmFsbChbeGhyRGZvLCBkZWZlckNvbnRyb2xsZXIucHJvbWlzZV0sIHdoZW4uYXBwbHkoZGZvLnJlc29sdmUpLCB3aGVuLmFwcGx5KGRmby5yZWplY3QpLCB1cGRhdGVYSFJJbnRlcm5hbHMoZGZvLCB4aHIpKTsKCiAgICAgICAgICAgICAgICAgICAgZGZvLnByb2dyZXNzKCdiZWZvcmUtc2VuZCcsIFtkZm8sIG9wdGlvbnNdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFN0YXJ0LCBxdWVyeUlkLCB0eXBlLCB3aGVuUXVldWUubGVuZ3RoKTsKCiAgICAgICAgICAgICAgICB3aGVuLmFueShbd2hlbi5hbGwod2hlblF1ZXVlKSwgd2hlbi5kZWxheSh0aGF0LmZpbmlzaFRpbWVvdXQpXSwgZGVmZXJDb250cm9sbGVyLnJlc29sdmUsIGRlZmVyQ29udHJvbGxlci5yZXNvbHZlKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9OwoKICAgIHJldHVybiBSZXNwb25zZVF1ZXVlOwp9KTsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9tYWluJyxbCiAgICAnanF1ZXJ5JywKICAgICd0aHJ1c3QvdXRpbCcsCiAgICAndGhydXN0L2xvZycsCiAgICAndGhydXN0L2NvbmZpZycsCiAgICAnLi9ldmVudC5mYWN0b3J5JywKICAgICcuL3Jlc3BvbnNlLnF1ZXVlJywKICAgICd0aHJ1c3QvZXZlbnRzJywKICAgICd0aHJ1c3QvZmFjYWRlJywKICAgICcuL2V2ZW50LnR5cGVzJwpdLApmdW5jdGlvbiAoalF1ZXJ5LCB1dGlsLCBsb2csIGNvbmZpZywgZXZlbnRGYWN0b3J5LCBSZXNwb25zZVF1ZXVlLCBldmVudHMsIGZhY2FkZSwgZXZlbnRUeXBlcykKewogICAgCiAgICAvLyBWYXJpYWJsZSBkZWNsYXJhdGlvbi4KICAgIHZhciBmb3JtYXQgICAgICAgICAgPSB1dGlsLmZvcm1hdCwKICAgICAgICBleHRlbmQgICAgICAgICAgPSB1dGlsLmV4dGVuZCwKICAgICAgICB0eXBlICAgICAgICAgICAgPSB1dGlsLnR5cGUsCiAgICAgICAgd2hlbiAgICAgICAgICAgID0gdXRpbC53aGVuLAogICAgICAgIHNsaWNlICAgICAgICAgICA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKICAgICAgICBhamF4ICAgICAgICAgICAgPSBqUXVlcnkuYWpheCwKICAgICAgICB1aWQgICAgICAgICAgICAgPSB1dGlsLnVuaXF1ZUlkLAogICAgICAgIGRhdGFDYWNoZSAgICAgICA9IHt9LAogICAgICAgIGRhdGFFdmVudFdhaXQgICA9IGV2ZW50VHlwZXNbJ3dhaXQnXSwKICAgICAgICBkYXRhRXZlbnRTdGFydCAgPSBldmVudFR5cGVzWydzdGFydCddLAogICAgICAgIGRhdGFFdmVudFN0b3AgICA9IGV2ZW50VHlwZXNbJ3N0b3AnXSwKICAgICAgICBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzWydzdGF0dXMnXSwKICAgICAgICBkZWZhdWx0cyAgICAgICAgPSB7CiAgICAgICAgICAgIGNhY2hlICAgICAgICAgICAgICAgICAgOiBjb25maWcuZGF0YS5jYWNoZSwKICAgICAgICAgICAgYmVmb3JlU2VuZCAgICAgICAgICAgICA6IGV2ZW50RmFjdG9yeS5iZWZvcmVTZW5kTWV0aG9kLAogICAgICAgICAgICBjb250ZW50VHlwZSAgICAgICAgICAgIDogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICB0eXBlICAgICAgICAgICAgICAgICAgIDogJ1BPU1QnLAogICAgICAgICAgICB1cmwgICAgICAgICAgICAgICAgICAgIDogJycsCiAgICAgICAgICAgIGRhdGEgICAgICAgICAgICAgICAgICAgOiAnJywKICAgICAgICAgICAgZGF0YVR5cGUgICAgICAgICAgICAgICA6ICdqc29uJywKICAgICAgICAgICAgX19tZWRpYXRvcl9kYXRhX2ZpcmVkX186IHRydWUKICAgICAgICB9OwoKICAgIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWwgPSAhIWNvbmZpZy51cmwudHJhZGl0aW9uYWxFbmNvZGluZzsKCiAgICB2YXIgakRvYyA9IGpRdWVyeShkb2N1bWVudCk7CgogICAgZXZlbnRGYWN0b3J5LmluaXQoakRvYyk7CiAgICAvLyNyZWdpb24gRGF0YUZhY2FkZQogICAgdmFyIERhdGFGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkKICAgIHsKICAgICAgICB0aGlzLm5hbWUgPSBtb2R1bGUubmFtZSArICctZGF0YSc7CiAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CiAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gcGFyZW50Ll9jYWxsYmFja3M7CiAgICAgICAgdGhpcy5yZXNwb25zZVF1ZXVlID0gcGFyZW50LnJlc3BvbnNlUXVldWU7CiAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICB9KTsKICAgIHV0aWwuZXh0ZW5kKERhdGFGYWNhZGUuZm4sIGV2ZW50cyk7CiAgICAvLyNlbmRyZWdpb24KCiAgICB2YXIgRGF0YSA9IGZ1bmN0aW9uICgvKiAkcmVmICovIG5hbWUsIC8qICRyZWYgKi8gbWVkaWF0b3IsIC8qICRyZWYgKi8gY29uZmlnKQogICAgewogICAgICAgIC8vIEVuZm9yY2UgbmV3CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIERhdGEpKQogICAgICAgICAgICByZXR1cm4gbmV3IERhdGEobmFtZSwgbWVkaWF0b3IpOwoKICAgICAgICBpZiAoIW5hbWUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YTogbW9kdWxlIG5hbWUgbXVzdCBiZSBkZWZpbmVkLicpOwoKICAgICAgICB0aGlzLnJlc3BvbnNlUXVldWUgPSBuZXcgUmVzcG9uc2VRdWV1ZSh0aGlzLCBjb25maWcuZGF0YS5zdGFydFRpbWVvdXQsIGNvbmZpZy5kYXRhLmZpbmlzaFRpbWVvdXQpOwoKICAgICAgICBsb2cuZGVidWcoJ0RhdGE6IENyZWF0aW5nIG5ldyBEYXRhJyk7CgogICAgICAgIHRoaXMubWVkaWF0b3IgPSBtZWRpYXRvcjsKICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSB0aGlzLm1lZGlhdG9yLl9jYWxsYmFja3M7CiAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICB9OwoKICAgIHZhciBEYXRhTWV0aG9kcyA9IHsKICAgICAgICBjcmVhdGVGYWNhZGU6IGZ1bmN0aW9uICh0aHJ1c3QsIG1vZHVsZSwgZmFjYWRlcykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChtb2R1bGUuZGF0YSAmJiAhKGZhY2FkZXMuZGF0YSBpbnN0YW5jZW9mIERhdGFGYWNhZGUpKSB0aHJvdyBuZXcgRXJyb3IoJyJkYXRhIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CgogICAgICAgICAgICB2YXIgZGF0YTsKICAgICAgICAgICAgaWYgKGZhY2FkZXMuZGF0YSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZmFjYWRlcy5kYXRhLnVwZGF0ZUZhY2FkZShtb2R1bGUsIHRoaXMpOwogICAgICAgICAgICAgICAgZGF0YSA9IGZhY2FkZXMuZGF0YTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGRhdGEgPSBmYWNhZGVzLmRhdGEgPSBtb2R1bGUuZGF0YSA9IG5ldyBEYXRhRmFjYWRlKG1vZHVsZSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgfSwKICAgIH07CgogICAgdmFyIERhdGFQcm90b3R5cGUgPSB7CiAgICAgICAgZ2V0RGF0YTogZnVuY3Rpb24gKHVybCwgZGF0YSwgc2V0dGluZ3MpCiAgICAgICAgewogICAgICAgICAgICBzZXR0aW5ncyA9ICFzZXR0aW5ncyA/IHsgZGF0YTogZGF0YSB9IDogZXh0ZW5kKHNldHRpbmdzLCB7IGRhdGE6IGRhdGEgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldCh1cmwsIHNldHRpbmdzKTsKICAgICAgICB9LAogICAgICAgIHBvc3REYXRhOiBmdW5jdGlvbiAodXJsLCBkYXRhLCBzZXR0aW5ncykKICAgICAgICB7CiAgICAgICAgICAgIHNldHRpbmdzID0gIXNldHRpbmdzID8geyBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKSB9IDogZXh0ZW5kKHNldHRpbmdzLCB7IGRhdGE6IEpTT04uc3RyaW5naWZ5KGRhdGEpIH0pOwogICAgICAgICAgICByZXR1cm4gdGhpcy5wb3N0KHVybCwgc2V0dGluZ3MpOwogICAgICAgIH0sCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAodXJsLCBzZXR0aW5ncywganVtcFF1ZXVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHNldHRpbmdzID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCA9PT0gJ29iamVjdCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodXJsID09PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MudXJsICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIGlmICh1cmwgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdXJsIGlzIGRlZmluZWQnKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCBleHRlbmQoc2V0dGluZ3MgfHwge30sIHsgdHlwZTogJ2dldCcgfSksIGp1bXBRdWV1ZSk7CiAgICAgICAgfSwKICAgICAgICBwb3N0OiBmdW5jdGlvbiAodXJsLCBzZXR0aW5ncywganVtcFF1ZXVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHNldHRpbmdzID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCA9PT0gJ29iamVjdCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodXJsID09PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MudXJsICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIGlmICh1cmwgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdXJsIGlzIGRlZmluZWQnKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCBleHRlbmQoc2V0dGluZ3MgfHwge30sIHsgdHlwZTogJ3Bvc3QnIH0pLCBqdW1wUXVldWUpOwogICAgICAgIH0sCiAgICAgICAgYWRkVG9DYWNoZTogZnVuY3Rpb24gKGNhY2hlT2JqZWN0cykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjYWNoZU9iamVjdHMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhY2hlT2JqZWN0cy5mb3JFYWNoKGZ1bmN0aW9uICh4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRhdGFDYWNoZVt4LlVybF0gPSB4Lkpzb247CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYWpheDogZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MsIGp1bXBRdWV1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgb3B0aW9ucywgdHlwZSwgYmVmb3JlU2VuZDsKICAgICAgICAgICAgbG9nLmluZm8oZm9ybWF0KCdEYXRhW3swfV06IEZldGNoaW5nIGRhdGEgZnJvbSAiezF9IicsIHRoYXQubmFtZXNwYWNlLCB1cmwpKTsKCiAgICAgICAgICAgIGlmIChzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXNldHRpbmdzKQogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB7fTsKCiAgICAgICAgICAgIGlmICh1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKCgogICAgICAgICAgICB1cmwgPSB1dGlsLmZpeHVwVXJsKHVybCk7CgogICAgICAgICAgICB2YXIgbW9kdWxlID0gKHRoYXQubW9kdWxlICYmIHRoYXQubW9kdWxlLm1vZHVsZSk7CiAgICAgICAgICAgIGlmIChqdW1wUXVldWUgJiYgdGhhdC5fZmFzdEFqYXhQZXJtaXNzaW9uKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZGZvID0gd2hlbi5kZWZlcigpOwoKICAgICAgICAgICAgICAgIHZhciBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICAgICAgdHlwZSA9IHNldHRpbmdzLnR5cGUudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgICAgICB0aGF0LmZpcmUoZGF0YUV2ZW50V2FpdCwgcXVlcnlJZCwgdHlwZSk7CiAgICAgICAgICAgICAgICB0aGF0LmZpcmUoZGF0YUV2ZW50U3RhcnQsIHF1ZXJ5SWQsIHR5cGUsIDEpOwoKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoe30sIHsgYmVmb3JlU2VuZDogZXZlbnRGYWN0b3J5LmJlZm9yZVNlbmRNZXRob2QgfSwgZGVmYXVsdHMsIHNldHRpbmdzKTsKCiAgICAgICAgICAgICAgICB2YXIgeGhyID0gYWpheCh1cmwsIG9wdGlvbnMpLmFsd2F5cyhmdW5jdGlvbiAoKSB7IHRoYXQuZmlyZShkYXRhRXZlbnRTdGF0dXMsIHF1ZXJ5SWQsIHR5cGUsIDEpOyB0aGF0LmZpcmUoZGF0YUV2ZW50U3RvcCwgcXVlcnlJZCwgdHlwZSwgMSk7IH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4oeGhyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3B0aW9ucyA9IGV4dGVuZCh7fSwgZGVmYXVsdHMsIHNldHRpbmdzLCB7IGJlZm9yZVNlbmQ6IGV2ZW50RmFjdG9yeS5iZWZvcmVTZW5kTWV0aG9kIH0pOwoKICAgICAgICAgICAgdHlwZSA9IG9wdGlvbnMudHlwZS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzcG9uc2VRdWV1ZS5hZGRUb1F1ZXVlKHR5cGUsIHVybCwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgfTsKCiAgICB1dGlsLmV4dGVuZChEYXRhRmFjYWRlLmZuLCBEYXRhUHJvdG90eXBlKTsKCiAgICBEYXRhLnByb3RvdHlwZSA9IERhdGEuZm4gPSB1dGlsLmV4dGVuZCh7fSwgRGF0YU1ldGhvZHMsIERhdGFQcm90b3R5cGUsIGV2ZW50cyk7CgogICAgLy8gVGFrZSBhIGhvbGQgb2YgalF1ZXJ5Li4uIHRoaXMgaXMgc3VyZSB0byBiZSBjb250cmF2ZXNpYWwuCiAgICBqUXVlcnkuYWpheCA9IERhdGEuYWpheDsKCiAgICByZXR1cm4gRGF0YTsKfSk7CgpkZWZpbmUoJ3RocnVzdC9kYXRhJywgWyd0aHJ1c3QvZGF0YS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2RhdGEvY29udmVudGlvbi9zdGFydCcsWyd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLApmdW5jdGlvbiAoQ29udmVudGlvbiwgdXRpbCkKewogICAgdmFyIHdoZW4gPSB1dGlsLndoZW47CiAgICB2YXIgd2hlblF1ZXVlID0gW10sCiAgICAgICAgd2FpdENhbGxiYWNrID0gZnVuY3Rpb24gKHVpZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgZGVmZXIucmVzb2x2ZXIudWlkID0gdWlkOwoKICAgICAgICAgICAgd2hlblF1ZXVlLnB1c2goeyB1aWQ6IHVpZCwgcmVzb2x2ZXI6IGRlZmVyLnJlc29sdmVyIH0pOwogICAgICAgIH0sCiAgICAgICAgc3RvcENhbGxiYWNrID0gZnVuY3Rpb24gKHVpZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBpdGVtID0gdXRpbC5maW5kKHdoZW5RdWV1ZSwgZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHgudWlkID09PSB1aWQ7IH0pOwogICAgICAgICAgICB3aGVuUXVldWUgPSB1dGlsLndpdGhvdXQod2hlblF1ZXVlLCBpdGVtKTsKCiAgICAgICAgICAgIGl0ZW0ucmVzb2x2ZXIucmVzb2x2ZSgpOwogICAgICAgIH07CgogICAgLyoqCiAgICBUaGUgZGF0YSBzdGFydCBjb252ZW50aW9uLCBkZWxheXMgdGhydXN0cyByZWFkeSAob3JiaXQpIGV2ZW50LCB1bnRpbCBhIHNldCB0aW1lb3V0LCBvciBhbGwgdGhlIGNhbGxzIHJldHVybi4KCiAgICBUaGlzIGFsbG93cyB0aGUgVUkgdG8gYXBwZWFyIGFzIGlmIGl0IHdhcyBhbHdheXMgZnVsbHkgYnVpbHQsIGlmIHNob3duIGFmdGVyIHJlYWR5IHJldHVybnMuCgogICAgQG1vZHVsZSB0aHJ1c3QtZGF0YQogICAgQHN1Ym1vZHVsZSB0aHJ1c3QtZGF0YS1jb252ZW50aW9uLXN0YXJ0CiAgICAqKi8KICAgIHJldHVybiBuZXcgQ29udmVudGlvbih7CiAgICAgICAgY291bnRkb3duOiBmdW5jdGlvbih0aHJ1c3QpCiAgICAgICAgewogICAgICAgICAgICAvLyBTdWJzY3JpYmUgdG8gdGhlIHdhaXQgYW5kIHN0b3AgZXZlbnRzCiAgICAgICAgICAgIHRocnVzdC5kYXRhLnN1YnNjcmliZSgndGhydXN0L2RhdGEvd2FpdCcsIHdhaXRDYWxsYmFjayk7CiAgICAgICAgICAgIHRocnVzdC5kYXRhLnN1YnNjcmliZSgndGhydXN0L2RhdGEvc3RvcCcsIHN0b3BDYWxsYmFjayk7CiAgICAgICAgfSwKICAgICAgICBvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIFVuc3Vic2NyaWJlIGZyb20gdGhlIHdhaXQgYW5kIHN0b3AgZXZlbnRzCiAgICAgICAgICAgIHRocnVzdC5kYXRhLnVuc3Vic2NyaWJlKCd0aHJ1c3QvZGF0YS93YWl0Jywgd2FpdENhbGxiYWNrKTsKICAgICAgICAgICAgdGhydXN0LmRhdGEudW5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3N0b3AnLCBzdG9wQ2FsbGJhY2spOwoKICAgICAgICAgICAgLy8gZGVmZXIgdW50aWwgYW55IG9mIHRoZSBldmVudHMgdGhhdCB3ZXJlIGNhcHR1cmVkIGFyZSByZXNvbHZlZCwgb3IgdGhlIGRlbGF5IHBhc3Nlcy4KICAgICAgICAgICAgdmFyIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICByZXR1cm4gd2hlbi5hbnkoW3doZW4uYWxsKHdoZW5RdWV1ZSksIHdoZW4uZGVsYXkodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQpXSwgZGVmZXIucmVzb2x2ZSwgZGVmZXIucmVzb2x2ZSk7CiAgICAgICAgfQogICAgfSk7Cn0pOwovKiEgVGhydXN0IEpTIEZyYW1ld29yayAtIHYwLjEuMCAtIDIwMTItMDgtMjkKKiB0aHJ1c3QtaG9tZQoqIENvcHlyaWdodCAoYykgMjAxMiBEYXZpZCBEcmlzY29sbDsgTGljZW5zZWQgTUlUICovCgoKZGVmaW5lKCd0aHJ1c3QvZG9tL2pxdWVyeS5pbnRlcmZhY2UnLFsnanF1ZXJ5J10sCmZ1bmN0aW9uIChqUXVlcnkpCnsKICAgIHZhciBqUXVlcnlNZXRob2RzVG9JZ25vcmUgPSBbJ2NvbnN0cnVjdG9yJywgJ2luaXQnLCAnc2VsZWN0b3InLCAnanF1ZXJ5JywgJ3JlYWR5JywgJ2V4dGVuZCcsICdxdWV1ZScsICdkZXF1ZXVlJywgJ2NsZWFyUXVldWUnLCAncHJvbWlzZScsICdiaW5kJywgJ3VuYmluZCcsICdsaXZlJywgJ2RpZScsICdkZWxlZ2F0ZScsICd1bmRlbGVnYXRlJywgJ2JsdXInLCAnZm9jdXMnLCAnZm9jdXNpbicsICdmb2N1c291dCcsICdsb2FkJywgJ3Jlc2l6ZScsICdzY3JvbGwnLCAndW5sb2FkJywgJ2NsaWNrJywgJ2RibGNsaWNrJywgJ21vdXNlZG93bicsICdtb3VzZXVwJywgJ21vdXNlbW92ZScsICdtb3VzZW92ZXInLCAnbW91c2VvdXQnLCAnbW91c2VlbnRlcicsICdtb3VzZWxlYXZlJywgJ2NoYW5nZScsICdzZWxlY3QnLCAnc3VibWl0JywgJ2tleWRvd24nLCAna2V5cHJlc3MnLCAna2V5dXAnLCAnZXJyb3InLCAnZG9tTWFuaXAnLCAnc2VyaWFsaXplJywgJ3NlcmlhbGl6ZUFycmF5JywgJ2FqYXhTdGFydCcsICdhamF4U3RvcCcsICdhamF4Q29tcGxldGUnLCAnYWpheEVycm9yJywgJ2FqYXhTdWNjZXNzJywgJ2FqYXhTZW5kJywgJ190b2dnbGUnLCAnZmFkZVRvJywgJ3N0b3AnLCAnc2xpZGVEb3duJywgJ3NsaWRlVXAnLCAnc2xpZGVUb2dnbGUnLCAnZmFkZUluJywgJ2ZhZGVPdXQnLCAnZmFkZVRvZ2dsZScsIC8qIFRoZXNlIG1ldGhvZHMgYXJlIGhlcmUgYmVjYXVzZSB3ZSBidWlsZCBhIGN1c3RvbSBvbmUgdGhhdCBkb2VzIHRoZSBqb2Igd2l0aCBuYW1lIHNwYWNlZCBldmVudHMgKi8nb24nLCAnb2ZmJywgJ29uZSddLAogICAgICAgIHNsaWNlICAgICAgICAgICAgICAgICA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCiAgICAvLyNyZWdpb24galF1ZXJ5IEludGVyZmFjZSBMYXllcgogICAgdmFyIHVwZGF0ZUludGVybmFscyA9IGZ1bmN0aW9uIChzZWxlY3RvcikKICAgIHsKICAgICAgICBpZiAoc2VsZWN0b3IpCiAgICAgICAgICAgIHRoaXMuX2NvbnRleHQgPSBqUXVlcnkoc2VsZWN0b3IpOwogICAgICAgIHRoaXMuY29udGV4dCA9IHRoaXMuX2NvbnRleHQuY29udGV4dDsKICAgICAgICB0aGlzLnNlbGVjdG9yID0gdGhpcy5fY29udGV4dC5zZWxlY3RvcjsKCiAgICAgICAgLy8gTGF6aWx5IHJlbW92ZSBtaXNzaW5nIHN1ZG8tYXJyYXkgZWxlbWVudHMuCiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoIHx8IDAsIGlMZW4gPSB0aGlzLl9jb250ZXh0LmNvbnRleHQ7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzW2ldOwoKICAgICAgICB0aGlzLmxlbmd0aCA9IHRoaXMuX2NvbnRleHQubGVuZ3RoOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gdGhpcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgIHRoaXNbaV0gPSB0aGlzLl9jb250ZXh0W2ldOwogICAgfTsKCiAgICB2YXIgaW5pdENvbnRleHQgPSBmdW5jdGlvbiAoY29udGV4dCkKICAgIHsKICAgICAgICAvLyBJZiB0aGUgY29udGV4dCBpcyBhIGpRdWVyeSBjb250ZXh0LCByZWZlcmVuY2UgdGhhdC4KICAgICAgICAvLyBJZiBpdCBpc24ndCBhIGpRdWVyeSBjb250ZXh0LCBydW4gaXQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgPyBjb250ZXh0IDogalF1ZXJ5KGNvbnRleHQpOwoKICAgICAgICAvLyBLZWVwIGEgY2FjaGUgb2YgYWxsIGRvbSBzZWxlY3RvcnMsIGZvciBjbGVhbiB1cCBsYXRlci4KICAgICAgICAvL2lmICh0aGlzLl9wYXJlbnREb20gJiYgdGhpcy5fcGFyZW50RG9tICE9PSB0aGlzKSB0aGlzLl9wYXJlbnREb20uX2ludGVybmFsUXVlcmllcy5wdXNoKHRoaXMpOwoKICAgICAgICAvLyBVcGRhdGUgdGhlIGludGVybmFscyB0byBtYXRjaCB0aGUgbWltaWNpbmcgb2YgalF1ZXJ5LgogICAgICAgIHVwZGF0ZUludGVybmFscy5jYWxsKHRoaXMpOwogICAgfTsKCiAgICB2YXIgc29tZUZpbHRlciA9IGZ1bmN0aW9uIChpKSB7IHJldHVybiBmdW5jdGlvbiAoZSwgaW5kZXgpIHsgcmV0dXJuIGUgPT09IGk7IH07IH0sCiAgICAvLyBXcmFwcyBhIGpRdWVyeSBtZXRob2QsIHdpdGggb3VyIG93biB2ZXJzaW9uIG9mIGl0LgogICAgICAgIG1ldGhvZEZhY3RvcnkgPSBmdW5jdGlvbiAobWV0aG9kLCBEb21GYWNhZGUpCiAgICAgICAgewogICAgICAgICAgICAvLyBSZXR1cm5zIGEgbWV0aG9kLCB0aGF0IHVud3JhcHMgYW55IERvbUZhY2FkZSBmYWNhZGUgb2JqZWN0cwogICAgICAgICAgICAvLyBUaGVuIGl0IGhhbmRzIGl0IG9mZiB0byBqUXVlcnkuCiAgICAgICAgICAgIC8vIEFuYWx5c2luZyB0aGUgcmVzcG9uc2UsIHdlIGRlY2lkZSBpZiBqUXVlcnkgZ2F2ZSB1cyBvbmUgb2YgdGhlIGZvbGxvd2luZzoKICAgICAgICAgICAgLy8gICAgICAgIEEgalF1ZXJ5IGluc3RhbmNlLCB0aGVuIHdlIGRlY2lkZSBpZiBpdCBpczoKICAgICAgICAgICAgLy8gICAgICAgICAgICBhIG5ldyBpbnN0YW5jZSwgZWcgLmNoaWxkcmVuKCkKICAgICAgICAgICAgLy8gICAgICAgICAgICB0aGUgc2FtZSBpbnN0YW5jZSwgZWcgLmNzcygpCiAgICAgICAgICAgIC8vICAgICAgICBSZXR1cm5lZCBkYXRhLCBlZyAucG9zaXRpb24oKSBvciAuaXMoKQogICAgICAgICAgICAvLyAgICAgICAgICAgIFJldHVybiB0aGF0IGRhdGEuCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBTZWFyY2ggYWxsIGFyZ3VtZW50cywgaWYgd2UgZmluZCBhIERvbUZhY2FkZSwgdW53cmFwIGl0IHRvIHRoZSBqUXVlcnkgY29udGV4dC4KICAgICAgICAgICAgICAgIC8vIGpRdWVyeSBkb2VzbnQgdW5kZXJzdGFuZCBEb21GYWNhZGUgd3JhcHBlcnMsIGl0IG9ubHkgdW5kZXJzdGFuZHMgalF1ZXJ5LgogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGFyZ3MubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICAgICAgICAgIGlmIChhcmdzW2ldIGluc3RhbmNlb2YgRG9tRmFjYWRlKQogICAgICAgICAgICAgICAgICAgICAgICBhcmdzW2ldID0gYXJnc1tpXS5fY29udGV4dDsKCiAgICAgICAgICAgICAgICAvLyBDYXB0dXJlIHRoZSByZXR1cm4gdmFsdWUgZm9yIGFuYWx5c2lzIGFuZCBwYXNzIGl0IGFsb25nIHRvIHRoZSBpbnRlcm5hbCBqUXVlcnkgY29udGV4dCBhbmQgaXRzIG1ldGhvZC4KICAgICAgICAgICAgICAgIC8vIENhbGwgaW4gcGxhY2UgYXMgaWYgaXQgd2VyZSBjYWxsZWQgbm9ybWFsbHkuCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fY29udGV4dCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5fY29udGV4dFttZXRob2RdLmFwcGx5KHRoaXMuX2NvbnRleHQsIGFyZ3MpOwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgcmV0dXJuIHZhbHVlIGlzIGEgalF1ZXJ5IGluc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgaWYgKHJldCBpbnN0YW5jZW9mIGpRdWVyeSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIGl0J3MgdGhlIHNhbWUgaW5zdGFuY2UsIHRoZW4gd2UganVzdCB1cGRhdGUgdGhlIGludGVybmFscywgYW5kIHJldHVybiBvdXJzZWxmLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmV0LnNlbGVjdG9yID09PSB0aGlzLnNlbGVjdG9yICYmIHJldC5jb250ZXh0ID09PSB0aGlzLmNvbnRleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUludGVybmFscy5jYWxsKHRoaXMsIHJldCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBpdCBpcyBhIG5ldyBpbnN0YW5jZSwgcmV0dXJuIGEgbmV3IGZhY2FkZQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERvbUZhY2FkZSh0aGlzLm1vZHVsZSwgdGhpcywgcmV0LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gUmVnYXJkbGVzcyB1cGRhdGUgb3VyIGludGVybmFscy4KICAgICAgICAgICAgICAgICAgICB1cGRhdGVJbnRlcm5hbHMuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdGhlIHJldHVybiB2YWx1ZSwgZm9yIGEgbWV0aG9kIGxpa2UgLmlzKCkgb3IgLnBvc2l0aWlvbigpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgIHZhciB1cGRhdGVQcm90b3R5cGUgPSBmdW5jdGlvbiAocHJvdG8sIERvbUZhY2FkZSkKICAgIHsKICAgICAgICAvLyBXcmFwIGpRdWVyeSBhbmQgZmlsdGVyIG91dCBtZXRob2RzIHdlIGRvIG5vdCB3YW50IGFueW9uZSB1c2luZwogICAgICAgIC8vIFdlIGFsc28gZmlsdGVyIG91dCBtZXRob2RzIHRoYXQgd2Ugb3ZlcnJpZGUsIGxpa2UgLm9uIGFuZCAub2ZmCiAgICAgICAgZm9yICh2YXIgaSBpbiBqUXVlcnkuZm4pCiAgICAgICAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChqUXVlcnkuZm4sIGkpICYmICFwcm90b1tpXSAmJiAhalF1ZXJ5TWV0aG9kc1RvSWdub3JlLnNvbWUoc29tZUZpbHRlcihpKSkpCiAgICAgICAgICAgICAgICBwcm90b1tpXSA9IG1ldGhvZEZhY3RvcnkoaSwgRG9tRmFjYWRlKTsKICAgICAgICBwcm90by4kID0gcHJvdG8uZmluZDsKICAgIH07CiAgICAvLyNlbmRyZWdpb24KCiAgICByZXR1cm4gewogICAgICAgIHVwZGF0ZUludGVybmFsczogdXBkYXRlSW50ZXJuYWxzLAogICAgICAgIHVwZGF0ZVByb3RvdHlwZTogdXBkYXRlUHJvdG90eXBlLAogICAgICAgIGluaXRDb250ZXh0ICAgIDogaW5pdENvbnRleHQKICAgIH07Cn0pOwpkZWZpbmUoJ3RocnVzdC9kb20vbWFpbicsWwogICAgJ2pxdWVyeScsCiAgICAndGhydXN0L3V0aWwnLAogICAgJ3RocnVzdC9sb2cnLAogICAgJy4vanF1ZXJ5LmludGVyZmFjZScsCiAgICAndGhydXN0L2ZhY2FkZScsCiAgICAndGhydXN0L2V2ZW50cycKXSwKZnVuY3Rpb24gKGpRdWVyeSwgdXRpbCwgbG9nLCBqUXVlcnlJbnRlcmZhY2UsIGZhY2FkZSwgZXZlbnRzKQp7CiAgICAKICAgIC8vI3JlZ2lvbiBWYXJpYWJsZSBkZWNsYXJhdGlvbgogICAgdmFyIGZvcm1hdCAgICAgICAgICA9IHV0aWwuZm9ybWF0LAogICAgICAgIGV4dGVuZCAgICAgICAgICA9IHV0aWwuZXh0ZW5kLAogICAgICAgIHR5cGUgICAgICAgICAgICA9IHV0aWwudHlwZSwKICAgICAgICBwcm94eSAgICAgICAgICAgPSB1dGlsLnByb3h5LAogICAgICAgIGhhc093biAgICAgICAgICA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgaXNPYmplY3QgICAgICAgID0gdXRpbC5pc1NpbXBsZU9iamVjdCwKICAgICAgICBzbGljZSAgICAgICAgICAgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCiAgICAgICAgd2hlbiAgICAgICAgICAgID0gdXRpbC53aGVuLAogICAgICAgIGluaXRDb250ZXh0ICAgICA9IGpRdWVyeUludGVyZmFjZS5pbml0Q29udGV4dCwKICAgICAgICB1cGRhdGVJbnRlcm5hbHMgPSBqUXVlcnlJbnRlcmZhY2UudXBkYXRlSW50ZXJuYWxzLAogICAgICAgIHVwZGF0ZVByb3RvdHlwZSA9IGpRdWVyeUludGVyZmFjZS51cGRhdGVQcm90b3R5cGUsCiAgICAgICAgRG9tLCBEb21NZXRob2RzLCBEb21Qcm90b3R5cGU7CiAgICAvLyNlbmRyZWdpb24KCiAgICAvLyNyZWdpb24gRGF0YUZhY2FkZQogICAgdmFyIERvbUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZHVsZSwgcGFyZW50LCBjb250ZXh0LCBmYWtlKQogICAgewogICAgICAgIHRoaXMubmFtZSA9IHBhcmVudC5uYW1lOwogICAgICAgIC8vdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgLy90aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAvL3RoaXMuX2NhbGxiYWNrcyA9IHBhcmVudC5fY2FsbGJhY2tzOwogICAgICAgIC8vdGhpcy5pbml0RXZlbnRzKCk7CgogICAgICAgIC8vIFdlJ3JlIGJ1aWxkaW5nIGEgZG9tIHNlbGVjdG9yLCBha2EganF1ZXJ5IHdyYXBwZXIKICAgICAgICBpZiAoY29udGV4dCAmJiBmYWtlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gUmVmZXJlbmNlIHRoZSBwYXJlbnQgbW9kdWxlLgogICAgICAgICAgICB0aGlzLl9wYXJlbnREb20gPSBwYXJlbnQuX3BhcmVudERvbTsKICAgICAgICAgICAgaWYgKHRoaXMuX3BhcmVudERvbSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gSW5pdCB0aGUgY29udGV4dAogICAgICAgICAgICAgICAgaW5pdENvbnRleHQuY2FsbCh0aGlzLCBjb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBsb2cuZGVidWcoJ0RvbTogQ3JlYXRpbmcgbmV3IERvbSBmYWNhZGUnKTsKICAgICAgICAgICAgdGhpcy5fcGFyZW50RG9tICAgPSB0aGlzOwogICAgICAgICAgICB0aGlzLl9yb290Q29udGV4dCA9IHRydWU7CgogICAgICAgICAgICB0aGlzLmNoYW5nZUNvbnRleHQoZG9jdW1lbnQpOwoKICAgICAgICAgICAgY3JlYXRlRmFjYWRlKHRoaXMpOwogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cyA9IFtdOwogICAgICAgIH0KICAgIH0pOwogICAgdXRpbC5leHRlbmQoRG9tRmFjYWRlLmZuLCB7CiAgICAgICAgaW5pdDogZnVuY3Rpb24gKGZha2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cyA9IHRoaXMuX2ludGVybmFsRXZlbnRzIHx8IFtdOwogICAgICAgICAgICBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogSW5pdGFsaXppbmcgezF9RG9tIGZhY2FkZScsIHRoaXMubmFtZXNwYWNlLCBmYWtlID8gJ2Zha2UgJyA6ICcnKSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogU3RhcnRpbmcgRG9tIGZhY2FkZScsIHRoaXMubmFtZXNwYWNlKSk7CiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IFN0b3BwaW5nIERvbSBmYWNhZGUnLCB0aGlzLm5hbWVzcGFjZSkpOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX2ludGVybmFsRXZlbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgc3ViID0gdGhpcy5faW50ZXJuYWxFdmVudHNbaV07CiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICB0aGlzLmNoYW5nZUNvbnRleHQoc3ViLmNvbnRleHQpOwogICAgICAgICAgICAgICAgdGhpcy5vZmYuYXBwbHkodGhpcywgKHV0aWwuaXNBcnJheShzdWIpKSA/IHN1YiA6ICh1dGlsLmlzQXJyYXkoc3ViLmFyZ3MpKSA/IHN1Yi5hcmdzIDogW10pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3Jvb3RDb250ZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogRGVzdHJveWluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbnRlcm5hbEV2ZW50czsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9jb250ZXh0OwogICAgICAgIH0KICAgIH0pOwogICAgLy8jZW5kcmVnaW9uCgogICAgdmFyIGNyZWF0ZUZhY2FkZSA9IGZ1bmN0aW9uIChkb20pCiAgICB7CiAgICAgICAgaWYgKCFkb20ucXVlcnkpCiAgICAgICAgICAgIGRvbS5xdWVyeSA9IGZ1bmN0aW9uIChjb250ZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQgIT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRG9tRmFjYWRlKGRvbS5tb2R1bGUsIGRvbSwgY29udGV4dCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZG9tOwogICAgICAgICAgICB9LmJpbmQoZG9tKTsKICAgICAgICByZXR1cm4gZG9tLnF1ZXJ5OwogICAgfTsKCiAgICAvLyBUaGlzIG1ldGhvZCB1cGRhdGVzIHRoZSBpbnRlcm5hbHMsIHRvIG1pbWljIGpRdWVyeQogICAgdmFyIG5vcm1hbGl6ZUV2ZW50cyA9IGZ1bmN0aW9uIChldmVudHMsIG5hbWVzcGFjZSkKICAgIHsKICAgICAgICAvLy8gPHN1bW1hcnk+Tm9ybWFsaXplcyBldmVudHMgdG8gdGFrZSBvbiB0aGUgbmFtZXNwYWNlIG9mIHRoZSBwYXJlbnQuPC9zdW1tYXJ5PgogICAgICAgIGlmIChpc09iamVjdChldmVudHMpKQogICAgICAgIHsKICAgICAgICAgICAgLy8gSGFuZGxlcyBrZXkgdmFsdWUgcGFyaXMgb2YgZXZlbnRzIHRvIGhhbmRsZXJzLgogICAgICAgICAgICBmb3IgKHZhciBpIGluIGV2ZW50cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZXZlbnRzW2kgKyBuYW1lc3BhY2VdID0gZXZlbnRzW2ldOwogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50c1tpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyBIYW5kbGUgYWJzZW5zZSBvZiBhbiBldmVudCwgcGFzcyBvdXIgbmFtZXNwYWNlLgogICAgICAgICAgICBpZiAoIWV2ZW50cykKICAgICAgICAgICAgICAgIHJldHVybiBuYW1lc3BhY2U7CgogICAgICAgICAgICAvLyBTcGxpdCB0aGUgZXZlbnRzIHVwCiAgICAgICAgICAgIGV2ZW50cyA9IGV2ZW50cy5zcGxpdCgnICcpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGV2ZW50cy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIEFkZCBvdXIgY3VzdG9tIGV2ZW50cwogICAgICAgICAgICAgICAgZXZlbnRzLnB1c2goZXZlbnRzW2ldICsgbmFtZXNwYWNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBHcmFiIHRoZSBuZXcgaGFsZiBvZiB0aGUgYXJyYXkgdGhhdCB3ZSBjYXJlIGFvdXQuCiAgICAgICAgICAgIHJldHVybiBldmVudHMuc2xpY2UoZXZlbnRzLmxlbmd0aCAvIDIpLmpvaW4oJyAnKTsKICAgICAgICB9CiAgICB9OwoKICAgIERvbVByb3RvdHlwZSA9IHsKICAgICAgICBjaGFuZ2VDb250ZXh0OiBmdW5jdGlvbiAoc2VsZWN0b3IpCiAgICAgICAgewogICAgICAgICAgICBsb2cuaW5mbyhmb3JtYXQoJ0RvbVt7MH1dOiBDaGFuZ2luZyBEb20gY29udGV4dCcsIHRoaXMubmFtZXNwYWNlKSk7CiAgICAgICAgICAgIHVwZGF0ZUludGVybmFscy5jYWxsKHRoaXMsIHNlbGVjdG9yKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICBvbjogZnVuY3Rpb24gKGV2ZW50cykKICAgICAgICB7CiAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBCaW5kaW5nIGV2ZW50cy4uLicsIHRoaXMubmFtZXNwYWNlKSk7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzWzBdID0gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgdGhpcy5uYW1lc3BhY2UpOwogICAgICAgICAgICB0aGlzLl9jb250ZXh0Lm9uLmFwcGx5KHRoaXMuX2NvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIG9uZTogZnVuY3Rpb24gKGV2ZW50cykKICAgICAgICB7CiAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBCaW5kaW5nIG9uZSBldmVudHMuLi4nLCB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJnc1swXSA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoaXMubmFtZXNwYWNlKTsKICAgICAgICAgICAgdGhpcy5fY29udGV4dC5vbmUuYXBwbHkodGhpcy5fY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgb2ZmOiBmdW5jdGlvbiAoZXZlbnRzKQogICAgICAgIHsKICAgICAgICAgICAgbG9nLmRlYnVnKGZvcm1hdCgnRG9tW3swfV06IFVuYmluZGluZyBldmVudHMuLi4nLCB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJnc1swXSA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoaXMubmFtZXNwYWNlKTsKICAgICAgICAgICAgdGhpcy5fY29udGV4dC5vbi5hcHBseSh0aGlzLl9jb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgfTsKCiAgICB1cGRhdGVQcm90b3R5cGUoRG9tUHJvdG90eXBlLCBEb21GYWNhZGUpOwogICAgdXRpbC5leHRlbmQoRG9tRmFjYWRlLmZuLCBEb21Qcm90b3R5cGUpOwogICAgRG9tRmFjYWRlLmZuLiQgPSBEb21GYWNhZGUuZm4uZmluZDsKCiAgICAvLyNyZWdpb24gRG9tCiAgICBEb20gPSBmdW5jdGlvbiAoLyogJHJlZiAqLyBuYW1lLCAvKiAkcmVmICovIG1lZGlhdG9yKQogICAgewogICAgICAgIC8vLyA8c3VtbWFyeT5UaGUgRG9tPC9zdW1tYXJ5PgogICAgICAgIC8vIEVuZm9yY2UgbmV3CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIERvbSkpCiAgICAgICAgICAgIHJldHVybiBuZXcgRG9tKG5hbWUsIG1lZGlhdG9yKTsKCiAgICAgICAgaWYgKCFuYW1lKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbTogbW9kdWxlIG5hbWUgbXVzdCBiZSBkZWZpbmVkLicpOwoKICAgICAgICBsb2cuZGVidWcoJ0RhdGE6IENyZWF0aW5nIG5ldyBEYXRhJyk7CgogICAgICAgIHRoaXMubWVkaWF0b3IgPSBtZWRpYXRvcjsKICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSB0aGlzLm1lZGlhdG9yLl9jYWxsYmFja3M7CiAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKCiAgICAgICAgLyp0aGlzLl9wYXJlbnREb20gPSB0aGlzOwogICAgICAgIHRoaXMuX3Jvb3RDb250ZXh0ID0gdHJ1ZTsKCiAgICAgICAgY3JlYXRlRmFjYWRlKHRoaXMpOwogICAgICAgIHRoaXMuX2ludGVybmFsRXZlbnRzID0gW107CiAgICAgICAgdGhpcy5jaGFuZ2VDb250ZXh0KGRvY3VtZW50KTsqLwogICAgfTsKCiAgICBEb20ucHJvdG90eXBlID0gRG9tLmZuID0gdXRpbC5leHRlbmQoe30sIERvbVByb3RvdHlwZSwKICAgIHsKICAgICAgICBjcmVhdGVGYWNhZGU6IGZ1bmN0aW9uICh0aHJ1c3QsIG1vZHVsZSwgZmFjYWRlcykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChtb2R1bGUuZG9tICYmICEoZmFjYWRlcy5kb20gaW5zdGFuY2VvZiBEb21GYWNhZGUpKSB0aHJvdyBuZXcgRXJyb3IoJyJkb20iIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKCiAgICAgICAgICAgIHZhciBkb207CiAgICAgICAgICAgIGlmIChmYWNhZGVzLmRvbSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZmFjYWRlcy5kb20udXBkYXRlRmFjYWRlKG1vZHVsZSwgdGhpcywgZG9jdW1lbnQpOwogICAgICAgICAgICAgICAgZG9tID0gZmFjYWRlcy5kb207CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkb20gPSBmYWNhZGVzLmRvbSA9IG5ldyBEb21GYWNhZGUobW9kdWxlLCB0aGlzLCBkb2N1bWVudCk7CiAgICAgICAgICAgICAgICBtb2R1bGUuZG9tID0gbW9kdWxlLiQgPSBkb20ucXVlcnk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRvbTsKICAgICAgICB9CiAgICB9LCBldmVudHMpOwoKICAgIC8vI2VuZHJlZ2lvbgoKICAgIHJldHVybiBEb207Cn0pOwoKZGVmaW5lKCd0aHJ1c3QvZG9tJywgWyd0aHJ1c3QvZG9tL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYWN0aW9uJyxbCiAgICAndGhydXN0L2NvbnZlbnRpb24nLAogICAgJ3RocnVzdC91dGlsJywKICAgICdqcXVlcnknCl0sCmZ1bmN0aW9uIChDb252ZW50aW9uLCB1dGlsLCAkKQp7CiAgICB2YXIgZm9ybWF0ICAgICA9IHV0aWwuZm9ybWF0LAogICAgICAgIEFDVElPTlMgICAgPSAnYWN0aW9ucycsCiAgICAgICAgU1RSSU5HICAgICA9ICdzdHJpbmcnLAogICAgICAgIGlzRnVuY3Rpb24gPSB1dGlsLmlzRnVuY3Rpb24sCiAgICAgICAgaXNTdHJpbmcgICA9IHV0aWwuaXNTdHJpbmcsCiAgICAgICAgaXNBcnJheSAgICA9IHV0aWwuaXNBcnJheTsKCiAgICB2YXIgYWN0aW9uSGFuZGxlcnMgPSB7CiAgICAgICAgX3JlZ2lzdHJhdGlvbnM6IHt9LAogICAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoZXZlbnROYW1lLCBhY2lvbk5hbWUsIGhhbmRsZXIsIGNvbnRleHQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmICghdGhhdC5fcmVnaXN0cmF0aW9uc1tldmVudE5hbWVdKQogICAgICAgICAgICAgICAgdGhhdC5fcmVnaXN0cmF0aW9uc1tldmVudE5hbWVdID0ge307CgogICAgICAgICAgICBpZiAoIXRoYXQuX3JlZ2lzdHJhdGlvbnNbZXZlbnROYW1lXVthY2lvbk5hbWVdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGF0Ll9yZWdpc3RyYXRpb25zW2V2ZW50TmFtZV1bYWNpb25OYW1lXSA9IGhhbmRsZXI7CiAgICAgICAgICAgICAgICBpZiAoY29udGV4dCkgdGhhdC5fcmVnaXN0cmF0aW9uc1tldmVudE5hbWVdW2FjaW9uTmFtZV0uY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnVGhlIGFjdGlvbiB7MX0gaGFuZGxlciAiezB9IiBoYXMgYWxyZWFkeSBiZWVuIHRha2VuIScsIGFjaW9uTmFtZSwgZXZlbnROYW1lKSk7CiAgICAgICAgfSwKICAgICAgICB1bnJlZ2lzdGVyOiBmdW5jdGlvbiAoZXZlbnROYW1lLCBhY2lvbk5hbWUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmICh0aGF0Ll9yZWdpc3RyYXRpb25zW2V2ZW50TmFtZV0gJiYgdGhhdC5fcmVnaXN0cmF0aW9uc1tldmVudE5hbWVdW2FjaW9uTmFtZV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQuX3JlZ2lzdHJhdGlvbnNbZXZlbnROYW1lXVthY2lvbk5hbWVdID0gbnVsbDsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGF0Ll9yZWdpc3RyYXRpb25zW2V2ZW50TmFtZV1bYWNpb25OYW1lXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY2FsbGJhY2tGb3I6IGZ1bmN0aW9uIChldmVudE5hbWUsIHJldHVyblJlc3VsdHMpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHZhciBhY3Rpb25BdHRyaWJ1dGUgPSAnZGF0YS1hY3Rpb24tJyArIGV2ZW50TmFtZSwKICAgICAgICAgICAgICAgIHJldHVyblJlc3VsdHNEZWZpbmVkID0gdHlwZW9mIHJldHVyblJlc3VsdHMgIT09ICd1bmRlZmluZWQnOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVWYWx1ZSA9ICQodGhpcykuYXR0cihhY3Rpb25BdHRyaWJ1dGUpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGVWYWx1ZSA9PT0gU1RSSU5HKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBtZXRob2QgPSB0aGF0Ll9yZWdpc3RyYXRpb25zW2V2ZW50TmFtZV1bYXR0cmlidXRlVmFsdWVdOwogICAgICAgICAgICAgICAgICAgIGlmIChtZXRob2QpCiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZC5hcHBseShtZXRob2QuY29udGV4dCB8fCB0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5SZXN1bHRzRGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldHVyblJlc3VsdHM7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIG5ldyBDb252ZW50aW9uKHsKICAgICAgICBwcm9wZXJ0aWVzOiBbQUNUSU9OU10sCiAgICAgICAgaWduaXRlOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICAkKHdpbmRvdy5kb2N1bWVudC5ib2R5KS5vbignY2xpY2suYWN0aW9ucycsICdhLCBidXR0b24sIGlucHV0W3R5cGU9ImJ1dHRvbiJdLCBpbnB1dFt0eXBlPSJzdWJtaXQiXScsIGFjdGlvbkhhbmRsZXJzLmNhbGxiYWNrRm9yKCdjbGljaycsIGZhbHNlKSk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKGZhY2FkZSwgbW9kdWxlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGFjdGlvbnMgPSBtb2R1bGUuY29udmVudGlvbihBQ1RJT05TKSwKICAgICAgICAgICAgICAgIGRvbSA9IGZhY2FkZSwKICAgICAgICAgICAgICAgIG1vZHVsZUluc3RhbmNlID0gbW9kdWxlLmluc3RhbmNlOwoKICAgICAgICAgICAgaWYgKGFjdGlvbnMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGFjdGlvbkV2ZW50IGluIGFjdGlvbnMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbkNvbGxlY3Rpb24gPSBhY3Rpb25zW2FjdGlvbkV2ZW50XTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBhY3Rpb25OYW1lIGluIGFjdGlvbkNvbGxlY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gYWN0aW9uQ29sbGVjdGlvblthY3Rpb25OYW1lXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihhY3Rpb24pKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gW2FjdGlvbkV2ZW50LCBhY3Rpb25OYW1lLCBhY3Rpb25dOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RyaW5nKGFjdGlvbikpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBbYWN0aW9uRXZlbnQsIGFjdGlvbk5hbWUsIG1vZHVsZUluc3RhbmNlW2FjdGlvbl1dOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzQXJyYXkoYWN0aW9uKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oYWN0aW9uWzBdKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gW2FjdGlvbkV2ZW50LCBhY3Rpb25OYW1lXS5jb25jYXQoYWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RyaW5nKGFjdGlvblswXSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uWzBdID0gbW9kdWxlSW5zdGFuY2VbYWN0aW9uWzBdXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gW2FjdGlvbkV2ZW50LCBhY3Rpb25OYW1lXS5jb25jYXQoYWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25IYW5kbGVycy5yZWdpc3Rlci5hcHBseShhY3Rpb25IYW5kbGVycywgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbiAoZmFjYWRlLCBtb2R1bGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgZG9tID0gZmFjYWRlLAogICAgICAgICAgICAgICAgYWN0aW9ucyA9IG1vZHVsZS5jb252ZW50aW9uKEFDVElPTlMpLAogICAgICAgICAgICAgICAgbW9kdWxlSW5zdGFuY2UgPSBtb2R1bGUuaW5zdGFuY2UsCiAgICAgICAgICAgICAgICBkb20gPSBmYWNhZGUuZG9tOwoKICAgICAgICAgICAgaWYgKGFjdGlvbnMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGFjdGlvbkV2ZW50IGluIGFjdGlvbnMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbkNvbGxlY3Rpb24gPSBhY3Rpb25zW2FjdGlvbkV2ZW50XTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBhY3Rpb25OYW1lIGluIGFjdGlvbkNvbGxlY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25IYW5kbGVycy51bnJlZ2lzdGVyKGFjdGlvbkV2ZW50LCBhY3Rpb25OYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKfSk7CmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2NvbnRleHQnLFsndGhydXN0L2NvbnZlbnRpb24nLCAnLi4vanF1ZXJ5LmludGVyZmFjZSddLApmdW5jdGlvbiAoQ29udmVudGlvbiwgalF1ZXJ5SW50ZXJmYWNlKQp7CiAgICB2YXIgQ09OVEVYVCAgICAgICAgID0gJ2NvbnRleHQnLAogICAgICAgIHVwZGF0ZUludGVybmFscyA9IGpRdWVyeUludGVyZmFjZS51cGRhdGVJbnRlcm5hbHM7CgogICAgcmV0dXJuIG5ldyBDb252ZW50aW9uKHsKICAgICAgICBwcm9wZXJ0aWVzOiBbQ09OVEVYVF0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChmYWNhZGUsIG1vZHVsZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0gbW9kdWxlLmNvbnZlbnRpb24oQ09OVEVYVCksCiAgICAgICAgICAgICAgICBkb20gICAgID0gZmFjYWRlOwoKICAgICAgICAgICAgaWYgKGNvbnRleHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHVwZGF0ZUludGVybmFscy5jYWxsKGRvbSwgY29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKfSk7CmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JyxbCiAgICAndGhydXN0L2NvbnZlbnRpb24nLAogICAgJ3RocnVzdC91dGlsJwpdLApmdW5jdGlvbiAoQ29udmVudGlvbiwgdXRpbCkKewogICAgdmFyIENPTlRFWFQgICAgPSAnY29udGV4dCcsCiAgICAgICAgRVZFTlRTICAgICA9ICdldmVudHMnLAogICAgICAgIGlzRnVuY3Rpb24gPSB1dGlsLmlzRnVuY3Rpb24sCiAgICAgICAgaXNTdHJpbmcgICA9IHV0aWwuaXNTdHJpbmcsCiAgICAgICAgaXNBcnJheSAgICA9IHV0aWwuaXNBcnJheTsKCiAgICByZXR1cm4gbmV3IENvbnZlbnRpb24oewogICAgICAgIHByb3BlcnRpZXM6IFtFVkVOVFNdLAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAoZmFjYWRlLCBtb2R1bGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgZXZlbnRzICAgICAgICAgID0gbW9kdWxlLmNvbnZlbnRpb24oRVZFTlRTKSwKICAgICAgICAgICAgICAgIG9wdGlvbmFsQ29udGV4dCA9IG1vZHVsZS5jb252ZW50aW9uKENPTlRFWFQpLAogICAgICAgICAgICAgICAgZG9tICAgICAgICAgICAgID0gb3B0aW9uYWxDb250ZXh0ID8gZmFjYWRlLnF1ZXJ5KG9wdGlvbmFsQ29udGV4dCkgOiBmYWNhZGUsCiAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZSAgPSBtb2R1bGUuaW5zdGFuY2U7CgogICAgICAgICAgICBpZiAoZXZlbnRzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBldmVudCBpbiBldmVudHMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlZmluaXRpb24gPSBldmVudHNbZXZlbnRdLAogICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGRlZmluaXRpb24pKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50ID0gW2V2ZW50LCBkZWZpbml0aW9uXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBldmVudCBtZXRob2QgaXMgYSBzdHJpbmcsIHdlIHNlYXJjaCB0byB2ZXJpZnkgdGhhdCBtb2R1bGUgbWV0aG9kIGV4aXN0cyBvbiB0aGUgZ2l2ZW4gbW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgICB0aGVuIGJpbmQgaXQsIHdpdGggdGhlIHByb3BlciBjb250ZXh0LgogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RyaW5nKGRlZmluaXRpb24pKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50ID0gW2V2ZW50LCBtb2R1bGVJbnN0YW5jZVtkZWZpbml0aW9uXV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZXZlbnQgbW9kdWxlIGlzIGFuIGFycmF5LCB3ZSBhcHBseSB0aGUgYXJyYXkgYXMgaWYgaXQgd2VyZSBhIGRpcmVjdCBjYWxsIHRvIHN1YnNjcmliZSwgYnkgcHVzaGluZyB0aGUgZXZlbnQgbmFtZSBvbiB0aGUgZnJvbnQuCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNBcnJheShkZWZpbml0aW9uKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudCA9IGRlZmluaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gZGVmaW5pdGlvbi5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhkZWZpbml0aW9uW2ldKSAmJiBtb2R1bGVJbnN0YW5jZVtkZWZpbml0aW9uW2ldXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZpbml0aW9uW2ldID0gbW9kdWxlSW5zdGFuY2VbZGVmaW5pdGlvbltpXV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50LnVuc2hpZnQoMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIENhbGwgdGhlIG9uIG1ldGhvZCwgd2l0aCBvdXIgYXJndW1lbnRzLgogICAgICAgICAgICAgICAgICAgIGRvbS5vbi5hcHBseShkb20sIGJpbmRFdmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvL1NhdmUgYSByZWZlcmVuY2Ugb2YgdGhlIGNvbnRleHQsIGZvciBsYXRlciB1bmJpbmRpbmcuCiAgICAgICAgICAgICAgICBldmVudHMuY29udGV4dCA9IGRvbS5fY29udGV4dFswXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKGZhY2FkZSwgbW9kdWxlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IG1vZHVsZS5jb252ZW50aW9uKEVWRU5UUyksCiAgICAgICAgICAgICAgICBkb20gPSBmYWNhZGU7CgogICAgICAgICAgICBpZiAoZXZlbnRzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkb20uY2hhbmdlQ29udGV4dChldmVudHMuY29udGV4dCk7CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnRzLmNvbnRleHQ7CgogICAgICAgICAgICAgICAgaWYgKGRvbS5fY29udGV4dCkKICAgICAgICAgICAgICAgICAgICBkb20ub2ZmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKfSk7Ci8qISBUaHJ1c3QgSlMgRnJhbWV3b3JrIC0gdjAuMS4wIC0gMjAxMi0wOC0yOQoqIHRocnVzdC1ob21lCiogQ29weXJpZ2h0IChjKSAyMDEyIERhdmlkIERyaXNjb2xsOyBMaWNlbnNlZCBNSVQgKi8KCgpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9tYWluJyxbCiAgICAncmVxdWlyZScsCiAgICAndGhydXN0L3V0aWwnLAogICAgJ3RocnVzdC9kYXRhJywKICAgICd0aHJ1c3QvbG9nJywKICAgICd0aHJ1c3QvY29uZmlnJywKICAgICdkb21SZWFkeScsCiAgICAnbG9kYXNoJywKICAgICd0aHJ1c3QvZmFjYWRlJwpdLAogICAgZnVuY3Rpb24gKHJlcXVpcmUsIHV0aWwsIHREYXRhLCBsb2csIGNvbmZpZywgZG9tUmVhZHksIF8sIGZhY2FkZSkKICAgIHsKICAgICAgICB2YXIgTE9ORyAgICAgICAgPSAnbG9uZycsCiAgICAgICAgICAgIFNIT1JUICAgICAgID0gJ3Nob3J0JywKICAgICAgICAgICAgSUQgICAgICAgICAgPSAnaWQnLAogICAgICAgICAgICB0ZW1wbGF0ZXMgICA9IHsKICAgICAgICAgICAgICAgIGxvbmc6IHt9LAogICAgICAgICAgICAgICAgc2hvcnQ6IHt9LAogICAgICAgICAgICAgICAgaWQ6IHt9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlZXBDb3B5ICAgID0gdXRpbC5kZWVwQ29weSwKICAgICAgICAgICAgZm9ybWF0ICAgICAgPSB1dGlsLmZvcm1hdCwKICAgICAgICAgICAgZWFjaCAgICAgICAgPSB1dGlsLmVhY2gsCiAgICAgICAgICAgIHdoZW4gICAgICAgID0gdXRpbC53aGVuLAogICAgICAgICAgICBtZW1vaXplICAgICA9IHV0aWwubWVtb2l6ZSwKICAgICAgICAgICAgZ2V0TG9uZ05hbWUgPSBmdW5jdGlvbiAobmFtZSwgdHlwZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgcmV0dXJuICh0aGF0LnNob3J0TmFtZShuYW1lKSArICcuJyArICh0eXBlIHx8IHRoYXQuZGVmYXVsdFR5cGUpICsgdGhhdC5leHRlbnNpb24pLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldFNob3J0TmFtZSA9IGZ1bmN0aW9uIChuYW1lKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5yZWR1Y2UodGhhdC50ZW1wbGF0ZVR5cGVzLCBmdW5jdGlvbiAobWVtbywgeCkgeyByZXR1cm4gbWVtby5yZXBsYWNlKCcuJyArIHgudG9Mb3dlckNhc2UoKSArIHRoYXQuZXh0ZW5zaW9uLCAnJyk7IH0sIG5hbWUudG9Mb3dlckNhc2UoKSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0VGVtcGxhdGVJZCA9IGZ1bmN0aW9uIChuYW1lKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zaG9ydE5hbWUobmFtZSkucmVwbGFjZSgvXC8vZywgJy0nKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgdmFyIFRlbXBsYXRlID0gZnVuY3Rpb24gKC8qICRyZWYgKi8gY29uZmlnLCAvKiAkcmVmICovIGRhdGEpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCAgICAgICAgICAgPSB0aGlzOwogICAgICAgICAgICBjb25maWcgICAgICAgICAgICAgPSBjb25maWcudGVtcGxhdGU7CiAgICAgICAgICAgIHRoYXQuZXh0ZW5zaW9uICAgICA9IGNvbmZpZy5leHRlbnNpb247CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVQYXRocyA9IGNvbmZpZy50eXBlczsKICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZVR5cGVzID0gdXRpbC5tYXAoY29uZmlnLnR5cGVzLCBmdW5jdGlvbiAoeCwgaSkgeyByZXR1cm4gaSB9KTsKICAgICAgICAgICAgdGhhdC5iYXNlVXJsICAgICAgID0gY29uZmlnLmJhc2VVcmw7CiAgICAgICAgICAgIHRoYXQuZGVmYXVsdFR5cGUgICA9IGNvbmZpZy5kZWZhdWx0VHlwZTsKICAgICAgICAgICAgdGhhdC5ldmFsdWF0b3JzICAgID0gY29uZmlnLmV2YWx1YXRvcnM7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVzICAgICA9IGRlZXBDb3B5KHt9LCB0ZW1wbGF0ZXMpOwogICAgICAgICAgICB0aGF0LmxvbmdOYW1lICAgICAgPSBtZW1vaXplKGdldExvbmdOYW1lLmJpbmQodGhhdCkpOwogICAgICAgICAgICB0aGF0LnNob3J0TmFtZSAgICAgPSBtZW1vaXplKGdldFNob3J0TmFtZS5iaW5kKHRoYXQpKTsKICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZUlkICAgID0gbWVtb2l6ZShnZXRUZW1wbGF0ZUlkLmJpbmQodGhhdCkpOwogICAgICAgICAgICB0aGF0LmVuZ2luZXMgICAgICAgPSB7fTsKICAgICAgICAgICAgdGhhdC5kYXRhICAgICAgICAgID0gZGF0YTsKCiAgICAgICAgICAgIHJlcXVpcmUoWyh0aGF0LnRlbXBsYXRlUGF0aHNbY29uZmlnLmRlZmF1bHRUeXBlXSB8fCAndGhydXN0L3RlbXBsYXRlLycgKyBjb25maWcuZGVmYXVsdFR5cGUpXSwgZnVuY3Rpb24gKGVuZ2luZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhhdC5lbmdpbmVzW2NvbmZpZy5kZWZhdWx0VHlwZV0gPSBlbmdpbmU7CgogICAgICAgICAgICAgICAgZG9tUmVhZHkoZnVuY3Rpb24gKCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBfKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKSkKICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbih4KSB7IHJldHVybiAhIXguZ2V0QXR0cmlidXRlKCdkYXRhLXRlbXBsYXRlJyk7IH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC5mb3JFYWNoKHRoYXQuY3JlYXRlRnJvbURvbU5vZGUuYmluZCh0aGF0KSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlID0gewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChuYW1lKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBudWxsLCB0aGF0ID0gdGhpcywgdGVtcGxhdGVzID0gdGhhdC50ZW1wbGF0ZXM7CiAgICAgICAgICAgICAgICBpZiAodGVtcGxhdGUgPSB0ZW1wbGF0ZXNbTE9OR11bdGhhdC5sb25nTmFtZShuYW1lKV0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICAgICAgZWxzZSBpZiAodGVtcGxhdGUgPSB0ZW1wbGF0ZXNbU0hPUlRdW3RoYXQuc2hvcnROYW1lKG5hbWUpXSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZW1wbGF0ZSA9IHRlbXBsYXRlc1tJRF1bdGhhdC50ZW1wbGF0ZUlkKG5hbWUpXSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKG5hbWUsIHR5cGUsIGNvbXBpbGVkVGVtcGxhdGUsIGh0bWwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBzaG9ydE5hbWUgPSB0aGF0LnNob3J0TmFtZShuYW1lKSwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZUlkID0gdGhhdC50ZW1wbGF0ZUlkKG5hbWUpLAogICAgICAgICAgICAgICAgICAgIGxvbmdOYW1lID0gdGhhdC5sb25nTmFtZShuYW1lLCB0eXBlKSwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZXMgPSB0aGF0LnRlbXBsYXRlczsKCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZXNbTE9OR11bbG9uZ05hbWVdID0gdGVtcGxhdGVzW1NIT1JUXVtzaG9ydE5hbWVdID0gdGVtcGxhdGVzW0lEXVt0ZW1wbGF0ZUlkXSA9IHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgIHNob3J0TmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICBpZDogdGVtcGxhdGVJZCwKICAgICAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgICAgIGh0bWw6IGh0bWwsCiAgICAgICAgICAgICAgICAgICAgY29tcGlsZWQ6IGNvbXBpbGVkVGVtcGxhdGUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhhczogZnVuY3Rpb24gKG5hbWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIHJldHVybiAhIXRoYXQuZ2V0KG5hbWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBhcHBlbmQ6IGZ1bmN0aW9uIChuYW1lLCB0eXBlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICAvLyBBcHBlbmQgdG8gZG9tPwogICAgICAgICAgICAgICAgLy8gSXMgdGhpcyByZWFsbHkgbmVlZGVkLi4uIGl0IGlzIG5lZWRlZCBmb3Iga25vY2tvdXQgdG8gZ3JhYiB0ZW1wbGF0ZXMgYnkgZGVmYXVsdCwKICAgICAgICAgICAgICAgIC8vICAgICAgYnV0IGtub2Nrb3V0IGNhbiBiZSBjaGFuZ2VkLCBpbiBob3cgaXQgZ2V0cyB0ZW1wbGF0ZXMuCiAgICAgICAgICAgICAgICAvLyAgICAgIEdyYW50ZWQga25vY2tvdXQgc3RpbGwgbmVlZHMgdGhlIGlkIHRvIGV4aXN0LCBtYXliZSB0aGUgYmVzdCB0aGluZyBpcyB0byBhZGQgdGhlIGVtcHR5IGRpdiwKICAgICAgICAgICAgICAgIC8vICAgICAgaWYgaXQgZG9lc24ndCBleGlzdCwgZm9yIGtub2Nrb3V0IHN1cHBvcnQuCiAgICAgICAgICAgICAgICBkb21SZWFkeShmdW5jdGlvbiAoKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhhdC50ZW1wbGF0ZUlkKG5hbWUpKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWVsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmlkID0gdGhhdC50ZW1wbGF0ZUlkKG5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnR5cGUgPSBmb3JtYXQoJ3RleHQveC17MH0tdGVtcGxhdGUnLCB0eXBlLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnZGF0YS10eXBlJywgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdkYXRhLXRlbXBsYXRlJywgdGhhdC5zaG9ydE5hbWUobmFtZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBwZXJoYXBzIGFkZCB0aGUgdGV4dCBub2RlIGNvbnRlbnQgZm9yIHRoZSB0ZW1wbGF0ZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGVsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG5ld1RlbXBsYXRlOiBmdW5jdGlvbiAobmFtZSwgdHlwZSwgaHRtbCwgZW5naW5lKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRlbXBsYXRlID0gdGhhdC5nZXQobmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoIXRlbXBsYXRlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09ICdwcmVjb21waWxlZCcpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnNldChuYW1lLCB0eXBlLCBodG1sLCBodG1sLnRvU3RyaW5nKCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgYXBwZW5kVGVtcGxhdGUodGhhdC5sb25nTmFtZShuYW1lKSwgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0aW5nTWV0aG9kOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBpbGVkVGVtcGxhdGUgPSB0aGlzLmNvbXBpbGUoaHRtbCwgZW5naW5lKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5zZXQobmFtZSwgdHlwZSwgY29tcGlsZWRUZW1wbGF0ZSwgaHRtbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuYXBwZW5kKHRoYXQubG9uZ05hbWUobmFtZSksIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy9pZiAoZGVmZXJyZWQpCiAgICAgICAgICAgICAgICAgICAgLy8gICAgZGVmZXJyZWQucmVzb2x2ZSh0ZW1wbGF0ZS5jb21waWxlZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5nZXQobmFtZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGh0bWwsIGVuZ2luZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgaWYgKCFlbmdpbmUpCiAgICAgICAgICAgICAgICAgICAgZW5naW5lID0gdGhhdC5lbmdpbmVzW3RoYXQuZGVmYXVsdFR5cGVdOwoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZW5naW5lID09PSAnZnVuY3Rpb24nKQogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRpbmdNZXRob2QgPSBlbmdpbmU7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgZW5naW5lLnRlbXBsYXRlID09PSAnZnVuY3Rpb24nKQogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRpbmdNZXRob2QgPSBlbmdpbmUudGVtcGxhdGU7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRpbmdNZXRob2QoaHRtbCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZldGNoOiBmdW5jdGlvbiAobmFtZSwgdHlwZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIHR5cGUgPSB0eXBlIHx8IHRoYXQuZGVmYXVsdFR5cGUsCiAgICAgICAgICAgICAgICAgICAgc2hvcnROYW1lID0gdGhhdC5zaG9ydE5hbWUobmFtZSksCiAgICAgICAgICAgICAgICAgICAgbG9uZ05hbWUgPSB0aGF0LmxvbmdOYW1lKG5hbWUsIHR5cGUpLAogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKCiAgICAgICAgICAgICAgICBpZiAodGVtcGxhdGUgPSB0aGF0LmdldChuYW1lKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGF0LmRhdGEuZ2V0KHRoYXQuYmFzZVVybCArIGxvbmdOYW1lLCB7IGNvbnRlbnRUeXBlOiAndGV4dC9wbGFpbicsIGRhdGFUeXBlOiAndGV4dCcgfSkudGhlbih3aGVuLmFwcGx5KGZ1bmN0aW9uIChkYXRhKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09ICdwcmVjb21waWxlZCcpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGF0Lm5ld1RlbXBsYXRlKG5hbWUsIHR5cGUsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQuZW5naW5lc1t0eXBlXSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhLCB0aGF0LmVuZ2luZXNbdHlwZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlKFsodGhhdC50ZW1wbGF0ZVBhdGhzW3R5cGVdIHx8ICd0aHJ1c3QvdGVtcGxhdGUvJyArIHR5cGUpXSwgZnVuY3Rpb24gKGVuZ2luZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmVuZ2luZXNbdHlwZV0gPSBlbmdpbmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhLCBlbmdpbmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KSwgZGVmZXIucmVqZWN0KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY3JlYXRlRnJvbURvbU5vZGU6ICBmdW5jdGlvbiAoZWxlbWVudCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgbG9nLmluZm8oZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGVtcGxhdGUnKSwKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10eXBlJyksCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KTsKCiAgICAgICAgICAgICAgICB0aGF0Lm5ld1RlbXBsYXRlKAogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXRlbXBsYXRlJyksCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdHlwZScpLAogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudGV4dAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBUZW1wbGF0ZUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZHVsZSwgcGFyZW50KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbW9kdWxlLm5hbWUgKyAnLXRlbXBsYXRlJzsKICAgICAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKCiAgICAgICAgICAgIHV0aWwuZXh0ZW5kKHRoaXMsIHsKICAgICAgICAgICAgICAgIGZldGNoOiBwYXJlbnQuZmV0Y2guYmluZChwYXJlbnQpLAogICAgICAgICAgICAgICAgZ2V0OiBwYXJlbnQuZ2V0LmJpbmQocGFyZW50KSwKICAgICAgICAgICAgICAgIGhhczogcGFyZW50Lmhhcy5iaW5kKHBhcmVudCkKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CgoKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gZnVuY3Rpb24gKHRocnVzdCwgbW9kdWxlLCBmYWNhZGVzKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlSW5zdGFuY2UgPSB0aHJ1c3QudGVtcGxhdGU7CgogICAgICAgICAgICBmYWNhZGVzLnRlbXBsYXRlID0gbmV3IFRlbXBsYXRlRmFjYWRlKG1vZHVsZSwgdGhpcyk7CiAgICAgICAgICAgIG1vZHVsZS50ZW1wbGF0ZXMgPSB7CiAgICAgICAgICAgICAgICBmZXRjaDogdGVtcGxhdGVJbnN0YW5jZS5mZXRjaC5iaW5kKHRlbXBsYXRlSW5zdGFuY2UpLAogICAgICAgICAgICAgICAgZ2V0OiB0ZW1wbGF0ZUluc3RhbmNlLmdldC5iaW5kKHRlbXBsYXRlSW5zdGFuY2UpLAogICAgICAgICAgICAgICAgaGFzOiB0ZW1wbGF0ZUluc3RhbmNlLmhhcy5iaW5kKHRlbXBsYXRlSW5zdGFuY2UpCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFRlbXBsYXRlOwogICAgfSk7CmRlZmluZSgndGhydXN0L3RlbXBsYXRlJywgWyd0aHJ1c3QvdGVtcGxhdGUvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL3RlbXBsYXRlJyxbJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sCmZ1bmN0aW9uIChDb252ZW50aW9uLCB1dGlsKQp7CiAgICB2YXIgVEVNUExBVEVTID0gJ3RlbXBsYXRlcycsCiAgICAgICAgd2hlbiA9IHV0aWwud2hlbiwKICAgICAgICBlYWNoID0gdXRpbC5lYWNoLAogICAgICAgIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgZmluZCA9IHV0aWwuZmluZDsKCiAgICByZXR1cm4gbmV3IENvbnZlbnRpb24oewogICAgICAgIHByb3BlcnRpZXM6IFtURU1QTEFURVNdLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uKGZhY2FkZSwgbW9kdWxlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGRlZmVyID0gd2hlbi5kZWZlcigpOwoKICAgICAgICAgICAgdmFyIHRlbXBsYXRlcyA9IG1vZHVsZS5jb252ZW50aW9uKFRFTVBMQVRFUyksCiAgICAgICAgICAgICAgICBpbnZlcnRlZFRlbXBsYXRlcyA9IHV0aWwuaW52ZXJ0KHRlbXBsYXRlcyksCiAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZSA9IG1vZHVsZS5pbnN0YW5jZTsKCiAgICAgICAgICAgIGlmICh0ZW1wbGF0ZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZhY2FkZS5kZWZlcnMgPSBbXTsKICAgICAgICAgICAgICAgIGVhY2godGVtcGxhdGVzLCBmdW5jdGlvbih0ZW1wbGF0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRlbXBsYXRlID09PSAnc3RyaW5nJykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZhY2FkZS5kZWZlcnMucHVzaChmYWNhZGUuZmV0Y2godGVtcGxhdGUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZhY2FkZS5kZWZlcnMgPSB3aGVuLmFsbChmYWNhZGUuZGVmZXJzKS50aGVuKGZ1bmN0aW9uIChsb2FkZWRUZW1wbGF0ZXMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBpbnZlcnRlZFRlbXBsYXRlcykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChpbnZlcnRlZFRlbXBsYXRlcywgaSkpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGZpbmQobG9hZGVkVGVtcGxhdGVzLCBmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5zaG9ydE5hbWUgPT09IGkgfHwgeC5uYW1lID09PSBpOyB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZUluc3RhbmNlLnRlbXBsYXRlc1tpXSA9IHRlbXBsYXRlLmNvbXBpbGVkOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAoZmFjYWRlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhY2FkZS5kZWZlcnMgfHwgdW5kZWZpbmVkOwogICAgICAgIH0KICAgIH0pOwp9KTsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi9rbm9ja291dC5lbmdpbmUnLFsndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAna25vY2tvdXQnXSwKZnVuY3Rpb24gKENvbnZlbnRpb24sIHV0aWwsIGtvKQp7CiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbiwKICAgICAgICBlYWNoID0gdXRpbC5lYWNoLAogICAgICAgIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgZmluZCA9IHV0aWwuZmluZCwKICAgICAgICBrbm9ja291dFRlbXBsYXRlcyA9IHt9OwoKICAgIHZhciBpbml0S25vY2tvdXRJbnRlZ3JhdGlvbiA9IGZ1bmN0aW9uICh0ZW1wbGF0ZU1hbmFnZXIpCiAgICB7CiAgICAgICAgdmFyIHRocnVzdFRlbXBsYXRlU291cmNlID0ga28udGVtcGxhdGVTb3VyY2VzLnRocnVzdFRlbXBsYXRlID0gZnVuY3Rpb24gKHRlbXBsYXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIH07CgogICAgICAgIHRocnVzdFRlbXBsYXRlU291cmNlLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgdGV4dDogZnVuY3Rpb24gKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZS5odG1sOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoYXQudGVtcGxhdGUuaHRtbCA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignVGhydXN0IFRlbXBsYXRlIGRvZXMgbm90IHN1cHBvcnQgcmV3cml0aW5nLi4uJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChrZXkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIGlmICghdGhhdC50ZW1wbGF0ZS5kYXRhKSB0aGF0LnRlbXBsYXRlLmRhdGEgPSB7fTsKICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQudGVtcGxhdGUuZGF0YVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoYXQudGVtcGxhdGUuZGF0YVtrZXldID0gYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gQmVnaW4gaW50ZWdyYXRpb24gb2YgdGVtcGxhdGUgcGx1Z2luLCB3aXRoIEtub2Nrb3V0LgogICAgICAgIHZhciBvbGRFbmdpbmUgPSBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZTsKCiAgICAgICAgdmFyIGNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZSA9IGtvLmNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICgpIHsgfQogICAgICAgIGNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGUgPSBrby51dGlscy5leHRlbmQobmV3IGtvLnRlbXBsYXRlRW5naW5lKCksCiAgICAgICAgewogICAgICAgICAgICByZW5kZXJUZW1wbGF0ZVNvdXJjZTogZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlU291cmNlLnRlbXBsYXRlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBldmFsdWF0b3JzID0gdGhpcy5ldmFsdWF0b3JzOwogICAgICAgICAgICAgICAgICAgIGlmICghZXZhbHVhdG9ycykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdG9ycyA9IGV2YWx1YXRvcnMgPSB0ZW1wbGF0ZU1hbmFnZXIuZXZhbHVhdG9yc1t0ZW1wbGF0ZU1hbmFnZXIuZGVmYXVsdFR5cGVdOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIHByZWNvbXBpbGVkID0gdGVtcGxhdGVTb3VyY2VbJ2RhdGEnXSgncHJlY29tcGlsZWQnKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXByZWNvbXBpbGVkKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZU1hbmFnZXIuY29tcGlsZSgne3sgd2l0aCgkZGF0YSkgeyB9fSAnICsgdGVtcGxhdGVTb3VyY2UudGV4dCgpICsgIiB7eyB9IH19Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlU291cmNlWydkYXRhJ10oJ3ByZWNvbXBpbGVkJywgcHJlY29tcGlsZWQpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gUnVuIHRoZSB0ZW1wbGF0ZSBhbmQgcGFyc2UgaXRzIG91dHB1dCBpbnRvIGFuIGFycmF5IG9mIERPTSBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZE1hcmt1cCA9IHRlbXBsYXRlU291cmNlLnRlbXBsYXRlLmNvbXBpbGVkKGJpbmRpbmdDb250ZXh0KS5yZXBsYWNlKC9ccysvZywgIiAiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQocmVuZGVyZWRNYXJrdXApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBvbGRFbmdpbmUucmVuZGVyVGVtcGxhdGVTb3VyY2UuYXBwbHkob2xkRW5naW5lLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2s6IGZ1bmN0aW9uIChzY3JpcHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5ldmFsdWF0b3JDYWNoZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdG9ycyA9IHRlbXBsYXRlTWFuYWdlci5ldmFsdWF0b3JzW3RlbXBsYXRlTWFuYWdlci5kZWZhdWx0VHlwZV07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmFsdWF0b3JDYWNoZSA9IGV2YWx1YXRvcnMubGVmdCArIHNjcmlwdCArIGV2YWx1YXRvcnMucmlnaHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ldmFsdWF0b3JDYWNoZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbWFrZVRlbXBsYXRlU291cmNlOiBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIE5hbWVkIHRlbXBsYXRlCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZpbml0aW9uID0gdGVtcGxhdGVNYW5hZ2VyLmdldCh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlZmluaXRpb24pCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgdGhydXN0VGVtcGxhdGVTb3VyY2UoZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIG9sZEVuZ2luZS5tYWtlVGVtcGxhdGVTb3VyY2UuYXBwbHkob2xkRW5naW5lLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGtvLnNldFRlbXBsYXRlRW5naW5lKG5ldyBrby5jb252ZW50aW9uVGVtcGxhdGVFbmdpbmUoKSk7CiAgICB9OwoKICAgIHJldHVybiBuZXcgQ29udmVudGlvbih7CiAgICAgICAgY291bnRkb3duOiBmdW5jdGlvbiAodGhydXN0KQogICAgICAgIHsKICAgICAgICAgICAgaW5pdEtub2Nrb3V0SW50ZWdyYXRpb24odGhydXN0LnRlbXBsYXRlKTsKICAgICAgICB9CiAgICB9KTsKfSk7Ci8qISBUaHJ1c3QgSlMgRnJhbWV3b3JrIC0gdjAuMS4wIC0gMjAxMi0wOC0yOQoqIHRocnVzdC1ob21lCiogQ29weXJpZ2h0IChjKSAyMDEyIERhdmlkIERyaXNjb2xsOyBMaWNlbnNlZCBNSVQgKi8KCgpkZWZpbmUoJ3RocnVzdC9zcGEvbWFpbicsWwogICAgJ3JlcXVpcmUnLAogICAgJ3RocnVzdCcsCiAgICAndGhydXN0L3V0aWwnLAogICAgJ3RocnVzdC9sb2cnLAogICAgJ2RhdmlzJywKICAgICdqcXVlcnknLAogICAgJ2RvbVJlYWR5JwpdLApmdW5jdGlvbiAocmVxdWlyZSwgVGhydXN0LCB1dGlsLCBsb2csIERhdmlzLCBqUXVlcnksIGRvbVJlYWR5KQp7CiAgICB2YXIgZWFjaCAgICAgICA9IHV0aWwuZWFjaCwKICAgICAgICBpc1N0cmluZyAgID0gdXRpbC5pc1N0cmluZywKICAgICAgICBpc0FycmF5ICAgID0gdXRpbC5pc0FycmF5LAogICAgICAgIGlzRnVuY3Rpb24gPSB1dGlsLmlzRnVuY3Rpb24sCiAgICAgICAgaXNPYmplY3QgICA9IHV0aWwuaXNPYmplY3QsCiAgICAgICAgZXh0ZW5kICAgICA9IHV0aWwuZXh0ZW5kLAogICAgICAgIG9uY2UgICAgICAgPSB1dGlsLm9uY2UsCiAgICAgICAgd2hlbiAgICAgICA9IHV0aWwud2hlbiwKICAgICAgICBiaW5kICAgICAgID0gdXRpbC5iaW5kLAogICAgICAgIGludm9rZSAgICAgPSB1dGlsLmludm9rZSwKICAgICAgICBwbHVjayAgICAgID0gdXRpbC5wbHVjaywKICAgICAgICBtYXAgICAgICAgID0gdXRpbC5tYXAsCiAgICAgICAgZGVmZXIgICAgICA9IHV0aWwuZGVmZXIsCiAgICAgICAgbWVtb2l6ZSAgICA9IHV0aWwubWVtb2l6ZSwKICAgICAgICB0b0FycmF5ICAgID0gdXRpbC50b0FycmF5LAogICAgICAgIFNUQVJUICAgICAgPSAnc3RhcnQnOwoKICAgIHZhciBTaW5nbGVQYWdlQXBwID0gZnVuY3Rpb24gKC8qICRyZWYgKi8gY29uZmlnLCAvKiAkcmVmIDogbmFtZSAqLyBpbnN0YW5jZU5hbWUsIC8qICRyZWYgKi8gbWVkaWF0b3IpCiAgICB7CiAgICAgICAgLy8gTmVlZCB0byBidWlsZCBhIHNoaW0gZm9yIHRoZSBqUXVlcnkgbWV0aG9kcyBEYXZpcyBuZWVkcy4KICAgICAgICBpZiAoIURhdmlzLiQpIERhdmlzLiQgPSBqUXVlcnk7CgogICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICB0aGF0LmJhc2VVcmwgPSBjb25maWcudXJsLnBhdGggKyAnLyc7CgogICAgICAgIGNvbmZpZyA9IGNvbmZpZy5zcGE7CgogICAgICAgIHRoYXQudGhydXN0SW5zdGFuY2VOYW1lID0gaW5zdGFuY2VOYW1lOwogICAgICAgIHRoYXQucm91dGVyID0gbmV3IERhdmlzLkFwcDsKICAgICAgICB0aGF0LnJvdXRlci5jb25maWd1cmUoZnVuY3Rpb24gKGNvbmZpZykKICAgICAgICB7CiAgICAgICAgICAgIGNvbmZpZy5nZW5lcmF0ZVJlcXVlc3RPblBhZ2VMb2FkID0gdHJ1ZTsKICAgICAgICB9KQoKICAgICAgICB0aGF0LmxvYWRSb3V0ZXMoY29uZmlnLnJvdXRlcyk7CiAgICAgICAgCiAgICAgICAgdmFyIGV2ZW50RmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKGV2ZW50KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1lZGlhdG9yLmZpcmUuYXN5bmMuYXBwbHkobWVkaWF0b3IsIFtldmVudF0uY29uY2F0KHRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICAgICAgICB9OwogICAgICAgIH0pOwoKICAgICAgICAvLyBGb3J3YXJkIGV2ZW50cwogICAgICAgIC8vIFRlY2huaWNhbGx5IHdlIHNob3VsZCB3cmFwIGNlcnRpYW4gcGFydHMgb2YgdGhlIGV2ZW50cywgdG8gb2ZmZXIgYSBjb21tb24gYXBpIHRoYXQgd29uJ3Qgc2hpZnQuCiAgICAgICAgdGhhdC5yb3V0ZXIuYmluZCgnc3RhcnQnLCBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvc3RhcnQnKSk7CiAgICAgICAgdGhhdC5yb3V0ZXIuYmluZCgnbG9va3VwUm91dGUnLCBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvbG9va3VwJykpOwogICAgICAgIHRoYXQucm91dGVyLmJpbmQoJ3J1blJvdXRlJywgZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL3J1bicpKTsKICAgICAgICB0aGF0LnJvdXRlci5iaW5kKCdyb3V0ZU5vdEZvdW5kJywgZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL25vdGZvdW5kJykpOwogICAgICAgIHRoYXQucm91dGVyLmJpbmQoJ3JlcXVlc3RIYWx0ZWQnLCBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcmVxdWVzdC9oYWx0JykpOwogICAgICAgIHRoYXQucm91dGVyLmJpbmQoJ3Vuc3VwcG9ydGVkJywgZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3Vuc3VwcG9ydGVkJykpOwogICAgfTsKCiAgICBTaW5nbGVQYWdlQXBwLnByb3RvdHlwZSA9IHsKICAgICAgICBzdGFydDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhhdC5yb3V0ZXIuc3RhcnQoKTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgIExvYWRzIHJvdXRlcyBpbnRvIHRoZSBzcGEgaW5zdGFuY2UKCiAgICAgICAgUm91dGVzIGNhbiBiZSBpbiAzIGZvcm1zCgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAnL3BhdGgvdG8vOmZvbyc6ICdwYXRoL3RvL21vZHVsZScsCiAgICAgICAgICAgICAgICAnL3BhdGgvdG8vOmJhcic6IFsncGF0aC90by9tb2R1bGUxJywgJ3BhdGgvdG8vbW9kdWxlMiddLAogICAgICAgICAgICAgICAgJy9wYXRoL3RvLzpmYic6IHsgcGF0aDogJ3BhdGgvdG8vbW9kdWxlJywgYXJnczogWydhcmdzJywgJ3RvJywgJ2hhbmQgb2ZmIHRvIHN0YXJ0J10gfQogICAgICAgICAgICAgICAgJy9wYXRoL3RvLzpmb28vOmJhcic6IGZ1bmN0aW9uKCl7ICBjdXN0b20gaGFuZGxlciB9CiAgICAgICAgICAgIH0KCiAgICAgICAgQG1ldGhvZCBsb2FkUm91dGVzCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHJvdXRlcyBPYmplY3Qgb2Ygcm91dGVzLgogICAgICAgICoqLwogICAgICAgIGxvYWRSb3V0ZXM6IGZ1bmN0aW9uIChyb3V0ZXMpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGVhY2gocm91dGVzLCBmdW5jdGlvbiAodmFsdWUsIHJvdXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcmVhbFJvdXRlID0gdXRpbC5maXh1cFVybCh0aGF0LmJhc2VVcmwgKyByb3V0ZSk7CiAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5yb3V0ZXIuZ2V0KHJlYWxSb3V0ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIC8vIFJ1biBjdXN0b20gZnVuY3Rpb24gaW4gZGF2aXMuCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvKmVsc2UgaWYgKGlzQXJyYXkodmFsdWUpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciByb3V0ZVJlc3VsdCA9IG1hcCh2YWx1ZSwgdGhhdC5fX3Byb2Nlc3NSb3V0ZSk7CgogICAgICAgICAgICAgICAgICAgIHRoYXQucm91dGVyLmdldChyZWFsUm91dGUsIGZ1bmN0aW9uIChyZXEpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpbnZva2Uocm91dGVSZXN1bHQsICdjYicsIHJlcSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHdoZW4uYWxsKHBsdWNrKHJvdXRlUmVzdWx0LCAncHJvbWlzZScpKQogICAgICAgICAgICAgICAgICAgICAgICAudGhlbihiaW5kKHRoYXQuc3RhcnRNb2R1bGVzLCB0aGF0LCBtYXAodmFsdWUsIGZ1bmN0aW9uKHgpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc09iamVjdCh4KSAmJiB4LmFyZ3MgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0pKSk7CiAgICAgICAgICAgICAgICB9Ki8KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcm91dGVSZXN1bHQgPSB0aGF0Ll9fcHJvY2Vzc1JvdXRlKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgdGhhdC5yb3V0ZXIuZ2V0KHJlYWxSb3V0ZSwgcm91dGVSZXN1bHQpOwogICAgICAgICAgICAgICAgICAgIC8vcm91dGVSZXN1bHQucHJvbWlzZS50aGVuKGJpbmQodGhhdC5zdGFydE1vZHVsZXMsIHRoYXQsIHZhbHVlLmFyZ3MgfHwgW10pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBQcm9jZXNzIGVhY2ggcm91dGUgbm9kZSBkZXBlbmRpbmcgaWYgaXQgaXMgYW4gb2JqZWN0IG9yIHN0cmluZy4KCiAgICAgICAgQG1ldGhvZCBfX3Byb2Nlc3NSb3V0ZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmFsdWUgVGhlIG1vZHVsZSBvciBtb2R1bGUgKyBhcmdzIHRvIHByb2Nlc3MuCiAgICAgICAgKiovCiAgICAgICAgX19wcm9jZXNzUm91dGU6IGZ1bmN0aW9uKHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLAogICAgICAgICAgICAgICAgYXJncyA9IHZhbHVlLmFyZ3MgfHwgW107CgogICAgICAgICAgICBpZiAoaXNPYmplY3QodmFsdWUpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5yb3V0ZUdldE1vZHVsZUZhY3RvcnkodmFsdWUucGF0aCwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaXNTdHJpbmcodmFsdWUpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5yb3V0ZUdldE1vZHVsZUZhY3RvcnkodmFsdWUsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBDcmVhdGVzIGEgbWV0aG9kIHRoYXQgaXMgaGFuZGVkIG9mZiB0byB0aGUgcm91dGVyCiAgICAgICAgV2hlbiB0aGUgcm91dGUgaW52b2tlcyB0aGF0IG1vZHVsZSwgaXQgd2lsbCBhc3luY3Jvbm91c2x5IGxvYWQgdGhlIGdpdmVuIG1vZHVsZSwgYW5kIHJldHVybiBhIHByb21pc2UgZm9yIHRoZSByZXN1bHQuCgogICAgICAgIEBtZXRob2Qgcm91dGVHZXRNb2R1bGVGYWN0b3J5CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZHVsZVBhdGggVGhlIHBhdGggdG8gdGhlIG1vZHVsZQogICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IHRoZW1NZXRob2QgVGhlIG1ldGhvZCB0aGF0IGlzIGNhbGxlZCwgYWZ0ZXIgdGhlIGZ1bmN0aW9uIGlzIHJlc29sdmVkLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBmb3Igd2hlbiB0aGUgbW9kdWxlIGdldHMgbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIHJvdXRlR2V0TW9kdWxlRmFjdG9yeTogZnVuY3Rpb24gKG1vZHVsZVBhdGgsIGFyZ3MpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHJlcSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG1wOwogICAgICAgICAgICAgICAgaWYgKG1vZHVsZVBhdGguaW5kZXhPZignOicpID4gLTEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbXAgPSB1dGlsLnJlZHVjZShyZXEucGFyYW1zLCBmdW5jdGlvbiAobWVtbywgcGFyYW0sIGkpIHsgcmV0dXJuIG1lbW8ucmVwbGFjZSgnOicgKyBpLCBwYXJhbS50b0xvd2VyQ2FzZSgpKTsgfSwgbW9kdWxlUGF0aCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1wLmxhc3RJbmRleE9mKCcuJykgPiAtMSkKICAgICAgICAgICAgICAgICAgICAgICAgbXAgPSBtcC5zdWJzdHJpbmcoMCwgbXAubGFzdEluZGV4T2YoJy4nKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0TW9kdWxlcyhhcmdzLCBtcCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICBTdGFydHMgdGhlIGdpdmVuIG1vZHVsZXMsIGlmIG9ubHkgb25lIG1vZHVsZSBpcyBwYXNzZWQgaW4sIGl0IHdpbGwgc3RhcnQgdGhhdCBpbmRpdmlkdWFsbHkuCgogICAgICAgIEBtZXRob2Qgc3RhcnRNb2R1bGVzCiAgICAgICAgQHBhcmFtIHtBcnJheSBvZiBPYmplY3R9IGFyZ3MgdG8gcGFzcyBvbnRvIHRocnVzdCdzIHN0YXJ0IG1ldGhvZC4KICAgICAgICBAcGFyYW0ge0FycmF5IG9mIE1vZHVsZXxNb2R1bGV9IG1vZHVsZXMgVGhlIG1vZHVsZXMgdG8gc3RhcnQKICAgICAgICAqKi8KICAgICAgICBzdGFydE1vZHVsZXM6IGZ1bmN0aW9uIChhcmdzLCBtb2R1bGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CgogICAgICAgICAgICBpZiAoIXRoYXQudGhydXN0KQogICAgICAgICAgICAgICAgdGhhdC50aHJ1c3QgPSBUaHJ1c3QuZ2V0SW5zdGFuY2UodGhhdC50aHJ1c3RJbnN0YW5jZU5hbWUpOwoKICAgICAgICAgICAgaWYgKGlzQXJyYXkobW9kdWxlKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZWFjaChtb2R1bGUsIGZ1bmN0aW9uICh4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRlZmVyKGZ1bmN0aW9uICgpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHRoYXQudGhydXN0LnN0YXJ0LmFwcGx5KHRoYXQudGhydXN0LCBbeF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGF0LnRocnVzdC5zdGFydGVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50aHJ1c3QucmVhZHkoeCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGF0LnRocnVzdC5zdGFydC5hcHBseSh0aGF0LnRocnVzdCwgW21vZHVsZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgIGlmICghdGhhdC50aHJ1c3Quc3RhcnRlZCkKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudGhydXN0LnJlYWR5KG1vZHVsZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgdGhhdC5zdGFydGluZ01vZHVsZVByb21pc2UgPSBbcHJvbWlzZV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIHJldHVybiBTaW5nbGVQYWdlQXBwOwp9KTsKZGVmaW5lKCd0aHJ1c3Qvc3BhJywgWyd0aHJ1c3Qvc3BhL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3RhcnQnLFsndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwKZnVuY3Rpb24gKENvbnZlbnRpb24sIHV0aWwpCnsKICAgIHJldHVybiBuZXcgQ29udmVudGlvbih7CiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcm91dGVyID0gdGhydXN0LnNwYTsKICAgICAgICAgICAgcm91dGVyLnN0YXJ0KCk7CgogICAgICAgICAgICByZXR1cm4gdGhydXN0LnNwYS5zdGFydGluZ01vZHVsZVByb21pc2UgfHwgdW5kZWZpbmVkOwogICAgICAgIH0KICAgIH0pOwp9KTsKZGVmaW5lKCdrb2ItbW9kZWwvdXRpbCcsWydsb2Rhc2gnLCAna25vY2tvdXQnLCAnZXhwb3J0cyddLCBmdW5jdGlvbiAoXywga28sIGV4cG9ydHMpCnsKICAgIHZhciBpc09iamVjdCA9IF8uaXNPYmplY3QsCiAgICAgICAgaXNBcnJheSA9IF8uaXNBcnJheSwKICAgICAgICBpc0ZvcmNlZE9iamVjdCA9IF8ubWVtb2l6ZShmdW5jdGlvbiAoa2V5KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGtleS5pbmRleE9mKCdfJykgPT09IDAgJiYga2V5Lmxhc3RJbmRleE9mKCdfJykgPT09IChrZXkubGVuZ3RoIC0gMSk7CiAgICAgICAgfSksCiAgICAgICAgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKICAgICAgICB1bndyYXBPYnNlcnZhYmxlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZTsKICAgIC8vIE5vdCBleGFjdGx5IGEgZ3JlYXQgYXNzdW1wdGlvbiwgYnV0IGZvciBsYXJnZSBsaXN0cywgd2UgbmVlZCBhIHF1aWNrIHdheSB0byBpZGVudGlmeSBpZiB0aGV5IGFyZSBmb3JjZWQuCgogICAgZXhwb3J0cy5pc0ZvcmNlZE9iamVjdCA9IGlzRm9yY2VkT2JqZWN0OwoKICAgIGV4cG9ydHMuaXNGb3JjZWRPYmplY3RIYXNoID0gZnVuY3Rpb24gKHZhbHVlKQogICAgewogICAgICAgIGlmICghaXNBcnJheSh2YWx1ZSkgJiYgaXNPYmplY3QodmFsdWUpKQogICAgICAgICAgICBmb3IgKHZhciB4IGluIHZhbHVlKQogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiB4ID09PSAnc3RyaW5nJyAmJiBpc0ZvcmNlZE9iamVjdCh4KTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIGV4cG9ydHMuaXNPYmplY3RPck9iamVjdE9ic2VydmFibGUgPSBmdW5jdGlvbiAocHJvcCkKICAgIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5pc0ZvcmNlZE9iamVjdEhhc2godW53cmFwT2JzZXJ2YWJsZShwcm9wKSk7CiAgICB9OwoKICAgIGV4cG9ydHMuaXNBcnJheU9yQXJyYXlPYnNlcnZhYmxlID0gZnVuY3Rpb24gKHByb3ApCiAgICB7CiAgICAgICAgcmV0dXJuIGlzQXJyYXkodW53cmFwT2JzZXJ2YWJsZShwcm9wKSk7CiAgICB9OwoKICAgIHZhciBfX2tvUGF0aE1hcCA9IHt9LAogICAgICAgIF9fcHJvcFBhdGhNYXAgPSB7fSwKICAgICAgICBfX2NsYXNzUGF0aE1hcCA9IHt9LAogICAgICAgIGtvUmVnZXggPSAvW1wufFxbXS9nLAogICAgICAgIHJpZ2h0QnJhY2tldFJlZ2V4ID0gL1xdL2c7CgogICAgZXhwb3J0cy5rbm9ja291dFBhdGggPSBmdW5jdGlvbiAoa2V5KQogICAgewogICAgICAgIGlmIChfX3Byb3BQYXRoTWFwW2tleV0pIHJldHVybiBfX3Byb3BQYXRoTWFwW2tleV07CgogICAgICAgIHZhciBrb1BhdGggPSBrZXkucmVwbGFjZShrb1JlZ2V4LCAnXycpLnJlcGxhY2UocmlnaHRCcmFja2V0UmVnZXgsICcnKTsKICAgICAgICBpZiAoIV9fa29QYXRoTWFwW2tvUGF0aF0pCiAgICAgICAgewogICAgICAgICAgICBfX2tvUGF0aE1hcFtrb1BhdGhdID0ga2V5OwogICAgICAgICAgICByZXR1cm4gKF9fcHJvcFBhdGhNYXBba2V5XSA9IGtvUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBrb1BhdGg7CiAgICB9OwoKICAgIGV4cG9ydHMucHJvcGVydHlQYXRoID0gZnVuY3Rpb24gKGtvUGF0aCkKICAgIHsKICAgICAgICByZXR1cm4gX19rb1BhdGhNYXBba29QYXRoXTsKICAgIH07CgogICAgZXhwb3J0cy5jbGFzc1BhdGggPSBfLm1lbW9pemUoZnVuY3Rpb24gKHBhdGgpCiAgICB7CiAgICAgICAgcmV0dXJuICcuJyArIHBhdGgucmVwbGFjZShrb1JlZ2V4LCAnLScpLnJlcGxhY2UocmlnaHRCcmFja2V0UmVnZXgsICcnKS50b0xvd2VyQ2FzZSgpOwogICAgfSk7CgogICAgZXhwb3J0cy5maW5kQWxsQ2hhbmdlZFByb3BlcnRpZXMgPSBmdW5jdGlvbiAoY3VycmVudCwgb2xkKQogICAgewogICAgICAgIHZhciBwcm9wZXJ0aWVzID0ge30sIGk7CiAgICAgICAgZm9yIChpIGluIGN1cnJlbnQpCiAgICAgICAgICAgIGlmICghcHJvcGVydGllc1tpXSAmJiBoYXNPd24uY2FsbChjdXJyZW50LCBpKSkKICAgICAgICAgICAgICAgIHByb3BlcnRpZXNbaV0gPSB0cnVlOwoKICAgICAgICBmb3IgKGkgaW4gb2xkKQogICAgICAgICAgICBpZiAoIXByb3BlcnRpZXNbaV0gJiYgaGFzT3duLmNhbGwob2xkLCBpKSkKICAgICAgICAgICAgICAgIHByb3BlcnRpZXNbaV0gPSB0cnVlOwoKICAgICAgICB2YXIgdmFsdWVzID0ge307CiAgICAgICAgZm9yIChpIGluIHByb3BlcnRpZXMpCiAgICAgICAgewogICAgICAgICAgICB2YXIgY1ZhbCA9IHVud3JhcE9ic2VydmFibGUoY3VycmVudFtpXSksCiAgICAgICAgICAgICAgICBvVmFsID0gdW53cmFwT2JzZXJ2YWJsZShvbGRbaV0pLAogICAgICAgICAgICAgICAgY1RvID0gaXNPYmplY3QoY1ZhbCksCiAgICAgICAgICAgICAgICBjVGEgPSBpc0FycmF5KGNWYWwpLAogICAgICAgICAgICAgICAgb1RvID0gaXNPYmplY3Qob1ZhbCksCiAgICAgICAgICAgICAgICBvVGEgPSBpc0FycmF5KG9WYWwpOwoKICAgICAgICAgICAgaWYgKGNUbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG9UbykKICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbaV0gPSBleHBvcnRzLmZpbmRBbGxDaGFuZ2VkUHJvcGVydGllcyhjVmFsLCBvVmFsKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbaV0gPSBjVmFsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGNUYSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG9UYSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwoY1ZhbCwgaSkpCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc1tpXSA9IGV4cG9ydHMuZmluZEFsbENoYW5nZWRQcm9wZXJ0aWVzKGNWYWwsIG9WYWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHZhbHVlc1tpXSA9IGNWYWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoY1ZhbCAhPT0gb1ZhbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsdWVzW2ldID0gY1ZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgfTsKCiAgICBleHBvcnRzLmRlZXBDbG9uZSA9IGZ1bmN0aW9uIChvYmopCiAgICB7CiAgICAgICAgaWYgKCFfLmlzT2JqZWN0KG9iaikgfHwgXy5pc0Z1bmN0aW9uKG9iaikpIHJldHVybiBvYmo7CiAgICAgICAgaWYgKF8uaXNEYXRlKG9iaikpIHJldHVybiBuZXcgRGF0ZShvYmouZ2V0VGltZSgpKTsKICAgICAgICBpZiAoXy5pc1JlZ0V4cChvYmopKSByZXR1cm4gbmV3IFJlZ0V4cChvYmouc291cmNlLCBvYmoudG9TdHJpbmcoKS5yZXBsYWNlKC8uKlwvLywgIiIpKTsKICAgICAgICB2YXIgaXNBcnIgPSAoXy5pc0FycmF5KG9iaikgfHwgXy5pc0FyZ3VtZW50cyhvYmopKTsKICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChtZW1vLCB2YWx1ZSwga2V5KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQXJyKQogICAgICAgICAgICAgICAgbWVtby5wdXNoKF8uY2xvbmUodmFsdWUsIHRydWUpKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgbWVtb1trZXldID0gXy5jbG9uZSh2YWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybiBtZW1vOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIF8ucmVkdWNlKG9iaiwgZnVuYywgaXNBcnIgPyBbXSA6IHt9KTsKICAgIH07Cn0pOwpkZWZpbmUoJ2tvYi1tb2RlbC9tb2RlbC5iYXNlJyxbCiAgICAnYmFja2JvbmUnLAogICAgJ2tub2Nrb3V0JywKICAgICdsb2Rhc2gnLAogICAgJy4vdXRpbCcsCl0sCmZ1bmN0aW9uIChCYWNrYm9uZSwga28sIF8sIHV0aWwpCnsKICAgIAogICAgdmFyIGV4dGVuZCA9IF8uZXh0ZW5kLAogICAgICAgIF9fbW9kZWxzID0ge30sCiAgICAgICAgX192aWV3TW9kZWxzID0ge30sCiAgICAgICAgX19vcmlnaW5hbFN0YXRlID0ge30sCiAgICAgICAgaXNPYmplY3QgPSBfLmlzT2JqZWN0LAogICAgICAgIGlzQXJyYXkgPSBfLmlzQXJyYXksCiAgICAgICAgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKICAgICAgICB1bndyYXBPYnNlcnZhYmxlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSwKICAgICAgICAvLyBOb3QgZXhhY3RseSBhIGdyZWF0IGFzc3VtcHRpb24sIGJ1dCBmb3IgbGFyZ2UgbGlzdHMsIHdlIG5lZWQgYSBxdWljayB3YXkgdG8gaWRlbnRpZnkgaWYgdGhleSBhcmUgZm9yY2VkLgogICAgICAgIGlzT2JqZWN0T3JPYmplY3RPYnNlcnZhYmxlID0gdXRpbC5pc09iamVjdE9yT2JqZWN0T2JzZXJ2YWJsZSwKICAgICAgICBpc0FycmF5T3JBcnJheU9ic2VydmFibGUgPSB1dGlsLmlzQXJyYXlPckFycmF5T2JzZXJ2YWJsZTsKCiAgICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGEgdmFsdWUgZnJvbSBhIEJhY2tib25lIG9iamVjdCBhcyBhIHRoaXMuX19wcm9wZXJ0eQogICAgLy8gb3IgYXMgYSBmdW5jdGlvbi4KICAgIHZhciBnZXRWYWx1ZSA9IGZ1bmN0aW9uIChvYmplY3QsIHByb3ApCiAgICB7CiAgICAgICAgaWYgKCEob2JqZWN0ICYmIG9iamVjdFtwcm9wXSkpIHJldHVybiBudWxsOwogICAgICAgIHJldHVybiBfLmlzRnVuY3Rpb24ob2JqZWN0W3Byb3BdKSA/IG9iamVjdFtwcm9wXSgpIDogb2JqZWN0W3Byb3BdOwogICAgfTsKCiAgICB2YXIgX25ld1ZhbHVlR2VuZXJhdG9yU3Vic2NyaXB0aW9uID0gZnVuY3Rpb24gKHBhdGgsIG5ld1ZhbCwgcGFyZW50KQogICAgewogICAgICAgIHJldHVybiAoZnVuY3Rpb24gKHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSB2YWx1ZS5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghKHZhbHVlW2ldIGluc3RhbmNlb2YgdGhpcy5jb25zdHJ1Y3RvcikpCiAgICAgICAgICAgICAgICAgICAgdmFsdWVbaV0gPSBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih2YWx1ZVtpXSwgdW5kZWZpbmVkLCBwYXJlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBwYXRoLCB0aGlzLCBuZXdWYWwoKSk7CiAgICAgICAgfSkuYmluZCh0aGlzKTsKICAgIH07CgogICAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuCiAgICB2YXIgS25vY2tvdXRNb2RlbEJhc2UgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewogICAgICAgIF9fZGVlcENsb25lOiBmdW5jdGlvbihvYmopCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05ZSScpOwogICAgICAgIH0sCiAgICAgICAgX19wcm9wZXJ0eToKICAgICAgICB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKG9iaiwgcGF0aCkgeyB0aHJvdyBuZXcgRXJyb3IoJ05ZSScpOyB9LAogICAgICAgICAgICBoYXM6IGZ1bmN0aW9uIChvYmosIHBhdGgpIHsgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsgfSwKICAgICAgICAgICAgZ2V0UGFyZW50OiBmdW5jdGlvbiAob2JqLCBwYXRoKSB7IHRocm93IG5ldyBFcnJvcignTllJJyk7IH0sCiAgICAgICAgICAgIGxhc3Q6IGZ1bmN0aW9uIChvYmosIHBhdGgpIHsgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAob2JqLCBwYXRoLCB2YWx1ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ05ZSScpOyB9LAogICAgICAgICAgICBkZWw6IGZ1bmN0aW9uIChvYmosIHBhdGgpIHsgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsgfSwKICAgICAgICAgICAgYnVpbGQ6IGZ1bmN0aW9uIChvYmosIHBhdGgpIHsgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsgfSwKICAgICAgICAgICAgZ2V0UHJvcGVydGllczogZnVuY3Rpb24gKG9iaiwgbGVhZnMsIHByZWZpeCkgeyB0aHJvdyBuZXcgRXJyb3IoJ05ZSScpOyB9LAogICAgICAgICAgICBmaW5kQWxsQ2hhbmdlZFByb3BlcnRpZXM6IGZ1bmN0aW9uIChjdXJyZW50LCBvbGQpIHsgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsgfQogICAgICAgIH0sCiAgICAgICAgX19idWlsZEVycm9yTWVzc2FnZXM6IGZ1bmN0aW9uKHBhcmVudCkKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTllJJyk7CiAgICAgICAgfSwKICAgICAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgICAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoYXR0cmlidXRlcywgb3B0aW9ucywgcGFyZW50KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lcnJvck1lc3NhZ2VzKSB0aGlzLmVycm9yTWVzc2FnZXMgPSB0aGlzLl9fYnVpbGRFcnJvck1lc3NhZ2VzKHBhcmVudCk7CiAgICAgICAgICAgIHRoaXMuX3BhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gdGhpcy5fX2RlZXBDbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwoKICAgICAgICAgICAgdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKICAgICAgICBpbml0OiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgIH0sCiAgICAgICAgdG9KU09OOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9Kc29uKCk7CiAgICAgICAgfSwKICAgICAgICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBtb2RlbCdzIGBhdHRyaWJ1dGVzYCBvYmplY3QuCiAgICAgICAgdG9Kc29uOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHByb3BzID0gdGhpcy5fX3Byb3BlcnR5LmdldFByb3BlcnRpZXModGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgICAgICAgdmFyIGpzb24gPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBwcm9wcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHByb3AgPSB1bndyYXBPYnNlcnZhYmxlKHByb3BzW3BhdGhdKSwgdmFsdWUgPSBwcm9wOwoKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdE9yT2JqZWN0T2JzZXJ2YWJsZShwcm9wKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHt9OwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gcHJvcCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHByb3AsIGkpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVbaV0gPSBwcm9wW2ldLnRvSnNvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNBcnJheU9yQXJyYXlPYnNlcnZhYmxlKHByb3ApKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBwcm9wLmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUucHVzaChwcm9wW2ldLnRvSnNvbigpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl9fcHJvcGVydHkuc2V0KGpzb24sIHBhdGgsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ganNvbjsKICAgICAgICB9LAogICAgICAgIHBhcmVudDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJlbnQ7CiAgICAgICAgfSwKICAgICAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgICAgICBnZXQ6IGZ1bmN0aW9uIChwYXRoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5fX3Byb3BlcnR5LmdldCh0aGlzLmF0dHJpYnV0ZXMsIHBhdGggfHwgJycpOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfSwKICAgICAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICAgICAgZXNjYXBlOiBmdW5jdGlvbiAocGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBodG1sOwogICAgICAgICAgICBpZiAoaHRtbCA9IHRoaXMuX19wcm9wZXJ0eS5nZXQodGhpcy5fZXNjYXBlZEF0dHJpYnV0ZXMsIHBhdGgpKSByZXR1cm4gaHRtbDsKICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuZ2V0KHBhdGgpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gXy5lc2NhcGUodmFsID09IG51bGwgPyAnJyA6ICcnICsgdmFsKTsKICAgICAgICAgICAgdGhpcy5fX3Byb3BlcnR5LnNldCh0aGlzLl9lc2NhcGVkQXR0cmlidXRlcywgcGF0aCwgcmVzdWx0KTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAogICAgICAgIC8vIFJldHVybnMgYHRydWVgIGlmIHRoZSBhdHRyaWJ1dGUgY29udGFpbnMgYSB2YWx1ZSB0aGF0IGlzIG5vdCBudWxsCiAgICAgICAgLy8gb3IgdW5kZWZpbmVkLgogICAgICAgIGhhczogZnVuY3Rpb24gKHBhdGgpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fX3Byb3BlcnR5Lmhhcyh0aGlzLmF0dHJpYnV0ZXMsIHBhdGggfHwgJycpOwogICAgICAgIH0sCiAgICAgICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgIHVubGVzcwogICAgICAgIC8vIHlvdSBjaG9vc2UgdG8gc2lsZW5jZSBpdC4KICAgICAgICBzZXQ6IGZ1bmN0aW9uIChrZXksIHZhbHVlLCBvcHRpb25zKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGF0dHJzLCBhdHRyLCB2YWw7CiAgICAgICAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICAgICAgICBpZiAoXy5pc09iamVjdChrZXkpIHx8IGtleSA9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGF0dHJzID0ge307CiAgICAgICAgICAgICAgICB0aGlzLl9fcHJvcGVydHkuYnVpbGQoYXR0cnMsIGtleSlbdGhpcy5fX3Byb3BlcnR5Lmxhc3QoYXR0cnMsIGtleSldID0gdmFsdWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgICAgICAgaWYgKCFhdHRycykgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIHRoaXMuY29uc3RydWN0b3IpIGF0dHJzID0gYXR0cnMuYXR0cmlidXRlczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMudW5zZXQpIGZvciAoYXR0ciBpbiBhdHRycykgYXR0cnNbYXR0cl0gPSB2b2lkIDA7CgogICAgICAgICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgICAgICAgIGlmICh0aGlzLl9fcHJvcGVydHkuaGFzKGF0dHJzLCB0aGlzLmlkQXR0cmlidXRlKSkgdGhpcy5pZCA9IHRoaXMuX19wcm9wZXJ0eS5nZXQoYXR0cnMsIHRoaXMuaWRBdHRyaWJ1dGUpOwoKICAgICAgICAgICAgdmFyIGNoYW5nZXMgPSBvcHRpb25zLmNoYW5nZXMgPSB7fSwKICAgICAgICAgICAgICAgIG5vdyA9IHRoaXMuYXR0cmlidXRlcywKICAgICAgICAgICAgICAgIGVzY2FwZWQgPSB0aGlzLl9lc2NhcGVkQXR0cmlidXRlcywKICAgICAgICAgICAgICAgIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgfHwge307CgogICAgICAgICAgICB2YXIgcGF0aHMgPSB0aGlzLl9fcHJvcGVydHkuZ2V0UHJvcGVydGllcyhhdHRycyk7CgogICAgICAgICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUuLi4KICAgICAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBwYXRocykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHByb3AgPSBwYXRoc1twYXRoXSwKICAgICAgICAgICAgICAgICAgICBwTm93ID0gdGhpcy5fX3Byb3BlcnR5LmJ1aWxkKG5vdywgcGF0aCksCiAgICAgICAgICAgICAgICAgICAgcFByZXYgPSB0aGlzLl9fcHJvcGVydHkuZ2V0UGFyZW50KHByZXYsIHBhdGgpLAogICAgICAgICAgICAgICAgICAgIHBDaGFuZ2VzID0gdGhpcy5fX3Byb3BlcnR5LmJ1aWxkKGNoYW5nZXMsIHBhdGgpLAogICAgICAgICAgICAgICAgICAgIHBFc2NhcGVkID0gdGhpcy5fX3Byb3BlcnR5LmJ1aWxkKGVzY2FwZWQsIHBhdGgpLAogICAgICAgICAgICAgICAgICAgIGF0dHIgPSB0aGlzLl9fcHJvcGVydHkubGFzdChhdHRycywgcGF0aCksCiAgICAgICAgICAgICAgICAgICAgdmFsID0gdGhpcy5fX3Byb3BlcnR5LmdldChhdHRycywgcGF0aCk7CgogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0T3JPYmplY3RPYnNlcnZhYmxlKHByb3ApKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy51bnNldCA/IGRlbGV0ZSBwTm93W2F0dHJdIDogcE5vd1thdHRyXSA9IChwTm93W2F0dHJdIHx8IGtvLm9ic2VydmFibGUoe30pKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1ZhbCA9IHBOb3dbYXR0cl07CiAgICAgICAgICAgICAgICAgICAgdmFyIHVuZGVybHlpbmdOZXdWYWwgPSBuZXdWYWwoKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHZhbCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbCh2YWwsIGkpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXYgPSB1bmRlcmx5aW5nTmV3VmFsW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHV2ICYmIHV2IGluc3RhbmNlb2YgdGhpcy5jb25zdHJ1Y3RvcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1di5zZXQodmFsW2ldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdiA9IHZhbFtpXSBpbnN0YW5jZW9mIHRoaXMuY29uc3RydWN0b3IgPyB2YWxbaV0gOiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih2YWxbaV0sIHVuZGVmaW5lZCwgcGFyZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmRlcmx5aW5nTmV3VmFsW2ldID0gdjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFsID0gbmV3VmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNBcnJheU9yQXJyYXlPYnNlcnZhYmxlKHByb3ApKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy51bnNldCA/IGRlbGV0ZSBwTm93W2F0dHJdIDogcE5vd1thdHRyXSA9IChwTm93W2F0dHJdIHx8IGtvLm9ic2VydmFibGVBcnJheShbXSkpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VmFsID0gcE5vd1thdHRyXTsKICAgICAgICAgICAgICAgICAgICB2YXIgdW5kZXJseWluZ05ld1ZhbCA9IG5ld1ZhbCgpOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gdmFsLmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1diA9IHVuZGVybHlpbmdOZXdWYWxbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1diAmJiB1diBpbnN0YW5jZW9mIHRoaXMuY29uc3RydWN0b3IpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHV2LnNldCh2YWxbaV0sIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHYgPSB2YWxbaV0gaW5zdGFuY2VvZiB0aGlzLmNvbnN0cnVjdG9yID8gdmFsW2ldIDogbmV3IHRoaXMuY29uc3RydWN0b3IodmFsW2ldLCB1bmRlZmluZWQsIHBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdWYWwucHVzaCh2KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbmV3VmFsLnN1YnNjcmliZShfbmV3VmFsdWVHZW5lcmF0b3JTdWJzY3JpcHRpb24uY2FsbCh0aGlzLCBwYXRoLCBuZXdWYWwsIHBhcmVudCkpOwoKICAgICAgICAgICAgICAgICAgICB2YWwgPSBuZXdWYWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnVuc2V0ID8gZGVsZXRlIHBOb3dbYXR0cl0gOiBwTm93W2F0dHJdID0gdmFsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIElmIHRoZSBuZXcgYW5kIGN1cnJlbnQgdmFsdWUgZGlmZmVyLCByZWNvcmQgdGhlIGNoYW5nZS4KICAgICAgICAgICAgICAgIGlmICghXy5pc0VxdWFsKHBOb3dbYXR0cl0sIHZhbCkgfHwgKG9wdGlvbnMudW5zZXQgJiYgXy5oYXMocE5vdywgYXR0cikpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwRXNjYXBlZFthdHRyXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9fcHJvcGVydHkuc2V0KChvcHRpb25zLnNpbGVudCA/IHRoaXMuX3NpbGVudCA6IGNoYW5nZXMpLCBwYXRoLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgbmV3IGFuZCBwcmV2aW91cyB2YWx1ZSBkaWZmZXIsIHJlY29yZCB0aGUgY2hhbmdlLiAgSWYgbm90LAogICAgICAgICAgICAgICAgLy8gdGhlbiByZW1vdmUgY2hhbmdlcyBmb3IgdGhpcyBhdHRyaWJ1dGUuCiAgICAgICAgICAgICAgICBpZiAoIV8uaXNFcXVhbChwUHJldlthdHRyXSwgdmFsKSB8fCAoXy5oYXMocE5vdywgYXR0cikgIT09IF8uaGFzKHBQcmV2LCBhdHRyKSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fX3Byb3BlcnR5LnNldCh0aGlzLmNoYW5nZWQsIHBhdGgsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy5fX3Byb3BlcnR5LnNldCh0aGlzLl9wZW5kaW5nLCBwYXRoLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9fcHJvcGVydHkuZGVsKHRoaXMuY2hhbmdlZCwgcGF0aCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fX3Byb3BlcnR5LmRlbCh0aGlzLl9wZW5kaW5nLCBwYXRoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmlyZSB0aGUgYCJjaGFuZ2UiYCBldmVudHMuCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMuY2hhbmdlKG9wdGlvbnMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIHJlc2V0OiBmdW5jdGlvbiAob3B0aW9ucykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldCh0aGlzLl9fZGVlcENsb25lKHRoaXMuX29yaWdpbmFsQXR0cmlidXRlcyksIG9wdGlvbnMpOwogICAgICAgIH0sCiAgICAgICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgICAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKICAgICAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgICAgIHNhdmU6IGZ1bmN0aW9uIChrZXksIHZhbHVlLCBvcHRpb25zKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGF0dHJzLCBjdXJyZW50OwogICAgICAgICAgICBpZiAoaXNPYmplY3Qoa2V5KSB8fCBrZXkgPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBhdHRycyA9IHt9OwogICAgICAgICAgICAgICAgdGhpcy5fX3Byb3BlcnR5LmJ1aWxkKGF0dHJzLCBrZXkpW3RoaXMuX19wcm9wZXJ0eS5sYXN0KGF0dHJzLCBrZXkpXSA9IHZhbHVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY3VycmVudCA9IHRoaXMuX19kZWVwQ2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgICAgICAgdmFyIHNpbGVudE9wdGlvbnMgPSBleHRlbmQoe30sIG9wdGlvbnMsIHsgc2lsZW50OiB0cnVlIH0pOwogICAgICAgICAgICBpZiAoYXR0cnMgJiYgIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zLndhaXQgPyBzaWxlbnRPcHRpb25zIDogb3B0aW9ucykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICAgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24gKHJlc3AsIHN0YXR1cywgeGhyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCB4aHIpOwogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgc2VydmVyQXR0cnMgPSBleHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKICAgICAgICAgICAgICAgIGlmICghbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzcyhtb2RlbCwgcmVzcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgb3B0aW9ucy5lcnJvciA9IEJhY2tib25lLndyYXBFcnJvcihvcHRpb25zLmVycm9yLCBtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgICAgIHZhciBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6ICd1cGRhdGUnOwogICAgICAgICAgICB2YXIgeGhyID0gKHRoaXMuc3luYyB8fCBCYWNrYm9uZS5zeW5jKS5jYWxsKHRoaXMsIG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChvcHRpb25zLndhaXQpIHRoaXMuc2V0KGN1cnJlbnQsIHNpbGVudE9wdGlvbnMpOwogICAgICAgICAgICByZXR1cm4geGhyOwogICAgICAgIH0sCgogICAgICAgIC8vIENhbGwgdGhpcyBtZXRob2QgdG8gbWFudWFsbHkgZmlyZSBhIGAiY2hhbmdlImAgZXZlbnQgZm9yIHRoaXMgbW9kZWwgYW5kCiAgICAgICAgLy8gYSBgImNoYW5nZTphdHRyaWJ1dGUiYCBldmVudCBmb3IgZWFjaCBjaGFuZ2VkIGF0dHJpYnV0ZS4KICAgICAgICAvLyBDYWxsaW5nIHRoaXMgd2lsbCBjYXVzZSBhbGwgb2JqZWN0cyBvYnNlcnZpbmcgdGhlIG1vZGVsIHRvIHVwZGF0ZS4KICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uIChvcHRpb25zKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2NoYW5naW5nIHx8ICF0aGlzLmhhc0NoYW5nZWQoKSkgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIHRoaXMuX2NoYW5naW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fbW9yZUNoYW5nZXMgPSB0cnVlOwogICAgICAgICAgICB2YXIgdHJpZ2dlciA9IGZ1bmN0aW9uIChjaGFuZ2VkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcGF0aHMgPSB0aGlzLl9fcHJvcGVydHkuZ2V0UHJvcGVydGllcyhjaGFuZ2VkKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIHBhdGggaW4gcGF0aHMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNoYW5nZSA9IHRoaXMuX19wcm9wZXJ0eS5nZXQoY2hhbmdlZCwgcGF0aCk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBwYXRoLCB0aGlzLCBjaGFuZ2UsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB0cmlnZ2VyLmNhbGwodGhpcywgdGhpcy5fY2hhbmdlZCk7CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9tb3JlQ2hhbmdlcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fbW9yZUNoYW5nZXMgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gdGhpcy5fX2RlZXBDbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5fY2hhbmdlZDsKICAgICAgICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgogICAgICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICAgICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24gKHBhdGgpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuX2NoYW5nZWQpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fY2hhbmdlZCAmJiB0aGlzLl9fcHJvcGVydHkuaGFzKHRoaXMuX2NoYW5nZWQsIHBhdGggfHwgJycpOwogICAgICAgIH0sCgogICAgICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCiAgICAgICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CiAgICAgICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgICAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICAgICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKICAgICAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbiAoZGlmZikKICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlmZikgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gdGhpcy5fX2RlZXBDbG9uZSh0aGlzLl9jaGFuZ2VkKSA6IGZhbHNlOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fX3Byb3BlcnR5LmZpbmRBbGxDaGFuZ2VkUHJvcGVydGllcyh0aGlzLmF0dHJpYnV0ZXMsIGRpZmYpOwogICAgICAgIH0sCgogICAgICAgIGdldENoYW5nZXM6IGZ1bmN0aW9uIChvcHRpb25zLCBjaGVja0FnYWluc3QpCiAgICAgICAgewogICAgICAgICAgICAvKmpzaGludCBsb29wZnVuYzp0cnVlKi8KICAgICAgICAgICAgdmFyIHJldE9iaiA9IHt9LAogICAgICAgICAgICAgICAgcGF0aHMgPSB0aGlzLl9fcHJvcGVydHkuZ2V0UHJvcGVydGllcyh0aGlzLmF0dHJpYnV0ZXMpLAogICAgICAgICAgICAgICAgaGFzQWRkaXRpb25hbFZhbHVlcyA9IGZhbHNlLAogICAgICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge30sCiAgICAgICAgICAgICAgICByZXF1aXJlZFByb3BlcnRpZXMgPSBvcHRpb25zLnJlcXVpcmVkIHx8IHt9LAogICAgICAgICAgICAgICAgY29tcGxldGVBcnJheSA9IG9wdGlvbnMuY29tcGxldGVBcnJheSB8fCB7fSwKICAgICAgICAgICAgICAgIHBhcnRpYWxBcnJheSA9IG9wdGlvbnMucGFydGlhbEFycmF5IHx8IHt9OwoKICAgICAgICAgICAgdmFyIGhhc1BhcnRpYWxBcnJheU9wdGlvbiA9IF8uc2l6ZShwYXJ0aWFsQXJyYXkpID4gMCwKICAgICAgICAgICAgICAgIGhhc0NvbXBsZXRlQXJyYXlPcHRpb24gPSBfLnNpemUoY29tcGxldGVBcnJheSkgPiAwOwoKICAgICAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBwYXRocykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcGF0aHNbcGF0aF0sCiAgICAgICAgICAgICAgICAgICAgb1ZhbHVlID0gdGhpcy5fX3Byb3BlcnR5LmdldChjaGVja0FnYWluc3QgfHwgdGhpcy5fb3JpZ2luYWxBdHRyaWJ1dGVzLCBwYXRoKTsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBmb3Igb2JzZXJ2YWJsZUFycmF5CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3RPck9iamVjdE9ic2VydmFibGUodmFsdWUpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdW53cmFwT2JzZXJ2YWJsZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgb1ZhbHVlID0gdW53cmFwT2JzZXJ2YWJsZShvVmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0ge307CiAgICAgICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsT2JqZWN0ID0ge307CiAgICAgICAgICAgICAgICAgICAgdmFyIG9iamVjdEhhc011dGF0ZWQgPSAhb1ZhbHVlOwogICAgICAgICAgICAgICAgICAgIGlmIChvVmFsdWUpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSAmJiBfLmZvckVhY2godmFsdWUsIGZ1bmN0aW9uICh4KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHgub3JpZ2luYWxLZXkgIT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsT2JqZWN0W3gub3JpZ2luYWxLZXldID0gb1ZhbHVlW3gub3JpZ2luYWxLZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdEhhc011dGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gdmFsdWUpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwodmFsdWUsIGkpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVhbFZhbHVlID0gdmFsdWVbaV0sIGNoYW5nZXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlYWxWYWx1ZS5vcmlnaW5hbEtleSAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlcyA9IHJlYWxWYWx1ZS5nZXRDaGFuZ2VzKG9wdGlvbnMsIG9yaWdpbmFsT2JqZWN0W3JlYWxWYWx1ZS5vcmlnaW5hbEtleV0gfHwge30pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZXMgPSByZWFsVmFsdWUuZ2V0Q2hhbmdlcyhvcHRpb25zLCB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYW5nZXMgJiYgIV8uaXNFbXB0eShjaGFuZ2VzKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmpbaV0gPSBjaGFuZ2VzOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICgoXy5zaXplKG9iaikgPiAwIHx8IG9iamVjdEhhc011dGF0ZWQpICYmIChoYXNBZGRpdGlvbmFsVmFsdWVzID0gdHJ1ZSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9fcHJvcGVydHkuc2V0KHJldE9iaiwgcGF0aCwgb2JqKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChpc0FycmF5T3JBcnJheU9ic2VydmFibGUodmFsdWUpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdW53cmFwT2JzZXJ2YWJsZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgb1ZhbHVlID0gdW53cmFwT2JzZXJ2YWJsZShvVmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgYXJyID0gW107CiAgICAgICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsQXJyYXkgPSB7fTsKICAgICAgICAgICAgICAgICAgICB2YXIgYXJyYXlIYXNNdXRhdGVkID0gIW9WYWx1ZSB8fCAob1ZhbHVlLmxlbmd0aCA+IDAgJiYgdmFsdWUubGVuZ3RoIDwgb1ZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9WYWx1ZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlICYmIHZhbHVlLmZvckVhY2goZnVuY3Rpb24gKHgpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgeC5vcmlnaW5hbEluZGV4ICE9PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbEFycmF5W3gub3JpZ2luYWxJbmRleF0gPSBvVmFsdWVbeC5vcmlnaW5hbEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheUhhc011dGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gdmFsdWUubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlYWxWYWx1ZSA9IHZhbHVlW2ldLCBjaGFuZ2VzOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlYWxWYWx1ZS5vcmlnaW5hbEluZGV4ICE9PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlcyA9IHJlYWxWYWx1ZS5nZXRDaGFuZ2VzKG9wdGlvbnMsIG9yaWdpbmFsQXJyYXlbcmVhbFZhbHVlLm9yaWdpbmFsSW5kZXhdIHx8IHt9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZXMgPSByZWFsVmFsdWUuZ2V0Q2hhbmdlcyhvcHRpb25zLCB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcnJheUhhc011dGF0ZWQpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNDb21wbGV0ZUFycmF5T3B0aW9uICYmIF8uYW55KGNvbXBsZXRlQXJyYXksIGZ1bmN0aW9uICh4KSB7IHJldHVybiBwYXRoLmluZGV4T2YoeCkgPiAtMTsgfSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlcyA9IHJlYWxWYWx1ZS50b0pzb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGhhc1BhcnRpYWxBcnJheU9wdGlvbiAmJiBfLmFsbChwYXJ0aWFsQXJyYXksIGZ1bmN0aW9uICh4KSB7IHJldHVybiBwYXRoLmluZGV4T2YoeCkgPT09IC0xOyB9KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VzID0gcmVhbFZhbHVlLnRvSnNvbigpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hhbmdlcyAmJiAhXy5pc0VtcHR5KGNoYW5nZXMpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goY2hhbmdlcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICgoYXJyLmxlbmd0aCA+IDAgfHwgYXJyYXlIYXNNdXRhdGVkKSAmJiAoaGFzQWRkaXRpb25hbFZhbHVlcyA9IHRydWUpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fX3Byb3BlcnR5LnNldChyZXRPYmosIHBhdGgsIGFycik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIFRvdGFsIGFidXNlIG9mIGFuIGlmIHN0YXRlbWVudAogICAgICAgICAgICAgICAgICAgIGlmICgodmFsdWUgIT0gb1ZhbHVlICYmIChoYXNBZGRpdGlvbmFsVmFsdWVzID0gdHJ1ZSkpIHx8IHJlcXVpcmVkUHJvcGVydGllcyAmJiByZXF1aXJlZFByb3BlcnRpZXNbcGF0aF0pCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX19wcm9wZXJ0eS5zZXQocmV0T2JqLCBwYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc0FkZGl0aW9uYWxWYWx1ZXMpCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0T2JqOwogICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgfSwKCiAgICAgICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CiAgICAgICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICAgICAgcHJldmlvdXM6IGZ1bmN0aW9uIChwYXRoKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fX3Byb3BlcnR5LmdldCh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMsIHBhdGggfHwgJycpOwogICAgICAgIH0sCgogICAgICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwogICAgICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICAgICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19kZWVwQ2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgICAgICB9LAoKICAgICAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuIEl0J3Mgb25seSBwb3NzaWJsZSB0bwogICAgICAgIC8vIGdldCBpbnRvIGFuICppbnZhbGlkKiBzdGF0ZSBpZiB5b3UncmUgdXNpbmcgc2lsZW50IGNoYW5nZXMuCiAgICAgICAgaXNWYWxpZDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAhdGhpcy52YWxpZGF0ZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgIH0sCgogICAgICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgYSBzZXQgb2YgaW5jb21pbmcgYXR0cmlidXRlcywgcmV0dXJuaW5nIGB0cnVlYAogICAgICAgIC8vIGlmIGFsbCBpcyB3ZWxsLiBJZiBhIHNwZWNpZmljIGBlcnJvcmAgY2FsbGJhY2sgaGFzIGJlZW4gcGFzc2VkLAogICAgICAgIC8vIGNhbGwgdGhhdCBpbnN0ZWFkIG9mIGZpcmluZyB0aGUgZ2VuZXJhbCBgImVycm9yImAgZXZlbnQuCiAgICAgICAgX3ZhbGlkYXRlOiBmdW5jdGlvbiAoYXR0cnMsIG9wdGlvbnMpCiAgICAgICAgewogICAgICAgICAgICBpZiAob3B0aW9ucy5zaWxlbnQgfHwgIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICAgICAgICBhdHRycyA9IGV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoIWVycm9yKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lcnJvcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3B0aW9ucy5lcnJvcih0aGlzLCBlcnJvciwgb3B0aW9ucyk7CiAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgdGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgdGhlIGtvIGJpbmRpbmdzLgogICAgICAgIGFwcGx5QmluZGluZ3M6IGZ1bmN0aW9uICh0bykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBrby5hcHBseUJpbmRpbmdzKHRoaXMuZ2V0Vmlld01vZGVsKCksIHRvKTsKICAgICAgICB9LAogICAgfSk7CgogICAgS25vY2tvdXRNb2RlbEJhc2UucHJvdG90eXBlLmdldFZpZXdNb2RlbCA9IGZ1bmN0aW9uIChvcHRpb25zKQogICAgewogICAgICAgIGlmIChfX3ZpZXdNb2RlbHNbdGhpcy5jaWRdKQogICAgICAgICAgICByZXR1cm4gX192aWV3TW9kZWxzW3RoaXMuY2lkXTsKCiAgICAgICAgcmV0dXJuIChfX3ZpZXdNb2RlbHNbdGhpcy5jaWRdID0gbmV3IHRoaXMudmlld01vZGVsQ29uc3RydWN0b3IodGhpcywgb3B0aW9ucykpOwogICAgfTsKCiAgICBLbm9ja291dE1vZGVsQmFzZS5leHRlbmQgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQ7CgogICAgS25vY2tvdXRNb2RlbEJhc2UucHJvdG90eXBlLnRvSlNPTiA9IEtub2Nrb3V0TW9kZWxCYXNlLnByb3RvdHlwZS50b0pzb247CgogICAgS25vY2tvdXRNb2RlbEJhc2UuZ2V0TW9kZWwgPSBmdW5jdGlvbiAoY2lkKQogICAgewogICAgICAgIHJldHVybiBfX21vZGVsc1tjaWRdOwogICAgfTsKCiAgICBLbm9ja291dE1vZGVsQmFzZS5fX21vZGVscyA9IF9fbW9kZWxzOwogICAgS25vY2tvdXRNb2RlbEJhc2UuX192aWV3TW9kZWxzID0gX192aWV3TW9kZWxzOwoKICAgIHJldHVybiBLbm9ja291dE1vZGVsQmFzZTsKfSk7CgpkZWZpbmUoJ2tvYi1tb2RlbC92aWV3bW9kZWwuYmFzZScsWwogICAgJy4vbW9kZWwuYmFzZScsCiAgICAna25vY2tvdXQnLAogICAgJ2xvZGFzaCcsCiAgICAnLi91dGlsJwpdLApmdW5jdGlvbiAoS25vY2tvdXRNb2RlbEJhc2UsIGtvLCBfLCB1dGlsKQp7CiAgICAKICAgIHZhciBleHRlbmQgPSBfLmV4dGVuZCwKICAgICAgICBrbm9ja291dFBhdGggPSB1dGlsLmtub2Nrb3V0UGF0aCwKICAgICAgICBfX21vZGVscyA9IEtub2Nrb3V0TW9kZWxCYXNlLl9fbW9kZWxzLAogICAgICAgIF9fdmlld01vZGVscyA9IEtub2Nrb3V0TW9kZWxCYXNlLl9fdmlld01vZGVscywKICAgICAgICBfX29yaWdpbmFsU3RhdGUgPSB7fSwKICAgICAgICB1bndyYXBPYnNlcnZhYmxlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSwKICAgICAgICBpc0FycmF5ID0gXy5pc0FycmF5LAogICAgICAgIGlzU3RyaW5nID0gXy5pc1N0cmluZywKICAgICAgICBpc0VxdWFsID0gXy5pc0VxdWFsLAogICAgICAgIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sCiAgICAgICAgZWFjaCA9IF8uZWFjaCwKICAgICAgICBpc09iamVjdE9yT2JqZWN0T2JzZXJ2YWJsZSA9IHV0aWwuaXNPYmplY3RPck9iamVjdE9ic2VydmFibGUsCiAgICAgICAgaXNBcnJheU9yQXJyYXlPYnNlcnZhYmxlID0gdXRpbC5pc0FycmF5T3JBcnJheU9ic2VydmFibGU7CgogICAgdmFyIEtub2Nrb3V0Vmlld01vZGVsQmFzZSA9IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykKICAgIHsKICAgICAgICAvKmpzaGludCBsb29wZnVuYzp0cnVlKi8KICAgICAgICAvLyBmZXRjaCBhbGwgdGhlIGxlYWYgbm9kZXMgZm9yIHRoZSBtb2RlbC4KICAgICAgICB2YXIgcHJvcGVydGllcyA9IHRoaXMuZ2V0UHJvcGVydGllcyhtb2RlbC5hdHRyaWJ1dGVzKTsKICAgICAgICB0aGlzLmNpZCA9IG1vZGVsLmNpZDsKICAgICAgICBfX21vZGVsc1ttb2RlbC5jaWRdID0gbW9kZWw7CgogICAgICAgIHZhciBtb2RlbEhhc0Vycm9yTWVzc2FnZXMgPSAhIW1vZGVsLmVycm9yTWVzc2FnZXM7CiAgICAgICAgaWYgKG1vZGVsSGFzRXJyb3JNZXNzYWdlcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3VtbWFyeSA9IG1vZGVsLmVycm9yTWVzc2FnZXMuZ2V0RXJyb3JPYnNlcnZhYmxlKCdzdW1tYXJ5Jyk7CiAgICAgICAgICAgIHRoaXMuc3VtbWFyeS5oYXNFcnJvcnMgPSB0aGlzLnN1bW1hcnkuZXJyb3JzLmhhc0Vycm9yczsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIHBhdGggaW4gcHJvcGVydGllcykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcm9wID0gdW53cmFwT2JzZXJ2YWJsZShwcm9wZXJ0aWVzW3BhdGhdKSwKICAgICAgICAgICAgICAgIGtvUGF0aCA9IGtub2Nrb3V0UGF0aChwYXRoKSwKICAgICAgICAgICAgICAgIGJpbmRQYXRoID0gJ2NoYW5nZTonICsgcGF0aCwKICAgICAgICAgICAgICAgIGxhc3RJbmRleCA9IC0xLAogICAgICAgICAgICAgICAgb2JzZXJ2YWJsZTsKCiAgICAgICAgICAgIGlmIChpc09iamVjdE9yT2JqZWN0T2JzZXJ2YWJsZShwcm9wKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG9ic2VydmFibGVWYWx1ZSA9IHt9OwogICAgICAgICAgICAgICAgb2JzZXJ2YWJsZSA9IHRoaXNba29QYXRoXSA9IGtvLm9ic2VydmFibGUob2JzZXJ2YWJsZVZhbHVlKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gcHJvcCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwocHJvcCwgaSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3ViS29QYXRoID0ga25vY2tvdXRQYXRoKGkpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcE1vZGVsID0gcHJvcFtpXSwgcHJvcFZpZXdNb2RlbCA9IHByb3BNb2RlbC5nZXRWaWV3TW9kZWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvcFZpZXdNb2RlbC5vcmlnaW5hbEtleSA9IHByb3BNb2RlbC5vcmlnaW5hbEtleSA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmFibGVWYWx1ZVtzdWJLb1BhdGhdID0gcHJvcFZpZXdNb2RlbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaXNBcnJheU9yQXJyYXlPYnNlcnZhYmxlKHByb3ApKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvYnNlcnZhYmxlID0gdGhpc1trb1BhdGhdID0ga28ub2JzZXJ2YWJsZUFycmF5KFtdKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gcHJvcC5sZW5ndGg7IGkgPCBpTGVuOyBpKyspCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BNb2RlbCA9IHByb3BbaV0sIHByb3BWaWV3TW9kZWwgPSBwcm9wTW9kZWwuZ2V0Vmlld01vZGVsKCk7CiAgICAgICAgICAgICAgICAgICAgcHJvcFZpZXdNb2RlbC5vcmlnaW5hbEluZGV4ID0gcHJvcE1vZGVsLm9yaWdpbmFsSW5kZXggPSBpOwogICAgICAgICAgICAgICAgICAgIG9ic2VydmFibGUucHVzaChwcm9wVmlld01vZGVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vZGVsLmJpbmQoYmluZFBhdGgsIHVwZGF0ZV92bU9ic2VydmFibGVBcnJheV9mcm9tX21PYnNlcnZhYmxlQXJyYXlGYWN0b3J5KG9ic2VydmFibGUpKTsKICAgICAgICAgICAgICAgIG9ic2VydmFibGUuc3Vic2NyaWJlKHVwZGF0ZV9tT2JzZXJ2YWJsZUFycmF5X2Zyb21fdm1PYnNlcnZhYmxlQXJyYXlfZmFjdG9yeShtb2RlbCwgcGF0aCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb2JzZXJ2YWJsZSA9IHRoaXNba29QYXRoXSA9IGtvLm9ic2VydmFibGUodHlwZW9mIHByb3AgPT09ICd1bmRlZmluZWQnID8gJycgOiBwcm9wKTsKICAgICAgICAgICAgICAgIG1vZGVsLmJpbmQoYmluZFBhdGgsIHVwZGF0ZV92bU9ic2VydmFibGVfZnJvbV9tVmFsdWVfZmFjdG9yeShvYnNlcnZhYmxlKSk7CiAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnN1YnNjcmliZSh1cGRhdGVfbVZhbHVlX2Zyb21fdm1PYnNlcnZhYmxlX2ZhY3RvcnkobW9kZWwsIHBhdGgpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG1vZGVsSGFzRXJyb3JNZXNzYWdlcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb2JzZXJ2YWJsZS5lcnJvcnMgPSBtb2RlbC5lcnJvck1lc3NhZ2VzLmdldEVycm9yT2JzZXJ2YWJsZShwYXRoKTsKICAgICAgICAgICAgICAgIG9ic2VydmFibGUuaGFzRXJyb3JzID0gb2JzZXJ2YWJsZS5lcnJvcnMuaGFzRXJyb3JzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLm1pcnJvclBhdGhzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICBlYWNoKG9wdGlvbnMubWlycm9yUGF0aHMsIGZ1bmN0aW9uIChtaXJyb3JQYXRoKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChrb1BhdGguaW5kZXhPZihtaXJyb3JQYXRoKSA9PT0ga29QYXRoLmxlbmd0aCAtIG1pcnJvclBhdGgubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICB0aGF0W2tvUGF0aC5zdWJzdHJpbmcoMCwga29QYXRoLmxlbmd0aCAtIG1pcnJvclBhdGgubGVuZ3RoKV0gPSBvYnNlcnZhYmxlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIHZhciBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgZXh0ZW5kKEtub2Nrb3V0Vmlld01vZGVsQmFzZS5wcm90b3R5cGUsIHsKICAgICAgICBnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbiAob2JqKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsKICAgICAgICB9LAogICAgICAgIGdldE1vZGVsOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIF9fbW9kZWxzW3RoaXMuY2lkXTsKICAgICAgICB9LAogICAgICAgIHBhcmVudDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBtID0gdGhpcy5nZXRNb2RlbCgpOwogICAgICAgICAgICByZXR1cm4gbS5fcGFyZW50ICYmIF9fdmlld01vZGVsc1ttLl9wYXJlbnQuY2lkXTsKICAgICAgICB9LAogICAgICAgIGNsb25lOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9kZWwoKS5jbG9uZSgpLmdldFZpZXdNb2RlbCgpOwogICAgICAgIH0sCiAgICAgICAgc3RvcmU6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgb3MgPSBfX29yaWdpbmFsU3RhdGVbdGhpcy5jaWRdID0ge307CgogICAgICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbCh0aGlzLCBpKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSB1bndyYXBPYnNlcnZhYmxlKHRoaXNbaV0pOwogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2ID0gb3NbaV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgeiA9IDAsIHpMZW4gPSB2YWx1ZS5sZW5ndGg7IHogPCB6TGVuOyB6KyspCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZVt6XSBpbnN0YW5jZW9mIHRoaXMuY29uc3RydWN0b3IpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVbel0uc3RvcmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2LnB1c2godmFsdWVbel0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9zW2ldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZXZlcnQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgc3RhdGUgPSBfX29yaWdpbmFsU3RhdGVbdGhpcy5jaWRdOwogICAgICAgICAgICBpZiAoc3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gc3RhdGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHRoaXMsIGkpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gc3RhdGVbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJUaGlzID0gdW53cmFwT2JzZXJ2YWJsZSh0aGlzW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkodmFsdWUpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJUaGlzLnNwbGljZSgwLCB2YXJUaGlzLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB6ID0gMCwgekxlbiA9IHZhbHVlLmxlbmd0aDsgeiA8IHpMZW47IHorKykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJUaGlzLnB1c2godmFsdWVbel0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlW3pdLnJldmVydCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24odGhpc1tpXSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjb21taXQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICBkZWxldGUgX19vcmlnaW5hbFN0YXRlW3RoaXMuY2lkXTsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgdGhlIGtvIGJpbmRpbmdzLgogICAgICAgIGFwcGx5QmluZGluZ3M6IGZ1bmN0aW9uICh0bykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBrby5hcHBseUJpbmRpbmdzKHRoaXMsIHRvKTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgIE1hcHMgdGhlIGNoYW5nZXMgZnJvbSBvbmUgYXJyYXkgb250byB0aGUgb3RoZXIgYXJyYXkuCiAgICBBdHRlbXB0aW5nIHRvIHRyYWNrIHNpbXBsZSBvcGVyYXRpb25zLCBsaWtlIGluc2VydHMgb3Igc3BsaWNlcywgd29yc2UgY2FzZSB0aGUgZW50aXJlIGFycmF5IGVtcHRpZWQgYW5kIHJlYnVpbHQuCiAgICBUaGUgbGFzdCBvcGVyYXRpb24gY291bGQgdXNlIHNvbWUgVExDIHNvIHRoYXQgaXQncyBub3QgYXMgZXhwZW5zaXZlIGlmIHRoZSBhcnJheSBpcyB2ZXJ5IGxhcmdlLgoKICAgIEBtZXRob2Qgb2JzZXJ2YWJsZUFycmF5U3Vic2NyaXB0aW9uQmluZGVyCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtrby5vYnNlcnZhYmxlQXJyYXkgfCBBcnJheX0gdGFyZ2V0QXJyYXkgVGhlIGFycmF5IHRoYXQgaXMgdGhlIHRhcmdldCBvZiB0aGUgY2hhbmdlcy4KICAgIEBwYXJhbSB7a28ub2JzZXJ2YWJsZUFycmF5IHwgQXJyYXl9IHJlZmVyZW5jZUFycmF5IFRoZSBhcnJheSB0aGF0IGlzIHRoZSByZWZlcmVuY2UgYXJyYXkgd2l0aCBjaGFuZ2VzLgogICAgQHBhcmFtIHtGdWNudGlvbn0gbmV3Q2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRoYXQgaXMgaXNzdWVkLCB0byBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgdGhlIGl0ZW0gaW4gdGhlIGFycmF5LiAgVGhpbmsgY3JlYXRlIGEgbmV3IGNsYXNzLCBnaXZlbiB0aGUgaW5wdXQuCiAgICBAcGFyYW0ge1N0cmluZ30gcmVmZXJlbmNlTW9kZWxBY2Nlc3NvciBUaGUgbW9kZWwgYWNjZXNzb3IgZm9yIHRoZSByZWZlcmVuY2UgYXJyYXkuICBXaWxsIHJldHVybiBhbiBvYmplY3QgdGhhdCBpcyBjb21wYXRhYmxlIHdpdGggdGhlIHRhcmdldCBhcnJheSB3aGVuIGludm9rZWQuCiAgICBAcGFyYW0ge1N0cmluZ30gdGFyZ2V0TW9kZWxBY2Nlc3NvciBUaGUgbW9kZWwgYWNjZXNzb3IgZm9yIHRoZSB0YXJnZXQgYXJyYXkuIFdpbGwgcmV0dXJuIGFuIG9iamVjdCB0aGF0IGlzIGNvbXBhdGFibGUgd2l0aCB0aGUgcmVmZXJlbmNlIGFycmF5IHdoZW4gaW52b2tlZC4KICAgICoqLwogICAgdmFyIG9ic2VydmFibGVBcnJheVN1YnNjcmlwdGlvbkJpbmRlciA9IGZ1bmN0aW9uICh0YXJnZXRBcnJheSwgcmVmZXJlbmNlQXJyYXksIG5ld0NhbGxiYWNrLCByZWZlcmVuY2VNb2RlbEFjY2Vzc29yLCB0YXJnZXRNb2RlbEFjY2Vzc29yKQogICAgewogICAgICAgIC8qanNoaW50IGxvb3BmdW5jOnRydWUqLwogICAgICAgIHJlZmVyZW5jZUFycmF5ID0gdW53cmFwT2JzZXJ2YWJsZShyZWZlcmVuY2VBcnJheSk7CiAgICAgICAgdmFyIHRhcmdldCA9IHVud3JhcE9ic2VydmFibGUodGFyZ2V0QXJyYXkpOwoKICAgICAgICAvLyBFdmVudCBmaXJlcyB3aGVuIHNvbWV0aGluZyBjaGFuZ2VzIHdoZW4gdGhlIGFycmF5IGlzIGFkZGVkIG9yIHJlbW92ZWQuCiAgICAgICAgLy8gQ2hhbmdlIGluIHRoZSBwYXJlbnQgYXJyYXksIGdldCB0cmFuc2xhdGVkIHRvIHRoZSBiYWNrYm9uZSBtb2RlbC4KICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IHJlZmVyZW5jZUFycmF5Lmxlbmd0aDsgaSA8IGlMZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBvID0gcmVmZXJlbmNlQXJyYXlbaV0sCiAgICAgICAgICAgICAgICB0ID0gdGFyZ2V0W2ldOwogICAgICAgICAgICAvLyBJbnNlcnQKICAgICAgICAgICAgaWYgKHQgPT09IHVuZGVmaW5lZCB8fCAhdC5jaWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IG5ld0NhbGxiYWNrKG8pOwogICAgICAgICAgICAgICAgaWYgKHRhcmdldE1vZGVsQWNjZXNzb3IpCiAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlQXJyYXlbaV0gPSBuZXdWYWx1ZVt0YXJnZXRNb2RlbEFjY2Vzc29yXSgpOwogICAgICAgICAgICAgICAgdGFyZ2V0QXJyYXkuc3BsaWNlKGksIDAsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBEZWxldGUKICAgICAgICAgICAgZWxzZSBpZiAodGFyZ2V0Lmxlbmd0aCA+IHJlZmVyZW5jZUFycmF5Lmxlbmd0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGNpZHMgPSByZWZlcmVuY2VBcnJheS5tYXAoZnVuY3Rpb24gKGl0ZW0pIHsgcmV0dXJuIGl0ZW0uY2lkOyB9KTsKICAgICAgICAgICAgICAgIGZvciAodmFyIHogPSB0YXJnZXQubGVuZ3RoIC0gMTsgeiA+PSAwOyB6LS0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB0YXJnZXRbel07CiAgICAgICAgICAgICAgICAgICAgaWYgKCFjaWRzLnNvbWUoZnVuY3Rpb24gKGl0KSB7IHJldHVybiBpdCA9PT0gaXRlbS5jaWQ7IH0pKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0QXJyYXkuc3BsaWNlKHosIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gUG90ZW50aWFsbHkgY29tcGxleCBtb3ZlLCBqdXN0IHJlYnVpbGQgYXJyYXkgd2l0aCByZWZlcmVuY2UgbW9kZWxzLgogICAgICAgICAgICBlbHNlIGlmICh0YXJnZXRbaV0uY2lkICE9PSBvLmNpZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFyZ2V0LnNwbGljZSgwLCB0YXJnZXQubGVuZ3RoKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIHogPSAwLCB6TGVuID0gcmVmZXJlbmNlQXJyYXkubGVuZ3RoOyB6IDwgekxlbjsgeisrKQogICAgICAgICAgICAgICAgICAgIHRhcmdldC5wdXNoKHJlZmVyZW5jZUFycmF5W3pdW3JlZmVyZW5jZU1vZGVsQWNjZXNzb3JdKCkpOwogICAgICAgICAgICAgICAgLy8gVGFyZ2V0IGFycmF5IGlzIG9ic2VydmFibGUKICAgICAgICAgICAgICAgIHRhcmdldEFycmF5Lm5vdGlmeVN1YnNjcmliZXJzICYmIHRhcmdldEFycmF5Lm5vdGlmeVN1YnNjcmliZXJzKHRhcmdldCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocmVmZXJlbmNlQXJyYXkubGVuZ3RoID09PSAwICYmIHRhcmdldC5sZW5ndGggPiAwKQogICAgICAgICAgICB0YXJnZXRBcnJheS5zcGxpY2UoMCwgdGFyZ2V0Lmxlbmd0aCk7CiAgICB9OwoKICAgIC8qKgogICAgVXBkYXRlcyB0aGUgdmlldyBtb2RlbCBvYnNlcnZhYmxlIGFycmF5LCBmcm9tIHRoZSBtb2RlbCBvYnNlcnZhYmxlIGFycmF5LgoKICAgIEBtZXRob2QgdXBkYXRlX3ZtT2JzZXJ2YWJsZUFycmF5X2Zyb21fbU9ic2VydmFibGVBcnJheUZhY3RvcnkKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge2tvLm9ic2VydmFibGVBcnJheX0gb2JzZXJ2YWJsZUFycmF5IFRoZSBvYnNlcnZhYmxlIGl0ZW0uCiAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBzdWJzY3JpcHRpb24gbWV0aG9kIHRvIGJlIHVzZWQgd2hlbiB1cGRhdGluZyB0aGUgYXJyYXkgb24gdGhlIG1vZGVsIHNpZGUKICAgICoqLwogICAgdmFyIHVwZGF0ZV92bU9ic2VydmFibGVBcnJheV9mcm9tX21PYnNlcnZhYmxlQXJyYXlGYWN0b3J5ID0gZnVuY3Rpb24gKG9ic2VydmFibGVBcnJheSkKICAgIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHBhdGgsIHZhbCkKICAgICAgICB7CiAgICAgICAgICAgIG9ic2VydmFibGVBcnJheVN1YnNjcmlwdGlvbkJpbmRlcihvYnNlcnZhYmxlQXJyYXksIHZhbCwgZnVuY3Rpb24gKG8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBvLmdldFZpZXdNb2RlbCgpOwogICAgICAgICAgICB9LCAnZ2V0Vmlld01vZGVsJyk7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICBVcGRhdGVzIHRoZSBtb2RlbCBvYnNlcnZhYmxlIGFycmF5LCBmcm9tIHRoZSB2aWV3IG1vZGVsIG9ic2VydmFibGUgYXJyYXkuCgogICAgQG1ldGhvZCB1cGRhdGVfbU9ic2VydmFibGVBcnJheV9mcm9tX3ZtT2JzZXJ2YWJsZUFycmF5X2ZhY3RvcnkKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0tub2Nrb3V0TW9kZWxCYXNlfSBtb2RlbCBUaGUgY28gbW9kZWwKICAgIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwYXRoIHRvIHRoZSBvYnNlcnZhYmxlIGFycmF5CiAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBzdWJzY3JpcHRpb24gbWV0aG9kIHRvIGJlIHVzZWQgd2hlbiB1cGRhdGluZyB0aGUgYXJyYXkgb24gdGhlIHZpZXcgbW9kZWwgc2lkZQogICAgKiovCiAgICB2YXIgdXBkYXRlX21PYnNlcnZhYmxlQXJyYXlfZnJvbV92bU9ic2VydmFibGVBcnJheV9mYWN0b3J5ID0gZnVuY3Rpb24gKG1vZGVsLCBwYXRoKQogICAgewogICAgICAgIHZhciBwYXJlbnRDaWQgPSBtb2RlbC5jaWQsCiAgICAgICAgICAgIG9ic2VydmFibGVBcnJheSA9IG1vZGVsLmdldChwYXRoKTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWwpCiAgICAgICAgewogICAgICAgICAgICBvYnNlcnZhYmxlQXJyYXlTdWJzY3JpcHRpb25CaW5kZXIob2JzZXJ2YWJsZUFycmF5LCB2YWwsIGZ1bmN0aW9uIChvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAobyBpbnN0YW5jZW9mIG1vZGVsLmNvbnN0cnVjdG9yKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG8gPSBvLmdldE1vZGVsKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbyA9IG5ldyBtb2RlbC5jb25zdHJ1Y3RvcihvLCB1bmRlZmluZWQsIF9fbW9kZWxzW3BhcmVudENpZF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG87CiAgICAgICAgICAgIH0sICdnZXRNb2RlbCcsICdnZXRWaWV3TW9kZWwnKTsKICAgICAgICB9OwogICAgfTsKCiAgICAvKioKICAgIFVwZGF0ZXMgdGhlIHZpZXcgbW9kZWwgb2JzZXJ2YWJsZSB2YWx1ZSBmcm9tIHRoZSBtb2RlbCB2YWx1ZQoKICAgIEBtZXRob2QgdXBkYXRlX3ZtT2JzZXJ2YWJsZV9mcm9tX21WYWx1ZV9mYWN0b3J5CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtrby5vYnNlcnZhYmxlfSBvYnNlcnZhYmxlIFRoZSBvYnNlcnZhYmxlIHZhbHVlIHRvIGJlIHVwZGF0ZWQsIGlmIHJlcXVpcmVkLgogICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgc3Vic2NyaXB0aW9uIG1ldGhvZCB0byBiZSB1c2VkIHdoZW4gdXBkYXRpbmcgdGhlIG9ic2VydmFibGUgb24gdGhlIHZpZXcgbW9kZWwgc2lkZQogICAgKiovCiAgICB2YXIgdXBkYXRlX3ZtT2JzZXJ2YWJsZV9mcm9tX21WYWx1ZV9mYWN0b3J5ID0gZnVuY3Rpb24gKG9ic2VydmFibGUpCiAgICB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChwYXRoLCB2YWwpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRXF1YWwob2JzZXJ2YWJsZSgpLCB2YWwpKSBvYnNlcnZhYmxlKHZhbCk7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICBVcGRhdGVzIHRoZSB2aWV3IG1vZGVsIG9ic2VydmFibGUgdmFsdWUgZnJvbSB0aGUgbW9kZWwgdmFsdWUKCiAgICBAbWV0aG9kIHVwZGF0ZV9tVmFsdWVfZnJvbV92bU9ic2VydmFibGVfZmFjdG9yeQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7S25vY2tvdXRNb2RlbEJhc2V9IG1vZGVsIFRoZSBjbyBtb2RlbAogICAgQHBhcmFtIHtTdHJpbmd9IHBhdGggVGhlIHBhdGggdG8gdGhlIG9ic2VydmFibGUgYXJyYXkKICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIHN1YnNjcmlwdGlvbiBtZXRob2QgdG8gYmUgdXNlZCB3aGVuIHVwZGF0aW5nIHRoZSB2YWx1ZSBvbiB0aGUgbW9kZWwgc2lkZQogICAgKiovCiAgICB2YXIgdXBkYXRlX21WYWx1ZV9mcm9tX3ZtT2JzZXJ2YWJsZV9mYWN0b3J5ID0gZnVuY3Rpb24gKG1vZGVsLCBwYXRoKQogICAgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc0VxdWFsKG1vZGVsLmdldChwYXRoKSwgdmFsKSkKICAgICAgICAgICAgICAgIG1vZGVsLnNldChwYXRoLCB2YWwpOwogICAgICAgIH07CiAgICB9OwoKICAgIEtub2Nrb3V0Vmlld01vZGVsQmFzZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBLbm9ja291dFZpZXdNb2RlbEJhc2U7CiAgICBLbm9ja291dFZpZXdNb2RlbEJhc2UuZXh0ZW5kID0gS25vY2tvdXRNb2RlbEJhc2UuZXh0ZW5kOwoKICAgIHJldHVybiBLbm9ja291dFZpZXdNb2RlbEJhc2U7Cn0pOwoKZGVmaW5lKCdrb2ItbW9kZWwvc2ltcGxlL3ZpZXdtb2RlbCcsWycuLi92aWV3bW9kZWwuYmFzZSddLApmdW5jdGlvbiAoS25vY2tvdXRWaWV3TW9kZWxCYXNlKQp7CiAgICB2YXIgU2ltcGxlS25vY2tvdXRWaWV3TW9kZWwgPSBLbm9ja291dFZpZXdNb2RlbEJhc2UuZXh0ZW5kKHsKICAgICAgICBnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbiAoYXR0cnMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgICAgfSwKICAgIH0pOwogICAgU2ltcGxlS25vY2tvdXRWaWV3TW9kZWwucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gU2ltcGxlS25vY2tvdXRWaWV3TW9kZWw7CgogICAgcmV0dXJuIFNpbXBsZUtub2Nrb3V0Vmlld01vZGVsOwp9KTsKCmRlZmluZSgna29iLW1vZGVsL2Vycm9ycy5iYXNlJyxbJ2JhY2tib25lJywgJ2xvZGFzaCcsICdrbm9ja291dCddLApmdW5jdGlvbihCYWNrYm9uZSwgXywga28pCnsKICAgIHZhciBpc1N0cmluZyA9IF8uaXNTdHJpbmcsCiAgICAgICAgaXNBcnJheSA9IF8uaXNBcnJheSwKICAgICAgICBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKICAgIC8qCiAgICAgICAgRGVmYXVsdCBleHRlbmRlciBmb3IgZXJyb3JzLCBhbGxvd3MgZm9yIGJldHRlciBvdmVyYWxsIHBlcmZvcm1hbmNlIGluIGRldGVjdGluZyBpZiB0aGVyZSBhcmUgZXJyb3JzLgogICAgKi8KICAgIGtvLmV4dGVuZGVyc1snZXJyb3JzJ10gPSBmdW5jdGlvbiAodGFyZ2V0KQogICAgewogICAgICAgIHZhciBoYXNFcnJvcnMgPSB0YXJnZXQuaGFzRXJyb3JzID0ga28ub2JzZXJ2YWJsZShmYWxzZSk7CiAgICAgICAgdGFyZ2V0LnN1YnNjcmliZShmdW5jdGlvbiAodmFsdWUpCiAgICAgICAgewogICAgICAgICAgICB0YXJnZXQuaGFzRXJyb3JzKCEhKHZhbHVlICYmIHZhbHVlLmxlbmd0aCkpOwogICAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgRXJyb3JDb250YWluZXJCYXNlID0gZnVuY3Rpb24gKHBhcmVudCkKICAgIHsKICAgICAgICB0aGlzLmhhc2ggPSB7CiAgICAgICAgICAgIHN1bW1hcnk6IGtvLm9ic2VydmFibGUoKQogICAgICAgIH07CiAgICAgICAgdGhpcy5oYXNoLnN1bW1hcnkuZXh0ZW5kKHsgZXJyb3JzOiB0cnVlIH0pOwogICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgfTsKCiAgICB2YXIgaGFuZGxlQWRkTWVzc2FnZUFycmF5ID0gZnVuY3Rpb24gKGNvbnRhaW5lciwgcGF0aCwgbWVzc2FnZSwgdHlwZSkKICAgIHsKICAgICAgICBpZiAoaXNBcnJheShtZXNzYWdlKSkKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIHogPSAwLCB6TGVuID0gbWVzc2FnZS5sZW5ndGg7IHogPCB6TGVuOyB6KyspCiAgICAgICAgICAgICAgICB0aGlzLmFkZE1lc3NhZ2UocGF0aCwgbWVzc2FnZVt6XSwgdHlwZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYWRkTWVzc2FnZShwYXRoLCBtZXNzYWdlLCB0eXBlKTsKICAgICAgICB9CiAgICB9OwoKICAgIEVycm9yQ29udGFpbmVyQmFzZS5wcm90b3R5cGUgPSB7CiAgICAgICAgZ2V0UHJvcGVydHk6IGZ1bmN0aW9uIChvYmosIHBhdGgpCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05ZSScpOwogICAgICAgIH0sCiAgICAgICAgc2V0UHJvcGVydHk6IGZ1bmN0aW9uIChvYmosIHBhdGgsIHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOWUknKTsKICAgICAgICB9LAogICAgICAgIGdldFByb3BlcnRpZXM6IGZ1bmN0aW9uKG9iaikKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTllJJyk7CiAgICAgICAgfSwKICAgICAgICBhZGRNZXNzYWdlczogZnVuY3Rpb24gKHByb3BlcnR5UGF0aCwgZXJyb3JzQ29sbGVjdGlvbiwgdHlwZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhwcm9wZXJ0eVBhdGgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBoYW5kbGVBZGRNZXNzYWdlQXJyYXkodGhpcywgcHJvcGVydHlQYXRoLCBlcnJvcnNDb2xsZWN0aW9uLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHR5cGUgPSBlcnJvcnNDb2xsZWN0aW9uOwogICAgICAgICAgICAgICAgZXJyb3JzQ29sbGVjdGlvbiA9IHByb3BlcnR5UGF0aDsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHRoaXMsIGkpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSB0aGlzW2ldLmVycm9yczsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQWRkTWVzc2FnZUFycmF5KHRoaXMsIGksIG1lc3NhZ2UsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2V0RXJyb3JPYnNlcnZhYmxlOiBmdW5jdGlvbiAocHJvcGVydHlQYXRoKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UHJvcGVydHkodGhpcy5oYXNoLCBwcm9wZXJ0eVBhdGgpOwogICAgICAgIH0sCiAgICAgICAgY3JlYXRlRXJyb3JPYnNlcnZhYmxlOiBmdW5jdGlvbiAocHJvcGVydHlQYXRoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIG9ic2VydmFibGVBcnJheSA9IGtvLm9ic2VydmFibGVBcnJheShbXSk7CiAgICAgICAgICAgIHRoaXMuc2V0UHJvcGVydHkodGhpcy5oYXNoLCBwcm9wZXJ0eVBhdGgsIG9ic2VydmFibGVBcnJheSk7CiAgICAgICAgICAgIHJldHVybiBvYnNlcnZhYmxlQXJyYXk7CiAgICAgICAgfSwKICAgICAgICBnZXRPckNyZWF0ZUVycm9yT2JzZXJ2YWJsZTogZnVuY3Rpb24gKHByb3BlcnR5UGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBvYnNlcnZhYmxlQXJyYXkgPSB0aGlzLmdldEVycm9yT2JzZXJ2YWJsZShwcm9wZXJ0eVBhdGgpOwogICAgICAgICAgICBpZiAoIW9ic2VydmFibGVBcnJheSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb2JzZXJ2YWJsZUFycmF5ID0gdGhpcy5jcmVhdGVFcnJvck9ic2VydmFibGUocHJvcGVydHlQYXRoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZUFycmF5OwogICAgICAgIH0sCiAgICAgICAgYWRkTWVzc2FnZTogZnVuY3Rpb24gKHByb3BlcnR5UGF0aCwgbWVzc2FnZSwgdHlwZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciAvLyBOZWVkcyB0byBiZSBjb25maWd1cmFibGUgaW4gdGhlIGNhc2Ugb2YgYSBzaGFyZWQgcHJlZml4IG1vZGVsIGl0ZW0uLi4uPz8KICAgICAgICAgICAgICAgIC8vZXJyb3JzID0gdGhpc1twYXRoXSB8fCB0aGlzW3BhdGggKyB2YWx1ZUtvUGF0aF0sCiAgICAgICAgICAgICAgICBlcnJvcnMgPSB0aGlzLmdldE9yQ3JlYXRlRXJyb3JPYnNlcnZhYmxlKHByb3BlcnR5UGF0aCk7CgogICAgICAgICAgICBpZiAoZXJyb3JzLl9zdWJzY3JpcHRpb25zLmNoYW5nZS5sZW5ndGggPCAyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlQYXRoID09PSAnc3VtbWFyeScpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJlbnQgJiYgdGhpcy5wYXJlbnQuYWRkTWVzc2FnZSgnc3VtbWFyeScsIG1lc3NhZ2UsIHR5cGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkTWVzc2FnZSgnc3VtbWFyeScsIG1lc3NhZ2UsIHR5cGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZXJyb3JzKCkuZXZlcnkoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHgubWVzc2FnZSAhPT0gbWVzc2FnZTsgfSkpCiAgICAgICAgICAgICAgICBlcnJvcnMucHVzaCh7IG1lc3NhZ2U6IG1lc3NhZ2UsIHR5cGU6IHR5cGUgfSk7CiAgICAgICAgfSwKICAgICAgICByZW1vdmVNZXNzYWdlczogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBsaXN0ID0gdGhpcy5nZXRQcm9wZXJ0aWVzKHRoaXMuaGFzaCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gbGlzdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGVycm9ycyA9IGxpc3RbaV07CiAgICAgICAgICAgICAgICBlcnJvcnMgJiYgZXJyb3JzLnNwbGljZSgwLCBlcnJvcnMoKS5sZW5ndGgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZW1vdmVNZXNzYWdlOiBmdW5jdGlvbiAocHJvcGVydHlQYXRoLCBtZXNzYWdlLCB0eXBlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIC8vIE5lZWRzIHRvIGJlIGNvbmZpZ3VyYWJsZSBpbiB0aGUgY2FzZSBvZiBhIHNoYXJlZCBwcmVmaXggbW9kZWwgaXRlbS4uLi4/PwogICAgICAgICAgICAgICAgLy9lcnJvcnMgPSB0aGlzW3BhdGhdIHx8IHRoaXNbcGF0aCArIHZhbHVlS29QYXRoXSwKICAgICAgICAgICAgICAgIGVycm9yc09ic2VydmFibGUgPSB0aGlzLmdldE9yQ3JlYXRlRXJyb3JPYnNlcnZhYmxlKHByb3BlcnR5UGF0aCk7CgogICAgICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gZXJyb3JzT2JzZXJ2YWJsZSgpOwogICAgICAgICAgICBpZiAodW5kZXJseWluZ0FycmF5Lmxlbmd0aCA+IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVuZGVybHlpbmdBcnJheVtpXS5tZXNzYWdlID09PSBtZXNzYWdlIHx8ICghbWVzc2FnZSAmJiB1bmRlcmx5aW5nQXJyYXlbaV0udHlwZSA9PSB0eXBlKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yc09ic2VydmFibGUuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGdldE1lc3NhZ2VzOiBmdW5jdGlvbiAocHJvcGVydHlQYXRoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nZXRFcnJvck9ic2VydmFibGUocHJvcGVydHlQYXRoKTsKICAgICAgICB9CiAgICB9OwoKICAgIEVycm9yQ29udGFpbmVyQmFzZS5leHRlbmQgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQ7CgogICAgcmV0dXJuIEVycm9yQ29udGFpbmVyQmFzZTsKfSk7CmRlZmluZSgna29iLW1vZGVsL3NpbXBsZS9lcnJvcnMnLFsnLi4vZXJyb3JzLmJhc2UnXSwKZnVuY3Rpb24gKEVycm9yQ29udGFpbmVyQmFzZSkKewogICAgdmFyIFNpbXBsZUVycm9yQ29udGFpbmVyID0gRXJyb3JDb250YWluZXJCYXNlLmV4dGVuZCh7CiAgICAgICAgZ2V0UHJvcGVydHk6IGZ1bmN0aW9uIChvYmosIHBhdGgpIHsgcmV0dXJuIG9ialtwYXRoXTsgfSwKICAgICAgICBzZXRQcm9wZXJ0eTogZnVuY3Rpb24gKG9iaiwgcGF0aCwgdmFsdWUpIHsgcmV0dXJuIChvYmpbcGF0aF0gPSB2YWx1ZSk7IH0sCiAgICAgICAgZ2V0UHJvcGVydGllczogZnVuY3Rpb24gKG9iaikgeyByZXR1cm4gb2JqOyB9CiAgICB9KTsKCiAgICByZXR1cm4gU2ltcGxlRXJyb3JDb250YWluZXI7Cn0pOwpkZWZpbmUoJ2tvYi1tb2RlbC9zaW1wbGUvbW9kZWwnLFsKICAgICcuLi9tb2RlbC5iYXNlJywKICAgICcuL3ZpZXdtb2RlbCcsCiAgICAnbG9kYXNoJywKICAgICcuL2Vycm9ycycsCiAgICAnLi4vdXRpbCcKXSwKZnVuY3Rpb24gKEtub2Nrb3V0TW9kZWxCYXNlLCBTaW1wbGVLbm9ja291dFZpZXdNb2RlbCwgXywgRXJyb3JzLCB1dGlsKQp7CiAgICAKCiAgICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICAgIHZhciBTaW1wbGVLbm9ja291dE1vZGVsID0gS25vY2tvdXRNb2RlbEJhc2UuZXh0ZW5kKHsKICAgICAgICBfX2RlZXBDbG9uZTogZnVuY3Rpb24ob2JqKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIF8uY2xvbmUob2JqKTsKICAgICAgICB9LAogICAgICAgIF9fcHJvcGVydHk6CiAgICAgICAgewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChvYmosIHBhdGgpIHsgcmV0dXJuIG9ialtwYXRoXTsgfSwKICAgICAgICAgICAgaGFzOiBmdW5jdGlvbiAob2JqLCBwYXRoKSB7IHJldHVybiAhIW9ialtwYXRoXTsgfSwKICAgICAgICAgICAgZ2V0UGFyZW50OiBmdW5jdGlvbiAob2JqLCBwYXRoKSB7IHJldHVybiBvYmo7IH0sCiAgICAgICAgICAgIGxhc3Q6IGZ1bmN0aW9uIChvYmosIHBhdGgpIHsgcmV0dXJuIHBhdGg7IH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKG9iaiwgcGF0aCwgdmFsdWUpIHsgcmV0dXJuIChvYmpbcGF0aF0gPSB2YWx1ZSk7IH0sCiAgICAgICAgICAgIGRlbDogZnVuY3Rpb24gKG9iaiwgcGF0aCkgeyBkZWxldGUgb2JqW3BhdGhdOyB9LAogICAgICAgICAgICBidWlsZDogZnVuY3Rpb24gKG9iaiwgcGF0aCkgeyByZXR1cm4gb2JqOyB9LAogICAgICAgICAgICBnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbiAob2JqLCBsZWFmcywgcHJlZml4KSB7IHJldHVybiBvYmo7IH0sCiAgICAgICAgICAgIGZpbmRBbGxDaGFuZ2VkUHJvcGVydGllczogdXRpbC5maW5kQWxsQ2hhbmdlZFByb3BlcnRpZXMKICAgICAgICB9LAogICAgICAgIF9fYnVpbGRFcnJvck1lc3NhZ2VzOiBmdW5jdGlvbiAocGFyZW50KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBFcnJvcnMocGFyZW50ICYmIHBhcmVudC5lcnJvck1lc3NhZ2VzKTsKICAgICAgICB9LAogICAgICAgIHZpZXdNb2RlbENvbnN0cnVjdG9yOiBTaW1wbGVLbm9ja291dFZpZXdNb2RlbAogICAgfSk7CgogICAgLy9TaW1wbGVLbm9ja291dE1vZGVsLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFNpbXBsZUtub2Nrb3V0TW9kZWw7CgogICAgcmV0dXJuIFNpbXBsZUtub2Nrb3V0TW9kZWw7Cn0pOwoKZGVmaW5lKCdrb2ItbW9kZWwvc2ltcGxlL21haW4nLFsnLi9tb2RlbCcsICcuL3ZpZXdtb2RlbCddLApmdW5jdGlvbiAoU2ltcGxlS25vY2tvdXRNb2RlbCwgU2ltcGxlS25vY2tvdXRWaWV3TW9kZWwpCnsKICAgIHJldHVybiB7CiAgICAgICAgTW9kZWw6IFNpbXBsZUtub2Nrb3V0TW9kZWwsCiAgICAgICAgVmlld01vZGVsOiBTaW1wbGVLbm9ja291dFZpZXdNb2RlbAogICAgfTsKfSk7CmRlZmluZSgna29iLW1vZGVsL3NpbXBsZScsIFsna29iLW1vZGVsL3NpbXBsZS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgna29iLW1vZGVsL2NvbXBsZXgvcHJvcGVydHkuaGVscGVycycsWydsb2Rhc2gnLCAna25vY2tvdXQnLCAnLi4vdXRpbCddLApmdW5jdGlvbiAoXywga28sIHV0aWwpCnsKICAgIHZhciBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAogICAgICAgIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sCiAgICAgICAgdW53cmFwT2JzZXJ2YWJsZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUsCiAgICAgICAgaXNPYmplY3QgPSBfLmlzT2JqZWN0LAogICAgICAgIGlzQXJyYXkgPSBfLmlzQXJyYXksCiAgICAgICAgcHJvcGVydHlPYmplY3RDYWNoZSA9IHt9LAogICAgICAgIF9fa29QYXRoTWFwID0ge30sCiAgICAgICAgX19wcm9wUGF0aE1hcCA9IHt9LAogICAgICAgIGlzRm9yY2VkT2JqZWN0ID0gdXRpbC5pc0ZvcmNlZE9iamVjdCwKICAgICAgICBzcXVhcmVCcmFja2V0UmVnZXggPSAvXFsoLio/KVxdL2lnLAogICAgICAgIGRvdFJlZ2V4ID0gL1wuL2csCiAgICAgICAgY29tbWFSZWdleCA9IC8sL2csCiAgICAgICAgdW5kZXJzY29yZVJlZ2V4ID0gL18vZywKICAgICAgICBjb21wbGV4UmVwbGFjbWVudE1ldGhvZCA9IGZ1bmN0aW9uIChtLCB2KSB7IHJldHVybiAnLicgKyB2LnJlcGxhY2UoZG90UmVnZXgsICcsJyk7IH0sCiAgICAgICAgZ2V0UGF0aHMgPSBmdW5jdGlvbiAocGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXRocyA9IHBhdGgucmVwbGFjZShzcXVhcmVCcmFja2V0UmVnZXgsIGNvbXBsZXhSZXBsYWNtZW50TWV0aG9kKS5zcGxpdCgnLicpOwogICAgICAgICAgICBpZiAocGF0aHNbMF0gPT0gbnVsbCB8fCBwYXRoc1swXSA9PT0gJycpCiAgICAgICAgICAgICAgICBwYXRocy5zaGlmdCgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IHBhdGhzLmxlbmd0aDsgaSA8IGlMZW4gOyBpKyspCiAgICAgICAgICAgICAgICBwYXRoc1tpXSA9IHBhdGhzW2ldLnJlcGxhY2UoY29tbWFSZWdleCwgJy4nKTsKICAgICAgICAgICAgcmV0dXJuIHBhdGhzOwogICAgICAgIH0sCiAgICAgICAgZ2V0U3RyaWN0UGF0aCA9IGZ1bmN0aW9uIChwYXRocykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAnWycgKyBwYXRocy5qb2luKCddWycpICsgJ10nOwogICAgICAgIH0sCiAgICAgICAgZ2V0UGF0aEFuZERyb3AgPSBmdW5jdGlvbiAocGF0aCwgZHJvcCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZHJvcCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgICAgICBkcm9wID0gMTsKCiAgICAgICAgICAgIHZhciBwYXRocyA9IGdldFBhdGhzKHBhdGgpOwogICAgICAgICAgICBwYXRocyA9IHBhdGhzLnNsaWNlKDAsIC0oZHJvcCkpOwoKICAgICAgICAgICAgcmV0dXJuIGdldFN0cmljdFBhdGgocGF0aHMpOwogICAgICAgIH07CgogICAgdmFyIG5hdmlnYXRlT2JqZWN0ID0gZnVuY3Rpb24gKG9iaiwgcGF0aCkKICAgIHsKICAgICAgICB2YXIgcGF0aHMgPSBnZXRQYXRocyhwYXRoKSwgbWF0Y2ggPSBmYWxzZSwKICAgICAgICAgICAgcGF0aE1hdGNoID0gJyc7CgogICAgICAgIHdoaWxlIChvYmogJiYgKHBhdGggPSBwYXRocy5zaGlmdCgpKSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChwYXRoIGluIG9iaiAmJiAoKG1hdGNoID0gdHJ1ZSkpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvYmogPSBvYmpbcGF0aF07CiAgICAgICAgICAgICAgICBwYXRoTWF0Y2ggPSBwYXRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKCghKG1hdGNoID0gZmFsc2UpKSAmJiBwYXRocy5sZW5ndGggPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwYXRocy51bnNoaWZ0KHBhdGggKyAnLicgKyBwYXRocy5zaGlmdCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChwYXRocy5sZW5ndGggPT09IDAgJiYgbWF0Y2ggPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwYXRoTWF0Y2ggPSBwYXRoOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4geyBtYXRjaDogbWF0Y2gsIG9iajogb2JqLCBwYXRoTWF0Y2g6IHBhdGhNYXRjaCB9OwogICAgfTsKCiAgICB2YXIgcHJvcGVydHkgPSB7CiAgICAgICAgbmF2aWdhdGVPYmplY3Q6IG5hdmlnYXRlT2JqZWN0LAogICAgICAgIGdldFBhdGhzOiBnZXRQYXRocywKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChvYmosIHBhdGgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gbmF2aWdhdGVPYmplY3Qob2JqLCBwYXRoKTsKCiAgICAgICAgICAgIHJldHVybiAocmVzdWx0Lm1hdGNoID8gcmVzdWx0Lm9iaiA6IGZhbHNlKTsKICAgICAgICB9LAogICAgICAgIGhhczogZnVuY3Rpb24gKG9iaiwgcGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBuYXZpZ2F0ZU9iamVjdChvYmosIHBhdGgpOwoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5tYXRjaDsKICAgICAgICB9LAogICAgICAgIGdldFBhcmVudDogZnVuY3Rpb24gKG9iaiwgcGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXRoID0gZ2V0UGF0aEFuZERyb3AocGF0aCwgMSk7CgogICAgICAgICAgICB2YXIgcmVzdWx0ID0gbmF2aWdhdGVPYmplY3Qob2JqLCBwYXRoKTsKCiAgICAgICAgICAgIHJldHVybiByZXN1bHQub2JqOwogICAgICAgIH0sCiAgICAgICAgbGFzdDogZnVuY3Rpb24gKG9iaiwgcGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBuYXZpZ2F0ZU9iamVjdChvYmosIHBhdGgpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0LnBhdGhNYXRjaDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gKG9iaiwgcGF0aCwgdmFsdWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJ1aWxkKG9iaiwgcGF0aClbdGhpcy5sYXN0KG9iaiwgcGF0aCldID0gdmFsdWU7CiAgICAgICAgfSwKICAgICAgICBkZWw6IGZ1bmN0aW9uKG9iaiwgcGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmJ1aWxkKG9iaiwgcGF0aClbdGhpcy5sYXN0KG9iaiwgcGF0aCldOwogICAgICAgIH0sCiAgICAgICAgLypjb3B5OiBmdW5jdGlvbiAoZnJvbSwgdG8sIHBhdGgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNldCh0bywgcGF0aCwgdGhpcy5nZXQoZnJvbSwgcGF0aCkpOwogICAgICAgIH0sKi8KICAgICAgICBidWlsZDogZnVuY3Rpb24gKG9iaiwgcGF0aCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXRocyA9IGdldFBhdGhzKGdldFBhdGhBbmREcm9wKHBhdGgsIDEpKTsKCiAgICAgICAgICAgIGlmICghdGhpcy5oYXMob2JqLCBwYXRoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2hpbGUgKHBhdGggPSBwYXRocy5zaGlmdCgpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICghb2JqW3BhdGhdKQogICAgICAgICAgICAgICAgICAgICAgICBvYmpbcGF0aF0gPSB7fTsKICAgICAgICAgICAgICAgICAgICBvYmogPSBvYmpbcGF0aF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UGFyZW50KG9iaiwgcGF0aCk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CiAgICAgICAgfSwKICAgICAgICBnZXRBbGxMZWFmczogZnVuY3Rpb24gKG9iaiwgbGVhZnMsIHByZWZpeCkKICAgICAgICB7CiAgICAgICAgICAgIGxlYWZzID0gbGVhZnMgfHwge307CiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gb2JqKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgbyA9IHVud3JhcE9ic2VydmFibGUob2JqW2ldKSwgcCA9IGk7CgogICAgICAgICAgICAgICAgaWYgKGkuaW5kZXhPZignLicpID4gLTEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcCA9IChwcmVmaXggfHwgJycpICsgJ1snICsgaSArICddJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBwID0gcHJlZml4ID8gcHJlZml4ICsgJy4nICsgaSA6IGk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGlzRm9yY2VkT2JqZWN0KGkpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICghbGVhZnNbcHJlZml4XSkKICAgICAgICAgICAgICAgICAgICAgICAgbGVhZnNbcHJlZml4XSA9IHt9OwogICAgICAgICAgICAgICAgICAgIGxlYWZzW3ByZWZpeF1baV0gPSB0aGlzLmdldEFsbExlYWZzKG8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoIWlzQXJyYXkobykgJiYgaXNPYmplY3QobykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRBbGxMZWFmcyhvLCBsZWFmcywgcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChpc0FycmF5KG8pKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGxlYWZzW3BdID0gbzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBsZWFmc1twXSA9IG87CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlYWZzOwogICAgICAgIH0sCiAgICAgICAgZmluZEFsbENoYW5nZWRQcm9wZXJ0aWVzOiB1dGlsLmZpbmRBbGxDaGFuZ2VkUHJvcGVydGllcwogICAgfTsKCiAgICByZXR1cm4gcHJvcGVydHk7Cn0pOwpkZWZpbmUoJ2tvYi1tb2RlbC9jb21wbGV4L3ZpZXdtb2RlbCcsWycuLi92aWV3bW9kZWwuYmFzZScsICcuL3Byb3BlcnR5LmhlbHBlcnMnXSwKZnVuY3Rpb24gKEtub2Nrb3V0Vmlld01vZGVsQmFzZSwgcHJvcGVydHlIZWxwZXJzKQp7CiAgICB2YXIgQ29tcGxleEtub2Nrb3V0Vmlld01vZGVsID0gS25vY2tvdXRWaWV3TW9kZWxCYXNlLmV4dGVuZCh7CiAgICAgICAgZ2V0UHJvcGVydGllczogZnVuY3Rpb24gKGF0dHJzKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHByb3BlcnR5SGVscGVycy5nZXRBbGxMZWFmcyhhdHRycyk7CiAgICAgICAgfQogICAgfSk7CiAgICBDb21wbGV4S25vY2tvdXRWaWV3TW9kZWwucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29tcGxleEtub2Nrb3V0Vmlld01vZGVsOwoKICAgIHJldHVybiBDb21wbGV4S25vY2tvdXRWaWV3TW9kZWw7Cn0pOwoKZGVmaW5lKCdrb2ItbW9kZWwvY29tcGxleC9lcnJvcnMnLFsnLi4vZXJyb3JzLmJhc2UnLCAnLi9wcm9wZXJ0eS5oZWxwZXJzJ10sCmZ1bmN0aW9uIChFcnJvckNvbnRhaW5lckJhc2UsIHByb3BlcnR5SGVscGVycykKewogICAgdmFyIENvbXBsZXhFcnJvckNvbnRhaW5lciA9IEVycm9yQ29udGFpbmVyQmFzZS5leHRlbmQoewogICAgICAgIGdldFByb3BlcnR5OiBwcm9wZXJ0eUhlbHBlcnMuZ2V0LAogICAgICAgIHNldFByb3BlcnR5OiBwcm9wZXJ0eUhlbHBlcnMuc2V0LAogICAgICAgIGdldFByb3BlcnRpZXM6IHByb3BlcnR5SGVscGVycy5nZXRBbGxMZWFmcwogICAgfSk7CgogICAgcmV0dXJuIENvbXBsZXhFcnJvckNvbnRhaW5lcjsKfSk7CmRlZmluZSgna29iLW1vZGVsL2NvbXBsZXgvbW9kZWwnLFsKICAgICcuLi9tb2RlbC5iYXNlJywKICAgICcuL3Byb3BlcnR5LmhlbHBlcnMnLAogICAgJy4vdmlld21vZGVsJywKICAgICdsb2Rhc2gnLAogICAgJy4vZXJyb3JzJywKICAgICcuLi91dGlsJwpdLApmdW5jdGlvbiAoS25vY2tvdXRNb2RlbEJhc2UsIHByb3BlcnR5SGVscGVycywgQ29tcGxleEtub2Nrb3V0Vmlld01vZGVsLCBfLCBFcnJvcnMsIHV0aWwpCnsKICAgIAoKICAgIHZhciBkZWVwQ2xvbmUgPSB1dGlsLmRlZXBDbG9uZTsKICAgIAogICAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuCiAgICB2YXIgQ29tcGxleEtub2Nrb3V0TW9kZWwgPSBLbm9ja291dE1vZGVsQmFzZS5leHRlbmQoewogICAgICAgIF9fZGVlcENsb25lOiBmdW5jdGlvbihvYmopCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVlcENsb25lKG9iaik7CiAgICAgICAgfSwKICAgICAgICBfX3Byb3BlcnR5OgogICAgICAgIHsKICAgICAgICAgICAgZ2V0OiBwcm9wZXJ0eUhlbHBlcnMuZ2V0LAogICAgICAgICAgICBoYXM6IHByb3BlcnR5SGVscGVycy5oYXMsCiAgICAgICAgICAgIGdldFBhcmVudDogcHJvcGVydHlIZWxwZXJzLmdldFBhcmVudCwKICAgICAgICAgICAgbGFzdDogcHJvcGVydHlIZWxwZXJzLmxhc3QsCiAgICAgICAgICAgIHNldDogcHJvcGVydHlIZWxwZXJzLnNldCwKICAgICAgICAgICAgZGVsOiBwcm9wZXJ0eUhlbHBlcnMuZGVsLAogICAgICAgICAgICBidWlsZDogcHJvcGVydHlIZWxwZXJzLmJ1aWxkLAogICAgICAgICAgICBnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbiAoKSB7IHJldHVybiBwcm9wZXJ0eUhlbHBlcnMuZ2V0QWxsTGVhZnMuYXBwbHkocHJvcGVydHlIZWxwZXJzLCBhcmd1bWVudHMpOyB9LAogICAgICAgICAgICBmaW5kQWxsQ2hhbmdlZFByb3BlcnRpZXM6IHByb3BlcnR5SGVscGVycy5maW5kQWxsQ2hhbmdlZFByb3BlcnRpZXMKICAgICAgICB9LAogICAgICAgIF9fYnVpbGRFcnJvck1lc3NhZ2VzOiBmdW5jdGlvbiAocGFyZW50KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBFcnJvcnMocGFyZW50ICYmIHBhcmVudC5lcnJvck1lc3NhZ2VzKTsKICAgICAgICB9LAogICAgICAgIHZpZXdNb2RlbENvbnN0cnVjdG9yOiBDb21wbGV4S25vY2tvdXRWaWV3TW9kZWwKICAgIH0pOwoKICAgIC8vQ29tcGxleEtub2Nrb3V0TW9kZWwucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29tcGxleEtub2Nrb3V0TW9kZWw7CgogICAgcmV0dXJuIENvbXBsZXhLbm9ja291dE1vZGVsOwp9KTsKCmRlZmluZSgna29iLW1vZGVsL2NvbXBsZXgvbWFpbicsWycuL21vZGVsJywgJy4vdmlld21vZGVsJ10sCmZ1bmN0aW9uIChDb21wbGV4S25vY2tvdXRNb2RlbCwgQ29tcGxleEtub2Nrb3V0Vmlld01vZGVsKQp7CiAgICByZXR1cm4gewogICAgICAgIE1vZGVsOiBDb21wbGV4S25vY2tvdXRNb2RlbCwKICAgICAgICBWaWV3TW9kZWw6IENvbXBsZXhLbm9ja291dFZpZXdNb2RlbAogICAgfTsKfSk7CmRlZmluZSgna29iLW1vZGVsL2NvbXBsZXgnLCBbJ2tvYi1tb2RlbC9jb21wbGV4L21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCdrb2ItbW9kZWwvbWFpbicsWydrb2ItbW9kZWwvc2ltcGxlJywgJ2tvYi1tb2RlbC9jb21wbGV4J10sCmZ1bmN0aW9uIChTaW1wbGUsIENvbXBsZXgpCnsKICAgIHJldHVybiB7CiAgICAgICAgU2ltcGxlS25vY2tvdXRNb2RlbDogU2ltcGxlLk1vZGVsLAogICAgICAgIENvbXBsZXhLbm9ja291dE1vZGVsOiBDb21wbGV4Lk1vZGVsLAogICAgICAgIFNpbXBsZUtub2Nrb3V0Vmlld01vZGVsOiBTaW1wbGUuVmlld01vZGVsLAogICAgICAgIENvbXBsZXhLbm9ja291dFZpZXdNb2RlbDogQ29tcGxleC5WaWV3TW9kZWwKICAgIH07Cn0pOwpkZWZpbmUoJ2tvYi1tb2RlbCcsIFsna29iLW1vZGVsL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCdhY2NvdW50LmNvbnRyb2xzL2FjY291bnQuY29udHJvbHMnLFsna29iLW1vZGVsJywgJ3RocnVzdC91dGlsJ10sCmZ1bmN0aW9uKEtub2Nrb3V0QmFja2JvbmUsIHV0aWwpCnsKICAgIHZhciBhY2NvdW50RGF0YVByb21pc2UsCiAgICAgICAgd2hlbiA9IHV0aWwud2hlbjsKCiAgICByZXR1cm4gewogICAgICAgIHRlbXBsYXRlczogWwogICAgICAgICAgICAnYWN0aW9ubGluaycsCiAgICAgICAgICAgICdhY2NvdW50LmNvbnRyb2xzL2FjY291bnQuY29udHJvbHMnCiAgICAgICAgXSwKICAgICAgICBjb250ZXh0OiAnI3VzZXItY29udHJvbHMnLAogICAgICAgIGF1dG9TdGFydDogdHJ1ZSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgLy8gR2V0IG91ciBkYXRhIGZyb20gdGhlIHNlcnZlciBvciBzZXJ2aWNlLgogICAgICAgICAgICBhY2NvdW50RGF0YVByb21pc2UgPSB0aGlzLmRhdGEuZ2V0KCdhY2NvdW50LmNvbnRyb2xzL2FjY291bnQuY29udHJvbHMuanNvbicpCiAgICAgICAgICAgICAgICAudGhlbih3aGVuLmFwcGx5KHRoaXMuYnVpbGRNb2RlbC5iaW5kKHRoaXMpKSk7CiAgICAgICAgfSwKICAgICAgICBidWlsZE1vZGVsOiBmdW5jdGlvbihkYXRhKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb2RlbCA9IG5ldyBLbm9ja291dEJhY2tib25lLlNpbXBsZUtub2Nrb3V0TW9kZWwoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiB1dGlsLm5vb3AsCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLiQoKS5hZGRDbGFzcygnYnRuLWdyb3VwIHB1bGwtcmlnaHQnKTsKICAgICAgICAgICAgdGhpcy4kKCkuaHRtbCh0aGlzLnRlbXBsYXRlc1snYWNjb3VudC5jb250cm9scy9hY2NvdW50LmNvbnRyb2xzJ10oKSk7CiAgICAgICAgICAgIC8vIEhvbGQgcmVhZHkgdW50aWwgb3VyIGRhdGEgY29tZXMgYmFjay4KICAgICAgICAgICAgcmV0dXJuIGFjY291bnREYXRhUHJvbWlzZS50aGVuKHRoaXMuYXBwbHlCaW5kaW5ncy5iaW5kKHRoaXMpKTsKICAgICAgICB9LAogICAgICAgIGFwcGx5QmluZGluZ3M6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm1vZGVsLmdldFZpZXdNb2RlbCgpLmFwcGx5QmluZGluZ3ModGhpcy4kKClbMF0pOwogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgfQogICAgfTsKfSk7CmRlZmluZSgnbWVudS9tZW51JyxbJ2tvYi1tb2RlbCcsICd0aHJ1c3QvdXRpbCddLApmdW5jdGlvbiAoS25vY2tvdXRCYWNrYm9uZSwgdXRpbCkKewogICAgdmFyIG1lbnVEYXRhUHJvbWlzZSwKICAgICAgICBtZW51UmVhZHlQcm9taXNlLAogICAgICAgIHdoZW4gPSB1dGlsLndoZW47CgogICAgcmV0dXJuIHsKICAgICAgICB0ZW1wbGF0ZXM6IFsKICAgICAgICAgICAgJ2FjdGlvbmxpbmsnLAogICAgICAgICAgICAnbWVudS9tZW51JwogICAgICAgIF0sCiAgICAgICAgY29udGV4dDogJyNtYWluLW1lbnUnLAogICAgICAgIGF1dG9TdGFydDogdHJ1ZSwKICAgICAgICBzdWJzY3JpcHRpb25zOiB7CiAgICAgICAgICAgICd0aHJ1c3Qvc3BhL3JvdXRlL3J1bic6IGZ1bmN0aW9uIChyZXF1ZXN0LCByb3V0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgbWVudVJlYWR5UHJvbWlzZS50aGVuKGZ1bmN0aW9uICgpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC4kKCkuJCgndWwnKQogICAgICAgICAgICAgICAgICAgICAgICAuY2hpbGRyZW4oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCdhY3RpdmUnKQogICAgICAgICAgICAgICAgICAgICAgICAuZmluZCgnW2hyZWYkPSInICsgcmVxdWVzdC5wYXJhbXMucGF0aCArICciXScpCiAgICAgICAgICAgICAgICAgICAgICAgIC5wYXJlbnQoKS5hZGRDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgaW5pdDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIEdldCBvdXIgZGF0YSBmcm9tIHRoZSBzZXJ2ZXIgb3Igc2VydmljZS4KICAgICAgICAgICAgbWVudURhdGFQcm9taXNlID0gdGhpcy5kYXRhLmdldCgnbWVudS9tZW51Lmpzb24nKQogICAgICAgICAgICAgICAgLnRoZW4od2hlbi5hcHBseSh0aGlzLmJ1aWxkTW9kZWwuYmluZCh0aGlzKSkpOwogICAgICAgIH0sCiAgICAgICAgYnVpbGRNb2RlbDogZnVuY3Rpb24gKGRhdGEpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm1vZGVsID0gbmV3IEtub2Nrb3V0QmFja2JvbmUuU2ltcGxlS25vY2tvdXRNb2RlbChkYXRhKTsKICAgICAgICB9LAogICAgICAgIGRlc3Ryb3k6IHV0aWwubm9vcCwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIG1lbnVSZWFkeVByb21pc2UgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuJCgpLmFkZENsYXNzKCduYXYtY29sbGFwc2UnKTsKICAgICAgICAgICAgdGhpcy4kKCkuaHRtbCh0aGlzLnRlbXBsYXRlc1snbWVudS9tZW51J10oKSk7CiAgICAgICAgICAgIC8vIEhvbGQgcmVhZHkgdW50aWwgb3VyIGRhdGEgY29tZXMgYmFjay4KICAgICAgICAgICAgcmV0dXJuIG1lbnVEYXRhUHJvbWlzZS50aGVuKHRoaXMuYXBwbHlCaW5kaW5ncy5iaW5kKHRoaXMpKTsKICAgICAgICB9LAogICAgICAgIGFwcGx5QmluZGluZ3M6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm1vZGVsLmdldFZpZXdNb2RlbCgpLmFwcGx5QmluZGluZ3ModGhpcy4kKClbMF0pOwoKICAgICAgICAgICAgbWVudVJlYWR5UHJvbWlzZS5yZXNvbHZlKCk7CiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICB9CiAgICB9Owp9KTsKLy8vIDxyZWZlcmVuY2UgcGF0aD0ic2lkZS5qcyIgLz4KZGVmaW5lKCdtZW51L3NpZGUnLFsna29iLW1vZGVsJywgJ3RocnVzdC91dGlsJ10sCmZ1bmN0aW9uIChLbm9ja291dEJhY2tib25lLCB1dGlsKQp7CiAgICB2YXIgbWVudURhdGFQcm9taXNlLAogICAgICAgIG1lbnVSZWFkeVByb21pc2UsCiAgICAgICAgd2hlbiA9IHV0aWwud2hlbjsKCiAgICByZXR1cm4gewogICAgICAgIHRlbXBsYXRlczogWwogICAgICAgICAgICAnYWN0aW9ubGluaycsCiAgICAgICAgICAgICdtZW51L3NpZGUnLAogICAgICAgICAgICAnbWVudS9zaWRlLmhlYWRlcicKICAgICAgICBdLAogICAgICAgIGNvbnRleHQ6ICcjc2lkZS1tZW51JywKICAgICAgICBhdXRvU3RhcnQ6IHRydWUsCiAgICAgICAgaW5pdDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIEdldCBvdXIgZGF0YSBmcm9tIHRoZSBzZXJ2ZXIgb3Igc2VydmljZS4KICAgICAgICAgICAgbWVudURhdGFQcm9taXNlID0gdGhpcy5kYXRhLmdldCgnbWVudS9zaWRlLmpzb24nKQogICAgICAgICAgICAgICAgLnRoZW4od2hlbi5hcHBseSh0aGlzLmJ1aWxkTW9kZWwuYmluZCh0aGlzKSkpOwogICAgICAgIH0sCiAgICAgICAgYnVpbGRNb2RlbDogZnVuY3Rpb24gKGRhdGEpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm1vZGVsID0gbmV3IEtub2Nrb3V0QmFja2JvbmUuU2ltcGxlS25vY2tvdXRNb2RlbChkYXRhKTsKICAgICAgICB9LAogICAgICAgIGRlc3Ryb3k6IHV0aWwubm9vcCwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIG1lbnVSZWFkeVByb21pc2UgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuJCgpLmFkZENsYXNzKCduYXYtY29sbGFwc2UnKTsKICAgICAgICAgICAgdGhpcy4kKCkuaHRtbCh0aGlzLnRlbXBsYXRlc1snbWVudS9zaWRlJ10oKSk7CiAgICAgICAgICAgIC8vIEhvbGQgcmVhZHkgdW50aWwgb3VyIGRhdGEgY29tZXMgYmFjay4KICAgICAgICAgICAgcmV0dXJuIG1lbnVEYXRhUHJvbWlzZS50aGVuKHRoaXMuYXBwbHlCaW5kaW5ncy5iaW5kKHRoaXMpKTsKICAgICAgICB9LAogICAgICAgIGFwcGx5QmluZGluZ3M6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm1vZGVsLmdldFZpZXdNb2RlbCgpLmFwcGx5QmluZGluZ3ModGhpcy4kKClbMF0pOwoKICAgICAgICAgICAgbWVudVJlYWR5UHJvbWlzZS5yZXNvbHZlKCk7CiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICB9CiAgICB9Owp9KTsKZGVmaW5lKCdyZWFkeScsWyd0aHJ1c3QvdXRpbCddLApmdW5jdGlvbiAodXRpbCkKewogICAgcmV0dXJuIHsKICAgICAgICBzdWJzY3JpcHRpb25zOiB7CiAgICAgICAgICAgICd0aHJ1c3QvcmVhZHknOiBmdW5jdGlvbiAoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGF0LiQoKS5yZW1vdmVDbGFzcygnbG9hZGluZycpOwogICAgICAgICAgICB9LAogICAgICAgIH0sCiAgICAgICAgY29udGV4dDogJ2JvZHknLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7IH0sCiAgICAgICAgYXV0b1N0YXJ0OiB0cnVlCiAgICB9Owp9KTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 20:05:27 GMT",
                    "Content-Length": "1007549",
                    "Date": "Sat, 08 Nov 2014 20:05:28 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}