{
    "url": "http://localhost:9999/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc3/thorax.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc3/thorax.js",
                "path": "/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc3/thorax.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9vaWVkdWFyZG9yYWJlbG8vc2F3cGYvc3JjL2pzL3Rob3JheC8yLjAuMHJjMy90aG9yYXguanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTMxMDE3DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDAzOjU1OjM2IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAwMzo1NDo1OSBHTVQNCg0KLyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuOS4wCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMDUsIDIwMTIgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDEzLTEtMTQKICovCihmdW5jdGlvbiggd2luZG93LCB1bmRlZmluZWQgKSB7CiJ1c2Ugc3RyaWN0IjsKdmFyCiAgLy8gQSBjZW50cmFsIHJlZmVyZW5jZSB0byB0aGUgcm9vdCBqUXVlcnkoZG9jdW1lbnQpCiAgcm9vdGpRdWVyeSwKCiAgLy8gVGhlIGRlZmVycmVkIHVzZWQgb24gRE9NIHJlYWR5CiAgcmVhZHlMaXN0LAoKICAvLyBVc2UgdGhlIGNvcnJlY3QgZG9jdW1lbnQgYWNjb3JkaW5nbHkgd2l0aCB3aW5kb3cgYXJndW1lbnQgKHNhbmRib3gpCiAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCgogIC8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQogIF9qUXVlcnkgPSB3aW5kb3cualF1ZXJ5LAoKICAvLyBNYXAgb3ZlciB0aGUgJCBpbiBjYXNlIG9mIG92ZXJ3cml0ZQogIF8kID0gd2luZG93LiQsCgogIC8vIFtbQ2xhc3NdXSAtPiB0eXBlIHBhaXJzCiAgY2xhc3MydHlwZSA9IHt9LAoKICAvLyBMaXN0IG9mIGRlbGV0ZWQgZGF0YSBjYWNoZSBpZHMsIHNvIHdlIGNhbiByZXVzZSB0aGVtCiAgY29yZV9kZWxldGVkSWRzID0gW10sCgogIGNvcmVfdmVyc2lvbiA9ICIxLjkuMCIsCgogIC8vIFNhdmUgYSByZWZlcmVuY2UgdG8gc29tZSBjb3JlIG1ldGhvZHMKICBjb3JlX2NvbmNhdCA9IGNvcmVfZGVsZXRlZElkcy5jb25jYXQsCiAgY29yZV9wdXNoID0gY29yZV9kZWxldGVkSWRzLnB1c2gsCiAgY29yZV9zbGljZSA9IGNvcmVfZGVsZXRlZElkcy5zbGljZSwKICBjb3JlX2luZGV4T2YgPSBjb3JlX2RlbGV0ZWRJZHMuaW5kZXhPZiwKICBjb3JlX3RvU3RyaW5nID0gY2xhc3MydHlwZS50b1N0cmluZywKICBjb3JlX2hhc093biA9IGNsYXNzMnR5cGUuaGFzT3duUHJvcGVydHksCiAgY29yZV90cmltID0gY29yZV92ZXJzaW9uLnRyaW0sCgogIC8vIERlZmluZSBhIGxvY2FsIGNvcHkgb2YgalF1ZXJ5CiAgalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewogICAgLy8gVGhlIGpRdWVyeSBvYmplY3QgaXMgYWN0dWFsbHkganVzdCB0aGUgaW5pdCBjb25zdHJ1Y3RvciAnZW5oYW5jZWQnCiAgICByZXR1cm4gbmV3IGpRdWVyeS5mbi5pbml0KCBzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeSApOwogIH0sCgogIC8vIFVzZWQgZm9yIG1hdGNoaW5nIG51bWJlcnMKICBjb3JlX3BudW0gPSAvWystXT8oPzpcZCpcLnwpXGQrKD86W2VFXVsrLV0/XGQrfCkvLnNvdXJjZSwKCiAgLy8gVXNlZCBmb3Igc3BsaXR0aW5nIG9uIHdoaXRlc3BhY2UKICBjb3JlX3Jub3R3aGl0ZSA9IC9cUysvZywKCiAgLy8gTWFrZSBzdXJlIHdlIHRyaW0gQk9NIGFuZCBOQlNQIChoZXJlJ3MgbG9va2luZyBhdCB5b3UsIFNhZmFyaSA1LjAgYW5kIElFKQogIHJ0cmltID0gL15bXHNcdUZFRkZceEEwXSt8W1xzXHVGRUZGXHhBMF0rJC9nLAoKICAvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncwogIC8vIFByaW9yaXRpemUgI2lkIG92ZXIgPHRhZz4gdG8gYXZvaWQgWFNTIHZpYSBsb2NhdGlvbi5oYXNoICgjOTUyMSkKICAvLyBTdHJpY3QgSFRNTCByZWNvZ25pdGlvbiAoIzExMjkwOiBtdXN0IHN0YXJ0IHdpdGggPCkKICBycXVpY2tFeHByID0gL14oPzooPFtcd1xXXSs+KVtePl0qfCMoW1x3LV0qKSkkLywKCiAgLy8gTWF0Y2ggYSBzdGFuZGFsb25lIHRhZwogIHJzaW5nbGVUYWcgPSAvXjwoXHcrKVxzKlwvPz4oPzo8XC9cMT58KSQvLAoKICAvLyBKU09OIFJlZ0V4cAogIHJ2YWxpZGNoYXJzID0gL15bXF0sOnt9XHNdKiQvLAogIHJ2YWxpZGJyYWNlcyA9IC8oPzpefDp8LCkoPzpccypcWykrL2csCiAgcnZhbGlkZXNjYXBlID0gL1xcKD86WyJcXFwvYmZucnRdfHVbXGRhLWZBLUZdezR9KS9nLAogIHJ2YWxpZHRva2VucyA9IC8iW14iXFxcclxuXSoifHRydWV8ZmFsc2V8bnVsbHwtPyg/OlxkK1wufClcZCsoPzpbZUVdWystXT9cZCt8KS9nLAoKICAvLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKICBybXNQcmVmaXggPSAvXi1tcy0vLAogIHJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwKCiAgLy8gVXNlZCBieSBqUXVlcnkuY2FtZWxDYXNlIGFzIGNhbGxiYWNrIHRvIHJlcGxhY2UoKQogIGZjYW1lbENhc2UgPSBmdW5jdGlvbiggYWxsLCBsZXR0ZXIgKSB7CiAgICByZXR1cm4gbGV0dGVyLnRvVXBwZXJDYXNlKCk7CiAgfSwKCiAgLy8gVGhlIHJlYWR5IGV2ZW50IGhhbmRsZXIgYW5kIHNlbGYgY2xlYW51cCBtZXRob2QKICBET01Db250ZW50TG9hZGVkID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgKSB7CiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiwgRE9NQ29udGVudExvYWRlZCwgZmFsc2UgKTsKICAgICAgalF1ZXJ5LnJlYWR5KCk7CiAgICB9IGVsc2UgaWYgKCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewogICAgICAvLyB3ZSdyZSBoZXJlIGJlY2F1c2UgcmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiBpbiBvbGRJRQogICAgICAvLyB3aGljaCBpcyBnb29kIGVub3VnaCBmb3IgdXMgdG8gY2FsbCB0aGUgZG9tIHJlYWR5IQogICAgICBkb2N1bWVudC5kZXRhY2hFdmVudCggIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIERPTUNvbnRlbnRMb2FkZWQgKTsKICAgICAgalF1ZXJ5LnJlYWR5KCk7CiAgICB9CiAgfTsKCmpRdWVyeS5mbiA9IGpRdWVyeS5wcm90b3R5cGUgPSB7CiAgLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBqUXVlcnkgYmVpbmcgdXNlZAogIGpxdWVyeTogY29yZV92ZXJzaW9uLAoKICBjb25zdHJ1Y3RvcjogalF1ZXJ5LAogIGluaXQ6IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeSApIHsKICAgIHZhciBtYXRjaCwgZWxlbTsKCiAgICAvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCiAgICBpZiAoICFzZWxlY3RvciApIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLy8gSGFuZGxlIEhUTUwgc3RyaW5ncwogICAgaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewogICAgICBpZiAoIHNlbGVjdG9yLmNoYXJBdCgwKSA9PT0gIjwiICYmIHNlbGVjdG9yLmNoYXJBdCggc2VsZWN0b3IubGVuZ3RoIC0gMSApID09PSAiPiIgJiYgc2VsZWN0b3IubGVuZ3RoID49IDMgKSB7CiAgICAgICAgLy8gQXNzdW1lIHRoYXQgc3RyaW5ncyB0aGF0IHN0YXJ0IGFuZCBlbmQgd2l0aCA8PiBhcmUgSFRNTCBhbmQgc2tpcCB0aGUgcmVnZXggY2hlY2sKICAgICAgICBtYXRjaCA9IFsgbnVsbCwgc2VsZWN0b3IsIG51bGwgXTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoIHNlbGVjdG9yICk7CiAgICAgIH0KCiAgICAgIC8vIE1hdGNoIGh0bWwgb3IgbWFrZSBzdXJlIG5vIGNvbnRleHQgaXMgc3BlY2lmaWVkIGZvciAjaWQKICAgICAgaWYgKCBtYXRjaCAmJiAobWF0Y2hbMV0gfHwgIWNvbnRleHQpICkgewoKICAgICAgICAvLyBIQU5ETEU6ICQoaHRtbCkgLT4gJChhcnJheSkKICAgICAgICBpZiAoIG1hdGNoWzFdICkgewogICAgICAgICAgY29udGV4dCA9IGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgPyBjb250ZXh0WzBdIDogY29udGV4dDsKCiAgICAgICAgICAvLyBzY3JpcHRzIGlzIHRydWUgZm9yIGJhY2stY29tcGF0CiAgICAgICAgICBqUXVlcnkubWVyZ2UoIHRoaXMsIGpRdWVyeS5wYXJzZUhUTUwoCiAgICAgICAgICAgIG1hdGNoWzFdLAogICAgICAgICAgICBjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IGRvY3VtZW50LAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApICk7CgogICAgICAgICAgLy8gSEFORExFOiAkKGh0bWwsIHByb3BzKQogICAgICAgICAgaWYgKCByc2luZ2xlVGFnLnRlc3QoIG1hdGNoWzFdICkgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3QoIGNvbnRleHQgKSApIHsKICAgICAgICAgICAgZm9yICggbWF0Y2ggaW4gY29udGV4dCApIHsKICAgICAgICAgICAgICAvLyBQcm9wZXJ0aWVzIG9mIGNvbnRleHQgYXJlIGNhbGxlZCBhcyBtZXRob2RzIGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdGhpc1sgbWF0Y2ggXSApICkgewogICAgICAgICAgICAgICAgdGhpc1sgbWF0Y2ggXSggY29udGV4dFsgbWF0Y2ggXSApOwoKICAgICAgICAgICAgICAvLyAuLi5hbmQgb3RoZXJ3aXNlIHNldCBhcyBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYXR0ciggbWF0Y2gsIGNvbnRleHRbIG1hdGNoIF0gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdGhpczsKCiAgICAgICAgLy8gSEFORExFOiAkKCNpZCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFsyXSApOwoKICAgICAgICAgIC8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCiAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgICBpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewogICAgICAgICAgICAvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUgYW5kIE9wZXJhIHJldHVybiBpdGVtcwogICAgICAgICAgICAvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKICAgICAgICAgICAgaWYgKCBlbGVtLmlkICE9PSBtYXRjaFsyXSApIHsKICAgICAgICAgICAgICByZXR1cm4gcm9vdGpRdWVyeS5maW5kKCBzZWxlY3RvciApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UsIHdlIGluamVjdCB0aGUgZWxlbWVudCBkaXJlY3RseSBpbnRvIHRoZSBqUXVlcnkgb2JqZWN0CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMTsKICAgICAgICAgICAgdGhpc1swXSA9IGVsZW07CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CiAgICAgICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAvLyBIQU5ETEU6ICQoZXhwciwgJCguLi4pKQogICAgICB9IGVsc2UgaWYgKCAhY29udGV4dCB8fCBjb250ZXh0LmpxdWVyeSApIHsKICAgICAgICByZXR1cm4gKCBjb250ZXh0IHx8IHJvb3RqUXVlcnkgKS5maW5kKCBzZWxlY3RvciApOwoKICAgICAgLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpCiAgICAgIC8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKTsKICAgICAgfQoKICAgIC8vIEhBTkRMRTogJChET01FbGVtZW50KQogICAgfSBlbHNlIGlmICggc2VsZWN0b3Iubm9kZVR5cGUgKSB7CiAgICAgIHRoaXMuY29udGV4dCA9IHRoaXNbMF0gPSBzZWxlY3RvcjsKICAgICAgdGhpcy5sZW5ndGggPSAxOwogICAgICByZXR1cm4gdGhpczsKCiAgICAvLyBIQU5ETEU6ICQoZnVuY3Rpb24pCiAgICAvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKICAgIH0gZWxzZSBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBzZWxlY3RvciApICkgewogICAgICByZXR1cm4gcm9vdGpRdWVyeS5yZWFkeSggc2VsZWN0b3IgKTsKICAgIH0KCiAgICBpZiAoIHNlbGVjdG9yLnNlbGVjdG9yICE9PSB1bmRlZmluZWQgKSB7CiAgICAgIHRoaXMuc2VsZWN0b3IgPSBzZWxlY3Rvci5zZWxlY3RvcjsKICAgICAgdGhpcy5jb250ZXh0ID0gc2VsZWN0b3IuY29udGV4dDsKICAgIH0KCiAgICByZXR1cm4galF1ZXJ5Lm1ha2VBcnJheSggc2VsZWN0b3IsIHRoaXMgKTsKICB9LAoKICAvLyBTdGFydCB3aXRoIGFuIGVtcHR5IHNlbGVjdG9yCiAgc2VsZWN0b3I6ICIiLAoKICAvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDAKICBsZW5ndGg6IDAsCgogIC8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CiAgc2l6ZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGg7CiAgfSwKCiAgdG9BcnJheTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29yZV9zbGljZS5jYWxsKCB0aGlzICk7CiAgfSwKCiAgLy8gR2V0IHRoZSBOdGggZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldCBPUgogIC8vIEdldCB0aGUgd2hvbGUgbWF0Y2hlZCBlbGVtZW50IHNldCBhcyBhIGNsZWFuIGFycmF5CiAgZ2V0OiBmdW5jdGlvbiggbnVtICkgewogICAgcmV0dXJuIG51bSA9PSBudWxsID8KCiAgICAgIC8vIFJldHVybiBhICdjbGVhbicgYXJyYXkKICAgICAgdGhpcy50b0FycmF5KCkgOgoKICAgICAgLy8gUmV0dXJuIGp1c3QgdGhlIG9iamVjdAogICAgICAoIG51bSA8IDAgPyB0aGlzWyB0aGlzLmxlbmd0aCArIG51bSBdIDogdGhpc1sgbnVtIF0gKTsKICB9LAoKICAvLyBUYWtlIGFuIGFycmF5IG9mIGVsZW1lbnRzIGFuZCBwdXNoIGl0IG9udG8gdGhlIHN0YWNrCiAgLy8gKHJldHVybmluZyB0aGUgbmV3IG1hdGNoZWQgZWxlbWVudCBzZXQpCiAgcHVzaFN0YWNrOiBmdW5jdGlvbiggZWxlbXMgKSB7CgogICAgLy8gQnVpbGQgYSBuZXcgalF1ZXJ5IG1hdGNoZWQgZWxlbWVudCBzZXQKICAgIHZhciByZXQgPSBqUXVlcnkubWVyZ2UoIHRoaXMuY29uc3RydWN0b3IoKSwgZWxlbXMgKTsKCiAgICAvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQogICAgcmV0LnByZXZPYmplY3QgPSB0aGlzOwogICAgcmV0LmNvbnRleHQgPSB0aGlzLmNvbnRleHQ7CgogICAgLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKICAgIHJldHVybiByZXQ7CiAgfSwKCiAgLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KICAvLyAoWW91IGNhbiBzZWVkIHRoZSBhcmd1bWVudHMgd2l0aCBhbiBhcnJheSBvZiBhcmdzLCBidXQgdGhpcyBpcwogIC8vIG9ubHkgdXNlZCBpbnRlcm5hbGx5LikKICBlYWNoOiBmdW5jdGlvbiggY2FsbGJhY2ssIGFyZ3MgKSB7CiAgICByZXR1cm4galF1ZXJ5LmVhY2goIHRoaXMsIGNhbGxiYWNrLCBhcmdzICk7CiAgfSwKCiAgcmVhZHk6IGZ1bmN0aW9uKCBmbiApIHsKICAgIC8vIEFkZCB0aGUgY2FsbGJhY2sKICAgIGpRdWVyeS5yZWFkeS5wcm9taXNlKCkuZG9uZSggZm4gKTsKCiAgICByZXR1cm4gdGhpczsKICB9LAoKICBzbGljZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soIGNvcmVfc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApICk7CiAgfSwKCiAgZmlyc3Q6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZXEoIDAgKTsKICB9LAoKICBsYXN0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmVxKCAtMSApOwogIH0sCgogIGVxOiBmdW5jdGlvbiggaSApIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aCwKICAgICAgaiA9ICtpICsgKCBpIDwgMCA/IGxlbiA6IDAgKTsKICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayggaiA+PSAwICYmIGogPCBsZW4gPyBbIHRoaXNbal0gXSA6IFtdICk7CiAgfSwKCiAgbWFwOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CiAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CiAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKCBlbGVtLCBpLCBlbGVtICk7CiAgICB9KSk7CiAgfSwKCiAgZW5kOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcihudWxsKTsKICB9LAoKICAvLyBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuCiAgLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCiAgcHVzaDogY29yZV9wdXNoLAogIHNvcnQ6IFtdLnNvcnQsCiAgc3BsaWNlOiBbXS5zcGxpY2UKfTsKCi8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KalF1ZXJ5LmZuLmluaXQucHJvdG90eXBlID0galF1ZXJ5LmZuOwoKalF1ZXJ5LmV4dGVuZCA9IGpRdWVyeS5mbi5leHRlbmQgPSBmdW5jdGlvbigpIHsKICB2YXIgb3B0aW9ucywgbmFtZSwgc3JjLCBjb3B5LCBjb3B5SXNBcnJheSwgY2xvbmUsCiAgICB0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sCiAgICBpID0gMSwKICAgIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICBkZWVwID0gZmFsc2U7CgogIC8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KICBpZiAoIHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIiApIHsKICAgIGRlZXAgPSB0YXJnZXQ7CiAgICB0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CiAgICAvLyBza2lwIHRoZSBib29sZWFuIGFuZCB0aGUgdGFyZ2V0CiAgICBpID0gMjsKICB9CgogIC8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQogIGlmICggdHlwZW9mIHRhcmdldCAhPT0gIm9iamVjdCIgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKHRhcmdldCkgKSB7CiAgICB0YXJnZXQgPSB7fTsKICB9CgogIC8vIGV4dGVuZCBqUXVlcnkgaXRzZWxmIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAogIGlmICggbGVuZ3RoID09PSBpICkgewogICAgdGFyZ2V0ID0gdGhpczsKICAgIC0taTsKICB9CgogIGZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewogICAgLy8gT25seSBkZWFsIHdpdGggbm9uLW51bGwvdW5kZWZpbmVkIHZhbHVlcwogICAgaWYgKCAob3B0aW9ucyA9IGFyZ3VtZW50c1sgaSBdKSAhPSBudWxsICkgewogICAgICAvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CiAgICAgIGZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsKICAgICAgICBzcmMgPSB0YXJnZXRbIG5hbWUgXTsKICAgICAgICBjb3B5ID0gb3B0aW9uc1sgbmFtZSBdOwoKICAgICAgICAvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCiAgICAgICAgaWYgKCB0YXJnZXQgPT09IGNvcHkgKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIC8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwogICAgICAgIGlmICggZGVlcCAmJiBjb3B5ICYmICggalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0galF1ZXJ5LmlzQXJyYXkoY29weSkpICkgKSB7CiAgICAgICAgICBpZiAoIGNvcHlJc0FycmF5ICkgewogICAgICAgICAgICBjb3B5SXNBcnJheSA9IGZhbHNlOwogICAgICAgICAgICBjbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNBcnJheShzcmMpID8gc3JjIDogW107CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSA/IHNyYyA6IHt9OwogICAgICAgICAgfQoKICAgICAgICAgIC8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQogICAgICAgICAgdGFyZ2V0WyBuYW1lIF0gPSBqUXVlcnkuZXh0ZW5kKCBkZWVwLCBjbG9uZSwgY29weSApOwoKICAgICAgICAvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCiAgICAgICAgfSBlbHNlIGlmICggY29weSAhPT0gdW5kZWZpbmVkICkgewogICAgICAgICAgdGFyZ2V0WyBuYW1lIF0gPSBjb3B5OwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLy8gUmV0dXJuIHRoZSBtb2RpZmllZCBvYmplY3QKICByZXR1cm4gdGFyZ2V0Owp9OwoKalF1ZXJ5LmV4dGVuZCh7CiAgbm9Db25mbGljdDogZnVuY3Rpb24oIGRlZXAgKSB7CiAgICBpZiAoIHdpbmRvdy4kID09PSBqUXVlcnkgKSB7CiAgICAgIHdpbmRvdy4kID0gXyQ7CiAgICB9CgogICAgaWYgKCBkZWVwICYmIHdpbmRvdy5qUXVlcnkgPT09IGpRdWVyeSApIHsKICAgICAgd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CiAgICB9CgogICAgcmV0dXJuIGpRdWVyeTsKICB9LAoKICAvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgogIGlzUmVhZHk6IGZhbHNlLAoKICAvLyBBIGNvdW50ZXIgdG8gdHJhY2sgaG93IG1hbnkgaXRlbXMgdG8gd2FpdCBmb3IgYmVmb3JlCiAgLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODEKICByZWFkeVdhaXQ6IDEsCgogIC8vIEhvbGQgKG9yIHJlbGVhc2UpIHRoZSByZWFkeSBldmVudAogIGhvbGRSZWFkeTogZnVuY3Rpb24oIGhvbGQgKSB7CiAgICBpZiAoIGhvbGQgKSB7CiAgICAgIGpRdWVyeS5yZWFkeVdhaXQrKzsKICAgIH0gZWxzZSB7CiAgICAgIGpRdWVyeS5yZWFkeSggdHJ1ZSApOwogICAgfQogIH0sCgogIC8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKICByZWFkeTogZnVuY3Rpb24oIHdhaXQgKSB7CgogICAgLy8gQWJvcnQgaWYgdGhlcmUgYXJlIHBlbmRpbmcgaG9sZHMgb3Igd2UncmUgYWxyZWFkeSByZWFkeQogICAgaWYgKCB3YWl0ID09PSB0cnVlID8gLS1qUXVlcnkucmVhZHlXYWl0IDogalF1ZXJ5LmlzUmVhZHkgKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBNYWtlIHN1cmUgYm9keSBleGlzdHMsIGF0IGxlYXN0LCBpbiBjYXNlIElFIGdldHMgYSBsaXR0bGUgb3ZlcnplYWxvdXMgKHRpY2tldCAjNTQ0MykuCiAgICBpZiAoICFkb2N1bWVudC5ib2R5ICkgewogICAgICByZXR1cm4gc2V0VGltZW91dCggalF1ZXJ5LnJlYWR5ICk7CiAgICB9CgogICAgLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CiAgICBqUXVlcnkuaXNSZWFkeSA9IHRydWU7CgogICAgLy8gSWYgYSBub3JtYWwgRE9NIFJlYWR5IGV2ZW50IGZpcmVkLCBkZWNyZW1lbnQsIGFuZCB3YWl0IGlmIG5lZWQgYmUKICAgIGlmICggd2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwICkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gSWYgdGhlcmUgYXJlIGZ1bmN0aW9ucyBib3VuZCwgdG8gZXhlY3V0ZQogICAgcmVhZHlMaXN0LnJlc29sdmVXaXRoKCBkb2N1bWVudCwgWyBqUXVlcnkgXSApOwoKICAgIC8vIFRyaWdnZXIgYW55IGJvdW5kIHJlYWR5IGV2ZW50cwogICAgaWYgKCBqUXVlcnkuZm4udHJpZ2dlciApIHsKICAgICAgalF1ZXJ5KCBkb2N1bWVudCApLnRyaWdnZXIoInJlYWR5Iikub2ZmKCJyZWFkeSIpOwogICAgfQogIH0sCgogIC8vIFNlZSB0ZXN0L3VuaXQvY29yZS5qcyBmb3IgZGV0YWlscyBjb25jZXJuaW5nIGlzRnVuY3Rpb24uCiAgLy8gU2luY2UgdmVyc2lvbiAxLjMsIERPTSBtZXRob2RzIGFuZCBmdW5jdGlvbnMgbGlrZSBhbGVydAogIC8vIGFyZW4ndCBzdXBwb3J0ZWQuIFRoZXkgcmV0dXJuIGZhbHNlIG9uIElFICgjMjk2OCkuCiAgaXNGdW5jdGlvbjogZnVuY3Rpb24oIG9iaiApIHsKICAgIHJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiZnVuY3Rpb24iOwogIH0sCgogIGlzQXJyYXk6IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24oIG9iaiApIHsKICAgIHJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiYXJyYXkiOwogIH0sCgogIGlzV2luZG93OiBmdW5jdGlvbiggb2JqICkgewogICAgcmV0dXJuIG9iaiAhPSBudWxsICYmIG9iaiA9PSBvYmoud2luZG93OwogIH0sCgogIGlzTnVtZXJpYzogZnVuY3Rpb24oIG9iaiApIHsKICAgIHJldHVybiAhaXNOYU4oIHBhcnNlRmxvYXQob2JqKSApICYmIGlzRmluaXRlKCBvYmogKTsKICB9LAoKICB0eXBlOiBmdW5jdGlvbiggb2JqICkgewogICAgaWYgKCBvYmogPT0gbnVsbCApIHsKICAgICAgcmV0dXJuIFN0cmluZyggb2JqICk7CiAgICB9CiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIiA/CiAgICAgIGNsYXNzMnR5cGVbIGNvcmVfdG9TdHJpbmcuY2FsbChvYmopIF0gfHwgIm9iamVjdCIgOgogICAgICB0eXBlb2Ygb2JqOwogIH0sCgogIGlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CiAgICAvLyBNdXN0IGJlIGFuIE9iamVjdC4KICAgIC8vIEJlY2F1c2Ugb2YgSUUsIHdlIGFsc28gaGF2ZSB0byBjaGVjayB0aGUgcHJlc2VuY2Ugb2YgdGhlIGNvbnN0cnVjdG9yIHByb3BlcnR5LgogICAgLy8gTWFrZSBzdXJlIHRoYXQgRE9NIG5vZGVzIGFuZCB3aW5kb3cgb2JqZWN0cyBkb24ndCBwYXNzIHRocm91Z2gsIGFzIHdlbGwKICAgIGlmICggIW9iaiB8fCBqUXVlcnkudHlwZShvYmopICE9PSAib2JqZWN0IiB8fCBvYmoubm9kZVR5cGUgfHwgalF1ZXJ5LmlzV2luZG93KCBvYmogKSApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHRyeSB7CiAgICAgIC8vIE5vdCBvd24gY29uc3RydWN0b3IgcHJvcGVydHkgbXVzdCBiZSBPYmplY3QKICAgICAgaWYgKCBvYmouY29uc3RydWN0b3IgJiYKICAgICAgICAhY29yZV9oYXNPd24uY2FsbChvYmosICJjb25zdHJ1Y3RvciIpICYmCiAgICAgICAgIWNvcmVfaGFzT3duLmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgImlzUHJvdG90eXBlT2YiKSApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0gY2F0Y2ggKCBlICkgewogICAgICAvLyBJRTgsOSBXaWxsIHRocm93IGV4Y2VwdGlvbnMgb24gY2VydGFpbiBob3N0IG9iamVjdHMgIzk4OTcKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIE93biBwcm9wZXJ0aWVzIGFyZSBlbnVtZXJhdGVkIGZpcnN0bHksIHNvIHRvIHNwZWVkIHVwLAogICAgLy8gaWYgbGFzdCBvbmUgaXMgb3duLCB0aGVuIGFsbCBwcm9wZXJ0aWVzIGFyZSBvd24uCgogICAgdmFyIGtleTsKICAgIGZvciAoIGtleSBpbiBvYmogKSB7fQoKICAgIHJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBjb3JlX2hhc093bi5jYWxsKCBvYmosIGtleSApOwogIH0sCgogIGlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CiAgICB2YXIgbmFtZTsKICAgIGZvciAoIG5hbWUgaW4gb2JqICkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICBlcnJvcjogZnVuY3Rpb24oIG1zZyApIHsKICAgIHRocm93IG5ldyBFcnJvciggbXNnICk7CiAgfSwKCiAgLy8gZGF0YTogc3RyaW5nIG9mIGh0bWwKICAvLyBjb250ZXh0IChvcHRpb25hbCk6IElmIHNwZWNpZmllZCwgdGhlIGZyYWdtZW50IHdpbGwgYmUgY3JlYXRlZCBpbiB0aGlzIGNvbnRleHQsIGRlZmF1bHRzIHRvIGRvY3VtZW50CiAgLy8ga2VlcFNjcmlwdHMgKG9wdGlvbmFsKTogSWYgdHJ1ZSwgd2lsbCBpbmNsdWRlIHNjcmlwdHMgcGFzc2VkIGluIHRoZSBodG1sIHN0cmluZwogIHBhcnNlSFRNTDogZnVuY3Rpb24oIGRhdGEsIGNvbnRleHQsIGtlZXBTY3JpcHRzICkgewogICAgaWYgKCAhZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gImJvb2xlYW4iICkgewogICAgICBrZWVwU2NyaXB0cyA9IGNvbnRleHQ7CiAgICAgIGNvbnRleHQgPSBmYWxzZTsKICAgIH0KICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwoKICAgIHZhciBwYXJzZWQgPSByc2luZ2xlVGFnLmV4ZWMoIGRhdGEgKSwKICAgICAgc2NyaXB0cyA9ICFrZWVwU2NyaXB0cyAmJiBbXTsKCiAgICAvLyBTaW5nbGUgdGFnCiAgICBpZiAoIHBhcnNlZCApIHsKICAgICAgcmV0dXJuIFsgY29udGV4dC5jcmVhdGVFbGVtZW50KCBwYXJzZWRbMV0gKSBdOwogICAgfQoKICAgIHBhcnNlZCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KCBbIGRhdGEgXSwgY29udGV4dCwgc2NyaXB0cyApOwogICAgaWYgKCBzY3JpcHRzICkgewogICAgICBqUXVlcnkoIHNjcmlwdHMgKS5yZW1vdmUoKTsKICAgIH0KICAgIHJldHVybiBqUXVlcnkubWVyZ2UoIFtdLCBwYXJzZWQuY2hpbGROb2RlcyApOwogIH0sCgogIHBhcnNlSlNPTjogZnVuY3Rpb24oIGRhdGEgKSB7CiAgICAvLyBBdHRlbXB0IHRvIHBhcnNlIHVzaW5nIHRoZSBuYXRpdmUgSlNPTiBwYXJzZXIgZmlyc3QKICAgIGlmICggd2luZG93LkpTT04gJiYgd2luZG93LkpTT04ucGFyc2UgKSB7CiAgICAgIHJldHVybiB3aW5kb3cuSlNPTi5wYXJzZSggZGF0YSApOwogICAgfQoKICAgIGlmICggZGF0YSA9PT0gbnVsbCApIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CgogICAgaWYgKCB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgKSB7CgogICAgICAvLyBNYWtlIHN1cmUgbGVhZGluZy90cmFpbGluZyB3aGl0ZXNwYWNlIGlzIHJlbW92ZWQgKElFIGNhbid0IGhhbmRsZSBpdCkKICAgICAgZGF0YSA9IGpRdWVyeS50cmltKCBkYXRhICk7CgogICAgICBpZiAoIGRhdGEgKSB7CiAgICAgICAgLy8gTWFrZSBzdXJlIHRoZSBpbmNvbWluZyBkYXRhIGlzIGFjdHVhbCBKU09OCiAgICAgICAgLy8gTG9naWMgYm9ycm93ZWQgZnJvbSBodHRwOi8vanNvbi5vcmcvanNvbjIuanMKICAgICAgICBpZiAoIHJ2YWxpZGNoYXJzLnRlc3QoIGRhdGEucmVwbGFjZSggcnZhbGlkZXNjYXBlLCAiQCIgKQogICAgICAgICAgLnJlcGxhY2UoIHJ2YWxpZHRva2VucywgIl0iICkKICAgICAgICAgIC5yZXBsYWNlKCBydmFsaWRicmFjZXMsICIiKSkgKSB7CgogICAgICAgICAgcmV0dXJuICggbmV3IEZ1bmN0aW9uKCAicmV0dXJuICIgKyBkYXRhICkgKSgpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGpRdWVyeS5lcnJvciggIkludmFsaWQgSlNPTjogIiArIGRhdGEgKTsKICB9LAoKICAvLyBDcm9zcy1icm93c2VyIHhtbCBwYXJzaW5nCiAgcGFyc2VYTUw6IGZ1bmN0aW9uKCBkYXRhICkgewogICAgdmFyIHhtbCwgdG1wOwogICAgaWYgKCAhZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdHJ5IHsKICAgICAgaWYgKCB3aW5kb3cuRE9NUGFyc2VyICkgeyAvLyBTdGFuZGFyZAogICAgICAgIHRtcCA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICB4bWwgPSB0bXAucGFyc2VGcm9tU3RyaW5nKCBkYXRhICwgInRleHQveG1sIiApOwogICAgICB9IGVsc2UgeyAvLyBJRQogICAgICAgIHhtbCA9IG5ldyBBY3RpdmVYT2JqZWN0KCAiTWljcm9zb2Z0LlhNTERPTSIgKTsKICAgICAgICB4bWwuYXN5bmMgPSAiZmFsc2UiOwogICAgICAgIHhtbC5sb2FkWE1MKCBkYXRhICk7CiAgICAgIH0KICAgIH0gY2F0Y2goIGUgKSB7CiAgICAgIHhtbCA9IHVuZGVmaW5lZDsKICAgIH0KICAgIGlmICggIXhtbCB8fCAheG1sLmRvY3VtZW50RWxlbWVudCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJwYXJzZXJlcnJvciIgKS5sZW5ndGggKSB7CiAgICAgIGpRdWVyeS5lcnJvciggIkludmFsaWQgWE1MOiAiICsgZGF0YSApOwogICAgfQogICAgcmV0dXJuIHhtbDsKICB9LAoKICBub29wOiBmdW5jdGlvbigpIHt9LAoKICAvLyBFdmFsdWF0ZXMgYSBzY3JpcHQgaW4gYSBnbG9iYWwgY29udGV4dAogIC8vIFdvcmthcm91bmRzIGJhc2VkIG9uIGZpbmRpbmdzIGJ5IEppbSBEcmlzY29sbAogIC8vIGh0dHA6Ly93ZWJsb2dzLmphdmEubmV0L2Jsb2cvZHJpc2NvbGwvYXJjaGl2ZS8yMDA5LzA5LzA4L2V2YWwtamF2YXNjcmlwdC1nbG9iYWwtY29udGV4dAogIGdsb2JhbEV2YWw6IGZ1bmN0aW9uKCBkYXRhICkgewogICAgaWYgKCBkYXRhICYmIGpRdWVyeS50cmltKCBkYXRhICkgKSB7CiAgICAgIC8vIFdlIHVzZSBleGVjU2NyaXB0IG9uIEludGVybmV0IEV4cGxvcmVyCiAgICAgIC8vIFdlIHVzZSBhbiBhbm9ueW1vdXMgZnVuY3Rpb24gc28gdGhhdCBjb250ZXh0IGlzIHdpbmRvdwogICAgICAvLyByYXRoZXIgdGhhbiBqUXVlcnkgaW4gRmlyZWZveAogICAgICAoIHdpbmRvdy5leGVjU2NyaXB0IHx8IGZ1bmN0aW9uKCBkYXRhICkgewogICAgICAgIHdpbmRvd1sgImV2YWwiIF0uY2FsbCggd2luZG93LCBkYXRhICk7CiAgICAgIH0gKSggZGF0YSApOwogICAgfQogIH0sCgogIC8vIENvbnZlcnQgZGFzaGVkIHRvIGNhbWVsQ2FzZTsgdXNlZCBieSB0aGUgY3NzIGFuZCBkYXRhIG1vZHVsZXMKICAvLyBNaWNyb3NvZnQgZm9yZ290IHRvIGh1bXAgdGhlaXIgdmVuZG9yIHByZWZpeCAoIzk1NzIpCiAgY2FtZWxDYXNlOiBmdW5jdGlvbiggc3RyaW5nICkgewogICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKCBybXNQcmVmaXgsICJtcy0iICkucmVwbGFjZSggcmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSApOwogIH0sCgogIG5vZGVOYW1lOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKICAgIHJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOwogIH0sCgogIC8vIGFyZ3MgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICBlYWNoOiBmdW5jdGlvbiggb2JqLCBjYWxsYmFjaywgYXJncyApIHsKICAgIHZhciB2YWx1ZSwKICAgICAgaSA9IDAsCiAgICAgIGxlbmd0aCA9IG9iai5sZW5ndGgsCiAgICAgIGlzQXJyYXkgPSBpc0FycmF5bGlrZSggb2JqICk7CgogICAgaWYgKCBhcmdzICkgewogICAgICBpZiAoIGlzQXJyYXkgKSB7CiAgICAgICAgZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkgXSwgYXJncyApOwoKICAgICAgICAgIGlmICggdmFsdWUgPT09IGZhbHNlICkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yICggaSBpbiBvYmogKSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkgXSwgYXJncyApOwoKICAgICAgICAgIGlmICggdmFsdWUgPT09IGZhbHNlICkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAvLyBBIHNwZWNpYWwsIGZhc3QsIGNhc2UgZm9yIHRoZSBtb3N0IGNvbW1vbiB1c2Ugb2YgZWFjaAogICAgfSBlbHNlIHsKICAgICAgaWYgKCBpc0FycmF5ICkgewogICAgICAgIGZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewogICAgICAgICAgdmFsdWUgPSBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKTsKCiAgICAgICAgICBpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoIGkgaW4gb2JqICkgewogICAgICAgICAgdmFsdWUgPSBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKTsKCiAgICAgICAgICBpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9LAoKICAvLyBVc2UgbmF0aXZlIFN0cmluZy50cmltIGZ1bmN0aW9uIHdoZXJldmVyIHBvc3NpYmxlCiAgdHJpbTogY29yZV90cmltICYmICFjb3JlX3RyaW0uY2FsbCgiXHVGRUZGXHhBMCIpID8KICAgIGZ1bmN0aW9uKCB0ZXh0ICkgewogICAgICByZXR1cm4gdGV4dCA9PSBudWxsID8KICAgICAgICAiIiA6CiAgICAgICAgY29yZV90cmltLmNhbGwoIHRleHQgKTsKICAgIH0gOgoKICAgIC8vIE90aGVyd2lzZSB1c2Ugb3VyIG93biB0cmltbWluZyBmdW5jdGlvbmFsaXR5CiAgICBmdW5jdGlvbiggdGV4dCApIHsKICAgICAgcmV0dXJuIHRleHQgPT0gbnVsbCA/CiAgICAgICAgIiIgOgogICAgICAgICggdGV4dCArICIiICkucmVwbGFjZSggcnRyaW0sICIiICk7CiAgICB9LAoKICAvLyByZXN1bHRzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgbWFrZUFycmF5OiBmdW5jdGlvbiggYXJyLCByZXN1bHRzICkgewogICAgdmFyIHJldCA9IHJlc3VsdHMgfHwgW107CgogICAgaWYgKCBhcnIgIT0gbnVsbCApIHsKICAgICAgaWYgKCBpc0FycmF5bGlrZSggT2JqZWN0KGFycikgKSApIHsKICAgICAgICBqUXVlcnkubWVyZ2UoIHJldCwKICAgICAgICAgIHR5cGVvZiBhcnIgPT09ICJzdHJpbmciID8KICAgICAgICAgIFsgYXJyIF0gOiBhcnIKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIGNvcmVfcHVzaC5jYWxsKCByZXQsIGFyciApOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJldDsKICB9LAoKICBpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyLCBpICkgewogICAgdmFyIGxlbjsKCiAgICBpZiAoIGFyciApIHsKICAgICAgaWYgKCBjb3JlX2luZGV4T2YgKSB7CiAgICAgICAgcmV0dXJuIGNvcmVfaW5kZXhPZi5jYWxsKCBhcnIsIGVsZW0sIGkgKTsKICAgICAgfQoKICAgICAgbGVuID0gYXJyLmxlbmd0aDsKICAgICAgaSA9IGkgPyBpIDwgMCA/IE1hdGgubWF4KCAwLCBsZW4gKyBpICkgOiBpIDogMDsKCiAgICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgICAgIC8vIFNraXAgYWNjZXNzaW5nIGluIHNwYXJzZSBhcnJheXMKICAgICAgICBpZiAoIGkgaW4gYXJyICYmIGFyclsgaSBdID09PSBlbGVtICkgewogICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIC0xOwogIH0sCgogIG1lcmdlOiBmdW5jdGlvbiggZmlyc3QsIHNlY29uZCApIHsKICAgIHZhciBsID0gc2Vjb25kLmxlbmd0aCwKICAgICAgaSA9IGZpcnN0Lmxlbmd0aCwKICAgICAgaiA9IDA7CgogICAgaWYgKCB0eXBlb2YgbCA9PT0gIm51bWJlciIgKSB7CiAgICAgIGZvciAoIDsgaiA8IGw7IGorKyApIHsKICAgICAgICBmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGogXTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgd2hpbGUgKCBzZWNvbmRbal0gIT09IHVuZGVmaW5lZCApIHsKICAgICAgICBmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGorKyBdOwogICAgICB9CiAgICB9CgogICAgZmlyc3QubGVuZ3RoID0gaTsKCiAgICByZXR1cm4gZmlyc3Q7CiAgfSwKCiAgZ3JlcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgaW52ICkgewogICAgdmFyIHJldFZhbCwKICAgICAgcmV0ID0gW10sCiAgICAgIGkgPSAwLAogICAgICBsZW5ndGggPSBlbGVtcy5sZW5ndGg7CiAgICBpbnYgPSAhIWludjsKCiAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCiAgICAvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgogICAgZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgIHJldFZhbCA9ICEhY2FsbGJhY2soIGVsZW1zWyBpIF0sIGkgKTsKICAgICAgaWYgKCBpbnYgIT09IHJldFZhbCApIHsKICAgICAgICByZXQucHVzaCggZWxlbXNbIGkgXSApOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJldDsKICB9LAoKICAvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICBtYXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGFyZyApIHsKICAgIHZhciB2YWx1ZSwKICAgICAgaSA9IDAsCiAgICAgIGxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKICAgICAgaXNBcnJheSA9IGlzQXJyYXlsaWtlKCBlbGVtcyApLAogICAgICByZXQgPSBbXTsKCiAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXIKICAgIGlmICggaXNBcnJheSApIHsKICAgICAgZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgICAgdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSwgYXJnICk7CgogICAgICAgIGlmICggdmFsdWUgIT0gbnVsbCApIHsKICAgICAgICAgIHJldFsgcmV0Lmxlbmd0aCBdID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CgogICAgLy8gR28gdGhyb3VnaCBldmVyeSBrZXkgb24gdGhlIG9iamVjdCwKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoIGkgaW4gZWxlbXMgKSB7CiAgICAgICAgdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSwgYXJnICk7CgogICAgICAgIGlmICggdmFsdWUgIT0gbnVsbCApIHsKICAgICAgICAgIHJldFsgcmV0Lmxlbmd0aCBdID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwogICAgcmV0dXJuIGNvcmVfY29uY2F0LmFwcGx5KCBbXSwgcmV0ICk7CiAgfSwKCiAgLy8gQSBnbG9iYWwgR1VJRCBjb3VudGVyIGZvciBvYmplY3RzCiAgZ3VpZDogMSwKCiAgLy8gQmluZCBhIGZ1bmN0aW9uIHRvIGEgY29udGV4dCwgb3B0aW9uYWxseSBwYXJ0aWFsbHkgYXBwbHlpbmcgYW55CiAgLy8gYXJndW1lbnRzLgogIHByb3h5OiBmdW5jdGlvbiggZm4sIGNvbnRleHQgKSB7CiAgICB2YXIgdG1wLCBhcmdzLCBwcm94eTsKCiAgICBpZiAoIHR5cGVvZiBjb250ZXh0ID09PSAic3RyaW5nIiApIHsKICAgICAgdG1wID0gZm5bIGNvbnRleHQgXTsKICAgICAgY29udGV4dCA9IGZuOwogICAgICBmbiA9IHRtcDsKICAgIH0KCiAgICAvLyBRdWljayBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGFyZ2V0IGlzIGNhbGxhYmxlLCBpbiB0aGUgc3BlYwogICAgLy8gdGhpcyB0aHJvd3MgYSBUeXBlRXJyb3IsIGJ1dCB3ZSB3aWxsIGp1c3QgcmV0dXJuIHVuZGVmaW5lZC4KICAgIGlmICggIWpRdWVyeS5pc0Z1bmN0aW9uKCBmbiApICkgewogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQoKICAgIC8vIFNpbXVsYXRlZCBiaW5kCiAgICBhcmdzID0gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMsIDIgKTsKICAgIHByb3h5ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmbi5hcHBseSggY29udGV4dCB8fCB0aGlzLCBhcmdzLmNvbmNhdCggY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSApICk7CiAgICB9OwoKICAgIC8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAogICAgcHJveHkuZ3VpZCA9IGZuLmd1aWQgPSBmbi5ndWlkIHx8IGpRdWVyeS5ndWlkKys7CgogICAgcmV0dXJuIHByb3h5OwogIH0sCgogIC8vIE11bHRpZnVuY3Rpb25hbCBtZXRob2QgdG8gZ2V0IGFuZCBzZXQgdmFsdWVzIG9mIGEgY29sbGVjdGlvbgogIC8vIFRoZSB2YWx1ZS9zIGNhbiBvcHRpb25hbGx5IGJlIGV4ZWN1dGVkIGlmIGl0J3MgYSBmdW5jdGlvbgogIGFjY2VzczogZnVuY3Rpb24oIGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcmF3ICkgewogICAgdmFyIGkgPSAwLAogICAgICBsZW5ndGggPSBlbGVtcy5sZW5ndGgsCiAgICAgIGJ1bGsgPSBrZXkgPT0gbnVsbDsKCiAgICAvLyBTZXRzIG1hbnkgdmFsdWVzCiAgICBpZiAoIGpRdWVyeS50eXBlKCBrZXkgKSA9PT0gIm9iamVjdCIgKSB7CiAgICAgIGNoYWluYWJsZSA9IHRydWU7CiAgICAgIGZvciAoIGkgaW4ga2V5ICkgewogICAgICAgIGpRdWVyeS5hY2Nlc3MoIGVsZW1zLCBmbiwgaSwga2V5W2ldLCB0cnVlLCBlbXB0eUdldCwgcmF3ICk7CiAgICAgIH0KCiAgICAvLyBTZXRzIG9uZSB2YWx1ZQogICAgfSBlbHNlIGlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKICAgICAgY2hhaW5hYmxlID0gdHJ1ZTsKCiAgICAgIGlmICggIWpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewogICAgICAgIHJhdyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICggYnVsayApIHsKICAgICAgICAvLyBCdWxrIG9wZXJhdGlvbnMgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKICAgICAgICBpZiAoIHJhdyApIHsKICAgICAgICAgIGZuLmNhbGwoIGVsZW1zLCB2YWx1ZSApOwogICAgICAgICAgZm4gPSBudWxsOwoKICAgICAgICAvLyAuLi5leGNlcHQgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJ1bGsgPSBmbjsKICAgICAgICAgIGZuID0gZnVuY3Rpb24oIGVsZW0sIGtleSwgdmFsdWUgKSB7CiAgICAgICAgICAgIHJldHVybiBidWxrLmNhbGwoIGpRdWVyeSggZWxlbSApLCB2YWx1ZSApOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICggZm4gKSB7CiAgICAgICAgZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICBmbiggZWxlbXNbaV0sIGtleSwgcmF3ID8gdmFsdWUgOiB2YWx1ZS5jYWxsKCBlbGVtc1tpXSwgaSwgZm4oIGVsZW1zW2ldLCBrZXkgKSApICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNoYWluYWJsZSA/CiAgICAgIGVsZW1zIDoKCiAgICAgIC8vIEdldHMKICAgICAgYnVsayA/CiAgICAgICAgZm4uY2FsbCggZWxlbXMgKSA6CiAgICAgICAgbGVuZ3RoID8gZm4oIGVsZW1zWzBdLCBrZXkgKSA6IGVtcHR5R2V0OwogIH0sCgogIG5vdzogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwogIH0KfSk7CgpqUXVlcnkucmVhZHkucHJvbWlzZSA9IGZ1bmN0aW9uKCBvYmogKSB7CiAgaWYgKCAhcmVhZHlMaXN0ICkgewoKICAgIHJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOwoKICAgIC8vIENhdGNoIGNhc2VzIHdoZXJlICQoZG9jdW1lbnQpLnJlYWR5KCkgaXMgY2FsbGVkIGFmdGVyIHRoZSBicm93c2VyIGV2ZW50IGhhcyBhbHJlYWR5IG9jY3VycmVkLgogICAgLy8gd2Ugb25jZSB0cmllZCB0byB1c2UgcmVhZHlTdGF0ZSAiaW50ZXJhY3RpdmUiIGhlcmUsIGJ1dCBpdCBjYXVzZWQgaXNzdWVzIGxpa2UgdGhlIG9uZQogICAgLy8gZGlzY292ZXJlZCBieSBDaHJpc1MgaGVyZTogaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIyODIjY29tbWVudDoxNQogICAgaWYgKCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewogICAgICAvLyBIYW5kbGUgaXQgYXN5bmNocm9ub3VzbHkgdG8gYWxsb3cgc2NyaXB0cyB0aGUgb3Bwb3J0dW5pdHkgdG8gZGVsYXkgcmVhZHkKICAgICAgc2V0VGltZW91dCggalF1ZXJ5LnJlYWR5ICk7CgogICAgLy8gU3RhbmRhcmRzLWJhc2VkIGJyb3dzZXJzIHN1cHBvcnQgRE9NQ29udGVudExvYWRlZAogICAgfSBlbHNlIGlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKICAgICAgLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIERPTUNvbnRlbnRMb2FkZWQsIGZhbHNlICk7CgogICAgICAvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggImxvYWQiLCBqUXVlcnkucmVhZHksIGZhbHNlICk7CgogICAgLy8gSWYgSUUgZXZlbnQgbW9kZWwgaXMgdXNlZAogICAgfSBlbHNlIHsKICAgICAgLy8gRW5zdXJlIGZpcmluZyBiZWZvcmUgb25sb2FkLCBtYXliZSBsYXRlIGJ1dCBzYWZlIGFsc28gZm9yIGlmcmFtZXMKICAgICAgZG9jdW1lbnQuYXR0YWNoRXZlbnQoICJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBET01Db250ZW50TG9hZGVkICk7CgogICAgICAvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawogICAgICB3aW5kb3cuYXR0YWNoRXZlbnQoICJvbmxvYWQiLCBqUXVlcnkucmVhZHkgKTsKCiAgICAgIC8vIElmIElFIGFuZCBub3QgYSBmcmFtZQogICAgICAvLyBjb250aW51YWxseSBjaGVjayB0byBzZWUgaWYgdGhlIGRvY3VtZW50IGlzIHJlYWR5CiAgICAgIHZhciB0b3AgPSBmYWxzZTsKCiAgICAgIHRyeSB7CiAgICAgICAgdG9wID0gd2luZG93LmZyYW1lRWxlbWVudCA9PSBudWxsICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAgICAgfSBjYXRjaChlKSB7fQoKICAgICAgaWYgKCB0b3AgJiYgdG9wLmRvU2Nyb2xsICkgewogICAgICAgIChmdW5jdGlvbiBkb1Njcm9sbENoZWNrKCkgewogICAgICAgICAgaWYgKCAhalF1ZXJ5LmlzUmVhZHkgKSB7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIC8vIFVzZSB0aGUgdHJpY2sgYnkgRGllZ28gUGVyaW5pCiAgICAgICAgICAgICAgLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KICAgICAgICAgICAgICB0b3AuZG9TY3JvbGwoImxlZnQiKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoIGRvU2Nyb2xsQ2hlY2ssIDUwICk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGFuZCBleGVjdXRlIGFueSB3YWl0aW5nIGZ1bmN0aW9ucwogICAgICAgICAgICBqUXVlcnkucmVhZHkoKTsKICAgICAgICAgIH0KICAgICAgICB9KSgpOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiByZWFkeUxpc3QucHJvbWlzZSggb2JqICk7Cn07CgovLyBQb3B1bGF0ZSB0aGUgY2xhc3MydHlwZSBtYXAKalF1ZXJ5LmVhY2goIkJvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QgRXJyb3IiLnNwbGl0KCIgIiksIGZ1bmN0aW9uKGksIG5hbWUpIHsKICBjbGFzczJ0eXBlWyAiW29iamVjdCAiICsgbmFtZSArICJdIiBdID0gbmFtZS50b0xvd2VyQ2FzZSgpOwp9KTsKCmZ1bmN0aW9uIGlzQXJyYXlsaWtlKCBvYmogKSB7CiAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGgsCiAgICB0eXBlID0galF1ZXJ5LnR5cGUoIG9iaiApOwoKICBpZiAoIGpRdWVyeS5pc1dpbmRvdyggb2JqICkgKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBpZiAoIG9iai5ub2RlVHlwZSA9PT0gMSAmJiBsZW5ndGggKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIHJldHVybiB0eXBlID09PSAiYXJyYXkiIHx8IHR5cGUgIT09ICJmdW5jdGlvbiIgJiYKICAgICggbGVuZ3RoID09PSAwIHx8CiAgICB0eXBlb2YgbGVuZ3RoID09PSAibnVtYmVyIiAmJiBsZW5ndGggPiAwICYmICggbGVuZ3RoIC0gMSApIGluIG9iaiApOwp9CgovLyBBbGwgalF1ZXJ5IG9iamVjdHMgc2hvdWxkIHBvaW50IGJhY2sgdG8gdGhlc2UKcm9vdGpRdWVyeSA9IGpRdWVyeShkb2N1bWVudCk7Ci8vIFN0cmluZyB0byBPYmplY3Qgb3B0aW9ucyBmb3JtYXQgY2FjaGUKdmFyIG9wdGlvbnNDYWNoZSA9IHt9OwoKLy8gQ29udmVydCBTdHJpbmctZm9ybWF0dGVkIG9wdGlvbnMgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMgYW5kIHN0b3JlIGluIGNhY2hlCmZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSB7CiAgdmFyIG9iamVjdCA9IG9wdGlvbnNDYWNoZVsgb3B0aW9ucyBdID0ge307CiAgalF1ZXJ5LmVhY2goIG9wdGlvbnMubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgW10sIGZ1bmN0aW9uKCBfLCBmbGFnICkgewogICAgb2JqZWN0WyBmbGFnIF0gPSB0cnVlOwogIH0pOwogIHJldHVybiBvYmplY3Q7Cn0KCi8qCiAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogKgogKiAgb3B0aW9uczogYW4gb3B0aW9uYWwgbGlzdCBvZiBzcGFjZS1zZXBhcmF0ZWQgb3B0aW9ucyB0aGF0IHdpbGwgY2hhbmdlIGhvdwogKiAgICAgIHRoZSBjYWxsYmFjayBsaXN0IGJlaGF2ZXMgb3IgYSBtb3JlIHRyYWRpdGlvbmFsIG9wdGlvbiBvYmplY3QKICoKICogQnkgZGVmYXVsdCBhIGNhbGxiYWNrIGxpc3Qgd2lsbCBhY3QgbGlrZSBhbiBldmVudCBjYWxsYmFjayBsaXN0IGFuZCBjYW4gYmUKICogImZpcmVkIiBtdWx0aXBsZSB0aW1lcy4KICoKICogUG9zc2libGUgb3B0aW9uczoKICoKICogIG9uY2U6ICAgICB3aWxsIGVuc3VyZSB0aGUgY2FsbGJhY2sgbGlzdCBjYW4gb25seSBiZSBmaXJlZCBvbmNlIChsaWtlIGEgRGVmZXJyZWQpCiAqCiAqICBtZW1vcnk6ICAgICB3aWxsIGtlZXAgdHJhY2sgb2YgcHJldmlvdXMgdmFsdWVzIGFuZCB3aWxsIGNhbGwgYW55IGNhbGxiYWNrIGFkZGVkCiAqICAgICAgICAgIGFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAqICAgICAgICAgIHZhbHVlcyAobGlrZSBhIERlZmVycmVkKQogKgogKiAgdW5pcXVlOiAgICAgd2lsbCBlbnN1cmUgYSBjYWxsYmFjayBjYW4gb25seSBiZSBhZGRlZCBvbmNlIChubyBkdXBsaWNhdGUgaW4gdGhlIGxpc3QpCiAqCiAqICBzdG9wT25GYWxzZTogIGludGVycnVwdCBjYWxsaW5ncyB3aGVuIGEgY2FsbGJhY2sgcmV0dXJucyBmYWxzZQogKgogKi8KalF1ZXJ5LkNhbGxiYWNrcyA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKICAvLyBDb252ZXJ0IG9wdGlvbnMgZnJvbSBTdHJpbmctZm9ybWF0dGVkIHRvIE9iamVjdC1mb3JtYXR0ZWQgaWYgbmVlZGVkCiAgLy8gKHdlIGNoZWNrIGluIGNhY2hlIGZpcnN0KQogIG9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgPwogICAgKCBvcHRpb25zQ2FjaGVbIG9wdGlvbnMgXSB8fCBjcmVhdGVPcHRpb25zKCBvcHRpb25zICkgKSA6CiAgICBqUXVlcnkuZXh0ZW5kKCB7fSwgb3B0aW9ucyApOwoKICB2YXIgLy8gTGFzdCBmaXJlIHZhbHVlIChmb3Igbm9uLWZvcmdldHRhYmxlIGxpc3RzKQogICAgbWVtb3J5LAogICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3Qgd2FzIGFscmVhZHkgZmlyZWQKICAgIGZpcmVkLAogICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3QgaXMgY3VycmVudGx5IGZpcmluZwogICAgZmlyaW5nLAogICAgLy8gRmlyc3QgY2FsbGJhY2sgdG8gZmlyZSAodXNlZCBpbnRlcm5hbGx5IGJ5IGFkZCBhbmQgZmlyZVdpdGgpCiAgICBmaXJpbmdTdGFydCwKICAgIC8vIEVuZCBvZiB0aGUgbG9vcCB3aGVuIGZpcmluZwogICAgZmlyaW5nTGVuZ3RoLAogICAgLy8gSW5kZXggb2YgY3VycmVudGx5IGZpcmluZyBjYWxsYmFjayAobW9kaWZpZWQgYnkgcmVtb3ZlIGlmIG5lZWRlZCkKICAgIGZpcmluZ0luZGV4LAogICAgLy8gQWN0dWFsIGNhbGxiYWNrIGxpc3QKICAgIGxpc3QgPSBbXSwKICAgIC8vIFN0YWNrIG9mIGZpcmUgY2FsbHMgZm9yIHJlcGVhdGFibGUgbGlzdHMKICAgIHN0YWNrID0gIW9wdGlvbnMub25jZSAmJiBbXSwKICAgIC8vIEZpcmUgY2FsbGJhY2tzCiAgICBmaXJlID0gZnVuY3Rpb24oIGRhdGEgKSB7CiAgICAgIG1lbW9yeSA9IG9wdGlvbnMubWVtb3J5ICYmIGRhdGE7CiAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgZmlyaW5nSW5kZXggPSBmaXJpbmdTdGFydCB8fCAwOwogICAgICBmaXJpbmdTdGFydCA9IDA7CiAgICAgIGZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwogICAgICBmaXJpbmcgPSB0cnVlOwogICAgICBmb3IgKCA7IGxpc3QgJiYgZmlyaW5nSW5kZXggPCBmaXJpbmdMZW5ndGg7IGZpcmluZ0luZGV4KysgKSB7CiAgICAgICAgaWYgKCBsaXN0WyBmaXJpbmdJbmRleCBdLmFwcGx5KCBkYXRhWyAwIF0sIGRhdGFbIDEgXSApID09PSBmYWxzZSAmJiBvcHRpb25zLnN0b3BPbkZhbHNlICkgewogICAgICAgICAgbWVtb3J5ID0gZmFsc2U7IC8vIFRvIHByZXZlbnQgZnVydGhlciBjYWxscyB1c2luZyBhZGQKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBmaXJpbmcgPSBmYWxzZTsKICAgICAgaWYgKCBsaXN0ICkgewogICAgICAgIGlmICggc3RhY2sgKSB7CiAgICAgICAgICBpZiAoIHN0YWNrLmxlbmd0aCApIHsKICAgICAgICAgICAgZmlyZSggc3RhY2suc2hpZnQoKSApOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIG1lbW9yeSApIHsKICAgICAgICAgIGxpc3QgPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5kaXNhYmxlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gQWN0dWFsIENhbGxiYWNrcyBvYmplY3QKICAgIHNlbGYgPSB7CiAgICAgIC8vIEFkZCBhIGNhbGxiYWNrIG9yIGEgY29sbGVjdGlvbiBvZiBjYWxsYmFja3MgdG8gdGhlIGxpc3QKICAgICAgYWRkOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIGxpc3QgKSB7CiAgICAgICAgICAvLyBGaXJzdCwgd2Ugc2F2ZSB0aGUgY3VycmVudCBsZW5ndGgKICAgICAgICAgIHZhciBzdGFydCA9IGxpc3QubGVuZ3RoOwogICAgICAgICAgKGZ1bmN0aW9uIGFkZCggYXJncyApIHsKICAgICAgICAgICAgalF1ZXJ5LmVhY2goIGFyZ3MsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBqUXVlcnkudHlwZSggYXJnICk7CiAgICAgICAgICAgICAgaWYgKCB0eXBlID09PSAiZnVuY3Rpb24iICkgewogICAgICAgICAgICAgICAgaWYgKCAhb3B0aW9ucy51bmlxdWUgfHwgIXNlbGYuaGFzKCBhcmcgKSApIHsKICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKCBhcmcgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBhcmcgJiYgYXJnLmxlbmd0aCAmJiB0eXBlICE9PSAic3RyaW5nIiApIHsKICAgICAgICAgICAgICAgIC8vIEluc3BlY3QgcmVjdXJzaXZlbHkKICAgICAgICAgICAgICAgIGFkZCggYXJnICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pKCBhcmd1bWVudHMgKTsKICAgICAgICAgIC8vIERvIHdlIG5lZWQgdG8gYWRkIHRoZSBjYWxsYmFja3MgdG8gdGhlCiAgICAgICAgICAvLyBjdXJyZW50IGZpcmluZyBiYXRjaD8KICAgICAgICAgIGlmICggZmlyaW5nICkgewogICAgICAgICAgICBmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsKICAgICAgICAgIC8vIFdpdGggbWVtb3J5LCBpZiB3ZSdyZSBub3QgZmlyaW5nIHRoZW4KICAgICAgICAgIC8vIHdlIHNob3VsZCBjYWxsIHJpZ2h0IGF3YXkKICAgICAgICAgIH0gZWxzZSBpZiAoIG1lbW9yeSApIHsKICAgICAgICAgICAgZmlyaW5nU3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgZmlyZSggbWVtb3J5ICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBSZW1vdmUgYSBjYWxsYmFjayBmcm9tIHRoZSBsaXN0CiAgICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCBsaXN0ICkgewogICAgICAgICAgalF1ZXJ5LmVhY2goIGFyZ3VtZW50cywgZnVuY3Rpb24oIF8sIGFyZyApIHsKICAgICAgICAgICAgdmFyIGluZGV4OwogICAgICAgICAgICB3aGlsZSggKCBpbmRleCA9IGpRdWVyeS5pbkFycmF5KCBhcmcsIGxpc3QsIGluZGV4ICkgKSA+IC0xICkgewogICAgICAgICAgICAgIGxpc3Quc3BsaWNlKCBpbmRleCwgMSApOwogICAgICAgICAgICAgIC8vIEhhbmRsZSBmaXJpbmcgaW5kZXhlcwogICAgICAgICAgICAgIGlmICggZmlyaW5nICkgewogICAgICAgICAgICAgICAgaWYgKCBpbmRleCA8PSBmaXJpbmdMZW5ndGggKSB7CiAgICAgICAgICAgICAgICAgIGZpcmluZ0xlbmd0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCBpbmRleCA8PSBmaXJpbmdJbmRleCApIHsKICAgICAgICAgICAgICAgICAgZmlyaW5nSW5kZXgtLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gQ29udHJvbCBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0CiAgICAgIGhhczogZnVuY3Rpb24oIGZuICkgewogICAgICAgIHJldHVybiBqUXVlcnkuaW5BcnJheSggZm4sIGxpc3QgKSA+IC0xOwogICAgICB9LAogICAgICAvLyBSZW1vdmUgYWxsIGNhbGxiYWNrcyBmcm9tIHRoZSBsaXN0CiAgICAgIGVtcHR5OiBmdW5jdGlvbigpIHsKICAgICAgICBsaXN0ID0gW107CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0sCiAgICAgIC8vIEhhdmUgdGhlIGxpc3QgZG8gbm90aGluZyBhbnltb3JlCiAgICAgIGRpc2FibGU6IGZ1bmN0aW9uKCkgewogICAgICAgIGxpc3QgPSBzdGFjayA9IG1lbW9yeSA9IHVuZGVmaW5lZDsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gSXMgaXQgZGlzYWJsZWQ/CiAgICAgIGRpc2FibGVkOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gIWxpc3Q7CiAgICAgIH0sCiAgICAgIC8vIExvY2sgdGhlIGxpc3QgaW4gaXRzIGN1cnJlbnQgc3RhdGUKICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgc3RhY2sgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKCAhbWVtb3J5ICkgewogICAgICAgICAgc2VsZi5kaXNhYmxlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBJcyBpdCBsb2NrZWQ/CiAgICAgIGxvY2tlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICFzdGFjazsKICAgICAgfSwKICAgICAgLy8gQ2FsbCBhbGwgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGNvbnRleHQgYW5kIGFyZ3VtZW50cwogICAgICBmaXJlV2l0aDogZnVuY3Rpb24oIGNvbnRleHQsIGFyZ3MgKSB7CiAgICAgICAgYXJncyA9IGFyZ3MgfHwgW107CiAgICAgICAgYXJncyA9IFsgY29udGV4dCwgYXJncy5zbGljZSA/IGFyZ3Muc2xpY2UoKSA6IGFyZ3MgXTsKICAgICAgICBpZiAoIGxpc3QgJiYgKCAhZmlyZWQgfHwgc3RhY2sgKSApIHsKICAgICAgICAgIGlmICggZmlyaW5nICkgewogICAgICAgICAgICBzdGFjay5wdXNoKCBhcmdzICk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmaXJlKCBhcmdzICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBDYWxsIGFsbCB0aGUgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cwogICAgICBmaXJlOiBmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLmZpcmVXaXRoKCB0aGlzLCBhcmd1bWVudHMgKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gVG8ga25vdyBpZiB0aGUgY2FsbGJhY2tzIGhhdmUgYWxyZWFkeSBiZWVuIGNhbGxlZCBhdCBsZWFzdCBvbmNlCiAgICAgIGZpcmVkOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gISFmaXJlZDsKICAgICAgfQogICAgfTsKCiAgcmV0dXJuIHNlbGY7Cn07CmpRdWVyeS5leHRlbmQoewoKICBEZWZlcnJlZDogZnVuY3Rpb24oIGZ1bmMgKSB7CiAgICB2YXIgdHVwbGVzID0gWwogICAgICAgIC8vIGFjdGlvbiwgYWRkIGxpc3RlbmVyLCBsaXN0ZW5lciBsaXN0LCBmaW5hbCBzdGF0ZQogICAgICAgIFsgInJlc29sdmUiLCAiZG9uZSIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZXNvbHZlZCIgXSwKICAgICAgICBbICJyZWplY3QiLCAiZmFpbCIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZWplY3RlZCIgXSwKICAgICAgICBbICJub3RpZnkiLCAicHJvZ3Jlc3MiLCBqUXVlcnkuQ2FsbGJhY2tzKCJtZW1vcnkiKSBdCiAgICAgIF0sCiAgICAgIHN0YXRlID0gInBlbmRpbmciLAogICAgICBwcm9taXNlID0gewogICAgICAgIHN0YXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICB9LAogICAgICAgIGFsd2F5czogZnVuY3Rpb24oKSB7CiAgICAgICAgICBkZWZlcnJlZC5kb25lKCBhcmd1bWVudHMgKS5mYWlsKCBhcmd1bWVudHMgKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgdGhlbjogZnVuY3Rpb24oIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovICkgewogICAgICAgICAgdmFyIGZucyA9IGFyZ3VtZW50czsKICAgICAgICAgIHJldHVybiBqUXVlcnkuRGVmZXJyZWQoZnVuY3Rpb24oIG5ld0RlZmVyICkgewogICAgICAgICAgICBqUXVlcnkuZWFjaCggdHVwbGVzLCBmdW5jdGlvbiggaSwgdHVwbGUgKSB7CiAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHR1cGxlWyAwIF0sCiAgICAgICAgICAgICAgICBmbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCBmbnNbIGkgXSApICYmIGZuc1sgaSBdOwogICAgICAgICAgICAgIC8vIGRlZmVycmVkWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gZm9yIGZvcndhcmRpbmcgYWN0aW9ucyB0byBuZXdEZWZlcgogICAgICAgICAgICAgIGRlZmVycmVkWyB0dXBsZVsxXSBdKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHJldHVybmVkID0gZm4gJiYgZm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogICAgICAgICAgICAgICAgaWYgKCByZXR1cm5lZCAmJiBqUXVlcnkuaXNGdW5jdGlvbiggcmV0dXJuZWQucHJvbWlzZSApICkgewogICAgICAgICAgICAgICAgICByZXR1cm5lZC5wcm9taXNlKCkKICAgICAgICAgICAgICAgICAgICAuZG9uZSggbmV3RGVmZXIucmVzb2x2ZSApCiAgICAgICAgICAgICAgICAgICAgLmZhaWwoIG5ld0RlZmVyLnJlamVjdCApCiAgICAgICAgICAgICAgICAgICAgLnByb2dyZXNzKCBuZXdEZWZlci5ub3RpZnkgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0RlZmVyWyBhY3Rpb24gKyAiV2l0aCIgXSggdGhpcyA9PT0gcHJvbWlzZSA/IG5ld0RlZmVyLnByb21pc2UoKSA6IHRoaXMsIGZuID8gWyByZXR1cm5lZCBdIDogYXJndW1lbnRzICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBmbnMgPSBudWxsOwogICAgICAgICAgfSkucHJvbWlzZSgpOwogICAgICAgIH0sCiAgICAgICAgLy8gR2V0IGEgcHJvbWlzZSBmb3IgdGhpcyBkZWZlcnJlZAogICAgICAgIC8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QKICAgICAgICBwcm9taXNlOiBmdW5jdGlvbiggb2JqICkgewogICAgICAgICAgcmV0dXJuIG9iaiAhPSBudWxsID8galF1ZXJ5LmV4dGVuZCggb2JqLCBwcm9taXNlICkgOiBwcm9taXNlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVmZXJyZWQgPSB7fTsKCiAgICAvLyBLZWVwIHBpcGUgZm9yIGJhY2stY29tcGF0CiAgICBwcm9taXNlLnBpcGUgPSBwcm9taXNlLnRoZW47CgogICAgLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcwogICAgalF1ZXJ5LmVhY2goIHR1cGxlcywgZnVuY3Rpb24oIGksIHR1cGxlICkgewogICAgICB2YXIgbGlzdCA9IHR1cGxlWyAyIF0sCiAgICAgICAgc3RhdGVTdHJpbmcgPSB0dXBsZVsgMyBdOwoKICAgICAgLy8gcHJvbWlzZVsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdID0gbGlzdC5hZGQKICAgICAgcHJvbWlzZVsgdHVwbGVbMV0gXSA9IGxpc3QuYWRkOwoKICAgICAgLy8gSGFuZGxlIHN0YXRlCiAgICAgIGlmICggc3RhdGVTdHJpbmcgKSB7CiAgICAgICAgbGlzdC5hZGQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBzdGF0ZSA9IFsgcmVzb2x2ZWQgfCByZWplY3RlZCBdCiAgICAgICAgICBzdGF0ZSA9IHN0YXRlU3RyaW5nOwoKICAgICAgICAvLyBbIHJlamVjdF9saXN0IHwgcmVzb2x2ZV9saXN0IF0uZGlzYWJsZTsgcHJvZ3Jlc3NfbGlzdC5sb2NrCiAgICAgICAgfSwgdHVwbGVzWyBpIF4gMSBdWyAyIF0uZGlzYWJsZSwgdHVwbGVzWyAyIF1bIDIgXS5sb2NrICk7CiAgICAgIH0KCiAgICAgIC8vIGRlZmVycmVkWyByZXNvbHZlIHwgcmVqZWN0IHwgbm90aWZ5IF0KICAgICAgZGVmZXJyZWRbIHR1cGxlWzBdIF0gPSBmdW5jdGlvbigpIHsKICAgICAgICBkZWZlcnJlZFsgdHVwbGVbMF0gKyAiV2l0aCIgXSggdGhpcyA9PT0gZGVmZXJyZWQgPyBwcm9taXNlIDogdGhpcywgYXJndW1lbnRzICk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH07CiAgICAgIGRlZmVycmVkWyB0dXBsZVswXSArICJXaXRoIiBdID0gbGlzdC5maXJlV2l0aDsKICAgIH0pOwoKICAgIC8vIE1ha2UgdGhlIGRlZmVycmVkIGEgcHJvbWlzZQogICAgcHJvbWlzZS5wcm9taXNlKCBkZWZlcnJlZCApOwoKICAgIC8vIENhbGwgZ2l2ZW4gZnVuYyBpZiBhbnkKICAgIGlmICggZnVuYyApIHsKICAgICAgZnVuYy5jYWxsKCBkZWZlcnJlZCwgZGVmZXJyZWQgKTsKICAgIH0KCiAgICAvLyBBbGwgZG9uZSEKICAgIHJldHVybiBkZWZlcnJlZDsKICB9LAoKICAvLyBEZWZlcnJlZCBoZWxwZXIKICB3aGVuOiBmdW5jdGlvbiggc3Vib3JkaW5hdGUgLyogLCAuLi4sIHN1Ym9yZGluYXRlTiAqLyApIHsKICAgIHZhciBpID0gMCwKICAgICAgcmVzb2x2ZVZhbHVlcyA9IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICksCiAgICAgIGxlbmd0aCA9IHJlc29sdmVWYWx1ZXMubGVuZ3RoLAoKICAgICAgLy8gdGhlIGNvdW50IG9mIHVuY29tcGxldGVkIHN1Ym9yZGluYXRlcwogICAgICByZW1haW5pbmcgPSBsZW5ndGggIT09IDEgfHwgKCBzdWJvcmRpbmF0ZSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggc3Vib3JkaW5hdGUucHJvbWlzZSApICkgPyBsZW5ndGggOiAwLAoKICAgICAgLy8gdGhlIG1hc3RlciBEZWZlcnJlZC4gSWYgcmVzb2x2ZVZhbHVlcyBjb25zaXN0IG9mIG9ubHkgYSBzaW5nbGUgRGVmZXJyZWQsIGp1c3QgdXNlIHRoYXQuCiAgICAgIGRlZmVycmVkID0gcmVtYWluaW5nID09PSAxID8gc3Vib3JkaW5hdGUgOiBqUXVlcnkuRGVmZXJyZWQoKSwKCiAgICAgIC8vIFVwZGF0ZSBmdW5jdGlvbiBmb3IgYm90aCByZXNvbHZlIGFuZCBwcm9ncmVzcyB2YWx1ZXMKICAgICAgdXBkYXRlRnVuYyA9IGZ1bmN0aW9uKCBpLCBjb250ZXh0cywgdmFsdWVzICkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiggdmFsdWUgKSB7CiAgICAgICAgICBjb250ZXh0c1sgaSBdID0gdGhpczsKICAgICAgICAgIHZhbHVlc1sgaSBdID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBjb3JlX3NsaWNlLmNhbGwoIGFyZ3VtZW50cyApIDogdmFsdWU7CiAgICAgICAgICBpZiggdmFsdWVzID09PSBwcm9ncmVzc1ZhbHVlcyApIHsKICAgICAgICAgICAgZGVmZXJyZWQubm90aWZ5V2l0aCggY29udGV4dHMsIHZhbHVlcyApOwogICAgICAgICAgfSBlbHNlIGlmICggISggLS1yZW1haW5pbmcgKSApIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNvbnRleHRzLCB2YWx1ZXMgKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9LAoKICAgICAgcHJvZ3Jlc3NWYWx1ZXMsIHByb2dyZXNzQ29udGV4dHMsIHJlc29sdmVDb250ZXh0czsKCiAgICAvLyBhZGQgbGlzdGVuZXJzIHRvIERlZmVycmVkIHN1Ym9yZGluYXRlczsgdHJlYXQgb3RoZXJzIGFzIHJlc29sdmVkCiAgICBpZiAoIGxlbmd0aCA+IDEgKSB7CiAgICAgIHByb2dyZXNzVmFsdWVzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKICAgICAgcHJvZ3Jlc3NDb250ZXh0cyA9IG5ldyBBcnJheSggbGVuZ3RoICk7CiAgICAgIHJlc29sdmVDb250ZXh0cyA9IG5ldyBBcnJheSggbGVuZ3RoICk7CiAgICAgIGZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewogICAgICAgIGlmICggcmVzb2x2ZVZhbHVlc1sgaSBdICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCByZXNvbHZlVmFsdWVzWyBpIF0ucHJvbWlzZSApICkgewogICAgICAgICAgcmVzb2x2ZVZhbHVlc1sgaSBdLnByb21pc2UoKQogICAgICAgICAgICAuZG9uZSggdXBkYXRlRnVuYyggaSwgcmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzICkgKQogICAgICAgICAgICAuZmFpbCggZGVmZXJyZWQucmVqZWN0ICkKICAgICAgICAgICAgLnByb2dyZXNzKCB1cGRhdGVGdW5jKCBpLCBwcm9ncmVzc0NvbnRleHRzLCBwcm9ncmVzc1ZhbHVlcyApICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC0tcmVtYWluaW5nOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIGlmIHdlJ3JlIG5vdCB3YWl0aW5nIG9uIGFueXRoaW5nLCByZXNvbHZlIHRoZSBtYXN0ZXIKICAgIGlmICggIXJlbWFpbmluZyApIHsKICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoIHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcyApOwogICAgfQoKICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CiAgfQp9KTsKalF1ZXJ5LnN1cHBvcnQgPSAoZnVuY3Rpb24oKSB7CgogIHZhciBzdXBwb3J0LCBhbGwsIGEsIHNlbGVjdCwgb3B0LCBpbnB1dCwgZnJhZ21lbnQsIGV2ZW50TmFtZSwgaXNTdXBwb3J0ZWQsIGksCiAgICBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgLy8gU2V0dXAKICBkaXYuc2V0QXR0cmlidXRlKCAiY2xhc3NOYW1lIiwgInQiICk7CiAgZGl2LmlubmVySFRNTCA9ICIgIDxsaW5rLz48dGFibGU+PC90YWJsZT48YSBocmVmPScvYSc+YTwvYT48aW5wdXQgdHlwZT0nY2hlY2tib3gnLz4iOwoKICAvLyBTdXBwb3J0IHRlc3RzIHdvbid0IHJ1biBpbiBzb21lIGxpbWl0ZWQgb3Igbm9uLWJyb3dzZXIgZW52aXJvbm1lbnRzCiAgYWxsID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIik7CiAgYSA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYSIpWyAwIF07CiAgaWYgKCAhYWxsIHx8ICFhIHx8ICFhbGwubGVuZ3RoICkgewogICAgcmV0dXJuIHt9OwogIH0KCiAgLy8gRmlyc3QgYmF0Y2ggb2YgdGVzdHMKICBzZWxlY3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzZWxlY3QiKTsKICBvcHQgPSBzZWxlY3QuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpICk7CiAgaW5wdXQgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImlucHV0IilbIDAgXTsKCiAgYS5zdHlsZS5jc3NUZXh0ID0gInRvcDoxcHg7ZmxvYXQ6bGVmdDtvcGFjaXR5Oi41IjsKICBzdXBwb3J0ID0gewogICAgLy8gVGVzdCBzZXRBdHRyaWJ1dGUgb24gY2FtZWxDYXNlIGNsYXNzLiBJZiBpdCB3b3Jrcywgd2UgbmVlZCBhdHRyRml4ZXMgd2hlbiBkb2luZyBnZXQvc2V0QXR0cmlidXRlIChpZTYvNykKICAgIGdldFNldEF0dHJpYnV0ZTogZGl2LmNsYXNzTmFtZSAhPT0gInQiLAoKICAgIC8vIElFIHN0cmlwcyBsZWFkaW5nIHdoaXRlc3BhY2Ugd2hlbiAuaW5uZXJIVE1MIGlzIHVzZWQKICAgIGxlYWRpbmdXaGl0ZXNwYWNlOiBkaXYuZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gMywKCiAgICAvLyBNYWtlIHN1cmUgdGhhdCB0Ym9keSBlbGVtZW50cyBhcmVuJ3QgYXV0b21hdGljYWxseSBpbnNlcnRlZAogICAgLy8gSUUgd2lsbCBpbnNlcnQgdGhlbSBpbnRvIGVtcHR5IHRhYmxlcwogICAgdGJvZHk6ICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRib2R5IikubGVuZ3RoLAoKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGxpbmsgZWxlbWVudHMgZ2V0IHNlcmlhbGl6ZWQgY29ycmVjdGx5IGJ5IGlubmVySFRNTAogICAgLy8gVGhpcyByZXF1aXJlcyBhIHdyYXBwZXIgZWxlbWVudCBpbiBJRQogICAgaHRtbFNlcmlhbGl6ZTogISFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpbmsiKS5sZW5ndGgsCgogICAgLy8gR2V0IHRoZSBzdHlsZSBpbmZvcm1hdGlvbiBmcm9tIGdldEF0dHJpYnV0ZQogICAgLy8gKElFIHVzZXMgLmNzc1RleHQgaW5zdGVhZCkKICAgIHN0eWxlOiAvdG9wLy50ZXN0KCBhLmdldEF0dHJpYnV0ZSgic3R5bGUiKSApLAoKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IFVSTHMgYXJlbid0IG1hbmlwdWxhdGVkCiAgICAvLyAoSUUgbm9ybWFsaXplcyBpdCBieSBkZWZhdWx0KQogICAgaHJlZk5vcm1hbGl6ZWQ6IGEuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIvYSIsCgogICAgLy8gTWFrZSBzdXJlIHRoYXQgZWxlbWVudCBvcGFjaXR5IGV4aXN0cwogICAgLy8gKElFIHVzZXMgZmlsdGVyIGluc3RlYWQpCiAgICAvLyBVc2UgYSByZWdleCB0byB3b3JrIGFyb3VuZCBhIFdlYktpdCBpc3N1ZS4gU2VlICM1MTQ1CiAgICBvcGFjaXR5OiAvXjAuNS8udGVzdCggYS5zdHlsZS5vcGFjaXR5ICksCgogICAgLy8gVmVyaWZ5IHN0eWxlIGZsb2F0IGV4aXN0ZW5jZQogICAgLy8gKElFIHVzZXMgc3R5bGVGbG9hdCBpbnN0ZWFkIG9mIGNzc0Zsb2F0KQogICAgY3NzRmxvYXQ6ICEhYS5zdHlsZS5jc3NGbG9hdCwKCiAgICAvLyBDaGVjayB0aGUgZGVmYXVsdCBjaGVja2JveC9yYWRpbyB2YWx1ZSAoIiIgb24gV2ViS2l0OyAib24iIGVsc2V3aGVyZSkKICAgIGNoZWNrT246ICEhaW5wdXQudmFsdWUsCgogICAgLy8gTWFrZSBzdXJlIHRoYXQgYSBzZWxlY3RlZC1ieS1kZWZhdWx0IG9wdGlvbiBoYXMgYSB3b3JraW5nIHNlbGVjdGVkIHByb3BlcnR5LgogICAgLy8gKFdlYktpdCBkZWZhdWx0cyB0byBmYWxzZSBpbnN0ZWFkIG9mIHRydWUsIElFIHRvbywgaWYgaXQncyBpbiBhbiBvcHRncm91cCkKICAgIG9wdFNlbGVjdGVkOiBvcHQuc2VsZWN0ZWQsCgogICAgLy8gVGVzdHMgZm9yIGVuY3R5cGUgc3VwcG9ydCBvbiBhIGZvcm0gKCM2NzQzKQogICAgZW5jdHlwZTogISFkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIikuZW5jdHlwZSwKCiAgICAvLyBNYWtlcyBzdXJlIGNsb25pbmcgYW4gaHRtbDUgZWxlbWVudCBkb2VzIG5vdCBjYXVzZSBwcm9ibGVtcwogICAgLy8gV2hlcmUgb3V0ZXJIVE1MIGlzIHVuZGVmaW5lZCwgdGhpcyBzdGlsbCB3b3JrcwogICAgaHRtbDVDbG9uZTogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibmF2IikuY2xvbmVOb2RlKCB0cnVlICkub3V0ZXJIVE1MICE9PSAiPDpuYXY+PC86bmF2PiIsCgogICAgLy8galF1ZXJ5LnN1cHBvcnQuYm94TW9kZWwgREVQUkVDQVRFRCBpbiAxLjggc2luY2Ugd2UgZG9uJ3Qgc3VwcG9ydCBRdWlya3MgTW9kZQogICAgYm94TW9kZWw6IGRvY3VtZW50LmNvbXBhdE1vZGUgPT09ICJDU1MxQ29tcGF0IiwKCiAgICAvLyBXaWxsIGJlIGRlZmluZWQgbGF0ZXIKICAgIGRlbGV0ZUV4cGFuZG86IHRydWUsCiAgICBub0Nsb25lRXZlbnQ6IHRydWUsCiAgICBpbmxpbmVCbG9ja05lZWRzTGF5b3V0OiBmYWxzZSwKICAgIHNocmlua1dyYXBCbG9ja3M6IGZhbHNlLAogICAgcmVsaWFibGVNYXJnaW5SaWdodDogdHJ1ZSwKICAgIGJveFNpemluZ1JlbGlhYmxlOiB0cnVlLAogICAgcGl4ZWxQb3NpdGlvbjogZmFsc2UKICB9OwoKICAvLyBNYWtlIHN1cmUgY2hlY2tlZCBzdGF0dXMgaXMgcHJvcGVybHkgY2xvbmVkCiAgaW5wdXQuY2hlY2tlZCA9IHRydWU7CiAgc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCA9IGlucHV0LmNsb25lTm9kZSggdHJ1ZSApLmNoZWNrZWQ7CgogIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKICAvLyAoV2ViS2l0IG1hcmtzIHRoZW0gYXMgZGlzYWJsZWQpCiAgc2VsZWN0LmRpc2FibGVkID0gdHJ1ZTsKICBzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKCiAgLy8gU3VwcG9ydDogSUU8OQogIHRyeSB7CiAgICBkZWxldGUgZGl2LnRlc3Q7CiAgfSBjYXRjaCggZSApIHsKICAgIHN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9IGZhbHNlOwogIH0KCiAgLy8gQ2hlY2sgaWYgd2UgY2FuIHRydXN0IGdldEF0dHJpYnV0ZSgidmFsdWUiKQogIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICBpbnB1dC5zZXRBdHRyaWJ1dGUoICJ2YWx1ZSIsICIiICk7CiAgc3VwcG9ydC5pbnB1dCA9IGlucHV0LmdldEF0dHJpYnV0ZSggInZhbHVlIiApID09PSAiIjsKCiAgLy8gQ2hlY2sgaWYgYW4gaW5wdXQgbWFpbnRhaW5zIGl0cyB2YWx1ZSBhZnRlciBiZWNvbWluZyBhIHJhZGlvCiAgaW5wdXQudmFsdWUgPSAidCI7CiAgaW5wdXQuc2V0QXR0cmlidXRlKCAidHlwZSIsICJyYWRpbyIgKTsKICBzdXBwb3J0LnJhZGlvVmFsdWUgPSBpbnB1dC52YWx1ZSA9PT0gInQiOwoKICAvLyAjMTEyMTcgLSBXZWJLaXQgbG9zZXMgY2hlY2sgd2hlbiB0aGUgbmFtZSBpcyBhZnRlciB0aGUgY2hlY2tlZCBhdHRyaWJ1dGUKICBpbnB1dC5zZXRBdHRyaWJ1dGUoICJjaGVja2VkIiwgInQiICk7CiAgaW5wdXQuc2V0QXR0cmlidXRlKCAibmFtZSIsICJ0IiApOwoKICBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICBmcmFnbWVudC5hcHBlbmRDaGlsZCggaW5wdXQgKTsKCiAgLy8gQ2hlY2sgaWYgYSBkaXNjb25uZWN0ZWQgY2hlY2tib3ggd2lsbCByZXRhaW4gaXRzIGNoZWNrZWQKICAvLyB2YWx1ZSBvZiB0cnVlIGFmdGVyIGFwcGVuZGVkIHRvIHRoZSBET00gKElFNi83KQogIHN1cHBvcnQuYXBwZW5kQ2hlY2tlZCA9IGlucHV0LmNoZWNrZWQ7CgogIC8vIFdlYktpdCBkb2Vzbid0IGNsb25lIGNoZWNrZWQgc3RhdGUgY29ycmVjdGx5IGluIGZyYWdtZW50cwogIHN1cHBvcnQuY2hlY2tDbG9uZSA9IGZyYWdtZW50LmNsb25lTm9kZSggdHJ1ZSApLmNsb25lTm9kZSggdHJ1ZSApLmxhc3RDaGlsZC5jaGVja2VkOwoKICAvLyBTdXBwb3J0OiBJRTw5CiAgLy8gT3BlcmEgZG9lcyBub3QgY2xvbmUgZXZlbnRzIChhbmQgdHlwZW9mIGRpdi5hdHRhY2hFdmVudCA9PT0gdW5kZWZpbmVkKS4KICAvLyBJRTktMTAgY2xvbmVzIGV2ZW50cyBib3VuZCB2aWEgYXR0YWNoRXZlbnQsIGJ1dCB0aGV5IGRvbid0IHRyaWdnZXIgd2l0aCAuY2xpY2soKQogIGlmICggZGl2LmF0dGFjaEV2ZW50ICkgewogICAgZGl2LmF0dGFjaEV2ZW50KCAib25jbGljayIsIGZ1bmN0aW9uKCkgewogICAgICBzdXBwb3J0Lm5vQ2xvbmVFdmVudCA9IGZhbHNlOwogICAgfSk7CgogICAgZGl2LmNsb25lTm9kZSggdHJ1ZSApLmNsaWNrKCk7CiAgfQoKICAvLyBTdXBwb3J0OiBJRTw5IChsYWNrIHN1Ym1pdC9jaGFuZ2UgYnViYmxlKSwgRmlyZWZveCAxNysgKGxhY2sgZm9jdXNpbiBldmVudCkKICAvLyBCZXdhcmUgb2YgQ1NQIHJlc3RyaWN0aW9ucyAoaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQKSwgdGVzdC9jc3AucGhwCiAgZm9yICggaSBpbiB7IHN1Ym1pdDogdHJ1ZSwgY2hhbmdlOiB0cnVlLCBmb2N1c2luOiB0cnVlIH0pIHsKICAgIGRpdi5zZXRBdHRyaWJ1dGUoIGV2ZW50TmFtZSA9ICJvbiIgKyBpLCAidCIgKTsKCiAgICBzdXBwb3J0WyBpICsgIkJ1YmJsZXMiIF0gPSBldmVudE5hbWUgaW4gd2luZG93IHx8IGRpdi5hdHRyaWJ1dGVzWyBldmVudE5hbWUgXS5leHBhbmRvID09PSBmYWxzZTsKICB9CgogIGRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICJjb250ZW50LWJveCI7CiAgZGl2LmNsb25lTm9kZSggdHJ1ZSApLnN0eWxlLmJhY2tncm91bmRDbGlwID0gIiI7CiAgc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgPSBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPT09ICJjb250ZW50LWJveCI7CgogIC8vIFJ1biB0ZXN0cyB0aGF0IG5lZWQgYSBib2R5IGF0IGRvYyByZWFkeQogIGpRdWVyeShmdW5jdGlvbigpIHsKICAgIHZhciBjb250YWluZXIsIG1hcmdpbkRpdiwgdGRzLAogICAgICBkaXZSZXNldCA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjA7ZGlzcGxheTpibG9jaztib3gtc2l6aW5nOmNvbnRlbnQtYm94Oy1tb3otYm94LXNpemluZzpjb250ZW50LWJveDstd2Via2l0LWJveC1zaXppbmc6Y29udGVudC1ib3g7IiwKICAgICAgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF07CgogICAgaWYgKCAhYm9keSApIHsKICAgICAgLy8gUmV0dXJuIGZvciBmcmFtZXNldCBkb2NzIHRoYXQgZG9uJ3QgaGF2ZSBhIGJvZHkKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAiYm9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDtwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtsZWZ0Oi05OTk5cHg7bWFyZ2luLXRvcDoxcHgiOwoKICAgIGJvZHkuYXBwZW5kQ2hpbGQoIGNvbnRhaW5lciApLmFwcGVuZENoaWxkKCBkaXYgKTsKCiAgICAvLyBTdXBwb3J0OiBJRTgKICAgIC8vIENoZWNrIGlmIHRhYmxlIGNlbGxzIHN0aWxsIGhhdmUgb2Zmc2V0V2lkdGgvSGVpZ2h0IHdoZW4gdGhleSBhcmUgc2V0CiAgICAvLyB0byBkaXNwbGF5Om5vbmUgYW5kIHRoZXJlIGFyZSBzdGlsbCBvdGhlciB2aXNpYmxlIHRhYmxlIGNlbGxzIGluIGEKICAgIC8vIHRhYmxlIHJvdzsgaWYgc28sIG9mZnNldFdpZHRoL0hlaWdodCBhcmUgbm90IHJlbGlhYmxlIGZvciB1c2Ugd2hlbgogICAgLy8gZGV0ZXJtaW5pbmcgaWYgYW4gZWxlbWVudCBoYXMgYmVlbiBoaWRkZW4gZGlyZWN0bHkgdXNpbmcKICAgIC8vIGRpc3BsYXk6bm9uZSAoaXQgaXMgc3RpbGwgc2FmZSB0byB1c2Ugb2Zmc2V0cyBpZiBhIHBhcmVudCBlbGVtZW50IGlzCiAgICAvLyBoaWRkZW47IGRvbiBzYWZldHkgZ29nZ2xlcyBhbmQgc2VlIGJ1ZyAjNDUxMiBmb3IgbW9yZSBpbmZvcm1hdGlvbikuCiAgICBkaXYuaW5uZXJIVE1MID0gIjx0YWJsZT48dHI+PHRkPjwvdGQ+PHRkPnQ8L3RkPjwvdHI+PC90YWJsZT4iOwogICAgdGRzID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0ZCIpOwogICAgdGRzWyAwIF0uc3R5bGUuY3NzVGV4dCA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjA7ZGlzcGxheTpub25lIjsKICAgIGlzU3VwcG9ydGVkID0gKCB0ZHNbIDAgXS5vZmZzZXRIZWlnaHQgPT09IDAgKTsKCiAgICB0ZHNbIDAgXS5zdHlsZS5kaXNwbGF5ID0gIiI7CiAgICB0ZHNbIDEgXS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKICAgIC8vIFN1cHBvcnQ6IElFOAogICAgLy8gQ2hlY2sgaWYgZW1wdHkgdGFibGUgY2VsbHMgc3RpbGwgaGF2ZSBvZmZzZXRXaWR0aC9IZWlnaHQKICAgIHN1cHBvcnQucmVsaWFibGVIaWRkZW5PZmZzZXRzID0gaXNTdXBwb3J0ZWQgJiYgKCB0ZHNbIDAgXS5vZmZzZXRIZWlnaHQgPT09IDAgKTsKCiAgICAvLyBDaGVjayBib3gtc2l6aW5nIGFuZCBtYXJnaW4gYmVoYXZpb3IKICAgIGRpdi5pbm5lckhUTUwgPSAiIjsKICAgIGRpdi5zdHlsZS5jc3NUZXh0ID0gImJveC1zaXppbmc6Ym9yZGVyLWJveDstbW96LWJveC1zaXppbmc6Ym9yZGVyLWJveDstd2Via2l0LWJveC1zaXppbmc6Ym9yZGVyLWJveDtwYWRkaW5nOjFweDtib3JkZXI6MXB4O2Rpc3BsYXk6YmxvY2s7d2lkdGg6NHB4O21hcmdpbi10b3A6MSU7cG9zaXRpb246YWJzb2x1dGU7dG9wOjElOyI7CiAgICBzdXBwb3J0LmJveFNpemluZyA9ICggZGl2Lm9mZnNldFdpZHRoID09PSA0ICk7CiAgICBzdXBwb3J0LmRvZXNOb3RJbmNsdWRlTWFyZ2luSW5Cb2R5T2Zmc2V0ID0gKCBib2R5Lm9mZnNldFRvcCAhPT0gMSApOwoKICAgIC8vIFVzZSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0LgogICAgaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKICAgICAgc3VwcG9ydC5waXhlbFBvc2l0aW9uID0gKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZGl2LCBudWxsICkgfHwge30gKS50b3AgIT09ICIxJSI7CiAgICAgIHN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUgPSAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBkaXYsIG51bGwgKSB8fCB7IHdpZHRoOiAiNHB4IiB9ICkud2lkdGggPT09ICI0cHgiOwoKICAgICAgLy8gQ2hlY2sgaWYgZGl2IHdpdGggZXhwbGljaXQgd2lkdGggYW5kIG5vIG1hcmdpbi1yaWdodCBpbmNvcnJlY3RseQogICAgICAvLyBnZXRzIGNvbXB1dGVkIG1hcmdpbi1yaWdodCBiYXNlZCBvbiB3aWR0aCBvZiBjb250YWluZXIuICgjMzMzMykKICAgICAgLy8gRmFpbHMgaW4gV2ViS2l0IGJlZm9yZSBGZWIgMjAxMSBuaWdodGxpZXMKICAgICAgLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CiAgICAgIG1hcmdpbkRpdiA9IGRpdi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikgKTsKICAgICAgbWFyZ2luRGl2LnN0eWxlLmNzc1RleHQgPSBkaXYuc3R5bGUuY3NzVGV4dCA9IGRpdlJlc2V0OwogICAgICBtYXJnaW5EaXYuc3R5bGUubWFyZ2luUmlnaHQgPSBtYXJnaW5EaXYuc3R5bGUud2lkdGggPSAiMCI7CiAgICAgIGRpdi5zdHlsZS53aWR0aCA9ICIxcHgiOwoKICAgICAgc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ID0KICAgICAgICAhcGFyc2VGbG9hdCggKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggbWFyZ2luRGl2LCBudWxsICkgfHwge30gKS5tYXJnaW5SaWdodCApOwogICAgfQoKICAgIGlmICggdHlwZW9mIGRpdi5zdHlsZS56b29tICE9PSAidW5kZWZpbmVkIiApIHsKICAgICAgLy8gU3VwcG9ydDogSUU8OAogICAgICAvLyBDaGVjayBpZiBuYXRpdmVseSBibG9jay1sZXZlbCBlbGVtZW50cyBhY3QgbGlrZSBpbmxpbmUtYmxvY2sKICAgICAgLy8gZWxlbWVudHMgd2hlbiBzZXR0aW5nIHRoZWlyIGRpc3BsYXkgdG8gJ2lubGluZScgYW5kIGdpdmluZwogICAgICAvLyB0aGVtIGxheW91dAogICAgICBkaXYuaW5uZXJIVE1MID0gIiI7CiAgICAgIGRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2UmVzZXQgKyAid2lkdGg6MXB4O3BhZGRpbmc6MXB4O2Rpc3BsYXk6aW5saW5lO3pvb206MSI7CiAgICAgIHN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCA9ICggZGl2Lm9mZnNldFdpZHRoID09PSAzICk7CgogICAgICAvLyBTdXBwb3J0OiBJRTYKICAgICAgLy8gQ2hlY2sgaWYgZWxlbWVudHMgd2l0aCBsYXlvdXQgc2hyaW5rLXdyYXAgdGhlaXIgY2hpbGRyZW4KICAgICAgZGl2LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICBkaXYuaW5uZXJIVE1MID0gIjxkaXY+PC9kaXY+IjsKICAgICAgZGl2LmZpcnN0Q2hpbGQuc3R5bGUud2lkdGggPSAiNXB4IjsKICAgICAgc3VwcG9ydC5zaHJpbmtXcmFwQmxvY2tzID0gKCBkaXYub2Zmc2V0V2lkdGggIT09IDMgKTsKCiAgICAgIC8vIFByZXZlbnQgSUUgNiBmcm9tIGFmZmVjdGluZyBsYXlvdXQgZm9yIHBvc2l0aW9uZWQgZWxlbWVudHMgIzExMDQ4CiAgICAgIC8vIFByZXZlbnQgSUUgZnJvbSBzaHJpbmtpbmcgdGhlIGJvZHkgaW4gSUUgNyBtb2RlICMxMjg2OQogICAgICBib2R5LnN0eWxlLnpvb20gPSAxOwogICAgfQoKICAgIGJvZHkucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoKICAgIC8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUKICAgIGNvbnRhaW5lciA9IGRpdiA9IHRkcyA9IG1hcmdpbkRpdiA9IG51bGw7CiAgfSk7CgogIC8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUKICBhbGwgPSBzZWxlY3QgPSBmcmFnbWVudCA9IG9wdCA9IGEgPSBpbnB1dCA9IG51bGw7CgogIHJldHVybiBzdXBwb3J0Owp9KSgpOwoKdmFyIHJicmFjZSA9IC8oPzpce1tcc1xTXSpcfXxcW1tcc1xTXSpcXSkkLywKICBybXVsdGlEYXNoID0gLyhbQS1aXSkvZzsKICAKZnVuY3Rpb24gaW50ZXJuYWxEYXRhKCBlbGVtLCBuYW1lLCBkYXRhLCBwdnQgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKXsKICBpZiAoICFqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHRoaXNDYWNoZSwgcmV0LAogICAgaW50ZXJuYWxLZXkgPSBqUXVlcnkuZXhwYW5kbywKICAgIGdldEJ5TmFtZSA9IHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiwKCiAgICAvLyBXZSBoYXZlIHRvIGhhbmRsZSBET00gbm9kZXMgYW5kIEpTIG9iamVjdHMgZGlmZmVyZW50bHkgYmVjYXVzZSBJRTYtNwogICAgLy8gY2FuJ3QgR0Mgb2JqZWN0IHJlZmVyZW5jZXMgcHJvcGVybHkgYWNyb3NzIHRoZSBET00tSlMgYm91bmRhcnkKICAgIGlzTm9kZSA9IGVsZW0ubm9kZVR5cGUsCgogICAgLy8gT25seSBET00gbm9kZXMgbmVlZCB0aGUgZ2xvYmFsIGpRdWVyeSBjYWNoZTsgSlMgb2JqZWN0IGRhdGEgaXMKICAgIC8vIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSBvYmplY3Qgc28gR0MgY2FuIG9jY3VyIGF1dG9tYXRpY2FsbHkKICAgIGNhY2hlID0gaXNOb2RlID8galF1ZXJ5LmNhY2hlIDogZWxlbSwKCiAgICAvLyBPbmx5IGRlZmluaW5nIGFuIElEIGZvciBKUyBvYmplY3RzIGlmIGl0cyBjYWNoZSBhbHJlYWR5IGV4aXN0cyBhbGxvd3MKICAgIC8vIHRoZSBjb2RlIHRvIHNob3J0Y3V0IG9uIHRoZSBzYW1lIHBhdGggYXMgYSBET00gbm9kZSB3aXRoIG5vIGNhY2hlCiAgICBpZCA9IGlzTm9kZSA/IGVsZW1bIGludGVybmFsS2V5IF0gOiBlbGVtWyBpbnRlcm5hbEtleSBdICYmIGludGVybmFsS2V5OwoKICAvLyBBdm9pZCBkb2luZyBhbnkgbW9yZSB3b3JrIHRoYW4gd2UgbmVlZCB0byB3aGVuIHRyeWluZyB0byBnZXQgZGF0YSBvbiBhbgogIC8vIG9iamVjdCB0aGF0IGhhcyBubyBkYXRhIGF0IGFsbAogIGlmICggKCFpZCB8fCAhY2FjaGVbaWRdIHx8ICghcHZ0ICYmICFjYWNoZVtpZF0uZGF0YSkpICYmIGdldEJ5TmFtZSAmJiBkYXRhID09PSB1bmRlZmluZWQgKSB7CiAgICByZXR1cm47CiAgfQoKICBpZiAoICFpZCApIHsKICAgIC8vIE9ubHkgRE9NIG5vZGVzIG5lZWQgYSBuZXcgdW5pcXVlIElEIGZvciBlYWNoIGVsZW1lbnQgc2luY2UgdGhlaXIgZGF0YQogICAgLy8gZW5kcyB1cCBpbiB0aGUgZ2xvYmFsIGNhY2hlCiAgICBpZiAoIGlzTm9kZSApIHsKICAgICAgZWxlbVsgaW50ZXJuYWxLZXkgXSA9IGlkID0gY29yZV9kZWxldGVkSWRzLnBvcCgpIHx8IGpRdWVyeS5ndWlkKys7CiAgICB9IGVsc2UgewogICAgICBpZCA9IGludGVybmFsS2V5OwogICAgfQogIH0KCiAgaWYgKCAhY2FjaGVbIGlkIF0gKSB7CiAgICBjYWNoZVsgaWQgXSA9IHt9OwoKICAgIC8vIEF2b2lkcyBleHBvc2luZyBqUXVlcnkgbWV0YWRhdGEgb24gcGxhaW4gSlMgb2JqZWN0cyB3aGVuIHRoZSBvYmplY3QKICAgIC8vIGlzIHNlcmlhbGl6ZWQgdXNpbmcgSlNPTi5zdHJpbmdpZnkKICAgIGlmICggIWlzTm9kZSApIHsKICAgICAgY2FjaGVbIGlkIF0udG9KU09OID0galF1ZXJ5Lm5vb3A7CiAgICB9CiAgfQoKICAvLyBBbiBvYmplY3QgY2FuIGJlIHBhc3NlZCB0byBqUXVlcnkuZGF0YSBpbnN0ZWFkIG9mIGEga2V5L3ZhbHVlIHBhaXI7IHRoaXMgZ2V0cwogIC8vIHNoYWxsb3cgY29waWVkIG92ZXIgb250byB0aGUgZXhpc3RpbmcgY2FjaGUKICBpZiAoIHR5cGVvZiBuYW1lID09PSAib2JqZWN0IiB8fCB0eXBlb2YgbmFtZSA9PT0gImZ1bmN0aW9uIiApIHsKICAgIGlmICggcHZ0ICkgewogICAgICBjYWNoZVsgaWQgXSA9IGpRdWVyeS5leHRlbmQoIGNhY2hlWyBpZCBdLCBuYW1lICk7CiAgICB9IGVsc2UgewogICAgICBjYWNoZVsgaWQgXS5kYXRhID0galF1ZXJ5LmV4dGVuZCggY2FjaGVbIGlkIF0uZGF0YSwgbmFtZSApOwogICAgfQogIH0KCiAgdGhpc0NhY2hlID0gY2FjaGVbIGlkIF07CgogIC8vIGpRdWVyeSBkYXRhKCkgaXMgc3RvcmVkIGluIGEgc2VwYXJhdGUgb2JqZWN0IGluc2lkZSB0aGUgb2JqZWN0J3MgaW50ZXJuYWwgZGF0YQogIC8vIGNhY2hlIGluIG9yZGVyIHRvIGF2b2lkIGtleSBjb2xsaXNpb25zIGJldHdlZW4gaW50ZXJuYWwgZGF0YSBhbmQgdXNlci1kZWZpbmVkCiAgLy8gZGF0YS4KICBpZiAoICFwdnQgKSB7CiAgICBpZiAoICF0aGlzQ2FjaGUuZGF0YSApIHsKICAgICAgdGhpc0NhY2hlLmRhdGEgPSB7fTsKICAgIH0KCiAgICB0aGlzQ2FjaGUgPSB0aGlzQ2FjaGUuZGF0YTsKICB9CgogIGlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgewogICAgdGhpc0NhY2hlWyBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICkgXSA9IGRhdGE7CiAgfQoKICAvLyBDaGVjayBmb3IgYm90aCBjb252ZXJ0ZWQtdG8tY2FtZWwgYW5kIG5vbi1jb252ZXJ0ZWQgZGF0YSBwcm9wZXJ0eSBuYW1lcwogIC8vIElmIGEgZGF0YSBwcm9wZXJ0eSB3YXMgc3BlY2lmaWVkCiAgaWYgKCBnZXRCeU5hbWUgKSB7CgogICAgLy8gRmlyc3QgVHJ5IHRvIGZpbmQgYXMtaXMgcHJvcGVydHkgZGF0YQogICAgcmV0ID0gdGhpc0NhY2hlWyBuYW1lIF07CgogICAgLy8gVGVzdCBmb3IgbnVsbHx1bmRlZmluZWQgcHJvcGVydHkgZGF0YQogICAgaWYgKCByZXQgPT0gbnVsbCApIHsKCiAgICAgIC8vIFRyeSB0byBmaW5kIHRoZSBjYW1lbENhc2VkIHByb3BlcnR5CiAgICAgIHJldCA9IHRoaXNDYWNoZVsgalF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApIF07CiAgICB9CiAgfSBlbHNlIHsKICAgIHJldCA9IHRoaXNDYWNoZTsKICB9CgogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGludGVybmFsUmVtb3ZlRGF0YSggZWxlbSwgbmFtZSwgcHZ0IC8qIEZvciBpbnRlcm5hbCB1c2Ugb25seSAqLyApewogIGlmICggIWpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgdGhpc0NhY2hlLCBpLCBsLAoKICAgIGlzTm9kZSA9IGVsZW0ubm9kZVR5cGUsCgogICAgLy8gU2VlIGpRdWVyeS5kYXRhIGZvciBtb3JlIGluZm9ybWF0aW9uCiAgICBjYWNoZSA9IGlzTm9kZSA/IGpRdWVyeS5jYWNoZSA6IGVsZW0sCiAgICBpZCA9IGlzTm9kZSA/IGVsZW1bIGpRdWVyeS5leHBhbmRvIF0gOiBqUXVlcnkuZXhwYW5kbzsKCiAgLy8gSWYgdGhlcmUgaXMgYWxyZWFkeSBubyBjYWNoZSBlbnRyeSBmb3IgdGhpcyBvYmplY3QsIHRoZXJlIGlzIG5vCiAgLy8gcHVycG9zZSBpbiBjb250aW51aW5nCiAgaWYgKCAhY2FjaGVbIGlkIF0gKSB7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIG5hbWUgKSB7CgogICAgdGhpc0NhY2hlID0gcHZ0ID8gY2FjaGVbIGlkIF0gOiBjYWNoZVsgaWQgXS5kYXRhOwoKICAgIGlmICggdGhpc0NhY2hlICkgewoKICAgICAgLy8gU3VwcG9ydCBhcnJheSBvciBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIG5hbWVzIGZvciBkYXRhIGtleXMKICAgICAgaWYgKCAhalF1ZXJ5LmlzQXJyYXkoIG5hbWUgKSApIHsKCiAgICAgICAgLy8gdHJ5IHRoZSBzdHJpbmcgYXMgYSBrZXkgYmVmb3JlIGFueSBtYW5pcHVsYXRpb24KICAgICAgICBpZiAoIG5hbWUgaW4gdGhpc0NhY2hlICkgewogICAgICAgICAgbmFtZSA9IFsgbmFtZSBdOwogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgLy8gc3BsaXQgdGhlIGNhbWVsIGNhc2VkIHZlcnNpb24gYnkgc3BhY2VzIHVubGVzcyBhIGtleSB3aXRoIHRoZSBzcGFjZXMgZXhpc3RzCiAgICAgICAgICBuYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApOwogICAgICAgICAgaWYgKCBuYW1lIGluIHRoaXNDYWNoZSApIHsKICAgICAgICAgICAgbmFtZSA9IFsgbmFtZSBdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3BsaXQoIiAiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgIm5hbWUiIGlzIGFuIGFycmF5IG9mIGtleXMuLi4KICAgICAgICAvLyBXaGVuIGRhdGEgaXMgaW5pdGlhbGx5IGNyZWF0ZWQsIHZpYSAoImtleSIsICJ2YWwiKSBzaWduYXR1cmUsCiAgICAgICAgLy8ga2V5cyB3aWxsIGJlIGNvbnZlcnRlZCB0byBjYW1lbENhc2UuCiAgICAgICAgLy8gU2luY2UgdGhlcmUgaXMgbm8gd2F5IHRvIHRlbGwgX2hvd18gYSBrZXkgd2FzIGFkZGVkLCByZW1vdmUKICAgICAgICAvLyBib3RoIHBsYWluIGtleSBhbmQgY2FtZWxDYXNlIGtleS4gIzEyNzg2CiAgICAgICAgLy8gVGhpcyB3aWxsIG9ubHkgcGVuYWxpemUgdGhlIGFycmF5IGFyZ3VtZW50IHBhdGguCiAgICAgICAgbmFtZSA9IG5hbWUuY29uY2F0KCBqUXVlcnkubWFwKCBuYW1lLCBqUXVlcnkuY2FtZWxDYXNlICkgKTsKICAgICAgfQoKICAgICAgZm9yICggaSA9IDAsIGwgPSBuYW1lLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKICAgICAgICBkZWxldGUgdGhpc0NhY2hlWyBuYW1lW2ldIF07CiAgICAgIH0KCiAgICAgIC8vIElmIHRoZXJlIGlzIG5vIGRhdGEgbGVmdCBpbiB0aGUgY2FjaGUsIHdlIHdhbnQgdG8gY29udGludWUKICAgICAgLy8gYW5kIGxldCB0aGUgY2FjaGUgb2JqZWN0IGl0c2VsZiBnZXQgZGVzdHJveWVkCiAgICAgIGlmICggISggcHZ0ID8gaXNFbXB0eURhdGFPYmplY3QgOiBqUXVlcnkuaXNFbXB0eU9iamVjdCApKCB0aGlzQ2FjaGUgKSApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9CgogIC8vIFNlZSBqUXVlcnkuZGF0YSBmb3IgbW9yZSBpbmZvcm1hdGlvbgogIGlmICggIXB2dCApIHsKICAgIGRlbGV0ZSBjYWNoZVsgaWQgXS5kYXRhOwoKICAgIC8vIERvbid0IGRlc3Ryb3kgdGhlIHBhcmVudCBjYWNoZSB1bmxlc3MgdGhlIGludGVybmFsIGRhdGEgb2JqZWN0CiAgICAvLyBoYWQgYmVlbiB0aGUgb25seSB0aGluZyBsZWZ0IGluIGl0CiAgICBpZiAoICFpc0VtcHR5RGF0YU9iamVjdCggY2FjaGVbIGlkIF0gKSApIHsKICAgICAgcmV0dXJuOwogICAgfQogIH0KCiAgLy8gRGVzdHJveSB0aGUgY2FjaGUKICBpZiAoIGlzTm9kZSApIHsKICAgIGpRdWVyeS5jbGVhbkRhdGEoIFsgZWxlbSBdLCB0cnVlICk7CgogIC8vIFVzZSBkZWxldGUgd2hlbiBzdXBwb3J0ZWQgZm9yIGV4cGFuZG9zIG9yIGBjYWNoZWAgaXMgbm90IGEgd2luZG93IHBlciBpc1dpbmRvdyAoIzEwMDgwKQogIH0gZWxzZSBpZiAoIGpRdWVyeS5zdXBwb3J0LmRlbGV0ZUV4cGFuZG8gfHwgY2FjaGUgIT0gY2FjaGUud2luZG93ICkgewogICAgZGVsZXRlIGNhY2hlWyBpZCBdOwoKICAvLyBXaGVuIGFsbCBlbHNlIGZhaWxzLCBudWxsCiAgfSBlbHNlIHsKICAgIGNhY2hlWyBpZCBdID0gbnVsbDsKICB9Cn0KCmpRdWVyeS5leHRlbmQoewogIGNhY2hlOiB7fSwKCiAgLy8gVW5pcXVlIGZvciBlYWNoIGNvcHkgb2YgalF1ZXJ5IG9uIHRoZSBwYWdlCiAgLy8gTm9uLWRpZ2l0cyByZW1vdmVkIHRvIG1hdGNoIHJpbmxpbmVqUXVlcnkKICBleHBhbmRvOiAialF1ZXJ5IiArICggY29yZV92ZXJzaW9uICsgTWF0aC5yYW5kb20oKSApLnJlcGxhY2UoIC9cRC9nLCAiIiApLAoKICAvLyBUaGUgZm9sbG93aW5nIGVsZW1lbnRzIHRocm93IHVuY2F0Y2hhYmxlIGV4Y2VwdGlvbnMgaWYgeW91CiAgLy8gYXR0ZW1wdCB0byBhZGQgZXhwYW5kbyBwcm9wZXJ0aWVzIHRvIHRoZW0uCiAgbm9EYXRhOiB7CiAgICAiZW1iZWQiOiB0cnVlLAogICAgLy8gQmFuIGFsbCBvYmplY3RzIGV4Y2VwdCBmb3IgRmxhc2ggKHdoaWNoIGhhbmRsZSBleHBhbmRvcykKICAgICJvYmplY3QiOiAiY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwIiwKICAgICJhcHBsZXQiOiB0cnVlCiAgfSwKCiAgaGFzRGF0YTogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICBlbGVtID0gZWxlbS5ub2RlVHlwZSA/IGpRdWVyeS5jYWNoZVsgZWxlbVtqUXVlcnkuZXhwYW5kb10gXSA6IGVsZW1bIGpRdWVyeS5leHBhbmRvIF07CiAgICByZXR1cm4gISFlbGVtICYmICFpc0VtcHR5RGF0YU9iamVjdCggZWxlbSApOwogIH0sCgogIGRhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBkYXRhICkgewogICAgcmV0dXJuIGludGVybmFsRGF0YSggZWxlbSwgbmFtZSwgZGF0YSwgZmFsc2UgKTsKICB9LAoKICByZW1vdmVEYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKICAgIHJldHVybiBpbnRlcm5hbFJlbW92ZURhdGEoIGVsZW0sIG5hbWUsIGZhbHNlICk7CiAgfSwKCiAgLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgogIF9kYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsKICAgIHJldHVybiBpbnRlcm5hbERhdGEoIGVsZW0sIG5hbWUsIGRhdGEsIHRydWUgKTsKICB9LAogIAogIF9yZW1vdmVEYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKICAgIHJldHVybiBpbnRlcm5hbFJlbW92ZURhdGEoIGVsZW0sIG5hbWUsIHRydWUgKTsKICB9LAoKICAvLyBBIG1ldGhvZCBmb3IgZGV0ZXJtaW5pbmcgaWYgYSBET00gbm9kZSBjYW4gaGFuZGxlIHRoZSBkYXRhIGV4cGFuZG8KICBhY2NlcHREYXRhOiBmdW5jdGlvbiggZWxlbSApIHsKICAgIHZhciBub0RhdGEgPSBlbGVtLm5vZGVOYW1lICYmIGpRdWVyeS5ub0RhdGFbIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOwoKICAgIC8vIG5vZGVzIGFjY2VwdCBkYXRhIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkOyByZWplY3Rpb24gY2FuIGJlIGNvbmRpdGlvbmFsCiAgICByZXR1cm4gIW5vRGF0YSB8fCBub0RhdGEgIT09IHRydWUgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzaWQiKSA9PT0gbm9EYXRhOwogIH0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKICBkYXRhOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKICAgIHZhciBhdHRycywgbmFtZSwKICAgICAgZWxlbSA9IHRoaXNbMF0sCiAgICAgIGkgPSAwLAogICAgICBkYXRhID0gbnVsbDsKCiAgICAvLyBHZXRzIGFsbCB2YWx1ZXMKICAgIGlmICgga2V5ID09PSB1bmRlZmluZWQgKSB7CiAgICAgIGlmICggdGhpcy5sZW5ndGggKSB7CiAgICAgICAgZGF0YSA9IGpRdWVyeS5kYXRhKCBlbGVtICk7CgogICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhalF1ZXJ5Ll9kYXRhKCBlbGVtLCAicGFyc2VkQXR0cnMiICkgKSB7CiAgICAgICAgICBhdHRycyA9IGVsZW0uYXR0cmlidXRlczsKICAgICAgICAgIGZvciAoIDsgaSA8IGF0dHJzLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICBuYW1lID0gYXR0cnNbaV0ubmFtZTsKCiAgICAgICAgICAgIGlmICggIW5hbWUuaW5kZXhPZiggImRhdGEtIiApICkgewogICAgICAgICAgICAgIG5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lLnN1YnN0cmluZyg1KSApOwoKICAgICAgICAgICAgICBkYXRhQXR0ciggZWxlbSwgbmFtZSwgZGF0YVsgbmFtZSBdICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGpRdWVyeS5fZGF0YSggZWxlbSwgInBhcnNlZEF0dHJzIiwgdHJ1ZSApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CgogICAgLy8gU2V0cyBtdWx0aXBsZSB2YWx1ZXMKICAgIGlmICggdHlwZW9mIGtleSA9PT0gIm9iamVjdCIgKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSApOwogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoKICAgICAgaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewogICAgICAgIC8vIFRyeSB0byBmZXRjaCBhbnkgaW50ZXJuYWxseSBzdG9yZWQgZGF0YSBmaXJzdAogICAgICAgIHJldHVybiBlbGVtID8gZGF0YUF0dHIoIGVsZW0sIGtleSwgalF1ZXJ5LmRhdGEoIGVsZW0sIGtleSApICkgOiBudWxsOwogICAgICB9CgogICAgICB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSwgdmFsdWUgKTsKICAgICAgfSk7CiAgICB9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEsIG51bGwsIHRydWUgKTsKICB9LAoKICByZW1vdmVEYXRhOiBmdW5jdGlvbigga2V5ICkgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgalF1ZXJ5LnJlbW92ZURhdGEoIHRoaXMsIGtleSApOwogICAgfSk7CiAgfQp9KTsKCmZ1bmN0aW9uIGRhdGFBdHRyKCBlbGVtLCBrZXksIGRhdGEgKSB7CiAgLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW50ZXJuYWxseSwgdHJ5IHRvIGZldGNoIGFueQogIC8vIGRhdGEgZnJvbSB0aGUgSFRNTDUgZGF0YS0qIGF0dHJpYnV0ZQogIGlmICggZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgogICAgdmFyIG5hbWUgPSAiZGF0YS0iICsga2V5LnJlcGxhY2UoIHJtdWx0aURhc2gsICItJDEiICkudG9Mb3dlckNhc2UoKTsKCiAgICBkYXRhID0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKTsKCiAgICBpZiAoIHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiApIHsKICAgICAgdHJ5IHsKICAgICAgICBkYXRhID0gZGF0YSA9PT0gInRydWUiID8gdHJ1ZSA6CiAgICAgICAgZGF0YSA9PT0gImZhbHNlIiA/IGZhbHNlIDoKICAgICAgICBkYXRhID09PSAibnVsbCIgPyBudWxsIDoKICAgICAgICAvLyBPbmx5IGNvbnZlcnQgdG8gYSBudW1iZXIgaWYgaXQgZG9lc24ndCBjaGFuZ2UgdGhlIHN0cmluZwogICAgICAgICtkYXRhICsgIiIgPT09IGRhdGEgPyArZGF0YSA6CiAgICAgICAgcmJyYWNlLnRlc3QoIGRhdGEgKSA/IGpRdWVyeS5wYXJzZUpTT04oIGRhdGEgKSA6CiAgICAgICAgICBkYXRhOwogICAgICB9IGNhdGNoKCBlICkge30KCiAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBzZXQgdGhlIGRhdGEgc28gaXQgaXNuJ3QgY2hhbmdlZCBsYXRlcgogICAgICBqUXVlcnkuZGF0YSggZWxlbSwga2V5LCBkYXRhICk7CgogICAgfSBlbHNlIHsKICAgICAgZGF0YSA9IHVuZGVmaW5lZDsKICAgIH0KICB9CgogIHJldHVybiBkYXRhOwp9CgovLyBjaGVja3MgYSBjYWNoZSBvYmplY3QgZm9yIGVtcHRpbmVzcwpmdW5jdGlvbiBpc0VtcHR5RGF0YU9iamVjdCggb2JqICkgewogIHZhciBuYW1lOwogIGZvciAoIG5hbWUgaW4gb2JqICkgewoKICAgIC8vIGlmIHRoZSBwdWJsaWMgZGF0YSBvYmplY3QgaXMgZW1wdHksIHRoZSBwcml2YXRlIGlzIHN0aWxsIGVtcHR5CiAgICBpZiAoIG5hbWUgPT09ICJkYXRhIiAmJiBqUXVlcnkuaXNFbXB0eU9iamVjdCggb2JqW25hbWVdICkgKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgaWYgKCBuYW1lICE9PSAidG9KU09OIiApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgcmV0dXJuIHRydWU7Cn0KalF1ZXJ5LmV4dGVuZCh7CiAgcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBkYXRhICkgewogICAgdmFyIHF1ZXVlOwoKICAgIGlmICggZWxlbSApIHsKICAgICAgdHlwZSA9ICggdHlwZSB8fCAiZngiICkgKyAicXVldWUiOwogICAgICBxdWV1ZSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgdHlwZSApOwoKICAgICAgLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAogICAgICBpZiAoIGRhdGEgKSB7CiAgICAgICAgaWYgKCAhcXVldWUgfHwgalF1ZXJ5LmlzQXJyYXkoZGF0YSkgKSB7CiAgICAgICAgICBxdWV1ZSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheShkYXRhKSApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWV1ZS5wdXNoKCBkYXRhICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBxdWV1ZSB8fCBbXTsKICAgIH0KICB9LAoKICBkZXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsKICAgIHR5cGUgPSB0eXBlIHx8ICJmeCI7CgogICAgdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKCBlbGVtLCB0eXBlICksCiAgICAgIHN0YXJ0TGVuZ3RoID0gcXVldWUubGVuZ3RoLAogICAgICBmbiA9IHF1ZXVlLnNoaWZ0KCksCiAgICAgIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKCBlbGVtLCB0eXBlICksCiAgICAgIG5leHQgPSBmdW5jdGlvbigpIHsKICAgICAgICBqUXVlcnkuZGVxdWV1ZSggZWxlbSwgdHlwZSApOwogICAgICB9OwoKICAgIC8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKICAgIGlmICggZm4gPT09ICJpbnByb2dyZXNzIiApIHsKICAgICAgZm4gPSBxdWV1ZS5zaGlmdCgpOwogICAgICBzdGFydExlbmd0aC0tOwogICAgfQoKICAgIGhvb2tzLmN1ciA9IGZuOwogICAgaWYgKCBmbiApIHsKCiAgICAgIC8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKICAgICAgLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAogICAgICBpZiAoIHR5cGUgPT09ICJmeCIgKSB7CiAgICAgICAgcXVldWUudW5zaGlmdCggImlucHJvZ3Jlc3MiICk7CiAgICAgIH0KCiAgICAgIC8vIGNsZWFyIHVwIHRoZSBsYXN0IHF1ZXVlIHN0b3AgZnVuY3Rpb24KICAgICAgZGVsZXRlIGhvb2tzLnN0b3A7CiAgICAgIGZuLmNhbGwoIGVsZW0sIG5leHQsIGhvb2tzICk7CiAgICB9CgogICAgaWYgKCAhc3RhcnRMZW5ndGggJiYgaG9va3MgKSB7CiAgICAgIGhvb2tzLmVtcHR5LmZpcmUoKTsKICAgIH0KICB9LAoKICAvLyBub3QgaW50ZW5kZWQgZm9yIHB1YmxpYyBjb25zdW1wdGlvbiAtIGdlbmVyYXRlcyBhIHF1ZXVlSG9va3Mgb2JqZWN0LCBvciByZXR1cm5zIHRoZSBjdXJyZW50IG9uZQogIF9xdWV1ZUhvb2tzOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsKICAgIHZhciBrZXkgPSB0eXBlICsgInF1ZXVlSG9va3MiOwogICAgcmV0dXJuIGpRdWVyeS5fZGF0YSggZWxlbSwga2V5ICkgfHwgalF1ZXJ5Ll9kYXRhKCBlbGVtLCBrZXksIHsKICAgICAgZW1wdHk6IGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IikuYWRkKGZ1bmN0aW9uKCkgewogICAgICAgIGpRdWVyeS5fcmVtb3ZlRGF0YSggZWxlbSwgdHlwZSArICJxdWV1ZSIgKTsKICAgICAgICBqUXVlcnkuX3JlbW92ZURhdGEoIGVsZW0sIGtleSApOwogICAgICB9KQogICAgfSk7CiAgfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewogIHF1ZXVlOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKICAgIHZhciBzZXR0ZXIgPSAyOwoKICAgIGlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewogICAgICBkYXRhID0gdHlwZTsKICAgICAgdHlwZSA9ICJmeCI7CiAgICAgIHNldHRlci0tOwogICAgfQoKICAgIGlmICggYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlciApIHsKICAgICAgcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1swXSwgdHlwZSApOwogICAgfQoKICAgIHJldHVybiBkYXRhID09PSB1bmRlZmluZWQgPwogICAgICB0aGlzIDoKICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSggdGhpcywgdHlwZSwgZGF0YSApOwoKICAgICAgICAvLyBlbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQogICAgICAgIGpRdWVyeS5fcXVldWVIb29rcyggdGhpcywgdHlwZSApOwoKICAgICAgICBpZiAoIHR5cGUgPT09ICJmeCIgJiYgcXVldWVbMF0gIT09ICJpbnByb2dyZXNzIiApIHsKICAgICAgICAgIGpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CiAgICAgICAgfQogICAgICB9KTsKICB9LAogIGRlcXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKICAgIH0pOwogIH0sCiAgLy8gQmFzZWQgb2ZmIG9mIHRoZSBwbHVnaW4gYnkgQ2xpbnQgSGVsZmVycywgd2l0aCBwZXJtaXNzaW9uLgogIC8vIGh0dHA6Ly9ibGluZHNpZ25hbHMuY29tL2luZGV4LnBocC8yMDA5LzA3L2pxdWVyeS1kZWxheS8KICBkZWxheTogZnVuY3Rpb24oIHRpbWUsIHR5cGUgKSB7CiAgICB0aW1lID0galF1ZXJ5LmZ4ID8galF1ZXJ5LmZ4LnNwZWVkc1sgdGltZSBdIHx8IHRpbWUgOiB0aW1lOwogICAgdHlwZSA9IHR5cGUgfHwgImZ4IjsKCiAgICByZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oIG5leHQsIGhvb2tzICkgewogICAgICB2YXIgdGltZW91dCA9IHNldFRpbWVvdXQoIG5leHQsIHRpbWUgKTsKICAgICAgaG9va3Muc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNsZWFyVGltZW91dCggdGltZW91dCApOwogICAgICB9OwogICAgfSk7CiAgfSwKICBjbGVhclF1ZXVlOiBmdW5jdGlvbiggdHlwZSApIHsKICAgIHJldHVybiB0aGlzLnF1ZXVlKCB0eXBlIHx8ICJmeCIsIFtdICk7CiAgfSwKICAvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlCiAgLy8gYXJlIGVtcHRpZWQgKGZ4IGlzIHRoZSB0eXBlIGJ5IGRlZmF1bHQpCiAgcHJvbWlzZTogZnVuY3Rpb24oIHR5cGUsIG9iaiApIHsKICAgIHZhciB0bXAsCiAgICAgIGNvdW50ID0gMSwKICAgICAgZGVmZXIgPSBqUXVlcnkuRGVmZXJyZWQoKSwKICAgICAgZWxlbWVudHMgPSB0aGlzLAogICAgICBpID0gdGhpcy5sZW5ndGgsCiAgICAgIHJlc29sdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICEoIC0tY291bnQgKSApIHsKICAgICAgICAgIGRlZmVyLnJlc29sdmVXaXRoKCBlbGVtZW50cywgWyBlbGVtZW50cyBdICk7CiAgICAgICAgfQogICAgICB9OwoKICAgIGlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewogICAgICBvYmogPSB0eXBlOwogICAgICB0eXBlID0gdW5kZWZpbmVkOwogICAgfQogICAgdHlwZSA9IHR5cGUgfHwgImZ4IjsKCiAgICB3aGlsZSggaS0tICkgewogICAgICB0bXAgPSBqUXVlcnkuX2RhdGEoIGVsZW1lbnRzWyBpIF0sIHR5cGUgKyAicXVldWVIb29rcyIgKTsKICAgICAgaWYgKCB0bXAgJiYgdG1wLmVtcHR5ICkgewogICAgICAgIGNvdW50Kys7CiAgICAgICAgdG1wLmVtcHR5LmFkZCggcmVzb2x2ZSApOwogICAgICB9CiAgICB9CiAgICByZXNvbHZlKCk7CiAgICByZXR1cm4gZGVmZXIucHJvbWlzZSggb2JqICk7CiAgfQp9KTsKdmFyIG5vZGVIb29rLCBib29sSG9vaywKICByY2xhc3MgPSAvW1x0XHJcbl0vZywKICBycmV0dXJuID0gL1xyL2csCiAgcmZvY3VzYWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbnxvYmplY3QpJC9pLAogIHJjbGlja2FibGUgPSAvXig/OmF8YXJlYSkkL2ksCiAgcmJvb2xlYW4gPSAvXig/OmNoZWNrZWR8c2VsZWN0ZWR8YXV0b2ZvY3VzfGF1dG9wbGF5fGFzeW5jfGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkKSQvaSwKICBydXNlRGVmYXVsdCA9IC9eKD86Y2hlY2tlZHxzZWxlY3RlZCkkL2ksCiAgZ2V0U2V0QXR0cmlidXRlID0galF1ZXJ5LnN1cHBvcnQuZ2V0U2V0QXR0cmlidXRlLAogIGdldFNldElucHV0ID0galF1ZXJ5LnN1cHBvcnQuaW5wdXQ7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKICBhdHRyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CiAgICByZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgalF1ZXJ5LmF0dHIsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwogIH0sCgogIHJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lICkgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIoIHRoaXMsIG5hbWUgKTsKICAgIH0pOwogIH0sCgogIHByb3A6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKICAgIHJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBqUXVlcnkucHJvcCwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7CiAgfSwKCiAgcmVtb3ZlUHJvcDogZnVuY3Rpb24oIG5hbWUgKSB7CiAgICBuYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgLy8gdHJ5L2NhdGNoIGhhbmRsZXMgY2FzZXMgd2hlcmUgSUUgYmFsa3MgKHN1Y2ggYXMgcmVtb3ZpbmcgYSBwcm9wZXJ0eSBvbiB3aW5kb3cpCiAgICAgIHRyeSB7CiAgICAgICAgdGhpc1sgbmFtZSBdID0gdW5kZWZpbmVkOwogICAgICAgIGRlbGV0ZSB0aGlzWyBuYW1lIF07CiAgICAgIH0gY2F0Y2goIGUgKSB7fQogICAgfSk7CiAgfSwKCiAgYWRkQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgIHZhciBjbGFzc2VzLCBlbGVtLCBjdXIsIGNsYXp6LCBqLAogICAgICBpID0gMCwKICAgICAgbGVuID0gdGhpcy5sZW5ndGgsCiAgICAgIHByb2NlZWQgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIHZhbHVlOwoKICAgIGlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGogKSB7CiAgICAgICAgalF1ZXJ5KCB0aGlzICkuYWRkQ2xhc3MoIHZhbHVlLmNhbGwoIHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lICkgKTsKICAgICAgfSk7CiAgICB9CgogICAgaWYgKCBwcm9jZWVkICkgewogICAgICAvLyBUaGUgZGlzanVuY3Rpb24gaGVyZSBpcyBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIHJlbW92ZUNsYXNzKQogICAgICBjbGFzc2VzID0gKCB2YWx1ZSB8fCAiIiApLm1hdGNoKCBjb3JlX3Jub3R3aGl0ZSApIHx8IFtdOwoKICAgICAgZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CiAgICAgICAgZWxlbSA9IHRoaXNbIGkgXTsKICAgICAgICBjdXIgPSBlbGVtLm5vZGVUeXBlID09PSAxICYmICggZWxlbS5jbGFzc05hbWUgPwogICAgICAgICAgKCAiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIiApLnJlcGxhY2UoIHJjbGFzcywgIiAiICkgOgogICAgICAgICAgIiAiCiAgICAgICAgKTsKCiAgICAgICAgaWYgKCBjdXIgKSB7CiAgICAgICAgICBqID0gMDsKICAgICAgICAgIHdoaWxlICggKGNsYXp6ID0gY2xhc3Nlc1tqKytdKSApIHsKICAgICAgICAgICAgaWYgKCBjdXIuaW5kZXhPZiggIiAiICsgY2xhenogKyAiICIgKSA8IDAgKSB7CiAgICAgICAgICAgICAgY3VyICs9IGNsYXp6ICsgIiAiOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtLmNsYXNzTmFtZSA9IGpRdWVyeS50cmltKCBjdXIgKTsKCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgIHZhciBjbGFzc2VzLCBlbGVtLCBjdXIsIGNsYXp6LCBqLAogICAgICBpID0gMCwKICAgICAgbGVuID0gdGhpcy5sZW5ndGgsCiAgICAgIHByb2NlZWQgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgdmFsdWU7CgogICAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaiApIHsKICAgICAgICBqUXVlcnkoIHRoaXMgKS5yZW1vdmVDbGFzcyggdmFsdWUuY2FsbCggdGhpcywgaiwgdGhpcy5jbGFzc05hbWUgKSApOwogICAgICB9KTsKICAgIH0KICAgIGlmICggcHJvY2VlZCApIHsKICAgICAgY2xhc3NlcyA9ICggdmFsdWUgfHwgIiIgKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbXTsKCiAgICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgICAgIGVsZW0gPSB0aGlzWyBpIF07CiAgICAgICAgLy8gVGhpcyBleHByZXNzaW9uIGlzIGhlcmUgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSBhZGRDbGFzcykKICAgICAgICBjdXIgPSBlbGVtLm5vZGVUeXBlID09PSAxICYmICggZWxlbS5jbGFzc05hbWUgPwogICAgICAgICAgKCAiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIiApLnJlcGxhY2UoIHJjbGFzcywgIiAiICkgOgogICAgICAgICAgIiIKICAgICAgICApOwoKICAgICAgICBpZiAoIGN1ciApIHsKICAgICAgICAgIGogPSAwOwogICAgICAgICAgd2hpbGUgKCAoY2xhenogPSBjbGFzc2VzW2orK10pICkgewogICAgICAgICAgICAvLyBSZW1vdmUgKmFsbCogaW5zdGFuY2VzCiAgICAgICAgICAgIHdoaWxlICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPj0gMCApIHsKICAgICAgICAgICAgICBjdXIgPSBjdXIucmVwbGFjZSggIiAiICsgY2xhenogKyAiICIsICIgIiApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtLmNsYXNzTmFtZSA9IHZhbHVlID8galF1ZXJ5LnRyaW0oIGN1ciApIDogIiI7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSwgc3RhdGVWYWwgKSB7CiAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZSwKICAgICAgaXNCb29sID0gdHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiI7CgogICAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKICAgICAgICBqUXVlcnkoIHRoaXMgKS50b2dnbGVDbGFzcyggdmFsdWUuY2FsbCh0aGlzLCBpLCB0aGlzLmNsYXNzTmFtZSwgc3RhdGVWYWwpLCBzdGF0ZVZhbCApOwogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICBpZiAoIHR5cGUgPT09ICJzdHJpbmciICkgewogICAgICAgIC8vIHRvZ2dsZSBpbmRpdmlkdWFsIGNsYXNzIG5hbWVzCiAgICAgICAgdmFyIGNsYXNzTmFtZSwKICAgICAgICAgIGkgPSAwLAogICAgICAgICAgc2VsZiA9IGpRdWVyeSggdGhpcyApLAogICAgICAgICAgc3RhdGUgPSBzdGF0ZVZhbCwKICAgICAgICAgIGNsYXNzTmFtZXMgPSB2YWx1ZS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbXTsKCiAgICAgICAgd2hpbGUgKCAoY2xhc3NOYW1lID0gY2xhc3NOYW1lc1sgaSsrIF0pICkgewogICAgICAgICAgLy8gY2hlY2sgZWFjaCBjbGFzc05hbWUgZ2l2ZW4sIHNwYWNlIHNlcGFyYXRlZCBsaXN0CiAgICAgICAgICBzdGF0ZSA9IGlzQm9vbCA/IHN0YXRlIDogIXNlbGYuaGFzQ2xhc3MoIGNsYXNzTmFtZSApOwogICAgICAgICAgc2VsZlsgc3RhdGUgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIiBdKCBjbGFzc05hbWUgKTsKICAgICAgICB9CgogICAgICAvLyBUb2dnbGUgd2hvbGUgY2xhc3MgbmFtZQogICAgICB9IGVsc2UgaWYgKCB0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlID09PSAiYm9vbGVhbiIgKSB7CiAgICAgICAgaWYgKCB0aGlzLmNsYXNzTmFtZSApIHsKICAgICAgICAgIC8vIHN0b3JlIGNsYXNzTmFtZSBpZiBzZXQKICAgICAgICAgIGpRdWVyeS5fZGF0YSggdGhpcywgIl9fY2xhc3NOYW1lX18iLCB0aGlzLmNsYXNzTmFtZSApOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlIGVsZW1lbnQgaGFzIGEgY2xhc3MgbmFtZSBvciBpZiB3ZSdyZSBwYXNzZWQgImZhbHNlIiwKICAgICAgICAvLyB0aGVuIHJlbW92ZSB0aGUgd2hvbGUgY2xhc3NuYW1lIChpZiB0aGVyZSB3YXMgb25lLCB0aGUgYWJvdmUgc2F2ZWQgaXQpLgogICAgICAgIC8vIE90aGVyd2lzZSBicmluZyBiYWNrIHdoYXRldmVyIHdhcyBwcmV2aW91c2x5IHNhdmVkIChpZiBhbnl0aGluZyksCiAgICAgICAgLy8gZmFsbGluZyBiYWNrIHRvIHRoZSBlbXB0eSBzdHJpbmcgaWYgbm90aGluZyB3YXMgc3RvcmVkLgogICAgICAgIHRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUgfHwgdmFsdWUgPT09IGZhbHNlID8gIiIgOiBqUXVlcnkuX2RhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiApIHx8ICIiOwogICAgICB9CiAgICB9KTsKICB9LAoKICBoYXNDbGFzczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewogICAgdmFyIGNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiLAogICAgICBpID0gMCwKICAgICAgbCA9IHRoaXMubGVuZ3RoOwogICAgZm9yICggOyBpIDwgbDsgaSsrICkgewogICAgICBpZiAoIHRoaXNbaV0ubm9kZVR5cGUgPT09IDEgJiYgKCIgIiArIHRoaXNbaV0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKHJjbGFzcywgIiAiKS5pbmRleE9mKCBjbGFzc05hbWUgKSA+PSAwICkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIHZhbDogZnVuY3Rpb24oIHZhbHVlICkgewogICAgdmFyIGhvb2tzLCByZXQsIGlzRnVuY3Rpb24sCiAgICAgIGVsZW0gPSB0aGlzWzBdOwoKICAgIGlmICggIWFyZ3VtZW50cy5sZW5ndGggKSB7CiAgICAgIGlmICggZWxlbSApIHsKICAgICAgICBob29rcyA9IGpRdWVyeS52YWxIb29rc1sgZWxlbS50eXBlIF0gfHwgalF1ZXJ5LnZhbEhvb2tzWyBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCiAgICAgICAgaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCAidmFsdWUiICkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KCiAgICAgICAgcmV0ID0gZWxlbS52YWx1ZTsKCiAgICAgICAgcmV0dXJuIHR5cGVvZiByZXQgPT09ICJzdHJpbmciID8KICAgICAgICAgIC8vIGhhbmRsZSBtb3N0IGNvbW1vbiBzdHJpbmcgY2FzZXMKICAgICAgICAgIHJldC5yZXBsYWNlKHJyZXR1cm4sICIiKSA6CiAgICAgICAgICAvLyBoYW5kbGUgY2FzZXMgd2hlcmUgdmFsdWUgaXMgbnVsbC91bmRlZiBvciBudW1iZXIKICAgICAgICAgIHJldCA9PSBudWxsID8gIiIgOiByZXQ7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKICAgICAgdmFyIHZhbCwKICAgICAgICBzZWxmID0galF1ZXJ5KHRoaXMpOwoKICAgICAgaWYgKCB0aGlzLm5vZGVUeXBlICE9PSAxICkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCBpc0Z1bmN0aW9uICkgewogICAgICAgIHZhbCA9IHZhbHVlLmNhbGwoIHRoaXMsIGksIHNlbGYudmFsKCkgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWwgPSB2YWx1ZTsKICAgICAgfQoKICAgICAgLy8gVHJlYXQgbnVsbC91bmRlZmluZWQgYXMgIiI7IGNvbnZlcnQgbnVtYmVycyB0byBzdHJpbmcKICAgICAgaWYgKCB2YWwgPT0gbnVsbCApIHsKICAgICAgICB2YWwgPSAiIjsKICAgICAgfSBlbHNlIGlmICggdHlwZW9mIHZhbCA9PT0gIm51bWJlciIgKSB7CiAgICAgICAgdmFsICs9ICIiOwogICAgICB9IGVsc2UgaWYgKCBqUXVlcnkuaXNBcnJheSggdmFsICkgKSB7CiAgICAgICAgdmFsID0galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICggdmFsdWUgKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKyAiIjsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIHRoaXMudHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgogICAgICAvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwogICAgICBpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCBob29rcy5zZXQoIHRoaXMsIHZhbCwgInZhbHVlIiApID09PSB1bmRlZmluZWQgKSB7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbDsKICAgICAgfQogICAgfSk7CiAgfQp9KTsKCmpRdWVyeS5leHRlbmQoewogIHZhbEhvb2tzOiB7CiAgICBvcHRpb246IHsKICAgICAgZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICAvLyBhdHRyaWJ1dGVzLnZhbHVlIGlzIHVuZGVmaW5lZCBpbiBCbGFja2JlcnJ5IDQuNyBidXQKICAgICAgICAvLyB1c2VzIC52YWx1ZS4gU2VlICM2OTMyCiAgICAgICAgdmFyIHZhbCA9IGVsZW0uYXR0cmlidXRlcy52YWx1ZTsKICAgICAgICByZXR1cm4gIXZhbCB8fCB2YWwuc3BlY2lmaWVkID8gZWxlbS52YWx1ZSA6IGVsZW0udGV4dDsKICAgICAgfQogICAgfSwKICAgIHNlbGVjdDogewogICAgICBnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAgIHZhciB2YWx1ZSwgb3B0aW9uLAogICAgICAgICAgb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKICAgICAgICAgIGluZGV4ID0gZWxlbS5zZWxlY3RlZEluZGV4LAogICAgICAgICAgb25lID0gZWxlbS50eXBlID09PSAic2VsZWN0LW9uZSIgfHwgaW5kZXggPCAwLAogICAgICAgICAgdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLAogICAgICAgICAgbWF4ID0gb25lID8gaW5kZXggKyAxIDogb3B0aW9ucy5sZW5ndGgsCiAgICAgICAgICBpID0gaW5kZXggPCAwID8KICAgICAgICAgICAgbWF4IDoKICAgICAgICAgICAgb25lID8gaW5kZXggOiAwOwoKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBzZWxlY3RlZCBvcHRpb25zCiAgICAgICAgZm9yICggOyBpIDwgbWF4OyBpKysgKSB7CiAgICAgICAgICBvcHRpb24gPSBvcHRpb25zWyBpIF07CgogICAgICAgICAgLy8gb2xkSUUgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAoIzI1NTEpCiAgICAgICAgICBpZiAoICggb3B0aW9uLnNlbGVjdGVkIHx8IGkgPT09IGluZGV4ICkgJiYKICAgICAgICAgICAgICAvLyBEb24ndCByZXR1cm4gb3B0aW9ucyB0aGF0IGFyZSBkaXNhYmxlZCBvciBpbiBhIGRpc2FibGVkIG9wdGdyb3VwCiAgICAgICAgICAgICAgKCBqUXVlcnkuc3VwcG9ydC5vcHREaXNhYmxlZCA/ICFvcHRpb24uZGlzYWJsZWQgOiBvcHRpb24uZ2V0QXR0cmlidXRlKCJkaXNhYmxlZCIpID09PSBudWxsICkgJiYKICAgICAgICAgICAgICAoICFvcHRpb24ucGFyZW50Tm9kZS5kaXNhYmxlZCB8fCAhalF1ZXJ5Lm5vZGVOYW1lKCBvcHRpb24ucGFyZW50Tm9kZSwgIm9wdGdyb3VwIiApICkgKSB7CgogICAgICAgICAgICAvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uCiAgICAgICAgICAgIHZhbHVlID0galF1ZXJ5KCBvcHRpb24gKS52YWwoKTsKCiAgICAgICAgICAgIC8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCiAgICAgICAgICAgIGlmICggb25lICkgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKICAgICAgICAgICAgdmFsdWVzLnB1c2goIHZhbHVlICk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgICB9LAoKICAgICAgc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CiAgICAgICAgdmFyIHZhbHVlcyA9IGpRdWVyeS5tYWtlQXJyYXkoIHZhbHVlICk7CgogICAgICAgIGpRdWVyeShlbGVtKS5maW5kKCJvcHRpb24iKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5zZWxlY3RlZCA9IGpRdWVyeS5pbkFycmF5KCBqUXVlcnkodGhpcykudmFsKCksIHZhbHVlcyApID49IDA7CiAgICAgICAgfSk7CgogICAgICAgIGlmICggIXZhbHVlcy5sZW5ndGggKSB7CiAgICAgICAgICBlbGVtLnNlbGVjdGVkSW5kZXggPSAtMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgfQogICAgfQogIH0sCgogIGF0dHI6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSApIHsKICAgIHZhciByZXQsIGhvb2tzLCBub3R4bWwsCiAgICAgIG5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCiAgICAvLyBkb24ndCBnZXQvc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCiAgICBpZiAoICFlbGVtIHx8IG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyICkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gRmFsbGJhY2sgdG8gcHJvcCB3aGVuIGF0dHJpYnV0ZXMgYXJlIG5vdCBzdXBwb3J0ZWQKICAgIGlmICggdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlID09PSAidW5kZWZpbmVkIiApIHsKICAgICAgcmV0dXJuIGpRdWVyeS5wcm9wKCBlbGVtLCBuYW1lLCB2YWx1ZSApOwogICAgfQoKICAgIG5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKTsKCiAgICAvLyBBbGwgYXR0cmlidXRlcyBhcmUgbG93ZXJjYXNlCiAgICAvLyBHcmFiIG5lY2Vzc2FyeSBob29rIGlmIG9uZSBpcyBkZWZpbmVkCiAgICBpZiAoIG5vdHhtbCApIHsKICAgICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gfHwgKCByYm9vbGVhbi50ZXN0KCBuYW1lICkgPyBib29sSG9vayA6IG5vZGVIb29rICk7CiAgICB9CgogICAgaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoKICAgICAgaWYgKCB2YWx1ZSA9PT0gbnVsbCApIHsKICAgICAgICBqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoKICAgICAgfSBlbHNlIGlmICggaG9va3MgJiYgbm90eG1sICYmICJzZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgcmV0dXJuIHJldDsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsIHZhbHVlICsgIiIgKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KCiAgICB9IGVsc2UgaWYgKCBob29rcyAmJiBub3R4bWwgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgbmFtZSApKSAhPT0gbnVsbCApIHsKICAgICAgcmV0dXJuIHJldDsKCiAgICB9IGVsc2UgewoKICAgICAgLy8gSW4gSUU5KywgRmxhc2ggb2JqZWN0cyBkb24ndCBoYXZlIC5nZXRBdHRyaWJ1dGUgKCMxMjk0NSkKICAgICAgLy8gU3VwcG9ydDogSUU5KwogICAgICBpZiAoIHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSAhPT0gInVuZGVmaW5lZCIgKSB7CiAgICAgICAgcmV0ID0gIGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICk7CiAgICAgIH0KCiAgICAgIC8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCiAgICAgIHJldHVybiByZXQgPT0gbnVsbCA/CiAgICAgICAgdW5kZWZpbmVkIDoKICAgICAgICByZXQ7CiAgICB9CiAgfSwKCiAgcmVtb3ZlQXR0cjogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewogICAgdmFyIG5hbWUsIHByb3BOYW1lLAogICAgICBpID0gMCwKICAgICAgYXR0ck5hbWVzID0gdmFsdWUgJiYgdmFsdWUubWF0Y2goIGNvcmVfcm5vdHdoaXRlICk7CgogICAgaWYgKCBhdHRyTmFtZXMgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKICAgICAgd2hpbGUgKCAobmFtZSA9IGF0dHJOYW1lc1tpKytdKSApIHsKICAgICAgICBwcm9wTmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCiAgICAgICAgLy8gQm9vbGVhbiBhdHRyaWJ1dGVzIGdldCBzcGVjaWFsIHRyZWF0bWVudCAoIzEwODcwKQogICAgICAgIGlmICggcmJvb2xlYW4udGVzdCggbmFtZSApICkgewogICAgICAgICAgLy8gU2V0IGNvcnJlc3BvbmRpbmcgcHJvcGVydHkgdG8gZmFsc2UgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwogICAgICAgICAgLy8gQWxzbyBjbGVhciBkZWZhdWx0Q2hlY2tlZC9kZWZhdWx0U2VsZWN0ZWQgKGlmIGFwcHJvcHJpYXRlKSBmb3IgSUU8OAogICAgICAgICAgaWYgKCAhZ2V0U2V0QXR0cmlidXRlICYmIHJ1c2VEZWZhdWx0LnRlc3QoIG5hbWUgKSApIHsKICAgICAgICAgICAgZWxlbVsgalF1ZXJ5LmNhbWVsQ2FzZSggImRlZmF1bHQtIiArIG5hbWUgKSBdID0KICAgICAgICAgICAgICBlbGVtWyBwcm9wTmFtZSBdID0gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtWyBwcm9wTmFtZSBdID0gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgIC8vIFNlZSAjOTY5OSBmb3IgZXhwbGFuYXRpb24gb2YgdGhpcyBhcHByb2FjaCAoc2V0dGluZyBmaXJzdCwgdGhlbiByZW1vdmFsKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBqUXVlcnkuYXR0ciggZWxlbSwgbmFtZSwgIiIgKTsKICAgICAgICB9CgogICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKCBnZXRTZXRBdHRyaWJ1dGUgPyBuYW1lIDogcHJvcE5hbWUgKTsKICAgICAgfQogICAgfQogIH0sCgogIGF0dHJIb29rczogewogICAgdHlwZTogewogICAgICBzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKICAgICAgICBpZiAoICFqUXVlcnkuc3VwcG9ydC5yYWRpb1ZhbHVlICYmIHZhbHVlID09PSAicmFkaW8iICYmIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAiaW5wdXQiKSApIHsKICAgICAgICAgIC8vIFNldHRpbmcgdGhlIHR5cGUgb24gYSByYWRpbyBidXR0b24gYWZ0ZXIgdGhlIHZhbHVlIHJlc2V0cyB0aGUgdmFsdWUgaW4gSUU2LTkKICAgICAgICAgIC8vIFJlc2V0IHZhbHVlIHRvIGRlZmF1bHQgaW4gY2FzZSB0eXBlIGlzIHNldCBhZnRlciB2YWx1ZSBkdXJpbmcgY3JlYXRpb24KICAgICAgICAgIHZhciB2YWwgPSBlbGVtLnZhbHVlOwogICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgdmFsdWUgKTsKICAgICAgICAgIGlmICggdmFsICkgewogICAgICAgICAgICBlbGVtLnZhbHVlID0gdmFsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sCgogIHByb3BGaXg6IHsKICAgIHRhYmluZGV4OiAidGFiSW5kZXgiLAogICAgcmVhZG9ubHk6ICJyZWFkT25seSIsCiAgICAiZm9yIjogImh0bWxGb3IiLAogICAgImNsYXNzIjogImNsYXNzTmFtZSIsCiAgICBtYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAogICAgY2VsbHNwYWNpbmc6ICJjZWxsU3BhY2luZyIsCiAgICBjZWxscGFkZGluZzogImNlbGxQYWRkaW5nIiwKICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgIGNvbHNwYW46ICJjb2xTcGFuIiwKICAgIHVzZW1hcDogInVzZU1hcCIsCiAgICBmcmFtZWJvcmRlcjogImZyYW1lQm9yZGVyIiwKICAgIGNvbnRlbnRlZGl0YWJsZTogImNvbnRlbnRFZGl0YWJsZSIKICB9LAoKICBwcm9wOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CiAgICB2YXIgcmV0LCBob29rcywgbm90eG1sLAogICAgICBuVHlwZSA9IGVsZW0ubm9kZVR5cGU7CgogICAgLy8gZG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwogICAgaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIG5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKTsKCiAgICBpZiAoIG5vdHhtbCApIHsKICAgICAgLy8gRml4IG5hbWUgYW5kIGF0dGFjaCBob29rcwogICAgICBuYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwogICAgICBob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXTsKICAgIH0KCiAgICBpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CiAgICAgIGlmICggaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSkgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICByZXR1cm4gcmV0OwoKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gKCBlbGVtWyBuYW1lIF0gPSB2YWx1ZSApOwogICAgICB9CgogICAgfSBlbHNlIHsKICAgICAgaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkpICE9PSBudWxsICkgewogICAgICAgIHJldHVybiByZXQ7CgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBlbGVtWyBuYW1lIF07CiAgICAgIH0KICAgIH0KICB9LAoKICBwcm9wSG9va3M6IHsKICAgIHRhYkluZGV4OiB7CiAgICAgIGdldDogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgLy8gZWxlbS50YWJJbmRleCBkb2Vzbid0IGFsd2F5cyByZXR1cm4gdGhlIGNvcnJlY3QgdmFsdWUgd2hlbiBpdCBoYXNuJ3QgYmVlbiBleHBsaWNpdGx5IHNldAogICAgICAgIC8vIGh0dHA6Ly9mbHVpZHByb2plY3Qub3JnL2Jsb2cvMjAwOC8wMS8wOS9nZXR0aW5nLXNldHRpbmctYW5kLXJlbW92aW5nLXRhYmluZGV4LXZhbHVlcy13aXRoLWphdmFzY3JpcHQvCiAgICAgICAgdmFyIGF0dHJpYnV0ZU5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoInRhYmluZGV4Iik7CgogICAgICAgIHJldHVybiBhdHRyaWJ1dGVOb2RlICYmIGF0dHJpYnV0ZU5vZGUuc3BlY2lmaWVkID8KICAgICAgICAgIHBhcnNlSW50KCBhdHRyaWJ1dGVOb2RlLnZhbHVlLCAxMCApIDoKICAgICAgICAgIHJmb2N1c2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApIHx8IHJjbGlja2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApICYmIGVsZW0uaHJlZiA/CiAgICAgICAgICAgIDAgOgogICAgICAgICAgICB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0KICB9Cn0pOwoKLy8gSG9vayBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCmJvb2xIb29rID0gewogIGdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CiAgICB2YXIKICAgICAgLy8gVXNlIC5wcm9wIHRvIGRldGVybWluZSBpZiB0aGlzIGF0dHJpYnV0ZSBpcyB1bmRlcnN0b29kIGFzIGJvb2xlYW4KICAgICAgcHJvcCA9IGpRdWVyeS5wcm9wKCBlbGVtLCBuYW1lICksCgogICAgICAvLyBGZXRjaCBpdCBhY2NvcmRpbmdseQogICAgICBhdHRyID0gdHlwZW9mIHByb3AgPT09ICJib29sZWFuIiAmJiBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApLAogICAgICBkZXRhaWwgPSB0eXBlb2YgcHJvcCA9PT0gImJvb2xlYW4iID8KCiAgICAgICAgZ2V0U2V0SW5wdXQgJiYgZ2V0U2V0QXR0cmlidXRlID8KICAgICAgICAgIGF0dHIgIT0gbnVsbCA6CiAgICAgICAgICAvLyBvbGRJRSBmYWJyaWNhdGVzIGFuIGVtcHR5IHN0cmluZyBmb3IgbWlzc2luZyBib29sZWFuIGF0dHJpYnV0ZXMKICAgICAgICAgIC8vIGFuZCBjb25mbGF0ZXMgY2hlY2tlZC9zZWxlY3RlZCBpbnRvIGF0dHJvcGVydGllcwogICAgICAgICAgcnVzZURlZmF1bHQudGVzdCggbmFtZSApID8KICAgICAgICAgICAgZWxlbVsgalF1ZXJ5LmNhbWVsQ2FzZSggImRlZmF1bHQtIiArIG5hbWUgKSBdIDoKICAgICAgICAgICAgISFhdHRyIDoKCiAgICAgICAgLy8gZmV0Y2ggYW4gYXR0cmlidXRlIG5vZGUgZm9yIHByb3BlcnRpZXMgbm90IHJlY29nbml6ZWQgYXMgYm9vbGVhbgogICAgICAgIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApOwoKICAgIHJldHVybiBkZXRhaWwgJiYgZGV0YWlsLnZhbHVlICE9PSBmYWxzZSA/CiAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSA6CiAgICAgIHVuZGVmaW5lZDsKICB9LAogIHNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewogICAgaWYgKCB2YWx1ZSA9PT0gZmFsc2UgKSB7CiAgICAgIC8vIFJlbW92ZSBib29sZWFuIGF0dHJpYnV0ZXMgd2hlbiBzZXQgdG8gZmFsc2UKICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIoIGVsZW0sIG5hbWUgKTsKICAgIH0gZWxzZSBpZiAoIGdldFNldElucHV0ICYmIGdldFNldEF0dHJpYnV0ZSB8fCAhcnVzZURlZmF1bHQudGVzdCggbmFtZSApICkgewogICAgICAvLyBJRTw4IG5lZWRzIHRoZSAqcHJvcGVydHkqIG5hbWUKICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoICFnZXRTZXRBdHRyaWJ1dGUgJiYgalF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lLCBuYW1lICk7CgogICAgLy8gVXNlIGRlZmF1bHRDaGVja2VkIGFuZCBkZWZhdWx0U2VsZWN0ZWQgZm9yIG9sZElFCiAgICB9IGVsc2UgewogICAgICBlbGVtWyBqUXVlcnkuY2FtZWxDYXNlKCAiZGVmYXVsdC0iICsgbmFtZSApIF0gPSBlbGVtWyBuYW1lIF0gPSB0cnVlOwogICAgfQoKICAgIHJldHVybiBuYW1lOwogIH0KfTsKCi8vIGZpeCBvbGRJRSB2YWx1ZSBhdHRyb3BlcnR5CmlmICggIWdldFNldElucHV0IHx8ICFnZXRTZXRBdHRyaWJ1dGUgKSB7CiAgalF1ZXJ5LmF0dHJIb29rcy52YWx1ZSA9IHsKICAgIGdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CiAgICAgIHZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKICAgICAgcmV0dXJuIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImlucHV0IiApID8KCiAgICAgICAgLy8gSWdub3JlIHRoZSB2YWx1ZSAqcHJvcGVydHkqIGJ5IHVzaW5nIGRlZmF1bHRWYWx1ZQogICAgICAgIGVsZW0uZGVmYXVsdFZhbHVlIDoKCiAgICAgICAgcmV0ICYmIHJldC5zcGVjaWZpZWQgPyByZXQudmFsdWUgOiB1bmRlZmluZWQ7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7CiAgICAgIGlmICggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaW5wdXQiICkgKSB7CiAgICAgICAgLy8gRG9lcyBub3QgcmV0dXJuIHNvIHRoYXQgc2V0QXR0cmlidXRlIGlzIGFsc28gdXNlZAogICAgICAgIGVsZW0uZGVmYXVsdFZhbHVlID0gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVXNlIG5vZGVIb29rIGlmIGRlZmluZWQgKCMxOTU0KTsgb3RoZXJ3aXNlIHNldEF0dHJpYnV0ZSBpcyBmaW5lCiAgICAgICAgcmV0dXJuIG5vZGVIb29rICYmIG5vZGVIb29rLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKTsKICAgICAgfQogICAgfQogIH07Cn0KCi8vIElFNi83IGRvIG5vdCBzdXBwb3J0IGdldHRpbmcvc2V0dGluZyBzb21lIGF0dHJpYnV0ZXMgd2l0aCBnZXQvc2V0QXR0cmlidXRlCmlmICggIWdldFNldEF0dHJpYnV0ZSApIHsKCiAgLy8gVXNlIHRoaXMgZm9yIGFueSBhdHRyaWJ1dGUgaW4gSUU2LzcKICAvLyBUaGlzIGZpeGVzIGFsbW9zdCBldmVyeSBJRTYvNyBpc3N1ZQogIG5vZGVIb29rID0galF1ZXJ5LnZhbEhvb2tzLmJ1dHRvbiA9IHsKICAgIGdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CiAgICAgIHZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKICAgICAgcmV0dXJuIHJldCAmJiAoIG5hbWUgPT09ICJpZCIgfHwgbmFtZSA9PT0gIm5hbWUiIHx8IG5hbWUgPT09ICJjb29yZHMiID8gcmV0LnZhbHVlICE9PSAiIiA6IHJldC5zcGVjaWZpZWQgKSA/CiAgICAgICAgcmV0LnZhbHVlIDoKICAgICAgICB1bmRlZmluZWQ7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7CiAgICAgIC8vIFNldCB0aGUgZXhpc3Rpbmcgb3IgY3JlYXRlIGEgbmV3IGF0dHJpYnV0ZSBub2RlCiAgICAgIHZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKICAgICAgaWYgKCAhcmV0ICkgewogICAgICAgIGVsZW0uc2V0QXR0cmlidXRlTm9kZSgKICAgICAgICAgIChyZXQgPSBlbGVtLm93bmVyRG9jdW1lbnQuY3JlYXRlQXR0cmlidXRlKCBuYW1lICkpCiAgICAgICAgKTsKICAgICAgfQoKICAgICAgcmV0LnZhbHVlID0gdmFsdWUgKz0gIiI7CgogICAgICAvLyBCcmVhayBhc3NvY2lhdGlvbiB3aXRoIGNsb25lZCBlbGVtZW50cyBieSBhbHNvIHVzaW5nIHNldEF0dHJpYnV0ZSAoIzk2NDYpCiAgICAgIHJldHVybiBuYW1lID09PSAidmFsdWUiIHx8IHZhbHVlID09PSBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApID8KICAgICAgICB2YWx1ZSA6CiAgICAgICAgdW5kZWZpbmVkOwogICAgfQogIH07CgogIC8vIFNldCBjb250ZW50ZWRpdGFibGUgdG8gZmFsc2Ugb24gcmVtb3ZhbHMoIzEwNDI5KQogIC8vIFNldHRpbmcgdG8gZW1wdHkgc3RyaW5nIHRocm93cyBhbiBlcnJvciBhcyBhbiBpbnZhbGlkIHZhbHVlCiAgalF1ZXJ5LmF0dHJIb29rcy5jb250ZW50ZWRpdGFibGUgPSB7CiAgICBnZXQ6IG5vZGVIb29rLmdldCwKICAgIHNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewogICAgICBub2RlSG9vay5zZXQoIGVsZW0sIHZhbHVlID09PSAiIiA/IGZhbHNlIDogdmFsdWUsIG5hbWUgKTsKICAgIH0KICB9OwoKICAvLyBTZXQgd2lkdGggYW5kIGhlaWdodCB0byBhdXRvIGluc3RlYWQgb2YgMCBvbiBlbXB0eSBzdHJpbmcoIEJ1ZyAjODE1MCApCiAgLy8gVGhpcyBpcyBmb3IgcmVtb3ZhbHMKICBqUXVlcnkuZWFjaChbICJ3aWR0aCIsICJoZWlnaHQiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewogICAgalF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggalF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdLCB7CiAgICAgIHNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewogICAgICAgIGlmICggdmFsdWUgPT09ICIiICkgewogICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsICJhdXRvIiApOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSk7Cn0KCgovLyBTb21lIGF0dHJpYnV0ZXMgcmVxdWlyZSBhIHNwZWNpYWwgY2FsbCBvbiBJRQovLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4CmlmICggIWpRdWVyeS5zdXBwb3J0LmhyZWZOb3JtYWxpemVkICkgewogIGpRdWVyeS5lYWNoKFsgImhyZWYiLCAic3JjIiwgIndpZHRoIiwgImhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CiAgICBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gPSBqUXVlcnkuZXh0ZW5kKCBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0sIHsKICAgICAgZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICB2YXIgcmV0ID0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIDIgKTsKICAgICAgICByZXR1cm4gcmV0ID09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICAgIH0KICAgIH0pOwogIH0pOwoKICAvLyBocmVmL3NyYyBwcm9wZXJ0eSBzaG91bGQgZ2V0IHRoZSBmdWxsIG5vcm1hbGl6ZWQgVVJMICgjMTAyOTkvIzEyOTE1KQogIGpRdWVyeS5lYWNoKFsgImhyZWYiLCAic3JjIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKICAgIGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXSA9IHsKICAgICAgZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIDQgKTsKICAgICAgfQogICAgfTsKICB9KTsKfQoKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuc3R5bGUgKSB7CiAgalF1ZXJ5LmF0dHJIb29rcy5zdHlsZSA9IHsKICAgIGdldDogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIC8vIFJldHVybiB1bmRlZmluZWQgaW4gdGhlIGNhc2Ugb2YgZW1wdHkgc3RyaW5nCiAgICAgIC8vIE5vdGU6IElFIHVwcGVyY2FzZXMgY3NzIHByb3BlcnR5IG5hbWVzLCBidXQgaWYgd2Ugd2VyZSB0byAudG9Mb3dlckNhc2UoKQogICAgICAvLyAuY3NzVGV4dCwgdGhhdCB3b3VsZCBkZXN0cm95IGNhc2Ugc2Vuc3RpdGl2aXR5IGluIFVSTCdzLCBsaWtlIGluICJiYWNrZ3JvdW5kIgogICAgICByZXR1cm4gZWxlbS5zdHlsZS5jc3NUZXh0IHx8IHVuZGVmaW5lZDsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKICAgICAgcmV0dXJuICggZWxlbS5zdHlsZS5jc3NUZXh0ID0gdmFsdWUgKyAiIiApOwogICAgfQogIH07Cn0KCi8vIFNhZmFyaSBtaXMtcmVwb3J0cyB0aGUgZGVmYXVsdCBzZWxlY3RlZCBwcm9wZXJ0eSBvZiBhbiBvcHRpb24KLy8gQWNjZXNzaW5nIHRoZSBwYXJlbnQncyBzZWxlY3RlZEluZGV4IHByb3BlcnR5IGZpeGVzIGl0CmlmICggIWpRdWVyeS5zdXBwb3J0Lm9wdFNlbGVjdGVkICkgewogIGpRdWVyeS5wcm9wSG9va3Muc2VsZWN0ZWQgPSBqUXVlcnkuZXh0ZW5kKCBqUXVlcnkucHJvcEhvb2tzLnNlbGVjdGVkLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoKICAgICAgaWYgKCBwYXJlbnQgKSB7CiAgICAgICAgcGFyZW50LnNlbGVjdGVkSW5kZXg7CgogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGl0IGFsc28gd29ya3Mgd2l0aCBvcHRncm91cHMsIHNlZSAjNTcwMQogICAgICAgIGlmICggcGFyZW50LnBhcmVudE5vZGUgKSB7CiAgICAgICAgICBwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9KTsKfQoKLy8gSUU2LzcgY2FsbCBlbmN0eXBlIGVuY29kaW5nCmlmICggIWpRdWVyeS5zdXBwb3J0LmVuY3R5cGUgKSB7CiAgalF1ZXJ5LnByb3BGaXguZW5jdHlwZSA9ICJlbmNvZGluZyI7Cn0KCi8vIFJhZGlvcyBhbmQgY2hlY2tib3hlcyBnZXR0ZXIvc2V0dGVyCmlmICggIWpRdWVyeS5zdXBwb3J0LmNoZWNrT24gKSB7CiAgalF1ZXJ5LmVhY2goWyAicmFkaW8iLCAiY2hlY2tib3giIF0sIGZ1bmN0aW9uKCkgewogICAgalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0gPSB7CiAgICAgIGdldDogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIGluIFdlYmtpdCAiIiBpcyByZXR1cm5lZCBpbnN0ZWFkIG9mICJvbiIgaWYgYSB2YWx1ZSBpc24ndCBzcGVjaWZpZWQKICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInZhbHVlIikgPT09IG51bGwgPyAib24iIDogZWxlbS52YWx1ZTsKICAgICAgfQogICAgfTsKICB9KTsKfQpqUXVlcnkuZWFjaChbICJyYWRpbyIsICJjaGVja2JveCIgXSwgZnVuY3Rpb24oKSB7CiAgalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0gPSBqUXVlcnkuZXh0ZW5kKCBqUXVlcnkudmFsSG9va3NbIHRoaXMgXSwgewogICAgc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CiAgICAgIGlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbHVlICkgKSB7CiAgICAgICAgcmV0dXJuICggZWxlbS5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoIGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUgKSA+PSAwICk7CiAgICAgIH0KICAgIH0KICB9KTsKfSk7CnZhciByZm9ybUVsZW1zID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWEpJC9pLAogIHJrZXlFdmVudCA9IC9ea2V5LywKICBybW91c2VFdmVudCA9IC9eKD86bW91c2V8Y29udGV4dG1lbnUpfGNsaWNrLywKICByZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywKICBydHlwZW5hbWVzcGFjZSA9IC9eKFteLl0qKSg/OlwuKC4rKXwpJC87CgpmdW5jdGlvbiByZXR1cm5UcnVlKCkgewogIHJldHVybiB0cnVlOwp9CgpmdW5jdGlvbiByZXR1cm5GYWxzZSgpIHsKICByZXR1cm4gZmFsc2U7Cn0KCi8qCiAqIEhlbHBlciBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIGV2ZW50cyAtLSBub3QgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4KICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICovCmpRdWVyeS5ldmVudCA9IHsKCiAgZ2xvYmFsOiB7fSwKCiAgYWRkOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yICkgewoKICAgIHZhciBoYW5kbGVPYmpJbiwgZXZlbnRIYW5kbGUsIHRtcCwKICAgICAgZXZlbnRzLCB0LCBoYW5kbGVPYmosCiAgICAgIHNwZWNpYWwsIGhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwKICAgICAgLy8gRG9uJ3QgYXR0YWNoIGV2ZW50cyB0byBub0RhdGEgb3IgdGV4dC9jb21tZW50IG5vZGVzIChidXQgYWxsb3cgcGxhaW4gb2JqZWN0cykKICAgICAgZWxlbURhdGEgPSBlbGVtLm5vZGVUeXBlICE9PSAzICYmIGVsZW0ubm9kZVR5cGUgIT09IDggJiYgalF1ZXJ5Ll9kYXRhKCBlbGVtICk7CgogICAgaWYgKCAhZWxlbURhdGEgKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYW4gb2JqZWN0IG9mIGN1c3RvbSBkYXRhIGluIGxpZXUgb2YgdGhlIGhhbmRsZXIKICAgIGlmICggaGFuZGxlci5oYW5kbGVyICkgewogICAgICBoYW5kbGVPYmpJbiA9IGhhbmRsZXI7CiAgICAgIGhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwogICAgICBzZWxlY3RvciA9IGhhbmRsZU9iakluLnNlbGVjdG9yOwogICAgfQoKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBoYW5kbGVyIGhhcyBhIHVuaXF1ZSBJRCwgdXNlZCB0byBmaW5kL3JlbW92ZSBpdCBsYXRlcgogICAgaWYgKCAhaGFuZGxlci5ndWlkICkgewogICAgICBoYW5kbGVyLmd1aWQgPSBqUXVlcnkuZ3VpZCsrOwogICAgfQoKICAgIC8vIEluaXQgdGhlIGVsZW1lbnQncyBldmVudCBzdHJ1Y3R1cmUgYW5kIG1haW4gaGFuZGxlciwgaWYgdGhpcyBpcyB0aGUgZmlyc3QKICAgIGlmICggIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpICkgewogICAgICBldmVudHMgPSBlbGVtRGF0YS5ldmVudHMgPSB7fTsKICAgIH0KICAgIGlmICggIShldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSkgKSB7CiAgICAgIGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlID0gZnVuY3Rpb24oIGUgKSB7CiAgICAgICAgLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKICAgICAgICAvLyB3aGVuIGFuIGV2ZW50IGlzIGNhbGxlZCBhZnRlciBhIHBhZ2UgaGFzIHVubG9hZGVkCiAgICAgICAgcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT09ICJ1bmRlZmluZWQiICYmICghZSB8fCBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUpID8KICAgICAgICAgIGpRdWVyeS5ldmVudC5kaXNwYXRjaC5hcHBseSggZXZlbnRIYW5kbGUuZWxlbSwgYXJndW1lbnRzICkgOgogICAgICAgICAgdW5kZWZpbmVkOwogICAgICB9OwogICAgICAvLyBBZGQgZWxlbSBhcyBhIHByb3BlcnR5IG9mIHRoZSBoYW5kbGUgZm4gdG8gcHJldmVudCBhIG1lbW9yeSBsZWFrIHdpdGggSUUgbm9uLW5hdGl2ZSBldmVudHMKICAgICAgZXZlbnRIYW5kbGUuZWxlbSA9IGVsZW07CiAgICB9CgogICAgLy8gSGFuZGxlIG11bHRpcGxlIGV2ZW50cyBzZXBhcmF0ZWQgYnkgYSBzcGFjZQogICAgLy8galF1ZXJ5KC4uLikuYmluZCgibW91c2VvdmVyIG1vdXNlb3V0IiwgZm4pOwogICAgdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgWyIiXTsKICAgIHQgPSB0eXBlcy5sZW5ndGg7CiAgICB3aGlsZSAoIHQtLSApIHsKICAgICAgdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKICAgICAgdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwogICAgICBuYW1lc3BhY2VzID0gKCB0bXBbMl0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKICAgICAgLy8gSWYgZXZlbnQgY2hhbmdlcyBpdHMgdHlwZSwgdXNlIHRoZSBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgY2hhbmdlZCB0eXBlCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoKICAgICAgLy8gSWYgc2VsZWN0b3IgZGVmaW5lZCwgZGV0ZXJtaW5lIHNwZWNpYWwgZXZlbnQgYXBpIHR5cGUsIG90aGVyd2lzZSBnaXZlbiB0eXBlCiAgICAgIHR5cGUgPSAoIHNlbGVjdG9yID8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlICkgfHwgdHlwZTsKCiAgICAgIC8vIFVwZGF0ZSBzcGVjaWFsIGJhc2VkIG9uIG5ld2x5IHJlc2V0IHR5cGUKICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgogICAgICAvLyBoYW5kbGVPYmogaXMgcGFzc2VkIHRvIGFsbCBldmVudCBoYW5kbGVycwogICAgICBoYW5kbGVPYmogPSBqUXVlcnkuZXh0ZW5kKHsKICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgIG9yaWdUeXBlOiBvcmlnVHlwZSwKICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgZ3VpZDogaGFuZGxlci5ndWlkLAogICAgICAgIHNlbGVjdG9yOiBzZWxlY3RvciwKICAgICAgICBuZWVkc0NvbnRleHQ6IHNlbGVjdG9yICYmIGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KCBzZWxlY3RvciApLAogICAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlcy5qb2luKCIuIikKICAgICAgfSwgaGFuZGxlT2JqSW4gKTsKCiAgICAgIC8vIEluaXQgdGhlIGV2ZW50IGhhbmRsZXIgcXVldWUgaWYgd2UncmUgdGhlIGZpcnN0CiAgICAgIGlmICggIShoYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdKSApIHsKICAgICAgICBoYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdID0gW107CiAgICAgICAgaGFuZGxlcnMuZGVsZWdhdGVDb3VudCA9IDA7CgogICAgICAgIC8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIvYXR0YWNoRXZlbnQgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQogICAgICAgIGlmICggIXNwZWNpYWwuc2V0dXAgfHwgc3BlY2lhbC5zZXR1cC5jYWxsKCBlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSApID09PSBmYWxzZSApIHsKICAgICAgICAgIC8vIEJpbmQgdGhlIGdsb2JhbCBldmVudCBoYW5kbGVyIHRvIHRoZSBlbGVtZW50CiAgICAgICAgICBpZiAoIGVsZW0uYWRkRXZlbnRMaXN0ZW5lciApIHsKICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBldmVudEhhbmRsZSwgZmFsc2UgKTsKCiAgICAgICAgICB9IGVsc2UgaWYgKCBlbGVtLmF0dGFjaEV2ZW50ICkgewogICAgICAgICAgICBlbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZXZlbnRIYW5kbGUgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICggc3BlY2lhbC5hZGQgKSB7CiAgICAgICAgc3BlY2lhbC5hZGQuY2FsbCggZWxlbSwgaGFuZGxlT2JqICk7CgogICAgICAgIGlmICggIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgKSB7CiAgICAgICAgICBoYW5kbGVPYmouaGFuZGxlci5ndWlkID0gaGFuZGxlci5ndWlkOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQWRkIHRvIHRoZSBlbGVtZW50J3MgaGFuZGxlciBsaXN0LCBkZWxlZ2F0ZXMgaW4gZnJvbnQKICAgICAgaWYgKCBzZWxlY3RvciApIHsKICAgICAgICBoYW5kbGVycy5zcGxpY2UoIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQrKywgMCwgaGFuZGxlT2JqICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlcnMucHVzaCggaGFuZGxlT2JqICk7CiAgICAgIH0KCiAgICAgIC8vIEtlZXAgdHJhY2sgb2Ygd2hpY2ggZXZlbnRzIGhhdmUgZXZlciBiZWVuIHVzZWQsIGZvciBldmVudCBvcHRpbWl6YXRpb24KICAgICAgalF1ZXJ5LmV2ZW50Lmdsb2JhbFsgdHlwZSBdID0gdHJ1ZTsKICAgIH0KCiAgICAvLyBOdWxsaWZ5IGVsZW0gdG8gcHJldmVudCBtZW1vcnkgbGVha3MgaW4gSUUKICAgIGVsZW0gPSBudWxsOwogIH0sCgogIC8vIERldGFjaCBhbiBldmVudCBvciBzZXQgb2YgZXZlbnRzIGZyb20gYW4gZWxlbWVudAogIHJlbW92ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBzZWxlY3RvciwgbWFwcGVkVHlwZXMgKSB7CgogICAgdmFyIGosIG9yaWdDb3VudCwgdG1wLAogICAgICBldmVudHMsIHQsIGhhbmRsZU9iaiwKICAgICAgc3BlY2lhbCwgaGFuZGxlcnMsIHR5cGUsIG5hbWVzcGFjZXMsIG9yaWdUeXBlLAogICAgICBlbGVtRGF0YSA9IGpRdWVyeS5oYXNEYXRhKCBlbGVtICkgJiYgalF1ZXJ5Ll9kYXRhKCBlbGVtICk7CgogICAgaWYgKCAhZWxlbURhdGEgfHwgIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpICkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZAogICAgdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgWyIiXTsKICAgIHQgPSB0eXBlcy5sZW5ndGg7CiAgICB3aGlsZSAoIHQtLSApIHsKICAgICAgdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKICAgICAgdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwogICAgICBuYW1lc3BhY2VzID0gKCB0bXBbMl0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKICAgICAgLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CiAgICAgIGlmICggIXR5cGUgKSB7CiAgICAgICAgZm9yICggdHlwZSBpbiBldmVudHMgKSB7CiAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICsgdHlwZXNbIHQgXSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUgKTsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwogICAgICB0eXBlID0gKCBzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSApIHx8IHR5cGU7CiAgICAgIGhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gfHwgW107CiAgICAgIHRtcCA9IHRtcFsyXSAmJiBuZXcgUmVnRXhwKCAiKF58XFwuKSIgKyBuYW1lc3BhY2VzLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIiApOwoKICAgICAgLy8gUmVtb3ZlIG1hdGNoaW5nIGV2ZW50cwogICAgICBvcmlnQ291bnQgPSBqID0gaGFuZGxlcnMubGVuZ3RoOwogICAgICB3aGlsZSAoIGotLSApIHsKICAgICAgICBoYW5kbGVPYmogPSBoYW5kbGVyc1sgaiBdOwoKICAgICAgICBpZiAoICggbWFwcGVkVHlwZXMgfHwgb3JpZ1R5cGUgPT09IGhhbmRsZU9iai5vcmlnVHlwZSApICYmCiAgICAgICAgICAoICFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSAmJgogICAgICAgICAgKCAhdG1wIHx8IHRtcC50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSAmJgogICAgICAgICAgKCAhc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09IGhhbmRsZU9iai5zZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gIioqIiAmJiBoYW5kbGVPYmouc2VsZWN0b3IgKSApIHsKICAgICAgICAgIGhhbmRsZXJzLnNwbGljZSggaiwgMSApOwoKICAgICAgICAgIGlmICggaGFuZGxlT2JqLnNlbGVjdG9yICkgewogICAgICAgICAgICBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LS07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIHNwZWNpYWwucmVtb3ZlICkgewogICAgICAgICAgICBzcGVjaWFsLnJlbW92ZS5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgd2UgcmVtb3ZlZCBzb21ldGhpbmcgYW5kIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKICAgICAgLy8gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGVuZGxlc3MgcmVjdXJzaW9uIGR1cmluZyByZW1vdmFsIG9mIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMpCiAgICAgIGlmICggb3JpZ0NvdW50ICYmICFoYW5kbGVycy5sZW5ndGggKSB7CiAgICAgICAgaWYgKCAhc3BlY2lhbC50ZWFyZG93biB8fCBzcGVjaWFsLnRlYXJkb3duLmNhbGwoIGVsZW0sIG5hbWVzcGFjZXMsIGVsZW1EYXRhLmhhbmRsZSApID09PSBmYWxzZSApIHsKICAgICAgICAgIGpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlICk7CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgZXZlbnRzWyB0eXBlIF07CiAgICAgIH0KICAgIH0KCiAgICAvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAogICAgaWYgKCBqUXVlcnkuaXNFbXB0eU9iamVjdCggZXZlbnRzICkgKSB7CiAgICAgIGRlbGV0ZSBlbGVtRGF0YS5oYW5kbGU7CgogICAgICAvLyByZW1vdmVEYXRhIGFsc28gY2hlY2tzIGZvciBlbXB0aW5lc3MgYW5kIGNsZWFycyB0aGUgZXhwYW5kbyBpZiBlbXB0eQogICAgICAvLyBzbyB1c2UgaXQgaW5zdGVhZCBvZiBkZWxldGUKICAgICAgalF1ZXJ5Ll9yZW1vdmVEYXRhKCBlbGVtLCAiZXZlbnRzIiApOwogICAgfQogIH0sCgogIHRyaWdnZXI6IGZ1bmN0aW9uKCBldmVudCwgZGF0YSwgZWxlbSwgb25seUhhbmRsZXJzICkgewoKICAgIHZhciBpLCBjdXIsIHRtcCwgYnViYmxlVHlwZSwgb250eXBlLCBoYW5kbGUsIHNwZWNpYWwsCiAgICAgIGV2ZW50UGF0aCA9IFsgZWxlbSB8fCBkb2N1bWVudCBdLAogICAgICB0eXBlID0gZXZlbnQudHlwZSB8fCBldmVudCwKICAgICAgbmFtZXNwYWNlcyA9IGV2ZW50Lm5hbWVzcGFjZSA/IGV2ZW50Lm5hbWVzcGFjZS5zcGxpdCgiLiIpIDogW107CgogICAgY3VyID0gdG1wID0gZWxlbSA9IGVsZW0gfHwgZG9jdW1lbnQ7CgogICAgLy8gRG9uJ3QgZG8gZXZlbnRzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gZm9jdXMvYmx1ciBtb3JwaHMgdG8gZm9jdXNpbi9vdXQ7IGVuc3VyZSB3ZSdyZSBub3QgZmlyaW5nIHRoZW0gcmlnaHQgbm93CiAgICBpZiAoIHJmb2N1c01vcnBoLnRlc3QoIHR5cGUgKyBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICkgKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoIHR5cGUuaW5kZXhPZigiLiIpID49IDAgKSB7CiAgICAgIC8vIE5hbWVzcGFjZWQgdHJpZ2dlcjsgY3JlYXRlIGEgcmVnZXhwIHRvIG1hdGNoIGV2ZW50IHR5cGUgaW4gaGFuZGxlKCkKICAgICAgbmFtZXNwYWNlcyA9IHR5cGUuc3BsaXQoIi4iKTsKICAgICAgdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsKICAgICAgbmFtZXNwYWNlcy5zb3J0KCk7CiAgICB9CiAgICBvbnR5cGUgPSB0eXBlLmluZGV4T2YoIjoiKSA8IDAgJiYgIm9uIiArIHR5cGU7CgogICAgLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGEgalF1ZXJ5LkV2ZW50IG9iamVjdCwgT2JqZWN0LCBvciBqdXN0IGFuIGV2ZW50IHR5cGUgc3RyaW5nCiAgICBldmVudCA9IGV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdID8KICAgICAgZXZlbnQgOgogICAgICBuZXcgalF1ZXJ5LkV2ZW50KCB0eXBlLCB0eXBlb2YgZXZlbnQgPT09ICJvYmplY3QiICYmIGV2ZW50ICk7CgogICAgZXZlbnQuaXNUcmlnZ2VyID0gdHJ1ZTsKICAgIGV2ZW50Lm5hbWVzcGFjZSA9IG5hbWVzcGFjZXMuam9pbigiLiIpOwogICAgZXZlbnQubmFtZXNwYWNlX3JlID0gZXZlbnQubmFtZXNwYWNlID8KICAgICAgbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIgKSA6CiAgICAgIG51bGw7CgogICAgLy8gQ2xlYW4gdXAgdGhlIGV2ZW50IGluIGNhc2UgaXQgaXMgYmVpbmcgcmV1c2VkCiAgICBldmVudC5yZXN1bHQgPSB1bmRlZmluZWQ7CiAgICBpZiAoICFldmVudC50YXJnZXQgKSB7CiAgICAgIGV2ZW50LnRhcmdldCA9IGVsZW07CiAgICB9CgogICAgLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAogICAgZGF0YSA9IGRhdGEgPT0gbnVsbCA/CiAgICAgIFsgZXZlbnQgXSA6CiAgICAgIGpRdWVyeS5tYWtlQXJyYXkoIGRhdGEsIFsgZXZlbnQgXSApOwoKICAgIC8vIEFsbG93IHNwZWNpYWwgZXZlbnRzIHRvIGRyYXcgb3V0c2lkZSB0aGUgbGluZXMKICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwogICAgaWYgKCAhb25seUhhbmRsZXJzICYmIHNwZWNpYWwudHJpZ2dlciAmJiBzcGVjaWFsLnRyaWdnZXIuYXBwbHkoIGVsZW0sIGRhdGEgKSA9PT0gZmFsc2UgKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBEZXRlcm1pbmUgZXZlbnQgcHJvcGFnYXRpb24gcGF0aCBpbiBhZHZhbmNlLCBwZXIgVzNDIGV2ZW50cyBzcGVjICgjOTk1MSkKICAgIC8vIEJ1YmJsZSB1cCB0byBkb2N1bWVudCwgdGhlbiB0byB3aW5kb3c7IHdhdGNoIGZvciBhIGdsb2JhbCBvd25lckRvY3VtZW50IHZhciAoIzk3MjQpCiAgICBpZiAoICFvbmx5SGFuZGxlcnMgJiYgIXNwZWNpYWwubm9CdWJibGUgJiYgIWpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoKICAgICAgYnViYmxlVHlwZSA9IHNwZWNpYWwuZGVsZWdhdGVUeXBlIHx8IHR5cGU7CiAgICAgIGlmICggIXJmb2N1c01vcnBoLnRlc3QoIGJ1YmJsZVR5cGUgKyB0eXBlICkgKSB7CiAgICAgICAgY3VyID0gY3VyLnBhcmVudE5vZGU7CiAgICAgIH0KICAgICAgZm9yICggOyBjdXI7IGN1ciA9IGN1ci5wYXJlbnROb2RlICkgewogICAgICAgIGV2ZW50UGF0aC5wdXNoKCBjdXIgKTsKICAgICAgICB0bXAgPSBjdXI7CiAgICAgIH0KCiAgICAgIC8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQogICAgICBpZiAoIHRtcCA9PT0gKGVsZW0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCkgKSB7CiAgICAgICAgZXZlbnRQYXRoLnB1c2goIHRtcC5kZWZhdWx0VmlldyB8fCB0bXAucGFyZW50V2luZG93IHx8IHdpbmRvdyApOwogICAgICB9CiAgICB9CgogICAgLy8gRmlyZSBoYW5kbGVycyBvbiB0aGUgZXZlbnQgcGF0aAogICAgaSA9IDA7CiAgICB3aGlsZSAoIChjdXIgPSBldmVudFBhdGhbaSsrXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgogICAgICBldmVudC50eXBlID0gaSA+IDEgPwogICAgICAgIGJ1YmJsZVR5cGUgOgogICAgICAgIHNwZWNpYWwuYmluZFR5cGUgfHwgdHlwZTsKCiAgICAgIC8vIGpRdWVyeSBoYW5kbGVyCiAgICAgIGhhbmRsZSA9ICggalF1ZXJ5Ll9kYXRhKCBjdXIsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdICYmIGpRdWVyeS5fZGF0YSggY3VyLCAiaGFuZGxlIiApOwogICAgICBpZiAoIGhhbmRsZSApIHsKICAgICAgICBoYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApOwogICAgICB9CgogICAgICAvLyBOYXRpdmUgaGFuZGxlcgogICAgICBoYW5kbGUgPSBvbnR5cGUgJiYgY3VyWyBvbnR5cGUgXTsKICAgICAgaWYgKCBoYW5kbGUgJiYgalF1ZXJ5LmFjY2VwdERhdGEoIGN1ciApICYmIGhhbmRsZS5hcHBseSAmJiBoYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApID09PSBmYWxzZSApIHsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9CiAgICBldmVudC50eXBlID0gdHlwZTsKCiAgICAvLyBJZiBub2JvZHkgcHJldmVudGVkIHRoZSBkZWZhdWx0IGFjdGlvbiwgZG8gaXQgbm93CiAgICBpZiAoICFvbmx5SGFuZGxlcnMgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoKICAgICAgaWYgKCAoIXNwZWNpYWwuX2RlZmF1bHQgfHwgc3BlY2lhbC5fZGVmYXVsdC5hcHBseSggZWxlbS5vd25lckRvY3VtZW50LCBkYXRhICkgPT09IGZhbHNlKSAmJgogICAgICAgICEodHlwZSA9PT0gImNsaWNrIiAmJiBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJhIiApKSAmJiBqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewoKICAgICAgICAvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgbmFtZSBhcyB0aGUgZXZlbnQuCiAgICAgICAgLy8gQ2FuJ3QgdXNlIGFuIC5pc0Z1bmN0aW9uKCkgY2hlY2sgaGVyZSBiZWNhdXNlIElFNi83IGZhaWxzIHRoYXQgdGVzdC4KICAgICAgICAvLyBEb24ndCBkbyBkZWZhdWx0IGFjdGlvbnMgb24gd2luZG93LCB0aGF0J3Mgd2hlcmUgZ2xvYmFsIHZhcmlhYmxlcyBiZSAoIzYxNzApCiAgICAgICAgaWYgKCBvbnR5cGUgJiYgZWxlbVsgdHlwZSBdICYmICFqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsKCiAgICAgICAgICAvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCiAgICAgICAgICB0bXAgPSBlbGVtWyBvbnR5cGUgXTsKCiAgICAgICAgICBpZiAoIHRtcCApIHsKICAgICAgICAgICAgZWxlbVsgb250eXBlIF0gPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlCiAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdHlwZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGVsZW1bIHR5cGUgXSgpOwogICAgICAgICAgfSBjYXRjaCAoIGUgKSB7CiAgICAgICAgICAgIC8vIElFPDkgZGllcyBvbiBmb2N1cy9ibHVyIHRvIGhpZGRlbiBlbGVtZW50ICgjMTQ4NiwjMTI1MTgpCiAgICAgICAgICAgIC8vIG9ubHkgcmVwcm9kdWNpYmxlIG9uIHdpblhQIElFOCBuYXRpdmUsIG5vdCBJRTkgaW4gSUU4IG1vZGUKICAgICAgICAgIH0KICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CgogICAgICAgICAgaWYgKCB0bXAgKSB7CiAgICAgICAgICAgIGVsZW1bIG9udHlwZSBdID0gdG1wOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBldmVudC5yZXN1bHQ7CiAgfSwKCiAgZGlzcGF0Y2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCiAgICAvLyBNYWtlIGEgd3JpdGFibGUgalF1ZXJ5LkV2ZW50IGZyb20gdGhlIG5hdGl2ZSBldmVudCBvYmplY3QKICAgIGV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgKTsKCiAgICB2YXIgaSwgaiwgcmV0LCBtYXRjaGVkLCBoYW5kbGVPYmosCiAgICAgIGhhbmRsZXJRdWV1ZSA9IFtdLAogICAgICBhcmdzID0gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSwKICAgICAgaGFuZGxlcnMgPSAoIGpRdWVyeS5fZGF0YSggdGhpcywgImV2ZW50cyIgKSB8fCB7fSApWyBldmVudC50eXBlIF0gfHwgW10sCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgZXZlbnQudHlwZSBdIHx8IHt9OwoKICAgIC8vIFVzZSB0aGUgZml4LWVkIGpRdWVyeS5FdmVudCByYXRoZXIgdGhhbiB0aGUgKHJlYWQtb25seSkgbmF0aXZlIGV2ZW50CiAgICBhcmdzWzBdID0gZXZlbnQ7CiAgICBldmVudC5kZWxlZ2F0ZVRhcmdldCA9IHRoaXM7CgogICAgLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZAogICAgaWYgKCBzcGVjaWFsLnByZURpc3BhdGNoICYmIHNwZWNpYWwucHJlRGlzcGF0Y2guY2FsbCggdGhpcywgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBEZXRlcm1pbmUgaGFuZGxlcnMKICAgIGhhbmRsZXJRdWV1ZSA9IGpRdWVyeS5ldmVudC5oYW5kbGVycy5jYWxsKCB0aGlzLCBldmVudCwgaGFuZGxlcnMgKTsKCiAgICAvLyBSdW4gZGVsZWdhdGVzIGZpcnN0OyB0aGV5IG1heSB3YW50IHRvIHN0b3AgcHJvcGFnYXRpb24gYmVuZWF0aCB1cwogICAgaSA9IDA7CiAgICB3aGlsZSAoIChtYXRjaGVkID0gaGFuZGxlclF1ZXVlWyBpKysgXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CiAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CgogICAgICBqID0gMDsKICAgICAgd2hpbGUgKCAoaGFuZGxlT2JqID0gbWF0Y2hlZC5oYW5kbGVyc1sgaisrIF0pICYmICFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoKICAgICAgICAvLyBUcmlnZ2VyZWQgZXZlbnQgbXVzdCBlaXRoZXIgMSkgaGF2ZSBubyBuYW1lc3BhY2UsIG9yCiAgICAgICAgLy8gMikgaGF2ZSBuYW1lc3BhY2UocykgYSBzdWJzZXQgb3IgZXF1YWwgdG8gdGhvc2UgaW4gdGhlIGJvdW5kIGV2ZW50IChib3RoIGNhbiBoYXZlIG5vIG5hbWVzcGFjZSkuCiAgICAgICAgaWYgKCAhZXZlbnQubmFtZXNwYWNlX3JlIHx8IGV2ZW50Lm5hbWVzcGFjZV9yZS50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSB7CgogICAgICAgICAgZXZlbnQuaGFuZGxlT2JqID0gaGFuZGxlT2JqOwogICAgICAgICAgZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOwoKICAgICAgICAgIHJldCA9ICggKGpRdWVyeS5ldmVudC5zcGVjaWFsWyBoYW5kbGVPYmoub3JpZ1R5cGUgXSB8fCB7fSkuaGFuZGxlIHx8IGhhbmRsZU9iai5oYW5kbGVyICkKICAgICAgICAgICAgICAuYXBwbHkoIG1hdGNoZWQuZWxlbSwgYXJncyApOwoKICAgICAgICAgIGlmICggcmV0ICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgIGlmICggKGV2ZW50LnJlc3VsdCA9IHJldCkgPT09IGZhbHNlICkgewogICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBDYWxsIHRoZSBwb3N0RGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlCiAgICBpZiAoIHNwZWNpYWwucG9zdERpc3BhdGNoICkgewogICAgICBzcGVjaWFsLnBvc3REaXNwYXRjaC5jYWxsKCB0aGlzLCBldmVudCApOwogICAgfQoKICAgIHJldHVybiBldmVudC5yZXN1bHQ7CiAgfSwKCiAgaGFuZGxlcnM6IGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlcnMgKSB7CiAgICB2YXIgaSwgbWF0Y2hlcywgc2VsLCBoYW5kbGVPYmosCiAgICAgIGhhbmRsZXJRdWV1ZSA9IFtdLAogICAgICBkZWxlZ2F0ZUNvdW50ID0gaGFuZGxlcnMuZGVsZWdhdGVDb3VudCwKICAgICAgY3VyID0gZXZlbnQudGFyZ2V0OwoKICAgIC8vIEZpbmQgZGVsZWdhdGUgaGFuZGxlcnMKICAgIC8vIEJsYWNrLWhvbGUgU1ZHIDx1c2U+IGluc3RhbmNlIHRyZWVzICgjMTMxODApCiAgICAvLyBBdm9pZCBub24tbGVmdC1jbGljayBidWJibGluZyBpbiBGaXJlZm94ICgjMzg2MSkKICAgIGlmICggZGVsZWdhdGVDb3VudCAmJiBjdXIubm9kZVR5cGUgJiYgKCFldmVudC5idXR0b24gfHwgZXZlbnQudHlwZSAhPT0gImNsaWNrIikgKSB7CgogICAgICBmb3IgKCA7IGN1ciAhPSB0aGlzOyBjdXIgPSBjdXIucGFyZW50Tm9kZSB8fCB0aGlzICkgewoKICAgICAgICAvLyBEb24ndCBwcm9jZXNzIGNsaWNrcyBvbiBkaXNhYmxlZCBlbGVtZW50cyAoIzY5MTEsICM4MTY1LCAjMTEzODIsICMxMTc2NCkKICAgICAgICBpZiAoIGN1ci5kaXNhYmxlZCAhPT0gdHJ1ZSB8fCBldmVudC50eXBlICE9PSAiY2xpY2siICkgewogICAgICAgICAgbWF0Y2hlcyA9IFtdOwogICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBkZWxlZ2F0ZUNvdW50OyBpKysgKSB7CiAgICAgICAgICAgIGhhbmRsZU9iaiA9IGhhbmRsZXJzWyBpIF07CgogICAgICAgICAgICAvLyBEb24ndCBjb25mbGljdCB3aXRoIE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoIzEzMjAzKQogICAgICAgICAgICBzZWwgPSBoYW5kbGVPYmouc2VsZWN0b3IgKyAiICI7CgogICAgICAgICAgICBpZiAoIG1hdGNoZXNbIHNlbCBdID09PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgICAgbWF0Y2hlc1sgc2VsIF0gPSBoYW5kbGVPYmoubmVlZHNDb250ZXh0ID8KICAgICAgICAgICAgICAgIGpRdWVyeSggc2VsLCB0aGlzICkuaW5kZXgoIGN1ciApID49IDAgOgogICAgICAgICAgICAgICAgalF1ZXJ5LmZpbmQoIHNlbCwgdGhpcywgbnVsbCwgWyBjdXIgXSApLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIG1hdGNoZXNbIHNlbCBdICkgewogICAgICAgICAgICAgIG1hdGNoZXMucHVzaCggaGFuZGxlT2JqICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICggbWF0Y2hlcy5sZW5ndGggKSB7CiAgICAgICAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsgZWxlbTogY3VyLCBoYW5kbGVyczogbWF0Y2hlcyB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBBZGQgdGhlIHJlbWFpbmluZyAoZGlyZWN0bHktYm91bmQpIGhhbmRsZXJzCiAgICBpZiAoIGRlbGVnYXRlQ291bnQgPCBoYW5kbGVycy5sZW5ndGggKSB7CiAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsgZWxlbTogdGhpcywgaGFuZGxlcnM6IGhhbmRsZXJzLnNsaWNlKCBkZWxlZ2F0ZUNvdW50ICkgfSk7CiAgICB9CgogICAgcmV0dXJuIGhhbmRsZXJRdWV1ZTsKICB9LAoKICBmaXg6IGZ1bmN0aW9uKCBldmVudCApIHsKICAgIGlmICggZXZlbnRbIGpRdWVyeS5leHBhbmRvIF0gKSB7CiAgICAgIHJldHVybiBldmVudDsKICAgIH0KCiAgICAvLyBDcmVhdGUgYSB3cml0YWJsZSBjb3B5IG9mIHRoZSBldmVudCBvYmplY3QgYW5kIG5vcm1hbGl6ZSBzb21lIHByb3BlcnRpZXMKICAgIHZhciBpLCBwcm9wLAogICAgICBvcmlnaW5hbEV2ZW50ID0gZXZlbnQsCiAgICAgIGZpeEhvb2sgPSBqUXVlcnkuZXZlbnQuZml4SG9va3NbIGV2ZW50LnR5cGUgXSB8fCB7fSwKICAgICAgY29weSA9IGZpeEhvb2sucHJvcHMgPyB0aGlzLnByb3BzLmNvbmNhdCggZml4SG9vay5wcm9wcyApIDogdGhpcy5wcm9wczsKCiAgICBldmVudCA9IG5ldyBqUXVlcnkuRXZlbnQoIG9yaWdpbmFsRXZlbnQgKTsKCiAgICBpID0gY29weS5sZW5ndGg7CiAgICB3aGlsZSAoIGktLSApIHsKICAgICAgcHJvcCA9IGNvcHlbIGkgXTsKICAgICAgZXZlbnRbIHByb3AgXSA9IG9yaWdpbmFsRXZlbnRbIHByb3AgXTsKICAgIH0KCiAgICAvLyBTdXBwb3J0OiBJRTw5CiAgICAvLyBGaXggdGFyZ2V0IHByb3BlcnR5ICgjMTkyNSkKICAgIGlmICggIWV2ZW50LnRhcmdldCApIHsKICAgICAgZXZlbnQudGFyZ2V0ID0gb3JpZ2luYWxFdmVudC5zcmNFbGVtZW50IHx8IGRvY3VtZW50OwogICAgfQoKICAgIC8vIFN1cHBvcnQ6IENocm9tZSAyMyssIFNhZmFyaT8KICAgIC8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCAjMTMxNDMpCiAgICBpZiAoIGV2ZW50LnRhcmdldC5ub2RlVHlwZSA9PT0gMyApIHsKICAgICAgZXZlbnQudGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7CiAgICB9CgogICAgLy8gU3VwcG9ydDogSUU8OQogICAgLy8gRm9yIG1vdXNlL2tleSBldmVudHMsIG1ldGFLZXk9PWZhbHNlIGlmIGl0J3MgdW5kZWZpbmVkICgjMzM2OCwgIzExMzI4KQogICAgZXZlbnQubWV0YUtleSA9ICEhZXZlbnQubWV0YUtleTsKCiAgICByZXR1cm4gZml4SG9vay5maWx0ZXIgPyBmaXhIb29rLmZpbHRlciggZXZlbnQsIG9yaWdpbmFsRXZlbnQgKSA6IGV2ZW50OwogIH0sCgogIC8vIEluY2x1ZGVzIHNvbWUgZXZlbnQgcHJvcHMgc2hhcmVkIGJ5IEtleUV2ZW50IGFuZCBNb3VzZUV2ZW50CiAgcHJvcHM6ICJhbHRLZXkgYnViYmxlcyBjYW5jZWxhYmxlIGN0cmxLZXkgY3VycmVudFRhcmdldCBldmVudFBoYXNlIG1ldGFLZXkgcmVsYXRlZFRhcmdldCBzaGlmdEtleSB0YXJnZXQgdGltZVN0YW1wIHZpZXcgd2hpY2giLnNwbGl0KCIgIiksCgogIGZpeEhvb2tzOiB7fSwKCiAga2V5SG9va3M6IHsKICAgIHByb3BzOiAiY2hhciBjaGFyQ29kZSBrZXkga2V5Q29kZSIuc3BsaXQoIiAiKSwKICAgIGZpbHRlcjogZnVuY3Rpb24oIGV2ZW50LCBvcmlnaW5hbCApIHsKCiAgICAgIC8vIEFkZCB3aGljaCBmb3Iga2V5IGV2ZW50cwogICAgICBpZiAoIGV2ZW50LndoaWNoID09IG51bGwgKSB7CiAgICAgICAgZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOwogICAgICB9CgogICAgICByZXR1cm4gZXZlbnQ7CiAgICB9CiAgfSwKCiAgbW91c2VIb29rczogewogICAgcHJvcHM6ICJidXR0b24gYnV0dG9ucyBjbGllbnRYIGNsaWVudFkgZnJvbUVsZW1lbnQgb2Zmc2V0WCBvZmZzZXRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSB0b0VsZW1lbnQiLnNwbGl0KCIgIiksCiAgICBmaWx0ZXI6IGZ1bmN0aW9uKCBldmVudCwgb3JpZ2luYWwgKSB7CiAgICAgIHZhciBldmVudERvYywgZG9jLCBib2R5LAogICAgICAgIGJ1dHRvbiA9IG9yaWdpbmFsLmJ1dHRvbiwKICAgICAgICBmcm9tRWxlbWVudCA9IG9yaWdpbmFsLmZyb21FbGVtZW50OwoKICAgICAgLy8gQ2FsY3VsYXRlIHBhZ2VYL1kgaWYgbWlzc2luZyBhbmQgY2xpZW50WC9ZIGF2YWlsYWJsZQogICAgICBpZiAoIGV2ZW50LnBhZ2VYID09IG51bGwgJiYgb3JpZ2luYWwuY2xpZW50WCAhPSBudWxsICkgewogICAgICAgIGV2ZW50RG9jID0gZXZlbnQudGFyZ2V0Lm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgZG9jID0gZXZlbnREb2MuZG9jdW1lbnRFbGVtZW50OwogICAgICAgIGJvZHkgPSBldmVudERvYy5ib2R5OwoKICAgICAgICBldmVudC5wYWdlWCA9IG9yaWdpbmFsLmNsaWVudFggKyAoIGRvYyAmJiBkb2Muc2Nyb2xsTGVmdCB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsTGVmdCB8fCAwICkgLSAoIGRvYyAmJiBkb2MuY2xpZW50TGVmdCB8fCBib2R5ICYmIGJvZHkuY2xpZW50TGVmdCB8fCAwICk7CiAgICAgICAgZXZlbnQucGFnZVkgPSBvcmlnaW5hbC5jbGllbnRZICsgKCBkb2MgJiYgZG9jLnNjcm9sbFRvcCAgfHwgYm9keSAmJiBib2R5LnNjcm9sbFRvcCAgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudFRvcCAgfHwgYm9keSAmJiBib2R5LmNsaWVudFRvcCAgfHwgMCApOwogICAgICB9CgogICAgICAvLyBBZGQgcmVsYXRlZFRhcmdldCwgaWYgbmVjZXNzYXJ5CiAgICAgIGlmICggIWV2ZW50LnJlbGF0ZWRUYXJnZXQgJiYgZnJvbUVsZW1lbnQgKSB7CiAgICAgICAgZXZlbnQucmVsYXRlZFRhcmdldCA9IGZyb21FbGVtZW50ID09PSBldmVudC50YXJnZXQgPyBvcmlnaW5hbC50b0VsZW1lbnQgOiBmcm9tRWxlbWVudDsKICAgICAgfQoKICAgICAgLy8gQWRkIHdoaWNoIGZvciBjbGljazogMSA9PT0gbGVmdDsgMiA9PT0gbWlkZGxlOyAzID09PSByaWdodAogICAgICAvLyBOb3RlOiBidXR0b24gaXMgbm90IG5vcm1hbGl6ZWQsIHNvIGRvbid0IHVzZSBpdAogICAgICBpZiAoICFldmVudC53aGljaCAmJiBidXR0b24gIT09IHVuZGVmaW5lZCApIHsKICAgICAgICBldmVudC53aGljaCA9ICggYnV0dG9uICYgMSA/IDEgOiAoIGJ1dHRvbiAmIDIgPyAzIDogKCBidXR0b24gJiA0ID8gMiA6IDAgKSApICk7CiAgICAgIH0KCiAgICAgIHJldHVybiBldmVudDsKICAgIH0KICB9LAoKICBzcGVjaWFsOiB7CiAgICBsb2FkOiB7CiAgICAgIC8vIFByZXZlbnQgdHJpZ2dlcmVkIGltYWdlLmxvYWQgZXZlbnRzIGZyb20gYnViYmxpbmcgdG8gd2luZG93LmxvYWQKICAgICAgbm9CdWJibGU6IHRydWUKICAgIH0sCiAgICBjbGljazogewogICAgICAvLyBGb3IgY2hlY2tib3gsIGZpcmUgbmF0aXZlIGV2ZW50IHNvIGNoZWNrZWQgc3RhdGUgd2lsbCBiZSByaWdodAogICAgICB0cmlnZ2VyOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgImlucHV0IiApICYmIHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiAmJiB0aGlzLmNsaWNrICkgewogICAgICAgICAgdGhpcy5jbGljaygpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGZvY3VzOiB7CiAgICAgIC8vIEZpcmUgbmF0aXZlIGV2ZW50IGlmIHBvc3NpYmxlIHNvIGJsdXIvZm9jdXMgc2VxdWVuY2UgaXMgY29ycmVjdAogICAgICB0cmlnZ2VyOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIHRoaXMgIT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgdGhpcy5mb2N1cyApIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBjYXRjaCAoIGUgKSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFPDkKICAgICAgICAgICAgLy8gSWYgd2UgZXJyb3Igb24gZm9jdXMgdG8gaGlkZGVuIGVsZW1lbnQgKCMxNDg2LCAjMTI1MTgpLAogICAgICAgICAgICAvLyBsZXQgLnRyaWdnZXIoKSBydW4gdGhlIGhhbmRsZXJzCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBkZWxlZ2F0ZVR5cGU6ICJmb2N1c2luIgogICAgfSwKICAgIGJsdXI6IHsKICAgICAgdHJpZ2dlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCB0aGlzID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIHRoaXMuYmx1ciApIHsKICAgICAgICAgIHRoaXMuYmx1cigpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVsZWdhdGVUeXBlOiAiZm9jdXNvdXQiCiAgICB9LAoKICAgIGJlZm9yZXVubG9hZDogewogICAgICBwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCiAgICAgICAgLy8gRXZlbiB3aGVuIHJldHVyblZhbHVlIGVxdWFscyB0byB1bmRlZmluZWQgRmlyZWZveCB3aWxsIHN0aWxsIHNob3cgYWxlcnQKICAgICAgICBpZiAoIGV2ZW50LnJlc3VsdCAhPT0gdW5kZWZpbmVkICkgewogICAgICAgICAgZXZlbnQub3JpZ2luYWxFdmVudC5yZXR1cm5WYWx1ZSA9IGV2ZW50LnJlc3VsdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LAoKICBzaW11bGF0ZTogZnVuY3Rpb24oIHR5cGUsIGVsZW0sIGV2ZW50LCBidWJibGUgKSB7CiAgICAvLyBQaWdneWJhY2sgb24gYSBkb25vciBldmVudCB0byBzaW11bGF0ZSBhIGRpZmZlcmVudCBvbmUuCiAgICAvLyBGYWtlIG9yaWdpbmFsRXZlbnQgdG8gYXZvaWQgZG9ub3IncyBzdG9wUHJvcGFnYXRpb24sIGJ1dCBpZiB0aGUKICAgIC8vIHNpbXVsYXRlZCBldmVudCBwcmV2ZW50cyBkZWZhdWx0IHRoZW4gd2UgZG8gdGhlIHNhbWUgb24gdGhlIGRvbm9yLgogICAgdmFyIGUgPSBqUXVlcnkuZXh0ZW5kKAogICAgICBuZXcgalF1ZXJ5LkV2ZW50KCksCiAgICAgIGV2ZW50LAogICAgICB7IHR5cGU6IHR5cGUsCiAgICAgICAgaXNTaW11bGF0ZWQ6IHRydWUsCiAgICAgICAgb3JpZ2luYWxFdmVudDoge30KICAgICAgfQogICAgKTsKICAgIGlmICggYnViYmxlICkgewogICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlciggZSwgbnVsbCwgZWxlbSApOwogICAgfSBlbHNlIHsKICAgICAgalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmNhbGwoIGVsZW0sIGUgKTsKICAgIH0KICAgIGlmICggZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgIH0KICB9Cn07CgpqUXVlcnkucmVtb3ZlRXZlbnQgPSBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyID8KICBmdW5jdGlvbiggZWxlbSwgdHlwZSwgaGFuZGxlICkgewogICAgaWYgKCBlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIgKSB7CiAgICAgIGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgaGFuZGxlLCBmYWxzZSApOwogICAgfQogIH0gOgogIGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBoYW5kbGUgKSB7CiAgICB2YXIgbmFtZSA9ICJvbiIgKyB0eXBlOwoKICAgIGlmICggZWxlbS5kZXRhY2hFdmVudCApIHsKCiAgICAgIC8vICM4NTQ1LCAjNzA1NCwgcHJldmVudGluZyBtZW1vcnkgbGVha3MgZm9yIGN1c3RvbSBldmVudHMgaW4gSUU2LTgKICAgICAgLy8gZGV0YWNoRXZlbnQgbmVlZGVkIHByb3BlcnR5IG9uIGVsZW1lbnQsIGJ5IG5hbWUgb2YgdGhhdCBldmVudCwgdG8gcHJvcGVybHkgZXhwb3NlIGl0IHRvIEdDCiAgICAgIGlmICggdHlwZW9mIGVsZW1bIG5hbWUgXSA9PT0gInVuZGVmaW5lZCIgKSB7CiAgICAgICAgZWxlbVsgbmFtZSBdID0gbnVsbDsKICAgICAgfQoKICAgICAgZWxlbS5kZXRhY2hFdmVudCggbmFtZSwgaGFuZGxlICk7CiAgICB9CiAgfTsKCmpRdWVyeS5FdmVudCA9IGZ1bmN0aW9uKCBzcmMsIHByb3BzICkgewogIC8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAogIGlmICggISh0aGlzIGluc3RhbmNlb2YgalF1ZXJ5LkV2ZW50KSApIHsKICAgIHJldHVybiBuZXcgalF1ZXJ5LkV2ZW50KCBzcmMsIHByb3BzICk7CiAgfQoKICAvLyBFdmVudCBvYmplY3QKICBpZiAoIHNyYyAmJiBzcmMudHlwZSApIHsKICAgIHRoaXMub3JpZ2luYWxFdmVudCA9IHNyYzsKICAgIHRoaXMudHlwZSA9IHNyYy50eXBlOwoKICAgIC8vIEV2ZW50cyBidWJibGluZyB1cCB0aGUgZG9jdW1lbnQgbWF5IGhhdmUgYmVlbiBtYXJrZWQgYXMgcHJldmVudGVkCiAgICAvLyBieSBhIGhhbmRsZXIgbG93ZXIgZG93biB0aGUgdHJlZTsgcmVmbGVjdCB0aGUgY29ycmVjdCB2YWx1ZS4KICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gKCBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fCBzcmMucmV0dXJuVmFsdWUgPT09IGZhbHNlIHx8CiAgICAgIHNyYy5nZXRQcmV2ZW50RGVmYXVsdCAmJiBzcmMuZ2V0UHJldmVudERlZmF1bHQoKSApID8gcmV0dXJuVHJ1ZSA6IHJldHVybkZhbHNlOwoKICAvLyBFdmVudCB0eXBlCiAgfSBlbHNlIHsKICAgIHRoaXMudHlwZSA9IHNyYzsKICB9CgogIC8vIFB1dCBleHBsaWNpdGx5IHByb3ZpZGVkIHByb3BlcnRpZXMgb250byB0aGUgZXZlbnQgb2JqZWN0CiAgaWYgKCBwcm9wcyApIHsKICAgIGpRdWVyeS5leHRlbmQoIHRoaXMsIHByb3BzICk7CiAgfQoKICAvLyBDcmVhdGUgYSB0aW1lc3RhbXAgaWYgaW5jb21pbmcgZXZlbnQgZG9lc24ndCBoYXZlIG9uZQogIHRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgalF1ZXJ5Lm5vdygpOwoKICAvLyBNYXJrIGl0IGFzIGZpeGVkCiAgdGhpc1sgalF1ZXJ5LmV4cGFuZG8gXSA9IHRydWU7Cn07CgovLyBqUXVlcnkuRXZlbnQgaXMgYmFzZWQgb24gRE9NMyBFdmVudHMgYXMgc3BlY2lmaWVkIGJ5IHRoZSBFQ01BU2NyaXB0IExhbmd1YWdlIEJpbmRpbmcKLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAwMy9XRC1ET00tTGV2ZWwtMy1FdmVudHMtMjAwMzAzMzEvZWNtYS1zY3JpcHQtYmluZGluZy5odG1sCmpRdWVyeS5FdmVudC5wcm90b3R5cGUgPSB7CiAgaXNEZWZhdWx0UHJldmVudGVkOiByZXR1cm5GYWxzZSwKICBpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoKICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCiAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7CiAgICBpZiAoICFlICkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gSWYgcHJldmVudERlZmF1bHQgZXhpc3RzLCBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CiAgICBpZiAoIGUucHJldmVudERlZmF1bHQgKSB7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAvLyBTdXBwb3J0OiBJRQogICAgLy8gT3RoZXJ3aXNlIHNldCB0aGUgcmV0dXJuVmFsdWUgcHJvcGVydHkgb2YgdGhlIG9yaWdpbmFsIGV2ZW50IHRvIGZhbHNlCiAgICB9IGVsc2UgewogICAgICBlLnJldHVyblZhbHVlID0gZmFsc2U7CiAgICB9CiAgfSwKICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgogICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CiAgICBpZiAoICFlICkgewogICAgICByZXR1cm47CiAgICB9CiAgICAvLyBJZiBzdG9wUHJvcGFnYXRpb24gZXhpc3RzLCBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CiAgICBpZiAoIGUuc3RvcFByb3BhZ2F0aW9uICkgewogICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgfQoKICAgIC8vIFN1cHBvcnQ6IElFCiAgICAvLyBTZXQgdGhlIGNhbmNlbEJ1YmJsZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gdHJ1ZQogICAgZS5jYW5jZWxCdWJibGUgPSB0cnVlOwogIH0sCiAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwogICAgdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKICB9Cn07CgovLyBDcmVhdGUgbW91c2VlbnRlci9sZWF2ZSBldmVudHMgdXNpbmcgbW91c2VvdmVyL291dCBhbmQgZXZlbnQtdGltZSBjaGVja3MKalF1ZXJ5LmVhY2goewogIG1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAogIG1vdXNlbGVhdmU6ICJtb3VzZW91dCIKfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKICBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgb3JpZyBdID0gewogICAgZGVsZWdhdGVUeXBlOiBmaXgsCiAgICBiaW5kVHlwZTogZml4LAoKICAgIGhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICB2YXIgcmV0LAogICAgICAgIHRhcmdldCA9IHRoaXMsCiAgICAgICAgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQsCiAgICAgICAgaGFuZGxlT2JqID0gZXZlbnQuaGFuZGxlT2JqOwoKICAgICAgLy8gRm9yIG1vdXNlbnRlci9sZWF2ZSBjYWxsIHRoZSBoYW5kbGVyIGlmIHJlbGF0ZWQgaXMgb3V0c2lkZSB0aGUgdGFyZ2V0LgogICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICBpZiAoICFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0YXJnZXQgJiYgIWpRdWVyeS5jb250YWlucyggdGFyZ2V0LCByZWxhdGVkICkpICkgewogICAgICAgIGV2ZW50LnR5cGUgPSBoYW5kbGVPYmoub3JpZ1R5cGU7CiAgICAgICAgcmV0ID0gaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogICAgICAgIGV2ZW50LnR5cGUgPSBmaXg7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICAgIH0KICB9Owp9KTsKCi8vIElFIHN1Ym1pdCBkZWxlZ2F0aW9uCmlmICggIWpRdWVyeS5zdXBwb3J0LnN1Ym1pdEJ1YmJsZXMgKSB7CgogIGpRdWVyeS5ldmVudC5zcGVjaWFsLnN1Ym1pdCA9IHsKICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gT25seSBuZWVkIHRoaXMgZm9yIGRlbGVnYXRlZCBmb3JtIHN1Ym1pdCBldmVudHMKICAgICAgaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJmb3JtIiApICkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gTGF6eS1hZGQgYSBzdWJtaXQgaGFuZGxlciB3aGVuIGEgZGVzY2VuZGFudCBmb3JtIG1heSBwb3RlbnRpYWxseSBiZSBzdWJtaXR0ZWQKICAgICAgalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgImNsaWNrLl9zdWJtaXQga2V5cHJlc3MuX3N1Ym1pdCIsIGZ1bmN0aW9uKCBlICkgewogICAgICAgIC8vIE5vZGUgbmFtZSBjaGVjayBhdm9pZHMgYSBWTUwtcmVsYXRlZCBjcmFzaCBpbiBJRSAoIzk4MDcpCiAgICAgICAgdmFyIGVsZW0gPSBlLnRhcmdldCwKICAgICAgICAgIGZvcm0gPSBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpbnB1dCIgKSB8fCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJidXR0b24iICkgPyBlbGVtLmZvcm0gOiB1bmRlZmluZWQ7CiAgICAgICAgaWYgKCBmb3JtICYmICFqUXVlcnkuX2RhdGEoIGZvcm0sICJzdWJtaXRCdWJibGVzIiApICkgewogICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZCggZm9ybSwgInN1Ym1pdC5fc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICAgICAgICBldmVudC5fc3VibWl0X2J1YmJsZSA9IHRydWU7CiAgICAgICAgICB9KTsKICAgICAgICAgIGpRdWVyeS5fZGF0YSggZm9ybSwgInN1Ym1pdEJ1YmJsZXMiLCB0cnVlICk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgLy8gcmV0dXJuIHVuZGVmaW5lZCBzaW5jZSB3ZSBkb24ndCBuZWVkIGFuIGV2ZW50IGxpc3RlbmVyCiAgICB9LAoKICAgIHBvc3REaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICAvLyBJZiBmb3JtIHdhcyBzdWJtaXR0ZWQgYnkgdGhlIHVzZXIsIGJ1YmJsZSB0aGUgZXZlbnQgdXAgdGhlIHRyZWUKICAgICAgaWYgKCBldmVudC5fc3VibWl0X2J1YmJsZSApIHsKICAgICAgICBkZWxldGUgZXZlbnQuX3N1Ym1pdF9idWJibGU7CiAgICAgICAgaWYgKCB0aGlzLnBhcmVudE5vZGUgJiYgIWV2ZW50LmlzVHJpZ2dlciApIHsKICAgICAgICAgIGpRdWVyeS5ldmVudC5zaW11bGF0ZSggInN1Ym1pdCIsIHRoaXMucGFyZW50Tm9kZSwgZXZlbnQsIHRydWUgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBPbmx5IG5lZWQgdGhpcyBmb3IgZGVsZWdhdGVkIGZvcm0gc3VibWl0IGV2ZW50cwogICAgICBpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgImZvcm0iICkgKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgZGVsZWdhdGVkIGhhbmRsZXJzOyBjbGVhbkRhdGEgZXZlbnR1YWxseSByZWFwcyBzdWJtaXQgaGFuZGxlcnMgYXR0YWNoZWQgYWJvdmUKICAgICAgalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5fc3VibWl0IiApOwogICAgfQogIH07Cn0KCi8vIElFIGNoYW5nZSBkZWxlZ2F0aW9uIGFuZCBjaGVja2JveC9yYWRpbyBmaXgKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hhbmdlQnViYmxlcyApIHsKCiAgalF1ZXJ5LmV2ZW50LnNwZWNpYWwuY2hhbmdlID0gewoKICAgIHNldHVwOiBmdW5jdGlvbigpIHsKCiAgICAgIGlmICggcmZvcm1FbGVtcy50ZXN0KCB0aGlzLm5vZGVOYW1lICkgKSB7CiAgICAgICAgLy8gSUUgZG9lc24ndCBmaXJlIGNoYW5nZSBvbiBhIGNoZWNrL3JhZGlvIHVudGlsIGJsdXI7IHRyaWdnZXIgaXQgb24gY2xpY2sKICAgICAgICAvLyBhZnRlciBhIHByb3BlcnR5Y2hhbmdlLiBFYXQgdGhlIGJsdXItY2hhbmdlIGluIHNwZWNpYWwuY2hhbmdlLmhhbmRsZS4KICAgICAgICAvLyBUaGlzIHN0aWxsIGZpcmVzIG9uY2hhbmdlIGEgc2Vjb25kIHRpbWUgZm9yIGNoZWNrL3JhZGlvIGFmdGVyIGJsdXIuCiAgICAgICAgaWYgKCB0aGlzLnR5cGUgPT09ICJjaGVja2JveCIgfHwgdGhpcy50eXBlID09PSAicmFkaW8iICkgewogICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgInByb3BlcnR5Y2hhbmdlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CiAgICAgICAgICAgIGlmICggZXZlbnQub3JpZ2luYWxFdmVudC5wcm9wZXJ0eU5hbWUgPT09ICJjaGVja2VkIiApIHsKICAgICAgICAgICAgICB0aGlzLl9qdXN0X2NoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQoIHRoaXMsICJjbGljay5fY2hhbmdlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICAgICAgICBpZiAoIHRoaXMuX2p1c3RfY2hhbmdlZCAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgewogICAgICAgICAgICAgIHRoaXMuX2p1c3RfY2hhbmdlZCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEFsbG93IHRyaWdnZXJlZCwgc2ltdWxhdGVkIGNoYW5nZSBldmVudHMgKCMxMTUwMCkKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAiY2hhbmdlIiwgdGhpcywgZXZlbnQsIHRydWUgKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gRGVsZWdhdGVkIGV2ZW50OyBsYXp5LWFkZCBhIGNoYW5nZSBoYW5kbGVyIG9uIGRlc2NlbmRhbnQgaW5wdXRzCiAgICAgIGpRdWVyeS5ldmVudC5hZGQoIHRoaXMsICJiZWZvcmVhY3RpdmF0ZS5fY2hhbmdlIiwgZnVuY3Rpb24oIGUgKSB7CiAgICAgICAgdmFyIGVsZW0gPSBlLnRhcmdldDsKCiAgICAgICAgaWYgKCByZm9ybUVsZW1zLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSAmJiAhalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiY2hhbmdlQnViYmxlcyIgKSApIHsKICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQoIGVsZW0sICJjaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKICAgICAgICAgICAgaWYgKCB0aGlzLnBhcmVudE5vZGUgJiYgIWV2ZW50LmlzU2ltdWxhdGVkICYmICFldmVudC5pc1RyaWdnZXIgKSB7CiAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAiY2hhbmdlIiwgdGhpcy5wYXJlbnROb2RlLCBldmVudCwgdHJ1ZSApOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGpRdWVyeS5fZGF0YSggZWxlbSwgImNoYW5nZUJ1YmJsZXMiLCB0cnVlICk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgaGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CiAgICAgIHZhciBlbGVtID0gZXZlbnQudGFyZ2V0OwoKICAgICAgLy8gU3dhbGxvdyBuYXRpdmUgY2hhbmdlIGV2ZW50cyBmcm9tIGNoZWNrYm94L3JhZGlvLCB3ZSBhbHJlYWR5IHRyaWdnZXJlZCB0aGVtIGFib3ZlCiAgICAgIGlmICggdGhpcyAhPT0gZWxlbSB8fCBldmVudC5pc1NpbXVsYXRlZCB8fCBldmVudC5pc1RyaWdnZXIgfHwgKGVsZW0udHlwZSAhPT0gInJhZGlvIiAmJiBlbGVtLnR5cGUgIT09ICJjaGVja2JveCIpICkgewogICAgICAgIHJldHVybiBldmVudC5oYW5kbGVPYmouaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CiAgICAgIH0KICAgIH0sCgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCAiLl9jaGFuZ2UiICk7CgogICAgICByZXR1cm4gIXJmb3JtRWxlbXMudGVzdCggdGhpcy5ub2RlTmFtZSApOwogICAgfQogIH07Cn0KCi8vIENyZWF0ZSAiYnViYmxpbmciIGZvY3VzIGFuZCBibHVyIGV2ZW50cwppZiAoICFqUXVlcnkuc3VwcG9ydC5mb2N1c2luQnViYmxlcyApIHsKICBqUXVlcnkuZWFjaCh7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKCiAgICAvLyBBdHRhY2ggYSBzaW5nbGUgY2FwdHVyaW5nIGhhbmRsZXIgd2hpbGUgc29tZW9uZSB3YW50cyBmb2N1c2luL2ZvY3Vzb3V0CiAgICB2YXIgYXR0YWNoZXMgPSAwLAogICAgICBoYW5kbGVyID0gZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICAgIGpRdWVyeS5ldmVudC5zaW11bGF0ZSggZml4LCBldmVudC50YXJnZXQsIGpRdWVyeS5ldmVudC5maXgoIGV2ZW50ICksIHRydWUgKTsKICAgICAgfTsKCiAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgZml4IF0gPSB7CiAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIGF0dGFjaGVzKysgPT09IDAgKSB7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CiAgICAgICAgfQogICAgICB9LAogICAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCAtLWF0dGFjaGVzID09PSAwICkgewogICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggb3JpZywgaGFuZGxlciwgdHJ1ZSApOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9KTsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7CgogIG9uOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgLypJTlRFUk5BTCovIG9uZSApIHsKICAgIHZhciBvcmlnRm4sIHR5cGU7CgogICAgLy8gVHlwZXMgY2FuIGJlIGEgbWFwIG9mIHR5cGVzL2hhbmRsZXJzCiAgICBpZiAoIHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIgKSB7CiAgICAgIC8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApCiAgICAgIGlmICggdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKICAgICAgICAvLyAoIHR5cGVzLU9iamVjdCwgZGF0YSApCiAgICAgICAgZGF0YSA9IGRhdGEgfHwgc2VsZWN0b3I7CiAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgZm9yICggdHlwZSBpbiB0eXBlcyApIHsKICAgICAgICB0aGlzLm9uKCB0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbIHR5cGUgXSwgb25lICk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgaWYgKCBkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCApIHsKICAgICAgLy8gKCB0eXBlcywgZm4gKQogICAgICBmbiA9IHNlbGVjdG9yOwogICAgICBkYXRhID0gc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICB9IGVsc2UgaWYgKCBmbiA9PSBudWxsICkgewogICAgICBpZiAoIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CiAgICAgICAgLy8gKCB0eXBlcywgc2VsZWN0b3IsIGZuICkKICAgICAgICBmbiA9IGRhdGE7CiAgICAgICAgZGF0YSA9IHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyAoIHR5cGVzLCBkYXRhLCBmbiApCiAgICAgICAgZm4gPSBkYXRhOwogICAgICAgIGRhdGEgPSBzZWxlY3RvcjsKICAgICAgICBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgfQogICAgaWYgKCBmbiA9PT0gZmFsc2UgKSB7CiAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICB9IGVsc2UgaWYgKCAhZm4gKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGlmICggb25lID09PSAxICkgewogICAgICBvcmlnRm4gPSBmbjsKICAgICAgZm4gPSBmdW5jdGlvbiggZXZlbnQgKSB7CiAgICAgICAgLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvCiAgICAgICAgalF1ZXJ5KCkub2ZmKCBldmVudCApOwogICAgICAgIHJldHVybiBvcmlnRm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogICAgICB9OwogICAgICAvLyBVc2Ugc2FtZSBndWlkIHNvIGNhbGxlciBjYW4gcmVtb3ZlIHVzaW5nIG9yaWdGbgogICAgICBmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKCBvcmlnRm4uZ3VpZCA9IGpRdWVyeS5ndWlkKysgKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewogICAgICBqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCB0eXBlcywgZm4sIGRhdGEsIHNlbGVjdG9yICk7CiAgICB9KTsKICB9LAogIG9uZTogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKSB7CiAgICByZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgMSApOwogIH0sCiAgb2ZmOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBmbiApIHsKICAgIHZhciBoYW5kbGVPYmosIHR5cGU7CiAgICBpZiAoIHR5cGVzICYmIHR5cGVzLnByZXZlbnREZWZhdWx0ICYmIHR5cGVzLmhhbmRsZU9iaiApIHsKICAgICAgLy8gKCBldmVudCApICBkaXNwYXRjaGVkIGpRdWVyeS5FdmVudAogICAgICBoYW5kbGVPYmogPSB0eXBlcy5oYW5kbGVPYmo7CiAgICAgIGpRdWVyeSggdHlwZXMuZGVsZWdhdGVUYXJnZXQgKS5vZmYoCiAgICAgICAgaGFuZGxlT2JqLm5hbWVzcGFjZSA/IGhhbmRsZU9iai5vcmlnVHlwZSArICIuIiArIGhhbmRsZU9iai5uYW1lc3BhY2UgOiBoYW5kbGVPYmoub3JpZ1R5cGUsCiAgICAgICAgaGFuZGxlT2JqLnNlbGVjdG9yLAogICAgICAgIGhhbmRsZU9iai5oYW5kbGVyCiAgICAgICk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgaWYgKCB0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiICkgewogICAgICAvLyAoIHR5cGVzLW9iamVjdCBbLCBzZWxlY3Rvcl0gKQogICAgICBmb3IgKCB0eXBlIGluIHR5cGVzICkgewogICAgICAgIHRoaXMub2ZmKCB0eXBlLCBzZWxlY3RvciwgdHlwZXNbIHR5cGUgXSApOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgaWYgKCBzZWxlY3RvciA9PT0gZmFsc2UgfHwgdHlwZW9mIHNlbGVjdG9yID09PSAiZnVuY3Rpb24iICkgewogICAgICAvLyAoIHR5cGVzIFssIGZuXSApCiAgICAgIGZuID0gc2VsZWN0b3I7CiAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgfQogICAgaWYgKCBmbiA9PT0gZmFsc2UgKSB7CiAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICB9CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCB0eXBlcywgZm4sIHNlbGVjdG9yICk7CiAgICB9KTsKICB9LAoKICBiaW5kOiBmdW5jdGlvbiggdHlwZXMsIGRhdGEsIGZuICkgewogICAgcmV0dXJuIHRoaXMub24oIHR5cGVzLCBudWxsLCBkYXRhLCBmbiApOwogIH0sCiAgdW5iaW5kOiBmdW5jdGlvbiggdHlwZXMsIGZuICkgewogICAgcmV0dXJuIHRoaXMub2ZmKCB0eXBlcywgbnVsbCwgZm4gKTsKICB9LAoKICBkZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZGF0YSwgZm4gKSB7CiAgICByZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApOwogIH0sCiAgdW5kZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZm4gKSB7CiAgICAvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHRoaXMub2ZmKCBzZWxlY3RvciwgIioqIiApIDogdGhpcy5vZmYoIHR5cGVzLCBzZWxlY3RvciB8fCAiKioiLCBmbiApOwogIH0sCgogIHRyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIHRoaXMgKTsKICAgIH0pOwogIH0sCiAgdHJpZ2dlckhhbmRsZXI6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewogICAgdmFyIGVsZW0gPSB0aGlzWzBdOwogICAgaWYgKCBlbGVtICkgewogICAgICByZXR1cm4galF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIGVsZW0sIHRydWUgKTsKICAgIH0KICB9LAoKICBob3ZlcjogZnVuY3Rpb24oIGZuT3ZlciwgZm5PdXQgKSB7CiAgICByZXR1cm4gdGhpcy5tb3VzZWVudGVyKCBmbk92ZXIgKS5tb3VzZWxlYXZlKCBmbk91dCB8fCBmbk92ZXIgKTsKICB9Cn0pOwoKalF1ZXJ5LmVhY2goICgiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgIiArCiAgIm1vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlICIgKwogICJjaGFuZ2Ugc2VsZWN0IHN1Ym1pdCBrZXlkb3duIGtleXByZXNzIGtleXVwIGVycm9yIGNvbnRleHRtZW51Iikuc3BsaXQoIiAiKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgogIC8vIEhhbmRsZSBldmVudCBiaW5kaW5nCiAgalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZGF0YSwgZm4gKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDAgPwogICAgICB0aGlzLm9uKCBuYW1lLCBudWxsLCBkYXRhLCBmbiApIDoKICAgICAgdGhpcy50cmlnZ2VyKCBuYW1lICk7CiAgfTsKCiAgaWYgKCBya2V5RXZlbnQudGVzdCggbmFtZSApICkgewogICAgalF1ZXJ5LmV2ZW50LmZpeEhvb2tzWyBuYW1lIF0gPSBqUXVlcnkuZXZlbnQua2V5SG9va3M7CiAgfQoKICBpZiAoIHJtb3VzZUV2ZW50LnRlc3QoIG5hbWUgKSApIHsKICAgIGpRdWVyeS5ldmVudC5maXhIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV2ZW50Lm1vdXNlSG9va3M7CiAgfQp9KTsKLyohCiAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lCiAqIENvcHlyaWdodCAyMDEyIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqLwooZnVuY3Rpb24oIHdpbmRvdywgdW5kZWZpbmVkICkgewoKdmFyIGksCiAgY2FjaGVkcnVucywKICBFeHByLAogIGdldFRleHQsCiAgaXNYTUwsCiAgY29tcGlsZSwKICBoYXNEdXBsaWNhdGUsCiAgb3V0ZXJtb3N0Q29udGV4dCwKCiAgLy8gTG9jYWwgZG9jdW1lbnQgdmFycwogIHNldERvY3VtZW50LAogIGRvY3VtZW50LAogIGRvY0VsZW0sCiAgZG9jdW1lbnRJc1hNTCwKICByYnVnZ3lRU0EsCiAgcmJ1Z2d5TWF0Y2hlcywKICBtYXRjaGVzLAogIGNvbnRhaW5zLAogIHNvcnRPcmRlciwKCiAgLy8gSW5zdGFuY2Utc3BlY2lmaWMgZGF0YQogIGV4cGFuZG8gPSAic2l6emxlIiArIC0obmV3IERhdGUoKSksCiAgcHJlZmVycmVkRG9jID0gd2luZG93LmRvY3VtZW50LAogIHN1cHBvcnQgPSB7fSwKICBkaXJydW5zID0gMCwKICBkb25lID0gMCwKICBjbGFzc0NhY2hlID0gY3JlYXRlQ2FjaGUoKSwKICB0b2tlbkNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKICBjb21waWxlckNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKCiAgLy8gR2VuZXJhbC1wdXJwb3NlIGNvbnN0YW50cwogIHN0cnVuZGVmaW5lZCA9IHR5cGVvZiB1bmRlZmluZWQsCiAgTUFYX05FR0FUSVZFID0gMSA8PCAzMSwKCiAgLy8gQXJyYXkgbWV0aG9kcwogIGFyciA9IFtdLAogIHBvcCA9IGFyci5wb3AsCiAgcHVzaCA9IGFyci5wdXNoLAogIHNsaWNlID0gYXJyLnNsaWNlLAogIC8vIFVzZSBhIHN0cmlwcGVkLWRvd24gaW5kZXhPZiBpZiB3ZSBjYW4ndCB1c2UgYSBuYXRpdmUgb25lCiAgaW5kZXhPZiA9IGFyci5pbmRleE9mIHx8IGZ1bmN0aW9uKCBlbGVtICkgewogICAgdmFyIGkgPSAwLAogICAgICBsZW4gPSB0aGlzLmxlbmd0aDsKICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgICBpZiAoIHRoaXNbaV0gPT09IGVsZW0gKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9LAoKCiAgLy8gUmVndWxhciBleHByZXNzaW9ucwoKICAvLyBXaGl0ZXNwYWNlIGNoYXJhY3RlcnMgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI3doaXRlc3BhY2UKICB3aGl0ZXNwYWNlID0gIltcXHgyMFxcdFxcclxcblxcZl0iLAogIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc3ludGF4LyNjaGFyYWN0ZXJzCiAgY2hhcmFjdGVyRW5jb2RpbmcgPSAiKD86XFxcXC58W1xcdy1dfFteXFx4MDAtXFx4YTBdKSsiLAoKICAvLyBMb29zZWx5IG1vZGVsZWQgb24gQ1NTIGlkZW50aWZpZXIgY2hhcmFjdGVycwogIC8vIEFuIHVucXVvdGVkIHZhbHVlIHNob3VsZCBiZSBhIENTUyBpZGVudGlmaWVyIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc2VsZWN0b3JzLyNhdHRyaWJ1dGUtc2VsZWN0b3JzCiAgLy8gUHJvcGVyIHN5bnRheDogaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI3ZhbHVlLWRlZi1pZGVudGlmaWVyCiAgaWRlbnRpZmllciA9IGNoYXJhY3RlckVuY29kaW5nLnJlcGxhY2UoICJ3IiwgIncjIiApLAoKICAvLyBBY2NlcHRhYmxlIG9wZXJhdG9ycyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMKICBvcGVyYXRvcnMgPSAiKFsqXiR8IX5dPz0pIiwKICBhdHRyaWJ1dGVzID0gIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICsgd2hpdGVzcGFjZSArCiAgICAiKig/OiIgKyBvcGVyYXRvcnMgKyB3aGl0ZXNwYWNlICsgIiooPzooWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwzfCgiICsgaWRlbnRpZmllciArICIpfCl8KSIgKyB3aGl0ZXNwYWNlICsgIipcXF0iLAoKICAvLyBQcmVmZXIgYXJndW1lbnRzIHF1b3RlZCwKICAvLyAgIHRoZW4gbm90IGNvbnRhaW5pbmcgcHNldWRvcy9icmFja2V0cywKICAvLyAgIHRoZW4gYXR0cmlidXRlIHNlbGVjdG9ycy9ub24tcGFyZW50aGV0aWNhbCBleHByZXNzaW9ucywKICAvLyAgIHRoZW4gYW55dGhpbmcgZWxzZQogIC8vIFRoZXNlIHByZWZlcmVuY2VzIGFyZSBoZXJlIHRvIHJlZHVjZSB0aGUgbnVtYmVyIG9mIHNlbGVjdG9ycwogIC8vICAgbmVlZGluZyB0b2tlbml6ZSBpbiB0aGUgUFNFVURPIHByZUZpbHRlcgogIHBzZXVkb3MgPSAiOigiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSg/OlxcKCgoWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwzfCgoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCIgKyBhdHRyaWJ1dGVzLnJlcGxhY2UoIDMsIDggKSArICIpKil8LiopXFwpfCkiLAoKICAvLyBMZWFkaW5nIGFuZCBub24tZXNjYXBlZCB0cmFpbGluZyB3aGl0ZXNwYWNlLCBjYXB0dXJpbmcgc29tZSBub24td2hpdGVzcGFjZSBjaGFyYWN0ZXJzIHByZWNlZGluZyB0aGUgbGF0dGVyCiAgcnRyaW0gPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIit8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKSIgKyB3aGl0ZXNwYWNlICsgIiskIiwgImciICksCgogIHJjb21tYSA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKiwiICsgd2hpdGVzcGFjZSArICIqIiApLAogIHJjb21iaW5hdG9ycyA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKihbXFx4MjBcXHRcXHJcXG5cXGY+K35dKSIgKyB3aGl0ZXNwYWNlICsgIioiICksCiAgcnBzZXVkbyA9IG5ldyBSZWdFeHAoIHBzZXVkb3MgKSwKICByaWRlbnRpZmllciA9IG5ldyBSZWdFeHAoICJeIiArIGlkZW50aWZpZXIgKyAiJCIgKSwKCiAgbWF0Y2hFeHByID0gewogICAgIklEIjogbmV3IFJlZ0V4cCggIl4jKCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpIiApLAogICAgIkNMQVNTIjogbmV3IFJlZ0V4cCggIl5cXC4oIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksCiAgICAiTkFNRSI6IG5ldyBSZWdFeHAoICJeXFxbbmFtZT1bJ1wiXT8oIiArIGNoYXJhY3RlckVuY29kaW5nICsgIilbJ1wiXT9cXF0iICksCiAgICAiVEFHIjogbmV3IFJlZ0V4cCggIl4oIiArIGNoYXJhY3RlckVuY29kaW5nLnJlcGxhY2UoICJ3IiwgIncqIiApICsgIikiICksCiAgICAiQVRUUiI6IG5ldyBSZWdFeHAoICJeIiArIGF0dHJpYnV0ZXMgKSwKICAgICJQU0VVRE8iOiBuZXcgUmVnRXhwKCAiXiIgKyBwc2V1ZG9zICksCiAgICAiQ0hJTEQiOiBuZXcgUmVnRXhwKCAiXjoob25seXxmaXJzdHxsYXN0fG50aHxudGgtbGFzdCktKGNoaWxkfG9mLXR5cGUpKD86XFwoIiArIHdoaXRlc3BhY2UgKwogICAgICAiKihldmVufG9kZHwoKFsrLV18KShcXGQqKW58KSIgKyB3aGl0ZXNwYWNlICsgIiooPzooWystXXwpIiArIHdoaXRlc3BhY2UgKwogICAgICAiKihcXGQrKXwpKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSIsICJpIiApLAogICAgLy8gRm9yIHVzZSBpbiBsaWJyYXJpZXMgaW1wbGVtZW50aW5nIC5pcygpCiAgICAvLyBXZSB1c2UgdGhpcyBmb3IgUE9TIG1hdGNoaW5nIGluIGBzZWxlY3RgCiAgICAibmVlZHNDb250ZXh0IjogbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIqWz4rfl18OihldmVufG9kZHxlcXxndHxsdHxudGh8Zmlyc3R8bGFzdCkoPzpcXCgiICsKICAgICAgd2hpdGVzcGFjZSArICIqKCg/Oi1cXGQpP1xcZCopIiArIHdoaXRlc3BhY2UgKyAiKlxcKXwpKD89W14tXXwkKSIsICJpIiApCiAgfSwKCiAgcnNpYmxpbmcgPSAvW1x4MjBcdFxyXG5cZl0qWyt+XS8sCgogIHJuYXRpdmUgPSAvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8sCgogIC8vIEVhc2lseS1wYXJzZWFibGUvcmV0cmlldmFibGUgSUQgb3IgVEFHIG9yIENMQVNTIHNlbGVjdG9ycwogIHJxdWlja0V4cHIgPSAvXig/OiMoW1x3LV0rKXwoXHcrKXxcLihbXHctXSspKSQvLAoKICByaW5wdXRzID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaSwKICByaGVhZGVyID0gL15oXGQkL2ksCgogIHJlc2NhcGUgPSAvJ3xcXC9nLAogIHJhdHRyaWJ1dGVRdW90ZXMgPSAvXD1bXHgyMFx0XHJcblxmXSooW14nIlxdXSopW1x4MjBcdFxyXG5cZl0qXF0vZywKCiAgLy8gQ1NTIGVzY2FwZXMgaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI2VzY2FwZWQtY2hhcmFjdGVycwogIHJ1bmVzY2FwZSA9IC9cXChbXGRhLWZBLUZdezEsNn1bXHgyMFx0XHJcblxmXT98LikvZywKICBmdW5lc2NhcGUgPSBmdW5jdGlvbiggXywgZXNjYXBlZCApIHsKICAgIHZhciBoaWdoID0gIjB4IiArIGVzY2FwZWQgLSAweDEwMDAwOwogICAgLy8gTmFOIG1lYW5zIG5vbi1jb2RlcG9pbnQKICAgIHJldHVybiBoaWdoICE9PSBoaWdoID8KICAgICAgZXNjYXBlZCA6CiAgICAgIC8vIEJNUCBjb2RlcG9pbnQKICAgICAgaGlnaCA8IDAgPwogICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggKyAweDEwMDAwICkgOgogICAgICAgIC8vIFN1cHBsZW1lbnRhbCBQbGFuZSBjb2RlcG9pbnQgKHN1cnJvZ2F0ZSBwYWlyKQogICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggPj4gMTAgfCAweEQ4MDAsIGhpZ2ggJiAweDNGRiB8IDB4REMwMCApOwogIH07CgovLyBVc2UgYSBzdHJpcHBlZC1kb3duIHNsaWNlIGlmIHdlIGNhbid0IHVzZSBhIG5hdGl2ZSBvbmUKdHJ5IHsKICBzbGljZS5jYWxsKCBkb2NFbGVtLmNoaWxkTm9kZXMsIDAgKVswXS5ub2RlVHlwZTsKfSBjYXRjaCAoIGUgKSB7CiAgc2xpY2UgPSBmdW5jdGlvbiggaSApIHsKICAgIHZhciBlbGVtLAogICAgICByZXN1bHRzID0gW107CiAgICBmb3IgKCA7IChlbGVtID0gdGhpc1tpXSk7IGkrKyApIHsKICAgICAgcmVzdWx0cy5wdXNoKCBlbGVtICk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9Owp9CgovKioKICogRm9yIGZlYXR1cmUgZGV0ZWN0aW9uCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byB0ZXN0IGZvciBuYXRpdmUgc3VwcG9ydAogKi8KZnVuY3Rpb24gaXNOYXRpdmUoIGZuICkgewogIHJldHVybiBybmF0aXZlLnRlc3QoIGZuICsgIiIgKTsKfQoKLyoqCiAqIENyZWF0ZSBrZXktdmFsdWUgY2FjaGVzIG9mIGxpbWl0ZWQgc2l6ZQogKiBAcmV0dXJucyB7RnVuY3Rpb24oc3RyaW5nLCBPYmplY3QpfSBSZXR1cm5zIHRoZSBPYmplY3QgZGF0YSBhZnRlciBzdG9yaW5nIGl0IG9uIGl0c2VsZiB3aXRoCiAqICBwcm9wZXJ0eSBuYW1lIHRoZSAoc3BhY2Utc3VmZml4ZWQpIHN0cmluZyBhbmQgKGlmIHRoZSBjYWNoZSBpcyBsYXJnZXIgdGhhbiBFeHByLmNhY2hlTGVuZ3RoKQogKiAgZGVsZXRpbmcgdGhlIG9sZGVzdCBlbnRyeQogKi8KZnVuY3Rpb24gY3JlYXRlQ2FjaGUoKSB7CiAgdmFyIGNhY2hlLAogICAga2V5cyA9IFtdOwoKICByZXR1cm4gKGNhY2hlID0gZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CiAgICAvLyBVc2UgKGtleSArICIgIikgdG8gYXZvaWQgY29sbGlzaW9uIHdpdGggbmF0aXZlIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChzZWUgSXNzdWUgIzE1NykKICAgIGlmICgga2V5cy5wdXNoKCBrZXkgKz0gIiAiICkgPiBFeHByLmNhY2hlTGVuZ3RoICkgewogICAgICAvLyBPbmx5IGtlZXAgdGhlIG1vc3QgcmVjZW50IGVudHJpZXMKICAgICAgZGVsZXRlIGNhY2hlWyBrZXlzLnNoaWZ0KCkgXTsKICAgIH0KICAgIHJldHVybiAoY2FjaGVbIGtleSBdID0gdmFsdWUpOwogIH0pOwp9CgovKioKICogTWFyayBhIGZ1bmN0aW9uIGZvciBzcGVjaWFsIHVzZSBieSBTaXp6bGUKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIG1hcmsKICovCmZ1bmN0aW9uIG1hcmtGdW5jdGlvbiggZm4gKSB7CiAgZm5bIGV4cGFuZG8gXSA9IHRydWU7CiAgcmV0dXJuIGZuOwp9CgovKioKICogU3VwcG9ydCB0ZXN0aW5nIHVzaW5nIGFuIGVsZW1lbnQKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gUGFzc2VkIHRoZSBjcmVhdGVkIGRpdiBhbmQgZXhwZWN0cyBhIGJvb2xlYW4gcmVzdWx0CiAqLwpmdW5jdGlvbiBhc3NlcnQoIGZuICkgewogIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgdHJ5IHsKICAgIHJldHVybiBmbiggZGl2ICk7CiAgfSBjYXRjaCAoZSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0gZmluYWxseSB7CiAgICAvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQogICAgZGl2ID0gbnVsbDsKICB9Cn0KCmZ1bmN0aW9uIFNpenpsZSggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKSB7CiAgdmFyIG1hdGNoLCBlbGVtLCBtLCBub2RlVHlwZSwKICAgIC8vIFFTQSB2YXJzCiAgICBpLCBncm91cHMsIG9sZCwgbmlkLCBuZXdDb250ZXh0LCBuZXdTZWxlY3RvcjsKCiAgaWYgKCAoIGNvbnRleHQgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IHByZWZlcnJlZERvYyApICE9PSBkb2N1bWVudCApIHsKICAgIHNldERvY3VtZW50KCBjb250ZXh0ICk7CiAgfQoKICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICByZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKCiAgaWYgKCAhc2VsZWN0b3IgfHwgdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKICAgIHJldHVybiByZXN1bHRzOwogIH0KCiAgaWYgKCAobm9kZVR5cGUgPSBjb250ZXh0Lm5vZGVUeXBlKSAhPT0gMSAmJiBub2RlVHlwZSAhPT0gOSApIHsKICAgIHJldHVybiBbXTsKICB9CgogIGlmICggIWRvY3VtZW50SXNYTUwgJiYgIXNlZWQgKSB7CgogICAgLy8gU2hvcnRjdXRzCiAgICBpZiAoIChtYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKSkgKSB7CiAgICAgIC8vIFNwZWVkLXVwOiBTaXp6bGUoIiNJRCIpCiAgICAgIGlmICggKG0gPSBtYXRjaFsxXSkgKSB7CiAgICAgICAgaWYgKCBub2RlVHlwZSA9PT0gOSApIHsKICAgICAgICAgIGVsZW0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKCBtICk7CiAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwogICAgICAgICAgaWYgKCBlbGVtICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKICAgICAgICAgICAgLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIElFLCBPcGVyYSwgYW5kIFdlYmtpdCByZXR1cm4gaXRlbXMKICAgICAgICAgICAgLy8gYnkgbmFtZSBpbnN0ZWFkIG9mIElECiAgICAgICAgICAgIGlmICggZWxlbS5pZCA9PT0gbSApIHsKICAgICAgICAgICAgICByZXN1bHRzLnB1c2goIGVsZW0gKTsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIENvbnRleHQgaXMgbm90IGEgZG9jdW1lbnQKICAgICAgICAgIGlmICggY29udGV4dC5vd25lckRvY3VtZW50ICYmIChlbGVtID0gY29udGV4dC5vd25lckRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtICkpICYmCiAgICAgICAgICAgIGNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICkgJiYgZWxlbS5pZCA9PT0gbSApIHsKICAgICAgICAgICAgcmVzdWx0cy5wdXNoKCBlbGVtICk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgIC8vIFNwZWVkLXVwOiBTaXp6bGUoIlRBRyIpCiAgICAgIH0gZWxzZSBpZiAoIG1hdGNoWzJdICkgewogICAgICAgIHB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggc2VsZWN0b3IgKSwgMCkgKTsKICAgICAgICByZXR1cm4gcmVzdWx0czsKCiAgICAgIC8vIFNwZWVkLXVwOiBTaXp6bGUoIi5DTEFTUyIpCiAgICAgIH0gZWxzZSBpZiAoIChtID0gbWF0Y2hbM10pICYmIHN1cHBvcnQuZ2V0QnlDbGFzc05hbWUgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICkgewogICAgICAgIHB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBtICksIDApICk7CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgIH0KICAgIH0KCiAgICAvLyBRU0EgcGF0aAogICAgaWYgKCBzdXBwb3J0LnFzYSAmJiAhcmJ1Z2d5UVNBLnRlc3Qoc2VsZWN0b3IpICkgewogICAgICBvbGQgPSB0cnVlOwogICAgICBuaWQgPSBleHBhbmRvOwogICAgICBuZXdDb250ZXh0ID0gY29udGV4dDsKICAgICAgbmV3U2VsZWN0b3IgPSBub2RlVHlwZSA9PT0gOSAmJiBzZWxlY3RvcjsKCiAgICAgIC8vIHFTQSB3b3JrcyBzdHJhbmdlbHkgb24gRWxlbWVudC1yb290ZWQgcXVlcmllcwogICAgICAvLyBXZSBjYW4gd29yayBhcm91bmQgdGhpcyBieSBzcGVjaWZ5aW5nIGFuIGV4dHJhIElEIG9uIHRoZSByb290CiAgICAgIC8vIGFuZCB3b3JraW5nIHVwIGZyb20gdGhlcmUgKFRoYW5rcyB0byBBbmRyZXcgRHVwb250IGZvciB0aGUgdGVjaG5pcXVlKQogICAgICAvLyBJRSA4IGRvZXNuJ3Qgd29yayBvbiBvYmplY3QgZWxlbWVudHMKICAgICAgaWYgKCBub2RlVHlwZSA9PT0gMSAmJiBjb250ZXh0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJvYmplY3QiICkgewogICAgICAgIGdyb3VwcyA9IHRva2VuaXplKCBzZWxlY3RvciApOwoKICAgICAgICBpZiAoIChvbGQgPSBjb250ZXh0LmdldEF0dHJpYnV0ZSgiaWQiKSkgKSB7CiAgICAgICAgICBuaWQgPSBvbGQucmVwbGFjZSggcmVzY2FwZSwgIlxcJCYiICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnRleHQuc2V0QXR0cmlidXRlKCAiaWQiLCBuaWQgKTsKICAgICAgICB9CiAgICAgICAgbmlkID0gIltpZD0nIiArIG5pZCArICInXSAiOwoKICAgICAgICBpID0gZ3JvdXBzLmxlbmd0aDsKICAgICAgICB3aGlsZSAoIGktLSApIHsKICAgICAgICAgIGdyb3Vwc1tpXSA9IG5pZCArIHRvU2VsZWN0b3IoIGdyb3Vwc1tpXSApOwogICAgICAgIH0KICAgICAgICBuZXdDb250ZXh0ID0gcnNpYmxpbmcudGVzdCggc2VsZWN0b3IgKSAmJiBjb250ZXh0LnBhcmVudE5vZGUgfHwgY29udGV4dDsKICAgICAgICBuZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCIsIik7CiAgICAgIH0KCiAgICAgIGlmICggbmV3U2VsZWN0b3IgKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoIG5ld0NvbnRleHQucXVlcnlTZWxlY3RvckFsbCgKICAgICAgICAgICAgbmV3U2VsZWN0b3IKICAgICAgICAgICksIDAgKSApOwogICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgfSBjYXRjaChxc2FFcnJvcikgewogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoICFvbGQgKSB7CiAgICAgICAgICAgIGNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCJpZCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLy8gQWxsIG90aGVycwogIHJldHVybiBzZWxlY3QoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKTsKfQoKLyoqCiAqIERldGVjdCB4bWwKICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gZWxlbSBBbiBlbGVtZW50IG9yIGEgZG9jdW1lbnQKICovCmlzWE1MID0gU2l6emxlLmlzWE1MID0gZnVuY3Rpb24oIGVsZW0gKSB7CiAgLy8gZG9jdW1lbnRFbGVtZW50IGlzIHZlcmlmaWVkIGZvciBjYXNlcyB3aGVyZSBpdCBkb2Vzbid0IHlldCBleGlzdAogIC8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKQogIHZhciBkb2N1bWVudEVsZW1lbnQgPSBlbGVtICYmIChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkuZG9jdW1lbnRFbGVtZW50OwogIHJldHVybiBkb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgIT09ICJIVE1MIiA6IGZhbHNlOwp9OwoKLyoqCiAqIFNldHMgZG9jdW1lbnQtcmVsYXRlZCB2YXJpYWJsZXMgb25jZSBiYXNlZCBvbiB0aGUgY3VycmVudCBkb2N1bWVudAogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBbZG9jXSBBbiBlbGVtZW50IG9yIGRvY3VtZW50IG9iamVjdCB0byB1c2UgdG8gc2V0IHRoZSBkb2N1bWVudAogKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjdXJyZW50IGRvY3VtZW50CiAqLwpzZXREb2N1bWVudCA9IFNpenpsZS5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKCBub2RlICkgewogIHZhciBkb2MgPSBub2RlID8gbm9kZS5vd25lckRvY3VtZW50IHx8IG5vZGUgOiBwcmVmZXJyZWREb2M7CgogIC8vIElmIG5vIGRvY3VtZW50IGFuZCBkb2N1bWVudEVsZW1lbnQgaXMgYXZhaWxhYmxlLCByZXR1cm4KICBpZiAoIGRvYyA9PT0gZG9jdW1lbnQgfHwgZG9jLm5vZGVUeXBlICE9PSA5IHx8ICFkb2MuZG9jdW1lbnRFbGVtZW50ICkgewogICAgcmV0dXJuIGRvY3VtZW50OwogIH0KCiAgLy8gU2V0IG91ciBkb2N1bWVudAogIGRvY3VtZW50ID0gZG9jOwogIGRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50OwoKICAvLyBTdXBwb3J0IHRlc3RzCiAgZG9jdW1lbnRJc1hNTCA9IGlzWE1MKCBkb2MgKTsKCiAgLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMKICBzdXBwb3J0LnRhZ05hbWVOb0NvbW1lbnRzID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CiAgICBkaXYuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVDb21tZW50KCIiKSApOwogICAgcmV0dXJuICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKS5sZW5ndGg7CiAgfSk7CgogIC8vIENoZWNrIGlmIGF0dHJpYnV0ZXMgc2hvdWxkIGJlIHJldHJpZXZlZCBieSBhdHRyaWJ1dGUgbm9kZXMKICBzdXBwb3J0LmF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKICAgIGRpdi5pbm5lckhUTUwgPSAiPHNlbGVjdD48L3NlbGVjdD4iOwogICAgdmFyIHR5cGUgPSB0eXBlb2YgZGl2Lmxhc3RDaGlsZC5nZXRBdHRyaWJ1dGUoIm11bHRpcGxlIik7CiAgICAvLyBJRTggcmV0dXJucyBhIHN0cmluZyBmb3Igc29tZSBhdHRyaWJ1dGVzIGV2ZW4gd2hlbiBub3QgcHJlc2VudAogICAgcmV0dXJuIHR5cGUgIT09ICJib29sZWFuIiAmJiB0eXBlICE9PSAic3RyaW5nIjsKICB9KTsKCiAgLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYW4gYmUgdHJ1c3RlZAogIHN1cHBvcnQuZ2V0QnlDbGFzc05hbWUgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKICAgIC8vIE9wZXJhIGNhbid0IGZpbmQgYSBzZWNvbmQgY2xhc3NuYW1lIChpbiA5LjYpCiAgICBkaXYuaW5uZXJIVE1MID0gIjxkaXYgY2xhc3M9J2hpZGRlbiBlJz48L2Rpdj48ZGl2IGNsYXNzPSdoaWRkZW4nPjwvZGl2PiI7CiAgICBpZiAoICFkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCAhZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImUiKS5sZW5ndGggKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBTYWZhcmkgMy4yIGNhY2hlcyBjbGFzcyBhdHRyaWJ1dGVzIGFuZCBkb2Vzbid0IGNhdGNoIGNoYW5nZXMKICAgIGRpdi5sYXN0Q2hpbGQuY2xhc3NOYW1lID0gImUiOwogICAgcmV0dXJuIGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJlIikubGVuZ3RoID09PSAyOwogIH0pOwoKICAvLyBDaGVjayBpZiBnZXRFbGVtZW50QnlJZCByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUKICAvLyBDaGVjayBpZiBnZXRFbGVtZW50c0J5TmFtZSBwcml2aWxlZ2VzIGZvcm0gY29udHJvbHMgb3IgcmV0dXJucyBlbGVtZW50cyBieSBJRAogIHN1cHBvcnQuZ2V0QnlOYW1lID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CiAgICAvLyBJbmplY3QgY29udGVudAogICAgZGl2LmlkID0gZXhwYW5kbyArIDA7CiAgICBkaXYuaW5uZXJIVE1MID0gIjxhIG5hbWU9JyIgKyBleHBhbmRvICsgIic+PC9hPjxkaXYgbmFtZT0nIiArIGV4cGFuZG8gKyAiJz48L2Rpdj4iOwogICAgZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGRpdiwgZG9jRWxlbS5maXJzdENoaWxkICk7CgogICAgLy8gVGVzdAogICAgdmFyIHBhc3MgPSBkb2MuZ2V0RWxlbWVudHNCeU5hbWUgJiYKICAgICAgLy8gYnVnZ3kgYnJvd3NlcnMgd2lsbCByZXR1cm4gZmV3ZXIgdGhhbiB0aGUgY29ycmVjdCAyCiAgICAgIGRvYy5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyApLmxlbmd0aCA9PT0gMiArCiAgICAgIC8vIGJ1Z2d5IGJyb3dzZXJzIHdpbGwgcmV0dXJuIG1vcmUgdGhhbiB0aGUgY29ycmVjdCAwCiAgICAgIGRvYy5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyArIDAgKS5sZW5ndGg7CiAgICBzdXBwb3J0LmdldElkTm90TmFtZSA9ICFkb2MuZ2V0RWxlbWVudEJ5SWQoIGV4cGFuZG8gKTsKCiAgICAvLyBDbGVhbnVwCiAgICBkb2NFbGVtLnJlbW92ZUNoaWxkKCBkaXYgKTsKCiAgICByZXR1cm4gcGFzczsKICB9KTsKCiAgLy8gSUU2LzcgcmV0dXJuIG1vZGlmaWVkIGF0dHJpYnV0ZXMKICBFeHByLmF0dHJIYW5kbGUgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKICAgIGRpdi5pbm5lckhUTUwgPSAiPGEgaHJlZj0nIyc+PC9hPiI7CiAgICByZXR1cm4gZGl2LmZpcnN0Q2hpbGQgJiYgdHlwZW9mIGRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSAhPT0gc3RydW5kZWZpbmVkICYmCiAgICAgIGRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgiaHJlZiIpID09PSAiIyI7CiAgfSkgPwogICAge30gOgogICAgewogICAgICAiaHJlZiI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggImhyZWYiLCAyICk7CiAgICAgIH0sCiAgICAgICJ0eXBlIjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIik7CiAgICAgIH0KICAgIH07CgogIC8vIElEIGZpbmQgYW5kIGZpbHRlcgogIGlmICggc3VwcG9ydC5nZXRJZE5vdE5hbWUgKSB7CiAgICBFeHByLmZpbmRbIklEIl0gPSBmdW5jdGlvbiggaWQsIGNvbnRleHQgKSB7CiAgICAgIGlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09IHN0cnVuZGVmaW5lZCAmJiAhZG9jdW1lbnRJc1hNTCApIHsKICAgICAgICB2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7CiAgICAgICAgLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgcmV0dXJuIG0gJiYgbS5wYXJlbnROb2RlID8gW21dIDogW107CiAgICAgIH0KICAgIH07CiAgICBFeHByLmZpbHRlclsiSUQiXSA9IGZ1bmN0aW9uKCBpZCApIHsKICAgICAgdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CiAgICAgIHJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IGF0dHJJZDsKICAgICAgfTsKICAgIH07CiAgfSBlbHNlIHsKICAgIEV4cHIuZmluZFsiSUQiXSA9IGZ1bmN0aW9uKCBpZCwgY29udGV4dCApIHsKICAgICAgaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gc3RydW5kZWZpbmVkICYmICFkb2N1bWVudElzWE1MICkgewogICAgICAgIHZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZCggaWQgKTsKCiAgICAgICAgcmV0dXJuIG0gPwogICAgICAgICAgbS5pZCA9PT0gaWQgfHwgdHlwZW9mIG0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gc3RydW5kZWZpbmVkICYmIG0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKS52YWx1ZSA9PT0gaWQgPwogICAgICAgICAgICBbbV0gOgogICAgICAgICAgICB1bmRlZmluZWQgOgogICAgICAgICAgW107CiAgICAgIH0KICAgIH07CiAgICBFeHByLmZpbHRlclsiSUQiXSA9ICBmdW5jdGlvbiggaWQgKSB7CiAgICAgIHZhciBhdHRySWQgPSBpZC5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwogICAgICByZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwogICAgICAgIHJldHVybiBub2RlICYmIG5vZGUudmFsdWUgPT09IGF0dHJJZDsKICAgICAgfTsKICAgIH07CiAgfQoKICAvLyBUYWcKICBFeHByLmZpbmRbIlRBRyJdID0gc3VwcG9ydC50YWdOYW1lTm9Db21tZW50cyA/CiAgICBmdW5jdGlvbiggdGFnLCBjb250ZXh0ICkgewogICAgICBpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSBzdHJ1bmRlZmluZWQgKSB7CiAgICAgICAgcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwogICAgICB9CiAgICB9IDoKICAgIGZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CiAgICAgIHZhciBlbGVtLAogICAgICAgIHRtcCA9IFtdLAogICAgICAgIGkgPSAwLAogICAgICAgIHJlc3VsdHMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKTsKCiAgICAgIC8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMKICAgICAgaWYgKCB0YWcgPT09ICIqIiApIHsKICAgICAgICBmb3IgKCA7IChlbGVtID0gcmVzdWx0c1tpXSk7IGkrKyApIHsKICAgICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKICAgICAgICAgICAgdG1wLnB1c2goIGVsZW0gKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0bXA7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9OwoKICAvLyBOYW1lCiAgRXhwci5maW5kWyJOQU1FIl0gPSBzdXBwb3J0LmdldEJ5TmFtZSAmJiBmdW5jdGlvbiggdGFnLCBjb250ZXh0ICkgewogICAgaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZSAhPT0gc3RydW5kZWZpbmVkICkgewogICAgICByZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZSggbmFtZSApOwogICAgfQogIH07CgogIC8vIENsYXNzCiAgRXhwci5maW5kWyJDTEFTUyJdID0gc3VwcG9ydC5nZXRCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiggY2xhc3NOYW1lLCBjb250ZXh0ICkgewogICAgaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICE9PSBzdHJ1bmRlZmluZWQgJiYgIWRvY3VtZW50SXNYTUwgKSB7CiAgICAgIHJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIGNsYXNzTmFtZSApOwogICAgfQogIH07CgogIC8vIFFTQSBhbmQgbWF0Y2hlc1NlbGVjdG9yIHN1cHBvcnQKCiAgLy8gbWF0Y2hlc1NlbGVjdG9yKDphY3RpdmUpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChJRTkvT3BlcmEgMTEuNSkKICByYnVnZ3lNYXRjaGVzID0gW107CgogIC8vIHFTYSg6Zm9jdXMpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChDaHJvbWUgMjEpLAogIC8vIG5vIG5lZWQgdG8gYWxzbyBhZGQgdG8gYnVnZ3lNYXRjaGVzIHNpbmNlIG1hdGNoZXMgY2hlY2tzIGJ1Z2d5UVNBCiAgLy8gQSBzdXBwb3J0IHRlc3Qgd291bGQgcmVxdWlyZSB0b28gbXVjaCBjb2RlICh3b3VsZCBpbmNsdWRlIGRvY3VtZW50IHJlYWR5KQogIHJidWdneVFTQSA9IFsgIjpmb2N1cyIgXTsKCiAgaWYgKCAoc3VwcG9ydC5xc2EgPSBpc05hdGl2ZShkb2MucXVlcnlTZWxlY3RvckFsbCkpICkgewogICAgLy8gQnVpbGQgUVNBIHJlZ2V4CiAgICAvLyBSZWdleCBzdHJhdGVneSBhZG9wdGVkIGZyb20gRGllZ28gUGVyaW5pCiAgICBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKICAgICAgLy8gU2VsZWN0IGlzIHNldCB0byBlbXB0eSBzdHJpbmcgb24gcHVycG9zZQogICAgICAvLyBUaGlzIGlzIHRvIHRlc3QgSUUncyB0cmVhdG1lbnQgb2Ygbm90IGV4cGxpY3RseQogICAgICAvLyBzZXR0aW5nIGEgYm9vbGVhbiBjb250ZW50IGF0dHJpYnV0ZSwKICAgICAgLy8gc2luY2UgaXRzIHByZXNlbmNlIHNob3VsZCBiZSBlbm91Z2gKICAgICAgLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIzNTkKICAgICAgZGl2LmlubmVySFRNTCA9ICI8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ9Jyc+PC9vcHRpb24+PC9zZWxlY3Q+IjsKCiAgICAgIC8vIElFOCAtIFNvbWUgYm9vbGVhbiBhdHRyaWJ1dGVzIGFyZSBub3QgdHJlYXRlZCBjb3JyZWN0bHkKICAgICAgaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIltzZWxlY3RlZF0iKS5sZW5ndGggKSB7CiAgICAgICAgcmJ1Z2d5UVNBLnB1c2goICJcXFsiICsgd2hpdGVzcGFjZSArICIqKD86Y2hlY2tlZHxkaXNhYmxlZHxpc21hcHxtdWx0aXBsZXxyZWFkb25seXxzZWxlY3RlZHx2YWx1ZSkiICk7CiAgICAgIH0KCiAgICAgIC8vIFdlYmtpdC9PcGVyYSAtIDpjaGVja2VkIHNob3VsZCByZXR1cm4gc2VsZWN0ZWQgb3B0aW9uIGVsZW1lbnRzCiAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCiAgICAgIC8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCiAgICAgIGlmICggIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCI6Y2hlY2tlZCIpLmxlbmd0aCApIHsKICAgICAgICByYnVnZ3lRU0EucHVzaCgiOmNoZWNrZWQiKTsKICAgICAgfQogICAgfSk7CgogICAgYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgogICAgICAvLyBPcGVyYSAxMC0xMi9JRTggLSBePSAkPSAqPSBhbmQgZW1wdHkgdmFsdWVzCiAgICAgIC8vIFNob3VsZCBub3Qgc2VsZWN0IGFueXRoaW5nCiAgICAgIGRpdi5pbm5lckhUTUwgPSAiPGlucHV0IHR5cGU9J2hpZGRlbicgaT0nJy8+IjsKICAgICAgaWYgKCBkaXYucXVlcnlTZWxlY3RvckFsbCgiW2lePScnXSIpLmxlbmd0aCApIHsKICAgICAgICByYnVnZ3lRU0EucHVzaCggIlsqXiRdPSIgKyB3aGl0ZXNwYWNlICsgIiooPzpcIlwifCcnKSIgKTsKICAgICAgfQoKICAgICAgLy8gRkYgMy41IC0gOmVuYWJsZWQvOmRpc2FibGVkIGFuZCBoaWRkZW4gZWxlbWVudHMgKGhpZGRlbiBlbGVtZW50cyBhcmUgc3RpbGwgZW5hYmxlZCkKICAgICAgLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIGFuZCB3aWxsIG5vdCBzZWUgbGF0ZXIgdGVzdHMKICAgICAgaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIjplbmFibGVkIikubGVuZ3RoICkgewogICAgICAgIHJidWdneVFTQS5wdXNoKCAiOmVuYWJsZWQiLCAiOmRpc2FibGVkIiApOwogICAgICB9CgogICAgICAvLyBPcGVyYSAxMC0xMSBkb2VzIG5vdCB0aHJvdyBvbiBwb3N0LWNvbW1hIGludmFsaWQgcHNldWRvcwogICAgICBkaXYucXVlcnlTZWxlY3RvckFsbCgiKiw6eCIpOwogICAgICByYnVnZ3lRU0EucHVzaCgiLC4qOiIpOwogICAgfSk7CiAgfQoKICBpZiAoIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciA9IGlzTmF0aXZlKCAobWF0Y2hlcyA9IGRvY0VsZW0ubWF0Y2hlc1NlbGVjdG9yIHx8CiAgICBkb2NFbGVtLm1vek1hdGNoZXNTZWxlY3RvciB8fAogICAgZG9jRWxlbS53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwKICAgIGRvY0VsZW0ub01hdGNoZXNTZWxlY3RvciB8fAogICAgZG9jRWxlbS5tc01hdGNoZXNTZWxlY3RvcikgKSkgKSB7CgogICAgYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CiAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgogICAgICAvLyBvbiBhIGRpc2Nvbm5lY3RlZCBub2RlIChJRSA5KQogICAgICBzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoID0gbWF0Y2hlcy5jYWxsKCBkaXYsICJkaXYiICk7CgogICAgICAvLyBUaGlzIHNob3VsZCBmYWlsIHdpdGggYW4gZXhjZXB0aW9uCiAgICAgIC8vIEdlY2tvIGRvZXMgbm90IGVycm9yLCByZXR1cm5zIGZhbHNlIGluc3RlYWQKICAgICAgbWF0Y2hlcy5jYWxsKCBkaXYsICJbcyE9JyddOngiICk7CiAgICAgIHJidWdneU1hdGNoZXMucHVzaCggIiE9IiwgcHNldWRvcyApOwogICAgfSk7CiAgfQoKICByYnVnZ3lRU0EgPSBuZXcgUmVnRXhwKCByYnVnZ3lRU0Euam9pbigifCIpICk7CiAgcmJ1Z2d5TWF0Y2hlcyA9IG5ldyBSZWdFeHAoIHJidWdneU1hdGNoZXMuam9pbigifCIpICk7CgogIC8vIEVsZW1lbnQgY29udGFpbnMgYW5vdGhlcgogIC8vIFB1cnBvc2VmdWxseSBkb2VzIG5vdCBpbXBsZW1lbnQgaW5jbHVzaXZlIGRlc2NlbmRlbnQKICAvLyBBcyBpbiwgYW4gZWxlbWVudCBkb2VzIG5vdCBjb250YWluIGl0c2VsZgogIGNvbnRhaW5zID0gaXNOYXRpdmUoZG9jRWxlbS5jb250YWlucykgfHwgZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/CiAgICBmdW5jdGlvbiggYSwgYiApIHsKICAgICAgdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKICAgICAgICBidXAgPSBiICYmIGIucGFyZW50Tm9kZTsKICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhISggYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoCiAgICAgICAgYWRvd24uY29udGFpbnMgPwogICAgICAgICAgYWRvd24uY29udGFpbnMoIGJ1cCApIDoKICAgICAgICAgIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYnVwICkgJiAxNgogICAgICApKTsKICAgIH0gOgogICAgZnVuY3Rpb24oIGEsIGIgKSB7CiAgICAgIGlmICggYiApIHsKICAgICAgICB3aGlsZSAoIChiID0gYi5wYXJlbnROb2RlKSApIHsKICAgICAgICAgIGlmICggYiA9PT0gYSApIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogIC8vIERvY3VtZW50IG9yZGVyIHNvcnRpbmcKICBzb3J0T3JkZXIgPSBkb2NFbGVtLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8KICBmdW5jdGlvbiggYSwgYiApIHsKICAgIHZhciBjb21wYXJlOwoKICAgIGlmICggYSA9PT0gYiApIHsKICAgICAgaGFzRHVwbGljYXRlID0gdHJ1ZTsKICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgaWYgKCAoY29tcGFyZSA9IGIuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBiICkpICkgewogICAgICBpZiAoIGNvbXBhcmUgJiAxIHx8IGEucGFyZW50Tm9kZSAmJiBhLnBhcmVudE5vZGUubm9kZVR5cGUgPT09IDExICkgewogICAgICAgIGlmICggYSA9PT0gZG9jIHx8IGNvbnRhaW5zKCBwcmVmZXJyZWREb2MsIGEgKSApIHsKICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgaWYgKCBiID09PSBkb2MgfHwgY29udGFpbnMoIHByZWZlcnJlZERvYywgYiApICkgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIHJldHVybiBjb21wYXJlICYgNCA/IC0xIDogMTsKICAgIH0KCiAgICByZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/IC0xIDogMTsKICB9IDoKICBmdW5jdGlvbiggYSwgYiApIHsKICAgIHZhciBjdXIsCiAgICAgIGkgPSAwLAogICAgICBhdXAgPSBhLnBhcmVudE5vZGUsCiAgICAgIGJ1cCA9IGIucGFyZW50Tm9kZSwKICAgICAgYXAgPSBbIGEgXSwKICAgICAgYnAgPSBbIGIgXTsKCiAgICAvLyBUaGUgbm9kZXMgYXJlIGlkZW50aWNhbCwgd2UgY2FuIGV4aXQgZWFybHkKICAgIGlmICggYSA9PT0gYiApIHsKICAgICAgaGFzRHVwbGljYXRlID0gdHJ1ZTsKICAgICAgcmV0dXJuIDA7CgogICAgLy8gRmFsbGJhY2sgdG8gdXNpbmcgc291cmNlSW5kZXggKGluIElFKSBpZiBpdCdzIGF2YWlsYWJsZSBvbiBib3RoIG5vZGVzCiAgICB9IGVsc2UgaWYgKCBhLnNvdXJjZUluZGV4ICYmIGIuc291cmNlSW5kZXggKSB7CiAgICAgIHJldHVybiAoIH5iLnNvdXJjZUluZGV4IHx8IE1BWF9ORUdBVElWRSApIC0gKCBjb250YWlucyggcHJlZmVycmVkRG9jLCBhICkgJiYgfmEuc291cmNlSW5kZXggfHwgTUFYX05FR0FUSVZFICk7CgogICAgLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQKICAgIH0gZWxzZSBpZiAoICFhdXAgfHwgIWJ1cCApIHsKICAgICAgcmV0dXJuIGEgPT09IGRvYyA/IC0xIDoKICAgICAgICBiID09PSBkb2MgPyAxIDoKICAgICAgICBhdXAgPyAtMSA6CiAgICAgICAgYnVwID8gMSA6CiAgICAgICAgMDsKCiAgICAvLyBJZiB0aGUgbm9kZXMgYXJlIHNpYmxpbmdzLCB3ZSBjYW4gZG8gYSBxdWljayBjaGVjawogICAgfSBlbHNlIGlmICggYXVwID09PSBidXAgKSB7CiAgICAgIHJldHVybiBzaWJsaW5nQ2hlY2soIGEsIGIgKTsKICAgIH0KCiAgICAvLyBPdGhlcndpc2Ugd2UgbmVlZCBmdWxsIGxpc3RzIG9mIHRoZWlyIGFuY2VzdG9ycyBmb3IgY29tcGFyaXNvbgogICAgY3VyID0gYTsKICAgIHdoaWxlICggKGN1ciA9IGN1ci5wYXJlbnROb2RlKSApIHsKICAgICAgYXAudW5zaGlmdCggY3VyICk7CiAgICB9CiAgICBjdXIgPSBiOwogICAgd2hpbGUgKCAoY3VyID0gY3VyLnBhcmVudE5vZGUpICkgewogICAgICBicC51bnNoaWZ0KCBjdXIgKTsKICAgIH0KCiAgICAvLyBXYWxrIGRvd24gdGhlIHRyZWUgbG9va2luZyBmb3IgYSBkaXNjcmVwYW5jeQogICAgd2hpbGUgKCBhcFtpXSA9PT0gYnBbaV0gKSB7CiAgICAgIGkrKzsKICAgIH0KCiAgICByZXR1cm4gaSA/CiAgICAgIC8vIERvIGEgc2libGluZyBjaGVjayBpZiB0aGUgbm9kZXMgaGF2ZSBhIGNvbW1vbiBhbmNlc3RvcgogICAgICBzaWJsaW5nQ2hlY2soIGFwW2ldLCBicFtpXSApIDoKCiAgICAgIC8vIE90aGVyd2lzZSBub2RlcyBpbiBvdXIgZG9jdW1lbnQgc29ydCBmaXJzdAogICAgICBhcFtpXSA9PT0gcHJlZmVycmVkRG9jID8gLTEgOgogICAgICBicFtpXSA9PT0gcHJlZmVycmVkRG9jID8gMSA6CiAgICAgIDA7CiAgfTsKCiAgLy8gQWx3YXlzIGFzc3VtZSB0aGUgcHJlc2VuY2Ugb2YgZHVwbGljYXRlcyBpZiBzb3J0IGRvZXNuJ3QKICAvLyBwYXNzIHRoZW0gdG8gb3VyIGNvbXBhcmlzb24gZnVuY3Rpb24gKGFzIGluIEdvb2dsZSBDaHJvbWUpLgogIGhhc0R1cGxpY2F0ZSA9IGZhbHNlOwogIFswLCAwXS5zb3J0KCBzb3J0T3JkZXIgKTsKICBzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXMgPSBoYXNEdXBsaWNhdGU7CgogIHJldHVybiBkb2N1bWVudDsKfTsKClNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIGVsZW1lbnRzICkgewogIHJldHVybiBTaXp6bGUoIGV4cHIsIG51bGwsIG51bGwsIGVsZW1lbnRzICk7Cn07CgpTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIGVsZW0sIGV4cHIgKSB7CiAgLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCiAgaWYgKCAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtICkgIT09IGRvY3VtZW50ICkgewogICAgc2V0RG9jdW1lbnQoIGVsZW0gKTsKICB9CgogIC8vIE1ha2Ugc3VyZSB0aGF0IGF0dHJpYnV0ZSBzZWxlY3RvcnMgYXJlIHF1b3RlZAogIGV4cHIgPSBleHByLnJlcGxhY2UoIHJhdHRyaWJ1dGVRdW90ZXMsICI9JyQxJ10iICk7CgogIC8vIHJidWdneVFTQSBhbHdheXMgY29udGFpbnMgOmZvY3VzLCBzbyBubyBuZWVkIGZvciBhbiBleGlzdGVuY2UgY2hlY2sKICBpZiAoIHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yICYmICFkb2N1bWVudElzWE1MICYmICghcmJ1Z2d5TWF0Y2hlcyB8fCAhcmJ1Z2d5TWF0Y2hlcy50ZXN0KGV4cHIpKSAmJiAhcmJ1Z2d5UVNBLnRlc3QoZXhwcikgKSB7CiAgICB0cnkgewogICAgICB2YXIgcmV0ID0gbWF0Y2hlcy5jYWxsKCBlbGVtLCBleHByICk7CgogICAgICAvLyBJRSA5J3MgbWF0Y2hlc1NlbGVjdG9yIHJldHVybnMgZmFsc2Ugb24gZGlzY29ubmVjdGVkIG5vZGVzCiAgICAgIGlmICggcmV0IHx8IHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggfHwKICAgICAgICAgIC8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50CiAgICAgICAgICAvLyBmcmFnbWVudCBpbiBJRSA5CiAgICAgICAgICBlbGVtLmRvY3VtZW50ICYmIGVsZW0uZG9jdW1lbnQubm9kZVR5cGUgIT09IDExICkgewogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICAgIH0gY2F0Y2goZSkge30KICB9CgogIHJldHVybiBTaXp6bGUoIGV4cHIsIGRvY3VtZW50LCBudWxsLCBbZWxlbV0gKS5sZW5ndGggPiAwOwp9OwoKU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24oIGNvbnRleHQsIGVsZW0gKSB7CiAgLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCiAgaWYgKCAoIGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0ICkgIT09IGRvY3VtZW50ICkgewogICAgc2V0RG9jdW1lbnQoIGNvbnRleHQgKTsKICB9CiAgcmV0dXJuIGNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICk7Cn07CgpTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewogIHZhciB2YWw7CgogIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogIGlmICggKCBlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSApICE9PSBkb2N1bWVudCApIHsKICAgIHNldERvY3VtZW50KCBlbGVtICk7CiAgfQoKICBpZiAoICFkb2N1bWVudElzWE1MICkgewogICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICB9CiAgaWYgKCAodmFsID0gRXhwci5hdHRySGFuZGxlWyBuYW1lIF0pICkgewogICAgcmV0dXJuIHZhbCggZWxlbSApOwogIH0KICBpZiAoIGRvY3VtZW50SXNYTUwgfHwgc3VwcG9ydC5hdHRyaWJ1dGVzICkgewogICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICk7CiAgfQogIHJldHVybiAoICh2YWwgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKSkgfHwgZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKSApICYmIGVsZW1bIG5hbWUgXSA9PT0gdHJ1ZSA/CiAgICBuYW1lIDoKICAgIHZhbCAmJiB2YWwuc3BlY2lmaWVkID8gdmFsLnZhbHVlIDogbnVsbDsKfTsKClNpenpsZS5lcnJvciA9IGZ1bmN0aW9uKCBtc2cgKSB7CiAgdGhyb3cgbmV3IEVycm9yKCAiU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogIiArIG1zZyApOwp9OwoKLy8gRG9jdW1lbnQgc29ydGluZyBhbmQgcmVtb3ZpbmcgZHVwbGljYXRlcwpTaXp6bGUudW5pcXVlU29ydCA9IGZ1bmN0aW9uKCByZXN1bHRzICkgewogIHZhciBlbGVtLAogICAgZHVwbGljYXRlcyA9IFtdLAogICAgaSA9IDEsCiAgICBqID0gMDsKCiAgLy8gVW5sZXNzIHdlICprbm93KiB3ZSBjYW4gZGV0ZWN0IGR1cGxpY2F0ZXMsIGFzc3VtZSB0aGVpciBwcmVzZW5jZQogIGhhc0R1cGxpY2F0ZSA9ICFzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXM7CiAgcmVzdWx0cy5zb3J0KCBzb3J0T3JkZXIgKTsKCiAgaWYgKCBoYXNEdXBsaWNhdGUgKSB7CiAgICBmb3IgKCA7IChlbGVtID0gcmVzdWx0c1tpXSk7IGkrKyApIHsKICAgICAgaWYgKCBlbGVtID09PSByZXN1bHRzWyBpIC0gMSBdICkgewogICAgICAgIGogPSBkdXBsaWNhdGVzLnB1c2goIGkgKTsKICAgICAgfQogICAgfQogICAgd2hpbGUgKCBqLS0gKSB7CiAgICAgIHJlc3VsdHMuc3BsaWNlKCBkdXBsaWNhdGVzWyBqIF0sIDEgKTsKICAgIH0KICB9CgogIHJldHVybiByZXN1bHRzOwp9OwoKZnVuY3Rpb24gc2libGluZ0NoZWNrKCBhLCBiICkgewogIHZhciBjdXIgPSBhICYmIGIgJiYgYS5uZXh0U2libGluZzsKCiAgZm9yICggOyBjdXI7IGN1ciA9IGN1ci5uZXh0U2libGluZyApIHsKICAgIGlmICggY3VyID09PSBiICkgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfQoKICByZXR1cm4gYSA/IDEgOiAtMTsKfQoKLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBpbnB1dCB0eXBlcwpmdW5jdGlvbiBjcmVhdGVJbnB1dFBzZXVkbyggdHlwZSApIHsKICByZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CiAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgIHJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKICB9Owp9CgovLyBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGJ1dHRvbnMKZnVuY3Rpb24gY3JlYXRlQnV0dG9uUHNldWRvKCB0eXBlICkgewogIHJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKICAgIHZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiBlbGVtLnR5cGUgPT09IHR5cGU7CiAgfTsKfQoKLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBwb3NpdGlvbmFscwpmdW5jdGlvbiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKCBmbiApIHsKICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBhcmd1bWVudCApIHsKICAgIGFyZ3VtZW50ID0gK2FyZ3VtZW50OwogICAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcyApIHsKICAgICAgdmFyIGosCiAgICAgICAgbWF0Y2hJbmRleGVzID0gZm4oIFtdLCBzZWVkLmxlbmd0aCwgYXJndW1lbnQgKSwKICAgICAgICBpID0gbWF0Y2hJbmRleGVzLmxlbmd0aDsKCiAgICAgIC8vIE1hdGNoIGVsZW1lbnRzIGZvdW5kIGF0IHRoZSBzcGVjaWZpZWQgaW5kZXhlcwogICAgICB3aGlsZSAoIGktLSApIHsKICAgICAgICBpZiAoIHNlZWRbIChqID0gbWF0Y2hJbmRleGVzW2ldKSBdICkgewogICAgICAgICAgc2VlZFtqXSA9ICEobWF0Y2hlc1tqXSA9IHNlZWRbal0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSk7Cn0KCi8qKgogKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwogKiBAcGFyYW0ge0FycmF5fEVsZW1lbnR9IGVsZW0KICovCmdldFRleHQgPSBTaXp6bGUuZ2V0VGV4dCA9IGZ1bmN0aW9uKCBlbGVtICkgewogIHZhciBub2RlLAogICAgcmV0ID0gIiIsCiAgICBpID0gMCwKICAgIG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKCiAgaWYgKCAhbm9kZVR5cGUgKSB7CiAgICAvLyBJZiBubyBub2RlVHlwZSwgdGhpcyBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheQogICAgZm9yICggOyAobm9kZSA9IGVsZW1baV0pOyBpKysgKSB7CiAgICAgIC8vIERvIG5vdCB0cmF2ZXJzZSBjb21tZW50IG5vZGVzCiAgICAgIHJldCArPSBnZXRUZXh0KCBub2RlICk7CiAgICB9CiAgfSBlbHNlIGlmICggbm9kZVR5cGUgPT09IDEgfHwgbm9kZVR5cGUgPT09IDkgfHwgbm9kZVR5cGUgPT09IDExICkgewogICAgLy8gVXNlIHRleHRDb250ZW50IGZvciBlbGVtZW50cwogICAgLy8gaW5uZXJUZXh0IHVzYWdlIHJlbW92ZWQgZm9yIGNvbnNpc3RlbmN5IG9mIG5ldyBsaW5lcyAoc2VlICMxMTE1MykKICAgIGlmICggdHlwZW9mIGVsZW0udGV4dENvbnRlbnQgPT09ICJzdHJpbmciICkgewogICAgICByZXR1cm4gZWxlbS50ZXh0Q29udGVudDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFRyYXZlcnNlIGl0cyBjaGlsZHJlbgogICAgICBmb3IgKCBlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZyApIHsKICAgICAgICByZXQgKz0gZ2V0VGV4dCggZWxlbSApOwogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmICggbm9kZVR5cGUgPT09IDMgfHwgbm9kZVR5cGUgPT09IDQgKSB7CiAgICByZXR1cm4gZWxlbS5ub2RlVmFsdWU7CiAgfQogIC8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwoKICByZXR1cm4gcmV0Owp9OwoKRXhwciA9IFNpenpsZS5zZWxlY3RvcnMgPSB7CgogIC8vIENhbiBiZSBhZGp1c3RlZCBieSB0aGUgdXNlcgogIGNhY2hlTGVuZ3RoOiA1MCwKCiAgY3JlYXRlUHNldWRvOiBtYXJrRnVuY3Rpb24sCgogIG1hdGNoOiBtYXRjaEV4cHIsCgogIGZpbmQ6IHt9LAoKICByZWxhdGl2ZTogewogICAgIj4iOiB7IGRpcjogInBhcmVudE5vZGUiLCBmaXJzdDogdHJ1ZSB9LAogICAgIiAiOiB7IGRpcjogInBhcmVudE5vZGUiIH0sCiAgICAiKyI6IHsgZGlyOiAicHJldmlvdXNTaWJsaW5nIiwgZmlyc3Q6IHRydWUgfSwKICAgICJ+IjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciIH0KICB9LAoKICBwcmVGaWx0ZXI6IHsKICAgICJBVFRSIjogZnVuY3Rpb24oIG1hdGNoICkgewogICAgICBtYXRjaFsxXSA9IG1hdGNoWzFdLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgogICAgICAvLyBNb3ZlIHRoZSBnaXZlbiB2YWx1ZSB0byBtYXRjaFszXSB3aGV0aGVyIHF1b3RlZCBvciB1bnF1b3RlZAogICAgICBtYXRjaFszXSA9ICggbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgIiIgKS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwoKICAgICAgaWYgKCBtYXRjaFsyXSA9PT0gIn49IiApIHsKICAgICAgICBtYXRjaFszXSA9ICIgIiArIG1hdGNoWzNdICsgIiAiOwogICAgICB9CgogICAgICByZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDQgKTsKICAgIH0sCgogICAgIkNISUxEIjogZnVuY3Rpb24oIG1hdGNoICkgewogICAgICAvKiBtYXRjaGVzIGZyb20gbWF0Y2hFeHByWyJDSElMRCJdCiAgICAgICAgMSB0eXBlIChvbmx5fG50aHwuLi4pCiAgICAgICAgMiB3aGF0IChjaGlsZHxvZi10eXBlKQogICAgICAgIDMgYXJndW1lbnQgKGV2ZW58b2RkfFxkKnxcZCpuKFsrLV1cZCspP3wuLi4pCiAgICAgICAgNCB4bi1jb21wb25lbnQgb2YgeG4reSBhcmd1bWVudCAoWystXT9cZCpufCkKICAgICAgICA1IHNpZ24gb2YgeG4tY29tcG9uZW50CiAgICAgICAgNiB4IG9mIHhuLWNvbXBvbmVudAogICAgICAgIDcgc2lnbiBvZiB5LWNvbXBvbmVudAogICAgICAgIDggeSBvZiB5LWNvbXBvbmVudAogICAgICAqLwogICAgICBtYXRjaFsxXSA9IG1hdGNoWzFdLnRvTG93ZXJDYXNlKCk7CgogICAgICBpZiAoIG1hdGNoWzFdLnNsaWNlKCAwLCAzICkgPT09ICJudGgiICkgewogICAgICAgIC8vIG50aC0qIHJlcXVpcmVzIGFyZ3VtZW50CiAgICAgICAgaWYgKCAhbWF0Y2hbM10gKSB7CiAgICAgICAgICBTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CiAgICAgICAgfQoKICAgICAgICAvLyBudW1lcmljIHggYW5kIHkgcGFyYW1ldGVycyBmb3IgRXhwci5maWx0ZXIuQ0hJTEQKICAgICAgICAvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCiAgICAgICAgbWF0Y2hbNF0gPSArKCBtYXRjaFs0XSA/IG1hdGNoWzVdICsgKG1hdGNoWzZdIHx8IDEpIDogMiAqICggbWF0Y2hbM10gPT09ICJldmVuIiB8fCBtYXRjaFszXSA9PT0gIm9kZCIgKSApOwogICAgICAgIG1hdGNoWzVdID0gKyggKCBtYXRjaFs3XSArIG1hdGNoWzhdICkgfHwgbWF0Y2hbM10gPT09ICJvZGQiICk7CgogICAgICAvLyBvdGhlciB0eXBlcyBwcm9oaWJpdCBhcmd1bWVudHMKICAgICAgfSBlbHNlIGlmICggbWF0Y2hbM10gKSB7CiAgICAgICAgU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwogICAgICB9CgogICAgICByZXR1cm4gbWF0Y2g7CiAgICB9LAoKICAgICJQU0VVRE8iOiBmdW5jdGlvbiggbWF0Y2ggKSB7CiAgICAgIHZhciBleGNlc3MsCiAgICAgICAgdW5xdW90ZWQgPSAhbWF0Y2hbNV0gJiYgbWF0Y2hbMl07CgogICAgICBpZiAoIG1hdGNoRXhwclsiQ0hJTEQiXS50ZXN0KCBtYXRjaFswXSApICkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICAvLyBBY2NlcHQgcXVvdGVkIGFyZ3VtZW50cyBhcy1pcwogICAgICBpZiAoIG1hdGNoWzRdICkgewogICAgICAgIG1hdGNoWzJdID0gbWF0Y2hbNF07CgogICAgICAvLyBTdHJpcCBleGNlc3MgY2hhcmFjdGVycyBmcm9tIHVucXVvdGVkIGFyZ3VtZW50cwogICAgICB9IGVsc2UgaWYgKCB1bnF1b3RlZCAmJiBycHNldWRvLnRlc3QoIHVucXVvdGVkICkgJiYKICAgICAgICAvLyBHZXQgZXhjZXNzIGZyb20gdG9rZW5pemUgKHJlY3Vyc2l2ZWx5KQogICAgICAgIChleGNlc3MgPSB0b2tlbml6ZSggdW5xdW90ZWQsIHRydWUgKSkgJiYKICAgICAgICAvLyBhZHZhbmNlIHRvIHRoZSBuZXh0IGNsb3NpbmcgcGFyZW50aGVzaXMKICAgICAgICAoZXhjZXNzID0gdW5xdW90ZWQuaW5kZXhPZiggIikiLCB1bnF1b3RlZC5sZW5ndGggLSBleGNlc3MgKSAtIHVucXVvdGVkLmxlbmd0aCkgKSB7CgogICAgICAgIC8vIGV4Y2VzcyBpcyBhIG5lZ2F0aXZlIGluZGV4CiAgICAgICAgbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSggMCwgZXhjZXNzICk7CiAgICAgICAgbWF0Y2hbMl0gPSB1bnF1b3RlZC5zbGljZSggMCwgZXhjZXNzICk7CiAgICAgIH0KCiAgICAgIC8vIFJldHVybiBvbmx5IGNhcHR1cmVzIG5lZWRlZCBieSB0aGUgcHNldWRvIGZpbHRlciBtZXRob2QgKHR5cGUgYW5kIGFyZ3VtZW50KQogICAgICByZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDMgKTsKICAgIH0KICB9LAoKICBmaWx0ZXI6IHsKCiAgICAiVEFHIjogZnVuY3Rpb24oIG5vZGVOYW1lICkgewogICAgICBpZiAoIG5vZGVOYW1lID09PSAiKiIgKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfTsKICAgICAgfQoKICAgICAgbm9kZU5hbWUgPSBub2RlTmFtZS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLnRvTG93ZXJDYXNlKCk7CiAgICAgIHJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICByZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5vZGVOYW1lOwogICAgICB9OwogICAgfSwKCiAgICAiQ0xBU1MiOiBmdW5jdGlvbiggY2xhc3NOYW1lICkgewogICAgICB2YXIgcGF0dGVybiA9IGNsYXNzQ2FjaGVbIGNsYXNzTmFtZSArICIgIiBdOwoKICAgICAgcmV0dXJuIHBhdHRlcm4gfHwKICAgICAgICAocGF0dGVybiA9IG5ldyBSZWdFeHAoICIoXnwiICsgd2hpdGVzcGFjZSArICIpIiArIGNsYXNzTmFtZSArICIoIiArIHdoaXRlc3BhY2UgKyAifCQpIiApKSAmJgogICAgICAgIGNsYXNzQ2FjaGUoIGNsYXNzTmFtZSwgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgICByZXR1cm4gcGF0dGVybi50ZXN0KCBlbGVtLmNsYXNzTmFtZSB8fCAodHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikpIHx8ICIiICk7CiAgICAgICAgfSk7CiAgICB9LAoKICAgICJBVFRSIjogZnVuY3Rpb24oIG5hbWUsIG9wZXJhdG9yLCBjaGVjayApIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAgIHZhciByZXN1bHQgPSBTaXp6bGUuYXR0ciggZWxlbSwgbmFtZSApOwoKICAgICAgICBpZiAoIHJlc3VsdCA9PSBudWxsICkgewogICAgICAgICAgcmV0dXJuIG9wZXJhdG9yID09PSAiIT0iOwogICAgICAgIH0KICAgICAgICBpZiAoICFvcGVyYXRvciApIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmVzdWx0ICs9ICIiOwoKICAgICAgICByZXR1cm4gb3BlcmF0b3IgPT09ICI9IiA/IHJlc3VsdCA9PT0gY2hlY2sgOgogICAgICAgICAgb3BlcmF0b3IgPT09ICIhPSIgPyByZXN1bHQgIT09IGNoZWNrIDoKICAgICAgICAgIG9wZXJhdG9yID09PSAiXj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPT09IDAgOgogICAgICAgICAgb3BlcmF0b3IgPT09ICIqPSIgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoKICAgICAgICAgIG9wZXJhdG9yID09PSAiJD0iID8gY2hlY2sgJiYgcmVzdWx0LnN1YnN0ciggcmVzdWx0Lmxlbmd0aCAtIGNoZWNrLmxlbmd0aCApID09PSBjaGVjayA6CiAgICAgICAgICBvcGVyYXRvciA9PT0gIn49IiA/ICggIiAiICsgcmVzdWx0ICsgIiAiICkuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoKICAgICAgICAgIG9wZXJhdG9yID09PSAifD0iID8gcmVzdWx0ID09PSBjaGVjayB8fCByZXN1bHQuc3Vic3RyKCAwLCBjaGVjay5sZW5ndGggKyAxICkgPT09IGNoZWNrICsgIi0iIDoKICAgICAgICAgIGZhbHNlOwogICAgICB9OwogICAgfSwKCiAgICAiQ0hJTEQiOiBmdW5jdGlvbiggdHlwZSwgd2hhdCwgYXJndW1lbnQsIGZpcnN0LCBsYXN0ICkgewogICAgICB2YXIgc2ltcGxlID0gdHlwZS5zbGljZSggMCwgMyApICE9PSAibnRoIiwKICAgICAgICBmb3J3YXJkID0gdHlwZS5zbGljZSggLTQgKSAhPT0gImxhc3QiLAogICAgICAgIG9mVHlwZSA9IHdoYXQgPT09ICJvZi10eXBlIjsKCiAgICAgIHJldHVybiBmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwID8KCiAgICAgICAgLy8gU2hvcnRjdXQgZm9yIDpudGgtKihuKQogICAgICAgIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAgICAgcmV0dXJuICEhZWxlbS5wYXJlbnROb2RlOwogICAgICAgIH0gOgoKICAgICAgICBmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewogICAgICAgICAgdmFyIGNhY2hlLCBvdXRlckNhY2hlLCBub2RlLCBkaWZmLCBub2RlSW5kZXgsIHN0YXJ0LAogICAgICAgICAgICBkaXIgPSBzaW1wbGUgIT09IGZvcndhcmQgPyAibmV4dFNpYmxpbmciIDogInByZXZpb3VzU2libGluZyIsCiAgICAgICAgICAgIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZSwKICAgICAgICAgICAgbmFtZSA9IG9mVHlwZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIHVzZUNhY2hlID0gIXhtbCAmJiAhb2ZUeXBlOwoKICAgICAgICAgIGlmICggcGFyZW50ICkgewoKICAgICAgICAgICAgLy8gOihmaXJzdHxsYXN0fG9ubHkpLShjaGlsZHxvZi10eXBlKQogICAgICAgICAgICBpZiAoIHNpbXBsZSApIHsKICAgICAgICAgICAgICB3aGlsZSAoIGRpciApIHsKICAgICAgICAgICAgICAgIG5vZGUgPSBlbGVtOwogICAgICAgICAgICAgICAgd2hpbGUgKCAobm9kZSA9IG5vZGVbIGRpciBdKSApIHsKICAgICAgICAgICAgICAgICAgaWYgKCBvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxICkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gUmV2ZXJzZSBkaXJlY3Rpb24gZm9yIDpvbmx5LSogKGlmIHdlIGhhdmVuJ3QgeWV0IGRvbmUgc28pCiAgICAgICAgICAgICAgICBzdGFydCA9IGRpciA9IHR5cGUgPT09ICJvbmx5IiAmJiAhc3RhcnQgJiYgIm5leHRTaWJsaW5nIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN0YXJ0ID0gWyBmb3J3YXJkID8gcGFyZW50LmZpcnN0Q2hpbGQgOiBwYXJlbnQubGFzdENoaWxkIF07CgogICAgICAgICAgICAvLyBub24teG1sIDpudGgtY2hpbGQoLi4uKSBzdG9yZXMgY2FjaGUgZGF0YSBvbiBgcGFyZW50YAogICAgICAgICAgICBpZiAoIGZvcndhcmQgJiYgdXNlQ2FjaGUgKSB7CiAgICAgICAgICAgICAgLy8gU2VlayBgZWxlbWAgZnJvbSBhIHByZXZpb3VzbHktY2FjaGVkIGluZGV4CiAgICAgICAgICAgICAgb3V0ZXJDYWNoZSA9IHBhcmVudFsgZXhwYW5kbyBdIHx8IChwYXJlbnRbIGV4cGFuZG8gXSA9IHt9KTsKICAgICAgICAgICAgICBjYWNoZSA9IG91dGVyQ2FjaGVbIHR5cGUgXSB8fCBbXTsKICAgICAgICAgICAgICBub2RlSW5kZXggPSBjYWNoZVswXSA9PT0gZGlycnVucyAmJiBjYWNoZVsxXTsKICAgICAgICAgICAgICBkaWZmID0gY2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbMl07CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1sgbm9kZUluZGV4IF07CgogICAgICAgICAgICAgIHdoaWxlICggKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbIGRpciBdIHx8CgogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gc2Vla2luZyBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKICAgICAgICAgICAgICAgIChkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpICkgewoKICAgICAgICAgICAgICAgIC8vIFdoZW4gZm91bmQsIGNhY2hlIGluZGV4ZXMgb24gYHBhcmVudGAgYW5kIGJyZWFrCiAgICAgICAgICAgICAgICBpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgJiYgKytkaWZmICYmIG5vZGUgPT09IGVsZW0gKSB7CiAgICAgICAgICAgICAgICAgIG91dGVyQ2FjaGVbIHR5cGUgXSA9IFsgZGlycnVucywgbm9kZUluZGV4LCBkaWZmIF07CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQogICAgICAgICAgICB9IGVsc2UgaWYgKCB1c2VDYWNoZSAmJiAoY2FjaGUgPSAoZWxlbVsgZXhwYW5kbyBdIHx8IChlbGVtWyBleHBhbmRvIF0gPSB7fSkpWyB0eXBlIF0pICYmIGNhY2hlWzBdID09PSBkaXJydW5zICkgewogICAgICAgICAgICAgIGRpZmYgPSBjYWNoZVsxXTsKCiAgICAgICAgICAgIC8vIHhtbCA6bnRoLWNoaWxkKC4uLikgb3IgOm50aC1sYXN0LWNoaWxkKC4uLikgb3IgOm50aCgtbGFzdCk/LW9mLXR5cGUoLi4uKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIFVzZSB0aGUgc2FtZSBsb29wIGFzIGFib3ZlIHRvIHNlZWsgYGVsZW1gIGZyb20gdGhlIHN0YXJ0CiAgICAgICAgICAgICAgd2hpbGUgKCAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwKICAgICAgICAgICAgICAgIChkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpICkgewoKICAgICAgICAgICAgICAgIGlmICggKCBvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxICkgJiYgKytkaWZmICkgewogICAgICAgICAgICAgICAgICAvLyBDYWNoZSB0aGUgaW5kZXggb2YgZWFjaCBlbmNvdW50ZXJlZCBlbGVtZW50CiAgICAgICAgICAgICAgICAgIGlmICggdXNlQ2FjaGUgKSB7CiAgICAgICAgICAgICAgICAgICAgKG5vZGVbIGV4cGFuZG8gXSB8fCAobm9kZVsgZXhwYW5kbyBdID0ge30pKVsgdHlwZSBdID0gWyBkaXJydW5zLCBkaWZmIF07CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmICggbm9kZSA9PT0gZWxlbSApIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSW5jb3Jwb3JhdGUgdGhlIG9mZnNldCwgdGhlbiBjaGVjayBhZ2FpbnN0IGN5Y2xlIHNpemUKICAgICAgICAgICAgZGlmZiAtPSBsYXN0OwogICAgICAgICAgICByZXR1cm4gZGlmZiA9PT0gZmlyc3QgfHwgKCBkaWZmICUgZmlyc3QgPT09IDAgJiYgZGlmZiAvIGZpcnN0ID49IDAgKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSwKCiAgICAiUFNFVURPIjogZnVuY3Rpb24oIHBzZXVkbywgYXJndW1lbnQgKSB7CiAgICAgIC8vIHBzZXVkby1jbGFzcyBuYW1lcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZQogICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI3BzZXVkby1jbGFzc2VzCiAgICAgIC8vIFByaW9yaXRpemUgYnkgY2FzZSBzZW5zaXRpdml0eSBpbiBjYXNlIGN1c3RvbSBwc2V1ZG9zIGFyZSBhZGRlZCB3aXRoIHVwcGVyY2FzZSBsZXR0ZXJzCiAgICAgIC8vIFJlbWVtYmVyIHRoYXQgc2V0RmlsdGVycyBpbmhlcml0cyBmcm9tIHBzZXVkb3MKICAgICAgdmFyIGFyZ3MsCiAgICAgICAgZm4gPSBFeHByLnBzZXVkb3NbIHBzZXVkbyBdIHx8IEV4cHIuc2V0RmlsdGVyc1sgcHNldWRvLnRvTG93ZXJDYXNlKCkgXSB8fAogICAgICAgICAgU2l6emxlLmVycm9yKCAidW5zdXBwb3J0ZWQgcHNldWRvOiAiICsgcHNldWRvICk7CgogICAgICAvLyBUaGUgdXNlciBtYXkgdXNlIGNyZWF0ZVBzZXVkbyB0byBpbmRpY2F0ZSB0aGF0CiAgICAgIC8vIGFyZ3VtZW50cyBhcmUgbmVlZGVkIHRvIGNyZWF0ZSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgIC8vIGp1c3QgYXMgU2l6emxlIGRvZXMKICAgICAgaWYgKCBmblsgZXhwYW5kbyBdICkgewogICAgICAgIHJldHVybiBmbiggYXJndW1lbnQgKTsKICAgICAgfQoKICAgICAgLy8gQnV0IG1haW50YWluIHN1cHBvcnQgZm9yIG9sZCBzaWduYXR1cmVzCiAgICAgIGlmICggZm4ubGVuZ3RoID4gMSApIHsKICAgICAgICBhcmdzID0gWyBwc2V1ZG8sIHBzZXVkbywgIiIsIGFyZ3VtZW50IF07CiAgICAgICAgcmV0dXJuIEV4cHIuc2V0RmlsdGVycy5oYXNPd25Qcm9wZXJ0eSggcHNldWRvLnRvTG93ZXJDYXNlKCkgKSA/CiAgICAgICAgICBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CiAgICAgICAgICAgIHZhciBpZHgsCiAgICAgICAgICAgICAgbWF0Y2hlZCA9IGZuKCBzZWVkLCBhcmd1bWVudCApLAogICAgICAgICAgICAgIGkgPSBtYXRjaGVkLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKCBpLS0gKSB7CiAgICAgICAgICAgICAgaWR4ID0gaW5kZXhPZi5jYWxsKCBzZWVkLCBtYXRjaGVkW2ldICk7CiAgICAgICAgICAgICAgc2VlZFsgaWR4IF0gPSAhKCBtYXRjaGVzWyBpZHggXSA9IG1hdGNoZWRbaV0gKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkgOgogICAgICAgICAgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgICAgIHJldHVybiBmbiggZWxlbSwgMCwgYXJncyApOwogICAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZuOwogICAgfQogIH0sCgogIHBzZXVkb3M6IHsKICAgIC8vIFBvdGVudGlhbGx5IGNvbXBsZXggcHNldWRvcwogICAgIm5vdCI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICAgIC8vIFRyaW0gdGhlIHNlbGVjdG9yIHBhc3NlZCB0byBjb21waWxlCiAgICAgIC8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCiAgICAgIC8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwogICAgICB2YXIgaW5wdXQgPSBbXSwKICAgICAgICByZXN1bHRzID0gW10sCiAgICAgICAgbWF0Y2hlciA9IGNvbXBpbGUoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICkgKTsKCiAgICAgIHJldHVybiBtYXRjaGVyWyBleHBhbmRvIF0gPwogICAgICAgIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcywgY29udGV4dCwgeG1sICkgewogICAgICAgICAgdmFyIGVsZW0sCiAgICAgICAgICAgIHVubWF0Y2hlZCA9IG1hdGNoZXIoIHNlZWQsIG51bGwsIHhtbCwgW10gKSwKICAgICAgICAgICAgaSA9IHNlZWQubGVuZ3RoOwoKICAgICAgICAgIC8vIE1hdGNoIGVsZW1lbnRzIHVubWF0Y2hlZCBieSBgbWF0Y2hlcmAKICAgICAgICAgIHdoaWxlICggaS0tICkgewogICAgICAgICAgICBpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKICAgICAgICAgICAgICBzZWVkW2ldID0gIShtYXRjaGVzW2ldID0gZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KSA6CiAgICAgICAgZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKICAgICAgICAgIGlucHV0WzBdID0gZWxlbTsKICAgICAgICAgIG1hdGNoZXIoIGlucHV0LCBudWxsLCB4bWwsIHJlc3VsdHMgKTsKICAgICAgICAgIHJldHVybiAhcmVzdWx0cy5wb3AoKTsKICAgICAgICB9OwogICAgfSksCgogICAgImhhcyI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICByZXR1cm4gU2l6emxlKCBzZWxlY3RvciwgZWxlbSApLmxlbmd0aCA+IDA7CiAgICAgIH07CiAgICB9KSwKCiAgICAiY29udGFpbnMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHRleHQgKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICByZXR1cm4gKCBlbGVtLnRleHRDb250ZW50IHx8IGVsZW0uaW5uZXJUZXh0IHx8IGdldFRleHQoIGVsZW0gKSApLmluZGV4T2YoIHRleHQgKSA+IC0xOwogICAgICB9OwogICAgfSksCgogICAgLy8gIldoZXRoZXIgYW4gZWxlbWVudCBpcyByZXByZXNlbnRlZCBieSBhIDpsYW5nKCkgc2VsZWN0b3IKICAgIC8vIGlzIGJhc2VkIHNvbGVseSBvbiB0aGUgZWxlbWVudCdzIGxhbmd1YWdlIHZhbHVlCiAgICAvLyBiZWluZyBlcXVhbCB0byB0aGUgaWRlbnRpZmllciBDLAogICAgLy8gb3IgYmVnaW5uaW5nIHdpdGggdGhlIGlkZW50aWZpZXIgQyBpbW1lZGlhdGVseSBmb2xsb3dlZCBieSAiLSIuCiAgICAvLyBUaGUgbWF0Y2hpbmcgb2YgQyBhZ2FpbnN0IHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUgaXMgcGVyZm9ybWVkIGNhc2UtaW5zZW5zaXRpdmVseS4KICAgIC8vIFRoZSBpZGVudGlmaWVyIEMgZG9lcyBub3QgaGF2ZSB0byBiZSBhIHZhbGlkIGxhbmd1YWdlIG5hbWUuIgogICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNsYW5nLXBzZXVkbwogICAgImxhbmciOiBtYXJrRnVuY3Rpb24oIGZ1bmN0aW9uKCBsYW5nICkgewogICAgICAvLyBsYW5nIHZhbHVlIG11c3QgYmUgYSB2YWxpZCBpZGVudGlmaWRlcgogICAgICBpZiAoICFyaWRlbnRpZmllci50ZXN0KGxhbmcgfHwgIiIpICkgewogICAgICAgIFNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIGxhbmc6ICIgKyBsYW5nICk7CiAgICAgIH0KICAgICAgbGFuZyA9IGxhbmcucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKS50b0xvd2VyQ2FzZSgpOwogICAgICByZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgdmFyIGVsZW1MYW5nOwogICAgICAgIGRvIHsKICAgICAgICAgIGlmICggKGVsZW1MYW5nID0gZG9jdW1lbnRJc1hNTCA/CiAgICAgICAgICAgIGVsZW0uZ2V0QXR0cmlidXRlKCJ4bWw6bGFuZyIpIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJsYW5nIikgOgogICAgICAgICAgICBlbGVtLmxhbmcpICkgewoKICAgICAgICAgICAgZWxlbUxhbmcgPSBlbGVtTGFuZy50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICByZXR1cm4gZWxlbUxhbmcgPT09IGxhbmcgfHwgZWxlbUxhbmcuaW5kZXhPZiggbGFuZyArICItIiApID09PSAwOwogICAgICAgICAgfQogICAgICAgIH0gd2hpbGUgKCAoZWxlbSA9IGVsZW0ucGFyZW50Tm9kZSkgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgIH0pLAoKICAgIC8vIE1pc2NlbGxhbmVvdXMKICAgICJ0YXJnZXQiOiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgdmFyIGhhc2ggPSB3aW5kb3cubG9jYXRpb24gJiYgd2luZG93LmxvY2F0aW9uLmhhc2g7CiAgICAgIHJldHVybiBoYXNoICYmIGhhc2guc2xpY2UoIDEgKSA9PT0gZWxlbS5pZDsKICAgIH0sCgogICAgInJvb3QiOiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgcmV0dXJuIGVsZW0gPT09IGRvY0VsZW07CiAgICB9LAoKICAgICJmb2N1cyI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICByZXR1cm4gZWxlbSA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAoIWRvY3VtZW50Lmhhc0ZvY3VzIHx8IGRvY3VtZW50Lmhhc0ZvY3VzKCkpICYmICEhKGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXgpOwogICAgfSwKCiAgICAvLyBCb29sZWFuIHByb3BlcnRpZXMKICAgICJlbmFibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZTsKICAgIH0sCgogICAgImRpc2FibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSB0cnVlOwogICAgfSwKCiAgICAiY2hlY2tlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAvLyBJbiBDU1MzLCA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIGJvdGggY2hlY2tlZCBhbmQgc2VsZWN0ZWQgZWxlbWVudHMKICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICByZXR1cm4gKG5vZGVOYW1lID09PSAiaW5wdXQiICYmICEhZWxlbS5jaGVja2VkKSB8fCAobm9kZU5hbWUgPT09ICJvcHRpb24iICYmICEhZWxlbS5zZWxlY3RlZCk7CiAgICB9LAoKICAgICJzZWxlY3RlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CiAgICAgIC8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkKICAgICAgaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CiAgICAgICAgZWxlbS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CiAgICAgIH0KCiAgICAgIHJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOwogICAgfSwKCiAgICAvLyBDb250ZW50cwogICAgImVtcHR5IjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jZW1wdHktcHNldWRvCiAgICAgIC8vIDplbXB0eSBpcyBvbmx5IGFmZmVjdGVkIGJ5IGVsZW1lbnQgbm9kZXMgYW5kIGNvbnRlbnQgbm9kZXMoaW5jbHVkaW5nIHRleHQoMyksIGNkYXRhKDQpKSwKICAgICAgLy8gICBub3QgY29tbWVudCwgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbnMsIG9yIG90aGVycwogICAgICAvLyBUaGFua3MgdG8gRGllZ28gUGVyaW5pIGZvciB0aGUgbm9kZU5hbWUgc2hvcnRjdXQKICAgICAgLy8gICBHcmVhdGVyIHRoYW4gIkAiIG1lYW5zIGFscGhhIGNoYXJhY3RlcnMgKHNwZWNpZmljYWxseSBub3Qgc3RhcnRpbmcgd2l0aCAiIyIgb3IgIj8iKQogICAgICBmb3IgKCBlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZyApIHsKICAgICAgICBpZiAoIGVsZW0ubm9kZU5hbWUgPiAiQCIgfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA0ICkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgInBhcmVudCI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICByZXR1cm4gIUV4cHIucHNldWRvc1siZW1wdHkiXSggZWxlbSApOwogICAgfSwKCiAgICAvLyBFbGVtZW50L2lucHV0IHR5cGVzCiAgICAiaGVhZGVyIjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIHJldHVybiByaGVhZGVyLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKICAgIH0sCgogICAgImlucHV0IjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIHJldHVybiByaW5wdXRzLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKICAgIH0sCgogICAgImJ1dHRvbiI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgcmV0dXJuIG5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSAiYnV0dG9uIiB8fCBuYW1lID09PSAiYnV0dG9uIjsKICAgIH0sCgogICAgInRleHQiOiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgdmFyIGF0dHI7CiAgICAgIC8vIElFNiBhbmQgNyB3aWxsIG1hcCBlbGVtLnR5cGUgdG8gJ3RleHQnIGZvciBuZXcgSFRNTDUgdHlwZXMgKHNlYXJjaCwgZXRjKQogICAgICAvLyB1c2UgZ2V0QXR0cmlidXRlIGluc3RlYWQgdG8gdGVzdCB0aGlzIGNhc2UKICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJgogICAgICAgIGVsZW0udHlwZSA9PT0gInRleHQiICYmCiAgICAgICAgKCAoYXR0ciA9IGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIikpID09IG51bGwgfHwgYXR0ci50b0xvd2VyQ2FzZSgpID09PSBlbGVtLnR5cGUgKTsKICAgIH0sCgogICAgLy8gUG9zaXRpb24taW4tY29sbGVjdGlvbgogICAgImZpcnN0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFsgMCBdOwogICAgfSksCgogICAgImxhc3QiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKICAgICAgcmV0dXJuIFsgbGVuZ3RoIC0gMSBdOwogICAgfSksCgogICAgImVxIjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewogICAgICByZXR1cm4gWyBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50IF07CiAgICB9KSwKCiAgICAiZXZlbiI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewogICAgICB2YXIgaSA9IDA7CiAgICAgIGZvciAoIDsgaSA8IGxlbmd0aDsgaSArPSAyICkgewogICAgICAgIG1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoSW5kZXhlczsKICAgIH0pLAoKICAgICJvZGQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKICAgICAgdmFyIGkgPSAxOwogICAgICBmb3IgKCA7IGkgPCBsZW5ndGg7IGkgKz0gMiApIHsKICAgICAgICBtYXRjaEluZGV4ZXMucHVzaCggaSApOwogICAgICB9CiAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICB9KSwKCiAgICAibHQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CiAgICAgIHZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudDsKICAgICAgZm9yICggOyAtLWkgPj0gMDsgKSB7CiAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsKICAgICAgfQogICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgfSksCgogICAgImd0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewogICAgICB2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7CiAgICAgIGZvciAoIDsgKytpIDwgbGVuZ3RoOyApIHsKICAgICAgICBtYXRjaEluZGV4ZXMucHVzaCggaSApOwogICAgICB9CiAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICB9KQogIH0KfTsKCi8vIEFkZCBidXR0b24vaW5wdXQgdHlwZSBwc2V1ZG9zCmZvciAoIGkgaW4geyByYWRpbzogdHJ1ZSwgY2hlY2tib3g6IHRydWUsIGZpbGU6IHRydWUsIHBhc3N3b3JkOiB0cnVlLCBpbWFnZTogdHJ1ZSB9ICkgewogIEV4cHIucHNldWRvc1sgaSBdID0gY3JlYXRlSW5wdXRQc2V1ZG8oIGkgKTsKfQpmb3IgKCBpIGluIHsgc3VibWl0OiB0cnVlLCByZXNldDogdHJ1ZSB9ICkgewogIEV4cHIucHNldWRvc1sgaSBdID0gY3JlYXRlQnV0dG9uUHNldWRvKCBpICk7Cn0KCmZ1bmN0aW9uIHRva2VuaXplKCBzZWxlY3RvciwgcGFyc2VPbmx5ICkgewogIHZhciBtYXRjaGVkLCBtYXRjaCwgdG9rZW5zLCB0eXBlLAogICAgc29GYXIsIGdyb3VwcywgcHJlRmlsdGVycywKICAgIGNhY2hlZCA9IHRva2VuQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgogIGlmICggY2FjaGVkICkgewogICAgcmV0dXJuIHBhcnNlT25seSA/IDAgOiBjYWNoZWQuc2xpY2UoIDAgKTsKICB9CgogIHNvRmFyID0gc2VsZWN0b3I7CiAgZ3JvdXBzID0gW107CiAgcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyOwoKICB3aGlsZSAoIHNvRmFyICkgewoKICAgIC8vIENvbW1hIGFuZCBmaXJzdCBydW4KICAgIGlmICggIW1hdGNoZWQgfHwgKG1hdGNoID0gcmNvbW1hLmV4ZWMoIHNvRmFyICkpICkgewogICAgICBpZiAoIG1hdGNoICkgewogICAgICAgIC8vIERvbid0IGNvbnN1bWUgdHJhaWxpbmcgY29tbWFzIGFzIHZhbGlkCiAgICAgICAgc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hbMF0ubGVuZ3RoICkgfHwgc29GYXI7CiAgICAgIH0KICAgICAgZ3JvdXBzLnB1c2goIHRva2VucyA9IFtdICk7CiAgICB9CgogICAgbWF0Y2hlZCA9IGZhbHNlOwoKICAgIC8vIENvbWJpbmF0b3JzCiAgICBpZiAoIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApKSApIHsKICAgICAgbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CiAgICAgIHRva2Vucy5wdXNoKCB7CiAgICAgICAgdmFsdWU6IG1hdGNoZWQsCiAgICAgICAgLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCiAgICAgICAgdHlwZTogbWF0Y2hbMF0ucmVwbGFjZSggcnRyaW0sICIgIiApCiAgICAgIH0gKTsKICAgICAgc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hlZC5sZW5ndGggKTsKICAgIH0KCiAgICAvLyBGaWx0ZXJzCiAgICBmb3IgKCB0eXBlIGluIEV4cHIuZmlsdGVyICkgewogICAgICBpZiAoIChtYXRjaCA9IG1hdGNoRXhwclsgdHlwZSBdLmV4ZWMoIHNvRmFyICkpICYmICghcHJlRmlsdGVyc1sgdHlwZSBdIHx8CiAgICAgICAgKG1hdGNoID0gcHJlRmlsdGVyc1sgdHlwZSBdKCBtYXRjaCApKSkgKSB7CiAgICAgICAgbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CiAgICAgICAgdG9rZW5zLnB1c2goIHsKICAgICAgICAgIHZhbHVlOiBtYXRjaGVkLAogICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgIG1hdGNoZXM6IG1hdGNoCiAgICAgICAgfSApOwogICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoICFtYXRjaGVkICkgewogICAgICBicmVhazsKICAgIH0KICB9CgogIC8vIFJldHVybiB0aGUgbGVuZ3RoIG9mIHRoZSBpbnZhbGlkIGV4Y2VzcwogIC8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwogIC8vIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3Igb3IgcmV0dXJuIHRva2VucwogIHJldHVybiBwYXJzZU9ubHkgPwogICAgc29GYXIubGVuZ3RoIDoKICAgIHNvRmFyID8KICAgICAgU2l6emxlLmVycm9yKCBzZWxlY3RvciApIDoKICAgICAgLy8gQ2FjaGUgdGhlIHRva2VucwogICAgICB0b2tlbkNhY2hlKCBzZWxlY3RvciwgZ3JvdXBzICkuc2xpY2UoIDAgKTsKfQoKZnVuY3Rpb24gdG9TZWxlY3RvciggdG9rZW5zICkgewogIHZhciBpID0gMCwKICAgIGxlbiA9IHRva2Vucy5sZW5ndGgsCiAgICBzZWxlY3RvciA9ICIiOwogIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgc2VsZWN0b3IgKz0gdG9rZW5zW2ldLnZhbHVlOwogIH0KICByZXR1cm4gc2VsZWN0b3I7Cn0KCmZ1bmN0aW9uIGFkZENvbWJpbmF0b3IoIG1hdGNoZXIsIGNvbWJpbmF0b3IsIGJhc2UgKSB7CiAgdmFyIGRpciA9IGNvbWJpbmF0b3IuZGlyLAogICAgY2hlY2tOb25FbGVtZW50cyA9IGJhc2UgJiYgY29tYmluYXRvci5kaXIgPT09ICJwYXJlbnROb2RlIiwKICAgIGRvbmVOYW1lID0gZG9uZSsrOwoKICByZXR1cm4gY29tYmluYXRvci5maXJzdCA/CiAgICAvLyBDaGVjayBhZ2FpbnN0IGNsb3Nlc3QgYW5jZXN0b3IvcHJlY2VkaW5nIGVsZW1lbnQKICAgIGZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CiAgICAgIHdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CiAgICAgICAgaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CiAgICAgICAgICByZXR1cm4gbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICk7CiAgICAgICAgfQogICAgICB9CiAgICB9IDoKCiAgICAvLyBDaGVjayBhZ2FpbnN0IGFsbCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudHMKICAgIGZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CiAgICAgIHZhciBkYXRhLCBjYWNoZSwgb3V0ZXJDYWNoZSwKICAgICAgICBkaXJrZXkgPSBkaXJydW5zICsgIiAiICsgZG9uZU5hbWU7CgogICAgICAvLyBXZSBjYW4ndCBzZXQgYXJiaXRyYXJ5IGRhdGEgb24gWE1MIG5vZGVzLCBzbyB0aGV5IGRvbid0IGJlbmVmaXQgZnJvbSBkaXIgY2FjaGluZwogICAgICBpZiAoIHhtbCApIHsKICAgICAgICB3aGlsZSAoIChlbGVtID0gZWxlbVsgZGlyIF0pICkgewogICAgICAgICAgaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CiAgICAgICAgICAgIGlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKICAgICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgewogICAgICAgICAgICBvdXRlckNhY2hlID0gZWxlbVsgZXhwYW5kbyBdIHx8IChlbGVtWyBleHBhbmRvIF0gPSB7fSk7CiAgICAgICAgICAgIGlmICggKGNhY2hlID0gb3V0ZXJDYWNoZVsgZGlyIF0pICYmIGNhY2hlWzBdID09PSBkaXJrZXkgKSB7CiAgICAgICAgICAgICAgaWYgKCAoZGF0YSA9IGNhY2hlWzFdKSA9PT0gdHJ1ZSB8fCBkYXRhID09PSBjYWNoZWRydW5zICkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGEgPT09IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNhY2hlID0gb3V0ZXJDYWNoZVsgZGlyIF0gPSBbIGRpcmtleSBdOwogICAgICAgICAgICAgIGNhY2hlWzFdID0gbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgfHwgY2FjaGVkcnVuczsKICAgICAgICAgICAgICBpZiAoIGNhY2hlWzFdID09PSB0cnVlICkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9Owp9CgpmdW5jdGlvbiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSB7CiAgcmV0dXJuIG1hdGNoZXJzLmxlbmd0aCA+IDEgPwogICAgZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKICAgICAgdmFyIGkgPSBtYXRjaGVycy5sZW5ndGg7CiAgICAgIHdoaWxlICggaS0tICkgewogICAgICAgIGlmICggIW1hdGNoZXJzW2ldKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9IDoKICAgIG1hdGNoZXJzWzBdOwp9CgpmdW5jdGlvbiBjb25kZW5zZSggdW5tYXRjaGVkLCBtYXAsIGZpbHRlciwgY29udGV4dCwgeG1sICkgewogIHZhciBlbGVtLAogICAgbmV3VW5tYXRjaGVkID0gW10sCiAgICBpID0gMCwKICAgIGxlbiA9IHVubWF0Y2hlZC5sZW5ndGgsCiAgICBtYXBwZWQgPSBtYXAgIT0gbnVsbDsKCiAgZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CiAgICBpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKICAgICAgaWYgKCAhZmlsdGVyIHx8IGZpbHRlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CiAgICAgICAgbmV3VW5tYXRjaGVkLnB1c2goIGVsZW0gKTsKICAgICAgICBpZiAoIG1hcHBlZCApIHsKICAgICAgICAgIG1hcC5wdXNoKCBpICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gbmV3VW5tYXRjaGVkOwp9CgpmdW5jdGlvbiBzZXRNYXRjaGVyKCBwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKSB7CiAgaWYgKCBwb3N0RmlsdGVyICYmICFwb3N0RmlsdGVyWyBleHBhbmRvIF0gKSB7CiAgICBwb3N0RmlsdGVyID0gc2V0TWF0Y2hlciggcG9zdEZpbHRlciApOwogIH0KICBpZiAoIHBvc3RGaW5kZXIgJiYgIXBvc3RGaW5kZXJbIGV4cGFuZG8gXSApIHsKICAgIHBvc3RGaW5kZXIgPSBzZXRNYXRjaGVyKCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKTsKICB9CiAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgcmVzdWx0cywgY29udGV4dCwgeG1sICkgewogICAgdmFyIHRlbXAsIGksIGVsZW0sCiAgICAgIHByZU1hcCA9IFtdLAogICAgICBwb3N0TWFwID0gW10sCiAgICAgIHByZWV4aXN0aW5nID0gcmVzdWx0cy5sZW5ndGgsCgogICAgICAvLyBHZXQgaW5pdGlhbCBlbGVtZW50cyBmcm9tIHNlZWQgb3IgY29udGV4dAogICAgICBlbGVtcyA9IHNlZWQgfHwgbXVsdGlwbGVDb250ZXh0cyggc2VsZWN0b3IgfHwgIioiLCBjb250ZXh0Lm5vZGVUeXBlID8gWyBjb250ZXh0IF0gOiBjb250ZXh0LCBbXSApLAoKICAgICAgLy8gUHJlZmlsdGVyIHRvIGdldCBtYXRjaGVyIGlucHV0LCBwcmVzZXJ2aW5nIGEgbWFwIGZvciBzZWVkLXJlc3VsdHMgc3luY2hyb25pemF0aW9uCiAgICAgIG1hdGNoZXJJbiA9IHByZUZpbHRlciAmJiAoIHNlZWQgfHwgIXNlbGVjdG9yICkgPwogICAgICAgIGNvbmRlbnNlKCBlbGVtcywgcHJlTWFwLCBwcmVGaWx0ZXIsIGNvbnRleHQsIHhtbCApIDoKICAgICAgICBlbGVtcywKCiAgICAgIG1hdGNoZXJPdXQgPSBtYXRjaGVyID8KICAgICAgICAvLyBJZiB3ZSBoYXZlIGEgcG9zdEZpbmRlciwgb3IgZmlsdGVyZWQgc2VlZCwgb3Igbm9uLXNlZWQgcG9zdEZpbHRlciBvciBwcmVleGlzdGluZyByZXN1bHRzLAogICAgICAgIHBvc3RGaW5kZXIgfHwgKCBzZWVkID8gcHJlRmlsdGVyIDogcHJlZXhpc3RpbmcgfHwgcG9zdEZpbHRlciApID8KCiAgICAgICAgICAvLyAuLi5pbnRlcm1lZGlhdGUgcHJvY2Vzc2luZyBpcyBuZWNlc3NhcnkKICAgICAgICAgIFtdIDoKCiAgICAgICAgICAvLyAuLi5vdGhlcndpc2UgdXNlIHJlc3VsdHMgZGlyZWN0bHkKICAgICAgICAgIHJlc3VsdHMgOgogICAgICAgIG1hdGNoZXJJbjsKCiAgICAvLyBGaW5kIHByaW1hcnkgbWF0Y2hlcwogICAgaWYgKCBtYXRjaGVyICkgewogICAgICBtYXRjaGVyKCBtYXRjaGVySW4sIG1hdGNoZXJPdXQsIGNvbnRleHQsIHhtbCApOwogICAgfQoKICAgIC8vIEFwcGx5IHBvc3RGaWx0ZXIKICAgIGlmICggcG9zdEZpbHRlciApIHsKICAgICAgdGVtcCA9IGNvbmRlbnNlKCBtYXRjaGVyT3V0LCBwb3N0TWFwICk7CiAgICAgIHBvc3RGaWx0ZXIoIHRlbXAsIFtdLCBjb250ZXh0LCB4bWwgKTsKCiAgICAgIC8vIFVuLW1hdGNoIGZhaWxpbmcgZWxlbWVudHMgYnkgbW92aW5nIHRoZW0gYmFjayB0byBtYXRjaGVySW4KICAgICAgaSA9IHRlbXAubGVuZ3RoOwogICAgICB3aGlsZSAoIGktLSApIHsKICAgICAgICBpZiAoIChlbGVtID0gdGVtcFtpXSkgKSB7CiAgICAgICAgICBtYXRjaGVyT3V0WyBwb3N0TWFwW2ldIF0gPSAhKG1hdGNoZXJJblsgcG9zdE1hcFtpXSBdID0gZWxlbSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKCBzZWVkICkgewogICAgICBpZiAoIHBvc3RGaW5kZXIgfHwgcHJlRmlsdGVyICkgewogICAgICAgIGlmICggcG9zdEZpbmRlciApIHsKICAgICAgICAgIC8vIEdldCB0aGUgZmluYWwgbWF0Y2hlck91dCBieSBjb25kZW5zaW5nIHRoaXMgaW50ZXJtZWRpYXRlIGludG8gcG9zdEZpbmRlciBjb250ZXh0cwogICAgICAgICAgdGVtcCA9IFtdOwogICAgICAgICAgaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKCBpLS0gKSB7CiAgICAgICAgICAgIGlmICggKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSApIHsKICAgICAgICAgICAgICAvLyBSZXN0b3JlIG1hdGNoZXJJbiBzaW5jZSBlbGVtIGlzIG5vdCB5ZXQgYSBmaW5hbCBtYXRjaAogICAgICAgICAgICAgIHRlbXAucHVzaCggKG1hdGNoZXJJbltpXSA9IGVsZW0pICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvc3RGaW5kZXIoIG51bGwsIChtYXRjaGVyT3V0ID0gW10pLCB0ZW1wLCB4bWwgKTsKICAgICAgICB9CgogICAgICAgIC8vIE1vdmUgbWF0Y2hlZCBlbGVtZW50cyBmcm9tIHNlZWQgdG8gcmVzdWx0cyB0byBrZWVwIHRoZW0gc3luY2hyb25pemVkCiAgICAgICAgaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwogICAgICAgIHdoaWxlICggaS0tICkgewogICAgICAgICAgaWYgKCAoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICYmCiAgICAgICAgICAgICh0ZW1wID0gcG9zdEZpbmRlciA/IGluZGV4T2YuY2FsbCggc2VlZCwgZWxlbSApIDogcHJlTWFwW2ldKSA+IC0xICkgewoKICAgICAgICAgICAgc2VlZFt0ZW1wXSA9ICEocmVzdWx0c1t0ZW1wXSA9IGVsZW0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgIC8vIEFkZCBlbGVtZW50cyB0byByZXN1bHRzLCB0aHJvdWdoIHBvc3RGaW5kZXIgaWYgZGVmaW5lZAogICAgfSBlbHNlIHsKICAgICAgbWF0Y2hlck91dCA9IGNvbmRlbnNlKAogICAgICAgIG1hdGNoZXJPdXQgPT09IHJlc3VsdHMgPwogICAgICAgICAgbWF0Y2hlck91dC5zcGxpY2UoIHByZWV4aXN0aW5nLCBtYXRjaGVyT3V0Lmxlbmd0aCApIDoKICAgICAgICAgIG1hdGNoZXJPdXQKICAgICAgKTsKICAgICAgaWYgKCBwb3N0RmluZGVyICkgewogICAgICAgIHBvc3RGaW5kZXIoIG51bGwsIHJlc3VsdHMsIG1hdGNoZXJPdXQsIHhtbCApOwogICAgICB9IGVsc2UgewogICAgICAgIHB1c2guYXBwbHkoIHJlc3VsdHMsIG1hdGNoZXJPdXQgKTsKICAgICAgfQogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbVRva2VucyggdG9rZW5zICkgewogIHZhciBjaGVja0NvbnRleHQsIG1hdGNoZXIsIGosCiAgICBsZW4gPSB0b2tlbnMubGVuZ3RoLAogICAgbGVhZGluZ1JlbGF0aXZlID0gRXhwci5yZWxhdGl2ZVsgdG9rZW5zWzBdLnR5cGUgXSwKICAgIGltcGxpY2l0UmVsYXRpdmUgPSBsZWFkaW5nUmVsYXRpdmUgfHwgRXhwci5yZWxhdGl2ZVsiICJdLAogICAgaSA9IGxlYWRpbmdSZWxhdGl2ZSA/IDEgOiAwLAoKICAgIC8vIFRoZSBmb3VuZGF0aW9uYWwgbWF0Y2hlciBlbnN1cmVzIHRoYXQgZWxlbWVudHMgYXJlIHJlYWNoYWJsZSBmcm9tIHRvcC1sZXZlbCBjb250ZXh0KHMpCiAgICBtYXRjaENvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsKICAgIH0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUgKSwKICAgIG1hdGNoQW55Q29udGV4dCA9IGFkZENvbWJpbmF0b3IoIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKCBjaGVja0NvbnRleHQsIGVsZW0gKSA+IC0xOwogICAgfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLAogICAgbWF0Y2hlcnMgPSBbIGZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CiAgICAgIHJldHVybiAoICFsZWFkaW5nUmVsYXRpdmUgJiYgKCB4bWwgfHwgY29udGV4dCAhPT0gb3V0ZXJtb3N0Q29udGV4dCApICkgfHwgKAogICAgICAgIChjaGVja0NvbnRleHQgPSBjb250ZXh0KS5ub2RlVHlwZSA/CiAgICAgICAgICBtYXRjaENvbnRleHQoIGVsZW0sIGNvbnRleHQsIHhtbCApIDoKICAgICAgICAgIG1hdGNoQW55Q29udGV4dCggZWxlbSwgY29udGV4dCwgeG1sICkgKTsKICAgIH0gXTsKCiAgZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CiAgICBpZiAoIChtYXRjaGVyID0gRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2ldLnR5cGUgXSkgKSB7CiAgICAgIG1hdGNoZXJzID0gWyBhZGRDb21iaW5hdG9yKGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApLCBtYXRjaGVyKSBdOwogICAgfSBlbHNlIHsKICAgICAgbWF0Y2hlciA9IEV4cHIuZmlsdGVyWyB0b2tlbnNbaV0udHlwZSBdLmFwcGx5KCBudWxsLCB0b2tlbnNbaV0ubWF0Y2hlcyApOwoKICAgICAgLy8gUmV0dXJuIHNwZWNpYWwgdXBvbiBzZWVpbmcgYSBwb3NpdGlvbmFsIG1hdGNoZXIKICAgICAgaWYgKCBtYXRjaGVyWyBleHBhbmRvIF0gKSB7CiAgICAgICAgLy8gRmluZCB0aGUgbmV4dCByZWxhdGl2ZSBvcGVyYXRvciAoaWYgYW55KSBmb3IgcHJvcGVyIGhhbmRsaW5nCiAgICAgICAgaiA9ICsraTsKICAgICAgICBmb3IgKCA7IGogPCBsZW47IGorKyApIHsKICAgICAgICAgIGlmICggRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2pdLnR5cGUgXSApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXRNYXRjaGVyKAogICAgICAgICAgaSA+IDEgJiYgZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICksCiAgICAgICAgICBpID4gMSAmJiB0b1NlbGVjdG9yKCB0b2tlbnMuc2xpY2UoIDAsIGkgLSAxICkgKS5yZXBsYWNlKCBydHJpbSwgIiQxIiApLAogICAgICAgICAgbWF0Y2hlciwKICAgICAgICAgIGkgPCBqICYmIG1hdGNoZXJGcm9tVG9rZW5zKCB0b2tlbnMuc2xpY2UoIGksIGogKSApLAogICAgICAgICAgaiA8IGxlbiAmJiBtYXRjaGVyRnJvbVRva2VucyggKHRva2VucyA9IHRva2Vucy5zbGljZSggaiApKSApLAogICAgICAgICAgaiA8IGxlbiAmJiB0b1NlbGVjdG9yKCB0b2tlbnMgKQogICAgICAgICk7CiAgICAgIH0KICAgICAgbWF0Y2hlcnMucHVzaCggbWF0Y2hlciApOwogICAgfQogIH0KCiAgcmV0dXJuIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoIGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMgKSB7CiAgLy8gQSBjb3VudGVyIHRvIHNwZWNpZnkgd2hpY2ggZWxlbWVudCBpcyBjdXJyZW50bHkgYmVpbmcgbWF0Y2hlZAogIHZhciBtYXRjaGVyQ2FjaGVkUnVucyA9IDAsCiAgICBieVNldCA9IHNldE1hdGNoZXJzLmxlbmd0aCA+IDAsCiAgICBieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwKICAgIHN1cGVyTWF0Y2hlciA9IGZ1bmN0aW9uKCBzZWVkLCBjb250ZXh0LCB4bWwsIHJlc3VsdHMsIGV4cGFuZENvbnRleHQgKSB7CiAgICAgIHZhciBlbGVtLCBqLCBtYXRjaGVyLAogICAgICAgIHNldE1hdGNoZWQgPSBbXSwKICAgICAgICBtYXRjaGVkQ291bnQgPSAwLAogICAgICAgIGkgPSAiMCIsCiAgICAgICAgdW5tYXRjaGVkID0gc2VlZCAmJiBbXSwKICAgICAgICBvdXRlcm1vc3QgPSBleHBhbmRDb250ZXh0ICE9IG51bGwsCiAgICAgICAgY29udGV4dEJhY2t1cCA9IG91dGVybW9zdENvbnRleHQsCiAgICAgICAgLy8gV2UgbXVzdCBhbHdheXMgaGF2ZSBlaXRoZXIgc2VlZCBlbGVtZW50cyBvciBjb250ZXh0CiAgICAgICAgZWxlbXMgPSBzZWVkIHx8IGJ5RWxlbWVudCAmJiBFeHByLmZpbmRbIlRBRyJdKCAiKiIsIGV4cGFuZENvbnRleHQgJiYgY29udGV4dC5wYXJlbnROb2RlIHx8IGNvbnRleHQgKSwKICAgICAgICAvLyBOZXN0ZWQgbWF0Y2hlcnMgc2hvdWxkIHVzZSBub24taW50ZWdlciBkaXJydW5zCiAgICAgICAgZGlycnVuc1VuaXF1ZSA9IChkaXJydW5zICs9IGNvbnRleHRCYWNrdXAgPT0gbnVsbCA/IDEgOiBNYXRoLkUpOwoKICAgICAgaWYgKCBvdXRlcm1vc3QgKSB7CiAgICAgICAgb3V0ZXJtb3N0Q29udGV4dCA9IGNvbnRleHQgIT09IGRvY3VtZW50ICYmIGNvbnRleHQ7CiAgICAgICAgY2FjaGVkcnVucyA9IG1hdGNoZXJDYWNoZWRSdW5zOwogICAgICB9CgogICAgICAvLyBBZGQgZWxlbWVudHMgcGFzc2luZyBlbGVtZW50TWF0Y2hlcnMgZGlyZWN0bHkgdG8gcmVzdWx0cwogICAgICBmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKICAgICAgICBpZiAoIGJ5RWxlbWVudCAmJiBlbGVtICkgewogICAgICAgICAgZm9yICggaiA9IDA7IChtYXRjaGVyID0gZWxlbWVudE1hdGNoZXJzW2pdKTsgaisrICkgewogICAgICAgICAgICBpZiAoIG1hdGNoZXIoIGVsZW0sIGNvbnRleHQsIHhtbCApICkgewogICAgICAgICAgICAgIHJlc3VsdHMucHVzaCggZWxlbSApOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIG91dGVybW9zdCApIHsKICAgICAgICAgICAgZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CiAgICAgICAgICAgIGNhY2hlZHJ1bnMgPSArK21hdGNoZXJDYWNoZWRSdW5zOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVHJhY2sgdW5tYXRjaGVkIGVsZW1lbnRzIGZvciBzZXQgZmlsdGVycwogICAgICAgIGlmICggYnlTZXQgKSB7CiAgICAgICAgICAvLyBUaGV5IHdpbGwgaGF2ZSBnb25lIHRocm91Z2ggYWxsIHBvc3NpYmxlIG1hdGNoZXJzCiAgICAgICAgICBpZiAoIChlbGVtID0gIW1hdGNoZXIgJiYgZWxlbSkgKSB7CiAgICAgICAgICAgIG1hdGNoZWRDb3VudC0tOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIExlbmd0aGVuIHRoZSBhcnJheSBmb3IgZXZlcnkgZWxlbWVudCwgbWF0Y2hlZCBvciBub3QKICAgICAgICAgIGlmICggc2VlZCApIHsKICAgICAgICAgICAgdW5tYXRjaGVkLnB1c2goIGVsZW0gKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEFwcGx5IHNldCBmaWx0ZXJzIHRvIHVubWF0Y2hlZCBlbGVtZW50cwogICAgICAvLyBgaWAgc3RhcnRzIGFzIGEgc3RyaW5nLCBzbyBtYXRjaGVkQ291bnQgd291bGQgZXF1YWwgIjAwIiBpZiB0aGVyZSBhcmUgbm8gZWxlbWVudHMKICAgICAgbWF0Y2hlZENvdW50ICs9IGk7CiAgICAgIGlmICggYnlTZXQgJiYgaSAhPT0gbWF0Y2hlZENvdW50ICkgewogICAgICAgIGZvciAoIGogPSAwOyAobWF0Y2hlciA9IHNldE1hdGNoZXJzW2pdKTsgaisrICkgewogICAgICAgICAgbWF0Y2hlciggdW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwgKTsKICAgICAgICB9CgogICAgICAgIGlmICggc2VlZCApIHsKICAgICAgICAgIC8vIFJlaW50ZWdyYXRlIGVsZW1lbnQgbWF0Y2hlcyB0byBlbGltaW5hdGUgdGhlIG5lZWQgZm9yIHNvcnRpbmcKICAgICAgICAgIGlmICggbWF0Y2hlZENvdW50ID4gMCApIHsKICAgICAgICAgICAgd2hpbGUgKCBpLS0gKSB7CiAgICAgICAgICAgICAgaWYgKCAhKHVubWF0Y2hlZFtpXSB8fCBzZXRNYXRjaGVkW2ldKSApIHsKICAgICAgICAgICAgICAgIHNldE1hdGNoZWRbaV0gPSBwb3AuY2FsbCggcmVzdWx0cyApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIERpc2NhcmQgaW5kZXggcGxhY2Vob2xkZXIgdmFsdWVzIHRvIGdldCBvbmx5IGFjdHVhbCBtYXRjaGVzCiAgICAgICAgICBzZXRNYXRjaGVkID0gY29uZGVuc2UoIHNldE1hdGNoZWQgKTsKICAgICAgICB9CgogICAgICAgIC8vIEFkZCBtYXRjaGVzIHRvIHJlc3VsdHMKICAgICAgICBwdXNoLmFwcGx5KCByZXN1bHRzLCBzZXRNYXRjaGVkICk7CgogICAgICAgIC8vIFNlZWRsZXNzIHNldCBtYXRjaGVzIHN1Y2NlZWRpbmcgbXVsdGlwbGUgc3VjY2Vzc2Z1bCBtYXRjaGVycyBzdGlwdWxhdGUgc29ydGluZwogICAgICAgIGlmICggb3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJgogICAgICAgICAgKCBtYXRjaGVkQ291bnQgKyBzZXRNYXRjaGVycy5sZW5ndGggKSA+IDEgKSB7CgogICAgICAgICAgU2l6emxlLnVuaXF1ZVNvcnQoIHJlc3VsdHMgKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIE92ZXJyaWRlIG1hbmlwdWxhdGlvbiBvZiBnbG9iYWxzIGJ5IG5lc3RlZCBtYXRjaGVycwogICAgICBpZiAoIG91dGVybW9zdCApIHsKICAgICAgICBkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsKICAgICAgICBvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dEJhY2t1cDsKICAgICAgfQoKICAgICAgcmV0dXJuIHVubWF0Y2hlZDsKICAgIH07CgogIHJldHVybiBieVNldCA/CiAgICBtYXJrRnVuY3Rpb24oIHN1cGVyTWF0Y2hlciApIDoKICAgIHN1cGVyTWF0Y2hlcjsKfQoKY29tcGlsZSA9IFNpenpsZS5jb21waWxlID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBncm91cCAvKiBJbnRlcm5hbCBVc2UgT25seSAqLyApIHsKICB2YXIgaSwKICAgIHNldE1hdGNoZXJzID0gW10sCiAgICBlbGVtZW50TWF0Y2hlcnMgPSBbXSwKICAgIGNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgogIGlmICggIWNhY2hlZCApIHsKICAgIC8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAogICAgaWYgKCAhZ3JvdXAgKSB7CiAgICAgIGdyb3VwID0gdG9rZW5pemUoIHNlbGVjdG9yICk7CiAgICB9CiAgICBpID0gZ3JvdXAubGVuZ3RoOwogICAgd2hpbGUgKCBpLS0gKSB7CiAgICAgIGNhY2hlZCA9IG1hdGNoZXJGcm9tVG9rZW5zKCBncm91cFtpXSApOwogICAgICBpZiAoIGNhY2hlZFsgZXhwYW5kbyBdICkgewogICAgICAgIHNldE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwogICAgICB9IGVsc2UgewogICAgICAgIGVsZW1lbnRNYXRjaGVycy5wdXNoKCBjYWNoZWQgKTsKICAgICAgfQogICAgfQoKICAgIC8vIENhY2hlIHRoZSBjb21waWxlZCBmdW5jdGlvbgogICAgY2FjaGVkID0gY29tcGlsZXJDYWNoZSggc2VsZWN0b3IsIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyggZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycyApICk7CiAgfQogIHJldHVybiBjYWNoZWQ7Cn07CgpmdW5jdGlvbiBtdWx0aXBsZUNvbnRleHRzKCBzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMgKSB7CiAgdmFyIGkgPSAwLAogICAgbGVuID0gY29udGV4dHMubGVuZ3RoOwogIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgU2l6emxlKCBzZWxlY3RvciwgY29udGV4dHNbaV0sIHJlc3VsdHMgKTsKICB9CiAgcmV0dXJuIHJlc3VsdHM7Cn0KCmZ1bmN0aW9uIHNlbGVjdCggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKSB7CiAgdmFyIGksIHRva2VucywgdG9rZW4sIHR5cGUsIGZpbmQsCiAgICBtYXRjaCA9IHRva2VuaXplKCBzZWxlY3RvciApOwoKICBpZiAoICFzZWVkICkgewogICAgLy8gVHJ5IHRvIG1pbmltaXplIG9wZXJhdGlvbnMgaWYgdGhlcmUgaXMgb25seSBvbmUgZ3JvdXAKICAgIGlmICggbWF0Y2gubGVuZ3RoID09PSAxICkgewoKICAgICAgLy8gVGFrZSBhIHNob3J0Y3V0IGFuZCBzZXQgdGhlIGNvbnRleHQgaWYgdGhlIHJvb3Qgc2VsZWN0b3IgaXMgYW4gSUQKICAgICAgdG9rZW5zID0gbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSggMCApOwogICAgICBpZiAoIHRva2Vucy5sZW5ndGggPiAyICYmICh0b2tlbiA9IHRva2Vuc1swXSkudHlwZSA9PT0gIklEIiAmJgogICAgICAgICAgY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiAhZG9jdW1lbnRJc1hNTCAmJgogICAgICAgICAgRXhwci5yZWxhdGl2ZVsgdG9rZW5zWzFdLnR5cGUgXSApIHsKCiAgICAgICAgY29udGV4dCA9IEV4cHIuZmluZFsiSUQiXSggdG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLCBjb250ZXh0IClbMF07CiAgICAgICAgaWYgKCAhY29udGV4dCApIHsKICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgIH0KCiAgICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5zbGljZSggdG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoICk7CiAgICAgIH0KCiAgICAgIC8vIEZldGNoIGEgc2VlZCBzZXQgZm9yIHJpZ2h0LXRvLWxlZnQgbWF0Y2hpbmcKICAgICAgZm9yICggaSA9IG1hdGNoRXhwclsibmVlZHNDb250ZXh0Il0udGVzdCggc2VsZWN0b3IgKSA/IC0xIDogdG9rZW5zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewogICAgICAgIHRva2VuID0gdG9rZW5zW2ldOwoKICAgICAgICAvLyBBYm9ydCBpZiB3ZSBoaXQgYSBjb21iaW5hdG9yCiAgICAgICAgaWYgKCBFeHByLnJlbGF0aXZlWyAodHlwZSA9IHRva2VuLnR5cGUpIF0gKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCAoZmluZCA9IEV4cHIuZmluZFsgdHlwZSBdKSApIHsKICAgICAgICAgIC8vIFNlYXJjaCwgZXhwYW5kaW5nIGNvbnRleHQgZm9yIGxlYWRpbmcgc2libGluZyBjb21iaW5hdG9ycwogICAgICAgICAgaWYgKCAoc2VlZCA9IGZpbmQoCiAgICAgICAgICAgIHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKSwKICAgICAgICAgICAgcnNpYmxpbmcudGVzdCggdG9rZW5zWzBdLnR5cGUgKSAmJiBjb250ZXh0LnBhcmVudE5vZGUgfHwgY29udGV4dAogICAgICAgICAgKSkgKSB7CgogICAgICAgICAgICAvLyBJZiBzZWVkIGlzIGVtcHR5IG9yIG5vIHRva2VucyByZW1haW4sIHdlIGNhbiByZXR1cm4gZWFybHkKICAgICAgICAgICAgdG9rZW5zLnNwbGljZSggaSwgMSApOwogICAgICAgICAgICBzZWxlY3RvciA9IHNlZWQubGVuZ3RoICYmIHRvU2VsZWN0b3IoIHRva2VucyApOwogICAgICAgICAgICBpZiAoICFzZWxlY3RvciApIHsKICAgICAgICAgICAgICBwdXNoLmFwcGx5KCByZXN1bHRzLCBzbGljZS5jYWxsKCBzZWVkLCAwICkgKTsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICAvLyBDb21waWxlIGFuZCBleGVjdXRlIGEgZmlsdGVyaW5nIGZ1bmN0aW9uCiAgLy8gUHJvdmlkZSBgbWF0Y2hgIHRvIGF2b2lkIHJldG9rZW5pemF0aW9uIGlmIHdlIG1vZGlmaWVkIHRoZSBzZWxlY3RvciBhYm92ZQogIGNvbXBpbGUoIHNlbGVjdG9yLCBtYXRjaCApKAogICAgc2VlZCwKICAgIGNvbnRleHQsCiAgICBkb2N1bWVudElzWE1MLAogICAgcmVzdWx0cywKICAgIHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkKICApOwogIHJldHVybiByZXN1bHRzOwp9CgovLyBEZXByZWNhdGVkCkV4cHIucHNldWRvc1sibnRoIl0gPSBFeHByLnBzZXVkb3NbImVxIl07CgovLyBFYXN5IEFQSSBmb3IgY3JlYXRpbmcgbmV3IHNldEZpbHRlcnMKZnVuY3Rpb24gc2V0RmlsdGVycygpIHt9CkV4cHIuZmlsdGVycyA9IHNldEZpbHRlcnMucHJvdG90eXBlID0gRXhwci5wc2V1ZG9zOwpFeHByLnNldEZpbHRlcnMgPSBuZXcgc2V0RmlsdGVycygpOwoKLy8gSW5pdGlhbGl6ZSB3aXRoIHRoZSBkZWZhdWx0IGRvY3VtZW50CnNldERvY3VtZW50KCk7CgovLyBPdmVycmlkZSBzaXp6bGUgYXR0cmlidXRlIHJldHJpZXZhbApTaXp6bGUuYXR0ciA9IGpRdWVyeS5hdHRyOwpqUXVlcnkuZmluZCA9IFNpenpsZTsKalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwpqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIucHNldWRvczsKalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwpqUXVlcnkudGV4dCA9IFNpenpsZS5nZXRUZXh0OwpqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CmpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKCgp9KSggd2luZG93ICk7CnZhciBydW50aWwgPSAvVW50aWwkLywKICBycGFyZW50c3ByZXYgPSAvXig/OnBhcmVudHN8cHJldig/OlVudGlsfEFsbCkpLywKICBpc1NpbXBsZSA9IC9eLlteOiNcW1wuLF0qJC8sCiAgcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dCwKICAvLyBtZXRob2RzIGd1YXJhbnRlZWQgdG8gcHJvZHVjZSBhIHVuaXF1ZSBzZXQgd2hlbiBzdGFydGluZyBmcm9tIGEgdW5pcXVlIHNldAogIGd1YXJhbnRlZWRVbmlxdWUgPSB7CiAgICBjaGlsZHJlbjogdHJ1ZSwKICAgIGNvbnRlbnRzOiB0cnVlLAogICAgbmV4dDogdHJ1ZSwKICAgIHByZXY6IHRydWUKICB9OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CiAgZmluZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewogICAgdmFyIGksIHJldCwgc2VsZjsKCiAgICBpZiAoIHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgKSB7CiAgICAgIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeSggc2VsZWN0b3IgKS5maWx0ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICggaSA9IDA7IGkgPCBzZWxmLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgaWYgKCBqUXVlcnkuY29udGFpbnMoIHNlbGZbIGkgXSwgdGhpcyApICkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pICk7CiAgICB9CgogICAgcmV0ID0gW107CiAgICBmb3IgKCBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKysgKSB7CiAgICAgIGpRdWVyeS5maW5kKCBzZWxlY3RvciwgdGhpc1sgaSBdLCByZXQgKTsKICAgIH0KCiAgICAvLyBOZWVkZWQgYmVjYXVzZSAkKCBzZWxlY3RvciwgY29udGV4dCApIGJlY29tZXMgJCggY29udGV4dCApLmZpbmQoIHNlbGVjdG9yICkKICAgIHJldCA9IHRoaXMucHVzaFN0YWNrKCBqUXVlcnkudW5pcXVlKCByZXQgKSApOwogICAgcmV0LnNlbGVjdG9yID0gKCB0aGlzLnNlbGVjdG9yID8gdGhpcy5zZWxlY3RvciArICIgIiA6ICIiICkgKyBzZWxlY3RvcjsKICAgIHJldHVybiByZXQ7CiAgfSwKCiAgaGFzOiBmdW5jdGlvbiggdGFyZ2V0ICkgewogICAgdmFyIGksCiAgICAgIHRhcmdldHMgPSBqUXVlcnkoIHRhcmdldCwgdGhpcyApLAogICAgICBsZW4gPSB0YXJnZXRzLmxlbmd0aDsKCiAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oKSB7CiAgICAgIGZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CiAgICAgICAgaWYgKCBqUXVlcnkuY29udGFpbnMoIHRoaXMsIHRhcmdldHNbaV0gKSApIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSwKCiAgbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciwgZmFsc2UpICk7CiAgfSwKCiAgZmlsdGVyOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciwgdHJ1ZSkgKTsKICB9LAoKICBpczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewogICAgcmV0dXJuICEhc2VsZWN0b3IgJiYgKAogICAgICB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciID8KICAgICAgICAvLyBJZiB0aGlzIGlzIGEgcG9zaXRpb25hbC9yZWxhdGl2ZSBzZWxlY3RvciwgY2hlY2sgbWVtYmVyc2hpcCBpbiB0aGUgcmV0dXJuZWQgc2V0CiAgICAgICAgLy8gc28gJCgicDpmaXJzdCIpLmlzKCJwOmxhc3QiKSB3b24ndCByZXR1cm4gdHJ1ZSBmb3IgYSBkb2Mgd2l0aCB0d28gInAiLgogICAgICAgIHJuZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSA/CiAgICAgICAgICBqUXVlcnkoIHNlbGVjdG9yLCB0aGlzLmNvbnRleHQgKS5pbmRleCggdGhpc1swXSApID49IDAgOgogICAgICAgICAgalF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIHRoaXMgKS5sZW5ndGggPiAwIDoKICAgICAgICB0aGlzLmZpbHRlciggc2VsZWN0b3IgKS5sZW5ndGggPiAwICk7CiAgfSwKCiAgY2xvc2VzdDogZnVuY3Rpb24oIHNlbGVjdG9ycywgY29udGV4dCApIHsKICAgIHZhciBjdXIsCiAgICAgIGkgPSAwLAogICAgICBsID0gdGhpcy5sZW5ndGgsCiAgICAgIHJldCA9IFtdLAogICAgICBwb3MgPSBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9ycyApIHx8IHR5cGVvZiBzZWxlY3RvcnMgIT09ICJzdHJpbmciID8KICAgICAgICBqUXVlcnkoIHNlbGVjdG9ycywgY29udGV4dCB8fCB0aGlzLmNvbnRleHQgKSA6CiAgICAgICAgMDsKCiAgICBmb3IgKCA7IGkgPCBsOyBpKysgKSB7CiAgICAgIGN1ciA9IHRoaXNbaV07CgogICAgICB3aGlsZSAoIGN1ciAmJiBjdXIub3duZXJEb2N1bWVudCAmJiBjdXIgIT09IGNvbnRleHQgJiYgY3VyLm5vZGVUeXBlICE9PSAxMSApIHsKICAgICAgICBpZiAoIHBvcyA/IHBvcy5pbmRleChjdXIpID4gLTEgOiBqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoY3VyLCBzZWxlY3RvcnMpICkgewogICAgICAgICAgcmV0LnB1c2goIGN1ciApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGN1ciA9IGN1ci5wYXJlbnROb2RlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQubGVuZ3RoID4gMSA/IGpRdWVyeS51bmlxdWUoIHJldCApIDogcmV0ICk7CiAgfSwKCiAgLy8gRGV0ZXJtaW5lIHRoZSBwb3NpdGlvbiBvZiBhbiBlbGVtZW50IHdpdGhpbgogIC8vIHRoZSBtYXRjaGVkIHNldCBvZiBlbGVtZW50cwogIGluZGV4OiBmdW5jdGlvbiggZWxlbSApIHsKCiAgICAvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAogICAgaWYgKCAhZWxlbSApIHsKICAgICAgcmV0dXJuICggdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgKSA/IHRoaXMuZmlyc3QoKS5wcmV2QWxsKCkubGVuZ3RoIDogLTE7CiAgICB9CgogICAgLy8gaW5kZXggaW4gc2VsZWN0b3IKICAgIGlmICggdHlwZW9mIGVsZW0gPT09ICJzdHJpbmciICkgewogICAgICByZXR1cm4galF1ZXJ5LmluQXJyYXkoIHRoaXNbMF0sIGpRdWVyeSggZWxlbSApICk7CiAgICB9CgogICAgLy8gTG9jYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgZGVzaXJlZCBlbGVtZW50CiAgICByZXR1cm4galF1ZXJ5LmluQXJyYXkoCiAgICAgIC8vIElmIGl0IHJlY2VpdmVzIGEgalF1ZXJ5IG9iamVjdCwgdGhlIGZpcnN0IGVsZW1lbnQgaXMgdXNlZAogICAgICBlbGVtLmpxdWVyeSA/IGVsZW1bMF0gOiBlbGVtLCB0aGlzICk7CiAgfSwKCiAgYWRkOiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CiAgICB2YXIgc2V0ID0gdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiA/CiAgICAgICAgalF1ZXJ5KCBzZWxlY3RvciwgY29udGV4dCApIDoKICAgICAgICBqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciAmJiBzZWxlY3Rvci5ub2RlVHlwZSA/IFsgc2VsZWN0b3IgXSA6IHNlbGVjdG9yICksCiAgICAgIGFsbCA9IGpRdWVyeS5tZXJnZSggdGhpcy5nZXQoKSwgc2V0ICk7CgogICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkudW5pcXVlKGFsbCkgKTsKICB9LAoKICBhZGRCYWNrOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICByZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPwogICAgICB0aGlzLnByZXZPYmplY3QgOiB0aGlzLnByZXZPYmplY3QuZmlsdGVyKHNlbGVjdG9yKQogICAgKTsKICB9Cn0pOwoKalF1ZXJ5LmZuLmFuZFNlbGYgPSBqUXVlcnkuZm4uYWRkQmFjazsKCmZ1bmN0aW9uIHNpYmxpbmcoIGN1ciwgZGlyICkgewogIGRvIHsKICAgIGN1ciA9IGN1clsgZGlyIF07CiAgfSB3aGlsZSAoIGN1ciAmJiBjdXIubm9kZVR5cGUgIT09IDEgKTsKCiAgcmV0dXJuIGN1cjsKfQoKalF1ZXJ5LmVhY2goewogIHBhcmVudDogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwogICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKICB9LAogIHBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwYXJlbnROb2RlIiApOwogIH0sCiAgcGFyZW50c1VudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CiAgICByZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInBhcmVudE5vZGUiLCB1bnRpbCApOwogIH0sCiAgbmV4dDogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gc2libGluZyggZWxlbSwgIm5leHRTaWJsaW5nIiApOwogIH0sCiAgcHJldjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gc2libGluZyggZWxlbSwgInByZXZpb3VzU2libGluZyIgKTsKICB9LAogIG5leHRBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJuZXh0U2libGluZyIgKTsKICB9LAogIHByZXZBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7CiAgfSwKICBuZXh0VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKICAgIHJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAibmV4dFNpYmxpbmciLCB1bnRpbCApOwogIH0sCiAgcHJldlVudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CiAgICByZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIsIHVudGlsICk7CiAgfSwKICBzaWJsaW5nczogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4galF1ZXJ5LnNpYmxpbmcoICggZWxlbS5wYXJlbnROb2RlIHx8IHt9ICkuZmlyc3RDaGlsZCwgZWxlbSApOwogIH0sCiAgY2hpbGRyZW46IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGpRdWVyeS5zaWJsaW5nKCBlbGVtLmZpcnN0Q2hpbGQgKTsKICB9LAogIGNvbnRlbnRzOiBmdW5jdGlvbiggZWxlbSApIHsKICAgIHJldHVybiBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpZnJhbWUiICkgPwogICAgICBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgOgogICAgICBqUXVlcnkubWVyZ2UoIFtdLCBlbGVtLmNoaWxkTm9kZXMgKTsKICB9Cn0sIGZ1bmN0aW9uKCBuYW1lLCBmbiApIHsKICBqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCB1bnRpbCwgc2VsZWN0b3IgKSB7CiAgICB2YXIgcmV0ID0galF1ZXJ5Lm1hcCggdGhpcywgZm4sIHVudGlsICk7CgogICAgaWYgKCAhcnVudGlsLnRlc3QoIG5hbWUgKSApIHsKICAgICAgc2VsZWN0b3IgPSB1bnRpbDsKICAgIH0KCiAgICBpZiAoIHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CiAgICAgIHJldCA9IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCByZXQgKTsKICAgIH0KCiAgICByZXQgPSB0aGlzLmxlbmd0aCA+IDEgJiYgIWd1YXJhbnRlZWRVbmlxdWVbIG5hbWUgXSA/IGpRdWVyeS51bmlxdWUoIHJldCApIDogcmV0OwoKICAgIGlmICggdGhpcy5sZW5ndGggPiAxICYmIHJwYXJlbnRzcHJldi50ZXN0KCBuYW1lICkgKSB7CiAgICAgIHJldCA9IHJldC5yZXZlcnNlKCk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQgKTsKICB9Owp9KTsKCmpRdWVyeS5leHRlbmQoewogIGZpbHRlcjogZnVuY3Rpb24oIGV4cHIsIGVsZW1zLCBub3QgKSB7CiAgICBpZiAoIG5vdCApIHsKICAgICAgZXhwciA9ICI6bm90KCIgKyBleHByICsgIikiOwogICAgfQoKICAgIHJldHVybiBlbGVtcy5sZW5ndGggPT09IDEgPwogICAgICBqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoZWxlbXNbMF0sIGV4cHIpID8gWyBlbGVtc1swXSBdIDogW10gOgogICAgICBqUXVlcnkuZmluZC5tYXRjaGVzKGV4cHIsIGVsZW1zKTsKICB9LAoKICBkaXI6IGZ1bmN0aW9uKCBlbGVtLCBkaXIsIHVudGlsICkgewogICAgdmFyIG1hdGNoZWQgPSBbXSwKICAgICAgY3VyID0gZWxlbVsgZGlyIF07CgogICAgd2hpbGUgKCBjdXIgJiYgY3VyLm5vZGVUeXBlICE9PSA5ICYmICh1bnRpbCA9PT0gdW5kZWZpbmVkIHx8IGN1ci5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5KCBjdXIgKS5pcyggdW50aWwgKSkgKSB7CiAgICAgIGlmICggY3VyLm5vZGVUeXBlID09PSAxICkgewogICAgICAgIG1hdGNoZWQucHVzaCggY3VyICk7CiAgICAgIH0KICAgICAgY3VyID0gY3VyW2Rpcl07CiAgICB9CiAgICByZXR1cm4gbWF0Y2hlZDsKICB9LAoKICBzaWJsaW5nOiBmdW5jdGlvbiggbiwgZWxlbSApIHsKICAgIHZhciByID0gW107CgogICAgZm9yICggOyBuOyBuID0gbi5uZXh0U2libGluZyApIHsKICAgICAgaWYgKCBuLm5vZGVUeXBlID09PSAxICYmIG4gIT09IGVsZW0gKSB7CiAgICAgICAgci5wdXNoKCBuICk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcjsKICB9Cn0pOwoKLy8gSW1wbGVtZW50IHRoZSBpZGVudGljYWwgZnVuY3Rpb25hbGl0eSBmb3IgZmlsdGVyIGFuZCBub3QKZnVuY3Rpb24gd2lubm93KCBlbGVtZW50cywgcXVhbGlmaWVyLCBrZWVwICkgewoKICAvLyBDYW4ndCBwYXNzIG51bGwgb3IgdW5kZWZpbmVkIHRvIGluZGV4T2YgaW4gRmlyZWZveCA0CiAgLy8gU2V0IHRvIDAgdG8gc2tpcCBzdHJpbmcgY2hlY2sKICBxdWFsaWZpZXIgPSBxdWFsaWZpZXIgfHwgMDsKCiAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcXVhbGlmaWVyICkgKSB7CiAgICByZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewogICAgICB2YXIgcmV0VmFsID0gISFxdWFsaWZpZXIuY2FsbCggZWxlbSwgaSwgZWxlbSApOwogICAgICByZXR1cm4gcmV0VmFsID09PSBrZWVwOwogICAgfSk7CgogIH0gZWxzZSBpZiAoIHF1YWxpZmllci5ub2RlVHlwZSApIHsKICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIHJldHVybiAoIGVsZW0gPT09IHF1YWxpZmllciApID09PSBrZWVwOwogICAgfSk7CgogIH0gZWxzZSBpZiAoIHR5cGVvZiBxdWFsaWZpZXIgPT09ICJzdHJpbmciICkgewogICAgdmFyIGZpbHRlcmVkID0galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMTsKICAgIH0pOwoKICAgIGlmICggaXNTaW1wbGUudGVzdCggcXVhbGlmaWVyICkgKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZmlsdGVyKHF1YWxpZmllciwgZmlsdGVyZWQsICFrZWVwKTsKICAgIH0gZWxzZSB7CiAgICAgIHF1YWxpZmllciA9IGpRdWVyeS5maWx0ZXIoIHF1YWxpZmllciwgZmlsdGVyZWQgKTsKICAgIH0KICB9CgogIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gKCBqUXVlcnkuaW5BcnJheSggZWxlbSwgcXVhbGlmaWVyICkgPj0gMCApID09PSBrZWVwOwogIH0pOwp9CmZ1bmN0aW9uIGNyZWF0ZVNhZmVGcmFnbWVudCggZG9jdW1lbnQgKSB7CiAgdmFyIGxpc3QgPSBub2RlTmFtZXMuc3BsaXQoICJ8IiApLAogICAgc2FmZUZyYWcgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgogIGlmICggc2FmZUZyYWcuY3JlYXRlRWxlbWVudCApIHsKICAgIHdoaWxlICggbGlzdC5sZW5ndGggKSB7CiAgICAgIHNhZmVGcmFnLmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgbGlzdC5wb3AoKQogICAgICApOwogICAgfQogIH0KICByZXR1cm4gc2FmZUZyYWc7Cn0KCnZhciBub2RlTmFtZXMgPSAiYWJicnxhcnRpY2xlfGFzaWRlfGF1ZGlvfGJkaXxjYW52YXN8ZGF0YXxkYXRhbGlzdHxkZXRhaWxzfGZpZ2NhcHRpb258ZmlndXJlfGZvb3RlcnwiICsKICAgICJoZWFkZXJ8aGdyb3VwfG1hcmt8bWV0ZXJ8bmF2fG91dHB1dHxwcm9ncmVzc3xzZWN0aW9ufHN1bW1hcnl8dGltZXx2aWRlbyIsCiAgcmlubGluZWpRdWVyeSA9IC8galF1ZXJ5XGQrPSIoPzpudWxsfFxkKykiL2csCiAgcm5vc2hpbWNhY2hlID0gbmV3IFJlZ0V4cCgiPCg/OiIgKyBub2RlTmFtZXMgKyAiKVtcXHMvPl0iLCAiaSIpLAogIHJsZWFkaW5nV2hpdGVzcGFjZSA9IC9eXHMrLywKICByeGh0bWxUYWcgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbXHc6XSspW14+XSopXC8+L2dpLAogIHJ0YWdOYW1lID0gLzwoW1x3Ol0rKS8sCiAgcnRib2R5ID0gLzx0Ym9keS9pLAogIHJodG1sID0gLzx8JiM/XHcrOy8sCiAgcm5vSW5uZXJodG1sID0gLzwoPzpzY3JpcHR8c3R5bGV8bGluaykvaSwKICBtYW5pcHVsYXRpb25fcmNoZWNrYWJsZVR5cGUgPSAvXig/OmNoZWNrYm94fHJhZGlvKSQvaSwKICAvLyBjaGVja2VkPSJjaGVja2VkIiBvciBjaGVja2VkCiAgcmNoZWNrZWQgPSAvY2hlY2tlZFxzKig/OltePV18PVxzKi5jaGVja2VkLikvaSwKICByc2NyaXB0VHlwZSA9IC9eJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaSwKICByc2NyaXB0VHlwZU1hc2tlZCA9IC9edHJ1ZVwvKC4qKS8sCiAgcmNsZWFuU2NyaXB0ID0gL15ccyo8ISg/OlxbQ0RBVEFcW3wtLSl8KD86XF1cXXwtLSk+XHMqJC9nLAoKICAvLyBXZSBoYXZlIHRvIGNsb3NlIHRoZXNlIHRhZ3MgdG8gc3VwcG9ydCBYSFRNTCAoIzEzMjAwKQogIHdyYXBNYXAgPSB7CiAgICBvcHRpb246IFsgMSwgIjxzZWxlY3QgbXVsdGlwbGU9J211bHRpcGxlJz4iLCAiPC9zZWxlY3Q+IiBdLAogICAgbGVnZW5kOiBbIDEsICI8ZmllbGRzZXQ+IiwgIjwvZmllbGRzZXQ+IiBdLAogICAgYXJlYTogWyAxLCAiPG1hcD4iLCAiPC9tYXA+IiBdLAogICAgcGFyYW06IFsgMSwgIjxvYmplY3Q+IiwgIjwvb2JqZWN0PiIgXSwKICAgIHRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLAogICAgdHI6IFsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0sCiAgICBjb2w6IFsgMiwgIjx0YWJsZT48dGJvZHk+PC90Ym9keT48Y29sZ3JvdXA+IiwgIjwvY29sZ3JvdXA+PC90YWJsZT4iIF0sCiAgICB0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwKCiAgICAvLyBJRTYtOCBjYW4ndCBzZXJpYWxpemUgbGluaywgc2NyaXB0LCBzdHlsZSwgb3IgYW55IGh0bWw1IChOb1Njb3BlKSB0YWdzLAogICAgLy8gdW5sZXNzIHdyYXBwZWQgaW4gYSBkaXYgd2l0aCBub24tYnJlYWtpbmcgY2hhcmFjdGVycyBpbiBmcm9udCBvZiBpdC4KICAgIF9kZWZhdWx0OiBqUXVlcnkuc3VwcG9ydC5odG1sU2VyaWFsaXplID8gWyAwLCAiIiwgIiIgXSA6IFsgMSwgIlg8ZGl2PiIsICI8L2Rpdj4iICBdCiAgfSwKICBzYWZlRnJhZ21lbnQgPSBjcmVhdGVTYWZlRnJhZ21lbnQoIGRvY3VtZW50ICksCiAgZnJhZ21lbnREaXYgPSBzYWZlRnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpICk7Cgp3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247CndyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CndyYXBNYXAudGggPSB3cmFwTWFwLnRkOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CiAgdGV4dDogZnVuY3Rpb24oIHZhbHVlICkgewogICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwogICAgICAgIGpRdWVyeS50ZXh0KCB0aGlzICkgOgogICAgICAgIHRoaXMuZW1wdHkoKS5hcHBlbmQoICggdGhpc1swXSAmJiB0aGlzWzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQgKS5jcmVhdGVUZXh0Tm9kZSggdmFsdWUgKSApOwogICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggKTsKICB9LAoKICB3cmFwQWxsOiBmdW5jdGlvbiggaHRtbCApIHsKICAgIGlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKSApIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CiAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBBbGwoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwogICAgICB9KTsKICAgIH0KCiAgICBpZiAoIHRoaXNbMF0gKSB7CiAgICAgIC8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kCiAgICAgIHZhciB3cmFwID0galF1ZXJ5KCBodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQgKS5lcSgwKS5jbG9uZSh0cnVlKTsKCiAgICAgIGlmICggdGhpc1swXS5wYXJlbnROb2RlICkgewogICAgICAgIHdyYXAuaW5zZXJ0QmVmb3JlKCB0aGlzWzBdICk7CiAgICAgIH0KCiAgICAgIHdyYXAubWFwKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBlbGVtID0gdGhpczsKCiAgICAgICAgd2hpbGUgKCBlbGVtLmZpcnN0Q2hpbGQgJiYgZWxlbS5maXJzdENoaWxkLm5vZGVUeXBlID09PSAxICkgewogICAgICAgICAgZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbGVtOwogICAgICB9KS5hcHBlbmQoIHRoaXMgKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9LAoKICB3cmFwSW5uZXI6IGZ1bmN0aW9uKCBodG1sICkgewogICAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApICkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKICAgICAgICBqUXVlcnkodGhpcykud3JhcElubmVyKCBodG1sLmNhbGwodGhpcywgaSkgKTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSBqUXVlcnkoIHRoaXMgKSwKICAgICAgICBjb250ZW50cyA9IHNlbGYuY29udGVudHMoKTsKCiAgICAgIGlmICggY29udGVudHMubGVuZ3RoICkgewogICAgICAgIGNvbnRlbnRzLndyYXBBbGwoIGh0bWwgKTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZi5hcHBlbmQoIGh0bWwgKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgd3JhcDogZnVuY3Rpb24oIGh0bWwgKSB7CiAgICB2YXIgaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICk7CgogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CiAgICAgIGpRdWVyeSggdGhpcyApLndyYXBBbGwoIGlzRnVuY3Rpb24gPyBodG1sLmNhbGwodGhpcywgaSkgOiBodG1sICk7CiAgICB9KTsKICB9LAoKICB1bndyYXA6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbigpIHsKICAgICAgaWYgKCAhalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzLCAiYm9keSIgKSApIHsKICAgICAgICBqUXVlcnkoIHRoaXMgKS5yZXBsYWNlV2l0aCggdGhpcy5jaGlsZE5vZGVzICk7CiAgICAgIH0KICAgIH0pLmVuZCgpOwogIH0sCgogIGFwcGVuZDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIHRydWUsIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICBpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsKICAgICAgICB0aGlzLmFwcGVuZENoaWxkKCBlbGVtICk7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIHByZXBlbmQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCB0cnVlLCBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7CiAgICAgICAgdGhpcy5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMuZmlyc3RDaGlsZCApOwogICAgICB9CiAgICB9KTsKICB9LAoKICBiZWZvcmU6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoIGFyZ3VtZW50cywgZmFsc2UsIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICBpZiAoIHRoaXMucGFyZW50Tm9kZSApIHsKICAgICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzICk7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIGFmdGVyOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmRvbU1hbmlwKCBhcmd1bWVudHMsIGZhbHNlLCBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7CiAgICAgICAgdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5uZXh0U2libGluZyApOwogICAgICB9CiAgICB9KTsKICB9LAoKICAvLyBrZWVwRGF0YSBpcyBmb3IgaW50ZXJuYWwgdXNlIG9ubHktLWRvIG5vdCBkb2N1bWVudAogIHJlbW92ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCBrZWVwRGF0YSApIHsKICAgIHZhciBlbGVtLAogICAgICBpID0gMDsKCiAgICBmb3IgKCA7IChlbGVtID0gdGhpc1tpXSkgIT0gbnVsbDsgaSsrICkgewogICAgICBpZiAoICFzZWxlY3RvciB8fCBqUXVlcnkuZmlsdGVyKCBzZWxlY3RvciwgWyBlbGVtIF0gKS5sZW5ndGggPiAwICkgewogICAgICAgIGlmICggIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CiAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0gKSApOwogICAgICAgIH0KCiAgICAgICAgaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CiAgICAgICAgICBpZiAoIGtlZXBEYXRhICYmIGpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICkgKSB7CiAgICAgICAgICAgIHNldEdsb2JhbEV2YWwoIGdldEFsbCggZWxlbSwgInNjcmlwdCIgKSApOwogICAgICAgICAgfQogICAgICAgICAgZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBlbGVtICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgZW1wdHk6IGZ1bmN0aW9uKCkgewogICAgdmFyIGVsZW0sCiAgICAgIGkgPSAwOwoKICAgIGZvciAoIDsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKysgKSB7CiAgICAgIC8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwogICAgICBpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CiAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBhbnkgcmVtYWluaW5nIG5vZGVzCiAgICAgIHdoaWxlICggZWxlbS5maXJzdENoaWxkICkgewogICAgICAgIGVsZW0ucmVtb3ZlQ2hpbGQoIGVsZW0uZmlyc3RDaGlsZCApOwogICAgICB9CgogICAgICAvLyBJZiB0aGlzIGlzIGEgc2VsZWN0LCBlbnN1cmUgdGhhdCBpdCBkaXNwbGF5cyBlbXB0eSAoIzEyMzM2KQogICAgICAvLyBTdXBwb3J0OiBJRTw5CiAgICAgIGlmICggZWxlbS5vcHRpb25zICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgInNlbGVjdCIgKSApIHsKICAgICAgICBlbGVtLm9wdGlvbnMubGVuZ3RoID0gMDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIGNsb25lOiBmdW5jdGlvbiggZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CiAgICBkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOwogICAgZGVlcERhdGFBbmRFdmVudHMgPSBkZWVwRGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZGF0YUFuZEV2ZW50cyA6IGRlZXBEYXRhQW5kRXZlbnRzOwoKICAgIHJldHVybiB0aGlzLm1hcCggZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4galF1ZXJ5LmNsb25lKCB0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApOwogICAgfSk7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24oIHZhbHVlICkgewogICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgICAgdmFyIGVsZW0gPSB0aGlzWzBdIHx8IHt9LAogICAgICAgIGkgPSAwLAogICAgICAgIGwgPSB0aGlzLmxlbmd0aDsKCiAgICAgIGlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKICAgICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMSA/CiAgICAgICAgICBlbGVtLmlubmVySFRNTC5yZXBsYWNlKCByaW5saW5lalF1ZXJ5LCAiIiApIDoKICAgICAgICAgIHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgLy8gU2VlIGlmIHdlIGNhbiB0YWtlIGEgc2hvcnRjdXQgYW5kIGp1c3QgdXNlIGlubmVySFRNTAogICAgICBpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgIXJub0lubmVyaHRtbC50ZXN0KCB2YWx1ZSApICYmCiAgICAgICAgKCBqUXVlcnkuc3VwcG9ydC5odG1sU2VyaWFsaXplIHx8ICFybm9zaGltY2FjaGUudGVzdCggdmFsdWUgKSAgKSAmJgogICAgICAgICggalF1ZXJ5LnN1cHBvcnQubGVhZGluZ1doaXRlc3BhY2UgfHwgIXJsZWFkaW5nV2hpdGVzcGFjZS50ZXN0KCB2YWx1ZSApICkgJiYKICAgICAgICAhd3JhcE1hcFsgKCBydGFnTmFtZS5leGVjKCB2YWx1ZSApIHx8IFsiIiwgIiJdIClbMV0udG9Mb3dlckNhc2UoKSBdICkgewoKICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoIHJ4aHRtbFRhZywgIjwkMT48LyQyPiIgKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSsrICkgewogICAgICAgICAgICAvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKICAgICAgICAgICAgZWxlbSA9IHRoaXNbaV0gfHwge307CiAgICAgICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKICAgICAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0sIGZhbHNlICkgKTsKICAgICAgICAgICAgICBlbGVtLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZWxlbSA9IDA7CgogICAgICAgIC8vIElmIHVzaW5nIGlubmVySFRNTCB0aHJvd3MgYW4gZXhjZXB0aW9uLCB1c2UgdGhlIGZhbGxiYWNrIG1ldGhvZAogICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgfQoKICAgICAgaWYgKCBlbGVtICkgewogICAgICAgIHRoaXMuZW1wdHkoKS5hcHBlbmQoIHZhbHVlICk7CiAgICAgIH0KICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7CiAgfSwKCiAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgIHZhciBpc0Z1bmMgPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKTsKCiAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgZWxlbWVudHMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NIGJlZm9yZSB0aGV5IGFyZSBpbnNlcnRlZAogICAgLy8gdGhpcyBjYW4gaGVscCBmaXggcmVwbGFjaW5nIGEgcGFyZW50IHdpdGggY2hpbGQgZWxlbWVudHMKICAgIGlmICggIWlzRnVuYyAmJiB0eXBlb2YgdmFsdWUgIT09ICJzdHJpbmciICkgewogICAgICB2YWx1ZSA9IGpRdWVyeSggdmFsdWUgKS5ub3QoIHRoaXMgKS5kZXRhY2goKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5kb21NYW5pcCggWyB2YWx1ZSBdLCB0cnVlLCBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgdmFyIG5leHQgPSB0aGlzLm5leHRTaWJsaW5nLAogICAgICAgIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKCiAgICAgIGlmICggcGFyZW50ICYmIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgKSB7CgogICAgICAgIGpRdWVyeSggdGhpcyApLnJlbW92ZSgpOwoKICAgICAgICBpZiAoIG5leHQgKSB7CiAgICAgICAgICBuZXh0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCBuZXh0ICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBhcmVudC5hcHBlbmRDaGlsZCggZWxlbSApOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSwKCiAgZGV0YWNoOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICByZXR1cm4gdGhpcy5yZW1vdmUoIHNlbGVjdG9yLCB0cnVlICk7CiAgfSwKCiAgZG9tTWFuaXA6IGZ1bmN0aW9uKCBhcmdzLCB0YWJsZSwgY2FsbGJhY2sgKSB7CgogICAgLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwogICAgYXJncyA9IGNvcmVfY29uY2F0LmFwcGx5KCBbXSwgYXJncyApOwoKICAgIHZhciBmcmFnbWVudCwgZmlyc3QsIHNjcmlwdHMsIGhhc1NjcmlwdHMsIG5vZGUsIGRvYywKICAgICAgaSA9IDAsCiAgICAgIGwgPSB0aGlzLmxlbmd0aCwKICAgICAgc2V0ID0gdGhpcywKICAgICAgaU5vQ2xvbmUgPSBsIC0gMSwKICAgICAgdmFsdWUgPSBhcmdzWzBdLAogICAgICBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgogICAgLy8gV2UgY2FuJ3QgY2xvbmVOb2RlIGZyYWdtZW50cyB0aGF0IGNvbnRhaW4gY2hlY2tlZCwgaW4gV2ViS2l0CiAgICBpZiAoIGlzRnVuY3Rpb24gfHwgISggbCA8PSAxIHx8IHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIgfHwgalF1ZXJ5LnN1cHBvcnQuY2hlY2tDbG9uZSB8fCAhcmNoZWNrZWQudGVzdCggdmFsdWUgKSApICkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpbmRleCApIHsKICAgICAgICB2YXIgc2VsZiA9IHNldC5lcSggaW5kZXggKTsKICAgICAgICBpZiAoIGlzRnVuY3Rpb24gKSB7CiAgICAgICAgICBhcmdzWzBdID0gdmFsdWUuY2FsbCggdGhpcywgaW5kZXgsIHRhYmxlID8gc2VsZi5odG1sKCkgOiB1bmRlZmluZWQgKTsKICAgICAgICB9CiAgICAgICAgc2VsZi5kb21NYW5pcCggYXJncywgdGFibGUsIGNhbGxiYWNrICk7CiAgICAgIH0pOwogICAgfQoKICAgIGlmICggbCApIHsKICAgICAgZnJhZ21lbnQgPSBqUXVlcnkuYnVpbGRGcmFnbWVudCggYXJncywgdGhpc1sgMCBdLm93bmVyRG9jdW1lbnQsIGZhbHNlLCB0aGlzICk7CiAgICAgIGZpcnN0ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCiAgICAgIGlmICggZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgKSB7CiAgICAgICAgZnJhZ21lbnQgPSBmaXJzdDsKICAgICAgfQoKICAgICAgaWYgKCBmaXJzdCApIHsKICAgICAgICB0YWJsZSA9IHRhYmxlICYmIGpRdWVyeS5ub2RlTmFtZSggZmlyc3QsICJ0ciIgKTsKICAgICAgICBzY3JpcHRzID0galF1ZXJ5Lm1hcCggZ2V0QWxsKCBmcmFnbWVudCwgInNjcmlwdCIgKSwgZGlzYWJsZVNjcmlwdCApOwogICAgICAgIGhhc1NjcmlwdHMgPSBzY3JpcHRzLmxlbmd0aDsKCiAgICAgICAgLy8gVXNlIHRoZSBvcmlnaW5hbCBmcmFnbWVudCBmb3IgdGhlIGxhc3QgaXRlbSBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBiZWNhdXNlIGl0IGNhbiBlbmQgdXAKICAgICAgICAvLyBiZWluZyBlbXB0aWVkIGluY29ycmVjdGx5IGluIGNlcnRhaW4gc2l0dWF0aW9ucyAoIzgwNzApLgogICAgICAgIGZvciAoIDsgaSA8IGw7IGkrKyApIHsKICAgICAgICAgIG5vZGUgPSBmcmFnbWVudDsKCiAgICAgICAgICBpZiAoIGkgIT09IGlOb0Nsb25lICkgewogICAgICAgICAgICBub2RlID0galF1ZXJ5LmNsb25lKCBub2RlLCB0cnVlLCB0cnVlICk7CgogICAgICAgICAgICAvLyBLZWVwIHJlZmVyZW5jZXMgdG8gY2xvbmVkIHNjcmlwdHMgZm9yIGxhdGVyIHJlc3RvcmF0aW9uCiAgICAgICAgICAgIGlmICggaGFzU2NyaXB0cyApIHsKICAgICAgICAgICAgICBqUXVlcnkubWVyZ2UoIHNjcmlwdHMsIGdldEFsbCggbm9kZSwgInNjcmlwdCIgKSApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgY2FsbGJhY2suY2FsbCgKICAgICAgICAgICAgdGFibGUgJiYgalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzW2ldLCAidGFibGUiICkgPwogICAgICAgICAgICAgIGZpbmRPckFwcGVuZCggdGhpc1tpXSwgInRib2R5IiApIDoKICAgICAgICAgICAgICB0aGlzW2ldLAogICAgICAgICAgICBub2RlLAogICAgICAgICAgICBpCiAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgaWYgKCBoYXNTY3JpcHRzICkgewogICAgICAgICAgZG9jID0gc2NyaXB0c1sgc2NyaXB0cy5sZW5ndGggLSAxIF0ub3duZXJEb2N1bWVudDsKCiAgICAgICAgICAvLyBSZWVuYWJsZSBzY3JpcHRzCiAgICAgICAgICBqUXVlcnkubWFwKCBzY3JpcHRzLCByZXN0b3JlU2NyaXB0ICk7CgogICAgICAgICAgLy8gRXZhbHVhdGUgZXhlY3V0YWJsZSBzY3JpcHRzIG9uIGZpcnN0IGRvY3VtZW50IGluc2VydGlvbgogICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBoYXNTY3JpcHRzOyBpKysgKSB7CiAgICAgICAgICAgIG5vZGUgPSBzY3JpcHRzWyBpIF07CiAgICAgICAgICAgIGlmICggcnNjcmlwdFR5cGUudGVzdCggbm9kZS50eXBlIHx8ICIiICkgJiYKICAgICAgICAgICAgICAhalF1ZXJ5Ll9kYXRhKCBub2RlLCAiZ2xvYmFsRXZhbCIgKSAmJiBqUXVlcnkuY29udGFpbnMoIGRvYywgbm9kZSApICkgewoKICAgICAgICAgICAgICBpZiAoIG5vZGUuc3JjICkgewogICAgICAgICAgICAgICAgLy8gSG9wZSBhamF4IGlzIGF2YWlsYWJsZS4uLgogICAgICAgICAgICAgICAgalF1ZXJ5LmFqYXgoewogICAgICAgICAgICAgICAgICB1cmw6IG5vZGUuc3JjLAogICAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJzY3JpcHQiLAogICAgICAgICAgICAgICAgICBhc3luYzogZmFsc2UsCiAgICAgICAgICAgICAgICAgIGdsb2JhbDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICJ0aHJvd3MiOiB0cnVlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwoICggbm9kZS50ZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgbm9kZS5pbm5lckhUTUwgfHwgIiIgKS5yZXBsYWNlKCByY2xlYW5TY3JpcHQsICIiICkgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZpeCAjMTE4MDk6IEF2b2lkIGxlYWtpbmcgbWVtb3J5CiAgICAgICAgZnJhZ21lbnQgPSBmaXJzdCA9IG51bGw7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9Cn0pOwoKZnVuY3Rpb24gZmluZE9yQXBwZW5kKCBlbGVtLCB0YWcgKSB7CiAgcmV0dXJuIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApWzBdIHx8IGVsZW0uYXBwZW5kQ2hpbGQoIGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCB0YWcgKSApOwp9CgovLyBSZXBsYWNlL3Jlc3RvcmUgdGhlIHR5cGUgYXR0cmlidXRlIG9mIHNjcmlwdCBlbGVtZW50cyBmb3Igc2FmZSBET00gbWFuaXB1bGF0aW9uCmZ1bmN0aW9uIGRpc2FibGVTY3JpcHQoIGVsZW0gKSB7CiAgdmFyIGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoInR5cGUiKTsKICBlbGVtLnR5cGUgPSAoIGF0dHIgJiYgYXR0ci5zcGVjaWZpZWQgKSArICIvIiArIGVsZW0udHlwZTsKICByZXR1cm4gZWxlbTsKfQpmdW5jdGlvbiByZXN0b3JlU2NyaXB0KCBlbGVtICkgewogIHZhciBtYXRjaCA9IHJzY3JpcHRUeXBlTWFza2VkLmV4ZWMoIGVsZW0udHlwZSApOwogIGlmICggbWF0Y2ggKSB7CiAgICBlbGVtLnR5cGUgPSBtYXRjaFsxXTsKICB9IGVsc2UgewogICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoInR5cGUiKTsKICB9CiAgcmV0dXJuIGVsZW07Cn0KCi8vIE1hcmsgc2NyaXB0cyBhcyBoYXZpbmcgYWxyZWFkeSBiZWVuIGV2YWx1YXRlZApmdW5jdGlvbiBzZXRHbG9iYWxFdmFsKCBlbGVtcywgcmVmRWxlbWVudHMgKSB7CiAgdmFyIGVsZW0sCiAgICBpID0gMDsKICBmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKICAgIGpRdWVyeS5fZGF0YSggZWxlbSwgImdsb2JhbEV2YWwiLCAhcmVmRWxlbWVudHMgfHwgalF1ZXJ5Ll9kYXRhKCByZWZFbGVtZW50c1tpXSwgImdsb2JhbEV2YWwiICkgKTsKICB9Cn0KCmZ1bmN0aW9uIGNsb25lQ29weUV2ZW50KCBzcmMsIGRlc3QgKSB7CgogIGlmICggZGVzdC5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5Lmhhc0RhdGEoIHNyYyApICkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHR5cGUsIGksIGwsCiAgICBvbGREYXRhID0galF1ZXJ5Ll9kYXRhKCBzcmMgKSwKICAgIGN1ckRhdGEgPSBqUXVlcnkuX2RhdGEoIGRlc3QsIG9sZERhdGEgKSwKICAgIGV2ZW50cyA9IG9sZERhdGEuZXZlbnRzOwoKICBpZiAoIGV2ZW50cyApIHsKICAgIGRlbGV0ZSBjdXJEYXRhLmhhbmRsZTsKICAgIGN1ckRhdGEuZXZlbnRzID0ge307CgogICAgZm9yICggdHlwZSBpbiBldmVudHMgKSB7CiAgICAgIGZvciAoIGkgPSAwLCBsID0gZXZlbnRzWyB0eXBlIF0ubGVuZ3RoOyBpIDwgbDsgaSsrICkgewogICAgICAgIGpRdWVyeS5ldmVudC5hZGQoIGRlc3QsIHR5cGUsIGV2ZW50c1sgdHlwZSBdWyBpIF0gKTsKICAgICAgfQogICAgfQogIH0KCiAgLy8gbWFrZSB0aGUgY2xvbmVkIHB1YmxpYyBkYXRhIG9iamVjdCBhIGNvcHkgZnJvbSB0aGUgb3JpZ2luYWwKICBpZiAoIGN1ckRhdGEuZGF0YSApIHsKICAgIGN1ckRhdGEuZGF0YSA9IGpRdWVyeS5leHRlbmQoIHt9LCBjdXJEYXRhLmRhdGEgKTsKICB9Cn0KCmZ1bmN0aW9uIGZpeENsb25lTm9kZUlzc3Vlcyggc3JjLCBkZXN0ICkgewogIHZhciBub2RlTmFtZSwgZGF0YSwgZTsKCiAgLy8gV2UgZG8gbm90IG5lZWQgdG8gZG8gYW55dGhpbmcgZm9yIG5vbi1FbGVtZW50cwogIGlmICggZGVzdC5ub2RlVHlwZSAhPT0gMSApIHsKICAgIHJldHVybjsKICB9CgogIG5vZGVOYW1lID0gZGVzdC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoKICAvLyBJRTYtOCBjb3BpZXMgZXZlbnRzIGJvdW5kIHZpYSBhdHRhY2hFdmVudCB3aGVuIHVzaW5nIGNsb25lTm9kZS4KICBpZiAoICFqUXVlcnkuc3VwcG9ydC5ub0Nsb25lRXZlbnQgJiYgZGVzdFsgalF1ZXJ5LmV4cGFuZG8gXSApIHsKICAgIGRhdGEgPSBqUXVlcnkuX2RhdGEoIGRlc3QgKTsKCiAgICBmb3IgKCBlIGluIGRhdGEuZXZlbnRzICkgewogICAgICBqUXVlcnkucmVtb3ZlRXZlbnQoIGRlc3QsIGUsIGRhdGEuaGFuZGxlICk7CiAgICB9CgogICAgLy8gRXZlbnQgZGF0YSBnZXRzIHJlZmVyZW5jZWQgaW5zdGVhZCBvZiBjb3BpZWQgaWYgdGhlIGV4cGFuZG8gZ2V0cyBjb3BpZWQgdG9vCiAgICBkZXN0LnJlbW92ZUF0dHJpYnV0ZSggalF1ZXJ5LmV4cGFuZG8gKTsKICB9CgogIC8vIElFIGJsYW5rcyBjb250ZW50cyB3aGVuIGNsb25pbmcgc2NyaXB0cywgYW5kIHRyaWVzIHRvIGV2YWx1YXRlIG5ld2x5LXNldCB0ZXh0CiAgaWYgKCBub2RlTmFtZSA9PT0gInNjcmlwdCIgJiYgZGVzdC50ZXh0ICE9PSBzcmMudGV4dCApIHsKICAgIGRpc2FibGVTY3JpcHQoIGRlc3QgKS50ZXh0ID0gc3JjLnRleHQ7CiAgICByZXN0b3JlU2NyaXB0KCBkZXN0ICk7CgogIC8vIElFNi0xMCBpbXByb3Blcmx5IGNsb25lcyBjaGlsZHJlbiBvZiBvYmplY3QgZWxlbWVudHMgdXNpbmcgY2xhc3NpZC4KICAvLyBJRTEwIHRocm93cyBOb01vZGlmaWNhdGlvbkFsbG93ZWRFcnJvciBpZiBwYXJlbnQgaXMgbnVsbCwgIzEyMTMyLgogIH0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAib2JqZWN0IiApIHsKICAgIGlmICggZGVzdC5wYXJlbnROb2RlICkgewogICAgICBkZXN0Lm91dGVySFRNTCA9IHNyYy5vdXRlckhUTUw7CiAgICB9CgogICAgLy8gVGhpcyBwYXRoIGFwcGVhcnMgdW5hdm9pZGFibGUgZm9yIElFOS4gV2hlbiBjbG9uaW5nIGFuIG9iamVjdAogICAgLy8gZWxlbWVudCBpbiBJRTksIHRoZSBvdXRlckhUTUwgc3RyYXRlZ3kgYWJvdmUgaXMgbm90IHN1ZmZpY2llbnQuCiAgICAvLyBJZiB0aGUgc3JjIGhhcyBpbm5lckhUTUwgYW5kIHRoZSBkZXN0aW5hdGlvbiBkb2VzIG5vdCwKICAgIC8vIGNvcHkgdGhlIHNyYy5pbm5lckhUTUwgaW50byB0aGUgZGVzdC5pbm5lckhUTUwuICMxMDMyNAogICAgaWYgKCBqUXVlcnkuc3VwcG9ydC5odG1sNUNsb25lICYmICggc3JjLmlubmVySFRNTCAmJiAhalF1ZXJ5LnRyaW0oZGVzdC5pbm5lckhUTUwpICkgKSB7CiAgICAgIGRlc3QuaW5uZXJIVE1MID0gc3JjLmlubmVySFRNTDsKICAgIH0KCiAgfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgbWFuaXB1bGF0aW9uX3JjaGVja2FibGVUeXBlLnRlc3QoIHNyYy50eXBlICkgKSB7CiAgICAvLyBJRTYtOCBmYWlscyB0byBwZXJzaXN0IHRoZSBjaGVja2VkIHN0YXRlIG9mIGEgY2xvbmVkIGNoZWNrYm94CiAgICAvLyBvciByYWRpbyBidXR0b24uIFdvcnNlLCBJRTYtNyBmYWlsIHRvIGdpdmUgdGhlIGNsb25lZCBlbGVtZW50CiAgICAvLyBhIGNoZWNrZWQgYXBwZWFyYW5jZSBpZiB0aGUgZGVmYXVsdENoZWNrZWQgdmFsdWUgaXNuJ3QgYWxzbyBzZXQKCiAgICBkZXN0LmRlZmF1bHRDaGVja2VkID0gZGVzdC5jaGVja2VkID0gc3JjLmNoZWNrZWQ7CgogICAgLy8gSUU2LTcgZ2V0IGNvbmZ1c2VkIGFuZCBlbmQgdXAgc2V0dGluZyB0aGUgdmFsdWUgb2YgYSBjbG9uZWQKICAgIC8vIGNoZWNrYm94L3JhZGlvIGJ1dHRvbiB0byBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiAib24iCiAgICBpZiAoIGRlc3QudmFsdWUgIT09IHNyYy52YWx1ZSApIHsKICAgICAgZGVzdC52YWx1ZSA9IHNyYy52YWx1ZTsKICAgIH0KCiAgLy8gSUU2LTggZmFpbHMgdG8gcmV0dXJuIHRoZSBzZWxlY3RlZCBvcHRpb24gdG8gdGhlIGRlZmF1bHQgc2VsZWN0ZWQKICAvLyBzdGF0ZSB3aGVuIGNsb25pbmcgb3B0aW9ucwogIH0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAib3B0aW9uIiApIHsKICAgIGRlc3QuZGVmYXVsdFNlbGVjdGVkID0gZGVzdC5zZWxlY3RlZCA9IHNyYy5kZWZhdWx0U2VsZWN0ZWQ7CgogIC8vIElFNi04IGZhaWxzIHRvIHNldCB0aGUgZGVmYXVsdFZhbHVlIHRvIHRoZSBjb3JyZWN0IHZhbHVlIHdoZW4KICAvLyBjbG9uaW5nIG90aGVyIHR5cGVzIG9mIGlucHV0IGZpZWxkcwogIH0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiIHx8IG5vZGVOYW1lID09PSAidGV4dGFyZWEiICkgewogICAgZGVzdC5kZWZhdWx0VmFsdWUgPSBzcmMuZGVmYXVsdFZhbHVlOwogIH0KfQoKalF1ZXJ5LmVhY2goewogIGFwcGVuZFRvOiAiYXBwZW5kIiwKICBwcmVwZW5kVG86ICJwcmVwZW5kIiwKICBpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAogIGluc2VydEFmdGVyOiAiYWZ0ZXIiLAogIHJlcGxhY2VBbGw6ICJyZXBsYWNlV2l0aCIKfSwgZnVuY3Rpb24oIG5hbWUsIG9yaWdpbmFsICkgewogIGpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewogICAgdmFyIGVsZW1zLAogICAgICBpID0gMCwKICAgICAgcmV0ID0gW10sCiAgICAgIGluc2VydCA9IGpRdWVyeSggc2VsZWN0b3IgKSwKICAgICAgbGFzdCA9IGluc2VydC5sZW5ndGggLSAxOwoKICAgIGZvciAoIDsgaSA8PSBsYXN0OyBpKysgKSB7CiAgICAgIGVsZW1zID0gaSA9PT0gbGFzdCA/IHRoaXMgOiB0aGlzLmNsb25lKHRydWUpOwogICAgICBqUXVlcnkoIGluc2VydFtpXSApWyBvcmlnaW5hbCBdKCBlbGVtcyApOwoKICAgICAgLy8gTW9kZXJuIGJyb3dzZXJzIGNhbiBhcHBseSBqUXVlcnkgY29sbGVjdGlvbnMgYXMgYXJyYXlzLCBidXQgb2xkSUUgbmVlZHMgYSAuZ2V0KCkKICAgICAgY29yZV9wdXNoLmFwcGx5KCByZXQsIGVsZW1zLmdldCgpICk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQgKTsKICB9Owp9KTsKCmZ1bmN0aW9uIGdldEFsbCggY29udGV4dCwgdGFnICkgewogIHZhciBlbGVtcywgZWxlbSwKICAgIGkgPSAwLAogICAgZm91bmQgPSB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgPyBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgfHwgIioiICkgOgogICAgICB0eXBlb2YgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsICE9PSAidW5kZWZpbmVkIiA/IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggdGFnIHx8ICIqIiApIDoKICAgICAgdW5kZWZpbmVkOwoKICBpZiAoICFmb3VuZCApIHsKICAgIGZvciAoIGZvdW5kID0gW10sIGVsZW1zID0gY29udGV4dC5jaGlsZE5vZGVzIHx8IGNvbnRleHQ7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKICAgICAgaWYgKCAhdGFnIHx8IGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgdGFnICkgKSB7CiAgICAgICAgZm91bmQucHVzaCggZWxlbSApOwogICAgICB9IGVsc2UgewogICAgICAgIGpRdWVyeS5tZXJnZSggZm91bmQsIGdldEFsbCggZWxlbSwgdGFnICkgKTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHRhZyA9PT0gdW5kZWZpbmVkIHx8IHRhZyAmJiBqUXVlcnkubm9kZU5hbWUoIGNvbnRleHQsIHRhZyApID8KICAgIGpRdWVyeS5tZXJnZSggWyBjb250ZXh0IF0sIGZvdW5kICkgOgogICAgZm91bmQ7Cn0KCi8vIFVzZWQgaW4gYnVpbGRGcmFnbWVudCwgZml4ZXMgdGhlIGRlZmF1bHRDaGVja2VkIHByb3BlcnR5CmZ1bmN0aW9uIGZpeERlZmF1bHRDaGVja2VkKCBlbGVtICkgewogIGlmICggbWFuaXB1bGF0aW9uX3JjaGVja2FibGVUeXBlLnRlc3QoIGVsZW0udHlwZSApICkgewogICAgZWxlbS5kZWZhdWx0Q2hlY2tlZCA9IGVsZW0uY2hlY2tlZDsKICB9Cn0KCmpRdWVyeS5leHRlbmQoewogIGNsb25lOiBmdW5jdGlvbiggZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CiAgICB2YXIgZGVzdEVsZW1lbnRzLCBzcmNFbGVtZW50cywgbm9kZSwgaSwgY2xvbmUsCiAgICAgIGluUGFnZSA9IGpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7CgogICAgaWYgKCBqUXVlcnkuc3VwcG9ydC5odG1sNUNsb25lIHx8IGpRdWVyeS5pc1hNTERvYyhlbGVtKSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoICI8IiArIGVsZW0ubm9kZU5hbWUgKyAiPiIgKSApIHsKICAgICAgY2xvbmUgPSBlbGVtLmNsb25lTm9kZSggdHJ1ZSApOwoKICAgIC8vIElFPD04IGRvZXMgbm90IHByb3Blcmx5IGNsb25lIGRldGFjaGVkLCB1bmtub3duIGVsZW1lbnQgbm9kZXMKICAgIH0gZWxzZSB7CiAgICAgIGZyYWdtZW50RGl2LmlubmVySFRNTCA9IGVsZW0ub3V0ZXJIVE1MOwogICAgICBmcmFnbWVudERpdi5yZW1vdmVDaGlsZCggY2xvbmUgPSBmcmFnbWVudERpdi5maXJzdENoaWxkICk7CiAgICB9CgogICAgaWYgKCAoIWpRdWVyeS5zdXBwb3J0Lm5vQ2xvbmVFdmVudCB8fCAhalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUNoZWNrZWQpICYmCiAgICAgICAgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgZWxlbS5ub2RlVHlwZSA9PT0gMTEpICYmICFqUXVlcnkuaXNYTUxEb2MoZWxlbSkgKSB7CgogICAgICAvLyBXZSBlc2NoZXcgU2l6emxlIGhlcmUgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnM6IGh0dHA6Ly9qc3BlcmYuY29tL2dldGFsbC12cy1zaXp6bGUvMgogICAgICBkZXN0RWxlbWVudHMgPSBnZXRBbGwoIGNsb25lICk7CiAgICAgIHNyY0VsZW1lbnRzID0gZ2V0QWxsKCBlbGVtICk7CgogICAgICAvLyBGaXggYWxsIElFIGNsb25pbmcgaXNzdWVzCiAgICAgIGZvciAoIGkgPSAwOyAobm9kZSA9IHNyY0VsZW1lbnRzW2ldKSAhPSBudWxsOyArK2kgKSB7CiAgICAgICAgLy8gRW5zdXJlIHRoYXQgdGhlIGRlc3RpbmF0aW9uIG5vZGUgaXMgbm90IG51bGw7IEZpeGVzICM5NTg3CiAgICAgICAgaWYgKCBkZXN0RWxlbWVudHNbaV0gKSB7CiAgICAgICAgICBmaXhDbG9uZU5vZGVJc3N1ZXMoIG5vZGUsIGRlc3RFbGVtZW50c1tpXSApOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKICAgIGlmICggZGF0YUFuZEV2ZW50cyApIHsKICAgICAgaWYgKCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKICAgICAgICBzcmNFbGVtZW50cyA9IHNyY0VsZW1lbnRzIHx8IGdldEFsbCggZWxlbSApOwogICAgICAgIGRlc3RFbGVtZW50cyA9IGRlc3RFbGVtZW50cyB8fCBnZXRBbGwoIGNsb25lICk7CgogICAgICAgIGZvciAoIGkgPSAwOyAobm9kZSA9IHNyY0VsZW1lbnRzW2ldKSAhPSBudWxsOyBpKysgKSB7CiAgICAgICAgICBjbG9uZUNvcHlFdmVudCggbm9kZSwgZGVzdEVsZW1lbnRzW2ldICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNsb25lQ29weUV2ZW50KCBlbGVtLCBjbG9uZSApOwogICAgICB9CiAgICB9CgogICAgLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQogICAgZGVzdEVsZW1lbnRzID0gZ2V0QWxsKCBjbG9uZSwgInNjcmlwdCIgKTsKICAgIGlmICggZGVzdEVsZW1lbnRzLmxlbmd0aCA+IDAgKSB7CiAgICAgIHNldEdsb2JhbEV2YWwoIGRlc3RFbGVtZW50cywgIWluUGFnZSAmJiBnZXRBbGwoIGVsZW0sICJzY3JpcHQiICkgKTsKICAgIH0KCiAgICBkZXN0RWxlbWVudHMgPSBzcmNFbGVtZW50cyA9IG5vZGUgPSBudWxsOwoKICAgIC8vIFJldHVybiB0aGUgY2xvbmVkIHNldAogICAgcmV0dXJuIGNsb25lOwogIH0sCgogIGJ1aWxkRnJhZ21lbnQ6IGZ1bmN0aW9uKCBlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uICkgewogICAgdmFyIGNvbnRhaW5zLCBlbGVtLCB0YWcsIHRtcCwgd3JhcCwgdGJvZHksIGosCiAgICAgIGwgPSBlbGVtcy5sZW5ndGgsCgogICAgICAvLyBFbnN1cmUgYSBzYWZlIGZyYWdtZW50CiAgICAgIHNhZmUgPSBjcmVhdGVTYWZlRnJhZ21lbnQoIGNvbnRleHQgKSwKCiAgICAgIG5vZGVzID0gW10sCiAgICAgIGkgPSAwOwoKICAgIGZvciAoIDsgaSA8IGw7IGkrKyApIHsKICAgICAgZWxlbSA9IGVsZW1zWyBpIF07CgogICAgICBpZiAoIGVsZW0gfHwgZWxlbSA9PT0gMCApIHsKCiAgICAgICAgLy8gQWRkIG5vZGVzIGRpcmVjdGx5CiAgICAgICAgaWYgKCBqUXVlcnkudHlwZSggZWxlbSApID09PSAib2JqZWN0IiApIHsKICAgICAgICAgIGpRdWVyeS5tZXJnZSggbm9kZXMsIGVsZW0ubm9kZVR5cGUgPyBbIGVsZW0gXSA6IGVsZW0gKTsKCiAgICAgICAgLy8gQ29udmVydCBub24taHRtbCBpbnRvIGEgdGV4dCBub2RlCiAgICAgICAgfSBlbHNlIGlmICggIXJodG1sLnRlc3QoIGVsZW0gKSApIHsKICAgICAgICAgIG5vZGVzLnB1c2goIGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoIGVsZW0gKSApOwoKICAgICAgICAvLyBDb252ZXJ0IGh0bWwgaW50byBET00gbm9kZXMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdG1wID0gdG1wIHx8IHNhZmUuYXBwZW5kQ2hpbGQoIGNvbnRleHQuY3JlYXRlRWxlbWVudCgiZGl2IikgKTsKCiAgICAgICAgICAvLyBEZXNlcmlhbGl6ZSBhIHN0YW5kYXJkIHJlcHJlc2VudGF0aW9uCiAgICAgICAgICB0YWcgPSAoIHJ0YWdOYW1lLmV4ZWMoIGVsZW0gKSB8fCBbIiIsICIiXSApWzFdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICB3cmFwID0gd3JhcE1hcFsgdGFnIF0gfHwgd3JhcE1hcC5fZGVmYXVsdDsKCiAgICAgICAgICB0bXAuaW5uZXJIVE1MID0gd3JhcFsxXSArIGVsZW0ucmVwbGFjZSggcnhodG1sVGFnLCAiPCQxPjwvJDI+IiApICsgd3JhcFsyXTsKCiAgICAgICAgICAvLyBEZXNjZW5kIHRocm91Z2ggd3JhcHBlcnMgdG8gdGhlIHJpZ2h0IGNvbnRlbnQKICAgICAgICAgIGogPSB3cmFwWzBdOwogICAgICAgICAgd2hpbGUgKCBqLS0gKSB7CiAgICAgICAgICAgIHRtcCA9IHRtcC5sYXN0Q2hpbGQ7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTWFudWFsbHkgYWRkIGxlYWRpbmcgd2hpdGVzcGFjZSByZW1vdmVkIGJ5IElFCiAgICAgICAgICBpZiAoICFqUXVlcnkuc3VwcG9ydC5sZWFkaW5nV2hpdGVzcGFjZSAmJiBybGVhZGluZ1doaXRlc3BhY2UudGVzdCggZWxlbSApICkgewogICAgICAgICAgICBub2Rlcy5wdXNoKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBybGVhZGluZ1doaXRlc3BhY2UuZXhlYyggZWxlbSApWzBdICkgKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZW1vdmUgSUUncyBhdXRvaW5zZXJ0ZWQgPHRib2R5PiBmcm9tIHRhYmxlIGZyYWdtZW50cwogICAgICAgICAgaWYgKCAhalF1ZXJ5LnN1cHBvcnQudGJvZHkgKSB7CgogICAgICAgICAgICAvLyBTdHJpbmcgd2FzIGEgPHRhYmxlPiwgKm1heSogaGF2ZSBzcHVyaW91cyA8dGJvZHk+CiAgICAgICAgICAgIGVsZW0gPSB0YWcgPT09ICJ0YWJsZSIgJiYgIXJ0Ym9keS50ZXN0KCBlbGVtICkgPwogICAgICAgICAgICAgIHRtcC5maXJzdENoaWxkIDoKCiAgICAgICAgICAgICAgLy8gU3RyaW5nIHdhcyBhIGJhcmUgPHRoZWFkPiBvciA8dGZvb3Q+CiAgICAgICAgICAgICAgd3JhcFsxXSA9PT0gIjx0YWJsZT4iICYmICFydGJvZHkudGVzdCggZWxlbSApID8KICAgICAgICAgICAgICAgIHRtcCA6CiAgICAgICAgICAgICAgICAwOwoKICAgICAgICAgICAgaiA9IGVsZW0gJiYgZWxlbS5jaGlsZE5vZGVzLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKCBqLS0gKSB7CiAgICAgICAgICAgICAgaWYgKCBqUXVlcnkubm9kZU5hbWUoICh0Ym9keSA9IGVsZW0uY2hpbGROb2Rlc1tqXSksICJ0Ym9keSIgKSAmJiAhdGJvZHkuY2hpbGROb2Rlcy5sZW5ndGggKSB7CiAgICAgICAgICAgICAgICBlbGVtLnJlbW92ZUNoaWxkKCB0Ym9keSApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGpRdWVyeS5tZXJnZSggbm9kZXMsIHRtcC5jaGlsZE5vZGVzICk7CgogICAgICAgICAgLy8gRml4ICMxMjM5MiBmb3IgV2ViS2l0IGFuZCBJRSA+IDkKICAgICAgICAgIHRtcC50ZXh0Q29udGVudCA9ICIiOwoKICAgICAgICAgIC8vIEZpeCAjMTIzOTIgZm9yIG9sZElFCiAgICAgICAgICB3aGlsZSAoIHRtcC5maXJzdENoaWxkICkgewogICAgICAgICAgICB0bXAucmVtb3ZlQ2hpbGQoIHRtcC5maXJzdENoaWxkICk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gUmVtZW1iZXIgdGhlIHRvcC1sZXZlbCBjb250YWluZXIgZm9yIHByb3BlciBjbGVhbnVwCiAgICAgICAgICB0bXAgPSBzYWZlLmxhc3RDaGlsZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBGaXggIzExMzU2OiBDbGVhciBlbGVtZW50cyBmcm9tIGZyYWdtZW50CiAgICBpZiAoIHRtcCApIHsKICAgICAgc2FmZS5yZW1vdmVDaGlsZCggdG1wICk7CiAgICB9CgogICAgLy8gUmVzZXQgZGVmYXVsdENoZWNrZWQgZm9yIGFueSByYWRpb3MgYW5kIGNoZWNrYm94ZXMKICAgIC8vIGFib3V0IHRvIGJlIGFwcGVuZGVkIHRvIHRoZSBET00gaW4gSUUgNi83ICgjODA2MCkKICAgIGlmICggIWpRdWVyeS5zdXBwb3J0LmFwcGVuZENoZWNrZWQgKSB7CiAgICAgIGpRdWVyeS5ncmVwKCBnZXRBbGwoIG5vZGVzLCAiaW5wdXQiICksIGZpeERlZmF1bHRDaGVja2VkICk7CiAgICB9CgogICAgaSA9IDA7CiAgICB3aGlsZSAoIChlbGVtID0gbm9kZXNbIGkrKyBdKSApIHsKCiAgICAgIC8vICM0MDg3IC0gSWYgb3JpZ2luIGFuZCBkZXN0aW5hdGlvbiBlbGVtZW50cyBhcmUgdGhlIHNhbWUsIGFuZCB0aGlzIGlzCiAgICAgIC8vIHRoYXQgZWxlbWVudCwgZG8gbm90IGRvIGFueXRoaW5nCiAgICAgIGlmICggc2VsZWN0aW9uICYmIGpRdWVyeS5pbkFycmF5KCBlbGVtLCBzZWxlY3Rpb24gKSAhPT0gLTEgKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGNvbnRhaW5zID0galF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKTsKCiAgICAgIC8vIEFwcGVuZCB0byBmcmFnbWVudAogICAgICB0bXAgPSBnZXRBbGwoIHNhZmUuYXBwZW5kQ2hpbGQoIGVsZW0gKSwgInNjcmlwdCIgKTsKCiAgICAgIC8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkKICAgICAgaWYgKCBjb250YWlucyApIHsKICAgICAgICBzZXRHbG9iYWxFdmFsKCB0bXAgKTsKICAgICAgfQoKICAgICAgLy8gQ2FwdHVyZSBleGVjdXRhYmxlcwogICAgICBpZiAoIHNjcmlwdHMgKSB7CiAgICAgICAgaiA9IDA7CiAgICAgICAgd2hpbGUgKCAoZWxlbSA9IHRtcFsgaisrIF0pICkgewogICAgICAgICAgaWYgKCByc2NyaXB0VHlwZS50ZXN0KCBlbGVtLnR5cGUgfHwgIiIgKSApIHsKICAgICAgICAgICAgc2NyaXB0cy5wdXNoKCBlbGVtICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdG1wID0gbnVsbDsKCiAgICByZXR1cm4gc2FmZTsKICB9LAoKICBjbGVhbkRhdGE6IGZ1bmN0aW9uKCBlbGVtcywgLyogaW50ZXJuYWwgKi8gYWNjZXB0RGF0YSApIHsKICAgIHZhciBkYXRhLCBpZCwgZWxlbSwgdHlwZSwKICAgICAgaSA9IDAsCiAgICAgIGludGVybmFsS2V5ID0galF1ZXJ5LmV4cGFuZG8sCiAgICAgIGNhY2hlID0galF1ZXJ5LmNhY2hlLAogICAgICBkZWxldGVFeHBhbmRvID0galF1ZXJ5LnN1cHBvcnQuZGVsZXRlRXhwYW5kbywKICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsOwoKICAgIGZvciAoIDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoKICAgICAgaWYgKCBhY2NlcHREYXRhIHx8IGpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CgogICAgICAgIGlkID0gZWxlbVsgaW50ZXJuYWxLZXkgXTsKICAgICAgICBkYXRhID0gaWQgJiYgY2FjaGVbIGlkIF07CgogICAgICAgIGlmICggZGF0YSApIHsKICAgICAgICAgIGlmICggZGF0YS5ldmVudHMgKSB7CiAgICAgICAgICAgIGZvciAoIHR5cGUgaW4gZGF0YS5ldmVudHMgKSB7CiAgICAgICAgICAgICAgaWYgKCBzcGVjaWFsWyB0eXBlIF0gKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICk7CgogICAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBzaG9ydGN1dCB0byBhdm9pZCBqUXVlcnkuZXZlbnQucmVtb3ZlJ3Mgb3ZlcmhlYWQKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBkYXRhLmhhbmRsZSApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJlbW92ZSBjYWNoZSBvbmx5IGlmIGl0IHdhcyBub3QgYWxyZWFkeSByZW1vdmVkIGJ5IGpRdWVyeS5ldmVudC5yZW1vdmUKICAgICAgICAgIGlmICggY2FjaGVbIGlkIF0gKSB7CgogICAgICAgICAgICBkZWxldGUgY2FjaGVbIGlkIF07CgogICAgICAgICAgICAvLyBJRSBkb2VzIG5vdCBhbGxvdyB1cyB0byBkZWxldGUgZXhwYW5kbyBwcm9wZXJ0aWVzIGZyb20gbm9kZXMsCiAgICAgICAgICAgIC8vIG5vciBkb2VzIGl0IGhhdmUgYSByZW1vdmVBdHRyaWJ1dGUgZnVuY3Rpb24gb24gRG9jdW1lbnQgbm9kZXM7CiAgICAgICAgICAgIC8vIHdlIG11c3QgaGFuZGxlIGFsbCBvZiB0aGVzZSBjYXNlcwogICAgICAgICAgICBpZiAoIGRlbGV0ZUV4cGFuZG8gKSB7CiAgICAgICAgICAgICAgZGVsZXRlIGVsZW1bIGludGVybmFsS2V5IF07CgogICAgICAgICAgICB9IGVsc2UgaWYgKCB0eXBlb2YgZWxlbS5yZW1vdmVBdHRyaWJ1dGUgIT09ICJ1bmRlZmluZWQiICkgewogICAgICAgICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKCBpbnRlcm5hbEtleSApOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbGVtWyBpbnRlcm5hbEtleSBdID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29yZV9kZWxldGVkSWRzLnB1c2goIGlkICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIGN1ckNTUywgZ2V0U3R5bGVzLCBpZnJhbWUsCiAgcmFscGhhID0gL2FscGhhXChbXildKlwpL2ksCiAgcm9wYWNpdHkgPSAvb3BhY2l0eVxzKj1ccyooW14pXSopLywKICBycG9zaXRpb24gPSAvXih0b3B8cmlnaHR8Ym90dG9tfGxlZnQpJC8sCiAgLy8gc3dhcHBhYmxlIGlmIGRpc3BsYXkgaXMgbm9uZSBvciBzdGFydHMgd2l0aCB0YWJsZSBleGNlcHQgInRhYmxlIiwgInRhYmxlLWNlbGwiLCBvciAidGFibGUtY2FwdGlvbiIKICAvLyBzZWUgaGVyZSBmb3IgZGlzcGxheSB2YWx1ZXM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvQ1NTL2Rpc3BsYXkKICByZGlzcGxheXN3YXAgPSAvXihub25lfHRhYmxlKD8hLWNbZWFdKS4rKS8sCiAgcm1hcmdpbiA9IC9ebWFyZ2luLywKICBybnVtc3BsaXQgPSBuZXcgUmVnRXhwKCAiXigiICsgY29yZV9wbnVtICsgIikoLiopJCIsICJpIiApLAogIHJudW1ub25weCA9IG5ldyBSZWdFeHAoICJeKCIgKyBjb3JlX3BudW0gKyAiKSg/IXB4KVthLXolXSskIiwgImkiICksCiAgcnJlbE51bSA9IG5ldyBSZWdFeHAoICJeKFsrLV0pPSgiICsgY29yZV9wbnVtICsgIikiLCAiaSIgKSwKICBlbGVtZGlzcGxheSA9IHsgQk9EWTogImJsb2NrIiB9LAoKICBjc3NTaG93ID0geyBwb3NpdGlvbjogImFic29sdXRlIiwgdmlzaWJpbGl0eTogImhpZGRlbiIsIGRpc3BsYXk6ICJibG9jayIgfSwKICBjc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CiAgICBsZXR0ZXJTcGFjaW5nOiAwLAogICAgZm9udFdlaWdodDogNDAwCiAgfSwKCiAgY3NzRXhwYW5kID0gWyAiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0IiBdLAogIGNzc1ByZWZpeGVzID0gWyAiV2Via2l0IiwgIk8iLCAiTW96IiwgIm1zIiBdOwoKLy8gcmV0dXJuIGEgY3NzIHByb3BlcnR5IG1hcHBlZCB0byBhIHBvdGVudGlhbGx5IHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQpmdW5jdGlvbiB2ZW5kb3JQcm9wTmFtZSggc3R5bGUsIG5hbWUgKSB7CgogIC8vIHNob3J0Y3V0IGZvciBuYW1lcyB0aGF0IGFyZSBub3QgdmVuZG9yIHByZWZpeGVkCiAgaWYgKCBuYW1lIGluIHN0eWxlICkgewogICAgcmV0dXJuIG5hbWU7CiAgfQoKICAvLyBjaGVjayBmb3IgdmVuZG9yIHByZWZpeGVkIG5hbWVzCiAgdmFyIGNhcE5hbWUgPSBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwKICAgIG9yaWdOYW1lID0gbmFtZSwKICAgIGkgPSBjc3NQcmVmaXhlcy5sZW5ndGg7CgogIHdoaWxlICggaS0tICkgewogICAgbmFtZSA9IGNzc1ByZWZpeGVzWyBpIF0gKyBjYXBOYW1lOwogICAgaWYgKCBuYW1lIGluIHN0eWxlICkgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9CgogIHJldHVybiBvcmlnTmFtZTsKfQoKZnVuY3Rpb24gaXNIaWRkZW4oIGVsZW0sIGVsICkgewogIC8vIGlzSGlkZGVuIG1pZ2h0IGJlIGNhbGxlZCBmcm9tIGpRdWVyeSNmaWx0ZXIgZnVuY3Rpb247CiAgLy8gaW4gdGhhdCBjYXNlLCBlbGVtZW50IHdpbGwgYmUgc2Vjb25kIGFyZ3VtZW50CiAgZWxlbSA9IGVsIHx8IGVsZW07CiAgcmV0dXJuIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAibm9uZSIgfHwgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7Cn0KCmZ1bmN0aW9uIHNob3dIaWRlKCBlbGVtZW50cywgc2hvdyApIHsKICB2YXIgZWxlbSwKICAgIHZhbHVlcyA9IFtdLAogICAgaW5kZXggPSAwLAogICAgbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwoKICBmb3IgKCA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewogICAgZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwogICAgaWYgKCAhZWxlbS5zdHlsZSApIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICB2YWx1ZXNbIGluZGV4IF0gPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiApOwogICAgaWYgKCBzaG93ICkgewogICAgICAvLyBSZXNldCB0aGUgaW5saW5lIGRpc3BsYXkgb2YgdGhpcyBlbGVtZW50IHRvIGxlYXJuIGlmIGl0IGlzCiAgICAgIC8vIGJlaW5nIGhpZGRlbiBieSBjYXNjYWRlZCBydWxlcyBvciBub3QKICAgICAgaWYgKCAhdmFsdWVzWyBpbmRleCBdICYmIGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiICkgewogICAgICAgIGVsZW0uc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICB9CgogICAgICAvLyBTZXQgZWxlbWVudHMgd2hpY2ggaGF2ZSBiZWVuIG92ZXJyaWRkZW4gd2l0aCBkaXNwbGF5OiBub25lCiAgICAgIC8vIGluIGEgc3R5bGVzaGVldCB0byB3aGF0ZXZlciB0aGUgZGVmYXVsdCBicm93c2VyIHN0eWxlIGlzCiAgICAgIC8vIGZvciBzdWNoIGFuIGVsZW1lbnQKICAgICAgaWYgKCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmIGlzSGlkZGVuKCBlbGVtICkgKSB7CiAgICAgICAgdmFsdWVzWyBpbmRleCBdID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCAib2xkZGlzcGxheSIsIGNzc19kZWZhdWx0RGlzcGxheShlbGVtLm5vZGVOYW1lKSApOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCAhdmFsdWVzWyBpbmRleCBdICYmICFpc0hpZGRlbiggZWxlbSApICkgewogICAgICBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiwgalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgKTsKICAgIH0KICB9CgogIC8vIFNldCB0aGUgZGlzcGxheSBvZiBtb3N0IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wCiAgLy8gdG8gYXZvaWQgdGhlIGNvbnN0YW50IHJlZmxvdwogIGZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CiAgICBlbGVtID0gZWxlbWVudHNbIGluZGV4IF07CiAgICBpZiAoICFlbGVtLnN0eWxlICkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIGlmICggIXNob3cgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAiIiApIHsKICAgICAgZWxlbS5zdHlsZS5kaXNwbGF5ID0gc2hvdyA/IHZhbHVlc1sgaW5kZXggXSB8fCAiIiA6ICJub25lIjsKICAgIH0KICB9CgogIHJldHVybiBlbGVtZW50czsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7CiAgY3NzOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CiAgICByZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewogICAgICB2YXIgc3R5bGVzLCBsZW4sCiAgICAgICAgbWFwID0ge30sCiAgICAgICAgaSA9IDA7CgogICAgICBpZiAoIGpRdWVyeS5pc0FycmF5KCBuYW1lICkgKSB7CiAgICAgICAgc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICk7CiAgICAgICAgbGVuID0gbmFtZS5sZW5ndGg7CgogICAgICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgICAgICAgbWFwWyBuYW1lWyBpIF0gXSA9IGpRdWVyeS5jc3MoIGVsZW0sIG5hbWVbIGkgXSwgZmFsc2UsIHN0eWxlcyApOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgfQoKICAgICAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPwogICAgICAgIGpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSwgdmFsdWUgKSA6CiAgICAgICAgalF1ZXJ5LmNzcyggZWxlbSwgbmFtZSApOwogICAgfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7CiAgfSwKICBzaG93OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzaG93SGlkZSggdGhpcywgdHJ1ZSApOwogIH0sCiAgaGlkZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gc2hvd0hpZGUoIHRoaXMgKTsKICB9LAogIHRvZ2dsZTogZnVuY3Rpb24oIHN0YXRlICkgewogICAgdmFyIGJvb2wgPSB0eXBlb2Ygc3RhdGUgPT09ICJib29sZWFuIjsKCiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICBpZiAoIGJvb2wgPyBzdGF0ZSA6IGlzSGlkZGVuKCB0aGlzICkgKSB7CiAgICAgICAgalF1ZXJ5KCB0aGlzICkuc2hvdygpOwogICAgICB9IGVsc2UgewogICAgICAgIGpRdWVyeSggdGhpcyApLmhpZGUoKTsKICAgICAgfQogICAgfSk7CiAgfQp9KTsKCmpRdWVyeS5leHRlbmQoewogIC8vIEFkZCBpbiBzdHlsZSBwcm9wZXJ0eSBob29rcyBmb3Igb3ZlcnJpZGluZyB0aGUgZGVmYXVsdAogIC8vIGJlaGF2aW9yIG9mIGdldHRpbmcgYW5kIHNldHRpbmcgYSBzdHlsZSBwcm9wZXJ0eQogIGNzc0hvb2tzOiB7CiAgICBvcGFjaXR5OiB7CiAgICAgIGdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewogICAgICAgIGlmICggY29tcHV0ZWQgKSB7CiAgICAgICAgICAvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQogICAgICAgICAgdmFyIHJldCA9IGN1ckNTUyggZWxlbSwgIm9wYWNpdHkiICk7CiAgICAgICAgICByZXR1cm4gcmV0ID09PSAiIiA/ICIxIiA6IHJldDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LAoKICAvLyBFeGNsdWRlIHRoZSBmb2xsb3dpbmcgY3NzIHByb3BlcnRpZXMgdG8gYWRkIHB4CiAgY3NzTnVtYmVyOiB7CiAgICAiY29sdW1uQ291bnQiOiB0cnVlLAogICAgImZpbGxPcGFjaXR5IjogdHJ1ZSwKICAgICJmb250V2VpZ2h0IjogdHJ1ZSwKICAgICJsaW5lSGVpZ2h0IjogdHJ1ZSwKICAgICJvcGFjaXR5IjogdHJ1ZSwKICAgICJvcnBoYW5zIjogdHJ1ZSwKICAgICJ3aWRvd3MiOiB0cnVlLAogICAgInpJbmRleCI6IHRydWUsCiAgICAiem9vbSI6IHRydWUKICB9LAoKICAvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCiAgLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQogIGNzc1Byb3BzOiB7CiAgICAvLyBub3JtYWxpemUgZmxvYXQgY3NzIHByb3BlcnR5CiAgICAiZmxvYXQiOiBqUXVlcnkuc3VwcG9ydC5jc3NGbG9hdCA/ICJjc3NGbG9hdCIgOiAic3R5bGVGbG9hdCIKICB9LAoKICAvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQogIHN0eWxlOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUsIGV4dHJhICkgewogICAgLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCiAgICBpZiAoICFlbGVtIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCB8fCAhZWxlbS5zdHlsZSApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQogICAgdmFyIHJldCwgdHlwZSwgaG9va3MsCiAgICAgIG9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApLAogICAgICBzdHlsZSA9IGVsZW0uc3R5bGU7CgogICAgbmFtZSA9IGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSB8fCAoIGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSA9IHZlbmRvclByb3BOYW1lKCBzdHlsZSwgb3JpZ05hbWUgKSApOwoKICAgIC8vIGdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24KICAgIC8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKICAgIC8vIENoZWNrIGlmIHdlJ3JlIHNldHRpbmcgYSB2YWx1ZQogICAgaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewogICAgICB0eXBlID0gdHlwZW9mIHZhbHVlOwoKICAgICAgLy8gY29udmVydCByZWxhdGl2ZSBudW1iZXIgc3RyaW5ncyAoKz0gb3IgLT0pIHRvIHJlbGF0aXZlIG51bWJlcnMuICM3MzQ1CiAgICAgIGlmICggdHlwZSA9PT0gInN0cmluZyIgJiYgKHJldCA9IHJyZWxOdW0uZXhlYyggdmFsdWUgKSkgKSB7CiAgICAgICAgdmFsdWUgPSAoIHJldFsxXSArIDEgKSAqIHJldFsyXSArIHBhcnNlRmxvYXQoIGpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKSApOwogICAgICAgIC8vIEZpeGVzIGJ1ZyAjOTIzNwogICAgICAgIHR5cGUgPSAibnVtYmVyIjsKICAgICAgfQoKICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgTmFOIGFuZCBudWxsIHZhbHVlcyBhcmVuJ3Qgc2V0LiBTZWU6ICM3MTE2CiAgICAgIGlmICggdmFsdWUgPT0gbnVsbCB8fCB0eXBlID09PSAibnVtYmVyIiAmJiBpc05hTiggdmFsdWUgKSApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIElmIGEgbnVtYmVyIHdhcyBwYXNzZWQgaW4sIGFkZCAncHgnIHRvIHRoZSAoZXhjZXB0IGZvciBjZXJ0YWluIENTUyBwcm9wZXJ0aWVzKQogICAgICBpZiAoIHR5cGUgPT09ICJudW1iZXIiICYmICFqUXVlcnkuY3NzTnVtYmVyWyBvcmlnTmFtZSBdICkgewogICAgICAgIHZhbHVlICs9ICJweCI7CiAgICAgIH0KCiAgICAgIC8vIEZpeGVzICM4OTA4LCBpdCBjYW4gYmUgZG9uZSBtb3JlIGNvcnJlY3RseSBieSBzcGVjaWZpbmcgc2V0dGVycyBpbiBjc3NIb29rcywKICAgICAgLy8gYnV0IGl0IHdvdWxkIG1lYW4gdG8gZGVmaW5lIGVpZ2h0IChmb3IgZXZlcnkgcHJvYmxlbWF0aWMgcHJvcGVydHkpIGlkZW50aWNhbCBmdW5jdGlvbnMKICAgICAgaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlICYmIHZhbHVlID09PSAiIiAmJiBuYW1lLmluZGV4T2YoImJhY2tncm91bmQiKSA9PT0gMCApIHsKICAgICAgICBzdHlsZVsgbmFtZSBdID0gImluaGVyaXQiOwogICAgICB9CgogICAgICAvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkLCB1c2UgdGhhdCB2YWx1ZSwgb3RoZXJ3aXNlIGp1c3Qgc2V0IHRoZSBzcGVjaWZpZWQgdmFsdWUKICAgICAgaWYgKCAhaG9va3MgfHwgISgic2V0IiBpbiBob29rcykgfHwgKHZhbHVlID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgZXh0cmEgKSkgIT09IHVuZGVmaW5lZCApIHsKCiAgICAgICAgLy8gV3JhcHBlZCB0byBwcmV2ZW50IElFIGZyb20gdGhyb3dpbmcgZXJyb3JzIHdoZW4gJ2ludmFsaWQnIHZhbHVlcyBhcmUgcHJvdmlkZWQKICAgICAgICAvLyBGaXhlcyBidWcgIzU1MDkKICAgICAgICB0cnkgewogICAgICAgICAgc3R5bGVbIG5hbWUgXSA9IHZhbHVlOwogICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBub24tY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQogICAgICBpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIGZhbHNlLCBleHRyYSApKSAhPT0gdW5kZWZpbmVkICkgewogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KCiAgICAgIC8vIE90aGVyd2lzZSBqdXN0IGdldCB0aGUgdmFsdWUgZnJvbSB0aGUgc3R5bGUgb2JqZWN0CiAgICAgIHJldHVybiBzdHlsZVsgbmFtZSBdOwogICAgfQogIH0sCgogIGNzczogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGV4dHJhLCBzdHlsZXMgKSB7CiAgICB2YXIgdmFsLCBudW0sIGhvb2tzLAogICAgICBvcmlnTmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKTsKCiAgICAvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKICAgIG5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gfHwgKCBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gPSB2ZW5kb3JQcm9wTmFtZSggZWxlbS5zdHlsZSwgb3JpZ05hbWUgKSApOwoKICAgIC8vIGdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24KICAgIC8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICBpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICkgewogICAgICB2YWwgPSBob29rcy5nZXQoIGVsZW0sIHRydWUsIGV4dHJhICk7CiAgICB9CgogICAgLy8gT3RoZXJ3aXNlLCBpZiBhIHdheSB0byBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGV4aXN0cywgdXNlIHRoYXQKICAgIGlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CiAgICAgIHZhbCA9IGN1ckNTUyggZWxlbSwgbmFtZSwgc3R5bGVzICk7CiAgICB9CgogICAgLy9jb252ZXJ0ICJub3JtYWwiIHRvIGNvbXB1dGVkIHZhbHVlCiAgICBpZiAoIHZhbCA9PT0gIm5vcm1hbCIgJiYgbmFtZSBpbiBjc3NOb3JtYWxUcmFuc2Zvcm0gKSB7CiAgICAgIHZhbCA9IGNzc05vcm1hbFRyYW5zZm9ybVsgbmFtZSBdOwogICAgfQoKICAgIC8vIFJldHVybiwgY29udmVydGluZyB0byBudW1iZXIgaWYgZm9yY2VkIG9yIGEgcXVhbGlmaWVyIHdhcyBwcm92aWRlZCBhbmQgdmFsIGxvb2tzIG51bWVyaWMKICAgIGlmICggZXh0cmEgKSB7CiAgICAgIG51bSA9IHBhcnNlRmxvYXQoIHZhbCApOwogICAgICByZXR1cm4gZXh0cmEgPT09IHRydWUgfHwgalF1ZXJ5LmlzTnVtZXJpYyggbnVtICkgPyBudW0gfHwgMCA6IHZhbDsKICAgIH0KICAgIHJldHVybiB2YWw7CiAgfSwKCiAgLy8gQSBtZXRob2QgZm9yIHF1aWNrbHkgc3dhcHBpbmcgaW4vb3V0IENTUyBwcm9wZXJ0aWVzIHRvIGdldCBjb3JyZWN0IGNhbGN1bGF0aW9ucwogIHN3YXA6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBjYWxsYmFjaywgYXJncyApIHsKICAgIHZhciByZXQsIG5hbWUsCiAgICAgIG9sZCA9IHt9OwoKICAgIC8vIFJlbWVtYmVyIHRoZSBvbGQgdmFsdWVzLCBhbmQgaW5zZXJ0IHRoZSBuZXcgb25lcwogICAgZm9yICggbmFtZSBpbiBvcHRpb25zICkgewogICAgICBvbGRbIG5hbWUgXSA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKICAgICAgZWxlbS5zdHlsZVsgbmFtZSBdID0gb3B0aW9uc1sgbmFtZSBdOwogICAgfQoKICAgIHJldCA9IGNhbGxiYWNrLmFwcGx5KCBlbGVtLCBhcmdzIHx8IFtdICk7CgogICAgLy8gUmV2ZXJ0IHRoZSBvbGQgdmFsdWVzCiAgICBmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CiAgICAgIGVsZW0uc3R5bGVbIG5hbWUgXSA9IG9sZFsgbmFtZSBdOwogICAgfQoKICAgIHJldHVybiByZXQ7CiAgfQp9KTsKCi8vIE5PVEU6IHdlJ3ZlIGluY2x1ZGVkIHRoZSAid2luZG93IiBpbiB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZQovLyBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0LgppZiAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlICkgewogIGdldFN0eWxlcyA9IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbGVtLCBudWxsICk7CiAgfTsKCiAgY3VyQ1NTID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUsIF9jb21wdXRlZCApIHsKICAgIHZhciB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLAogICAgICBjb21wdXRlZCA9IF9jb21wdXRlZCB8fCBnZXRTdHlsZXMoIGVsZW0gKSwKCiAgICAgIC8vIGdldFByb3BlcnR5VmFsdWUgaXMgb25seSBuZWVkZWQgZm9yIC5jc3MoJ2ZpbHRlcicpIGluIElFOSwgc2VlICMxMjUzNwogICAgICByZXQgPSBjb21wdXRlZCA/IGNvbXB1dGVkLmdldFByb3BlcnR5VmFsdWUoIG5hbWUgKSB8fCBjb21wdXRlZFsgbmFtZSBdIDogdW5kZWZpbmVkLAogICAgICBzdHlsZSA9IGVsZW0uc3R5bGU7CgogICAgaWYgKCBjb21wdXRlZCApIHsKCiAgICAgIGlmICggcmV0ID09PSAiIiAmJiAhalF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKSApIHsKICAgICAgICByZXQgPSBqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUgKTsKICAgICAgfQoKICAgICAgLy8gQSB0cmlidXRlIHRvIHRoZSAiYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcyIKICAgICAgLy8gQ2hyb21lIDwgMTcgYW5kIFNhZmFyaSA1LjAgdXNlcyAiY29tcHV0ZWQgdmFsdWUiIGluc3RlYWQgb2YgInVzZWQgdmFsdWUiIGZvciBtYXJnaW4tcmlnaHQKICAgICAgLy8gU2FmYXJpIDUuMS43IChhdCBsZWFzdCkgcmV0dXJucyBwZXJjZW50YWdlIGZvciBhIGxhcmdlciBzZXQgb2YgdmFsdWVzLCBidXQgd2lkdGggc2VlbXMgdG8gYmUgcmVsaWFibHkgcGl4ZWxzCiAgICAgIC8vIHRoaXMgaXMgYWdhaW5zdCB0aGUgQ1NTT00gZHJhZnQgc3BlYzogaHR0cDovL2Rldi53My5vcmcvY3Nzd2cvY3Nzb20vI3Jlc29sdmVkLXZhbHVlcwogICAgICBpZiAoIHJudW1ub25weC50ZXN0KCByZXQgKSAmJiBybWFyZ2luLnRlc3QoIG5hbWUgKSApIHsKCiAgICAgICAgLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwogICAgICAgIHdpZHRoID0gc3R5bGUud2lkdGg7CiAgICAgICAgbWluV2lkdGggPSBzdHlsZS5taW5XaWR0aDsKICAgICAgICBtYXhXaWR0aCA9IHN0eWxlLm1heFdpZHRoOwoKICAgICAgICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgICAgICAgc3R5bGUubWluV2lkdGggPSBzdHlsZS5tYXhXaWR0aCA9IHN0eWxlLndpZHRoID0gcmV0OwogICAgICAgIHJldCA9IGNvbXB1dGVkLndpZHRoOwoKICAgICAgICAvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCiAgICAgICAgc3R5bGUud2lkdGggPSB3aWR0aDsKICAgICAgICBzdHlsZS5taW5XaWR0aCA9IG1pbldpZHRoOwogICAgICAgIHN0eWxlLm1heFdpZHRoID0gbWF4V2lkdGg7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH07Cn0gZWxzZSBpZiAoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jdXJyZW50U3R5bGUgKSB7CiAgZ2V0U3R5bGVzID0gZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gZWxlbS5jdXJyZW50U3R5bGU7CiAgfTsKCiAgY3VyQ1NTID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUsIF9jb21wdXRlZCApIHsKICAgIHZhciBsZWZ0LCBycywgcnNMZWZ0LAogICAgICBjb21wdXRlZCA9IF9jb21wdXRlZCB8fCBnZXRTdHlsZXMoIGVsZW0gKSwKICAgICAgcmV0ID0gY29tcHV0ZWQgPyBjb21wdXRlZFsgbmFtZSBdIDogdW5kZWZpbmVkLAogICAgICBzdHlsZSA9IGVsZW0uc3R5bGU7CgogICAgLy8gQXZvaWQgc2V0dGluZyByZXQgdG8gZW1wdHkgc3RyaW5nIGhlcmUKICAgIC8vIHNvIHdlIGRvbid0IGRlZmF1bHQgdG8gYXV0bwogICAgaWYgKCByZXQgPT0gbnVsbCAmJiBzdHlsZSAmJiBzdHlsZVsgbmFtZSBdICkgewogICAgICByZXQgPSBzdHlsZVsgbmFtZSBdOwogICAgfQoKICAgIC8vIEZyb20gdGhlIGF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMKICAgIC8vIGh0dHA6Ly9lcmlrLmVhZS5uZXQvYXJjaGl2ZXMvMjAwNy8wNy8yNy8xOC41NC4xNS8jY29tbWVudC0xMDIyOTEKCiAgICAvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKICAgIC8vIGJ1dCBhIG51bWJlciB0aGF0IGhhcyBhIHdlaXJkIGVuZGluZywgd2UgbmVlZCB0byBjb252ZXJ0IGl0IHRvIHBpeGVscwogICAgLy8gYnV0IG5vdCBwb3NpdGlvbiBjc3MgYXR0cmlidXRlcywgYXMgdGhvc2UgYXJlIHByb3BvcnRpb25hbCB0byB0aGUgcGFyZW50IGVsZW1lbnQgaW5zdGVhZAogICAgLy8gYW5kIHdlIGNhbid0IG1lYXN1cmUgdGhlIHBhcmVudCBpbnN0ZWFkIGJlY2F1c2UgaXQgbWlnaHQgdHJpZ2dlciBhICJzdGFja2luZyBkb2xscyIgcHJvYmxlbQogICAgaWYgKCBybnVtbm9ucHgudGVzdCggcmV0ICkgJiYgIXJwb3NpdGlvbi50ZXN0KCBuYW1lICkgKSB7CgogICAgICAvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCiAgICAgIGxlZnQgPSBzdHlsZS5sZWZ0OwogICAgICBycyA9IGVsZW0ucnVudGltZVN0eWxlOwogICAgICByc0xlZnQgPSBycyAmJiBycy5sZWZ0OwoKICAgICAgLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dAogICAgICBpZiAoIHJzTGVmdCApIHsKICAgICAgICBycy5sZWZ0ID0gZWxlbS5jdXJyZW50U3R5bGUubGVmdDsKICAgICAgfQogICAgICBzdHlsZS5sZWZ0ID0gbmFtZSA9PT0gImZvbnRTaXplIiA/ICIxZW0iIDogcmV0OwogICAgICByZXQgPSBzdHlsZS5waXhlbExlZnQgKyAicHgiOwoKICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICBzdHlsZS5sZWZ0ID0gbGVmdDsKICAgICAgaWYgKCByc0xlZnQgKSB7CiAgICAgICAgcnMubGVmdCA9IHJzTGVmdDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXQgPT09ICIiID8gImF1dG8iIDogcmV0OwogIH07Cn0KCmZ1bmN0aW9uIHNldFBvc2l0aXZlTnVtYmVyKCBlbGVtLCB2YWx1ZSwgc3VidHJhY3QgKSB7CiAgdmFyIG1hdGNoZXMgPSBybnVtc3BsaXQuZXhlYyggdmFsdWUgKTsKICByZXR1cm4gbWF0Y2hlcyA/CiAgICAvLyBHdWFyZCBhZ2FpbnN0IHVuZGVmaW5lZCAic3VidHJhY3QiLCBlLmcuLCB3aGVuIHVzZWQgYXMgaW4gY3NzSG9va3MKICAgIE1hdGgubWF4KCAwLCBtYXRjaGVzWyAxIF0gLSAoIHN1YnRyYWN0IHx8IDAgKSApICsgKCBtYXRjaGVzWyAyIF0gfHwgInB4IiApIDoKICAgIHZhbHVlOwp9CgpmdW5jdGlvbiBhdWdtZW50V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEsIGlzQm9yZGVyQm94LCBzdHlsZXMgKSB7CiAgdmFyIGkgPSBleHRyYSA9PT0gKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICkgPwogICAgLy8gSWYgd2UgYWxyZWFkeSBoYXZlIHRoZSByaWdodCBtZWFzdXJlbWVudCwgYXZvaWQgYXVnbWVudGF0aW9uCiAgICA0IDoKICAgIC8vIE90aGVyd2lzZSBpbml0aWFsaXplIGZvciBob3Jpem9udGFsIG9yIHZlcnRpY2FsIHByb3BlcnRpZXMKICAgIG5hbWUgPT09ICJ3aWR0aCIgPyAxIDogMCwKCiAgICB2YWwgPSAwOwoKICBmb3IgKCA7IGkgPCA0OyBpICs9IDIgKSB7CiAgICAvLyBib3RoIGJveCBtb2RlbHMgZXhjbHVkZSBtYXJnaW4sIHNvIGFkZCBpdCBpZiB3ZSB3YW50IGl0CiAgICBpZiAoIGV4dHJhID09PSAibWFyZ2luIiApIHsKICAgICAgdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sIGV4dHJhICsgY3NzRXhwYW5kWyBpIF0sIHRydWUsIHN0eWxlcyApOwogICAgfQoKICAgIGlmICggaXNCb3JkZXJCb3ggKSB7CiAgICAgIC8vIGJvcmRlci1ib3ggaW5jbHVkZXMgcGFkZGluZywgc28gcmVtb3ZlIGl0IGlmIHdlIHdhbnQgY29udGVudAogICAgICBpZiAoIGV4dHJhID09PSAiY29udGVudCIgKSB7CiAgICAgICAgdmFsIC09IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKICAgICAgfQoKICAgICAgLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgYm9yZGVyIG5vciBtYXJnaW4sIHNvIHJlbW92ZSBib3JkZXIKICAgICAgaWYgKCBleHRyYSAhPT0gIm1hcmdpbiIgKSB7CiAgICAgICAgdmFsIC09IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCwgc28gYWRkIHBhZGRpbmcKICAgICAgdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCiAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGNvbnRlbnQgbm9yIHBhZGRpbmcsIHNvIGFkZCBib3JkZXIKICAgICAgaWYgKCBleHRyYSAhPT0gInBhZGRpbmciICkgewogICAgICAgIHZhbCArPSBqUXVlcnkuY3NzKCBlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIiwgdHJ1ZSwgc3R5bGVzICk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiB2YWw7Cn0KCmZ1bmN0aW9uIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICkgewoKICAvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQogIHZhciB2YWx1ZUlzQm9yZGVyQm94ID0gdHJ1ZSwKICAgIHZhbCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsCiAgICBzdHlsZXMgPSBnZXRTdHlsZXMoIGVsZW0gKSwKICAgIGlzQm9yZGVyQm94ID0galF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IjsKCiAgLy8gc29tZSBub24taHRtbCBlbGVtZW50cyByZXR1cm4gdW5kZWZpbmVkIGZvciBvZmZzZXRXaWR0aCwgc28gY2hlY2sgZm9yIG51bGwvdW5kZWZpbmVkCiAgLy8gc3ZnIC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjQ5Mjg1CiAgLy8gTWF0aE1MIC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDkxNjY4CiAgaWYgKCB2YWwgPD0gMCB8fCB2YWwgPT0gbnVsbCApIHsKICAgIC8vIEZhbGwgYmFjayB0byBjb21wdXRlZCB0aGVuIHVuY29tcHV0ZWQgY3NzIGlmIG5lY2Vzc2FyeQogICAgdmFsID0gY3VyQ1NTKCBlbGVtLCBuYW1lLCBzdHlsZXMgKTsKICAgIGlmICggdmFsIDwgMCB8fCB2YWwgPT0gbnVsbCApIHsKICAgICAgdmFsID0gZWxlbS5zdHlsZVsgbmFtZSBdOwogICAgfQoKICAgIC8vIENvbXB1dGVkIHVuaXQgaXMgbm90IHBpeGVscy4gU3RvcCBoZXJlIGFuZCByZXR1cm4uCiAgICBpZiAoIHJudW1ub25weC50ZXN0KHZhbCkgKSB7CiAgICAgIHJldHVybiB2YWw7CiAgICB9CgogICAgLy8gd2UgbmVlZCB0aGUgY2hlY2sgZm9yIHN0eWxlIGluIGNhc2UgYSBicm93c2VyIHdoaWNoIHJldHVybnMgdW5yZWxpYWJsZSB2YWx1ZXMKICAgIC8vIGZvciBnZXRDb21wdXRlZFN0eWxlIHNpbGVudGx5IGZhbGxzIGJhY2sgdG8gdGhlIHJlbGlhYmxlIGVsZW0uc3R5bGUKICAgIHZhbHVlSXNCb3JkZXJCb3ggPSBpc0JvcmRlckJveCAmJiAoIGpRdWVyeS5zdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlIHx8IHZhbCA9PT0gZWxlbS5zdHlsZVsgbmFtZSBdICk7CgogICAgLy8gTm9ybWFsaXplICIiLCBhdXRvLCBhbmQgcHJlcGFyZSBmb3IgZXh0cmEKICAgIHZhbCA9IHBhcnNlRmxvYXQoIHZhbCApIHx8IDA7CiAgfQoKICAvLyB1c2UgdGhlIGFjdGl2ZSBib3gtc2l6aW5nIG1vZGVsIHRvIGFkZC9zdWJ0cmFjdCBpcnJlbGV2YW50IHN0eWxlcwogIHJldHVybiAoIHZhbCArCiAgICBhdWdtZW50V2lkdGhPckhlaWdodCgKICAgICAgZWxlbSwKICAgICAgbmFtZSwKICAgICAgZXh0cmEgfHwgKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICksCiAgICAgIHZhbHVlSXNCb3JkZXJCb3gsCiAgICAgIHN0eWxlcwogICAgKQogICkgKyAicHgiOwp9CgovLyBUcnkgdG8gZGV0ZXJtaW5lIHRoZSBkZWZhdWx0IGRpc3BsYXkgdmFsdWUgb2YgYW4gZWxlbWVudApmdW5jdGlvbiBjc3NfZGVmYXVsdERpc3BsYXkoIG5vZGVOYW1lICkgewogIHZhciBkb2MgPSBkb2N1bWVudCwKICAgIGRpc3BsYXkgPSBlbGVtZGlzcGxheVsgbm9kZU5hbWUgXTsKCiAgaWYgKCAhZGlzcGxheSApIHsKICAgIGRpc3BsYXkgPSBhY3R1YWxEaXNwbGF5KCBub2RlTmFtZSwgZG9jICk7CgogICAgLy8gSWYgdGhlIHNpbXBsZSB3YXkgZmFpbHMsIHJlYWQgZnJvbSBpbnNpZGUgYW4gaWZyYW1lCiAgICBpZiAoIGRpc3BsYXkgPT09ICJub25lIiB8fCAhZGlzcGxheSApIHsKICAgICAgLy8gVXNlIHRoZSBhbHJlYWR5LWNyZWF0ZWQgaWZyYW1lIGlmIHBvc3NpYmxlCiAgICAgIGlmcmFtZSA9ICggaWZyYW1lIHx8CiAgICAgICAgalF1ZXJ5KCI8aWZyYW1lIGZyYW1lYm9yZGVyPScwJyB3aWR0aD0nMCcgaGVpZ2h0PScwJy8+IikKICAgICAgICAuY3NzKCAiY3NzVGV4dCIsICJkaXNwbGF5OmJsb2NrICFpbXBvcnRhbnQiICkKICAgICAgKS5hcHBlbmRUbyggZG9jLmRvY3VtZW50RWxlbWVudCApOwoKICAgICAgLy8gQWx3YXlzIHdyaXRlIGEgbmV3IEhUTUwgc2tlbGV0b24gc28gV2Via2l0IGFuZCBGaXJlZm94IGRvbid0IGNob2tlIG9uIHJldXNlCiAgICAgIGRvYyA9ICggaWZyYW1lWzBdLmNvbnRlbnRXaW5kb3cgfHwgaWZyYW1lWzBdLmNvbnRlbnREb2N1bWVudCApLmRvY3VtZW50OwogICAgICBkb2Mud3JpdGUoIjwhZG9jdHlwZSBodG1sPjxodG1sPjxib2R5PiIpOwogICAgICBkb2MuY2xvc2UoKTsKCiAgICAgIGRpc3BsYXkgPSBhY3R1YWxEaXNwbGF5KCBub2RlTmFtZSwgZG9jICk7CiAgICAgIGlmcmFtZS5kZXRhY2goKTsKICAgIH0KCiAgICAvLyBTdG9yZSB0aGUgY29ycmVjdCBkZWZhdWx0IGRpc3BsYXkKICAgIGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdID0gZGlzcGxheTsKICB9CgogIHJldHVybiBkaXNwbGF5Owp9CgovLyBDYWxsZWQgT05MWSBmcm9tIHdpdGhpbiBjc3NfZGVmYXVsdERpc3BsYXkKZnVuY3Rpb24gYWN0dWFsRGlzcGxheSggbmFtZSwgZG9jICkgewogIHZhciBlbGVtID0galF1ZXJ5KCBkb2MuY3JlYXRlRWxlbWVudCggbmFtZSApICkuYXBwZW5kVG8oIGRvYy5ib2R5ICksCiAgICBkaXNwbGF5ID0galF1ZXJ5LmNzcyggZWxlbVswXSwgImRpc3BsYXkiICk7CiAgZWxlbS5yZW1vdmUoKTsKICByZXR1cm4gZGlzcGxheTsKfQoKalF1ZXJ5LmVhY2goWyAiaGVpZ2h0IiwgIndpZHRoIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKICBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSA9IHsKICAgIGdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkLCBleHRyYSApIHsKICAgICAgaWYgKCBjb21wdXRlZCApIHsKICAgICAgICAvLyBjZXJ0YWluIGVsZW1lbnRzIGNhbiBoYXZlIGRpbWVuc2lvbiBpbmZvIGlmIHdlIGludmlzaWJseSBzaG93IHRoZW0KICAgICAgICAvLyBob3dldmVyLCBpdCBtdXN0IGhhdmUgYSBjdXJyZW50IGRpc3BsYXkgc3R5bGUgdGhhdCB3b3VsZCBiZW5lZml0IGZyb20gdGhpcwogICAgICAgIHJldHVybiBlbGVtLm9mZnNldFdpZHRoID09PSAwICYmIHJkaXNwbGF5c3dhcC50ZXN0KCBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSApID8KICAgICAgICAgIGpRdWVyeS5zd2FwKCBlbGVtLCBjc3NTaG93LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICk7CiAgICAgICAgICB9KSA6CiAgICAgICAgICBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApOwogICAgICB9CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBleHRyYSApIHsKICAgICAgdmFyIHN0eWxlcyA9IGV4dHJhICYmIGdldFN0eWxlcyggZWxlbSApOwogICAgICByZXR1cm4gc2V0UG9zaXRpdmVOdW1iZXIoIGVsZW0sIHZhbHVlLCBleHRyYSA/CiAgICAgICAgYXVnbWVudFdpZHRoT3JIZWlnaHQoCiAgICAgICAgICBlbGVtLAogICAgICAgICAgbmFtZSwKICAgICAgICAgIGV4dHJhLAogICAgICAgICAgalF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwKICAgICAgICAgIHN0eWxlcwogICAgICAgICkgOiAwCiAgICAgICk7CiAgICB9CiAgfTsKfSk7CgppZiAoICFqUXVlcnkuc3VwcG9ydC5vcGFjaXR5ICkgewogIGpRdWVyeS5jc3NIb29rcy5vcGFjaXR5ID0gewogICAgZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7CiAgICAgIC8vIElFIHVzZXMgZmlsdGVycyBmb3Igb3BhY2l0eQogICAgICByZXR1cm4gcm9wYWNpdHkudGVzdCggKGNvbXB1dGVkICYmIGVsZW0uY3VycmVudFN0eWxlID8gZWxlbS5jdXJyZW50U3R5bGUuZmlsdGVyIDogZWxlbS5zdHlsZS5maWx0ZXIpIHx8ICIiICkgPwogICAgICAgICggMC4wMSAqIHBhcnNlRmxvYXQoIFJlZ0V4cC4kMSApICkgKyAiIiA6CiAgICAgICAgY29tcHV0ZWQgPyAiMSIgOiAiIjsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CiAgICAgIHZhciBzdHlsZSA9IGVsZW0uc3R5bGUsCiAgICAgICAgY3VycmVudFN0eWxlID0gZWxlbS5jdXJyZW50U3R5bGUsCiAgICAgICAgb3BhY2l0eSA9IGpRdWVyeS5pc051bWVyaWMoIHZhbHVlICkgPyAiYWxwaGEob3BhY2l0eT0iICsgdmFsdWUgKiAxMDAgKyAiKSIgOiAiIiwKICAgICAgICBmaWx0ZXIgPSBjdXJyZW50U3R5bGUgJiYgY3VycmVudFN0eWxlLmZpbHRlciB8fCBzdHlsZS5maWx0ZXIgfHwgIiI7CgogICAgICAvLyBJRSBoYXMgdHJvdWJsZSB3aXRoIG9wYWNpdHkgaWYgaXQgZG9lcyBub3QgaGF2ZSBsYXlvdXQKICAgICAgLy8gRm9yY2UgaXQgYnkgc2V0dGluZyB0aGUgem9vbSBsZXZlbAogICAgICBzdHlsZS56b29tID0gMTsKCiAgICAgIC8vIGlmIHNldHRpbmcgb3BhY2l0eSB0byAxLCBhbmQgbm8gb3RoZXIgZmlsdGVycyBleGlzdCAtIGF0dGVtcHQgdG8gcmVtb3ZlIGZpbHRlciBhdHRyaWJ1dGUgIzY2NTIKICAgICAgLy8gaWYgdmFsdWUgPT09ICIiLCB0aGVuIHJlbW92ZSBpbmxpbmUgb3BhY2l0eSAjMTI2ODUKICAgICAgaWYgKCAoIHZhbHVlID49IDEgfHwgdmFsdWUgPT09ICIiICkgJiYKICAgICAgICAgIGpRdWVyeS50cmltKCBmaWx0ZXIucmVwbGFjZSggcmFscGhhLCAiIiApICkgPT09ICIiICYmCiAgICAgICAgICBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUgKSB7CgogICAgICAgIC8vIFNldHRpbmcgc3R5bGUuZmlsdGVyIHRvIG51bGwsICIiICYgIiAiIHN0aWxsIGxlYXZlICJmaWx0ZXI6IiBpbiB0aGUgY3NzVGV4dAogICAgICAgIC8vIGlmICJmaWx0ZXI6IiBpcyBwcmVzZW50IGF0IGFsbCwgY2xlYXJUeXBlIGlzIGRpc2FibGVkLCB3ZSB3YW50IHRvIGF2b2lkIHRoaXMKICAgICAgICAvLyBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUgaXMgSUUgT25seSwgYnV0IHNvIGFwcGFyZW50bHkgaXMgdGhpcyBjb2RlIHBhdGguLi4KICAgICAgICBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUoICJmaWx0ZXIiICk7CgogICAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIGZpbHRlciBzdHlsZSBhcHBsaWVkIGluIGEgY3NzIHJ1bGUgb3IgdW5zZXQgaW5saW5lIG9wYWNpdHksIHdlIGFyZSBkb25lCiAgICAgICAgaWYgKCB2YWx1ZSA9PT0gIiIgfHwgY3VycmVudFN0eWxlICYmICFjdXJyZW50U3R5bGUuZmlsdGVyICkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gb3RoZXJ3aXNlLCBzZXQgbmV3IGZpbHRlciB2YWx1ZXMKICAgICAgc3R5bGUuZmlsdGVyID0gcmFscGhhLnRlc3QoIGZpbHRlciApID8KICAgICAgICBmaWx0ZXIucmVwbGFjZSggcmFscGhhLCBvcGFjaXR5ICkgOgogICAgICAgIGZpbHRlciArICIgIiArIG9wYWNpdHk7CiAgICB9CiAgfTsKfQoKLy8gVGhlc2UgaG9va3MgY2Fubm90IGJlIGFkZGVkIHVudGlsIERPTSByZWFkeSBiZWNhdXNlIHRoZSBzdXBwb3J0IHRlc3QKLy8gZm9yIGl0IGlzIG5vdCBydW4gdW50aWwgYWZ0ZXIgRE9NIHJlYWR5CmpRdWVyeShmdW5jdGlvbigpIHsKICBpZiAoICFqUXVlcnkuc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ICkgewogICAgalF1ZXJ5LmNzc0hvb2tzLm1hcmdpblJpZ2h0ID0gewogICAgICBnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKICAgICAgICBpZiAoIGNvbXB1dGVkICkgewogICAgICAgICAgLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CiAgICAgICAgICAvLyBXb3JrIGFyb3VuZCBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIGVsZW1lbnQgZGlzcGxheSB0byBpbmxpbmUtYmxvY2sKICAgICAgICAgIHJldHVybiBqUXVlcnkuc3dhcCggZWxlbSwgeyAiZGlzcGxheSI6ICJpbmxpbmUtYmxvY2siIH0sCiAgICAgICAgICAgIGN1ckNTUywgWyBlbGVtLCAibWFyZ2luUmlnaHQiIF0gKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQoKICAvLyBXZWJraXQgYnVnOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MjkwODQKICAvLyBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgcGVyY2VudCB3aGVuIHNwZWNpZmllZCBmb3IgdG9wL2xlZnQvYm90dG9tL3JpZ2h0CiAgLy8gcmF0aGVyIHRoYW4gbWFrZSB0aGUgY3NzIG1vZHVsZSBkZXBlbmQgb24gdGhlIG9mZnNldCBtb2R1bGUsIHdlIGp1c3QgY2hlY2sgZm9yIGl0IGhlcmUKICBpZiAoICFqUXVlcnkuc3VwcG9ydC5waXhlbFBvc2l0aW9uICYmIGpRdWVyeS5mbi5wb3NpdGlvbiApIHsKICAgIGpRdWVyeS5lYWNoKCBbICJ0b3AiLCAibGVmdCIgXSwgZnVuY3Rpb24oIGksIHByb3AgKSB7CiAgICAgIGpRdWVyeS5jc3NIb29rc1sgcHJvcCBdID0gewogICAgICAgIGdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewogICAgICAgICAgaWYgKCBjb21wdXRlZCApIHsKICAgICAgICAgICAgY29tcHV0ZWQgPSBjdXJDU1MoIGVsZW0sIHByb3AgKTsKICAgICAgICAgICAgLy8gaWYgY3VyQ1NTIHJldHVybnMgcGVyY2VudGFnZSwgZmFsbGJhY2sgdG8gb2Zmc2V0CiAgICAgICAgICAgIHJldHVybiBybnVtbm9ucHgudGVzdCggY29tcHV0ZWQgKSA/CiAgICAgICAgICAgICAgalF1ZXJ5KCBlbGVtICkucG9zaXRpb24oKVsgcHJvcCBdICsgInB4IiA6CiAgICAgICAgICAgICAgY29tcHV0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfSk7CiAgfQoKfSk7CgppZiAoIGpRdWVyeS5leHByICYmIGpRdWVyeS5leHByLmZpbHRlcnMgKSB7CiAgalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKICAgIHJldHVybiAoIGVsZW0ub2Zmc2V0V2lkdGggPT09IDAgJiYgZWxlbS5vZmZzZXRIZWlnaHQgPT09IDAgKSB8fCAoIWpRdWVyeS5zdXBwb3J0LnJlbGlhYmxlSGlkZGVuT2Zmc2V0cyAmJiAoKGVsZW0uc3R5bGUgJiYgZWxlbS5zdHlsZS5kaXNwbGF5KSB8fCBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSkgPT09ICJub25lIik7CiAgfTsKCiAgalF1ZXJ5LmV4cHIuZmlsdGVycy52aXNpYmxlID0gZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gIWpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuKCBlbGVtICk7CiAgfTsKfQoKLy8gVGhlc2UgaG9va3MgYXJlIHVzZWQgYnkgYW5pbWF0ZSB0byBleHBhbmQgcHJvcGVydGllcwpqUXVlcnkuZWFjaCh7CiAgbWFyZ2luOiAiIiwKICBwYWRkaW5nOiAiIiwKICBib3JkZXI6ICJXaWR0aCIKfSwgZnVuY3Rpb24oIHByZWZpeCwgc3VmZml4ICkgewogIGpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0gPSB7CiAgICBleHBhbmQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgICAgdmFyIGkgPSAwLAogICAgICAgIGV4cGFuZGVkID0ge30sCgogICAgICAgIC8vIGFzc3VtZXMgYSBzaW5nbGUgbnVtYmVyIGlmIG5vdCBhIHN0cmluZwogICAgICAgIHBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIgIikgOiBbIHZhbHVlIF07CgogICAgICBmb3IgKCA7IGkgPCA0OyBpKysgKSB7CiAgICAgICAgZXhwYW5kZWRbIHByZWZpeCArIGNzc0V4cGFuZFsgaSBdICsgc3VmZml4IF0gPQogICAgICAgICAgcGFydHNbIGkgXSB8fCBwYXJ0c1sgaSAtIDIgXSB8fCBwYXJ0c1sgMCBdOwogICAgICB9CgogICAgICByZXR1cm4gZXhwYW5kZWQ7CiAgICB9CiAgfTsKCiAgaWYgKCAhcm1hcmdpbi50ZXN0KCBwcmVmaXggKSApIHsKICAgIGpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0uc2V0ID0gc2V0UG9zaXRpdmVOdW1iZXI7CiAgfQp9KTsKdmFyIHIyMCA9IC8lMjAvZywKICByYnJhY2tldCA9IC9cW1xdJC8sCiAgckNSTEYgPSAvXHI/XG4vZywKICByc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXQpJC9pLAogIHJzdWJtaXR0YWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGtleWdlbikvaTsKCmpRdWVyeS5mbi5leHRlbmQoewogIHNlcmlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4galF1ZXJ5LnBhcmFtKCB0aGlzLnNlcmlhbGl6ZUFycmF5KCkgKTsKICB9LAogIHNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpewogICAgICAvLyBDYW4gYWRkIHByb3BIb29rIGZvciAiZWxlbWVudHMiIHRvIGZpbHRlciBvciBhZGQgZm9ybSBlbGVtZW50cwogICAgICB2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCggdGhpcywgImVsZW1lbnRzIiApOwogICAgICByZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KCBlbGVtZW50cyApIDogdGhpczsKICAgIH0pCiAgICAuZmlsdGVyKGZ1bmN0aW9uKCl7CiAgICAgIHZhciB0eXBlID0gdGhpcy50eXBlOwogICAgICAvLyBVc2UgLmlzKCI6ZGlzYWJsZWQiKSBzbyB0aGF0IGZpZWxkc2V0W2Rpc2FibGVkXSB3b3JrcwogICAgICByZXR1cm4gdGhpcy5uYW1lICYmICFqUXVlcnkoIHRoaXMgKS5pcyggIjpkaXNhYmxlZCIgKSAmJgogICAgICAgIHJzdWJtaXR0YWJsZS50ZXN0KCB0aGlzLm5vZGVOYW1lICkgJiYgIXJzdWJtaXR0ZXJUeXBlcy50ZXN0KCB0eXBlICkgJiYKICAgICAgICAoIHRoaXMuY2hlY2tlZCB8fCAhbWFuaXB1bGF0aW9uX3JjaGVja2FibGVUeXBlLnRlc3QoIHR5cGUgKSApOwogICAgfSkKICAgIC5tYXAoZnVuY3Rpb24oIGksIGVsZW0gKXsKICAgICAgdmFyIHZhbCA9IGpRdWVyeSggdGhpcyApLnZhbCgpOwoKICAgICAgcmV0dXJuIHZhbCA9PSBudWxsID8KICAgICAgICBudWxsIDoKICAgICAgICBqUXVlcnkuaXNBcnJheSggdmFsICkgPwogICAgICAgICAgalF1ZXJ5Lm1hcCggdmFsLCBmdW5jdGlvbiggdmFsICl7CiAgICAgICAgICAgIHJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsKICAgICAgICAgIH0pIDoKICAgICAgICAgIHsgbmFtZTogZWxlbS5uYW1lLCB2YWx1ZTogdmFsLnJlcGxhY2UoIHJDUkxGLCAiXHJcbiIgKSB9OwogICAgfSkuZ2V0KCk7CiAgfQp9KTsKCi8vU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKLy9rZXkvdmFsdWVzIGludG8gYSBxdWVyeSBzdHJpbmcKalF1ZXJ5LnBhcmFtID0gZnVuY3Rpb24oIGEsIHRyYWRpdGlvbmFsICkgewogIHZhciBwcmVmaXgsCiAgICBzID0gW10sCiAgICBhZGQgPSBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKICAgICAgLy8gSWYgdmFsdWUgaXMgYSBmdW5jdGlvbiwgaW52b2tlIGl0IGFuZCByZXR1cm4gaXRzIHZhbHVlCiAgICAgIHZhbHVlID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgPyB2YWx1ZSgpIDogKCB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSApOwogICAgICBzWyBzLmxlbmd0aCBdID0gZW5jb2RlVVJJQ29tcG9uZW50KCBrZXkgKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCggdmFsdWUgKTsKICAgIH07CgogIC8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuCiAgaWYgKCB0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkICkgewogICAgdHJhZGl0aW9uYWwgPSBqUXVlcnkuYWpheFNldHRpbmdzICYmIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWw7CiAgfQoKICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogIGlmICggalF1ZXJ5LmlzQXJyYXkoIGEgKSB8fCAoIGEuanF1ZXJ5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdCggYSApICkgKSB7CiAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgIGpRdWVyeS5lYWNoKCBhLCBmdW5jdGlvbigpIHsKICAgICAgYWRkKCB0aGlzLm5hbWUsIHRoaXMudmFsdWUgKTsKICAgIH0pOwoKICB9IGVsc2UgewogICAgLy8gSWYgdHJhZGl0aW9uYWwsIGVuY29kZSB0aGUgIm9sZCIgd2F5ICh0aGUgd2F5IDEuMy4yIG9yIG9sZGVyCiAgICAvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KICAgIGZvciAoIHByZWZpeCBpbiBhICkgewogICAgICBidWlsZFBhcmFtcyggcHJlZml4LCBhWyBwcmVmaXggXSwgdHJhZGl0aW9uYWwsIGFkZCApOwogICAgfQogIH0KCiAgLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgogIHJldHVybiBzLmpvaW4oICImIiApLnJlcGxhY2UoIHIyMCwgIisiICk7Cn07CgpmdW5jdGlvbiBidWlsZFBhcmFtcyggcHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQgKSB7CiAgdmFyIG5hbWU7CgogIGlmICggalF1ZXJ5LmlzQXJyYXkoIG9iaiApICkgewogICAgLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCiAgICBqUXVlcnkuZWFjaCggb2JqLCBmdW5jdGlvbiggaSwgdiApIHsKICAgICAgaWYgKCB0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KCBwcmVmaXggKSApIHsKICAgICAgICAvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCiAgICAgICAgYWRkKCBwcmVmaXgsIHYgKTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzIG51bWVyaWMgaW5kZXguCiAgICAgICAgYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArICggdHlwZW9mIHYgPT09ICJvYmplY3QiID8gaSA6ICIiICkgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQgKTsKICAgICAgfQogICAgfSk7CgogIH0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZSggb2JqICkgPT09ICJvYmplY3QiICkgewogICAgLy8gU2VyaWFsaXplIG9iamVjdCBpdGVtLgogICAgZm9yICggbmFtZSBpbiBvYmogKSB7CiAgICAgIGJ1aWxkUGFyYW1zKCBwcmVmaXggKyAiWyIgKyBuYW1lICsgIl0iLCBvYmpbIG5hbWUgXSwgdHJhZGl0aW9uYWwsIGFkZCApOwogICAgfQoKICB9IGVsc2UgewogICAgLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgogICAgYWRkKCBwcmVmaXgsIG9iaiApOwogIH0KfQp2YXIKICAvLyBEb2N1bWVudCBsb2NhdGlvbgogIGFqYXhMb2NQYXJ0cywKICBhamF4TG9jYXRpb24sCiAgCiAgYWpheF9ub25jZSA9IGpRdWVyeS5ub3coKSwKCiAgYWpheF9ycXVlcnkgPSAvXD8vLAogIHJoYXNoID0gLyMuKiQvLAogIHJ0cyA9IC8oWz8mXSlfPVteJl0qLywKICByaGVhZGVycyA9IC9eKC4qPyk6WyBcdF0qKFteXHJcbl0qKVxyPyQvbWcsIC8vIElFIGxlYXZlcyBhbiBcciBjaGFyYWN0ZXIgYXQgRU9MCiAgLy8gIzc2NTMsICM4MTI1LCAjODE1MjogbG9jYWwgcHJvdG9jb2wgZGV0ZWN0aW9uCiAgcmxvY2FsUHJvdG9jb2wgPSAvXig/OmFib3V0fGFwcHxhcHAtc3RvcmFnZXwuKy1leHRlbnNpb258ZmlsZXxyZXN8d2lkZ2V0KTokLywKICBybm9Db250ZW50ID0gL14oPzpHRVR8SEVBRCkkLywKICBycHJvdG9jb2wgPSAvXlwvXC8vLAogIHJ1cmwgPSAvXihbXHcuKy1dKzopKD86XC9cLyhbXlwvPyM6XSopKD86OihcZCspfCl8KS8sCgogIC8vIEtlZXAgYSBjb3B5IG9mIHRoZSBvbGQgbG9hZCBtZXRob2QKICBfbG9hZCA9IGpRdWVyeS5mbi5sb2FkLAoKICAvKiBQcmVmaWx0ZXJzCiAgICogMSkgVGhleSBhcmUgdXNlZnVsIHRvIGludHJvZHVjZSBjdXN0b20gZGF0YVR5cGVzIChzZWUgYWpheC9qc29ucC5qcyBmb3IgYW4gZXhhbXBsZSkKICAgKiAyKSBUaGVzZSBhcmUgY2FsbGVkOgogICAqICAgIC0gQkVGT1JFIGFza2luZyBmb3IgYSB0cmFuc3BvcnQKICAgKiAgICAtIEFGVEVSIHBhcmFtIHNlcmlhbGl6YXRpb24gKHMuZGF0YSBpcyBhIHN0cmluZyBpZiBzLnByb2Nlc3NEYXRhIGlzIHRydWUpCiAgICogMykga2V5IGlzIHRoZSBkYXRhVHlwZQogICAqIDQpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICogNSkgZXhlY3V0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gY29udGludWUgZG93biB0byAiKiIgaWYgbmVlZGVkCiAgICovCiAgcHJlZmlsdGVycyA9IHt9LAoKICAvKiBUcmFuc3BvcnRzIGJpbmRpbmdzCiAgICogMSkga2V5IGlzIHRoZSBkYXRhVHlwZQogICAqIDIpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZAogICAqLwogIHRyYW5zcG9ydHMgPSB7fSwKCiAgLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCiAgYWxsVHlwZXMgPSAiKi8iLmNvbmNhdCgiKiIpOwoKLy8gIzgxMzgsIElFIG1heSB0aHJvdyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKLy8gYSBmaWVsZCBmcm9tIHdpbmRvdy5sb2NhdGlvbiBpZiBkb2N1bWVudC5kb21haW4gaGFzIGJlZW4gc2V0CnRyeSB7CiAgYWpheExvY2F0aW9uID0gbG9jYXRpb24uaHJlZjsKfSBjYXRjaCggZSApIHsKICAvLyBVc2UgdGhlIGhyZWYgYXR0cmlidXRlIG9mIGFuIEEgZWxlbWVudAogIC8vIHNpbmNlIElFIHdpbGwgbW9kaWZ5IGl0IGdpdmVuIGRvY3VtZW50LmxvY2F0aW9uCiAgYWpheExvY2F0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CiAgYWpheExvY2F0aW9uLmhyZWYgPSAiIjsKICBhamF4TG9jYXRpb24gPSBhamF4TG9jYXRpb24uaHJlZjsKfQoKLy8gU2VnbWVudCBsb2NhdGlvbiBpbnRvIHBhcnRzCmFqYXhMb2NQYXJ0cyA9IHJ1cmwuZXhlYyggYWpheExvY2F0aW9uLnRvTG93ZXJDYXNlKCkgKSB8fCBbXTsKCi8vIEJhc2UgImNvbnN0cnVjdG9yIiBmb3IgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIgYW5kIGpRdWVyeS5hamF4VHJhbnNwb3J0CmZ1bmN0aW9uIGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlICkgewoKICAvLyBkYXRhVHlwZUV4cHJlc3Npb24gaXMgb3B0aW9uYWwgYW5kIGRlZmF1bHRzIHRvICIqIgogIHJldHVybiBmdW5jdGlvbiggZGF0YVR5cGVFeHByZXNzaW9uLCBmdW5jICkgewoKICAgIGlmICggdHlwZW9mIGRhdGFUeXBlRXhwcmVzc2lvbiAhPT0gInN0cmluZyIgKSB7CiAgICAgIGZ1bmMgPSBkYXRhVHlwZUV4cHJlc3Npb247CiAgICAgIGRhdGFUeXBlRXhwcmVzc2lvbiA9ICIqIjsKICAgIH0KCiAgICB2YXIgZGF0YVR5cGUsCiAgICAgIGkgPSAwLAogICAgICBkYXRhVHlwZXMgPSBkYXRhVHlwZUV4cHJlc3Npb24udG9Mb3dlckNhc2UoKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbXTsKCiAgICBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBmdW5jICkgKSB7CiAgICAgIC8vIEZvciBlYWNoIGRhdGFUeXBlIGluIHRoZSBkYXRhVHlwZUV4cHJlc3Npb24KICAgICAgd2hpbGUgKCAoZGF0YVR5cGUgPSBkYXRhVHlwZXNbaSsrXSkgKSB7CiAgICAgICAgLy8gUHJlcGVuZCBpZiByZXF1ZXN0ZWQKICAgICAgICBpZiAoIGRhdGFUeXBlWzBdID09PSAiKyIgKSB7CiAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlLnNsaWNlKCAxICkgfHwgIioiOwogICAgICAgICAgKHN0cnVjdHVyZVsgZGF0YVR5cGUgXSA9IHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXSkudW5zaGlmdCggZnVuYyApOwoKICAgICAgICAvLyBPdGhlcndpc2UgYXBwZW5kCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIChzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10pLnB1c2goIGZ1bmMgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Owp9CgovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMKZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApIHsKCiAgdmFyIGluc3BlY3RlZCA9IHt9LAogICAgc2Vla2luZ1RyYW5zcG9ydCA9ICggc3RydWN0dXJlID09PSB0cmFuc3BvcnRzICk7CgogIGZ1bmN0aW9uIGluc3BlY3QoIGRhdGFUeXBlICkgewogICAgdmFyIHNlbGVjdGVkOwogICAgaW5zcGVjdGVkWyBkYXRhVHlwZSBdID0gdHJ1ZTsKICAgIGpRdWVyeS5lYWNoKCBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10sIGZ1bmN0aW9uKCBfLCBwcmVmaWx0ZXJPckZhY3RvcnkgKSB7CiAgICAgIHZhciBkYXRhVHlwZU9yVHJhbnNwb3J0ID0gcHJlZmlsdGVyT3JGYWN0b3J5KCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSICk7CiAgICAgIGlmKCB0eXBlb2YgZGF0YVR5cGVPclRyYW5zcG9ydCA9PT0gInN0cmluZyIgJiYgIXNlZWtpbmdUcmFuc3BvcnQgJiYgIWluc3BlY3RlZFsgZGF0YVR5cGVPclRyYW5zcG9ydCBdICkgewogICAgICAgIG9wdGlvbnMuZGF0YVR5cGVzLnVuc2hpZnQoIGRhdGFUeXBlT3JUcmFuc3BvcnQgKTsKICAgICAgICBpbnNwZWN0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgaWYgKCBzZWVraW5nVHJhbnNwb3J0ICkgewogICAgICAgIHJldHVybiAhKCBzZWxlY3RlZCA9IGRhdGFUeXBlT3JUcmFuc3BvcnQgKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gc2VsZWN0ZWQ7CiAgfQoKICByZXR1cm4gaW5zcGVjdCggb3B0aW9ucy5kYXRhVHlwZXNbIDAgXSApIHx8ICFpbnNwZWN0ZWRbICIqIiBdICYmIGluc3BlY3QoICIqIiApOwp9CgovLyBBIHNwZWNpYWwgZXh0ZW5kIGZvciBhamF4IG9wdGlvbnMKLy8gdGhhdCB0YWtlcyAiZmxhdCIgb3B0aW9ucyAobm90IHRvIGJlIGRlZXAgZXh0ZW5kZWQpCi8vIEZpeGVzICM5ODg3CmZ1bmN0aW9uIGFqYXhFeHRlbmQoIHRhcmdldCwgc3JjICkgewogIHZhciBrZXksIGRlZXAsCiAgICBmbGF0T3B0aW9ucyA9IGpRdWVyeS5hamF4U2V0dGluZ3MuZmxhdE9wdGlvbnMgfHwge307CgogIGZvciAoIGtleSBpbiBzcmMgKSB7CiAgICBpZiAoIHNyY1sga2V5IF0gIT09IHVuZGVmaW5lZCApIHsKICAgICAgKCBmbGF0T3B0aW9uc1sga2V5IF0gPyB0YXJnZXQgOiAoIGRlZXAgfHwgKGRlZXAgPSB7fSkgKSApWyBrZXkgXSA9IHNyY1sga2V5IF07CiAgICB9CiAgfQogIGlmICggZGVlcCApIHsKICAgIGpRdWVyeS5leHRlbmQoIHRydWUsIHRhcmdldCwgZGVlcCApOwogIH0KCiAgcmV0dXJuIHRhcmdldDsKfQoKalF1ZXJ5LmZuLmxvYWQgPSBmdW5jdGlvbiggdXJsLCBwYXJhbXMsIGNhbGxiYWNrICkgewogIGlmICggdHlwZW9mIHVybCAhPT0gInN0cmluZyIgJiYgX2xvYWQgKSB7CiAgICByZXR1cm4gX2xvYWQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogIH0KCiAgdmFyIHNlbGVjdG9yLCB0eXBlLCByZXNwb25zZSwKICAgIHNlbGYgPSB0aGlzLAogICAgb2ZmID0gdXJsLmluZGV4T2YoIiAiKTsKCiAgaWYgKCBvZmYgPj0gMCApIHsKICAgIHNlbGVjdG9yID0gdXJsLnNsaWNlKCBvZmYsIHVybC5sZW5ndGggKTsKICAgIHVybCA9IHVybC5zbGljZSggMCwgb2ZmICk7CiAgfQoKICAvLyBJZiBpdCdzIGEgZnVuY3Rpb24KICBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwYXJhbXMgKSApIHsKCiAgICAvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawogICAgY2FsbGJhY2sgPSBwYXJhbXM7CiAgICBwYXJhbXMgPSB1bmRlZmluZWQ7CgogIC8vIE90aGVyd2lzZSwgYnVpbGQgYSBwYXJhbSBzdHJpbmcKICB9IGVsc2UgaWYgKCBwYXJhbXMgJiYgdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSB7CiAgICB0eXBlID0gIlBPU1QiOwogIH0KCiAgLy8gSWYgd2UgaGF2ZSBlbGVtZW50cyB0byBtb2RpZnksIG1ha2UgdGhlIHJlcXVlc3QKICBpZiAoIHNlbGYubGVuZ3RoID4gMCApIHsKICAgIGpRdWVyeS5hamF4KHsKICAgICAgdXJsOiB1cmwsCgogICAgICAvLyBpZiAidHlwZSIgdmFyaWFibGUgaXMgdW5kZWZpbmVkLCB0aGVuICJHRVQiIG1ldGhvZCB3aWxsIGJlIHVzZWQKICAgICAgdHlwZTogdHlwZSwKICAgICAgZGF0YVR5cGU6ICJodG1sIiwKICAgICAgZGF0YTogcGFyYW1zCiAgICB9KS5kb25lKGZ1bmN0aW9uKCByZXNwb25zZVRleHQgKSB7CgogICAgICAvLyBTYXZlIHJlc3BvbnNlIGZvciB1c2UgaW4gY29tcGxldGUgY2FsbGJhY2sKICAgICAgcmVzcG9uc2UgPSBhcmd1bWVudHM7CgogICAgICBzZWxmLmh0bWwoIHNlbGVjdG9yID8KCiAgICAgICAgLy8gSWYgYSBzZWxlY3RvciB3YXMgc3BlY2lmaWVkLCBsb2NhdGUgdGhlIHJpZ2h0IGVsZW1lbnRzIGluIGEgZHVtbXkgZGl2CiAgICAgICAgLy8gRXhjbHVkZSBzY3JpcHRzIHRvIGF2b2lkIElFICdQZXJtaXNzaW9uIERlbmllZCcgZXJyb3JzCiAgICAgICAgalF1ZXJ5KCI8ZGl2PiIpLmFwcGVuZCggalF1ZXJ5LnBhcnNlSFRNTCggcmVzcG9uc2VUZXh0ICkgKS5maW5kKCBzZWxlY3RvciApIDoKCiAgICAgICAgLy8gT3RoZXJ3aXNlIHVzZSB0aGUgZnVsbCByZXN1bHQKICAgICAgICByZXNwb25zZVRleHQgKTsKCiAgICB9KS5jb21wbGV0ZSggY2FsbGJhY2sgJiYgZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CiAgICAgIHNlbGYuZWFjaCggY2FsbGJhY2ssIHJlc3BvbnNlIHx8IFsganFYSFIucmVzcG9uc2VUZXh0LCBzdGF0dXMsIGpxWEhSIF0gKTsKICAgIH0pOwogIH0KCiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBdHRhY2ggYSBidW5jaCBvZiBmdW5jdGlvbnMgZm9yIGhhbmRsaW5nIGNvbW1vbiBBSkFYIGV2ZW50cwpqUXVlcnkuZWFjaCggWyAiYWpheFN0YXJ0IiwgImFqYXhTdG9wIiwgImFqYXhDb21wbGV0ZSIsICJhamF4RXJyb3IiLCAiYWpheFN1Y2Nlc3MiLCAiYWpheFNlbmQiIF0sIGZ1bmN0aW9uKCBpLCB0eXBlICl7CiAgalF1ZXJ5LmZuWyB0eXBlIF0gPSBmdW5jdGlvbiggZm4gKXsKICAgIHJldHVybiB0aGlzLm9uKCB0eXBlLCBmbiApOwogIH07Cn0pOwoKalF1ZXJ5LmVhY2goIFsgImdldCIsICJwb3N0IiBdLCBmdW5jdGlvbiggaSwgbWV0aG9kICkgewogIGpRdWVyeVsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKICAgIC8vIHNoaWZ0IGFyZ3VtZW50cyBpZiBkYXRhIGFyZ3VtZW50IHdhcyBvbWl0dGVkCiAgICBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CiAgICAgIHR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwogICAgICBjYWxsYmFjayA9IGRhdGE7CiAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgcmV0dXJuIGpRdWVyeS5hamF4KHsKICAgICAgdXJsOiB1cmwsCiAgICAgIHR5cGU6IG1ldGhvZCwKICAgICAgZGF0YVR5cGU6IHR5cGUsCiAgICAgIGRhdGE6IGRhdGEsCiAgICAgIHN1Y2Nlc3M6IGNhbGxiYWNrCiAgICB9KTsKICB9Owp9KTsKCmpRdWVyeS5leHRlbmQoewoKICAvLyBDb3VudGVyIGZvciBob2xkaW5nIHRoZSBudW1iZXIgb2YgYWN0aXZlIHF1ZXJpZXMKICBhY3RpdmU6IDAsCgogIC8vIExhc3QtTW9kaWZpZWQgaGVhZGVyIGNhY2hlIGZvciBuZXh0IHJlcXVlc3QKICBsYXN0TW9kaWZpZWQ6IHt9LAogIGV0YWc6IHt9LAoKICBhamF4U2V0dGluZ3M6IHsKICAgIHVybDogYWpheExvY2F0aW9uLAogICAgdHlwZTogIkdFVCIsCiAgICBpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KCBhamF4TG9jUGFydHNbIDEgXSApLAogICAgZ2xvYmFsOiB0cnVlLAogICAgcHJvY2Vzc0RhdGE6IHRydWUsCiAgICBhc3luYzogdHJ1ZSwKICAgIGNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04IiwKICAgIC8qCiAgICB0aW1lb3V0OiAwLAogICAgZGF0YTogbnVsbCwKICAgIGRhdGFUeXBlOiBudWxsLAogICAgdXNlcm5hbWU6IG51bGwsCiAgICBwYXNzd29yZDogbnVsbCwKICAgIGNhY2hlOiBudWxsLAogICAgdGhyb3dzOiBmYWxzZSwKICAgIHRyYWRpdGlvbmFsOiBmYWxzZSwKICAgIGhlYWRlcnM6IHt9LAogICAgKi8KCiAgICBhY2NlcHRzOiB7CiAgICAgICIqIjogYWxsVHlwZXMsCiAgICAgIHRleHQ6ICJ0ZXh0L3BsYWluIiwKICAgICAgaHRtbDogInRleHQvaHRtbCIsCiAgICAgIHhtbDogImFwcGxpY2F0aW9uL3htbCwgdGV4dC94bWwiLAogICAgICBqc29uOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0IgogICAgfSwKCiAgICBjb250ZW50czogewogICAgICB4bWw6IC94bWwvLAogICAgICBodG1sOiAvaHRtbC8sCiAgICAgIGpzb246IC9qc29uLwogICAgfSwKCiAgICByZXNwb25zZUZpZWxkczogewogICAgICB4bWw6ICJyZXNwb25zZVhNTCIsCiAgICAgIHRleHQ6ICJyZXNwb25zZVRleHQiCiAgICB9LAoKICAgIC8vIERhdGEgY29udmVydGVycwogICAgLy8gS2V5cyBzZXBhcmF0ZSBzb3VyY2UgKG9yIGNhdGNoYWxsICIqIikgYW5kIGRlc3RpbmF0aW9uIHR5cGVzIHdpdGggYSBzaW5nbGUgc3BhY2UKICAgIGNvbnZlcnRlcnM6IHsKCiAgICAgIC8vIENvbnZlcnQgYW55dGhpbmcgdG8gdGV4dAogICAgICAiKiB0ZXh0Ijogd2luZG93LlN0cmluZywKCiAgICAgIC8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQogICAgICAidGV4dCBodG1sIjogdHJ1ZSwKCiAgICAgIC8vIEV2YWx1YXRlIHRleHQgYXMgYSBqc29uIGV4cHJlc3Npb24KICAgICAgInRleHQganNvbiI6IGpRdWVyeS5wYXJzZUpTT04sCgogICAgICAvLyBQYXJzZSB0ZXh0IGFzIHhtbAogICAgICAidGV4dCB4bWwiOiBqUXVlcnkucGFyc2VYTUwKICAgIH0sCgogICAgLy8gRm9yIG9wdGlvbnMgdGhhdCBzaG91bGRuJ3QgYmUgZGVlcCBleHRlbmRlZDoKICAgIC8vIHlvdSBjYW4gYWRkIHlvdXIgb3duIGN1c3RvbSBvcHRpb25zIGhlcmUgaWYKICAgIC8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCiAgICAvLyBkZWVwIGV4dGVuZGVkIChzZWUgYWpheEV4dGVuZCkKICAgIGZsYXRPcHRpb25zOiB7CiAgICAgIHVybDogdHJ1ZSwKICAgICAgY29udGV4dDogdHJ1ZQogICAgfQogIH0sCgogIC8vIENyZWF0ZXMgYSBmdWxsIGZsZWRnZWQgc2V0dGluZ3Mgb2JqZWN0IGludG8gdGFyZ2V0CiAgLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgogIC8vIElmIHRhcmdldCBpcyBvbWl0dGVkLCB3cml0ZXMgaW50byBhamF4U2V0dGluZ3MuCiAgYWpheFNldHVwOiBmdW5jdGlvbiggdGFyZ2V0LCBzZXR0aW5ncyApIHsKICAgIHJldHVybiBzZXR0aW5ncyA/CgogICAgICAvLyBCdWlsZGluZyBhIHNldHRpbmdzIG9iamVjdAogICAgICBhamF4RXh0ZW5kKCBhamF4RXh0ZW5kKCB0YXJnZXQsIGpRdWVyeS5hamF4U2V0dGluZ3MgKSwgc2V0dGluZ3MgKSA6CgogICAgICAvLyBFeHRlbmRpbmcgYWpheFNldHRpbmdzCiAgICAgIGFqYXhFeHRlbmQoIGpRdWVyeS5hamF4U2V0dGluZ3MsIHRhcmdldCApOwogIH0sCgogIGFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycyApLAogIGFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cyApLAoKICAvLyBNYWluIG1ldGhvZAogIGFqYXg6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgogICAgLy8gSWYgdXJsIGlzIGFuIG9iamVjdCwgc2ltdWxhdGUgcHJlLTEuNSBzaWduYXR1cmUKICAgIGlmICggdHlwZW9mIHVybCA9PT0gIm9iamVjdCIgKSB7CiAgICAgIG9wdGlvbnMgPSB1cmw7CiAgICAgIHVybCA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICAvLyBGb3JjZSBvcHRpb25zIHRvIGJlIGFuIG9iamVjdAogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgdmFyIHRyYW5zcG9ydCwKICAgICAgLy8gVVJMIHdpdGhvdXQgYW50aS1jYWNoZSBwYXJhbQogICAgICBjYWNoZVVSTCwKICAgICAgLy8gUmVzcG9uc2UgaGVhZGVycwogICAgICByZXNwb25zZUhlYWRlcnNTdHJpbmcsCiAgICAgIHJlc3BvbnNlSGVhZGVycywKICAgICAgLy8gdGltZW91dCBoYW5kbGUKICAgICAgdGltZW91dFRpbWVyLAogICAgICAvLyBDcm9zcy1kb21haW4gZGV0ZWN0aW9uIHZhcnMKICAgICAgcGFydHMsCiAgICAgIC8vIFRvIGtub3cgaWYgZ2xvYmFsIGV2ZW50cyBhcmUgdG8gYmUgZGlzcGF0Y2hlZAogICAgICBmaXJlR2xvYmFscywKICAgICAgLy8gTG9vcCB2YXJpYWJsZQogICAgICBpLAogICAgICAvLyBDcmVhdGUgdGhlIGZpbmFsIG9wdGlvbnMgb2JqZWN0CiAgICAgIHMgPSBqUXVlcnkuYWpheFNldHVwKCB7fSwgb3B0aW9ucyApLAogICAgICAvLyBDYWxsYmFja3MgY29udGV4dAogICAgICBjYWxsYmFja0NvbnRleHQgPSBzLmNvbnRleHQgfHwgcywKICAgICAgLy8gQ29udGV4dCBmb3IgZ2xvYmFsIGV2ZW50cyBpcyBjYWxsYmFja0NvbnRleHQgaWYgaXQgaXMgYSBET00gbm9kZSBvciBqUXVlcnkgY29sbGVjdGlvbgogICAgICBnbG9iYWxFdmVudENvbnRleHQgPSBzLmNvbnRleHQgJiYgKCBjYWxsYmFja0NvbnRleHQubm9kZVR5cGUgfHwgY2FsbGJhY2tDb250ZXh0LmpxdWVyeSApID8KICAgICAgICBqUXVlcnkoIGNhbGxiYWNrQ29udGV4dCApIDoKICAgICAgICBqUXVlcnkuZXZlbnQsCiAgICAgIC8vIERlZmVycmVkcwogICAgICBkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLAogICAgICBjb21wbGV0ZURlZmVycmVkID0galF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwKICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgc3RhdHVzQ29kZSA9IHMuc3RhdHVzQ29kZSB8fCB7fSwKICAgICAgLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkKICAgICAgcmVxdWVzdEhlYWRlcnMgPSB7fSwKICAgICAgcmVxdWVzdEhlYWRlcnNOYW1lcyA9IHt9LAogICAgICAvLyBUaGUganFYSFIgc3RhdGUKICAgICAgc3RhdGUgPSAwLAogICAgICAvLyBEZWZhdWx0IGFib3J0IG1lc3NhZ2UKICAgICAgc3RyQWJvcnQgPSAiY2FuY2VsZWQiLAogICAgICAvLyBGYWtlIHhocgogICAgICBqcVhIUiA9IHsKICAgICAgICByZWFkeVN0YXRlOiAwLAoKICAgICAgICAvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCiAgICAgICAgZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uKCBrZXkgKSB7CiAgICAgICAgICB2YXIgbWF0Y2g7CiAgICAgICAgICBpZiAoIHN0YXRlID09PSAyICkgewogICAgICAgICAgICBpZiAoICFyZXNwb25zZUhlYWRlcnMgKSB7CiAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzID0ge307CiAgICAgICAgICAgICAgd2hpbGUgKCAobWF0Y2ggPSByaGVhZGVycy5leGVjKCByZXNwb25zZUhlYWRlcnNTdHJpbmcgKSkgKSB7CiAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnNbIG1hdGNoWzFdLnRvTG93ZXJDYXNlKCkgXSA9IG1hdGNoWyAyIF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hdGNoID0gcmVzcG9uc2VIZWFkZXJzWyBrZXkudG9Mb3dlckNhc2UoKSBdOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoID09IG51bGwgPyBudWxsIDogbWF0Y2g7CiAgICAgICAgfSwKCiAgICAgICAgLy8gUmF3IHN0cmluZwogICAgICAgIGdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gc3RhdGUgPT09IDIgPyByZXNwb25zZUhlYWRlcnNTdHJpbmcgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8vIENhY2hlcyB0aGUgaGVhZGVyCiAgICAgICAgc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewogICAgICAgICAgdmFyIGxuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYgKCAhc3RhdGUgKSB7CiAgICAgICAgICAgIG5hbWUgPSByZXF1ZXN0SGVhZGVyc05hbWVzWyBsbmFtZSBdID0gcmVxdWVzdEhlYWRlcnNOYW1lc1sgbG5hbWUgXSB8fCBuYW1lOwogICAgICAgICAgICByZXF1ZXN0SGVhZGVyc1sgbmFtZSBdID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAvLyBPdmVycmlkZXMgcmVzcG9uc2UgY29udGVudC10eXBlIGhlYWRlcgogICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IGZ1bmN0aW9uKCB0eXBlICkgewogICAgICAgICAgaWYgKCAhc3RhdGUgKSB7CiAgICAgICAgICAgIHMubWltZVR5cGUgPSB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICBzdGF0dXNDb2RlOiBmdW5jdGlvbiggbWFwICkgewogICAgICAgICAgdmFyIGNvZGU7CiAgICAgICAgICBpZiAoIG1hcCApIHsKICAgICAgICAgICAgaWYgKCBzdGF0ZSA8IDIgKSB7CiAgICAgICAgICAgICAgZm9yICggY29kZSBpbiBtYXAgKSB7CiAgICAgICAgICAgICAgICAvLyBMYXp5LWFkZCB0aGUgbmV3IGNhbGxiYWNrIGluIGEgd2F5IHRoYXQgcHJlc2VydmVzIG9sZCBvbmVzCiAgICAgICAgICAgICAgICBzdGF0dXNDb2RlWyBjb2RlIF0gPSBbIHN0YXR1c0NvZGVbIGNvZGUgXSwgbWFwWyBjb2RlIF0gXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gRXhlY3V0ZSB0aGUgYXBwcm9wcmlhdGUgY2FsbGJhY2tzCiAgICAgICAgICAgICAganFYSFIuYWx3YXlzKCBtYXBbIGpxWEhSLnN0YXR1cyBdICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8vIENhbmNlbCB0aGUgcmVxdWVzdAogICAgICAgIGFib3J0OiBmdW5jdGlvbiggc3RhdHVzVGV4dCApIHsKICAgICAgICAgIHZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0OwogICAgICAgICAgaWYgKCB0cmFuc3BvcnQgKSB7CiAgICAgICAgICAgIHRyYW5zcG9ydC5hYm9ydCggZmluYWxUZXh0ICk7CiAgICAgICAgICB9CiAgICAgICAgICBkb25lKCAwLCBmaW5hbFRleHQgKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgfTsKCiAgICAvLyBBdHRhY2ggZGVmZXJyZWRzCiAgICBkZWZlcnJlZC5wcm9taXNlKCBqcVhIUiApLmNvbXBsZXRlID0gY29tcGxldGVEZWZlcnJlZC5hZGQ7CiAgICBqcVhIUi5zdWNjZXNzID0ganFYSFIuZG9uZTsKICAgIGpxWEhSLmVycm9yID0ganFYSFIuZmFpbDsKCiAgICAvLyBSZW1vdmUgaGFzaCBjaGFyYWN0ZXIgKCM3NTMxOiBhbmQgc3RyaW5nIHByb21vdGlvbikKICAgIC8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKCM1ODY2OiBJRTcgaXNzdWUgd2l0aCBwcm90b2NvbC1sZXNzIHVybHMpCiAgICAvLyBIYW5kbGUgZmFsc3kgdXJsIGluIHRoZSBzZXR0aW5ncyBvYmplY3QgKCMxMDA5MzogY29uc2lzdGVuY3kgd2l0aCBvbGQgc2lnbmF0dXJlKQogICAgLy8gV2UgYWxzbyB1c2UgdGhlIHVybCBwYXJhbWV0ZXIgaWYgYXZhaWxhYmxlCiAgICBzLnVybCA9ICggKCB1cmwgfHwgcy51cmwgfHwgYWpheExvY2F0aW9uICkgKyAiIiApLnJlcGxhY2UoIHJoYXNoLCAiIiApLnJlcGxhY2UoIHJwcm90b2NvbCwgYWpheExvY1BhcnRzWyAxIF0gKyAiLy8iICk7CgogICAgLy8gQWxpYXMgbWV0aG9kIG9wdGlvbiB0byB0eXBlIGFzIHBlciB0aWNrZXQgIzEyMDA0CiAgICBzLnR5cGUgPSBvcHRpb25zLm1ldGhvZCB8fCBvcHRpb25zLnR5cGUgfHwgcy5tZXRob2QgfHwgcy50eXBlOwoKICAgIC8vIEV4dHJhY3QgZGF0YVR5cGVzIGxpc3QKICAgIHMuZGF0YVR5cGVzID0galF1ZXJ5LnRyaW0oIHMuZGF0YVR5cGUgfHwgIioiICkudG9Mb3dlckNhc2UoKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbIiJdOwoKICAgIC8vIEEgY3Jvc3MtZG9tYWluIHJlcXVlc3QgaXMgaW4gb3JkZXIgd2hlbiB3ZSBoYXZlIGEgcHJvdG9jb2w6aG9zdDpwb3J0IG1pc21hdGNoCiAgICBpZiAoIHMuY3Jvc3NEb21haW4gPT0gbnVsbCApIHsKICAgICAgcGFydHMgPSBydXJsLmV4ZWMoIHMudXJsLnRvTG93ZXJDYXNlKCkgKTsKICAgICAgcy5jcm9zc0RvbWFpbiA9ICEhKCBwYXJ0cyAmJgogICAgICAgICggcGFydHNbIDEgXSAhPT0gYWpheExvY1BhcnRzWyAxIF0gfHwgcGFydHNbIDIgXSAhPT0gYWpheExvY1BhcnRzWyAyIF0gfHwKICAgICAgICAgICggcGFydHNbIDMgXSB8fCAoIHBhcnRzWyAxIF0gPT09ICJodHRwOiIgPyA4MCA6IDQ0MyApICkgIT0KICAgICAgICAgICAgKCBhamF4TG9jUGFydHNbIDMgXSB8fCAoIGFqYXhMb2NQYXJ0c1sgMSBdID09PSAiaHR0cDoiID8gODAgOiA0NDMgKSApICkKICAgICAgKTsKICAgIH0KCiAgICAvLyBDb252ZXJ0IGRhdGEgaWYgbm90IGFscmVhZHkgYSBzdHJpbmcKICAgIGlmICggcy5kYXRhICYmIHMucHJvY2Vzc0RhdGEgJiYgdHlwZW9mIHMuZGF0YSAhPT0gInN0cmluZyIgKSB7CiAgICAgIHMuZGF0YSA9IGpRdWVyeS5wYXJhbSggcy5kYXRhLCBzLnRyYWRpdGlvbmFsICk7CiAgICB9CgogICAgLy8gQXBwbHkgcHJlZmlsdGVycwogICAgaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHByZWZpbHRlcnMsIHMsIG9wdGlvbnMsIGpxWEhSICk7CgogICAgLy8gSWYgcmVxdWVzdCB3YXMgYWJvcnRlZCBpbnNpZGUgYSBwcmVmaWx0ZXIsIHN0b3AgdGhlcmUKICAgIGlmICggc3RhdGUgPT09IDIgKSB7CiAgICAgIHJldHVybiBqcVhIUjsKICAgIH0KCiAgICAvLyBXZSBjYW4gZmlyZSBnbG9iYWwgZXZlbnRzIGFzIG9mIG5vdyBpZiBhc2tlZCB0bwogICAgZmlyZUdsb2JhbHMgPSBzLmdsb2JhbDsKCiAgICAvLyBXYXRjaCBmb3IgYSBuZXcgc2V0IG9mIHJlcXVlc3RzCiAgICBpZiAoIGZpcmVHbG9iYWxzICYmIGpRdWVyeS5hY3RpdmUrKyA9PT0gMCApIHsKICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoImFqYXhTdGFydCIpOwogICAgfQoKICAgIC8vIFVwcGVyY2FzZSB0aGUgdHlwZQogICAgcy50eXBlID0gcy50eXBlLnRvVXBwZXJDYXNlKCk7CgogICAgLy8gRGV0ZXJtaW5lIGlmIHJlcXVlc3QgaGFzIGNvbnRlbnQKICAgIHMuaGFzQ29udGVudCA9ICFybm9Db250ZW50LnRlc3QoIHMudHlwZSApOwoKICAgIC8vIFNhdmUgdGhlIFVSTCBpbiBjYXNlIHdlJ3JlIHRveWluZyB3aXRoIHRoZSBJZi1Nb2RpZmllZC1TaW5jZQogICAgLy8gYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyIGxhdGVyIG9uCiAgICBjYWNoZVVSTCA9IHMudXJsOwoKICAgIC8vIE1vcmUgb3B0aW9ucyBoYW5kbGluZyBmb3IgcmVxdWVzdHMgd2l0aCBubyBjb250ZW50CiAgICBpZiAoICFzLmhhc0NvbnRlbnQgKSB7CgogICAgICAvLyBJZiBkYXRhIGlzIGF2YWlsYWJsZSwgYXBwZW5kIGRhdGEgdG8gdXJsCiAgICAgIGlmICggcy5kYXRhICkgewogICAgICAgIGNhY2hlVVJMID0gKCBzLnVybCArPSAoIGFqYXhfcnF1ZXJ5LnRlc3QoIGNhY2hlVVJMICkgPyAiJiIgOiAiPyIgKSArIHMuZGF0YSApOwogICAgICAgIC8vICM5NjgyOiByZW1vdmUgZGF0YSBzbyB0aGF0IGl0J3Mgbm90IHVzZWQgaW4gYW4gZXZlbnR1YWwgcmV0cnkKICAgICAgICBkZWxldGUgcy5kYXRhOwogICAgICB9CgogICAgICAvLyBBZGQgYW50aS1jYWNoZSBpbiB1cmwgaWYgbmVlZGVkCiAgICAgIGlmICggcy5jYWNoZSA9PT0gZmFsc2UgKSB7CiAgICAgICAgcy51cmwgPSBydHMudGVzdCggY2FjaGVVUkwgKSA/CgogICAgICAgICAgLy8gSWYgdGhlcmUgaXMgYWxyZWFkeSBhICdfJyBwYXJhbWV0ZXIsIHNldCBpdHMgdmFsdWUKICAgICAgICAgIGNhY2hlVVJMLnJlcGxhY2UoIHJ0cywgIiQxXz0iICsgYWpheF9ub25jZSsrICkgOgoKICAgICAgICAgIC8vIE90aGVyd2lzZSBhZGQgb25lIHRvIHRoZSBlbmQKICAgICAgICAgIGNhY2hlVVJMICsgKCBhamF4X3JxdWVyeS50ZXN0KCBjYWNoZVVSTCApID8gIiYiIDogIj8iICkgKyAiXz0iICsgYWpheF9ub25jZSsrOwogICAgICB9CiAgICB9CgogICAgLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KICAgIGlmICggcy5pZk1vZGlmaWVkICkgewogICAgICBpZiAoIGpRdWVyeS5sYXN0TW9kaWZpZWRbIGNhY2hlVVJMIF0gKSB7CiAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU1vZGlmaWVkLVNpbmNlIiwgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSApOwogICAgICB9CiAgICAgIGlmICggalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gKSB7CiAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU5vbmUtTWF0Y2giLCBqUXVlcnkuZXRhZ1sgY2FjaGVVUkwgXSApOwogICAgICB9CiAgICB9CgogICAgLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CiAgICBpZiAoIHMuZGF0YSAmJiBzLmhhc0NvbnRlbnQgJiYgcy5jb250ZW50VHlwZSAhPT0gZmFsc2UgfHwgb3B0aW9ucy5jb250ZW50VHlwZSApIHsKICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlciggIkNvbnRlbnQtVHlwZSIsIHMuY29udGVudFR5cGUgKTsKICAgIH0KCiAgICAvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlCiAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKAogICAgICAiQWNjZXB0IiwKICAgICAgcy5kYXRhVHlwZXNbIDAgXSAmJiBzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWzBdIF0gPwogICAgICAgIHMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbMF0gXSArICggcy5kYXRhVHlwZXNbIDAgXSAhPT0gIioiID8gIiwgIiArIGFsbFR5cGVzICsgIjsgcT0wLjAxIiA6ICIiICkgOgogICAgICAgIHMuYWNjZXB0c1sgIioiIF0KICAgICk7CgogICAgLy8gQ2hlY2sgZm9yIGhlYWRlcnMgb3B0aW9uCiAgICBmb3IgKCBpIGluIHMuaGVhZGVycyApIHsKICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlciggaSwgcy5oZWFkZXJzWyBpIF0gKTsKICAgIH0KCiAgICAvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0CiAgICBpZiAoIHMuYmVmb3JlU2VuZCAmJiAoIHMuYmVmb3JlU2VuZC5jYWxsKCBjYWxsYmFja0NvbnRleHQsIGpxWEhSLCBzICkgPT09IGZhbHNlIHx8IHN0YXRlID09PSAyICkgKSB7CiAgICAgIC8vIEFib3J0IGlmIG5vdCBkb25lIGFscmVhZHkgYW5kIHJldHVybgogICAgICByZXR1cm4ganFYSFIuYWJvcnQoKTsKICAgIH0KCiAgICAvLyBhYm9ydGluZyBpcyBubyBsb25nZXIgYSBjYW5jZWxsYXRpb24KICAgIHN0ckFib3J0ID0gImFib3J0IjsKCiAgICAvLyBJbnN0YWxsIGNhbGxiYWNrcyBvbiBkZWZlcnJlZHMKICAgIGZvciAoIGkgaW4geyBzdWNjZXNzOiAxLCBlcnJvcjogMSwgY29tcGxldGU6IDEgfSApIHsKICAgICAganFYSFJbIGkgXSggc1sgaSBdICk7CiAgICB9CgogICAgLy8gR2V0IHRyYW5zcG9ydAogICAgdHJhbnNwb3J0ID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHRyYW5zcG9ydHMsIHMsIG9wdGlvbnMsIGpxWEhSICk7CgogICAgLy8gSWYgbm8gdHJhbnNwb3J0LCB3ZSBhdXRvLWFib3J0CiAgICBpZiAoICF0cmFuc3BvcnQgKSB7CiAgICAgIGRvbmUoIC0xLCAiTm8gVHJhbnNwb3J0IiApOwogICAgfSBlbHNlIHsKICAgICAganFYSFIucmVhZHlTdGF0ZSA9IDE7CgogICAgICAvLyBTZW5kIGdsb2JhbCBldmVudAogICAgICBpZiAoIGZpcmVHbG9iYWxzICkgewogICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheFNlbmQiLCBbIGpxWEhSLCBzIF0gKTsKICAgICAgfQogICAgICAvLyBUaW1lb3V0CiAgICAgIGlmICggcy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwICkgewogICAgICAgIHRpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBqcVhIUi5hYm9ydCgidGltZW91dCIpOwogICAgICAgIH0sIHMudGltZW91dCApOwogICAgICB9CgogICAgICB0cnkgewogICAgICAgIHN0YXRlID0gMTsKICAgICAgICB0cmFuc3BvcnQuc2VuZCggcmVxdWVzdEhlYWRlcnMsIGRvbmUgKTsKICAgICAgfSBjYXRjaCAoIGUgKSB7CiAgICAgICAgLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQogICAgICAgIGlmICggc3RhdGUgPCAyICkgewogICAgICAgICAgZG9uZSggLTEsIGUgKTsKICAgICAgICAvLyBTaW1wbHkgcmV0aHJvdyBvdGhlcndpc2UKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBDYWxsYmFjayBmb3Igd2hlbiBldmVyeXRoaW5nIGlzIGRvbmUKICAgIGZ1bmN0aW9uIGRvbmUoIHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzICkgewogICAgICB2YXIgaXNTdWNjZXNzLCBzdWNjZXNzLCBlcnJvciwgcmVzcG9uc2UsIG1vZGlmaWVkLAogICAgICAgIHN0YXR1c1RleHQgPSBuYXRpdmVTdGF0dXNUZXh0OwoKICAgICAgLy8gQ2FsbGVkIG9uY2UKICAgICAgaWYgKCBzdGF0ZSA9PT0gMiApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIFN0YXRlIGlzICJkb25lIiBub3cKICAgICAgc3RhdGUgPSAyOwoKICAgICAgLy8gQ2xlYXIgdGltZW91dCBpZiBpdCBleGlzdHMKICAgICAgaWYgKCB0aW1lb3V0VGltZXIgKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KCB0aW1lb3V0VGltZXIgKTsKICAgICAgfQoKICAgICAgLy8gRGVyZWZlcmVuY2UgdHJhbnNwb3J0IGZvciBlYXJseSBnYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkKICAgICAgdHJhbnNwb3J0ID0gdW5kZWZpbmVkOwoKICAgICAgLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycwogICAgICByZXNwb25zZUhlYWRlcnNTdHJpbmcgPSBoZWFkZXJzIHx8ICIiOwoKICAgICAgLy8gU2V0IHJlYWR5U3RhdGUKICAgICAganFYSFIucmVhZHlTdGF0ZSA9IHN0YXR1cyA+IDAgPyA0IDogMDsKCiAgICAgIC8vIEdldCByZXNwb25zZSBkYXRhCiAgICAgIGlmICggcmVzcG9uc2VzICkgewogICAgICAgIHJlc3BvbnNlID0gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApOwogICAgICB9CgogICAgICAvLyBJZiBzdWNjZXNzZnVsLCBoYW5kbGUgdHlwZSBjaGFpbmluZwogICAgICBpZiAoIHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0ICkgewoKICAgICAgICAvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgogICAgICAgIGlmICggcy5pZk1vZGlmaWVkICkgewogICAgICAgICAgbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiTGFzdC1Nb2RpZmllZCIpOwogICAgICAgICAgaWYgKCBtb2RpZmllZCApIHsKICAgICAgICAgICAgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSA9IG1vZGlmaWVkOwogICAgICAgICAgfQogICAgICAgICAgbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiZXRhZyIpOwogICAgICAgICAgaWYgKCBtb2RpZmllZCApIHsKICAgICAgICAgICAgalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gPSBtb2RpZmllZDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIElmIG5vdCBtb2RpZmllZAogICAgICAgIGlmICggc3RhdHVzID09PSAzMDQgKSB7CiAgICAgICAgICBpc1N1Y2Nlc3MgPSB0cnVlOwogICAgICAgICAgc3RhdHVzVGV4dCA9ICJub3Rtb2RpZmllZCI7CgogICAgICAgIC8vIElmIHdlIGhhdmUgZGF0YQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpc1N1Y2Nlc3MgPSBhamF4Q29udmVydCggcywgcmVzcG9uc2UgKTsKICAgICAgICAgIHN0YXR1c1RleHQgPSBpc1N1Y2Nlc3Muc3RhdGU7CiAgICAgICAgICBzdWNjZXNzID0gaXNTdWNjZXNzLmRhdGE7CiAgICAgICAgICBlcnJvciA9IGlzU3VjY2Vzcy5lcnJvcjsKICAgICAgICAgIGlzU3VjY2VzcyA9ICFlcnJvcjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gV2UgZXh0cmFjdCBlcnJvciBmcm9tIHN0YXR1c1RleHQKICAgICAgICAvLyB0aGVuIG5vcm1hbGl6ZSBzdGF0dXNUZXh0IGFuZCBzdGF0dXMgZm9yIG5vbi1hYm9ydHMKICAgICAgICBlcnJvciA9IHN0YXR1c1RleHQ7CiAgICAgICAgaWYgKCBzdGF0dXMgfHwgIXN0YXR1c1RleHQgKSB7CiAgICAgICAgICBzdGF0dXNUZXh0ID0gImVycm9yIjsKICAgICAgICAgIGlmICggc3RhdHVzIDwgMCApIHsKICAgICAgICAgICAgc3RhdHVzID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNldCBkYXRhIGZvciB0aGUgZmFrZSB4aHIgb2JqZWN0CiAgICAgIGpxWEhSLnN0YXR1cyA9IHN0YXR1czsKICAgICAganFYSFIuc3RhdHVzVGV4dCA9ICggbmF0aXZlU3RhdHVzVGV4dCB8fCBzdGF0dXNUZXh0ICkgKyAiIjsKCiAgICAgIC8vIFN1Y2Nlc3MvRXJyb3IKICAgICAgaWYgKCBpc1N1Y2Nlc3MgKSB7CiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBzdWNjZXNzLCBzdGF0dXNUZXh0LCBqcVhIUiBdICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0LCBlcnJvciBdICk7CiAgICAgIH0KCiAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgIGpxWEhSLnN0YXR1c0NvZGUoIHN0YXR1c0NvZGUgKTsKICAgICAgc3RhdHVzQ29kZSA9IHVuZGVmaW5lZDsKCiAgICAgIGlmICggZmlyZUdsb2JhbHMgKSB7CiAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoIGlzU3VjY2VzcyA/ICJhamF4U3VjY2VzcyIgOiAiYWpheEVycm9yIiwKICAgICAgICAgIFsganFYSFIsIHMsIGlzU3VjY2VzcyA/IHN1Y2Nlc3MgOiBlcnJvciBdICk7CiAgICAgIH0KCiAgICAgIC8vIENvbXBsZXRlCiAgICAgIGNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBqcVhIUiwgc3RhdHVzVGV4dCBdICk7CgogICAgICBpZiAoIGZpcmVHbG9iYWxzICkgewogICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheENvbXBsZXRlIiwgWyBqcVhIUiwgcyBdICk7CiAgICAgICAgLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCiAgICAgICAgaWYgKCAhKCAtLWpRdWVyeS5hY3RpdmUgKSApIHsKICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RvcCIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBqcVhIUjsKICB9LAoKICBnZXRTY3JpcHQ6IGZ1bmN0aW9uKCB1cmwsIGNhbGxiYWNrICkgewogICAgcmV0dXJuIGpRdWVyeS5nZXQoIHVybCwgdW5kZWZpbmVkLCBjYWxsYmFjaywgInNjcmlwdCIgKTsKICB9LAoKICBnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsKICAgIHJldHVybiBqUXVlcnkuZ2V0KCB1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIgKTsKICB9Cn0pOwoKLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogKiAtIHNldHMgYWxsIHJlc3BvbnNlWFhYIGZpZWxkcyBhY2NvcmRpbmdseQogKiAtIGZpbmRzIHRoZSByaWdodCBkYXRhVHlwZSAobWVkaWF0ZXMgYmV0d2VlbiBjb250ZW50LXR5cGUgYW5kIGV4cGVjdGVkIGRhdGFUeXBlKQogKiAtIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKICovCmZ1bmN0aW9uIGFqYXhIYW5kbGVSZXNwb25zZXMoIHMsIGpxWEhSLCByZXNwb25zZXMgKSB7CgogIHZhciBjdCwgdHlwZSwgZmluYWxEYXRhVHlwZSwgZmlyc3REYXRhVHlwZSwKICAgIGNvbnRlbnRzID0gcy5jb250ZW50cywKICAgIGRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLAogICAgcmVzcG9uc2VGaWVsZHMgPSBzLnJlc3BvbnNlRmllbGRzOwoKICAvLyBGaWxsIHJlc3BvbnNlWFhYIGZpZWxkcwogIGZvciAoIHR5cGUgaW4gcmVzcG9uc2VGaWVsZHMgKSB7CiAgICBpZiAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewogICAgICBqcVhIUlsgcmVzcG9uc2VGaWVsZHNbdHlwZV0gXSA9IHJlc3BvbnNlc1sgdHlwZSBdOwogICAgfQogIH0KCiAgLy8gUmVtb3ZlIGF1dG8gZGF0YVR5cGUgYW5kIGdldCBjb250ZW50LXR5cGUgaW4gdGhlIHByb2Nlc3MKICB3aGlsZSggZGF0YVR5cGVzWyAwIF0gPT09ICIqIiApIHsKICAgIGRhdGFUeXBlcy5zaGlmdCgpOwogICAgaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgewogICAgICBjdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtVHlwZSIpOwogICAgfQogIH0KCiAgLy8gQ2hlY2sgaWYgd2UncmUgZGVhbGluZyB3aXRoIGEga25vd24gY29udGVudC10eXBlCiAgaWYgKCBjdCApIHsKICAgIGZvciAoIHR5cGUgaW4gY29udGVudHMgKSB7CiAgICAgIGlmICggY29udGVudHNbIHR5cGUgXSAmJiBjb250ZW50c1sgdHlwZSBdLnRlc3QoIGN0ICkgKSB7CiAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQoIHR5cGUgKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KCiAgLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIGhhdmUgYSByZXNwb25zZSBmb3IgdGhlIGV4cGVjdGVkIGRhdGFUeXBlCiAgaWYgKCBkYXRhVHlwZXNbIDAgXSBpbiByZXNwb25zZXMgKSB7CiAgICBmaW5hbERhdGFUeXBlID0gZGF0YVR5cGVzWyAwIF07CiAgfSBlbHNlIHsKICAgIC8vIFRyeSBjb252ZXJ0aWJsZSBkYXRhVHlwZXMKICAgIGZvciAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewogICAgICBpZiAoICFkYXRhVHlwZXNbIDAgXSB8fCBzLmNvbnZlcnRlcnNbIHR5cGUgKyAiICIgKyBkYXRhVHlwZXNbMF0gXSApIHsKICAgICAgICBmaW5hbERhdGFUeXBlID0gdHlwZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBpZiAoICFmaXJzdERhdGFUeXBlICkgewogICAgICAgIGZpcnN0RGF0YVR5cGUgPSB0eXBlOwogICAgICB9CiAgICB9CiAgICAvLyBPciBqdXN0IHVzZSBmaXJzdCBvbmUKICAgIGZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7CiAgfQoKICAvLyBJZiB3ZSBmb3VuZCBhIGRhdGFUeXBlCiAgLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKICAvLyBhbmQgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAgaWYgKCBmaW5hbERhdGFUeXBlICkgewogICAgaWYgKCBmaW5hbERhdGFUeXBlICE9PSBkYXRhVHlwZXNbIDAgXSApIHsKICAgICAgZGF0YVR5cGVzLnVuc2hpZnQoIGZpbmFsRGF0YVR5cGUgKTsKICAgIH0KICAgIHJldHVybiByZXNwb25zZXNbIGZpbmFsRGF0YVR5cGUgXTsKICB9Cn0KCi8vIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKZnVuY3Rpb24gYWpheENvbnZlcnQoIHMsIHJlc3BvbnNlICkgewoKICB2YXIgY29udiwgY29udjIsIGN1cnJlbnQsIHRtcCwKICAgIGNvbnZlcnRlcnMgPSB7fSwKICAgIGkgPSAwLAogICAgLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgogICAgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXMuc2xpY2UoKSwKICAgIHByZXYgPSBkYXRhVHlwZXNbIDAgXTsKCiAgLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKICBpZiAoIHMuZGF0YUZpbHRlciApIHsKICAgIHJlc3BvbnNlID0gcy5kYXRhRmlsdGVyKCByZXNwb25zZSwgcy5kYXRhVHlwZSApOwogIH0KCiAgLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzCiAgaWYgKCBkYXRhVHlwZXNbIDEgXSApIHsKICAgIGZvciAoIGNvbnYgaW4gcy5jb252ZXJ0ZXJzICkgewogICAgICBjb252ZXJ0ZXJzWyBjb252LnRvTG93ZXJDYXNlKCkgXSA9IHMuY29udmVydGVyc1sgY29udiBdOwogICAgfQogIH0KCiAgLy8gQ29udmVydCB0byBlYWNoIHNlcXVlbnRpYWwgZGF0YVR5cGUsIHRvbGVyYXRpbmcgbGlzdCBtb2RpZmljYXRpb24KICBmb3IgKCA7IChjdXJyZW50ID0gZGF0YVR5cGVzWysraV0pOyApIHsKCiAgICAvLyBUaGVyZSdzIG9ubHkgd29yayB0byBkbyBpZiBjdXJyZW50IGRhdGFUeXBlIGlzIG5vbi1hdXRvCiAgICBpZiAoIGN1cnJlbnQgIT09ICIqIiApIHsKCiAgICAgIC8vIENvbnZlcnQgcmVzcG9uc2UgaWYgcHJldiBkYXRhVHlwZSBpcyBub24tYXV0byBhbmQgZGlmZmVycyBmcm9tIGN1cnJlbnQKICAgICAgaWYgKCBwcmV2ICE9PSAiKiIgJiYgcHJldiAhPT0gY3VycmVudCApIHsKCiAgICAgICAgLy8gU2VlayBhIGRpcmVjdCBjb252ZXJ0ZXIKICAgICAgICBjb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIGN1cnJlbnQgXSB8fCBjb252ZXJ0ZXJzWyAiKiAiICsgY3VycmVudCBdOwoKICAgICAgICAvLyBJZiBub25lIGZvdW5kLCBzZWVrIGEgcGFpcgogICAgICAgIGlmICggIWNvbnYgKSB7CiAgICAgICAgICBmb3IgKCBjb252MiBpbiBjb252ZXJ0ZXJzICkgewoKICAgICAgICAgICAgLy8gSWYgY29udjIgb3V0cHV0cyBjdXJyZW50CiAgICAgICAgICAgIHRtcCA9IGNvbnYyLnNwbGl0KCIgIik7CiAgICAgICAgICAgIGlmICggdG1wWyAxIF0gPT09IGN1cnJlbnQgKSB7CgogICAgICAgICAgICAgIC8vIElmIHByZXYgY2FuIGJlIGNvbnZlcnRlZCB0byBhY2NlcHRlZCBpbnB1dAogICAgICAgICAgICAgIGNvbnYgPSBjb252ZXJ0ZXJzWyBwcmV2ICsgIiAiICsgdG1wWyAwIF0gXSB8fAogICAgICAgICAgICAgICAgY29udmVydGVyc1sgIiogIiArIHRtcFsgMCBdIF07CiAgICAgICAgICAgICAgaWYgKCBjb252ICkgewogICAgICAgICAgICAgICAgLy8gQ29uZGVuc2UgZXF1aXZhbGVuY2UgY29udmVydGVycwogICAgICAgICAgICAgICAgaWYgKCBjb252ID09PSB0cnVlICkgewogICAgICAgICAgICAgICAgICBjb252ID0gY29udmVydGVyc1sgY29udjIgXTsKCiAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIGluc2VydCB0aGUgaW50ZXJtZWRpYXRlIGRhdGFUeXBlCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBjb252ZXJ0ZXJzWyBjb252MiBdICE9PSB0cnVlICkgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdG1wWyAwIF07CiAgICAgICAgICAgICAgICAgIGRhdGFUeXBlcy5zcGxpY2UoIGktLSwgMCwgY3VycmVudCApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQXBwbHkgY29udmVydGVyIChpZiBub3QgYW4gZXF1aXZhbGVuY2UpCiAgICAgICAgaWYgKCBjb252ICE9PSB0cnVlICkgewoKICAgICAgICAgIC8vIFVubGVzcyBlcnJvcnMgYXJlIGFsbG93ZWQgdG8gYnViYmxlLCBjYXRjaCBhbmQgcmV0dXJuIHRoZW0KICAgICAgICAgIGlmICggY29udiAmJiBzWyJ0aHJvd3MiXSApIHsKICAgICAgICAgICAgcmVzcG9uc2UgPSBjb252KCByZXNwb25zZSApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CiAgICAgICAgICAgIH0gY2F0Y2ggKCBlICkgewogICAgICAgICAgICAgIHJldHVybiB7IHN0YXRlOiAicGFyc2VyZXJyb3IiLCBlcnJvcjogY29udiA/IGUgOiAiTm8gY29udmVyc2lvbiBmcm9tICIgKyBwcmV2ICsgIiB0byAiICsgY3VycmVudCB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBVcGRhdGUgcHJldiBmb3IgbmV4dCBpdGVyYXRpb24KICAgICAgcHJldiA9IGN1cnJlbnQ7CiAgICB9CiAgfQoKICByZXR1cm4geyBzdGF0ZTogInN1Y2Nlc3MiLCBkYXRhOiByZXNwb25zZSB9Owp9Ci8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlCmpRdWVyeS5hamF4U2V0dXAoewogIGFjY2VwdHM6IHsKICAgIHNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24vZWNtYXNjcmlwdCwgYXBwbGljYXRpb24veC1lY21hc2NyaXB0IgogIH0sCiAgY29udGVudHM6IHsKICAgIHNjcmlwdDogLyg/OmphdmF8ZWNtYSlzY3JpcHQvCiAgfSwKICBjb252ZXJ0ZXJzOiB7CiAgICAidGV4dCBzY3JpcHQiOiBmdW5jdGlvbiggdGV4dCApIHsKICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwoIHRleHQgKTsKICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgfQp9KTsKCi8vIEhhbmRsZSBjYWNoZSdzIHNwZWNpYWwgY2FzZSBhbmQgZ2xvYmFsCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAic2NyaXB0IiwgZnVuY3Rpb24oIHMgKSB7CiAgaWYgKCBzLmNhY2hlID09PSB1bmRlZmluZWQgKSB7CiAgICBzLmNhY2hlID0gZmFsc2U7CiAgfQogIGlmICggcy5jcm9zc0RvbWFpbiApIHsKICAgIHMudHlwZSA9ICJHRVQiOwogICAgcy5nbG9iYWwgPSBmYWxzZTsKICB9Cn0pOwoKLy8gQmluZCBzY3JpcHQgdGFnIGhhY2sgdHJhbnNwb3J0CmpRdWVyeS5hamF4VHJhbnNwb3J0KCAic2NyaXB0IiwgZnVuY3Rpb24ocykgewoKICAvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIHJlcXVlc3RzCiAgaWYgKCBzLmNyb3NzRG9tYWluICkgewoKICAgIHZhciBzY3JpcHQsCiAgICAgIGhlYWQgPSBkb2N1bWVudC5oZWFkIHx8IGpRdWVyeSgiaGVhZCIpWzBdIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCiAgICByZXR1cm4gewoKICAgICAgc2VuZDogZnVuY3Rpb24oIF8sIGNhbGxiYWNrICkgewoKICAgICAgICBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCiAgICAgICAgc2NyaXB0LmFzeW5jID0gdHJ1ZTsKCiAgICAgICAgaWYgKCBzLnNjcmlwdENoYXJzZXQgKSB7CiAgICAgICAgICBzY3JpcHQuY2hhcnNldCA9IHMuc2NyaXB0Q2hhcnNldDsKICAgICAgICB9CgogICAgICAgIHNjcmlwdC5zcmMgPSBzLnVybDsKCiAgICAgICAgLy8gQXR0YWNoIGhhbmRsZXJzIGZvciBhbGwgYnJvd3NlcnMKICAgICAgICBzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCBfLCBpc0Fib3J0ICkgewoKICAgICAgICAgIGlmICggaXNBYm9ydCB8fCAhc2NyaXB0LnJlYWR5U3RhdGUgfHwgL2xvYWRlZHxjb21wbGV0ZS8udGVzdCggc2NyaXB0LnJlYWR5U3RhdGUgKSApIHsKCiAgICAgICAgICAgIC8vIEhhbmRsZSBtZW1vcnkgbGVhayBpbiBJRQogICAgICAgICAgICBzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CgogICAgICAgICAgICAvLyBSZW1vdmUgdGhlIHNjcmlwdAogICAgICAgICAgICBpZiAoIHNjcmlwdC5wYXJlbnROb2RlICkgewogICAgICAgICAgICAgIHNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBzY3JpcHQgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGVyZWZlcmVuY2UgdGhlIHNjcmlwdAogICAgICAgICAgICBzY3JpcHQgPSBudWxsOwoKICAgICAgICAgICAgLy8gQ2FsbGJhY2sgaWYgbm90IGFib3J0CiAgICAgICAgICAgIGlmICggIWlzQWJvcnQgKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2soIDIwMCwgInN1Y2Nlc3MiICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBDaXJjdW12ZW50IElFNiBidWdzIHdpdGggYmFzZSBlbGVtZW50cyAoIzI3MDkgYW5kICM0Mzc4KSBieSBwcmVwZW5kaW5nCiAgICAgICAgLy8gVXNlIG5hdGl2ZSBET00gbWFuaXB1bGF0aW9uIHRvIGF2b2lkIG91ciBkb21NYW5pcCBBSkFYIHRyaWNrZXJ5CiAgICAgICAgaGVhZC5pbnNlcnRCZWZvcmUoIHNjcmlwdCwgaGVhZC5maXJzdENoaWxkICk7CiAgICAgIH0sCgogICAgICBhYm9ydDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCBzY3JpcHQgKSB7CiAgICAgICAgICBzY3JpcHQub25sb2FkKCB1bmRlZmluZWQsIHRydWUgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQp9KTsKdmFyIG9sZENhbGxiYWNrcyA9IFtdLAogIHJqc29ucCA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87CgovLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCmpRdWVyeS5hamF4U2V0dXAoewogIGpzb25wOiAiY2FsbGJhY2siLAogIGpzb25wQ2FsbGJhY2s6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8ICggalF1ZXJ5LmV4cGFuZG8gKyAiXyIgKyAoIGFqYXhfbm9uY2UrKyApICk7CiAgICB0aGlzWyBjYWxsYmFjayBdID0gdHJ1ZTsKICAgIHJldHVybiBjYWxsYmFjazsKICB9Cn0pOwoKLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAianNvbiBqc29ucCIsIGZ1bmN0aW9uKCBzLCBvcmlnaW5hbFNldHRpbmdzLCBqcVhIUiApIHsKCiAgdmFyIGNhbGxiYWNrTmFtZSwgb3ZlcndyaXR0ZW4sIHJlc3BvbnNlQ29udGFpbmVyLAogICAganNvblByb3AgPSBzLmpzb25wICE9PSBmYWxzZSAmJiAoIHJqc29ucC50ZXN0KCBzLnVybCApID8KICAgICAgInVybCIgOgogICAgICB0eXBlb2Ygcy5kYXRhID09PSAic3RyaW5nIiAmJiAhKCBzLmNvbnRlbnRUeXBlIHx8ICIiICkuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgJiYgcmpzb25wLnRlc3QoIHMuZGF0YSApICYmICJkYXRhIgogICAgKTsKCiAgLy8gSGFuZGxlIGlmZiB0aGUgZXhwZWN0ZWQgZGF0YSB0eXBlIGlzICJqc29ucCIgb3Igd2UgaGF2ZSBhIHBhcmFtZXRlciB0byBzZXQKICBpZiAoIGpzb25Qcm9wIHx8IHMuZGF0YVR5cGVzWyAwIF0gPT09ICJqc29ucCIgKSB7CgogICAgLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdAogICAgY2FsbGJhY2tOYW1lID0gcy5qc29ucENhbGxiYWNrID0galF1ZXJ5LmlzRnVuY3Rpb24oIHMuanNvbnBDYWxsYmFjayApID8KICAgICAgcy5qc29ucENhbGxiYWNrKCkgOgogICAgICBzLmpzb25wQ2FsbGJhY2s7CgogICAgLy8gSW5zZXJ0IGNhbGxiYWNrIGludG8gdXJsIG9yIGZvcm0gZGF0YQogICAgaWYgKCBqc29uUHJvcCApIHsKICAgICAgc1sganNvblByb3AgXSA9IHNbIGpzb25Qcm9wIF0ucmVwbGFjZSggcmpzb25wLCAiJDEiICsgY2FsbGJhY2tOYW1lICk7CiAgICB9IGVsc2UgaWYgKCBzLmpzb25wICE9PSBmYWxzZSApIHsKICAgICAgcy51cmwgKz0gKCBhamF4X3JxdWVyeS50ZXN0KCBzLnVybCApID8gIiYiIDogIj8iICkgKyBzLmpzb25wICsgIj0iICsgY2FsbGJhY2tOYW1lOwogICAgfQoKICAgIC8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24KICAgIHMuY29udmVydGVyc1sic2NyaXB0IGpzb24iXSA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoICFyZXNwb25zZUNvbnRhaW5lciApIHsKICAgICAgICBqUXVlcnkuZXJyb3IoIGNhbGxiYWNrTmFtZSArICIgd2FzIG5vdCBjYWxsZWQiICk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3BvbnNlQ29udGFpbmVyWyAwIF07CiAgICB9OwoKICAgIC8vIGZvcmNlIGpzb24gZGF0YVR5cGUKICAgIHMuZGF0YVR5cGVzWyAwIF0gPSAianNvbiI7CgogICAgLy8gSW5zdGFsbCBjYWxsYmFjawogICAgb3ZlcndyaXR0ZW4gPSB3aW5kb3dbIGNhbGxiYWNrTmFtZSBdOwogICAgd2luZG93WyBjYWxsYmFja05hbWUgXSA9IGZ1bmN0aW9uKCkgewogICAgICByZXNwb25zZUNvbnRhaW5lciA9IGFyZ3VtZW50czsKICAgIH07CgogICAgLy8gQ2xlYW4tdXAgZnVuY3Rpb24gKGZpcmVzIGFmdGVyIGNvbnZlcnRlcnMpCiAgICBqcVhIUi5hbHdheXMoZnVuY3Rpb24oKSB7CiAgICAgIC8vIFJlc3RvcmUgcHJlZXhpc3RpbmcgdmFsdWUKICAgICAgd2luZG93WyBjYWxsYmFja05hbWUgXSA9IG92ZXJ3cml0dGVuOwoKICAgICAgLy8gU2F2ZSBiYWNrIGFzIGZyZWUKICAgICAgaWYgKCBzWyBjYWxsYmFja05hbWUgXSApIHsKICAgICAgICAvLyBtYWtlIHN1cmUgdGhhdCByZS11c2luZyB0aGUgb3B0aW9ucyBkb2Vzbid0IHNjcmV3IHRoaW5ncyBhcm91bmQKICAgICAgICBzLmpzb25wQ2FsbGJhY2sgPSBvcmlnaW5hbFNldHRpbmdzLmpzb25wQ2FsbGJhY2s7CgogICAgICAgIC8vIHNhdmUgdGhlIGNhbGxiYWNrIG5hbWUgZm9yIGZ1dHVyZSB1c2UKICAgICAgICBvbGRDYWxsYmFja3MucHVzaCggY2FsbGJhY2tOYW1lICk7CiAgICAgIH0KCiAgICAgIC8vIENhbGwgaWYgaXQgd2FzIGEgZnVuY3Rpb24gYW5kIHdlIGhhdmUgYSByZXNwb25zZQogICAgICBpZiAoIHJlc3BvbnNlQ29udGFpbmVyICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBvdmVyd3JpdHRlbiApICkgewogICAgICAgIG92ZXJ3cml0dGVuKCByZXNwb25zZUNvbnRhaW5lclsgMCBdICk7CiAgICAgIH0KCiAgICAgIHJlc3BvbnNlQ29udGFpbmVyID0gb3ZlcndyaXR0ZW4gPSB1bmRlZmluZWQ7CiAgICB9KTsKCiAgICAvLyBEZWxlZ2F0ZSB0byBzY3JpcHQKICAgIHJldHVybiAic2NyaXB0IjsKICB9Cn0pOwp2YXIgeGhyQ2FsbGJhY2tzLCB4aHJTdXBwb3J0ZWQsCiAgeGhySWQgPSAwLAogIC8vICM1MjgwOiBJbnRlcm5ldCBFeHBsb3JlciB3aWxsIGtlZXAgY29ubmVjdGlvbnMgYWxpdmUgaWYgd2UgZG9uJ3QgYWJvcnQgb24gdW5sb2FkCiAgeGhyT25VbmxvYWRBYm9ydCA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ICYmIGZ1bmN0aW9uKCkgewogICAgLy8gQWJvcnQgYWxsIHBlbmRpbmcgcmVxdWVzdHMKICAgIHZhciBrZXk7CiAgICBmb3IgKCBrZXkgaW4geGhyQ2FsbGJhY2tzICkgewogICAgICB4aHJDYWxsYmFja3NbIGtleSBdKCB1bmRlZmluZWQsIHRydWUgKTsKICAgIH0KICB9OwoKLy8gRnVuY3Rpb25zIHRvIGNyZWF0ZSB4aHJzCmZ1bmN0aW9uIGNyZWF0ZVN0YW5kYXJkWEhSKCkgewogIHRyeSB7CiAgICByZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpOwogIH0gY2F0Y2goIGUgKSB7fQp9CgpmdW5jdGlvbiBjcmVhdGVBY3RpdmVYSFIoKSB7CiAgdHJ5IHsKICAgIHJldHVybiBuZXcgd2luZG93LkFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgfSBjYXRjaCggZSApIHt9Cn0KCi8vIENyZWF0ZSB0aGUgcmVxdWVzdCBvYmplY3QKLy8gKFRoaXMgaXMgc3RpbGwgYXR0YWNoZWQgdG8gYWpheFNldHRpbmdzIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KQpqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ID8KICAvKiBNaWNyb3NvZnQgZmFpbGVkIHRvIHByb3Blcmx5CiAgICogaW1wbGVtZW50IHRoZSBYTUxIdHRwUmVxdWVzdCBpbiBJRTcgKGNhbid0IHJlcXVlc3QgbG9jYWwgZmlsZXMpLAogICAqIHNvIHdlIHVzZSB0aGUgQWN0aXZlWE9iamVjdCB3aGVuIGl0IGlzIGF2YWlsYWJsZQogICAqIEFkZGl0aW9uYWxseSBYTUxIdHRwUmVxdWVzdCBjYW4gYmUgZGlzYWJsZWQgaW4gSUU3L0lFOCBzbwogICAqIHdlIG5lZWQgYSBmYWxsYmFjay4KICAgKi8KICBmdW5jdGlvbigpIHsKICAgIHJldHVybiAhdGhpcy5pc0xvY2FsICYmIGNyZWF0ZVN0YW5kYXJkWEhSKCkgfHwgY3JlYXRlQWN0aXZlWEhSKCk7CiAgfSA6CiAgLy8gRm9yIGFsbCBvdGhlciBicm93c2VycywgdXNlIHRoZSBzdGFuZGFyZCBYTUxIdHRwUmVxdWVzdCBvYmplY3QKICBjcmVhdGVTdGFuZGFyZFhIUjsKCi8vIERldGVybWluZSBzdXBwb3J0IHByb3BlcnRpZXMKeGhyU3VwcG9ydGVkID0galF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIoKTsKalF1ZXJ5LnN1cHBvcnQuY29ycyA9ICEheGhyU3VwcG9ydGVkICYmICggIndpdGhDcmVkZW50aWFscyIgaW4geGhyU3VwcG9ydGVkICk7CnhoclN1cHBvcnRlZCA9IGpRdWVyeS5zdXBwb3J0LmFqYXggPSAhIXhoclN1cHBvcnRlZDsKCi8vIENyZWF0ZSB0cmFuc3BvcnQgaWYgdGhlIGJyb3dzZXIgY2FuIHByb3ZpZGUgYW4geGhyCmlmICggeGhyU3VwcG9ydGVkICkgewoKICBqUXVlcnkuYWpheFRyYW5zcG9ydChmdW5jdGlvbiggcyApIHsKICAgIC8vIENyb3NzIGRvbWFpbiBvbmx5IGFsbG93ZWQgaWYgc3VwcG9ydGVkIHRocm91Z2ggWE1MSHR0cFJlcXVlc3QKICAgIGlmICggIXMuY3Jvc3NEb21haW4gfHwgalF1ZXJ5LnN1cHBvcnQuY29ycyApIHsKCiAgICAgIHZhciBjYWxsYmFjazsKCiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24oIGhlYWRlcnMsIGNvbXBsZXRlICkgewoKICAgICAgICAgIC8vIEdldCBhIG5ldyB4aHIKICAgICAgICAgIHZhciBoYW5kbGUsIGksCiAgICAgICAgICAgIHhociA9IHMueGhyKCk7CgogICAgICAgICAgLy8gT3BlbiB0aGUgc29ja2V0CiAgICAgICAgICAvLyBQYXNzaW5nIG51bGwgdXNlcm5hbWUsIGdlbmVyYXRlcyBhIGxvZ2luIHBvcHVwIG9uIE9wZXJhICgjMjg2NSkKICAgICAgICAgIGlmICggcy51c2VybmFtZSApIHsKICAgICAgICAgICAgeGhyLm9wZW4oIHMudHlwZSwgcy51cmwsIHMuYXN5bmMsIHMudXNlcm5hbWUsIHMucGFzc3dvcmQgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHhoci5vcGVuKCBzLnR5cGUsIHMudXJsLCBzLmFzeW5jICk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQXBwbHkgY3VzdG9tIGZpZWxkcyBpZiBwcm92aWRlZAogICAgICAgICAgaWYgKCBzLnhockZpZWxkcyApIHsKICAgICAgICAgICAgZm9yICggaSBpbiBzLnhockZpZWxkcyApIHsKICAgICAgICAgICAgICB4aHJbIGkgXSA9IHMueGhyRmllbGRzWyBpIF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkCiAgICAgICAgICBpZiAoIHMubWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUgKSB7CiAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlKCBzLm1pbWVUeXBlICk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXIKICAgICAgICAgIC8vIEZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMsIHNlZWluZyBhcyBjb25kaXRpb25zIGZvciBhIHByZWZsaWdodCBhcmUKICAgICAgICAgIC8vIGFraW4gdG8gYSBqaWdzYXcgcHV6emxlLCB3ZSBzaW1wbHkgbmV2ZXIgc2V0IGl0IHRvIGJlIHN1cmUuCiAgICAgICAgICAvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkKICAgICAgICAgIC8vIEZvciBzYW1lLWRvbWFpbiByZXF1ZXN0cywgd29uJ3QgY2hhbmdlIGhlYWRlciBpZiBhbHJlYWR5IHByb3ZpZGVkLgogICAgICAgICAgaWYgKCAhcy5jcm9zc0RvbWFpbiAmJiAhaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdICkgewogICAgICAgICAgICBoZWFkZXJzWyJYLVJlcXVlc3RlZC1XaXRoIl0gPSAiWE1MSHR0cFJlcXVlc3QiOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIE5lZWQgYW4gZXh0cmEgdHJ5L2NhdGNoIGZvciBjcm9zcyBkb21haW4gcmVxdWVzdHMgaW4gRmlyZWZveCAzCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKCBpIGluIGhlYWRlcnMgKSB7CiAgICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoIGksIGhlYWRlcnNbIGkgXSApOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoKCBlcnIgKSB7fQoKICAgICAgICAgIC8vIERvIHNlbmQgdGhlIHJlcXVlc3QKICAgICAgICAgIC8vIFRoaXMgbWF5IHJhaXNlIGFuIGV4Y2VwdGlvbiB3aGljaCBpcyBhY3R1YWxseQogICAgICAgICAgLy8gaGFuZGxlZCBpbiBqUXVlcnkuYWpheCAoc28gbm8gdHJ5L2NhdGNoIGhlcmUpCiAgICAgICAgICB4aHIuc2VuZCggKCBzLmhhc0NvbnRlbnQgJiYgcy5kYXRhICkgfHwgbnVsbCApOwoKICAgICAgICAgIC8vIExpc3RlbmVyCiAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCBfLCBpc0Fib3J0ICkgewoKICAgICAgICAgICAgdmFyIHN0YXR1cywKICAgICAgICAgICAgICBzdGF0dXNUZXh0LAogICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycywKICAgICAgICAgICAgICByZXNwb25zZXMsCiAgICAgICAgICAgICAgeG1sOwoKICAgICAgICAgICAgLy8gRmlyZWZveCB0aHJvd3MgZXhjZXB0aW9ucyB3aGVuIGFjY2Vzc2luZyBwcm9wZXJ0aWVzCiAgICAgICAgICAgIC8vIG9mIGFuIHhociB3aGVuIGEgbmV0d29yayBlcnJvciBvY2N1cnJlZAogICAgICAgICAgICAvLyBodHRwOi8vaGVscGZ1bC5rbm9icy1kaWFscy5jb20vaW5kZXgucGhwL0NvbXBvbmVudF9yZXR1cm5lZF9mYWlsdXJlX2NvZGU6XzB4ODAwNDAxMTFfKE5TX0VSUk9SX05PVF9BVkFJTEFCTEUpCiAgICAgICAgICAgIHRyeSB7CgogICAgICAgICAgICAgIC8vIFdhcyBuZXZlciBjYWxsZWQgYW5kIGlzIGFib3J0ZWQgb3IgY29tcGxldGUKICAgICAgICAgICAgICBpZiAoIGNhbGxiYWNrICYmICggaXNBYm9ydCB8fCB4aHIucmVhZHlTdGF0ZSA9PT0gNCApICkgewoKICAgICAgICAgICAgICAgIC8vIE9ubHkgY2FsbGVkIG9uY2UKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgICAgIC8vIERvIG5vdCBrZWVwIGFzIGFjdGl2ZSBhbnltb3JlCiAgICAgICAgICAgICAgICBpZiAoIGhhbmRsZSApIHsKICAgICAgICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGpRdWVyeS5ub29wOwogICAgICAgICAgICAgICAgICBpZiAoIHhock9uVW5sb2FkQWJvcnQgKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHhockNhbGxiYWNrc1sgaGFuZGxlIF07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJZiBpdCdzIGFuIGFib3J0CiAgICAgICAgICAgICAgICBpZiAoIGlzQWJvcnQgKSB7CiAgICAgICAgICAgICAgICAgIC8vIEFib3J0IGl0IG1hbnVhbGx5IGlmIG5lZWRlZAogICAgICAgICAgICAgICAgICBpZiAoIHhoci5yZWFkeVN0YXRlICE9PSA0ICkgewogICAgICAgICAgICAgICAgICAgIHhoci5hYm9ydCgpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXNwb25zZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgc3RhdHVzID0geGhyLnN0YXR1czsKICAgICAgICAgICAgICAgICAgeG1sID0geGhyLnJlc3BvbnNlWE1MOwogICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAgICAgICAgICAvLyBDb25zdHJ1Y3QgcmVzcG9uc2UgbGlzdAogICAgICAgICAgICAgICAgICBpZiAoIHhtbCAmJiB4bWwuZG9jdW1lbnRFbGVtZW50IC8qICM0OTU4ICovICkgewogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlcy54bWwgPSB4bWw7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIC8vIFdoZW4gcmVxdWVzdGluZyBiaW5hcnkgZGF0YSwgSUU2LTkgd2lsbCB0aHJvdyBhbiBleGNlcHRpb24KICAgICAgICAgICAgICAgICAgLy8gb24gYW55IGF0dGVtcHQgdG8gYWNjZXNzIHJlc3BvbnNlVGV4dCAoIzExNDI2KQogICAgICAgICAgICAgICAgICBpZiAoIHR5cGVvZiB4aHIucmVzcG9uc2VUZXh0ID09PSAic3RyaW5nIiApIHsKICAgICAgICAgICAgICAgICAgICByZXNwb25zZXMudGV4dCA9IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggdGhyb3dzIGFuIGV4Y2VwdGlvbiB3aGVuIGFjY2Vzc2luZwogICAgICAgICAgICAgICAgICAvLyBzdGF0dXNUZXh0IGZvciBmYXVsdHkgY3Jvc3MtZG9tYWluIHJlcXVlc3RzCiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdHVzVGV4dCA9IHhoci5zdGF0dXNUZXh0OwogICAgICAgICAgICAgICAgICB9IGNhdGNoKCBlICkgewogICAgICAgICAgICAgICAgICAgIC8vIFdlIG5vcm1hbGl6ZSB3aXRoIFdlYmtpdCBnaXZpbmcgYW4gZW1wdHkgc3RhdHVzVGV4dAogICAgICAgICAgICAgICAgICAgIHN0YXR1c1RleHQgPSAiIjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgLy8gRmlsdGVyIHN0YXR1cyBmb3Igbm9uIHN0YW5kYXJkIGJlaGF2aW9ycwoKICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHJlcXVlc3QgaXMgbG9jYWwgYW5kIHdlIGhhdmUgZGF0YTogYXNzdW1lIGEgc3VjY2VzcwogICAgICAgICAgICAgICAgICAvLyAoc3VjY2VzcyB3aXRoIG5vIGRhdGEgd29uJ3QgZ2V0IG5vdGlmaWVkLCB0aGF0J3MgdGhlIGJlc3Qgd2UKICAgICAgICAgICAgICAgICAgLy8gY2FuIGRvIGdpdmVuIGN1cnJlbnQgaW1wbGVtZW50YXRpb25zKQogICAgICAgICAgICAgICAgICBpZiAoICFzdGF0dXMgJiYgcy5pc0xvY2FsICYmICFzLmNyb3NzRG9tYWluICkgewogICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IHJlc3BvbnNlcy50ZXh0ID8gMjAwIDogNDA0OwogICAgICAgICAgICAgICAgICAvLyBJRSAtICMxNDUwOiBzb21ldGltZXMgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDEyMjMgKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdHVzID0gMjA0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKCBmaXJlZm94QWNjZXNzRXhjZXB0aW9uICkgewogICAgICAgICAgICAgIGlmICggIWlzQWJvcnQgKSB7CiAgICAgICAgICAgICAgICBjb21wbGV0ZSggLTEsIGZpcmVmb3hBY2Nlc3NFeGNlcHRpb24gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhbGwgY29tcGxldGUgaWYgbmVlZGVkCiAgICAgICAgICAgIGlmICggcmVzcG9uc2VzICkgewogICAgICAgICAgICAgIGNvbXBsZXRlKCBzdGF0dXMsIHN0YXR1c1RleHQsIHJlc3BvbnNlcywgcmVzcG9uc2VIZWFkZXJzICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgaWYgKCAhcy5hc3luYyApIHsKICAgICAgICAgICAgLy8gaWYgd2UncmUgaW4gc3luYyBtb2RlIHdlIGZpcmUgdGhlIGNhbGxiYWNrCiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKCB4aHIucmVhZHlTdGF0ZSA9PT0gNCApIHsKICAgICAgICAgICAgLy8gKElFNiAmIElFNykgaWYgaXQncyBpbiBjYWNoZSBhbmQgaGFzIGJlZW4KICAgICAgICAgICAgLy8gcmV0cmlldmVkIGRpcmVjdGx5IHdlIG5lZWQgdG8gZmlyZSB0aGUgY2FsbGJhY2sKICAgICAgICAgICAgc2V0VGltZW91dCggY2FsbGJhY2sgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhhbmRsZSA9ICsreGhySWQ7CiAgICAgICAgICAgIGlmICggeGhyT25VbmxvYWRBYm9ydCApIHsKICAgICAgICAgICAgICAvLyBDcmVhdGUgdGhlIGFjdGl2ZSB4aHJzIGNhbGxiYWNrcyBsaXN0IGlmIG5lZWRlZAogICAgICAgICAgICAgIC8vIGFuZCBhdHRhY2ggdGhlIHVubG9hZCBoYW5kbGVyCiAgICAgICAgICAgICAgaWYgKCAheGhyQ2FsbGJhY2tzICkgewogICAgICAgICAgICAgICAgeGhyQ2FsbGJhY2tzID0ge307CiAgICAgICAgICAgICAgICBqUXVlcnkoIHdpbmRvdyApLnVubG9hZCggeGhyT25VbmxvYWRBYm9ydCApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBBZGQgdG8gbGlzdCBvZiBhY3RpdmUgeGhycyBjYWxsYmFja3MKICAgICAgICAgICAgICB4aHJDYWxsYmFja3NbIGhhbmRsZSBdID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGNhbGxiYWNrOwogICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGFib3J0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICggY2FsbGJhY2sgKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKCB1bmRlZmluZWQsIHRydWUgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfSk7Cn0KdmFyIGZ4Tm93LCB0aW1lcklkLAogIHJmeHR5cGVzID0gL14oPzp0b2dnbGV8c2hvd3xoaWRlKSQvLAogIHJmeG51bSA9IG5ldyBSZWdFeHAoICJeKD86KFsrLV0pPXwpKCIgKyBjb3JlX3BudW0gKyAiKShbYS16JV0qKSQiLCAiaSIgKSwKICBycnVuID0gL3F1ZXVlSG9va3MkLywKICBhbmltYXRpb25QcmVmaWx0ZXJzID0gWyBkZWZhdWx0UHJlZmlsdGVyIF0sCiAgdHdlZW5lcnMgPSB7CiAgICAiKiI6IFtmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CiAgICAgIHZhciBlbmQsIHVuaXQsCiAgICAgICAgdHdlZW4gPSB0aGlzLmNyZWF0ZVR3ZWVuKCBwcm9wLCB2YWx1ZSApLAogICAgICAgIHBhcnRzID0gcmZ4bnVtLmV4ZWMoIHZhbHVlICksCiAgICAgICAgdGFyZ2V0ID0gdHdlZW4uY3VyKCksCiAgICAgICAgc3RhcnQgPSArdGFyZ2V0IHx8IDAsCiAgICAgICAgc2NhbGUgPSAxLAogICAgICAgIG1heEl0ZXJhdGlvbnMgPSAyMDsKCiAgICAgIGlmICggcGFydHMgKSB7CiAgICAgICAgZW5kID0gK3BhcnRzWzJdOwogICAgICAgIHVuaXQgPSBwYXJ0c1szXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApOwoKICAgICAgICAvLyBXZSBuZWVkIHRvIGNvbXB1dGUgc3RhcnRpbmcgdmFsdWUKICAgICAgICBpZiAoIHVuaXQgIT09ICJweCIgJiYgc3RhcnQgKSB7CiAgICAgICAgICAvLyBJdGVyYXRpdmVseSBhcHByb3hpbWF0ZSBmcm9tIGEgbm9uemVybyBzdGFydGluZyBwb2ludAogICAgICAgICAgLy8gUHJlZmVyIHRoZSBjdXJyZW50IHByb3BlcnR5LCBiZWNhdXNlIHRoaXMgcHJvY2VzcyB3aWxsIGJlIHRyaXZpYWwgaWYgaXQgdXNlcyB0aGUgc2FtZSB1bml0cwogICAgICAgICAgLy8gRmFsbGJhY2sgdG8gZW5kIG9yIGEgc2ltcGxlIGNvbnN0YW50CiAgICAgICAgICBzdGFydCA9IGpRdWVyeS5jc3MoIHR3ZWVuLmVsZW0sIHByb3AsIHRydWUgKSB8fCBlbmQgfHwgMTsKCiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIC8vIElmIHByZXZpb3VzIGl0ZXJhdGlvbiB6ZXJvZWQgb3V0LCBkb3VibGUgdW50aWwgd2UgZ2V0ICpzb21ldGhpbmcqCiAgICAgICAgICAgIC8vIFVzZSBhIHN0cmluZyBmb3IgZG91YmxpbmcgZmFjdG9yIHNvIHdlIGRvbid0IGFjY2lkZW50YWxseSBzZWUgc2NhbGUgYXMgdW5jaGFuZ2VkIGJlbG93CiAgICAgICAgICAgIHNjYWxlID0gc2NhbGUgfHwgIi41IjsKCiAgICAgICAgICAgIC8vIEFkanVzdCBhbmQgYXBwbHkKICAgICAgICAgICAgc3RhcnQgPSBzdGFydCAvIHNjYWxlOwogICAgICAgICAgICBqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHByb3AsIHN0YXJ0ICsgdW5pdCApOwoKICAgICAgICAgIC8vIFVwZGF0ZSBzY2FsZSwgdG9sZXJhdGluZyB6ZXJvIG9yIE5hTiBmcm9tIHR3ZWVuLmN1cigpCiAgICAgICAgICAvLyBBbmQgYnJlYWtpbmcgdGhlIGxvb3AgaWYgc2NhbGUgaXMgdW5jaGFuZ2VkIG9yIHBlcmZlY3QsIG9yIGlmIHdlJ3ZlIGp1c3QgaGFkIGVub3VnaAogICAgICAgICAgfSB3aGlsZSAoIHNjYWxlICE9PSAoc2NhbGUgPSB0d2Vlbi5jdXIoKSAvIHRhcmdldCkgJiYgc2NhbGUgIT09IDEgJiYgLS1tYXhJdGVyYXRpb25zICk7CiAgICAgICAgfQoKICAgICAgICB0d2Vlbi51bml0ID0gdW5pdDsKICAgICAgICB0d2Vlbi5zdGFydCA9IHN0YXJ0OwogICAgICAgIC8vIElmIGEgKz0vLT0gdG9rZW4gd2FzIHByb3ZpZGVkLCB3ZSdyZSBkb2luZyBhIHJlbGF0aXZlIGFuaW1hdGlvbgogICAgICAgIHR3ZWVuLmVuZCA9IHBhcnRzWzFdID8gc3RhcnQgKyAoIHBhcnRzWzFdICsgMSApICogZW5kIDogZW5kOwogICAgICB9CiAgICAgIHJldHVybiB0d2VlbjsKICAgIH1dCiAgfTsKCi8vIEFuaW1hdGlvbnMgY3JlYXRlZCBzeW5jaHJvbm91c2x5IHdpbGwgcnVuIHN5bmNocm9ub3VzbHkKZnVuY3Rpb24gY3JlYXRlRnhOb3coKSB7CiAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgIGZ4Tm93ID0gdW5kZWZpbmVkOwogIH0pOwogIHJldHVybiAoIGZ4Tm93ID0galF1ZXJ5Lm5vdygpICk7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVR3ZWVucyggYW5pbWF0aW9uLCBwcm9wcyApIHsKICBqUXVlcnkuZWFjaCggcHJvcHMsIGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKICAgIHZhciBjb2xsZWN0aW9uID0gKCB0d2VlbmVyc1sgcHJvcCBdIHx8IFtdICkuY29uY2F0KCB0d2VlbmVyc1sgIioiIF0gKSwKICAgICAgaW5kZXggPSAwLAogICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKICAgIGZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CiAgICAgIGlmICggY29sbGVjdGlvblsgaW5kZXggXS5jYWxsKCBhbmltYXRpb24sIHByb3AsIHZhbHVlICkgKSB7CgogICAgICAgIC8vIHdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb3BlcnR5CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIEFuaW1hdGlvbiggZWxlbSwgcHJvcGVydGllcywgb3B0aW9ucyApIHsKICB2YXIgcmVzdWx0LAogICAgc3RvcHBlZCwKICAgIGluZGV4ID0gMCwKICAgIGxlbmd0aCA9IGFuaW1hdGlvblByZWZpbHRlcnMubGVuZ3RoLAogICAgZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKS5hbHdheXMoIGZ1bmN0aW9uKCkgewogICAgICAvLyBkb24ndCBtYXRjaCBlbGVtIGluIHRoZSA6YW5pbWF0ZWQgc2VsZWN0b3IKICAgICAgZGVsZXRlIHRpY2suZWxlbTsKICAgIH0pLAogICAgdGljayA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIHN0b3BwZWQgKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHZhciBjdXJyZW50VGltZSA9IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCiAgICAgICAgcmVtYWluaW5nID0gTWF0aC5tYXgoIDAsIGFuaW1hdGlvbi5zdGFydFRpbWUgKyBhbmltYXRpb24uZHVyYXRpb24gLSBjdXJyZW50VGltZSApLAogICAgICAgIC8vIGFyY2hhaWMgY3Jhc2ggYnVnIHdvbid0IGFsbG93IHVzIHRvIHVzZSAxIC0gKCAwLjUgfHwgMCApICgjMTI0OTcpCiAgICAgICAgdGVtcCA9IHJlbWFpbmluZyAvIGFuaW1hdGlvbi5kdXJhdGlvbiB8fCAwLAogICAgICAgIHBlcmNlbnQgPSAxIC0gdGVtcCwKICAgICAgICBpbmRleCA9IDAsCiAgICAgICAgbGVuZ3RoID0gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGg7CgogICAgICBmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKICAgICAgICBhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggcGVyY2VudCApOwogICAgICB9CgogICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgcGVyY2VudCwgcmVtYWluaW5nIF0pOwoKICAgICAgaWYgKCBwZXJjZW50IDwgMSAmJiBsZW5ndGggKSB7CiAgICAgICAgcmV0dXJuIHJlbWFpbmluZzsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWZlcnJlZC5yZXNvbHZlV2l0aCggZWxlbSwgWyBhbmltYXRpb24gXSApOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSwKICAgIGFuaW1hdGlvbiA9IGRlZmVycmVkLnByb21pc2UoewogICAgICBlbGVtOiBlbGVtLAogICAgICBwcm9wczogalF1ZXJ5LmV4dGVuZCgge30sIHByb3BlcnRpZXMgKSwKICAgICAgb3B0czogalF1ZXJ5LmV4dGVuZCggdHJ1ZSwgeyBzcGVjaWFsRWFzaW5nOiB7fSB9LCBvcHRpb25zICksCiAgICAgIG9yaWdpbmFsUHJvcGVydGllczogcHJvcGVydGllcywKICAgICAgb3JpZ2luYWxPcHRpb25zOiBvcHRpb25zLAogICAgICBzdGFydFRpbWU6IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCiAgICAgIGR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAogICAgICB0d2VlbnM6IFtdLAogICAgICBjcmVhdGVUd2VlbjogZnVuY3Rpb24oIHByb3AsIGVuZCApIHsKICAgICAgICB2YXIgdHdlZW4gPSBqUXVlcnkuVHdlZW4oIGVsZW0sIGFuaW1hdGlvbi5vcHRzLCBwcm9wLCBlbmQsCiAgICAgICAgICAgIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmdbIHByb3AgXSB8fCBhbmltYXRpb24ub3B0cy5lYXNpbmcgKTsKICAgICAgICBhbmltYXRpb24udHdlZW5zLnB1c2goIHR3ZWVuICk7CiAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiggZ290b0VuZCApIHsKICAgICAgICB2YXIgaW5kZXggPSAwLAogICAgICAgICAgLy8gaWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBlbmQsIHdlIHdhbnQgdG8gcnVuIGFsbCB0aGUgdHdlZW5zCiAgICAgICAgICAvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKICAgICAgICAgIGxlbmd0aCA9IGdvdG9FbmQgPyBhbmltYXRpb24udHdlZW5zLmxlbmd0aCA6IDA7CiAgICAgICAgaWYgKCBzdG9wcGVkICkgewogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIHN0b3BwZWQgPSB0cnVlOwogICAgICAgIGZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewogICAgICAgICAgYW5pbWF0aW9uLnR3ZWVuc1sgaW5kZXggXS5ydW4oIDEgKTsKICAgICAgICB9CgogICAgICAgIC8vIHJlc29sdmUgd2hlbiB3ZSBwbGF5ZWQgdGhlIGxhc3QgZnJhbWUKICAgICAgICAvLyBvdGhlcndpc2UsIHJlamVjdAogICAgICAgIGlmICggZ290b0VuZCApIHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgZ290b0VuZCBdICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdFdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH0pLAogICAgcHJvcHMgPSBhbmltYXRpb24ucHJvcHM7CgogIHByb3BGaWx0ZXIoIHByb3BzLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nICk7CgogIGZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewogICAgcmVzdWx0ID0gYW5pbWF0aW9uUHJlZmlsdGVyc1sgaW5kZXggXS5jYWxsKCBhbmltYXRpb24sIGVsZW0sIHByb3BzLCBhbmltYXRpb24ub3B0cyApOwogICAgaWYgKCByZXN1bHQgKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgfQoKICBjcmVhdGVUd2VlbnMoIGFuaW1hdGlvbiwgcHJvcHMgKTsKCiAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggYW5pbWF0aW9uLm9wdHMuc3RhcnQgKSApIHsKICAgIGFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoIGVsZW0sIGFuaW1hdGlvbiApOwogIH0KCiAgalF1ZXJ5LmZ4LnRpbWVyKAogICAgalF1ZXJ5LmV4dGVuZCggdGljaywgewogICAgICBlbGVtOiBlbGVtLAogICAgICBhbmltOiBhbmltYXRpb24sCiAgICAgIHF1ZXVlOiBhbmltYXRpb24ub3B0cy5xdWV1ZQogICAgfSkKICApOwoKICAvLyBhdHRhY2ggY2FsbGJhY2tzIGZyb20gb3B0aW9ucwogIHJldHVybiBhbmltYXRpb24ucHJvZ3Jlc3MoIGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzICkKICAgIC5kb25lKCBhbmltYXRpb24ub3B0cy5kb25lLCBhbmltYXRpb24ub3B0cy5jb21wbGV0ZSApCiAgICAuZmFpbCggYW5pbWF0aW9uLm9wdHMuZmFpbCApCiAgICAuYWx3YXlzKCBhbmltYXRpb24ub3B0cy5hbHdheXMgKTsKfQoKZnVuY3Rpb24gcHJvcEZpbHRlciggcHJvcHMsIHNwZWNpYWxFYXNpbmcgKSB7CiAgdmFyIGluZGV4LCBuYW1lLCBlYXNpbmcsIHZhbHVlLCBob29rczsKCiAgLy8gY2FtZWxDYXNlLCBzcGVjaWFsRWFzaW5nIGFuZCBleHBhbmQgY3NzSG9vayBwYXNzCiAgZm9yICggaW5kZXggaW4gcHJvcHMgKSB7CiAgICBuYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggaW5kZXggKTsKICAgIGVhc2luZyA9IHNwZWNpYWxFYXNpbmdbIG5hbWUgXTsKICAgIHZhbHVlID0gcHJvcHNbIGluZGV4IF07CiAgICBpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWx1ZSApICkgewogICAgICBlYXNpbmcgPSB2YWx1ZVsgMSBdOwogICAgICB2YWx1ZSA9IHByb3BzWyBpbmRleCBdID0gdmFsdWVbIDAgXTsKICAgIH0KCiAgICBpZiAoIGluZGV4ICE9PSBuYW1lICkgewogICAgICBwcm9wc1sgbmFtZSBdID0gdmFsdWU7CiAgICAgIGRlbGV0ZSBwcm9wc1sgaW5kZXggXTsKICAgIH0KCiAgICBob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdOwogICAgaWYgKCBob29rcyAmJiAiZXhwYW5kIiBpbiBob29rcyApIHsKICAgICAgdmFsdWUgPSBob29rcy5leHBhbmQoIHZhbHVlICk7CiAgICAgIGRlbGV0ZSBwcm9wc1sgbmFtZSBdOwoKICAgICAgLy8gbm90IHF1aXRlICQuZXh0ZW5kLCB0aGlzIHdvbnQgb3ZlcndyaXRlIGtleXMgYWxyZWFkeSBwcmVzZW50LgogICAgICAvLyBhbHNvIC0gcmV1c2luZyAnaW5kZXgnIGZyb20gYWJvdmUgYmVjYXVzZSB3ZSBoYXZlIHRoZSBjb3JyZWN0ICJuYW1lIgogICAgICBmb3IgKCBpbmRleCBpbiB2YWx1ZSApIHsKICAgICAgICBpZiAoICEoIGluZGV4IGluIHByb3BzICkgKSB7CiAgICAgICAgICBwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyBpbmRleCBdOwogICAgICAgICAgc3BlY2lhbEVhc2luZ1sgaW5kZXggXSA9IGVhc2luZzsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHNwZWNpYWxFYXNpbmdbIG5hbWUgXSA9IGVhc2luZzsKICAgIH0KICB9Cn0KCmpRdWVyeS5BbmltYXRpb24gPSBqUXVlcnkuZXh0ZW5kKCBBbmltYXRpb24sIHsKCiAgdHdlZW5lcjogZnVuY3Rpb24oIHByb3BzLCBjYWxsYmFjayApIHsKICAgIGlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHByb3BzICkgKSB7CiAgICAgIGNhbGxiYWNrID0gcHJvcHM7CiAgICAgIHByb3BzID0gWyAiKiIgXTsKICAgIH0gZWxzZSB7CiAgICAgIHByb3BzID0gcHJvcHMuc3BsaXQoIiAiKTsKICAgIH0KCiAgICB2YXIgcHJvcCwKICAgICAgaW5kZXggPSAwLAogICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CgogICAgZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CiAgICAgIHByb3AgPSBwcm9wc1sgaW5kZXggXTsKICAgICAgdHdlZW5lcnNbIHByb3AgXSA9IHR3ZWVuZXJzWyBwcm9wIF0gfHwgW107CiAgICAgIHR3ZWVuZXJzWyBwcm9wIF0udW5zaGlmdCggY2FsbGJhY2sgKTsKICAgIH0KICB9LAoKICBwcmVmaWx0ZXI6IGZ1bmN0aW9uKCBjYWxsYmFjaywgcHJlcGVuZCApIHsKICAgIGlmICggcHJlcGVuZCApIHsKICAgICAgYW5pbWF0aW9uUHJlZmlsdGVycy51bnNoaWZ0KCBjYWxsYmFjayApOwogICAgfSBlbHNlIHsKICAgICAgYW5pbWF0aW9uUHJlZmlsdGVycy5wdXNoKCBjYWxsYmFjayApOwogICAgfQogIH0KfSk7CgpmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKCBlbGVtLCBwcm9wcywgb3B0cyApIHsKICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogIHZhciBpbmRleCwgcHJvcCwgdmFsdWUsIGxlbmd0aCwgZGF0YVNob3csIHRvZ2dsZSwgdHdlZW4sIGhvb2tzLCBvbGRmaXJlLAogICAgYW5pbSA9IHRoaXMsCiAgICBzdHlsZSA9IGVsZW0uc3R5bGUsCiAgICBvcmlnID0ge30sCiAgICBoYW5kbGVkID0gW10sCiAgICBoaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuKCBlbGVtICk7CgogIC8vIGhhbmRsZSBxdWV1ZTogZmFsc2UgcHJvbWlzZXMKICBpZiAoICFvcHRzLnF1ZXVlICkgewogICAgaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sICJmeCIgKTsKICAgIGlmICggaG9va3MudW5xdWV1ZWQgPT0gbnVsbCApIHsKICAgICAgaG9va3MudW5xdWV1ZWQgPSAwOwogICAgICBvbGRmaXJlID0gaG9va3MuZW1wdHkuZmlyZTsKICAgICAgaG9va3MuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICggIWhvb2tzLnVucXVldWVkICkgewogICAgICAgICAgb2xkZmlyZSgpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIGhvb2tzLnVucXVldWVkKys7CgogICAgYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7CiAgICAgIC8vIGRvaW5nIHRoaXMgbWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wbGV0ZSBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkCiAgICAgIC8vIGJlZm9yZSB0aGlzIGNvbXBsZXRlcwogICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKICAgICAgICBob29rcy51bnF1ZXVlZC0tOwogICAgICAgIGlmICggIWpRdWVyeS5xdWV1ZSggZWxlbSwgImZ4IiApLmxlbmd0aCApIHsKICAgICAgICAgIGhvb2tzLmVtcHR5LmZpcmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAvLyBoZWlnaHQvd2lkdGggb3ZlcmZsb3cgcGFzcwogIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoICJoZWlnaHQiIGluIHByb3BzIHx8ICJ3aWR0aCIgaW4gcHJvcHMgKSApIHsKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAogICAgLy8gUmVjb3JkIGFsbCAzIG92ZXJmbG93IGF0dHJpYnV0ZXMgYmVjYXVzZSBJRSBkb2VzIG5vdAogICAgLy8gY2hhbmdlIHRoZSBvdmVyZmxvdyBhdHRyaWJ1dGUgd2hlbiBvdmVyZmxvd1ggYW5kCiAgICAvLyBvdmVyZmxvd1kgYXJlIHNldCB0byB0aGUgc2FtZSB2YWx1ZQogICAgb3B0cy5vdmVyZmxvdyA9IFsgc3R5bGUub3ZlcmZsb3csIHN0eWxlLm92ZXJmbG93WCwgc3R5bGUub3ZlcmZsb3dZIF07CgogICAgLy8gU2V0IGRpc3BsYXkgcHJvcGVydHkgdG8gaW5saW5lLWJsb2NrIGZvciBoZWlnaHQvd2lkdGgKICAgIC8vIGFuaW1hdGlvbnMgb24gaW5saW5lIGVsZW1lbnRzIHRoYXQgYXJlIGhhdmluZyB3aWR0aC9oZWlnaHQgYW5pbWF0ZWQKICAgIGlmICggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgPT09ICJpbmxpbmUiICYmCiAgICAgICAgalF1ZXJ5LmNzcyggZWxlbSwgImZsb2F0IiApID09PSAibm9uZSIgKSB7CgogICAgICAvLyBpbmxpbmUtbGV2ZWwgZWxlbWVudHMgYWNjZXB0IGlubGluZS1ibG9jazsKICAgICAgLy8gYmxvY2stbGV2ZWwgZWxlbWVudHMgbmVlZCB0byBiZSBpbmxpbmUgd2l0aCBsYXlvdXQKICAgICAgaWYgKCAhalF1ZXJ5LnN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCB8fCBjc3NfZGVmYXVsdERpc3BsYXkoIGVsZW0ubm9kZU5hbWUgKSA9PT0gImlubGluZSIgKSB7CiAgICAgICAgc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUtYmxvY2siOwoKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHlsZS56b29tID0gMTsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKCBvcHRzLm92ZXJmbG93ICkgewogICAgc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsKICAgIGlmICggIWpRdWVyeS5zdXBwb3J0LnNocmlua1dyYXBCbG9ja3MgKSB7CiAgICAgIGFuaW0uZG9uZShmdW5jdGlvbigpIHsKICAgICAgICBzdHlsZS5vdmVyZmxvdyA9IG9wdHMub3ZlcmZsb3dbIDAgXTsKICAgICAgICBzdHlsZS5vdmVyZmxvd1ggPSBvcHRzLm92ZXJmbG93WyAxIF07CiAgICAgICAgc3R5bGUub3ZlcmZsb3dZID0gb3B0cy5vdmVyZmxvd1sgMiBdOwogICAgICB9KTsKICAgIH0KICB9CgoKICAvLyBzaG93L2hpZGUgcGFzcwogIGZvciAoIGluZGV4IGluIHByb3BzICkgewogICAgdmFsdWUgPSBwcm9wc1sgaW5kZXggXTsKICAgIGlmICggcmZ4dHlwZXMuZXhlYyggdmFsdWUgKSApIHsKICAgICAgZGVsZXRlIHByb3BzWyBpbmRleCBdOwogICAgICB0b2dnbGUgPSB0b2dnbGUgfHwgdmFsdWUgPT09ICJ0b2dnbGUiOwogICAgICBpZiAoIHZhbHVlID09PSAoIGhpZGRlbiA/ICJoaWRlIiA6ICJzaG93IiApICkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGhhbmRsZWQucHVzaCggaW5kZXggKTsKICAgIH0KICB9CgogIGxlbmd0aCA9IGhhbmRsZWQubGVuZ3RoOwogIGlmICggbGVuZ3RoICkgewogICAgZGF0YVNob3cgPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJmeHNob3ciICkgfHwgalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiZnhzaG93Iiwge30gKTsKICAgIGlmICggImhpZGRlbiIgaW4gZGF0YVNob3cgKSB7CiAgICAgIGhpZGRlbiA9IGRhdGFTaG93LmhpZGRlbjsKICAgIH0KCiAgICAvLyBzdG9yZSBzdGF0ZSBpZiBpdHMgdG9nZ2xlIC0gZW5hYmxlcyAuc3RvcCgpLnRvZ2dsZSgpIHRvICJyZXZlcnNlIgogICAgaWYgKCB0b2dnbGUgKSB7CiAgICAgIGRhdGFTaG93LmhpZGRlbiA9ICFoaWRkZW47CiAgICB9CiAgICBpZiAoIGhpZGRlbiApIHsKICAgICAgalF1ZXJ5KCBlbGVtICkuc2hvdygpOwogICAgfSBlbHNlIHsKICAgICAgYW5pbS5kb25lKGZ1bmN0aW9uKCkgewogICAgICAgIGpRdWVyeSggZWxlbSApLmhpZGUoKTsKICAgICAgfSk7CiAgICB9CiAgICBhbmltLmRvbmUoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwcm9wOwogICAgICBqUXVlcnkuX3JlbW92ZURhdGEoIGVsZW0sICJmeHNob3ciICk7CiAgICAgIGZvciAoIHByb3AgaW4gb3JpZyApIHsKICAgICAgICBqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AsIG9yaWdbIHByb3AgXSApOwogICAgICB9CiAgICB9KTsKICAgIGZvciAoIGluZGV4ID0gMCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKICAgICAgcHJvcCA9IGhhbmRsZWRbIGluZGV4IF07CiAgICAgIHR3ZWVuID0gYW5pbS5jcmVhdGVUd2VlbiggcHJvcCwgaGlkZGVuID8gZGF0YVNob3dbIHByb3AgXSA6IDAgKTsKICAgICAgb3JpZ1sgcHJvcCBdID0gZGF0YVNob3dbIHByb3AgXSB8fCBqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AgKTsKCiAgICAgIGlmICggISggcHJvcCBpbiBkYXRhU2hvdyApICkgewogICAgICAgIGRhdGFTaG93WyBwcm9wIF0gPSB0d2Vlbi5zdGFydDsKICAgICAgICBpZiAoIGhpZGRlbiApIHsKICAgICAgICAgIHR3ZWVuLmVuZCA9IHR3ZWVuLnN0YXJ0OwogICAgICAgICAgdHdlZW4uc3RhcnQgPSBwcm9wID09PSAid2lkdGgiIHx8IHByb3AgPT09ICJoZWlnaHQiID8gMSA6IDA7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBUd2VlbiggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKSB7CiAgcmV0dXJuIG5ldyBUd2Vlbi5wcm90b3R5cGUuaW5pdCggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKTsKfQpqUXVlcnkuVHdlZW4gPSBUd2VlbjsKClR3ZWVuLnByb3RvdHlwZSA9IHsKICBjb25zdHJ1Y3RvcjogVHdlZW4sCiAgaW5pdDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0ICkgewogICAgdGhpcy5lbGVtID0gZWxlbTsKICAgIHRoaXMucHJvcCA9IHByb3A7CiAgICB0aGlzLmVhc2luZyA9IGVhc2luZyB8fCAic3dpbmciOwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCk7CiAgICB0aGlzLmVuZCA9IGVuZDsKICAgIHRoaXMudW5pdCA9IHVuaXQgfHwgKCBqUXVlcnkuY3NzTnVtYmVyWyBwcm9wIF0gPyAiIiA6ICJweCIgKTsKICB9LAogIGN1cjogZnVuY3Rpb24oKSB7CiAgICB2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbIHRoaXMucHJvcCBdOwoKICAgIHJldHVybiBob29rcyAmJiBob29rcy5nZXQgPwogICAgICBob29rcy5nZXQoIHRoaXMgKSA6CiAgICAgIFR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5nZXQoIHRoaXMgKTsKICB9LAogIHJ1bjogZnVuY3Rpb24oIHBlcmNlbnQgKSB7CiAgICB2YXIgZWFzZWQsCiAgICAgIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCiAgICBpZiAoIHRoaXMub3B0aW9ucy5kdXJhdGlvbiApIHsKICAgICAgdGhpcy5wb3MgPSBlYXNlZCA9IGpRdWVyeS5lYXNpbmdbIHRoaXMuZWFzaW5nIF0oCiAgICAgICAgcGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnBvcyA9IGVhc2VkID0gcGVyY2VudDsKICAgIH0KICAgIHRoaXMubm93ID0gKCB0aGlzLmVuZCAtIHRoaXMuc3RhcnQgKSAqIGVhc2VkICsgdGhpcy5zdGFydDsKCiAgICBpZiAoIHRoaXMub3B0aW9ucy5zdGVwICkgewogICAgICB0aGlzLm9wdGlvbnMuc3RlcC5jYWxsKCB0aGlzLmVsZW0sIHRoaXMubm93LCB0aGlzICk7CiAgICB9CgogICAgaWYgKCBob29rcyAmJiBob29rcy5zZXQgKSB7CiAgICAgIGhvb2tzLnNldCggdGhpcyApOwogICAgfSBlbHNlIHsKICAgICAgVHdlZW4ucHJvcEhvb2tzLl9kZWZhdWx0LnNldCggdGhpcyApOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9OwoKVHdlZW4ucHJvdG90eXBlLmluaXQucHJvdG90eXBlID0gVHdlZW4ucHJvdG90eXBlOwoKVHdlZW4ucHJvcEhvb2tzID0gewogIF9kZWZhdWx0OiB7CiAgICBnZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKICAgICAgdmFyIHJlc3VsdDsKCiAgICAgIGlmICggdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdICE9IG51bGwgJiYKICAgICAgICAoIXR3ZWVuLmVsZW0uc3R5bGUgfHwgdHdlZW4uZWxlbS5zdHlsZVsgdHdlZW4ucHJvcCBdID09IG51bGwpICkgewogICAgICAgIHJldHVybiB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF07CiAgICAgIH0KCiAgICAgIC8vIHBhc3NpbmcgYSBub24gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQogICAgICAvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzCiAgICAgIC8vIHNvLCBzaW1wbGUgdmFsdWVzIHN1Y2ggYXMgIjEwcHgiIGFyZSBwYXJzZWQgdG8gRmxvYXQuCiAgICAgIC8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzIGlzLgogICAgICByZXN1bHQgPSBqUXVlcnkuY3NzKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCAiYXV0byIgKTsKICAgICAgLy8gRW1wdHkgc3RyaW5ncywgbnVsbCwgdW5kZWZpbmVkIGFuZCAiYXV0byIgYXJlIGNvbnZlcnRlZCB0byAwLgogICAgICByZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICJhdXRvIiA/IDAgOiByZXN1bHQ7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiggdHdlZW4gKSB7CiAgICAgIC8vIHVzZSBzdGVwIGhvb2sgZm9yIGJhY2sgY29tcGF0IC0gdXNlIGNzc0hvb2sgaWYgaXRzIHRoZXJlIC0gdXNlIC5zdHlsZSBpZiBpdHMKICAgICAgLy8gYXZhaWxhYmxlIGFuZCB1c2UgcGxhaW4gcHJvcGVydGllcyB3aGVyZSBhdmFpbGFibGUKICAgICAgaWYgKCBqUXVlcnkuZnguc3RlcFsgdHdlZW4ucHJvcCBdICkgewogICAgICAgIGpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0oIHR3ZWVuICk7CiAgICAgIH0gZWxzZSBpZiAoIHR3ZWVuLmVsZW0uc3R5bGUgJiYgKCB0d2Vlbi5lbGVtLnN0eWxlWyBqUXVlcnkuY3NzUHJvcHNbIHR3ZWVuLnByb3AgXSBdICE9IG51bGwgfHwgalF1ZXJ5LmNzc0hvb2tzWyB0d2Vlbi5wcm9wIF0gKSApIHsKICAgICAgICBqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsIHR3ZWVuLm5vdyArIHR3ZWVuLnVuaXQgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gPSB0d2Vlbi5ub3c7CiAgICAgIH0KICAgIH0KICB9Cn07CgovLyBSZW1vdmUgaW4gMi4wIC0gdGhpcyBzdXBwb3J0cyBJRTgncyBwYW5pYyBiYXNlZCBhcHByb2FjaAovLyB0byBzZXR0aW5nIHRoaW5ncyBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKClR3ZWVuLnByb3BIb29rcy5zY3JvbGxUb3AgPSBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9IHsKICBzZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKICAgIGlmICggdHdlZW4uZWxlbS5ub2RlVHlwZSAmJiB0d2Vlbi5lbGVtLnBhcmVudE5vZGUgKSB7CiAgICAgIHR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsKICAgIH0KICB9Cn07CgpqUXVlcnkuZWFjaChbICJ0b2dnbGUiLCAic2hvdyIsICJoaWRlIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKICB2YXIgY3NzRm4gPSBqUXVlcnkuZm5bIG5hbWUgXTsKICBqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKICAgIHJldHVybiBzcGVlZCA9PSBudWxsIHx8IHR5cGVvZiBzcGVlZCA9PT0gImJvb2xlYW4iID8KICAgICAgY3NzRm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApIDoKICAgICAgdGhpcy5hbmltYXRlKCBnZW5GeCggbmFtZSwgdHJ1ZSApLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwogIH07Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CiAgZmFkZVRvOiBmdW5jdGlvbiggc3BlZWQsIHRvLCBlYXNpbmcsIGNhbGxiYWNrICkgewoKICAgIC8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAogICAgcmV0dXJuIHRoaXMuZmlsdGVyKCBpc0hpZGRlbiApLmNzcyggIm9wYWNpdHkiLCAwICkuc2hvdygpCgogICAgICAvLyBhbmltYXRlIHRvIHRoZSB2YWx1ZSBzcGVjaWZpZWQKICAgICAgLmVuZCgpLmFuaW1hdGUoeyBvcGFjaXR5OiB0byB9LCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwogIH0sCiAgYW5pbWF0ZTogZnVuY3Rpb24oIHByb3AsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewogICAgdmFyIGVtcHR5ID0galF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3AgKSwKICAgICAgb3B0YWxsID0galF1ZXJ5LnNwZWVkKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApLAogICAgICBkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIE9wZXJhdGUgb24gYSBjb3B5IG9mIHByb3Agc28gcGVyLXByb3BlcnR5IGVhc2luZyB3b24ndCBiZSBsb3N0CiAgICAgICAgdmFyIGFuaW0gPSBBbmltYXRpb24oIHRoaXMsIGpRdWVyeS5leHRlbmQoIHt9LCBwcm9wICksIG9wdGFsbCApOwogICAgICAgIGRvQW5pbWF0aW9uLmZpbmlzaCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgYW5pbS5zdG9wKCB0cnVlICk7CiAgICAgICAgfTsKICAgICAgICAvLyBFbXB0eSBhbmltYXRpb25zLCBvciBmaW5pc2hpbmcgcmVzb2x2ZXMgaW1tZWRpYXRlbHkKICAgICAgICBpZiAoIGVtcHR5IHx8IGpRdWVyeS5fZGF0YSggdGhpcywgImZpbmlzaCIgKSApIHsKICAgICAgICAgIGFuaW0uc3RvcCggdHJ1ZSApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZG9BbmltYXRpb24uZmluaXNoID0gZG9BbmltYXRpb247CgogICAgcmV0dXJuIGVtcHR5IHx8IG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPwogICAgICB0aGlzLmVhY2goIGRvQW5pbWF0aW9uICkgOgogICAgICB0aGlzLnF1ZXVlKCBvcHRhbGwucXVldWUsIGRvQW5pbWF0aW9uICk7CiAgfSwKICBzdG9wOiBmdW5jdGlvbiggdHlwZSwgY2xlYXJRdWV1ZSwgZ290b0VuZCApIHsKICAgIHZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiggaG9va3MgKSB7CiAgICAgIHZhciBzdG9wID0gaG9va3Muc3RvcDsKICAgICAgZGVsZXRlIGhvb2tzLnN0b3A7CiAgICAgIHN0b3AoIGdvdG9FbmQgKTsKICAgIH07CgogICAgaWYgKCB0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIgKSB7CiAgICAgIGdvdG9FbmQgPSBjbGVhclF1ZXVlOwogICAgICBjbGVhclF1ZXVlID0gdHlwZTsKICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgIH0KICAgIGlmICggY2xlYXJRdWV1ZSAmJiB0eXBlICE9PSBmYWxzZSApIHsKICAgICAgdGhpcy5xdWV1ZSggdHlwZSB8fCAiZngiLCBbXSApOwogICAgfQoKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgIHZhciBkZXF1ZXVlID0gdHJ1ZSwKICAgICAgICBpbmRleCA9IHR5cGUgIT0gbnVsbCAmJiB0eXBlICsgInF1ZXVlSG9va3MiLAogICAgICAgIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsCiAgICAgICAgZGF0YSA9IGpRdWVyeS5fZGF0YSggdGhpcyApOwoKICAgICAgaWYgKCBpbmRleCApIHsKICAgICAgICBpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICkgewogICAgICAgICAgc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoIGluZGV4IGluIGRhdGEgKSB7CiAgICAgICAgICBpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICYmIHJydW4udGVzdCggaW5kZXggKSApIHsKICAgICAgICAgICAgc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKCBpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07ICkgewogICAgICAgIGlmICggdGltZXJzWyBpbmRleCBdLmVsZW0gPT09IHRoaXMgJiYgKHR5cGUgPT0gbnVsbCB8fCB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUpICkgewogICAgICAgICAgdGltZXJzWyBpbmRleCBdLmFuaW0uc3RvcCggZ290b0VuZCApOwogICAgICAgICAgZGVxdWV1ZSA9IGZhbHNlOwogICAgICAgICAgdGltZXJzLnNwbGljZSggaW5kZXgsIDEgKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIHN0YXJ0IHRoZSBuZXh0IGluIHRoZSBxdWV1ZSBpZiB0aGUgbGFzdCBzdGVwIHdhc24ndCBmb3JjZWQKICAgICAgLy8gdGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaCB3aWxsIGRlcXVldWUKICAgICAgLy8gYnV0IG9ubHkgaWYgdGhleSB3ZXJlIGdvdG9FbmQKICAgICAgaWYgKCBkZXF1ZXVlIHx8ICFnb3RvRW5kICkgewogICAgICAgIGpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CiAgICAgIH0KICAgIH0pOwogIH0sCiAgZmluaXNoOiBmdW5jdGlvbiggdHlwZSApIHsKICAgIGlmICggdHlwZSAhPT0gZmFsc2UgKSB7CiAgICAgIHR5cGUgPSB0eXBlIHx8ICJmeCI7CiAgICB9CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICB2YXIgaW5kZXgsCiAgICAgICAgZGF0YSA9IGpRdWVyeS5fZGF0YSggdGhpcyApLAogICAgICAgIHF1ZXVlID0gZGF0YVsgdHlwZSArICJxdWV1ZSIgXSwKICAgICAgICBob29rcyA9IGRhdGFbIHR5cGUgKyAicXVldWVIb29rcyIgXSwKICAgICAgICB0aW1lcnMgPSBqUXVlcnkudGltZXJzLAogICAgICAgIGxlbmd0aCA9IHF1ZXVlID8gcXVldWUubGVuZ3RoIDogMDsKCiAgICAgIC8vIGVuYWJsZSBmaW5pc2hpbmcgZmxhZyBvbiBwcml2YXRlIGRhdGEKICAgICAgZGF0YS5maW5pc2ggPSB0cnVlOwoKICAgICAgLy8gZW1wdHkgdGhlIHF1ZXVlIGZpcnN0CiAgICAgIGpRdWVyeS5xdWV1ZSggdGhpcywgdHlwZSwgW10gKTsKCiAgICAgIGlmICggaG9va3MgJiYgaG9va3MuY3VyICYmIGhvb2tzLmN1ci5maW5pc2ggKSB7CiAgICAgICAgaG9va3MuY3VyLmZpbmlzaC5jYWxsKCB0aGlzICk7CiAgICAgIH0KCiAgICAgIC8vIGxvb2sgZm9yIGFueSBhY3RpdmUgYW5pbWF0aW9ucywgYW5kIGZpbmlzaCB0aGVtCiAgICAgIGZvciAoIGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTsgKSB7CiAgICAgICAgaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJiB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUgKSB7CiAgICAgICAgICB0aW1lcnNbIGluZGV4IF0uYW5pbS5zdG9wKCB0cnVlICk7CiAgICAgICAgICB0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gbG9vayBmb3IgYW55IGFuaW1hdGlvbnMgaW4gdGhlIG9sZCBxdWV1ZSBhbmQgZmluaXNoIHRoZW0KICAgICAgZm9yICggaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKICAgICAgICBpZiAoIHF1ZXVlWyBpbmRleCBdICYmIHF1ZXVlWyBpbmRleCBdLmZpbmlzaCApIHsKICAgICAgICAgIHF1ZXVlWyBpbmRleCBdLmZpbmlzaC5jYWxsKCB0aGlzICk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyB0dXJuIG9mZiBmaW5pc2hpbmcgZmxhZwogICAgICBkZWxldGUgZGF0YS5maW5pc2g7CiAgICB9KTsKICB9Cn0pOwoKLy8gR2VuZXJhdGUgcGFyYW1ldGVycyB0byBjcmVhdGUgYSBzdGFuZGFyZCBhbmltYXRpb24KZnVuY3Rpb24gZ2VuRngoIHR5cGUsIGluY2x1ZGVXaWR0aCApIHsKICB2YXIgd2hpY2gsCiAgICBhdHRycyA9IHsgaGVpZ2h0OiB0eXBlIH0sCiAgICBpID0gMDsKCiAgLy8gaWYgd2UgaW5jbHVkZSB3aWR0aCwgc3RlcCB2YWx1ZSBpcyAxIHRvIGRvIGFsbCBjc3NFeHBhbmQgdmFsdWVzLAogIC8vIGlmIHdlIGRvbid0IGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKICBpbmNsdWRlV2lkdGggPSBpbmNsdWRlV2lkdGg/IDEgOiAwOwogIGZvciggOyBpIDwgNCA7IGkgKz0gMiAtIGluY2x1ZGVXaWR0aCApIHsKICAgIHdoaWNoID0gY3NzRXhwYW5kWyBpIF07CiAgICBhdHRyc1sgIm1hcmdpbiIgKyB3aGljaCBdID0gYXR0cnNbICJwYWRkaW5nIiArIHdoaWNoIF0gPSB0eXBlOwogIH0KCiAgaWYgKCBpbmNsdWRlV2lkdGggKSB7CiAgICBhdHRycy5vcGFjaXR5ID0gYXR0cnMud2lkdGggPSB0eXBlOwogIH0KCiAgcmV0dXJuIGF0dHJzOwp9CgovLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCmpRdWVyeS5lYWNoKHsKICBzbGlkZURvd246IGdlbkZ4KCJzaG93IiksCiAgc2xpZGVVcDogZ2VuRngoImhpZGUiKSwKICBzbGlkZVRvZ2dsZTogZ2VuRngoInRvZ2dsZSIpLAogIGZhZGVJbjogeyBvcGFjaXR5OiAic2hvdyIgfSwKICBmYWRlT3V0OiB7IG9wYWNpdHk6ICJoaWRlIiB9LAogIGZhZGVUb2dnbGU6IHsgb3BhY2l0eTogInRvZ2dsZSIgfQp9LCBmdW5jdGlvbiggbmFtZSwgcHJvcHMgKSB7CiAgalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CiAgICByZXR1cm4gdGhpcy5hbmltYXRlKCBwcm9wcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKICB9Owp9KTsKCmpRdWVyeS5zcGVlZCA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBmbiApIHsKICB2YXIgb3B0ID0gc3BlZWQgJiYgdHlwZW9mIHNwZWVkID09PSAib2JqZWN0IiA/IGpRdWVyeS5leHRlbmQoIHt9LCBzcGVlZCApIDogewogICAgY29tcGxldGU6IGZuIHx8ICFmbiAmJiBlYXNpbmcgfHwKICAgICAgalF1ZXJ5LmlzRnVuY3Rpb24oIHNwZWVkICkgJiYgc3BlZWQsCiAgICBkdXJhdGlvbjogc3BlZWQsCiAgICBlYXNpbmc6IGZuICYmIGVhc2luZyB8fCBlYXNpbmcgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKCBlYXNpbmcgKSAmJiBlYXNpbmcKICB9OwoKICBvcHQuZHVyYXRpb24gPSBqUXVlcnkuZngub2ZmID8gMCA6IHR5cGVvZiBvcHQuZHVyYXRpb24gPT09ICJudW1iZXIiID8gb3B0LmR1cmF0aW9uIDoKICAgIG9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzID8galF1ZXJ5LmZ4LnNwZWVkc1sgb3B0LmR1cmF0aW9uIF0gOiBqUXVlcnkuZnguc3BlZWRzLl9kZWZhdWx0OwoKICAvLyBub3JtYWxpemUgb3B0LnF1ZXVlIC0gdHJ1ZS91bmRlZmluZWQvbnVsbCAtPiAiZngiCiAgaWYgKCBvcHQucXVldWUgPT0gbnVsbCB8fCBvcHQucXVldWUgPT09IHRydWUgKSB7CiAgICBvcHQucXVldWUgPSAiZngiOwogIH0KCiAgLy8gUXVldWVpbmcKICBvcHQub2xkID0gb3B0LmNvbXBsZXRlOwoKICBvcHQuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgIGlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIG9wdC5vbGQgKSApIHsKICAgICAgb3B0Lm9sZC5jYWxsKCB0aGlzICk7CiAgICB9CgogICAgaWYgKCBvcHQucXVldWUgKSB7CiAgICAgIGpRdWVyeS5kZXF1ZXVlKCB0aGlzLCBvcHQucXVldWUgKTsKICAgIH0KICB9OwoKICByZXR1cm4gb3B0Owp9OwoKalF1ZXJ5LmVhc2luZyA9IHsKICBsaW5lYXI6IGZ1bmN0aW9uKCBwICkgewogICAgcmV0dXJuIHA7CiAgfSwKICBzd2luZzogZnVuY3Rpb24oIHAgKSB7CiAgICByZXR1cm4gMC41IC0gTWF0aC5jb3MoIHAqTWF0aC5QSSApIC8gMjsKICB9Cn07CgpqUXVlcnkudGltZXJzID0gW107CmpRdWVyeS5meCA9IFR3ZWVuLnByb3RvdHlwZS5pbml0OwpqUXVlcnkuZngudGljayA9IGZ1bmN0aW9uKCkgewogIHZhciB0aW1lciwKICAgIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsCiAgICBpID0gMDsKCiAgZnhOb3cgPSBqUXVlcnkubm93KCk7CgogIGZvciAoIDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKyApIHsKICAgIHRpbWVyID0gdGltZXJzWyBpIF07CiAgICAvLyBDaGVja3MgdGhlIHRpbWVyIGhhcyBub3QgYWxyZWFkeSBiZWVuIHJlbW92ZWQKICAgIGlmICggIXRpbWVyKCkgJiYgdGltZXJzWyBpIF0gPT09IHRpbWVyICkgewogICAgICB0aW1lcnMuc3BsaWNlKCBpLS0sIDEgKTsKICAgIH0KICB9CgogIGlmICggIXRpbWVycy5sZW5ndGggKSB7CiAgICBqUXVlcnkuZnguc3RvcCgpOwogIH0KICBmeE5vdyA9IHVuZGVmaW5lZDsKfTsKCmpRdWVyeS5meC50aW1lciA9IGZ1bmN0aW9uKCB0aW1lciApIHsKICBpZiAoIHRpbWVyKCkgJiYgalF1ZXJ5LnRpbWVycy5wdXNoKCB0aW1lciApICkgewogICAgalF1ZXJ5LmZ4LnN0YXJ0KCk7CiAgfQp9OwoKalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7CgpqUXVlcnkuZnguc3RhcnQgPSBmdW5jdGlvbigpIHsKICBpZiAoICF0aW1lcklkICkgewogICAgdGltZXJJZCA9IHNldEludGVydmFsKCBqUXVlcnkuZngudGljaywgalF1ZXJ5LmZ4LmludGVydmFsICk7CiAgfQp9OwoKalF1ZXJ5LmZ4LnN0b3AgPSBmdW5jdGlvbigpIHsKICBjbGVhckludGVydmFsKCB0aW1lcklkICk7CiAgdGltZXJJZCA9IG51bGw7Cn07CgpqUXVlcnkuZnguc3BlZWRzID0gewogIHNsb3c6IDYwMCwKICBmYXN0OiAyMDAsCiAgLy8gRGVmYXVsdCBzcGVlZAogIF9kZWZhdWx0OiA0MDAKfTsKCi8vIEJhY2sgQ29tcGF0IDwxLjggZXh0ZW5zaW9uIHBvaW50CmpRdWVyeS5meC5zdGVwID0ge307CgppZiAoIGpRdWVyeS5leHByICYmIGpRdWVyeS5leHByLmZpbHRlcnMgKSB7CiAgalF1ZXJ5LmV4cHIuZmlsdGVycy5hbmltYXRlZCA9IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGpRdWVyeS5ncmVwKGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uKCBmbiApIHsKICAgICAgcmV0dXJuIGVsZW0gPT09IGZuLmVsZW07CiAgICB9KS5sZW5ndGg7CiAgfTsKfQpqUXVlcnkuZm4ub2Zmc2V0ID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CiAgaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewogICAgcmV0dXJuIG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/CiAgICAgIHRoaXMgOgogICAgICB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CiAgICAgICAgalF1ZXJ5Lm9mZnNldC5zZXRPZmZzZXQoIHRoaXMsIG9wdGlvbnMsIGkgKTsKICAgICAgfSk7CiAgfQoKICB2YXIgZG9jRWxlbSwgd2luLAogICAgYm94ID0geyB0b3A6IDAsIGxlZnQ6IDAgfSwKICAgIGVsZW0gPSB0aGlzWyAwIF0sCiAgICBkb2MgPSBlbGVtICYmIGVsZW0ub3duZXJEb2N1bWVudDsKCiAgaWYgKCAhZG9jICkgewogICAgcmV0dXJuOwogIH0KCiAgZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQ7CgogIC8vIE1ha2Ugc3VyZSBpdCdzIG5vdCBhIGRpc2Nvbm5lY3RlZCBET00gbm9kZQogIGlmICggIWpRdWVyeS5jb250YWlucyggZG9jRWxlbSwgZWxlbSApICkgewogICAgcmV0dXJuIGJveDsKICB9CgogIC8vIElmIHdlIGRvbid0IGhhdmUgZ0JDUiwganVzdCB1c2UgMCwwIHJhdGhlciB0aGFuIGVycm9yCiAgLy8gQmxhY2tCZXJyeSA1LCBpT1MgMyAob3JpZ2luYWwgaVBob25lKQogIGlmICggdHlwZW9mIGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIiApIHsKICAgIGJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgfQogIHdpbiA9IGdldFdpbmRvdyggZG9jICk7CiAgcmV0dXJuIHsKICAgIHRvcDogYm94LnRvcCAgKyAoIHdpbi5wYWdlWU9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbFRvcCApICAtICggZG9jRWxlbS5jbGllbnRUb3AgIHx8IDAgKSwKICAgIGxlZnQ6IGJveC5sZWZ0ICsgKCB3aW4ucGFnZVhPZmZzZXQgfHwgZG9jRWxlbS5zY3JvbGxMZWZ0ICkgLSAoIGRvY0VsZW0uY2xpZW50TGVmdCB8fCAwICkKICB9Owp9OwoKalF1ZXJ5Lm9mZnNldCA9IHsKCiAgc2V0T2Zmc2V0OiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgaSApIHsKICAgIHZhciBwb3NpdGlvbiA9IGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKTsKCiAgICAvLyBzZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCiAgICBpZiAoIHBvc2l0aW9uID09PSAic3RhdGljIiApIHsKICAgICAgZWxlbS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgICB9CgogICAgdmFyIGN1ckVsZW0gPSBqUXVlcnkoIGVsZW0gKSwKICAgICAgY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKSwKICAgICAgY3VyQ1NTVG9wID0galF1ZXJ5LmNzcyggZWxlbSwgInRvcCIgKSwKICAgICAgY3VyQ1NTTGVmdCA9IGpRdWVyeS5jc3MoIGVsZW0sICJsZWZ0IiApLAogICAgICBjYWxjdWxhdGVQb3NpdGlvbiA9ICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSAmJiBqUXVlcnkuaW5BcnJheSgiYXV0byIsIFtjdXJDU1NUb3AsIGN1ckNTU0xlZnRdKSA+IC0xLAogICAgICBwcm9wcyA9IHt9LCBjdXJQb3NpdGlvbiA9IHt9LCBjdXJUb3AsIGN1ckxlZnQ7CgogICAgLy8gbmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIgdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCiAgICBpZiAoIGNhbGN1bGF0ZVBvc2l0aW9uICkgewogICAgICBjdXJQb3NpdGlvbiA9IGN1ckVsZW0ucG9zaXRpb24oKTsKICAgICAgY3VyVG9wID0gY3VyUG9zaXRpb24udG9wOwogICAgICBjdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKICAgIH0gZWxzZSB7CiAgICAgIGN1clRvcCA9IHBhcnNlRmxvYXQoIGN1ckNTU1RvcCApIHx8IDA7CiAgICAgIGN1ckxlZnQgPSBwYXJzZUZsb2F0KCBjdXJDU1NMZWZ0ICkgfHwgMDsKICAgIH0KCiAgICBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBvcHRpb25zICkgKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zLmNhbGwoIGVsZW0sIGksIGN1ck9mZnNldCApOwogICAgfQoKICAgIGlmICggb3B0aW9ucy50b3AgIT0gbnVsbCApIHsKICAgICAgcHJvcHMudG9wID0gKCBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKSArIGN1clRvcDsKICAgIH0KICAgIGlmICggb3B0aW9ucy5sZWZ0ICE9IG51bGwgKSB7CiAgICAgIHByb3BzLmxlZnQgPSAoIG9wdGlvbnMubGVmdCAtIGN1ck9mZnNldC5sZWZ0ICkgKyBjdXJMZWZ0OwogICAgfQoKICAgIGlmICggInVzaW5nIiBpbiBvcHRpb25zICkgewogICAgICBvcHRpb25zLnVzaW5nLmNhbGwoIGVsZW0sIHByb3BzICk7CiAgICB9IGVsc2UgewogICAgICBjdXJFbGVtLmNzcyggcHJvcHMgKTsKICAgIH0KICB9Cn07CgoKalF1ZXJ5LmZuLmV4dGVuZCh7CgogIHBvc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgIGlmICggIXRoaXNbIDAgXSApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBvZmZzZXRQYXJlbnQsIG9mZnNldCwKICAgICAgcGFyZW50T2Zmc2V0ID0geyB0b3A6IDAsIGxlZnQ6IDAgfSwKICAgICAgZWxlbSA9IHRoaXNbIDAgXTsKCiAgICAvLyBmaXhlZCBlbGVtZW50cyBhcmUgb2Zmc2V0IGZyb20gd2luZG93IChwYXJlbnRPZmZzZXQgPSB7dG9wOjAsIGxlZnQ6IDB9LCBiZWNhdXNlIGl0IGlzIGl0J3Mgb25seSBvZmZzZXQgcGFyZW50CiAgICBpZiAoIGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKSA9PT0gImZpeGVkIiApIHsKICAgICAgLy8gd2UgYXNzdW1lIHRoYXQgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IGlzIGF2YWlsYWJsZSB3aGVuIGNvbXB1dGVkIHBvc2l0aW9uIGlzIGZpeGVkCiAgICAgIG9mZnNldCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB9IGVsc2UgewogICAgICAvLyBHZXQgKnJlYWwqIG9mZnNldFBhcmVudAogICAgICBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpOwoKICAgICAgLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwogICAgICBvZmZzZXQgPSB0aGlzLm9mZnNldCgpOwogICAgICBpZiAoICFqUXVlcnkubm9kZU5hbWUoIG9mZnNldFBhcmVudFsgMCBdLCAiaHRtbCIgKSApIHsKICAgICAgICBwYXJlbnRPZmZzZXQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0KCk7CiAgICAgIH0KCiAgICAgIC8vIEFkZCBvZmZzZXRQYXJlbnQgYm9yZGVycwogICAgICBwYXJlbnRPZmZzZXQudG9wICArPSBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnRbIDAgXSwgImJvcmRlclRvcFdpZHRoIiwgdHJ1ZSApOwogICAgICBwYXJlbnRPZmZzZXQubGVmdCArPSBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnRbIDAgXSwgImJvcmRlckxlZnRXaWR0aCIsIHRydWUgKTsKICAgIH0KCiAgICAvLyBTdWJ0cmFjdCBwYXJlbnQgb2Zmc2V0cyBhbmQgZWxlbWVudCBtYXJnaW5zCiAgICAvLyBub3RlOiB3aGVuIGFuIGVsZW1lbnQgaGFzIG1hcmdpbjogYXV0byB0aGUgb2Zmc2V0TGVmdCBhbmQgbWFyZ2luTGVmdAogICAgLy8gYXJlIHRoZSBzYW1lIGluIFNhZmFyaSBjYXVzaW5nIG9mZnNldC5sZWZ0IHRvIGluY29ycmVjdGx5IGJlIDAKICAgIHJldHVybiB7CiAgICAgIHRvcDogIG9mZnNldC50b3AgIC0gcGFyZW50T2Zmc2V0LnRvcCAtIGpRdWVyeS5jc3MoIGVsZW0sICJtYXJnaW5Ub3AiLCB0cnVlICksCiAgICAgIGxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luTGVmdCIsIHRydWUpCiAgICB9OwogIH0sCgogIG9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICAgIHdoaWxlICggb2Zmc2V0UGFyZW50ICYmICggIWpRdWVyeS5ub2RlTmFtZSggb2Zmc2V0UGFyZW50LCAiaHRtbCIgKSAmJiBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIiApICkgewogICAgICAgIG9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CiAgICAgIH0KICAgICAgcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICB9KTsKICB9Cn0pOwoKCi8vIENyZWF0ZSBzY3JvbGxMZWZ0IGFuZCBzY3JvbGxUb3AgbWV0aG9kcwpqUXVlcnkuZWFjaCgge3Njcm9sbExlZnQ6ICJwYWdlWE9mZnNldCIsIHNjcm9sbFRvcDogInBhZ2VZT2Zmc2V0In0sIGZ1bmN0aW9uKCBtZXRob2QsIHByb3AgKSB7CiAgdmFyIHRvcCA9IC9ZLy50ZXN0KCBwcm9wICk7CgogIGpRdWVyeS5mblsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdmFsICkgewogICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBtZXRob2QsIHZhbCApIHsKICAgICAgdmFyIHdpbiA9IGdldFdpbmRvdyggZWxlbSApOwoKICAgICAgaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsKICAgICAgICByZXR1cm4gd2luID8gKHByb3AgaW4gd2luKSA/IHdpblsgcHJvcCBdIDoKICAgICAgICAgIHdpbi5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbIG1ldGhvZCBdIDoKICAgICAgICAgIGVsZW1bIG1ldGhvZCBdOwogICAgICB9CgogICAgICBpZiAoIHdpbiApIHsKICAgICAgICB3aW4uc2Nyb2xsVG8oCiAgICAgICAgICAhdG9wID8gdmFsIDogalF1ZXJ5KCB3aW4gKS5zY3JvbGxMZWZ0KCksCiAgICAgICAgICB0b3AgPyB2YWwgOiBqUXVlcnkoIHdpbiApLnNjcm9sbFRvcCgpCiAgICAgICAgKTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWxlbVsgbWV0aG9kIF0gPSB2YWw7CiAgICAgIH0KICAgIH0sIG1ldGhvZCwgdmFsLCBhcmd1bWVudHMubGVuZ3RoLCBudWxsICk7CiAgfTsKfSk7CgpmdW5jdGlvbiBnZXRXaW5kb3coIGVsZW0gKSB7CiAgcmV0dXJuIGpRdWVyeS5pc1dpbmRvdyggZWxlbSApID8KICAgIGVsZW0gOgogICAgZWxlbS5ub2RlVHlwZSA9PT0gOSA/CiAgICAgIGVsZW0uZGVmYXVsdFZpZXcgfHwgZWxlbS5wYXJlbnRXaW5kb3cgOgogICAgICBmYWxzZTsKfQovLyBDcmVhdGUgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGgsIGhlaWdodCwgd2lkdGgsIG91dGVySGVpZ2h0IGFuZCBvdXRlcldpZHRoIG1ldGhvZHMKalF1ZXJ5LmVhY2goIHsgSGVpZ2h0OiAiaGVpZ2h0IiwgV2lkdGg6ICJ3aWR0aCIgfSwgZnVuY3Rpb24oIG5hbWUsIHR5cGUgKSB7CiAgalF1ZXJ5LmVhY2goIHsgcGFkZGluZzogImlubmVyIiArIG5hbWUsIGNvbnRlbnQ6IHR5cGUsICIiOiAib3V0ZXIiICsgbmFtZSB9LCBmdW5jdGlvbiggZGVmYXVsdEV4dHJhLCBmdW5jTmFtZSApIHsKICAgIC8vIG1hcmdpbiBpcyBvbmx5IGZvciBvdXRlckhlaWdodCwgb3V0ZXJXaWR0aAogICAgalF1ZXJ5LmZuWyBmdW5jTmFtZSBdID0gZnVuY3Rpb24oIG1hcmdpbiwgdmFsdWUgKSB7CiAgICAgIHZhciBjaGFpbmFibGUgPSBhcmd1bWVudHMubGVuZ3RoICYmICggZGVmYXVsdEV4dHJhIHx8IHR5cGVvZiBtYXJnaW4gIT09ICJib29sZWFuIiApLAogICAgICAgIGV4dHJhID0gZGVmYXVsdEV4dHJhIHx8ICggbWFyZ2luID09PSB0cnVlIHx8IHZhbHVlID09PSB0cnVlID8gIm1hcmdpbiIgOiAiYm9yZGVyIiApOwoKICAgICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCB2YWx1ZSApIHsKICAgICAgICB2YXIgZG9jOwoKICAgICAgICBpZiAoIGpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewogICAgICAgICAgLy8gQXMgb2YgNS84LzIwMTIgdGhpcyB3aWxsIHlpZWxkIGluY29ycmVjdCByZXN1bHRzIGZvciBNb2JpbGUgU2FmYXJpLCBidXQgdGhlcmUKICAgICAgICAgIC8vIGlzbid0IGEgd2hvbGUgbG90IHdlIGNhbiBkby4gU2VlIHB1bGwgcmVxdWVzdCBhdCB0aGlzIFVSTCBmb3IgZGlzY3Vzc2lvbjoKICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNzY0CiAgICAgICAgICByZXR1cm4gZWxlbS5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbICJjbGllbnQiICsgbmFtZSBdOwogICAgICAgIH0KCiAgICAgICAgLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodAogICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsKICAgICAgICAgIGRvYyA9IGVsZW0uZG9jdW1lbnRFbGVtZW50OwoKICAgICAgICAgIC8vIEVpdGhlciBzY3JvbGxbV2lkdGgvSGVpZ2h0XSBvciBvZmZzZXRbV2lkdGgvSGVpZ2h0XSBvciBjbGllbnRbV2lkdGgvSGVpZ2h0XSwgd2hpY2hldmVyIGlzIGdyZWF0ZXN0CiAgICAgICAgICAvLyB1bmZvcnR1bmF0ZWx5LCB0aGlzIGNhdXNlcyBidWcgIzM4MzggaW4gSUU2Lzggb25seSwgYnV0IHRoZXJlIGlzIGN1cnJlbnRseSBubyBnb29kLCBzbWFsbCB3YXkgdG8gZml4IGl0LgogICAgICAgICAgcmV0dXJuIE1hdGgubWF4KAogICAgICAgICAgICBlbGVtLmJvZHlbICJzY3JvbGwiICsgbmFtZSBdLCBkb2NbICJzY3JvbGwiICsgbmFtZSBdLAogICAgICAgICAgICBlbGVtLmJvZHlbICJvZmZzZXQiICsgbmFtZSBdLCBkb2NbICJvZmZzZXQiICsgbmFtZSBdLAogICAgICAgICAgICBkb2NbICJjbGllbnQiICsgbmFtZSBdCiAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwogICAgICAgICAgLy8gR2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCwgcmVxdWVzdGluZyBidXQgbm90IGZvcmNpbmcgcGFyc2VGbG9hdAogICAgICAgICAgalF1ZXJ5LmNzcyggZWxlbSwgdHlwZSwgZXh0cmEgKSA6CgogICAgICAgICAgLy8gU2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudAogICAgICAgICAgalF1ZXJ5LnN0eWxlKCBlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEgKTsKICAgICAgfSwgdHlwZSwgY2hhaW5hYmxlID8gbWFyZ2luIDogdW5kZWZpbmVkLCBjaGFpbmFibGUsIG51bGwgKTsKICAgIH07CiAgfSk7Cn0pOwovLyBMaW1pdCBzY29wZSBwb2xsdXRpb24gZnJvbSBhbnkgZGVwcmVjYXRlZCBBUEkKLy8gKGZ1bmN0aW9uKCkgewoKLy8gfSkoKTsKLy8gRXhwb3NlIGpRdWVyeSB0byB0aGUgZ2xvYmFsIG9iamVjdAp3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7CgovLyBFeHBvc2UgalF1ZXJ5IGFzIGFuIEFNRCBtb2R1bGUsIGJ1dCBvbmx5IGZvciBBTUQgbG9hZGVycyB0aGF0Ci8vIHVuZGVyc3RhbmQgdGhlIGlzc3VlcyB3aXRoIGxvYWRpbmcgbXVsdGlwbGUgdmVyc2lvbnMgb2YgalF1ZXJ5Ci8vIGluIGEgcGFnZSB0aGF0IGFsbCBtaWdodCBjYWxsIGRlZmluZSgpLiBUaGUgbG9hZGVyIHdpbGwgaW5kaWNhdGUKLy8gdGhleSBoYXZlIHNwZWNpYWwgYWxsb3dhbmNlcyBmb3IgbXVsdGlwbGUgalF1ZXJ5IHZlcnNpb25zIGJ5Ci8vIHNwZWNpZnlpbmcgZGVmaW5lLmFtZC5qUXVlcnkgPSB0cnVlLiBSZWdpc3RlciBhcyBhIG5hbWVkIG1vZHVsZSwKLy8gc2luY2UgalF1ZXJ5IGNhbiBiZSBjb25jYXRlbmF0ZWQgd2l0aCBvdGhlciBmaWxlcyB0aGF0IG1heSB1c2UgZGVmaW5lLAovLyBidXQgbm90IHVzZSBhIHByb3BlciBjb25jYXRlbmF0aW9uIHNjcmlwdCB0aGF0IHVuZGVyc3RhbmRzIGFub255bW91cwovLyBBTUQgbW9kdWxlcy4gQSBuYW1lZCBBTUQgaXMgc2FmZXN0IGFuZCBtb3N0IHJvYnVzdCB3YXkgdG8gcmVnaXN0ZXIuCi8vIExvd2VyY2FzZSBqcXVlcnkgaXMgdXNlZCBiZWNhdXNlIEFNRCBtb2R1bGUgbmFtZXMgYXJlIGRlcml2ZWQgZnJvbQovLyBmaWxlIG5hbWVzLCBhbmQgalF1ZXJ5IGlzIG5vcm1hbGx5IGRlbGl2ZXJlZCBpbiBhIGxvd2VyY2FzZSBmaWxlIG5hbWUuCi8vIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgdGhlIGdsb2JhbCBzbyB0aGF0IGlmIGFuIEFNRCBtb2R1bGUgd2FudHMgdG8gY2FsbAovLyBub0NvbmZsaWN0IHRvIGhpZGUgdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSwgaXQgd2lsbCB3b3JrLgppZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCAmJiBkZWZpbmUuYW1kLmpRdWVyeSApIHsKICBkZWZpbmUoICJqcXVlcnkiLCBbXSwgZnVuY3Rpb24gKCkgeyByZXR1cm4galF1ZXJ5OyB9ICk7Cn0KCn0pKCB3aW5kb3cgKTsKLy8gbGliL2hhbmRsZWJhcnMvYmFzZS5qcwoKLypqc2hpbnQgZXFudWxsOnRydWUqLwp0aGlzLkhhbmRsZWJhcnMgPSB7fTsKCihmdW5jdGlvbihIYW5kbGViYXJzKSB7CgpIYW5kbGViYXJzLlZFUlNJT04gPSAiMS4wLnJjLjEiOwoKSGFuZGxlYmFycy5oZWxwZXJzICA9IHt9OwpIYW5kbGViYXJzLnBhcnRpYWxzID0ge307CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyID0gZnVuY3Rpb24obmFtZSwgZm4sIGludmVyc2UpIHsKICBpZihpbnZlcnNlKSB7IGZuLm5vdCA9IGludmVyc2U7IH0KICB0aGlzLmhlbHBlcnNbbmFtZV0gPSBmbjsKfTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJQYXJ0aWFsID0gZnVuY3Rpb24obmFtZSwgc3RyKSB7CiAgdGhpcy5wYXJ0aWFsc1tuYW1lXSA9IHN0cjsKfTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2hlbHBlck1pc3NpbmcnLCBmdW5jdGlvbihhcmcpIHsKICBpZihhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICByZXR1cm4gdW5kZWZpbmVkOwogIH0gZWxzZSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkNvdWxkIG5vdCBmaW5kIHByb3BlcnR5ICciICsgYXJnICsgIiciKTsKICB9Cn0pOwoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywgZnVuY3Rpb25UeXBlID0gIltvYmplY3QgRnVuY3Rpb25dIjsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2Jsb2NrSGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICB2YXIgaW52ZXJzZSA9IG9wdGlvbnMuaW52ZXJzZSB8fCBmdW5jdGlvbigpIHt9LCBmbiA9IG9wdGlvbnMuZm47CgoKICB2YXIgcmV0ID0gIiI7CiAgdmFyIHR5cGUgPSB0b1N0cmluZy5jYWxsKGNvbnRleHQpOwoKICBpZih0eXBlID09PSBmdW5jdGlvblR5cGUpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfQoKICBpZihjb250ZXh0ID09PSB0cnVlKSB7CiAgICByZXR1cm4gZm4odGhpcyk7CiAgfSBlbHNlIGlmKGNvbnRleHQgPT09IGZhbHNlIHx8IGNvbnRleHQgPT0gbnVsbCkgewogICAgcmV0dXJuIGludmVyc2UodGhpcyk7CiAgfSBlbHNlIGlmKHR5cGUgPT09ICJbb2JqZWN0IEFycmF5XSIpIHsKICAgIGlmKGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gSGFuZGxlYmFycy5oZWxwZXJzLmVhY2goY29udGV4dCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0dXJuIGZuKGNvbnRleHQpOwogIH0KfSk7CgpIYW5kbGViYXJzLksgPSBmdW5jdGlvbigpIHt9OwoKSGFuZGxlYmFycy5jcmVhdGVGcmFtZSA9IE9iamVjdC5jcmVhdGUgfHwgZnVuY3Rpb24ob2JqZWN0KSB7CiAgSGFuZGxlYmFycy5LLnByb3RvdHlwZSA9IG9iamVjdDsKICB2YXIgb2JqID0gbmV3IEhhbmRsZWJhcnMuSygpOwogIEhhbmRsZWJhcnMuSy5wcm90b3R5cGUgPSBudWxsOwogIHJldHVybiBvYmo7Cn07CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlYWNoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgdmFyIHJldCA9ICIiLCBkYXRhOwoKICBpZiAob3B0aW9ucy5kYXRhKSB7CiAgICBkYXRhID0gSGFuZGxlYmFycy5jcmVhdGVGcmFtZShvcHRpb25zLmRhdGEpOwogIH0KCiAgaWYoY29udGV4dCAmJiBjb250ZXh0Lmxlbmd0aCA+IDApIHsKICAgIGZvcih2YXIgaT0wLCBqPWNvbnRleHQubGVuZ3RoOyBpPGo7IGkrKykgewogICAgICBpZiAoZGF0YSkgeyBkYXRhLmluZGV4ID0gaTsgfQogICAgICByZXQgPSByZXQgKyBmbihjb250ZXh0W2ldLCB7IGRhdGE6IGRhdGEgfSk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHJldCA9IGludmVyc2UodGhpcyk7CiAgfQogIHJldHVybiByZXQ7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWYnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIHR5cGUgPSB0b1N0cmluZy5jYWxsKGNvbnRleHQpOwogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmKCFjb250ZXh0IHx8IEhhbmRsZWJhcnMuVXRpbHMuaXNFbXB0eShjb250ZXh0KSkgewogICAgcmV0dXJuIG9wdGlvbnMuaW52ZXJzZSh0aGlzKTsKICB9IGVsc2UgewogICAgcmV0dXJuIG9wdGlvbnMuZm4odGhpcyk7CiAgfQp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3VubGVzcycsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICB2YXIgZm4gPSBvcHRpb25zLmZuLCBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlOwogIG9wdGlvbnMuZm4gPSBpbnZlcnNlOwogIG9wdGlvbnMuaW52ZXJzZSA9IGZuOwoKICByZXR1cm4gSGFuZGxlYmFycy5oZWxwZXJzWydpZiddLmNhbGwodGhpcywgY29udGV4dCwgb3B0aW9ucyk7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignd2l0aCcsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICByZXR1cm4gb3B0aW9ucy5mbihjb250ZXh0KTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsb2cnLCBmdW5jdGlvbihjb250ZXh0KSB7CiAgSGFuZGxlYmFycy5sb2coY29udGV4dCk7Cn0pOwoKfSh0aGlzLkhhbmRsZWJhcnMpKTsKOwovLyBsaWIvaGFuZGxlYmFycy9jb21waWxlci9wYXJzZXIuanMKLyogSmlzb24gZ2VuZXJhdGVkIHBhcnNlciAqLwp2YXIgaGFuZGxlYmFycyA9IChmdW5jdGlvbigpewp2YXIgcGFyc2VyID0ge3RyYWNlOiBmdW5jdGlvbiB0cmFjZSgpIHsgfSwKeXk6IHt9LApzeW1ib2xzXzogeyJlcnJvciI6Miwicm9vdCI6MywicHJvZ3JhbSI6NCwiRU9GIjo1LCJzdGF0ZW1lbnRzIjo2LCJzaW1wbGVJbnZlcnNlIjo3LCJzdGF0ZW1lbnQiOjgsIm9wZW5JbnZlcnNlIjo5LCJjbG9zZUJsb2NrIjoxMCwib3BlbkJsb2NrIjoxMSwibXVzdGFjaGUiOjEyLCJwYXJ0aWFsIjoxMywiQ09OVEVOVCI6MTQsIkNPTU1FTlQiOjE1LCJPUEVOX0JMT0NLIjoxNiwiaW5NdXN0YWNoZSI6MTcsIkNMT1NFIjoxOCwiT1BFTl9JTlZFUlNFIjoxOSwiT1BFTl9FTkRCTE9DSyI6MjAsInBhdGgiOjIxLCJPUEVOIjoyMiwiT1BFTl9VTkVTQ0FQRUQiOjIzLCJPUEVOX1BBUlRJQUwiOjI0LCJwYXJhbXMiOjI1LCJoYXNoIjoyNiwiREFUQSI6MjcsInBhcmFtIjoyOCwiU1RSSU5HIjoyOSwiSU5URUdFUiI6MzAsIkJPT0xFQU4iOjMxLCJoYXNoU2VnbWVudHMiOjMyLCJoYXNoU2VnbWVudCI6MzMsIklEIjozNCwiRVFVQUxTIjozNSwicGF0aFNlZ21lbnRzIjozNiwiU0VQIjozNywiJGFjY2VwdCI6MCwiJGVuZCI6MX0sCnRlcm1pbmFsc186IHsyOiJlcnJvciIsNToiRU9GIiwxNDoiQ09OVEVOVCIsMTU6IkNPTU1FTlQiLDE2OiJPUEVOX0JMT0NLIiwxODoiQ0xPU0UiLDE5OiJPUEVOX0lOVkVSU0UiLDIwOiJPUEVOX0VOREJMT0NLIiwyMjoiT1BFTiIsMjM6Ik9QRU5fVU5FU0NBUEVEIiwyNDoiT1BFTl9QQVJUSUFMIiwyNzoiREFUQSIsMjk6IlNUUklORyIsMzA6IklOVEVHRVIiLDMxOiJCT09MRUFOIiwzNDoiSUQiLDM1OiJFUVVBTFMiLDM3OiJTRVAifSwKcHJvZHVjdGlvbnNfOiBbMCxbMywyXSxbNCwzXSxbNCwxXSxbNCwwXSxbNiwxXSxbNiwyXSxbOCwzXSxbOCwzXSxbOCwxXSxbOCwxXSxbOCwxXSxbOCwxXSxbMTEsM10sWzksM10sWzEwLDNdLFsxMiwzXSxbMTIsM10sWzEzLDNdLFsxMyw0XSxbNywyXSxbMTcsM10sWzE3LDJdLFsxNywyXSxbMTcsMV0sWzE3LDFdLFsyNSwyXSxbMjUsMV0sWzI4LDFdLFsyOCwxXSxbMjgsMV0sWzI4LDFdLFsyOCwxXSxbMjYsMV0sWzMyLDJdLFszMiwxXSxbMzMsM10sWzMzLDNdLFszMywzXSxbMzMsM10sWzMzLDNdLFsyMSwxXSxbMzYsM10sWzM2LDFdXSwKcGVyZm9ybUFjdGlvbjogZnVuY3Rpb24gYW5vbnltb3VzKHl5dGV4dCx5eWxlbmcseXlsaW5lbm8seXkseXlzdGF0ZSwkJCxfJCkgewoKdmFyICQwID0gJCQubGVuZ3RoIC0gMTsKc3dpdGNoICh5eXN0YXRlKSB7CmNhc2UgMTogcmV0dXJuICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgMjogdGhpcy4kID0gbmV3IHl5LlByb2dyYW1Ob2RlKCQkWyQwLTJdLCAkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzogdGhpcy4kID0gbmV3IHl5LlByb2dyYW1Ob2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSA0OiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoW10pOyAKYnJlYWs7CmNhc2UgNTogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKY2FzZSA2OiAkJFskMC0xXS5wdXNoKCQkWyQwXSk7IHRoaXMuJCA9ICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgNzogdGhpcy4kID0gbmV3IHl5LkJsb2NrTm9kZSgkJFskMC0yXSwgJCRbJDAtMV0uaW52ZXJzZSwgJCRbJDAtMV0sICQkWyQwXSk7IApicmVhazsKY2FzZSA4OiB0aGlzLiQgPSBuZXcgeXkuQmxvY2tOb2RlKCQkWyQwLTJdLCAkJFskMC0xXSwgJCRbJDAtMV0uaW52ZXJzZSwgJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDk6IHRoaXMuJCA9ICQkWyQwXTsgCmJyZWFrOwpjYXNlIDEwOiB0aGlzLiQgPSAkJFskMF07IApicmVhazsKY2FzZSAxMTogdGhpcy4kID0gbmV3IHl5LkNvbnRlbnROb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAxMjogdGhpcy4kID0gbmV3IHl5LkNvbW1lbnROb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAxMzogdGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0pOyAKYnJlYWs7CmNhc2UgMTQ6IHRoaXMuJCA9IG5ldyB5eS5NdXN0YWNoZU5vZGUoJCRbJDAtMV1bMF0sICQkWyQwLTFdWzFdKTsgCmJyZWFrOwpjYXNlIDE1OiB0aGlzLiQgPSAkJFskMC0xXTsgCmJyZWFrOwpjYXNlIDE2OiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSk7IApicmVhazsKY2FzZSAxNzogdGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0sIHRydWUpOyAKYnJlYWs7CmNhc2UgMTg6IHRoaXMuJCA9IG5ldyB5eS5QYXJ0aWFsTm9kZSgkJFskMC0xXSk7IApicmVhazsKY2FzZSAxOTogdGhpcy4kID0gbmV3IHl5LlBhcnRpYWxOb2RlKCQkWyQwLTJdLCAkJFskMC0xXSk7IApicmVhazsKY2FzZSAyMDogCmJyZWFrOwpjYXNlIDIxOiB0aGlzLiQgPSBbWyQkWyQwLTJdXS5jb25jYXQoJCRbJDAtMV0pLCAkJFskMF1dOyAKYnJlYWs7CmNhc2UgMjI6IHRoaXMuJCA9IFtbJCRbJDAtMV1dLmNvbmNhdCgkJFskMF0pLCBudWxsXTsgCmJyZWFrOwpjYXNlIDIzOiB0aGlzLiQgPSBbWyQkWyQwLTFdXSwgJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDI0OiB0aGlzLiQgPSBbWyQkWyQwXV0sIG51bGxdOyAKYnJlYWs7CmNhc2UgMjU6IHRoaXMuJCA9IFtbbmV3IHl5LkRhdGFOb2RlKCQkWyQwXSldLCBudWxsXTsgCmJyZWFrOwpjYXNlIDI2OiAkJFskMC0xXS5wdXNoKCQkWyQwXSk7IHRoaXMuJCA9ICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgMjc6IHRoaXMuJCA9IFskJFskMF1dOyAKYnJlYWs7CmNhc2UgMjg6IHRoaXMuJCA9ICQkWyQwXTsgCmJyZWFrOwpjYXNlIDI5OiB0aGlzLiQgPSBuZXcgeXkuU3RyaW5nTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzA6IHRoaXMuJCA9IG5ldyB5eS5JbnRlZ2VyTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzE6IHRoaXMuJCA9IG5ldyB5eS5Cb29sZWFuTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzI6IHRoaXMuJCA9IG5ldyB5eS5EYXRhTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzM6IHRoaXMuJCA9IG5ldyB5eS5IYXNoTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzQ6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSAzNTogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKY2FzZSAzNjogdGhpcy4kID0gWyQkWyQwLTJdLCAkJFskMF1dOyAKYnJlYWs7CmNhc2UgMzc6IHRoaXMuJCA9IFskJFskMC0yXSwgbmV3IHl5LlN0cmluZ05vZGUoJCRbJDBdKV07IApicmVhazsKY2FzZSAzODogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuSW50ZWdlck5vZGUoJCRbJDBdKV07IApicmVhazsKY2FzZSAzOTogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuQm9vbGVhbk5vZGUoJCRbJDBdKV07IApicmVhazsKY2FzZSA0MDogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuRGF0YU5vZGUoJCRbJDBdKV07IApicmVhazsKY2FzZSA0MTogdGhpcy4kID0gbmV3IHl5LklkTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgNDI6ICQkWyQwLTJdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMl07IApicmVhazsKY2FzZSA0MzogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKfQp9LAp0YWJsZTogW3szOjEsNDoyLDU6WzIsNF0sNjozLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHsxOlszXX0sezU6WzEsMTZdfSx7NTpbMiwzXSw3OjE3LDg6MTgsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTldLDIwOlsyLDNdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7NTpbMiw1XSwxNDpbMiw1XSwxNTpbMiw1XSwxNjpbMiw1XSwxOTpbMiw1XSwyMDpbMiw1XSwyMjpbMiw1XSwyMzpbMiw1XSwyNDpbMiw1XX0sezQ6MjAsNjozLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjA6WzIsNF0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs0OjIxLDY6Myw4OjQsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIwOlsyLDRdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7NTpbMiw5XSwxNDpbMiw5XSwxNTpbMiw5XSwxNjpbMiw5XSwxOTpbMiw5XSwyMDpbMiw5XSwyMjpbMiw5XSwyMzpbMiw5XSwyNDpbMiw5XX0sezU6WzIsMTBdLDE0OlsyLDEwXSwxNTpbMiwxMF0sMTY6WzIsMTBdLDE5OlsyLDEwXSwyMDpbMiwxMF0sMjI6WzIsMTBdLDIzOlsyLDEwXSwyNDpbMiwxMF19LHs1OlsyLDExXSwxNDpbMiwxMV0sMTU6WzIsMTFdLDE2OlsyLDExXSwxOTpbMiwxMV0sMjA6WzIsMTFdLDIyOlsyLDExXSwyMzpbMiwxMV0sMjQ6WzIsMTFdfSx7NTpbMiwxMl0sMTQ6WzIsMTJdLDE1OlsyLDEyXSwxNjpbMiwxMl0sMTk6WzIsMTJdLDIwOlsyLDEyXSwyMjpbMiwxMl0sMjM6WzIsMTJdLDI0OlsyLDEyXX0sezE3OjIyLDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxNzoyNywyMToyMywyNzpbMSwyNF0sMzQ6WzEsMjZdLDM2OjI1fSx7MTc6MjgsMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezE3OjI5LDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsyMTozMCwzNDpbMSwyNl0sMzY6MjV9LHsxOlsyLDFdfSx7NjozMSw4OjQsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7NTpbMiw2XSwxNDpbMiw2XSwxNTpbMiw2XSwxNjpbMiw2XSwxOTpbMiw2XSwyMDpbMiw2XSwyMjpbMiw2XSwyMzpbMiw2XSwyNDpbMiw2XX0sezE3OjIyLDE4OlsxLDMyXSwyMToyMywyNzpbMSwyNF0sMzQ6WzEsMjZdLDM2OjI1fSx7MTA6MzMsMjA6WzEsMzRdfSx7MTA6MzUsMjA6WzEsMzRdfSx7MTg6WzEsMzZdfSx7MTg6WzIsMjRdLDIxOjQxLDI1OjM3LDI2OjM4LDI3OlsxLDQ1XSwyODozOSwyOTpbMSw0Ml0sMzA6WzEsNDNdLDMxOlsxLDQ0XSwzMjo0MCwzMzo0NiwzNDpbMSw0N10sMzY6MjV9LHsxODpbMiwyNV19LHsxODpbMiw0MV0sMjc6WzIsNDFdLDI5OlsyLDQxXSwzMDpbMiw0MV0sMzE6WzIsNDFdLDM0OlsyLDQxXSwzNzpbMSw0OF19LHsxODpbMiw0M10sMjc6WzIsNDNdLDI5OlsyLDQzXSwzMDpbMiw0M10sMzE6WzIsNDNdLDM0OlsyLDQzXSwzNzpbMiw0M119LHsxODpbMSw0OV19LHsxODpbMSw1MF19LHsxODpbMSw1MV19LHsxODpbMSw1Ml0sMjE6NTMsMzQ6WzEsMjZdLDM2OjI1fSx7NTpbMiwyXSw4OjE4LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMDpbMiwyXSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezE0OlsyLDIwXSwxNTpbMiwyMF0sMTY6WzIsMjBdLDE5OlsyLDIwXSwyMjpbMiwyMF0sMjM6WzIsMjBdLDI0OlsyLDIwXX0sezU6WzIsN10sMTQ6WzIsN10sMTU6WzIsN10sMTY6WzIsN10sMTk6WzIsN10sMjA6WzIsN10sMjI6WzIsN10sMjM6WzIsN10sMjQ6WzIsN119LHsyMTo1NCwzNDpbMSwyNl0sMzY6MjV9LHs1OlsyLDhdLDE0OlsyLDhdLDE1OlsyLDhdLDE2OlsyLDhdLDE5OlsyLDhdLDIwOlsyLDhdLDIyOlsyLDhdLDIzOlsyLDhdLDI0OlsyLDhdfSx7MTQ6WzIsMTRdLDE1OlsyLDE0XSwxNjpbMiwxNF0sMTk6WzIsMTRdLDIwOlsyLDE0XSwyMjpbMiwxNF0sMjM6WzIsMTRdLDI0OlsyLDE0XX0sezE4OlsyLDIyXSwyMTo0MSwyNjo1NSwyNzpbMSw0NV0sMjg6NTYsMjk6WzEsNDJdLDMwOlsxLDQzXSwzMTpbMSw0NF0sMzI6NDAsMzM6NDYsMzQ6WzEsNDddLDM2OjI1fSx7MTg6WzIsMjNdfSx7MTg6WzIsMjddLDI3OlsyLDI3XSwyOTpbMiwyN10sMzA6WzIsMjddLDMxOlsyLDI3XSwzNDpbMiwyN119LHsxODpbMiwzM10sMzM6NTcsMzQ6WzEsNThdfSx7MTg6WzIsMjhdLDI3OlsyLDI4XSwyOTpbMiwyOF0sMzA6WzIsMjhdLDMxOlsyLDI4XSwzNDpbMiwyOF19LHsxODpbMiwyOV0sMjc6WzIsMjldLDI5OlsyLDI5XSwzMDpbMiwyOV0sMzE6WzIsMjldLDM0OlsyLDI5XX0sezE4OlsyLDMwXSwyNzpbMiwzMF0sMjk6WzIsMzBdLDMwOlsyLDMwXSwzMTpbMiwzMF0sMzQ6WzIsMzBdfSx7MTg6WzIsMzFdLDI3OlsyLDMxXSwyOTpbMiwzMV0sMzA6WzIsMzFdLDMxOlsyLDMxXSwzNDpbMiwzMV19LHsxODpbMiwzMl0sMjc6WzIsMzJdLDI5OlsyLDMyXSwzMDpbMiwzMl0sMzE6WzIsMzJdLDM0OlsyLDMyXX0sezE4OlsyLDM1XSwzNDpbMiwzNV19LHsxODpbMiw0M10sMjc6WzIsNDNdLDI5OlsyLDQzXSwzMDpbMiw0M10sMzE6WzIsNDNdLDM0OlsyLDQzXSwzNTpbMSw1OV0sMzc6WzIsNDNdfSx7MzQ6WzEsNjBdfSx7MTQ6WzIsMTNdLDE1OlsyLDEzXSwxNjpbMiwxM10sMTk6WzIsMTNdLDIwOlsyLDEzXSwyMjpbMiwxM10sMjM6WzIsMTNdLDI0OlsyLDEzXX0sezU6WzIsMTZdLDE0OlsyLDE2XSwxNTpbMiwxNl0sMTY6WzIsMTZdLDE5OlsyLDE2XSwyMDpbMiwxNl0sMjI6WzIsMTZdLDIzOlsyLDE2XSwyNDpbMiwxNl19LHs1OlsyLDE3XSwxNDpbMiwxN10sMTU6WzIsMTddLDE2OlsyLDE3XSwxOTpbMiwxN10sMjA6WzIsMTddLDIyOlsyLDE3XSwyMzpbMiwxN10sMjQ6WzIsMTddfSx7NTpbMiwxOF0sMTQ6WzIsMThdLDE1OlsyLDE4XSwxNjpbMiwxOF0sMTk6WzIsMThdLDIwOlsyLDE4XSwyMjpbMiwxOF0sMjM6WzIsMThdLDI0OlsyLDE4XX0sezE4OlsxLDYxXX0sezE4OlsxLDYyXX0sezE4OlsyLDIxXX0sezE4OlsyLDI2XSwyNzpbMiwyNl0sMjk6WzIsMjZdLDMwOlsyLDI2XSwzMTpbMiwyNl0sMzQ6WzIsMjZdfSx7MTg6WzIsMzRdLDM0OlsyLDM0XX0sezM1OlsxLDU5XX0sezIxOjYzLDI3OlsxLDY3XSwyOTpbMSw2NF0sMzA6WzEsNjVdLDMxOlsxLDY2XSwzNDpbMSwyNl0sMzY6MjV9LHsxODpbMiw0Ml0sMjc6WzIsNDJdLDI5OlsyLDQyXSwzMDpbMiw0Ml0sMzE6WzIsNDJdLDM0OlsyLDQyXSwzNzpbMiw0Ml19LHs1OlsyLDE5XSwxNDpbMiwxOV0sMTU6WzIsMTldLDE2OlsyLDE5XSwxOTpbMiwxOV0sMjA6WzIsMTldLDIyOlsyLDE5XSwyMzpbMiwxOV0sMjQ6WzIsMTldfSx7NTpbMiwxNV0sMTQ6WzIsMTVdLDE1OlsyLDE1XSwxNjpbMiwxNV0sMTk6WzIsMTVdLDIwOlsyLDE1XSwyMjpbMiwxNV0sMjM6WzIsMTVdLDI0OlsyLDE1XX0sezE4OlsyLDM2XSwzNDpbMiwzNl19LHsxODpbMiwzN10sMzQ6WzIsMzddfSx7MTg6WzIsMzhdLDM0OlsyLDM4XX0sezE4OlsyLDM5XSwzNDpbMiwzOV19LHsxODpbMiw0MF0sMzQ6WzIsNDBdfV0sCmRlZmF1bHRBY3Rpb25zOiB7MTY6WzIsMV0sMjQ6WzIsMjVdLDM4OlsyLDIzXSw1NTpbMiwyMV19LApwYXJzZUVycm9yOiBmdW5jdGlvbiBwYXJzZUVycm9yKHN0ciwgaGFzaCkgewogICAgdGhyb3cgbmV3IEVycm9yKHN0cik7Cn0sCnBhcnNlOiBmdW5jdGlvbiBwYXJzZShpbnB1dCkgewogICAgdmFyIHNlbGYgPSB0aGlzLCBzdGFjayA9IFswXSwgdnN0YWNrID0gW251bGxdLCBsc3RhY2sgPSBbXSwgdGFibGUgPSB0aGlzLnRhYmxlLCB5eXRleHQgPSAiIiwgeXlsaW5lbm8gPSAwLCB5eWxlbmcgPSAwLCByZWNvdmVyaW5nID0gMCwgVEVSUk9SID0gMiwgRU9GID0gMTsKICAgIHRoaXMubGV4ZXIuc2V0SW5wdXQoaW5wdXQpOwogICAgdGhpcy5sZXhlci55eSA9IHRoaXMueXk7CiAgICB0aGlzLnl5LmxleGVyID0gdGhpcy5sZXhlcjsKICAgIHRoaXMueXkucGFyc2VyID0gdGhpczsKICAgIGlmICh0eXBlb2YgdGhpcy5sZXhlci55eWxsb2MgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgdGhpcy5sZXhlci55eWxsb2MgPSB7fTsKICAgIHZhciB5eWxvYyA9IHRoaXMubGV4ZXIueXlsbG9jOwogICAgbHN0YWNrLnB1c2goeXlsb2MpOwogICAgdmFyIHJhbmdlcyA9IHRoaXMubGV4ZXIub3B0aW9ucyAmJiB0aGlzLmxleGVyLm9wdGlvbnMucmFuZ2VzOwogICAgaWYgKHR5cGVvZiB0aGlzLnl5LnBhcnNlRXJyb3IgPT09ICJmdW5jdGlvbiIpCiAgICAgICAgdGhpcy5wYXJzZUVycm9yID0gdGhpcy55eS5wYXJzZUVycm9yOwogICAgZnVuY3Rpb24gcG9wU3RhY2sobikgewogICAgICAgIHN0YWNrLmxlbmd0aCA9IHN0YWNrLmxlbmd0aCAtIDIgKiBuOwogICAgICAgIHZzdGFjay5sZW5ndGggPSB2c3RhY2subGVuZ3RoIC0gbjsKICAgICAgICBsc3RhY2subGVuZ3RoID0gbHN0YWNrLmxlbmd0aCAtIG47CiAgICB9CiAgICBmdW5jdGlvbiBsZXgoKSB7CiAgICAgICAgdmFyIHRva2VuOwogICAgICAgIHRva2VuID0gc2VsZi5sZXhlci5sZXgoKSB8fCAxOwogICAgICAgIGlmICh0eXBlb2YgdG9rZW4gIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHRva2VuID0gc2VsZi5zeW1ib2xzX1t0b2tlbl0gfHwgdG9rZW47CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbjsKICAgIH0KICAgIHZhciBzeW1ib2wsIHByZUVycm9yU3ltYm9sLCBzdGF0ZSwgYWN0aW9uLCBhLCByLCB5eXZhbCA9IHt9LCBwLCBsZW4sIG5ld1N0YXRlLCBleHBlY3RlZDsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgc3RhdGUgPSBzdGFja1tzdGFjay5sZW5ndGggLSAxXTsKICAgICAgICBpZiAodGhpcy5kZWZhdWx0QWN0aW9uc1tzdGF0ZV0pIHsKICAgICAgICAgICAgYWN0aW9uID0gdGhpcy5kZWZhdWx0QWN0aW9uc1tzdGF0ZV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHN5bWJvbCA9PT0gbnVsbCB8fCB0eXBlb2Ygc3ltYm9sID09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBzeW1ib2wgPSBsZXgoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhY3Rpb24gPSB0YWJsZVtzdGF0ZV0gJiYgdGFibGVbc3RhdGVdW3N5bWJvbF07CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYWN0aW9uID09PSAidW5kZWZpbmVkIiB8fCAhYWN0aW9uLmxlbmd0aCB8fCAhYWN0aW9uWzBdKSB7CiAgICAgICAgICAgIHZhciBlcnJTdHIgPSAiIjsKICAgICAgICAgICAgaWYgKCFyZWNvdmVyaW5nKSB7CiAgICAgICAgICAgICAgICBleHBlY3RlZCA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChwIGluIHRhYmxlW3N0YXRlXSkKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50ZXJtaW5hbHNfW3BdICYmIHAgPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkLnB1c2goIiciICsgdGhpcy50ZXJtaW5hbHNfW3BdICsgIiciKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5sZXhlci5zaG93UG9zaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBlcnJTdHIgPSAiUGFyc2UgZXJyb3Igb24gbGluZSAiICsgKHl5bGluZW5vICsgMSkgKyAiOlxuIiArIHRoaXMubGV4ZXIuc2hvd1Bvc2l0aW9uKCkgKyAiXG5FeHBlY3RpbmcgIiArIGV4cGVjdGVkLmpvaW4oIiwgIikgKyAiLCBnb3QgJyIgKyAodGhpcy50ZXJtaW5hbHNfW3N5bWJvbF0gfHwgc3ltYm9sKSArICInIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyU3RyID0gIlBhcnNlIGVycm9yIG9uIGxpbmUgIiArICh5eWxpbmVubyArIDEpICsgIjogVW5leHBlY3RlZCAiICsgKHN5bWJvbCA9PSAxPyJlbmQgb2YgaW5wdXQiOiInIiArICh0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wpICsgIiciKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGFyc2VFcnJvcihlcnJTdHIsIHt0ZXh0OiB0aGlzLmxleGVyLm1hdGNoLCB0b2tlbjogdGhpcy50ZXJtaW5hbHNfW3N5bWJvbF0gfHwgc3ltYm9sLCBsaW5lOiB0aGlzLmxleGVyLnl5bGluZW5vLCBsb2M6IHl5bG9jLCBleHBlY3RlZDogZXhwZWN0ZWR9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoYWN0aW9uWzBdIGluc3RhbmNlb2YgQXJyYXkgJiYgYWN0aW9uLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQYXJzZSBFcnJvcjogbXVsdGlwbGUgYWN0aW9ucyBwb3NzaWJsZSBhdCBzdGF0ZTogIiArIHN0YXRlICsgIiwgdG9rZW46ICIgKyBzeW1ib2wpOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKGFjdGlvblswXSkgewogICAgICAgIGNhc2UgMToKICAgICAgICAgICAgc3RhY2sucHVzaChzeW1ib2wpOwogICAgICAgICAgICB2c3RhY2sucHVzaCh0aGlzLmxleGVyLnl5dGV4dCk7CiAgICAgICAgICAgIGxzdGFjay5wdXNoKHRoaXMubGV4ZXIueXlsbG9jKTsKICAgICAgICAgICAgc3RhY2sucHVzaChhY3Rpb25bMV0pOwogICAgICAgICAgICBzeW1ib2wgPSBudWxsOwogICAgICAgICAgICBpZiAoIXByZUVycm9yU3ltYm9sKSB7CiAgICAgICAgICAgICAgICB5eWxlbmcgPSB0aGlzLmxleGVyLnl5bGVuZzsKICAgICAgICAgICAgICAgIHl5dGV4dCA9IHRoaXMubGV4ZXIueXl0ZXh0OwogICAgICAgICAgICAgICAgeXlsaW5lbm8gPSB0aGlzLmxleGVyLnl5bGluZW5vOwogICAgICAgICAgICAgICAgeXlsb2MgPSB0aGlzLmxleGVyLnl5bGxvYzsKICAgICAgICAgICAgICAgIGlmIChyZWNvdmVyaW5nID4gMCkKICAgICAgICAgICAgICAgICAgICByZWNvdmVyaW5nLS07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzeW1ib2wgPSBwcmVFcnJvclN5bWJvbDsKICAgICAgICAgICAgICAgIHByZUVycm9yU3ltYm9sID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGxlbiA9IHRoaXMucHJvZHVjdGlvbnNfW2FjdGlvblsxXV1bMV07CiAgICAgICAgICAgIHl5dmFsLiQgPSB2c3RhY2tbdnN0YWNrLmxlbmd0aCAtIGxlbl07CiAgICAgICAgICAgIHl5dmFsLl8kID0ge2ZpcnN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0uZmlyc3RfbGluZSwgbGFzdF9saW5lOiBsc3RhY2tbbHN0YWNrLmxlbmd0aCAtIDFdLmxhc3RfbGluZSwgZmlyc3RfY29sdW1uOiBsc3RhY2tbbHN0YWNrLmxlbmd0aCAtIChsZW4gfHwgMSldLmZpcnN0X2NvbHVtbiwgbGFzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ubGFzdF9jb2x1bW59OwogICAgICAgICAgICBpZiAocmFuZ2VzKSB7CiAgICAgICAgICAgICAgICB5eXZhbC5fJC5yYW5nZSA9IFtsc3RhY2tbbHN0YWNrLmxlbmd0aCAtIChsZW4gfHwgMSldLnJhbmdlWzBdLCBsc3RhY2tbbHN0YWNrLmxlbmd0aCAtIDFdLnJhbmdlWzFdXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByID0gdGhpcy5wZXJmb3JtQWN0aW9uLmNhbGwoeXl2YWwsIHl5dGV4dCwgeXlsZW5nLCB5eWxpbmVubywgdGhpcy55eSwgYWN0aW9uWzFdLCB2c3RhY2ssIGxzdGFjayk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsZW4pIHsKICAgICAgICAgICAgICAgIHN0YWNrID0gc3RhY2suc2xpY2UoMCwgLTEgKiBsZW4gKiAyKTsKICAgICAgICAgICAgICAgIHZzdGFjayA9IHZzdGFjay5zbGljZSgwLCAtMSAqIGxlbik7CiAgICAgICAgICAgICAgICBsc3RhY2sgPSBsc3RhY2suc2xpY2UoMCwgLTEgKiBsZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0YWNrLnB1c2godGhpcy5wcm9kdWN0aW9uc19bYWN0aW9uWzFdXVswXSk7CiAgICAgICAgICAgIHZzdGFjay5wdXNoKHl5dmFsLiQpOwogICAgICAgICAgICBsc3RhY2sucHVzaCh5eXZhbC5fJCk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gdGFibGVbc3RhY2tbc3RhY2subGVuZ3RoIC0gMl1dW3N0YWNrW3N0YWNrLmxlbmd0aCAtIDFdXTsKICAgICAgICAgICAgc3RhY2sucHVzaChuZXdTdGF0ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KfTsKLyogSmlzb24gZ2VuZXJhdGVkIGxleGVyICovCnZhciBsZXhlciA9IChmdW5jdGlvbigpewp2YXIgbGV4ZXIgPSAoe0VPRjoxLApwYXJzZUVycm9yOmZ1bmN0aW9uIHBhcnNlRXJyb3Ioc3RyLCBoYXNoKSB7CiAgICAgICAgaWYgKHRoaXMueXkucGFyc2VyKSB7CiAgICAgICAgICAgIHRoaXMueXkucGFyc2VyLnBhcnNlRXJyb3Ioc3RyLCBoYXNoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3Ioc3RyKTsKICAgICAgICB9CiAgICB9LApzZXRJbnB1dDpmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICB0aGlzLl9pbnB1dCA9IGlucHV0OwogICAgICAgIHRoaXMuX21vcmUgPSB0aGlzLl9sZXNzID0gdGhpcy5kb25lID0gZmFsc2U7CiAgICAgICAgdGhpcy55eWxpbmVubyA9IHRoaXMueXlsZW5nID0gMDsKICAgICAgICB0aGlzLnl5dGV4dCA9IHRoaXMubWF0Y2hlZCA9IHRoaXMubWF0Y2ggPSAnJzsKICAgICAgICB0aGlzLmNvbmRpdGlvblN0YWNrID0gWydJTklUSUFMJ107CiAgICAgICAgdGhpcy55eWxsb2MgPSB7Zmlyc3RfbGluZToxLGZpcnN0X2NvbHVtbjowLGxhc3RfbGluZToxLGxhc3RfY29sdW1uOjB9OwogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB0aGlzLnl5bGxvYy5yYW5nZSA9IFswLDBdOwogICAgICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCmlucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgY2ggPSB0aGlzLl9pbnB1dFswXTsKICAgICAgICB0aGlzLnl5dGV4dCArPSBjaDsKICAgICAgICB0aGlzLnl5bGVuZysrOwogICAgICAgIHRoaXMub2Zmc2V0Kys7CiAgICAgICAgdGhpcy5tYXRjaCArPSBjaDsKICAgICAgICB0aGlzLm1hdGNoZWQgKz0gY2g7CiAgICAgICAgdmFyIGxpbmVzID0gY2gubWF0Y2goLyg/OlxyXG4/fFxuKS4qL2cpOwogICAgICAgIGlmIChsaW5lcykgewogICAgICAgICAgICB0aGlzLnl5bGluZW5vKys7CiAgICAgICAgICAgIHRoaXMueXlsbG9jLmxhc3RfbGluZSsrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMueXlsbG9jLmxhc3RfY29sdW1uKys7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB0aGlzLnl5bGxvYy5yYW5nZVsxXSsrOwoKICAgICAgICB0aGlzLl9pbnB1dCA9IHRoaXMuX2lucHV0LnNsaWNlKDEpOwogICAgICAgIHJldHVybiBjaDsKICAgIH0sCnVucHV0OmZ1bmN0aW9uIChjaCkgewogICAgICAgIHZhciBsZW4gPSBjaC5sZW5ndGg7CiAgICAgICAgdmFyIGxpbmVzID0gY2guc3BsaXQoLyg/OlxyXG4/fFxuKS9nKTsKCiAgICAgICAgdGhpcy5faW5wdXQgPSBjaCArIHRoaXMuX2lucHV0OwogICAgICAgIHRoaXMueXl0ZXh0ID0gdGhpcy55eXRleHQuc3Vic3RyKDAsIHRoaXMueXl0ZXh0Lmxlbmd0aC1sZW4tMSk7CiAgICAgICAgLy90aGlzLnl5bGVuZyAtPSBsZW47CiAgICAgICAgdGhpcy5vZmZzZXQgLT0gbGVuOwogICAgICAgIHZhciBvbGRMaW5lcyA9IHRoaXMubWF0Y2guc3BsaXQoLyg/OlxyXG4/fFxuKS9nKTsKICAgICAgICB0aGlzLm1hdGNoID0gdGhpcy5tYXRjaC5zdWJzdHIoMCwgdGhpcy5tYXRjaC5sZW5ndGgtMSk7CiAgICAgICAgdGhpcy5tYXRjaGVkID0gdGhpcy5tYXRjaGVkLnN1YnN0cigwLCB0aGlzLm1hdGNoZWQubGVuZ3RoLTEpOwoKICAgICAgICBpZiAobGluZXMubGVuZ3RoLTEpIHRoaXMueXlsaW5lbm8gLT0gbGluZXMubGVuZ3RoLTE7CiAgICAgICAgdmFyIHIgPSB0aGlzLnl5bGxvYy5yYW5nZTsKCiAgICAgICAgdGhpcy55eWxsb2MgPSB7Zmlyc3RfbGluZTogdGhpcy55eWxsb2MuZmlyc3RfbGluZSwKICAgICAgICAgIGxhc3RfbGluZTogdGhpcy55eWxpbmVubysxLAogICAgICAgICAgZmlyc3RfY29sdW1uOiB0aGlzLnl5bGxvYy5maXJzdF9jb2x1bW4sCiAgICAgICAgICBsYXN0X2NvbHVtbjogbGluZXMgPwogICAgICAgICAgICAgIChsaW5lcy5sZW5ndGggPT09IG9sZExpbmVzLmxlbmd0aCA/IHRoaXMueXlsbG9jLmZpcnN0X2NvbHVtbiA6IDApICsgb2xkTGluZXNbb2xkTGluZXMubGVuZ3RoIC0gbGluZXMubGVuZ3RoXS5sZW5ndGggLSBsaW5lc1swXS5sZW5ndGg6CiAgICAgICAgICAgICAgdGhpcy55eWxsb2MuZmlyc3RfY29sdW1uIC0gbGVuCiAgICAgICAgICB9OwoKICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJhbmdlcykgewogICAgICAgICAgICB0aGlzLnl5bGxvYy5yYW5nZSA9IFtyWzBdLCByWzBdICsgdGhpcy55eWxlbmcgLSBsZW5dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCm1vcmU6ZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuX21vcmUgPSB0cnVlOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKbGVzczpmdW5jdGlvbiAobikgewogICAgICAgIHRoaXMudW5wdXQodGhpcy5tYXRjaC5zbGljZShuKSk7CiAgICB9LApwYXN0SW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwYXN0ID0gdGhpcy5tYXRjaGVkLnN1YnN0cigwLCB0aGlzLm1hdGNoZWQubGVuZ3RoIC0gdGhpcy5tYXRjaC5sZW5ndGgpOwogICAgICAgIHJldHVybiAocGFzdC5sZW5ndGggPiAyMCA/ICcuLi4nOicnKSArIHBhc3Quc3Vic3RyKC0yMCkucmVwbGFjZSgvXG4vZywgIiIpOwogICAgfSwKdXBjb21pbmdJbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG5leHQgPSB0aGlzLm1hdGNoOwogICAgICAgIGlmIChuZXh0Lmxlbmd0aCA8IDIwKSB7CiAgICAgICAgICAgIG5leHQgKz0gdGhpcy5faW5wdXQuc3Vic3RyKDAsIDIwLW5leHQubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChuZXh0LnN1YnN0cigwLDIwKSsobmV4dC5sZW5ndGggPiAyMCA/ICcuLi4nOicnKSkucmVwbGFjZSgvXG4vZywgIiIpOwogICAgfSwKc2hvd1Bvc2l0aW9uOmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcHJlID0gdGhpcy5wYXN0SW5wdXQoKTsKICAgICAgICB2YXIgYyA9IG5ldyBBcnJheShwcmUubGVuZ3RoICsgMSkuam9pbigiLSIpOwogICAgICAgIHJldHVybiBwcmUgKyB0aGlzLnVwY29taW5nSW5wdXQoKSArICJcbiIgKyBjKyJeIjsKICAgIH0sCm5leHQ6ZnVuY3Rpb24gKCkgewogICAgICAgIGlmICh0aGlzLmRvbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuRU9GOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuX2lucHV0KSB0aGlzLmRvbmUgPSB0cnVlOwoKICAgICAgICB2YXIgdG9rZW4sCiAgICAgICAgICAgIG1hdGNoLAogICAgICAgICAgICB0ZW1wTWF0Y2gsCiAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICBjb2wsCiAgICAgICAgICAgIGxpbmVzOwogICAgICAgIGlmICghdGhpcy5fbW9yZSkgewogICAgICAgICAgICB0aGlzLnl5dGV4dCA9ICcnOwogICAgICAgICAgICB0aGlzLm1hdGNoID0gJyc7CiAgICAgICAgfQogICAgICAgIHZhciBydWxlcyA9IHRoaXMuX2N1cnJlbnRSdWxlcygpOwogICAgICAgIGZvciAodmFyIGk9MDtpIDwgcnVsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdGVtcE1hdGNoID0gdGhpcy5faW5wdXQubWF0Y2godGhpcy5ydWxlc1tydWxlc1tpXV0pOwogICAgICAgICAgICBpZiAodGVtcE1hdGNoICYmICghbWF0Y2ggfHwgdGVtcE1hdGNoWzBdLmxlbmd0aCA+IG1hdGNoWzBdLmxlbmd0aCkpIHsKICAgICAgICAgICAgICAgIG1hdGNoID0gdGVtcE1hdGNoOwogICAgICAgICAgICAgICAgaW5kZXggPSBpOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuZmxleCkgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGxpbmVzID0gbWF0Y2hbMF0ubWF0Y2goLyg/OlxyXG4/fFxuKS4qL2cpOwogICAgICAgICAgICBpZiAobGluZXMpIHRoaXMueXlsaW5lbm8gKz0gbGluZXMubGVuZ3RoOwogICAgICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOiB0aGlzLnl5bGxvYy5sYXN0X2xpbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfbGluZTogdGhpcy55eWxpbmVubysxLAogICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdF9jb2x1bW46IHRoaXMueXlsbG9jLmxhc3RfY29sdW1uLAogICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0X2NvbHVtbjogbGluZXMgPyBsaW5lc1tsaW5lcy5sZW5ndGgtMV0ubGVuZ3RoLWxpbmVzW2xpbmVzLmxlbmd0aC0xXS5tYXRjaCgvXHI/XG4/LylbMF0ubGVuZ3RoIDogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4gKyBtYXRjaFswXS5sZW5ndGh9OwogICAgICAgICAgICB0aGlzLnl5dGV4dCArPSBtYXRjaFswXTsKICAgICAgICAgICAgdGhpcy5tYXRjaCArPSBtYXRjaFswXTsKICAgICAgICAgICAgdGhpcy5tYXRjaGVzID0gbWF0Y2g7CiAgICAgICAgICAgIHRoaXMueXlsZW5nID0gdGhpcy55eXRleHQubGVuZ3RoOwogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJhbmdlcykgewogICAgICAgICAgICAgICAgdGhpcy55eWxsb2MucmFuZ2UgPSBbdGhpcy5vZmZzZXQsIHRoaXMub2Zmc2V0ICs9IHRoaXMueXlsZW5nXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tb3JlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2lucHV0ID0gdGhpcy5faW5wdXQuc2xpY2UobWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgICAgICAgdGhpcy5tYXRjaGVkICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0b2tlbiA9IHRoaXMucGVyZm9ybUFjdGlvbi5jYWxsKHRoaXMsIHRoaXMueXksIHRoaXMsIHJ1bGVzW2luZGV4XSx0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTFdKTsKICAgICAgICAgICAgaWYgKHRoaXMuZG9uZSAmJiB0aGlzLl9pbnB1dCkgdGhpcy5kb25lID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0b2tlbikgcmV0dXJuIHRva2VuOwogICAgICAgICAgICBlbHNlIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX2lucHV0ID09PSAiIikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5FT0Y7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VFcnJvcignTGV4aWNhbCBlcnJvciBvbiBsaW5lICcrKHRoaXMueXlsaW5lbm8rMSkrJy4gVW5yZWNvZ25pemVkIHRleHQuXG4nK3RoaXMuc2hvd1Bvc2l0aW9uKCksCiAgICAgICAgICAgICAgICAgICAge3RleHQ6ICIiLCB0b2tlbjogbnVsbCwgbGluZTogdGhpcy55eWxpbmVub30pOwogICAgICAgIH0KICAgIH0sCmxleDpmdW5jdGlvbiBsZXgoKSB7CiAgICAgICAgdmFyIHIgPSB0aGlzLm5leHQoKTsKICAgICAgICBpZiAodHlwZW9mIHIgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHJldHVybiByOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxleCgpOwogICAgICAgIH0KICAgIH0sCmJlZ2luOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgIHRoaXMuY29uZGl0aW9uU3RhY2sucHVzaChjb25kaXRpb24pOwogICAgfSwKcG9wU3RhdGU6ZnVuY3Rpb24gcG9wU3RhdGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uZGl0aW9uU3RhY2sucG9wKCk7CiAgICB9LApfY3VycmVudFJ1bGVzOmZ1bmN0aW9uIF9jdXJyZW50UnVsZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uZGl0aW9uc1t0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTFdXS5ydWxlczsKICAgIH0sCnRvcFN0YXRlOmZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFja1t0aGlzLmNvbmRpdGlvblN0YWNrLmxlbmd0aC0yXTsKICAgIH0sCnB1c2hTdGF0ZTpmdW5jdGlvbiBiZWdpbihjb25kaXRpb24pIHsKICAgICAgICB0aGlzLmJlZ2luKGNvbmRpdGlvbik7CiAgICB9fSk7CmxleGVyLm9wdGlvbnMgPSB7fTsKbGV4ZXIucGVyZm9ybUFjdGlvbiA9IGZ1bmN0aW9uIGFub255bW91cyh5eSx5eV8sJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucyxZWV9TVEFSVCkgewoKdmFyIFlZU1RBVEU9WVlfU1RBUlQKc3dpdGNoKCRhdm9pZGluZ19uYW1lX2NvbGxpc2lvbnMpIHsKY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQuc2xpY2UoLTEpICE9PSAiXFwiKSB0aGlzLmJlZ2luKCJtdSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQuc2xpY2UoLTEpID09PSAiXFwiKSB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMCx5eV8ueXlsZW5nLTEpLCB0aGlzLmJlZ2luKCJlbXUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5eV8ueXl0ZXh0KSByZXR1cm4gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIApicmVhazsKY2FzZSAxOiByZXR1cm4gMTQ7IApicmVhazsKY2FzZSAyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQuc2xpY2UoLTEpICE9PSAiXFwiKSB0aGlzLnBvcFN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgPT09ICJcXCIpIHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigwLHl5Xy55eWxlbmctMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKYnJlYWs7CmNhc2UgMzogcmV0dXJuIDI0OyAKYnJlYWs7CmNhc2UgNDogcmV0dXJuIDE2OyAKYnJlYWs7CmNhc2UgNTogcmV0dXJuIDIwOyAKYnJlYWs7CmNhc2UgNjogcmV0dXJuIDE5OyAKYnJlYWs7CmNhc2UgNzogcmV0dXJuIDE5OyAKYnJlYWs7CmNhc2UgODogcmV0dXJuIDIzOyAKYnJlYWs7CmNhc2UgOTogcmV0dXJuIDIzOyAKYnJlYWs7CmNhc2UgMTA6IHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigzLHl5Xy55eWxlbmctNSk7IHRoaXMucG9wU3RhdGUoKTsgcmV0dXJuIDE1OyAKYnJlYWs7CmNhc2UgMTE6IHJldHVybiAyMjsgCmJyZWFrOwpjYXNlIDEyOiByZXR1cm4gMzU7IApicmVhazsKY2FzZSAxMzogcmV0dXJuIDM0OyAKYnJlYWs7CmNhc2UgMTQ6IHJldHVybiAzNDsgCmJyZWFrOwpjYXNlIDE1OiByZXR1cm4gMzc7IApicmVhazsKY2FzZSAxNjogLyppZ25vcmUgd2hpdGVzcGFjZSovIApicmVhazsKY2FzZSAxNzogdGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTg7IApicmVhazsKY2FzZSAxODogdGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTg7IApicmVhazsKY2FzZSAxOTogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEseXlfLnl5bGVuZy0yKS5yZXBsYWNlKC9cXCIvZywnIicpOyByZXR1cm4gMjk7IApicmVhazsKY2FzZSAyMDogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEseXlfLnl5bGVuZy0yKS5yZXBsYWNlKC9cXCIvZywnIicpOyByZXR1cm4gMjk7IApicmVhazsKY2FzZSAyMTogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEpOyByZXR1cm4gMjc7IApicmVhazsKY2FzZSAyMjogcmV0dXJuIDMxOyAKYnJlYWs7CmNhc2UgMjM6IHJldHVybiAzMTsgCmJyZWFrOwpjYXNlIDI0OiByZXR1cm4gMzA7IApicmVhazsKY2FzZSAyNTogcmV0dXJuIDM0OyAKYnJlYWs7CmNhc2UgMjY6IHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigxLCB5eV8ueXlsZW5nLTIpOyByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAyNzogcmV0dXJuICdJTlZBTElEJzsgCmJyZWFrOwpjYXNlIDI4OiByZXR1cm4gNTsgCmJyZWFrOwp9Cn07CmxleGVyLnJ1bGVzID0gWy9eKD86W15ceDAwXSo/KD89KFx7XHspKSkvLC9eKD86W15ceDAwXSspLywvXig/OlteXHgwMF17Mix9Pyg/PShce1x7fCQpKSkvLC9eKD86XHtcez4pLywvXig/Olx7XHsjKS8sL14oPzpce1x7XC8pLywvXig/Olx7XHtcXikvLC9eKD86XHtce1xzKmVsc2VcYikvLC9eKD86XHtce1x7KS8sL14oPzpce1x7JikvLC9eKD86XHtceyFbXHNcU10qP1x9XH0pLywvXig/Olx7XHspLywvXig/Oj0pLywvXig/OlwuKD89W30gXSkpLywvXig/OlwuXC4pLywvXig/OltcLy5dKS8sL14oPzpccyspLywvXig/Olx9XH1cfSkvLC9eKD86XH1cfSkvLC9eKD86IihcXFsiXXxbXiJdKSoiKS8sL14oPzonKFxcWyddfFteJ10pKicpLywvXig/OkBbYS16QS1aXSspLywvXig/OnRydWUoPz1bfVxzXSkpLywvXig/OmZhbHNlKD89W31cc10pKS8sL14oPzpbMC05XSsoPz1bfVxzXSkpLywvXig/OlthLXpBLVowLTlfJC1dKyg/PVs9fVxzXC8uXSkpLywvXig/OlxbW15cXV0qXF0pLywvXig/Oi4pLywvXig/OiQpL107CmxleGVyLmNvbmRpdGlvbnMgPSB7Im11Ijp7InJ1bGVzIjpbMyw0LDUsNiw3LDgsOSwxMCwxMSwxMiwxMywxNCwxNSwxNiwxNywxOCwxOSwyMCwyMSwyMiwyMywyNCwyNSwyNiwyNywyOF0sImluY2x1c2l2ZSI6ZmFsc2V9LCJlbXUiOnsicnVsZXMiOlsyXSwiaW5jbHVzaXZlIjpmYWxzZX0sIklOSVRJQUwiOnsicnVsZXMiOlswLDEsMjhdLCJpbmNsdXNpdmUiOnRydWV9fTsKcmV0dXJuIGxleGVyO30pKCkKcGFyc2VyLmxleGVyID0gbGV4ZXI7CmZ1bmN0aW9uIFBhcnNlciAoKSB7IHRoaXMueXkgPSB7fTsgfVBhcnNlci5wcm90b3R5cGUgPSBwYXJzZXI7cGFyc2VyLlBhcnNlciA9IFBhcnNlcjsKcmV0dXJuIG5ldyBQYXJzZXI7Cn0pKCk7CmlmICh0eXBlb2YgcmVxdWlyZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CmV4cG9ydHMucGFyc2VyID0gaGFuZGxlYmFyczsKZXhwb3J0cy5QYXJzZXIgPSBoYW5kbGViYXJzLlBhcnNlcjsKZXhwb3J0cy5wYXJzZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGhhbmRsZWJhcnMucGFyc2UuYXBwbHkoaGFuZGxlYmFycywgYXJndW1lbnRzKTsgfQpleHBvcnRzLm1haW4gPSBmdW5jdGlvbiBjb21tb25qc01haW4oYXJncykgewogICAgaWYgKCFhcmdzWzFdKQogICAgICAgIHRocm93IG5ldyBFcnJvcignVXNhZ2U6ICcrYXJnc1swXSsnIEZJTEUnKTsKICAgIHZhciBzb3VyY2UsIGN3ZDsKICAgIGlmICh0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICBzb3VyY2UgPSByZXF1aXJlKCdmcycpLnJlYWRGaWxlU3luYyhyZXF1aXJlKCdwYXRoJykucmVzb2x2ZShhcmdzWzFdKSwgInV0ZjgiKTsKICAgIH0gZWxzZSB7CiAgICAgICAgc291cmNlID0gcmVxdWlyZSgiZmlsZSIpLnBhdGgocmVxdWlyZSgiZmlsZSIpLmN3ZCgpKS5qb2luKGFyZ3NbMV0pLnJlYWQoe2NoYXJzZXQ6ICJ1dGYtOCJ9KTsKICAgIH0KICAgIHJldHVybiBleHBvcnRzLnBhcnNlci5wYXJzZShzb3VyY2UpOwp9CmlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiByZXF1aXJlLm1haW4gPT09IG1vZHVsZSkgewogIGV4cG9ydHMubWFpbih0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcgPyBwcm9jZXNzLmFyZ3Yuc2xpY2UoMSkgOiByZXF1aXJlKCJzeXN0ZW0iKS5hcmdzKTsKfQp9Owo7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL2Jhc2UuanMKSGFuZGxlYmFycy5QYXJzZXIgPSBoYW5kbGViYXJzOwoKSGFuZGxlYmFycy5wYXJzZSA9IGZ1bmN0aW9uKHN0cmluZykgewogIEhhbmRsZWJhcnMuUGFyc2VyLnl5ID0gSGFuZGxlYmFycy5BU1Q7CiAgcmV0dXJuIEhhbmRsZWJhcnMuUGFyc2VyLnBhcnNlKHN0cmluZyk7Cn07CgpIYW5kbGViYXJzLnByaW50ID0gZnVuY3Rpb24oYXN0KSB7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlByaW50VmlzaXRvcigpLmFjY2VwdChhc3QpOwp9OwoKSGFuZGxlYmFycy5sb2dnZXIgPSB7CiAgREVCVUc6IDAsIElORk86IDEsIFdBUk46IDIsIEVSUk9SOiAzLCBsZXZlbDogMywKCiAgLy8gb3ZlcnJpZGUgaW4gdGhlIGhvc3QgZW52aXJvbm1lbnQKICBsb2c6IGZ1bmN0aW9uKGxldmVsLCBzdHIpIHt9Cn07CgpIYW5kbGViYXJzLmxvZyA9IGZ1bmN0aW9uKGxldmVsLCBzdHIpIHsgSGFuZGxlYmFycy5sb2dnZXIubG9nKGxldmVsLCBzdHIpOyB9Owo7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL2FzdC5qcwooZnVuY3Rpb24oKSB7CgogIEhhbmRsZWJhcnMuQVNUID0ge307CgogIEhhbmRsZWJhcnMuQVNULlByb2dyYW1Ob2RlID0gZnVuY3Rpb24oc3RhdGVtZW50cywgaW52ZXJzZSkgewogICAgdGhpcy50eXBlID0gInByb2dyYW0iOwogICAgdGhpcy5zdGF0ZW1lbnRzID0gc3RhdGVtZW50czsKICAgIGlmKGludmVyc2UpIHsgdGhpcy5pbnZlcnNlID0gbmV3IEhhbmRsZWJhcnMuQVNULlByb2dyYW1Ob2RlKGludmVyc2UpOyB9CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuTXVzdGFjaGVOb2RlID0gZnVuY3Rpb24ocmF3UGFyYW1zLCBoYXNoLCB1bmVzY2FwZWQpIHsKICAgIHRoaXMudHlwZSA9ICJtdXN0YWNoZSI7CiAgICB0aGlzLmVzY2FwZWQgPSAhdW5lc2NhcGVkOwogICAgdGhpcy5oYXNoID0gaGFzaDsKCiAgICB2YXIgaWQgPSB0aGlzLmlkID0gcmF3UGFyYW1zWzBdOwogICAgdmFyIHBhcmFtcyA9IHRoaXMucGFyYW1zID0gcmF3UGFyYW1zLnNsaWNlKDEpOwoKICAgIC8vIGEgbXVzdGFjaGUgaXMgYW4gZWxpZ2libGUgaGVscGVyIGlmOgogICAgLy8gKiBpdHMgaWQgaXMgc2ltcGxlIChhIHNpbmdsZSBwYXJ0LCBub3QgYHRoaXNgIG9yIGAuLmApCiAgICB2YXIgZWxpZ2libGVIZWxwZXIgPSB0aGlzLmVsaWdpYmxlSGVscGVyID0gaWQuaXNTaW1wbGU7CgogICAgLy8gYSBtdXN0YWNoZSBpcyBkZWZpbml0ZWx5IGEgaGVscGVyIGlmOgogICAgLy8gKiBpdCBpcyBhbiBlbGlnaWJsZSBoZWxwZXIsIGFuZAogICAgLy8gKiBpdCBoYXMgYXQgbGVhc3Qgb25lIHBhcmFtZXRlciBvciBoYXNoIHNlZ21lbnQKICAgIHRoaXMuaXNIZWxwZXIgPSBlbGlnaWJsZUhlbHBlciAmJiAocGFyYW1zLmxlbmd0aCB8fCBoYXNoKTsKCiAgICAvLyBpZiBhIG11c3RhY2hlIGlzIGFuIGVsaWdpYmxlIGhlbHBlciBidXQgbm90IGEgZGVmaW5pdGUKICAgIC8vIGhlbHBlciwgaXQgaXMgYW1iaWd1b3VzLCBhbmQgd2lsbCBiZSByZXNvbHZlZCBpbiBhIGxhdGVyCiAgICAvLyBwYXNzIG9yIGF0IHJ1bnRpbWUuCiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuUGFydGlhbE5vZGUgPSBmdW5jdGlvbihpZCwgY29udGV4dCkgewogICAgdGhpcy50eXBlICAgID0gInBhcnRpYWwiOwoKICAgIC8vIFRPRE86IGRpc2FsbG93IGNvbXBsZXggSURzCgogICAgdGhpcy5pZCAgICAgID0gaWQ7CiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogIH07CgogIHZhciB2ZXJpZnlNYXRjaCA9IGZ1bmN0aW9uKG9wZW4sIGNsb3NlKSB7CiAgICBpZihvcGVuLm9yaWdpbmFsICE9PSBjbG9zZS5vcmlnaW5hbCkgewogICAgICB0aHJvdyBuZXcgSGFuZGxlYmFycy5FeGNlcHRpb24ob3Blbi5vcmlnaW5hbCArICIgZG9lc24ndCBtYXRjaCAiICsgY2xvc2Uub3JpZ2luYWwpOwogICAgfQogIH07CgogIEhhbmRsZWJhcnMuQVNULkJsb2NrTm9kZSA9IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlLCBjbG9zZSkgewogICAgdmVyaWZ5TWF0Y2gobXVzdGFjaGUuaWQsIGNsb3NlKTsKICAgIHRoaXMudHlwZSA9ICJibG9jayI7CiAgICB0aGlzLm11c3RhY2hlID0gbXVzdGFjaGU7CiAgICB0aGlzLnByb2dyYW0gID0gcHJvZ3JhbTsKICAgIHRoaXMuaW52ZXJzZSAgPSBpbnZlcnNlOwoKICAgIGlmICh0aGlzLmludmVyc2UgJiYgIXRoaXMucHJvZ3JhbSkgewogICAgICB0aGlzLmlzSW52ZXJzZSA9IHRydWU7CiAgICB9CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQ29udGVudE5vZGUgPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgIHRoaXMudHlwZSA9ICJjb250ZW50IjsKICAgIHRoaXMuc3RyaW5nID0gc3RyaW5nOwogIH07CgogIEhhbmRsZWJhcnMuQVNULkhhc2hOb2RlID0gZnVuY3Rpb24ocGFpcnMpIHsKICAgIHRoaXMudHlwZSA9ICJoYXNoIjsKICAgIHRoaXMucGFpcnMgPSBwYWlyczsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5JZE5vZGUgPSBmdW5jdGlvbihwYXJ0cykgewogICAgdGhpcy50eXBlID0gIklEIjsKICAgIHRoaXMub3JpZ2luYWwgPSBwYXJ0cy5qb2luKCIuIik7CgogICAgdmFyIGRpZyA9IFtdLCBkZXB0aCA9IDA7CgogICAgZm9yKHZhciBpPTAsbD1wYXJ0cy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgIHZhciBwYXJ0ID0gcGFydHNbaV07CgogICAgICBpZihwYXJ0ID09PSAiLi4iKSB7IGRlcHRoKys7IH0KICAgICAgZWxzZSBpZihwYXJ0ID09PSAiLiIgfHwgcGFydCA9PT0gInRoaXMiKSB7IHRoaXMuaXNTY29wZWQgPSB0cnVlOyB9CiAgICAgIGVsc2UgeyBkaWcucHVzaChwYXJ0KTsgfQogICAgfQoKICAgIHRoaXMucGFydHMgICAgPSBkaWc7CiAgICB0aGlzLnN0cmluZyAgID0gZGlnLmpvaW4oJy4nKTsKICAgIHRoaXMuZGVwdGggICAgPSBkZXB0aDsKCiAgICAvLyBhbiBJRCBpcyBzaW1wbGUgaWYgaXQgb25seSBoYXMgb25lIHBhcnQsIGFuZCB0aGF0IHBhcnQgaXMgbm90CiAgICAvLyBgLi5gIG9yIGB0aGlzYC4KICAgIHRoaXMuaXNTaW1wbGUgPSBwYXJ0cy5sZW5ndGggPT09IDEgJiYgIXRoaXMuaXNTY29wZWQgJiYgZGVwdGggPT09IDA7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuRGF0YU5vZGUgPSBmdW5jdGlvbihpZCkgewogICAgdGhpcy50eXBlID0gIkRBVEEiOwogICAgdGhpcy5pZCA9IGlkOwogIH07CgogIEhhbmRsZWJhcnMuQVNULlN0cmluZ05vZGUgPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgIHRoaXMudHlwZSA9ICJTVFJJTkciOwogICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuSW50ZWdlck5vZGUgPSBmdW5jdGlvbihpbnRlZ2VyKSB7CiAgICB0aGlzLnR5cGUgPSAiSU5URUdFUiI7CiAgICB0aGlzLmludGVnZXIgPSBpbnRlZ2VyOwogIH07CgogIEhhbmRsZWJhcnMuQVNULkJvb2xlYW5Ob2RlID0gZnVuY3Rpb24oYm9vbCkgewogICAgdGhpcy50eXBlID0gIkJPT0xFQU4iOwogICAgdGhpcy5ib29sID0gYm9vbDsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5Db21tZW50Tm9kZSA9IGZ1bmN0aW9uKGNvbW1lbnQpIHsKICAgIHRoaXMudHlwZSA9ICJjb21tZW50IjsKICAgIHRoaXMuY29tbWVudCA9IGNvbW1lbnQ7CiAgfTsKCn0pKCk7OwovLyBsaWIvaGFuZGxlYmFycy91dGlscy5qcwpIYW5kbGViYXJzLkV4Y2VwdGlvbiA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICB2YXIgdG1wID0gRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIGZvciAodmFyIHAgaW4gdG1wKSB7CiAgICBpZiAodG1wLmhhc093blByb3BlcnR5KHApKSB7IHRoaXNbcF0gPSB0bXBbcF07IH0KICB9CgogIHRoaXMubWVzc2FnZSA9IHRtcC5tZXNzYWdlOwp9OwpIYW5kbGViYXJzLkV4Y2VwdGlvbi5wcm90b3R5cGUgPSBuZXcgRXJyb3IoKTsKCi8vIEJ1aWxkIG91dCBvdXIgYmFzaWMgU2FmZVN0cmluZyB0eXBlCkhhbmRsZWJhcnMuU2FmZVN0cmluZyA9IGZ1bmN0aW9uKHN0cmluZykgewogIHRoaXMuc3RyaW5nID0gc3RyaW5nOwp9OwpIYW5kbGViYXJzLlNhZmVTdHJpbmcucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuc3RyaW5nLnRvU3RyaW5nKCk7Cn07CgooZnVuY3Rpb24oKSB7CiAgdmFyIGVzY2FwZSA9IHsKICAgICImIjogIiZhbXA7IiwKICAgICI8IjogIiZsdDsiLAogICAgIj4iOiAiJmd0OyIsCiAgICAnIic6ICImcXVvdDsiLAogICAgIiciOiAiJiN4Mjc7IiwKICAgICJgIjogIiYjeDYwOyIKICB9OwoKICB2YXIgYmFkQ2hhcnMgPSAvWyY8PiInYF0vZzsKICB2YXIgcG9zc2libGUgPSAvWyY8PiInYF0vOwoKICB2YXIgZXNjYXBlQ2hhciA9IGZ1bmN0aW9uKGNocikgewogICAgcmV0dXJuIGVzY2FwZVtjaHJdIHx8ICImYW1wOyI7CiAgfTsKCiAgSGFuZGxlYmFycy5VdGlscyA9IHsKICAgIGVzY2FwZUV4cHJlc3Npb246IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAvLyBkb24ndCBlc2NhcGUgU2FmZVN0cmluZ3MsIHNpbmNlIHRoZXkncmUgYWxyZWFkeSBzYWZlCiAgICAgIGlmIChzdHJpbmcgaW5zdGFuY2VvZiBIYW5kbGViYXJzLlNhZmVTdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyaW5nLnRvU3RyaW5nKCk7CiAgICAgIH0gZWxzZSBpZiAoc3RyaW5nID09IG51bGwgfHwgc3RyaW5nID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiAiIjsKICAgICAgfQoKICAgICAgaWYoIXBvc3NpYmxlLnRlc3Qoc3RyaW5nKSkgeyByZXR1cm4gc3RyaW5nOyB9CiAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShiYWRDaGFycywgZXNjYXBlQ2hhcik7CiAgICB9LAoKICAgIGlzRW1wdHk6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICJbb2JqZWN0IEFycmF5XSIgJiYgdmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgfTsKfSkoKTs7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL2NvbXBpbGVyLmpzCgovKmpzaGludCBlcW51bGw6dHJ1ZSovCkhhbmRsZWJhcnMuQ29tcGlsZXIgPSBmdW5jdGlvbigpIHt9OwpIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlciA9IGZ1bmN0aW9uKCkge307CgooZnVuY3Rpb24oQ29tcGlsZXIsIEphdmFTY3JpcHRDb21waWxlcikgewogIC8vIHRoZSBmb3VuZEhlbHBlciByZWdpc3RlciB3aWxsIGRpc2FtYmlndWF0ZSBoZWxwZXIgbG9va3VwIGZyb20gZmluZGluZyBhCiAgLy8gZnVuY3Rpb24gaW4gYSBjb250ZXh0LiBUaGlzIGlzIG5lY2Vzc2FyeSBmb3IgbXVzdGFjaGUgY29tcGF0aWJpbGl0eSwgd2hpY2gKICAvLyByZXF1aXJlcyB0aGF0IGNvbnRleHQgZnVuY3Rpb25zIGluIGJsb2NrcyBhcmUgZXZhbHVhdGVkIGJ5IGJsb2NrSGVscGVyTWlzc2luZywKICAvLyBhbmQgdGhlbiBwcm9jZWVkIGFzIGlmIHRoZSByZXN1bHRpbmcgdmFsdWUgd2FzIHByb3ZpZGVkIHRvIGJsb2NrSGVscGVyTWlzc2luZy4KCiAgQ29tcGlsZXIucHJvdG90eXBlID0gewogICAgY29tcGlsZXI6IENvbXBpbGVyLAoKICAgIGRpc2Fzc2VtYmxlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9wY29kZXMgPSB0aGlzLm9wY29kZXMsIG9wY29kZSwgb3V0ID0gW10sIHBhcmFtcywgcGFyYW07CgogICAgICBmb3IgKHZhciBpPTAsIGw9b3Bjb2Rlcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgb3Bjb2RlID0gb3Bjb2Rlc1tpXTsKCiAgICAgICAgaWYgKG9wY29kZS5vcGNvZGUgPT09ICdERUNMQVJFJykgewogICAgICAgICAgb3V0LnB1c2goIkRFQ0xBUkUgIiArIG9wY29kZS5uYW1lICsgIj0iICsgb3Bjb2RlLnZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGFyYW1zID0gW107CiAgICAgICAgICBmb3IgKHZhciBqPTA7IGo8b3Bjb2RlLmFyZ3MubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgcGFyYW0gPSBvcGNvZGUuYXJnc1tqXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBwYXJhbSA9ICJcIiIgKyBwYXJhbS5yZXBsYWNlKCJcbiIsICJcXG4iKSArICJcIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pOwogICAgICAgICAgfQogICAgICAgICAgb3V0LnB1c2gob3Bjb2RlLm9wY29kZSArICIgIiArIHBhcmFtcy5qb2luKCIgIikpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG91dC5qb2luKCJcbiIpOwogICAgfSwKCiAgICBndWlkOiAwLAoKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHByb2dyYW0sIG9wdGlvbnMpIHsKICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgICB0aGlzLmRlcHRocyA9IHtsaXN0OiBbXX07CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgogICAgICAvLyBUaGVzZSBjaGFuZ2VzIHdpbGwgcHJvcGFnYXRlIHRvIHRoZSBvdGhlciBjb21waWxlciBjb21wb25lbnRzCiAgICAgIHZhciBrbm93bkhlbHBlcnMgPSB0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzOwogICAgICB0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzID0gewogICAgICAgICdoZWxwZXJNaXNzaW5nJzogdHJ1ZSwKICAgICAgICAnYmxvY2tIZWxwZXJNaXNzaW5nJzogdHJ1ZSwKICAgICAgICAnZWFjaCc6IHRydWUsCiAgICAgICAgJ2lmJzogdHJ1ZSwKICAgICAgICAndW5sZXNzJzogdHJ1ZSwKICAgICAgICAnd2l0aCc6IHRydWUsCiAgICAgICAgJ2xvZyc6IHRydWUKICAgICAgfTsKICAgICAgaWYgKGtub3duSGVscGVycykgewogICAgICAgIGZvciAodmFyIG5hbWUgaW4ga25vd25IZWxwZXJzKSB7CiAgICAgICAgICB0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzW25hbWVdID0ga25vd25IZWxwZXJzW25hbWVdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMucHJvZ3JhbShwcm9ncmFtKTsKICAgIH0sCgogICAgYWNjZXB0OiBmdW5jdGlvbihub2RlKSB7CiAgICAgIHJldHVybiB0aGlzW25vZGUudHlwZV0obm9kZSk7CiAgICB9LAoKICAgIHByb2dyYW06IGZ1bmN0aW9uKHByb2dyYW0pIHsKICAgICAgdmFyIHN0YXRlbWVudHMgPSBwcm9ncmFtLnN0YXRlbWVudHMsIHN0YXRlbWVudDsKICAgICAgdGhpcy5vcGNvZGVzID0gW107CgogICAgICBmb3IodmFyIGk9MCwgbD1zdGF0ZW1lbnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBzdGF0ZW1lbnQgPSBzdGF0ZW1lbnRzW2ldOwogICAgICAgIHRoaXNbc3RhdGVtZW50LnR5cGVdKHN0YXRlbWVudCk7CiAgICAgIH0KICAgICAgdGhpcy5pc1NpbXBsZSA9IGwgPT09IDE7CgogICAgICB0aGlzLmRlcHRocy5saXN0ID0gdGhpcy5kZXB0aHMubGlzdC5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICByZXR1cm4gYSAtIGI7CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIGNvbXBpbGVQcm9ncmFtOiBmdW5jdGlvbihwcm9ncmFtKSB7CiAgICAgIHZhciByZXN1bHQgPSBuZXcgdGhpcy5jb21waWxlcigpLmNvbXBpbGUocHJvZ3JhbSwgdGhpcy5vcHRpb25zKTsKICAgICAgdmFyIGd1aWQgPSB0aGlzLmd1aWQrKywgZGVwdGg7CgogICAgICB0aGlzLnVzZVBhcnRpYWwgPSB0aGlzLnVzZVBhcnRpYWwgfHwgcmVzdWx0LnVzZVBhcnRpYWw7CgogICAgICB0aGlzLmNoaWxkcmVuW2d1aWRdID0gcmVzdWx0OwoKICAgICAgZm9yKHZhciBpPTAsIGw9cmVzdWx0LmRlcHRocy5saXN0Lmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBkZXB0aCA9IHJlc3VsdC5kZXB0aHMubGlzdFtpXTsKCiAgICAgICAgaWYoZGVwdGggPCAyKSB7IGNvbnRpbnVlOyB9CiAgICAgICAgZWxzZSB7IHRoaXMuYWRkRGVwdGgoZGVwdGggLSAxKTsgfQogICAgICB9CgogICAgICByZXR1cm4gZ3VpZDsKICAgIH0sCgogICAgYmxvY2s6IGZ1bmN0aW9uKGJsb2NrKSB7CiAgICAgIHZhciBtdXN0YWNoZSA9IGJsb2NrLm11c3RhY2hlLAogICAgICAgICAgcHJvZ3JhbSA9IGJsb2NrLnByb2dyYW0sCiAgICAgICAgICBpbnZlcnNlID0gYmxvY2suaW52ZXJzZTsKCiAgICAgIGlmIChwcm9ncmFtKSB7CiAgICAgICAgcHJvZ3JhbSA9IHRoaXMuY29tcGlsZVByb2dyYW0ocHJvZ3JhbSk7CiAgICAgIH0KCiAgICAgIGlmIChpbnZlcnNlKSB7CiAgICAgICAgaW52ZXJzZSA9IHRoaXMuY29tcGlsZVByb2dyYW0oaW52ZXJzZSk7CiAgICAgIH0KCiAgICAgIHZhciB0eXBlID0gdGhpcy5jbGFzc2lmeU11c3RhY2hlKG11c3RhY2hlKTsKCiAgICAgIGlmICh0eXBlID09PSAiaGVscGVyIikgewogICAgICAgIHRoaXMuaGVscGVyTXVzdGFjaGUobXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UpOwogICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJzaW1wbGUiKSB7CiAgICAgICAgdGhpcy5zaW1wbGVNdXN0YWNoZShtdXN0YWNoZSk7CgogICAgICAgIC8vIG5vdyB0aGF0IHRoZSBzaW1wbGUgbXVzdGFjaGUgaXMgcmVzb2x2ZWQsIHdlIG5lZWQgdG8KICAgICAgICAvLyBldmFsdWF0ZSBpdCBieSBleGVjdXRpbmcgYGJsb2NrSGVscGVyTWlzc2luZ2AKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgICB0aGlzLm9wY29kZSgnYmxvY2tWYWx1ZScpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYW1iaWd1b3VzTXVzdGFjaGUobXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UpOwoKICAgICAgICAvLyBub3cgdGhhdCB0aGUgc2ltcGxlIG11c3RhY2hlIGlzIHJlc29sdmVkLCB3ZSBuZWVkIHRvCiAgICAgICAgLy8gZXZhbHVhdGUgaXQgYnkgZXhlY3V0aW5nIGBibG9ja0hlbHBlck1pc3NpbmdgCiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgcHJvZ3JhbSk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgaW52ZXJzZSk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hMaXRlcmFsJywgJ3t9Jyk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FtYmlndW91c0Jsb2NrVmFsdWUnKTsKICAgICAgfQoKICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZCcpOwogICAgfSwKCiAgICBoYXNoOiBmdW5jdGlvbihoYXNoKSB7CiAgICAgIHZhciBwYWlycyA9IGhhc2gucGFpcnMsIHBhaXIsIHZhbDsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoJywgJ3t9Jyk7CgogICAgICBmb3IodmFyIGk9MCwgbD1wYWlycy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgcGFpciA9IHBhaXJzW2ldOwogICAgICAgIHZhbCAgPSBwYWlyWzFdOwoKICAgICAgICB0aGlzLmFjY2VwdCh2YWwpOwogICAgICAgIHRoaXMub3Bjb2RlKCdhc3NpZ25Ub0hhc2gnLCBwYWlyWzBdKTsKICAgICAgfQogICAgfSwKCiAgICBwYXJ0aWFsOiBmdW5jdGlvbihwYXJ0aWFsKSB7CiAgICAgIHZhciBpZCA9IHBhcnRpYWwuaWQ7CiAgICAgIHRoaXMudXNlUGFydGlhbCA9IHRydWU7CgogICAgICBpZihwYXJ0aWFsLmNvbnRleHQpIHsKICAgICAgICB0aGlzLklEKHBhcnRpYWwuY29udGV4dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2gnLCAnZGVwdGgwJyk7CiAgICAgIH0KCiAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VQYXJ0aWFsJywgaWQub3JpZ2luYWwpOwogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICB9LAoKICAgIGNvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZENvbnRlbnQnLCBjb250ZW50LnN0cmluZyk7CiAgICB9LAoKICAgIG11c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgICAgdmFyIHR5cGUgPSB0aGlzLmNsYXNzaWZ5TXVzdGFjaGUobXVzdGFjaGUpOwoKICAgICAgaWYgKHR5cGUgPT09ICJzaW1wbGUiKSB7CiAgICAgICAgdGhpcy5zaW1wbGVNdXN0YWNoZShtdXN0YWNoZSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gImhlbHBlciIpIHsKICAgICAgICB0aGlzLmhlbHBlck11c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFtYmlndW91c011c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfQoKICAgICAgaWYobXVzdGFjaGUuZXNjYXBlZCAmJiAhb3B0aW9ucy5ub0VzY2FwZSkgewogICAgICAgIHRoaXMub3Bjb2RlKCdhcHBlbmRFc2NhcGVkJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZCcpOwogICAgICB9CiAgICB9LAoKICAgIGFtYmlndW91c011c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgaWQgPSBtdXN0YWNoZS5pZCwgbmFtZSA9IGlkLnBhcnRzWzBdOwoKICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CgogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgaW52ZXJzZSk7CgogICAgICB0aGlzLm9wY29kZSgnaW52b2tlQW1iaWd1b3VzJywgbmFtZSk7CiAgICB9LAoKICAgIHNpbXBsZU11c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgaWQgPSBtdXN0YWNoZS5pZDsKCiAgICAgIGlmIChpZC50eXBlID09PSAnREFUQScpIHsKICAgICAgICB0aGlzLkRBVEEoaWQpOwogICAgICB9IGVsc2UgaWYgKGlkLnBhcnRzLmxlbmd0aCkgewogICAgICAgIHRoaXMuSUQoaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNpbXBsaWZpZWQgSUQgZm9yIGB0aGlzYAogICAgICAgIHRoaXMuYWRkRGVwdGgoaWQuZGVwdGgpOwogICAgICAgIHRoaXMub3Bjb2RlKCdnZXRDb250ZXh0JywgaWQuZGVwdGgpOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoQ29udGV4dCcpOwogICAgICB9CgogICAgICB0aGlzLm9wY29kZSgncmVzb2x2ZVBvc3NpYmxlTGFtYmRhJyk7CiAgICB9LAoKICAgIGhlbHBlck11c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgcGFyYW1zID0gdGhpcy5zZXR1cEZ1bGxNdXN0YWNoZVBhcmFtcyhtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSksCiAgICAgICAgICBuYW1lID0gbXVzdGFjaGUuaWQucGFydHNbMF07CgogICAgICBpZiAodGhpcy5vcHRpb25zLmtub3duSGVscGVyc1tuYW1lXSkgewogICAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VLbm93bkhlbHBlcicsIHBhcmFtcy5sZW5ndGgsIG5hbWUpOwogICAgICB9IGVsc2UgaWYgKHRoaXMua25vd25IZWxwZXJzT25seSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiWW91IHNwZWNpZmllZCBrbm93bkhlbHBlcnNPbmx5LCBidXQgdXNlZCB0aGUgdW5rbm93biBoZWxwZXIgIiArIG5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VIZWxwZXInLCBwYXJhbXMubGVuZ3RoLCBuYW1lKTsKICAgICAgfQogICAgfSwKCiAgICBJRDogZnVuY3Rpb24oaWQpIHsKICAgICAgdGhpcy5hZGREZXB0aChpZC5kZXB0aCk7CiAgICAgIHRoaXMub3Bjb2RlKCdnZXRDb250ZXh0JywgaWQuZGVwdGgpOwoKICAgICAgdmFyIG5hbWUgPSBpZC5wYXJ0c1swXTsKICAgICAgaWYgKCFuYW1lKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hDb250ZXh0Jyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cE9uQ29udGV4dCcsIGlkLnBhcnRzWzBdKTsKICAgICAgfQoKICAgICAgZm9yKHZhciBpPTEsIGw9aWQucGFydHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHRoaXMub3Bjb2RlKCdsb29rdXAnLCBpZC5wYXJ0c1tpXSk7CiAgICAgIH0KICAgIH0sCgogICAgREFUQTogZnVuY3Rpb24oZGF0YSkgewogICAgICB0aGlzLm9wdGlvbnMuZGF0YSA9IHRydWU7CiAgICAgIHRoaXMub3Bjb2RlKCdsb29rdXBEYXRhJywgZGF0YS5pZCk7CiAgICB9LAoKICAgIFNUUklORzogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoU3RyaW5nJywgc3RyaW5nLnN0cmluZyk7CiAgICB9LAoKICAgIElOVEVHRVI6IGZ1bmN0aW9uKGludGVnZXIpIHsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hMaXRlcmFsJywgaW50ZWdlci5pbnRlZ2VyKTsKICAgIH0sCgogICAgQk9PTEVBTjogZnVuY3Rpb24oYm9vbCkgewogICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCBib29sLmJvb2wpOwogICAgfSwKCiAgICBjb21tZW50OiBmdW5jdGlvbigpIHt9LAoKICAgIC8vIEhFTFBFUlMKICAgIG9wY29kZTogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLm9wY29kZXMucHVzaCh7IG9wY29kZTogbmFtZSwgYXJnczogW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpIH0pOwogICAgfSwKCiAgICBkZWNsYXJlOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICB0aGlzLm9wY29kZXMucHVzaCh7IG9wY29kZTogJ0RFQ0xBUkUnLCBuYW1lOiBuYW1lLCB2YWx1ZTogdmFsdWUgfSk7CiAgICB9LAoKICAgIGFkZERlcHRoOiBmdW5jdGlvbihkZXB0aCkgewogICAgICBpZihpc05hTihkZXB0aCkpIHsgdGhyb3cgbmV3IEVycm9yKCJFV09UIik7IH0KICAgICAgaWYoZGVwdGggPT09IDApIHsgcmV0dXJuOyB9CgogICAgICBpZighdGhpcy5kZXB0aHNbZGVwdGhdKSB7CiAgICAgICAgdGhpcy5kZXB0aHNbZGVwdGhdID0gdHJ1ZTsKICAgICAgICB0aGlzLmRlcHRocy5saXN0LnB1c2goZGVwdGgpOwogICAgICB9CiAgICB9LAoKICAgIGNsYXNzaWZ5TXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgICAgIHZhciBpc0hlbHBlciAgID0gbXVzdGFjaGUuaXNIZWxwZXI7CiAgICAgIHZhciBpc0VsaWdpYmxlID0gbXVzdGFjaGUuZWxpZ2libGVIZWxwZXI7CiAgICAgIHZhciBvcHRpb25zICAgID0gdGhpcy5vcHRpb25zOwoKICAgICAgLy8gaWYgYW1iaWd1b3VzLCB3ZSBjYW4gcG9zc2libHkgcmVzb2x2ZSB0aGUgYW1iaWd1aXR5IG5vdwogICAgICBpZiAoaXNFbGlnaWJsZSAmJiAhaXNIZWxwZXIpIHsKICAgICAgICB2YXIgbmFtZSA9IG11c3RhY2hlLmlkLnBhcnRzWzBdOwoKICAgICAgICBpZiAob3B0aW9ucy5rbm93bkhlbHBlcnNbbmFtZV0pIHsKICAgICAgICAgIGlzSGVscGVyID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMua25vd25IZWxwZXJzT25seSkgewogICAgICAgICAgaXNFbGlnaWJsZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlzSGVscGVyKSB7IHJldHVybiAiaGVscGVyIjsgfQogICAgICBlbHNlIGlmIChpc0VsaWdpYmxlKSB7IHJldHVybiAiYW1iaWd1b3VzIjsgfQogICAgICBlbHNlIHsgcmV0dXJuICJzaW1wbGUiOyB9CiAgICB9LAoKICAgIHB1c2hQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICB2YXIgaSA9IHBhcmFtcy5sZW5ndGgsIHBhcmFtOwoKICAgICAgd2hpbGUoaS0tKSB7CiAgICAgICAgcGFyYW0gPSBwYXJhbXNbaV07CgogICAgICAgIGlmKHRoaXMub3B0aW9ucy5zdHJpbmdQYXJhbXMpIHsKICAgICAgICAgIGlmKHBhcmFtLmRlcHRoKSB7CiAgICAgICAgICAgIHRoaXMuYWRkRGVwdGgocGFyYW0uZGVwdGgpOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMub3Bjb2RlKCdnZXRDb250ZXh0JywgcGFyYW0uZGVwdGggfHwgMCk7CiAgICAgICAgICB0aGlzLm9wY29kZSgncHVzaFN0cmluZ1BhcmFtJywgcGFyYW0uc3RyaW5nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpc1twYXJhbS50eXBlXShwYXJhbSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHNldHVwTXVzdGFjaGVQYXJhbXM6IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgICAgIHZhciBwYXJhbXMgPSBtdXN0YWNoZS5wYXJhbXM7CiAgICAgIHRoaXMucHVzaFBhcmFtcyhwYXJhbXMpOwoKICAgICAgaWYobXVzdGFjaGUuaGFzaCkgewogICAgICAgIHRoaXMuaGFzaChtdXN0YWNoZS5oYXNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH0sCgogICAgLy8gdGhpcyB3aWxsIHJlcGxhY2Ugc2V0dXBNdXN0YWNoZVBhcmFtcyB3aGVuIHdlJ3JlIGRvbmUKICAgIHNldHVwRnVsbE11c3RhY2hlUGFyYW1zOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgcGFyYW1zID0gbXVzdGFjaGUucGFyYW1zOwogICAgICB0aGlzLnB1c2hQYXJhbXMocGFyYW1zKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKCiAgICAgIGlmKG11c3RhY2hlLmhhc2gpIHsKICAgICAgICB0aGlzLmhhc2gobXVzdGFjaGUuaGFzaCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hMaXRlcmFsJywgJ3t9Jyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwYXJhbXM7CiAgICB9CiAgfTsKCiAgdmFyIExpdGVyYWwgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIH07CgogIEphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUgPSB7CiAgICAvLyBQVUJMSUMgQVBJOiBZb3UgY2FuIG92ZXJyaWRlIHRoZXNlIG1ldGhvZHMgaW4gYSBzdWJjbGFzcyB0byBwcm92aWRlCiAgICAvLyBhbHRlcm5hdGl2ZSBjb21waWxlZCBmb3JtcyBmb3IgbmFtZSBsb29rdXAgYW5kIGJ1ZmZlcmluZyBzZW1hbnRpY3MKICAgIG5hbWVMb29rdXA6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSwgdHlwZSkgewogICAgICBpZiAoL15bMC05XSskLy50ZXN0KG5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHBhcmVudCArICJbIiArIG5hbWUgKyAiXSI7CiAgICAgIH0gZWxzZSBpZiAoSmF2YVNjcmlwdENvbXBpbGVyLmlzVmFsaWRKYXZhU2NyaXB0VmFyaWFibGVOYW1lKG5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHBhcmVudCArICIuIiArIG5hbWU7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgcmV0dXJuIHBhcmVudCArICJbJyIgKyBuYW1lICsgIiddIjsKICAgICAgfQogICAgfSwKCiAgICBhcHBlbmRUb0J1ZmZlcjogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIGlmICh0aGlzLmVudmlyb25tZW50LmlzU2ltcGxlKSB7CiAgICAgICAgcmV0dXJuICJyZXR1cm4gIiArIHN0cmluZyArICI7IjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gImJ1ZmZlciArPSAiICsgc3RyaW5nICsgIjsiOwogICAgICB9CiAgICB9LAoKICAgIGluaXRpYWxpemVCdWZmZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5xdW90ZWRTdHJpbmcoIiIpOwogICAgfSwKCiAgICBuYW1lc3BhY2U6ICJIYW5kbGViYXJzIiwKICAgIC8vIEVORCBQVUJMSUMgQVBJCgogICAgY29tcGlsZTogZnVuY3Rpb24oZW52aXJvbm1lbnQsIG9wdGlvbnMsIGNvbnRleHQsIGFzT2JqZWN0KSB7CiAgICAgIHRoaXMuZW52aXJvbm1lbnQgPSBlbnZpcm9ubWVudDsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgIEhhbmRsZWJhcnMubG9nKEhhbmRsZWJhcnMubG9nZ2VyLkRFQlVHLCB0aGlzLmVudmlyb25tZW50LmRpc2Fzc2VtYmxlKCkgKyAiXG5cbiIpOwoKICAgICAgdGhpcy5uYW1lID0gdGhpcy5lbnZpcm9ubWVudC5uYW1lOwogICAgICB0aGlzLmlzQ2hpbGQgPSAhIWNvbnRleHQ7CiAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQgfHwgewogICAgICAgIHByb2dyYW1zOiBbXSwKICAgICAgICBhbGlhc2VzOiB7IH0KICAgICAgfTsKCiAgICAgIHRoaXMucHJlYW1ibGUoKTsKCiAgICAgIHRoaXMuc3RhY2tTbG90ID0gMDsKICAgICAgdGhpcy5zdGFja1ZhcnMgPSBbXTsKICAgICAgdGhpcy5yZWdpc3RlcnMgPSB7IGxpc3Q6IFtdIH07CiAgICAgIHRoaXMuY29tcGlsZVN0YWNrID0gW107CgogICAgICB0aGlzLmNvbXBpbGVDaGlsZHJlbihlbnZpcm9ubWVudCwgb3B0aW9ucyk7CgogICAgICB2YXIgb3Bjb2RlcyA9IGVudmlyb25tZW50Lm9wY29kZXMsIG9wY29kZTsKCiAgICAgIHRoaXMuaSA9IDA7CgogICAgICBmb3IobD1vcGNvZGVzLmxlbmd0aDsgdGhpcy5pPGw7IHRoaXMuaSsrKSB7CiAgICAgICAgb3Bjb2RlID0gb3Bjb2Rlc1t0aGlzLmldOwoKICAgICAgICBpZihvcGNvZGUub3Bjb2RlID09PSAnREVDTEFSRScpIHsKICAgICAgICAgIHRoaXNbb3Bjb2RlLm5hbWVdID0gb3Bjb2RlLnZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW29wY29kZS5vcGNvZGVdLmFwcGx5KHRoaXMsIG9wY29kZS5hcmdzKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUZ1bmN0aW9uQ29udGV4dChhc09iamVjdCk7CiAgICB9LAoKICAgIG5leHRPcGNvZGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3Bjb2RlcyA9IHRoaXMuZW52aXJvbm1lbnQub3Bjb2Rlcywgb3Bjb2RlID0gb3Bjb2Rlc1t0aGlzLmkgKyAxXTsKICAgICAgcmV0dXJuIG9wY29kZXNbdGhpcy5pICsgMV07CiAgICB9LAoKICAgIGVhdDogZnVuY3Rpb24ob3Bjb2RlKSB7CiAgICAgIHRoaXMuaSA9IHRoaXMuaSArIDE7CiAgICB9LAoKICAgIHByZWFtYmxlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG91dCA9IFtdOwoKICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5uYW1lc3BhY2U7CiAgICAgICAgdmFyIGNvcGllcyA9ICJoZWxwZXJzID0gaGVscGVycyB8fCAiICsgbmFtZXNwYWNlICsgIi5oZWxwZXJzOyI7CiAgICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQudXNlUGFydGlhbCkgeyBjb3BpZXMgPSBjb3BpZXMgKyAiIHBhcnRpYWxzID0gcGFydGlhbHMgfHwgIiArIG5hbWVzcGFjZSArICIucGFydGlhbHM7IjsgfQogICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZGF0YSkgeyBjb3BpZXMgPSBjb3BpZXMgKyAiIGRhdGEgPSBkYXRhIHx8IHt9OyI7IH0KICAgICAgICBvdXQucHVzaChjb3BpZXMpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dC5wdXNoKCcnKTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLmVudmlyb25tZW50LmlzU2ltcGxlKSB7CiAgICAgICAgb3V0LnB1c2goIiwgYnVmZmVyID0gIiArIHRoaXMuaW5pdGlhbGl6ZUJ1ZmZlcigpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXQucHVzaCgiIik7CiAgICAgIH0KCiAgICAgIC8vIHRyYWNrIHRoZSBsYXN0IGNvbnRleHQgcHVzaGVkIGludG8gcGxhY2UgdG8gYWxsb3cgc2tpcHBpbmcgdGhlCiAgICAgIC8vIGdldENvbnRleHQgb3Bjb2RlIHdoZW4gaXQgd291bGQgYmUgYSBub29wCiAgICAgIHRoaXMubGFzdENvbnRleHQgPSAwOwogICAgICB0aGlzLnNvdXJjZSA9IG91dDsKICAgIH0sCgogICAgY3JlYXRlRnVuY3Rpb25Db250ZXh0OiBmdW5jdGlvbihhc09iamVjdCkgewogICAgICB2YXIgbG9jYWxzID0gdGhpcy5zdGFja1ZhcnMuY29uY2F0KHRoaXMucmVnaXN0ZXJzLmxpc3QpOwoKICAgICAgaWYobG9jYWxzLmxlbmd0aCA+IDApIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSA9IHRoaXMuc291cmNlWzFdICsgIiwgIiArIGxvY2Fscy5qb2luKCIsICIpOwogICAgICB9CgogICAgICAvLyBHZW5lcmF0ZSBtaW5pbWl6ZXIgYWxpYXMgbWFwcGluZ3MKICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB2YXIgYWxpYXNlcyA9IFtdOwogICAgICAgIGZvciAodmFyIGFsaWFzIGluIHRoaXMuY29udGV4dC5hbGlhc2VzKSB7CiAgICAgICAgICB0aGlzLnNvdXJjZVsxXSA9IHRoaXMuc291cmNlWzFdICsgJywgJyArIGFsaWFzICsgJz0nICsgdGhpcy5jb250ZXh0LmFsaWFzZXNbYWxpYXNdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuc291cmNlWzFdKSB7CiAgICAgICAgdGhpcy5zb3VyY2VbMV0gPSAidmFyICIgKyB0aGlzLnNvdXJjZVsxXS5zdWJzdHJpbmcoMikgKyAiOyI7CiAgICAgIH0KCiAgICAgIC8vIE1lcmdlIGNoaWxkcmVuCiAgICAgIGlmICghdGhpcy5pc0NoaWxkKSB7CiAgICAgICAgdGhpcy5zb3VyY2VbMV0gKz0gJ1xuJyArIHRoaXMuY29udGV4dC5wcm9ncmFtcy5qb2luKCdcbicpICsgJ1xuJzsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLmVudmlyb25tZW50LmlzU2ltcGxlKSB7CiAgICAgICAgdGhpcy5zb3VyY2UucHVzaCgicmV0dXJuIGJ1ZmZlcjsiKTsKICAgICAgfQoKICAgICAgdmFyIHBhcmFtcyA9IHRoaXMuaXNDaGlsZCA/IFsiZGVwdGgwIiwgImRhdGEiXSA6IFsiSGFuZGxlYmFycyIsICJkZXB0aDAiLCAiaGVscGVycyIsICJwYXJ0aWFscyIsICJkYXRhIl07CgogICAgICBmb3IodmFyIGk9MCwgbD10aGlzLmVudmlyb25tZW50LmRlcHRocy5saXN0Lmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBwYXJhbXMucHVzaCgiZGVwdGgiICsgdGhpcy5lbnZpcm9ubWVudC5kZXB0aHMubGlzdFtpXSk7CiAgICAgIH0KCiAgICAgIGlmIChhc09iamVjdCkgewogICAgICAgIHBhcmFtcy5wdXNoKHRoaXMuc291cmNlLmpvaW4oIlxuICAiKSk7CgogICAgICAgIHJldHVybiBGdW5jdGlvbi5hcHBseSh0aGlzLCBwYXJhbXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBmdW5jdGlvblNvdXJjZSA9ICdmdW5jdGlvbiAnICsgKHRoaXMubmFtZSB8fCAnJykgKyAnKCcgKyBwYXJhbXMuam9pbignLCcpICsgJykge1xuICAnICsgdGhpcy5zb3VyY2Uuam9pbigiXG4gICIpICsgJ30nOwogICAgICAgIEhhbmRsZWJhcnMubG9nKEhhbmRsZWJhcnMubG9nZ2VyLkRFQlVHLCBmdW5jdGlvblNvdXJjZSArICJcblxuIik7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uU291cmNlOwogICAgICB9CiAgICB9LAoKICAgIC8vIFtibG9ja1ZhbHVlXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHZhbHVlCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHJldHVybiB2YWx1ZSBvZiBibG9ja0hlbHBlck1pc3NpbmcKICAgIC8vCiAgICAvLyBUaGUgcHVycG9zZSBvZiB0aGlzIG9wY29kZSBpcyB0byB0YWtlIGEgYmxvY2sgb2YgdGhlIGZvcm0KICAgIC8vIGB7eyNmb299fS4uLnt7L2Zvb319YCwgcmVzb2x2ZSB0aGUgdmFsdWUgb2YgYGZvb2AsIGFuZAogICAgLy8gcmVwbGFjZSBpdCBvbiB0aGUgc3RhY2sgd2l0aCB0aGUgcmVzdWx0IG9mIHByb3Blcmx5CiAgICAvLyBpbnZva2luZyBibG9ja0hlbHBlck1pc3NpbmcuCiAgICBibG9ja1ZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuYmxvY2tIZWxwZXJNaXNzaW5nID0gJ2hlbHBlcnMuYmxvY2tIZWxwZXJNaXNzaW5nJzsKCiAgICAgIHZhciBwYXJhbXMgPSBbImRlcHRoMCJdOwogICAgICB0aGlzLnNldHVwUGFyYW1zKDAsIHBhcmFtcyk7CgogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcGFyYW1zLnNwbGljZSgxLCAwLCBjdXJyZW50KTsKICAgICAgICByZXR1cm4gY3VycmVudCArICIgPSBibG9ja0hlbHBlck1pc3NpbmcuY2FsbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKSI7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbYW1iaWd1b3VzQmxvY2tWYWx1ZV0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCB2YWx1ZQogICAgLy8gQ29tcGlsZXIgdmFsdWUsIGJlZm9yZTogbGFzdEhlbHBlcj12YWx1ZSBvZiBsYXN0IGZvdW5kIGhlbHBlciwgaWYgYW55CiAgICAvLyBPbiBzdGFjaywgYWZ0ZXIsIGlmIG5vIGxhc3RIZWxwZXI6IHNhbWUgYXMgW2Jsb2NrVmFsdWVdCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXIsIGlmIGxhc3RIZWxwZXI6IHZhbHVlCiAgICBhbWJpZ3VvdXNCbG9ja1ZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuYmxvY2tIZWxwZXJNaXNzaW5nID0gJ2hlbHBlcnMuYmxvY2tIZWxwZXJNaXNzaW5nJzsKCiAgICAgIHZhciBwYXJhbXMgPSBbImRlcHRoMCJdOwogICAgICB0aGlzLnNldHVwUGFyYW1zKDAsIHBhcmFtcyk7CgogICAgICB2YXIgY3VycmVudCA9IHRoaXMudG9wU3RhY2soKTsKICAgICAgcGFyYW1zLnNwbGljZSgxLCAwLCBjdXJyZW50KTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2goImlmICghIiArIHRoaXMubGFzdEhlbHBlciArICIpIHsgIiArIGN1cnJlbnQgKyAiID0gYmxvY2tIZWxwZXJNaXNzaW5nLmNhbGwoIiArIHBhcmFtcy5qb2luKCIsICIpICsgIik7IH0iKTsKICAgIH0sCgogICAgLy8gW2FwcGVuZENvbnRlbnRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IC4uLgogICAgLy8KICAgIC8vIEFwcGVuZHMgdGhlIHN0cmluZyB2YWx1ZSBvZiBgY29udGVudGAgdG8gdGhlIGN1cnJlbnQgYnVmZmVyCiAgICBhcHBlbmRDb250ZW50OiBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgIHRoaXMuc291cmNlLnB1c2godGhpcy5hcHBlbmRUb0J1ZmZlcih0aGlzLnF1b3RlZFN0cmluZyhjb250ZW50KSkpOwogICAgfSwKCiAgICAvLyBbYXBwZW5kXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gQ29lcmNlcyBgdmFsdWVgIHRvIGEgU3RyaW5nIGFuZCBhcHBlbmRzIGl0IHRvIHRoZSBjdXJyZW50IGJ1ZmZlci4KICAgIC8vCiAgICAvLyBJZiBgdmFsdWVgIGlzIHRydXRoeSwgb3IgMCwgaXQgaXMgY29lcmNlZCBpbnRvIGEgc3RyaW5nIGFuZCBhcHBlbmRlZAogICAgLy8gT3RoZXJ3aXNlLCB0aGUgZW1wdHkgc3RyaW5nIGlzIGFwcGVuZGVkCiAgICBhcHBlbmQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbG9jYWwgPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgIHRoaXMuc291cmNlLnB1c2goImlmKCIgKyBsb2NhbCArICIgfHwgIiArIGxvY2FsICsgIiA9PT0gMCkgeyAiICsgdGhpcy5hcHBlbmRUb0J1ZmZlcihsb2NhbCkgKyAiIH0iKTsKICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICB0aGlzLnNvdXJjZS5wdXNoKCJlbHNlIHsgIiArIHRoaXMuYXBwZW5kVG9CdWZmZXIoIicnIikgKyAiIH0iKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBbYXBwZW5kRXNjYXBlZF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiB2YWx1ZSwgLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IC4uLgogICAgLy8KICAgIC8vIEVzY2FwZSBgdmFsdWVgIGFuZCBhcHBlbmQgaXQgdG8gdGhlIGJ1ZmZlcgogICAgYXBwZW5kRXNjYXBlZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcGNvZGUgPSB0aGlzLm5leHRPcGNvZGUoKSwgZXh0cmEgPSAiIjsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuZXNjYXBlRXhwcmVzc2lvbiA9ICd0aGlzLmVzY2FwZUV4cHJlc3Npb24nOwoKICAgICAgaWYob3Bjb2RlICYmIG9wY29kZS5vcGNvZGUgPT09ICdhcHBlbmRDb250ZW50JykgewogICAgICAgIGV4dHJhID0gIiArICIgKyB0aGlzLnF1b3RlZFN0cmluZyhvcGNvZGUuYXJnc1swXSk7CiAgICAgICAgdGhpcy5lYXQob3Bjb2RlKTsKICAgICAgfQoKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmFwcGVuZFRvQnVmZmVyKCJlc2NhcGVFeHByZXNzaW9uKCIgKyB0aGlzLnBvcFN0YWNrKCkgKyAiKSIgKyBleHRyYSkpOwogICAgfSwKCiAgICAvLyBbZ2V0Q29udGV4dF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLyBDb21waWxlciB2YWx1ZSwgYWZ0ZXI6IGxhc3RDb250ZXh0PWRlcHRoCiAgICAvLwogICAgLy8gU2V0IHRoZSB2YWx1ZSBvZiB0aGUgYGxhc3RDb250ZXh0YCBjb21waWxlciB2YWx1ZSB0byB0aGUgZGVwdGgKICAgIGdldENvbnRleHQ6IGZ1bmN0aW9uKGRlcHRoKSB7CiAgICAgIGlmKHRoaXMubGFzdENvbnRleHQgIT09IGRlcHRoKSB7CiAgICAgICAgdGhpcy5sYXN0Q29udGV4dCA9IGRlcHRoOwogICAgICB9CiAgICB9LAoKICAgIC8vIFtsb29rdXBPbkNvbnRleHRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IGN1cnJlbnRDb250ZXh0W25hbWVdLCAuLi4KICAgIC8vCiAgICAvLyBMb29rcyB1cCB0aGUgdmFsdWUgb2YgYG5hbWVgIG9uIHRoZSBjdXJyZW50IGNvbnRleHQgYW5kIHB1c2hlcwogICAgLy8gaXQgb250byB0aGUgc3RhY2suCiAgICBsb29rdXBPbkNvbnRleHQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdGhpcy5wdXNoU3RhY2sodGhpcy5uYW1lTG9va3VwKCdkZXB0aCcgKyB0aGlzLmxhc3RDb250ZXh0LCBuYW1lLCAnY29udGV4dCcpKTsKICAgIH0sCgogICAgLy8gW3B1c2hDb250ZXh0XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBjdXJyZW50Q29udGV4dCwgLi4uCiAgICAvLwogICAgLy8gUHVzaGVzIHRoZSB2YWx1ZSBvZiB0aGUgY3VycmVudCBjb250ZXh0IG9udG8gdGhlIHN0YWNrLgogICAgcHVzaENvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQpOwogICAgfSwKCiAgICAvLyBbcmVzb2x2ZVBvc3NpYmxlTGFtYmRhXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmVzb2x2ZWQgdmFsdWUsIC4uLgogICAgLy8KICAgIC8vIElmIHRoZSBgdmFsdWVgIGlzIGEgbGFtYmRhLCByZXBsYWNlIGl0IG9uIHRoZSBzdGFjayBieQogICAgLy8gdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgbGFtYmRhCiAgICByZXNvbHZlUG9zc2libGVMYW1iZGE6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5mdW5jdGlvblR5cGUgPSAnImZ1bmN0aW9uIic7CgogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcmV0dXJuICJ0eXBlb2YgIiArIGN1cnJlbnQgKyAiID09PSBmdW5jdGlvblR5cGUgPyAiICsgY3VycmVudCArICIoKSA6ICIgKyBjdXJyZW50OwogICAgICB9KTsKICAgIH0sCgogICAgLy8gW2xvb2t1cF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiB2YWx1ZSwgLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHZhbHVlW25hbWVdLCAuLi4KICAgIC8vCiAgICAvLyBSZXBsYWNlIHRoZSB2YWx1ZSBvbiB0aGUgc3RhY2sgd2l0aCB0aGUgcmVzdWx0IG9mIGxvb2tpbmcKICAgIC8vIHVwIGBuYW1lYCBvbiBgdmFsdWVgCiAgICBsb29rdXA6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdGhpcy5yZXBsYWNlU3RhY2soZnVuY3Rpb24oY3VycmVudCkgewogICAgICAgIHJldHVybiBjdXJyZW50ICsgIiA9PSBudWxsIHx8ICIgKyBjdXJyZW50ICsgIiA9PT0gZmFsc2UgPyAiICsgY3VycmVudCArICIgOiAiICsgdGhpcy5uYW1lTG9va3VwKGN1cnJlbnQsIG5hbWUsICdjb250ZXh0Jyk7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbbG9va3VwRGF0YV0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogZGF0YVtpZF0sIC4uLgogICAgLy8KICAgIC8vIFB1c2ggdGhlIHJlc3VsdCBvZiBsb29raW5nIHVwIGBpZGAgb24gdGhlIGN1cnJlbnQgZGF0YQogICAgbG9va3VwRGF0YTogZnVuY3Rpb24oaWQpIHsKICAgICAgdGhpcy5wdXNoU3RhY2sodGhpcy5uYW1lTG9va3VwKCdkYXRhJywgaWQsICdkYXRhJykpOwogICAgfSwKCiAgICAvLyBbcHVzaFN0cmluZ1BhcmFtXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBzdHJpbmcsIGN1cnJlbnRDb250ZXh0LCAuLi4KICAgIC8vCiAgICAvLyBUaGlzIG9wY29kZSBpcyBkZXNpZ25lZCBmb3IgdXNlIGluIHN0cmluZyBtb2RlLCB3aGljaAogICAgLy8gcHJvdmlkZXMgdGhlIHN0cmluZyB2YWx1ZSBvZiBhIHBhcmFtZXRlciBhbG9uZyB3aXRoIGl0cwogICAgLy8gZGVwdGggcmF0aGVyIHRoYW4gcmVzb2x2aW5nIGl0IGltbWVkaWF0ZWx5LgogICAgcHVzaFN0cmluZ1BhcmFtOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKCdkZXB0aCcgKyB0aGlzLmxhc3RDb250ZXh0KTsKICAgICAgdGhpcy5wdXNoU3RyaW5nKHN0cmluZyk7CiAgICB9LAoKICAgIC8vIFtwdXNoU3RyaW5nXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBxdW90ZWRTdHJpbmcoc3RyaW5nKSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCBhIHF1b3RlZCB2ZXJzaW9uIG9mIGBzdHJpbmdgIG9udG8gdGhlIHN0YWNrCiAgICBwdXNoU3RyaW5nOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKHRoaXMucXVvdGVkU3RyaW5nKHN0cmluZykpOwogICAgfSwKCiAgICAvLyBbcHVzaF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogZXhwciwgLi4uCiAgICAvLwogICAgLy8gUHVzaCBhbiBleHByZXNzaW9uIG9udG8gdGhlIHN0YWNrCiAgICBwdXNoOiBmdW5jdGlvbihleHByKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrKGV4cHIpOwogICAgfSwKCiAgICAvLyBbcHVzaExpdGVyYWxdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHZhbHVlLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoZXMgYSB2YWx1ZSBvbnRvIHRoZSBzdGFjay4gVGhpcyBvcGVyYXRpb24gcHJldmVudHMKICAgIC8vIHRoZSBjb21waWxlciBmcm9tIGNyZWF0aW5nIGEgdGVtcG9yYXJ5IHZhcmlhYmxlIHRvIGhvbGQKICAgIC8vIGl0LgogICAgcHVzaExpdGVyYWw6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCh2YWx1ZSk7CiAgICB9LAoKICAgIC8vIFtwdXNoUHJvZ3JhbV0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcHJvZ3JhbShndWlkKSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCBhIHByb2dyYW0gZXhwcmVzc2lvbiBvbnRvIHRoZSBzdGFjay4gVGhpcyB0YWtlcwogICAgLy8gYSBjb21waWxlLXRpbWUgZ3VpZCBhbmQgY29udmVydHMgaXQgaW50byBhIHJ1bnRpbWUtYWNjZXNzaWJsZQogICAgLy8gZXhwcmVzc2lvbi4KICAgIHB1c2hQcm9ncmFtOiBmdW5jdGlvbihndWlkKSB7CiAgICAgIGlmIChndWlkICE9IG51bGwpIHsKICAgICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwodGhpcy5wcm9ncmFtRXhwcmVzc2lvbihndWlkKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKG51bGwpOwogICAgICB9CiAgICB9LAoKICAgIC8vIFtpbnZva2VIZWxwZXJdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgcGFyYW1zLi4uLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmVzdWx0IG9mIGhlbHBlciBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gUG9wcyBvZmYgdGhlIGhlbHBlcidzIHBhcmFtZXRlcnMsIGludm9rZXMgdGhlIGhlbHBlciwKICAgIC8vIGFuZCBwdXNoZXMgdGhlIGhlbHBlcidzIHJldHVybiB2YWx1ZSBvbnRvIHRoZSBzdGFjay4KICAgIC8vCiAgICAvLyBJZiB0aGUgaGVscGVyIGlzIG5vdCBmb3VuZCwgYGhlbHBlck1pc3NpbmdgIGlzIGNhbGxlZC4KICAgIGludm9rZUhlbHBlcjogZnVuY3Rpb24ocGFyYW1TaXplLCBuYW1lKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmhlbHBlck1pc3NpbmcgPSAnaGVscGVycy5oZWxwZXJNaXNzaW5nJzsKCiAgICAgIHZhciBoZWxwZXIgPSB0aGlzLmxhc3RIZWxwZXIgPSB0aGlzLnNldHVwSGVscGVyKHBhcmFtU2l6ZSwgbmFtZSk7CiAgICAgIHRoaXMucmVnaXN0ZXIoJ2ZvdW5kSGVscGVyJywgaGVscGVyLm5hbWUpOwoKICAgICAgdGhpcy5wdXNoU3RhY2soImZvdW5kSGVscGVyID8gZm91bmRIZWxwZXIuY2FsbCgiICsKICAgICAgICBoZWxwZXIuY2FsbFBhcmFtcyArICIpICIgKyAiOiBoZWxwZXJNaXNzaW5nLmNhbGwoIiArCiAgICAgICAgaGVscGVyLmhlbHBlck1pc3NpbmdQYXJhbXMgKyAiKSIpOwogICAgfSwKCiAgICAvLyBbaW52b2tlS25vd25IZWxwZXJdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgcGFyYW1zLi4uLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmVzdWx0IG9mIGhlbHBlciBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gaXMgdXNlZCB3aGVuIHRoZSBoZWxwZXIgaXMga25vd24gdG8gZXhpc3QsCiAgICAvLyBzbyBhIGBoZWxwZXJNaXNzaW5nYCBmYWxsYmFjayBpcyBub3QgcmVxdWlyZWQuCiAgICBpbnZva2VLbm93bkhlbHBlcjogZnVuY3Rpb24ocGFyYW1TaXplLCBuYW1lKSB7CiAgICAgIHZhciBoZWxwZXIgPSB0aGlzLnNldHVwSGVscGVyKHBhcmFtU2l6ZSwgbmFtZSk7CiAgICAgIHRoaXMucHVzaFN0YWNrKGhlbHBlci5uYW1lICsgIi5jYWxsKCIgKyBoZWxwZXIuY2FsbFBhcmFtcyArICIpIik7CiAgICB9LAoKICAgIC8vIFtpbnZva2VBbWJpZ3VvdXNdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgcGFyYW1zLi4uLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmVzdWx0IG9mIGRpc2FtYmlndWF0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gaXMgdXNlZCB3aGVuIGFuIGV4cHJlc3Npb24gbGlrZSBge3tmb299fWAKICAgIC8vIGlzIHByb3ZpZGVkLCBidXQgd2UgZG9uJ3Qga25vdyBhdCBjb21waWxlLXRpbWUgd2hldGhlciBpdAogICAgLy8gaXMgYSBoZWxwZXIgb3IgYSBwYXRoLgogICAgLy8KICAgIC8vIFRoaXMgb3BlcmF0aW9uIGVtaXRzIG1vcmUgY29kZSB0aGFuIHRoZSBvdGhlciBvcHRpb25zLAogICAgLy8gYW5kIGNhbiBiZSBhdm9pZGVkIGJ5IHBhc3NpbmcgdGhlIGBrbm93bkhlbHBlcnNgIGFuZAogICAgLy8gYGtub3duSGVscGVyc09ubHlgIGZsYWdzIGF0IGNvbXBpbGUtdGltZS4KICAgIGludm9rZUFtYmlndW91czogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5mdW5jdGlvblR5cGUgPSAnImZ1bmN0aW9uIic7CgogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ3t9Jyk7CiAgICAgIHZhciBoZWxwZXIgPSB0aGlzLnNldHVwSGVscGVyKDAsIG5hbWUpOwoKICAgICAgdmFyIGhlbHBlck5hbWUgPSB0aGlzLmxhc3RIZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2hlbHBlcnMnLCBuYW1lLCAnaGVscGVyJyk7CiAgICAgIHRoaXMucmVnaXN0ZXIoJ2ZvdW5kSGVscGVyJywgaGVscGVyTmFtZSk7CgogICAgICB2YXIgbm9uSGVscGVyID0gdGhpcy5uYW1lTG9va3VwKCdkZXB0aCcgKyB0aGlzLmxhc3RDb250ZXh0LCBuYW1lLCAnY29udGV4dCcpOwogICAgICB2YXIgbmV4dFN0YWNrID0gdGhpcy5uZXh0U3RhY2soKTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2goJ2lmIChmb3VuZEhlbHBlcikgeyAnICsgbmV4dFN0YWNrICsgJyA9IGZvdW5kSGVscGVyLmNhbGwoJyArIGhlbHBlci5jYWxsUGFyYW1zICsgJyk7IH0nKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaCgnZWxzZSB7ICcgKyBuZXh0U3RhY2sgKyAnID0gJyArIG5vbkhlbHBlciArICc7ICcgKyBuZXh0U3RhY2sgKyAnID0gdHlwZW9mICcgKyBuZXh0U3RhY2sgKyAnID09PSBmdW5jdGlvblR5cGUgPyAnICsgbmV4dFN0YWNrICsgJygpIDogJyArIG5leHRTdGFjayArICc7IH0nKTsKICAgIH0sCgogICAgLy8gW2ludm9rZVBhcnRpYWxdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogY29udGV4dCwgLi4uCiAgICAvLyBPbiBzdGFjayBhZnRlcjogcmVzdWx0IG9mIHBhcnRpYWwgaW52b2NhdGlvbgogICAgLy8KICAgIC8vIFRoaXMgb3BlcmF0aW9uIHBvcHMgb2ZmIGEgY29udGV4dCwgaW52b2tlcyBhIHBhcnRpYWwgd2l0aCB0aGF0IGNvbnRleHQsCiAgICAvLyBhbmQgcHVzaGVzIHRoZSByZXN1bHQgb2YgdGhlIGludm9jYXRpb24gYmFjay4KICAgIGludm9rZVBhcnRpYWw6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdmFyIHBhcmFtcyA9IFt0aGlzLm5hbWVMb29rdXAoJ3BhcnRpYWxzJywgbmFtZSwgJ3BhcnRpYWwnKSwgIiciICsgbmFtZSArICInIiwgdGhpcy5wb3BTdGFjaygpLCAiaGVscGVycyIsICJwYXJ0aWFscyJdOwoKICAgICAgaWYgKHRoaXMub3B0aW9ucy5kYXRhKSB7CiAgICAgICAgcGFyYW1zLnB1c2goImRhdGEiKTsKICAgICAgfQoKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKICAgICAgdGhpcy5wdXNoU3RhY2soInNlbGYuaW52b2tlUGFydGlhbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKTsiKTsKICAgIH0sCgogICAgLy8gW2Fzc2lnblRvSGFzaF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiB2YWx1ZSwgaGFzaCwgLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IGhhc2gsIC4uLgogICAgLy8KICAgIC8vIFBvcHMgYSB2YWx1ZSBhbmQgaGFzaCBvZmYgdGhlIHN0YWNrLCBhc3NpZ25zIGBoYXNoW2tleV0gPSB2YWx1ZWAKICAgIC8vIGFuZCBwdXNoZXMgdGhlIGhhc2ggYmFjayBvbnRvIHRoZSBzdGFjay4KICAgIGFzc2lnblRvSGFzaDogZnVuY3Rpb24oa2V5KSB7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgdmFyIGhhc2ggPSB0aGlzLnRvcFN0YWNrKCk7CgogICAgICB0aGlzLnNvdXJjZS5wdXNoKGhhc2ggKyAiWyciICsga2V5ICsgIiddID0gIiArIHZhbHVlICsgIjsiKTsKICAgIH0sCgogICAgLy8gSEVMUEVSUwoKICAgIGNvbXBpbGVyOiBKYXZhU2NyaXB0Q29tcGlsZXIsCgogICAgY29tcGlsZUNoaWxkcmVuOiBmdW5jdGlvbihlbnZpcm9ubWVudCwgb3B0aW9ucykgewogICAgICB2YXIgY2hpbGRyZW4gPSBlbnZpcm9ubWVudC5jaGlsZHJlbiwgY2hpbGQsIGNvbXBpbGVyOwoKICAgICAgZm9yKHZhciBpPTAsIGw9Y2hpbGRyZW4ubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgY29tcGlsZXIgPSBuZXcgdGhpcy5jb21waWxlcigpOwoKICAgICAgICB0aGlzLmNvbnRleHQucHJvZ3JhbXMucHVzaCgnJyk7ICAgICAvLyBQbGFjZWhvbGRlciB0byBwcmV2ZW50IG5hbWUgY29uZmxpY3RzIGZvciBuZXN0ZWQgY2hpbGRyZW4KICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmNvbnRleHQucHJvZ3JhbXMubGVuZ3RoOwogICAgICAgIGNoaWxkLmluZGV4ID0gaW5kZXg7CiAgICAgICAgY2hpbGQubmFtZSA9ICdwcm9ncmFtJyArIGluZGV4OwogICAgICAgIHRoaXMuY29udGV4dC5wcm9ncmFtc1tpbmRleF0gPSBjb21waWxlci5jb21waWxlKGNoaWxkLCBvcHRpb25zLCB0aGlzLmNvbnRleHQpOwogICAgICB9CiAgICB9LAoKICAgIHByb2dyYW1FeHByZXNzaW9uOiBmdW5jdGlvbihndWlkKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CgogICAgICBpZihndWlkID09IG51bGwpIHsKICAgICAgICByZXR1cm4gInNlbGYubm9vcCI7CiAgICAgIH0KCiAgICAgIHZhciBjaGlsZCA9IHRoaXMuZW52aXJvbm1lbnQuY2hpbGRyZW5bZ3VpZF0sCiAgICAgICAgICBkZXB0aHMgPSBjaGlsZC5kZXB0aHMubGlzdCwgZGVwdGg7CgogICAgICB2YXIgcHJvZ3JhbVBhcmFtcyA9IFtjaGlsZC5pbmRleCwgY2hpbGQubmFtZSwgImRhdGEiXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsID0gZGVwdGhzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBkZXB0aCA9IGRlcHRoc1tpXTsKCiAgICAgICAgaWYoZGVwdGggPT09IDEpIHsgcHJvZ3JhbVBhcmFtcy5wdXNoKCJkZXB0aDAiKTsgfQogICAgICAgIGVsc2UgeyBwcm9ncmFtUGFyYW1zLnB1c2goImRlcHRoIiArIChkZXB0aCAtIDEpKTsgfQogICAgICB9CgogICAgICBpZihkZXB0aHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuICJzZWxmLnByb2dyYW0oIiArIHByb2dyYW1QYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9ncmFtUGFyYW1zLnNoaWZ0KCk7CiAgICAgICAgcmV0dXJuICJzZWxmLnByb2dyYW1XaXRoRGVwdGgoIiArIHByb2dyYW1QYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfQogICAgfSwKCiAgICByZWdpc3RlcjogZnVuY3Rpb24obmFtZSwgdmFsKSB7CiAgICAgIHRoaXMudXNlUmVnaXN0ZXIobmFtZSk7CiAgICAgIHRoaXMuc291cmNlLnB1c2gobmFtZSArICIgPSAiICsgdmFsICsgIjsiKTsKICAgIH0sCgogICAgdXNlUmVnaXN0ZXI6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgaWYoIXRoaXMucmVnaXN0ZXJzW25hbWVdKSB7CiAgICAgICAgdGhpcy5yZWdpc3RlcnNbbmFtZV0gPSB0cnVlOwogICAgICAgIHRoaXMucmVnaXN0ZXJzLmxpc3QucHVzaChuYW1lKTsKICAgICAgfQogICAgfSwKCiAgICBwdXNoU3RhY2tMaXRlcmFsOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHRoaXMuY29tcGlsZVN0YWNrLnB1c2gobmV3IExpdGVyYWwoaXRlbSkpOwogICAgICByZXR1cm4gaXRlbTsKICAgIH0sCgogICAgcHVzaFN0YWNrOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHRoaXMuc291cmNlLnB1c2godGhpcy5pbmNyU3RhY2soKSArICIgPSAiICsgaXRlbSArICI7Iik7CiAgICAgIHRoaXMuY29tcGlsZVN0YWNrLnB1c2goInN0YWNrIiArIHRoaXMuc3RhY2tTbG90KTsKICAgICAgcmV0dXJuICJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdDsKICAgIH0sCgogICAgcmVwbGFjZVN0YWNrOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICB2YXIgaXRlbSA9IGNhbGxiYWNrLmNhbGwodGhpcywgdGhpcy50b3BTdGFjaygpKTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2godGhpcy50b3BTdGFjaygpICsgIiA9ICIgKyBpdGVtICsgIjsiKTsKICAgICAgcmV0dXJuICJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdDsKICAgIH0sCgogICAgbmV4dFN0YWNrOiBmdW5jdGlvbihza2lwQ29tcGlsZVN0YWNrKSB7CiAgICAgIHZhciBuYW1lID0gdGhpcy5pbmNyU3RhY2soKTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaCgic3RhY2siICsgdGhpcy5zdGFja1Nsb3QpOwogICAgICByZXR1cm4gbmFtZTsKICAgIH0sCgogICAgaW5jclN0YWNrOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5zdGFja1Nsb3QrKzsKICAgICAgaWYodGhpcy5zdGFja1Nsb3QgPiB0aGlzLnN0YWNrVmFycy5sZW5ndGgpIHsgdGhpcy5zdGFja1ZhcnMucHVzaCgic3RhY2siICsgdGhpcy5zdGFja1Nsb3QpOyB9CiAgICAgIHJldHVybiAic3RhY2siICsgdGhpcy5zdGFja1Nsb3Q7CiAgICB9LAoKICAgIHBvcFN0YWNrOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGl0ZW0gPSB0aGlzLmNvbXBpbGVTdGFjay5wb3AoKTsKCiAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgTGl0ZXJhbCkgewogICAgICAgIHJldHVybiBpdGVtLnZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhY2tTbG90LS07CiAgICAgICAgcmV0dXJuIGl0ZW07CiAgICAgIH0KICAgIH0sCgogICAgdG9wU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbSA9IHRoaXMuY29tcGlsZVN0YWNrW3RoaXMuY29tcGlsZVN0YWNrLmxlbmd0aCAtIDFdOwoKICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBMaXRlcmFsKSB7CiAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGl0ZW07CiAgICAgIH0KICAgIH0sCgogICAgcXVvdGVkU3RyaW5nOiBmdW5jdGlvbihzdHIpIHsKICAgICAgcmV0dXJuICciJyArIHN0cgogICAgICAgIC5yZXBsYWNlKC9cXC9nLCAnXFxcXCcpCiAgICAgICAgLnJlcGxhY2UoLyIvZywgJ1xcIicpCiAgICAgICAgLnJlcGxhY2UoL1xuL2csICdcXG4nKQogICAgICAgIC5yZXBsYWNlKC9cci9nLCAnXFxyJykgKyAnIic7CiAgICB9LAoKICAgIHNldHVwSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdmFyIHBhcmFtcyA9IFtdOwogICAgICB0aGlzLnNldHVwUGFyYW1zKHBhcmFtU2l6ZSwgcGFyYW1zKTsKICAgICAgdmFyIGZvdW5kSGVscGVyID0gdGhpcy5uYW1lTG9va3VwKCdoZWxwZXJzJywgbmFtZSwgJ2hlbHBlcicpOwoKICAgICAgcmV0dXJuIHsKICAgICAgICBwYXJhbXM6IHBhcmFtcywKICAgICAgICBuYW1lOiBmb3VuZEhlbHBlciwKICAgICAgICBjYWxsUGFyYW1zOiBbImRlcHRoMCJdLmNvbmNhdChwYXJhbXMpLmpvaW4oIiwgIiksCiAgICAgICAgaGVscGVyTWlzc2luZ1BhcmFtczogWyJkZXB0aDAiLCB0aGlzLnF1b3RlZFN0cmluZyhuYW1lKV0uY29uY2F0KHBhcmFtcykuam9pbigiLCAiKQogICAgICB9OwogICAgfSwKCiAgICAvLyB0aGUgcGFyYW1zIGFuZCBjb250ZXh0cyBhcmd1bWVudHMgYXJlIHBhc3NlZCBpbiBhcnJheXMKICAgIC8vIHRvIGZpbGwgaW4KICAgIHNldHVwUGFyYW1zOiBmdW5jdGlvbihwYXJhbVNpemUsIHBhcmFtcykgewogICAgICB2YXIgb3B0aW9ucyA9IFtdLCBjb250ZXh0cyA9IFtdLCBwYXJhbSwgaW52ZXJzZSwgcHJvZ3JhbTsKCiAgICAgIG9wdGlvbnMucHVzaCgiaGFzaDoiICsgdGhpcy5wb3BTdGFjaygpKTsKCiAgICAgIGludmVyc2UgPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgIHByb2dyYW0gPSB0aGlzLnBvcFN0YWNrKCk7CgogICAgICAvLyBBdm9pZCBzZXR0aW5nIGZuIGFuZCBpbnZlcnNlIGlmIG5laXRoZXIgYXJlIHNldC4gVGhpcyBhbGxvd3MKICAgICAgLy8gaGVscGVycyB0byBkbyBhIGNoZWNrIGZvciBgaWYgKG9wdGlvbnMuZm4pYAogICAgICBpZiAocHJvZ3JhbSB8fCBpbnZlcnNlKSB7CiAgICAgICAgaWYgKCFwcm9ncmFtKSB7CiAgICAgICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5zZWxmID0gInRoaXMiOwogICAgICAgICAgcHJvZ3JhbSA9ICJzZWxmLm5vb3AiOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpbnZlcnNlKSB7CiAgICAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CiAgICAgICAgICBpbnZlcnNlID0gInNlbGYubm9vcCI7CiAgICAgICAgfQoKICAgICAgICBvcHRpb25zLnB1c2goImludmVyc2U6IiArIGludmVyc2UpOwogICAgICAgIG9wdGlvbnMucHVzaCgiZm46IiArIHByb2dyYW0pOwogICAgICB9CgogICAgICBmb3IodmFyIGk9MDsgaTxwYXJhbVNpemU7IGkrKykgewogICAgICAgIHBhcmFtID0gdGhpcy5wb3BTdGFjaygpOwogICAgICAgIHBhcmFtcy5wdXNoKHBhcmFtKTsKCiAgICAgICAgaWYodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgICAgY29udGV4dHMucHVzaCh0aGlzLnBvcFN0YWNrKCkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMub3B0aW9ucy5zdHJpbmdQYXJhbXMpIHsKICAgICAgICBvcHRpb25zLnB1c2goImNvbnRleHRzOlsiICsgY29udGV4dHMuam9pbigiLCIpICsgIl0iKTsKICAgICAgfQoKICAgICAgaWYodGhpcy5vcHRpb25zLmRhdGEpIHsKICAgICAgICBvcHRpb25zLnB1c2goImRhdGE6ZGF0YSIpOwogICAgICB9CgogICAgICBwYXJhbXMucHVzaCgieyIgKyBvcHRpb25zLmpvaW4oIiwiKSArICJ9Iik7CiAgICAgIHJldHVybiBwYXJhbXMuam9pbigiLCAiKTsKICAgIH0KICB9OwoKICB2YXIgcmVzZXJ2ZWRXb3JkcyA9ICgKICAgICJicmVhayBlbHNlIG5ldyB2YXIiICsKICAgICIgY2FzZSBmaW5hbGx5IHJldHVybiB2b2lkIiArCiAgICAiIGNhdGNoIGZvciBzd2l0Y2ggd2hpbGUiICsKICAgICIgY29udGludWUgZnVuY3Rpb24gdGhpcyB3aXRoIiArCiAgICAiIGRlZmF1bHQgaWYgdGhyb3ciICsKICAgICIgZGVsZXRlIGluIHRyeSIgKwogICAgIiBkbyBpbnN0YW5jZW9mIHR5cGVvZiIgKwogICAgIiBhYnN0cmFjdCBlbnVtIGludCBzaG9ydCIgKwogICAgIiBib29sZWFuIGV4cG9ydCBpbnRlcmZhY2Ugc3RhdGljIiArCiAgICAiIGJ5dGUgZXh0ZW5kcyBsb25nIHN1cGVyIiArCiAgICAiIGNoYXIgZmluYWwgbmF0aXZlIHN5bmNocm9uaXplZCIgKwogICAgIiBjbGFzcyBmbG9hdCBwYWNrYWdlIHRocm93cyIgKwogICAgIiBjb25zdCBnb3RvIHByaXZhdGUgdHJhbnNpZW50IiArCiAgICAiIGRlYnVnZ2VyIGltcGxlbWVudHMgcHJvdGVjdGVkIHZvbGF0aWxlIiArCiAgICAiIGRvdWJsZSBpbXBvcnQgcHVibGljIGxldCB5aWVsZCIKICApLnNwbGl0KCIgIik7CgogIHZhciBjb21waWxlcldvcmRzID0gSmF2YVNjcmlwdENvbXBpbGVyLlJFU0VSVkVEX1dPUkRTID0ge307CgogIGZvcih2YXIgaT0wLCBsPXJlc2VydmVkV29yZHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgY29tcGlsZXJXb3Jkc1tyZXNlcnZlZFdvcmRzW2ldXSA9IHRydWU7CiAgfQoKICBKYXZhU2NyaXB0Q29tcGlsZXIuaXNWYWxpZEphdmFTY3JpcHRWYXJpYWJsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICBpZighSmF2YVNjcmlwdENvbXBpbGVyLlJFU0VSVkVEX1dPUkRTW25hbWVdICYmIC9eW2EtekEtWl8kXVswLTlhLXpBLVpfJF0rJC8udGVzdChuYW1lKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9OwoKfSkoSGFuZGxlYmFycy5Db21waWxlciwgSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIpOwoKSGFuZGxlYmFycy5wcmVjb21waWxlID0gZnVuY3Rpb24oc3RyaW5nLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgaWYgKCEoJ2RhdGEnIGluIG9wdGlvbnMpKSB7CiAgICBvcHRpb25zLmRhdGEgPSB0cnVlOwogIH0KICB2YXIgYXN0ID0gSGFuZGxlYmFycy5wYXJzZShzdHJpbmcpOwogIHZhciBlbnZpcm9ubWVudCA9IG5ldyBIYW5kbGViYXJzLkNvbXBpbGVyKCkuY29tcGlsZShhc3QsIG9wdGlvbnMpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIoKS5jb21waWxlKGVudmlyb25tZW50LCBvcHRpb25zKTsKfTsKCkhhbmRsZWJhcnMuY29tcGlsZSA9IGZ1bmN0aW9uKHN0cmluZywgb3B0aW9ucykgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIGlmICghKCdkYXRhJyBpbiBvcHRpb25zKSkgewogICAgb3B0aW9ucy5kYXRhID0gdHJ1ZTsKICB9CiAgdmFyIGNvbXBpbGVkOwogIGZ1bmN0aW9uIGNvbXBpbGUoKSB7CiAgICB2YXIgYXN0ID0gSGFuZGxlYmFycy5wYXJzZShzdHJpbmcpOwogICAgdmFyIGVudmlyb25tZW50ID0gbmV3IEhhbmRsZWJhcnMuQ29tcGlsZXIoKS5jb21waWxlKGFzdCwgb3B0aW9ucyk7CiAgICB2YXIgdGVtcGxhdGVTcGVjID0gbmV3IEhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyKCkuY29tcGlsZShlbnZpcm9ubWVudCwgb3B0aW9ucywgdW5kZWZpbmVkLCB0cnVlKTsKICAgIHJldHVybiBIYW5kbGViYXJzLnRlbXBsYXRlKHRlbXBsYXRlU3BlYyk7CiAgfQoKICAvLyBUZW1wbGF0ZSBpcyBvbmx5IGNvbXBpbGVkIG9uIGZpcnN0IHVzZSBhbmQgY2FjaGVkIGFmdGVyIHRoYXQgcG9pbnQuCiAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgIGlmICghY29tcGlsZWQpIHsKICAgICAgY29tcGlsZWQgPSBjb21waWxlKCk7CiAgICB9CiAgICByZXR1cm4gY29tcGlsZWQuY2FsbCh0aGlzLCBjb250ZXh0LCBvcHRpb25zKTsKICB9Owp9Owo7Ci8vIGxpYi9oYW5kbGViYXJzL3J1bnRpbWUuanMKSGFuZGxlYmFycy5WTSA9IHsKICB0ZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGVTcGVjKSB7CiAgICAvLyBKdXN0IGFkZCB3YXRlcgogICAgdmFyIGNvbnRhaW5lciA9IHsKICAgICAgZXNjYXBlRXhwcmVzc2lvbjogSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uLAogICAgICBpbnZva2VQYXJ0aWFsOiBIYW5kbGViYXJzLlZNLmludm9rZVBhcnRpYWwsCiAgICAgIHByb2dyYW1zOiBbXSwKICAgICAgcHJvZ3JhbTogZnVuY3Rpb24oaSwgZm4sIGRhdGEpIHsKICAgICAgICB2YXIgcHJvZ3JhbVdyYXBwZXIgPSB0aGlzLnByb2dyYW1zW2ldOwogICAgICAgIGlmKGRhdGEpIHsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gSGFuZGxlYmFycy5WTS5wcm9ncmFtKGZuLCBkYXRhKTsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyLnByb2dyYW0gPSBpOwogICAgICAgIH0gZWxzZSBpZiAoIXByb2dyYW1XcmFwcGVyKSB7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV0gPSBIYW5kbGViYXJzLlZNLnByb2dyYW0oZm4pOwogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIucHJvZ3JhbSA9IGk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9ncmFtV3JhcHBlcjsKICAgICAgfSwKICAgICAgcHJvZ3JhbVdpdGhEZXB0aDogSGFuZGxlYmFycy5WTS5wcm9ncmFtV2l0aERlcHRoLAogICAgICBub29wOiBIYW5kbGViYXJzLlZNLm5vb3AKICAgIH07CgogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHJldHVybiB0ZW1wbGF0ZVNwZWMuY2FsbChjb250YWluZXIsIEhhbmRsZWJhcnMsIGNvbnRleHQsIG9wdGlvbnMuaGVscGVycywgb3B0aW9ucy5wYXJ0aWFscywgb3B0aW9ucy5kYXRhKTsKICAgIH07CiAgfSwKCiAgcHJvZ3JhbVdpdGhEZXB0aDogZnVuY3Rpb24oZm4sIGRhdGEsICRkZXB0aCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoKICAgIHJldHVybiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIFtjb250ZXh0LCBvcHRpb25zLmRhdGEgfHwgZGF0YV0uY29uY2F0KGFyZ3MpKTsKICAgIH07CiAgfSwKICBwcm9ncmFtOiBmdW5jdGlvbihmbiwgZGF0YSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4oY29udGV4dCwgb3B0aW9ucy5kYXRhIHx8IGRhdGEpOwogICAgfTsKICB9LAogIG5vb3A6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIiI7IH0sCiAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24ocGFydGlhbCwgbmFtZSwgY29udGV4dCwgaGVscGVycywgcGFydGlhbHMsIGRhdGEpIHsKICAgIHZhciBvcHRpb25zID0geyBoZWxwZXJzOiBoZWxwZXJzLCBwYXJ0aWFsczogcGFydGlhbHMsIGRhdGE6IGRhdGEgfTsKCiAgICBpZihwYXJ0aWFsID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhyb3cgbmV3IEhhbmRsZWJhcnMuRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGZvdW5kIik7CiAgICB9IGVsc2UgaWYocGFydGlhbCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7CiAgICAgIHJldHVybiBwYXJ0aWFsKGNvbnRleHQsIG9wdGlvbnMpOwogICAgfSBlbHNlIGlmICghSGFuZGxlYmFycy5jb21waWxlKSB7CiAgICAgIHRocm93IG5ldyBIYW5kbGViYXJzLkV4Y2VwdGlvbigiVGhlIHBhcnRpYWwgIiArIG5hbWUgKyAiIGNvdWxkIG5vdCBiZSBjb21waWxlZCB3aGVuIHJ1bm5pbmcgaW4gcnVudGltZS1vbmx5IG1vZGUiKTsKICAgIH0gZWxzZSB7CiAgICAgIHBhcnRpYWxzW25hbWVdID0gSGFuZGxlYmFycy5jb21waWxlKHBhcnRpYWwsIHtkYXRhOiBkYXRhICE9PSB1bmRlZmluZWR9KTsKICAgICAgcmV0dXJuIHBhcnRpYWxzW25hbWVdKGNvbnRleHQsIG9wdGlvbnMpOwogICAgfQogIH0KfTsKCkhhbmRsZWJhcnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLnRlbXBsYXRlOwo7CgovLyAgICAgVW5kZXJzY29yZS5qcyAxLjQuMgovLyAgICAgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcKLy8gICAgIChjKSAyMDA5LTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIFVuZGVyc2NvcmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgooZnVuY3Rpb24oKSB7CgogIC8vIEJhc2VsaW5lIHNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gRXN0YWJsaXNoIHRoZSByb290IG9iamVjdCwgYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIG9yIGBnbG9iYWxgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgogIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgogIC8vIEVzdGFibGlzaCB0aGUgb2JqZWN0IHRoYXQgZ2V0cyByZXR1cm5lZCB0byBicmVhayBvdXQgb2YgYSBsb29wIGl0ZXJhdGlvbi4KICB2YXIgYnJlYWtlciA9IHt9OwoKICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLCBPYmpQcm90byA9IE9iamVjdC5wcm90b3R5cGUsIEZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKCiAgLy8gQ3JlYXRlIHF1aWNrIHJlZmVyZW5jZSB2YXJpYWJsZXMgZm9yIHNwZWVkIGFjY2VzcyB0byBjb3JlIHByb3RvdHlwZXMuCiAgdmFyIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCiAgICAgIHNsaWNlICAgICAgICAgICAgPSBBcnJheVByb3RvLnNsaWNlLAogICAgICBjb25jYXQgICAgICAgICAgID0gQXJyYXlQcm90by5jb25jYXQsCiAgICAgIHVuc2hpZnQgICAgICAgICAgPSBBcnJheVByb3RvLnVuc2hpZnQsCiAgICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKICAgICAgaGFzT3duUHJvcGVydHkgICA9IE9ialByb3RvLmhhc093blByb3BlcnR5OwoKICAvLyBBbGwgKipFQ01BU2NyaXB0IDUqKiBuYXRpdmUgZnVuY3Rpb24gaW1wbGVtZW50YXRpb25zIHRoYXQgd2UgaG9wZSB0byB1c2UKICAvLyBhcmUgZGVjbGFyZWQgaGVyZS4KICB2YXIKICAgIG5hdGl2ZUZvckVhY2ggICAgICA9IEFycmF5UHJvdG8uZm9yRWFjaCwKICAgIG5hdGl2ZU1hcCAgICAgICAgICA9IEFycmF5UHJvdG8ubWFwLAogICAgbmF0aXZlUmVkdWNlICAgICAgID0gQXJyYXlQcm90by5yZWR1Y2UsCiAgICBuYXRpdmVSZWR1Y2VSaWdodCAgPSBBcnJheVByb3RvLnJlZHVjZVJpZ2h0LAogICAgbmF0aXZlRmlsdGVyICAgICAgID0gQXJyYXlQcm90by5maWx0ZXIsCiAgICBuYXRpdmVFdmVyeSAgICAgICAgPSBBcnJheVByb3RvLmV2ZXJ5LAogICAgbmF0aXZlU29tZSAgICAgICAgID0gQXJyYXlQcm90by5zb21lLAogICAgbmF0aXZlSW5kZXhPZiAgICAgID0gQXJyYXlQcm90by5pbmRleE9mLAogICAgbmF0aXZlTGFzdEluZGV4T2YgID0gQXJyYXlQcm90by5sYXN0SW5kZXhPZiwKICAgIG5hdGl2ZUlzQXJyYXkgICAgICA9IEFycmF5LmlzQXJyYXksCiAgICBuYXRpdmVLZXlzICAgICAgICAgPSBPYmplY3Qua2V5cywKICAgIG5hdGl2ZUJpbmQgICAgICAgICA9IEZ1bmNQcm90by5iaW5kOwoKICAvLyBDcmVhdGUgYSBzYWZlIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yIHVzZSBiZWxvdy4KICB2YXIgXyA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIF8pIHJldHVybiBvYmo7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpIHJldHVybiBuZXcgXyhvYmopOwogICAgdGhpcy5fd3JhcHBlZCA9IG9iajsKICB9OwoKICAvLyBFeHBvcnQgdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciAqKk5vZGUuanMqKiwgd2l0aAogIC8vIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IGZvciB0aGUgb2xkIGByZXF1aXJlKClgIEFQSS4gSWYgd2UncmUgaW4KICAvLyB0aGUgYnJvd3NlciwgYWRkIGBfYCBhcyBhIGdsb2JhbCBvYmplY3QgdmlhIGEgc3RyaW5nIGlkZW50aWZpZXIsCiAgLy8gZm9yIENsb3N1cmUgQ29tcGlsZXIgImFkdmFuY2VkIiBtb2RlLgogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBfOwogICAgfQogICAgZXhwb3J0cy5fID0gXzsKICB9IGVsc2UgewogICAgcm9vdFsnXyddID0gXzsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbi4KICBfLlZFUlNJT04gPSAnMS40LjInOwoKICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFRoZSBjb3JuZXJzdG9uZSwgYW4gYGVhY2hgIGltcGxlbWVudGF0aW9uLCBha2EgYGZvckVhY2hgLgogIC8vIEhhbmRsZXMgb2JqZWN0cyB3aXRoIHRoZSBidWlsdC1pbiBgZm9yRWFjaGAsIGFycmF5cywgYW5kIHJhdyBvYmplY3RzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmb3JFYWNoYCBpZiBhdmFpbGFibGUuCiAgdmFyIGVhY2ggPSBfLmVhY2ggPSBfLmZvckVhY2ggPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybjsKICAgIGlmIChuYXRpdmVGb3JFYWNoICYmIG9iai5mb3JFYWNoID09PSBuYXRpdmVGb3JFYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvYmoubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICBpZiAoXy5oYXMob2JqLCBrZXkpKSB7CiAgICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSByZXN1bHRzIG9mIGFwcGx5aW5nIHRoZSBpdGVyYXRvciB0byBlYWNoIGVsZW1lbnQuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYG1hcGAgaWYgYXZhaWxhYmxlLgogIF8ubWFwID0gXy5jb2xsZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlTWFwICYmIG9iai5tYXAgPT09IG5hdGl2ZU1hcCkgcmV0dXJuIG9iai5tYXAoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXN1bHRzW3Jlc3VsdHMubGVuZ3RoXSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gKipSZWR1Y2UqKiBidWlsZHMgdXAgYSBzaW5nbGUgcmVzdWx0IGZyb20gYSBsaXN0IG9mIHZhbHVlcywgYWthIGBpbmplY3RgLAogIC8vIG9yIGBmb2xkbGAuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZSA9IF8uZm9sZGwgPSBfLmluamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZSAmJiBvYmoucmVkdWNlID09PSBuYXRpdmVSZWR1Y2UpIHsKICAgICAgaWYgKGNvbnRleHQpIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlKGl0ZXJhdG9yLCBtZW1vKSA6IG9iai5yZWR1Y2UoaXRlcmF0b3IpOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gdmFsdWU7CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpIHRocm93IG5ldyBUeXBlRXJyb3IoJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnKTsKICAgIHJldHVybiBtZW1vOwogIH07CgogIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VSaWdodGAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlUmlnaHQgPSBfLmZvbGRyID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlUmlnaHQgJiYgb2JqLnJlZHVjZVJpZ2h0ID09PSBuYXRpdmVSZWR1Y2VSaWdodCkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yKTsKICAgIH0KICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgaWYgKGxlbmd0aCAhPT0gK2xlbmd0aCkgewogICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgICBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaW5kZXggPSBrZXlzID8ga2V5c1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IG9ialtpbmRleF07CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgb2JqW2luZGV4XSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcignUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZScpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBmaXJzdCB2YWx1ZSB3aGljaCBwYXNzZXMgYSB0cnV0aCB0ZXN0LiBBbGlhc2VkIGFzIGBkZXRlY3RgLgogIF8uZmluZCA9IF8uZGV0ZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdDsKICAgIGFueShvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyB0aGF0IHBhc3MgYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmaWx0ZXJgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBzZWxlY3RgLgogIF8uZmlsdGVyID0gXy5zZWxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVGaWx0ZXIgJiYgb2JqLmZpbHRlciA9PT0gbmF0aXZlRmlsdGVyKSByZXR1cm4gb2JqLmZpbHRlcihpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGZvciB3aGljaCBhIHRydXRoIHRlc3QgZmFpbHMuCiAgXy5yZWplY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCFpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIERldGVybWluZSB3aGV0aGVyIGFsbCBvZiB0aGUgZWxlbWVudHMgbWF0Y2ggYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBldmVyeWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFsbGAuCiAgXy5ldmVyeSA9IF8uYWxsID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChuYXRpdmVFdmVyeSAmJiBvYmouZXZlcnkgPT09IG5hdGl2ZUV2ZXJ5KSByZXR1cm4gb2JqLmV2ZXJ5KGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCEocmVzdWx0ID0gcmVzdWx0ICYmIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIGF0IGxlYXN0IG9uZSBlbGVtZW50IGluIHRoZSBvYmplY3QgbWF0Y2hlcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHNvbWVgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBhbnlgLgogIHZhciBhbnkgPSBfLnNvbWUgPSBfLmFueSA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yIHx8IChpdGVyYXRvciA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZVNvbWUgJiYgb2JqLnNvbWUgPT09IG5hdGl2ZVNvbWUpIHJldHVybiBvYmouc29tZShpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChyZXN1bHQgfHwgKHJlc3VsdCA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgogIC8vIEFsaWFzZWQgYXMgYGluY2x1ZGVgLgogIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbihvYmosIHRhcmdldCkgewogICAgdmFyIGZvdW5kID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiBmb3VuZDsKICAgIGlmIChuYXRpdmVJbmRleE9mICYmIG9iai5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKSByZXR1cm4gb2JqLmluZGV4T2YodGFyZ2V0KSAhPSAtMTsKICAgIGZvdW5kID0gYW55KG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0YXJnZXQ7CiAgICB9KTsKICAgIHJldHVybiBmb3VuZDsKICB9OwoKICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KICBfLmludm9rZSA9IGZ1bmN0aW9uKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiAoXy5pc0Z1bmN0aW9uKG1ldGhvZCkgPyBtZXRob2QgOiB2YWx1ZVttZXRob2RdKS5hcHBseSh2YWx1ZSwgYXJncyk7CiAgICB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgogIF8ucGx1Y2sgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gdmFsdWVba2V5XTsgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIHdpdGggc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gW107CiAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gdmFsdWVba2V5XSkgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSk7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgb3IgKGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIC8vIENhbid0IG9wdGltaXplIGFycmF5cyBvZiBpbnRlZ2VycyBsb25nZXIgdGhhbiA2NSw1MzUgZWxlbWVudHMuCiAgLy8gU2VlOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODA3OTcKICBfLm1heCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiAtSW5maW5pdHk7CiAgICB2YXIgcmVzdWx0ID0ge2NvbXB1dGVkIDogLUluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPj0gcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiBJbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiBJbmZpbml0eX07CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGNvbXB1dGVkIDwgcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFNodWZmbGUgYW4gYXJyYXkuCiAgXy5zaHVmZmxlID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcmFuZDsKICAgIHZhciBpbmRleCA9IDA7CiAgICB2YXIgc2h1ZmZsZWQgPSBbXTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByYW5kID0gXy5yYW5kb20oaW5kZXgrKyk7CiAgICAgIHNodWZmbGVkW2luZGV4IC0gMV0gPSBzaHVmZmxlZFtyYW5kXTsKICAgICAgc2h1ZmZsZWRbcmFuZF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHNodWZmbGVkOwogIH07CgogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIGxvb2t1cCBpdGVyYXRvcnMuCiAgdmFyIGxvb2t1cEl0ZXJhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihvYmopeyByZXR1cm4gb2JqW3ZhbHVlXTsgfTsKICB9OwoKICAvLyBTb3J0IHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24gcHJvZHVjZWQgYnkgYW4gaXRlcmF0b3IuCiAgXy5zb3J0QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSk7CiAgICByZXR1cm4gXy5wbHVjayhfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlIDogdmFsdWUsCiAgICAgICAgaW5kZXggOiBpbmRleCwKICAgICAgICBjcml0ZXJpYSA6IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KQogICAgICB9OwogICAgfSkuc29ydChmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWE7CiAgICAgIHZhciBiID0gcmlnaHQuY3JpdGVyaWE7CiAgICAgIGlmIChhICE9PSBiKSB7CiAgICAgICAgaWYgKGEgPiBiIHx8IGEgPT09IHZvaWQgMCkgcmV0dXJuIDE7CiAgICAgICAgaWYgKGEgPCBiIHx8IGIgPT09IHZvaWQgMCkgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHJldHVybiBsZWZ0LmluZGV4IDwgcmlnaHQuaW5kZXggPyAtMSA6IDE7CiAgICB9KSwgJ3ZhbHVlJyk7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdXNlZCBmb3IgYWdncmVnYXRlICJncm91cCBieSIgb3BlcmF0aW9ucy4KICB2YXIgZ3JvdXAgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0LCBiZWhhdmlvcikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgdmFyIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IodmFsdWUpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICB2YXIga2V5ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIG9iaik7CiAgICAgIGJlaGF2aW9yKHJlc3VsdCwga2V5LCB2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHJldHVybiBncm91cChvYmosIHZhbHVlLCBjb250ZXh0LCBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgICAgKF8uaGFzKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldIDogKHJlc3VsdFtrZXldID0gW10pKS5wdXNoKHZhbHVlKTsKICAgIH0pOwogIH07CgogIC8vIENvdW50cyBpbnN0YW5jZXMgb2YgYW4gb2JqZWN0IHRoYXQgZ3JvdXAgYnkgYSBjZXJ0YWluIGNyaXRlcmlvbi4gUGFzcwogIC8vIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUgdG8gY291bnQgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQogIC8vIGNyaXRlcmlvbi4KICBfLmNvdW50QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gZ3JvdXAob2JqLCB2YWx1ZSwgY29udGV4dCwgZnVuY3Rpb24ocmVzdWx0LCBrZXksIHZhbHVlKSB7CiAgICAgIGlmICghXy5oYXMocmVzdWx0LCBrZXkpKSByZXN1bHRba2V5XSA9IDA7CiAgICAgIHJlc3VsdFtrZXldKys7CiAgICB9KTsKICB9OwoKICAvLyBVc2UgYSBjb21wYXJhdG9yIGZ1bmN0aW9uIHRvIGZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoCiAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgogIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbihhcnJheSwgb2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgPSBpdGVyYXRvciA9PSBudWxsID8gXy5pZGVudGl0eSA6IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgIHZhciB2YWx1ZSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqKTsKICAgIHZhciBsb3cgPSAwLCBoaWdoID0gYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBhcnJheVttaWRdKSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CgogIC8vIFNhZmVseSBjb252ZXJ0IGFueXRoaW5nIGl0ZXJhYmxlIGludG8gYSByZWFsLCBsaXZlIGFycmF5LgogIF8udG9BcnJheSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFvYmopIHJldHVybiBbXTsKICAgIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgcmV0dXJuIHNsaWNlLmNhbGwob2JqKTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CgogIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KICBfLnNpemUgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpID8gb2JqLmxlbmd0aCA6IF8ua2V5cyhvYmopLmxlbmd0aDsKICB9OwoKICAvLyBBcnJheSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawogIC8vIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gKG4gIT0gbnVsbCkgJiYgIWd1YXJkID8gc2xpY2UuY2FsbChhcnJheSwgMCwgbikgOiBhcnJheVswXTsKICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBsYXN0IGVudHJ5IG9mIHRoZSBhcnJheS4gRXNwZWNpYWxseSB1c2VmdWwgb24KICAvLyB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiBhbGwgdGhlIHZhbHVlcyBpbgogIC8vIHRoZSBhcnJheSwgZXhjbHVkaW5nIHRoZSBsYXN0IE4uIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aAogIC8vIGBfLm1hcGAuCiAgXy5pbml0aWFsID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgYXJyYXkubGVuZ3RoIC0gKChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pKTsKICB9OwoKICAvLyBHZXQgdGhlIGxhc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgbGFzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5sYXN0ID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoKG4gIT0gbnVsbCkgJiYgIWd1YXJkKSB7CiAgICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgogIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCiAgLy8gdGhlIHJlc3QgTiB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqCiAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pOwogIH07CgogIC8vIFRyaW0gb3V0IGFsbCBmYWxzeSB2YWx1ZXMgZnJvbSBhbiBhcnJheS4KICBfLmNvbXBhY3QgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhIXZhbHVlOyB9KTsKICB9OwoKICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbihpbnB1dCwgc2hhbGxvdywgb3V0cHV0KSB7CiAgICBlYWNoKGlucHV0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHNoYWxsb3cgPyBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpIDogZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgb3V0cHV0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwoKICAvLyBSZXR1cm4gYSBjb21wbGV0ZWx5IGZsYXR0ZW5lZCB2ZXJzaW9uIG9mIGFuIGFycmF5LgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CiAgICByZXR1cm4gZmxhdHRlbihhcnJheSwgc2hhbGxvdywgW10pOwogIH07CgogIC8vIFJldHVybiBhIHZlcnNpb24gb2YgdGhlIGFycmF5IHRoYXQgZG9lcyBub3QgY29udGFpbiB0aGUgc3BlY2lmaWVkIHZhbHVlKHMpLgogIF8ud2l0aG91dCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5kaWZmZXJlbmNlKGFycmF5LCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogIH07CgogIC8vIFByb2R1Y2UgYSBkdXBsaWNhdGUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBhcnJheS4gSWYgdGhlIGFycmF5IGhhcyBhbHJlYWR5CiAgLy8gYmVlbiBzb3J0ZWQsIHlvdSBoYXZlIHRoZSBvcHRpb24gb2YgdXNpbmcgYSBmYXN0ZXIgYWxnb3JpdGhtLgogIC8vIEFsaWFzZWQgYXMgYHVuaXF1ZWAuCiAgXy51bmlxID0gXy51bmlxdWUgPSBmdW5jdGlvbihhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGl0ZXJhdG9yID8gXy5tYXAoYXJyYXksIGl0ZXJhdG9yLCBjb250ZXh0KSA6IGFycmF5OwogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBzZWVuID0gW107CiAgICBlYWNoKGluaXRpYWwsIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICBpZiAoaXNTb3J0ZWQgPyAoIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gdmFsdWUpIDogIV8uY29udGFpbnMoc2VlbiwgdmFsdWUpKSB7CiAgICAgICAgc2Vlbi5wdXNoKHZhbHVlKTsKICAgICAgICByZXN1bHRzLnB1c2goYXJyYXlbaW5kZXhdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KICBfLnVuaW9uID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy51bmlxKGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBhcmd1bWVudHMpKTsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBfLmZpbHRlcihfLnVuaXEoYXJyYXkpLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBfLmV2ZXJ5KHJlc3QsIGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIF8uaW5kZXhPZihvdGhlciwgaXRlbSkgPj0gMDsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvLyBUYWtlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gb25lIGFycmF5IGFuZCBhIG51bWJlciBvZiBvdGhlciBhcnJheXMuCiAgLy8gT25seSB0aGUgZWxlbWVudHMgcHJlc2VudCBpbiBqdXN0IHRoZSBmaXJzdCBhcnJheSB3aWxsIHJlbWFpbi4KICBfLmRpZmZlcmVuY2UgPSBmdW5jdGlvbihhcnJheSkgewogICAgdmFyIHJlc3QgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gIV8uY29udGFpbnMocmVzdCwgdmFsdWUpOyB9KTsKICB9OwoKICAvLyBaaXAgdG9nZXRoZXIgbXVsdGlwbGUgbGlzdHMgaW50byBhIHNpbmdsZSBhcnJheSAtLSBlbGVtZW50cyB0aGF0IHNoYXJlCiAgLy8gYW4gaW5kZXggZ28gdG9nZXRoZXIuCiAgXy56aXAgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdmFyIGxlbmd0aCA9IF8ubWF4KF8ucGx1Y2soYXJncywgJ2xlbmd0aCcpKTsKICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3MsICIiICsgaSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBDb252ZXJ0cyBsaXN0cyBpbnRvIG9iamVjdHMuIFBhc3MgZWl0aGVyIGEgc2luZ2xlIGFycmF5IG9mIGBba2V5LCB2YWx1ZV1gCiAgLy8gcGFpcnMsIG9yIHR3byBwYXJhbGxlbCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoIC0tIG9uZSBvZiBrZXlzLCBhbmQgb25lIG9mCiAgLy8gdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogIF8ub2JqZWN0ID0gZnVuY3Rpb24obGlzdCwgdmFsdWVzKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGxpc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBJZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBseSB1cyB3aXRoIGluZGV4T2YgKEknbSBsb29raW5nIGF0IHlvdSwgKipNU0lFKiopLAogIC8vIHdlIG5lZWQgdGhpcyBmdW5jdGlvbi4gUmV0dXJuIHRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhbgogIC8vIGl0ZW0gaW4gYW4gYXJyYXksIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChpc1NvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CiAgICAgICAgaSA9IChpc1NvcnRlZCA8IDAgPyBNYXRoLm1heCgwLCBsICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKICAgICAgICByZXR1cm4gYXJyYXlbaV0gPT09IGl0ZW0gPyBpIDogLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChuYXRpdmVJbmRleE9mICYmIGFycmF5LmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0sIGlzU29ydGVkKTsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBsYXN0SW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgZnJvbSkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBoYXNJbmRleCA9IGZyb20gIT0gbnVsbDsKICAgIGlmIChuYXRpdmVMYXN0SW5kZXhPZiAmJiBhcnJheS5sYXN0SW5kZXhPZiA9PT0gbmF0aXZlTGFzdEluZGV4T2YpIHsKICAgICAgcmV0dXJuIGhhc0luZGV4ID8gYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgZnJvbSkgOiBhcnJheS5sYXN0SW5kZXhPZihpdGVtKTsKICAgIH0KICAgIHZhciBpID0gKGhhc0luZGV4ID8gZnJvbSA6IGFycmF5Lmxlbmd0aCk7CiAgICB3aGlsZSAoaS0tKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKICAvLyB0aGUgbmF0aXZlIFB5dGhvbiBgcmFuZ2UoKWAgZnVuY3Rpb24uIFNlZQogIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCiAgXy5yYW5nZSA9IGZ1bmN0aW9uKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICBzdGVwID0gYXJndW1lbnRzWzJdIHx8IDE7CgogICAgdmFyIGxlbiA9IE1hdGgubWF4KE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApLCAwKTsKICAgIHZhciBpZHggPSAwOwogICAgdmFyIHJhbmdlID0gbmV3IEFycmF5KGxlbik7CgogICAgd2hpbGUoaWR4IDwgbGVuKSB7CiAgICAgIHJhbmdlW2lkeCsrXSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQoKICAgIHJldHVybiByYW5nZTsKICB9OwoKICAvLyBGdW5jdGlvbiAoYWhlbSkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldXNhYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciBwcm90b3R5cGUgc2V0dGluZy4KICB2YXIgY3RvciA9IGZ1bmN0aW9uKCl7fTsKCiAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCiAgLy8gb3B0aW9uYWxseSkuIEJpbmRpbmcgd2l0aCBhcmd1bWVudHMgaXMgYWxzbyBrbm93biBhcyBgY3VycnlgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZiBhdmFpbGFibGUuCiAgLy8gV2UgY2hlY2sgZm9yIGBmdW5jLmJpbmRgIGZpcnN0LCB0byBmYWlsIGZhc3Qgd2hlbiBgZnVuY2AgaXMgdW5kZWZpbmVkLgogIF8uYmluZCA9IGZ1bmN0aW9uIGJpbmQoZnVuYywgY29udGV4dCkgewogICAgdmFyIGJvdW5kLCBhcmdzOwogICAgaWYgKGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCAmJiBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgaWYgKCFfLmlzRnVuY3Rpb24oZnVuYykpIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkpIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBjdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICB2YXIgc2VsZiA9IG5ldyBjdG9yOwogICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgaWYgKE9iamVjdChyZXN1bHQpID09PSByZXN1bHQpIHJldHVybiByZXN1bHQ7CiAgICAgIHJldHVybiBzZWxmOwogICAgfTsKICB9OwoKICAvLyBCaW5kIGFsbCBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBVc2VmdWwgZm9yIGVuc3VyaW5nIHRoYXQKICAvLyBhbGwgY2FsbGJhY2tzIGRlZmluZWQgb24gYW4gb2JqZWN0IGJlbG9uZyB0byBpdC4KICBfLmJpbmRBbGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBmdW5jcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIGlmIChmdW5jcy5sZW5ndGggPT0gMCkgZnVuY3MgPSBfLmZ1bmN0aW9ucyhvYmopOwogICAgZWFjaChmdW5jcywgZnVuY3Rpb24oZikgeyBvYmpbZl0gPSBfLmJpbmQob2JqW2ZdLCBvYmopOyB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gTWVtb2l6ZSBhbiBleHBlbnNpdmUgZnVuY3Rpb24gYnkgc3RvcmluZyBpdHMgcmVzdWx0cy4KICBfLm1lbW9pemUgPSBmdW5jdGlvbihmdW5jLCBoYXNoZXIpIHsKICAgIHZhciBtZW1vID0ge307CiAgICBoYXNoZXIgfHwgKGhhc2hlciA9IF8uaWRlbnRpdHkpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIga2V5ID0gaGFzaGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBfLmhhcyhtZW1vLCBrZXkpID8gbWVtb1trZXldIDogKG1lbW9ba2V5XSA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9OwogIH07CgogIC8vIERlbGF5cyBhIGZ1bmN0aW9uIGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kIHRoZW4gY2FsbHMKICAvLyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgc3VwcGxpZWQuCiAgXy5kZWxheSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgcmV0dXJuIGZ1bmMuYXBwbHkobnVsbCwgYXJncyk7IH0sIHdhaXQpOwogIH07CgogIC8vIERlZmVycyBhIGZ1bmN0aW9uLCBzY2hlZHVsaW5nIGl0IHRvIHJ1biBhZnRlciB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcwogIC8vIGNsZWFyZWQuCiAgXy5kZWZlciA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHJldHVybiBfLmRlbGF5LmFwcGx5KF8sIFtmdW5jLCAxXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCB3aGVuIGludm9rZWQsIHdpbGwgb25seSBiZSB0cmlnZ2VyZWQgYXQgbW9zdCBvbmNlCiAgLy8gZHVyaW5nIGEgZ2l2ZW4gd2luZG93IG9mIHRpbWUuCiAgXy50aHJvdHRsZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBjb250ZXh0LCBhcmdzLCB0aW1lb3V0LCB0aHJvdHRsaW5nLCBtb3JlLCByZXN1bHQ7CiAgICB2YXIgd2hlbkRvbmUgPSBfLmRlYm91bmNlKGZ1bmN0aW9uKCl7IG1vcmUgPSB0aHJvdHRsaW5nID0gZmFsc2U7IH0sIHdhaXQpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBjb250ZXh0ID0gdGhpczsgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgaWYgKG1vcmUpIHsKICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfQogICAgICAgIHdoZW5Eb25lKCk7CiAgICAgIH07CiAgICAgIGlmICghdGltZW91dCkgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICBpZiAodGhyb3R0bGluZykgewogICAgICAgIG1vcmUgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm90dGxpbmcgPSB0cnVlOwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH0KICAgICAgd2hlbkRvbmUoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAogIC8vIGJlIHRyaWdnZXJlZC4gVGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGl0IHN0b3BzIGJlaW5nIGNhbGxlZCBmb3IKICAvLyBOIG1pbGxpc2Vjb25kcy4gSWYgYGltbWVkaWF0ZWAgaXMgcGFzc2VkLCB0cmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUKICAvLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLgogIF8uZGVib3VuY2UgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciB0aW1lb3V0LCByZXN1bHQ7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjb250ZXh0ID0gdGhpcywgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgaWYgKCFpbW1lZGlhdGUpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH07CiAgICAgIHZhciBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgaWYgKGNhbGxOb3cpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZXhlY3V0ZWQgYXQgbW9zdCBvbmUgdGltZSwgbm8gbWF0dGVyIGhvdwogIC8vIG9mdGVuIHlvdSBjYWxsIGl0LiBVc2VmdWwgZm9yIGxhenkgaW5pdGlhbGl6YXRpb24uCiAgXy5vbmNlID0gZnVuY3Rpb24oZnVuYykgewogICAgdmFyIHJhbiA9IGZhbHNlLCBtZW1vOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAocmFuKSByZXR1cm4gbWVtbzsKICAgICAgcmFuID0gdHJ1ZTsKICAgICAgbWVtbyA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgZnVuYyA9IG51bGw7CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIHRoZSBmaXJzdCBmdW5jdGlvbiBwYXNzZWQgYXMgYW4gYXJndW1lbnQgdG8gdGhlIHNlY29uZCwKICAvLyBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGFyZ3VtZW50cywgcnVuIGNvZGUgYmVmb3JlIGFuZCBhZnRlciwgYW5kCiAgLy8gY29uZGl0aW9uYWxseSBleGVjdXRlIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KICBfLndyYXAgPSBmdW5jdGlvbihmdW5jLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gW2Z1bmNdOwogICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB3cmFwcGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgYSBsaXN0IG9mIGZ1bmN0aW9ucywgZWFjaAogIC8vIGNvbnN1bWluZyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgXy5jb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgZnVuY3MgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICBmb3IgKHZhciBpID0gZnVuY3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgfQogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIGFmdGVyIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgogIF8uYWZ0ZXIgPSBmdW5jdGlvbih0aW1lcywgZnVuYykgewogICAgaWYgKHRpbWVzIDw9IDApIHJldHVybiBmdW5jKCk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICgtLXRpbWVzIDwgMSkgewogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgLy8gT2JqZWN0IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV0cmlldmUgdGhlIG5hbWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYE9iamVjdC5rZXlzYAogIF8ua2V5cyA9IG5hdGl2ZUtleXMgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqICE9PSBPYmplY3Qob2JqKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBvYmplY3QnKTsKICAgIHZhciBrZXlzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBrZXlzW2tleXMubGVuZ3RoXSA9IGtleTsKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICBfLnZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHZhbHVlcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgdmFsdWVzLnB1c2gob2JqW2tleV0pOwogICAgcmV0dXJuIHZhbHVlczsKICB9OwoKICAvLyBDb252ZXJ0IGFuIG9iamVjdCBpbnRvIGEgbGlzdCBvZiBgW2tleSwgdmFsdWVdYCBwYWlycy4KICBfLnBhaXJzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcGFpcnMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHBhaXJzLnB1c2goW2tleSwgb2JqW2tleV1dKTsKICAgIHJldHVybiBwYWlyczsKICB9OwoKICAvLyBJbnZlcnQgdGhlIGtleXMgYW5kIHZhbHVlcyBvZiBhbiBvYmplY3QuIFRoZSB2YWx1ZXMgbXVzdCBiZSBzZXJpYWxpemFibGUuCiAgXy5pbnZlcnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJlc3VsdFtvYmpba2V5XV0gPSBrZXk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhIHNvcnRlZCBsaXN0IG9mIHRoZSBmdW5jdGlvbiBuYW1lcyBhdmFpbGFibGUgb24gdGhlIG9iamVjdC4KICAvLyBBbGlhc2VkIGFzIGBtZXRob2RzYAogIF8uZnVuY3Rpb25zID0gXy5tZXRob2RzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgbmFtZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihvYmpba2V5XSkpIG5hbWVzLnB1c2goa2V5KTsKICAgIH0KICAgIHJldHVybiBuYW1lcy5zb3J0KCk7CiAgfTsKCiAgLy8gRXh0ZW5kIGEgZ2l2ZW4gb2JqZWN0IHdpdGggYWxsIHRoZSBwcm9wZXJ0aWVzIGluIHBhc3NlZC1pbiBvYmplY3QocykuCiAgXy5leHRlbmQgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgb25seSBjb250YWluaW5nIHRoZSB3aGl0ZWxpc3RlZCBwcm9wZXJ0aWVzLgogIF8ucGljayA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoa2V5IGluIG9iaikgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9KTsKICAgIHJldHVybiBjb3B5OwogIH07CgogICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KICBfLm9taXQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoIV8uY29udGFpbnMoa2V5cywga2V5KSkgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9CiAgICByZXR1cm4gY29weTsKICB9OwoKICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgogIF8uZGVmYXVsdHMgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBpZiAob2JqW3Byb3BdID09IG51bGwpIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KICBfLmNsb25lID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CiAgfTsKCiAgLy8gSW52b2tlcyBpbnRlcmNlcHRvciB3aXRoIHRoZSBvYmosIGFuZCB0aGVuIHJldHVybnMgb2JqLgogIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICBfLnRhcCA9IGZ1bmN0aW9uKG9iaiwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCiAgdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKICAgIC8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KICAgIC8vIFNlZSB0aGUgSGFybW9ueSBgZWdhbGAgcHJvcG9zYWw6IGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbC4KICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PSAxIC8gYjsKICAgIC8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSByZXR1cm4gYSA9PT0gYjsKICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgogICAgaWYgKGEgaW5zdGFuY2VvZiBfKSBhID0gYS5fd3JhcHBlZDsKICAgIGlmIChiIGluc3RhbmNlb2YgXykgYiA9IGIuX3dyYXBwZWQ7CiAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CiAgICBpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpIHJldHVybiBmYWxzZTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgogICAgICBjYXNlICdbb2JqZWN0IFN0cmluZ10nOgogICAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwogICAgICAgIC8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCiAgICAgICAgcmV0dXJuIGEgPT0gU3RyaW5nKGIpOwogICAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgogICAgICAgIC8vIGBOYU5gcyBhcmUgZXF1aXZhbGVudCwgYnV0IG5vbi1yZWZsZXhpdmUuIEFuIGBlZ2FsYCBjb21wYXJpc29uIGlzIHBlcmZvcm1lZCBmb3IKICAgICAgICAvLyBvdGhlciBudW1lcmljIHZhbHVlcy4KICAgICAgICByZXR1cm4gYSAhPSArYSA/IGIgIT0gK2IgOiAoYSA9PSAwID8gMSAvIGEgPT0gMSAvIGIgOiBhID09ICtiKTsKICAgICAgY2FzZSAnW29iamVjdCBEYXRlXSc6CiAgICAgIGNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgogICAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKICAgICAgICAvLyBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMuIE5vdGUgdGhhdCBpbnZhbGlkIGRhdGVzIHdpdGggbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zCiAgICAgICAgLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgogICAgICAgIHJldHVybiArYSA9PSArYjsKICAgICAgLy8gUmVnRXhwcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIgc291cmNlIHBhdHRlcm5zIGFuZCBmbGFncy4KICAgICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKICAgICAgICByZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYKICAgICAgICAgICAgICAgYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYKICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYKICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT0gYSkgcmV0dXJuIGJTdGFja1tsZW5ndGhdID09IGI7CiAgICB9CiAgICAvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucHVzaChhKTsKICAgIGJTdGFjay5wdXNoKGIpOwogICAgdmFyIHNpemUgPSAwLCByZXN1bHQgPSB0cnVlOwogICAgLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCiAgICBpZiAoY2xhc3NOYW1lID09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PSBiLmxlbmd0aDsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIERlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMuCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKICAgICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgICAgdmFyIGFDdG9yID0gYS5jb25zdHJ1Y3RvciwgYkN0b3IgPSBiLmNvbnN0cnVjdG9yOwogICAgICBpZiAoYUN0b3IgIT09IGJDdG9yICYmICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiAoYUN0b3IgaW5zdGFuY2VvZiBhQ3RvcikgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgKGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBEZWVwIGNvbXBhcmUgb2JqZWN0cy4KICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICBpZiAoXy5oYXMoYSwga2V5KSkgewogICAgICAgICAgLy8gQ291bnQgdGhlIGV4cGVjdGVkIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyLgogICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgZm9yIChrZXkgaW4gYikgewogICAgICAgICAgaWYgKF8uaGFzKGIsIGtleSkgJiYgIShzaXplLS0pKSBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgIH0KICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnBvcCgpOwogICAgYlN0YWNrLnBvcCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBQZXJmb3JtIGEgZGVlcCBjb21wYXJpc29uIHRvIGNoZWNrIGlmIHR3byBvYmplY3RzIGFyZSBlcXVhbC4KICBfLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIGFycmF5LCBzdHJpbmcsIG9yIG9iamVjdCBlbXB0eT8KICAvLyBBbiAiZW1wdHkiIG9iamVjdCBoYXMgbm8gZW51bWVyYWJsZSBvd24tcHJvcGVydGllcy4KICBfLmlzRW1wdHkgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CiAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopKSByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmoubm9kZVR5cGUgPT09IDEpOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CiAgLy8gRGVsZWdhdGVzIHRvIEVDTUE1J3MgbmF0aXZlIEFycmF5LmlzQXJyYXkKICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IE9iamVjdChvYmopOwogIH07CgogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIGVhY2goWydBcmd1bWVudHMnLCAnRnVuY3Rpb24nLCAnU3RyaW5nJywgJ051bWJlcicsICdEYXRlJywgJ1JlZ0V4cCddLCBmdW5jdGlvbihuYW1lKSB7CiAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKCiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuICEhKG9iaiAmJiBfLmhhcyhvYmosICdjYWxsZWUnKSk7CiAgICB9OwogIH0KCiAgLy8gT3B0aW1pemUgYGlzRnVuY3Rpb25gIGlmIGFwcHJvcHJpYXRlLgogIGlmICh0eXBlb2YgKC8uLykgIT09ICdmdW5jdGlvbicpIHsKICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJzsKICAgIH07CiAgfQoKICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIF8uaXNOdW1iZXIob2JqKSAmJiBpc0Zpbml0ZShvYmopOwogIH07CgogIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KICBfLmlzTmFOID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPSArb2JqOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEJvb2xlYW5dJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGVxdWFsIHRvIG51bGw/CiAgXy5pc051bGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IG51bGw7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CiAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdm9pZCAwOwogIH07CgogIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKICAvLyBvbiBpdHNlbGYgKGluIG90aGVyIHdvcmRzLCBub3Qgb24gYSBwcm90b3R5cGUpLgogIF8uaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICB9OwoKICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJ1biBVbmRlcnNjb3JlLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBfYCB2YXJpYWJsZSB0byBpdHMKICAvLyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290Ll8gPSBwcmV2aW91c1VuZGVyc2NvcmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBLZWVwIHRoZSBpZGVudGl0eSBmdW5jdGlvbiBhcm91bmQgZm9yIGRlZmF1bHQgaXRlcmF0b3JzLgogIF8uaWRlbnRpdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgogIF8udGltZXMgPSBmdW5jdGlvbihuLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyBpKyspIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgaSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS4KICBfLnJhbmRvbSA9IGZ1bmN0aW9uKG1pbiwgbWF4KSB7CiAgICBpZiAobWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gbWluOwogICAgICBtaW4gPSAwOwogICAgfQogICAgcmV0dXJuIG1pbiArICgwIHwgTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSk7CiAgfTsKCiAgLy8gTGlzdCBvZiBIVE1MIGVudGl0aWVzIGZvciBlc2NhcGluZy4KICB2YXIgZW50aXR5TWFwID0gewogICAgZXNjYXBlOiB7CiAgICAgICcmJzogJyZhbXA7JywKICAgICAgJzwnOiAnJmx0OycsCiAgICAgICc+JzogJyZndDsnLAogICAgICAnIic6ICcmcXVvdDsnLAogICAgICAiJyI6ICcmI3gyNzsnLAogICAgICAnLyc6ICcmI3gyRjsnCiAgICB9CiAgfTsKICBlbnRpdHlNYXAudW5lc2NhcGUgPSBfLmludmVydChlbnRpdHlNYXAuZXNjYXBlKTsKCiAgLy8gUmVnZXhlcyBjb250YWluaW5nIHRoZSBrZXlzIGFuZCB2YWx1ZXMgbGlzdGVkIGltbWVkaWF0ZWx5IGFib3ZlLgogIHZhciBlbnRpdHlSZWdleGVzID0gewogICAgZXNjYXBlOiAgIG5ldyBSZWdFeHAoJ1snICsgXy5rZXlzKGVudGl0eU1hcC5lc2NhcGUpLmpvaW4oJycpICsgJ10nLCAnZycpLAogICAgdW5lc2NhcGU6IG5ldyBSZWdFeHAoJygnICsgXy5rZXlzKGVudGl0eU1hcC51bmVzY2FwZSkuam9pbignfCcpICsgJyknLCAnZycpCiAgfTsKCiAgLy8gRnVuY3Rpb25zIGZvciBlc2NhcGluZyBhbmQgdW5lc2NhcGluZyBzdHJpbmdzIHRvL2Zyb20gSFRNTCBpbnRlcnBvbGF0aW9uLgogIF8uZWFjaChbJ2VzY2FwZScsICd1bmVzY2FwZSddLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIF9bbWV0aG9kXSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICBpZiAoc3RyaW5nID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuICgnJyArIHN0cmluZykucmVwbGFjZShlbnRpdHlSZWdleGVzW21ldGhvZF0sIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgICAgcmV0dXJuIGVudGl0eU1hcFttZXRob2RdW21hdGNoXTsKICAgICAgfSk7CiAgICB9OwogIH0pOwoKICAvLyBJZiB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkIHByb3BlcnR5IGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQ7CiAgLy8gb3RoZXJ3aXNlLCByZXR1cm4gaXQuCiAgXy5yZXN1bHQgPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7CiAgICBpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwogICAgdmFyIHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUuY2FsbChvYmplY3QpIDogdmFsdWU7CiAgfTsKCiAgLy8gQWRkIHlvdXIgb3duIGN1c3RvbSBmdW5jdGlvbnMgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubWl4aW4gPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goXy5mdW5jdGlvbnMob2JqKSwgZnVuY3Rpb24obmFtZSl7CiAgICAgIHZhciBmdW5jID0gX1tuYW1lXSA9IG9ialtuYW1lXTsKICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIGZ1bmMuYXBwbHkoXywgYXJncykpOwogICAgICB9OwogICAgfSk7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KICAvLyBVc2VmdWwgZm9yIHRlbXBvcmFyeSBET00gaWRzLgogIHZhciBpZENvdW50ZXIgPSAwOwogIF8udW5pcXVlSWQgPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgIHZhciBpZCA9IGlkQ291bnRlcisrOwogICAgcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7CiAgfTsKCiAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCiAgLy8gZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCiAgICBpbnRlcnBvbGF0ZSA6IC88JT0oW1xzXFNdKz8pJT4vZywKICAgIGVzY2FwZSAgICAgIDogLzwlLShbXHNcU10rPyklPi9nCiAgfTsKCiAgLy8gV2hlbiBjdXN0b21pemluZyBgdGVtcGxhdGVTZXR0aW5nc2AsIGlmIHlvdSBkb24ndCB3YW50IHRvIGRlZmluZSBhbgogIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KICB2YXIgbm9NYXRjaCA9IC8oLileLzsKCiAgLy8gQ2VydGFpbiBjaGFyYWN0ZXJzIG5lZWQgdG8gYmUgZXNjYXBlZCBzbyB0aGF0IHRoZXkgY2FuIGJlIHB1dCBpbnRvIGEKICAvLyBzdHJpbmcgbGl0ZXJhbC4KICB2YXIgZXNjYXBlcyA9IHsKICAgICInIjogICAgICAiJyIsCiAgICAnXFwnOiAgICAgJ1xcJywKICAgICdccic6ICAgICAncicsCiAgICAnXG4nOiAgICAgJ24nLAogICAgJ1x0JzogICAgICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwoKICB2YXIgZXNjYXBlciA9IC9cXHwnfFxyfFxufFx0fFx1MjAyOHxcdTIwMjkvZzsKCiAgLy8gSmF2YVNjcmlwdCBtaWNyby10ZW1wbGF0aW5nLCBzaW1pbGFyIHRvIEpvaG4gUmVzaWcncyBpbXBsZW1lbnRhdGlvbi4KICAvLyBVbmRlcnNjb3JlIHRlbXBsYXRpbmcgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzIHdoaXRlc3BhY2UsCiAgLy8gYW5kIGNvcnJlY3RseSBlc2NhcGVzIHF1b3RlcyB3aXRoaW4gaW50ZXJwb2xhdGVkIGNvZGUuCiAgXy50ZW1wbGF0ZSA9IGZ1bmN0aW9uKHRleHQsIGRhdGEsIHNldHRpbmdzKSB7CiAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwoKICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzb3VyY2UgPSAiX19wKz0nIjsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KQogICAgICAgIC5yZXBsYWNlKGVzY2FwZXIsIGZ1bmN0aW9uKG1hdGNoKSB7IHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07IH0pOwogICAgICBzb3VyY2UgKz0KICAgICAgICBlc2NhcGUgPyAiJytcbigoX190PSgiICsgZXNjYXBlICsgIikpPT1udWxsPycnOl8uZXNjYXBlKF9fdCkpK1xuJyIgOgogICAgICAgIGludGVycG9sYXRlID8gIicrXG4oKF9fdD0oIiArIGludGVycG9sYXRlICsgIikpPT1udWxsPycnOl9fdCkrXG4nIiA6CiAgICAgICAgZXZhbHVhdGUgPyAiJztcbiIgKyBldmFsdWF0ZSArICJcbl9fcCs9JyIgOiAnJzsKICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CiAgICB9KTsKICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgLy8gSWYgYSB2YXJpYWJsZSBpcyBub3Qgc3BlY2lmaWVkLCBwbGFjZSBkYXRhIHZhbHVlcyBpbiBsb2NhbCBzY29wZS4KICAgIGlmICghc2V0dGluZ3MudmFyaWFibGUpIHNvdXJjZSA9ICd3aXRoKG9ianx8e30pe1xuJyArIHNvdXJjZSArICd9XG4nOwoKICAgIHNvdXJjZSA9ICJ2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sIiArCiAgICAgICJwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9O1xuIiArCiAgICAgIHNvdXJjZSArICJyZXR1cm4gX19wO1xuIjsKCiAgICB0cnkgewogICAgICB2YXIgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICB0aHJvdyBlOwogICAgfQoKICAgIGlmIChkYXRhKSByZXR1cm4gcmVuZGVyKGRhdGEsIF8pOwogICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwoKICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KICAgIHRlbXBsYXRlLnNvdXJjZSA9ICdmdW5jdGlvbignICsgKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonKSArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKCiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbiwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSB0byB0aGUgd3JhcHBlci4KICBfLmNoYWluID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXyhvYmopLmNoYWluKCk7CiAgfTsKCiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb250aW51ZSBjaGFpbmluZyBpbnRlcm1lZGlhdGUgcmVzdWx0cy4KICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwoKICAvLyBBZGQgYWxsIG9mIHRoZSBVbmRlcnNjb3JlIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlciBvYmplY3QuCiAgXy5taXhpbihfKTsKCiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9iaiA9IHRoaXMuX3dyYXBwZWQ7CiAgICAgIG1ldGhvZC5hcHBseShvYmosIGFyZ3VtZW50cyk7CiAgICAgIGlmICgobmFtZSA9PSAnc2hpZnQnIHx8IG5hbWUgPT0gJ3NwbGljZScpICYmIG9iai5sZW5ndGggPT09IDApIGRlbGV0ZSBvYmpbMF07CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwogICAgfTsKICB9KTsKCiAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIF8uZXh0ZW5kKF8ucHJvdG90eXBlLCB7CgogICAgLy8gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9jaGFpbiA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeHRyYWN0cyB0aGUgcmVzdWx0IGZyb20gYSB3cmFwcGVkIGFuZCBjaGFpbmVkIG9iamVjdC4KICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CiAgICB9CgogIH0pOwoKfSkuY2FsbCh0aGlzKTsKCi8vICAgICBCYWNrYm9uZS5qcyAwLjkuOQoKLy8gICAgIChjKSAyMDEwLTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24oKXsKCiAgLy8gSW5pdGlhbCBTZXR1cAogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdCAoYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIGBleHBvcnRzYAogIC8vIG9uIHRoZSBzZXJ2ZXIpLgogIHZhciByb290ID0gdGhpczsKCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCiAgLy8gQ3JlYXRlIGEgbG9jYWwgcmVmZXJlbmNlIHRvIGFycmF5IG1ldGhvZHMuCiAgdmFyIGFycmF5ID0gW107CiAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwogIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwogIHZhciBzcGxpY2UgPSBhcnJheS5zcGxpY2U7CgogIC8vIFRoZSB0b3AtbGV2ZWwgbmFtZXNwYWNlLiBBbGwgcHVibGljIEJhY2tib25lIGNsYXNzZXMgYW5kIG1vZHVsZXMgd2lsbAogIC8vIGJlIGF0dGFjaGVkIHRvIHRoaXMuIEV4cG9ydGVkIGZvciBib3RoIENvbW1vbkpTIGFuZCB0aGUgYnJvd3Nlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcwLjkuOSc7CgogIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4KICB2YXIgXyA9IHJvb3QuXzsKICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBvciBFbmRlciBvd25zIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9IHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlcjsKCiAgLy8gUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCiAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgogIEJhY2tib25lLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgogIC8vIHdpbGwgZmFrZSBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7CgogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9OwoKICAvLyBPcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0bwogIC8vIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihvYmosIGV2ZW50cywgYXJncykgewogICAgdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoOwogICAgc3dpdGNoIChhcmdzLmxlbmd0aCkgewogICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7CiAgICByZXR1cm47CiAgICBjYXNlIDE6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhcmdzWzBdKTsKICAgIHJldHVybjsKICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGFyZ3NbMF0sIGFyZ3NbMV0pOwogICAgcmV0dXJuOwogICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICByZXR1cm47CiAgICBkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5hcHBseShldi5jdHgsIGFyZ3MpOwogICAgfQogIH07CgogIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrCiAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KICAvLyBzdWNjZXNzaW9uLgogIC8vCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogIC8vCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCiAgICAvLyBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIG9yIGFuIGV2ZW50cyBtYXAsCiAgICAvLyB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvCiAgICAvLyBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghKGV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSAmJiBjYWxsYmFjaykpIHJldHVybiB0aGlzOwogICAgICB0aGlzLl9ldmVudHMgfHwgKHRoaXMuX2V2ZW50cyA9IHt9KTsKICAgICAgdmFyIGxpc3QgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgbGlzdC5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGV2ZW50cyB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQogICAgLy8gdGhlIGNhbGxiYWNrIGlzIGludm9rZWQsIGl0IHdpbGwgYmUgcmVtb3ZlZC4KICAgIG9uY2U6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghKGV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pICYmIGNhbGxiYWNrKSkgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHRoaXMub24obmFtZSwgb25jZSwgY29udGV4dCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgZXZlbnRzYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAogICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgogICAgb2ZmOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICB2YXIgbGlzdCwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CgogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAobGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgZXZlbnRzID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gbGlzdC5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBldiA9IGxpc3Rbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gKGV2LmNhbGxiYWNrLl9jYWxsYmFjayB8fCBldi5jYWxsYmFjaykpIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICBldmVudHMucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSBldmVudHM7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHModGhpcywgZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyh0aGlzLCBhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBbiBpbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9uIG9mIGBvbmAuIFRlbGwgKnRoaXMqIG9iamVjdCB0byBsaXN0ZW4gdG8KICAgIC8vIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncyBsaXN0ZW5pbmcgdG8uCiAgICBsaXN0ZW5UbzogZnVuY3Rpb24ob2JqZWN0LCBldmVudHMsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnMgfHwgKHRoaXMuX2xpc3RlbmVycyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqZWN0Ll9saXN0ZW5lcklkIHx8IChvYmplY3QuX2xpc3RlbmVySWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5lcnNbaWRdID0gb2JqZWN0OwogICAgICBvYmplY3Qub24oZXZlbnRzLCBjYWxsYmFjayB8fCB0aGlzLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmplY3QsIGV2ZW50cywgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKICAgICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybjsKICAgICAgaWYgKG9iamVjdCkgewogICAgICAgIG9iamVjdC5vZmYoZXZlbnRzLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgaWYgKCFldmVudHMgJiYgIWNhbGxiYWNrKSBkZWxldGUgbGlzdGVuZXJzW29iamVjdC5fbGlzdGVuZXJJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuZXJzKSB7CiAgICAgICAgICBsaXN0ZW5lcnNbaWRdLm9mZihudWxsLCBudWxsLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fbGlzdGVuZXJzID0ge307CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwsIHdpdGggZGVmaW5lZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApCiAgLy8gaXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIGFzc2lnbmVkIGZvciB5b3UuCiAgdmFyIE1vZGVsID0gQmFja2JvbmUuTW9kZWwgPSBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICB2YXIgZGVmYXVsdHM7CiAgICB2YXIgYXR0cnMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgdGhpcy5fY2hhbmdlcyA9IFtdOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb2xsZWN0aW9uKSB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMpOwogICAgaWYgKGRlZmF1bHRzID0gXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpIF8uZGVmYXVsdHMoYXR0cnMsIGRlZmF1bHRzKTsKICAgIHRoaXMuc2V0KGF0dHJzLCB7c2lsZW50OiB0cnVlfSk7CiAgICB0aGlzLl9jdXJyZW50QXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgIHVubGVzcwogICAgLy8geW91IGNob29zZSB0byBzaWxlbmNlIGl0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnM7CiAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKF8uaXNPYmplY3Qoa2V5KSkgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdmFyIHNpbGVudCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5zaWxlbnQ7CiAgICAgIHZhciB1bnNldCA9IG9wdGlvbnMgJiYgb3B0aW9ucy51bnNldDsKCiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCiAgICAgIHZhciBub3cgPSB0aGlzLmF0dHJpYnV0ZXM7CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUuLi4KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CgogICAgICAgIC8vIFVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUsIGFuZCB0cmFjayB0aGUgY2hhbmdlLgogICAgICAgIHVuc2V0ID8gZGVsZXRlIG5vd1thdHRyXSA6IG5vd1thdHRyXSA9IHZhbDsKICAgICAgICB0aGlzLl9jaGFuZ2VzLnB1c2goYXR0ciwgdmFsKTsKICAgICAgfQoKICAgICAgLy8gU2lnbmFsIHRoYXQgdGhlIG1vZGVsJ3Mgc3RhdGUgaGFzIHBvdGVudGlhbGx5IGNoYW5nZWQsIGFuZCB3ZSBuZWVkCiAgICAgIC8vIHRvIHJlY29tcHV0ZSB0aGUgYWN0dWFsIGNoYW5nZXMuCiAgICAgIHRoaXMuX2hhc0NvbXB1dGVkID0gZmFsc2U7CgogICAgICAvLyBGaXJlIHRoZSBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKCFzaWxlbnQpIHRoaXMuY2hhbmdlKG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UKICAgIC8vIHRvIHNpbGVuY2UgaXQuIGB1bnNldGAgaXMgYSBub29wIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KICAgIHVuc2V0OiBmdW5jdGlvbihhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UKICAgIC8vIHRvIHNpbGVuY2UgaXQuCiAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgYXR0cnMgPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRlbiwKICAgIC8vIHRyaWdnZXJpbmcgYSBgImNoYW5nZSJgIGV2ZW50LgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncwogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycywgY3VycmVudCwgZG9uZTsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgXy5pc09iamVjdChrZXkpKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIGlmIChrZXkgIT0gbnVsbCkgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoKICAgICAgLy8gSWYgd2UncmUgIndhaXQiLWluZyB0byBzZXQgY2hhbmdlZCBhdHRyaWJ1dGVzLCB2YWxpZGF0ZSBlYXJseS4KICAgICAgaWYgKG9wdGlvbnMud2FpdCkgewogICAgICAgIGlmIChhdHRycyAmJiAhdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgY3VycmVudCA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgfQoKICAgICAgLy8gUmVndWxhciBzYXZlcyBgc2V0YCBhdHRyaWJ1dGVzIGJlZm9yZSBwZXJzaXN0aW5nIHRvIHRoZSBzZXJ2ZXIuCiAgICAgIHZhciBzaWxlbnRPcHRpb25zID0gXy5leHRlbmQoe30sIG9wdGlvbnMsIHtzaWxlbnQ6IHRydWV9KTsKICAgICAgaWYgKGF0dHJzICYmICF0aGlzLnNldChhdHRycywgb3B0aW9ucy53YWl0ID8gc2lsZW50T3B0aW9ucyA6IG9wdGlvbnMpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICAvLyBEbyBub3QgcGVyc2lzdCBpbnZhbGlkIG1vZGVscy4KICAgICAgaWYgKCFhdHRycyAmJiAhdGhpcy5fdmFsaWRhdGUobnVsbCwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQogICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgLy8gRmluaXNoIGNvbmZpZ3VyaW5nIGFuZCBzZW5kaW5nIHRoZSBBamF4IHJlcXVlc3QuCiAgICAgIHZhciBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFdoZW4gdXNpbmcgYHdhaXRgLCByZXNldCBhdHRyaWJ1dGVzIHRvIG9yaWdpbmFsIHZhbHVlcyB1bmxlc3MKICAgICAgLy8gYHN1Y2Nlc3NgIGhhcyBiZWVuIGNhbGxlZCBhbHJlYWR5LgogICAgICBpZiAoIWRvbmUgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5jbGVhcihzaWxlbnRPcHRpb25zKTsKICAgICAgICB0aGlzLnNldChjdXJyZW50LCBzaWxlbnRPcHRpb25zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgogICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuCiAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCiAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpIGRlc3Ryb3koKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDYWxsIHRoaXMgbWV0aG9kIHRvIG1hbnVhbGx5IGZpcmUgYSBgImNoYW5nZSJgIGV2ZW50IGZvciB0aGlzIG1vZGVsIGFuZAogICAgLy8gYSBgImNoYW5nZTphdHRyaWJ1dGUiYCBldmVudCBmb3IgZWFjaCBjaGFuZ2VkIGF0dHJpYnV0ZS4KICAgIC8vIENhbGxpbmcgdGhpcyB3aWxsIGNhdXNlIGFsbCBvYmplY3RzIG9ic2VydmluZyB0aGUgbW9kZWwgdG8gdXBkYXRlLgogICAgY2hhbmdlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBjaGFuZ2luZyA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IHRydWU7CgogICAgICAvLyBHZW5lcmF0ZSB0aGUgY2hhbmdlcyB0byBiZSB0cmlnZ2VyZWQgb24gdGhlIG1vZGVsLgogICAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLl9jb21wdXRlQ2hhbmdlcyh0cnVlKTsKCiAgICAgIHRoaXMuX3BlbmRpbmcgPSAhIXRyaWdnZXJzLmxlbmd0aDsKCiAgICAgIGZvciAodmFyIGkgPSB0cmlnZ2Vycy5sZW5ndGggLSAyOyBpID49IDA7IGkgLT0gMikgewogICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyB0cmlnZ2Vyc1tpXSwgdGhpcywgdHJpZ2dlcnNbaSArIDFdLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYSBgY2hhbmdlYCB3aGlsZSB0aGVyZSBoYXZlIGJlZW4gY2hhbmdlcy4KICAgICAgd2hpbGUgKHRoaXMuX3BlbmRpbmcpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIG1vZGVsIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoIXRoaXMuX2hhc0NvbXB1dGVkKSB0aGlzLl9jb21wdXRlQ2hhbmdlcygpOwogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgIH0sCgogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlLCBvbGQgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAoKICAgIC8vIExvb2tpbmcgYXQgdGhlIGJ1aWx0IHVwIGxpc3Qgb2YgYHNldGAgYXR0cmlidXRlIGNoYW5nZXMsIGNvbXB1dGUgaG93CiAgICAvLyBtYW55IG9mIHRoZSBhdHRyaWJ1dGVzIGhhdmUgYWN0dWFsbHkgY2hhbmdlZC4gSWYgYGxvdWRgLCByZXR1cm4gYQogICAgLy8gYm9pbGVkLWRvd24gbGlzdCBvZiBvbmx5IHRoZSByZWFsIGNoYW5nZXMuCiAgICBfY29tcHV0ZUNoYW5nZXM6IGZ1bmN0aW9uKGxvdWQpIHsKICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIHZhciBhbHJlYWR5ID0ge307CiAgICAgIHZhciB0cmlnZ2VycyA9IFtdOwogICAgICAvLyBXQVJOOiBtb25rZXkgcGF0Y2ggZm9yIDAuOS45LCB3aWxsIGdvIGF3YXkgd2hlbiB1cGdyYWRpbmcKICAgICAgLy8gdG8gZnV0dXJlIHZlcnNpb24gb2YgYmFja2JvbmUKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50QXR0cmlidXRlcyB8fCB7fTsKICAgICAgdmFyIGNoYW5nZXMgPSB0aGlzLl9jaGFuZ2VzOwoKICAgICAgLy8gTG9vcCB0aHJvdWdoIHRoZSBjdXJyZW50IHF1ZXVlIG9mIHBvdGVudGlhbCBtb2RlbCBjaGFuZ2VzLgogICAgICBmb3IgKHZhciBpID0gY2hhbmdlcy5sZW5ndGggLSAyOyBpID49IDA7IGkgLT0gMikgewogICAgICAgIHZhciBrZXkgPSBjaGFuZ2VzW2ldLCB2YWwgPSBjaGFuZ2VzW2kgKyAxXTsKICAgICAgICBpZiAoYWxyZWFkeVtrZXldKSBjb250aW51ZTsKICAgICAgICBhbHJlYWR5W2tleV0gPSB0cnVlOwoKICAgICAgICAvLyBDaGVjayBpZiB0aGUgYXR0cmlidXRlIGhhcyBiZWVuIG1vZGlmaWVkIHNpbmNlIHRoZSBsYXN0IGNoYW5nZSwKICAgICAgICAvLyBhbmQgdXBkYXRlIGB0aGlzLmNoYW5nZWRgIGFjY29yZGluZ2x5LiBJZiB3ZSdyZSBpbnNpZGUgb2YgYSBgY2hhbmdlYAogICAgICAgIC8vIGNhbGwsIGFsc28gYWRkIGEgdHJpZ2dlciB0byB0aGUgbGlzdC4KICAgICAgICBpZiAoY3VycmVudFtrZXldICE9PSB2YWwpIHsKICAgICAgICAgIHRoaXMuY2hhbmdlZFtrZXldID0gdmFsOwogICAgICAgICAgaWYgKCFsb3VkKSBjb250aW51ZTsKICAgICAgICAgIHRyaWdnZXJzLnB1c2goa2V5LCB2YWwpOwogICAgICAgICAgY3VycmVudFtrZXldID0gdmFsOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobG91ZCkgdGhpcy5fY2hhbmdlcyA9IFtdOwoKICAgICAgLy8gU2lnbmFscyBgdGhpcy5jaGFuZ2VkYCBpcyBjdXJyZW50IHRvIHByZXZlbnQgZHVwbGljYXRlIGNhbGxzIGZyb20gYHRoaXMuaGFzQ2hhbmdlZGAuCiAgICAgIHRoaXMuX2hhc0NvbXB1dGVkID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRyaWdnZXJzOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgbW9kZWwgYXR0cmlidXRlcywKICAgIC8vIHJldHVybmluZyBgdHJ1ZWAgaWYgYWxsIGlzIHdlbGwuIElmIGEgc3BlY2lmaWMgYGVycm9yYCBjYWxsYmFjayBoYXMKICAgIC8vIGJlZW4gcGFzc2VkLCBjYWxsIHRoYXQgaW5zdGVhZCBvZiBmaXJpbmcgdGhlIGdlbmVyYWwgYCJlcnJvciJgIGV2ZW50LgogICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0ZShhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmVycm9yKSBvcHRpb25zLmVycm9yKHRoaXMsIGVycm9yLCBvcHRpb25zKTsKICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIHRoaXMsIGVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUHJvdmlkZXMgYSBzdGFuZGFyZCBjb2xsZWN0aW9uIGNsYXNzIGZvciBvdXIgc2V0cyBvZiBtb2RlbHMsIG9yZGVyZWQKICAvLyBvciB1bm9yZGVyZWQuIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbgogIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogIH07CgogIC8vIERlZmluZSB0aGUgQ29sbGVjdGlvbidzIGluaGVyaXRhYmxlIG1ldGhvZHMuCiAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGZvciBhIGNvbGxlY3Rpb24gaXMganVzdCBhICoqQmFja2JvbmUuTW9kZWwqKi4KICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KICAgIG1vZGVsOiBNb2RlbCwKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUKICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24obW9kZWwpeyByZXR1cm4gbW9kZWwudG9KU09OKG9wdGlvbnMpOyB9KTsKICAgIH0sCgogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCiAgICBzeW5jOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuIFBhc3MgKipzaWxlbnQqKiB0byBhdm9pZAogICAgLy8gZmlyaW5nIHRoZSBgYWRkYCBldmVudCBmb3IgZXZlcnkgbmV3IG1vZGVsLgogICAgYWRkOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgdmFyIGksIGFyZ3MsIGxlbmd0aCwgbW9kZWwsIGV4aXN0aW5nLCBuZWVkc1NvcnQ7CiAgICAgIHZhciBhdCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5hdDsKICAgICAgdmFyIHNvcnQgPSAoKG9wdGlvbnMgJiYgb3B0aW9ucy5zb3J0KSA9PSBudWxsID8gdHJ1ZSA6IG9wdGlvbnMuc29ydCk7CiAgICAgIG1vZGVscyA9IF8uaXNBcnJheShtb2RlbHMpID8gbW9kZWxzLnNsaWNlKCkgOiBbbW9kZWxzXTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gbW9kZWxzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgaWYoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbHNbaV0sIG9wdGlvbnMpKSkgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCJlcnJvciIsIHRoaXMsIG1vZGVsc1tpXSwgb3B0aW9ucyk7CiAgICAgICAgICBtb2RlbHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIG1vZGVsc1tpXSA9IG1vZGVsOwoKICAgICAgICBleGlzdGluZyA9IG1vZGVsLmlkICE9IG51bGwgJiYgdGhpcy5fYnlJZFttb2RlbC5pZF07CiAgICAgICAgLy8gSWYgYSBkdXBsaWNhdGUgaXMgZm91bmQsIHByZXZlbnQgaXQgZnJvbSBiZWluZyBhZGRlZCBhbmQKICAgICAgICAvLyBvcHRpb25hbGx5IG1lcmdlIGl0IGludG8gdGhlIGV4aXN0aW5nIG1vZGVsLgogICAgICAgIGlmIChleGlzdGluZyB8fCB0aGlzLl9ieUNpZFttb2RlbC5jaWRdKSB7CiAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLm1lcmdlICYmIGV4aXN0aW5nKSB7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChtb2RlbC5hdHRyaWJ1dGVzLCBvcHRpb25zKTsKICAgICAgICAgICAgbmVlZHNTb3J0ID0gc29ydDsKICAgICAgICAgIH0KICAgICAgICAgIG1vZGVscy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIC8vIExpc3RlbiB0byBhZGRlZCBtb2RlbHMnIGV2ZW50cywgYW5kIGluZGV4IG1vZGVscyBmb3IgbG9va3VwIGJ5CiAgICAgICAgLy8gYGlkYCBhbmQgYnkgYGNpZGAuCiAgICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICAgICAgdGhpcy5fYnlDaWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CgogICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICAgIGlmIChtb2RlbHMubGVuZ3RoKSBuZWVkc1NvcnQgPSBzb3J0OwogICAgICB0aGlzLmxlbmd0aCArPSBtb2RlbHMubGVuZ3RoOwogICAgICBhcmdzID0gW2F0ICE9IG51bGwgPyBhdCA6IHRoaXMubW9kZWxzLmxlbmd0aCwgMF07CiAgICAgIHB1c2guYXBwbHkoYXJncywgbW9kZWxzKTsKICAgICAgc3BsaWNlLmFwcGx5KHRoaXMubW9kZWxzLCBhcmdzKTsKCiAgICAgIC8vIFNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChuZWVkc1NvcnQgJiYgdGhpcy5jb21wYXJhdG9yICYmIGF0ID09IG51bGwpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CgogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBUcmlnZ2VyIGBhZGRgIGV2ZW50cy4KICAgICAgd2hpbGUgKG1vZGVsID0gbW9kZWxzLnNoaWZ0KCkpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdhZGQnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuIFBhc3Mgc2lsZW50IHRvIGF2b2lkCiAgICAvLyBmaXJpbmcgdGhlIGByZW1vdmVgIGV2ZW50IGZvciBldmVyeSBtb2RlbCByZW1vdmVkLgogICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgbW9kZWxzID0gXy5pc0FycmF5KG1vZGVscykgPyBtb2RlbHMuc2xpY2UoKSA6IFttb2RlbHNdOwogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG1vZGVsID0gdGhpcy5nZXQobW9kZWxzW2ldKTsKICAgICAgICBpZiAoIW1vZGVsKSBjb250aW51ZTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5pZF07CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5Q2lkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KHRoaXMubGVuZ3RoIC0gMSk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHNoaWZ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICBzbGljZTogZnVuY3Rpb24oYmVnaW4sIGVuZCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHMuc2xpY2UoYmVnaW4sIGVuZCk7CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgIGdldDogZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqLmlkICE9IG51bGwgPyBvYmouaWQgOiBvYmpdIHx8IHRoaXMuX2J5Q2lkW29iai5jaWQgfHwgb2JqXTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsKICAgIH0sCgogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mIGBmaWx0ZXJgLgogICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzKSB7CiAgICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gW107CiAgICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbihtb2RlbCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc29ydCBhIHNldCB3aXRob3V0IGEgY29tcGFyYXRvcicpOwogICAgICB9CgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucyB8fCAhb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBTbWFydGx5IHVwZGF0ZSBhIGNvbGxlY3Rpb24gd2l0aCBhIGNoYW5nZSBzZXQgb2YgbW9kZWxzLCBhZGRpbmcsCiAgICAvLyByZW1vdmluZywgYW5kIG1lcmdpbmcgYXMgbmVjZXNzYXJ5LgogICAgdXBkYXRlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsLCBpLCBsLCBleGlzdGluZzsKICAgICAgdmFyIGFkZCA9IFtdLCByZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKICAgICAgdmFyIGlkQXR0ciA9IHRoaXMubW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlOwogICAgICBvcHRpb25zID0gXy5leHRlbmQoe2FkZDogdHJ1ZSwgbWVyZ2U6IHRydWUsIHJlbW92ZTogdHJ1ZX0sIG9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMpOwoKICAgICAgLy8gQWxsb3cgYSBzaW5nbGUgbW9kZWwgKG9yIG5vIGFyZ3VtZW50KSB0byBiZSBwYXNzZWQuCiAgICAgIGlmICghXy5pc0FycmF5KG1vZGVscykpIG1vZGVscyA9IG1vZGVscyA/IFttb2RlbHNdIDogW107CgogICAgICAvLyBQcm94eSB0byBgYWRkYCBmb3IgdGhpcyBjYXNlLCBubyBuZWVkIHRvIGl0ZXJhdGUuLi4KICAgICAgaWYgKG9wdGlvbnMuYWRkICYmICFvcHRpb25zLnJlbW92ZSkgcmV0dXJuIHRoaXMuYWRkKG1vZGVscywgb3B0aW9ucyk7CgogICAgICAvLyBEZXRlcm1pbmUgd2hpY2ggbW9kZWxzIHRvIGFkZCBhbmQgbWVyZ2UsIGFuZCB3aGljaCB0byByZW1vdmUuCiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV07CiAgICAgICAgZXhpc3RpbmcgPSB0aGlzLmdldChtb2RlbC5pZCB8fCBtb2RlbC5jaWQgfHwgbW9kZWxbaWRBdHRyXSk7CiAgICAgICAgaWYgKG9wdGlvbnMucmVtb3ZlICYmIGV4aXN0aW5nKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICBpZiAoKG9wdGlvbnMuYWRkICYmICFleGlzdGluZykgfHwgKG9wdGlvbnMubWVyZ2UgJiYgZXhpc3RpbmcpKSB7CiAgICAgICAgICBhZGQucHVzaChtb2RlbCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnJlbW92ZSkgewogICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIG1vZGVsID0gdGhpcy5tb2RlbHNbaV07CiAgICAgICAgICBpZiAoIW1vZGVsTWFwW21vZGVsLmNpZF0pIHJlbW92ZS5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBtb2RlbHMgKGlmIGFwcGxpY2FibGUpIGJlZm9yZSB3ZSBhZGQgYW5kIG1lcmdlIHRoZSByZXN0LgogICAgICBpZiAocmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUocmVtb3ZlLCBvcHRpb25zKTsKICAgICAgaWYgKGFkZC5sZW5ndGgpIHRoaXMuYWRkKGFkZCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBXaGVuIHlvdSBoYXZlIG1vcmUgaXRlbXMgdGhhbiB5b3Ugd2FudCB0byBhZGQgb3IgcmVtb3ZlIGluZGl2aWR1YWxseSwKICAgIC8vIHlvdSBjYW4gcmVzZXQgdGhlIGVudGlyZSBzZXQgd2l0aCBhIG5ldyBsaXN0IG9mIG1vZGVscywgd2l0aG91dCBmaXJpbmcKICAgIC8vIGFueSBgYWRkYCBvciBgcmVtb3ZlYCBldmVudHMuIEZpcmVzIGByZXNldGAgd2hlbiBmaW5pc2hlZC4KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0pOwogICAgICB9CiAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgaWYgKG1vZGVscykgdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYGFkZDogdHJ1ZWAgaXMgcGFzc2VkLCBhcHBlbmRzIHRoZQogICAgLy8gbW9kZWxzIHRvIHRoZSBjb2xsZWN0aW9uIGluc3RlYWQgb2YgcmVzZXR0aW5nLgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwLCBzdGF0dXMsIHhocikgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnVwZGF0ZSA/ICd1cGRhdGUnIDogJ3Jlc2V0JzsKICAgICAgICBjb2xsZWN0aW9uW21ldGhvZF0ocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24obW9kZWwsIHJlc3AsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICBtb2RlbC5zYXZlKG51bGwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gYSBsaXN0IG9mIG1vZGVscyB0byBiZSBhZGRlZCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5tb2RlbHMpOwogICAgfSwKCiAgICAvLyBQcm94eSB0byBfJ3MgY2hhaW4uIENhbid0IGJlIHByb3hpZWQgdGhlIHNhbWUgd2F5IHRoZSByZXN0IG9mIHRoZQogICAgLy8gdW5kZXJzY29yZSBtZXRob2RzIGFyZSBwcm94aWVkIGJlY2F1c2UgaXQgcmVsaWVzIG9uIHRoZSB1bmRlcnNjb3JlCiAgICAvLyBjb25zdHJ1Y3Rvci4KICAgIGNoYWluOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8odGhpcy5tb2RlbHMpLmNoYWluKCk7CiAgICB9LAoKICAgIC8vIFJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24gaXMgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzID0gW107CiAgICAgIHRoaXMuX2J5SWQgID0ge307CiAgICAgIHRoaXMuX2J5Q2lkID0ge307CiAgICB9LAoKICAgIC8vIFByZXBhcmUgYSBtb2RlbCBvciBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYWRkZWQgdG8gdGhpcyBjb2xsZWN0aW9uLgogICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKICAgICAgICBpZiAoIWF0dHJzLmNvbGxlY3Rpb24pIGF0dHJzLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICAgIHJldHVybiBhdHRyczsKICAgICAgfQogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byByZW1vdmUgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCiAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsCiAgICAnbWF4JywgJ21pbicsICdzb3J0ZWRJbmRleCcsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywKICAgICdpbml0aWFsJywgJ3Jlc3QnLCAndGFpbCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnaW5kZXhPZicsICdzaHVmZmxlJywKICAgICdsYXN0SW5kZXhPZicsICdpc0VtcHR5J107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5tb2RlbHMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCiAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbJ2dyb3VwQnknLCAnY291bnRCeScsICdzb3J0QnknXTsKCiAgLy8gVXNlIGF0dHJpYnV0ZXMgaW5zdGVhZCBvZiBwcm9wZXJ0aWVzLgogIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih2YWx1ZSwgY29udGV4dCkgewogICAgICB2YXIgaXRlcmF0b3IgPSBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwogICAgICB9OwogICAgICByZXR1cm4gX1ttZXRob2RdKHRoaXMubW9kZWxzLCBpdGVyYXRvciwgY29udGV4dCk7CiAgICB9OwogIH0pOwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvOlx3Ky9nOwogIHZhciBzcGxhdFBhcmFtICAgID0gL1wqXHcrL2c7CiAgdmFyIGVzY2FwZVJlZ0V4cCAgPSAvW1wte31cW1xdKz8uLFxcXF4kfCNcc10vZzsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlJvdXRlcioqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoUm91dGVyLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyBNYW51YWxseSBiaW5kIGEgc2luZ2xlIG5hbWVkIHJvdXRlIHRvIGEgY2FsbGJhY2suIEZvciBleGFtcGxlOgogICAgLy8KICAgIC8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsKICAgIC8vICAgICAgIC4uLgogICAgLy8gICAgIH0pOwogICAgLy8KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgaWYgKCFfLmlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKICAgICAgaWYgKCFjYWxsYmFjaykgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwogICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBfLmJpbmQoZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgICB2YXIgYXJncyA9IHRoaXMuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHRoaXMsIG5hbWUsIGFyZ3MpOwogICAgICB9LCB0aGlzKSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgogICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CiAgICAgIHZhciByb3V0ZSwgcm91dGVzID0gXy5rZXlzKHRoaXMucm91dGVzKTsKICAgICAgd2hpbGUgKChyb3V0ZSA9IHJvdXRlcy5wb3AoKSkgIT0gbnVsbCkgewogICAgICAgIHRoaXMucm91dGUocm91dGUsIHRoaXMucm91dGVzW3JvdXRlXSk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKICAgIC8vIGFnYWluc3QgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaC4KICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbihyb3V0ZSkgewogICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShvcHRpb25hbFBhcmFtLCAnKD86JDEpPycpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShuYW1lZFBhcmFtLCAnKFteXC9dKyknKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyguKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIHBhcmFtZXRlcnMuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICByZXR1cm4gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5IaXN0b3J5CiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBVUkwgZnJhZ21lbnRzLiBJZiB0aGUKICAvLyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgYG9uaGFzaGNoYW5nZWAsIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KICB2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKICAgIF8uYmluZEFsbCh0aGlzLCAnY2hlY2tVcmwnKTsKCiAgICAvLyBFbnN1cmUgdGhhdCBgSGlzdG9yeWAgY2FuIGJlIHVzZWQgb3V0c2lkZSBvZiB0aGUgYnJvd3Nlci4KICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgICB0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKICAgIH0KICB9OwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBhIGxlYWRpbmcgaGFzaC9zbGFzaCBhbmQgdHJhaWxpbmcgc3BhY2UuCiAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcy4KICB2YXIgcm9vdFN0cmlwcGVyID0gL15cLyt8XC8rJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgogIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgogIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CgogIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgIGludGVydmFsOiA1MCwKCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewogICAgICB2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewogICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lOwogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc3Vic3RyKHJvb3QubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgfSwKCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7fSwge3Jvb3Q6ICcvJ30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CiAgICAgIHRoaXMucm9vdCAgICAgICAgICAgICA9IHRoaXMub3B0aW9ucy5yb290OwogICAgICB0aGlzLl93YW50c0hhc2hDaGFuZ2UgPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CiAgICAgIHRoaXMuX3dhbnRzUHVzaFN0YXRlICA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKICAgICAgdGhpcy5faGFzUHVzaFN0YXRlICAgID0gISEodGhpcy5vcHRpb25zLnB1c2hTdGF0ZSAmJiB0aGlzLmhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5LnB1c2hTdGF0ZSk7CiAgICAgIHZhciBmcmFnbWVudCAgICAgICAgICA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgdmFyIGRvY01vZGUgICAgICAgICAgID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwogICAgICB2YXIgb2xkSUUgICAgICAgICAgICAgPSAoaXNFeHBsb3Jlci5leGVjKG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSkgJiYgKCFkb2NNb2RlIHx8IGRvY01vZGUgPD0gNykpOwoKICAgICAgLy8gTm9ybWFsaXplIHJvb3QgdG8gYWx3YXlzIGluY2x1ZGUgYSBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaC4KICAgICAgdGhpcy5yb290ID0gKCcvJyArIHRoaXMucm9vdCArICcvJykucmVwbGFjZShyb290U3RyaXBwZXIsICcvJyk7CgogICAgICBpZiAob2xkSUUgJiYgdGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5pZnJhbWUgPSBCYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiIC8+JykuaGlkZSgpLmFwcGVuZFRvKCdib2R5JylbMF0uY29udGVudFdpbmRvdzsKICAgICAgICB0aGlzLm5hdmlnYXRlKGZyYWdtZW50KTsKICAgICAgfQoKICAgICAgLy8gRGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmUgdXNpbmcgcHVzaFN0YXRlIG9yIGhhc2hlcywgYW5kIHdoZXRoZXIKICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykuYmluZCgncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLmJpbmQoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl9jaGVja1VybEludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5jaGVja1VybCwgdGhpcy5pbnRlcnZhbCk7CiAgICAgIH0KCiAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCiAgICAgIC8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4KICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKICAgICAgdmFyIGF0Um9vdCA9IGxvYy5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKCiAgICAgIC8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb2ZmIHdpdGggYSByb3V0ZSBmcm9tIGEgYHB1c2hTdGF0ZWAtZW5hYmxlZCBicm93c2VyLAogICAgICAvLyBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLgogICAgICBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmIHRoaXMuX3dhbnRzUHVzaFN0YXRlICYmICF0aGlzLl9oYXNQdXNoU3RhdGUgJiYgIWF0Um9vdCkgewogICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwogICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgIC8vIFJldHVybiBpbW1lZGlhdGVseSBhcyBicm93c2VyIHdpbGwgZG8gcmVkaXJlY3QgdG8gbmV3IHVybAogICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgLy8gaW4gYSBicm93c2VyIHdoZXJlIGl0IGNvdWxkIGJlIGBwdXNoU3RhdGVgLWJhc2VkIGluc3RlYWQuLi4KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c1B1c2hTdGF0ZSAmJiB0aGlzLl9oYXNQdXNoU3RhdGUgJiYgYXRSb290ICYmIGxvYy5oYXNoKSB7CiAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50ICsgbG9jLnNlYXJjaCk7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwogICAgfSwKCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIEJhY2tib25lLiQod2luZG93KS51bmJpbmQoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkudW5iaW5kKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCk7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwogICAgfSwKCiAgICAvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCiAgICAvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLgogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBjYWxsYmFjaykgewogICAgICB0aGlzLmhhbmRsZXJzLnVuc2hpZnQoe3JvdXRlOiByb3V0ZSwgY2FsbGJhY2s6IGNhbGxiYWNrfSk7CiAgICB9LAoKICAgIC8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAogICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCiAgICBjaGVja1VybDogZnVuY3Rpb24oZSkgewogICAgICB2YXIgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsKICAgICAgICBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKTsKICAgICAgfQogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAodGhpcy5pZnJhbWUpIHRoaXMubmF2aWdhdGUoY3VycmVudCk7CiAgICAgIHRoaXMubG9hZFVybCgpIHx8IHRoaXMubG9hZFVybCh0aGlzLmdldEhhc2goKSk7CiAgICB9LAoKICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCiAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAogICAgLy8gcmV0dXJucyBgZmFsc2VgLgogICAgbG9hZFVybDogZnVuY3Rpb24oZnJhZ21lbnRPdmVycmlkZSkgewogICAgICB2YXIgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudE92ZXJyaWRlKTsKICAgICAgdmFyIG1hdGNoZWQgPSBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKICAgICAgICAgIGhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICB9LAoKICAgIC8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUKICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKICAgIC8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgogICAgLy8KICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKICAgIC8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCiAgICAvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIGlmICghSGlzdG9yeS5zdGFydGVkKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zID09PSB0cnVlKSBvcHRpb25zID0ge3RyaWdnZXI6IG9wdGlvbnN9OwogICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpOwogICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICB2YXIgdXJsID0gdGhpcy5yb290ICsgZnJhZ21lbnQ7CgogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCiAgICAgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCiAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewogICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhCiAgICAgICAgICAvLyBoaXN0b3J5IGVudHJ5IG9uIGhhc2gtdGFnIGNoYW5nZS4gIFdoZW4gcmVwbGFjZSBpcyB0cnVlLCB3ZSBkb24ndAogICAgICAgICAgLy8gd2FudCB0aGlzLgogICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9CgogICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KICAgICAgLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKICAgIH0sCgogICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgewogICAgICBpZiAocmVwbGFjZSkgewogICAgICAgIHZhciBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CiAgICAgICAgbG9jYXRpb24ucmVwbGFjZShocmVmICsgJyMnICsgZnJhZ21lbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNvbWUgYnJvd3NlcnMgcmVxdWlyZSB0aGF0IGBoYXNoYCBjb250YWlucyBhIGxlYWRpbmcgIy4KICAgICAgICBsb2NhdGlvbi5oYXNoID0gJyMnICsgZnJhZ21lbnQ7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5LgogIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeTsKCiAgLy8gQmFja2JvbmUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgIHRoaXMuX2NvbmZpZ3VyZShvcHRpb25zIHx8IHt9KTsKICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogIH07CgogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLgogIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KICB2YXIgdmlld09wdGlvbnMgPSBbJ21vZGVsJywgJ2NvbGxlY3Rpb24nLCAnZWwnLCAnaWQnLCAnYXR0cmlidXRlcycsICdjbGFzc05hbWUnLCAndGFnTmFtZScsICdldmVudHMnXTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBgdGFnTmFtZWAgb2YgYSBWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLgogICAgdGFnTmFtZTogJ2RpdicsCgogICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlCiAgICAvLyBjdXJyZW50IHZpZXcuIFRoaXMgc2hvdWxkIGJlIHByZWZlcmVkIHRvIGdsb2JhbCBsb29rdXBzIHdoZXJlIHBvc3NpYmxlLgogICAgJDogZnVuY3Rpb24oc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMuJGVsLmZpbmQoc2VsZWN0b3IpOwogICAgfSwKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vICoqcmVuZGVyKiogaXMgdGhlIGNvcmUgZnVuY3Rpb24gdGhhdCB5b3VyIHZpZXcgc2hvdWxkIG92ZXJyaWRlLCBpbiBvcmRlcgogICAgLy8gdG8gcG9wdWxhdGUgaXRzIGVsZW1lbnQgKGB0aGlzLmVsYCksIHdpdGggdGhlIGFwcHJvcHJpYXRlIEhUTUwuIFRoZQogICAgLy8gY29udmVudGlvbiBpcyBmb3IgKipyZW5kZXIqKiB0byBhbHdheXMgcmV0dXJuIGB0aGlzYC4KICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgdGhpcyB2aWV3IGJ5IHRha2luZyB0aGUgZWxlbWVudCBvdXQgb2YgdGhlIERPTSwgYW5kIHJlbW92aW5nIGFueQogICAgLy8gYXBwbGljYWJsZSBCYWNrYm9uZS5FdmVudHMgbGlzdGVuZXJzLgogICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwucmVtb3ZlKCk7CiAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRm9yIHNtYWxsIGFtb3VudHMgb2YgRE9NIEVsZW1lbnRzLCB3aGVyZSBhIGZ1bGwtYmxvd24gdGVtcGxhdGUgaXNuJ3QKICAgIC8vIG5lZWRlZCwgdXNlICoqbWFrZSoqIHRvIG1hbnVmYWN0dXJlIGVsZW1lbnRzLCBvbmUgYXQgYSB0aW1lLgogICAgLy8KICAgIC8vICAgICB2YXIgZWwgPSB0aGlzLm1ha2UoJ2xpJywgeydjbGFzcyc6ICdyb3cnfSwgdGhpcy5tb2RlbC5lc2NhcGUoJ3RpdGxlJykpOwogICAgLy8KICAgIG1ha2U6IGZ1bmN0aW9uKHRhZ05hbWUsIGF0dHJpYnV0ZXMsIGNvbnRlbnQpIHsKICAgICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTsKICAgICAgaWYgKGF0dHJpYnV0ZXMpIEJhY2tib25lLiQoZWwpLmF0dHIoYXR0cmlidXRlcyk7CiAgICAgIGlmIChjb250ZW50ICE9IG51bGwpIEJhY2tib25lLiQoZWwpLmh0bWwoY29udGVudCk7CiAgICAgIHJldHVybiBlbDsKICAgIH0sCgogICAgLy8gQ2hhbmdlIHRoZSB2aWV3J3MgZWxlbWVudCAoYHRoaXMuZWxgIHByb3BlcnR5KSwgaW5jbHVkaW5nIGV2ZW50CiAgICAvLyByZS1kZWxlZ2F0aW9uLgogICAgc2V0RWxlbWVudDogZnVuY3Rpb24oZWxlbWVudCwgZGVsZWdhdGUpIHsKICAgICAgaWYgKHRoaXMuJGVsKSB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgdGhpcy4kZWwgPSBlbGVtZW50IGluc3RhbmNlb2YgQmFja2JvbmUuJCA/IGVsZW1lbnQgOiBCYWNrYm9uZS4kKGVsZW1lbnQpOwogICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07CiAgICAgIGlmIChkZWxlZ2F0ZSAhPT0gZmFsc2UpIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFNldCBjYWxsYmFja3MsIHdoZXJlIGB0aGlzLmV2ZW50c2AgaXMgYSBoYXNoIG9mCiAgICAvLwogICAgLy8gKnsiZXZlbnQgc2VsZWN0b3IiOiAiY2FsbGJhY2sifSoKICAgIC8vCiAgICAvLyAgICAgewogICAgLy8gICAgICAgJ21vdXNlZG93biAudGl0bGUnOiAgJ2VkaXQnLAogICAgLy8gICAgICAgJ2NsaWNrIC5idXR0b24nOiAgICAgJ3NhdmUnCiAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CiAgICAvLyAgICAgfQogICAgLy8KICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgogICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgogICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCiAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm47CiAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICBmb3IgKHZhciBrZXkgaW4gZXZlbnRzKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOwogICAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIG1ldGhvZCA9IHRoaXNbZXZlbnRzW2tleV1dOwogICAgICAgIGlmICghbWV0aG9kKSB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCAiJyArIGV2ZW50c1trZXldICsgJyIgZG9lcyBub3QgZXhpc3QnKTsKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwuYmluZChldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJGVsLmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8vIENsZWFycyBhbGwgY2FsbGJhY2tzIHByZXZpb3VzbHkgYm91bmQgdG8gdGhlIHZpZXcgd2l0aCBgZGVsZWdhdGVFdmVudHNgLgogICAgLy8gWW91IHVzdWFsbHkgZG9uJ3QgbmVlZCB0byB1c2UgdGhpcywgYnV0IG1heSB3aXNoIHRvIGlmIHlvdSBoYXZlIG11bHRpcGxlCiAgICAvLyBCYWNrYm9uZSB2aWV3cyBhdHRhY2hlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudC4KICAgIHVuZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC51bmJpbmQoJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZCk7CiAgICB9LAoKICAgIC8vIFBlcmZvcm1zIHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24gb2YgYSBWaWV3IHdpdGggYSBzZXQgb2Ygb3B0aW9ucy4KICAgIC8vIEtleXMgd2l0aCBzcGVjaWFsIG1lYW5pbmcgKihtb2RlbCwgY29sbGVjdGlvbiwgaWQsIGNsYXNzTmFtZSkqLCBhcmUKICAgIC8vIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSB2aWV3LgogICAgX2NvbmZpZ3VyZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAodGhpcy5vcHRpb25zKSBvcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOwogICAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0sCgogICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCiAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKICAgIC8vIG1hdGNoaW5nIGVsZW1lbnQsIGFuZCByZS1hc3NpZ24gaXQgdG8gYGVsYC4gT3RoZXJ3aXNlLCBjcmVhdGUKICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CiAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSBhdHRyc1snY2xhc3MnXSA9IF8ucmVzdWx0KHRoaXMsICdjbGFzc05hbWUnKTsKICAgICAgICB0aGlzLnNldEVsZW1lbnQodGhpcy5tYWtlKF8ucmVzdWx0KHRoaXMsICd0YWdOYW1lJyksIGF0dHJzKSwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBCYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4KICB2YXIgbWV0aG9kTWFwID0gewogICAgJ2NyZWF0ZSc6ICdQT1NUJywKICAgICd1cGRhdGUnOiAnUFVUJywKICAgICdwYXRjaCc6ICAnUEFUQ0gnLAogICAgJ2RlbGV0ZSc6ICdERUxFVEUnLAogICAgJ3JlYWQnOiAgICdHRVQnCiAgfTsKCiAgLy8gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiB0byBjaGFuZ2UgdGhlIG1hbm5lciBpbiB3aGljaCBCYWNrYm9uZSBwZXJzaXN0cwogIC8vIG1vZGVscyB0byB0aGUgc2VydmVyLiBZb3Ugd2lsbCBiZSBwYXNzZWQgdGhlIHR5cGUgb2YgcmVxdWVzdCwgYW5kIHRoZQogIC8vIG1vZGVsIGluIHF1ZXN0aW9uLiBCeSBkZWZhdWx0LCBtYWtlcyBhIFJFU1RmdWwgQWpheCByZXF1ZXN0CiAgLy8gdG8gdGhlIG1vZGVsJ3MgYHVybCgpYC4gU29tZSBwb3NzaWJsZSBjdXN0b21pemF0aW9ucyBjb3VsZCBiZToKICAvLwogIC8vICogVXNlIGBzZXRUaW1lb3V0YCB0byBiYXRjaCByYXBpZC1maXJlIHVwZGF0ZXMgaW50byBhIHNpbmdsZSByZXF1ZXN0LgogIC8vICogU2VuZCB1cCB0aGUgbW9kZWxzIGFzIFhNTCBpbnN0ZWFkIG9mIEpTT04uCiAgLy8gKiBQZXJzaXN0IG1vZGVscyB2aWEgV2ViU29ja2V0cyBpbnN0ZWFkIG9mIEFqYXguCiAgLy8KICAvLyBUdXJuIG9uIGBCYWNrYm9uZS5lbXVsYXRlSFRUUGAgaW4gb3JkZXIgdG8gc2VuZCBgUFVUYCBhbmQgYERFTEVURWAgcmVxdWVzdHMKICAvLyBhcyBgUE9TVGAsIHdpdGggYSBgX21ldGhvZGAgcGFyYW1ldGVyIGNvbnRhaW5pbmcgdGhlIHRydWUgSFRUUCBtZXRob2QsCiAgLy8gYXMgd2VsbCBhcyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgYm9keSBhcyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAogIC8vIGluc3RlYWQgb2YgYGFwcGxpY2F0aW9uL2pzb25gIHdpdGggdGhlIG1vZGVsIGluIGEgcGFyYW0gbmFtZWQgYG1vZGVsYC4KICAvLyBVc2VmdWwgd2hlbiBpbnRlcmZhY2luZyB3aXRoIHNlcnZlci1zaWRlIGxhbmd1YWdlcyBsaWtlICoqUEhQKiogdGhhdCBtYWtlCiAgLy8gaXQgZGlmZmljdWx0IHRvIHJlYWQgdGhlIGJvZHkgb2YgYFBVVGAgcmVxdWVzdHMuCiAgQmFja2JvbmUuc3luYyA9IGZ1bmN0aW9uKG1ldGhvZCwgbW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciB0eXBlID0gbWV0aG9kTWFwW21ldGhvZF07CgogICAgLy8gRGVmYXVsdCBvcHRpb25zLCB1bmxlc3Mgc3BlY2lmaWVkLgogICAgXy5kZWZhdWx0cyhvcHRpb25zIHx8IChvcHRpb25zID0ge30pLCB7CiAgICAgIGVtdWxhdGVIVFRQOiBCYWNrYm9uZS5lbXVsYXRlSFRUUCwKICAgICAgZW11bGF0ZUpTT046IEJhY2tib25lLmVtdWxhdGVKU09OCiAgICB9KTsKCiAgICAvLyBEZWZhdWx0IEpTT04tcmVxdWVzdCBvcHRpb25zLgogICAgdmFyIHBhcmFtcyA9IHt0eXBlOiB0eXBlLCBkYXRhVHlwZTogJ2pzb24nfTsKCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIGEgVVJMLgogICAgaWYgKCFvcHRpb25zLnVybCkgewogICAgICBwYXJhbXMudXJsID0gXy5yZXN1bHQobW9kZWwsICd1cmwnKSB8fCB1cmxFcnJvcigpOwogICAgfQoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgdGhlIGFwcHJvcHJpYXRlIHJlcXVlc3QgZGF0YS4KICAgIGlmIChvcHRpb25zLmRhdGEgPT0gbnVsbCAmJiBtb2RlbCAmJiAobWV0aG9kID09PSAnY3JlYXRlJyB8fCBtZXRob2QgPT09ICd1cGRhdGUnIHx8IG1ldGhvZCA9PT0gJ3BhdGNoJykpIHsKICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nOwogICAgICBwYXJhbXMuZGF0YSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuYXR0cnMgfHwgbW9kZWwudG9KU09OKG9wdGlvbnMpKTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBKU09OIGJ5IGVuY29kaW5nIHRoZSByZXF1ZXN0IGludG8gYW4gSFRNTC1mb3JtLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCc7CiAgICAgIHBhcmFtcy5kYXRhID0gcGFyYW1zLmRhdGEgPyB7bW9kZWw6IHBhcmFtcy5kYXRhfSA6IHt9OwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEhUVFAgYnkgbWltaWNraW5nIHRoZSBIVFRQIG1ldGhvZCB3aXRoIGBfbWV0aG9kYAogICAgLy8gQW5kIGFuIGBYLUhUVFAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSFRUUCAmJiAodHlwZSA9PT0gJ1BVVCcgfHwgdHlwZSA9PT0gJ0RFTEVURScgfHwgdHlwZSA9PT0gJ1BBVENIJykpIHsKICAgICAgcGFyYW1zLnR5cGUgPSAnUE9TVCc7CiAgICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSBwYXJhbXMuZGF0YS5fbWV0aG9kID0gdHlwZTsKICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9IGZ1bmN0aW9uKHhocikgewogICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLUhUVFAtTWV0aG9kLU92ZXJyaWRlJywgdHlwZSk7CiAgICAgICAgaWYgKGJlZm9yZVNlbmQpIHJldHVybiBiZWZvcmVTZW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CgogICAgLy8gRG9uJ3QgcHJvY2VzcyBkYXRhIG9uIGEgbm9uLUdFVCByZXF1ZXN0LgogICAgaWYgKHBhcmFtcy50eXBlICE9PSAnR0VUJyAmJiAhb3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMucHJvY2Vzc0RhdGEgPSBmYWxzZTsKICAgIH0KCiAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7CiAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKHJlc3AsIHN0YXR1cywgeGhyKTsKICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgIH07CgogICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbih4aHIsIHN0YXR1cywgdGhyb3duKSB7CiAgICAgIGlmIChlcnJvcikgZXJyb3IobW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICAgIG1vZGVsLnRyaWdnZXIoJ2Vycm9yJywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICB9OwoKICAgIC8vIE1ha2UgdGhlIHJlcXVlc3QsIGFsbG93aW5nIHRoZSB1c2VyIHRvIG92ZXJyaWRlIGFueSBBamF4IG9wdGlvbnMuCiAgICB2YXIgeGhyID0gQmFja2JvbmUuYWpheChfLmV4dGVuZChwYXJhbXMsIG9wdGlvbnMpKTsKICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIHJldHVybiB4aHI7CiAgfTsKCiAgLy8gU2V0IHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGBCYWNrYm9uZS5hamF4YCB0byBwcm94eSB0aHJvdWdoIHRvIGAkYC4KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCiAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogIHZhciBleHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgdmFyIHBhcmVudCA9IHRoaXM7CiAgICB2YXIgY2hpbGQ7CgogICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQogICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAogICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogICAgaWYgKHByb3RvUHJvcHMgJiYgXy5oYXMocHJvdG9Qcm9wcywgJ2NvbnN0cnVjdG9yJykpIHsKICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwogICAgfSBlbHNlIHsKICAgICAgY2hpbGQgPSBmdW5jdGlvbigpeyBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICAgIH0KCiAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgIF8uZXh0ZW5kKGNoaWxkLCBwYXJlbnQsIHN0YXRpY1Byb3BzKTsKCiAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbigpeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH07CiAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7CgogICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAvLyBpZiBzdXBwbGllZC4KICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKICAgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQKICAgIC8vIGxhdGVyLgogICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgICByZXR1cm4gY2hpbGQ7CiAgfTsKCiAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KICBNb2RlbC5leHRlbmQgPSBDb2xsZWN0aW9uLmV4dGVuZCA9IFJvdXRlci5leHRlbmQgPSBWaWV3LmV4dGVuZCA9IEhpc3RvcnkuZXh0ZW5kID0gZXh0ZW5kOwoKICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCiAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsKICB9OwoKfSkuY2FsbCh0aGlzKTsKLyoKQ29weXJpZ2h0IChjKSAyMDExLTIwMTMgQFdhbG1hcnRMYWJzCgpQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5Cm9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0bwpkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZQpyaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3IKc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKClRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCmFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoKVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCkZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQpBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCkxJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCkZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIKREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoqLwoKOzsKKGZ1bmN0aW9uKCkgewoKLypnbG9iYWwgY2xvbmVJbmhlcml0VmFycywgY3JlYXRlSW5oZXJpdFZhcnMsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciwgZ2V0VmFsdWUsIGluaGVyaXRWYXJzICovCgovL3N1cHBvcnQgemVwdG8uZm9yRWFjaCBvbiBqUXVlcnkKaWYgKCEkLmZuLmZvckVhY2gpIHsKICAkLmZuLmZvckVhY2ggPSBmdW5jdGlvbihpdGVyYXRvciwgY29udGV4dCkgewogICAgJC5mbi5lYWNoLmNhbGwodGhpcywgZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0IHx8IHRoaXMsIHRoaXMsIGluZGV4KTsKICAgIH0pOwogIH07Cn0KCnZhciB2aWV3TmFtZUF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LW5hbWUnLAogICAgdmlld0NpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LWNpZCcsCiAgICB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctaGVscGVyJzsKCi8vdmlldyBpbnN0YW5jZXMKdmFyIHZpZXdzSW5kZXhlZEJ5Q2lkID0ge307Cgp2YXIgVGhvcmF4ID0gdGhpcy5UaG9yYXggPSB7CiAgVkVSU0lPTjogJzIuMC4wcmMxJywKICB0ZW1wbGF0ZVBhdGhQcmVmaXg6ICcnLAogIHRlbXBsYXRlczoge30sCiAgLy92aWV3IGNsYXNzZXMKICBWaWV3czoge30sCiAgLy9jZXJ0YWluIGVycm9yIHByb25lIHBpZWNlcyBvZiBjb2RlIChvbiBBbmRyb2lkIG9ubHkgaXQgc2VlbXMpCiAgLy9hcmUgd3JhcHBlZCBpbiBhIHRyeSBjYXRjaCBibG9jaywgdGhlbiB0cmlnZ2VyIHRoaXMgaGFuZGxlciBpbgogIC8vdGhlIGNhdGNoLCB3aXRoIHRoZSBuYW1lIG9mIHRoZSBmdW5jdGlvbiBvciBldmVudCB0aGF0IHdhcwogIC8vdHJ5aW5nIHRvIGJlIGV4ZWN1dGVkLiBPdmVycmlkZSB0aGlzIHdpdGggYSBjdXN0b20gaGFuZGxlcgogIC8vdG8gZGVidWcgLyBsb2cgLyBldGMKICBvbkV4Y2VwdGlvbjogZnVuY3Rpb24obmFtZSwgZXJyKSB7CiAgICB0aHJvdyBlcnI7CiAgfQp9OwoKVGhvcmF4LlZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3BvbnNlID0gQmFja2JvbmUuVmlldy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iai5jdG9yKSB7CiAgICAgICAgb2JqLmN0b3IuY2FsbCh0aGlzLCByZXNwb25zZSk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgX2NvbmZpZ3VyZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZCA9IHt9OwogICAgdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkID0ge307CgogICAgLy8gU2V0dXAgb2JqZWN0IGV2ZW50IHRyYWNraW5nCiAgICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgICBzZWxmW29iai5uYW1lXSA9IFtdOwogICAgfSk7CgogICAgdmlld3NJbmRleGVkQnlDaWRbdGhpcy5jaWRdID0gdGhpczsKICAgIHRoaXMuY2hpbGRyZW4gPSB7fTsKICAgIHRoaXMuX3JlbmRlckNvdW50ID0gMDsKCiAgICAvL3RoaXMub3B0aW9ucyBpcyByZW1vdmVkIGluIFRob3JheC5WaWV3LCB3ZSBtZXJnZSBwYXNzZWQKICAgIC8vcHJvcGVydGllcyBkaXJlY3RseSB3aXRoIHRoZSB2aWV3IGFuZCB0ZW1wbGF0ZSBjb250ZXh0CiAgICBfLmV4dGVuZCh0aGlzLCBvcHRpb25zIHx8IHt9KTsKCiAgICAvLyBTZXR1cCBoZWxwZXJzCiAgICBiaW5kSGVscGVycy5jYWxsKHRoaXMpOwoKICAgIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmouY29uZmlndXJlKSB7CiAgICAgICAgb2JqLmNvbmZpZ3VyZS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB0aGlzKTsKICB9LAoKICBzZXRFbGVtZW50IDogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS5zZXRFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLm5hbWUgJiYgdGhpcy4kZWwuYXR0cih2aWV3TmFtZUF0dHJpYnV0ZU5hbWUsIHRoaXMubmFtZSk7CiAgICB0aGlzLiRlbC5hdHRyKHZpZXdDaWRBdHRyaWJ1dGVOYW1lLCB0aGlzLmNpZCk7CiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKCiAgX2FkZENoaWxkOiBmdW5jdGlvbih2aWV3KSB7CiAgICB0aGlzLmNoaWxkcmVuW3ZpZXcuY2lkXSA9IHZpZXc7CiAgICBpZiAoIXZpZXcucGFyZW50KSB7CiAgICAgIHZpZXcucGFyZW50ID0gdGhpczsKICAgIH0KICAgIHRoaXMudHJpZ2dlcignY2hpbGQnLCB2aWV3KTsKICAgIHJldHVybiB2aWV3OwogIH0sCgogIF9yZW1vdmVDaGlsZDogZnVuY3Rpb24odmlldykgewogICAgZGVsZXRlIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdOwogICAgdmlldy5wYXJlbnQgPSBudWxsOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMob3B0aW9ucyB8fCB7fSwgewogICAgICBjaGlsZHJlbjogdHJ1ZQogICAgfSk7CiAgICBfLmVhY2godGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkLCB0aGlzLnVuYmluZERhdGFPYmplY3QsIHRoaXMpOwogICAgdGhpcy50cmlnZ2VyKCdkZXN0cm95ZWQnKTsKICAgIGRlbGV0ZSB2aWV3c0luZGV4ZWRCeUNpZFt0aGlzLmNpZF07CiAgICBfLmVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgdGhpcy5fcmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICBpZiAob3B0aW9ucy5jaGlsZHJlbikgewogICAgICAgIGNoaWxkLmRlc3Ryb3koKTsKICAgICAgfQogICAgfSwgdGhpcyk7CiAgICBpZiAodGhpcy5wYXJlbnQpIHsKICAgICAgdGhpcy5wYXJlbnQuX3JlbW92ZUNoaWxkKHRoaXMpOwogICAgfQogICAgdGhpcy5yZW1vdmUoKTsgLy8gV2lsbCBjYWxsIHN0b3BMaXN0ZW5pbmcoKQogIH0sCgogIHJlbmRlcjogZnVuY3Rpb24ob3V0cHV0KSB7CiAgICB0aGlzLl9wcmV2aW91c0hlbHBlcnMgPSBfLmZpbHRlcih0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgeyByZXR1cm4gY2hpbGQuX2hlbHBlck9wdGlvbnM7IH0pOwoKICAgIHZhciBjaGlsZHJlbiA9IHt9OwogICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkLCBrZXkpIHsKICAgICAgaWYgKCFjaGlsZC5faGVscGVyT3B0aW9ucykgewogICAgICAgIGNoaWxkcmVuW2tleV0gPSBjaGlsZDsKICAgICAgfQogICAgfSk7CiAgICB0aGlzLmNoaWxkcmVuID0gY2hpbGRyZW47CgogICAgaWYgKF8uaXNVbmRlZmluZWQob3V0cHV0KSB8fCAoIV8uaXNFbGVtZW50KG91dHB1dCkgJiYgIVRob3JheC5VdGlsLmlzJChvdXRwdXQpICYmICEob3V0cHV0ICYmIG91dHB1dC5lbCkgJiYgIV8uaXNTdHJpbmcob3V0cHV0KSAmJiAhXy5pc0Z1bmN0aW9uKG91dHB1dCkpKSB7CiAgICAgIC8vIHRyeSBvbmUgbW9yZSB0aW1lIHRvIGFzc2lnbiB0aGUgdGVtcGxhdGUsIGlmIHdlIGRvbid0CiAgICAgIC8vIHlldCBoYXZlIG9uZSB3ZSBtdXN0IHJhaXNlCiAgICAgIGFzc2lnblRlbXBsYXRlLmNhbGwodGhpcywgJ3RlbXBsYXRlJywgewogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgIH0pOwogICAgICBvdXRwdXQgPSB0aGlzLnJlbmRlclRlbXBsYXRlKHRoaXMudGVtcGxhdGUpOwogICAgfSBlbHNlIGlmIChfLmlzRnVuY3Rpb24ob3V0cHV0KSkgewogICAgICBvdXRwdXQgPSB0aGlzLnJlbmRlclRlbXBsYXRlKG91dHB1dCk7CiAgICB9CgogICAgLy8gRGVzdHJveSBhbnkgaGVscGVycyB0aGF0IG1heSBiZSBsaW5nZXJpbmcKICAgIF8uZWFjaCh0aGlzLl9wcmV2aW91c0hlbHBlcnMsIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgIGNoaWxkLmRlc3Ryb3koKTsKICAgICAgY2hpbGQucGFyZW50ID0gdW5kZWZpbmVkOwogICAgfSk7CiAgICB0aGlzLl9wcmV2aW91c0hlbHBlcnMgPSB1bmRlZmluZWQ7CgogICAgLy9hY2NlcHQgYSB2aWV3LCBzdHJpbmcsIEhhbmRsZWJhcnMuU2FmZVN0cmluZyBvciBET00gZWxlbWVudAogICAgdGhpcy5odG1sKChvdXRwdXQgJiYgb3V0cHV0LmVsKSB8fCAob3V0cHV0ICYmIG91dHB1dC5zdHJpbmcpIHx8IG91dHB1dCk7CiAgICArK3RoaXMuX3JlbmRlckNvdW50OwogICAgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZCcpOwogICAgcmV0dXJuIG91dHB1dDsKICB9LAoKICBjb250ZXh0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLmV4dGVuZCh7fSwgKHRoaXMubW9kZWwgJiYgdGhpcy5tb2RlbC5hdHRyaWJ1dGVzKSB8fCB7fSk7CiAgfSwKCiAgX2dldENvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCB0aGlzLCBnZXRWYWx1ZSh0aGlzLCAnY29udGV4dCcpIHx8IHt9KTsKICB9LAoKICAvLyBQcml2YXRlIHZhcmlhYmxlcyBpbiBoYW5kbGViYXJzIC8gb3B0aW9ucy5kYXRhIGluIHRlbXBsYXRlIGhlbHBlcnMKICBfZ2V0RGF0YTogZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuIHsKICAgICAgdmlldzogdGhpcywKICAgICAgY2lkOiBfLnVuaXF1ZUlkKCd0JyksCiAgICAgIHlpZWxkOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBmbiBpcyBzZWVkZWQgYnkgdGVtcGxhdGUgaGVscGVyIHBhc3NpbmcgY29udGV4dCB0byBkYXRhCiAgICAgICAgcmV0dXJuIGRhdGEuZm4gJiYgZGF0YS5mbihkYXRhKTsKICAgICAgfQogICAgfTsKICB9LAoKICBfZ2V0SGVscGVyczogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5oZWxwZXJzKSB7CiAgICAgIHJldHVybiBfLmV4dGVuZCh7fSwgSGFuZGxlYmFycy5oZWxwZXJzLCB0aGlzLmhlbHBlcnMpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIEhhbmRsZWJhcnMuaGVscGVyczsKICAgIH0KCiAgfSwKCiAgcmVuZGVyVGVtcGxhdGU6IGZ1bmN0aW9uKGZpbGUsIGNvbnRleHQsIGlnbm9yZUVycm9ycykgewogICAgdmFyIHRlbXBsYXRlOwogICAgY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwogICAgaWYgKF8uaXNGdW5jdGlvbihmaWxlKSkgewogICAgICB0ZW1wbGF0ZSA9IGZpbGU7CiAgICB9IGVsc2UgewogICAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKGZpbGUsIGlnbm9yZUVycm9ycyk7CiAgICB9CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIHJldHVybiAnJzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0ZW1wbGF0ZShjb250ZXh0LCB7CiAgICAgICAgaGVscGVyczogdGhpcy5fZ2V0SGVscGVycygpLAogICAgICAgIGRhdGE6IHRoaXMuX2dldERhdGEoY29udGV4dCkKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgZW5zdXJlUmVuZGVyZWQ6IGZ1bmN0aW9uKCkgewogICAgIXRoaXMuX3JlbmRlckNvdW50ICYmIHRoaXMucmVuZGVyKCk7CiAgfSwKCiAgYXBwZW5kVG86IGZ1bmN0aW9uKGVsKSB7CiAgICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7CiAgICAkKGVsKS5hcHBlbmQodGhpcy5lbCk7CiAgICB0aGlzLnRyaWdnZXIoJ3JlYWR5Jywge3RhcmdldDogdGhpc30pOwogIH0sCgogIGh0bWw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIGlmIChfLmlzVW5kZWZpbmVkKGh0bWwpKSB7CiAgICAgIHJldHVybiB0aGlzLmVsLmlubmVySFRNTDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEV2ZW50IGZvciBJRSBlbGVtZW50IGZpeGVzCiAgICAgIHRoaXMudHJpZ2dlcignYmVmb3JlOmFwcGVuZCcpOwogICAgICB2YXIgZWxlbWVudCA9IHRoaXMuX3JlcGxhY2VIVE1MKGh0bWwpOwogICAgICB0aGlzLnRyaWdnZXIoJ2FwcGVuZCcpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0KICB9LAoKICBfcmVwbGFjZUhUTUw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIHRoaXMuZWwuaW5uZXJIVE1MID0gIiI7CiAgICByZXR1cm4gdGhpcy4kZWwuYXBwZW5kKGh0bWwpOwogIH0sCgogIF9hbmNob3JDbGljazogZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciB0YXJnZXQgPSAkKGV2ZW50LmN1cnJlbnRUYXJnZXQpLAogICAgICAgIGhyZWYgPSB0YXJnZXQuYXR0cignaHJlZicpOwogICAgLy8gUm91dGUgYW55dGhpbmcgdGhhdCBzdGFydHMgd2l0aCAjIG9yIC8gKGV4Y2x1ZGluZyAvL2RvbWFpbiB1cmxzKQogICAgaWYgKGhyZWYgJiYgKGhyZWZbMF0gPT09ICcjJyB8fCAoaHJlZlswXSA9PT0gJy8nICYmIGhyZWZbMV0gIT09ICcvJykpKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoaHJlZiwgewogICAgICAgIHRyaWdnZXI6IHRydWUKICAgICAgfSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KfSk7CgpUaG9yYXguVmlldy5leHRlbmQgPSBmdW5jdGlvbigpIHsKICBjcmVhdGVJbmhlcml0VmFycyh0aGlzKTsKCiAgdmFyIGNoaWxkID0gQmFja2JvbmUuVmlldy5leHRlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBjaGlsZC5fX3BhcmVudF9fID0gdGhpczsKCiAgcmVzZXRJbmhlcml0VmFycyhjaGlsZCk7CgogIHJldHVybiBjaGlsZDsKfTsKCmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguVmlldywgVGhvcmF4LlZpZXdzKTsKCmZ1bmN0aW9uIGJpbmRIZWxwZXJzKCkgewogIGlmICh0aGlzLmhlbHBlcnMpIHsKICAgIF8uZWFjaCh0aGlzLmhlbHBlcnMsIGZ1bmN0aW9uKGhlbHBlciwgbmFtZSkgewogICAgICB2YXIgdmlldyA9IHRoaXM7CiAgICAgIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgIG9wdGlvbnMgPSBfLmxhc3QoYXJncyk7CiAgICAgICAgb3B0aW9ucy5jb250ZXh0ID0gdGhpczsKICAgICAgICByZXR1cm4gaGVscGVyLmFwcGx5KHZpZXcsIGFyZ3MpOwogICAgICB9OwogICAgfSwgdGhpcyk7CiAgfQp9CgovLyQoc2VsZWN0b3IpLnZpZXcoKSBoZWxwZXIKJC5mbi52aWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHsKICAgIGhlbHBlcjogdHJ1ZQogIH0pOwogIHZhciBzZWxlY3RvciA9ICdbJyArIHZpZXdDaWRBdHRyaWJ1dGVOYW1lICsgJ10nOwogIGlmICghb3B0aW9ucy5oZWxwZXIpIHsKICAgIHNlbGVjdG9yICs9ICc6bm90KFsnICsgdmlld0hlbHBlckF0dHJpYnV0ZU5hbWUgKyAnXSknOwogIH0KICB2YXIgZWwgPSAkKHRoaXMpLmNsb3Nlc3Qoc2VsZWN0b3IpOwogIHJldHVybiAoZWwgJiYgdmlld3NJbmRleGVkQnlDaWRbZWwuYXR0cih2aWV3Q2lkQXR0cmlidXRlTmFtZSldKSB8fCBmYWxzZTsKfTsKCjs7Ci8qZ2xvYmFsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcjp0cnVlLCBjbG9uZUV2ZW50czogdHJ1ZSAqLwpmdW5jdGlvbiBjcmVhdGVSZWdpc3RyeVdyYXBwZXIoa2xhc3MsIGhhc2gpIHsKICB2YXIgJHN1cGVyID0ga2xhc3MuZXh0ZW5kOwogIGtsYXNzLmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGNoaWxkID0gJHN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAoY2hpbGQucHJvdG90eXBlLm5hbWUpIHsKICAgICAgaGFzaFtjaGlsZC5wcm90b3R5cGUubmFtZV0gPSBjaGlsZDsKICAgIH0KICAgIHJldHVybiBjaGlsZDsKICB9Owp9CgpmdW5jdGlvbiByZWdpc3RyeUdldChvYmplY3QsIHR5cGUsIG5hbWUsIGlnbm9yZUVycm9ycykgewogIHZhciB0YXJnZXQgPSBvYmplY3RbdHlwZV0sCiAgICAgIHZhbHVlOwogIGlmIChuYW1lLmluZGV4T2YoJy4nKSA+PSAwKSB7CiAgICB2YXIgYml0cyA9IG5hbWUuc3BsaXQoL1wuLyk7CiAgICBuYW1lID0gYml0cy5wb3AoKTsKICAgIF8uZWFjaChiaXRzLCBmdW5jdGlvbihrZXkpIHsKICAgICAgdGFyZ2V0ID0gdGFyZ2V0W2tleV07CiAgICB9KTsKICB9CiAgdGFyZ2V0ICYmICh2YWx1ZSA9IHRhcmdldFtuYW1lXSk7CiAgaWYgKCF2YWx1ZSAmJiAhaWdub3JlRXJyb3JzKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IodHlwZSArICc6ICcgKyBuYW1lICsgJyBkb2VzIG5vdCBleGlzdC4nKTsKICB9IGVsc2UgewogICAgcmV0dXJuIHZhbHVlOwogIH0KfQoKZnVuY3Rpb24gYXNzaWduVGVtcGxhdGUoYXR0cmlidXRlTmFtZSwgb3B0aW9ucykgewogIHZhciB0ZW1wbGF0ZTsKICAvLyBpZiBhdHRyaWJ1dGUgaXMgdGhlIG5hbWUgb2YgdGVtcGxhdGUgdG8gZmV0Y2gKICBpZiAoXy5pc1N0cmluZyh0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzW2F0dHJpYnV0ZU5hbWVdLCB0cnVlKTsKICAvLyBlbHNlIHRyeSBhbmQgZmV0Y2ggdGhlIHRlbXBsYXRlIGJhc2VkIG9uIHRoZSBuYW1lCiAgfSBlbHNlIGlmICh0aGlzLm5hbWUgJiYgIV8uaXNGdW5jdGlvbih0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLm5hbWUgKyAob3B0aW9ucy5leHRlbnNpb24gfHwgJycpLCB0cnVlKTsKICB9CiAgLy8gQ29sbGVjdGlvblZpZXcgYW5kIExheW91dFZpZXcgaGF2ZSBhIGRlZmF1bHRUZW1wbGF0ZSB0aGF0IG1heSBiZSB1c2VkIGlmIG5vbmUKICAvLyB3YXMgZm91bmQsIHJlZ3VsYXIgdmlld3MgbXVzdCBoYXZlIGEgdGVtcGxhdGUgaWYgcmVuZGVyKCkgaXMgY2FsbGVkCiAgaWYgKCF0ZW1wbGF0ZSAmJiBhdHRyaWJ1dGVOYW1lID09PSAndGVtcGxhdGUnICYmIHRoaXMuX2RlZmF1bHRUZW1wbGF0ZSkgewogICAgdGVtcGxhdGUgPSB0aGlzLl9kZWZhdWx0VGVtcGxhdGU7CiAgfQogIC8vIGlmIHdlIGZvdW5kIHNvbWV0aGluZywgYXNzaWduIGl0CiAgaWYgKHRlbXBsYXRlICYmICFfLmlzRnVuY3Rpb24odGhpc1thdHRyaWJ1dGVOYW1lXSkpIHsKICAgIHRoaXNbYXR0cmlidXRlTmFtZV0gPSB0ZW1wbGF0ZTsKICB9CiAgLy8gaWYgbm90aGluZyB3YXMgZm91bmQgYW5kIGl0J3MgcmVxdWlyZWQsIHRocm93CiAgaWYgKG9wdGlvbnMucmVxdWlyZWQgJiYgIV8uaXNGdW5jdGlvbih0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdWaWV3ICcgKyAodGhpcy5uYW1lIHx8IHRoaXMuY2lkKSArICcgcmVxdWlyZXM6ICcgKyBhdHRyaWJ1dGVOYW1lKTsKICB9Cn0KCi8vIGdldFZhbHVlIGlzIHVzZWQgaW5zdGVhZCBvZiBfLnJlc3VsdCBiZWNhdXNlIHdlCi8vIG5lZWQgYW4gZXh0cmEgc2NvcGUgcGFyYW1ldGVyLCBhbmQgd2lsbCBtaW5pZnkKLy8gYmV0dGVyIHRoYW4gXy5yZXN1bHQKZnVuY3Rpb24gZ2V0VmFsdWUob2JqZWN0LCBwcm9wLCBzY29wZSkgewogIGlmICghKG9iamVjdCAmJiBvYmplY3RbcHJvcF0pKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIF8uaXNGdW5jdGlvbihvYmplY3RbcHJvcF0pCiAgICA/IG9iamVjdFtwcm9wXS5jYWxsKHNjb3BlIHx8IG9iamVjdCkKICAgIDogb2JqZWN0W3Byb3BdOwp9Cgp2YXIgaW5oZXJpdFZhcnMgPSB7fTsKZnVuY3Rpb24gY3JlYXRlSW5oZXJpdFZhcnMoc2VsZikgewogIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgb3VyIHN0YXRpYyBldmVudCBvYmplY3RzCiAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgIGlmICghc2VsZltvYmoubmFtZV0pIHsKICAgICAgc2VsZltvYmoubmFtZV0gPSBbXTsKICAgIH0KICB9KTsKfQpmdW5jdGlvbiByZXNldEluaGVyaXRWYXJzKHNlbGYpIHsKICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIG91ciBzdGF0aWMgZXZlbnQgb2JqZWN0cwogIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICBzZWxmW29iai5uYW1lXSA9IFtdOwogIH0pOwp9CmZ1bmN0aW9uIHdhbGtJbmhlcml0VHJlZShzb3VyY2UsIGZpZWxkTmFtZSwgaXNTdGF0aWMsIGNhbGxiYWNrKSB7CiAgdmFyIHRyZWUgPSBbXTsKICBpZiAoXy5oYXMoc291cmNlLCBmaWVsZE5hbWUpKSB7CiAgICB0cmVlLnB1c2goc291cmNlKTsKICB9CiAgdmFyIGl0ZXJhdGUgPSBzb3VyY2U7CiAgaWYgKGlzU3RhdGljKSB7CiAgICB3aGlsZSAoaXRlcmF0ZSA9IGl0ZXJhdGUuX19wYXJlbnRfXykgewogICAgICBpZiAoXy5oYXMoaXRlcmF0ZSwgZmllbGROYW1lKSkgewogICAgICAgIHRyZWUucHVzaChpdGVyYXRlKTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBpdGVyYXRlID0gaXRlcmF0ZS5jb25zdHJ1Y3RvcjsKICAgIHdoaWxlIChpdGVyYXRlKSB7CiAgICAgIGlmIChpdGVyYXRlLnByb3RvdHlwZSAmJiBfLmhhcyhpdGVyYXRlLnByb3RvdHlwZSwgZmllbGROYW1lKSkgewogICAgICAgIHRyZWUucHVzaChpdGVyYXRlLnByb3RvdHlwZSk7CiAgICAgIH0KICAgICAgaXRlcmF0ZSA9IGl0ZXJhdGUuX19zdXBlcl9fICYmIGl0ZXJhdGUuX19zdXBlcl9fLmNvbnN0cnVjdG9yOwogICAgfQogIH0KCiAgdmFyIGkgPSB0cmVlLmxlbmd0aDsKICB3aGlsZSAoaS0tKSB7CiAgICBfLmVhY2goZ2V0VmFsdWUodHJlZVtpXSwgZmllbGROYW1lLCBzb3VyY2UpLCBjYWxsYmFjayk7CiAgfQp9CgpmdW5jdGlvbiBvYmplY3RFdmVudHModGFyZ2V0LCBldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgaWYgKF8uaXNPYmplY3QoY2FsbGJhY2spKSB7CiAgICB2YXIgc3BlYyA9IGluaGVyaXRWYXJzW2V2ZW50TmFtZV07CiAgICBpZiAoc3BlYyAmJiBzcGVjLmV2ZW50KSB7CiAgICAgIGFkZEV2ZW50cyh0YXJnZXRbJ18nICsgZXZlbnROYW1lICsgJ0V2ZW50cyddLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfQpmdW5jdGlvbiBhZGRFdmVudHModGFyZ2V0LCBzb3VyY2UsIGNvbnRleHQpIHsKICBfLmVhY2goc291cmNlLCBmdW5jdGlvbihjYWxsYmFjaywgZXZlbnROYW1lKSB7CiAgICBpZiAoXy5pc0FycmF5KGNhbGxiYWNrKSkgewogICAgICBfLmVhY2goY2FsbGJhY2ssIGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgdGFyZ2V0LnB1c2goW2V2ZW50TmFtZSwgY2IsIGNvbnRleHRdKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB0YXJnZXQucHVzaChbZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dF0pOwogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBnZXRPcHRpb25zRGF0YShvcHRpb25zKSB7CiAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLmRhdGEpIHsKICAgIHRocm93IG5ldyBFcnJvcignSGFuZGxlYmFycyB0ZW1wbGF0ZSBjb21waWxlZCB3aXRob3V0IGRhdGEsIHVzZTogSGFuZGxlYmFycy5jb21waWxlKHRlbXBsYXRlLCB7ZGF0YTogdHJ1ZX0pJyk7CiAgfQogIHJldHVybiBvcHRpb25zLmRhdGE7Cn0KCi8vIFRoZXNlIHdoaXRlbGlzdGVkIGF0dHJpYnV0ZXMgd2lsbCBiZSB0aGUgb25seSBvbmVzIHBhc3NlZAovLyBmcm9tIHRoZSBvcHRpb25zIGhhc2ggdG8gVGhvcmF4LlV0aWwudGFnCnZhciBodG1sQXR0cmlidXRlc1RvQ29weSA9IFsnaWQnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnXTsKCi8vIEluIGhlbHBlcnMgInRhZ05hbWUiIG9yICJ0YWciIG1heSBiZSBzcGVjaWZpZWQsIGFzIHdlbGwKLy8gYXMgImNsYXNzIiBvciAiY2xhc3NOYW1lIi4gTm9ybWFsaXplIHRvICJ0YWdOYW1lIiBhbmQKLy8gImNsYXNzTmFtZSIgdG8gbWF0Y2ggdGhlIHByb3BlcnR5IG5hbWVzIHVzZWQgYnkgQmFja2JvbmUKLy8galF1ZXJ5LCBldGMuIFNwZWNpYWwgY2FzZSBmb3IgImNsYXNzTmFtZSIgaW4KLy8gVGhvcmF4LlV0aWwudGFnOiB3aWxsIGJlIHJld3JpdHRlbiBhcyAiY2xhc3MiIGluCi8vIGdlbmVyYXRlZCBIVE1MLgpmdW5jdGlvbiBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhvcHRpb25zKSB7CiAgaWYgKG9wdGlvbnMudGFnKSB7CiAgICBvcHRpb25zLnRhZ05hbWUgPSBvcHRpb25zLnRhZzsKICAgIGRlbGV0ZSBvcHRpb25zLnRhZzsKICB9CiAgaWYgKG9wdGlvbnNbJ2NsYXNzJ10pIHsKICAgIG9wdGlvbnMuY2xhc3NOYW1lID0gb3B0aW9uc1snY2xhc3MnXTsKICAgIGRlbGV0ZSBvcHRpb25zWydjbGFzcyddOwogIH0KfQoKVGhvcmF4LlV0aWwgPSB7CiAgZ2V0Vmlld0luc3RhbmNlOiBmdW5jdGlvbihuYW1lLCBhdHRyaWJ1dGVzKSB7CiAgICBhdHRyaWJ1dGVzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIGlmIChfLmlzU3RyaW5nKG5hbWUpKSB7CiAgICAgIHZhciBLbGFzcyA9IHJlZ2lzdHJ5R2V0KFRob3JheCwgJ1ZpZXdzJywgbmFtZSwgZmFsc2UpOwogICAgICByZXR1cm4gS2xhc3MuY2lkID8gXy5leHRlbmQoS2xhc3MsIGF0dHJpYnV0ZXMgfHwge30pIDogbmV3IEtsYXNzKGF0dHJpYnV0ZXMpOwogICAgfSBlbHNlIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgcmV0dXJuIG5ldyBuYW1lKGF0dHJpYnV0ZXMpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgfSwKCiAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uKGZpbGUsIGlnbm9yZUVycm9ycykgewogICAgLy9hcHBlbmQgdGhlIHRlbXBsYXRlIHBhdGggcHJlZml4IGlmIGl0IGlzIG1pc3NpbmcKICAgIHZhciBwYXRoUHJlZml4ID0gVGhvcmF4LnRlbXBsYXRlUGF0aFByZWZpeCwKICAgICAgICB0ZW1wbGF0ZTsKICAgIGlmIChwYXRoUHJlZml4ICYmIGZpbGUuc3Vic3RyKDAsIHBhdGhQcmVmaXgubGVuZ3RoKSAhPT0gcGF0aFByZWZpeCkgewogICAgICBmaWxlID0gcGF0aFByZWZpeCArIGZpbGU7CiAgICB9CgogICAgLy8gV2l0aG91dCBleHRlbnNpb24KICAgIGZpbGUgPSBmaWxlLnJlcGxhY2UoL1wuaGFuZGxlYmFycyQvLCAnJyk7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC50ZW1wbGF0ZXNbZmlsZV07CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIC8vIFdpdGggZXh0ZW5zaW9uCiAgICAgIGZpbGUgPSBmaWxlICsgJy5oYW5kbGViYXJzJzsKICAgICAgdGVtcGxhdGUgPSBUaG9yYXgudGVtcGxhdGVzW2ZpbGVdOwogICAgfQoKICAgIGlmICghdGVtcGxhdGUgJiYgIWlnbm9yZUVycm9ycykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3RlbXBsYXRlczogJyArIGZpbGUgKyAnIGRvZXMgbm90IGV4aXN0LicpOwogICAgfQogICAgcmV0dXJuIHRlbXBsYXRlOwogIH0sCgogIC8vJ3NlbGVjdG9yJyBpcyBub3QgcHJlc2VudCBpbiAkKCc8cD48L3A+JykKICAvL1RPRE86IGludmVzdGlnYWdlIGEgYmV0dGVyIGRldGVjdGlvbiBtZXRob2QKICBpcyQ6IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIF8uaXNPYmplY3Qob2JqKSAmJiAoJ2xlbmd0aCcgaW4gb2JqKTsKICB9LAogIGV4cGFuZFRva2VuOiBmdW5jdGlvbihpbnB1dCwgc2NvcGUpIHsKICAgIGlmIChpbnB1dCAmJiBpbnB1dC5pbmRleE9mICYmIGlucHV0LmluZGV4T2YoJ3t7JykgPj0gMCkgewogICAgICB2YXIgcmUgPSAvKD86XHs/W157XSspfCg/Olx7XHsoW159XSspXH1cfSkvZywKICAgICAgICAgIG1hdGNoLAogICAgICAgICAgcmV0ID0gW107CiAgICAgIGZ1bmN0aW9uIGRlcmVmKHRva2VuLCBzY29wZSkgewogICAgICAgIGlmICh0b2tlbi5tYXRjaCgvXigifCcpLykgJiYgdG9rZW4ubWF0Y2goLygifCcpJC8pKSB7CiAgICAgICAgICByZXR1cm4gdG9rZW4ucmVwbGFjZSgvKF4oInwnKXwoJ3wiKSQpL2csICcnKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNlZ21lbnRzID0gdG9rZW4uc3BsaXQoJy4nKSwKICAgICAgICAgICAgbGVuID0gc2VnbWVudHMubGVuZ3RoOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBzY29wZSAmJiBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGlmIChzZWdtZW50c1tpXSAhPT0gJ3RoaXMnKSB7CiAgICAgICAgICAgIHNjb3BlID0gc2NvcGVbc2VnbWVudHNbaV1dOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2NvcGU7CiAgICAgIH0KICAgICAgd2hpbGUgKG1hdGNoID0gcmUuZXhlYyhpbnB1dCkpIHsKICAgICAgICBpZiAobWF0Y2hbMV0pIHsKICAgICAgICAgIHZhciBwYXJhbXMgPSBtYXRjaFsxXS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICBpZiAocGFyYW1zLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGhlbHBlciA9IHBhcmFtcy5zaGlmdCgpOwogICAgICAgICAgICBwYXJhbXMgPSBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtKSB7IHJldHVybiBkZXJlZihwYXJhbSwgc2NvcGUpOyB9KTsKICAgICAgICAgICAgaWYgKEhhbmRsZWJhcnMuaGVscGVyc1toZWxwZXJdKSB7CiAgICAgICAgICAgICAgcmV0LnB1c2goSGFuZGxlYmFycy5oZWxwZXJzW2hlbHBlcl0uYXBwbHkoc2NvcGUsIHBhcmFtcykpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIElmIHRoZSBoZWxwZXIgaXMgbm90IGRlZmluZWQgZG8gbm90aGluZwogICAgICAgICAgICAgIHJldC5wdXNoKG1hdGNoWzBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0LnB1c2goZGVyZWYocGFyYW1zWzBdLCBzY29wZSkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXQucHVzaChtYXRjaFswXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlucHV0ID0gcmV0LmpvaW4oJycpOwogICAgfQogICAgcmV0dXJuIGlucHV0OwogIH0sCiAgdGFnOiBmdW5jdGlvbihhdHRyaWJ1dGVzLCBjb250ZW50LCBzY29wZSkgewogICAgdmFyIGh0bWxBdHRyaWJ1dGVzID0gXy5vbWl0KGF0dHJpYnV0ZXMsICd0YWdOYW1lJyksCiAgICAgICAgdGFnID0gYXR0cmlidXRlcy50YWdOYW1lIHx8ICdkaXYnOwogICAgcmV0dXJuICc8JyArIHRhZyArICcgJyArIF8ubWFwKGh0bWxBdHRyaWJ1dGVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgIGlmIChfLmlzVW5kZWZpbmVkKHZhbHVlKSB8fCBrZXkgPT09ICdleHBhbmQtdG9rZW5zJykgewogICAgICAgIHJldHVybiAnJzsKICAgICAgfQogICAgICB2YXIgZm9ybWF0dGVkVmFsdWUgPSB2YWx1ZTsKICAgICAgaWYgKHNjb3BlKSB7CiAgICAgICAgZm9ybWF0dGVkVmFsdWUgPSBUaG9yYXguVXRpbC5leHBhbmRUb2tlbih2YWx1ZSwgc2NvcGUpOwogICAgICB9CiAgICAgIHJldHVybiAoa2V5ID09PSAnY2xhc3NOYW1lJyA/ICdjbGFzcycgOiBrZXkpICsgJz0iJyArIEhhbmRsZWJhcnMuVXRpbHMuZXNjYXBlRXhwcmVzc2lvbihmb3JtYXR0ZWRWYWx1ZSkgKyAnIic7CiAgICB9KS5qb2luKCcgJykgKyAnPicgKyAoXy5pc1VuZGVmaW5lZChjb250ZW50KSA/ICcnIDogY29udGVudCkgKyAnPC8nICsgdGFnICsgJz4nOwogIH0KfTsKCjs7Ci8qZ2xvYmFsIGNyZWF0ZUluaGVyaXRWYXJzLCBpbmhlcml0VmFycyAqLwpUaG9yYXguTWl4aW5zID0ge307Cgppbmhlcml0VmFycy5taXhpbnMgPSB7CiAgbmFtZTogJ21peGlucycsCiAgY29uZmlndXJlOiBmdW5jdGlvbigpIHsKICAgIF8uZWFjaCh0aGlzLmNvbnN0cnVjdG9yLm1peGlucywgdGhpcy5taXhpbiwgdGhpcyk7CiAgICBfLmVhY2godGhpcy5taXhpbnMsIHRoaXMubWl4aW4sIHRoaXMpOwogIH0KfTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LCB7CiAgbWl4aW46IGZ1bmN0aW9uKG1peGluKSB7CiAgICBjcmVhdGVJbmhlcml0VmFycyh0aGlzKTsKICAgIHRoaXMubWl4aW5zLnB1c2gobWl4aW4pOwogIH0sCiAgcmVnaXN0ZXJNaXhpbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIG1ldGhvZHMpIHsKICAgIFRob3JheC5NaXhpbnNbbmFtZV0gPSBbY2FsbGJhY2ssIG1ldGhvZHNdOwogIH0KfSk7CgpUaG9yYXguVmlldy5wcm90b3R5cGUubWl4aW4gPSBmdW5jdGlvbihuYW1lKSB7CiAgaWYgKCF0aGlzLl9hcHBsaWVkTWl4aW5zKSB7CiAgICB0aGlzLl9hcHBsaWVkTWl4aW5zID0gW107CiAgfQogIGlmICh0aGlzLl9hcHBsaWVkTWl4aW5zLmluZGV4T2YobmFtZSkgPT09IC0xKSB7CiAgICB0aGlzLl9hcHBsaWVkTWl4aW5zLnB1c2gobmFtZSk7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKG5hbWUpKSB7CiAgICAgIG5hbWUuY2FsbCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBtaXhpbiA9IFRob3JheC5NaXhpbnNbbmFtZV07CiAgICAgIF8uZXh0ZW5kKHRoaXMsIG1peGluWzFdKTsKICAgICAgLy9taXhpbiBjYWxsYmFjayBtYXkgYmUgYW4gYXJyYXkgb2YgW2NhbGxiYWNrLCBhcmd1bWVudHNdCiAgICAgIGlmIChfLmlzQXJyYXkobWl4aW5bMF0pKSB7CiAgICAgICAgbWl4aW5bMF1bMF0uYXBwbHkodGhpcywgbWl4aW5bMF1bMV0pOwogICAgICB9IGVsc2UgewogICAgICAgIG1peGluWzBdLmFwcGx5KHRoaXMsIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpKTsKICAgICAgfQogICAgfQogIH0KfTsKCjs7Ci8qZ2xvYmFsIGNyZWF0ZUluaGVyaXRWYXJzLCBpbmhlcml0VmFycywgb2JqZWN0RXZlbnRzLCB3YWxrSW5oZXJpdFRyZWUgKi8KLy8gU2F2ZSBhIGNvcHkgb2YgdGhlIF9vbiBtZXRob2QgdG8gY2FsbCBhcyBhICRzdXBlciBtZXRob2QKdmFyIF9vbiA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5vbjsKCmluaGVyaXRWYXJzLmV2ZW50ID0gewogIG5hbWU6ICdfZXZlbnRzJywKCiAgY29uZmlndXJlOiBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHdhbGtJbmhlcml0VHJlZSh0aGlzLmNvbnN0cnVjdG9yLCAnX2V2ZW50cycsIHRydWUsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHNlbGYub24uYXBwbHkoc2VsZiwgZXZlbnQpOwogICAgfSk7CiAgICB3YWxrSW5oZXJpdFRyZWUodGhpcywgJ2V2ZW50cycsIGZhbHNlLCBmdW5jdGlvbihoYW5kbGVyLCBldmVudE5hbWUpIHsKICAgICAgc2VsZi5vbihldmVudE5hbWUsIGhhbmRsZXIsIHNlbGYpOwogICAgfSk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcsIHsKICBvbjogZnVuY3Rpb24oZXZlbnROYW1lLCBjYWxsYmFjaykgewogICAgY3JlYXRlSW5oZXJpdFZhcnModGhpcyk7CgogICAgaWYgKG9iamVjdEV2ZW50cyh0aGlzLCBldmVudE5hbWUsIGNhbGxiYWNrKSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvL2FjY2VwdCBvbih7InJlbmRlcmVkIjogaGFuZGxlcn0pCiAgICBpZiAoXy5pc09iamVjdChldmVudE5hbWUpKSB7CiAgICAgIF8uZWFjaChldmVudE5hbWUsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICB0aGlzLm9uKGtleSwgdmFsdWUpOwogICAgICB9LCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vYWNjZXB0IG9uKHsicmVuZGVyZWQiOiBbaGFuZGxlciwgaGFuZGxlcl19KQogICAgICBpZiAoXy5pc0FycmF5KGNhbGxiYWNrKSkgewogICAgICAgIF8uZWFjaChjYWxsYmFjaywgZnVuY3Rpb24oY2IpIHsKICAgICAgICAgIHRoaXMuX2V2ZW50cy5wdXNoKFtldmVudE5hbWUsIGNiXSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIC8vYWNjZXB0IG9uKCJyZW5kZXJlZCIsIGhhbmRsZXIpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goW2V2ZW50TmFtZSwgY2FsbGJhY2tdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9KTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIG9uOiBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICBpZiAob2JqZWN0RXZlbnRzKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGlmIChfLmlzT2JqZWN0KGV2ZW50TmFtZSkgJiYgYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKICAgICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IGNhbGxiYWNrfSkKICAgICAgXy5lYWNoKGV2ZW50TmFtZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHRoaXMub24oa2V5LCB2YWx1ZSwgY2FsbGJhY2sgfHwgdGhpcyk7ICAgIC8vIGNhbGxiYWNrIGlzIGNvbnRleHQgaW4gdGhpcyBmb3JtIG9mIHRoZSBjYWxsCiAgICAgIH0sIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy9hY2NlcHQgb24oInJlbmRlcmVkIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIC8vYWNjZXB0IG9uKCJjbGljayBhIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIF8uZWFjaCgoXy5pc0FycmF5KGNhbGxiYWNrKSA/IGNhbGxiYWNrIDogW2NhbGxiYWNrXSksIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IGV2ZW50UGFyYW1zRnJvbUV2ZW50SXRlbS5jYWxsKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQgfHwgdGhpcyk7CiAgICAgICAgaWYgKHBhcmFtcy50eXBlID09PSAnRE9NJykgewogICAgICAgICAgLy93aWxsIGNhbGwgX2FkZEV2ZW50IGR1cmluZyBkZWxlZ2F0ZUV2ZW50cygpCiAgICAgICAgICBpZiAoIXRoaXMuX2V2ZW50c1RvRGVsZWdhdGUpIHsKICAgICAgICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZS5wdXNoKHBhcmFtcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX2FkZEV2ZW50KHBhcmFtcyk7CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCiAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICBpZiAoZXZlbnRzKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oZXZlbnRzKSkgewogICAgICAgIGV2ZW50cyA9IGV2ZW50cy5jYWxsKHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMuX2V2ZW50c1RvRGVsZWdhdGUgPSBbXTsKICAgICAgdGhpcy5vbihldmVudHMpOwogICAgfQogICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSAmJiBfLmVhY2godGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSwgdGhpcy5fYWRkRXZlbnQsIHRoaXMpOwogIH0sCiAgLy9wYXJhbXMgbWF5IGNvbnRhaW46CiAgLy8tIG5hbWUKICAvLy0gb3JpZ2luYWxOYW1lCiAgLy8tIHNlbGVjdG9yCiAgLy8tIHR5cGUgInZpZXciIHx8ICJET00iCiAgLy8tIGhhbmRsZXIKICBfYWRkRXZlbnQ6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgaWYgKHBhcmFtcy50eXBlID09PSAndmlldycpIHsKICAgICAgXy5lYWNoKHBhcmFtcy5uYW1lLnNwbGl0KC9ccysvKSwgZnVuY3Rpb24obmFtZSkgewogICAgICAgIF9vbi5jYWxsKHRoaXMsIG5hbWUsIGJpbmRFdmVudEhhbmRsZXIuY2FsbCh0aGlzLCAndmlldy1ldmVudDonLCBwYXJhbXMpKTsKICAgICAgfSwgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgYm91bmRIYW5kbGVyID0gYmluZEV2ZW50SGFuZGxlci5jYWxsKHRoaXMsICdkb20tZXZlbnQ6JywgcGFyYW1zKTsKICAgICAgaWYgKCFwYXJhbXMubmVzdGVkKSB7CiAgICAgICAgYm91bmRIYW5kbGVyID0gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoYm91bmRIYW5kbGVyLCB0aGlzLmNpZCk7CiAgICAgIH0KICAgICAgaWYgKHBhcmFtcy5zZWxlY3RvcikgewogICAgICAgIHZhciBuYW1lID0gcGFyYW1zLm5hbWUgKyAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwogICAgICAgIHRoaXMuJGVsLm9uKG5hbWUsIHBhcmFtcy5zZWxlY3RvciwgYm91bmRIYW5kbGVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRlbC5vbihwYXJhbXMubmFtZSwgYm91bmRIYW5kbGVyKTsKICAgICAgfQogICAgfQogIH0KfSk7CgovLyBXaGVuIHZpZXcgaXMgcmVhZHkgdHJpZ2dlciByZWFkeSBldmVudCBvbiBhbGwKLy8gY2hpbGRyZW4gdGhhdCBhcmUgcHJlc2VudCwgdGhlbiByZWdpc3RlciBhbgovLyBldmVudCB0aGF0IHdpbGwgdHJpZ2dlciByZWFkeSBvbiBuZXcgY2hpbGRyZW4KLy8gd2hlbiB0aGV5IGFyZSBhZGRlZApUaG9yYXguVmlldy5vbigncmVhZHknLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgaWYgKCF0aGlzLl9pc1JlYWR5KSB7CiAgICB0aGlzLl9pc1JlYWR5ID0gdHJ1ZTsKICAgIGZ1bmN0aW9uIHRyaWdnZXJSZWFkeU9uQ2hpbGQoY2hpbGQpIHsKICAgICAgY2hpbGQudHJpZ2dlcigncmVhZHknLCBvcHRpb25zKTsKICAgIH0KICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCB0cmlnZ2VyUmVhZHlPbkNoaWxkKTsKICAgIHRoaXMub24oJ2NoaWxkJywgdHJpZ2dlclJlYWR5T25DaGlsZCk7CiAgfQp9KTsKCnZhciBldmVudFNwbGl0dGVyID0gL14obmVzdGVkXHMrKT8oXFMrKSg/OlxzKyguKykpPy87Cgp2YXIgZG9tRXZlbnRzID0gW10sCiAgICBkb21FdmVudFJlZ2V4cDsKZnVuY3Rpb24gcHVzaERvbUV2ZW50cyhldmVudHMpIHsKICBkb21FdmVudHMucHVzaC5hcHBseShkb21FdmVudHMsIGV2ZW50cyk7CiAgZG9tRXZlbnRSZWdleHAgPSBuZXcgUmVnRXhwKCdeKG5lc3RlZFxccyspPygnICsgZG9tRXZlbnRzLmpvaW4oJ3wnKSArICcpKD86XFxzfCQpJyk7Cn0KcHVzaERvbUV2ZW50cyhbCiAgJ21vdXNlZG93bicsICdtb3VzZXVwJywgJ21vdXNlbW92ZScsICdtb3VzZW92ZXInLCAnbW91c2VvdXQnLAogICd0b3VjaHN0YXJ0JywgJ3RvdWNoZW5kJywgJ3RvdWNobW92ZScsCiAgJ2NsaWNrJywgJ2RibGNsaWNrJywKICAna2V5dXAnLCAna2V5ZG93bicsICdrZXlwcmVzcycsCiAgJ3N1Ym1pdCcsICdjaGFuZ2UnLAogICdmb2N1cycsICdibHVyJwpdKTsKCmZ1bmN0aW9uIGNvbnRhaW5IYW5kbGVyVG9DdXJlbnRWaWV3KGhhbmRsZXIsIGNpZCkgewogIHJldHVybiBmdW5jdGlvbihldmVudCkgewogICAgdmFyIHZpZXcgPSAkKGV2ZW50LnRhcmdldCkudmlldyh7aGVscGVyOiBmYWxzZX0pOwogICAgaWYgKHZpZXcgJiYgdmlldy5jaWQgPT09IGNpZCkgewogICAgICBldmVudC5vcmlnaW5hbENvbnRleHQgPSB0aGlzOwogICAgICBoYW5kbGVyKGV2ZW50KTsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiBiaW5kRXZlbnRIYW5kbGVyKGV2ZW50TmFtZSwgcGFyYW1zKSB7CiAgZXZlbnROYW1lICs9IHBhcmFtcy5vcmlnaW5hbE5hbWU7CgogIHZhciBjYWxsYmFjayA9IHBhcmFtcy5oYW5kbGVyLAogICAgICBtZXRob2QgPSBfLmlzRnVuY3Rpb24oY2FsbGJhY2spID8gY2FsbGJhY2sgOiB0aGlzW2NhbGxiYWNrXTsKICBpZiAoIW1ldGhvZCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdFdmVudCAiJyArIGNhbGxiYWNrICsgJyIgZG9lcyBub3QgZXhpc3QgJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJzonICsgZXZlbnROYW1lKTsKICB9CiAgcmV0dXJuIF8uYmluZChmdW5jdGlvbigpIHsKICAgIHRyeSB7CiAgICAgIG1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBUaG9yYXgub25FeGNlcHRpb24oJ3Rob3JheC1leGNlcHRpb246ICcgKyAodGhpcy5uYW1lIHx8IHRoaXMuY2lkKSArICc6JyArIGV2ZW50TmFtZSwgZSk7CiAgICB9CiAgfSwgcGFyYW1zLmNvbnRleHQgfHwgdGhpcyk7Cn0KCmZ1bmN0aW9uIGV2ZW50UGFyYW1zRnJvbUV2ZW50SXRlbShuYW1lLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgdmFyIHBhcmFtcyA9IHsKICAgIG9yaWdpbmFsTmFtZTogbmFtZSwKICAgIGhhbmRsZXI6IF8uaXNTdHJpbmcoaGFuZGxlcikgPyB0aGlzW2hhbmRsZXJdIDogaGFuZGxlcgogIH07CiAgaWYgKG5hbWUubWF0Y2goZG9tRXZlbnRSZWdleHApKSB7CiAgICB2YXIgbWF0Y2ggPSBldmVudFNwbGl0dGVyLmV4ZWMobmFtZSk7CiAgICBwYXJhbXMubmVzdGVkID0gISFtYXRjaFsxXTsKICAgIHBhcmFtcy5uYW1lID0gbWF0Y2hbMl07CiAgICBwYXJhbXMudHlwZSA9ICdET00nOwogICAgcGFyYW1zLnNlbGVjdG9yID0gbWF0Y2hbM107CiAgfSBlbHNlIHsKICAgIHBhcmFtcy5uYW1lID0gbmFtZTsKICAgIHBhcmFtcy50eXBlID0gJ3ZpZXcnOwogIH0KICBwYXJhbXMuY29udGV4dCA9IGNvbnRleHQ7CiAgcmV0dXJuIHBhcmFtczsKfQoKOzsKLypnbG9iYWwgZ2V0T3B0aW9uc0RhdGEsIGh0bWxBdHRyaWJ1dGVzVG9Db3B5LCBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucywgdmlld0hlbHBlckF0dHJpYnV0ZU5hbWUgKi8KdmFyIHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LXRtcCcsCiAgICB2aWV3VGVtcGxhdGVPdmVycmlkZXMgPSB7fTsKCi8vIFdpbGwgYmUgc2hhcmVkIGJ5IEhlbHBlclZpZXcgYW5kIENvbGxlY3Rpb25IZWxwZXJWaWV3CnZhciBoZWxwZXJWaWV3UHJvdG90eXBlID0gewogIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIFRob3JheC5WaWV3LnByb3RvdHlwZS5fZW5zdXJlRWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy4kZWwuYXR0cih2aWV3SGVscGVyQXR0cmlidXRlTmFtZSwgdGhpcy5faGVscGVyTmFtZSk7CiAgfSwKICBfZ2V0Q29udGV4dDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5wYXJlbnQuX2dldENvbnRleHQuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3VtZW50cyk7CiAgfQp9OwoKVGhvcmF4LkhlbHBlclZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoaGVscGVyVmlld1Byb3RvdHlwZSk7CgovLyBFbnN1cmUgbmVzdGVkIGlubGluZSBoZWxwZXJzIHdpbGwgYWx3YXlzIGhhdmUgdGhpcy5wYXJlbnQKLy8gc2V0IHRvIHRoZSB2aWV3IGNvbnRhaW5pbmcgdGhlIHRlbXBsYXRlCmZ1bmN0aW9uIGdldFBhcmVudChwYXJlbnQpIHsKICAvLyBUaGUgYHZpZXdgIGhlbHBlciBpcyBhIHNwZWNpYWwgY2FzZSBhcyBpdCBlbWJlZHMKICAvLyBhIHZpZXcgaW5zdGVhZCBvZiBjcmVhdGluZyBhIG5ldyBvbmUKICB3aGlsZSAocGFyZW50Ll9oZWxwZXJOYW1lICYmIHBhcmVudC5faGVscGVyTmFtZSAhPT0gJ3ZpZXcnKSB7CiAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50OwogIH0KICByZXR1cm4gcGFyZW50Owp9CgpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlciA9IGZ1bmN0aW9uKG5hbWUsIFZpZXdDbGFzcywgY2FsbGJhY2spIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgIGNhbGxiYWNrID0gVmlld0NsYXNzLmNhbGxiYWNrOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSBWaWV3Q2xhc3M7CiAgICAgIFZpZXdDbGFzcyA9IFRob3JheC5IZWxwZXJWaWV3OwogICAgfQogIH0KICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKG5hbWUsIGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICBvcHRpb25zID0gYXJncy5wb3AoKSwKICAgICAgICBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKCiAgICB2YXIgdmlld09wdGlvbnMgPSB7CiAgICAgIHRlbXBsYXRlOiBvcHRpb25zLmZuIHx8IEhhbmRsZWJhcnMuVk0ubm9vcCwKICAgICAgaW52ZXJzZTogb3B0aW9ucy5pbnZlcnNlLAogICAgICBvcHRpb25zOiBvcHRpb25zLmhhc2gsCiAgICAgIGRlY2xhcmluZ1ZpZXc6IGRlY2xhcmluZ1ZpZXcsCiAgICAgIHBhcmVudDogZ2V0UGFyZW50KGRlY2xhcmluZ1ZpZXcpLAogICAgICBfaGVscGVyTmFtZTogbmFtZSwKICAgICAgX2hlbHBlck9wdGlvbnM6IHsKICAgICAgICBvcHRpb25zOiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucyksCiAgICAgICAgYXJnczogXy5jbG9uZShhcmdzKQogICAgICB9CiAgICB9OwoKICAgIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMuaGFzaCk7CiAgICBfLmV4dGVuZCh2aWV3T3B0aW9ucywgXy5waWNrKG9wdGlvbnMuaGFzaCwgaHRtbEF0dHJpYnV0ZXNUb0NvcHkpKTsKCiAgICAvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhbiBleGlzdGluZyBpbnN0YW5jZSB0aGF0IHdlIGNhbiByZXVzZQogICAgdmFyIGluc3RhbmNlID0gXy5maW5kKGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgcmV0dXJuIGNvbXBhcmVIZWxwZXJPcHRpb25zKHZpZXdPcHRpb25zLCBjaGlsZCk7CiAgICB9KTsKCiAgICAvLyBDcmVhdGUgdGhlIGluc3RhbmNlIGlmIHdlIGRvbid0IGFscmVhZHkgaGF2ZSBvbmUKICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgICAgaW5zdGFuY2UgPSBWaWV3Q2xhc3MuZmFjdG9yeShhcmdzLCB2aWV3T3B0aW9ucyk7CiAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KCiAgICAgICAgaW5zdGFuY2UuX2hlbHBlck5hbWUgPSB2aWV3T3B0aW9ucy5faGVscGVyTmFtZTsKICAgICAgICBpbnN0YW5jZS5faGVscGVyT3B0aW9ucyA9IHZpZXdPcHRpb25zLl9oZWxwZXJPcHRpb25zOwogICAgICB9IGVsc2UgewogICAgICAgIGluc3RhbmNlID0gbmV3IFZpZXdDbGFzcyh2aWV3T3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIGFyZ3MucHVzaChpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuX2FkZENoaWxkKGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyJywgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoKICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICB9IGVsc2UgewogICAgICBkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMgPSBfLndpdGhvdXQoZGVjbGFyaW5nVmlldy5fcHJldmlvdXNIZWxwZXJzLCBpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuY2hpbGRyZW5baW5zdGFuY2UuY2lkXSA9IGluc3RhbmNlOwogICAgfQoKICAgIHZhciBodG1sQXR0cmlidXRlcyA9IF8ucGljayhvcHRpb25zLmhhc2gsIGh0bWxBdHRyaWJ1dGVzVG9Db3B5KTsKICAgIGh0bWxBdHRyaWJ1dGVzW3ZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gaW5zdGFuY2UuY2lkOwoKICAgIHZhciBleHBhbmRUb2tlbnMgPSBvcHRpb25zLmhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICAgIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhodG1sQXR0cmlidXRlcywgJycsIGV4cGFuZFRva2VucyA/IHRoaXMgOiBudWxsKSk7CiAgfSk7CiAgdmFyIGhlbHBlciA9IEhhbmRsZWJhcnMuaGVscGVyc1tuYW1lXTsKICByZXR1cm4gaGVscGVyOwp9OwoKVGhvcmF4LlZpZXcub24oJ2FwcGVuZCcsIGZ1bmN0aW9uKHNjb3BlLCBjYWxsYmFjaykgewogIChzY29wZSB8fCB0aGlzLiRlbCkuZmluZCgnWycgKyB2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lICsgJ10nKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICB2YXIgcGxhY2Vob2xkZXJJZCA9IGVsLmdldEF0dHJpYnV0ZSh2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lKSwKICAgICAgICB2aWV3ID0gdGhpcy5jaGlsZHJlbltwbGFjZWhvbGRlcklkXTsKICAgIGlmICh2aWV3KSB7CiAgICAgIC8vc2VlIGlmIHRoZSB2aWV3IGhlbHBlciBkZWNsYXJlZCBhbiBvdmVycmlkZSBmb3IgdGhlIHZpZXcKICAgICAgLy9pZiBub3QsIGVuc3VyZSB0aGUgdmlldyBoYXMgYmVlbiByZW5kZXJlZCBhdCBsZWFzdCBvbmNlCiAgICAgIGlmICh2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pIHsKICAgICAgICB2aWV3LnJlbmRlcih2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pOwogICAgICAgIGRlbGV0ZSB2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICB9CiAgICAgICQoZWwpLnJlcGxhY2VXaXRoKHZpZXcuZWwpOwogICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayh2aWV3LmVsKTsKICAgIH0KICB9LCB0aGlzKTsKfSk7CgoKLyoqCiAqIENsb25lcyB0aGUgaGVscGVyIG9wdGlvbnMsIGRyb3BwaW5nIGl0ZW1zIHRoYXQgYXJlIGtub3duIHRvIGNoYW5nZQogKiBiZXR3ZWVuIHJlbmRlcmluZyBjeWNsZXMgYXMgYXBwcm9wcmlhdGUuCiAqLwpmdW5jdGlvbiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucykgewogIHZhciByZXQgPSBfLnBpY2sob3B0aW9ucywgJ2ZuJywgJ2ludmVyc2UnLCAnaGFzaCcsICdkYXRhJyk7CiAgcmV0LmRhdGEgPSBfLm9taXQob3B0aW9ucy5kYXRhLCAnY2lkJywgJ3ZpZXcnLCAneWllbGQnKTsKICByZXR1cm4gcmV0Owp9CgovKioKICogQ2hlY2tzIGZvciBiYXNpYyBlcXVhbGl0eSBiZXR3ZWVuIHR3byBzZXRzIG9mIHBhcmFtZXRlcnMgZm9yIGEgaGVscGVyIHZpZXcuCiAqCiAqIENoZWNrZWQgZmllbGRzIGluY2x1ZGU6CiAqICAtIF9oZWxwZXJOYW1lCiAqICAtIEFsbCBhcmdzCiAqICAtIEhhc2gKICogIC0gRGF0YQogKiAgLSBGdW5jdGlvbiBhbmQgSW52ZXJ0IChpZCBiYXNlZCBpZiBwb3NzaWJsZSkKICoKICogVGhpcyBtZXRob2QgYWxsb3dzIHVzIHRvIGRldGVybWluZSBpZiB0aGUgaW5wdXRzIHRvIGEgZ2l2ZW4gdmlldyBhcmUgdGhlIHNhbWUuIElmIHRoZXkKICogYXJlIHRoZW4gd2UgbWFrZSB0aGUgYXNzdW1wdGlvbiB0aGF0IHRoZSByZW5kZXJpbmcgd2lsbCBiZSB0aGUgc2FtZSAob3IgdGhlIGNoaWxkIHZpZXcgd2lsbAogKiBvdGhlcndpc2UgcmVyZW5kZXJpbmcgaXQgYnkgbW9uaXRvcmluZyBpdCdzIHBhcmFtZXRlcnMgYXMgbmVjZXNzYXJ5KSBhbmQgcmV1c2UgdGhlIHZpZXcgb24KICogcmVyZW5kZXIgb2YgdGhlIHBhcmVudCB2aWV3LgogKi8KZnVuY3Rpb24gY29tcGFyZUhlbHBlck9wdGlvbnMoYSwgYikgewogIGZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYSwgYikgewogICAgcmV0dXJuIF8uZXZlcnkoYSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICByZXR1cm4gYltrZXldID09PSB2YWx1ZTsKICAgIH0pOwogIH0KCiAgaWYgKGEuX2hlbHBlck5hbWUgIT09IGIuX2hlbHBlck5hbWUpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGEgPSBhLl9oZWxwZXJPcHRpb25zOwogIGIgPSBiLl9oZWxwZXJPcHRpb25zOwoKICAvLyBJbXBsZW1lbnRzIGEgZmlyc3QgbGV2ZWwgZGVwdGggY29tcGFyaXNvbgogIHJldHVybiBhLmFyZ3MubGVuZ3RoID09PSBiLmFyZ3MubGVuZ3RoCiAgICAgICYmIGNvbXBhcmVWYWx1ZXMoYS5hcmdzLCBiLmFyZ3MpCiAgICAgICYmIF8uaXNFcXVhbChfLmtleXMoYS5vcHRpb25zKSwgXy5rZXlzKGIub3B0aW9ucykpCiAgICAgICYmIF8uZXZlcnkoYS5vcHRpb25zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAnZGF0YScgfHwga2V5ID09PSAnaGFzaCcpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXMoYS5vcHRpb25zW2tleV0sIGIub3B0aW9uc1trZXldKTsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnZm4nIHx8IGtleSA9PT0gJ2ludmVyc2UnKSB7CiAgICAgICAgICAgIGlmIChiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG90aGVyID0gYi5vcHRpb25zW2tleV0gfHwge307CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSAmJiBfLmhhcyh2YWx1ZSwgJ3Byb2dyYW0nKSAmJiAhdmFsdWUuZGVwdGggJiYgb3RoZXIucHJvZ3JhbSA9PT0gdmFsdWUucHJvZ3JhbTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWU7CiAgICAgICAgfSk7Cn0KCjs7Ci8qZ2xvYmFsIGdldFZhbHVlLCBpbmhlcml0VmFycywgd2Fsa0luaGVyaXRUcmVlICovCgpmdW5jdGlvbiBkYXRhT2JqZWN0KHR5cGUsIHNwZWMpIHsKICBzcGVjID0gaW5oZXJpdFZhcnNbdHlwZV0gPSBfLmRlZmF1bHRzKHsKICAgIG5hbWU6ICdfJyArIHR5cGUgKyAnRXZlbnRzJywKICAgIGV2ZW50OiB0cnVlCiAgfSwgc3BlYyk7CgogIC8vIEFkZCBhIGNhbGxiYWNrIGluIHRoZSB2aWV3IGNvbnN0cnVjdG9yCiAgc3BlYy5jdG9yID0gZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpc1t0eXBlXSkgewogICAgICAvLyBOZWVkIHRvIG51bGwgdGhpcy5tb2RlbC9jb2xsZWN0aW9uIHNvIHNldE1vZGVsL0NvbGxlY3Rpb24gd2lsbAogICAgICAvLyBub3QgdHJlYXQgaXQgYXMgdGhlIG9sZCBtb2RlbC9jb2xsZWN0aW9uIGFuZCBpbW1lZGlhdGVseSByZXR1cm4KICAgICAgdmFyIG9iamVjdCA9IHRoaXNbdHlwZV07CiAgICAgIHRoaXNbdHlwZV0gPSBudWxsOwogICAgICB0aGlzW3NwZWMuc2V0XShvYmplY3QpOwogICAgfQogIH07CgogIGZ1bmN0aW9uIHNldE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICB2YXIgb2xkID0gdGhpc1t0eXBlXSwKICAgICAgICAkZWwgPSBnZXRWYWx1ZSh0aGlzLCBzcGVjLiRlbCk7CgogICAgaWYgKGRhdGFPYmplY3QgPT09IG9sZCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGlmIChvbGQpIHsKICAgICAgdGhpcy51bmJpbmREYXRhT2JqZWN0KG9sZCk7CiAgICB9CgogICAgaWYgKGRhdGFPYmplY3QpIHsKICAgICAgdGhpc1t0eXBlXSA9IGRhdGFPYmplY3Q7CgogICAgICBpZiAoc3BlYy5sb2FkaW5nKSB7CiAgICAgICAgc3BlYy5sb2FkaW5nLmNhbGwodGhpcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuYmluZERhdGFPYmplY3QodHlwZSwgZGF0YU9iamVjdCwgXy5leHRlbmQoe30sIHRoaXMub3B0aW9ucywgb3B0aW9ucykpOwogICAgICAkZWwgJiYgJGVsLmF0dHIoc3BlYy5jaWRBdHRyTmFtZSwgZGF0YU9iamVjdC5jaWQpOwogICAgICBkYXRhT2JqZWN0LnRyaWdnZXIoJ3NldCcsIGRhdGFPYmplY3QsIG9sZCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzW3R5cGVdID0gZmFsc2U7CiAgICAgIGlmIChzcGVjLmNoYW5nZSkgewogICAgICAgIHNwZWMuY2hhbmdlLmNhbGwodGhpcywgZmFsc2UpOwogICAgICB9CiAgICAgICRlbCAmJiAkZWwucmVtb3ZlQXR0cihzcGVjLmNpZEF0dHJOYW1lKTsKICAgIH0KICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOmRhdGEtb2JqZWN0JywgdHlwZSwgZGF0YU9iamVjdCwgb2xkKTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgVGhvcmF4LlZpZXcucHJvdG90eXBlW3NwZWMuc2V0XSA9IHNldE9iamVjdDsKfQoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgYmluZERhdGFPYmplY3Q6IGZ1bmN0aW9uKHR5cGUsIGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICAgIGlmICh0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF0gPSBkYXRhT2JqZWN0OwoKICAgIHZhciBvcHRpb25zID0gdGhpcy5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMoZGF0YU9iamVjdCwgXy5leHRlbmQoe30sIGluaGVyaXRWYXJzW3R5cGVdLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKSk7CiAgICB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbZGF0YU9iamVjdC5jaWRdID0gb3B0aW9uczsKCiAgICBiaW5kRXZlbnRzLmNhbGwodGhpcywgdHlwZSwgZGF0YU9iamVjdCwgdGhpcy5jb25zdHJ1Y3Rvcik7CiAgICBiaW5kRXZlbnRzLmNhbGwodGhpcywgdHlwZSwgZGF0YU9iamVjdCwgdGhpcyk7CgogICAgdmFyIHNwZWMgPSBpbmhlcml0VmFyc1t0eXBlXTsKICAgIHNwZWMuYmluZENhbGxiYWNrICYmIHNwZWMuYmluZENhbGxiYWNrLmNhbGwodGhpcywgZGF0YU9iamVjdCwgb3B0aW9ucyk7CgogICAgaWYgKGRhdGFPYmplY3Quc2hvdWxkRmV0Y2ggJiYgZGF0YU9iamVjdC5zaG91bGRGZXRjaChvcHRpb25zKSkgewogICAgICBsb2FkT2JqZWN0KGRhdGFPYmplY3QsIG9wdGlvbnMpOwogICAgfSBlbHNlIGlmIChpbmhlcml0VmFyc1t0eXBlXS5jaGFuZ2UpIHsKICAgICAgLy8gd2FudCB0byB0cmlnZ2VyIGJ1aWx0IGluIHJlbmRlcmluZyB3aXRob3V0IHRyaWdnZXJpbmcgZXZlbnQgb24gbW9kZWwKICAgICAgaW5oZXJpdFZhcnNbdHlwZV0uY2hhbmdlLmNhbGwodGhpcywgZGF0YU9iamVjdCwgb3B0aW9ucyk7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfSwKCiAgdW5iaW5kRGF0YU9iamVjdDogZnVuY3Rpb24gKGRhdGFPYmplY3QpIHsKICAgIGlmICghdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBkZWxldGUgdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXTsKICAgIHRoaXMuc3RvcExpc3RlbmluZyhkYXRhT2JqZWN0KTsKICAgIGRlbGV0ZSB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbZGF0YU9iamVjdC5jaWRdOwogICAgcmV0dXJuIHRydWU7CiAgfSwKCiAgX21vZGlmeURhdGFPYmplY3RPcHRpb25zOiBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9uczsKICB9Cn0pOwoKZnVuY3Rpb24gYmluZEV2ZW50cyh0eXBlLCB0YXJnZXQsIHNvdXJjZSkgewogIHZhciBjb250ZXh0ID0gdGhpczsKICB3YWxrSW5oZXJpdFRyZWUoc291cmNlLCAnXycgKyB0eXBlICsgJ0V2ZW50cycsIHRydWUsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAvLyBnZXRFdmVudENhbGxiYWNrIHdpbGwgcmVzb2x2ZSBpZiBpdCBpcyBhIHN0cmluZyBvciBhIG1ldGhvZAogICAgLy8gYW5kIHJldHVybiBhIG1ldGhvZAogICAgY29udGV4dC5saXN0ZW5Ubyh0YXJnZXQsIGV2ZW50WzBdLCBfLmJpbmQoZ2V0RXZlbnRDYWxsYmFjayhldmVudFsxXSwgY29udGV4dCksIGV2ZW50WzJdIHx8IGNvbnRleHQpKTsKICB9KTsKfQoKZnVuY3Rpb24gbG9hZE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgaWYgKGRhdGFPYmplY3QubG9hZCkgewogICAgZGF0YU9iamVjdC5sb2FkKGZ1bmN0aW9uKCkgewogICAgICBvcHRpb25zICYmIG9wdGlvbnMuc3VjY2VzcyAmJiBvcHRpb25zLnN1Y2Nlc3MoZGF0YU9iamVjdCk7CiAgICB9LCBvcHRpb25zKTsKICB9IGVsc2UgewogICAgZGF0YU9iamVjdC5mZXRjaChvcHRpb25zKTsKICB9Cn0KCmZ1bmN0aW9uIGdldEV2ZW50Q2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQpIHsKICBpZiAoXy5pc0Z1bmN0aW9uKGNhbGxiYWNrKSkgewogICAgcmV0dXJuIGNhbGxiYWNrOwogIH0gZWxzZSB7CiAgICByZXR1cm4gY29udGV4dFtjYWxsYmFja107CiAgfQp9Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXIsIGRhdGFPYmplY3QsIGdldFZhbHVlICovCnZhciBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1tb2RlbC1jaWQnOwoKVGhvcmF4Lk1vZGVsID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKHsKICBpc0VtcHR5OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiAhdGhpcy5pc1BvcHVsYXRlZCgpOwogIH0sCiAgaXNQb3B1bGF0ZWQ6IGZ1bmN0aW9uKCkgewogICAgLy8gV2UgYXJlIHBvcHVsYXRlZCBpZiB3ZSBoYXZlIGF0dHJpYnV0ZXMgc2V0CiAgICB2YXIgYXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKSwKICAgICAgICBkZWZhdWx0cyA9IGdldFZhbHVlKHRoaXMsICdkZWZhdWx0cycpIHx8IHt9OwogICAgZm9yICh2YXIgZGVmYXVsdF9rZXkgaW4gZGVmYXVsdHMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXNbZGVmYXVsdF9rZXldICE9IGRlZmF1bHRzW2RlZmF1bHRfa2V5XSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGRlbGV0ZSBhdHRyaWJ1dGVzW2RlZmF1bHRfa2V5XTsKICAgIH0KICAgIHZhciBrZXlzID0gXy5rZXlzKGF0dHJpYnV0ZXMpOwogICAgcmV0dXJuIGtleXMubGVuZ3RoID4gMSB8fCAoa2V5cy5sZW5ndGggPT09IDEgJiYga2V5c1swXSAhPT0gdGhpcy5pZEF0dHJpYnV0ZSk7CiAgfSwKICBzaG91bGRGZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgLy8gdXJsKCkgd2lsbCB0aHJvdyBpZiBtb2RlbCBoYXMgbm8gYHVybFJvb3RgIGFuZCBubyBgY29sbGVjdGlvbmAKICAgIC8vIG9yIGhhcyBgY29sbGVjdGlvbmAgYW5kIGBjb2xsZWN0aW9uYCBoYXMgbm8gYHVybGAKICAgIHZhciB1cmw7CiAgICB0cnkgewogICAgICB1cmwgPSBnZXRWYWx1ZSh0aGlzLCAndXJsJyk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgdXJsID0gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gb3B0aW9ucy5mZXRjaCAmJiAhIXVybCAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpOwogIH0KfSk7CgpUaG9yYXguTW9kZWxzID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguTW9kZWwsIFRob3JheC5Nb2RlbHMpOwoKZGF0YU9iamVjdCgnbW9kZWwnLCB7CiAgc2V0OiAnc2V0TW9kZWwnLAogIGRlZmF1bHRPcHRpb25zOiB7CiAgICByZW5kZXI6IHRydWUsCiAgICBmZXRjaDogdHJ1ZSwKICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgZXJyb3JzOiB0cnVlCiAgfSwKICBjaGFuZ2U6IG9uTW9kZWxDaGFuZ2UsCiAgJGVsOiAnJGVsJywKICBjaWRBdHRyTmFtZTogbW9kZWxDaWRBdHRyaWJ1dGVOYW1lCn0pOwoKZnVuY3Rpb24gb25Nb2RlbENoYW5nZShtb2RlbCkgewogIHZhciBtb2RlbE9wdGlvbnMgPSBtb2RlbCAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbbW9kZWwuY2lkXTsKICAvLyAhbW9kZWxPcHRpb25zIHdpbGwgYmUgdHJ1ZSB3aGVuIHNldE1vZGVsKGZhbHNlKSBpcyBjYWxsZWQKICBpZiAoIW1vZGVsT3B0aW9ucyB8fCAobW9kZWxPcHRpb25zICYmIG1vZGVsT3B0aW9ucy5yZW5kZXIpKSB7CiAgICB0aGlzLnJlbmRlcigpOwogIH0KfQoKVGhvcmF4LlZpZXcub24oewogIG1vZGVsOiB7CiAgICBlcnJvcjogZnVuY3Rpb24obW9kZWwsIGVycm9ycykgewogICAgICBpZiAodGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW21vZGVsLmNpZF0uZXJyb3JzKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIGVycm9ycywgbW9kZWwpOwogICAgICB9CiAgICB9LAogICAgY2hhbmdlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBvbk1vZGVsQ2hhbmdlLmNhbGwodGhpcywgbW9kZWwpOwogICAgfQogIH0KfSk7CgokLmZuLm1vZGVsID0gZnVuY3Rpb24odmlldykgewogIHZhciAkdGhpcyA9ICQodGhpcyksCiAgICAgIG1vZGVsRWxlbWVudCA9ICR0aGlzLmNsb3Nlc3QoJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJ10nKSwKICAgICAgbW9kZWxDaWQgPSBtb2RlbEVsZW1lbnQgJiYgbW9kZWxFbGVtZW50LmF0dHIobW9kZWxDaWRBdHRyaWJ1dGVOYW1lKTsKICBpZiAobW9kZWxDaWQpIHsKICAgIHZhciB2aWV3ID0gdmlldyB8fCAkdGhpcy52aWV3KCk7CiAgICBpZiAodmlldyAmJiB2aWV3Lm1vZGVsICYmIHZpZXcubW9kZWwuY2lkID09PSBtb2RlbENpZCkgewogICAgICByZXR1cm4gdmlldy5tb2RlbCB8fCBmYWxzZTsKICAgIH0KICAgIHZhciBjb2xsZWN0aW9uID0gJHRoaXMuY29sbGVjdGlvbih2aWV3KTsKICAgIGlmIChjb2xsZWN0aW9uKSB7CiAgICAgIHJldHVybiBjb2xsZWN0aW9uLmdldChtb2RlbENpZCk7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKCjs7Ci8qZ2xvYmFsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciwgZGF0YU9iamVjdCwgZ2V0RXZlbnRDYWxsYmFjaywgZ2V0VmFsdWUsIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgdmlld0NpZEF0dHJpYnV0ZU5hbWUgKi8KdmFyIF9mZXRjaCA9IEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLmZldGNoLAogICAgX3Jlc2V0ID0gQmFja2JvbmUuQ29sbGVjdGlvbi5wcm90b3R5cGUucmVzZXQsCiAgICBfcmVwbGFjZUhUTUwgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX3JlcGxhY2VIVE1MLAogICAgY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWNpZCcsCiAgICBjb2xsZWN0aW9uRW1wdHlBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY29sbGVjdGlvbi1lbXB0eScsCiAgICBjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWVsZW1lbnQnLAogICAgRUxFTUVOVF9OT0RFX1RZUEUgPSAxOwoKVGhvcmF4LkNvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uLmV4dGVuZCh7CiAgbW9kZWw6IFRob3JheC5Nb2RlbCB8fCBCYWNrYm9uZS5Nb2RlbCwKICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnY29sbGVjdGlvbicpOwogICAgcmV0dXJuIEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9LAogIGlzRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5sZW5ndGggPT09IDAgJiYgdGhpcy5pc1BvcHVsYXRlZCgpOwogICAgfQogIH0sCiAgaXNQb3B1bGF0ZWQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2ZldGNoZWQgfHwgdGhpcy5sZW5ndGggPiAwIHx8ICghdGhpcy5sZW5ndGggJiYgIWdldFZhbHVlKHRoaXMsICd1cmwnKSk7CiAgfSwKICBzaG91bGRGZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG9wdGlvbnMuZmV0Y2ggJiYgISFnZXRWYWx1ZSh0aGlzLCAndXJsJykgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9LAogIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24oY29sbGVjdGlvbiwgcmVzcG9uc2UpIHsKICAgICAgY29sbGVjdGlvbi5fZmV0Y2hlZCA9IHRydWU7CiAgICAgIHN1Y2Nlc3MgJiYgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwb25zZSk7CiAgICB9OwogICAgcmV0dXJuIF9mZXRjaC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0sCiAgcmVzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgdGhpcy5fZmV0Y2hlZCA9ICEhbW9kZWxzOwogICAgcmV0dXJuIF9yZXNldC5jYWxsKHRoaXMsIG1vZGVscywgb3B0aW9ucyk7CiAgfQp9KTsKClRob3JheC5Db2xsZWN0aW9ucyA9IHt9OwpjcmVhdGVSZWdpc3RyeVdyYXBwZXIoVGhvcmF4LkNvbGxlY3Rpb24sIFRob3JheC5Db2xsZWN0aW9ucyk7CgpkYXRhT2JqZWN0KCdjb2xsZWN0aW9uJywgewogIHNldDogJ3NldENvbGxlY3Rpb24nLAogIGJpbmRDYWxsYmFjazogb25TZXRDb2xsZWN0aW9uLAogIGRlZmF1bHRPcHRpb25zOiB7CiAgICByZW5kZXI6IHRydWUsCiAgICBmZXRjaDogdHJ1ZSwKICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgZXJyb3JzOiB0cnVlCiAgfSwKICBjaGFuZ2U6IG9uQ29sbGVjdGlvblJlc2V0LAogICRlbDogJ2dldENvbGxlY3Rpb25FbGVtZW50JywKICBjaWRBdHRyTmFtZTogY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUKfSk7CgpUaG9yYXguQ29sbGVjdGlvblZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoewogIF9kZWZhdWx0VGVtcGxhdGU6IEhhbmRsZWJhcnMuVk0ubm9vcCwKICBfY29sbGVjdGlvblNlbGVjdG9yOiAnWycgKyBjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWUgKyAnXScsCgogIC8vIHByZXNlcnZlIGNvbGxlY3Rpb24gZWxlbWVudCBpZiBpdCB3YXMgbm90IGNyZWF0ZWQgd2l0aCB7e2NvbGxlY3Rpb259fSBoZWxwZXIKICBfcmVwbGFjZUhUTUw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIGlmICh0aGlzLmNvbGxlY3Rpb24gJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW3RoaXMuY29sbGVjdGlvbi5jaWRdICYmIHRoaXMuX3JlbmRlckNvdW50KSB7CiAgICAgIHZhciBlbGVtZW50OwogICAgICB2YXIgb2xkQ29sbGVjdGlvbkVsZW1lbnQgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIGVsZW1lbnQgPSBfcmVwbGFjZUhUTUwuY2FsbCh0aGlzLCBodG1sKTsKICAgICAgaWYgKCFvbGRDb2xsZWN0aW9uRWxlbWVudC5hdHRyKCdkYXRhLXZpZXctY2lkJykpIHsKICAgICAgICB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCkucmVwbGFjZVdpdGgob2xkQ29sbGVjdGlvbkVsZW1lbnQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gX3JlcGxhY2VIVE1MLmNhbGwodGhpcywgaHRtbCk7CiAgICB9CiAgfSwKCiAgLy9hcHBlbmRJdGVtKG1vZGVsIFssaW5kZXhdKQogIC8vYXBwZW5kSXRlbShodG1sX3N0cmluZywgaW5kZXgpCiAgLy9hcHBlbmRJdGVtKHZpZXcsIGluZGV4KQogIGFwcGVuZEl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpbmRleCwgb3B0aW9ucykgewogICAgLy9lbXB0eSBpdGVtCiAgICBpZiAoIW1vZGVsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBpdGVtVmlldywKICAgICAgICAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgIGZpbHRlcjogdHJ1ZQogICAgfSk7CiAgICAvL2lmIGluZGV4IGFyZ3VtZW50IGlzIGEgdmlldwogICAgaW5kZXggJiYgaW5kZXguZWwgJiYgKGluZGV4ID0gJGVsLmNoaWxkcmVuKCkuaW5kZXhPZihpbmRleC5lbCkgKyAxKTsKICAgIC8vaWYgYXJndW1lbnQgaXMgYSB2aWV3LCBvciBodG1sIHN0cmluZwogICAgaWYgKG1vZGVsLmVsIHx8IF8uaXNTdHJpbmcobW9kZWwpKSB7CiAgICAgIGl0ZW1WaWV3ID0gbW9kZWw7CiAgICAgIG1vZGVsID0gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICBpbmRleCA9IGluZGV4IHx8IHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSB8fCAwOwogICAgICBpdGVtVmlldyA9IHRoaXMucmVuZGVySXRlbShtb2RlbCwgaW5kZXgpOwogICAgfQogICAgaWYgKGl0ZW1WaWV3KSB7CiAgICAgIGl0ZW1WaWV3LmNpZCAmJiB0aGlzLl9hZGRDaGlsZChpdGVtVmlldyk7CiAgICAgIC8vaWYgdGhlIHJlbmRlcmVyJ3Mgb3V0cHV0IHdhc24ndCBjb250YWluZWQgaW4gYSB0YWcsIHdyYXAgaXQgaW4gYSBkaXYKICAgICAgLy9wbGFpbiB0ZXh0LCBvciBhIG1peHR1cmUgb2YgdG9wIGxldmVsIHRleHQgbm9kZXMgYW5kIGVsZW1lbnQgbm9kZXMKICAgICAgLy93aWxsIGdldCB3cmFwcGVkCiAgICAgIGlmIChfLmlzU3RyaW5nKGl0ZW1WaWV3KSAmJiAhaXRlbVZpZXcubWF0Y2goL15ccyo8L20pKSB7CiAgICAgICAgaXRlbVZpZXcgPSAnPGRpdj4nICsgaXRlbVZpZXcgKyAnPC9kaXY+JzsKICAgICAgfQogICAgICB2YXIgaXRlbUVsZW1lbnQgPSBpdGVtVmlldy5lbCA/IFtpdGVtVmlldy5lbF0gOiBfLmZpbHRlcigkKCQudHJpbShpdGVtVmlldykpLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy9maWx0ZXIgb3V0IHRvcCBsZXZlbCB3aGl0ZXNwYWNlIG5vZGVzCiAgICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERV9UWVBFOwogICAgICB9KTsKICAgICAgbW9kZWwgJiYgJChpdGVtRWxlbWVudCkuYXR0cihtb2RlbENpZEF0dHJpYnV0ZU5hbWUsIG1vZGVsLmNpZCk7CiAgICAgIHZhciBwcmV2aW91c01vZGVsID0gaW5kZXggPiAwID8gdGhpcy5jb2xsZWN0aW9uLmF0KGluZGV4IC0gMSkgOiBmYWxzZTsKICAgICAgaWYgKCFwcmV2aW91c01vZGVsKSB7CiAgICAgICAgJGVsLnByZXBlbmQoaXRlbUVsZW1lbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vdXNlIGxhc3QoKSBhcyBhcHBlbmRJdGVtIGNhbiBhY2NlcHQgbXVsdGlwbGUgbm9kZXMgZnJvbSBhIHRlbXBsYXRlCiAgICAgICAgdmFyIGxhc3QgPSAkZWwuY2hpbGRyZW4oJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIHByZXZpb3VzTW9kZWwuY2lkICsgJyJdJykubGFzdCgpOwogICAgICAgIGxhc3QuYWZ0ZXIoaXRlbUVsZW1lbnQpOwogICAgICB9CgogICAgICB0aGlzLnRyaWdnZXIoJ2FwcGVuZCcsIG51bGwsIGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgZWwuc2V0QXR0cmlidXRlKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgbW9kZWwuY2lkKTsKICAgICAgfSk7CgogICAgICAhb3B0aW9ucy5zaWxlbnQgJiYgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZDppdGVtJywgdGhpcywgdGhpcy5jb2xsZWN0aW9uLCBtb2RlbCwgaXRlbUVsZW1lbnQsIGluZGV4KTsKICAgICAgb3B0aW9ucy5maWx0ZXIgJiYgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfQogICAgcmV0dXJuIGl0ZW1WaWV3OwogIH0sCiAgLy/CoHVwZGF0ZUl0ZW0gb25seSB1c2VmdWwgaWYgdGhlcmUgaXMgbm8gaXRlbSB2aWV3LCBvdGhlcndpc2UKICAvL8KgaXRlbVZpZXcucmVuZGVyKCkgcHJvdmlkZXMgdGhlIHNhbWUgZnVuY3Rpb25hbGl0eQogIHVwZGF0ZUl0ZW06IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB0aGlzLnJlbW92ZUl0ZW0obW9kZWwpOwogICAgdGhpcy5hcHBlbmRJdGVtKG1vZGVsKTsKICB9LAogIHJlbW92ZUl0ZW06IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpLAogICAgICAgIHZpZXdFbCA9ICRlbC5maW5kKCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICc9IicgKyBtb2RlbC5jaWQgKyAnIl0nKTsKICAgIGlmICghdmlld0VsLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2aWV3RWwucmVtb3ZlKCk7CiAgICB2YXIgdmlld0NpZCA9IHZpZXdFbC5hdHRyKHZpZXdDaWRBdHRyaWJ1dGVOYW1lKSwKICAgICAgICBjaGlsZCA9IHRoaXMuY2hpbGRyZW5bdmlld0NpZF07CiAgICBpZiAoY2hpbGQpIHsKICAgICAgdGhpcy5fcmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICBjaGlsZC5kZXN0cm95KCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIHJlbmRlckNvbGxlY3Rpb246IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuY29sbGVjdGlvbikgewogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uLmlzRW1wdHkoKSkgewogICAgICAgIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkuY2FsbCh0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBoYW5kbGVDaGFuZ2VGcm9tRW1wdHlUb05vdEVtcHR5LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5jb2xsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaSkgewogICAgICAgICAgdGhpcy5hcHBlbmRJdGVtKGl0ZW0sIGkpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlcigncmVuZGVyZWQ6Y29sbGVjdGlvbicsIHRoaXMsIHRoaXMuY29sbGVjdGlvbik7CiAgICAgIGFwcGx5VmlzaWJpbGl0eUZpbHRlci5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgfQogIH0sCiAgZW1wdHlDbGFzczogJ2VtcHR5JywKICByZW5kZXJFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuZW1wdHlUZW1wbGF0ZSAmJiAhdGhpcy5lbXB0eVZpZXcpIHsKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAnZW1wdHlUZW1wbGF0ZScsIHsKICAgICAgICBleHRlbnNpb246ICctZW1wdHknLAogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLmVtcHR5VmlldykgewogICAgICB2YXIgdmlld09wdGlvbnMgPSB7fTsKICAgICAgaWYgKHRoaXMuZW1wdHlUZW1wbGF0ZSkgewogICAgICAgIHZpZXdPcHRpb25zLnRlbXBsYXRlID0gdGhpcy5lbXB0eVRlbXBsYXRlOwogICAgICB9CiAgICAgIHZhciB2aWV3ID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuZW1wdHlWaWV3LCB2aWV3T3B0aW9ucyk7CiAgICAgIHZpZXcuZW5zdXJlUmVuZGVyZWQoKTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5lbXB0eVRlbXBsYXRlICYmIHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy5lbXB0eVRlbXBsYXRlKTsKICAgIH0KICB9LAogIHJlbmRlckl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpKSB7CiAgICBpZiAoIXRoaXMuaXRlbVRlbXBsYXRlICYmICF0aGlzLml0ZW1WaWV3KSB7CiAgICAgIGFzc2lnblRlbXBsYXRlLmNhbGwodGhpcywgJ2l0ZW1UZW1wbGF0ZScsIHsKICAgICAgICBleHRlbnNpb246ICctaXRlbScsCiAgICAgICAgLy8gb25seSByZXF1aXJlIGFuIGl0ZW1UZW1wbGF0ZSBpZiBhbiBpdGVtVmlldwogICAgICAgIC8vIGlzIG5vdCBwcmVzZW50CiAgICAgICAgcmVxdWlyZWQ6ICF0aGlzLml0ZW1WaWV3CiAgICAgIH0pOwogICAgfQogICAgaWYgKHRoaXMuaXRlbVZpZXcpIHsKICAgICAgdmFyIHZpZXdPcHRpb25zID0gewogICAgICAgIG1vZGVsOiBtb2RlbAogICAgICB9OwogICAgICBpZiAodGhpcy5pdGVtVGVtcGxhdGUpIHsKICAgICAgICB2aWV3T3B0aW9ucy50ZW1wbGF0ZSA9IHRoaXMuaXRlbVRlbXBsYXRlOwogICAgICB9CiAgICAgIHZhciB2aWV3ID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuaXRlbVZpZXcsIHZpZXdPcHRpb25zKTsKICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLnJlbmRlclRlbXBsYXRlKHRoaXMuaXRlbVRlbXBsYXRlLCB0aGlzLml0ZW1Db250ZXh0KG1vZGVsLCBpKSk7CiAgICB9CiAgfSwKICBpdGVtQ29udGV4dDogZnVuY3Rpb24obW9kZWwgLyosIGkgKi8pIHsKICAgIHJldHVybiBtb2RlbC5hdHRyaWJ1dGVzOwogIH0sCiAgYXBwZW5kRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICRlbC5lbXB0eSgpOwogICAgdmFyIGVtcHR5Q29udGVudCA9IHRoaXMucmVuZGVyRW1wdHkoKTsKICAgIGVtcHR5Q29udGVudCAmJiB0aGlzLmFwcGVuZEl0ZW0oZW1wdHlDb250ZW50LCAwLCB7CiAgICAgIHNpbGVudDogdHJ1ZSwKICAgICAgZmlsdGVyOiBmYWxzZQogICAgfSk7CiAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOmVtcHR5JywgdGhpcywgdGhpcy5jb2xsZWN0aW9uKTsKICB9LAogIGdldENvbGxlY3Rpb25FbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIHZhciBlbGVtZW50ID0gdGhpcy4kKHRoaXMuX2NvbGxlY3Rpb25TZWxlY3Rvcik7CiAgICByZXR1cm4gZWxlbWVudC5sZW5ndGggPT09IDAgPyB0aGlzLiRlbCA6IGVsZW1lbnQ7CiAgfQp9KTsKClRob3JheC5Db2xsZWN0aW9uVmlldy5vbih7CiAgY29sbGVjdGlvbjogewogICAgcmVzZXQ6IG9uQ29sbGVjdGlvblJlc2V0LAogICAgc29ydDogb25Db2xsZWN0aW9uUmVzZXQsCiAgICBmaWx0ZXI6IGZ1bmN0aW9uKCkgewogICAgICBhcHBseVZpc2liaWxpdHlGaWx0ZXIuY2FsbCh0aGlzKTsKICAgIH0sCiAgICBjaGFuZ2U6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIC8vIElmIHdlIHJlbmRlcmVkIHdpdGggaXRlbSB2aWV3cywgbW9kZWwgY2hhbmdlcyB3aWxsIGJlIG9ic2VydmVkCiAgICAgIC8vIGJ5IHRoZSBnZW5lcmF0ZWQgaXRlbSB2aWV3IGJ1dCBpZiB3ZSByZW5kZXJlZCB3aXRoIHRlbXBsYXRlcwogICAgICAvLyB0aGVuIG1vZGVsIGNoYW5nZXMgbmVlZCB0byBiZSBib3VuZCBhcyBub3RoaW5nIGlzIHdhdGNoaW5nCiAgICAgICF0aGlzLml0ZW1WaWV3ICYmIHRoaXMudXBkYXRlSXRlbShtb2RlbCk7CiAgICAgIGFwcGx5SXRlbVZpc2libGl0eUZpbHRlci5jYWxsKHRoaXMsIG1vZGVsKTsKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDEgJiYgJGVsLmxlbmd0aCAmJiBoYW5kbGVDaGFuZ2VGcm9tRW1wdHlUb05vdEVtcHR5LmNhbGwodGhpcyk7CiAgICAgIGlmICgkZWwubGVuZ3RoKSB7CiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMuYXBwZW5kSXRlbShtb2RlbCwgaW5kZXgpOwogICAgICB9CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgICB0aGlzLnJlbW92ZUl0ZW0obW9kZWwpOwogICAgICB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoID09PSAwICYmICRlbC5sZW5ndGggJiYgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgfQogIH0KfSk7CgpUaG9yYXguVmlldy5vbih7CiAgY29sbGVjdGlvbjogewogICAgZXJyb3I6IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIG1lc3NhZ2UpIHsKICAgICAgaWYgKHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtjb2xsZWN0aW9uLmNpZF0uZXJyb3JzKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIG1lc3NhZ2UsIGNvbGxlY3Rpb24pOwogICAgICB9CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIG9uQ29sbGVjdGlvblJlc2V0KGNvbGxlY3Rpb24pIHsKICB2YXIgb3B0aW9ucyA9IGNvbGxlY3Rpb24gJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2NvbGxlY3Rpb24uY2lkXTsKICAvLyB3ZSB3b3VsZCB3YW50IHRvIHN0aWxsIHJlbmRlciBpbiB0aGUgY2FzZSB0aGF0IHRoZQogIC8vIGNvbGxlY3Rpb24gaGFzIHRyYW5zaXRpb25lZCB0byBiZWluZyBmYWxzeQogIGlmICghY29sbGVjdGlvbiB8fCAob3B0aW9ucyAmJiBvcHRpb25zLnJlbmRlcikpIHsKICAgIHRoaXMucmVuZGVyQ29sbGVjdGlvbiAmJiB0aGlzLnJlbmRlckNvbGxlY3Rpb24oKTsKICB9Cn0KCi8vIEV2ZW4gaWYgdGhlIHZpZXcgaXMgbm90IGEgQ29sbGVjdGlvblZpZXcKLy8gZW5zdXJlUmVuZGVyZWQoKSB0byBwcm92aWRlIHNpbWlsYXIgYmVoYXZpb3IKLy8gdG8gYSBtb2RlbApmdW5jdGlvbiBvblNldENvbGxlY3Rpb24oKSB7CiAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwp9CgpmdW5jdGlvbiBhcHBseVZpc2liaWxpdHlGaWx0ZXIoKSB7CiAgaWYgKHRoaXMuaXRlbUZpbHRlcikgewogICAgdGhpcy5jb2xsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24obW9kZWwpIHsKICAgICAgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfSwgdGhpcyk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIobW9kZWwpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuaXRlbUZpbHRlciAmJiAkZWwuZmluZCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgbW9kZWwuY2lkICsgJyJdJylbaXRlbVNob3VsZEJlVmlzaWJsZS5jYWxsKHRoaXMsIG1vZGVsKSA/ICdzaG93JyA6ICdoaWRlJ10oKTsKfQoKZnVuY3Rpb24gaXRlbVNob3VsZEJlVmlzaWJsZShtb2RlbCkgewogIHJldHVybiB0aGlzLml0ZW1GaWx0ZXIobW9kZWwsIHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLnJlbW92ZUNsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLnJlbW92ZUF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSk7CiAgJGVsLmVtcHR5KCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLmFkZENsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLmF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSwgdHJ1ZSk7CiAgdGhpcy5hcHBlbmRFbXB0eSgpOwp9CgovLyQoc2VsZWN0b3IpLmNvbGxlY3Rpb24oKSBoZWxwZXIKJC5mbi5jb2xsZWN0aW9uID0gZnVuY3Rpb24odmlldykgewogIGlmICh2aWV3ICYmIHZpZXcuY29sbGVjdGlvbikgewogICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICB9CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgY29sbGVjdGlvbkVsZW1lbnQgPSAkdGhpcy5jbG9zZXN0KCdbJyArIGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lICsgJ10nKSwKICAgICAgY29sbGVjdGlvbkNpZCA9IGNvbGxlY3Rpb25FbGVtZW50ICYmIGNvbGxlY3Rpb25FbGVtZW50LmF0dHIoY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUpOwogIGlmIChjb2xsZWN0aW9uQ2lkKSB7CiAgICB2aWV3ID0gJHRoaXMudmlldygpOwogICAgaWYgKHZpZXcpIHsKICAgICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgaW5oZXJpdFZhcnMgKi8KCmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCnZhciBvbGRNb2RlbENoYW5nZSA9IGluaGVyaXRWYXJzLm1vZGVsLmNoYW5nZTsKaW5oZXJpdFZhcnMubW9kZWwuY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgb2xkTW9kZWxDaGFuZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAvLyBUT0RPIDogV2hhdCBjYW4gd2UgZG8gdG8gcmVtb3ZlIHRoaXMgZHVwbGljYXRpb24/CiAgdmFyIG1vZGVsT3B0aW9ucyA9IHRoaXMubW9kZWwgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW3RoaXMubW9kZWwuY2lkXTsKICBpZiAobW9kZWxPcHRpb25zICYmIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSkgewogICAgdGhpcy5wb3B1bGF0ZSh0aGlzLm1vZGVsLmF0dHJpYnV0ZXMsIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSA9PT0gdHJ1ZSA/IHt9IDogbW9kZWxPcHRpb25zLnBvcHVsYXRlKTsKICB9Cn07CmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIC8vc2VyaWFsaXplcyBhIGZvcm0gcHJlc2VudCBpbiB0aGUgdmlldywgcmV0dXJuaW5nIHRoZSBzZXJpYWxpemVkIGRhdGEKICAvL2FzIGFuIG9iamVjdAogIC8vcGFzcyB7c2V0OmZhbHNlfSB0byBub3QgdXBkYXRlIHRoaXMubW9kZWwgaWYgcHJlc2VudAogIC8vY2FuIHBhc3Mgb3B0aW9ucywgY2FsbGJhY2sgb3IgZXZlbnQgaW4gYW55IG9yZGVyCiAgc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKICAgIHZhciBjYWxsYmFjaywgb3B0aW9ucywgZXZlbnQ7CiAgICAvL2lnbm9yZSB1bmRlZmluZWQgYXJndW1lbnRzIGluIGNhc2UgZXZlbnQgd2FzIG51bGwKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oYXJndW1lbnRzW2ldKSkgewogICAgICAgIGNhbGxiYWNrID0gYXJndW1lbnRzW2ldOwogICAgICB9IGVsc2UgaWYgKF8uaXNPYmplY3QoYXJndW1lbnRzW2ldKSkgewogICAgICAgIGlmICgnc3RvcFByb3BhZ2F0aW9uJyBpbiBhcmd1bWVudHNbaV0gJiYgJ3ByZXZlbnREZWZhdWx0JyBpbiBhcmd1bWVudHNbaV0pIHsKICAgICAgICAgIGV2ZW50ID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvcHRpb25zID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChldmVudCAmJiAhdGhpcy5fcHJldmVudER1cGxpY2F0ZVN1Ym1pc3Npb24oZXZlbnQpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBvcHRpb25zID0gXy5leHRlbmQoewogICAgICBzZXQ6IHRydWUsCiAgICAgIHZhbGlkYXRlOiB0cnVlLAogICAgICBjaGlsZHJlbjogdHJ1ZSwKICAgICAgc2lsZW50OiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgYXR0cmlidXRlcyA9IG9wdGlvbnMuYXR0cmlidXRlcyB8fCB7fTsKCiAgICAvL2NhbGxiYWNrIGhhcyBjb250ZXh0IG9mIGVsZW1lbnQKICAgIHZhciB2aWV3ID0gdGhpczsKICAgIHZhciBlcnJvcnMgPSBbXTsKICAgIGVhY2hOYW1lZElucHV0LmNhbGwodGhpcywgb3B0aW9ucywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YWx1ZSA9IHZpZXcuX2dldElucHV0VmFsdWUodGhpcywgb3B0aW9ucywgZXJyb3JzKTsKICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgIG9iamVjdEFuZEtleUZyb21BdHRyaWJ1dGVzQW5kTmFtZS5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIHRoaXMubmFtZSwge21vZGU6ICdzZXJpYWxpemUnfSwgZnVuY3Rpb24ob2JqZWN0LCBrZXkpIHsKICAgICAgICAgIGlmICghb2JqZWN0W2tleV0pIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KG9iamVjdFtrZXldKSkgewogICAgICAgICAgICBvYmplY3Rba2V5XS5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9iamVjdFtrZXldID0gW29iamVjdFtrZXldLCB2YWx1ZV07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMudHJpZ2dlcignc2VyaWFsaXplJywgYXR0cmlidXRlcywgb3B0aW9ucyk7CgogICAgaWYgKG9wdGlvbnMudmFsaWRhdGUpIHsKICAgICAgdmFyIHZhbGlkYXRlSW5wdXRFcnJvcnMgPSB0aGlzLnZhbGlkYXRlSW5wdXQoYXR0cmlidXRlcyk7CiAgICAgIGlmICh2YWxpZGF0ZUlucHV0RXJyb3JzICYmIHZhbGlkYXRlSW5wdXRFcnJvcnMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3JzID0gZXJyb3JzLmNvbmNhdCh2YWxpZGF0ZUlucHV0RXJyb3JzKTsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIoJ3ZhbGlkYXRlJywgYXR0cmlidXRlcywgZXJyb3JzLCBvcHRpb25zKTsKICAgICAgaWYgKGVycm9ycy5sZW5ndGgpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgZXJyb3JzKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICBpZiAob3B0aW9ucy5zZXQgJiYgdGhpcy5tb2RlbCkgewogICAgICBpZiAoIXRoaXMubW9kZWwuc2V0KGF0dHJpYnV0ZXMsIHtzaWxlbnQ6IG9wdGlvbnMuc2lsZW50fSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KCiAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIF8uYmluZChyZXNldFN1Ym1pdFN0YXRlLCB0aGlzKSk7CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9LAoKICBfcHJldmVudER1cGxpY2F0ZVN1Ym1pc3Npb246IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjaykgewogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICB2YXIgZm9ybSA9ICQoZXZlbnQudGFyZ2V0KTsKICAgIGlmICgoZXZlbnQudGFyZ2V0LnRhZ05hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgIT09ICdmb3JtJykgewogICAgICAvLyBIYW5kbGUgbm9uLXN1Ym1pdCBldmVudHMgYnkgZ2F0aW5nIG9uIHRoZSBmb3JtCiAgICAgIGZvcm0gPSAkKGV2ZW50LnRhcmdldCkuY2xvc2VzdCgnZm9ybScpOwogICAgfQoKICAgIGlmICghZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JykpIHsKICAgICAgZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JywgJ3RydWUnKTsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzLCBldmVudCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgLy9wb3B1bGF0ZSBhIGZvcm0gZnJvbSB0aGUgcGFzc2VkIGF0dHJpYnV0ZXMgb3IgdGhpcy5tb2RlbCBpZiBwcmVzZW50CiAgcG9wdWxhdGU6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgdmFsdWUsCiAgICAgICAgYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXMgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwoKICAgIC8vY2FsbGJhY2sgaGFzIGNvbnRleHQgb2YgZWxlbWVudAogICAgZWFjaE5hbWVkSW5wdXQuY2FsbCh0aGlzLCBvcHRpb25zLCBmdW5jdGlvbigpIHsKICAgICAgb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lLmNhbGwodGhpcywgYXR0cmlidXRlcywgdGhpcy5uYW1lLCB7bW9kZTogJ3BvcHVsYXRlJ30sIGZ1bmN0aW9uKG9iamVjdCwga2V5KSB7CiAgICAgICAgdmFsdWUgPSBvYmplY3QgJiYgb2JqZWN0W2tleV07CgogICAgICAgIGlmICghXy5pc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIC8vd2lsbCBvbmx5IGV4ZWN1dGUgaWYgd2UgaGF2ZSBhIG5hbWUgdGhhdCBtYXRjaGVzIHRoZSBzdHJ1Y3R1cmUgaW4gYXR0cmlidXRlcwogICAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JyAmJiBfLmlzQm9vbGVhbih2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5jaGVja2VkID0gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JyB8fCB0aGlzLnR5cGUgPT09ICdyYWRpbycpIHsKICAgICAgICAgICAgdGhpcy5jaGVja2VkID0gdmFsdWUgPT0gdGhpcy52YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CgogICAgdGhpcy50cmlnZ2VyKCdwb3B1bGF0ZScsIGF0dHJpYnV0ZXMpOwogIH0sCgogIC8vcGVyZm9ybSBmb3JtIHZhbGlkYXRpb24sIGltcGxlbWVudGVkIGJ5IGNoaWxkIGNsYXNzCiAgdmFsaWRhdGVJbnB1dDogZnVuY3Rpb24oLyogYXR0cmlidXRlcywgb3B0aW9ucywgZXJyb3JzICovKSB7fSwKCiAgX2dldElucHV0VmFsdWU6IGZ1bmN0aW9uKGlucHV0IC8qICwgb3B0aW9ucywgZXJyb3JzICovKSB7CiAgICBpZiAoaW5wdXQudHlwZSA9PT0gJ2NoZWNrYm94JyB8fCBpbnB1dC50eXBlID09PSAncmFkaW8nKSB7CiAgICAgIGlmIChpbnB1dC5jaGVja2VkKSB7CiAgICAgICAgcmV0dXJuIGlucHV0LnZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlucHV0Lm11bHRpcGxlID09PSB0cnVlKSB7CiAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgJCgnb3B0aW9uJywgaW5wdXQpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWQpIHsKICAgICAgICAgIHZhbHVlcy5wdXNoKHRoaXMudmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaW5wdXQudmFsdWU7CiAgICB9CiAgfQp9KTsKClRob3JheC5WaWV3Lm9uKHsKICBlcnJvcjogZnVuY3Rpb24oKSB7CiAgICByZXNldFN1Ym1pdFN0YXRlLmNhbGwodGhpcyk7CgogICAgLy8gSWYgd2UgZXJyb3JlZCB3aXRoIGEgbW9kZWwgd2Ugd2FudCB0byByZXNldCB0aGUgY29udGVudCBidXQgbGVhdmUgdGhlIFVJCiAgICAvLyBpbnRhY3QuIElmIHRoZSB1c2VyIHVwZGF0ZXMgdGhlIGRhdGEgYW5kIHNlcmlhbGl6ZXMgYW55IG92ZXJ3cml0dGVuIGRhdGEKICAgIC8vIHdpbGwgYmUgcmVzdG9yZWQuCiAgICBpZiAodGhpcy5tb2RlbCAmJiB0aGlzLm1vZGVsLnByZXZpb3VzQXR0cmlidXRlcykgewogICAgICB0aGlzLm1vZGVsLnNldCh0aGlzLm1vZGVsLnByZXZpb3VzQXR0cmlidXRlcygpLCB7CiAgICAgICAgc2lsZW50OiB0cnVlCiAgICAgIH0pOwogICAgfQogIH0sCiAgZGVhY3RpdmF0ZWQ6IGZ1bmN0aW9uKCkgewogICAgcmVzZXRTdWJtaXRTdGF0ZS5jYWxsKHRoaXMpOwogIH0KfSk7CgpmdW5jdGlvbiBlYWNoTmFtZWRJbnB1dChvcHRpb25zLCBpdGVyYXRvciwgY29udGV4dCkgewogIHZhciBpID0gMCwKICAgICAgc2VsZiA9IHRoaXM7CgogIHRoaXMuJCgnc2VsZWN0LGlucHV0LHRleHRhcmVhJywgb3B0aW9ucy5yb290IHx8IHRoaXMuZWwpLmVhY2goZnVuY3Rpb24oKSB7CiAgICBpZiAoIW9wdGlvbnMuY2hpbGRyZW4pIHsKICAgICAgaWYgKHNlbGYgIT09ICQodGhpcykudmlldyh7aGVscGVyOiBmYWxzZX0pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy50eXBlICE9PSAnYnV0dG9uJyAmJiB0aGlzLnR5cGUgIT09ICdjYW5jZWwnICYmIHRoaXMudHlwZSAhPT0gJ3N1Ym1pdCcgJiYgdGhpcy5uYW1lICYmIHRoaXMubmFtZSAhPT0gJycpIHsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0IHx8IHRoaXMsIGksIHRoaXMpOwogICAgICArK2k7CiAgICB9CiAgfSk7Cn0KCi8vY2FsbHMgYSBjYWxsYmFjayB3aXRoIHRoZSBjb3JyZWN0IG9iamVjdCBmcmFnbWVudCBhbmQga2V5IGZyb20gYSBjb21wb3VuZCBuYW1lCmZ1bmN0aW9uIG9iamVjdEFuZEtleUZyb21BdHRyaWJ1dGVzQW5kTmFtZShhdHRyaWJ1dGVzLCBuYW1lLCBvcHRpb25zLCBjYWxsYmFjaykgewogIHZhciBrZXksCiAgICAgIG9iamVjdCA9IGF0dHJpYnV0ZXMsCiAgICAgIGtleXMgPSBuYW1lLnNwbGl0KCdbJyksCiAgICAgIG1vZGUgPSBvcHRpb25zLm1vZGU7CgogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGggLSAxOyArK2kpIHsKICAgIGtleSA9IGtleXNbaV0ucmVwbGFjZSgnXScsICcnKTsKICAgIGlmICghb2JqZWN0W2tleV0pIHsKICAgICAgaWYgKG1vZGUgPT09ICdzZXJpYWxpemUnKSB7CiAgICAgICAgb2JqZWN0W2tleV0gPSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbCh0aGlzLCBmYWxzZSwga2V5KTsKICAgICAgfQogICAgfQogICAgb2JqZWN0ID0gb2JqZWN0W2tleV07CiAgfQogIGtleSA9IGtleXNba2V5cy5sZW5ndGggLSAxXS5yZXBsYWNlKCddJywgJycpOwogIGNhbGxiYWNrLmNhbGwodGhpcywgb2JqZWN0LCBrZXkpOwp9CgpmdW5jdGlvbiByZXNldFN1Ym1pdFN0YXRlKCkgewogIHRoaXMuJCgnZm9ybScpLnJlbW92ZUF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnKTsKfQoKOzsKdmFyIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1sYXlvdXQtY2lkJzsKClRob3JheC5MYXlvdXRWaWV3ID0gVGhvcmF4LlZpZXcuZXh0ZW5kKHsKICBfZGVmYXVsdFRlbXBsYXRlOiBIYW5kbGViYXJzLlZNLm5vb3AsCiAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmICh0aGlzLnRlbXBsYXRlID09PSBIYW5kbGViYXJzLlZNLm5vb3ApIHsKICAgICAgLy8gaWYgdGhlcmUgaXMgbm8gdGVtcGxhdGUgc2V0VmlldyB3aWxsIGFwcGVuZCB0byB0aGlzLiRlbAogICAgICBlbnN1cmVMYXlvdXRDaWQuY2FsbCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIGlmIGEgdGVtcGxhdGUgd2FzIHNwZWNpZmllZCBpcyBtdXN0IGRlY2xhcmUgYSBsYXlvdXQtZWxlbWVudAogICAgICBlbnN1cmVMYXlvdXRWaWV3c1RhcmdldEVsZW1lbnQuY2FsbCh0aGlzKTsKICAgIH0KICAgIHJldHVybiByZXNwb25zZTsKICB9LAogIHNldFZpZXc6IGZ1bmN0aW9uKHZpZXcsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIHNjcm9sbDogdHJ1ZSwKICAgICAgZGVzdHJveTogdHJ1ZQogICAgfSwgb3B0aW9ucyB8fCB7fSk7CiAgICBpZiAoXy5pc1N0cmluZyh2aWV3KSkgewogICAgICB2aWV3ID0gbmV3IChUaG9yYXguVXRpbC5yZWdpc3RyeUdldChUaG9yYXgsICdWaWV3cycsIHZpZXcsIGZhbHNlKSkoKTsKICAgIH0KICAgIHRoaXMuZW5zdXJlUmVuZGVyZWQoKTsKICAgIHZhciBvbGRWaWV3ID0gdGhpcy5fdmlldzsKICAgIGlmICh2aWV3ID09PSBvbGRWaWV3KSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChvcHRpb25zLmRlc3Ryb3kgJiYgdmlldykgewogICAgICB2aWV3Ll9zaG91bGREZXN0cm95T25OZXh0U2V0VmlldyA9IHRydWU7CiAgICB9CgogICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6dmlldzpzdGFydCcsIHZpZXcsIG9sZFZpZXcsIG9wdGlvbnMpOwoKICAgIGlmIChvbGRWaWV3KSB7CiAgICAgIHRoaXMuX3JlbW92ZUNoaWxkKG9sZFZpZXcpOwogICAgICBvbGRWaWV3LiRlbC5yZW1vdmUoKTsKICAgICAgdHJpZ2dlckxpZmVjeWNsZUV2ZW50LmNhbGwob2xkVmlldywgJ2RlYWN0aXZhdGVkJywgb3B0aW9ucyk7CiAgICAgIGlmIChvbGRWaWV3Ll9zaG91bGREZXN0cm95T25OZXh0U2V0VmlldykgewogICAgICAgIG9sZFZpZXcuZGVzdHJveSgpOwogICAgICB9CiAgICB9CgogICAgaWYgKHZpZXcpIHsKICAgICAgdHJpZ2dlckxpZmVjeWNsZUV2ZW50LmNhbGwodGhpcywgJ2FjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICB2aWV3LnRyaWdnZXIoJ2FjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9hZGRDaGlsZCh2aWV3KTsKICAgICAgdGhpcy5fdmlldyA9IHZpZXc7CiAgICAgIHRoaXMuX3ZpZXcuYXBwZW5kVG8oZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50LmNhbGwodGhpcykpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdmlldyA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTp2aWV3OmVuZCcsIHZpZXcsIG9sZFZpZXcsIG9wdGlvbnMpOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgZ2V0VmlldzogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fdmlldzsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbGF5b3V0LWVsZW1lbnQnLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIHZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3OwogIC8vIGR1Y2sgdHlwZSBjaGVjayBmb3IgTGF5b3V0VmlldwogIGlmICghdmlldy5nZXRWaWV3KSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ2xheW91dC1lbGVtZW50IG11c3QgYmUgdXNlZCB3aXRoaW4gYSBMYXlvdXRWaWV3Jyk7CiAgfQogIG9wdGlvbnMuaGFzaFtsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lXSA9IHZpZXcuY2lkOwogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMuaGFzaCk7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnLmNhbGwodGhpcywgb3B0aW9ucy5oYXNoLCAnJywgdGhpcykpOwp9KTsKCmZ1bmN0aW9uIHRyaWdnZXJMaWZlY3ljbGVFdmVudChldmVudE5hbWUsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBvcHRpb25zLnRhcmdldCA9IHRoaXM7CiAgdGhpcy50cmlnZ2VyKGV2ZW50TmFtZSwgb3B0aW9ucyk7CiAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICBjaGlsZC50cmlnZ2VyKGV2ZW50TmFtZSwgb3B0aW9ucyk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGVuc3VyZUxheW91dENpZCgpIHsKICArK3RoaXMuX3JlbmRlckNvdW50OwogIC8vc2V0IHRoZSBsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lIG9uIHRoaXMuJGVsIGlmIHRoZXJlIHdhcyBubyB0ZW1wbGF0ZQogIHRoaXMuJGVsLmF0dHIobGF5b3V0Q2lkQXR0cmlidXRlTmFtZSwgdGhpcy5jaWQpOwp9CgpmdW5jdGlvbiBlbnN1cmVMYXlvdXRWaWV3c1RhcmdldEVsZW1lbnQoKSB7CiAgaWYgKCF0aGlzLiQoJ1snICsgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSArICc9IicgKyB0aGlzLmNpZCArICciXScpWzBdKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGxheW91dCBlbGVtZW50IGZvdW5kIGluICcgKyAodGhpcy5uYW1lIHx8IHRoaXMuY2lkKSk7CiAgfQp9CgpmdW5jdGlvbiBnZXRMYXlvdXRWaWV3c1RhcmdldEVsZW1lbnQoKSB7CiAgcmV0dXJuIHRoaXMuJCgnWycgKyBsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIHRoaXMuY2lkICsgJyJdJylbMF0gfHwgdGhpcy5lbFswXSB8fCB0aGlzLmVsOwp9Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXIgKi8KCi8vUm91dGVyCmZ1bmN0aW9uIGluaXRpYWxpemVSb3V0ZXIoKSB7CiAgQmFja2JvbmUuaGlzdG9yeSB8fCAoQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBCYWNrYm9uZS5IaXN0b3J5KCkpOwogIEJhY2tib25lLmhpc3Rvcnkub24oJ3JvdXRlJywgb25Sb3V0ZSwgdGhpcyk7CiAgLy9yb3V0ZXIgZG9lcyBub3QgaGF2ZSBhIGJ1aWx0IGluIGRlc3Ryb3kgZXZlbnQKICAvL2J1dCBWaWV3Q29udHJvbGxlciBkb2VzCiAgdGhpcy5vbignZGVzdHJveWVkJywgZnVuY3Rpb24oKSB7CiAgICBCYWNrYm9uZS5oaXN0b3J5Lm9mZigncm91dGUnLCBvblJvdXRlLCB0aGlzKTsKICB9KTsKfQoKVGhvcmF4LlJvdXRlciA9IEJhY2tib25lLlJvdXRlci5leHRlbmQoewogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IFRob3JheC5Sb3V0ZXIuX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpbml0aWFsaXplUm91dGVyLmNhbGwodGhpcyk7CiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgIH0KICAgIC8vYWRkIGEgcm91dGU6YmVmb3JlIGV2ZW50IHRoYXQgaXMgZmlyZWQgYmVmb3JlIHRoZSBjYWxsYmFjayBpcyBjYWxsZWQKICAgIHJldHVybiBCYWNrYm9uZS5Sb3V0ZXIucHJvdG90eXBlLnJvdXRlLmNhbGwodGhpcywgcm91dGUsIG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZTpiZWZvcmUnLCByb3V0ZSwgbmFtZV0uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9KTsKICB9Cn0pOwoKVGhvcmF4LlJvdXRlcnMgPSB7fTsKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5Sb3V0ZXIsIFRob3JheC5Sb3V0ZXJzKTsKCmZ1bmN0aW9uIG9uUm91dGUocm91dGVyIC8qICwgbmFtZSAqLykgewogIGlmICh0aGlzID09PSByb3V0ZXIpIHsKICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBbJ3JvdXRlJ10uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICB9Cn0KCjs7ClRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldyA9IFRob3JheC5Db2xsZWN0aW9uVmlldy5leHRlbmQoewogIC8vIEZvcndhcmQgcmVuZGVyIGV2ZW50cyB0byB0aGUgcGFyZW50CiAgZXZlbnRzOiB7CiAgICAncmVuZGVyZWQ6aXRlbSc6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6aXRlbScpLAogICAgJ3JlbmRlcmVkOmNvbGxlY3Rpb24nOiBmb3J3YXJkUmVuZGVyRXZlbnQoJ3JlbmRlcmVkOmNvbGxlY3Rpb24nKSwKICAgICdyZW5kZXJlZDplbXB0eSc6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6ZW1wdHknKQogIH0sCgogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBfLmVhY2goY29sbGVjdGlvbk9wdGlvbk5hbWVzLCBmdW5jdGlvbih2aWV3QXR0cmlidXRlTmFtZSwgaGVscGVyT3B0aW9uTmFtZSkgewogICAgICBpZiAob3B0aW9ucy5vcHRpb25zW2hlbHBlck9wdGlvbk5hbWVdKSB7CiAgICAgICAgdmFyIHZhbHVlID0gb3B0aW9ucy5vcHRpb25zW2hlbHBlck9wdGlvbk5hbWVdOwogICAgICAgIGlmICh2aWV3QXR0cmlidXRlTmFtZSA9PT0gJ2l0ZW1UZW1wbGF0ZScgfHwgdmlld0F0dHJpYnV0ZU5hbWUgPT09ICdlbXB0eVRlbXBsYXRlJykgewogICAgICAgICAgdmFsdWUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIG9wdGlvbnNbdmlld0F0dHJpYnV0ZU5hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgIH0pOwogICAgLy8gSGFuZGxlYmFycy5WTS5ub29wIGlzIHBhc3NlZCBpbiB0aGUgaGFuZGxlYmFycyBvcHRpb25zIG9iamVjdCBhcwogICAgLy8gYSBkZWZhdWx0IGZvciBmbiBhbmQgaW52ZXJzZSwgaWYgYSBibG9jayB3YXMgcHJlc2VudC4gTmVlZCB0bwogICAgLy8gY2hlY2sgdG8gZW5zdXJlIHdlIGRvbid0IHBpY2sgdGhlIGVtcHR5IC8gbnVsbCBibG9jayB1cC4KICAgIGlmICghb3B0aW9ucy5pdGVtVGVtcGxhdGUgJiYgb3B0aW9ucy50ZW1wbGF0ZSAmJiBvcHRpb25zLnRlbXBsYXRlICE9PSBIYW5kbGViYXJzLlZNLm5vb3ApIHsKICAgICAgb3B0aW9ucy5pdGVtVGVtcGxhdGUgPSBvcHRpb25zLnRlbXBsYXRlOwogICAgICBvcHRpb25zLnRlbXBsYXRlID0gSGFuZGxlYmFycy5WTS5ub29wOwogICAgfQogICAgaWYgKCFvcHRpb25zLmVtcHR5VGVtcGxhdGUgJiYgb3B0aW9ucy5pbnZlcnNlICYmIG9wdGlvbnMuaW52ZXJzZSAhPT0gSGFuZGxlYmFycy5WTS5ub29wKSB7CiAgICAgIG9wdGlvbnMuZW1wdHlUZW1wbGF0ZSA9IG9wdGlvbnMuaW52ZXJzZTsKICAgICAgb3B0aW9ucy5pbnZlcnNlID0gSGFuZGxlYmFycy5WTS5ub29wOwogICAgfQogICAgdmFyIHJlc3BvbnNlID0gVGhvcmF4LkhlbHBlclZpZXcuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgIGlmICh0aGlzLnBhcmVudC5uYW1lKSB7CiAgICAgIGlmICghdGhpcy5lbXB0eVRlbXBsYXRlKSB7CiAgICAgICAgdGhpcy5lbXB0eVRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGhpcy5wYXJlbnQubmFtZSArICctZW1wdHknLCB0cnVlKTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuaXRlbVRlbXBsYXRlKSB7CiAgICAgICAgLy8gaXRlbSB0ZW1wbGF0ZSBtdXN0IGJlIHByZXNlbnQgaWYgYW4gaXRlbVZpZXcgaXMgbm90CiAgICAgICAgdGhpcy5pdGVtVGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLnBhcmVudC5uYW1lICsgJy1pdGVtJywgISF0aGlzLml0ZW1WaWV3KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXNwb25zZTsKICB9LAogIHNldEFzUHJpbWFyeUNvbGxlY3Rpb25IZWxwZXI6IGZ1bmN0aW9uKCkgewogICAgXy5lYWNoKGZvcndhcmRhYmxlUHJvcGVydGllcywgZnVuY3Rpb24ocHJvcGVydHlOYW1lKSB7CiAgICAgIGZvcndhcmRNaXNzaW5nUHJvcGVydHkuY2FsbCh0aGlzLCBwcm9wZXJ0eU5hbWUpOwogICAgfSwgdGhpcyk7CiAgICBpZiAodGhpcy5wYXJlbnQuaXRlbUZpbHRlciAmJiAhdGhpcy5pdGVtRmlsdGVyKSB7CiAgICAgIHRoaXMuaXRlbUZpbHRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBhcmVudC5pdGVtRmlsdGVyLmFwcGx5KHRoaXMucGFyZW50LCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogICAgaWYgKHRoaXMucGFyZW50Lml0ZW1Db250ZXh0KSB7CiAgICAgIHRoaXMuaXRlbUNvbnRleHQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQuaXRlbUNvbnRleHQuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CiAgfQp9KTsKCl8uZXh0ZW5kKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5wcm90b3R5cGUsIGhlbHBlclZpZXdQcm90b3R5cGUpOwoKdmFyIGNvbGxlY3Rpb25PcHRpb25OYW1lcyA9IHsKICAnaXRlbS10ZW1wbGF0ZSc6ICdpdGVtVGVtcGxhdGUnLAogICdlbXB0eS10ZW1wbGF0ZSc6ICdlbXB0eVRlbXBsYXRlJywKICAnaXRlbS12aWV3JzogJ2l0ZW1WaWV3JywKICAnZW1wdHktdmlldyc6ICdlbXB0eVZpZXcnLAogICdlbXB0eS1jbGFzcyc6ICdlbXB0eUNsYXNzJwp9OwoKZnVuY3Rpb24gZm9yd2FyZFJlbmRlckV2ZW50KGV2ZW50TmFtZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyk7CiAgICBhcmdzLnVuc2hpZnQoZXZlbnROYW1lKTsKICAgIHRoaXMucGFyZW50LnRyaWdnZXIuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3MpOwogIH0KfQoKdmFyIGZvcndhcmRhYmxlUHJvcGVydGllcyA9IFsKICAnaXRlbVRlbXBsYXRlJywKICAnaXRlbVZpZXcnLAogICdlbXB0eVRlbXBsYXRlJywKICAnZW1wdHlWaWV3JwpdOwoKZnVuY3Rpb24gZm9yd2FyZE1pc3NpbmdQcm9wZXJ0eShwcm9wZXJ0eU5hbWUpIHsKICB2YXIgcGFyZW50ID0gZ2V0UGFyZW50KHRoaXMpOwogIGlmICghdGhpc1twcm9wZXJ0eU5hbWVdKSB7CiAgICB2YXIgcHJvcCA9IHBhcmVudFtwcm9wZXJ0eU5hbWVdOwogICAgaWYgKHByb3ApewogICAgICB0aGlzW3Byb3BlcnR5TmFtZV0gPSBwcm9wOwogICAgfQogIH0KfQoKSGFuZGxlYmFycy5yZWdpc3RlclZpZXdIZWxwZXIoJ2NvbGxlY3Rpb24nLCBUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcsIGZ1bmN0aW9uKGNvbGxlY3Rpb24sIHZpZXcpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgdmlldyA9IGNvbGxlY3Rpb247CiAgICBjb2xsZWN0aW9uID0gdmlldy5wYXJlbnQuY29sbGVjdGlvbjsKICAgIGNvbGxlY3Rpb24gJiYgdmlldy5zZXRBc1ByaW1hcnlDb2xsZWN0aW9uSGVscGVyKCk7CiAgICB2aWV3LiRlbC5hdHRyKGNvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZSwgJ3RydWUnKTsKICAgIC8vIHByb3BhZ2F0ZSBmdXR1cmUgY2hhbmdlcyB0byB0aGUgcGFyZW50J3MgY29sbGVjdGlvbiBvYmplY3QKICAgIC8vIHRvIHRoZSBoZWxwZXIgdmlldwogICAgdmlldy5saXN0ZW5Ubyh2aWV3LnBhcmVudCwgJ2NoYW5nZTpkYXRhLW9iamVjdCcsIGZ1bmN0aW9uKHR5cGUsIGRhdGFPYmplY3QpIHsKICAgICAgaWYgKHR5cGUgPT09ICdjb2xsZWN0aW9uJykgewogICAgICAgIHZpZXcuc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcigpOwogICAgICAgIHZpZXcuc2V0Q29sbGVjdGlvbihkYXRhT2JqZWN0KTsKICAgICAgfQogICAgfSk7CiAgfQogIGNvbGxlY3Rpb24gJiYgdmlldy5zZXRDb2xsZWN0aW9uKGNvbGxlY3Rpb24pOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2NvbGxlY3Rpb24tZWxlbWVudCcsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBpZiAoIWdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcucmVuZGVyQ29sbGVjdGlvbikgewogICAgdGhyb3cgbmV3IEVycm9yKCJjb2xsZWN0aW9uLWVsZW1lbnQgaGVscGVyIG11c3QgYmUgZGVjbGFyZWQgaW5zaWRlIG9mIGEgQ29sbGVjdGlvblZpZXciKTsKICB9CiAgdmFyIGhhc2ggPSBvcHRpb25zLmhhc2g7CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMoaGFzaCk7CiAgaGFzaC50YWdOYW1lID0gaGFzaC50YWdOYW1lIHx8ICdkaXYnOwogIGhhc2hbY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnLmNhbGwodGhpcywgaGFzaCwgJycsIHRoaXMpKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlbXB0eScsIGZ1bmN0aW9uKGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgb3B0aW9ucyA9IGRhdGFPYmplY3Q7CiAgfQogIHZhciB2aWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgZGF0YU9iamVjdCA9IHZpZXcubW9kZWw7CiAgfQogIC8vIGxpc3RlbmVycyBmb3IgdGhlIGVtcHR5IGhlbHBlciByYXRoZXIgdGhhbiBsaXN0ZW5lcnMKICAvLyB0aGF0IGFyZSB0aGVtc2VsdmVzIGVtcHR5CiAgaWYgKCF2aWV3Ll9lbXB0eUxpc3RlbmVycykgewogICAgdmlldy5fZW1wdHlMaXN0ZW5lcnMgPSB7fTsKICB9CiAgLy8gZHVjayB0eXBlIGNoZWNrIGZvciBjb2xsZWN0aW9uCiAgaWYgKGRhdGFPYmplY3QgJiYgIXZpZXcuX2VtcHR5TGlzdGVuZXJzW2RhdGFPYmplY3QuY2lkXSAmJiBkYXRhT2JqZWN0Lm1vZGVscyAmJiAoJ2xlbmd0aCcgaW4gZGF0YU9iamVjdCkpIHsKICAgIHZpZXcuX2VtcHR5TGlzdGVuZXJzW2RhdGFPYmplY3QuY2lkXSA9IHRydWU7CiAgICB2aWV3Lmxpc3RlblRvKGRhdGFPYmplY3QsICdyZW1vdmUnLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGRhdGFPYmplY3QubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdmlldy5yZW5kZXIoKTsKICAgICAgfQogICAgfSk7CiAgICB2aWV3Lmxpc3RlblRvKGRhdGFPYmplY3QsICdhZGQnLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGRhdGFPYmplY3QubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdmlldy5yZW5kZXIoKTsKICAgICAgfQogICAgfSk7CiAgICB2aWV3Lmxpc3RlblRvKGRhdGFPYmplY3QsICdyZXNldCcsIGZ1bmN0aW9uKCkgewogICAgICB2aWV3LnJlbmRlcigpOwogICAgfSk7CiAgfQogIHJldHVybiAhZGF0YU9iamVjdCB8fCBkYXRhT2JqZWN0LmlzRW1wdHkoKSA/IG9wdGlvbnMuZm4odGhpcykgOiBvcHRpb25zLmludmVyc2UodGhpcyk7Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndGVtcGxhdGUnLCBmdW5jdGlvbihuYW1lLCBvcHRpb25zKSB7CiAgdmFyIGNvbnRleHQgPSBfLmV4dGVuZCh7Zm46IG9wdGlvbnMgJiYgb3B0aW9ucy5mbn0sIHRoaXMsIG9wdGlvbnMgPyBvcHRpb25zLmhhc2ggOiB7fSk7CiAgdmFyIG91dHB1dCA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcucmVuZGVyVGVtcGxhdGUobmFtZSwgY29udGV4dCk7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcob3V0cHV0KTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd5aWVsZCcsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICByZXR1cm4gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykueWllbGQgJiYgb3B0aW9ucy5kYXRhLnlpZWxkKCk7Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndXJsJywgZnVuY3Rpb24odXJsKSB7CiAgdmFyIGZyYWdtZW50OwogIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMikgewogICAgZnJhZ21lbnQgPSBfLm1hcChfLmhlYWQoYXJndW1lbnRzLCBhcmd1bWVudHMubGVuZ3RoIC0gMSksIGVuY29kZVVSSUNvbXBvbmVudCkuam9pbignLycpOwogIH0gZWxzZSB7CiAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50c1sxXSwKICAgICAgICBoYXNoID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5oYXNoKSB8fCBvcHRpb25zOwogICAgaWYgKGhhc2ggJiYgaGFzaFsnZXhwYW5kLXRva2VucyddKSB7CiAgICAgIGZyYWdtZW50ID0gVGhvcmF4LlV0aWwuZXhwYW5kVG9rZW4odXJsLCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIGZyYWdtZW50ID0gdXJsOwogICAgfQogIH0KICByZXR1cm4gKEJhY2tib25lLmhpc3RvcnkuX2hhc1B1c2hTdGF0ZSA/IEJhY2tib25lLmhpc3Rvcnkub3B0aW9ucy5yb290IDogJyMnKSArIGZyYWdtZW50Owp9KTsKCjs7Ci8qZ2xvYmFsIHZpZXdUZW1wbGF0ZU92ZXJyaWRlcyAqLwpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcigndmlldycsIHsKICBmYWN0b3J5OiBmdW5jdGlvbihhcmdzLCBvcHRpb25zKSB7CiAgICB2YXIgVmlldyA9IGFyZ3MubGVuZ3RoID49IDEgPyBhcmdzWzBdIDogVGhvcmF4LlZpZXc7CiAgICByZXR1cm4gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKFZpZXcsIG9wdGlvbnMub3B0aW9ucyk7CiAgfSwKICBjYWxsYmFjazogZnVuY3Rpb24oKSB7CiAgICB2YXIgaW5zdGFuY2UgPSBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aC0xXSwKICAgICAgICBvcHRpb25zID0gaW5zdGFuY2UuX2hlbHBlck9wdGlvbnMub3B0aW9ucywKICAgICAgICBwbGFjZWhvbGRlcklkID0gaW5zdGFuY2UuY2lkOwoKICAgIGlmIChvcHRpb25zLmZuKSB7CiAgICAgIHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXSA9IG9wdGlvbnMuZm47CiAgICB9CiAgfQp9KTsKCjs7CnZhciBjYWxsTWV0aG9kQXR0cmlidXRlTmFtZSA9ICdkYXRhLWNhbGwtbWV0aG9kJywKICAgIHRyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS10cmlnZ2VyLWV2ZW50JzsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2J1dHRvbicsIGZ1bmN0aW9uKG1ldGhvZCwgb3B0aW9ucykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICBvcHRpb25zID0gbWV0aG9kOwogICAgbWV0aG9kID0gb3B0aW9ucy5oYXNoLm1ldGhvZDsKICB9CiAgdmFyIGhhc2ggPSBvcHRpb25zLmhhc2gsCiAgICAgIGV4cGFuZFRva2VucyA9IGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBkZWxldGUgaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGlmICghbWV0aG9kICYmICFvcHRpb25zLmhhc2gudHJpZ2dlcikgewogICAgdGhyb3cgbmV3IEVycm9yKCJidXR0b24gaGVscGVyIG11c3QgaGF2ZSBhIG1ldGhvZCBuYW1lIGFzIHRoZSBmaXJzdCBhcmd1bWVudCBvciBhICd0cmlnZ2VyJywgb3IgYSAnbWV0aG9kJyBhdHRyaWJ1dGUgc3BlY2lmaWVkLiIpOwogIH0KICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhoYXNoKTsKICBoYXNoLnRhZ05hbWUgPSBoYXNoLnRhZ05hbWUgfHwgJ2J1dHRvbic7CiAgaGFzaC50cmlnZ2VyICYmIChoYXNoW3RyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWVdID0gaGFzaC50cmlnZ2VyKTsKICBkZWxldGUgaGFzaC50cmlnZ2VyOwogIG1ldGhvZCAmJiAoaGFzaFtjYWxsTWV0aG9kQXR0cmlidXRlTmFtZV0gPSBtZXRob2QpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhoYXNoLCBvcHRpb25zLmZuID8gb3B0aW9ucy5mbih0aGlzKSA6ICcnLCBleHBhbmRUb2tlbnMgPyB0aGlzIDogbnVsbCkpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xpbmsnLCBmdW5jdGlvbigpIHsKICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpLAogICAgICBvcHRpb25zID0gYXJncy5wb3AoKSwKICAgICAgaGFzaCA9IG9wdGlvbnMuaGFzaCwKICAgICAgLy8gdXJsIGlzIGFuIGFycmF5IHRoYXQgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIHVybCBoZWxwZXIKICAgICAgdXJsID0gYXJncy5sZW5ndGggPT09IDAgPyBbaGFzaC5ocmVmXSA6IGFyZ3MsCiAgICAgIGV4cGFuZFRva2VucyA9IGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBkZWxldGUgaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGlmICghdXJsWzBdICYmIHVybFswXSAhPT0gJycpIHsKICAgIHRocm93IG5ldyBFcnJvcigibGluayBoZWxwZXIgcmVxdWlyZXMgYW4gaHJlZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQgb3IgYW4gJ2hyZWYnIGF0dHJpYnV0ZSIpOwogIH0KICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhoYXNoKTsKICB1cmwucHVzaChvcHRpb25zKTsKICBoYXNoLmhyZWYgPSBIYW5kbGViYXJzLmhlbHBlcnMudXJsLmFwcGx5KHRoaXMsIHVybCk7CiAgaGFzaC50YWdOYW1lID0gaGFzaC50YWdOYW1lIHx8ICdhJzsKICBoYXNoLnRyaWdnZXIgJiYgKGhhc2hbdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZV0gPSBvcHRpb25zLmhhc2gudHJpZ2dlcik7CiAgZGVsZXRlIGhhc2gudHJpZ2dlcjsKICBoYXNoW2NhbGxNZXRob2RBdHRyaWJ1dGVOYW1lXSA9ICdfYW5jaG9yQ2xpY2snOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhoYXNoLCBvcHRpb25zLmZuID8gb3B0aW9ucy5mbih0aGlzKSA6ICcnLCBleHBhbmRUb2tlbnMgPyB0aGlzIDogbnVsbCkpOwp9KTsKCnZhciBjbGlja1NlbGVjdG9yID0gJ1snICsgY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWUgKyAnXSwgWycgKyB0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lICsgJ10nOwoKZnVuY3Rpb24gaGFuZGxlQ2xpY2soZXZlbnQpIHsKICB2YXIgdGFyZ2V0ID0gJChldmVudC50YXJnZXQpLAogICAgICB2aWV3ID0gdGFyZ2V0LnZpZXcoe2hlbHBlcjogZmFsc2V9KSwKICAgICAgbWV0aG9kTmFtZSA9IHRhcmdldC5hdHRyKGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lKSwKICAgICAgZXZlbnROYW1lID0gdGFyZ2V0LmF0dHIodHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSksCiAgICAgIG1ldGhvZFJlc3BvbnNlID0gZmFsc2U7CiAgbWV0aG9kTmFtZSAmJiAobWV0aG9kUmVzcG9uc2UgPSB2aWV3W21ldGhvZE5hbWVdLmNhbGwodmlldywgZXZlbnQpKTsKICBldmVudE5hbWUgJiYgdmlldy50cmlnZ2VyKGV2ZW50TmFtZSwgZXZlbnQpOwogIHRhcmdldC50YWdOYW1lID09PSAiQSIgJiYgbWV0aG9kUmVzcG9uc2UgPT09IGZhbHNlICYmIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cn0KCnZhciBsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lOwoKZnVuY3Rpb24gcmVnaXN0ZXJDbGlja0hhbmRsZXIoKSB7CiAgdW5yZWdpc3RlckNsaWNrSGFuZGxlcigpOwogIGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUgPSBUaG9yYXguX2Zhc3RDbGlja0V2ZW50TmFtZSB8fCAnY2xpY2snOwogICQoZG9jdW1lbnQpLm9uKGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUsIGNsaWNrU2VsZWN0b3IsIGhhbmRsZUNsaWNrKTsKfQoKZnVuY3Rpb24gdW5yZWdpc3RlckNsaWNrSGFuZGxlcigpIHsKICBsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lICYmICQoZG9jdW1lbnQpLm9mZihsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lLCBjbGlja1NlbGVjdG9yLCBoYW5kbGVDbGljayk7Cn0KCiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkgewogIGlmICghVGhvcmF4Ll9mYXN0Q2xpY2tFdmVudE5hbWUpIHsKICAgIHJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCk7CiAgfQp9KTsKCjs7CnZhciBlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtZWxlbWVudC10bXAnOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignZWxlbWVudCcsIGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhvcHRpb25zLmhhc2gpOwogIHZhciBjaWQgPSBfLnVuaXF1ZUlkKCdlbGVtZW50JyksCiAgICAgIGRlY2xhcmluZ1ZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3LAogICAgICBodG1sQXR0cmlidXRlcyA9IF8ucGljayhvcHRpb25zLmhhc2gsIGh0bWxBdHRyaWJ1dGVzVG9Db3B5KTsKICBodG1sQXR0cmlidXRlc1tlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lXSA9IGNpZDsKICBkZWNsYXJpbmdWaWV3Ll9lbGVtZW50c0J5Q2lkIHx8IChkZWNsYXJpbmdWaWV3Ll9lbGVtZW50c0J5Q2lkID0ge30pOwogIGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWRbY2lkXSA9IGVsZW1lbnQ7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnKGh0bWxBdHRyaWJ1dGVzKSk7Cn0pOwoKVGhvcmF4LlZpZXcub24oJ2FwcGVuZCcsIGZ1bmN0aW9uKHNjb3BlLCBjYWxsYmFjaykgewogIChzY29wZSB8fCB0aGlzLiRlbCkuZmluZCgnWycgKyBlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lICsgJ10nKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICB2YXIgJGVsID0gJChlbCksCiAgICAgICAgY2lkID0gJGVsLmF0dHIoZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSksCiAgICAgICAgZWxlbWVudCA9IHRoaXMuX2VsZW1lbnRzQnlDaWRbY2lkXTsKICAgIC8vIEEgY2FsbGJhY2sgZnVuY3Rpb24gbWF5IGJlIHNwZWNpZmllZCBhcyB0aGUgdmFsdWUKICAgIGlmIChfLmlzRnVuY3Rpb24oZWxlbWVudCkpIHsKICAgICAgZWxlbWVudCA9IGVsZW1lbnQuY2FsbCh0aGlzKTsKICAgIH0KICAgICRlbC5yZXBsYWNlV2l0aChlbGVtZW50KTsKICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKGVsZW1lbnQpOwogIH0sIHRoaXMpOwp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3N1cGVyJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldywKICAgICAgcGFyZW50ID0gZGVjbGFyaW5nVmlldy5jb25zdHJ1Y3RvciAmJiBkZWNsYXJpbmdWaWV3LmNvbnN0cnVjdG9yLl9fc3VwZXJfXzsKICBpZiAocGFyZW50KSB7CiAgICB2YXIgdGVtcGxhdGUgPSBwYXJlbnQudGVtcGxhdGU7CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIGlmICghcGFyZW50Lm5hbWUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCB1c2Ugc3VwZXIgaGVscGVyIHdoZW4gcGFyZW50IGhhcyBubyBuYW1lIG9yIHRlbXBsYXRlLicpOwogICAgICB9CiAgICAgIHRlbXBsYXRlID0gcGFyZW50Lm5hbWU7CiAgICB9CiAgICBpZiAoXy5pc1N0cmluZyh0ZW1wbGF0ZSkpIHsKICAgICAgdGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0ZW1wbGF0ZSwgZmFsc2UpOwogICAgfQogICAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcodGVtcGxhdGUodGhpcywgb3B0aW9ucykpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gJyc7CiAgfQp9KTsKCjs7Ci8qZ2xvYmFsIGNvbGxlY3Rpb25PcHRpb25OYW1lcywgaW5oZXJpdFZhcnMgKi8KCnZhciBsb2FkU3RhcnQgPSAnbG9hZDpzdGFydCcsCiAgICBsb2FkRW5kID0gJ2xvYWQ6ZW5kJywKICAgIHJvb3RPYmplY3Q7CgpUaG9yYXguc2V0Um9vdE9iamVjdCA9IGZ1bmN0aW9uKG9iaikgewogIHJvb3RPYmplY3QgPSBvYmo7Cn07CgpUaG9yYXgubG9hZEhhbmRsZXIgPSBmdW5jdGlvbihzdGFydCwgZW5kLCBjb250ZXh0KSB7CiAgdmFyIGxvYWRDb3VudGVyID0gXy51bmlxdWVJZCgpOwogIHJldHVybiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgIHZhciBzZWxmID0gY29udGV4dCB8fCB0aGlzOwogICAgc2VsZi5fbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mbyB8fCBbXTsKICAgIHZhciBsb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvW2xvYWRDb3VudGVyXTsKCiAgICBmdW5jdGlvbiBzdGFydExvYWRUaW1lb3V0KCkgewoKICAgICAgLy8gSWYgdGhlIHRpbWVvdXQgaGFzIGJlZW4gc2V0IGFscmVhZHkgYnV0IGhhcyBub3QgdHJpZ2dlcmVkIHlldCBkbyBub3RoaW5nCiAgICAgIC8vIE90aGVyd2lzZSBzZXQgYSBuZXcgdGltZW91dCAoZWl0aGVyIGluaXRpYWwgb3IgZm9yIGdvaW5nIGZyb20gYmFja2dyb3VuZCB0bwogICAgICAvLyBub24tYmFja2dyb3VuZCBsb2FkaW5nKQogICAgICBpZiAobG9hZEluZm8udGltZW91dCAmJiAhbG9hZEluZm8ucnVuKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgbG9hZGluZ1RpbWVvdXQgPSBzZWxmLl9sb2FkaW5nVGltZW91dER1cmF0aW9uICE9PSB1bmRlZmluZWQgPwogICAgICAgIHNlbGYuX2xvYWRpbmdUaW1lb3V0RHVyYXRpb24gOiBUaG9yYXguVmlldy5wcm90b3R5cGUuX2xvYWRpbmdUaW1lb3V0RHVyYXRpb247CiAgICAgIGxvYWRJbmZvLnRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbG9hZEluZm8ucnVuID0gdHJ1ZTsKICAgICAgICAgICAgc3RhcnQuY2FsbChzZWxmLCBsb2FkSW5mby5tZXNzYWdlLCBsb2FkSW5mby5iYWNrZ3JvdW5kLCBsb2FkSW5mbyk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIFRob3JheC5vbkV4Y2VwdGlvbignbG9hZFN0YXJ0JywgZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwgbG9hZGluZ1RpbWVvdXQgKiAxMDAwKTsKICAgIH0KCiAgICBpZiAoIWxvYWRJbmZvKSB7CiAgICAgIGxvYWRJbmZvID0gc2VsZi5fbG9hZEluZm9bbG9hZENvdW50ZXJdID0gXy5leHRlbmQoewogICAgICAgIGV2ZW50czogW10sCiAgICAgICAgdGltZW91dDogMCwKICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLAogICAgICAgIGJhY2tncm91bmQ6ICEhYmFja2dyb3VuZAogICAgICB9LCBCYWNrYm9uZS5FdmVudHMpOwogICAgICBzdGFydExvYWRUaW1lb3V0KCk7CiAgICB9IGVsc2UgewogICAgICBjbGVhclRpbWVvdXQobG9hZEluZm8uZW5kVGltZW91dCk7CgogICAgICBsb2FkSW5mby5tZXNzYWdlID0gbWVzc2FnZTsKICAgICAgaWYgKCFiYWNrZ3JvdW5kICYmIGxvYWRJbmZvLmJhY2tncm91bmQpIHsKICAgICAgICBsb2FkSW5mby5iYWNrZ3JvdW5kID0gZmFsc2U7CiAgICAgICAgc3RhcnRMb2FkVGltZW91dCgpOwogICAgICB9CiAgICB9CgogICAgLy8gUHJldmVudCBiaW5kcyB0byB0aGUgc2FtZSBvYmplY3QgbXVsdGlwbGUgdGltZXMgYXMgdGhpcyBjYW4gY2F1c2UgdmVyeSBiYWQgdGhpbmdzCiAgICAvLyB0byBoYXBwZW4gZm9yIHRoZSBsb2FkO2xvYWQ7ZW5kO2VuZCBleGVjdXRpb24gZmxvdy4KICAgIGlmIChsb2FkSW5mby5ldmVudHMuaW5kZXhPZihvYmplY3QpID49IDApIHsKICAgICAgbG9hZEluZm8uZXZlbnRzLnB1c2gob2JqZWN0KTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGxvYWRJbmZvLmV2ZW50cy5wdXNoKG9iamVjdCk7CgogICAgb2JqZWN0Lm9uKGxvYWRFbmQsIGZ1bmN0aW9uIGVuZENhbGxiYWNrKCkgewogICAgICB2YXIgbG9hZGluZ0VuZFRpbWVvdXQgPSBzZWxmLl9sb2FkaW5nVGltZW91dEVuZER1cmF0aW9uOwogICAgICBpZiAobG9hZGluZ0VuZFRpbWVvdXQgPT09IHZvaWQgMCkgewogICAgICAgIC8vIElmIHdlIGFyZSBydW5uaW5nIG9uIGEgbm9uLXZpZXcgb2JqZWN0IHB1bGwgdGhlIGRlZmF1bHQgdGltZW91dAogICAgICAgIGxvYWRpbmdFbmRUaW1lb3V0ID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLl9sb2FkaW5nVGltZW91dEVuZER1cmF0aW9uOwogICAgICB9CgogICAgICB2YXIgZXZlbnRzID0gbG9hZEluZm8uZXZlbnRzLAogICAgICAgICAgaW5kZXggPSBldmVudHMuaW5kZXhPZihvYmplY3QpOwogICAgICBpZiAoaW5kZXggPj0gMCkgewogICAgICAgIGV2ZW50cy5zcGxpY2UoaW5kZXgsIDEpOwoKICAgICAgICBpZiAoZXZlbnRzLmluZGV4T2Yob2JqZWN0KSA8IDApIHsKICAgICAgICAgIC8vIExhc3QgY2FsbGJhY2sgZm9yIHRoaXMgcGFydGljbGFyIG9iamVjdCwgcmVtb3ZlIHRoZSBiaW5kCiAgICAgICAgICBvYmplY3Qub2ZmKGxvYWRFbmQsIGVuZENhbGxiYWNrKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghZXZlbnRzLmxlbmd0aCkgewogICAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby5lbmRUaW1lb3V0KTsKICAgICAgICBsb2FkSW5mby5lbmRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmICghZXZlbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgIHZhciBydW4gPSBsb2FkSW5mby5ydW47CgogICAgICAgICAgICAgIGlmIChydW4pIHsKICAgICAgICAgICAgICAgIC8vIEVtaXQgdGhlIGVuZCBiZWhhdmlvciwgYnV0IG9ubHkgaWYgdGhlcmUgaXMgYSBwYWlyZWQgc3RhcnQKICAgICAgICAgICAgICAgIGVuZC5jYWxsKHNlbGYsIGxvYWRJbmZvLmJhY2tncm91bmQsIGxvYWRJbmZvKTsKICAgICAgICAgICAgICAgIGxvYWRJbmZvLnRyaWdnZXIobG9hZEVuZCwgbG9hZEluZm8pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gSWYgc3RvcHBpbmcgbWFrZSBzdXJlIHdlIGRvbid0IHJ1biBhIHN0YXJ0CiAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGxvYWRJbmZvLnRpbWVvdXQpOwogICAgICAgICAgICAgIGxvYWRJbmZvID0gc2VsZi5fbG9hZEluZm9bbG9hZENvdW50ZXJdID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIFRob3JheC5vbkV4Y2VwdGlvbignbG9hZEVuZCcsIGUpOwogICAgICAgICAgfQogICAgICAgIH0sIGxvYWRpbmdFbmRUaW1lb3V0ICogMTAwMCk7CiAgICAgIH0KICAgIH0pOwogIH07Cn07CgovKioKICogSGVscGVyIG1ldGhvZCBmb3IgcHJvcGFnYXRpbmcgbG9hZDpzdGFydCBldmVudHMgdG8gb3RoZXIgb2JqZWN0cy4KICoKICogRm9yd2FyZHMgbG9hZDpzdGFydCBldmVudHMgdGhhdCBvY2N1ciBvbiBgc291cmNlYCB0byBgZGVzdGAuCiAqLwpUaG9yYXguZm9yd2FyZExvYWRFdmVudHMgPSBmdW5jdGlvbihzb3VyY2UsIGRlc3QsIG9uY2UpIHsKICBmdW5jdGlvbiBsb2FkKG1lc3NhZ2UsIGJhY2tnb3VuZCwgb2JqZWN0KSB7CiAgICBpZiAob25jZSkgewogICAgICBzb3VyY2Uub2ZmKGxvYWRTdGFydCwgbG9hZCk7CiAgICB9CiAgICBkZXN0LnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ291bmQsIG9iamVjdCk7CiAgfQogIHNvdXJjZS5vbihsb2FkU3RhcnQsIGxvYWQpOwogIHJldHVybiB7CiAgICBvZmY6IGZ1bmN0aW9uKCkgewogICAgICBzb3VyY2Uub2ZmKGxvYWRTdGFydCwgbG9hZCk7CiAgICB9CiAgfTsKfTsKCi8vCi8vIERhdGEgbG9hZCBldmVudCBnZW5lcmF0aW9uCi8vCgovKioKICogTWl4aW5nIGZvciBnZW5lcmF0aW5nIGxvYWQ6c3RhcnQgYW5kIGxvYWQ6ZW5kIGV2ZW50cy4KICovClRob3JheC5taXhpbkxvYWRhYmxlID0gZnVuY3Rpb24odGFyZ2V0LCB1c2VQYXJlbnQpIHsKICBfLmV4dGVuZCh0YXJnZXQsIHsKICAgIC8vbG9hZGluZyBjb25maWcKICAgIF9sb2FkaW5nQ2xhc3NOYW1lOiAnbG9hZGluZycsCiAgICBfbG9hZGluZ1RpbWVvdXREdXJhdGlvbjogMC4zMywKICAgIF9sb2FkaW5nVGltZW91dEVuZER1cmF0aW9uOiAwLjEwLAoKICAgIC8vIFByb3BhZ2F0ZXMgbG9hZGluZyB2aWV3IHBhcmFtZXRlcnMgdG8gdGhlIEFKQVggbGF5ZXIKICAgIG9uTG9hZFN0YXJ0OiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CgogICAgICAvLyBQcm90ZWN0IGFnYWluc3QgcmFjZSBjb25kaXRpb25zCiAgICAgIGlmICghdGhhdCB8fCAhdGhhdC5lbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCF0aGF0Lm5vbkJsb2NraW5nTG9hZCAmJiAhYmFja2dyb3VuZCAmJiByb290T2JqZWN0ICYmIHJvb3RPYmplY3QgIT09IHRoaXMpIHsKICAgICAgICByb290T2JqZWN0LnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgICB9CiAgICAgIHRoYXQuX2lzTG9hZGluZyA9IHRydWU7CiAgICAgICQodGhhdC5lbCkuYWRkQ2xhc3ModGhhdC5fbG9hZGluZ0NsYXNzTmFtZSk7CiAgICAgIC8vIHVzZWQgYnkgbG9hZGluZyBoZWxwZXJzCiAgICAgIHRoYXQudHJpZ2dlcignY2hhbmdlOmxvYWQtc3RhdGUnLCAnc3RhcnQnKTsKICAgIH0sCiAgICBvbkxvYWRFbmQ6IGZ1bmN0aW9uKC8qIGJhY2tncm91bmQsIG9iamVjdCAqLykgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKCiAgICAgIC8vIFByb3RlY3QgYWdhaW5zdCByYWNlIGNvbmRpdGlvbnMKICAgICAgaWYgKCF0aGF0IHx8ICF0aGF0LmVsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICB0aGF0Ll9pc0xvYWRpbmcgPSBmYWxzZTsKICAgICAgJCh0aGF0LmVsKS5yZW1vdmVDbGFzcyh0aGF0Ll9sb2FkaW5nQ2xhc3NOYW1lKTsKICAgICAgLy8gdXNlZCBieSBsb2FkaW5nIGhlbHBlcgogICAgICB0aGF0LnRyaWdnZXIoJ2NoYW5nZTpsb2FkLXN0YXRlJywgJ2VuZCcpOwogICAgfQogIH0pOwp9OwoKVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMgPSBmdW5jdGlvbih0YXJnZXQsIHVzZVBhcmVudCkgewogIF8uZXh0ZW5kKHRhcmdldCwgewogICAgbG9hZFN0YXJ0OiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kKSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwogICAgICB0aGF0LnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ3JvdW5kLCB0aGF0KTsKICAgIH0sCiAgICBsb2FkRW5kOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CiAgICAgIHRoYXQudHJpZ2dlcihsb2FkRW5kLCB0aGF0KTsKICAgIH0KICB9KTsKfTsKClRob3JheC5taXhpbkxvYWRhYmxlKFRob3JheC5WaWV3LnByb3RvdHlwZSk7ClRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKFRob3JheC5WaWV3LnByb3RvdHlwZSk7CgoKaWYgKFRob3JheC5IZWxwZXJWaWV3KSB7CiAgVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LkhlbHBlclZpZXcucHJvdG90eXBlLCB0cnVlKTsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyhUaG9yYXguSGVscGVyVmlldy5wcm90b3R5cGUsIHRydWUpOwp9CgppZiAoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3KSB7CiAgVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7CiAgVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7Cn0KClRob3JheC5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBkYXRhT2JqLCBvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICBjb21wbGV0ZSA9IG9wdGlvbnMuY29tcGxldGU7CgogIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgIHNlbGYuX3JlcXVlc3QgPSB1bmRlZmluZWQ7CiAgICBzZWxmLl9hYm9ydGVkID0gZmFsc2U7CgogICAgY29tcGxldGUgJiYgY29tcGxldGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIHRoaXMuX3JlcXVlc3QgPSBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHJldHVybiB0aGlzLl9yZXF1ZXN0Owp9OwoKZnVuY3Rpb24gYmluZFRvUm91dGUoY2FsbGJhY2ssIGZhaWxiYWNrKSB7CiAgdmFyIGZyYWdtZW50ID0gQmFja2JvbmUuaGlzdG9yeS5nZXRGcmFnbWVudCgpLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gcm91dGVIYW5kbGVyKCkgewogICAgaWYgKGZyYWdtZW50ID09PSBCYWNrYm9uZS5oaXN0b3J5LmdldEZyYWdtZW50KCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgIHJlcy5jYW5jZWwoKTsKICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrKCk7CiAgfQoKICBCYWNrYm9uZS5oaXN0b3J5Lm9uKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CgogIGZ1bmN0aW9uIGZpbmFsaXplcigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgICBpZiAoIXJvdXRlQ2hhbmdlZCkgewogICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KCiAgdmFyIHJlcyA9IF8uYmluZChmaW5hbGl6ZXIsIHRoaXMpOwogIHJlcy5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgfTsKCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gbG9hZERhdGEoY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgaWYgKHRoaXMuaXNQb3B1bGF0ZWQoKSkgewogICAgcmV0dXJuIGNhbGxiYWNrKHRoaXMpOwogIH0KCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgIV8uaXNGdW5jdGlvbihmYWlsYmFjaykgJiYgXy5pc09iamVjdChmYWlsYmFjaykpIHsKICAgIG9wdGlvbnMgPSBmYWlsYmFjazsKICAgIGZhaWxiYWNrID0gZmFsc2U7CiAgfQoKICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgIHJvdXRlQ2hhbmdlZCA9IGZhbHNlLAogICAgICBzdWNjZXNzQ2FsbGJhY2sgPSBiaW5kVG9Sb3V0ZShfLmJpbmQoY2FsbGJhY2ssIHNlbGYpLCBmdW5jdGlvbigpIHsKICAgICAgICByb3V0ZUNoYW5nZWQgPSB0cnVlOwogICAgICAgIGlmIChzZWxmLl9yZXF1ZXN0KSB7CiAgICAgICAgICBzZWxmLl9hYm9ydGVkID0gdHJ1ZTsKICAgICAgICAgIHNlbGYuX3JlcXVlc3QuYWJvcnQoKTsKICAgICAgICB9CiAgICAgICAgZmFpbGJhY2sgJiYgZmFpbGJhY2suY2FsbChzZWxmLCBmYWxzZSk7CiAgICAgIH0pOwoKICB0aGlzLmZldGNoKF8uZGVmYXVsdHMoewogICAgc3VjY2Vzczogc3VjY2Vzc0NhbGxiYWNrLAogICAgZXJyb3I6IGZhaWxiYWNrICYmIGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXJvdXRlQ2hhbmdlZCkgewogICAgICAgIGZhaWxiYWNrLmFwcGx5KHNlbGYsIFt0cnVlXS5jb25jYXQoXy50b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgfQogICAgfSwKICAgIGNvbXBsZXRlOiBmdW5jdGlvbigpIHsKICAgICAgc3VjY2Vzc0NhbGxiYWNrLmNhbmNlbCgpOwogICAgfQogIH0sIG9wdGlvbnMpKTsKfQoKZnVuY3Rpb24gZmV0Y2hRdWV1ZShvcHRpb25zLCAkc3VwZXIpIHsKICBpZiAob3B0aW9ucy5yZXNldFF1ZXVlKSB7CiAgICAvLyBXQVJOOiBTaG91bGQgZW5zdXJlIHRoYXQgbG9hZGVycyBhcmUgcHJvdGVjdGVkIGZyb20gb3V0IG9mIGJhbmQgZGF0YQogICAgLy8gICAgd2hlbiB1c2luZyB0aGlzIG9wdGlvbgogICAgdGhpcy5mZXRjaFF1ZXVlID0gdW5kZWZpbmVkOwogIH0KCiAgaWYgKCF0aGlzLmZldGNoUXVldWUpIHsKICAgIC8vIEtpY2sgb2ZmIHRoZSByZXF1ZXN0CiAgICB0aGlzLmZldGNoUXVldWUgPSBbb3B0aW9uc107CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7CiAgICAgIHN1Y2Nlc3M6IGZsdXNoUXVldWUodGhpcywgdGhpcy5mZXRjaFF1ZXVlLCAnc3VjY2VzcycpLAogICAgICBlcnJvcjogZmx1c2hRdWV1ZSh0aGlzLCB0aGlzLmZldGNoUXVldWUsICdlcnJvcicpLAogICAgICBjb21wbGV0ZTogZmx1c2hRdWV1ZSh0aGlzLCB0aGlzLmZldGNoUXVldWUsICdjb21wbGV0ZScpCiAgICB9LCBvcHRpb25zKTsKICAgICRzdXBlci5jYWxsKHRoaXMsIG9wdGlvbnMpOwogIH0gZWxzZSB7CiAgICAvLyBDdXJyZW50bHkgZmV0Y2hpbmcuIFF1ZXVlIGFuZCBwcm9jZXNzIG9uY2UgY29tcGxldGUKICAgIHRoaXMuZmV0Y2hRdWV1ZS5wdXNoKG9wdGlvbnMpOwogIH0KfQoKZnVuY3Rpb24gZmx1c2hRdWV1ZShzZWxmLCBmZXRjaFF1ZXVlLCBoYW5kbGVyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CgogICAgLy8gRmx1c2ggdGhlIHF1ZXVlLiBFeGVjdXRlcyBhbnkgY2FsbGJhY2sgaGFuZGxlcnMgdGhhdAogICAgLy8gbWF5IGhhdmUgYmVlbiBwYXNzZWQgaW4gdGhlIGZldGNoIG9wdGlvbnMuCiAgICBfLmVhY2goZmV0Y2hRdWV1ZSwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAob3B0aW9uc1toYW5kbGVyXSkgewogICAgICAgIG9wdGlvbnNbaGFuZGxlcl0uYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwoKICAgIC8vIFJlc2V0IHRoZSBxdWV1ZSBpZiB3ZSBhcmUgc3RpbGwgdGhlIGFjdGl2ZSByZXF1ZXN0CiAgICBpZiAoc2VsZi5mZXRjaFF1ZXVlID09PSBmZXRjaFF1ZXVlKSB7CiAgICAgIHNlbGYuZmV0Y2hRdWV1ZSA9IHVuZGVmaW5lZDsKICAgIH0KICB9Owp9Cgp2YXIga2xhc3NlcyA9IFtdOwpUaG9yYXguTW9kZWwgJiYga2xhc3Nlcy5wdXNoKFRob3JheC5Nb2RlbCk7ClRob3JheC5Db2xsZWN0aW9uICYmIGtsYXNzZXMucHVzaChUaG9yYXguQ29sbGVjdGlvbik7CgpfLmVhY2goa2xhc3NlcywgZnVuY3Rpb24oRGF0YUNsYXNzKSB7CiAgdmFyICRmZXRjaCA9IERhdGFDbGFzcy5wcm90b3R5cGUuZmV0Y2g7CiAgVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoRGF0YUNsYXNzLnByb3RvdHlwZSwgZmFsc2UpOwogIF8uZXh0ZW5kKERhdGFDbGFzcy5wcm90b3R5cGUsIHsKICAgIHN5bmM6IFRob3JheC5zeW5jLAoKICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgY29tcGxldGUgPSBvcHRpb25zLmNvbXBsZXRlOwoKICAgICAgb3B0aW9ucy5jb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbXBsZXRlICYmIGNvbXBsZXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgc2VsZi5sb2FkRW5kKCk7CiAgICAgIH07CiAgICAgIHNlbGYubG9hZFN0YXJ0KHVuZGVmaW5lZCwgb3B0aW9ucy5iYWNrZ3JvdW5kKTsKICAgICAgcmV0dXJuIGZldGNoUXVldWUuY2FsbCh0aGlzLCBvcHRpb25zIHx8IHt9LCAkZmV0Y2gpOwogICAgfSwKCiAgICBsb2FkOiBmdW5jdGlvbihjYWxsYmFjaywgZmFpbGJhY2ssIG9wdGlvbnMpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgIV8uaXNGdW5jdGlvbihmYWlsYmFjaykpIHsKICAgICAgICBvcHRpb25zID0gZmFpbGJhY2s7CiAgICAgICAgZmFpbGJhY2sgPSBmYWxzZTsKICAgICAgfQoKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIGlmICghb3B0aW9ucy5iYWNrZ3JvdW5kICYmICF0aGlzLmlzUG9wdWxhdGVkKCkgJiYgcm9vdE9iamVjdCkgewogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBnbG9iYWwgc2NvcGUgc2VlcyB0aGUgcHJvcGVyIGxvYWQgZXZlbnRzIGhlcmUKICAgICAgICAvLyBpZiB3ZSBhcmUgbG9hZGluZyBpbiBzdGFuZGFsb25lIG1vZGUKICAgICAgICBUaG9yYXguZm9yd2FyZExvYWRFdmVudHModGhpcywgcm9vdE9iamVjdCwgdHJ1ZSk7CiAgICAgIH0KCiAgICAgIGxvYWREYXRhLmNhbGwodGhpcywgY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKTsKICAgIH0KICB9KTsKfSk7CgpUaG9yYXguVXRpbC5iaW5kVG9Sb3V0ZSA9IGJpbmRUb1JvdXRlOwoKaWYgKFRob3JheC5Sb3V0ZXIpIHsKICBUaG9yYXguUm91dGVyLmJpbmRUb1JvdXRlID0gVGhvcmF4LlJvdXRlci5wcm90b3R5cGUuYmluZFRvUm91dGUgPSBiaW5kVG9Sb3V0ZTsKfQoKLy8gUHJvcGFnYXRlcyBsb2FkaW5nIHZpZXcgcGFyYW1ldGVycyB0byB0aGUgQUpBWCBsYXllcgpUaG9yYXguVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIG9wdGlvbnMuaWdub3JlRXJyb3JzID0gdGhpcy5pZ25vcmVGZXRjaEVycm9yOwogIG9wdGlvbnMuYmFja2dyb3VuZCA9IHRoaXMubm9uQmxvY2tpbmdMb2FkOwogIHJldHVybiBvcHRpb25zOwp9OwoKLy8gVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3IGluaGVyaXRzIGZyb20gQ29sbGVjdGlvblZpZXcKLy8gbm90IEhlbHBlclZpZXcgc28gbmVlZCB0byBzZXQgaXQgbWFudWFsbHkKVGhvcmF4LkhlbHBlclZpZXcucHJvdG90eXBlLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyA9IFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIG9wdGlvbnMuaWdub3JlRXJyb3JzID0gdGhpcy5wYXJlbnQuaWdub3JlRmV0Y2hFcnJvcjsKICBvcHRpb25zLmJhY2tncm91bmQgPSB0aGlzLnBhcmVudC5ub25CbG9ja2luZ0xvYWQ7CiAgcmV0dXJuIG9wdGlvbnM7Cn07Cgppbmhlcml0VmFycy5jb2xsZWN0aW9uLmxvYWRpbmcgPSBmdW5jdGlvbigpIHsKICB2YXIgbG9hZGluZ1ZpZXcgPSB0aGlzLmxvYWRpbmdWaWV3LAogICAgICBsb2FkaW5nVGVtcGxhdGUgPSB0aGlzLmxvYWRpbmdUZW1wbGF0ZSwKICAgICAgbG9hZGluZ1BsYWNlbWVudCA9IHRoaXMubG9hZGluZ1BsYWNlbWVudDsKICAvL2FkZCAibG9hZGluZy12aWV3IiBhbmQgImxvYWRpbmctdGVtcGxhdGUiIG9wdGlvbnMgdG8gY29sbGVjdGlvbiBoZWxwZXIKICBpZiAobG9hZGluZ1ZpZXcgfHwgbG9hZGluZ1RlbXBsYXRlKSB7CiAgICB2YXIgY2FsbGJhY2sgPSBUaG9yYXgubG9hZEhhbmRsZXIoXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbTsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLiRlbC5lbXB0eSgpOwogICAgICB9CiAgICAgIGlmIChsb2FkaW5nVmlldykgewogICAgICAgIHZhciBpbnN0YW5jZSA9IFRob3JheC5VdGlsLmdldFZpZXdJbnN0YW5jZShsb2FkaW5nVmlldyk7CiAgICAgICAgdGhpcy5fYWRkQ2hpbGQoaW5zdGFuY2UpOwogICAgICAgIGlmIChsb2FkaW5nVGVtcGxhdGUpIHsKICAgICAgICAgIGluc3RhbmNlLnJlbmRlcihsb2FkaW5nVGVtcGxhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICB9CiAgICAgICAgaXRlbSA9IGluc3RhbmNlOwogICAgICB9IGVsc2UgewogICAgICAgIGl0ZW0gPSB0aGlzLnJlbmRlclRlbXBsYXRlKGxvYWRpbmdUZW1wbGF0ZSk7CiAgICAgIH0KICAgICAgdmFyIGluZGV4ID0gbG9hZGluZ1BsYWNlbWVudAogICAgICAgID8gbG9hZGluZ1BsYWNlbWVudC5jYWxsKHRoaXMpCiAgICAgICAgOiB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoCiAgICAgIDsKICAgICAgdGhpcy5hcHBlbmRJdGVtKGl0ZW0sIGluZGV4KTsKICAgICAgdGhpcy4kZWwuY2hpbGRyZW4oKS5lcShpbmRleCkuYXR0cignZGF0YS1sb2FkaW5nLWVsZW1lbnQnLCB0aGlzLmNvbGxlY3Rpb24uY2lkKTsKICAgIH0sIHRoaXMpLCBfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLmZpbmQoJ1tkYXRhLWxvYWRpbmctZWxlbWVudD0iJyArIHRoaXMuY29sbGVjdGlvbi5jaWQgKyAnIl0nKS5yZW1vdmUoKTsKICAgIH0sIHRoaXMpLAogICAgdGhpcy5jb2xsZWN0aW9uKTsKCiAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2xvYWQ6c3RhcnQnLCBjYWxsYmFjayk7CiAgfQp9OwoKaWYgKGNvbGxlY3Rpb25PcHRpb25OYW1lcykgewogIGNvbGxlY3Rpb25PcHRpb25OYW1lc1snbG9hZGluZy10ZW1wbGF0ZSddID0gJ2xvYWRpbmdUZW1wbGF0ZSc7CiAgY29sbGVjdGlvbk9wdGlvbk5hbWVzWydsb2FkaW5nLXZpZXcnXSA9ICdsb2FkaW5nVmlldyc7CiAgY29sbGVjdGlvbk9wdGlvbk5hbWVzWydsb2FkaW5nLXBsYWNlbWVudCddID0gJ2xvYWRpbmdQbGFjZW1lbnQnOwp9CgpUaG9yYXguVmlldy5vbih7CiAgJ2xvYWQ6c3RhcnQnOiBUaG9yYXgubG9hZEhhbmRsZXIoCiAgICAgIGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICAgIHRoaXMub25Mb2FkU3RhcnQobWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgICAgdGhpcy5vbkxvYWRFbmQob2JqZWN0KTsKICAgICAgfSksCgogIGNvbGxlY3Rpb246IHsKICAgICdsb2FkOnN0YXJ0JzogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgIHRoaXMudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICB9CiAgfSwKICBtb2RlbDogewogICAgJ2xvYWQ6c3RhcnQnOiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgdGhpcy50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgIH0KICB9Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbG9hZGluZycsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgdmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAgdmlldy5vZmYoJ2NoYW5nZTpsb2FkLXN0YXRlJywgb25Mb2FkU3RhdGVDaGFuZ2UsIHZpZXcpOwogIHZpZXcub24oJ2NoYW5nZTpsb2FkLXN0YXRlJywgb25Mb2FkU3RhdGVDaGFuZ2UsIHZpZXcpOwogIHJldHVybiB2aWV3Ll9pc0xvYWRpbmcgPyBvcHRpb25zLmZuKHRoaXMpIDogb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwp9KTsKCmZ1bmN0aW9uIG9uTG9hZFN0YXRlQ2hhbmdlKCkgewogIHRoaXMucmVuZGVyKCk7Cn0KOzsKdmFyIGlzSUUgPSAoL21zaWUgW1x3Ll0rLykuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpOwoKaWYgKGlzSUUpIHsKICAvLyBJRSB3aWxsIGxvc2UgYSByZWZlcmVuY2UgdG8gdGhlIGVsZW1lbnRzIGlmIHZpZXcuZWwuaW5uZXJIVE1MID0gJyc7CiAgLy8gSWYgdGhleSBhcmUgcmVtb3ZlZCBvbmUgYnkgb25lIHRoZSByZWZlcmVuY2VzIGFyZSBub3QgbG9zdC4KICAvLyBGb3IgaW5zdGFuY2UgYSB2aWV3J3MgY2hpbGRyZW5zJyBgZWxgcyB3aWxsIGJlIGxvc3QgaWYgdGhlIHZpZXcKICAvLyBzZXRzIGl0J3MgYGVsLmlubmVySFRNTGAuCiAgVGhvcmF4LlZpZXcub24oJ2JlZm9yZTphcHBlbmQnLCBmdW5jdGlvbigpIHsKICAgIC8vIG5vdGUgdGhhdCBkZXRhY2ggaXMgbm90IGF2YWlsYWJsZSBpbiBaZXB0bywKICAgIC8vIGJ1dCBJRSBzaG91bGQgbmV2ZXIgcnVuIHdpdGggWmVwdG8KICAgIGlmICh0aGlzLl9yZW5kZXJDb3VudCA+IDApIHsKICAgICAgXy5lYWNoKHRoaXMuX2VsZW1lbnRzQnlDaWQsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAkKGVsZW1lbnQpLmRldGFjaCgpOwogICAgICB9KTsKICAgICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgY2hpbGQuJGVsLmRldGFjaCgpOwogICAgICB9KTsKICAgIH0KICB9KTsKCiAgLy8gT25jZSBub2RlcyBhcmUgZGV0YWNoZWQgdGhlaXIgaW5uZXJIVE1MIGdldHMgbnVrZWQgaW4gSUUKICAvLyBzbyBjcmVhdGUgYSBkZWVwIGNsb25lLiBUaGlzIG1ldGhvZCBpcyBpZGVudGljYWwgdG8gdGhlCiAgLy8gbWFpbiBpbXBsZW1lbnRhdGlvbiBleGNlcHQgZm9yICIuY2xvbmUodHJ1ZSwgdHJ1ZSkiIHdoaWNoCiAgLy8gd2lsbCBwZXJmb3JtIGEgZGVlcCBjbG9uZSB3aXRoIGV2ZW50cyBhbmQgZGF0YQogIFRob3JheC5Db2xsZWN0aW9uVmlldy5wcm90b3R5cGUuX3JlcGxhY2VIVE1MID0gZnVuY3Rpb24oaHRtbCkgewogICAgaWYgKHRoaXMuY29sbGVjdGlvbiAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbdGhpcy5jb2xsZWN0aW9uLmNpZF0gJiYgdGhpcy5fcmVuZGVyQ291bnQpIHsKICAgICAgdmFyIGVsZW1lbnQ7CiAgICAgIHZhciBvbGRDb2xsZWN0aW9uRWxlbWVudCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKS5jbG9uZSh0cnVlLCB0cnVlKTsKICAgICAgZWxlbWVudCA9IF9yZXBsYWNlSFRNTC5jYWxsKHRoaXMsIGh0bWwpOwogICAgICBpZiAoIW9sZENvbGxlY3Rpb25FbGVtZW50LmF0dHIoJ2RhdGEtdmlldy1jaWQnKSkgewogICAgICAgIHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKS5yZXBsYWNlV2l0aChvbGRDb2xsZWN0aW9uRWxlbWVudCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBfcmVwbGFjZUhUTUwuY2FsbCh0aGlzLCBodG1sKTsKICAgIH0KICB9Owp9Cgo7OwoKCn0pKCk7CgovL0Agc291cmNlTWFwcGluZ1VSTD10aG9yYXguanMubWFwCgo=",
                "body": "LyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuOS4wCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMDUsIDIwMTIgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDEzLTEtMTQKICovCihmdW5jdGlvbiggd2luZG93LCB1bmRlZmluZWQgKSB7CiJ1c2Ugc3RyaWN0IjsKdmFyCiAgLy8gQSBjZW50cmFsIHJlZmVyZW5jZSB0byB0aGUgcm9vdCBqUXVlcnkoZG9jdW1lbnQpCiAgcm9vdGpRdWVyeSwKCiAgLy8gVGhlIGRlZmVycmVkIHVzZWQgb24gRE9NIHJlYWR5CiAgcmVhZHlMaXN0LAoKICAvLyBVc2UgdGhlIGNvcnJlY3QgZG9jdW1lbnQgYWNjb3JkaW5nbHkgd2l0aCB3aW5kb3cgYXJndW1lbnQgKHNhbmRib3gpCiAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCgogIC8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQogIF9qUXVlcnkgPSB3aW5kb3cualF1ZXJ5LAoKICAvLyBNYXAgb3ZlciB0aGUgJCBpbiBjYXNlIG9mIG92ZXJ3cml0ZQogIF8kID0gd2luZG93LiQsCgogIC8vIFtbQ2xhc3NdXSAtPiB0eXBlIHBhaXJzCiAgY2xhc3MydHlwZSA9IHt9LAoKICAvLyBMaXN0IG9mIGRlbGV0ZWQgZGF0YSBjYWNoZSBpZHMsIHNvIHdlIGNhbiByZXVzZSB0aGVtCiAgY29yZV9kZWxldGVkSWRzID0gW10sCgogIGNvcmVfdmVyc2lvbiA9ICIxLjkuMCIsCgogIC8vIFNhdmUgYSByZWZlcmVuY2UgdG8gc29tZSBjb3JlIG1ldGhvZHMKICBjb3JlX2NvbmNhdCA9IGNvcmVfZGVsZXRlZElkcy5jb25jYXQsCiAgY29yZV9wdXNoID0gY29yZV9kZWxldGVkSWRzLnB1c2gsCiAgY29yZV9zbGljZSA9IGNvcmVfZGVsZXRlZElkcy5zbGljZSwKICBjb3JlX2luZGV4T2YgPSBjb3JlX2RlbGV0ZWRJZHMuaW5kZXhPZiwKICBjb3JlX3RvU3RyaW5nID0gY2xhc3MydHlwZS50b1N0cmluZywKICBjb3JlX2hhc093biA9IGNsYXNzMnR5cGUuaGFzT3duUHJvcGVydHksCiAgY29yZV90cmltID0gY29yZV92ZXJzaW9uLnRyaW0sCgogIC8vIERlZmluZSBhIGxvY2FsIGNvcHkgb2YgalF1ZXJ5CiAgalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewogICAgLy8gVGhlIGpRdWVyeSBvYmplY3QgaXMgYWN0dWFsbHkganVzdCB0aGUgaW5pdCBjb25zdHJ1Y3RvciAnZW5oYW5jZWQnCiAgICByZXR1cm4gbmV3IGpRdWVyeS5mbi5pbml0KCBzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeSApOwogIH0sCgogIC8vIFVzZWQgZm9yIG1hdGNoaW5nIG51bWJlcnMKICBjb3JlX3BudW0gPSAvWystXT8oPzpcZCpcLnwpXGQrKD86W2VFXVsrLV0/XGQrfCkvLnNvdXJjZSwKCiAgLy8gVXNlZCBmb3Igc3BsaXR0aW5nIG9uIHdoaXRlc3BhY2UKICBjb3JlX3Jub3R3aGl0ZSA9IC9cUysvZywKCiAgLy8gTWFrZSBzdXJlIHdlIHRyaW0gQk9NIGFuZCBOQlNQIChoZXJlJ3MgbG9va2luZyBhdCB5b3UsIFNhZmFyaSA1LjAgYW5kIElFKQogIHJ0cmltID0gL15bXHNcdUZFRkZceEEwXSt8W1xzXHVGRUZGXHhBMF0rJC9nLAoKICAvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncwogIC8vIFByaW9yaXRpemUgI2lkIG92ZXIgPHRhZz4gdG8gYXZvaWQgWFNTIHZpYSBsb2NhdGlvbi5oYXNoICgjOTUyMSkKICAvLyBTdHJpY3QgSFRNTCByZWNvZ25pdGlvbiAoIzExMjkwOiBtdXN0IHN0YXJ0IHdpdGggPCkKICBycXVpY2tFeHByID0gL14oPzooPFtcd1xXXSs+KVtePl0qfCMoW1x3LV0qKSkkLywKCiAgLy8gTWF0Y2ggYSBzdGFuZGFsb25lIHRhZwogIHJzaW5nbGVUYWcgPSAvXjwoXHcrKVxzKlwvPz4oPzo8XC9cMT58KSQvLAoKICAvLyBKU09OIFJlZ0V4cAogIHJ2YWxpZGNoYXJzID0gL15bXF0sOnt9XHNdKiQvLAogIHJ2YWxpZGJyYWNlcyA9IC8oPzpefDp8LCkoPzpccypcWykrL2csCiAgcnZhbGlkZXNjYXBlID0gL1xcKD86WyJcXFwvYmZucnRdfHVbXGRhLWZBLUZdezR9KS9nLAogIHJ2YWxpZHRva2VucyA9IC8iW14iXFxcclxuXSoifHRydWV8ZmFsc2V8bnVsbHwtPyg/OlxkK1wufClcZCsoPzpbZUVdWystXT9cZCt8KS9nLAoKICAvLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKICBybXNQcmVmaXggPSAvXi1tcy0vLAogIHJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwKCiAgLy8gVXNlZCBieSBqUXVlcnkuY2FtZWxDYXNlIGFzIGNhbGxiYWNrIHRvIHJlcGxhY2UoKQogIGZjYW1lbENhc2UgPSBmdW5jdGlvbiggYWxsLCBsZXR0ZXIgKSB7CiAgICByZXR1cm4gbGV0dGVyLnRvVXBwZXJDYXNlKCk7CiAgfSwKCiAgLy8gVGhlIHJlYWR5IGV2ZW50IGhhbmRsZXIgYW5kIHNlbGYgY2xlYW51cCBtZXRob2QKICBET01Db250ZW50TG9hZGVkID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgKSB7CiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiwgRE9NQ29udGVudExvYWRlZCwgZmFsc2UgKTsKICAgICAgalF1ZXJ5LnJlYWR5KCk7CiAgICB9IGVsc2UgaWYgKCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewogICAgICAvLyB3ZSdyZSBoZXJlIGJlY2F1c2UgcmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiBpbiBvbGRJRQogICAgICAvLyB3aGljaCBpcyBnb29kIGVub3VnaCBmb3IgdXMgdG8gY2FsbCB0aGUgZG9tIHJlYWR5IQogICAgICBkb2N1bWVudC5kZXRhY2hFdmVudCggIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIERPTUNvbnRlbnRMb2FkZWQgKTsKICAgICAgalF1ZXJ5LnJlYWR5KCk7CiAgICB9CiAgfTsKCmpRdWVyeS5mbiA9IGpRdWVyeS5wcm90b3R5cGUgPSB7CiAgLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBqUXVlcnkgYmVpbmcgdXNlZAogIGpxdWVyeTogY29yZV92ZXJzaW9uLAoKICBjb25zdHJ1Y3RvcjogalF1ZXJ5LAogIGluaXQ6IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeSApIHsKICAgIHZhciBtYXRjaCwgZWxlbTsKCiAgICAvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCiAgICBpZiAoICFzZWxlY3RvciApIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLy8gSGFuZGxlIEhUTUwgc3RyaW5ncwogICAgaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewogICAgICBpZiAoIHNlbGVjdG9yLmNoYXJBdCgwKSA9PT0gIjwiICYmIHNlbGVjdG9yLmNoYXJBdCggc2VsZWN0b3IubGVuZ3RoIC0gMSApID09PSAiPiIgJiYgc2VsZWN0b3IubGVuZ3RoID49IDMgKSB7CiAgICAgICAgLy8gQXNzdW1lIHRoYXQgc3RyaW5ncyB0aGF0IHN0YXJ0IGFuZCBlbmQgd2l0aCA8PiBhcmUgSFRNTCBhbmQgc2tpcCB0aGUgcmVnZXggY2hlY2sKICAgICAgICBtYXRjaCA9IFsgbnVsbCwgc2VsZWN0b3IsIG51bGwgXTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoIHNlbGVjdG9yICk7CiAgICAgIH0KCiAgICAgIC8vIE1hdGNoIGh0bWwgb3IgbWFrZSBzdXJlIG5vIGNvbnRleHQgaXMgc3BlY2lmaWVkIGZvciAjaWQKICAgICAgaWYgKCBtYXRjaCAmJiAobWF0Y2hbMV0gfHwgIWNvbnRleHQpICkgewoKICAgICAgICAvLyBIQU5ETEU6ICQoaHRtbCkgLT4gJChhcnJheSkKICAgICAgICBpZiAoIG1hdGNoWzFdICkgewogICAgICAgICAgY29udGV4dCA9IGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgPyBjb250ZXh0WzBdIDogY29udGV4dDsKCiAgICAgICAgICAvLyBzY3JpcHRzIGlzIHRydWUgZm9yIGJhY2stY29tcGF0CiAgICAgICAgICBqUXVlcnkubWVyZ2UoIHRoaXMsIGpRdWVyeS5wYXJzZUhUTUwoCiAgICAgICAgICAgIG1hdGNoWzFdLAogICAgICAgICAgICBjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IGRvY3VtZW50LAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApICk7CgogICAgICAgICAgLy8gSEFORExFOiAkKGh0bWwsIHByb3BzKQogICAgICAgICAgaWYgKCByc2luZ2xlVGFnLnRlc3QoIG1hdGNoWzFdICkgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3QoIGNvbnRleHQgKSApIHsKICAgICAgICAgICAgZm9yICggbWF0Y2ggaW4gY29udGV4dCApIHsKICAgICAgICAgICAgICAvLyBQcm9wZXJ0aWVzIG9mIGNvbnRleHQgYXJlIGNhbGxlZCBhcyBtZXRob2RzIGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdGhpc1sgbWF0Y2ggXSApICkgewogICAgICAgICAgICAgICAgdGhpc1sgbWF0Y2ggXSggY29udGV4dFsgbWF0Y2ggXSApOwoKICAgICAgICAgICAgICAvLyAuLi5hbmQgb3RoZXJ3aXNlIHNldCBhcyBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYXR0ciggbWF0Y2gsIGNvbnRleHRbIG1hdGNoIF0gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdGhpczsKCiAgICAgICAgLy8gSEFORExFOiAkKCNpZCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFsyXSApOwoKICAgICAgICAgIC8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCiAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgICBpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewogICAgICAgICAgICAvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUgYW5kIE9wZXJhIHJldHVybiBpdGVtcwogICAgICAgICAgICAvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKICAgICAgICAgICAgaWYgKCBlbGVtLmlkICE9PSBtYXRjaFsyXSApIHsKICAgICAgICAgICAgICByZXR1cm4gcm9vdGpRdWVyeS5maW5kKCBzZWxlY3RvciApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPdGhlcndpc2UsIHdlIGluamVjdCB0aGUgZWxlbWVudCBkaXJlY3RseSBpbnRvIHRoZSBqUXVlcnkgb2JqZWN0CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMTsKICAgICAgICAgICAgdGhpc1swXSA9IGVsZW07CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CiAgICAgICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAvLyBIQU5ETEU6ICQoZXhwciwgJCguLi4pKQogICAgICB9IGVsc2UgaWYgKCAhY29udGV4dCB8fCBjb250ZXh0LmpxdWVyeSApIHsKICAgICAgICByZXR1cm4gKCBjb250ZXh0IHx8IHJvb3RqUXVlcnkgKS5maW5kKCBzZWxlY3RvciApOwoKICAgICAgLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpCiAgICAgIC8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKTsKICAgICAgfQoKICAgIC8vIEhBTkRMRTogJChET01FbGVtZW50KQogICAgfSBlbHNlIGlmICggc2VsZWN0b3Iubm9kZVR5cGUgKSB7CiAgICAgIHRoaXMuY29udGV4dCA9IHRoaXNbMF0gPSBzZWxlY3RvcjsKICAgICAgdGhpcy5sZW5ndGggPSAxOwogICAgICByZXR1cm4gdGhpczsKCiAgICAvLyBIQU5ETEU6ICQoZnVuY3Rpb24pCiAgICAvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKICAgIH0gZWxzZSBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBzZWxlY3RvciApICkgewogICAgICByZXR1cm4gcm9vdGpRdWVyeS5yZWFkeSggc2VsZWN0b3IgKTsKICAgIH0KCiAgICBpZiAoIHNlbGVjdG9yLnNlbGVjdG9yICE9PSB1bmRlZmluZWQgKSB7CiAgICAgIHRoaXMuc2VsZWN0b3IgPSBzZWxlY3Rvci5zZWxlY3RvcjsKICAgICAgdGhpcy5jb250ZXh0ID0gc2VsZWN0b3IuY29udGV4dDsKICAgIH0KCiAgICByZXR1cm4galF1ZXJ5Lm1ha2VBcnJheSggc2VsZWN0b3IsIHRoaXMgKTsKICB9LAoKICAvLyBTdGFydCB3aXRoIGFuIGVtcHR5IHNlbGVjdG9yCiAgc2VsZWN0b3I6ICIiLAoKICAvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDAKICBsZW5ndGg6IDAsCgogIC8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CiAgc2l6ZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGg7CiAgfSwKCiAgdG9BcnJheTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29yZV9zbGljZS5jYWxsKCB0aGlzICk7CiAgfSwKCiAgLy8gR2V0IHRoZSBOdGggZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldCBPUgogIC8vIEdldCB0aGUgd2hvbGUgbWF0Y2hlZCBlbGVtZW50IHNldCBhcyBhIGNsZWFuIGFycmF5CiAgZ2V0OiBmdW5jdGlvbiggbnVtICkgewogICAgcmV0dXJuIG51bSA9PSBudWxsID8KCiAgICAgIC8vIFJldHVybiBhICdjbGVhbicgYXJyYXkKICAgICAgdGhpcy50b0FycmF5KCkgOgoKICAgICAgLy8gUmV0dXJuIGp1c3QgdGhlIG9iamVjdAogICAgICAoIG51bSA8IDAgPyB0aGlzWyB0aGlzLmxlbmd0aCArIG51bSBdIDogdGhpc1sgbnVtIF0gKTsKICB9LAoKICAvLyBUYWtlIGFuIGFycmF5IG9mIGVsZW1lbnRzIGFuZCBwdXNoIGl0IG9udG8gdGhlIHN0YWNrCiAgLy8gKHJldHVybmluZyB0aGUgbmV3IG1hdGNoZWQgZWxlbWVudCBzZXQpCiAgcHVzaFN0YWNrOiBmdW5jdGlvbiggZWxlbXMgKSB7CgogICAgLy8gQnVpbGQgYSBuZXcgalF1ZXJ5IG1hdGNoZWQgZWxlbWVudCBzZXQKICAgIHZhciByZXQgPSBqUXVlcnkubWVyZ2UoIHRoaXMuY29uc3RydWN0b3IoKSwgZWxlbXMgKTsKCiAgICAvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQogICAgcmV0LnByZXZPYmplY3QgPSB0aGlzOwogICAgcmV0LmNvbnRleHQgPSB0aGlzLmNvbnRleHQ7CgogICAgLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKICAgIHJldHVybiByZXQ7CiAgfSwKCiAgLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KICAvLyAoWW91IGNhbiBzZWVkIHRoZSBhcmd1bWVudHMgd2l0aCBhbiBhcnJheSBvZiBhcmdzLCBidXQgdGhpcyBpcwogIC8vIG9ubHkgdXNlZCBpbnRlcm5hbGx5LikKICBlYWNoOiBmdW5jdGlvbiggY2FsbGJhY2ssIGFyZ3MgKSB7CiAgICByZXR1cm4galF1ZXJ5LmVhY2goIHRoaXMsIGNhbGxiYWNrLCBhcmdzICk7CiAgfSwKCiAgcmVhZHk6IGZ1bmN0aW9uKCBmbiApIHsKICAgIC8vIEFkZCB0aGUgY2FsbGJhY2sKICAgIGpRdWVyeS5yZWFkeS5wcm9taXNlKCkuZG9uZSggZm4gKTsKCiAgICByZXR1cm4gdGhpczsKICB9LAoKICBzbGljZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soIGNvcmVfc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApICk7CiAgfSwKCiAgZmlyc3Q6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZXEoIDAgKTsKICB9LAoKICBsYXN0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmVxKCAtMSApOwogIH0sCgogIGVxOiBmdW5jdGlvbiggaSApIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aCwKICAgICAgaiA9ICtpICsgKCBpIDwgMCA/IGxlbiA6IDAgKTsKICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayggaiA+PSAwICYmIGogPCBsZW4gPyBbIHRoaXNbal0gXSA6IFtdICk7CiAgfSwKCiAgbWFwOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CiAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CiAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKCBlbGVtLCBpLCBlbGVtICk7CiAgICB9KSk7CiAgfSwKCiAgZW5kOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcihudWxsKTsKICB9LAoKICAvLyBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuCiAgLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCiAgcHVzaDogY29yZV9wdXNoLAogIHNvcnQ6IFtdLnNvcnQsCiAgc3BsaWNlOiBbXS5zcGxpY2UKfTsKCi8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KalF1ZXJ5LmZuLmluaXQucHJvdG90eXBlID0galF1ZXJ5LmZuOwoKalF1ZXJ5LmV4dGVuZCA9IGpRdWVyeS5mbi5leHRlbmQgPSBmdW5jdGlvbigpIHsKICB2YXIgb3B0aW9ucywgbmFtZSwgc3JjLCBjb3B5LCBjb3B5SXNBcnJheSwgY2xvbmUsCiAgICB0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sCiAgICBpID0gMSwKICAgIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICBkZWVwID0gZmFsc2U7CgogIC8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KICBpZiAoIHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIiApIHsKICAgIGRlZXAgPSB0YXJnZXQ7CiAgICB0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CiAgICAvLyBza2lwIHRoZSBib29sZWFuIGFuZCB0aGUgdGFyZ2V0CiAgICBpID0gMjsKICB9CgogIC8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQogIGlmICggdHlwZW9mIHRhcmdldCAhPT0gIm9iamVjdCIgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKHRhcmdldCkgKSB7CiAgICB0YXJnZXQgPSB7fTsKICB9CgogIC8vIGV4dGVuZCBqUXVlcnkgaXRzZWxmIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAogIGlmICggbGVuZ3RoID09PSBpICkgewogICAgdGFyZ2V0ID0gdGhpczsKICAgIC0taTsKICB9CgogIGZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewogICAgLy8gT25seSBkZWFsIHdpdGggbm9uLW51bGwvdW5kZWZpbmVkIHZhbHVlcwogICAgaWYgKCAob3B0aW9ucyA9IGFyZ3VtZW50c1sgaSBdKSAhPSBudWxsICkgewogICAgICAvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CiAgICAgIGZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsKICAgICAgICBzcmMgPSB0YXJnZXRbIG5hbWUgXTsKICAgICAgICBjb3B5ID0gb3B0aW9uc1sgbmFtZSBdOwoKICAgICAgICAvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCiAgICAgICAgaWYgKCB0YXJnZXQgPT09IGNvcHkgKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIC8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwogICAgICAgIGlmICggZGVlcCAmJiBjb3B5ICYmICggalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0galF1ZXJ5LmlzQXJyYXkoY29weSkpICkgKSB7CiAgICAgICAgICBpZiAoIGNvcHlJc0FycmF5ICkgewogICAgICAgICAgICBjb3B5SXNBcnJheSA9IGZhbHNlOwogICAgICAgICAgICBjbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNBcnJheShzcmMpID8gc3JjIDogW107CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSA/IHNyYyA6IHt9OwogICAgICAgICAgfQoKICAgICAgICAgIC8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQogICAgICAgICAgdGFyZ2V0WyBuYW1lIF0gPSBqUXVlcnkuZXh0ZW5kKCBkZWVwLCBjbG9uZSwgY29weSApOwoKICAgICAgICAvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCiAgICAgICAgfSBlbHNlIGlmICggY29weSAhPT0gdW5kZWZpbmVkICkgewogICAgICAgICAgdGFyZ2V0WyBuYW1lIF0gPSBjb3B5OwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLy8gUmV0dXJuIHRoZSBtb2RpZmllZCBvYmplY3QKICByZXR1cm4gdGFyZ2V0Owp9OwoKalF1ZXJ5LmV4dGVuZCh7CiAgbm9Db25mbGljdDogZnVuY3Rpb24oIGRlZXAgKSB7CiAgICBpZiAoIHdpbmRvdy4kID09PSBqUXVlcnkgKSB7CiAgICAgIHdpbmRvdy4kID0gXyQ7CiAgICB9CgogICAgaWYgKCBkZWVwICYmIHdpbmRvdy5qUXVlcnkgPT09IGpRdWVyeSApIHsKICAgICAgd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CiAgICB9CgogICAgcmV0dXJuIGpRdWVyeTsKICB9LAoKICAvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgogIGlzUmVhZHk6IGZhbHNlLAoKICAvLyBBIGNvdW50ZXIgdG8gdHJhY2sgaG93IG1hbnkgaXRlbXMgdG8gd2FpdCBmb3IgYmVmb3JlCiAgLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODEKICByZWFkeVdhaXQ6IDEsCgogIC8vIEhvbGQgKG9yIHJlbGVhc2UpIHRoZSByZWFkeSBldmVudAogIGhvbGRSZWFkeTogZnVuY3Rpb24oIGhvbGQgKSB7CiAgICBpZiAoIGhvbGQgKSB7CiAgICAgIGpRdWVyeS5yZWFkeVdhaXQrKzsKICAgIH0gZWxzZSB7CiAgICAgIGpRdWVyeS5yZWFkeSggdHJ1ZSApOwogICAgfQogIH0sCgogIC8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKICByZWFkeTogZnVuY3Rpb24oIHdhaXQgKSB7CgogICAgLy8gQWJvcnQgaWYgdGhlcmUgYXJlIHBlbmRpbmcgaG9sZHMgb3Igd2UncmUgYWxyZWFkeSByZWFkeQogICAgaWYgKCB3YWl0ID09PSB0cnVlID8gLS1qUXVlcnkucmVhZHlXYWl0IDogalF1ZXJ5LmlzUmVhZHkgKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBNYWtlIHN1cmUgYm9keSBleGlzdHMsIGF0IGxlYXN0LCBpbiBjYXNlIElFIGdldHMgYSBsaXR0bGUgb3ZlcnplYWxvdXMgKHRpY2tldCAjNTQ0MykuCiAgICBpZiAoICFkb2N1bWVudC5ib2R5ICkgewogICAgICByZXR1cm4gc2V0VGltZW91dCggalF1ZXJ5LnJlYWR5ICk7CiAgICB9CgogICAgLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CiAgICBqUXVlcnkuaXNSZWFkeSA9IHRydWU7CgogICAgLy8gSWYgYSBub3JtYWwgRE9NIFJlYWR5IGV2ZW50IGZpcmVkLCBkZWNyZW1lbnQsIGFuZCB3YWl0IGlmIG5lZWQgYmUKICAgIGlmICggd2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwICkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gSWYgdGhlcmUgYXJlIGZ1bmN0aW9ucyBib3VuZCwgdG8gZXhlY3V0ZQogICAgcmVhZHlMaXN0LnJlc29sdmVXaXRoKCBkb2N1bWVudCwgWyBqUXVlcnkgXSApOwoKICAgIC8vIFRyaWdnZXIgYW55IGJvdW5kIHJlYWR5IGV2ZW50cwogICAgaWYgKCBqUXVlcnkuZm4udHJpZ2dlciApIHsKICAgICAgalF1ZXJ5KCBkb2N1bWVudCApLnRyaWdnZXIoInJlYWR5Iikub2ZmKCJyZWFkeSIpOwogICAgfQogIH0sCgogIC8vIFNlZSB0ZXN0L3VuaXQvY29yZS5qcyBmb3IgZGV0YWlscyBjb25jZXJuaW5nIGlzRnVuY3Rpb24uCiAgLy8gU2luY2UgdmVyc2lvbiAxLjMsIERPTSBtZXRob2RzIGFuZCBmdW5jdGlvbnMgbGlrZSBhbGVydAogIC8vIGFyZW4ndCBzdXBwb3J0ZWQuIFRoZXkgcmV0dXJuIGZhbHNlIG9uIElFICgjMjk2OCkuCiAgaXNGdW5jdGlvbjogZnVuY3Rpb24oIG9iaiApIHsKICAgIHJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiZnVuY3Rpb24iOwogIH0sCgogIGlzQXJyYXk6IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24oIG9iaiApIHsKICAgIHJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiYXJyYXkiOwogIH0sCgogIGlzV2luZG93OiBmdW5jdGlvbiggb2JqICkgewogICAgcmV0dXJuIG9iaiAhPSBudWxsICYmIG9iaiA9PSBvYmoud2luZG93OwogIH0sCgogIGlzTnVtZXJpYzogZnVuY3Rpb24oIG9iaiApIHsKICAgIHJldHVybiAhaXNOYU4oIHBhcnNlRmxvYXQob2JqKSApICYmIGlzRmluaXRlKCBvYmogKTsKICB9LAoKICB0eXBlOiBmdW5jdGlvbiggb2JqICkgewogICAgaWYgKCBvYmogPT0gbnVsbCApIHsKICAgICAgcmV0dXJuIFN0cmluZyggb2JqICk7CiAgICB9CiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIiA/CiAgICAgIGNsYXNzMnR5cGVbIGNvcmVfdG9TdHJpbmcuY2FsbChvYmopIF0gfHwgIm9iamVjdCIgOgogICAgICB0eXBlb2Ygb2JqOwogIH0sCgogIGlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CiAgICAvLyBNdXN0IGJlIGFuIE9iamVjdC4KICAgIC8vIEJlY2F1c2Ugb2YgSUUsIHdlIGFsc28gaGF2ZSB0byBjaGVjayB0aGUgcHJlc2VuY2Ugb2YgdGhlIGNvbnN0cnVjdG9yIHByb3BlcnR5LgogICAgLy8gTWFrZSBzdXJlIHRoYXQgRE9NIG5vZGVzIGFuZCB3aW5kb3cgb2JqZWN0cyBkb24ndCBwYXNzIHRocm91Z2gsIGFzIHdlbGwKICAgIGlmICggIW9iaiB8fCBqUXVlcnkudHlwZShvYmopICE9PSAib2JqZWN0IiB8fCBvYmoubm9kZVR5cGUgfHwgalF1ZXJ5LmlzV2luZG93KCBvYmogKSApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHRyeSB7CiAgICAgIC8vIE5vdCBvd24gY29uc3RydWN0b3IgcHJvcGVydHkgbXVzdCBiZSBPYmplY3QKICAgICAgaWYgKCBvYmouY29uc3RydWN0b3IgJiYKICAgICAgICAhY29yZV9oYXNPd24uY2FsbChvYmosICJjb25zdHJ1Y3RvciIpICYmCiAgICAgICAgIWNvcmVfaGFzT3duLmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgImlzUHJvdG90eXBlT2YiKSApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0gY2F0Y2ggKCBlICkgewogICAgICAvLyBJRTgsOSBXaWxsIHRocm93IGV4Y2VwdGlvbnMgb24gY2VydGFpbiBob3N0IG9iamVjdHMgIzk4OTcKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIE93biBwcm9wZXJ0aWVzIGFyZSBlbnVtZXJhdGVkIGZpcnN0bHksIHNvIHRvIHNwZWVkIHVwLAogICAgLy8gaWYgbGFzdCBvbmUgaXMgb3duLCB0aGVuIGFsbCBwcm9wZXJ0aWVzIGFyZSBvd24uCgogICAgdmFyIGtleTsKICAgIGZvciAoIGtleSBpbiBvYmogKSB7fQoKICAgIHJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBjb3JlX2hhc093bi5jYWxsKCBvYmosIGtleSApOwogIH0sCgogIGlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CiAgICB2YXIgbmFtZTsKICAgIGZvciAoIG5hbWUgaW4gb2JqICkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICBlcnJvcjogZnVuY3Rpb24oIG1zZyApIHsKICAgIHRocm93IG5ldyBFcnJvciggbXNnICk7CiAgfSwKCiAgLy8gZGF0YTogc3RyaW5nIG9mIGh0bWwKICAvLyBjb250ZXh0IChvcHRpb25hbCk6IElmIHNwZWNpZmllZCwgdGhlIGZyYWdtZW50IHdpbGwgYmUgY3JlYXRlZCBpbiB0aGlzIGNvbnRleHQsIGRlZmF1bHRzIHRvIGRvY3VtZW50CiAgLy8ga2VlcFNjcmlwdHMgKG9wdGlvbmFsKTogSWYgdHJ1ZSwgd2lsbCBpbmNsdWRlIHNjcmlwdHMgcGFzc2VkIGluIHRoZSBodG1sIHN0cmluZwogIHBhcnNlSFRNTDogZnVuY3Rpb24oIGRhdGEsIGNvbnRleHQsIGtlZXBTY3JpcHRzICkgewogICAgaWYgKCAhZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gImJvb2xlYW4iICkgewogICAgICBrZWVwU2NyaXB0cyA9IGNvbnRleHQ7CiAgICAgIGNvbnRleHQgPSBmYWxzZTsKICAgIH0KICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwoKICAgIHZhciBwYXJzZWQgPSByc2luZ2xlVGFnLmV4ZWMoIGRhdGEgKSwKICAgICAgc2NyaXB0cyA9ICFrZWVwU2NyaXB0cyAmJiBbXTsKCiAgICAvLyBTaW5nbGUgdGFnCiAgICBpZiAoIHBhcnNlZCApIHsKICAgICAgcmV0dXJuIFsgY29udGV4dC5jcmVhdGVFbGVtZW50KCBwYXJzZWRbMV0gKSBdOwogICAgfQoKICAgIHBhcnNlZCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KCBbIGRhdGEgXSwgY29udGV4dCwgc2NyaXB0cyApOwogICAgaWYgKCBzY3JpcHRzICkgewogICAgICBqUXVlcnkoIHNjcmlwdHMgKS5yZW1vdmUoKTsKICAgIH0KICAgIHJldHVybiBqUXVlcnkubWVyZ2UoIFtdLCBwYXJzZWQuY2hpbGROb2RlcyApOwogIH0sCgogIHBhcnNlSlNPTjogZnVuY3Rpb24oIGRhdGEgKSB7CiAgICAvLyBBdHRlbXB0IHRvIHBhcnNlIHVzaW5nIHRoZSBuYXRpdmUgSlNPTiBwYXJzZXIgZmlyc3QKICAgIGlmICggd2luZG93LkpTT04gJiYgd2luZG93LkpTT04ucGFyc2UgKSB7CiAgICAgIHJldHVybiB3aW5kb3cuSlNPTi5wYXJzZSggZGF0YSApOwogICAgfQoKICAgIGlmICggZGF0YSA9PT0gbnVsbCApIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CgogICAgaWYgKCB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgKSB7CgogICAgICAvLyBNYWtlIHN1cmUgbGVhZGluZy90cmFpbGluZyB3aGl0ZXNwYWNlIGlzIHJlbW92ZWQgKElFIGNhbid0IGhhbmRsZSBpdCkKICAgICAgZGF0YSA9IGpRdWVyeS50cmltKCBkYXRhICk7CgogICAgICBpZiAoIGRhdGEgKSB7CiAgICAgICAgLy8gTWFrZSBzdXJlIHRoZSBpbmNvbWluZyBkYXRhIGlzIGFjdHVhbCBKU09OCiAgICAgICAgLy8gTG9naWMgYm9ycm93ZWQgZnJvbSBodHRwOi8vanNvbi5vcmcvanNvbjIuanMKICAgICAgICBpZiAoIHJ2YWxpZGNoYXJzLnRlc3QoIGRhdGEucmVwbGFjZSggcnZhbGlkZXNjYXBlLCAiQCIgKQogICAgICAgICAgLnJlcGxhY2UoIHJ2YWxpZHRva2VucywgIl0iICkKICAgICAgICAgIC5yZXBsYWNlKCBydmFsaWRicmFjZXMsICIiKSkgKSB7CgogICAgICAgICAgcmV0dXJuICggbmV3IEZ1bmN0aW9uKCAicmV0dXJuICIgKyBkYXRhICkgKSgpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGpRdWVyeS5lcnJvciggIkludmFsaWQgSlNPTjogIiArIGRhdGEgKTsKICB9LAoKICAvLyBDcm9zcy1icm93c2VyIHhtbCBwYXJzaW5nCiAgcGFyc2VYTUw6IGZ1bmN0aW9uKCBkYXRhICkgewogICAgdmFyIHhtbCwgdG1wOwogICAgaWYgKCAhZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdHJ5IHsKICAgICAgaWYgKCB3aW5kb3cuRE9NUGFyc2VyICkgeyAvLyBTdGFuZGFyZAogICAgICAgIHRtcCA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICB4bWwgPSB0bXAucGFyc2VGcm9tU3RyaW5nKCBkYXRhICwgInRleHQveG1sIiApOwogICAgICB9IGVsc2UgeyAvLyBJRQogICAgICAgIHhtbCA9IG5ldyBBY3RpdmVYT2JqZWN0KCAiTWljcm9zb2Z0LlhNTERPTSIgKTsKICAgICAgICB4bWwuYXN5bmMgPSAiZmFsc2UiOwogICAgICAgIHhtbC5sb2FkWE1MKCBkYXRhICk7CiAgICAgIH0KICAgIH0gY2F0Y2goIGUgKSB7CiAgICAgIHhtbCA9IHVuZGVmaW5lZDsKICAgIH0KICAgIGlmICggIXhtbCB8fCAheG1sLmRvY3VtZW50RWxlbWVudCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJwYXJzZXJlcnJvciIgKS5sZW5ndGggKSB7CiAgICAgIGpRdWVyeS5lcnJvciggIkludmFsaWQgWE1MOiAiICsgZGF0YSApOwogICAgfQogICAgcmV0dXJuIHhtbDsKICB9LAoKICBub29wOiBmdW5jdGlvbigpIHt9LAoKICAvLyBFdmFsdWF0ZXMgYSBzY3JpcHQgaW4gYSBnbG9iYWwgY29udGV4dAogIC8vIFdvcmthcm91bmRzIGJhc2VkIG9uIGZpbmRpbmdzIGJ5IEppbSBEcmlzY29sbAogIC8vIGh0dHA6Ly93ZWJsb2dzLmphdmEubmV0L2Jsb2cvZHJpc2NvbGwvYXJjaGl2ZS8yMDA5LzA5LzA4L2V2YWwtamF2YXNjcmlwdC1nbG9iYWwtY29udGV4dAogIGdsb2JhbEV2YWw6IGZ1bmN0aW9uKCBkYXRhICkgewogICAgaWYgKCBkYXRhICYmIGpRdWVyeS50cmltKCBkYXRhICkgKSB7CiAgICAgIC8vIFdlIHVzZSBleGVjU2NyaXB0IG9uIEludGVybmV0IEV4cGxvcmVyCiAgICAgIC8vIFdlIHVzZSBhbiBhbm9ueW1vdXMgZnVuY3Rpb24gc28gdGhhdCBjb250ZXh0IGlzIHdpbmRvdwogICAgICAvLyByYXRoZXIgdGhhbiBqUXVlcnkgaW4gRmlyZWZveAogICAgICAoIHdpbmRvdy5leGVjU2NyaXB0IHx8IGZ1bmN0aW9uKCBkYXRhICkgewogICAgICAgIHdpbmRvd1sgImV2YWwiIF0uY2FsbCggd2luZG93LCBkYXRhICk7CiAgICAgIH0gKSggZGF0YSApOwogICAgfQogIH0sCgogIC8vIENvbnZlcnQgZGFzaGVkIHRvIGNhbWVsQ2FzZTsgdXNlZCBieSB0aGUgY3NzIGFuZCBkYXRhIG1vZHVsZXMKICAvLyBNaWNyb3NvZnQgZm9yZ290IHRvIGh1bXAgdGhlaXIgdmVuZG9yIHByZWZpeCAoIzk1NzIpCiAgY2FtZWxDYXNlOiBmdW5jdGlvbiggc3RyaW5nICkgewogICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKCBybXNQcmVmaXgsICJtcy0iICkucmVwbGFjZSggcmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSApOwogIH0sCgogIG5vZGVOYW1lOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKICAgIHJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOwogIH0sCgogIC8vIGFyZ3MgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICBlYWNoOiBmdW5jdGlvbiggb2JqLCBjYWxsYmFjaywgYXJncyApIHsKICAgIHZhciB2YWx1ZSwKICAgICAgaSA9IDAsCiAgICAgIGxlbmd0aCA9IG9iai5sZW5ndGgsCiAgICAgIGlzQXJyYXkgPSBpc0FycmF5bGlrZSggb2JqICk7CgogICAgaWYgKCBhcmdzICkgewogICAgICBpZiAoIGlzQXJyYXkgKSB7CiAgICAgICAgZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkgXSwgYXJncyApOwoKICAgICAgICAgIGlmICggdmFsdWUgPT09IGZhbHNlICkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yICggaSBpbiBvYmogKSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkgXSwgYXJncyApOwoKICAgICAgICAgIGlmICggdmFsdWUgPT09IGZhbHNlICkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAvLyBBIHNwZWNpYWwsIGZhc3QsIGNhc2UgZm9yIHRoZSBtb3N0IGNvbW1vbiB1c2Ugb2YgZWFjaAogICAgfSBlbHNlIHsKICAgICAgaWYgKCBpc0FycmF5ICkgewogICAgICAgIGZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewogICAgICAgICAgdmFsdWUgPSBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKTsKCiAgICAgICAgICBpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoIGkgaW4gb2JqICkgewogICAgICAgICAgdmFsdWUgPSBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKTsKCiAgICAgICAgICBpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9LAoKICAvLyBVc2UgbmF0aXZlIFN0cmluZy50cmltIGZ1bmN0aW9uIHdoZXJldmVyIHBvc3NpYmxlCiAgdHJpbTogY29yZV90cmltICYmICFjb3JlX3RyaW0uY2FsbCgiXHVGRUZGXHhBMCIpID8KICAgIGZ1bmN0aW9uKCB0ZXh0ICkgewogICAgICByZXR1cm4gdGV4dCA9PSBudWxsID8KICAgICAgICAiIiA6CiAgICAgICAgY29yZV90cmltLmNhbGwoIHRleHQgKTsKICAgIH0gOgoKICAgIC8vIE90aGVyd2lzZSB1c2Ugb3VyIG93biB0cmltbWluZyBmdW5jdGlvbmFsaXR5CiAgICBmdW5jdGlvbiggdGV4dCApIHsKICAgICAgcmV0dXJuIHRleHQgPT0gbnVsbCA/CiAgICAgICAgIiIgOgogICAgICAgICggdGV4dCArICIiICkucmVwbGFjZSggcnRyaW0sICIiICk7CiAgICB9LAoKICAvLyByZXN1bHRzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgbWFrZUFycmF5OiBmdW5jdGlvbiggYXJyLCByZXN1bHRzICkgewogICAgdmFyIHJldCA9IHJlc3VsdHMgfHwgW107CgogICAgaWYgKCBhcnIgIT0gbnVsbCApIHsKICAgICAgaWYgKCBpc0FycmF5bGlrZSggT2JqZWN0KGFycikgKSApIHsKICAgICAgICBqUXVlcnkubWVyZ2UoIHJldCwKICAgICAgICAgIHR5cGVvZiBhcnIgPT09ICJzdHJpbmciID8KICAgICAgICAgIFsgYXJyIF0gOiBhcnIKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIGNvcmVfcHVzaC5jYWxsKCByZXQsIGFyciApOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJldDsKICB9LAoKICBpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyLCBpICkgewogICAgdmFyIGxlbjsKCiAgICBpZiAoIGFyciApIHsKICAgICAgaWYgKCBjb3JlX2luZGV4T2YgKSB7CiAgICAgICAgcmV0dXJuIGNvcmVfaW5kZXhPZi5jYWxsKCBhcnIsIGVsZW0sIGkgKTsKICAgICAgfQoKICAgICAgbGVuID0gYXJyLmxlbmd0aDsKICAgICAgaSA9IGkgPyBpIDwgMCA/IE1hdGgubWF4KCAwLCBsZW4gKyBpICkgOiBpIDogMDsKCiAgICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgICAgIC8vIFNraXAgYWNjZXNzaW5nIGluIHNwYXJzZSBhcnJheXMKICAgICAgICBpZiAoIGkgaW4gYXJyICYmIGFyclsgaSBdID09PSBlbGVtICkgewogICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIC0xOwogIH0sCgogIG1lcmdlOiBmdW5jdGlvbiggZmlyc3QsIHNlY29uZCApIHsKICAgIHZhciBsID0gc2Vjb25kLmxlbmd0aCwKICAgICAgaSA9IGZpcnN0Lmxlbmd0aCwKICAgICAgaiA9IDA7CgogICAgaWYgKCB0eXBlb2YgbCA9PT0gIm51bWJlciIgKSB7CiAgICAgIGZvciAoIDsgaiA8IGw7IGorKyApIHsKICAgICAgICBmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGogXTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgd2hpbGUgKCBzZWNvbmRbal0gIT09IHVuZGVmaW5lZCApIHsKICAgICAgICBmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGorKyBdOwogICAgICB9CiAgICB9CgogICAgZmlyc3QubGVuZ3RoID0gaTsKCiAgICByZXR1cm4gZmlyc3Q7CiAgfSwKCiAgZ3JlcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgaW52ICkgewogICAgdmFyIHJldFZhbCwKICAgICAgcmV0ID0gW10sCiAgICAgIGkgPSAwLAogICAgICBsZW5ndGggPSBlbGVtcy5sZW5ndGg7CiAgICBpbnYgPSAhIWludjsKCiAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCiAgICAvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgogICAgZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgIHJldFZhbCA9ICEhY2FsbGJhY2soIGVsZW1zWyBpIF0sIGkgKTsKICAgICAgaWYgKCBpbnYgIT09IHJldFZhbCApIHsKICAgICAgICByZXQucHVzaCggZWxlbXNbIGkgXSApOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJldDsKICB9LAoKICAvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICBtYXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGFyZyApIHsKICAgIHZhciB2YWx1ZSwKICAgICAgaSA9IDAsCiAgICAgIGxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKICAgICAgaXNBcnJheSA9IGlzQXJyYXlsaWtlKCBlbGVtcyApLAogICAgICByZXQgPSBbXTsKCiAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXIKICAgIGlmICggaXNBcnJheSApIHsKICAgICAgZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgICAgdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSwgYXJnICk7CgogICAgICAgIGlmICggdmFsdWUgIT0gbnVsbCApIHsKICAgICAgICAgIHJldFsgcmV0Lmxlbmd0aCBdID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CgogICAgLy8gR28gdGhyb3VnaCBldmVyeSBrZXkgb24gdGhlIG9iamVjdCwKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoIGkgaW4gZWxlbXMgKSB7CiAgICAgICAgdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSwgYXJnICk7CgogICAgICAgIGlmICggdmFsdWUgIT0gbnVsbCApIHsKICAgICAgICAgIHJldFsgcmV0Lmxlbmd0aCBdID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwogICAgcmV0dXJuIGNvcmVfY29uY2F0LmFwcGx5KCBbXSwgcmV0ICk7CiAgfSwKCiAgLy8gQSBnbG9iYWwgR1VJRCBjb3VudGVyIGZvciBvYmplY3RzCiAgZ3VpZDogMSwKCiAgLy8gQmluZCBhIGZ1bmN0aW9uIHRvIGEgY29udGV4dCwgb3B0aW9uYWxseSBwYXJ0aWFsbHkgYXBwbHlpbmcgYW55CiAgLy8gYXJndW1lbnRzLgogIHByb3h5OiBmdW5jdGlvbiggZm4sIGNvbnRleHQgKSB7CiAgICB2YXIgdG1wLCBhcmdzLCBwcm94eTsKCiAgICBpZiAoIHR5cGVvZiBjb250ZXh0ID09PSAic3RyaW5nIiApIHsKICAgICAgdG1wID0gZm5bIGNvbnRleHQgXTsKICAgICAgY29udGV4dCA9IGZuOwogICAgICBmbiA9IHRtcDsKICAgIH0KCiAgICAvLyBRdWljayBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGFyZ2V0IGlzIGNhbGxhYmxlLCBpbiB0aGUgc3BlYwogICAgLy8gdGhpcyB0aHJvd3MgYSBUeXBlRXJyb3IsIGJ1dCB3ZSB3aWxsIGp1c3QgcmV0dXJuIHVuZGVmaW5lZC4KICAgIGlmICggIWpRdWVyeS5pc0Z1bmN0aW9uKCBmbiApICkgewogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQoKICAgIC8vIFNpbXVsYXRlZCBiaW5kCiAgICBhcmdzID0gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMsIDIgKTsKICAgIHByb3h5ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmbi5hcHBseSggY29udGV4dCB8fCB0aGlzLCBhcmdzLmNvbmNhdCggY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSApICk7CiAgICB9OwoKICAgIC8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAogICAgcHJveHkuZ3VpZCA9IGZuLmd1aWQgPSBmbi5ndWlkIHx8IGpRdWVyeS5ndWlkKys7CgogICAgcmV0dXJuIHByb3h5OwogIH0sCgogIC8vIE11bHRpZnVuY3Rpb25hbCBtZXRob2QgdG8gZ2V0IGFuZCBzZXQgdmFsdWVzIG9mIGEgY29sbGVjdGlvbgogIC8vIFRoZSB2YWx1ZS9zIGNhbiBvcHRpb25hbGx5IGJlIGV4ZWN1dGVkIGlmIGl0J3MgYSBmdW5jdGlvbgogIGFjY2VzczogZnVuY3Rpb24oIGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcmF3ICkgewogICAgdmFyIGkgPSAwLAogICAgICBsZW5ndGggPSBlbGVtcy5sZW5ndGgsCiAgICAgIGJ1bGsgPSBrZXkgPT0gbnVsbDsKCiAgICAvLyBTZXRzIG1hbnkgdmFsdWVzCiAgICBpZiAoIGpRdWVyeS50eXBlKCBrZXkgKSA9PT0gIm9iamVjdCIgKSB7CiAgICAgIGNoYWluYWJsZSA9IHRydWU7CiAgICAgIGZvciAoIGkgaW4ga2V5ICkgewogICAgICAgIGpRdWVyeS5hY2Nlc3MoIGVsZW1zLCBmbiwgaSwga2V5W2ldLCB0cnVlLCBlbXB0eUdldCwgcmF3ICk7CiAgICAgIH0KCiAgICAvLyBTZXRzIG9uZSB2YWx1ZQogICAgfSBlbHNlIGlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKICAgICAgY2hhaW5hYmxlID0gdHJ1ZTsKCiAgICAgIGlmICggIWpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewogICAgICAgIHJhdyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICggYnVsayApIHsKICAgICAgICAvLyBCdWxrIG9wZXJhdGlvbnMgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKICAgICAgICBpZiAoIHJhdyApIHsKICAgICAgICAgIGZuLmNhbGwoIGVsZW1zLCB2YWx1ZSApOwogICAgICAgICAgZm4gPSBudWxsOwoKICAgICAgICAvLyAuLi5leGNlcHQgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJ1bGsgPSBmbjsKICAgICAgICAgIGZuID0gZnVuY3Rpb24oIGVsZW0sIGtleSwgdmFsdWUgKSB7CiAgICAgICAgICAgIHJldHVybiBidWxrLmNhbGwoIGpRdWVyeSggZWxlbSApLCB2YWx1ZSApOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICggZm4gKSB7CiAgICAgICAgZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICBmbiggZWxlbXNbaV0sIGtleSwgcmF3ID8gdmFsdWUgOiB2YWx1ZS5jYWxsKCBlbGVtc1tpXSwgaSwgZm4oIGVsZW1zW2ldLCBrZXkgKSApICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNoYWluYWJsZSA/CiAgICAgIGVsZW1zIDoKCiAgICAgIC8vIEdldHMKICAgICAgYnVsayA/CiAgICAgICAgZm4uY2FsbCggZWxlbXMgKSA6CiAgICAgICAgbGVuZ3RoID8gZm4oIGVsZW1zWzBdLCBrZXkgKSA6IGVtcHR5R2V0OwogIH0sCgogIG5vdzogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwogIH0KfSk7CgpqUXVlcnkucmVhZHkucHJvbWlzZSA9IGZ1bmN0aW9uKCBvYmogKSB7CiAgaWYgKCAhcmVhZHlMaXN0ICkgewoKICAgIHJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOwoKICAgIC8vIENhdGNoIGNhc2VzIHdoZXJlICQoZG9jdW1lbnQpLnJlYWR5KCkgaXMgY2FsbGVkIGFmdGVyIHRoZSBicm93c2VyIGV2ZW50IGhhcyBhbHJlYWR5IG9jY3VycmVkLgogICAgLy8gd2Ugb25jZSB0cmllZCB0byB1c2UgcmVhZHlTdGF0ZSAiaW50ZXJhY3RpdmUiIGhlcmUsIGJ1dCBpdCBjYXVzZWQgaXNzdWVzIGxpa2UgdGhlIG9uZQogICAgLy8gZGlzY292ZXJlZCBieSBDaHJpc1MgaGVyZTogaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIyODIjY29tbWVudDoxNQogICAgaWYgKCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewogICAgICAvLyBIYW5kbGUgaXQgYXN5bmNocm9ub3VzbHkgdG8gYWxsb3cgc2NyaXB0cyB0aGUgb3Bwb3J0dW5pdHkgdG8gZGVsYXkgcmVhZHkKICAgICAgc2V0VGltZW91dCggalF1ZXJ5LnJlYWR5ICk7CgogICAgLy8gU3RhbmRhcmRzLWJhc2VkIGJyb3dzZXJzIHN1cHBvcnQgRE9NQ29udGVudExvYWRlZAogICAgfSBlbHNlIGlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKICAgICAgLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIERPTUNvbnRlbnRMb2FkZWQsIGZhbHNlICk7CgogICAgICAvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggImxvYWQiLCBqUXVlcnkucmVhZHksIGZhbHNlICk7CgogICAgLy8gSWYgSUUgZXZlbnQgbW9kZWwgaXMgdXNlZAogICAgfSBlbHNlIHsKICAgICAgLy8gRW5zdXJlIGZpcmluZyBiZWZvcmUgb25sb2FkLCBtYXliZSBsYXRlIGJ1dCBzYWZlIGFsc28gZm9yIGlmcmFtZXMKICAgICAgZG9jdW1lbnQuYXR0YWNoRXZlbnQoICJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBET01Db250ZW50TG9hZGVkICk7CgogICAgICAvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawogICAgICB3aW5kb3cuYXR0YWNoRXZlbnQoICJvbmxvYWQiLCBqUXVlcnkucmVhZHkgKTsKCiAgICAgIC8vIElmIElFIGFuZCBub3QgYSBmcmFtZQogICAgICAvLyBjb250aW51YWxseSBjaGVjayB0byBzZWUgaWYgdGhlIGRvY3VtZW50IGlzIHJlYWR5CiAgICAgIHZhciB0b3AgPSBmYWxzZTsKCiAgICAgIHRyeSB7CiAgICAgICAgdG9wID0gd2luZG93LmZyYW1lRWxlbWVudCA9PSBudWxsICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAgICAgfSBjYXRjaChlKSB7fQoKICAgICAgaWYgKCB0b3AgJiYgdG9wLmRvU2Nyb2xsICkgewogICAgICAgIChmdW5jdGlvbiBkb1Njcm9sbENoZWNrKCkgewogICAgICAgICAgaWYgKCAhalF1ZXJ5LmlzUmVhZHkgKSB7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIC8vIFVzZSB0aGUgdHJpY2sgYnkgRGllZ28gUGVyaW5pCiAgICAgICAgICAgICAgLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KICAgICAgICAgICAgICB0b3AuZG9TY3JvbGwoImxlZnQiKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoIGRvU2Nyb2xsQ2hlY2ssIDUwICk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGFuZCBleGVjdXRlIGFueSB3YWl0aW5nIGZ1bmN0aW9ucwogICAgICAgICAgICBqUXVlcnkucmVhZHkoKTsKICAgICAgICAgIH0KICAgICAgICB9KSgpOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiByZWFkeUxpc3QucHJvbWlzZSggb2JqICk7Cn07CgovLyBQb3B1bGF0ZSB0aGUgY2xhc3MydHlwZSBtYXAKalF1ZXJ5LmVhY2goIkJvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QgRXJyb3IiLnNwbGl0KCIgIiksIGZ1bmN0aW9uKGksIG5hbWUpIHsKICBjbGFzczJ0eXBlWyAiW29iamVjdCAiICsgbmFtZSArICJdIiBdID0gbmFtZS50b0xvd2VyQ2FzZSgpOwp9KTsKCmZ1bmN0aW9uIGlzQXJyYXlsaWtlKCBvYmogKSB7CiAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGgsCiAgICB0eXBlID0galF1ZXJ5LnR5cGUoIG9iaiApOwoKICBpZiAoIGpRdWVyeS5pc1dpbmRvdyggb2JqICkgKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBpZiAoIG9iai5ub2RlVHlwZSA9PT0gMSAmJiBsZW5ndGggKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIHJldHVybiB0eXBlID09PSAiYXJyYXkiIHx8IHR5cGUgIT09ICJmdW5jdGlvbiIgJiYKICAgICggbGVuZ3RoID09PSAwIHx8CiAgICB0eXBlb2YgbGVuZ3RoID09PSAibnVtYmVyIiAmJiBsZW5ndGggPiAwICYmICggbGVuZ3RoIC0gMSApIGluIG9iaiApOwp9CgovLyBBbGwgalF1ZXJ5IG9iamVjdHMgc2hvdWxkIHBvaW50IGJhY2sgdG8gdGhlc2UKcm9vdGpRdWVyeSA9IGpRdWVyeShkb2N1bWVudCk7Ci8vIFN0cmluZyB0byBPYmplY3Qgb3B0aW9ucyBmb3JtYXQgY2FjaGUKdmFyIG9wdGlvbnNDYWNoZSA9IHt9OwoKLy8gQ29udmVydCBTdHJpbmctZm9ybWF0dGVkIG9wdGlvbnMgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMgYW5kIHN0b3JlIGluIGNhY2hlCmZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSB7CiAgdmFyIG9iamVjdCA9IG9wdGlvbnNDYWNoZVsgb3B0aW9ucyBdID0ge307CiAgalF1ZXJ5LmVhY2goIG9wdGlvbnMubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgW10sIGZ1bmN0aW9uKCBfLCBmbGFnICkgewogICAgb2JqZWN0WyBmbGFnIF0gPSB0cnVlOwogIH0pOwogIHJldHVybiBvYmplY3Q7Cn0KCi8qCiAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogKgogKiAgb3B0aW9uczogYW4gb3B0aW9uYWwgbGlzdCBvZiBzcGFjZS1zZXBhcmF0ZWQgb3B0aW9ucyB0aGF0IHdpbGwgY2hhbmdlIGhvdwogKiAgICAgIHRoZSBjYWxsYmFjayBsaXN0IGJlaGF2ZXMgb3IgYSBtb3JlIHRyYWRpdGlvbmFsIG9wdGlvbiBvYmplY3QKICoKICogQnkgZGVmYXVsdCBhIGNhbGxiYWNrIGxpc3Qgd2lsbCBhY3QgbGlrZSBhbiBldmVudCBjYWxsYmFjayBsaXN0IGFuZCBjYW4gYmUKICogImZpcmVkIiBtdWx0aXBsZSB0aW1lcy4KICoKICogUG9zc2libGUgb3B0aW9uczoKICoKICogIG9uY2U6ICAgICB3aWxsIGVuc3VyZSB0aGUgY2FsbGJhY2sgbGlzdCBjYW4gb25seSBiZSBmaXJlZCBvbmNlIChsaWtlIGEgRGVmZXJyZWQpCiAqCiAqICBtZW1vcnk6ICAgICB3aWxsIGtlZXAgdHJhY2sgb2YgcHJldmlvdXMgdmFsdWVzIGFuZCB3aWxsIGNhbGwgYW55IGNhbGxiYWNrIGFkZGVkCiAqICAgICAgICAgIGFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAqICAgICAgICAgIHZhbHVlcyAobGlrZSBhIERlZmVycmVkKQogKgogKiAgdW5pcXVlOiAgICAgd2lsbCBlbnN1cmUgYSBjYWxsYmFjayBjYW4gb25seSBiZSBhZGRlZCBvbmNlIChubyBkdXBsaWNhdGUgaW4gdGhlIGxpc3QpCiAqCiAqICBzdG9wT25GYWxzZTogIGludGVycnVwdCBjYWxsaW5ncyB3aGVuIGEgY2FsbGJhY2sgcmV0dXJucyBmYWxzZQogKgogKi8KalF1ZXJ5LkNhbGxiYWNrcyA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKICAvLyBDb252ZXJ0IG9wdGlvbnMgZnJvbSBTdHJpbmctZm9ybWF0dGVkIHRvIE9iamVjdC1mb3JtYXR0ZWQgaWYgbmVlZGVkCiAgLy8gKHdlIGNoZWNrIGluIGNhY2hlIGZpcnN0KQogIG9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgPwogICAgKCBvcHRpb25zQ2FjaGVbIG9wdGlvbnMgXSB8fCBjcmVhdGVPcHRpb25zKCBvcHRpb25zICkgKSA6CiAgICBqUXVlcnkuZXh0ZW5kKCB7fSwgb3B0aW9ucyApOwoKICB2YXIgLy8gTGFzdCBmaXJlIHZhbHVlIChmb3Igbm9uLWZvcmdldHRhYmxlIGxpc3RzKQogICAgbWVtb3J5LAogICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3Qgd2FzIGFscmVhZHkgZmlyZWQKICAgIGZpcmVkLAogICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3QgaXMgY3VycmVudGx5IGZpcmluZwogICAgZmlyaW5nLAogICAgLy8gRmlyc3QgY2FsbGJhY2sgdG8gZmlyZSAodXNlZCBpbnRlcm5hbGx5IGJ5IGFkZCBhbmQgZmlyZVdpdGgpCiAgICBmaXJpbmdTdGFydCwKICAgIC8vIEVuZCBvZiB0aGUgbG9vcCB3aGVuIGZpcmluZwogICAgZmlyaW5nTGVuZ3RoLAogICAgLy8gSW5kZXggb2YgY3VycmVudGx5IGZpcmluZyBjYWxsYmFjayAobW9kaWZpZWQgYnkgcmVtb3ZlIGlmIG5lZWRlZCkKICAgIGZpcmluZ0luZGV4LAogICAgLy8gQWN0dWFsIGNhbGxiYWNrIGxpc3QKICAgIGxpc3QgPSBbXSwKICAgIC8vIFN0YWNrIG9mIGZpcmUgY2FsbHMgZm9yIHJlcGVhdGFibGUgbGlzdHMKICAgIHN0YWNrID0gIW9wdGlvbnMub25jZSAmJiBbXSwKICAgIC8vIEZpcmUgY2FsbGJhY2tzCiAgICBmaXJlID0gZnVuY3Rpb24oIGRhdGEgKSB7CiAgICAgIG1lbW9yeSA9IG9wdGlvbnMubWVtb3J5ICYmIGRhdGE7CiAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgZmlyaW5nSW5kZXggPSBmaXJpbmdTdGFydCB8fCAwOwogICAgICBmaXJpbmdTdGFydCA9IDA7CiAgICAgIGZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwogICAgICBmaXJpbmcgPSB0cnVlOwogICAgICBmb3IgKCA7IGxpc3QgJiYgZmlyaW5nSW5kZXggPCBmaXJpbmdMZW5ndGg7IGZpcmluZ0luZGV4KysgKSB7CiAgICAgICAgaWYgKCBsaXN0WyBmaXJpbmdJbmRleCBdLmFwcGx5KCBkYXRhWyAwIF0sIGRhdGFbIDEgXSApID09PSBmYWxzZSAmJiBvcHRpb25zLnN0b3BPbkZhbHNlICkgewogICAgICAgICAgbWVtb3J5ID0gZmFsc2U7IC8vIFRvIHByZXZlbnQgZnVydGhlciBjYWxscyB1c2luZyBhZGQKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBmaXJpbmcgPSBmYWxzZTsKICAgICAgaWYgKCBsaXN0ICkgewogICAgICAgIGlmICggc3RhY2sgKSB7CiAgICAgICAgICBpZiAoIHN0YWNrLmxlbmd0aCApIHsKICAgICAgICAgICAgZmlyZSggc3RhY2suc2hpZnQoKSApOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIG1lbW9yeSApIHsKICAgICAgICAgIGxpc3QgPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5kaXNhYmxlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gQWN0dWFsIENhbGxiYWNrcyBvYmplY3QKICAgIHNlbGYgPSB7CiAgICAgIC8vIEFkZCBhIGNhbGxiYWNrIG9yIGEgY29sbGVjdGlvbiBvZiBjYWxsYmFja3MgdG8gdGhlIGxpc3QKICAgICAgYWRkOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIGxpc3QgKSB7CiAgICAgICAgICAvLyBGaXJzdCwgd2Ugc2F2ZSB0aGUgY3VycmVudCBsZW5ndGgKICAgICAgICAgIHZhciBzdGFydCA9IGxpc3QubGVuZ3RoOwogICAgICAgICAgKGZ1bmN0aW9uIGFkZCggYXJncyApIHsKICAgICAgICAgICAgalF1ZXJ5LmVhY2goIGFyZ3MsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBqUXVlcnkudHlwZSggYXJnICk7CiAgICAgICAgICAgICAgaWYgKCB0eXBlID09PSAiZnVuY3Rpb24iICkgewogICAgICAgICAgICAgICAgaWYgKCAhb3B0aW9ucy51bmlxdWUgfHwgIXNlbGYuaGFzKCBhcmcgKSApIHsKICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKCBhcmcgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBhcmcgJiYgYXJnLmxlbmd0aCAmJiB0eXBlICE9PSAic3RyaW5nIiApIHsKICAgICAgICAgICAgICAgIC8vIEluc3BlY3QgcmVjdXJzaXZlbHkKICAgICAgICAgICAgICAgIGFkZCggYXJnICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pKCBhcmd1bWVudHMgKTsKICAgICAgICAgIC8vIERvIHdlIG5lZWQgdG8gYWRkIHRoZSBjYWxsYmFja3MgdG8gdGhlCiAgICAgICAgICAvLyBjdXJyZW50IGZpcmluZyBiYXRjaD8KICAgICAgICAgIGlmICggZmlyaW5nICkgewogICAgICAgICAgICBmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsKICAgICAgICAgIC8vIFdpdGggbWVtb3J5LCBpZiB3ZSdyZSBub3QgZmlyaW5nIHRoZW4KICAgICAgICAgIC8vIHdlIHNob3VsZCBjYWxsIHJpZ2h0IGF3YXkKICAgICAgICAgIH0gZWxzZSBpZiAoIG1lbW9yeSApIHsKICAgICAgICAgICAgZmlyaW5nU3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgZmlyZSggbWVtb3J5ICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBSZW1vdmUgYSBjYWxsYmFjayBmcm9tIHRoZSBsaXN0CiAgICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCBsaXN0ICkgewogICAgICAgICAgalF1ZXJ5LmVhY2goIGFyZ3VtZW50cywgZnVuY3Rpb24oIF8sIGFyZyApIHsKICAgICAgICAgICAgdmFyIGluZGV4OwogICAgICAgICAgICB3aGlsZSggKCBpbmRleCA9IGpRdWVyeS5pbkFycmF5KCBhcmcsIGxpc3QsIGluZGV4ICkgKSA+IC0xICkgewogICAgICAgICAgICAgIGxpc3Quc3BsaWNlKCBpbmRleCwgMSApOwogICAgICAgICAgICAgIC8vIEhhbmRsZSBmaXJpbmcgaW5kZXhlcwogICAgICAgICAgICAgIGlmICggZmlyaW5nICkgewogICAgICAgICAgICAgICAgaWYgKCBpbmRleCA8PSBmaXJpbmdMZW5ndGggKSB7CiAgICAgICAgICAgICAgICAgIGZpcmluZ0xlbmd0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCBpbmRleCA8PSBmaXJpbmdJbmRleCApIHsKICAgICAgICAgICAgICAgICAgZmlyaW5nSW5kZXgtLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gQ29udHJvbCBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0CiAgICAgIGhhczogZnVuY3Rpb24oIGZuICkgewogICAgICAgIHJldHVybiBqUXVlcnkuaW5BcnJheSggZm4sIGxpc3QgKSA+IC0xOwogICAgICB9LAogICAgICAvLyBSZW1vdmUgYWxsIGNhbGxiYWNrcyBmcm9tIHRoZSBsaXN0CiAgICAgIGVtcHR5OiBmdW5jdGlvbigpIHsKICAgICAgICBsaXN0ID0gW107CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0sCiAgICAgIC8vIEhhdmUgdGhlIGxpc3QgZG8gbm90aGluZyBhbnltb3JlCiAgICAgIGRpc2FibGU6IGZ1bmN0aW9uKCkgewogICAgICAgIGxpc3QgPSBzdGFjayA9IG1lbW9yeSA9IHVuZGVmaW5lZDsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gSXMgaXQgZGlzYWJsZWQ/CiAgICAgIGRpc2FibGVkOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gIWxpc3Q7CiAgICAgIH0sCiAgICAgIC8vIExvY2sgdGhlIGxpc3QgaW4gaXRzIGN1cnJlbnQgc3RhdGUKICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgc3RhY2sgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKCAhbWVtb3J5ICkgewogICAgICAgICAgc2VsZi5kaXNhYmxlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBJcyBpdCBsb2NrZWQ/CiAgICAgIGxvY2tlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICFzdGFjazsKICAgICAgfSwKICAgICAgLy8gQ2FsbCBhbGwgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGNvbnRleHQgYW5kIGFyZ3VtZW50cwogICAgICBmaXJlV2l0aDogZnVuY3Rpb24oIGNvbnRleHQsIGFyZ3MgKSB7CiAgICAgICAgYXJncyA9IGFyZ3MgfHwgW107CiAgICAgICAgYXJncyA9IFsgY29udGV4dCwgYXJncy5zbGljZSA/IGFyZ3Muc2xpY2UoKSA6IGFyZ3MgXTsKICAgICAgICBpZiAoIGxpc3QgJiYgKCAhZmlyZWQgfHwgc3RhY2sgKSApIHsKICAgICAgICAgIGlmICggZmlyaW5nICkgewogICAgICAgICAgICBzdGFjay5wdXNoKCBhcmdzICk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmaXJlKCBhcmdzICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBDYWxsIGFsbCB0aGUgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cwogICAgICBmaXJlOiBmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLmZpcmVXaXRoKCB0aGlzLCBhcmd1bWVudHMgKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gVG8ga25vdyBpZiB0aGUgY2FsbGJhY2tzIGhhdmUgYWxyZWFkeSBiZWVuIGNhbGxlZCBhdCBsZWFzdCBvbmNlCiAgICAgIGZpcmVkOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gISFmaXJlZDsKICAgICAgfQogICAgfTsKCiAgcmV0dXJuIHNlbGY7Cn07CmpRdWVyeS5leHRlbmQoewoKICBEZWZlcnJlZDogZnVuY3Rpb24oIGZ1bmMgKSB7CiAgICB2YXIgdHVwbGVzID0gWwogICAgICAgIC8vIGFjdGlvbiwgYWRkIGxpc3RlbmVyLCBsaXN0ZW5lciBsaXN0LCBmaW5hbCBzdGF0ZQogICAgICAgIFsgInJlc29sdmUiLCAiZG9uZSIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZXNvbHZlZCIgXSwKICAgICAgICBbICJyZWplY3QiLCAiZmFpbCIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZWplY3RlZCIgXSwKICAgICAgICBbICJub3RpZnkiLCAicHJvZ3Jlc3MiLCBqUXVlcnkuQ2FsbGJhY2tzKCJtZW1vcnkiKSBdCiAgICAgIF0sCiAgICAgIHN0YXRlID0gInBlbmRpbmciLAogICAgICBwcm9taXNlID0gewogICAgICAgIHN0YXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICB9LAogICAgICAgIGFsd2F5czogZnVuY3Rpb24oKSB7CiAgICAgICAgICBkZWZlcnJlZC5kb25lKCBhcmd1bWVudHMgKS5mYWlsKCBhcmd1bWVudHMgKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgdGhlbjogZnVuY3Rpb24oIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovICkgewogICAgICAgICAgdmFyIGZucyA9IGFyZ3VtZW50czsKICAgICAgICAgIHJldHVybiBqUXVlcnkuRGVmZXJyZWQoZnVuY3Rpb24oIG5ld0RlZmVyICkgewogICAgICAgICAgICBqUXVlcnkuZWFjaCggdHVwbGVzLCBmdW5jdGlvbiggaSwgdHVwbGUgKSB7CiAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHR1cGxlWyAwIF0sCiAgICAgICAgICAgICAgICBmbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCBmbnNbIGkgXSApICYmIGZuc1sgaSBdOwogICAgICAgICAgICAgIC8vIGRlZmVycmVkWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gZm9yIGZvcndhcmRpbmcgYWN0aW9ucyB0byBuZXdEZWZlcgogICAgICAgICAgICAgIGRlZmVycmVkWyB0dXBsZVsxXSBdKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHJldHVybmVkID0gZm4gJiYgZm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogICAgICAgICAgICAgICAgaWYgKCByZXR1cm5lZCAmJiBqUXVlcnkuaXNGdW5jdGlvbiggcmV0dXJuZWQucHJvbWlzZSApICkgewogICAgICAgICAgICAgICAgICByZXR1cm5lZC5wcm9taXNlKCkKICAgICAgICAgICAgICAgICAgICAuZG9uZSggbmV3RGVmZXIucmVzb2x2ZSApCiAgICAgICAgICAgICAgICAgICAgLmZhaWwoIG5ld0RlZmVyLnJlamVjdCApCiAgICAgICAgICAgICAgICAgICAgLnByb2dyZXNzKCBuZXdEZWZlci5ub3RpZnkgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0RlZmVyWyBhY3Rpb24gKyAiV2l0aCIgXSggdGhpcyA9PT0gcHJvbWlzZSA/IG5ld0RlZmVyLnByb21pc2UoKSA6IHRoaXMsIGZuID8gWyByZXR1cm5lZCBdIDogYXJndW1lbnRzICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBmbnMgPSBudWxsOwogICAgICAgICAgfSkucHJvbWlzZSgpOwogICAgICAgIH0sCiAgICAgICAgLy8gR2V0IGEgcHJvbWlzZSBmb3IgdGhpcyBkZWZlcnJlZAogICAgICAgIC8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QKICAgICAgICBwcm9taXNlOiBmdW5jdGlvbiggb2JqICkgewogICAgICAgICAgcmV0dXJuIG9iaiAhPSBudWxsID8galF1ZXJ5LmV4dGVuZCggb2JqLCBwcm9taXNlICkgOiBwcm9taXNlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVmZXJyZWQgPSB7fTsKCiAgICAvLyBLZWVwIHBpcGUgZm9yIGJhY2stY29tcGF0CiAgICBwcm9taXNlLnBpcGUgPSBwcm9taXNlLnRoZW47CgogICAgLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcwogICAgalF1ZXJ5LmVhY2goIHR1cGxlcywgZnVuY3Rpb24oIGksIHR1cGxlICkgewogICAgICB2YXIgbGlzdCA9IHR1cGxlWyAyIF0sCiAgICAgICAgc3RhdGVTdHJpbmcgPSB0dXBsZVsgMyBdOwoKICAgICAgLy8gcHJvbWlzZVsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdID0gbGlzdC5hZGQKICAgICAgcHJvbWlzZVsgdHVwbGVbMV0gXSA9IGxpc3QuYWRkOwoKICAgICAgLy8gSGFuZGxlIHN0YXRlCiAgICAgIGlmICggc3RhdGVTdHJpbmcgKSB7CiAgICAgICAgbGlzdC5hZGQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBzdGF0ZSA9IFsgcmVzb2x2ZWQgfCByZWplY3RlZCBdCiAgICAgICAgICBzdGF0ZSA9IHN0YXRlU3RyaW5nOwoKICAgICAgICAvLyBbIHJlamVjdF9saXN0IHwgcmVzb2x2ZV9saXN0IF0uZGlzYWJsZTsgcHJvZ3Jlc3NfbGlzdC5sb2NrCiAgICAgICAgfSwgdHVwbGVzWyBpIF4gMSBdWyAyIF0uZGlzYWJsZSwgdHVwbGVzWyAyIF1bIDIgXS5sb2NrICk7CiAgICAgIH0KCiAgICAgIC8vIGRlZmVycmVkWyByZXNvbHZlIHwgcmVqZWN0IHwgbm90aWZ5IF0KICAgICAgZGVmZXJyZWRbIHR1cGxlWzBdIF0gPSBmdW5jdGlvbigpIHsKICAgICAgICBkZWZlcnJlZFsgdHVwbGVbMF0gKyAiV2l0aCIgXSggdGhpcyA9PT0gZGVmZXJyZWQgPyBwcm9taXNlIDogdGhpcywgYXJndW1lbnRzICk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH07CiAgICAgIGRlZmVycmVkWyB0dXBsZVswXSArICJXaXRoIiBdID0gbGlzdC5maXJlV2l0aDsKICAgIH0pOwoKICAgIC8vIE1ha2UgdGhlIGRlZmVycmVkIGEgcHJvbWlzZQogICAgcHJvbWlzZS5wcm9taXNlKCBkZWZlcnJlZCApOwoKICAgIC8vIENhbGwgZ2l2ZW4gZnVuYyBpZiBhbnkKICAgIGlmICggZnVuYyApIHsKICAgICAgZnVuYy5jYWxsKCBkZWZlcnJlZCwgZGVmZXJyZWQgKTsKICAgIH0KCiAgICAvLyBBbGwgZG9uZSEKICAgIHJldHVybiBkZWZlcnJlZDsKICB9LAoKICAvLyBEZWZlcnJlZCBoZWxwZXIKICB3aGVuOiBmdW5jdGlvbiggc3Vib3JkaW5hdGUgLyogLCAuLi4sIHN1Ym9yZGluYXRlTiAqLyApIHsKICAgIHZhciBpID0gMCwKICAgICAgcmVzb2x2ZVZhbHVlcyA9IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICksCiAgICAgIGxlbmd0aCA9IHJlc29sdmVWYWx1ZXMubGVuZ3RoLAoKICAgICAgLy8gdGhlIGNvdW50IG9mIHVuY29tcGxldGVkIHN1Ym9yZGluYXRlcwogICAgICByZW1haW5pbmcgPSBsZW5ndGggIT09IDEgfHwgKCBzdWJvcmRpbmF0ZSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggc3Vib3JkaW5hdGUucHJvbWlzZSApICkgPyBsZW5ndGggOiAwLAoKICAgICAgLy8gdGhlIG1hc3RlciBEZWZlcnJlZC4gSWYgcmVzb2x2ZVZhbHVlcyBjb25zaXN0IG9mIG9ubHkgYSBzaW5nbGUgRGVmZXJyZWQsIGp1c3QgdXNlIHRoYXQuCiAgICAgIGRlZmVycmVkID0gcmVtYWluaW5nID09PSAxID8gc3Vib3JkaW5hdGUgOiBqUXVlcnkuRGVmZXJyZWQoKSwKCiAgICAgIC8vIFVwZGF0ZSBmdW5jdGlvbiBmb3IgYm90aCByZXNvbHZlIGFuZCBwcm9ncmVzcyB2YWx1ZXMKICAgICAgdXBkYXRlRnVuYyA9IGZ1bmN0aW9uKCBpLCBjb250ZXh0cywgdmFsdWVzICkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiggdmFsdWUgKSB7CiAgICAgICAgICBjb250ZXh0c1sgaSBdID0gdGhpczsKICAgICAgICAgIHZhbHVlc1sgaSBdID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBjb3JlX3NsaWNlLmNhbGwoIGFyZ3VtZW50cyApIDogdmFsdWU7CiAgICAgICAgICBpZiggdmFsdWVzID09PSBwcm9ncmVzc1ZhbHVlcyApIHsKICAgICAgICAgICAgZGVmZXJyZWQubm90aWZ5V2l0aCggY29udGV4dHMsIHZhbHVlcyApOwogICAgICAgICAgfSBlbHNlIGlmICggISggLS1yZW1haW5pbmcgKSApIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNvbnRleHRzLCB2YWx1ZXMgKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9LAoKICAgICAgcHJvZ3Jlc3NWYWx1ZXMsIHByb2dyZXNzQ29udGV4dHMsIHJlc29sdmVDb250ZXh0czsKCiAgICAvLyBhZGQgbGlzdGVuZXJzIHRvIERlZmVycmVkIHN1Ym9yZGluYXRlczsgdHJlYXQgb3RoZXJzIGFzIHJlc29sdmVkCiAgICBpZiAoIGxlbmd0aCA+IDEgKSB7CiAgICAgIHByb2dyZXNzVmFsdWVzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKICAgICAgcHJvZ3Jlc3NDb250ZXh0cyA9IG5ldyBBcnJheSggbGVuZ3RoICk7CiAgICAgIHJlc29sdmVDb250ZXh0cyA9IG5ldyBBcnJheSggbGVuZ3RoICk7CiAgICAgIGZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewogICAgICAgIGlmICggcmVzb2x2ZVZhbHVlc1sgaSBdICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCByZXNvbHZlVmFsdWVzWyBpIF0ucHJvbWlzZSApICkgewogICAgICAgICAgcmVzb2x2ZVZhbHVlc1sgaSBdLnByb21pc2UoKQogICAgICAgICAgICAuZG9uZSggdXBkYXRlRnVuYyggaSwgcmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzICkgKQogICAgICAgICAgICAuZmFpbCggZGVmZXJyZWQucmVqZWN0ICkKICAgICAgICAgICAgLnByb2dyZXNzKCB1cGRhdGVGdW5jKCBpLCBwcm9ncmVzc0NvbnRleHRzLCBwcm9ncmVzc1ZhbHVlcyApICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC0tcmVtYWluaW5nOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIGlmIHdlJ3JlIG5vdCB3YWl0aW5nIG9uIGFueXRoaW5nLCByZXNvbHZlIHRoZSBtYXN0ZXIKICAgIGlmICggIXJlbWFpbmluZyApIHsKICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoIHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcyApOwogICAgfQoKICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CiAgfQp9KTsKalF1ZXJ5LnN1cHBvcnQgPSAoZnVuY3Rpb24oKSB7CgogIHZhciBzdXBwb3J0LCBhbGwsIGEsIHNlbGVjdCwgb3B0LCBpbnB1dCwgZnJhZ21lbnQsIGV2ZW50TmFtZSwgaXNTdXBwb3J0ZWQsIGksCiAgICBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgLy8gU2V0dXAKICBkaXYuc2V0QXR0cmlidXRlKCAiY2xhc3NOYW1lIiwgInQiICk7CiAgZGl2LmlubmVySFRNTCA9ICIgIDxsaW5rLz48dGFibGU+PC90YWJsZT48YSBocmVmPScvYSc+YTwvYT48aW5wdXQgdHlwZT0nY2hlY2tib3gnLz4iOwoKICAvLyBTdXBwb3J0IHRlc3RzIHdvbid0IHJ1biBpbiBzb21lIGxpbWl0ZWQgb3Igbm9uLWJyb3dzZXIgZW52aXJvbm1lbnRzCiAgYWxsID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIik7CiAgYSA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYSIpWyAwIF07CiAgaWYgKCAhYWxsIHx8ICFhIHx8ICFhbGwubGVuZ3RoICkgewogICAgcmV0dXJuIHt9OwogIH0KCiAgLy8gRmlyc3QgYmF0Y2ggb2YgdGVzdHMKICBzZWxlY3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzZWxlY3QiKTsKICBvcHQgPSBzZWxlY3QuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpICk7CiAgaW5wdXQgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImlucHV0IilbIDAgXTsKCiAgYS5zdHlsZS5jc3NUZXh0ID0gInRvcDoxcHg7ZmxvYXQ6bGVmdDtvcGFjaXR5Oi41IjsKICBzdXBwb3J0ID0gewogICAgLy8gVGVzdCBzZXRBdHRyaWJ1dGUgb24gY2FtZWxDYXNlIGNsYXNzLiBJZiBpdCB3b3Jrcywgd2UgbmVlZCBhdHRyRml4ZXMgd2hlbiBkb2luZyBnZXQvc2V0QXR0cmlidXRlIChpZTYvNykKICAgIGdldFNldEF0dHJpYnV0ZTogZGl2LmNsYXNzTmFtZSAhPT0gInQiLAoKICAgIC8vIElFIHN0cmlwcyBsZWFkaW5nIHdoaXRlc3BhY2Ugd2hlbiAuaW5uZXJIVE1MIGlzIHVzZWQKICAgIGxlYWRpbmdXaGl0ZXNwYWNlOiBkaXYuZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gMywKCiAgICAvLyBNYWtlIHN1cmUgdGhhdCB0Ym9keSBlbGVtZW50cyBhcmVuJ3QgYXV0b21hdGljYWxseSBpbnNlcnRlZAogICAgLy8gSUUgd2lsbCBpbnNlcnQgdGhlbSBpbnRvIGVtcHR5IHRhYmxlcwogICAgdGJvZHk6ICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRib2R5IikubGVuZ3RoLAoKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGxpbmsgZWxlbWVudHMgZ2V0IHNlcmlhbGl6ZWQgY29ycmVjdGx5IGJ5IGlubmVySFRNTAogICAgLy8gVGhpcyByZXF1aXJlcyBhIHdyYXBwZXIgZWxlbWVudCBpbiBJRQogICAgaHRtbFNlcmlhbGl6ZTogISFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpbmsiKS5sZW5ndGgsCgogICAgLy8gR2V0IHRoZSBzdHlsZSBpbmZvcm1hdGlvbiBmcm9tIGdldEF0dHJpYnV0ZQogICAgLy8gKElFIHVzZXMgLmNzc1RleHQgaW5zdGVhZCkKICAgIHN0eWxlOiAvdG9wLy50ZXN0KCBhLmdldEF0dHJpYnV0ZSgic3R5bGUiKSApLAoKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IFVSTHMgYXJlbid0IG1hbmlwdWxhdGVkCiAgICAvLyAoSUUgbm9ybWFsaXplcyBpdCBieSBkZWZhdWx0KQogICAgaHJlZk5vcm1hbGl6ZWQ6IGEuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIvYSIsCgogICAgLy8gTWFrZSBzdXJlIHRoYXQgZWxlbWVudCBvcGFjaXR5IGV4aXN0cwogICAgLy8gKElFIHVzZXMgZmlsdGVyIGluc3RlYWQpCiAgICAvLyBVc2UgYSByZWdleCB0byB3b3JrIGFyb3VuZCBhIFdlYktpdCBpc3N1ZS4gU2VlICM1MTQ1CiAgICBvcGFjaXR5OiAvXjAuNS8udGVzdCggYS5zdHlsZS5vcGFjaXR5ICksCgogICAgLy8gVmVyaWZ5IHN0eWxlIGZsb2F0IGV4aXN0ZW5jZQogICAgLy8gKElFIHVzZXMgc3R5bGVGbG9hdCBpbnN0ZWFkIG9mIGNzc0Zsb2F0KQogICAgY3NzRmxvYXQ6ICEhYS5zdHlsZS5jc3NGbG9hdCwKCiAgICAvLyBDaGVjayB0aGUgZGVmYXVsdCBjaGVja2JveC9yYWRpbyB2YWx1ZSAoIiIgb24gV2ViS2l0OyAib24iIGVsc2V3aGVyZSkKICAgIGNoZWNrT246ICEhaW5wdXQudmFsdWUsCgogICAgLy8gTWFrZSBzdXJlIHRoYXQgYSBzZWxlY3RlZC1ieS1kZWZhdWx0IG9wdGlvbiBoYXMgYSB3b3JraW5nIHNlbGVjdGVkIHByb3BlcnR5LgogICAgLy8gKFdlYktpdCBkZWZhdWx0cyB0byBmYWxzZSBpbnN0ZWFkIG9mIHRydWUsIElFIHRvbywgaWYgaXQncyBpbiBhbiBvcHRncm91cCkKICAgIG9wdFNlbGVjdGVkOiBvcHQuc2VsZWN0ZWQsCgogICAgLy8gVGVzdHMgZm9yIGVuY3R5cGUgc3VwcG9ydCBvbiBhIGZvcm0gKCM2NzQzKQogICAgZW5jdHlwZTogISFkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIikuZW5jdHlwZSwKCiAgICAvLyBNYWtlcyBzdXJlIGNsb25pbmcgYW4gaHRtbDUgZWxlbWVudCBkb2VzIG5vdCBjYXVzZSBwcm9ibGVtcwogICAgLy8gV2hlcmUgb3V0ZXJIVE1MIGlzIHVuZGVmaW5lZCwgdGhpcyBzdGlsbCB3b3JrcwogICAgaHRtbDVDbG9uZTogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibmF2IikuY2xvbmVOb2RlKCB0cnVlICkub3V0ZXJIVE1MICE9PSAiPDpuYXY+PC86bmF2PiIsCgogICAgLy8galF1ZXJ5LnN1cHBvcnQuYm94TW9kZWwgREVQUkVDQVRFRCBpbiAxLjggc2luY2Ugd2UgZG9uJ3Qgc3VwcG9ydCBRdWlya3MgTW9kZQogICAgYm94TW9kZWw6IGRvY3VtZW50LmNvbXBhdE1vZGUgPT09ICJDU1MxQ29tcGF0IiwKCiAgICAvLyBXaWxsIGJlIGRlZmluZWQgbGF0ZXIKICAgIGRlbGV0ZUV4cGFuZG86IHRydWUsCiAgICBub0Nsb25lRXZlbnQ6IHRydWUsCiAgICBpbmxpbmVCbG9ja05lZWRzTGF5b3V0OiBmYWxzZSwKICAgIHNocmlua1dyYXBCbG9ja3M6IGZhbHNlLAogICAgcmVsaWFibGVNYXJnaW5SaWdodDogdHJ1ZSwKICAgIGJveFNpemluZ1JlbGlhYmxlOiB0cnVlLAogICAgcGl4ZWxQb3NpdGlvbjogZmFsc2UKICB9OwoKICAvLyBNYWtlIHN1cmUgY2hlY2tlZCBzdGF0dXMgaXMgcHJvcGVybHkgY2xvbmVkCiAgaW5wdXQuY2hlY2tlZCA9IHRydWU7CiAgc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCA9IGlucHV0LmNsb25lTm9kZSggdHJ1ZSApLmNoZWNrZWQ7CgogIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKICAvLyAoV2ViS2l0IG1hcmtzIHRoZW0gYXMgZGlzYWJsZWQpCiAgc2VsZWN0LmRpc2FibGVkID0gdHJ1ZTsKICBzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKCiAgLy8gU3VwcG9ydDogSUU8OQogIHRyeSB7CiAgICBkZWxldGUgZGl2LnRlc3Q7CiAgfSBjYXRjaCggZSApIHsKICAgIHN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9IGZhbHNlOwogIH0KCiAgLy8gQ2hlY2sgaWYgd2UgY2FuIHRydXN0IGdldEF0dHJpYnV0ZSgidmFsdWUiKQogIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICBpbnB1dC5zZXRBdHRyaWJ1dGUoICJ2YWx1ZSIsICIiICk7CiAgc3VwcG9ydC5pbnB1dCA9IGlucHV0LmdldEF0dHJpYnV0ZSggInZhbHVlIiApID09PSAiIjsKCiAgLy8gQ2hlY2sgaWYgYW4gaW5wdXQgbWFpbnRhaW5zIGl0cyB2YWx1ZSBhZnRlciBiZWNvbWluZyBhIHJhZGlvCiAgaW5wdXQudmFsdWUgPSAidCI7CiAgaW5wdXQuc2V0QXR0cmlidXRlKCAidHlwZSIsICJyYWRpbyIgKTsKICBzdXBwb3J0LnJhZGlvVmFsdWUgPSBpbnB1dC52YWx1ZSA9PT0gInQiOwoKICAvLyAjMTEyMTcgLSBXZWJLaXQgbG9zZXMgY2hlY2sgd2hlbiB0aGUgbmFtZSBpcyBhZnRlciB0aGUgY2hlY2tlZCBhdHRyaWJ1dGUKICBpbnB1dC5zZXRBdHRyaWJ1dGUoICJjaGVja2VkIiwgInQiICk7CiAgaW5wdXQuc2V0QXR0cmlidXRlKCAibmFtZSIsICJ0IiApOwoKICBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICBmcmFnbWVudC5hcHBlbmRDaGlsZCggaW5wdXQgKTsKCiAgLy8gQ2hlY2sgaWYgYSBkaXNjb25uZWN0ZWQgY2hlY2tib3ggd2lsbCByZXRhaW4gaXRzIGNoZWNrZWQKICAvLyB2YWx1ZSBvZiB0cnVlIGFmdGVyIGFwcGVuZGVkIHRvIHRoZSBET00gKElFNi83KQogIHN1cHBvcnQuYXBwZW5kQ2hlY2tlZCA9IGlucHV0LmNoZWNrZWQ7CgogIC8vIFdlYktpdCBkb2Vzbid0IGNsb25lIGNoZWNrZWQgc3RhdGUgY29ycmVjdGx5IGluIGZyYWdtZW50cwogIHN1cHBvcnQuY2hlY2tDbG9uZSA9IGZyYWdtZW50LmNsb25lTm9kZSggdHJ1ZSApLmNsb25lTm9kZSggdHJ1ZSApLmxhc3RDaGlsZC5jaGVja2VkOwoKICAvLyBTdXBwb3J0OiBJRTw5CiAgLy8gT3BlcmEgZG9lcyBub3QgY2xvbmUgZXZlbnRzIChhbmQgdHlwZW9mIGRpdi5hdHRhY2hFdmVudCA9PT0gdW5kZWZpbmVkKS4KICAvLyBJRTktMTAgY2xvbmVzIGV2ZW50cyBib3VuZCB2aWEgYXR0YWNoRXZlbnQsIGJ1dCB0aGV5IGRvbid0IHRyaWdnZXIgd2l0aCAuY2xpY2soKQogIGlmICggZGl2LmF0dGFjaEV2ZW50ICkgewogICAgZGl2LmF0dGFjaEV2ZW50KCAib25jbGljayIsIGZ1bmN0aW9uKCkgewogICAgICBzdXBwb3J0Lm5vQ2xvbmVFdmVudCA9IGZhbHNlOwogICAgfSk7CgogICAgZGl2LmNsb25lTm9kZSggdHJ1ZSApLmNsaWNrKCk7CiAgfQoKICAvLyBTdXBwb3J0OiBJRTw5IChsYWNrIHN1Ym1pdC9jaGFuZ2UgYnViYmxlKSwgRmlyZWZveCAxNysgKGxhY2sgZm9jdXNpbiBldmVudCkKICAvLyBCZXdhcmUgb2YgQ1NQIHJlc3RyaWN0aW9ucyAoaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQKSwgdGVzdC9jc3AucGhwCiAgZm9yICggaSBpbiB7IHN1Ym1pdDogdHJ1ZSwgY2hhbmdlOiB0cnVlLCBmb2N1c2luOiB0cnVlIH0pIHsKICAgIGRpdi5zZXRBdHRyaWJ1dGUoIGV2ZW50TmFtZSA9ICJvbiIgKyBpLCAidCIgKTsKCiAgICBzdXBwb3J0WyBpICsgIkJ1YmJsZXMiIF0gPSBldmVudE5hbWUgaW4gd2luZG93IHx8IGRpdi5hdHRyaWJ1dGVzWyBldmVudE5hbWUgXS5leHBhbmRvID09PSBmYWxzZTsKICB9CgogIGRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICJjb250ZW50LWJveCI7CiAgZGl2LmNsb25lTm9kZSggdHJ1ZSApLnN0eWxlLmJhY2tncm91bmRDbGlwID0gIiI7CiAgc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgPSBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPT09ICJjb250ZW50LWJveCI7CgogIC8vIFJ1biB0ZXN0cyB0aGF0IG5lZWQgYSBib2R5IGF0IGRvYyByZWFkeQogIGpRdWVyeShmdW5jdGlvbigpIHsKICAgIHZhciBjb250YWluZXIsIG1hcmdpbkRpdiwgdGRzLAogICAgICBkaXZSZXNldCA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjA7ZGlzcGxheTpibG9jaztib3gtc2l6aW5nOmNvbnRlbnQtYm94Oy1tb3otYm94LXNpemluZzpjb250ZW50LWJveDstd2Via2l0LWJveC1zaXppbmc6Y29udGVudC1ib3g7IiwKICAgICAgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF07CgogICAgaWYgKCAhYm9keSApIHsKICAgICAgLy8gUmV0dXJuIGZvciBmcmFtZXNldCBkb2NzIHRoYXQgZG9uJ3QgaGF2ZSBhIGJvZHkKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAiYm9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDtwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtsZWZ0Oi05OTk5cHg7bWFyZ2luLXRvcDoxcHgiOwoKICAgIGJvZHkuYXBwZW5kQ2hpbGQoIGNvbnRhaW5lciApLmFwcGVuZENoaWxkKCBkaXYgKTsKCiAgICAvLyBTdXBwb3J0OiBJRTgKICAgIC8vIENoZWNrIGlmIHRhYmxlIGNlbGxzIHN0aWxsIGhhdmUgb2Zmc2V0V2lkdGgvSGVpZ2h0IHdoZW4gdGhleSBhcmUgc2V0CiAgICAvLyB0byBkaXNwbGF5Om5vbmUgYW5kIHRoZXJlIGFyZSBzdGlsbCBvdGhlciB2aXNpYmxlIHRhYmxlIGNlbGxzIGluIGEKICAgIC8vIHRhYmxlIHJvdzsgaWYgc28sIG9mZnNldFdpZHRoL0hlaWdodCBhcmUgbm90IHJlbGlhYmxlIGZvciB1c2Ugd2hlbgogICAgLy8gZGV0ZXJtaW5pbmcgaWYgYW4gZWxlbWVudCBoYXMgYmVlbiBoaWRkZW4gZGlyZWN0bHkgdXNpbmcKICAgIC8vIGRpc3BsYXk6bm9uZSAoaXQgaXMgc3RpbGwgc2FmZSB0byB1c2Ugb2Zmc2V0cyBpZiBhIHBhcmVudCBlbGVtZW50IGlzCiAgICAvLyBoaWRkZW47IGRvbiBzYWZldHkgZ29nZ2xlcyBhbmQgc2VlIGJ1ZyAjNDUxMiBmb3IgbW9yZSBpbmZvcm1hdGlvbikuCiAgICBkaXYuaW5uZXJIVE1MID0gIjx0YWJsZT48dHI+PHRkPjwvdGQ+PHRkPnQ8L3RkPjwvdHI+PC90YWJsZT4iOwogICAgdGRzID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0ZCIpOwogICAgdGRzWyAwIF0uc3R5bGUuY3NzVGV4dCA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjA7ZGlzcGxheTpub25lIjsKICAgIGlzU3VwcG9ydGVkID0gKCB0ZHNbIDAgXS5vZmZzZXRIZWlnaHQgPT09IDAgKTsKCiAgICB0ZHNbIDAgXS5zdHlsZS5kaXNwbGF5ID0gIiI7CiAgICB0ZHNbIDEgXS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKICAgIC8vIFN1cHBvcnQ6IElFOAogICAgLy8gQ2hlY2sgaWYgZW1wdHkgdGFibGUgY2VsbHMgc3RpbGwgaGF2ZSBvZmZzZXRXaWR0aC9IZWlnaHQKICAgIHN1cHBvcnQucmVsaWFibGVIaWRkZW5PZmZzZXRzID0gaXNTdXBwb3J0ZWQgJiYgKCB0ZHNbIDAgXS5vZmZzZXRIZWlnaHQgPT09IDAgKTsKCiAgICAvLyBDaGVjayBib3gtc2l6aW5nIGFuZCBtYXJnaW4gYmVoYXZpb3IKICAgIGRpdi5pbm5lckhUTUwgPSAiIjsKICAgIGRpdi5zdHlsZS5jc3NUZXh0ID0gImJveC1zaXppbmc6Ym9yZGVyLWJveDstbW96LWJveC1zaXppbmc6Ym9yZGVyLWJveDstd2Via2l0LWJveC1zaXppbmc6Ym9yZGVyLWJveDtwYWRkaW5nOjFweDtib3JkZXI6MXB4O2Rpc3BsYXk6YmxvY2s7d2lkdGg6NHB4O21hcmdpbi10b3A6MSU7cG9zaXRpb246YWJzb2x1dGU7dG9wOjElOyI7CiAgICBzdXBwb3J0LmJveFNpemluZyA9ICggZGl2Lm9mZnNldFdpZHRoID09PSA0ICk7CiAgICBzdXBwb3J0LmRvZXNOb3RJbmNsdWRlTWFyZ2luSW5Cb2R5T2Zmc2V0ID0gKCBib2R5Lm9mZnNldFRvcCAhPT0gMSApOwoKICAgIC8vIFVzZSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0LgogICAgaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKICAgICAgc3VwcG9ydC5waXhlbFBvc2l0aW9uID0gKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZGl2LCBudWxsICkgfHwge30gKS50b3AgIT09ICIxJSI7CiAgICAgIHN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUgPSAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBkaXYsIG51bGwgKSB8fCB7IHdpZHRoOiAiNHB4IiB9ICkud2lkdGggPT09ICI0cHgiOwoKICAgICAgLy8gQ2hlY2sgaWYgZGl2IHdpdGggZXhwbGljaXQgd2lkdGggYW5kIG5vIG1hcmdpbi1yaWdodCBpbmNvcnJlY3RseQogICAgICAvLyBnZXRzIGNvbXB1dGVkIG1hcmdpbi1yaWdodCBiYXNlZCBvbiB3aWR0aCBvZiBjb250YWluZXIuICgjMzMzMykKICAgICAgLy8gRmFpbHMgaW4gV2ViS2l0IGJlZm9yZSBGZWIgMjAxMSBuaWdodGxpZXMKICAgICAgLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CiAgICAgIG1hcmdpbkRpdiA9IGRpdi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikgKTsKICAgICAgbWFyZ2luRGl2LnN0eWxlLmNzc1RleHQgPSBkaXYuc3R5bGUuY3NzVGV4dCA9IGRpdlJlc2V0OwogICAgICBtYXJnaW5EaXYuc3R5bGUubWFyZ2luUmlnaHQgPSBtYXJnaW5EaXYuc3R5bGUud2lkdGggPSAiMCI7CiAgICAgIGRpdi5zdHlsZS53aWR0aCA9ICIxcHgiOwoKICAgICAgc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ID0KICAgICAgICAhcGFyc2VGbG9hdCggKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggbWFyZ2luRGl2LCBudWxsICkgfHwge30gKS5tYXJnaW5SaWdodCApOwogICAgfQoKICAgIGlmICggdHlwZW9mIGRpdi5zdHlsZS56b29tICE9PSAidW5kZWZpbmVkIiApIHsKICAgICAgLy8gU3VwcG9ydDogSUU8OAogICAgICAvLyBDaGVjayBpZiBuYXRpdmVseSBibG9jay1sZXZlbCBlbGVtZW50cyBhY3QgbGlrZSBpbmxpbmUtYmxvY2sKICAgICAgLy8gZWxlbWVudHMgd2hlbiBzZXR0aW5nIHRoZWlyIGRpc3BsYXkgdG8gJ2lubGluZScgYW5kIGdpdmluZwogICAgICAvLyB0aGVtIGxheW91dAogICAgICBkaXYuaW5uZXJIVE1MID0gIiI7CiAgICAgIGRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2UmVzZXQgKyAid2lkdGg6MXB4O3BhZGRpbmc6MXB4O2Rpc3BsYXk6aW5saW5lO3pvb206MSI7CiAgICAgIHN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCA9ICggZGl2Lm9mZnNldFdpZHRoID09PSAzICk7CgogICAgICAvLyBTdXBwb3J0OiBJRTYKICAgICAgLy8gQ2hlY2sgaWYgZWxlbWVudHMgd2l0aCBsYXlvdXQgc2hyaW5rLXdyYXAgdGhlaXIgY2hpbGRyZW4KICAgICAgZGl2LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICBkaXYuaW5uZXJIVE1MID0gIjxkaXY+PC9kaXY+IjsKICAgICAgZGl2LmZpcnN0Q2hpbGQuc3R5bGUud2lkdGggPSAiNXB4IjsKICAgICAgc3VwcG9ydC5zaHJpbmtXcmFwQmxvY2tzID0gKCBkaXYub2Zmc2V0V2lkdGggIT09IDMgKTsKCiAgICAgIC8vIFByZXZlbnQgSUUgNiBmcm9tIGFmZmVjdGluZyBsYXlvdXQgZm9yIHBvc2l0aW9uZWQgZWxlbWVudHMgIzExMDQ4CiAgICAgIC8vIFByZXZlbnQgSUUgZnJvbSBzaHJpbmtpbmcgdGhlIGJvZHkgaW4gSUUgNyBtb2RlICMxMjg2OQogICAgICBib2R5LnN0eWxlLnpvb20gPSAxOwogICAgfQoKICAgIGJvZHkucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoKICAgIC8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUKICAgIGNvbnRhaW5lciA9IGRpdiA9IHRkcyA9IG1hcmdpbkRpdiA9IG51bGw7CiAgfSk7CgogIC8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUKICBhbGwgPSBzZWxlY3QgPSBmcmFnbWVudCA9IG9wdCA9IGEgPSBpbnB1dCA9IG51bGw7CgogIHJldHVybiBzdXBwb3J0Owp9KSgpOwoKdmFyIHJicmFjZSA9IC8oPzpce1tcc1xTXSpcfXxcW1tcc1xTXSpcXSkkLywKICBybXVsdGlEYXNoID0gLyhbQS1aXSkvZzsKICAKZnVuY3Rpb24gaW50ZXJuYWxEYXRhKCBlbGVtLCBuYW1lLCBkYXRhLCBwdnQgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKXsKICBpZiAoICFqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHRoaXNDYWNoZSwgcmV0LAogICAgaW50ZXJuYWxLZXkgPSBqUXVlcnkuZXhwYW5kbywKICAgIGdldEJ5TmFtZSA9IHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiwKCiAgICAvLyBXZSBoYXZlIHRvIGhhbmRsZSBET00gbm9kZXMgYW5kIEpTIG9iamVjdHMgZGlmZmVyZW50bHkgYmVjYXVzZSBJRTYtNwogICAgLy8gY2FuJ3QgR0Mgb2JqZWN0IHJlZmVyZW5jZXMgcHJvcGVybHkgYWNyb3NzIHRoZSBET00tSlMgYm91bmRhcnkKICAgIGlzTm9kZSA9IGVsZW0ubm9kZVR5cGUsCgogICAgLy8gT25seSBET00gbm9kZXMgbmVlZCB0aGUgZ2xvYmFsIGpRdWVyeSBjYWNoZTsgSlMgb2JqZWN0IGRhdGEgaXMKICAgIC8vIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSBvYmplY3Qgc28gR0MgY2FuIG9jY3VyIGF1dG9tYXRpY2FsbHkKICAgIGNhY2hlID0gaXNOb2RlID8galF1ZXJ5LmNhY2hlIDogZWxlbSwKCiAgICAvLyBPbmx5IGRlZmluaW5nIGFuIElEIGZvciBKUyBvYmplY3RzIGlmIGl0cyBjYWNoZSBhbHJlYWR5IGV4aXN0cyBhbGxvd3MKICAgIC8vIHRoZSBjb2RlIHRvIHNob3J0Y3V0IG9uIHRoZSBzYW1lIHBhdGggYXMgYSBET00gbm9kZSB3aXRoIG5vIGNhY2hlCiAgICBpZCA9IGlzTm9kZSA/IGVsZW1bIGludGVybmFsS2V5IF0gOiBlbGVtWyBpbnRlcm5hbEtleSBdICYmIGludGVybmFsS2V5OwoKICAvLyBBdm9pZCBkb2luZyBhbnkgbW9yZSB3b3JrIHRoYW4gd2UgbmVlZCB0byB3aGVuIHRyeWluZyB0byBnZXQgZGF0YSBvbiBhbgogIC8vIG9iamVjdCB0aGF0IGhhcyBubyBkYXRhIGF0IGFsbAogIGlmICggKCFpZCB8fCAhY2FjaGVbaWRdIHx8ICghcHZ0ICYmICFjYWNoZVtpZF0uZGF0YSkpICYmIGdldEJ5TmFtZSAmJiBkYXRhID09PSB1bmRlZmluZWQgKSB7CiAgICByZXR1cm47CiAgfQoKICBpZiAoICFpZCApIHsKICAgIC8vIE9ubHkgRE9NIG5vZGVzIG5lZWQgYSBuZXcgdW5pcXVlIElEIGZvciBlYWNoIGVsZW1lbnQgc2luY2UgdGhlaXIgZGF0YQogICAgLy8gZW5kcyB1cCBpbiB0aGUgZ2xvYmFsIGNhY2hlCiAgICBpZiAoIGlzTm9kZSApIHsKICAgICAgZWxlbVsgaW50ZXJuYWxLZXkgXSA9IGlkID0gY29yZV9kZWxldGVkSWRzLnBvcCgpIHx8IGpRdWVyeS5ndWlkKys7CiAgICB9IGVsc2UgewogICAgICBpZCA9IGludGVybmFsS2V5OwogICAgfQogIH0KCiAgaWYgKCAhY2FjaGVbIGlkIF0gKSB7CiAgICBjYWNoZVsgaWQgXSA9IHt9OwoKICAgIC8vIEF2b2lkcyBleHBvc2luZyBqUXVlcnkgbWV0YWRhdGEgb24gcGxhaW4gSlMgb2JqZWN0cyB3aGVuIHRoZSBvYmplY3QKICAgIC8vIGlzIHNlcmlhbGl6ZWQgdXNpbmcgSlNPTi5zdHJpbmdpZnkKICAgIGlmICggIWlzTm9kZSApIHsKICAgICAgY2FjaGVbIGlkIF0udG9KU09OID0galF1ZXJ5Lm5vb3A7CiAgICB9CiAgfQoKICAvLyBBbiBvYmplY3QgY2FuIGJlIHBhc3NlZCB0byBqUXVlcnkuZGF0YSBpbnN0ZWFkIG9mIGEga2V5L3ZhbHVlIHBhaXI7IHRoaXMgZ2V0cwogIC8vIHNoYWxsb3cgY29waWVkIG92ZXIgb250byB0aGUgZXhpc3RpbmcgY2FjaGUKICBpZiAoIHR5cGVvZiBuYW1lID09PSAib2JqZWN0IiB8fCB0eXBlb2YgbmFtZSA9PT0gImZ1bmN0aW9uIiApIHsKICAgIGlmICggcHZ0ICkgewogICAgICBjYWNoZVsgaWQgXSA9IGpRdWVyeS5leHRlbmQoIGNhY2hlWyBpZCBdLCBuYW1lICk7CiAgICB9IGVsc2UgewogICAgICBjYWNoZVsgaWQgXS5kYXRhID0galF1ZXJ5LmV4dGVuZCggY2FjaGVbIGlkIF0uZGF0YSwgbmFtZSApOwogICAgfQogIH0KCiAgdGhpc0NhY2hlID0gY2FjaGVbIGlkIF07CgogIC8vIGpRdWVyeSBkYXRhKCkgaXMgc3RvcmVkIGluIGEgc2VwYXJhdGUgb2JqZWN0IGluc2lkZSB0aGUgb2JqZWN0J3MgaW50ZXJuYWwgZGF0YQogIC8vIGNhY2hlIGluIG9yZGVyIHRvIGF2b2lkIGtleSBjb2xsaXNpb25zIGJldHdlZW4gaW50ZXJuYWwgZGF0YSBhbmQgdXNlci1kZWZpbmVkCiAgLy8gZGF0YS4KICBpZiAoICFwdnQgKSB7CiAgICBpZiAoICF0aGlzQ2FjaGUuZGF0YSApIHsKICAgICAgdGhpc0NhY2hlLmRhdGEgPSB7fTsKICAgIH0KCiAgICB0aGlzQ2FjaGUgPSB0aGlzQ2FjaGUuZGF0YTsKICB9CgogIGlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgewogICAgdGhpc0NhY2hlWyBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICkgXSA9IGRhdGE7CiAgfQoKICAvLyBDaGVjayBmb3IgYm90aCBjb252ZXJ0ZWQtdG8tY2FtZWwgYW5kIG5vbi1jb252ZXJ0ZWQgZGF0YSBwcm9wZXJ0eSBuYW1lcwogIC8vIElmIGEgZGF0YSBwcm9wZXJ0eSB3YXMgc3BlY2lmaWVkCiAgaWYgKCBnZXRCeU5hbWUgKSB7CgogICAgLy8gRmlyc3QgVHJ5IHRvIGZpbmQgYXMtaXMgcHJvcGVydHkgZGF0YQogICAgcmV0ID0gdGhpc0NhY2hlWyBuYW1lIF07CgogICAgLy8gVGVzdCBmb3IgbnVsbHx1bmRlZmluZWQgcHJvcGVydHkgZGF0YQogICAgaWYgKCByZXQgPT0gbnVsbCApIHsKCiAgICAgIC8vIFRyeSB0byBmaW5kIHRoZSBjYW1lbENhc2VkIHByb3BlcnR5CiAgICAgIHJldCA9IHRoaXNDYWNoZVsgalF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApIF07CiAgICB9CiAgfSBlbHNlIHsKICAgIHJldCA9IHRoaXNDYWNoZTsKICB9CgogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGludGVybmFsUmVtb3ZlRGF0YSggZWxlbSwgbmFtZSwgcHZ0IC8qIEZvciBpbnRlcm5hbCB1c2Ugb25seSAqLyApewogIGlmICggIWpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgdGhpc0NhY2hlLCBpLCBsLAoKICAgIGlzTm9kZSA9IGVsZW0ubm9kZVR5cGUsCgogICAgLy8gU2VlIGpRdWVyeS5kYXRhIGZvciBtb3JlIGluZm9ybWF0aW9uCiAgICBjYWNoZSA9IGlzTm9kZSA/IGpRdWVyeS5jYWNoZSA6IGVsZW0sCiAgICBpZCA9IGlzTm9kZSA/IGVsZW1bIGpRdWVyeS5leHBhbmRvIF0gOiBqUXVlcnkuZXhwYW5kbzsKCiAgLy8gSWYgdGhlcmUgaXMgYWxyZWFkeSBubyBjYWNoZSBlbnRyeSBmb3IgdGhpcyBvYmplY3QsIHRoZXJlIGlzIG5vCiAgLy8gcHVycG9zZSBpbiBjb250aW51aW5nCiAgaWYgKCAhY2FjaGVbIGlkIF0gKSB7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIG5hbWUgKSB7CgogICAgdGhpc0NhY2hlID0gcHZ0ID8gY2FjaGVbIGlkIF0gOiBjYWNoZVsgaWQgXS5kYXRhOwoKICAgIGlmICggdGhpc0NhY2hlICkgewoKICAgICAgLy8gU3VwcG9ydCBhcnJheSBvciBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIG5hbWVzIGZvciBkYXRhIGtleXMKICAgICAgaWYgKCAhalF1ZXJ5LmlzQXJyYXkoIG5hbWUgKSApIHsKCiAgICAgICAgLy8gdHJ5IHRoZSBzdHJpbmcgYXMgYSBrZXkgYmVmb3JlIGFueSBtYW5pcHVsYXRpb24KICAgICAgICBpZiAoIG5hbWUgaW4gdGhpc0NhY2hlICkgewogICAgICAgICAgbmFtZSA9IFsgbmFtZSBdOwogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgLy8gc3BsaXQgdGhlIGNhbWVsIGNhc2VkIHZlcnNpb24gYnkgc3BhY2VzIHVubGVzcyBhIGtleSB3aXRoIHRoZSBzcGFjZXMgZXhpc3RzCiAgICAgICAgICBuYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApOwogICAgICAgICAgaWYgKCBuYW1lIGluIHRoaXNDYWNoZSApIHsKICAgICAgICAgICAgbmFtZSA9IFsgbmFtZSBdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3BsaXQoIiAiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgIm5hbWUiIGlzIGFuIGFycmF5IG9mIGtleXMuLi4KICAgICAgICAvLyBXaGVuIGRhdGEgaXMgaW5pdGlhbGx5IGNyZWF0ZWQsIHZpYSAoImtleSIsICJ2YWwiKSBzaWduYXR1cmUsCiAgICAgICAgLy8ga2V5cyB3aWxsIGJlIGNvbnZlcnRlZCB0byBjYW1lbENhc2UuCiAgICAgICAgLy8gU2luY2UgdGhlcmUgaXMgbm8gd2F5IHRvIHRlbGwgX2hvd18gYSBrZXkgd2FzIGFkZGVkLCByZW1vdmUKICAgICAgICAvLyBib3RoIHBsYWluIGtleSBhbmQgY2FtZWxDYXNlIGtleS4gIzEyNzg2CiAgICAgICAgLy8gVGhpcyB3aWxsIG9ubHkgcGVuYWxpemUgdGhlIGFycmF5IGFyZ3VtZW50IHBhdGguCiAgICAgICAgbmFtZSA9IG5hbWUuY29uY2F0KCBqUXVlcnkubWFwKCBuYW1lLCBqUXVlcnkuY2FtZWxDYXNlICkgKTsKICAgICAgfQoKICAgICAgZm9yICggaSA9IDAsIGwgPSBuYW1lLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKICAgICAgICBkZWxldGUgdGhpc0NhY2hlWyBuYW1lW2ldIF07CiAgICAgIH0KCiAgICAgIC8vIElmIHRoZXJlIGlzIG5vIGRhdGEgbGVmdCBpbiB0aGUgY2FjaGUsIHdlIHdhbnQgdG8gY29udGludWUKICAgICAgLy8gYW5kIGxldCB0aGUgY2FjaGUgb2JqZWN0IGl0c2VsZiBnZXQgZGVzdHJveWVkCiAgICAgIGlmICggISggcHZ0ID8gaXNFbXB0eURhdGFPYmplY3QgOiBqUXVlcnkuaXNFbXB0eU9iamVjdCApKCB0aGlzQ2FjaGUgKSApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9CgogIC8vIFNlZSBqUXVlcnkuZGF0YSBmb3IgbW9yZSBpbmZvcm1hdGlvbgogIGlmICggIXB2dCApIHsKICAgIGRlbGV0ZSBjYWNoZVsgaWQgXS5kYXRhOwoKICAgIC8vIERvbid0IGRlc3Ryb3kgdGhlIHBhcmVudCBjYWNoZSB1bmxlc3MgdGhlIGludGVybmFsIGRhdGEgb2JqZWN0CiAgICAvLyBoYWQgYmVlbiB0aGUgb25seSB0aGluZyBsZWZ0IGluIGl0CiAgICBpZiAoICFpc0VtcHR5RGF0YU9iamVjdCggY2FjaGVbIGlkIF0gKSApIHsKICAgICAgcmV0dXJuOwogICAgfQogIH0KCiAgLy8gRGVzdHJveSB0aGUgY2FjaGUKICBpZiAoIGlzTm9kZSApIHsKICAgIGpRdWVyeS5jbGVhbkRhdGEoIFsgZWxlbSBdLCB0cnVlICk7CgogIC8vIFVzZSBkZWxldGUgd2hlbiBzdXBwb3J0ZWQgZm9yIGV4cGFuZG9zIG9yIGBjYWNoZWAgaXMgbm90IGEgd2luZG93IHBlciBpc1dpbmRvdyAoIzEwMDgwKQogIH0gZWxzZSBpZiAoIGpRdWVyeS5zdXBwb3J0LmRlbGV0ZUV4cGFuZG8gfHwgY2FjaGUgIT0gY2FjaGUud2luZG93ICkgewogICAgZGVsZXRlIGNhY2hlWyBpZCBdOwoKICAvLyBXaGVuIGFsbCBlbHNlIGZhaWxzLCBudWxsCiAgfSBlbHNlIHsKICAgIGNhY2hlWyBpZCBdID0gbnVsbDsKICB9Cn0KCmpRdWVyeS5leHRlbmQoewogIGNhY2hlOiB7fSwKCiAgLy8gVW5pcXVlIGZvciBlYWNoIGNvcHkgb2YgalF1ZXJ5IG9uIHRoZSBwYWdlCiAgLy8gTm9uLWRpZ2l0cyByZW1vdmVkIHRvIG1hdGNoIHJpbmxpbmVqUXVlcnkKICBleHBhbmRvOiAialF1ZXJ5IiArICggY29yZV92ZXJzaW9uICsgTWF0aC5yYW5kb20oKSApLnJlcGxhY2UoIC9cRC9nLCAiIiApLAoKICAvLyBUaGUgZm9sbG93aW5nIGVsZW1lbnRzIHRocm93IHVuY2F0Y2hhYmxlIGV4Y2VwdGlvbnMgaWYgeW91CiAgLy8gYXR0ZW1wdCB0byBhZGQgZXhwYW5kbyBwcm9wZXJ0aWVzIHRvIHRoZW0uCiAgbm9EYXRhOiB7CiAgICAiZW1iZWQiOiB0cnVlLAogICAgLy8gQmFuIGFsbCBvYmplY3RzIGV4Y2VwdCBmb3IgRmxhc2ggKHdoaWNoIGhhbmRsZSBleHBhbmRvcykKICAgICJvYmplY3QiOiAiY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwIiwKICAgICJhcHBsZXQiOiB0cnVlCiAgfSwKCiAgaGFzRGF0YTogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICBlbGVtID0gZWxlbS5ub2RlVHlwZSA/IGpRdWVyeS5jYWNoZVsgZWxlbVtqUXVlcnkuZXhwYW5kb10gXSA6IGVsZW1bIGpRdWVyeS5leHBhbmRvIF07CiAgICByZXR1cm4gISFlbGVtICYmICFpc0VtcHR5RGF0YU9iamVjdCggZWxlbSApOwogIH0sCgogIGRhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBkYXRhICkgewogICAgcmV0dXJuIGludGVybmFsRGF0YSggZWxlbSwgbmFtZSwgZGF0YSwgZmFsc2UgKTsKICB9LAoKICByZW1vdmVEYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKICAgIHJldHVybiBpbnRlcm5hbFJlbW92ZURhdGEoIGVsZW0sIG5hbWUsIGZhbHNlICk7CiAgfSwKCiAgLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgogIF9kYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsKICAgIHJldHVybiBpbnRlcm5hbERhdGEoIGVsZW0sIG5hbWUsIGRhdGEsIHRydWUgKTsKICB9LAogIAogIF9yZW1vdmVEYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKICAgIHJldHVybiBpbnRlcm5hbFJlbW92ZURhdGEoIGVsZW0sIG5hbWUsIHRydWUgKTsKICB9LAoKICAvLyBBIG1ldGhvZCBmb3IgZGV0ZXJtaW5pbmcgaWYgYSBET00gbm9kZSBjYW4gaGFuZGxlIHRoZSBkYXRhIGV4cGFuZG8KICBhY2NlcHREYXRhOiBmdW5jdGlvbiggZWxlbSApIHsKICAgIHZhciBub0RhdGEgPSBlbGVtLm5vZGVOYW1lICYmIGpRdWVyeS5ub0RhdGFbIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOwoKICAgIC8vIG5vZGVzIGFjY2VwdCBkYXRhIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkOyByZWplY3Rpb24gY2FuIGJlIGNvbmRpdGlvbmFsCiAgICByZXR1cm4gIW5vRGF0YSB8fCBub0RhdGEgIT09IHRydWUgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzaWQiKSA9PT0gbm9EYXRhOwogIH0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKICBkYXRhOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKICAgIHZhciBhdHRycywgbmFtZSwKICAgICAgZWxlbSA9IHRoaXNbMF0sCiAgICAgIGkgPSAwLAogICAgICBkYXRhID0gbnVsbDsKCiAgICAvLyBHZXRzIGFsbCB2YWx1ZXMKICAgIGlmICgga2V5ID09PSB1bmRlZmluZWQgKSB7CiAgICAgIGlmICggdGhpcy5sZW5ndGggKSB7CiAgICAgICAgZGF0YSA9IGpRdWVyeS5kYXRhKCBlbGVtICk7CgogICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhalF1ZXJ5Ll9kYXRhKCBlbGVtLCAicGFyc2VkQXR0cnMiICkgKSB7CiAgICAgICAgICBhdHRycyA9IGVsZW0uYXR0cmlidXRlczsKICAgICAgICAgIGZvciAoIDsgaSA8IGF0dHJzLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICBuYW1lID0gYXR0cnNbaV0ubmFtZTsKCiAgICAgICAgICAgIGlmICggIW5hbWUuaW5kZXhPZiggImRhdGEtIiApICkgewogICAgICAgICAgICAgIG5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lLnN1YnN0cmluZyg1KSApOwoKICAgICAgICAgICAgICBkYXRhQXR0ciggZWxlbSwgbmFtZSwgZGF0YVsgbmFtZSBdICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGpRdWVyeS5fZGF0YSggZWxlbSwgInBhcnNlZEF0dHJzIiwgdHJ1ZSApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CgogICAgLy8gU2V0cyBtdWx0aXBsZSB2YWx1ZXMKICAgIGlmICggdHlwZW9mIGtleSA9PT0gIm9iamVjdCIgKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSApOwogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoKICAgICAgaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewogICAgICAgIC8vIFRyeSB0byBmZXRjaCBhbnkgaW50ZXJuYWxseSBzdG9yZWQgZGF0YSBmaXJzdAogICAgICAgIHJldHVybiBlbGVtID8gZGF0YUF0dHIoIGVsZW0sIGtleSwgalF1ZXJ5LmRhdGEoIGVsZW0sIGtleSApICkgOiBudWxsOwogICAgICB9CgogICAgICB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSwgdmFsdWUgKTsKICAgICAgfSk7CiAgICB9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEsIG51bGwsIHRydWUgKTsKICB9LAoKICByZW1vdmVEYXRhOiBmdW5jdGlvbigga2V5ICkgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgalF1ZXJ5LnJlbW92ZURhdGEoIHRoaXMsIGtleSApOwogICAgfSk7CiAgfQp9KTsKCmZ1bmN0aW9uIGRhdGFBdHRyKCBlbGVtLCBrZXksIGRhdGEgKSB7CiAgLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW50ZXJuYWxseSwgdHJ5IHRvIGZldGNoIGFueQogIC8vIGRhdGEgZnJvbSB0aGUgSFRNTDUgZGF0YS0qIGF0dHJpYnV0ZQogIGlmICggZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgogICAgdmFyIG5hbWUgPSAiZGF0YS0iICsga2V5LnJlcGxhY2UoIHJtdWx0aURhc2gsICItJDEiICkudG9Mb3dlckNhc2UoKTsKCiAgICBkYXRhID0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKTsKCiAgICBpZiAoIHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiApIHsKICAgICAgdHJ5IHsKICAgICAgICBkYXRhID0gZGF0YSA9PT0gInRydWUiID8gdHJ1ZSA6CiAgICAgICAgZGF0YSA9PT0gImZhbHNlIiA/IGZhbHNlIDoKICAgICAgICBkYXRhID09PSAibnVsbCIgPyBudWxsIDoKICAgICAgICAvLyBPbmx5IGNvbnZlcnQgdG8gYSBudW1iZXIgaWYgaXQgZG9lc24ndCBjaGFuZ2UgdGhlIHN0cmluZwogICAgICAgICtkYXRhICsgIiIgPT09IGRhdGEgPyArZGF0YSA6CiAgICAgICAgcmJyYWNlLnRlc3QoIGRhdGEgKSA/IGpRdWVyeS5wYXJzZUpTT04oIGRhdGEgKSA6CiAgICAgICAgICBkYXRhOwogICAgICB9IGNhdGNoKCBlICkge30KCiAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBzZXQgdGhlIGRhdGEgc28gaXQgaXNuJ3QgY2hhbmdlZCBsYXRlcgogICAgICBqUXVlcnkuZGF0YSggZWxlbSwga2V5LCBkYXRhICk7CgogICAgfSBlbHNlIHsKICAgICAgZGF0YSA9IHVuZGVmaW5lZDsKICAgIH0KICB9CgogIHJldHVybiBkYXRhOwp9CgovLyBjaGVja3MgYSBjYWNoZSBvYmplY3QgZm9yIGVtcHRpbmVzcwpmdW5jdGlvbiBpc0VtcHR5RGF0YU9iamVjdCggb2JqICkgewogIHZhciBuYW1lOwogIGZvciAoIG5hbWUgaW4gb2JqICkgewoKICAgIC8vIGlmIHRoZSBwdWJsaWMgZGF0YSBvYmplY3QgaXMgZW1wdHksIHRoZSBwcml2YXRlIGlzIHN0aWxsIGVtcHR5CiAgICBpZiAoIG5hbWUgPT09ICJkYXRhIiAmJiBqUXVlcnkuaXNFbXB0eU9iamVjdCggb2JqW25hbWVdICkgKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgaWYgKCBuYW1lICE9PSAidG9KU09OIiApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgcmV0dXJuIHRydWU7Cn0KalF1ZXJ5LmV4dGVuZCh7CiAgcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBkYXRhICkgewogICAgdmFyIHF1ZXVlOwoKICAgIGlmICggZWxlbSApIHsKICAgICAgdHlwZSA9ICggdHlwZSB8fCAiZngiICkgKyAicXVldWUiOwogICAgICBxdWV1ZSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgdHlwZSApOwoKICAgICAgLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAogICAgICBpZiAoIGRhdGEgKSB7CiAgICAgICAgaWYgKCAhcXVldWUgfHwgalF1ZXJ5LmlzQXJyYXkoZGF0YSkgKSB7CiAgICAgICAgICBxdWV1ZSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheShkYXRhKSApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWV1ZS5wdXNoKCBkYXRhICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBxdWV1ZSB8fCBbXTsKICAgIH0KICB9LAoKICBkZXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsKICAgIHR5cGUgPSB0eXBlIHx8ICJmeCI7CgogICAgdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKCBlbGVtLCB0eXBlICksCiAgICAgIHN0YXJ0TGVuZ3RoID0gcXVldWUubGVuZ3RoLAogICAgICBmbiA9IHF1ZXVlLnNoaWZ0KCksCiAgICAgIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKCBlbGVtLCB0eXBlICksCiAgICAgIG5leHQgPSBmdW5jdGlvbigpIHsKICAgICAgICBqUXVlcnkuZGVxdWV1ZSggZWxlbSwgdHlwZSApOwogICAgICB9OwoKICAgIC8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKICAgIGlmICggZm4gPT09ICJpbnByb2dyZXNzIiApIHsKICAgICAgZm4gPSBxdWV1ZS5zaGlmdCgpOwogICAgICBzdGFydExlbmd0aC0tOwogICAgfQoKICAgIGhvb2tzLmN1ciA9IGZuOwogICAgaWYgKCBmbiApIHsKCiAgICAgIC8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKICAgICAgLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAogICAgICBpZiAoIHR5cGUgPT09ICJmeCIgKSB7CiAgICAgICAgcXVldWUudW5zaGlmdCggImlucHJvZ3Jlc3MiICk7CiAgICAgIH0KCiAgICAgIC8vIGNsZWFyIHVwIHRoZSBsYXN0IHF1ZXVlIHN0b3AgZnVuY3Rpb24KICAgICAgZGVsZXRlIGhvb2tzLnN0b3A7CiAgICAgIGZuLmNhbGwoIGVsZW0sIG5leHQsIGhvb2tzICk7CiAgICB9CgogICAgaWYgKCAhc3RhcnRMZW5ndGggJiYgaG9va3MgKSB7CiAgICAgIGhvb2tzLmVtcHR5LmZpcmUoKTsKICAgIH0KICB9LAoKICAvLyBub3QgaW50ZW5kZWQgZm9yIHB1YmxpYyBjb25zdW1wdGlvbiAtIGdlbmVyYXRlcyBhIHF1ZXVlSG9va3Mgb2JqZWN0LCBvciByZXR1cm5zIHRoZSBjdXJyZW50IG9uZQogIF9xdWV1ZUhvb2tzOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsKICAgIHZhciBrZXkgPSB0eXBlICsgInF1ZXVlSG9va3MiOwogICAgcmV0dXJuIGpRdWVyeS5fZGF0YSggZWxlbSwga2V5ICkgfHwgalF1ZXJ5Ll9kYXRhKCBlbGVtLCBrZXksIHsKICAgICAgZW1wdHk6IGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IikuYWRkKGZ1bmN0aW9uKCkgewogICAgICAgIGpRdWVyeS5fcmVtb3ZlRGF0YSggZWxlbSwgdHlwZSArICJxdWV1ZSIgKTsKICAgICAgICBqUXVlcnkuX3JlbW92ZURhdGEoIGVsZW0sIGtleSApOwogICAgICB9KQogICAgfSk7CiAgfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewogIHF1ZXVlOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKICAgIHZhciBzZXR0ZXIgPSAyOwoKICAgIGlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewogICAgICBkYXRhID0gdHlwZTsKICAgICAgdHlwZSA9ICJmeCI7CiAgICAgIHNldHRlci0tOwogICAgfQoKICAgIGlmICggYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlciApIHsKICAgICAgcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1swXSwgdHlwZSApOwogICAgfQoKICAgIHJldHVybiBkYXRhID09PSB1bmRlZmluZWQgPwogICAgICB0aGlzIDoKICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSggdGhpcywgdHlwZSwgZGF0YSApOwoKICAgICAgICAvLyBlbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQogICAgICAgIGpRdWVyeS5fcXVldWVIb29rcyggdGhpcywgdHlwZSApOwoKICAgICAgICBpZiAoIHR5cGUgPT09ICJmeCIgJiYgcXVldWVbMF0gIT09ICJpbnByb2dyZXNzIiApIHsKICAgICAgICAgIGpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CiAgICAgICAgfQogICAgICB9KTsKICB9LAogIGRlcXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKICAgIH0pOwogIH0sCiAgLy8gQmFzZWQgb2ZmIG9mIHRoZSBwbHVnaW4gYnkgQ2xpbnQgSGVsZmVycywgd2l0aCBwZXJtaXNzaW9uLgogIC8vIGh0dHA6Ly9ibGluZHNpZ25hbHMuY29tL2luZGV4LnBocC8yMDA5LzA3L2pxdWVyeS1kZWxheS8KICBkZWxheTogZnVuY3Rpb24oIHRpbWUsIHR5cGUgKSB7CiAgICB0aW1lID0galF1ZXJ5LmZ4ID8galF1ZXJ5LmZ4LnNwZWVkc1sgdGltZSBdIHx8IHRpbWUgOiB0aW1lOwogICAgdHlwZSA9IHR5cGUgfHwgImZ4IjsKCiAgICByZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oIG5leHQsIGhvb2tzICkgewogICAgICB2YXIgdGltZW91dCA9IHNldFRpbWVvdXQoIG5leHQsIHRpbWUgKTsKICAgICAgaG9va3Muc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNsZWFyVGltZW91dCggdGltZW91dCApOwogICAgICB9OwogICAgfSk7CiAgfSwKICBjbGVhclF1ZXVlOiBmdW5jdGlvbiggdHlwZSApIHsKICAgIHJldHVybiB0aGlzLnF1ZXVlKCB0eXBlIHx8ICJmeCIsIFtdICk7CiAgfSwKICAvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlCiAgLy8gYXJlIGVtcHRpZWQgKGZ4IGlzIHRoZSB0eXBlIGJ5IGRlZmF1bHQpCiAgcHJvbWlzZTogZnVuY3Rpb24oIHR5cGUsIG9iaiApIHsKICAgIHZhciB0bXAsCiAgICAgIGNvdW50ID0gMSwKICAgICAgZGVmZXIgPSBqUXVlcnkuRGVmZXJyZWQoKSwKICAgICAgZWxlbWVudHMgPSB0aGlzLAogICAgICBpID0gdGhpcy5sZW5ndGgsCiAgICAgIHJlc29sdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICEoIC0tY291bnQgKSApIHsKICAgICAgICAgIGRlZmVyLnJlc29sdmVXaXRoKCBlbGVtZW50cywgWyBlbGVtZW50cyBdICk7CiAgICAgICAgfQogICAgICB9OwoKICAgIGlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewogICAgICBvYmogPSB0eXBlOwogICAgICB0eXBlID0gdW5kZWZpbmVkOwogICAgfQogICAgdHlwZSA9IHR5cGUgfHwgImZ4IjsKCiAgICB3aGlsZSggaS0tICkgewogICAgICB0bXAgPSBqUXVlcnkuX2RhdGEoIGVsZW1lbnRzWyBpIF0sIHR5cGUgKyAicXVldWVIb29rcyIgKTsKICAgICAgaWYgKCB0bXAgJiYgdG1wLmVtcHR5ICkgewogICAgICAgIGNvdW50Kys7CiAgICAgICAgdG1wLmVtcHR5LmFkZCggcmVzb2x2ZSApOwogICAgICB9CiAgICB9CiAgICByZXNvbHZlKCk7CiAgICByZXR1cm4gZGVmZXIucHJvbWlzZSggb2JqICk7CiAgfQp9KTsKdmFyIG5vZGVIb29rLCBib29sSG9vaywKICByY2xhc3MgPSAvW1x0XHJcbl0vZywKICBycmV0dXJuID0gL1xyL2csCiAgcmZvY3VzYWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbnxvYmplY3QpJC9pLAogIHJjbGlja2FibGUgPSAvXig/OmF8YXJlYSkkL2ksCiAgcmJvb2xlYW4gPSAvXig/OmNoZWNrZWR8c2VsZWN0ZWR8YXV0b2ZvY3VzfGF1dG9wbGF5fGFzeW5jfGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkKSQvaSwKICBydXNlRGVmYXVsdCA9IC9eKD86Y2hlY2tlZHxzZWxlY3RlZCkkL2ksCiAgZ2V0U2V0QXR0cmlidXRlID0galF1ZXJ5LnN1cHBvcnQuZ2V0U2V0QXR0cmlidXRlLAogIGdldFNldElucHV0ID0galF1ZXJ5LnN1cHBvcnQuaW5wdXQ7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKICBhdHRyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CiAgICByZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgalF1ZXJ5LmF0dHIsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwogIH0sCgogIHJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lICkgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIoIHRoaXMsIG5hbWUgKTsKICAgIH0pOwogIH0sCgogIHByb3A6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKICAgIHJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBqUXVlcnkucHJvcCwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7CiAgfSwKCiAgcmVtb3ZlUHJvcDogZnVuY3Rpb24oIG5hbWUgKSB7CiAgICBuYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgLy8gdHJ5L2NhdGNoIGhhbmRsZXMgY2FzZXMgd2hlcmUgSUUgYmFsa3MgKHN1Y2ggYXMgcmVtb3ZpbmcgYSBwcm9wZXJ0eSBvbiB3aW5kb3cpCiAgICAgIHRyeSB7CiAgICAgICAgdGhpc1sgbmFtZSBdID0gdW5kZWZpbmVkOwogICAgICAgIGRlbGV0ZSB0aGlzWyBuYW1lIF07CiAgICAgIH0gY2F0Y2goIGUgKSB7fQogICAgfSk7CiAgfSwKCiAgYWRkQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgIHZhciBjbGFzc2VzLCBlbGVtLCBjdXIsIGNsYXp6LCBqLAogICAgICBpID0gMCwKICAgICAgbGVuID0gdGhpcy5sZW5ndGgsCiAgICAgIHByb2NlZWQgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIHZhbHVlOwoKICAgIGlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGogKSB7CiAgICAgICAgalF1ZXJ5KCB0aGlzICkuYWRkQ2xhc3MoIHZhbHVlLmNhbGwoIHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lICkgKTsKICAgICAgfSk7CiAgICB9CgogICAgaWYgKCBwcm9jZWVkICkgewogICAgICAvLyBUaGUgZGlzanVuY3Rpb24gaGVyZSBpcyBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIHJlbW92ZUNsYXNzKQogICAgICBjbGFzc2VzID0gKCB2YWx1ZSB8fCAiIiApLm1hdGNoKCBjb3JlX3Jub3R3aGl0ZSApIHx8IFtdOwoKICAgICAgZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CiAgICAgICAgZWxlbSA9IHRoaXNbIGkgXTsKICAgICAgICBjdXIgPSBlbGVtLm5vZGVUeXBlID09PSAxICYmICggZWxlbS5jbGFzc05hbWUgPwogICAgICAgICAgKCAiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIiApLnJlcGxhY2UoIHJjbGFzcywgIiAiICkgOgogICAgICAgICAgIiAiCiAgICAgICAgKTsKCiAgICAgICAgaWYgKCBjdXIgKSB7CiAgICAgICAgICBqID0gMDsKICAgICAgICAgIHdoaWxlICggKGNsYXp6ID0gY2xhc3Nlc1tqKytdKSApIHsKICAgICAgICAgICAgaWYgKCBjdXIuaW5kZXhPZiggIiAiICsgY2xhenogKyAiICIgKSA8IDAgKSB7CiAgICAgICAgICAgICAgY3VyICs9IGNsYXp6ICsgIiAiOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtLmNsYXNzTmFtZSA9IGpRdWVyeS50cmltKCBjdXIgKTsKCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgIHZhciBjbGFzc2VzLCBlbGVtLCBjdXIsIGNsYXp6LCBqLAogICAgICBpID0gMCwKICAgICAgbGVuID0gdGhpcy5sZW5ndGgsCiAgICAgIHByb2NlZWQgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgdmFsdWU7CgogICAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaiApIHsKICAgICAgICBqUXVlcnkoIHRoaXMgKS5yZW1vdmVDbGFzcyggdmFsdWUuY2FsbCggdGhpcywgaiwgdGhpcy5jbGFzc05hbWUgKSApOwogICAgICB9KTsKICAgIH0KICAgIGlmICggcHJvY2VlZCApIHsKICAgICAgY2xhc3NlcyA9ICggdmFsdWUgfHwgIiIgKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbXTsKCiAgICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgICAgIGVsZW0gPSB0aGlzWyBpIF07CiAgICAgICAgLy8gVGhpcyBleHByZXNzaW9uIGlzIGhlcmUgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSBhZGRDbGFzcykKICAgICAgICBjdXIgPSBlbGVtLm5vZGVUeXBlID09PSAxICYmICggZWxlbS5jbGFzc05hbWUgPwogICAgICAgICAgKCAiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIiApLnJlcGxhY2UoIHJjbGFzcywgIiAiICkgOgogICAgICAgICAgIiIKICAgICAgICApOwoKICAgICAgICBpZiAoIGN1ciApIHsKICAgICAgICAgIGogPSAwOwogICAgICAgICAgd2hpbGUgKCAoY2xhenogPSBjbGFzc2VzW2orK10pICkgewogICAgICAgICAgICAvLyBSZW1vdmUgKmFsbCogaW5zdGFuY2VzCiAgICAgICAgICAgIHdoaWxlICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPj0gMCApIHsKICAgICAgICAgICAgICBjdXIgPSBjdXIucmVwbGFjZSggIiAiICsgY2xhenogKyAiICIsICIgIiApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtLmNsYXNzTmFtZSA9IHZhbHVlID8galF1ZXJ5LnRyaW0oIGN1ciApIDogIiI7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSwgc3RhdGVWYWwgKSB7CiAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZSwKICAgICAgaXNCb29sID0gdHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiI7CgogICAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKICAgICAgICBqUXVlcnkoIHRoaXMgKS50b2dnbGVDbGFzcyggdmFsdWUuY2FsbCh0aGlzLCBpLCB0aGlzLmNsYXNzTmFtZSwgc3RhdGVWYWwpLCBzdGF0ZVZhbCApOwogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICBpZiAoIHR5cGUgPT09ICJzdHJpbmciICkgewogICAgICAgIC8vIHRvZ2dsZSBpbmRpdmlkdWFsIGNsYXNzIG5hbWVzCiAgICAgICAgdmFyIGNsYXNzTmFtZSwKICAgICAgICAgIGkgPSAwLAogICAgICAgICAgc2VsZiA9IGpRdWVyeSggdGhpcyApLAogICAgICAgICAgc3RhdGUgPSBzdGF0ZVZhbCwKICAgICAgICAgIGNsYXNzTmFtZXMgPSB2YWx1ZS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbXTsKCiAgICAgICAgd2hpbGUgKCAoY2xhc3NOYW1lID0gY2xhc3NOYW1lc1sgaSsrIF0pICkgewogICAgICAgICAgLy8gY2hlY2sgZWFjaCBjbGFzc05hbWUgZ2l2ZW4sIHNwYWNlIHNlcGFyYXRlZCBsaXN0CiAgICAgICAgICBzdGF0ZSA9IGlzQm9vbCA/IHN0YXRlIDogIXNlbGYuaGFzQ2xhc3MoIGNsYXNzTmFtZSApOwogICAgICAgICAgc2VsZlsgc3RhdGUgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIiBdKCBjbGFzc05hbWUgKTsKICAgICAgICB9CgogICAgICAvLyBUb2dnbGUgd2hvbGUgY2xhc3MgbmFtZQogICAgICB9IGVsc2UgaWYgKCB0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlID09PSAiYm9vbGVhbiIgKSB7CiAgICAgICAgaWYgKCB0aGlzLmNsYXNzTmFtZSApIHsKICAgICAgICAgIC8vIHN0b3JlIGNsYXNzTmFtZSBpZiBzZXQKICAgICAgICAgIGpRdWVyeS5fZGF0YSggdGhpcywgIl9fY2xhc3NOYW1lX18iLCB0aGlzLmNsYXNzTmFtZSApOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlIGVsZW1lbnQgaGFzIGEgY2xhc3MgbmFtZSBvciBpZiB3ZSdyZSBwYXNzZWQgImZhbHNlIiwKICAgICAgICAvLyB0aGVuIHJlbW92ZSB0aGUgd2hvbGUgY2xhc3NuYW1lIChpZiB0aGVyZSB3YXMgb25lLCB0aGUgYWJvdmUgc2F2ZWQgaXQpLgogICAgICAgIC8vIE90aGVyd2lzZSBicmluZyBiYWNrIHdoYXRldmVyIHdhcyBwcmV2aW91c2x5IHNhdmVkIChpZiBhbnl0aGluZyksCiAgICAgICAgLy8gZmFsbGluZyBiYWNrIHRvIHRoZSBlbXB0eSBzdHJpbmcgaWYgbm90aGluZyB3YXMgc3RvcmVkLgogICAgICAgIHRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUgfHwgdmFsdWUgPT09IGZhbHNlID8gIiIgOiBqUXVlcnkuX2RhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiApIHx8ICIiOwogICAgICB9CiAgICB9KTsKICB9LAoKICBoYXNDbGFzczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewogICAgdmFyIGNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiLAogICAgICBpID0gMCwKICAgICAgbCA9IHRoaXMubGVuZ3RoOwogICAgZm9yICggOyBpIDwgbDsgaSsrICkgewogICAgICBpZiAoIHRoaXNbaV0ubm9kZVR5cGUgPT09IDEgJiYgKCIgIiArIHRoaXNbaV0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKHJjbGFzcywgIiAiKS5pbmRleE9mKCBjbGFzc05hbWUgKSA+PSAwICkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIHZhbDogZnVuY3Rpb24oIHZhbHVlICkgewogICAgdmFyIGhvb2tzLCByZXQsIGlzRnVuY3Rpb24sCiAgICAgIGVsZW0gPSB0aGlzWzBdOwoKICAgIGlmICggIWFyZ3VtZW50cy5sZW5ndGggKSB7CiAgICAgIGlmICggZWxlbSApIHsKICAgICAgICBob29rcyA9IGpRdWVyeS52YWxIb29rc1sgZWxlbS50eXBlIF0gfHwgalF1ZXJ5LnZhbEhvb2tzWyBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCiAgICAgICAgaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCAidmFsdWUiICkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KCiAgICAgICAgcmV0ID0gZWxlbS52YWx1ZTsKCiAgICAgICAgcmV0dXJuIHR5cGVvZiByZXQgPT09ICJzdHJpbmciID8KICAgICAgICAgIC8vIGhhbmRsZSBtb3N0IGNvbW1vbiBzdHJpbmcgY2FzZXMKICAgICAgICAgIHJldC5yZXBsYWNlKHJyZXR1cm4sICIiKSA6CiAgICAgICAgICAvLyBoYW5kbGUgY2FzZXMgd2hlcmUgdmFsdWUgaXMgbnVsbC91bmRlZiBvciBudW1iZXIKICAgICAgICAgIHJldCA9PSBudWxsID8gIiIgOiByZXQ7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKICAgICAgdmFyIHZhbCwKICAgICAgICBzZWxmID0galF1ZXJ5KHRoaXMpOwoKICAgICAgaWYgKCB0aGlzLm5vZGVUeXBlICE9PSAxICkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCBpc0Z1bmN0aW9uICkgewogICAgICAgIHZhbCA9IHZhbHVlLmNhbGwoIHRoaXMsIGksIHNlbGYudmFsKCkgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWwgPSB2YWx1ZTsKICAgICAgfQoKICAgICAgLy8gVHJlYXQgbnVsbC91bmRlZmluZWQgYXMgIiI7IGNvbnZlcnQgbnVtYmVycyB0byBzdHJpbmcKICAgICAgaWYgKCB2YWwgPT0gbnVsbCApIHsKICAgICAgICB2YWwgPSAiIjsKICAgICAgfSBlbHNlIGlmICggdHlwZW9mIHZhbCA9PT0gIm51bWJlciIgKSB7CiAgICAgICAgdmFsICs9ICIiOwogICAgICB9IGVsc2UgaWYgKCBqUXVlcnkuaXNBcnJheSggdmFsICkgKSB7CiAgICAgICAgdmFsID0galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICggdmFsdWUgKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKyAiIjsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIHRoaXMudHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgogICAgICAvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwogICAgICBpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCBob29rcy5zZXQoIHRoaXMsIHZhbCwgInZhbHVlIiApID09PSB1bmRlZmluZWQgKSB7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbDsKICAgICAgfQogICAgfSk7CiAgfQp9KTsKCmpRdWVyeS5leHRlbmQoewogIHZhbEhvb2tzOiB7CiAgICBvcHRpb246IHsKICAgICAgZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICAvLyBhdHRyaWJ1dGVzLnZhbHVlIGlzIHVuZGVmaW5lZCBpbiBCbGFja2JlcnJ5IDQuNyBidXQKICAgICAgICAvLyB1c2VzIC52YWx1ZS4gU2VlICM2OTMyCiAgICAgICAgdmFyIHZhbCA9IGVsZW0uYXR0cmlidXRlcy52YWx1ZTsKICAgICAgICByZXR1cm4gIXZhbCB8fCB2YWwuc3BlY2lmaWVkID8gZWxlbS52YWx1ZSA6IGVsZW0udGV4dDsKICAgICAgfQogICAgfSwKICAgIHNlbGVjdDogewogICAgICBnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAgIHZhciB2YWx1ZSwgb3B0aW9uLAogICAgICAgICAgb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKICAgICAgICAgIGluZGV4ID0gZWxlbS5zZWxlY3RlZEluZGV4LAogICAgICAgICAgb25lID0gZWxlbS50eXBlID09PSAic2VsZWN0LW9uZSIgfHwgaW5kZXggPCAwLAogICAgICAgICAgdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLAogICAgICAgICAgbWF4ID0gb25lID8gaW5kZXggKyAxIDogb3B0aW9ucy5sZW5ndGgsCiAgICAgICAgICBpID0gaW5kZXggPCAwID8KICAgICAgICAgICAgbWF4IDoKICAgICAgICAgICAgb25lID8gaW5kZXggOiAwOwoKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBzZWxlY3RlZCBvcHRpb25zCiAgICAgICAgZm9yICggOyBpIDwgbWF4OyBpKysgKSB7CiAgICAgICAgICBvcHRpb24gPSBvcHRpb25zWyBpIF07CgogICAgICAgICAgLy8gb2xkSUUgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAoIzI1NTEpCiAgICAgICAgICBpZiAoICggb3B0aW9uLnNlbGVjdGVkIHx8IGkgPT09IGluZGV4ICkgJiYKICAgICAgICAgICAgICAvLyBEb24ndCByZXR1cm4gb3B0aW9ucyB0aGF0IGFyZSBkaXNhYmxlZCBvciBpbiBhIGRpc2FibGVkIG9wdGdyb3VwCiAgICAgICAgICAgICAgKCBqUXVlcnkuc3VwcG9ydC5vcHREaXNhYmxlZCA/ICFvcHRpb24uZGlzYWJsZWQgOiBvcHRpb24uZ2V0QXR0cmlidXRlKCJkaXNhYmxlZCIpID09PSBudWxsICkgJiYKICAgICAgICAgICAgICAoICFvcHRpb24ucGFyZW50Tm9kZS5kaXNhYmxlZCB8fCAhalF1ZXJ5Lm5vZGVOYW1lKCBvcHRpb24ucGFyZW50Tm9kZSwgIm9wdGdyb3VwIiApICkgKSB7CgogICAgICAgICAgICAvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uCiAgICAgICAgICAgIHZhbHVlID0galF1ZXJ5KCBvcHRpb24gKS52YWwoKTsKCiAgICAgICAgICAgIC8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCiAgICAgICAgICAgIGlmICggb25lICkgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKICAgICAgICAgICAgdmFsdWVzLnB1c2goIHZhbHVlICk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgICB9LAoKICAgICAgc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CiAgICAgICAgdmFyIHZhbHVlcyA9IGpRdWVyeS5tYWtlQXJyYXkoIHZhbHVlICk7CgogICAgICAgIGpRdWVyeShlbGVtKS5maW5kKCJvcHRpb24iKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5zZWxlY3RlZCA9IGpRdWVyeS5pbkFycmF5KCBqUXVlcnkodGhpcykudmFsKCksIHZhbHVlcyApID49IDA7CiAgICAgICAgfSk7CgogICAgICAgIGlmICggIXZhbHVlcy5sZW5ndGggKSB7CiAgICAgICAgICBlbGVtLnNlbGVjdGVkSW5kZXggPSAtMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgfQogICAgfQogIH0sCgogIGF0dHI6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSApIHsKICAgIHZhciByZXQsIGhvb2tzLCBub3R4bWwsCiAgICAgIG5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCiAgICAvLyBkb24ndCBnZXQvc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCiAgICBpZiAoICFlbGVtIHx8IG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyICkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gRmFsbGJhY2sgdG8gcHJvcCB3aGVuIGF0dHJpYnV0ZXMgYXJlIG5vdCBzdXBwb3J0ZWQKICAgIGlmICggdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlID09PSAidW5kZWZpbmVkIiApIHsKICAgICAgcmV0dXJuIGpRdWVyeS5wcm9wKCBlbGVtLCBuYW1lLCB2YWx1ZSApOwogICAgfQoKICAgIG5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKTsKCiAgICAvLyBBbGwgYXR0cmlidXRlcyBhcmUgbG93ZXJjYXNlCiAgICAvLyBHcmFiIG5lY2Vzc2FyeSBob29rIGlmIG9uZSBpcyBkZWZpbmVkCiAgICBpZiAoIG5vdHhtbCApIHsKICAgICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gfHwgKCByYm9vbGVhbi50ZXN0KCBuYW1lICkgPyBib29sSG9vayA6IG5vZGVIb29rICk7CiAgICB9CgogICAgaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoKICAgICAgaWYgKCB2YWx1ZSA9PT0gbnVsbCApIHsKICAgICAgICBqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoKICAgICAgfSBlbHNlIGlmICggaG9va3MgJiYgbm90eG1sICYmICJzZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgcmV0dXJuIHJldDsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsIHZhbHVlICsgIiIgKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KCiAgICB9IGVsc2UgaWYgKCBob29rcyAmJiBub3R4bWwgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgbmFtZSApKSAhPT0gbnVsbCApIHsKICAgICAgcmV0dXJuIHJldDsKCiAgICB9IGVsc2UgewoKICAgICAgLy8gSW4gSUU5KywgRmxhc2ggb2JqZWN0cyBkb24ndCBoYXZlIC5nZXRBdHRyaWJ1dGUgKCMxMjk0NSkKICAgICAgLy8gU3VwcG9ydDogSUU5KwogICAgICBpZiAoIHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSAhPT0gInVuZGVmaW5lZCIgKSB7CiAgICAgICAgcmV0ID0gIGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICk7CiAgICAgIH0KCiAgICAgIC8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCiAgICAgIHJldHVybiByZXQgPT0gbnVsbCA/CiAgICAgICAgdW5kZWZpbmVkIDoKICAgICAgICByZXQ7CiAgICB9CiAgfSwKCiAgcmVtb3ZlQXR0cjogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewogICAgdmFyIG5hbWUsIHByb3BOYW1lLAogICAgICBpID0gMCwKICAgICAgYXR0ck5hbWVzID0gdmFsdWUgJiYgdmFsdWUubWF0Y2goIGNvcmVfcm5vdHdoaXRlICk7CgogICAgaWYgKCBhdHRyTmFtZXMgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKICAgICAgd2hpbGUgKCAobmFtZSA9IGF0dHJOYW1lc1tpKytdKSApIHsKICAgICAgICBwcm9wTmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCiAgICAgICAgLy8gQm9vbGVhbiBhdHRyaWJ1dGVzIGdldCBzcGVjaWFsIHRyZWF0bWVudCAoIzEwODcwKQogICAgICAgIGlmICggcmJvb2xlYW4udGVzdCggbmFtZSApICkgewogICAgICAgICAgLy8gU2V0IGNvcnJlc3BvbmRpbmcgcHJvcGVydHkgdG8gZmFsc2UgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwogICAgICAgICAgLy8gQWxzbyBjbGVhciBkZWZhdWx0Q2hlY2tlZC9kZWZhdWx0U2VsZWN0ZWQgKGlmIGFwcHJvcHJpYXRlKSBmb3IgSUU8OAogICAgICAgICAgaWYgKCAhZ2V0U2V0QXR0cmlidXRlICYmIHJ1c2VEZWZhdWx0LnRlc3QoIG5hbWUgKSApIHsKICAgICAgICAgICAgZWxlbVsgalF1ZXJ5LmNhbWVsQ2FzZSggImRlZmF1bHQtIiArIG5hbWUgKSBdID0KICAgICAgICAgICAgICBlbGVtWyBwcm9wTmFtZSBdID0gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtWyBwcm9wTmFtZSBdID0gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgIC8vIFNlZSAjOTY5OSBmb3IgZXhwbGFuYXRpb24gb2YgdGhpcyBhcHByb2FjaCAoc2V0dGluZyBmaXJzdCwgdGhlbiByZW1vdmFsKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBqUXVlcnkuYXR0ciggZWxlbSwgbmFtZSwgIiIgKTsKICAgICAgICB9CgogICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKCBnZXRTZXRBdHRyaWJ1dGUgPyBuYW1lIDogcHJvcE5hbWUgKTsKICAgICAgfQogICAgfQogIH0sCgogIGF0dHJIb29rczogewogICAgdHlwZTogewogICAgICBzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKICAgICAgICBpZiAoICFqUXVlcnkuc3VwcG9ydC5yYWRpb1ZhbHVlICYmIHZhbHVlID09PSAicmFkaW8iICYmIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAiaW5wdXQiKSApIHsKICAgICAgICAgIC8vIFNldHRpbmcgdGhlIHR5cGUgb24gYSByYWRpbyBidXR0b24gYWZ0ZXIgdGhlIHZhbHVlIHJlc2V0cyB0aGUgdmFsdWUgaW4gSUU2LTkKICAgICAgICAgIC8vIFJlc2V0IHZhbHVlIHRvIGRlZmF1bHQgaW4gY2FzZSB0eXBlIGlzIHNldCBhZnRlciB2YWx1ZSBkdXJpbmcgY3JlYXRpb24KICAgICAgICAgIHZhciB2YWwgPSBlbGVtLnZhbHVlOwogICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgdmFsdWUgKTsKICAgICAgICAgIGlmICggdmFsICkgewogICAgICAgICAgICBlbGVtLnZhbHVlID0gdmFsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sCgogIHByb3BGaXg6IHsKICAgIHRhYmluZGV4OiAidGFiSW5kZXgiLAogICAgcmVhZG9ubHk6ICJyZWFkT25seSIsCiAgICAiZm9yIjogImh0bWxGb3IiLAogICAgImNsYXNzIjogImNsYXNzTmFtZSIsCiAgICBtYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAogICAgY2VsbHNwYWNpbmc6ICJjZWxsU3BhY2luZyIsCiAgICBjZWxscGFkZGluZzogImNlbGxQYWRkaW5nIiwKICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgIGNvbHNwYW46ICJjb2xTcGFuIiwKICAgIHVzZW1hcDogInVzZU1hcCIsCiAgICBmcmFtZWJvcmRlcjogImZyYW1lQm9yZGVyIiwKICAgIGNvbnRlbnRlZGl0YWJsZTogImNvbnRlbnRFZGl0YWJsZSIKICB9LAoKICBwcm9wOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CiAgICB2YXIgcmV0LCBob29rcywgbm90eG1sLAogICAgICBuVHlwZSA9IGVsZW0ubm9kZVR5cGU7CgogICAgLy8gZG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwogICAgaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIG5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKTsKCiAgICBpZiAoIG5vdHhtbCApIHsKICAgICAgLy8gRml4IG5hbWUgYW5kIGF0dGFjaCBob29rcwogICAgICBuYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwogICAgICBob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXTsKICAgIH0KCiAgICBpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CiAgICAgIGlmICggaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSkgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICByZXR1cm4gcmV0OwoKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gKCBlbGVtWyBuYW1lIF0gPSB2YWx1ZSApOwogICAgICB9CgogICAgfSBlbHNlIHsKICAgICAgaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkpICE9PSBudWxsICkgewogICAgICAgIHJldHVybiByZXQ7CgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBlbGVtWyBuYW1lIF07CiAgICAgIH0KICAgIH0KICB9LAoKICBwcm9wSG9va3M6IHsKICAgIHRhYkluZGV4OiB7CiAgICAgIGdldDogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgLy8gZWxlbS50YWJJbmRleCBkb2Vzbid0IGFsd2F5cyByZXR1cm4gdGhlIGNvcnJlY3QgdmFsdWUgd2hlbiBpdCBoYXNuJ3QgYmVlbiBleHBsaWNpdGx5IHNldAogICAgICAgIC8vIGh0dHA6Ly9mbHVpZHByb2plY3Qub3JnL2Jsb2cvMjAwOC8wMS8wOS9nZXR0aW5nLXNldHRpbmctYW5kLXJlbW92aW5nLXRhYmluZGV4LXZhbHVlcy13aXRoLWphdmFzY3JpcHQvCiAgICAgICAgdmFyIGF0dHJpYnV0ZU5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoInRhYmluZGV4Iik7CgogICAgICAgIHJldHVybiBhdHRyaWJ1dGVOb2RlICYmIGF0dHJpYnV0ZU5vZGUuc3BlY2lmaWVkID8KICAgICAgICAgIHBhcnNlSW50KCBhdHRyaWJ1dGVOb2RlLnZhbHVlLCAxMCApIDoKICAgICAgICAgIHJmb2N1c2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApIHx8IHJjbGlja2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApICYmIGVsZW0uaHJlZiA/CiAgICAgICAgICAgIDAgOgogICAgICAgICAgICB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0KICB9Cn0pOwoKLy8gSG9vayBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCmJvb2xIb29rID0gewogIGdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CiAgICB2YXIKICAgICAgLy8gVXNlIC5wcm9wIHRvIGRldGVybWluZSBpZiB0aGlzIGF0dHJpYnV0ZSBpcyB1bmRlcnN0b29kIGFzIGJvb2xlYW4KICAgICAgcHJvcCA9IGpRdWVyeS5wcm9wKCBlbGVtLCBuYW1lICksCgogICAgICAvLyBGZXRjaCBpdCBhY2NvcmRpbmdseQogICAgICBhdHRyID0gdHlwZW9mIHByb3AgPT09ICJib29sZWFuIiAmJiBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApLAogICAgICBkZXRhaWwgPSB0eXBlb2YgcHJvcCA9PT0gImJvb2xlYW4iID8KCiAgICAgICAgZ2V0U2V0SW5wdXQgJiYgZ2V0U2V0QXR0cmlidXRlID8KICAgICAgICAgIGF0dHIgIT0gbnVsbCA6CiAgICAgICAgICAvLyBvbGRJRSBmYWJyaWNhdGVzIGFuIGVtcHR5IHN0cmluZyBmb3IgbWlzc2luZyBib29sZWFuIGF0dHJpYnV0ZXMKICAgICAgICAgIC8vIGFuZCBjb25mbGF0ZXMgY2hlY2tlZC9zZWxlY3RlZCBpbnRvIGF0dHJvcGVydGllcwogICAgICAgICAgcnVzZURlZmF1bHQudGVzdCggbmFtZSApID8KICAgICAgICAgICAgZWxlbVsgalF1ZXJ5LmNhbWVsQ2FzZSggImRlZmF1bHQtIiArIG5hbWUgKSBdIDoKICAgICAgICAgICAgISFhdHRyIDoKCiAgICAgICAgLy8gZmV0Y2ggYW4gYXR0cmlidXRlIG5vZGUgZm9yIHByb3BlcnRpZXMgbm90IHJlY29nbml6ZWQgYXMgYm9vbGVhbgogICAgICAgIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApOwoKICAgIHJldHVybiBkZXRhaWwgJiYgZGV0YWlsLnZhbHVlICE9PSBmYWxzZSA/CiAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSA6CiAgICAgIHVuZGVmaW5lZDsKICB9LAogIHNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewogICAgaWYgKCB2YWx1ZSA9PT0gZmFsc2UgKSB7CiAgICAgIC8vIFJlbW92ZSBib29sZWFuIGF0dHJpYnV0ZXMgd2hlbiBzZXQgdG8gZmFsc2UKICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIoIGVsZW0sIG5hbWUgKTsKICAgIH0gZWxzZSBpZiAoIGdldFNldElucHV0ICYmIGdldFNldEF0dHJpYnV0ZSB8fCAhcnVzZURlZmF1bHQudGVzdCggbmFtZSApICkgewogICAgICAvLyBJRTw4IG5lZWRzIHRoZSAqcHJvcGVydHkqIG5hbWUKICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoICFnZXRTZXRBdHRyaWJ1dGUgJiYgalF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lLCBuYW1lICk7CgogICAgLy8gVXNlIGRlZmF1bHRDaGVja2VkIGFuZCBkZWZhdWx0U2VsZWN0ZWQgZm9yIG9sZElFCiAgICB9IGVsc2UgewogICAgICBlbGVtWyBqUXVlcnkuY2FtZWxDYXNlKCAiZGVmYXVsdC0iICsgbmFtZSApIF0gPSBlbGVtWyBuYW1lIF0gPSB0cnVlOwogICAgfQoKICAgIHJldHVybiBuYW1lOwogIH0KfTsKCi8vIGZpeCBvbGRJRSB2YWx1ZSBhdHRyb3BlcnR5CmlmICggIWdldFNldElucHV0IHx8ICFnZXRTZXRBdHRyaWJ1dGUgKSB7CiAgalF1ZXJ5LmF0dHJIb29rcy52YWx1ZSA9IHsKICAgIGdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CiAgICAgIHZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKICAgICAgcmV0dXJuIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImlucHV0IiApID8KCiAgICAgICAgLy8gSWdub3JlIHRoZSB2YWx1ZSAqcHJvcGVydHkqIGJ5IHVzaW5nIGRlZmF1bHRWYWx1ZQogICAgICAgIGVsZW0uZGVmYXVsdFZhbHVlIDoKCiAgICAgICAgcmV0ICYmIHJldC5zcGVjaWZpZWQgPyByZXQudmFsdWUgOiB1bmRlZmluZWQ7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7CiAgICAgIGlmICggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaW5wdXQiICkgKSB7CiAgICAgICAgLy8gRG9lcyBub3QgcmV0dXJuIHNvIHRoYXQgc2V0QXR0cmlidXRlIGlzIGFsc28gdXNlZAogICAgICAgIGVsZW0uZGVmYXVsdFZhbHVlID0gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVXNlIG5vZGVIb29rIGlmIGRlZmluZWQgKCMxOTU0KTsgb3RoZXJ3aXNlIHNldEF0dHJpYnV0ZSBpcyBmaW5lCiAgICAgICAgcmV0dXJuIG5vZGVIb29rICYmIG5vZGVIb29rLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKTsKICAgICAgfQogICAgfQogIH07Cn0KCi8vIElFNi83IGRvIG5vdCBzdXBwb3J0IGdldHRpbmcvc2V0dGluZyBzb21lIGF0dHJpYnV0ZXMgd2l0aCBnZXQvc2V0QXR0cmlidXRlCmlmICggIWdldFNldEF0dHJpYnV0ZSApIHsKCiAgLy8gVXNlIHRoaXMgZm9yIGFueSBhdHRyaWJ1dGUgaW4gSUU2LzcKICAvLyBUaGlzIGZpeGVzIGFsbW9zdCBldmVyeSBJRTYvNyBpc3N1ZQogIG5vZGVIb29rID0galF1ZXJ5LnZhbEhvb2tzLmJ1dHRvbiA9IHsKICAgIGdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CiAgICAgIHZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKICAgICAgcmV0dXJuIHJldCAmJiAoIG5hbWUgPT09ICJpZCIgfHwgbmFtZSA9PT0gIm5hbWUiIHx8IG5hbWUgPT09ICJjb29yZHMiID8gcmV0LnZhbHVlICE9PSAiIiA6IHJldC5zcGVjaWZpZWQgKSA/CiAgICAgICAgcmV0LnZhbHVlIDoKICAgICAgICB1bmRlZmluZWQ7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7CiAgICAgIC8vIFNldCB0aGUgZXhpc3Rpbmcgb3IgY3JlYXRlIGEgbmV3IGF0dHJpYnV0ZSBub2RlCiAgICAgIHZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKICAgICAgaWYgKCAhcmV0ICkgewogICAgICAgIGVsZW0uc2V0QXR0cmlidXRlTm9kZSgKICAgICAgICAgIChyZXQgPSBlbGVtLm93bmVyRG9jdW1lbnQuY3JlYXRlQXR0cmlidXRlKCBuYW1lICkpCiAgICAgICAgKTsKICAgICAgfQoKICAgICAgcmV0LnZhbHVlID0gdmFsdWUgKz0gIiI7CgogICAgICAvLyBCcmVhayBhc3NvY2lhdGlvbiB3aXRoIGNsb25lZCBlbGVtZW50cyBieSBhbHNvIHVzaW5nIHNldEF0dHJpYnV0ZSAoIzk2NDYpCiAgICAgIHJldHVybiBuYW1lID09PSAidmFsdWUiIHx8IHZhbHVlID09PSBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApID8KICAgICAgICB2YWx1ZSA6CiAgICAgICAgdW5kZWZpbmVkOwogICAgfQogIH07CgogIC8vIFNldCBjb250ZW50ZWRpdGFibGUgdG8gZmFsc2Ugb24gcmVtb3ZhbHMoIzEwNDI5KQogIC8vIFNldHRpbmcgdG8gZW1wdHkgc3RyaW5nIHRocm93cyBhbiBlcnJvciBhcyBhbiBpbnZhbGlkIHZhbHVlCiAgalF1ZXJ5LmF0dHJIb29rcy5jb250ZW50ZWRpdGFibGUgPSB7CiAgICBnZXQ6IG5vZGVIb29rLmdldCwKICAgIHNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewogICAgICBub2RlSG9vay5zZXQoIGVsZW0sIHZhbHVlID09PSAiIiA/IGZhbHNlIDogdmFsdWUsIG5hbWUgKTsKICAgIH0KICB9OwoKICAvLyBTZXQgd2lkdGggYW5kIGhlaWdodCB0byBhdXRvIGluc3RlYWQgb2YgMCBvbiBlbXB0eSBzdHJpbmcoIEJ1ZyAjODE1MCApCiAgLy8gVGhpcyBpcyBmb3IgcmVtb3ZhbHMKICBqUXVlcnkuZWFjaChbICJ3aWR0aCIsICJoZWlnaHQiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewogICAgalF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggalF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdLCB7CiAgICAgIHNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewogICAgICAgIGlmICggdmFsdWUgPT09ICIiICkgewogICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsICJhdXRvIiApOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSk7Cn0KCgovLyBTb21lIGF0dHJpYnV0ZXMgcmVxdWlyZSBhIHNwZWNpYWwgY2FsbCBvbiBJRQovLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4CmlmICggIWpRdWVyeS5zdXBwb3J0LmhyZWZOb3JtYWxpemVkICkgewogIGpRdWVyeS5lYWNoKFsgImhyZWYiLCAic3JjIiwgIndpZHRoIiwgImhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CiAgICBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gPSBqUXVlcnkuZXh0ZW5kKCBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0sIHsKICAgICAgZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICB2YXIgcmV0ID0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIDIgKTsKICAgICAgICByZXR1cm4gcmV0ID09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICAgIH0KICAgIH0pOwogIH0pOwoKICAvLyBocmVmL3NyYyBwcm9wZXJ0eSBzaG91bGQgZ2V0IHRoZSBmdWxsIG5vcm1hbGl6ZWQgVVJMICgjMTAyOTkvIzEyOTE1KQogIGpRdWVyeS5lYWNoKFsgImhyZWYiLCAic3JjIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKICAgIGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXSA9IHsKICAgICAgZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIDQgKTsKICAgICAgfQogICAgfTsKICB9KTsKfQoKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuc3R5bGUgKSB7CiAgalF1ZXJ5LmF0dHJIb29rcy5zdHlsZSA9IHsKICAgIGdldDogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIC8vIFJldHVybiB1bmRlZmluZWQgaW4gdGhlIGNhc2Ugb2YgZW1wdHkgc3RyaW5nCiAgICAgIC8vIE5vdGU6IElFIHVwcGVyY2FzZXMgY3NzIHByb3BlcnR5IG5hbWVzLCBidXQgaWYgd2Ugd2VyZSB0byAudG9Mb3dlckNhc2UoKQogICAgICAvLyAuY3NzVGV4dCwgdGhhdCB3b3VsZCBkZXN0cm95IGNhc2Ugc2Vuc3RpdGl2aXR5IGluIFVSTCdzLCBsaWtlIGluICJiYWNrZ3JvdW5kIgogICAgICByZXR1cm4gZWxlbS5zdHlsZS5jc3NUZXh0IHx8IHVuZGVmaW5lZDsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKICAgICAgcmV0dXJuICggZWxlbS5zdHlsZS5jc3NUZXh0ID0gdmFsdWUgKyAiIiApOwogICAgfQogIH07Cn0KCi8vIFNhZmFyaSBtaXMtcmVwb3J0cyB0aGUgZGVmYXVsdCBzZWxlY3RlZCBwcm9wZXJ0eSBvZiBhbiBvcHRpb24KLy8gQWNjZXNzaW5nIHRoZSBwYXJlbnQncyBzZWxlY3RlZEluZGV4IHByb3BlcnR5IGZpeGVzIGl0CmlmICggIWpRdWVyeS5zdXBwb3J0Lm9wdFNlbGVjdGVkICkgewogIGpRdWVyeS5wcm9wSG9va3Muc2VsZWN0ZWQgPSBqUXVlcnkuZXh0ZW5kKCBqUXVlcnkucHJvcEhvb2tzLnNlbGVjdGVkLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoKICAgICAgaWYgKCBwYXJlbnQgKSB7CiAgICAgICAgcGFyZW50LnNlbGVjdGVkSW5kZXg7CgogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGl0IGFsc28gd29ya3Mgd2l0aCBvcHRncm91cHMsIHNlZSAjNTcwMQogICAgICAgIGlmICggcGFyZW50LnBhcmVudE5vZGUgKSB7CiAgICAgICAgICBwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9KTsKfQoKLy8gSUU2LzcgY2FsbCBlbmN0eXBlIGVuY29kaW5nCmlmICggIWpRdWVyeS5zdXBwb3J0LmVuY3R5cGUgKSB7CiAgalF1ZXJ5LnByb3BGaXguZW5jdHlwZSA9ICJlbmNvZGluZyI7Cn0KCi8vIFJhZGlvcyBhbmQgY2hlY2tib3hlcyBnZXR0ZXIvc2V0dGVyCmlmICggIWpRdWVyeS5zdXBwb3J0LmNoZWNrT24gKSB7CiAgalF1ZXJ5LmVhY2goWyAicmFkaW8iLCAiY2hlY2tib3giIF0sIGZ1bmN0aW9uKCkgewogICAgalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0gPSB7CiAgICAgIGdldDogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIGluIFdlYmtpdCAiIiBpcyByZXR1cm5lZCBpbnN0ZWFkIG9mICJvbiIgaWYgYSB2YWx1ZSBpc24ndCBzcGVjaWZpZWQKICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInZhbHVlIikgPT09IG51bGwgPyAib24iIDogZWxlbS52YWx1ZTsKICAgICAgfQogICAgfTsKICB9KTsKfQpqUXVlcnkuZWFjaChbICJyYWRpbyIsICJjaGVja2JveCIgXSwgZnVuY3Rpb24oKSB7CiAgalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0gPSBqUXVlcnkuZXh0ZW5kKCBqUXVlcnkudmFsSG9va3NbIHRoaXMgXSwgewogICAgc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CiAgICAgIGlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbHVlICkgKSB7CiAgICAgICAgcmV0dXJuICggZWxlbS5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoIGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUgKSA+PSAwICk7CiAgICAgIH0KICAgIH0KICB9KTsKfSk7CnZhciByZm9ybUVsZW1zID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWEpJC9pLAogIHJrZXlFdmVudCA9IC9ea2V5LywKICBybW91c2VFdmVudCA9IC9eKD86bW91c2V8Y29udGV4dG1lbnUpfGNsaWNrLywKICByZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywKICBydHlwZW5hbWVzcGFjZSA9IC9eKFteLl0qKSg/OlwuKC4rKXwpJC87CgpmdW5jdGlvbiByZXR1cm5UcnVlKCkgewogIHJldHVybiB0cnVlOwp9CgpmdW5jdGlvbiByZXR1cm5GYWxzZSgpIHsKICByZXR1cm4gZmFsc2U7Cn0KCi8qCiAqIEhlbHBlciBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIGV2ZW50cyAtLSBub3QgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4KICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICovCmpRdWVyeS5ldmVudCA9IHsKCiAgZ2xvYmFsOiB7fSwKCiAgYWRkOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yICkgewoKICAgIHZhciBoYW5kbGVPYmpJbiwgZXZlbnRIYW5kbGUsIHRtcCwKICAgICAgZXZlbnRzLCB0LCBoYW5kbGVPYmosCiAgICAgIHNwZWNpYWwsIGhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwKICAgICAgLy8gRG9uJ3QgYXR0YWNoIGV2ZW50cyB0byBub0RhdGEgb3IgdGV4dC9jb21tZW50IG5vZGVzIChidXQgYWxsb3cgcGxhaW4gb2JqZWN0cykKICAgICAgZWxlbURhdGEgPSBlbGVtLm5vZGVUeXBlICE9PSAzICYmIGVsZW0ubm9kZVR5cGUgIT09IDggJiYgalF1ZXJ5Ll9kYXRhKCBlbGVtICk7CgogICAgaWYgKCAhZWxlbURhdGEgKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYW4gb2JqZWN0IG9mIGN1c3RvbSBkYXRhIGluIGxpZXUgb2YgdGhlIGhhbmRsZXIKICAgIGlmICggaGFuZGxlci5oYW5kbGVyICkgewogICAgICBoYW5kbGVPYmpJbiA9IGhhbmRsZXI7CiAgICAgIGhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwogICAgICBzZWxlY3RvciA9IGhhbmRsZU9iakluLnNlbGVjdG9yOwogICAgfQoKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBoYW5kbGVyIGhhcyBhIHVuaXF1ZSBJRCwgdXNlZCB0byBmaW5kL3JlbW92ZSBpdCBsYXRlcgogICAgaWYgKCAhaGFuZGxlci5ndWlkICkgewogICAgICBoYW5kbGVyLmd1aWQgPSBqUXVlcnkuZ3VpZCsrOwogICAgfQoKICAgIC8vIEluaXQgdGhlIGVsZW1lbnQncyBldmVudCBzdHJ1Y3R1cmUgYW5kIG1haW4gaGFuZGxlciwgaWYgdGhpcyBpcyB0aGUgZmlyc3QKICAgIGlmICggIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpICkgewogICAgICBldmVudHMgPSBlbGVtRGF0YS5ldmVudHMgPSB7fTsKICAgIH0KICAgIGlmICggIShldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSkgKSB7CiAgICAgIGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlID0gZnVuY3Rpb24oIGUgKSB7CiAgICAgICAgLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKICAgICAgICAvLyB3aGVuIGFuIGV2ZW50IGlzIGNhbGxlZCBhZnRlciBhIHBhZ2UgaGFzIHVubG9hZGVkCiAgICAgICAgcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT09ICJ1bmRlZmluZWQiICYmICghZSB8fCBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUpID8KICAgICAgICAgIGpRdWVyeS5ldmVudC5kaXNwYXRjaC5hcHBseSggZXZlbnRIYW5kbGUuZWxlbSwgYXJndW1lbnRzICkgOgogICAgICAgICAgdW5kZWZpbmVkOwogICAgICB9OwogICAgICAvLyBBZGQgZWxlbSBhcyBhIHByb3BlcnR5IG9mIHRoZSBoYW5kbGUgZm4gdG8gcHJldmVudCBhIG1lbW9yeSBsZWFrIHdpdGggSUUgbm9uLW5hdGl2ZSBldmVudHMKICAgICAgZXZlbnRIYW5kbGUuZWxlbSA9IGVsZW07CiAgICB9CgogICAgLy8gSGFuZGxlIG11bHRpcGxlIGV2ZW50cyBzZXBhcmF0ZWQgYnkgYSBzcGFjZQogICAgLy8galF1ZXJ5KC4uLikuYmluZCgibW91c2VvdmVyIG1vdXNlb3V0IiwgZm4pOwogICAgdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgWyIiXTsKICAgIHQgPSB0eXBlcy5sZW5ndGg7CiAgICB3aGlsZSAoIHQtLSApIHsKICAgICAgdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKICAgICAgdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwogICAgICBuYW1lc3BhY2VzID0gKCB0bXBbMl0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKICAgICAgLy8gSWYgZXZlbnQgY2hhbmdlcyBpdHMgdHlwZSwgdXNlIHRoZSBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgY2hhbmdlZCB0eXBlCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoKICAgICAgLy8gSWYgc2VsZWN0b3IgZGVmaW5lZCwgZGV0ZXJtaW5lIHNwZWNpYWwgZXZlbnQgYXBpIHR5cGUsIG90aGVyd2lzZSBnaXZlbiB0eXBlCiAgICAgIHR5cGUgPSAoIHNlbGVjdG9yID8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlICkgfHwgdHlwZTsKCiAgICAgIC8vIFVwZGF0ZSBzcGVjaWFsIGJhc2VkIG9uIG5ld2x5IHJlc2V0IHR5cGUKICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgogICAgICAvLyBoYW5kbGVPYmogaXMgcGFzc2VkIHRvIGFsbCBldmVudCBoYW5kbGVycwogICAgICBoYW5kbGVPYmogPSBqUXVlcnkuZXh0ZW5kKHsKICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgIG9yaWdUeXBlOiBvcmlnVHlwZSwKICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgZ3VpZDogaGFuZGxlci5ndWlkLAogICAgICAgIHNlbGVjdG9yOiBzZWxlY3RvciwKICAgICAgICBuZWVkc0NvbnRleHQ6IHNlbGVjdG9yICYmIGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KCBzZWxlY3RvciApLAogICAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlcy5qb2luKCIuIikKICAgICAgfSwgaGFuZGxlT2JqSW4gKTsKCiAgICAgIC8vIEluaXQgdGhlIGV2ZW50IGhhbmRsZXIgcXVldWUgaWYgd2UncmUgdGhlIGZpcnN0CiAgICAgIGlmICggIShoYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdKSApIHsKICAgICAgICBoYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdID0gW107CiAgICAgICAgaGFuZGxlcnMuZGVsZWdhdGVDb3VudCA9IDA7CgogICAgICAgIC8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIvYXR0YWNoRXZlbnQgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQogICAgICAgIGlmICggIXNwZWNpYWwuc2V0dXAgfHwgc3BlY2lhbC5zZXR1cC5jYWxsKCBlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSApID09PSBmYWxzZSApIHsKICAgICAgICAgIC8vIEJpbmQgdGhlIGdsb2JhbCBldmVudCBoYW5kbGVyIHRvIHRoZSBlbGVtZW50CiAgICAgICAgICBpZiAoIGVsZW0uYWRkRXZlbnRMaXN0ZW5lciApIHsKICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBldmVudEhhbmRsZSwgZmFsc2UgKTsKCiAgICAgICAgICB9IGVsc2UgaWYgKCBlbGVtLmF0dGFjaEV2ZW50ICkgewogICAgICAgICAgICBlbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZXZlbnRIYW5kbGUgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICggc3BlY2lhbC5hZGQgKSB7CiAgICAgICAgc3BlY2lhbC5hZGQuY2FsbCggZWxlbSwgaGFuZGxlT2JqICk7CgogICAgICAgIGlmICggIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgKSB7CiAgICAgICAgICBoYW5kbGVPYmouaGFuZGxlci5ndWlkID0gaGFuZGxlci5ndWlkOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQWRkIHRvIHRoZSBlbGVtZW50J3MgaGFuZGxlciBsaXN0LCBkZWxlZ2F0ZXMgaW4gZnJvbnQKICAgICAgaWYgKCBzZWxlY3RvciApIHsKICAgICAgICBoYW5kbGVycy5zcGxpY2UoIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQrKywgMCwgaGFuZGxlT2JqICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlcnMucHVzaCggaGFuZGxlT2JqICk7CiAgICAgIH0KCiAgICAgIC8vIEtlZXAgdHJhY2sgb2Ygd2hpY2ggZXZlbnRzIGhhdmUgZXZlciBiZWVuIHVzZWQsIGZvciBldmVudCBvcHRpbWl6YXRpb24KICAgICAgalF1ZXJ5LmV2ZW50Lmdsb2JhbFsgdHlwZSBdID0gdHJ1ZTsKICAgIH0KCiAgICAvLyBOdWxsaWZ5IGVsZW0gdG8gcHJldmVudCBtZW1vcnkgbGVha3MgaW4gSUUKICAgIGVsZW0gPSBudWxsOwogIH0sCgogIC8vIERldGFjaCBhbiBldmVudCBvciBzZXQgb2YgZXZlbnRzIGZyb20gYW4gZWxlbWVudAogIHJlbW92ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBzZWxlY3RvciwgbWFwcGVkVHlwZXMgKSB7CgogICAgdmFyIGosIG9yaWdDb3VudCwgdG1wLAogICAgICBldmVudHMsIHQsIGhhbmRsZU9iaiwKICAgICAgc3BlY2lhbCwgaGFuZGxlcnMsIHR5cGUsIG5hbWVzcGFjZXMsIG9yaWdUeXBlLAogICAgICBlbGVtRGF0YSA9IGpRdWVyeS5oYXNEYXRhKCBlbGVtICkgJiYgalF1ZXJ5Ll9kYXRhKCBlbGVtICk7CgogICAgaWYgKCAhZWxlbURhdGEgfHwgIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpICkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZAogICAgdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgWyIiXTsKICAgIHQgPSB0eXBlcy5sZW5ndGg7CiAgICB3aGlsZSAoIHQtLSApIHsKICAgICAgdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKICAgICAgdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwogICAgICBuYW1lc3BhY2VzID0gKCB0bXBbMl0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKICAgICAgLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CiAgICAgIGlmICggIXR5cGUgKSB7CiAgICAgICAgZm9yICggdHlwZSBpbiBldmVudHMgKSB7CiAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICsgdHlwZXNbIHQgXSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUgKTsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwogICAgICB0eXBlID0gKCBzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSApIHx8IHR5cGU7CiAgICAgIGhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gfHwgW107CiAgICAgIHRtcCA9IHRtcFsyXSAmJiBuZXcgUmVnRXhwKCAiKF58XFwuKSIgKyBuYW1lc3BhY2VzLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIiApOwoKICAgICAgLy8gUmVtb3ZlIG1hdGNoaW5nIGV2ZW50cwogICAgICBvcmlnQ291bnQgPSBqID0gaGFuZGxlcnMubGVuZ3RoOwogICAgICB3aGlsZSAoIGotLSApIHsKICAgICAgICBoYW5kbGVPYmogPSBoYW5kbGVyc1sgaiBdOwoKICAgICAgICBpZiAoICggbWFwcGVkVHlwZXMgfHwgb3JpZ1R5cGUgPT09IGhhbmRsZU9iai5vcmlnVHlwZSApICYmCiAgICAgICAgICAoICFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSAmJgogICAgICAgICAgKCAhdG1wIHx8IHRtcC50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSAmJgogICAgICAgICAgKCAhc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09IGhhbmRsZU9iai5zZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gIioqIiAmJiBoYW5kbGVPYmouc2VsZWN0b3IgKSApIHsKICAgICAgICAgIGhhbmRsZXJzLnNwbGljZSggaiwgMSApOwoKICAgICAgICAgIGlmICggaGFuZGxlT2JqLnNlbGVjdG9yICkgewogICAgICAgICAgICBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LS07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIHNwZWNpYWwucmVtb3ZlICkgewogICAgICAgICAgICBzcGVjaWFsLnJlbW92ZS5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgd2UgcmVtb3ZlZCBzb21ldGhpbmcgYW5kIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKICAgICAgLy8gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGVuZGxlc3MgcmVjdXJzaW9uIGR1cmluZyByZW1vdmFsIG9mIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMpCiAgICAgIGlmICggb3JpZ0NvdW50ICYmICFoYW5kbGVycy5sZW5ndGggKSB7CiAgICAgICAgaWYgKCAhc3BlY2lhbC50ZWFyZG93biB8fCBzcGVjaWFsLnRlYXJkb3duLmNhbGwoIGVsZW0sIG5hbWVzcGFjZXMsIGVsZW1EYXRhLmhhbmRsZSApID09PSBmYWxzZSApIHsKICAgICAgICAgIGpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlICk7CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgZXZlbnRzWyB0eXBlIF07CiAgICAgIH0KICAgIH0KCiAgICAvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAogICAgaWYgKCBqUXVlcnkuaXNFbXB0eU9iamVjdCggZXZlbnRzICkgKSB7CiAgICAgIGRlbGV0ZSBlbGVtRGF0YS5oYW5kbGU7CgogICAgICAvLyByZW1vdmVEYXRhIGFsc28gY2hlY2tzIGZvciBlbXB0aW5lc3MgYW5kIGNsZWFycyB0aGUgZXhwYW5kbyBpZiBlbXB0eQogICAgICAvLyBzbyB1c2UgaXQgaW5zdGVhZCBvZiBkZWxldGUKICAgICAgalF1ZXJ5Ll9yZW1vdmVEYXRhKCBlbGVtLCAiZXZlbnRzIiApOwogICAgfQogIH0sCgogIHRyaWdnZXI6IGZ1bmN0aW9uKCBldmVudCwgZGF0YSwgZWxlbSwgb25seUhhbmRsZXJzICkgewoKICAgIHZhciBpLCBjdXIsIHRtcCwgYnViYmxlVHlwZSwgb250eXBlLCBoYW5kbGUsIHNwZWNpYWwsCiAgICAgIGV2ZW50UGF0aCA9IFsgZWxlbSB8fCBkb2N1bWVudCBdLAogICAgICB0eXBlID0gZXZlbnQudHlwZSB8fCBldmVudCwKICAgICAgbmFtZXNwYWNlcyA9IGV2ZW50Lm5hbWVzcGFjZSA/IGV2ZW50Lm5hbWVzcGFjZS5zcGxpdCgiLiIpIDogW107CgogICAgY3VyID0gdG1wID0gZWxlbSA9IGVsZW0gfHwgZG9jdW1lbnQ7CgogICAgLy8gRG9uJ3QgZG8gZXZlbnRzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gZm9jdXMvYmx1ciBtb3JwaHMgdG8gZm9jdXNpbi9vdXQ7IGVuc3VyZSB3ZSdyZSBub3QgZmlyaW5nIHRoZW0gcmlnaHQgbm93CiAgICBpZiAoIHJmb2N1c01vcnBoLnRlc3QoIHR5cGUgKyBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICkgKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoIHR5cGUuaW5kZXhPZigiLiIpID49IDAgKSB7CiAgICAgIC8vIE5hbWVzcGFjZWQgdHJpZ2dlcjsgY3JlYXRlIGEgcmVnZXhwIHRvIG1hdGNoIGV2ZW50IHR5cGUgaW4gaGFuZGxlKCkKICAgICAgbmFtZXNwYWNlcyA9IHR5cGUuc3BsaXQoIi4iKTsKICAgICAgdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsKICAgICAgbmFtZXNwYWNlcy5zb3J0KCk7CiAgICB9CiAgICBvbnR5cGUgPSB0eXBlLmluZGV4T2YoIjoiKSA8IDAgJiYgIm9uIiArIHR5cGU7CgogICAgLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGEgalF1ZXJ5LkV2ZW50IG9iamVjdCwgT2JqZWN0LCBvciBqdXN0IGFuIGV2ZW50IHR5cGUgc3RyaW5nCiAgICBldmVudCA9IGV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdID8KICAgICAgZXZlbnQgOgogICAgICBuZXcgalF1ZXJ5LkV2ZW50KCB0eXBlLCB0eXBlb2YgZXZlbnQgPT09ICJvYmplY3QiICYmIGV2ZW50ICk7CgogICAgZXZlbnQuaXNUcmlnZ2VyID0gdHJ1ZTsKICAgIGV2ZW50Lm5hbWVzcGFjZSA9IG5hbWVzcGFjZXMuam9pbigiLiIpOwogICAgZXZlbnQubmFtZXNwYWNlX3JlID0gZXZlbnQubmFtZXNwYWNlID8KICAgICAgbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIgKSA6CiAgICAgIG51bGw7CgogICAgLy8gQ2xlYW4gdXAgdGhlIGV2ZW50IGluIGNhc2UgaXQgaXMgYmVpbmcgcmV1c2VkCiAgICBldmVudC5yZXN1bHQgPSB1bmRlZmluZWQ7CiAgICBpZiAoICFldmVudC50YXJnZXQgKSB7CiAgICAgIGV2ZW50LnRhcmdldCA9IGVsZW07CiAgICB9CgogICAgLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAogICAgZGF0YSA9IGRhdGEgPT0gbnVsbCA/CiAgICAgIFsgZXZlbnQgXSA6CiAgICAgIGpRdWVyeS5tYWtlQXJyYXkoIGRhdGEsIFsgZXZlbnQgXSApOwoKICAgIC8vIEFsbG93IHNwZWNpYWwgZXZlbnRzIHRvIGRyYXcgb3V0c2lkZSB0aGUgbGluZXMKICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwogICAgaWYgKCAhb25seUhhbmRsZXJzICYmIHNwZWNpYWwudHJpZ2dlciAmJiBzcGVjaWFsLnRyaWdnZXIuYXBwbHkoIGVsZW0sIGRhdGEgKSA9PT0gZmFsc2UgKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBEZXRlcm1pbmUgZXZlbnQgcHJvcGFnYXRpb24gcGF0aCBpbiBhZHZhbmNlLCBwZXIgVzNDIGV2ZW50cyBzcGVjICgjOTk1MSkKICAgIC8vIEJ1YmJsZSB1cCB0byBkb2N1bWVudCwgdGhlbiB0byB3aW5kb3c7IHdhdGNoIGZvciBhIGdsb2JhbCBvd25lckRvY3VtZW50IHZhciAoIzk3MjQpCiAgICBpZiAoICFvbmx5SGFuZGxlcnMgJiYgIXNwZWNpYWwubm9CdWJibGUgJiYgIWpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoKICAgICAgYnViYmxlVHlwZSA9IHNwZWNpYWwuZGVsZWdhdGVUeXBlIHx8IHR5cGU7CiAgICAgIGlmICggIXJmb2N1c01vcnBoLnRlc3QoIGJ1YmJsZVR5cGUgKyB0eXBlICkgKSB7CiAgICAgICAgY3VyID0gY3VyLnBhcmVudE5vZGU7CiAgICAgIH0KICAgICAgZm9yICggOyBjdXI7IGN1ciA9IGN1ci5wYXJlbnROb2RlICkgewogICAgICAgIGV2ZW50UGF0aC5wdXNoKCBjdXIgKTsKICAgICAgICB0bXAgPSBjdXI7CiAgICAgIH0KCiAgICAgIC8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQogICAgICBpZiAoIHRtcCA9PT0gKGVsZW0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCkgKSB7CiAgICAgICAgZXZlbnRQYXRoLnB1c2goIHRtcC5kZWZhdWx0VmlldyB8fCB0bXAucGFyZW50V2luZG93IHx8IHdpbmRvdyApOwogICAgICB9CiAgICB9CgogICAgLy8gRmlyZSBoYW5kbGVycyBvbiB0aGUgZXZlbnQgcGF0aAogICAgaSA9IDA7CiAgICB3aGlsZSAoIChjdXIgPSBldmVudFBhdGhbaSsrXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgogICAgICBldmVudC50eXBlID0gaSA+IDEgPwogICAgICAgIGJ1YmJsZVR5cGUgOgogICAgICAgIHNwZWNpYWwuYmluZFR5cGUgfHwgdHlwZTsKCiAgICAgIC8vIGpRdWVyeSBoYW5kbGVyCiAgICAgIGhhbmRsZSA9ICggalF1ZXJ5Ll9kYXRhKCBjdXIsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdICYmIGpRdWVyeS5fZGF0YSggY3VyLCAiaGFuZGxlIiApOwogICAgICBpZiAoIGhhbmRsZSApIHsKICAgICAgICBoYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApOwogICAgICB9CgogICAgICAvLyBOYXRpdmUgaGFuZGxlcgogICAgICBoYW5kbGUgPSBvbnR5cGUgJiYgY3VyWyBvbnR5cGUgXTsKICAgICAgaWYgKCBoYW5kbGUgJiYgalF1ZXJ5LmFjY2VwdERhdGEoIGN1ciApICYmIGhhbmRsZS5hcHBseSAmJiBoYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApID09PSBmYWxzZSApIHsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9CiAgICBldmVudC50eXBlID0gdHlwZTsKCiAgICAvLyBJZiBub2JvZHkgcHJldmVudGVkIHRoZSBkZWZhdWx0IGFjdGlvbiwgZG8gaXQgbm93CiAgICBpZiAoICFvbmx5SGFuZGxlcnMgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoKICAgICAgaWYgKCAoIXNwZWNpYWwuX2RlZmF1bHQgfHwgc3BlY2lhbC5fZGVmYXVsdC5hcHBseSggZWxlbS5vd25lckRvY3VtZW50LCBkYXRhICkgPT09IGZhbHNlKSAmJgogICAgICAgICEodHlwZSA9PT0gImNsaWNrIiAmJiBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJhIiApKSAmJiBqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewoKICAgICAgICAvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgbmFtZSBhcyB0aGUgZXZlbnQuCiAgICAgICAgLy8gQ2FuJ3QgdXNlIGFuIC5pc0Z1bmN0aW9uKCkgY2hlY2sgaGVyZSBiZWNhdXNlIElFNi83IGZhaWxzIHRoYXQgdGVzdC4KICAgICAgICAvLyBEb24ndCBkbyBkZWZhdWx0IGFjdGlvbnMgb24gd2luZG93LCB0aGF0J3Mgd2hlcmUgZ2xvYmFsIHZhcmlhYmxlcyBiZSAoIzYxNzApCiAgICAgICAgaWYgKCBvbnR5cGUgJiYgZWxlbVsgdHlwZSBdICYmICFqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsKCiAgICAgICAgICAvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCiAgICAgICAgICB0bXAgPSBlbGVtWyBvbnR5cGUgXTsKCiAgICAgICAgICBpZiAoIHRtcCApIHsKICAgICAgICAgICAgZWxlbVsgb250eXBlIF0gPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlCiAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdHlwZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGVsZW1bIHR5cGUgXSgpOwogICAgICAgICAgfSBjYXRjaCAoIGUgKSB7CiAgICAgICAgICAgIC8vIElFPDkgZGllcyBvbiBmb2N1cy9ibHVyIHRvIGhpZGRlbiBlbGVtZW50ICgjMTQ4NiwjMTI1MTgpCiAgICAgICAgICAgIC8vIG9ubHkgcmVwcm9kdWNpYmxlIG9uIHdpblhQIElFOCBuYXRpdmUsIG5vdCBJRTkgaW4gSUU4IG1vZGUKICAgICAgICAgIH0KICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CgogICAgICAgICAgaWYgKCB0bXAgKSB7CiAgICAgICAgICAgIGVsZW1bIG9udHlwZSBdID0gdG1wOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBldmVudC5yZXN1bHQ7CiAgfSwKCiAgZGlzcGF0Y2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCiAgICAvLyBNYWtlIGEgd3JpdGFibGUgalF1ZXJ5LkV2ZW50IGZyb20gdGhlIG5hdGl2ZSBldmVudCBvYmplY3QKICAgIGV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgKTsKCiAgICB2YXIgaSwgaiwgcmV0LCBtYXRjaGVkLCBoYW5kbGVPYmosCiAgICAgIGhhbmRsZXJRdWV1ZSA9IFtdLAogICAgICBhcmdzID0gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSwKICAgICAgaGFuZGxlcnMgPSAoIGpRdWVyeS5fZGF0YSggdGhpcywgImV2ZW50cyIgKSB8fCB7fSApWyBldmVudC50eXBlIF0gfHwgW10sCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgZXZlbnQudHlwZSBdIHx8IHt9OwoKICAgIC8vIFVzZSB0aGUgZml4LWVkIGpRdWVyeS5FdmVudCByYXRoZXIgdGhhbiB0aGUgKHJlYWQtb25seSkgbmF0aXZlIGV2ZW50CiAgICBhcmdzWzBdID0gZXZlbnQ7CiAgICBldmVudC5kZWxlZ2F0ZVRhcmdldCA9IHRoaXM7CgogICAgLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZAogICAgaWYgKCBzcGVjaWFsLnByZURpc3BhdGNoICYmIHNwZWNpYWwucHJlRGlzcGF0Y2guY2FsbCggdGhpcywgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBEZXRlcm1pbmUgaGFuZGxlcnMKICAgIGhhbmRsZXJRdWV1ZSA9IGpRdWVyeS5ldmVudC5oYW5kbGVycy5jYWxsKCB0aGlzLCBldmVudCwgaGFuZGxlcnMgKTsKCiAgICAvLyBSdW4gZGVsZWdhdGVzIGZpcnN0OyB0aGV5IG1heSB3YW50IHRvIHN0b3AgcHJvcGFnYXRpb24gYmVuZWF0aCB1cwogICAgaSA9IDA7CiAgICB3aGlsZSAoIChtYXRjaGVkID0gaGFuZGxlclF1ZXVlWyBpKysgXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CiAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CgogICAgICBqID0gMDsKICAgICAgd2hpbGUgKCAoaGFuZGxlT2JqID0gbWF0Y2hlZC5oYW5kbGVyc1sgaisrIF0pICYmICFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoKICAgICAgICAvLyBUcmlnZ2VyZWQgZXZlbnQgbXVzdCBlaXRoZXIgMSkgaGF2ZSBubyBuYW1lc3BhY2UsIG9yCiAgICAgICAgLy8gMikgaGF2ZSBuYW1lc3BhY2UocykgYSBzdWJzZXQgb3IgZXF1YWwgdG8gdGhvc2UgaW4gdGhlIGJvdW5kIGV2ZW50IChib3RoIGNhbiBoYXZlIG5vIG5hbWVzcGFjZSkuCiAgICAgICAgaWYgKCAhZXZlbnQubmFtZXNwYWNlX3JlIHx8IGV2ZW50Lm5hbWVzcGFjZV9yZS50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSB7CgogICAgICAgICAgZXZlbnQuaGFuZGxlT2JqID0gaGFuZGxlT2JqOwogICAgICAgICAgZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOwoKICAgICAgICAgIHJldCA9ICggKGpRdWVyeS5ldmVudC5zcGVjaWFsWyBoYW5kbGVPYmoub3JpZ1R5cGUgXSB8fCB7fSkuaGFuZGxlIHx8IGhhbmRsZU9iai5oYW5kbGVyICkKICAgICAgICAgICAgICAuYXBwbHkoIG1hdGNoZWQuZWxlbSwgYXJncyApOwoKICAgICAgICAgIGlmICggcmV0ICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgIGlmICggKGV2ZW50LnJlc3VsdCA9IHJldCkgPT09IGZhbHNlICkgewogICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBDYWxsIHRoZSBwb3N0RGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlCiAgICBpZiAoIHNwZWNpYWwucG9zdERpc3BhdGNoICkgewogICAgICBzcGVjaWFsLnBvc3REaXNwYXRjaC5jYWxsKCB0aGlzLCBldmVudCApOwogICAgfQoKICAgIHJldHVybiBldmVudC5yZXN1bHQ7CiAgfSwKCiAgaGFuZGxlcnM6IGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlcnMgKSB7CiAgICB2YXIgaSwgbWF0Y2hlcywgc2VsLCBoYW5kbGVPYmosCiAgICAgIGhhbmRsZXJRdWV1ZSA9IFtdLAogICAgICBkZWxlZ2F0ZUNvdW50ID0gaGFuZGxlcnMuZGVsZWdhdGVDb3VudCwKICAgICAgY3VyID0gZXZlbnQudGFyZ2V0OwoKICAgIC8vIEZpbmQgZGVsZWdhdGUgaGFuZGxlcnMKICAgIC8vIEJsYWNrLWhvbGUgU1ZHIDx1c2U+IGluc3RhbmNlIHRyZWVzICgjMTMxODApCiAgICAvLyBBdm9pZCBub24tbGVmdC1jbGljayBidWJibGluZyBpbiBGaXJlZm94ICgjMzg2MSkKICAgIGlmICggZGVsZWdhdGVDb3VudCAmJiBjdXIubm9kZVR5cGUgJiYgKCFldmVudC5idXR0b24gfHwgZXZlbnQudHlwZSAhPT0gImNsaWNrIikgKSB7CgogICAgICBmb3IgKCA7IGN1ciAhPSB0aGlzOyBjdXIgPSBjdXIucGFyZW50Tm9kZSB8fCB0aGlzICkgewoKICAgICAgICAvLyBEb24ndCBwcm9jZXNzIGNsaWNrcyBvbiBkaXNhYmxlZCBlbGVtZW50cyAoIzY5MTEsICM4MTY1LCAjMTEzODIsICMxMTc2NCkKICAgICAgICBpZiAoIGN1ci5kaXNhYmxlZCAhPT0gdHJ1ZSB8fCBldmVudC50eXBlICE9PSAiY2xpY2siICkgewogICAgICAgICAgbWF0Y2hlcyA9IFtdOwogICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBkZWxlZ2F0ZUNvdW50OyBpKysgKSB7CiAgICAgICAgICAgIGhhbmRsZU9iaiA9IGhhbmRsZXJzWyBpIF07CgogICAgICAgICAgICAvLyBEb24ndCBjb25mbGljdCB3aXRoIE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoIzEzMjAzKQogICAgICAgICAgICBzZWwgPSBoYW5kbGVPYmouc2VsZWN0b3IgKyAiICI7CgogICAgICAgICAgICBpZiAoIG1hdGNoZXNbIHNlbCBdID09PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgICAgbWF0Y2hlc1sgc2VsIF0gPSBoYW5kbGVPYmoubmVlZHNDb250ZXh0ID8KICAgICAgICAgICAgICAgIGpRdWVyeSggc2VsLCB0aGlzICkuaW5kZXgoIGN1ciApID49IDAgOgogICAgICAgICAgICAgICAgalF1ZXJ5LmZpbmQoIHNlbCwgdGhpcywgbnVsbCwgWyBjdXIgXSApLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIG1hdGNoZXNbIHNlbCBdICkgewogICAgICAgICAgICAgIG1hdGNoZXMucHVzaCggaGFuZGxlT2JqICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICggbWF0Y2hlcy5sZW5ndGggKSB7CiAgICAgICAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsgZWxlbTogY3VyLCBoYW5kbGVyczogbWF0Y2hlcyB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBBZGQgdGhlIHJlbWFpbmluZyAoZGlyZWN0bHktYm91bmQpIGhhbmRsZXJzCiAgICBpZiAoIGRlbGVnYXRlQ291bnQgPCBoYW5kbGVycy5sZW5ndGggKSB7CiAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsgZWxlbTogdGhpcywgaGFuZGxlcnM6IGhhbmRsZXJzLnNsaWNlKCBkZWxlZ2F0ZUNvdW50ICkgfSk7CiAgICB9CgogICAgcmV0dXJuIGhhbmRsZXJRdWV1ZTsKICB9LAoKICBmaXg6IGZ1bmN0aW9uKCBldmVudCApIHsKICAgIGlmICggZXZlbnRbIGpRdWVyeS5leHBhbmRvIF0gKSB7CiAgICAgIHJldHVybiBldmVudDsKICAgIH0KCiAgICAvLyBDcmVhdGUgYSB3cml0YWJsZSBjb3B5IG9mIHRoZSBldmVudCBvYmplY3QgYW5kIG5vcm1hbGl6ZSBzb21lIHByb3BlcnRpZXMKICAgIHZhciBpLCBwcm9wLAogICAgICBvcmlnaW5hbEV2ZW50ID0gZXZlbnQsCiAgICAgIGZpeEhvb2sgPSBqUXVlcnkuZXZlbnQuZml4SG9va3NbIGV2ZW50LnR5cGUgXSB8fCB7fSwKICAgICAgY29weSA9IGZpeEhvb2sucHJvcHMgPyB0aGlzLnByb3BzLmNvbmNhdCggZml4SG9vay5wcm9wcyApIDogdGhpcy5wcm9wczsKCiAgICBldmVudCA9IG5ldyBqUXVlcnkuRXZlbnQoIG9yaWdpbmFsRXZlbnQgKTsKCiAgICBpID0gY29weS5sZW5ndGg7CiAgICB3aGlsZSAoIGktLSApIHsKICAgICAgcHJvcCA9IGNvcHlbIGkgXTsKICAgICAgZXZlbnRbIHByb3AgXSA9IG9yaWdpbmFsRXZlbnRbIHByb3AgXTsKICAgIH0KCiAgICAvLyBTdXBwb3J0OiBJRTw5CiAgICAvLyBGaXggdGFyZ2V0IHByb3BlcnR5ICgjMTkyNSkKICAgIGlmICggIWV2ZW50LnRhcmdldCApIHsKICAgICAgZXZlbnQudGFyZ2V0ID0gb3JpZ2luYWxFdmVudC5zcmNFbGVtZW50IHx8IGRvY3VtZW50OwogICAgfQoKICAgIC8vIFN1cHBvcnQ6IENocm9tZSAyMyssIFNhZmFyaT8KICAgIC8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCAjMTMxNDMpCiAgICBpZiAoIGV2ZW50LnRhcmdldC5ub2RlVHlwZSA9PT0gMyApIHsKICAgICAgZXZlbnQudGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7CiAgICB9CgogICAgLy8gU3VwcG9ydDogSUU8OQogICAgLy8gRm9yIG1vdXNlL2tleSBldmVudHMsIG1ldGFLZXk9PWZhbHNlIGlmIGl0J3MgdW5kZWZpbmVkICgjMzM2OCwgIzExMzI4KQogICAgZXZlbnQubWV0YUtleSA9ICEhZXZlbnQubWV0YUtleTsKCiAgICByZXR1cm4gZml4SG9vay5maWx0ZXIgPyBmaXhIb29rLmZpbHRlciggZXZlbnQsIG9yaWdpbmFsRXZlbnQgKSA6IGV2ZW50OwogIH0sCgogIC8vIEluY2x1ZGVzIHNvbWUgZXZlbnQgcHJvcHMgc2hhcmVkIGJ5IEtleUV2ZW50IGFuZCBNb3VzZUV2ZW50CiAgcHJvcHM6ICJhbHRLZXkgYnViYmxlcyBjYW5jZWxhYmxlIGN0cmxLZXkgY3VycmVudFRhcmdldCBldmVudFBoYXNlIG1ldGFLZXkgcmVsYXRlZFRhcmdldCBzaGlmdEtleSB0YXJnZXQgdGltZVN0YW1wIHZpZXcgd2hpY2giLnNwbGl0KCIgIiksCgogIGZpeEhvb2tzOiB7fSwKCiAga2V5SG9va3M6IHsKICAgIHByb3BzOiAiY2hhciBjaGFyQ29kZSBrZXkga2V5Q29kZSIuc3BsaXQoIiAiKSwKICAgIGZpbHRlcjogZnVuY3Rpb24oIGV2ZW50LCBvcmlnaW5hbCApIHsKCiAgICAgIC8vIEFkZCB3aGljaCBmb3Iga2V5IGV2ZW50cwogICAgICBpZiAoIGV2ZW50LndoaWNoID09IG51bGwgKSB7CiAgICAgICAgZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOwogICAgICB9CgogICAgICByZXR1cm4gZXZlbnQ7CiAgICB9CiAgfSwKCiAgbW91c2VIb29rczogewogICAgcHJvcHM6ICJidXR0b24gYnV0dG9ucyBjbGllbnRYIGNsaWVudFkgZnJvbUVsZW1lbnQgb2Zmc2V0WCBvZmZzZXRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSB0b0VsZW1lbnQiLnNwbGl0KCIgIiksCiAgICBmaWx0ZXI6IGZ1bmN0aW9uKCBldmVudCwgb3JpZ2luYWwgKSB7CiAgICAgIHZhciBldmVudERvYywgZG9jLCBib2R5LAogICAgICAgIGJ1dHRvbiA9IG9yaWdpbmFsLmJ1dHRvbiwKICAgICAgICBmcm9tRWxlbWVudCA9IG9yaWdpbmFsLmZyb21FbGVtZW50OwoKICAgICAgLy8gQ2FsY3VsYXRlIHBhZ2VYL1kgaWYgbWlzc2luZyBhbmQgY2xpZW50WC9ZIGF2YWlsYWJsZQogICAgICBpZiAoIGV2ZW50LnBhZ2VYID09IG51bGwgJiYgb3JpZ2luYWwuY2xpZW50WCAhPSBudWxsICkgewogICAgICAgIGV2ZW50RG9jID0gZXZlbnQudGFyZ2V0Lm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgZG9jID0gZXZlbnREb2MuZG9jdW1lbnRFbGVtZW50OwogICAgICAgIGJvZHkgPSBldmVudERvYy5ib2R5OwoKICAgICAgICBldmVudC5wYWdlWCA9IG9yaWdpbmFsLmNsaWVudFggKyAoIGRvYyAmJiBkb2Muc2Nyb2xsTGVmdCB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsTGVmdCB8fCAwICkgLSAoIGRvYyAmJiBkb2MuY2xpZW50TGVmdCB8fCBib2R5ICYmIGJvZHkuY2xpZW50TGVmdCB8fCAwICk7CiAgICAgICAgZXZlbnQucGFnZVkgPSBvcmlnaW5hbC5jbGllbnRZICsgKCBkb2MgJiYgZG9jLnNjcm9sbFRvcCAgfHwgYm9keSAmJiBib2R5LnNjcm9sbFRvcCAgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudFRvcCAgfHwgYm9keSAmJiBib2R5LmNsaWVudFRvcCAgfHwgMCApOwogICAgICB9CgogICAgICAvLyBBZGQgcmVsYXRlZFRhcmdldCwgaWYgbmVjZXNzYXJ5CiAgICAgIGlmICggIWV2ZW50LnJlbGF0ZWRUYXJnZXQgJiYgZnJvbUVsZW1lbnQgKSB7CiAgICAgICAgZXZlbnQucmVsYXRlZFRhcmdldCA9IGZyb21FbGVtZW50ID09PSBldmVudC50YXJnZXQgPyBvcmlnaW5hbC50b0VsZW1lbnQgOiBmcm9tRWxlbWVudDsKICAgICAgfQoKICAgICAgLy8gQWRkIHdoaWNoIGZvciBjbGljazogMSA9PT0gbGVmdDsgMiA9PT0gbWlkZGxlOyAzID09PSByaWdodAogICAgICAvLyBOb3RlOiBidXR0b24gaXMgbm90IG5vcm1hbGl6ZWQsIHNvIGRvbid0IHVzZSBpdAogICAgICBpZiAoICFldmVudC53aGljaCAmJiBidXR0b24gIT09IHVuZGVmaW5lZCApIHsKICAgICAgICBldmVudC53aGljaCA9ICggYnV0dG9uICYgMSA/IDEgOiAoIGJ1dHRvbiAmIDIgPyAzIDogKCBidXR0b24gJiA0ID8gMiA6IDAgKSApICk7CiAgICAgIH0KCiAgICAgIHJldHVybiBldmVudDsKICAgIH0KICB9LAoKICBzcGVjaWFsOiB7CiAgICBsb2FkOiB7CiAgICAgIC8vIFByZXZlbnQgdHJpZ2dlcmVkIGltYWdlLmxvYWQgZXZlbnRzIGZyb20gYnViYmxpbmcgdG8gd2luZG93LmxvYWQKICAgICAgbm9CdWJibGU6IHRydWUKICAgIH0sCiAgICBjbGljazogewogICAgICAvLyBGb3IgY2hlY2tib3gsIGZpcmUgbmF0aXZlIGV2ZW50IHNvIGNoZWNrZWQgc3RhdGUgd2lsbCBiZSByaWdodAogICAgICB0cmlnZ2VyOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgImlucHV0IiApICYmIHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiAmJiB0aGlzLmNsaWNrICkgewogICAgICAgICAgdGhpcy5jbGljaygpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGZvY3VzOiB7CiAgICAgIC8vIEZpcmUgbmF0aXZlIGV2ZW50IGlmIHBvc3NpYmxlIHNvIGJsdXIvZm9jdXMgc2VxdWVuY2UgaXMgY29ycmVjdAogICAgICB0cmlnZ2VyOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIHRoaXMgIT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgdGhpcy5mb2N1cyApIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBjYXRjaCAoIGUgKSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFPDkKICAgICAgICAgICAgLy8gSWYgd2UgZXJyb3Igb24gZm9jdXMgdG8gaGlkZGVuIGVsZW1lbnQgKCMxNDg2LCAjMTI1MTgpLAogICAgICAgICAgICAvLyBsZXQgLnRyaWdnZXIoKSBydW4gdGhlIGhhbmRsZXJzCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBkZWxlZ2F0ZVR5cGU6ICJmb2N1c2luIgogICAgfSwKICAgIGJsdXI6IHsKICAgICAgdHJpZ2dlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCB0aGlzID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIHRoaXMuYmx1ciApIHsKICAgICAgICAgIHRoaXMuYmx1cigpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVsZWdhdGVUeXBlOiAiZm9jdXNvdXQiCiAgICB9LAoKICAgIGJlZm9yZXVubG9hZDogewogICAgICBwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCiAgICAgICAgLy8gRXZlbiB3aGVuIHJldHVyblZhbHVlIGVxdWFscyB0byB1bmRlZmluZWQgRmlyZWZveCB3aWxsIHN0aWxsIHNob3cgYWxlcnQKICAgICAgICBpZiAoIGV2ZW50LnJlc3VsdCAhPT0gdW5kZWZpbmVkICkgewogICAgICAgICAgZXZlbnQub3JpZ2luYWxFdmVudC5yZXR1cm5WYWx1ZSA9IGV2ZW50LnJlc3VsdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LAoKICBzaW11bGF0ZTogZnVuY3Rpb24oIHR5cGUsIGVsZW0sIGV2ZW50LCBidWJibGUgKSB7CiAgICAvLyBQaWdneWJhY2sgb24gYSBkb25vciBldmVudCB0byBzaW11bGF0ZSBhIGRpZmZlcmVudCBvbmUuCiAgICAvLyBGYWtlIG9yaWdpbmFsRXZlbnQgdG8gYXZvaWQgZG9ub3IncyBzdG9wUHJvcGFnYXRpb24sIGJ1dCBpZiB0aGUKICAgIC8vIHNpbXVsYXRlZCBldmVudCBwcmV2ZW50cyBkZWZhdWx0IHRoZW4gd2UgZG8gdGhlIHNhbWUgb24gdGhlIGRvbm9yLgogICAgdmFyIGUgPSBqUXVlcnkuZXh0ZW5kKAogICAgICBuZXcgalF1ZXJ5LkV2ZW50KCksCiAgICAgIGV2ZW50LAogICAgICB7IHR5cGU6IHR5cGUsCiAgICAgICAgaXNTaW11bGF0ZWQ6IHRydWUsCiAgICAgICAgb3JpZ2luYWxFdmVudDoge30KICAgICAgfQogICAgKTsKICAgIGlmICggYnViYmxlICkgewogICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlciggZSwgbnVsbCwgZWxlbSApOwogICAgfSBlbHNlIHsKICAgICAgalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmNhbGwoIGVsZW0sIGUgKTsKICAgIH0KICAgIGlmICggZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgIH0KICB9Cn07CgpqUXVlcnkucmVtb3ZlRXZlbnQgPSBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyID8KICBmdW5jdGlvbiggZWxlbSwgdHlwZSwgaGFuZGxlICkgewogICAgaWYgKCBlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIgKSB7CiAgICAgIGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgaGFuZGxlLCBmYWxzZSApOwogICAgfQogIH0gOgogIGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBoYW5kbGUgKSB7CiAgICB2YXIgbmFtZSA9ICJvbiIgKyB0eXBlOwoKICAgIGlmICggZWxlbS5kZXRhY2hFdmVudCApIHsKCiAgICAgIC8vICM4NTQ1LCAjNzA1NCwgcHJldmVudGluZyBtZW1vcnkgbGVha3MgZm9yIGN1c3RvbSBldmVudHMgaW4gSUU2LTgKICAgICAgLy8gZGV0YWNoRXZlbnQgbmVlZGVkIHByb3BlcnR5IG9uIGVsZW1lbnQsIGJ5IG5hbWUgb2YgdGhhdCBldmVudCwgdG8gcHJvcGVybHkgZXhwb3NlIGl0IHRvIEdDCiAgICAgIGlmICggdHlwZW9mIGVsZW1bIG5hbWUgXSA9PT0gInVuZGVmaW5lZCIgKSB7CiAgICAgICAgZWxlbVsgbmFtZSBdID0gbnVsbDsKICAgICAgfQoKICAgICAgZWxlbS5kZXRhY2hFdmVudCggbmFtZSwgaGFuZGxlICk7CiAgICB9CiAgfTsKCmpRdWVyeS5FdmVudCA9IGZ1bmN0aW9uKCBzcmMsIHByb3BzICkgewogIC8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAogIGlmICggISh0aGlzIGluc3RhbmNlb2YgalF1ZXJ5LkV2ZW50KSApIHsKICAgIHJldHVybiBuZXcgalF1ZXJ5LkV2ZW50KCBzcmMsIHByb3BzICk7CiAgfQoKICAvLyBFdmVudCBvYmplY3QKICBpZiAoIHNyYyAmJiBzcmMudHlwZSApIHsKICAgIHRoaXMub3JpZ2luYWxFdmVudCA9IHNyYzsKICAgIHRoaXMudHlwZSA9IHNyYy50eXBlOwoKICAgIC8vIEV2ZW50cyBidWJibGluZyB1cCB0aGUgZG9jdW1lbnQgbWF5IGhhdmUgYmVlbiBtYXJrZWQgYXMgcHJldmVudGVkCiAgICAvLyBieSBhIGhhbmRsZXIgbG93ZXIgZG93biB0aGUgdHJlZTsgcmVmbGVjdCB0aGUgY29ycmVjdCB2YWx1ZS4KICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gKCBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fCBzcmMucmV0dXJuVmFsdWUgPT09IGZhbHNlIHx8CiAgICAgIHNyYy5nZXRQcmV2ZW50RGVmYXVsdCAmJiBzcmMuZ2V0UHJldmVudERlZmF1bHQoKSApID8gcmV0dXJuVHJ1ZSA6IHJldHVybkZhbHNlOwoKICAvLyBFdmVudCB0eXBlCiAgfSBlbHNlIHsKICAgIHRoaXMudHlwZSA9IHNyYzsKICB9CgogIC8vIFB1dCBleHBsaWNpdGx5IHByb3ZpZGVkIHByb3BlcnRpZXMgb250byB0aGUgZXZlbnQgb2JqZWN0CiAgaWYgKCBwcm9wcyApIHsKICAgIGpRdWVyeS5leHRlbmQoIHRoaXMsIHByb3BzICk7CiAgfQoKICAvLyBDcmVhdGUgYSB0aW1lc3RhbXAgaWYgaW5jb21pbmcgZXZlbnQgZG9lc24ndCBoYXZlIG9uZQogIHRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgalF1ZXJ5Lm5vdygpOwoKICAvLyBNYXJrIGl0IGFzIGZpeGVkCiAgdGhpc1sgalF1ZXJ5LmV4cGFuZG8gXSA9IHRydWU7Cn07CgovLyBqUXVlcnkuRXZlbnQgaXMgYmFzZWQgb24gRE9NMyBFdmVudHMgYXMgc3BlY2lmaWVkIGJ5IHRoZSBFQ01BU2NyaXB0IExhbmd1YWdlIEJpbmRpbmcKLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAwMy9XRC1ET00tTGV2ZWwtMy1FdmVudHMtMjAwMzAzMzEvZWNtYS1zY3JpcHQtYmluZGluZy5odG1sCmpRdWVyeS5FdmVudC5wcm90b3R5cGUgPSB7CiAgaXNEZWZhdWx0UHJldmVudGVkOiByZXR1cm5GYWxzZSwKICBpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoKICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCiAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7CiAgICBpZiAoICFlICkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gSWYgcHJldmVudERlZmF1bHQgZXhpc3RzLCBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CiAgICBpZiAoIGUucHJldmVudERlZmF1bHQgKSB7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAvLyBTdXBwb3J0OiBJRQogICAgLy8gT3RoZXJ3aXNlIHNldCB0aGUgcmV0dXJuVmFsdWUgcHJvcGVydHkgb2YgdGhlIG9yaWdpbmFsIGV2ZW50IHRvIGZhbHNlCiAgICB9IGVsc2UgewogICAgICBlLnJldHVyblZhbHVlID0gZmFsc2U7CiAgICB9CiAgfSwKICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgogICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CiAgICBpZiAoICFlICkgewogICAgICByZXR1cm47CiAgICB9CiAgICAvLyBJZiBzdG9wUHJvcGFnYXRpb24gZXhpc3RzLCBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CiAgICBpZiAoIGUuc3RvcFByb3BhZ2F0aW9uICkgewogICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgfQoKICAgIC8vIFN1cHBvcnQ6IElFCiAgICAvLyBTZXQgdGhlIGNhbmNlbEJ1YmJsZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gdHJ1ZQogICAgZS5jYW5jZWxCdWJibGUgPSB0cnVlOwogIH0sCiAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwogICAgdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKICB9Cn07CgovLyBDcmVhdGUgbW91c2VlbnRlci9sZWF2ZSBldmVudHMgdXNpbmcgbW91c2VvdmVyL291dCBhbmQgZXZlbnQtdGltZSBjaGVja3MKalF1ZXJ5LmVhY2goewogIG1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAogIG1vdXNlbGVhdmU6ICJtb3VzZW91dCIKfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKICBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgb3JpZyBdID0gewogICAgZGVsZWdhdGVUeXBlOiBmaXgsCiAgICBiaW5kVHlwZTogZml4LAoKICAgIGhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICB2YXIgcmV0LAogICAgICAgIHRhcmdldCA9IHRoaXMsCiAgICAgICAgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQsCiAgICAgICAgaGFuZGxlT2JqID0gZXZlbnQuaGFuZGxlT2JqOwoKICAgICAgLy8gRm9yIG1vdXNlbnRlci9sZWF2ZSBjYWxsIHRoZSBoYW5kbGVyIGlmIHJlbGF0ZWQgaXMgb3V0c2lkZSB0aGUgdGFyZ2V0LgogICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICBpZiAoICFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0YXJnZXQgJiYgIWpRdWVyeS5jb250YWlucyggdGFyZ2V0LCByZWxhdGVkICkpICkgewogICAgICAgIGV2ZW50LnR5cGUgPSBoYW5kbGVPYmoub3JpZ1R5cGU7CiAgICAgICAgcmV0ID0gaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogICAgICAgIGV2ZW50LnR5cGUgPSBmaXg7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICAgIH0KICB9Owp9KTsKCi8vIElFIHN1Ym1pdCBkZWxlZ2F0aW9uCmlmICggIWpRdWVyeS5zdXBwb3J0LnN1Ym1pdEJ1YmJsZXMgKSB7CgogIGpRdWVyeS5ldmVudC5zcGVjaWFsLnN1Ym1pdCA9IHsKICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gT25seSBuZWVkIHRoaXMgZm9yIGRlbGVnYXRlZCBmb3JtIHN1Ym1pdCBldmVudHMKICAgICAgaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJmb3JtIiApICkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gTGF6eS1hZGQgYSBzdWJtaXQgaGFuZGxlciB3aGVuIGEgZGVzY2VuZGFudCBmb3JtIG1heSBwb3RlbnRpYWxseSBiZSBzdWJtaXR0ZWQKICAgICAgalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgImNsaWNrLl9zdWJtaXQga2V5cHJlc3MuX3N1Ym1pdCIsIGZ1bmN0aW9uKCBlICkgewogICAgICAgIC8vIE5vZGUgbmFtZSBjaGVjayBhdm9pZHMgYSBWTUwtcmVsYXRlZCBjcmFzaCBpbiBJRSAoIzk4MDcpCiAgICAgICAgdmFyIGVsZW0gPSBlLnRhcmdldCwKICAgICAgICAgIGZvcm0gPSBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpbnB1dCIgKSB8fCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJidXR0b24iICkgPyBlbGVtLmZvcm0gOiB1bmRlZmluZWQ7CiAgICAgICAgaWYgKCBmb3JtICYmICFqUXVlcnkuX2RhdGEoIGZvcm0sICJzdWJtaXRCdWJibGVzIiApICkgewogICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZCggZm9ybSwgInN1Ym1pdC5fc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICAgICAgICBldmVudC5fc3VibWl0X2J1YmJsZSA9IHRydWU7CiAgICAgICAgICB9KTsKICAgICAgICAgIGpRdWVyeS5fZGF0YSggZm9ybSwgInN1Ym1pdEJ1YmJsZXMiLCB0cnVlICk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgLy8gcmV0dXJuIHVuZGVmaW5lZCBzaW5jZSB3ZSBkb24ndCBuZWVkIGFuIGV2ZW50IGxpc3RlbmVyCiAgICB9LAoKICAgIHBvc3REaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICAvLyBJZiBmb3JtIHdhcyBzdWJtaXR0ZWQgYnkgdGhlIHVzZXIsIGJ1YmJsZSB0aGUgZXZlbnQgdXAgdGhlIHRyZWUKICAgICAgaWYgKCBldmVudC5fc3VibWl0X2J1YmJsZSApIHsKICAgICAgICBkZWxldGUgZXZlbnQuX3N1Ym1pdF9idWJibGU7CiAgICAgICAgaWYgKCB0aGlzLnBhcmVudE5vZGUgJiYgIWV2ZW50LmlzVHJpZ2dlciApIHsKICAgICAgICAgIGpRdWVyeS5ldmVudC5zaW11bGF0ZSggInN1Ym1pdCIsIHRoaXMucGFyZW50Tm9kZSwgZXZlbnQsIHRydWUgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBPbmx5IG5lZWQgdGhpcyBmb3IgZGVsZWdhdGVkIGZvcm0gc3VibWl0IGV2ZW50cwogICAgICBpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgImZvcm0iICkgKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgZGVsZWdhdGVkIGhhbmRsZXJzOyBjbGVhbkRhdGEgZXZlbnR1YWxseSByZWFwcyBzdWJtaXQgaGFuZGxlcnMgYXR0YWNoZWQgYWJvdmUKICAgICAgalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5fc3VibWl0IiApOwogICAgfQogIH07Cn0KCi8vIElFIGNoYW5nZSBkZWxlZ2F0aW9uIGFuZCBjaGVja2JveC9yYWRpbyBmaXgKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hhbmdlQnViYmxlcyApIHsKCiAgalF1ZXJ5LmV2ZW50LnNwZWNpYWwuY2hhbmdlID0gewoKICAgIHNldHVwOiBmdW5jdGlvbigpIHsKCiAgICAgIGlmICggcmZvcm1FbGVtcy50ZXN0KCB0aGlzLm5vZGVOYW1lICkgKSB7CiAgICAgICAgLy8gSUUgZG9lc24ndCBmaXJlIGNoYW5nZSBvbiBhIGNoZWNrL3JhZGlvIHVudGlsIGJsdXI7IHRyaWdnZXIgaXQgb24gY2xpY2sKICAgICAgICAvLyBhZnRlciBhIHByb3BlcnR5Y2hhbmdlLiBFYXQgdGhlIGJsdXItY2hhbmdlIGluIHNwZWNpYWwuY2hhbmdlLmhhbmRsZS4KICAgICAgICAvLyBUaGlzIHN0aWxsIGZpcmVzIG9uY2hhbmdlIGEgc2Vjb25kIHRpbWUgZm9yIGNoZWNrL3JhZGlvIGFmdGVyIGJsdXIuCiAgICAgICAgaWYgKCB0aGlzLnR5cGUgPT09ICJjaGVja2JveCIgfHwgdGhpcy50eXBlID09PSAicmFkaW8iICkgewogICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgInByb3BlcnR5Y2hhbmdlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CiAgICAgICAgICAgIGlmICggZXZlbnQub3JpZ2luYWxFdmVudC5wcm9wZXJ0eU5hbWUgPT09ICJjaGVja2VkIiApIHsKICAgICAgICAgICAgICB0aGlzLl9qdXN0X2NoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQoIHRoaXMsICJjbGljay5fY2hhbmdlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICAgICAgICBpZiAoIHRoaXMuX2p1c3RfY2hhbmdlZCAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgewogICAgICAgICAgICAgIHRoaXMuX2p1c3RfY2hhbmdlZCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEFsbG93IHRyaWdnZXJlZCwgc2ltdWxhdGVkIGNoYW5nZSBldmVudHMgKCMxMTUwMCkKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAiY2hhbmdlIiwgdGhpcywgZXZlbnQsIHRydWUgKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gRGVsZWdhdGVkIGV2ZW50OyBsYXp5LWFkZCBhIGNoYW5nZSBoYW5kbGVyIG9uIGRlc2NlbmRhbnQgaW5wdXRzCiAgICAgIGpRdWVyeS5ldmVudC5hZGQoIHRoaXMsICJiZWZvcmVhY3RpdmF0ZS5fY2hhbmdlIiwgZnVuY3Rpb24oIGUgKSB7CiAgICAgICAgdmFyIGVsZW0gPSBlLnRhcmdldDsKCiAgICAgICAgaWYgKCByZm9ybUVsZW1zLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSAmJiAhalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiY2hhbmdlQnViYmxlcyIgKSApIHsKICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQoIGVsZW0sICJjaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKICAgICAgICAgICAgaWYgKCB0aGlzLnBhcmVudE5vZGUgJiYgIWV2ZW50LmlzU2ltdWxhdGVkICYmICFldmVudC5pc1RyaWdnZXIgKSB7CiAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAiY2hhbmdlIiwgdGhpcy5wYXJlbnROb2RlLCBldmVudCwgdHJ1ZSApOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGpRdWVyeS5fZGF0YSggZWxlbSwgImNoYW5nZUJ1YmJsZXMiLCB0cnVlICk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgaGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CiAgICAgIHZhciBlbGVtID0gZXZlbnQudGFyZ2V0OwoKICAgICAgLy8gU3dhbGxvdyBuYXRpdmUgY2hhbmdlIGV2ZW50cyBmcm9tIGNoZWNrYm94L3JhZGlvLCB3ZSBhbHJlYWR5IHRyaWdnZXJlZCB0aGVtIGFib3ZlCiAgICAgIGlmICggdGhpcyAhPT0gZWxlbSB8fCBldmVudC5pc1NpbXVsYXRlZCB8fCBldmVudC5pc1RyaWdnZXIgfHwgKGVsZW0udHlwZSAhPT0gInJhZGlvIiAmJiBlbGVtLnR5cGUgIT09ICJjaGVja2JveCIpICkgewogICAgICAgIHJldHVybiBldmVudC5oYW5kbGVPYmouaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CiAgICAgIH0KICAgIH0sCgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCAiLl9jaGFuZ2UiICk7CgogICAgICByZXR1cm4gIXJmb3JtRWxlbXMudGVzdCggdGhpcy5ub2RlTmFtZSApOwogICAgfQogIH07Cn0KCi8vIENyZWF0ZSAiYnViYmxpbmciIGZvY3VzIGFuZCBibHVyIGV2ZW50cwppZiAoICFqUXVlcnkuc3VwcG9ydC5mb2N1c2luQnViYmxlcyApIHsKICBqUXVlcnkuZWFjaCh7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKCiAgICAvLyBBdHRhY2ggYSBzaW5nbGUgY2FwdHVyaW5nIGhhbmRsZXIgd2hpbGUgc29tZW9uZSB3YW50cyBmb2N1c2luL2ZvY3Vzb3V0CiAgICB2YXIgYXR0YWNoZXMgPSAwLAogICAgICBoYW5kbGVyID0gZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICAgIGpRdWVyeS5ldmVudC5zaW11bGF0ZSggZml4LCBldmVudC50YXJnZXQsIGpRdWVyeS5ldmVudC5maXgoIGV2ZW50ICksIHRydWUgKTsKICAgICAgfTsKCiAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgZml4IF0gPSB7CiAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIGF0dGFjaGVzKysgPT09IDAgKSB7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CiAgICAgICAgfQogICAgICB9LAogICAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCAtLWF0dGFjaGVzID09PSAwICkgewogICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggb3JpZywgaGFuZGxlciwgdHJ1ZSApOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9KTsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7CgogIG9uOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgLypJTlRFUk5BTCovIG9uZSApIHsKICAgIHZhciBvcmlnRm4sIHR5cGU7CgogICAgLy8gVHlwZXMgY2FuIGJlIGEgbWFwIG9mIHR5cGVzL2hhbmRsZXJzCiAgICBpZiAoIHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIgKSB7CiAgICAgIC8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApCiAgICAgIGlmICggdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKICAgICAgICAvLyAoIHR5cGVzLU9iamVjdCwgZGF0YSApCiAgICAgICAgZGF0YSA9IGRhdGEgfHwgc2VsZWN0b3I7CiAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgZm9yICggdHlwZSBpbiB0eXBlcyApIHsKICAgICAgICB0aGlzLm9uKCB0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbIHR5cGUgXSwgb25lICk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgaWYgKCBkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCApIHsKICAgICAgLy8gKCB0eXBlcywgZm4gKQogICAgICBmbiA9IHNlbGVjdG9yOwogICAgICBkYXRhID0gc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICB9IGVsc2UgaWYgKCBmbiA9PSBudWxsICkgewogICAgICBpZiAoIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CiAgICAgICAgLy8gKCB0eXBlcywgc2VsZWN0b3IsIGZuICkKICAgICAgICBmbiA9IGRhdGE7CiAgICAgICAgZGF0YSA9IHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyAoIHR5cGVzLCBkYXRhLCBmbiApCiAgICAgICAgZm4gPSBkYXRhOwogICAgICAgIGRhdGEgPSBzZWxlY3RvcjsKICAgICAgICBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgfQogICAgaWYgKCBmbiA9PT0gZmFsc2UgKSB7CiAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICB9IGVsc2UgaWYgKCAhZm4gKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGlmICggb25lID09PSAxICkgewogICAgICBvcmlnRm4gPSBmbjsKICAgICAgZm4gPSBmdW5jdGlvbiggZXZlbnQgKSB7CiAgICAgICAgLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvCiAgICAgICAgalF1ZXJ5KCkub2ZmKCBldmVudCApOwogICAgICAgIHJldHVybiBvcmlnRm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogICAgICB9OwogICAgICAvLyBVc2Ugc2FtZSBndWlkIHNvIGNhbGxlciBjYW4gcmVtb3ZlIHVzaW5nIG9yaWdGbgogICAgICBmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKCBvcmlnRm4uZ3VpZCA9IGpRdWVyeS5ndWlkKysgKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewogICAgICBqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCB0eXBlcywgZm4sIGRhdGEsIHNlbGVjdG9yICk7CiAgICB9KTsKICB9LAogIG9uZTogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKSB7CiAgICByZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgMSApOwogIH0sCiAgb2ZmOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBmbiApIHsKICAgIHZhciBoYW5kbGVPYmosIHR5cGU7CiAgICBpZiAoIHR5cGVzICYmIHR5cGVzLnByZXZlbnREZWZhdWx0ICYmIHR5cGVzLmhhbmRsZU9iaiApIHsKICAgICAgLy8gKCBldmVudCApICBkaXNwYXRjaGVkIGpRdWVyeS5FdmVudAogICAgICBoYW5kbGVPYmogPSB0eXBlcy5oYW5kbGVPYmo7CiAgICAgIGpRdWVyeSggdHlwZXMuZGVsZWdhdGVUYXJnZXQgKS5vZmYoCiAgICAgICAgaGFuZGxlT2JqLm5hbWVzcGFjZSA/IGhhbmRsZU9iai5vcmlnVHlwZSArICIuIiArIGhhbmRsZU9iai5uYW1lc3BhY2UgOiBoYW5kbGVPYmoub3JpZ1R5cGUsCiAgICAgICAgaGFuZGxlT2JqLnNlbGVjdG9yLAogICAgICAgIGhhbmRsZU9iai5oYW5kbGVyCiAgICAgICk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgaWYgKCB0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiICkgewogICAgICAvLyAoIHR5cGVzLW9iamVjdCBbLCBzZWxlY3Rvcl0gKQogICAgICBmb3IgKCB0eXBlIGluIHR5cGVzICkgewogICAgICAgIHRoaXMub2ZmKCB0eXBlLCBzZWxlY3RvciwgdHlwZXNbIHR5cGUgXSApOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgaWYgKCBzZWxlY3RvciA9PT0gZmFsc2UgfHwgdHlwZW9mIHNlbGVjdG9yID09PSAiZnVuY3Rpb24iICkgewogICAgICAvLyAoIHR5cGVzIFssIGZuXSApCiAgICAgIGZuID0gc2VsZWN0b3I7CiAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgfQogICAgaWYgKCBmbiA9PT0gZmFsc2UgKSB7CiAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICB9CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCB0eXBlcywgZm4sIHNlbGVjdG9yICk7CiAgICB9KTsKICB9LAoKICBiaW5kOiBmdW5jdGlvbiggdHlwZXMsIGRhdGEsIGZuICkgewogICAgcmV0dXJuIHRoaXMub24oIHR5cGVzLCBudWxsLCBkYXRhLCBmbiApOwogIH0sCiAgdW5iaW5kOiBmdW5jdGlvbiggdHlwZXMsIGZuICkgewogICAgcmV0dXJuIHRoaXMub2ZmKCB0eXBlcywgbnVsbCwgZm4gKTsKICB9LAoKICBkZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZGF0YSwgZm4gKSB7CiAgICByZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApOwogIH0sCiAgdW5kZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZm4gKSB7CiAgICAvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHRoaXMub2ZmKCBzZWxlY3RvciwgIioqIiApIDogdGhpcy5vZmYoIHR5cGVzLCBzZWxlY3RvciB8fCAiKioiLCBmbiApOwogIH0sCgogIHRyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIHRoaXMgKTsKICAgIH0pOwogIH0sCiAgdHJpZ2dlckhhbmRsZXI6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewogICAgdmFyIGVsZW0gPSB0aGlzWzBdOwogICAgaWYgKCBlbGVtICkgewogICAgICByZXR1cm4galF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIGVsZW0sIHRydWUgKTsKICAgIH0KICB9LAoKICBob3ZlcjogZnVuY3Rpb24oIGZuT3ZlciwgZm5PdXQgKSB7CiAgICByZXR1cm4gdGhpcy5tb3VzZWVudGVyKCBmbk92ZXIgKS5tb3VzZWxlYXZlKCBmbk91dCB8fCBmbk92ZXIgKTsKICB9Cn0pOwoKalF1ZXJ5LmVhY2goICgiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgIiArCiAgIm1vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlICIgKwogICJjaGFuZ2Ugc2VsZWN0IHN1Ym1pdCBrZXlkb3duIGtleXByZXNzIGtleXVwIGVycm9yIGNvbnRleHRtZW51Iikuc3BsaXQoIiAiKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgogIC8vIEhhbmRsZSBldmVudCBiaW5kaW5nCiAgalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZGF0YSwgZm4gKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDAgPwogICAgICB0aGlzLm9uKCBuYW1lLCBudWxsLCBkYXRhLCBmbiApIDoKICAgICAgdGhpcy50cmlnZ2VyKCBuYW1lICk7CiAgfTsKCiAgaWYgKCBya2V5RXZlbnQudGVzdCggbmFtZSApICkgewogICAgalF1ZXJ5LmV2ZW50LmZpeEhvb2tzWyBuYW1lIF0gPSBqUXVlcnkuZXZlbnQua2V5SG9va3M7CiAgfQoKICBpZiAoIHJtb3VzZUV2ZW50LnRlc3QoIG5hbWUgKSApIHsKICAgIGpRdWVyeS5ldmVudC5maXhIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV2ZW50Lm1vdXNlSG9va3M7CiAgfQp9KTsKLyohCiAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lCiAqIENvcHlyaWdodCAyMDEyIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqLwooZnVuY3Rpb24oIHdpbmRvdywgdW5kZWZpbmVkICkgewoKdmFyIGksCiAgY2FjaGVkcnVucywKICBFeHByLAogIGdldFRleHQsCiAgaXNYTUwsCiAgY29tcGlsZSwKICBoYXNEdXBsaWNhdGUsCiAgb3V0ZXJtb3N0Q29udGV4dCwKCiAgLy8gTG9jYWwgZG9jdW1lbnQgdmFycwogIHNldERvY3VtZW50LAogIGRvY3VtZW50LAogIGRvY0VsZW0sCiAgZG9jdW1lbnRJc1hNTCwKICByYnVnZ3lRU0EsCiAgcmJ1Z2d5TWF0Y2hlcywKICBtYXRjaGVzLAogIGNvbnRhaW5zLAogIHNvcnRPcmRlciwKCiAgLy8gSW5zdGFuY2Utc3BlY2lmaWMgZGF0YQogIGV4cGFuZG8gPSAic2l6emxlIiArIC0obmV3IERhdGUoKSksCiAgcHJlZmVycmVkRG9jID0gd2luZG93LmRvY3VtZW50LAogIHN1cHBvcnQgPSB7fSwKICBkaXJydW5zID0gMCwKICBkb25lID0gMCwKICBjbGFzc0NhY2hlID0gY3JlYXRlQ2FjaGUoKSwKICB0b2tlbkNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKICBjb21waWxlckNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKCiAgLy8gR2VuZXJhbC1wdXJwb3NlIGNvbnN0YW50cwogIHN0cnVuZGVmaW5lZCA9IHR5cGVvZiB1bmRlZmluZWQsCiAgTUFYX05FR0FUSVZFID0gMSA8PCAzMSwKCiAgLy8gQXJyYXkgbWV0aG9kcwogIGFyciA9IFtdLAogIHBvcCA9IGFyci5wb3AsCiAgcHVzaCA9IGFyci5wdXNoLAogIHNsaWNlID0gYXJyLnNsaWNlLAogIC8vIFVzZSBhIHN0cmlwcGVkLWRvd24gaW5kZXhPZiBpZiB3ZSBjYW4ndCB1c2UgYSBuYXRpdmUgb25lCiAgaW5kZXhPZiA9IGFyci5pbmRleE9mIHx8IGZ1bmN0aW9uKCBlbGVtICkgewogICAgdmFyIGkgPSAwLAogICAgICBsZW4gPSB0aGlzLmxlbmd0aDsKICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgICBpZiAoIHRoaXNbaV0gPT09IGVsZW0gKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9LAoKCiAgLy8gUmVndWxhciBleHByZXNzaW9ucwoKICAvLyBXaGl0ZXNwYWNlIGNoYXJhY3RlcnMgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI3doaXRlc3BhY2UKICB3aGl0ZXNwYWNlID0gIltcXHgyMFxcdFxcclxcblxcZl0iLAogIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc3ludGF4LyNjaGFyYWN0ZXJzCiAgY2hhcmFjdGVyRW5jb2RpbmcgPSAiKD86XFxcXC58W1xcdy1dfFteXFx4MDAtXFx4YTBdKSsiLAoKICAvLyBMb29zZWx5IG1vZGVsZWQgb24gQ1NTIGlkZW50aWZpZXIgY2hhcmFjdGVycwogIC8vIEFuIHVucXVvdGVkIHZhbHVlIHNob3VsZCBiZSBhIENTUyBpZGVudGlmaWVyIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc2VsZWN0b3JzLyNhdHRyaWJ1dGUtc2VsZWN0b3JzCiAgLy8gUHJvcGVyIHN5bnRheDogaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI3ZhbHVlLWRlZi1pZGVudGlmaWVyCiAgaWRlbnRpZmllciA9IGNoYXJhY3RlckVuY29kaW5nLnJlcGxhY2UoICJ3IiwgIncjIiApLAoKICAvLyBBY2NlcHRhYmxlIG9wZXJhdG9ycyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMKICBvcGVyYXRvcnMgPSAiKFsqXiR8IX5dPz0pIiwKICBhdHRyaWJ1dGVzID0gIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICsgd2hpdGVzcGFjZSArCiAgICAiKig/OiIgKyBvcGVyYXRvcnMgKyB3aGl0ZXNwYWNlICsgIiooPzooWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwzfCgiICsgaWRlbnRpZmllciArICIpfCl8KSIgKyB3aGl0ZXNwYWNlICsgIipcXF0iLAoKICAvLyBQcmVmZXIgYXJndW1lbnRzIHF1b3RlZCwKICAvLyAgIHRoZW4gbm90IGNvbnRhaW5pbmcgcHNldWRvcy9icmFja2V0cywKICAvLyAgIHRoZW4gYXR0cmlidXRlIHNlbGVjdG9ycy9ub24tcGFyZW50aGV0aWNhbCBleHByZXNzaW9ucywKICAvLyAgIHRoZW4gYW55dGhpbmcgZWxzZQogIC8vIFRoZXNlIHByZWZlcmVuY2VzIGFyZSBoZXJlIHRvIHJlZHVjZSB0aGUgbnVtYmVyIG9mIHNlbGVjdG9ycwogIC8vICAgbmVlZGluZyB0b2tlbml6ZSBpbiB0aGUgUFNFVURPIHByZUZpbHRlcgogIHBzZXVkb3MgPSAiOigiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSg/OlxcKCgoWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwzfCgoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCIgKyBhdHRyaWJ1dGVzLnJlcGxhY2UoIDMsIDggKSArICIpKil8LiopXFwpfCkiLAoKICAvLyBMZWFkaW5nIGFuZCBub24tZXNjYXBlZCB0cmFpbGluZyB3aGl0ZXNwYWNlLCBjYXB0dXJpbmcgc29tZSBub24td2hpdGVzcGFjZSBjaGFyYWN0ZXJzIHByZWNlZGluZyB0aGUgbGF0dGVyCiAgcnRyaW0gPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIit8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKSIgKyB3aGl0ZXNwYWNlICsgIiskIiwgImciICksCgogIHJjb21tYSA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKiwiICsgd2hpdGVzcGFjZSArICIqIiApLAogIHJjb21iaW5hdG9ycyA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKihbXFx4MjBcXHRcXHJcXG5cXGY+K35dKSIgKyB3aGl0ZXNwYWNlICsgIioiICksCiAgcnBzZXVkbyA9IG5ldyBSZWdFeHAoIHBzZXVkb3MgKSwKICByaWRlbnRpZmllciA9IG5ldyBSZWdFeHAoICJeIiArIGlkZW50aWZpZXIgKyAiJCIgKSwKCiAgbWF0Y2hFeHByID0gewogICAgIklEIjogbmV3IFJlZ0V4cCggIl4jKCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpIiApLAogICAgIkNMQVNTIjogbmV3IFJlZ0V4cCggIl5cXC4oIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksCiAgICAiTkFNRSI6IG5ldyBSZWdFeHAoICJeXFxbbmFtZT1bJ1wiXT8oIiArIGNoYXJhY3RlckVuY29kaW5nICsgIilbJ1wiXT9cXF0iICksCiAgICAiVEFHIjogbmV3IFJlZ0V4cCggIl4oIiArIGNoYXJhY3RlckVuY29kaW5nLnJlcGxhY2UoICJ3IiwgIncqIiApICsgIikiICksCiAgICAiQVRUUiI6IG5ldyBSZWdFeHAoICJeIiArIGF0dHJpYnV0ZXMgKSwKICAgICJQU0VVRE8iOiBuZXcgUmVnRXhwKCAiXiIgKyBwc2V1ZG9zICksCiAgICAiQ0hJTEQiOiBuZXcgUmVnRXhwKCAiXjoob25seXxmaXJzdHxsYXN0fG50aHxudGgtbGFzdCktKGNoaWxkfG9mLXR5cGUpKD86XFwoIiArIHdoaXRlc3BhY2UgKwogICAgICAiKihldmVufG9kZHwoKFsrLV18KShcXGQqKW58KSIgKyB3aGl0ZXNwYWNlICsgIiooPzooWystXXwpIiArIHdoaXRlc3BhY2UgKwogICAgICAiKihcXGQrKXwpKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSIsICJpIiApLAogICAgLy8gRm9yIHVzZSBpbiBsaWJyYXJpZXMgaW1wbGVtZW50aW5nIC5pcygpCiAgICAvLyBXZSB1c2UgdGhpcyBmb3IgUE9TIG1hdGNoaW5nIGluIGBzZWxlY3RgCiAgICAibmVlZHNDb250ZXh0IjogbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIqWz4rfl18OihldmVufG9kZHxlcXxndHxsdHxudGh8Zmlyc3R8bGFzdCkoPzpcXCgiICsKICAgICAgd2hpdGVzcGFjZSArICIqKCg/Oi1cXGQpP1xcZCopIiArIHdoaXRlc3BhY2UgKyAiKlxcKXwpKD89W14tXXwkKSIsICJpIiApCiAgfSwKCiAgcnNpYmxpbmcgPSAvW1x4MjBcdFxyXG5cZl0qWyt+XS8sCgogIHJuYXRpdmUgPSAvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8sCgogIC8vIEVhc2lseS1wYXJzZWFibGUvcmV0cmlldmFibGUgSUQgb3IgVEFHIG9yIENMQVNTIHNlbGVjdG9ycwogIHJxdWlja0V4cHIgPSAvXig/OiMoW1x3LV0rKXwoXHcrKXxcLihbXHctXSspKSQvLAoKICByaW5wdXRzID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaSwKICByaGVhZGVyID0gL15oXGQkL2ksCgogIHJlc2NhcGUgPSAvJ3xcXC9nLAogIHJhdHRyaWJ1dGVRdW90ZXMgPSAvXD1bXHgyMFx0XHJcblxmXSooW14nIlxdXSopW1x4MjBcdFxyXG5cZl0qXF0vZywKCiAgLy8gQ1NTIGVzY2FwZXMgaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI2VzY2FwZWQtY2hhcmFjdGVycwogIHJ1bmVzY2FwZSA9IC9cXChbXGRhLWZBLUZdezEsNn1bXHgyMFx0XHJcblxmXT98LikvZywKICBmdW5lc2NhcGUgPSBmdW5jdGlvbiggXywgZXNjYXBlZCApIHsKICAgIHZhciBoaWdoID0gIjB4IiArIGVzY2FwZWQgLSAweDEwMDAwOwogICAgLy8gTmFOIG1lYW5zIG5vbi1jb2RlcG9pbnQKICAgIHJldHVybiBoaWdoICE9PSBoaWdoID8KICAgICAgZXNjYXBlZCA6CiAgICAgIC8vIEJNUCBjb2RlcG9pbnQKICAgICAgaGlnaCA8IDAgPwogICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggKyAweDEwMDAwICkgOgogICAgICAgIC8vIFN1cHBsZW1lbnRhbCBQbGFuZSBjb2RlcG9pbnQgKHN1cnJvZ2F0ZSBwYWlyKQogICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggPj4gMTAgfCAweEQ4MDAsIGhpZ2ggJiAweDNGRiB8IDB4REMwMCApOwogIH07CgovLyBVc2UgYSBzdHJpcHBlZC1kb3duIHNsaWNlIGlmIHdlIGNhbid0IHVzZSBhIG5hdGl2ZSBvbmUKdHJ5IHsKICBzbGljZS5jYWxsKCBkb2NFbGVtLmNoaWxkTm9kZXMsIDAgKVswXS5ub2RlVHlwZTsKfSBjYXRjaCAoIGUgKSB7CiAgc2xpY2UgPSBmdW5jdGlvbiggaSApIHsKICAgIHZhciBlbGVtLAogICAgICByZXN1bHRzID0gW107CiAgICBmb3IgKCA7IChlbGVtID0gdGhpc1tpXSk7IGkrKyApIHsKICAgICAgcmVzdWx0cy5wdXNoKCBlbGVtICk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9Owp9CgovKioKICogRm9yIGZlYXR1cmUgZGV0ZWN0aW9uCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byB0ZXN0IGZvciBuYXRpdmUgc3VwcG9ydAogKi8KZnVuY3Rpb24gaXNOYXRpdmUoIGZuICkgewogIHJldHVybiBybmF0aXZlLnRlc3QoIGZuICsgIiIgKTsKfQoKLyoqCiAqIENyZWF0ZSBrZXktdmFsdWUgY2FjaGVzIG9mIGxpbWl0ZWQgc2l6ZQogKiBAcmV0dXJucyB7RnVuY3Rpb24oc3RyaW5nLCBPYmplY3QpfSBSZXR1cm5zIHRoZSBPYmplY3QgZGF0YSBhZnRlciBzdG9yaW5nIGl0IG9uIGl0c2VsZiB3aXRoCiAqICBwcm9wZXJ0eSBuYW1lIHRoZSAoc3BhY2Utc3VmZml4ZWQpIHN0cmluZyBhbmQgKGlmIHRoZSBjYWNoZSBpcyBsYXJnZXIgdGhhbiBFeHByLmNhY2hlTGVuZ3RoKQogKiAgZGVsZXRpbmcgdGhlIG9sZGVzdCBlbnRyeQogKi8KZnVuY3Rpb24gY3JlYXRlQ2FjaGUoKSB7CiAgdmFyIGNhY2hlLAogICAga2V5cyA9IFtdOwoKICByZXR1cm4gKGNhY2hlID0gZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CiAgICAvLyBVc2UgKGtleSArICIgIikgdG8gYXZvaWQgY29sbGlzaW9uIHdpdGggbmF0aXZlIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChzZWUgSXNzdWUgIzE1NykKICAgIGlmICgga2V5cy5wdXNoKCBrZXkgKz0gIiAiICkgPiBFeHByLmNhY2hlTGVuZ3RoICkgewogICAgICAvLyBPbmx5IGtlZXAgdGhlIG1vc3QgcmVjZW50IGVudHJpZXMKICAgICAgZGVsZXRlIGNhY2hlWyBrZXlzLnNoaWZ0KCkgXTsKICAgIH0KICAgIHJldHVybiAoY2FjaGVbIGtleSBdID0gdmFsdWUpOwogIH0pOwp9CgovKioKICogTWFyayBhIGZ1bmN0aW9uIGZvciBzcGVjaWFsIHVzZSBieSBTaXp6bGUKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIG1hcmsKICovCmZ1bmN0aW9uIG1hcmtGdW5jdGlvbiggZm4gKSB7CiAgZm5bIGV4cGFuZG8gXSA9IHRydWU7CiAgcmV0dXJuIGZuOwp9CgovKioKICogU3VwcG9ydCB0ZXN0aW5nIHVzaW5nIGFuIGVsZW1lbnQKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gUGFzc2VkIHRoZSBjcmVhdGVkIGRpdiBhbmQgZXhwZWN0cyBhIGJvb2xlYW4gcmVzdWx0CiAqLwpmdW5jdGlvbiBhc3NlcnQoIGZuICkgewogIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgdHJ5IHsKICAgIHJldHVybiBmbiggZGl2ICk7CiAgfSBjYXRjaCAoZSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0gZmluYWxseSB7CiAgICAvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQogICAgZGl2ID0gbnVsbDsKICB9Cn0KCmZ1bmN0aW9uIFNpenpsZSggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKSB7CiAgdmFyIG1hdGNoLCBlbGVtLCBtLCBub2RlVHlwZSwKICAgIC8vIFFTQSB2YXJzCiAgICBpLCBncm91cHMsIG9sZCwgbmlkLCBuZXdDb250ZXh0LCBuZXdTZWxlY3RvcjsKCiAgaWYgKCAoIGNvbnRleHQgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IHByZWZlcnJlZERvYyApICE9PSBkb2N1bWVudCApIHsKICAgIHNldERvY3VtZW50KCBjb250ZXh0ICk7CiAgfQoKICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICByZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKCiAgaWYgKCAhc2VsZWN0b3IgfHwgdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKICAgIHJldHVybiByZXN1bHRzOwogIH0KCiAgaWYgKCAobm9kZVR5cGUgPSBjb250ZXh0Lm5vZGVUeXBlKSAhPT0gMSAmJiBub2RlVHlwZSAhPT0gOSApIHsKICAgIHJldHVybiBbXTsKICB9CgogIGlmICggIWRvY3VtZW50SXNYTUwgJiYgIXNlZWQgKSB7CgogICAgLy8gU2hvcnRjdXRzCiAgICBpZiAoIChtYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKSkgKSB7CiAgICAgIC8vIFNwZWVkLXVwOiBTaXp6bGUoIiNJRCIpCiAgICAgIGlmICggKG0gPSBtYXRjaFsxXSkgKSB7CiAgICAgICAgaWYgKCBub2RlVHlwZSA9PT0gOSApIHsKICAgICAgICAgIGVsZW0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKCBtICk7CiAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwogICAgICAgICAgaWYgKCBlbGVtICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKICAgICAgICAgICAgLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIElFLCBPcGVyYSwgYW5kIFdlYmtpdCByZXR1cm4gaXRlbXMKICAgICAgICAgICAgLy8gYnkgbmFtZSBpbnN0ZWFkIG9mIElECiAgICAgICAgICAgIGlmICggZWxlbS5pZCA9PT0gbSApIHsKICAgICAgICAgICAgICByZXN1bHRzLnB1c2goIGVsZW0gKTsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIENvbnRleHQgaXMgbm90IGEgZG9jdW1lbnQKICAgICAgICAgIGlmICggY29udGV4dC5vd25lckRvY3VtZW50ICYmIChlbGVtID0gY29udGV4dC5vd25lckRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtICkpICYmCiAgICAgICAgICAgIGNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICkgJiYgZWxlbS5pZCA9PT0gbSApIHsKICAgICAgICAgICAgcmVzdWx0cy5wdXNoKCBlbGVtICk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgIC8vIFNwZWVkLXVwOiBTaXp6bGUoIlRBRyIpCiAgICAgIH0gZWxzZSBpZiAoIG1hdGNoWzJdICkgewogICAgICAgIHB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggc2VsZWN0b3IgKSwgMCkgKTsKICAgICAgICByZXR1cm4gcmVzdWx0czsKCiAgICAgIC8vIFNwZWVkLXVwOiBTaXp6bGUoIi5DTEFTUyIpCiAgICAgIH0gZWxzZSBpZiAoIChtID0gbWF0Y2hbM10pICYmIHN1cHBvcnQuZ2V0QnlDbGFzc05hbWUgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICkgewogICAgICAgIHB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBtICksIDApICk7CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgIH0KICAgIH0KCiAgICAvLyBRU0EgcGF0aAogICAgaWYgKCBzdXBwb3J0LnFzYSAmJiAhcmJ1Z2d5UVNBLnRlc3Qoc2VsZWN0b3IpICkgewogICAgICBvbGQgPSB0cnVlOwogICAgICBuaWQgPSBleHBhbmRvOwogICAgICBuZXdDb250ZXh0ID0gY29udGV4dDsKICAgICAgbmV3U2VsZWN0b3IgPSBub2RlVHlwZSA9PT0gOSAmJiBzZWxlY3RvcjsKCiAgICAgIC8vIHFTQSB3b3JrcyBzdHJhbmdlbHkgb24gRWxlbWVudC1yb290ZWQgcXVlcmllcwogICAgICAvLyBXZSBjYW4gd29yayBhcm91bmQgdGhpcyBieSBzcGVjaWZ5aW5nIGFuIGV4dHJhIElEIG9uIHRoZSByb290CiAgICAgIC8vIGFuZCB3b3JraW5nIHVwIGZyb20gdGhlcmUgKFRoYW5rcyB0byBBbmRyZXcgRHVwb250IGZvciB0aGUgdGVjaG5pcXVlKQogICAgICAvLyBJRSA4IGRvZXNuJ3Qgd29yayBvbiBvYmplY3QgZWxlbWVudHMKICAgICAgaWYgKCBub2RlVHlwZSA9PT0gMSAmJiBjb250ZXh0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJvYmplY3QiICkgewogICAgICAgIGdyb3VwcyA9IHRva2VuaXplKCBzZWxlY3RvciApOwoKICAgICAgICBpZiAoIChvbGQgPSBjb250ZXh0LmdldEF0dHJpYnV0ZSgiaWQiKSkgKSB7CiAgICAgICAgICBuaWQgPSBvbGQucmVwbGFjZSggcmVzY2FwZSwgIlxcJCYiICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnRleHQuc2V0QXR0cmlidXRlKCAiaWQiLCBuaWQgKTsKICAgICAgICB9CiAgICAgICAgbmlkID0gIltpZD0nIiArIG5pZCArICInXSAiOwoKICAgICAgICBpID0gZ3JvdXBzLmxlbmd0aDsKICAgICAgICB3aGlsZSAoIGktLSApIHsKICAgICAgICAgIGdyb3Vwc1tpXSA9IG5pZCArIHRvU2VsZWN0b3IoIGdyb3Vwc1tpXSApOwogICAgICAgIH0KICAgICAgICBuZXdDb250ZXh0ID0gcnNpYmxpbmcudGVzdCggc2VsZWN0b3IgKSAmJiBjb250ZXh0LnBhcmVudE5vZGUgfHwgY29udGV4dDsKICAgICAgICBuZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCIsIik7CiAgICAgIH0KCiAgICAgIGlmICggbmV3U2VsZWN0b3IgKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHB1c2guYXBwbHkoIHJlc3VsdHMsIHNsaWNlLmNhbGwoIG5ld0NvbnRleHQucXVlcnlTZWxlY3RvckFsbCgKICAgICAgICAgICAgbmV3U2VsZWN0b3IKICAgICAgICAgICksIDAgKSApOwogICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgfSBjYXRjaChxc2FFcnJvcikgewogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoICFvbGQgKSB7CiAgICAgICAgICAgIGNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCJpZCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLy8gQWxsIG90aGVycwogIHJldHVybiBzZWxlY3QoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKTsKfQoKLyoqCiAqIERldGVjdCB4bWwKICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gZWxlbSBBbiBlbGVtZW50IG9yIGEgZG9jdW1lbnQKICovCmlzWE1MID0gU2l6emxlLmlzWE1MID0gZnVuY3Rpb24oIGVsZW0gKSB7CiAgLy8gZG9jdW1lbnRFbGVtZW50IGlzIHZlcmlmaWVkIGZvciBjYXNlcyB3aGVyZSBpdCBkb2Vzbid0IHlldCBleGlzdAogIC8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKQogIHZhciBkb2N1bWVudEVsZW1lbnQgPSBlbGVtICYmIChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkuZG9jdW1lbnRFbGVtZW50OwogIHJldHVybiBkb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgIT09ICJIVE1MIiA6IGZhbHNlOwp9OwoKLyoqCiAqIFNldHMgZG9jdW1lbnQtcmVsYXRlZCB2YXJpYWJsZXMgb25jZSBiYXNlZCBvbiB0aGUgY3VycmVudCBkb2N1bWVudAogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBbZG9jXSBBbiBlbGVtZW50IG9yIGRvY3VtZW50IG9iamVjdCB0byB1c2UgdG8gc2V0IHRoZSBkb2N1bWVudAogKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjdXJyZW50IGRvY3VtZW50CiAqLwpzZXREb2N1bWVudCA9IFNpenpsZS5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKCBub2RlICkgewogIHZhciBkb2MgPSBub2RlID8gbm9kZS5vd25lckRvY3VtZW50IHx8IG5vZGUgOiBwcmVmZXJyZWREb2M7CgogIC8vIElmIG5vIGRvY3VtZW50IGFuZCBkb2N1bWVudEVsZW1lbnQgaXMgYXZhaWxhYmxlLCByZXR1cm4KICBpZiAoIGRvYyA9PT0gZG9jdW1lbnQgfHwgZG9jLm5vZGVUeXBlICE9PSA5IHx8ICFkb2MuZG9jdW1lbnRFbGVtZW50ICkgewogICAgcmV0dXJuIGRvY3VtZW50OwogIH0KCiAgLy8gU2V0IG91ciBkb2N1bWVudAogIGRvY3VtZW50ID0gZG9jOwogIGRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50OwoKICAvLyBTdXBwb3J0IHRlc3RzCiAgZG9jdW1lbnRJc1hNTCA9IGlzWE1MKCBkb2MgKTsKCiAgLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMKICBzdXBwb3J0LnRhZ05hbWVOb0NvbW1lbnRzID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CiAgICBkaXYuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVDb21tZW50KCIiKSApOwogICAgcmV0dXJuICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKS5sZW5ndGg7CiAgfSk7CgogIC8vIENoZWNrIGlmIGF0dHJpYnV0ZXMgc2hvdWxkIGJlIHJldHJpZXZlZCBieSBhdHRyaWJ1dGUgbm9kZXMKICBzdXBwb3J0LmF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKICAgIGRpdi5pbm5lckhUTUwgPSAiPHNlbGVjdD48L3NlbGVjdD4iOwogICAgdmFyIHR5cGUgPSB0eXBlb2YgZGl2Lmxhc3RDaGlsZC5nZXRBdHRyaWJ1dGUoIm11bHRpcGxlIik7CiAgICAvLyBJRTggcmV0dXJucyBhIHN0cmluZyBmb3Igc29tZSBhdHRyaWJ1dGVzIGV2ZW4gd2hlbiBub3QgcHJlc2VudAogICAgcmV0dXJuIHR5cGUgIT09ICJib29sZWFuIiAmJiB0eXBlICE9PSAic3RyaW5nIjsKICB9KTsKCiAgLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYW4gYmUgdHJ1c3RlZAogIHN1cHBvcnQuZ2V0QnlDbGFzc05hbWUgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKICAgIC8vIE9wZXJhIGNhbid0IGZpbmQgYSBzZWNvbmQgY2xhc3NuYW1lIChpbiA5LjYpCiAgICBkaXYuaW5uZXJIVE1MID0gIjxkaXYgY2xhc3M9J2hpZGRlbiBlJz48L2Rpdj48ZGl2IGNsYXNzPSdoaWRkZW4nPjwvZGl2PiI7CiAgICBpZiAoICFkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCAhZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImUiKS5sZW5ndGggKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBTYWZhcmkgMy4yIGNhY2hlcyBjbGFzcyBhdHRyaWJ1dGVzIGFuZCBkb2Vzbid0IGNhdGNoIGNoYW5nZXMKICAgIGRpdi5sYXN0Q2hpbGQuY2xhc3NOYW1lID0gImUiOwogICAgcmV0dXJuIGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJlIikubGVuZ3RoID09PSAyOwogIH0pOwoKICAvLyBDaGVjayBpZiBnZXRFbGVtZW50QnlJZCByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUKICAvLyBDaGVjayBpZiBnZXRFbGVtZW50c0J5TmFtZSBwcml2aWxlZ2VzIGZvcm0gY29udHJvbHMgb3IgcmV0dXJucyBlbGVtZW50cyBieSBJRAogIHN1cHBvcnQuZ2V0QnlOYW1lID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CiAgICAvLyBJbmplY3QgY29udGVudAogICAgZGl2LmlkID0gZXhwYW5kbyArIDA7CiAgICBkaXYuaW5uZXJIVE1MID0gIjxhIG5hbWU9JyIgKyBleHBhbmRvICsgIic+PC9hPjxkaXYgbmFtZT0nIiArIGV4cGFuZG8gKyAiJz48L2Rpdj4iOwogICAgZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGRpdiwgZG9jRWxlbS5maXJzdENoaWxkICk7CgogICAgLy8gVGVzdAogICAgdmFyIHBhc3MgPSBkb2MuZ2V0RWxlbWVudHNCeU5hbWUgJiYKICAgICAgLy8gYnVnZ3kgYnJvd3NlcnMgd2lsbCByZXR1cm4gZmV3ZXIgdGhhbiB0aGUgY29ycmVjdCAyCiAgICAgIGRvYy5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyApLmxlbmd0aCA9PT0gMiArCiAgICAgIC8vIGJ1Z2d5IGJyb3dzZXJzIHdpbGwgcmV0dXJuIG1vcmUgdGhhbiB0aGUgY29ycmVjdCAwCiAgICAgIGRvYy5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyArIDAgKS5sZW5ndGg7CiAgICBzdXBwb3J0LmdldElkTm90TmFtZSA9ICFkb2MuZ2V0RWxlbWVudEJ5SWQoIGV4cGFuZG8gKTsKCiAgICAvLyBDbGVhbnVwCiAgICBkb2NFbGVtLnJlbW92ZUNoaWxkKCBkaXYgKTsKCiAgICByZXR1cm4gcGFzczsKICB9KTsKCiAgLy8gSUU2LzcgcmV0dXJuIG1vZGlmaWVkIGF0dHJpYnV0ZXMKICBFeHByLmF0dHJIYW5kbGUgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKICAgIGRpdi5pbm5lckhUTUwgPSAiPGEgaHJlZj0nIyc+PC9hPiI7CiAgICByZXR1cm4gZGl2LmZpcnN0Q2hpbGQgJiYgdHlwZW9mIGRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSAhPT0gc3RydW5kZWZpbmVkICYmCiAgICAgIGRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgiaHJlZiIpID09PSAiIyI7CiAgfSkgPwogICAge30gOgogICAgewogICAgICAiaHJlZiI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggImhyZWYiLCAyICk7CiAgICAgIH0sCiAgICAgICJ0eXBlIjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIik7CiAgICAgIH0KICAgIH07CgogIC8vIElEIGZpbmQgYW5kIGZpbHRlcgogIGlmICggc3VwcG9ydC5nZXRJZE5vdE5hbWUgKSB7CiAgICBFeHByLmZpbmRbIklEIl0gPSBmdW5jdGlvbiggaWQsIGNvbnRleHQgKSB7CiAgICAgIGlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09IHN0cnVuZGVmaW5lZCAmJiAhZG9jdW1lbnRJc1hNTCApIHsKICAgICAgICB2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7CiAgICAgICAgLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgcmV0dXJuIG0gJiYgbS5wYXJlbnROb2RlID8gW21dIDogW107CiAgICAgIH0KICAgIH07CiAgICBFeHByLmZpbHRlclsiSUQiXSA9IGZ1bmN0aW9uKCBpZCApIHsKICAgICAgdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CiAgICAgIHJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IGF0dHJJZDsKICAgICAgfTsKICAgIH07CiAgfSBlbHNlIHsKICAgIEV4cHIuZmluZFsiSUQiXSA9IGZ1bmN0aW9uKCBpZCwgY29udGV4dCApIHsKICAgICAgaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gc3RydW5kZWZpbmVkICYmICFkb2N1bWVudElzWE1MICkgewogICAgICAgIHZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZCggaWQgKTsKCiAgICAgICAgcmV0dXJuIG0gPwogICAgICAgICAgbS5pZCA9PT0gaWQgfHwgdHlwZW9mIG0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gc3RydW5kZWZpbmVkICYmIG0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKS52YWx1ZSA9PT0gaWQgPwogICAgICAgICAgICBbbV0gOgogICAgICAgICAgICB1bmRlZmluZWQgOgogICAgICAgICAgW107CiAgICAgIH0KICAgIH07CiAgICBFeHByLmZpbHRlclsiSUQiXSA9ICBmdW5jdGlvbiggaWQgKSB7CiAgICAgIHZhciBhdHRySWQgPSBpZC5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwogICAgICByZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwogICAgICAgIHJldHVybiBub2RlICYmIG5vZGUudmFsdWUgPT09IGF0dHJJZDsKICAgICAgfTsKICAgIH07CiAgfQoKICAvLyBUYWcKICBFeHByLmZpbmRbIlRBRyJdID0gc3VwcG9ydC50YWdOYW1lTm9Db21tZW50cyA/CiAgICBmdW5jdGlvbiggdGFnLCBjb250ZXh0ICkgewogICAgICBpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSBzdHJ1bmRlZmluZWQgKSB7CiAgICAgICAgcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwogICAgICB9CiAgICB9IDoKICAgIGZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CiAgICAgIHZhciBlbGVtLAogICAgICAgIHRtcCA9IFtdLAogICAgICAgIGkgPSAwLAogICAgICAgIHJlc3VsdHMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKTsKCiAgICAgIC8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMKICAgICAgaWYgKCB0YWcgPT09ICIqIiApIHsKICAgICAgICBmb3IgKCA7IChlbGVtID0gcmVzdWx0c1tpXSk7IGkrKyApIHsKICAgICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKICAgICAgICAgICAgdG1wLnB1c2goIGVsZW0gKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0bXA7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9OwoKICAvLyBOYW1lCiAgRXhwci5maW5kWyJOQU1FIl0gPSBzdXBwb3J0LmdldEJ5TmFtZSAmJiBmdW5jdGlvbiggdGFnLCBjb250ZXh0ICkgewogICAgaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZSAhPT0gc3RydW5kZWZpbmVkICkgewogICAgICByZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZSggbmFtZSApOwogICAgfQogIH07CgogIC8vIENsYXNzCiAgRXhwci5maW5kWyJDTEFTUyJdID0gc3VwcG9ydC5nZXRCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiggY2xhc3NOYW1lLCBjb250ZXh0ICkgewogICAgaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICE9PSBzdHJ1bmRlZmluZWQgJiYgIWRvY3VtZW50SXNYTUwgKSB7CiAgICAgIHJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIGNsYXNzTmFtZSApOwogICAgfQogIH07CgogIC8vIFFTQSBhbmQgbWF0Y2hlc1NlbGVjdG9yIHN1cHBvcnQKCiAgLy8gbWF0Y2hlc1NlbGVjdG9yKDphY3RpdmUpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChJRTkvT3BlcmEgMTEuNSkKICByYnVnZ3lNYXRjaGVzID0gW107CgogIC8vIHFTYSg6Zm9jdXMpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChDaHJvbWUgMjEpLAogIC8vIG5vIG5lZWQgdG8gYWxzbyBhZGQgdG8gYnVnZ3lNYXRjaGVzIHNpbmNlIG1hdGNoZXMgY2hlY2tzIGJ1Z2d5UVNBCiAgLy8gQSBzdXBwb3J0IHRlc3Qgd291bGQgcmVxdWlyZSB0b28gbXVjaCBjb2RlICh3b3VsZCBpbmNsdWRlIGRvY3VtZW50IHJlYWR5KQogIHJidWdneVFTQSA9IFsgIjpmb2N1cyIgXTsKCiAgaWYgKCAoc3VwcG9ydC5xc2EgPSBpc05hdGl2ZShkb2MucXVlcnlTZWxlY3RvckFsbCkpICkgewogICAgLy8gQnVpbGQgUVNBIHJlZ2V4CiAgICAvLyBSZWdleCBzdHJhdGVneSBhZG9wdGVkIGZyb20gRGllZ28gUGVyaW5pCiAgICBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKICAgICAgLy8gU2VsZWN0IGlzIHNldCB0byBlbXB0eSBzdHJpbmcgb24gcHVycG9zZQogICAgICAvLyBUaGlzIGlzIHRvIHRlc3QgSUUncyB0cmVhdG1lbnQgb2Ygbm90IGV4cGxpY3RseQogICAgICAvLyBzZXR0aW5nIGEgYm9vbGVhbiBjb250ZW50IGF0dHJpYnV0ZSwKICAgICAgLy8gc2luY2UgaXRzIHByZXNlbmNlIHNob3VsZCBiZSBlbm91Z2gKICAgICAgLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIzNTkKICAgICAgZGl2LmlubmVySFRNTCA9ICI8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ9Jyc+PC9vcHRpb24+PC9zZWxlY3Q+IjsKCiAgICAgIC8vIElFOCAtIFNvbWUgYm9vbGVhbiBhdHRyaWJ1dGVzIGFyZSBub3QgdHJlYXRlZCBjb3JyZWN0bHkKICAgICAgaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIltzZWxlY3RlZF0iKS5sZW5ndGggKSB7CiAgICAgICAgcmJ1Z2d5UVNBLnB1c2goICJcXFsiICsgd2hpdGVzcGFjZSArICIqKD86Y2hlY2tlZHxkaXNhYmxlZHxpc21hcHxtdWx0aXBsZXxyZWFkb25seXxzZWxlY3RlZHx2YWx1ZSkiICk7CiAgICAgIH0KCiAgICAgIC8vIFdlYmtpdC9PcGVyYSAtIDpjaGVja2VkIHNob3VsZCByZXR1cm4gc2VsZWN0ZWQgb3B0aW9uIGVsZW1lbnRzCiAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCiAgICAgIC8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCiAgICAgIGlmICggIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCI6Y2hlY2tlZCIpLmxlbmd0aCApIHsKICAgICAgICByYnVnZ3lRU0EucHVzaCgiOmNoZWNrZWQiKTsKICAgICAgfQogICAgfSk7CgogICAgYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgogICAgICAvLyBPcGVyYSAxMC0xMi9JRTggLSBePSAkPSAqPSBhbmQgZW1wdHkgdmFsdWVzCiAgICAgIC8vIFNob3VsZCBub3Qgc2VsZWN0IGFueXRoaW5nCiAgICAgIGRpdi5pbm5lckhUTUwgPSAiPGlucHV0IHR5cGU9J2hpZGRlbicgaT0nJy8+IjsKICAgICAgaWYgKCBkaXYucXVlcnlTZWxlY3RvckFsbCgiW2lePScnXSIpLmxlbmd0aCApIHsKICAgICAgICByYnVnZ3lRU0EucHVzaCggIlsqXiRdPSIgKyB3aGl0ZXNwYWNlICsgIiooPzpcIlwifCcnKSIgKTsKICAgICAgfQoKICAgICAgLy8gRkYgMy41IC0gOmVuYWJsZWQvOmRpc2FibGVkIGFuZCBoaWRkZW4gZWxlbWVudHMgKGhpZGRlbiBlbGVtZW50cyBhcmUgc3RpbGwgZW5hYmxlZCkKICAgICAgLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIGFuZCB3aWxsIG5vdCBzZWUgbGF0ZXIgdGVzdHMKICAgICAgaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIjplbmFibGVkIikubGVuZ3RoICkgewogICAgICAgIHJidWdneVFTQS5wdXNoKCAiOmVuYWJsZWQiLCAiOmRpc2FibGVkIiApOwogICAgICB9CgogICAgICAvLyBPcGVyYSAxMC0xMSBkb2VzIG5vdCB0aHJvdyBvbiBwb3N0LWNvbW1hIGludmFsaWQgcHNldWRvcwogICAgICBkaXYucXVlcnlTZWxlY3RvckFsbCgiKiw6eCIpOwogICAgICByYnVnZ3lRU0EucHVzaCgiLC4qOiIpOwogICAgfSk7CiAgfQoKICBpZiAoIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciA9IGlzTmF0aXZlKCAobWF0Y2hlcyA9IGRvY0VsZW0ubWF0Y2hlc1NlbGVjdG9yIHx8CiAgICBkb2NFbGVtLm1vek1hdGNoZXNTZWxlY3RvciB8fAogICAgZG9jRWxlbS53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwKICAgIGRvY0VsZW0ub01hdGNoZXNTZWxlY3RvciB8fAogICAgZG9jRWxlbS5tc01hdGNoZXNTZWxlY3RvcikgKSkgKSB7CgogICAgYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CiAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgogICAgICAvLyBvbiBhIGRpc2Nvbm5lY3RlZCBub2RlIChJRSA5KQogICAgICBzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoID0gbWF0Y2hlcy5jYWxsKCBkaXYsICJkaXYiICk7CgogICAgICAvLyBUaGlzIHNob3VsZCBmYWlsIHdpdGggYW4gZXhjZXB0aW9uCiAgICAgIC8vIEdlY2tvIGRvZXMgbm90IGVycm9yLCByZXR1cm5zIGZhbHNlIGluc3RlYWQKICAgICAgbWF0Y2hlcy5jYWxsKCBkaXYsICJbcyE9JyddOngiICk7CiAgICAgIHJidWdneU1hdGNoZXMucHVzaCggIiE9IiwgcHNldWRvcyApOwogICAgfSk7CiAgfQoKICByYnVnZ3lRU0EgPSBuZXcgUmVnRXhwKCByYnVnZ3lRU0Euam9pbigifCIpICk7CiAgcmJ1Z2d5TWF0Y2hlcyA9IG5ldyBSZWdFeHAoIHJidWdneU1hdGNoZXMuam9pbigifCIpICk7CgogIC8vIEVsZW1lbnQgY29udGFpbnMgYW5vdGhlcgogIC8vIFB1cnBvc2VmdWxseSBkb2VzIG5vdCBpbXBsZW1lbnQgaW5jbHVzaXZlIGRlc2NlbmRlbnQKICAvLyBBcyBpbiwgYW4gZWxlbWVudCBkb2VzIG5vdCBjb250YWluIGl0c2VsZgogIGNvbnRhaW5zID0gaXNOYXRpdmUoZG9jRWxlbS5jb250YWlucykgfHwgZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/CiAgICBmdW5jdGlvbiggYSwgYiApIHsKICAgICAgdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKICAgICAgICBidXAgPSBiICYmIGIucGFyZW50Tm9kZTsKICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhISggYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoCiAgICAgICAgYWRvd24uY29udGFpbnMgPwogICAgICAgICAgYWRvd24uY29udGFpbnMoIGJ1cCApIDoKICAgICAgICAgIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYnVwICkgJiAxNgogICAgICApKTsKICAgIH0gOgogICAgZnVuY3Rpb24oIGEsIGIgKSB7CiAgICAgIGlmICggYiApIHsKICAgICAgICB3aGlsZSAoIChiID0gYi5wYXJlbnROb2RlKSApIHsKICAgICAgICAgIGlmICggYiA9PT0gYSApIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogIC8vIERvY3VtZW50IG9yZGVyIHNvcnRpbmcKICBzb3J0T3JkZXIgPSBkb2NFbGVtLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8KICBmdW5jdGlvbiggYSwgYiApIHsKICAgIHZhciBjb21wYXJlOwoKICAgIGlmICggYSA9PT0gYiApIHsKICAgICAgaGFzRHVwbGljYXRlID0gdHJ1ZTsKICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgaWYgKCAoY29tcGFyZSA9IGIuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBiICkpICkgewogICAgICBpZiAoIGNvbXBhcmUgJiAxIHx8IGEucGFyZW50Tm9kZSAmJiBhLnBhcmVudE5vZGUubm9kZVR5cGUgPT09IDExICkgewogICAgICAgIGlmICggYSA9PT0gZG9jIHx8IGNvbnRhaW5zKCBwcmVmZXJyZWREb2MsIGEgKSApIHsKICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgaWYgKCBiID09PSBkb2MgfHwgY29udGFpbnMoIHByZWZlcnJlZERvYywgYiApICkgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIHJldHVybiBjb21wYXJlICYgNCA/IC0xIDogMTsKICAgIH0KCiAgICByZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/IC0xIDogMTsKICB9IDoKICBmdW5jdGlvbiggYSwgYiApIHsKICAgIHZhciBjdXIsCiAgICAgIGkgPSAwLAogICAgICBhdXAgPSBhLnBhcmVudE5vZGUsCiAgICAgIGJ1cCA9IGIucGFyZW50Tm9kZSwKICAgICAgYXAgPSBbIGEgXSwKICAgICAgYnAgPSBbIGIgXTsKCiAgICAvLyBUaGUgbm9kZXMgYXJlIGlkZW50aWNhbCwgd2UgY2FuIGV4aXQgZWFybHkKICAgIGlmICggYSA9PT0gYiApIHsKICAgICAgaGFzRHVwbGljYXRlID0gdHJ1ZTsKICAgICAgcmV0dXJuIDA7CgogICAgLy8gRmFsbGJhY2sgdG8gdXNpbmcgc291cmNlSW5kZXggKGluIElFKSBpZiBpdCdzIGF2YWlsYWJsZSBvbiBib3RoIG5vZGVzCiAgICB9IGVsc2UgaWYgKCBhLnNvdXJjZUluZGV4ICYmIGIuc291cmNlSW5kZXggKSB7CiAgICAgIHJldHVybiAoIH5iLnNvdXJjZUluZGV4IHx8IE1BWF9ORUdBVElWRSApIC0gKCBjb250YWlucyggcHJlZmVycmVkRG9jLCBhICkgJiYgfmEuc291cmNlSW5kZXggfHwgTUFYX05FR0FUSVZFICk7CgogICAgLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQKICAgIH0gZWxzZSBpZiAoICFhdXAgfHwgIWJ1cCApIHsKICAgICAgcmV0dXJuIGEgPT09IGRvYyA/IC0xIDoKICAgICAgICBiID09PSBkb2MgPyAxIDoKICAgICAgICBhdXAgPyAtMSA6CiAgICAgICAgYnVwID8gMSA6CiAgICAgICAgMDsKCiAgICAvLyBJZiB0aGUgbm9kZXMgYXJlIHNpYmxpbmdzLCB3ZSBjYW4gZG8gYSBxdWljayBjaGVjawogICAgfSBlbHNlIGlmICggYXVwID09PSBidXAgKSB7CiAgICAgIHJldHVybiBzaWJsaW5nQ2hlY2soIGEsIGIgKTsKICAgIH0KCiAgICAvLyBPdGhlcndpc2Ugd2UgbmVlZCBmdWxsIGxpc3RzIG9mIHRoZWlyIGFuY2VzdG9ycyBmb3IgY29tcGFyaXNvbgogICAgY3VyID0gYTsKICAgIHdoaWxlICggKGN1ciA9IGN1ci5wYXJlbnROb2RlKSApIHsKICAgICAgYXAudW5zaGlmdCggY3VyICk7CiAgICB9CiAgICBjdXIgPSBiOwogICAgd2hpbGUgKCAoY3VyID0gY3VyLnBhcmVudE5vZGUpICkgewogICAgICBicC51bnNoaWZ0KCBjdXIgKTsKICAgIH0KCiAgICAvLyBXYWxrIGRvd24gdGhlIHRyZWUgbG9va2luZyBmb3IgYSBkaXNjcmVwYW5jeQogICAgd2hpbGUgKCBhcFtpXSA9PT0gYnBbaV0gKSB7CiAgICAgIGkrKzsKICAgIH0KCiAgICByZXR1cm4gaSA/CiAgICAgIC8vIERvIGEgc2libGluZyBjaGVjayBpZiB0aGUgbm9kZXMgaGF2ZSBhIGNvbW1vbiBhbmNlc3RvcgogICAgICBzaWJsaW5nQ2hlY2soIGFwW2ldLCBicFtpXSApIDoKCiAgICAgIC8vIE90aGVyd2lzZSBub2RlcyBpbiBvdXIgZG9jdW1lbnQgc29ydCBmaXJzdAogICAgICBhcFtpXSA9PT0gcHJlZmVycmVkRG9jID8gLTEgOgogICAgICBicFtpXSA9PT0gcHJlZmVycmVkRG9jID8gMSA6CiAgICAgIDA7CiAgfTsKCiAgLy8gQWx3YXlzIGFzc3VtZSB0aGUgcHJlc2VuY2Ugb2YgZHVwbGljYXRlcyBpZiBzb3J0IGRvZXNuJ3QKICAvLyBwYXNzIHRoZW0gdG8gb3VyIGNvbXBhcmlzb24gZnVuY3Rpb24gKGFzIGluIEdvb2dsZSBDaHJvbWUpLgogIGhhc0R1cGxpY2F0ZSA9IGZhbHNlOwogIFswLCAwXS5zb3J0KCBzb3J0T3JkZXIgKTsKICBzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXMgPSBoYXNEdXBsaWNhdGU7CgogIHJldHVybiBkb2N1bWVudDsKfTsKClNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIGVsZW1lbnRzICkgewogIHJldHVybiBTaXp6bGUoIGV4cHIsIG51bGwsIG51bGwsIGVsZW1lbnRzICk7Cn07CgpTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIGVsZW0sIGV4cHIgKSB7CiAgLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCiAgaWYgKCAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtICkgIT09IGRvY3VtZW50ICkgewogICAgc2V0RG9jdW1lbnQoIGVsZW0gKTsKICB9CgogIC8vIE1ha2Ugc3VyZSB0aGF0IGF0dHJpYnV0ZSBzZWxlY3RvcnMgYXJlIHF1b3RlZAogIGV4cHIgPSBleHByLnJlcGxhY2UoIHJhdHRyaWJ1dGVRdW90ZXMsICI9JyQxJ10iICk7CgogIC8vIHJidWdneVFTQSBhbHdheXMgY29udGFpbnMgOmZvY3VzLCBzbyBubyBuZWVkIGZvciBhbiBleGlzdGVuY2UgY2hlY2sKICBpZiAoIHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yICYmICFkb2N1bWVudElzWE1MICYmICghcmJ1Z2d5TWF0Y2hlcyB8fCAhcmJ1Z2d5TWF0Y2hlcy50ZXN0KGV4cHIpKSAmJiAhcmJ1Z2d5UVNBLnRlc3QoZXhwcikgKSB7CiAgICB0cnkgewogICAgICB2YXIgcmV0ID0gbWF0Y2hlcy5jYWxsKCBlbGVtLCBleHByICk7CgogICAgICAvLyBJRSA5J3MgbWF0Y2hlc1NlbGVjdG9yIHJldHVybnMgZmFsc2Ugb24gZGlzY29ubmVjdGVkIG5vZGVzCiAgICAgIGlmICggcmV0IHx8IHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggfHwKICAgICAgICAgIC8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50CiAgICAgICAgICAvLyBmcmFnbWVudCBpbiBJRSA5CiAgICAgICAgICBlbGVtLmRvY3VtZW50ICYmIGVsZW0uZG9jdW1lbnQubm9kZVR5cGUgIT09IDExICkgewogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICAgIH0gY2F0Y2goZSkge30KICB9CgogIHJldHVybiBTaXp6bGUoIGV4cHIsIGRvY3VtZW50LCBudWxsLCBbZWxlbV0gKS5sZW5ndGggPiAwOwp9OwoKU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24oIGNvbnRleHQsIGVsZW0gKSB7CiAgLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCiAgaWYgKCAoIGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0ICkgIT09IGRvY3VtZW50ICkgewogICAgc2V0RG9jdW1lbnQoIGNvbnRleHQgKTsKICB9CiAgcmV0dXJuIGNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICk7Cn07CgpTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewogIHZhciB2YWw7CgogIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogIGlmICggKCBlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSApICE9PSBkb2N1bWVudCApIHsKICAgIHNldERvY3VtZW50KCBlbGVtICk7CiAgfQoKICBpZiAoICFkb2N1bWVudElzWE1MICkgewogICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICB9CiAgaWYgKCAodmFsID0gRXhwci5hdHRySGFuZGxlWyBuYW1lIF0pICkgewogICAgcmV0dXJuIHZhbCggZWxlbSApOwogIH0KICBpZiAoIGRvY3VtZW50SXNYTUwgfHwgc3VwcG9ydC5hdHRyaWJ1dGVzICkgewogICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICk7CiAgfQogIHJldHVybiAoICh2YWwgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKSkgfHwgZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKSApICYmIGVsZW1bIG5hbWUgXSA9PT0gdHJ1ZSA/CiAgICBuYW1lIDoKICAgIHZhbCAmJiB2YWwuc3BlY2lmaWVkID8gdmFsLnZhbHVlIDogbnVsbDsKfTsKClNpenpsZS5lcnJvciA9IGZ1bmN0aW9uKCBtc2cgKSB7CiAgdGhyb3cgbmV3IEVycm9yKCAiU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogIiArIG1zZyApOwp9OwoKLy8gRG9jdW1lbnQgc29ydGluZyBhbmQgcmVtb3ZpbmcgZHVwbGljYXRlcwpTaXp6bGUudW5pcXVlU29ydCA9IGZ1bmN0aW9uKCByZXN1bHRzICkgewogIHZhciBlbGVtLAogICAgZHVwbGljYXRlcyA9IFtdLAogICAgaSA9IDEsCiAgICBqID0gMDsKCiAgLy8gVW5sZXNzIHdlICprbm93KiB3ZSBjYW4gZGV0ZWN0IGR1cGxpY2F0ZXMsIGFzc3VtZSB0aGVpciBwcmVzZW5jZQogIGhhc0R1cGxpY2F0ZSA9ICFzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXM7CiAgcmVzdWx0cy5zb3J0KCBzb3J0T3JkZXIgKTsKCiAgaWYgKCBoYXNEdXBsaWNhdGUgKSB7CiAgICBmb3IgKCA7IChlbGVtID0gcmVzdWx0c1tpXSk7IGkrKyApIHsKICAgICAgaWYgKCBlbGVtID09PSByZXN1bHRzWyBpIC0gMSBdICkgewogICAgICAgIGogPSBkdXBsaWNhdGVzLnB1c2goIGkgKTsKICAgICAgfQogICAgfQogICAgd2hpbGUgKCBqLS0gKSB7CiAgICAgIHJlc3VsdHMuc3BsaWNlKCBkdXBsaWNhdGVzWyBqIF0sIDEgKTsKICAgIH0KICB9CgogIHJldHVybiByZXN1bHRzOwp9OwoKZnVuY3Rpb24gc2libGluZ0NoZWNrKCBhLCBiICkgewogIHZhciBjdXIgPSBhICYmIGIgJiYgYS5uZXh0U2libGluZzsKCiAgZm9yICggOyBjdXI7IGN1ciA9IGN1ci5uZXh0U2libGluZyApIHsKICAgIGlmICggY3VyID09PSBiICkgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfQoKICByZXR1cm4gYSA/IDEgOiAtMTsKfQoKLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBpbnB1dCB0eXBlcwpmdW5jdGlvbiBjcmVhdGVJbnB1dFBzZXVkbyggdHlwZSApIHsKICByZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CiAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgIHJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKICB9Owp9CgovLyBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGJ1dHRvbnMKZnVuY3Rpb24gY3JlYXRlQnV0dG9uUHNldWRvKCB0eXBlICkgewogIHJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKICAgIHZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiBlbGVtLnR5cGUgPT09IHR5cGU7CiAgfTsKfQoKLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBwb3NpdGlvbmFscwpmdW5jdGlvbiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKCBmbiApIHsKICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBhcmd1bWVudCApIHsKICAgIGFyZ3VtZW50ID0gK2FyZ3VtZW50OwogICAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcyApIHsKICAgICAgdmFyIGosCiAgICAgICAgbWF0Y2hJbmRleGVzID0gZm4oIFtdLCBzZWVkLmxlbmd0aCwgYXJndW1lbnQgKSwKICAgICAgICBpID0gbWF0Y2hJbmRleGVzLmxlbmd0aDsKCiAgICAgIC8vIE1hdGNoIGVsZW1lbnRzIGZvdW5kIGF0IHRoZSBzcGVjaWZpZWQgaW5kZXhlcwogICAgICB3aGlsZSAoIGktLSApIHsKICAgICAgICBpZiAoIHNlZWRbIChqID0gbWF0Y2hJbmRleGVzW2ldKSBdICkgewogICAgICAgICAgc2VlZFtqXSA9ICEobWF0Y2hlc1tqXSA9IHNlZWRbal0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSk7Cn0KCi8qKgogKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwogKiBAcGFyYW0ge0FycmF5fEVsZW1lbnR9IGVsZW0KICovCmdldFRleHQgPSBTaXp6bGUuZ2V0VGV4dCA9IGZ1bmN0aW9uKCBlbGVtICkgewogIHZhciBub2RlLAogICAgcmV0ID0gIiIsCiAgICBpID0gMCwKICAgIG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKCiAgaWYgKCAhbm9kZVR5cGUgKSB7CiAgICAvLyBJZiBubyBub2RlVHlwZSwgdGhpcyBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheQogICAgZm9yICggOyAobm9kZSA9IGVsZW1baV0pOyBpKysgKSB7CiAgICAgIC8vIERvIG5vdCB0cmF2ZXJzZSBjb21tZW50IG5vZGVzCiAgICAgIHJldCArPSBnZXRUZXh0KCBub2RlICk7CiAgICB9CiAgfSBlbHNlIGlmICggbm9kZVR5cGUgPT09IDEgfHwgbm9kZVR5cGUgPT09IDkgfHwgbm9kZVR5cGUgPT09IDExICkgewogICAgLy8gVXNlIHRleHRDb250ZW50IGZvciBlbGVtZW50cwogICAgLy8gaW5uZXJUZXh0IHVzYWdlIHJlbW92ZWQgZm9yIGNvbnNpc3RlbmN5IG9mIG5ldyBsaW5lcyAoc2VlICMxMTE1MykKICAgIGlmICggdHlwZW9mIGVsZW0udGV4dENvbnRlbnQgPT09ICJzdHJpbmciICkgewogICAgICByZXR1cm4gZWxlbS50ZXh0Q29udGVudDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFRyYXZlcnNlIGl0cyBjaGlsZHJlbgogICAgICBmb3IgKCBlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZyApIHsKICAgICAgICByZXQgKz0gZ2V0VGV4dCggZWxlbSApOwogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmICggbm9kZVR5cGUgPT09IDMgfHwgbm9kZVR5cGUgPT09IDQgKSB7CiAgICByZXR1cm4gZWxlbS5ub2RlVmFsdWU7CiAgfQogIC8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwoKICByZXR1cm4gcmV0Owp9OwoKRXhwciA9IFNpenpsZS5zZWxlY3RvcnMgPSB7CgogIC8vIENhbiBiZSBhZGp1c3RlZCBieSB0aGUgdXNlcgogIGNhY2hlTGVuZ3RoOiA1MCwKCiAgY3JlYXRlUHNldWRvOiBtYXJrRnVuY3Rpb24sCgogIG1hdGNoOiBtYXRjaEV4cHIsCgogIGZpbmQ6IHt9LAoKICByZWxhdGl2ZTogewogICAgIj4iOiB7IGRpcjogInBhcmVudE5vZGUiLCBmaXJzdDogdHJ1ZSB9LAogICAgIiAiOiB7IGRpcjogInBhcmVudE5vZGUiIH0sCiAgICAiKyI6IHsgZGlyOiAicHJldmlvdXNTaWJsaW5nIiwgZmlyc3Q6IHRydWUgfSwKICAgICJ+IjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciIH0KICB9LAoKICBwcmVGaWx0ZXI6IHsKICAgICJBVFRSIjogZnVuY3Rpb24oIG1hdGNoICkgewogICAgICBtYXRjaFsxXSA9IG1hdGNoWzFdLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgogICAgICAvLyBNb3ZlIHRoZSBnaXZlbiB2YWx1ZSB0byBtYXRjaFszXSB3aGV0aGVyIHF1b3RlZCBvciB1bnF1b3RlZAogICAgICBtYXRjaFszXSA9ICggbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgIiIgKS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwoKICAgICAgaWYgKCBtYXRjaFsyXSA9PT0gIn49IiApIHsKICAgICAgICBtYXRjaFszXSA9ICIgIiArIG1hdGNoWzNdICsgIiAiOwogICAgICB9CgogICAgICByZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDQgKTsKICAgIH0sCgogICAgIkNISUxEIjogZnVuY3Rpb24oIG1hdGNoICkgewogICAgICAvKiBtYXRjaGVzIGZyb20gbWF0Y2hFeHByWyJDSElMRCJdCiAgICAgICAgMSB0eXBlIChvbmx5fG50aHwuLi4pCiAgICAgICAgMiB3aGF0IChjaGlsZHxvZi10eXBlKQogICAgICAgIDMgYXJndW1lbnQgKGV2ZW58b2RkfFxkKnxcZCpuKFsrLV1cZCspP3wuLi4pCiAgICAgICAgNCB4bi1jb21wb25lbnQgb2YgeG4reSBhcmd1bWVudCAoWystXT9cZCpufCkKICAgICAgICA1IHNpZ24gb2YgeG4tY29tcG9uZW50CiAgICAgICAgNiB4IG9mIHhuLWNvbXBvbmVudAogICAgICAgIDcgc2lnbiBvZiB5LWNvbXBvbmVudAogICAgICAgIDggeSBvZiB5LWNvbXBvbmVudAogICAgICAqLwogICAgICBtYXRjaFsxXSA9IG1hdGNoWzFdLnRvTG93ZXJDYXNlKCk7CgogICAgICBpZiAoIG1hdGNoWzFdLnNsaWNlKCAwLCAzICkgPT09ICJudGgiICkgewogICAgICAgIC8vIG50aC0qIHJlcXVpcmVzIGFyZ3VtZW50CiAgICAgICAgaWYgKCAhbWF0Y2hbM10gKSB7CiAgICAgICAgICBTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CiAgICAgICAgfQoKICAgICAgICAvLyBudW1lcmljIHggYW5kIHkgcGFyYW1ldGVycyBmb3IgRXhwci5maWx0ZXIuQ0hJTEQKICAgICAgICAvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCiAgICAgICAgbWF0Y2hbNF0gPSArKCBtYXRjaFs0XSA/IG1hdGNoWzVdICsgKG1hdGNoWzZdIHx8IDEpIDogMiAqICggbWF0Y2hbM10gPT09ICJldmVuIiB8fCBtYXRjaFszXSA9PT0gIm9kZCIgKSApOwogICAgICAgIG1hdGNoWzVdID0gKyggKCBtYXRjaFs3XSArIG1hdGNoWzhdICkgfHwgbWF0Y2hbM10gPT09ICJvZGQiICk7CgogICAgICAvLyBvdGhlciB0eXBlcyBwcm9oaWJpdCBhcmd1bWVudHMKICAgICAgfSBlbHNlIGlmICggbWF0Y2hbM10gKSB7CiAgICAgICAgU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwogICAgICB9CgogICAgICByZXR1cm4gbWF0Y2g7CiAgICB9LAoKICAgICJQU0VVRE8iOiBmdW5jdGlvbiggbWF0Y2ggKSB7CiAgICAgIHZhciBleGNlc3MsCiAgICAgICAgdW5xdW90ZWQgPSAhbWF0Y2hbNV0gJiYgbWF0Y2hbMl07CgogICAgICBpZiAoIG1hdGNoRXhwclsiQ0hJTEQiXS50ZXN0KCBtYXRjaFswXSApICkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICAvLyBBY2NlcHQgcXVvdGVkIGFyZ3VtZW50cyBhcy1pcwogICAgICBpZiAoIG1hdGNoWzRdICkgewogICAgICAgIG1hdGNoWzJdID0gbWF0Y2hbNF07CgogICAgICAvLyBTdHJpcCBleGNlc3MgY2hhcmFjdGVycyBmcm9tIHVucXVvdGVkIGFyZ3VtZW50cwogICAgICB9IGVsc2UgaWYgKCB1bnF1b3RlZCAmJiBycHNldWRvLnRlc3QoIHVucXVvdGVkICkgJiYKICAgICAgICAvLyBHZXQgZXhjZXNzIGZyb20gdG9rZW5pemUgKHJlY3Vyc2l2ZWx5KQogICAgICAgIChleGNlc3MgPSB0b2tlbml6ZSggdW5xdW90ZWQsIHRydWUgKSkgJiYKICAgICAgICAvLyBhZHZhbmNlIHRvIHRoZSBuZXh0IGNsb3NpbmcgcGFyZW50aGVzaXMKICAgICAgICAoZXhjZXNzID0gdW5xdW90ZWQuaW5kZXhPZiggIikiLCB1bnF1b3RlZC5sZW5ndGggLSBleGNlc3MgKSAtIHVucXVvdGVkLmxlbmd0aCkgKSB7CgogICAgICAgIC8vIGV4Y2VzcyBpcyBhIG5lZ2F0aXZlIGluZGV4CiAgICAgICAgbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSggMCwgZXhjZXNzICk7CiAgICAgICAgbWF0Y2hbMl0gPSB1bnF1b3RlZC5zbGljZSggMCwgZXhjZXNzICk7CiAgICAgIH0KCiAgICAgIC8vIFJldHVybiBvbmx5IGNhcHR1cmVzIG5lZWRlZCBieSB0aGUgcHNldWRvIGZpbHRlciBtZXRob2QgKHR5cGUgYW5kIGFyZ3VtZW50KQogICAgICByZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDMgKTsKICAgIH0KICB9LAoKICBmaWx0ZXI6IHsKCiAgICAiVEFHIjogZnVuY3Rpb24oIG5vZGVOYW1lICkgewogICAgICBpZiAoIG5vZGVOYW1lID09PSAiKiIgKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfTsKICAgICAgfQoKICAgICAgbm9kZU5hbWUgPSBub2RlTmFtZS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLnRvTG93ZXJDYXNlKCk7CiAgICAgIHJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICByZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5vZGVOYW1lOwogICAgICB9OwogICAgfSwKCiAgICAiQ0xBU1MiOiBmdW5jdGlvbiggY2xhc3NOYW1lICkgewogICAgICB2YXIgcGF0dGVybiA9IGNsYXNzQ2FjaGVbIGNsYXNzTmFtZSArICIgIiBdOwoKICAgICAgcmV0dXJuIHBhdHRlcm4gfHwKICAgICAgICAocGF0dGVybiA9IG5ldyBSZWdFeHAoICIoXnwiICsgd2hpdGVzcGFjZSArICIpIiArIGNsYXNzTmFtZSArICIoIiArIHdoaXRlc3BhY2UgKyAifCQpIiApKSAmJgogICAgICAgIGNsYXNzQ2FjaGUoIGNsYXNzTmFtZSwgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgICByZXR1cm4gcGF0dGVybi50ZXN0KCBlbGVtLmNsYXNzTmFtZSB8fCAodHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikpIHx8ICIiICk7CiAgICAgICAgfSk7CiAgICB9LAoKICAgICJBVFRSIjogZnVuY3Rpb24oIG5hbWUsIG9wZXJhdG9yLCBjaGVjayApIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAgIHZhciByZXN1bHQgPSBTaXp6bGUuYXR0ciggZWxlbSwgbmFtZSApOwoKICAgICAgICBpZiAoIHJlc3VsdCA9PSBudWxsICkgewogICAgICAgICAgcmV0dXJuIG9wZXJhdG9yID09PSAiIT0iOwogICAgICAgIH0KICAgICAgICBpZiAoICFvcGVyYXRvciApIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmVzdWx0ICs9ICIiOwoKICAgICAgICByZXR1cm4gb3BlcmF0b3IgPT09ICI9IiA/IHJlc3VsdCA9PT0gY2hlY2sgOgogICAgICAgICAgb3BlcmF0b3IgPT09ICIhPSIgPyByZXN1bHQgIT09IGNoZWNrIDoKICAgICAgICAgIG9wZXJhdG9yID09PSAiXj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPT09IDAgOgogICAgICAgICAgb3BlcmF0b3IgPT09ICIqPSIgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoKICAgICAgICAgIG9wZXJhdG9yID09PSAiJD0iID8gY2hlY2sgJiYgcmVzdWx0LnN1YnN0ciggcmVzdWx0Lmxlbmd0aCAtIGNoZWNrLmxlbmd0aCApID09PSBjaGVjayA6CiAgICAgICAgICBvcGVyYXRvciA9PT0gIn49IiA/ICggIiAiICsgcmVzdWx0ICsgIiAiICkuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoKICAgICAgICAgIG9wZXJhdG9yID09PSAifD0iID8gcmVzdWx0ID09PSBjaGVjayB8fCByZXN1bHQuc3Vic3RyKCAwLCBjaGVjay5sZW5ndGggKyAxICkgPT09IGNoZWNrICsgIi0iIDoKICAgICAgICAgIGZhbHNlOwogICAgICB9OwogICAgfSwKCiAgICAiQ0hJTEQiOiBmdW5jdGlvbiggdHlwZSwgd2hhdCwgYXJndW1lbnQsIGZpcnN0LCBsYXN0ICkgewogICAgICB2YXIgc2ltcGxlID0gdHlwZS5zbGljZSggMCwgMyApICE9PSAibnRoIiwKICAgICAgICBmb3J3YXJkID0gdHlwZS5zbGljZSggLTQgKSAhPT0gImxhc3QiLAogICAgICAgIG9mVHlwZSA9IHdoYXQgPT09ICJvZi10eXBlIjsKCiAgICAgIHJldHVybiBmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwID8KCiAgICAgICAgLy8gU2hvcnRjdXQgZm9yIDpudGgtKihuKQogICAgICAgIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAgICAgcmV0dXJuICEhZWxlbS5wYXJlbnROb2RlOwogICAgICAgIH0gOgoKICAgICAgICBmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewogICAgICAgICAgdmFyIGNhY2hlLCBvdXRlckNhY2hlLCBub2RlLCBkaWZmLCBub2RlSW5kZXgsIHN0YXJ0LAogICAgICAgICAgICBkaXIgPSBzaW1wbGUgIT09IGZvcndhcmQgPyAibmV4dFNpYmxpbmciIDogInByZXZpb3VzU2libGluZyIsCiAgICAgICAgICAgIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZSwKICAgICAgICAgICAgbmFtZSA9IG9mVHlwZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIHVzZUNhY2hlID0gIXhtbCAmJiAhb2ZUeXBlOwoKICAgICAgICAgIGlmICggcGFyZW50ICkgewoKICAgICAgICAgICAgLy8gOihmaXJzdHxsYXN0fG9ubHkpLShjaGlsZHxvZi10eXBlKQogICAgICAgICAgICBpZiAoIHNpbXBsZSApIHsKICAgICAgICAgICAgICB3aGlsZSAoIGRpciApIHsKICAgICAgICAgICAgICAgIG5vZGUgPSBlbGVtOwogICAgICAgICAgICAgICAgd2hpbGUgKCAobm9kZSA9IG5vZGVbIGRpciBdKSApIHsKICAgICAgICAgICAgICAgICAgaWYgKCBvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxICkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gUmV2ZXJzZSBkaXJlY3Rpb24gZm9yIDpvbmx5LSogKGlmIHdlIGhhdmVuJ3QgeWV0IGRvbmUgc28pCiAgICAgICAgICAgICAgICBzdGFydCA9IGRpciA9IHR5cGUgPT09ICJvbmx5IiAmJiAhc3RhcnQgJiYgIm5leHRTaWJsaW5nIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN0YXJ0ID0gWyBmb3J3YXJkID8gcGFyZW50LmZpcnN0Q2hpbGQgOiBwYXJlbnQubGFzdENoaWxkIF07CgogICAgICAgICAgICAvLyBub24teG1sIDpudGgtY2hpbGQoLi4uKSBzdG9yZXMgY2FjaGUgZGF0YSBvbiBgcGFyZW50YAogICAgICAgICAgICBpZiAoIGZvcndhcmQgJiYgdXNlQ2FjaGUgKSB7CiAgICAgICAgICAgICAgLy8gU2VlayBgZWxlbWAgZnJvbSBhIHByZXZpb3VzbHktY2FjaGVkIGluZGV4CiAgICAgICAgICAgICAgb3V0ZXJDYWNoZSA9IHBhcmVudFsgZXhwYW5kbyBdIHx8IChwYXJlbnRbIGV4cGFuZG8gXSA9IHt9KTsKICAgICAgICAgICAgICBjYWNoZSA9IG91dGVyQ2FjaGVbIHR5cGUgXSB8fCBbXTsKICAgICAgICAgICAgICBub2RlSW5kZXggPSBjYWNoZVswXSA9PT0gZGlycnVucyAmJiBjYWNoZVsxXTsKICAgICAgICAgICAgICBkaWZmID0gY2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbMl07CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1sgbm9kZUluZGV4IF07CgogICAgICAgICAgICAgIHdoaWxlICggKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbIGRpciBdIHx8CgogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gc2Vla2luZyBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKICAgICAgICAgICAgICAgIChkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpICkgewoKICAgICAgICAgICAgICAgIC8vIFdoZW4gZm91bmQsIGNhY2hlIGluZGV4ZXMgb24gYHBhcmVudGAgYW5kIGJyZWFrCiAgICAgICAgICAgICAgICBpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgJiYgKytkaWZmICYmIG5vZGUgPT09IGVsZW0gKSB7CiAgICAgICAgICAgICAgICAgIG91dGVyQ2FjaGVbIHR5cGUgXSA9IFsgZGlycnVucywgbm9kZUluZGV4LCBkaWZmIF07CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQogICAgICAgICAgICB9IGVsc2UgaWYgKCB1c2VDYWNoZSAmJiAoY2FjaGUgPSAoZWxlbVsgZXhwYW5kbyBdIHx8IChlbGVtWyBleHBhbmRvIF0gPSB7fSkpWyB0eXBlIF0pICYmIGNhY2hlWzBdID09PSBkaXJydW5zICkgewogICAgICAgICAgICAgIGRpZmYgPSBjYWNoZVsxXTsKCiAgICAgICAgICAgIC8vIHhtbCA6bnRoLWNoaWxkKC4uLikgb3IgOm50aC1sYXN0LWNoaWxkKC4uLikgb3IgOm50aCgtbGFzdCk/LW9mLXR5cGUoLi4uKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIFVzZSB0aGUgc2FtZSBsb29wIGFzIGFib3ZlIHRvIHNlZWsgYGVsZW1gIGZyb20gdGhlIHN0YXJ0CiAgICAgICAgICAgICAgd2hpbGUgKCAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwKICAgICAgICAgICAgICAgIChkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpICkgewoKICAgICAgICAgICAgICAgIGlmICggKCBvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxICkgJiYgKytkaWZmICkgewogICAgICAgICAgICAgICAgICAvLyBDYWNoZSB0aGUgaW5kZXggb2YgZWFjaCBlbmNvdW50ZXJlZCBlbGVtZW50CiAgICAgICAgICAgICAgICAgIGlmICggdXNlQ2FjaGUgKSB7CiAgICAgICAgICAgICAgICAgICAgKG5vZGVbIGV4cGFuZG8gXSB8fCAobm9kZVsgZXhwYW5kbyBdID0ge30pKVsgdHlwZSBdID0gWyBkaXJydW5zLCBkaWZmIF07CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmICggbm9kZSA9PT0gZWxlbSApIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSW5jb3Jwb3JhdGUgdGhlIG9mZnNldCwgdGhlbiBjaGVjayBhZ2FpbnN0IGN5Y2xlIHNpemUKICAgICAgICAgICAgZGlmZiAtPSBsYXN0OwogICAgICAgICAgICByZXR1cm4gZGlmZiA9PT0gZmlyc3QgfHwgKCBkaWZmICUgZmlyc3QgPT09IDAgJiYgZGlmZiAvIGZpcnN0ID49IDAgKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSwKCiAgICAiUFNFVURPIjogZnVuY3Rpb24oIHBzZXVkbywgYXJndW1lbnQgKSB7CiAgICAgIC8vIHBzZXVkby1jbGFzcyBuYW1lcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZQogICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI3BzZXVkby1jbGFzc2VzCiAgICAgIC8vIFByaW9yaXRpemUgYnkgY2FzZSBzZW5zaXRpdml0eSBpbiBjYXNlIGN1c3RvbSBwc2V1ZG9zIGFyZSBhZGRlZCB3aXRoIHVwcGVyY2FzZSBsZXR0ZXJzCiAgICAgIC8vIFJlbWVtYmVyIHRoYXQgc2V0RmlsdGVycyBpbmhlcml0cyBmcm9tIHBzZXVkb3MKICAgICAgdmFyIGFyZ3MsCiAgICAgICAgZm4gPSBFeHByLnBzZXVkb3NbIHBzZXVkbyBdIHx8IEV4cHIuc2V0RmlsdGVyc1sgcHNldWRvLnRvTG93ZXJDYXNlKCkgXSB8fAogICAgICAgICAgU2l6emxlLmVycm9yKCAidW5zdXBwb3J0ZWQgcHNldWRvOiAiICsgcHNldWRvICk7CgogICAgICAvLyBUaGUgdXNlciBtYXkgdXNlIGNyZWF0ZVBzZXVkbyB0byBpbmRpY2F0ZSB0aGF0CiAgICAgIC8vIGFyZ3VtZW50cyBhcmUgbmVlZGVkIHRvIGNyZWF0ZSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgIC8vIGp1c3QgYXMgU2l6emxlIGRvZXMKICAgICAgaWYgKCBmblsgZXhwYW5kbyBdICkgewogICAgICAgIHJldHVybiBmbiggYXJndW1lbnQgKTsKICAgICAgfQoKICAgICAgLy8gQnV0IG1haW50YWluIHN1cHBvcnQgZm9yIG9sZCBzaWduYXR1cmVzCiAgICAgIGlmICggZm4ubGVuZ3RoID4gMSApIHsKICAgICAgICBhcmdzID0gWyBwc2V1ZG8sIHBzZXVkbywgIiIsIGFyZ3VtZW50IF07CiAgICAgICAgcmV0dXJuIEV4cHIuc2V0RmlsdGVycy5oYXNPd25Qcm9wZXJ0eSggcHNldWRvLnRvTG93ZXJDYXNlKCkgKSA/CiAgICAgICAgICBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CiAgICAgICAgICAgIHZhciBpZHgsCiAgICAgICAgICAgICAgbWF0Y2hlZCA9IGZuKCBzZWVkLCBhcmd1bWVudCApLAogICAgICAgICAgICAgIGkgPSBtYXRjaGVkLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKCBpLS0gKSB7CiAgICAgICAgICAgICAgaWR4ID0gaW5kZXhPZi5jYWxsKCBzZWVkLCBtYXRjaGVkW2ldICk7CiAgICAgICAgICAgICAgc2VlZFsgaWR4IF0gPSAhKCBtYXRjaGVzWyBpZHggXSA9IG1hdGNoZWRbaV0gKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkgOgogICAgICAgICAgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgICAgIHJldHVybiBmbiggZWxlbSwgMCwgYXJncyApOwogICAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZuOwogICAgfQogIH0sCgogIHBzZXVkb3M6IHsKICAgIC8vIFBvdGVudGlhbGx5IGNvbXBsZXggcHNldWRvcwogICAgIm5vdCI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICAgIC8vIFRyaW0gdGhlIHNlbGVjdG9yIHBhc3NlZCB0byBjb21waWxlCiAgICAgIC8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCiAgICAgIC8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwogICAgICB2YXIgaW5wdXQgPSBbXSwKICAgICAgICByZXN1bHRzID0gW10sCiAgICAgICAgbWF0Y2hlciA9IGNvbXBpbGUoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICkgKTsKCiAgICAgIHJldHVybiBtYXRjaGVyWyBleHBhbmRvIF0gPwogICAgICAgIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcywgY29udGV4dCwgeG1sICkgewogICAgICAgICAgdmFyIGVsZW0sCiAgICAgICAgICAgIHVubWF0Y2hlZCA9IG1hdGNoZXIoIHNlZWQsIG51bGwsIHhtbCwgW10gKSwKICAgICAgICAgICAgaSA9IHNlZWQubGVuZ3RoOwoKICAgICAgICAgIC8vIE1hdGNoIGVsZW1lbnRzIHVubWF0Y2hlZCBieSBgbWF0Y2hlcmAKICAgICAgICAgIHdoaWxlICggaS0tICkgewogICAgICAgICAgICBpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKICAgICAgICAgICAgICBzZWVkW2ldID0gIShtYXRjaGVzW2ldID0gZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KSA6CiAgICAgICAgZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKICAgICAgICAgIGlucHV0WzBdID0gZWxlbTsKICAgICAgICAgIG1hdGNoZXIoIGlucHV0LCBudWxsLCB4bWwsIHJlc3VsdHMgKTsKICAgICAgICAgIHJldHVybiAhcmVzdWx0cy5wb3AoKTsKICAgICAgICB9OwogICAgfSksCgogICAgImhhcyI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICByZXR1cm4gU2l6emxlKCBzZWxlY3RvciwgZWxlbSApLmxlbmd0aCA+IDA7CiAgICAgIH07CiAgICB9KSwKCiAgICAiY29udGFpbnMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHRleHQgKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgICByZXR1cm4gKCBlbGVtLnRleHRDb250ZW50IHx8IGVsZW0uaW5uZXJUZXh0IHx8IGdldFRleHQoIGVsZW0gKSApLmluZGV4T2YoIHRleHQgKSA+IC0xOwogICAgICB9OwogICAgfSksCgogICAgLy8gIldoZXRoZXIgYW4gZWxlbWVudCBpcyByZXByZXNlbnRlZCBieSBhIDpsYW5nKCkgc2VsZWN0b3IKICAgIC8vIGlzIGJhc2VkIHNvbGVseSBvbiB0aGUgZWxlbWVudCdzIGxhbmd1YWdlIHZhbHVlCiAgICAvLyBiZWluZyBlcXVhbCB0byB0aGUgaWRlbnRpZmllciBDLAogICAgLy8gb3IgYmVnaW5uaW5nIHdpdGggdGhlIGlkZW50aWZpZXIgQyBpbW1lZGlhdGVseSBmb2xsb3dlZCBieSAiLSIuCiAgICAvLyBUaGUgbWF0Y2hpbmcgb2YgQyBhZ2FpbnN0IHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUgaXMgcGVyZm9ybWVkIGNhc2UtaW5zZW5zaXRpdmVseS4KICAgIC8vIFRoZSBpZGVudGlmaWVyIEMgZG9lcyBub3QgaGF2ZSB0byBiZSBhIHZhbGlkIGxhbmd1YWdlIG5hbWUuIgogICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNsYW5nLXBzZXVkbwogICAgImxhbmciOiBtYXJrRnVuY3Rpb24oIGZ1bmN0aW9uKCBsYW5nICkgewogICAgICAvLyBsYW5nIHZhbHVlIG11c3QgYmUgYSB2YWxpZCBpZGVudGlmaWRlcgogICAgICBpZiAoICFyaWRlbnRpZmllci50ZXN0KGxhbmcgfHwgIiIpICkgewogICAgICAgIFNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIGxhbmc6ICIgKyBsYW5nICk7CiAgICAgIH0KICAgICAgbGFuZyA9IGxhbmcucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKS50b0xvd2VyQ2FzZSgpOwogICAgICByZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgICAgdmFyIGVsZW1MYW5nOwogICAgICAgIGRvIHsKICAgICAgICAgIGlmICggKGVsZW1MYW5nID0gZG9jdW1lbnRJc1hNTCA/CiAgICAgICAgICAgIGVsZW0uZ2V0QXR0cmlidXRlKCJ4bWw6bGFuZyIpIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJsYW5nIikgOgogICAgICAgICAgICBlbGVtLmxhbmcpICkgewoKICAgICAgICAgICAgZWxlbUxhbmcgPSBlbGVtTGFuZy50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICByZXR1cm4gZWxlbUxhbmcgPT09IGxhbmcgfHwgZWxlbUxhbmcuaW5kZXhPZiggbGFuZyArICItIiApID09PSAwOwogICAgICAgICAgfQogICAgICAgIH0gd2hpbGUgKCAoZWxlbSA9IGVsZW0ucGFyZW50Tm9kZSkgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgIH0pLAoKICAgIC8vIE1pc2NlbGxhbmVvdXMKICAgICJ0YXJnZXQiOiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgdmFyIGhhc2ggPSB3aW5kb3cubG9jYXRpb24gJiYgd2luZG93LmxvY2F0aW9uLmhhc2g7CiAgICAgIHJldHVybiBoYXNoICYmIGhhc2guc2xpY2UoIDEgKSA9PT0gZWxlbS5pZDsKICAgIH0sCgogICAgInJvb3QiOiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgcmV0dXJuIGVsZW0gPT09IGRvY0VsZW07CiAgICB9LAoKICAgICJmb2N1cyI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICByZXR1cm4gZWxlbSA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAoIWRvY3VtZW50Lmhhc0ZvY3VzIHx8IGRvY3VtZW50Lmhhc0ZvY3VzKCkpICYmICEhKGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXgpOwogICAgfSwKCiAgICAvLyBCb29sZWFuIHByb3BlcnRpZXMKICAgICJlbmFibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZTsKICAgIH0sCgogICAgImRpc2FibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSB0cnVlOwogICAgfSwKCiAgICAiY2hlY2tlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAvLyBJbiBDU1MzLCA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIGJvdGggY2hlY2tlZCBhbmQgc2VsZWN0ZWQgZWxlbWVudHMKICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICByZXR1cm4gKG5vZGVOYW1lID09PSAiaW5wdXQiICYmICEhZWxlbS5jaGVja2VkKSB8fCAobm9kZU5hbWUgPT09ICJvcHRpb24iICYmICEhZWxlbS5zZWxlY3RlZCk7CiAgICB9LAoKICAgICJzZWxlY3RlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CiAgICAgIC8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkKICAgICAgaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CiAgICAgICAgZWxlbS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CiAgICAgIH0KCiAgICAgIHJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOwogICAgfSwKCiAgICAvLyBDb250ZW50cwogICAgImVtcHR5IjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jZW1wdHktcHNldWRvCiAgICAgIC8vIDplbXB0eSBpcyBvbmx5IGFmZmVjdGVkIGJ5IGVsZW1lbnQgbm9kZXMgYW5kIGNvbnRlbnQgbm9kZXMoaW5jbHVkaW5nIHRleHQoMyksIGNkYXRhKDQpKSwKICAgICAgLy8gICBub3QgY29tbWVudCwgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbnMsIG9yIG90aGVycwogICAgICAvLyBUaGFua3MgdG8gRGllZ28gUGVyaW5pIGZvciB0aGUgbm9kZU5hbWUgc2hvcnRjdXQKICAgICAgLy8gICBHcmVhdGVyIHRoYW4gIkAiIG1lYW5zIGFscGhhIGNoYXJhY3RlcnMgKHNwZWNpZmljYWxseSBub3Qgc3RhcnRpbmcgd2l0aCAiIyIgb3IgIj8iKQogICAgICBmb3IgKCBlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZyApIHsKICAgICAgICBpZiAoIGVsZW0ubm9kZU5hbWUgPiAiQCIgfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA0ICkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgInBhcmVudCI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICByZXR1cm4gIUV4cHIucHNldWRvc1siZW1wdHkiXSggZWxlbSApOwogICAgfSwKCiAgICAvLyBFbGVtZW50L2lucHV0IHR5cGVzCiAgICAiaGVhZGVyIjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIHJldHVybiByaGVhZGVyLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKICAgIH0sCgogICAgImlucHV0IjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIHJldHVybiByaW5wdXRzLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKICAgIH0sCgogICAgImJ1dHRvbiI6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgcmV0dXJuIG5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSAiYnV0dG9uIiB8fCBuYW1lID09PSAiYnV0dG9uIjsKICAgIH0sCgogICAgInRleHQiOiBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgdmFyIGF0dHI7CiAgICAgIC8vIElFNiBhbmQgNyB3aWxsIG1hcCBlbGVtLnR5cGUgdG8gJ3RleHQnIGZvciBuZXcgSFRNTDUgdHlwZXMgKHNlYXJjaCwgZXRjKQogICAgICAvLyB1c2UgZ2V0QXR0cmlidXRlIGluc3RlYWQgdG8gdGVzdCB0aGlzIGNhc2UKICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJgogICAgICAgIGVsZW0udHlwZSA9PT0gInRleHQiICYmCiAgICAgICAgKCAoYXR0ciA9IGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIikpID09IG51bGwgfHwgYXR0ci50b0xvd2VyQ2FzZSgpID09PSBlbGVtLnR5cGUgKTsKICAgIH0sCgogICAgLy8gUG9zaXRpb24taW4tY29sbGVjdGlvbgogICAgImZpcnN0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFsgMCBdOwogICAgfSksCgogICAgImxhc3QiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKICAgICAgcmV0dXJuIFsgbGVuZ3RoIC0gMSBdOwogICAgfSksCgogICAgImVxIjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewogICAgICByZXR1cm4gWyBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50IF07CiAgICB9KSwKCiAgICAiZXZlbiI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewogICAgICB2YXIgaSA9IDA7CiAgICAgIGZvciAoIDsgaSA8IGxlbmd0aDsgaSArPSAyICkgewogICAgICAgIG1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoSW5kZXhlczsKICAgIH0pLAoKICAgICJvZGQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKICAgICAgdmFyIGkgPSAxOwogICAgICBmb3IgKCA7IGkgPCBsZW5ndGg7IGkgKz0gMiApIHsKICAgICAgICBtYXRjaEluZGV4ZXMucHVzaCggaSApOwogICAgICB9CiAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICB9KSwKCiAgICAibHQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CiAgICAgIHZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudDsKICAgICAgZm9yICggOyAtLWkgPj0gMDsgKSB7CiAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsKICAgICAgfQogICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgfSksCgogICAgImd0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewogICAgICB2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7CiAgICAgIGZvciAoIDsgKytpIDwgbGVuZ3RoOyApIHsKICAgICAgICBtYXRjaEluZGV4ZXMucHVzaCggaSApOwogICAgICB9CiAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICB9KQogIH0KfTsKCi8vIEFkZCBidXR0b24vaW5wdXQgdHlwZSBwc2V1ZG9zCmZvciAoIGkgaW4geyByYWRpbzogdHJ1ZSwgY2hlY2tib3g6IHRydWUsIGZpbGU6IHRydWUsIHBhc3N3b3JkOiB0cnVlLCBpbWFnZTogdHJ1ZSB9ICkgewogIEV4cHIucHNldWRvc1sgaSBdID0gY3JlYXRlSW5wdXRQc2V1ZG8oIGkgKTsKfQpmb3IgKCBpIGluIHsgc3VibWl0OiB0cnVlLCByZXNldDogdHJ1ZSB9ICkgewogIEV4cHIucHNldWRvc1sgaSBdID0gY3JlYXRlQnV0dG9uUHNldWRvKCBpICk7Cn0KCmZ1bmN0aW9uIHRva2VuaXplKCBzZWxlY3RvciwgcGFyc2VPbmx5ICkgewogIHZhciBtYXRjaGVkLCBtYXRjaCwgdG9rZW5zLCB0eXBlLAogICAgc29GYXIsIGdyb3VwcywgcHJlRmlsdGVycywKICAgIGNhY2hlZCA9IHRva2VuQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgogIGlmICggY2FjaGVkICkgewogICAgcmV0dXJuIHBhcnNlT25seSA/IDAgOiBjYWNoZWQuc2xpY2UoIDAgKTsKICB9CgogIHNvRmFyID0gc2VsZWN0b3I7CiAgZ3JvdXBzID0gW107CiAgcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyOwoKICB3aGlsZSAoIHNvRmFyICkgewoKICAgIC8vIENvbW1hIGFuZCBmaXJzdCBydW4KICAgIGlmICggIW1hdGNoZWQgfHwgKG1hdGNoID0gcmNvbW1hLmV4ZWMoIHNvRmFyICkpICkgewogICAgICBpZiAoIG1hdGNoICkgewogICAgICAgIC8vIERvbid0IGNvbnN1bWUgdHJhaWxpbmcgY29tbWFzIGFzIHZhbGlkCiAgICAgICAgc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hbMF0ubGVuZ3RoICkgfHwgc29GYXI7CiAgICAgIH0KICAgICAgZ3JvdXBzLnB1c2goIHRva2VucyA9IFtdICk7CiAgICB9CgogICAgbWF0Y2hlZCA9IGZhbHNlOwoKICAgIC8vIENvbWJpbmF0b3JzCiAgICBpZiAoIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApKSApIHsKICAgICAgbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CiAgICAgIHRva2Vucy5wdXNoKCB7CiAgICAgICAgdmFsdWU6IG1hdGNoZWQsCiAgICAgICAgLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCiAgICAgICAgdHlwZTogbWF0Y2hbMF0ucmVwbGFjZSggcnRyaW0sICIgIiApCiAgICAgIH0gKTsKICAgICAgc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hlZC5sZW5ndGggKTsKICAgIH0KCiAgICAvLyBGaWx0ZXJzCiAgICBmb3IgKCB0eXBlIGluIEV4cHIuZmlsdGVyICkgewogICAgICBpZiAoIChtYXRjaCA9IG1hdGNoRXhwclsgdHlwZSBdLmV4ZWMoIHNvRmFyICkpICYmICghcHJlRmlsdGVyc1sgdHlwZSBdIHx8CiAgICAgICAgKG1hdGNoID0gcHJlRmlsdGVyc1sgdHlwZSBdKCBtYXRjaCApKSkgKSB7CiAgICAgICAgbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CiAgICAgICAgdG9rZW5zLnB1c2goIHsKICAgICAgICAgIHZhbHVlOiBtYXRjaGVkLAogICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgIG1hdGNoZXM6IG1hdGNoCiAgICAgICAgfSApOwogICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoICFtYXRjaGVkICkgewogICAgICBicmVhazsKICAgIH0KICB9CgogIC8vIFJldHVybiB0aGUgbGVuZ3RoIG9mIHRoZSBpbnZhbGlkIGV4Y2VzcwogIC8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwogIC8vIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3Igb3IgcmV0dXJuIHRva2VucwogIHJldHVybiBwYXJzZU9ubHkgPwogICAgc29GYXIubGVuZ3RoIDoKICAgIHNvRmFyID8KICAgICAgU2l6emxlLmVycm9yKCBzZWxlY3RvciApIDoKICAgICAgLy8gQ2FjaGUgdGhlIHRva2VucwogICAgICB0b2tlbkNhY2hlKCBzZWxlY3RvciwgZ3JvdXBzICkuc2xpY2UoIDAgKTsKfQoKZnVuY3Rpb24gdG9TZWxlY3RvciggdG9rZW5zICkgewogIHZhciBpID0gMCwKICAgIGxlbiA9IHRva2Vucy5sZW5ndGgsCiAgICBzZWxlY3RvciA9ICIiOwogIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgc2VsZWN0b3IgKz0gdG9rZW5zW2ldLnZhbHVlOwogIH0KICByZXR1cm4gc2VsZWN0b3I7Cn0KCmZ1bmN0aW9uIGFkZENvbWJpbmF0b3IoIG1hdGNoZXIsIGNvbWJpbmF0b3IsIGJhc2UgKSB7CiAgdmFyIGRpciA9IGNvbWJpbmF0b3IuZGlyLAogICAgY2hlY2tOb25FbGVtZW50cyA9IGJhc2UgJiYgY29tYmluYXRvci5kaXIgPT09ICJwYXJlbnROb2RlIiwKICAgIGRvbmVOYW1lID0gZG9uZSsrOwoKICByZXR1cm4gY29tYmluYXRvci5maXJzdCA/CiAgICAvLyBDaGVjayBhZ2FpbnN0IGNsb3Nlc3QgYW5jZXN0b3IvcHJlY2VkaW5nIGVsZW1lbnQKICAgIGZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CiAgICAgIHdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CiAgICAgICAgaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CiAgICAgICAgICByZXR1cm4gbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICk7CiAgICAgICAgfQogICAgICB9CiAgICB9IDoKCiAgICAvLyBDaGVjayBhZ2FpbnN0IGFsbCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudHMKICAgIGZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CiAgICAgIHZhciBkYXRhLCBjYWNoZSwgb3V0ZXJDYWNoZSwKICAgICAgICBkaXJrZXkgPSBkaXJydW5zICsgIiAiICsgZG9uZU5hbWU7CgogICAgICAvLyBXZSBjYW4ndCBzZXQgYXJiaXRyYXJ5IGRhdGEgb24gWE1MIG5vZGVzLCBzbyB0aGV5IGRvbid0IGJlbmVmaXQgZnJvbSBkaXIgY2FjaGluZwogICAgICBpZiAoIHhtbCApIHsKICAgICAgICB3aGlsZSAoIChlbGVtID0gZWxlbVsgZGlyIF0pICkgewogICAgICAgICAgaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CiAgICAgICAgICAgIGlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKICAgICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgewogICAgICAgICAgICBvdXRlckNhY2hlID0gZWxlbVsgZXhwYW5kbyBdIHx8IChlbGVtWyBleHBhbmRvIF0gPSB7fSk7CiAgICAgICAgICAgIGlmICggKGNhY2hlID0gb3V0ZXJDYWNoZVsgZGlyIF0pICYmIGNhY2hlWzBdID09PSBkaXJrZXkgKSB7CiAgICAgICAgICAgICAgaWYgKCAoZGF0YSA9IGNhY2hlWzFdKSA9PT0gdHJ1ZSB8fCBkYXRhID09PSBjYWNoZWRydW5zICkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGEgPT09IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNhY2hlID0gb3V0ZXJDYWNoZVsgZGlyIF0gPSBbIGRpcmtleSBdOwogICAgICAgICAgICAgIGNhY2hlWzFdID0gbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgfHwgY2FjaGVkcnVuczsKICAgICAgICAgICAgICBpZiAoIGNhY2hlWzFdID09PSB0cnVlICkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9Owp9CgpmdW5jdGlvbiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSB7CiAgcmV0dXJuIG1hdGNoZXJzLmxlbmd0aCA+IDEgPwogICAgZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKICAgICAgdmFyIGkgPSBtYXRjaGVycy5sZW5ndGg7CiAgICAgIHdoaWxlICggaS0tICkgewogICAgICAgIGlmICggIW1hdGNoZXJzW2ldKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9IDoKICAgIG1hdGNoZXJzWzBdOwp9CgpmdW5jdGlvbiBjb25kZW5zZSggdW5tYXRjaGVkLCBtYXAsIGZpbHRlciwgY29udGV4dCwgeG1sICkgewogIHZhciBlbGVtLAogICAgbmV3VW5tYXRjaGVkID0gW10sCiAgICBpID0gMCwKICAgIGxlbiA9IHVubWF0Y2hlZC5sZW5ndGgsCiAgICBtYXBwZWQgPSBtYXAgIT0gbnVsbDsKCiAgZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CiAgICBpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKICAgICAgaWYgKCAhZmlsdGVyIHx8IGZpbHRlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CiAgICAgICAgbmV3VW5tYXRjaGVkLnB1c2goIGVsZW0gKTsKICAgICAgICBpZiAoIG1hcHBlZCApIHsKICAgICAgICAgIG1hcC5wdXNoKCBpICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gbmV3VW5tYXRjaGVkOwp9CgpmdW5jdGlvbiBzZXRNYXRjaGVyKCBwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKSB7CiAgaWYgKCBwb3N0RmlsdGVyICYmICFwb3N0RmlsdGVyWyBleHBhbmRvIF0gKSB7CiAgICBwb3N0RmlsdGVyID0gc2V0TWF0Y2hlciggcG9zdEZpbHRlciApOwogIH0KICBpZiAoIHBvc3RGaW5kZXIgJiYgIXBvc3RGaW5kZXJbIGV4cGFuZG8gXSApIHsKICAgIHBvc3RGaW5kZXIgPSBzZXRNYXRjaGVyKCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKTsKICB9CiAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgcmVzdWx0cywgY29udGV4dCwgeG1sICkgewogICAgdmFyIHRlbXAsIGksIGVsZW0sCiAgICAgIHByZU1hcCA9IFtdLAogICAgICBwb3N0TWFwID0gW10sCiAgICAgIHByZWV4aXN0aW5nID0gcmVzdWx0cy5sZW5ndGgsCgogICAgICAvLyBHZXQgaW5pdGlhbCBlbGVtZW50cyBmcm9tIHNlZWQgb3IgY29udGV4dAogICAgICBlbGVtcyA9IHNlZWQgfHwgbXVsdGlwbGVDb250ZXh0cyggc2VsZWN0b3IgfHwgIioiLCBjb250ZXh0Lm5vZGVUeXBlID8gWyBjb250ZXh0IF0gOiBjb250ZXh0LCBbXSApLAoKICAgICAgLy8gUHJlZmlsdGVyIHRvIGdldCBtYXRjaGVyIGlucHV0LCBwcmVzZXJ2aW5nIGEgbWFwIGZvciBzZWVkLXJlc3VsdHMgc3luY2hyb25pemF0aW9uCiAgICAgIG1hdGNoZXJJbiA9IHByZUZpbHRlciAmJiAoIHNlZWQgfHwgIXNlbGVjdG9yICkgPwogICAgICAgIGNvbmRlbnNlKCBlbGVtcywgcHJlTWFwLCBwcmVGaWx0ZXIsIGNvbnRleHQsIHhtbCApIDoKICAgICAgICBlbGVtcywKCiAgICAgIG1hdGNoZXJPdXQgPSBtYXRjaGVyID8KICAgICAgICAvLyBJZiB3ZSBoYXZlIGEgcG9zdEZpbmRlciwgb3IgZmlsdGVyZWQgc2VlZCwgb3Igbm9uLXNlZWQgcG9zdEZpbHRlciBvciBwcmVleGlzdGluZyByZXN1bHRzLAogICAgICAgIHBvc3RGaW5kZXIgfHwgKCBzZWVkID8gcHJlRmlsdGVyIDogcHJlZXhpc3RpbmcgfHwgcG9zdEZpbHRlciApID8KCiAgICAgICAgICAvLyAuLi5pbnRlcm1lZGlhdGUgcHJvY2Vzc2luZyBpcyBuZWNlc3NhcnkKICAgICAgICAgIFtdIDoKCiAgICAgICAgICAvLyAuLi5vdGhlcndpc2UgdXNlIHJlc3VsdHMgZGlyZWN0bHkKICAgICAgICAgIHJlc3VsdHMgOgogICAgICAgIG1hdGNoZXJJbjsKCiAgICAvLyBGaW5kIHByaW1hcnkgbWF0Y2hlcwogICAgaWYgKCBtYXRjaGVyICkgewogICAgICBtYXRjaGVyKCBtYXRjaGVySW4sIG1hdGNoZXJPdXQsIGNvbnRleHQsIHhtbCApOwogICAgfQoKICAgIC8vIEFwcGx5IHBvc3RGaWx0ZXIKICAgIGlmICggcG9zdEZpbHRlciApIHsKICAgICAgdGVtcCA9IGNvbmRlbnNlKCBtYXRjaGVyT3V0LCBwb3N0TWFwICk7CiAgICAgIHBvc3RGaWx0ZXIoIHRlbXAsIFtdLCBjb250ZXh0LCB4bWwgKTsKCiAgICAgIC8vIFVuLW1hdGNoIGZhaWxpbmcgZWxlbWVudHMgYnkgbW92aW5nIHRoZW0gYmFjayB0byBtYXRjaGVySW4KICAgICAgaSA9IHRlbXAubGVuZ3RoOwogICAgICB3aGlsZSAoIGktLSApIHsKICAgICAgICBpZiAoIChlbGVtID0gdGVtcFtpXSkgKSB7CiAgICAgICAgICBtYXRjaGVyT3V0WyBwb3N0TWFwW2ldIF0gPSAhKG1hdGNoZXJJblsgcG9zdE1hcFtpXSBdID0gZWxlbSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKCBzZWVkICkgewogICAgICBpZiAoIHBvc3RGaW5kZXIgfHwgcHJlRmlsdGVyICkgewogICAgICAgIGlmICggcG9zdEZpbmRlciApIHsKICAgICAgICAgIC8vIEdldCB0aGUgZmluYWwgbWF0Y2hlck91dCBieSBjb25kZW5zaW5nIHRoaXMgaW50ZXJtZWRpYXRlIGludG8gcG9zdEZpbmRlciBjb250ZXh0cwogICAgICAgICAgdGVtcCA9IFtdOwogICAgICAgICAgaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKCBpLS0gKSB7CiAgICAgICAgICAgIGlmICggKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSApIHsKICAgICAgICAgICAgICAvLyBSZXN0b3JlIG1hdGNoZXJJbiBzaW5jZSBlbGVtIGlzIG5vdCB5ZXQgYSBmaW5hbCBtYXRjaAogICAgICAgICAgICAgIHRlbXAucHVzaCggKG1hdGNoZXJJbltpXSA9IGVsZW0pICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvc3RGaW5kZXIoIG51bGwsIChtYXRjaGVyT3V0ID0gW10pLCB0ZW1wLCB4bWwgKTsKICAgICAgICB9CgogICAgICAgIC8vIE1vdmUgbWF0Y2hlZCBlbGVtZW50cyBmcm9tIHNlZWQgdG8gcmVzdWx0cyB0byBrZWVwIHRoZW0gc3luY2hyb25pemVkCiAgICAgICAgaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwogICAgICAgIHdoaWxlICggaS0tICkgewogICAgICAgICAgaWYgKCAoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICYmCiAgICAgICAgICAgICh0ZW1wID0gcG9zdEZpbmRlciA/IGluZGV4T2YuY2FsbCggc2VlZCwgZWxlbSApIDogcHJlTWFwW2ldKSA+IC0xICkgewoKICAgICAgICAgICAgc2VlZFt0ZW1wXSA9ICEocmVzdWx0c1t0ZW1wXSA9IGVsZW0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgIC8vIEFkZCBlbGVtZW50cyB0byByZXN1bHRzLCB0aHJvdWdoIHBvc3RGaW5kZXIgaWYgZGVmaW5lZAogICAgfSBlbHNlIHsKICAgICAgbWF0Y2hlck91dCA9IGNvbmRlbnNlKAogICAgICAgIG1hdGNoZXJPdXQgPT09IHJlc3VsdHMgPwogICAgICAgICAgbWF0Y2hlck91dC5zcGxpY2UoIHByZWV4aXN0aW5nLCBtYXRjaGVyT3V0Lmxlbmd0aCApIDoKICAgICAgICAgIG1hdGNoZXJPdXQKICAgICAgKTsKICAgICAgaWYgKCBwb3N0RmluZGVyICkgewogICAgICAgIHBvc3RGaW5kZXIoIG51bGwsIHJlc3VsdHMsIG1hdGNoZXJPdXQsIHhtbCApOwogICAgICB9IGVsc2UgewogICAgICAgIHB1c2guYXBwbHkoIHJlc3VsdHMsIG1hdGNoZXJPdXQgKTsKICAgICAgfQogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbVRva2VucyggdG9rZW5zICkgewogIHZhciBjaGVja0NvbnRleHQsIG1hdGNoZXIsIGosCiAgICBsZW4gPSB0b2tlbnMubGVuZ3RoLAogICAgbGVhZGluZ1JlbGF0aXZlID0gRXhwci5yZWxhdGl2ZVsgdG9rZW5zWzBdLnR5cGUgXSwKICAgIGltcGxpY2l0UmVsYXRpdmUgPSBsZWFkaW5nUmVsYXRpdmUgfHwgRXhwci5yZWxhdGl2ZVsiICJdLAogICAgaSA9IGxlYWRpbmdSZWxhdGl2ZSA/IDEgOiAwLAoKICAgIC8vIFRoZSBmb3VuZGF0aW9uYWwgbWF0Y2hlciBlbnN1cmVzIHRoYXQgZWxlbWVudHMgYXJlIHJlYWNoYWJsZSBmcm9tIHRvcC1sZXZlbCBjb250ZXh0KHMpCiAgICBtYXRjaENvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsKICAgIH0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUgKSwKICAgIG1hdGNoQW55Q29udGV4dCA9IGFkZENvbWJpbmF0b3IoIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKCBjaGVja0NvbnRleHQsIGVsZW0gKSA+IC0xOwogICAgfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLAogICAgbWF0Y2hlcnMgPSBbIGZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CiAgICAgIHJldHVybiAoICFsZWFkaW5nUmVsYXRpdmUgJiYgKCB4bWwgfHwgY29udGV4dCAhPT0gb3V0ZXJtb3N0Q29udGV4dCApICkgfHwgKAogICAgICAgIChjaGVja0NvbnRleHQgPSBjb250ZXh0KS5ub2RlVHlwZSA/CiAgICAgICAgICBtYXRjaENvbnRleHQoIGVsZW0sIGNvbnRleHQsIHhtbCApIDoKICAgICAgICAgIG1hdGNoQW55Q29udGV4dCggZWxlbSwgY29udGV4dCwgeG1sICkgKTsKICAgIH0gXTsKCiAgZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CiAgICBpZiAoIChtYXRjaGVyID0gRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2ldLnR5cGUgXSkgKSB7CiAgICAgIG1hdGNoZXJzID0gWyBhZGRDb21iaW5hdG9yKGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApLCBtYXRjaGVyKSBdOwogICAgfSBlbHNlIHsKICAgICAgbWF0Y2hlciA9IEV4cHIuZmlsdGVyWyB0b2tlbnNbaV0udHlwZSBdLmFwcGx5KCBudWxsLCB0b2tlbnNbaV0ubWF0Y2hlcyApOwoKICAgICAgLy8gUmV0dXJuIHNwZWNpYWwgdXBvbiBzZWVpbmcgYSBwb3NpdGlvbmFsIG1hdGNoZXIKICAgICAgaWYgKCBtYXRjaGVyWyBleHBhbmRvIF0gKSB7CiAgICAgICAgLy8gRmluZCB0aGUgbmV4dCByZWxhdGl2ZSBvcGVyYXRvciAoaWYgYW55KSBmb3IgcHJvcGVyIGhhbmRsaW5nCiAgICAgICAgaiA9ICsraTsKICAgICAgICBmb3IgKCA7IGogPCBsZW47IGorKyApIHsKICAgICAgICAgIGlmICggRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2pdLnR5cGUgXSApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXRNYXRjaGVyKAogICAgICAgICAgaSA+IDEgJiYgZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICksCiAgICAgICAgICBpID4gMSAmJiB0b1NlbGVjdG9yKCB0b2tlbnMuc2xpY2UoIDAsIGkgLSAxICkgKS5yZXBsYWNlKCBydHJpbSwgIiQxIiApLAogICAgICAgICAgbWF0Y2hlciwKICAgICAgICAgIGkgPCBqICYmIG1hdGNoZXJGcm9tVG9rZW5zKCB0b2tlbnMuc2xpY2UoIGksIGogKSApLAogICAgICAgICAgaiA8IGxlbiAmJiBtYXRjaGVyRnJvbVRva2VucyggKHRva2VucyA9IHRva2Vucy5zbGljZSggaiApKSApLAogICAgICAgICAgaiA8IGxlbiAmJiB0b1NlbGVjdG9yKCB0b2tlbnMgKQogICAgICAgICk7CiAgICAgIH0KICAgICAgbWF0Y2hlcnMucHVzaCggbWF0Y2hlciApOwogICAgfQogIH0KCiAgcmV0dXJuIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoIGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMgKSB7CiAgLy8gQSBjb3VudGVyIHRvIHNwZWNpZnkgd2hpY2ggZWxlbWVudCBpcyBjdXJyZW50bHkgYmVpbmcgbWF0Y2hlZAogIHZhciBtYXRjaGVyQ2FjaGVkUnVucyA9IDAsCiAgICBieVNldCA9IHNldE1hdGNoZXJzLmxlbmd0aCA+IDAsCiAgICBieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwKICAgIHN1cGVyTWF0Y2hlciA9IGZ1bmN0aW9uKCBzZWVkLCBjb250ZXh0LCB4bWwsIHJlc3VsdHMsIGV4cGFuZENvbnRleHQgKSB7CiAgICAgIHZhciBlbGVtLCBqLCBtYXRjaGVyLAogICAgICAgIHNldE1hdGNoZWQgPSBbXSwKICAgICAgICBtYXRjaGVkQ291bnQgPSAwLAogICAgICAgIGkgPSAiMCIsCiAgICAgICAgdW5tYXRjaGVkID0gc2VlZCAmJiBbXSwKICAgICAgICBvdXRlcm1vc3QgPSBleHBhbmRDb250ZXh0ICE9IG51bGwsCiAgICAgICAgY29udGV4dEJhY2t1cCA9IG91dGVybW9zdENvbnRleHQsCiAgICAgICAgLy8gV2UgbXVzdCBhbHdheXMgaGF2ZSBlaXRoZXIgc2VlZCBlbGVtZW50cyBvciBjb250ZXh0CiAgICAgICAgZWxlbXMgPSBzZWVkIHx8IGJ5RWxlbWVudCAmJiBFeHByLmZpbmRbIlRBRyJdKCAiKiIsIGV4cGFuZENvbnRleHQgJiYgY29udGV4dC5wYXJlbnROb2RlIHx8IGNvbnRleHQgKSwKICAgICAgICAvLyBOZXN0ZWQgbWF0Y2hlcnMgc2hvdWxkIHVzZSBub24taW50ZWdlciBkaXJydW5zCiAgICAgICAgZGlycnVuc1VuaXF1ZSA9IChkaXJydW5zICs9IGNvbnRleHRCYWNrdXAgPT0gbnVsbCA/IDEgOiBNYXRoLkUpOwoKICAgICAgaWYgKCBvdXRlcm1vc3QgKSB7CiAgICAgICAgb3V0ZXJtb3N0Q29udGV4dCA9IGNvbnRleHQgIT09IGRvY3VtZW50ICYmIGNvbnRleHQ7CiAgICAgICAgY2FjaGVkcnVucyA9IG1hdGNoZXJDYWNoZWRSdW5zOwogICAgICB9CgogICAgICAvLyBBZGQgZWxlbWVudHMgcGFzc2luZyBlbGVtZW50TWF0Y2hlcnMgZGlyZWN0bHkgdG8gcmVzdWx0cwogICAgICBmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKICAgICAgICBpZiAoIGJ5RWxlbWVudCAmJiBlbGVtICkgewogICAgICAgICAgZm9yICggaiA9IDA7IChtYXRjaGVyID0gZWxlbWVudE1hdGNoZXJzW2pdKTsgaisrICkgewogICAgICAgICAgICBpZiAoIG1hdGNoZXIoIGVsZW0sIGNvbnRleHQsIHhtbCApICkgewogICAgICAgICAgICAgIHJlc3VsdHMucHVzaCggZWxlbSApOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIG91dGVybW9zdCApIHsKICAgICAgICAgICAgZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CiAgICAgICAgICAgIGNhY2hlZHJ1bnMgPSArK21hdGNoZXJDYWNoZWRSdW5zOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVHJhY2sgdW5tYXRjaGVkIGVsZW1lbnRzIGZvciBzZXQgZmlsdGVycwogICAgICAgIGlmICggYnlTZXQgKSB7CiAgICAgICAgICAvLyBUaGV5IHdpbGwgaGF2ZSBnb25lIHRocm91Z2ggYWxsIHBvc3NpYmxlIG1hdGNoZXJzCiAgICAgICAgICBpZiAoIChlbGVtID0gIW1hdGNoZXIgJiYgZWxlbSkgKSB7CiAgICAgICAgICAgIG1hdGNoZWRDb3VudC0tOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIExlbmd0aGVuIHRoZSBhcnJheSBmb3IgZXZlcnkgZWxlbWVudCwgbWF0Y2hlZCBvciBub3QKICAgICAgICAgIGlmICggc2VlZCApIHsKICAgICAgICAgICAgdW5tYXRjaGVkLnB1c2goIGVsZW0gKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEFwcGx5IHNldCBmaWx0ZXJzIHRvIHVubWF0Y2hlZCBlbGVtZW50cwogICAgICAvLyBgaWAgc3RhcnRzIGFzIGEgc3RyaW5nLCBzbyBtYXRjaGVkQ291bnQgd291bGQgZXF1YWwgIjAwIiBpZiB0aGVyZSBhcmUgbm8gZWxlbWVudHMKICAgICAgbWF0Y2hlZENvdW50ICs9IGk7CiAgICAgIGlmICggYnlTZXQgJiYgaSAhPT0gbWF0Y2hlZENvdW50ICkgewogICAgICAgIGZvciAoIGogPSAwOyAobWF0Y2hlciA9IHNldE1hdGNoZXJzW2pdKTsgaisrICkgewogICAgICAgICAgbWF0Y2hlciggdW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwgKTsKICAgICAgICB9CgogICAgICAgIGlmICggc2VlZCApIHsKICAgICAgICAgIC8vIFJlaW50ZWdyYXRlIGVsZW1lbnQgbWF0Y2hlcyB0byBlbGltaW5hdGUgdGhlIG5lZWQgZm9yIHNvcnRpbmcKICAgICAgICAgIGlmICggbWF0Y2hlZENvdW50ID4gMCApIHsKICAgICAgICAgICAgd2hpbGUgKCBpLS0gKSB7CiAgICAgICAgICAgICAgaWYgKCAhKHVubWF0Y2hlZFtpXSB8fCBzZXRNYXRjaGVkW2ldKSApIHsKICAgICAgICAgICAgICAgIHNldE1hdGNoZWRbaV0gPSBwb3AuY2FsbCggcmVzdWx0cyApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIERpc2NhcmQgaW5kZXggcGxhY2Vob2xkZXIgdmFsdWVzIHRvIGdldCBvbmx5IGFjdHVhbCBtYXRjaGVzCiAgICAgICAgICBzZXRNYXRjaGVkID0gY29uZGVuc2UoIHNldE1hdGNoZWQgKTsKICAgICAgICB9CgogICAgICAgIC8vIEFkZCBtYXRjaGVzIHRvIHJlc3VsdHMKICAgICAgICBwdXNoLmFwcGx5KCByZXN1bHRzLCBzZXRNYXRjaGVkICk7CgogICAgICAgIC8vIFNlZWRsZXNzIHNldCBtYXRjaGVzIHN1Y2NlZWRpbmcgbXVsdGlwbGUgc3VjY2Vzc2Z1bCBtYXRjaGVycyBzdGlwdWxhdGUgc29ydGluZwogICAgICAgIGlmICggb3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJgogICAgICAgICAgKCBtYXRjaGVkQ291bnQgKyBzZXRNYXRjaGVycy5sZW5ndGggKSA+IDEgKSB7CgogICAgICAgICAgU2l6emxlLnVuaXF1ZVNvcnQoIHJlc3VsdHMgKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIE92ZXJyaWRlIG1hbmlwdWxhdGlvbiBvZiBnbG9iYWxzIGJ5IG5lc3RlZCBtYXRjaGVycwogICAgICBpZiAoIG91dGVybW9zdCApIHsKICAgICAgICBkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsKICAgICAgICBvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dEJhY2t1cDsKICAgICAgfQoKICAgICAgcmV0dXJuIHVubWF0Y2hlZDsKICAgIH07CgogIHJldHVybiBieVNldCA/CiAgICBtYXJrRnVuY3Rpb24oIHN1cGVyTWF0Y2hlciApIDoKICAgIHN1cGVyTWF0Y2hlcjsKfQoKY29tcGlsZSA9IFNpenpsZS5jb21waWxlID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBncm91cCAvKiBJbnRlcm5hbCBVc2UgT25seSAqLyApIHsKICB2YXIgaSwKICAgIHNldE1hdGNoZXJzID0gW10sCiAgICBlbGVtZW50TWF0Y2hlcnMgPSBbXSwKICAgIGNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgogIGlmICggIWNhY2hlZCApIHsKICAgIC8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAogICAgaWYgKCAhZ3JvdXAgKSB7CiAgICAgIGdyb3VwID0gdG9rZW5pemUoIHNlbGVjdG9yICk7CiAgICB9CiAgICBpID0gZ3JvdXAubGVuZ3RoOwogICAgd2hpbGUgKCBpLS0gKSB7CiAgICAgIGNhY2hlZCA9IG1hdGNoZXJGcm9tVG9rZW5zKCBncm91cFtpXSApOwogICAgICBpZiAoIGNhY2hlZFsgZXhwYW5kbyBdICkgewogICAgICAgIHNldE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwogICAgICB9IGVsc2UgewogICAgICAgIGVsZW1lbnRNYXRjaGVycy5wdXNoKCBjYWNoZWQgKTsKICAgICAgfQogICAgfQoKICAgIC8vIENhY2hlIHRoZSBjb21waWxlZCBmdW5jdGlvbgogICAgY2FjaGVkID0gY29tcGlsZXJDYWNoZSggc2VsZWN0b3IsIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyggZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycyApICk7CiAgfQogIHJldHVybiBjYWNoZWQ7Cn07CgpmdW5jdGlvbiBtdWx0aXBsZUNvbnRleHRzKCBzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMgKSB7CiAgdmFyIGkgPSAwLAogICAgbGVuID0gY29udGV4dHMubGVuZ3RoOwogIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgU2l6emxlKCBzZWxlY3RvciwgY29udGV4dHNbaV0sIHJlc3VsdHMgKTsKICB9CiAgcmV0dXJuIHJlc3VsdHM7Cn0KCmZ1bmN0aW9uIHNlbGVjdCggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKSB7CiAgdmFyIGksIHRva2VucywgdG9rZW4sIHR5cGUsIGZpbmQsCiAgICBtYXRjaCA9IHRva2VuaXplKCBzZWxlY3RvciApOwoKICBpZiAoICFzZWVkICkgewogICAgLy8gVHJ5IHRvIG1pbmltaXplIG9wZXJhdGlvbnMgaWYgdGhlcmUgaXMgb25seSBvbmUgZ3JvdXAKICAgIGlmICggbWF0Y2gubGVuZ3RoID09PSAxICkgewoKICAgICAgLy8gVGFrZSBhIHNob3J0Y3V0IGFuZCBzZXQgdGhlIGNvbnRleHQgaWYgdGhlIHJvb3Qgc2VsZWN0b3IgaXMgYW4gSUQKICAgICAgdG9rZW5zID0gbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSggMCApOwogICAgICBpZiAoIHRva2Vucy5sZW5ndGggPiAyICYmICh0b2tlbiA9IHRva2Vuc1swXSkudHlwZSA9PT0gIklEIiAmJgogICAgICAgICAgY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiAhZG9jdW1lbnRJc1hNTCAmJgogICAgICAgICAgRXhwci5yZWxhdGl2ZVsgdG9rZW5zWzFdLnR5cGUgXSApIHsKCiAgICAgICAgY29udGV4dCA9IEV4cHIuZmluZFsiSUQiXSggdG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLCBjb250ZXh0IClbMF07CiAgICAgICAgaWYgKCAhY29udGV4dCApIHsKICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgIH0KCiAgICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5zbGljZSggdG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoICk7CiAgICAgIH0KCiAgICAgIC8vIEZldGNoIGEgc2VlZCBzZXQgZm9yIHJpZ2h0LXRvLWxlZnQgbWF0Y2hpbmcKICAgICAgZm9yICggaSA9IG1hdGNoRXhwclsibmVlZHNDb250ZXh0Il0udGVzdCggc2VsZWN0b3IgKSA/IC0xIDogdG9rZW5zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewogICAgICAgIHRva2VuID0gdG9rZW5zW2ldOwoKICAgICAgICAvLyBBYm9ydCBpZiB3ZSBoaXQgYSBjb21iaW5hdG9yCiAgICAgICAgaWYgKCBFeHByLnJlbGF0aXZlWyAodHlwZSA9IHRva2VuLnR5cGUpIF0gKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCAoZmluZCA9IEV4cHIuZmluZFsgdHlwZSBdKSApIHsKICAgICAgICAgIC8vIFNlYXJjaCwgZXhwYW5kaW5nIGNvbnRleHQgZm9yIGxlYWRpbmcgc2libGluZyBjb21iaW5hdG9ycwogICAgICAgICAgaWYgKCAoc2VlZCA9IGZpbmQoCiAgICAgICAgICAgIHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKSwKICAgICAgICAgICAgcnNpYmxpbmcudGVzdCggdG9rZW5zWzBdLnR5cGUgKSAmJiBjb250ZXh0LnBhcmVudE5vZGUgfHwgY29udGV4dAogICAgICAgICAgKSkgKSB7CgogICAgICAgICAgICAvLyBJZiBzZWVkIGlzIGVtcHR5IG9yIG5vIHRva2VucyByZW1haW4sIHdlIGNhbiByZXR1cm4gZWFybHkKICAgICAgICAgICAgdG9rZW5zLnNwbGljZSggaSwgMSApOwogICAgICAgICAgICBzZWxlY3RvciA9IHNlZWQubGVuZ3RoICYmIHRvU2VsZWN0b3IoIHRva2VucyApOwogICAgICAgICAgICBpZiAoICFzZWxlY3RvciApIHsKICAgICAgICAgICAgICBwdXNoLmFwcGx5KCByZXN1bHRzLCBzbGljZS5jYWxsKCBzZWVkLCAwICkgKTsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICAvLyBDb21waWxlIGFuZCBleGVjdXRlIGEgZmlsdGVyaW5nIGZ1bmN0aW9uCiAgLy8gUHJvdmlkZSBgbWF0Y2hgIHRvIGF2b2lkIHJldG9rZW5pemF0aW9uIGlmIHdlIG1vZGlmaWVkIHRoZSBzZWxlY3RvciBhYm92ZQogIGNvbXBpbGUoIHNlbGVjdG9yLCBtYXRjaCApKAogICAgc2VlZCwKICAgIGNvbnRleHQsCiAgICBkb2N1bWVudElzWE1MLAogICAgcmVzdWx0cywKICAgIHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkKICApOwogIHJldHVybiByZXN1bHRzOwp9CgovLyBEZXByZWNhdGVkCkV4cHIucHNldWRvc1sibnRoIl0gPSBFeHByLnBzZXVkb3NbImVxIl07CgovLyBFYXN5IEFQSSBmb3IgY3JlYXRpbmcgbmV3IHNldEZpbHRlcnMKZnVuY3Rpb24gc2V0RmlsdGVycygpIHt9CkV4cHIuZmlsdGVycyA9IHNldEZpbHRlcnMucHJvdG90eXBlID0gRXhwci5wc2V1ZG9zOwpFeHByLnNldEZpbHRlcnMgPSBuZXcgc2V0RmlsdGVycygpOwoKLy8gSW5pdGlhbGl6ZSB3aXRoIHRoZSBkZWZhdWx0IGRvY3VtZW50CnNldERvY3VtZW50KCk7CgovLyBPdmVycmlkZSBzaXp6bGUgYXR0cmlidXRlIHJldHJpZXZhbApTaXp6bGUuYXR0ciA9IGpRdWVyeS5hdHRyOwpqUXVlcnkuZmluZCA9IFNpenpsZTsKalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwpqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIucHNldWRvczsKalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwpqUXVlcnkudGV4dCA9IFNpenpsZS5nZXRUZXh0OwpqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CmpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKCgp9KSggd2luZG93ICk7CnZhciBydW50aWwgPSAvVW50aWwkLywKICBycGFyZW50c3ByZXYgPSAvXig/OnBhcmVudHN8cHJldig/OlVudGlsfEFsbCkpLywKICBpc1NpbXBsZSA9IC9eLlteOiNcW1wuLF0qJC8sCiAgcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dCwKICAvLyBtZXRob2RzIGd1YXJhbnRlZWQgdG8gcHJvZHVjZSBhIHVuaXF1ZSBzZXQgd2hlbiBzdGFydGluZyBmcm9tIGEgdW5pcXVlIHNldAogIGd1YXJhbnRlZWRVbmlxdWUgPSB7CiAgICBjaGlsZHJlbjogdHJ1ZSwKICAgIGNvbnRlbnRzOiB0cnVlLAogICAgbmV4dDogdHJ1ZSwKICAgIHByZXY6IHRydWUKICB9OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CiAgZmluZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewogICAgdmFyIGksIHJldCwgc2VsZjsKCiAgICBpZiAoIHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgKSB7CiAgICAgIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeSggc2VsZWN0b3IgKS5maWx0ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICggaSA9IDA7IGkgPCBzZWxmLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgaWYgKCBqUXVlcnkuY29udGFpbnMoIHNlbGZbIGkgXSwgdGhpcyApICkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pICk7CiAgICB9CgogICAgcmV0ID0gW107CiAgICBmb3IgKCBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKysgKSB7CiAgICAgIGpRdWVyeS5maW5kKCBzZWxlY3RvciwgdGhpc1sgaSBdLCByZXQgKTsKICAgIH0KCiAgICAvLyBOZWVkZWQgYmVjYXVzZSAkKCBzZWxlY3RvciwgY29udGV4dCApIGJlY29tZXMgJCggY29udGV4dCApLmZpbmQoIHNlbGVjdG9yICkKICAgIHJldCA9IHRoaXMucHVzaFN0YWNrKCBqUXVlcnkudW5pcXVlKCByZXQgKSApOwogICAgcmV0LnNlbGVjdG9yID0gKCB0aGlzLnNlbGVjdG9yID8gdGhpcy5zZWxlY3RvciArICIgIiA6ICIiICkgKyBzZWxlY3RvcjsKICAgIHJldHVybiByZXQ7CiAgfSwKCiAgaGFzOiBmdW5jdGlvbiggdGFyZ2V0ICkgewogICAgdmFyIGksCiAgICAgIHRhcmdldHMgPSBqUXVlcnkoIHRhcmdldCwgdGhpcyApLAogICAgICBsZW4gPSB0YXJnZXRzLmxlbmd0aDsKCiAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oKSB7CiAgICAgIGZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CiAgICAgICAgaWYgKCBqUXVlcnkuY29udGFpbnMoIHRoaXMsIHRhcmdldHNbaV0gKSApIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSwKCiAgbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciwgZmFsc2UpICk7CiAgfSwKCiAgZmlsdGVyOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciwgdHJ1ZSkgKTsKICB9LAoKICBpczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewogICAgcmV0dXJuICEhc2VsZWN0b3IgJiYgKAogICAgICB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciID8KICAgICAgICAvLyBJZiB0aGlzIGlzIGEgcG9zaXRpb25hbC9yZWxhdGl2ZSBzZWxlY3RvciwgY2hlY2sgbWVtYmVyc2hpcCBpbiB0aGUgcmV0dXJuZWQgc2V0CiAgICAgICAgLy8gc28gJCgicDpmaXJzdCIpLmlzKCJwOmxhc3QiKSB3b24ndCByZXR1cm4gdHJ1ZSBmb3IgYSBkb2Mgd2l0aCB0d28gInAiLgogICAgICAgIHJuZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSA/CiAgICAgICAgICBqUXVlcnkoIHNlbGVjdG9yLCB0aGlzLmNvbnRleHQgKS5pbmRleCggdGhpc1swXSApID49IDAgOgogICAgICAgICAgalF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIHRoaXMgKS5sZW5ndGggPiAwIDoKICAgICAgICB0aGlzLmZpbHRlciggc2VsZWN0b3IgKS5sZW5ndGggPiAwICk7CiAgfSwKCiAgY2xvc2VzdDogZnVuY3Rpb24oIHNlbGVjdG9ycywgY29udGV4dCApIHsKICAgIHZhciBjdXIsCiAgICAgIGkgPSAwLAogICAgICBsID0gdGhpcy5sZW5ndGgsCiAgICAgIHJldCA9IFtdLAogICAgICBwb3MgPSBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9ycyApIHx8IHR5cGVvZiBzZWxlY3RvcnMgIT09ICJzdHJpbmciID8KICAgICAgICBqUXVlcnkoIHNlbGVjdG9ycywgY29udGV4dCB8fCB0aGlzLmNvbnRleHQgKSA6CiAgICAgICAgMDsKCiAgICBmb3IgKCA7IGkgPCBsOyBpKysgKSB7CiAgICAgIGN1ciA9IHRoaXNbaV07CgogICAgICB3aGlsZSAoIGN1ciAmJiBjdXIub3duZXJEb2N1bWVudCAmJiBjdXIgIT09IGNvbnRleHQgJiYgY3VyLm5vZGVUeXBlICE9PSAxMSApIHsKICAgICAgICBpZiAoIHBvcyA/IHBvcy5pbmRleChjdXIpID4gLTEgOiBqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoY3VyLCBzZWxlY3RvcnMpICkgewogICAgICAgICAgcmV0LnB1c2goIGN1ciApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGN1ciA9IGN1ci5wYXJlbnROb2RlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQubGVuZ3RoID4gMSA/IGpRdWVyeS51bmlxdWUoIHJldCApIDogcmV0ICk7CiAgfSwKCiAgLy8gRGV0ZXJtaW5lIHRoZSBwb3NpdGlvbiBvZiBhbiBlbGVtZW50IHdpdGhpbgogIC8vIHRoZSBtYXRjaGVkIHNldCBvZiBlbGVtZW50cwogIGluZGV4OiBmdW5jdGlvbiggZWxlbSApIHsKCiAgICAvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAogICAgaWYgKCAhZWxlbSApIHsKICAgICAgcmV0dXJuICggdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgKSA/IHRoaXMuZmlyc3QoKS5wcmV2QWxsKCkubGVuZ3RoIDogLTE7CiAgICB9CgogICAgLy8gaW5kZXggaW4gc2VsZWN0b3IKICAgIGlmICggdHlwZW9mIGVsZW0gPT09ICJzdHJpbmciICkgewogICAgICByZXR1cm4galF1ZXJ5LmluQXJyYXkoIHRoaXNbMF0sIGpRdWVyeSggZWxlbSApICk7CiAgICB9CgogICAgLy8gTG9jYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgZGVzaXJlZCBlbGVtZW50CiAgICByZXR1cm4galF1ZXJ5LmluQXJyYXkoCiAgICAgIC8vIElmIGl0IHJlY2VpdmVzIGEgalF1ZXJ5IG9iamVjdCwgdGhlIGZpcnN0IGVsZW1lbnQgaXMgdXNlZAogICAgICBlbGVtLmpxdWVyeSA/IGVsZW1bMF0gOiBlbGVtLCB0aGlzICk7CiAgfSwKCiAgYWRkOiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CiAgICB2YXIgc2V0ID0gdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiA/CiAgICAgICAgalF1ZXJ5KCBzZWxlY3RvciwgY29udGV4dCApIDoKICAgICAgICBqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciAmJiBzZWxlY3Rvci5ub2RlVHlwZSA/IFsgc2VsZWN0b3IgXSA6IHNlbGVjdG9yICksCiAgICAgIGFsbCA9IGpRdWVyeS5tZXJnZSggdGhpcy5nZXQoKSwgc2V0ICk7CgogICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkudW5pcXVlKGFsbCkgKTsKICB9LAoKICBhZGRCYWNrOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICByZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPwogICAgICB0aGlzLnByZXZPYmplY3QgOiB0aGlzLnByZXZPYmplY3QuZmlsdGVyKHNlbGVjdG9yKQogICAgKTsKICB9Cn0pOwoKalF1ZXJ5LmZuLmFuZFNlbGYgPSBqUXVlcnkuZm4uYWRkQmFjazsKCmZ1bmN0aW9uIHNpYmxpbmcoIGN1ciwgZGlyICkgewogIGRvIHsKICAgIGN1ciA9IGN1clsgZGlyIF07CiAgfSB3aGlsZSAoIGN1ciAmJiBjdXIubm9kZVR5cGUgIT09IDEgKTsKCiAgcmV0dXJuIGN1cjsKfQoKalF1ZXJ5LmVhY2goewogIHBhcmVudDogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwogICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKICB9LAogIHBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwYXJlbnROb2RlIiApOwogIH0sCiAgcGFyZW50c1VudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CiAgICByZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInBhcmVudE5vZGUiLCB1bnRpbCApOwogIH0sCiAgbmV4dDogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gc2libGluZyggZWxlbSwgIm5leHRTaWJsaW5nIiApOwogIH0sCiAgcHJldjogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gc2libGluZyggZWxlbSwgInByZXZpb3VzU2libGluZyIgKTsKICB9LAogIG5leHRBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJuZXh0U2libGluZyIgKTsKICB9LAogIHByZXZBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7CiAgfSwKICBuZXh0VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKICAgIHJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAibmV4dFNpYmxpbmciLCB1bnRpbCApOwogIH0sCiAgcHJldlVudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CiAgICByZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIsIHVudGlsICk7CiAgfSwKICBzaWJsaW5nczogZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4galF1ZXJ5LnNpYmxpbmcoICggZWxlbS5wYXJlbnROb2RlIHx8IHt9ICkuZmlyc3RDaGlsZCwgZWxlbSApOwogIH0sCiAgY2hpbGRyZW46IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGpRdWVyeS5zaWJsaW5nKCBlbGVtLmZpcnN0Q2hpbGQgKTsKICB9LAogIGNvbnRlbnRzOiBmdW5jdGlvbiggZWxlbSApIHsKICAgIHJldHVybiBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpZnJhbWUiICkgPwogICAgICBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgOgogICAgICBqUXVlcnkubWVyZ2UoIFtdLCBlbGVtLmNoaWxkTm9kZXMgKTsKICB9Cn0sIGZ1bmN0aW9uKCBuYW1lLCBmbiApIHsKICBqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCB1bnRpbCwgc2VsZWN0b3IgKSB7CiAgICB2YXIgcmV0ID0galF1ZXJ5Lm1hcCggdGhpcywgZm4sIHVudGlsICk7CgogICAgaWYgKCAhcnVudGlsLnRlc3QoIG5hbWUgKSApIHsKICAgICAgc2VsZWN0b3IgPSB1bnRpbDsKICAgIH0KCiAgICBpZiAoIHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CiAgICAgIHJldCA9IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCByZXQgKTsKICAgIH0KCiAgICByZXQgPSB0aGlzLmxlbmd0aCA+IDEgJiYgIWd1YXJhbnRlZWRVbmlxdWVbIG5hbWUgXSA/IGpRdWVyeS51bmlxdWUoIHJldCApIDogcmV0OwoKICAgIGlmICggdGhpcy5sZW5ndGggPiAxICYmIHJwYXJlbnRzcHJldi50ZXN0KCBuYW1lICkgKSB7CiAgICAgIHJldCA9IHJldC5yZXZlcnNlKCk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQgKTsKICB9Owp9KTsKCmpRdWVyeS5leHRlbmQoewogIGZpbHRlcjogZnVuY3Rpb24oIGV4cHIsIGVsZW1zLCBub3QgKSB7CiAgICBpZiAoIG5vdCApIHsKICAgICAgZXhwciA9ICI6bm90KCIgKyBleHByICsgIikiOwogICAgfQoKICAgIHJldHVybiBlbGVtcy5sZW5ndGggPT09IDEgPwogICAgICBqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoZWxlbXNbMF0sIGV4cHIpID8gWyBlbGVtc1swXSBdIDogW10gOgogICAgICBqUXVlcnkuZmluZC5tYXRjaGVzKGV4cHIsIGVsZW1zKTsKICB9LAoKICBkaXI6IGZ1bmN0aW9uKCBlbGVtLCBkaXIsIHVudGlsICkgewogICAgdmFyIG1hdGNoZWQgPSBbXSwKICAgICAgY3VyID0gZWxlbVsgZGlyIF07CgogICAgd2hpbGUgKCBjdXIgJiYgY3VyLm5vZGVUeXBlICE9PSA5ICYmICh1bnRpbCA9PT0gdW5kZWZpbmVkIHx8IGN1ci5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5KCBjdXIgKS5pcyggdW50aWwgKSkgKSB7CiAgICAgIGlmICggY3VyLm5vZGVUeXBlID09PSAxICkgewogICAgICAgIG1hdGNoZWQucHVzaCggY3VyICk7CiAgICAgIH0KICAgICAgY3VyID0gY3VyW2Rpcl07CiAgICB9CiAgICByZXR1cm4gbWF0Y2hlZDsKICB9LAoKICBzaWJsaW5nOiBmdW5jdGlvbiggbiwgZWxlbSApIHsKICAgIHZhciByID0gW107CgogICAgZm9yICggOyBuOyBuID0gbi5uZXh0U2libGluZyApIHsKICAgICAgaWYgKCBuLm5vZGVUeXBlID09PSAxICYmIG4gIT09IGVsZW0gKSB7CiAgICAgICAgci5wdXNoKCBuICk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcjsKICB9Cn0pOwoKLy8gSW1wbGVtZW50IHRoZSBpZGVudGljYWwgZnVuY3Rpb25hbGl0eSBmb3IgZmlsdGVyIGFuZCBub3QKZnVuY3Rpb24gd2lubm93KCBlbGVtZW50cywgcXVhbGlmaWVyLCBrZWVwICkgewoKICAvLyBDYW4ndCBwYXNzIG51bGwgb3IgdW5kZWZpbmVkIHRvIGluZGV4T2YgaW4gRmlyZWZveCA0CiAgLy8gU2V0IHRvIDAgdG8gc2tpcCBzdHJpbmcgY2hlY2sKICBxdWFsaWZpZXIgPSBxdWFsaWZpZXIgfHwgMDsKCiAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcXVhbGlmaWVyICkgKSB7CiAgICByZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewogICAgICB2YXIgcmV0VmFsID0gISFxdWFsaWZpZXIuY2FsbCggZWxlbSwgaSwgZWxlbSApOwogICAgICByZXR1cm4gcmV0VmFsID09PSBrZWVwOwogICAgfSk7CgogIH0gZWxzZSBpZiAoIHF1YWxpZmllci5ub2RlVHlwZSApIHsKICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICAgIHJldHVybiAoIGVsZW0gPT09IHF1YWxpZmllciApID09PSBrZWVwOwogICAgfSk7CgogIH0gZWxzZSBpZiAoIHR5cGVvZiBxdWFsaWZpZXIgPT09ICJzdHJpbmciICkgewogICAgdmFyIGZpbHRlcmVkID0galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMTsKICAgIH0pOwoKICAgIGlmICggaXNTaW1wbGUudGVzdCggcXVhbGlmaWVyICkgKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZmlsdGVyKHF1YWxpZmllciwgZmlsdGVyZWQsICFrZWVwKTsKICAgIH0gZWxzZSB7CiAgICAgIHF1YWxpZmllciA9IGpRdWVyeS5maWx0ZXIoIHF1YWxpZmllciwgZmlsdGVyZWQgKTsKICAgIH0KICB9CgogIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gKCBqUXVlcnkuaW5BcnJheSggZWxlbSwgcXVhbGlmaWVyICkgPj0gMCApID09PSBrZWVwOwogIH0pOwp9CmZ1bmN0aW9uIGNyZWF0ZVNhZmVGcmFnbWVudCggZG9jdW1lbnQgKSB7CiAgdmFyIGxpc3QgPSBub2RlTmFtZXMuc3BsaXQoICJ8IiApLAogICAgc2FmZUZyYWcgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgogIGlmICggc2FmZUZyYWcuY3JlYXRlRWxlbWVudCApIHsKICAgIHdoaWxlICggbGlzdC5sZW5ndGggKSB7CiAgICAgIHNhZmVGcmFnLmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgbGlzdC5wb3AoKQogICAgICApOwogICAgfQogIH0KICByZXR1cm4gc2FmZUZyYWc7Cn0KCnZhciBub2RlTmFtZXMgPSAiYWJicnxhcnRpY2xlfGFzaWRlfGF1ZGlvfGJkaXxjYW52YXN8ZGF0YXxkYXRhbGlzdHxkZXRhaWxzfGZpZ2NhcHRpb258ZmlndXJlfGZvb3RlcnwiICsKICAgICJoZWFkZXJ8aGdyb3VwfG1hcmt8bWV0ZXJ8bmF2fG91dHB1dHxwcm9ncmVzc3xzZWN0aW9ufHN1bW1hcnl8dGltZXx2aWRlbyIsCiAgcmlubGluZWpRdWVyeSA9IC8galF1ZXJ5XGQrPSIoPzpudWxsfFxkKykiL2csCiAgcm5vc2hpbWNhY2hlID0gbmV3IFJlZ0V4cCgiPCg/OiIgKyBub2RlTmFtZXMgKyAiKVtcXHMvPl0iLCAiaSIpLAogIHJsZWFkaW5nV2hpdGVzcGFjZSA9IC9eXHMrLywKICByeGh0bWxUYWcgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbXHc6XSspW14+XSopXC8+L2dpLAogIHJ0YWdOYW1lID0gLzwoW1x3Ol0rKS8sCiAgcnRib2R5ID0gLzx0Ym9keS9pLAogIHJodG1sID0gLzx8JiM/XHcrOy8sCiAgcm5vSW5uZXJodG1sID0gLzwoPzpzY3JpcHR8c3R5bGV8bGluaykvaSwKICBtYW5pcHVsYXRpb25fcmNoZWNrYWJsZVR5cGUgPSAvXig/OmNoZWNrYm94fHJhZGlvKSQvaSwKICAvLyBjaGVja2VkPSJjaGVja2VkIiBvciBjaGVja2VkCiAgcmNoZWNrZWQgPSAvY2hlY2tlZFxzKig/OltePV18PVxzKi5jaGVja2VkLikvaSwKICByc2NyaXB0VHlwZSA9IC9eJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaSwKICByc2NyaXB0VHlwZU1hc2tlZCA9IC9edHJ1ZVwvKC4qKS8sCiAgcmNsZWFuU2NyaXB0ID0gL15ccyo8ISg/OlxbQ0RBVEFcW3wtLSl8KD86XF1cXXwtLSk+XHMqJC9nLAoKICAvLyBXZSBoYXZlIHRvIGNsb3NlIHRoZXNlIHRhZ3MgdG8gc3VwcG9ydCBYSFRNTCAoIzEzMjAwKQogIHdyYXBNYXAgPSB7CiAgICBvcHRpb246IFsgMSwgIjxzZWxlY3QgbXVsdGlwbGU9J211bHRpcGxlJz4iLCAiPC9zZWxlY3Q+IiBdLAogICAgbGVnZW5kOiBbIDEsICI8ZmllbGRzZXQ+IiwgIjwvZmllbGRzZXQ+IiBdLAogICAgYXJlYTogWyAxLCAiPG1hcD4iLCAiPC9tYXA+IiBdLAogICAgcGFyYW06IFsgMSwgIjxvYmplY3Q+IiwgIjwvb2JqZWN0PiIgXSwKICAgIHRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLAogICAgdHI6IFsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0sCiAgICBjb2w6IFsgMiwgIjx0YWJsZT48dGJvZHk+PC90Ym9keT48Y29sZ3JvdXA+IiwgIjwvY29sZ3JvdXA+PC90YWJsZT4iIF0sCiAgICB0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwKCiAgICAvLyBJRTYtOCBjYW4ndCBzZXJpYWxpemUgbGluaywgc2NyaXB0LCBzdHlsZSwgb3IgYW55IGh0bWw1IChOb1Njb3BlKSB0YWdzLAogICAgLy8gdW5sZXNzIHdyYXBwZWQgaW4gYSBkaXYgd2l0aCBub24tYnJlYWtpbmcgY2hhcmFjdGVycyBpbiBmcm9udCBvZiBpdC4KICAgIF9kZWZhdWx0OiBqUXVlcnkuc3VwcG9ydC5odG1sU2VyaWFsaXplID8gWyAwLCAiIiwgIiIgXSA6IFsgMSwgIlg8ZGl2PiIsICI8L2Rpdj4iICBdCiAgfSwKICBzYWZlRnJhZ21lbnQgPSBjcmVhdGVTYWZlRnJhZ21lbnQoIGRvY3VtZW50ICksCiAgZnJhZ21lbnREaXYgPSBzYWZlRnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpICk7Cgp3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247CndyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CndyYXBNYXAudGggPSB3cmFwTWFwLnRkOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CiAgdGV4dDogZnVuY3Rpb24oIHZhbHVlICkgewogICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwogICAgICAgIGpRdWVyeS50ZXh0KCB0aGlzICkgOgogICAgICAgIHRoaXMuZW1wdHkoKS5hcHBlbmQoICggdGhpc1swXSAmJiB0aGlzWzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQgKS5jcmVhdGVUZXh0Tm9kZSggdmFsdWUgKSApOwogICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggKTsKICB9LAoKICB3cmFwQWxsOiBmdW5jdGlvbiggaHRtbCApIHsKICAgIGlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKSApIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CiAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBBbGwoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwogICAgICB9KTsKICAgIH0KCiAgICBpZiAoIHRoaXNbMF0gKSB7CiAgICAgIC8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kCiAgICAgIHZhciB3cmFwID0galF1ZXJ5KCBodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQgKS5lcSgwKS5jbG9uZSh0cnVlKTsKCiAgICAgIGlmICggdGhpc1swXS5wYXJlbnROb2RlICkgewogICAgICAgIHdyYXAuaW5zZXJ0QmVmb3JlKCB0aGlzWzBdICk7CiAgICAgIH0KCiAgICAgIHdyYXAubWFwKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBlbGVtID0gdGhpczsKCiAgICAgICAgd2hpbGUgKCBlbGVtLmZpcnN0Q2hpbGQgJiYgZWxlbS5maXJzdENoaWxkLm5vZGVUeXBlID09PSAxICkgewogICAgICAgICAgZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbGVtOwogICAgICB9KS5hcHBlbmQoIHRoaXMgKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9LAoKICB3cmFwSW5uZXI6IGZ1bmN0aW9uKCBodG1sICkgewogICAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApICkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKICAgICAgICBqUXVlcnkodGhpcykud3JhcElubmVyKCBodG1sLmNhbGwodGhpcywgaSkgKTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSBqUXVlcnkoIHRoaXMgKSwKICAgICAgICBjb250ZW50cyA9IHNlbGYuY29udGVudHMoKTsKCiAgICAgIGlmICggY29udGVudHMubGVuZ3RoICkgewogICAgICAgIGNvbnRlbnRzLndyYXBBbGwoIGh0bWwgKTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZi5hcHBlbmQoIGh0bWwgKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgd3JhcDogZnVuY3Rpb24oIGh0bWwgKSB7CiAgICB2YXIgaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICk7CgogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CiAgICAgIGpRdWVyeSggdGhpcyApLndyYXBBbGwoIGlzRnVuY3Rpb24gPyBodG1sLmNhbGwodGhpcywgaSkgOiBodG1sICk7CiAgICB9KTsKICB9LAoKICB1bndyYXA6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbigpIHsKICAgICAgaWYgKCAhalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzLCAiYm9keSIgKSApIHsKICAgICAgICBqUXVlcnkoIHRoaXMgKS5yZXBsYWNlV2l0aCggdGhpcy5jaGlsZE5vZGVzICk7CiAgICAgIH0KICAgIH0pLmVuZCgpOwogIH0sCgogIGFwcGVuZDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIHRydWUsIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICBpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsKICAgICAgICB0aGlzLmFwcGVuZENoaWxkKCBlbGVtICk7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIHByZXBlbmQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCB0cnVlLCBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7CiAgICAgICAgdGhpcy5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMuZmlyc3RDaGlsZCApOwogICAgICB9CiAgICB9KTsKICB9LAoKICBiZWZvcmU6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoIGFyZ3VtZW50cywgZmFsc2UsIGZ1bmN0aW9uKCBlbGVtICkgewogICAgICBpZiAoIHRoaXMucGFyZW50Tm9kZSApIHsKICAgICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzICk7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIGFmdGVyOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmRvbU1hbmlwKCBhcmd1bWVudHMsIGZhbHNlLCBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7CiAgICAgICAgdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5uZXh0U2libGluZyApOwogICAgICB9CiAgICB9KTsKICB9LAoKICAvLyBrZWVwRGF0YSBpcyBmb3IgaW50ZXJuYWwgdXNlIG9ubHktLWRvIG5vdCBkb2N1bWVudAogIHJlbW92ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCBrZWVwRGF0YSApIHsKICAgIHZhciBlbGVtLAogICAgICBpID0gMDsKCiAgICBmb3IgKCA7IChlbGVtID0gdGhpc1tpXSkgIT0gbnVsbDsgaSsrICkgewogICAgICBpZiAoICFzZWxlY3RvciB8fCBqUXVlcnkuZmlsdGVyKCBzZWxlY3RvciwgWyBlbGVtIF0gKS5sZW5ndGggPiAwICkgewogICAgICAgIGlmICggIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CiAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0gKSApOwogICAgICAgIH0KCiAgICAgICAgaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CiAgICAgICAgICBpZiAoIGtlZXBEYXRhICYmIGpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICkgKSB7CiAgICAgICAgICAgIHNldEdsb2JhbEV2YWwoIGdldEFsbCggZWxlbSwgInNjcmlwdCIgKSApOwogICAgICAgICAgfQogICAgICAgICAgZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBlbGVtICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgZW1wdHk6IGZ1bmN0aW9uKCkgewogICAgdmFyIGVsZW0sCiAgICAgIGkgPSAwOwoKICAgIGZvciAoIDsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKysgKSB7CiAgICAgIC8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwogICAgICBpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CiAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBhbnkgcmVtYWluaW5nIG5vZGVzCiAgICAgIHdoaWxlICggZWxlbS5maXJzdENoaWxkICkgewogICAgICAgIGVsZW0ucmVtb3ZlQ2hpbGQoIGVsZW0uZmlyc3RDaGlsZCApOwogICAgICB9CgogICAgICAvLyBJZiB0aGlzIGlzIGEgc2VsZWN0LCBlbnN1cmUgdGhhdCBpdCBkaXNwbGF5cyBlbXB0eSAoIzEyMzM2KQogICAgICAvLyBTdXBwb3J0OiBJRTw5CiAgICAgIGlmICggZWxlbS5vcHRpb25zICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgInNlbGVjdCIgKSApIHsKICAgICAgICBlbGVtLm9wdGlvbnMubGVuZ3RoID0gMDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIGNsb25lOiBmdW5jdGlvbiggZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CiAgICBkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOwogICAgZGVlcERhdGFBbmRFdmVudHMgPSBkZWVwRGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZGF0YUFuZEV2ZW50cyA6IGRlZXBEYXRhQW5kRXZlbnRzOwoKICAgIHJldHVybiB0aGlzLm1hcCggZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4galF1ZXJ5LmNsb25lKCB0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApOwogICAgfSk7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24oIHZhbHVlICkgewogICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgICAgdmFyIGVsZW0gPSB0aGlzWzBdIHx8IHt9LAogICAgICAgIGkgPSAwLAogICAgICAgIGwgPSB0aGlzLmxlbmd0aDsKCiAgICAgIGlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKICAgICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMSA/CiAgICAgICAgICBlbGVtLmlubmVySFRNTC5yZXBsYWNlKCByaW5saW5lalF1ZXJ5LCAiIiApIDoKICAgICAgICAgIHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgLy8gU2VlIGlmIHdlIGNhbiB0YWtlIGEgc2hvcnRjdXQgYW5kIGp1c3QgdXNlIGlubmVySFRNTAogICAgICBpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgIXJub0lubmVyaHRtbC50ZXN0KCB2YWx1ZSApICYmCiAgICAgICAgKCBqUXVlcnkuc3VwcG9ydC5odG1sU2VyaWFsaXplIHx8ICFybm9zaGltY2FjaGUudGVzdCggdmFsdWUgKSAgKSAmJgogICAgICAgICggalF1ZXJ5LnN1cHBvcnQubGVhZGluZ1doaXRlc3BhY2UgfHwgIXJsZWFkaW5nV2hpdGVzcGFjZS50ZXN0KCB2YWx1ZSApICkgJiYKICAgICAgICAhd3JhcE1hcFsgKCBydGFnTmFtZS5leGVjKCB2YWx1ZSApIHx8IFsiIiwgIiJdIClbMV0udG9Mb3dlckNhc2UoKSBdICkgewoKICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoIHJ4aHRtbFRhZywgIjwkMT48LyQyPiIgKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSsrICkgewogICAgICAgICAgICAvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKICAgICAgICAgICAgZWxlbSA9IHRoaXNbaV0gfHwge307CiAgICAgICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKICAgICAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0sIGZhbHNlICkgKTsKICAgICAgICAgICAgICBlbGVtLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZWxlbSA9IDA7CgogICAgICAgIC8vIElmIHVzaW5nIGlubmVySFRNTCB0aHJvd3MgYW4gZXhjZXB0aW9uLCB1c2UgdGhlIGZhbGxiYWNrIG1ldGhvZAogICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgfQoKICAgICAgaWYgKCBlbGVtICkgewogICAgICAgIHRoaXMuZW1wdHkoKS5hcHBlbmQoIHZhbHVlICk7CiAgICAgIH0KICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7CiAgfSwKCiAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgIHZhciBpc0Z1bmMgPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKTsKCiAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgZWxlbWVudHMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NIGJlZm9yZSB0aGV5IGFyZSBpbnNlcnRlZAogICAgLy8gdGhpcyBjYW4gaGVscCBmaXggcmVwbGFjaW5nIGEgcGFyZW50IHdpdGggY2hpbGQgZWxlbWVudHMKICAgIGlmICggIWlzRnVuYyAmJiB0eXBlb2YgdmFsdWUgIT09ICJzdHJpbmciICkgewogICAgICB2YWx1ZSA9IGpRdWVyeSggdmFsdWUgKS5ub3QoIHRoaXMgKS5kZXRhY2goKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5kb21NYW5pcCggWyB2YWx1ZSBdLCB0cnVlLCBmdW5jdGlvbiggZWxlbSApIHsKICAgICAgdmFyIG5leHQgPSB0aGlzLm5leHRTaWJsaW5nLAogICAgICAgIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKCiAgICAgIGlmICggcGFyZW50ICYmIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgKSB7CgogICAgICAgIGpRdWVyeSggdGhpcyApLnJlbW92ZSgpOwoKICAgICAgICBpZiAoIG5leHQgKSB7CiAgICAgICAgICBuZXh0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCBuZXh0ICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBhcmVudC5hcHBlbmRDaGlsZCggZWxlbSApOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSwKCiAgZGV0YWNoOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CiAgICByZXR1cm4gdGhpcy5yZW1vdmUoIHNlbGVjdG9yLCB0cnVlICk7CiAgfSwKCiAgZG9tTWFuaXA6IGZ1bmN0aW9uKCBhcmdzLCB0YWJsZSwgY2FsbGJhY2sgKSB7CgogICAgLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwogICAgYXJncyA9IGNvcmVfY29uY2F0LmFwcGx5KCBbXSwgYXJncyApOwoKICAgIHZhciBmcmFnbWVudCwgZmlyc3QsIHNjcmlwdHMsIGhhc1NjcmlwdHMsIG5vZGUsIGRvYywKICAgICAgaSA9IDAsCiAgICAgIGwgPSB0aGlzLmxlbmd0aCwKICAgICAgc2V0ID0gdGhpcywKICAgICAgaU5vQ2xvbmUgPSBsIC0gMSwKICAgICAgdmFsdWUgPSBhcmdzWzBdLAogICAgICBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgogICAgLy8gV2UgY2FuJ3QgY2xvbmVOb2RlIGZyYWdtZW50cyB0aGF0IGNvbnRhaW4gY2hlY2tlZCwgaW4gV2ViS2l0CiAgICBpZiAoIGlzRnVuY3Rpb24gfHwgISggbCA8PSAxIHx8IHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIgfHwgalF1ZXJ5LnN1cHBvcnQuY2hlY2tDbG9uZSB8fCAhcmNoZWNrZWQudGVzdCggdmFsdWUgKSApICkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpbmRleCApIHsKICAgICAgICB2YXIgc2VsZiA9IHNldC5lcSggaW5kZXggKTsKICAgICAgICBpZiAoIGlzRnVuY3Rpb24gKSB7CiAgICAgICAgICBhcmdzWzBdID0gdmFsdWUuY2FsbCggdGhpcywgaW5kZXgsIHRhYmxlID8gc2VsZi5odG1sKCkgOiB1bmRlZmluZWQgKTsKICAgICAgICB9CiAgICAgICAgc2VsZi5kb21NYW5pcCggYXJncywgdGFibGUsIGNhbGxiYWNrICk7CiAgICAgIH0pOwogICAgfQoKICAgIGlmICggbCApIHsKICAgICAgZnJhZ21lbnQgPSBqUXVlcnkuYnVpbGRGcmFnbWVudCggYXJncywgdGhpc1sgMCBdLm93bmVyRG9jdW1lbnQsIGZhbHNlLCB0aGlzICk7CiAgICAgIGZpcnN0ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCiAgICAgIGlmICggZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgKSB7CiAgICAgICAgZnJhZ21lbnQgPSBmaXJzdDsKICAgICAgfQoKICAgICAgaWYgKCBmaXJzdCApIHsKICAgICAgICB0YWJsZSA9IHRhYmxlICYmIGpRdWVyeS5ub2RlTmFtZSggZmlyc3QsICJ0ciIgKTsKICAgICAgICBzY3JpcHRzID0galF1ZXJ5Lm1hcCggZ2V0QWxsKCBmcmFnbWVudCwgInNjcmlwdCIgKSwgZGlzYWJsZVNjcmlwdCApOwogICAgICAgIGhhc1NjcmlwdHMgPSBzY3JpcHRzLmxlbmd0aDsKCiAgICAgICAgLy8gVXNlIHRoZSBvcmlnaW5hbCBmcmFnbWVudCBmb3IgdGhlIGxhc3QgaXRlbSBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBiZWNhdXNlIGl0IGNhbiBlbmQgdXAKICAgICAgICAvLyBiZWluZyBlbXB0aWVkIGluY29ycmVjdGx5IGluIGNlcnRhaW4gc2l0dWF0aW9ucyAoIzgwNzApLgogICAgICAgIGZvciAoIDsgaSA8IGw7IGkrKyApIHsKICAgICAgICAgIG5vZGUgPSBmcmFnbWVudDsKCiAgICAgICAgICBpZiAoIGkgIT09IGlOb0Nsb25lICkgewogICAgICAgICAgICBub2RlID0galF1ZXJ5LmNsb25lKCBub2RlLCB0cnVlLCB0cnVlICk7CgogICAgICAgICAgICAvLyBLZWVwIHJlZmVyZW5jZXMgdG8gY2xvbmVkIHNjcmlwdHMgZm9yIGxhdGVyIHJlc3RvcmF0aW9uCiAgICAgICAgICAgIGlmICggaGFzU2NyaXB0cyApIHsKICAgICAgICAgICAgICBqUXVlcnkubWVyZ2UoIHNjcmlwdHMsIGdldEFsbCggbm9kZSwgInNjcmlwdCIgKSApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgY2FsbGJhY2suY2FsbCgKICAgICAgICAgICAgdGFibGUgJiYgalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzW2ldLCAidGFibGUiICkgPwogICAgICAgICAgICAgIGZpbmRPckFwcGVuZCggdGhpc1tpXSwgInRib2R5IiApIDoKICAgICAgICAgICAgICB0aGlzW2ldLAogICAgICAgICAgICBub2RlLAogICAgICAgICAgICBpCiAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgaWYgKCBoYXNTY3JpcHRzICkgewogICAgICAgICAgZG9jID0gc2NyaXB0c1sgc2NyaXB0cy5sZW5ndGggLSAxIF0ub3duZXJEb2N1bWVudDsKCiAgICAgICAgICAvLyBSZWVuYWJsZSBzY3JpcHRzCiAgICAgICAgICBqUXVlcnkubWFwKCBzY3JpcHRzLCByZXN0b3JlU2NyaXB0ICk7CgogICAgICAgICAgLy8gRXZhbHVhdGUgZXhlY3V0YWJsZSBzY3JpcHRzIG9uIGZpcnN0IGRvY3VtZW50IGluc2VydGlvbgogICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBoYXNTY3JpcHRzOyBpKysgKSB7CiAgICAgICAgICAgIG5vZGUgPSBzY3JpcHRzWyBpIF07CiAgICAgICAgICAgIGlmICggcnNjcmlwdFR5cGUudGVzdCggbm9kZS50eXBlIHx8ICIiICkgJiYKICAgICAgICAgICAgICAhalF1ZXJ5Ll9kYXRhKCBub2RlLCAiZ2xvYmFsRXZhbCIgKSAmJiBqUXVlcnkuY29udGFpbnMoIGRvYywgbm9kZSApICkgewoKICAgICAgICAgICAgICBpZiAoIG5vZGUuc3JjICkgewogICAgICAgICAgICAgICAgLy8gSG9wZSBhamF4IGlzIGF2YWlsYWJsZS4uLgogICAgICAgICAgICAgICAgalF1ZXJ5LmFqYXgoewogICAgICAgICAgICAgICAgICB1cmw6IG5vZGUuc3JjLAogICAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJzY3JpcHQiLAogICAgICAgICAgICAgICAgICBhc3luYzogZmFsc2UsCiAgICAgICAgICAgICAgICAgIGdsb2JhbDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICJ0aHJvd3MiOiB0cnVlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwoICggbm9kZS50ZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgbm9kZS5pbm5lckhUTUwgfHwgIiIgKS5yZXBsYWNlKCByY2xlYW5TY3JpcHQsICIiICkgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZpeCAjMTE4MDk6IEF2b2lkIGxlYWtpbmcgbWVtb3J5CiAgICAgICAgZnJhZ21lbnQgPSBmaXJzdCA9IG51bGw7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9Cn0pOwoKZnVuY3Rpb24gZmluZE9yQXBwZW5kKCBlbGVtLCB0YWcgKSB7CiAgcmV0dXJuIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApWzBdIHx8IGVsZW0uYXBwZW5kQ2hpbGQoIGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCB0YWcgKSApOwp9CgovLyBSZXBsYWNlL3Jlc3RvcmUgdGhlIHR5cGUgYXR0cmlidXRlIG9mIHNjcmlwdCBlbGVtZW50cyBmb3Igc2FmZSBET00gbWFuaXB1bGF0aW9uCmZ1bmN0aW9uIGRpc2FibGVTY3JpcHQoIGVsZW0gKSB7CiAgdmFyIGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoInR5cGUiKTsKICBlbGVtLnR5cGUgPSAoIGF0dHIgJiYgYXR0ci5zcGVjaWZpZWQgKSArICIvIiArIGVsZW0udHlwZTsKICByZXR1cm4gZWxlbTsKfQpmdW5jdGlvbiByZXN0b3JlU2NyaXB0KCBlbGVtICkgewogIHZhciBtYXRjaCA9IHJzY3JpcHRUeXBlTWFza2VkLmV4ZWMoIGVsZW0udHlwZSApOwogIGlmICggbWF0Y2ggKSB7CiAgICBlbGVtLnR5cGUgPSBtYXRjaFsxXTsKICB9IGVsc2UgewogICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoInR5cGUiKTsKICB9CiAgcmV0dXJuIGVsZW07Cn0KCi8vIE1hcmsgc2NyaXB0cyBhcyBoYXZpbmcgYWxyZWFkeSBiZWVuIGV2YWx1YXRlZApmdW5jdGlvbiBzZXRHbG9iYWxFdmFsKCBlbGVtcywgcmVmRWxlbWVudHMgKSB7CiAgdmFyIGVsZW0sCiAgICBpID0gMDsKICBmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKICAgIGpRdWVyeS5fZGF0YSggZWxlbSwgImdsb2JhbEV2YWwiLCAhcmVmRWxlbWVudHMgfHwgalF1ZXJ5Ll9kYXRhKCByZWZFbGVtZW50c1tpXSwgImdsb2JhbEV2YWwiICkgKTsKICB9Cn0KCmZ1bmN0aW9uIGNsb25lQ29weUV2ZW50KCBzcmMsIGRlc3QgKSB7CgogIGlmICggZGVzdC5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5Lmhhc0RhdGEoIHNyYyApICkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHR5cGUsIGksIGwsCiAgICBvbGREYXRhID0galF1ZXJ5Ll9kYXRhKCBzcmMgKSwKICAgIGN1ckRhdGEgPSBqUXVlcnkuX2RhdGEoIGRlc3QsIG9sZERhdGEgKSwKICAgIGV2ZW50cyA9IG9sZERhdGEuZXZlbnRzOwoKICBpZiAoIGV2ZW50cyApIHsKICAgIGRlbGV0ZSBjdXJEYXRhLmhhbmRsZTsKICAgIGN1ckRhdGEuZXZlbnRzID0ge307CgogICAgZm9yICggdHlwZSBpbiBldmVudHMgKSB7CiAgICAgIGZvciAoIGkgPSAwLCBsID0gZXZlbnRzWyB0eXBlIF0ubGVuZ3RoOyBpIDwgbDsgaSsrICkgewogICAgICAgIGpRdWVyeS5ldmVudC5hZGQoIGRlc3QsIHR5cGUsIGV2ZW50c1sgdHlwZSBdWyBpIF0gKTsKICAgICAgfQogICAgfQogIH0KCiAgLy8gbWFrZSB0aGUgY2xvbmVkIHB1YmxpYyBkYXRhIG9iamVjdCBhIGNvcHkgZnJvbSB0aGUgb3JpZ2luYWwKICBpZiAoIGN1ckRhdGEuZGF0YSApIHsKICAgIGN1ckRhdGEuZGF0YSA9IGpRdWVyeS5leHRlbmQoIHt9LCBjdXJEYXRhLmRhdGEgKTsKICB9Cn0KCmZ1bmN0aW9uIGZpeENsb25lTm9kZUlzc3Vlcyggc3JjLCBkZXN0ICkgewogIHZhciBub2RlTmFtZSwgZGF0YSwgZTsKCiAgLy8gV2UgZG8gbm90IG5lZWQgdG8gZG8gYW55dGhpbmcgZm9yIG5vbi1FbGVtZW50cwogIGlmICggZGVzdC5ub2RlVHlwZSAhPT0gMSApIHsKICAgIHJldHVybjsKICB9CgogIG5vZGVOYW1lID0gZGVzdC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoKICAvLyBJRTYtOCBjb3BpZXMgZXZlbnRzIGJvdW5kIHZpYSBhdHRhY2hFdmVudCB3aGVuIHVzaW5nIGNsb25lTm9kZS4KICBpZiAoICFqUXVlcnkuc3VwcG9ydC5ub0Nsb25lRXZlbnQgJiYgZGVzdFsgalF1ZXJ5LmV4cGFuZG8gXSApIHsKICAgIGRhdGEgPSBqUXVlcnkuX2RhdGEoIGRlc3QgKTsKCiAgICBmb3IgKCBlIGluIGRhdGEuZXZlbnRzICkgewogICAgICBqUXVlcnkucmVtb3ZlRXZlbnQoIGRlc3QsIGUsIGRhdGEuaGFuZGxlICk7CiAgICB9CgogICAgLy8gRXZlbnQgZGF0YSBnZXRzIHJlZmVyZW5jZWQgaW5zdGVhZCBvZiBjb3BpZWQgaWYgdGhlIGV4cGFuZG8gZ2V0cyBjb3BpZWQgdG9vCiAgICBkZXN0LnJlbW92ZUF0dHJpYnV0ZSggalF1ZXJ5LmV4cGFuZG8gKTsKICB9CgogIC8vIElFIGJsYW5rcyBjb250ZW50cyB3aGVuIGNsb25pbmcgc2NyaXB0cywgYW5kIHRyaWVzIHRvIGV2YWx1YXRlIG5ld2x5LXNldCB0ZXh0CiAgaWYgKCBub2RlTmFtZSA9PT0gInNjcmlwdCIgJiYgZGVzdC50ZXh0ICE9PSBzcmMudGV4dCApIHsKICAgIGRpc2FibGVTY3JpcHQoIGRlc3QgKS50ZXh0ID0gc3JjLnRleHQ7CiAgICByZXN0b3JlU2NyaXB0KCBkZXN0ICk7CgogIC8vIElFNi0xMCBpbXByb3Blcmx5IGNsb25lcyBjaGlsZHJlbiBvZiBvYmplY3QgZWxlbWVudHMgdXNpbmcgY2xhc3NpZC4KICAvLyBJRTEwIHRocm93cyBOb01vZGlmaWNhdGlvbkFsbG93ZWRFcnJvciBpZiBwYXJlbnQgaXMgbnVsbCwgIzEyMTMyLgogIH0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAib2JqZWN0IiApIHsKICAgIGlmICggZGVzdC5wYXJlbnROb2RlICkgewogICAgICBkZXN0Lm91dGVySFRNTCA9IHNyYy5vdXRlckhUTUw7CiAgICB9CgogICAgLy8gVGhpcyBwYXRoIGFwcGVhcnMgdW5hdm9pZGFibGUgZm9yIElFOS4gV2hlbiBjbG9uaW5nIGFuIG9iamVjdAogICAgLy8gZWxlbWVudCBpbiBJRTksIHRoZSBvdXRlckhUTUwgc3RyYXRlZ3kgYWJvdmUgaXMgbm90IHN1ZmZpY2llbnQuCiAgICAvLyBJZiB0aGUgc3JjIGhhcyBpbm5lckhUTUwgYW5kIHRoZSBkZXN0aW5hdGlvbiBkb2VzIG5vdCwKICAgIC8vIGNvcHkgdGhlIHNyYy5pbm5lckhUTUwgaW50byB0aGUgZGVzdC5pbm5lckhUTUwuICMxMDMyNAogICAgaWYgKCBqUXVlcnkuc3VwcG9ydC5odG1sNUNsb25lICYmICggc3JjLmlubmVySFRNTCAmJiAhalF1ZXJ5LnRyaW0oZGVzdC5pbm5lckhUTUwpICkgKSB7CiAgICAgIGRlc3QuaW5uZXJIVE1MID0gc3JjLmlubmVySFRNTDsKICAgIH0KCiAgfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgbWFuaXB1bGF0aW9uX3JjaGVja2FibGVUeXBlLnRlc3QoIHNyYy50eXBlICkgKSB7CiAgICAvLyBJRTYtOCBmYWlscyB0byBwZXJzaXN0IHRoZSBjaGVja2VkIHN0YXRlIG9mIGEgY2xvbmVkIGNoZWNrYm94CiAgICAvLyBvciByYWRpbyBidXR0b24uIFdvcnNlLCBJRTYtNyBmYWlsIHRvIGdpdmUgdGhlIGNsb25lZCBlbGVtZW50CiAgICAvLyBhIGNoZWNrZWQgYXBwZWFyYW5jZSBpZiB0aGUgZGVmYXVsdENoZWNrZWQgdmFsdWUgaXNuJ3QgYWxzbyBzZXQKCiAgICBkZXN0LmRlZmF1bHRDaGVja2VkID0gZGVzdC5jaGVja2VkID0gc3JjLmNoZWNrZWQ7CgogICAgLy8gSUU2LTcgZ2V0IGNvbmZ1c2VkIGFuZCBlbmQgdXAgc2V0dGluZyB0aGUgdmFsdWUgb2YgYSBjbG9uZWQKICAgIC8vIGNoZWNrYm94L3JhZGlvIGJ1dHRvbiB0byBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiAib24iCiAgICBpZiAoIGRlc3QudmFsdWUgIT09IHNyYy52YWx1ZSApIHsKICAgICAgZGVzdC52YWx1ZSA9IHNyYy52YWx1ZTsKICAgIH0KCiAgLy8gSUU2LTggZmFpbHMgdG8gcmV0dXJuIHRoZSBzZWxlY3RlZCBvcHRpb24gdG8gdGhlIGRlZmF1bHQgc2VsZWN0ZWQKICAvLyBzdGF0ZSB3aGVuIGNsb25pbmcgb3B0aW9ucwogIH0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAib3B0aW9uIiApIHsKICAgIGRlc3QuZGVmYXVsdFNlbGVjdGVkID0gZGVzdC5zZWxlY3RlZCA9IHNyYy5kZWZhdWx0U2VsZWN0ZWQ7CgogIC8vIElFNi04IGZhaWxzIHRvIHNldCB0aGUgZGVmYXVsdFZhbHVlIHRvIHRoZSBjb3JyZWN0IHZhbHVlIHdoZW4KICAvLyBjbG9uaW5nIG90aGVyIHR5cGVzIG9mIGlucHV0IGZpZWxkcwogIH0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiIHx8IG5vZGVOYW1lID09PSAidGV4dGFyZWEiICkgewogICAgZGVzdC5kZWZhdWx0VmFsdWUgPSBzcmMuZGVmYXVsdFZhbHVlOwogIH0KfQoKalF1ZXJ5LmVhY2goewogIGFwcGVuZFRvOiAiYXBwZW5kIiwKICBwcmVwZW5kVG86ICJwcmVwZW5kIiwKICBpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAogIGluc2VydEFmdGVyOiAiYWZ0ZXIiLAogIHJlcGxhY2VBbGw6ICJyZXBsYWNlV2l0aCIKfSwgZnVuY3Rpb24oIG5hbWUsIG9yaWdpbmFsICkgewogIGpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewogICAgdmFyIGVsZW1zLAogICAgICBpID0gMCwKICAgICAgcmV0ID0gW10sCiAgICAgIGluc2VydCA9IGpRdWVyeSggc2VsZWN0b3IgKSwKICAgICAgbGFzdCA9IGluc2VydC5sZW5ndGggLSAxOwoKICAgIGZvciAoIDsgaSA8PSBsYXN0OyBpKysgKSB7CiAgICAgIGVsZW1zID0gaSA9PT0gbGFzdCA/IHRoaXMgOiB0aGlzLmNsb25lKHRydWUpOwogICAgICBqUXVlcnkoIGluc2VydFtpXSApWyBvcmlnaW5hbCBdKCBlbGVtcyApOwoKICAgICAgLy8gTW9kZXJuIGJyb3dzZXJzIGNhbiBhcHBseSBqUXVlcnkgY29sbGVjdGlvbnMgYXMgYXJyYXlzLCBidXQgb2xkSUUgbmVlZHMgYSAuZ2V0KCkKICAgICAgY29yZV9wdXNoLmFwcGx5KCByZXQsIGVsZW1zLmdldCgpICk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQgKTsKICB9Owp9KTsKCmZ1bmN0aW9uIGdldEFsbCggY29udGV4dCwgdGFnICkgewogIHZhciBlbGVtcywgZWxlbSwKICAgIGkgPSAwLAogICAgZm91bmQgPSB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgPyBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgfHwgIioiICkgOgogICAgICB0eXBlb2YgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsICE9PSAidW5kZWZpbmVkIiA/IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggdGFnIHx8ICIqIiApIDoKICAgICAgdW5kZWZpbmVkOwoKICBpZiAoICFmb3VuZCApIHsKICAgIGZvciAoIGZvdW5kID0gW10sIGVsZW1zID0gY29udGV4dC5jaGlsZE5vZGVzIHx8IGNvbnRleHQ7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKICAgICAgaWYgKCAhdGFnIHx8IGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgdGFnICkgKSB7CiAgICAgICAgZm91bmQucHVzaCggZWxlbSApOwogICAgICB9IGVsc2UgewogICAgICAgIGpRdWVyeS5tZXJnZSggZm91bmQsIGdldEFsbCggZWxlbSwgdGFnICkgKTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHRhZyA9PT0gdW5kZWZpbmVkIHx8IHRhZyAmJiBqUXVlcnkubm9kZU5hbWUoIGNvbnRleHQsIHRhZyApID8KICAgIGpRdWVyeS5tZXJnZSggWyBjb250ZXh0IF0sIGZvdW5kICkgOgogICAgZm91bmQ7Cn0KCi8vIFVzZWQgaW4gYnVpbGRGcmFnbWVudCwgZml4ZXMgdGhlIGRlZmF1bHRDaGVja2VkIHByb3BlcnR5CmZ1bmN0aW9uIGZpeERlZmF1bHRDaGVja2VkKCBlbGVtICkgewogIGlmICggbWFuaXB1bGF0aW9uX3JjaGVja2FibGVUeXBlLnRlc3QoIGVsZW0udHlwZSApICkgewogICAgZWxlbS5kZWZhdWx0Q2hlY2tlZCA9IGVsZW0uY2hlY2tlZDsKICB9Cn0KCmpRdWVyeS5leHRlbmQoewogIGNsb25lOiBmdW5jdGlvbiggZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CiAgICB2YXIgZGVzdEVsZW1lbnRzLCBzcmNFbGVtZW50cywgbm9kZSwgaSwgY2xvbmUsCiAgICAgIGluUGFnZSA9IGpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7CgogICAgaWYgKCBqUXVlcnkuc3VwcG9ydC5odG1sNUNsb25lIHx8IGpRdWVyeS5pc1hNTERvYyhlbGVtKSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoICI8IiArIGVsZW0ubm9kZU5hbWUgKyAiPiIgKSApIHsKICAgICAgY2xvbmUgPSBlbGVtLmNsb25lTm9kZSggdHJ1ZSApOwoKICAgIC8vIElFPD04IGRvZXMgbm90IHByb3Blcmx5IGNsb25lIGRldGFjaGVkLCB1bmtub3duIGVsZW1lbnQgbm9kZXMKICAgIH0gZWxzZSB7CiAgICAgIGZyYWdtZW50RGl2LmlubmVySFRNTCA9IGVsZW0ub3V0ZXJIVE1MOwogICAgICBmcmFnbWVudERpdi5yZW1vdmVDaGlsZCggY2xvbmUgPSBmcmFnbWVudERpdi5maXJzdENoaWxkICk7CiAgICB9CgogICAgaWYgKCAoIWpRdWVyeS5zdXBwb3J0Lm5vQ2xvbmVFdmVudCB8fCAhalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUNoZWNrZWQpICYmCiAgICAgICAgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgZWxlbS5ub2RlVHlwZSA9PT0gMTEpICYmICFqUXVlcnkuaXNYTUxEb2MoZWxlbSkgKSB7CgogICAgICAvLyBXZSBlc2NoZXcgU2l6emxlIGhlcmUgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnM6IGh0dHA6Ly9qc3BlcmYuY29tL2dldGFsbC12cy1zaXp6bGUvMgogICAgICBkZXN0RWxlbWVudHMgPSBnZXRBbGwoIGNsb25lICk7CiAgICAgIHNyY0VsZW1lbnRzID0gZ2V0QWxsKCBlbGVtICk7CgogICAgICAvLyBGaXggYWxsIElFIGNsb25pbmcgaXNzdWVzCiAgICAgIGZvciAoIGkgPSAwOyAobm9kZSA9IHNyY0VsZW1lbnRzW2ldKSAhPSBudWxsOyArK2kgKSB7CiAgICAgICAgLy8gRW5zdXJlIHRoYXQgdGhlIGRlc3RpbmF0aW9uIG5vZGUgaXMgbm90IG51bGw7IEZpeGVzICM5NTg3CiAgICAgICAgaWYgKCBkZXN0RWxlbWVudHNbaV0gKSB7CiAgICAgICAgICBmaXhDbG9uZU5vZGVJc3N1ZXMoIG5vZGUsIGRlc3RFbGVtZW50c1tpXSApOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKICAgIGlmICggZGF0YUFuZEV2ZW50cyApIHsKICAgICAgaWYgKCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKICAgICAgICBzcmNFbGVtZW50cyA9IHNyY0VsZW1lbnRzIHx8IGdldEFsbCggZWxlbSApOwogICAgICAgIGRlc3RFbGVtZW50cyA9IGRlc3RFbGVtZW50cyB8fCBnZXRBbGwoIGNsb25lICk7CgogICAgICAgIGZvciAoIGkgPSAwOyAobm9kZSA9IHNyY0VsZW1lbnRzW2ldKSAhPSBudWxsOyBpKysgKSB7CiAgICAgICAgICBjbG9uZUNvcHlFdmVudCggbm9kZSwgZGVzdEVsZW1lbnRzW2ldICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNsb25lQ29weUV2ZW50KCBlbGVtLCBjbG9uZSApOwogICAgICB9CiAgICB9CgogICAgLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQogICAgZGVzdEVsZW1lbnRzID0gZ2V0QWxsKCBjbG9uZSwgInNjcmlwdCIgKTsKICAgIGlmICggZGVzdEVsZW1lbnRzLmxlbmd0aCA+IDAgKSB7CiAgICAgIHNldEdsb2JhbEV2YWwoIGRlc3RFbGVtZW50cywgIWluUGFnZSAmJiBnZXRBbGwoIGVsZW0sICJzY3JpcHQiICkgKTsKICAgIH0KCiAgICBkZXN0RWxlbWVudHMgPSBzcmNFbGVtZW50cyA9IG5vZGUgPSBudWxsOwoKICAgIC8vIFJldHVybiB0aGUgY2xvbmVkIHNldAogICAgcmV0dXJuIGNsb25lOwogIH0sCgogIGJ1aWxkRnJhZ21lbnQ6IGZ1bmN0aW9uKCBlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uICkgewogICAgdmFyIGNvbnRhaW5zLCBlbGVtLCB0YWcsIHRtcCwgd3JhcCwgdGJvZHksIGosCiAgICAgIGwgPSBlbGVtcy5sZW5ndGgsCgogICAgICAvLyBFbnN1cmUgYSBzYWZlIGZyYWdtZW50CiAgICAgIHNhZmUgPSBjcmVhdGVTYWZlRnJhZ21lbnQoIGNvbnRleHQgKSwKCiAgICAgIG5vZGVzID0gW10sCiAgICAgIGkgPSAwOwoKICAgIGZvciAoIDsgaSA8IGw7IGkrKyApIHsKICAgICAgZWxlbSA9IGVsZW1zWyBpIF07CgogICAgICBpZiAoIGVsZW0gfHwgZWxlbSA9PT0gMCApIHsKCiAgICAgICAgLy8gQWRkIG5vZGVzIGRpcmVjdGx5CiAgICAgICAgaWYgKCBqUXVlcnkudHlwZSggZWxlbSApID09PSAib2JqZWN0IiApIHsKICAgICAgICAgIGpRdWVyeS5tZXJnZSggbm9kZXMsIGVsZW0ubm9kZVR5cGUgPyBbIGVsZW0gXSA6IGVsZW0gKTsKCiAgICAgICAgLy8gQ29udmVydCBub24taHRtbCBpbnRvIGEgdGV4dCBub2RlCiAgICAgICAgfSBlbHNlIGlmICggIXJodG1sLnRlc3QoIGVsZW0gKSApIHsKICAgICAgICAgIG5vZGVzLnB1c2goIGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoIGVsZW0gKSApOwoKICAgICAgICAvLyBDb252ZXJ0IGh0bWwgaW50byBET00gbm9kZXMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdG1wID0gdG1wIHx8IHNhZmUuYXBwZW5kQ2hpbGQoIGNvbnRleHQuY3JlYXRlRWxlbWVudCgiZGl2IikgKTsKCiAgICAgICAgICAvLyBEZXNlcmlhbGl6ZSBhIHN0YW5kYXJkIHJlcHJlc2VudGF0aW9uCiAgICAgICAgICB0YWcgPSAoIHJ0YWdOYW1lLmV4ZWMoIGVsZW0gKSB8fCBbIiIsICIiXSApWzFdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICB3cmFwID0gd3JhcE1hcFsgdGFnIF0gfHwgd3JhcE1hcC5fZGVmYXVsdDsKCiAgICAgICAgICB0bXAuaW5uZXJIVE1MID0gd3JhcFsxXSArIGVsZW0ucmVwbGFjZSggcnhodG1sVGFnLCAiPCQxPjwvJDI+IiApICsgd3JhcFsyXTsKCiAgICAgICAgICAvLyBEZXNjZW5kIHRocm91Z2ggd3JhcHBlcnMgdG8gdGhlIHJpZ2h0IGNvbnRlbnQKICAgICAgICAgIGogPSB3cmFwWzBdOwogICAgICAgICAgd2hpbGUgKCBqLS0gKSB7CiAgICAgICAgICAgIHRtcCA9IHRtcC5sYXN0Q2hpbGQ7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTWFudWFsbHkgYWRkIGxlYWRpbmcgd2hpdGVzcGFjZSByZW1vdmVkIGJ5IElFCiAgICAgICAgICBpZiAoICFqUXVlcnkuc3VwcG9ydC5sZWFkaW5nV2hpdGVzcGFjZSAmJiBybGVhZGluZ1doaXRlc3BhY2UudGVzdCggZWxlbSApICkgewogICAgICAgICAgICBub2Rlcy5wdXNoKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBybGVhZGluZ1doaXRlc3BhY2UuZXhlYyggZWxlbSApWzBdICkgKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZW1vdmUgSUUncyBhdXRvaW5zZXJ0ZWQgPHRib2R5PiBmcm9tIHRhYmxlIGZyYWdtZW50cwogICAgICAgICAgaWYgKCAhalF1ZXJ5LnN1cHBvcnQudGJvZHkgKSB7CgogICAgICAgICAgICAvLyBTdHJpbmcgd2FzIGEgPHRhYmxlPiwgKm1heSogaGF2ZSBzcHVyaW91cyA8dGJvZHk+CiAgICAgICAgICAgIGVsZW0gPSB0YWcgPT09ICJ0YWJsZSIgJiYgIXJ0Ym9keS50ZXN0KCBlbGVtICkgPwogICAgICAgICAgICAgIHRtcC5maXJzdENoaWxkIDoKCiAgICAgICAgICAgICAgLy8gU3RyaW5nIHdhcyBhIGJhcmUgPHRoZWFkPiBvciA8dGZvb3Q+CiAgICAgICAgICAgICAgd3JhcFsxXSA9PT0gIjx0YWJsZT4iICYmICFydGJvZHkudGVzdCggZWxlbSApID8KICAgICAgICAgICAgICAgIHRtcCA6CiAgICAgICAgICAgICAgICAwOwoKICAgICAgICAgICAgaiA9IGVsZW0gJiYgZWxlbS5jaGlsZE5vZGVzLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKCBqLS0gKSB7CiAgICAgICAgICAgICAgaWYgKCBqUXVlcnkubm9kZU5hbWUoICh0Ym9keSA9IGVsZW0uY2hpbGROb2Rlc1tqXSksICJ0Ym9keSIgKSAmJiAhdGJvZHkuY2hpbGROb2Rlcy5sZW5ndGggKSB7CiAgICAgICAgICAgICAgICBlbGVtLnJlbW92ZUNoaWxkKCB0Ym9keSApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGpRdWVyeS5tZXJnZSggbm9kZXMsIHRtcC5jaGlsZE5vZGVzICk7CgogICAgICAgICAgLy8gRml4ICMxMjM5MiBmb3IgV2ViS2l0IGFuZCBJRSA+IDkKICAgICAgICAgIHRtcC50ZXh0Q29udGVudCA9ICIiOwoKICAgICAgICAgIC8vIEZpeCAjMTIzOTIgZm9yIG9sZElFCiAgICAgICAgICB3aGlsZSAoIHRtcC5maXJzdENoaWxkICkgewogICAgICAgICAgICB0bXAucmVtb3ZlQ2hpbGQoIHRtcC5maXJzdENoaWxkICk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gUmVtZW1iZXIgdGhlIHRvcC1sZXZlbCBjb250YWluZXIgZm9yIHByb3BlciBjbGVhbnVwCiAgICAgICAgICB0bXAgPSBzYWZlLmxhc3RDaGlsZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBGaXggIzExMzU2OiBDbGVhciBlbGVtZW50cyBmcm9tIGZyYWdtZW50CiAgICBpZiAoIHRtcCApIHsKICAgICAgc2FmZS5yZW1vdmVDaGlsZCggdG1wICk7CiAgICB9CgogICAgLy8gUmVzZXQgZGVmYXVsdENoZWNrZWQgZm9yIGFueSByYWRpb3MgYW5kIGNoZWNrYm94ZXMKICAgIC8vIGFib3V0IHRvIGJlIGFwcGVuZGVkIHRvIHRoZSBET00gaW4gSUUgNi83ICgjODA2MCkKICAgIGlmICggIWpRdWVyeS5zdXBwb3J0LmFwcGVuZENoZWNrZWQgKSB7CiAgICAgIGpRdWVyeS5ncmVwKCBnZXRBbGwoIG5vZGVzLCAiaW5wdXQiICksIGZpeERlZmF1bHRDaGVja2VkICk7CiAgICB9CgogICAgaSA9IDA7CiAgICB3aGlsZSAoIChlbGVtID0gbm9kZXNbIGkrKyBdKSApIHsKCiAgICAgIC8vICM0MDg3IC0gSWYgb3JpZ2luIGFuZCBkZXN0aW5hdGlvbiBlbGVtZW50cyBhcmUgdGhlIHNhbWUsIGFuZCB0aGlzIGlzCiAgICAgIC8vIHRoYXQgZWxlbWVudCwgZG8gbm90IGRvIGFueXRoaW5nCiAgICAgIGlmICggc2VsZWN0aW9uICYmIGpRdWVyeS5pbkFycmF5KCBlbGVtLCBzZWxlY3Rpb24gKSAhPT0gLTEgKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGNvbnRhaW5zID0galF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKTsKCiAgICAgIC8vIEFwcGVuZCB0byBmcmFnbWVudAogICAgICB0bXAgPSBnZXRBbGwoIHNhZmUuYXBwZW5kQ2hpbGQoIGVsZW0gKSwgInNjcmlwdCIgKTsKCiAgICAgIC8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkKICAgICAgaWYgKCBjb250YWlucyApIHsKICAgICAgICBzZXRHbG9iYWxFdmFsKCB0bXAgKTsKICAgICAgfQoKICAgICAgLy8gQ2FwdHVyZSBleGVjdXRhYmxlcwogICAgICBpZiAoIHNjcmlwdHMgKSB7CiAgICAgICAgaiA9IDA7CiAgICAgICAgd2hpbGUgKCAoZWxlbSA9IHRtcFsgaisrIF0pICkgewogICAgICAgICAgaWYgKCByc2NyaXB0VHlwZS50ZXN0KCBlbGVtLnR5cGUgfHwgIiIgKSApIHsKICAgICAgICAgICAgc2NyaXB0cy5wdXNoKCBlbGVtICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdG1wID0gbnVsbDsKCiAgICByZXR1cm4gc2FmZTsKICB9LAoKICBjbGVhbkRhdGE6IGZ1bmN0aW9uKCBlbGVtcywgLyogaW50ZXJuYWwgKi8gYWNjZXB0RGF0YSApIHsKICAgIHZhciBkYXRhLCBpZCwgZWxlbSwgdHlwZSwKICAgICAgaSA9IDAsCiAgICAgIGludGVybmFsS2V5ID0galF1ZXJ5LmV4cGFuZG8sCiAgICAgIGNhY2hlID0galF1ZXJ5LmNhY2hlLAogICAgICBkZWxldGVFeHBhbmRvID0galF1ZXJ5LnN1cHBvcnQuZGVsZXRlRXhwYW5kbywKICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsOwoKICAgIGZvciAoIDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoKICAgICAgaWYgKCBhY2NlcHREYXRhIHx8IGpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CgogICAgICAgIGlkID0gZWxlbVsgaW50ZXJuYWxLZXkgXTsKICAgICAgICBkYXRhID0gaWQgJiYgY2FjaGVbIGlkIF07CgogICAgICAgIGlmICggZGF0YSApIHsKICAgICAgICAgIGlmICggZGF0YS5ldmVudHMgKSB7CiAgICAgICAgICAgIGZvciAoIHR5cGUgaW4gZGF0YS5ldmVudHMgKSB7CiAgICAgICAgICAgICAgaWYgKCBzcGVjaWFsWyB0eXBlIF0gKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICk7CgogICAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBzaG9ydGN1dCB0byBhdm9pZCBqUXVlcnkuZXZlbnQucmVtb3ZlJ3Mgb3ZlcmhlYWQKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBkYXRhLmhhbmRsZSApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJlbW92ZSBjYWNoZSBvbmx5IGlmIGl0IHdhcyBub3QgYWxyZWFkeSByZW1vdmVkIGJ5IGpRdWVyeS5ldmVudC5yZW1vdmUKICAgICAgICAgIGlmICggY2FjaGVbIGlkIF0gKSB7CgogICAgICAgICAgICBkZWxldGUgY2FjaGVbIGlkIF07CgogICAgICAgICAgICAvLyBJRSBkb2VzIG5vdCBhbGxvdyB1cyB0byBkZWxldGUgZXhwYW5kbyBwcm9wZXJ0aWVzIGZyb20gbm9kZXMsCiAgICAgICAgICAgIC8vIG5vciBkb2VzIGl0IGhhdmUgYSByZW1vdmVBdHRyaWJ1dGUgZnVuY3Rpb24gb24gRG9jdW1lbnQgbm9kZXM7CiAgICAgICAgICAgIC8vIHdlIG11c3QgaGFuZGxlIGFsbCBvZiB0aGVzZSBjYXNlcwogICAgICAgICAgICBpZiAoIGRlbGV0ZUV4cGFuZG8gKSB7CiAgICAgICAgICAgICAgZGVsZXRlIGVsZW1bIGludGVybmFsS2V5IF07CgogICAgICAgICAgICB9IGVsc2UgaWYgKCB0eXBlb2YgZWxlbS5yZW1vdmVBdHRyaWJ1dGUgIT09ICJ1bmRlZmluZWQiICkgewogICAgICAgICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKCBpbnRlcm5hbEtleSApOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbGVtWyBpbnRlcm5hbEtleSBdID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29yZV9kZWxldGVkSWRzLnB1c2goIGlkICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIGN1ckNTUywgZ2V0U3R5bGVzLCBpZnJhbWUsCiAgcmFscGhhID0gL2FscGhhXChbXildKlwpL2ksCiAgcm9wYWNpdHkgPSAvb3BhY2l0eVxzKj1ccyooW14pXSopLywKICBycG9zaXRpb24gPSAvXih0b3B8cmlnaHR8Ym90dG9tfGxlZnQpJC8sCiAgLy8gc3dhcHBhYmxlIGlmIGRpc3BsYXkgaXMgbm9uZSBvciBzdGFydHMgd2l0aCB0YWJsZSBleGNlcHQgInRhYmxlIiwgInRhYmxlLWNlbGwiLCBvciAidGFibGUtY2FwdGlvbiIKICAvLyBzZWUgaGVyZSBmb3IgZGlzcGxheSB2YWx1ZXM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvQ1NTL2Rpc3BsYXkKICByZGlzcGxheXN3YXAgPSAvXihub25lfHRhYmxlKD8hLWNbZWFdKS4rKS8sCiAgcm1hcmdpbiA9IC9ebWFyZ2luLywKICBybnVtc3BsaXQgPSBuZXcgUmVnRXhwKCAiXigiICsgY29yZV9wbnVtICsgIikoLiopJCIsICJpIiApLAogIHJudW1ub25weCA9IG5ldyBSZWdFeHAoICJeKCIgKyBjb3JlX3BudW0gKyAiKSg/IXB4KVthLXolXSskIiwgImkiICksCiAgcnJlbE51bSA9IG5ldyBSZWdFeHAoICJeKFsrLV0pPSgiICsgY29yZV9wbnVtICsgIikiLCAiaSIgKSwKICBlbGVtZGlzcGxheSA9IHsgQk9EWTogImJsb2NrIiB9LAoKICBjc3NTaG93ID0geyBwb3NpdGlvbjogImFic29sdXRlIiwgdmlzaWJpbGl0eTogImhpZGRlbiIsIGRpc3BsYXk6ICJibG9jayIgfSwKICBjc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CiAgICBsZXR0ZXJTcGFjaW5nOiAwLAogICAgZm9udFdlaWdodDogNDAwCiAgfSwKCiAgY3NzRXhwYW5kID0gWyAiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0IiBdLAogIGNzc1ByZWZpeGVzID0gWyAiV2Via2l0IiwgIk8iLCAiTW96IiwgIm1zIiBdOwoKLy8gcmV0dXJuIGEgY3NzIHByb3BlcnR5IG1hcHBlZCB0byBhIHBvdGVudGlhbGx5IHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQpmdW5jdGlvbiB2ZW5kb3JQcm9wTmFtZSggc3R5bGUsIG5hbWUgKSB7CgogIC8vIHNob3J0Y3V0IGZvciBuYW1lcyB0aGF0IGFyZSBub3QgdmVuZG9yIHByZWZpeGVkCiAgaWYgKCBuYW1lIGluIHN0eWxlICkgewogICAgcmV0dXJuIG5hbWU7CiAgfQoKICAvLyBjaGVjayBmb3IgdmVuZG9yIHByZWZpeGVkIG5hbWVzCiAgdmFyIGNhcE5hbWUgPSBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwKICAgIG9yaWdOYW1lID0gbmFtZSwKICAgIGkgPSBjc3NQcmVmaXhlcy5sZW5ndGg7CgogIHdoaWxlICggaS0tICkgewogICAgbmFtZSA9IGNzc1ByZWZpeGVzWyBpIF0gKyBjYXBOYW1lOwogICAgaWYgKCBuYW1lIGluIHN0eWxlICkgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9CgogIHJldHVybiBvcmlnTmFtZTsKfQoKZnVuY3Rpb24gaXNIaWRkZW4oIGVsZW0sIGVsICkgewogIC8vIGlzSGlkZGVuIG1pZ2h0IGJlIGNhbGxlZCBmcm9tIGpRdWVyeSNmaWx0ZXIgZnVuY3Rpb247CiAgLy8gaW4gdGhhdCBjYXNlLCBlbGVtZW50IHdpbGwgYmUgc2Vjb25kIGFyZ3VtZW50CiAgZWxlbSA9IGVsIHx8IGVsZW07CiAgcmV0dXJuIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAibm9uZSIgfHwgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7Cn0KCmZ1bmN0aW9uIHNob3dIaWRlKCBlbGVtZW50cywgc2hvdyApIHsKICB2YXIgZWxlbSwKICAgIHZhbHVlcyA9IFtdLAogICAgaW5kZXggPSAwLAogICAgbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwoKICBmb3IgKCA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewogICAgZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwogICAgaWYgKCAhZWxlbS5zdHlsZSApIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICB2YWx1ZXNbIGluZGV4IF0gPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiApOwogICAgaWYgKCBzaG93ICkgewogICAgICAvLyBSZXNldCB0aGUgaW5saW5lIGRpc3BsYXkgb2YgdGhpcyBlbGVtZW50IHRvIGxlYXJuIGlmIGl0IGlzCiAgICAgIC8vIGJlaW5nIGhpZGRlbiBieSBjYXNjYWRlZCBydWxlcyBvciBub3QKICAgICAgaWYgKCAhdmFsdWVzWyBpbmRleCBdICYmIGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiICkgewogICAgICAgIGVsZW0uc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICB9CgogICAgICAvLyBTZXQgZWxlbWVudHMgd2hpY2ggaGF2ZSBiZWVuIG92ZXJyaWRkZW4gd2l0aCBkaXNwbGF5OiBub25lCiAgICAgIC8vIGluIGEgc3R5bGVzaGVldCB0byB3aGF0ZXZlciB0aGUgZGVmYXVsdCBicm93c2VyIHN0eWxlIGlzCiAgICAgIC8vIGZvciBzdWNoIGFuIGVsZW1lbnQKICAgICAgaWYgKCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmIGlzSGlkZGVuKCBlbGVtICkgKSB7CiAgICAgICAgdmFsdWVzWyBpbmRleCBdID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCAib2xkZGlzcGxheSIsIGNzc19kZWZhdWx0RGlzcGxheShlbGVtLm5vZGVOYW1lKSApOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCAhdmFsdWVzWyBpbmRleCBdICYmICFpc0hpZGRlbiggZWxlbSApICkgewogICAgICBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiwgalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgKTsKICAgIH0KICB9CgogIC8vIFNldCB0aGUgZGlzcGxheSBvZiBtb3N0IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wCiAgLy8gdG8gYXZvaWQgdGhlIGNvbnN0YW50IHJlZmxvdwogIGZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CiAgICBlbGVtID0gZWxlbWVudHNbIGluZGV4IF07CiAgICBpZiAoICFlbGVtLnN0eWxlICkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIGlmICggIXNob3cgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAiIiApIHsKICAgICAgZWxlbS5zdHlsZS5kaXNwbGF5ID0gc2hvdyA/IHZhbHVlc1sgaW5kZXggXSB8fCAiIiA6ICJub25lIjsKICAgIH0KICB9CgogIHJldHVybiBlbGVtZW50czsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7CiAgY3NzOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CiAgICByZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewogICAgICB2YXIgc3R5bGVzLCBsZW4sCiAgICAgICAgbWFwID0ge30sCiAgICAgICAgaSA9IDA7CgogICAgICBpZiAoIGpRdWVyeS5pc0FycmF5KCBuYW1lICkgKSB7CiAgICAgICAgc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICk7CiAgICAgICAgbGVuID0gbmFtZS5sZW5ndGg7CgogICAgICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrICkgewogICAgICAgICAgbWFwWyBuYW1lWyBpIF0gXSA9IGpRdWVyeS5jc3MoIGVsZW0sIG5hbWVbIGkgXSwgZmFsc2UsIHN0eWxlcyApOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgfQoKICAgICAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPwogICAgICAgIGpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSwgdmFsdWUgKSA6CiAgICAgICAgalF1ZXJ5LmNzcyggZWxlbSwgbmFtZSApOwogICAgfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7CiAgfSwKICBzaG93OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzaG93SGlkZSggdGhpcywgdHJ1ZSApOwogIH0sCiAgaGlkZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gc2hvd0hpZGUoIHRoaXMgKTsKICB9LAogIHRvZ2dsZTogZnVuY3Rpb24oIHN0YXRlICkgewogICAgdmFyIGJvb2wgPSB0eXBlb2Ygc3RhdGUgPT09ICJib29sZWFuIjsKCiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICBpZiAoIGJvb2wgPyBzdGF0ZSA6IGlzSGlkZGVuKCB0aGlzICkgKSB7CiAgICAgICAgalF1ZXJ5KCB0aGlzICkuc2hvdygpOwogICAgICB9IGVsc2UgewogICAgICAgIGpRdWVyeSggdGhpcyApLmhpZGUoKTsKICAgICAgfQogICAgfSk7CiAgfQp9KTsKCmpRdWVyeS5leHRlbmQoewogIC8vIEFkZCBpbiBzdHlsZSBwcm9wZXJ0eSBob29rcyBmb3Igb3ZlcnJpZGluZyB0aGUgZGVmYXVsdAogIC8vIGJlaGF2aW9yIG9mIGdldHRpbmcgYW5kIHNldHRpbmcgYSBzdHlsZSBwcm9wZXJ0eQogIGNzc0hvb2tzOiB7CiAgICBvcGFjaXR5OiB7CiAgICAgIGdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewogICAgICAgIGlmICggY29tcHV0ZWQgKSB7CiAgICAgICAgICAvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQogICAgICAgICAgdmFyIHJldCA9IGN1ckNTUyggZWxlbSwgIm9wYWNpdHkiICk7CiAgICAgICAgICByZXR1cm4gcmV0ID09PSAiIiA/ICIxIiA6IHJldDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LAoKICAvLyBFeGNsdWRlIHRoZSBmb2xsb3dpbmcgY3NzIHByb3BlcnRpZXMgdG8gYWRkIHB4CiAgY3NzTnVtYmVyOiB7CiAgICAiY29sdW1uQ291bnQiOiB0cnVlLAogICAgImZpbGxPcGFjaXR5IjogdHJ1ZSwKICAgICJmb250V2VpZ2h0IjogdHJ1ZSwKICAgICJsaW5lSGVpZ2h0IjogdHJ1ZSwKICAgICJvcGFjaXR5IjogdHJ1ZSwKICAgICJvcnBoYW5zIjogdHJ1ZSwKICAgICJ3aWRvd3MiOiB0cnVlLAogICAgInpJbmRleCI6IHRydWUsCiAgICAiem9vbSI6IHRydWUKICB9LAoKICAvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCiAgLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQogIGNzc1Byb3BzOiB7CiAgICAvLyBub3JtYWxpemUgZmxvYXQgY3NzIHByb3BlcnR5CiAgICAiZmxvYXQiOiBqUXVlcnkuc3VwcG9ydC5jc3NGbG9hdCA/ICJjc3NGbG9hdCIgOiAic3R5bGVGbG9hdCIKICB9LAoKICAvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQogIHN0eWxlOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUsIGV4dHJhICkgewogICAgLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCiAgICBpZiAoICFlbGVtIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCB8fCAhZWxlbS5zdHlsZSApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQogICAgdmFyIHJldCwgdHlwZSwgaG9va3MsCiAgICAgIG9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApLAogICAgICBzdHlsZSA9IGVsZW0uc3R5bGU7CgogICAgbmFtZSA9IGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSB8fCAoIGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSA9IHZlbmRvclByb3BOYW1lKCBzdHlsZSwgb3JpZ05hbWUgKSApOwoKICAgIC8vIGdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24KICAgIC8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKICAgIC8vIENoZWNrIGlmIHdlJ3JlIHNldHRpbmcgYSB2YWx1ZQogICAgaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewogICAgICB0eXBlID0gdHlwZW9mIHZhbHVlOwoKICAgICAgLy8gY29udmVydCByZWxhdGl2ZSBudW1iZXIgc3RyaW5ncyAoKz0gb3IgLT0pIHRvIHJlbGF0aXZlIG51bWJlcnMuICM3MzQ1CiAgICAgIGlmICggdHlwZSA9PT0gInN0cmluZyIgJiYgKHJldCA9IHJyZWxOdW0uZXhlYyggdmFsdWUgKSkgKSB7CiAgICAgICAgdmFsdWUgPSAoIHJldFsxXSArIDEgKSAqIHJldFsyXSArIHBhcnNlRmxvYXQoIGpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKSApOwogICAgICAgIC8vIEZpeGVzIGJ1ZyAjOTIzNwogICAgICAgIHR5cGUgPSAibnVtYmVyIjsKICAgICAgfQoKICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgTmFOIGFuZCBudWxsIHZhbHVlcyBhcmVuJ3Qgc2V0LiBTZWU6ICM3MTE2CiAgICAgIGlmICggdmFsdWUgPT0gbnVsbCB8fCB0eXBlID09PSAibnVtYmVyIiAmJiBpc05hTiggdmFsdWUgKSApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIElmIGEgbnVtYmVyIHdhcyBwYXNzZWQgaW4sIGFkZCAncHgnIHRvIHRoZSAoZXhjZXB0IGZvciBjZXJ0YWluIENTUyBwcm9wZXJ0aWVzKQogICAgICBpZiAoIHR5cGUgPT09ICJudW1iZXIiICYmICFqUXVlcnkuY3NzTnVtYmVyWyBvcmlnTmFtZSBdICkgewogICAgICAgIHZhbHVlICs9ICJweCI7CiAgICAgIH0KCiAgICAgIC8vIEZpeGVzICM4OTA4LCBpdCBjYW4gYmUgZG9uZSBtb3JlIGNvcnJlY3RseSBieSBzcGVjaWZpbmcgc2V0dGVycyBpbiBjc3NIb29rcywKICAgICAgLy8gYnV0IGl0IHdvdWxkIG1lYW4gdG8gZGVmaW5lIGVpZ2h0IChmb3IgZXZlcnkgcHJvYmxlbWF0aWMgcHJvcGVydHkpIGlkZW50aWNhbCBmdW5jdGlvbnMKICAgICAgaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlICYmIHZhbHVlID09PSAiIiAmJiBuYW1lLmluZGV4T2YoImJhY2tncm91bmQiKSA9PT0gMCApIHsKICAgICAgICBzdHlsZVsgbmFtZSBdID0gImluaGVyaXQiOwogICAgICB9CgogICAgICAvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkLCB1c2UgdGhhdCB2YWx1ZSwgb3RoZXJ3aXNlIGp1c3Qgc2V0IHRoZSBzcGVjaWZpZWQgdmFsdWUKICAgICAgaWYgKCAhaG9va3MgfHwgISgic2V0IiBpbiBob29rcykgfHwgKHZhbHVlID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgZXh0cmEgKSkgIT09IHVuZGVmaW5lZCApIHsKCiAgICAgICAgLy8gV3JhcHBlZCB0byBwcmV2ZW50IElFIGZyb20gdGhyb3dpbmcgZXJyb3JzIHdoZW4gJ2ludmFsaWQnIHZhbHVlcyBhcmUgcHJvdmlkZWQKICAgICAgICAvLyBGaXhlcyBidWcgIzU1MDkKICAgICAgICB0cnkgewogICAgICAgICAgc3R5bGVbIG5hbWUgXSA9IHZhbHVlOwogICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBub24tY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQogICAgICBpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIGZhbHNlLCBleHRyYSApKSAhPT0gdW5kZWZpbmVkICkgewogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KCiAgICAgIC8vIE90aGVyd2lzZSBqdXN0IGdldCB0aGUgdmFsdWUgZnJvbSB0aGUgc3R5bGUgb2JqZWN0CiAgICAgIHJldHVybiBzdHlsZVsgbmFtZSBdOwogICAgfQogIH0sCgogIGNzczogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGV4dHJhLCBzdHlsZXMgKSB7CiAgICB2YXIgdmFsLCBudW0sIGhvb2tzLAogICAgICBvcmlnTmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKTsKCiAgICAvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKICAgIG5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gfHwgKCBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gPSB2ZW5kb3JQcm9wTmFtZSggZWxlbS5zdHlsZSwgb3JpZ05hbWUgKSApOwoKICAgIC8vIGdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24KICAgIC8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICBpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICkgewogICAgICB2YWwgPSBob29rcy5nZXQoIGVsZW0sIHRydWUsIGV4dHJhICk7CiAgICB9CgogICAgLy8gT3RoZXJ3aXNlLCBpZiBhIHdheSB0byBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGV4aXN0cywgdXNlIHRoYXQKICAgIGlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CiAgICAgIHZhbCA9IGN1ckNTUyggZWxlbSwgbmFtZSwgc3R5bGVzICk7CiAgICB9CgogICAgLy9jb252ZXJ0ICJub3JtYWwiIHRvIGNvbXB1dGVkIHZhbHVlCiAgICBpZiAoIHZhbCA9PT0gIm5vcm1hbCIgJiYgbmFtZSBpbiBjc3NOb3JtYWxUcmFuc2Zvcm0gKSB7CiAgICAgIHZhbCA9IGNzc05vcm1hbFRyYW5zZm9ybVsgbmFtZSBdOwogICAgfQoKICAgIC8vIFJldHVybiwgY29udmVydGluZyB0byBudW1iZXIgaWYgZm9yY2VkIG9yIGEgcXVhbGlmaWVyIHdhcyBwcm92aWRlZCBhbmQgdmFsIGxvb2tzIG51bWVyaWMKICAgIGlmICggZXh0cmEgKSB7CiAgICAgIG51bSA9IHBhcnNlRmxvYXQoIHZhbCApOwogICAgICByZXR1cm4gZXh0cmEgPT09IHRydWUgfHwgalF1ZXJ5LmlzTnVtZXJpYyggbnVtICkgPyBudW0gfHwgMCA6IHZhbDsKICAgIH0KICAgIHJldHVybiB2YWw7CiAgfSwKCiAgLy8gQSBtZXRob2QgZm9yIHF1aWNrbHkgc3dhcHBpbmcgaW4vb3V0IENTUyBwcm9wZXJ0aWVzIHRvIGdldCBjb3JyZWN0IGNhbGN1bGF0aW9ucwogIHN3YXA6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBjYWxsYmFjaywgYXJncyApIHsKICAgIHZhciByZXQsIG5hbWUsCiAgICAgIG9sZCA9IHt9OwoKICAgIC8vIFJlbWVtYmVyIHRoZSBvbGQgdmFsdWVzLCBhbmQgaW5zZXJ0IHRoZSBuZXcgb25lcwogICAgZm9yICggbmFtZSBpbiBvcHRpb25zICkgewogICAgICBvbGRbIG5hbWUgXSA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKICAgICAgZWxlbS5zdHlsZVsgbmFtZSBdID0gb3B0aW9uc1sgbmFtZSBdOwogICAgfQoKICAgIHJldCA9IGNhbGxiYWNrLmFwcGx5KCBlbGVtLCBhcmdzIHx8IFtdICk7CgogICAgLy8gUmV2ZXJ0IHRoZSBvbGQgdmFsdWVzCiAgICBmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CiAgICAgIGVsZW0uc3R5bGVbIG5hbWUgXSA9IG9sZFsgbmFtZSBdOwogICAgfQoKICAgIHJldHVybiByZXQ7CiAgfQp9KTsKCi8vIE5PVEU6IHdlJ3ZlIGluY2x1ZGVkIHRoZSAid2luZG93IiBpbiB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZQovLyBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0LgppZiAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlICkgewogIGdldFN0eWxlcyA9IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbGVtLCBudWxsICk7CiAgfTsKCiAgY3VyQ1NTID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUsIF9jb21wdXRlZCApIHsKICAgIHZhciB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLAogICAgICBjb21wdXRlZCA9IF9jb21wdXRlZCB8fCBnZXRTdHlsZXMoIGVsZW0gKSwKCiAgICAgIC8vIGdldFByb3BlcnR5VmFsdWUgaXMgb25seSBuZWVkZWQgZm9yIC5jc3MoJ2ZpbHRlcicpIGluIElFOSwgc2VlICMxMjUzNwogICAgICByZXQgPSBjb21wdXRlZCA/IGNvbXB1dGVkLmdldFByb3BlcnR5VmFsdWUoIG5hbWUgKSB8fCBjb21wdXRlZFsgbmFtZSBdIDogdW5kZWZpbmVkLAogICAgICBzdHlsZSA9IGVsZW0uc3R5bGU7CgogICAgaWYgKCBjb21wdXRlZCApIHsKCiAgICAgIGlmICggcmV0ID09PSAiIiAmJiAhalF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKSApIHsKICAgICAgICByZXQgPSBqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUgKTsKICAgICAgfQoKICAgICAgLy8gQSB0cmlidXRlIHRvIHRoZSAiYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcyIKICAgICAgLy8gQ2hyb21lIDwgMTcgYW5kIFNhZmFyaSA1LjAgdXNlcyAiY29tcHV0ZWQgdmFsdWUiIGluc3RlYWQgb2YgInVzZWQgdmFsdWUiIGZvciBtYXJnaW4tcmlnaHQKICAgICAgLy8gU2FmYXJpIDUuMS43IChhdCBsZWFzdCkgcmV0dXJucyBwZXJjZW50YWdlIGZvciBhIGxhcmdlciBzZXQgb2YgdmFsdWVzLCBidXQgd2lkdGggc2VlbXMgdG8gYmUgcmVsaWFibHkgcGl4ZWxzCiAgICAgIC8vIHRoaXMgaXMgYWdhaW5zdCB0aGUgQ1NTT00gZHJhZnQgc3BlYzogaHR0cDovL2Rldi53My5vcmcvY3Nzd2cvY3Nzb20vI3Jlc29sdmVkLXZhbHVlcwogICAgICBpZiAoIHJudW1ub25weC50ZXN0KCByZXQgKSAmJiBybWFyZ2luLnRlc3QoIG5hbWUgKSApIHsKCiAgICAgICAgLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwogICAgICAgIHdpZHRoID0gc3R5bGUud2lkdGg7CiAgICAgICAgbWluV2lkdGggPSBzdHlsZS5taW5XaWR0aDsKICAgICAgICBtYXhXaWR0aCA9IHN0eWxlLm1heFdpZHRoOwoKICAgICAgICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgICAgICAgc3R5bGUubWluV2lkdGggPSBzdHlsZS5tYXhXaWR0aCA9IHN0eWxlLndpZHRoID0gcmV0OwogICAgICAgIHJldCA9IGNvbXB1dGVkLndpZHRoOwoKICAgICAgICAvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCiAgICAgICAgc3R5bGUud2lkdGggPSB3aWR0aDsKICAgICAgICBzdHlsZS5taW5XaWR0aCA9IG1pbldpZHRoOwogICAgICAgIHN0eWxlLm1heFdpZHRoID0gbWF4V2lkdGg7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH07Cn0gZWxzZSBpZiAoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jdXJyZW50U3R5bGUgKSB7CiAgZ2V0U3R5bGVzID0gZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gZWxlbS5jdXJyZW50U3R5bGU7CiAgfTsKCiAgY3VyQ1NTID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUsIF9jb21wdXRlZCApIHsKICAgIHZhciBsZWZ0LCBycywgcnNMZWZ0LAogICAgICBjb21wdXRlZCA9IF9jb21wdXRlZCB8fCBnZXRTdHlsZXMoIGVsZW0gKSwKICAgICAgcmV0ID0gY29tcHV0ZWQgPyBjb21wdXRlZFsgbmFtZSBdIDogdW5kZWZpbmVkLAogICAgICBzdHlsZSA9IGVsZW0uc3R5bGU7CgogICAgLy8gQXZvaWQgc2V0dGluZyByZXQgdG8gZW1wdHkgc3RyaW5nIGhlcmUKICAgIC8vIHNvIHdlIGRvbid0IGRlZmF1bHQgdG8gYXV0bwogICAgaWYgKCByZXQgPT0gbnVsbCAmJiBzdHlsZSAmJiBzdHlsZVsgbmFtZSBdICkgewogICAgICByZXQgPSBzdHlsZVsgbmFtZSBdOwogICAgfQoKICAgIC8vIEZyb20gdGhlIGF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMKICAgIC8vIGh0dHA6Ly9lcmlrLmVhZS5uZXQvYXJjaGl2ZXMvMjAwNy8wNy8yNy8xOC41NC4xNS8jY29tbWVudC0xMDIyOTEKCiAgICAvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKICAgIC8vIGJ1dCBhIG51bWJlciB0aGF0IGhhcyBhIHdlaXJkIGVuZGluZywgd2UgbmVlZCB0byBjb252ZXJ0IGl0IHRvIHBpeGVscwogICAgLy8gYnV0IG5vdCBwb3NpdGlvbiBjc3MgYXR0cmlidXRlcywgYXMgdGhvc2UgYXJlIHByb3BvcnRpb25hbCB0byB0aGUgcGFyZW50IGVsZW1lbnQgaW5zdGVhZAogICAgLy8gYW5kIHdlIGNhbid0IG1lYXN1cmUgdGhlIHBhcmVudCBpbnN0ZWFkIGJlY2F1c2UgaXQgbWlnaHQgdHJpZ2dlciBhICJzdGFja2luZyBkb2xscyIgcHJvYmxlbQogICAgaWYgKCBybnVtbm9ucHgudGVzdCggcmV0ICkgJiYgIXJwb3NpdGlvbi50ZXN0KCBuYW1lICkgKSB7CgogICAgICAvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCiAgICAgIGxlZnQgPSBzdHlsZS5sZWZ0OwogICAgICBycyA9IGVsZW0ucnVudGltZVN0eWxlOwogICAgICByc0xlZnQgPSBycyAmJiBycy5sZWZ0OwoKICAgICAgLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dAogICAgICBpZiAoIHJzTGVmdCApIHsKICAgICAgICBycy5sZWZ0ID0gZWxlbS5jdXJyZW50U3R5bGUubGVmdDsKICAgICAgfQogICAgICBzdHlsZS5sZWZ0ID0gbmFtZSA9PT0gImZvbnRTaXplIiA/ICIxZW0iIDogcmV0OwogICAgICByZXQgPSBzdHlsZS5waXhlbExlZnQgKyAicHgiOwoKICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICBzdHlsZS5sZWZ0ID0gbGVmdDsKICAgICAgaWYgKCByc0xlZnQgKSB7CiAgICAgICAgcnMubGVmdCA9IHJzTGVmdDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXQgPT09ICIiID8gImF1dG8iIDogcmV0OwogIH07Cn0KCmZ1bmN0aW9uIHNldFBvc2l0aXZlTnVtYmVyKCBlbGVtLCB2YWx1ZSwgc3VidHJhY3QgKSB7CiAgdmFyIG1hdGNoZXMgPSBybnVtc3BsaXQuZXhlYyggdmFsdWUgKTsKICByZXR1cm4gbWF0Y2hlcyA/CiAgICAvLyBHdWFyZCBhZ2FpbnN0IHVuZGVmaW5lZCAic3VidHJhY3QiLCBlLmcuLCB3aGVuIHVzZWQgYXMgaW4gY3NzSG9va3MKICAgIE1hdGgubWF4KCAwLCBtYXRjaGVzWyAxIF0gLSAoIHN1YnRyYWN0IHx8IDAgKSApICsgKCBtYXRjaGVzWyAyIF0gfHwgInB4IiApIDoKICAgIHZhbHVlOwp9CgpmdW5jdGlvbiBhdWdtZW50V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEsIGlzQm9yZGVyQm94LCBzdHlsZXMgKSB7CiAgdmFyIGkgPSBleHRyYSA9PT0gKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICkgPwogICAgLy8gSWYgd2UgYWxyZWFkeSBoYXZlIHRoZSByaWdodCBtZWFzdXJlbWVudCwgYXZvaWQgYXVnbWVudGF0aW9uCiAgICA0IDoKICAgIC8vIE90aGVyd2lzZSBpbml0aWFsaXplIGZvciBob3Jpem9udGFsIG9yIHZlcnRpY2FsIHByb3BlcnRpZXMKICAgIG5hbWUgPT09ICJ3aWR0aCIgPyAxIDogMCwKCiAgICB2YWwgPSAwOwoKICBmb3IgKCA7IGkgPCA0OyBpICs9IDIgKSB7CiAgICAvLyBib3RoIGJveCBtb2RlbHMgZXhjbHVkZSBtYXJnaW4sIHNvIGFkZCBpdCBpZiB3ZSB3YW50IGl0CiAgICBpZiAoIGV4dHJhID09PSAibWFyZ2luIiApIHsKICAgICAgdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sIGV4dHJhICsgY3NzRXhwYW5kWyBpIF0sIHRydWUsIHN0eWxlcyApOwogICAgfQoKICAgIGlmICggaXNCb3JkZXJCb3ggKSB7CiAgICAgIC8vIGJvcmRlci1ib3ggaW5jbHVkZXMgcGFkZGluZywgc28gcmVtb3ZlIGl0IGlmIHdlIHdhbnQgY29udGVudAogICAgICBpZiAoIGV4dHJhID09PSAiY29udGVudCIgKSB7CiAgICAgICAgdmFsIC09IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKICAgICAgfQoKICAgICAgLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgYm9yZGVyIG5vciBtYXJnaW4sIHNvIHJlbW92ZSBib3JkZXIKICAgICAgaWYgKCBleHRyYSAhPT0gIm1hcmdpbiIgKSB7CiAgICAgICAgdmFsIC09IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCwgc28gYWRkIHBhZGRpbmcKICAgICAgdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCiAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGNvbnRlbnQgbm9yIHBhZGRpbmcsIHNvIGFkZCBib3JkZXIKICAgICAgaWYgKCBleHRyYSAhPT0gInBhZGRpbmciICkgewogICAgICAgIHZhbCArPSBqUXVlcnkuY3NzKCBlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIiwgdHJ1ZSwgc3R5bGVzICk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiB2YWw7Cn0KCmZ1bmN0aW9uIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICkgewoKICAvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQogIHZhciB2YWx1ZUlzQm9yZGVyQm94ID0gdHJ1ZSwKICAgIHZhbCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsCiAgICBzdHlsZXMgPSBnZXRTdHlsZXMoIGVsZW0gKSwKICAgIGlzQm9yZGVyQm94ID0galF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IjsKCiAgLy8gc29tZSBub24taHRtbCBlbGVtZW50cyByZXR1cm4gdW5kZWZpbmVkIGZvciBvZmZzZXRXaWR0aCwgc28gY2hlY2sgZm9yIG51bGwvdW5kZWZpbmVkCiAgLy8gc3ZnIC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjQ5Mjg1CiAgLy8gTWF0aE1MIC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDkxNjY4CiAgaWYgKCB2YWwgPD0gMCB8fCB2YWwgPT0gbnVsbCApIHsKICAgIC8vIEZhbGwgYmFjayB0byBjb21wdXRlZCB0aGVuIHVuY29tcHV0ZWQgY3NzIGlmIG5lY2Vzc2FyeQogICAgdmFsID0gY3VyQ1NTKCBlbGVtLCBuYW1lLCBzdHlsZXMgKTsKICAgIGlmICggdmFsIDwgMCB8fCB2YWwgPT0gbnVsbCApIHsKICAgICAgdmFsID0gZWxlbS5zdHlsZVsgbmFtZSBdOwogICAgfQoKICAgIC8vIENvbXB1dGVkIHVuaXQgaXMgbm90IHBpeGVscy4gU3RvcCBoZXJlIGFuZCByZXR1cm4uCiAgICBpZiAoIHJudW1ub25weC50ZXN0KHZhbCkgKSB7CiAgICAgIHJldHVybiB2YWw7CiAgICB9CgogICAgLy8gd2UgbmVlZCB0aGUgY2hlY2sgZm9yIHN0eWxlIGluIGNhc2UgYSBicm93c2VyIHdoaWNoIHJldHVybnMgdW5yZWxpYWJsZSB2YWx1ZXMKICAgIC8vIGZvciBnZXRDb21wdXRlZFN0eWxlIHNpbGVudGx5IGZhbGxzIGJhY2sgdG8gdGhlIHJlbGlhYmxlIGVsZW0uc3R5bGUKICAgIHZhbHVlSXNCb3JkZXJCb3ggPSBpc0JvcmRlckJveCAmJiAoIGpRdWVyeS5zdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlIHx8IHZhbCA9PT0gZWxlbS5zdHlsZVsgbmFtZSBdICk7CgogICAgLy8gTm9ybWFsaXplICIiLCBhdXRvLCBhbmQgcHJlcGFyZSBmb3IgZXh0cmEKICAgIHZhbCA9IHBhcnNlRmxvYXQoIHZhbCApIHx8IDA7CiAgfQoKICAvLyB1c2UgdGhlIGFjdGl2ZSBib3gtc2l6aW5nIG1vZGVsIHRvIGFkZC9zdWJ0cmFjdCBpcnJlbGV2YW50IHN0eWxlcwogIHJldHVybiAoIHZhbCArCiAgICBhdWdtZW50V2lkdGhPckhlaWdodCgKICAgICAgZWxlbSwKICAgICAgbmFtZSwKICAgICAgZXh0cmEgfHwgKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICksCiAgICAgIHZhbHVlSXNCb3JkZXJCb3gsCiAgICAgIHN0eWxlcwogICAgKQogICkgKyAicHgiOwp9CgovLyBUcnkgdG8gZGV0ZXJtaW5lIHRoZSBkZWZhdWx0IGRpc3BsYXkgdmFsdWUgb2YgYW4gZWxlbWVudApmdW5jdGlvbiBjc3NfZGVmYXVsdERpc3BsYXkoIG5vZGVOYW1lICkgewogIHZhciBkb2MgPSBkb2N1bWVudCwKICAgIGRpc3BsYXkgPSBlbGVtZGlzcGxheVsgbm9kZU5hbWUgXTsKCiAgaWYgKCAhZGlzcGxheSApIHsKICAgIGRpc3BsYXkgPSBhY3R1YWxEaXNwbGF5KCBub2RlTmFtZSwgZG9jICk7CgogICAgLy8gSWYgdGhlIHNpbXBsZSB3YXkgZmFpbHMsIHJlYWQgZnJvbSBpbnNpZGUgYW4gaWZyYW1lCiAgICBpZiAoIGRpc3BsYXkgPT09ICJub25lIiB8fCAhZGlzcGxheSApIHsKICAgICAgLy8gVXNlIHRoZSBhbHJlYWR5LWNyZWF0ZWQgaWZyYW1lIGlmIHBvc3NpYmxlCiAgICAgIGlmcmFtZSA9ICggaWZyYW1lIHx8CiAgICAgICAgalF1ZXJ5KCI8aWZyYW1lIGZyYW1lYm9yZGVyPScwJyB3aWR0aD0nMCcgaGVpZ2h0PScwJy8+IikKICAgICAgICAuY3NzKCAiY3NzVGV4dCIsICJkaXNwbGF5OmJsb2NrICFpbXBvcnRhbnQiICkKICAgICAgKS5hcHBlbmRUbyggZG9jLmRvY3VtZW50RWxlbWVudCApOwoKICAgICAgLy8gQWx3YXlzIHdyaXRlIGEgbmV3IEhUTUwgc2tlbGV0b24gc28gV2Via2l0IGFuZCBGaXJlZm94IGRvbid0IGNob2tlIG9uIHJldXNlCiAgICAgIGRvYyA9ICggaWZyYW1lWzBdLmNvbnRlbnRXaW5kb3cgfHwgaWZyYW1lWzBdLmNvbnRlbnREb2N1bWVudCApLmRvY3VtZW50OwogICAgICBkb2Mud3JpdGUoIjwhZG9jdHlwZSBodG1sPjxodG1sPjxib2R5PiIpOwogICAgICBkb2MuY2xvc2UoKTsKCiAgICAgIGRpc3BsYXkgPSBhY3R1YWxEaXNwbGF5KCBub2RlTmFtZSwgZG9jICk7CiAgICAgIGlmcmFtZS5kZXRhY2goKTsKICAgIH0KCiAgICAvLyBTdG9yZSB0aGUgY29ycmVjdCBkZWZhdWx0IGRpc3BsYXkKICAgIGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdID0gZGlzcGxheTsKICB9CgogIHJldHVybiBkaXNwbGF5Owp9CgovLyBDYWxsZWQgT05MWSBmcm9tIHdpdGhpbiBjc3NfZGVmYXVsdERpc3BsYXkKZnVuY3Rpb24gYWN0dWFsRGlzcGxheSggbmFtZSwgZG9jICkgewogIHZhciBlbGVtID0galF1ZXJ5KCBkb2MuY3JlYXRlRWxlbWVudCggbmFtZSApICkuYXBwZW5kVG8oIGRvYy5ib2R5ICksCiAgICBkaXNwbGF5ID0galF1ZXJ5LmNzcyggZWxlbVswXSwgImRpc3BsYXkiICk7CiAgZWxlbS5yZW1vdmUoKTsKICByZXR1cm4gZGlzcGxheTsKfQoKalF1ZXJ5LmVhY2goWyAiaGVpZ2h0IiwgIndpZHRoIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKICBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSA9IHsKICAgIGdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkLCBleHRyYSApIHsKICAgICAgaWYgKCBjb21wdXRlZCApIHsKICAgICAgICAvLyBjZXJ0YWluIGVsZW1lbnRzIGNhbiBoYXZlIGRpbWVuc2lvbiBpbmZvIGlmIHdlIGludmlzaWJseSBzaG93IHRoZW0KICAgICAgICAvLyBob3dldmVyLCBpdCBtdXN0IGhhdmUgYSBjdXJyZW50IGRpc3BsYXkgc3R5bGUgdGhhdCB3b3VsZCBiZW5lZml0IGZyb20gdGhpcwogICAgICAgIHJldHVybiBlbGVtLm9mZnNldFdpZHRoID09PSAwICYmIHJkaXNwbGF5c3dhcC50ZXN0KCBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSApID8KICAgICAgICAgIGpRdWVyeS5zd2FwKCBlbGVtLCBjc3NTaG93LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICk7CiAgICAgICAgICB9KSA6CiAgICAgICAgICBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApOwogICAgICB9CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBleHRyYSApIHsKICAgICAgdmFyIHN0eWxlcyA9IGV4dHJhICYmIGdldFN0eWxlcyggZWxlbSApOwogICAgICByZXR1cm4gc2V0UG9zaXRpdmVOdW1iZXIoIGVsZW0sIHZhbHVlLCBleHRyYSA/CiAgICAgICAgYXVnbWVudFdpZHRoT3JIZWlnaHQoCiAgICAgICAgICBlbGVtLAogICAgICAgICAgbmFtZSwKICAgICAgICAgIGV4dHJhLAogICAgICAgICAgalF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwKICAgICAgICAgIHN0eWxlcwogICAgICAgICkgOiAwCiAgICAgICk7CiAgICB9CiAgfTsKfSk7CgppZiAoICFqUXVlcnkuc3VwcG9ydC5vcGFjaXR5ICkgewogIGpRdWVyeS5jc3NIb29rcy5vcGFjaXR5ID0gewogICAgZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7CiAgICAgIC8vIElFIHVzZXMgZmlsdGVycyBmb3Igb3BhY2l0eQogICAgICByZXR1cm4gcm9wYWNpdHkudGVzdCggKGNvbXB1dGVkICYmIGVsZW0uY3VycmVudFN0eWxlID8gZWxlbS5jdXJyZW50U3R5bGUuZmlsdGVyIDogZWxlbS5zdHlsZS5maWx0ZXIpIHx8ICIiICkgPwogICAgICAgICggMC4wMSAqIHBhcnNlRmxvYXQoIFJlZ0V4cC4kMSApICkgKyAiIiA6CiAgICAgICAgY29tcHV0ZWQgPyAiMSIgOiAiIjsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CiAgICAgIHZhciBzdHlsZSA9IGVsZW0uc3R5bGUsCiAgICAgICAgY3VycmVudFN0eWxlID0gZWxlbS5jdXJyZW50U3R5bGUsCiAgICAgICAgb3BhY2l0eSA9IGpRdWVyeS5pc051bWVyaWMoIHZhbHVlICkgPyAiYWxwaGEob3BhY2l0eT0iICsgdmFsdWUgKiAxMDAgKyAiKSIgOiAiIiwKICAgICAgICBmaWx0ZXIgPSBjdXJyZW50U3R5bGUgJiYgY3VycmVudFN0eWxlLmZpbHRlciB8fCBzdHlsZS5maWx0ZXIgfHwgIiI7CgogICAgICAvLyBJRSBoYXMgdHJvdWJsZSB3aXRoIG9wYWNpdHkgaWYgaXQgZG9lcyBub3QgaGF2ZSBsYXlvdXQKICAgICAgLy8gRm9yY2UgaXQgYnkgc2V0dGluZyB0aGUgem9vbSBsZXZlbAogICAgICBzdHlsZS56b29tID0gMTsKCiAgICAgIC8vIGlmIHNldHRpbmcgb3BhY2l0eSB0byAxLCBhbmQgbm8gb3RoZXIgZmlsdGVycyBleGlzdCAtIGF0dGVtcHQgdG8gcmVtb3ZlIGZpbHRlciBhdHRyaWJ1dGUgIzY2NTIKICAgICAgLy8gaWYgdmFsdWUgPT09ICIiLCB0aGVuIHJlbW92ZSBpbmxpbmUgb3BhY2l0eSAjMTI2ODUKICAgICAgaWYgKCAoIHZhbHVlID49IDEgfHwgdmFsdWUgPT09ICIiICkgJiYKICAgICAgICAgIGpRdWVyeS50cmltKCBmaWx0ZXIucmVwbGFjZSggcmFscGhhLCAiIiApICkgPT09ICIiICYmCiAgICAgICAgICBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUgKSB7CgogICAgICAgIC8vIFNldHRpbmcgc3R5bGUuZmlsdGVyIHRvIG51bGwsICIiICYgIiAiIHN0aWxsIGxlYXZlICJmaWx0ZXI6IiBpbiB0aGUgY3NzVGV4dAogICAgICAgIC8vIGlmICJmaWx0ZXI6IiBpcyBwcmVzZW50IGF0IGFsbCwgY2xlYXJUeXBlIGlzIGRpc2FibGVkLCB3ZSB3YW50IHRvIGF2b2lkIHRoaXMKICAgICAgICAvLyBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUgaXMgSUUgT25seSwgYnV0IHNvIGFwcGFyZW50bHkgaXMgdGhpcyBjb2RlIHBhdGguLi4KICAgICAgICBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUoICJmaWx0ZXIiICk7CgogICAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIGZpbHRlciBzdHlsZSBhcHBsaWVkIGluIGEgY3NzIHJ1bGUgb3IgdW5zZXQgaW5saW5lIG9wYWNpdHksIHdlIGFyZSBkb25lCiAgICAgICAgaWYgKCB2YWx1ZSA9PT0gIiIgfHwgY3VycmVudFN0eWxlICYmICFjdXJyZW50U3R5bGUuZmlsdGVyICkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gb3RoZXJ3aXNlLCBzZXQgbmV3IGZpbHRlciB2YWx1ZXMKICAgICAgc3R5bGUuZmlsdGVyID0gcmFscGhhLnRlc3QoIGZpbHRlciApID8KICAgICAgICBmaWx0ZXIucmVwbGFjZSggcmFscGhhLCBvcGFjaXR5ICkgOgogICAgICAgIGZpbHRlciArICIgIiArIG9wYWNpdHk7CiAgICB9CiAgfTsKfQoKLy8gVGhlc2UgaG9va3MgY2Fubm90IGJlIGFkZGVkIHVudGlsIERPTSByZWFkeSBiZWNhdXNlIHRoZSBzdXBwb3J0IHRlc3QKLy8gZm9yIGl0IGlzIG5vdCBydW4gdW50aWwgYWZ0ZXIgRE9NIHJlYWR5CmpRdWVyeShmdW5jdGlvbigpIHsKICBpZiAoICFqUXVlcnkuc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ICkgewogICAgalF1ZXJ5LmNzc0hvb2tzLm1hcmdpblJpZ2h0ID0gewogICAgICBnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKICAgICAgICBpZiAoIGNvbXB1dGVkICkgewogICAgICAgICAgLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CiAgICAgICAgICAvLyBXb3JrIGFyb3VuZCBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIGVsZW1lbnQgZGlzcGxheSB0byBpbmxpbmUtYmxvY2sKICAgICAgICAgIHJldHVybiBqUXVlcnkuc3dhcCggZWxlbSwgeyAiZGlzcGxheSI6ICJpbmxpbmUtYmxvY2siIH0sCiAgICAgICAgICAgIGN1ckNTUywgWyBlbGVtLCAibWFyZ2luUmlnaHQiIF0gKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQoKICAvLyBXZWJraXQgYnVnOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MjkwODQKICAvLyBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgcGVyY2VudCB3aGVuIHNwZWNpZmllZCBmb3IgdG9wL2xlZnQvYm90dG9tL3JpZ2h0CiAgLy8gcmF0aGVyIHRoYW4gbWFrZSB0aGUgY3NzIG1vZHVsZSBkZXBlbmQgb24gdGhlIG9mZnNldCBtb2R1bGUsIHdlIGp1c3QgY2hlY2sgZm9yIGl0IGhlcmUKICBpZiAoICFqUXVlcnkuc3VwcG9ydC5waXhlbFBvc2l0aW9uICYmIGpRdWVyeS5mbi5wb3NpdGlvbiApIHsKICAgIGpRdWVyeS5lYWNoKCBbICJ0b3AiLCAibGVmdCIgXSwgZnVuY3Rpb24oIGksIHByb3AgKSB7CiAgICAgIGpRdWVyeS5jc3NIb29rc1sgcHJvcCBdID0gewogICAgICAgIGdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewogICAgICAgICAgaWYgKCBjb21wdXRlZCApIHsKICAgICAgICAgICAgY29tcHV0ZWQgPSBjdXJDU1MoIGVsZW0sIHByb3AgKTsKICAgICAgICAgICAgLy8gaWYgY3VyQ1NTIHJldHVybnMgcGVyY2VudGFnZSwgZmFsbGJhY2sgdG8gb2Zmc2V0CiAgICAgICAgICAgIHJldHVybiBybnVtbm9ucHgudGVzdCggY29tcHV0ZWQgKSA/CiAgICAgICAgICAgICAgalF1ZXJ5KCBlbGVtICkucG9zaXRpb24oKVsgcHJvcCBdICsgInB4IiA6CiAgICAgICAgICAgICAgY29tcHV0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfSk7CiAgfQoKfSk7CgppZiAoIGpRdWVyeS5leHByICYmIGpRdWVyeS5leHByLmZpbHRlcnMgKSB7CiAgalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKICAgIHJldHVybiAoIGVsZW0ub2Zmc2V0V2lkdGggPT09IDAgJiYgZWxlbS5vZmZzZXRIZWlnaHQgPT09IDAgKSB8fCAoIWpRdWVyeS5zdXBwb3J0LnJlbGlhYmxlSGlkZGVuT2Zmc2V0cyAmJiAoKGVsZW0uc3R5bGUgJiYgZWxlbS5zdHlsZS5kaXNwbGF5KSB8fCBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSkgPT09ICJub25lIik7CiAgfTsKCiAgalF1ZXJ5LmV4cHIuZmlsdGVycy52aXNpYmxlID0gZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gIWpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuKCBlbGVtICk7CiAgfTsKfQoKLy8gVGhlc2UgaG9va3MgYXJlIHVzZWQgYnkgYW5pbWF0ZSB0byBleHBhbmQgcHJvcGVydGllcwpqUXVlcnkuZWFjaCh7CiAgbWFyZ2luOiAiIiwKICBwYWRkaW5nOiAiIiwKICBib3JkZXI6ICJXaWR0aCIKfSwgZnVuY3Rpb24oIHByZWZpeCwgc3VmZml4ICkgewogIGpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0gPSB7CiAgICBleHBhbmQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKICAgICAgdmFyIGkgPSAwLAogICAgICAgIGV4cGFuZGVkID0ge30sCgogICAgICAgIC8vIGFzc3VtZXMgYSBzaW5nbGUgbnVtYmVyIGlmIG5vdCBhIHN0cmluZwogICAgICAgIHBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIgIikgOiBbIHZhbHVlIF07CgogICAgICBmb3IgKCA7IGkgPCA0OyBpKysgKSB7CiAgICAgICAgZXhwYW5kZWRbIHByZWZpeCArIGNzc0V4cGFuZFsgaSBdICsgc3VmZml4IF0gPQogICAgICAgICAgcGFydHNbIGkgXSB8fCBwYXJ0c1sgaSAtIDIgXSB8fCBwYXJ0c1sgMCBdOwogICAgICB9CgogICAgICByZXR1cm4gZXhwYW5kZWQ7CiAgICB9CiAgfTsKCiAgaWYgKCAhcm1hcmdpbi50ZXN0KCBwcmVmaXggKSApIHsKICAgIGpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0uc2V0ID0gc2V0UG9zaXRpdmVOdW1iZXI7CiAgfQp9KTsKdmFyIHIyMCA9IC8lMjAvZywKICByYnJhY2tldCA9IC9cW1xdJC8sCiAgckNSTEYgPSAvXHI/XG4vZywKICByc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXQpJC9pLAogIHJzdWJtaXR0YWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGtleWdlbikvaTsKCmpRdWVyeS5mbi5leHRlbmQoewogIHNlcmlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4galF1ZXJ5LnBhcmFtKCB0aGlzLnNlcmlhbGl6ZUFycmF5KCkgKTsKICB9LAogIHNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpewogICAgICAvLyBDYW4gYWRkIHByb3BIb29rIGZvciAiZWxlbWVudHMiIHRvIGZpbHRlciBvciBhZGQgZm9ybSBlbGVtZW50cwogICAgICB2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCggdGhpcywgImVsZW1lbnRzIiApOwogICAgICByZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KCBlbGVtZW50cyApIDogdGhpczsKICAgIH0pCiAgICAuZmlsdGVyKGZ1bmN0aW9uKCl7CiAgICAgIHZhciB0eXBlID0gdGhpcy50eXBlOwogICAgICAvLyBVc2UgLmlzKCI6ZGlzYWJsZWQiKSBzbyB0aGF0IGZpZWxkc2V0W2Rpc2FibGVkXSB3b3JrcwogICAgICByZXR1cm4gdGhpcy5uYW1lICYmICFqUXVlcnkoIHRoaXMgKS5pcyggIjpkaXNhYmxlZCIgKSAmJgogICAgICAgIHJzdWJtaXR0YWJsZS50ZXN0KCB0aGlzLm5vZGVOYW1lICkgJiYgIXJzdWJtaXR0ZXJUeXBlcy50ZXN0KCB0eXBlICkgJiYKICAgICAgICAoIHRoaXMuY2hlY2tlZCB8fCAhbWFuaXB1bGF0aW9uX3JjaGVja2FibGVUeXBlLnRlc3QoIHR5cGUgKSApOwogICAgfSkKICAgIC5tYXAoZnVuY3Rpb24oIGksIGVsZW0gKXsKICAgICAgdmFyIHZhbCA9IGpRdWVyeSggdGhpcyApLnZhbCgpOwoKICAgICAgcmV0dXJuIHZhbCA9PSBudWxsID8KICAgICAgICBudWxsIDoKICAgICAgICBqUXVlcnkuaXNBcnJheSggdmFsICkgPwogICAgICAgICAgalF1ZXJ5Lm1hcCggdmFsLCBmdW5jdGlvbiggdmFsICl7CiAgICAgICAgICAgIHJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsKICAgICAgICAgIH0pIDoKICAgICAgICAgIHsgbmFtZTogZWxlbS5uYW1lLCB2YWx1ZTogdmFsLnJlcGxhY2UoIHJDUkxGLCAiXHJcbiIgKSB9OwogICAgfSkuZ2V0KCk7CiAgfQp9KTsKCi8vU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKLy9rZXkvdmFsdWVzIGludG8gYSBxdWVyeSBzdHJpbmcKalF1ZXJ5LnBhcmFtID0gZnVuY3Rpb24oIGEsIHRyYWRpdGlvbmFsICkgewogIHZhciBwcmVmaXgsCiAgICBzID0gW10sCiAgICBhZGQgPSBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKICAgICAgLy8gSWYgdmFsdWUgaXMgYSBmdW5jdGlvbiwgaW52b2tlIGl0IGFuZCByZXR1cm4gaXRzIHZhbHVlCiAgICAgIHZhbHVlID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgPyB2YWx1ZSgpIDogKCB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSApOwogICAgICBzWyBzLmxlbmd0aCBdID0gZW5jb2RlVVJJQ29tcG9uZW50KCBrZXkgKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCggdmFsdWUgKTsKICAgIH07CgogIC8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuCiAgaWYgKCB0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkICkgewogICAgdHJhZGl0aW9uYWwgPSBqUXVlcnkuYWpheFNldHRpbmdzICYmIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWw7CiAgfQoKICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogIGlmICggalF1ZXJ5LmlzQXJyYXkoIGEgKSB8fCAoIGEuanF1ZXJ5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdCggYSApICkgKSB7CiAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgIGpRdWVyeS5lYWNoKCBhLCBmdW5jdGlvbigpIHsKICAgICAgYWRkKCB0aGlzLm5hbWUsIHRoaXMudmFsdWUgKTsKICAgIH0pOwoKICB9IGVsc2UgewogICAgLy8gSWYgdHJhZGl0aW9uYWwsIGVuY29kZSB0aGUgIm9sZCIgd2F5ICh0aGUgd2F5IDEuMy4yIG9yIG9sZGVyCiAgICAvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KICAgIGZvciAoIHByZWZpeCBpbiBhICkgewogICAgICBidWlsZFBhcmFtcyggcHJlZml4LCBhWyBwcmVmaXggXSwgdHJhZGl0aW9uYWwsIGFkZCApOwogICAgfQogIH0KCiAgLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgogIHJldHVybiBzLmpvaW4oICImIiApLnJlcGxhY2UoIHIyMCwgIisiICk7Cn07CgpmdW5jdGlvbiBidWlsZFBhcmFtcyggcHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQgKSB7CiAgdmFyIG5hbWU7CgogIGlmICggalF1ZXJ5LmlzQXJyYXkoIG9iaiApICkgewogICAgLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCiAgICBqUXVlcnkuZWFjaCggb2JqLCBmdW5jdGlvbiggaSwgdiApIHsKICAgICAgaWYgKCB0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KCBwcmVmaXggKSApIHsKICAgICAgICAvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCiAgICAgICAgYWRkKCBwcmVmaXgsIHYgKTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzIG51bWVyaWMgaW5kZXguCiAgICAgICAgYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArICggdHlwZW9mIHYgPT09ICJvYmplY3QiID8gaSA6ICIiICkgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQgKTsKICAgICAgfQogICAgfSk7CgogIH0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZSggb2JqICkgPT09ICJvYmplY3QiICkgewogICAgLy8gU2VyaWFsaXplIG9iamVjdCBpdGVtLgogICAgZm9yICggbmFtZSBpbiBvYmogKSB7CiAgICAgIGJ1aWxkUGFyYW1zKCBwcmVmaXggKyAiWyIgKyBuYW1lICsgIl0iLCBvYmpbIG5hbWUgXSwgdHJhZGl0aW9uYWwsIGFkZCApOwogICAgfQoKICB9IGVsc2UgewogICAgLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgogICAgYWRkKCBwcmVmaXgsIG9iaiApOwogIH0KfQp2YXIKICAvLyBEb2N1bWVudCBsb2NhdGlvbgogIGFqYXhMb2NQYXJ0cywKICBhamF4TG9jYXRpb24sCiAgCiAgYWpheF9ub25jZSA9IGpRdWVyeS5ub3coKSwKCiAgYWpheF9ycXVlcnkgPSAvXD8vLAogIHJoYXNoID0gLyMuKiQvLAogIHJ0cyA9IC8oWz8mXSlfPVteJl0qLywKICByaGVhZGVycyA9IC9eKC4qPyk6WyBcdF0qKFteXHJcbl0qKVxyPyQvbWcsIC8vIElFIGxlYXZlcyBhbiBcciBjaGFyYWN0ZXIgYXQgRU9MCiAgLy8gIzc2NTMsICM4MTI1LCAjODE1MjogbG9jYWwgcHJvdG9jb2wgZGV0ZWN0aW9uCiAgcmxvY2FsUHJvdG9jb2wgPSAvXig/OmFib3V0fGFwcHxhcHAtc3RvcmFnZXwuKy1leHRlbnNpb258ZmlsZXxyZXN8d2lkZ2V0KTokLywKICBybm9Db250ZW50ID0gL14oPzpHRVR8SEVBRCkkLywKICBycHJvdG9jb2wgPSAvXlwvXC8vLAogIHJ1cmwgPSAvXihbXHcuKy1dKzopKD86XC9cLyhbXlwvPyM6XSopKD86OihcZCspfCl8KS8sCgogIC8vIEtlZXAgYSBjb3B5IG9mIHRoZSBvbGQgbG9hZCBtZXRob2QKICBfbG9hZCA9IGpRdWVyeS5mbi5sb2FkLAoKICAvKiBQcmVmaWx0ZXJzCiAgICogMSkgVGhleSBhcmUgdXNlZnVsIHRvIGludHJvZHVjZSBjdXN0b20gZGF0YVR5cGVzIChzZWUgYWpheC9qc29ucC5qcyBmb3IgYW4gZXhhbXBsZSkKICAgKiAyKSBUaGVzZSBhcmUgY2FsbGVkOgogICAqICAgIC0gQkVGT1JFIGFza2luZyBmb3IgYSB0cmFuc3BvcnQKICAgKiAgICAtIEFGVEVSIHBhcmFtIHNlcmlhbGl6YXRpb24gKHMuZGF0YSBpcyBhIHN0cmluZyBpZiBzLnByb2Nlc3NEYXRhIGlzIHRydWUpCiAgICogMykga2V5IGlzIHRoZSBkYXRhVHlwZQogICAqIDQpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICogNSkgZXhlY3V0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gY29udGludWUgZG93biB0byAiKiIgaWYgbmVlZGVkCiAgICovCiAgcHJlZmlsdGVycyA9IHt9LAoKICAvKiBUcmFuc3BvcnRzIGJpbmRpbmdzCiAgICogMSkga2V5IGlzIHRoZSBkYXRhVHlwZQogICAqIDIpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZAogICAqLwogIHRyYW5zcG9ydHMgPSB7fSwKCiAgLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCiAgYWxsVHlwZXMgPSAiKi8iLmNvbmNhdCgiKiIpOwoKLy8gIzgxMzgsIElFIG1heSB0aHJvdyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKLy8gYSBmaWVsZCBmcm9tIHdpbmRvdy5sb2NhdGlvbiBpZiBkb2N1bWVudC5kb21haW4gaGFzIGJlZW4gc2V0CnRyeSB7CiAgYWpheExvY2F0aW9uID0gbG9jYXRpb24uaHJlZjsKfSBjYXRjaCggZSApIHsKICAvLyBVc2UgdGhlIGhyZWYgYXR0cmlidXRlIG9mIGFuIEEgZWxlbWVudAogIC8vIHNpbmNlIElFIHdpbGwgbW9kaWZ5IGl0IGdpdmVuIGRvY3VtZW50LmxvY2F0aW9uCiAgYWpheExvY2F0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CiAgYWpheExvY2F0aW9uLmhyZWYgPSAiIjsKICBhamF4TG9jYXRpb24gPSBhamF4TG9jYXRpb24uaHJlZjsKfQoKLy8gU2VnbWVudCBsb2NhdGlvbiBpbnRvIHBhcnRzCmFqYXhMb2NQYXJ0cyA9IHJ1cmwuZXhlYyggYWpheExvY2F0aW9uLnRvTG93ZXJDYXNlKCkgKSB8fCBbXTsKCi8vIEJhc2UgImNvbnN0cnVjdG9yIiBmb3IgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIgYW5kIGpRdWVyeS5hamF4VHJhbnNwb3J0CmZ1bmN0aW9uIGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlICkgewoKICAvLyBkYXRhVHlwZUV4cHJlc3Npb24gaXMgb3B0aW9uYWwgYW5kIGRlZmF1bHRzIHRvICIqIgogIHJldHVybiBmdW5jdGlvbiggZGF0YVR5cGVFeHByZXNzaW9uLCBmdW5jICkgewoKICAgIGlmICggdHlwZW9mIGRhdGFUeXBlRXhwcmVzc2lvbiAhPT0gInN0cmluZyIgKSB7CiAgICAgIGZ1bmMgPSBkYXRhVHlwZUV4cHJlc3Npb247CiAgICAgIGRhdGFUeXBlRXhwcmVzc2lvbiA9ICIqIjsKICAgIH0KCiAgICB2YXIgZGF0YVR5cGUsCiAgICAgIGkgPSAwLAogICAgICBkYXRhVHlwZXMgPSBkYXRhVHlwZUV4cHJlc3Npb24udG9Mb3dlckNhc2UoKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbXTsKCiAgICBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBmdW5jICkgKSB7CiAgICAgIC8vIEZvciBlYWNoIGRhdGFUeXBlIGluIHRoZSBkYXRhVHlwZUV4cHJlc3Npb24KICAgICAgd2hpbGUgKCAoZGF0YVR5cGUgPSBkYXRhVHlwZXNbaSsrXSkgKSB7CiAgICAgICAgLy8gUHJlcGVuZCBpZiByZXF1ZXN0ZWQKICAgICAgICBpZiAoIGRhdGFUeXBlWzBdID09PSAiKyIgKSB7CiAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlLnNsaWNlKCAxICkgfHwgIioiOwogICAgICAgICAgKHN0cnVjdHVyZVsgZGF0YVR5cGUgXSA9IHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXSkudW5zaGlmdCggZnVuYyApOwoKICAgICAgICAvLyBPdGhlcndpc2UgYXBwZW5kCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIChzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10pLnB1c2goIGZ1bmMgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Owp9CgovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMKZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApIHsKCiAgdmFyIGluc3BlY3RlZCA9IHt9LAogICAgc2Vla2luZ1RyYW5zcG9ydCA9ICggc3RydWN0dXJlID09PSB0cmFuc3BvcnRzICk7CgogIGZ1bmN0aW9uIGluc3BlY3QoIGRhdGFUeXBlICkgewogICAgdmFyIHNlbGVjdGVkOwogICAgaW5zcGVjdGVkWyBkYXRhVHlwZSBdID0gdHJ1ZTsKICAgIGpRdWVyeS5lYWNoKCBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10sIGZ1bmN0aW9uKCBfLCBwcmVmaWx0ZXJPckZhY3RvcnkgKSB7CiAgICAgIHZhciBkYXRhVHlwZU9yVHJhbnNwb3J0ID0gcHJlZmlsdGVyT3JGYWN0b3J5KCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSICk7CiAgICAgIGlmKCB0eXBlb2YgZGF0YVR5cGVPclRyYW5zcG9ydCA9PT0gInN0cmluZyIgJiYgIXNlZWtpbmdUcmFuc3BvcnQgJiYgIWluc3BlY3RlZFsgZGF0YVR5cGVPclRyYW5zcG9ydCBdICkgewogICAgICAgIG9wdGlvbnMuZGF0YVR5cGVzLnVuc2hpZnQoIGRhdGFUeXBlT3JUcmFuc3BvcnQgKTsKICAgICAgICBpbnNwZWN0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgaWYgKCBzZWVraW5nVHJhbnNwb3J0ICkgewogICAgICAgIHJldHVybiAhKCBzZWxlY3RlZCA9IGRhdGFUeXBlT3JUcmFuc3BvcnQgKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gc2VsZWN0ZWQ7CiAgfQoKICByZXR1cm4gaW5zcGVjdCggb3B0aW9ucy5kYXRhVHlwZXNbIDAgXSApIHx8ICFpbnNwZWN0ZWRbICIqIiBdICYmIGluc3BlY3QoICIqIiApOwp9CgovLyBBIHNwZWNpYWwgZXh0ZW5kIGZvciBhamF4IG9wdGlvbnMKLy8gdGhhdCB0YWtlcyAiZmxhdCIgb3B0aW9ucyAobm90IHRvIGJlIGRlZXAgZXh0ZW5kZWQpCi8vIEZpeGVzICM5ODg3CmZ1bmN0aW9uIGFqYXhFeHRlbmQoIHRhcmdldCwgc3JjICkgewogIHZhciBrZXksIGRlZXAsCiAgICBmbGF0T3B0aW9ucyA9IGpRdWVyeS5hamF4U2V0dGluZ3MuZmxhdE9wdGlvbnMgfHwge307CgogIGZvciAoIGtleSBpbiBzcmMgKSB7CiAgICBpZiAoIHNyY1sga2V5IF0gIT09IHVuZGVmaW5lZCApIHsKICAgICAgKCBmbGF0T3B0aW9uc1sga2V5IF0gPyB0YXJnZXQgOiAoIGRlZXAgfHwgKGRlZXAgPSB7fSkgKSApWyBrZXkgXSA9IHNyY1sga2V5IF07CiAgICB9CiAgfQogIGlmICggZGVlcCApIHsKICAgIGpRdWVyeS5leHRlbmQoIHRydWUsIHRhcmdldCwgZGVlcCApOwogIH0KCiAgcmV0dXJuIHRhcmdldDsKfQoKalF1ZXJ5LmZuLmxvYWQgPSBmdW5jdGlvbiggdXJsLCBwYXJhbXMsIGNhbGxiYWNrICkgewogIGlmICggdHlwZW9mIHVybCAhPT0gInN0cmluZyIgJiYgX2xvYWQgKSB7CiAgICByZXR1cm4gX2xvYWQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogIH0KCiAgdmFyIHNlbGVjdG9yLCB0eXBlLCByZXNwb25zZSwKICAgIHNlbGYgPSB0aGlzLAogICAgb2ZmID0gdXJsLmluZGV4T2YoIiAiKTsKCiAgaWYgKCBvZmYgPj0gMCApIHsKICAgIHNlbGVjdG9yID0gdXJsLnNsaWNlKCBvZmYsIHVybC5sZW5ndGggKTsKICAgIHVybCA9IHVybC5zbGljZSggMCwgb2ZmICk7CiAgfQoKICAvLyBJZiBpdCdzIGEgZnVuY3Rpb24KICBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwYXJhbXMgKSApIHsKCiAgICAvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawogICAgY2FsbGJhY2sgPSBwYXJhbXM7CiAgICBwYXJhbXMgPSB1bmRlZmluZWQ7CgogIC8vIE90aGVyd2lzZSwgYnVpbGQgYSBwYXJhbSBzdHJpbmcKICB9IGVsc2UgaWYgKCBwYXJhbXMgJiYgdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSB7CiAgICB0eXBlID0gIlBPU1QiOwogIH0KCiAgLy8gSWYgd2UgaGF2ZSBlbGVtZW50cyB0byBtb2RpZnksIG1ha2UgdGhlIHJlcXVlc3QKICBpZiAoIHNlbGYubGVuZ3RoID4gMCApIHsKICAgIGpRdWVyeS5hamF4KHsKICAgICAgdXJsOiB1cmwsCgogICAgICAvLyBpZiAidHlwZSIgdmFyaWFibGUgaXMgdW5kZWZpbmVkLCB0aGVuICJHRVQiIG1ldGhvZCB3aWxsIGJlIHVzZWQKICAgICAgdHlwZTogdHlwZSwKICAgICAgZGF0YVR5cGU6ICJodG1sIiwKICAgICAgZGF0YTogcGFyYW1zCiAgICB9KS5kb25lKGZ1bmN0aW9uKCByZXNwb25zZVRleHQgKSB7CgogICAgICAvLyBTYXZlIHJlc3BvbnNlIGZvciB1c2UgaW4gY29tcGxldGUgY2FsbGJhY2sKICAgICAgcmVzcG9uc2UgPSBhcmd1bWVudHM7CgogICAgICBzZWxmLmh0bWwoIHNlbGVjdG9yID8KCiAgICAgICAgLy8gSWYgYSBzZWxlY3RvciB3YXMgc3BlY2lmaWVkLCBsb2NhdGUgdGhlIHJpZ2h0IGVsZW1lbnRzIGluIGEgZHVtbXkgZGl2CiAgICAgICAgLy8gRXhjbHVkZSBzY3JpcHRzIHRvIGF2b2lkIElFICdQZXJtaXNzaW9uIERlbmllZCcgZXJyb3JzCiAgICAgICAgalF1ZXJ5KCI8ZGl2PiIpLmFwcGVuZCggalF1ZXJ5LnBhcnNlSFRNTCggcmVzcG9uc2VUZXh0ICkgKS5maW5kKCBzZWxlY3RvciApIDoKCiAgICAgICAgLy8gT3RoZXJ3aXNlIHVzZSB0aGUgZnVsbCByZXN1bHQKICAgICAgICByZXNwb25zZVRleHQgKTsKCiAgICB9KS5jb21wbGV0ZSggY2FsbGJhY2sgJiYgZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CiAgICAgIHNlbGYuZWFjaCggY2FsbGJhY2ssIHJlc3BvbnNlIHx8IFsganFYSFIucmVzcG9uc2VUZXh0LCBzdGF0dXMsIGpxWEhSIF0gKTsKICAgIH0pOwogIH0KCiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBdHRhY2ggYSBidW5jaCBvZiBmdW5jdGlvbnMgZm9yIGhhbmRsaW5nIGNvbW1vbiBBSkFYIGV2ZW50cwpqUXVlcnkuZWFjaCggWyAiYWpheFN0YXJ0IiwgImFqYXhTdG9wIiwgImFqYXhDb21wbGV0ZSIsICJhamF4RXJyb3IiLCAiYWpheFN1Y2Nlc3MiLCAiYWpheFNlbmQiIF0sIGZ1bmN0aW9uKCBpLCB0eXBlICl7CiAgalF1ZXJ5LmZuWyB0eXBlIF0gPSBmdW5jdGlvbiggZm4gKXsKICAgIHJldHVybiB0aGlzLm9uKCB0eXBlLCBmbiApOwogIH07Cn0pOwoKalF1ZXJ5LmVhY2goIFsgImdldCIsICJwb3N0IiBdLCBmdW5jdGlvbiggaSwgbWV0aG9kICkgewogIGpRdWVyeVsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKICAgIC8vIHNoaWZ0IGFyZ3VtZW50cyBpZiBkYXRhIGFyZ3VtZW50IHdhcyBvbWl0dGVkCiAgICBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CiAgICAgIHR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwogICAgICBjYWxsYmFjayA9IGRhdGE7CiAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgcmV0dXJuIGpRdWVyeS5hamF4KHsKICAgICAgdXJsOiB1cmwsCiAgICAgIHR5cGU6IG1ldGhvZCwKICAgICAgZGF0YVR5cGU6IHR5cGUsCiAgICAgIGRhdGE6IGRhdGEsCiAgICAgIHN1Y2Nlc3M6IGNhbGxiYWNrCiAgICB9KTsKICB9Owp9KTsKCmpRdWVyeS5leHRlbmQoewoKICAvLyBDb3VudGVyIGZvciBob2xkaW5nIHRoZSBudW1iZXIgb2YgYWN0aXZlIHF1ZXJpZXMKICBhY3RpdmU6IDAsCgogIC8vIExhc3QtTW9kaWZpZWQgaGVhZGVyIGNhY2hlIGZvciBuZXh0IHJlcXVlc3QKICBsYXN0TW9kaWZpZWQ6IHt9LAogIGV0YWc6IHt9LAoKICBhamF4U2V0dGluZ3M6IHsKICAgIHVybDogYWpheExvY2F0aW9uLAogICAgdHlwZTogIkdFVCIsCiAgICBpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KCBhamF4TG9jUGFydHNbIDEgXSApLAogICAgZ2xvYmFsOiB0cnVlLAogICAgcHJvY2Vzc0RhdGE6IHRydWUsCiAgICBhc3luYzogdHJ1ZSwKICAgIGNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04IiwKICAgIC8qCiAgICB0aW1lb3V0OiAwLAogICAgZGF0YTogbnVsbCwKICAgIGRhdGFUeXBlOiBudWxsLAogICAgdXNlcm5hbWU6IG51bGwsCiAgICBwYXNzd29yZDogbnVsbCwKICAgIGNhY2hlOiBudWxsLAogICAgdGhyb3dzOiBmYWxzZSwKICAgIHRyYWRpdGlvbmFsOiBmYWxzZSwKICAgIGhlYWRlcnM6IHt9LAogICAgKi8KCiAgICBhY2NlcHRzOiB7CiAgICAgICIqIjogYWxsVHlwZXMsCiAgICAgIHRleHQ6ICJ0ZXh0L3BsYWluIiwKICAgICAgaHRtbDogInRleHQvaHRtbCIsCiAgICAgIHhtbDogImFwcGxpY2F0aW9uL3htbCwgdGV4dC94bWwiLAogICAgICBqc29uOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0IgogICAgfSwKCiAgICBjb250ZW50czogewogICAgICB4bWw6IC94bWwvLAogICAgICBodG1sOiAvaHRtbC8sCiAgICAgIGpzb246IC9qc29uLwogICAgfSwKCiAgICByZXNwb25zZUZpZWxkczogewogICAgICB4bWw6ICJyZXNwb25zZVhNTCIsCiAgICAgIHRleHQ6ICJyZXNwb25zZVRleHQiCiAgICB9LAoKICAgIC8vIERhdGEgY29udmVydGVycwogICAgLy8gS2V5cyBzZXBhcmF0ZSBzb3VyY2UgKG9yIGNhdGNoYWxsICIqIikgYW5kIGRlc3RpbmF0aW9uIHR5cGVzIHdpdGggYSBzaW5nbGUgc3BhY2UKICAgIGNvbnZlcnRlcnM6IHsKCiAgICAgIC8vIENvbnZlcnQgYW55dGhpbmcgdG8gdGV4dAogICAgICAiKiB0ZXh0Ijogd2luZG93LlN0cmluZywKCiAgICAgIC8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQogICAgICAidGV4dCBodG1sIjogdHJ1ZSwKCiAgICAgIC8vIEV2YWx1YXRlIHRleHQgYXMgYSBqc29uIGV4cHJlc3Npb24KICAgICAgInRleHQganNvbiI6IGpRdWVyeS5wYXJzZUpTT04sCgogICAgICAvLyBQYXJzZSB0ZXh0IGFzIHhtbAogICAgICAidGV4dCB4bWwiOiBqUXVlcnkucGFyc2VYTUwKICAgIH0sCgogICAgLy8gRm9yIG9wdGlvbnMgdGhhdCBzaG91bGRuJ3QgYmUgZGVlcCBleHRlbmRlZDoKICAgIC8vIHlvdSBjYW4gYWRkIHlvdXIgb3duIGN1c3RvbSBvcHRpb25zIGhlcmUgaWYKICAgIC8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCiAgICAvLyBkZWVwIGV4dGVuZGVkIChzZWUgYWpheEV4dGVuZCkKICAgIGZsYXRPcHRpb25zOiB7CiAgICAgIHVybDogdHJ1ZSwKICAgICAgY29udGV4dDogdHJ1ZQogICAgfQogIH0sCgogIC8vIENyZWF0ZXMgYSBmdWxsIGZsZWRnZWQgc2V0dGluZ3Mgb2JqZWN0IGludG8gdGFyZ2V0CiAgLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgogIC8vIElmIHRhcmdldCBpcyBvbWl0dGVkLCB3cml0ZXMgaW50byBhamF4U2V0dGluZ3MuCiAgYWpheFNldHVwOiBmdW5jdGlvbiggdGFyZ2V0LCBzZXR0aW5ncyApIHsKICAgIHJldHVybiBzZXR0aW5ncyA/CgogICAgICAvLyBCdWlsZGluZyBhIHNldHRpbmdzIG9iamVjdAogICAgICBhamF4RXh0ZW5kKCBhamF4RXh0ZW5kKCB0YXJnZXQsIGpRdWVyeS5hamF4U2V0dGluZ3MgKSwgc2V0dGluZ3MgKSA6CgogICAgICAvLyBFeHRlbmRpbmcgYWpheFNldHRpbmdzCiAgICAgIGFqYXhFeHRlbmQoIGpRdWVyeS5hamF4U2V0dGluZ3MsIHRhcmdldCApOwogIH0sCgogIGFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycyApLAogIGFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cyApLAoKICAvLyBNYWluIG1ldGhvZAogIGFqYXg6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgogICAgLy8gSWYgdXJsIGlzIGFuIG9iamVjdCwgc2ltdWxhdGUgcHJlLTEuNSBzaWduYXR1cmUKICAgIGlmICggdHlwZW9mIHVybCA9PT0gIm9iamVjdCIgKSB7CiAgICAgIG9wdGlvbnMgPSB1cmw7CiAgICAgIHVybCA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICAvLyBGb3JjZSBvcHRpb25zIHRvIGJlIGFuIG9iamVjdAogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgdmFyIHRyYW5zcG9ydCwKICAgICAgLy8gVVJMIHdpdGhvdXQgYW50aS1jYWNoZSBwYXJhbQogICAgICBjYWNoZVVSTCwKICAgICAgLy8gUmVzcG9uc2UgaGVhZGVycwogICAgICByZXNwb25zZUhlYWRlcnNTdHJpbmcsCiAgICAgIHJlc3BvbnNlSGVhZGVycywKICAgICAgLy8gdGltZW91dCBoYW5kbGUKICAgICAgdGltZW91dFRpbWVyLAogICAgICAvLyBDcm9zcy1kb21haW4gZGV0ZWN0aW9uIHZhcnMKICAgICAgcGFydHMsCiAgICAgIC8vIFRvIGtub3cgaWYgZ2xvYmFsIGV2ZW50cyBhcmUgdG8gYmUgZGlzcGF0Y2hlZAogICAgICBmaXJlR2xvYmFscywKICAgICAgLy8gTG9vcCB2YXJpYWJsZQogICAgICBpLAogICAgICAvLyBDcmVhdGUgdGhlIGZpbmFsIG9wdGlvbnMgb2JqZWN0CiAgICAgIHMgPSBqUXVlcnkuYWpheFNldHVwKCB7fSwgb3B0aW9ucyApLAogICAgICAvLyBDYWxsYmFja3MgY29udGV4dAogICAgICBjYWxsYmFja0NvbnRleHQgPSBzLmNvbnRleHQgfHwgcywKICAgICAgLy8gQ29udGV4dCBmb3IgZ2xvYmFsIGV2ZW50cyBpcyBjYWxsYmFja0NvbnRleHQgaWYgaXQgaXMgYSBET00gbm9kZSBvciBqUXVlcnkgY29sbGVjdGlvbgogICAgICBnbG9iYWxFdmVudENvbnRleHQgPSBzLmNvbnRleHQgJiYgKCBjYWxsYmFja0NvbnRleHQubm9kZVR5cGUgfHwgY2FsbGJhY2tDb250ZXh0LmpxdWVyeSApID8KICAgICAgICBqUXVlcnkoIGNhbGxiYWNrQ29udGV4dCApIDoKICAgICAgICBqUXVlcnkuZXZlbnQsCiAgICAgIC8vIERlZmVycmVkcwogICAgICBkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLAogICAgICBjb21wbGV0ZURlZmVycmVkID0galF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwKICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgc3RhdHVzQ29kZSA9IHMuc3RhdHVzQ29kZSB8fCB7fSwKICAgICAgLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkKICAgICAgcmVxdWVzdEhlYWRlcnMgPSB7fSwKICAgICAgcmVxdWVzdEhlYWRlcnNOYW1lcyA9IHt9LAogICAgICAvLyBUaGUganFYSFIgc3RhdGUKICAgICAgc3RhdGUgPSAwLAogICAgICAvLyBEZWZhdWx0IGFib3J0IG1lc3NhZ2UKICAgICAgc3RyQWJvcnQgPSAiY2FuY2VsZWQiLAogICAgICAvLyBGYWtlIHhocgogICAgICBqcVhIUiA9IHsKICAgICAgICByZWFkeVN0YXRlOiAwLAoKICAgICAgICAvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCiAgICAgICAgZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uKCBrZXkgKSB7CiAgICAgICAgICB2YXIgbWF0Y2g7CiAgICAgICAgICBpZiAoIHN0YXRlID09PSAyICkgewogICAgICAgICAgICBpZiAoICFyZXNwb25zZUhlYWRlcnMgKSB7CiAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzID0ge307CiAgICAgICAgICAgICAgd2hpbGUgKCAobWF0Y2ggPSByaGVhZGVycy5leGVjKCByZXNwb25zZUhlYWRlcnNTdHJpbmcgKSkgKSB7CiAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnNbIG1hdGNoWzFdLnRvTG93ZXJDYXNlKCkgXSA9IG1hdGNoWyAyIF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hdGNoID0gcmVzcG9uc2VIZWFkZXJzWyBrZXkudG9Mb3dlckNhc2UoKSBdOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoID09IG51bGwgPyBudWxsIDogbWF0Y2g7CiAgICAgICAgfSwKCiAgICAgICAgLy8gUmF3IHN0cmluZwogICAgICAgIGdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gc3RhdGUgPT09IDIgPyByZXNwb25zZUhlYWRlcnNTdHJpbmcgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8vIENhY2hlcyB0aGUgaGVhZGVyCiAgICAgICAgc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewogICAgICAgICAgdmFyIGxuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYgKCAhc3RhdGUgKSB7CiAgICAgICAgICAgIG5hbWUgPSByZXF1ZXN0SGVhZGVyc05hbWVzWyBsbmFtZSBdID0gcmVxdWVzdEhlYWRlcnNOYW1lc1sgbG5hbWUgXSB8fCBuYW1lOwogICAgICAgICAgICByZXF1ZXN0SGVhZGVyc1sgbmFtZSBdID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAvLyBPdmVycmlkZXMgcmVzcG9uc2UgY29udGVudC10eXBlIGhlYWRlcgogICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IGZ1bmN0aW9uKCB0eXBlICkgewogICAgICAgICAgaWYgKCAhc3RhdGUgKSB7CiAgICAgICAgICAgIHMubWltZVR5cGUgPSB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICBzdGF0dXNDb2RlOiBmdW5jdGlvbiggbWFwICkgewogICAgICAgICAgdmFyIGNvZGU7CiAgICAgICAgICBpZiAoIG1hcCApIHsKICAgICAgICAgICAgaWYgKCBzdGF0ZSA8IDIgKSB7CiAgICAgICAgICAgICAgZm9yICggY29kZSBpbiBtYXAgKSB7CiAgICAgICAgICAgICAgICAvLyBMYXp5LWFkZCB0aGUgbmV3IGNhbGxiYWNrIGluIGEgd2F5IHRoYXQgcHJlc2VydmVzIG9sZCBvbmVzCiAgICAgICAgICAgICAgICBzdGF0dXNDb2RlWyBjb2RlIF0gPSBbIHN0YXR1c0NvZGVbIGNvZGUgXSwgbWFwWyBjb2RlIF0gXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gRXhlY3V0ZSB0aGUgYXBwcm9wcmlhdGUgY2FsbGJhY2tzCiAgICAgICAgICAgICAganFYSFIuYWx3YXlzKCBtYXBbIGpxWEhSLnN0YXR1cyBdICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8vIENhbmNlbCB0aGUgcmVxdWVzdAogICAgICAgIGFib3J0OiBmdW5jdGlvbiggc3RhdHVzVGV4dCApIHsKICAgICAgICAgIHZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0OwogICAgICAgICAgaWYgKCB0cmFuc3BvcnQgKSB7CiAgICAgICAgICAgIHRyYW5zcG9ydC5hYm9ydCggZmluYWxUZXh0ICk7CiAgICAgICAgICB9CiAgICAgICAgICBkb25lKCAwLCBmaW5hbFRleHQgKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgfTsKCiAgICAvLyBBdHRhY2ggZGVmZXJyZWRzCiAgICBkZWZlcnJlZC5wcm9taXNlKCBqcVhIUiApLmNvbXBsZXRlID0gY29tcGxldGVEZWZlcnJlZC5hZGQ7CiAgICBqcVhIUi5zdWNjZXNzID0ganFYSFIuZG9uZTsKICAgIGpxWEhSLmVycm9yID0ganFYSFIuZmFpbDsKCiAgICAvLyBSZW1vdmUgaGFzaCBjaGFyYWN0ZXIgKCM3NTMxOiBhbmQgc3RyaW5nIHByb21vdGlvbikKICAgIC8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKCM1ODY2OiBJRTcgaXNzdWUgd2l0aCBwcm90b2NvbC1sZXNzIHVybHMpCiAgICAvLyBIYW5kbGUgZmFsc3kgdXJsIGluIHRoZSBzZXR0aW5ncyBvYmplY3QgKCMxMDA5MzogY29uc2lzdGVuY3kgd2l0aCBvbGQgc2lnbmF0dXJlKQogICAgLy8gV2UgYWxzbyB1c2UgdGhlIHVybCBwYXJhbWV0ZXIgaWYgYXZhaWxhYmxlCiAgICBzLnVybCA9ICggKCB1cmwgfHwgcy51cmwgfHwgYWpheExvY2F0aW9uICkgKyAiIiApLnJlcGxhY2UoIHJoYXNoLCAiIiApLnJlcGxhY2UoIHJwcm90b2NvbCwgYWpheExvY1BhcnRzWyAxIF0gKyAiLy8iICk7CgogICAgLy8gQWxpYXMgbWV0aG9kIG9wdGlvbiB0byB0eXBlIGFzIHBlciB0aWNrZXQgIzEyMDA0CiAgICBzLnR5cGUgPSBvcHRpb25zLm1ldGhvZCB8fCBvcHRpb25zLnR5cGUgfHwgcy5tZXRob2QgfHwgcy50eXBlOwoKICAgIC8vIEV4dHJhY3QgZGF0YVR5cGVzIGxpc3QKICAgIHMuZGF0YVR5cGVzID0galF1ZXJ5LnRyaW0oIHMuZGF0YVR5cGUgfHwgIioiICkudG9Mb3dlckNhc2UoKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbIiJdOwoKICAgIC8vIEEgY3Jvc3MtZG9tYWluIHJlcXVlc3QgaXMgaW4gb3JkZXIgd2hlbiB3ZSBoYXZlIGEgcHJvdG9jb2w6aG9zdDpwb3J0IG1pc21hdGNoCiAgICBpZiAoIHMuY3Jvc3NEb21haW4gPT0gbnVsbCApIHsKICAgICAgcGFydHMgPSBydXJsLmV4ZWMoIHMudXJsLnRvTG93ZXJDYXNlKCkgKTsKICAgICAgcy5jcm9zc0RvbWFpbiA9ICEhKCBwYXJ0cyAmJgogICAgICAgICggcGFydHNbIDEgXSAhPT0gYWpheExvY1BhcnRzWyAxIF0gfHwgcGFydHNbIDIgXSAhPT0gYWpheExvY1BhcnRzWyAyIF0gfHwKICAgICAgICAgICggcGFydHNbIDMgXSB8fCAoIHBhcnRzWyAxIF0gPT09ICJodHRwOiIgPyA4MCA6IDQ0MyApICkgIT0KICAgICAgICAgICAgKCBhamF4TG9jUGFydHNbIDMgXSB8fCAoIGFqYXhMb2NQYXJ0c1sgMSBdID09PSAiaHR0cDoiID8gODAgOiA0NDMgKSApICkKICAgICAgKTsKICAgIH0KCiAgICAvLyBDb252ZXJ0IGRhdGEgaWYgbm90IGFscmVhZHkgYSBzdHJpbmcKICAgIGlmICggcy5kYXRhICYmIHMucHJvY2Vzc0RhdGEgJiYgdHlwZW9mIHMuZGF0YSAhPT0gInN0cmluZyIgKSB7CiAgICAgIHMuZGF0YSA9IGpRdWVyeS5wYXJhbSggcy5kYXRhLCBzLnRyYWRpdGlvbmFsICk7CiAgICB9CgogICAgLy8gQXBwbHkgcHJlZmlsdGVycwogICAgaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHByZWZpbHRlcnMsIHMsIG9wdGlvbnMsIGpxWEhSICk7CgogICAgLy8gSWYgcmVxdWVzdCB3YXMgYWJvcnRlZCBpbnNpZGUgYSBwcmVmaWx0ZXIsIHN0b3AgdGhlcmUKICAgIGlmICggc3RhdGUgPT09IDIgKSB7CiAgICAgIHJldHVybiBqcVhIUjsKICAgIH0KCiAgICAvLyBXZSBjYW4gZmlyZSBnbG9iYWwgZXZlbnRzIGFzIG9mIG5vdyBpZiBhc2tlZCB0bwogICAgZmlyZUdsb2JhbHMgPSBzLmdsb2JhbDsKCiAgICAvLyBXYXRjaCBmb3IgYSBuZXcgc2V0IG9mIHJlcXVlc3RzCiAgICBpZiAoIGZpcmVHbG9iYWxzICYmIGpRdWVyeS5hY3RpdmUrKyA9PT0gMCApIHsKICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoImFqYXhTdGFydCIpOwogICAgfQoKICAgIC8vIFVwcGVyY2FzZSB0aGUgdHlwZQogICAgcy50eXBlID0gcy50eXBlLnRvVXBwZXJDYXNlKCk7CgogICAgLy8gRGV0ZXJtaW5lIGlmIHJlcXVlc3QgaGFzIGNvbnRlbnQKICAgIHMuaGFzQ29udGVudCA9ICFybm9Db250ZW50LnRlc3QoIHMudHlwZSApOwoKICAgIC8vIFNhdmUgdGhlIFVSTCBpbiBjYXNlIHdlJ3JlIHRveWluZyB3aXRoIHRoZSBJZi1Nb2RpZmllZC1TaW5jZQogICAgLy8gYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyIGxhdGVyIG9uCiAgICBjYWNoZVVSTCA9IHMudXJsOwoKICAgIC8vIE1vcmUgb3B0aW9ucyBoYW5kbGluZyBmb3IgcmVxdWVzdHMgd2l0aCBubyBjb250ZW50CiAgICBpZiAoICFzLmhhc0NvbnRlbnQgKSB7CgogICAgICAvLyBJZiBkYXRhIGlzIGF2YWlsYWJsZSwgYXBwZW5kIGRhdGEgdG8gdXJsCiAgICAgIGlmICggcy5kYXRhICkgewogICAgICAgIGNhY2hlVVJMID0gKCBzLnVybCArPSAoIGFqYXhfcnF1ZXJ5LnRlc3QoIGNhY2hlVVJMICkgPyAiJiIgOiAiPyIgKSArIHMuZGF0YSApOwogICAgICAgIC8vICM5NjgyOiByZW1vdmUgZGF0YSBzbyB0aGF0IGl0J3Mgbm90IHVzZWQgaW4gYW4gZXZlbnR1YWwgcmV0cnkKICAgICAgICBkZWxldGUgcy5kYXRhOwogICAgICB9CgogICAgICAvLyBBZGQgYW50aS1jYWNoZSBpbiB1cmwgaWYgbmVlZGVkCiAgICAgIGlmICggcy5jYWNoZSA9PT0gZmFsc2UgKSB7CiAgICAgICAgcy51cmwgPSBydHMudGVzdCggY2FjaGVVUkwgKSA/CgogICAgICAgICAgLy8gSWYgdGhlcmUgaXMgYWxyZWFkeSBhICdfJyBwYXJhbWV0ZXIsIHNldCBpdHMgdmFsdWUKICAgICAgICAgIGNhY2hlVVJMLnJlcGxhY2UoIHJ0cywgIiQxXz0iICsgYWpheF9ub25jZSsrICkgOgoKICAgICAgICAgIC8vIE90aGVyd2lzZSBhZGQgb25lIHRvIHRoZSBlbmQKICAgICAgICAgIGNhY2hlVVJMICsgKCBhamF4X3JxdWVyeS50ZXN0KCBjYWNoZVVSTCApID8gIiYiIDogIj8iICkgKyAiXz0iICsgYWpheF9ub25jZSsrOwogICAgICB9CiAgICB9CgogICAgLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KICAgIGlmICggcy5pZk1vZGlmaWVkICkgewogICAgICBpZiAoIGpRdWVyeS5sYXN0TW9kaWZpZWRbIGNhY2hlVVJMIF0gKSB7CiAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU1vZGlmaWVkLVNpbmNlIiwgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSApOwogICAgICB9CiAgICAgIGlmICggalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gKSB7CiAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU5vbmUtTWF0Y2giLCBqUXVlcnkuZXRhZ1sgY2FjaGVVUkwgXSApOwogICAgICB9CiAgICB9CgogICAgLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CiAgICBpZiAoIHMuZGF0YSAmJiBzLmhhc0NvbnRlbnQgJiYgcy5jb250ZW50VHlwZSAhPT0gZmFsc2UgfHwgb3B0aW9ucy5jb250ZW50VHlwZSApIHsKICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlciggIkNvbnRlbnQtVHlwZSIsIHMuY29udGVudFR5cGUgKTsKICAgIH0KCiAgICAvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlCiAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKAogICAgICAiQWNjZXB0IiwKICAgICAgcy5kYXRhVHlwZXNbIDAgXSAmJiBzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWzBdIF0gPwogICAgICAgIHMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbMF0gXSArICggcy5kYXRhVHlwZXNbIDAgXSAhPT0gIioiID8gIiwgIiArIGFsbFR5cGVzICsgIjsgcT0wLjAxIiA6ICIiICkgOgogICAgICAgIHMuYWNjZXB0c1sgIioiIF0KICAgICk7CgogICAgLy8gQ2hlY2sgZm9yIGhlYWRlcnMgb3B0aW9uCiAgICBmb3IgKCBpIGluIHMuaGVhZGVycyApIHsKICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlciggaSwgcy5oZWFkZXJzWyBpIF0gKTsKICAgIH0KCiAgICAvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0CiAgICBpZiAoIHMuYmVmb3JlU2VuZCAmJiAoIHMuYmVmb3JlU2VuZC5jYWxsKCBjYWxsYmFja0NvbnRleHQsIGpxWEhSLCBzICkgPT09IGZhbHNlIHx8IHN0YXRlID09PSAyICkgKSB7CiAgICAgIC8vIEFib3J0IGlmIG5vdCBkb25lIGFscmVhZHkgYW5kIHJldHVybgogICAgICByZXR1cm4ganFYSFIuYWJvcnQoKTsKICAgIH0KCiAgICAvLyBhYm9ydGluZyBpcyBubyBsb25nZXIgYSBjYW5jZWxsYXRpb24KICAgIHN0ckFib3J0ID0gImFib3J0IjsKCiAgICAvLyBJbnN0YWxsIGNhbGxiYWNrcyBvbiBkZWZlcnJlZHMKICAgIGZvciAoIGkgaW4geyBzdWNjZXNzOiAxLCBlcnJvcjogMSwgY29tcGxldGU6IDEgfSApIHsKICAgICAganFYSFJbIGkgXSggc1sgaSBdICk7CiAgICB9CgogICAgLy8gR2V0IHRyYW5zcG9ydAogICAgdHJhbnNwb3J0ID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHRyYW5zcG9ydHMsIHMsIG9wdGlvbnMsIGpxWEhSICk7CgogICAgLy8gSWYgbm8gdHJhbnNwb3J0LCB3ZSBhdXRvLWFib3J0CiAgICBpZiAoICF0cmFuc3BvcnQgKSB7CiAgICAgIGRvbmUoIC0xLCAiTm8gVHJhbnNwb3J0IiApOwogICAgfSBlbHNlIHsKICAgICAganFYSFIucmVhZHlTdGF0ZSA9IDE7CgogICAgICAvLyBTZW5kIGdsb2JhbCBldmVudAogICAgICBpZiAoIGZpcmVHbG9iYWxzICkgewogICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheFNlbmQiLCBbIGpxWEhSLCBzIF0gKTsKICAgICAgfQogICAgICAvLyBUaW1lb3V0CiAgICAgIGlmICggcy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwICkgewogICAgICAgIHRpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBqcVhIUi5hYm9ydCgidGltZW91dCIpOwogICAgICAgIH0sIHMudGltZW91dCApOwogICAgICB9CgogICAgICB0cnkgewogICAgICAgIHN0YXRlID0gMTsKICAgICAgICB0cmFuc3BvcnQuc2VuZCggcmVxdWVzdEhlYWRlcnMsIGRvbmUgKTsKICAgICAgfSBjYXRjaCAoIGUgKSB7CiAgICAgICAgLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQogICAgICAgIGlmICggc3RhdGUgPCAyICkgewogICAgICAgICAgZG9uZSggLTEsIGUgKTsKICAgICAgICAvLyBTaW1wbHkgcmV0aHJvdyBvdGhlcndpc2UKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBDYWxsYmFjayBmb3Igd2hlbiBldmVyeXRoaW5nIGlzIGRvbmUKICAgIGZ1bmN0aW9uIGRvbmUoIHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzICkgewogICAgICB2YXIgaXNTdWNjZXNzLCBzdWNjZXNzLCBlcnJvciwgcmVzcG9uc2UsIG1vZGlmaWVkLAogICAgICAgIHN0YXR1c1RleHQgPSBuYXRpdmVTdGF0dXNUZXh0OwoKICAgICAgLy8gQ2FsbGVkIG9uY2UKICAgICAgaWYgKCBzdGF0ZSA9PT0gMiApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIFN0YXRlIGlzICJkb25lIiBub3cKICAgICAgc3RhdGUgPSAyOwoKICAgICAgLy8gQ2xlYXIgdGltZW91dCBpZiBpdCBleGlzdHMKICAgICAgaWYgKCB0aW1lb3V0VGltZXIgKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KCB0aW1lb3V0VGltZXIgKTsKICAgICAgfQoKICAgICAgLy8gRGVyZWZlcmVuY2UgdHJhbnNwb3J0IGZvciBlYXJseSBnYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkKICAgICAgdHJhbnNwb3J0ID0gdW5kZWZpbmVkOwoKICAgICAgLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycwogICAgICByZXNwb25zZUhlYWRlcnNTdHJpbmcgPSBoZWFkZXJzIHx8ICIiOwoKICAgICAgLy8gU2V0IHJlYWR5U3RhdGUKICAgICAganFYSFIucmVhZHlTdGF0ZSA9IHN0YXR1cyA+IDAgPyA0IDogMDsKCiAgICAgIC8vIEdldCByZXNwb25zZSBkYXRhCiAgICAgIGlmICggcmVzcG9uc2VzICkgewogICAgICAgIHJlc3BvbnNlID0gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApOwogICAgICB9CgogICAgICAvLyBJZiBzdWNjZXNzZnVsLCBoYW5kbGUgdHlwZSBjaGFpbmluZwogICAgICBpZiAoIHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0ICkgewoKICAgICAgICAvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgogICAgICAgIGlmICggcy5pZk1vZGlmaWVkICkgewogICAgICAgICAgbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiTGFzdC1Nb2RpZmllZCIpOwogICAgICAgICAgaWYgKCBtb2RpZmllZCApIHsKICAgICAgICAgICAgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSA9IG1vZGlmaWVkOwogICAgICAgICAgfQogICAgICAgICAgbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiZXRhZyIpOwogICAgICAgICAgaWYgKCBtb2RpZmllZCApIHsKICAgICAgICAgICAgalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gPSBtb2RpZmllZDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIElmIG5vdCBtb2RpZmllZAogICAgICAgIGlmICggc3RhdHVzID09PSAzMDQgKSB7CiAgICAgICAgICBpc1N1Y2Nlc3MgPSB0cnVlOwogICAgICAgICAgc3RhdHVzVGV4dCA9ICJub3Rtb2RpZmllZCI7CgogICAgICAgIC8vIElmIHdlIGhhdmUgZGF0YQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpc1N1Y2Nlc3MgPSBhamF4Q29udmVydCggcywgcmVzcG9uc2UgKTsKICAgICAgICAgIHN0YXR1c1RleHQgPSBpc1N1Y2Nlc3Muc3RhdGU7CiAgICAgICAgICBzdWNjZXNzID0gaXNTdWNjZXNzLmRhdGE7CiAgICAgICAgICBlcnJvciA9IGlzU3VjY2Vzcy5lcnJvcjsKICAgICAgICAgIGlzU3VjY2VzcyA9ICFlcnJvcjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gV2UgZXh0cmFjdCBlcnJvciBmcm9tIHN0YXR1c1RleHQKICAgICAgICAvLyB0aGVuIG5vcm1hbGl6ZSBzdGF0dXNUZXh0IGFuZCBzdGF0dXMgZm9yIG5vbi1hYm9ydHMKICAgICAgICBlcnJvciA9IHN0YXR1c1RleHQ7CiAgICAgICAgaWYgKCBzdGF0dXMgfHwgIXN0YXR1c1RleHQgKSB7CiAgICAgICAgICBzdGF0dXNUZXh0ID0gImVycm9yIjsKICAgICAgICAgIGlmICggc3RhdHVzIDwgMCApIHsKICAgICAgICAgICAgc3RhdHVzID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNldCBkYXRhIGZvciB0aGUgZmFrZSB4aHIgb2JqZWN0CiAgICAgIGpxWEhSLnN0YXR1cyA9IHN0YXR1czsKICAgICAganFYSFIuc3RhdHVzVGV4dCA9ICggbmF0aXZlU3RhdHVzVGV4dCB8fCBzdGF0dXNUZXh0ICkgKyAiIjsKCiAgICAgIC8vIFN1Y2Nlc3MvRXJyb3IKICAgICAgaWYgKCBpc1N1Y2Nlc3MgKSB7CiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBzdWNjZXNzLCBzdGF0dXNUZXh0LCBqcVhIUiBdICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0LCBlcnJvciBdICk7CiAgICAgIH0KCiAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgIGpxWEhSLnN0YXR1c0NvZGUoIHN0YXR1c0NvZGUgKTsKICAgICAgc3RhdHVzQ29kZSA9IHVuZGVmaW5lZDsKCiAgICAgIGlmICggZmlyZUdsb2JhbHMgKSB7CiAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoIGlzU3VjY2VzcyA/ICJhamF4U3VjY2VzcyIgOiAiYWpheEVycm9yIiwKICAgICAgICAgIFsganFYSFIsIHMsIGlzU3VjY2VzcyA/IHN1Y2Nlc3MgOiBlcnJvciBdICk7CiAgICAgIH0KCiAgICAgIC8vIENvbXBsZXRlCiAgICAgIGNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBqcVhIUiwgc3RhdHVzVGV4dCBdICk7CgogICAgICBpZiAoIGZpcmVHbG9iYWxzICkgewogICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheENvbXBsZXRlIiwgWyBqcVhIUiwgcyBdICk7CiAgICAgICAgLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCiAgICAgICAgaWYgKCAhKCAtLWpRdWVyeS5hY3RpdmUgKSApIHsKICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RvcCIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBqcVhIUjsKICB9LAoKICBnZXRTY3JpcHQ6IGZ1bmN0aW9uKCB1cmwsIGNhbGxiYWNrICkgewogICAgcmV0dXJuIGpRdWVyeS5nZXQoIHVybCwgdW5kZWZpbmVkLCBjYWxsYmFjaywgInNjcmlwdCIgKTsKICB9LAoKICBnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsKICAgIHJldHVybiBqUXVlcnkuZ2V0KCB1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIgKTsKICB9Cn0pOwoKLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogKiAtIHNldHMgYWxsIHJlc3BvbnNlWFhYIGZpZWxkcyBhY2NvcmRpbmdseQogKiAtIGZpbmRzIHRoZSByaWdodCBkYXRhVHlwZSAobWVkaWF0ZXMgYmV0d2VlbiBjb250ZW50LXR5cGUgYW5kIGV4cGVjdGVkIGRhdGFUeXBlKQogKiAtIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKICovCmZ1bmN0aW9uIGFqYXhIYW5kbGVSZXNwb25zZXMoIHMsIGpxWEhSLCByZXNwb25zZXMgKSB7CgogIHZhciBjdCwgdHlwZSwgZmluYWxEYXRhVHlwZSwgZmlyc3REYXRhVHlwZSwKICAgIGNvbnRlbnRzID0gcy5jb250ZW50cywKICAgIGRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLAogICAgcmVzcG9uc2VGaWVsZHMgPSBzLnJlc3BvbnNlRmllbGRzOwoKICAvLyBGaWxsIHJlc3BvbnNlWFhYIGZpZWxkcwogIGZvciAoIHR5cGUgaW4gcmVzcG9uc2VGaWVsZHMgKSB7CiAgICBpZiAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewogICAgICBqcVhIUlsgcmVzcG9uc2VGaWVsZHNbdHlwZV0gXSA9IHJlc3BvbnNlc1sgdHlwZSBdOwogICAgfQogIH0KCiAgLy8gUmVtb3ZlIGF1dG8gZGF0YVR5cGUgYW5kIGdldCBjb250ZW50LXR5cGUgaW4gdGhlIHByb2Nlc3MKICB3aGlsZSggZGF0YVR5cGVzWyAwIF0gPT09ICIqIiApIHsKICAgIGRhdGFUeXBlcy5zaGlmdCgpOwogICAgaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgewogICAgICBjdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtVHlwZSIpOwogICAgfQogIH0KCiAgLy8gQ2hlY2sgaWYgd2UncmUgZGVhbGluZyB3aXRoIGEga25vd24gY29udGVudC10eXBlCiAgaWYgKCBjdCApIHsKICAgIGZvciAoIHR5cGUgaW4gY29udGVudHMgKSB7CiAgICAgIGlmICggY29udGVudHNbIHR5cGUgXSAmJiBjb250ZW50c1sgdHlwZSBdLnRlc3QoIGN0ICkgKSB7CiAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQoIHR5cGUgKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KCiAgLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIGhhdmUgYSByZXNwb25zZSBmb3IgdGhlIGV4cGVjdGVkIGRhdGFUeXBlCiAgaWYgKCBkYXRhVHlwZXNbIDAgXSBpbiByZXNwb25zZXMgKSB7CiAgICBmaW5hbERhdGFUeXBlID0gZGF0YVR5cGVzWyAwIF07CiAgfSBlbHNlIHsKICAgIC8vIFRyeSBjb252ZXJ0aWJsZSBkYXRhVHlwZXMKICAgIGZvciAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewogICAgICBpZiAoICFkYXRhVHlwZXNbIDAgXSB8fCBzLmNvbnZlcnRlcnNbIHR5cGUgKyAiICIgKyBkYXRhVHlwZXNbMF0gXSApIHsKICAgICAgICBmaW5hbERhdGFUeXBlID0gdHlwZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBpZiAoICFmaXJzdERhdGFUeXBlICkgewogICAgICAgIGZpcnN0RGF0YVR5cGUgPSB0eXBlOwogICAgICB9CiAgICB9CiAgICAvLyBPciBqdXN0IHVzZSBmaXJzdCBvbmUKICAgIGZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7CiAgfQoKICAvLyBJZiB3ZSBmb3VuZCBhIGRhdGFUeXBlCiAgLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKICAvLyBhbmQgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAgaWYgKCBmaW5hbERhdGFUeXBlICkgewogICAgaWYgKCBmaW5hbERhdGFUeXBlICE9PSBkYXRhVHlwZXNbIDAgXSApIHsKICAgICAgZGF0YVR5cGVzLnVuc2hpZnQoIGZpbmFsRGF0YVR5cGUgKTsKICAgIH0KICAgIHJldHVybiByZXNwb25zZXNbIGZpbmFsRGF0YVR5cGUgXTsKICB9Cn0KCi8vIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKZnVuY3Rpb24gYWpheENvbnZlcnQoIHMsIHJlc3BvbnNlICkgewoKICB2YXIgY29udiwgY29udjIsIGN1cnJlbnQsIHRtcCwKICAgIGNvbnZlcnRlcnMgPSB7fSwKICAgIGkgPSAwLAogICAgLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgogICAgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXMuc2xpY2UoKSwKICAgIHByZXYgPSBkYXRhVHlwZXNbIDAgXTsKCiAgLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKICBpZiAoIHMuZGF0YUZpbHRlciApIHsKICAgIHJlc3BvbnNlID0gcy5kYXRhRmlsdGVyKCByZXNwb25zZSwgcy5kYXRhVHlwZSApOwogIH0KCiAgLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzCiAgaWYgKCBkYXRhVHlwZXNbIDEgXSApIHsKICAgIGZvciAoIGNvbnYgaW4gcy5jb252ZXJ0ZXJzICkgewogICAgICBjb252ZXJ0ZXJzWyBjb252LnRvTG93ZXJDYXNlKCkgXSA9IHMuY29udmVydGVyc1sgY29udiBdOwogICAgfQogIH0KCiAgLy8gQ29udmVydCB0byBlYWNoIHNlcXVlbnRpYWwgZGF0YVR5cGUsIHRvbGVyYXRpbmcgbGlzdCBtb2RpZmljYXRpb24KICBmb3IgKCA7IChjdXJyZW50ID0gZGF0YVR5cGVzWysraV0pOyApIHsKCiAgICAvLyBUaGVyZSdzIG9ubHkgd29yayB0byBkbyBpZiBjdXJyZW50IGRhdGFUeXBlIGlzIG5vbi1hdXRvCiAgICBpZiAoIGN1cnJlbnQgIT09ICIqIiApIHsKCiAgICAgIC8vIENvbnZlcnQgcmVzcG9uc2UgaWYgcHJldiBkYXRhVHlwZSBpcyBub24tYXV0byBhbmQgZGlmZmVycyBmcm9tIGN1cnJlbnQKICAgICAgaWYgKCBwcmV2ICE9PSAiKiIgJiYgcHJldiAhPT0gY3VycmVudCApIHsKCiAgICAgICAgLy8gU2VlayBhIGRpcmVjdCBjb252ZXJ0ZXIKICAgICAgICBjb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIGN1cnJlbnQgXSB8fCBjb252ZXJ0ZXJzWyAiKiAiICsgY3VycmVudCBdOwoKICAgICAgICAvLyBJZiBub25lIGZvdW5kLCBzZWVrIGEgcGFpcgogICAgICAgIGlmICggIWNvbnYgKSB7CiAgICAgICAgICBmb3IgKCBjb252MiBpbiBjb252ZXJ0ZXJzICkgewoKICAgICAgICAgICAgLy8gSWYgY29udjIgb3V0cHV0cyBjdXJyZW50CiAgICAgICAgICAgIHRtcCA9IGNvbnYyLnNwbGl0KCIgIik7CiAgICAgICAgICAgIGlmICggdG1wWyAxIF0gPT09IGN1cnJlbnQgKSB7CgogICAgICAgICAgICAgIC8vIElmIHByZXYgY2FuIGJlIGNvbnZlcnRlZCB0byBhY2NlcHRlZCBpbnB1dAogICAgICAgICAgICAgIGNvbnYgPSBjb252ZXJ0ZXJzWyBwcmV2ICsgIiAiICsgdG1wWyAwIF0gXSB8fAogICAgICAgICAgICAgICAgY29udmVydGVyc1sgIiogIiArIHRtcFsgMCBdIF07CiAgICAgICAgICAgICAgaWYgKCBjb252ICkgewogICAgICAgICAgICAgICAgLy8gQ29uZGVuc2UgZXF1aXZhbGVuY2UgY29udmVydGVycwogICAgICAgICAgICAgICAgaWYgKCBjb252ID09PSB0cnVlICkgewogICAgICAgICAgICAgICAgICBjb252ID0gY29udmVydGVyc1sgY29udjIgXTsKCiAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIGluc2VydCB0aGUgaW50ZXJtZWRpYXRlIGRhdGFUeXBlCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBjb252ZXJ0ZXJzWyBjb252MiBdICE9PSB0cnVlICkgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdG1wWyAwIF07CiAgICAgICAgICAgICAgICAgIGRhdGFUeXBlcy5zcGxpY2UoIGktLSwgMCwgY3VycmVudCApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQXBwbHkgY29udmVydGVyIChpZiBub3QgYW4gZXF1aXZhbGVuY2UpCiAgICAgICAgaWYgKCBjb252ICE9PSB0cnVlICkgewoKICAgICAgICAgIC8vIFVubGVzcyBlcnJvcnMgYXJlIGFsbG93ZWQgdG8gYnViYmxlLCBjYXRjaCBhbmQgcmV0dXJuIHRoZW0KICAgICAgICAgIGlmICggY29udiAmJiBzWyJ0aHJvd3MiXSApIHsKICAgICAgICAgICAgcmVzcG9uc2UgPSBjb252KCByZXNwb25zZSApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CiAgICAgICAgICAgIH0gY2F0Y2ggKCBlICkgewogICAgICAgICAgICAgIHJldHVybiB7IHN0YXRlOiAicGFyc2VyZXJyb3IiLCBlcnJvcjogY29udiA/IGUgOiAiTm8gY29udmVyc2lvbiBmcm9tICIgKyBwcmV2ICsgIiB0byAiICsgY3VycmVudCB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBVcGRhdGUgcHJldiBmb3IgbmV4dCBpdGVyYXRpb24KICAgICAgcHJldiA9IGN1cnJlbnQ7CiAgICB9CiAgfQoKICByZXR1cm4geyBzdGF0ZTogInN1Y2Nlc3MiLCBkYXRhOiByZXNwb25zZSB9Owp9Ci8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlCmpRdWVyeS5hamF4U2V0dXAoewogIGFjY2VwdHM6IHsKICAgIHNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24vZWNtYXNjcmlwdCwgYXBwbGljYXRpb24veC1lY21hc2NyaXB0IgogIH0sCiAgY29udGVudHM6IHsKICAgIHNjcmlwdDogLyg/OmphdmF8ZWNtYSlzY3JpcHQvCiAgfSwKICBjb252ZXJ0ZXJzOiB7CiAgICAidGV4dCBzY3JpcHQiOiBmdW5jdGlvbiggdGV4dCApIHsKICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwoIHRleHQgKTsKICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgfQp9KTsKCi8vIEhhbmRsZSBjYWNoZSdzIHNwZWNpYWwgY2FzZSBhbmQgZ2xvYmFsCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAic2NyaXB0IiwgZnVuY3Rpb24oIHMgKSB7CiAgaWYgKCBzLmNhY2hlID09PSB1bmRlZmluZWQgKSB7CiAgICBzLmNhY2hlID0gZmFsc2U7CiAgfQogIGlmICggcy5jcm9zc0RvbWFpbiApIHsKICAgIHMudHlwZSA9ICJHRVQiOwogICAgcy5nbG9iYWwgPSBmYWxzZTsKICB9Cn0pOwoKLy8gQmluZCBzY3JpcHQgdGFnIGhhY2sgdHJhbnNwb3J0CmpRdWVyeS5hamF4VHJhbnNwb3J0KCAic2NyaXB0IiwgZnVuY3Rpb24ocykgewoKICAvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIHJlcXVlc3RzCiAgaWYgKCBzLmNyb3NzRG9tYWluICkgewoKICAgIHZhciBzY3JpcHQsCiAgICAgIGhlYWQgPSBkb2N1bWVudC5oZWFkIHx8IGpRdWVyeSgiaGVhZCIpWzBdIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCiAgICByZXR1cm4gewoKICAgICAgc2VuZDogZnVuY3Rpb24oIF8sIGNhbGxiYWNrICkgewoKICAgICAgICBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCiAgICAgICAgc2NyaXB0LmFzeW5jID0gdHJ1ZTsKCiAgICAgICAgaWYgKCBzLnNjcmlwdENoYXJzZXQgKSB7CiAgICAgICAgICBzY3JpcHQuY2hhcnNldCA9IHMuc2NyaXB0Q2hhcnNldDsKICAgICAgICB9CgogICAgICAgIHNjcmlwdC5zcmMgPSBzLnVybDsKCiAgICAgICAgLy8gQXR0YWNoIGhhbmRsZXJzIGZvciBhbGwgYnJvd3NlcnMKICAgICAgICBzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCBfLCBpc0Fib3J0ICkgewoKICAgICAgICAgIGlmICggaXNBYm9ydCB8fCAhc2NyaXB0LnJlYWR5U3RhdGUgfHwgL2xvYWRlZHxjb21wbGV0ZS8udGVzdCggc2NyaXB0LnJlYWR5U3RhdGUgKSApIHsKCiAgICAgICAgICAgIC8vIEhhbmRsZSBtZW1vcnkgbGVhayBpbiBJRQogICAgICAgICAgICBzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CgogICAgICAgICAgICAvLyBSZW1vdmUgdGhlIHNjcmlwdAogICAgICAgICAgICBpZiAoIHNjcmlwdC5wYXJlbnROb2RlICkgewogICAgICAgICAgICAgIHNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBzY3JpcHQgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGVyZWZlcmVuY2UgdGhlIHNjcmlwdAogICAgICAgICAgICBzY3JpcHQgPSBudWxsOwoKICAgICAgICAgICAgLy8gQ2FsbGJhY2sgaWYgbm90IGFib3J0CiAgICAgICAgICAgIGlmICggIWlzQWJvcnQgKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2soIDIwMCwgInN1Y2Nlc3MiICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBDaXJjdW12ZW50IElFNiBidWdzIHdpdGggYmFzZSBlbGVtZW50cyAoIzI3MDkgYW5kICM0Mzc4KSBieSBwcmVwZW5kaW5nCiAgICAgICAgLy8gVXNlIG5hdGl2ZSBET00gbWFuaXB1bGF0aW9uIHRvIGF2b2lkIG91ciBkb21NYW5pcCBBSkFYIHRyaWNrZXJ5CiAgICAgICAgaGVhZC5pbnNlcnRCZWZvcmUoIHNjcmlwdCwgaGVhZC5maXJzdENoaWxkICk7CiAgICAgIH0sCgogICAgICBhYm9ydDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCBzY3JpcHQgKSB7CiAgICAgICAgICBzY3JpcHQub25sb2FkKCB1bmRlZmluZWQsIHRydWUgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQp9KTsKdmFyIG9sZENhbGxiYWNrcyA9IFtdLAogIHJqc29ucCA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87CgovLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCmpRdWVyeS5hamF4U2V0dXAoewogIGpzb25wOiAiY2FsbGJhY2siLAogIGpzb25wQ2FsbGJhY2s6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8ICggalF1ZXJ5LmV4cGFuZG8gKyAiXyIgKyAoIGFqYXhfbm9uY2UrKyApICk7CiAgICB0aGlzWyBjYWxsYmFjayBdID0gdHJ1ZTsKICAgIHJldHVybiBjYWxsYmFjazsKICB9Cn0pOwoKLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAianNvbiBqc29ucCIsIGZ1bmN0aW9uKCBzLCBvcmlnaW5hbFNldHRpbmdzLCBqcVhIUiApIHsKCiAgdmFyIGNhbGxiYWNrTmFtZSwgb3ZlcndyaXR0ZW4sIHJlc3BvbnNlQ29udGFpbmVyLAogICAganNvblByb3AgPSBzLmpzb25wICE9PSBmYWxzZSAmJiAoIHJqc29ucC50ZXN0KCBzLnVybCApID8KICAgICAgInVybCIgOgogICAgICB0eXBlb2Ygcy5kYXRhID09PSAic3RyaW5nIiAmJiAhKCBzLmNvbnRlbnRUeXBlIHx8ICIiICkuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgJiYgcmpzb25wLnRlc3QoIHMuZGF0YSApICYmICJkYXRhIgogICAgKTsKCiAgLy8gSGFuZGxlIGlmZiB0aGUgZXhwZWN0ZWQgZGF0YSB0eXBlIGlzICJqc29ucCIgb3Igd2UgaGF2ZSBhIHBhcmFtZXRlciB0byBzZXQKICBpZiAoIGpzb25Qcm9wIHx8IHMuZGF0YVR5cGVzWyAwIF0gPT09ICJqc29ucCIgKSB7CgogICAgLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdAogICAgY2FsbGJhY2tOYW1lID0gcy5qc29ucENhbGxiYWNrID0galF1ZXJ5LmlzRnVuY3Rpb24oIHMuanNvbnBDYWxsYmFjayApID8KICAgICAgcy5qc29ucENhbGxiYWNrKCkgOgogICAgICBzLmpzb25wQ2FsbGJhY2s7CgogICAgLy8gSW5zZXJ0IGNhbGxiYWNrIGludG8gdXJsIG9yIGZvcm0gZGF0YQogICAgaWYgKCBqc29uUHJvcCApIHsKICAgICAgc1sganNvblByb3AgXSA9IHNbIGpzb25Qcm9wIF0ucmVwbGFjZSggcmpzb25wLCAiJDEiICsgY2FsbGJhY2tOYW1lICk7CiAgICB9IGVsc2UgaWYgKCBzLmpzb25wICE9PSBmYWxzZSApIHsKICAgICAgcy51cmwgKz0gKCBhamF4X3JxdWVyeS50ZXN0KCBzLnVybCApID8gIiYiIDogIj8iICkgKyBzLmpzb25wICsgIj0iICsgY2FsbGJhY2tOYW1lOwogICAgfQoKICAgIC8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24KICAgIHMuY29udmVydGVyc1sic2NyaXB0IGpzb24iXSA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoICFyZXNwb25zZUNvbnRhaW5lciApIHsKICAgICAgICBqUXVlcnkuZXJyb3IoIGNhbGxiYWNrTmFtZSArICIgd2FzIG5vdCBjYWxsZWQiICk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3BvbnNlQ29udGFpbmVyWyAwIF07CiAgICB9OwoKICAgIC8vIGZvcmNlIGpzb24gZGF0YVR5cGUKICAgIHMuZGF0YVR5cGVzWyAwIF0gPSAianNvbiI7CgogICAgLy8gSW5zdGFsbCBjYWxsYmFjawogICAgb3ZlcndyaXR0ZW4gPSB3aW5kb3dbIGNhbGxiYWNrTmFtZSBdOwogICAgd2luZG93WyBjYWxsYmFja05hbWUgXSA9IGZ1bmN0aW9uKCkgewogICAgICByZXNwb25zZUNvbnRhaW5lciA9IGFyZ3VtZW50czsKICAgIH07CgogICAgLy8gQ2xlYW4tdXAgZnVuY3Rpb24gKGZpcmVzIGFmdGVyIGNvbnZlcnRlcnMpCiAgICBqcVhIUi5hbHdheXMoZnVuY3Rpb24oKSB7CiAgICAgIC8vIFJlc3RvcmUgcHJlZXhpc3RpbmcgdmFsdWUKICAgICAgd2luZG93WyBjYWxsYmFja05hbWUgXSA9IG92ZXJ3cml0dGVuOwoKICAgICAgLy8gU2F2ZSBiYWNrIGFzIGZyZWUKICAgICAgaWYgKCBzWyBjYWxsYmFja05hbWUgXSApIHsKICAgICAgICAvLyBtYWtlIHN1cmUgdGhhdCByZS11c2luZyB0aGUgb3B0aW9ucyBkb2Vzbid0IHNjcmV3IHRoaW5ncyBhcm91bmQKICAgICAgICBzLmpzb25wQ2FsbGJhY2sgPSBvcmlnaW5hbFNldHRpbmdzLmpzb25wQ2FsbGJhY2s7CgogICAgICAgIC8vIHNhdmUgdGhlIGNhbGxiYWNrIG5hbWUgZm9yIGZ1dHVyZSB1c2UKICAgICAgICBvbGRDYWxsYmFja3MucHVzaCggY2FsbGJhY2tOYW1lICk7CiAgICAgIH0KCiAgICAgIC8vIENhbGwgaWYgaXQgd2FzIGEgZnVuY3Rpb24gYW5kIHdlIGhhdmUgYSByZXNwb25zZQogICAgICBpZiAoIHJlc3BvbnNlQ29udGFpbmVyICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBvdmVyd3JpdHRlbiApICkgewogICAgICAgIG92ZXJ3cml0dGVuKCByZXNwb25zZUNvbnRhaW5lclsgMCBdICk7CiAgICAgIH0KCiAgICAgIHJlc3BvbnNlQ29udGFpbmVyID0gb3ZlcndyaXR0ZW4gPSB1bmRlZmluZWQ7CiAgICB9KTsKCiAgICAvLyBEZWxlZ2F0ZSB0byBzY3JpcHQKICAgIHJldHVybiAic2NyaXB0IjsKICB9Cn0pOwp2YXIgeGhyQ2FsbGJhY2tzLCB4aHJTdXBwb3J0ZWQsCiAgeGhySWQgPSAwLAogIC8vICM1MjgwOiBJbnRlcm5ldCBFeHBsb3JlciB3aWxsIGtlZXAgY29ubmVjdGlvbnMgYWxpdmUgaWYgd2UgZG9uJ3QgYWJvcnQgb24gdW5sb2FkCiAgeGhyT25VbmxvYWRBYm9ydCA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ICYmIGZ1bmN0aW9uKCkgewogICAgLy8gQWJvcnQgYWxsIHBlbmRpbmcgcmVxdWVzdHMKICAgIHZhciBrZXk7CiAgICBmb3IgKCBrZXkgaW4geGhyQ2FsbGJhY2tzICkgewogICAgICB4aHJDYWxsYmFja3NbIGtleSBdKCB1bmRlZmluZWQsIHRydWUgKTsKICAgIH0KICB9OwoKLy8gRnVuY3Rpb25zIHRvIGNyZWF0ZSB4aHJzCmZ1bmN0aW9uIGNyZWF0ZVN0YW5kYXJkWEhSKCkgewogIHRyeSB7CiAgICByZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpOwogIH0gY2F0Y2goIGUgKSB7fQp9CgpmdW5jdGlvbiBjcmVhdGVBY3RpdmVYSFIoKSB7CiAgdHJ5IHsKICAgIHJldHVybiBuZXcgd2luZG93LkFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgfSBjYXRjaCggZSApIHt9Cn0KCi8vIENyZWF0ZSB0aGUgcmVxdWVzdCBvYmplY3QKLy8gKFRoaXMgaXMgc3RpbGwgYXR0YWNoZWQgdG8gYWpheFNldHRpbmdzIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KQpqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ID8KICAvKiBNaWNyb3NvZnQgZmFpbGVkIHRvIHByb3Blcmx5CiAgICogaW1wbGVtZW50IHRoZSBYTUxIdHRwUmVxdWVzdCBpbiBJRTcgKGNhbid0IHJlcXVlc3QgbG9jYWwgZmlsZXMpLAogICAqIHNvIHdlIHVzZSB0aGUgQWN0aXZlWE9iamVjdCB3aGVuIGl0IGlzIGF2YWlsYWJsZQogICAqIEFkZGl0aW9uYWxseSBYTUxIdHRwUmVxdWVzdCBjYW4gYmUgZGlzYWJsZWQgaW4gSUU3L0lFOCBzbwogICAqIHdlIG5lZWQgYSBmYWxsYmFjay4KICAgKi8KICBmdW5jdGlvbigpIHsKICAgIHJldHVybiAhdGhpcy5pc0xvY2FsICYmIGNyZWF0ZVN0YW5kYXJkWEhSKCkgfHwgY3JlYXRlQWN0aXZlWEhSKCk7CiAgfSA6CiAgLy8gRm9yIGFsbCBvdGhlciBicm93c2VycywgdXNlIHRoZSBzdGFuZGFyZCBYTUxIdHRwUmVxdWVzdCBvYmplY3QKICBjcmVhdGVTdGFuZGFyZFhIUjsKCi8vIERldGVybWluZSBzdXBwb3J0IHByb3BlcnRpZXMKeGhyU3VwcG9ydGVkID0galF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIoKTsKalF1ZXJ5LnN1cHBvcnQuY29ycyA9ICEheGhyU3VwcG9ydGVkICYmICggIndpdGhDcmVkZW50aWFscyIgaW4geGhyU3VwcG9ydGVkICk7CnhoclN1cHBvcnRlZCA9IGpRdWVyeS5zdXBwb3J0LmFqYXggPSAhIXhoclN1cHBvcnRlZDsKCi8vIENyZWF0ZSB0cmFuc3BvcnQgaWYgdGhlIGJyb3dzZXIgY2FuIHByb3ZpZGUgYW4geGhyCmlmICggeGhyU3VwcG9ydGVkICkgewoKICBqUXVlcnkuYWpheFRyYW5zcG9ydChmdW5jdGlvbiggcyApIHsKICAgIC8vIENyb3NzIGRvbWFpbiBvbmx5IGFsbG93ZWQgaWYgc3VwcG9ydGVkIHRocm91Z2ggWE1MSHR0cFJlcXVlc3QKICAgIGlmICggIXMuY3Jvc3NEb21haW4gfHwgalF1ZXJ5LnN1cHBvcnQuY29ycyApIHsKCiAgICAgIHZhciBjYWxsYmFjazsKCiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24oIGhlYWRlcnMsIGNvbXBsZXRlICkgewoKICAgICAgICAgIC8vIEdldCBhIG5ldyB4aHIKICAgICAgICAgIHZhciBoYW5kbGUsIGksCiAgICAgICAgICAgIHhociA9IHMueGhyKCk7CgogICAgICAgICAgLy8gT3BlbiB0aGUgc29ja2V0CiAgICAgICAgICAvLyBQYXNzaW5nIG51bGwgdXNlcm5hbWUsIGdlbmVyYXRlcyBhIGxvZ2luIHBvcHVwIG9uIE9wZXJhICgjMjg2NSkKICAgICAgICAgIGlmICggcy51c2VybmFtZSApIHsKICAgICAgICAgICAgeGhyLm9wZW4oIHMudHlwZSwgcy51cmwsIHMuYXN5bmMsIHMudXNlcm5hbWUsIHMucGFzc3dvcmQgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHhoci5vcGVuKCBzLnR5cGUsIHMudXJsLCBzLmFzeW5jICk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQXBwbHkgY3VzdG9tIGZpZWxkcyBpZiBwcm92aWRlZAogICAgICAgICAgaWYgKCBzLnhockZpZWxkcyApIHsKICAgICAgICAgICAgZm9yICggaSBpbiBzLnhockZpZWxkcyApIHsKICAgICAgICAgICAgICB4aHJbIGkgXSA9IHMueGhyRmllbGRzWyBpIF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkCiAgICAgICAgICBpZiAoIHMubWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUgKSB7CiAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlKCBzLm1pbWVUeXBlICk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXIKICAgICAgICAgIC8vIEZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMsIHNlZWluZyBhcyBjb25kaXRpb25zIGZvciBhIHByZWZsaWdodCBhcmUKICAgICAgICAgIC8vIGFraW4gdG8gYSBqaWdzYXcgcHV6emxlLCB3ZSBzaW1wbHkgbmV2ZXIgc2V0IGl0IHRvIGJlIHN1cmUuCiAgICAgICAgICAvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkKICAgICAgICAgIC8vIEZvciBzYW1lLWRvbWFpbiByZXF1ZXN0cywgd29uJ3QgY2hhbmdlIGhlYWRlciBpZiBhbHJlYWR5IHByb3ZpZGVkLgogICAgICAgICAgaWYgKCAhcy5jcm9zc0RvbWFpbiAmJiAhaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdICkgewogICAgICAgICAgICBoZWFkZXJzWyJYLVJlcXVlc3RlZC1XaXRoIl0gPSAiWE1MSHR0cFJlcXVlc3QiOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIE5lZWQgYW4gZXh0cmEgdHJ5L2NhdGNoIGZvciBjcm9zcyBkb21haW4gcmVxdWVzdHMgaW4gRmlyZWZveCAzCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKCBpIGluIGhlYWRlcnMgKSB7CiAgICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoIGksIGhlYWRlcnNbIGkgXSApOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoKCBlcnIgKSB7fQoKICAgICAgICAgIC8vIERvIHNlbmQgdGhlIHJlcXVlc3QKICAgICAgICAgIC8vIFRoaXMgbWF5IHJhaXNlIGFuIGV4Y2VwdGlvbiB3aGljaCBpcyBhY3R1YWxseQogICAgICAgICAgLy8gaGFuZGxlZCBpbiBqUXVlcnkuYWpheCAoc28gbm8gdHJ5L2NhdGNoIGhlcmUpCiAgICAgICAgICB4aHIuc2VuZCggKCBzLmhhc0NvbnRlbnQgJiYgcy5kYXRhICkgfHwgbnVsbCApOwoKICAgICAgICAgIC8vIExpc3RlbmVyCiAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCBfLCBpc0Fib3J0ICkgewoKICAgICAgICAgICAgdmFyIHN0YXR1cywKICAgICAgICAgICAgICBzdGF0dXNUZXh0LAogICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycywKICAgICAgICAgICAgICByZXNwb25zZXMsCiAgICAgICAgICAgICAgeG1sOwoKICAgICAgICAgICAgLy8gRmlyZWZveCB0aHJvd3MgZXhjZXB0aW9ucyB3aGVuIGFjY2Vzc2luZyBwcm9wZXJ0aWVzCiAgICAgICAgICAgIC8vIG9mIGFuIHhociB3aGVuIGEgbmV0d29yayBlcnJvciBvY2N1cnJlZAogICAgICAgICAgICAvLyBodHRwOi8vaGVscGZ1bC5rbm9icy1kaWFscy5jb20vaW5kZXgucGhwL0NvbXBvbmVudF9yZXR1cm5lZF9mYWlsdXJlX2NvZGU6XzB4ODAwNDAxMTFfKE5TX0VSUk9SX05PVF9BVkFJTEFCTEUpCiAgICAgICAgICAgIHRyeSB7CgogICAgICAgICAgICAgIC8vIFdhcyBuZXZlciBjYWxsZWQgYW5kIGlzIGFib3J0ZWQgb3IgY29tcGxldGUKICAgICAgICAgICAgICBpZiAoIGNhbGxiYWNrICYmICggaXNBYm9ydCB8fCB4aHIucmVhZHlTdGF0ZSA9PT0gNCApICkgewoKICAgICAgICAgICAgICAgIC8vIE9ubHkgY2FsbGVkIG9uY2UKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgICAgIC8vIERvIG5vdCBrZWVwIGFzIGFjdGl2ZSBhbnltb3JlCiAgICAgICAgICAgICAgICBpZiAoIGhhbmRsZSApIHsKICAgICAgICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGpRdWVyeS5ub29wOwogICAgICAgICAgICAgICAgICBpZiAoIHhock9uVW5sb2FkQWJvcnQgKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHhockNhbGxiYWNrc1sgaGFuZGxlIF07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJZiBpdCdzIGFuIGFib3J0CiAgICAgICAgICAgICAgICBpZiAoIGlzQWJvcnQgKSB7CiAgICAgICAgICAgICAgICAgIC8vIEFib3J0IGl0IG1hbnVhbGx5IGlmIG5lZWRlZAogICAgICAgICAgICAgICAgICBpZiAoIHhoci5yZWFkeVN0YXRlICE9PSA0ICkgewogICAgICAgICAgICAgICAgICAgIHhoci5hYm9ydCgpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXNwb25zZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgc3RhdHVzID0geGhyLnN0YXR1czsKICAgICAgICAgICAgICAgICAgeG1sID0geGhyLnJlc3BvbnNlWE1MOwogICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAgICAgICAgICAvLyBDb25zdHJ1Y3QgcmVzcG9uc2UgbGlzdAogICAgICAgICAgICAgICAgICBpZiAoIHhtbCAmJiB4bWwuZG9jdW1lbnRFbGVtZW50IC8qICM0OTU4ICovICkgewogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlcy54bWwgPSB4bWw7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIC8vIFdoZW4gcmVxdWVzdGluZyBiaW5hcnkgZGF0YSwgSUU2LTkgd2lsbCB0aHJvdyBhbiBleGNlcHRpb24KICAgICAgICAgICAgICAgICAgLy8gb24gYW55IGF0dGVtcHQgdG8gYWNjZXNzIHJlc3BvbnNlVGV4dCAoIzExNDI2KQogICAgICAgICAgICAgICAgICBpZiAoIHR5cGVvZiB4aHIucmVzcG9uc2VUZXh0ID09PSAic3RyaW5nIiApIHsKICAgICAgICAgICAgICAgICAgICByZXNwb25zZXMudGV4dCA9IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggdGhyb3dzIGFuIGV4Y2VwdGlvbiB3aGVuIGFjY2Vzc2luZwogICAgICAgICAgICAgICAgICAvLyBzdGF0dXNUZXh0IGZvciBmYXVsdHkgY3Jvc3MtZG9tYWluIHJlcXVlc3RzCiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdHVzVGV4dCA9IHhoci5zdGF0dXNUZXh0OwogICAgICAgICAgICAgICAgICB9IGNhdGNoKCBlICkgewogICAgICAgICAgICAgICAgICAgIC8vIFdlIG5vcm1hbGl6ZSB3aXRoIFdlYmtpdCBnaXZpbmcgYW4gZW1wdHkgc3RhdHVzVGV4dAogICAgICAgICAgICAgICAgICAgIHN0YXR1c1RleHQgPSAiIjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgLy8gRmlsdGVyIHN0YXR1cyBmb3Igbm9uIHN0YW5kYXJkIGJlaGF2aW9ycwoKICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHJlcXVlc3QgaXMgbG9jYWwgYW5kIHdlIGhhdmUgZGF0YTogYXNzdW1lIGEgc3VjY2VzcwogICAgICAgICAgICAgICAgICAvLyAoc3VjY2VzcyB3aXRoIG5vIGRhdGEgd29uJ3QgZ2V0IG5vdGlmaWVkLCB0aGF0J3MgdGhlIGJlc3Qgd2UKICAgICAgICAgICAgICAgICAgLy8gY2FuIGRvIGdpdmVuIGN1cnJlbnQgaW1wbGVtZW50YXRpb25zKQogICAgICAgICAgICAgICAgICBpZiAoICFzdGF0dXMgJiYgcy5pc0xvY2FsICYmICFzLmNyb3NzRG9tYWluICkgewogICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IHJlc3BvbnNlcy50ZXh0ID8gMjAwIDogNDA0OwogICAgICAgICAgICAgICAgICAvLyBJRSAtICMxNDUwOiBzb21ldGltZXMgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDEyMjMgKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdHVzID0gMjA0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKCBmaXJlZm94QWNjZXNzRXhjZXB0aW9uICkgewogICAgICAgICAgICAgIGlmICggIWlzQWJvcnQgKSB7CiAgICAgICAgICAgICAgICBjb21wbGV0ZSggLTEsIGZpcmVmb3hBY2Nlc3NFeGNlcHRpb24gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhbGwgY29tcGxldGUgaWYgbmVlZGVkCiAgICAgICAgICAgIGlmICggcmVzcG9uc2VzICkgewogICAgICAgICAgICAgIGNvbXBsZXRlKCBzdGF0dXMsIHN0YXR1c1RleHQsIHJlc3BvbnNlcywgcmVzcG9uc2VIZWFkZXJzICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgaWYgKCAhcy5hc3luYyApIHsKICAgICAgICAgICAgLy8gaWYgd2UncmUgaW4gc3luYyBtb2RlIHdlIGZpcmUgdGhlIGNhbGxiYWNrCiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKCB4aHIucmVhZHlTdGF0ZSA9PT0gNCApIHsKICAgICAgICAgICAgLy8gKElFNiAmIElFNykgaWYgaXQncyBpbiBjYWNoZSBhbmQgaGFzIGJlZW4KICAgICAgICAgICAgLy8gcmV0cmlldmVkIGRpcmVjdGx5IHdlIG5lZWQgdG8gZmlyZSB0aGUgY2FsbGJhY2sKICAgICAgICAgICAgc2V0VGltZW91dCggY2FsbGJhY2sgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhhbmRsZSA9ICsreGhySWQ7CiAgICAgICAgICAgIGlmICggeGhyT25VbmxvYWRBYm9ydCApIHsKICAgICAgICAgICAgICAvLyBDcmVhdGUgdGhlIGFjdGl2ZSB4aHJzIGNhbGxiYWNrcyBsaXN0IGlmIG5lZWRlZAogICAgICAgICAgICAgIC8vIGFuZCBhdHRhY2ggdGhlIHVubG9hZCBoYW5kbGVyCiAgICAgICAgICAgICAgaWYgKCAheGhyQ2FsbGJhY2tzICkgewogICAgICAgICAgICAgICAgeGhyQ2FsbGJhY2tzID0ge307CiAgICAgICAgICAgICAgICBqUXVlcnkoIHdpbmRvdyApLnVubG9hZCggeGhyT25VbmxvYWRBYm9ydCApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBBZGQgdG8gbGlzdCBvZiBhY3RpdmUgeGhycyBjYWxsYmFja3MKICAgICAgICAgICAgICB4aHJDYWxsYmFja3NbIGhhbmRsZSBdID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGNhbGxiYWNrOwogICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGFib3J0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICggY2FsbGJhY2sgKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKCB1bmRlZmluZWQsIHRydWUgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfSk7Cn0KdmFyIGZ4Tm93LCB0aW1lcklkLAogIHJmeHR5cGVzID0gL14oPzp0b2dnbGV8c2hvd3xoaWRlKSQvLAogIHJmeG51bSA9IG5ldyBSZWdFeHAoICJeKD86KFsrLV0pPXwpKCIgKyBjb3JlX3BudW0gKyAiKShbYS16JV0qKSQiLCAiaSIgKSwKICBycnVuID0gL3F1ZXVlSG9va3MkLywKICBhbmltYXRpb25QcmVmaWx0ZXJzID0gWyBkZWZhdWx0UHJlZmlsdGVyIF0sCiAgdHdlZW5lcnMgPSB7CiAgICAiKiI6IFtmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CiAgICAgIHZhciBlbmQsIHVuaXQsCiAgICAgICAgdHdlZW4gPSB0aGlzLmNyZWF0ZVR3ZWVuKCBwcm9wLCB2YWx1ZSApLAogICAgICAgIHBhcnRzID0gcmZ4bnVtLmV4ZWMoIHZhbHVlICksCiAgICAgICAgdGFyZ2V0ID0gdHdlZW4uY3VyKCksCiAgICAgICAgc3RhcnQgPSArdGFyZ2V0IHx8IDAsCiAgICAgICAgc2NhbGUgPSAxLAogICAgICAgIG1heEl0ZXJhdGlvbnMgPSAyMDsKCiAgICAgIGlmICggcGFydHMgKSB7CiAgICAgICAgZW5kID0gK3BhcnRzWzJdOwogICAgICAgIHVuaXQgPSBwYXJ0c1szXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApOwoKICAgICAgICAvLyBXZSBuZWVkIHRvIGNvbXB1dGUgc3RhcnRpbmcgdmFsdWUKICAgICAgICBpZiAoIHVuaXQgIT09ICJweCIgJiYgc3RhcnQgKSB7CiAgICAgICAgICAvLyBJdGVyYXRpdmVseSBhcHByb3hpbWF0ZSBmcm9tIGEgbm9uemVybyBzdGFydGluZyBwb2ludAogICAgICAgICAgLy8gUHJlZmVyIHRoZSBjdXJyZW50IHByb3BlcnR5LCBiZWNhdXNlIHRoaXMgcHJvY2VzcyB3aWxsIGJlIHRyaXZpYWwgaWYgaXQgdXNlcyB0aGUgc2FtZSB1bml0cwogICAgICAgICAgLy8gRmFsbGJhY2sgdG8gZW5kIG9yIGEgc2ltcGxlIGNvbnN0YW50CiAgICAgICAgICBzdGFydCA9IGpRdWVyeS5jc3MoIHR3ZWVuLmVsZW0sIHByb3AsIHRydWUgKSB8fCBlbmQgfHwgMTsKCiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIC8vIElmIHByZXZpb3VzIGl0ZXJhdGlvbiB6ZXJvZWQgb3V0LCBkb3VibGUgdW50aWwgd2UgZ2V0ICpzb21ldGhpbmcqCiAgICAgICAgICAgIC8vIFVzZSBhIHN0cmluZyBmb3IgZG91YmxpbmcgZmFjdG9yIHNvIHdlIGRvbid0IGFjY2lkZW50YWxseSBzZWUgc2NhbGUgYXMgdW5jaGFuZ2VkIGJlbG93CiAgICAgICAgICAgIHNjYWxlID0gc2NhbGUgfHwgIi41IjsKCiAgICAgICAgICAgIC8vIEFkanVzdCBhbmQgYXBwbHkKICAgICAgICAgICAgc3RhcnQgPSBzdGFydCAvIHNjYWxlOwogICAgICAgICAgICBqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHByb3AsIHN0YXJ0ICsgdW5pdCApOwoKICAgICAgICAgIC8vIFVwZGF0ZSBzY2FsZSwgdG9sZXJhdGluZyB6ZXJvIG9yIE5hTiBmcm9tIHR3ZWVuLmN1cigpCiAgICAgICAgICAvLyBBbmQgYnJlYWtpbmcgdGhlIGxvb3AgaWYgc2NhbGUgaXMgdW5jaGFuZ2VkIG9yIHBlcmZlY3QsIG9yIGlmIHdlJ3ZlIGp1c3QgaGFkIGVub3VnaAogICAgICAgICAgfSB3aGlsZSAoIHNjYWxlICE9PSAoc2NhbGUgPSB0d2Vlbi5jdXIoKSAvIHRhcmdldCkgJiYgc2NhbGUgIT09IDEgJiYgLS1tYXhJdGVyYXRpb25zICk7CiAgICAgICAgfQoKICAgICAgICB0d2Vlbi51bml0ID0gdW5pdDsKICAgICAgICB0d2Vlbi5zdGFydCA9IHN0YXJ0OwogICAgICAgIC8vIElmIGEgKz0vLT0gdG9rZW4gd2FzIHByb3ZpZGVkLCB3ZSdyZSBkb2luZyBhIHJlbGF0aXZlIGFuaW1hdGlvbgogICAgICAgIHR3ZWVuLmVuZCA9IHBhcnRzWzFdID8gc3RhcnQgKyAoIHBhcnRzWzFdICsgMSApICogZW5kIDogZW5kOwogICAgICB9CiAgICAgIHJldHVybiB0d2VlbjsKICAgIH1dCiAgfTsKCi8vIEFuaW1hdGlvbnMgY3JlYXRlZCBzeW5jaHJvbm91c2x5IHdpbGwgcnVuIHN5bmNocm9ub3VzbHkKZnVuY3Rpb24gY3JlYXRlRnhOb3coKSB7CiAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgIGZ4Tm93ID0gdW5kZWZpbmVkOwogIH0pOwogIHJldHVybiAoIGZ4Tm93ID0galF1ZXJ5Lm5vdygpICk7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVR3ZWVucyggYW5pbWF0aW9uLCBwcm9wcyApIHsKICBqUXVlcnkuZWFjaCggcHJvcHMsIGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKICAgIHZhciBjb2xsZWN0aW9uID0gKCB0d2VlbmVyc1sgcHJvcCBdIHx8IFtdICkuY29uY2F0KCB0d2VlbmVyc1sgIioiIF0gKSwKICAgICAgaW5kZXggPSAwLAogICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKICAgIGZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CiAgICAgIGlmICggY29sbGVjdGlvblsgaW5kZXggXS5jYWxsKCBhbmltYXRpb24sIHByb3AsIHZhbHVlICkgKSB7CgogICAgICAgIC8vIHdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb3BlcnR5CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIEFuaW1hdGlvbiggZWxlbSwgcHJvcGVydGllcywgb3B0aW9ucyApIHsKICB2YXIgcmVzdWx0LAogICAgc3RvcHBlZCwKICAgIGluZGV4ID0gMCwKICAgIGxlbmd0aCA9IGFuaW1hdGlvblByZWZpbHRlcnMubGVuZ3RoLAogICAgZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKS5hbHdheXMoIGZ1bmN0aW9uKCkgewogICAgICAvLyBkb24ndCBtYXRjaCBlbGVtIGluIHRoZSA6YW5pbWF0ZWQgc2VsZWN0b3IKICAgICAgZGVsZXRlIHRpY2suZWxlbTsKICAgIH0pLAogICAgdGljayA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIHN0b3BwZWQgKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHZhciBjdXJyZW50VGltZSA9IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCiAgICAgICAgcmVtYWluaW5nID0gTWF0aC5tYXgoIDAsIGFuaW1hdGlvbi5zdGFydFRpbWUgKyBhbmltYXRpb24uZHVyYXRpb24gLSBjdXJyZW50VGltZSApLAogICAgICAgIC8vIGFyY2hhaWMgY3Jhc2ggYnVnIHdvbid0IGFsbG93IHVzIHRvIHVzZSAxIC0gKCAwLjUgfHwgMCApICgjMTI0OTcpCiAgICAgICAgdGVtcCA9IHJlbWFpbmluZyAvIGFuaW1hdGlvbi5kdXJhdGlvbiB8fCAwLAogICAgICAgIHBlcmNlbnQgPSAxIC0gdGVtcCwKICAgICAgICBpbmRleCA9IDAsCiAgICAgICAgbGVuZ3RoID0gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGg7CgogICAgICBmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKICAgICAgICBhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggcGVyY2VudCApOwogICAgICB9CgogICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgcGVyY2VudCwgcmVtYWluaW5nIF0pOwoKICAgICAgaWYgKCBwZXJjZW50IDwgMSAmJiBsZW5ndGggKSB7CiAgICAgICAgcmV0dXJuIHJlbWFpbmluZzsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWZlcnJlZC5yZXNvbHZlV2l0aCggZWxlbSwgWyBhbmltYXRpb24gXSApOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSwKICAgIGFuaW1hdGlvbiA9IGRlZmVycmVkLnByb21pc2UoewogICAgICBlbGVtOiBlbGVtLAogICAgICBwcm9wczogalF1ZXJ5LmV4dGVuZCgge30sIHByb3BlcnRpZXMgKSwKICAgICAgb3B0czogalF1ZXJ5LmV4dGVuZCggdHJ1ZSwgeyBzcGVjaWFsRWFzaW5nOiB7fSB9LCBvcHRpb25zICksCiAgICAgIG9yaWdpbmFsUHJvcGVydGllczogcHJvcGVydGllcywKICAgICAgb3JpZ2luYWxPcHRpb25zOiBvcHRpb25zLAogICAgICBzdGFydFRpbWU6IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCiAgICAgIGR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAogICAgICB0d2VlbnM6IFtdLAogICAgICBjcmVhdGVUd2VlbjogZnVuY3Rpb24oIHByb3AsIGVuZCApIHsKICAgICAgICB2YXIgdHdlZW4gPSBqUXVlcnkuVHdlZW4oIGVsZW0sIGFuaW1hdGlvbi5vcHRzLCBwcm9wLCBlbmQsCiAgICAgICAgICAgIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmdbIHByb3AgXSB8fCBhbmltYXRpb24ub3B0cy5lYXNpbmcgKTsKICAgICAgICBhbmltYXRpb24udHdlZW5zLnB1c2goIHR3ZWVuICk7CiAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiggZ290b0VuZCApIHsKICAgICAgICB2YXIgaW5kZXggPSAwLAogICAgICAgICAgLy8gaWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBlbmQsIHdlIHdhbnQgdG8gcnVuIGFsbCB0aGUgdHdlZW5zCiAgICAgICAgICAvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKICAgICAgICAgIGxlbmd0aCA9IGdvdG9FbmQgPyBhbmltYXRpb24udHdlZW5zLmxlbmd0aCA6IDA7CiAgICAgICAgaWYgKCBzdG9wcGVkICkgewogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIHN0b3BwZWQgPSB0cnVlOwogICAgICAgIGZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewogICAgICAgICAgYW5pbWF0aW9uLnR3ZWVuc1sgaW5kZXggXS5ydW4oIDEgKTsKICAgICAgICB9CgogICAgICAgIC8vIHJlc29sdmUgd2hlbiB3ZSBwbGF5ZWQgdGhlIGxhc3QgZnJhbWUKICAgICAgICAvLyBvdGhlcndpc2UsIHJlamVjdAogICAgICAgIGlmICggZ290b0VuZCApIHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgZ290b0VuZCBdICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdFdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH0pLAogICAgcHJvcHMgPSBhbmltYXRpb24ucHJvcHM7CgogIHByb3BGaWx0ZXIoIHByb3BzLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nICk7CgogIGZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewogICAgcmVzdWx0ID0gYW5pbWF0aW9uUHJlZmlsdGVyc1sgaW5kZXggXS5jYWxsKCBhbmltYXRpb24sIGVsZW0sIHByb3BzLCBhbmltYXRpb24ub3B0cyApOwogICAgaWYgKCByZXN1bHQgKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgfQoKICBjcmVhdGVUd2VlbnMoIGFuaW1hdGlvbiwgcHJvcHMgKTsKCiAgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggYW5pbWF0aW9uLm9wdHMuc3RhcnQgKSApIHsKICAgIGFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoIGVsZW0sIGFuaW1hdGlvbiApOwogIH0KCiAgalF1ZXJ5LmZ4LnRpbWVyKAogICAgalF1ZXJ5LmV4dGVuZCggdGljaywgewogICAgICBlbGVtOiBlbGVtLAogICAgICBhbmltOiBhbmltYXRpb24sCiAgICAgIHF1ZXVlOiBhbmltYXRpb24ub3B0cy5xdWV1ZQogICAgfSkKICApOwoKICAvLyBhdHRhY2ggY2FsbGJhY2tzIGZyb20gb3B0aW9ucwogIHJldHVybiBhbmltYXRpb24ucHJvZ3Jlc3MoIGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzICkKICAgIC5kb25lKCBhbmltYXRpb24ub3B0cy5kb25lLCBhbmltYXRpb24ub3B0cy5jb21wbGV0ZSApCiAgICAuZmFpbCggYW5pbWF0aW9uLm9wdHMuZmFpbCApCiAgICAuYWx3YXlzKCBhbmltYXRpb24ub3B0cy5hbHdheXMgKTsKfQoKZnVuY3Rpb24gcHJvcEZpbHRlciggcHJvcHMsIHNwZWNpYWxFYXNpbmcgKSB7CiAgdmFyIGluZGV4LCBuYW1lLCBlYXNpbmcsIHZhbHVlLCBob29rczsKCiAgLy8gY2FtZWxDYXNlLCBzcGVjaWFsRWFzaW5nIGFuZCBleHBhbmQgY3NzSG9vayBwYXNzCiAgZm9yICggaW5kZXggaW4gcHJvcHMgKSB7CiAgICBuYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggaW5kZXggKTsKICAgIGVhc2luZyA9IHNwZWNpYWxFYXNpbmdbIG5hbWUgXTsKICAgIHZhbHVlID0gcHJvcHNbIGluZGV4IF07CiAgICBpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWx1ZSApICkgewogICAgICBlYXNpbmcgPSB2YWx1ZVsgMSBdOwogICAgICB2YWx1ZSA9IHByb3BzWyBpbmRleCBdID0gdmFsdWVbIDAgXTsKICAgIH0KCiAgICBpZiAoIGluZGV4ICE9PSBuYW1lICkgewogICAgICBwcm9wc1sgbmFtZSBdID0gdmFsdWU7CiAgICAgIGRlbGV0ZSBwcm9wc1sgaW5kZXggXTsKICAgIH0KCiAgICBob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdOwogICAgaWYgKCBob29rcyAmJiAiZXhwYW5kIiBpbiBob29rcyApIHsKICAgICAgdmFsdWUgPSBob29rcy5leHBhbmQoIHZhbHVlICk7CiAgICAgIGRlbGV0ZSBwcm9wc1sgbmFtZSBdOwoKICAgICAgLy8gbm90IHF1aXRlICQuZXh0ZW5kLCB0aGlzIHdvbnQgb3ZlcndyaXRlIGtleXMgYWxyZWFkeSBwcmVzZW50LgogICAgICAvLyBhbHNvIC0gcmV1c2luZyAnaW5kZXgnIGZyb20gYWJvdmUgYmVjYXVzZSB3ZSBoYXZlIHRoZSBjb3JyZWN0ICJuYW1lIgogICAgICBmb3IgKCBpbmRleCBpbiB2YWx1ZSApIHsKICAgICAgICBpZiAoICEoIGluZGV4IGluIHByb3BzICkgKSB7CiAgICAgICAgICBwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyBpbmRleCBdOwogICAgICAgICAgc3BlY2lhbEVhc2luZ1sgaW5kZXggXSA9IGVhc2luZzsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHNwZWNpYWxFYXNpbmdbIG5hbWUgXSA9IGVhc2luZzsKICAgIH0KICB9Cn0KCmpRdWVyeS5BbmltYXRpb24gPSBqUXVlcnkuZXh0ZW5kKCBBbmltYXRpb24sIHsKCiAgdHdlZW5lcjogZnVuY3Rpb24oIHByb3BzLCBjYWxsYmFjayApIHsKICAgIGlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHByb3BzICkgKSB7CiAgICAgIGNhbGxiYWNrID0gcHJvcHM7CiAgICAgIHByb3BzID0gWyAiKiIgXTsKICAgIH0gZWxzZSB7CiAgICAgIHByb3BzID0gcHJvcHMuc3BsaXQoIiAiKTsKICAgIH0KCiAgICB2YXIgcHJvcCwKICAgICAgaW5kZXggPSAwLAogICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CgogICAgZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CiAgICAgIHByb3AgPSBwcm9wc1sgaW5kZXggXTsKICAgICAgdHdlZW5lcnNbIHByb3AgXSA9IHR3ZWVuZXJzWyBwcm9wIF0gfHwgW107CiAgICAgIHR3ZWVuZXJzWyBwcm9wIF0udW5zaGlmdCggY2FsbGJhY2sgKTsKICAgIH0KICB9LAoKICBwcmVmaWx0ZXI6IGZ1bmN0aW9uKCBjYWxsYmFjaywgcHJlcGVuZCApIHsKICAgIGlmICggcHJlcGVuZCApIHsKICAgICAgYW5pbWF0aW9uUHJlZmlsdGVycy51bnNoaWZ0KCBjYWxsYmFjayApOwogICAgfSBlbHNlIHsKICAgICAgYW5pbWF0aW9uUHJlZmlsdGVycy5wdXNoKCBjYWxsYmFjayApOwogICAgfQogIH0KfSk7CgpmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKCBlbGVtLCBwcm9wcywgb3B0cyApIHsKICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogIHZhciBpbmRleCwgcHJvcCwgdmFsdWUsIGxlbmd0aCwgZGF0YVNob3csIHRvZ2dsZSwgdHdlZW4sIGhvb2tzLCBvbGRmaXJlLAogICAgYW5pbSA9IHRoaXMsCiAgICBzdHlsZSA9IGVsZW0uc3R5bGUsCiAgICBvcmlnID0ge30sCiAgICBoYW5kbGVkID0gW10sCiAgICBoaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuKCBlbGVtICk7CgogIC8vIGhhbmRsZSBxdWV1ZTogZmFsc2UgcHJvbWlzZXMKICBpZiAoICFvcHRzLnF1ZXVlICkgewogICAgaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sICJmeCIgKTsKICAgIGlmICggaG9va3MudW5xdWV1ZWQgPT0gbnVsbCApIHsKICAgICAgaG9va3MudW5xdWV1ZWQgPSAwOwogICAgICBvbGRmaXJlID0gaG9va3MuZW1wdHkuZmlyZTsKICAgICAgaG9va3MuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICggIWhvb2tzLnVucXVldWVkICkgewogICAgICAgICAgb2xkZmlyZSgpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIGhvb2tzLnVucXVldWVkKys7CgogICAgYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7CiAgICAgIC8vIGRvaW5nIHRoaXMgbWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wbGV0ZSBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkCiAgICAgIC8vIGJlZm9yZSB0aGlzIGNvbXBsZXRlcwogICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKICAgICAgICBob29rcy51bnF1ZXVlZC0tOwogICAgICAgIGlmICggIWpRdWVyeS5xdWV1ZSggZWxlbSwgImZ4IiApLmxlbmd0aCApIHsKICAgICAgICAgIGhvb2tzLmVtcHR5LmZpcmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAvLyBoZWlnaHQvd2lkdGggb3ZlcmZsb3cgcGFzcwogIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoICJoZWlnaHQiIGluIHByb3BzIHx8ICJ3aWR0aCIgaW4gcHJvcHMgKSApIHsKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAogICAgLy8gUmVjb3JkIGFsbCAzIG92ZXJmbG93IGF0dHJpYnV0ZXMgYmVjYXVzZSBJRSBkb2VzIG5vdAogICAgLy8gY2hhbmdlIHRoZSBvdmVyZmxvdyBhdHRyaWJ1dGUgd2hlbiBvdmVyZmxvd1ggYW5kCiAgICAvLyBvdmVyZmxvd1kgYXJlIHNldCB0byB0aGUgc2FtZSB2YWx1ZQogICAgb3B0cy5vdmVyZmxvdyA9IFsgc3R5bGUub3ZlcmZsb3csIHN0eWxlLm92ZXJmbG93WCwgc3R5bGUub3ZlcmZsb3dZIF07CgogICAgLy8gU2V0IGRpc3BsYXkgcHJvcGVydHkgdG8gaW5saW5lLWJsb2NrIGZvciBoZWlnaHQvd2lkdGgKICAgIC8vIGFuaW1hdGlvbnMgb24gaW5saW5lIGVsZW1lbnRzIHRoYXQgYXJlIGhhdmluZyB3aWR0aC9oZWlnaHQgYW5pbWF0ZWQKICAgIGlmICggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgPT09ICJpbmxpbmUiICYmCiAgICAgICAgalF1ZXJ5LmNzcyggZWxlbSwgImZsb2F0IiApID09PSAibm9uZSIgKSB7CgogICAgICAvLyBpbmxpbmUtbGV2ZWwgZWxlbWVudHMgYWNjZXB0IGlubGluZS1ibG9jazsKICAgICAgLy8gYmxvY2stbGV2ZWwgZWxlbWVudHMgbmVlZCB0byBiZSBpbmxpbmUgd2l0aCBsYXlvdXQKICAgICAgaWYgKCAhalF1ZXJ5LnN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCB8fCBjc3NfZGVmYXVsdERpc3BsYXkoIGVsZW0ubm9kZU5hbWUgKSA9PT0gImlubGluZSIgKSB7CiAgICAgICAgc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUtYmxvY2siOwoKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHlsZS56b29tID0gMTsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKCBvcHRzLm92ZXJmbG93ICkgewogICAgc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsKICAgIGlmICggIWpRdWVyeS5zdXBwb3J0LnNocmlua1dyYXBCbG9ja3MgKSB7CiAgICAgIGFuaW0uZG9uZShmdW5jdGlvbigpIHsKICAgICAgICBzdHlsZS5vdmVyZmxvdyA9IG9wdHMub3ZlcmZsb3dbIDAgXTsKICAgICAgICBzdHlsZS5vdmVyZmxvd1ggPSBvcHRzLm92ZXJmbG93WyAxIF07CiAgICAgICAgc3R5bGUub3ZlcmZsb3dZID0gb3B0cy5vdmVyZmxvd1sgMiBdOwogICAgICB9KTsKICAgIH0KICB9CgoKICAvLyBzaG93L2hpZGUgcGFzcwogIGZvciAoIGluZGV4IGluIHByb3BzICkgewogICAgdmFsdWUgPSBwcm9wc1sgaW5kZXggXTsKICAgIGlmICggcmZ4dHlwZXMuZXhlYyggdmFsdWUgKSApIHsKICAgICAgZGVsZXRlIHByb3BzWyBpbmRleCBdOwogICAgICB0b2dnbGUgPSB0b2dnbGUgfHwgdmFsdWUgPT09ICJ0b2dnbGUiOwogICAgICBpZiAoIHZhbHVlID09PSAoIGhpZGRlbiA/ICJoaWRlIiA6ICJzaG93IiApICkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGhhbmRsZWQucHVzaCggaW5kZXggKTsKICAgIH0KICB9CgogIGxlbmd0aCA9IGhhbmRsZWQubGVuZ3RoOwogIGlmICggbGVuZ3RoICkgewogICAgZGF0YVNob3cgPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJmeHNob3ciICkgfHwgalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiZnhzaG93Iiwge30gKTsKICAgIGlmICggImhpZGRlbiIgaW4gZGF0YVNob3cgKSB7CiAgICAgIGhpZGRlbiA9IGRhdGFTaG93LmhpZGRlbjsKICAgIH0KCiAgICAvLyBzdG9yZSBzdGF0ZSBpZiBpdHMgdG9nZ2xlIC0gZW5hYmxlcyAuc3RvcCgpLnRvZ2dsZSgpIHRvICJyZXZlcnNlIgogICAgaWYgKCB0b2dnbGUgKSB7CiAgICAgIGRhdGFTaG93LmhpZGRlbiA9ICFoaWRkZW47CiAgICB9CiAgICBpZiAoIGhpZGRlbiApIHsKICAgICAgalF1ZXJ5KCBlbGVtICkuc2hvdygpOwogICAgfSBlbHNlIHsKICAgICAgYW5pbS5kb25lKGZ1bmN0aW9uKCkgewogICAgICAgIGpRdWVyeSggZWxlbSApLmhpZGUoKTsKICAgICAgfSk7CiAgICB9CiAgICBhbmltLmRvbmUoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwcm9wOwogICAgICBqUXVlcnkuX3JlbW92ZURhdGEoIGVsZW0sICJmeHNob3ciICk7CiAgICAgIGZvciAoIHByb3AgaW4gb3JpZyApIHsKICAgICAgICBqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AsIG9yaWdbIHByb3AgXSApOwogICAgICB9CiAgICB9KTsKICAgIGZvciAoIGluZGV4ID0gMCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKICAgICAgcHJvcCA9IGhhbmRsZWRbIGluZGV4IF07CiAgICAgIHR3ZWVuID0gYW5pbS5jcmVhdGVUd2VlbiggcHJvcCwgaGlkZGVuID8gZGF0YVNob3dbIHByb3AgXSA6IDAgKTsKICAgICAgb3JpZ1sgcHJvcCBdID0gZGF0YVNob3dbIHByb3AgXSB8fCBqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AgKTsKCiAgICAgIGlmICggISggcHJvcCBpbiBkYXRhU2hvdyApICkgewogICAgICAgIGRhdGFTaG93WyBwcm9wIF0gPSB0d2Vlbi5zdGFydDsKICAgICAgICBpZiAoIGhpZGRlbiApIHsKICAgICAgICAgIHR3ZWVuLmVuZCA9IHR3ZWVuLnN0YXJ0OwogICAgICAgICAgdHdlZW4uc3RhcnQgPSBwcm9wID09PSAid2lkdGgiIHx8IHByb3AgPT09ICJoZWlnaHQiID8gMSA6IDA7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBUd2VlbiggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKSB7CiAgcmV0dXJuIG5ldyBUd2Vlbi5wcm90b3R5cGUuaW5pdCggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKTsKfQpqUXVlcnkuVHdlZW4gPSBUd2VlbjsKClR3ZWVuLnByb3RvdHlwZSA9IHsKICBjb25zdHJ1Y3RvcjogVHdlZW4sCiAgaW5pdDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0ICkgewogICAgdGhpcy5lbGVtID0gZWxlbTsKICAgIHRoaXMucHJvcCA9IHByb3A7CiAgICB0aGlzLmVhc2luZyA9IGVhc2luZyB8fCAic3dpbmciOwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCk7CiAgICB0aGlzLmVuZCA9IGVuZDsKICAgIHRoaXMudW5pdCA9IHVuaXQgfHwgKCBqUXVlcnkuY3NzTnVtYmVyWyBwcm9wIF0gPyAiIiA6ICJweCIgKTsKICB9LAogIGN1cjogZnVuY3Rpb24oKSB7CiAgICB2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbIHRoaXMucHJvcCBdOwoKICAgIHJldHVybiBob29rcyAmJiBob29rcy5nZXQgPwogICAgICBob29rcy5nZXQoIHRoaXMgKSA6CiAgICAgIFR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5nZXQoIHRoaXMgKTsKICB9LAogIHJ1bjogZnVuY3Rpb24oIHBlcmNlbnQgKSB7CiAgICB2YXIgZWFzZWQsCiAgICAgIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCiAgICBpZiAoIHRoaXMub3B0aW9ucy5kdXJhdGlvbiApIHsKICAgICAgdGhpcy5wb3MgPSBlYXNlZCA9IGpRdWVyeS5lYXNpbmdbIHRoaXMuZWFzaW5nIF0oCiAgICAgICAgcGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnBvcyA9IGVhc2VkID0gcGVyY2VudDsKICAgIH0KICAgIHRoaXMubm93ID0gKCB0aGlzLmVuZCAtIHRoaXMuc3RhcnQgKSAqIGVhc2VkICsgdGhpcy5zdGFydDsKCiAgICBpZiAoIHRoaXMub3B0aW9ucy5zdGVwICkgewogICAgICB0aGlzLm9wdGlvbnMuc3RlcC5jYWxsKCB0aGlzLmVsZW0sIHRoaXMubm93LCB0aGlzICk7CiAgICB9CgogICAgaWYgKCBob29rcyAmJiBob29rcy5zZXQgKSB7CiAgICAgIGhvb2tzLnNldCggdGhpcyApOwogICAgfSBlbHNlIHsKICAgICAgVHdlZW4ucHJvcEhvb2tzLl9kZWZhdWx0LnNldCggdGhpcyApOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9OwoKVHdlZW4ucHJvdG90eXBlLmluaXQucHJvdG90eXBlID0gVHdlZW4ucHJvdG90eXBlOwoKVHdlZW4ucHJvcEhvb2tzID0gewogIF9kZWZhdWx0OiB7CiAgICBnZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKICAgICAgdmFyIHJlc3VsdDsKCiAgICAgIGlmICggdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdICE9IG51bGwgJiYKICAgICAgICAoIXR3ZWVuLmVsZW0uc3R5bGUgfHwgdHdlZW4uZWxlbS5zdHlsZVsgdHdlZW4ucHJvcCBdID09IG51bGwpICkgewogICAgICAgIHJldHVybiB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF07CiAgICAgIH0KCiAgICAgIC8vIHBhc3NpbmcgYSBub24gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQogICAgICAvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzCiAgICAgIC8vIHNvLCBzaW1wbGUgdmFsdWVzIHN1Y2ggYXMgIjEwcHgiIGFyZSBwYXJzZWQgdG8gRmxvYXQuCiAgICAgIC8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzIGlzLgogICAgICByZXN1bHQgPSBqUXVlcnkuY3NzKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCAiYXV0byIgKTsKICAgICAgLy8gRW1wdHkgc3RyaW5ncywgbnVsbCwgdW5kZWZpbmVkIGFuZCAiYXV0byIgYXJlIGNvbnZlcnRlZCB0byAwLgogICAgICByZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICJhdXRvIiA/IDAgOiByZXN1bHQ7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiggdHdlZW4gKSB7CiAgICAgIC8vIHVzZSBzdGVwIGhvb2sgZm9yIGJhY2sgY29tcGF0IC0gdXNlIGNzc0hvb2sgaWYgaXRzIHRoZXJlIC0gdXNlIC5zdHlsZSBpZiBpdHMKICAgICAgLy8gYXZhaWxhYmxlIGFuZCB1c2UgcGxhaW4gcHJvcGVydGllcyB3aGVyZSBhdmFpbGFibGUKICAgICAgaWYgKCBqUXVlcnkuZnguc3RlcFsgdHdlZW4ucHJvcCBdICkgewogICAgICAgIGpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0oIHR3ZWVuICk7CiAgICAgIH0gZWxzZSBpZiAoIHR3ZWVuLmVsZW0uc3R5bGUgJiYgKCB0d2Vlbi5lbGVtLnN0eWxlWyBqUXVlcnkuY3NzUHJvcHNbIHR3ZWVuLnByb3AgXSBdICE9IG51bGwgfHwgalF1ZXJ5LmNzc0hvb2tzWyB0d2Vlbi5wcm9wIF0gKSApIHsKICAgICAgICBqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsIHR3ZWVuLm5vdyArIHR3ZWVuLnVuaXQgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gPSB0d2Vlbi5ub3c7CiAgICAgIH0KICAgIH0KICB9Cn07CgovLyBSZW1vdmUgaW4gMi4wIC0gdGhpcyBzdXBwb3J0cyBJRTgncyBwYW5pYyBiYXNlZCBhcHByb2FjaAovLyB0byBzZXR0aW5nIHRoaW5ncyBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKClR3ZWVuLnByb3BIb29rcy5zY3JvbGxUb3AgPSBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9IHsKICBzZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKICAgIGlmICggdHdlZW4uZWxlbS5ub2RlVHlwZSAmJiB0d2Vlbi5lbGVtLnBhcmVudE5vZGUgKSB7CiAgICAgIHR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsKICAgIH0KICB9Cn07CgpqUXVlcnkuZWFjaChbICJ0b2dnbGUiLCAic2hvdyIsICJoaWRlIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKICB2YXIgY3NzRm4gPSBqUXVlcnkuZm5bIG5hbWUgXTsKICBqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKICAgIHJldHVybiBzcGVlZCA9PSBudWxsIHx8IHR5cGVvZiBzcGVlZCA9PT0gImJvb2xlYW4iID8KICAgICAgY3NzRm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApIDoKICAgICAgdGhpcy5hbmltYXRlKCBnZW5GeCggbmFtZSwgdHJ1ZSApLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwogIH07Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CiAgZmFkZVRvOiBmdW5jdGlvbiggc3BlZWQsIHRvLCBlYXNpbmcsIGNhbGxiYWNrICkgewoKICAgIC8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAogICAgcmV0dXJuIHRoaXMuZmlsdGVyKCBpc0hpZGRlbiApLmNzcyggIm9wYWNpdHkiLCAwICkuc2hvdygpCgogICAgICAvLyBhbmltYXRlIHRvIHRoZSB2YWx1ZSBzcGVjaWZpZWQKICAgICAgLmVuZCgpLmFuaW1hdGUoeyBvcGFjaXR5OiB0byB9LCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwogIH0sCiAgYW5pbWF0ZTogZnVuY3Rpb24oIHByb3AsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewogICAgdmFyIGVtcHR5ID0galF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3AgKSwKICAgICAgb3B0YWxsID0galF1ZXJ5LnNwZWVkKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApLAogICAgICBkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIE9wZXJhdGUgb24gYSBjb3B5IG9mIHByb3Agc28gcGVyLXByb3BlcnR5IGVhc2luZyB3b24ndCBiZSBsb3N0CiAgICAgICAgdmFyIGFuaW0gPSBBbmltYXRpb24oIHRoaXMsIGpRdWVyeS5leHRlbmQoIHt9LCBwcm9wICksIG9wdGFsbCApOwogICAgICAgIGRvQW5pbWF0aW9uLmZpbmlzaCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgYW5pbS5zdG9wKCB0cnVlICk7CiAgICAgICAgfTsKICAgICAgICAvLyBFbXB0eSBhbmltYXRpb25zLCBvciBmaW5pc2hpbmcgcmVzb2x2ZXMgaW1tZWRpYXRlbHkKICAgICAgICBpZiAoIGVtcHR5IHx8IGpRdWVyeS5fZGF0YSggdGhpcywgImZpbmlzaCIgKSApIHsKICAgICAgICAgIGFuaW0uc3RvcCggdHJ1ZSApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZG9BbmltYXRpb24uZmluaXNoID0gZG9BbmltYXRpb247CgogICAgcmV0dXJuIGVtcHR5IHx8IG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPwogICAgICB0aGlzLmVhY2goIGRvQW5pbWF0aW9uICkgOgogICAgICB0aGlzLnF1ZXVlKCBvcHRhbGwucXVldWUsIGRvQW5pbWF0aW9uICk7CiAgfSwKICBzdG9wOiBmdW5jdGlvbiggdHlwZSwgY2xlYXJRdWV1ZSwgZ290b0VuZCApIHsKICAgIHZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiggaG9va3MgKSB7CiAgICAgIHZhciBzdG9wID0gaG9va3Muc3RvcDsKICAgICAgZGVsZXRlIGhvb2tzLnN0b3A7CiAgICAgIHN0b3AoIGdvdG9FbmQgKTsKICAgIH07CgogICAgaWYgKCB0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIgKSB7CiAgICAgIGdvdG9FbmQgPSBjbGVhclF1ZXVlOwogICAgICBjbGVhclF1ZXVlID0gdHlwZTsKICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgIH0KICAgIGlmICggY2xlYXJRdWV1ZSAmJiB0eXBlICE9PSBmYWxzZSApIHsKICAgICAgdGhpcy5xdWV1ZSggdHlwZSB8fCAiZngiLCBbXSApOwogICAgfQoKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgIHZhciBkZXF1ZXVlID0gdHJ1ZSwKICAgICAgICBpbmRleCA9IHR5cGUgIT0gbnVsbCAmJiB0eXBlICsgInF1ZXVlSG9va3MiLAogICAgICAgIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsCiAgICAgICAgZGF0YSA9IGpRdWVyeS5fZGF0YSggdGhpcyApOwoKICAgICAgaWYgKCBpbmRleCApIHsKICAgICAgICBpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICkgewogICAgICAgICAgc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoIGluZGV4IGluIGRhdGEgKSB7CiAgICAgICAgICBpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICYmIHJydW4udGVzdCggaW5kZXggKSApIHsKICAgICAgICAgICAgc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKCBpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07ICkgewogICAgICAgIGlmICggdGltZXJzWyBpbmRleCBdLmVsZW0gPT09IHRoaXMgJiYgKHR5cGUgPT0gbnVsbCB8fCB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUpICkgewogICAgICAgICAgdGltZXJzWyBpbmRleCBdLmFuaW0uc3RvcCggZ290b0VuZCApOwogICAgICAgICAgZGVxdWV1ZSA9IGZhbHNlOwogICAgICAgICAgdGltZXJzLnNwbGljZSggaW5kZXgsIDEgKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIHN0YXJ0IHRoZSBuZXh0IGluIHRoZSBxdWV1ZSBpZiB0aGUgbGFzdCBzdGVwIHdhc24ndCBmb3JjZWQKICAgICAgLy8gdGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaCB3aWxsIGRlcXVldWUKICAgICAgLy8gYnV0IG9ubHkgaWYgdGhleSB3ZXJlIGdvdG9FbmQKICAgICAgaWYgKCBkZXF1ZXVlIHx8ICFnb3RvRW5kICkgewogICAgICAgIGpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CiAgICAgIH0KICAgIH0pOwogIH0sCiAgZmluaXNoOiBmdW5jdGlvbiggdHlwZSApIHsKICAgIGlmICggdHlwZSAhPT0gZmFsc2UgKSB7CiAgICAgIHR5cGUgPSB0eXBlIHx8ICJmeCI7CiAgICB9CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICB2YXIgaW5kZXgsCiAgICAgICAgZGF0YSA9IGpRdWVyeS5fZGF0YSggdGhpcyApLAogICAgICAgIHF1ZXVlID0gZGF0YVsgdHlwZSArICJxdWV1ZSIgXSwKICAgICAgICBob29rcyA9IGRhdGFbIHR5cGUgKyAicXVldWVIb29rcyIgXSwKICAgICAgICB0aW1lcnMgPSBqUXVlcnkudGltZXJzLAogICAgICAgIGxlbmd0aCA9IHF1ZXVlID8gcXVldWUubGVuZ3RoIDogMDsKCiAgICAgIC8vIGVuYWJsZSBmaW5pc2hpbmcgZmxhZyBvbiBwcml2YXRlIGRhdGEKICAgICAgZGF0YS5maW5pc2ggPSB0cnVlOwoKICAgICAgLy8gZW1wdHkgdGhlIHF1ZXVlIGZpcnN0CiAgICAgIGpRdWVyeS5xdWV1ZSggdGhpcywgdHlwZSwgW10gKTsKCiAgICAgIGlmICggaG9va3MgJiYgaG9va3MuY3VyICYmIGhvb2tzLmN1ci5maW5pc2ggKSB7CiAgICAgICAgaG9va3MuY3VyLmZpbmlzaC5jYWxsKCB0aGlzICk7CiAgICAgIH0KCiAgICAgIC8vIGxvb2sgZm9yIGFueSBhY3RpdmUgYW5pbWF0aW9ucywgYW5kIGZpbmlzaCB0aGVtCiAgICAgIGZvciAoIGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTsgKSB7CiAgICAgICAgaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJiB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUgKSB7CiAgICAgICAgICB0aW1lcnNbIGluZGV4IF0uYW5pbS5zdG9wKCB0cnVlICk7CiAgICAgICAgICB0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gbG9vayBmb3IgYW55IGFuaW1hdGlvbnMgaW4gdGhlIG9sZCBxdWV1ZSBhbmQgZmluaXNoIHRoZW0KICAgICAgZm9yICggaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKICAgICAgICBpZiAoIHF1ZXVlWyBpbmRleCBdICYmIHF1ZXVlWyBpbmRleCBdLmZpbmlzaCApIHsKICAgICAgICAgIHF1ZXVlWyBpbmRleCBdLmZpbmlzaC5jYWxsKCB0aGlzICk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyB0dXJuIG9mZiBmaW5pc2hpbmcgZmxhZwogICAgICBkZWxldGUgZGF0YS5maW5pc2g7CiAgICB9KTsKICB9Cn0pOwoKLy8gR2VuZXJhdGUgcGFyYW1ldGVycyB0byBjcmVhdGUgYSBzdGFuZGFyZCBhbmltYXRpb24KZnVuY3Rpb24gZ2VuRngoIHR5cGUsIGluY2x1ZGVXaWR0aCApIHsKICB2YXIgd2hpY2gsCiAgICBhdHRycyA9IHsgaGVpZ2h0OiB0eXBlIH0sCiAgICBpID0gMDsKCiAgLy8gaWYgd2UgaW5jbHVkZSB3aWR0aCwgc3RlcCB2YWx1ZSBpcyAxIHRvIGRvIGFsbCBjc3NFeHBhbmQgdmFsdWVzLAogIC8vIGlmIHdlIGRvbid0IGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKICBpbmNsdWRlV2lkdGggPSBpbmNsdWRlV2lkdGg/IDEgOiAwOwogIGZvciggOyBpIDwgNCA7IGkgKz0gMiAtIGluY2x1ZGVXaWR0aCApIHsKICAgIHdoaWNoID0gY3NzRXhwYW5kWyBpIF07CiAgICBhdHRyc1sgIm1hcmdpbiIgKyB3aGljaCBdID0gYXR0cnNbICJwYWRkaW5nIiArIHdoaWNoIF0gPSB0eXBlOwogIH0KCiAgaWYgKCBpbmNsdWRlV2lkdGggKSB7CiAgICBhdHRycy5vcGFjaXR5ID0gYXR0cnMud2lkdGggPSB0eXBlOwogIH0KCiAgcmV0dXJuIGF0dHJzOwp9CgovLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCmpRdWVyeS5lYWNoKHsKICBzbGlkZURvd246IGdlbkZ4KCJzaG93IiksCiAgc2xpZGVVcDogZ2VuRngoImhpZGUiKSwKICBzbGlkZVRvZ2dsZTogZ2VuRngoInRvZ2dsZSIpLAogIGZhZGVJbjogeyBvcGFjaXR5OiAic2hvdyIgfSwKICBmYWRlT3V0OiB7IG9wYWNpdHk6ICJoaWRlIiB9LAogIGZhZGVUb2dnbGU6IHsgb3BhY2l0eTogInRvZ2dsZSIgfQp9LCBmdW5jdGlvbiggbmFtZSwgcHJvcHMgKSB7CiAgalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CiAgICByZXR1cm4gdGhpcy5hbmltYXRlKCBwcm9wcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKICB9Owp9KTsKCmpRdWVyeS5zcGVlZCA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBmbiApIHsKICB2YXIgb3B0ID0gc3BlZWQgJiYgdHlwZW9mIHNwZWVkID09PSAib2JqZWN0IiA/IGpRdWVyeS5leHRlbmQoIHt9LCBzcGVlZCApIDogewogICAgY29tcGxldGU6IGZuIHx8ICFmbiAmJiBlYXNpbmcgfHwKICAgICAgalF1ZXJ5LmlzRnVuY3Rpb24oIHNwZWVkICkgJiYgc3BlZWQsCiAgICBkdXJhdGlvbjogc3BlZWQsCiAgICBlYXNpbmc6IGZuICYmIGVhc2luZyB8fCBlYXNpbmcgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKCBlYXNpbmcgKSAmJiBlYXNpbmcKICB9OwoKICBvcHQuZHVyYXRpb24gPSBqUXVlcnkuZngub2ZmID8gMCA6IHR5cGVvZiBvcHQuZHVyYXRpb24gPT09ICJudW1iZXIiID8gb3B0LmR1cmF0aW9uIDoKICAgIG9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzID8galF1ZXJ5LmZ4LnNwZWVkc1sgb3B0LmR1cmF0aW9uIF0gOiBqUXVlcnkuZnguc3BlZWRzLl9kZWZhdWx0OwoKICAvLyBub3JtYWxpemUgb3B0LnF1ZXVlIC0gdHJ1ZS91bmRlZmluZWQvbnVsbCAtPiAiZngiCiAgaWYgKCBvcHQucXVldWUgPT0gbnVsbCB8fCBvcHQucXVldWUgPT09IHRydWUgKSB7CiAgICBvcHQucXVldWUgPSAiZngiOwogIH0KCiAgLy8gUXVldWVpbmcKICBvcHQub2xkID0gb3B0LmNvbXBsZXRlOwoKICBvcHQuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgIGlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIG9wdC5vbGQgKSApIHsKICAgICAgb3B0Lm9sZC5jYWxsKCB0aGlzICk7CiAgICB9CgogICAgaWYgKCBvcHQucXVldWUgKSB7CiAgICAgIGpRdWVyeS5kZXF1ZXVlKCB0aGlzLCBvcHQucXVldWUgKTsKICAgIH0KICB9OwoKICByZXR1cm4gb3B0Owp9OwoKalF1ZXJ5LmVhc2luZyA9IHsKICBsaW5lYXI6IGZ1bmN0aW9uKCBwICkgewogICAgcmV0dXJuIHA7CiAgfSwKICBzd2luZzogZnVuY3Rpb24oIHAgKSB7CiAgICByZXR1cm4gMC41IC0gTWF0aC5jb3MoIHAqTWF0aC5QSSApIC8gMjsKICB9Cn07CgpqUXVlcnkudGltZXJzID0gW107CmpRdWVyeS5meCA9IFR3ZWVuLnByb3RvdHlwZS5pbml0OwpqUXVlcnkuZngudGljayA9IGZ1bmN0aW9uKCkgewogIHZhciB0aW1lciwKICAgIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsCiAgICBpID0gMDsKCiAgZnhOb3cgPSBqUXVlcnkubm93KCk7CgogIGZvciAoIDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKyApIHsKICAgIHRpbWVyID0gdGltZXJzWyBpIF07CiAgICAvLyBDaGVja3MgdGhlIHRpbWVyIGhhcyBub3QgYWxyZWFkeSBiZWVuIHJlbW92ZWQKICAgIGlmICggIXRpbWVyKCkgJiYgdGltZXJzWyBpIF0gPT09IHRpbWVyICkgewogICAgICB0aW1lcnMuc3BsaWNlKCBpLS0sIDEgKTsKICAgIH0KICB9CgogIGlmICggIXRpbWVycy5sZW5ndGggKSB7CiAgICBqUXVlcnkuZnguc3RvcCgpOwogIH0KICBmeE5vdyA9IHVuZGVmaW5lZDsKfTsKCmpRdWVyeS5meC50aW1lciA9IGZ1bmN0aW9uKCB0aW1lciApIHsKICBpZiAoIHRpbWVyKCkgJiYgalF1ZXJ5LnRpbWVycy5wdXNoKCB0aW1lciApICkgewogICAgalF1ZXJ5LmZ4LnN0YXJ0KCk7CiAgfQp9OwoKalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7CgpqUXVlcnkuZnguc3RhcnQgPSBmdW5jdGlvbigpIHsKICBpZiAoICF0aW1lcklkICkgewogICAgdGltZXJJZCA9IHNldEludGVydmFsKCBqUXVlcnkuZngudGljaywgalF1ZXJ5LmZ4LmludGVydmFsICk7CiAgfQp9OwoKalF1ZXJ5LmZ4LnN0b3AgPSBmdW5jdGlvbigpIHsKICBjbGVhckludGVydmFsKCB0aW1lcklkICk7CiAgdGltZXJJZCA9IG51bGw7Cn07CgpqUXVlcnkuZnguc3BlZWRzID0gewogIHNsb3c6IDYwMCwKICBmYXN0OiAyMDAsCiAgLy8gRGVmYXVsdCBzcGVlZAogIF9kZWZhdWx0OiA0MDAKfTsKCi8vIEJhY2sgQ29tcGF0IDwxLjggZXh0ZW5zaW9uIHBvaW50CmpRdWVyeS5meC5zdGVwID0ge307CgppZiAoIGpRdWVyeS5leHByICYmIGpRdWVyeS5leHByLmZpbHRlcnMgKSB7CiAgalF1ZXJ5LmV4cHIuZmlsdGVycy5hbmltYXRlZCA9IGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGpRdWVyeS5ncmVwKGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uKCBmbiApIHsKICAgICAgcmV0dXJuIGVsZW0gPT09IGZuLmVsZW07CiAgICB9KS5sZW5ndGg7CiAgfTsKfQpqUXVlcnkuZm4ub2Zmc2V0ID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CiAgaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewogICAgcmV0dXJuIG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/CiAgICAgIHRoaXMgOgogICAgICB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CiAgICAgICAgalF1ZXJ5Lm9mZnNldC5zZXRPZmZzZXQoIHRoaXMsIG9wdGlvbnMsIGkgKTsKICAgICAgfSk7CiAgfQoKICB2YXIgZG9jRWxlbSwgd2luLAogICAgYm94ID0geyB0b3A6IDAsIGxlZnQ6IDAgfSwKICAgIGVsZW0gPSB0aGlzWyAwIF0sCiAgICBkb2MgPSBlbGVtICYmIGVsZW0ub3duZXJEb2N1bWVudDsKCiAgaWYgKCAhZG9jICkgewogICAgcmV0dXJuOwogIH0KCiAgZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQ7CgogIC8vIE1ha2Ugc3VyZSBpdCdzIG5vdCBhIGRpc2Nvbm5lY3RlZCBET00gbm9kZQogIGlmICggIWpRdWVyeS5jb250YWlucyggZG9jRWxlbSwgZWxlbSApICkgewogICAgcmV0dXJuIGJveDsKICB9CgogIC8vIElmIHdlIGRvbid0IGhhdmUgZ0JDUiwganVzdCB1c2UgMCwwIHJhdGhlciB0aGFuIGVycm9yCiAgLy8gQmxhY2tCZXJyeSA1LCBpT1MgMyAob3JpZ2luYWwgaVBob25lKQogIGlmICggdHlwZW9mIGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIiApIHsKICAgIGJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgfQogIHdpbiA9IGdldFdpbmRvdyggZG9jICk7CiAgcmV0dXJuIHsKICAgIHRvcDogYm94LnRvcCAgKyAoIHdpbi5wYWdlWU9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbFRvcCApICAtICggZG9jRWxlbS5jbGllbnRUb3AgIHx8IDAgKSwKICAgIGxlZnQ6IGJveC5sZWZ0ICsgKCB3aW4ucGFnZVhPZmZzZXQgfHwgZG9jRWxlbS5zY3JvbGxMZWZ0ICkgLSAoIGRvY0VsZW0uY2xpZW50TGVmdCB8fCAwICkKICB9Owp9OwoKalF1ZXJ5Lm9mZnNldCA9IHsKCiAgc2V0T2Zmc2V0OiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgaSApIHsKICAgIHZhciBwb3NpdGlvbiA9IGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKTsKCiAgICAvLyBzZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCiAgICBpZiAoIHBvc2l0aW9uID09PSAic3RhdGljIiApIHsKICAgICAgZWxlbS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgICB9CgogICAgdmFyIGN1ckVsZW0gPSBqUXVlcnkoIGVsZW0gKSwKICAgICAgY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKSwKICAgICAgY3VyQ1NTVG9wID0galF1ZXJ5LmNzcyggZWxlbSwgInRvcCIgKSwKICAgICAgY3VyQ1NTTGVmdCA9IGpRdWVyeS5jc3MoIGVsZW0sICJsZWZ0IiApLAogICAgICBjYWxjdWxhdGVQb3NpdGlvbiA9ICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSAmJiBqUXVlcnkuaW5BcnJheSgiYXV0byIsIFtjdXJDU1NUb3AsIGN1ckNTU0xlZnRdKSA+IC0xLAogICAgICBwcm9wcyA9IHt9LCBjdXJQb3NpdGlvbiA9IHt9LCBjdXJUb3AsIGN1ckxlZnQ7CgogICAgLy8gbmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIgdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCiAgICBpZiAoIGNhbGN1bGF0ZVBvc2l0aW9uICkgewogICAgICBjdXJQb3NpdGlvbiA9IGN1ckVsZW0ucG9zaXRpb24oKTsKICAgICAgY3VyVG9wID0gY3VyUG9zaXRpb24udG9wOwogICAgICBjdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKICAgIH0gZWxzZSB7CiAgICAgIGN1clRvcCA9IHBhcnNlRmxvYXQoIGN1ckNTU1RvcCApIHx8IDA7CiAgICAgIGN1ckxlZnQgPSBwYXJzZUZsb2F0KCBjdXJDU1NMZWZ0ICkgfHwgMDsKICAgIH0KCiAgICBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBvcHRpb25zICkgKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zLmNhbGwoIGVsZW0sIGksIGN1ck9mZnNldCApOwogICAgfQoKICAgIGlmICggb3B0aW9ucy50b3AgIT0gbnVsbCApIHsKICAgICAgcHJvcHMudG9wID0gKCBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKSArIGN1clRvcDsKICAgIH0KICAgIGlmICggb3B0aW9ucy5sZWZ0ICE9IG51bGwgKSB7CiAgICAgIHByb3BzLmxlZnQgPSAoIG9wdGlvbnMubGVmdCAtIGN1ck9mZnNldC5sZWZ0ICkgKyBjdXJMZWZ0OwogICAgfQoKICAgIGlmICggInVzaW5nIiBpbiBvcHRpb25zICkgewogICAgICBvcHRpb25zLnVzaW5nLmNhbGwoIGVsZW0sIHByb3BzICk7CiAgICB9IGVsc2UgewogICAgICBjdXJFbGVtLmNzcyggcHJvcHMgKTsKICAgIH0KICB9Cn07CgoKalF1ZXJ5LmZuLmV4dGVuZCh7CgogIHBvc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgIGlmICggIXRoaXNbIDAgXSApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBvZmZzZXRQYXJlbnQsIG9mZnNldCwKICAgICAgcGFyZW50T2Zmc2V0ID0geyB0b3A6IDAsIGxlZnQ6IDAgfSwKICAgICAgZWxlbSA9IHRoaXNbIDAgXTsKCiAgICAvLyBmaXhlZCBlbGVtZW50cyBhcmUgb2Zmc2V0IGZyb20gd2luZG93IChwYXJlbnRPZmZzZXQgPSB7dG9wOjAsIGxlZnQ6IDB9LCBiZWNhdXNlIGl0IGlzIGl0J3Mgb25seSBvZmZzZXQgcGFyZW50CiAgICBpZiAoIGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKSA9PT0gImZpeGVkIiApIHsKICAgICAgLy8gd2UgYXNzdW1lIHRoYXQgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IGlzIGF2YWlsYWJsZSB3aGVuIGNvbXB1dGVkIHBvc2l0aW9uIGlzIGZpeGVkCiAgICAgIG9mZnNldCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB9IGVsc2UgewogICAgICAvLyBHZXQgKnJlYWwqIG9mZnNldFBhcmVudAogICAgICBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpOwoKICAgICAgLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwogICAgICBvZmZzZXQgPSB0aGlzLm9mZnNldCgpOwogICAgICBpZiAoICFqUXVlcnkubm9kZU5hbWUoIG9mZnNldFBhcmVudFsgMCBdLCAiaHRtbCIgKSApIHsKICAgICAgICBwYXJlbnRPZmZzZXQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0KCk7CiAgICAgIH0KCiAgICAgIC8vIEFkZCBvZmZzZXRQYXJlbnQgYm9yZGVycwogICAgICBwYXJlbnRPZmZzZXQudG9wICArPSBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnRbIDAgXSwgImJvcmRlclRvcFdpZHRoIiwgdHJ1ZSApOwogICAgICBwYXJlbnRPZmZzZXQubGVmdCArPSBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnRbIDAgXSwgImJvcmRlckxlZnRXaWR0aCIsIHRydWUgKTsKICAgIH0KCiAgICAvLyBTdWJ0cmFjdCBwYXJlbnQgb2Zmc2V0cyBhbmQgZWxlbWVudCBtYXJnaW5zCiAgICAvLyBub3RlOiB3aGVuIGFuIGVsZW1lbnQgaGFzIG1hcmdpbjogYXV0byB0aGUgb2Zmc2V0TGVmdCBhbmQgbWFyZ2luTGVmdAogICAgLy8gYXJlIHRoZSBzYW1lIGluIFNhZmFyaSBjYXVzaW5nIG9mZnNldC5sZWZ0IHRvIGluY29ycmVjdGx5IGJlIDAKICAgIHJldHVybiB7CiAgICAgIHRvcDogIG9mZnNldC50b3AgIC0gcGFyZW50T2Zmc2V0LnRvcCAtIGpRdWVyeS5jc3MoIGVsZW0sICJtYXJnaW5Ub3AiLCB0cnVlICksCiAgICAgIGxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luTGVmdCIsIHRydWUpCiAgICB9OwogIH0sCgogIG9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICAgIHdoaWxlICggb2Zmc2V0UGFyZW50ICYmICggIWpRdWVyeS5ub2RlTmFtZSggb2Zmc2V0UGFyZW50LCAiaHRtbCIgKSAmJiBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIiApICkgewogICAgICAgIG9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CiAgICAgIH0KICAgICAgcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICB9KTsKICB9Cn0pOwoKCi8vIENyZWF0ZSBzY3JvbGxMZWZ0IGFuZCBzY3JvbGxUb3AgbWV0aG9kcwpqUXVlcnkuZWFjaCgge3Njcm9sbExlZnQ6ICJwYWdlWE9mZnNldCIsIHNjcm9sbFRvcDogInBhZ2VZT2Zmc2V0In0sIGZ1bmN0aW9uKCBtZXRob2QsIHByb3AgKSB7CiAgdmFyIHRvcCA9IC9ZLy50ZXN0KCBwcm9wICk7CgogIGpRdWVyeS5mblsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdmFsICkgewogICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBtZXRob2QsIHZhbCApIHsKICAgICAgdmFyIHdpbiA9IGdldFdpbmRvdyggZWxlbSApOwoKICAgICAgaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsKICAgICAgICByZXR1cm4gd2luID8gKHByb3AgaW4gd2luKSA/IHdpblsgcHJvcCBdIDoKICAgICAgICAgIHdpbi5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbIG1ldGhvZCBdIDoKICAgICAgICAgIGVsZW1bIG1ldGhvZCBdOwogICAgICB9CgogICAgICBpZiAoIHdpbiApIHsKICAgICAgICB3aW4uc2Nyb2xsVG8oCiAgICAgICAgICAhdG9wID8gdmFsIDogalF1ZXJ5KCB3aW4gKS5zY3JvbGxMZWZ0KCksCiAgICAgICAgICB0b3AgPyB2YWwgOiBqUXVlcnkoIHdpbiApLnNjcm9sbFRvcCgpCiAgICAgICAgKTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWxlbVsgbWV0aG9kIF0gPSB2YWw7CiAgICAgIH0KICAgIH0sIG1ldGhvZCwgdmFsLCBhcmd1bWVudHMubGVuZ3RoLCBudWxsICk7CiAgfTsKfSk7CgpmdW5jdGlvbiBnZXRXaW5kb3coIGVsZW0gKSB7CiAgcmV0dXJuIGpRdWVyeS5pc1dpbmRvdyggZWxlbSApID8KICAgIGVsZW0gOgogICAgZWxlbS5ub2RlVHlwZSA9PT0gOSA/CiAgICAgIGVsZW0uZGVmYXVsdFZpZXcgfHwgZWxlbS5wYXJlbnRXaW5kb3cgOgogICAgICBmYWxzZTsKfQovLyBDcmVhdGUgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGgsIGhlaWdodCwgd2lkdGgsIG91dGVySGVpZ2h0IGFuZCBvdXRlcldpZHRoIG1ldGhvZHMKalF1ZXJ5LmVhY2goIHsgSGVpZ2h0OiAiaGVpZ2h0IiwgV2lkdGg6ICJ3aWR0aCIgfSwgZnVuY3Rpb24oIG5hbWUsIHR5cGUgKSB7CiAgalF1ZXJ5LmVhY2goIHsgcGFkZGluZzogImlubmVyIiArIG5hbWUsIGNvbnRlbnQ6IHR5cGUsICIiOiAib3V0ZXIiICsgbmFtZSB9LCBmdW5jdGlvbiggZGVmYXVsdEV4dHJhLCBmdW5jTmFtZSApIHsKICAgIC8vIG1hcmdpbiBpcyBvbmx5IGZvciBvdXRlckhlaWdodCwgb3V0ZXJXaWR0aAogICAgalF1ZXJ5LmZuWyBmdW5jTmFtZSBdID0gZnVuY3Rpb24oIG1hcmdpbiwgdmFsdWUgKSB7CiAgICAgIHZhciBjaGFpbmFibGUgPSBhcmd1bWVudHMubGVuZ3RoICYmICggZGVmYXVsdEV4dHJhIHx8IHR5cGVvZiBtYXJnaW4gIT09ICJib29sZWFuIiApLAogICAgICAgIGV4dHJhID0gZGVmYXVsdEV4dHJhIHx8ICggbWFyZ2luID09PSB0cnVlIHx8IHZhbHVlID09PSB0cnVlID8gIm1hcmdpbiIgOiAiYm9yZGVyIiApOwoKICAgICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCB2YWx1ZSApIHsKICAgICAgICB2YXIgZG9jOwoKICAgICAgICBpZiAoIGpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewogICAgICAgICAgLy8gQXMgb2YgNS84LzIwMTIgdGhpcyB3aWxsIHlpZWxkIGluY29ycmVjdCByZXN1bHRzIGZvciBNb2JpbGUgU2FmYXJpLCBidXQgdGhlcmUKICAgICAgICAgIC8vIGlzbid0IGEgd2hvbGUgbG90IHdlIGNhbiBkby4gU2VlIHB1bGwgcmVxdWVzdCBhdCB0aGlzIFVSTCBmb3IgZGlzY3Vzc2lvbjoKICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNzY0CiAgICAgICAgICByZXR1cm4gZWxlbS5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbICJjbGllbnQiICsgbmFtZSBdOwogICAgICAgIH0KCiAgICAgICAgLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodAogICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsKICAgICAgICAgIGRvYyA9IGVsZW0uZG9jdW1lbnRFbGVtZW50OwoKICAgICAgICAgIC8vIEVpdGhlciBzY3JvbGxbV2lkdGgvSGVpZ2h0XSBvciBvZmZzZXRbV2lkdGgvSGVpZ2h0XSBvciBjbGllbnRbV2lkdGgvSGVpZ2h0XSwgd2hpY2hldmVyIGlzIGdyZWF0ZXN0CiAgICAgICAgICAvLyB1bmZvcnR1bmF0ZWx5LCB0aGlzIGNhdXNlcyBidWcgIzM4MzggaW4gSUU2Lzggb25seSwgYnV0IHRoZXJlIGlzIGN1cnJlbnRseSBubyBnb29kLCBzbWFsbCB3YXkgdG8gZml4IGl0LgogICAgICAgICAgcmV0dXJuIE1hdGgubWF4KAogICAgICAgICAgICBlbGVtLmJvZHlbICJzY3JvbGwiICsgbmFtZSBdLCBkb2NbICJzY3JvbGwiICsgbmFtZSBdLAogICAgICAgICAgICBlbGVtLmJvZHlbICJvZmZzZXQiICsgbmFtZSBdLCBkb2NbICJvZmZzZXQiICsgbmFtZSBdLAogICAgICAgICAgICBkb2NbICJjbGllbnQiICsgbmFtZSBdCiAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwogICAgICAgICAgLy8gR2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCwgcmVxdWVzdGluZyBidXQgbm90IGZvcmNpbmcgcGFyc2VGbG9hdAogICAgICAgICAgalF1ZXJ5LmNzcyggZWxlbSwgdHlwZSwgZXh0cmEgKSA6CgogICAgICAgICAgLy8gU2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudAogICAgICAgICAgalF1ZXJ5LnN0eWxlKCBlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEgKTsKICAgICAgfSwgdHlwZSwgY2hhaW5hYmxlID8gbWFyZ2luIDogdW5kZWZpbmVkLCBjaGFpbmFibGUsIG51bGwgKTsKICAgIH07CiAgfSk7Cn0pOwovLyBMaW1pdCBzY29wZSBwb2xsdXRpb24gZnJvbSBhbnkgZGVwcmVjYXRlZCBBUEkKLy8gKGZ1bmN0aW9uKCkgewoKLy8gfSkoKTsKLy8gRXhwb3NlIGpRdWVyeSB0byB0aGUgZ2xvYmFsIG9iamVjdAp3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7CgovLyBFeHBvc2UgalF1ZXJ5IGFzIGFuIEFNRCBtb2R1bGUsIGJ1dCBvbmx5IGZvciBBTUQgbG9hZGVycyB0aGF0Ci8vIHVuZGVyc3RhbmQgdGhlIGlzc3VlcyB3aXRoIGxvYWRpbmcgbXVsdGlwbGUgdmVyc2lvbnMgb2YgalF1ZXJ5Ci8vIGluIGEgcGFnZSB0aGF0IGFsbCBtaWdodCBjYWxsIGRlZmluZSgpLiBUaGUgbG9hZGVyIHdpbGwgaW5kaWNhdGUKLy8gdGhleSBoYXZlIHNwZWNpYWwgYWxsb3dhbmNlcyBmb3IgbXVsdGlwbGUgalF1ZXJ5IHZlcnNpb25zIGJ5Ci8vIHNwZWNpZnlpbmcgZGVmaW5lLmFtZC5qUXVlcnkgPSB0cnVlLiBSZWdpc3RlciBhcyBhIG5hbWVkIG1vZHVsZSwKLy8gc2luY2UgalF1ZXJ5IGNhbiBiZSBjb25jYXRlbmF0ZWQgd2l0aCBvdGhlciBmaWxlcyB0aGF0IG1heSB1c2UgZGVmaW5lLAovLyBidXQgbm90IHVzZSBhIHByb3BlciBjb25jYXRlbmF0aW9uIHNjcmlwdCB0aGF0IHVuZGVyc3RhbmRzIGFub255bW91cwovLyBBTUQgbW9kdWxlcy4gQSBuYW1lZCBBTUQgaXMgc2FmZXN0IGFuZCBtb3N0IHJvYnVzdCB3YXkgdG8gcmVnaXN0ZXIuCi8vIExvd2VyY2FzZSBqcXVlcnkgaXMgdXNlZCBiZWNhdXNlIEFNRCBtb2R1bGUgbmFtZXMgYXJlIGRlcml2ZWQgZnJvbQovLyBmaWxlIG5hbWVzLCBhbmQgalF1ZXJ5IGlzIG5vcm1hbGx5IGRlbGl2ZXJlZCBpbiBhIGxvd2VyY2FzZSBmaWxlIG5hbWUuCi8vIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgdGhlIGdsb2JhbCBzbyB0aGF0IGlmIGFuIEFNRCBtb2R1bGUgd2FudHMgdG8gY2FsbAovLyBub0NvbmZsaWN0IHRvIGhpZGUgdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSwgaXQgd2lsbCB3b3JrLgppZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCAmJiBkZWZpbmUuYW1kLmpRdWVyeSApIHsKICBkZWZpbmUoICJqcXVlcnkiLCBbXSwgZnVuY3Rpb24gKCkgeyByZXR1cm4galF1ZXJ5OyB9ICk7Cn0KCn0pKCB3aW5kb3cgKTsKLy8gbGliL2hhbmRsZWJhcnMvYmFzZS5qcwoKLypqc2hpbnQgZXFudWxsOnRydWUqLwp0aGlzLkhhbmRsZWJhcnMgPSB7fTsKCihmdW5jdGlvbihIYW5kbGViYXJzKSB7CgpIYW5kbGViYXJzLlZFUlNJT04gPSAiMS4wLnJjLjEiOwoKSGFuZGxlYmFycy5oZWxwZXJzICA9IHt9OwpIYW5kbGViYXJzLnBhcnRpYWxzID0ge307CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyID0gZnVuY3Rpb24obmFtZSwgZm4sIGludmVyc2UpIHsKICBpZihpbnZlcnNlKSB7IGZuLm5vdCA9IGludmVyc2U7IH0KICB0aGlzLmhlbHBlcnNbbmFtZV0gPSBmbjsKfTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJQYXJ0aWFsID0gZnVuY3Rpb24obmFtZSwgc3RyKSB7CiAgdGhpcy5wYXJ0aWFsc1tuYW1lXSA9IHN0cjsKfTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2hlbHBlck1pc3NpbmcnLCBmdW5jdGlvbihhcmcpIHsKICBpZihhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICByZXR1cm4gdW5kZWZpbmVkOwogIH0gZWxzZSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkNvdWxkIG5vdCBmaW5kIHByb3BlcnR5ICciICsgYXJnICsgIiciKTsKICB9Cn0pOwoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywgZnVuY3Rpb25UeXBlID0gIltvYmplY3QgRnVuY3Rpb25dIjsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2Jsb2NrSGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICB2YXIgaW52ZXJzZSA9IG9wdGlvbnMuaW52ZXJzZSB8fCBmdW5jdGlvbigpIHt9LCBmbiA9IG9wdGlvbnMuZm47CgoKICB2YXIgcmV0ID0gIiI7CiAgdmFyIHR5cGUgPSB0b1N0cmluZy5jYWxsKGNvbnRleHQpOwoKICBpZih0eXBlID09PSBmdW5jdGlvblR5cGUpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfQoKICBpZihjb250ZXh0ID09PSB0cnVlKSB7CiAgICByZXR1cm4gZm4odGhpcyk7CiAgfSBlbHNlIGlmKGNvbnRleHQgPT09IGZhbHNlIHx8IGNvbnRleHQgPT0gbnVsbCkgewogICAgcmV0dXJuIGludmVyc2UodGhpcyk7CiAgfSBlbHNlIGlmKHR5cGUgPT09ICJbb2JqZWN0IEFycmF5XSIpIHsKICAgIGlmKGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gSGFuZGxlYmFycy5oZWxwZXJzLmVhY2goY29udGV4dCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0dXJuIGZuKGNvbnRleHQpOwogIH0KfSk7CgpIYW5kbGViYXJzLksgPSBmdW5jdGlvbigpIHt9OwoKSGFuZGxlYmFycy5jcmVhdGVGcmFtZSA9IE9iamVjdC5jcmVhdGUgfHwgZnVuY3Rpb24ob2JqZWN0KSB7CiAgSGFuZGxlYmFycy5LLnByb3RvdHlwZSA9IG9iamVjdDsKICB2YXIgb2JqID0gbmV3IEhhbmRsZWJhcnMuSygpOwogIEhhbmRsZWJhcnMuSy5wcm90b3R5cGUgPSBudWxsOwogIHJldHVybiBvYmo7Cn07CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlYWNoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgdmFyIHJldCA9ICIiLCBkYXRhOwoKICBpZiAob3B0aW9ucy5kYXRhKSB7CiAgICBkYXRhID0gSGFuZGxlYmFycy5jcmVhdGVGcmFtZShvcHRpb25zLmRhdGEpOwogIH0KCiAgaWYoY29udGV4dCAmJiBjb250ZXh0Lmxlbmd0aCA+IDApIHsKICAgIGZvcih2YXIgaT0wLCBqPWNvbnRleHQubGVuZ3RoOyBpPGo7IGkrKykgewogICAgICBpZiAoZGF0YSkgeyBkYXRhLmluZGV4ID0gaTsgfQogICAgICByZXQgPSByZXQgKyBmbihjb250ZXh0W2ldLCB7IGRhdGE6IGRhdGEgfSk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHJldCA9IGludmVyc2UodGhpcyk7CiAgfQogIHJldHVybiByZXQ7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWYnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIHR5cGUgPSB0b1N0cmluZy5jYWxsKGNvbnRleHQpOwogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmKCFjb250ZXh0IHx8IEhhbmRsZWJhcnMuVXRpbHMuaXNFbXB0eShjb250ZXh0KSkgewogICAgcmV0dXJuIG9wdGlvbnMuaW52ZXJzZSh0aGlzKTsKICB9IGVsc2UgewogICAgcmV0dXJuIG9wdGlvbnMuZm4odGhpcyk7CiAgfQp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3VubGVzcycsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICB2YXIgZm4gPSBvcHRpb25zLmZuLCBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlOwogIG9wdGlvbnMuZm4gPSBpbnZlcnNlOwogIG9wdGlvbnMuaW52ZXJzZSA9IGZuOwoKICByZXR1cm4gSGFuZGxlYmFycy5oZWxwZXJzWydpZiddLmNhbGwodGhpcywgY29udGV4dCwgb3B0aW9ucyk7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignd2l0aCcsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICByZXR1cm4gb3B0aW9ucy5mbihjb250ZXh0KTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsb2cnLCBmdW5jdGlvbihjb250ZXh0KSB7CiAgSGFuZGxlYmFycy5sb2coY29udGV4dCk7Cn0pOwoKfSh0aGlzLkhhbmRsZWJhcnMpKTsKOwovLyBsaWIvaGFuZGxlYmFycy9jb21waWxlci9wYXJzZXIuanMKLyogSmlzb24gZ2VuZXJhdGVkIHBhcnNlciAqLwp2YXIgaGFuZGxlYmFycyA9IChmdW5jdGlvbigpewp2YXIgcGFyc2VyID0ge3RyYWNlOiBmdW5jdGlvbiB0cmFjZSgpIHsgfSwKeXk6IHt9LApzeW1ib2xzXzogeyJlcnJvciI6Miwicm9vdCI6MywicHJvZ3JhbSI6NCwiRU9GIjo1LCJzdGF0ZW1lbnRzIjo2LCJzaW1wbGVJbnZlcnNlIjo3LCJzdGF0ZW1lbnQiOjgsIm9wZW5JbnZlcnNlIjo5LCJjbG9zZUJsb2NrIjoxMCwib3BlbkJsb2NrIjoxMSwibXVzdGFjaGUiOjEyLCJwYXJ0aWFsIjoxMywiQ09OVEVOVCI6MTQsIkNPTU1FTlQiOjE1LCJPUEVOX0JMT0NLIjoxNiwiaW5NdXN0YWNoZSI6MTcsIkNMT1NFIjoxOCwiT1BFTl9JTlZFUlNFIjoxOSwiT1BFTl9FTkRCTE9DSyI6MjAsInBhdGgiOjIxLCJPUEVOIjoyMiwiT1BFTl9VTkVTQ0FQRUQiOjIzLCJPUEVOX1BBUlRJQUwiOjI0LCJwYXJhbXMiOjI1LCJoYXNoIjoyNiwiREFUQSI6MjcsInBhcmFtIjoyOCwiU1RSSU5HIjoyOSwiSU5URUdFUiI6MzAsIkJPT0xFQU4iOjMxLCJoYXNoU2VnbWVudHMiOjMyLCJoYXNoU2VnbWVudCI6MzMsIklEIjozNCwiRVFVQUxTIjozNSwicGF0aFNlZ21lbnRzIjozNiwiU0VQIjozNywiJGFjY2VwdCI6MCwiJGVuZCI6MX0sCnRlcm1pbmFsc186IHsyOiJlcnJvciIsNToiRU9GIiwxNDoiQ09OVEVOVCIsMTU6IkNPTU1FTlQiLDE2OiJPUEVOX0JMT0NLIiwxODoiQ0xPU0UiLDE5OiJPUEVOX0lOVkVSU0UiLDIwOiJPUEVOX0VOREJMT0NLIiwyMjoiT1BFTiIsMjM6Ik9QRU5fVU5FU0NBUEVEIiwyNDoiT1BFTl9QQVJUSUFMIiwyNzoiREFUQSIsMjk6IlNUUklORyIsMzA6IklOVEVHRVIiLDMxOiJCT09MRUFOIiwzNDoiSUQiLDM1OiJFUVVBTFMiLDM3OiJTRVAifSwKcHJvZHVjdGlvbnNfOiBbMCxbMywyXSxbNCwzXSxbNCwxXSxbNCwwXSxbNiwxXSxbNiwyXSxbOCwzXSxbOCwzXSxbOCwxXSxbOCwxXSxbOCwxXSxbOCwxXSxbMTEsM10sWzksM10sWzEwLDNdLFsxMiwzXSxbMTIsM10sWzEzLDNdLFsxMyw0XSxbNywyXSxbMTcsM10sWzE3LDJdLFsxNywyXSxbMTcsMV0sWzE3LDFdLFsyNSwyXSxbMjUsMV0sWzI4LDFdLFsyOCwxXSxbMjgsMV0sWzI4LDFdLFsyOCwxXSxbMjYsMV0sWzMyLDJdLFszMiwxXSxbMzMsM10sWzMzLDNdLFszMywzXSxbMzMsM10sWzMzLDNdLFsyMSwxXSxbMzYsM10sWzM2LDFdXSwKcGVyZm9ybUFjdGlvbjogZnVuY3Rpb24gYW5vbnltb3VzKHl5dGV4dCx5eWxlbmcseXlsaW5lbm8seXkseXlzdGF0ZSwkJCxfJCkgewoKdmFyICQwID0gJCQubGVuZ3RoIC0gMTsKc3dpdGNoICh5eXN0YXRlKSB7CmNhc2UgMTogcmV0dXJuICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgMjogdGhpcy4kID0gbmV3IHl5LlByb2dyYW1Ob2RlKCQkWyQwLTJdLCAkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzogdGhpcy4kID0gbmV3IHl5LlByb2dyYW1Ob2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSA0OiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoW10pOyAKYnJlYWs7CmNhc2UgNTogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKY2FzZSA2OiAkJFskMC0xXS5wdXNoKCQkWyQwXSk7IHRoaXMuJCA9ICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgNzogdGhpcy4kID0gbmV3IHl5LkJsb2NrTm9kZSgkJFskMC0yXSwgJCRbJDAtMV0uaW52ZXJzZSwgJCRbJDAtMV0sICQkWyQwXSk7IApicmVhazsKY2FzZSA4OiB0aGlzLiQgPSBuZXcgeXkuQmxvY2tOb2RlKCQkWyQwLTJdLCAkJFskMC0xXSwgJCRbJDAtMV0uaW52ZXJzZSwgJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDk6IHRoaXMuJCA9ICQkWyQwXTsgCmJyZWFrOwpjYXNlIDEwOiB0aGlzLiQgPSAkJFskMF07IApicmVhazsKY2FzZSAxMTogdGhpcy4kID0gbmV3IHl5LkNvbnRlbnROb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAxMjogdGhpcy4kID0gbmV3IHl5LkNvbW1lbnROb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAxMzogdGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0pOyAKYnJlYWs7CmNhc2UgMTQ6IHRoaXMuJCA9IG5ldyB5eS5NdXN0YWNoZU5vZGUoJCRbJDAtMV1bMF0sICQkWyQwLTFdWzFdKTsgCmJyZWFrOwpjYXNlIDE1OiB0aGlzLiQgPSAkJFskMC0xXTsgCmJyZWFrOwpjYXNlIDE2OiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSk7IApicmVhazsKY2FzZSAxNzogdGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0sIHRydWUpOyAKYnJlYWs7CmNhc2UgMTg6IHRoaXMuJCA9IG5ldyB5eS5QYXJ0aWFsTm9kZSgkJFskMC0xXSk7IApicmVhazsKY2FzZSAxOTogdGhpcy4kID0gbmV3IHl5LlBhcnRpYWxOb2RlKCQkWyQwLTJdLCAkJFskMC0xXSk7IApicmVhazsKY2FzZSAyMDogCmJyZWFrOwpjYXNlIDIxOiB0aGlzLiQgPSBbWyQkWyQwLTJdXS5jb25jYXQoJCRbJDAtMV0pLCAkJFskMF1dOyAKYnJlYWs7CmNhc2UgMjI6IHRoaXMuJCA9IFtbJCRbJDAtMV1dLmNvbmNhdCgkJFskMF0pLCBudWxsXTsgCmJyZWFrOwpjYXNlIDIzOiB0aGlzLiQgPSBbWyQkWyQwLTFdXSwgJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDI0OiB0aGlzLiQgPSBbWyQkWyQwXV0sIG51bGxdOyAKYnJlYWs7CmNhc2UgMjU6IHRoaXMuJCA9IFtbbmV3IHl5LkRhdGFOb2RlKCQkWyQwXSldLCBudWxsXTsgCmJyZWFrOwpjYXNlIDI2OiAkJFskMC0xXS5wdXNoKCQkWyQwXSk7IHRoaXMuJCA9ICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgMjc6IHRoaXMuJCA9IFskJFskMF1dOyAKYnJlYWs7CmNhc2UgMjg6IHRoaXMuJCA9ICQkWyQwXTsgCmJyZWFrOwpjYXNlIDI5OiB0aGlzLiQgPSBuZXcgeXkuU3RyaW5nTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzA6IHRoaXMuJCA9IG5ldyB5eS5JbnRlZ2VyTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzE6IHRoaXMuJCA9IG5ldyB5eS5Cb29sZWFuTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzI6IHRoaXMuJCA9IG5ldyB5eS5EYXRhTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzM6IHRoaXMuJCA9IG5ldyB5eS5IYXNoTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgMzQ6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSAzNTogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKY2FzZSAzNjogdGhpcy4kID0gWyQkWyQwLTJdLCAkJFskMF1dOyAKYnJlYWs7CmNhc2UgMzc6IHRoaXMuJCA9IFskJFskMC0yXSwgbmV3IHl5LlN0cmluZ05vZGUoJCRbJDBdKV07IApicmVhazsKY2FzZSAzODogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuSW50ZWdlck5vZGUoJCRbJDBdKV07IApicmVhazsKY2FzZSAzOTogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuQm9vbGVhbk5vZGUoJCRbJDBdKV07IApicmVhazsKY2FzZSA0MDogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuRGF0YU5vZGUoJCRbJDBdKV07IApicmVhazsKY2FzZSA0MTogdGhpcy4kID0gbmV3IHl5LklkTm9kZSgkJFskMF0pOyAKYnJlYWs7CmNhc2UgNDI6ICQkWyQwLTJdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMl07IApicmVhazsKY2FzZSA0MzogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKfQp9LAp0YWJsZTogW3szOjEsNDoyLDU6WzIsNF0sNjozLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHsxOlszXX0sezU6WzEsMTZdfSx7NTpbMiwzXSw3OjE3LDg6MTgsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTldLDIwOlsyLDNdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7NTpbMiw1XSwxNDpbMiw1XSwxNTpbMiw1XSwxNjpbMiw1XSwxOTpbMiw1XSwyMDpbMiw1XSwyMjpbMiw1XSwyMzpbMiw1XSwyNDpbMiw1XX0sezQ6MjAsNjozLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjA6WzIsNF0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs0OjIxLDY6Myw4OjQsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIwOlsyLDRdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7NTpbMiw5XSwxNDpbMiw5XSwxNTpbMiw5XSwxNjpbMiw5XSwxOTpbMiw5XSwyMDpbMiw5XSwyMjpbMiw5XSwyMzpbMiw5XSwyNDpbMiw5XX0sezU6WzIsMTBdLDE0OlsyLDEwXSwxNTpbMiwxMF0sMTY6WzIsMTBdLDE5OlsyLDEwXSwyMDpbMiwxMF0sMjI6WzIsMTBdLDIzOlsyLDEwXSwyNDpbMiwxMF19LHs1OlsyLDExXSwxNDpbMiwxMV0sMTU6WzIsMTFdLDE2OlsyLDExXSwxOTpbMiwxMV0sMjA6WzIsMTFdLDIyOlsyLDExXSwyMzpbMiwxMV0sMjQ6WzIsMTFdfSx7NTpbMiwxMl0sMTQ6WzIsMTJdLDE1OlsyLDEyXSwxNjpbMiwxMl0sMTk6WzIsMTJdLDIwOlsyLDEyXSwyMjpbMiwxMl0sMjM6WzIsMTJdLDI0OlsyLDEyXX0sezE3OjIyLDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxNzoyNywyMToyMywyNzpbMSwyNF0sMzQ6WzEsMjZdLDM2OjI1fSx7MTc6MjgsMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezE3OjI5LDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsyMTozMCwzNDpbMSwyNl0sMzY6MjV9LHsxOlsyLDFdfSx7NjozMSw4OjQsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7NTpbMiw2XSwxNDpbMiw2XSwxNTpbMiw2XSwxNjpbMiw2XSwxOTpbMiw2XSwyMDpbMiw2XSwyMjpbMiw2XSwyMzpbMiw2XSwyNDpbMiw2XX0sezE3OjIyLDE4OlsxLDMyXSwyMToyMywyNzpbMSwyNF0sMzQ6WzEsMjZdLDM2OjI1fSx7MTA6MzMsMjA6WzEsMzRdfSx7MTA6MzUsMjA6WzEsMzRdfSx7MTg6WzEsMzZdfSx7MTg6WzIsMjRdLDIxOjQxLDI1OjM3LDI2OjM4LDI3OlsxLDQ1XSwyODozOSwyOTpbMSw0Ml0sMzA6WzEsNDNdLDMxOlsxLDQ0XSwzMjo0MCwzMzo0NiwzNDpbMSw0N10sMzY6MjV9LHsxODpbMiwyNV19LHsxODpbMiw0MV0sMjc6WzIsNDFdLDI5OlsyLDQxXSwzMDpbMiw0MV0sMzE6WzIsNDFdLDM0OlsyLDQxXSwzNzpbMSw0OF19LHsxODpbMiw0M10sMjc6WzIsNDNdLDI5OlsyLDQzXSwzMDpbMiw0M10sMzE6WzIsNDNdLDM0OlsyLDQzXSwzNzpbMiw0M119LHsxODpbMSw0OV19LHsxODpbMSw1MF19LHsxODpbMSw1MV19LHsxODpbMSw1Ml0sMjE6NTMsMzQ6WzEsMjZdLDM2OjI1fSx7NTpbMiwyXSw4OjE4LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMDpbMiwyXSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezE0OlsyLDIwXSwxNTpbMiwyMF0sMTY6WzIsMjBdLDE5OlsyLDIwXSwyMjpbMiwyMF0sMjM6WzIsMjBdLDI0OlsyLDIwXX0sezU6WzIsN10sMTQ6WzIsN10sMTU6WzIsN10sMTY6WzIsN10sMTk6WzIsN10sMjA6WzIsN10sMjI6WzIsN10sMjM6WzIsN10sMjQ6WzIsN119LHsyMTo1NCwzNDpbMSwyNl0sMzY6MjV9LHs1OlsyLDhdLDE0OlsyLDhdLDE1OlsyLDhdLDE2OlsyLDhdLDE5OlsyLDhdLDIwOlsyLDhdLDIyOlsyLDhdLDIzOlsyLDhdLDI0OlsyLDhdfSx7MTQ6WzIsMTRdLDE1OlsyLDE0XSwxNjpbMiwxNF0sMTk6WzIsMTRdLDIwOlsyLDE0XSwyMjpbMiwxNF0sMjM6WzIsMTRdLDI0OlsyLDE0XX0sezE4OlsyLDIyXSwyMTo0MSwyNjo1NSwyNzpbMSw0NV0sMjg6NTYsMjk6WzEsNDJdLDMwOlsxLDQzXSwzMTpbMSw0NF0sMzI6NDAsMzM6NDYsMzQ6WzEsNDddLDM2OjI1fSx7MTg6WzIsMjNdfSx7MTg6WzIsMjddLDI3OlsyLDI3XSwyOTpbMiwyN10sMzA6WzIsMjddLDMxOlsyLDI3XSwzNDpbMiwyN119LHsxODpbMiwzM10sMzM6NTcsMzQ6WzEsNThdfSx7MTg6WzIsMjhdLDI3OlsyLDI4XSwyOTpbMiwyOF0sMzA6WzIsMjhdLDMxOlsyLDI4XSwzNDpbMiwyOF19LHsxODpbMiwyOV0sMjc6WzIsMjldLDI5OlsyLDI5XSwzMDpbMiwyOV0sMzE6WzIsMjldLDM0OlsyLDI5XX0sezE4OlsyLDMwXSwyNzpbMiwzMF0sMjk6WzIsMzBdLDMwOlsyLDMwXSwzMTpbMiwzMF0sMzQ6WzIsMzBdfSx7MTg6WzIsMzFdLDI3OlsyLDMxXSwyOTpbMiwzMV0sMzA6WzIsMzFdLDMxOlsyLDMxXSwzNDpbMiwzMV19LHsxODpbMiwzMl0sMjc6WzIsMzJdLDI5OlsyLDMyXSwzMDpbMiwzMl0sMzE6WzIsMzJdLDM0OlsyLDMyXX0sezE4OlsyLDM1XSwzNDpbMiwzNV19LHsxODpbMiw0M10sMjc6WzIsNDNdLDI5OlsyLDQzXSwzMDpbMiw0M10sMzE6WzIsNDNdLDM0OlsyLDQzXSwzNTpbMSw1OV0sMzc6WzIsNDNdfSx7MzQ6WzEsNjBdfSx7MTQ6WzIsMTNdLDE1OlsyLDEzXSwxNjpbMiwxM10sMTk6WzIsMTNdLDIwOlsyLDEzXSwyMjpbMiwxM10sMjM6WzIsMTNdLDI0OlsyLDEzXX0sezU6WzIsMTZdLDE0OlsyLDE2XSwxNTpbMiwxNl0sMTY6WzIsMTZdLDE5OlsyLDE2XSwyMDpbMiwxNl0sMjI6WzIsMTZdLDIzOlsyLDE2XSwyNDpbMiwxNl19LHs1OlsyLDE3XSwxNDpbMiwxN10sMTU6WzIsMTddLDE2OlsyLDE3XSwxOTpbMiwxN10sMjA6WzIsMTddLDIyOlsyLDE3XSwyMzpbMiwxN10sMjQ6WzIsMTddfSx7NTpbMiwxOF0sMTQ6WzIsMThdLDE1OlsyLDE4XSwxNjpbMiwxOF0sMTk6WzIsMThdLDIwOlsyLDE4XSwyMjpbMiwxOF0sMjM6WzIsMThdLDI0OlsyLDE4XX0sezE4OlsxLDYxXX0sezE4OlsxLDYyXX0sezE4OlsyLDIxXX0sezE4OlsyLDI2XSwyNzpbMiwyNl0sMjk6WzIsMjZdLDMwOlsyLDI2XSwzMTpbMiwyNl0sMzQ6WzIsMjZdfSx7MTg6WzIsMzRdLDM0OlsyLDM0XX0sezM1OlsxLDU5XX0sezIxOjYzLDI3OlsxLDY3XSwyOTpbMSw2NF0sMzA6WzEsNjVdLDMxOlsxLDY2XSwzNDpbMSwyNl0sMzY6MjV9LHsxODpbMiw0Ml0sMjc6WzIsNDJdLDI5OlsyLDQyXSwzMDpbMiw0Ml0sMzE6WzIsNDJdLDM0OlsyLDQyXSwzNzpbMiw0Ml19LHs1OlsyLDE5XSwxNDpbMiwxOV0sMTU6WzIsMTldLDE2OlsyLDE5XSwxOTpbMiwxOV0sMjA6WzIsMTldLDIyOlsyLDE5XSwyMzpbMiwxOV0sMjQ6WzIsMTldfSx7NTpbMiwxNV0sMTQ6WzIsMTVdLDE1OlsyLDE1XSwxNjpbMiwxNV0sMTk6WzIsMTVdLDIwOlsyLDE1XSwyMjpbMiwxNV0sMjM6WzIsMTVdLDI0OlsyLDE1XX0sezE4OlsyLDM2XSwzNDpbMiwzNl19LHsxODpbMiwzN10sMzQ6WzIsMzddfSx7MTg6WzIsMzhdLDM0OlsyLDM4XX0sezE4OlsyLDM5XSwzNDpbMiwzOV19LHsxODpbMiw0MF0sMzQ6WzIsNDBdfV0sCmRlZmF1bHRBY3Rpb25zOiB7MTY6WzIsMV0sMjQ6WzIsMjVdLDM4OlsyLDIzXSw1NTpbMiwyMV19LApwYXJzZUVycm9yOiBmdW5jdGlvbiBwYXJzZUVycm9yKHN0ciwgaGFzaCkgewogICAgdGhyb3cgbmV3IEVycm9yKHN0cik7Cn0sCnBhcnNlOiBmdW5jdGlvbiBwYXJzZShpbnB1dCkgewogICAgdmFyIHNlbGYgPSB0aGlzLCBzdGFjayA9IFswXSwgdnN0YWNrID0gW251bGxdLCBsc3RhY2sgPSBbXSwgdGFibGUgPSB0aGlzLnRhYmxlLCB5eXRleHQgPSAiIiwgeXlsaW5lbm8gPSAwLCB5eWxlbmcgPSAwLCByZWNvdmVyaW5nID0gMCwgVEVSUk9SID0gMiwgRU9GID0gMTsKICAgIHRoaXMubGV4ZXIuc2V0SW5wdXQoaW5wdXQpOwogICAgdGhpcy5sZXhlci55eSA9IHRoaXMueXk7CiAgICB0aGlzLnl5LmxleGVyID0gdGhpcy5sZXhlcjsKICAgIHRoaXMueXkucGFyc2VyID0gdGhpczsKICAgIGlmICh0eXBlb2YgdGhpcy5sZXhlci55eWxsb2MgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgdGhpcy5sZXhlci55eWxsb2MgPSB7fTsKICAgIHZhciB5eWxvYyA9IHRoaXMubGV4ZXIueXlsbG9jOwogICAgbHN0YWNrLnB1c2goeXlsb2MpOwogICAgdmFyIHJhbmdlcyA9IHRoaXMubGV4ZXIub3B0aW9ucyAmJiB0aGlzLmxleGVyLm9wdGlvbnMucmFuZ2VzOwogICAgaWYgKHR5cGVvZiB0aGlzLnl5LnBhcnNlRXJyb3IgPT09ICJmdW5jdGlvbiIpCiAgICAgICAgdGhpcy5wYXJzZUVycm9yID0gdGhpcy55eS5wYXJzZUVycm9yOwogICAgZnVuY3Rpb24gcG9wU3RhY2sobikgewogICAgICAgIHN0YWNrLmxlbmd0aCA9IHN0YWNrLmxlbmd0aCAtIDIgKiBuOwogICAgICAgIHZzdGFjay5sZW5ndGggPSB2c3RhY2subGVuZ3RoIC0gbjsKICAgICAgICBsc3RhY2subGVuZ3RoID0gbHN0YWNrLmxlbmd0aCAtIG47CiAgICB9CiAgICBmdW5jdGlvbiBsZXgoKSB7CiAgICAgICAgdmFyIHRva2VuOwogICAgICAgIHRva2VuID0gc2VsZi5sZXhlci5sZXgoKSB8fCAxOwogICAgICAgIGlmICh0eXBlb2YgdG9rZW4gIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHRva2VuID0gc2VsZi5zeW1ib2xzX1t0b2tlbl0gfHwgdG9rZW47CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbjsKICAgIH0KICAgIHZhciBzeW1ib2wsIHByZUVycm9yU3ltYm9sLCBzdGF0ZSwgYWN0aW9uLCBhLCByLCB5eXZhbCA9IHt9LCBwLCBsZW4sIG5ld1N0YXRlLCBleHBlY3RlZDsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgc3RhdGUgPSBzdGFja1tzdGFjay5sZW5ndGggLSAxXTsKICAgICAgICBpZiAodGhpcy5kZWZhdWx0QWN0aW9uc1tzdGF0ZV0pIHsKICAgICAgICAgICAgYWN0aW9uID0gdGhpcy5kZWZhdWx0QWN0aW9uc1tzdGF0ZV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHN5bWJvbCA9PT0gbnVsbCB8fCB0eXBlb2Ygc3ltYm9sID09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBzeW1ib2wgPSBsZXgoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhY3Rpb24gPSB0YWJsZVtzdGF0ZV0gJiYgdGFibGVbc3RhdGVdW3N5bWJvbF07CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYWN0aW9uID09PSAidW5kZWZpbmVkIiB8fCAhYWN0aW9uLmxlbmd0aCB8fCAhYWN0aW9uWzBdKSB7CiAgICAgICAgICAgIHZhciBlcnJTdHIgPSAiIjsKICAgICAgICAgICAgaWYgKCFyZWNvdmVyaW5nKSB7CiAgICAgICAgICAgICAgICBleHBlY3RlZCA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChwIGluIHRhYmxlW3N0YXRlXSkKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50ZXJtaW5hbHNfW3BdICYmIHAgPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkLnB1c2goIiciICsgdGhpcy50ZXJtaW5hbHNfW3BdICsgIiciKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5sZXhlci5zaG93UG9zaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBlcnJTdHIgPSAiUGFyc2UgZXJyb3Igb24gbGluZSAiICsgKHl5bGluZW5vICsgMSkgKyAiOlxuIiArIHRoaXMubGV4ZXIuc2hvd1Bvc2l0aW9uKCkgKyAiXG5FeHBlY3RpbmcgIiArIGV4cGVjdGVkLmpvaW4oIiwgIikgKyAiLCBnb3QgJyIgKyAodGhpcy50ZXJtaW5hbHNfW3N5bWJvbF0gfHwgc3ltYm9sKSArICInIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyU3RyID0gIlBhcnNlIGVycm9yIG9uIGxpbmUgIiArICh5eWxpbmVubyArIDEpICsgIjogVW5leHBlY3RlZCAiICsgKHN5bWJvbCA9PSAxPyJlbmQgb2YgaW5wdXQiOiInIiArICh0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wpICsgIiciKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGFyc2VFcnJvcihlcnJTdHIsIHt0ZXh0OiB0aGlzLmxleGVyLm1hdGNoLCB0b2tlbjogdGhpcy50ZXJtaW5hbHNfW3N5bWJvbF0gfHwgc3ltYm9sLCBsaW5lOiB0aGlzLmxleGVyLnl5bGluZW5vLCBsb2M6IHl5bG9jLCBleHBlY3RlZDogZXhwZWN0ZWR9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoYWN0aW9uWzBdIGluc3RhbmNlb2YgQXJyYXkgJiYgYWN0aW9uLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQYXJzZSBFcnJvcjogbXVsdGlwbGUgYWN0aW9ucyBwb3NzaWJsZSBhdCBzdGF0ZTogIiArIHN0YXRlICsgIiwgdG9rZW46ICIgKyBzeW1ib2wpOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKGFjdGlvblswXSkgewogICAgICAgIGNhc2UgMToKICAgICAgICAgICAgc3RhY2sucHVzaChzeW1ib2wpOwogICAgICAgICAgICB2c3RhY2sucHVzaCh0aGlzLmxleGVyLnl5dGV4dCk7CiAgICAgICAgICAgIGxzdGFjay5wdXNoKHRoaXMubGV4ZXIueXlsbG9jKTsKICAgICAgICAgICAgc3RhY2sucHVzaChhY3Rpb25bMV0pOwogICAgICAgICAgICBzeW1ib2wgPSBudWxsOwogICAgICAgICAgICBpZiAoIXByZUVycm9yU3ltYm9sKSB7CiAgICAgICAgICAgICAgICB5eWxlbmcgPSB0aGlzLmxleGVyLnl5bGVuZzsKICAgICAgICAgICAgICAgIHl5dGV4dCA9IHRoaXMubGV4ZXIueXl0ZXh0OwogICAgICAgICAgICAgICAgeXlsaW5lbm8gPSB0aGlzLmxleGVyLnl5bGluZW5vOwogICAgICAgICAgICAgICAgeXlsb2MgPSB0aGlzLmxleGVyLnl5bGxvYzsKICAgICAgICAgICAgICAgIGlmIChyZWNvdmVyaW5nID4gMCkKICAgICAgICAgICAgICAgICAgICByZWNvdmVyaW5nLS07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzeW1ib2wgPSBwcmVFcnJvclN5bWJvbDsKICAgICAgICAgICAgICAgIHByZUVycm9yU3ltYm9sID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGxlbiA9IHRoaXMucHJvZHVjdGlvbnNfW2FjdGlvblsxXV1bMV07CiAgICAgICAgICAgIHl5dmFsLiQgPSB2c3RhY2tbdnN0YWNrLmxlbmd0aCAtIGxlbl07CiAgICAgICAgICAgIHl5dmFsLl8kID0ge2ZpcnN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0uZmlyc3RfbGluZSwgbGFzdF9saW5lOiBsc3RhY2tbbHN0YWNrLmxlbmd0aCAtIDFdLmxhc3RfbGluZSwgZmlyc3RfY29sdW1uOiBsc3RhY2tbbHN0YWNrLmxlbmd0aCAtIChsZW4gfHwgMSldLmZpcnN0X2NvbHVtbiwgbGFzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ubGFzdF9jb2x1bW59OwogICAgICAgICAgICBpZiAocmFuZ2VzKSB7CiAgICAgICAgICAgICAgICB5eXZhbC5fJC5yYW5nZSA9IFtsc3RhY2tbbHN0YWNrLmxlbmd0aCAtIChsZW4gfHwgMSldLnJhbmdlWzBdLCBsc3RhY2tbbHN0YWNrLmxlbmd0aCAtIDFdLnJhbmdlWzFdXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByID0gdGhpcy5wZXJmb3JtQWN0aW9uLmNhbGwoeXl2YWwsIHl5dGV4dCwgeXlsZW5nLCB5eWxpbmVubywgdGhpcy55eSwgYWN0aW9uWzFdLCB2c3RhY2ssIGxzdGFjayk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsZW4pIHsKICAgICAgICAgICAgICAgIHN0YWNrID0gc3RhY2suc2xpY2UoMCwgLTEgKiBsZW4gKiAyKTsKICAgICAgICAgICAgICAgIHZzdGFjayA9IHZzdGFjay5zbGljZSgwLCAtMSAqIGxlbik7CiAgICAgICAgICAgICAgICBsc3RhY2sgPSBsc3RhY2suc2xpY2UoMCwgLTEgKiBsZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0YWNrLnB1c2godGhpcy5wcm9kdWN0aW9uc19bYWN0aW9uWzFdXVswXSk7CiAgICAgICAgICAgIHZzdGFjay5wdXNoKHl5dmFsLiQpOwogICAgICAgICAgICBsc3RhY2sucHVzaCh5eXZhbC5fJCk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gdGFibGVbc3RhY2tbc3RhY2subGVuZ3RoIC0gMl1dW3N0YWNrW3N0YWNrLmxlbmd0aCAtIDFdXTsKICAgICAgICAgICAgc3RhY2sucHVzaChuZXdTdGF0ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KfTsKLyogSmlzb24gZ2VuZXJhdGVkIGxleGVyICovCnZhciBsZXhlciA9IChmdW5jdGlvbigpewp2YXIgbGV4ZXIgPSAoe0VPRjoxLApwYXJzZUVycm9yOmZ1bmN0aW9uIHBhcnNlRXJyb3Ioc3RyLCBoYXNoKSB7CiAgICAgICAgaWYgKHRoaXMueXkucGFyc2VyKSB7CiAgICAgICAgICAgIHRoaXMueXkucGFyc2VyLnBhcnNlRXJyb3Ioc3RyLCBoYXNoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3Ioc3RyKTsKICAgICAgICB9CiAgICB9LApzZXRJbnB1dDpmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICB0aGlzLl9pbnB1dCA9IGlucHV0OwogICAgICAgIHRoaXMuX21vcmUgPSB0aGlzLl9sZXNzID0gdGhpcy5kb25lID0gZmFsc2U7CiAgICAgICAgdGhpcy55eWxpbmVubyA9IHRoaXMueXlsZW5nID0gMDsKICAgICAgICB0aGlzLnl5dGV4dCA9IHRoaXMubWF0Y2hlZCA9IHRoaXMubWF0Y2ggPSAnJzsKICAgICAgICB0aGlzLmNvbmRpdGlvblN0YWNrID0gWydJTklUSUFMJ107CiAgICAgICAgdGhpcy55eWxsb2MgPSB7Zmlyc3RfbGluZToxLGZpcnN0X2NvbHVtbjowLGxhc3RfbGluZToxLGxhc3RfY29sdW1uOjB9OwogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB0aGlzLnl5bGxvYy5yYW5nZSA9IFswLDBdOwogICAgICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCmlucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgY2ggPSB0aGlzLl9pbnB1dFswXTsKICAgICAgICB0aGlzLnl5dGV4dCArPSBjaDsKICAgICAgICB0aGlzLnl5bGVuZysrOwogICAgICAgIHRoaXMub2Zmc2V0Kys7CiAgICAgICAgdGhpcy5tYXRjaCArPSBjaDsKICAgICAgICB0aGlzLm1hdGNoZWQgKz0gY2g7CiAgICAgICAgdmFyIGxpbmVzID0gY2gubWF0Y2goLyg/OlxyXG4/fFxuKS4qL2cpOwogICAgICAgIGlmIChsaW5lcykgewogICAgICAgICAgICB0aGlzLnl5bGluZW5vKys7CiAgICAgICAgICAgIHRoaXMueXlsbG9jLmxhc3RfbGluZSsrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMueXlsbG9jLmxhc3RfY29sdW1uKys7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB0aGlzLnl5bGxvYy5yYW5nZVsxXSsrOwoKICAgICAgICB0aGlzLl9pbnB1dCA9IHRoaXMuX2lucHV0LnNsaWNlKDEpOwogICAgICAgIHJldHVybiBjaDsKICAgIH0sCnVucHV0OmZ1bmN0aW9uIChjaCkgewogICAgICAgIHZhciBsZW4gPSBjaC5sZW5ndGg7CiAgICAgICAgdmFyIGxpbmVzID0gY2guc3BsaXQoLyg/OlxyXG4/fFxuKS9nKTsKCiAgICAgICAgdGhpcy5faW5wdXQgPSBjaCArIHRoaXMuX2lucHV0OwogICAgICAgIHRoaXMueXl0ZXh0ID0gdGhpcy55eXRleHQuc3Vic3RyKDAsIHRoaXMueXl0ZXh0Lmxlbmd0aC1sZW4tMSk7CiAgICAgICAgLy90aGlzLnl5bGVuZyAtPSBsZW47CiAgICAgICAgdGhpcy5vZmZzZXQgLT0gbGVuOwogICAgICAgIHZhciBvbGRMaW5lcyA9IHRoaXMubWF0Y2guc3BsaXQoLyg/OlxyXG4/fFxuKS9nKTsKICAgICAgICB0aGlzLm1hdGNoID0gdGhpcy5tYXRjaC5zdWJzdHIoMCwgdGhpcy5tYXRjaC5sZW5ndGgtMSk7CiAgICAgICAgdGhpcy5tYXRjaGVkID0gdGhpcy5tYXRjaGVkLnN1YnN0cigwLCB0aGlzLm1hdGNoZWQubGVuZ3RoLTEpOwoKICAgICAgICBpZiAobGluZXMubGVuZ3RoLTEpIHRoaXMueXlsaW5lbm8gLT0gbGluZXMubGVuZ3RoLTE7CiAgICAgICAgdmFyIHIgPSB0aGlzLnl5bGxvYy5yYW5nZTsKCiAgICAgICAgdGhpcy55eWxsb2MgPSB7Zmlyc3RfbGluZTogdGhpcy55eWxsb2MuZmlyc3RfbGluZSwKICAgICAgICAgIGxhc3RfbGluZTogdGhpcy55eWxpbmVubysxLAogICAgICAgICAgZmlyc3RfY29sdW1uOiB0aGlzLnl5bGxvYy5maXJzdF9jb2x1bW4sCiAgICAgICAgICBsYXN0X2NvbHVtbjogbGluZXMgPwogICAgICAgICAgICAgIChsaW5lcy5sZW5ndGggPT09IG9sZExpbmVzLmxlbmd0aCA/IHRoaXMueXlsbG9jLmZpcnN0X2NvbHVtbiA6IDApICsgb2xkTGluZXNbb2xkTGluZXMubGVuZ3RoIC0gbGluZXMubGVuZ3RoXS5sZW5ndGggLSBsaW5lc1swXS5sZW5ndGg6CiAgICAgICAgICAgICAgdGhpcy55eWxsb2MuZmlyc3RfY29sdW1uIC0gbGVuCiAgICAgICAgICB9OwoKICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJhbmdlcykgewogICAgICAgICAgICB0aGlzLnl5bGxvYy5yYW5nZSA9IFtyWzBdLCByWzBdICsgdGhpcy55eWxlbmcgLSBsZW5dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCm1vcmU6ZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuX21vcmUgPSB0cnVlOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKbGVzczpmdW5jdGlvbiAobikgewogICAgICAgIHRoaXMudW5wdXQodGhpcy5tYXRjaC5zbGljZShuKSk7CiAgICB9LApwYXN0SW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwYXN0ID0gdGhpcy5tYXRjaGVkLnN1YnN0cigwLCB0aGlzLm1hdGNoZWQubGVuZ3RoIC0gdGhpcy5tYXRjaC5sZW5ndGgpOwogICAgICAgIHJldHVybiAocGFzdC5sZW5ndGggPiAyMCA/ICcuLi4nOicnKSArIHBhc3Quc3Vic3RyKC0yMCkucmVwbGFjZSgvXG4vZywgIiIpOwogICAgfSwKdXBjb21pbmdJbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG5leHQgPSB0aGlzLm1hdGNoOwogICAgICAgIGlmIChuZXh0Lmxlbmd0aCA8IDIwKSB7CiAgICAgICAgICAgIG5leHQgKz0gdGhpcy5faW5wdXQuc3Vic3RyKDAsIDIwLW5leHQubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChuZXh0LnN1YnN0cigwLDIwKSsobmV4dC5sZW5ndGggPiAyMCA/ICcuLi4nOicnKSkucmVwbGFjZSgvXG4vZywgIiIpOwogICAgfSwKc2hvd1Bvc2l0aW9uOmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcHJlID0gdGhpcy5wYXN0SW5wdXQoKTsKICAgICAgICB2YXIgYyA9IG5ldyBBcnJheShwcmUubGVuZ3RoICsgMSkuam9pbigiLSIpOwogICAgICAgIHJldHVybiBwcmUgKyB0aGlzLnVwY29taW5nSW5wdXQoKSArICJcbiIgKyBjKyJeIjsKICAgIH0sCm5leHQ6ZnVuY3Rpb24gKCkgewogICAgICAgIGlmICh0aGlzLmRvbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuRU9GOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuX2lucHV0KSB0aGlzLmRvbmUgPSB0cnVlOwoKICAgICAgICB2YXIgdG9rZW4sCiAgICAgICAgICAgIG1hdGNoLAogICAgICAgICAgICB0ZW1wTWF0Y2gsCiAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICBjb2wsCiAgICAgICAgICAgIGxpbmVzOwogICAgICAgIGlmICghdGhpcy5fbW9yZSkgewogICAgICAgICAgICB0aGlzLnl5dGV4dCA9ICcnOwogICAgICAgICAgICB0aGlzLm1hdGNoID0gJyc7CiAgICAgICAgfQogICAgICAgIHZhciBydWxlcyA9IHRoaXMuX2N1cnJlbnRSdWxlcygpOwogICAgICAgIGZvciAodmFyIGk9MDtpIDwgcnVsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdGVtcE1hdGNoID0gdGhpcy5faW5wdXQubWF0Y2godGhpcy5ydWxlc1tydWxlc1tpXV0pOwogICAgICAgICAgICBpZiAodGVtcE1hdGNoICYmICghbWF0Y2ggfHwgdGVtcE1hdGNoWzBdLmxlbmd0aCA+IG1hdGNoWzBdLmxlbmd0aCkpIHsKICAgICAgICAgICAgICAgIG1hdGNoID0gdGVtcE1hdGNoOwogICAgICAgICAgICAgICAgaW5kZXggPSBpOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuZmxleCkgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGxpbmVzID0gbWF0Y2hbMF0ubWF0Y2goLyg/OlxyXG4/fFxuKS4qL2cpOwogICAgICAgICAgICBpZiAobGluZXMpIHRoaXMueXlsaW5lbm8gKz0gbGluZXMubGVuZ3RoOwogICAgICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOiB0aGlzLnl5bGxvYy5sYXN0X2xpbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfbGluZTogdGhpcy55eWxpbmVubysxLAogICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdF9jb2x1bW46IHRoaXMueXlsbG9jLmxhc3RfY29sdW1uLAogICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0X2NvbHVtbjogbGluZXMgPyBsaW5lc1tsaW5lcy5sZW5ndGgtMV0ubGVuZ3RoLWxpbmVzW2xpbmVzLmxlbmd0aC0xXS5tYXRjaCgvXHI/XG4/LylbMF0ubGVuZ3RoIDogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4gKyBtYXRjaFswXS5sZW5ndGh9OwogICAgICAgICAgICB0aGlzLnl5dGV4dCArPSBtYXRjaFswXTsKICAgICAgICAgICAgdGhpcy5tYXRjaCArPSBtYXRjaFswXTsKICAgICAgICAgICAgdGhpcy5tYXRjaGVzID0gbWF0Y2g7CiAgICAgICAgICAgIHRoaXMueXlsZW5nID0gdGhpcy55eXRleHQubGVuZ3RoOwogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJhbmdlcykgewogICAgICAgICAgICAgICAgdGhpcy55eWxsb2MucmFuZ2UgPSBbdGhpcy5vZmZzZXQsIHRoaXMub2Zmc2V0ICs9IHRoaXMueXlsZW5nXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tb3JlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2lucHV0ID0gdGhpcy5faW5wdXQuc2xpY2UobWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgICAgICAgdGhpcy5tYXRjaGVkICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0b2tlbiA9IHRoaXMucGVyZm9ybUFjdGlvbi5jYWxsKHRoaXMsIHRoaXMueXksIHRoaXMsIHJ1bGVzW2luZGV4XSx0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTFdKTsKICAgICAgICAgICAgaWYgKHRoaXMuZG9uZSAmJiB0aGlzLl9pbnB1dCkgdGhpcy5kb25lID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0b2tlbikgcmV0dXJuIHRva2VuOwogICAgICAgICAgICBlbHNlIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX2lucHV0ID09PSAiIikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5FT0Y7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VFcnJvcignTGV4aWNhbCBlcnJvciBvbiBsaW5lICcrKHRoaXMueXlsaW5lbm8rMSkrJy4gVW5yZWNvZ25pemVkIHRleHQuXG4nK3RoaXMuc2hvd1Bvc2l0aW9uKCksCiAgICAgICAgICAgICAgICAgICAge3RleHQ6ICIiLCB0b2tlbjogbnVsbCwgbGluZTogdGhpcy55eWxpbmVub30pOwogICAgICAgIH0KICAgIH0sCmxleDpmdW5jdGlvbiBsZXgoKSB7CiAgICAgICAgdmFyIHIgPSB0aGlzLm5leHQoKTsKICAgICAgICBpZiAodHlwZW9mIHIgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHJldHVybiByOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxleCgpOwogICAgICAgIH0KICAgIH0sCmJlZ2luOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgIHRoaXMuY29uZGl0aW9uU3RhY2sucHVzaChjb25kaXRpb24pOwogICAgfSwKcG9wU3RhdGU6ZnVuY3Rpb24gcG9wU3RhdGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uZGl0aW9uU3RhY2sucG9wKCk7CiAgICB9LApfY3VycmVudFJ1bGVzOmZ1bmN0aW9uIF9jdXJyZW50UnVsZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uZGl0aW9uc1t0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTFdXS5ydWxlczsKICAgIH0sCnRvcFN0YXRlOmZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFja1t0aGlzLmNvbmRpdGlvblN0YWNrLmxlbmd0aC0yXTsKICAgIH0sCnB1c2hTdGF0ZTpmdW5jdGlvbiBiZWdpbihjb25kaXRpb24pIHsKICAgICAgICB0aGlzLmJlZ2luKGNvbmRpdGlvbik7CiAgICB9fSk7CmxleGVyLm9wdGlvbnMgPSB7fTsKbGV4ZXIucGVyZm9ybUFjdGlvbiA9IGZ1bmN0aW9uIGFub255bW91cyh5eSx5eV8sJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucyxZWV9TVEFSVCkgewoKdmFyIFlZU1RBVEU9WVlfU1RBUlQKc3dpdGNoKCRhdm9pZGluZ19uYW1lX2NvbGxpc2lvbnMpIHsKY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQuc2xpY2UoLTEpICE9PSAiXFwiKSB0aGlzLmJlZ2luKCJtdSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQuc2xpY2UoLTEpID09PSAiXFwiKSB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMCx5eV8ueXlsZW5nLTEpLCB0aGlzLmJlZ2luKCJlbXUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5eV8ueXl0ZXh0KSByZXR1cm4gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIApicmVhazsKY2FzZSAxOiByZXR1cm4gMTQ7IApicmVhazsKY2FzZSAyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQuc2xpY2UoLTEpICE9PSAiXFwiKSB0aGlzLnBvcFN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgPT09ICJcXCIpIHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigwLHl5Xy55eWxlbmctMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKYnJlYWs7CmNhc2UgMzogcmV0dXJuIDI0OyAKYnJlYWs7CmNhc2UgNDogcmV0dXJuIDE2OyAKYnJlYWs7CmNhc2UgNTogcmV0dXJuIDIwOyAKYnJlYWs7CmNhc2UgNjogcmV0dXJuIDE5OyAKYnJlYWs7CmNhc2UgNzogcmV0dXJuIDE5OyAKYnJlYWs7CmNhc2UgODogcmV0dXJuIDIzOyAKYnJlYWs7CmNhc2UgOTogcmV0dXJuIDIzOyAKYnJlYWs7CmNhc2UgMTA6IHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigzLHl5Xy55eWxlbmctNSk7IHRoaXMucG9wU3RhdGUoKTsgcmV0dXJuIDE1OyAKYnJlYWs7CmNhc2UgMTE6IHJldHVybiAyMjsgCmJyZWFrOwpjYXNlIDEyOiByZXR1cm4gMzU7IApicmVhazsKY2FzZSAxMzogcmV0dXJuIDM0OyAKYnJlYWs7CmNhc2UgMTQ6IHJldHVybiAzNDsgCmJyZWFrOwpjYXNlIDE1OiByZXR1cm4gMzc7IApicmVhazsKY2FzZSAxNjogLyppZ25vcmUgd2hpdGVzcGFjZSovIApicmVhazsKY2FzZSAxNzogdGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTg7IApicmVhazsKY2FzZSAxODogdGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTg7IApicmVhazsKY2FzZSAxOTogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEseXlfLnl5bGVuZy0yKS5yZXBsYWNlKC9cXCIvZywnIicpOyByZXR1cm4gMjk7IApicmVhazsKY2FzZSAyMDogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEseXlfLnl5bGVuZy0yKS5yZXBsYWNlKC9cXCIvZywnIicpOyByZXR1cm4gMjk7IApicmVhazsKY2FzZSAyMTogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEpOyByZXR1cm4gMjc7IApicmVhazsKY2FzZSAyMjogcmV0dXJuIDMxOyAKYnJlYWs7CmNhc2UgMjM6IHJldHVybiAzMTsgCmJyZWFrOwpjYXNlIDI0OiByZXR1cm4gMzA7IApicmVhazsKY2FzZSAyNTogcmV0dXJuIDM0OyAKYnJlYWs7CmNhc2UgMjY6IHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigxLCB5eV8ueXlsZW5nLTIpOyByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAyNzogcmV0dXJuICdJTlZBTElEJzsgCmJyZWFrOwpjYXNlIDI4OiByZXR1cm4gNTsgCmJyZWFrOwp9Cn07CmxleGVyLnJ1bGVzID0gWy9eKD86W15ceDAwXSo/KD89KFx7XHspKSkvLC9eKD86W15ceDAwXSspLywvXig/OlteXHgwMF17Mix9Pyg/PShce1x7fCQpKSkvLC9eKD86XHtcez4pLywvXig/Olx7XHsjKS8sL14oPzpce1x7XC8pLywvXig/Olx7XHtcXikvLC9eKD86XHtce1xzKmVsc2VcYikvLC9eKD86XHtce1x7KS8sL14oPzpce1x7JikvLC9eKD86XHtceyFbXHNcU10qP1x9XH0pLywvXig/Olx7XHspLywvXig/Oj0pLywvXig/OlwuKD89W30gXSkpLywvXig/OlwuXC4pLywvXig/OltcLy5dKS8sL14oPzpccyspLywvXig/Olx9XH1cfSkvLC9eKD86XH1cfSkvLC9eKD86IihcXFsiXXxbXiJdKSoiKS8sL14oPzonKFxcWyddfFteJ10pKicpLywvXig/OkBbYS16QS1aXSspLywvXig/OnRydWUoPz1bfVxzXSkpLywvXig/OmZhbHNlKD89W31cc10pKS8sL14oPzpbMC05XSsoPz1bfVxzXSkpLywvXig/OlthLXpBLVowLTlfJC1dKyg/PVs9fVxzXC8uXSkpLywvXig/OlxbW15cXV0qXF0pLywvXig/Oi4pLywvXig/OiQpL107CmxleGVyLmNvbmRpdGlvbnMgPSB7Im11Ijp7InJ1bGVzIjpbMyw0LDUsNiw3LDgsOSwxMCwxMSwxMiwxMywxNCwxNSwxNiwxNywxOCwxOSwyMCwyMSwyMiwyMywyNCwyNSwyNiwyNywyOF0sImluY2x1c2l2ZSI6ZmFsc2V9LCJlbXUiOnsicnVsZXMiOlsyXSwiaW5jbHVzaXZlIjpmYWxzZX0sIklOSVRJQUwiOnsicnVsZXMiOlswLDEsMjhdLCJpbmNsdXNpdmUiOnRydWV9fTsKcmV0dXJuIGxleGVyO30pKCkKcGFyc2VyLmxleGVyID0gbGV4ZXI7CmZ1bmN0aW9uIFBhcnNlciAoKSB7IHRoaXMueXkgPSB7fTsgfVBhcnNlci5wcm90b3R5cGUgPSBwYXJzZXI7cGFyc2VyLlBhcnNlciA9IFBhcnNlcjsKcmV0dXJuIG5ldyBQYXJzZXI7Cn0pKCk7CmlmICh0eXBlb2YgcmVxdWlyZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CmV4cG9ydHMucGFyc2VyID0gaGFuZGxlYmFyczsKZXhwb3J0cy5QYXJzZXIgPSBoYW5kbGViYXJzLlBhcnNlcjsKZXhwb3J0cy5wYXJzZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGhhbmRsZWJhcnMucGFyc2UuYXBwbHkoaGFuZGxlYmFycywgYXJndW1lbnRzKTsgfQpleHBvcnRzLm1haW4gPSBmdW5jdGlvbiBjb21tb25qc01haW4oYXJncykgewogICAgaWYgKCFhcmdzWzFdKQogICAgICAgIHRocm93IG5ldyBFcnJvcignVXNhZ2U6ICcrYXJnc1swXSsnIEZJTEUnKTsKICAgIHZhciBzb3VyY2UsIGN3ZDsKICAgIGlmICh0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICBzb3VyY2UgPSByZXF1aXJlKCdmcycpLnJlYWRGaWxlU3luYyhyZXF1aXJlKCdwYXRoJykucmVzb2x2ZShhcmdzWzFdKSwgInV0ZjgiKTsKICAgIH0gZWxzZSB7CiAgICAgICAgc291cmNlID0gcmVxdWlyZSgiZmlsZSIpLnBhdGgocmVxdWlyZSgiZmlsZSIpLmN3ZCgpKS5qb2luKGFyZ3NbMV0pLnJlYWQoe2NoYXJzZXQ6ICJ1dGYtOCJ9KTsKICAgIH0KICAgIHJldHVybiBleHBvcnRzLnBhcnNlci5wYXJzZShzb3VyY2UpOwp9CmlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiByZXF1aXJlLm1haW4gPT09IG1vZHVsZSkgewogIGV4cG9ydHMubWFpbih0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcgPyBwcm9jZXNzLmFyZ3Yuc2xpY2UoMSkgOiByZXF1aXJlKCJzeXN0ZW0iKS5hcmdzKTsKfQp9Owo7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL2Jhc2UuanMKSGFuZGxlYmFycy5QYXJzZXIgPSBoYW5kbGViYXJzOwoKSGFuZGxlYmFycy5wYXJzZSA9IGZ1bmN0aW9uKHN0cmluZykgewogIEhhbmRsZWJhcnMuUGFyc2VyLnl5ID0gSGFuZGxlYmFycy5BU1Q7CiAgcmV0dXJuIEhhbmRsZWJhcnMuUGFyc2VyLnBhcnNlKHN0cmluZyk7Cn07CgpIYW5kbGViYXJzLnByaW50ID0gZnVuY3Rpb24oYXN0KSB7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlByaW50VmlzaXRvcigpLmFjY2VwdChhc3QpOwp9OwoKSGFuZGxlYmFycy5sb2dnZXIgPSB7CiAgREVCVUc6IDAsIElORk86IDEsIFdBUk46IDIsIEVSUk9SOiAzLCBsZXZlbDogMywKCiAgLy8gb3ZlcnJpZGUgaW4gdGhlIGhvc3QgZW52aXJvbm1lbnQKICBsb2c6IGZ1bmN0aW9uKGxldmVsLCBzdHIpIHt9Cn07CgpIYW5kbGViYXJzLmxvZyA9IGZ1bmN0aW9uKGxldmVsLCBzdHIpIHsgSGFuZGxlYmFycy5sb2dnZXIubG9nKGxldmVsLCBzdHIpOyB9Owo7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL2FzdC5qcwooZnVuY3Rpb24oKSB7CgogIEhhbmRsZWJhcnMuQVNUID0ge307CgogIEhhbmRsZWJhcnMuQVNULlByb2dyYW1Ob2RlID0gZnVuY3Rpb24oc3RhdGVtZW50cywgaW52ZXJzZSkgewogICAgdGhpcy50eXBlID0gInByb2dyYW0iOwogICAgdGhpcy5zdGF0ZW1lbnRzID0gc3RhdGVtZW50czsKICAgIGlmKGludmVyc2UpIHsgdGhpcy5pbnZlcnNlID0gbmV3IEhhbmRsZWJhcnMuQVNULlByb2dyYW1Ob2RlKGludmVyc2UpOyB9CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuTXVzdGFjaGVOb2RlID0gZnVuY3Rpb24ocmF3UGFyYW1zLCBoYXNoLCB1bmVzY2FwZWQpIHsKICAgIHRoaXMudHlwZSA9ICJtdXN0YWNoZSI7CiAgICB0aGlzLmVzY2FwZWQgPSAhdW5lc2NhcGVkOwogICAgdGhpcy5oYXNoID0gaGFzaDsKCiAgICB2YXIgaWQgPSB0aGlzLmlkID0gcmF3UGFyYW1zWzBdOwogICAgdmFyIHBhcmFtcyA9IHRoaXMucGFyYW1zID0gcmF3UGFyYW1zLnNsaWNlKDEpOwoKICAgIC8vIGEgbXVzdGFjaGUgaXMgYW4gZWxpZ2libGUgaGVscGVyIGlmOgogICAgLy8gKiBpdHMgaWQgaXMgc2ltcGxlIChhIHNpbmdsZSBwYXJ0LCBub3QgYHRoaXNgIG9yIGAuLmApCiAgICB2YXIgZWxpZ2libGVIZWxwZXIgPSB0aGlzLmVsaWdpYmxlSGVscGVyID0gaWQuaXNTaW1wbGU7CgogICAgLy8gYSBtdXN0YWNoZSBpcyBkZWZpbml0ZWx5IGEgaGVscGVyIGlmOgogICAgLy8gKiBpdCBpcyBhbiBlbGlnaWJsZSBoZWxwZXIsIGFuZAogICAgLy8gKiBpdCBoYXMgYXQgbGVhc3Qgb25lIHBhcmFtZXRlciBvciBoYXNoIHNlZ21lbnQKICAgIHRoaXMuaXNIZWxwZXIgPSBlbGlnaWJsZUhlbHBlciAmJiAocGFyYW1zLmxlbmd0aCB8fCBoYXNoKTsKCiAgICAvLyBpZiBhIG11c3RhY2hlIGlzIGFuIGVsaWdpYmxlIGhlbHBlciBidXQgbm90IGEgZGVmaW5pdGUKICAgIC8vIGhlbHBlciwgaXQgaXMgYW1iaWd1b3VzLCBhbmQgd2lsbCBiZSByZXNvbHZlZCBpbiBhIGxhdGVyCiAgICAvLyBwYXNzIG9yIGF0IHJ1bnRpbWUuCiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuUGFydGlhbE5vZGUgPSBmdW5jdGlvbihpZCwgY29udGV4dCkgewogICAgdGhpcy50eXBlICAgID0gInBhcnRpYWwiOwoKICAgIC8vIFRPRE86IGRpc2FsbG93IGNvbXBsZXggSURzCgogICAgdGhpcy5pZCAgICAgID0gaWQ7CiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogIH07CgogIHZhciB2ZXJpZnlNYXRjaCA9IGZ1bmN0aW9uKG9wZW4sIGNsb3NlKSB7CiAgICBpZihvcGVuLm9yaWdpbmFsICE9PSBjbG9zZS5vcmlnaW5hbCkgewogICAgICB0aHJvdyBuZXcgSGFuZGxlYmFycy5FeGNlcHRpb24ob3Blbi5vcmlnaW5hbCArICIgZG9lc24ndCBtYXRjaCAiICsgY2xvc2Uub3JpZ2luYWwpOwogICAgfQogIH07CgogIEhhbmRsZWJhcnMuQVNULkJsb2NrTm9kZSA9IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlLCBjbG9zZSkgewogICAgdmVyaWZ5TWF0Y2gobXVzdGFjaGUuaWQsIGNsb3NlKTsKICAgIHRoaXMudHlwZSA9ICJibG9jayI7CiAgICB0aGlzLm11c3RhY2hlID0gbXVzdGFjaGU7CiAgICB0aGlzLnByb2dyYW0gID0gcHJvZ3JhbTsKICAgIHRoaXMuaW52ZXJzZSAgPSBpbnZlcnNlOwoKICAgIGlmICh0aGlzLmludmVyc2UgJiYgIXRoaXMucHJvZ3JhbSkgewogICAgICB0aGlzLmlzSW52ZXJzZSA9IHRydWU7CiAgICB9CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQ29udGVudE5vZGUgPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgIHRoaXMudHlwZSA9ICJjb250ZW50IjsKICAgIHRoaXMuc3RyaW5nID0gc3RyaW5nOwogIH07CgogIEhhbmRsZWJhcnMuQVNULkhhc2hOb2RlID0gZnVuY3Rpb24ocGFpcnMpIHsKICAgIHRoaXMudHlwZSA9ICJoYXNoIjsKICAgIHRoaXMucGFpcnMgPSBwYWlyczsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5JZE5vZGUgPSBmdW5jdGlvbihwYXJ0cykgewogICAgdGhpcy50eXBlID0gIklEIjsKICAgIHRoaXMub3JpZ2luYWwgPSBwYXJ0cy5qb2luKCIuIik7CgogICAgdmFyIGRpZyA9IFtdLCBkZXB0aCA9IDA7CgogICAgZm9yKHZhciBpPTAsbD1wYXJ0cy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgIHZhciBwYXJ0ID0gcGFydHNbaV07CgogICAgICBpZihwYXJ0ID09PSAiLi4iKSB7IGRlcHRoKys7IH0KICAgICAgZWxzZSBpZihwYXJ0ID09PSAiLiIgfHwgcGFydCA9PT0gInRoaXMiKSB7IHRoaXMuaXNTY29wZWQgPSB0cnVlOyB9CiAgICAgIGVsc2UgeyBkaWcucHVzaChwYXJ0KTsgfQogICAgfQoKICAgIHRoaXMucGFydHMgICAgPSBkaWc7CiAgICB0aGlzLnN0cmluZyAgID0gZGlnLmpvaW4oJy4nKTsKICAgIHRoaXMuZGVwdGggICAgPSBkZXB0aDsKCiAgICAvLyBhbiBJRCBpcyBzaW1wbGUgaWYgaXQgb25seSBoYXMgb25lIHBhcnQsIGFuZCB0aGF0IHBhcnQgaXMgbm90CiAgICAvLyBgLi5gIG9yIGB0aGlzYC4KICAgIHRoaXMuaXNTaW1wbGUgPSBwYXJ0cy5sZW5ndGggPT09IDEgJiYgIXRoaXMuaXNTY29wZWQgJiYgZGVwdGggPT09IDA7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuRGF0YU5vZGUgPSBmdW5jdGlvbihpZCkgewogICAgdGhpcy50eXBlID0gIkRBVEEiOwogICAgdGhpcy5pZCA9IGlkOwogIH07CgogIEhhbmRsZWJhcnMuQVNULlN0cmluZ05vZGUgPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgIHRoaXMudHlwZSA9ICJTVFJJTkciOwogICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuSW50ZWdlck5vZGUgPSBmdW5jdGlvbihpbnRlZ2VyKSB7CiAgICB0aGlzLnR5cGUgPSAiSU5URUdFUiI7CiAgICB0aGlzLmludGVnZXIgPSBpbnRlZ2VyOwogIH07CgogIEhhbmRsZWJhcnMuQVNULkJvb2xlYW5Ob2RlID0gZnVuY3Rpb24oYm9vbCkgewogICAgdGhpcy50eXBlID0gIkJPT0xFQU4iOwogICAgdGhpcy5ib29sID0gYm9vbDsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5Db21tZW50Tm9kZSA9IGZ1bmN0aW9uKGNvbW1lbnQpIHsKICAgIHRoaXMudHlwZSA9ICJjb21tZW50IjsKICAgIHRoaXMuY29tbWVudCA9IGNvbW1lbnQ7CiAgfTsKCn0pKCk7OwovLyBsaWIvaGFuZGxlYmFycy91dGlscy5qcwpIYW5kbGViYXJzLkV4Y2VwdGlvbiA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICB2YXIgdG1wID0gRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIGZvciAodmFyIHAgaW4gdG1wKSB7CiAgICBpZiAodG1wLmhhc093blByb3BlcnR5KHApKSB7IHRoaXNbcF0gPSB0bXBbcF07IH0KICB9CgogIHRoaXMubWVzc2FnZSA9IHRtcC5tZXNzYWdlOwp9OwpIYW5kbGViYXJzLkV4Y2VwdGlvbi5wcm90b3R5cGUgPSBuZXcgRXJyb3IoKTsKCi8vIEJ1aWxkIG91dCBvdXIgYmFzaWMgU2FmZVN0cmluZyB0eXBlCkhhbmRsZWJhcnMuU2FmZVN0cmluZyA9IGZ1bmN0aW9uKHN0cmluZykgewogIHRoaXMuc3RyaW5nID0gc3RyaW5nOwp9OwpIYW5kbGViYXJzLlNhZmVTdHJpbmcucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuc3RyaW5nLnRvU3RyaW5nKCk7Cn07CgooZnVuY3Rpb24oKSB7CiAgdmFyIGVzY2FwZSA9IHsKICAgICImIjogIiZhbXA7IiwKICAgICI8IjogIiZsdDsiLAogICAgIj4iOiAiJmd0OyIsCiAgICAnIic6ICImcXVvdDsiLAogICAgIiciOiAiJiN4Mjc7IiwKICAgICJgIjogIiYjeDYwOyIKICB9OwoKICB2YXIgYmFkQ2hhcnMgPSAvWyY8PiInYF0vZzsKICB2YXIgcG9zc2libGUgPSAvWyY8PiInYF0vOwoKICB2YXIgZXNjYXBlQ2hhciA9IGZ1bmN0aW9uKGNocikgewogICAgcmV0dXJuIGVzY2FwZVtjaHJdIHx8ICImYW1wOyI7CiAgfTsKCiAgSGFuZGxlYmFycy5VdGlscyA9IHsKICAgIGVzY2FwZUV4cHJlc3Npb246IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAvLyBkb24ndCBlc2NhcGUgU2FmZVN0cmluZ3MsIHNpbmNlIHRoZXkncmUgYWxyZWFkeSBzYWZlCiAgICAgIGlmIChzdHJpbmcgaW5zdGFuY2VvZiBIYW5kbGViYXJzLlNhZmVTdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyaW5nLnRvU3RyaW5nKCk7CiAgICAgIH0gZWxzZSBpZiAoc3RyaW5nID09IG51bGwgfHwgc3RyaW5nID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiAiIjsKICAgICAgfQoKICAgICAgaWYoIXBvc3NpYmxlLnRlc3Qoc3RyaW5nKSkgeyByZXR1cm4gc3RyaW5nOyB9CiAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShiYWRDaGFycywgZXNjYXBlQ2hhcik7CiAgICB9LAoKICAgIGlzRW1wdHk6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICJbb2JqZWN0IEFycmF5XSIgJiYgdmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgfTsKfSkoKTs7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL2NvbXBpbGVyLmpzCgovKmpzaGludCBlcW51bGw6dHJ1ZSovCkhhbmRsZWJhcnMuQ29tcGlsZXIgPSBmdW5jdGlvbigpIHt9OwpIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlciA9IGZ1bmN0aW9uKCkge307CgooZnVuY3Rpb24oQ29tcGlsZXIsIEphdmFTY3JpcHRDb21waWxlcikgewogIC8vIHRoZSBmb3VuZEhlbHBlciByZWdpc3RlciB3aWxsIGRpc2FtYmlndWF0ZSBoZWxwZXIgbG9va3VwIGZyb20gZmluZGluZyBhCiAgLy8gZnVuY3Rpb24gaW4gYSBjb250ZXh0LiBUaGlzIGlzIG5lY2Vzc2FyeSBmb3IgbXVzdGFjaGUgY29tcGF0aWJpbGl0eSwgd2hpY2gKICAvLyByZXF1aXJlcyB0aGF0IGNvbnRleHQgZnVuY3Rpb25zIGluIGJsb2NrcyBhcmUgZXZhbHVhdGVkIGJ5IGJsb2NrSGVscGVyTWlzc2luZywKICAvLyBhbmQgdGhlbiBwcm9jZWVkIGFzIGlmIHRoZSByZXN1bHRpbmcgdmFsdWUgd2FzIHByb3ZpZGVkIHRvIGJsb2NrSGVscGVyTWlzc2luZy4KCiAgQ29tcGlsZXIucHJvdG90eXBlID0gewogICAgY29tcGlsZXI6IENvbXBpbGVyLAoKICAgIGRpc2Fzc2VtYmxlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9wY29kZXMgPSB0aGlzLm9wY29kZXMsIG9wY29kZSwgb3V0ID0gW10sIHBhcmFtcywgcGFyYW07CgogICAgICBmb3IgKHZhciBpPTAsIGw9b3Bjb2Rlcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgb3Bjb2RlID0gb3Bjb2Rlc1tpXTsKCiAgICAgICAgaWYgKG9wY29kZS5vcGNvZGUgPT09ICdERUNMQVJFJykgewogICAgICAgICAgb3V0LnB1c2goIkRFQ0xBUkUgIiArIG9wY29kZS5uYW1lICsgIj0iICsgb3Bjb2RlLnZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGFyYW1zID0gW107CiAgICAgICAgICBmb3IgKHZhciBqPTA7IGo8b3Bjb2RlLmFyZ3MubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgcGFyYW0gPSBvcGNvZGUuYXJnc1tqXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBwYXJhbSA9ICJcIiIgKyBwYXJhbS5yZXBsYWNlKCJcbiIsICJcXG4iKSArICJcIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pOwogICAgICAgICAgfQogICAgICAgICAgb3V0LnB1c2gob3Bjb2RlLm9wY29kZSArICIgIiArIHBhcmFtcy5qb2luKCIgIikpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG91dC5qb2luKCJcbiIpOwogICAgfSwKCiAgICBndWlkOiAwLAoKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHByb2dyYW0sIG9wdGlvbnMpIHsKICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgICB0aGlzLmRlcHRocyA9IHtsaXN0OiBbXX07CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgogICAgICAvLyBUaGVzZSBjaGFuZ2VzIHdpbGwgcHJvcGFnYXRlIHRvIHRoZSBvdGhlciBjb21waWxlciBjb21wb25lbnRzCiAgICAgIHZhciBrbm93bkhlbHBlcnMgPSB0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzOwogICAgICB0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzID0gewogICAgICAgICdoZWxwZXJNaXNzaW5nJzogdHJ1ZSwKICAgICAgICAnYmxvY2tIZWxwZXJNaXNzaW5nJzogdHJ1ZSwKICAgICAgICAnZWFjaCc6IHRydWUsCiAgICAgICAgJ2lmJzogdHJ1ZSwKICAgICAgICAndW5sZXNzJzogdHJ1ZSwKICAgICAgICAnd2l0aCc6IHRydWUsCiAgICAgICAgJ2xvZyc6IHRydWUKICAgICAgfTsKICAgICAgaWYgKGtub3duSGVscGVycykgewogICAgICAgIGZvciAodmFyIG5hbWUgaW4ga25vd25IZWxwZXJzKSB7CiAgICAgICAgICB0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzW25hbWVdID0ga25vd25IZWxwZXJzW25hbWVdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMucHJvZ3JhbShwcm9ncmFtKTsKICAgIH0sCgogICAgYWNjZXB0OiBmdW5jdGlvbihub2RlKSB7CiAgICAgIHJldHVybiB0aGlzW25vZGUudHlwZV0obm9kZSk7CiAgICB9LAoKICAgIHByb2dyYW06IGZ1bmN0aW9uKHByb2dyYW0pIHsKICAgICAgdmFyIHN0YXRlbWVudHMgPSBwcm9ncmFtLnN0YXRlbWVudHMsIHN0YXRlbWVudDsKICAgICAgdGhpcy5vcGNvZGVzID0gW107CgogICAgICBmb3IodmFyIGk9MCwgbD1zdGF0ZW1lbnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBzdGF0ZW1lbnQgPSBzdGF0ZW1lbnRzW2ldOwogICAgICAgIHRoaXNbc3RhdGVtZW50LnR5cGVdKHN0YXRlbWVudCk7CiAgICAgIH0KICAgICAgdGhpcy5pc1NpbXBsZSA9IGwgPT09IDE7CgogICAgICB0aGlzLmRlcHRocy5saXN0ID0gdGhpcy5kZXB0aHMubGlzdC5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICByZXR1cm4gYSAtIGI7CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIGNvbXBpbGVQcm9ncmFtOiBmdW5jdGlvbihwcm9ncmFtKSB7CiAgICAgIHZhciByZXN1bHQgPSBuZXcgdGhpcy5jb21waWxlcigpLmNvbXBpbGUocHJvZ3JhbSwgdGhpcy5vcHRpb25zKTsKICAgICAgdmFyIGd1aWQgPSB0aGlzLmd1aWQrKywgZGVwdGg7CgogICAgICB0aGlzLnVzZVBhcnRpYWwgPSB0aGlzLnVzZVBhcnRpYWwgfHwgcmVzdWx0LnVzZVBhcnRpYWw7CgogICAgICB0aGlzLmNoaWxkcmVuW2d1aWRdID0gcmVzdWx0OwoKICAgICAgZm9yKHZhciBpPTAsIGw9cmVzdWx0LmRlcHRocy5saXN0Lmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBkZXB0aCA9IHJlc3VsdC5kZXB0aHMubGlzdFtpXTsKCiAgICAgICAgaWYoZGVwdGggPCAyKSB7IGNvbnRpbnVlOyB9CiAgICAgICAgZWxzZSB7IHRoaXMuYWRkRGVwdGgoZGVwdGggLSAxKTsgfQogICAgICB9CgogICAgICByZXR1cm4gZ3VpZDsKICAgIH0sCgogICAgYmxvY2s6IGZ1bmN0aW9uKGJsb2NrKSB7CiAgICAgIHZhciBtdXN0YWNoZSA9IGJsb2NrLm11c3RhY2hlLAogICAgICAgICAgcHJvZ3JhbSA9IGJsb2NrLnByb2dyYW0sCiAgICAgICAgICBpbnZlcnNlID0gYmxvY2suaW52ZXJzZTsKCiAgICAgIGlmIChwcm9ncmFtKSB7CiAgICAgICAgcHJvZ3JhbSA9IHRoaXMuY29tcGlsZVByb2dyYW0ocHJvZ3JhbSk7CiAgICAgIH0KCiAgICAgIGlmIChpbnZlcnNlKSB7CiAgICAgICAgaW52ZXJzZSA9IHRoaXMuY29tcGlsZVByb2dyYW0oaW52ZXJzZSk7CiAgICAgIH0KCiAgICAgIHZhciB0eXBlID0gdGhpcy5jbGFzc2lmeU11c3RhY2hlKG11c3RhY2hlKTsKCiAgICAgIGlmICh0eXBlID09PSAiaGVscGVyIikgewogICAgICAgIHRoaXMuaGVscGVyTXVzdGFjaGUobXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UpOwogICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJzaW1wbGUiKSB7CiAgICAgICAgdGhpcy5zaW1wbGVNdXN0YWNoZShtdXN0YWNoZSk7CgogICAgICAgIC8vIG5vdyB0aGF0IHRoZSBzaW1wbGUgbXVzdGFjaGUgaXMgcmVzb2x2ZWQsIHdlIG5lZWQgdG8KICAgICAgICAvLyBldmFsdWF0ZSBpdCBieSBleGVjdXRpbmcgYGJsb2NrSGVscGVyTWlzc2luZ2AKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgICB0aGlzLm9wY29kZSgnYmxvY2tWYWx1ZScpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYW1iaWd1b3VzTXVzdGFjaGUobXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UpOwoKICAgICAgICAvLyBub3cgdGhhdCB0aGUgc2ltcGxlIG11c3RhY2hlIGlzIHJlc29sdmVkLCB3ZSBuZWVkIHRvCiAgICAgICAgLy8gZXZhbHVhdGUgaXQgYnkgZXhlY3V0aW5nIGBibG9ja0hlbHBlck1pc3NpbmdgCiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgcHJvZ3JhbSk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgaW52ZXJzZSk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hMaXRlcmFsJywgJ3t9Jyk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FtYmlndW91c0Jsb2NrVmFsdWUnKTsKICAgICAgfQoKICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZCcpOwogICAgfSwKCiAgICBoYXNoOiBmdW5jdGlvbihoYXNoKSB7CiAgICAgIHZhciBwYWlycyA9IGhhc2gucGFpcnMsIHBhaXIsIHZhbDsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoJywgJ3t9Jyk7CgogICAgICBmb3IodmFyIGk9MCwgbD1wYWlycy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgcGFpciA9IHBhaXJzW2ldOwogICAgICAgIHZhbCAgPSBwYWlyWzFdOwoKICAgICAgICB0aGlzLmFjY2VwdCh2YWwpOwogICAgICAgIHRoaXMub3Bjb2RlKCdhc3NpZ25Ub0hhc2gnLCBwYWlyWzBdKTsKICAgICAgfQogICAgfSwKCiAgICBwYXJ0aWFsOiBmdW5jdGlvbihwYXJ0aWFsKSB7CiAgICAgIHZhciBpZCA9IHBhcnRpYWwuaWQ7CiAgICAgIHRoaXMudXNlUGFydGlhbCA9IHRydWU7CgogICAgICBpZihwYXJ0aWFsLmNvbnRleHQpIHsKICAgICAgICB0aGlzLklEKHBhcnRpYWwuY29udGV4dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2gnLCAnZGVwdGgwJyk7CiAgICAgIH0KCiAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VQYXJ0aWFsJywgaWQub3JpZ2luYWwpOwogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICB9LAoKICAgIGNvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZENvbnRlbnQnLCBjb250ZW50LnN0cmluZyk7CiAgICB9LAoKICAgIG11c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgICAgdmFyIHR5cGUgPSB0aGlzLmNsYXNzaWZ5TXVzdGFjaGUobXVzdGFjaGUpOwoKICAgICAgaWYgKHR5cGUgPT09ICJzaW1wbGUiKSB7CiAgICAgICAgdGhpcy5zaW1wbGVNdXN0YWNoZShtdXN0YWNoZSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gImhlbHBlciIpIHsKICAgICAgICB0aGlzLmhlbHBlck11c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFtYmlndW91c011c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfQoKICAgICAgaWYobXVzdGFjaGUuZXNjYXBlZCAmJiAhb3B0aW9ucy5ub0VzY2FwZSkgewogICAgICAgIHRoaXMub3Bjb2RlKCdhcHBlbmRFc2NhcGVkJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZCcpOwogICAgICB9CiAgICB9LAoKICAgIGFtYmlndW91c011c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgaWQgPSBtdXN0YWNoZS5pZCwgbmFtZSA9IGlkLnBhcnRzWzBdOwoKICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CgogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgaW52ZXJzZSk7CgogICAgICB0aGlzLm9wY29kZSgnaW52b2tlQW1iaWd1b3VzJywgbmFtZSk7CiAgICB9LAoKICAgIHNpbXBsZU11c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgaWQgPSBtdXN0YWNoZS5pZDsKCiAgICAgIGlmIChpZC50eXBlID09PSAnREFUQScpIHsKICAgICAgICB0aGlzLkRBVEEoaWQpOwogICAgICB9IGVsc2UgaWYgKGlkLnBhcnRzLmxlbmd0aCkgewogICAgICAgIHRoaXMuSUQoaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNpbXBsaWZpZWQgSUQgZm9yIGB0aGlzYAogICAgICAgIHRoaXMuYWRkRGVwdGgoaWQuZGVwdGgpOwogICAgICAgIHRoaXMub3Bjb2RlKCdnZXRDb250ZXh0JywgaWQuZGVwdGgpOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoQ29udGV4dCcpOwogICAgICB9CgogICAgICB0aGlzLm9wY29kZSgncmVzb2x2ZVBvc3NpYmxlTGFtYmRhJyk7CiAgICB9LAoKICAgIGhlbHBlck11c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgcGFyYW1zID0gdGhpcy5zZXR1cEZ1bGxNdXN0YWNoZVBhcmFtcyhtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSksCiAgICAgICAgICBuYW1lID0gbXVzdGFjaGUuaWQucGFydHNbMF07CgogICAgICBpZiAodGhpcy5vcHRpb25zLmtub3duSGVscGVyc1tuYW1lXSkgewogICAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VLbm93bkhlbHBlcicsIHBhcmFtcy5sZW5ndGgsIG5hbWUpOwogICAgICB9IGVsc2UgaWYgKHRoaXMua25vd25IZWxwZXJzT25seSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiWW91IHNwZWNpZmllZCBrbm93bkhlbHBlcnNPbmx5LCBidXQgdXNlZCB0aGUgdW5rbm93biBoZWxwZXIgIiArIG5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VIZWxwZXInLCBwYXJhbXMubGVuZ3RoLCBuYW1lKTsKICAgICAgfQogICAgfSwKCiAgICBJRDogZnVuY3Rpb24oaWQpIHsKICAgICAgdGhpcy5hZGREZXB0aChpZC5kZXB0aCk7CiAgICAgIHRoaXMub3Bjb2RlKCdnZXRDb250ZXh0JywgaWQuZGVwdGgpOwoKICAgICAgdmFyIG5hbWUgPSBpZC5wYXJ0c1swXTsKICAgICAgaWYgKCFuYW1lKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hDb250ZXh0Jyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cE9uQ29udGV4dCcsIGlkLnBhcnRzWzBdKTsKICAgICAgfQoKICAgICAgZm9yKHZhciBpPTEsIGw9aWQucGFydHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHRoaXMub3Bjb2RlKCdsb29rdXAnLCBpZC5wYXJ0c1tpXSk7CiAgICAgIH0KICAgIH0sCgogICAgREFUQTogZnVuY3Rpb24oZGF0YSkgewogICAgICB0aGlzLm9wdGlvbnMuZGF0YSA9IHRydWU7CiAgICAgIHRoaXMub3Bjb2RlKCdsb29rdXBEYXRhJywgZGF0YS5pZCk7CiAgICB9LAoKICAgIFNUUklORzogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoU3RyaW5nJywgc3RyaW5nLnN0cmluZyk7CiAgICB9LAoKICAgIElOVEVHRVI6IGZ1bmN0aW9uKGludGVnZXIpIHsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hMaXRlcmFsJywgaW50ZWdlci5pbnRlZ2VyKTsKICAgIH0sCgogICAgQk9PTEVBTjogZnVuY3Rpb24oYm9vbCkgewogICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCBib29sLmJvb2wpOwogICAgfSwKCiAgICBjb21tZW50OiBmdW5jdGlvbigpIHt9LAoKICAgIC8vIEhFTFBFUlMKICAgIG9wY29kZTogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLm9wY29kZXMucHVzaCh7IG9wY29kZTogbmFtZSwgYXJnczogW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpIH0pOwogICAgfSwKCiAgICBkZWNsYXJlOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICB0aGlzLm9wY29kZXMucHVzaCh7IG9wY29kZTogJ0RFQ0xBUkUnLCBuYW1lOiBuYW1lLCB2YWx1ZTogdmFsdWUgfSk7CiAgICB9LAoKICAgIGFkZERlcHRoOiBmdW5jdGlvbihkZXB0aCkgewogICAgICBpZihpc05hTihkZXB0aCkpIHsgdGhyb3cgbmV3IEVycm9yKCJFV09UIik7IH0KICAgICAgaWYoZGVwdGggPT09IDApIHsgcmV0dXJuOyB9CgogICAgICBpZighdGhpcy5kZXB0aHNbZGVwdGhdKSB7CiAgICAgICAgdGhpcy5kZXB0aHNbZGVwdGhdID0gdHJ1ZTsKICAgICAgICB0aGlzLmRlcHRocy5saXN0LnB1c2goZGVwdGgpOwogICAgICB9CiAgICB9LAoKICAgIGNsYXNzaWZ5TXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgICAgIHZhciBpc0hlbHBlciAgID0gbXVzdGFjaGUuaXNIZWxwZXI7CiAgICAgIHZhciBpc0VsaWdpYmxlID0gbXVzdGFjaGUuZWxpZ2libGVIZWxwZXI7CiAgICAgIHZhciBvcHRpb25zICAgID0gdGhpcy5vcHRpb25zOwoKICAgICAgLy8gaWYgYW1iaWd1b3VzLCB3ZSBjYW4gcG9zc2libHkgcmVzb2x2ZSB0aGUgYW1iaWd1aXR5IG5vdwogICAgICBpZiAoaXNFbGlnaWJsZSAmJiAhaXNIZWxwZXIpIHsKICAgICAgICB2YXIgbmFtZSA9IG11c3RhY2hlLmlkLnBhcnRzWzBdOwoKICAgICAgICBpZiAob3B0aW9ucy5rbm93bkhlbHBlcnNbbmFtZV0pIHsKICAgICAgICAgIGlzSGVscGVyID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMua25vd25IZWxwZXJzT25seSkgewogICAgICAgICAgaXNFbGlnaWJsZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlzSGVscGVyKSB7IHJldHVybiAiaGVscGVyIjsgfQogICAgICBlbHNlIGlmIChpc0VsaWdpYmxlKSB7IHJldHVybiAiYW1iaWd1b3VzIjsgfQogICAgICBlbHNlIHsgcmV0dXJuICJzaW1wbGUiOyB9CiAgICB9LAoKICAgIHB1c2hQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICB2YXIgaSA9IHBhcmFtcy5sZW5ndGgsIHBhcmFtOwoKICAgICAgd2hpbGUoaS0tKSB7CiAgICAgICAgcGFyYW0gPSBwYXJhbXNbaV07CgogICAgICAgIGlmKHRoaXMub3B0aW9ucy5zdHJpbmdQYXJhbXMpIHsKICAgICAgICAgIGlmKHBhcmFtLmRlcHRoKSB7CiAgICAgICAgICAgIHRoaXMuYWRkRGVwdGgocGFyYW0uZGVwdGgpOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMub3Bjb2RlKCdnZXRDb250ZXh0JywgcGFyYW0uZGVwdGggfHwgMCk7CiAgICAgICAgICB0aGlzLm9wY29kZSgncHVzaFN0cmluZ1BhcmFtJywgcGFyYW0uc3RyaW5nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpc1twYXJhbS50eXBlXShwYXJhbSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHNldHVwTXVzdGFjaGVQYXJhbXM6IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgICAgIHZhciBwYXJhbXMgPSBtdXN0YWNoZS5wYXJhbXM7CiAgICAgIHRoaXMucHVzaFBhcmFtcyhwYXJhbXMpOwoKICAgICAgaWYobXVzdGFjaGUuaGFzaCkgewogICAgICAgIHRoaXMuaGFzaChtdXN0YWNoZS5oYXNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH0sCgogICAgLy8gdGhpcyB3aWxsIHJlcGxhY2Ugc2V0dXBNdXN0YWNoZVBhcmFtcyB3aGVuIHdlJ3JlIGRvbmUKICAgIHNldHVwRnVsbE11c3RhY2hlUGFyYW1zOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgcGFyYW1zID0gbXVzdGFjaGUucGFyYW1zOwogICAgICB0aGlzLnB1c2hQYXJhbXMocGFyYW1zKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKCiAgICAgIGlmKG11c3RhY2hlLmhhc2gpIHsKICAgICAgICB0aGlzLmhhc2gobXVzdGFjaGUuaGFzaCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hMaXRlcmFsJywgJ3t9Jyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwYXJhbXM7CiAgICB9CiAgfTsKCiAgdmFyIExpdGVyYWwgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIH07CgogIEphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUgPSB7CiAgICAvLyBQVUJMSUMgQVBJOiBZb3UgY2FuIG92ZXJyaWRlIHRoZXNlIG1ldGhvZHMgaW4gYSBzdWJjbGFzcyB0byBwcm92aWRlCiAgICAvLyBhbHRlcm5hdGl2ZSBjb21waWxlZCBmb3JtcyBmb3IgbmFtZSBsb29rdXAgYW5kIGJ1ZmZlcmluZyBzZW1hbnRpY3MKICAgIG5hbWVMb29rdXA6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSwgdHlwZSkgewogICAgICBpZiAoL15bMC05XSskLy50ZXN0KG5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHBhcmVudCArICJbIiArIG5hbWUgKyAiXSI7CiAgICAgIH0gZWxzZSBpZiAoSmF2YVNjcmlwdENvbXBpbGVyLmlzVmFsaWRKYXZhU2NyaXB0VmFyaWFibGVOYW1lKG5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHBhcmVudCArICIuIiArIG5hbWU7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgcmV0dXJuIHBhcmVudCArICJbJyIgKyBuYW1lICsgIiddIjsKICAgICAgfQogICAgfSwKCiAgICBhcHBlbmRUb0J1ZmZlcjogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIGlmICh0aGlzLmVudmlyb25tZW50LmlzU2ltcGxlKSB7CiAgICAgICAgcmV0dXJuICJyZXR1cm4gIiArIHN0cmluZyArICI7IjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gImJ1ZmZlciArPSAiICsgc3RyaW5nICsgIjsiOwogICAgICB9CiAgICB9LAoKICAgIGluaXRpYWxpemVCdWZmZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5xdW90ZWRTdHJpbmcoIiIpOwogICAgfSwKCiAgICBuYW1lc3BhY2U6ICJIYW5kbGViYXJzIiwKICAgIC8vIEVORCBQVUJMSUMgQVBJCgogICAgY29tcGlsZTogZnVuY3Rpb24oZW52aXJvbm1lbnQsIG9wdGlvbnMsIGNvbnRleHQsIGFzT2JqZWN0KSB7CiAgICAgIHRoaXMuZW52aXJvbm1lbnQgPSBlbnZpcm9ubWVudDsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgIEhhbmRsZWJhcnMubG9nKEhhbmRsZWJhcnMubG9nZ2VyLkRFQlVHLCB0aGlzLmVudmlyb25tZW50LmRpc2Fzc2VtYmxlKCkgKyAiXG5cbiIpOwoKICAgICAgdGhpcy5uYW1lID0gdGhpcy5lbnZpcm9ubWVudC5uYW1lOwogICAgICB0aGlzLmlzQ2hpbGQgPSAhIWNvbnRleHQ7CiAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQgfHwgewogICAgICAgIHByb2dyYW1zOiBbXSwKICAgICAgICBhbGlhc2VzOiB7IH0KICAgICAgfTsKCiAgICAgIHRoaXMucHJlYW1ibGUoKTsKCiAgICAgIHRoaXMuc3RhY2tTbG90ID0gMDsKICAgICAgdGhpcy5zdGFja1ZhcnMgPSBbXTsKICAgICAgdGhpcy5yZWdpc3RlcnMgPSB7IGxpc3Q6IFtdIH07CiAgICAgIHRoaXMuY29tcGlsZVN0YWNrID0gW107CgogICAgICB0aGlzLmNvbXBpbGVDaGlsZHJlbihlbnZpcm9ubWVudCwgb3B0aW9ucyk7CgogICAgICB2YXIgb3Bjb2RlcyA9IGVudmlyb25tZW50Lm9wY29kZXMsIG9wY29kZTsKCiAgICAgIHRoaXMuaSA9IDA7CgogICAgICBmb3IobD1vcGNvZGVzLmxlbmd0aDsgdGhpcy5pPGw7IHRoaXMuaSsrKSB7CiAgICAgICAgb3Bjb2RlID0gb3Bjb2Rlc1t0aGlzLmldOwoKICAgICAgICBpZihvcGNvZGUub3Bjb2RlID09PSAnREVDTEFSRScpIHsKICAgICAgICAgIHRoaXNbb3Bjb2RlLm5hbWVdID0gb3Bjb2RlLnZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW29wY29kZS5vcGNvZGVdLmFwcGx5KHRoaXMsIG9wY29kZS5hcmdzKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUZ1bmN0aW9uQ29udGV4dChhc09iamVjdCk7CiAgICB9LAoKICAgIG5leHRPcGNvZGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3Bjb2RlcyA9IHRoaXMuZW52aXJvbm1lbnQub3Bjb2Rlcywgb3Bjb2RlID0gb3Bjb2Rlc1t0aGlzLmkgKyAxXTsKICAgICAgcmV0dXJuIG9wY29kZXNbdGhpcy5pICsgMV07CiAgICB9LAoKICAgIGVhdDogZnVuY3Rpb24ob3Bjb2RlKSB7CiAgICAgIHRoaXMuaSA9IHRoaXMuaSArIDE7CiAgICB9LAoKICAgIHByZWFtYmxlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG91dCA9IFtdOwoKICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5uYW1lc3BhY2U7CiAgICAgICAgdmFyIGNvcGllcyA9ICJoZWxwZXJzID0gaGVscGVycyB8fCAiICsgbmFtZXNwYWNlICsgIi5oZWxwZXJzOyI7CiAgICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQudXNlUGFydGlhbCkgeyBjb3BpZXMgPSBjb3BpZXMgKyAiIHBhcnRpYWxzID0gcGFydGlhbHMgfHwgIiArIG5hbWVzcGFjZSArICIucGFydGlhbHM7IjsgfQogICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZGF0YSkgeyBjb3BpZXMgPSBjb3BpZXMgKyAiIGRhdGEgPSBkYXRhIHx8IHt9OyI7IH0KICAgICAgICBvdXQucHVzaChjb3BpZXMpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dC5wdXNoKCcnKTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLmVudmlyb25tZW50LmlzU2ltcGxlKSB7CiAgICAgICAgb3V0LnB1c2goIiwgYnVmZmVyID0gIiArIHRoaXMuaW5pdGlhbGl6ZUJ1ZmZlcigpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXQucHVzaCgiIik7CiAgICAgIH0KCiAgICAgIC8vIHRyYWNrIHRoZSBsYXN0IGNvbnRleHQgcHVzaGVkIGludG8gcGxhY2UgdG8gYWxsb3cgc2tpcHBpbmcgdGhlCiAgICAgIC8vIGdldENvbnRleHQgb3Bjb2RlIHdoZW4gaXQgd291bGQgYmUgYSBub29wCiAgICAgIHRoaXMubGFzdENvbnRleHQgPSAwOwogICAgICB0aGlzLnNvdXJjZSA9IG91dDsKICAgIH0sCgogICAgY3JlYXRlRnVuY3Rpb25Db250ZXh0OiBmdW5jdGlvbihhc09iamVjdCkgewogICAgICB2YXIgbG9jYWxzID0gdGhpcy5zdGFja1ZhcnMuY29uY2F0KHRoaXMucmVnaXN0ZXJzLmxpc3QpOwoKICAgICAgaWYobG9jYWxzLmxlbmd0aCA+IDApIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSA9IHRoaXMuc291cmNlWzFdICsgIiwgIiArIGxvY2Fscy5qb2luKCIsICIpOwogICAgICB9CgogICAgICAvLyBHZW5lcmF0ZSBtaW5pbWl6ZXIgYWxpYXMgbWFwcGluZ3MKICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB2YXIgYWxpYXNlcyA9IFtdOwogICAgICAgIGZvciAodmFyIGFsaWFzIGluIHRoaXMuY29udGV4dC5hbGlhc2VzKSB7CiAgICAgICAgICB0aGlzLnNvdXJjZVsxXSA9IHRoaXMuc291cmNlWzFdICsgJywgJyArIGFsaWFzICsgJz0nICsgdGhpcy5jb250ZXh0LmFsaWFzZXNbYWxpYXNdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMuc291cmNlWzFdKSB7CiAgICAgICAgdGhpcy5zb3VyY2VbMV0gPSAidmFyICIgKyB0aGlzLnNvdXJjZVsxXS5zdWJzdHJpbmcoMikgKyAiOyI7CiAgICAgIH0KCiAgICAgIC8vIE1lcmdlIGNoaWxkcmVuCiAgICAgIGlmICghdGhpcy5pc0NoaWxkKSB7CiAgICAgICAgdGhpcy5zb3VyY2VbMV0gKz0gJ1xuJyArIHRoaXMuY29udGV4dC5wcm9ncmFtcy5qb2luKCdcbicpICsgJ1xuJzsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLmVudmlyb25tZW50LmlzU2ltcGxlKSB7CiAgICAgICAgdGhpcy5zb3VyY2UucHVzaCgicmV0dXJuIGJ1ZmZlcjsiKTsKICAgICAgfQoKICAgICAgdmFyIHBhcmFtcyA9IHRoaXMuaXNDaGlsZCA/IFsiZGVwdGgwIiwgImRhdGEiXSA6IFsiSGFuZGxlYmFycyIsICJkZXB0aDAiLCAiaGVscGVycyIsICJwYXJ0aWFscyIsICJkYXRhIl07CgogICAgICBmb3IodmFyIGk9MCwgbD10aGlzLmVudmlyb25tZW50LmRlcHRocy5saXN0Lmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBwYXJhbXMucHVzaCgiZGVwdGgiICsgdGhpcy5lbnZpcm9ubWVudC5kZXB0aHMubGlzdFtpXSk7CiAgICAgIH0KCiAgICAgIGlmIChhc09iamVjdCkgewogICAgICAgIHBhcmFtcy5wdXNoKHRoaXMuc291cmNlLmpvaW4oIlxuICAiKSk7CgogICAgICAgIHJldHVybiBGdW5jdGlvbi5hcHBseSh0aGlzLCBwYXJhbXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBmdW5jdGlvblNvdXJjZSA9ICdmdW5jdGlvbiAnICsgKHRoaXMubmFtZSB8fCAnJykgKyAnKCcgKyBwYXJhbXMuam9pbignLCcpICsgJykge1xuICAnICsgdGhpcy5zb3VyY2Uuam9pbigiXG4gICIpICsgJ30nOwogICAgICAgIEhhbmRsZWJhcnMubG9nKEhhbmRsZWJhcnMubG9nZ2VyLkRFQlVHLCBmdW5jdGlvblNvdXJjZSArICJcblxuIik7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uU291cmNlOwogICAgICB9CiAgICB9LAoKICAgIC8vIFtibG9ja1ZhbHVlXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHZhbHVlCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHJldHVybiB2YWx1ZSBvZiBibG9ja0hlbHBlck1pc3NpbmcKICAgIC8vCiAgICAvLyBUaGUgcHVycG9zZSBvZiB0aGlzIG9wY29kZSBpcyB0byB0YWtlIGEgYmxvY2sgb2YgdGhlIGZvcm0KICAgIC8vIGB7eyNmb299fS4uLnt7L2Zvb319YCwgcmVzb2x2ZSB0aGUgdmFsdWUgb2YgYGZvb2AsIGFuZAogICAgLy8gcmVwbGFjZSBpdCBvbiB0aGUgc3RhY2sgd2l0aCB0aGUgcmVzdWx0IG9mIHByb3Blcmx5CiAgICAvLyBpbnZva2luZyBibG9ja0hlbHBlck1pc3NpbmcuCiAgICBibG9ja1ZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuYmxvY2tIZWxwZXJNaXNzaW5nID0gJ2hlbHBlcnMuYmxvY2tIZWxwZXJNaXNzaW5nJzsKCiAgICAgIHZhciBwYXJhbXMgPSBbImRlcHRoMCJdOwogICAgICB0aGlzLnNldHVwUGFyYW1zKDAsIHBhcmFtcyk7CgogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcGFyYW1zLnNwbGljZSgxLCAwLCBjdXJyZW50KTsKICAgICAgICByZXR1cm4gY3VycmVudCArICIgPSBibG9ja0hlbHBlck1pc3NpbmcuY2FsbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKSI7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbYW1iaWd1b3VzQmxvY2tWYWx1ZV0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCB2YWx1ZQogICAgLy8gQ29tcGlsZXIgdmFsdWUsIGJlZm9yZTogbGFzdEhlbHBlcj12YWx1ZSBvZiBsYXN0IGZvdW5kIGhlbHBlciwgaWYgYW55CiAgICAvLyBPbiBzdGFjaywgYWZ0ZXIsIGlmIG5vIGxhc3RIZWxwZXI6IHNhbWUgYXMgW2Jsb2NrVmFsdWVdCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXIsIGlmIGxhc3RIZWxwZXI6IHZhbHVlCiAgICBhbWJpZ3VvdXNCbG9ja1ZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuYmxvY2tIZWxwZXJNaXNzaW5nID0gJ2hlbHBlcnMuYmxvY2tIZWxwZXJNaXNzaW5nJzsKCiAgICAgIHZhciBwYXJhbXMgPSBbImRlcHRoMCJdOwogICAgICB0aGlzLnNldHVwUGFyYW1zKDAsIHBhcmFtcyk7CgogICAgICB2YXIgY3VycmVudCA9IHRoaXMudG9wU3RhY2soKTsKICAgICAgcGFyYW1zLnNwbGljZSgxLCAwLCBjdXJyZW50KTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2goImlmICghIiArIHRoaXMubGFzdEhlbHBlciArICIpIHsgIiArIGN1cnJlbnQgKyAiID0gYmxvY2tIZWxwZXJNaXNzaW5nLmNhbGwoIiArIHBhcmFtcy5qb2luKCIsICIpICsgIik7IH0iKTsKICAgIH0sCgogICAgLy8gW2FwcGVuZENvbnRlbnRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IC4uLgogICAgLy8KICAgIC8vIEFwcGVuZHMgdGhlIHN0cmluZyB2YWx1ZSBvZiBgY29udGVudGAgdG8gdGhlIGN1cnJlbnQgYnVmZmVyCiAgICBhcHBlbmRDb250ZW50OiBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgIHRoaXMuc291cmNlLnB1c2godGhpcy5hcHBlbmRUb0J1ZmZlcih0aGlzLnF1b3RlZFN0cmluZyhjb250ZW50KSkpOwogICAgfSwKCiAgICAvLyBbYXBwZW5kXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gQ29lcmNlcyBgdmFsdWVgIHRvIGEgU3RyaW5nIGFuZCBhcHBlbmRzIGl0IHRvIHRoZSBjdXJyZW50IGJ1ZmZlci4KICAgIC8vCiAgICAvLyBJZiBgdmFsdWVgIGlzIHRydXRoeSwgb3IgMCwgaXQgaXMgY29lcmNlZCBpbnRvIGEgc3RyaW5nIGFuZCBhcHBlbmRlZAogICAgLy8gT3RoZXJ3aXNlLCB0aGUgZW1wdHkgc3RyaW5nIGlzIGFwcGVuZGVkCiAgICBhcHBlbmQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbG9jYWwgPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgIHRoaXMuc291cmNlLnB1c2goImlmKCIgKyBsb2NhbCArICIgfHwgIiArIGxvY2FsICsgIiA9PT0gMCkgeyAiICsgdGhpcy5hcHBlbmRUb0J1ZmZlcihsb2NhbCkgKyAiIH0iKTsKICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICB0aGlzLnNvdXJjZS5wdXNoKCJlbHNlIHsgIiArIHRoaXMuYXBwZW5kVG9CdWZmZXIoIicnIikgKyAiIH0iKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBbYXBwZW5kRXNjYXBlZF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiB2YWx1ZSwgLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IC4uLgogICAgLy8KICAgIC8vIEVzY2FwZSBgdmFsdWVgIGFuZCBhcHBlbmQgaXQgdG8gdGhlIGJ1ZmZlcgogICAgYXBwZW5kRXNjYXBlZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcGNvZGUgPSB0aGlzLm5leHRPcGNvZGUoKSwgZXh0cmEgPSAiIjsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuZXNjYXBlRXhwcmVzc2lvbiA9ICd0aGlzLmVzY2FwZUV4cHJlc3Npb24nOwoKICAgICAgaWYob3Bjb2RlICYmIG9wY29kZS5vcGNvZGUgPT09ICdhcHBlbmRDb250ZW50JykgewogICAgICAgIGV4dHJhID0gIiArICIgKyB0aGlzLnF1b3RlZFN0cmluZyhvcGNvZGUuYXJnc1swXSk7CiAgICAgICAgdGhpcy5lYXQob3Bjb2RlKTsKICAgICAgfQoKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmFwcGVuZFRvQnVmZmVyKCJlc2NhcGVFeHByZXNzaW9uKCIgKyB0aGlzLnBvcFN0YWNrKCkgKyAiKSIgKyBleHRyYSkpOwogICAgfSwKCiAgICAvLyBbZ2V0Q29udGV4dF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLyBDb21waWxlciB2YWx1ZSwgYWZ0ZXI6IGxhc3RDb250ZXh0PWRlcHRoCiAgICAvLwogICAgLy8gU2V0IHRoZSB2YWx1ZSBvZiB0aGUgYGxhc3RDb250ZXh0YCBjb21waWxlciB2YWx1ZSB0byB0aGUgZGVwdGgKICAgIGdldENvbnRleHQ6IGZ1bmN0aW9uKGRlcHRoKSB7CiAgICAgIGlmKHRoaXMubGFzdENvbnRleHQgIT09IGRlcHRoKSB7CiAgICAgICAgdGhpcy5sYXN0Q29udGV4dCA9IGRlcHRoOwogICAgICB9CiAgICB9LAoKICAgIC8vIFtsb29rdXBPbkNvbnRleHRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IGN1cnJlbnRDb250ZXh0W25hbWVdLCAuLi4KICAgIC8vCiAgICAvLyBMb29rcyB1cCB0aGUgdmFsdWUgb2YgYG5hbWVgIG9uIHRoZSBjdXJyZW50IGNvbnRleHQgYW5kIHB1c2hlcwogICAgLy8gaXQgb250byB0aGUgc3RhY2suCiAgICBsb29rdXBPbkNvbnRleHQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdGhpcy5wdXNoU3RhY2sodGhpcy5uYW1lTG9va3VwKCdkZXB0aCcgKyB0aGlzLmxhc3RDb250ZXh0LCBuYW1lLCAnY29udGV4dCcpKTsKICAgIH0sCgogICAgLy8gW3B1c2hDb250ZXh0XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBjdXJyZW50Q29udGV4dCwgLi4uCiAgICAvLwogICAgLy8gUHVzaGVzIHRoZSB2YWx1ZSBvZiB0aGUgY3VycmVudCBjb250ZXh0IG9udG8gdGhlIHN0YWNrLgogICAgcHVzaENvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQpOwogICAgfSwKCiAgICAvLyBbcmVzb2x2ZVBvc3NpYmxlTGFtYmRhXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmVzb2x2ZWQgdmFsdWUsIC4uLgogICAgLy8KICAgIC8vIElmIHRoZSBgdmFsdWVgIGlzIGEgbGFtYmRhLCByZXBsYWNlIGl0IG9uIHRoZSBzdGFjayBieQogICAgLy8gdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgbGFtYmRhCiAgICByZXNvbHZlUG9zc2libGVMYW1iZGE6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5mdW5jdGlvblR5cGUgPSAnImZ1bmN0aW9uIic7CgogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcmV0dXJuICJ0eXBlb2YgIiArIGN1cnJlbnQgKyAiID09PSBmdW5jdGlvblR5cGUgPyAiICsgY3VycmVudCArICIoKSA6ICIgKyBjdXJyZW50OwogICAgICB9KTsKICAgIH0sCgogICAgLy8gW2xvb2t1cF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiB2YWx1ZSwgLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHZhbHVlW25hbWVdLCAuLi4KICAgIC8vCiAgICAvLyBSZXBsYWNlIHRoZSB2YWx1ZSBvbiB0aGUgc3RhY2sgd2l0aCB0aGUgcmVzdWx0IG9mIGxvb2tpbmcKICAgIC8vIHVwIGBuYW1lYCBvbiBgdmFsdWVgCiAgICBsb29rdXA6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdGhpcy5yZXBsYWNlU3RhY2soZnVuY3Rpb24oY3VycmVudCkgewogICAgICAgIHJldHVybiBjdXJyZW50ICsgIiA9PSBudWxsIHx8ICIgKyBjdXJyZW50ICsgIiA9PT0gZmFsc2UgPyAiICsgY3VycmVudCArICIgOiAiICsgdGhpcy5uYW1lTG9va3VwKGN1cnJlbnQsIG5hbWUsICdjb250ZXh0Jyk7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbbG9va3VwRGF0YV0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogZGF0YVtpZF0sIC4uLgogICAgLy8KICAgIC8vIFB1c2ggdGhlIHJlc3VsdCBvZiBsb29raW5nIHVwIGBpZGAgb24gdGhlIGN1cnJlbnQgZGF0YQogICAgbG9va3VwRGF0YTogZnVuY3Rpb24oaWQpIHsKICAgICAgdGhpcy5wdXNoU3RhY2sodGhpcy5uYW1lTG9va3VwKCdkYXRhJywgaWQsICdkYXRhJykpOwogICAgfSwKCiAgICAvLyBbcHVzaFN0cmluZ1BhcmFtXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBzdHJpbmcsIGN1cnJlbnRDb250ZXh0LCAuLi4KICAgIC8vCiAgICAvLyBUaGlzIG9wY29kZSBpcyBkZXNpZ25lZCBmb3IgdXNlIGluIHN0cmluZyBtb2RlLCB3aGljaAogICAgLy8gcHJvdmlkZXMgdGhlIHN0cmluZyB2YWx1ZSBvZiBhIHBhcmFtZXRlciBhbG9uZyB3aXRoIGl0cwogICAgLy8gZGVwdGggcmF0aGVyIHRoYW4gcmVzb2x2aW5nIGl0IGltbWVkaWF0ZWx5LgogICAgcHVzaFN0cmluZ1BhcmFtOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKCdkZXB0aCcgKyB0aGlzLmxhc3RDb250ZXh0KTsKICAgICAgdGhpcy5wdXNoU3RyaW5nKHN0cmluZyk7CiAgICB9LAoKICAgIC8vIFtwdXNoU3RyaW5nXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBxdW90ZWRTdHJpbmcoc3RyaW5nKSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCBhIHF1b3RlZCB2ZXJzaW9uIG9mIGBzdHJpbmdgIG9udG8gdGhlIHN0YWNrCiAgICBwdXNoU3RyaW5nOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKHRoaXMucXVvdGVkU3RyaW5nKHN0cmluZykpOwogICAgfSwKCiAgICAvLyBbcHVzaF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogZXhwciwgLi4uCiAgICAvLwogICAgLy8gUHVzaCBhbiBleHByZXNzaW9uIG9udG8gdGhlIHN0YWNrCiAgICBwdXNoOiBmdW5jdGlvbihleHByKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrKGV4cHIpOwogICAgfSwKCiAgICAvLyBbcHVzaExpdGVyYWxdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHZhbHVlLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoZXMgYSB2YWx1ZSBvbnRvIHRoZSBzdGFjay4gVGhpcyBvcGVyYXRpb24gcHJldmVudHMKICAgIC8vIHRoZSBjb21waWxlciBmcm9tIGNyZWF0aW5nIGEgdGVtcG9yYXJ5IHZhcmlhYmxlIHRvIGhvbGQKICAgIC8vIGl0LgogICAgcHVzaExpdGVyYWw6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCh2YWx1ZSk7CiAgICB9LAoKICAgIC8vIFtwdXNoUHJvZ3JhbV0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcHJvZ3JhbShndWlkKSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCBhIHByb2dyYW0gZXhwcmVzc2lvbiBvbnRvIHRoZSBzdGFjay4gVGhpcyB0YWtlcwogICAgLy8gYSBjb21waWxlLXRpbWUgZ3VpZCBhbmQgY29udmVydHMgaXQgaW50byBhIHJ1bnRpbWUtYWNjZXNzaWJsZQogICAgLy8gZXhwcmVzc2lvbi4KICAgIHB1c2hQcm9ncmFtOiBmdW5jdGlvbihndWlkKSB7CiAgICAgIGlmIChndWlkICE9IG51bGwpIHsKICAgICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwodGhpcy5wcm9ncmFtRXhwcmVzc2lvbihndWlkKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKG51bGwpOwogICAgICB9CiAgICB9LAoKICAgIC8vIFtpbnZva2VIZWxwZXJdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgcGFyYW1zLi4uLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmVzdWx0IG9mIGhlbHBlciBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gUG9wcyBvZmYgdGhlIGhlbHBlcidzIHBhcmFtZXRlcnMsIGludm9rZXMgdGhlIGhlbHBlciwKICAgIC8vIGFuZCBwdXNoZXMgdGhlIGhlbHBlcidzIHJldHVybiB2YWx1ZSBvbnRvIHRoZSBzdGFjay4KICAgIC8vCiAgICAvLyBJZiB0aGUgaGVscGVyIGlzIG5vdCBmb3VuZCwgYGhlbHBlck1pc3NpbmdgIGlzIGNhbGxlZC4KICAgIGludm9rZUhlbHBlcjogZnVuY3Rpb24ocGFyYW1TaXplLCBuYW1lKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmhlbHBlck1pc3NpbmcgPSAnaGVscGVycy5oZWxwZXJNaXNzaW5nJzsKCiAgICAgIHZhciBoZWxwZXIgPSB0aGlzLmxhc3RIZWxwZXIgPSB0aGlzLnNldHVwSGVscGVyKHBhcmFtU2l6ZSwgbmFtZSk7CiAgICAgIHRoaXMucmVnaXN0ZXIoJ2ZvdW5kSGVscGVyJywgaGVscGVyLm5hbWUpOwoKICAgICAgdGhpcy5wdXNoU3RhY2soImZvdW5kSGVscGVyID8gZm91bmRIZWxwZXIuY2FsbCgiICsKICAgICAgICBoZWxwZXIuY2FsbFBhcmFtcyArICIpICIgKyAiOiBoZWxwZXJNaXNzaW5nLmNhbGwoIiArCiAgICAgICAgaGVscGVyLmhlbHBlck1pc3NpbmdQYXJhbXMgKyAiKSIpOwogICAgfSwKCiAgICAvLyBbaW52b2tlS25vd25IZWxwZXJdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgcGFyYW1zLi4uLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmVzdWx0IG9mIGhlbHBlciBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gaXMgdXNlZCB3aGVuIHRoZSBoZWxwZXIgaXMga25vd24gdG8gZXhpc3QsCiAgICAvLyBzbyBhIGBoZWxwZXJNaXNzaW5nYCBmYWxsYmFjayBpcyBub3QgcmVxdWlyZWQuCiAgICBpbnZva2VLbm93bkhlbHBlcjogZnVuY3Rpb24ocGFyYW1TaXplLCBuYW1lKSB7CiAgICAgIHZhciBoZWxwZXIgPSB0aGlzLnNldHVwSGVscGVyKHBhcmFtU2l6ZSwgbmFtZSk7CiAgICAgIHRoaXMucHVzaFN0YWNrKGhlbHBlci5uYW1lICsgIi5jYWxsKCIgKyBoZWxwZXIuY2FsbFBhcmFtcyArICIpIik7CiAgICB9LAoKICAgIC8vIFtpbnZva2VBbWJpZ3VvdXNdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgcGFyYW1zLi4uLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmVzdWx0IG9mIGRpc2FtYmlndWF0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gaXMgdXNlZCB3aGVuIGFuIGV4cHJlc3Npb24gbGlrZSBge3tmb299fWAKICAgIC8vIGlzIHByb3ZpZGVkLCBidXQgd2UgZG9uJ3Qga25vdyBhdCBjb21waWxlLXRpbWUgd2hldGhlciBpdAogICAgLy8gaXMgYSBoZWxwZXIgb3IgYSBwYXRoLgogICAgLy8KICAgIC8vIFRoaXMgb3BlcmF0aW9uIGVtaXRzIG1vcmUgY29kZSB0aGFuIHRoZSBvdGhlciBvcHRpb25zLAogICAgLy8gYW5kIGNhbiBiZSBhdm9pZGVkIGJ5IHBhc3NpbmcgdGhlIGBrbm93bkhlbHBlcnNgIGFuZAogICAgLy8gYGtub3duSGVscGVyc09ubHlgIGZsYWdzIGF0IGNvbXBpbGUtdGltZS4KICAgIGludm9rZUFtYmlndW91czogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5mdW5jdGlvblR5cGUgPSAnImZ1bmN0aW9uIic7CgogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ3t9Jyk7CiAgICAgIHZhciBoZWxwZXIgPSB0aGlzLnNldHVwSGVscGVyKDAsIG5hbWUpOwoKICAgICAgdmFyIGhlbHBlck5hbWUgPSB0aGlzLmxhc3RIZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2hlbHBlcnMnLCBuYW1lLCAnaGVscGVyJyk7CiAgICAgIHRoaXMucmVnaXN0ZXIoJ2ZvdW5kSGVscGVyJywgaGVscGVyTmFtZSk7CgogICAgICB2YXIgbm9uSGVscGVyID0gdGhpcy5uYW1lTG9va3VwKCdkZXB0aCcgKyB0aGlzLmxhc3RDb250ZXh0LCBuYW1lLCAnY29udGV4dCcpOwogICAgICB2YXIgbmV4dFN0YWNrID0gdGhpcy5uZXh0U3RhY2soKTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2goJ2lmIChmb3VuZEhlbHBlcikgeyAnICsgbmV4dFN0YWNrICsgJyA9IGZvdW5kSGVscGVyLmNhbGwoJyArIGhlbHBlci5jYWxsUGFyYW1zICsgJyk7IH0nKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaCgnZWxzZSB7ICcgKyBuZXh0U3RhY2sgKyAnID0gJyArIG5vbkhlbHBlciArICc7ICcgKyBuZXh0U3RhY2sgKyAnID0gdHlwZW9mICcgKyBuZXh0U3RhY2sgKyAnID09PSBmdW5jdGlvblR5cGUgPyAnICsgbmV4dFN0YWNrICsgJygpIDogJyArIG5leHRTdGFjayArICc7IH0nKTsKICAgIH0sCgogICAgLy8gW2ludm9rZVBhcnRpYWxdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogY29udGV4dCwgLi4uCiAgICAvLyBPbiBzdGFjayBhZnRlcjogcmVzdWx0IG9mIHBhcnRpYWwgaW52b2NhdGlvbgogICAgLy8KICAgIC8vIFRoaXMgb3BlcmF0aW9uIHBvcHMgb2ZmIGEgY29udGV4dCwgaW52b2tlcyBhIHBhcnRpYWwgd2l0aCB0aGF0IGNvbnRleHQsCiAgICAvLyBhbmQgcHVzaGVzIHRoZSByZXN1bHQgb2YgdGhlIGludm9jYXRpb24gYmFjay4KICAgIGludm9rZVBhcnRpYWw6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdmFyIHBhcmFtcyA9IFt0aGlzLm5hbWVMb29rdXAoJ3BhcnRpYWxzJywgbmFtZSwgJ3BhcnRpYWwnKSwgIiciICsgbmFtZSArICInIiwgdGhpcy5wb3BTdGFjaygpLCAiaGVscGVycyIsICJwYXJ0aWFscyJdOwoKICAgICAgaWYgKHRoaXMub3B0aW9ucy5kYXRhKSB7CiAgICAgICAgcGFyYW1zLnB1c2goImRhdGEiKTsKICAgICAgfQoKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKICAgICAgdGhpcy5wdXNoU3RhY2soInNlbGYuaW52b2tlUGFydGlhbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKTsiKTsKICAgIH0sCgogICAgLy8gW2Fzc2lnblRvSGFzaF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiB2YWx1ZSwgaGFzaCwgLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IGhhc2gsIC4uLgogICAgLy8KICAgIC8vIFBvcHMgYSB2YWx1ZSBhbmQgaGFzaCBvZmYgdGhlIHN0YWNrLCBhc3NpZ25zIGBoYXNoW2tleV0gPSB2YWx1ZWAKICAgIC8vIGFuZCBwdXNoZXMgdGhlIGhhc2ggYmFjayBvbnRvIHRoZSBzdGFjay4KICAgIGFzc2lnblRvSGFzaDogZnVuY3Rpb24oa2V5KSB7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgdmFyIGhhc2ggPSB0aGlzLnRvcFN0YWNrKCk7CgogICAgICB0aGlzLnNvdXJjZS5wdXNoKGhhc2ggKyAiWyciICsga2V5ICsgIiddID0gIiArIHZhbHVlICsgIjsiKTsKICAgIH0sCgogICAgLy8gSEVMUEVSUwoKICAgIGNvbXBpbGVyOiBKYXZhU2NyaXB0Q29tcGlsZXIsCgogICAgY29tcGlsZUNoaWxkcmVuOiBmdW5jdGlvbihlbnZpcm9ubWVudCwgb3B0aW9ucykgewogICAgICB2YXIgY2hpbGRyZW4gPSBlbnZpcm9ubWVudC5jaGlsZHJlbiwgY2hpbGQsIGNvbXBpbGVyOwoKICAgICAgZm9yKHZhciBpPTAsIGw9Y2hpbGRyZW4ubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgY29tcGlsZXIgPSBuZXcgdGhpcy5jb21waWxlcigpOwoKICAgICAgICB0aGlzLmNvbnRleHQucHJvZ3JhbXMucHVzaCgnJyk7ICAgICAvLyBQbGFjZWhvbGRlciB0byBwcmV2ZW50IG5hbWUgY29uZmxpY3RzIGZvciBuZXN0ZWQgY2hpbGRyZW4KICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmNvbnRleHQucHJvZ3JhbXMubGVuZ3RoOwogICAgICAgIGNoaWxkLmluZGV4ID0gaW5kZXg7CiAgICAgICAgY2hpbGQubmFtZSA9ICdwcm9ncmFtJyArIGluZGV4OwogICAgICAgIHRoaXMuY29udGV4dC5wcm9ncmFtc1tpbmRleF0gPSBjb21waWxlci5jb21waWxlKGNoaWxkLCBvcHRpb25zLCB0aGlzLmNvbnRleHQpOwogICAgICB9CiAgICB9LAoKICAgIHByb2dyYW1FeHByZXNzaW9uOiBmdW5jdGlvbihndWlkKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CgogICAgICBpZihndWlkID09IG51bGwpIHsKICAgICAgICByZXR1cm4gInNlbGYubm9vcCI7CiAgICAgIH0KCiAgICAgIHZhciBjaGlsZCA9IHRoaXMuZW52aXJvbm1lbnQuY2hpbGRyZW5bZ3VpZF0sCiAgICAgICAgICBkZXB0aHMgPSBjaGlsZC5kZXB0aHMubGlzdCwgZGVwdGg7CgogICAgICB2YXIgcHJvZ3JhbVBhcmFtcyA9IFtjaGlsZC5pbmRleCwgY2hpbGQubmFtZSwgImRhdGEiXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsID0gZGVwdGhzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBkZXB0aCA9IGRlcHRoc1tpXTsKCiAgICAgICAgaWYoZGVwdGggPT09IDEpIHsgcHJvZ3JhbVBhcmFtcy5wdXNoKCJkZXB0aDAiKTsgfQogICAgICAgIGVsc2UgeyBwcm9ncmFtUGFyYW1zLnB1c2goImRlcHRoIiArIChkZXB0aCAtIDEpKTsgfQogICAgICB9CgogICAgICBpZihkZXB0aHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuICJzZWxmLnByb2dyYW0oIiArIHByb2dyYW1QYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9ncmFtUGFyYW1zLnNoaWZ0KCk7CiAgICAgICAgcmV0dXJuICJzZWxmLnByb2dyYW1XaXRoRGVwdGgoIiArIHByb2dyYW1QYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfQogICAgfSwKCiAgICByZWdpc3RlcjogZnVuY3Rpb24obmFtZSwgdmFsKSB7CiAgICAgIHRoaXMudXNlUmVnaXN0ZXIobmFtZSk7CiAgICAgIHRoaXMuc291cmNlLnB1c2gobmFtZSArICIgPSAiICsgdmFsICsgIjsiKTsKICAgIH0sCgogICAgdXNlUmVnaXN0ZXI6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgaWYoIXRoaXMucmVnaXN0ZXJzW25hbWVdKSB7CiAgICAgICAgdGhpcy5yZWdpc3RlcnNbbmFtZV0gPSB0cnVlOwogICAgICAgIHRoaXMucmVnaXN0ZXJzLmxpc3QucHVzaChuYW1lKTsKICAgICAgfQogICAgfSwKCiAgICBwdXNoU3RhY2tMaXRlcmFsOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHRoaXMuY29tcGlsZVN0YWNrLnB1c2gobmV3IExpdGVyYWwoaXRlbSkpOwogICAgICByZXR1cm4gaXRlbTsKICAgIH0sCgogICAgcHVzaFN0YWNrOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHRoaXMuc291cmNlLnB1c2godGhpcy5pbmNyU3RhY2soKSArICIgPSAiICsgaXRlbSArICI7Iik7CiAgICAgIHRoaXMuY29tcGlsZVN0YWNrLnB1c2goInN0YWNrIiArIHRoaXMuc3RhY2tTbG90KTsKICAgICAgcmV0dXJuICJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdDsKICAgIH0sCgogICAgcmVwbGFjZVN0YWNrOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICB2YXIgaXRlbSA9IGNhbGxiYWNrLmNhbGwodGhpcywgdGhpcy50b3BTdGFjaygpKTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2godGhpcy50b3BTdGFjaygpICsgIiA9ICIgKyBpdGVtICsgIjsiKTsKICAgICAgcmV0dXJuICJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdDsKICAgIH0sCgogICAgbmV4dFN0YWNrOiBmdW5jdGlvbihza2lwQ29tcGlsZVN0YWNrKSB7CiAgICAgIHZhciBuYW1lID0gdGhpcy5pbmNyU3RhY2soKTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaCgic3RhY2siICsgdGhpcy5zdGFja1Nsb3QpOwogICAgICByZXR1cm4gbmFtZTsKICAgIH0sCgogICAgaW5jclN0YWNrOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5zdGFja1Nsb3QrKzsKICAgICAgaWYodGhpcy5zdGFja1Nsb3QgPiB0aGlzLnN0YWNrVmFycy5sZW5ndGgpIHsgdGhpcy5zdGFja1ZhcnMucHVzaCgic3RhY2siICsgdGhpcy5zdGFja1Nsb3QpOyB9CiAgICAgIHJldHVybiAic3RhY2siICsgdGhpcy5zdGFja1Nsb3Q7CiAgICB9LAoKICAgIHBvcFN0YWNrOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGl0ZW0gPSB0aGlzLmNvbXBpbGVTdGFjay5wb3AoKTsKCiAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgTGl0ZXJhbCkgewogICAgICAgIHJldHVybiBpdGVtLnZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhY2tTbG90LS07CiAgICAgICAgcmV0dXJuIGl0ZW07CiAgICAgIH0KICAgIH0sCgogICAgdG9wU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbSA9IHRoaXMuY29tcGlsZVN0YWNrW3RoaXMuY29tcGlsZVN0YWNrLmxlbmd0aCAtIDFdOwoKICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBMaXRlcmFsKSB7CiAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGl0ZW07CiAgICAgIH0KICAgIH0sCgogICAgcXVvdGVkU3RyaW5nOiBmdW5jdGlvbihzdHIpIHsKICAgICAgcmV0dXJuICciJyArIHN0cgogICAgICAgIC5yZXBsYWNlKC9cXC9nLCAnXFxcXCcpCiAgICAgICAgLnJlcGxhY2UoLyIvZywgJ1xcIicpCiAgICAgICAgLnJlcGxhY2UoL1xuL2csICdcXG4nKQogICAgICAgIC5yZXBsYWNlKC9cci9nLCAnXFxyJykgKyAnIic7CiAgICB9LAoKICAgIHNldHVwSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdmFyIHBhcmFtcyA9IFtdOwogICAgICB0aGlzLnNldHVwUGFyYW1zKHBhcmFtU2l6ZSwgcGFyYW1zKTsKICAgICAgdmFyIGZvdW5kSGVscGVyID0gdGhpcy5uYW1lTG9va3VwKCdoZWxwZXJzJywgbmFtZSwgJ2hlbHBlcicpOwoKICAgICAgcmV0dXJuIHsKICAgICAgICBwYXJhbXM6IHBhcmFtcywKICAgICAgICBuYW1lOiBmb3VuZEhlbHBlciwKICAgICAgICBjYWxsUGFyYW1zOiBbImRlcHRoMCJdLmNvbmNhdChwYXJhbXMpLmpvaW4oIiwgIiksCiAgICAgICAgaGVscGVyTWlzc2luZ1BhcmFtczogWyJkZXB0aDAiLCB0aGlzLnF1b3RlZFN0cmluZyhuYW1lKV0uY29uY2F0KHBhcmFtcykuam9pbigiLCAiKQogICAgICB9OwogICAgfSwKCiAgICAvLyB0aGUgcGFyYW1zIGFuZCBjb250ZXh0cyBhcmd1bWVudHMgYXJlIHBhc3NlZCBpbiBhcnJheXMKICAgIC8vIHRvIGZpbGwgaW4KICAgIHNldHVwUGFyYW1zOiBmdW5jdGlvbihwYXJhbVNpemUsIHBhcmFtcykgewogICAgICB2YXIgb3B0aW9ucyA9IFtdLCBjb250ZXh0cyA9IFtdLCBwYXJhbSwgaW52ZXJzZSwgcHJvZ3JhbTsKCiAgICAgIG9wdGlvbnMucHVzaCgiaGFzaDoiICsgdGhpcy5wb3BTdGFjaygpKTsKCiAgICAgIGludmVyc2UgPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgIHByb2dyYW0gPSB0aGlzLnBvcFN0YWNrKCk7CgogICAgICAvLyBBdm9pZCBzZXR0aW5nIGZuIGFuZCBpbnZlcnNlIGlmIG5laXRoZXIgYXJlIHNldC4gVGhpcyBhbGxvd3MKICAgICAgLy8gaGVscGVycyB0byBkbyBhIGNoZWNrIGZvciBgaWYgKG9wdGlvbnMuZm4pYAogICAgICBpZiAocHJvZ3JhbSB8fCBpbnZlcnNlKSB7CiAgICAgICAgaWYgKCFwcm9ncmFtKSB7CiAgICAgICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5zZWxmID0gInRoaXMiOwogICAgICAgICAgcHJvZ3JhbSA9ICJzZWxmLm5vb3AiOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpbnZlcnNlKSB7CiAgICAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CiAgICAgICAgICBpbnZlcnNlID0gInNlbGYubm9vcCI7CiAgICAgICAgfQoKICAgICAgICBvcHRpb25zLnB1c2goImludmVyc2U6IiArIGludmVyc2UpOwogICAgICAgIG9wdGlvbnMucHVzaCgiZm46IiArIHByb2dyYW0pOwogICAgICB9CgogICAgICBmb3IodmFyIGk9MDsgaTxwYXJhbVNpemU7IGkrKykgewogICAgICAgIHBhcmFtID0gdGhpcy5wb3BTdGFjaygpOwogICAgICAgIHBhcmFtcy5wdXNoKHBhcmFtKTsKCiAgICAgICAgaWYodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgICAgY29udGV4dHMucHVzaCh0aGlzLnBvcFN0YWNrKCkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRoaXMub3B0aW9ucy5zdHJpbmdQYXJhbXMpIHsKICAgICAgICBvcHRpb25zLnB1c2goImNvbnRleHRzOlsiICsgY29udGV4dHMuam9pbigiLCIpICsgIl0iKTsKICAgICAgfQoKICAgICAgaWYodGhpcy5vcHRpb25zLmRhdGEpIHsKICAgICAgICBvcHRpb25zLnB1c2goImRhdGE6ZGF0YSIpOwogICAgICB9CgogICAgICBwYXJhbXMucHVzaCgieyIgKyBvcHRpb25zLmpvaW4oIiwiKSArICJ9Iik7CiAgICAgIHJldHVybiBwYXJhbXMuam9pbigiLCAiKTsKICAgIH0KICB9OwoKICB2YXIgcmVzZXJ2ZWRXb3JkcyA9ICgKICAgICJicmVhayBlbHNlIG5ldyB2YXIiICsKICAgICIgY2FzZSBmaW5hbGx5IHJldHVybiB2b2lkIiArCiAgICAiIGNhdGNoIGZvciBzd2l0Y2ggd2hpbGUiICsKICAgICIgY29udGludWUgZnVuY3Rpb24gdGhpcyB3aXRoIiArCiAgICAiIGRlZmF1bHQgaWYgdGhyb3ciICsKICAgICIgZGVsZXRlIGluIHRyeSIgKwogICAgIiBkbyBpbnN0YW5jZW9mIHR5cGVvZiIgKwogICAgIiBhYnN0cmFjdCBlbnVtIGludCBzaG9ydCIgKwogICAgIiBib29sZWFuIGV4cG9ydCBpbnRlcmZhY2Ugc3RhdGljIiArCiAgICAiIGJ5dGUgZXh0ZW5kcyBsb25nIHN1cGVyIiArCiAgICAiIGNoYXIgZmluYWwgbmF0aXZlIHN5bmNocm9uaXplZCIgKwogICAgIiBjbGFzcyBmbG9hdCBwYWNrYWdlIHRocm93cyIgKwogICAgIiBjb25zdCBnb3RvIHByaXZhdGUgdHJhbnNpZW50IiArCiAgICAiIGRlYnVnZ2VyIGltcGxlbWVudHMgcHJvdGVjdGVkIHZvbGF0aWxlIiArCiAgICAiIGRvdWJsZSBpbXBvcnQgcHVibGljIGxldCB5aWVsZCIKICApLnNwbGl0KCIgIik7CgogIHZhciBjb21waWxlcldvcmRzID0gSmF2YVNjcmlwdENvbXBpbGVyLlJFU0VSVkVEX1dPUkRTID0ge307CgogIGZvcih2YXIgaT0wLCBsPXJlc2VydmVkV29yZHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgY29tcGlsZXJXb3Jkc1tyZXNlcnZlZFdvcmRzW2ldXSA9IHRydWU7CiAgfQoKICBKYXZhU2NyaXB0Q29tcGlsZXIuaXNWYWxpZEphdmFTY3JpcHRWYXJpYWJsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICBpZighSmF2YVNjcmlwdENvbXBpbGVyLlJFU0VSVkVEX1dPUkRTW25hbWVdICYmIC9eW2EtekEtWl8kXVswLTlhLXpBLVpfJF0rJC8udGVzdChuYW1lKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9OwoKfSkoSGFuZGxlYmFycy5Db21waWxlciwgSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIpOwoKSGFuZGxlYmFycy5wcmVjb21waWxlID0gZnVuY3Rpb24oc3RyaW5nLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgaWYgKCEoJ2RhdGEnIGluIG9wdGlvbnMpKSB7CiAgICBvcHRpb25zLmRhdGEgPSB0cnVlOwogIH0KICB2YXIgYXN0ID0gSGFuZGxlYmFycy5wYXJzZShzdHJpbmcpOwogIHZhciBlbnZpcm9ubWVudCA9IG5ldyBIYW5kbGViYXJzLkNvbXBpbGVyKCkuY29tcGlsZShhc3QsIG9wdGlvbnMpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIoKS5jb21waWxlKGVudmlyb25tZW50LCBvcHRpb25zKTsKfTsKCkhhbmRsZWJhcnMuY29tcGlsZSA9IGZ1bmN0aW9uKHN0cmluZywgb3B0aW9ucykgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIGlmICghKCdkYXRhJyBpbiBvcHRpb25zKSkgewogICAgb3B0aW9ucy5kYXRhID0gdHJ1ZTsKICB9CiAgdmFyIGNvbXBpbGVkOwogIGZ1bmN0aW9uIGNvbXBpbGUoKSB7CiAgICB2YXIgYXN0ID0gSGFuZGxlYmFycy5wYXJzZShzdHJpbmcpOwogICAgdmFyIGVudmlyb25tZW50ID0gbmV3IEhhbmRsZWJhcnMuQ29tcGlsZXIoKS5jb21waWxlKGFzdCwgb3B0aW9ucyk7CiAgICB2YXIgdGVtcGxhdGVTcGVjID0gbmV3IEhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyKCkuY29tcGlsZShlbnZpcm9ubWVudCwgb3B0aW9ucywgdW5kZWZpbmVkLCB0cnVlKTsKICAgIHJldHVybiBIYW5kbGViYXJzLnRlbXBsYXRlKHRlbXBsYXRlU3BlYyk7CiAgfQoKICAvLyBUZW1wbGF0ZSBpcyBvbmx5IGNvbXBpbGVkIG9uIGZpcnN0IHVzZSBhbmQgY2FjaGVkIGFmdGVyIHRoYXQgcG9pbnQuCiAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgIGlmICghY29tcGlsZWQpIHsKICAgICAgY29tcGlsZWQgPSBjb21waWxlKCk7CiAgICB9CiAgICByZXR1cm4gY29tcGlsZWQuY2FsbCh0aGlzLCBjb250ZXh0LCBvcHRpb25zKTsKICB9Owp9Owo7Ci8vIGxpYi9oYW5kbGViYXJzL3J1bnRpbWUuanMKSGFuZGxlYmFycy5WTSA9IHsKICB0ZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGVTcGVjKSB7CiAgICAvLyBKdXN0IGFkZCB3YXRlcgogICAgdmFyIGNvbnRhaW5lciA9IHsKICAgICAgZXNjYXBlRXhwcmVzc2lvbjogSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uLAogICAgICBpbnZva2VQYXJ0aWFsOiBIYW5kbGViYXJzLlZNLmludm9rZVBhcnRpYWwsCiAgICAgIHByb2dyYW1zOiBbXSwKICAgICAgcHJvZ3JhbTogZnVuY3Rpb24oaSwgZm4sIGRhdGEpIHsKICAgICAgICB2YXIgcHJvZ3JhbVdyYXBwZXIgPSB0aGlzLnByb2dyYW1zW2ldOwogICAgICAgIGlmKGRhdGEpIHsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gSGFuZGxlYmFycy5WTS5wcm9ncmFtKGZuLCBkYXRhKTsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyLnByb2dyYW0gPSBpOwogICAgICAgIH0gZWxzZSBpZiAoIXByb2dyYW1XcmFwcGVyKSB7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV0gPSBIYW5kbGViYXJzLlZNLnByb2dyYW0oZm4pOwogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIucHJvZ3JhbSA9IGk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9ncmFtV3JhcHBlcjsKICAgICAgfSwKICAgICAgcHJvZ3JhbVdpdGhEZXB0aDogSGFuZGxlYmFycy5WTS5wcm9ncmFtV2l0aERlcHRoLAogICAgICBub29wOiBIYW5kbGViYXJzLlZNLm5vb3AKICAgIH07CgogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHJldHVybiB0ZW1wbGF0ZVNwZWMuY2FsbChjb250YWluZXIsIEhhbmRsZWJhcnMsIGNvbnRleHQsIG9wdGlvbnMuaGVscGVycywgb3B0aW9ucy5wYXJ0aWFscywgb3B0aW9ucy5kYXRhKTsKICAgIH07CiAgfSwKCiAgcHJvZ3JhbVdpdGhEZXB0aDogZnVuY3Rpb24oZm4sIGRhdGEsICRkZXB0aCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoKICAgIHJldHVybiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIFtjb250ZXh0LCBvcHRpb25zLmRhdGEgfHwgZGF0YV0uY29uY2F0KGFyZ3MpKTsKICAgIH07CiAgfSwKICBwcm9ncmFtOiBmdW5jdGlvbihmbiwgZGF0YSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4oY29udGV4dCwgb3B0aW9ucy5kYXRhIHx8IGRhdGEpOwogICAgfTsKICB9LAogIG5vb3A6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIiI7IH0sCiAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24ocGFydGlhbCwgbmFtZSwgY29udGV4dCwgaGVscGVycywgcGFydGlhbHMsIGRhdGEpIHsKICAgIHZhciBvcHRpb25zID0geyBoZWxwZXJzOiBoZWxwZXJzLCBwYXJ0aWFsczogcGFydGlhbHMsIGRhdGE6IGRhdGEgfTsKCiAgICBpZihwYXJ0aWFsID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhyb3cgbmV3IEhhbmRsZWJhcnMuRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGZvdW5kIik7CiAgICB9IGVsc2UgaWYocGFydGlhbCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7CiAgICAgIHJldHVybiBwYXJ0aWFsKGNvbnRleHQsIG9wdGlvbnMpOwogICAgfSBlbHNlIGlmICghSGFuZGxlYmFycy5jb21waWxlKSB7CiAgICAgIHRocm93IG5ldyBIYW5kbGViYXJzLkV4Y2VwdGlvbigiVGhlIHBhcnRpYWwgIiArIG5hbWUgKyAiIGNvdWxkIG5vdCBiZSBjb21waWxlZCB3aGVuIHJ1bm5pbmcgaW4gcnVudGltZS1vbmx5IG1vZGUiKTsKICAgIH0gZWxzZSB7CiAgICAgIHBhcnRpYWxzW25hbWVdID0gSGFuZGxlYmFycy5jb21waWxlKHBhcnRpYWwsIHtkYXRhOiBkYXRhICE9PSB1bmRlZmluZWR9KTsKICAgICAgcmV0dXJuIHBhcnRpYWxzW25hbWVdKGNvbnRleHQsIG9wdGlvbnMpOwogICAgfQogIH0KfTsKCkhhbmRsZWJhcnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLnRlbXBsYXRlOwo7CgovLyAgICAgVW5kZXJzY29yZS5qcyAxLjQuMgovLyAgICAgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcKLy8gICAgIChjKSAyMDA5LTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIFVuZGVyc2NvcmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgooZnVuY3Rpb24oKSB7CgogIC8vIEJhc2VsaW5lIHNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gRXN0YWJsaXNoIHRoZSByb290IG9iamVjdCwgYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIG9yIGBnbG9iYWxgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgogIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgogIC8vIEVzdGFibGlzaCB0aGUgb2JqZWN0IHRoYXQgZ2V0cyByZXR1cm5lZCB0byBicmVhayBvdXQgb2YgYSBsb29wIGl0ZXJhdGlvbi4KICB2YXIgYnJlYWtlciA9IHt9OwoKICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLCBPYmpQcm90byA9IE9iamVjdC5wcm90b3R5cGUsIEZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKCiAgLy8gQ3JlYXRlIHF1aWNrIHJlZmVyZW5jZSB2YXJpYWJsZXMgZm9yIHNwZWVkIGFjY2VzcyB0byBjb3JlIHByb3RvdHlwZXMuCiAgdmFyIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCiAgICAgIHNsaWNlICAgICAgICAgICAgPSBBcnJheVByb3RvLnNsaWNlLAogICAgICBjb25jYXQgICAgICAgICAgID0gQXJyYXlQcm90by5jb25jYXQsCiAgICAgIHVuc2hpZnQgICAgICAgICAgPSBBcnJheVByb3RvLnVuc2hpZnQsCiAgICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKICAgICAgaGFzT3duUHJvcGVydHkgICA9IE9ialByb3RvLmhhc093blByb3BlcnR5OwoKICAvLyBBbGwgKipFQ01BU2NyaXB0IDUqKiBuYXRpdmUgZnVuY3Rpb24gaW1wbGVtZW50YXRpb25zIHRoYXQgd2UgaG9wZSB0byB1c2UKICAvLyBhcmUgZGVjbGFyZWQgaGVyZS4KICB2YXIKICAgIG5hdGl2ZUZvckVhY2ggICAgICA9IEFycmF5UHJvdG8uZm9yRWFjaCwKICAgIG5hdGl2ZU1hcCAgICAgICAgICA9IEFycmF5UHJvdG8ubWFwLAogICAgbmF0aXZlUmVkdWNlICAgICAgID0gQXJyYXlQcm90by5yZWR1Y2UsCiAgICBuYXRpdmVSZWR1Y2VSaWdodCAgPSBBcnJheVByb3RvLnJlZHVjZVJpZ2h0LAogICAgbmF0aXZlRmlsdGVyICAgICAgID0gQXJyYXlQcm90by5maWx0ZXIsCiAgICBuYXRpdmVFdmVyeSAgICAgICAgPSBBcnJheVByb3RvLmV2ZXJ5LAogICAgbmF0aXZlU29tZSAgICAgICAgID0gQXJyYXlQcm90by5zb21lLAogICAgbmF0aXZlSW5kZXhPZiAgICAgID0gQXJyYXlQcm90by5pbmRleE9mLAogICAgbmF0aXZlTGFzdEluZGV4T2YgID0gQXJyYXlQcm90by5sYXN0SW5kZXhPZiwKICAgIG5hdGl2ZUlzQXJyYXkgICAgICA9IEFycmF5LmlzQXJyYXksCiAgICBuYXRpdmVLZXlzICAgICAgICAgPSBPYmplY3Qua2V5cywKICAgIG5hdGl2ZUJpbmQgICAgICAgICA9IEZ1bmNQcm90by5iaW5kOwoKICAvLyBDcmVhdGUgYSBzYWZlIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yIHVzZSBiZWxvdy4KICB2YXIgXyA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIF8pIHJldHVybiBvYmo7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpIHJldHVybiBuZXcgXyhvYmopOwogICAgdGhpcy5fd3JhcHBlZCA9IG9iajsKICB9OwoKICAvLyBFeHBvcnQgdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciAqKk5vZGUuanMqKiwgd2l0aAogIC8vIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IGZvciB0aGUgb2xkIGByZXF1aXJlKClgIEFQSS4gSWYgd2UncmUgaW4KICAvLyB0aGUgYnJvd3NlciwgYWRkIGBfYCBhcyBhIGdsb2JhbCBvYmplY3QgdmlhIGEgc3RyaW5nIGlkZW50aWZpZXIsCiAgLy8gZm9yIENsb3N1cmUgQ29tcGlsZXIgImFkdmFuY2VkIiBtb2RlLgogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBfOwogICAgfQogICAgZXhwb3J0cy5fID0gXzsKICB9IGVsc2UgewogICAgcm9vdFsnXyddID0gXzsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbi4KICBfLlZFUlNJT04gPSAnMS40LjInOwoKICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFRoZSBjb3JuZXJzdG9uZSwgYW4gYGVhY2hgIGltcGxlbWVudGF0aW9uLCBha2EgYGZvckVhY2hgLgogIC8vIEhhbmRsZXMgb2JqZWN0cyB3aXRoIHRoZSBidWlsdC1pbiBgZm9yRWFjaGAsIGFycmF5cywgYW5kIHJhdyBvYmplY3RzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmb3JFYWNoYCBpZiBhdmFpbGFibGUuCiAgdmFyIGVhY2ggPSBfLmVhY2ggPSBfLmZvckVhY2ggPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybjsKICAgIGlmIChuYXRpdmVGb3JFYWNoICYmIG9iai5mb3JFYWNoID09PSBuYXRpdmVGb3JFYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvYmoubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICBpZiAoXy5oYXMob2JqLCBrZXkpKSB7CiAgICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSByZXN1bHRzIG9mIGFwcGx5aW5nIHRoZSBpdGVyYXRvciB0byBlYWNoIGVsZW1lbnQuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYG1hcGAgaWYgYXZhaWxhYmxlLgogIF8ubWFwID0gXy5jb2xsZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlTWFwICYmIG9iai5tYXAgPT09IG5hdGl2ZU1hcCkgcmV0dXJuIG9iai5tYXAoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXN1bHRzW3Jlc3VsdHMubGVuZ3RoXSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gKipSZWR1Y2UqKiBidWlsZHMgdXAgYSBzaW5nbGUgcmVzdWx0IGZyb20gYSBsaXN0IG9mIHZhbHVlcywgYWthIGBpbmplY3RgLAogIC8vIG9yIGBmb2xkbGAuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZSA9IF8uZm9sZGwgPSBfLmluamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZSAmJiBvYmoucmVkdWNlID09PSBuYXRpdmVSZWR1Y2UpIHsKICAgICAgaWYgKGNvbnRleHQpIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlKGl0ZXJhdG9yLCBtZW1vKSA6IG9iai5yZWR1Y2UoaXRlcmF0b3IpOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gdmFsdWU7CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpIHRocm93IG5ldyBUeXBlRXJyb3IoJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnKTsKICAgIHJldHVybiBtZW1vOwogIH07CgogIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VSaWdodGAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlUmlnaHQgPSBfLmZvbGRyID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlUmlnaHQgJiYgb2JqLnJlZHVjZVJpZ2h0ID09PSBuYXRpdmVSZWR1Y2VSaWdodCkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yKTsKICAgIH0KICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgaWYgKGxlbmd0aCAhPT0gK2xlbmd0aCkgewogICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgICBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaW5kZXggPSBrZXlzID8ga2V5c1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IG9ialtpbmRleF07CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgb2JqW2luZGV4XSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcignUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZScpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBmaXJzdCB2YWx1ZSB3aGljaCBwYXNzZXMgYSB0cnV0aCB0ZXN0LiBBbGlhc2VkIGFzIGBkZXRlY3RgLgogIF8uZmluZCA9IF8uZGV0ZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdDsKICAgIGFueShvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyB0aGF0IHBhc3MgYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmaWx0ZXJgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBzZWxlY3RgLgogIF8uZmlsdGVyID0gXy5zZWxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVGaWx0ZXIgJiYgb2JqLmZpbHRlciA9PT0gbmF0aXZlRmlsdGVyKSByZXR1cm4gb2JqLmZpbHRlcihpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGZvciB3aGljaCBhIHRydXRoIHRlc3QgZmFpbHMuCiAgXy5yZWplY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCFpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIERldGVybWluZSB3aGV0aGVyIGFsbCBvZiB0aGUgZWxlbWVudHMgbWF0Y2ggYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBldmVyeWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFsbGAuCiAgXy5ldmVyeSA9IF8uYWxsID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChuYXRpdmVFdmVyeSAmJiBvYmouZXZlcnkgPT09IG5hdGl2ZUV2ZXJ5KSByZXR1cm4gb2JqLmV2ZXJ5KGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCEocmVzdWx0ID0gcmVzdWx0ICYmIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIGF0IGxlYXN0IG9uZSBlbGVtZW50IGluIHRoZSBvYmplY3QgbWF0Y2hlcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHNvbWVgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBhbnlgLgogIHZhciBhbnkgPSBfLnNvbWUgPSBfLmFueSA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yIHx8IChpdGVyYXRvciA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZVNvbWUgJiYgb2JqLnNvbWUgPT09IG5hdGl2ZVNvbWUpIHJldHVybiBvYmouc29tZShpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChyZXN1bHQgfHwgKHJlc3VsdCA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgogIC8vIEFsaWFzZWQgYXMgYGluY2x1ZGVgLgogIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbihvYmosIHRhcmdldCkgewogICAgdmFyIGZvdW5kID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiBmb3VuZDsKICAgIGlmIChuYXRpdmVJbmRleE9mICYmIG9iai5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKSByZXR1cm4gb2JqLmluZGV4T2YodGFyZ2V0KSAhPSAtMTsKICAgIGZvdW5kID0gYW55KG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0YXJnZXQ7CiAgICB9KTsKICAgIHJldHVybiBmb3VuZDsKICB9OwoKICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KICBfLmludm9rZSA9IGZ1bmN0aW9uKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiAoXy5pc0Z1bmN0aW9uKG1ldGhvZCkgPyBtZXRob2QgOiB2YWx1ZVttZXRob2RdKS5hcHBseSh2YWx1ZSwgYXJncyk7CiAgICB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgogIF8ucGx1Y2sgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gdmFsdWVba2V5XTsgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIHdpdGggc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gW107CiAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gdmFsdWVba2V5XSkgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSk7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgb3IgKGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIC8vIENhbid0IG9wdGltaXplIGFycmF5cyBvZiBpbnRlZ2VycyBsb25nZXIgdGhhbiA2NSw1MzUgZWxlbWVudHMuCiAgLy8gU2VlOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODA3OTcKICBfLm1heCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiAtSW5maW5pdHk7CiAgICB2YXIgcmVzdWx0ID0ge2NvbXB1dGVkIDogLUluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPj0gcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiBJbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiBJbmZpbml0eX07CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGNvbXB1dGVkIDwgcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFNodWZmbGUgYW4gYXJyYXkuCiAgXy5zaHVmZmxlID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcmFuZDsKICAgIHZhciBpbmRleCA9IDA7CiAgICB2YXIgc2h1ZmZsZWQgPSBbXTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByYW5kID0gXy5yYW5kb20oaW5kZXgrKyk7CiAgICAgIHNodWZmbGVkW2luZGV4IC0gMV0gPSBzaHVmZmxlZFtyYW5kXTsKICAgICAgc2h1ZmZsZWRbcmFuZF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHNodWZmbGVkOwogIH07CgogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIGxvb2t1cCBpdGVyYXRvcnMuCiAgdmFyIGxvb2t1cEl0ZXJhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihvYmopeyByZXR1cm4gb2JqW3ZhbHVlXTsgfTsKICB9OwoKICAvLyBTb3J0IHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24gcHJvZHVjZWQgYnkgYW4gaXRlcmF0b3IuCiAgXy5zb3J0QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSk7CiAgICByZXR1cm4gXy5wbHVjayhfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlIDogdmFsdWUsCiAgICAgICAgaW5kZXggOiBpbmRleCwKICAgICAgICBjcml0ZXJpYSA6IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KQogICAgICB9OwogICAgfSkuc29ydChmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWE7CiAgICAgIHZhciBiID0gcmlnaHQuY3JpdGVyaWE7CiAgICAgIGlmIChhICE9PSBiKSB7CiAgICAgICAgaWYgKGEgPiBiIHx8IGEgPT09IHZvaWQgMCkgcmV0dXJuIDE7CiAgICAgICAgaWYgKGEgPCBiIHx8IGIgPT09IHZvaWQgMCkgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHJldHVybiBsZWZ0LmluZGV4IDwgcmlnaHQuaW5kZXggPyAtMSA6IDE7CiAgICB9KSwgJ3ZhbHVlJyk7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdXNlZCBmb3IgYWdncmVnYXRlICJncm91cCBieSIgb3BlcmF0aW9ucy4KICB2YXIgZ3JvdXAgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0LCBiZWhhdmlvcikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgdmFyIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IodmFsdWUpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICB2YXIga2V5ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIG9iaik7CiAgICAgIGJlaGF2aW9yKHJlc3VsdCwga2V5LCB2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHJldHVybiBncm91cChvYmosIHZhbHVlLCBjb250ZXh0LCBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgICAgKF8uaGFzKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldIDogKHJlc3VsdFtrZXldID0gW10pKS5wdXNoKHZhbHVlKTsKICAgIH0pOwogIH07CgogIC8vIENvdW50cyBpbnN0YW5jZXMgb2YgYW4gb2JqZWN0IHRoYXQgZ3JvdXAgYnkgYSBjZXJ0YWluIGNyaXRlcmlvbi4gUGFzcwogIC8vIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUgdG8gY291bnQgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQogIC8vIGNyaXRlcmlvbi4KICBfLmNvdW50QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gZ3JvdXAob2JqLCB2YWx1ZSwgY29udGV4dCwgZnVuY3Rpb24ocmVzdWx0LCBrZXksIHZhbHVlKSB7CiAgICAgIGlmICghXy5oYXMocmVzdWx0LCBrZXkpKSByZXN1bHRba2V5XSA9IDA7CiAgICAgIHJlc3VsdFtrZXldKys7CiAgICB9KTsKICB9OwoKICAvLyBVc2UgYSBjb21wYXJhdG9yIGZ1bmN0aW9uIHRvIGZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoCiAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgogIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbihhcnJheSwgb2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgPSBpdGVyYXRvciA9PSBudWxsID8gXy5pZGVudGl0eSA6IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgIHZhciB2YWx1ZSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqKTsKICAgIHZhciBsb3cgPSAwLCBoaWdoID0gYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBhcnJheVttaWRdKSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CgogIC8vIFNhZmVseSBjb252ZXJ0IGFueXRoaW5nIGl0ZXJhYmxlIGludG8gYSByZWFsLCBsaXZlIGFycmF5LgogIF8udG9BcnJheSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFvYmopIHJldHVybiBbXTsKICAgIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgcmV0dXJuIHNsaWNlLmNhbGwob2JqKTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CgogIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KICBfLnNpemUgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpID8gb2JqLmxlbmd0aCA6IF8ua2V5cyhvYmopLmxlbmd0aDsKICB9OwoKICAvLyBBcnJheSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawogIC8vIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gKG4gIT0gbnVsbCkgJiYgIWd1YXJkID8gc2xpY2UuY2FsbChhcnJheSwgMCwgbikgOiBhcnJheVswXTsKICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBsYXN0IGVudHJ5IG9mIHRoZSBhcnJheS4gRXNwZWNpYWxseSB1c2VmdWwgb24KICAvLyB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiBhbGwgdGhlIHZhbHVlcyBpbgogIC8vIHRoZSBhcnJheSwgZXhjbHVkaW5nIHRoZSBsYXN0IE4uIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aAogIC8vIGBfLm1hcGAuCiAgXy5pbml0aWFsID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgYXJyYXkubGVuZ3RoIC0gKChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pKTsKICB9OwoKICAvLyBHZXQgdGhlIGxhc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgbGFzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5sYXN0ID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoKG4gIT0gbnVsbCkgJiYgIWd1YXJkKSB7CiAgICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgogIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCiAgLy8gdGhlIHJlc3QgTiB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqCiAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pOwogIH07CgogIC8vIFRyaW0gb3V0IGFsbCBmYWxzeSB2YWx1ZXMgZnJvbSBhbiBhcnJheS4KICBfLmNvbXBhY3QgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhIXZhbHVlOyB9KTsKICB9OwoKICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbihpbnB1dCwgc2hhbGxvdywgb3V0cHV0KSB7CiAgICBlYWNoKGlucHV0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHNoYWxsb3cgPyBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpIDogZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgb3V0cHV0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwoKICAvLyBSZXR1cm4gYSBjb21wbGV0ZWx5IGZsYXR0ZW5lZCB2ZXJzaW9uIG9mIGFuIGFycmF5LgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CiAgICByZXR1cm4gZmxhdHRlbihhcnJheSwgc2hhbGxvdywgW10pOwogIH07CgogIC8vIFJldHVybiBhIHZlcnNpb24gb2YgdGhlIGFycmF5IHRoYXQgZG9lcyBub3QgY29udGFpbiB0aGUgc3BlY2lmaWVkIHZhbHVlKHMpLgogIF8ud2l0aG91dCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5kaWZmZXJlbmNlKGFycmF5LCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogIH07CgogIC8vIFByb2R1Y2UgYSBkdXBsaWNhdGUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBhcnJheS4gSWYgdGhlIGFycmF5IGhhcyBhbHJlYWR5CiAgLy8gYmVlbiBzb3J0ZWQsIHlvdSBoYXZlIHRoZSBvcHRpb24gb2YgdXNpbmcgYSBmYXN0ZXIgYWxnb3JpdGhtLgogIC8vIEFsaWFzZWQgYXMgYHVuaXF1ZWAuCiAgXy51bmlxID0gXy51bmlxdWUgPSBmdW5jdGlvbihhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGl0ZXJhdG9yID8gXy5tYXAoYXJyYXksIGl0ZXJhdG9yLCBjb250ZXh0KSA6IGFycmF5OwogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBzZWVuID0gW107CiAgICBlYWNoKGluaXRpYWwsIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICBpZiAoaXNTb3J0ZWQgPyAoIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gdmFsdWUpIDogIV8uY29udGFpbnMoc2VlbiwgdmFsdWUpKSB7CiAgICAgICAgc2Vlbi5wdXNoKHZhbHVlKTsKICAgICAgICByZXN1bHRzLnB1c2goYXJyYXlbaW5kZXhdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KICBfLnVuaW9uID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy51bmlxKGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBhcmd1bWVudHMpKTsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBfLmZpbHRlcihfLnVuaXEoYXJyYXkpLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBfLmV2ZXJ5KHJlc3QsIGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIF8uaW5kZXhPZihvdGhlciwgaXRlbSkgPj0gMDsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvLyBUYWtlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gb25lIGFycmF5IGFuZCBhIG51bWJlciBvZiBvdGhlciBhcnJheXMuCiAgLy8gT25seSB0aGUgZWxlbWVudHMgcHJlc2VudCBpbiBqdXN0IHRoZSBmaXJzdCBhcnJheSB3aWxsIHJlbWFpbi4KICBfLmRpZmZlcmVuY2UgPSBmdW5jdGlvbihhcnJheSkgewogICAgdmFyIHJlc3QgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gIV8uY29udGFpbnMocmVzdCwgdmFsdWUpOyB9KTsKICB9OwoKICAvLyBaaXAgdG9nZXRoZXIgbXVsdGlwbGUgbGlzdHMgaW50byBhIHNpbmdsZSBhcnJheSAtLSBlbGVtZW50cyB0aGF0IHNoYXJlCiAgLy8gYW4gaW5kZXggZ28gdG9nZXRoZXIuCiAgXy56aXAgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdmFyIGxlbmd0aCA9IF8ubWF4KF8ucGx1Y2soYXJncywgJ2xlbmd0aCcpKTsKICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3MsICIiICsgaSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBDb252ZXJ0cyBsaXN0cyBpbnRvIG9iamVjdHMuIFBhc3MgZWl0aGVyIGEgc2luZ2xlIGFycmF5IG9mIGBba2V5LCB2YWx1ZV1gCiAgLy8gcGFpcnMsIG9yIHR3byBwYXJhbGxlbCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoIC0tIG9uZSBvZiBrZXlzLCBhbmQgb25lIG9mCiAgLy8gdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogIF8ub2JqZWN0ID0gZnVuY3Rpb24obGlzdCwgdmFsdWVzKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGxpc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBJZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBseSB1cyB3aXRoIGluZGV4T2YgKEknbSBsb29raW5nIGF0IHlvdSwgKipNU0lFKiopLAogIC8vIHdlIG5lZWQgdGhpcyBmdW5jdGlvbi4gUmV0dXJuIHRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhbgogIC8vIGl0ZW0gaW4gYW4gYXJyYXksIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChpc1NvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CiAgICAgICAgaSA9IChpc1NvcnRlZCA8IDAgPyBNYXRoLm1heCgwLCBsICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKICAgICAgICByZXR1cm4gYXJyYXlbaV0gPT09IGl0ZW0gPyBpIDogLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChuYXRpdmVJbmRleE9mICYmIGFycmF5LmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0sIGlzU29ydGVkKTsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBsYXN0SW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgZnJvbSkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBoYXNJbmRleCA9IGZyb20gIT0gbnVsbDsKICAgIGlmIChuYXRpdmVMYXN0SW5kZXhPZiAmJiBhcnJheS5sYXN0SW5kZXhPZiA9PT0gbmF0aXZlTGFzdEluZGV4T2YpIHsKICAgICAgcmV0dXJuIGhhc0luZGV4ID8gYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgZnJvbSkgOiBhcnJheS5sYXN0SW5kZXhPZihpdGVtKTsKICAgIH0KICAgIHZhciBpID0gKGhhc0luZGV4ID8gZnJvbSA6IGFycmF5Lmxlbmd0aCk7CiAgICB3aGlsZSAoaS0tKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKICAvLyB0aGUgbmF0aXZlIFB5dGhvbiBgcmFuZ2UoKWAgZnVuY3Rpb24uIFNlZQogIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCiAgXy5yYW5nZSA9IGZ1bmN0aW9uKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICBzdGVwID0gYXJndW1lbnRzWzJdIHx8IDE7CgogICAgdmFyIGxlbiA9IE1hdGgubWF4KE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApLCAwKTsKICAgIHZhciBpZHggPSAwOwogICAgdmFyIHJhbmdlID0gbmV3IEFycmF5KGxlbik7CgogICAgd2hpbGUoaWR4IDwgbGVuKSB7CiAgICAgIHJhbmdlW2lkeCsrXSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQoKICAgIHJldHVybiByYW5nZTsKICB9OwoKICAvLyBGdW5jdGlvbiAoYWhlbSkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldXNhYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciBwcm90b3R5cGUgc2V0dGluZy4KICB2YXIgY3RvciA9IGZ1bmN0aW9uKCl7fTsKCiAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCiAgLy8gb3B0aW9uYWxseSkuIEJpbmRpbmcgd2l0aCBhcmd1bWVudHMgaXMgYWxzbyBrbm93biBhcyBgY3VycnlgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZiBhdmFpbGFibGUuCiAgLy8gV2UgY2hlY2sgZm9yIGBmdW5jLmJpbmRgIGZpcnN0LCB0byBmYWlsIGZhc3Qgd2hlbiBgZnVuY2AgaXMgdW5kZWZpbmVkLgogIF8uYmluZCA9IGZ1bmN0aW9uIGJpbmQoZnVuYywgY29udGV4dCkgewogICAgdmFyIGJvdW5kLCBhcmdzOwogICAgaWYgKGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCAmJiBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgaWYgKCFfLmlzRnVuY3Rpb24oZnVuYykpIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkpIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBjdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICB2YXIgc2VsZiA9IG5ldyBjdG9yOwogICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgaWYgKE9iamVjdChyZXN1bHQpID09PSByZXN1bHQpIHJldHVybiByZXN1bHQ7CiAgICAgIHJldHVybiBzZWxmOwogICAgfTsKICB9OwoKICAvLyBCaW5kIGFsbCBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBVc2VmdWwgZm9yIGVuc3VyaW5nIHRoYXQKICAvLyBhbGwgY2FsbGJhY2tzIGRlZmluZWQgb24gYW4gb2JqZWN0IGJlbG9uZyB0byBpdC4KICBfLmJpbmRBbGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBmdW5jcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIGlmIChmdW5jcy5sZW5ndGggPT0gMCkgZnVuY3MgPSBfLmZ1bmN0aW9ucyhvYmopOwogICAgZWFjaChmdW5jcywgZnVuY3Rpb24oZikgeyBvYmpbZl0gPSBfLmJpbmQob2JqW2ZdLCBvYmopOyB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gTWVtb2l6ZSBhbiBleHBlbnNpdmUgZnVuY3Rpb24gYnkgc3RvcmluZyBpdHMgcmVzdWx0cy4KICBfLm1lbW9pemUgPSBmdW5jdGlvbihmdW5jLCBoYXNoZXIpIHsKICAgIHZhciBtZW1vID0ge307CiAgICBoYXNoZXIgfHwgKGhhc2hlciA9IF8uaWRlbnRpdHkpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIga2V5ID0gaGFzaGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBfLmhhcyhtZW1vLCBrZXkpID8gbWVtb1trZXldIDogKG1lbW9ba2V5XSA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9OwogIH07CgogIC8vIERlbGF5cyBhIGZ1bmN0aW9uIGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kIHRoZW4gY2FsbHMKICAvLyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgc3VwcGxpZWQuCiAgXy5kZWxheSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgcmV0dXJuIGZ1bmMuYXBwbHkobnVsbCwgYXJncyk7IH0sIHdhaXQpOwogIH07CgogIC8vIERlZmVycyBhIGZ1bmN0aW9uLCBzY2hlZHVsaW5nIGl0IHRvIHJ1biBhZnRlciB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcwogIC8vIGNsZWFyZWQuCiAgXy5kZWZlciA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHJldHVybiBfLmRlbGF5LmFwcGx5KF8sIFtmdW5jLCAxXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCB3aGVuIGludm9rZWQsIHdpbGwgb25seSBiZSB0cmlnZ2VyZWQgYXQgbW9zdCBvbmNlCiAgLy8gZHVyaW5nIGEgZ2l2ZW4gd2luZG93IG9mIHRpbWUuCiAgXy50aHJvdHRsZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBjb250ZXh0LCBhcmdzLCB0aW1lb3V0LCB0aHJvdHRsaW5nLCBtb3JlLCByZXN1bHQ7CiAgICB2YXIgd2hlbkRvbmUgPSBfLmRlYm91bmNlKGZ1bmN0aW9uKCl7IG1vcmUgPSB0aHJvdHRsaW5nID0gZmFsc2U7IH0sIHdhaXQpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBjb250ZXh0ID0gdGhpczsgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgaWYgKG1vcmUpIHsKICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfQogICAgICAgIHdoZW5Eb25lKCk7CiAgICAgIH07CiAgICAgIGlmICghdGltZW91dCkgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICBpZiAodGhyb3R0bGluZykgewogICAgICAgIG1vcmUgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm90dGxpbmcgPSB0cnVlOwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH0KICAgICAgd2hlbkRvbmUoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAogIC8vIGJlIHRyaWdnZXJlZC4gVGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGl0IHN0b3BzIGJlaW5nIGNhbGxlZCBmb3IKICAvLyBOIG1pbGxpc2Vjb25kcy4gSWYgYGltbWVkaWF0ZWAgaXMgcGFzc2VkLCB0cmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUKICAvLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLgogIF8uZGVib3VuY2UgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciB0aW1lb3V0LCByZXN1bHQ7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjb250ZXh0ID0gdGhpcywgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgaWYgKCFpbW1lZGlhdGUpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH07CiAgICAgIHZhciBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgaWYgKGNhbGxOb3cpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZXhlY3V0ZWQgYXQgbW9zdCBvbmUgdGltZSwgbm8gbWF0dGVyIGhvdwogIC8vIG9mdGVuIHlvdSBjYWxsIGl0LiBVc2VmdWwgZm9yIGxhenkgaW5pdGlhbGl6YXRpb24uCiAgXy5vbmNlID0gZnVuY3Rpb24oZnVuYykgewogICAgdmFyIHJhbiA9IGZhbHNlLCBtZW1vOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAocmFuKSByZXR1cm4gbWVtbzsKICAgICAgcmFuID0gdHJ1ZTsKICAgICAgbWVtbyA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgZnVuYyA9IG51bGw7CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIHRoZSBmaXJzdCBmdW5jdGlvbiBwYXNzZWQgYXMgYW4gYXJndW1lbnQgdG8gdGhlIHNlY29uZCwKICAvLyBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGFyZ3VtZW50cywgcnVuIGNvZGUgYmVmb3JlIGFuZCBhZnRlciwgYW5kCiAgLy8gY29uZGl0aW9uYWxseSBleGVjdXRlIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KICBfLndyYXAgPSBmdW5jdGlvbihmdW5jLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gW2Z1bmNdOwogICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB3cmFwcGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgYSBsaXN0IG9mIGZ1bmN0aW9ucywgZWFjaAogIC8vIGNvbnN1bWluZyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgXy5jb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgZnVuY3MgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICBmb3IgKHZhciBpID0gZnVuY3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgfQogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIGFmdGVyIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgogIF8uYWZ0ZXIgPSBmdW5jdGlvbih0aW1lcywgZnVuYykgewogICAgaWYgKHRpbWVzIDw9IDApIHJldHVybiBmdW5jKCk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICgtLXRpbWVzIDwgMSkgewogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgLy8gT2JqZWN0IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV0cmlldmUgdGhlIG5hbWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYE9iamVjdC5rZXlzYAogIF8ua2V5cyA9IG5hdGl2ZUtleXMgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqICE9PSBPYmplY3Qob2JqKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBvYmplY3QnKTsKICAgIHZhciBrZXlzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBrZXlzW2tleXMubGVuZ3RoXSA9IGtleTsKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICBfLnZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHZhbHVlcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgdmFsdWVzLnB1c2gob2JqW2tleV0pOwogICAgcmV0dXJuIHZhbHVlczsKICB9OwoKICAvLyBDb252ZXJ0IGFuIG9iamVjdCBpbnRvIGEgbGlzdCBvZiBgW2tleSwgdmFsdWVdYCBwYWlycy4KICBfLnBhaXJzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcGFpcnMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHBhaXJzLnB1c2goW2tleSwgb2JqW2tleV1dKTsKICAgIHJldHVybiBwYWlyczsKICB9OwoKICAvLyBJbnZlcnQgdGhlIGtleXMgYW5kIHZhbHVlcyBvZiBhbiBvYmplY3QuIFRoZSB2YWx1ZXMgbXVzdCBiZSBzZXJpYWxpemFibGUuCiAgXy5pbnZlcnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJlc3VsdFtvYmpba2V5XV0gPSBrZXk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhIHNvcnRlZCBsaXN0IG9mIHRoZSBmdW5jdGlvbiBuYW1lcyBhdmFpbGFibGUgb24gdGhlIG9iamVjdC4KICAvLyBBbGlhc2VkIGFzIGBtZXRob2RzYAogIF8uZnVuY3Rpb25zID0gXy5tZXRob2RzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgbmFtZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihvYmpba2V5XSkpIG5hbWVzLnB1c2goa2V5KTsKICAgIH0KICAgIHJldHVybiBuYW1lcy5zb3J0KCk7CiAgfTsKCiAgLy8gRXh0ZW5kIGEgZ2l2ZW4gb2JqZWN0IHdpdGggYWxsIHRoZSBwcm9wZXJ0aWVzIGluIHBhc3NlZC1pbiBvYmplY3QocykuCiAgXy5leHRlbmQgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgb25seSBjb250YWluaW5nIHRoZSB3aGl0ZWxpc3RlZCBwcm9wZXJ0aWVzLgogIF8ucGljayA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoa2V5IGluIG9iaikgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9KTsKICAgIHJldHVybiBjb3B5OwogIH07CgogICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KICBfLm9taXQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoIV8uY29udGFpbnMoa2V5cywga2V5KSkgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9CiAgICByZXR1cm4gY29weTsKICB9OwoKICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgogIF8uZGVmYXVsdHMgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBpZiAob2JqW3Byb3BdID09IG51bGwpIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KICBfLmNsb25lID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CiAgfTsKCiAgLy8gSW52b2tlcyBpbnRlcmNlcHRvciB3aXRoIHRoZSBvYmosIGFuZCB0aGVuIHJldHVybnMgb2JqLgogIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICBfLnRhcCA9IGZ1bmN0aW9uKG9iaiwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCiAgdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKICAgIC8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KICAgIC8vIFNlZSB0aGUgSGFybW9ueSBgZWdhbGAgcHJvcG9zYWw6IGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbC4KICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PSAxIC8gYjsKICAgIC8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSByZXR1cm4gYSA9PT0gYjsKICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgogICAgaWYgKGEgaW5zdGFuY2VvZiBfKSBhID0gYS5fd3JhcHBlZDsKICAgIGlmIChiIGluc3RhbmNlb2YgXykgYiA9IGIuX3dyYXBwZWQ7CiAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CiAgICBpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpIHJldHVybiBmYWxzZTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgogICAgICBjYXNlICdbb2JqZWN0IFN0cmluZ10nOgogICAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwogICAgICAgIC8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCiAgICAgICAgcmV0dXJuIGEgPT0gU3RyaW5nKGIpOwogICAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgogICAgICAgIC8vIGBOYU5gcyBhcmUgZXF1aXZhbGVudCwgYnV0IG5vbi1yZWZsZXhpdmUuIEFuIGBlZ2FsYCBjb21wYXJpc29uIGlzIHBlcmZvcm1lZCBmb3IKICAgICAgICAvLyBvdGhlciBudW1lcmljIHZhbHVlcy4KICAgICAgICByZXR1cm4gYSAhPSArYSA/IGIgIT0gK2IgOiAoYSA9PSAwID8gMSAvIGEgPT0gMSAvIGIgOiBhID09ICtiKTsKICAgICAgY2FzZSAnW29iamVjdCBEYXRlXSc6CiAgICAgIGNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgogICAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKICAgICAgICAvLyBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMuIE5vdGUgdGhhdCBpbnZhbGlkIGRhdGVzIHdpdGggbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zCiAgICAgICAgLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgogICAgICAgIHJldHVybiArYSA9PSArYjsKICAgICAgLy8gUmVnRXhwcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIgc291cmNlIHBhdHRlcm5zIGFuZCBmbGFncy4KICAgICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKICAgICAgICByZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYKICAgICAgICAgICAgICAgYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYKICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYKICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT0gYSkgcmV0dXJuIGJTdGFja1tsZW5ndGhdID09IGI7CiAgICB9CiAgICAvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucHVzaChhKTsKICAgIGJTdGFjay5wdXNoKGIpOwogICAgdmFyIHNpemUgPSAwLCByZXN1bHQgPSB0cnVlOwogICAgLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCiAgICBpZiAoY2xhc3NOYW1lID09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PSBiLmxlbmd0aDsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIERlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMuCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKICAgICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgICAgdmFyIGFDdG9yID0gYS5jb25zdHJ1Y3RvciwgYkN0b3IgPSBiLmNvbnN0cnVjdG9yOwogICAgICBpZiAoYUN0b3IgIT09IGJDdG9yICYmICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiAoYUN0b3IgaW5zdGFuY2VvZiBhQ3RvcikgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgKGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBEZWVwIGNvbXBhcmUgb2JqZWN0cy4KICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICBpZiAoXy5oYXMoYSwga2V5KSkgewogICAgICAgICAgLy8gQ291bnQgdGhlIGV4cGVjdGVkIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyLgogICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgZm9yIChrZXkgaW4gYikgewogICAgICAgICAgaWYgKF8uaGFzKGIsIGtleSkgJiYgIShzaXplLS0pKSBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgIH0KICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnBvcCgpOwogICAgYlN0YWNrLnBvcCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBQZXJmb3JtIGEgZGVlcCBjb21wYXJpc29uIHRvIGNoZWNrIGlmIHR3byBvYmplY3RzIGFyZSBlcXVhbC4KICBfLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIGFycmF5LCBzdHJpbmcsIG9yIG9iamVjdCBlbXB0eT8KICAvLyBBbiAiZW1wdHkiIG9iamVjdCBoYXMgbm8gZW51bWVyYWJsZSBvd24tcHJvcGVydGllcy4KICBfLmlzRW1wdHkgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CiAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopKSByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmoubm9kZVR5cGUgPT09IDEpOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CiAgLy8gRGVsZWdhdGVzIHRvIEVDTUE1J3MgbmF0aXZlIEFycmF5LmlzQXJyYXkKICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IE9iamVjdChvYmopOwogIH07CgogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIGVhY2goWydBcmd1bWVudHMnLCAnRnVuY3Rpb24nLCAnU3RyaW5nJywgJ051bWJlcicsICdEYXRlJywgJ1JlZ0V4cCddLCBmdW5jdGlvbihuYW1lKSB7CiAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKCiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuICEhKG9iaiAmJiBfLmhhcyhvYmosICdjYWxsZWUnKSk7CiAgICB9OwogIH0KCiAgLy8gT3B0aW1pemUgYGlzRnVuY3Rpb25gIGlmIGFwcHJvcHJpYXRlLgogIGlmICh0eXBlb2YgKC8uLykgIT09ICdmdW5jdGlvbicpIHsKICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJzsKICAgIH07CiAgfQoKICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIF8uaXNOdW1iZXIob2JqKSAmJiBpc0Zpbml0ZShvYmopOwogIH07CgogIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KICBfLmlzTmFOID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPSArb2JqOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEJvb2xlYW5dJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGVxdWFsIHRvIG51bGw/CiAgXy5pc051bGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IG51bGw7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CiAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdm9pZCAwOwogIH07CgogIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKICAvLyBvbiBpdHNlbGYgKGluIG90aGVyIHdvcmRzLCBub3Qgb24gYSBwcm90b3R5cGUpLgogIF8uaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICB9OwoKICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJ1biBVbmRlcnNjb3JlLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBfYCB2YXJpYWJsZSB0byBpdHMKICAvLyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290Ll8gPSBwcmV2aW91c1VuZGVyc2NvcmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBLZWVwIHRoZSBpZGVudGl0eSBmdW5jdGlvbiBhcm91bmQgZm9yIGRlZmF1bHQgaXRlcmF0b3JzLgogIF8uaWRlbnRpdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgogIF8udGltZXMgPSBmdW5jdGlvbihuLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyBpKyspIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgaSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS4KICBfLnJhbmRvbSA9IGZ1bmN0aW9uKG1pbiwgbWF4KSB7CiAgICBpZiAobWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gbWluOwogICAgICBtaW4gPSAwOwogICAgfQogICAgcmV0dXJuIG1pbiArICgwIHwgTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSk7CiAgfTsKCiAgLy8gTGlzdCBvZiBIVE1MIGVudGl0aWVzIGZvciBlc2NhcGluZy4KICB2YXIgZW50aXR5TWFwID0gewogICAgZXNjYXBlOiB7CiAgICAgICcmJzogJyZhbXA7JywKICAgICAgJzwnOiAnJmx0OycsCiAgICAgICc+JzogJyZndDsnLAogICAgICAnIic6ICcmcXVvdDsnLAogICAgICAiJyI6ICcmI3gyNzsnLAogICAgICAnLyc6ICcmI3gyRjsnCiAgICB9CiAgfTsKICBlbnRpdHlNYXAudW5lc2NhcGUgPSBfLmludmVydChlbnRpdHlNYXAuZXNjYXBlKTsKCiAgLy8gUmVnZXhlcyBjb250YWluaW5nIHRoZSBrZXlzIGFuZCB2YWx1ZXMgbGlzdGVkIGltbWVkaWF0ZWx5IGFib3ZlLgogIHZhciBlbnRpdHlSZWdleGVzID0gewogICAgZXNjYXBlOiAgIG5ldyBSZWdFeHAoJ1snICsgXy5rZXlzKGVudGl0eU1hcC5lc2NhcGUpLmpvaW4oJycpICsgJ10nLCAnZycpLAogICAgdW5lc2NhcGU6IG5ldyBSZWdFeHAoJygnICsgXy5rZXlzKGVudGl0eU1hcC51bmVzY2FwZSkuam9pbignfCcpICsgJyknLCAnZycpCiAgfTsKCiAgLy8gRnVuY3Rpb25zIGZvciBlc2NhcGluZyBhbmQgdW5lc2NhcGluZyBzdHJpbmdzIHRvL2Zyb20gSFRNTCBpbnRlcnBvbGF0aW9uLgogIF8uZWFjaChbJ2VzY2FwZScsICd1bmVzY2FwZSddLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIF9bbWV0aG9kXSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICBpZiAoc3RyaW5nID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuICgnJyArIHN0cmluZykucmVwbGFjZShlbnRpdHlSZWdleGVzW21ldGhvZF0sIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgICAgcmV0dXJuIGVudGl0eU1hcFttZXRob2RdW21hdGNoXTsKICAgICAgfSk7CiAgICB9OwogIH0pOwoKICAvLyBJZiB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkIHByb3BlcnR5IGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQ7CiAgLy8gb3RoZXJ3aXNlLCByZXR1cm4gaXQuCiAgXy5yZXN1bHQgPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7CiAgICBpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwogICAgdmFyIHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUuY2FsbChvYmplY3QpIDogdmFsdWU7CiAgfTsKCiAgLy8gQWRkIHlvdXIgb3duIGN1c3RvbSBmdW5jdGlvbnMgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubWl4aW4gPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goXy5mdW5jdGlvbnMob2JqKSwgZnVuY3Rpb24obmFtZSl7CiAgICAgIHZhciBmdW5jID0gX1tuYW1lXSA9IG9ialtuYW1lXTsKICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIGZ1bmMuYXBwbHkoXywgYXJncykpOwogICAgICB9OwogICAgfSk7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KICAvLyBVc2VmdWwgZm9yIHRlbXBvcmFyeSBET00gaWRzLgogIHZhciBpZENvdW50ZXIgPSAwOwogIF8udW5pcXVlSWQgPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgIHZhciBpZCA9IGlkQ291bnRlcisrOwogICAgcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7CiAgfTsKCiAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCiAgLy8gZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCiAgICBpbnRlcnBvbGF0ZSA6IC88JT0oW1xzXFNdKz8pJT4vZywKICAgIGVzY2FwZSAgICAgIDogLzwlLShbXHNcU10rPyklPi9nCiAgfTsKCiAgLy8gV2hlbiBjdXN0b21pemluZyBgdGVtcGxhdGVTZXR0aW5nc2AsIGlmIHlvdSBkb24ndCB3YW50IHRvIGRlZmluZSBhbgogIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KICB2YXIgbm9NYXRjaCA9IC8oLileLzsKCiAgLy8gQ2VydGFpbiBjaGFyYWN0ZXJzIG5lZWQgdG8gYmUgZXNjYXBlZCBzbyB0aGF0IHRoZXkgY2FuIGJlIHB1dCBpbnRvIGEKICAvLyBzdHJpbmcgbGl0ZXJhbC4KICB2YXIgZXNjYXBlcyA9IHsKICAgICInIjogICAgICAiJyIsCiAgICAnXFwnOiAgICAgJ1xcJywKICAgICdccic6ICAgICAncicsCiAgICAnXG4nOiAgICAgJ24nLAogICAgJ1x0JzogICAgICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwoKICB2YXIgZXNjYXBlciA9IC9cXHwnfFxyfFxufFx0fFx1MjAyOHxcdTIwMjkvZzsKCiAgLy8gSmF2YVNjcmlwdCBtaWNyby10ZW1wbGF0aW5nLCBzaW1pbGFyIHRvIEpvaG4gUmVzaWcncyBpbXBsZW1lbnRhdGlvbi4KICAvLyBVbmRlcnNjb3JlIHRlbXBsYXRpbmcgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzIHdoaXRlc3BhY2UsCiAgLy8gYW5kIGNvcnJlY3RseSBlc2NhcGVzIHF1b3RlcyB3aXRoaW4gaW50ZXJwb2xhdGVkIGNvZGUuCiAgXy50ZW1wbGF0ZSA9IGZ1bmN0aW9uKHRleHQsIGRhdGEsIHNldHRpbmdzKSB7CiAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwoKICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzb3VyY2UgPSAiX19wKz0nIjsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KQogICAgICAgIC5yZXBsYWNlKGVzY2FwZXIsIGZ1bmN0aW9uKG1hdGNoKSB7IHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07IH0pOwogICAgICBzb3VyY2UgKz0KICAgICAgICBlc2NhcGUgPyAiJytcbigoX190PSgiICsgZXNjYXBlICsgIikpPT1udWxsPycnOl8uZXNjYXBlKF9fdCkpK1xuJyIgOgogICAgICAgIGludGVycG9sYXRlID8gIicrXG4oKF9fdD0oIiArIGludGVycG9sYXRlICsgIikpPT1udWxsPycnOl9fdCkrXG4nIiA6CiAgICAgICAgZXZhbHVhdGUgPyAiJztcbiIgKyBldmFsdWF0ZSArICJcbl9fcCs9JyIgOiAnJzsKICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CiAgICB9KTsKICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgLy8gSWYgYSB2YXJpYWJsZSBpcyBub3Qgc3BlY2lmaWVkLCBwbGFjZSBkYXRhIHZhbHVlcyBpbiBsb2NhbCBzY29wZS4KICAgIGlmICghc2V0dGluZ3MudmFyaWFibGUpIHNvdXJjZSA9ICd3aXRoKG9ianx8e30pe1xuJyArIHNvdXJjZSArICd9XG4nOwoKICAgIHNvdXJjZSA9ICJ2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sIiArCiAgICAgICJwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9O1xuIiArCiAgICAgIHNvdXJjZSArICJyZXR1cm4gX19wO1xuIjsKCiAgICB0cnkgewogICAgICB2YXIgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICB0aHJvdyBlOwogICAgfQoKICAgIGlmIChkYXRhKSByZXR1cm4gcmVuZGVyKGRhdGEsIF8pOwogICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwoKICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KICAgIHRlbXBsYXRlLnNvdXJjZSA9ICdmdW5jdGlvbignICsgKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonKSArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKCiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbiwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSB0byB0aGUgd3JhcHBlci4KICBfLmNoYWluID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXyhvYmopLmNoYWluKCk7CiAgfTsKCiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb250aW51ZSBjaGFpbmluZyBpbnRlcm1lZGlhdGUgcmVzdWx0cy4KICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwoKICAvLyBBZGQgYWxsIG9mIHRoZSBVbmRlcnNjb3JlIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlciBvYmplY3QuCiAgXy5taXhpbihfKTsKCiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9iaiA9IHRoaXMuX3dyYXBwZWQ7CiAgICAgIG1ldGhvZC5hcHBseShvYmosIGFyZ3VtZW50cyk7CiAgICAgIGlmICgobmFtZSA9PSAnc2hpZnQnIHx8IG5hbWUgPT0gJ3NwbGljZScpICYmIG9iai5sZW5ndGggPT09IDApIGRlbGV0ZSBvYmpbMF07CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwogICAgfTsKICB9KTsKCiAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIF8uZXh0ZW5kKF8ucHJvdG90eXBlLCB7CgogICAgLy8gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9jaGFpbiA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeHRyYWN0cyB0aGUgcmVzdWx0IGZyb20gYSB3cmFwcGVkIGFuZCBjaGFpbmVkIG9iamVjdC4KICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CiAgICB9CgogIH0pOwoKfSkuY2FsbCh0aGlzKTsKCi8vICAgICBCYWNrYm9uZS5qcyAwLjkuOQoKLy8gICAgIChjKSAyMDEwLTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24oKXsKCiAgLy8gSW5pdGlhbCBTZXR1cAogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdCAoYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIGBleHBvcnRzYAogIC8vIG9uIHRoZSBzZXJ2ZXIpLgogIHZhciByb290ID0gdGhpczsKCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCiAgLy8gQ3JlYXRlIGEgbG9jYWwgcmVmZXJlbmNlIHRvIGFycmF5IG1ldGhvZHMuCiAgdmFyIGFycmF5ID0gW107CiAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwogIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwogIHZhciBzcGxpY2UgPSBhcnJheS5zcGxpY2U7CgogIC8vIFRoZSB0b3AtbGV2ZWwgbmFtZXNwYWNlLiBBbGwgcHVibGljIEJhY2tib25lIGNsYXNzZXMgYW5kIG1vZHVsZXMgd2lsbAogIC8vIGJlIGF0dGFjaGVkIHRvIHRoaXMuIEV4cG9ydGVkIGZvciBib3RoIENvbW1vbkpTIGFuZCB0aGUgYnJvd3Nlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcwLjkuOSc7CgogIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4KICB2YXIgXyA9IHJvb3QuXzsKICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBvciBFbmRlciBvd25zIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9IHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlcjsKCiAgLy8gUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCiAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgogIEJhY2tib25lLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgogIC8vIHdpbGwgZmFrZSBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7CgogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9OwoKICAvLyBPcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0bwogIC8vIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihvYmosIGV2ZW50cywgYXJncykgewogICAgdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoOwogICAgc3dpdGNoIChhcmdzLmxlbmd0aCkgewogICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7CiAgICByZXR1cm47CiAgICBjYXNlIDE6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhcmdzWzBdKTsKICAgIHJldHVybjsKICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGFyZ3NbMF0sIGFyZ3NbMV0pOwogICAgcmV0dXJuOwogICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICByZXR1cm47CiAgICBkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5hcHBseShldi5jdHgsIGFyZ3MpOwogICAgfQogIH07CgogIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrCiAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KICAvLyBzdWNjZXNzaW9uLgogIC8vCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogIC8vCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCiAgICAvLyBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIG9yIGFuIGV2ZW50cyBtYXAsCiAgICAvLyB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvCiAgICAvLyBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghKGV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSAmJiBjYWxsYmFjaykpIHJldHVybiB0aGlzOwogICAgICB0aGlzLl9ldmVudHMgfHwgKHRoaXMuX2V2ZW50cyA9IHt9KTsKICAgICAgdmFyIGxpc3QgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgbGlzdC5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGV2ZW50cyB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQogICAgLy8gdGhlIGNhbGxiYWNrIGlzIGludm9rZWQsIGl0IHdpbGwgYmUgcmVtb3ZlZC4KICAgIG9uY2U6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghKGV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pICYmIGNhbGxiYWNrKSkgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHRoaXMub24obmFtZSwgb25jZSwgY29udGV4dCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgZXZlbnRzYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAogICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgogICAgb2ZmOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICB2YXIgbGlzdCwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CgogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAobGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgZXZlbnRzID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gbGlzdC5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBldiA9IGxpc3Rbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gKGV2LmNhbGxiYWNrLl9jYWxsYmFjayB8fCBldi5jYWxsYmFjaykpIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICBldmVudHMucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSBldmVudHM7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHModGhpcywgZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyh0aGlzLCBhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBbiBpbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9uIG9mIGBvbmAuIFRlbGwgKnRoaXMqIG9iamVjdCB0byBsaXN0ZW4gdG8KICAgIC8vIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncyBsaXN0ZW5pbmcgdG8uCiAgICBsaXN0ZW5UbzogZnVuY3Rpb24ob2JqZWN0LCBldmVudHMsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnMgfHwgKHRoaXMuX2xpc3RlbmVycyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqZWN0Ll9saXN0ZW5lcklkIHx8IChvYmplY3QuX2xpc3RlbmVySWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5lcnNbaWRdID0gb2JqZWN0OwogICAgICBvYmplY3Qub24oZXZlbnRzLCBjYWxsYmFjayB8fCB0aGlzLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmplY3QsIGV2ZW50cywgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKICAgICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybjsKICAgICAgaWYgKG9iamVjdCkgewogICAgICAgIG9iamVjdC5vZmYoZXZlbnRzLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgaWYgKCFldmVudHMgJiYgIWNhbGxiYWNrKSBkZWxldGUgbGlzdGVuZXJzW29iamVjdC5fbGlzdGVuZXJJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuZXJzKSB7CiAgICAgICAgICBsaXN0ZW5lcnNbaWRdLm9mZihudWxsLCBudWxsLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fbGlzdGVuZXJzID0ge307CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwsIHdpdGggZGVmaW5lZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApCiAgLy8gaXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIGFzc2lnbmVkIGZvciB5b3UuCiAgdmFyIE1vZGVsID0gQmFja2JvbmUuTW9kZWwgPSBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICB2YXIgZGVmYXVsdHM7CiAgICB2YXIgYXR0cnMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgdGhpcy5fY2hhbmdlcyA9IFtdOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb2xsZWN0aW9uKSB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMpOwogICAgaWYgKGRlZmF1bHRzID0gXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpIF8uZGVmYXVsdHMoYXR0cnMsIGRlZmF1bHRzKTsKICAgIHRoaXMuc2V0KGF0dHJzLCB7c2lsZW50OiB0cnVlfSk7CiAgICB0aGlzLl9jdXJyZW50QXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgIHVubGVzcwogICAgLy8geW91IGNob29zZSB0byBzaWxlbmNlIGl0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnM7CiAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKF8uaXNPYmplY3Qoa2V5KSkgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdmFyIHNpbGVudCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5zaWxlbnQ7CiAgICAgIHZhciB1bnNldCA9IG9wdGlvbnMgJiYgb3B0aW9ucy51bnNldDsKCiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCiAgICAgIHZhciBub3cgPSB0aGlzLmF0dHJpYnV0ZXM7CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUuLi4KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CgogICAgICAgIC8vIFVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUsIGFuZCB0cmFjayB0aGUgY2hhbmdlLgogICAgICAgIHVuc2V0ID8gZGVsZXRlIG5vd1thdHRyXSA6IG5vd1thdHRyXSA9IHZhbDsKICAgICAgICB0aGlzLl9jaGFuZ2VzLnB1c2goYXR0ciwgdmFsKTsKICAgICAgfQoKICAgICAgLy8gU2lnbmFsIHRoYXQgdGhlIG1vZGVsJ3Mgc3RhdGUgaGFzIHBvdGVudGlhbGx5IGNoYW5nZWQsIGFuZCB3ZSBuZWVkCiAgICAgIC8vIHRvIHJlY29tcHV0ZSB0aGUgYWN0dWFsIGNoYW5nZXMuCiAgICAgIHRoaXMuX2hhc0NvbXB1dGVkID0gZmFsc2U7CgogICAgICAvLyBGaXJlIHRoZSBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKCFzaWxlbnQpIHRoaXMuY2hhbmdlKG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UKICAgIC8vIHRvIHNpbGVuY2UgaXQuIGB1bnNldGAgaXMgYSBub29wIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KICAgIHVuc2V0OiBmdW5jdGlvbihhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UKICAgIC8vIHRvIHNpbGVuY2UgaXQuCiAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgYXR0cnMgPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRlbiwKICAgIC8vIHRyaWdnZXJpbmcgYSBgImNoYW5nZSJgIGV2ZW50LgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncwogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycywgY3VycmVudCwgZG9uZTsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgXy5pc09iamVjdChrZXkpKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIGlmIChrZXkgIT0gbnVsbCkgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoKICAgICAgLy8gSWYgd2UncmUgIndhaXQiLWluZyB0byBzZXQgY2hhbmdlZCBhdHRyaWJ1dGVzLCB2YWxpZGF0ZSBlYXJseS4KICAgICAgaWYgKG9wdGlvbnMud2FpdCkgewogICAgICAgIGlmIChhdHRycyAmJiAhdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgY3VycmVudCA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgfQoKICAgICAgLy8gUmVndWxhciBzYXZlcyBgc2V0YCBhdHRyaWJ1dGVzIGJlZm9yZSBwZXJzaXN0aW5nIHRvIHRoZSBzZXJ2ZXIuCiAgICAgIHZhciBzaWxlbnRPcHRpb25zID0gXy5leHRlbmQoe30sIG9wdGlvbnMsIHtzaWxlbnQ6IHRydWV9KTsKICAgICAgaWYgKGF0dHJzICYmICF0aGlzLnNldChhdHRycywgb3B0aW9ucy53YWl0ID8gc2lsZW50T3B0aW9ucyA6IG9wdGlvbnMpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICAvLyBEbyBub3QgcGVyc2lzdCBpbnZhbGlkIG1vZGVscy4KICAgICAgaWYgKCFhdHRycyAmJiAhdGhpcy5fdmFsaWRhdGUobnVsbCwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQogICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgLy8gRmluaXNoIGNvbmZpZ3VyaW5nIGFuZCBzZW5kaW5nIHRoZSBBamF4IHJlcXVlc3QuCiAgICAgIHZhciBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFdoZW4gdXNpbmcgYHdhaXRgLCByZXNldCBhdHRyaWJ1dGVzIHRvIG9yaWdpbmFsIHZhbHVlcyB1bmxlc3MKICAgICAgLy8gYHN1Y2Nlc3NgIGhhcyBiZWVuIGNhbGxlZCBhbHJlYWR5LgogICAgICBpZiAoIWRvbmUgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5jbGVhcihzaWxlbnRPcHRpb25zKTsKICAgICAgICB0aGlzLnNldChjdXJyZW50LCBzaWxlbnRPcHRpb25zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgogICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuCiAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCiAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpIGRlc3Ryb3koKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDYWxsIHRoaXMgbWV0aG9kIHRvIG1hbnVhbGx5IGZpcmUgYSBgImNoYW5nZSJgIGV2ZW50IGZvciB0aGlzIG1vZGVsIGFuZAogICAgLy8gYSBgImNoYW5nZTphdHRyaWJ1dGUiYCBldmVudCBmb3IgZWFjaCBjaGFuZ2VkIGF0dHJpYnV0ZS4KICAgIC8vIENhbGxpbmcgdGhpcyB3aWxsIGNhdXNlIGFsbCBvYmplY3RzIG9ic2VydmluZyB0aGUgbW9kZWwgdG8gdXBkYXRlLgogICAgY2hhbmdlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBjaGFuZ2luZyA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IHRydWU7CgogICAgICAvLyBHZW5lcmF0ZSB0aGUgY2hhbmdlcyB0byBiZSB0cmlnZ2VyZWQgb24gdGhlIG1vZGVsLgogICAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLl9jb21wdXRlQ2hhbmdlcyh0cnVlKTsKCiAgICAgIHRoaXMuX3BlbmRpbmcgPSAhIXRyaWdnZXJzLmxlbmd0aDsKCiAgICAgIGZvciAodmFyIGkgPSB0cmlnZ2Vycy5sZW5ndGggLSAyOyBpID49IDA7IGkgLT0gMikgewogICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyB0cmlnZ2Vyc1tpXSwgdGhpcywgdHJpZ2dlcnNbaSArIDFdLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYSBgY2hhbmdlYCB3aGlsZSB0aGVyZSBoYXZlIGJlZW4gY2hhbmdlcy4KICAgICAgd2hpbGUgKHRoaXMuX3BlbmRpbmcpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIG1vZGVsIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoIXRoaXMuX2hhc0NvbXB1dGVkKSB0aGlzLl9jb21wdXRlQ2hhbmdlcygpOwogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgIH0sCgogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlLCBvbGQgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAoKICAgIC8vIExvb2tpbmcgYXQgdGhlIGJ1aWx0IHVwIGxpc3Qgb2YgYHNldGAgYXR0cmlidXRlIGNoYW5nZXMsIGNvbXB1dGUgaG93CiAgICAvLyBtYW55IG9mIHRoZSBhdHRyaWJ1dGVzIGhhdmUgYWN0dWFsbHkgY2hhbmdlZC4gSWYgYGxvdWRgLCByZXR1cm4gYQogICAgLy8gYm9pbGVkLWRvd24gbGlzdCBvZiBvbmx5IHRoZSByZWFsIGNoYW5nZXMuCiAgICBfY29tcHV0ZUNoYW5nZXM6IGZ1bmN0aW9uKGxvdWQpIHsKICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIHZhciBhbHJlYWR5ID0ge307CiAgICAgIHZhciB0cmlnZ2VycyA9IFtdOwogICAgICAvLyBXQVJOOiBtb25rZXkgcGF0Y2ggZm9yIDAuOS45LCB3aWxsIGdvIGF3YXkgd2hlbiB1cGdyYWRpbmcKICAgICAgLy8gdG8gZnV0dXJlIHZlcnNpb24gb2YgYmFja2JvbmUKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50QXR0cmlidXRlcyB8fCB7fTsKICAgICAgdmFyIGNoYW5nZXMgPSB0aGlzLl9jaGFuZ2VzOwoKICAgICAgLy8gTG9vcCB0aHJvdWdoIHRoZSBjdXJyZW50IHF1ZXVlIG9mIHBvdGVudGlhbCBtb2RlbCBjaGFuZ2VzLgogICAgICBmb3IgKHZhciBpID0gY2hhbmdlcy5sZW5ndGggLSAyOyBpID49IDA7IGkgLT0gMikgewogICAgICAgIHZhciBrZXkgPSBjaGFuZ2VzW2ldLCB2YWwgPSBjaGFuZ2VzW2kgKyAxXTsKICAgICAgICBpZiAoYWxyZWFkeVtrZXldKSBjb250aW51ZTsKICAgICAgICBhbHJlYWR5W2tleV0gPSB0cnVlOwoKICAgICAgICAvLyBDaGVjayBpZiB0aGUgYXR0cmlidXRlIGhhcyBiZWVuIG1vZGlmaWVkIHNpbmNlIHRoZSBsYXN0IGNoYW5nZSwKICAgICAgICAvLyBhbmQgdXBkYXRlIGB0aGlzLmNoYW5nZWRgIGFjY29yZGluZ2x5LiBJZiB3ZSdyZSBpbnNpZGUgb2YgYSBgY2hhbmdlYAogICAgICAgIC8vIGNhbGwsIGFsc28gYWRkIGEgdHJpZ2dlciB0byB0aGUgbGlzdC4KICAgICAgICBpZiAoY3VycmVudFtrZXldICE9PSB2YWwpIHsKICAgICAgICAgIHRoaXMuY2hhbmdlZFtrZXldID0gdmFsOwogICAgICAgICAgaWYgKCFsb3VkKSBjb250aW51ZTsKICAgICAgICAgIHRyaWdnZXJzLnB1c2goa2V5LCB2YWwpOwogICAgICAgICAgY3VycmVudFtrZXldID0gdmFsOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobG91ZCkgdGhpcy5fY2hhbmdlcyA9IFtdOwoKICAgICAgLy8gU2lnbmFscyBgdGhpcy5jaGFuZ2VkYCBpcyBjdXJyZW50IHRvIHByZXZlbnQgZHVwbGljYXRlIGNhbGxzIGZyb20gYHRoaXMuaGFzQ2hhbmdlZGAuCiAgICAgIHRoaXMuX2hhc0NvbXB1dGVkID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRyaWdnZXJzOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgbW9kZWwgYXR0cmlidXRlcywKICAgIC8vIHJldHVybmluZyBgdHJ1ZWAgaWYgYWxsIGlzIHdlbGwuIElmIGEgc3BlY2lmaWMgYGVycm9yYCBjYWxsYmFjayBoYXMKICAgIC8vIGJlZW4gcGFzc2VkLCBjYWxsIHRoYXQgaW5zdGVhZCBvZiBmaXJpbmcgdGhlIGdlbmVyYWwgYCJlcnJvciJgIGV2ZW50LgogICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0ZShhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmVycm9yKSBvcHRpb25zLmVycm9yKHRoaXMsIGVycm9yLCBvcHRpb25zKTsKICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIHRoaXMsIGVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUHJvdmlkZXMgYSBzdGFuZGFyZCBjb2xsZWN0aW9uIGNsYXNzIGZvciBvdXIgc2V0cyBvZiBtb2RlbHMsIG9yZGVyZWQKICAvLyBvciB1bm9yZGVyZWQuIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbgogIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogIH07CgogIC8vIERlZmluZSB0aGUgQ29sbGVjdGlvbidzIGluaGVyaXRhYmxlIG1ldGhvZHMuCiAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGZvciBhIGNvbGxlY3Rpb24gaXMganVzdCBhICoqQmFja2JvbmUuTW9kZWwqKi4KICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KICAgIG1vZGVsOiBNb2RlbCwKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUKICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24obW9kZWwpeyByZXR1cm4gbW9kZWwudG9KU09OKG9wdGlvbnMpOyB9KTsKICAgIH0sCgogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCiAgICBzeW5jOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuIFBhc3MgKipzaWxlbnQqKiB0byBhdm9pZAogICAgLy8gZmlyaW5nIHRoZSBgYWRkYCBldmVudCBmb3IgZXZlcnkgbmV3IG1vZGVsLgogICAgYWRkOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgdmFyIGksIGFyZ3MsIGxlbmd0aCwgbW9kZWwsIGV4aXN0aW5nLCBuZWVkc1NvcnQ7CiAgICAgIHZhciBhdCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5hdDsKICAgICAgdmFyIHNvcnQgPSAoKG9wdGlvbnMgJiYgb3B0aW9ucy5zb3J0KSA9PSBudWxsID8gdHJ1ZSA6IG9wdGlvbnMuc29ydCk7CiAgICAgIG1vZGVscyA9IF8uaXNBcnJheShtb2RlbHMpID8gbW9kZWxzLnNsaWNlKCkgOiBbbW9kZWxzXTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gbW9kZWxzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgaWYoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbHNbaV0sIG9wdGlvbnMpKSkgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCJlcnJvciIsIHRoaXMsIG1vZGVsc1tpXSwgb3B0aW9ucyk7CiAgICAgICAgICBtb2RlbHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIG1vZGVsc1tpXSA9IG1vZGVsOwoKICAgICAgICBleGlzdGluZyA9IG1vZGVsLmlkICE9IG51bGwgJiYgdGhpcy5fYnlJZFttb2RlbC5pZF07CiAgICAgICAgLy8gSWYgYSBkdXBsaWNhdGUgaXMgZm91bmQsIHByZXZlbnQgaXQgZnJvbSBiZWluZyBhZGRlZCBhbmQKICAgICAgICAvLyBvcHRpb25hbGx5IG1lcmdlIGl0IGludG8gdGhlIGV4aXN0aW5nIG1vZGVsLgogICAgICAgIGlmIChleGlzdGluZyB8fCB0aGlzLl9ieUNpZFttb2RlbC5jaWRdKSB7CiAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLm1lcmdlICYmIGV4aXN0aW5nKSB7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChtb2RlbC5hdHRyaWJ1dGVzLCBvcHRpb25zKTsKICAgICAgICAgICAgbmVlZHNTb3J0ID0gc29ydDsKICAgICAgICAgIH0KICAgICAgICAgIG1vZGVscy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIC8vIExpc3RlbiB0byBhZGRlZCBtb2RlbHMnIGV2ZW50cywgYW5kIGluZGV4IG1vZGVscyBmb3IgbG9va3VwIGJ5CiAgICAgICAgLy8gYGlkYCBhbmQgYnkgYGNpZGAuCiAgICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICAgICAgdGhpcy5fYnlDaWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CgogICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICAgIGlmIChtb2RlbHMubGVuZ3RoKSBuZWVkc1NvcnQgPSBzb3J0OwogICAgICB0aGlzLmxlbmd0aCArPSBtb2RlbHMubGVuZ3RoOwogICAgICBhcmdzID0gW2F0ICE9IG51bGwgPyBhdCA6IHRoaXMubW9kZWxzLmxlbmd0aCwgMF07CiAgICAgIHB1c2guYXBwbHkoYXJncywgbW9kZWxzKTsKICAgICAgc3BsaWNlLmFwcGx5KHRoaXMubW9kZWxzLCBhcmdzKTsKCiAgICAgIC8vIFNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChuZWVkc1NvcnQgJiYgdGhpcy5jb21wYXJhdG9yICYmIGF0ID09IG51bGwpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CgogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBUcmlnZ2VyIGBhZGRgIGV2ZW50cy4KICAgICAgd2hpbGUgKG1vZGVsID0gbW9kZWxzLnNoaWZ0KCkpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdhZGQnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuIFBhc3Mgc2lsZW50IHRvIGF2b2lkCiAgICAvLyBmaXJpbmcgdGhlIGByZW1vdmVgIGV2ZW50IGZvciBldmVyeSBtb2RlbCByZW1vdmVkLgogICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgbW9kZWxzID0gXy5pc0FycmF5KG1vZGVscykgPyBtb2RlbHMuc2xpY2UoKSA6IFttb2RlbHNdOwogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG1vZGVsID0gdGhpcy5nZXQobW9kZWxzW2ldKTsKICAgICAgICBpZiAoIW1vZGVsKSBjb250aW51ZTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5pZF07CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5Q2lkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KHRoaXMubGVuZ3RoIC0gMSk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHNoaWZ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICBzbGljZTogZnVuY3Rpb24oYmVnaW4sIGVuZCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHMuc2xpY2UoYmVnaW4sIGVuZCk7CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgIGdldDogZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqLmlkICE9IG51bGwgPyBvYmouaWQgOiBvYmpdIHx8IHRoaXMuX2J5Q2lkW29iai5jaWQgfHwgb2JqXTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsKICAgIH0sCgogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mIGBmaWx0ZXJgLgogICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzKSB7CiAgICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gW107CiAgICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbihtb2RlbCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc29ydCBhIHNldCB3aXRob3V0IGEgY29tcGFyYXRvcicpOwogICAgICB9CgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucyB8fCAhb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBTbWFydGx5IHVwZGF0ZSBhIGNvbGxlY3Rpb24gd2l0aCBhIGNoYW5nZSBzZXQgb2YgbW9kZWxzLCBhZGRpbmcsCiAgICAvLyByZW1vdmluZywgYW5kIG1lcmdpbmcgYXMgbmVjZXNzYXJ5LgogICAgdXBkYXRlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsLCBpLCBsLCBleGlzdGluZzsKICAgICAgdmFyIGFkZCA9IFtdLCByZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKICAgICAgdmFyIGlkQXR0ciA9IHRoaXMubW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlOwogICAgICBvcHRpb25zID0gXy5leHRlbmQoe2FkZDogdHJ1ZSwgbWVyZ2U6IHRydWUsIHJlbW92ZTogdHJ1ZX0sIG9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMpOwoKICAgICAgLy8gQWxsb3cgYSBzaW5nbGUgbW9kZWwgKG9yIG5vIGFyZ3VtZW50KSB0byBiZSBwYXNzZWQuCiAgICAgIGlmICghXy5pc0FycmF5KG1vZGVscykpIG1vZGVscyA9IG1vZGVscyA/IFttb2RlbHNdIDogW107CgogICAgICAvLyBQcm94eSB0byBgYWRkYCBmb3IgdGhpcyBjYXNlLCBubyBuZWVkIHRvIGl0ZXJhdGUuLi4KICAgICAgaWYgKG9wdGlvbnMuYWRkICYmICFvcHRpb25zLnJlbW92ZSkgcmV0dXJuIHRoaXMuYWRkKG1vZGVscywgb3B0aW9ucyk7CgogICAgICAvLyBEZXRlcm1pbmUgd2hpY2ggbW9kZWxzIHRvIGFkZCBhbmQgbWVyZ2UsIGFuZCB3aGljaCB0byByZW1vdmUuCiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV07CiAgICAgICAgZXhpc3RpbmcgPSB0aGlzLmdldChtb2RlbC5pZCB8fCBtb2RlbC5jaWQgfHwgbW9kZWxbaWRBdHRyXSk7CiAgICAgICAgaWYgKG9wdGlvbnMucmVtb3ZlICYmIGV4aXN0aW5nKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICBpZiAoKG9wdGlvbnMuYWRkICYmICFleGlzdGluZykgfHwgKG9wdGlvbnMubWVyZ2UgJiYgZXhpc3RpbmcpKSB7CiAgICAgICAgICBhZGQucHVzaChtb2RlbCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnJlbW92ZSkgewogICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIG1vZGVsID0gdGhpcy5tb2RlbHNbaV07CiAgICAgICAgICBpZiAoIW1vZGVsTWFwW21vZGVsLmNpZF0pIHJlbW92ZS5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBtb2RlbHMgKGlmIGFwcGxpY2FibGUpIGJlZm9yZSB3ZSBhZGQgYW5kIG1lcmdlIHRoZSByZXN0LgogICAgICBpZiAocmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUocmVtb3ZlLCBvcHRpb25zKTsKICAgICAgaWYgKGFkZC5sZW5ndGgpIHRoaXMuYWRkKGFkZCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBXaGVuIHlvdSBoYXZlIG1vcmUgaXRlbXMgdGhhbiB5b3Ugd2FudCB0byBhZGQgb3IgcmVtb3ZlIGluZGl2aWR1YWxseSwKICAgIC8vIHlvdSBjYW4gcmVzZXQgdGhlIGVudGlyZSBzZXQgd2l0aCBhIG5ldyBsaXN0IG9mIG1vZGVscywgd2l0aG91dCBmaXJpbmcKICAgIC8vIGFueSBgYWRkYCBvciBgcmVtb3ZlYCBldmVudHMuIEZpcmVzIGByZXNldGAgd2hlbiBmaW5pc2hlZC4KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0pOwogICAgICB9CiAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgaWYgKG1vZGVscykgdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYGFkZDogdHJ1ZWAgaXMgcGFzc2VkLCBhcHBlbmRzIHRoZQogICAgLy8gbW9kZWxzIHRvIHRoZSBjb2xsZWN0aW9uIGluc3RlYWQgb2YgcmVzZXR0aW5nLgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwLCBzdGF0dXMsIHhocikgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnVwZGF0ZSA/ICd1cGRhdGUnIDogJ3Jlc2V0JzsKICAgICAgICBjb2xsZWN0aW9uW21ldGhvZF0ocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24obW9kZWwsIHJlc3AsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICBtb2RlbC5zYXZlKG51bGwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gYSBsaXN0IG9mIG1vZGVscyB0byBiZSBhZGRlZCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5tb2RlbHMpOwogICAgfSwKCiAgICAvLyBQcm94eSB0byBfJ3MgY2hhaW4uIENhbid0IGJlIHByb3hpZWQgdGhlIHNhbWUgd2F5IHRoZSByZXN0IG9mIHRoZQogICAgLy8gdW5kZXJzY29yZSBtZXRob2RzIGFyZSBwcm94aWVkIGJlY2F1c2UgaXQgcmVsaWVzIG9uIHRoZSB1bmRlcnNjb3JlCiAgICAvLyBjb25zdHJ1Y3Rvci4KICAgIGNoYWluOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8odGhpcy5tb2RlbHMpLmNoYWluKCk7CiAgICB9LAoKICAgIC8vIFJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24gaXMgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzID0gW107CiAgICAgIHRoaXMuX2J5SWQgID0ge307CiAgICAgIHRoaXMuX2J5Q2lkID0ge307CiAgICB9LAoKICAgIC8vIFByZXBhcmUgYSBtb2RlbCBvciBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYWRkZWQgdG8gdGhpcyBjb2xsZWN0aW9uLgogICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKICAgICAgICBpZiAoIWF0dHJzLmNvbGxlY3Rpb24pIGF0dHJzLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICAgIHJldHVybiBhdHRyczsKICAgICAgfQogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byByZW1vdmUgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCiAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsCiAgICAnbWF4JywgJ21pbicsICdzb3J0ZWRJbmRleCcsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywKICAgICdpbml0aWFsJywgJ3Jlc3QnLCAndGFpbCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnaW5kZXhPZicsICdzaHVmZmxlJywKICAgICdsYXN0SW5kZXhPZicsICdpc0VtcHR5J107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5tb2RlbHMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCiAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbJ2dyb3VwQnknLCAnY291bnRCeScsICdzb3J0QnknXTsKCiAgLy8gVXNlIGF0dHJpYnV0ZXMgaW5zdGVhZCBvZiBwcm9wZXJ0aWVzLgogIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih2YWx1ZSwgY29udGV4dCkgewogICAgICB2YXIgaXRlcmF0b3IgPSBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwogICAgICB9OwogICAgICByZXR1cm4gX1ttZXRob2RdKHRoaXMubW9kZWxzLCBpdGVyYXRvciwgY29udGV4dCk7CiAgICB9OwogIH0pOwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvOlx3Ky9nOwogIHZhciBzcGxhdFBhcmFtICAgID0gL1wqXHcrL2c7CiAgdmFyIGVzY2FwZVJlZ0V4cCAgPSAvW1wte31cW1xdKz8uLFxcXF4kfCNcc10vZzsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlJvdXRlcioqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoUm91dGVyLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyBNYW51YWxseSBiaW5kIGEgc2luZ2xlIG5hbWVkIHJvdXRlIHRvIGEgY2FsbGJhY2suIEZvciBleGFtcGxlOgogICAgLy8KICAgIC8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsKICAgIC8vICAgICAgIC4uLgogICAgLy8gICAgIH0pOwogICAgLy8KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgaWYgKCFfLmlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKICAgICAgaWYgKCFjYWxsYmFjaykgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwogICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBfLmJpbmQoZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgICB2YXIgYXJncyA9IHRoaXMuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHRoaXMsIG5hbWUsIGFyZ3MpOwogICAgICB9LCB0aGlzKSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgogICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CiAgICAgIHZhciByb3V0ZSwgcm91dGVzID0gXy5rZXlzKHRoaXMucm91dGVzKTsKICAgICAgd2hpbGUgKChyb3V0ZSA9IHJvdXRlcy5wb3AoKSkgIT0gbnVsbCkgewogICAgICAgIHRoaXMucm91dGUocm91dGUsIHRoaXMucm91dGVzW3JvdXRlXSk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKICAgIC8vIGFnYWluc3QgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaC4KICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbihyb3V0ZSkgewogICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShvcHRpb25hbFBhcmFtLCAnKD86JDEpPycpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShuYW1lZFBhcmFtLCAnKFteXC9dKyknKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyguKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIHBhcmFtZXRlcnMuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICByZXR1cm4gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5IaXN0b3J5CiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBVUkwgZnJhZ21lbnRzLiBJZiB0aGUKICAvLyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgYG9uaGFzaGNoYW5nZWAsIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KICB2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKICAgIF8uYmluZEFsbCh0aGlzLCAnY2hlY2tVcmwnKTsKCiAgICAvLyBFbnN1cmUgdGhhdCBgSGlzdG9yeWAgY2FuIGJlIHVzZWQgb3V0c2lkZSBvZiB0aGUgYnJvd3Nlci4KICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgICB0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKICAgIH0KICB9OwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBhIGxlYWRpbmcgaGFzaC9zbGFzaCBhbmQgdHJhaWxpbmcgc3BhY2UuCiAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcy4KICB2YXIgcm9vdFN0cmlwcGVyID0gL15cLyt8XC8rJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgogIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgogIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CgogIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgIGludGVydmFsOiA1MCwKCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewogICAgICB2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewogICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lOwogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc3Vic3RyKHJvb3QubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgfSwKCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7fSwge3Jvb3Q6ICcvJ30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CiAgICAgIHRoaXMucm9vdCAgICAgICAgICAgICA9IHRoaXMub3B0aW9ucy5yb290OwogICAgICB0aGlzLl93YW50c0hhc2hDaGFuZ2UgPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CiAgICAgIHRoaXMuX3dhbnRzUHVzaFN0YXRlICA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKICAgICAgdGhpcy5faGFzUHVzaFN0YXRlICAgID0gISEodGhpcy5vcHRpb25zLnB1c2hTdGF0ZSAmJiB0aGlzLmhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5LnB1c2hTdGF0ZSk7CiAgICAgIHZhciBmcmFnbWVudCAgICAgICAgICA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgdmFyIGRvY01vZGUgICAgICAgICAgID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwogICAgICB2YXIgb2xkSUUgICAgICAgICAgICAgPSAoaXNFeHBsb3Jlci5leGVjKG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSkgJiYgKCFkb2NNb2RlIHx8IGRvY01vZGUgPD0gNykpOwoKICAgICAgLy8gTm9ybWFsaXplIHJvb3QgdG8gYWx3YXlzIGluY2x1ZGUgYSBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaC4KICAgICAgdGhpcy5yb290ID0gKCcvJyArIHRoaXMucm9vdCArICcvJykucmVwbGFjZShyb290U3RyaXBwZXIsICcvJyk7CgogICAgICBpZiAob2xkSUUgJiYgdGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5pZnJhbWUgPSBCYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiIC8+JykuaGlkZSgpLmFwcGVuZFRvKCdib2R5JylbMF0uY29udGVudFdpbmRvdzsKICAgICAgICB0aGlzLm5hdmlnYXRlKGZyYWdtZW50KTsKICAgICAgfQoKICAgICAgLy8gRGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmUgdXNpbmcgcHVzaFN0YXRlIG9yIGhhc2hlcywgYW5kIHdoZXRoZXIKICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykuYmluZCgncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLmJpbmQoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl9jaGVja1VybEludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5jaGVja1VybCwgdGhpcy5pbnRlcnZhbCk7CiAgICAgIH0KCiAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCiAgICAgIC8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4KICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKICAgICAgdmFyIGF0Um9vdCA9IGxvYy5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKCiAgICAgIC8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb2ZmIHdpdGggYSByb3V0ZSBmcm9tIGEgYHB1c2hTdGF0ZWAtZW5hYmxlZCBicm93c2VyLAogICAgICAvLyBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLgogICAgICBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmIHRoaXMuX3dhbnRzUHVzaFN0YXRlICYmICF0aGlzLl9oYXNQdXNoU3RhdGUgJiYgIWF0Um9vdCkgewogICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwogICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgIC8vIFJldHVybiBpbW1lZGlhdGVseSBhcyBicm93c2VyIHdpbGwgZG8gcmVkaXJlY3QgdG8gbmV3IHVybAogICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgLy8gaW4gYSBicm93c2VyIHdoZXJlIGl0IGNvdWxkIGJlIGBwdXNoU3RhdGVgLWJhc2VkIGluc3RlYWQuLi4KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c1B1c2hTdGF0ZSAmJiB0aGlzLl9oYXNQdXNoU3RhdGUgJiYgYXRSb290ICYmIGxvYy5oYXNoKSB7CiAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50ICsgbG9jLnNlYXJjaCk7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwogICAgfSwKCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIEJhY2tib25lLiQod2luZG93KS51bmJpbmQoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkudW5iaW5kKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCk7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwogICAgfSwKCiAgICAvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCiAgICAvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLgogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBjYWxsYmFjaykgewogICAgICB0aGlzLmhhbmRsZXJzLnVuc2hpZnQoe3JvdXRlOiByb3V0ZSwgY2FsbGJhY2s6IGNhbGxiYWNrfSk7CiAgICB9LAoKICAgIC8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAogICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCiAgICBjaGVja1VybDogZnVuY3Rpb24oZSkgewogICAgICB2YXIgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsKICAgICAgICBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKTsKICAgICAgfQogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAodGhpcy5pZnJhbWUpIHRoaXMubmF2aWdhdGUoY3VycmVudCk7CiAgICAgIHRoaXMubG9hZFVybCgpIHx8IHRoaXMubG9hZFVybCh0aGlzLmdldEhhc2goKSk7CiAgICB9LAoKICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCiAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAogICAgLy8gcmV0dXJucyBgZmFsc2VgLgogICAgbG9hZFVybDogZnVuY3Rpb24oZnJhZ21lbnRPdmVycmlkZSkgewogICAgICB2YXIgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudE92ZXJyaWRlKTsKICAgICAgdmFyIG1hdGNoZWQgPSBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKICAgICAgICAgIGhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICB9LAoKICAgIC8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUKICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKICAgIC8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgogICAgLy8KICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKICAgIC8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCiAgICAvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIGlmICghSGlzdG9yeS5zdGFydGVkKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zID09PSB0cnVlKSBvcHRpb25zID0ge3RyaWdnZXI6IG9wdGlvbnN9OwogICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpOwogICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICB2YXIgdXJsID0gdGhpcy5yb290ICsgZnJhZ21lbnQ7CgogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCiAgICAgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCiAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewogICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhCiAgICAgICAgICAvLyBoaXN0b3J5IGVudHJ5IG9uIGhhc2gtdGFnIGNoYW5nZS4gIFdoZW4gcmVwbGFjZSBpcyB0cnVlLCB3ZSBkb24ndAogICAgICAgICAgLy8gd2FudCB0aGlzLgogICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9CgogICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KICAgICAgLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKICAgIH0sCgogICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgewogICAgICBpZiAocmVwbGFjZSkgewogICAgICAgIHZhciBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CiAgICAgICAgbG9jYXRpb24ucmVwbGFjZShocmVmICsgJyMnICsgZnJhZ21lbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNvbWUgYnJvd3NlcnMgcmVxdWlyZSB0aGF0IGBoYXNoYCBjb250YWlucyBhIGxlYWRpbmcgIy4KICAgICAgICBsb2NhdGlvbi5oYXNoID0gJyMnICsgZnJhZ21lbnQ7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5LgogIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeTsKCiAgLy8gQmFja2JvbmUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgIHRoaXMuX2NvbmZpZ3VyZShvcHRpb25zIHx8IHt9KTsKICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogIH07CgogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLgogIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KICB2YXIgdmlld09wdGlvbnMgPSBbJ21vZGVsJywgJ2NvbGxlY3Rpb24nLCAnZWwnLCAnaWQnLCAnYXR0cmlidXRlcycsICdjbGFzc05hbWUnLCAndGFnTmFtZScsICdldmVudHMnXTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBgdGFnTmFtZWAgb2YgYSBWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLgogICAgdGFnTmFtZTogJ2RpdicsCgogICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlCiAgICAvLyBjdXJyZW50IHZpZXcuIFRoaXMgc2hvdWxkIGJlIHByZWZlcmVkIHRvIGdsb2JhbCBsb29rdXBzIHdoZXJlIHBvc3NpYmxlLgogICAgJDogZnVuY3Rpb24oc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMuJGVsLmZpbmQoc2VsZWN0b3IpOwogICAgfSwKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vICoqcmVuZGVyKiogaXMgdGhlIGNvcmUgZnVuY3Rpb24gdGhhdCB5b3VyIHZpZXcgc2hvdWxkIG92ZXJyaWRlLCBpbiBvcmRlcgogICAgLy8gdG8gcG9wdWxhdGUgaXRzIGVsZW1lbnQgKGB0aGlzLmVsYCksIHdpdGggdGhlIGFwcHJvcHJpYXRlIEhUTUwuIFRoZQogICAgLy8gY29udmVudGlvbiBpcyBmb3IgKipyZW5kZXIqKiB0byBhbHdheXMgcmV0dXJuIGB0aGlzYC4KICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgdGhpcyB2aWV3IGJ5IHRha2luZyB0aGUgZWxlbWVudCBvdXQgb2YgdGhlIERPTSwgYW5kIHJlbW92aW5nIGFueQogICAgLy8gYXBwbGljYWJsZSBCYWNrYm9uZS5FdmVudHMgbGlzdGVuZXJzLgogICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwucmVtb3ZlKCk7CiAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRm9yIHNtYWxsIGFtb3VudHMgb2YgRE9NIEVsZW1lbnRzLCB3aGVyZSBhIGZ1bGwtYmxvd24gdGVtcGxhdGUgaXNuJ3QKICAgIC8vIG5lZWRlZCwgdXNlICoqbWFrZSoqIHRvIG1hbnVmYWN0dXJlIGVsZW1lbnRzLCBvbmUgYXQgYSB0aW1lLgogICAgLy8KICAgIC8vICAgICB2YXIgZWwgPSB0aGlzLm1ha2UoJ2xpJywgeydjbGFzcyc6ICdyb3cnfSwgdGhpcy5tb2RlbC5lc2NhcGUoJ3RpdGxlJykpOwogICAgLy8KICAgIG1ha2U6IGZ1bmN0aW9uKHRhZ05hbWUsIGF0dHJpYnV0ZXMsIGNvbnRlbnQpIHsKICAgICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTsKICAgICAgaWYgKGF0dHJpYnV0ZXMpIEJhY2tib25lLiQoZWwpLmF0dHIoYXR0cmlidXRlcyk7CiAgICAgIGlmIChjb250ZW50ICE9IG51bGwpIEJhY2tib25lLiQoZWwpLmh0bWwoY29udGVudCk7CiAgICAgIHJldHVybiBlbDsKICAgIH0sCgogICAgLy8gQ2hhbmdlIHRoZSB2aWV3J3MgZWxlbWVudCAoYHRoaXMuZWxgIHByb3BlcnR5KSwgaW5jbHVkaW5nIGV2ZW50CiAgICAvLyByZS1kZWxlZ2F0aW9uLgogICAgc2V0RWxlbWVudDogZnVuY3Rpb24oZWxlbWVudCwgZGVsZWdhdGUpIHsKICAgICAgaWYgKHRoaXMuJGVsKSB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgdGhpcy4kZWwgPSBlbGVtZW50IGluc3RhbmNlb2YgQmFja2JvbmUuJCA/IGVsZW1lbnQgOiBCYWNrYm9uZS4kKGVsZW1lbnQpOwogICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07CiAgICAgIGlmIChkZWxlZ2F0ZSAhPT0gZmFsc2UpIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFNldCBjYWxsYmFja3MsIHdoZXJlIGB0aGlzLmV2ZW50c2AgaXMgYSBoYXNoIG9mCiAgICAvLwogICAgLy8gKnsiZXZlbnQgc2VsZWN0b3IiOiAiY2FsbGJhY2sifSoKICAgIC8vCiAgICAvLyAgICAgewogICAgLy8gICAgICAgJ21vdXNlZG93biAudGl0bGUnOiAgJ2VkaXQnLAogICAgLy8gICAgICAgJ2NsaWNrIC5idXR0b24nOiAgICAgJ3NhdmUnCiAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CiAgICAvLyAgICAgfQogICAgLy8KICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgogICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgogICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCiAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm47CiAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICBmb3IgKHZhciBrZXkgaW4gZXZlbnRzKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOwogICAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIG1ldGhvZCA9IHRoaXNbZXZlbnRzW2tleV1dOwogICAgICAgIGlmICghbWV0aG9kKSB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCAiJyArIGV2ZW50c1trZXldICsgJyIgZG9lcyBub3QgZXhpc3QnKTsKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwuYmluZChldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJGVsLmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8vIENsZWFycyBhbGwgY2FsbGJhY2tzIHByZXZpb3VzbHkgYm91bmQgdG8gdGhlIHZpZXcgd2l0aCBgZGVsZWdhdGVFdmVudHNgLgogICAgLy8gWW91IHVzdWFsbHkgZG9uJ3QgbmVlZCB0byB1c2UgdGhpcywgYnV0IG1heSB3aXNoIHRvIGlmIHlvdSBoYXZlIG11bHRpcGxlCiAgICAvLyBCYWNrYm9uZSB2aWV3cyBhdHRhY2hlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudC4KICAgIHVuZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC51bmJpbmQoJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZCk7CiAgICB9LAoKICAgIC8vIFBlcmZvcm1zIHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24gb2YgYSBWaWV3IHdpdGggYSBzZXQgb2Ygb3B0aW9ucy4KICAgIC8vIEtleXMgd2l0aCBzcGVjaWFsIG1lYW5pbmcgKihtb2RlbCwgY29sbGVjdGlvbiwgaWQsIGNsYXNzTmFtZSkqLCBhcmUKICAgIC8vIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSB2aWV3LgogICAgX2NvbmZpZ3VyZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAodGhpcy5vcHRpb25zKSBvcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOwogICAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0sCgogICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCiAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKICAgIC8vIG1hdGNoaW5nIGVsZW1lbnQsIGFuZCByZS1hc3NpZ24gaXQgdG8gYGVsYC4gT3RoZXJ3aXNlLCBjcmVhdGUKICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CiAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSBhdHRyc1snY2xhc3MnXSA9IF8ucmVzdWx0KHRoaXMsICdjbGFzc05hbWUnKTsKICAgICAgICB0aGlzLnNldEVsZW1lbnQodGhpcy5tYWtlKF8ucmVzdWx0KHRoaXMsICd0YWdOYW1lJyksIGF0dHJzKSwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBCYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4KICB2YXIgbWV0aG9kTWFwID0gewogICAgJ2NyZWF0ZSc6ICdQT1NUJywKICAgICd1cGRhdGUnOiAnUFVUJywKICAgICdwYXRjaCc6ICAnUEFUQ0gnLAogICAgJ2RlbGV0ZSc6ICdERUxFVEUnLAogICAgJ3JlYWQnOiAgICdHRVQnCiAgfTsKCiAgLy8gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiB0byBjaGFuZ2UgdGhlIG1hbm5lciBpbiB3aGljaCBCYWNrYm9uZSBwZXJzaXN0cwogIC8vIG1vZGVscyB0byB0aGUgc2VydmVyLiBZb3Ugd2lsbCBiZSBwYXNzZWQgdGhlIHR5cGUgb2YgcmVxdWVzdCwgYW5kIHRoZQogIC8vIG1vZGVsIGluIHF1ZXN0aW9uLiBCeSBkZWZhdWx0LCBtYWtlcyBhIFJFU1RmdWwgQWpheCByZXF1ZXN0CiAgLy8gdG8gdGhlIG1vZGVsJ3MgYHVybCgpYC4gU29tZSBwb3NzaWJsZSBjdXN0b21pemF0aW9ucyBjb3VsZCBiZToKICAvLwogIC8vICogVXNlIGBzZXRUaW1lb3V0YCB0byBiYXRjaCByYXBpZC1maXJlIHVwZGF0ZXMgaW50byBhIHNpbmdsZSByZXF1ZXN0LgogIC8vICogU2VuZCB1cCB0aGUgbW9kZWxzIGFzIFhNTCBpbnN0ZWFkIG9mIEpTT04uCiAgLy8gKiBQZXJzaXN0IG1vZGVscyB2aWEgV2ViU29ja2V0cyBpbnN0ZWFkIG9mIEFqYXguCiAgLy8KICAvLyBUdXJuIG9uIGBCYWNrYm9uZS5lbXVsYXRlSFRUUGAgaW4gb3JkZXIgdG8gc2VuZCBgUFVUYCBhbmQgYERFTEVURWAgcmVxdWVzdHMKICAvLyBhcyBgUE9TVGAsIHdpdGggYSBgX21ldGhvZGAgcGFyYW1ldGVyIGNvbnRhaW5pbmcgdGhlIHRydWUgSFRUUCBtZXRob2QsCiAgLy8gYXMgd2VsbCBhcyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgYm9keSBhcyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAogIC8vIGluc3RlYWQgb2YgYGFwcGxpY2F0aW9uL2pzb25gIHdpdGggdGhlIG1vZGVsIGluIGEgcGFyYW0gbmFtZWQgYG1vZGVsYC4KICAvLyBVc2VmdWwgd2hlbiBpbnRlcmZhY2luZyB3aXRoIHNlcnZlci1zaWRlIGxhbmd1YWdlcyBsaWtlICoqUEhQKiogdGhhdCBtYWtlCiAgLy8gaXQgZGlmZmljdWx0IHRvIHJlYWQgdGhlIGJvZHkgb2YgYFBVVGAgcmVxdWVzdHMuCiAgQmFja2JvbmUuc3luYyA9IGZ1bmN0aW9uKG1ldGhvZCwgbW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciB0eXBlID0gbWV0aG9kTWFwW21ldGhvZF07CgogICAgLy8gRGVmYXVsdCBvcHRpb25zLCB1bmxlc3Mgc3BlY2lmaWVkLgogICAgXy5kZWZhdWx0cyhvcHRpb25zIHx8IChvcHRpb25zID0ge30pLCB7CiAgICAgIGVtdWxhdGVIVFRQOiBCYWNrYm9uZS5lbXVsYXRlSFRUUCwKICAgICAgZW11bGF0ZUpTT046IEJhY2tib25lLmVtdWxhdGVKU09OCiAgICB9KTsKCiAgICAvLyBEZWZhdWx0IEpTT04tcmVxdWVzdCBvcHRpb25zLgogICAgdmFyIHBhcmFtcyA9IHt0eXBlOiB0eXBlLCBkYXRhVHlwZTogJ2pzb24nfTsKCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIGEgVVJMLgogICAgaWYgKCFvcHRpb25zLnVybCkgewogICAgICBwYXJhbXMudXJsID0gXy5yZXN1bHQobW9kZWwsICd1cmwnKSB8fCB1cmxFcnJvcigpOwogICAgfQoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgdGhlIGFwcHJvcHJpYXRlIHJlcXVlc3QgZGF0YS4KICAgIGlmIChvcHRpb25zLmRhdGEgPT0gbnVsbCAmJiBtb2RlbCAmJiAobWV0aG9kID09PSAnY3JlYXRlJyB8fCBtZXRob2QgPT09ICd1cGRhdGUnIHx8IG1ldGhvZCA9PT0gJ3BhdGNoJykpIHsKICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nOwogICAgICBwYXJhbXMuZGF0YSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuYXR0cnMgfHwgbW9kZWwudG9KU09OKG9wdGlvbnMpKTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBKU09OIGJ5IGVuY29kaW5nIHRoZSByZXF1ZXN0IGludG8gYW4gSFRNTC1mb3JtLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCc7CiAgICAgIHBhcmFtcy5kYXRhID0gcGFyYW1zLmRhdGEgPyB7bW9kZWw6IHBhcmFtcy5kYXRhfSA6IHt9OwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEhUVFAgYnkgbWltaWNraW5nIHRoZSBIVFRQIG1ldGhvZCB3aXRoIGBfbWV0aG9kYAogICAgLy8gQW5kIGFuIGBYLUhUVFAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSFRUUCAmJiAodHlwZSA9PT0gJ1BVVCcgfHwgdHlwZSA9PT0gJ0RFTEVURScgfHwgdHlwZSA9PT0gJ1BBVENIJykpIHsKICAgICAgcGFyYW1zLnR5cGUgPSAnUE9TVCc7CiAgICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSBwYXJhbXMuZGF0YS5fbWV0aG9kID0gdHlwZTsKICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9IGZ1bmN0aW9uKHhocikgewogICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLUhUVFAtTWV0aG9kLU92ZXJyaWRlJywgdHlwZSk7CiAgICAgICAgaWYgKGJlZm9yZVNlbmQpIHJldHVybiBiZWZvcmVTZW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CgogICAgLy8gRG9uJ3QgcHJvY2VzcyBkYXRhIG9uIGEgbm9uLUdFVCByZXF1ZXN0LgogICAgaWYgKHBhcmFtcy50eXBlICE9PSAnR0VUJyAmJiAhb3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMucHJvY2Vzc0RhdGEgPSBmYWxzZTsKICAgIH0KCiAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7CiAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKHJlc3AsIHN0YXR1cywgeGhyKTsKICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgIH07CgogICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbih4aHIsIHN0YXR1cywgdGhyb3duKSB7CiAgICAgIGlmIChlcnJvcikgZXJyb3IobW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICAgIG1vZGVsLnRyaWdnZXIoJ2Vycm9yJywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICB9OwoKICAgIC8vIE1ha2UgdGhlIHJlcXVlc3QsIGFsbG93aW5nIHRoZSB1c2VyIHRvIG92ZXJyaWRlIGFueSBBamF4IG9wdGlvbnMuCiAgICB2YXIgeGhyID0gQmFja2JvbmUuYWpheChfLmV4dGVuZChwYXJhbXMsIG9wdGlvbnMpKTsKICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIHJldHVybiB4aHI7CiAgfTsKCiAgLy8gU2V0IHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGBCYWNrYm9uZS5hamF4YCB0byBwcm94eSB0aHJvdWdoIHRvIGAkYC4KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCiAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogIHZhciBleHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgdmFyIHBhcmVudCA9IHRoaXM7CiAgICB2YXIgY2hpbGQ7CgogICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQogICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAogICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogICAgaWYgKHByb3RvUHJvcHMgJiYgXy5oYXMocHJvdG9Qcm9wcywgJ2NvbnN0cnVjdG9yJykpIHsKICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwogICAgfSBlbHNlIHsKICAgICAgY2hpbGQgPSBmdW5jdGlvbigpeyBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICAgIH0KCiAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgIF8uZXh0ZW5kKGNoaWxkLCBwYXJlbnQsIHN0YXRpY1Byb3BzKTsKCiAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbigpeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH07CiAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7CgogICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAvLyBpZiBzdXBwbGllZC4KICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKICAgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQKICAgIC8vIGxhdGVyLgogICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgICByZXR1cm4gY2hpbGQ7CiAgfTsKCiAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KICBNb2RlbC5leHRlbmQgPSBDb2xsZWN0aW9uLmV4dGVuZCA9IFJvdXRlci5leHRlbmQgPSBWaWV3LmV4dGVuZCA9IEhpc3RvcnkuZXh0ZW5kID0gZXh0ZW5kOwoKICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCiAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsKICB9OwoKfSkuY2FsbCh0aGlzKTsKLyoKQ29weXJpZ2h0IChjKSAyMDExLTIwMTMgQFdhbG1hcnRMYWJzCgpQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5Cm9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0bwpkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZQpyaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3IKc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKClRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCmFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoKVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCkZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQpBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCkxJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCkZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIKREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoqLwoKOzsKKGZ1bmN0aW9uKCkgewoKLypnbG9iYWwgY2xvbmVJbmhlcml0VmFycywgY3JlYXRlSW5oZXJpdFZhcnMsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciwgZ2V0VmFsdWUsIGluaGVyaXRWYXJzICovCgovL3N1cHBvcnQgemVwdG8uZm9yRWFjaCBvbiBqUXVlcnkKaWYgKCEkLmZuLmZvckVhY2gpIHsKICAkLmZuLmZvckVhY2ggPSBmdW5jdGlvbihpdGVyYXRvciwgY29udGV4dCkgewogICAgJC5mbi5lYWNoLmNhbGwodGhpcywgZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0IHx8IHRoaXMsIHRoaXMsIGluZGV4KTsKICAgIH0pOwogIH07Cn0KCnZhciB2aWV3TmFtZUF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LW5hbWUnLAogICAgdmlld0NpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LWNpZCcsCiAgICB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctaGVscGVyJzsKCi8vdmlldyBpbnN0YW5jZXMKdmFyIHZpZXdzSW5kZXhlZEJ5Q2lkID0ge307Cgp2YXIgVGhvcmF4ID0gdGhpcy5UaG9yYXggPSB7CiAgVkVSU0lPTjogJzIuMC4wcmMxJywKICB0ZW1wbGF0ZVBhdGhQcmVmaXg6ICcnLAogIHRlbXBsYXRlczoge30sCiAgLy92aWV3IGNsYXNzZXMKICBWaWV3czoge30sCiAgLy9jZXJ0YWluIGVycm9yIHByb25lIHBpZWNlcyBvZiBjb2RlIChvbiBBbmRyb2lkIG9ubHkgaXQgc2VlbXMpCiAgLy9hcmUgd3JhcHBlZCBpbiBhIHRyeSBjYXRjaCBibG9jaywgdGhlbiB0cmlnZ2VyIHRoaXMgaGFuZGxlciBpbgogIC8vdGhlIGNhdGNoLCB3aXRoIHRoZSBuYW1lIG9mIHRoZSBmdW5jdGlvbiBvciBldmVudCB0aGF0IHdhcwogIC8vdHJ5aW5nIHRvIGJlIGV4ZWN1dGVkLiBPdmVycmlkZSB0aGlzIHdpdGggYSBjdXN0b20gaGFuZGxlcgogIC8vdG8gZGVidWcgLyBsb2cgLyBldGMKICBvbkV4Y2VwdGlvbjogZnVuY3Rpb24obmFtZSwgZXJyKSB7CiAgICB0aHJvdyBlcnI7CiAgfQp9OwoKVGhvcmF4LlZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3BvbnNlID0gQmFja2JvbmUuVmlldy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iai5jdG9yKSB7CiAgICAgICAgb2JqLmN0b3IuY2FsbCh0aGlzLCByZXNwb25zZSk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgX2NvbmZpZ3VyZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZCA9IHt9OwogICAgdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkID0ge307CgogICAgLy8gU2V0dXAgb2JqZWN0IGV2ZW50IHRyYWNraW5nCiAgICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgICBzZWxmW29iai5uYW1lXSA9IFtdOwogICAgfSk7CgogICAgdmlld3NJbmRleGVkQnlDaWRbdGhpcy5jaWRdID0gdGhpczsKICAgIHRoaXMuY2hpbGRyZW4gPSB7fTsKICAgIHRoaXMuX3JlbmRlckNvdW50ID0gMDsKCiAgICAvL3RoaXMub3B0aW9ucyBpcyByZW1vdmVkIGluIFRob3JheC5WaWV3LCB3ZSBtZXJnZSBwYXNzZWQKICAgIC8vcHJvcGVydGllcyBkaXJlY3RseSB3aXRoIHRoZSB2aWV3IGFuZCB0ZW1wbGF0ZSBjb250ZXh0CiAgICBfLmV4dGVuZCh0aGlzLCBvcHRpb25zIHx8IHt9KTsKCiAgICAvLyBTZXR1cCBoZWxwZXJzCiAgICBiaW5kSGVscGVycy5jYWxsKHRoaXMpOwoKICAgIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmouY29uZmlndXJlKSB7CiAgICAgICAgb2JqLmNvbmZpZ3VyZS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB0aGlzKTsKICB9LAoKICBzZXRFbGVtZW50IDogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS5zZXRFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLm5hbWUgJiYgdGhpcy4kZWwuYXR0cih2aWV3TmFtZUF0dHJpYnV0ZU5hbWUsIHRoaXMubmFtZSk7CiAgICB0aGlzLiRlbC5hdHRyKHZpZXdDaWRBdHRyaWJ1dGVOYW1lLCB0aGlzLmNpZCk7CiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKCiAgX2FkZENoaWxkOiBmdW5jdGlvbih2aWV3KSB7CiAgICB0aGlzLmNoaWxkcmVuW3ZpZXcuY2lkXSA9IHZpZXc7CiAgICBpZiAoIXZpZXcucGFyZW50KSB7CiAgICAgIHZpZXcucGFyZW50ID0gdGhpczsKICAgIH0KICAgIHRoaXMudHJpZ2dlcignY2hpbGQnLCB2aWV3KTsKICAgIHJldHVybiB2aWV3OwogIH0sCgogIF9yZW1vdmVDaGlsZDogZnVuY3Rpb24odmlldykgewogICAgZGVsZXRlIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdOwogICAgdmlldy5wYXJlbnQgPSBudWxsOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMob3B0aW9ucyB8fCB7fSwgewogICAgICBjaGlsZHJlbjogdHJ1ZQogICAgfSk7CiAgICBfLmVhY2godGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkLCB0aGlzLnVuYmluZERhdGFPYmplY3QsIHRoaXMpOwogICAgdGhpcy50cmlnZ2VyKCdkZXN0cm95ZWQnKTsKICAgIGRlbGV0ZSB2aWV3c0luZGV4ZWRCeUNpZFt0aGlzLmNpZF07CiAgICBfLmVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgdGhpcy5fcmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICBpZiAob3B0aW9ucy5jaGlsZHJlbikgewogICAgICAgIGNoaWxkLmRlc3Ryb3koKTsKICAgICAgfQogICAgfSwgdGhpcyk7CiAgICBpZiAodGhpcy5wYXJlbnQpIHsKICAgICAgdGhpcy5wYXJlbnQuX3JlbW92ZUNoaWxkKHRoaXMpOwogICAgfQogICAgdGhpcy5yZW1vdmUoKTsgLy8gV2lsbCBjYWxsIHN0b3BMaXN0ZW5pbmcoKQogIH0sCgogIHJlbmRlcjogZnVuY3Rpb24ob3V0cHV0KSB7CiAgICB0aGlzLl9wcmV2aW91c0hlbHBlcnMgPSBfLmZpbHRlcih0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgeyByZXR1cm4gY2hpbGQuX2hlbHBlck9wdGlvbnM7IH0pOwoKICAgIHZhciBjaGlsZHJlbiA9IHt9OwogICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkLCBrZXkpIHsKICAgICAgaWYgKCFjaGlsZC5faGVscGVyT3B0aW9ucykgewogICAgICAgIGNoaWxkcmVuW2tleV0gPSBjaGlsZDsKICAgICAgfQogICAgfSk7CiAgICB0aGlzLmNoaWxkcmVuID0gY2hpbGRyZW47CgogICAgaWYgKF8uaXNVbmRlZmluZWQob3V0cHV0KSB8fCAoIV8uaXNFbGVtZW50KG91dHB1dCkgJiYgIVRob3JheC5VdGlsLmlzJChvdXRwdXQpICYmICEob3V0cHV0ICYmIG91dHB1dC5lbCkgJiYgIV8uaXNTdHJpbmcob3V0cHV0KSAmJiAhXy5pc0Z1bmN0aW9uKG91dHB1dCkpKSB7CiAgICAgIC8vIHRyeSBvbmUgbW9yZSB0aW1lIHRvIGFzc2lnbiB0aGUgdGVtcGxhdGUsIGlmIHdlIGRvbid0CiAgICAgIC8vIHlldCBoYXZlIG9uZSB3ZSBtdXN0IHJhaXNlCiAgICAgIGFzc2lnblRlbXBsYXRlLmNhbGwodGhpcywgJ3RlbXBsYXRlJywgewogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgIH0pOwogICAgICBvdXRwdXQgPSB0aGlzLnJlbmRlclRlbXBsYXRlKHRoaXMudGVtcGxhdGUpOwogICAgfSBlbHNlIGlmIChfLmlzRnVuY3Rpb24ob3V0cHV0KSkgewogICAgICBvdXRwdXQgPSB0aGlzLnJlbmRlclRlbXBsYXRlKG91dHB1dCk7CiAgICB9CgogICAgLy8gRGVzdHJveSBhbnkgaGVscGVycyB0aGF0IG1heSBiZSBsaW5nZXJpbmcKICAgIF8uZWFjaCh0aGlzLl9wcmV2aW91c0hlbHBlcnMsIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgIGNoaWxkLmRlc3Ryb3koKTsKICAgICAgY2hpbGQucGFyZW50ID0gdW5kZWZpbmVkOwogICAgfSk7CiAgICB0aGlzLl9wcmV2aW91c0hlbHBlcnMgPSB1bmRlZmluZWQ7CgogICAgLy9hY2NlcHQgYSB2aWV3LCBzdHJpbmcsIEhhbmRsZWJhcnMuU2FmZVN0cmluZyBvciBET00gZWxlbWVudAogICAgdGhpcy5odG1sKChvdXRwdXQgJiYgb3V0cHV0LmVsKSB8fCAob3V0cHV0ICYmIG91dHB1dC5zdHJpbmcpIHx8IG91dHB1dCk7CiAgICArK3RoaXMuX3JlbmRlckNvdW50OwogICAgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZCcpOwogICAgcmV0dXJuIG91dHB1dDsKICB9LAoKICBjb250ZXh0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLmV4dGVuZCh7fSwgKHRoaXMubW9kZWwgJiYgdGhpcy5tb2RlbC5hdHRyaWJ1dGVzKSB8fCB7fSk7CiAgfSwKCiAgX2dldENvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCB0aGlzLCBnZXRWYWx1ZSh0aGlzLCAnY29udGV4dCcpIHx8IHt9KTsKICB9LAoKICAvLyBQcml2YXRlIHZhcmlhYmxlcyBpbiBoYW5kbGViYXJzIC8gb3B0aW9ucy5kYXRhIGluIHRlbXBsYXRlIGhlbHBlcnMKICBfZ2V0RGF0YTogZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuIHsKICAgICAgdmlldzogdGhpcywKICAgICAgY2lkOiBfLnVuaXF1ZUlkKCd0JyksCiAgICAgIHlpZWxkOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBmbiBpcyBzZWVkZWQgYnkgdGVtcGxhdGUgaGVscGVyIHBhc3NpbmcgY29udGV4dCB0byBkYXRhCiAgICAgICAgcmV0dXJuIGRhdGEuZm4gJiYgZGF0YS5mbihkYXRhKTsKICAgICAgfQogICAgfTsKICB9LAoKICBfZ2V0SGVscGVyczogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5oZWxwZXJzKSB7CiAgICAgIHJldHVybiBfLmV4dGVuZCh7fSwgSGFuZGxlYmFycy5oZWxwZXJzLCB0aGlzLmhlbHBlcnMpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIEhhbmRsZWJhcnMuaGVscGVyczsKICAgIH0KCiAgfSwKCiAgcmVuZGVyVGVtcGxhdGU6IGZ1bmN0aW9uKGZpbGUsIGNvbnRleHQsIGlnbm9yZUVycm9ycykgewogICAgdmFyIHRlbXBsYXRlOwogICAgY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwogICAgaWYgKF8uaXNGdW5jdGlvbihmaWxlKSkgewogICAgICB0ZW1wbGF0ZSA9IGZpbGU7CiAgICB9IGVsc2UgewogICAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKGZpbGUsIGlnbm9yZUVycm9ycyk7CiAgICB9CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIHJldHVybiAnJzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0ZW1wbGF0ZShjb250ZXh0LCB7CiAgICAgICAgaGVscGVyczogdGhpcy5fZ2V0SGVscGVycygpLAogICAgICAgIGRhdGE6IHRoaXMuX2dldERhdGEoY29udGV4dCkKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgZW5zdXJlUmVuZGVyZWQ6IGZ1bmN0aW9uKCkgewogICAgIXRoaXMuX3JlbmRlckNvdW50ICYmIHRoaXMucmVuZGVyKCk7CiAgfSwKCiAgYXBwZW5kVG86IGZ1bmN0aW9uKGVsKSB7CiAgICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7CiAgICAkKGVsKS5hcHBlbmQodGhpcy5lbCk7CiAgICB0aGlzLnRyaWdnZXIoJ3JlYWR5Jywge3RhcmdldDogdGhpc30pOwogIH0sCgogIGh0bWw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIGlmIChfLmlzVW5kZWZpbmVkKGh0bWwpKSB7CiAgICAgIHJldHVybiB0aGlzLmVsLmlubmVySFRNTDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEV2ZW50IGZvciBJRSBlbGVtZW50IGZpeGVzCiAgICAgIHRoaXMudHJpZ2dlcignYmVmb3JlOmFwcGVuZCcpOwogICAgICB2YXIgZWxlbWVudCA9IHRoaXMuX3JlcGxhY2VIVE1MKGh0bWwpOwogICAgICB0aGlzLnRyaWdnZXIoJ2FwcGVuZCcpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0KICB9LAoKICBfcmVwbGFjZUhUTUw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIHRoaXMuZWwuaW5uZXJIVE1MID0gIiI7CiAgICByZXR1cm4gdGhpcy4kZWwuYXBwZW5kKGh0bWwpOwogIH0sCgogIF9hbmNob3JDbGljazogZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciB0YXJnZXQgPSAkKGV2ZW50LmN1cnJlbnRUYXJnZXQpLAogICAgICAgIGhyZWYgPSB0YXJnZXQuYXR0cignaHJlZicpOwogICAgLy8gUm91dGUgYW55dGhpbmcgdGhhdCBzdGFydHMgd2l0aCAjIG9yIC8gKGV4Y2x1ZGluZyAvL2RvbWFpbiB1cmxzKQogICAgaWYgKGhyZWYgJiYgKGhyZWZbMF0gPT09ICcjJyB8fCAoaHJlZlswXSA9PT0gJy8nICYmIGhyZWZbMV0gIT09ICcvJykpKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoaHJlZiwgewogICAgICAgIHRyaWdnZXI6IHRydWUKICAgICAgfSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KfSk7CgpUaG9yYXguVmlldy5leHRlbmQgPSBmdW5jdGlvbigpIHsKICBjcmVhdGVJbmhlcml0VmFycyh0aGlzKTsKCiAgdmFyIGNoaWxkID0gQmFja2JvbmUuVmlldy5leHRlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBjaGlsZC5fX3BhcmVudF9fID0gdGhpczsKCiAgcmVzZXRJbmhlcml0VmFycyhjaGlsZCk7CgogIHJldHVybiBjaGlsZDsKfTsKCmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguVmlldywgVGhvcmF4LlZpZXdzKTsKCmZ1bmN0aW9uIGJpbmRIZWxwZXJzKCkgewogIGlmICh0aGlzLmhlbHBlcnMpIHsKICAgIF8uZWFjaCh0aGlzLmhlbHBlcnMsIGZ1bmN0aW9uKGhlbHBlciwgbmFtZSkgewogICAgICB2YXIgdmlldyA9IHRoaXM7CiAgICAgIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgIG9wdGlvbnMgPSBfLmxhc3QoYXJncyk7CiAgICAgICAgb3B0aW9ucy5jb250ZXh0ID0gdGhpczsKICAgICAgICByZXR1cm4gaGVscGVyLmFwcGx5KHZpZXcsIGFyZ3MpOwogICAgICB9OwogICAgfSwgdGhpcyk7CiAgfQp9CgovLyQoc2VsZWN0b3IpLnZpZXcoKSBoZWxwZXIKJC5mbi52aWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHsKICAgIGhlbHBlcjogdHJ1ZQogIH0pOwogIHZhciBzZWxlY3RvciA9ICdbJyArIHZpZXdDaWRBdHRyaWJ1dGVOYW1lICsgJ10nOwogIGlmICghb3B0aW9ucy5oZWxwZXIpIHsKICAgIHNlbGVjdG9yICs9ICc6bm90KFsnICsgdmlld0hlbHBlckF0dHJpYnV0ZU5hbWUgKyAnXSknOwogIH0KICB2YXIgZWwgPSAkKHRoaXMpLmNsb3Nlc3Qoc2VsZWN0b3IpOwogIHJldHVybiAoZWwgJiYgdmlld3NJbmRleGVkQnlDaWRbZWwuYXR0cih2aWV3Q2lkQXR0cmlidXRlTmFtZSldKSB8fCBmYWxzZTsKfTsKCjs7Ci8qZ2xvYmFsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcjp0cnVlLCBjbG9uZUV2ZW50czogdHJ1ZSAqLwpmdW5jdGlvbiBjcmVhdGVSZWdpc3RyeVdyYXBwZXIoa2xhc3MsIGhhc2gpIHsKICB2YXIgJHN1cGVyID0ga2xhc3MuZXh0ZW5kOwogIGtsYXNzLmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGNoaWxkID0gJHN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAoY2hpbGQucHJvdG90eXBlLm5hbWUpIHsKICAgICAgaGFzaFtjaGlsZC5wcm90b3R5cGUubmFtZV0gPSBjaGlsZDsKICAgIH0KICAgIHJldHVybiBjaGlsZDsKICB9Owp9CgpmdW5jdGlvbiByZWdpc3RyeUdldChvYmplY3QsIHR5cGUsIG5hbWUsIGlnbm9yZUVycm9ycykgewogIHZhciB0YXJnZXQgPSBvYmplY3RbdHlwZV0sCiAgICAgIHZhbHVlOwogIGlmIChuYW1lLmluZGV4T2YoJy4nKSA+PSAwKSB7CiAgICB2YXIgYml0cyA9IG5hbWUuc3BsaXQoL1wuLyk7CiAgICBuYW1lID0gYml0cy5wb3AoKTsKICAgIF8uZWFjaChiaXRzLCBmdW5jdGlvbihrZXkpIHsKICAgICAgdGFyZ2V0ID0gdGFyZ2V0W2tleV07CiAgICB9KTsKICB9CiAgdGFyZ2V0ICYmICh2YWx1ZSA9IHRhcmdldFtuYW1lXSk7CiAgaWYgKCF2YWx1ZSAmJiAhaWdub3JlRXJyb3JzKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IodHlwZSArICc6ICcgKyBuYW1lICsgJyBkb2VzIG5vdCBleGlzdC4nKTsKICB9IGVsc2UgewogICAgcmV0dXJuIHZhbHVlOwogIH0KfQoKZnVuY3Rpb24gYXNzaWduVGVtcGxhdGUoYXR0cmlidXRlTmFtZSwgb3B0aW9ucykgewogIHZhciB0ZW1wbGF0ZTsKICAvLyBpZiBhdHRyaWJ1dGUgaXMgdGhlIG5hbWUgb2YgdGVtcGxhdGUgdG8gZmV0Y2gKICBpZiAoXy5pc1N0cmluZyh0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzW2F0dHJpYnV0ZU5hbWVdLCB0cnVlKTsKICAvLyBlbHNlIHRyeSBhbmQgZmV0Y2ggdGhlIHRlbXBsYXRlIGJhc2VkIG9uIHRoZSBuYW1lCiAgfSBlbHNlIGlmICh0aGlzLm5hbWUgJiYgIV8uaXNGdW5jdGlvbih0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLm5hbWUgKyAob3B0aW9ucy5leHRlbnNpb24gfHwgJycpLCB0cnVlKTsKICB9CiAgLy8gQ29sbGVjdGlvblZpZXcgYW5kIExheW91dFZpZXcgaGF2ZSBhIGRlZmF1bHRUZW1wbGF0ZSB0aGF0IG1heSBiZSB1c2VkIGlmIG5vbmUKICAvLyB3YXMgZm91bmQsIHJlZ3VsYXIgdmlld3MgbXVzdCBoYXZlIGEgdGVtcGxhdGUgaWYgcmVuZGVyKCkgaXMgY2FsbGVkCiAgaWYgKCF0ZW1wbGF0ZSAmJiBhdHRyaWJ1dGVOYW1lID09PSAndGVtcGxhdGUnICYmIHRoaXMuX2RlZmF1bHRUZW1wbGF0ZSkgewogICAgdGVtcGxhdGUgPSB0aGlzLl9kZWZhdWx0VGVtcGxhdGU7CiAgfQogIC8vIGlmIHdlIGZvdW5kIHNvbWV0aGluZywgYXNzaWduIGl0CiAgaWYgKHRlbXBsYXRlICYmICFfLmlzRnVuY3Rpb24odGhpc1thdHRyaWJ1dGVOYW1lXSkpIHsKICAgIHRoaXNbYXR0cmlidXRlTmFtZV0gPSB0ZW1wbGF0ZTsKICB9CiAgLy8gaWYgbm90aGluZyB3YXMgZm91bmQgYW5kIGl0J3MgcmVxdWlyZWQsIHRocm93CiAgaWYgKG9wdGlvbnMucmVxdWlyZWQgJiYgIV8uaXNGdW5jdGlvbih0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdWaWV3ICcgKyAodGhpcy5uYW1lIHx8IHRoaXMuY2lkKSArICcgcmVxdWlyZXM6ICcgKyBhdHRyaWJ1dGVOYW1lKTsKICB9Cn0KCi8vIGdldFZhbHVlIGlzIHVzZWQgaW5zdGVhZCBvZiBfLnJlc3VsdCBiZWNhdXNlIHdlCi8vIG5lZWQgYW4gZXh0cmEgc2NvcGUgcGFyYW1ldGVyLCBhbmQgd2lsbCBtaW5pZnkKLy8gYmV0dGVyIHRoYW4gXy5yZXN1bHQKZnVuY3Rpb24gZ2V0VmFsdWUob2JqZWN0LCBwcm9wLCBzY29wZSkgewogIGlmICghKG9iamVjdCAmJiBvYmplY3RbcHJvcF0pKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIF8uaXNGdW5jdGlvbihvYmplY3RbcHJvcF0pCiAgICA/IG9iamVjdFtwcm9wXS5jYWxsKHNjb3BlIHx8IG9iamVjdCkKICAgIDogb2JqZWN0W3Byb3BdOwp9Cgp2YXIgaW5oZXJpdFZhcnMgPSB7fTsKZnVuY3Rpb24gY3JlYXRlSW5oZXJpdFZhcnMoc2VsZikgewogIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgb3VyIHN0YXRpYyBldmVudCBvYmplY3RzCiAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgIGlmICghc2VsZltvYmoubmFtZV0pIHsKICAgICAgc2VsZltvYmoubmFtZV0gPSBbXTsKICAgIH0KICB9KTsKfQpmdW5jdGlvbiByZXNldEluaGVyaXRWYXJzKHNlbGYpIHsKICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIG91ciBzdGF0aWMgZXZlbnQgb2JqZWN0cwogIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICBzZWxmW29iai5uYW1lXSA9IFtdOwogIH0pOwp9CmZ1bmN0aW9uIHdhbGtJbmhlcml0VHJlZShzb3VyY2UsIGZpZWxkTmFtZSwgaXNTdGF0aWMsIGNhbGxiYWNrKSB7CiAgdmFyIHRyZWUgPSBbXTsKICBpZiAoXy5oYXMoc291cmNlLCBmaWVsZE5hbWUpKSB7CiAgICB0cmVlLnB1c2goc291cmNlKTsKICB9CiAgdmFyIGl0ZXJhdGUgPSBzb3VyY2U7CiAgaWYgKGlzU3RhdGljKSB7CiAgICB3aGlsZSAoaXRlcmF0ZSA9IGl0ZXJhdGUuX19wYXJlbnRfXykgewogICAgICBpZiAoXy5oYXMoaXRlcmF0ZSwgZmllbGROYW1lKSkgewogICAgICAgIHRyZWUucHVzaChpdGVyYXRlKTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBpdGVyYXRlID0gaXRlcmF0ZS5jb25zdHJ1Y3RvcjsKICAgIHdoaWxlIChpdGVyYXRlKSB7CiAgICAgIGlmIChpdGVyYXRlLnByb3RvdHlwZSAmJiBfLmhhcyhpdGVyYXRlLnByb3RvdHlwZSwgZmllbGROYW1lKSkgewogICAgICAgIHRyZWUucHVzaChpdGVyYXRlLnByb3RvdHlwZSk7CiAgICAgIH0KICAgICAgaXRlcmF0ZSA9IGl0ZXJhdGUuX19zdXBlcl9fICYmIGl0ZXJhdGUuX19zdXBlcl9fLmNvbnN0cnVjdG9yOwogICAgfQogIH0KCiAgdmFyIGkgPSB0cmVlLmxlbmd0aDsKICB3aGlsZSAoaS0tKSB7CiAgICBfLmVhY2goZ2V0VmFsdWUodHJlZVtpXSwgZmllbGROYW1lLCBzb3VyY2UpLCBjYWxsYmFjayk7CiAgfQp9CgpmdW5jdGlvbiBvYmplY3RFdmVudHModGFyZ2V0LCBldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgaWYgKF8uaXNPYmplY3QoY2FsbGJhY2spKSB7CiAgICB2YXIgc3BlYyA9IGluaGVyaXRWYXJzW2V2ZW50TmFtZV07CiAgICBpZiAoc3BlYyAmJiBzcGVjLmV2ZW50KSB7CiAgICAgIGFkZEV2ZW50cyh0YXJnZXRbJ18nICsgZXZlbnROYW1lICsgJ0V2ZW50cyddLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfQpmdW5jdGlvbiBhZGRFdmVudHModGFyZ2V0LCBzb3VyY2UsIGNvbnRleHQpIHsKICBfLmVhY2goc291cmNlLCBmdW5jdGlvbihjYWxsYmFjaywgZXZlbnROYW1lKSB7CiAgICBpZiAoXy5pc0FycmF5KGNhbGxiYWNrKSkgewogICAgICBfLmVhY2goY2FsbGJhY2ssIGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgdGFyZ2V0LnB1c2goW2V2ZW50TmFtZSwgY2IsIGNvbnRleHRdKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB0YXJnZXQucHVzaChbZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dF0pOwogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBnZXRPcHRpb25zRGF0YShvcHRpb25zKSB7CiAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLmRhdGEpIHsKICAgIHRocm93IG5ldyBFcnJvcignSGFuZGxlYmFycyB0ZW1wbGF0ZSBjb21waWxlZCB3aXRob3V0IGRhdGEsIHVzZTogSGFuZGxlYmFycy5jb21waWxlKHRlbXBsYXRlLCB7ZGF0YTogdHJ1ZX0pJyk7CiAgfQogIHJldHVybiBvcHRpb25zLmRhdGE7Cn0KCi8vIFRoZXNlIHdoaXRlbGlzdGVkIGF0dHJpYnV0ZXMgd2lsbCBiZSB0aGUgb25seSBvbmVzIHBhc3NlZAovLyBmcm9tIHRoZSBvcHRpb25zIGhhc2ggdG8gVGhvcmF4LlV0aWwudGFnCnZhciBodG1sQXR0cmlidXRlc1RvQ29weSA9IFsnaWQnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnXTsKCi8vIEluIGhlbHBlcnMgInRhZ05hbWUiIG9yICJ0YWciIG1heSBiZSBzcGVjaWZpZWQsIGFzIHdlbGwKLy8gYXMgImNsYXNzIiBvciAiY2xhc3NOYW1lIi4gTm9ybWFsaXplIHRvICJ0YWdOYW1lIiBhbmQKLy8gImNsYXNzTmFtZSIgdG8gbWF0Y2ggdGhlIHByb3BlcnR5IG5hbWVzIHVzZWQgYnkgQmFja2JvbmUKLy8galF1ZXJ5LCBldGMuIFNwZWNpYWwgY2FzZSBmb3IgImNsYXNzTmFtZSIgaW4KLy8gVGhvcmF4LlV0aWwudGFnOiB3aWxsIGJlIHJld3JpdHRlbiBhcyAiY2xhc3MiIGluCi8vIGdlbmVyYXRlZCBIVE1MLgpmdW5jdGlvbiBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhvcHRpb25zKSB7CiAgaWYgKG9wdGlvbnMudGFnKSB7CiAgICBvcHRpb25zLnRhZ05hbWUgPSBvcHRpb25zLnRhZzsKICAgIGRlbGV0ZSBvcHRpb25zLnRhZzsKICB9CiAgaWYgKG9wdGlvbnNbJ2NsYXNzJ10pIHsKICAgIG9wdGlvbnMuY2xhc3NOYW1lID0gb3B0aW9uc1snY2xhc3MnXTsKICAgIGRlbGV0ZSBvcHRpb25zWydjbGFzcyddOwogIH0KfQoKVGhvcmF4LlV0aWwgPSB7CiAgZ2V0Vmlld0luc3RhbmNlOiBmdW5jdGlvbihuYW1lLCBhdHRyaWJ1dGVzKSB7CiAgICBhdHRyaWJ1dGVzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIGlmIChfLmlzU3RyaW5nKG5hbWUpKSB7CiAgICAgIHZhciBLbGFzcyA9IHJlZ2lzdHJ5R2V0KFRob3JheCwgJ1ZpZXdzJywgbmFtZSwgZmFsc2UpOwogICAgICByZXR1cm4gS2xhc3MuY2lkID8gXy5leHRlbmQoS2xhc3MsIGF0dHJpYnV0ZXMgfHwge30pIDogbmV3IEtsYXNzKGF0dHJpYnV0ZXMpOwogICAgfSBlbHNlIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgcmV0dXJuIG5ldyBuYW1lKGF0dHJpYnV0ZXMpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgfSwKCiAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uKGZpbGUsIGlnbm9yZUVycm9ycykgewogICAgLy9hcHBlbmQgdGhlIHRlbXBsYXRlIHBhdGggcHJlZml4IGlmIGl0IGlzIG1pc3NpbmcKICAgIHZhciBwYXRoUHJlZml4ID0gVGhvcmF4LnRlbXBsYXRlUGF0aFByZWZpeCwKICAgICAgICB0ZW1wbGF0ZTsKICAgIGlmIChwYXRoUHJlZml4ICYmIGZpbGUuc3Vic3RyKDAsIHBhdGhQcmVmaXgubGVuZ3RoKSAhPT0gcGF0aFByZWZpeCkgewogICAgICBmaWxlID0gcGF0aFByZWZpeCArIGZpbGU7CiAgICB9CgogICAgLy8gV2l0aG91dCBleHRlbnNpb24KICAgIGZpbGUgPSBmaWxlLnJlcGxhY2UoL1wuaGFuZGxlYmFycyQvLCAnJyk7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC50ZW1wbGF0ZXNbZmlsZV07CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIC8vIFdpdGggZXh0ZW5zaW9uCiAgICAgIGZpbGUgPSBmaWxlICsgJy5oYW5kbGViYXJzJzsKICAgICAgdGVtcGxhdGUgPSBUaG9yYXgudGVtcGxhdGVzW2ZpbGVdOwogICAgfQoKICAgIGlmICghdGVtcGxhdGUgJiYgIWlnbm9yZUVycm9ycykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3RlbXBsYXRlczogJyArIGZpbGUgKyAnIGRvZXMgbm90IGV4aXN0LicpOwogICAgfQogICAgcmV0dXJuIHRlbXBsYXRlOwogIH0sCgogIC8vJ3NlbGVjdG9yJyBpcyBub3QgcHJlc2VudCBpbiAkKCc8cD48L3A+JykKICAvL1RPRE86IGludmVzdGlnYWdlIGEgYmV0dGVyIGRldGVjdGlvbiBtZXRob2QKICBpcyQ6IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIF8uaXNPYmplY3Qob2JqKSAmJiAoJ2xlbmd0aCcgaW4gb2JqKTsKICB9LAogIGV4cGFuZFRva2VuOiBmdW5jdGlvbihpbnB1dCwgc2NvcGUpIHsKICAgIGlmIChpbnB1dCAmJiBpbnB1dC5pbmRleE9mICYmIGlucHV0LmluZGV4T2YoJ3t7JykgPj0gMCkgewogICAgICB2YXIgcmUgPSAvKD86XHs/W157XSspfCg/Olx7XHsoW159XSspXH1cfSkvZywKICAgICAgICAgIG1hdGNoLAogICAgICAgICAgcmV0ID0gW107CiAgICAgIGZ1bmN0aW9uIGRlcmVmKHRva2VuLCBzY29wZSkgewogICAgICAgIGlmICh0b2tlbi5tYXRjaCgvXigifCcpLykgJiYgdG9rZW4ubWF0Y2goLygifCcpJC8pKSB7CiAgICAgICAgICByZXR1cm4gdG9rZW4ucmVwbGFjZSgvKF4oInwnKXwoJ3wiKSQpL2csICcnKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNlZ21lbnRzID0gdG9rZW4uc3BsaXQoJy4nKSwKICAgICAgICAgICAgbGVuID0gc2VnbWVudHMubGVuZ3RoOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBzY29wZSAmJiBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGlmIChzZWdtZW50c1tpXSAhPT0gJ3RoaXMnKSB7CiAgICAgICAgICAgIHNjb3BlID0gc2NvcGVbc2VnbWVudHNbaV1dOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2NvcGU7CiAgICAgIH0KICAgICAgd2hpbGUgKG1hdGNoID0gcmUuZXhlYyhpbnB1dCkpIHsKICAgICAgICBpZiAobWF0Y2hbMV0pIHsKICAgICAgICAgIHZhciBwYXJhbXMgPSBtYXRjaFsxXS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICBpZiAocGFyYW1zLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGhlbHBlciA9IHBhcmFtcy5zaGlmdCgpOwogICAgICAgICAgICBwYXJhbXMgPSBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtKSB7IHJldHVybiBkZXJlZihwYXJhbSwgc2NvcGUpOyB9KTsKICAgICAgICAgICAgaWYgKEhhbmRsZWJhcnMuaGVscGVyc1toZWxwZXJdKSB7CiAgICAgICAgICAgICAgcmV0LnB1c2goSGFuZGxlYmFycy5oZWxwZXJzW2hlbHBlcl0uYXBwbHkoc2NvcGUsIHBhcmFtcykpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIElmIHRoZSBoZWxwZXIgaXMgbm90IGRlZmluZWQgZG8gbm90aGluZwogICAgICAgICAgICAgIHJldC5wdXNoKG1hdGNoWzBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0LnB1c2goZGVyZWYocGFyYW1zWzBdLCBzY29wZSkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXQucHVzaChtYXRjaFswXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlucHV0ID0gcmV0LmpvaW4oJycpOwogICAgfQogICAgcmV0dXJuIGlucHV0OwogIH0sCiAgdGFnOiBmdW5jdGlvbihhdHRyaWJ1dGVzLCBjb250ZW50LCBzY29wZSkgewogICAgdmFyIGh0bWxBdHRyaWJ1dGVzID0gXy5vbWl0KGF0dHJpYnV0ZXMsICd0YWdOYW1lJyksCiAgICAgICAgdGFnID0gYXR0cmlidXRlcy50YWdOYW1lIHx8ICdkaXYnOwogICAgcmV0dXJuICc8JyArIHRhZyArICcgJyArIF8ubWFwKGh0bWxBdHRyaWJ1dGVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgIGlmIChfLmlzVW5kZWZpbmVkKHZhbHVlKSB8fCBrZXkgPT09ICdleHBhbmQtdG9rZW5zJykgewogICAgICAgIHJldHVybiAnJzsKICAgICAgfQogICAgICB2YXIgZm9ybWF0dGVkVmFsdWUgPSB2YWx1ZTsKICAgICAgaWYgKHNjb3BlKSB7CiAgICAgICAgZm9ybWF0dGVkVmFsdWUgPSBUaG9yYXguVXRpbC5leHBhbmRUb2tlbih2YWx1ZSwgc2NvcGUpOwogICAgICB9CiAgICAgIHJldHVybiAoa2V5ID09PSAnY2xhc3NOYW1lJyA/ICdjbGFzcycgOiBrZXkpICsgJz0iJyArIEhhbmRsZWJhcnMuVXRpbHMuZXNjYXBlRXhwcmVzc2lvbihmb3JtYXR0ZWRWYWx1ZSkgKyAnIic7CiAgICB9KS5qb2luKCcgJykgKyAnPicgKyAoXy5pc1VuZGVmaW5lZChjb250ZW50KSA/ICcnIDogY29udGVudCkgKyAnPC8nICsgdGFnICsgJz4nOwogIH0KfTsKCjs7Ci8qZ2xvYmFsIGNyZWF0ZUluaGVyaXRWYXJzLCBpbmhlcml0VmFycyAqLwpUaG9yYXguTWl4aW5zID0ge307Cgppbmhlcml0VmFycy5taXhpbnMgPSB7CiAgbmFtZTogJ21peGlucycsCiAgY29uZmlndXJlOiBmdW5jdGlvbigpIHsKICAgIF8uZWFjaCh0aGlzLmNvbnN0cnVjdG9yLm1peGlucywgdGhpcy5taXhpbiwgdGhpcyk7CiAgICBfLmVhY2godGhpcy5taXhpbnMsIHRoaXMubWl4aW4sIHRoaXMpOwogIH0KfTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LCB7CiAgbWl4aW46IGZ1bmN0aW9uKG1peGluKSB7CiAgICBjcmVhdGVJbmhlcml0VmFycyh0aGlzKTsKICAgIHRoaXMubWl4aW5zLnB1c2gobWl4aW4pOwogIH0sCiAgcmVnaXN0ZXJNaXhpbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIG1ldGhvZHMpIHsKICAgIFRob3JheC5NaXhpbnNbbmFtZV0gPSBbY2FsbGJhY2ssIG1ldGhvZHNdOwogIH0KfSk7CgpUaG9yYXguVmlldy5wcm90b3R5cGUubWl4aW4gPSBmdW5jdGlvbihuYW1lKSB7CiAgaWYgKCF0aGlzLl9hcHBsaWVkTWl4aW5zKSB7CiAgICB0aGlzLl9hcHBsaWVkTWl4aW5zID0gW107CiAgfQogIGlmICh0aGlzLl9hcHBsaWVkTWl4aW5zLmluZGV4T2YobmFtZSkgPT09IC0xKSB7CiAgICB0aGlzLl9hcHBsaWVkTWl4aW5zLnB1c2gobmFtZSk7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKG5hbWUpKSB7CiAgICAgIG5hbWUuY2FsbCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBtaXhpbiA9IFRob3JheC5NaXhpbnNbbmFtZV07CiAgICAgIF8uZXh0ZW5kKHRoaXMsIG1peGluWzFdKTsKICAgICAgLy9taXhpbiBjYWxsYmFjayBtYXkgYmUgYW4gYXJyYXkgb2YgW2NhbGxiYWNrLCBhcmd1bWVudHNdCiAgICAgIGlmIChfLmlzQXJyYXkobWl4aW5bMF0pKSB7CiAgICAgICAgbWl4aW5bMF1bMF0uYXBwbHkodGhpcywgbWl4aW5bMF1bMV0pOwogICAgICB9IGVsc2UgewogICAgICAgIG1peGluWzBdLmFwcGx5KHRoaXMsIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpKTsKICAgICAgfQogICAgfQogIH0KfTsKCjs7Ci8qZ2xvYmFsIGNyZWF0ZUluaGVyaXRWYXJzLCBpbmhlcml0VmFycywgb2JqZWN0RXZlbnRzLCB3YWxrSW5oZXJpdFRyZWUgKi8KLy8gU2F2ZSBhIGNvcHkgb2YgdGhlIF9vbiBtZXRob2QgdG8gY2FsbCBhcyBhICRzdXBlciBtZXRob2QKdmFyIF9vbiA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5vbjsKCmluaGVyaXRWYXJzLmV2ZW50ID0gewogIG5hbWU6ICdfZXZlbnRzJywKCiAgY29uZmlndXJlOiBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHdhbGtJbmhlcml0VHJlZSh0aGlzLmNvbnN0cnVjdG9yLCAnX2V2ZW50cycsIHRydWUsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHNlbGYub24uYXBwbHkoc2VsZiwgZXZlbnQpOwogICAgfSk7CiAgICB3YWxrSW5oZXJpdFRyZWUodGhpcywgJ2V2ZW50cycsIGZhbHNlLCBmdW5jdGlvbihoYW5kbGVyLCBldmVudE5hbWUpIHsKICAgICAgc2VsZi5vbihldmVudE5hbWUsIGhhbmRsZXIsIHNlbGYpOwogICAgfSk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcsIHsKICBvbjogZnVuY3Rpb24oZXZlbnROYW1lLCBjYWxsYmFjaykgewogICAgY3JlYXRlSW5oZXJpdFZhcnModGhpcyk7CgogICAgaWYgKG9iamVjdEV2ZW50cyh0aGlzLCBldmVudE5hbWUsIGNhbGxiYWNrKSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvL2FjY2VwdCBvbih7InJlbmRlcmVkIjogaGFuZGxlcn0pCiAgICBpZiAoXy5pc09iamVjdChldmVudE5hbWUpKSB7CiAgICAgIF8uZWFjaChldmVudE5hbWUsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICB0aGlzLm9uKGtleSwgdmFsdWUpOwogICAgICB9LCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vYWNjZXB0IG9uKHsicmVuZGVyZWQiOiBbaGFuZGxlciwgaGFuZGxlcl19KQogICAgICBpZiAoXy5pc0FycmF5KGNhbGxiYWNrKSkgewogICAgICAgIF8uZWFjaChjYWxsYmFjaywgZnVuY3Rpb24oY2IpIHsKICAgICAgICAgIHRoaXMuX2V2ZW50cy5wdXNoKFtldmVudE5hbWUsIGNiXSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIC8vYWNjZXB0IG9uKCJyZW5kZXJlZCIsIGhhbmRsZXIpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goW2V2ZW50TmFtZSwgY2FsbGJhY2tdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9KTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIG9uOiBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICBpZiAob2JqZWN0RXZlbnRzKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGlmIChfLmlzT2JqZWN0KGV2ZW50TmFtZSkgJiYgYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKICAgICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IGNhbGxiYWNrfSkKICAgICAgXy5lYWNoKGV2ZW50TmFtZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHRoaXMub24oa2V5LCB2YWx1ZSwgY2FsbGJhY2sgfHwgdGhpcyk7ICAgIC8vIGNhbGxiYWNrIGlzIGNvbnRleHQgaW4gdGhpcyBmb3JtIG9mIHRoZSBjYWxsCiAgICAgIH0sIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy9hY2NlcHQgb24oInJlbmRlcmVkIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIC8vYWNjZXB0IG9uKCJjbGljayBhIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIF8uZWFjaCgoXy5pc0FycmF5KGNhbGxiYWNrKSA/IGNhbGxiYWNrIDogW2NhbGxiYWNrXSksIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IGV2ZW50UGFyYW1zRnJvbUV2ZW50SXRlbS5jYWxsKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQgfHwgdGhpcyk7CiAgICAgICAgaWYgKHBhcmFtcy50eXBlID09PSAnRE9NJykgewogICAgICAgICAgLy93aWxsIGNhbGwgX2FkZEV2ZW50IGR1cmluZyBkZWxlZ2F0ZUV2ZW50cygpCiAgICAgICAgICBpZiAoIXRoaXMuX2V2ZW50c1RvRGVsZWdhdGUpIHsKICAgICAgICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZS5wdXNoKHBhcmFtcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX2FkZEV2ZW50KHBhcmFtcyk7CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCiAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICBpZiAoZXZlbnRzKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oZXZlbnRzKSkgewogICAgICAgIGV2ZW50cyA9IGV2ZW50cy5jYWxsKHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMuX2V2ZW50c1RvRGVsZWdhdGUgPSBbXTsKICAgICAgdGhpcy5vbihldmVudHMpOwogICAgfQogICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSAmJiBfLmVhY2godGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSwgdGhpcy5fYWRkRXZlbnQsIHRoaXMpOwogIH0sCiAgLy9wYXJhbXMgbWF5IGNvbnRhaW46CiAgLy8tIG5hbWUKICAvLy0gb3JpZ2luYWxOYW1lCiAgLy8tIHNlbGVjdG9yCiAgLy8tIHR5cGUgInZpZXciIHx8ICJET00iCiAgLy8tIGhhbmRsZXIKICBfYWRkRXZlbnQ6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgaWYgKHBhcmFtcy50eXBlID09PSAndmlldycpIHsKICAgICAgXy5lYWNoKHBhcmFtcy5uYW1lLnNwbGl0KC9ccysvKSwgZnVuY3Rpb24obmFtZSkgewogICAgICAgIF9vbi5jYWxsKHRoaXMsIG5hbWUsIGJpbmRFdmVudEhhbmRsZXIuY2FsbCh0aGlzLCAndmlldy1ldmVudDonLCBwYXJhbXMpKTsKICAgICAgfSwgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgYm91bmRIYW5kbGVyID0gYmluZEV2ZW50SGFuZGxlci5jYWxsKHRoaXMsICdkb20tZXZlbnQ6JywgcGFyYW1zKTsKICAgICAgaWYgKCFwYXJhbXMubmVzdGVkKSB7CiAgICAgICAgYm91bmRIYW5kbGVyID0gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoYm91bmRIYW5kbGVyLCB0aGlzLmNpZCk7CiAgICAgIH0KICAgICAgaWYgKHBhcmFtcy5zZWxlY3RvcikgewogICAgICAgIHZhciBuYW1lID0gcGFyYW1zLm5hbWUgKyAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwogICAgICAgIHRoaXMuJGVsLm9uKG5hbWUsIHBhcmFtcy5zZWxlY3RvciwgYm91bmRIYW5kbGVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRlbC5vbihwYXJhbXMubmFtZSwgYm91bmRIYW5kbGVyKTsKICAgICAgfQogICAgfQogIH0KfSk7CgovLyBXaGVuIHZpZXcgaXMgcmVhZHkgdHJpZ2dlciByZWFkeSBldmVudCBvbiBhbGwKLy8gY2hpbGRyZW4gdGhhdCBhcmUgcHJlc2VudCwgdGhlbiByZWdpc3RlciBhbgovLyBldmVudCB0aGF0IHdpbGwgdHJpZ2dlciByZWFkeSBvbiBuZXcgY2hpbGRyZW4KLy8gd2hlbiB0aGV5IGFyZSBhZGRlZApUaG9yYXguVmlldy5vbigncmVhZHknLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgaWYgKCF0aGlzLl9pc1JlYWR5KSB7CiAgICB0aGlzLl9pc1JlYWR5ID0gdHJ1ZTsKICAgIGZ1bmN0aW9uIHRyaWdnZXJSZWFkeU9uQ2hpbGQoY2hpbGQpIHsKICAgICAgY2hpbGQudHJpZ2dlcigncmVhZHknLCBvcHRpb25zKTsKICAgIH0KICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCB0cmlnZ2VyUmVhZHlPbkNoaWxkKTsKICAgIHRoaXMub24oJ2NoaWxkJywgdHJpZ2dlclJlYWR5T25DaGlsZCk7CiAgfQp9KTsKCnZhciBldmVudFNwbGl0dGVyID0gL14obmVzdGVkXHMrKT8oXFMrKSg/OlxzKyguKykpPy87Cgp2YXIgZG9tRXZlbnRzID0gW10sCiAgICBkb21FdmVudFJlZ2V4cDsKZnVuY3Rpb24gcHVzaERvbUV2ZW50cyhldmVudHMpIHsKICBkb21FdmVudHMucHVzaC5hcHBseShkb21FdmVudHMsIGV2ZW50cyk7CiAgZG9tRXZlbnRSZWdleHAgPSBuZXcgUmVnRXhwKCdeKG5lc3RlZFxccyspPygnICsgZG9tRXZlbnRzLmpvaW4oJ3wnKSArICcpKD86XFxzfCQpJyk7Cn0KcHVzaERvbUV2ZW50cyhbCiAgJ21vdXNlZG93bicsICdtb3VzZXVwJywgJ21vdXNlbW92ZScsICdtb3VzZW92ZXInLCAnbW91c2VvdXQnLAogICd0b3VjaHN0YXJ0JywgJ3RvdWNoZW5kJywgJ3RvdWNobW92ZScsCiAgJ2NsaWNrJywgJ2RibGNsaWNrJywKICAna2V5dXAnLCAna2V5ZG93bicsICdrZXlwcmVzcycsCiAgJ3N1Ym1pdCcsICdjaGFuZ2UnLAogICdmb2N1cycsICdibHVyJwpdKTsKCmZ1bmN0aW9uIGNvbnRhaW5IYW5kbGVyVG9DdXJlbnRWaWV3KGhhbmRsZXIsIGNpZCkgewogIHJldHVybiBmdW5jdGlvbihldmVudCkgewogICAgdmFyIHZpZXcgPSAkKGV2ZW50LnRhcmdldCkudmlldyh7aGVscGVyOiBmYWxzZX0pOwogICAgaWYgKHZpZXcgJiYgdmlldy5jaWQgPT09IGNpZCkgewogICAgICBldmVudC5vcmlnaW5hbENvbnRleHQgPSB0aGlzOwogICAgICBoYW5kbGVyKGV2ZW50KTsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiBiaW5kRXZlbnRIYW5kbGVyKGV2ZW50TmFtZSwgcGFyYW1zKSB7CiAgZXZlbnROYW1lICs9IHBhcmFtcy5vcmlnaW5hbE5hbWU7CgogIHZhciBjYWxsYmFjayA9IHBhcmFtcy5oYW5kbGVyLAogICAgICBtZXRob2QgPSBfLmlzRnVuY3Rpb24oY2FsbGJhY2spID8gY2FsbGJhY2sgOiB0aGlzW2NhbGxiYWNrXTsKICBpZiAoIW1ldGhvZCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdFdmVudCAiJyArIGNhbGxiYWNrICsgJyIgZG9lcyBub3QgZXhpc3QgJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJzonICsgZXZlbnROYW1lKTsKICB9CiAgcmV0dXJuIF8uYmluZChmdW5jdGlvbigpIHsKICAgIHRyeSB7CiAgICAgIG1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBUaG9yYXgub25FeGNlcHRpb24oJ3Rob3JheC1leGNlcHRpb246ICcgKyAodGhpcy5uYW1lIHx8IHRoaXMuY2lkKSArICc6JyArIGV2ZW50TmFtZSwgZSk7CiAgICB9CiAgfSwgcGFyYW1zLmNvbnRleHQgfHwgdGhpcyk7Cn0KCmZ1bmN0aW9uIGV2ZW50UGFyYW1zRnJvbUV2ZW50SXRlbShuYW1lLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgdmFyIHBhcmFtcyA9IHsKICAgIG9yaWdpbmFsTmFtZTogbmFtZSwKICAgIGhhbmRsZXI6IF8uaXNTdHJpbmcoaGFuZGxlcikgPyB0aGlzW2hhbmRsZXJdIDogaGFuZGxlcgogIH07CiAgaWYgKG5hbWUubWF0Y2goZG9tRXZlbnRSZWdleHApKSB7CiAgICB2YXIgbWF0Y2ggPSBldmVudFNwbGl0dGVyLmV4ZWMobmFtZSk7CiAgICBwYXJhbXMubmVzdGVkID0gISFtYXRjaFsxXTsKICAgIHBhcmFtcy5uYW1lID0gbWF0Y2hbMl07CiAgICBwYXJhbXMudHlwZSA9ICdET00nOwogICAgcGFyYW1zLnNlbGVjdG9yID0gbWF0Y2hbM107CiAgfSBlbHNlIHsKICAgIHBhcmFtcy5uYW1lID0gbmFtZTsKICAgIHBhcmFtcy50eXBlID0gJ3ZpZXcnOwogIH0KICBwYXJhbXMuY29udGV4dCA9IGNvbnRleHQ7CiAgcmV0dXJuIHBhcmFtczsKfQoKOzsKLypnbG9iYWwgZ2V0T3B0aW9uc0RhdGEsIGh0bWxBdHRyaWJ1dGVzVG9Db3B5LCBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucywgdmlld0hlbHBlckF0dHJpYnV0ZU5hbWUgKi8KdmFyIHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgPSAnZGF0YS12aWV3LXRtcCcsCiAgICB2aWV3VGVtcGxhdGVPdmVycmlkZXMgPSB7fTsKCi8vIFdpbGwgYmUgc2hhcmVkIGJ5IEhlbHBlclZpZXcgYW5kIENvbGxlY3Rpb25IZWxwZXJWaWV3CnZhciBoZWxwZXJWaWV3UHJvdG90eXBlID0gewogIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIFRob3JheC5WaWV3LnByb3RvdHlwZS5fZW5zdXJlRWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy4kZWwuYXR0cih2aWV3SGVscGVyQXR0cmlidXRlTmFtZSwgdGhpcy5faGVscGVyTmFtZSk7CiAgfSwKICBfZ2V0Q29udGV4dDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5wYXJlbnQuX2dldENvbnRleHQuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3VtZW50cyk7CiAgfQp9OwoKVGhvcmF4LkhlbHBlclZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoaGVscGVyVmlld1Byb3RvdHlwZSk7CgovLyBFbnN1cmUgbmVzdGVkIGlubGluZSBoZWxwZXJzIHdpbGwgYWx3YXlzIGhhdmUgdGhpcy5wYXJlbnQKLy8gc2V0IHRvIHRoZSB2aWV3IGNvbnRhaW5pbmcgdGhlIHRlbXBsYXRlCmZ1bmN0aW9uIGdldFBhcmVudChwYXJlbnQpIHsKICAvLyBUaGUgYHZpZXdgIGhlbHBlciBpcyBhIHNwZWNpYWwgY2FzZSBhcyBpdCBlbWJlZHMKICAvLyBhIHZpZXcgaW5zdGVhZCBvZiBjcmVhdGluZyBhIG5ldyBvbmUKICB3aGlsZSAocGFyZW50Ll9oZWxwZXJOYW1lICYmIHBhcmVudC5faGVscGVyTmFtZSAhPT0gJ3ZpZXcnKSB7CiAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50OwogIH0KICByZXR1cm4gcGFyZW50Owp9CgpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlciA9IGZ1bmN0aW9uKG5hbWUsIFZpZXdDbGFzcywgY2FsbGJhY2spIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgIGNhbGxiYWNrID0gVmlld0NsYXNzLmNhbGxiYWNrOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSBWaWV3Q2xhc3M7CiAgICAgIFZpZXdDbGFzcyA9IFRob3JheC5IZWxwZXJWaWV3OwogICAgfQogIH0KICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKG5hbWUsIGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICBvcHRpb25zID0gYXJncy5wb3AoKSwKICAgICAgICBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKCiAgICB2YXIgdmlld09wdGlvbnMgPSB7CiAgICAgIHRlbXBsYXRlOiBvcHRpb25zLmZuIHx8IEhhbmRsZWJhcnMuVk0ubm9vcCwKICAgICAgaW52ZXJzZTogb3B0aW9ucy5pbnZlcnNlLAogICAgICBvcHRpb25zOiBvcHRpb25zLmhhc2gsCiAgICAgIGRlY2xhcmluZ1ZpZXc6IGRlY2xhcmluZ1ZpZXcsCiAgICAgIHBhcmVudDogZ2V0UGFyZW50KGRlY2xhcmluZ1ZpZXcpLAogICAgICBfaGVscGVyTmFtZTogbmFtZSwKICAgICAgX2hlbHBlck9wdGlvbnM6IHsKICAgICAgICBvcHRpb25zOiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucyksCiAgICAgICAgYXJnczogXy5jbG9uZShhcmdzKQogICAgICB9CiAgICB9OwoKICAgIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMuaGFzaCk7CiAgICBfLmV4dGVuZCh2aWV3T3B0aW9ucywgXy5waWNrKG9wdGlvbnMuaGFzaCwgaHRtbEF0dHJpYnV0ZXNUb0NvcHkpKTsKCiAgICAvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhbiBleGlzdGluZyBpbnN0YW5jZSB0aGF0IHdlIGNhbiByZXVzZQogICAgdmFyIGluc3RhbmNlID0gXy5maW5kKGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgcmV0dXJuIGNvbXBhcmVIZWxwZXJPcHRpb25zKHZpZXdPcHRpb25zLCBjaGlsZCk7CiAgICB9KTsKCiAgICAvLyBDcmVhdGUgdGhlIGluc3RhbmNlIGlmIHdlIGRvbid0IGFscmVhZHkgaGF2ZSBvbmUKICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgICAgaW5zdGFuY2UgPSBWaWV3Q2xhc3MuZmFjdG9yeShhcmdzLCB2aWV3T3B0aW9ucyk7CiAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KCiAgICAgICAgaW5zdGFuY2UuX2hlbHBlck5hbWUgPSB2aWV3T3B0aW9ucy5faGVscGVyTmFtZTsKICAgICAgICBpbnN0YW5jZS5faGVscGVyT3B0aW9ucyA9IHZpZXdPcHRpb25zLl9oZWxwZXJPcHRpb25zOwogICAgICB9IGVsc2UgewogICAgICAgIGluc3RhbmNlID0gbmV3IFZpZXdDbGFzcyh2aWV3T3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIGFyZ3MucHVzaChpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuX2FkZENoaWxkKGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyJywgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoKICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICB9IGVsc2UgewogICAgICBkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMgPSBfLndpdGhvdXQoZGVjbGFyaW5nVmlldy5fcHJldmlvdXNIZWxwZXJzLCBpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuY2hpbGRyZW5baW5zdGFuY2UuY2lkXSA9IGluc3RhbmNlOwogICAgfQoKICAgIHZhciBodG1sQXR0cmlidXRlcyA9IF8ucGljayhvcHRpb25zLmhhc2gsIGh0bWxBdHRyaWJ1dGVzVG9Db3B5KTsKICAgIGh0bWxBdHRyaWJ1dGVzW3ZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gaW5zdGFuY2UuY2lkOwoKICAgIHZhciBleHBhbmRUb2tlbnMgPSBvcHRpb25zLmhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICAgIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhodG1sQXR0cmlidXRlcywgJycsIGV4cGFuZFRva2VucyA/IHRoaXMgOiBudWxsKSk7CiAgfSk7CiAgdmFyIGhlbHBlciA9IEhhbmRsZWJhcnMuaGVscGVyc1tuYW1lXTsKICByZXR1cm4gaGVscGVyOwp9OwoKVGhvcmF4LlZpZXcub24oJ2FwcGVuZCcsIGZ1bmN0aW9uKHNjb3BlLCBjYWxsYmFjaykgewogIChzY29wZSB8fCB0aGlzLiRlbCkuZmluZCgnWycgKyB2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lICsgJ10nKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICB2YXIgcGxhY2Vob2xkZXJJZCA9IGVsLmdldEF0dHJpYnV0ZSh2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lKSwKICAgICAgICB2aWV3ID0gdGhpcy5jaGlsZHJlbltwbGFjZWhvbGRlcklkXTsKICAgIGlmICh2aWV3KSB7CiAgICAgIC8vc2VlIGlmIHRoZSB2aWV3IGhlbHBlciBkZWNsYXJlZCBhbiBvdmVycmlkZSBmb3IgdGhlIHZpZXcKICAgICAgLy9pZiBub3QsIGVuc3VyZSB0aGUgdmlldyBoYXMgYmVlbiByZW5kZXJlZCBhdCBsZWFzdCBvbmNlCiAgICAgIGlmICh2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pIHsKICAgICAgICB2aWV3LnJlbmRlcih2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pOwogICAgICAgIGRlbGV0ZSB2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICB9CiAgICAgICQoZWwpLnJlcGxhY2VXaXRoKHZpZXcuZWwpOwogICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayh2aWV3LmVsKTsKICAgIH0KICB9LCB0aGlzKTsKfSk7CgoKLyoqCiAqIENsb25lcyB0aGUgaGVscGVyIG9wdGlvbnMsIGRyb3BwaW5nIGl0ZW1zIHRoYXQgYXJlIGtub3duIHRvIGNoYW5nZQogKiBiZXR3ZWVuIHJlbmRlcmluZyBjeWNsZXMgYXMgYXBwcm9wcmlhdGUuCiAqLwpmdW5jdGlvbiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucykgewogIHZhciByZXQgPSBfLnBpY2sob3B0aW9ucywgJ2ZuJywgJ2ludmVyc2UnLCAnaGFzaCcsICdkYXRhJyk7CiAgcmV0LmRhdGEgPSBfLm9taXQob3B0aW9ucy5kYXRhLCAnY2lkJywgJ3ZpZXcnLCAneWllbGQnKTsKICByZXR1cm4gcmV0Owp9CgovKioKICogQ2hlY2tzIGZvciBiYXNpYyBlcXVhbGl0eSBiZXR3ZWVuIHR3byBzZXRzIG9mIHBhcmFtZXRlcnMgZm9yIGEgaGVscGVyIHZpZXcuCiAqCiAqIENoZWNrZWQgZmllbGRzIGluY2x1ZGU6CiAqICAtIF9oZWxwZXJOYW1lCiAqICAtIEFsbCBhcmdzCiAqICAtIEhhc2gKICogIC0gRGF0YQogKiAgLSBGdW5jdGlvbiBhbmQgSW52ZXJ0IChpZCBiYXNlZCBpZiBwb3NzaWJsZSkKICoKICogVGhpcyBtZXRob2QgYWxsb3dzIHVzIHRvIGRldGVybWluZSBpZiB0aGUgaW5wdXRzIHRvIGEgZ2l2ZW4gdmlldyBhcmUgdGhlIHNhbWUuIElmIHRoZXkKICogYXJlIHRoZW4gd2UgbWFrZSB0aGUgYXNzdW1wdGlvbiB0aGF0IHRoZSByZW5kZXJpbmcgd2lsbCBiZSB0aGUgc2FtZSAob3IgdGhlIGNoaWxkIHZpZXcgd2lsbAogKiBvdGhlcndpc2UgcmVyZW5kZXJpbmcgaXQgYnkgbW9uaXRvcmluZyBpdCdzIHBhcmFtZXRlcnMgYXMgbmVjZXNzYXJ5KSBhbmQgcmV1c2UgdGhlIHZpZXcgb24KICogcmVyZW5kZXIgb2YgdGhlIHBhcmVudCB2aWV3LgogKi8KZnVuY3Rpb24gY29tcGFyZUhlbHBlck9wdGlvbnMoYSwgYikgewogIGZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYSwgYikgewogICAgcmV0dXJuIF8uZXZlcnkoYSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICByZXR1cm4gYltrZXldID09PSB2YWx1ZTsKICAgIH0pOwogIH0KCiAgaWYgKGEuX2hlbHBlck5hbWUgIT09IGIuX2hlbHBlck5hbWUpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGEgPSBhLl9oZWxwZXJPcHRpb25zOwogIGIgPSBiLl9oZWxwZXJPcHRpb25zOwoKICAvLyBJbXBsZW1lbnRzIGEgZmlyc3QgbGV2ZWwgZGVwdGggY29tcGFyaXNvbgogIHJldHVybiBhLmFyZ3MubGVuZ3RoID09PSBiLmFyZ3MubGVuZ3RoCiAgICAgICYmIGNvbXBhcmVWYWx1ZXMoYS5hcmdzLCBiLmFyZ3MpCiAgICAgICYmIF8uaXNFcXVhbChfLmtleXMoYS5vcHRpb25zKSwgXy5rZXlzKGIub3B0aW9ucykpCiAgICAgICYmIF8uZXZlcnkoYS5vcHRpb25zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAnZGF0YScgfHwga2V5ID09PSAnaGFzaCcpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXMoYS5vcHRpb25zW2tleV0sIGIub3B0aW9uc1trZXldKTsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnZm4nIHx8IGtleSA9PT0gJ2ludmVyc2UnKSB7CiAgICAgICAgICAgIGlmIChiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG90aGVyID0gYi5vcHRpb25zW2tleV0gfHwge307CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSAmJiBfLmhhcyh2YWx1ZSwgJ3Byb2dyYW0nKSAmJiAhdmFsdWUuZGVwdGggJiYgb3RoZXIucHJvZ3JhbSA9PT0gdmFsdWUucHJvZ3JhbTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWU7CiAgICAgICAgfSk7Cn0KCjs7Ci8qZ2xvYmFsIGdldFZhbHVlLCBpbmhlcml0VmFycywgd2Fsa0luaGVyaXRUcmVlICovCgpmdW5jdGlvbiBkYXRhT2JqZWN0KHR5cGUsIHNwZWMpIHsKICBzcGVjID0gaW5oZXJpdFZhcnNbdHlwZV0gPSBfLmRlZmF1bHRzKHsKICAgIG5hbWU6ICdfJyArIHR5cGUgKyAnRXZlbnRzJywKICAgIGV2ZW50OiB0cnVlCiAgfSwgc3BlYyk7CgogIC8vIEFkZCBhIGNhbGxiYWNrIGluIHRoZSB2aWV3IGNvbnN0cnVjdG9yCiAgc3BlYy5jdG9yID0gZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpc1t0eXBlXSkgewogICAgICAvLyBOZWVkIHRvIG51bGwgdGhpcy5tb2RlbC9jb2xsZWN0aW9uIHNvIHNldE1vZGVsL0NvbGxlY3Rpb24gd2lsbAogICAgICAvLyBub3QgdHJlYXQgaXQgYXMgdGhlIG9sZCBtb2RlbC9jb2xsZWN0aW9uIGFuZCBpbW1lZGlhdGVseSByZXR1cm4KICAgICAgdmFyIG9iamVjdCA9IHRoaXNbdHlwZV07CiAgICAgIHRoaXNbdHlwZV0gPSBudWxsOwogICAgICB0aGlzW3NwZWMuc2V0XShvYmplY3QpOwogICAgfQogIH07CgogIGZ1bmN0aW9uIHNldE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICB2YXIgb2xkID0gdGhpc1t0eXBlXSwKICAgICAgICAkZWwgPSBnZXRWYWx1ZSh0aGlzLCBzcGVjLiRlbCk7CgogICAgaWYgKGRhdGFPYmplY3QgPT09IG9sZCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGlmIChvbGQpIHsKICAgICAgdGhpcy51bmJpbmREYXRhT2JqZWN0KG9sZCk7CiAgICB9CgogICAgaWYgKGRhdGFPYmplY3QpIHsKICAgICAgdGhpc1t0eXBlXSA9IGRhdGFPYmplY3Q7CgogICAgICBpZiAoc3BlYy5sb2FkaW5nKSB7CiAgICAgICAgc3BlYy5sb2FkaW5nLmNhbGwodGhpcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuYmluZERhdGFPYmplY3QodHlwZSwgZGF0YU9iamVjdCwgXy5leHRlbmQoe30sIHRoaXMub3B0aW9ucywgb3B0aW9ucykpOwogICAgICAkZWwgJiYgJGVsLmF0dHIoc3BlYy5jaWRBdHRyTmFtZSwgZGF0YU9iamVjdC5jaWQpOwogICAgICBkYXRhT2JqZWN0LnRyaWdnZXIoJ3NldCcsIGRhdGFPYmplY3QsIG9sZCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzW3R5cGVdID0gZmFsc2U7CiAgICAgIGlmIChzcGVjLmNoYW5nZSkgewogICAgICAgIHNwZWMuY2hhbmdlLmNhbGwodGhpcywgZmFsc2UpOwogICAgICB9CiAgICAgICRlbCAmJiAkZWwucmVtb3ZlQXR0cihzcGVjLmNpZEF0dHJOYW1lKTsKICAgIH0KICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOmRhdGEtb2JqZWN0JywgdHlwZSwgZGF0YU9iamVjdCwgb2xkKTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgVGhvcmF4LlZpZXcucHJvdG90eXBlW3NwZWMuc2V0XSA9IHNldE9iamVjdDsKfQoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgYmluZERhdGFPYmplY3Q6IGZ1bmN0aW9uKHR5cGUsIGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICAgIGlmICh0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF0gPSBkYXRhT2JqZWN0OwoKICAgIHZhciBvcHRpb25zID0gdGhpcy5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMoZGF0YU9iamVjdCwgXy5leHRlbmQoe30sIGluaGVyaXRWYXJzW3R5cGVdLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKSk7CiAgICB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbZGF0YU9iamVjdC5jaWRdID0gb3B0aW9uczsKCiAgICBiaW5kRXZlbnRzLmNhbGwodGhpcywgdHlwZSwgZGF0YU9iamVjdCwgdGhpcy5jb25zdHJ1Y3Rvcik7CiAgICBiaW5kRXZlbnRzLmNhbGwodGhpcywgdHlwZSwgZGF0YU9iamVjdCwgdGhpcyk7CgogICAgdmFyIHNwZWMgPSBpbmhlcml0VmFyc1t0eXBlXTsKICAgIHNwZWMuYmluZENhbGxiYWNrICYmIHNwZWMuYmluZENhbGxiYWNrLmNhbGwodGhpcywgZGF0YU9iamVjdCwgb3B0aW9ucyk7CgogICAgaWYgKGRhdGFPYmplY3Quc2hvdWxkRmV0Y2ggJiYgZGF0YU9iamVjdC5zaG91bGRGZXRjaChvcHRpb25zKSkgewogICAgICBsb2FkT2JqZWN0KGRhdGFPYmplY3QsIG9wdGlvbnMpOwogICAgfSBlbHNlIGlmIChpbmhlcml0VmFyc1t0eXBlXS5jaGFuZ2UpIHsKICAgICAgLy8gd2FudCB0byB0cmlnZ2VyIGJ1aWx0IGluIHJlbmRlcmluZyB3aXRob3V0IHRyaWdnZXJpbmcgZXZlbnQgb24gbW9kZWwKICAgICAgaW5oZXJpdFZhcnNbdHlwZV0uY2hhbmdlLmNhbGwodGhpcywgZGF0YU9iamVjdCwgb3B0aW9ucyk7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfSwKCiAgdW5iaW5kRGF0YU9iamVjdDogZnVuY3Rpb24gKGRhdGFPYmplY3QpIHsKICAgIGlmICghdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBkZWxldGUgdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXTsKICAgIHRoaXMuc3RvcExpc3RlbmluZyhkYXRhT2JqZWN0KTsKICAgIGRlbGV0ZSB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbZGF0YU9iamVjdC5jaWRdOwogICAgcmV0dXJuIHRydWU7CiAgfSwKCiAgX21vZGlmeURhdGFPYmplY3RPcHRpb25zOiBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9uczsKICB9Cn0pOwoKZnVuY3Rpb24gYmluZEV2ZW50cyh0eXBlLCB0YXJnZXQsIHNvdXJjZSkgewogIHZhciBjb250ZXh0ID0gdGhpczsKICB3YWxrSW5oZXJpdFRyZWUoc291cmNlLCAnXycgKyB0eXBlICsgJ0V2ZW50cycsIHRydWUsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAvLyBnZXRFdmVudENhbGxiYWNrIHdpbGwgcmVzb2x2ZSBpZiBpdCBpcyBhIHN0cmluZyBvciBhIG1ldGhvZAogICAgLy8gYW5kIHJldHVybiBhIG1ldGhvZAogICAgY29udGV4dC5saXN0ZW5Ubyh0YXJnZXQsIGV2ZW50WzBdLCBfLmJpbmQoZ2V0RXZlbnRDYWxsYmFjayhldmVudFsxXSwgY29udGV4dCksIGV2ZW50WzJdIHx8IGNvbnRleHQpKTsKICB9KTsKfQoKZnVuY3Rpb24gbG9hZE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgaWYgKGRhdGFPYmplY3QubG9hZCkgewogICAgZGF0YU9iamVjdC5sb2FkKGZ1bmN0aW9uKCkgewogICAgICBvcHRpb25zICYmIG9wdGlvbnMuc3VjY2VzcyAmJiBvcHRpb25zLnN1Y2Nlc3MoZGF0YU9iamVjdCk7CiAgICB9LCBvcHRpb25zKTsKICB9IGVsc2UgewogICAgZGF0YU9iamVjdC5mZXRjaChvcHRpb25zKTsKICB9Cn0KCmZ1bmN0aW9uIGdldEV2ZW50Q2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQpIHsKICBpZiAoXy5pc0Z1bmN0aW9uKGNhbGxiYWNrKSkgewogICAgcmV0dXJuIGNhbGxiYWNrOwogIH0gZWxzZSB7CiAgICByZXR1cm4gY29udGV4dFtjYWxsYmFja107CiAgfQp9Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXIsIGRhdGFPYmplY3QsIGdldFZhbHVlICovCnZhciBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1tb2RlbC1jaWQnOwoKVGhvcmF4Lk1vZGVsID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKHsKICBpc0VtcHR5OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiAhdGhpcy5pc1BvcHVsYXRlZCgpOwogIH0sCiAgaXNQb3B1bGF0ZWQ6IGZ1bmN0aW9uKCkgewogICAgLy8gV2UgYXJlIHBvcHVsYXRlZCBpZiB3ZSBoYXZlIGF0dHJpYnV0ZXMgc2V0CiAgICB2YXIgYXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKSwKICAgICAgICBkZWZhdWx0cyA9IGdldFZhbHVlKHRoaXMsICdkZWZhdWx0cycpIHx8IHt9OwogICAgZm9yICh2YXIgZGVmYXVsdF9rZXkgaW4gZGVmYXVsdHMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXNbZGVmYXVsdF9rZXldICE9IGRlZmF1bHRzW2RlZmF1bHRfa2V5XSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGRlbGV0ZSBhdHRyaWJ1dGVzW2RlZmF1bHRfa2V5XTsKICAgIH0KICAgIHZhciBrZXlzID0gXy5rZXlzKGF0dHJpYnV0ZXMpOwogICAgcmV0dXJuIGtleXMubGVuZ3RoID4gMSB8fCAoa2V5cy5sZW5ndGggPT09IDEgJiYga2V5c1swXSAhPT0gdGhpcy5pZEF0dHJpYnV0ZSk7CiAgfSwKICBzaG91bGRGZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgLy8gdXJsKCkgd2lsbCB0aHJvdyBpZiBtb2RlbCBoYXMgbm8gYHVybFJvb3RgIGFuZCBubyBgY29sbGVjdGlvbmAKICAgIC8vIG9yIGhhcyBgY29sbGVjdGlvbmAgYW5kIGBjb2xsZWN0aW9uYCBoYXMgbm8gYHVybGAKICAgIHZhciB1cmw7CiAgICB0cnkgewogICAgICB1cmwgPSBnZXRWYWx1ZSh0aGlzLCAndXJsJyk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgdXJsID0gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gb3B0aW9ucy5mZXRjaCAmJiAhIXVybCAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpOwogIH0KfSk7CgpUaG9yYXguTW9kZWxzID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguTW9kZWwsIFRob3JheC5Nb2RlbHMpOwoKZGF0YU9iamVjdCgnbW9kZWwnLCB7CiAgc2V0OiAnc2V0TW9kZWwnLAogIGRlZmF1bHRPcHRpb25zOiB7CiAgICByZW5kZXI6IHRydWUsCiAgICBmZXRjaDogdHJ1ZSwKICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgZXJyb3JzOiB0cnVlCiAgfSwKICBjaGFuZ2U6IG9uTW9kZWxDaGFuZ2UsCiAgJGVsOiAnJGVsJywKICBjaWRBdHRyTmFtZTogbW9kZWxDaWRBdHRyaWJ1dGVOYW1lCn0pOwoKZnVuY3Rpb24gb25Nb2RlbENoYW5nZShtb2RlbCkgewogIHZhciBtb2RlbE9wdGlvbnMgPSBtb2RlbCAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbbW9kZWwuY2lkXTsKICAvLyAhbW9kZWxPcHRpb25zIHdpbGwgYmUgdHJ1ZSB3aGVuIHNldE1vZGVsKGZhbHNlKSBpcyBjYWxsZWQKICBpZiAoIW1vZGVsT3B0aW9ucyB8fCAobW9kZWxPcHRpb25zICYmIG1vZGVsT3B0aW9ucy5yZW5kZXIpKSB7CiAgICB0aGlzLnJlbmRlcigpOwogIH0KfQoKVGhvcmF4LlZpZXcub24oewogIG1vZGVsOiB7CiAgICBlcnJvcjogZnVuY3Rpb24obW9kZWwsIGVycm9ycykgewogICAgICBpZiAodGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW21vZGVsLmNpZF0uZXJyb3JzKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIGVycm9ycywgbW9kZWwpOwogICAgICB9CiAgICB9LAogICAgY2hhbmdlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBvbk1vZGVsQ2hhbmdlLmNhbGwodGhpcywgbW9kZWwpOwogICAgfQogIH0KfSk7CgokLmZuLm1vZGVsID0gZnVuY3Rpb24odmlldykgewogIHZhciAkdGhpcyA9ICQodGhpcyksCiAgICAgIG1vZGVsRWxlbWVudCA9ICR0aGlzLmNsb3Nlc3QoJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJ10nKSwKICAgICAgbW9kZWxDaWQgPSBtb2RlbEVsZW1lbnQgJiYgbW9kZWxFbGVtZW50LmF0dHIobW9kZWxDaWRBdHRyaWJ1dGVOYW1lKTsKICBpZiAobW9kZWxDaWQpIHsKICAgIHZhciB2aWV3ID0gdmlldyB8fCAkdGhpcy52aWV3KCk7CiAgICBpZiAodmlldyAmJiB2aWV3Lm1vZGVsICYmIHZpZXcubW9kZWwuY2lkID09PSBtb2RlbENpZCkgewogICAgICByZXR1cm4gdmlldy5tb2RlbCB8fCBmYWxzZTsKICAgIH0KICAgIHZhciBjb2xsZWN0aW9uID0gJHRoaXMuY29sbGVjdGlvbih2aWV3KTsKICAgIGlmIChjb2xsZWN0aW9uKSB7CiAgICAgIHJldHVybiBjb2xsZWN0aW9uLmdldChtb2RlbENpZCk7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKCjs7Ci8qZ2xvYmFsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciwgZGF0YU9iamVjdCwgZ2V0RXZlbnRDYWxsYmFjaywgZ2V0VmFsdWUsIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgdmlld0NpZEF0dHJpYnV0ZU5hbWUgKi8KdmFyIF9mZXRjaCA9IEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLmZldGNoLAogICAgX3Jlc2V0ID0gQmFja2JvbmUuQ29sbGVjdGlvbi5wcm90b3R5cGUucmVzZXQsCiAgICBfcmVwbGFjZUhUTUwgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX3JlcGxhY2VIVE1MLAogICAgY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWNpZCcsCiAgICBjb2xsZWN0aW9uRW1wdHlBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY29sbGVjdGlvbi1lbXB0eScsCiAgICBjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWVsZW1lbnQnLAogICAgRUxFTUVOVF9OT0RFX1RZUEUgPSAxOwoKVGhvcmF4LkNvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uLmV4dGVuZCh7CiAgbW9kZWw6IFRob3JheC5Nb2RlbCB8fCBCYWNrYm9uZS5Nb2RlbCwKICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnY29sbGVjdGlvbicpOwogICAgcmV0dXJuIEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9LAogIGlzRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5sZW5ndGggPT09IDAgJiYgdGhpcy5pc1BvcHVsYXRlZCgpOwogICAgfQogIH0sCiAgaXNQb3B1bGF0ZWQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2ZldGNoZWQgfHwgdGhpcy5sZW5ndGggPiAwIHx8ICghdGhpcy5sZW5ndGggJiYgIWdldFZhbHVlKHRoaXMsICd1cmwnKSk7CiAgfSwKICBzaG91bGRGZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgcmV0dXJuIG9wdGlvbnMuZmV0Y2ggJiYgISFnZXRWYWx1ZSh0aGlzLCAndXJsJykgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9LAogIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24oY29sbGVjdGlvbiwgcmVzcG9uc2UpIHsKICAgICAgY29sbGVjdGlvbi5fZmV0Y2hlZCA9IHRydWU7CiAgICAgIHN1Y2Nlc3MgJiYgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwb25zZSk7CiAgICB9OwogICAgcmV0dXJuIF9mZXRjaC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0sCiAgcmVzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgdGhpcy5fZmV0Y2hlZCA9ICEhbW9kZWxzOwogICAgcmV0dXJuIF9yZXNldC5jYWxsKHRoaXMsIG1vZGVscywgb3B0aW9ucyk7CiAgfQp9KTsKClRob3JheC5Db2xsZWN0aW9ucyA9IHt9OwpjcmVhdGVSZWdpc3RyeVdyYXBwZXIoVGhvcmF4LkNvbGxlY3Rpb24sIFRob3JheC5Db2xsZWN0aW9ucyk7CgpkYXRhT2JqZWN0KCdjb2xsZWN0aW9uJywgewogIHNldDogJ3NldENvbGxlY3Rpb24nLAogIGJpbmRDYWxsYmFjazogb25TZXRDb2xsZWN0aW9uLAogIGRlZmF1bHRPcHRpb25zOiB7CiAgICByZW5kZXI6IHRydWUsCiAgICBmZXRjaDogdHJ1ZSwKICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgZXJyb3JzOiB0cnVlCiAgfSwKICBjaGFuZ2U6IG9uQ29sbGVjdGlvblJlc2V0LAogICRlbDogJ2dldENvbGxlY3Rpb25FbGVtZW50JywKICBjaWRBdHRyTmFtZTogY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUKfSk7CgpUaG9yYXguQ29sbGVjdGlvblZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoewogIF9kZWZhdWx0VGVtcGxhdGU6IEhhbmRsZWJhcnMuVk0ubm9vcCwKICBfY29sbGVjdGlvblNlbGVjdG9yOiAnWycgKyBjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWUgKyAnXScsCgogIC8vIHByZXNlcnZlIGNvbGxlY3Rpb24gZWxlbWVudCBpZiBpdCB3YXMgbm90IGNyZWF0ZWQgd2l0aCB7e2NvbGxlY3Rpb259fSBoZWxwZXIKICBfcmVwbGFjZUhUTUw6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIGlmICh0aGlzLmNvbGxlY3Rpb24gJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW3RoaXMuY29sbGVjdGlvbi5jaWRdICYmIHRoaXMuX3JlbmRlckNvdW50KSB7CiAgICAgIHZhciBlbGVtZW50OwogICAgICB2YXIgb2xkQ29sbGVjdGlvbkVsZW1lbnQgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIGVsZW1lbnQgPSBfcmVwbGFjZUhUTUwuY2FsbCh0aGlzLCBodG1sKTsKICAgICAgaWYgKCFvbGRDb2xsZWN0aW9uRWxlbWVudC5hdHRyKCdkYXRhLXZpZXctY2lkJykpIHsKICAgICAgICB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCkucmVwbGFjZVdpdGgob2xkQ29sbGVjdGlvbkVsZW1lbnQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gX3JlcGxhY2VIVE1MLmNhbGwodGhpcywgaHRtbCk7CiAgICB9CiAgfSwKCiAgLy9hcHBlbmRJdGVtKG1vZGVsIFssaW5kZXhdKQogIC8vYXBwZW5kSXRlbShodG1sX3N0cmluZywgaW5kZXgpCiAgLy9hcHBlbmRJdGVtKHZpZXcsIGluZGV4KQogIGFwcGVuZEl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpbmRleCwgb3B0aW9ucykgewogICAgLy9lbXB0eSBpdGVtCiAgICBpZiAoIW1vZGVsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBpdGVtVmlldywKICAgICAgICAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgIGZpbHRlcjogdHJ1ZQogICAgfSk7CiAgICAvL2lmIGluZGV4IGFyZ3VtZW50IGlzIGEgdmlldwogICAgaW5kZXggJiYgaW5kZXguZWwgJiYgKGluZGV4ID0gJGVsLmNoaWxkcmVuKCkuaW5kZXhPZihpbmRleC5lbCkgKyAxKTsKICAgIC8vaWYgYXJndW1lbnQgaXMgYSB2aWV3LCBvciBodG1sIHN0cmluZwogICAgaWYgKG1vZGVsLmVsIHx8IF8uaXNTdHJpbmcobW9kZWwpKSB7CiAgICAgIGl0ZW1WaWV3ID0gbW9kZWw7CiAgICAgIG1vZGVsID0gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICBpbmRleCA9IGluZGV4IHx8IHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSB8fCAwOwogICAgICBpdGVtVmlldyA9IHRoaXMucmVuZGVySXRlbShtb2RlbCwgaW5kZXgpOwogICAgfQogICAgaWYgKGl0ZW1WaWV3KSB7CiAgICAgIGl0ZW1WaWV3LmNpZCAmJiB0aGlzLl9hZGRDaGlsZChpdGVtVmlldyk7CiAgICAgIC8vaWYgdGhlIHJlbmRlcmVyJ3Mgb3V0cHV0IHdhc24ndCBjb250YWluZWQgaW4gYSB0YWcsIHdyYXAgaXQgaW4gYSBkaXYKICAgICAgLy9wbGFpbiB0ZXh0LCBvciBhIG1peHR1cmUgb2YgdG9wIGxldmVsIHRleHQgbm9kZXMgYW5kIGVsZW1lbnQgbm9kZXMKICAgICAgLy93aWxsIGdldCB3cmFwcGVkCiAgICAgIGlmIChfLmlzU3RyaW5nKGl0ZW1WaWV3KSAmJiAhaXRlbVZpZXcubWF0Y2goL15ccyo8L20pKSB7CiAgICAgICAgaXRlbVZpZXcgPSAnPGRpdj4nICsgaXRlbVZpZXcgKyAnPC9kaXY+JzsKICAgICAgfQogICAgICB2YXIgaXRlbUVsZW1lbnQgPSBpdGVtVmlldy5lbCA/IFtpdGVtVmlldy5lbF0gOiBfLmZpbHRlcigkKCQudHJpbShpdGVtVmlldykpLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy9maWx0ZXIgb3V0IHRvcCBsZXZlbCB3aGl0ZXNwYWNlIG5vZGVzCiAgICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERV9UWVBFOwogICAgICB9KTsKICAgICAgbW9kZWwgJiYgJChpdGVtRWxlbWVudCkuYXR0cihtb2RlbENpZEF0dHJpYnV0ZU5hbWUsIG1vZGVsLmNpZCk7CiAgICAgIHZhciBwcmV2aW91c01vZGVsID0gaW5kZXggPiAwID8gdGhpcy5jb2xsZWN0aW9uLmF0KGluZGV4IC0gMSkgOiBmYWxzZTsKICAgICAgaWYgKCFwcmV2aW91c01vZGVsKSB7CiAgICAgICAgJGVsLnByZXBlbmQoaXRlbUVsZW1lbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vdXNlIGxhc3QoKSBhcyBhcHBlbmRJdGVtIGNhbiBhY2NlcHQgbXVsdGlwbGUgbm9kZXMgZnJvbSBhIHRlbXBsYXRlCiAgICAgICAgdmFyIGxhc3QgPSAkZWwuY2hpbGRyZW4oJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIHByZXZpb3VzTW9kZWwuY2lkICsgJyJdJykubGFzdCgpOwogICAgICAgIGxhc3QuYWZ0ZXIoaXRlbUVsZW1lbnQpOwogICAgICB9CgogICAgICB0aGlzLnRyaWdnZXIoJ2FwcGVuZCcsIG51bGwsIGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgZWwuc2V0QXR0cmlidXRlKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgbW9kZWwuY2lkKTsKICAgICAgfSk7CgogICAgICAhb3B0aW9ucy5zaWxlbnQgJiYgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZDppdGVtJywgdGhpcywgdGhpcy5jb2xsZWN0aW9uLCBtb2RlbCwgaXRlbUVsZW1lbnQsIGluZGV4KTsKICAgICAgb3B0aW9ucy5maWx0ZXIgJiYgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfQogICAgcmV0dXJuIGl0ZW1WaWV3OwogIH0sCiAgLy/CoHVwZGF0ZUl0ZW0gb25seSB1c2VmdWwgaWYgdGhlcmUgaXMgbm8gaXRlbSB2aWV3LCBvdGhlcndpc2UKICAvL8KgaXRlbVZpZXcucmVuZGVyKCkgcHJvdmlkZXMgdGhlIHNhbWUgZnVuY3Rpb25hbGl0eQogIHVwZGF0ZUl0ZW06IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB0aGlzLnJlbW92ZUl0ZW0obW9kZWwpOwogICAgdGhpcy5hcHBlbmRJdGVtKG1vZGVsKTsKICB9LAogIHJlbW92ZUl0ZW06IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpLAogICAgICAgIHZpZXdFbCA9ICRlbC5maW5kKCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICc9IicgKyBtb2RlbC5jaWQgKyAnIl0nKTsKICAgIGlmICghdmlld0VsLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2aWV3RWwucmVtb3ZlKCk7CiAgICB2YXIgdmlld0NpZCA9IHZpZXdFbC5hdHRyKHZpZXdDaWRBdHRyaWJ1dGVOYW1lKSwKICAgICAgICBjaGlsZCA9IHRoaXMuY2hpbGRyZW5bdmlld0NpZF07CiAgICBpZiAoY2hpbGQpIHsKICAgICAgdGhpcy5fcmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICBjaGlsZC5kZXN0cm95KCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIHJlbmRlckNvbGxlY3Rpb246IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuY29sbGVjdGlvbikgewogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uLmlzRW1wdHkoKSkgewogICAgICAgIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkuY2FsbCh0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBoYW5kbGVDaGFuZ2VGcm9tRW1wdHlUb05vdEVtcHR5LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5jb2xsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaSkgewogICAgICAgICAgdGhpcy5hcHBlbmRJdGVtKGl0ZW0sIGkpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlcigncmVuZGVyZWQ6Y29sbGVjdGlvbicsIHRoaXMsIHRoaXMuY29sbGVjdGlvbik7CiAgICAgIGFwcGx5VmlzaWJpbGl0eUZpbHRlci5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgfQogIH0sCiAgZW1wdHlDbGFzczogJ2VtcHR5JywKICByZW5kZXJFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuZW1wdHlUZW1wbGF0ZSAmJiAhdGhpcy5lbXB0eVZpZXcpIHsKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAnZW1wdHlUZW1wbGF0ZScsIHsKICAgICAgICBleHRlbnNpb246ICctZW1wdHknLAogICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLmVtcHR5VmlldykgewogICAgICB2YXIgdmlld09wdGlvbnMgPSB7fTsKICAgICAgaWYgKHRoaXMuZW1wdHlUZW1wbGF0ZSkgewogICAgICAgIHZpZXdPcHRpb25zLnRlbXBsYXRlID0gdGhpcy5lbXB0eVRlbXBsYXRlOwogICAgICB9CiAgICAgIHZhciB2aWV3ID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuZW1wdHlWaWV3LCB2aWV3T3B0aW9ucyk7CiAgICAgIHZpZXcuZW5zdXJlUmVuZGVyZWQoKTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5lbXB0eVRlbXBsYXRlICYmIHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy5lbXB0eVRlbXBsYXRlKTsKICAgIH0KICB9LAogIHJlbmRlckl0ZW06IGZ1bmN0aW9uKG1vZGVsLCBpKSB7CiAgICBpZiAoIXRoaXMuaXRlbVRlbXBsYXRlICYmICF0aGlzLml0ZW1WaWV3KSB7CiAgICAgIGFzc2lnblRlbXBsYXRlLmNhbGwodGhpcywgJ2l0ZW1UZW1wbGF0ZScsIHsKICAgICAgICBleHRlbnNpb246ICctaXRlbScsCiAgICAgICAgLy8gb25seSByZXF1aXJlIGFuIGl0ZW1UZW1wbGF0ZSBpZiBhbiBpdGVtVmlldwogICAgICAgIC8vIGlzIG5vdCBwcmVzZW50CiAgICAgICAgcmVxdWlyZWQ6ICF0aGlzLml0ZW1WaWV3CiAgICAgIH0pOwogICAgfQogICAgaWYgKHRoaXMuaXRlbVZpZXcpIHsKICAgICAgdmFyIHZpZXdPcHRpb25zID0gewogICAgICAgIG1vZGVsOiBtb2RlbAogICAgICB9OwogICAgICBpZiAodGhpcy5pdGVtVGVtcGxhdGUpIHsKICAgICAgICB2aWV3T3B0aW9ucy50ZW1wbGF0ZSA9IHRoaXMuaXRlbVRlbXBsYXRlOwogICAgICB9CiAgICAgIHZhciB2aWV3ID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKHRoaXMuaXRlbVZpZXcsIHZpZXdPcHRpb25zKTsKICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLnJlbmRlclRlbXBsYXRlKHRoaXMuaXRlbVRlbXBsYXRlLCB0aGlzLml0ZW1Db250ZXh0KG1vZGVsLCBpKSk7CiAgICB9CiAgfSwKICBpdGVtQ29udGV4dDogZnVuY3Rpb24obW9kZWwgLyosIGkgKi8pIHsKICAgIHJldHVybiBtb2RlbC5hdHRyaWJ1dGVzOwogIH0sCiAgYXBwZW5kRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICRlbC5lbXB0eSgpOwogICAgdmFyIGVtcHR5Q29udGVudCA9IHRoaXMucmVuZGVyRW1wdHkoKTsKICAgIGVtcHR5Q29udGVudCAmJiB0aGlzLmFwcGVuZEl0ZW0oZW1wdHlDb250ZW50LCAwLCB7CiAgICAgIHNpbGVudDogdHJ1ZSwKICAgICAgZmlsdGVyOiBmYWxzZQogICAgfSk7CiAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOmVtcHR5JywgdGhpcywgdGhpcy5jb2xsZWN0aW9uKTsKICB9LAogIGdldENvbGxlY3Rpb25FbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIHZhciBlbGVtZW50ID0gdGhpcy4kKHRoaXMuX2NvbGxlY3Rpb25TZWxlY3Rvcik7CiAgICByZXR1cm4gZWxlbWVudC5sZW5ndGggPT09IDAgPyB0aGlzLiRlbCA6IGVsZW1lbnQ7CiAgfQp9KTsKClRob3JheC5Db2xsZWN0aW9uVmlldy5vbih7CiAgY29sbGVjdGlvbjogewogICAgcmVzZXQ6IG9uQ29sbGVjdGlvblJlc2V0LAogICAgc29ydDogb25Db2xsZWN0aW9uUmVzZXQsCiAgICBmaWx0ZXI6IGZ1bmN0aW9uKCkgewogICAgICBhcHBseVZpc2liaWxpdHlGaWx0ZXIuY2FsbCh0aGlzKTsKICAgIH0sCiAgICBjaGFuZ2U6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIC8vIElmIHdlIHJlbmRlcmVkIHdpdGggaXRlbSB2aWV3cywgbW9kZWwgY2hhbmdlcyB3aWxsIGJlIG9ic2VydmVkCiAgICAgIC8vIGJ5IHRoZSBnZW5lcmF0ZWQgaXRlbSB2aWV3IGJ1dCBpZiB3ZSByZW5kZXJlZCB3aXRoIHRlbXBsYXRlcwogICAgICAvLyB0aGVuIG1vZGVsIGNoYW5nZXMgbmVlZCB0byBiZSBib3VuZCBhcyBub3RoaW5nIGlzIHdhdGNoaW5nCiAgICAgICF0aGlzLml0ZW1WaWV3ICYmIHRoaXMudXBkYXRlSXRlbShtb2RlbCk7CiAgICAgIGFwcGx5SXRlbVZpc2libGl0eUZpbHRlci5jYWxsKHRoaXMsIG1vZGVsKTsKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDEgJiYgJGVsLmxlbmd0aCAmJiBoYW5kbGVDaGFuZ2VGcm9tRW1wdHlUb05vdEVtcHR5LmNhbGwodGhpcyk7CiAgICAgIGlmICgkZWwubGVuZ3RoKSB7CiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMuYXBwZW5kSXRlbShtb2RlbCwgaW5kZXgpOwogICAgICB9CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgICB0aGlzLnJlbW92ZUl0ZW0obW9kZWwpOwogICAgICB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoID09PSAwICYmICRlbC5sZW5ndGggJiYgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgfQogIH0KfSk7CgpUaG9yYXguVmlldy5vbih7CiAgY29sbGVjdGlvbjogewogICAgZXJyb3I6IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIG1lc3NhZ2UpIHsKICAgICAgaWYgKHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtjb2xsZWN0aW9uLmNpZF0uZXJyb3JzKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdlcnJvcicsIG1lc3NhZ2UsIGNvbGxlY3Rpb24pOwogICAgICB9CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIG9uQ29sbGVjdGlvblJlc2V0KGNvbGxlY3Rpb24pIHsKICB2YXIgb3B0aW9ucyA9IGNvbGxlY3Rpb24gJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2NvbGxlY3Rpb24uY2lkXTsKICAvLyB3ZSB3b3VsZCB3YW50IHRvIHN0aWxsIHJlbmRlciBpbiB0aGUgY2FzZSB0aGF0IHRoZQogIC8vIGNvbGxlY3Rpb24gaGFzIHRyYW5zaXRpb25lZCB0byBiZWluZyBmYWxzeQogIGlmICghY29sbGVjdGlvbiB8fCAob3B0aW9ucyAmJiBvcHRpb25zLnJlbmRlcikpIHsKICAgIHRoaXMucmVuZGVyQ29sbGVjdGlvbiAmJiB0aGlzLnJlbmRlckNvbGxlY3Rpb24oKTsKICB9Cn0KCi8vIEV2ZW4gaWYgdGhlIHZpZXcgaXMgbm90IGEgQ29sbGVjdGlvblZpZXcKLy8gZW5zdXJlUmVuZGVyZWQoKSB0byBwcm92aWRlIHNpbWlsYXIgYmVoYXZpb3IKLy8gdG8gYSBtb2RlbApmdW5jdGlvbiBvblNldENvbGxlY3Rpb24oKSB7CiAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwp9CgpmdW5jdGlvbiBhcHBseVZpc2liaWxpdHlGaWx0ZXIoKSB7CiAgaWYgKHRoaXMuaXRlbUZpbHRlcikgewogICAgdGhpcy5jb2xsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24obW9kZWwpIHsKICAgICAgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfSwgdGhpcyk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIobW9kZWwpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuaXRlbUZpbHRlciAmJiAkZWwuZmluZCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgbW9kZWwuY2lkICsgJyJdJylbaXRlbVNob3VsZEJlVmlzaWJsZS5jYWxsKHRoaXMsIG1vZGVsKSA/ICdzaG93JyA6ICdoaWRlJ10oKTsKfQoKZnVuY3Rpb24gaXRlbVNob3VsZEJlVmlzaWJsZShtb2RlbCkgewogIHJldHVybiB0aGlzLml0ZW1GaWx0ZXIobW9kZWwsIHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLnJlbW92ZUNsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLnJlbW92ZUF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSk7CiAgJGVsLmVtcHR5KCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLmFkZENsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLmF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSwgdHJ1ZSk7CiAgdGhpcy5hcHBlbmRFbXB0eSgpOwp9CgovLyQoc2VsZWN0b3IpLmNvbGxlY3Rpb24oKSBoZWxwZXIKJC5mbi5jb2xsZWN0aW9uID0gZnVuY3Rpb24odmlldykgewogIGlmICh2aWV3ICYmIHZpZXcuY29sbGVjdGlvbikgewogICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICB9CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgY29sbGVjdGlvbkVsZW1lbnQgPSAkdGhpcy5jbG9zZXN0KCdbJyArIGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lICsgJ10nKSwKICAgICAgY29sbGVjdGlvbkNpZCA9IGNvbGxlY3Rpb25FbGVtZW50ICYmIGNvbGxlY3Rpb25FbGVtZW50LmF0dHIoY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUpOwogIGlmIChjb2xsZWN0aW9uQ2lkKSB7CiAgICB2aWV3ID0gJHRoaXMudmlldygpOwogICAgaWYgKHZpZXcpIHsKICAgICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgaW5oZXJpdFZhcnMgKi8KCmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCnZhciBvbGRNb2RlbENoYW5nZSA9IGluaGVyaXRWYXJzLm1vZGVsLmNoYW5nZTsKaW5oZXJpdFZhcnMubW9kZWwuY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgb2xkTW9kZWxDaGFuZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAvLyBUT0RPIDogV2hhdCBjYW4gd2UgZG8gdG8gcmVtb3ZlIHRoaXMgZHVwbGljYXRpb24/CiAgdmFyIG1vZGVsT3B0aW9ucyA9IHRoaXMubW9kZWwgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW3RoaXMubW9kZWwuY2lkXTsKICBpZiAobW9kZWxPcHRpb25zICYmIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSkgewogICAgdGhpcy5wb3B1bGF0ZSh0aGlzLm1vZGVsLmF0dHJpYnV0ZXMsIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSA9PT0gdHJ1ZSA/IHt9IDogbW9kZWxPcHRpb25zLnBvcHVsYXRlKTsKICB9Cn07CmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIC8vc2VyaWFsaXplcyBhIGZvcm0gcHJlc2VudCBpbiB0aGUgdmlldywgcmV0dXJuaW5nIHRoZSBzZXJpYWxpemVkIGRhdGEKICAvL2FzIGFuIG9iamVjdAogIC8vcGFzcyB7c2V0OmZhbHNlfSB0byBub3QgdXBkYXRlIHRoaXMubW9kZWwgaWYgcHJlc2VudAogIC8vY2FuIHBhc3Mgb3B0aW9ucywgY2FsbGJhY2sgb3IgZXZlbnQgaW4gYW55IG9yZGVyCiAgc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKICAgIHZhciBjYWxsYmFjaywgb3B0aW9ucywgZXZlbnQ7CiAgICAvL2lnbm9yZSB1bmRlZmluZWQgYXJndW1lbnRzIGluIGNhc2UgZXZlbnQgd2FzIG51bGwKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oYXJndW1lbnRzW2ldKSkgewogICAgICAgIGNhbGxiYWNrID0gYXJndW1lbnRzW2ldOwogICAgICB9IGVsc2UgaWYgKF8uaXNPYmplY3QoYXJndW1lbnRzW2ldKSkgewogICAgICAgIGlmICgnc3RvcFByb3BhZ2F0aW9uJyBpbiBhcmd1bWVudHNbaV0gJiYgJ3ByZXZlbnREZWZhdWx0JyBpbiBhcmd1bWVudHNbaV0pIHsKICAgICAgICAgIGV2ZW50ID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvcHRpb25zID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChldmVudCAmJiAhdGhpcy5fcHJldmVudER1cGxpY2F0ZVN1Ym1pc3Npb24oZXZlbnQpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBvcHRpb25zID0gXy5leHRlbmQoewogICAgICBzZXQ6IHRydWUsCiAgICAgIHZhbGlkYXRlOiB0cnVlLAogICAgICBjaGlsZHJlbjogdHJ1ZSwKICAgICAgc2lsZW50OiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgYXR0cmlidXRlcyA9IG9wdGlvbnMuYXR0cmlidXRlcyB8fCB7fTsKCiAgICAvL2NhbGxiYWNrIGhhcyBjb250ZXh0IG9mIGVsZW1lbnQKICAgIHZhciB2aWV3ID0gdGhpczsKICAgIHZhciBlcnJvcnMgPSBbXTsKICAgIGVhY2hOYW1lZElucHV0LmNhbGwodGhpcywgb3B0aW9ucywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YWx1ZSA9IHZpZXcuX2dldElucHV0VmFsdWUodGhpcywgb3B0aW9ucywgZXJyb3JzKTsKICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgIG9iamVjdEFuZEtleUZyb21BdHRyaWJ1dGVzQW5kTmFtZS5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIHRoaXMubmFtZSwge21vZGU6ICdzZXJpYWxpemUnfSwgZnVuY3Rpb24ob2JqZWN0LCBrZXkpIHsKICAgICAgICAgIGlmICghb2JqZWN0W2tleV0pIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KG9iamVjdFtrZXldKSkgewogICAgICAgICAgICBvYmplY3Rba2V5XS5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9iamVjdFtrZXldID0gW29iamVjdFtrZXldLCB2YWx1ZV07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMudHJpZ2dlcignc2VyaWFsaXplJywgYXR0cmlidXRlcywgb3B0aW9ucyk7CgogICAgaWYgKG9wdGlvbnMudmFsaWRhdGUpIHsKICAgICAgdmFyIHZhbGlkYXRlSW5wdXRFcnJvcnMgPSB0aGlzLnZhbGlkYXRlSW5wdXQoYXR0cmlidXRlcyk7CiAgICAgIGlmICh2YWxpZGF0ZUlucHV0RXJyb3JzICYmIHZhbGlkYXRlSW5wdXRFcnJvcnMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3JzID0gZXJyb3JzLmNvbmNhdCh2YWxpZGF0ZUlucHV0RXJyb3JzKTsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIoJ3ZhbGlkYXRlJywgYXR0cmlidXRlcywgZXJyb3JzLCBvcHRpb25zKTsKICAgICAgaWYgKGVycm9ycy5sZW5ndGgpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgZXJyb3JzKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICBpZiAob3B0aW9ucy5zZXQgJiYgdGhpcy5tb2RlbCkgewogICAgICBpZiAoIXRoaXMubW9kZWwuc2V0KGF0dHJpYnV0ZXMsIHtzaWxlbnQ6IG9wdGlvbnMuc2lsZW50fSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KCiAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIF8uYmluZChyZXNldFN1Ym1pdFN0YXRlLCB0aGlzKSk7CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9LAoKICBfcHJldmVudER1cGxpY2F0ZVN1Ym1pc3Npb246IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjaykgewogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICB2YXIgZm9ybSA9ICQoZXZlbnQudGFyZ2V0KTsKICAgIGlmICgoZXZlbnQudGFyZ2V0LnRhZ05hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgIT09ICdmb3JtJykgewogICAgICAvLyBIYW5kbGUgbm9uLXN1Ym1pdCBldmVudHMgYnkgZ2F0aW5nIG9uIHRoZSBmb3JtCiAgICAgIGZvcm0gPSAkKGV2ZW50LnRhcmdldCkuY2xvc2VzdCgnZm9ybScpOwogICAgfQoKICAgIGlmICghZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JykpIHsKICAgICAgZm9ybS5hdHRyKCdkYXRhLXN1Ym1pdC13YWl0JywgJ3RydWUnKTsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzLCBldmVudCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgLy9wb3B1bGF0ZSBhIGZvcm0gZnJvbSB0aGUgcGFzc2VkIGF0dHJpYnV0ZXMgb3IgdGhpcy5tb2RlbCBpZiBwcmVzZW50CiAgcG9wdWxhdGU6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICB2YXIgdmFsdWUsCiAgICAgICAgYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXMgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwoKICAgIC8vY2FsbGJhY2sgaGFzIGNvbnRleHQgb2YgZWxlbWVudAogICAgZWFjaE5hbWVkSW5wdXQuY2FsbCh0aGlzLCBvcHRpb25zLCBmdW5jdGlvbigpIHsKICAgICAgb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lLmNhbGwodGhpcywgYXR0cmlidXRlcywgdGhpcy5uYW1lLCB7bW9kZTogJ3BvcHVsYXRlJ30sIGZ1bmN0aW9uKG9iamVjdCwga2V5KSB7CiAgICAgICAgdmFsdWUgPSBvYmplY3QgJiYgb2JqZWN0W2tleV07CgogICAgICAgIGlmICghXy5pc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIC8vd2lsbCBvbmx5IGV4ZWN1dGUgaWYgd2UgaGF2ZSBhIG5hbWUgdGhhdCBtYXRjaGVzIHRoZSBzdHJ1Y3R1cmUgaW4gYXR0cmlidXRlcwogICAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JyAmJiBfLmlzQm9vbGVhbih2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5jaGVja2VkID0gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JyB8fCB0aGlzLnR5cGUgPT09ICdyYWRpbycpIHsKICAgICAgICAgICAgdGhpcy5jaGVja2VkID0gdmFsdWUgPT0gdGhpcy52YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CgogICAgdGhpcy50cmlnZ2VyKCdwb3B1bGF0ZScsIGF0dHJpYnV0ZXMpOwogIH0sCgogIC8vcGVyZm9ybSBmb3JtIHZhbGlkYXRpb24sIGltcGxlbWVudGVkIGJ5IGNoaWxkIGNsYXNzCiAgdmFsaWRhdGVJbnB1dDogZnVuY3Rpb24oLyogYXR0cmlidXRlcywgb3B0aW9ucywgZXJyb3JzICovKSB7fSwKCiAgX2dldElucHV0VmFsdWU6IGZ1bmN0aW9uKGlucHV0IC8qICwgb3B0aW9ucywgZXJyb3JzICovKSB7CiAgICBpZiAoaW5wdXQudHlwZSA9PT0gJ2NoZWNrYm94JyB8fCBpbnB1dC50eXBlID09PSAncmFkaW8nKSB7CiAgICAgIGlmIChpbnB1dC5jaGVja2VkKSB7CiAgICAgICAgcmV0dXJuIGlucHV0LnZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlucHV0Lm11bHRpcGxlID09PSB0cnVlKSB7CiAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgJCgnb3B0aW9uJywgaW5wdXQpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWQpIHsKICAgICAgICAgIHZhbHVlcy5wdXNoKHRoaXMudmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaW5wdXQudmFsdWU7CiAgICB9CiAgfQp9KTsKClRob3JheC5WaWV3Lm9uKHsKICBlcnJvcjogZnVuY3Rpb24oKSB7CiAgICByZXNldFN1Ym1pdFN0YXRlLmNhbGwodGhpcyk7CgogICAgLy8gSWYgd2UgZXJyb3JlZCB3aXRoIGEgbW9kZWwgd2Ugd2FudCB0byByZXNldCB0aGUgY29udGVudCBidXQgbGVhdmUgdGhlIFVJCiAgICAvLyBpbnRhY3QuIElmIHRoZSB1c2VyIHVwZGF0ZXMgdGhlIGRhdGEgYW5kIHNlcmlhbGl6ZXMgYW55IG92ZXJ3cml0dGVuIGRhdGEKICAgIC8vIHdpbGwgYmUgcmVzdG9yZWQuCiAgICBpZiAodGhpcy5tb2RlbCAmJiB0aGlzLm1vZGVsLnByZXZpb3VzQXR0cmlidXRlcykgewogICAgICB0aGlzLm1vZGVsLnNldCh0aGlzLm1vZGVsLnByZXZpb3VzQXR0cmlidXRlcygpLCB7CiAgICAgICAgc2lsZW50OiB0cnVlCiAgICAgIH0pOwogICAgfQogIH0sCiAgZGVhY3RpdmF0ZWQ6IGZ1bmN0aW9uKCkgewogICAgcmVzZXRTdWJtaXRTdGF0ZS5jYWxsKHRoaXMpOwogIH0KfSk7CgpmdW5jdGlvbiBlYWNoTmFtZWRJbnB1dChvcHRpb25zLCBpdGVyYXRvciwgY29udGV4dCkgewogIHZhciBpID0gMCwKICAgICAgc2VsZiA9IHRoaXM7CgogIHRoaXMuJCgnc2VsZWN0LGlucHV0LHRleHRhcmVhJywgb3B0aW9ucy5yb290IHx8IHRoaXMuZWwpLmVhY2goZnVuY3Rpb24oKSB7CiAgICBpZiAoIW9wdGlvbnMuY2hpbGRyZW4pIHsKICAgICAgaWYgKHNlbGYgIT09ICQodGhpcykudmlldyh7aGVscGVyOiBmYWxzZX0pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy50eXBlICE9PSAnYnV0dG9uJyAmJiB0aGlzLnR5cGUgIT09ICdjYW5jZWwnICYmIHRoaXMudHlwZSAhPT0gJ3N1Ym1pdCcgJiYgdGhpcy5uYW1lICYmIHRoaXMubmFtZSAhPT0gJycpIHsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0IHx8IHRoaXMsIGksIHRoaXMpOwogICAgICArK2k7CiAgICB9CiAgfSk7Cn0KCi8vY2FsbHMgYSBjYWxsYmFjayB3aXRoIHRoZSBjb3JyZWN0IG9iamVjdCBmcmFnbWVudCBhbmQga2V5IGZyb20gYSBjb21wb3VuZCBuYW1lCmZ1bmN0aW9uIG9iamVjdEFuZEtleUZyb21BdHRyaWJ1dGVzQW5kTmFtZShhdHRyaWJ1dGVzLCBuYW1lLCBvcHRpb25zLCBjYWxsYmFjaykgewogIHZhciBrZXksCiAgICAgIG9iamVjdCA9IGF0dHJpYnV0ZXMsCiAgICAgIGtleXMgPSBuYW1lLnNwbGl0KCdbJyksCiAgICAgIG1vZGUgPSBvcHRpb25zLm1vZGU7CgogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGggLSAxOyArK2kpIHsKICAgIGtleSA9IGtleXNbaV0ucmVwbGFjZSgnXScsICcnKTsKICAgIGlmICghb2JqZWN0W2tleV0pIHsKICAgICAgaWYgKG1vZGUgPT09ICdzZXJpYWxpemUnKSB7CiAgICAgICAgb2JqZWN0W2tleV0gPSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbCh0aGlzLCBmYWxzZSwga2V5KTsKICAgICAgfQogICAgfQogICAgb2JqZWN0ID0gb2JqZWN0W2tleV07CiAgfQogIGtleSA9IGtleXNba2V5cy5sZW5ndGggLSAxXS5yZXBsYWNlKCddJywgJycpOwogIGNhbGxiYWNrLmNhbGwodGhpcywgb2JqZWN0LCBrZXkpOwp9CgpmdW5jdGlvbiByZXNldFN1Ym1pdFN0YXRlKCkgewogIHRoaXMuJCgnZm9ybScpLnJlbW92ZUF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnKTsKfQoKOzsKdmFyIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1sYXlvdXQtY2lkJzsKClRob3JheC5MYXlvdXRWaWV3ID0gVGhvcmF4LlZpZXcuZXh0ZW5kKHsKICBfZGVmYXVsdFRlbXBsYXRlOiBIYW5kbGViYXJzLlZNLm5vb3AsCiAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmICh0aGlzLnRlbXBsYXRlID09PSBIYW5kbGViYXJzLlZNLm5vb3ApIHsKICAgICAgLy8gaWYgdGhlcmUgaXMgbm8gdGVtcGxhdGUgc2V0VmlldyB3aWxsIGFwcGVuZCB0byB0aGlzLiRlbAogICAgICBlbnN1cmVMYXlvdXRDaWQuY2FsbCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIGlmIGEgdGVtcGxhdGUgd2FzIHNwZWNpZmllZCBpcyBtdXN0IGRlY2xhcmUgYSBsYXlvdXQtZWxlbWVudAogICAgICBlbnN1cmVMYXlvdXRWaWV3c1RhcmdldEVsZW1lbnQuY2FsbCh0aGlzKTsKICAgIH0KICAgIHJldHVybiByZXNwb25zZTsKICB9LAogIHNldFZpZXc6IGZ1bmN0aW9uKHZpZXcsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIHNjcm9sbDogdHJ1ZSwKICAgICAgZGVzdHJveTogdHJ1ZQogICAgfSwgb3B0aW9ucyB8fCB7fSk7CiAgICBpZiAoXy5pc1N0cmluZyh2aWV3KSkgewogICAgICB2aWV3ID0gbmV3IChUaG9yYXguVXRpbC5yZWdpc3RyeUdldChUaG9yYXgsICdWaWV3cycsIHZpZXcsIGZhbHNlKSkoKTsKICAgIH0KICAgIHRoaXMuZW5zdXJlUmVuZGVyZWQoKTsKICAgIHZhciBvbGRWaWV3ID0gdGhpcy5fdmlldzsKICAgIGlmICh2aWV3ID09PSBvbGRWaWV3KSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChvcHRpb25zLmRlc3Ryb3kgJiYgdmlldykgewogICAgICB2aWV3Ll9zaG91bGREZXN0cm95T25OZXh0U2V0VmlldyA9IHRydWU7CiAgICB9CgogICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6dmlldzpzdGFydCcsIHZpZXcsIG9sZFZpZXcsIG9wdGlvbnMpOwoKICAgIGlmIChvbGRWaWV3KSB7CiAgICAgIHRoaXMuX3JlbW92ZUNoaWxkKG9sZFZpZXcpOwogICAgICBvbGRWaWV3LiRlbC5yZW1vdmUoKTsKICAgICAgdHJpZ2dlckxpZmVjeWNsZUV2ZW50LmNhbGwob2xkVmlldywgJ2RlYWN0aXZhdGVkJywgb3B0aW9ucyk7CiAgICAgIGlmIChvbGRWaWV3Ll9zaG91bGREZXN0cm95T25OZXh0U2V0VmlldykgewogICAgICAgIG9sZFZpZXcuZGVzdHJveSgpOwogICAgICB9CiAgICB9CgogICAgaWYgKHZpZXcpIHsKICAgICAgdHJpZ2dlckxpZmVjeWNsZUV2ZW50LmNhbGwodGhpcywgJ2FjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICB2aWV3LnRyaWdnZXIoJ2FjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9hZGRDaGlsZCh2aWV3KTsKICAgICAgdGhpcy5fdmlldyA9IHZpZXc7CiAgICAgIHRoaXMuX3ZpZXcuYXBwZW5kVG8oZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50LmNhbGwodGhpcykpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdmlldyA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTp2aWV3OmVuZCcsIHZpZXcsIG9sZFZpZXcsIG9wdGlvbnMpOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgZ2V0VmlldzogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fdmlldzsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbGF5b3V0LWVsZW1lbnQnLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIHZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3OwogIC8vIGR1Y2sgdHlwZSBjaGVjayBmb3IgTGF5b3V0VmlldwogIGlmICghdmlldy5nZXRWaWV3KSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ2xheW91dC1lbGVtZW50IG11c3QgYmUgdXNlZCB3aXRoaW4gYSBMYXlvdXRWaWV3Jyk7CiAgfQogIG9wdGlvbnMuaGFzaFtsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lXSA9IHZpZXcuY2lkOwogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMuaGFzaCk7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnLmNhbGwodGhpcywgb3B0aW9ucy5oYXNoLCAnJywgdGhpcykpOwp9KTsKCmZ1bmN0aW9uIHRyaWdnZXJMaWZlY3ljbGVFdmVudChldmVudE5hbWUsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBvcHRpb25zLnRhcmdldCA9IHRoaXM7CiAgdGhpcy50cmlnZ2VyKGV2ZW50TmFtZSwgb3B0aW9ucyk7CiAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICBjaGlsZC50cmlnZ2VyKGV2ZW50TmFtZSwgb3B0aW9ucyk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGVuc3VyZUxheW91dENpZCgpIHsKICArK3RoaXMuX3JlbmRlckNvdW50OwogIC8vc2V0IHRoZSBsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lIG9uIHRoaXMuJGVsIGlmIHRoZXJlIHdhcyBubyB0ZW1wbGF0ZQogIHRoaXMuJGVsLmF0dHIobGF5b3V0Q2lkQXR0cmlidXRlTmFtZSwgdGhpcy5jaWQpOwp9CgpmdW5jdGlvbiBlbnN1cmVMYXlvdXRWaWV3c1RhcmdldEVsZW1lbnQoKSB7CiAgaWYgKCF0aGlzLiQoJ1snICsgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSArICc9IicgKyB0aGlzLmNpZCArICciXScpWzBdKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGxheW91dCBlbGVtZW50IGZvdW5kIGluICcgKyAodGhpcy5uYW1lIHx8IHRoaXMuY2lkKSk7CiAgfQp9CgpmdW5jdGlvbiBnZXRMYXlvdXRWaWV3c1RhcmdldEVsZW1lbnQoKSB7CiAgcmV0dXJuIHRoaXMuJCgnWycgKyBsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIHRoaXMuY2lkICsgJyJdJylbMF0gfHwgdGhpcy5lbFswXSB8fCB0aGlzLmVsOwp9Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXIgKi8KCi8vUm91dGVyCmZ1bmN0aW9uIGluaXRpYWxpemVSb3V0ZXIoKSB7CiAgQmFja2JvbmUuaGlzdG9yeSB8fCAoQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBCYWNrYm9uZS5IaXN0b3J5KCkpOwogIEJhY2tib25lLmhpc3Rvcnkub24oJ3JvdXRlJywgb25Sb3V0ZSwgdGhpcyk7CiAgLy9yb3V0ZXIgZG9lcyBub3QgaGF2ZSBhIGJ1aWx0IGluIGRlc3Ryb3kgZXZlbnQKICAvL2J1dCBWaWV3Q29udHJvbGxlciBkb2VzCiAgdGhpcy5vbignZGVzdHJveWVkJywgZnVuY3Rpb24oKSB7CiAgICBCYWNrYm9uZS5oaXN0b3J5Lm9mZigncm91dGUnLCBvblJvdXRlLCB0aGlzKTsKICB9KTsKfQoKVGhvcmF4LlJvdXRlciA9IEJhY2tib25lLlJvdXRlci5leHRlbmQoewogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IFRob3JheC5Sb3V0ZXIuX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpbml0aWFsaXplUm91dGVyLmNhbGwodGhpcyk7CiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgIH0KICAgIC8vYWRkIGEgcm91dGU6YmVmb3JlIGV2ZW50IHRoYXQgaXMgZmlyZWQgYmVmb3JlIHRoZSBjYWxsYmFjayBpcyBjYWxsZWQKICAgIHJldHVybiBCYWNrYm9uZS5Sb3V0ZXIucHJvdG90eXBlLnJvdXRlLmNhbGwodGhpcywgcm91dGUsIG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZTpiZWZvcmUnLCByb3V0ZSwgbmFtZV0uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9KTsKICB9Cn0pOwoKVGhvcmF4LlJvdXRlcnMgPSB7fTsKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5Sb3V0ZXIsIFRob3JheC5Sb3V0ZXJzKTsKCmZ1bmN0aW9uIG9uUm91dGUocm91dGVyIC8qICwgbmFtZSAqLykgewogIGlmICh0aGlzID09PSByb3V0ZXIpIHsKICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBbJ3JvdXRlJ10uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICB9Cn0KCjs7ClRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldyA9IFRob3JheC5Db2xsZWN0aW9uVmlldy5leHRlbmQoewogIC8vIEZvcndhcmQgcmVuZGVyIGV2ZW50cyB0byB0aGUgcGFyZW50CiAgZXZlbnRzOiB7CiAgICAncmVuZGVyZWQ6aXRlbSc6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6aXRlbScpLAogICAgJ3JlbmRlcmVkOmNvbGxlY3Rpb24nOiBmb3J3YXJkUmVuZGVyRXZlbnQoJ3JlbmRlcmVkOmNvbGxlY3Rpb24nKSwKICAgICdyZW5kZXJlZDplbXB0eSc6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6ZW1wdHknKQogIH0sCgogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBfLmVhY2goY29sbGVjdGlvbk9wdGlvbk5hbWVzLCBmdW5jdGlvbih2aWV3QXR0cmlidXRlTmFtZSwgaGVscGVyT3B0aW9uTmFtZSkgewogICAgICBpZiAob3B0aW9ucy5vcHRpb25zW2hlbHBlck9wdGlvbk5hbWVdKSB7CiAgICAgICAgdmFyIHZhbHVlID0gb3B0aW9ucy5vcHRpb25zW2hlbHBlck9wdGlvbk5hbWVdOwogICAgICAgIGlmICh2aWV3QXR0cmlidXRlTmFtZSA9PT0gJ2l0ZW1UZW1wbGF0ZScgfHwgdmlld0F0dHJpYnV0ZU5hbWUgPT09ICdlbXB0eVRlbXBsYXRlJykgewogICAgICAgICAgdmFsdWUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIG9wdGlvbnNbdmlld0F0dHJpYnV0ZU5hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgIH0pOwogICAgLy8gSGFuZGxlYmFycy5WTS5ub29wIGlzIHBhc3NlZCBpbiB0aGUgaGFuZGxlYmFycyBvcHRpb25zIG9iamVjdCBhcwogICAgLy8gYSBkZWZhdWx0IGZvciBmbiBhbmQgaW52ZXJzZSwgaWYgYSBibG9jayB3YXMgcHJlc2VudC4gTmVlZCB0bwogICAgLy8gY2hlY2sgdG8gZW5zdXJlIHdlIGRvbid0IHBpY2sgdGhlIGVtcHR5IC8gbnVsbCBibG9jayB1cC4KICAgIGlmICghb3B0aW9ucy5pdGVtVGVtcGxhdGUgJiYgb3B0aW9ucy50ZW1wbGF0ZSAmJiBvcHRpb25zLnRlbXBsYXRlICE9PSBIYW5kbGViYXJzLlZNLm5vb3ApIHsKICAgICAgb3B0aW9ucy5pdGVtVGVtcGxhdGUgPSBvcHRpb25zLnRlbXBsYXRlOwogICAgICBvcHRpb25zLnRlbXBsYXRlID0gSGFuZGxlYmFycy5WTS5ub29wOwogICAgfQogICAgaWYgKCFvcHRpb25zLmVtcHR5VGVtcGxhdGUgJiYgb3B0aW9ucy5pbnZlcnNlICYmIG9wdGlvbnMuaW52ZXJzZSAhPT0gSGFuZGxlYmFycy5WTS5ub29wKSB7CiAgICAgIG9wdGlvbnMuZW1wdHlUZW1wbGF0ZSA9IG9wdGlvbnMuaW52ZXJzZTsKICAgICAgb3B0aW9ucy5pbnZlcnNlID0gSGFuZGxlYmFycy5WTS5ub29wOwogICAgfQogICAgdmFyIHJlc3BvbnNlID0gVGhvcmF4LkhlbHBlclZpZXcuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgIGlmICh0aGlzLnBhcmVudC5uYW1lKSB7CiAgICAgIGlmICghdGhpcy5lbXB0eVRlbXBsYXRlKSB7CiAgICAgICAgdGhpcy5lbXB0eVRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGhpcy5wYXJlbnQubmFtZSArICctZW1wdHknLCB0cnVlKTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuaXRlbVRlbXBsYXRlKSB7CiAgICAgICAgLy8gaXRlbSB0ZW1wbGF0ZSBtdXN0IGJlIHByZXNlbnQgaWYgYW4gaXRlbVZpZXcgaXMgbm90CiAgICAgICAgdGhpcy5pdGVtVGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLnBhcmVudC5uYW1lICsgJy1pdGVtJywgISF0aGlzLml0ZW1WaWV3KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXNwb25zZTsKICB9LAogIHNldEFzUHJpbWFyeUNvbGxlY3Rpb25IZWxwZXI6IGZ1bmN0aW9uKCkgewogICAgXy5lYWNoKGZvcndhcmRhYmxlUHJvcGVydGllcywgZnVuY3Rpb24ocHJvcGVydHlOYW1lKSB7CiAgICAgIGZvcndhcmRNaXNzaW5nUHJvcGVydHkuY2FsbCh0aGlzLCBwcm9wZXJ0eU5hbWUpOwogICAgfSwgdGhpcyk7CiAgICBpZiAodGhpcy5wYXJlbnQuaXRlbUZpbHRlciAmJiAhdGhpcy5pdGVtRmlsdGVyKSB7CiAgICAgIHRoaXMuaXRlbUZpbHRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBhcmVudC5pdGVtRmlsdGVyLmFwcGx5KHRoaXMucGFyZW50LCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogICAgaWYgKHRoaXMucGFyZW50Lml0ZW1Db250ZXh0KSB7CiAgICAgIHRoaXMuaXRlbUNvbnRleHQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQuaXRlbUNvbnRleHQuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CiAgfQp9KTsKCl8uZXh0ZW5kKFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5wcm90b3R5cGUsIGhlbHBlclZpZXdQcm90b3R5cGUpOwoKdmFyIGNvbGxlY3Rpb25PcHRpb25OYW1lcyA9IHsKICAnaXRlbS10ZW1wbGF0ZSc6ICdpdGVtVGVtcGxhdGUnLAogICdlbXB0eS10ZW1wbGF0ZSc6ICdlbXB0eVRlbXBsYXRlJywKICAnaXRlbS12aWV3JzogJ2l0ZW1WaWV3JywKICAnZW1wdHktdmlldyc6ICdlbXB0eVZpZXcnLAogICdlbXB0eS1jbGFzcyc6ICdlbXB0eUNsYXNzJwp9OwoKZnVuY3Rpb24gZm9yd2FyZFJlbmRlckV2ZW50KGV2ZW50TmFtZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyk7CiAgICBhcmdzLnVuc2hpZnQoZXZlbnROYW1lKTsKICAgIHRoaXMucGFyZW50LnRyaWdnZXIuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3MpOwogIH0KfQoKdmFyIGZvcndhcmRhYmxlUHJvcGVydGllcyA9IFsKICAnaXRlbVRlbXBsYXRlJywKICAnaXRlbVZpZXcnLAogICdlbXB0eVRlbXBsYXRlJywKICAnZW1wdHlWaWV3JwpdOwoKZnVuY3Rpb24gZm9yd2FyZE1pc3NpbmdQcm9wZXJ0eShwcm9wZXJ0eU5hbWUpIHsKICB2YXIgcGFyZW50ID0gZ2V0UGFyZW50KHRoaXMpOwogIGlmICghdGhpc1twcm9wZXJ0eU5hbWVdKSB7CiAgICB2YXIgcHJvcCA9IHBhcmVudFtwcm9wZXJ0eU5hbWVdOwogICAgaWYgKHByb3ApewogICAgICB0aGlzW3Byb3BlcnR5TmFtZV0gPSBwcm9wOwogICAgfQogIH0KfQoKSGFuZGxlYmFycy5yZWdpc3RlclZpZXdIZWxwZXIoJ2NvbGxlY3Rpb24nLCBUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcsIGZ1bmN0aW9uKGNvbGxlY3Rpb24sIHZpZXcpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgdmlldyA9IGNvbGxlY3Rpb247CiAgICBjb2xsZWN0aW9uID0gdmlldy5wYXJlbnQuY29sbGVjdGlvbjsKICAgIGNvbGxlY3Rpb24gJiYgdmlldy5zZXRBc1ByaW1hcnlDb2xsZWN0aW9uSGVscGVyKCk7CiAgICB2aWV3LiRlbC5hdHRyKGNvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZSwgJ3RydWUnKTsKICAgIC8vIHByb3BhZ2F0ZSBmdXR1cmUgY2hhbmdlcyB0byB0aGUgcGFyZW50J3MgY29sbGVjdGlvbiBvYmplY3QKICAgIC8vIHRvIHRoZSBoZWxwZXIgdmlldwogICAgdmlldy5saXN0ZW5Ubyh2aWV3LnBhcmVudCwgJ2NoYW5nZTpkYXRhLW9iamVjdCcsIGZ1bmN0aW9uKHR5cGUsIGRhdGFPYmplY3QpIHsKICAgICAgaWYgKHR5cGUgPT09ICdjb2xsZWN0aW9uJykgewogICAgICAgIHZpZXcuc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcigpOwogICAgICAgIHZpZXcuc2V0Q29sbGVjdGlvbihkYXRhT2JqZWN0KTsKICAgICAgfQogICAgfSk7CiAgfQogIGNvbGxlY3Rpb24gJiYgdmlldy5zZXRDb2xsZWN0aW9uKGNvbGxlY3Rpb24pOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2NvbGxlY3Rpb24tZWxlbWVudCcsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBpZiAoIWdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcucmVuZGVyQ29sbGVjdGlvbikgewogICAgdGhyb3cgbmV3IEVycm9yKCJjb2xsZWN0aW9uLWVsZW1lbnQgaGVscGVyIG11c3QgYmUgZGVjbGFyZWQgaW5zaWRlIG9mIGEgQ29sbGVjdGlvblZpZXciKTsKICB9CiAgdmFyIGhhc2ggPSBvcHRpb25zLmhhc2g7CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMoaGFzaCk7CiAgaGFzaC50YWdOYW1lID0gaGFzaC50YWdOYW1lIHx8ICdkaXYnOwogIGhhc2hbY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnLmNhbGwodGhpcywgaGFzaCwgJycsIHRoaXMpKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlbXB0eScsIGZ1bmN0aW9uKGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgb3B0aW9ucyA9IGRhdGFPYmplY3Q7CiAgfQogIHZhciB2aWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgZGF0YU9iamVjdCA9IHZpZXcubW9kZWw7CiAgfQogIC8vIGxpc3RlbmVycyBmb3IgdGhlIGVtcHR5IGhlbHBlciByYXRoZXIgdGhhbiBsaXN0ZW5lcnMKICAvLyB0aGF0IGFyZSB0aGVtc2VsdmVzIGVtcHR5CiAgaWYgKCF2aWV3Ll9lbXB0eUxpc3RlbmVycykgewogICAgdmlldy5fZW1wdHlMaXN0ZW5lcnMgPSB7fTsKICB9CiAgLy8gZHVjayB0eXBlIGNoZWNrIGZvciBjb2xsZWN0aW9uCiAgaWYgKGRhdGFPYmplY3QgJiYgIXZpZXcuX2VtcHR5TGlzdGVuZXJzW2RhdGFPYmplY3QuY2lkXSAmJiBkYXRhT2JqZWN0Lm1vZGVscyAmJiAoJ2xlbmd0aCcgaW4gZGF0YU9iamVjdCkpIHsKICAgIHZpZXcuX2VtcHR5TGlzdGVuZXJzW2RhdGFPYmplY3QuY2lkXSA9IHRydWU7CiAgICB2aWV3Lmxpc3RlblRvKGRhdGFPYmplY3QsICdyZW1vdmUnLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGRhdGFPYmplY3QubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdmlldy5yZW5kZXIoKTsKICAgICAgfQogICAgfSk7CiAgICB2aWV3Lmxpc3RlblRvKGRhdGFPYmplY3QsICdhZGQnLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGRhdGFPYmplY3QubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdmlldy5yZW5kZXIoKTsKICAgICAgfQogICAgfSk7CiAgICB2aWV3Lmxpc3RlblRvKGRhdGFPYmplY3QsICdyZXNldCcsIGZ1bmN0aW9uKCkgewogICAgICB2aWV3LnJlbmRlcigpOwogICAgfSk7CiAgfQogIHJldHVybiAhZGF0YU9iamVjdCB8fCBkYXRhT2JqZWN0LmlzRW1wdHkoKSA/IG9wdGlvbnMuZm4odGhpcykgOiBvcHRpb25zLmludmVyc2UodGhpcyk7Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndGVtcGxhdGUnLCBmdW5jdGlvbihuYW1lLCBvcHRpb25zKSB7CiAgdmFyIGNvbnRleHQgPSBfLmV4dGVuZCh7Zm46IG9wdGlvbnMgJiYgb3B0aW9ucy5mbn0sIHRoaXMsIG9wdGlvbnMgPyBvcHRpb25zLmhhc2ggOiB7fSk7CiAgdmFyIG91dHB1dCA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcucmVuZGVyVGVtcGxhdGUobmFtZSwgY29udGV4dCk7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcob3V0cHV0KTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd5aWVsZCcsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICByZXR1cm4gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykueWllbGQgJiYgb3B0aW9ucy5kYXRhLnlpZWxkKCk7Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndXJsJywgZnVuY3Rpb24odXJsKSB7CiAgdmFyIGZyYWdtZW50OwogIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMikgewogICAgZnJhZ21lbnQgPSBfLm1hcChfLmhlYWQoYXJndW1lbnRzLCBhcmd1bWVudHMubGVuZ3RoIC0gMSksIGVuY29kZVVSSUNvbXBvbmVudCkuam9pbignLycpOwogIH0gZWxzZSB7CiAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50c1sxXSwKICAgICAgICBoYXNoID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5oYXNoKSB8fCBvcHRpb25zOwogICAgaWYgKGhhc2ggJiYgaGFzaFsnZXhwYW5kLXRva2VucyddKSB7CiAgICAgIGZyYWdtZW50ID0gVGhvcmF4LlV0aWwuZXhwYW5kVG9rZW4odXJsLCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIGZyYWdtZW50ID0gdXJsOwogICAgfQogIH0KICByZXR1cm4gKEJhY2tib25lLmhpc3RvcnkuX2hhc1B1c2hTdGF0ZSA/IEJhY2tib25lLmhpc3Rvcnkub3B0aW9ucy5yb290IDogJyMnKSArIGZyYWdtZW50Owp9KTsKCjs7Ci8qZ2xvYmFsIHZpZXdUZW1wbGF0ZU92ZXJyaWRlcyAqLwpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcigndmlldycsIHsKICBmYWN0b3J5OiBmdW5jdGlvbihhcmdzLCBvcHRpb25zKSB7CiAgICB2YXIgVmlldyA9IGFyZ3MubGVuZ3RoID49IDEgPyBhcmdzWzBdIDogVGhvcmF4LlZpZXc7CiAgICByZXR1cm4gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKFZpZXcsIG9wdGlvbnMub3B0aW9ucyk7CiAgfSwKICBjYWxsYmFjazogZnVuY3Rpb24oKSB7CiAgICB2YXIgaW5zdGFuY2UgPSBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aC0xXSwKICAgICAgICBvcHRpb25zID0gaW5zdGFuY2UuX2hlbHBlck9wdGlvbnMub3B0aW9ucywKICAgICAgICBwbGFjZWhvbGRlcklkID0gaW5zdGFuY2UuY2lkOwoKICAgIGlmIChvcHRpb25zLmZuKSB7CiAgICAgIHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXSA9IG9wdGlvbnMuZm47CiAgICB9CiAgfQp9KTsKCjs7CnZhciBjYWxsTWV0aG9kQXR0cmlidXRlTmFtZSA9ICdkYXRhLWNhbGwtbWV0aG9kJywKICAgIHRyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS10cmlnZ2VyLWV2ZW50JzsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2J1dHRvbicsIGZ1bmN0aW9uKG1ldGhvZCwgb3B0aW9ucykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICBvcHRpb25zID0gbWV0aG9kOwogICAgbWV0aG9kID0gb3B0aW9ucy5oYXNoLm1ldGhvZDsKICB9CiAgdmFyIGhhc2ggPSBvcHRpb25zLmhhc2gsCiAgICAgIGV4cGFuZFRva2VucyA9IGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBkZWxldGUgaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGlmICghbWV0aG9kICYmICFvcHRpb25zLmhhc2gudHJpZ2dlcikgewogICAgdGhyb3cgbmV3IEVycm9yKCJidXR0b24gaGVscGVyIG11c3QgaGF2ZSBhIG1ldGhvZCBuYW1lIGFzIHRoZSBmaXJzdCBhcmd1bWVudCBvciBhICd0cmlnZ2VyJywgb3IgYSAnbWV0aG9kJyBhdHRyaWJ1dGUgc3BlY2lmaWVkLiIpOwogIH0KICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhoYXNoKTsKICBoYXNoLnRhZ05hbWUgPSBoYXNoLnRhZ05hbWUgfHwgJ2J1dHRvbic7CiAgaGFzaC50cmlnZ2VyICYmIChoYXNoW3RyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWVdID0gaGFzaC50cmlnZ2VyKTsKICBkZWxldGUgaGFzaC50cmlnZ2VyOwogIG1ldGhvZCAmJiAoaGFzaFtjYWxsTWV0aG9kQXR0cmlidXRlTmFtZV0gPSBtZXRob2QpOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhoYXNoLCBvcHRpb25zLmZuID8gb3B0aW9ucy5mbih0aGlzKSA6ICcnLCBleHBhbmRUb2tlbnMgPyB0aGlzIDogbnVsbCkpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xpbmsnLCBmdW5jdGlvbigpIHsKICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpLAogICAgICBvcHRpb25zID0gYXJncy5wb3AoKSwKICAgICAgaGFzaCA9IG9wdGlvbnMuaGFzaCwKICAgICAgLy8gdXJsIGlzIGFuIGFycmF5IHRoYXQgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIHVybCBoZWxwZXIKICAgICAgdXJsID0gYXJncy5sZW5ndGggPT09IDAgPyBbaGFzaC5ocmVmXSA6IGFyZ3MsCiAgICAgIGV4cGFuZFRva2VucyA9IGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBkZWxldGUgaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGlmICghdXJsWzBdICYmIHVybFswXSAhPT0gJycpIHsKICAgIHRocm93IG5ldyBFcnJvcigibGluayBoZWxwZXIgcmVxdWlyZXMgYW4gaHJlZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQgb3IgYW4gJ2hyZWYnIGF0dHJpYnV0ZSIpOwogIH0KICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhoYXNoKTsKICB1cmwucHVzaChvcHRpb25zKTsKICBoYXNoLmhyZWYgPSBIYW5kbGViYXJzLmhlbHBlcnMudXJsLmFwcGx5KHRoaXMsIHVybCk7CiAgaGFzaC50YWdOYW1lID0gaGFzaC50YWdOYW1lIHx8ICdhJzsKICBoYXNoLnRyaWdnZXIgJiYgKGhhc2hbdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZV0gPSBvcHRpb25zLmhhc2gudHJpZ2dlcik7CiAgZGVsZXRlIGhhc2gudHJpZ2dlcjsKICBoYXNoW2NhbGxNZXRob2RBdHRyaWJ1dGVOYW1lXSA9ICdfYW5jaG9yQ2xpY2snOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhoYXNoLCBvcHRpb25zLmZuID8gb3B0aW9ucy5mbih0aGlzKSA6ICcnLCBleHBhbmRUb2tlbnMgPyB0aGlzIDogbnVsbCkpOwp9KTsKCnZhciBjbGlja1NlbGVjdG9yID0gJ1snICsgY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWUgKyAnXSwgWycgKyB0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lICsgJ10nOwoKZnVuY3Rpb24gaGFuZGxlQ2xpY2soZXZlbnQpIHsKICB2YXIgdGFyZ2V0ID0gJChldmVudC50YXJnZXQpLAogICAgICB2aWV3ID0gdGFyZ2V0LnZpZXcoe2hlbHBlcjogZmFsc2V9KSwKICAgICAgbWV0aG9kTmFtZSA9IHRhcmdldC5hdHRyKGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lKSwKICAgICAgZXZlbnROYW1lID0gdGFyZ2V0LmF0dHIodHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSksCiAgICAgIG1ldGhvZFJlc3BvbnNlID0gZmFsc2U7CiAgbWV0aG9kTmFtZSAmJiAobWV0aG9kUmVzcG9uc2UgPSB2aWV3W21ldGhvZE5hbWVdLmNhbGwodmlldywgZXZlbnQpKTsKICBldmVudE5hbWUgJiYgdmlldy50cmlnZ2VyKGV2ZW50TmFtZSwgZXZlbnQpOwogIHRhcmdldC50YWdOYW1lID09PSAiQSIgJiYgbWV0aG9kUmVzcG9uc2UgPT09IGZhbHNlICYmIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cn0KCnZhciBsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lOwoKZnVuY3Rpb24gcmVnaXN0ZXJDbGlja0hhbmRsZXIoKSB7CiAgdW5yZWdpc3RlckNsaWNrSGFuZGxlcigpOwogIGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUgPSBUaG9yYXguX2Zhc3RDbGlja0V2ZW50TmFtZSB8fCAnY2xpY2snOwogICQoZG9jdW1lbnQpLm9uKGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUsIGNsaWNrU2VsZWN0b3IsIGhhbmRsZUNsaWNrKTsKfQoKZnVuY3Rpb24gdW5yZWdpc3RlckNsaWNrSGFuZGxlcigpIHsKICBsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lICYmICQoZG9jdW1lbnQpLm9mZihsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lLCBjbGlja1NlbGVjdG9yLCBoYW5kbGVDbGljayk7Cn0KCiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkgewogIGlmICghVGhvcmF4Ll9mYXN0Q2xpY2tFdmVudE5hbWUpIHsKICAgIHJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCk7CiAgfQp9KTsKCjs7CnZhciBlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtZWxlbWVudC10bXAnOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignZWxlbWVudCcsIGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhvcHRpb25zLmhhc2gpOwogIHZhciBjaWQgPSBfLnVuaXF1ZUlkKCdlbGVtZW50JyksCiAgICAgIGRlY2xhcmluZ1ZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3LAogICAgICBodG1sQXR0cmlidXRlcyA9IF8ucGljayhvcHRpb25zLmhhc2gsIGh0bWxBdHRyaWJ1dGVzVG9Db3B5KTsKICBodG1sQXR0cmlidXRlc1tlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lXSA9IGNpZDsKICBkZWNsYXJpbmdWaWV3Ll9lbGVtZW50c0J5Q2lkIHx8IChkZWNsYXJpbmdWaWV3Ll9lbGVtZW50c0J5Q2lkID0ge30pOwogIGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWRbY2lkXSA9IGVsZW1lbnQ7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnKGh0bWxBdHRyaWJ1dGVzKSk7Cn0pOwoKVGhvcmF4LlZpZXcub24oJ2FwcGVuZCcsIGZ1bmN0aW9uKHNjb3BlLCBjYWxsYmFjaykgewogIChzY29wZSB8fCB0aGlzLiRlbCkuZmluZCgnWycgKyBlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lICsgJ10nKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICB2YXIgJGVsID0gJChlbCksCiAgICAgICAgY2lkID0gJGVsLmF0dHIoZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSksCiAgICAgICAgZWxlbWVudCA9IHRoaXMuX2VsZW1lbnRzQnlDaWRbY2lkXTsKICAgIC8vIEEgY2FsbGJhY2sgZnVuY3Rpb24gbWF5IGJlIHNwZWNpZmllZCBhcyB0aGUgdmFsdWUKICAgIGlmIChfLmlzRnVuY3Rpb24oZWxlbWVudCkpIHsKICAgICAgZWxlbWVudCA9IGVsZW1lbnQuY2FsbCh0aGlzKTsKICAgIH0KICAgICRlbC5yZXBsYWNlV2l0aChlbGVtZW50KTsKICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKGVsZW1lbnQpOwogIH0sIHRoaXMpOwp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3N1cGVyJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldywKICAgICAgcGFyZW50ID0gZGVjbGFyaW5nVmlldy5jb25zdHJ1Y3RvciAmJiBkZWNsYXJpbmdWaWV3LmNvbnN0cnVjdG9yLl9fc3VwZXJfXzsKICBpZiAocGFyZW50KSB7CiAgICB2YXIgdGVtcGxhdGUgPSBwYXJlbnQudGVtcGxhdGU7CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIGlmICghcGFyZW50Lm5hbWUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCB1c2Ugc3VwZXIgaGVscGVyIHdoZW4gcGFyZW50IGhhcyBubyBuYW1lIG9yIHRlbXBsYXRlLicpOwogICAgICB9CiAgICAgIHRlbXBsYXRlID0gcGFyZW50Lm5hbWU7CiAgICB9CiAgICBpZiAoXy5pc1N0cmluZyh0ZW1wbGF0ZSkpIHsKICAgICAgdGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0ZW1wbGF0ZSwgZmFsc2UpOwogICAgfQogICAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcodGVtcGxhdGUodGhpcywgb3B0aW9ucykpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gJyc7CiAgfQp9KTsKCjs7Ci8qZ2xvYmFsIGNvbGxlY3Rpb25PcHRpb25OYW1lcywgaW5oZXJpdFZhcnMgKi8KCnZhciBsb2FkU3RhcnQgPSAnbG9hZDpzdGFydCcsCiAgICBsb2FkRW5kID0gJ2xvYWQ6ZW5kJywKICAgIHJvb3RPYmplY3Q7CgpUaG9yYXguc2V0Um9vdE9iamVjdCA9IGZ1bmN0aW9uKG9iaikgewogIHJvb3RPYmplY3QgPSBvYmo7Cn07CgpUaG9yYXgubG9hZEhhbmRsZXIgPSBmdW5jdGlvbihzdGFydCwgZW5kLCBjb250ZXh0KSB7CiAgdmFyIGxvYWRDb3VudGVyID0gXy51bmlxdWVJZCgpOwogIHJldHVybiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgIHZhciBzZWxmID0gY29udGV4dCB8fCB0aGlzOwogICAgc2VsZi5fbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mbyB8fCBbXTsKICAgIHZhciBsb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvW2xvYWRDb3VudGVyXTsKCiAgICBmdW5jdGlvbiBzdGFydExvYWRUaW1lb3V0KCkgewoKICAgICAgLy8gSWYgdGhlIHRpbWVvdXQgaGFzIGJlZW4gc2V0IGFscmVhZHkgYnV0IGhhcyBub3QgdHJpZ2dlcmVkIHlldCBkbyBub3RoaW5nCiAgICAgIC8vIE90aGVyd2lzZSBzZXQgYSBuZXcgdGltZW91dCAoZWl0aGVyIGluaXRpYWwgb3IgZm9yIGdvaW5nIGZyb20gYmFja2dyb3VuZCB0bwogICAgICAvLyBub24tYmFja2dyb3VuZCBsb2FkaW5nKQogICAgICBpZiAobG9hZEluZm8udGltZW91dCAmJiAhbG9hZEluZm8ucnVuKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgbG9hZGluZ1RpbWVvdXQgPSBzZWxmLl9sb2FkaW5nVGltZW91dER1cmF0aW9uICE9PSB1bmRlZmluZWQgPwogICAgICAgIHNlbGYuX2xvYWRpbmdUaW1lb3V0RHVyYXRpb24gOiBUaG9yYXguVmlldy5wcm90b3R5cGUuX2xvYWRpbmdUaW1lb3V0RHVyYXRpb247CiAgICAgIGxvYWRJbmZvLnRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbG9hZEluZm8ucnVuID0gdHJ1ZTsKICAgICAgICAgICAgc3RhcnQuY2FsbChzZWxmLCBsb2FkSW5mby5tZXNzYWdlLCBsb2FkSW5mby5iYWNrZ3JvdW5kLCBsb2FkSW5mbyk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIFRob3JheC5vbkV4Y2VwdGlvbignbG9hZFN0YXJ0JywgZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwgbG9hZGluZ1RpbWVvdXQgKiAxMDAwKTsKICAgIH0KCiAgICBpZiAoIWxvYWRJbmZvKSB7CiAgICAgIGxvYWRJbmZvID0gc2VsZi5fbG9hZEluZm9bbG9hZENvdW50ZXJdID0gXy5leHRlbmQoewogICAgICAgIGV2ZW50czogW10sCiAgICAgICAgdGltZW91dDogMCwKICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLAogICAgICAgIGJhY2tncm91bmQ6ICEhYmFja2dyb3VuZAogICAgICB9LCBCYWNrYm9uZS5FdmVudHMpOwogICAgICBzdGFydExvYWRUaW1lb3V0KCk7CiAgICB9IGVsc2UgewogICAgICBjbGVhclRpbWVvdXQobG9hZEluZm8uZW5kVGltZW91dCk7CgogICAgICBsb2FkSW5mby5tZXNzYWdlID0gbWVzc2FnZTsKICAgICAgaWYgKCFiYWNrZ3JvdW5kICYmIGxvYWRJbmZvLmJhY2tncm91bmQpIHsKICAgICAgICBsb2FkSW5mby5iYWNrZ3JvdW5kID0gZmFsc2U7CiAgICAgICAgc3RhcnRMb2FkVGltZW91dCgpOwogICAgICB9CiAgICB9CgogICAgLy8gUHJldmVudCBiaW5kcyB0byB0aGUgc2FtZSBvYmplY3QgbXVsdGlwbGUgdGltZXMgYXMgdGhpcyBjYW4gY2F1c2UgdmVyeSBiYWQgdGhpbmdzCiAgICAvLyB0byBoYXBwZW4gZm9yIHRoZSBsb2FkO2xvYWQ7ZW5kO2VuZCBleGVjdXRpb24gZmxvdy4KICAgIGlmIChsb2FkSW5mby5ldmVudHMuaW5kZXhPZihvYmplY3QpID49IDApIHsKICAgICAgbG9hZEluZm8uZXZlbnRzLnB1c2gob2JqZWN0KTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGxvYWRJbmZvLmV2ZW50cy5wdXNoKG9iamVjdCk7CgogICAgb2JqZWN0Lm9uKGxvYWRFbmQsIGZ1bmN0aW9uIGVuZENhbGxiYWNrKCkgewogICAgICB2YXIgbG9hZGluZ0VuZFRpbWVvdXQgPSBzZWxmLl9sb2FkaW5nVGltZW91dEVuZER1cmF0aW9uOwogICAgICBpZiAobG9hZGluZ0VuZFRpbWVvdXQgPT09IHZvaWQgMCkgewogICAgICAgIC8vIElmIHdlIGFyZSBydW5uaW5nIG9uIGEgbm9uLXZpZXcgb2JqZWN0IHB1bGwgdGhlIGRlZmF1bHQgdGltZW91dAogICAgICAgIGxvYWRpbmdFbmRUaW1lb3V0ID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLl9sb2FkaW5nVGltZW91dEVuZER1cmF0aW9uOwogICAgICB9CgogICAgICB2YXIgZXZlbnRzID0gbG9hZEluZm8uZXZlbnRzLAogICAgICAgICAgaW5kZXggPSBldmVudHMuaW5kZXhPZihvYmplY3QpOwogICAgICBpZiAoaW5kZXggPj0gMCkgewogICAgICAgIGV2ZW50cy5zcGxpY2UoaW5kZXgsIDEpOwoKICAgICAgICBpZiAoZXZlbnRzLmluZGV4T2Yob2JqZWN0KSA8IDApIHsKICAgICAgICAgIC8vIExhc3QgY2FsbGJhY2sgZm9yIHRoaXMgcGFydGljbGFyIG9iamVjdCwgcmVtb3ZlIHRoZSBiaW5kCiAgICAgICAgICBvYmplY3Qub2ZmKGxvYWRFbmQsIGVuZENhbGxiYWNrKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghZXZlbnRzLmxlbmd0aCkgewogICAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby5lbmRUaW1lb3V0KTsKICAgICAgICBsb2FkSW5mby5lbmRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmICghZXZlbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgIHZhciBydW4gPSBsb2FkSW5mby5ydW47CgogICAgICAgICAgICAgIGlmIChydW4pIHsKICAgICAgICAgICAgICAgIC8vIEVtaXQgdGhlIGVuZCBiZWhhdmlvciwgYnV0IG9ubHkgaWYgdGhlcmUgaXMgYSBwYWlyZWQgc3RhcnQKICAgICAgICAgICAgICAgIGVuZC5jYWxsKHNlbGYsIGxvYWRJbmZvLmJhY2tncm91bmQsIGxvYWRJbmZvKTsKICAgICAgICAgICAgICAgIGxvYWRJbmZvLnRyaWdnZXIobG9hZEVuZCwgbG9hZEluZm8pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gSWYgc3RvcHBpbmcgbWFrZSBzdXJlIHdlIGRvbid0IHJ1biBhIHN0YXJ0CiAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGxvYWRJbmZvLnRpbWVvdXQpOwogICAgICAgICAgICAgIGxvYWRJbmZvID0gc2VsZi5fbG9hZEluZm9bbG9hZENvdW50ZXJdID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIFRob3JheC5vbkV4Y2VwdGlvbignbG9hZEVuZCcsIGUpOwogICAgICAgICAgfQogICAgICAgIH0sIGxvYWRpbmdFbmRUaW1lb3V0ICogMTAwMCk7CiAgICAgIH0KICAgIH0pOwogIH07Cn07CgovKioKICogSGVscGVyIG1ldGhvZCBmb3IgcHJvcGFnYXRpbmcgbG9hZDpzdGFydCBldmVudHMgdG8gb3RoZXIgb2JqZWN0cy4KICoKICogRm9yd2FyZHMgbG9hZDpzdGFydCBldmVudHMgdGhhdCBvY2N1ciBvbiBgc291cmNlYCB0byBgZGVzdGAuCiAqLwpUaG9yYXguZm9yd2FyZExvYWRFdmVudHMgPSBmdW5jdGlvbihzb3VyY2UsIGRlc3QsIG9uY2UpIHsKICBmdW5jdGlvbiBsb2FkKG1lc3NhZ2UsIGJhY2tnb3VuZCwgb2JqZWN0KSB7CiAgICBpZiAob25jZSkgewogICAgICBzb3VyY2Uub2ZmKGxvYWRTdGFydCwgbG9hZCk7CiAgICB9CiAgICBkZXN0LnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ291bmQsIG9iamVjdCk7CiAgfQogIHNvdXJjZS5vbihsb2FkU3RhcnQsIGxvYWQpOwogIHJldHVybiB7CiAgICBvZmY6IGZ1bmN0aW9uKCkgewogICAgICBzb3VyY2Uub2ZmKGxvYWRTdGFydCwgbG9hZCk7CiAgICB9CiAgfTsKfTsKCi8vCi8vIERhdGEgbG9hZCBldmVudCBnZW5lcmF0aW9uCi8vCgovKioKICogTWl4aW5nIGZvciBnZW5lcmF0aW5nIGxvYWQ6c3RhcnQgYW5kIGxvYWQ6ZW5kIGV2ZW50cy4KICovClRob3JheC5taXhpbkxvYWRhYmxlID0gZnVuY3Rpb24odGFyZ2V0LCB1c2VQYXJlbnQpIHsKICBfLmV4dGVuZCh0YXJnZXQsIHsKICAgIC8vbG9hZGluZyBjb25maWcKICAgIF9sb2FkaW5nQ2xhc3NOYW1lOiAnbG9hZGluZycsCiAgICBfbG9hZGluZ1RpbWVvdXREdXJhdGlvbjogMC4zMywKICAgIF9sb2FkaW5nVGltZW91dEVuZER1cmF0aW9uOiAwLjEwLAoKICAgIC8vIFByb3BhZ2F0ZXMgbG9hZGluZyB2aWV3IHBhcmFtZXRlcnMgdG8gdGhlIEFKQVggbGF5ZXIKICAgIG9uTG9hZFN0YXJ0OiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CgogICAgICAvLyBQcm90ZWN0IGFnYWluc3QgcmFjZSBjb25kaXRpb25zCiAgICAgIGlmICghdGhhdCB8fCAhdGhhdC5lbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCF0aGF0Lm5vbkJsb2NraW5nTG9hZCAmJiAhYmFja2dyb3VuZCAmJiByb290T2JqZWN0ICYmIHJvb3RPYmplY3QgIT09IHRoaXMpIHsKICAgICAgICByb290T2JqZWN0LnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgICB9CiAgICAgIHRoYXQuX2lzTG9hZGluZyA9IHRydWU7CiAgICAgICQodGhhdC5lbCkuYWRkQ2xhc3ModGhhdC5fbG9hZGluZ0NsYXNzTmFtZSk7CiAgICAgIC8vIHVzZWQgYnkgbG9hZGluZyBoZWxwZXJzCiAgICAgIHRoYXQudHJpZ2dlcignY2hhbmdlOmxvYWQtc3RhdGUnLCAnc3RhcnQnKTsKICAgIH0sCiAgICBvbkxvYWRFbmQ6IGZ1bmN0aW9uKC8qIGJhY2tncm91bmQsIG9iamVjdCAqLykgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKCiAgICAgIC8vIFByb3RlY3QgYWdhaW5zdCByYWNlIGNvbmRpdGlvbnMKICAgICAgaWYgKCF0aGF0IHx8ICF0aGF0LmVsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICB0aGF0Ll9pc0xvYWRpbmcgPSBmYWxzZTsKICAgICAgJCh0aGF0LmVsKS5yZW1vdmVDbGFzcyh0aGF0Ll9sb2FkaW5nQ2xhc3NOYW1lKTsKICAgICAgLy8gdXNlZCBieSBsb2FkaW5nIGhlbHBlcgogICAgICB0aGF0LnRyaWdnZXIoJ2NoYW5nZTpsb2FkLXN0YXRlJywgJ2VuZCcpOwogICAgfQogIH0pOwp9OwoKVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMgPSBmdW5jdGlvbih0YXJnZXQsIHVzZVBhcmVudCkgewogIF8uZXh0ZW5kKHRhcmdldCwgewogICAgbG9hZFN0YXJ0OiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kKSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwogICAgICB0aGF0LnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ3JvdW5kLCB0aGF0KTsKICAgIH0sCiAgICBsb2FkRW5kOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CiAgICAgIHRoYXQudHJpZ2dlcihsb2FkRW5kLCB0aGF0KTsKICAgIH0KICB9KTsKfTsKClRob3JheC5taXhpbkxvYWRhYmxlKFRob3JheC5WaWV3LnByb3RvdHlwZSk7ClRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKFRob3JheC5WaWV3LnByb3RvdHlwZSk7CgoKaWYgKFRob3JheC5IZWxwZXJWaWV3KSB7CiAgVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LkhlbHBlclZpZXcucHJvdG90eXBlLCB0cnVlKTsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyhUaG9yYXguSGVscGVyVmlldy5wcm90b3R5cGUsIHRydWUpOwp9CgppZiAoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3KSB7CiAgVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7CiAgVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7Cn0KClRob3JheC5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBkYXRhT2JqLCBvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICBjb21wbGV0ZSA9IG9wdGlvbnMuY29tcGxldGU7CgogIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgIHNlbGYuX3JlcXVlc3QgPSB1bmRlZmluZWQ7CiAgICBzZWxmLl9hYm9ydGVkID0gZmFsc2U7CgogICAgY29tcGxldGUgJiYgY29tcGxldGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIHRoaXMuX3JlcXVlc3QgPSBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHJldHVybiB0aGlzLl9yZXF1ZXN0Owp9OwoKZnVuY3Rpb24gYmluZFRvUm91dGUoY2FsbGJhY2ssIGZhaWxiYWNrKSB7CiAgdmFyIGZyYWdtZW50ID0gQmFja2JvbmUuaGlzdG9yeS5nZXRGcmFnbWVudCgpLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gcm91dGVIYW5kbGVyKCkgewogICAgaWYgKGZyYWdtZW50ID09PSBCYWNrYm9uZS5oaXN0b3J5LmdldEZyYWdtZW50KCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgIHJlcy5jYW5jZWwoKTsKICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrKCk7CiAgfQoKICBCYWNrYm9uZS5oaXN0b3J5Lm9uKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CgogIGZ1bmN0aW9uIGZpbmFsaXplcigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgICBpZiAoIXJvdXRlQ2hhbmdlZCkgewogICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KCiAgdmFyIHJlcyA9IF8uYmluZChmaW5hbGl6ZXIsIHRoaXMpOwogIHJlcy5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgfTsKCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gbG9hZERhdGEoY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgaWYgKHRoaXMuaXNQb3B1bGF0ZWQoKSkgewogICAgcmV0dXJuIGNhbGxiYWNrKHRoaXMpOwogIH0KCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgIV8uaXNGdW5jdGlvbihmYWlsYmFjaykgJiYgXy5pc09iamVjdChmYWlsYmFjaykpIHsKICAgIG9wdGlvbnMgPSBmYWlsYmFjazsKICAgIGZhaWxiYWNrID0gZmFsc2U7CiAgfQoKICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgIHJvdXRlQ2hhbmdlZCA9IGZhbHNlLAogICAgICBzdWNjZXNzQ2FsbGJhY2sgPSBiaW5kVG9Sb3V0ZShfLmJpbmQoY2FsbGJhY2ssIHNlbGYpLCBmdW5jdGlvbigpIHsKICAgICAgICByb3V0ZUNoYW5nZWQgPSB0cnVlOwogICAgICAgIGlmIChzZWxmLl9yZXF1ZXN0KSB7CiAgICAgICAgICBzZWxmLl9hYm9ydGVkID0gdHJ1ZTsKICAgICAgICAgIHNlbGYuX3JlcXVlc3QuYWJvcnQoKTsKICAgICAgICB9CiAgICAgICAgZmFpbGJhY2sgJiYgZmFpbGJhY2suY2FsbChzZWxmLCBmYWxzZSk7CiAgICAgIH0pOwoKICB0aGlzLmZldGNoKF8uZGVmYXVsdHMoewogICAgc3VjY2Vzczogc3VjY2Vzc0NhbGxiYWNrLAogICAgZXJyb3I6IGZhaWxiYWNrICYmIGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXJvdXRlQ2hhbmdlZCkgewogICAgICAgIGZhaWxiYWNrLmFwcGx5KHNlbGYsIFt0cnVlXS5jb25jYXQoXy50b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgfQogICAgfSwKICAgIGNvbXBsZXRlOiBmdW5jdGlvbigpIHsKICAgICAgc3VjY2Vzc0NhbGxiYWNrLmNhbmNlbCgpOwogICAgfQogIH0sIG9wdGlvbnMpKTsKfQoKZnVuY3Rpb24gZmV0Y2hRdWV1ZShvcHRpb25zLCAkc3VwZXIpIHsKICBpZiAob3B0aW9ucy5yZXNldFF1ZXVlKSB7CiAgICAvLyBXQVJOOiBTaG91bGQgZW5zdXJlIHRoYXQgbG9hZGVycyBhcmUgcHJvdGVjdGVkIGZyb20gb3V0IG9mIGJhbmQgZGF0YQogICAgLy8gICAgd2hlbiB1c2luZyB0aGlzIG9wdGlvbgogICAgdGhpcy5mZXRjaFF1ZXVlID0gdW5kZWZpbmVkOwogIH0KCiAgaWYgKCF0aGlzLmZldGNoUXVldWUpIHsKICAgIC8vIEtpY2sgb2ZmIHRoZSByZXF1ZXN0CiAgICB0aGlzLmZldGNoUXVldWUgPSBbb3B0aW9uc107CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7CiAgICAgIHN1Y2Nlc3M6IGZsdXNoUXVldWUodGhpcywgdGhpcy5mZXRjaFF1ZXVlLCAnc3VjY2VzcycpLAogICAgICBlcnJvcjogZmx1c2hRdWV1ZSh0aGlzLCB0aGlzLmZldGNoUXVldWUsICdlcnJvcicpLAogICAgICBjb21wbGV0ZTogZmx1c2hRdWV1ZSh0aGlzLCB0aGlzLmZldGNoUXVldWUsICdjb21wbGV0ZScpCiAgICB9LCBvcHRpb25zKTsKICAgICRzdXBlci5jYWxsKHRoaXMsIG9wdGlvbnMpOwogIH0gZWxzZSB7CiAgICAvLyBDdXJyZW50bHkgZmV0Y2hpbmcuIFF1ZXVlIGFuZCBwcm9jZXNzIG9uY2UgY29tcGxldGUKICAgIHRoaXMuZmV0Y2hRdWV1ZS5wdXNoKG9wdGlvbnMpOwogIH0KfQoKZnVuY3Rpb24gZmx1c2hRdWV1ZShzZWxmLCBmZXRjaFF1ZXVlLCBoYW5kbGVyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CgogICAgLy8gRmx1c2ggdGhlIHF1ZXVlLiBFeGVjdXRlcyBhbnkgY2FsbGJhY2sgaGFuZGxlcnMgdGhhdAogICAgLy8gbWF5IGhhdmUgYmVlbiBwYXNzZWQgaW4gdGhlIGZldGNoIG9wdGlvbnMuCiAgICBfLmVhY2goZmV0Y2hRdWV1ZSwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAob3B0aW9uc1toYW5kbGVyXSkgewogICAgICAgIG9wdGlvbnNbaGFuZGxlcl0uYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwoKICAgIC8vIFJlc2V0IHRoZSBxdWV1ZSBpZiB3ZSBhcmUgc3RpbGwgdGhlIGFjdGl2ZSByZXF1ZXN0CiAgICBpZiAoc2VsZi5mZXRjaFF1ZXVlID09PSBmZXRjaFF1ZXVlKSB7CiAgICAgIHNlbGYuZmV0Y2hRdWV1ZSA9IHVuZGVmaW5lZDsKICAgIH0KICB9Owp9Cgp2YXIga2xhc3NlcyA9IFtdOwpUaG9yYXguTW9kZWwgJiYga2xhc3Nlcy5wdXNoKFRob3JheC5Nb2RlbCk7ClRob3JheC5Db2xsZWN0aW9uICYmIGtsYXNzZXMucHVzaChUaG9yYXguQ29sbGVjdGlvbik7CgpfLmVhY2goa2xhc3NlcywgZnVuY3Rpb24oRGF0YUNsYXNzKSB7CiAgdmFyICRmZXRjaCA9IERhdGFDbGFzcy5wcm90b3R5cGUuZmV0Y2g7CiAgVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoRGF0YUNsYXNzLnByb3RvdHlwZSwgZmFsc2UpOwogIF8uZXh0ZW5kKERhdGFDbGFzcy5wcm90b3R5cGUsIHsKICAgIHN5bmM6IFRob3JheC5zeW5jLAoKICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgY29tcGxldGUgPSBvcHRpb25zLmNvbXBsZXRlOwoKICAgICAgb3B0aW9ucy5jb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbXBsZXRlICYmIGNvbXBsZXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgc2VsZi5sb2FkRW5kKCk7CiAgICAgIH07CiAgICAgIHNlbGYubG9hZFN0YXJ0KHVuZGVmaW5lZCwgb3B0aW9ucy5iYWNrZ3JvdW5kKTsKICAgICAgcmV0dXJuIGZldGNoUXVldWUuY2FsbCh0aGlzLCBvcHRpb25zIHx8IHt9LCAkZmV0Y2gpOwogICAgfSwKCiAgICBsb2FkOiBmdW5jdGlvbihjYWxsYmFjaywgZmFpbGJhY2ssIG9wdGlvbnMpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgIV8uaXNGdW5jdGlvbihmYWlsYmFjaykpIHsKICAgICAgICBvcHRpb25zID0gZmFpbGJhY2s7CiAgICAgICAgZmFpbGJhY2sgPSBmYWxzZTsKICAgICAgfQoKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIGlmICghb3B0aW9ucy5iYWNrZ3JvdW5kICYmICF0aGlzLmlzUG9wdWxhdGVkKCkgJiYgcm9vdE9iamVjdCkgewogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBnbG9iYWwgc2NvcGUgc2VlcyB0aGUgcHJvcGVyIGxvYWQgZXZlbnRzIGhlcmUKICAgICAgICAvLyBpZiB3ZSBhcmUgbG9hZGluZyBpbiBzdGFuZGFsb25lIG1vZGUKICAgICAgICBUaG9yYXguZm9yd2FyZExvYWRFdmVudHModGhpcywgcm9vdE9iamVjdCwgdHJ1ZSk7CiAgICAgIH0KCiAgICAgIGxvYWREYXRhLmNhbGwodGhpcywgY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKTsKICAgIH0KICB9KTsKfSk7CgpUaG9yYXguVXRpbC5iaW5kVG9Sb3V0ZSA9IGJpbmRUb1JvdXRlOwoKaWYgKFRob3JheC5Sb3V0ZXIpIHsKICBUaG9yYXguUm91dGVyLmJpbmRUb1JvdXRlID0gVGhvcmF4LlJvdXRlci5wcm90b3R5cGUuYmluZFRvUm91dGUgPSBiaW5kVG9Sb3V0ZTsKfQoKLy8gUHJvcGFnYXRlcyBsb2FkaW5nIHZpZXcgcGFyYW1ldGVycyB0byB0aGUgQUpBWCBsYXllcgpUaG9yYXguVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIG9wdGlvbnMuaWdub3JlRXJyb3JzID0gdGhpcy5pZ25vcmVGZXRjaEVycm9yOwogIG9wdGlvbnMuYmFja2dyb3VuZCA9IHRoaXMubm9uQmxvY2tpbmdMb2FkOwogIHJldHVybiBvcHRpb25zOwp9OwoKLy8gVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3IGluaGVyaXRzIGZyb20gQ29sbGVjdGlvblZpZXcKLy8gbm90IEhlbHBlclZpZXcgc28gbmVlZCB0byBzZXQgaXQgbWFudWFsbHkKVGhvcmF4LkhlbHBlclZpZXcucHJvdG90eXBlLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyA9IFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIG9wdGlvbnMuaWdub3JlRXJyb3JzID0gdGhpcy5wYXJlbnQuaWdub3JlRmV0Y2hFcnJvcjsKICBvcHRpb25zLmJhY2tncm91bmQgPSB0aGlzLnBhcmVudC5ub25CbG9ja2luZ0xvYWQ7CiAgcmV0dXJuIG9wdGlvbnM7Cn07Cgppbmhlcml0VmFycy5jb2xsZWN0aW9uLmxvYWRpbmcgPSBmdW5jdGlvbigpIHsKICB2YXIgbG9hZGluZ1ZpZXcgPSB0aGlzLmxvYWRpbmdWaWV3LAogICAgICBsb2FkaW5nVGVtcGxhdGUgPSB0aGlzLmxvYWRpbmdUZW1wbGF0ZSwKICAgICAgbG9hZGluZ1BsYWNlbWVudCA9IHRoaXMubG9hZGluZ1BsYWNlbWVudDsKICAvL2FkZCAibG9hZGluZy12aWV3IiBhbmQgImxvYWRpbmctdGVtcGxhdGUiIG9wdGlvbnMgdG8gY29sbGVjdGlvbiBoZWxwZXIKICBpZiAobG9hZGluZ1ZpZXcgfHwgbG9hZGluZ1RlbXBsYXRlKSB7CiAgICB2YXIgY2FsbGJhY2sgPSBUaG9yYXgubG9hZEhhbmRsZXIoXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbTsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLiRlbC5lbXB0eSgpOwogICAgICB9CiAgICAgIGlmIChsb2FkaW5nVmlldykgewogICAgICAgIHZhciBpbnN0YW5jZSA9IFRob3JheC5VdGlsLmdldFZpZXdJbnN0YW5jZShsb2FkaW5nVmlldyk7CiAgICAgICAgdGhpcy5fYWRkQ2hpbGQoaW5zdGFuY2UpOwogICAgICAgIGlmIChsb2FkaW5nVGVtcGxhdGUpIHsKICAgICAgICAgIGluc3RhbmNlLnJlbmRlcihsb2FkaW5nVGVtcGxhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICB9CiAgICAgICAgaXRlbSA9IGluc3RhbmNlOwogICAgICB9IGVsc2UgewogICAgICAgIGl0ZW0gPSB0aGlzLnJlbmRlclRlbXBsYXRlKGxvYWRpbmdUZW1wbGF0ZSk7CiAgICAgIH0KICAgICAgdmFyIGluZGV4ID0gbG9hZGluZ1BsYWNlbWVudAogICAgICAgID8gbG9hZGluZ1BsYWNlbWVudC5jYWxsKHRoaXMpCiAgICAgICAgOiB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoCiAgICAgIDsKICAgICAgdGhpcy5hcHBlbmRJdGVtKGl0ZW0sIGluZGV4KTsKICAgICAgdGhpcy4kZWwuY2hpbGRyZW4oKS5lcShpbmRleCkuYXR0cignZGF0YS1sb2FkaW5nLWVsZW1lbnQnLCB0aGlzLmNvbGxlY3Rpb24uY2lkKTsKICAgIH0sIHRoaXMpLCBfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLmZpbmQoJ1tkYXRhLWxvYWRpbmctZWxlbWVudD0iJyArIHRoaXMuY29sbGVjdGlvbi5jaWQgKyAnIl0nKS5yZW1vdmUoKTsKICAgIH0sIHRoaXMpLAogICAgdGhpcy5jb2xsZWN0aW9uKTsKCiAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2xvYWQ6c3RhcnQnLCBjYWxsYmFjayk7CiAgfQp9OwoKaWYgKGNvbGxlY3Rpb25PcHRpb25OYW1lcykgewogIGNvbGxlY3Rpb25PcHRpb25OYW1lc1snbG9hZGluZy10ZW1wbGF0ZSddID0gJ2xvYWRpbmdUZW1wbGF0ZSc7CiAgY29sbGVjdGlvbk9wdGlvbk5hbWVzWydsb2FkaW5nLXZpZXcnXSA9ICdsb2FkaW5nVmlldyc7CiAgY29sbGVjdGlvbk9wdGlvbk5hbWVzWydsb2FkaW5nLXBsYWNlbWVudCddID0gJ2xvYWRpbmdQbGFjZW1lbnQnOwp9CgpUaG9yYXguVmlldy5vbih7CiAgJ2xvYWQ6c3RhcnQnOiBUaG9yYXgubG9hZEhhbmRsZXIoCiAgICAgIGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICAgIHRoaXMub25Mb2FkU3RhcnQobWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgICAgdGhpcy5vbkxvYWRFbmQob2JqZWN0KTsKICAgICAgfSksCgogIGNvbGxlY3Rpb246IHsKICAgICdsb2FkOnN0YXJ0JzogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgIHRoaXMudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICB9CiAgfSwKICBtb2RlbDogewogICAgJ2xvYWQ6c3RhcnQnOiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgdGhpcy50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgIH0KICB9Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbG9hZGluZycsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgdmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAgdmlldy5vZmYoJ2NoYW5nZTpsb2FkLXN0YXRlJywgb25Mb2FkU3RhdGVDaGFuZ2UsIHZpZXcpOwogIHZpZXcub24oJ2NoYW5nZTpsb2FkLXN0YXRlJywgb25Mb2FkU3RhdGVDaGFuZ2UsIHZpZXcpOwogIHJldHVybiB2aWV3Ll9pc0xvYWRpbmcgPyBvcHRpb25zLmZuKHRoaXMpIDogb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwp9KTsKCmZ1bmN0aW9uIG9uTG9hZFN0YXRlQ2hhbmdlKCkgewogIHRoaXMucmVuZGVyKCk7Cn0KOzsKdmFyIGlzSUUgPSAoL21zaWUgW1x3Ll0rLykuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpOwoKaWYgKGlzSUUpIHsKICAvLyBJRSB3aWxsIGxvc2UgYSByZWZlcmVuY2UgdG8gdGhlIGVsZW1lbnRzIGlmIHZpZXcuZWwuaW5uZXJIVE1MID0gJyc7CiAgLy8gSWYgdGhleSBhcmUgcmVtb3ZlZCBvbmUgYnkgb25lIHRoZSByZWZlcmVuY2VzIGFyZSBub3QgbG9zdC4KICAvLyBGb3IgaW5zdGFuY2UgYSB2aWV3J3MgY2hpbGRyZW5zJyBgZWxgcyB3aWxsIGJlIGxvc3QgaWYgdGhlIHZpZXcKICAvLyBzZXRzIGl0J3MgYGVsLmlubmVySFRNTGAuCiAgVGhvcmF4LlZpZXcub24oJ2JlZm9yZTphcHBlbmQnLCBmdW5jdGlvbigpIHsKICAgIC8vIG5vdGUgdGhhdCBkZXRhY2ggaXMgbm90IGF2YWlsYWJsZSBpbiBaZXB0bywKICAgIC8vIGJ1dCBJRSBzaG91bGQgbmV2ZXIgcnVuIHdpdGggWmVwdG8KICAgIGlmICh0aGlzLl9yZW5kZXJDb3VudCA+IDApIHsKICAgICAgXy5lYWNoKHRoaXMuX2VsZW1lbnRzQnlDaWQsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAkKGVsZW1lbnQpLmRldGFjaCgpOwogICAgICB9KTsKICAgICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgY2hpbGQuJGVsLmRldGFjaCgpOwogICAgICB9KTsKICAgIH0KICB9KTsKCiAgLy8gT25jZSBub2RlcyBhcmUgZGV0YWNoZWQgdGhlaXIgaW5uZXJIVE1MIGdldHMgbnVrZWQgaW4gSUUKICAvLyBzbyBjcmVhdGUgYSBkZWVwIGNsb25lLiBUaGlzIG1ldGhvZCBpcyBpZGVudGljYWwgdG8gdGhlCiAgLy8gbWFpbiBpbXBsZW1lbnRhdGlvbiBleGNlcHQgZm9yICIuY2xvbmUodHJ1ZSwgdHJ1ZSkiIHdoaWNoCiAgLy8gd2lsbCBwZXJmb3JtIGEgZGVlcCBjbG9uZSB3aXRoIGV2ZW50cyBhbmQgZGF0YQogIFRob3JheC5Db2xsZWN0aW9uVmlldy5wcm90b3R5cGUuX3JlcGxhY2VIVE1MID0gZnVuY3Rpb24oaHRtbCkgewogICAgaWYgKHRoaXMuY29sbGVjdGlvbiAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbdGhpcy5jb2xsZWN0aW9uLmNpZF0gJiYgdGhpcy5fcmVuZGVyQ291bnQpIHsKICAgICAgdmFyIGVsZW1lbnQ7CiAgICAgIHZhciBvbGRDb2xsZWN0aW9uRWxlbWVudCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKS5jbG9uZSh0cnVlLCB0cnVlKTsKICAgICAgZWxlbWVudCA9IF9yZXBsYWNlSFRNTC5jYWxsKHRoaXMsIGh0bWwpOwogICAgICBpZiAoIW9sZENvbGxlY3Rpb25FbGVtZW50LmF0dHIoJ2RhdGEtdmlldy1jaWQnKSkgewogICAgICAgIHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKS5yZXBsYWNlV2l0aChvbGRDb2xsZWN0aW9uRWxlbWVudCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBfcmVwbGFjZUhUTUwuY2FsbCh0aGlzLCBodG1sKTsKICAgIH0KICB9Owp9Cgo7OwoKCn0pKCk7CgovL0Agc291cmNlTWFwcGluZ1VSTD10aG9yYXguanMubWFwCgo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 03:54:59 GMT",
                    "Content-Length": "531017",
                    "Date": "Sat, 08 Nov 2014 03:55:36 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}