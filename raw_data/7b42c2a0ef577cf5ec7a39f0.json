{
    "url": "http://localhost:9999/david-driscoll/thrust/dist/debug/thrust.all.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>parent.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>this.name = parent.name;</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/david-driscoll/thrust/dist/debug/thrust.all.js",
                "path": "/david-driscoll/thrust/dist/debug/thrust.all.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kYXZpZC1kcmlzY29sbC90aHJ1c3QvZGlzdC9kZWJ1Zy90aHJ1c3QuYWxsLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjMxODM3DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDIwOjA1OjI3IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAyMDowNToyNyBHTVQNCg0KLyohIHRocnVzdC1qcyAtIHYwLjEuNSAtIDIwMTMtMDEtMjcgKi8KZGVmaW5lKCd0aHJ1c3QvdXRpbC9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdsb2Rhc2gnLCAndW5kZXJzY29yZS5zdHJpbmcnLCAndXVpZCcsICd3aGVuJywgJ3doZW4vYXBwbHknLCAnd2hlbi9kZWxheScsICd3aGVuL3RpbWVvdXQnLCAnd2hlbi9wYXJhbGxlbCcsICd3aGVuL3BpcGVsaW5lJywgJ3doZW4vc2VxdWVuY2UnLCAnd2hlbi9jYW5jZWxhYmxlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fX19fXywgX19fc19fLCBfX3V1aWRfXywgX193X18sIF9fd2hlbkFwcGx5X18sIF9fd2hlbkRlbGF5X18sIF9fd2hlblRpbWVvdXRfXywgX193aGVuUGFyYWxsZWxfXywgX193aGVuUGlwZWxpbmVfXywgX193aGVuU2VxdWVuY2VfXywgX193aGVuQ2FuY2VsYWJsZV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSB1dGlsIHsqLwogICAgdmFyIF9fID0gX19fX19fOwoKICAgIHZhciBfcyA9IF9fX3NfXzsKCiAgICB2YXIgdXVpZCA9IF9fdXVpZF9fOwoKICAgIAogICAgX18ubWl4aW4oX3MpOwogICAgZXhwb3J0cy5fID0gX187CiAgICAvLyNyZWdpb24gZnVuY3Rpb24KICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIC8qKgogICAgQSBmdW5jdGlvbiB0aGF0IGRvZXMgbm90aGluZywgb3Igbm8gb3BlcmF0aW9uLiAgSGVuY2UgdGhlIG5hbWUgbm9vcC4KICAgIAogICAgQG1ldGhvZCBub29wCiAgICAqKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICB9CiAgICBleHBvcnRzLm5vb3AgPSBub29wOwogICAgdmFyIHByb3BlcnR5SXNFbnVtZXJhYmxlID0gbm9vcC5wcm9wZXJ0eUlzRW51bWVyYWJsZTsKICAgIC8qKgogICAgQXR0ZW1wdHMgdG8gaW52b2tlLCBzaW1pbGFyIHRvIF8uaW52b2tlLCBidXQgaW4gdGhpcyBjYXNlIGl0IHZlcmlmaWVzIHRoYXQgdGhlIHByb3BlcnR5IGV4aXN0LAogICAgYW5kIGFsc28gdmVyaWZpZXMgdGhhdCBpdCBpcyBhIGZ1bmN0aW9uLCBhbmQgbm90IHRoZSBub29wIG1ldGhvZCBhdmFpbGFibGUgaW4gdGhydXN0LgogICAgCiAgICBUaGUgaW50ZW50IGlzIGEgbWV0aG9kIHRoYXQgYWxsb3dzIG92ZXJyaWRlIG9mIGZ1bmN0aW9ucywgd2l0aG91dCBjcmVhdGluZyBjdXN0b20gY29kZS4KICAgIAogICAgQG1ldGhvZCBzYXZlSW52b2tlCiAgICBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29udGFpbmVyIHRoYXQgaGFzIHRoZSBpdGVtcwogICAgQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IG1ldGhvZCBUaGUgbWV0aG9kIG5hbWUgb24gZXZlcnkgaXRlbSwgb3IgdGhlIG1ldGhvZCB0byBpbnZva2UgYWdhaW5zdCBlYWNoIGl0ZW0uCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3NdKiBUaGUgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHNhZmVJbnZva2UoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMik7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAyXTsKICAgICAgICB9CiAgICAgICAgLypqc2hpbnQgYml0d2lzZTpmYWxzZSAqLwogICAgICAgICAgICAgICAgdmFyIGluZGV4LCBpdGVyYXRlZSA9IGNvbGxlY3Rpb24sIHJlc3VsdDsKICAgICAgICBpZighY29sbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLCBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLCBtZXRob2RFeGlzdHM7CiAgICAgICAgdmFyIGxlbmd0aCA9IGl0ZXJhdGVlLmxlbmd0aDsKICAgICAgICBpbmRleCA9IC0xOwogICAgICAgIGlmKGxlbmd0aCA9PT0gbGVuZ3RoID4+PiAwKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKTsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyAmJiBtZXRob2RFeGlzdHMgIT09IG5vb3AgJiYgKHJlc3VsdFtpbmRleF0gPSBtZXRob2RFeGlzdHMuYXBwbHkoaXRlcmF0ZWVbaW5kZXhdLCBhcmdzKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc2tpcFByb3RvID0gdHlwZW9mIGl0ZXJhdGVlID09ICdmdW5jdGlvbicgJiYgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChpdGVyYXRlZSwgJ3Byb3RvdHlwZScpOwogICAgICAgICAgICB2YXIgcHJvcHMgPSBleHBvcnRzLl8ua2V5cyhpdGVyYXRlZSksIHByb3BJbmRleCA9IC0xLCBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsrcHJvcEluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IHByb3BzW3Byb3BJbmRleF07CiAgICAgICAgICAgICAgICBpZighKHNraXBQcm90byAmJiBpbmRleCA9PSAncHJvdG90eXBlJykpIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzICYmIG1ldGhvZEV4aXN0cyAhPT0gbm9vcCAmJiAocmVzdWx0W3Byb3BJbmRleF0gPSAoKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pLmFwcGx5KGl0ZXJhdGVlW2luZGV4XSwgYXJncykpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy5zYWZlSW52b2tlID0gc2FmZUludm9rZTsKICAgIC8qKgogICAgKiBDb25zdHJ1Y3RvciB1c2VkIHRvIGJlZ2V0IG9iamVjdHMgdGhhdCB3aXJlIG5lZWRzIHRvIGNyZWF0ZSB1c2luZyBuZXcuCiAgICAqIEBwYXJhbSBjdG9yIHtGdW5jdGlvbn0gcmVhbCBjb25zdHJ1Y3RvciB0byBiZSBpbnZva2VkCiAgICAqIEBwYXJhbSBhcmdzIHtBcnJheX0gYXJndW1lbnRzIHRvIGJlIHN1cHBsaWVkIHRvIGN0b3IKICAgICovCiAgICBmdW5jdGlvbiBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gY3Rvci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICAgIC8qKgogICAgKiBDcmVhdGVzIGFuIG9iamVjdCBieSBlaXRoZXIgaW52b2tpbmcgY3RvciBhcyBhIGZ1bmN0aW9uIGFuZCByZXR1cm5pbmcgdGhlIHJlc3VsdCwKICAgICogb3IgYnkgY2FsbGluZyBuZXcgY3RvcigpLiAgSXQgdXNlcyBhIHNpbXBsZSBoZXVyaXN0aWMgdG8gdHJ5IHRvIGd1ZXNzIHdoaWNoIGFwcHJvYWNoCiAgICAqIGlzIHRoZSAicmlnaHQiIG9uZS4KICAgICoKICAgICogQHBhcmFtIGN0b3Ige0Z1bmN0aW9ufSBmdW5jdGlvbiBvciBjb25zdHJ1Y3RvciB0byBpbnZva2UKICAgICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcnJheSBvZiBhcmd1bWVudHMgdG8gcGFzcyB0byBjdG9yIGluIGVpdGhlciBjYXNlCiAgICAqCiAgICAqIEByZXR1cm5zIFRoZSByZXN1bHQgb2YgaW52b2tpbmcgY3RvciB3aXRoIGFyZ3MsIHdpdGggb3Igd2l0aG91dCBuZXcsIGRlcGVuZGluZyBvbgogICAgKiB0aGUgc3RyYXRlZ3kgc2VsZWN0ZWQuCiAgICAqLwogICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoY3RvciwgYXJncywgbmFtZSkgewogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gY3Rvci5wcm90b3R5cGU7CiAgICAgICAgRHluYW1pY2x5Q3JlYXRlZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yOwogICAgICAgIHZhciBiZWdvdHRlbiA9IG5ldyBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpOwogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gdm9pZCAwOwogICAgICAgIHJldHVybiBiZWdvdHRlbjsKICAgIH0KICAgIGV4cG9ydHMuaW5zdGFudGlhdGUgPSBpbnN0YW50aWF0ZTsKICAgIC8qKgogICAgRmxhdHRlbiBhbmQgZmlsdGVyIGFycmF5cyBkb3duIHRvIGp1c3QgdGhlIGV4aXN0aW5nIHByb21pc2VzLgogICAgCiAgICBAbWV0aG9kIGZsYXR0ZW5Ub1Byb21pc2VzCiAgICBAcGFyYW0ge0FycmF5fSBBcnJheSB0byBmbGF0dGVuLCBhbmQgZmlsdGVyLgogICAgQHJldHVybnMge0FycmF5IG9mIFByb21pc2VzfQogICAgKiovCiAgICBmdW5jdGlvbiBmbGF0dGVuVG9Qcm9taXNlcyhhcnJheSkgewogICAgICAgIHJldHVybiBleHBvcnRzLl8uZmxhdHRlbihhcnJheSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLmlzUHJvbWlzZSh4KTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZmxhdHRlblRvUHJvbWlzZXMgPSBmbGF0dGVuVG9Qcm9taXNlczsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIG9iamVjdAogICAgLyoqCiAgICBJbnZlcnRzIGFuIG9iamVjdC4gIFRoZSBrZXlzIGJlY29tZSB2YWx1ZXMsIGFuZCB0aGUgdmFsdWVzIGJlY29tZSBrZXlzLgogICAgRG9lcyBub3QgZG8gYW55IGNvcHlpbmcuCiAgICAKICAgIEBtZXRob2QgaW52ZXJ0CiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gaW52ZXJ0LgogICAgQHJldHVybnMge09iamVjdH0gVGhlIGludmVydGVkIG9iamVjdC4KICAgICoqLwogICAgdmFyIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBmdW5jdGlvbiBpbnZlcnQob2JqKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICB9OwogICAgICAgIGZvcih2YXIgaSBpbiBvYmopIHsKICAgICAgICAgICAgaWYoaGFzT3duLmNhbGwob2JqLCBpKSkgewogICAgICAgICAgICAgICAgcmVzdWx0W29ialtpXV0gPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLmludmVydCA9IGludmVydDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHR5cGUudHMKICAgIC8qKgogICAgQ2hlY2tzIGlzIHRoZSBvYmplY3QgaXMgYXJyYXkgbGlrZSwgbGlrZSB0aGUgYXJ1Z3VtZW50cyBvYmplY3QsIGJ1dCBub3QgYSBzdHJpbmcsIG9lIGFycmF5LgogICAgalF1ZXJ5IG9iamVjdHMgZm9yIGV4YW1wbGUgd291bGQgcmVwb3J0IGFzIGFycmF5IGxpa2UuCiAgICBBcyB3ZWxsIGFzIGtub2Nrb3V0IG9ic2VydmFibGUgYXJyYXlzIHJlcG9ydCBhcyBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlMaWtlCiAgICBAcGFyYW0ge09iamVjdH0gbyBUaGUgb2JqZWN0IHRvIGNoZWNrCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSXMgaXQgdHJ1ZSBvciBmYWxzZS4KICAgICoqLwogICAgZnVuY3Rpb24gaXNBcnJheUxpa2UobykgewogICAgICAgIHJldHVybiAobyAmJiAhZXhwb3J0cy5fLmlzU3RyaW5nKG8pICYmIG8ubGVuZ3RoICE9PSB1bmRlZmluZWQpIHx8IGZhbHNlOwogICAgfQogICAgZXhwb3J0cy5pc0FycmF5TGlrZSA9IGlzQXJyYXlMaWtlOwogICAgLyoqCiAgICBDaGVja3MgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhcnJheSBvciBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlPckFycmF5TGlrZQogICAgQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB0byBjaGVjawogICAgQHJldHVybnMge0Jvb2xlYW59IElzIGl0IHRydWUgb3IgZmFsc2UuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXlPckFycmF5TGlrZShvKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc0FycmF5KG8pIHx8IChpc0FycmF5TGlrZShvKSk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlPckFycmF5TGlrZSA9IGlzQXJyYXlPckFycmF5TGlrZTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHV1aWQKICAgICAgICB2YXIgZ3VpZFJlZ2V4ID0gL14oXHt7MCwxfShbMC05YS1mQS1GXSl7OH0tKFswLTlhLWZBLUZdKXs0fS0oWzAtOWEtZkEtRl0pezR9LShbMC05YS1mQS1GXSl7NH0tKFswLTlhLWZBLUZdKXsxMn1cfXswLDF9KSQvLCBlbXRwdHlHdWlkID0gJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCc7CiAgICAvKioKICAgIFJldHVybnMgYSBuZXcgc3VkbyBndWlkLCBsaW1pYXRpb25zIGluIEphdmFTY3JpcHQgbWFrZSBtdXN0IG1vcmUgcmVsaWFibGUgZ3VpZHMgZmFpcmx5IGRpZmZpY3VsdCB0byBjcmVhdGUuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwKICAgIEBtZXRob2QgbmV3R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBuZXcgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gbmV3R3VpZCgpIHsKICAgICAgICByZXR1cm4gdXVpZC52NCgpOwogICAgfQogICAgZXhwb3J0cy5uZXdHdWlkID0gbmV3R3VpZDsKICAgIC8qKgogICAgUmV0dXJucyBhbiBlbXB0eSBndWlkLgogICAgCiAgICBAbWV0aG9kIGVtcHR5R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBlbXRwdHkgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gZW1wdHlHdWlkKCkgewogICAgICAgIHJldHVybiBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5lbXB0eUd1aWQgPSBlbXB0eUd1aWQ7CiAgICAvKioKICAgIENoZWNrcyBpZiB0aGUgZ2l2ZW4gc3RyaW5nIGlzIGEgZ3VpZC4KICAgIAogICAgQG1ldGhvZCBpc0d1aWQKICAgIEBwYXJhbSB7R3VpZH0gZ3VpZAogICAgQHJldHVybnMge0Jvb2xlYW59IElmIHRoZSBndWlkIGlzIGEgZ3VpZCBvciBub3QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzR3VpZChndWlkKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc1N0cmluZyhndWlkKSA/IGd1aWRSZWdleC50ZXN0KGd1aWQpIDogZmFsc2U7CiAgICB9CiAgICBleHBvcnRzLmlzR3VpZCA9IGlzR3VpZDsKICAgIC8qKgogICAgQ2hlY2tzIGlmIHRoZSBHdWlkIGlzIGFuIEVtcHR5IEd1aWQKICAgIAogICAgQG1ldGhvZCBpc0VtcHR5R3VpZAogICAgQHBhcmFtIHtHdWlkfSBndWlkCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSWYgdGhlIGd1aWQgaXMgYSBndWlkIG9yIG5vdC4KICAgICoqLwogICAgZnVuY3Rpb24gaXNFbXB0eUd1aWQoZ3VpZCkgewogICAgICAgIHJldHVybiBndWlkID09PSBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5pc0VtcHR5R3VpZCA9IGlzRW1wdHlHdWlkOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gc3RyaW5nCiAgICAgICAgdmFyIG9iamVjdEN1cmx5UmVnZXggPSAvXHtce3xcfVx9fFx7KC4qPylcfS9nLCBudW1iZXJDdXJseVJlZ2V4ID0gL1x7XHt8XH1cfXxceyhcZCspXH0vZzsKICAgIC8qKgogICAgQyMgc3R5bGUgc3RyaW5nIGZvcm1hdC4KICAgIAogICAgQGZvciB0aHJ1c3QudXRpbAogICAgQG1ldGhvZCBmb3JtYXQKICAgICoqLwogICAgZnVuY3Rpb24gZm9ybWF0KHN0cikgewogICAgICAgIHZhciBmb3JtYXRBcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgZm9ybWF0QXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgaWYodHlwZW9mIGZvcm1hdEFyZ3NbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHZhciBhID0gZm9ybWF0QXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKG9iamVjdEN1cmx5UmVnZXgsIGZ1bmN0aW9uIChtLCBuKSB7CiAgICAgICAgICAgICAgICBpZihtID09ICd7eycpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYobSA9PSAnfX0nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhICYmIGFbbl0gfHwgJyc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UobnVtYmVyQ3VybHlSZWdleCwgZnVuY3Rpb24gKG0sIG4pIHsKICAgICAgICAgICAgaWYobSA9PSAne3snKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG0gPT0gJ319JykgewogICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm9ybWF0QXJnc1tuXSB8fCAnJzsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZm9ybWF0ID0gZm9ybWF0OwogICAgZnVuY3Rpb24gZ2V0TW9kdWxlTmFtZUZvclBhdGgobmFtZSkgewogICAgICAgIHJldHVybiAobmFtZS5sYXN0SW5kZXhPZignLycpID4gLTEgPyBuYW1lLnN1YnN0cmluZyhuYW1lLmxhc3RJbmRleE9mKCcvJykgKyAxKSA6IG5hbWUpLnJlcGxhY2UoL1wuL2csICctJyk7CiAgICB9CiAgICBleHBvcnRzLmdldE1vZHVsZU5hbWVGb3JQYXRoID0gZ2V0TW9kdWxlTmFtZUZvclBhdGg7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiB1cmwKICAgICAgICB2YXIgZG91YmxlU2xhc2hSZWdleCA9IC9cL1wvL2csIHIyMCA9IC8lMjAvZywgcmJyYWNrZXQgPSAvXFtcXSQvOwogICAgLyoqCiAgICBqUXVlcnkgcGFyYW0gbWV0aG9kIHRvIGVuY29kZSBmb3JtIHBhcmFtZXRlcnMuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwudXJsCiAgICBAbWV0aG9kIHBhcmFtCiAgICAqKi8KICAgIGZ1bmN0aW9uIHBhcmFtKGEsIHRyYWRpdGlvbmFsKSB7CiAgICAgICAgdmFyIHByZWZpeCwgcyA9IFtdLCBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHJldHVybiBpdHMgdmFsdWUKICAgICAgICAgICAgdmFsdWUgPSBleHBvcnRzLl8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSgpIDogKHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlKTsKICAgICAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgICAvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgogICAgICAgIC8qaWYgKHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQpCiAgICAgICAgewogICAgICAgIC8vIFRPRE8gU3VwcG9ydCBmb3IgdHJhZGl0aW9uYWxFbmNvZGluZwogICAgICAgIC8vdHJhZGl0aW9uYWwgPSAhIW0uY29uZmlnKCkudHJhZGl0aW9uYWxFbmNvZGluZzsKICAgICAgICB9Ki8KICAgICAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgICAgIGlmKGlzQXJyYXlPckFycmF5TGlrZShhKSkgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgICAgICAgICAgZXhwb3J0cy5fLmVhY2goYSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGFkZCh4Lm5hbWUsIHgudmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKICAgICAgICAgICAgLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCiAgICAgICAgICAgIGZvcihwcmVmaXggaW4gYSkgewogICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhW3ByZWZpeF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KICAgICAgICByZXR1cm4gcy5qb2luKCImIikucmVwbGFjZShyMjAsICIrIik7CiAgICB9CiAgICBleHBvcnRzLnBhcmFtID0gcGFyYW07CiAgICBmdW5jdGlvbiBidWlsZFBhcmFtcyhwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCkgewogICAgICAgIGlmKGV4cG9ydHMuXy5pc0FycmF5KG9iaikpIHsKICAgICAgICAgICAgLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCiAgICAgICAgICAgIGV4cG9ydHMuXy5lYWNoKG9iaiwgZnVuY3Rpb24gKGksIHYpIHsKICAgICAgICAgICAgICAgIGlmKHRyYWRpdGlvbmFsIHx8IHJicmFja2V0LnRlc3QocHJlZml4KSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgICAgICAgICAgICBhZGQocHJlZml4LCB2KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCiAgICAgICAgICAgICAgICAgICAgLy8gbnVtZXJpYyBpbmRleCB0byByZXNvbHZlIGRlc2VyaWFsaXphdGlvbiBhbWJpZ3VpdHkgaXNzdWVzLgogICAgICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCByYWNrIChhcyBvZiAxLjAuMCkgY2FuJ3QgY3VycmVudGx5IGRlc2VyaWFsaXplCiAgICAgICAgICAgICAgICAgICAgLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCiAgICAgICAgICAgICAgICAgICAgLy8gYSBzZXJ2ZXIgZXJyb3IuIFBvc3NpYmxlIGZpeGVzIGFyZSB0byBtb2RpZnkgcmFjaydzCiAgICAgICAgICAgICAgICAgICAgLy8gZGVzZXJpYWxpemF0aW9uIGFsZ29yaXRobSBvciB0byBwcm92aWRlIGFuIG9wdGlvbiBvciBmbGFnCiAgICAgICAgICAgICAgICAgICAgLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgogICAgICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArICh0eXBlb2YgdiA9PT0gIm9iamVjdCIgfHwgZXhwb3J0cy5fLmlzQXJyYXkodikgPyBpIDogIiIpICsgIl0iLCB2LCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmKCF0cmFkaXRpb25hbCAmJiBvYmogIT0gbnVsbCAmJiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgICAgICAgIGZvcih2YXIgbmFtZSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialtuYW1lXSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgICAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBDbGVhbnMgdXAgZG91YmxlIHNsYXNocyBpbiBhIHVybCwgdXNlZCBieSB0aHJ1c3QvZGF0YQogICAgCiAgICBAbWV0aG9kIGNsZWFuVXJsCiAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gY2xlYW4KICAgIEByZXRydXNuIHtTdHJpbmd9IFRoZSBjbGVhbmVkIHVybAogICAgKiovCiAgICBmdW5jdGlvbiBjbGVhblVybCh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnJlcGxhY2UoZG91YmxlU2xhc2hSZWdleCwgJy8nKTsKICAgIH0KICAgIGV4cG9ydHMuY2xlYW5VcmwgPSBjbGVhblVybDsKICAgIC8qKgogICAgQ2hlY2tzIGZvciBleGlzdGFuY2Ugb2YgYXBwbGljYXRpb24gcGF0aCBpbiB0aGUgdXJsLCBvciBodHRwIGlmIHRoZSB1cmwgaXMgc3VwcG9zZWQgdG8gZ28gdG8gYW5vdGhlciBsb2NhdGlvbi4KICAgIAogICAgQG1ldGhvZCBmaXh1cFVybAogICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGZpeHVwCiAgICBAcmV0cnVzbiB7U3RyaW5nfSBUaGUgZml4ZWQgdXJsCiAgICAqKi8KICAgIGZ1bmN0aW9uIGZpeHVwVXJsKHVybCwgdXJsUGF0aCkgewogICAgICAgIGlmKHVybC5pbmRleE9mKCdodHRwJykgPT09IC0xKSB7CiAgICAgICAgICAgIHZhciBwYXRoID0gdXJsUGF0aC5sYXN0SW5kZXhPZignLycpID09PSB1cmxQYXRoLmxlbmd0aCAtIDEgPyB1cmxQYXRoLnN1YnN0cmluZygwLCAtMSkgOiB1cmxQYXRoOwogICAgICAgICAgICBpZih1cmwuaW5kZXhPZihwYXRoKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHVybCA9IHBhdGggKyB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXJsID0gY2xlYW5VcmwodXJsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIGV4cG9ydHMuZml4dXBVcmwgPSBmaXh1cFVybDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHdoZW4KICAgIHZhciB3ID0gX193X187CgogICAgLy9pbXBvcnQgdyA9IG1vZHVsZSgnd2hlbi9kZWJ1ZycpOwogICAgdmFyIHdoZW5BcHBseSA9IF9fd2hlbkFwcGx5X187CgogICAgdmFyIHdoZW5EZWxheSA9IF9fd2hlbkRlbGF5X187CgogICAgdmFyIHdoZW5UaW1lb3V0ID0gX193aGVuVGltZW91dF9fOwoKICAgIHZhciB3aGVuUGFyYWxsZWwgPSBfX3doZW5QYXJhbGxlbF9fOwoKICAgIHZhciB3aGVuUGlwZWxpbmUgPSBfX3doZW5QaXBlbGluZV9fOwoKICAgIHZhciB3aGVuU2VxdWVuY2UgPSBfX3doZW5TZXF1ZW5jZV9fOwoKICAgIHZhciB3aGVuQ2FuY2VsYWJsZSA9IF9fd2hlbkNhbmNlbGFibGVfXzsKCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnV0aWwKICAgIEBzdWJtb2R1bGUgdGhydXN0LnV0aWwud2hlbgogICAgKiovCiAgICAoZnVuY3Rpb24gKHdoZW4pIHsKICAgICAgICB3aGVuLndoZW4gPSB3OwogICAgICAgIC8qKgogICAgICAgIHdoZW4uYXBwbHksIHVzZWQgdG8gYXBwbHkgd2hlbiByZXN1bHRzIG92ZXIgYSBmdW5jdGlvbiwgc2ltaWxhciB0byBqUXVlcnlzIERlZmVycmVkLgogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHldKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHkpCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudXRpbC53aGVuCiAgICAgICAgQG1ldGhvZCB3aGVuLmFwcGx5CiAgICAgICAgKiovCiAgICAgICAgd2hlbi5hcHBseSA9IHdoZW5BcHBseTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmRlbGF5LCBjcmVhdGVzIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIGluIHggbXMsIHVzaW5nIHNldFRpbWVvdXQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uZGVsYXkKICAgICAgICAqKi8KICAgICAgICB3aGVuLmRlbGF5ID0gd2hlbkRlbGF5OwogICAgICAgIC8qKgogICAgICAgIHdoZW4udGltZW91dCwgY3JlYXRlcyBhIHByb21pc2UgdGhhdCB3aWxsIHRpbWVvdXQgaWYgeCBtcyBpZiBub3QgcmVzb2x2ZWQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi10aW1lb3V0XShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXRpbWVvdXQpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnRpbWVvdXQKICAgICAgICAqKi8KICAgICAgICB3aGVuLnRpbWVvdXQgPSB3aGVuVGltZW91dDsKICAgICAgICAvKioKICAgICAgICB3aGVuLnBhcmFsbGVsCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbF0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbCkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4ucGFyYWxsZWwKICAgICAgICAqKi8KICAgICAgICB3aGVuLnBhcmFsbGVsID0gd2hlblBhcmFsbGVsOwogICAgICAgIC8qKgogICAgICAgIHdoZW4ucGlwZWxpbmUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lXShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lKQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5waXBlbGluZQogICAgICAgICoqLwogICAgICAgIHdoZW4ucGlwZWxpbmUgPSB3aGVuUGlwZWxpbmU7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi5zZXF1ZW5jZQogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2UpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnNlcXVlbmNlCiAgICAgICAgKiovCiAgICAgICAgd2hlbi5zZXF1ZW5jZSA9IHdoZW5TZXF1ZW5jZTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmNhbmNlbGFibGUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWNhbmNlbGFibGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tY2FuY2VsYWJsZSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uY2FuY2VsYWJsZQogICAgICAgICoqLwogICAgICAgIHdoZW4uY2FuY2VsYWJsZSA9IHdoZW5DYW5jZWxhYmxlOwogICAgICAgIHdoZW4uYWxsID0gd2hlbi53aGVuLmFsbDsKICAgICAgICB3aGVuLmFueSA9IHdoZW4ud2hlbi5hbnk7CiAgICAgICAgd2hlbi5jaGFpbiA9IHdoZW4ud2hlbi5jaGFpbjsKICAgICAgICB3aGVuLmRlZmVyID0gd2hlbi53aGVuLmRlZmVyOwogICAgICAgIHdoZW4uaXNQcm9taXNlID0gd2hlbi53aGVuLmlzUHJvbWlzZTsKICAgICAgICB3aGVuLm1hcCA9IHdoZW4ud2hlbi5tYXA7CiAgICAgICAgd2hlbi5yZWR1Y2UgPSB3aGVuLndoZW4ucmVkdWNlOwogICAgICAgIHdoZW4uc29tZSA9IHdoZW4ud2hlbi5zb21lOwogICAgICAgIHdoZW4ucmVzb2x2ZSA9IHdoZW4ud2hlbi5yZXNvbHZlOwogICAgICAgIHdoZW4ucmVqZWN0ID0gd2hlbi53aGVuLnJlamVjdDsKICAgICAgICB3aGVuLmpvaW4gPSB3aGVuLndoZW4uam9pbjsKICAgIH0pKGV4cG9ydHMud2hlbiB8fCAoZXhwb3J0cy53aGVuID0ge30pKTsKICAgIHZhciB3aGVuID0gZXhwb3J0cy53aGVuOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gY2FtZWxDYXNlCiAgICAgICAgdmFyIHJtc1ByZWZpeCA9IC9eLW1zLS8sIHJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwgZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uIChhbGwsIGxldHRlcikgewogICAgICAgIHJldHVybiAobGV0dGVyICsgIiIpLnRvVXBwZXJDYXNlKCk7CiAgICB9OwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICJtcy0iKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogICAgfQogICAgZXhwb3J0cy5jYW1lbENhc2UgPSBjYW1lbENhc2U7CiAgICBmdW5jdGlvbiB1bkNhbWVsQ2FzZShzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyhbQS1aXSkvZywgZnVuY3Rpb24gKGFsbCwgcykgewogICAgICAgICAgICByZXR1cm4gJy0nICsgcy50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy51bkNhbWVsQ2FzZSA9IHVuQ2FtZWxDYXNlOwogICAgLy8jZW5kcmVnCiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3V0aWwnLCBbJ3RocnVzdC91dGlsL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvY2Fwc3VsZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAnLi9sb2cnLCAnaGFzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX2xvZ19fLCBfX2hhc19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZWFjaCA9IF8uZWFjaCwgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgcGx1Y2sgPSBfLnBsdWNrLCBmbGF0dGVuVG9Qcm9taXNlcyA9IHV0aWwuZmxhdHRlblRvUHJvbWlzZXMsIHRocnVzdENhY2hlID0gewogICAgfSwgX19vcHRpb25hbE1ldGhvZHMgPSBbCiAgICAgICAgLy8gT3B0aW9uYWwgbWV0aG9kcyB0aGF0IG1heSBiZSBvbiBhIG1vZHVsZQogICAgICAgICdzdGFydCcsIAogICAgICAgICdzdG9wJywgCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ2NvbmZpZycsIAogICAgICAgIAogICAgXSwgX19yZXF1aXJlZE1ldGhvZHMgPSBbCiAgICAgICAgLy8gUmVxdWlyZWQgbWV0aG9kcyB0aGF0IG11c3QgYmUgb24gZXZlcnkgbW9kdWxlCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnZGVzdHJveScsIAogICAgICAgIAogICAgXTsKICAgIC8qKgogICAgTW92ZXMgYWxsIHByb3BlcnRpZXMsIHRoYXQgc2hvdWxkIGV4aXN0IG91dHNpZGUgb2YgdGhlIG1vZHVsZSwgaW50byBhIHByaXZhdGUgb2JqZWN0IGZvciBob2xkaW5nLgogICAgCiAgICBAbWV0aG9kIG1vdmVUb1RocnVzdENhY2hlCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGZyb20gT2JqZWN0IHRvIGV4dHJhY3QgaXRlbXMgZnJvbQogICAgQHBhcmFtIHtPYmplY3R9IHRvIE9iamVjdCB0byBwbGFjZSBpdGVtcyBvbgogICAgQHBhcmFtIHtBcnJheX0gbGlzdCBJdGVtcyB0byBtb3ZlIGZyb20gdG8gdGhlIG90aGVyIG9iamVjdAogICAgKiovCiAgICBmdW5jdGlvbiBtb3ZlVG9UaHJ1c3RDYWNoZShmcm9tLCB0bywgbGlzdCkgewogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBsaXN0Lmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICB0b1tsaXN0W2ldXSA9IGZyb21bbGlzdFtpXV07CiAgICAgICAgICAgIGRlbGV0ZSBmcm9tW2xpc3RbaV1dOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGdldEV2ZW50TmFtZXNwYWNlKG5hbWUsIHByZWZpeCkgewogICAgICAgIGlmKCFwcmVmaXgpIHsKICAgICAgICAgICAgcHJlZml4ID0gJ21vZHVsZS0nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJy4nICsgKG5hbWUgPT09ICdnbG9iYWwnID8gJ2dsb2JhbCcgOiBwcmVmaXggKyBuYW1lLnJlcGxhY2UoL1wuL2csICctJykpOwogICAgfQogICAgZnVuY3Rpb24gY2FsbEZhY2FkZU1ldGhvZHMobWV0aG9kLCBtb2R1bGVDYWNoZSkgewogICAgICAgIHZhciBtID0gbW9kdWxlQ2FjaGUubW9kdWxlOwogICAgICAgIHZhciByZXN1bHRzID0gW107CiAgICAgICAgXy5mb3JPd24obW9kdWxlQ2FjaGUuZmFjYWRlcywgZnVuY3Rpb24gKGZhY2FkZSwgaSkgewogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ3RocnVzdC9jYXBzdWxlOiBDYWxsaW5nIGZhY2FkZSAiezB9IiB7MX0oKScsIGksIG1ldGhvZCkpOwogICAgICAgICAgICBpZihmYWNhZGVbbWV0aG9kXSAmJiBpc09iamVjdChmYWNhZGUpKSB7CiAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goZmFjYWRlW21ldGhvZF0uY2FsbChmYWNhZGUsIG0pKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJlc3VsdHMucHVzaCh1dGlsLnNhZmVJbnZva2UoKG0udGhydXN0KS5fX3RocnVzdENvbnZlbnRpb25zLCBtZXRob2QsIG0sIG1vZHVsZUNhY2hlLmZhY2FkZXMpKTsKICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgIH0KICAgIC8qKgogICAgVGhlIG1vZHVsZSBpcyB0aGUgaGVhcnQgb2YgdGhlIHRocnVzdCwgZXZlcnkgbW9kdWxlIGdldHMgb25lIGZhY2FkZSBwZXIgbW9kdWxlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgQGNsYXNzIHRocnVzdC5Nb2R1bGUKICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgQHBhcmFtIHtPYmplY3R9IGRlZiBUaGUgbW9kdWxlIGRlZmluaXRpb24KICAgIEBwYXJhbSB7U3RyaW5nfSBbbmFtZV0gVGhlIG1vZHVsZSBuYW1lLgogICAgKiovCiAgICB2YXIgTW9kdWxlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvL3ZhciBNb2R1bGUgPQogICAgICAgIGZ1bmN0aW9uIE1vZHVsZSh0aHJ1c3QsIGRlZiwgbmFtZSkgewogICAgICAgICAgICBuYW1lID0gdGhpcy5uYW1lID0gKG5hbWUgfHwgZGVmLm5hbWUpOwogICAgICAgICAgICBpZih0eXBlb2YgZGVmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBkZWYgPSBkZWYobmFtZSk7CiAgICAgICAgICAgICAgICBkZWYubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1pZCA9IHRoaXMubWlkID0gdGhydXN0Lm5hbWUgKyAnOicgKyBuYW1lOwogICAgICAgICAgICB2YXIgdENhY2hlID0gdGhydXN0Q2FjaGVbZGVmLmhhc2ggfHwgbWlkXTsKICAgICAgICAgICAgLy8gQ2xlYXIgYW55IHBvdGVudGlhbCBjYWNoZWQgY29uZmlnIG9iamVjdHMsIHRvIG1ha2Ugc3VyZSB0aGV5IHJlZnJlc2ggaWYgdGhlIG1vZHVsZSBpcyByZWRlZmluZWQuCiAgICAgICAgICAgIGlmKHRDYWNoZSkgewogICAgICAgICAgICAgICAgXy5rZXlzKHRDYWNoZSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHguaW5kZXhPZignY29uZmlnLicpID09PSAwOwogICAgICAgICAgICAgICAgfSkuZm9yRWFjaChmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGUgdENhY2hlW3hdOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pbnN0YW5jZSA9IGV4dGVuZChkZWYsIHRDYWNoZSAmJiB0Q2FjaGUuaW5zdGFuY2UgfHwgewogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5uYW1lID0gKHRoaXMuaW5zdGFuY2UubmFtZSB8fCBuYW1lKTsKICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5taWQgPSBtaWQ7CiAgICAgICAgICAgIGlmKCF0aGlzLmluc3RhbmNlLm5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQWxsIE1vZHVsZXMgbXVzdCBoYXZlIGEgbmFtZSEnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBNb2R1bGVzIG11c3QgaGF2ZSBhbiBpbml0IG1ldGhvZCBhbmQgYSBkZXN0cm95IG1ldGhvZCwgaXQncyB1cCB0byB0aGUgbW9kdWxlIGRldmVsb3BlciB0byBwb3B1bGF0ZSB0aGVzZSBtZXRob2RzLgogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gX19yZXF1aXJlZE1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZighZGVmW19fcmVxdWlyZWRNZXRob2RzW2ldXSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ1JlcXVpcmVkICJ7MH0iIG1ldGhvZCBub3QgZm91bmQgb24gbW9kdWxlICJ7MX0iIScsIF9fcmVxdWlyZWRNZXRob2RzW2ldLCBuYW1lKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gSWYgdGhlIG1vZHVsZSBuYW1lIGlzIHVuZGVmaW5lZCwgYnJpbmcgdGhlIG5hbWUgaW50byB0aGUgbW9kdWxlLgogICAgICAgICAgICBpZih0eXBlb2YgZGVmLm5hbWUgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICBkZWYubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRocnVzdE1vZHVsZUNhY2hlSXRlbSA9IHRocnVzdENhY2hlW21pZF0gPSBleHRlbmQodENhY2hlIHx8IHsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgX3N0YXJ0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgbmFtZTogdXRpbC5nZXRNb2R1bGVOYW1lRm9yUGF0aChuYW1lKSwKICAgICAgICAgICAgICAgIG1vZHVsZTogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGVsZXRlIHRocnVzdENhY2hlW2RlZi5oYXNoXTsKICAgICAgICAgICAgdmFyIGZhY2FkZXMgPSB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uZmFjYWRlcyB8fCAodGhydXN0TW9kdWxlQ2FjaGVJdGVtLmZhY2FkZXMgPSB7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZighdGhydXN0Ll9fY29udmVudGlvblBsdWNrUHJvcGVydGllc0NhY2hlKSB7CiAgICAgICAgICAgICAgICB0aHJ1c3QuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUgPSBmbGF0dGVuKHBsdWNrKHRocnVzdC5fX2NvbnZlbnRpb25zIHx8IFtdLCAncHJvcGVydGllcycpKS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geC5pbmRleE9mKCdjb25maWcuJykgIT09IDA7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBNb3ZlIGFsbCBzcGVjaWFsIHByb3BlcnRpZXMgb2ZmIHRvIHRoZSB0aHJ1c3QncyBpbnRlcm5hbCBtZXRob2QuCiAgICAgICAgICAgIG1vdmVUb1RocnVzdENhY2hlKHRoaXMuaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbSwgX19yZXF1aXJlZE1ldGhvZHMpOwogICAgICAgICAgICBtb3ZlVG9UaHJ1c3RDYWNoZSh0aGlzLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0sIF9fb3B0aW9uYWxNZXRob2RzKTsKICAgICAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLCB0aHJ1c3QuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUpOwogICAgICAgICAgICB1dGlsLnNhZmVJbnZva2UodGhydXN0LCAnY3JlYXRlRmFjYWRlJywgdGhydXN0LCB0aGlzLmluc3RhbmNlLCBmYWNhZGVzKTsKICAgICAgICAgICAgdGhpcy5fX25hbWVzcGFjZSA9IGdldEV2ZW50TmFtZXNwYWNlKHRoaXMuaW5zdGFuY2UubmFtZSk7CiAgICAgICAgICAgIHRoaXMudGhydXN0ID0gdGhydXN0OwogICAgICAgICAgICB0aGlzLmNhY2hlID0gdGhydXN0Q2FjaGVbbWlkXTsKICAgICAgICB9CiAgICAgICAgTW9kdWxlLnRocnVzdENhY2hlID0gdGhydXN0Q2FjaGU7CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5jb252ZW50aW9uID0gLyoqCiAgICAgICAgR2V0dGVyL1NldHRlciBmb3IgY29udmVudGlvbiBtZXRob2RzLgogICAgICAgIEdldHMgdGhlIHZhbHVlIGNvbnZlbnRpb24gcHJvcGVydHkgKGRlZmluZWQgaW4gdGhlIHByb3BlcnRpZXMgYXJyYXkgb2YgYSBmYWNhZGUpLgogICAgICAgIFNldHMgdGhlIHZhbHVlIG9mIGEgY29udmVudGlvbiBwcm9wZXJ0eSAoZm9yIHN0b3JpbmcgY29udmVudGlvbiBjb25maWd1cmF0aW9uKQogICAgICAgIAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eSBUaGUgcHJvcGVydHkgdG8gZ2V0IG9yIHNldAogICAgICAgIEBwYXJhbSB7b2JqZWN0fSBbdmFsdWVdIFRoZSB2YWx1ZSB0byBzZXQKICAgICAgICBAbWV0aG9kIGNvbnZlbnRpb24KICAgICAgICBAcmV0dXJucyB7T2JqZWN0fSBUaGUgdmFsYXVlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChwcm9wZXJ0eSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHRjID0gdGhpcy5jYWNoZTsKICAgICAgICAgICAgaWYocHJvcGVydHkuaW5kZXhPZignY29uZmlnLicpID09PSAwKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgdGNbcHJvcGVydHldID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgICAgIHRjW3Byb3BlcnR5XSA9IHRoaXMuZ2V0VmFsdWVGcm9tUGF0aChwcm9wZXJ0eSwgdGMpIHx8IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIHRjW3Byb3BlcnR5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0Y1twcm9wZXJ0eV07CiAgICAgICAgfTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLmdldFZhbHVlRnJvbVBhdGggPSBmdW5jdGlvbiAocGF0aCwgb2JqZWN0KSB7CiAgICAgICAgICAgIHZhciBwYXRocyA9IHBhdGguc3BsaXQoJy4nKSwgdiA9IG9iamVjdDsKICAgICAgICAgICAgXy5lYWNoKHBhdGhzLCBmdW5jdGlvbiAocCkgewogICAgICAgICAgICAgICAgdiA9IHYgJiYgdltwXTsKICAgICAgICAgICAgICAgIGlmKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgfTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLnRocnVzdENyZWF0ZSA9IC8qKgogICAgICAgIEluamVjdHMgdGhpcyBtb2R1bGUgaW50byB0aGUgZ2l2ZW4gdGhydXN0IGluc3RhbmNlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgdGhydXN0Q3JlYXRlCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdGhydXN0Ll9faW5qZWN0TW9kdWxlKHRoaXMpOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS50aHJ1c3RDYWxsID0gLyoqCiAgICAgICAgTWFrZXMgYSBjYWxsIHRvIGFsbCB0aGUgbW9kdWxlcyBmYWNhZGVzCiAgICAgICAgVGhlIG9yZGVyIG9mIHRoZSBjYWxsIGRlcGVuZHMgb24gdGhlIG9yZGVyIHJlcXVpcmVkLgogICAgICAgIER1cmluZyB0aGUgc3RhcnR1cCBzdGFnZSAoaW5pdCwgc3RhcnQsIHJlYWR5KSBmYWNhZGVzIGFyZSBjYWxsZWQgZmlyc3QuCiAgICAgICAgRHVyaW5nIHRoZSBzaHV0ZG93biBzdGF0ZSAoc3RvcCwgZGVzdHJveSkgZmFjYWRlcyBhcmUgY2FsbGVkIGxhc3QuCiAgICAgICAgVGhpcyBhbGxvd3MgbW9kdWxlcyB0byBzdGFydHVwIGFuZCBzaHV0ZG93biB3aWxsIGFsbCB0aGUgdG9vbHMgaXQgaGFkIHRvIGJlZ2luIHdpdGguCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB0aHJ1c3RDYWxsCiAgICAgICAgQHByb3RlY3RlZAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgdGhlIG1ldGhvZCB0byBjYWxsCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBmYWNhZGVBZnRlciBjYWxscyBmYWNhZGUgbWV0aG9kcyBiZWZvcmUgb3IgYWZ0ZXIgbW9kdWxlIG1ldGhvZC4KICAgICAgICBAcGFyYW0ge0FycmF5fSBhcmdzIEFyZ3MgdG8gYmUgcGFzc2VkIG9udG8gdGhlIG1vZHVsZSBtZXRob2QuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1ldGhvZCwgZmFjYWRlQWZ0ZXIsIGFyZ3MpIHsKICAgICAgICAgICAgdmFyIHNlcSA9IFtdLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCd0aHJ1c3QvY2Fwc3VsZTogQ2FsbGluZyBmYWNhZGVzIGZvciAiezB9IicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICB2YXIgY2FjaGUgPSB0aGlzLmNhY2hlLCBtID0gY2FjaGVbbWV0aG9kXTsKICAgICAgICAgICAgc2VxLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxGYWNhZGVNZXRob2RzKG1ldGhvZCwgY2FjaGUpOwogICAgICAgICAgICAgICAgaWYocmVzdWx0ICYmIHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihtKSB7CiAgICAgICAgICAgICAgICBzZXEucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG0uYXBwbHkodGhhdC5pbnN0YW5jZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgaWYocmVzdWx0ICYmIHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW5Ub1Byb21pc2VzKHJlc3VsdCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGZhY2FkZUFmdGVyKSB7CiAgICAgICAgICAgICAgICBzZXEucHVzaChzZXEuc2hpZnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdoZW4uc2VxdWVuY2Uoc2VxKTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuc3RhcnQgPSAvKioKICAgICAgICBTdGFydCB0aGUgbW9kdWxlLCBpbnNpZGUgdGhlIHRocnVzdCBjb250YWluZXIgaXQgd2FzIGNyZWF0ZWQgb24uCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC50aHJ1c3Quc3RhcnQodGhhdC5uYW1lKTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuc3RvcCA9IC8qKgogICAgICAgIFN0b3AgdGhlIG1vZHVsZSwgaW5zaWRlIHRoZSB0aHJ1c3QgY29udGFpbmVyIGl0IHdhcyBjcmVhdGVkIG9uLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQudGhydXN0LnN0b3AodGhhdC5uYW1lKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBNb2R1bGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5Nb2R1bGUgPSBNb2R1bGU7ICAgIAogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBtb2R1bGUgaW5zdGFuY2UuCiAgICBGb3JtYXQ6CiAgICB0aHJ1c3QvY2Fwc3VsZSF7aW5zdGFuY2V9Onttb2R1bGVOYW1lfQogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBmdW5jdGlvbiBsb2FkKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwgaW5zdGFuY2VOYW1lID0gcGFydHNbMF0sIG1vZHVsZU5hbWUgPSBwYXJ0c1sxXTsKICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgJ3RocnVzdCEnICsgaW5zdGFuY2VOYW1lCiAgICAgICAgXSwgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgbW9kdWxlID0gdGhydXN0Lm1vZHVsZXNbbW9kdWxlTmFtZV07CiAgICAgICAgICAgIGlmKCFtb2R1bGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ01vZHVsZSAiezB9IiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgInsxfSIuJywgbW9kdWxlTmFtZSwgaW5zdGFuY2VOYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9hZChtb2R1bGUpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y2Fwc3VsZS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9pbnN0YW5jZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2NhcHN1bGUnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fY2Fwc3VsZV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAvKioKICAgIEdldHMgdGhlIHRocnVzdCBpbnN0YW5jZXMuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIHdoZW4gPSB1dGlsLndoZW47CiAgICB2YXIgY2Fwc3VsZSA9IF9fY2Fwc3VsZV9fOwoKICAgIC8qKgogICAgVGhlIGF2YWlsYWJsZSB0aHJ1c3QgaW5zdGFuY2VzCiAgICBpbmRleCBieSBuYW1lCiAgICAKICAgIEBmb3IgdGhydXN0Lmluc3RhbmNlCiAgICBAcHJvcGVydHkgaW5zdGFuY2VzCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBleHBvcnRzLmluc3RhbmNlcyA9IHsKICAgIH07CiAgICAvKioKICAgIFRoZSBsb2FkaW5nIHRodXJzdCBpbnN0YW5jZXMuCiAgICBpbmRleCBieSBuYW1lCiAgICAKICAgIEBwcm9wZXJ0eSBsb2FkaW5nSW5zdGFuY2VzCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXMgPSB7CiAgICB9OwogICAgLyoqCiAgICBHZXRzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAKICAgIEBtZXRob2QgZ2V0SW5zdGFuY2UKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICBAcmV0dXJucyB7VGhydXN0fSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGdldEluc3RhbmNlKG5hbWUpIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5pbnN0YW5jZXNbbmFtZV0gfHwgbnVsbDsKICAgIH0KICAgIGV4cG9ydHMuZ2V0SW5zdGFuY2UgPSBnZXRJbnN0YW5jZTsKICAgIC8qKgogICAgRmV0Y2hzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICBUaGlzIGxvYWRzIGFzeW5jcm9ub3VzbHksIGFzIHRoZSBpbnN0YW5jZSBtYXkgbm90IGJlIGxvYWRlZAogICAgCiAgICBAbWV0aG9kIGZldGNoSW5zdGFuY2UKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgQHJldHVybnMge1Byb21pc2V9IFRvIGEgdGhydXN0IGluc3RhbmNlIHNwZWMKICAgICoqLwogICAgZnVuY3Rpb24gZmV0Y2hJbnN0YW5jZShuYW1lKSB7CiAgICAgICAgdmFyIGRlZmVyID0gZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW25hbWVdIHx8IChleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbbmFtZV0gPSB3aGVuLmRlZmVyKCkpOwogICAgICAgIHJldHVybiBkZWZlcjsKICAgIH0KICAgIGV4cG9ydHMuZmV0Y2hJbnN0YW5jZSA9IGZldGNoSW5zdGFuY2U7CiAgICAvKioKICAgIENsZWFycyB0aGUgVGhydXN0IEluc3RhbmNlIGNhY2hlLCB0aGlzIGlzIHVzZWQgZm9yIHVuaXQgdGVzdGluZywgYW5kIGNsZWFyaW5nIGFsbCB0aGUgY2FjaGUgZGF0YSBlYWNoIHJ1bi4KICAgIAogICAgQG1ldGhvZCBjbGVhckNhY2hlCiAgICBAc3RhdGljCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBmdW5jdGlvbiBjbGVhckNhY2hlKCkgewogICAgICAgIHV0aWwuXy5lYWNoKHV0aWwuXy5rZXlzKGV4cG9ydHMuaW5zdGFuY2VzKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgZXhwb3J0cy5pbnN0YW5jZXNbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgZXhwb3J0cy5pbnN0YW5jZXNbeF07CiAgICAgICAgfSk7CiAgICAgICAgdXRpbC5fLmVhY2godXRpbC5fLmtleXMoZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW3hdID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIGV4cG9ydHMubG9hZGluZ0luc3RhbmNlc1t4XTsKICAgICAgICB9KTsKICAgICAgICB1dGlsLl8uZWFjaCh1dGlsLl8ua2V5cyhjYXBzdWxlLk1vZHVsZS50aHJ1c3RDYWNoZSksIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlW3hdID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlW3hdOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5jbGVhckNhY2hlID0gY2xlYXJDYWNoZTsKICAgIC8qfSovIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWluc3RhbmNlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2NvbmZpZycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnLi9pbnN0YW5jZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3RocnVzdEluc3RhbmNlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGNvbmZpZyB7Ki8KICAgIAogICAgdmFyIHRocnVzdEluc3RhbmNlID0gX190aHJ1c3RJbnN0YW5jZV9fOwoKICAgIC8qKgogICAgUHJvdmlkZXMgdGhydXN0IGNvbmZpZ3VyYXRpb24KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBzdWJtb2R1bGUgdGhydXN0LmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFRoaXMgcHJvcGVydHksIHRlbGxzIHRoZSBmcmFtZXdvcmsgaWYgaXQgc2hvdWxkIHRocm93IGVycm9ycyBvciBub3QuCiAgICBJbiBwcm9kdWN0aW9uIGl0J3MgcmVjb21tZW5kZWQgbm90IHRvIHRocm93IGVycm9ycywgdGhhdCB3YXkgaWYgYSBjb21wb25lbnQgZmFpbHMKICAgIHRoZXJlIGlzIGEgY2hhbmNlIHRoZSBhcHBsaWNhdGlvbiBjYW4gc3RpbGwgcmVjb3Zlci4KICAgIAogICAgQGZvciB0aHJ1c3QuY29uZmlnCiAgICBAcHJvcGVydHkgdGhyb3dFcnJvcnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCBmYWxzZQogICAgKiovCiAgICBleHBvcnRzLnRocm93RXJyb3JzID0gdHJ1ZTsKICAgIC8qKgogICAgVGVsbHMgdGhlIGZyYW1ld29yayB0byBydW4gaW4gYXN5bmMgbW9kZSwgdGhpcyBtYXkgZGVsYXkgc3RhcnQgdXAsIGJ1dCB3aWxsIG1ha2UgaW1hZ2UgbG9hZGluZyBhbmQgaW5pdGFsIHJ1bm5pbmcgYXBwZWFyIGZhc3Rlci4KICAgIAogICAgQHByb3BlcnR5IGFzeW5jCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgQGRlZmF1bHQgdHJ1ZQogICAgKiovCiAgICBleHBvcnRzLmFzeW5jID0gdHJ1ZTsKICAgIC8qKgogICAgVGVsbHMgdGhydXN0IHRvIGV4cG9zZSBlYWNoIGluc3RhbmNlIGFzIGEgZ2xvYmFsLCB0aGlzIGFsbG93cyBsZWdhY3kgY29tcG9uZW50cyB0byB1dGlsaXplIHBhcnRzIG9mIHRocnVzdCwgb3IgZWFzaWx5CiAgICBnZXQgYXQgeW91ciB0aHJ1c3QgaW5zdGFuY2UgZHVyaW5nIGRlYnVnZ2luZy4KICAgIAogICAgQHByb3BlcnR5IGV4cG9zZUdsb2JhbHMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuZXhwb3NlR2xvYmFscyA9IHRydWU7CiAgICBleHBvcnRzLnVybCA9IHsKICAgICAgICBwYXRoOiAvKioKICAgICAgICBUaGlzIHByb3BlcnR5LCBnaXZlcyB0aGUgZnJhbWV3b3JrIGl0J3MgZGVmYXVsdCBwYXRoLCBpZiBkaWZmZXJlbnQgdGhhbiAnLycKICAgICAgICAKICAgICAgICBAcHJvcGVydHkgdXJsLnBhdGgKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7U3RyaW5nfQogICAgICAgIEBkZWZhdWx0ICIvIgogICAgICAgICoqLwogICAgICAgICcvJywKICAgICAgICB0cmFkaXRpb25hbEVuY29kaW5nOiAvKioKICAgICAgICBUaGlzIHByb3BlcnR5LCB0ZWxscyB0aGUgZnJhbWV3b3JrIGhvdyBpdCBzaG91bGQgZW5jb2RlIGFycmF5IGZvcm0gZGF0YS4KICAgICAgICBJbiBnZW5lcmFsLCBmb3IgQVNQLk5FVCBiYXNlZCBhcHBsaWNhdGlvbnMsIHRyYWRpdGlvbmFsIHNob3VsZCBiZSB0cnVlLgogICAgICAgIEZvciBSdWJ5L1B5dGhvbiBiYXNlZCBhcHBsaWNhdGlvbnMsIHRoaXMgc2hvdWxkIGJlIGZhbHNlLgogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSB1cmwudHJhZGl0aW9uYWxFbmNvZGluZwogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgKiovCiAgICAgICAgdHJ1ZQogICAgfTsKICAgIGV4cG9ydHMubG9nID0gewogICAgICAgIGxldmVsOiAvKioKICAgICAgICBUaGlzIGxlbmRzIHRvIHRoZSBsb2cgbGV2ZWwgb2YgdGhydXN0LgogICAgICAgIAogICAgICAgIEVSUk9SOiAxCiAgICAgICAgV0FSTjogMgogICAgICAgIElORk86IDMKICAgICAgICBERUJVRzogNAogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSBsb2cubGV2ZWwKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7U3RyaW5nfQogICAgICAgIEBkZWZhdWx0IDEKICAgICAgICAqKi8KICAgICAgICA0LAogICAgICAgIGVuYWJsZWQ6IC8qKgogICAgICAgIFRoaXMgdG9nZ2xlcyBlbmFibGluZyBvbiBvciBvZmYuCiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IGxvZy5lbmFibGVkCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAqKi8KICAgICAgICB0cnVlCiAgICB9OwogICAgLyoqCiAgICBQbHVnaW5zIGZvciB0aHJ1c3QgdG8gbG9hZCwgb3ZlcnJpZGUgd2l0aCB5b3VyIG93biBzZXQgaWYgeW91IGhhdmUgYSBkaWZmZXJlbnQgc2V0LgogICAgCiAgICBAcHJvcGVydHkgcGx1Z2lucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucGx1Z2lucyA9IFtdOwogICAgLyoqCiAgICAqIFRoZSBzZXQgb2YgbW9kdWxlcyB0byBwcmVsb2FkIHdpdGggdGhlIGluaXRhbCB3aXJldXAgb2YgdGhlIFRocnVzdCBpbnN0YW5jZS4KICAgICoKICAgICogQWNjZXB0cyB0aGUgbW9kdWxlIHBhdGggYSBzdHJpbmcgb3IgdGhlIG1vZHVsZSBhcyBhbiBvYmplY3QgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQuCiAgICAqICAgV2hlcmUgYXJncyB3aWxsIGJlIGhhbmRlZCBvZmYgdG8gdGhlIG1vZHVsZSBsaWZlIGN5Y2xlIG1ldGhvZHMuCiAgICAqCiAgICAqICAgIHsKICAgICogICAgICAgIHBhdGg6ICcnLAogICAgKiAgICAgICAgYXJnczogW10KICAgICogICAgfQogICAgKgogICAgKiBAcHJvcGVydHkgbW9kdWxlcwogICAgKiBAcmVhZE9ubHkKICAgICogQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLm1vZHVsZXMgPSBbXTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbmUgaWYgdGhlIGxpZmUtY3ljbGUgaXMgY29udHJvbGxlZCBieSB0aHJ1c3QsIG9yIGEgcGFyZW50IGluc3RhbmNlLgogICAgCiAgICBAcHJvcGVydHkgY2hpbGRJbnN0YW5jZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5jaGlsZEluc3RhbmNlID0gZmFsc2U7CiAgICAvKioKICAgIFVzZWQgaW50ZXJuYWxseSBieSB0aHJ1c3QgdG8gZGV0ZXJtaW5lIGlmIHRocnVzdCBzaG91bGQgY29udHJvbCB0aGUgbGlmZS1jeWNsZSwgb3IgdGhlIGNvbnN1bWVyCiAgICAKICAgIEBwcm9wZXJ0eSBhdXRvbWF0aWNMaWZlY3ljbGUKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICAqKi8KICAgIGV4cG9ydHMuYXV0b21hdGljTGlmZWN5Y2xlID0gdHJ1ZTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbiBpZiB0aGUgdGhydXN0IGluc3RhbmNlIHNob3VsZCBhdXRvbWF0aWNhbGx5IHN0YXJ0IHVwb24gY3JlYXRpb24uCiAgICAKICAgIEBwcm9wZXJ0eSBhdXRvU3RhcnQKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICAqKi8KICAgIGV4cG9ydHMuYXV0b1N0YXJ0ID0gZmFsc2U7CiAgICAvKioKICAgIERlZmluZSB0aGUgY29udmVudGlvbnMgdGhhdCB1bmlxdWUgdG8gdGhydXN0LCB0aGV5IGFyZSBub3Qgc3BlY2lmaWMgdG8gYW55IG9uZSBwbHVnaW4uCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lcicsIAogICAgICAgICd0aHJ1c3QvY29udmVudGlvbi9hdXRvc3RhcnQnLCAKICAgICAgICAndGhydXN0L2NvbnZlbnRpb24vZGVwZW5kZW50Lm1vZHVsZXMnCiAgICBdOwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBjdXJyZW50IGNvbmZpZyBmb3IgdGhlIGN1cnJlbnQgdGhydXN0IGluc3RhbmNlLCBvciB0aGUgY29uZmlnIG9mIHRoZSBnaXZlbiBwbHVnaW4uCiAgICBBZGRpbmcgdGhlIDogY2hhcmFjdGVyIHJlcXVlc3RzIGEgc3BlY2lmaWMgY29uZmlnIHBsdWdpbi4KICAgIHRocnVzdC9jb25maWchZ2xvYmFsID0gdGhydXN0IWdsb2JhbDpjb25maWcgPSBUaHJ1c3QgaW5zdGFuY2UgY29uZmlnIGZyb20gdGhlIGluc3RhbmNlIG5hbWVkIGdsb2JhbC4KICAgIAogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIHJlYWxOYW1lID0gcGFydHNbMF0sIHBsdWdpbk5hbWUgPSBwYXJ0c1sxXSB8fCBmYWxzZTsKICAgICAgICB2YXIgaW5zdGFuY2VEZWZlcnJlZCA9IHRocnVzdEluc3RhbmNlLmZldGNoSW5zdGFuY2UocmVhbE5hbWUpOwogICAgICAgIGluc3RhbmNlRGVmZXJyZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBwbHVnaW5OYW1lICYmIGNvbnRleHQuY2ZnW3BsdWdpbk5hbWVdIHx8IGNvbnRleHQuY29uZmlnOwogICAgICAgICAgICBpZighcGx1Z2luKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsdWdpbiAiJyArIHBsdWdpbk5hbWUgKyAnIiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgIicgKyByZWFsTmFtZSArICciLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvYWQocGx1Z2luKTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMubG9hZCA9IGxvYWQ7CiAgICAvKn0qLyB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbG9nJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL2NvbmZpZycsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3RDb25maWdfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIC8qKgogICAgQSBiYXNpYyBsb2dnZXIgZm9yIHRoZSB0aHJ1c3QgZnJhbWV3b3JrLgogICAgRGlzYWJsZXMgZGVidWcgbG9nZ2luZyB3aGVuIHRocnVzdCBpcyBub3QgaW4gZGVidWcgbW9kZS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIAogICAgKiovCiAgICAKICAgIC8vIExvZyBsZXZlbHMKICAgIHZhciBMRVZFTCA9IHsKICAgICAgICBERUJVRzogNCwKICAgICAgICBJTkZPOiAzLAogICAgICAgIFdBUk46IDIsCiAgICAgICAgRVJST1I6IDEKICAgIH07CiAgICAvLyBEZWNsYXJlIG91ciB2YXJpYWJsZXMKICAgICAgICB2YXIgY29uc29sZSA9IHdpbmRvdy5jb25zb2xlLCB0aW1lcnMgPSB7CiAgICB9LCBjTG9nID0gKGNvbnNvbGUgJiYgY29uc29sZS5sb2cpIHx8IGZhbHNlLCBjV2FybiA9IChjb25zb2xlICYmIGNvbnNvbGUud2FybikgfHwgZmFsc2UsIGNJbmZvID0gKGNvbnNvbGUgJiYgY29uc29sZS5pbmZvKSB8fCBmYWxzZSwgY0Vycm9yID0gKGNvbnNvbGUgJiYgY29uc29sZS5lcnJvcikgfHwgZmFsc2UsIGNUaW1lID0gKGNvbnNvbGUgJiYgY29uc29sZVsndGltZSddKSB8fCBmYWxzZSwgY1RpbWVFbmQgPSAoY29uc29sZSAmJiBjb25zb2xlWyd0aW1lRW5kJ10pIHx8IGZhbHNlLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgY29uZmlnTGV2ZWwgPSB0Q29uZmlnLmxvZy5sZXZlbCB8fCBMRVZFTC5FUlJPUiwgbG9nTGV2ZWwgPSBMRVZFTFtjb25maWdMZXZlbF0gfHwgKHR5cGVvZiBjb25maWdMZXZlbCA9PT0gJ3N0cmluZycgJiYgTEVWRUxbY29uZmlnTGV2ZWwudG9VcHBlckNhc2UoKV0pIHx8ICh0eXBlb2YgY29uZmlnTGV2ZWwgPT09ICdudW1iZXInICYmIGNvbmZpZ0xldmVsKSB8fCBMRVZFTC5FUlJPUjsKICAgIC8vIFZhcmlvdXMgbG9nZ2VycyB0byBoYW5kbGUgSUU4Lzkgc3VwcG9ydC4KICAgIHZhciBsb2dSdW5uZXIgPSBmdW5jdGlvbiAoY29uc29sZU1ldGhvZCwgbG9nVHlwZSkgewogICAgICAgIC8vIFNob3cgbG9ncyB3aGVuIGVuYWJsZWQgb3IgaWYgdGhleSBhcmUgZXJyb3JzCiAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgaWYoY29uc29sZU1ldGhvZCkgewogICAgICAgICAgICBpZihjb25zb2xlTWV0aG9kLmFwcGx5KSB7CiAgICAgICAgICAgICAgICBjb25zb2xlTWV0aG9kLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZU1ldGhvZChhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZighY29uc29sZU1ldGhvZCAmJiBjTG9nKSB7CiAgICAgICAgICAgIGlmKGNMb2cuYXBwbHkpIHsKICAgICAgICAgICAgICAgIGNMb2cuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjTG9nKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIC8qKgogICAgQSBiYXNpYyBsb2dnZXIgZm9yIHRoZSB0aHJ1c3QgZnJhbWV3b3JrLgogICAgRGlzYWJsZXMgZGVidWcgbG9nZ2luZyB3aGVuIHRocnVzdCBpcyBub3QgaW4gZGVidWcgbW9kZS4KICAgIAogICAgQGNsYXNzIHRocnVzdC5Mb2cKICAgICoqLwogICAgLyoqCiAgICBMb2dzIGEgZGVidWcgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGxvZyBtZXRob2QKICAgIAogICAgQG1ldGhvZCBkZWJ1ZwogICAgKiovCiAgICBmdW5jdGlvbiBkZWJ1ZygpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjTG9nKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICdsb2cnKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmRlYnVnID0gZGVidWc7CiAgICAvKioKICAgIExvZ3MgYSBpbmZvIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSBpbmZvIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgaW5mbwogICAgKiovCiAgICBmdW5jdGlvbiBpbmZvKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5JTkZPKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY0luZm8pOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ2luZm8nKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmluZm8gPSBpbmZvOwogICAgLyoqCiAgICBMb2dzIGEgd2FybiB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgd2FybiBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgCiAgICBAbWV0aG9kIHdhcm4KICAgICoqLwogICAgZnVuY3Rpb24gd2FybigpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuV0FSTikgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNXYXJuKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICd3YXJuJyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy53YXJuID0gd2FybjsKICAgIC8qKgogICAgTG9ncyBhIGVycm9yIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSBlcnJvciBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgCiAgICBAbWV0aG9kIGVycm9yCiAgICAqKi8KICAgIGZ1bmN0aW9uIGVycm9yKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5FUlJPUikgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNFcnJvcik7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnZXJyb3InKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmVycm9yID0gZXJyb3I7CiAgICAvKioKICAgIExvZ3MgYSB0aW1lIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSB0aW1lIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgdGltZQogICAgKiovCiAgICBmdW5jdGlvbiB0aW1lKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdGltZXJzW21lc3NhZ2VdID0gewogICAgICAgICAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBtc2cgPSB1dGlsLmZvcm1hdCgnezB9OiB0aW1lciBzdGFydGVkJywgbWVzc2FnZSksIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChtc2cpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1RpbWUpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy50aW1lID0gdGltZTsKICAgIC8qKgogICAgTG9ncyBhIHRpbWVFbmQgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIHRpbWVFbmQgbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIENhdXNlcyB0aGUgdGltZXIgdG8gZW5kLCBmb3IgdGhlIGdpdmVuIG1lc3NhZ2UuCiAgICAKICAgIEBtZXRob2QgdGltZUVuZAogICAgKiovCiAgICBmdW5jdGlvbiB0aW1lRW5kKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdGltZXJzW21lc3NhZ2VdLmVuZCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CiAgICAgICAgICAgIHZhciB0aW1lID0gdGltZXJzW21lc3NhZ2VdLmVuZCAtIHRpbWVyc1ttZXNzYWdlXS5zdGFydCwgbXNnID0gdXRpbC5mb3JtYXQoJ3swfTogezF9bXMnLCBtZXNzYWdlLCB0aW1lKTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChtc2cpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1RpbWVFbmQpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy50aW1lRW5kID0gdGltZUVuZDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bG9nLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2lnbml0ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnbW9kdWxlJywgJ3RocnVzdC91dGlsJywgJy4vY29uZmlnJywgJy4vY2Fwc3VsZScsICcuL2luc3RhbmNlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fcmVxdWlyZU1vZHVsZV9fLCBfX3V0aWxfXywgX19jb25maWdfXywgX190bV9fLCBfX2luc3RhbmNlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHJlcXVpcmVNb2R1bGUgPSBfX3JlcXVpcmVNb2R1bGVfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICB2YXIgdG0gPSBfX3RtX187CgogICAgdmFyIGluc3RhbmNlID0gX19pbnN0YW5jZV9fOwoKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgaXNBcnJheSA9IF8uaXNBcnJheSwgdG9BcnJheSA9IF8udG9BcnJheSwgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgZWFjaCA9IF8uZWFjaCwgbWFwID0gXy5tYXAsIGFueSA9IF8uYW55LCBhbGwgPSBfLmFsbCwgd2hlbiA9IHV0aWwud2hlbiwgZXh0ZW5kID0gXy5leHRlbmQsIGZsYXR0ZW4gPSBfLmZsYXR0ZW4sIHBsdWNrID0gXy5wbHVjaywgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBrZXlzID0gXy5rZXlzLCB1bmlvbiA9IF8udW5pb247CiAgICAvKmZ1bmN0aW9uIHJlY29uY2lsZUFycmF5cyhjb25maWcsIHNldHRpbmdzLCB0bykKICAgIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKGNvbmZpZyk7CiAgICBpZiAoc2V0dGluZ3MpCiAgICB7CiAgICBrZXlzID0gdW5pb24oXy5rZXlzKHNldHRpbmdzKSwga2V5cyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICBzZXR0aW5ncyA9IHt9OwogICAgfQogICAgZWFjaChrZXlzLCBmdW5jdGlvbiAoaSkKICAgIHsKICAgIHZhciB4ID0gc2V0dGluZ3NbaV0gfHwgY29uZmlnW2ldOwogICAgaWYgKGlzQXJyYXkoeCkpCiAgICB7CiAgICB0b1tpXSA9IHRvQXJyYXkoc2V0dGluZ3NbaV0gfHwgdG9baV0pOwogICAgfQogICAgZWxzZSBpZiAoaXNPYmplY3QoeCkgJiYgIWlzRnVuY3Rpb24oeCkpCiAgICB7CiAgICByZWNvbmNpbGVBcnJheXMoeCwgbnVsbCwgdG9baV0pOwogICAgfQogICAgfSk7CiAgICB9Ki8KICAgIGZ1bmN0aW9uIG1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpIHsKICAgICAgICBpZigoc2V0dGluZ3MpLl9fc2V0dGluZ3NNZXJnZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHNldHRpbmdzOwogICAgICAgIH0KICAgICAgICB2YXIgcmVxdWlyZUNvbmZpZyA9IHJlcXVpcmVNb2R1bGUuY29uZmlnKCksIHBsdWdpbnMgPSBbCiAgICAgICAgICAgICd0aHJ1c3QvbWVkaWF0b3InCiAgICAgICAgXS5jb25jYXQoc2V0dGluZ3MucGx1Z2lucyB8fCByZXF1aXJlQ29uZmlnLnBsdWdpbnMgfHwgY29uZmlnLnBsdWdpbnMgfHwgW10pLCBjb252ZW50aW9ucyA9IFtdLmNvbmNhdChzZXR0aW5ncy5jb252ZW50aW9ucyB8fCByZXF1aXJlTW9kdWxlLmNvbmZpZygpLmNvbnZlbnRpb25zIHx8IGNvbmZpZy5wbHVnaW5zIHx8IFtdKTsKICAgICAgICBzZXR0aW5ncyA9IF8ubWVyZ2UoewogICAgICAgIH0sIGNvbmZpZywgcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgc2V0dGluZ3MsIHsKICAgICAgICAgICAgX19zZXR0aW5nc01lcmdlZDogdHJ1ZSwKICAgICAgICAgICAgcGx1Z2luczogcGx1Z2lucywKICAgICAgICAgICAgY29udmVudGlvbnM6IGNvbnZlbnRpb25zCiAgICAgICAgfSk7CiAgICAgICAgc2V0dGluZ3MucGx1Z2lucyA9IHBsdWdpbnM7CiAgICAgICAgc2V0dGluZ3MuY29udmVudGlvbnMgPSBjb252ZW50aW9uczsKICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICB9CiAgICBleHBvcnRzLm1lcmdlU2V0dGluZ3MgPSBtZXJnZVNldHRpbmdzOwogICAgZnVuY3Rpb24gZnVzZShzZXR0aW5ncykgewogICAgICAgIHZhciBwaXBlID0gW107CiAgICAgICAgc2V0dGluZ3MgPSBtZXJnZVNldHRpbmdzKHNldHRpbmdzKTsKICAgICAgICBpZighaW5zdGFuY2UuaW5zdGFuY2VzW3NldHRpbmdzLm5hbWVdKSB7CiAgICAgICAgICAgIHBpcGUucHVzaChzdGFnZU9uZSk7CiAgICAgICAgfQogICAgICAgIHBpcGUucHVzaChzdGFnZVR3byk7CiAgICAgICAgaWYoc2V0dGluZ3MubW9kdWxlcyAmJiBzZXR0aW5ncy5tb2R1bGVzLmxlbmd0aCkgewogICAgICAgICAgICBwaXBlLnB1c2goc3RhZ2VUaHJlZSk7CiAgICAgICAgfQogICAgICAgIHZhciBwcm9taXNlID0gd2hlbi5waXBlbGluZShwaXBlLCBzZXR0aW5ncyk7CiAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLmZ1c2UgPSBmdXNlOwogICAgLyoqCiAgICBDb250cnVjdHMgYSB3aXJlIHNwZWMgZm9yIHRocnVzdCB0byBsYXVuY2ggZnJvbS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgLyoqCiAgICBNZXJnZXMgYSBhbGwgdGhlIHBsdWdpbnMgY29uZmlndXJhdGlvbnMsIHdpdGggdGhlIGRlZmF1bHQgY29uZmlnLCBhbmQgdGhlbiBmaW5hbGx5IHdpdGgKICAgIGFueSBjdXN0b21pemVkIGNvbmZpZyBmcm9tIHJlcXVpcmVqcwogICAgCiAgICBAbWV0aG9kIHN0YWdlT25lCiAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbnRzIHRvIHBhc3Mgb250byB0aGUgdGhydXN0IGluc3RhbmNlIGJlaW5nIGNyZWF0ZWQuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlT25lKHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICAgICAgICAgIHZhciBwbHVnaW5zID0gc2V0dGluZ3MucGx1Z2lucywgcmVxdWlyZUNvbmZpZyA9IHJlcXVpcmVNb2R1bGUuY29uZmlnKCksIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgIHNldHRpbmdzLnBsdWdpbnMgPSBwbHVnaW5zOwogICAgICAgIHJlcXVpcmUocGx1Z2lucy5tYXAoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgfSksIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIHBsdWdpbnMuZm9yRWFjaChmdW5jdGlvbiAocGx1Z2luLCBpKSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxKSwgcGx1Z2luU2V0dGluZ3MgPSBzZXR0aW5nc1tuYW1lXSB8fCB7CiAgICAgICAgICAgICAgICB9LCBwbHVnaW5SZXF1aXJlQ29uZmlnID0gcmVxdWlyZUNvbmZpZ1tuYW1lXSB8fCB7CiAgICAgICAgICAgICAgICB9LCBwbHVnaW5DbGFzcyA9IGFyZ3NbaV1bYXJnc1tpXS5jbGFzc05hbWVdOwogICAgICAgICAgICAgICAgaWYoIWNvbmZpZ1tuYW1lXSkgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZ1tuYW1lXSA9IF8ubWVyZ2UocGx1Z2luQ2xhc3MuY29uZmlnLCBwbHVnaW5SZXF1aXJlQ29uZmlnIHx8IHsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjb252ZW50aW9ucyA9IFtdLmNvbmNhdChwbHVnaW5TZXR0aW5ncy5jb252ZW50aW9ucyB8fCBwbHVnaW5SZXF1aXJlQ29uZmlnLmNvbnZlbnRpb25zIHx8IGNvbmZpZ1tuYW1lXS5jb252ZW50aW9ucyB8fCBbXSk7CiAgICAgICAgICAgICAgICBzZXR0aW5nc1tuYW1lXSA9IF8ubWVyZ2UoewogICAgICAgICAgICAgICAgfSwgY29uZmlnW25hbWVdLCBwbHVnaW5TZXR0aW5ncyB8fCB7CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgY29udmVudGlvbnM6IGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHNldHRpbmdzW25hbWVdLmNvbnZlbnRpb25zID0gY29udmVudGlvbnM7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWZlci5yZXNvbHZlKHNldHRpbmdzKTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZU9uZSA9IHN0YWdlT25lOwogICAgLyoqCiAgICBDcmVhdGVzIGEgdGhydXN0IGluc3RhbmNlLCBmcm9tIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgIEluY2x1ZGluZyB0aGUgcGx1Z2lucy4KICAgIAogICAgQG1ldGhvZCBzdGFnZVR3bwogICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW50cyB0byBwYXNzIG9udG8gdGhlIHRocnVzdCBpbnN0YW5jZSBiZWluZyBjcmVhdGVkLgogICAgKiovCiAgICBmdW5jdGlvbiBzdGFnZVR3byhzZXR0aW5ncykgewogICAgICAgIC8qanNoaW50IGxvb3BmdW5jOnRydWUgKi8KICAgICAgICAvLyBHZXQgdGhlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgIHZhciBsb2NhbENvbmZpZyA9IHNldHRpbmdzLCBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAvLyBNZWRpYXRvciBpcyBhIHJlcXVpcmVkIHBsdWdpbiwgaW5jbHVkZSBhbGwgdGhlIG90aGVycyBpbiBhZGRpdGlvbiB0byBpdC4KICAgICAgICAgICAgICAgIHZhciBwbHVnaW5zID0gbG9jYWxDb25maWcucGx1Z2lucywgbW9kdWxlc1RvTG9hZCA9IC8vIFRoZSBtb2R1bGVzIHRvIGxvYWQKICAgICAgICBbXSwgdGhydXN0Q29udmVudGlvbnMgPSBzZXR0aW5ncy5jb252ZW50aW9ucyB8fCBbXSwgbW9kdWxlc0NvbmZpZ3VyYXRpb25zID0gLy8gVGhlIG1vZHVsZSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgIHsKICAgICAgICAgICAgdGhydXN0OiAndGhydXN0JwogICAgICAgIH07CiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGx1Z2lucywgY3JlYXRpbmcgYSBwcm9wZXIgZGVwZW5kYW5jeSBsaXN0LgogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBwbHVnaW5zLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICB2YXIgcGx1Z2luID0gcGx1Z2luc1tpXSwgbmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxKSwgcGx1Z2luQ29uZmlnID0gbG9jYWxDb25maWdbbmFtZV07CiAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaChwbHVnaW4pOwogICAgICAgICAgICBtb2R1bGVzVG9Mb2FkLnB1c2gocGx1Z2luQ29uZmlnICYmIHBsdWdpbkNvbmZpZy5jb252ZW50aW9ucyB8fCBbXSk7CiAgICAgICAgICAgIG1vZHVsZXNDb25maWd1cmF0aW9uc1twbHVnaW5dID0gcGx1Z2luQ29uZmlnOwogICAgICAgIH0KICAgICAgICAvLyBOYW1lIGFuZCBjZmcgYXJlIGRlZmF1bHQgcHJvcGVydGllcyBvZiB0aGUgY29uZmlndXJhdGlvbiBjb250ZXh0CiAgICAgICAgICAgICAgICB2YXIgb3JkZXJlZFBsdWdpbnMgPSBbCiAgICAgICAgICAgICduYW1lJywgCiAgICAgICAgICAgICdjZmcnCiAgICAgICAgXSwgcmVsb29wID0gLy8gV2UgbG9vcCB0aHJvdWdoIHVudGlsIGFsbCB0aGUgcGx1Z2lucyBhcmUgaW4gcHJvcGVyIG9yZGVyLgogICAgICAgIHRydWUsIGlMZW4gPSBtb2R1bGVzVG9Mb2FkLmxlbmd0aCwgaSA9IDA7CiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGx1Z2lucyB1bnRpbCB3ZSBoYXZlIGEgc2V0IHRoYXQgd2lsbCBsb2FkIGluIHByb3BlciBvcmRlci4KICAgICAgICB3aGlsZShpIDwgaUxlbikgewogICAgICAgICAgICAvLyBUaGUgcGx1Z2luCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwbHVnaW4gPSBtb2R1bGVzVG9Mb2FkW2ldLCBuYW1lID0gLy8gVGhlIGltcGxpZWQgcGx1Z2luIG5hbWUKICAgICAgICAgICAgcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5Db25maWcgPSAvLyBUaGUgcGx1Z2lucyBjb25maWd1cmF0aW9uCiAgICAgICAgICAgIGxvY2FsQ29uZmlnW25hbWVdOwogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcGx1Z2luIGhhcyB0byByZXNvbHZlIGFueSBvdGhlciBwbHVnaW5zCiAgICAgICAgICAgIGlmKHBsdWdpbkNvbmZpZyAmJiBwbHVnaW5Db25maWcucmVzb2x2ZSAmJiBwbHVnaW5Db25maWcucmVzb2x2ZS5sZW5ndGggPiAwICYmICFhbGwocGx1Z2luQ29uZmlnLnJlc29sdmUsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYW55KG9yZGVyZWRQbHVnaW5zLCBmdW5jdGlvbiAoeikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB4ID09PSB6IHx8IHggPT09IHo7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkpIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBtb2R1bGVzIHRvIGxvYWQuCiAgICAgICAgICAgICAgICAvLyBBbHNvIGluY2x1ZGVzIGFueSBjb252ZW50aW9ucy4KICAgICAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaC5hcHBseShtb2R1bGVzVG9Mb2FkLCBtb2R1bGVzVG9Mb2FkLnNwbGljZShpLCAyKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZW9yZGVyIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgIG9yZGVyZWRQbHVnaW5zLnB1c2gobmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gVGhlIG1vZHVsZXMgY29uZmlnCiAgICAgICAgdmFyIG1vZHVsZXMgPSBsb2NhbENvbmZpZy5tb2R1bGVzIHx8IFtdOwogICAgICAgIC8vIFRocnVzdCBhbmQgdGhydXN0L2NhcHN1bGUgYWxzbyBuZWVkIHRvIGJlIGxvYWRlZC4KICAgICAgICBtb2R1bGVzVG9Mb2FkLnB1c2guYXBwbHkobW9kdWxlc1RvTG9hZCwgWwogICAgICAgICAgICAndGhydXN0JywgCiAgICAgICAgICAgIHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IFtdCiAgICAgICAgXSk7CiAgICAgICAgLy8gRmxhdHRlbiB0aGUgcmVzdWx0YW50IGFycmF5CiAgICAgICAgbW9kdWxlc1RvTG9hZCA9IGZsYXR0ZW4obW9kdWxlc1RvTG9hZCk7CiAgICAgICAgLy8gQ3JlYXRlIHRoZSBjb25maWd1cmF0aW9uIHNwZWMKICAgICAgICB2YXIgc3BlYyA9IHsKICAgICAgICAgICAgbmFtZTogbG9jYWxDb25maWcubmFtZSB8fCAnZ2xvYmFsJywKICAgICAgICAgICAgY2ZnOiBsb2NhbENvbmZpZwogICAgICAgIH07CiAgICAgICAgLy8gTG9hZCBldmVyeXRoaW5nCiAgICAgICAgcmVxdWlyZShtb2R1bGVzVG9Mb2FkLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEdldCByZWFkeSB0byBsb29wCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50UGx1Z2luID0gbnVsbCwgYWxsQ29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgbW9kdWxlcyBiZWluZyBsb2FkZWQKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG1vZHVsZXNUb0xvYWQubGVuZ3RoOyBpIDwgaUxlbiAtIHRocnVzdENvbnZlbnRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgcGx1Z2luIGFuZCBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbiA9IG1vZHVsZXNUb0xvYWRbaV0sIG1Db25maWcgPSBtb2R1bGVzQ29uZmlndXJhdGlvbnNbcGx1Z2luXTsKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlIGhhdmUgYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgaWYobUNvbmZpZykgewogICAgICAgICAgICAgICAgICAgIC8vIExvYWQgYSBuZXcgcGx1Z2luLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbk9iamVjdCA9IGFyZ3NbaV0sIG5hbWUgPSAvLyBHZXQgdGhlIHBsdWdpbiBuYW1lCiAgICAgICAgICAgICAgICAgICAgcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCByZXNvbHZlSXRlbXMgPSAvLyBSZXNvbHZlIGFsbCB0aGUgcmVxdWlyZWQgaXRlbXMuCiAgICAgICAgICAgICAgICAgICAgbWFwKG1Db25maWcucmVzb2x2ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNwZWNbeF07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbkNsYXNzID0gcGx1Z2luT2JqZWN0W3BsdWdpbk9iamVjdC5jbGFzc05hbWVdOwogICAgICAgICAgICAgICAgICAgIC8vIEluc3RhbnRpYXRlIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGx1Z2luID0gc3BlY1tuYW1lXSA9IHV0aWwuaW5zdGFudGlhdGUocGx1Z2luQ2xhc3MsIHJlc29sdmVJdGVtcyk7CiAgICAgICAgICAgICAgICAgICAgLy8gU2V0dXAgdGhlIGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgICAgICB9IGVsc2UgLy8gTG9hZCBhbGwgdGhlIGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICBpZihjdXJyZW50UGx1Z2luKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29udmVudGlvbnMgaW50byB0aGUgcGx1Z2luCiAgICAgICAgICAgICAgICAgICAgXy5mb3JPd24oYXJnc1tpXSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRQbHVnaW4uX19jb252ZW50aW9ucy5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIExvYWQgdGhlIGNvbnZlbnRpb25zIGludG8gdGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICAgICAgICAgICAgICBfLmZvck93bihhcmdzW2ldLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWxsQ29udmVudGlvbnMucHVzaCh4KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBUaGUgbGFzdCBjdXJyZW50IHBsdWdpbiwgd2lsbCBhbHdheXMgYmUgdGhydXN0LgogICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fY29udmVudGlvbnMgPSBhbGxDb252ZW50aW9uczsKICAgICAgICAgICAgdmFyIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyA9IGFyZ3Muc2xpY2UobW9kdWxlc1RvTG9hZC5sZW5ndGggLSB0aHJ1c3RDb252ZW50aW9ucy5sZW5ndGgpOwogICAgICAgICAgICB0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnMgPSBmbGF0dGVuKG1hcCh0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWFwKHgsIGZ1bmN0aW9uICh6KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHo7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fdGhydXN0Q29udmVudGlvbnMgPSB0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnM7CiAgICAgICAgICAgIGFsbENvbnZlbnRpb25zLnB1c2guYXBwbHkoYWxsQ29udmVudGlvbnMsIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyk7CiAgICAgICAgICAgIC8vIEV4dGVuZCB0aHJ1c3Qgd2l0aCB0aGUgc3BlYwogICAgICAgICAgICBleHRlbmQoY3VycmVudFBsdWdpbiwgc3BlYyk7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoc3BlYyk7CiAgICAgICAgfSwgZGVmZXIucmVqZWN0KTsKICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgIH0KICAgIGV4cG9ydHMuc3RhZ2VUd28gPSBzdGFnZVR3bzsKICAgIC8qKgogICAgTG9hZHMgdXAgdGhlIGRlZmF1bHQgbW9kdWxlcyBhcyBpbmRpY2F0ZWQgdG8gdGhydXN0LgogICAgCiAgICBAbWV0aG9kIHN0YWdlVGhyZWUKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIHVzZSB0byBsb2FkIHRoZSBtb2R1bGVzLgogICAgKiovCiAgICBmdW5jdGlvbiBzdGFnZVRocmVlKGNvbnRleHQpIHsKICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3QsIGRlZmVyID0gd2hlbi5kZWZlcigpLCBtb2R1bGVzID0gY29udGV4dC5jZmcubW9kdWxlczsKICAgICAgICBtb2R1bGVzID0gXy5maWx0ZXIobW9kdWxlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuICF0aHJ1c3QubW9kdWxlc1t4XTsKICAgICAgICB9KTsKICAgICAgICByZXF1aXJlKG1vZHVsZXMsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIE1vZHVsZSA9IHRtLk1vZHVsZTsKICAgICAgICAgICAgLy8gR2V0IHRoZSBkZWZpbml0aW9ucwogICAgICAgICAgICB2YXIgbW9kdWxlRGVmaW5pdGlvbnMgPSBhcmdzOwogICAgICAgICAgICAvLyBMb29wIG92ZXIgYWxsIHRoZSBtb2R1bGVzCiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBtb2R1bGVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBtb2R1bGUgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2QgPSBtb2R1bGVzW2ldLCBkZWZpbml0aW9uID0gLy8gR2V0IHRoZSBkZWZpbml0aW9uCiAgICAgICAgICAgICAgICBtb2R1bGVEZWZpbml0aW9uc1tpXTsKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgaW5zdGFuY2UKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG5ldyBNb2R1bGUodGhydXN0LCBkZWZpbml0aW9uLCBtb2QpOwogICAgICAgICAgICAgICAgLy8gSW5qZWN0IGl0IGludG8gdGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgICAgICAgICAgbW9kdWxlSW5zdGFuY2UudGhydXN0Q3JlYXRlKHRocnVzdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmZXIucmVzb2x2ZShjb250ZXh0KTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZVRocmVlID0gc3RhZ2VUaHJlZTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9aWduaXRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJy4vbG9nJywgJy4vaW5zdGFuY2UnLCAnLi9pZ25pdGUnLCAnLi9jYXBzdWxlJywgJ2RvbVJlYWR5JywgJ2hhcycsICd0aHJ1c3QvY29uZmlnJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX2xvZ19fLCBfX3RocnVzdEluc3RhbmNlX18sIF9faWduaXRlU3BlY19fLCBfX21fXywgX19kb21SZWFkeV9fLCBfX2hhc19fLCBfX3RDb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgdGhydXN0SW5zdGFuY2UgPSBfX3RocnVzdEluc3RhbmNlX187CgogICAgdmFyIGlnbml0ZVNwZWMgPSBfX2lnbml0ZVNwZWNfXzsKCiAgICB2YXIgbSA9IF9fbV9fOwoKICAgIHZhciBNb2R1bGUgPSBtLk1vZHVsZTsKICAgIHZhciBkb21SZWFkeSA9IF9fZG9tUmVhZHlfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgdENvbmZpZyA9IF9fdENvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ1RocnVzdCc7CiAgICAvKioKICAgIFRoZSB0aHJ1c3QgYXBwbGljYXRpb24hCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAbWFpbiB0aHJ1c3QKICAgICoqLwogICAgICAgIHZhciBJTklUID0gJ2luaXQnLCBTVEFSVCA9ICdzdGFydCcsIFJFQURZID0gJ3JlYWR5JywgU1RPUCA9ICdzdG9wJywgREVTVFJPWSA9ICdkZXN0cm95JywgQ09VTlRET1dOID0gJ2NvdW50ZG93bicsIElHTklURSA9ICdpZ25pdGUnLCBPUkJJVCA9ICdvcmJpdCcsIERFUExPWSA9ICdkZXBsb3knLCBERU9SQklUID0gJ2Rlb3JiaXQnLCBTUExBU0hET1dOID0gJ3NwbGFzaGRvd24nLCBJTk9SQklUID0gJ2luT3JiaXQnLCBtZW1vaXplID0gXy5tZW1vaXplLCBlYWNoID0gXy5lYWNoLCBtYXAgPSBfLm1hcCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIGJpbmQgPSBfLmJpbmQsIGlzQXJyYXkgPSBfLmlzQXJyYXksIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCB0b0FycmF5ID0gXy50b0FycmF5LCBtZXJnZSA9IF8ubWVyZ2UsIGZsYXR0ZW4gPSBfLmZsYXR0ZW4sIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCByZXNvbHZlTWV0aG9kcyA9IFsKICAgICAgICBJTklULCAKICAgICAgICBTVEFSVCwgCiAgICAgICAgUkVBRFksIAogICAgICAgIFNUT1AsIAogICAgICAgIERFU1RST1kKICAgIF0sIGluc3RhbmNlcyA9IHRocnVzdEluc3RhbmNlLmluc3RhbmNlcywgbG9hZGluZ0luc3RhbmNlcyA9IHRocnVzdEluc3RhbmNlLmxvYWRpbmdJbnN0YW5jZXMsIHNhZmVJbnZva2UgPSB1dGlsLnNhZmVJbnZva2U7CiAgICAvLyNyZWdpb24gUnVubmVyIEZhY3RvcmllcwogICAgdmFyIHJ1blJ1bm5lckZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICB2YXIgY29udmVudGlvbk1ldGhvZCA9IChtZXRob2QgPT09IFNUT1AgJiYgU1RBUlQpIHx8IChtZXRob2QgPT09IERFU1RST1kgJiYgSU5JVCkgfHwgbWV0aG9kLCBjb252ZW50aW9uVmFsdWUgPSAhKG1ldGhvZCA9PT0gU1RPUCB8fCBtZXRob2QgPT09IERFU1RST1kpLCB1bnNldFJlYWR5ID0gbWV0aG9kID09PSBTVE9QLCBjb252ZW50aW9uQ2hlY2sgPSBjb252ZW50aW9uTWV0aG9kICE9PSBtZXRob2QsIGNvbnZlbnRpb25OYW1lID0gZm9ybWF0KCd7MH0tc3RhdHVzJywgY29udmVudGlvbk1ldGhvZCksIHJ1bm5lciA9IHJ1bm5lckZhY3RvcnkobWV0aG9kLCBjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlLCB1bnNldFJlYWR5KSwgbG9nTWVzc2FnZSA9IGZvcm1hdCgnVGhydXN0OiB7MH1pbmcgbW9kdWxlICJ7ezB9fSIgZmFpbGVkIScsIG1ldGhvZCksIHJ1bm5pbmdNZXNzYWdlID0gZm9ybWF0KCdUaHJ1c3Q6IFJ1bm5pbmcgezB9IGZvciBtb2R1bGUgInt7MH19Ii4nLCBtZXRob2QpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZXMpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighaXNBcnJheShuYW1lcykpIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gWwogICAgICAgICAgICAgICAgICAgIG5hbWVzCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzLCByZXN1bHRzID0gW107CiAgICAgICAgICAgIGVhY2gobmFtZXMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQocnVubmluZ01lc3NhZ2UsIG5hbWUpKTsKICAgICAgICAgICAgICAgIHZhciBtb2QgPSB0aGF0Lm1vZHVsZXNbbmFtZV07CiAgICAgICAgICAgICAgICBpZighbW9kICYmICF0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAvLyB0cnkgdG8gZmV0Y2ggdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm5pbmcgdGhlIHByb3BlciBkZWZlciBpbiBpdCdzIHBsYWNlCiAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRlckRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lCiAgICAgICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKG1vZHVsZURlZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jcmVhdGVNb2R1bGUobW9kdWxlRGVmbiAmJiBtb2R1bGVEZWZuLm5hbWUgfHwgbmFtZSwgbW9kdWxlRGVmbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlRGVmbi5uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbi5jaGFpbih3aGVuLmFsbChmbGF0dGVuKHJlc3VsdCkpLCBsb2FkZXJEZWZlcik7CiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXJEZWZlci5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGxvYWRlckRlZmVyLnByb21pc2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKChjb252ZW50aW9uQ2hlY2sgJiYgbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB8fCAhbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYodHJ1ZSAmJiB0Q29uZmlnLnRocm93RXJyb3JzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChydW5uZXIodGhhdCwgbmFtZSwgbW9kLCBhcmdzKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5ICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVubmVyKHRoYXQsIG5hbWUsIG1vZCwgYXJncykpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5lcnJvcihmb3JtYXQobG9nTWVzc2FnZSwgbmFtZSksIGUsIGUuc3RhY2spOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHMubGVuZ3RoICYmIHJlc3VsdHM7CiAgICAgICAgfTsKICAgIH0pOwogICAgdmFyIHJ1bm5lckZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChtZXRob2QsIGNvbnZlbnRpb25OYW1lLCBjb252ZW50aW9uVmFsdWUsIHVuc2V0UmVhZHkpIHsKICAgICAgICB2YXIgZXZlbnROYW1lID0gZm9ybWF0KCd0aHJ1c3QvbW9kdWxlL3swfScsIG1ldGhvZCksIGluZm9Gb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogezB9aW5nIG1vZHVsZSAie3swfX0iJywgbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnN1YnN0cmluZygxKSksIGRlYnVnRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IENhbGxpbmcgbW9kdWxlICJ7ezB9fSIgezB9KCknLCBtZXRob2QpLCBjb21wQWZ0ZXIgPSBtZXRob2QgPT09IFNUT1AgfHwgbWV0aG9kID09PSBERVNUUk9ZIHx8IGZhbHNlOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAodGhhdCwgbmFtZSwgbW9kLCBhcmdzKSB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIG5hbWUpKTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KGNvbnZlbnRpb25OYW1lLCBuYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0Q2FsbChtZXRob2QsIGNvbXBBZnRlciwgX19nZXRNb2R1bGVBcmdzKHRoYXQubmFtZSwgbmFtZSwgYXJncykpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhhdC5tZWRpYXRvciAmJiB0aGF0Lm1lZGlhdG9yLmZpcmUoZXZlbnROYW1lLCBuYW1lKTsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKGNvbnZlbnRpb25OYW1lLCBjb252ZW50aW9uVmFsdWUpOwogICAgICAgICAgICAgICAgaWYodW5zZXRSZWFkeSkgewogICAgICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKFJFQURZICsgJy1zdGF0dXMnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9KTsKICAgIHZhciBhbGxSdW5uZXJGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgdmFyIGluZm9Gb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogezB9aW5nIGFsbCBtb2R1bGVzLi4uIFt7ezB9fV0nLCBtZXRob2QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBtZXRob2Quc3Vic3RyaW5nKDEpKSwgcGx1cmFsTmFtZSA9IGZvcm1hdCgndGhydXN0L21vZHVsZS9hbGwvezB9JywgbWV0aG9kKSwgY2hlY2tBdXRvU3RhcnQgPSBtZXRob2QgPT09IElOSVQgfHwgbWV0aG9kID09PSBTVEFSVCB8fCBtZXRob2QgPT09IFJFQURZOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAodGhhdCkgewogICAgICAgICAgICB0aGF0Lm1lZGlhdG9yICYmIHRoYXQubWVkaWF0b3IuZmlyZShwbHVyYWxOYW1lKTsKICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSB0aGF0Lm1vZHVsZXMsIHJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoaW5mb0Zvcm1hdCwgbWFwKG1vZHVsZXMsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4geC5jb252ZW50aW9uKCdhdXRvU3RhcnQnKSAmJiBpOwogICAgICAgICAgICB9KS5qb2luKCcsICcpKSk7CiAgICAgICAgICAgIGVhY2gobW9kdWxlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIGlmKCFjaGVja0F1dG9TdGFydCB8fCAoY2hlY2tBdXRvU3RhcnQgJiYgeC5jb252ZW50aW9uKCdhdXRvU3RhcnQnKSkpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2godGhhdFttZXRob2RdKGkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHRoYXQuc3RhcnRpbmdNb2R1bGVzICYmIGNoZWNrQXV0b1N0YXJ0KSB7CiAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCB0aGF0LnN0YXJ0aW5nTW9kdWxlcy5qb2luKCcsICcpKSk7CiAgICAgICAgICAgICAgICB0aGF0W21ldGhvZF0odGhhdC5zdGFydGluZ01vZHVsZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChyZXN1bHRzKTsKICAgICAgICB9OwogICAgfSk7CiAgICBmdW5jdGlvbiBmaXJlVGhydXN0RXZlbnQodGhhdCwgZXZlbnQpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGF0Lm1lZGlhdG9yICYmIHRoYXQubWVkaWF0b3IuZmlyZShldmVudCk7CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBtZXRob2QsIHN0b3BwaW5nKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgZWFjaCh0aGF0LmNoaWxkcmVuLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgaWYoc3RvcHBpbmcpIHsKICAgICAgICAgICAgICAgIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSA9IGNoaWxkLnN0YXJ0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoY2hpbGQuY2ZnLmF1dG9TdGFydCB8fCAoIXN0b3BwaW5nICYmIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSkgfHwgKHN0b3BwaW5nICYmIGNoaWxkLnN0YXJ0ZWQpKSB7CiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKGNoaWxkW21ldGhvZF0oZmFsc2UsIHRydWUpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmKGl0ZW1zLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoaXRlbXMpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgYXJyKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuZmxhdHRlblRvUHJvbWlzZXMoYXJyLmNvbmNhdCh0aGF0LmNmZy5hc3luYyAmJiBbCiAgICAgICAgICAgIHdoZW4uZGVsYXkoMCkKICAgICAgICBdIHx8IFtdKSk7CiAgICB9CiAgICB2YXIgdGhydXN0TG9nRXZlbnQ7CiAgICBpZih0cnVlKSB7CiAgICAgICAgdGhydXN0TG9nRXZlbnQgPSBmdW5jdGlvbiAobWVzc2FnZSwgbmFtZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgbG9nLmRlYnVnKGZvcm1hdC5hcHBseShmb3JtYXQsIFsKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlCiAgICAgICAgICAgICAgICBdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhydXN0TG9nRXZlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB1dGlsLm5vb3A7CiAgICAgICAgfTsKICAgIH0KICAgIHZhciB0aHJ1c3RTaG91bGRFeGVjdXRlID0gZnVuY3Rpb24gKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCBzdG9wcGluZykgewogICAgICAgIGlmKHRoYXQucGFyZW50ICYmIHRoYXQuY2ZnLmNoaWxkSW5zdGFuY2UgJiYgIXRoYXQucGFyZW50LnN0YXJ0ZWQgJiYgIWNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIGxvZy53YXJuKGZvcm1hdCgnQ2Fubm90IGV4ZWN1dGUgb24gY2hpbGQgaW5zdGFuY2UgInswfSIgcGFyZW50IGluc3RhbmNlICJ7MX0iIG11c3QgYmUgc3RhcnRlZCBmaXJzdC4nLCB0aGF0Lm5hbWUsIHRoYXQucGFyZW50Lm5hbWUpKTsKICAgICAgICB9CiAgICAgICAgaWYoIXN0b3BwaW5nICYmIHRoYXQuc3RhcnRlZCB8fCBzdG9wcGluZyAmJiAhdGhhdC5zdGFydGVkKSB7CiAgICAgICAgICAgIGxvZy53YXJuKGZvcm1hdCgnQ2Fubm90IHN0YXJ0IHRocnVzdCBpbnN0YW5jZSAiezB9IiBzaW5jZSBpdCBhbHJlYWR5IHN0YXJ0ZWQnLCB0aGF0Lm5hbWUpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgLyoqCiAgICBHZXRzIHRoZSBtb2R1bGVzIGFyZ3VtZW50cyBmcm9tIHRoZSByZWdpc3RyYXRpb25zLgogICAgCiAgICBJZiBvcmlnaW5hbCBhcmdzIGNvbnRhaW5zIGFueXRoaW5nIGl0IGlzIHBhc3NlZCBpbnN0ZWFkIG9mIHRoZSByZWdpc3RyYXRpb25zLgogICAgSWYgdGhlIHJlZ2lzdHJhdGlvbnMgYXJlIGluIHBsYWNlIGl0IHdpbGwgcmV0dXJuIHRoZW0uCiAgICAKICAgIEBtZXRob2QgX19nZXRNb2R1bGVBcmdzCiAgICBAc3RhdGljCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlTmFtZSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbW9kdWxlIG5hbWUKICAgIEBwYXJhbSB7QXJyYXl9IG9yaWdpbmFsQXJncyBUaGUgb3JpZ2luYWwgYXJndW1lbnRzIHBhc3NlZCBpbnRvIHRoZSBjYWxsaW5nIG1ldGhvZC4KICAgICoqLwogICAgZnVuY3Rpb24gX19nZXRNb2R1bGVBcmdzKGluc3RhbmNlTmFtZSwgbmFtZSwgb3JpZ2luYWxBcmdzKSB7CiAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KG9yaWdpbmFsQXJncyk7CiAgICAgICAgaWYoYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICAgICAgfQogICAgICAgIHZhciBpbnN0YW5jZVJlZ2lzdHJhdGlvbnMgPSBUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zW2luc3RhbmNlTmFtZV07CiAgICAgICAgaWYoaW5zdGFuY2VSZWdpc3RyYXRpb25zICYmIGluc3RhbmNlUmVnaXN0cmF0aW9uc1tuYW1lXSkgewogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2VSZWdpc3RyYXRpb25zW25hbWVdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnczsKICAgIH0KICAgIC8vI2VuZHJlZ2lvbgogICAgLyoqCiAgICBUaGUgcHJpbWFyeSB0aHJ1c3QgY2xhc3MuCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuVGhydXN0CiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoaXMgdGhydXN0IGluc3RhbmNlCiAgICBAcmV0dXJucyB7VGhydXN0fQogICAgKiovCiAgICB2YXIgVGhydXN0ID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBUaHJ1c3QobmFtZSkgewogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX190aHJ1c3RDb252ZW50aW9ucyA9IFtdOwogICAgICAgICAgICB0aGlzLmNmZyA9IG1lcmdlKHRDb25maWcsIHsKICAgICAgICAgICAgICAgIGF1dG9TdGFydDogZmFsc2UsCiAgICAgICAgICAgICAgICBhc3luYzogZmFsc2UsCiAgICAgICAgICAgICAgICBjaGlsZEluc3RhbmNlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGF1dG9tYXRpY0xpZmVjeWNsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5jb25maWcgPSBtZXJnZSh0Q29uZmlnLCB7CiAgICAgICAgICAgICAgICBhdXRvU3RhcnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgY2hpbGRJbnN0YW5jZTogZmFsc2UsCiAgICAgICAgICAgICAgICBhdXRvbWF0aWNMaWZlY3ljbGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHRoaXMubW9kdWxlcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5mYWlsZWRNb2R1bGVzID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgICAgICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zID0gewogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5jcmVhdGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IHRocnVzdCBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjcmVhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdW5pcXVlIG1vZHVsZSBuYW1lLgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGUgVGhlIG1vZHVsZSBkZWZpbnRpb24uCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBwcmVCdWlsZCBIYXMgdGhpcyBtb2R1bGUgYmVlbiBwcmVidWlsdCwgaW4gb3RoZXIgd29yZHMgaGFzIGl0IGJlZW4gY3JlYXRlZCwgYnkgd2lyZS5qcyBhbmQgbmVlZHMgdG8gYmUgaW5qZWN0ZWQuCiAgICAgICAgQHJldHVybnMge01vZHVsZX0gVGhlIG5ldyBtb2R1bGUgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIG1vZCwgcHJlQnVpbHQpIHsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdUaHJ1c3Q6IENyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiAiezB9IicsIG5hbWUpKTsKICAgICAgICAgICAgdmFyIG9sZE1vZHVsZSwgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKHByZUJ1aWx0KSB7CiAgICAgICAgICAgICAgICBvbGRNb2R1bGUgPSBtb2Q7CiAgICAgICAgICAgICAgICBtb2QgPSBtb2QuaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXByZUJ1aWx0KSB7CiAgICAgICAgICAgICAgICBtb2QgPSBuZXcgbS5Nb2R1bGUodGhhdCwgbW9kLCBuYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1vZCA9IG9sZE1vZHVsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBNb2R1bGVzIGNhbm5vdCBoYXZlIGR1cGxpY2F0ZSBuYW1lcywgY2hvb3NlIGEgbmV3IG9uZS4KICAgICAgICAgICAgaWYodGhhdC5tb2R1bGVzW21vZC5uYW1lXSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnRHVwbGljYXRlIG1vZHVsZSBuYW1lICJ7MH0iLicsIG5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBtIGlzIHRoZSBtZWRpYXRvcnMgaW50ZXJuYWwgbW9kdWxlLgogICAgICAgICAgICB0aGF0Lm1vZHVsZXNbbW9kLm5hbWVdID0gbW9kOwogICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdCgnVGhydXN0OiBDcmVhdGVkIG1vZHVsZSAiezB9IicsIG5hbWUpKTsKICAgICAgICAgICAgLy8gTm90aWZ5IHRoZSBtZWRpYXRvciB0aGF0IGEgbW9kdWxlIGhhcyBiZWVuIGNyZWF0ZWQuCiAgICAgICAgICAgIHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L21vZHVsZS9jcmVhdGUnLCBuYW1lKTsKICAgICAgICAgICAgaWYodGhhdCAmJiB0aGF0LnN0YXJ0ZWQgJiYgbW9kLmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSB7CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0KG1vZC5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdGFydHVwID0gLy8jcmVnaW9uIEdsb2JhbCBSdW5uZXJzCiAgICAgICAgZnVuY3Rpb24gKGV2ZW50LCBldmVudFR5cGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KSwgCiAgICAgICAgICAgICAgICB0aGF0W2V2ZW50VHlwZV0oKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgZXZlbnQpCiAgICAgICAgICAgIF0pKTsKICAgICAgICAgICAgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKGZpcmVUaHJ1c3RFdmVudCh0aGF0LCAndGhydXN0LycgKyBldmVudFR5cGUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLl9jb3VudGRvd24gPSBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnVlICYmIHRocnVzdExvZ0V2ZW50KCdMYXVuY2ggaW5zdGFuY2UgInswfSIgaW4gNS4uLiA0Li4uIDMuLi4gMi4uLiAxLi4uJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnN0YXJ0dXAoQ09VTlRET1dOLCBJTklUKTsKICAgICAgICAgICAgdHJ1ZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBoYXMgYmVlbiBpbml0YWxpemVkLicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY291bnRkb3duID0gLyoqCiAgICAgICAgQmVnaW5zIHRoZSBjb3VudGRvd24gdG8gdGhydXN0cyBzdGFydC4KICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjb3VudGRvd24KICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgY291bnRkb3duIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGF0LmNmZy5hdXRvbWF0aWNMaWZlY3ljbGUgJiYgKCF0aGF0LmNmZy5jaGlsZEluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFRocnVzdC5sYXVuY2hTZXF1ZW5jZSh0aGF0LCBjYWxsZWRCeVBhcmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoYXQuX2NvdW50ZG93bihjYWxsZWRCeVBhcmVudCk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmlnbml0ZSA9IC8qKgogICAgICAgIEJlZ2lucyB0aGUgaW5naXRpb24gYXMgdGhydXN0IHN0YXJ0cyB1cC4KICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBpZ25pdGUKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5naXRpb24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRydWUgJiYgdGhydXN0TG9nRXZlbnQoJ0ZpcmluZyByb2NrZXRzIGZvciB0aHVyc3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnN0YXJ0dXAoSUdOSVRFLCBTVEFSVCk7CiAgICAgICAgICAgIHRydWUgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaGFzIGJlZW4gc3RhcnRlZC4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLm9yYml0ID0gLyoqCiAgICAgICAgVGhydXN0IHByZXBhcmVzIGZvciBvcmJpdC4KICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24uCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBvcmJpdAogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRocnVzdCBpcyBpbiBvcmJpdC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnVlICYmIHRocnVzdExvZ0V2ZW50KCdGaXJpbmcgc3RhZ2UgdHdvIHRocnVzdGVycyBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSkoKTsKICAgICAgICAgICAgdmFyIGRvbVJlYWR5RGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIGRvbVJlYWR5RGVmZXIucHJvbWlzZS50aGVuKGZpcmVUaHJ1c3RFdmVudCh0aGF0LCAndGhydXN0L2RvbS9yZWFkeScpKTsKICAgICAgICAgICAgZG9tUmVhZHkoZG9tUmVhZHlEZWZlci5yZXNvbHZlKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIGRvbVJlYWR5RGVmZXIucHJvbWlzZSwgCiAgICAgICAgICAgICAgICBzYWZlSW52b2tlKHRoYXQuX19jb252ZW50aW9ucywgT1JCSVQsIHRoYXQpLCAKICAgICAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBPUkJJVCkKICAgICAgICAgICAgXSkpOwogICAgICAgICAgICB0cnVlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIGFsbW9zdCByZWFkeS4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlcGxveSA9IC8qKgogICAgICAgIFRocnVzdCBkZXBsb3lzIGNvbXBvbmVudHMgaW4gb3JiaXQKICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZXBsb3kKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaGFzIGZ1bGx5IGRlcGxveWVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRydWUpIHsKICAgICAgICAgICAgICAgIHZhciB0aW1lU3RhcnQgPSB0aGF0LmNvbmZpZy5kZWJ1Zy50aW1lU3RhcnQsIHRpbWVFbmQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSwgc3RhcnRUaW1lID0gKHRpbWVFbmQgLSB0aW1lU3RhcnQpLCB0dG9EaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHRvJyk7CiAgICAgICAgICAgICAgICBpZih0dG9EaXYpIHsKICAgICAgICAgICAgICAgICAgICB0dG9EaXYuaW5uZXJIVE1MID0gc3RhcnRUaW1lICsgJ21zJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgdGhhdC5yZWFkeSgpLCAKICAgICAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBERVBMT1kpCiAgICAgICAgICAgIF0pKS50aGVuKGZpcmVUaHJ1c3RFdmVudCh0aGF0LCAndGhydXN0L3JlYWR5JykpOwogICAgICAgICAgICB0cnVlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIG5vdyByZWFkeS4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmluT3JiaXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhhdC5zdGFydGVkID0gdHJ1ZTsKICAgICAgICAgICAgY2hpbGRyZW5DYWxsTWV0aG9kKHRoYXQsIElOT1JCSVQpOwogICAgICAgICAgICBpZih0cnVlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KTsKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTdGFydGVkIGluICcgKyBzdGFydFRpbWUgKyAnbXMnKTsKICAgICAgICAgICAgICAgIHZhciB0dHJEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHRyJyk7CiAgICAgICAgICAgICAgICBpZih0dHJEaXYpIHsKICAgICAgICAgICAgICAgICAgICB0dHJEaXYuaW5uZXJIVE1MID0gc3RhcnRUaW1lICsgJ21zJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zaHV0ZG93biA9IGZ1bmN0aW9uIChldmVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBldmVudCwgdHJ1ZSksIAogICAgICAgICAgICAgICAgdGhhdFtldmVudFR5cGVdKCksIAogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC8nICsgZXZlbnRUeXBlKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fZGVvcmJpdCA9IGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCB0cnVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRydWUgJiYgdGhydXN0TG9nRXZlbnQoJ1JlZW50ZXJpbmcgZWFydGhzIGF0bW9zcGhlcmUgZm9yIHRocnVzdCBpbnN0YW5jZSAiezB9Ii4nLCB0aGF0Lm5hbWUpOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHRoaXMuc2h1dGRvd24oREVPUkJJVCwgU1RPUCk7CiAgICAgICAgICAgIHRydWUgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IHN0b3BwZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5kZW9yYml0ID0gLyoqCiAgICAgICAgQmVnaW5zIHRoZSBkZW9yYml0IGFzIHRocnVzdCBzaHV0ZG93bi4KICAgICAgICBTaHV0ZG93biBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgogICAgICAgIAogICAgICAgIEBtZXRob2QgZGVvcmJpdAogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQsIHRydWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhhdC5jZmcuYXV0b21hdGljTGlmZWN5Y2xlICYmICghdGhhdC5jZmcuY2hpbGRJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLnNlcXVlbmNlKFsKICAgICAgICAgICAgICAgICAgICBfLmJpbmQodGhhdC5fZGVvcmJpdCwgdGhhdCksIAogICAgICAgICAgICAgICAgICAgIF8uYmluZCh0aGF0LnNwbGFzaGRvd24sIHRoYXQpCiAgICAgICAgICAgICAgICBdLCBjYWxsZWRCeVBhcmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoYXQuX2Rlb3JiaXQoY2FsbGVkQnlQYXJlbnQpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zcGxhc2hkb3duID0gLyoqCiAgICAgICAgQmVnaW5zIHRoZSBzcGxhc2hkb3duIGFzIHRocnVzdCBzaHV0ZG93bi4KICAgICAgICBTaHV0ZG93biBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3BsYXNoZG93bgogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQsIHRydWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ1ZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGFuZGluZyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBhdGxhbnRpYyBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zaHV0ZG93bihTUExBU0hET1dOLCBERVNUUk9ZKTsKICAgICAgICAgICAgdHJ1ZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBub3cgYmVpbmcgZGVzdHJveWVkJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5tb2R1bGVNZXRob2QgPSBmdW5jdGlvbiAobWV0aG9kLCBuYW1lLCBhcmdzLCByZXZlcnNlLCBkZXBlbmRlbnRNZXRob2RzLCBzdGFydGVkTWV0aG9kcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHBpcGUgPSBbXTsKICAgICAgICAgICAgaWYoIW5hbWUpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBhbGxSdW5uZXJGYWN0b3J5KG1ldGhvZCkodGhhdCk7CiAgICAgICAgICAgICAgICBpZihyZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgICAgICBpZighaXNBcnJheShuYW1lKSkgewogICAgICAgICAgICAgICAgbmFtZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgbmFtZQogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gKG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGRlcGVuZGVudE1ldGhvZHMgJiYgZGVwZW5kZW50TWV0aG9kcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBpdGVtcyA9IHsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gbmFtZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSBuYW1lc1tpXSwgbW9kID0gdGhhdC5tb2R1bGVzW25dOwogICAgICAgICAgICAgICAgICAgIGVhY2goZGVwZW5kZW50TWV0aG9kcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWl0ZW1zW3hdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1t4XSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFyZXZlcnNlICYmICghbW9kIHx8ICFtb2QuY29udmVudGlvbih4ICsgJy1zdGF0dXMnKSkgfHwgKHJldmVyc2UgJiYgbW9kLmNvbnZlbnRpb24oeCArICctc3RhdHVzJykpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1t4XS5wdXNoKG4pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlYWNoKGRlcGVuZGVudE1ldGhvZHMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgaWYoaXRlbXNbeF0gJiYgaXRlbXNbeF0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlbih0aGF0W3hdLmFwcGx5KHRoYXQsIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1t4XQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlbihydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgIG5hbWVzCiAgICAgICAgICAgICAgICBdLmNvbmNhdChhcmdzKSkpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHRoYXQuc3RhcnRlZCAmJiBzdGFydGVkTWV0aG9kcyAmJiBzdGFydGVkTWV0aG9kcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGVhY2goc3RhcnRlZE1ldGhvZHMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcGlwZS5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4odGhhdFt4XS5hcHBseSh0aGF0LCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lcwogICAgICAgICAgICAgICAgICAgICAgICBdLmNvbmNhdChhcmdzKSkpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLnBpcGVsaW5lKHBpcGUpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoSU5JVCwgbmFtZSwgYXJncywgZmFsc2UpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQubW9kdWxlTWV0aG9kKFNUQVJULCBuYW1lLCBhcmdzLCBmYWxzZSwgWwogICAgICAgICAgICAgICAgSU5JVAogICAgICAgICAgICBdLCBbCiAgICAgICAgICAgICAgICBSRUFEWQogICAgICAgICAgICBdKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUucmVhZHkgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChSRUFEWSwgbmFtZSwgYXJncywgZmFsc2UsIFsKICAgICAgICAgICAgICAgIElOSVQsIAogICAgICAgICAgICAgICAgU1RBUlQKICAgICAgICAgICAgXSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChTVE9QLCBuYW1lLCBhcmdzLCB0cnVlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgbWV0aG9kID0gREVTVFJPWTsKICAgICAgICAgICAgcmV0dXJuIHRoYXQubW9kdWxlTWV0aG9kKERFU1RST1ksIG5hbWUsIGFyZ3MsIHRydWUsIFsKICAgICAgICAgICAgICAgIFNUT1AKICAgICAgICAgICAgXSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLl9faW5qZWN0TW9kdWxlID0gLy8jZW5kcmVnaW9uCiAgICAgICAgLyoqCiAgICAgICAgSW5qZWN0cyBhIHByZWNvbnN0cnVjdGVkIG1vZHVsZSBpbnRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBfX2luamVjdE1vZHVsZQogICAgICAgIEBwcml2YXRlCiAgICAgICAgQHBhcmFtIHtNb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGluamVjdC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kdWxlKSB7CiAgICAgICAgICAgIHRoaXMuY3JlYXRlKG1vZHVsZS5uYW1lLCBtb2R1bGUsIHRydWUpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5jcmVhdGVNb2R1bGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbW9kdWxlIGZyb20gdGhlIGdpdmVuIGRlZmluaXRpb24gb2JqZWN0LCB3aXRoIHRoZSBnaXZlbiBuYW1lLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY3JlYXRlTW9kdWxlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZHVsZURlZm4gVGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIG1vZHVsZURlZm4pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZih0aGF0Lm1vZHVsZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZXNbbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1vZHVsZSA9IG5ldyBNb2R1bGUodGhhdCwgbW9kdWxlRGVmbiwgbmFtZSk7CiAgICAgICAgICAgIHRoYXQuX19pbmplY3RNb2R1bGUobW9kdWxlKTsKICAgICAgICAgICAgcmV0dXJuIG1vZHVsZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3Bhd24gPSAvKioKICAgICAgICBMYXVuY2hlcyBhbm90aGVyIGNoaWxkIG1vZHVsZSBmb3IgdGhydXN0LgogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3Bhd24KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgdGhhdCByZXNvbHZlcyBvbmNlIHRoZSBjaGlsZCBpbnN0YW5jZSBoYXMgZnVsbHkgbG9hZGVkLiAgUmVzb2x2ZXMgd2l0aCB0aGUgY29udGV4dCB0aGF0IGNvbnRhaW5zIHRoZSB0aHJ1c3QgaW5zdGFuY2UgYW5kIGFsbCBwbHVnaW5zIHRoYXQgd2VyZSBsb2FkZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHNldHRpbmdzKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIFRocnVzdC5sYXVuY2goZXh0ZW5kKHsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgY2hpbGRJbnN0YW5jZTogdHJ1ZQogICAgICAgICAgICB9LCBzZXR0aW5ncyksIHRydWUpLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdDsKICAgICAgICAgICAgICAgIHRoYXQuY2hpbGRyZW4ucHVzaCh0aHJ1c3QpOwogICAgICAgICAgICAgICAgdGhydXN0LnBhcmVudCA9IHRoYXQ7CiAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnJlZ2lzdGVyTW9kdWxlID0gLyoqCiAgICAgICAgUmVnaXN0ZXJzIGEgc3BlY2lmaWMgbW9kdWxlIG5hbWUsIGFuZCBhcmd1bWVudHMuICBUaGUgYXJndW1lbnRzIHdpbGwgYmUgdXNlZCB3aGVuIGluaXRhbnRpYXRpbmcgdGhlIG1vZHVsZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHJlZ2lzdGVyTW9kdWxlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lIHRvIGFzc2lnbiB0aGUgYXJndW1lbnRzIHdpdGguCiAgICAgICAgQHBhcmFtIHtPYmplY3QqfSBhcmd1bWVudHMsIGFkZGl0aW9uYWwgYXJndW1lbnRzIHRoYXQgd2lsbCBiZSBwYXNzZWQgb250byB0aGUgbW91ZGxlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBUaHJ1c3QucmVnaXN0ZXJNb2R1bGUuYXBwbHkoVGhydXN0LCBbCiAgICAgICAgICAgICAgICB0aGF0Lm5hbWUKICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QubGF1bmNoU2VxdWVuY2UgPSBmdW5jdGlvbiBsYXVuY2hTZXF1ZW5jZShpbnN0YW5jZSwgY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHdoZW4uc2VxdWVuY2UoWwogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLl9jb3VudGRvd24sIGluc3RhbmNlKSwgCiAgICAgICAgICAgICAgICBfLmJpbmQoaW5zdGFuY2UuaWduaXRlLCBpbnN0YW5jZSksIAogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLm9yYml0LCBpbnN0YW5jZSksIAogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLmRlcGxveSwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5pbk9yYml0LCBpbnN0YW5jZSkKICAgICAgICAgICAgXSwgY2FsbGVkQnlQYXJlbnQpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmxhdW5jaCA9IC8qKgogICAgICAgIEluaXRhbGl6ZXMgYSBuZXcgVGhydXN0IGluc3RhbmNlIGJhc2VkIG9uIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGxhdW5jaAogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIG1vZHVsZSB0byBpbmplY3QKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBsYXVuY2goc2V0dGluZ3MsIGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2dsb2JhbCcKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXNldHRpbmdzLm5hbWUpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLm5hbWUgPSAnZ2xvYmFsJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0cnVlKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy5kZWJ1ZyA9IHsKICAgICAgICAgICAgICAgICAgICB0aW1lU3RhcnQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldHRpbmdzID0gaWduaXRlU3BlYy5tZXJnZVNldHRpbmdzKHNldHRpbmdzKTsKICAgICAgICAgICAgdmFyIHBpcGUgPSBbCiAgICAgICAgICAgICAgICBpZ25pdGVTcGVjLmZ1c2UKICAgICAgICAgICAgXTsKICAgICAgICAgICAgdmFyIHNldHVwRGVmZXIgPSBUaHJ1c3QuX19mZXRjaEluc3RhbmNlKHNldHRpbmdzLm5hbWUpOwogICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdCwgbW9kdWxlcyA9IHRocnVzdC5zdGFydGluZ01vZHVsZXMgPSBjb250ZXh0LmNmZy5tb2R1bGVzLCBjb25maWcgPSB0aHJ1c3QuY29uZmlnID0gdGhydXN0LmNmZzsKICAgICAgICAgICAgICAgIGluc3RhbmNlc1t0aHJ1c3QubmFtZV0gPSB0aHJ1c3Q7CiAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHNldHRpbmdzLmF1dG9tYXRpY0xpZmVjeWNsZSkgewogICAgICAgICAgICAgICAgcGlwZS5wdXNoKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRocnVzdCA9IGNvbnRleHQudGhydXN0LCBkID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICAgICAgICAgIFRocnVzdC5sYXVuY2hTZXF1ZW5jZSh0aHJ1c3QsIGNhbGxlZEJ5UGFyZW50KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQucmVzb2x2ZShjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5wcm9taXNlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBpcGVsaW5lID0gd2hlbi5waXBlbGluZShwaXBlLCBzZXR0aW5ncykudGhlbihmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNldHVwRGVmZXIucmVzb2x2ZShjb250ZXh0KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIFdlJ3JlIG9ubHkgZ29pbmcgdG8gZXhwb3NlIGdsb2JhbHMgaWYgcmVxdWVzdGVkLiAgVGhpcyBpcyBhIHBvdGVudGlhbCB1c2VjYXNlIHRoYXQgbWF5IGJlIG5lZWRlZCBmb3Igc29tZSB0ZWFtcy4KICAgICAgICAgICAgaWYodENvbmZpZy5leHBvc2VHbG9iYWxzKSB7CiAgICAgICAgICAgICAgICBpZighd2luZG93WydUaHJ1c3QnXSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvd1snVGhydXN0J10gPSBUaHJ1c3Q7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwaXBlbGluZS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93W3NldHRpbmdzLm5hbWVdID0gY29udGV4dDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwaXBlbGluZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5nZXRJbnN0YW5jZSA9IC8qKgogICAgICAgIEdldHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGdldEluc3RhbmNlCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICAgICAgQHJldHVybnMge1RocnVzdH0gVGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIGdldEluc3RhbmNlKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRocnVzdEluc3RhbmNlLmdldEluc3RhbmNlKG5hbWUpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0Ll9fZmV0Y2hJbnN0YW5jZSA9IC8qKgogICAgICAgIEZldGNocyBhIG5hbWVkIHRocnVzdCBzdGFuY2UgaWYgaXQgZXhpc3RzLgogICAgICAgIFRoaXMgbG9hZHMgYXN5bmNyb25vdXNseSwgYXMgdGhlIGluc3RhbmNlIG1heSBub3QgYmUgbG9hZGVkCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBfX2ZldGNoSW5zdGFuY2UKICAgICAgICBAc3RhdGljCiAgICAgICAgQHByaXZhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUbyBhIHRocnVzdCBpbnN0YW5jZSBzcGVjCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gX19mZXRjaEluc3RhbmNlKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRocnVzdEluc3RhbmNlLmZldGNoSW5zdGFuY2UobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QuY3JlYXRlTW9kdWxlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyBtb2R1bGUgYW5kIGhhbmRzIGl0IG9mZiB0byB0aGUgZ2l2ZW4gaW5zdGFuY2UsIGlmIHRoYXQgaW5zdGFuY2UgZXhpc3RzLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY3JlYXRlTW9kdWxlCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZSBuYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZHVsZURlZm4gVGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTW9kdWxlKGluc3RhbmNlTmFtZSwgbmFtZSwgbW9kdWxlRGVmbikgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBUaHJ1c3QuZ2V0SW5zdGFuY2UoaW5zdGFuY2VOYW1lKTsKICAgICAgICAgICAgaWYoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgIHZhciBtb2R1bGUgPSBuZXcgTW9kdWxlKGluc3RhbmNlLCBtb2R1bGVEZWZuLCBuYW1lKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLl9faW5qZWN0TW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucmVnaXN0ZXJNb2R1bGUgPSAvKioKICAgICAgICBSZWdpc3RlcnMgYSBzcGVjaWZpYyBtb2R1bGUgbmFtZSwgYW5kIGFyZ3VtZW50cy4gIFRoZSBhcmd1bWVudHMgd2lsbCBiZSB1c2VkIHdoZW4gaW5pdGFudGlhdGluZyB0aGUgbW9kdWxlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgcmVnaXN0ZXJNb2R1bGUKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlTmFtZSBUaGUgdGhydXN0IGluc3RhbmNlIHRoZSBtb2R1bGUgaXMgdG8gYmUgYXNzb2NpYXRlZCB3aXRoLgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZSB0byBhc3NpZ24gdGhlIGFyZ3VtZW50cyB3aXRoLgogICAgICAgIEBwYXJhbSB7T2JqZWN0Kn0gYXJndW1lbnRzLCBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0aGF0IHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIG1vdWRsZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyTW9kdWxlKGluc3RhbmNlTmFtZSwgbmFtZSkgewogICAgICAgICAgICBpZighaW5zdGFuY2VOYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc3RhbmNlTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighbmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCduYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zW2luc3RhbmNlTmFtZV0pIHsKICAgICAgICAgICAgICAgIFRocnVzdC5fX21vZHVsZVJlZ2lzdHJhdGlvbnNbaW5zdGFuY2VOYW1lXSA9IHsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cykuc2xpY2UoMik7CiAgICAgICAgICAgIGlmKFRocnVzdC5fX21vZHVsZVJlZ2lzdHJhdGlvbnNbaW5zdGFuY2VOYW1lXVtuYW1lXSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnTW9kdWxlICJ7MH0iIGFscmVhZHkgcmVnaXN0ZXJlZCB0byBpbnN0YW5jZSAiezF9IicsIG5hbWUsIGluc3RhbmNlTmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFRocnVzdC5fX21vZHVsZVJlZ2lzdHJhdGlvbnNbaW5zdGFuY2VOYW1lXVtuYW1lXSA9IGFyZ3MgfHwgW107CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QuX19nZXRNb2R1bGVBcmdzID0gX19nZXRNb2R1bGVBcmdzOwogICAgICAgIHJldHVybiBUaHJ1c3Q7CiAgICB9KSgpOwogICAgZXhwb3J0cy5UaHJ1c3QgPSBUaHJ1c3Q7ICAgIAogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBjdXJyZW50IHRodXJzdCBpbnN0YW5jZSwgYnkgZXhwZWN0ZWQgbmFtZS4KICAgIEFkZGluZyB0aGUgOiBjaGFyYWN0ZXIgcmVxdWVzdHMgYSBzcGVjaWZpYyBwbHVnaW4uCiAgICB0aHJ1c3QhZ2xvYmFsID0gVGhydXN0IGluc3RhbmNlCiAgICB0aHJ1c3QhZ2xvYmFsOmRvbSA9IFRoZSB0aHJ1c3QgZG9tIHBsdWdpbiBpbnN0YW5jZQogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBmdW5jdGlvbiBsb2FkKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwgcmVhbE5hbWUgPSBwYXJ0c1swXSwgcGx1Z2luTmFtZSA9IHBhcnRzWzFdIHx8ICd0aHJ1c3QnOwogICAgICAgIHZhciBpbnN0YW5jZVByb21pc2UgPSBUaHJ1c3QuX19mZXRjaEluc3RhbmNlKHJlYWxOYW1lKTsKICAgICAgICBpbnN0YW5jZVByb21pc2UucHJvbWlzZS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBjb250ZXh0W3BsdWdpbk5hbWVdOwogICAgICAgICAgICBpZighcGx1Z2luKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdQbHVnaW4gInswfSIgZG9lcyBub3QgZXhpc3Qgb24gdGhydXN0IGluc3RhbmNlICJ7MX0iLicsIHBsdWdpbk5hbWUsIHJlYWxOYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9hZChwbHVnaW4pOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdCcsIFsndGhydXN0L21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvY29udmVudGlvbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEEgQ29udmVudGlvbiBhbGxvd3MgdGhydXN0IHRvIGJlIGFzIGV4dGVuZGFibGUgYXMgcG9zc2libGUsIGJ5IGdpdmluZyBleHRlbnNpb24gcG9pbnRzIGF0IGV2ZXJ5IHN0ZXAgYWxvbmcgdGhlIHdheS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgdmFyIG1ldGhvZHMgPSBbCiAgICAgICAgJ2NyZWF0ZScsIAogICAgICAgICdpbml0JywgCiAgICAgICAgJ3N0YXJ0JywgCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAnZGVzdHJveScsIAogICAgICAgICdjb3VudGRvd24nLCAKICAgICAgICAnaWduaXRlJywgCiAgICAgICAgJ29yYml0JywgCiAgICAgICAgJ2Rlb3JiaXQnLCAKICAgICAgICAnc3BsYXNoZG93bicKICAgIF07CiAgICAvKioKICAgIFRoZSBjb252ZW50aW9uIGNsYXNzLCB0YWtlcyBhbiBvdmVybG9hZGVkIHNldCBvZiBtZXRob2RzLCBmb3IgYW55IG1ldGhvZCB0aGF0IG5lZWRzIHRvIGJlIG92ZXJsb2FkZWQuCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuQ29udmVudGlvbgogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge09iamVjdH0gbWV0aG9kcyBBbiBvYmplY3Qgb2YgYXBwbGljYWJsZSBtZXRob2RzLgogICAgKiovCiAgICB2YXIgQ29udmVudGlvbiA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQ29udmVudGlvbihtZXRob2RPdmVycmlkZXMpIHsKICAgICAgICAgICAgXy5leHRlbmQodGhpcywgbWV0aG9kT3ZlcnJpZGVzKTsKICAgICAgICAgICAgdmFyIGtleXMgPSBfLmRpZmZlcmVuY2UobWV0aG9kcywgXy5pbnRlcnNlY3Rpb24obWV0aG9kcywgXy5rZXlzKG1ldGhvZE92ZXJyaWRlcykpKTsKICAgICAgICAgICAgXy5lYWNoKGtleXMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICBpZihfLmlzRnVuY3Rpb24odGhpc1t4XSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBub29wIGlzIHVzZWQgaW4gc2FmZWludm9rZSwgYXMgYSBzYWZlIGlnbm9yZSBmdW5jdGlvbiwgbm8gb3RoZXIgbm9vcCB3aWxsIHdvcmsgY29ycmVjdGx5LgogICAgICAgICAgICAgICAgICAgIHRoaXNbeF0gPSB1dGlsLm5vb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0KICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5jcmVhdGUgPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgY3JlYXRlIG9mIGEgbW9kdWxlLCBnZW5lcmFsbHkgdXNlZCB0byBjcmVhdGUgYSBmYWNhZGUsIHRoYXQgaXMgdGhlbiBib3VuZCB0byB0aGUgbW9kdWxlLgogICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSBpbnN0YW5jZS4KICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBBbGwgdGhlIGZhY2FkZXMgYWxyZWFkeSBhdHRhY2hlZCB0byB0aGUgbW9kdWxlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuaW5pdCA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBpbml0IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIGluaXQgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIGluaXQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5zdGFydCA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBzdGFydCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBzdGFydCBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5yZWFkeSA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCByZWFkeSBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyByZWFkeSBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2QgcmVhZHkKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5zdG9wID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHN0b3AgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3Mgc3RvcCBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3RvcAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmRlc3Ryb3kgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3QgZGVzdHJveSBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBkZXN0cm95IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZXN0cm95CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuY291bnRkb3duID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgY291bnRkb3duCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmlnbml0ZSA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgc3RhcnQgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBpZ25pdGUKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUub3JiaXQgPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHJlYWR5IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2Qgb3JiaXQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuZGVvcmJpdCA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgc3RvcCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGRlb3JiaXQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuc3BsYXNoZG93biA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgZGVzdHJveSBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIHNwbGFzaGRvd24KICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgcmV0dXJuIENvbnZlbnRpb247CiAgICB9KSgpOwogICAgZXhwb3J0cy5Db252ZW50aW9uID0gQ29udmVudGlvbjsgICAgCn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbnZlbnRpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZXZlbnRzJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL2xvZycsICcuL2NvbmZpZycsICdoYXMnLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19sb2dfXywgX190Q29uZmlnX18sIF9faGFzX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIC8vICAgICBCYWNrYm9uZS5qcyAwLjkuMQogICAgLy8gICAgIChjKSAyMDEwLTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KICAgIC8vICAgICBCYWNrYm9uZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICAgIC8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246CiAgICAvLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCiAgICAvKioKICAgIFRocnVzdCBFdmVudHMgYXJlIGJhc2VkIG9mZiBvZiB0aGUgQmFja2JvbmUgZXZlbnQgbW9kZWwsIHdpdGggc3BlY2lhbCBhZGRpdGlvbnMuCiAgICAKICAgICogRXZlbnRzIGNhbiBiZSBmaXJlZCBhc3luY3Jvbm91c2x5LgogICAgKiBFdmVudHMgY2FuIGJlIG5hbWVzcGFjZWQuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciB0Q29uZmlnID0gX190Q29uZmlnX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBFdmVudE5vZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEV2ZW50Tm9kZSgpIHsKICAgICAgICAgICAgdGhpcy50YWlsID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubmFtZXNwYWNlID0gJyc7CiAgICAgICAgICAgIHRoaXMub25jZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gRXZlbnROb2RlOwogICAgfSkoKTsKICAgIGV4cG9ydHMuRXZlbnROb2RlID0gRXZlbnROb2RlOyAgICAKICAgIHZhciBjcmVhdGVBc3luY0V2ZW50ID0gZnVuY3Rpb24gKG9iamVjdCkgewogICAgICAgIHZhciBmID0gZnVuY3Rpb24gZihldmVudHMpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3RyaWdnZXIuYXBwbHkob2JqZWN0LCBbCiAgICAgICAgICAgICAgICBmYWxzZQogICAgICAgICAgICBdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICB9OwogICAgICAgIGYuYXN5bmMgPSBmdW5jdGlvbiAoZXZlbnRzKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF90cmlnZ2VyLmFwcGx5KG9iamVjdCwgWwogICAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICBdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICB9OwogICAgICAgIHJldHVybiBmOwogICAgfTsKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgYXN5bmNGaXJlLCBub29wID0gdXRpbC5ub29wLCB3aGVuID0gdXRpbC53aGVuLCBzaXplID0gXy5zaXplLCBlYWNoID0gXy5lYWNoLCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQsIGV4dGVuZCA9IF8uZXh0ZW5kLCBmb3JtYXQgPSB1dGlsLmZvcm1hdDsKICAgIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy8sIEFMTCA9ICdhbGwnLCBTVEFSQUxMID0gJyphbGwnOwogICAgLyoqCiAgICBOb3JtYWxpemVzIHRoZSBnaXZlbiBldmVudHMgdG8gdGhlIGV4cGVjdGVkIG5hbWVzcGFjZS4KICAgIAogICAgQG1ldGhvZCBub3JtYWxpemVFdmVudHMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFRoZSBldmVudHMgZGVsaW1pdGVkIGJ5IGEgc3BhY2UKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2UgVGhlIG5hbWVzcGFjZSwgaW5jbHVkaW5nIHByZWZpeGVkICcuJwogICAgKiovCiAgICBmdW5jdGlvbiBub3JtYWxpemVFdmVudHMoZXZlbnRzLCBuYW1lc3BhY2UpIHsKICAgICAgICB2YXIgZXZlbnRzQXJyYXkgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGV2ZW50c0FycmF5Lmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICBpZihldmVudHNBcnJheVtpXS5pbmRleE9mKCcuJykgPT09IC0xKSB7CiAgICAgICAgICAgICAgICBldmVudHNBcnJheVtpXSA9IGV2ZW50c0FycmF5W2ldICsgbmFtZXNwYWNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBldmVudHNBcnJheS5qb2luKCcgJyk7CiAgICB9CiAgICAvKioKICAgIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KICAgIAogICAgQG1ldGhvZCBfdHJpZ2dlcgogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7Qm9vbGVhbn0gYXN5bmMgRmlyZSBldmVudCBhc3luYyBvciBzeW5jCiAgICBAcGFyYW0ge09iamVjdH0gZXZlbnRzIFRoZSBldmVudHMgdG8gYmUgZmlyZWQuCiAgICBkZWxpbWl0ZWQgYnkgYSBzcGFjZS4KICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgQHJldHVybnMgSWYgYXN5bmMgdGhlbiByZXR1cm5zIGEgUHJvbWlzZSwgd2hlcmUgdGhlIGZpcnN0IGFyZ3VtZW50IGNvbnRhaW5zIGFsbCB0aGUgcmV0dXJuZWQgdmFsdWVzLCBhcyBhbiBhcnJheQogICAgSWYgc3luYyB0aGVuIHJldHVybnMgYW4gYXJyYXkgb2YgdGhlIHJldHVybiB2YWx1ZXMuCiAgICBJZiBtb3JlIHRoYW4gb25lIGV2ZW50LCByZXR1cm5zIGFuIG9iamVjdCBvZiBhcnJheXMgb3IgcHJvbWlzZXMsIHdpdGggdGhlIGtleSBmb3IgZWFjaCBldmVudC4KICAgICoqLwogICAgZnVuY3Rpb24gX3RyaWdnZXIoYXN5bmMsIGV2ZW50cykgewogICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGV2ZW50LCBub2RlLCBjYWxscywgdGFpbCwgYXJncywgYWxsLCByZXN0LCBuYW1lc3BhY2UsIG9uY2VOb2RlczsKICAgICAgICBpZighKGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzKSkgewogICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICB9CiAgICAgICAgYWxsID0gY2FsbHMuYWxsOwogICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgICAgIHdoaWxlKGV2ZW50ID0gZXZlbnRzQXJyYXkuc2hpZnQoKSkgewogICAgICAgICAgICBpZihub2RlID0gY2FsbHNbZXZlbnRdKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyTm9kZXModGhhdCwgZXZlbnQsIGFzeW5jLCBub2RlLCByZXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihub2RlID0gYWxsKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyTm9kZXModGhhdCwgQUxMLCBhc3luYywgbm9kZSwgWwogICAgICAgICAgICAgICAgICAgIGV2ZW50CiAgICAgICAgICAgICAgICBdLmNvbmNhdChyZXN0KSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIFRyaWdnZXJzIGFsbCBldmVudHMgb24gYSBub2RlLgogICAgQWxzbyB1bmJpbmRzIGFueSBub2RlIHRoYXQgaXMgc2V0IHRvIG9ubHkgYmUgY2FsbGVkIG9uY2UuCiAgICAKICAgIEBtZXRob2QgdHJpZ2dlck5vZGVzCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGV2ZW50IGNvbnRhaW5lciBjb250ZXh0LgogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudCB0byBiZSBib3VuZCBvciB1bmJvdW5kLgogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7T2JqZWN0fSBub2RlIFRoZSBub2RlIGxpbmtlZCBsaXN0LgogICAgQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgdHJpZ2dlcmVkIG5vZGVzCiAgICAKICAgICoqLwogICAgZnVuY3Rpb24gdHJpZ2dlck5vZGVzKHRoYXQsIGV2ZW50LCBhc3luYywgbm9kZUxpc3QsIGFyZ3MpIHsKICAgICAgICB2YXIgdGFpbCwgb25jZU5vZGVzID0gW107CiAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ3swfTogdHJpZ2dlcmluZyB7MX0gZXZlbnQgInsyfSInLCB0aGF0Ll9fcHViU3ViTmFtZSwgYXN5bmMgJiYgJ2FzeW5jJyB8fCAnJywgZXZlbnQpKTsKICAgICAgICBlYWNoKG5vZGVMaXN0LCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgICAgICB3aGlsZSgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJDYWxsYmFjayhhc3luYywgbm9kZS5jYWxsYmFjaywgbm9kZS5jb250ZXh0IHx8IHRoYXQsIGFyZ3MpOwogICAgICAgICAgICAgICAgbm9kZS5vbmNlICYmIG9uY2VOb2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYob25jZU5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICBlYWNoKG9uY2VOb2RlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHRoYXQudW5zdWJzY3JpYmUoZXZlbnQsIHguY2FsbGJhY2ssIHguY29udGV4dCwgeC5uYW1lc3BhY2UpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIEludm9rZXMgYSB0cmlnZ2VyIGNhbGxiYWNrCiAgICAKICAgIEBtZXRob2QgdHJpZ2dlckNhbGxiYWNrCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjYWxsaW5nIGNvbnRleHQKICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBjYWxsIHRoZSBjYWxsYmFjayB3aXRoLgogICAgQHJldHVybnMge09iamVjdH0gVGhlIHJldHVybmVkIHZhbHVlLgogICAgRm9yIGFzeW5jIGNhbGxzLCB0aGlzIGlzIGEgcHJvbWlzZQogICAgRm9yIHN5bmMgY2FsbHMgdGhpcyBpcyB0aGUgdmFsdWUgZnJvbSB0aGUgbWV0aG9kLgogICAgKiovCiAgICBmdW5jdGlvbiB0cmlnZ2VyQ2FsbGJhY2soYXN5bmMsIGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgaWYoYXN5bmMpIHsKICAgICAgICAgICAgZGVmZXIodHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpLCAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cnkgIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgaWYodENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIENyZWF0ZXMgYW4gYXN5bmMgZXZlbnQgaGFuZGxlcgogICAgCiAgICBAbWV0aG9kIGFzeW5jRXZlbnRGYWN0b3J5CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZAogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGNhbGxpbmcgY29udGV4dAogICAgQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGguCiAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjYWxsYmFjayBmb3IgdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgICoqLwogICAgZnVuY3Rpb24gdHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgUmVzdWJzY3JpYmVzIHRvIHRoZSBhcHByb3ByaWF0ZSBldmVudHMKICAgIAogICAgQG1ldGhvZCBfb2ZmUHJvY2Vzc05vZGUKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGV4dAogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudAogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBldmVudCBjYWxsYmFjayB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtPYmplY3R9IFtjb250ZXh0XSBUaGUgZXZlbnQgY29udGV4dCB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lc3BhY2VdIFRoZSBuYW1lc3BhY2UgdG8gdW5zdWJzY3JpYmUKICAgICoqLwogICAgZnVuY3Rpb24gX29mZlByb2Nlc3NOb2RlKHRoYXQsIGV2ZW50LCBub2RlLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIHZhciB0YWlsLCBjYiwgY3R4LCBuczsKICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICBjYiA9IG5vZGUuY2FsbGJhY2s7CiAgICAgICAgICAgIGN0eCA9IG5vZGUuY29udGV4dDsKICAgICAgICAgICAgbnMgPSBub2RlLm5hbWVzcGFjZTsKICAgICAgICAgICAgaWYoKGNhbGxiYWNrICYmIGNiICE9PSBjYWxsYmFjaykgfHwgKGNvbnRleHQgJiYgY3R4ICE9PSBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoZXZlbnQgKyAobnMgJiYgKCcuJyArIG5zKSB8fCAnJyksIGNiLCBjdHgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBHZXRzIHRoZSBuYW1lc3BhY2UgaW5mb3JtYXRpb24sIHRoZSByZWFsIGV2ZW50IHRvIHBhc3MgYmFjayBvbnRvIHRoZSBtZXRob2RzLgogICAgCiAgICBAbWV0aG9kIGdldE5hbWVzcGFjZURhdGEKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGNhcHR1cmUgbmFtZXNwYWNlIGRhdGEgZnJvbS4KICAgIEByZXR1cm5zIHtPYmplY3R9IENvbnRhaW5pbmcgZXZlbnQgYW5kIG5hbWVzcGFjZS4KICAgICoqLwogICAgZnVuY3Rpb24gZ2V0TmFtZXNwYWNlRGF0YShldmVudCkgewogICAgICAgIHZhciBuc0luZGV4ID0gKGV2ZW50IHx8ICcnKS5pbmRleE9mKCcuJyksIGhhc05zID0gbnNJbmRleCA+IC0xLCBuYW1lc3BhY2UgPSBoYXNOcyA/IGV2ZW50LnN1YnN0cmluZyhuc0luZGV4ICsgMSkgOiB1bmRlZmluZWQsIGV2ZW50ID0gaGFzTnMgPyBldmVudC5zdWJzdHJpbmcoMCwgbnNJbmRleCkgOiBldmVudDsKICAgICAgICBpZihuc0luZGV4ID09PSAwKSB7CiAgICAgICAgICAgIGV2ZW50ID0gU1RBUkFMTDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LAogICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgIFRocnVzdCBFdmVudHMgYXJlIGJhc2VkIG9mZiBvZiB0aGUgQmFja2JvbmUgZXZlbnQgbW9kZWwsIHdpdGggc3BlY2lhbCBhZGRpdGlvbnMuCiAgICAKICAgICogRXZlbnRzIGNhbiBiZSBmaXJlZCBhc3luY3Jvbm91c2x5LgogICAgKiBFdmVudHMgY2FuIGJlIG5hbWVzcGFjZWQuCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuRXZlbnRzCiAgICAqKi8KICAgIGV4cG9ydHMuRXZlbnRzID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZXZlbnRzID0gewogICAgICAgICAgICBzdWJzY3JpYmU6IC8qKgogICAgICAgICAgICBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgICAgICAgICAgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnRzIGFyZSBmaXJlZC4KICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICAgICAgQHBhcmFtIHtCb29sZWFufSBvbmNlIENhbGwgdGhpcyBldmVudCBvbmx5IG9uY2UuCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbHMsIGV2ZW50LCBub2RlLCB0YWlsLCBsaXN0LCBuZDsKICAgICAgICAgICAgICAgIHRoaXMuX19uYW1lc3BhY2UgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoaXMuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICAgICAgICAgIGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzIHx8ICh0aGlzLl9jYWxsYmFja3MgPSB7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBpbW11dGFibGUgY2FsbGJhY2sgbGlzdCwgYWxsb3dpbmcgdHJhdmVyc2FsIGR1cmluZwogICAgICAgICAgICAgICAgLy8gbW9kaWZpY2F0aW9uLiAgVGhlIHRhaWwgaXMgYW4gZW1wdHkgb2JqZWN0IHRoYXQgd2lsbCBhbHdheXMgYmUgdXNlZAogICAgICAgICAgICAgICAgLy8gYXMgdGhlIG5leHQgbm9kZS4KICAgICAgICAgICAgICAgIHdoaWxlKGV2ZW50ID0gZXZlbnRzQXJyYXkuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgICAgIG5kID0gZ2V0TmFtZXNwYWNlRGF0YShldmVudCk7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSBuZC5ldmVudDsKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gY2FsbHNbZXZlbnRdIHx8IChjYWxsc1tldmVudF0gPSB7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgbGlzdCA9IGxpc3RbbmQubmFtZXNwYWNlXTsKICAgICAgICAgICAgICAgICAgICBub2RlID0gbGlzdCA/IGxpc3QudGFpbCA6IG5ldyBFdmVudE5vZGUoKTsKICAgICAgICAgICAgICAgICAgICBub2RlLm5leHQgPSB0YWlsID0gbmV3IEV2ZW50Tm9kZSgpOwogICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fX2RlZmF1bHRDb250ZXh0IHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBub2RlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgaWYobmQubmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihvbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUub25jZSA9IG9uY2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhbGxzW2V2ZW50XVtuZC5uYW1lc3BhY2VdID0gewogICAgICAgICAgICAgICAgICAgICAgICB0YWlsOiB0YWlsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXh0OiBsaXN0ID8gbGlzdC5uZXh0IDogbm9kZQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25jZTogLyoqCiAgICAgICAgICAgIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgYGV2ZW50c2AsIHRvIGEgYGNhbGxiYWNrYAogICAgICAgICAgICBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KICAgICAgICAgICAgCiAgICAgICAgICAgIEVhY2ggZXZlbnQgd2lsbCBvbmx5IGJlIGNhbGxlZCBvbmNlLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBvbmNlCiAgICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY29udGV4dCB0byBiaW5kIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIHRvLgogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN1YnNjcmliZTogLyoqCiAgICAgICAgICAgIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MKICAgICAgICAgICAgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGNhbGxiYWNrcyBmb3IgdGhlCiAgICAgICAgICAgIGV2ZW50LiBJZiBgZXZlbnRgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgdW5zdWJzY3JpYmUKICAgICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBTcGF2ZSBzZXBlcmF0ZWQgZXZlbnRzCiAgICAgICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnQsIGNhbGxzLCBub2RlLCBuZCwgb3VyTnMsIG5hbWVzcGFjZSwgdGhhdCA9IHRoaXMsIGhhc05zOwogICAgICAgICAgICAgICAgb3VyTnMgPSB0aGF0Ll9fbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgb3VyTnMgJiYgKG91ck5zID0gb3VyTnMuc3Vic3RyaW5nKDEpKTsKICAgICAgICAgICAgICAgIC8vIE5vIGV2ZW50cywgb3IgcmVtb3ZpbmcgKmFsbCogZXZlbnRzLgogICAgICAgICAgICAgICAgaWYoIShjYWxscyA9IHRoYXQuX2NhbGxiYWNrcykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZighKGV2ZW50cyB8fCBjYWxsYmFjayB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFvdXJOcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhhdC5fY2FsbGJhY2tzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYnMgPSB0aGF0Ll9jYWxsYmFja3M7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSBpbiBjYnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYnNbaV1bb3VyTnNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2l6ZShjYnNbaV0pID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNic1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgbGlzdGVkIGV2ZW50cyBhbmQgY29udGV4dHMsIHNwbGljaW5nIHRoZW0gb3V0IG9mIHRoZQogICAgICAgICAgICAgICAgLy8gbGlua2VkIGxpc3Qgb2YgY2FsbGJhY2tzIGlmIGFwcHJvcHJpYXRlLgogICAgICAgICAgICAgICAgb3VyTnMgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoYXQuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cyA/IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKSA6IF8ua2V5cyhjYWxscyk7CiAgICAgICAgICAgICAgICB3aGlsZShldmVudCA9IGV2ZW50c0FycmF5LnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgICAgICBuZCA9IGdldE5hbWVzcGFjZURhdGEoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gbmQuZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIGhhc05zID0gISFuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgaWYoIW91ck5zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGNhbGxzW2V2ZW50XSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdW291ck5zXTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNpemUoY2FsbHNbZXZlbnRdKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZighbm9kZSB8fCAhKGNhbGxiYWNrIHx8IGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvKmlmIChldmVudCAhPT0gU1RBUkFMTCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSovCiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnQgIT09IFNUQVJBTEwgJiYgIWNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBldmVudCwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudCA9PT0gQUxMIHx8ICFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgaW4gY2FsbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGhhc05zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBpLCBub2RlLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX19wdWJTdWJOYW1lOiAvKioKICAgICAgICAgICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAgICAgICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgICAgICAgICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBmaXJlCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgICAgICAgICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICAgICAgICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgICAgICAgICBAcmV0dXJucyB7QXJyYXkgb2YgVmFsdWVzfSBJZiBtb3JlIHRoYW4gb24gZXZlbnQgaXMgZmlyZWQsIGFuIE9iamVjdCBvZiBBcnJheXMgaXMgcmV0dXJuZWQuCiAgICAgICAgICAgICoqLwogICAgICAgICAgICAnRXZlbnRzJywKICAgICAgICAgICAgaW5pdEV2ZW50czogLyoqCiAgICAgICAgICAgIEluaXQncyB0aGUgRXZlbnQgbW9kdWxlLgogICAgICAgICAgICBUaGlzIGlzIG9ubHkgcmVxdWlyZWQgaWYgeW91IHdpc2ggdG8gdXNlIGZpcmUuYXN5bmMsIGFuZCBuYW1lc3BhY2luZy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgaW5pdEV2ZW50cwogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZGVmYXVsdENvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZSA9IHRoaXMucHVibGlzaCA9IGNyZWF0ZUFzeW5jRXZlbnQodGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLmluaXRFdmVudHMgPSBub29wOwogICAgICAgICAgICAgICAgdGhpcy5fX3B1YlN1Yk5hbWUgPSB0aGlzLm5hbWUgfHwgJ0V2ZW50cyc7CiAgICAgICAgICAgICAgICBpZih0aGlzLm5hbWUgJiYgIXRoaXMuX19uYW1lc3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlID0gJy4nICsgdGhpcy5uYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fX2RlZmF1bHRDb250ZXh0ID0gZGVmYXVsdENvbnRleHQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZXh0ZW5kOiAvKioKICAgICAgICAgICAgRXh0ZW5kcyBFdmVudHMgaW50byB0aGUgZ2l2ZW4gb2JqZWN0LgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBleHRlbmQKICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IHRvIFRoZSBvYmplY3Qgb3QgZXh0ZW5kIGV2ZW50cyBvbnRvCiAgICAgICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gW2luaXRdIE9wdGlvbmFsbHkgaW5pdCB0aGUgZXZlbnRzLgogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgICAgICBfLmV4dGVuZCh0bywgZXhwb3J0cy5FdmVudHMpOwogICAgICAgICAgICAgICAgZGVsZXRlIHRvLmV4dGVuZDsKICAgICAgICAgICAgICAgIGluaXQgJiYgdG8uaW5pdEV2ZW50cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRvOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudHMuZmlyZSA9IGV2ZW50cy5wdWJsaXNoID0gY3JlYXRlQXN5bmNFdmVudCh7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgIH0pKCk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50cy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9mYWNhZGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJy4vY2Fwc3VsZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX190bV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgdG0gPSBfX3RtX187CgogICAgdmFyIE1vZHVsZSA9IHRtLk1vZHVsZTsKICAgIC8qKgogICAgCiAgICBUaGUgRmFjYWRlIG1vZHVsZSBvZmZlcnMgdGhlIGFiaWxpdHkgdG8gY3JlYXRlIGFuIGludGVyZmFjZSBvciBzaW1pbGFyIGNvbmNlcHQuCiAgICBXaXRoIHRoZSBGYWNhZGUgaW4gdGhydXN0LCBpdCBhbGxvd3MgeW91IHRvIGNhcHR1cmUgZXZlbnRzIGZyb20gYSBtb2R1bGUsIHdoZW4gbG9hZGVkIHZpYSBjb252ZW50aW9uLgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEZhY2FkZSBoYXMgdGhlc2UgYnVpbHQgaW4gbWV0aG9kczoKICAgICogaW5pdAogICAgKiBzdGFydAogICAgKiByZWFkeQogICAgKiBzdG9wCiAgICAqIGRlc3Ryb3kKICAgIAogICAgQmVoaW5kIHRoZSBzY2VuZXMgdGhlIGZhY2FkZSBtZXRob2RzLCBpbnZva2UgYW55IGNvbnZlbnRpb25zIGxvYWRlZCBmb3IgdGhlIHBsdWdpbi4KICAgIAogICAgQGNsYXNzIHRocnVzdC5GYWNhZGUKICAgICoqLwogICAgdmFyIHRocnVzdENhY2hlID0gTW9kdWxlLnRocnVzdENhY2hlOwogICAgdmFyIGZhY2FkZU1ldGhvZHMgPSBbCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdkZXN0cm95JwogICAgXSwgZGVmYXVsdFByb3RvdHlwZSA9IHsKICAgIH07CiAgICBmdW5jdGlvbiBjb252ZW50aW9uRnVuY3Rpb25GYWN0b3J5KG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWVzID0gW107CiAgICAgICAgICAgIGlmKG0gJiYgISgobSkuY29udmVudGlvbikpIHsKICAgICAgICAgICAgICAgIG0gPSB0aHJ1c3RDYWNoZVttLm1pZF0ubW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuX19jb252ZW50aW9ucykgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIG5hbWUsIG0sIHRoYXQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIG1ldGhvZFdyYXAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgZi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9OwogICAgfQogICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgZGVmYXVsdFByb3RvdHlwZVttZXRob2RdID0gY29udmVudGlvbkZ1bmN0aW9uRmFjdG9yeShtZXRob2QpOwogICAgfQogICAgLyoqCiAgICBGYWNhZGUgaW5pdAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgaW5pdAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RhcnQKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgc3RhcnQgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCBzdGFydAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgcmVhZHkKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCByZWFkeQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RvcAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2Qgc3RvcAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgZGVzdHJveQogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgZGVzdHJveQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBtb2R1bGUgaW5zdGFuY2UKICAgIAogICAgRm9ybWF0OgogICAgdGhydXN0L2NhcHN1bGUhe2luc3RhbmNlfTp7cGx1Z2luTmFtZX06e2hhc2hLZXl9CiAgICAKICAgIGhhc0tleTogaXMgYSB1bmlxdWUga2V5LCB0aGF0IHRoZSBtb2R1bGUgc2hhcmVzIHdpdGggdGhlIGZhY2FkZSwgYWxsb3dzIGZvciBkZWZpbmluZyBkZXBlbmRlbmNpZXMKICAgIGluIHlvdXIgZGVmaW5lIGJsb2NrLCBhbmQgZ2V0IGFjY2VzcyB0byB0aGUgbW9kdWxlcyBmYWNhZGUuCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQG9ic29sZXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIGluc3RhbmNlTmFtZSA9IHBhcnRzWzBdLCBwbHVnaW4gPSBwYXJ0c1sxXSwgcGx1Z2luTmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxIHx8IDApLCBoYXNoS2V5ID0gcGFydHNbMl07CiAgICAgICAgaWYoIWluc3RhbmNlTmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc3RhbmNlTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICB9CiAgICAgICAgaWYoIXBsdWdpbk5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwbHVnaW5OYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgIH0KICAgICAgICBpZighaGFzaEtleSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2hhc2hLZXkgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgfQogICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAndGhydXN0IScgKyBpbnN0YW5jZU5hbWUKICAgICAgICBdLCBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciB0aHJ1c3RQbHVnaW4gPSB0aHJ1c3RbcGx1Z2luTmFtZV07CiAgICAgICAgICAgIGlmKCF0aHJ1c3RQbHVnaW4pIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgIHBsdWdpbgogICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgICAgICAgICBsb2FkKHApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRocnVzdE1vZHVsZUNhY2hlSXRlbSA9IHRocnVzdENhY2hlW2hhc2hLZXldIHx8ICh0aHJ1c3RDYWNoZVtoYXNoS2V5XSA9IHsKICAgICAgICAgICAgICAgIGZhY2FkZXM6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnN0YW5jZTogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIGZhY2FkZSA9IHRocnVzdFBsdWdpbi5jcmVhdGVGYWNhZGUodGhydXN0LCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzKTsKICAgICAgICAgICAgbG9hZChmYWNhZGUpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY2FkZShpbml0TWV0aG9kKSB7CiAgICAgICAgdmFyIGYgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgRmFjYWRlID0gZnVuY3Rpb24gKG1vZCkgewogICAgICAgICAgICAgICAgaW5pdE1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYodGhpc1ttZXRob2RdICE9PSBkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1ttZXRob2RdID0gXy53cmFwKHRoaXNbbWV0aG9kXSwgbWV0aG9kV3JhcChkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm1vZCA9IG1vZDsKICAgICAgICAgICAgICAgIC8vdGhpcy5pbml0KG1vZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBGYWNhZGUucHJvdG90eXBlID0gXy5leHRlbmQoewogICAgICAgICAgICAgICAgdXBkYXRlRmFjYWRlOiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgICAgICAgICBpbml0TWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGRlZmF1bHRQcm90b3R5cGUpOwogICAgICAgICAgICByZXR1cm4gRmFjYWRlOwogICAgICAgIH0pKCk7CiAgICAgICAgcmV0dXJuIGY7CiAgICB9CiAgICBleHBvcnRzLmNyZWF0ZUZhY2FkZSA9IGNyZWF0ZUZhY2FkZTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZmFjYWRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2NvbnZlbnRpb24vYXV0b3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbiddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9tZWRpYXRvcl9fIENvbnZlbnRpb24gLSBBdXRvIFN0YXJ0CiAgICAqCiAgICAqIFRoZSBhdXRvIHN0YXJ0IHByb3BlcnR5IGFsbG93cyBmb3IgYSBtb2R1bGUsIHRvIGJlIGF1dG9tYXRpY2FsbHkgc3RhcnRlZCBvbmNlIGl0IGlzCiAgICAqIGluY2x1ZGVkIGludG8gYSB0aHJ1c3QgaW5zdG5hY2UsIHdpdGhvdXQgaGF2aW5nIHRvIGV4cGxpY2l0eSBjYWxsIHN0YXJ0IG9uIHRoZSBtb2R1bGUuCiAgICAqCiAgICAqCiAgICAqIFRoaXMgaXMgdXNlZnVsIGZvciBjZXJ0aWFuIHR5cGVzIG9mIG1vZHVsZXMsIHVzdWFsbHkgcGVyc2lzdGFudCBvbmVzIHRoYXQgYWx3YXlzIG5lZWQgdG8gbG9hZCByZWdhcmRsZXNzLgogICAgKiBGb3IgZXhhbXBsZSBhIG5hdmlnYXRpb24gbW9kdWxlLCBvciB1c2VyIHNldHRpbmdzIG1vZHVsZS4KICAgICoKICAgICogQGZvciB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgYXV0b1N0YXJ0CiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgJ2NvbmZpZy5hdXRvU3RhcnQnCiAgICAgICAgXQogICAgfTsKICAgIGV4cG9ydHMuYXV0b3N0YXJ0ID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWF1dG9zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lcicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIGFueUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9hbnknLAogICAgICAgIGNoYW5nZUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9jaGFuZ2UnCiAgICB9LCBhbnkgPSBfLmFueSwgYmluZCA9IF8uYmluZCwgQ09OVEFJTkVSID0gJ2NvbmZpZy5jb250YWluZXInLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXI7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIENPTlRBSU5FUgogICAgICAgIF0sCiAgICAgICAgY2hhbmdlOiBmdW5jdGlvbiAobW9kLCBjb250YWluZXIpIHsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUgJiYgY29udGFpbmVyICYmIGNvbnRhaW5lclZhbHVlID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZC5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIGRlZmVyKGJpbmQobW9kLnN0b3AsIG1vZCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IuZmlyZShldmVudC5jaGFuZ2VDb250YWluZXIsIGNvbnRhaW5lclZhbHVlKTsKICAgICAgICAgICAgICAgIC8vIFN1YnNjcmlwdGlvbnMgZ2V0IHVuc3Vic2NyaWJlZCB3aGVuIHN0b3BwaW5nIGEgbW9kdWxlLCBzbyB3ZSBuZWVkIHRvIHJlc3Vic2NyaWJlIGV2ZXJ5IHRpbWUgaGVyZS4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgcHJvYmFibHkgYmV0dGVyLCBhcyB0aGUgZXZlbnRzIHdpbGwgYmUgbGVzcyBjaGF0dHkuCiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLnN1YnNjcmliZShldmVudC5jaGFuZ2VDb250YWluZXIsIGJpbmQodGhhdC5jaGFuZ2UsIHRoYXQsIG1vZCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGFpbmVyID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2RlcGVuZGVudC5tb2R1bGVzJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0Lm1lZGlhdG9yCiAgICBAc3VibW9kdWxlIHRocnVzdC5tZWRpYXRvci5jb252ZW50aW9uCiAgICAqKi8KICAgICAgICB2YXIgYW55ID0gXy5hbnksIG1hcCA9IF8ubWFwLCBETU9EVUxFUyA9ICdjb25maWcuZGVwZW5kZW50TW9kdWxlcycsIENNT0RVTEVTID0gJ2NvbmZpZy5jaGlsZE1vZHVsZXMnLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQ7CiAgICB2YXIgaW52b2tlZGVwZW5kZW50TW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihETU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIGludm9rZUNoaWxkTW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihDTU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBETU9EVUxFUywgCiAgICAgICAgICAgIENNT0RVTEVTCiAgICAgICAgXSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgaW52b2tlZGVwZW5kZW50TW9kdWxlcyhtb2QsICdzdGFydCcpLCAKICAgICAgICAgICAgICAgIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdGFydCcpCiAgICAgICAgICAgIF07CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZighbW9kLnRocnVzdC5zdGFydGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgIGludm9rZWRlcGVuZGVudE1vZHVsZXMobW9kLCAncmVhZHknKSwgCiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2hpbGRNb2R1bGVzKG1vZCwgJ3JlYWR5JykKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdG9wJyk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHJldHVybiBpbnZva2VDaGlsZE1vZHVsZXMobW9kLCAnZGVzdHJveScpOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmRlcGVuZGVudE1vZHVsZXMgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZGVwZW5kZW50Lm1vZHVsZXMuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnY2ZnJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L21lZGlhdG9yLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nCiAgICBdOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9jb252ZW50aW9uL3N1YnNjcmlwdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgVGhlIGZhY2FkZSBjb252ZW50aW9uLCBjcmVhdGVzIHRoZSBtZWRpYXRvciBmYWNhZGUgZm9yIGVhY2ggbW9kdWxlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIFNVQlNDUklQVElPTlMgPSAnY29uZmlnLm1lZGlhdG9yLnN1YnNjcmlwdGlvbnMnLCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBpc1N0cmluZyA9IF8uaXNTdHJpbmcsIGlzQXJyYXkgPSBfLmlzQXJyYXksIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgaXNQbGFpbk9iamVjdCA9IF8uaXNQbGFpbk9iamVjdCwgZm9yT3duID0gXy5mb3JPd24sIGVhY2ggPSBfLmVhY2g7CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnaGFuZGxlcicsIAogICAgICAgICdjb250ZXh0JwogICAgXTsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgU1VCU0NSSVBUSU9OUwogICAgICAgIF0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpOwogICAgICAgICAgICBpZihzdWJzY3JpcHRpb25zICYmICEoc3Vic2NyaXB0aW9ucykuX3N1YnNjcmlwdGlvbnNTZXQpIHsKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgICAgIGZvck93bihzdWJzY3JpcHRpb25zLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgc3Vic2NyaXB0aW9uTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFpc0FycmF5KHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihzdWJzY3JpcHRpb25Db2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVhY2goc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKHN1YnNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KHN1YnNjcmlwdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3U3Vic2NyaXB0aW9uLnB1c2guYXBwbHkobmV3U3Vic2NyaXB0aW9uLCBzdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWFjaChzdWJzY3JpcHRpb24sIGZ1bmN0aW9uIChoYW5kbGVyT2JqZWN0LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1N1YnNjcmlwdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uTmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3RdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc3Vic2NyaXB0aW9uW2kgKyAxXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goc3Vic2NyaXB0aW9uW2kgKyAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9yZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzRnVuY3Rpb24oaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goaGFuZGxlck9iamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbltpICsgMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKHN1YnNjcmlwdGlvbltpICsgMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc1BsYWluT2JqZWN0KGhhbmRsZXJPYmplY3QpICYmICgnbW9kdWxlSGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCB8fCAnaGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9uZXdTdWJzY3JpcHRpb24gPSBbc3Vic2NyaXB0aW9uTmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdtb2R1bGVIYW5kbGVyJyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChtb2QuaW5zdGFuY2VbaGFuZGxlck9iamVjdC5tb2R1bGVIYW5kbGVyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoJ2hhbmRsZXInIGluIGhhbmRsZXJPYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3QuaGFuZGxlcl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdjb250ZXh0JyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5ld1N1YnNjcmlwdGlvbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY2FkZS5zdWJzY3JpYmUuYXBwbHkoZmFjYWRlLCBuZXdTdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpLl9zdWJzY3JpcHRpb25zU2V0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb25zID0gbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUyk7CiAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbnMgJiYgc3Vic2NyaXB0aW9ucy5fc3Vic2NyaXB0aW9uc1NldCkgewogICAgICAgICAgICAgICAgbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUykuX3N1YnNjcmlwdGlvbnNTZXQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnN1YnNjcmlwdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJzY3JpcHRpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LmRhdGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LmRhdGEuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicsIAogICAgICAgICdjZmcnCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JwogICAgXTsKICAgIC8qKgogICAgRGVjaWRlcyBpZiBgdGhydXN0L2RhdGFgIHNob3VsZCBjYWNoZSByZXF1ZXN0cyBvciBub3QuCiAgICAKICAgIFlvdSBzaG91bGQgdHVybiB0aGlzIHRvIGBmYWxzZWAsIGlmIHlvdSBhcmUgZXhwZXJpZW5jaW5nIGNhY2hpbmcgaXNzdWVzIGFuZCBuZWVkIHRvIGRlYnVnLgogICAgCiAgICBAcHJvcGVydHkgY2FjaGUKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuY2FjaGUgPSB0cnVlOwogICAgLyoqCiAgICAqCiAgICAqIGBzdGFydFRpbWVvdXRgIGlzIHBhcnQgb2YgcXVldWVpbmcgYnVpbHQgaW50byBgdGhydXN0L2RhdGFgLiAgSXQgZGVmaW5lcyB0aGUgd2FpdCB0aW1lIGJlZm9yZSByZXF1ZXN0cwogICAgKiBhcmUgc3RhcnRlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIGZpcnN0IHJlcXVlc3QsIHRoZSB0aW1lcgogICAgKiBzdGFydHMsIG9uY2UgdGhlIHRpbWVvdXQgZWxhcHNlcywgYWxsIHRoZSByZXF1ZXN0cyBhcmUgc2hpcHBlZCBvZmYgYXQgb25jZS4KICAgICoKICAgICoKICAgICogVGhpcyBjb3VudGVyIGludHVpdGl2ZSBpZiB5b3UncmUgbG9va2luZyB0byBnZXQgdGhlIHJlcXVlc3QgYmFjayBpbW1lZGlhdGVseSwgYnV0IGZyb20gYSBVWCBwZXJzcGVjdGl2ZQogICAgKiB0aGlzIGFsbG93cyB0aGUgVUkgdG8gc3RheSBpbiBzeW5jIGFuZCBnaXZlIHRoZSB1c2VyIGEgY29oZXNpdmUsIGluc3RlYWQgb2Ygc2VlaW5nIGxvYWRlcnMsIHNob3cgdXAgYW5kCiAgICAqIGRpc2FwcGVhciBhdCBzZWVtaW5nbHkgcmFuZG9tIGludGVydmFscywgdGhlIHVzZXIgZG9lcyBhbiBhY3Rpb24sIGFuZCB0aGVuIHNlZXMgYSByZXNwb25zZS4KICAgICoKICAgICoKICAgICogQHByb3BlcnR5IHN0YXJ0VGltZW91dAogICAgKiBAcmVhZE9ubHkKICAgICogQHR5cGUge051bWJlcn0KICAgICogQGRlZmF1bHQgNTAwCiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnRUaW1lb3V0ID0gMTAwOwogICAgLyoqCiAgICAqCiAgICAqIGBmaW5pc2hUaW1lb3V0YCBpcyBwYXJ0IG9mIHF1ZXVlaW5nIGJ1aWx0IGludG8gYHRocnVzdC9kYXRhYC4gIEl0IGRlZmluZXMgdGhlIHdhaXQgdGltZSBiZWZvcmUgdGhlCiAgICAqIHF1ZXVlIGlzIGNvbXBsZXRlZC4gIElmIGFsbCB0aGUgcmVxdWVzdHMgZmluaXNoIGVhcmx5LCB0aGUgdGltZW91dCBpcyBjYW5jZWxlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIHJlcXVlc3RzIGFyZSBmaXJlZCBvZmYKICAgICogYHRocnVzdC9kYXRhYCB3aWxsIHdhaXQgdW50aWwgaXQgZ2V0cyBhIHJlc3BvbnNlIGZyb20gZXZlcnlvbmUgb2YgdGhlbS4gIElmIGZvciBzb21lIHJlYXNvbiBhIHJlcXVlc3QKICAgICogdGFrZXMgdG8gbG9uZywgYW5kIHRoZSB0aW1lb3V0IGlzIGhpdCwgYWxsIHRoZSByZXF1ZXN0cyB0aGF0IGhhdmUgY29tcGxldGVkLCB3aWxsIGJlIHJlbGVhc2VlZCwgYWxsb3dpbmcKICAgICogdGhlIGFwcGxpY2F0aW9uIHRvIGNvbnRpbnVlIHVuZGlzcnVwdGVkLgogICAgKgogICAgKgogICAgKiBUaGlzIGNvdW50ZXIgaW50dWl0aXZlIGlmIHlvdSdyZSBsb29raW5nIHRvIGdldCB0aGUgcmVxdWVzdCBiYWNrIGltbWVkaWF0ZWx5LCBidXQgZnJvbSBhIFVYIHBlcnNwZWN0aXZlCiAgICAqIHRoaXMgYWxsb3dzIHRoZSBVSSB0byBzdGF5IGluIHN5bmMgYW5kIGdpdmUgdGhlIHVzZXIgYSBjb2hlc2l2ZSwgaW5zdGVhZCBvZiBzZWVpbmcgbG9hZGVycywgc2hvdyB1cCBhbmQKICAgICogZGlzYXBwZWFyIGF0IHNlZW1pbmdseSByYW5kb20gaW50ZXJ2YWxzLCB0aGUgdXNlciBkb2VzIGFuIGFjdGlvbiwgYW5kIHRoZW4gc2VlcyBhIHJlc3BvbnNlLgogICAgKgogICAgKgogICAgQHByb3BlcnR5IGZpbmlzaFRpbWVvdXQKICAgIEByZWFkT25seQogICAgQHR5cGUge051bWJlcn0KICAgIEBkZWZhdWx0IDIwMDAKICAgICoqLwogICAgZXhwb3J0cy5maW5pc2hUaW1lb3V0ID0gMjAwMDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvZXZlbnQudHlwZXMnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8qKgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5kYXRhCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICAqKi8KICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS93YWl0YCBldmVudCBpcyBmaXJlZCBvbmNlIGEgZGF0YSBjYWxsIGlzIG1hZGUuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS93YWl0CiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICAqKi8KICAgIGV4cG9ydHMud2FpdCA9ICd0aHJ1c3QvZGF0YS93YWl0JzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdGFydGAgZXZlbnQgaXMgZmlyZWQgdGhlIHF1ZXVlIGlzIHN0YXJ0ZWQuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGFydAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXJ5SWQgVGhlIGludGVybmFsIGlkIG9mIHRoZSBvdXRib3VuZCBxdWV1ZS4KICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBvdXRib3VuZCBldmVudCBxdWV1ZSAoR2V0L1Bvc3QvZXRjKQogICAgQHBhcmFtIHtOdW1iZXJ9IGNvdW50IFRoZSBvdXRnb2luZyBjYWxsIGNvdW50CiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnQgPSAndGhydXN0L2RhdGEvc3RhcnQnOwogICAgLyoqCiAgICBUaGUgYHRocnVzdC9kYXRhL3N0YXR1c2AgZXZlbnQgaXMgZmlyZWQgZm9yIGV2ZXJ5IGl0ZW0gdGhhdCByZXR1cm5zIGZyb20gdGhlIHF1ZXVlLgogICAgCiAgICBOT1RFOiBJdCBpcyBlbnRpcmVseSBwb3NzaWJsZSBmb3IgYHRocnVzdC9kYXRhL3N0YXR1cyoqIHRvIGJlIGNhbGxlZCBhZnRlciBgdGhydXN0L2RhdGEvc3RvcCoqIGlmIHNldmVyYWwKICAgIGNhbGxzIHRha2UgdG8gbG9uZyB0byBjb21wbGV0ZS4gIFRoaXMgaXMgaW50ZW5kZWQsIGFuZCBwb3RlbnRpYWxseSB1c2VmdWwgaW5mb3JtYXRpb24uCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGF0dXMKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgY3VycmVudCBjb21wbGV0ZWQgY2FsbCBjb3VudCBmb3IgdGhpcyBxdWV1ZS4KICAgICoqLwogICAgZXhwb3J0cy5zdGF0dXMgPSAndGhydXN0L2RhdGEvc3RhdHVzJzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdG9wYCBldmVudCBpcyBmaXJlZCB3aGVuIGFsbCBpdGVtcyBpbiB0aGUgcXVldWUgcmV0dXJuLCBvciB0aGUgZmluaXNoZWRUaW1lb3V0IHNldHRpbmcgZWxhcHNlcy4KICAgIAogICAgQGV2ZW50IHRocnVzdC9kYXRhL3N0b3AKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgKGN1cnJlbnQpIGNvbXBsZXRlZCBjYWxsIGNvdW50IGZvciB0aGlzIHF1ZXVlLgogICAgKiovCiAgICBleHBvcnRzLnN0b3AgPSAndGhydXN0L2RhdGEvc3RvcCc7CiAgICBleHBvcnRzLmV2ZW50ID0gewogICAgICAgIGJlZm9yZVNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmRgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L2JlZm9yZS1zZW5kJywKICAgICAgICBzdGFydDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdGFydGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N0YXJ0CiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvc3RhcnQnLAogICAgICAgIHNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc2VuZGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3NlbmQKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zZW5kJywKICAgICAgICBlcnJvcjogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9lcnJvcmAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L2Vycm9yCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvZXJyb3InLAogICAgICAgIHN1Y2Nlc3M6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc3VjY2Vzc2AgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N1Y2Nlc3MKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zdWNlc3MnLAogICAgICAgIGNvbXBsZXRlOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L2NvbXBsZXRlYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9jb21wbGV0ZScsCiAgICAgICAgc3RvcDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdG9wYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvc3RvcAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L3N0b3AnCiAgICB9Owp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudC50eXBlcy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhL2V2ZW50LmZhY3RvcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4vZXZlbnQudHlwZXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vanF1ZXJ5LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBjYW1lbENhc2UgPSB1dGlsLmNhbWVsQ2FzZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGJpbmQgPSBfLmJpbmQsIGRhdGFFdmVudHMgPSBldmVudFR5cGVzLmV2ZW50LCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZTsKICAgIC8qKgogICAgVGhlIGV2ZW50IGZhY3RvcnkgbGlua3MgalF1ZXJ5IEV2ZW50cyB1cCB0byB0aHJ1c3QgY2VudHJpYyBldmVudHMuCiAgICBUaGUgZXZlbnQgZmFjdG9yeSB3b3VsZCBiZSByZXBsYWNlZCBpZiB3ZSB3ZXJlIGV2ZXIgbW92ZWQgb2ZmIG9mIHRoZSBqUXVlcnkgZGVwZW5kYW5jeS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QuZGF0YQogICAgKiovCiAgICB2YXIgZXZlbnRIYW5kbGVycyA9IHsKICAgICAgICAnYmVmb3JlLXNlbmQnOiAvLyBTdXBwb3J0ZWQgZXZlbnQgaGFuZGxlcnMKICAgICAgICB0cnVlLAogICAgICAgICdzZW5kJzogdHJ1ZSwKICAgICAgICAnZXJyb3InOiB0cnVlLAogICAgICAgICdzdWNjZXNzJzogdHJ1ZSwKICAgICAgICAnY29tcGxldGUnOiB0cnVlLAogICAgICAgICdzdGFydCc6IHRydWUsCiAgICAgICAgJ3N0b3AnOiB0cnVlCiAgICB9OwogICAgLyoqCiAgICBXcmFwcyBiZWZvcmVTZW5kLCB3aGljaCBpcyBhIGN1c3RvbSBwcm9wZXJ0eSBvbiB0aGUgalF1ZXJ5IGFqYXggZGF0YSBjYWxsLgogICAgCiAgICBAbWV0aG9kIGJlZm9yZVNlbmRNZXRob2QKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGJlZm9yZVNlbmRNZXRob2QoanFYSFIsIHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICB0aGlzLmZpcmUoZGF0YUV2ZW50c1snYmVmb3JlU2VuZCddLCBqcVhIUiwgc2V0dGluZ3MpOwogICAgfQogICAgZXhwb3J0cy5iZWZvcmVTZW5kTWV0aG9kID0gYmVmb3JlU2VuZE1ldGhvZDsKICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHZhciBldnQgPSBkYXRhRXZlbnRzW2V2ZW50XTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGV2dCk7CiAgICAgICAgICAgIHRoaXMuZmlyZS5hcHBseSh0aGlzLmZpcmUuYXN5bmMsIGFyZ3MpOwogICAgICAgIH07CiAgICB9KTsKICAgIHZhciBub3JtYWxpemVFdmVudHMgPSBmdW5jdGlvbiAoZXZ0cykgewogICAgICAgIGV2dHMgPSBldnRzLnNwbGl0KCcgJyk7CiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGV2dHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKCFldmVudEhhbmRsZXJzW2V2dHNbaV1dKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdFdmVudCAiezB9IiBpcyBub3QgYSB2YWxpZCBkYXRhIGV2ZW50JywgZXZ0c1tpXSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2dHNbaV0gPSBkYXRhRXZlbnRzW2V2dHNbaV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZ0cy5qb2luKCcgJyk7CiAgICB9OwogICAgdmFyIHNlbmRFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoaSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXZlbnQsIGpxWEhSLCBzZXR0aW5ncykgewogICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICBpZighc2V0dGluZ3MuX19tZWRpYXRvcl9kYXRhX2ZpcmVkX18pIHsKICAgICAgICAgICAgICAgIGpxWEhSLmFib3J0KCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCwgYWxsIGFqYXggY2FsbHMgbXVzdCBwYXNzIHRocm91Z2ggdGhydXN0LWRhdGEuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXNldHRpbmdzLnNpbGVudCkgewogICAgICAgICAgICAgICAgZXZlbnRGYWN0b3J5KGkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgQmluZHMgYWxsIHRoZSBqUXVlcnkgZGF0YSBldmVudHMgYW5kIGNyZWF0ZXMgZXZlbnQgbmF0aXZlIHRocnVzdCBldmVudHMgb3V0IG9mIHRoZW0uCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGluaXQKICAgIEBwYXJhbSB7alF1ZXJ5fSBBIGpRdWVyeSBpbnN0YW5jZSB3cmFwcGluZyAnZG9jdW1lbnQnCiAgICAqKi8KICAgIGZ1bmN0aW9uIGluaXQoakRvYykgewogICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgICAgZm9yKHZhciBpIGluIGV2ZW50SGFuZGxlcnMpIHsKICAgICAgICAgICAgdmFyIGpxRXZ0ID0gJ2FqYXgtJyArIGksIG1ldGhvZCA9IGV2ZW50RmFjdG9yeShpKTsKICAgICAgICAgICAgaWYoaSA9PT0gJ3NlbmQnKSB7CiAgICAgICAgICAgICAgICBtZXRob2QgPSBiaW5kKHNlbmRFdmVudEZhY3RvcnkoaSksIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGpEb2Mub24oY2FtZWxDYXNlKGpxRXZ0KSArIHRoaXMubmFtZXNwYWNlLCBtZXRob2QpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaW5pdCA9IGluaXQ7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50LmZhY3RvcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9yZXNwb25zZS5xdWV1ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAnLi9ldmVudC50eXBlcycsICdqcXVlcnknLCAndGhydXN0L2xvZycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXywgX19qUXVlcnlfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9qcXVlcnkuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBldmVudFR5cGVzID0gX19ldmVudFR5cGVzX187CgogICAgdmFyIGpRdWVyeSA9IF9falF1ZXJ5X187CgogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIHVpZCA9IF8udW5pcXVlSWQsIGFqYXggPSBqUXVlcnkuYWpheCwgZGF0YUV2ZW50V2FpdCA9IGV2ZW50VHlwZXMud2FpdCwgZGF0YUV2ZW50U3RhcnQgPSBldmVudFR5cGVzLnN0YXJ0LCBkYXRhRXZlbnRTdG9wID0gZXZlbnRUeXBlcy5zdG9wLCBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzLnN0YXR1cywgcXVldWUgPSB7CiAgICB9LCB1cGRhdGVYSFJJbnRlcm5hbHMgPSBmdW5jdGlvbiAoZGZvLCB4aHIpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZighZGZvLl94aHIpIHsKICAgICAgICAgICAgICAgIGRmby5feGhyID0geGhyOwogICAgICAgICAgICAgICAgZGZvLmdldEFsbFJlc3BvbnNlSGVhZGVycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZGZvLmdldFJlc3BvbnNlSGVhZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5nZXRBbGxSZXNwb25zZUhlYWRlcnNnZXRSZXNwb25zZUhlYWRlcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRmby5hYm9ydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBkZm8uc2V0UmVxdWVzdEhlYWRlciA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5zZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGZvLnJlc3BvbnNlVGV4dCA9IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgIGRmby5yZXNwb25zZVhNTCA9IHhoci5yZXNwb25zZVhNTDsKICAgICAgICAgICAgZGZvLnJlYWR5U3RhdGUgPSB4aHIucmVhZHlTdGF0ZTsKICAgICAgICAgICAgZGZvLnN0YXR1cyA9IHhoci5zdGF0dXM7CiAgICAgICAgICAgIGRmby5zdGF0dXNUZXh0ID0geGhyLnN0YXR1c1RleHQ7CiAgICAgICAgfTsKICAgIH0sIGFyZ3VtZW50UmVzb2x2ZXIgPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgfTsKICAgIH0sIGRlZmVyQ29udHJvbGxlckl0ZW1DYWxsYmFjayA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzLCBhcmd1bWVudHNbMF1bMF0pOwogICAgICAgIH07CiAgICB9OwogICAgLyoqCiAgICBUaGUgcmVzcG9uc2UgcXVldWUgY2xhc3MgaGFuZGxlcyBjcmVhdGlvbiBvZiBhIHF1ZXVlIG9yIGJhdGNoaW5nIHN5c3RlbS4KICAgIFdpdGggdGhpcyBzeXN0ZW0sIHdlIGNhbiBiYXRjaCB1cCBhbGwgb3VyIHNlcnZlciByZXF1ZXN0cywgYW5kIHJlcXVlc3QgdGhlbSBmcm9tIHRoZSBzZXJ2ZXIgYWxsIGFyb3VuZCB0aGUgc2FtZSB0aW1lLgogICAgSW4gYWRkaXRpb24gdG8gdGhhdCwgd2hlbiB0aGUgcmVxdWVzdHMgY29tZSBiYWNrIHdlIGNhbiBhbHNvIHNwb29sIHRoZW0gdG9nZXRoZXIsIHNvIHRoYXQgdGhlIGNhbGxzIGRvbid0IHJlc29sdmUgdW50aWwKICAgIGVpdGhlciBhbGwgdGhlIGNhbGxzIGNvbWUgYmFjaywgb3IgYSBzcGVjaWZpYyB0aW1lIGhhcyBlbGFwc2VkLgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAY2xhc3MgdGhydXN0LmRhdGEuUmVzcG9uc2VRdWV1ZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgcmVzcG9uc2UgcXVldWUgZm9yCiAgICBAcGFyYW0ge051bWJlcn0gc3RhcnRUaW1lb3V0IFRoZSB0aW1lIHRvIHdhaXQgZm9yIGFkZGl0aW9uYWwgcmVxdWVzdHMuCiAgICBAcGFyYW0ge051bWJlcn0gZmluaXNoVGltZW91dCBUaGUgbWF4aW11bSB0aW1lIHRvIHdhaXQgZm9yIHJlcXVlc3RzIHRvIHJldHVybi4KICAgICoqLwogICAgdmFyIFJlc3BvbnNlUXVldWUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJlc3BvbnNlUXVldWUobW9kdWxlLCBzdGFydFRpbWVvdXQsIGZpbmlzaFRpbWVvdXQpIHsKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWVvdXQgPSBzdGFydFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMuZmluaXNoVGltZW91dCA9IGZpbmlzaFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLm5hbWVzcGFjZSA9IG1vZHVsZS5uYW1lc3BhY2U7CiAgICAgICAgfQogICAgICAgIFJlc3BvbnNlUXVldWUucHJvdG90eXBlLmFkZFRvUXVldWUgPSAvKioKICAgICAgICBBZGRzIGEgcmVxdWVzdCB0byB0aGUgcXVldWUKICAgICAgICBRdWV1ZXMgYXJlIHNwbGl0IHVwIGJ5IEhUVFAgdHlwZSwgc28gR0VUIHJlcXVlc3RzIGdvIHdpdGggR0VUIHJlcXVlc3RzIGFuZCBQT1NUIHJlcXVlc3RzIGdvIHdpdGggUE9TVCByZXF1ZXN0cy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGFkZFRvUXVldWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgcmVxdWVzdCB0eXBlIChQT1NULCBHRVQsIGV0YykKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSByZXF1ZXN0IHVybCB0byBxdWV1ZSB1cAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSByZXF1ZXN0IG9wdGlvbnMuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIG9yIHJlamVjdCwgd2hlbiB0aGUgcmVxdWVzdCBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHR5cGUsIHVybCwgb3B0aW9ucykgewogICAgICAgICAgICB2YXIgZGZvID0gd2hlbi5kZWZlcigpLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYob3B0aW9ucy5iZWZvcmVTZW5kKSB7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgICAgIGRmby5wcm9ncmVzcyhmdW5jdGlvbiAoZXZlbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnRUeXBlICYmIGV2ZW50VHlwZSA9PSAnYmVmb3JlLXNlbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVTZW5kLmFwcGx5KGJlZm9yZVNlbmQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLmNvbXBsZXRlKSB7CiAgICAgICAgICAgICAgICBkZm8ucHJvbWlzZS5hbHdheXMob3B0aW9ucy5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5jb21wbGV0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGRmby5wcm9taXNlLnRoZW4ob3B0aW9ucy5zdWNjZXNzKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYob3B0aW9ucy5lcnJvcikgewogICAgICAgICAgICAgICAgZGZvLnByb21pc2Uub3RoZXJ3aXNlKG9wdGlvbnMuZXJyb3IpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc1F1ZXVlID0gISFxdWV1ZVt0eXBlXSwgbGlzdCA9IHF1ZXVlW3R5cGVdIHx8IChxdWV1ZVt0eXBlXSA9IHsKICAgICAgICAgICAgfSksIHRhaWwgPSBsaXN0LnRhaWwgfHwgKGxpc3QudGFpbCA9IGxpc3QubmV4dCA9IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGV4dGVuZCh0YWlsLCB7CiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICBkZm86IGRmbwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGlzdC50YWlsID0gdGFpbC5uZXh0ID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICBpZighaGFzUXVldWUpIHsKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhhdC5zdGFydFRpbWVvdXQpLnRoZW4odGhhdC5wcm9jZXNzKHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGZvLnByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBSZXNwb25zZVF1ZXVlLnByb3RvdHlwZS5wcm9jZXNzID0gLyoqCiAgICAgICAgUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0IHdpbGwgcHJvY2VzcyB0aGUgZ2l2ZW4gcXVldWUgYWZ0ZXIgdGhlIHN0YXJ0IHRpbWUgaGFzIGVsYXBzZWQuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBwcm9jZXNzCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHF1ZXVlIHR5cGUsIHRvIHByb2Nlc3MuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGRvIHRoZSB3b3JrIG9uIHRoZSBxdWV1ZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcXVldWVbdHlwZV0sIG5vZGUgPSBwYXJlbnQsIHRoYXQgPSB0aGlzLCBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RhdGFbezB9XTogQ3JlYXRpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFdhaXQsIHF1ZXJ5SWQsIHR5cGUpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEYXRhW3swfV06IFByb2Nlc3NpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICAgICAgdmFyIHdoZW5RdWV1ZSA9IFtdLCBkZWZlckNvbnRyb2xsZXIgPSB3aGVuLmRlZmVyKCksIHJldHVybkNvdW50ID0gMDsKICAgICAgICAgICAgICAgIGRlZmVyQ29udHJvbGxlci5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBGaW5pc2hpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICAgICAgICAgIHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50U3RvcCwgcXVlcnlJZCwgdHlwZSwgcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBkZWxldGUgcXVldWVbdHlwZV07CiAgICAgICAgICAgICAgICB2YXIgdGFpbCA9IG5vZGUudGFpbCwgc3RhdHVzQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRTdGF0dXMsIHF1ZXJ5SWQsIHR5cGUsICsrcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZm8gPSBub2RlLmRmbywgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgfSwgbm9kZS5vcHRpb25zKSwgeGhyRGZvID0gd2hlbi5kZWZlcigpLCB4aHIgPSBub2RlLnhociA9IGFqYXgobm9kZS51cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcih4aHJEZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoeGhyRGZvLnJlamVjdCkpOwogICAgICAgICAgICAgICAgICAgIHhockRmby5wcm9taXNlLnRoZW4oc3RhdHVzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIHdoZW5RdWV1ZS5wdXNoKHhocik7CiAgICAgICAgICAgICAgICAgICAgd2hlbi5hbGwoWwogICAgICAgICAgICAgICAgICAgICAgICB4aHJEZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBkZWZlckNvbnRyb2xsZXIucHJvbWlzZQogICAgICAgICAgICAgICAgICAgIF0sIHdoZW4uYXBwbHkoZGZvLnJlc29sdmUpLCB3aGVuLmFwcGx5KGRmby5yZWplY3QpLCB1cGRhdGVYSFJJbnRlcm5hbHMoZGZvLCB4aHIpKTsKICAgICAgICAgICAgICAgICAgICBkZm8ucHJvZ3Jlc3MoJ2JlZm9yZS1zZW5kJywgWwogICAgICAgICAgICAgICAgICAgICAgICBkZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFN0YXJ0LCBxdWVyeUlkLCB0eXBlLCB3aGVuUXVldWUubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRoYXQuZmluaXNoVGltZW91dCkKICAgICAgICAgICAgICAgIF0sIGRlZmVyQ29udHJvbGxlci5yZXNvbHZlLCBkZWZlckNvbnRyb2xsZXIucmVzb2x2ZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gUmVzcG9uc2VRdWV1ZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLlJlc3BvbnNlUXVldWUgPSBSZXNwb25zZVF1ZXVlOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9cmVzcG9uc2UucXVldWUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHZhciB3aGVuUXVldWUgPSBbXTsKICAgIGZ1bmN0aW9uIHdhaXRDYWxsYmFjayh1aWQpIHsKICAgICAgICB2YXIgZCA9IHdoZW4uZGVmZXIoKTsKICAgICAgICBkLnJlc29sdmVyWyd1aWQnXSA9IHVpZDsKICAgICAgICB3aGVuUXVldWUucHVzaCh7CiAgICAgICAgICAgIHVpZDogdWlkLAogICAgICAgICAgICByZXNvbHZlcjogZC5yZXNvbHZlcgogICAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gc3RvcENhbGxiYWNrKHVpZCkgewogICAgICAgIHZhciBpdGVtID0gXy5maW5kKHdoZW5RdWV1ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHgudWlkID09PSB1aWQ7CiAgICAgICAgfSk7CiAgICAgICAgd2hlblF1ZXVlID0gXy53aXRob3V0KHdoZW5RdWV1ZSwgaXRlbSk7CiAgICAgICAgaXRlbS5yZXNvbHZlci5yZXNvbHZlKCk7CiAgICB9CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBjb3VudGRvd246IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gU3Vic2NyaWJlIHRvIHRoZSB3YWl0IGFuZCBzdG9wIGV2ZW50cwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3N0b3AnLCBzdG9wQ2FsbGJhY2spOwogICAgICAgIH0sCiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gVW5zdWJzY3JpYmUgZnJvbSB0aGUgd2FpdCBhbmQgc3RvcCBldmVudHMKICAgICAgICAgICAgdGhydXN0LmRhdGEudW5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS51bnN1YnNjcmliZSgndGhydXN0L2RhdGEvc3RvcCcsIHN0b3BDYWxsYmFjayk7CiAgICAgICAgICAgIC8vIGRlZmVyIHVudGlsIGFueSBvZiB0aGUgZXZlbnRzIHRoYXQgd2VyZSBjYXB0dXJlZCBhcmUgcmVzb2x2ZWQsIG9yIHRoZSBkZWxheSBwYXNzZXMuCiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgaWYodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQgPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbCh3aGVuUXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQpCiAgICAgICAgICAgIF0sIGRlZmVyLnJlc29sdmUsIGRlZmVyLnJlamVjdCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuc3Vic2NyaXB0aW9uID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXN0YXJ0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRvbS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicKICAgIF07CiAgICAvKioKICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9kb20uCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9hY3Rpb24nLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2NvbnRleHQnLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JwogICAgXTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9zdWJqcXVlcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ2pxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ2hhcyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2pRdWVyeV9fLCBfX3V0aWxfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBqUXVlcnkgPSBfX2pRdWVyeV9fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGV4dGVuZCA9IF8uZXh0ZW5kLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBHTE9CQUwgPSAnLmdsb2JhbCc7CiAgICB2YXIgalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QgPSBbCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ2V4dGVuZCcsIAogICAgICAgICdxdWV1ZScsIAogICAgICAgICdkZXF1ZXVlJywgCiAgICAgICAgJ2NsZWFyUXVldWUnLCAKICAgICAgICAncHJvbWlzZScsIAogICAgICAgICdiaW5kJywgCiAgICAgICAgJ3VuYmluZCcsIAogICAgICAgICdsaXZlJywgCiAgICAgICAgJ2RpZScsIAogICAgICAgICdkZWxlZ2F0ZScsIAogICAgICAgICd1bmRlbGVnYXRlJywgCiAgICAgICAgJ2JsdXInLCAKICAgICAgICAnZm9jdXMnLCAKICAgICAgICAnZm9jdXNpbicsIAogICAgICAgICdmb2N1c291dCcsIAogICAgICAgICdsb2FkJywgCiAgICAgICAgJ3Jlc2l6ZScsIAogICAgICAgICdzY3JvbGwnLCAKICAgICAgICAndW5sb2FkJywgCiAgICAgICAgJ2NsaWNrJywgCiAgICAgICAgJ2RibGNsaWNrJywgCiAgICAgICAgJ21vdXNlZG93bicsIAogICAgICAgICdtb3VzZXVwJywgCiAgICAgICAgJ21vdXNlbW92ZScsIAogICAgICAgICdtb3VzZW92ZXInLCAKICAgICAgICAnbW91c2VvdXQnLCAKICAgICAgICAnbW91c2VlbnRlcicsIAogICAgICAgICdtb3VzZWxlYXZlJywgCiAgICAgICAgJ2NoYW5nZScsIAogICAgICAgICdzZWxlY3QnLCAKICAgICAgICAnc3VibWl0JywgCiAgICAgICAgJ2tleWRvd24nLCAKICAgICAgICAna2V5cHJlc3MnLCAKICAgICAgICAna2V5dXAnLCAKICAgICAgICAnZXJyb3InLCAKICAgICAgICAnc2VyaWFsaXplJywgCiAgICAgICAgJ3NlcmlhbGl6ZUFycmF5JywgCiAgICAgICAgJ2FqYXhTdGFydCcsIAogICAgICAgICdhamF4U3RvcCcsIAogICAgICAgICdhamF4Q29tcGxldGUnLCAKICAgICAgICAnYWpheEVycm9yJywgCiAgICAgICAgJ2FqYXhTdWNjZXNzJywgCiAgICAgICAgJ2FqYXhTZW5kJywgCiAgICAgICAgJ190b2dnbGUnLCAKICAgICAgICAnZmFkZVRvJywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAnc2xpZGVEb3duJywgCiAgICAgICAgJ3NsaWRlVXAnLCAKICAgICAgICAnc2xpZGVUb2dnbGUnLCAKICAgICAgICAnZmFkZUluJywgCiAgICAgICAgJ2ZhZGVPdXQnLCAKICAgICAgICAnZmFkZVRvZ2dsZScvKiwgJ29uJywgJ29mZicsICdvbmUnKi8gCiAgICBdOwogICAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgbmFtZXNwYWNlKSB7CiAgICAgICAgaWYoIW5hbWVzcGFjZSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0KICAgICAgICBpZihpc09iamVjdChldmVudHMpKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBuZXcgb2JqZWN0LCBzbyB0aGF0IG9yaWdpbmFsIG9iamVjdCB3aWxsIG5vdCBiZSBtb2RpZmllZCB3aGVuIGJpbmRpbmcuCiAgICAgICAgICAgIGV2ZW50cyA9IGV4dGVuZCh7CiAgICAgICAgICAgIH0sIGV2ZW50cyk7CiAgICAgICAgICAgIGZvcih2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgaWYoa2V5LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNba2V5ICsgbmFtZXNwYWNlXSA9IGV2ZW50c1trZXldOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmKCFldmVudHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KCcgJyk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBldmVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZ0ID0gZXZlbnRzW2ldOwogICAgICAgICAgICAgICAgaWYoZXZ0LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNbaV0gPSBldnQgKyBuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50cy5qb2luKCcgJyk7CiAgICAgICAgfQogICAgfQogICAgLyoKICAgIENsb25lIGpxdWVyeQogICAgUmVtb3ZlIGFsbCBleGNlc3MgbWV0aG9kcyB3ZSBkb24ndCB3YW50IHRvIGV4cG9zZSBuYXRpdmVseS4KICAgIG92ZXJybG9hZCBhbnkgbWV0aG9kcyB3ZSB3YW50IHRvIGNoYW5nZSBiZWhhdmlvciBvZiAobm90ZWFibHkgb24sIG9uZSwgYW5kIG9mZikKICAgIAogICAgSW5zdGVhZCBvZiBkdXBsaWNhdGluZyB0aGUganF1ZXJ5IGJlaGF2aW9yIHdlIGluc3RlYWQgcmVhbGlnbiBpdCB0byBvdXIgb3duLgogICAgKi8KICAgIC8vIGpRdWVyeSBzdWIKICAgIGZ1bmN0aW9uIHN1YkpRdWVyeSgpIHsKICAgICAgICB2YXIgdFF1ZXJ5ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB0UXVlcnkucHJvdG90eXBlLmluaXQoc2VsZWN0b3IsIGNvbnRleHQsIG5hbWVzcGFjZSB8fCAodGhpcyAmJiB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgIH07CiAgICAgICAgXy5tZXJnZSh0UXVlcnksIGpRdWVyeSk7CiAgICAgICAgLy8gRG8gbm90IGxpa2UKICAgICAgICAvLyBwcm9iYWJseSBuZWVkZWQgaW4gc29tZSBzcGVjaWFsIHVuaXF1ZSBjYXNlcwogICAgICAgIHRRdWVyeS5qUXVlcnkgPSBqUXVlcnk7CiAgICAgICAgLy8gZXhwb3NlIGV2ZW50cyBmb3IgZG9pbmcgc3BlY2lhbCBldmVudHMgYXMgcmVxdWlyZWQuCiAgICAgICAgdFF1ZXJ5LmV2ZW50ID0gKGpRdWVyeSkuZXZlbnQ7CiAgICAgICAgdFF1ZXJ5LmZuID0gdFF1ZXJ5LnByb3RvdHlwZSA9IGV4dGVuZCh7CiAgICAgICAgfSwgalF1ZXJ5LmZuKTsKICAgICAgICB0UXVlcnkuZm4uY29uc3RydWN0b3IgPSB0UXVlcnk7CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiBpbml0KHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgdmFyIGlvRG9tID0gY29udGV4dCBpbnN0YW5jZW9mIHRRdWVyeTsKICAgICAgICAgICAgaWYoY29udGV4dCAmJiBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ICYmICEoaW9Eb20pKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gdFF1ZXJ5KGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBqUXVlcnkuZm4uaW5pdC5jYWxsKHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCB0UXVlcnlSb290KTsKICAgICAgICAgICAgaWYobmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICByZXN1bHQubmFtZXNwYWNlID0gbmFtZXNwYWNlOwogICAgICAgICAgICB9IGVsc2UgaWYoaW9Eb20pIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5uYW1lc3BhY2UgPSBjb250ZXh0Lm5hbWVzcGFjZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQucHJvdG90eXBlID0gdFF1ZXJ5LmZuOwogICAgICAgIHZhciB0UXVlcnlSb290ID0gdFF1ZXJ5KGRvY3VtZW50KTsKICAgICAgICAvLyByZW1vdmUgYWxsIG5vdCBhcHBsaWNhYmxlIG1ldGhvZHMgb2ZmIG9mIGZuLgogICAgICAgIGVhY2goalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIGlmKHRRdWVyeS5mblt4XSkgewogICAgICAgICAgICAgICAgdFF1ZXJ5LmZuW3hdID0gbnVsbDsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0UXVlcnkuZm5beF07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBfLmVhY2goWwogICAgICAgICAgICAnb24nLCAKICAgICAgICAgICAgJ29uZScsIAogICAgICAgICAgICAnb2ZmJwogICAgICAgIF0sIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHRRdWVyeS5mblt4XSA9IF8ud3JhcCh0UXVlcnkuZm5beF0sIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCd0UXVlcnlbezB9XTogQmluZGluZyAnICsgeCArICcgZXZlbnRzLi4uJywgdGhpcy5uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIGFyZ3NbMF0gPSBub3JtYWxpemVFdmVudHMoYXJnc1swXSwgdGhpcy5uYW1lc3BhY2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIGYuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIHRRdWVyeS5mbi5xdWVyeSA9IHRRdWVyeS5mbi4kID0gdFF1ZXJ5LmZuLmZpbmQ7CiAgICAgICAgcmV0dXJuIHRRdWVyeTsKICAgIH0KICAgIGV4cG9ydHMudFF1ZXJ5ID0gc3ViSlF1ZXJ5KCk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXN1YmpxdWVyeS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9hY3Rpb24nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4uL3N1YmpxdWVyeSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18sIF9fc3VianF1ZXJ5X18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2NvbnZlbnRpb24vYWN0aW9uLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgc3VianF1ZXJ5ID0gX19zdWJqcXVlcnlfXzsKCiAgICB2YXIgJCA9IHN1YmpxdWVyeS50UXVlcnk7CiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIEFDVElPTlMgPSAnY29uZmlnLmRvbS5hY3Rpb25zJywgQUNUSU9OU1NJTkdMRSA9ICdhY3Rpb25zJywgU1RSSU5HID0gJ3N0cmluZycsIFJFR0lTVFJBVElPTlMgPSAnX3JlZ2lzdHJhdGlvbnMnLCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBpc1N0cmluZyA9IF8uaXNTdHJpbmcsIGlzQXJyYXkgPSBfLmlzQXJyYXk7CiAgICB2YXIgZ2V0QWN0aW9uQXR0cmlidXRlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgICAgIHJldHVybiAnZGF0YS1hY3Rpb24tJyArIGV2ZW50TmFtZTsKICAgIH07CiAgICB2YXIgQWN0aW9uSGFuZGxlciA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQWN0aW9uSGFuZGxlcigpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIEFjdGlvbkhhbmRsZXIucHJvdG90eXBlLnJlZ2lzdGVyID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgYWN0aW9uTmFtZSwgYWN0aW9uKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50czsKICAgICAgICAgICAgaWYoIWV2ZW50c1tldmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBldmVudHNbZXZlbnROYW1lXSA9IHsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIWV2ZW50c1tldmVudE5hbWVdW2FjdGlvbk5hbWVdKSB7CiAgICAgICAgICAgICAgICBldmVudHNbZXZlbnROYW1lXVthY3Rpb25OYW1lXSA9IGFjdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ1RoZSBhY3Rpb24gezF9IGhhbmRsZXIgInswfSIgaGFzIGFscmVhZHkgYmVlbiB0YWtlbiEnLCBhY3Rpb25OYW1lLCBldmVudE5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5wcm90b3R5cGUudW5yZWdpc3RlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGFjdGlvbk5hbWUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuZXZlbnRzOwogICAgICAgICAgICBpZihldmVudHNbZXZlbnROYW1lXSAmJiBldmVudHNbZXZlbnROYW1lXVthY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBBY3Rpb25IYW5kbGVyLnByb3RvdHlwZS5jYWxsYmFja0ZvciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIHJldHVyblJlc3VsdHMpIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuZXZlbnRzLCBhY3Rpb25BdHRyaWJ1dGUgPSBnZXRBY3Rpb25BdHRyaWJ1dGUoZXZlbnROYW1lKSwgcmV0dXJuUmVzdWx0c0RlZmluZWQgPSB0eXBlb2YgcmV0dXJuUmVzdWx0cyAhPT0gJ3VuZGVmaW5lZCc7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlVmFsdWUgPSAkKHRoaXMpLmF0dHIoYWN0aW9uQXR0cmlidXRlKTsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBhdHRyaWJ1dGVWYWx1ZSA9PT0gU1RSSU5HKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGV2ZW50c1tldmVudE5hbWVdW2F0dHJpYnV0ZVZhbHVlXTsKICAgICAgICAgICAgICAgICAgICBpZihhY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uLmhhbmRsZXIuYXBwbHkoYWN0aW9uLmNvbnRleHQgfHwgdGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYocmV0dXJuUmVzdWx0c0RlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldHVyblJlc3VsdHM7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIEFjdGlvbkhhbmRsZXIuYWN0aW9uSGFuZGxlcnMgPSB7CiAgICAgICAgfTsKICAgICAgICBBY3Rpb25IYW5kbGVyLmdldEZvciA9IGZ1bmN0aW9uIGdldEZvcihuYW1lKSB7CiAgICAgICAgICAgIGlmKHRoaXMuYWN0aW9uSGFuZGxlcnNbbmFtZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFjdGlvbkhhbmRsZXJzW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAodGhpcy5hY3Rpb25IYW5kbGVyc1tuYW1lXSA9IG5ldyBBY3Rpb25IYW5kbGVyKCkpOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIEFjdGlvbkhhbmRsZXI7CiAgICB9KSgpOyAgICAKICAgIHZhciBldmVudHMgPSB7CiAgICAgICAgY2xpY2s6IFsKICAgICAgICAgICAgJ2EnLCAKICAgICAgICAgICAgJ2J1dHRvbicsIAogICAgICAgICAgICAnaW5wdXRbdHlwZT0iYnV0dG9uIl0nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9InN1Ym1pdCJdJwogICAgICAgIF0sCiAgICAgICAgZGJsY2xpY2s6IFsKICAgICAgICAgICAgJ2EnLCAKICAgICAgICAgICAgJ2J1dHRvbicsIAogICAgICAgICAgICAnaW5wdXRbdHlwZT0iYnV0dG9uIl0nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9InN1Ym1pdCJdJwogICAgICAgIF0sCiAgICAgICAgbW91c2VlbnRlcjogWwogICAgICAgICAgICAnJwogICAgICAgIF0sCiAgICAgICAgbW91c2VsZWF2ZTogWwogICAgICAgICAgICAnJwogICAgICAgIF0sCiAgICAgICAgZm9jdXM6IFsKICAgICAgICAgICAgJ2lucHV0JwogICAgICAgIF0sCiAgICAgICAgYmx1cjogWwogICAgICAgICAgICAnaW5wdXQnCiAgICAgICAgXQogICAgfTsKICAgIHZhciBhcnJheVNob3J0SGFuZEFyZ3NJbk9yZGVyID0gWwogICAgICAgICduYW1lJywgCiAgICAgICAgJ2hhbmRsZXInLCAKICAgICAgICAnY29udGV4dCcKICAgIF07CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIEFDVElPTlMKICAgICAgICBdLAogICAgICAgIGlnbml0ZTogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgdGhydXN0LmRvbS5hY3Rpb25IYW5kbGVyID0gYWN0aW9uSGFuZGxlcjsKICAgICAgICAgICAgdmFyICRib2R5ID0gJCh3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgICAgICAgIF8uZWFjaChldmVudHMsIGZ1bmN0aW9uIChldmVudFNlbGVjdG9ycywgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAvLyB1c2luZyB0aHJ1c3QgbmFtZSwgYXMgY2FsbGJhY2sgbmVlZHMgdG8gYmUgcGVyIHRocnVzdCBpbnN0YW5jZQogICAgICAgICAgICAgICAgLy8gaW4gdGhlIGV2ZW50IG9mIG11bHRpcGxlIHRocnVzdCBpbnN0YW5jZXMuCiAgICAgICAgICAgICAgICAkYm9keS5vbihldmVudE5hbWUgKyAnLicgKyBBQ1RJT05TU0lOR0xFICsgdGhydXN0Lm5hbWUsIGV2ZW50U2VsZWN0b3JzLmpvaW4oZ2V0QWN0aW9uQXR0cmlidXRlKGV2ZW50TmFtZSkgKyAnLCAnKSwgYWN0aW9uSGFuZGxlci5jYWxsYmFja0ZvcihldmVudE5hbWUsIHRydWUpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBkZW9yYml0OiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25IYW5kbGVyID0gQWN0aW9uSGFuZGxlci5nZXRGb3IodGhydXN0Lm5hbWUpOwogICAgICAgICAgICB2YXIgJGJvZHkgPSAkKHdpbmRvdy5kb2N1bWVudC5ib2R5KTsKICAgICAgICAgICAgXy5lYWNoKGV2ZW50cywgZnVuY3Rpb24gKGV2ZW50U2VsZWN0b3JzLCBldmVudE5hbWUpIHsKICAgICAgICAgICAgICAgICRib2R5Lm9mZignLicgKyBBQ1RJT05TU0lOR0xFICsgdGhydXN0Lm5hbWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbnMgPSBtb2QuY29udmVudGlvbihBQ1RJT05TKSwgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKG1vZC50aHJ1c3QubmFtZSksIGRvbSA9IGZhY2FkZSwgbW9kdWxlSW5zdGFuY2UgPSBtb2QuaW5zdGFuY2U7CiAgICAgICAgICAgIGlmKGFjdGlvbnMpIHsKICAgICAgICAgICAgICAgIF8uZm9yT3duKGFjdGlvbnMsIGZ1bmN0aW9uIChhY3Rpb25Db2xsZWN0aW9uLCBldmVudE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZighaXNBcnJheShhY3Rpb25Db2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihhY3Rpb25Db2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoYWN0aW9uQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoYWN0aW9uQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Db2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8uZWFjaChhY3Rpb25Db2xsZWN0aW9uLCBmdW5jdGlvbiAoYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzQXJyYXkoYWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0FjdGlvbiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmVhY2goYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciwgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4ID09PSAnaGFuZGxlcicgJiYgaXNTdHJpbmcoYWN0aW9uW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25baV0gPSBtb2QuaW5zdGFuY2VbYWN0aW9uW2ldXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3QWN0aW9uW3hdID0gYWN0aW9uW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSBuZXdBY3Rpb247CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbk5hbWUgPSBhY3Rpb24ubmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWFjdGlvbi5oYW5kbGVyICYmIGFjdGlvbi5tb2R1bGVIYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24uaGFuZGxlciA9IG1vZC5pbnN0YW5jZVthY3Rpb24ubW9kdWxlSGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZighYWN0aW9uLmhhbmRsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTXVzdCBkZWZpbmUgZWl0aGVyIGEgaGFuZGxlciBvciBtb2R1bGUgaGFuZGxlci4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25IYW5kbGVyLnJlZ2lzdGVyKGV2ZW50TmFtZSwgYWN0aW9uTmFtZSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbnMgPSBtb2QuY29udmVudGlvbihBQ1RJT05TKSwgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKG1vZC50aHJ1c3QubmFtZSksIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICBmb3IodmFyIGFjdGlvbkV2ZW50IGluIGFjdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYWN0aW9uQ29sbGVjdGlvbiA9IGFjdGlvbnNbYWN0aW9uRXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGZvcih2YXIgYWN0aW9uTmFtZSBpbiBhY3Rpb25Db2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkhhbmRsZXIudW5yZWdpc3RlcihhY3Rpb25FdmVudCwgYWN0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuYWN0aW9uID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWFjdGlvbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9hbmltYXRlLmNvbnRhaW5lcicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2NvbnRleHQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBldmVudCA9IHsKICAgICAgICBhbnlDb250YWluZXI6ICd0aHJ1c3QtY29udmVudGlvbi1jb250YWluZXItYW55JywKICAgICAgICBjaGFuZ2VDb250YWluZXI6ICd0aHJ1c3QtY29udmVudGlvbi1jb250YWluZXItY2hhbmdlJwogICAgfSwgYW55ID0gXy5hbnksIGRlZmVyID0gXy5kZWZlciwgYmluZCA9IF8uYmluZCwgU1RBUlQgPSAnc3RhcnQtc3RhdHVzJywgQU5JTUFURSA9ICdhbmltYXRlJywgQ09OVEFJTkVSID0gJ2NvbnRhaW5lcicsIENPTlRFWFQgPSAnY29udGV4dCc7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIEFOSU1BVEUKICAgICAgICBdLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1lZGlhdG9yID0gbW9kLmluc3RhbmNlLm1lZGlhdG9yOwogICAgICAgICAgICBtZWRpYXRvci5zdWJzY3JpYmUoZXZlbnQuY2hhbmdlQ29udGFpbmVyLCBiaW5kKHRoYXQuY2hhbmdlLCB0aGF0LCBtb2QpKTsKICAgICAgICB9LAogICAgICAgIGNoYW5nZTogZnVuY3Rpb24gKG1vZHVsZSwgY29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmKG1vZHVsZS5jb252ZW50aW9uKENPTlRBSU5FUikgPT09IGNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgaWYobW9kdWxlLmNvbnZlbnRpb24oU1RBUlQpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFuaW1hdGUgPSBtb2R1bGUuY29udmVudGlvbihBTklNQVRFKTsKICAgICAgICAgICAgICAgICAgICBpZihhbmltYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb250ZXh0Tm9kZSA9IG1vZHVsZS5pbnN0YW5jZS5kb20oKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dE5vZGUucmVtb3ZlQ2xhc3MoYW5pbWF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgYW5pbWF0ZSA9IG1vZC5jb252ZW50aW9uKEFOSU1BVEUpLCBjb250YWluZXIgPSBtb2QuY29udmVudGlvbihDT05UQUlORVIpLCBjb250ZXh0ID0gbW9kLmNvbnZlbnRpb24oQ09OVEVYVCksIGRvbSA9IGZhY2FkZTsKICAgICAgICAgICAgaWYoYW5pbWF0ZSAmJiBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IGRvbS5jb250ZXh0LmNsb25lKCkuYXBwZW5kVG8oZG9tLmNvbnRleHQucGFyZW50KCkpOwogICAgICAgICAgICAgICAgY2xvbmUuYWRkQ2xhc3MoYW5pbWF0ZS5yZXBsYWNlKC9cLi9nLCAnICcpLnRyaW0oKSk7CiAgICAgICAgICAgICAgICBtb2QuaW5zdGFuY2UuZG9tID0gbW9kLmluc3RhbmNlLiQgPSBjbG9uZTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYmluZCh0aGF0LmNsZWFudXAsIHRoYXQsIGRvbS5jb250ZXh0LnBhcmVudCgpLCBhbmltYXRlLCBjb250ZXh0KSwgMjAwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNsZWFudXA6IGZ1bmN0aW9uIChjb250YWluZXIsIGFuaW1hdGUsIGNvbnRleHQpIHsKICAgICAgICAgICAgY29udGFpbmVyLmZpbmQoY29udGV4dCkuZmlsdGVyKCc6bm90KCcgKyBhbmltYXRlICsgJyknKS5yZW1vdmUoKTsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5hbmltYXRlQ29udGFpbmVyID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWFuaW1hdGUuY29udGFpbmVyLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2NvbnRleHQnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4uL3N1YmpxdWVyeSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18sIF9fc3VianF1ZXJ5X18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2NvbnZlbnRpb24vY29udGV4dC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyIHRRdWVyeSA9IHN1YmpxdWVyeS50UXVlcnk7CiAgICB2YXIgQ09OVEVYVCA9ICdjb25maWcuZG9tLmNvbnRleHQnOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBDT05URVhUCiAgICAgICAgXSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0gbW9kLmNvbnZlbnRpb24oQ09OVEVYVCk7CiAgICAgICAgICAgIGlmKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIG1vZC5pbnN0YW5jZS5kb20gPSBtb2QuaW5zdGFuY2UuJCA9IHRRdWVyeShjb250ZXh0LCBmYWNhZGUuY29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5jb250ZXh0ID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbnRleHQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vZXZlbnQnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vY29udmVudGlvbi9ldmVudC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIENPTlRFWFQgPSAnY29uZmlnLmRvbS5jb250ZXh0JywgRVZFTlRTID0gJ2NvbmZpZy5kb20uZXZlbnRzJywgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgdmFyIGV2ZW50UHJvcGVydHlMb2FkT3JkZXIgPSBbCiAgICAgICAgJ3NlbGVjdG9yJywgCiAgICAgICAgJ2RhdGEnLCAKICAgICAgICAnaGFuZGxlcicKICAgIF07CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIEVWRU5UUwogICAgICAgIF0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gbW9kLmNvbnZlbnRpb24oRVZFTlRTKSwgJGNvbnRleHQgPSBmYWNhZGUuY29udGV4dCwgbW9kdWxlSW5zdGFuY2UgPSBtb2QuaW5zdGFuY2U7CiAgICAgICAgICAgIGlmKGV2ZW50cykgewogICAgICAgICAgICAgICAgXy5mb3JJbihldmVudHMsIGZ1bmN0aW9uIChldmVudHNDb2xsZWN0aW9uLCBldmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vdmFyIGV2ZW50c0NvbGxlY3Rpb24gPSBldmVudHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGlmKCFpc0FycmF5KGV2ZW50c0NvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0NvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGV2ZW50c0NvbGxlY3Rpb24ubGVuZ3RoICYmICghaXNBcnJheShldmVudHNDb2xsZWN0aW9uWzBdKSB8fCBpc1N0cmluZyhldmVudHNDb2xsZWN0aW9uWzBdKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzQ29sbGVjdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0NvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGV2ZW50c0NvbGxlY3Rpb24sIGZ1bmN0aW9uIChkZWZpbml0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiaW5kRXZlbnQgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudAogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KGRlZmluaXRpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnQucHVzaC5hcHBseShiaW5kRXZlbnQsIGRlZmluaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgaGF2ZSBvbmUgZWRnZWNhc2UgaGVyZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHNob3J0IGhhbmQgYXJyYXksIGhhcyBhIGNvbnRleHQgdGhhdCBpcyBhIHN0cmluZyBvciBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGl0IGRvZXNudCBoYXZlIGluZm9ybWF0aW9uIGZvciBib3RoIHNlbGVjdG9yIGFuZCBkYXRhLCB0aGlzIHdpbGwgZmFpbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuIHJlY292ZXIgd2hlbiBhbGwgNSBwb3NzaWJsZSBpdGVtcyBhcmUgZGVmaW5lZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyID0gYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIHdlcmUgYXNrZWQgZm9yIGEgbWV0aG9kIG9uIHRoZSBtb2R1bGUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyhoYW5kbGVyKSAmJiBiaW5kRXZlbnQubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAxXSA9IG1vZC5pbnN0YW5jZVtoYW5kbGVyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSAvLyBXZSBkaWRudCBmaW5kIGEgZnVuY3Rpb24gOigKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICBFREdFIENBU0U6IElmIGNvbnRleHQgaXMgYSBmdW5jdGlvbiwgd2Ugd2lsbCBhc3N1bWUgYWxsIGlzIHdlbGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICBFdmVuIGlmIHRoZSBoYW5kbGVyIGlzIGEgc3RyaW5nIHRoYXQgbmVlZHMgdG8gYmUgcmVmZXJlbmNlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdvcmsgYXJyb3VuZHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgIFNob3J0aGFuZDogYWRkIG51bGwvZW1wdHkgdmFsdWVzIGZvciBzZWxlY3RvciBhbmQgZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICBMb25naGFuZDogc3dpdGNoIHRvIGxvbmcgaGFuZCBhcyBpdCBoYXMgbW9yZSBleHBsaWNpdCBzeW50YXguCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighaXNTdHJpbmcoaGFuZGxlcikgJiYgIWlzRnVuY3Rpb24oaGFuZGxlcikgJiYgYmluZEV2ZW50Lmxlbmd0aCA+IDIgfHwgYmluZEV2ZW50Lmxlbmd0aCA9PT0gNSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGhhbmRsZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMl0gPSBtb2QuaW5zdGFuY2VbaGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMl0gPSBfLmJpbmQoYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAyXSwgYmluZEV2ZW50LnBvcCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc1N0cmluZyhoYW5kbGVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV0gPSBtb2QuaW5zdGFuY2VbaGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmVhY2goZXZlbnRQcm9wZXJ0eUxvYWRPcmRlciwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkZWZpbml0aW9uW3hdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGRlZmluaXRpb25beF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHggPT09ICdoYW5kbGVyJyAmJiBkZWZpbml0aW9uLmNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gXy5iaW5kKHZhbHVlLCBkZWZpbml0aW9uLmNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudC5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxsIHRoZSBvbiBtZXRob2QsIHdpdGggb3VyIGFyZ3VtZW50cy4KICAgICAgICAgICAgICAgICAgICAgICAgJGNvbnRleHQub24uYXBwbHkoJGNvbnRleHQsIGJpbmRFdmVudCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSBtb2QuY29udmVudGlvbihFVkVOVFMpLCAkY29udGV4dCA9IGZhY2FkZS5jb250ZXh0OwogICAgICAgICAgICBpZigkY29udGV4dCkgewogICAgICAgICAgICAgICAgJGNvbnRleHQub2ZmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5ldmVudCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LnRlbXBsYXRlCiAgICBAc3VibW9kdWxlIHRocnVzdC50ZW1wbGF0ZS5jb25maWcKICAgICoqLwogICAgLyoqCiAgICBSZXNvbHZlcyB0aGUgZ2l2ZW4gcHJvcGVydGllcyB3aGVuIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoZSBwbHVnaW4uCiAgICAKICAgIFRoaXMgaXMgZm9yIGludGVybmFsIHRocnVzdCB1c2UuICBUaHJ1c3QgdXNlcyB0aGlzIGFycmF5IHRvIGdlbmVyYXRlIHRoZSBwcm9wZXJ0aWVzIHRoYXQgbmVlZCB0byBiZSBoYW5kZWQKICAgIHRvIHRoZSBwbHVnaW4gY29uc3RydWN0b3IgbWV0aG9kLgogICAgCiAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnY2ZnJywgCiAgICAgICAgJ2RhdGEnCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvdGVtcGxhdGUuCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL3RlbXBsYXRlJywgCiAgICAgICAgJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL2tub2Nrb3V0LmVuZ2luZScKICAgIF07CiAgICAvKioKICAgIE1hcHMgdGhlIGF2YWlsYWJsZSB0ZW1wbGF0ZXMsIHRvIHRoZWlyIGFwcHJvcHJpYXRlIG1vZHVsZSBuYW1lLgogICAgCiAgICAqKnByZWNvbXBpbGVkIGlzIGEgc3BlY2lhbCBjYXNlLCBhbmQgdGhvc2UgbWV0aG9kcyBhcmUgZXhwZWN0ZWQgdG8gYmUgY29kZSBidWlsdCBmdW5jdGlvbnMuCiAgICAKICAgIEBwcm9wZXJ0eSB0eXBlcwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7T2JqZWN0fQogICAgKiovCiAgICBleHBvcnRzLnR5cGVzID0gewogICAgICAgICdkb1QnOiAnZG9UJywKICAgICAgICAncHJlY29tcGlsZWQnOiB0cnVlCiAgICB9OwogICAgLyoqCiAgICBNYXBzIHRoZSB0ZW1wbGF0ZSBldmFsdWF0b3JzLCBzbyB0aGF0IHdoZW4gY3JlYXRpbmcgYSB0ZW1wbGF0ZSBmb3Iga25vY2tvdXQsIGl0IGtub3dzIGhvdyB0byBwcm9wZXJseSBvdXRwdXQgdGhlIGluZm9ybWF0aW9uLgogICAgCiAgICBAcHJvcGVydHkgZXZhbHVhdG9ycwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7T2JqZWN0fQogICAgKiovCiAgICBleHBvcnRzLmV2YWx1YXRvcnMgPSB7CiAgICAgICAgJ2RvVCc6IHsKICAgICAgICAgICAgbGVmdDogJ3t7PSAnLAogICAgICAgICAgICByaWdodDogJ319JwogICAgICAgIH0KICAgIH07CiAgICAvKioKICAgIFRoZSBkZWZhdWx0IHRlbXBsYXRlIHR5cGUsIHVzZWQgd2hlbiBleHRlbnNpb24gaXNuJ3QgZ2l2ZW4uCiAgICAKICAgIEBwcm9wZXJ0eSBkZWZhdWx0VHlwZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJ2RvVCcKICAgICoqLwogICAgZXhwb3J0cy5kZWZhdWx0VHlwZSA9ICdkb1QnOwogICAgLyoqCiAgICBUaGUgYmFzZSBsb2NhdGlvbiwgcmVsYXRpdmUgdG8gdGhlIGFwcGxpY2F0aW9uIHBhdGggZm9yIHRlbXBsYXRlIGxvY2F0aW9uLgogICAgSWYgdGVtcGxhdGUgcGF0aHMgYXJlIGdpdmVuIHJlbGF0aXZlIHRvIGFwcGxpY2F0aW9uIHBhdGgsIHRoaXMgY2FuIGJlIGxlZnQgZW1wdHkuCiAgICAKICAgIEBwcm9wZXJ0eSBiYXNlVXJsCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtTdHJpbmd9CiAgICBAZGVmYXVsdCAnJwogICAgKiovCiAgICBleHBvcnRzLmJhc2VVcmwgPSAnJzsKICAgIC8qKgogICAgRGVmaW5lcyB0aGUgZXh0ZW5zaW9uIHVzZWQgZm9yIHRlbXBsYXRlcyBzdG9yZWQgb24gdGhlIHNlcnZlci4KICAgIAogICAgQHByb3BlcnR5IGV4dGVuc2lvbgogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJy50bXBsJwogICAgKiovCiAgICBleHBvcnRzLmV4dGVuc2lvbiA9ICcudG1wbCc7CiAgICAvKioKICAgIERlZmluZXMgdGhlIEFNRCBwYXRocyB0byBmaW5kIHRoZSBnaXZlbiB0ZW1wbGF0ZSB0eXBlCiAgICAKICAgIEBwcm9wZXJ0eSB0ZW1wbGF0ZVBhdGhzCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtTdHJpbmd9CiAgICBAZGVmYXVsdCB7fQogICAgKiovCiAgICBleHBvcnRzLnRlbXBsYXRlUGF0aHMgPSB7CiAgICAgICAgJ2RvVCc6ICdkb1QnCiAgICB9Owp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi9rbm9ja291dC5lbmdpbmUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJ2tub2Nrb3V0J10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19rb19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RlbXBsYXRlL3RlbXBsYXRlLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGtvID0gX19rb19fOwoKICAgIHZhciB3aGVuID0gdXRpbC53aGVuLCBlYWNoID0gXy5lYWNoLCBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LCBmaW5kID0gXy5maW5kLCBrbm9ja291dFRlbXBsYXRlcyA9IHsKICAgIH07CiAgICB2YXIgaW5pdEtub2Nrb3V0SW50ZWdyYXRpb24gPSBmdW5jdGlvbiAodGVtcGxhdGVNYW5hZ2VyKSB7CiAgICAgICAgdmFyIFRocnVzdFRlbXBsYXRlU291cmNlID0gKGtvKS50ZW1wbGF0ZVNvdXJjZXMudGhydXN0VGVtcGxhdGUgPSBmdW5jdGlvbiAodGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0VGVtcGxhdGVTb3VyY2UucHJvdG90eXBlID0gewogICAgICAgICAgICB0ZXh0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICBpZihhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQudGVtcGxhdGUuaHRtbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZS5odG1sID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKCdUaHJ1c3QgVGVtcGxhdGUgZG9lcyBub3Qgc3VwcG9ydCByZXdyaXRpbmcuLi4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICBpZighdGhhdC50ZW1wbGF0ZS5kYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZS5kYXRhID0gewogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQudGVtcGxhdGUuZGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmRhdGFba2V5XSA9IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgLy8gQmVnaW4gaW50ZWdyYXRpb24gb2YgdGVtcGxhdGUgcGx1Z2luLCB3aXRoIEtub2Nrb3V0LgogICAgICAgIHZhciBvbGRFbmdpbmUgPSAoa28pLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlOwogICAgICAgIHZhciBjb252ZW50aW9uVGVtcGxhdGVFbmdpbmUgPSAoa28pLmNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB9OwogICAgICAgIGNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGUgPSBrby51dGlscy5leHRlbmQobmV3IChrbykudGVtcGxhdGVFbmdpbmUoKSwgewogICAgICAgICAgICByZW5kZXJUZW1wbGF0ZVNvdXJjZTogZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgaWYodGVtcGxhdGVTb3VyY2UudGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdG9ycyA9IHRoaXMuZXZhbHVhdG9yczsKICAgICAgICAgICAgICAgICAgICBpZighZXZhbHVhdG9ycykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV2YWx1YXRvcnMgPSBldmFsdWF0b3JzID0gdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5ldmFsdWF0b3JzW3RlbXBsYXRlTWFuYWdlci5jb25maWcuZGVmYXVsdFR5cGVdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcpOwogICAgICAgICAgICAgICAgICAgIGlmKCFwcmVjb21waWxlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVjb21waWxlZCA9IHRlbXBsYXRlTWFuYWdlci5jb21waWxlKCd7eyB3aXRoKCRkYXRhKSB7IH19ICcgKyB0ZW1wbGF0ZVNvdXJjZS50ZXh0KCkgKyAiIHt7IH0gfX0iKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVTb3VyY2VbJ2RhdGEnXSgncHJlY29tcGlsZWQnLCBwcmVjb21waWxlZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIFJ1biB0aGUgdGVtcGxhdGUgYW5kIHBhcnNlIGl0cyBvdXRwdXQgaW50byBhbiBhcnJheSBvZiBET00gZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRNYXJrdXAgPSB0ZW1wbGF0ZVNvdXJjZS50ZW1wbGF0ZS5jb21waWxlZChiaW5kaW5nQ29udGV4dCkucmVwbGFjZSgvXHMrL2csICIgIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChrbykudXRpbHMucGFyc2VIdG1sRnJhZ21lbnQocmVuZGVyZWRNYXJrdXApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9sZEVuZ2luZS5yZW5kZXJUZW1wbGF0ZVNvdXJjZS5hcHBseShvbGRFbmdpbmUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jazogZnVuY3Rpb24gKHNjcmlwdCkgewogICAgICAgICAgICAgICAgaWYoIXRoaXMuZXZhbHVhdG9yQ2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdG9ycyA9IHRlbXBsYXRlTWFuYWdlci5jb25maWcuZXZhbHVhdG9yc1t0ZW1wbGF0ZU1hbmFnZXIuY29uZmlnLmRlZmF1bHRUeXBlXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV2YWx1YXRvckNhY2hlID0gZXZhbHVhdG9ycy5sZWZ0ICsgc2NyaXB0ICsgZXZhbHVhdG9ycy5yaWdodDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV2YWx1YXRvckNhY2hlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBtYWtlVGVtcGxhdGVTb3VyY2U6IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkgewogICAgICAgICAgICAgICAgLy8gTmFtZWQgdGVtcGxhdGUKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiB0ZW1wbGF0ZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZpbml0aW9uID0gdGVtcGxhdGVNYW5hZ2VyLmdldCh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRocnVzdFRlbXBsYXRlU291cmNlKGRlZmluaXRpb24pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBvbGRFbmdpbmUubWFrZVRlbXBsYXRlU291cmNlLmFwcGx5KG9sZEVuZ2luZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIChrbykuc2V0VGVtcGxhdGVFbmdpbmUobmV3IChrbykuY29udmVudGlvblRlbXBsYXRlRW5naW5lKCkpOwogICAgfTsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIGNvdW50ZG93bjogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICBpbml0S25vY2tvdXRJbnRlZ3JhdGlvbih0aHJ1c3QudGVtcGxhdGUpOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmtub2Nrb3V0RW5naW5lID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWtub2Nrb3V0LmVuZ2luZS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL3RlbXBsYXRlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgVEVNUExBVEVTID0gJ3RlbXBsYXRlcycsIHdoZW4gPSB1dGlsLndoZW4sIGVhY2ggPSBfLmVhY2gsIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksIGZpbmQgPSBfLmZpbmQ7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIFRFTVBMQVRFUwogICAgICAgIF0sCiAgICAgICAgaW5pdDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlcyA9IG1vZC5jb252ZW50aW9uKFRFTVBMQVRFUyksIGludmVydGVkVGVtcGxhdGVzID0gdXRpbC5pbnZlcnQodGVtcGxhdGVzKSwgbW9kdWxlSW5zdGFuY2UgPSBtb2QuaW5zdGFuY2U7CiAgICAgICAgICAgIGlmKHRlbXBsYXRlcykgewogICAgICAgICAgICAgICAgdmFyIGRlZmVycyA9IFtdOwogICAgICAgICAgICAgICAgZWFjaCh0ZW1wbGF0ZXMsIGZ1bmN0aW9uICh0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJzLnB1c2goZmFjYWRlLmZldGNoKHRlbXBsYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmYWNhZGUubG9hZGluZ1Byb21pc2UgPSB3aGVuLmFsbChkZWZlcnMpLnRoZW4oZnVuY3Rpb24gKGxvYWRlZFRlbXBsYXRlcykgewogICAgICAgICAgICAgICAgICAgIC8qanNoaW50IGxvb3BmdW5jOnRydWUgKi8KICAgICAgICAgICAgICAgICAgICBfLmVhY2goaW52ZXJ0ZWRUZW1wbGF0ZXMsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IF8uZmluZChsb2FkZWRUZW1wbGF0ZXMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geC5zaG9ydE5hbWUgPT09IGkgfHwgeC5uYW1lID09PSBpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlSW5zdGFuY2UudGVtcGxhdGVzW2ldID0gdGVtcGxhdGUuY29tcGlsZWQ7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICByZXR1cm4gZmFjYWRlLmxvYWRpbmdQcm9taXNlIHx8IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy50ZW1wbGF0ZSA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD10ZW1wbGF0ZS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9zcGEvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5zcGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LnNwYS5jb25maWcKICAgICoqLwogICAgLyoqCiAgICBSZXNvbHZlcyB0aGUgZ2l2ZW4gcHJvcGVydGllcyB3aGVuIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoZSBwbHVnaW4uCiAgICAKICAgIFRoaXMgaXMgZm9yIGludGVybmFsIHRocnVzdCB1c2UuICBUaHJ1c3QgdXNlcyB0aGlzIGFycmF5IHRvIGdlbmVyYXRlIHRoZSBwcm9wZXJ0aWVzIHRoYXQgbmVlZCB0byBiZSBoYW5kZWQKICAgIHRvIHRoZSBwbHVnaW4gY29uc3RydWN0b3IgbWV0aG9kLgogICAgCiAgICBAZm9yIHRocnVzdC5zcGEuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ2NmZycsIAogICAgICAgICduYW1lJywgCiAgICAgICAgJ21lZGlhdG9yJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L21lZGlhdG9yLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3RhcnQnLCAKICAgICAgICAndGhydXN0L3NwYS9jb252ZW50aW9uL3NwYWxpbmsnCiAgICBdOwogICAgLyoqCiAgICBEZWZpbmVzIHRoZSB2YWx1ZSBvZiBjdXN0b20gcGFyYW1ldGVycy4KICAgIFlvdSBjYW4gYWxzbyBkZWZpbmUgY3VzdG9tIHBhcmFtZXRlcnMgdG8gYmUgYSByZWd1bGFyIGV4cHJlc3Npb24sIGFuZCB0aGVuIHVzZSB0aGVtIGluIHlvdXIgcm91dGVzCiAgICAKICAgIEBwcm9wZXJ0eSBwYXJhbXMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy5wYXJhbXMgPSB7CiAgICB9OwogICAgLyoqCiAgICBUaGUgcHJlZGZpbmVkIHJvdXRlcyB0byBiZSB1c2VkIGJ5IHNwYS4KICAgIAogICAgQHByb3BlcnR5IHJvdXRlcwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7T2JqZWN0fQogICAgKiovCiAgICBleHBvcnRzLnJvdXRlcyA9IHsKICAgIH07CiAgICAvKioKICAgIFRoZSBmaWxlIGV4c3RlbmlvbiB0aGF0IHNob3VsZCBiZSByZW1vdmVkIHdoZW4gcmVzb2x2aW5nIHJvdXRlcyBhbmQgc3RhcnRpbmcgbW9kdWxlcy4KICAgIAogICAgQHByb3BlcnR5IGZpbGVFeHRlbnNpb24KICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgICoqLwogICAgZXhwb3J0cy5maWxlRXh0ZW5zaW9uID0gJy5odG1sJzsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYS9jb252ZW50aW9uL3NwYWxpbmsnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJ3RocnVzdC9kb20vc3VianF1ZXJ5J10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19zdWJqcXVlcnlfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3NwYS9zcGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgc3VianF1ZXJ5ID0gX19zdWJqcXVlcnlfXzsKCiAgICB2YXIgJCA9IHN1YmpxdWVyeS50UXVlcnk7CiAgICB2YXIgcGFyc2VGdWxsSHJlZiA9IGZ1bmN0aW9uIChocmVmKSB7CiAgICAgICAgdmFyIGJhc2VVcmwgPSBsb2NhdGlvbi5wYXRobmFtZS5zdWJzdHJpbmcoMCwgbG9jYXRpb24ucGF0aG5hbWUubGFzdEluZGV4T2YoJy8nKSk7CiAgICAgICAgaWYoaHJlZi5pbmRleE9mKCcvJykgIT0gLTEpIHsKICAgICAgICAgICAgaHJlZiA9IGhyZWYuc3Vic3RyaW5nKGhyZWYubGFzdEluZGV4T2YoJy8nKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHJlZiA9ICcvJyArIGhyZWY7CiAgICAgICAgfQogICAgICAgIHJldHVybiBiYXNlVXJsICsgaHJlZjsKICAgIH07CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LmRvbQogICAgQHN1Ym1vZHVsZSB0aHJ1c3QuZG9tLmNvbnZlbnRpb24KICAgICoqLwogICAgLyoqCiAgICAqICMgX190aHJ1c3QvZG9tX18gQ29udmVudGlvbiAtIFNpbmdsZSBQYWdlIEFwcCBMaW5rCiAgICAqCiAgICAqIFJlcXVpcmVzIHRocnVzdC9kb20KICAgICoKICAgICogQGZvciB0aHJ1c3QuZG9tLmNvbnZlbnRpb24KICAgICogQHByb3BlcnR5IHNwYTtpbmsKICAgICoqLwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIGNvbmZpZyA9IHRocnVzdC5jb25maWcsIHNwYSA9IHRocnVzdC5zcGE7CiAgICAgICAgICAgICQub24oJ2NsaWNrJywgJ2EnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgdmFyIGxpbmsgPSBwYXJzZUZ1bGxIcmVmKHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJykpOwogICAgICAgICAgICAgICAgaWYobGluay5pbmRleE9mKGNvbmZpZy51cmwucGF0aCkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBzcGEubmF2aWdhdGUobGluayk7CiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5zcGFsaW5rID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXNwYWxpbmsuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3RhcnQnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9zcGEvc3BhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RlbXBsYXRlL3RlbXBsYXRlLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5zcGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LnNwYS5jb252ZW50aW9uCiAgICAqKi8KICAgIC8qKgogICAgKiAjIF9fdGhydXN0L3NwYV9fIENvbnZlbnRpb24gLSBTdGFydAogICAgKgogICAgKiBUaGUgc2luZ2xlIHBhZ2UgYXBwIHN0YXJ0IGNvbnZlbnRpb24sIGRvZXMgdGhlIGFjdHVhbCBzdGFydGluZyBvZiB0aGUgcGx1Z2luLCBpbiBhZGRpdGlvbiBpdCBhbHNvIGRlbGF5cwogICAgKiBmdWxsIG9yYml0LCB1bnRpbCBhbnkgbW9kdWxlIGl0IGhhcyBzdGFydGVkIGhhcyBiZWVuIGxvYWRlZC4KICAgICoKICAgICogQGZvciB0aHJ1c3Quc3BhLmNvbnZlbnRpb24KICAgICogQHByb3BlcnR5IHN0YXJ0CiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gewogICAgICAgIG9yYml0OiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciByb3V0ZXIgPSB0aHJ1c3Quc3BhOwogICAgICAgICAgICByb3V0ZXIuc3RhcnQoKTsKICAgICAgICAgICAgcmV0dXJuIHRocnVzdC5zcGEuc3RhcnRpbmdNb2R1bGVQcm9taXNlIHx8IG51bGw7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuc3RhcnQgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9c3RhcnQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICd0aHJ1c3QvZXZlbnRzJywgJ3RocnVzdC9mYWNhZGUnLCAnaGFzJywgJ3RocnVzdC9jb25maWcnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fbG9nX18sIF9fZXZlbnRzX18sIF9fZmFjYWRlX18sIF9faGFzX18sIF9fY29uZmlnX18sIF9fbWVkaWF0b3JDb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaGFzLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIC8vaW1wb3J0IGV2ZW50cyA9IG1vZHVsZSgndGhydXN0L2V2ZW50cycpOwogICAgdmFyIGV2ZW50cyA9IF9fZXZlbnRzX187CgogICAgdmFyIEV2ZW50cyA9IGV2ZW50cy5FdmVudHM7CiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICB2YXIgbWVkaWF0b3JDb25maWcgPSBfX21lZGlhdG9yQ29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnTWVkaWF0b3InOwogICAgLy8gVmFyaWFibGUgZGVjbGFyYXRpb24uCiAgICAgICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBleHRlbmQgPSAvLyBzdHJpbmcgZm9ybWF0IG1ldGhvZAogICAgXy5leHRlbmQsIHdoZW4gPSAvLyBvYmplY3QgZXh0ZW5zaW9uIG1ldGhvZAogICAgdXRpbC53aGVuLCBtZW1vaXplID0gXy5tZW1vaXplLCBtZWRpYXRvciwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgICB2YXIgYyA9IGNvbmZpZzsKICAgIC8vI3JlZ2lvbiBGYWNhZGUKICAgIC8qKgogICAgQ3JlYXRlcyBhIG5ldyBtZWRpYXRvciBmYWNhZGUgZm9yIHRoZSBnaXZlbiBtb2R1bGUuCiAgICAKICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yCiAgICBAY2xhc3MgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICBAcGFyYW0ge3RocnVzdC5NZWRpYXRvcn0gcGFyZW50IFRoZSBwYXJlbnQgbWVkaWF0b3IgdG8gY3JlYXRlIHRoZSBmYWNhZGUgb24uCiAgICAqKi8KICAgIHZhciBNZWRpYXRvckZhY2FkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG1lZGlhdG9yRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kdWxlLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbW9kdWxlLm5hbWU7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IHBhcmVudC5fY2FsbGJhY2tzOwogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMobW9kdWxlKTsKICAgICAgICB9KTsKICAgICAgICBfLmV4dGVuZChtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUsIEV2ZW50cyk7CiAgICAgICAgLyoqCiAgICAgICAgRHVyaW5nIHRoZSBzdGFydCBvZiBhIG1lZGlhdG9yIGZhY2FkZSwgc3RhcnQgY3JlYXRlcyB0aGUgaW50ZXJuYWwgc3Vic2NyaXB0aW9ucyBhcnJheS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5tZWRpYXRvci5NZWRpYXRvckZhY2FkZQogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAqKi8KICAgICAgICBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgbWVkaWF0b3JGYWNhZGUucHJvdG90eXBlLnN0YXJ0ID0gbWVkaWF0b3JGYWNhZGUucHJvdG90eXBlLmluaXQ7CiAgICAgICAgLyoqCiAgICAgICAgT3ZlcnJpZGVzIHRoZSBzdWJzY3JpYmUgbWV0aG9kLCBhbmQgdHJhY2tzIHRoZSBhbnkgZXZlbnQgdGhhdCBpcyBib3VuZC4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5tZWRpYXRvci5NZWRpYXRvckZhY2FkZQogICAgICAgIEBtZXRob2Qgc3Vic2NyaWJlCiAgICAgICAgKiovCiAgICAgICAgKG1lZGlhdG9yRmFjYWRlKS5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnRzOiBldmVudHMsCiAgICAgICAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBFdmVudHMuc3Vic2NyaWJlLmNhbGwodGhpcywgZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgfTsKICAgICAgICAvKioKICAgICAgICBVbnN1YnNjcmliZXMgZnJvbSBhbGwgZXZlbnRzIHRoYXQgd2VyZSBzdWJzY3JpYmVkIHRvLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICAgICAgQG1ldGhvZCBzdG9wCiAgICAgICAgKiovCiAgICAgICAgbWVkaWF0b3JGYWNhZGUucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICBpZih0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMpIHsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdWIgPSB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnNbaV07CiAgICAgICAgICAgICAgICAgICAgdGhpcy51bnN1YnNjcmliZShzdWIuZXZlbnRzLCBzdWIuY2FsbGJhY2ssIHN1Yi5jb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbWVkaWF0b3JGYWNhZGU7CiAgICB9KSgpOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyBPdXIgZGVmYXVsdCBuYW1lc3BhY2UgcHJlZml4LgogICAgLyoqCiAgICBNZWRpYXRvciBjbGFzcy4KICAgIFRoaXMgY3JlYXRlcyBhIGluc3RhbmNlIG9mIHRoZSBtZWRpYXRvciwgZm9yIHVzZSBpbnNpZGUgdGhydXN0LgogICAgCiAgICBAZm9yIHRocnVzdC5tZWRpYXRvcgogICAgQGNsYXNzIHRocnVzdC5tZWRpYXRvci5NZWRpYXRvcgogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbWVkaWF0b3IuCiAgICAqKi8KICAgIHZhciBNZWRpYXRvciA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8jZW5kcmVnaW9uCiAgICAgICAgZnVuY3Rpb24gTWVkaWF0b3IobmFtZSwgY29uZmlnKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgYXBwUGF0aCA9IGNvbmZpZyAmJiBjb25maWcudXJsICYmIGNvbmZpZy51cmwucGF0aDsKICAgICAgICAgICAgdGhhdC5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdNZWRpYXRvcjogQ3JlYXRpbmcgbmV3IE1lZGlhdG9yIHswfScsIG5hbWUpKTsKICAgICAgICAgICAgdGhhdC5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoYXQuc3Vic2NyaWJlKCd0aHJ1c3QvcmVhZHknLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKCdNZWRpYXRvcjogUmVhZHkhJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZihmYWNhZGVzLm1lZGlhdG9yICYmICEoZmFjYWRlcy5tZWRpYXRvciBpbnN0YW5jZW9mIE1lZGlhdG9yRmFjYWRlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCcibWVkaWF0b3IiIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWVkaWF0b3I7CiAgICAgICAgICAgIGlmKGZhY2FkZXMubWVkaWF0b3IpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IudXBkYXRlRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgICAgICBtZWRpYXRvciA9IGZhY2FkZXMubWVkaWF0b3I7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZWRpYXRvciA9IGZhY2FkZXMubWVkaWF0b3IgPSAobW9kKS5tZWRpYXRvciA9IG5ldyBNZWRpYXRvckZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtZWRpYXRvcjsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLmNvbmZpZyA9IG1lZGlhdG9yQ29uZmlnOwogICAgICAgIHJldHVybiBNZWRpYXRvcjsKICAgIH0pKCk7CiAgICBleHBvcnRzLk1lZGlhdG9yID0gTWVkaWF0b3I7ICAgIAogICAgLy8gR2V0IHRoZSBhY3R1YWwgZXZlbnQgbWV0aG9kcyBvbnRvIHRoZSBNZWRpYXRvcgogICAgXy5leHRlbmQoTWVkaWF0b3IucHJvdG90eXBlLCBFdmVudHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21lZGlhdG9yJywgWyd0aHJ1c3QvbWVkaWF0b3IvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9kYXRhL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJ2pxdWVyeScsICd0aHJ1c3QvbG9nJywgJy4vY29uZmlnJywgJ3RocnVzdC9jb25maWcnLCAnLi9ldmVudC5mYWN0b3J5JywgJy4vcmVzcG9uc2UucXVldWUnLCAndGhydXN0L2V2ZW50cycsICd0aHJ1c3QvZmFjYWRlJywgJy4vZXZlbnQudHlwZXMnLCAnaGFzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19qUXVlcnlfXywgX19sb2dfXywgX19jb25maWdfXywgX190Q29uZmlnX18sIF9fZXZlbnRGYWN0b3J5X18sIF9fcmVzcG9uc2VRdWV1ZV9fLCBfX2V2ZW50c19fLCBfX2ZhY2FkZV9fLCBfX2V2ZW50VHlwZXNfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2pxdWVyeS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGpRdWVyeSA9IF9falF1ZXJ5X187CgogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgZXZlbnRGYWN0b3J5ID0gX19ldmVudEZhY3RvcnlfXzsKCiAgICB2YXIgcmVzcG9uc2VRdWV1ZSA9IF9fcmVzcG9uc2VRdWV1ZV9fOwoKICAgIHZhciBSZXNwb25zZVF1ZXVlID0gcmVzcG9uc2VRdWV1ZS5SZXNwb25zZVF1ZXVlOwogICAgdmFyIGV2ZW50cyA9IF9fZXZlbnRzX187CgogICAgdmFyIEV2ZW50cyA9IGV2ZW50cy5FdmVudHM7CiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ0RhdGEnOwogICAgY29uZmlnOwogICAgLy8gVmFyaWFibGUgZGVjbGFyYXRpb24uCiAgICAgICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIGFqYXggPSBqUXVlcnkuYWpheCwgdWlkID0gXy51bmlxdWVJZCwgZGF0YUV2ZW50V2FpdCA9IGV2ZW50VHlwZXNbJ3dhaXQnXSwgZGF0YUV2ZW50U3RhcnQgPSBldmVudFR5cGVzWydzdGFydCddLCBkYXRhRXZlbnRTdG9wID0gZXZlbnRUeXBlc1snc3RvcCddLCBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzWydzdGF0dXMnXSwgYXJndW1lbnRSZXNvbHZlciA9IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gbWV0aG9kKF8udG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgICB9OwogICAgfTsKICAgIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWwgPSAhIXRDb25maWcudXJsLnRyYWRpdGlvbmFsRW5jb2Rpbmc7CiAgICB2YXIgakRvYyA9IGpRdWVyeShkb2N1bWVudCk7CiAgICBldmVudEZhY3RvcnkuaW5pdChqRG9jKTsKICAgIC8vI3JlZ2lvbiBEYXRhRmFjYWRlCiAgICAvKioKICAgIFRoZSBkYXRhIGZhY2FkZSB0aGF0IGlzIGhhbmRlZCBvZmYgdG8gbW9kdWxlcy4KICAgIAogICAgCiAgICBFbmFibGVzIGRhdGEgdHJhbnNwb3J0LCB1c2luZyBqUXVlcnkgZm9yIHRocnVzdC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgQGNsYXNzIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICBAcGFyYW0ge3RocnVzdC5kYXRhLkRhdGF9IHBhcmVudCBUaGUgcGFyZW50IHRocnVzdCBkYXRhIG9iamVjdCB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IuCiAgICBAY29uc3RydWN0b3IKICAgICoqLwogICAgdmFyIERhdGFGYWNhZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBkYXRhRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kdWxlLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbW9kdWxlLm5hbWUgKyAnLWRhdGEnOwogICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSBwYXJlbnQuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5yZXNwb25zZVF1ZXVlID0gcGFyZW50LnJlc3BvbnNlUXVldWU7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgICAgICB0aGlzLmRlZmF1bHRzID0gcGFyZW50LmRlZmF1bHRzOwogICAgICAgICAgICB0aGlzLmFwcFBhdGggPSBwYXJlbnQuYXBwUGF0aDsKICAgICAgICB9KTsKICAgICAgICBfLmV4dGVuZChkYXRhRmFjYWRlLnByb3RvdHlwZSwgZXZlbnRzKTsKICAgICAgICByZXR1cm4gZGF0YUZhY2FkZTsKICAgIH0pKCk7CiAgICAvLyNlbmRyZWdpb24KICAgIC8qKgogICAgVGhlIG1hc3RlciBkYXRhIHBsdWdpbi4KICAgIAogICAgCiAgICBFbmFibGVzIGRhdGEgdHJhbnNwb3J0LCB1c2luZyBqUXVlcnkgZm9yIHRocnVzdC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgQGNsYXNzIHRocnVzdC5kYXRhLkRhdGEKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZS4KICAgIEBwYXJhbSB7dGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yfSBtZWRpYXRvciBUaGUgdGhydXN0IG1lZGlhdG9yIGluc3RhbmNlLgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGluc3RhbmNlIGNvbmZpZ3VyYXRpb24uCiAgICBAY29uc3RydWN0b3IKICAgICoqLwogICAgdmFyIERhdGEgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vI2VuZHJlZ2lvbgogICAgICAgIGZ1bmN0aW9uIERhdGEobmFtZSwgbWVkaWF0b3IsIGNvbmZpZykgewogICAgICAgICAgICBpZighbmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEYXRhOiBtb2R1bGUgbmFtZSBtdXN0IGJlIGRlZmluZWQuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy5yZXNwb25zZVF1ZXVlID0gbmV3IFJlc3BvbnNlUXVldWUodGhpcywgY29uZmlnLmRhdGEuc3RhcnRUaW1lb3V0LCBjb25maWcuZGF0YS5maW5pc2hUaW1lb3V0KTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoJ0RhdGE6IENyZWF0aW5nIG5ldyBEYXRhJyk7CiAgICAgICAgICAgIHRoaXMubWVkaWF0b3IgPSBtZWRpYXRvcjsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gKHRoaXMpLm1lZGlhdG9yLl9jYWxsYmFja3M7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgICAgICB0aGlzLmRlZmF1bHRzID0gewogICAgICAgICAgICAgICAgY2FjaGU6IGNvbmZpZy5kYXRhLmNhY2hlLAogICAgICAgICAgICAgICAgYmVmb3JlU2VuZDogZXZlbnRGYWN0b3J5LmJlZm9yZVNlbmRNZXRob2QsCiAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAgdHlwZTogJ1BPU1QnLAogICAgICAgICAgICAgICAgdXJsOiAnJywKICAgICAgICAgICAgICAgIGRhdGE6ICcnLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJywKICAgICAgICAgICAgICAgIF9fbWVkaWF0b3JfZGF0YV9maXJlZF9fOiB0cnVlLAogICAgICAgICAgICAgICAgc2lsZW50OiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmFwcFBhdGggPSBjb25maWcudXJsLnBhdGggKyAnLyc7CiAgICAgICAgfQogICAgICAgIERhdGEucHJvdG90eXBlLmluaXRFdmVudHMgPSAvLyNyZWdpb24gRXZlbnRzCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIG9uY2UpIHsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIERhdGFGYWNhZGUgZm9yIHRoZSBnaXZlbiBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBjcmVhdGVGYWNhZGUKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICBAcGFyYW0ge01vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgYXZhaWxhYmxlIGZhY2FkZXMKICAgICAgICBAcmV0dXJucyB7RGF0YUZhY2FkZX0gVGhlIG5ldyBEYXRhRmFjYWRlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIGlmKG1vZC5kYXRhICYmICEoZmFjYWRlcy5kYXRhIGluc3RhbmNlb2YgRGF0YUZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignImRhdGEiIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGF0YTsKICAgICAgICAgICAgaWYoZmFjYWRlcy5kYXRhKSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLmRhdGEudXBkYXRlRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgICAgICBkYXRhID0gZmFjYWRlcy5kYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGF0YSA9IGZhY2FkZXMuZGF0YSA9IG1vZC5kYXRhID0gbmV3IERhdGFGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmdldERhdGEgPSAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIGZvciB0aGUgZ2l2ZW4gZGF0YSBhbmQgc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBnZXREYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhIEdFVCB0byB0aGUgc2VydmVyLCBmb3IgdGhlIGdpdmVuIGRhdGEgYW5kIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgZ2V0RGF0YQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgdG8gcGFzcyB0byB0aGUgZ2l2ZW4gdXJsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh1cmwsIGRhdGEsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIHNldHRpbmdzID0gIXNldHRpbmdzID8gewogICAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9IDogZXh0ZW5kKHNldHRpbmdzLCB7CiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQodXJsLCBzZXR0aW5ncyk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5wb3N0RGF0YSA9IC8qKgogICAgICAgIERvZXMgYSBQT1NUIHRvIHRoZSBzZXJ2ZXIsIGZvciB0aGUgZ2l2ZW4gZGF0YSBhbmQgc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBwb3N0RGF0YQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgdG8gcGFzcyB0byB0aGUgZ2l2ZW4gdXJsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYSBQT1NUIHRvIHRoZSBzZXJ2ZXIsIGZvciB0aGUgZ2l2ZW4gZGF0YSBhbmQgc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBwb3N0RGF0YQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgdG8gcGFzcyB0byB0aGUgZ2l2ZW4gdXJsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh1cmwsIGRhdGEsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIHNldHRpbmdzID0gIXNldHRpbmdzID8gewogICAgICAgICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoZGF0YSkKICAgICAgICAgICAgfSA6IGV4dGVuZChzZXR0aW5ncywgewogICAgICAgICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoZGF0YSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvc3QodXJsLCBzZXR0aW5ncyk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5nZXQgPSAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBnZXREYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhIEdFVCB0byB0aGUgc2VydmVyLCB1c2luZyB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgRGF0YSBtdXN0IGJlIHBhc3NlZCBpbiB1c2luZyBzZXR0aW5nczogeyBkYXRhOiB7fSB9IG90aGVyd2lzZSB1c2UgZ2V0RGF0YS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh1cmwsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIGlmKHNldHRpbmdzID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLnVybCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdXJsIGlzIGRlZmluZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgZXh0ZW5kKHNldHRpbmdzIHx8IHsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgdHlwZTogJ2dldCcKICAgICAgICAgICAgfSkpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUucG9zdCA9IC8qKgogICAgICAgIERvZXMgYSBQT1NUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBwb3N0RGF0YS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIHBvc3QKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgUE9TVCB0byB0aGUgc2VydmVyLCB1c2luZyB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgRGF0YSBtdXN0IGJlIHBhc3NlZCBpbiB1c2luZyBzZXR0aW5nczogeyBkYXRhOiB7fSB9IG90aGVyd2lzZSB1c2UgcG9zdERhdGEuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBwb3N0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgaWYoc2V0dGluZ3MgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdXJsID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB1cmw7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodXJsID09PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MudXJsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyB1cmwgaXMgZGVmaW5lZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCBleHRlbmQoc2V0dGluZ3MgfHwgewogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICB0eXBlOiAncG9zdCcKICAgICAgICAgICAgfSkpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuYWpheCA9IC8qKgogICAgICAgIERvZXMgYW4gYWpheCBjYWxsIHRvIHRoZSBnaXZlbiB1cmwsIHdpdGggdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgYWpheAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYW4gYWpheCBjYWxsIHRvIHRoZSBnaXZlbiB1cmwsIHdpdGggdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgYWpheAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh1cmwsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgb3B0aW9ucywgdHlwZSwgYmVmb3JlU2VuZDsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ0RhdGFbezB9XTogRmV0Y2hpbmcgZGF0YSBmcm9tICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHVybCkpOwogICAgICAgICAgICBpZihzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVybCA9IHV0aWwuZml4dXBVcmwodXJsLCB0aGF0LmFwcFBhdGgpOwogICAgICAgICAgICBpZihzZXR0aW5ncy5zaWxlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBkZm8gPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgcXVlcnlJZCA9IHVpZCgnZHEnKTsKICAgICAgICAgICAgICAgIHR5cGUgPSBzZXR0aW5ncy50eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgICAgICAgIH0sIHRoYXQuZGVmYXVsdHMsIHsKICAgICAgICAgICAgICAgICAgICBiZWZvcmVTZW5kOiB1dGlsLm5vb3AKICAgICAgICAgICAgICAgIH0sIHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIGFqYXgodXJsLCBvcHRpb25zKS50aGVuKGFyZ3VtZW50UmVzb2x2ZXIoZGZvLnJlc29sdmUpLCBhcmd1bWVudFJlc29sdmVyKGRmby5yZWplY3QpKTsKICAgICAgICAgICAgICAgIHJldHVybiBkZm8ucHJvbWlzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgICAgfSwgdGhhdC5kZWZhdWx0cywgc2V0dGluZ3MsIHsKICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IGV2ZW50RmFjdG9yeS5iZWZvcmVTZW5kTWV0aG9kCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0eXBlID0gb3B0aW9ucy50eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3BvbnNlUXVldWUuYWRkVG9RdWV1ZSh0eXBlLCB1cmwsIG9wdGlvbnMpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5jb25maWcgPSBjb25maWc7CiAgICAgICAgcmV0dXJuIERhdGE7CiAgICB9KSgpOwogICAgZXhwb3J0cy5EYXRhID0gRGF0YTsgICAgCiAgICBfLmV4dGVuZChEYXRhLnByb3RvdHlwZSwgRXZlbnRzKTsKICAgIF8uZXh0ZW5kKERhdGFGYWNhZGUucHJvdG90eXBlLCBEYXRhLnByb3RvdHlwZSk7CiAgICAvLyBUYWtlIGEgaG9sZCBvZiBqUXVlcnkuLi4gdGhpcyBpcyBzdXJlIHRvIGJlIGNvbnRyYXZlc2lhbAogICAgalF1ZXJ5LmFqYXggPSAoRGF0YSkucHJvdG90eXBlLmFqYXg7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YScsIFsndGhydXN0L2RhdGEvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9kb20vbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnLi9zdWJqcXVlcnknLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICd0aHJ1c3QvZmFjYWRlJywgJ2hhcycsICd0aHJ1c3QvaW5zdGFuY2UnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19zdWJqcXVlcnlfXywgX191dGlsX18sIF9fbG9nX18sIF9fZmFjYWRlX18sIF9faGFzX18sIF9faW5zdGFuY2VfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyIHRRdWVyeSA9IHN1YmpxdWVyeS50UXVlcnk7CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGZhY2FkZSA9IF9fZmFjYWRlX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGluc3RhbmNlID0gX19pbnN0YW5jZV9fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ0RvbSc7CiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IF8uZXh0ZW5kLCBiaW5kID0gXy5iaW5kLCBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LCBpc09iamVjdCA9IF8uaXNPYmplY3QsIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCB3aGVuID0gdXRpbC53aGVuLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgLy8jcmVnaW9uIERvbUZhY2FkZQogICAgdmFyIERvbUZhY2FkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRvbUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZCwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IHBhcmVudC5uYW1lOwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gdFF1ZXJ5KGRvY3VtZW50LCB1bmRlZmluZWQsIHRoaXMubmFtZSk7CiAgICAgICAgfSk7CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKGZha2UpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMgPSB0aGlzLl9pbnRlcm5hbEV2ZW50cyB8fCBbXTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogSW5pdGFsaXppbmcgezF9RG9tIGZhY2FkZScsIHRoaXMubmFtZSwgZmFrZSA/ICdmYWtlICcgOiAnJykpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIGRvbUZhY2FkZS5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBTdGFydGluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogU3RvcHBpbmcgRG9tIGZhY2FkZScsIHRoaXMubmFtZSkpOwogICAgICAgICAgICBmb3IodmFyIGkgPSB0aGlzLl9pbnRlcm5hbEV2ZW50cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX2ludGVybmFsRXZlbnRzW2ldOwogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgc3ViLmNvbnRleHQub2ZmLmFwcGx5KHRoaXMsIChpc0FycmF5KHN1YikpID8gc3ViIDogKGlzQXJyYXkoc3ViLmFyZ3MpKSA/IHN1Yi5hcmdzIDogW10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogRGVzdHJveWluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lKSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbnRlcm5hbEV2ZW50czsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZG9tRmFjYWRlOwogICAgfSkoKTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIERvbQogICAgdmFyIERvbSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8jZW5kcmVnaW9uCiAgICAgICAgZnVuY3Rpb24gRG9tKG5hbWUsIG1lZGlhdG9yKSB7CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbTogbW9kdWxlIG5hbWUgbXVzdCBiZSBkZWZpbmVkLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKCdEYXRhOiBDcmVhdGluZyBuZXcgRGF0YScpOwogICAgICAgICAgICB0aGlzLm1lZGlhdG9yID0gbWVkaWF0b3I7CiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IChtZWRpYXRvcikuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShuYW1lKS5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICAgICAgdmFyIG1vZCA9IHsKICAgICAgICAgICAgICAgIH0sIGZhY2FkZSA9IHRoYXQuY3JlYXRlRmFjYWRlKHRocnVzdCwgbW9kLCB7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBEb20ucHJvdG90eXBlLmluaXRFdmVudHMgPSAvLyNyZWdpb24gRXZlbnRzCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIH07CiAgICAgICAgRG9tLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbiAodG8sIGluaXQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBEb20ucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgfTsKICAgICAgICBEb20ucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBEb20uY29uZmlnID0gY29uZmlnOwogICAgICAgIERvbS5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIGlmKGZhY2FkZXMuZG9tICYmICEoZmFjYWRlcy5kb20gaW5zdGFuY2VvZiBEb21GYWNhZGUpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyJkb20iIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZG9tOwogICAgICAgICAgICBpZihmYWNhZGVzLmRvbSkgewogICAgICAgICAgICAgICAgZmFjYWRlcy5kb20udXBkYXRlRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgICAgICBkb20gPSBmYWNhZGVzLmRvbTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRvbSA9IGZhY2FkZXMuZG9tID0gbmV3IERvbUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkb207CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gRG9tOwogICAgfSkoKTsKICAgIGV4cG9ydHMuRG9tID0gRG9tOyAgICAKICAgIC8vI2VuZHJlZ2lvbgogICAgfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20nLCBbJ3RocnVzdC9kb20vbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICdkb21SZWFkeScsICd0aHJ1c3QvZmFjYWRlJywgJy4vY29uZmlnJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX2RvbVJlYWR5X18sIF9fZmFjYWRlX18sIF9fY29uZmlnX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RlbXBsYXRlL3RlbXBsYXRlLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIAogICAgCiAgICB2YXIgZG9tUmVhZHkgPSBfX2RvbVJlYWR5X187CgogICAgdmFyIGZhY2FkZSA9IF9fZmFjYWRlX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnVGVtcGxhdGUnOwogICAgY29uZmlnOwogICAgdmFyIExPTkcgPSAnbG9uZycsIFNIT1JUID0gJ3Nob3J0JywgSUQgPSAnaWQnLCBkZWVwQ29weSA9IF8ubWVyZ2UsIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBlYWNoID0gXy5lYWNoLCBiaW5kID0gXy5iaW5kLCB3aGVuID0gdXRpbC53aGVuLCByZWR1Y2UgPSBfLnJlZHVjZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZSwgbWFwID0gXy5tYXAsIGV4dGVuZCA9IF8uZXh0ZW5kLCBnZXRMb25nTmFtZSA9IGZ1bmN0aW9uIChuYW1lLCB0eXBlKSB7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCByZXN1bHQgPSAodGhhdC5zaG9ydE5hbWUobmFtZSkgKyAnLicgKyAodHlwZSB8fCB0aGF0LmNvbmZpZy5kZWZhdWx0VHlwZSkgKyB0aGF0LmNvbmZpZy5leHRlbnNpb24pLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sIGdldFNob3J0TmFtZSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCByZXN1bHQgPSByZWR1Y2UodGhhdC50ZW1wbGF0ZVR5cGVzLCBmdW5jdGlvbiAobWVtbywgeCkgewogICAgICAgICAgICByZXR1cm4gbWVtby5yZXBsYWNlKCcuJyArIHgudG9Mb3dlckNhc2UoKSArIHRoYXQuY29uZmlnLmV4dGVuc2lvbiwgJycpOwogICAgICAgIH0sIG5hbWUudG9Mb3dlckNhc2UoKSkudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwgZ2V0VGVtcGxhdGVJZCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCByZXN1bHQgPSB0aGF0LnNob3J0TmFtZShuYW1lKS5yZXBsYWNlKC9cLy9nLCAnLScpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC50ZW1wbGF0ZQogICAgQHJlcXVpcmVzIHRocnVzdC5kYXRhCiAgICAqKi8KICAgIC8qKgogICAgVGhlIHRlbXBsYXRlIHBsdWdpbiBjb25zdHVyY3Rvci4KICAgIAogICAgQGZvciB0aHJ1c3QudGVtcGxhdGUKICAgIEBjbGFzcyB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRocnVzdCBjb25maWcgb2JqZWN0CiAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgdGhydXN0IGRhdGEgaW5zdGFuY2UKICAgIEB1c2VzIHRocnVzdC5kYXRhLkRhdGEKICAgIEBjb25zdHJ1Y3RvcgogICAgKiovCiAgICB2YXIgVGVtcGxhdGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFRlbXBsYXRlKGNvbmZpZywgZGF0YSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRlbXBsYXRlQ29uZmlnID0gdGhpcy5jb25maWcgPSBjb25maWcudGVtcGxhdGU7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVUeXBlcyA9IG1hcCh0ZW1wbGF0ZUNvbmZpZy50eXBlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZXMgPSB7CiAgICAgICAgICAgICAgICBsb25nOiB7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2hvcnQ6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpZDogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGF0LmxvbmdOYW1lID0gbWVtb2l6ZShiaW5kKGdldExvbmdOYW1lLCB0aGF0KSk7CiAgICAgICAgICAgIHRoYXQuc2hvcnROYW1lID0gbWVtb2l6ZShiaW5kKGdldFNob3J0TmFtZSwgdGhhdCkpOwogICAgICAgICAgICB0aGF0LnRlbXBsYXRlSWQgPSBtZW1vaXplKGJpbmQoZ2V0VGVtcGxhdGVJZCwgdGhhdCkpOwogICAgICAgICAgICB0aGF0LmVuZ2luZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoYXQuZGF0YSA9IGRhdGE7CiAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgKHRlbXBsYXRlQ29uZmlnLnRlbXBsYXRlUGF0aHNbdGVtcGxhdGVDb25maWcuZGVmYXVsdFR5cGVdIHx8ICd0aHJ1c3QvdGVtcGxhdGUvJyArIHRlbXBsYXRlQ29uZmlnLmRlZmF1bHRUeXBlKQogICAgICAgICAgICBdLCBmdW5jdGlvbiAoZW5naW5lKSB7CiAgICAgICAgICAgICAgICB0aGF0LmVuZ2luZXNbdGVtcGxhdGVDb25maWcuZGVmYXVsdFR5cGVdID0gZW5naW5lOwogICAgICAgICAgICAgICAgZG9tUmVhZHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIChfKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKSkpLmZpbHRlcihmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gISF4LmdldEF0dHJpYnV0ZSgnZGF0YS10ZW1wbGF0ZScpOwogICAgICAgICAgICAgICAgICAgIH0pLmVhY2goYmluZCh0aGF0LmNyZWF0ZUZyb21Eb21Ob2RlLCB0aGF0KSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5nZXQgPSAvKioKICAgICAgICBHZXRzIGEgdGVtcGxhdGUgZnJvbSB0aGUgY2FjaGUgaWYgaXQgaGFzIGJlZW4gZmV0Y2hlZC4gRmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBnZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZSB0byB0cnkgYW5kIGdldC4KICAgICAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSB0ZW1wbGF0ZSBvYmplY3QKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBHZXRzIGEgdGVtcGxhdGUgZnJvbSB0aGUgY2FjaGUgaWYgaXQgaGFzIGJlZW4gZmV0Y2hlZC4gRmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlRmFjYWRlCiAgICAgICAgQG1ldGhvZCBnZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZSB0byB0cnkgYW5kIGdldC4KICAgICAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSB0ZW1wbGF0ZSBvYmplY3QKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBudWxsLCB0aGF0ID0gdGhpcywgdGVtcGxhdGVzID0gdGhhdC50ZW1wbGF0ZXM7CiAgICAgICAgICAgIGlmKHRlbXBsYXRlID0gdGVtcGxhdGVzLmxvbmdbdGhhdC5sb25nTmFtZShuYW1lKV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgICAgICAgfSBlbHNlIGlmKHRlbXBsYXRlID0gdGVtcGxhdGVzLnNob3J0W3RoYXQuc2hvcnROYW1lKG5hbWUpXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICB9IGVsc2UgaWYodGVtcGxhdGUgPSB0ZW1wbGF0ZXMuaWRbdGhhdC50ZW1wbGF0ZUlkKG5hbWUpXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLnNldCA9IC8qKgogICAgICAgIFNldHMgYSB0ZW1wbGF0ZSB0byB0aGUgY2FjaGUsIHdpdGggdGhlIGdpdmVuIGluZm9ybWF0aW9uCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIHNldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHRlbXBsYXRlIGVuZ2luZSB0eXBlCiAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY29tcGlsZWRUZW1wbGF0ZSBUaGUgY29tcGlsZWQgdGVtcGxhdGUgbWV0aG9kCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGh0bWwgVGhlIHRlbXBsYXRlIEhUTUwuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIHR5cGUsIGNvbXBpbGVkVGVtcGxhdGUsIGh0bWwpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBzaG9ydE5hbWUgPSB0aGF0LnNob3J0TmFtZShuYW1lKSwgdGVtcGxhdGVJZCA9IHRoYXQudGVtcGxhdGVJZChuYW1lKSwgbG9uZ05hbWUgPSB0aGF0LmxvbmdOYW1lKG5hbWUsIHR5cGUpLCB0ZW1wbGF0ZXMgPSB0aGF0LnRlbXBsYXRlczsKICAgICAgICAgICAgdGVtcGxhdGVzLmxvbmdbbG9uZ05hbWVdID0gdGVtcGxhdGVzLnNob3J0W3Nob3J0TmFtZV0gPSB0ZW1wbGF0ZXMuaWRbdGVtcGxhdGVJZF0gPSB7CiAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgc2hvcnROYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgaWQ6IHRlbXBsYXRlSWQsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgaHRtbDogaHRtbCwKICAgICAgICAgICAgICAgIGNvbXBpbGVkOiBjb21waWxlZFRlbXBsYXRlCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuaGFzID0gLyoqCiAgICAgICAgQ2hlY2tzIGlmIHRoZSB0ZW1wbGF0ZSBleGlzdHMgaW4gdGhlIGNhY2hlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBoYXMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEByZXR1cm5zIHtCb29sZWFufSBXZXRoZXIgdGhlIHRlbXBsYXRlIGV4aXN0cyBvciBub3QuCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgQ2hlY2tzIGlmIHRoZSB0ZW1wbGF0ZSBleGlzdHMgaW4gdGhlIGNhY2hlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlRmFjYWRlCiAgICAgICAgQG1ldGhvZCBoYXMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEByZXR1cm5zIHtCb29sZWFufSBXZXRoZXIgdGhlIHRlbXBsYXRlIGV4aXN0cyBvciBub3QuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gISF0aGF0LmdldChuYW1lKTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5uZXdUZW1wbGF0ZSA9IC8qKgogICAgICAgIENyZWF0ZXMgYSBuZXcgdGVtcGxhdGUgZ2l2ZW4gdGhlIGluZm9ybWF0aW9uCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIG5ld1RlbXBsYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdGVtcGxhdGUgZW5naW5lIHR5cGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaHRtbCBUaGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICBAcGFyYW0ge1N0cmluZ30gZW5naW5lIFRoZSB0ZW1wbGF0ZSBlbmdpbmUKICAgICAgICBAcmV0dXJucyB7T2JqZWN0fSBUaGUgbmV3IHRlbXBsYXRlIGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCB0eXBlLCBodG1sLCBlbmdpbmUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCB0ZW1wbGF0ZSA9IHRoYXQuZ2V0KG5hbWUpOwogICAgICAgICAgICBpZighdGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgIGlmKHR5cGUgPT0gJ3ByZWNvbXBpbGVkJykgewogICAgICAgICAgICAgICAgICAgIHRoYXQuc2V0KG5hbWUsIHR5cGUsIGh0bWwsIGh0bWwudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0aW5nTWV0aG9kOwogICAgICAgICAgICAgICAgICAgIHZhciBjb21waWxlZFRlbXBsYXRlID0gdGhpcy5jb21waWxlKGh0bWwsIGVuZ2luZSk7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5zZXQobmFtZSwgdHlwZSwgY29tcGlsZWRUZW1wbGF0ZSwgaHRtbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoYXQuZ2V0KG5hbWUpOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmNvbXBpbGUgPSAvKioKICAgICAgICBDb21waWxlcyBhIHRlbXBsYXRlIGdpdmVuIHRoZSBodG1sIGFuZCB0aGUgZW5naW5lIHR5cGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGNvbXBpbGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaHRtbCBUaGUgaHRtbCB0byBnZW5lcmF0ZSB0aGUgdGVtcGxhdGUgZnJvbQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBlbmdpbmUgVGhlIHRlbXBsYXRlIGVuZ2luZSB0aGF0IGlzIGJlaW5nIHVzZWQuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgY29tcGlsZWQgdGVtcGxhdGUgbWV0aG9kCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGh0bWwsIGVuZ2luZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRlbXBsYXRpbmdNZXRob2Q7CiAgICAgICAgICAgIGlmKCFlbmdpbmUpIHsKICAgICAgICAgICAgICAgIGVuZ2luZSA9IHRoYXQuZW5naW5lc1t0aGF0LmNvbmZpZy5kZWZhdWx0VHlwZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodHlwZW9mIGVuZ2luZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgdGVtcGxhdGluZ01ldGhvZCA9IGVuZ2luZTsKICAgICAgICAgICAgfSBlbHNlIGlmKHR5cGVvZiBlbmdpbmUudGVtcGxhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHRlbXBsYXRpbmdNZXRob2QgPSBlbmdpbmUudGVtcGxhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRpbmdNZXRob2QoaHRtbCk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuZmV0Y2ggPSAvKioKICAgICAgICBGZXRjaHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBzZXJ2ZXIsIG9yIHRlbXBsYXRlIHN0b3JlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBmZXRjaAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IFt0eXBlXSBUaGUgdGVtcGxhdGUgdHlwZSBpZiBub3QgdGhlIGRlZmF1bHQKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgZm9yIHdoZW4gdGhlIHRlbXBsYXRlIGhhcyBiZWVuIGxvYWRlZC4KICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBGZXRjaHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBzZXJ2ZXIsIG9yIHRlbXBsYXRlIHN0b3JlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlRmFjYWRlCiAgICAgICAgQG1ldGhvZCBmZXRjaAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IFt0eXBlXSBUaGUgdGVtcGxhdGUgdHlwZSBpZiBub3QgdGhlIGRlZmF1bHQKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgZm9yIHdoZW4gdGhlIHRlbXBsYXRlIGhhcyBiZWVuIGxvYWRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSwgdHlwZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHR5cGUgPSB0eXBlIHx8IHRoYXQuY29uZmlnLmRlZmF1bHRUeXBlLCBzaG9ydE5hbWUgPSB0aGF0LnNob3J0TmFtZShuYW1lKSwgbG9uZ05hbWUgPSB0aGF0LmxvbmdOYW1lKG5hbWUsIHR5cGUpLCB0ZW1wbGF0ZTsKICAgICAgICAgICAgdmFyIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICBpZih0ZW1wbGF0ZSA9IHRoYXQuZ2V0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoYXQuZGF0YS5nZXQodGhhdC5jb25maWcuYmFzZVVybCArIGxvbmdOYW1lLCB7CiAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogJ3RleHQvcGxhaW4nLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6ICd0ZXh0JywKICAgICAgICAgICAgICAgIHNpbGVudDogdHJ1ZQogICAgICAgICAgICB9KS50aGVuKHdoZW4uYXBwbHkoZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgIGlmKHR5cGUgPT0gJ3ByZWNvbXBpbGVkJykgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoYXQubmV3VGVtcGxhdGUobmFtZSwgdHlwZSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmKHRoYXQuZW5naW5lc1t0eXBlXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGF0Lm5ld1RlbXBsYXRlKG5hbWUsIHR5cGUsIGRhdGEsIHRoYXQuZW5naW5lc1t0eXBlXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRoYXQuY29uZmlnLnRlbXBsYXRlUGF0aHNbdHlwZV0gfHwgJ3RocnVzdC90ZW1wbGF0ZS8nICsgdHlwZSkKICAgICAgICAgICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKGVuZ2luZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5lbmdpbmVzW3R5cGVdID0gZW5naW5lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhLCBlbmdpbmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSksIGRlZmVyLnJlamVjdCk7CiAgICAgICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmNyZWF0ZUZyb21Eb21Ob2RlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0ZW1wbGF0ZSBmcm9tIHRoZSBnaXZlbiBET00gTm9kZQogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBjcmVhdGVGcm9tRG9tTm9kZQogICAgICAgIEBwcm90ZWN0ZWQKICAgICAgICBAcGFyYW0ge05vZGV9IGVsZW1lbnQgVEhlIGRvbWUgZWxlbWVudC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoYXQubmV3VGVtcGxhdGUoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGVtcGxhdGUnKSwgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdHlwZScpLCBlbGVtZW50LnRleHQpOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IC8qKgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBjcmVhdGVGYWNhZGUKICAgICAgICBAcGFyYW0ge3RocnVzdC5UaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBhbHJlYWR5IGFkZGVkIGZvciB0aGlzIG1vZHVsZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlSW5zdGFuY2UgPSB0aHJ1c3QudGVtcGxhdGU7CiAgICAgICAgICAgIHZhciBmYWNhZGUgPSBmYWNhZGVzLnRlbXBsYXRlID0gbmV3IFRlbXBsYXRlRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgIG1vZC50ZW1wbGF0ZXMgPSB7CiAgICAgICAgICAgICAgICBmZXRjaDogYmluZCh0ZW1wbGF0ZUluc3RhbmNlLmZldGNoLCB0ZW1wbGF0ZUluc3RhbmNlKSwKICAgICAgICAgICAgICAgIGdldDogYmluZCh0ZW1wbGF0ZUluc3RhbmNlLmdldCwgdGVtcGxhdGVJbnN0YW5jZSksCiAgICAgICAgICAgICAgICBoYXM6IGJpbmQodGVtcGxhdGVJbnN0YW5jZS5oYXMsIHRlbXBsYXRlSW5zdGFuY2UpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBmYWNhZGU7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5jb25maWcgPSBjb25maWc7CiAgICAgICAgcmV0dXJuIFRlbXBsYXRlOwogICAgfSkoKTsKICAgIGV4cG9ydHMuVGVtcGxhdGUgPSBUZW1wbGF0ZTsgICAgCiAgICAvKioKICAgIAogICAgQGZvciB0aHJ1c3QudGVtcGxhdGUKICAgIEBjbGFzcyB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgIEBwYXJhbSB7dGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlfSBwYXJlbnQgVGhlIHRlbXBsYXRlIGluc3RhbmNlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvci4KICAgICoqLwogICAgdmFyIFRlbXBsYXRlRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdGVtcGxhdGVGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBtb2R1bGUubmFtZSArICctdGVtcGxhdGUnOwogICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICBleHRlbmQodGhpcywgewogICAgICAgICAgICAgICAgZmV0Y2g6IGJpbmQocGFyZW50LmZldGNoLCBwYXJlbnQpLAogICAgICAgICAgICAgICAgZ2V0OiBiaW5kKHBhcmVudC5nZXQsIHBhcmVudCksCiAgICAgICAgICAgICAgICBoYXM6IGJpbmQocGFyZW50LmhhcywgcGFyZW50KQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGVtcGxhdGVGYWNhZGU7CiAgICB9KSgpOwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSB0aHJ1c3QvdGVtcGxhdGUgYnkgcGF0aC4KICAgIFJlcXVpcmVzIHRoZSBpbnN0YW5jZSwgdGhhdCB0aGUgdGVtcGxhdGUgaXMgZXhwZWN0ZWQgdG8gY29tZSBmcm9tLgogICAgdGhydXN0SW5zdGFuY2VbOmVuZ2luZU5hbWVdOnRlbXBsYXRlUGF0aAogICAgCiAgICBQcmVmaXggd2l0aCA8ZW5naW5lTmFtZT46IHRvIHNlbGVjdCBhIHNwZWNpZmljIHRlbXBsYXRlIGVuZ2luZS4KICAgIHRocnVzdC90ZW1wbGF0ZSFnbG9iYWw6dGVtcGxhdGVzL215VGVtcGxhdGUudG1wbCA9IFNwZWNpZmljIHRlbXBsYXRlCiAgICB0aHJ1c3QvdGVtcGxhdGUhaW5zdGFuY2UyOnRlbXBsYXRlcy9teVRlbXBsYXRlID0gVXNlcyBkZWZhdWx0IGV4dGVuc2lvbiBmcm9tIGNvbmZpZwogICAgdGhydXN0L3RlbXBsYXRlIWluc3RhbmNlMjprZW5kbzp0ZW1wbGF0ZXMvbXlUZW1wbGF0ZS50bXBsID0gVXNlcyB0aGUga2VuZG8gdGVtcGxhdGUgZW5naW5lLgogICAgdGhydXN0L3RlbXBsYXRlIWluc3RhbmNlMzprZW5kbzp0ZW1wbGF0ZXMvbXlUZW1wbGF0ZS50bXBsID0gVXNlcyB0aGUga2VuZG8gdGVtcGxhdGUgZW5naW5lIHdpdGggdGhlIGRlZmF1bHQgZXh0ZW5zaW9uCiAgICAKICAgIAogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgdGVtcGxhdGUgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgLy8gTm90IGNvbXBsZXRlZCB5ZXQKICAgIC8vIFNob3VsZCBiZWhhdmUgc2ltaWxhcmx5IHRvIHRleHQhCiAgICAvL2V4cG9ydCBmdW5jdGlvbiBsb2FkKG5hbWU6IHN0cmluZywgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKQogICAgLy97CiAgICAvLyAgICB2YXIgdGVtcGxhdGVQYXRoID0gbmFtZSwKICAgIC8vICAgICAgICB0ZW1wbGF0ZUVuZ2luZSwKICAgIC8vICAgICAgICBjb2xvbiA9IHRlbXBsYXRlUGF0aC5pbmRleE9mKCc6Jyk7CiAgICAvLwl2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksCiAgICAvLyAgICAgICAgaW5zdGFuY2VOYW1lID0gcGFydHNbMF0sCiAgICAvLwkJdGVtcGxhdGVFbmdpbmUgPSBwYXJ0c1sxXSwKICAgIC8vCQl0ZW1wbGF0ZVBhdGggPSBwYXJ0c1syXSB8fCB0ZW1wbGF0ZUVuZ2luZTsKICAgIC8vICAgIGlmIChwYXJ0cy5sZW5ndGggPT09IDIpCiAgICAvLyAgICAgICAgdGVtcGxhdGVFbmdpbmUgPSBudWxsOwogICAgLy8JLy92YXIgaW5zdGFuY2VQcm9taXNlID0gVGhydXN0Ll9fZmV0Y2hJbnN0YW5jZShyZWFsTmFtZSk7CiAgICAvLyAgICAvLyBHZXQgdGhlIGRhdGEgcGx1Z2luLgogICAgLy8gICAgcGFyZW50UmVxdWlyZShbJ3RocnVzdCFkYXRhOicgKyBpbnN0YW5jZU5hbWVdLCAoZGF0YVBsdWdpbikgPT4KICAgIC8vICAgIHsKICAgIC8vICAgICAgICB2YXIgZGF0YVBsdWdpbiA9IGRhdGFQbHVnaW4KICAgIC8vICAgIH0pOwogICAgLy99CiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3RlbXBsYXRlJywgWyd0aHJ1c3QvdGVtcGxhdGUvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9zcGEvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAndGhydXN0JywgJ3RocnVzdC9sb2cnLCAnaGFzJywgJ2ZsYXRpcm9uL2RpcmVjdG9yJywgJ3RocnVzdC9pbnN0YW5jZScsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX190aHJ1c3RfXywgX19sb2dfXywgX19oYXNfXywgX19mbGF0aXJvblJvdXRlcl9fLCBfX2luc3RhbmNlX18sIF9fY29uZmlnX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvc3BhL3NwYS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgdGhydXN0ID0gX190aHJ1c3RfXzsKCiAgICB2YXIgVGhydXN0ID0gdGhydXN0LlRocnVzdDsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBmbGF0aXJvblJvdXRlciA9IF9fZmxhdGlyb25Sb3V0ZXJfXzsKCiAgICB2YXIgUm91dGVyID0gZmxhdGlyb25Sb3V0ZXIuUm91dGVyIHx8IGZsYXRpcm9uUm91dGVyOwogICAgCiAgICB2YXIgaW5zdGFuY2UgPSBfX2luc3RhbmNlX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnU2luZ2xlUGFnZUFwcGxpY2F0aW9uJzsKICAgIGNvbmZpZzsKICAgIHZhciBlYWNoID0gXy5lYWNoLCBpc1N0cmluZyA9IF8uaXNTdHJpbmcsIGlzQXJyYXkgPSBfLmlzQXJyYXksIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgaXNSZWdFeHAgPSBfLmlzUmVnRXhwLCBleHRlbmQgPSBfLmV4dGVuZCwgb25jZSA9IF8ub25jZSwgd2hlbiA9IHV0aWwud2hlbiwgYmluZCA9IF8uYmluZCwgaW52b2tlID0gXy5pbnZva2UsIHBsdWNrID0gXy5wbHVjaywgbWFwID0gXy5tYXAsIGRlZmVyID0gXy5kZWZlciwgcmVkdWNlID0gXy5yZWR1Y2UsIG1lbW9pemUgPSBfLm1lbW9pemUsIHRvQXJyYXkgPSBfLnRvQXJyYXksIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBTVEFSVCA9ICdzdGFydCc7CiAgICB2YXIgZXh0cmFjdFBhcmFtcyA9IGZ1bmN0aW9uIChyb3V0ZSkgewogICAgICAgIHZhciBwYXJhbXMgPSBbXSwgaW5kZXggPSByb3V0ZS5pbmRleE9mKCc6JyksIHNsYXNoSW5kZXg7CiAgICAgICAgd2hpbGUoaW5kZXggPiAtMSkgewogICAgICAgICAgICBzbGFzaEluZGV4ID0gcm91dGUuaW5kZXhPZignLycsIGluZGV4KTsKICAgICAgICAgICAgaWYoc2xhc2hJbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHNsYXNoSW5kZXggPSByb3V0ZS5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyYW1zLnB1c2gocm91dGUuc3Vic3RyaW5nKGluZGV4LCBzbGFzaEluZGV4IC0gaW5kZXggKyAxKSk7CiAgICAgICAgICAgIHJvdXRlID0gcm91dGUuc3Vic3RyaW5nKHNsYXNoSW5kZXgpOwogICAgICAgICAgICBpbmRleCA9IHJvdXRlLmluZGV4T2YoJzonKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH07CiAgICB2YXIgZXZlbnRGYWN0b3J5ID0gZnVuY3Rpb24gKGV2ZW50LCBtZWRpYXRvcikgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRmlyaW5nIHNwYSAiezB9IiB3aXRoIFt7MX1dJywgZXZlbnQsIHRvQXJyYXkoYXJndW1lbnRzKS5qb2luKCcsJykpKTsKICAgICAgICAgICAgbWVkaWF0b3IuZmlyZS5hc3luYy5hcHBseShtZWRpYXRvciwgWwogICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgICAgfTsKICAgIH07CiAgICAvKioKICAgIAogICAgQGZvciB0aHJ1c3Quc3BhCiAgICBAY2xhc3MgdGhydXN0LnNwYS5TaW5nbGVQYWdlQXBwCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRocnVzdCBpbnN0YW5jZSBjb25maWd1cmF0aW9uCiAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZQogICAgQHBhcmFtIHt0aHJ1c3QubWVkaWF0b3JNZWRpYXRvcn0gbWVkaWF0b3IgVGhlIHRocnVzdCBpbnN0YW5jZSBtZWRpYXRvcgogICAgKiovCiAgICB2YXIgU2luZ2xlUGFnZUFwcGxpY2F0aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBTaW5nbGVQYWdlQXBwbGljYXRpb24oY29uZmlnLCBpbnN0YW5jZU5hbWUsIG1lZGlhdG9yKSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnRpbmdNb2R1bGVQcm9taXNlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LmJhc2VVcmwgPSBjb25maWcudXJsLnBhdGg7CiAgICAgICAgICAgIHZhciBzcGFDb25maWcgPSBjb25maWcuc3BhOwogICAgICAgICAgICB0aGF0LmZpbGVFeHRlbnNpb24gPSBzcGFDb25maWcuZmlsZUV4dGVuc2lvbjsKICAgICAgICAgICAgdmFyIHJvdXRlcyA9IHRoYXQuY29uZmlndXJlUm91dGVzKHNwYUNvbmZpZy5yb3V0ZXMpLCBwYXJhbXMgPSBzcGFDb25maWcucGFyYW1zOwogICAgICAgICAgICB2YXIgZXZlbnRGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdGaXJpbmcgc3BhICJ7MH0iIHdpdGggW3sxfV0nLCBldmVudCwgdG9BcnJheShhcmd1bWVudHMpLmpvaW4oJywnKSkpOwogICAgICAgICAgICAgICAgICAgIG1lZGlhdG9yLmZpcmUuYXN5bmMuYXBwbHkobWVkaWF0b3IsIFsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgICAgICBdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgcm91dGVyID0gdGhhdC5yb3V0ZXIgPSBuZXcgUm91dGVyKHJvdXRlcykuY29uZmlndXJlKHsKICAgICAgICAgICAgICAgIHJlY3Vyc2U6IGZhbHNlLAogICAgICAgICAgICAgICAgc3RyaWN0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgICAgICAgICAgIGh0bWw1aGlzdG9yeTogdHJ1ZSwKICAgICAgICAgICAgICAgIG5vdGZvdW5kOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvbm90Zm91bmQnKSwKICAgICAgICAgICAgICAgIGJlZm9yZTogZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL2JlZm9yZScpLAogICAgICAgICAgICAgICAgb246IGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9ydW4nKSwKICAgICAgICAgICAgICAgIGFmdGVyOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvYWZ0ZXInKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgXy5lYWNoKHBhcmFtcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJvdXRlci5wYXJhbShpLCB4KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBTdGFydCB0aGUgc2luZ2xlIHBhZ2UgYXBwIHJvdXRlci4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHRoYXQuc3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGF0LnRocnVzdCA9IGluc3RhbmNlLmdldEluc3RhbmNlKGluc3RhbmNlTmFtZSk7CiAgICAgICAgICAgICAgICB0aGF0LnJvdXRlci5pbml0KCk7CiAgICAgICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jKCd0aHJ1c3Qvc3BhL3N0YXJ0Jyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoYXQubmF2aWdhdGUgPSB0aGF0Lm5hdmlnYXRlLmJpbmQodGhhdCk7CiAgICAgICAgfQogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUubmF2aWdhdGUgPSAvKioKICAgICAgICBOYXZpZ2F0ZXMgdG8gdGhlIGdpdmVuIHVybC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIG5hdmlnYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGxvY2F0aW9uIFRoZSBsb2NhdGlvbiB0byBuYXZpZ2F0ZSB0by4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobG9jYXRpb24pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgdXJsID0gdXRpbC5maXh1cFVybChsb2NhdGlvbiwgdGhhdC5iYXNlVXJsKTsKICAgICAgICAgICAgdGhhdC5yb3V0ZXIuc2V0Um91dGUodXJsKTsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUuc3RhcnQgPSAvKioKICAgICAgICBTdGFydCB0aGUgc2luZ2xlIHBhZ2UgYXBwIHJvdXRlci4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnRocnVzdCA9IGluc3RhbmNlLmdldEluc3RhbmNlKHRoaXMuaW5zdGFuY2VOYW1lKTsKICAgICAgICAgICAgdGhpcy5yb3V0ZXIuaW5pdCgpOwogICAgICAgICAgICB0aGlzLnRocnVzdC5tZWRpYXRvci5maXJlLmFzeW5jKCd0aHJ1c3Qvc3BhL3N0YXJ0Jyk7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLmNvbmZpZ3VyZVJvdXRlcyA9IC8qKgogICAgICAgIENvbmZpZ3VyZXMgdGhlIHJvdXRlIG9iamVjdCBmb3IgdGhlIHNwYSBpbnN0YW5jZQogICAgICAgIAogICAgICAgIFJvdXRlcyBjYW4gYmUgaW4gNCBmb3JtcwogICAgICAgIAogICAgICAgIHsKICAgICAgICAnL3BhdGgvdG8vOmZvbyc6ICdwYXRoL3RvL21vZHVsZScsCiAgICAgICAgJy9wYXRoL3RvLzpiYXInOiBbJ3BhdGgvdG8vbW9kdWxlMScsICdwYXRoL3RvL21vZHVsZTInXSwKICAgICAgICAnL3BhdGgvdG8vOmZiJzogeyBwYXRoOiAncGF0aC90by9tb2R1bGUnLCBhcmdzOiBbJ2FyZ3MnLCAndG8nLCAnaGFuZCBvZmYgdG8gc3RhcnQnXSB9CiAgICAgICAgJy9wYXRoL3RvLzpmb28vOmJhcic6IGZ1bmN0aW9uKGZvbywgYmFyKXsgIGN1c3RvbSBoYW5kbGVyIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjb25maWd1cmVSb3V0ZXMKICAgICAgICBAcGFyYW0ge09iamVjdH0gcm91dGVzIE9iamVjdCBvZiByb3V0ZXMuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHJvdXRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGNvbmZpZ3VyZWRSb3V0ZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIGVhY2gocm91dGVzLCBmdW5jdGlvbiAodmFsdWUsIHJvdXRlKSB7CiAgICAgICAgICAgIGZvcih2YXIgcm91dGUgaW4gcm91dGVzKSB7CiAgICAgICAgICAgICAgICBpZihfLmhhcyhyb3V0ZXMsIHJvdXRlKSkgewogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHJvdXRlc1tyb3V0ZV07CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlYWxSb3V0ZSA9IHV0aWwuZml4dXBVcmwocm91dGUsIHRoYXQuYmFzZVVybCk7CiAgICAgICAgICAgICAgICAgICAgaWYoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJlZFJvdXRlc1tyZWFsUm91dGVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVzID0gW10sIG1ldGhvZHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IHZhbHVlLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHYgPSB2YWx1ZVt2XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKHYpIHx8IGlzT2JqZWN0KHYpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzRnVuY3Rpb24odikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2RzLnB1c2godik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUNhbGxiYWNrID0gdGhhdC5tb2R1bGVTdGFydENhbGxiYWNrKHJvdXRlLCBtb2R1bGVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kcy5wdXNoKG1vZHVsZUNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJlZFJvdXRlc1tyZWFsUm91dGVdID0gbWV0aG9kczsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVDYWxsYmFjayA9IHRoYXQubW9kdWxlU3RhcnRDYWxsYmFjayhyb3V0ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmVkUm91dGVzW3JlYWxSb3V0ZV0gPSBtb2R1bGVDYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy99KTsKICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ3VyZWRSb3V0ZXM7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLm1vZHVsZVN0YXJ0Q2FsbGJhY2sgPSAvKioKICAgICAgICAKICAgICAgICBAbWV0aG9kIG1vZHVsZVN0YXJ0Q2FsbGJhY2sKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nIHwgQXJyYXkgfCBPYmplY3R9IG1vZHVsZXMgU3RyaW5nIHRvIHN0YXJ0IGEgc2luZ2xlIG1vZHVsZSwgQXJyYXkgdG8gc3RhcnQgbWFueSBtb2R1bGVzLCBPYmplY3QgdG8gc3RhcnQgYSBtb2R1bGUgd2l0aCBzcGVjaWZpYyBhcmd1bWVudHMuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHJvdXRlLCBtb2R1bGVzKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW10sIHBhcmFtcyA9IGV4dHJhY3RQYXJhbXMocm91dGUpLCB0aGF0ID0gdGhpcywgZmlsZUV4dGVuc2lvbiA9IHRoYXQuZmlsZUV4dGVuc2lvbjsKICAgICAgICAgICAgaWYoaXNPYmplY3QobW9kdWxlcykpIHsKICAgICAgICAgICAgICAgIGFyZ3MgPSBtb2R1bGVzLmFyZ3MgfHwgYXJnczsKICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBtb2R1bGVzLnBhdGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoaXNTdHJpbmcobW9kdWxlcykpIHsKICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlcwogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGFyID0gdG9BcnJheShhcmd1bWVudHMpLCB0aHJ1c3QgPSB0aGF0LnRocnVzdCwgbWFwcGVkTW9kdWxlcyA9IG1hcChtb2R1bGVzLCBmdW5jdGlvbiAobW9kdWxlUGF0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZWR1Y2UoYXIsIGZ1bmN0aW9uIChtZW1vLCBhcmcsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lbW8ucmVwbGFjZShwYXJhbXNbaV0sIGFyZy50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICB9LCBtb2R1bGVQYXRoKS5yZXBsYWNlKGZpbGVFeHRlbnNpb24sICcnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aHJ1c3Quc3RhcnQuYXBwbHkodGhydXN0LCBbCiAgICAgICAgICAgICAgICAgICAgbWFwcGVkTW9kdWxlcwogICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICAgICAgaWYoIXRoYXQudGhydXN0LnN0YXJ0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJ1c3QucmVhZHkobWFwcGVkTW9kdWxlcywgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0aW5nTW9kdWxlUHJvbWlzZSA9IHByb21pc2U7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IC8qKgogICAgICAgIEhhbmRzIHRoZSBuYXZpZ2F0ZSBtZXRob2Qgb2ZmIHRvIHRoZSBtb2R1bGUsIHNvIGFueSBtb2R1bGUgY2FuIHRyaWdnZXIgYSBuYXZpZ2F0aW9uIGV2ZW50LgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnNwYS5TaW5nbGVQYWdlQXBwCiAgICAgICAgQG1ldGhvZCBjcmVhdGVGYWNhZGUKICAgICAgICBAcGFyYW0ge3RocnVzdC5UaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2QgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBhbHJlYWR5IGFkZGVkIGZvciB0aGlzIG1vZHVsZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZihtb2QubmF2aWdhdGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignIm5hdmlnYXRlIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQWxyZWFkeSBwcmUgYm91bmQsIHNvIHdlIG9ubHkgcGFzcyBhcm91bmQgMSBmdW5jdGlvbiBwZXIgaW5zdGFuY2UuCiAgICAgICAgICAgIG1vZC5uYXZpZ2F0ZSA9IHRoYXQubmF2aWdhdGUuYmluZCh0aGF0KTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24uY29uZmlnID0gY29uZmlnOwogICAgICAgIHJldHVybiBTaW5nbGVQYWdlQXBwbGljYXRpb247CiAgICB9KSgpOwogICAgZXhwb3J0cy5TaW5nbGVQYWdlQXBwbGljYXRpb24gPSBTaW5nbGVQYWdlQXBwbGljYXRpb247ICAgIAp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYScsIFsndGhydXN0L3NwYS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsK",
                "body": "LyohIHRocnVzdC1qcyAtIHYwLjEuNSAtIDIwMTMtMDEtMjcgKi8KZGVmaW5lKCd0aHJ1c3QvdXRpbC9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdsb2Rhc2gnLCAndW5kZXJzY29yZS5zdHJpbmcnLCAndXVpZCcsICd3aGVuJywgJ3doZW4vYXBwbHknLCAnd2hlbi9kZWxheScsICd3aGVuL3RpbWVvdXQnLCAnd2hlbi9wYXJhbGxlbCcsICd3aGVuL3BpcGVsaW5lJywgJ3doZW4vc2VxdWVuY2UnLCAnd2hlbi9jYW5jZWxhYmxlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fX19fXywgX19fc19fLCBfX3V1aWRfXywgX193X18sIF9fd2hlbkFwcGx5X18sIF9fd2hlbkRlbGF5X18sIF9fd2hlblRpbWVvdXRfXywgX193aGVuUGFyYWxsZWxfXywgX193aGVuUGlwZWxpbmVfXywgX193aGVuU2VxdWVuY2VfXywgX193aGVuQ2FuY2VsYWJsZV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSB1dGlsIHsqLwogICAgdmFyIF9fID0gX19fX19fOwoKICAgIHZhciBfcyA9IF9fX3NfXzsKCiAgICB2YXIgdXVpZCA9IF9fdXVpZF9fOwoKICAgIAogICAgX18ubWl4aW4oX3MpOwogICAgZXhwb3J0cy5fID0gX187CiAgICAvLyNyZWdpb24gZnVuY3Rpb24KICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIC8qKgogICAgQSBmdW5jdGlvbiB0aGF0IGRvZXMgbm90aGluZywgb3Igbm8gb3BlcmF0aW9uLiAgSGVuY2UgdGhlIG5hbWUgbm9vcC4KICAgIAogICAgQG1ldGhvZCBub29wCiAgICAqKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICB9CiAgICBleHBvcnRzLm5vb3AgPSBub29wOwogICAgdmFyIHByb3BlcnR5SXNFbnVtZXJhYmxlID0gbm9vcC5wcm9wZXJ0eUlzRW51bWVyYWJsZTsKICAgIC8qKgogICAgQXR0ZW1wdHMgdG8gaW52b2tlLCBzaW1pbGFyIHRvIF8uaW52b2tlLCBidXQgaW4gdGhpcyBjYXNlIGl0IHZlcmlmaWVzIHRoYXQgdGhlIHByb3BlcnR5IGV4aXN0LAogICAgYW5kIGFsc28gdmVyaWZpZXMgdGhhdCBpdCBpcyBhIGZ1bmN0aW9uLCBhbmQgbm90IHRoZSBub29wIG1ldGhvZCBhdmFpbGFibGUgaW4gdGhydXN0LgogICAgCiAgICBUaGUgaW50ZW50IGlzIGEgbWV0aG9kIHRoYXQgYWxsb3dzIG92ZXJyaWRlIG9mIGZ1bmN0aW9ucywgd2l0aG91dCBjcmVhdGluZyBjdXN0b20gY29kZS4KICAgIAogICAgQG1ldGhvZCBzYXZlSW52b2tlCiAgICBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29udGFpbmVyIHRoYXQgaGFzIHRoZSBpdGVtcwogICAgQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IG1ldGhvZCBUaGUgbWV0aG9kIG5hbWUgb24gZXZlcnkgaXRlbSwgb3IgdGhlIG1ldGhvZCB0byBpbnZva2UgYWdhaW5zdCBlYWNoIGl0ZW0uCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3NdKiBUaGUgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHNhZmVJbnZva2UoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMik7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAyXTsKICAgICAgICB9CiAgICAgICAgLypqc2hpbnQgYml0d2lzZTpmYWxzZSAqLwogICAgICAgICAgICAgICAgdmFyIGluZGV4LCBpdGVyYXRlZSA9IGNvbGxlY3Rpb24sIHJlc3VsdDsKICAgICAgICBpZighY29sbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLCBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLCBtZXRob2RFeGlzdHM7CiAgICAgICAgdmFyIGxlbmd0aCA9IGl0ZXJhdGVlLmxlbmd0aDsKICAgICAgICBpbmRleCA9IC0xOwogICAgICAgIGlmKGxlbmd0aCA9PT0gbGVuZ3RoID4+PiAwKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKTsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyAmJiBtZXRob2RFeGlzdHMgIT09IG5vb3AgJiYgKHJlc3VsdFtpbmRleF0gPSBtZXRob2RFeGlzdHMuYXBwbHkoaXRlcmF0ZWVbaW5kZXhdLCBhcmdzKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc2tpcFByb3RvID0gdHlwZW9mIGl0ZXJhdGVlID09ICdmdW5jdGlvbicgJiYgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChpdGVyYXRlZSwgJ3Byb3RvdHlwZScpOwogICAgICAgICAgICB2YXIgcHJvcHMgPSBleHBvcnRzLl8ua2V5cyhpdGVyYXRlZSksIHByb3BJbmRleCA9IC0xLCBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsrcHJvcEluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IHByb3BzW3Byb3BJbmRleF07CiAgICAgICAgICAgICAgICBpZighKHNraXBQcm90byAmJiBpbmRleCA9PSAncHJvdG90eXBlJykpIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzICYmIG1ldGhvZEV4aXN0cyAhPT0gbm9vcCAmJiAocmVzdWx0W3Byb3BJbmRleF0gPSAoKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pLmFwcGx5KGl0ZXJhdGVlW2luZGV4XSwgYXJncykpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy5zYWZlSW52b2tlID0gc2FmZUludm9rZTsKICAgIC8qKgogICAgKiBDb25zdHJ1Y3RvciB1c2VkIHRvIGJlZ2V0IG9iamVjdHMgdGhhdCB3aXJlIG5lZWRzIHRvIGNyZWF0ZSB1c2luZyBuZXcuCiAgICAqIEBwYXJhbSBjdG9yIHtGdW5jdGlvbn0gcmVhbCBjb25zdHJ1Y3RvciB0byBiZSBpbnZva2VkCiAgICAqIEBwYXJhbSBhcmdzIHtBcnJheX0gYXJndW1lbnRzIHRvIGJlIHN1cHBsaWVkIHRvIGN0b3IKICAgICovCiAgICBmdW5jdGlvbiBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gY3Rvci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICAgIC8qKgogICAgKiBDcmVhdGVzIGFuIG9iamVjdCBieSBlaXRoZXIgaW52b2tpbmcgY3RvciBhcyBhIGZ1bmN0aW9uIGFuZCByZXR1cm5pbmcgdGhlIHJlc3VsdCwKICAgICogb3IgYnkgY2FsbGluZyBuZXcgY3RvcigpLiAgSXQgdXNlcyBhIHNpbXBsZSBoZXVyaXN0aWMgdG8gdHJ5IHRvIGd1ZXNzIHdoaWNoIGFwcHJvYWNoCiAgICAqIGlzIHRoZSAicmlnaHQiIG9uZS4KICAgICoKICAgICogQHBhcmFtIGN0b3Ige0Z1bmN0aW9ufSBmdW5jdGlvbiBvciBjb25zdHJ1Y3RvciB0byBpbnZva2UKICAgICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcnJheSBvZiBhcmd1bWVudHMgdG8gcGFzcyB0byBjdG9yIGluIGVpdGhlciBjYXNlCiAgICAqCiAgICAqIEByZXR1cm5zIFRoZSByZXN1bHQgb2YgaW52b2tpbmcgY3RvciB3aXRoIGFyZ3MsIHdpdGggb3Igd2l0aG91dCBuZXcsIGRlcGVuZGluZyBvbgogICAgKiB0aGUgc3RyYXRlZ3kgc2VsZWN0ZWQuCiAgICAqLwogICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoY3RvciwgYXJncywgbmFtZSkgewogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gY3Rvci5wcm90b3R5cGU7CiAgICAgICAgRHluYW1pY2x5Q3JlYXRlZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yOwogICAgICAgIHZhciBiZWdvdHRlbiA9IG5ldyBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpOwogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gdm9pZCAwOwogICAgICAgIHJldHVybiBiZWdvdHRlbjsKICAgIH0KICAgIGV4cG9ydHMuaW5zdGFudGlhdGUgPSBpbnN0YW50aWF0ZTsKICAgIC8qKgogICAgRmxhdHRlbiBhbmQgZmlsdGVyIGFycmF5cyBkb3duIHRvIGp1c3QgdGhlIGV4aXN0aW5nIHByb21pc2VzLgogICAgCiAgICBAbWV0aG9kIGZsYXR0ZW5Ub1Byb21pc2VzCiAgICBAcGFyYW0ge0FycmF5fSBBcnJheSB0byBmbGF0dGVuLCBhbmQgZmlsdGVyLgogICAgQHJldHVybnMge0FycmF5IG9mIFByb21pc2VzfQogICAgKiovCiAgICBmdW5jdGlvbiBmbGF0dGVuVG9Qcm9taXNlcyhhcnJheSkgewogICAgICAgIHJldHVybiBleHBvcnRzLl8uZmxhdHRlbihhcnJheSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLmlzUHJvbWlzZSh4KTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZmxhdHRlblRvUHJvbWlzZXMgPSBmbGF0dGVuVG9Qcm9taXNlczsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIG9iamVjdAogICAgLyoqCiAgICBJbnZlcnRzIGFuIG9iamVjdC4gIFRoZSBrZXlzIGJlY29tZSB2YWx1ZXMsIGFuZCB0aGUgdmFsdWVzIGJlY29tZSBrZXlzLgogICAgRG9lcyBub3QgZG8gYW55IGNvcHlpbmcuCiAgICAKICAgIEBtZXRob2QgaW52ZXJ0CiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gaW52ZXJ0LgogICAgQHJldHVybnMge09iamVjdH0gVGhlIGludmVydGVkIG9iamVjdC4KICAgICoqLwogICAgdmFyIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBmdW5jdGlvbiBpbnZlcnQob2JqKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICB9OwogICAgICAgIGZvcih2YXIgaSBpbiBvYmopIHsKICAgICAgICAgICAgaWYoaGFzT3duLmNhbGwob2JqLCBpKSkgewogICAgICAgICAgICAgICAgcmVzdWx0W29ialtpXV0gPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLmludmVydCA9IGludmVydDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHR5cGUudHMKICAgIC8qKgogICAgQ2hlY2tzIGlzIHRoZSBvYmplY3QgaXMgYXJyYXkgbGlrZSwgbGlrZSB0aGUgYXJ1Z3VtZW50cyBvYmplY3QsIGJ1dCBub3QgYSBzdHJpbmcsIG9lIGFycmF5LgogICAgalF1ZXJ5IG9iamVjdHMgZm9yIGV4YW1wbGUgd291bGQgcmVwb3J0IGFzIGFycmF5IGxpa2UuCiAgICBBcyB3ZWxsIGFzIGtub2Nrb3V0IG9ic2VydmFibGUgYXJyYXlzIHJlcG9ydCBhcyBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlMaWtlCiAgICBAcGFyYW0ge09iamVjdH0gbyBUaGUgb2JqZWN0IHRvIGNoZWNrCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSXMgaXQgdHJ1ZSBvciBmYWxzZS4KICAgICoqLwogICAgZnVuY3Rpb24gaXNBcnJheUxpa2UobykgewogICAgICAgIHJldHVybiAobyAmJiAhZXhwb3J0cy5fLmlzU3RyaW5nKG8pICYmIG8ubGVuZ3RoICE9PSB1bmRlZmluZWQpIHx8IGZhbHNlOwogICAgfQogICAgZXhwb3J0cy5pc0FycmF5TGlrZSA9IGlzQXJyYXlMaWtlOwogICAgLyoqCiAgICBDaGVja3MgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhcnJheSBvciBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlPckFycmF5TGlrZQogICAgQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB0byBjaGVjawogICAgQHJldHVybnMge0Jvb2xlYW59IElzIGl0IHRydWUgb3IgZmFsc2UuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXlPckFycmF5TGlrZShvKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc0FycmF5KG8pIHx8IChpc0FycmF5TGlrZShvKSk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlPckFycmF5TGlrZSA9IGlzQXJyYXlPckFycmF5TGlrZTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHV1aWQKICAgICAgICB2YXIgZ3VpZFJlZ2V4ID0gL14oXHt7MCwxfShbMC05YS1mQS1GXSl7OH0tKFswLTlhLWZBLUZdKXs0fS0oWzAtOWEtZkEtRl0pezR9LShbMC05YS1mQS1GXSl7NH0tKFswLTlhLWZBLUZdKXsxMn1cfXswLDF9KSQvLCBlbXRwdHlHdWlkID0gJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCc7CiAgICAvKioKICAgIFJldHVybnMgYSBuZXcgc3VkbyBndWlkLCBsaW1pYXRpb25zIGluIEphdmFTY3JpcHQgbWFrZSBtdXN0IG1vcmUgcmVsaWFibGUgZ3VpZHMgZmFpcmx5IGRpZmZpY3VsdCB0byBjcmVhdGUuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwKICAgIEBtZXRob2QgbmV3R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBuZXcgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gbmV3R3VpZCgpIHsKICAgICAgICByZXR1cm4gdXVpZC52NCgpOwogICAgfQogICAgZXhwb3J0cy5uZXdHdWlkID0gbmV3R3VpZDsKICAgIC8qKgogICAgUmV0dXJucyBhbiBlbXB0eSBndWlkLgogICAgCiAgICBAbWV0aG9kIGVtcHR5R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBlbXRwdHkgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gZW1wdHlHdWlkKCkgewogICAgICAgIHJldHVybiBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5lbXB0eUd1aWQgPSBlbXB0eUd1aWQ7CiAgICAvKioKICAgIENoZWNrcyBpZiB0aGUgZ2l2ZW4gc3RyaW5nIGlzIGEgZ3VpZC4KICAgIAogICAgQG1ldGhvZCBpc0d1aWQKICAgIEBwYXJhbSB7R3VpZH0gZ3VpZAogICAgQHJldHVybnMge0Jvb2xlYW59IElmIHRoZSBndWlkIGlzIGEgZ3VpZCBvciBub3QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzR3VpZChndWlkKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc1N0cmluZyhndWlkKSA/IGd1aWRSZWdleC50ZXN0KGd1aWQpIDogZmFsc2U7CiAgICB9CiAgICBleHBvcnRzLmlzR3VpZCA9IGlzR3VpZDsKICAgIC8qKgogICAgQ2hlY2tzIGlmIHRoZSBHdWlkIGlzIGFuIEVtcHR5IEd1aWQKICAgIAogICAgQG1ldGhvZCBpc0VtcHR5R3VpZAogICAgQHBhcmFtIHtHdWlkfSBndWlkCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSWYgdGhlIGd1aWQgaXMgYSBndWlkIG9yIG5vdC4KICAgICoqLwogICAgZnVuY3Rpb24gaXNFbXB0eUd1aWQoZ3VpZCkgewogICAgICAgIHJldHVybiBndWlkID09PSBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5pc0VtcHR5R3VpZCA9IGlzRW1wdHlHdWlkOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gc3RyaW5nCiAgICAgICAgdmFyIG9iamVjdEN1cmx5UmVnZXggPSAvXHtce3xcfVx9fFx7KC4qPylcfS9nLCBudW1iZXJDdXJseVJlZ2V4ID0gL1x7XHt8XH1cfXxceyhcZCspXH0vZzsKICAgIC8qKgogICAgQyMgc3R5bGUgc3RyaW5nIGZvcm1hdC4KICAgIAogICAgQGZvciB0aHJ1c3QudXRpbAogICAgQG1ldGhvZCBmb3JtYXQKICAgICoqLwogICAgZnVuY3Rpb24gZm9ybWF0KHN0cikgewogICAgICAgIHZhciBmb3JtYXRBcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgZm9ybWF0QXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgaWYodHlwZW9mIGZvcm1hdEFyZ3NbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHZhciBhID0gZm9ybWF0QXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKG9iamVjdEN1cmx5UmVnZXgsIGZ1bmN0aW9uIChtLCBuKSB7CiAgICAgICAgICAgICAgICBpZihtID09ICd7eycpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYobSA9PSAnfX0nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhICYmIGFbbl0gfHwgJyc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UobnVtYmVyQ3VybHlSZWdleCwgZnVuY3Rpb24gKG0sIG4pIHsKICAgICAgICAgICAgaWYobSA9PSAne3snKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG0gPT0gJ319JykgewogICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm9ybWF0QXJnc1tuXSB8fCAnJzsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZm9ybWF0ID0gZm9ybWF0OwogICAgZnVuY3Rpb24gZ2V0TW9kdWxlTmFtZUZvclBhdGgobmFtZSkgewogICAgICAgIHJldHVybiAobmFtZS5sYXN0SW5kZXhPZignLycpID4gLTEgPyBuYW1lLnN1YnN0cmluZyhuYW1lLmxhc3RJbmRleE9mKCcvJykgKyAxKSA6IG5hbWUpLnJlcGxhY2UoL1wuL2csICctJyk7CiAgICB9CiAgICBleHBvcnRzLmdldE1vZHVsZU5hbWVGb3JQYXRoID0gZ2V0TW9kdWxlTmFtZUZvclBhdGg7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiB1cmwKICAgICAgICB2YXIgZG91YmxlU2xhc2hSZWdleCA9IC9cL1wvL2csIHIyMCA9IC8lMjAvZywgcmJyYWNrZXQgPSAvXFtcXSQvOwogICAgLyoqCiAgICBqUXVlcnkgcGFyYW0gbWV0aG9kIHRvIGVuY29kZSBmb3JtIHBhcmFtZXRlcnMuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwudXJsCiAgICBAbWV0aG9kIHBhcmFtCiAgICAqKi8KICAgIGZ1bmN0aW9uIHBhcmFtKGEsIHRyYWRpdGlvbmFsKSB7CiAgICAgICAgdmFyIHByZWZpeCwgcyA9IFtdLCBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHJldHVybiBpdHMgdmFsdWUKICAgICAgICAgICAgdmFsdWUgPSBleHBvcnRzLl8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSgpIDogKHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlKTsKICAgICAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgICAvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgogICAgICAgIC8qaWYgKHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQpCiAgICAgICAgewogICAgICAgIC8vIFRPRE8gU3VwcG9ydCBmb3IgdHJhZGl0aW9uYWxFbmNvZGluZwogICAgICAgIC8vdHJhZGl0aW9uYWwgPSAhIW0uY29uZmlnKCkudHJhZGl0aW9uYWxFbmNvZGluZzsKICAgICAgICB9Ki8KICAgICAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgICAgIGlmKGlzQXJyYXlPckFycmF5TGlrZShhKSkgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgICAgICAgICAgZXhwb3J0cy5fLmVhY2goYSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGFkZCh4Lm5hbWUsIHgudmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKICAgICAgICAgICAgLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCiAgICAgICAgICAgIGZvcihwcmVmaXggaW4gYSkgewogICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhW3ByZWZpeF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KICAgICAgICByZXR1cm4gcy5qb2luKCImIikucmVwbGFjZShyMjAsICIrIik7CiAgICB9CiAgICBleHBvcnRzLnBhcmFtID0gcGFyYW07CiAgICBmdW5jdGlvbiBidWlsZFBhcmFtcyhwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCkgewogICAgICAgIGlmKGV4cG9ydHMuXy5pc0FycmF5KG9iaikpIHsKICAgICAgICAgICAgLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCiAgICAgICAgICAgIGV4cG9ydHMuXy5lYWNoKG9iaiwgZnVuY3Rpb24gKGksIHYpIHsKICAgICAgICAgICAgICAgIGlmKHRyYWRpdGlvbmFsIHx8IHJicmFja2V0LnRlc3QocHJlZml4KSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgICAgICAgICAgICBhZGQocHJlZml4LCB2KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCiAgICAgICAgICAgICAgICAgICAgLy8gbnVtZXJpYyBpbmRleCB0byByZXNvbHZlIGRlc2VyaWFsaXphdGlvbiBhbWJpZ3VpdHkgaXNzdWVzLgogICAgICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCByYWNrIChhcyBvZiAxLjAuMCkgY2FuJ3QgY3VycmVudGx5IGRlc2VyaWFsaXplCiAgICAgICAgICAgICAgICAgICAgLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCiAgICAgICAgICAgICAgICAgICAgLy8gYSBzZXJ2ZXIgZXJyb3IuIFBvc3NpYmxlIGZpeGVzIGFyZSB0byBtb2RpZnkgcmFjaydzCiAgICAgICAgICAgICAgICAgICAgLy8gZGVzZXJpYWxpemF0aW9uIGFsZ29yaXRobSBvciB0byBwcm92aWRlIGFuIG9wdGlvbiBvciBmbGFnCiAgICAgICAgICAgICAgICAgICAgLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgogICAgICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArICh0eXBlb2YgdiA9PT0gIm9iamVjdCIgfHwgZXhwb3J0cy5fLmlzQXJyYXkodikgPyBpIDogIiIpICsgIl0iLCB2LCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmKCF0cmFkaXRpb25hbCAmJiBvYmogIT0gbnVsbCAmJiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgICAgICAgIGZvcih2YXIgbmFtZSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialtuYW1lXSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgICAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBDbGVhbnMgdXAgZG91YmxlIHNsYXNocyBpbiBhIHVybCwgdXNlZCBieSB0aHJ1c3QvZGF0YQogICAgCiAgICBAbWV0aG9kIGNsZWFuVXJsCiAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gY2xlYW4KICAgIEByZXRydXNuIHtTdHJpbmd9IFRoZSBjbGVhbmVkIHVybAogICAgKiovCiAgICBmdW5jdGlvbiBjbGVhblVybCh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnJlcGxhY2UoZG91YmxlU2xhc2hSZWdleCwgJy8nKTsKICAgIH0KICAgIGV4cG9ydHMuY2xlYW5VcmwgPSBjbGVhblVybDsKICAgIC8qKgogICAgQ2hlY2tzIGZvciBleGlzdGFuY2Ugb2YgYXBwbGljYXRpb24gcGF0aCBpbiB0aGUgdXJsLCBvciBodHRwIGlmIHRoZSB1cmwgaXMgc3VwcG9zZWQgdG8gZ28gdG8gYW5vdGhlciBsb2NhdGlvbi4KICAgIAogICAgQG1ldGhvZCBmaXh1cFVybAogICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGZpeHVwCiAgICBAcmV0cnVzbiB7U3RyaW5nfSBUaGUgZml4ZWQgdXJsCiAgICAqKi8KICAgIGZ1bmN0aW9uIGZpeHVwVXJsKHVybCwgdXJsUGF0aCkgewogICAgICAgIGlmKHVybC5pbmRleE9mKCdodHRwJykgPT09IC0xKSB7CiAgICAgICAgICAgIHZhciBwYXRoID0gdXJsUGF0aC5sYXN0SW5kZXhPZignLycpID09PSB1cmxQYXRoLmxlbmd0aCAtIDEgPyB1cmxQYXRoLnN1YnN0cmluZygwLCAtMSkgOiB1cmxQYXRoOwogICAgICAgICAgICBpZih1cmwuaW5kZXhPZihwYXRoKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHVybCA9IHBhdGggKyB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXJsID0gY2xlYW5VcmwodXJsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIGV4cG9ydHMuZml4dXBVcmwgPSBmaXh1cFVybDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHdoZW4KICAgIHZhciB3ID0gX193X187CgogICAgLy9pbXBvcnQgdyA9IG1vZHVsZSgnd2hlbi9kZWJ1ZycpOwogICAgdmFyIHdoZW5BcHBseSA9IF9fd2hlbkFwcGx5X187CgogICAgdmFyIHdoZW5EZWxheSA9IF9fd2hlbkRlbGF5X187CgogICAgdmFyIHdoZW5UaW1lb3V0ID0gX193aGVuVGltZW91dF9fOwoKICAgIHZhciB3aGVuUGFyYWxsZWwgPSBfX3doZW5QYXJhbGxlbF9fOwoKICAgIHZhciB3aGVuUGlwZWxpbmUgPSBfX3doZW5QaXBlbGluZV9fOwoKICAgIHZhciB3aGVuU2VxdWVuY2UgPSBfX3doZW5TZXF1ZW5jZV9fOwoKICAgIHZhciB3aGVuQ2FuY2VsYWJsZSA9IF9fd2hlbkNhbmNlbGFibGVfXzsKCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnV0aWwKICAgIEBzdWJtb2R1bGUgdGhydXN0LnV0aWwud2hlbgogICAgKiovCiAgICAoZnVuY3Rpb24gKHdoZW4pIHsKICAgICAgICB3aGVuLndoZW4gPSB3OwogICAgICAgIC8qKgogICAgICAgIHdoZW4uYXBwbHksIHVzZWQgdG8gYXBwbHkgd2hlbiByZXN1bHRzIG92ZXIgYSBmdW5jdGlvbiwgc2ltaWxhciB0byBqUXVlcnlzIERlZmVycmVkLgogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHldKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHkpCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudXRpbC53aGVuCiAgICAgICAgQG1ldGhvZCB3aGVuLmFwcGx5CiAgICAgICAgKiovCiAgICAgICAgd2hlbi5hcHBseSA9IHdoZW5BcHBseTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmRlbGF5LCBjcmVhdGVzIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIGluIHggbXMsIHVzaW5nIHNldFRpbWVvdXQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uZGVsYXkKICAgICAgICAqKi8KICAgICAgICB3aGVuLmRlbGF5ID0gd2hlbkRlbGF5OwogICAgICAgIC8qKgogICAgICAgIHdoZW4udGltZW91dCwgY3JlYXRlcyBhIHByb21pc2UgdGhhdCB3aWxsIHRpbWVvdXQgaWYgeCBtcyBpZiBub3QgcmVzb2x2ZWQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi10aW1lb3V0XShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXRpbWVvdXQpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnRpbWVvdXQKICAgICAgICAqKi8KICAgICAgICB3aGVuLnRpbWVvdXQgPSB3aGVuVGltZW91dDsKICAgICAgICAvKioKICAgICAgICB3aGVuLnBhcmFsbGVsCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbF0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbCkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4ucGFyYWxsZWwKICAgICAgICAqKi8KICAgICAgICB3aGVuLnBhcmFsbGVsID0gd2hlblBhcmFsbGVsOwogICAgICAgIC8qKgogICAgICAgIHdoZW4ucGlwZWxpbmUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lXShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lKQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5waXBlbGluZQogICAgICAgICoqLwogICAgICAgIHdoZW4ucGlwZWxpbmUgPSB3aGVuUGlwZWxpbmU7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi5zZXF1ZW5jZQogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2UpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnNlcXVlbmNlCiAgICAgICAgKiovCiAgICAgICAgd2hlbi5zZXF1ZW5jZSA9IHdoZW5TZXF1ZW5jZTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmNhbmNlbGFibGUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWNhbmNlbGFibGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tY2FuY2VsYWJsZSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uY2FuY2VsYWJsZQogICAgICAgICoqLwogICAgICAgIHdoZW4uY2FuY2VsYWJsZSA9IHdoZW5DYW5jZWxhYmxlOwogICAgICAgIHdoZW4uYWxsID0gd2hlbi53aGVuLmFsbDsKICAgICAgICB3aGVuLmFueSA9IHdoZW4ud2hlbi5hbnk7CiAgICAgICAgd2hlbi5jaGFpbiA9IHdoZW4ud2hlbi5jaGFpbjsKICAgICAgICB3aGVuLmRlZmVyID0gd2hlbi53aGVuLmRlZmVyOwogICAgICAgIHdoZW4uaXNQcm9taXNlID0gd2hlbi53aGVuLmlzUHJvbWlzZTsKICAgICAgICB3aGVuLm1hcCA9IHdoZW4ud2hlbi5tYXA7CiAgICAgICAgd2hlbi5yZWR1Y2UgPSB3aGVuLndoZW4ucmVkdWNlOwogICAgICAgIHdoZW4uc29tZSA9IHdoZW4ud2hlbi5zb21lOwogICAgICAgIHdoZW4ucmVzb2x2ZSA9IHdoZW4ud2hlbi5yZXNvbHZlOwogICAgICAgIHdoZW4ucmVqZWN0ID0gd2hlbi53aGVuLnJlamVjdDsKICAgICAgICB3aGVuLmpvaW4gPSB3aGVuLndoZW4uam9pbjsKICAgIH0pKGV4cG9ydHMud2hlbiB8fCAoZXhwb3J0cy53aGVuID0ge30pKTsKICAgIHZhciB3aGVuID0gZXhwb3J0cy53aGVuOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gY2FtZWxDYXNlCiAgICAgICAgdmFyIHJtc1ByZWZpeCA9IC9eLW1zLS8sIHJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwgZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uIChhbGwsIGxldHRlcikgewogICAgICAgIHJldHVybiAobGV0dGVyICsgIiIpLnRvVXBwZXJDYXNlKCk7CiAgICB9OwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICJtcy0iKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogICAgfQogICAgZXhwb3J0cy5jYW1lbENhc2UgPSBjYW1lbENhc2U7CiAgICBmdW5jdGlvbiB1bkNhbWVsQ2FzZShzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyhbQS1aXSkvZywgZnVuY3Rpb24gKGFsbCwgcykgewogICAgICAgICAgICByZXR1cm4gJy0nICsgcy50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy51bkNhbWVsQ2FzZSA9IHVuQ2FtZWxDYXNlOwogICAgLy8jZW5kcmVnCiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3V0aWwnLCBbJ3RocnVzdC91dGlsL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvY2Fwc3VsZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAnLi9sb2cnLCAnaGFzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX2xvZ19fLCBfX2hhc19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZWFjaCA9IF8uZWFjaCwgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgcGx1Y2sgPSBfLnBsdWNrLCBmbGF0dGVuVG9Qcm9taXNlcyA9IHV0aWwuZmxhdHRlblRvUHJvbWlzZXMsIHRocnVzdENhY2hlID0gewogICAgfSwgX19vcHRpb25hbE1ldGhvZHMgPSBbCiAgICAgICAgLy8gT3B0aW9uYWwgbWV0aG9kcyB0aGF0IG1heSBiZSBvbiBhIG1vZHVsZQogICAgICAgICdzdGFydCcsIAogICAgICAgICdzdG9wJywgCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ2NvbmZpZycsIAogICAgICAgIAogICAgXSwgX19yZXF1aXJlZE1ldGhvZHMgPSBbCiAgICAgICAgLy8gUmVxdWlyZWQgbWV0aG9kcyB0aGF0IG11c3QgYmUgb24gZXZlcnkgbW9kdWxlCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnZGVzdHJveScsIAogICAgICAgIAogICAgXTsKICAgIC8qKgogICAgTW92ZXMgYWxsIHByb3BlcnRpZXMsIHRoYXQgc2hvdWxkIGV4aXN0IG91dHNpZGUgb2YgdGhlIG1vZHVsZSwgaW50byBhIHByaXZhdGUgb2JqZWN0IGZvciBob2xkaW5nLgogICAgCiAgICBAbWV0aG9kIG1vdmVUb1RocnVzdENhY2hlCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGZyb20gT2JqZWN0IHRvIGV4dHJhY3QgaXRlbXMgZnJvbQogICAgQHBhcmFtIHtPYmplY3R9IHRvIE9iamVjdCB0byBwbGFjZSBpdGVtcyBvbgogICAgQHBhcmFtIHtBcnJheX0gbGlzdCBJdGVtcyB0byBtb3ZlIGZyb20gdG8gdGhlIG90aGVyIG9iamVjdAogICAgKiovCiAgICBmdW5jdGlvbiBtb3ZlVG9UaHJ1c3RDYWNoZShmcm9tLCB0bywgbGlzdCkgewogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBsaXN0Lmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICB0b1tsaXN0W2ldXSA9IGZyb21bbGlzdFtpXV07CiAgICAgICAgICAgIGRlbGV0ZSBmcm9tW2xpc3RbaV1dOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGdldEV2ZW50TmFtZXNwYWNlKG5hbWUsIHByZWZpeCkgewogICAgICAgIGlmKCFwcmVmaXgpIHsKICAgICAgICAgICAgcHJlZml4ID0gJ21vZHVsZS0nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJy4nICsgKG5hbWUgPT09ICdnbG9iYWwnID8gJ2dsb2JhbCcgOiBwcmVmaXggKyBuYW1lLnJlcGxhY2UoL1wuL2csICctJykpOwogICAgfQogICAgZnVuY3Rpb24gY2FsbEZhY2FkZU1ldGhvZHMobWV0aG9kLCBtb2R1bGVDYWNoZSkgewogICAgICAgIHZhciBtID0gbW9kdWxlQ2FjaGUubW9kdWxlOwogICAgICAgIHZhciByZXN1bHRzID0gW107CiAgICAgICAgXy5mb3JPd24obW9kdWxlQ2FjaGUuZmFjYWRlcywgZnVuY3Rpb24gKGZhY2FkZSwgaSkgewogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ3RocnVzdC9jYXBzdWxlOiBDYWxsaW5nIGZhY2FkZSAiezB9IiB7MX0oKScsIGksIG1ldGhvZCkpOwogICAgICAgICAgICBpZihmYWNhZGVbbWV0aG9kXSAmJiBpc09iamVjdChmYWNhZGUpKSB7CiAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goZmFjYWRlW21ldGhvZF0uY2FsbChmYWNhZGUsIG0pKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJlc3VsdHMucHVzaCh1dGlsLnNhZmVJbnZva2UoKG0udGhydXN0KS5fX3RocnVzdENvbnZlbnRpb25zLCBtZXRob2QsIG0sIG1vZHVsZUNhY2hlLmZhY2FkZXMpKTsKICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgIH0KICAgIC8qKgogICAgVGhlIG1vZHVsZSBpcyB0aGUgaGVhcnQgb2YgdGhlIHRocnVzdCwgZXZlcnkgbW9kdWxlIGdldHMgb25lIGZhY2FkZSBwZXIgbW9kdWxlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgQGNsYXNzIHRocnVzdC5Nb2R1bGUKICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgQHBhcmFtIHtPYmplY3R9IGRlZiBUaGUgbW9kdWxlIGRlZmluaXRpb24KICAgIEBwYXJhbSB7U3RyaW5nfSBbbmFtZV0gVGhlIG1vZHVsZSBuYW1lLgogICAgKiovCiAgICB2YXIgTW9kdWxlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvL3ZhciBNb2R1bGUgPQogICAgICAgIGZ1bmN0aW9uIE1vZHVsZSh0aHJ1c3QsIGRlZiwgbmFtZSkgewogICAgICAgICAgICBuYW1lID0gdGhpcy5uYW1lID0gKG5hbWUgfHwgZGVmLm5hbWUpOwogICAgICAgICAgICBpZih0eXBlb2YgZGVmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBkZWYgPSBkZWYobmFtZSk7CiAgICAgICAgICAgICAgICBkZWYubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1pZCA9IHRoaXMubWlkID0gdGhydXN0Lm5hbWUgKyAnOicgKyBuYW1lOwogICAgICAgICAgICB2YXIgdENhY2hlID0gdGhydXN0Q2FjaGVbZGVmLmhhc2ggfHwgbWlkXTsKICAgICAgICAgICAgLy8gQ2xlYXIgYW55IHBvdGVudGlhbCBjYWNoZWQgY29uZmlnIG9iamVjdHMsIHRvIG1ha2Ugc3VyZSB0aGV5IHJlZnJlc2ggaWYgdGhlIG1vZHVsZSBpcyByZWRlZmluZWQuCiAgICAgICAgICAgIGlmKHRDYWNoZSkgewogICAgICAgICAgICAgICAgXy5rZXlzKHRDYWNoZSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHguaW5kZXhPZignY29uZmlnLicpID09PSAwOwogICAgICAgICAgICAgICAgfSkuZm9yRWFjaChmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGUgdENhY2hlW3hdOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pbnN0YW5jZSA9IGV4dGVuZChkZWYsIHRDYWNoZSAmJiB0Q2FjaGUuaW5zdGFuY2UgfHwgewogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5uYW1lID0gKHRoaXMuaW5zdGFuY2UubmFtZSB8fCBuYW1lKTsKICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5taWQgPSBtaWQ7CiAgICAgICAgICAgIGlmKCF0aGlzLmluc3RhbmNlLm5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQWxsIE1vZHVsZXMgbXVzdCBoYXZlIGEgbmFtZSEnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBNb2R1bGVzIG11c3QgaGF2ZSBhbiBpbml0IG1ldGhvZCBhbmQgYSBkZXN0cm95IG1ldGhvZCwgaXQncyB1cCB0byB0aGUgbW9kdWxlIGRldmVsb3BlciB0byBwb3B1bGF0ZSB0aGVzZSBtZXRob2RzLgogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gX19yZXF1aXJlZE1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZighZGVmW19fcmVxdWlyZWRNZXRob2RzW2ldXSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ1JlcXVpcmVkICJ7MH0iIG1ldGhvZCBub3QgZm91bmQgb24gbW9kdWxlICJ7MX0iIScsIF9fcmVxdWlyZWRNZXRob2RzW2ldLCBuYW1lKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gSWYgdGhlIG1vZHVsZSBuYW1lIGlzIHVuZGVmaW5lZCwgYnJpbmcgdGhlIG5hbWUgaW50byB0aGUgbW9kdWxlLgogICAgICAgICAgICBpZih0eXBlb2YgZGVmLm5hbWUgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICBkZWYubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRocnVzdE1vZHVsZUNhY2hlSXRlbSA9IHRocnVzdENhY2hlW21pZF0gPSBleHRlbmQodENhY2hlIHx8IHsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgX3N0YXJ0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgbmFtZTogdXRpbC5nZXRNb2R1bGVOYW1lRm9yUGF0aChuYW1lKSwKICAgICAgICAgICAgICAgIG1vZHVsZTogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGVsZXRlIHRocnVzdENhY2hlW2RlZi5oYXNoXTsKICAgICAgICAgICAgdmFyIGZhY2FkZXMgPSB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uZmFjYWRlcyB8fCAodGhydXN0TW9kdWxlQ2FjaGVJdGVtLmZhY2FkZXMgPSB7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZighdGhydXN0Ll9fY29udmVudGlvblBsdWNrUHJvcGVydGllc0NhY2hlKSB7CiAgICAgICAgICAgICAgICB0aHJ1c3QuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUgPSBmbGF0dGVuKHBsdWNrKHRocnVzdC5fX2NvbnZlbnRpb25zIHx8IFtdLCAncHJvcGVydGllcycpKS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geC5pbmRleE9mKCdjb25maWcuJykgIT09IDA7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBNb3ZlIGFsbCBzcGVjaWFsIHByb3BlcnRpZXMgb2ZmIHRvIHRoZSB0aHJ1c3QncyBpbnRlcm5hbCBtZXRob2QuCiAgICAgICAgICAgIG1vdmVUb1RocnVzdENhY2hlKHRoaXMuaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbSwgX19yZXF1aXJlZE1ldGhvZHMpOwogICAgICAgICAgICBtb3ZlVG9UaHJ1c3RDYWNoZSh0aGlzLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0sIF9fb3B0aW9uYWxNZXRob2RzKTsKICAgICAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLCB0aHJ1c3QuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUpOwogICAgICAgICAgICB1dGlsLnNhZmVJbnZva2UodGhydXN0LCAnY3JlYXRlRmFjYWRlJywgdGhydXN0LCB0aGlzLmluc3RhbmNlLCBmYWNhZGVzKTsKICAgICAgICAgICAgdGhpcy5fX25hbWVzcGFjZSA9IGdldEV2ZW50TmFtZXNwYWNlKHRoaXMuaW5zdGFuY2UubmFtZSk7CiAgICAgICAgICAgIHRoaXMudGhydXN0ID0gdGhydXN0OwogICAgICAgICAgICB0aGlzLmNhY2hlID0gdGhydXN0Q2FjaGVbbWlkXTsKICAgICAgICB9CiAgICAgICAgTW9kdWxlLnRocnVzdENhY2hlID0gdGhydXN0Q2FjaGU7CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5jb252ZW50aW9uID0gLyoqCiAgICAgICAgR2V0dGVyL1NldHRlciBmb3IgY29udmVudGlvbiBtZXRob2RzLgogICAgICAgIEdldHMgdGhlIHZhbHVlIGNvbnZlbnRpb24gcHJvcGVydHkgKGRlZmluZWQgaW4gdGhlIHByb3BlcnRpZXMgYXJyYXkgb2YgYSBmYWNhZGUpLgogICAgICAgIFNldHMgdGhlIHZhbHVlIG9mIGEgY29udmVudGlvbiBwcm9wZXJ0eSAoZm9yIHN0b3JpbmcgY29udmVudGlvbiBjb25maWd1cmF0aW9uKQogICAgICAgIAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eSBUaGUgcHJvcGVydHkgdG8gZ2V0IG9yIHNldAogICAgICAgIEBwYXJhbSB7b2JqZWN0fSBbdmFsdWVdIFRoZSB2YWx1ZSB0byBzZXQKICAgICAgICBAbWV0aG9kIGNvbnZlbnRpb24KICAgICAgICBAcmV0dXJucyB7T2JqZWN0fSBUaGUgdmFsYXVlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChwcm9wZXJ0eSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHRjID0gdGhpcy5jYWNoZTsKICAgICAgICAgICAgaWYocHJvcGVydHkuaW5kZXhPZignY29uZmlnLicpID09PSAwKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgdGNbcHJvcGVydHldID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgICAgIHRjW3Byb3BlcnR5XSA9IHRoaXMuZ2V0VmFsdWVGcm9tUGF0aChwcm9wZXJ0eSwgdGMpIHx8IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIHRjW3Byb3BlcnR5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0Y1twcm9wZXJ0eV07CiAgICAgICAgfTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLmdldFZhbHVlRnJvbVBhdGggPSBmdW5jdGlvbiAocGF0aCwgb2JqZWN0KSB7CiAgICAgICAgICAgIHZhciBwYXRocyA9IHBhdGguc3BsaXQoJy4nKSwgdiA9IG9iamVjdDsKICAgICAgICAgICAgXy5lYWNoKHBhdGhzLCBmdW5jdGlvbiAocCkgewogICAgICAgICAgICAgICAgdiA9IHYgJiYgdltwXTsKICAgICAgICAgICAgICAgIGlmKCF2KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgfTsKICAgICAgICBNb2R1bGUucHJvdG90eXBlLnRocnVzdENyZWF0ZSA9IC8qKgogICAgICAgIEluamVjdHMgdGhpcyBtb2R1bGUgaW50byB0aGUgZ2l2ZW4gdGhydXN0IGluc3RhbmNlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgdGhydXN0Q3JlYXRlCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdGhydXN0Ll9faW5qZWN0TW9kdWxlKHRoaXMpOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS50aHJ1c3RDYWxsID0gLyoqCiAgICAgICAgTWFrZXMgYSBjYWxsIHRvIGFsbCB0aGUgbW9kdWxlcyBmYWNhZGVzCiAgICAgICAgVGhlIG9yZGVyIG9mIHRoZSBjYWxsIGRlcGVuZHMgb24gdGhlIG9yZGVyIHJlcXVpcmVkLgogICAgICAgIER1cmluZyB0aGUgc3RhcnR1cCBzdGFnZSAoaW5pdCwgc3RhcnQsIHJlYWR5KSBmYWNhZGVzIGFyZSBjYWxsZWQgZmlyc3QuCiAgICAgICAgRHVyaW5nIHRoZSBzaHV0ZG93biBzdGF0ZSAoc3RvcCwgZGVzdHJveSkgZmFjYWRlcyBhcmUgY2FsbGVkIGxhc3QuCiAgICAgICAgVGhpcyBhbGxvd3MgbW9kdWxlcyB0byBzdGFydHVwIGFuZCBzaHV0ZG93biB3aWxsIGFsbCB0aGUgdG9vbHMgaXQgaGFkIHRvIGJlZ2luIHdpdGguCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB0aHJ1c3RDYWxsCiAgICAgICAgQHByb3RlY3RlZAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgdGhlIG1ldGhvZCB0byBjYWxsCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBmYWNhZGVBZnRlciBjYWxscyBmYWNhZGUgbWV0aG9kcyBiZWZvcmUgb3IgYWZ0ZXIgbW9kdWxlIG1ldGhvZC4KICAgICAgICBAcGFyYW0ge0FycmF5fSBhcmdzIEFyZ3MgdG8gYmUgcGFzc2VkIG9udG8gdGhlIG1vZHVsZSBtZXRob2QuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1ldGhvZCwgZmFjYWRlQWZ0ZXIsIGFyZ3MpIHsKICAgICAgICAgICAgdmFyIHNlcSA9IFtdLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCd0aHJ1c3QvY2Fwc3VsZTogQ2FsbGluZyBmYWNhZGVzIGZvciAiezB9IicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICB2YXIgY2FjaGUgPSB0aGlzLmNhY2hlLCBtID0gY2FjaGVbbWV0aG9kXTsKICAgICAgICAgICAgc2VxLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxGYWNhZGVNZXRob2RzKG1ldGhvZCwgY2FjaGUpOwogICAgICAgICAgICAgICAgaWYocmVzdWx0ICYmIHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihtKSB7CiAgICAgICAgICAgICAgICBzZXEucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG0uYXBwbHkodGhhdC5pbnN0YW5jZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgaWYocmVzdWx0ICYmIHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW5Ub1Byb21pc2VzKHJlc3VsdCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGZhY2FkZUFmdGVyKSB7CiAgICAgICAgICAgICAgICBzZXEucHVzaChzZXEuc2hpZnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdoZW4uc2VxdWVuY2Uoc2VxKTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuc3RhcnQgPSAvKioKICAgICAgICBTdGFydCB0aGUgbW9kdWxlLCBpbnNpZGUgdGhlIHRocnVzdCBjb250YWluZXIgaXQgd2FzIGNyZWF0ZWQgb24uCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC50aHJ1c3Quc3RhcnQodGhhdC5uYW1lKTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuc3RvcCA9IC8qKgogICAgICAgIFN0b3AgdGhlIG1vZHVsZSwgaW5zaWRlIHRoZSB0aHJ1c3QgY29udGFpbmVyIGl0IHdhcyBjcmVhdGVkIG9uLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQudGhydXN0LnN0b3AodGhhdC5uYW1lKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBNb2R1bGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5Nb2R1bGUgPSBNb2R1bGU7ICAgIAogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBtb2R1bGUgaW5zdGFuY2UuCiAgICBGb3JtYXQ6CiAgICB0aHJ1c3QvY2Fwc3VsZSF7aW5zdGFuY2V9Onttb2R1bGVOYW1lfQogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBmdW5jdGlvbiBsb2FkKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwgaW5zdGFuY2VOYW1lID0gcGFydHNbMF0sIG1vZHVsZU5hbWUgPSBwYXJ0c1sxXTsKICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgJ3RocnVzdCEnICsgaW5zdGFuY2VOYW1lCiAgICAgICAgXSwgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgbW9kdWxlID0gdGhydXN0Lm1vZHVsZXNbbW9kdWxlTmFtZV07CiAgICAgICAgICAgIGlmKCFtb2R1bGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ01vZHVsZSAiezB9IiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgInsxfSIuJywgbW9kdWxlTmFtZSwgaW5zdGFuY2VOYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9hZChtb2R1bGUpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y2Fwc3VsZS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9pbnN0YW5jZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2NhcHN1bGUnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fY2Fwc3VsZV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAvKioKICAgIEdldHMgdGhlIHRocnVzdCBpbnN0YW5jZXMuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIHdoZW4gPSB1dGlsLndoZW47CiAgICB2YXIgY2Fwc3VsZSA9IF9fY2Fwc3VsZV9fOwoKICAgIC8qKgogICAgVGhlIGF2YWlsYWJsZSB0aHJ1c3QgaW5zdGFuY2VzCiAgICBpbmRleCBieSBuYW1lCiAgICAKICAgIEBmb3IgdGhydXN0Lmluc3RhbmNlCiAgICBAcHJvcGVydHkgaW5zdGFuY2VzCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBleHBvcnRzLmluc3RhbmNlcyA9IHsKICAgIH07CiAgICAvKioKICAgIFRoZSBsb2FkaW5nIHRodXJzdCBpbnN0YW5jZXMuCiAgICBpbmRleCBieSBuYW1lCiAgICAKICAgIEBwcm9wZXJ0eSBsb2FkaW5nSW5zdGFuY2VzCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXMgPSB7CiAgICB9OwogICAgLyoqCiAgICBHZXRzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAKICAgIEBtZXRob2QgZ2V0SW5zdGFuY2UKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICBAcmV0dXJucyB7VGhydXN0fSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGdldEluc3RhbmNlKG5hbWUpIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5pbnN0YW5jZXNbbmFtZV0gfHwgbnVsbDsKICAgIH0KICAgIGV4cG9ydHMuZ2V0SW5zdGFuY2UgPSBnZXRJbnN0YW5jZTsKICAgIC8qKgogICAgRmV0Y2hzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICBUaGlzIGxvYWRzIGFzeW5jcm9ub3VzbHksIGFzIHRoZSBpbnN0YW5jZSBtYXkgbm90IGJlIGxvYWRlZAogICAgCiAgICBAbWV0aG9kIGZldGNoSW5zdGFuY2UKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgQHJldHVybnMge1Byb21pc2V9IFRvIGEgdGhydXN0IGluc3RhbmNlIHNwZWMKICAgICoqLwogICAgZnVuY3Rpb24gZmV0Y2hJbnN0YW5jZShuYW1lKSB7CiAgICAgICAgdmFyIGRlZmVyID0gZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW25hbWVdIHx8IChleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbbmFtZV0gPSB3aGVuLmRlZmVyKCkpOwogICAgICAgIHJldHVybiBkZWZlcjsKICAgIH0KICAgIGV4cG9ydHMuZmV0Y2hJbnN0YW5jZSA9IGZldGNoSW5zdGFuY2U7CiAgICAvKioKICAgIENsZWFycyB0aGUgVGhydXN0IEluc3RhbmNlIGNhY2hlLCB0aGlzIGlzIHVzZWQgZm9yIHVuaXQgdGVzdGluZywgYW5kIGNsZWFyaW5nIGFsbCB0aGUgY2FjaGUgZGF0YSBlYWNoIHJ1bi4KICAgIAogICAgQG1ldGhvZCBjbGVhckNhY2hlCiAgICBAc3RhdGljCiAgICBAcHJpdmF0ZQogICAgKiovCiAgICBmdW5jdGlvbiBjbGVhckNhY2hlKCkgewogICAgICAgIHV0aWwuXy5lYWNoKHV0aWwuXy5rZXlzKGV4cG9ydHMuaW5zdGFuY2VzKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgZXhwb3J0cy5pbnN0YW5jZXNbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgZXhwb3J0cy5pbnN0YW5jZXNbeF07CiAgICAgICAgfSk7CiAgICAgICAgdXRpbC5fLmVhY2godXRpbC5fLmtleXMoZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW3hdID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIGV4cG9ydHMubG9hZGluZ0luc3RhbmNlc1t4XTsKICAgICAgICB9KTsKICAgICAgICB1dGlsLl8uZWFjaCh1dGlsLl8ua2V5cyhjYXBzdWxlLk1vZHVsZS50aHJ1c3RDYWNoZSksIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlW3hdID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlW3hdOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5jbGVhckNhY2hlID0gY2xlYXJDYWNoZTsKICAgIC8qfSovIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWluc3RhbmNlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2NvbmZpZycsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnLi9pbnN0YW5jZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3RocnVzdEluc3RhbmNlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGNvbmZpZyB7Ki8KICAgIAogICAgdmFyIHRocnVzdEluc3RhbmNlID0gX190aHJ1c3RJbnN0YW5jZV9fOwoKICAgIC8qKgogICAgUHJvdmlkZXMgdGhydXN0IGNvbmZpZ3VyYXRpb24KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBzdWJtb2R1bGUgdGhydXN0LmNvbmZpZwogICAgKiovCiAgICAvKioKICAgIFRoaXMgcHJvcGVydHksIHRlbGxzIHRoZSBmcmFtZXdvcmsgaWYgaXQgc2hvdWxkIHRocm93IGVycm9ycyBvciBub3QuCiAgICBJbiBwcm9kdWN0aW9uIGl0J3MgcmVjb21tZW5kZWQgbm90IHRvIHRocm93IGVycm9ycywgdGhhdCB3YXkgaWYgYSBjb21wb25lbnQgZmFpbHMKICAgIHRoZXJlIGlzIGEgY2hhbmNlIHRoZSBhcHBsaWNhdGlvbiBjYW4gc3RpbGwgcmVjb3Zlci4KICAgIAogICAgQGZvciB0aHJ1c3QuY29uZmlnCiAgICBAcHJvcGVydHkgdGhyb3dFcnJvcnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCBmYWxzZQogICAgKiovCiAgICBleHBvcnRzLnRocm93RXJyb3JzID0gdHJ1ZTsKICAgIC8qKgogICAgVGVsbHMgdGhlIGZyYW1ld29yayB0byBydW4gaW4gYXN5bmMgbW9kZSwgdGhpcyBtYXkgZGVsYXkgc3RhcnQgdXAsIGJ1dCB3aWxsIG1ha2UgaW1hZ2UgbG9hZGluZyBhbmQgaW5pdGFsIHJ1bm5pbmcgYXBwZWFyIGZhc3Rlci4KICAgIAogICAgQHByb3BlcnR5IGFzeW5jCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgQGRlZmF1bHQgdHJ1ZQogICAgKiovCiAgICBleHBvcnRzLmFzeW5jID0gdHJ1ZTsKICAgIC8qKgogICAgVGVsbHMgdGhydXN0IHRvIGV4cG9zZSBlYWNoIGluc3RhbmNlIGFzIGEgZ2xvYmFsLCB0aGlzIGFsbG93cyBsZWdhY3kgY29tcG9uZW50cyB0byB1dGlsaXplIHBhcnRzIG9mIHRocnVzdCwgb3IgZWFzaWx5CiAgICBnZXQgYXQgeW91ciB0aHJ1c3QgaW5zdGFuY2UgZHVyaW5nIGRlYnVnZ2luZy4KICAgIAogICAgQHByb3BlcnR5IGV4cG9zZUdsb2JhbHMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuZXhwb3NlR2xvYmFscyA9IHRydWU7CiAgICBleHBvcnRzLnVybCA9IHsKICAgICAgICBwYXRoOiAvKioKICAgICAgICBUaGlzIHByb3BlcnR5LCBnaXZlcyB0aGUgZnJhbWV3b3JrIGl0J3MgZGVmYXVsdCBwYXRoLCBpZiBkaWZmZXJlbnQgdGhhbiAnLycKICAgICAgICAKICAgICAgICBAcHJvcGVydHkgdXJsLnBhdGgKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7U3RyaW5nfQogICAgICAgIEBkZWZhdWx0ICIvIgogICAgICAgICoqLwogICAgICAgICcvJywKICAgICAgICB0cmFkaXRpb25hbEVuY29kaW5nOiAvKioKICAgICAgICBUaGlzIHByb3BlcnR5LCB0ZWxscyB0aGUgZnJhbWV3b3JrIGhvdyBpdCBzaG91bGQgZW5jb2RlIGFycmF5IGZvcm0gZGF0YS4KICAgICAgICBJbiBnZW5lcmFsLCBmb3IgQVNQLk5FVCBiYXNlZCBhcHBsaWNhdGlvbnMsIHRyYWRpdGlvbmFsIHNob3VsZCBiZSB0cnVlLgogICAgICAgIEZvciBSdWJ5L1B5dGhvbiBiYXNlZCBhcHBsaWNhdGlvbnMsIHRoaXMgc2hvdWxkIGJlIGZhbHNlLgogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSB1cmwudHJhZGl0aW9uYWxFbmNvZGluZwogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtCb29sZWFufQogICAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgKiovCiAgICAgICAgdHJ1ZQogICAgfTsKICAgIGV4cG9ydHMubG9nID0gewogICAgICAgIGxldmVsOiAvKioKICAgICAgICBUaGlzIGxlbmRzIHRvIHRoZSBsb2cgbGV2ZWwgb2YgdGhydXN0LgogICAgICAgIAogICAgICAgIEVSUk9SOiAxCiAgICAgICAgV0FSTjogMgogICAgICAgIElORk86IDMKICAgICAgICBERUJVRzogNAogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSBsb2cubGV2ZWwKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7U3RyaW5nfQogICAgICAgIEBkZWZhdWx0IDEKICAgICAgICAqKi8KICAgICAgICA0LAogICAgICAgIGVuYWJsZWQ6IC8qKgogICAgICAgIFRoaXMgdG9nZ2xlcyBlbmFibGluZyBvbiBvciBvZmYuCiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IGxvZy5lbmFibGVkCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAqKi8KICAgICAgICB0cnVlCiAgICB9OwogICAgLyoqCiAgICBQbHVnaW5zIGZvciB0aHJ1c3QgdG8gbG9hZCwgb3ZlcnJpZGUgd2l0aCB5b3VyIG93biBzZXQgaWYgeW91IGhhdmUgYSBkaWZmZXJlbnQgc2V0LgogICAgCiAgICBAcHJvcGVydHkgcGx1Z2lucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucGx1Z2lucyA9IFtdOwogICAgLyoqCiAgICAqIFRoZSBzZXQgb2YgbW9kdWxlcyB0byBwcmVsb2FkIHdpdGggdGhlIGluaXRhbCB3aXJldXAgb2YgdGhlIFRocnVzdCBpbnN0YW5jZS4KICAgICoKICAgICogQWNjZXB0cyB0aGUgbW9kdWxlIHBhdGggYSBzdHJpbmcgb3IgdGhlIG1vZHVsZSBhcyBhbiBvYmplY3QgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQuCiAgICAqICAgV2hlcmUgYXJncyB3aWxsIGJlIGhhbmRlZCBvZmYgdG8gdGhlIG1vZHVsZSBsaWZlIGN5Y2xlIG1ldGhvZHMuCiAgICAqCiAgICAqICAgIHsKICAgICogICAgICAgIHBhdGg6ICcnLAogICAgKiAgICAgICAgYXJnczogW10KICAgICogICAgfQogICAgKgogICAgKiBAcHJvcGVydHkgbW9kdWxlcwogICAgKiBAcmVhZE9ubHkKICAgICogQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLm1vZHVsZXMgPSBbXTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbmUgaWYgdGhlIGxpZmUtY3ljbGUgaXMgY29udHJvbGxlZCBieSB0aHJ1c3QsIG9yIGEgcGFyZW50IGluc3RhbmNlLgogICAgCiAgICBAcHJvcGVydHkgY2hpbGRJbnN0YW5jZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5jaGlsZEluc3RhbmNlID0gZmFsc2U7CiAgICAvKioKICAgIFVzZWQgaW50ZXJuYWxseSBieSB0aHJ1c3QgdG8gZGV0ZXJtaW5lIGlmIHRocnVzdCBzaG91bGQgY29udHJvbCB0aGUgbGlmZS1jeWNsZSwgb3IgdGhlIGNvbnN1bWVyCiAgICAKICAgIEBwcm9wZXJ0eSBhdXRvbWF0aWNMaWZlY3ljbGUKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICAqKi8KICAgIGV4cG9ydHMuYXV0b21hdGljTGlmZWN5Y2xlID0gdHJ1ZTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbiBpZiB0aGUgdGhydXN0IGluc3RhbmNlIHNob3VsZCBhdXRvbWF0aWNhbGx5IHN0YXJ0IHVwb24gY3JlYXRpb24uCiAgICAKICAgIEBwcm9wZXJ0eSBhdXRvU3RhcnQKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICAqKi8KICAgIGV4cG9ydHMuYXV0b1N0YXJ0ID0gZmFsc2U7CiAgICAvKioKICAgIERlZmluZSB0aGUgY29udmVudGlvbnMgdGhhdCB1bmlxdWUgdG8gdGhydXN0LCB0aGV5IGFyZSBub3Qgc3BlY2lmaWMgdG8gYW55IG9uZSBwbHVnaW4uCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lcicsIAogICAgICAgICd0aHJ1c3QvY29udmVudGlvbi9hdXRvc3RhcnQnLCAKICAgICAgICAndGhydXN0L2NvbnZlbnRpb24vZGVwZW5kZW50Lm1vZHVsZXMnCiAgICBdOwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBjdXJyZW50IGNvbmZpZyBmb3IgdGhlIGN1cnJlbnQgdGhydXN0IGluc3RhbmNlLCBvciB0aGUgY29uZmlnIG9mIHRoZSBnaXZlbiBwbHVnaW4uCiAgICBBZGRpbmcgdGhlIDogY2hhcmFjdGVyIHJlcXVlc3RzIGEgc3BlY2lmaWMgY29uZmlnIHBsdWdpbi4KICAgIHRocnVzdC9jb25maWchZ2xvYmFsID0gdGhydXN0IWdsb2JhbDpjb25maWcgPSBUaHJ1c3QgaW5zdGFuY2UgY29uZmlnIGZyb20gdGhlIGluc3RhbmNlIG5hbWVkIGdsb2JhbC4KICAgIAogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIHJlYWxOYW1lID0gcGFydHNbMF0sIHBsdWdpbk5hbWUgPSBwYXJ0c1sxXSB8fCBmYWxzZTsKICAgICAgICB2YXIgaW5zdGFuY2VEZWZlcnJlZCA9IHRocnVzdEluc3RhbmNlLmZldGNoSW5zdGFuY2UocmVhbE5hbWUpOwogICAgICAgIGluc3RhbmNlRGVmZXJyZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBwbHVnaW5OYW1lICYmIGNvbnRleHQuY2ZnW3BsdWdpbk5hbWVdIHx8IGNvbnRleHQuY29uZmlnOwogICAgICAgICAgICBpZighcGx1Z2luKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsdWdpbiAiJyArIHBsdWdpbk5hbWUgKyAnIiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgIicgKyByZWFsTmFtZSArICciLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvYWQocGx1Z2luKTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMubG9hZCA9IGxvYWQ7CiAgICAvKn0qLyB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbG9nJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL2NvbmZpZycsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3RDb25maWdfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIC8qKgogICAgQSBiYXNpYyBsb2dnZXIgZm9yIHRoZSB0aHJ1c3QgZnJhbWV3b3JrLgogICAgRGlzYWJsZXMgZGVidWcgbG9nZ2luZyB3aGVuIHRocnVzdCBpcyBub3QgaW4gZGVidWcgbW9kZS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIAogICAgKiovCiAgICAKICAgIC8vIExvZyBsZXZlbHMKICAgIHZhciBMRVZFTCA9IHsKICAgICAgICBERUJVRzogNCwKICAgICAgICBJTkZPOiAzLAogICAgICAgIFdBUk46IDIsCiAgICAgICAgRVJST1I6IDEKICAgIH07CiAgICAvLyBEZWNsYXJlIG91ciB2YXJpYWJsZXMKICAgICAgICB2YXIgY29uc29sZSA9IHdpbmRvdy5jb25zb2xlLCB0aW1lcnMgPSB7CiAgICB9LCBjTG9nID0gKGNvbnNvbGUgJiYgY29uc29sZS5sb2cpIHx8IGZhbHNlLCBjV2FybiA9IChjb25zb2xlICYmIGNvbnNvbGUud2FybikgfHwgZmFsc2UsIGNJbmZvID0gKGNvbnNvbGUgJiYgY29uc29sZS5pbmZvKSB8fCBmYWxzZSwgY0Vycm9yID0gKGNvbnNvbGUgJiYgY29uc29sZS5lcnJvcikgfHwgZmFsc2UsIGNUaW1lID0gKGNvbnNvbGUgJiYgY29uc29sZVsndGltZSddKSB8fCBmYWxzZSwgY1RpbWVFbmQgPSAoY29uc29sZSAmJiBjb25zb2xlWyd0aW1lRW5kJ10pIHx8IGZhbHNlLCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgY29uZmlnTGV2ZWwgPSB0Q29uZmlnLmxvZy5sZXZlbCB8fCBMRVZFTC5FUlJPUiwgbG9nTGV2ZWwgPSBMRVZFTFtjb25maWdMZXZlbF0gfHwgKHR5cGVvZiBjb25maWdMZXZlbCA9PT0gJ3N0cmluZycgJiYgTEVWRUxbY29uZmlnTGV2ZWwudG9VcHBlckNhc2UoKV0pIHx8ICh0eXBlb2YgY29uZmlnTGV2ZWwgPT09ICdudW1iZXInICYmIGNvbmZpZ0xldmVsKSB8fCBMRVZFTC5FUlJPUjsKICAgIC8vIFZhcmlvdXMgbG9nZ2VycyB0byBoYW5kbGUgSUU4Lzkgc3VwcG9ydC4KICAgIHZhciBsb2dSdW5uZXIgPSBmdW5jdGlvbiAoY29uc29sZU1ldGhvZCwgbG9nVHlwZSkgewogICAgICAgIC8vIFNob3cgbG9ncyB3aGVuIGVuYWJsZWQgb3IgaWYgdGhleSBhcmUgZXJyb3JzCiAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgaWYoY29uc29sZU1ldGhvZCkgewogICAgICAgICAgICBpZihjb25zb2xlTWV0aG9kLmFwcGx5KSB7CiAgICAgICAgICAgICAgICBjb25zb2xlTWV0aG9kLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZU1ldGhvZChhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZighY29uc29sZU1ldGhvZCAmJiBjTG9nKSB7CiAgICAgICAgICAgIGlmKGNMb2cuYXBwbHkpIHsKICAgICAgICAgICAgICAgIGNMb2cuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjTG9nKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIC8qKgogICAgQSBiYXNpYyBsb2dnZXIgZm9yIHRoZSB0aHJ1c3QgZnJhbWV3b3JrLgogICAgRGlzYWJsZXMgZGVidWcgbG9nZ2luZyB3aGVuIHRocnVzdCBpcyBub3QgaW4gZGVidWcgbW9kZS4KICAgIAogICAgQGNsYXNzIHRocnVzdC5Mb2cKICAgICoqLwogICAgLyoqCiAgICBMb2dzIGEgZGVidWcgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGxvZyBtZXRob2QKICAgIAogICAgQG1ldGhvZCBkZWJ1ZwogICAgKiovCiAgICBmdW5jdGlvbiBkZWJ1ZygpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjTG9nKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICdsb2cnKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmRlYnVnID0gZGVidWc7CiAgICAvKioKICAgIExvZ3MgYSBpbmZvIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSBpbmZvIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgaW5mbwogICAgKiovCiAgICBmdW5jdGlvbiBpbmZvKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5JTkZPKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY0luZm8pOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ2luZm8nKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmluZm8gPSBpbmZvOwogICAgLyoqCiAgICBMb2dzIGEgd2FybiB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgd2FybiBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgCiAgICBAbWV0aG9kIHdhcm4KICAgICoqLwogICAgZnVuY3Rpb24gd2FybigpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuV0FSTikgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNXYXJuKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICd3YXJuJyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy53YXJuID0gd2FybjsKICAgIC8qKgogICAgTG9ncyBhIGVycm9yIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSBlcnJvciBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgCiAgICBAbWV0aG9kIGVycm9yCiAgICAqKi8KICAgIGZ1bmN0aW9uIGVycm9yKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5FUlJPUikgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNFcnJvcik7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnZXJyb3InKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmVycm9yID0gZXJyb3I7CiAgICAvKioKICAgIExvZ3MgYSB0aW1lIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSB0aW1lIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgdGltZQogICAgKiovCiAgICBmdW5jdGlvbiB0aW1lKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdGltZXJzW21lc3NhZ2VdID0gewogICAgICAgICAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBtc2cgPSB1dGlsLmZvcm1hdCgnezB9OiB0aW1lciBzdGFydGVkJywgbWVzc2FnZSksIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChtc2cpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1RpbWUpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy50aW1lID0gdGltZTsKICAgIC8qKgogICAgTG9ncyBhIHRpbWVFbmQgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIHRpbWVFbmQgbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIENhdXNlcyB0aGUgdGltZXIgdG8gZW5kLCBmb3IgdGhlIGdpdmVuIG1lc3NhZ2UuCiAgICAKICAgIEBtZXRob2QgdGltZUVuZAogICAgKiovCiAgICBmdW5jdGlvbiB0aW1lRW5kKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgfQogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgbG9nZ2luZyBpcyBkaXNhYmxlZC4gIFRoaXMgaXMgYXMgY2xvc2UgdG8gbm9vcCBhcyB3ZSBjYW4gZ2V0LCBpbmNhc2UgdGhlcmUgaXMgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIHRoaXMgbWV0aG9kLgogICAgICAgIGlmKCF0Q29uZmlnLmxvZy5lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYobG9nTGV2ZWwgPj0gTEVWRUwuREVCVUcpIHsKICAgICAgICAgICAgdGltZXJzW21lc3NhZ2VdLmVuZCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CiAgICAgICAgICAgIHZhciB0aW1lID0gdGltZXJzW21lc3NhZ2VdLmVuZCAtIHRpbWVyc1ttZXNzYWdlXS5zdGFydCwgbXNnID0gdXRpbC5mb3JtYXQoJ3swfTogezF9bXMnLCBtZXNzYWdlLCB0aW1lKTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChtc2cpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1RpbWVFbmQpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgfQogICAgZXhwb3J0cy50aW1lRW5kID0gdGltZUVuZDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bG9nLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2lnbml0ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnbW9kdWxlJywgJ3RocnVzdC91dGlsJywgJy4vY29uZmlnJywgJy4vY2Fwc3VsZScsICcuL2luc3RhbmNlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fcmVxdWlyZU1vZHVsZV9fLCBfX3V0aWxfXywgX19jb25maWdfXywgX190bV9fLCBfX2luc3RhbmNlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHJlcXVpcmVNb2R1bGUgPSBfX3JlcXVpcmVNb2R1bGVfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICB2YXIgdG0gPSBfX3RtX187CgogICAgdmFyIGluc3RhbmNlID0gX19pbnN0YW5jZV9fOwoKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgaXNBcnJheSA9IF8uaXNBcnJheSwgdG9BcnJheSA9IF8udG9BcnJheSwgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgZWFjaCA9IF8uZWFjaCwgbWFwID0gXy5tYXAsIGFueSA9IF8uYW55LCBhbGwgPSBfLmFsbCwgd2hlbiA9IHV0aWwud2hlbiwgZXh0ZW5kID0gXy5leHRlbmQsIGZsYXR0ZW4gPSBfLmZsYXR0ZW4sIHBsdWNrID0gXy5wbHVjaywgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBrZXlzID0gXy5rZXlzLCB1bmlvbiA9IF8udW5pb247CiAgICAvKmZ1bmN0aW9uIHJlY29uY2lsZUFycmF5cyhjb25maWcsIHNldHRpbmdzLCB0bykKICAgIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKGNvbmZpZyk7CiAgICBpZiAoc2V0dGluZ3MpCiAgICB7CiAgICBrZXlzID0gdW5pb24oXy5rZXlzKHNldHRpbmdzKSwga2V5cyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICBzZXR0aW5ncyA9IHt9OwogICAgfQogICAgZWFjaChrZXlzLCBmdW5jdGlvbiAoaSkKICAgIHsKICAgIHZhciB4ID0gc2V0dGluZ3NbaV0gfHwgY29uZmlnW2ldOwogICAgaWYgKGlzQXJyYXkoeCkpCiAgICB7CiAgICB0b1tpXSA9IHRvQXJyYXkoc2V0dGluZ3NbaV0gfHwgdG9baV0pOwogICAgfQogICAgZWxzZSBpZiAoaXNPYmplY3QoeCkgJiYgIWlzRnVuY3Rpb24oeCkpCiAgICB7CiAgICByZWNvbmNpbGVBcnJheXMoeCwgbnVsbCwgdG9baV0pOwogICAgfQogICAgfSk7CiAgICB9Ki8KICAgIGZ1bmN0aW9uIG1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpIHsKICAgICAgICBpZigoc2V0dGluZ3MpLl9fc2V0dGluZ3NNZXJnZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHNldHRpbmdzOwogICAgICAgIH0KICAgICAgICB2YXIgcmVxdWlyZUNvbmZpZyA9IHJlcXVpcmVNb2R1bGUuY29uZmlnKCksIHBsdWdpbnMgPSBbCiAgICAgICAgICAgICd0aHJ1c3QvbWVkaWF0b3InCiAgICAgICAgXS5jb25jYXQoc2V0dGluZ3MucGx1Z2lucyB8fCByZXF1aXJlQ29uZmlnLnBsdWdpbnMgfHwgY29uZmlnLnBsdWdpbnMgfHwgW10pLCBjb252ZW50aW9ucyA9IFtdLmNvbmNhdChzZXR0aW5ncy5jb252ZW50aW9ucyB8fCByZXF1aXJlTW9kdWxlLmNvbmZpZygpLmNvbnZlbnRpb25zIHx8IGNvbmZpZy5wbHVnaW5zIHx8IFtdKTsKICAgICAgICBzZXR0aW5ncyA9IF8ubWVyZ2UoewogICAgICAgIH0sIGNvbmZpZywgcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgc2V0dGluZ3MsIHsKICAgICAgICAgICAgX19zZXR0aW5nc01lcmdlZDogdHJ1ZSwKICAgICAgICAgICAgcGx1Z2luczogcGx1Z2lucywKICAgICAgICAgICAgY29udmVudGlvbnM6IGNvbnZlbnRpb25zCiAgICAgICAgfSk7CiAgICAgICAgc2V0dGluZ3MucGx1Z2lucyA9IHBsdWdpbnM7CiAgICAgICAgc2V0dGluZ3MuY29udmVudGlvbnMgPSBjb252ZW50aW9uczsKICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICB9CiAgICBleHBvcnRzLm1lcmdlU2V0dGluZ3MgPSBtZXJnZVNldHRpbmdzOwogICAgZnVuY3Rpb24gZnVzZShzZXR0aW5ncykgewogICAgICAgIHZhciBwaXBlID0gW107CiAgICAgICAgc2V0dGluZ3MgPSBtZXJnZVNldHRpbmdzKHNldHRpbmdzKTsKICAgICAgICBpZighaW5zdGFuY2UuaW5zdGFuY2VzW3NldHRpbmdzLm5hbWVdKSB7CiAgICAgICAgICAgIHBpcGUucHVzaChzdGFnZU9uZSk7CiAgICAgICAgfQogICAgICAgIHBpcGUucHVzaChzdGFnZVR3byk7CiAgICAgICAgaWYoc2V0dGluZ3MubW9kdWxlcyAmJiBzZXR0aW5ncy5tb2R1bGVzLmxlbmd0aCkgewogICAgICAgICAgICBwaXBlLnB1c2goc3RhZ2VUaHJlZSk7CiAgICAgICAgfQogICAgICAgIHZhciBwcm9taXNlID0gd2hlbi5waXBlbGluZShwaXBlLCBzZXR0aW5ncyk7CiAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLmZ1c2UgPSBmdXNlOwogICAgLyoqCiAgICBDb250cnVjdHMgYSB3aXJlIHNwZWMgZm9yIHRocnVzdCB0byBsYXVuY2ggZnJvbS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgLyoqCiAgICBNZXJnZXMgYSBhbGwgdGhlIHBsdWdpbnMgY29uZmlndXJhdGlvbnMsIHdpdGggdGhlIGRlZmF1bHQgY29uZmlnLCBhbmQgdGhlbiBmaW5hbGx5IHdpdGgKICAgIGFueSBjdXN0b21pemVkIGNvbmZpZyBmcm9tIHJlcXVpcmVqcwogICAgCiAgICBAbWV0aG9kIHN0YWdlT25lCiAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbnRzIHRvIHBhc3Mgb250byB0aGUgdGhydXN0IGluc3RhbmNlIGJlaW5nIGNyZWF0ZWQuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlT25lKHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICAgICAgICAgIHZhciBwbHVnaW5zID0gc2V0dGluZ3MucGx1Z2lucywgcmVxdWlyZUNvbmZpZyA9IHJlcXVpcmVNb2R1bGUuY29uZmlnKCksIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgIHNldHRpbmdzLnBsdWdpbnMgPSBwbHVnaW5zOwogICAgICAgIHJlcXVpcmUocGx1Z2lucy5tYXAoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgfSksIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIHBsdWdpbnMuZm9yRWFjaChmdW5jdGlvbiAocGx1Z2luLCBpKSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxKSwgcGx1Z2luU2V0dGluZ3MgPSBzZXR0aW5nc1tuYW1lXSB8fCB7CiAgICAgICAgICAgICAgICB9LCBwbHVnaW5SZXF1aXJlQ29uZmlnID0gcmVxdWlyZUNvbmZpZ1tuYW1lXSB8fCB7CiAgICAgICAgICAgICAgICB9LCBwbHVnaW5DbGFzcyA9IGFyZ3NbaV1bYXJnc1tpXS5jbGFzc05hbWVdOwogICAgICAgICAgICAgICAgaWYoIWNvbmZpZ1tuYW1lXSkgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZ1tuYW1lXSA9IF8ubWVyZ2UocGx1Z2luQ2xhc3MuY29uZmlnLCBwbHVnaW5SZXF1aXJlQ29uZmlnIHx8IHsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjb252ZW50aW9ucyA9IFtdLmNvbmNhdChwbHVnaW5TZXR0aW5ncy5jb252ZW50aW9ucyB8fCBwbHVnaW5SZXF1aXJlQ29uZmlnLmNvbnZlbnRpb25zIHx8IGNvbmZpZ1tuYW1lXS5jb252ZW50aW9ucyB8fCBbXSk7CiAgICAgICAgICAgICAgICBzZXR0aW5nc1tuYW1lXSA9IF8ubWVyZ2UoewogICAgICAgICAgICAgICAgfSwgY29uZmlnW25hbWVdLCBwbHVnaW5TZXR0aW5ncyB8fCB7CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgY29udmVudGlvbnM6IGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHNldHRpbmdzW25hbWVdLmNvbnZlbnRpb25zID0gY29udmVudGlvbnM7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWZlci5yZXNvbHZlKHNldHRpbmdzKTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZU9uZSA9IHN0YWdlT25lOwogICAgLyoqCiAgICBDcmVhdGVzIGEgdGhydXN0IGluc3RhbmNlLCBmcm9tIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgIEluY2x1ZGluZyB0aGUgcGx1Z2lucy4KICAgIAogICAgQG1ldGhvZCBzdGFnZVR3bwogICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW50cyB0byBwYXNzIG9udG8gdGhlIHRocnVzdCBpbnN0YW5jZSBiZWluZyBjcmVhdGVkLgogICAgKiovCiAgICBmdW5jdGlvbiBzdGFnZVR3byhzZXR0aW5ncykgewogICAgICAgIC8qanNoaW50IGxvb3BmdW5jOnRydWUgKi8KICAgICAgICAvLyBHZXQgdGhlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgIHZhciBsb2NhbENvbmZpZyA9IHNldHRpbmdzLCBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAvLyBNZWRpYXRvciBpcyBhIHJlcXVpcmVkIHBsdWdpbiwgaW5jbHVkZSBhbGwgdGhlIG90aGVycyBpbiBhZGRpdGlvbiB0byBpdC4KICAgICAgICAgICAgICAgIHZhciBwbHVnaW5zID0gbG9jYWxDb25maWcucGx1Z2lucywgbW9kdWxlc1RvTG9hZCA9IC8vIFRoZSBtb2R1bGVzIHRvIGxvYWQKICAgICAgICBbXSwgdGhydXN0Q29udmVudGlvbnMgPSBzZXR0aW5ncy5jb252ZW50aW9ucyB8fCBbXSwgbW9kdWxlc0NvbmZpZ3VyYXRpb25zID0gLy8gVGhlIG1vZHVsZSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgIHsKICAgICAgICAgICAgdGhydXN0OiAndGhydXN0JwogICAgICAgIH07CiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGx1Z2lucywgY3JlYXRpbmcgYSBwcm9wZXIgZGVwZW5kYW5jeSBsaXN0LgogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBwbHVnaW5zLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICB2YXIgcGx1Z2luID0gcGx1Z2luc1tpXSwgbmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxKSwgcGx1Z2luQ29uZmlnID0gbG9jYWxDb25maWdbbmFtZV07CiAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaChwbHVnaW4pOwogICAgICAgICAgICBtb2R1bGVzVG9Mb2FkLnB1c2gocGx1Z2luQ29uZmlnICYmIHBsdWdpbkNvbmZpZy5jb252ZW50aW9ucyB8fCBbXSk7CiAgICAgICAgICAgIG1vZHVsZXNDb25maWd1cmF0aW9uc1twbHVnaW5dID0gcGx1Z2luQ29uZmlnOwogICAgICAgIH0KICAgICAgICAvLyBOYW1lIGFuZCBjZmcgYXJlIGRlZmF1bHQgcHJvcGVydGllcyBvZiB0aGUgY29uZmlndXJhdGlvbiBjb250ZXh0CiAgICAgICAgICAgICAgICB2YXIgb3JkZXJlZFBsdWdpbnMgPSBbCiAgICAgICAgICAgICduYW1lJywgCiAgICAgICAgICAgICdjZmcnCiAgICAgICAgXSwgcmVsb29wID0gLy8gV2UgbG9vcCB0aHJvdWdoIHVudGlsIGFsbCB0aGUgcGx1Z2lucyBhcmUgaW4gcHJvcGVyIG9yZGVyLgogICAgICAgIHRydWUsIGlMZW4gPSBtb2R1bGVzVG9Mb2FkLmxlbmd0aCwgaSA9IDA7CiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGx1Z2lucyB1bnRpbCB3ZSBoYXZlIGEgc2V0IHRoYXQgd2lsbCBsb2FkIGluIHByb3BlciBvcmRlci4KICAgICAgICB3aGlsZShpIDwgaUxlbikgewogICAgICAgICAgICAvLyBUaGUgcGx1Z2luCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwbHVnaW4gPSBtb2R1bGVzVG9Mb2FkW2ldLCBuYW1lID0gLy8gVGhlIGltcGxpZWQgcGx1Z2luIG5hbWUKICAgICAgICAgICAgcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5Db25maWcgPSAvLyBUaGUgcGx1Z2lucyBjb25maWd1cmF0aW9uCiAgICAgICAgICAgIGxvY2FsQ29uZmlnW25hbWVdOwogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcGx1Z2luIGhhcyB0byByZXNvbHZlIGFueSBvdGhlciBwbHVnaW5zCiAgICAgICAgICAgIGlmKHBsdWdpbkNvbmZpZyAmJiBwbHVnaW5Db25maWcucmVzb2x2ZSAmJiBwbHVnaW5Db25maWcucmVzb2x2ZS5sZW5ndGggPiAwICYmICFhbGwocGx1Z2luQ29uZmlnLnJlc29sdmUsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYW55KG9yZGVyZWRQbHVnaW5zLCBmdW5jdGlvbiAoeikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB4ID09PSB6IHx8IHggPT09IHo7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkpIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBtb2R1bGVzIHRvIGxvYWQuCiAgICAgICAgICAgICAgICAvLyBBbHNvIGluY2x1ZGVzIGFueSBjb252ZW50aW9ucy4KICAgICAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaC5hcHBseShtb2R1bGVzVG9Mb2FkLCBtb2R1bGVzVG9Mb2FkLnNwbGljZShpLCAyKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZW9yZGVyIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgIG9yZGVyZWRQbHVnaW5zLnB1c2gobmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gVGhlIG1vZHVsZXMgY29uZmlnCiAgICAgICAgdmFyIG1vZHVsZXMgPSBsb2NhbENvbmZpZy5tb2R1bGVzIHx8IFtdOwogICAgICAgIC8vIFRocnVzdCBhbmQgdGhydXN0L2NhcHN1bGUgYWxzbyBuZWVkIHRvIGJlIGxvYWRlZC4KICAgICAgICBtb2R1bGVzVG9Mb2FkLnB1c2guYXBwbHkobW9kdWxlc1RvTG9hZCwgWwogICAgICAgICAgICAndGhydXN0JywgCiAgICAgICAgICAgIHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IFtdCiAgICAgICAgXSk7CiAgICAgICAgLy8gRmxhdHRlbiB0aGUgcmVzdWx0YW50IGFycmF5CiAgICAgICAgbW9kdWxlc1RvTG9hZCA9IGZsYXR0ZW4obW9kdWxlc1RvTG9hZCk7CiAgICAgICAgLy8gQ3JlYXRlIHRoZSBjb25maWd1cmF0aW9uIHNwZWMKICAgICAgICB2YXIgc3BlYyA9IHsKICAgICAgICAgICAgbmFtZTogbG9jYWxDb25maWcubmFtZSB8fCAnZ2xvYmFsJywKICAgICAgICAgICAgY2ZnOiBsb2NhbENvbmZpZwogICAgICAgIH07CiAgICAgICAgLy8gTG9hZCBldmVyeXRoaW5nCiAgICAgICAgcmVxdWlyZShtb2R1bGVzVG9Mb2FkLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEdldCByZWFkeSB0byBsb29wCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50UGx1Z2luID0gbnVsbCwgYWxsQ29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgbW9kdWxlcyBiZWluZyBsb2FkZWQKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG1vZHVsZXNUb0xvYWQubGVuZ3RoOyBpIDwgaUxlbiAtIHRocnVzdENvbnZlbnRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgcGx1Z2luIGFuZCBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbiA9IG1vZHVsZXNUb0xvYWRbaV0sIG1Db25maWcgPSBtb2R1bGVzQ29uZmlndXJhdGlvbnNbcGx1Z2luXTsKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlIGhhdmUgYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgaWYobUNvbmZpZykgewogICAgICAgICAgICAgICAgICAgIC8vIExvYWQgYSBuZXcgcGx1Z2luLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbk9iamVjdCA9IGFyZ3NbaV0sIG5hbWUgPSAvLyBHZXQgdGhlIHBsdWdpbiBuYW1lCiAgICAgICAgICAgICAgICAgICAgcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCByZXNvbHZlSXRlbXMgPSAvLyBSZXNvbHZlIGFsbCB0aGUgcmVxdWlyZWQgaXRlbXMuCiAgICAgICAgICAgICAgICAgICAgbWFwKG1Db25maWcucmVzb2x2ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNwZWNbeF07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbkNsYXNzID0gcGx1Z2luT2JqZWN0W3BsdWdpbk9iamVjdC5jbGFzc05hbWVdOwogICAgICAgICAgICAgICAgICAgIC8vIEluc3RhbnRpYXRlIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGx1Z2luID0gc3BlY1tuYW1lXSA9IHV0aWwuaW5zdGFudGlhdGUocGx1Z2luQ2xhc3MsIHJlc29sdmVJdGVtcyk7CiAgICAgICAgICAgICAgICAgICAgLy8gU2V0dXAgdGhlIGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgICAgICB9IGVsc2UgLy8gTG9hZCBhbGwgdGhlIGNvbnZlbnRpb25zCiAgICAgICAgICAgICAgICBpZihjdXJyZW50UGx1Z2luKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29udmVudGlvbnMgaW50byB0aGUgcGx1Z2luCiAgICAgICAgICAgICAgICAgICAgXy5mb3JPd24oYXJnc1tpXSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRQbHVnaW4uX19jb252ZW50aW9ucy5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIExvYWQgdGhlIGNvbnZlbnRpb25zIGludG8gdGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICAgICAgICAgICAgICBfLmZvck93bihhcmdzW2ldLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWxsQ29udmVudGlvbnMucHVzaCh4KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBUaGUgbGFzdCBjdXJyZW50IHBsdWdpbiwgd2lsbCBhbHdheXMgYmUgdGhydXN0LgogICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fY29udmVudGlvbnMgPSBhbGxDb252ZW50aW9uczsKICAgICAgICAgICAgdmFyIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyA9IGFyZ3Muc2xpY2UobW9kdWxlc1RvTG9hZC5sZW5ndGggLSB0aHJ1c3RDb252ZW50aW9ucy5sZW5ndGgpOwogICAgICAgICAgICB0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnMgPSBmbGF0dGVuKG1hcCh0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWFwKHgsIGZ1bmN0aW9uICh6KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHo7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fdGhydXN0Q29udmVudGlvbnMgPSB0aHJ1c3RDb252ZW50aW9uRGVmaW5pdGlvbnM7CiAgICAgICAgICAgIGFsbENvbnZlbnRpb25zLnB1c2guYXBwbHkoYWxsQ29udmVudGlvbnMsIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyk7CiAgICAgICAgICAgIC8vIEV4dGVuZCB0aHJ1c3Qgd2l0aCB0aGUgc3BlYwogICAgICAgICAgICBleHRlbmQoY3VycmVudFBsdWdpbiwgc3BlYyk7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoc3BlYyk7CiAgICAgICAgfSwgZGVmZXIucmVqZWN0KTsKICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgIH0KICAgIGV4cG9ydHMuc3RhZ2VUd28gPSBzdGFnZVR3bzsKICAgIC8qKgogICAgTG9hZHMgdXAgdGhlIGRlZmF1bHQgbW9kdWxlcyBhcyBpbmRpY2F0ZWQgdG8gdGhydXN0LgogICAgCiAgICBAbWV0aG9kIHN0YWdlVGhyZWUKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIHVzZSB0byBsb2FkIHRoZSBtb2R1bGVzLgogICAgKiovCiAgICBmdW5jdGlvbiBzdGFnZVRocmVlKGNvbnRleHQpIHsKICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3QsIGRlZmVyID0gd2hlbi5kZWZlcigpLCBtb2R1bGVzID0gY29udGV4dC5jZmcubW9kdWxlczsKICAgICAgICBtb2R1bGVzID0gXy5maWx0ZXIobW9kdWxlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuICF0aHJ1c3QubW9kdWxlc1t4XTsKICAgICAgICB9KTsKICAgICAgICByZXF1aXJlKG1vZHVsZXMsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIE1vZHVsZSA9IHRtLk1vZHVsZTsKICAgICAgICAgICAgLy8gR2V0IHRoZSBkZWZpbml0aW9ucwogICAgICAgICAgICB2YXIgbW9kdWxlRGVmaW5pdGlvbnMgPSBhcmdzOwogICAgICAgICAgICAvLyBMb29wIG92ZXIgYWxsIHRoZSBtb2R1bGVzCiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBtb2R1bGVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBtb2R1bGUgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2QgPSBtb2R1bGVzW2ldLCBkZWZpbml0aW9uID0gLy8gR2V0IHRoZSBkZWZpbml0aW9uCiAgICAgICAgICAgICAgICBtb2R1bGVEZWZpbml0aW9uc1tpXTsKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgaW5zdGFuY2UKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG5ldyBNb2R1bGUodGhydXN0LCBkZWZpbml0aW9uLCBtb2QpOwogICAgICAgICAgICAgICAgLy8gSW5qZWN0IGl0IGludG8gdGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgICAgICAgICAgbW9kdWxlSW5zdGFuY2UudGhydXN0Q3JlYXRlKHRocnVzdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmZXIucmVzb2x2ZShjb250ZXh0KTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZVRocmVlID0gc3RhZ2VUaHJlZTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9aWduaXRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJy4vbG9nJywgJy4vaW5zdGFuY2UnLCAnLi9pZ25pdGUnLCAnLi9jYXBzdWxlJywgJ2RvbVJlYWR5JywgJ2hhcycsICd0aHJ1c3QvY29uZmlnJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX2xvZ19fLCBfX3RocnVzdEluc3RhbmNlX18sIF9faWduaXRlU3BlY19fLCBfX21fXywgX19kb21SZWFkeV9fLCBfX2hhc19fLCBfX3RDb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgdGhydXN0SW5zdGFuY2UgPSBfX3RocnVzdEluc3RhbmNlX187CgogICAgdmFyIGlnbml0ZVNwZWMgPSBfX2lnbml0ZVNwZWNfXzsKCiAgICB2YXIgbSA9IF9fbV9fOwoKICAgIHZhciBNb2R1bGUgPSBtLk1vZHVsZTsKICAgIHZhciBkb21SZWFkeSA9IF9fZG9tUmVhZHlfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgdENvbmZpZyA9IF9fdENvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ1RocnVzdCc7CiAgICAvKioKICAgIFRoZSB0aHJ1c3QgYXBwbGljYXRpb24hCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICBAbWFpbiB0aHJ1c3QKICAgICoqLwogICAgICAgIHZhciBJTklUID0gJ2luaXQnLCBTVEFSVCA9ICdzdGFydCcsIFJFQURZID0gJ3JlYWR5JywgU1RPUCA9ICdzdG9wJywgREVTVFJPWSA9ICdkZXN0cm95JywgQ09VTlRET1dOID0gJ2NvdW50ZG93bicsIElHTklURSA9ICdpZ25pdGUnLCBPUkJJVCA9ICdvcmJpdCcsIERFUExPWSA9ICdkZXBsb3knLCBERU9SQklUID0gJ2Rlb3JiaXQnLCBTUExBU0hET1dOID0gJ3NwbGFzaGRvd24nLCBJTk9SQklUID0gJ2luT3JiaXQnLCBtZW1vaXplID0gXy5tZW1vaXplLCBlYWNoID0gXy5lYWNoLCBtYXAgPSBfLm1hcCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIGJpbmQgPSBfLmJpbmQsIGlzQXJyYXkgPSBfLmlzQXJyYXksIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCB0b0FycmF5ID0gXy50b0FycmF5LCBtZXJnZSA9IF8ubWVyZ2UsIGZsYXR0ZW4gPSBfLmZsYXR0ZW4sIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCByZXNvbHZlTWV0aG9kcyA9IFsKICAgICAgICBJTklULCAKICAgICAgICBTVEFSVCwgCiAgICAgICAgUkVBRFksIAogICAgICAgIFNUT1AsIAogICAgICAgIERFU1RST1kKICAgIF0sIGluc3RhbmNlcyA9IHRocnVzdEluc3RhbmNlLmluc3RhbmNlcywgbG9hZGluZ0luc3RhbmNlcyA9IHRocnVzdEluc3RhbmNlLmxvYWRpbmdJbnN0YW5jZXMsIHNhZmVJbnZva2UgPSB1dGlsLnNhZmVJbnZva2U7CiAgICAvLyNyZWdpb24gUnVubmVyIEZhY3RvcmllcwogICAgdmFyIHJ1blJ1bm5lckZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICB2YXIgY29udmVudGlvbk1ldGhvZCA9IChtZXRob2QgPT09IFNUT1AgJiYgU1RBUlQpIHx8IChtZXRob2QgPT09IERFU1RST1kgJiYgSU5JVCkgfHwgbWV0aG9kLCBjb252ZW50aW9uVmFsdWUgPSAhKG1ldGhvZCA9PT0gU1RPUCB8fCBtZXRob2QgPT09IERFU1RST1kpLCB1bnNldFJlYWR5ID0gbWV0aG9kID09PSBTVE9QLCBjb252ZW50aW9uQ2hlY2sgPSBjb252ZW50aW9uTWV0aG9kICE9PSBtZXRob2QsIGNvbnZlbnRpb25OYW1lID0gZm9ybWF0KCd7MH0tc3RhdHVzJywgY29udmVudGlvbk1ldGhvZCksIHJ1bm5lciA9IHJ1bm5lckZhY3RvcnkobWV0aG9kLCBjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlLCB1bnNldFJlYWR5KSwgbG9nTWVzc2FnZSA9IGZvcm1hdCgnVGhydXN0OiB7MH1pbmcgbW9kdWxlICJ7ezB9fSIgZmFpbGVkIScsIG1ldGhvZCksIHJ1bm5pbmdNZXNzYWdlID0gZm9ybWF0KCdUaHJ1c3Q6IFJ1bm5pbmcgezB9IGZvciBtb2R1bGUgInt7MH19Ii4nLCBtZXRob2QpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZXMpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighaXNBcnJheShuYW1lcykpIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gWwogICAgICAgICAgICAgICAgICAgIG5hbWVzCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzLCByZXN1bHRzID0gW107CiAgICAgICAgICAgIGVhY2gobmFtZXMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQocnVubmluZ01lc3NhZ2UsIG5hbWUpKTsKICAgICAgICAgICAgICAgIHZhciBtb2QgPSB0aGF0Lm1vZHVsZXNbbmFtZV07CiAgICAgICAgICAgICAgICBpZighbW9kICYmICF0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAvLyB0cnkgdG8gZmV0Y2ggdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm5pbmcgdGhlIHByb3BlciBkZWZlciBpbiBpdCdzIHBsYWNlCiAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRlckRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lCiAgICAgICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKG1vZHVsZURlZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jcmVhdGVNb2R1bGUobW9kdWxlRGVmbiAmJiBtb2R1bGVEZWZuLm5hbWUgfHwgbmFtZSwgbW9kdWxlRGVmbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlRGVmbi5uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbi5jaGFpbih3aGVuLmFsbChmbGF0dGVuKHJlc3VsdCkpLCBsb2FkZXJEZWZlcik7CiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXJEZWZlci5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGxvYWRlckRlZmVyLnByb21pc2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKChjb252ZW50aW9uQ2hlY2sgJiYgbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB8fCAhbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYodHJ1ZSAmJiB0Q29uZmlnLnRocm93RXJyb3JzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChydW5uZXIodGhhdCwgbmFtZSwgbW9kLCBhcmdzKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5ICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVubmVyKHRoYXQsIG5hbWUsIG1vZCwgYXJncykpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5lcnJvcihmb3JtYXQobG9nTWVzc2FnZSwgbmFtZSksIGUsIGUuc3RhY2spOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHMubGVuZ3RoICYmIHJlc3VsdHM7CiAgICAgICAgfTsKICAgIH0pOwogICAgdmFyIHJ1bm5lckZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChtZXRob2QsIGNvbnZlbnRpb25OYW1lLCBjb252ZW50aW9uVmFsdWUsIHVuc2V0UmVhZHkpIHsKICAgICAgICB2YXIgZXZlbnROYW1lID0gZm9ybWF0KCd0aHJ1c3QvbW9kdWxlL3swfScsIG1ldGhvZCksIGluZm9Gb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogezB9aW5nIG1vZHVsZSAie3swfX0iJywgbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnN1YnN0cmluZygxKSksIGRlYnVnRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IENhbGxpbmcgbW9kdWxlICJ7ezB9fSIgezB9KCknLCBtZXRob2QpLCBjb21wQWZ0ZXIgPSBtZXRob2QgPT09IFNUT1AgfHwgbWV0aG9kID09PSBERVNUUk9ZIHx8IGZhbHNlOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAodGhhdCwgbmFtZSwgbW9kLCBhcmdzKSB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIG5hbWUpKTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KGNvbnZlbnRpb25OYW1lLCBuYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0Q2FsbChtZXRob2QsIGNvbXBBZnRlciwgX19nZXRNb2R1bGVBcmdzKHRoYXQubmFtZSwgbmFtZSwgYXJncykpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhhdC5tZWRpYXRvciAmJiB0aGF0Lm1lZGlhdG9yLmZpcmUoZXZlbnROYW1lLCBuYW1lKTsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKGNvbnZlbnRpb25OYW1lLCBjb252ZW50aW9uVmFsdWUpOwogICAgICAgICAgICAgICAgaWYodW5zZXRSZWFkeSkgewogICAgICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKFJFQURZICsgJy1zdGF0dXMnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9KTsKICAgIHZhciBhbGxSdW5uZXJGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgdmFyIGluZm9Gb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogezB9aW5nIGFsbCBtb2R1bGVzLi4uIFt7ezB9fV0nLCBtZXRob2QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBtZXRob2Quc3Vic3RyaW5nKDEpKSwgcGx1cmFsTmFtZSA9IGZvcm1hdCgndGhydXN0L21vZHVsZS9hbGwvezB9JywgbWV0aG9kKSwgY2hlY2tBdXRvU3RhcnQgPSBtZXRob2QgPT09IElOSVQgfHwgbWV0aG9kID09PSBTVEFSVCB8fCBtZXRob2QgPT09IFJFQURZOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAodGhhdCkgewogICAgICAgICAgICB0aGF0Lm1lZGlhdG9yICYmIHRoYXQubWVkaWF0b3IuZmlyZShwbHVyYWxOYW1lKTsKICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSB0aGF0Lm1vZHVsZXMsIHJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoaW5mb0Zvcm1hdCwgbWFwKG1vZHVsZXMsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4geC5jb252ZW50aW9uKCdhdXRvU3RhcnQnKSAmJiBpOwogICAgICAgICAgICB9KS5qb2luKCcsICcpKSk7CiAgICAgICAgICAgIGVhY2gobW9kdWxlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIGlmKCFjaGVja0F1dG9TdGFydCB8fCAoY2hlY2tBdXRvU3RhcnQgJiYgeC5jb252ZW50aW9uKCdhdXRvU3RhcnQnKSkpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2godGhhdFttZXRob2RdKGkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHRoYXQuc3RhcnRpbmdNb2R1bGVzICYmIGNoZWNrQXV0b1N0YXJ0KSB7CiAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCB0aGF0LnN0YXJ0aW5nTW9kdWxlcy5qb2luKCcsICcpKSk7CiAgICAgICAgICAgICAgICB0aGF0W21ldGhvZF0odGhhdC5zdGFydGluZ01vZHVsZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChyZXN1bHRzKTsKICAgICAgICB9OwogICAgfSk7CiAgICBmdW5jdGlvbiBmaXJlVGhydXN0RXZlbnQodGhhdCwgZXZlbnQpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGF0Lm1lZGlhdG9yICYmIHRoYXQubWVkaWF0b3IuZmlyZShldmVudCk7CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBtZXRob2QsIHN0b3BwaW5nKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgZWFjaCh0aGF0LmNoaWxkcmVuLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgaWYoc3RvcHBpbmcpIHsKICAgICAgICAgICAgICAgIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSA9IGNoaWxkLnN0YXJ0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoY2hpbGQuY2ZnLmF1dG9TdGFydCB8fCAoIXN0b3BwaW5nICYmIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSkgfHwgKHN0b3BwaW5nICYmIGNoaWxkLnN0YXJ0ZWQpKSB7CiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKGNoaWxkW21ldGhvZF0oZmFsc2UsIHRydWUpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmKGl0ZW1zLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoaXRlbXMpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgYXJyKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuZmxhdHRlblRvUHJvbWlzZXMoYXJyLmNvbmNhdCh0aGF0LmNmZy5hc3luYyAmJiBbCiAgICAgICAgICAgIHdoZW4uZGVsYXkoMCkKICAgICAgICBdIHx8IFtdKSk7CiAgICB9CiAgICB2YXIgdGhydXN0TG9nRXZlbnQ7CiAgICBpZih0cnVlKSB7CiAgICAgICAgdGhydXN0TG9nRXZlbnQgPSBmdW5jdGlvbiAobWVzc2FnZSwgbmFtZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgbG9nLmRlYnVnKGZvcm1hdC5hcHBseShmb3JtYXQsIFsKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlCiAgICAgICAgICAgICAgICBdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhydXN0TG9nRXZlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB1dGlsLm5vb3A7CiAgICAgICAgfTsKICAgIH0KICAgIHZhciB0aHJ1c3RTaG91bGRFeGVjdXRlID0gZnVuY3Rpb24gKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCBzdG9wcGluZykgewogICAgICAgIGlmKHRoYXQucGFyZW50ICYmIHRoYXQuY2ZnLmNoaWxkSW5zdGFuY2UgJiYgIXRoYXQucGFyZW50LnN0YXJ0ZWQgJiYgIWNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIGxvZy53YXJuKGZvcm1hdCgnQ2Fubm90IGV4ZWN1dGUgb24gY2hpbGQgaW5zdGFuY2UgInswfSIgcGFyZW50IGluc3RhbmNlICJ7MX0iIG11c3QgYmUgc3RhcnRlZCBmaXJzdC4nLCB0aGF0Lm5hbWUsIHRoYXQucGFyZW50Lm5hbWUpKTsKICAgICAgICB9CiAgICAgICAgaWYoIXN0b3BwaW5nICYmIHRoYXQuc3RhcnRlZCB8fCBzdG9wcGluZyAmJiAhdGhhdC5zdGFydGVkKSB7CiAgICAgICAgICAgIGxvZy53YXJuKGZvcm1hdCgnQ2Fubm90IHN0YXJ0IHRocnVzdCBpbnN0YW5jZSAiezB9IiBzaW5jZSBpdCBhbHJlYWR5IHN0YXJ0ZWQnLCB0aGF0Lm5hbWUpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgLyoqCiAgICBHZXRzIHRoZSBtb2R1bGVzIGFyZ3VtZW50cyBmcm9tIHRoZSByZWdpc3RyYXRpb25zLgogICAgCiAgICBJZiBvcmlnaW5hbCBhcmdzIGNvbnRhaW5zIGFueXRoaW5nIGl0IGlzIHBhc3NlZCBpbnN0ZWFkIG9mIHRoZSByZWdpc3RyYXRpb25zLgogICAgSWYgdGhlIHJlZ2lzdHJhdGlvbnMgYXJlIGluIHBsYWNlIGl0IHdpbGwgcmV0dXJuIHRoZW0uCiAgICAKICAgIEBtZXRob2QgX19nZXRNb2R1bGVBcmdzCiAgICBAc3RhdGljCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlTmFtZSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbW9kdWxlIG5hbWUKICAgIEBwYXJhbSB7QXJyYXl9IG9yaWdpbmFsQXJncyBUaGUgb3JpZ2luYWwgYXJndW1lbnRzIHBhc3NlZCBpbnRvIHRoZSBjYWxsaW5nIG1ldGhvZC4KICAgICoqLwogICAgZnVuY3Rpb24gX19nZXRNb2R1bGVBcmdzKGluc3RhbmNlTmFtZSwgbmFtZSwgb3JpZ2luYWxBcmdzKSB7CiAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KG9yaWdpbmFsQXJncyk7CiAgICAgICAgaWYoYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICAgICAgfQogICAgICAgIHZhciBpbnN0YW5jZVJlZ2lzdHJhdGlvbnMgPSBUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zW2luc3RhbmNlTmFtZV07CiAgICAgICAgaWYoaW5zdGFuY2VSZWdpc3RyYXRpb25zICYmIGluc3RhbmNlUmVnaXN0cmF0aW9uc1tuYW1lXSkgewogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2VSZWdpc3RyYXRpb25zW25hbWVdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnczsKICAgIH0KICAgIC8vI2VuZHJlZ2lvbgogICAgLyoqCiAgICBUaGUgcHJpbWFyeSB0aHJ1c3QgY2xhc3MuCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuVGhydXN0CiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoaXMgdGhydXN0IGluc3RhbmNlCiAgICBAcmV0dXJucyB7VGhydXN0fQogICAgKiovCiAgICB2YXIgVGhydXN0ID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBUaHJ1c3QobmFtZSkgewogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX190aHJ1c3RDb252ZW50aW9ucyA9IFtdOwogICAgICAgICAgICB0aGlzLmNmZyA9IG1lcmdlKHRDb25maWcsIHsKICAgICAgICAgICAgICAgIGF1dG9TdGFydDogZmFsc2UsCiAgICAgICAgICAgICAgICBhc3luYzogZmFsc2UsCiAgICAgICAgICAgICAgICBjaGlsZEluc3RhbmNlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGF1dG9tYXRpY0xpZmVjeWNsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5jb25maWcgPSBtZXJnZSh0Q29uZmlnLCB7CiAgICAgICAgICAgICAgICBhdXRvU3RhcnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgY2hpbGRJbnN0YW5jZTogZmFsc2UsCiAgICAgICAgICAgICAgICBhdXRvbWF0aWNMaWZlY3ljbGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHRoaXMubW9kdWxlcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5mYWlsZWRNb2R1bGVzID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgICAgICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zID0gewogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5jcmVhdGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IHRocnVzdCBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjcmVhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdW5pcXVlIG1vZHVsZSBuYW1lLgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGUgVGhlIG1vZHVsZSBkZWZpbnRpb24uCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBwcmVCdWlsZCBIYXMgdGhpcyBtb2R1bGUgYmVlbiBwcmVidWlsdCwgaW4gb3RoZXIgd29yZHMgaGFzIGl0IGJlZW4gY3JlYXRlZCwgYnkgd2lyZS5qcyBhbmQgbmVlZHMgdG8gYmUgaW5qZWN0ZWQuCiAgICAgICAgQHJldHVybnMge01vZHVsZX0gVGhlIG5ldyBtb2R1bGUgaW5zdGFuY2UuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIG1vZCwgcHJlQnVpbHQpIHsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdUaHJ1c3Q6IENyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiAiezB9IicsIG5hbWUpKTsKICAgICAgICAgICAgdmFyIG9sZE1vZHVsZSwgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKHByZUJ1aWx0KSB7CiAgICAgICAgICAgICAgICBvbGRNb2R1bGUgPSBtb2Q7CiAgICAgICAgICAgICAgICBtb2QgPSBtb2QuaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXByZUJ1aWx0KSB7CiAgICAgICAgICAgICAgICBtb2QgPSBuZXcgbS5Nb2R1bGUodGhhdCwgbW9kLCBuYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1vZCA9IG9sZE1vZHVsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBNb2R1bGVzIGNhbm5vdCBoYXZlIGR1cGxpY2F0ZSBuYW1lcywgY2hvb3NlIGEgbmV3IG9uZS4KICAgICAgICAgICAgaWYodGhhdC5tb2R1bGVzW21vZC5uYW1lXSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnRHVwbGljYXRlIG1vZHVsZSBuYW1lICJ7MH0iLicsIG5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBtIGlzIHRoZSBtZWRpYXRvcnMgaW50ZXJuYWwgbW9kdWxlLgogICAgICAgICAgICB0aGF0Lm1vZHVsZXNbbW9kLm5hbWVdID0gbW9kOwogICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKGZvcm1hdCgnVGhydXN0OiBDcmVhdGVkIG1vZHVsZSAiezB9IicsIG5hbWUpKTsKICAgICAgICAgICAgLy8gTm90aWZ5IHRoZSBtZWRpYXRvciB0aGF0IGEgbW9kdWxlIGhhcyBiZWVuIGNyZWF0ZWQuCiAgICAgICAgICAgIHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L21vZHVsZS9jcmVhdGUnLCBuYW1lKTsKICAgICAgICAgICAgaWYodGhhdCAmJiB0aGF0LnN0YXJ0ZWQgJiYgbW9kLmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSB7CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0KG1vZC5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdGFydHVwID0gLy8jcmVnaW9uIEdsb2JhbCBSdW5uZXJzCiAgICAgICAgZnVuY3Rpb24gKGV2ZW50LCBldmVudFR5cGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KSwgCiAgICAgICAgICAgICAgICB0aGF0W2V2ZW50VHlwZV0oKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgZXZlbnQpCiAgICAgICAgICAgIF0pKTsKICAgICAgICAgICAgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKGZpcmVUaHJ1c3RFdmVudCh0aGF0LCAndGhydXN0LycgKyBldmVudFR5cGUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLl9jb3VudGRvd24gPSBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnVlICYmIHRocnVzdExvZ0V2ZW50KCdMYXVuY2ggaW5zdGFuY2UgInswfSIgaW4gNS4uLiA0Li4uIDMuLi4gMi4uLiAxLi4uJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnN0YXJ0dXAoQ09VTlRET1dOLCBJTklUKTsKICAgICAgICAgICAgdHJ1ZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBoYXMgYmVlbiBpbml0YWxpemVkLicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY291bnRkb3duID0gLyoqCiAgICAgICAgQmVnaW5zIHRoZSBjb3VudGRvd24gdG8gdGhydXN0cyBzdGFydC4KICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjb3VudGRvd24KICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgY291bnRkb3duIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGF0LmNmZy5hdXRvbWF0aWNMaWZlY3ljbGUgJiYgKCF0aGF0LmNmZy5jaGlsZEluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFRocnVzdC5sYXVuY2hTZXF1ZW5jZSh0aGF0LCBjYWxsZWRCeVBhcmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoYXQuX2NvdW50ZG93bihjYWxsZWRCeVBhcmVudCk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmlnbml0ZSA9IC8qKgogICAgICAgIEJlZ2lucyB0aGUgaW5naXRpb24gYXMgdGhydXN0IHN0YXJ0cyB1cC4KICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBpZ25pdGUKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aGUgaW5naXRpb24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRydWUgJiYgdGhydXN0TG9nRXZlbnQoJ0ZpcmluZyByb2NrZXRzIGZvciB0aHVyc3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnN0YXJ0dXAoSUdOSVRFLCBTVEFSVCk7CiAgICAgICAgICAgIHRydWUgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaGFzIGJlZW4gc3RhcnRlZC4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLm9yYml0ID0gLyoqCiAgICAgICAgVGhydXN0IHByZXBhcmVzIGZvciBvcmJpdC4KICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24uCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBvcmJpdAogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRocnVzdCBpcyBpbiBvcmJpdC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnVlICYmIHRocnVzdExvZ0V2ZW50KCdGaXJpbmcgc3RhZ2UgdHdvIHRocnVzdGVycyBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSkoKTsKICAgICAgICAgICAgdmFyIGRvbVJlYWR5RGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIGRvbVJlYWR5RGVmZXIucHJvbWlzZS50aGVuKGZpcmVUaHJ1c3RFdmVudCh0aGF0LCAndGhydXN0L2RvbS9yZWFkeScpKTsKICAgICAgICAgICAgZG9tUmVhZHkoZG9tUmVhZHlEZWZlci5yZXNvbHZlKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIGRvbVJlYWR5RGVmZXIucHJvbWlzZSwgCiAgICAgICAgICAgICAgICBzYWZlSW52b2tlKHRoYXQuX19jb252ZW50aW9ucywgT1JCSVQsIHRoYXQpLCAKICAgICAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBPUkJJVCkKICAgICAgICAgICAgXSkpOwogICAgICAgICAgICB0cnVlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIGFsbW9zdCByZWFkeS4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlcGxveSA9IC8qKgogICAgICAgIFRocnVzdCBkZXBsb3lzIGNvbXBvbmVudHMgaW4gb3JiaXQKICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZXBsb3kKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaGFzIGZ1bGx5IGRlcGxveWVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRydWUpIHsKICAgICAgICAgICAgICAgIHZhciB0aW1lU3RhcnQgPSB0aGF0LmNvbmZpZy5kZWJ1Zy50aW1lU3RhcnQsIHRpbWVFbmQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSwgc3RhcnRUaW1lID0gKHRpbWVFbmQgLSB0aW1lU3RhcnQpLCB0dG9EaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHRvJyk7CiAgICAgICAgICAgICAgICBpZih0dG9EaXYpIHsKICAgICAgICAgICAgICAgICAgICB0dG9EaXYuaW5uZXJIVE1MID0gc3RhcnRUaW1lICsgJ21zJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgdGhhdC5yZWFkeSgpLCAKICAgICAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBERVBMT1kpCiAgICAgICAgICAgIF0pKS50aGVuKGZpcmVUaHJ1c3RFdmVudCh0aGF0LCAndGhydXN0L3JlYWR5JykpOwogICAgICAgICAgICB0cnVlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIG5vdyByZWFkeS4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmluT3JiaXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhhdC5zdGFydGVkID0gdHJ1ZTsKICAgICAgICAgICAgY2hpbGRyZW5DYWxsTWV0aG9kKHRoYXQsIElOT1JCSVQpOwogICAgICAgICAgICBpZih0cnVlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KTsKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTdGFydGVkIGluICcgKyBzdGFydFRpbWUgKyAnbXMnKTsKICAgICAgICAgICAgICAgIHZhciB0dHJEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHRyJyk7CiAgICAgICAgICAgICAgICBpZih0dHJEaXYpIHsKICAgICAgICAgICAgICAgICAgICB0dHJEaXYuaW5uZXJIVE1MID0gc3RhcnRUaW1lICsgJ21zJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zaHV0ZG93biA9IGZ1bmN0aW9uIChldmVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBldmVudCwgdHJ1ZSksIAogICAgICAgICAgICAgICAgdGhhdFtldmVudFR5cGVdKCksIAogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC8nICsgZXZlbnRUeXBlKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fZGVvcmJpdCA9IGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCB0cnVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRydWUgJiYgdGhydXN0TG9nRXZlbnQoJ1JlZW50ZXJpbmcgZWFydGhzIGF0bW9zcGhlcmUgZm9yIHRocnVzdCBpbnN0YW5jZSAiezB9Ii4nLCB0aGF0Lm5hbWUpOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHRoaXMuc2h1dGRvd24oREVPUkJJVCwgU1RPUCk7CiAgICAgICAgICAgIHRydWUgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IHN0b3BwZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5kZW9yYml0ID0gLyoqCiAgICAgICAgQmVnaW5zIHRoZSBkZW9yYml0IGFzIHRocnVzdCBzaHV0ZG93bi4KICAgICAgICBTaHV0ZG93biBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgogICAgICAgIAogICAgICAgIEBtZXRob2QgZGVvcmJpdAogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQsIHRydWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhhdC5jZmcuYXV0b21hdGljTGlmZWN5Y2xlICYmICghdGhhdC5jZmcuY2hpbGRJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLnNlcXVlbmNlKFsKICAgICAgICAgICAgICAgICAgICBfLmJpbmQodGhhdC5fZGVvcmJpdCwgdGhhdCksIAogICAgICAgICAgICAgICAgICAgIF8uYmluZCh0aGF0LnNwbGFzaGRvd24sIHRoYXQpCiAgICAgICAgICAgICAgICBdLCBjYWxsZWRCeVBhcmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoYXQuX2Rlb3JiaXQoY2FsbGVkQnlQYXJlbnQpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zcGxhc2hkb3duID0gLyoqCiAgICAgICAgQmVnaW5zIHRoZSBzcGxhc2hkb3duIGFzIHRocnVzdCBzaHV0ZG93bi4KICAgICAgICBTaHV0ZG93biBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLCBvciBtb2R1bGUgbWV0aG9kLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3BsYXNoZG93bgogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQsIHRydWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ1ZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGFuZGluZyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBhdGxhbnRpYyBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zaHV0ZG93bihTUExBU0hET1dOLCBERVNUUk9ZKTsKICAgICAgICAgICAgdHJ1ZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBub3cgYmVpbmcgZGVzdHJveWVkJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5tb2R1bGVNZXRob2QgPSBmdW5jdGlvbiAobWV0aG9kLCBuYW1lLCBhcmdzLCByZXZlcnNlLCBkZXBlbmRlbnRNZXRob2RzLCBzdGFydGVkTWV0aG9kcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHBpcGUgPSBbXTsKICAgICAgICAgICAgaWYoIW5hbWUpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBhbGxSdW5uZXJGYWN0b3J5KG1ldGhvZCkodGhhdCk7CiAgICAgICAgICAgICAgICBpZihyZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgICAgICBpZighaXNBcnJheShuYW1lKSkgewogICAgICAgICAgICAgICAgbmFtZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgbmFtZQogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gKG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGRlcGVuZGVudE1ldGhvZHMgJiYgZGVwZW5kZW50TWV0aG9kcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBpdGVtcyA9IHsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gbmFtZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSBuYW1lc1tpXSwgbW9kID0gdGhhdC5tb2R1bGVzW25dOwogICAgICAgICAgICAgICAgICAgIGVhY2goZGVwZW5kZW50TWV0aG9kcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWl0ZW1zW3hdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1t4XSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFyZXZlcnNlICYmICghbW9kIHx8ICFtb2QuY29udmVudGlvbih4ICsgJy1zdGF0dXMnKSkgfHwgKHJldmVyc2UgJiYgbW9kLmNvbnZlbnRpb24oeCArICctc3RhdHVzJykpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1t4XS5wdXNoKG4pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlYWNoKGRlcGVuZGVudE1ldGhvZHMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgaWYoaXRlbXNbeF0gJiYgaXRlbXNbeF0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlbih0aGF0W3hdLmFwcGx5KHRoYXQsIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1t4XQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlbihydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgIG5hbWVzCiAgICAgICAgICAgICAgICBdLmNvbmNhdChhcmdzKSkpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHRoYXQuc3RhcnRlZCAmJiBzdGFydGVkTWV0aG9kcyAmJiBzdGFydGVkTWV0aG9kcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGVhY2goc3RhcnRlZE1ldGhvZHMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcGlwZS5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4odGhhdFt4XS5hcHBseSh0aGF0LCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lcwogICAgICAgICAgICAgICAgICAgICAgICBdLmNvbmNhdChhcmdzKSkpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLnBpcGVsaW5lKHBpcGUpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoSU5JVCwgbmFtZSwgYXJncywgZmFsc2UpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQubW9kdWxlTWV0aG9kKFNUQVJULCBuYW1lLCBhcmdzLCBmYWxzZSwgWwogICAgICAgICAgICAgICAgSU5JVAogICAgICAgICAgICBdLCBbCiAgICAgICAgICAgICAgICBSRUFEWQogICAgICAgICAgICBdKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUucmVhZHkgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChSRUFEWSwgbmFtZSwgYXJncywgZmFsc2UsIFsKICAgICAgICAgICAgICAgIElOSVQsIAogICAgICAgICAgICAgICAgU1RBUlQKICAgICAgICAgICAgXSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChTVE9QLCBuYW1lLCBhcmdzLCB0cnVlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgbWV0aG9kID0gREVTVFJPWTsKICAgICAgICAgICAgcmV0dXJuIHRoYXQubW9kdWxlTWV0aG9kKERFU1RST1ksIG5hbWUsIGFyZ3MsIHRydWUsIFsKICAgICAgICAgICAgICAgIFNUT1AKICAgICAgICAgICAgXSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLl9faW5qZWN0TW9kdWxlID0gLy8jZW5kcmVnaW9uCiAgICAgICAgLyoqCiAgICAgICAgSW5qZWN0cyBhIHByZWNvbnN0cnVjdGVkIG1vZHVsZSBpbnRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBfX2luamVjdE1vZHVsZQogICAgICAgIEBwcml2YXRlCiAgICAgICAgQHBhcmFtIHtNb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGluamVjdC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kdWxlKSB7CiAgICAgICAgICAgIHRoaXMuY3JlYXRlKG1vZHVsZS5uYW1lLCBtb2R1bGUsIHRydWUpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5jcmVhdGVNb2R1bGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbW9kdWxlIGZyb20gdGhlIGdpdmVuIGRlZmluaXRpb24gb2JqZWN0LCB3aXRoIHRoZSBnaXZlbiBuYW1lLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY3JlYXRlTW9kdWxlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZHVsZURlZm4gVGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIG1vZHVsZURlZm4pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZih0aGF0Lm1vZHVsZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZXNbbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG1vZHVsZSA9IG5ldyBNb2R1bGUodGhhdCwgbW9kdWxlRGVmbiwgbmFtZSk7CiAgICAgICAgICAgIHRoYXQuX19pbmplY3RNb2R1bGUobW9kdWxlKTsKICAgICAgICAgICAgcmV0dXJuIG1vZHVsZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3Bhd24gPSAvKioKICAgICAgICBMYXVuY2hlcyBhbm90aGVyIGNoaWxkIG1vZHVsZSBmb3IgdGhydXN0LgogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3Bhd24KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgdGhhdCByZXNvbHZlcyBvbmNlIHRoZSBjaGlsZCBpbnN0YW5jZSBoYXMgZnVsbHkgbG9hZGVkLiAgUmVzb2x2ZXMgd2l0aCB0aGUgY29udGV4dCB0aGF0IGNvbnRhaW5zIHRoZSB0aHJ1c3QgaW5zdGFuY2UgYW5kIGFsbCBwbHVnaW5zIHRoYXQgd2VyZSBsb2FkZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHNldHRpbmdzKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIFRocnVzdC5sYXVuY2goZXh0ZW5kKHsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgY2hpbGRJbnN0YW5jZTogdHJ1ZQogICAgICAgICAgICB9LCBzZXR0aW5ncyksIHRydWUpLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdDsKICAgICAgICAgICAgICAgIHRoYXQuY2hpbGRyZW4ucHVzaCh0aHJ1c3QpOwogICAgICAgICAgICAgICAgdGhydXN0LnBhcmVudCA9IHRoYXQ7CiAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnJlZ2lzdGVyTW9kdWxlID0gLyoqCiAgICAgICAgUmVnaXN0ZXJzIGEgc3BlY2lmaWMgbW9kdWxlIG5hbWUsIGFuZCBhcmd1bWVudHMuICBUaGUgYXJndW1lbnRzIHdpbGwgYmUgdXNlZCB3aGVuIGluaXRhbnRpYXRpbmcgdGhlIG1vZHVsZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHJlZ2lzdGVyTW9kdWxlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lIHRvIGFzc2lnbiB0aGUgYXJndW1lbnRzIHdpdGguCiAgICAgICAgQHBhcmFtIHtPYmplY3QqfSBhcmd1bWVudHMsIGFkZGl0aW9uYWwgYXJndW1lbnRzIHRoYXQgd2lsbCBiZSBwYXNzZWQgb250byB0aGUgbW91ZGxlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBUaHJ1c3QucmVnaXN0ZXJNb2R1bGUuYXBwbHkoVGhydXN0LCBbCiAgICAgICAgICAgICAgICB0aGF0Lm5hbWUKICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QubGF1bmNoU2VxdWVuY2UgPSBmdW5jdGlvbiBsYXVuY2hTZXF1ZW5jZShpbnN0YW5jZSwgY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHdoZW4uc2VxdWVuY2UoWwogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLl9jb3VudGRvd24sIGluc3RhbmNlKSwgCiAgICAgICAgICAgICAgICBfLmJpbmQoaW5zdGFuY2UuaWduaXRlLCBpbnN0YW5jZSksIAogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLm9yYml0LCBpbnN0YW5jZSksIAogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLmRlcGxveSwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5pbk9yYml0LCBpbnN0YW5jZSkKICAgICAgICAgICAgXSwgY2FsbGVkQnlQYXJlbnQpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmxhdW5jaCA9IC8qKgogICAgICAgIEluaXRhbGl6ZXMgYSBuZXcgVGhydXN0IGluc3RhbmNlIGJhc2VkIG9uIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGxhdW5jaAogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIG1vZHVsZSB0byBpbmplY3QKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBsYXVuY2goc2V0dGluZ3MsIGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2dsb2JhbCcKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXNldHRpbmdzLm5hbWUpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLm5hbWUgPSAnZ2xvYmFsJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0cnVlKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy5kZWJ1ZyA9IHsKICAgICAgICAgICAgICAgICAgICB0aW1lU3RhcnQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldHRpbmdzID0gaWduaXRlU3BlYy5tZXJnZVNldHRpbmdzKHNldHRpbmdzKTsKICAgICAgICAgICAgdmFyIHBpcGUgPSBbCiAgICAgICAgICAgICAgICBpZ25pdGVTcGVjLmZ1c2UKICAgICAgICAgICAgXTsKICAgICAgICAgICAgdmFyIHNldHVwRGVmZXIgPSBUaHJ1c3QuX19mZXRjaEluc3RhbmNlKHNldHRpbmdzLm5hbWUpOwogICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdCwgbW9kdWxlcyA9IHRocnVzdC5zdGFydGluZ01vZHVsZXMgPSBjb250ZXh0LmNmZy5tb2R1bGVzLCBjb25maWcgPSB0aHJ1c3QuY29uZmlnID0gdGhydXN0LmNmZzsKICAgICAgICAgICAgICAgIGluc3RhbmNlc1t0aHJ1c3QubmFtZV0gPSB0aHJ1c3Q7CiAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHNldHRpbmdzLmF1dG9tYXRpY0xpZmVjeWNsZSkgewogICAgICAgICAgICAgICAgcGlwZS5wdXNoKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRocnVzdCA9IGNvbnRleHQudGhydXN0LCBkID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICAgICAgICAgIFRocnVzdC5sYXVuY2hTZXF1ZW5jZSh0aHJ1c3QsIGNhbGxlZEJ5UGFyZW50KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQucmVzb2x2ZShjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5wcm9taXNlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBpcGVsaW5lID0gd2hlbi5waXBlbGluZShwaXBlLCBzZXR0aW5ncykudGhlbihmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNldHVwRGVmZXIucmVzb2x2ZShjb250ZXh0KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIFdlJ3JlIG9ubHkgZ29pbmcgdG8gZXhwb3NlIGdsb2JhbHMgaWYgcmVxdWVzdGVkLiAgVGhpcyBpcyBhIHBvdGVudGlhbCB1c2VjYXNlIHRoYXQgbWF5IGJlIG5lZWRlZCBmb3Igc29tZSB0ZWFtcy4KICAgICAgICAgICAgaWYodENvbmZpZy5leHBvc2VHbG9iYWxzKSB7CiAgICAgICAgICAgICAgICBpZighd2luZG93WydUaHJ1c3QnXSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvd1snVGhydXN0J10gPSBUaHJ1c3Q7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwaXBlbGluZS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93W3NldHRpbmdzLm5hbWVdID0gY29udGV4dDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwaXBlbGluZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5nZXRJbnN0YW5jZSA9IC8qKgogICAgICAgIEdldHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGdldEluc3RhbmNlCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICAgICAgQHJldHVybnMge1RocnVzdH0gVGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIGdldEluc3RhbmNlKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRocnVzdEluc3RhbmNlLmdldEluc3RhbmNlKG5hbWUpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0Ll9fZmV0Y2hJbnN0YW5jZSA9IC8qKgogICAgICAgIEZldGNocyBhIG5hbWVkIHRocnVzdCBzdGFuY2UgaWYgaXQgZXhpc3RzLgogICAgICAgIFRoaXMgbG9hZHMgYXN5bmNyb25vdXNseSwgYXMgdGhlIGluc3RhbmNlIG1heSBub3QgYmUgbG9hZGVkCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBfX2ZldGNoSW5zdGFuY2UKICAgICAgICBAc3RhdGljCiAgICAgICAgQHByaXZhdGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaW5zdGFuY2UgbmFtZQogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUbyBhIHRocnVzdCBpbnN0YW5jZSBzcGVjCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gX19mZXRjaEluc3RhbmNlKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRocnVzdEluc3RhbmNlLmZldGNoSW5zdGFuY2UobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QuY3JlYXRlTW9kdWxlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyBtb2R1bGUgYW5kIGhhbmRzIGl0IG9mZiB0byB0aGUgZ2l2ZW4gaW5zdGFuY2UsIGlmIHRoYXQgaW5zdGFuY2UgZXhpc3RzLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY3JlYXRlTW9kdWxlCiAgICAgICAgQHN0YXRpYwogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZSBuYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZHVsZURlZm4gVGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTW9kdWxlKGluc3RhbmNlTmFtZSwgbmFtZSwgbW9kdWxlRGVmbikgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBUaHJ1c3QuZ2V0SW5zdGFuY2UoaW5zdGFuY2VOYW1lKTsKICAgICAgICAgICAgaWYoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgIHZhciBtb2R1bGUgPSBuZXcgTW9kdWxlKGluc3RhbmNlLCBtb2R1bGVEZWZuLCBuYW1lKTsKICAgICAgICAgICAgICAgIGluc3RhbmNlLl9faW5qZWN0TW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucmVnaXN0ZXJNb2R1bGUgPSAvKioKICAgICAgICBSZWdpc3RlcnMgYSBzcGVjaWZpYyBtb2R1bGUgbmFtZSwgYW5kIGFyZ3VtZW50cy4gIFRoZSBhcmd1bWVudHMgd2lsbCBiZSB1c2VkIHdoZW4gaW5pdGFudGlhdGluZyB0aGUgbW9kdWxlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgcmVnaXN0ZXJNb2R1bGUKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlTmFtZSBUaGUgdGhydXN0IGluc3RhbmNlIHRoZSBtb2R1bGUgaXMgdG8gYmUgYXNzb2NpYXRlZCB3aXRoLgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZSB0byBhc3NpZ24gdGhlIGFyZ3VtZW50cyB3aXRoLgogICAgICAgIEBwYXJhbSB7T2JqZWN0Kn0gYXJndW1lbnRzLCBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0aGF0IHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIG1vdWRsZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyTW9kdWxlKGluc3RhbmNlTmFtZSwgbmFtZSkgewogICAgICAgICAgICBpZighaW5zdGFuY2VOYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc3RhbmNlTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighbmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCduYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFUaHJ1c3QuX19tb2R1bGVSZWdpc3RyYXRpb25zW2luc3RhbmNlTmFtZV0pIHsKICAgICAgICAgICAgICAgIFRocnVzdC5fX21vZHVsZVJlZ2lzdHJhdGlvbnNbaW5zdGFuY2VOYW1lXSA9IHsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cykuc2xpY2UoMik7CiAgICAgICAgICAgIGlmKFRocnVzdC5fX21vZHVsZVJlZ2lzdHJhdGlvbnNbaW5zdGFuY2VOYW1lXVtuYW1lXSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnTW9kdWxlICJ7MH0iIGFscmVhZHkgcmVnaXN0ZXJlZCB0byBpbnN0YW5jZSAiezF9IicsIG5hbWUsIGluc3RhbmNlTmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFRocnVzdC5fX21vZHVsZVJlZ2lzdHJhdGlvbnNbaW5zdGFuY2VOYW1lXVtuYW1lXSA9IGFyZ3MgfHwgW107CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QuX19nZXRNb2R1bGVBcmdzID0gX19nZXRNb2R1bGVBcmdzOwogICAgICAgIHJldHVybiBUaHJ1c3Q7CiAgICB9KSgpOwogICAgZXhwb3J0cy5UaHJ1c3QgPSBUaHJ1c3Q7ICAgIAogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBjdXJyZW50IHRodXJzdCBpbnN0YW5jZSwgYnkgZXhwZWN0ZWQgbmFtZS4KICAgIEFkZGluZyB0aGUgOiBjaGFyYWN0ZXIgcmVxdWVzdHMgYSBzcGVjaWZpYyBwbHVnaW4uCiAgICB0aHJ1c3QhZ2xvYmFsID0gVGhydXN0IGluc3RhbmNlCiAgICB0aHJ1c3QhZ2xvYmFsOmRvbSA9IFRoZSB0aHJ1c3QgZG9tIHBsdWdpbiBpbnN0YW5jZQogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBmdW5jdGlvbiBsb2FkKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwgcmVhbE5hbWUgPSBwYXJ0c1swXSwgcGx1Z2luTmFtZSA9IHBhcnRzWzFdIHx8ICd0aHJ1c3QnOwogICAgICAgIHZhciBpbnN0YW5jZVByb21pc2UgPSBUaHJ1c3QuX19mZXRjaEluc3RhbmNlKHJlYWxOYW1lKTsKICAgICAgICBpbnN0YW5jZVByb21pc2UucHJvbWlzZS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBjb250ZXh0W3BsdWdpbk5hbWVdOwogICAgICAgICAgICBpZighcGx1Z2luKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdQbHVnaW4gInswfSIgZG9lcyBub3QgZXhpc3Qgb24gdGhydXN0IGluc3RhbmNlICJ7MX0iLicsIHBsdWdpbk5hbWUsIHJlYWxOYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9hZChwbHVnaW4pOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdCcsIFsndGhydXN0L21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvY29udmVudGlvbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEEgQ29udmVudGlvbiBhbGxvd3MgdGhydXN0IHRvIGJlIGFzIGV4dGVuZGFibGUgYXMgcG9zc2libGUsIGJ5IGdpdmluZyBleHRlbnNpb24gcG9pbnRzIGF0IGV2ZXJ5IHN0ZXAgYWxvbmcgdGhlIHdheS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgdmFyIG1ldGhvZHMgPSBbCiAgICAgICAgJ2NyZWF0ZScsIAogICAgICAgICdpbml0JywgCiAgICAgICAgJ3N0YXJ0JywgCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAnZGVzdHJveScsIAogICAgICAgICdjb3VudGRvd24nLCAKICAgICAgICAnaWduaXRlJywgCiAgICAgICAgJ29yYml0JywgCiAgICAgICAgJ2Rlb3JiaXQnLCAKICAgICAgICAnc3BsYXNoZG93bicKICAgIF07CiAgICAvKioKICAgIFRoZSBjb252ZW50aW9uIGNsYXNzLCB0YWtlcyBhbiBvdmVybG9hZGVkIHNldCBvZiBtZXRob2RzLCBmb3IgYW55IG1ldGhvZCB0aGF0IG5lZWRzIHRvIGJlIG92ZXJsb2FkZWQuCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuQ29udmVudGlvbgogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge09iamVjdH0gbWV0aG9kcyBBbiBvYmplY3Qgb2YgYXBwbGljYWJsZSBtZXRob2RzLgogICAgKiovCiAgICB2YXIgQ29udmVudGlvbiA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQ29udmVudGlvbihtZXRob2RPdmVycmlkZXMpIHsKICAgICAgICAgICAgXy5leHRlbmQodGhpcywgbWV0aG9kT3ZlcnJpZGVzKTsKICAgICAgICAgICAgdmFyIGtleXMgPSBfLmRpZmZlcmVuY2UobWV0aG9kcywgXy5pbnRlcnNlY3Rpb24obWV0aG9kcywgXy5rZXlzKG1ldGhvZE92ZXJyaWRlcykpKTsKICAgICAgICAgICAgXy5lYWNoKGtleXMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICBpZihfLmlzRnVuY3Rpb24odGhpc1t4XSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBub29wIGlzIHVzZWQgaW4gc2FmZWludm9rZSwgYXMgYSBzYWZlIGlnbm9yZSBmdW5jdGlvbiwgbm8gb3RoZXIgbm9vcCB3aWxsIHdvcmsgY29ycmVjdGx5LgogICAgICAgICAgICAgICAgICAgIHRoaXNbeF0gPSB1dGlsLm5vb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0KICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5jcmVhdGUgPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgY3JlYXRlIG9mIGEgbW9kdWxlLCBnZW5lcmFsbHkgdXNlZCB0byBjcmVhdGUgYSBmYWNhZGUsIHRoYXQgaXMgdGhlbiBib3VuZCB0byB0aGUgbW9kdWxlLgogICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSBpbnN0YW5jZS4KICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBBbGwgdGhlIGZhY2FkZXMgYWxyZWFkeSBhdHRhY2hlZCB0byB0aGUgbW9kdWxlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuaW5pdCA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBpbml0IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIGluaXQgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIGluaXQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5zdGFydCA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBzdGFydCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBzdGFydCBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5yZWFkeSA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCByZWFkeSBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyByZWFkeSBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2QgcmVhZHkKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5zdG9wID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHN0b3AgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3Mgc3RvcCBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2Qgc3RvcAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmRlc3Ryb3kgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3QgZGVzdHJveSBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBkZXN0cm95IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZXN0cm95CiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuY291bnRkb3duID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgY291bnRkb3duCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmlnbml0ZSA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgc3RhcnQgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBpZ25pdGUKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUub3JiaXQgPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHJlYWR5IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2Qgb3JiaXQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuZGVvcmJpdCA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgc3RvcCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGRlb3JiaXQKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuc3BsYXNoZG93biA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgZGVzdHJveSBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIHNwbGFzaGRvd24KICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgcmV0dXJuIENvbnZlbnRpb247CiAgICB9KSgpOwogICAgZXhwb3J0cy5Db252ZW50aW9uID0gQ29udmVudGlvbjsgICAgCn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbnZlbnRpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZXZlbnRzJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL2xvZycsICcuL2NvbmZpZycsICdoYXMnLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19sb2dfXywgX190Q29uZmlnX18sIF9faGFzX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIC8vICAgICBCYWNrYm9uZS5qcyAwLjkuMQogICAgLy8gICAgIChjKSAyMDEwLTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KICAgIC8vICAgICBCYWNrYm9uZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICAgIC8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246CiAgICAvLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCiAgICAvKioKICAgIFRocnVzdCBFdmVudHMgYXJlIGJhc2VkIG9mZiBvZiB0aGUgQmFja2JvbmUgZXZlbnQgbW9kZWwsIHdpdGggc3BlY2lhbCBhZGRpdGlvbnMuCiAgICAKICAgICogRXZlbnRzIGNhbiBiZSBmaXJlZCBhc3luY3Jvbm91c2x5LgogICAgKiBFdmVudHMgY2FuIGJlIG5hbWVzcGFjZWQuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciB0Q29uZmlnID0gX190Q29uZmlnX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBFdmVudE5vZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEV2ZW50Tm9kZSgpIHsKICAgICAgICAgICAgdGhpcy50YWlsID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubmFtZXNwYWNlID0gJyc7CiAgICAgICAgICAgIHRoaXMub25jZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gRXZlbnROb2RlOwogICAgfSkoKTsKICAgIGV4cG9ydHMuRXZlbnROb2RlID0gRXZlbnROb2RlOyAgICAKICAgIHZhciBjcmVhdGVBc3luY0V2ZW50ID0gZnVuY3Rpb24gKG9iamVjdCkgewogICAgICAgIHZhciBmID0gZnVuY3Rpb24gZihldmVudHMpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3RyaWdnZXIuYXBwbHkob2JqZWN0LCBbCiAgICAgICAgICAgICAgICBmYWxzZQogICAgICAgICAgICBdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICB9OwogICAgICAgIGYuYXN5bmMgPSBmdW5jdGlvbiAoZXZlbnRzKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF90cmlnZ2VyLmFwcGx5KG9iamVjdCwgWwogICAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICBdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICB9OwogICAgICAgIHJldHVybiBmOwogICAgfTsKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgYXN5bmNGaXJlLCBub29wID0gdXRpbC5ub29wLCB3aGVuID0gdXRpbC53aGVuLCBzaXplID0gXy5zaXplLCBlYWNoID0gXy5lYWNoLCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQsIGV4dGVuZCA9IF8uZXh0ZW5kLCBmb3JtYXQgPSB1dGlsLmZvcm1hdDsKICAgIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy8sIEFMTCA9ICdhbGwnLCBTVEFSQUxMID0gJyphbGwnOwogICAgLyoqCiAgICBOb3JtYWxpemVzIHRoZSBnaXZlbiBldmVudHMgdG8gdGhlIGV4cGVjdGVkIG5hbWVzcGFjZS4KICAgIAogICAgQG1ldGhvZCBub3JtYWxpemVFdmVudHMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFRoZSBldmVudHMgZGVsaW1pdGVkIGJ5IGEgc3BhY2UKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2UgVGhlIG5hbWVzcGFjZSwgaW5jbHVkaW5nIHByZWZpeGVkICcuJwogICAgKiovCiAgICBmdW5jdGlvbiBub3JtYWxpemVFdmVudHMoZXZlbnRzLCBuYW1lc3BhY2UpIHsKICAgICAgICB2YXIgZXZlbnRzQXJyYXkgPSBldmVudHMuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGV2ZW50c0FycmF5Lmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICBpZihldmVudHNBcnJheVtpXS5pbmRleE9mKCcuJykgPT09IC0xKSB7CiAgICAgICAgICAgICAgICBldmVudHNBcnJheVtpXSA9IGV2ZW50c0FycmF5W2ldICsgbmFtZXNwYWNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBldmVudHNBcnJheS5qb2luKCcgJyk7CiAgICB9CiAgICAvKioKICAgIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KICAgIAogICAgQG1ldGhvZCBfdHJpZ2dlcgogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7Qm9vbGVhbn0gYXN5bmMgRmlyZSBldmVudCBhc3luYyBvciBzeW5jCiAgICBAcGFyYW0ge09iamVjdH0gZXZlbnRzIFRoZSBldmVudHMgdG8gYmUgZmlyZWQuCiAgICBkZWxpbWl0ZWQgYnkgYSBzcGFjZS4KICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgQHJldHVybnMgSWYgYXN5bmMgdGhlbiByZXR1cm5zIGEgUHJvbWlzZSwgd2hlcmUgdGhlIGZpcnN0IGFyZ3VtZW50IGNvbnRhaW5zIGFsbCB0aGUgcmV0dXJuZWQgdmFsdWVzLCBhcyBhbiBhcnJheQogICAgSWYgc3luYyB0aGVuIHJldHVybnMgYW4gYXJyYXkgb2YgdGhlIHJldHVybiB2YWx1ZXMuCiAgICBJZiBtb3JlIHRoYW4gb25lIGV2ZW50LCByZXR1cm5zIGFuIG9iamVjdCBvZiBhcnJheXMgb3IgcHJvbWlzZXMsIHdpdGggdGhlIGtleSBmb3IgZWFjaCBldmVudC4KICAgICoqLwogICAgZnVuY3Rpb24gX3RyaWdnZXIoYXN5bmMsIGV2ZW50cykgewogICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGV2ZW50LCBub2RlLCBjYWxscywgdGFpbCwgYXJncywgYWxsLCByZXN0LCBuYW1lc3BhY2UsIG9uY2VOb2RlczsKICAgICAgICBpZighKGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzKSkgewogICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICB9CiAgICAgICAgYWxsID0gY2FsbHMuYWxsOwogICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgICAgIHdoaWxlKGV2ZW50ID0gZXZlbnRzQXJyYXkuc2hpZnQoKSkgewogICAgICAgICAgICBpZihub2RlID0gY2FsbHNbZXZlbnRdKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyTm9kZXModGhhdCwgZXZlbnQsIGFzeW5jLCBub2RlLCByZXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihub2RlID0gYWxsKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyTm9kZXModGhhdCwgQUxMLCBhc3luYywgbm9kZSwgWwogICAgICAgICAgICAgICAgICAgIGV2ZW50CiAgICAgICAgICAgICAgICBdLmNvbmNhdChyZXN0KSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIFRyaWdnZXJzIGFsbCBldmVudHMgb24gYSBub2RlLgogICAgQWxzbyB1bmJpbmRzIGFueSBub2RlIHRoYXQgaXMgc2V0IHRvIG9ubHkgYmUgY2FsbGVkIG9uY2UuCiAgICAKICAgIEBtZXRob2QgdHJpZ2dlck5vZGVzCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGV2ZW50IGNvbnRhaW5lciBjb250ZXh0LgogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudCB0byBiZSBib3VuZCBvciB1bmJvdW5kLgogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7T2JqZWN0fSBub2RlIFRoZSBub2RlIGxpbmtlZCBsaXN0LgogICAgQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIHBhc3Mgb250byB0aGUgdHJpZ2dlcmVkIG5vZGVzCiAgICAKICAgICoqLwogICAgZnVuY3Rpb24gdHJpZ2dlck5vZGVzKHRoYXQsIGV2ZW50LCBhc3luYywgbm9kZUxpc3QsIGFyZ3MpIHsKICAgICAgICB2YXIgdGFpbCwgb25jZU5vZGVzID0gW107CiAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ3swfTogdHJpZ2dlcmluZyB7MX0gZXZlbnQgInsyfSInLCB0aGF0Ll9fcHViU3ViTmFtZSwgYXN5bmMgJiYgJ2FzeW5jJyB8fCAnJywgZXZlbnQpKTsKICAgICAgICBlYWNoKG5vZGVMaXN0LCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgICAgICB3aGlsZSgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJDYWxsYmFjayhhc3luYywgbm9kZS5jYWxsYmFjaywgbm9kZS5jb250ZXh0IHx8IHRoYXQsIGFyZ3MpOwogICAgICAgICAgICAgICAgbm9kZS5vbmNlICYmIG9uY2VOb2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYob25jZU5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICBlYWNoKG9uY2VOb2RlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHRoYXQudW5zdWJzY3JpYmUoZXZlbnQsIHguY2FsbGJhY2ssIHguY29udGV4dCwgeC5uYW1lc3BhY2UpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIEludm9rZXMgYSB0cmlnZ2VyIGNhbGxiYWNrCiAgICAKICAgIEBtZXRob2QgdHJpZ2dlckNhbGxiYWNrCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjYWxsaW5nIGNvbnRleHQKICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBjYWxsIHRoZSBjYWxsYmFjayB3aXRoLgogICAgQHJldHVybnMge09iamVjdH0gVGhlIHJldHVybmVkIHZhbHVlLgogICAgRm9yIGFzeW5jIGNhbGxzLCB0aGlzIGlzIGEgcHJvbWlzZQogICAgRm9yIHN5bmMgY2FsbHMgdGhpcyBpcyB0aGUgdmFsdWUgZnJvbSB0aGUgbWV0aG9kLgogICAgKiovCiAgICBmdW5jdGlvbiB0cmlnZ2VyQ2FsbGJhY2soYXN5bmMsIGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgaWYoYXN5bmMpIHsKICAgICAgICAgICAgZGVmZXIodHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpLCAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cnkgIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgaWYodENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIENyZWF0ZXMgYW4gYXN5bmMgZXZlbnQgaGFuZGxlcgogICAgCiAgICBAbWV0aG9kIGFzeW5jRXZlbnRGYWN0b3J5CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZAogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGNhbGxpbmcgY29udGV4dAogICAgQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGguCiAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjYWxsYmFjayBmb3IgdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgICoqLwogICAgZnVuY3Rpb24gdHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgUmVzdWJzY3JpYmVzIHRvIHRoZSBhcHByb3ByaWF0ZSBldmVudHMKICAgIAogICAgQG1ldGhvZCBfb2ZmUHJvY2Vzc05vZGUKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGV4dAogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudAogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBldmVudCBjYWxsYmFjayB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtPYmplY3R9IFtjb250ZXh0XSBUaGUgZXZlbnQgY29udGV4dCB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lc3BhY2VdIFRoZSBuYW1lc3BhY2UgdG8gdW5zdWJzY3JpYmUKICAgICoqLwogICAgZnVuY3Rpb24gX29mZlByb2Nlc3NOb2RlKHRoYXQsIGV2ZW50LCBub2RlLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIHZhciB0YWlsLCBjYiwgY3R4LCBuczsKICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICBjYiA9IG5vZGUuY2FsbGJhY2s7CiAgICAgICAgICAgIGN0eCA9IG5vZGUuY29udGV4dDsKICAgICAgICAgICAgbnMgPSBub2RlLm5hbWVzcGFjZTsKICAgICAgICAgICAgaWYoKGNhbGxiYWNrICYmIGNiICE9PSBjYWxsYmFjaykgfHwgKGNvbnRleHQgJiYgY3R4ICE9PSBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoZXZlbnQgKyAobnMgJiYgKCcuJyArIG5zKSB8fCAnJyksIGNiLCBjdHgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBHZXRzIHRoZSBuYW1lc3BhY2UgaW5mb3JtYXRpb24sIHRoZSByZWFsIGV2ZW50IHRvIHBhc3MgYmFjayBvbnRvIHRoZSBtZXRob2RzLgogICAgCiAgICBAbWV0aG9kIGdldE5hbWVzcGFjZURhdGEKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGNhcHR1cmUgbmFtZXNwYWNlIGRhdGEgZnJvbS4KICAgIEByZXR1cm5zIHtPYmplY3R9IENvbnRhaW5pbmcgZXZlbnQgYW5kIG5hbWVzcGFjZS4KICAgICoqLwogICAgZnVuY3Rpb24gZ2V0TmFtZXNwYWNlRGF0YShldmVudCkgewogICAgICAgIHZhciBuc0luZGV4ID0gKGV2ZW50IHx8ICcnKS5pbmRleE9mKCcuJyksIGhhc05zID0gbnNJbmRleCA+IC0xLCBuYW1lc3BhY2UgPSBoYXNOcyA/IGV2ZW50LnN1YnN0cmluZyhuc0luZGV4ICsgMSkgOiB1bmRlZmluZWQsIGV2ZW50ID0gaGFzTnMgPyBldmVudC5zdWJzdHJpbmcoMCwgbnNJbmRleCkgOiBldmVudDsKICAgICAgICBpZihuc0luZGV4ID09PSAwKSB7CiAgICAgICAgICAgIGV2ZW50ID0gU1RBUkFMTDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LAogICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgIFRocnVzdCBFdmVudHMgYXJlIGJhc2VkIG9mZiBvZiB0aGUgQmFja2JvbmUgZXZlbnQgbW9kZWwsIHdpdGggc3BlY2lhbCBhZGRpdGlvbnMuCiAgICAKICAgICogRXZlbnRzIGNhbiBiZSBmaXJlZCBhc3luY3Jvbm91c2x5LgogICAgKiBFdmVudHMgY2FuIGJlIG5hbWVzcGFjZWQuCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuRXZlbnRzCiAgICAqKi8KICAgIGV4cG9ydHMuRXZlbnRzID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZXZlbnRzID0gewogICAgICAgICAgICBzdWJzY3JpYmU6IC8qKgogICAgICAgICAgICBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgICAgICAgICAgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnRzIGFyZSBmaXJlZC4KICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICAgICAgQHBhcmFtIHtCb29sZWFufSBvbmNlIENhbGwgdGhpcyBldmVudCBvbmx5IG9uY2UuCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbHMsIGV2ZW50LCBub2RlLCB0YWlsLCBsaXN0LCBuZDsKICAgICAgICAgICAgICAgIHRoaXMuX19uYW1lc3BhY2UgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoaXMuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICAgICAgICAgIGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzIHx8ICh0aGlzLl9jYWxsYmFja3MgPSB7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBpbW11dGFibGUgY2FsbGJhY2sgbGlzdCwgYWxsb3dpbmcgdHJhdmVyc2FsIGR1cmluZwogICAgICAgICAgICAgICAgLy8gbW9kaWZpY2F0aW9uLiAgVGhlIHRhaWwgaXMgYW4gZW1wdHkgb2JqZWN0IHRoYXQgd2lsbCBhbHdheXMgYmUgdXNlZAogICAgICAgICAgICAgICAgLy8gYXMgdGhlIG5leHQgbm9kZS4KICAgICAgICAgICAgICAgIHdoaWxlKGV2ZW50ID0gZXZlbnRzQXJyYXkuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgICAgIG5kID0gZ2V0TmFtZXNwYWNlRGF0YShldmVudCk7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSBuZC5ldmVudDsKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gY2FsbHNbZXZlbnRdIHx8IChjYWxsc1tldmVudF0gPSB7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgbGlzdCA9IGxpc3RbbmQubmFtZXNwYWNlXTsKICAgICAgICAgICAgICAgICAgICBub2RlID0gbGlzdCA/IGxpc3QudGFpbCA6IG5ldyBFdmVudE5vZGUoKTsKICAgICAgICAgICAgICAgICAgICBub2RlLm5leHQgPSB0YWlsID0gbmV3IEV2ZW50Tm9kZSgpOwogICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fX2RlZmF1bHRDb250ZXh0IHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBub2RlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgaWYobmQubmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihvbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUub25jZSA9IG9uY2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhbGxzW2V2ZW50XVtuZC5uYW1lc3BhY2VdID0gewogICAgICAgICAgICAgICAgICAgICAgICB0YWlsOiB0YWlsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXh0OiBsaXN0ID8gbGlzdC5uZXh0IDogbm9kZQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25jZTogLyoqCiAgICAgICAgICAgIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgYGV2ZW50c2AsIHRvIGEgYGNhbGxiYWNrYAogICAgICAgICAgICBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KICAgICAgICAgICAgCiAgICAgICAgICAgIEVhY2ggZXZlbnQgd2lsbCBvbmx5IGJlIGNhbGxlZCBvbmNlLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBvbmNlCiAgICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY29udGV4dCB0byBiaW5kIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIHRvLgogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN1YnNjcmliZTogLyoqCiAgICAgICAgICAgIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MKICAgICAgICAgICAgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGNhbGxiYWNrcyBmb3IgdGhlCiAgICAgICAgICAgIGV2ZW50LiBJZiBgZXZlbnRgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgdW5zdWJzY3JpYmUKICAgICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBTcGF2ZSBzZXBlcmF0ZWQgZXZlbnRzCiAgICAgICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnQsIGNhbGxzLCBub2RlLCBuZCwgb3VyTnMsIG5hbWVzcGFjZSwgdGhhdCA9IHRoaXMsIGhhc05zOwogICAgICAgICAgICAgICAgb3VyTnMgPSB0aGF0Ll9fbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgb3VyTnMgJiYgKG91ck5zID0gb3VyTnMuc3Vic3RyaW5nKDEpKTsKICAgICAgICAgICAgICAgIC8vIE5vIGV2ZW50cywgb3IgcmVtb3ZpbmcgKmFsbCogZXZlbnRzLgogICAgICAgICAgICAgICAgaWYoIShjYWxscyA9IHRoYXQuX2NhbGxiYWNrcykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZighKGV2ZW50cyB8fCBjYWxsYmFjayB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFvdXJOcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhhdC5fY2FsbGJhY2tzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYnMgPSB0aGF0Ll9jYWxsYmFja3M7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSBpbiBjYnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYnNbaV1bb3VyTnNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2l6ZShjYnNbaV0pID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNic1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgbGlzdGVkIGV2ZW50cyBhbmQgY29udGV4dHMsIHNwbGljaW5nIHRoZW0gb3V0IG9mIHRoZQogICAgICAgICAgICAgICAgLy8gbGlua2VkIGxpc3Qgb2YgY2FsbGJhY2tzIGlmIGFwcHJvcHJpYXRlLgogICAgICAgICAgICAgICAgb3VyTnMgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoYXQuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cyA/IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKSA6IF8ua2V5cyhjYWxscyk7CiAgICAgICAgICAgICAgICB3aGlsZShldmVudCA9IGV2ZW50c0FycmF5LnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgICAgICBuZCA9IGdldE5hbWVzcGFjZURhdGEoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gbmQuZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIGhhc05zID0gISFuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgaWYoIW91ck5zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGNhbGxzW2V2ZW50XSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdW291ck5zXTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNpemUoY2FsbHNbZXZlbnRdKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZighbm9kZSB8fCAhKGNhbGxiYWNrIHx8IGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvKmlmIChldmVudCAhPT0gU1RBUkFMTCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSovCiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnQgIT09IFNUQVJBTEwgJiYgIWNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBldmVudCwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudCA9PT0gQUxMIHx8ICFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgaW4gY2FsbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGhhc05zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBpLCBub2RlLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX19wdWJTdWJOYW1lOiAvKioKICAgICAgICAgICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAgICAgICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgICAgICAgICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBmaXJlCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgICAgICAgICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICAgICAgICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgICAgICAgICBAcmV0dXJucyB7QXJyYXkgb2YgVmFsdWVzfSBJZiBtb3JlIHRoYW4gb24gZXZlbnQgaXMgZmlyZWQsIGFuIE9iamVjdCBvZiBBcnJheXMgaXMgcmV0dXJuZWQuCiAgICAgICAgICAgICoqLwogICAgICAgICAgICAnRXZlbnRzJywKICAgICAgICAgICAgaW5pdEV2ZW50czogLyoqCiAgICAgICAgICAgIEluaXQncyB0aGUgRXZlbnQgbW9kdWxlLgogICAgICAgICAgICBUaGlzIGlzIG9ubHkgcmVxdWlyZWQgaWYgeW91IHdpc2ggdG8gdXNlIGZpcmUuYXN5bmMsIGFuZCBuYW1lc3BhY2luZy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgaW5pdEV2ZW50cwogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZGVmYXVsdENvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZSA9IHRoaXMucHVibGlzaCA9IGNyZWF0ZUFzeW5jRXZlbnQodGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLmluaXRFdmVudHMgPSBub29wOwogICAgICAgICAgICAgICAgdGhpcy5fX3B1YlN1Yk5hbWUgPSB0aGlzLm5hbWUgfHwgJ0V2ZW50cyc7CiAgICAgICAgICAgICAgICBpZih0aGlzLm5hbWUgJiYgIXRoaXMuX19uYW1lc3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlID0gJy4nICsgdGhpcy5uYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fX2RlZmF1bHRDb250ZXh0ID0gZGVmYXVsdENvbnRleHQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZXh0ZW5kOiAvKioKICAgICAgICAgICAgRXh0ZW5kcyBFdmVudHMgaW50byB0aGUgZ2l2ZW4gb2JqZWN0LgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBleHRlbmQKICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IHRvIFRoZSBvYmplY3Qgb3QgZXh0ZW5kIGV2ZW50cyBvbnRvCiAgICAgICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gW2luaXRdIE9wdGlvbmFsbHkgaW5pdCB0aGUgZXZlbnRzLgogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgICAgICBfLmV4dGVuZCh0bywgZXhwb3J0cy5FdmVudHMpOwogICAgICAgICAgICAgICAgZGVsZXRlIHRvLmV4dGVuZDsKICAgICAgICAgICAgICAgIGluaXQgJiYgdG8uaW5pdEV2ZW50cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRvOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudHMuZmlyZSA9IGV2ZW50cy5wdWJsaXNoID0gY3JlYXRlQXN5bmNFdmVudCh7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgIH0pKCk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50cy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9mYWNhZGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJy4vY2Fwc3VsZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX190bV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgdG0gPSBfX3RtX187CgogICAgdmFyIE1vZHVsZSA9IHRtLk1vZHVsZTsKICAgIC8qKgogICAgCiAgICBUaGUgRmFjYWRlIG1vZHVsZSBvZmZlcnMgdGhlIGFiaWxpdHkgdG8gY3JlYXRlIGFuIGludGVyZmFjZSBvciBzaW1pbGFyIGNvbmNlcHQuCiAgICBXaXRoIHRoZSBGYWNhZGUgaW4gdGhydXN0LCBpdCBhbGxvd3MgeW91IHRvIGNhcHR1cmUgZXZlbnRzIGZyb20gYSBtb2R1bGUsIHdoZW4gbG9hZGVkIHZpYSBjb252ZW50aW9uLgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEZhY2FkZSBoYXMgdGhlc2UgYnVpbHQgaW4gbWV0aG9kczoKICAgICogaW5pdAogICAgKiBzdGFydAogICAgKiByZWFkeQogICAgKiBzdG9wCiAgICAqIGRlc3Ryb3kKICAgIAogICAgQmVoaW5kIHRoZSBzY2VuZXMgdGhlIGZhY2FkZSBtZXRob2RzLCBpbnZva2UgYW55IGNvbnZlbnRpb25zIGxvYWRlZCBmb3IgdGhlIHBsdWdpbi4KICAgIAogICAgQGNsYXNzIHRocnVzdC5GYWNhZGUKICAgICoqLwogICAgdmFyIHRocnVzdENhY2hlID0gTW9kdWxlLnRocnVzdENhY2hlOwogICAgdmFyIGZhY2FkZU1ldGhvZHMgPSBbCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdkZXN0cm95JwogICAgXSwgZGVmYXVsdFByb3RvdHlwZSA9IHsKICAgIH07CiAgICBmdW5jdGlvbiBjb252ZW50aW9uRnVuY3Rpb25GYWN0b3J5KG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWVzID0gW107CiAgICAgICAgICAgIGlmKG0gJiYgISgobSkuY29udmVudGlvbikpIHsKICAgICAgICAgICAgICAgIG0gPSB0aHJ1c3RDYWNoZVttLm1pZF0ubW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuX19jb252ZW50aW9ucykgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIG5hbWUsIG0sIHRoYXQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIG1ldGhvZFdyYXAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgZi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9OwogICAgfQogICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgZGVmYXVsdFByb3RvdHlwZVttZXRob2RdID0gY29udmVudGlvbkZ1bmN0aW9uRmFjdG9yeShtZXRob2QpOwogICAgfQogICAgLyoqCiAgICBGYWNhZGUgaW5pdAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgaW5pdAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RhcnQKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgc3RhcnQgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCBzdGFydAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgcmVhZHkKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCByZWFkeQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RvcAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2Qgc3RvcAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgZGVzdHJveQogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgZGVzdHJveQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBtb2R1bGUgaW5zdGFuY2UKICAgIAogICAgRm9ybWF0OgogICAgdGhydXN0L2NhcHN1bGUhe2luc3RhbmNlfTp7cGx1Z2luTmFtZX06e2hhc2hLZXl9CiAgICAKICAgIGhhc0tleTogaXMgYSB1bmlxdWUga2V5LCB0aGF0IHRoZSBtb2R1bGUgc2hhcmVzIHdpdGggdGhlIGZhY2FkZSwgYWxsb3dzIGZvciBkZWZpbmluZyBkZXBlbmRlbmNpZXMKICAgIGluIHlvdXIgZGVmaW5lIGJsb2NrLCBhbmQgZ2V0IGFjY2VzcyB0byB0aGUgbW9kdWxlcyBmYWNhZGUuCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQG9ic29sZXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIGluc3RhbmNlTmFtZSA9IHBhcnRzWzBdLCBwbHVnaW4gPSBwYXJ0c1sxXSwgcGx1Z2luTmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxIHx8IDApLCBoYXNoS2V5ID0gcGFydHNbMl07CiAgICAgICAgaWYoIWluc3RhbmNlTmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc3RhbmNlTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICB9CiAgICAgICAgaWYoIXBsdWdpbk5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwbHVnaW5OYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgIH0KICAgICAgICBpZighaGFzaEtleSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2hhc2hLZXkgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgfQogICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAndGhydXN0IScgKyBpbnN0YW5jZU5hbWUKICAgICAgICBdLCBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciB0aHJ1c3RQbHVnaW4gPSB0aHJ1c3RbcGx1Z2luTmFtZV07CiAgICAgICAgICAgIGlmKCF0aHJ1c3RQbHVnaW4pIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgIHBsdWdpbgogICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgICAgICAgICBsb2FkKHApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRocnVzdE1vZHVsZUNhY2hlSXRlbSA9IHRocnVzdENhY2hlW2hhc2hLZXldIHx8ICh0aHJ1c3RDYWNoZVtoYXNoS2V5XSA9IHsKICAgICAgICAgICAgICAgIGZhY2FkZXM6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnN0YW5jZTogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIGZhY2FkZSA9IHRocnVzdFBsdWdpbi5jcmVhdGVGYWNhZGUodGhydXN0LCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzKTsKICAgICAgICAgICAgbG9hZChmYWNhZGUpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY2FkZShpbml0TWV0aG9kKSB7CiAgICAgICAgdmFyIGYgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgRmFjYWRlID0gZnVuY3Rpb24gKG1vZCkgewogICAgICAgICAgICAgICAgaW5pdE1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYodGhpc1ttZXRob2RdICE9PSBkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1ttZXRob2RdID0gXy53cmFwKHRoaXNbbWV0aG9kXSwgbWV0aG9kV3JhcChkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm1vZCA9IG1vZDsKICAgICAgICAgICAgICAgIC8vdGhpcy5pbml0KG1vZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBGYWNhZGUucHJvdG90eXBlID0gXy5leHRlbmQoewogICAgICAgICAgICAgICAgdXBkYXRlRmFjYWRlOiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgICAgICAgICBpbml0TWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGRlZmF1bHRQcm90b3R5cGUpOwogICAgICAgICAgICByZXR1cm4gRmFjYWRlOwogICAgICAgIH0pKCk7CiAgICAgICAgcmV0dXJuIGY7CiAgICB9CiAgICBleHBvcnRzLmNyZWF0ZUZhY2FkZSA9IGNyZWF0ZUZhY2FkZTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZmFjYWRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2NvbnZlbnRpb24vYXV0b3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbiddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9tZWRpYXRvcl9fIENvbnZlbnRpb24gLSBBdXRvIFN0YXJ0CiAgICAqCiAgICAqIFRoZSBhdXRvIHN0YXJ0IHByb3BlcnR5IGFsbG93cyBmb3IgYSBtb2R1bGUsIHRvIGJlIGF1dG9tYXRpY2FsbHkgc3RhcnRlZCBvbmNlIGl0IGlzCiAgICAqIGluY2x1ZGVkIGludG8gYSB0aHJ1c3QgaW5zdG5hY2UsIHdpdGhvdXQgaGF2aW5nIHRvIGV4cGxpY2l0eSBjYWxsIHN0YXJ0IG9uIHRoZSBtb2R1bGUuCiAgICAqCiAgICAqCiAgICAqIFRoaXMgaXMgdXNlZnVsIGZvciBjZXJ0aWFuIHR5cGVzIG9mIG1vZHVsZXMsIHVzdWFsbHkgcGVyc2lzdGFudCBvbmVzIHRoYXQgYWx3YXlzIG5lZWQgdG8gbG9hZCByZWdhcmRsZXNzLgogICAgKiBGb3IgZXhhbXBsZSBhIG5hdmlnYXRpb24gbW9kdWxlLCBvciB1c2VyIHNldHRpbmdzIG1vZHVsZS4KICAgICoKICAgICogQGZvciB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgYXV0b1N0YXJ0CiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgJ2NvbmZpZy5hdXRvU3RhcnQnCiAgICAgICAgXQogICAgfTsKICAgIGV4cG9ydHMuYXV0b3N0YXJ0ID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWF1dG9zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lcicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIGFueUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9hbnknLAogICAgICAgIGNoYW5nZUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9jaGFuZ2UnCiAgICB9LCBhbnkgPSBfLmFueSwgYmluZCA9IF8uYmluZCwgQ09OVEFJTkVSID0gJ2NvbmZpZy5jb250YWluZXInLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXI7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIENPTlRBSU5FUgogICAgICAgIF0sCiAgICAgICAgY2hhbmdlOiBmdW5jdGlvbiAobW9kLCBjb250YWluZXIpIHsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUgJiYgY29udGFpbmVyICYmIGNvbnRhaW5lclZhbHVlID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZC5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIGRlZmVyKGJpbmQobW9kLnN0b3AsIG1vZCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IuZmlyZShldmVudC5jaGFuZ2VDb250YWluZXIsIGNvbnRhaW5lclZhbHVlKTsKICAgICAgICAgICAgICAgIC8vIFN1YnNjcmlwdGlvbnMgZ2V0IHVuc3Vic2NyaWJlZCB3aGVuIHN0b3BwaW5nIGEgbW9kdWxlLCBzbyB3ZSBuZWVkIHRvIHJlc3Vic2NyaWJlIGV2ZXJ5IHRpbWUgaGVyZS4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgcHJvYmFibHkgYmV0dGVyLCBhcyB0aGUgZXZlbnRzIHdpbGwgYmUgbGVzcyBjaGF0dHkuCiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLnN1YnNjcmliZShldmVudC5jaGFuZ2VDb250YWluZXIsIGJpbmQodGhhdC5jaGFuZ2UsIHRoYXQsIG1vZCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGFpbmVyID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2RlcGVuZGVudC5tb2R1bGVzJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0Lm1lZGlhdG9yCiAgICBAc3VibW9kdWxlIHRocnVzdC5tZWRpYXRvci5jb252ZW50aW9uCiAgICAqKi8KICAgICAgICB2YXIgYW55ID0gXy5hbnksIG1hcCA9IF8ubWFwLCBETU9EVUxFUyA9ICdjb25maWcuZGVwZW5kZW50TW9kdWxlcycsIENNT0RVTEVTID0gJ2NvbmZpZy5jaGlsZE1vZHVsZXMnLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQ7CiAgICB2YXIgaW52b2tlZGVwZW5kZW50TW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihETU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIGludm9rZUNoaWxkTW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihDTU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBETU9EVUxFUywgCiAgICAgICAgICAgIENNT0RVTEVTCiAgICAgICAgXSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgaW52b2tlZGVwZW5kZW50TW9kdWxlcyhtb2QsICdzdGFydCcpLCAKICAgICAgICAgICAgICAgIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdGFydCcpCiAgICAgICAgICAgIF07CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZighbW9kLnRocnVzdC5zdGFydGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgIGludm9rZWRlcGVuZGVudE1vZHVsZXMobW9kLCAncmVhZHknKSwgCiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2hpbGRNb2R1bGVzKG1vZCwgJ3JlYWR5JykKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdG9wJyk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHJldHVybiBpbnZva2VDaGlsZE1vZHVsZXMobW9kLCAnZGVzdHJveScpOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmRlcGVuZGVudE1vZHVsZXMgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZGVwZW5kZW50Lm1vZHVsZXMuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnY2ZnJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L21lZGlhdG9yLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nCiAgICBdOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9jb252ZW50aW9uL3N1YnNjcmlwdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgVGhlIGZhY2FkZSBjb252ZW50aW9uLCBjcmVhdGVzIHRoZSBtZWRpYXRvciBmYWNhZGUgZm9yIGVhY2ggbW9kdWxlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIFNVQlNDUklQVElPTlMgPSAnY29uZmlnLm1lZGlhdG9yLnN1YnNjcmlwdGlvbnMnLCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBpc1N0cmluZyA9IF8uaXNTdHJpbmcsIGlzQXJyYXkgPSBfLmlzQXJyYXksIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgaXNQbGFpbk9iamVjdCA9IF8uaXNQbGFpbk9iamVjdCwgZm9yT3duID0gXy5mb3JPd24sIGVhY2ggPSBfLmVhY2g7CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnaGFuZGxlcicsIAogICAgICAgICdjb250ZXh0JwogICAgXTsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgU1VCU0NSSVBUSU9OUwogICAgICAgIF0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpOwogICAgICAgICAgICBpZihzdWJzY3JpcHRpb25zICYmICEoc3Vic2NyaXB0aW9ucykuX3N1YnNjcmlwdGlvbnNTZXQpIHsKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgICAgIGZvck93bihzdWJzY3JpcHRpb25zLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgc3Vic2NyaXB0aW9uTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFpc0FycmF5KHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihzdWJzY3JpcHRpb25Db2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVhY2goc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKHN1YnNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KHN1YnNjcmlwdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3U3Vic2NyaXB0aW9uLnB1c2guYXBwbHkobmV3U3Vic2NyaXB0aW9uLCBzdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWFjaChzdWJzY3JpcHRpb24sIGZ1bmN0aW9uIChoYW5kbGVyT2JqZWN0LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1N1YnNjcmlwdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uTmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3RdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc3Vic2NyaXB0aW9uW2kgKyAxXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goc3Vic2NyaXB0aW9uW2kgKyAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9yZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzRnVuY3Rpb24oaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goaGFuZGxlck9iamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbltpICsgMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKHN1YnNjcmlwdGlvbltpICsgMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc1BsYWluT2JqZWN0KGhhbmRsZXJPYmplY3QpICYmICgnbW9kdWxlSGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCB8fCAnaGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9uZXdTdWJzY3JpcHRpb24gPSBbc3Vic2NyaXB0aW9uTmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdtb2R1bGVIYW5kbGVyJyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChtb2QuaW5zdGFuY2VbaGFuZGxlck9iamVjdC5tb2R1bGVIYW5kbGVyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoJ2hhbmRsZXInIGluIGhhbmRsZXJPYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3QuaGFuZGxlcl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdjb250ZXh0JyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5ld1N1YnNjcmlwdGlvbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY2FkZS5zdWJzY3JpYmUuYXBwbHkoZmFjYWRlLCBuZXdTdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpLl9zdWJzY3JpcHRpb25zU2V0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb25zID0gbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUyk7CiAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbnMgJiYgc3Vic2NyaXB0aW9ucy5fc3Vic2NyaXB0aW9uc1NldCkgewogICAgICAgICAgICAgICAgbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUykuX3N1YnNjcmlwdGlvbnNTZXQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnN1YnNjcmlwdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJzY3JpcHRpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LmRhdGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LmRhdGEuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicsIAogICAgICAgICdjZmcnCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JwogICAgXTsKICAgIC8qKgogICAgRGVjaWRlcyBpZiBgdGhydXN0L2RhdGFgIHNob3VsZCBjYWNoZSByZXF1ZXN0cyBvciBub3QuCiAgICAKICAgIFlvdSBzaG91bGQgdHVybiB0aGlzIHRvIGBmYWxzZWAsIGlmIHlvdSBhcmUgZXhwZXJpZW5jaW5nIGNhY2hpbmcgaXNzdWVzIGFuZCBuZWVkIHRvIGRlYnVnLgogICAgCiAgICBAcHJvcGVydHkgY2FjaGUKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuY2FjaGUgPSB0cnVlOwogICAgLyoqCiAgICAqCiAgICAqIGBzdGFydFRpbWVvdXRgIGlzIHBhcnQgb2YgcXVldWVpbmcgYnVpbHQgaW50byBgdGhydXN0L2RhdGFgLiAgSXQgZGVmaW5lcyB0aGUgd2FpdCB0aW1lIGJlZm9yZSByZXF1ZXN0cwogICAgKiBhcmUgc3RhcnRlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIGZpcnN0IHJlcXVlc3QsIHRoZSB0aW1lcgogICAgKiBzdGFydHMsIG9uY2UgdGhlIHRpbWVvdXQgZWxhcHNlcywgYWxsIHRoZSByZXF1ZXN0cyBhcmUgc2hpcHBlZCBvZmYgYXQgb25jZS4KICAgICoKICAgICoKICAgICogVGhpcyBjb3VudGVyIGludHVpdGl2ZSBpZiB5b3UncmUgbG9va2luZyB0byBnZXQgdGhlIHJlcXVlc3QgYmFjayBpbW1lZGlhdGVseSwgYnV0IGZyb20gYSBVWCBwZXJzcGVjdGl2ZQogICAgKiB0aGlzIGFsbG93cyB0aGUgVUkgdG8gc3RheSBpbiBzeW5jIGFuZCBnaXZlIHRoZSB1c2VyIGEgY29oZXNpdmUsIGluc3RlYWQgb2Ygc2VlaW5nIGxvYWRlcnMsIHNob3cgdXAgYW5kCiAgICAqIGRpc2FwcGVhciBhdCBzZWVtaW5nbHkgcmFuZG9tIGludGVydmFscywgdGhlIHVzZXIgZG9lcyBhbiBhY3Rpb24sIGFuZCB0aGVuIHNlZXMgYSByZXNwb25zZS4KICAgICoKICAgICoKICAgICogQHByb3BlcnR5IHN0YXJ0VGltZW91dAogICAgKiBAcmVhZE9ubHkKICAgICogQHR5cGUge051bWJlcn0KICAgICogQGRlZmF1bHQgNTAwCiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnRUaW1lb3V0ID0gMTAwOwogICAgLyoqCiAgICAqCiAgICAqIGBmaW5pc2hUaW1lb3V0YCBpcyBwYXJ0IG9mIHF1ZXVlaW5nIGJ1aWx0IGludG8gYHRocnVzdC9kYXRhYC4gIEl0IGRlZmluZXMgdGhlIHdhaXQgdGltZSBiZWZvcmUgdGhlCiAgICAqIHF1ZXVlIGlzIGNvbXBsZXRlZC4gIElmIGFsbCB0aGUgcmVxdWVzdHMgZmluaXNoIGVhcmx5LCB0aGUgdGltZW91dCBpcyBjYW5jZWxlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIHJlcXVlc3RzIGFyZSBmaXJlZCBvZmYKICAgICogYHRocnVzdC9kYXRhYCB3aWxsIHdhaXQgdW50aWwgaXQgZ2V0cyBhIHJlc3BvbnNlIGZyb20gZXZlcnlvbmUgb2YgdGhlbS4gIElmIGZvciBzb21lIHJlYXNvbiBhIHJlcXVlc3QKICAgICogdGFrZXMgdG8gbG9uZywgYW5kIHRoZSB0aW1lb3V0IGlzIGhpdCwgYWxsIHRoZSByZXF1ZXN0cyB0aGF0IGhhdmUgY29tcGxldGVkLCB3aWxsIGJlIHJlbGVhc2VlZCwgYWxsb3dpbmcKICAgICogdGhlIGFwcGxpY2F0aW9uIHRvIGNvbnRpbnVlIHVuZGlzcnVwdGVkLgogICAgKgogICAgKgogICAgKiBUaGlzIGNvdW50ZXIgaW50dWl0aXZlIGlmIHlvdSdyZSBsb29raW5nIHRvIGdldCB0aGUgcmVxdWVzdCBiYWNrIGltbWVkaWF0ZWx5LCBidXQgZnJvbSBhIFVYIHBlcnNwZWN0aXZlCiAgICAqIHRoaXMgYWxsb3dzIHRoZSBVSSB0byBzdGF5IGluIHN5bmMgYW5kIGdpdmUgdGhlIHVzZXIgYSBjb2hlc2l2ZSwgaW5zdGVhZCBvZiBzZWVpbmcgbG9hZGVycywgc2hvdyB1cCBhbmQKICAgICogZGlzYXBwZWFyIGF0IHNlZW1pbmdseSByYW5kb20gaW50ZXJ2YWxzLCB0aGUgdXNlciBkb2VzIGFuIGFjdGlvbiwgYW5kIHRoZW4gc2VlcyBhIHJlc3BvbnNlLgogICAgKgogICAgKgogICAgQHByb3BlcnR5IGZpbmlzaFRpbWVvdXQKICAgIEByZWFkT25seQogICAgQHR5cGUge051bWJlcn0KICAgIEBkZWZhdWx0IDIwMDAKICAgICoqLwogICAgZXhwb3J0cy5maW5pc2hUaW1lb3V0ID0gMjAwMDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvZXZlbnQudHlwZXMnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8qKgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5kYXRhCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICAqKi8KICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS93YWl0YCBldmVudCBpcyBmaXJlZCBvbmNlIGEgZGF0YSBjYWxsIGlzIG1hZGUuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS93YWl0CiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICAqKi8KICAgIGV4cG9ydHMud2FpdCA9ICd0aHJ1c3QvZGF0YS93YWl0JzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdGFydGAgZXZlbnQgaXMgZmlyZWQgdGhlIHF1ZXVlIGlzIHN0YXJ0ZWQuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGFydAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXJ5SWQgVGhlIGludGVybmFsIGlkIG9mIHRoZSBvdXRib3VuZCBxdWV1ZS4KICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBvdXRib3VuZCBldmVudCBxdWV1ZSAoR2V0L1Bvc3QvZXRjKQogICAgQHBhcmFtIHtOdW1iZXJ9IGNvdW50IFRoZSBvdXRnb2luZyBjYWxsIGNvdW50CiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnQgPSAndGhydXN0L2RhdGEvc3RhcnQnOwogICAgLyoqCiAgICBUaGUgYHRocnVzdC9kYXRhL3N0YXR1c2AgZXZlbnQgaXMgZmlyZWQgZm9yIGV2ZXJ5IGl0ZW0gdGhhdCByZXR1cm5zIGZyb20gdGhlIHF1ZXVlLgogICAgCiAgICBOT1RFOiBJdCBpcyBlbnRpcmVseSBwb3NzaWJsZSBmb3IgYHRocnVzdC9kYXRhL3N0YXR1cyoqIHRvIGJlIGNhbGxlZCBhZnRlciBgdGhydXN0L2RhdGEvc3RvcCoqIGlmIHNldmVyYWwKICAgIGNhbGxzIHRha2UgdG8gbG9uZyB0byBjb21wbGV0ZS4gIFRoaXMgaXMgaW50ZW5kZWQsIGFuZCBwb3RlbnRpYWxseSB1c2VmdWwgaW5mb3JtYXRpb24uCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGF0dXMKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgY3VycmVudCBjb21wbGV0ZWQgY2FsbCBjb3VudCBmb3IgdGhpcyBxdWV1ZS4KICAgICoqLwogICAgZXhwb3J0cy5zdGF0dXMgPSAndGhydXN0L2RhdGEvc3RhdHVzJzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdG9wYCBldmVudCBpcyBmaXJlZCB3aGVuIGFsbCBpdGVtcyBpbiB0aGUgcXVldWUgcmV0dXJuLCBvciB0aGUgZmluaXNoZWRUaW1lb3V0IHNldHRpbmcgZWxhcHNlcy4KICAgIAogICAgQGV2ZW50IHRocnVzdC9kYXRhL3N0b3AKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgKGN1cnJlbnQpIGNvbXBsZXRlZCBjYWxsIGNvdW50IGZvciB0aGlzIHF1ZXVlLgogICAgKiovCiAgICBleHBvcnRzLnN0b3AgPSAndGhydXN0L2RhdGEvc3RvcCc7CiAgICBleHBvcnRzLmV2ZW50ID0gewogICAgICAgIGJlZm9yZVNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmRgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L2JlZm9yZS1zZW5kJywKICAgICAgICBzdGFydDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdGFydGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N0YXJ0CiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvc3RhcnQnLAogICAgICAgIHNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc2VuZGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3NlbmQKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zZW5kJywKICAgICAgICBlcnJvcjogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9lcnJvcmAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L2Vycm9yCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvZXJyb3InLAogICAgICAgIHN1Y2Nlc3M6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc3VjY2Vzc2AgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N1Y2Nlc3MKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zdWNlc3MnLAogICAgICAgIGNvbXBsZXRlOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L2NvbXBsZXRlYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9jb21wbGV0ZScsCiAgICAgICAgc3RvcDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdG9wYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvc3RvcAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L3N0b3AnCiAgICB9Owp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudC50eXBlcy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhL2V2ZW50LmZhY3RvcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4vZXZlbnQudHlwZXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vanF1ZXJ5LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBjYW1lbENhc2UgPSB1dGlsLmNhbWVsQ2FzZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGJpbmQgPSBfLmJpbmQsIGRhdGFFdmVudHMgPSBldmVudFR5cGVzLmV2ZW50LCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZTsKICAgIC8qKgogICAgVGhlIGV2ZW50IGZhY3RvcnkgbGlua3MgalF1ZXJ5IEV2ZW50cyB1cCB0byB0aHJ1c3QgY2VudHJpYyBldmVudHMuCiAgICBUaGUgZXZlbnQgZmFjdG9yeSB3b3VsZCBiZSByZXBsYWNlZCBpZiB3ZSB3ZXJlIGV2ZXIgbW92ZWQgb2ZmIG9mIHRoZSBqUXVlcnkgZGVwZW5kYW5jeS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QuZGF0YQogICAgKiovCiAgICB2YXIgZXZlbnRIYW5kbGVycyA9IHsKICAgICAgICAnYmVmb3JlLXNlbmQnOiAvLyBTdXBwb3J0ZWQgZXZlbnQgaGFuZGxlcnMKICAgICAgICB0cnVlLAogICAgICAgICdzZW5kJzogdHJ1ZSwKICAgICAgICAnZXJyb3InOiB0cnVlLAogICAgICAgICdzdWNjZXNzJzogdHJ1ZSwKICAgICAgICAnY29tcGxldGUnOiB0cnVlLAogICAgICAgICdzdGFydCc6IHRydWUsCiAgICAgICAgJ3N0b3AnOiB0cnVlCiAgICB9OwogICAgLyoqCiAgICBXcmFwcyBiZWZvcmVTZW5kLCB3aGljaCBpcyBhIGN1c3RvbSBwcm9wZXJ0eSBvbiB0aGUgalF1ZXJ5IGFqYXggZGF0YSBjYWxsLgogICAgCiAgICBAbWV0aG9kIGJlZm9yZVNlbmRNZXRob2QKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGJlZm9yZVNlbmRNZXRob2QoanFYSFIsIHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICB0aGlzLmZpcmUoZGF0YUV2ZW50c1snYmVmb3JlU2VuZCddLCBqcVhIUiwgc2V0dGluZ3MpOwogICAgfQogICAgZXhwb3J0cy5iZWZvcmVTZW5kTWV0aG9kID0gYmVmb3JlU2VuZE1ldGhvZDsKICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHZhciBldnQgPSBkYXRhRXZlbnRzW2V2ZW50XTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGV2dCk7CiAgICAgICAgICAgIHRoaXMuZmlyZS5hcHBseSh0aGlzLmZpcmUuYXN5bmMsIGFyZ3MpOwogICAgICAgIH07CiAgICB9KTsKICAgIHZhciBub3JtYWxpemVFdmVudHMgPSBmdW5jdGlvbiAoZXZ0cykgewogICAgICAgIGV2dHMgPSBldnRzLnNwbGl0KCcgJyk7CiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGV2dHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKCFldmVudEhhbmRsZXJzW2V2dHNbaV1dKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdFdmVudCAiezB9IiBpcyBub3QgYSB2YWxpZCBkYXRhIGV2ZW50JywgZXZ0c1tpXSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2dHNbaV0gPSBkYXRhRXZlbnRzW2V2dHNbaV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZ0cy5qb2luKCcgJyk7CiAgICB9OwogICAgdmFyIHNlbmRFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoaSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXZlbnQsIGpxWEhSLCBzZXR0aW5ncykgewogICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICBpZighc2V0dGluZ3MuX19tZWRpYXRvcl9kYXRhX2ZpcmVkX18pIHsKICAgICAgICAgICAgICAgIGpxWEhSLmFib3J0KCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCwgYWxsIGFqYXggY2FsbHMgbXVzdCBwYXNzIHRocm91Z2ggdGhydXN0LWRhdGEuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXNldHRpbmdzLnNpbGVudCkgewogICAgICAgICAgICAgICAgZXZlbnRGYWN0b3J5KGkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgQmluZHMgYWxsIHRoZSBqUXVlcnkgZGF0YSBldmVudHMgYW5kIGNyZWF0ZXMgZXZlbnQgbmF0aXZlIHRocnVzdCBldmVudHMgb3V0IG9mIHRoZW0uCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGluaXQKICAgIEBwYXJhbSB7alF1ZXJ5fSBBIGpRdWVyeSBpbnN0YW5jZSB3cmFwcGluZyAnZG9jdW1lbnQnCiAgICAqKi8KICAgIGZ1bmN0aW9uIGluaXQoakRvYykgewogICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgICAgZm9yKHZhciBpIGluIGV2ZW50SGFuZGxlcnMpIHsKICAgICAgICAgICAgdmFyIGpxRXZ0ID0gJ2FqYXgtJyArIGksIG1ldGhvZCA9IGV2ZW50RmFjdG9yeShpKTsKICAgICAgICAgICAgaWYoaSA9PT0gJ3NlbmQnKSB7CiAgICAgICAgICAgICAgICBtZXRob2QgPSBiaW5kKHNlbmRFdmVudEZhY3RvcnkoaSksIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGpEb2Mub24oY2FtZWxDYXNlKGpxRXZ0KSArIHRoaXMubmFtZXNwYWNlLCBtZXRob2QpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaW5pdCA9IGluaXQ7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50LmZhY3RvcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9yZXNwb25zZS5xdWV1ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAnLi9ldmVudC50eXBlcycsICdqcXVlcnknLCAndGhydXN0L2xvZycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXywgX19qUXVlcnlfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9qcXVlcnkuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBldmVudFR5cGVzID0gX19ldmVudFR5cGVzX187CgogICAgdmFyIGpRdWVyeSA9IF9falF1ZXJ5X187CgogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIHVpZCA9IF8udW5pcXVlSWQsIGFqYXggPSBqUXVlcnkuYWpheCwgZGF0YUV2ZW50V2FpdCA9IGV2ZW50VHlwZXMud2FpdCwgZGF0YUV2ZW50U3RhcnQgPSBldmVudFR5cGVzLnN0YXJ0LCBkYXRhRXZlbnRTdG9wID0gZXZlbnRUeXBlcy5zdG9wLCBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzLnN0YXR1cywgcXVldWUgPSB7CiAgICB9LCB1cGRhdGVYSFJJbnRlcm5hbHMgPSBmdW5jdGlvbiAoZGZvLCB4aHIpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZighZGZvLl94aHIpIHsKICAgICAgICAgICAgICAgIGRmby5feGhyID0geGhyOwogICAgICAgICAgICAgICAgZGZvLmdldEFsbFJlc3BvbnNlSGVhZGVycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZGZvLmdldFJlc3BvbnNlSGVhZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5nZXRBbGxSZXNwb25zZUhlYWRlcnNnZXRSZXNwb25zZUhlYWRlcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRmby5hYm9ydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBkZm8uc2V0UmVxdWVzdEhlYWRlciA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5zZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGZvLnJlc3BvbnNlVGV4dCA9IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgIGRmby5yZXNwb25zZVhNTCA9IHhoci5yZXNwb25zZVhNTDsKICAgICAgICAgICAgZGZvLnJlYWR5U3RhdGUgPSB4aHIucmVhZHlTdGF0ZTsKICAgICAgICAgICAgZGZvLnN0YXR1cyA9IHhoci5zdGF0dXM7CiAgICAgICAgICAgIGRmby5zdGF0dXNUZXh0ID0geGhyLnN0YXR1c1RleHQ7CiAgICAgICAgfTsKICAgIH0sIGFyZ3VtZW50UmVzb2x2ZXIgPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgfTsKICAgIH0sIGRlZmVyQ29udHJvbGxlckl0ZW1DYWxsYmFjayA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzLCBhcmd1bWVudHNbMF1bMF0pOwogICAgICAgIH07CiAgICB9OwogICAgLyoqCiAgICBUaGUgcmVzcG9uc2UgcXVldWUgY2xhc3MgaGFuZGxlcyBjcmVhdGlvbiBvZiBhIHF1ZXVlIG9yIGJhdGNoaW5nIHN5c3RlbS4KICAgIFdpdGggdGhpcyBzeXN0ZW0sIHdlIGNhbiBiYXRjaCB1cCBhbGwgb3VyIHNlcnZlciByZXF1ZXN0cywgYW5kIHJlcXVlc3QgdGhlbSBmcm9tIHRoZSBzZXJ2ZXIgYWxsIGFyb3VuZCB0aGUgc2FtZSB0aW1lLgogICAgSW4gYWRkaXRpb24gdG8gdGhhdCwgd2hlbiB0aGUgcmVxdWVzdHMgY29tZSBiYWNrIHdlIGNhbiBhbHNvIHNwb29sIHRoZW0gdG9nZXRoZXIsIHNvIHRoYXQgdGhlIGNhbGxzIGRvbid0IHJlc29sdmUgdW50aWwKICAgIGVpdGhlciBhbGwgdGhlIGNhbGxzIGNvbWUgYmFjaywgb3IgYSBzcGVjaWZpYyB0aW1lIGhhcyBlbGFwc2VkLgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAY2xhc3MgdGhydXN0LmRhdGEuUmVzcG9uc2VRdWV1ZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgcmVzcG9uc2UgcXVldWUgZm9yCiAgICBAcGFyYW0ge051bWJlcn0gc3RhcnRUaW1lb3V0IFRoZSB0aW1lIHRvIHdhaXQgZm9yIGFkZGl0aW9uYWwgcmVxdWVzdHMuCiAgICBAcGFyYW0ge051bWJlcn0gZmluaXNoVGltZW91dCBUaGUgbWF4aW11bSB0aW1lIHRvIHdhaXQgZm9yIHJlcXVlc3RzIHRvIHJldHVybi4KICAgICoqLwogICAgdmFyIFJlc3BvbnNlUXVldWUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJlc3BvbnNlUXVldWUobW9kdWxlLCBzdGFydFRpbWVvdXQsIGZpbmlzaFRpbWVvdXQpIHsKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWVvdXQgPSBzdGFydFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMuZmluaXNoVGltZW91dCA9IGZpbmlzaFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLm5hbWVzcGFjZSA9IG1vZHVsZS5uYW1lc3BhY2U7CiAgICAgICAgfQogICAgICAgIFJlc3BvbnNlUXVldWUucHJvdG90eXBlLmFkZFRvUXVldWUgPSAvKioKICAgICAgICBBZGRzIGEgcmVxdWVzdCB0byB0aGUgcXVldWUKICAgICAgICBRdWV1ZXMgYXJlIHNwbGl0IHVwIGJ5IEhUVFAgdHlwZSwgc28gR0VUIHJlcXVlc3RzIGdvIHdpdGggR0VUIHJlcXVlc3RzIGFuZCBQT1NUIHJlcXVlc3RzIGdvIHdpdGggUE9TVCByZXF1ZXN0cy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGFkZFRvUXVldWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgcmVxdWVzdCB0eXBlIChQT1NULCBHRVQsIGV0YykKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSByZXF1ZXN0IHVybCB0byBxdWV1ZSB1cAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSByZXF1ZXN0IG9wdGlvbnMuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIG9yIHJlamVjdCwgd2hlbiB0aGUgcmVxdWVzdCBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHR5cGUsIHVybCwgb3B0aW9ucykgewogICAgICAgICAgICB2YXIgZGZvID0gd2hlbi5kZWZlcigpLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYob3B0aW9ucy5iZWZvcmVTZW5kKSB7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgICAgIGRmby5wcm9ncmVzcyhmdW5jdGlvbiAoZXZlbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnRUeXBlICYmIGV2ZW50VHlwZSA9PSAnYmVmb3JlLXNlbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVTZW5kLmFwcGx5KGJlZm9yZVNlbmQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLmNvbXBsZXRlKSB7CiAgICAgICAgICAgICAgICBkZm8ucHJvbWlzZS5hbHdheXMob3B0aW9ucy5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5jb21wbGV0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGRmby5wcm9taXNlLnRoZW4ob3B0aW9ucy5zdWNjZXNzKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYob3B0aW9ucy5lcnJvcikgewogICAgICAgICAgICAgICAgZGZvLnByb21pc2Uub3RoZXJ3aXNlKG9wdGlvbnMuZXJyb3IpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc1F1ZXVlID0gISFxdWV1ZVt0eXBlXSwgbGlzdCA9IHF1ZXVlW3R5cGVdIHx8IChxdWV1ZVt0eXBlXSA9IHsKICAgICAgICAgICAgfSksIHRhaWwgPSBsaXN0LnRhaWwgfHwgKGxpc3QudGFpbCA9IGxpc3QubmV4dCA9IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGV4dGVuZCh0YWlsLCB7CiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICBkZm86IGRmbwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGlzdC50YWlsID0gdGFpbC5uZXh0ID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICBpZighaGFzUXVldWUpIHsKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhhdC5zdGFydFRpbWVvdXQpLnRoZW4odGhhdC5wcm9jZXNzKHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGZvLnByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBSZXNwb25zZVF1ZXVlLnByb3RvdHlwZS5wcm9jZXNzID0gLyoqCiAgICAgICAgUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0IHdpbGwgcHJvY2VzcyB0aGUgZ2l2ZW4gcXVldWUgYWZ0ZXIgdGhlIHN0YXJ0IHRpbWUgaGFzIGVsYXBzZWQuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBwcm9jZXNzCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHF1ZXVlIHR5cGUsIHRvIHByb2Nlc3MuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGRvIHRoZSB3b3JrIG9uIHRoZSBxdWV1ZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcXVldWVbdHlwZV0sIG5vZGUgPSBwYXJlbnQsIHRoYXQgPSB0aGlzLCBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RhdGFbezB9XTogQ3JlYXRpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFdhaXQsIHF1ZXJ5SWQsIHR5cGUpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEYXRhW3swfV06IFByb2Nlc3NpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICAgICAgdmFyIHdoZW5RdWV1ZSA9IFtdLCBkZWZlckNvbnRyb2xsZXIgPSB3aGVuLmRlZmVyKCksIHJldHVybkNvdW50ID0gMDsKICAgICAgICAgICAgICAgIGRlZmVyQ29udHJvbGxlci5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBGaW5pc2hpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICAgICAgICAgIHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50U3RvcCwgcXVlcnlJZCwgdHlwZSwgcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBkZWxldGUgcXVldWVbdHlwZV07CiAgICAgICAgICAgICAgICB2YXIgdGFpbCA9IG5vZGUudGFpbCwgc3RhdHVzQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRTdGF0dXMsIHF1ZXJ5SWQsIHR5cGUsICsrcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZm8gPSBub2RlLmRmbywgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgfSwgbm9kZS5vcHRpb25zKSwgeGhyRGZvID0gd2hlbi5kZWZlcigpLCB4aHIgPSBub2RlLnhociA9IGFqYXgobm9kZS51cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcih4aHJEZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoeGhyRGZvLnJlamVjdCkpOwogICAgICAgICAgICAgICAgICAgIHhockRmby5wcm9taXNlLnRoZW4oc3RhdHVzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIHdoZW5RdWV1ZS5wdXNoKHhocik7CiAgICAgICAgICAgICAgICAgICAgd2hlbi5hbGwoWwogICAgICAgICAgICAgICAgICAgICAgICB4aHJEZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBkZWZlckNvbnRyb2xsZXIucHJvbWlzZQogICAgICAgICAgICAgICAgICAgIF0sIHdoZW4uYXBwbHkoZGZvLnJlc29sdmUpLCB3aGVuLmFwcGx5KGRmby5yZWplY3QpLCB1cGRhdGVYSFJJbnRlcm5hbHMoZGZvLCB4aHIpKTsKICAgICAgICAgICAgICAgICAgICBkZm8ucHJvZ3Jlc3MoJ2JlZm9yZS1zZW5kJywgWwogICAgICAgICAgICAgICAgICAgICAgICBkZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFN0YXJ0LCBxdWVyeUlkLCB0eXBlLCB3aGVuUXVldWUubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRoYXQuZmluaXNoVGltZW91dCkKICAgICAgICAgICAgICAgIF0sIGRlZmVyQ29udHJvbGxlci5yZXNvbHZlLCBkZWZlckNvbnRyb2xsZXIucmVzb2x2ZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gUmVzcG9uc2VRdWV1ZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLlJlc3BvbnNlUXVldWUgPSBSZXNwb25zZVF1ZXVlOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9cmVzcG9uc2UucXVldWUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHZhciB3aGVuUXVldWUgPSBbXTsKICAgIGZ1bmN0aW9uIHdhaXRDYWxsYmFjayh1aWQpIHsKICAgICAgICB2YXIgZCA9IHdoZW4uZGVmZXIoKTsKICAgICAgICBkLnJlc29sdmVyWyd1aWQnXSA9IHVpZDsKICAgICAgICB3aGVuUXVldWUucHVzaCh7CiAgICAgICAgICAgIHVpZDogdWlkLAogICAgICAgICAgICByZXNvbHZlcjogZC5yZXNvbHZlcgogICAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gc3RvcENhbGxiYWNrKHVpZCkgewogICAgICAgIHZhciBpdGVtID0gXy5maW5kKHdoZW5RdWV1ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHgudWlkID09PSB1aWQ7CiAgICAgICAgfSk7CiAgICAgICAgd2hlblF1ZXVlID0gXy53aXRob3V0KHdoZW5RdWV1ZSwgaXRlbSk7CiAgICAgICAgaXRlbS5yZXNvbHZlci5yZXNvbHZlKCk7CiAgICB9CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBjb3VudGRvd246IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gU3Vic2NyaWJlIHRvIHRoZSB3YWl0IGFuZCBzdG9wIGV2ZW50cwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3N0b3AnLCBzdG9wQ2FsbGJhY2spOwogICAgICAgIH0sCiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gVW5zdWJzY3JpYmUgZnJvbSB0aGUgd2FpdCBhbmQgc3RvcCBldmVudHMKICAgICAgICAgICAgdGhydXN0LmRhdGEudW5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS51bnN1YnNjcmliZSgndGhydXN0L2RhdGEvc3RvcCcsIHN0b3BDYWxsYmFjayk7CiAgICAgICAgICAgIC8vIGRlZmVyIHVudGlsIGFueSBvZiB0aGUgZXZlbnRzIHRoYXQgd2VyZSBjYXB0dXJlZCBhcmUgcmVzb2x2ZWQsIG9yIHRoZSBkZWxheSBwYXNzZXMuCiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgaWYodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQgPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbCh3aGVuUXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQpCiAgICAgICAgICAgIF0sIGRlZmVyLnJlc29sdmUsIGRlZmVyLnJlamVjdCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuc3Vic2NyaXB0aW9uID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXN0YXJ0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRvbS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicKICAgIF07CiAgICAvKioKICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9kb20uCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9hY3Rpb24nLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2NvbnRleHQnLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JwogICAgXTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9zdWJqcXVlcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ2pxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ2hhcyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2pRdWVyeV9fLCBfX3V0aWxfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBqUXVlcnkgPSBfX2pRdWVyeV9fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGV4dGVuZCA9IF8uZXh0ZW5kLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBHTE9CQUwgPSAnLmdsb2JhbCc7CiAgICB2YXIgalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QgPSBbCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ2V4dGVuZCcsIAogICAgICAgICdxdWV1ZScsIAogICAgICAgICdkZXF1ZXVlJywgCiAgICAgICAgJ2NsZWFyUXVldWUnLCAKICAgICAgICAncHJvbWlzZScsIAogICAgICAgICdiaW5kJywgCiAgICAgICAgJ3VuYmluZCcsIAogICAgICAgICdsaXZlJywgCiAgICAgICAgJ2RpZScsIAogICAgICAgICdkZWxlZ2F0ZScsIAogICAgICAgICd1bmRlbGVnYXRlJywgCiAgICAgICAgJ2JsdXInLCAKICAgICAgICAnZm9jdXMnLCAKICAgICAgICAnZm9jdXNpbicsIAogICAgICAgICdmb2N1c291dCcsIAogICAgICAgICdsb2FkJywgCiAgICAgICAgJ3Jlc2l6ZScsIAogICAgICAgICdzY3JvbGwnLCAKICAgICAgICAndW5sb2FkJywgCiAgICAgICAgJ2NsaWNrJywgCiAgICAgICAgJ2RibGNsaWNrJywgCiAgICAgICAgJ21vdXNlZG93bicsIAogICAgICAgICdtb3VzZXVwJywgCiAgICAgICAgJ21vdXNlbW92ZScsIAogICAgICAgICdtb3VzZW92ZXInLCAKICAgICAgICAnbW91c2VvdXQnLCAKICAgICAgICAnbW91c2VlbnRlcicsIAogICAgICAgICdtb3VzZWxlYXZlJywgCiAgICAgICAgJ2NoYW5nZScsIAogICAgICAgICdzZWxlY3QnLCAKICAgICAgICAnc3VibWl0JywgCiAgICAgICAgJ2tleWRvd24nLCAKICAgICAgICAna2V5cHJlc3MnLCAKICAgICAgICAna2V5dXAnLCAKICAgICAgICAnZXJyb3InLCAKICAgICAgICAnc2VyaWFsaXplJywgCiAgICAgICAgJ3NlcmlhbGl6ZUFycmF5JywgCiAgICAgICAgJ2FqYXhTdGFydCcsIAogICAgICAgICdhamF4U3RvcCcsIAogICAgICAgICdhamF4Q29tcGxldGUnLCAKICAgICAgICAnYWpheEVycm9yJywgCiAgICAgICAgJ2FqYXhTdWNjZXNzJywgCiAgICAgICAgJ2FqYXhTZW5kJywgCiAgICAgICAgJ190b2dnbGUnLCAKICAgICAgICAnZmFkZVRvJywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAnc2xpZGVEb3duJywgCiAgICAgICAgJ3NsaWRlVXAnLCAKICAgICAgICAnc2xpZGVUb2dnbGUnLCAKICAgICAgICAnZmFkZUluJywgCiAgICAgICAgJ2ZhZGVPdXQnLCAKICAgICAgICAnZmFkZVRvZ2dsZScvKiwgJ29uJywgJ29mZicsICdvbmUnKi8gCiAgICBdOwogICAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgbmFtZXNwYWNlKSB7CiAgICAgICAgaWYoIW5hbWVzcGFjZSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0KICAgICAgICBpZihpc09iamVjdChldmVudHMpKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBuZXcgb2JqZWN0LCBzbyB0aGF0IG9yaWdpbmFsIG9iamVjdCB3aWxsIG5vdCBiZSBtb2RpZmllZCB3aGVuIGJpbmRpbmcuCiAgICAgICAgICAgIGV2ZW50cyA9IGV4dGVuZCh7CiAgICAgICAgICAgIH0sIGV2ZW50cyk7CiAgICAgICAgICAgIGZvcih2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgaWYoa2V5LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNba2V5ICsgbmFtZXNwYWNlXSA9IGV2ZW50c1trZXldOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmKCFldmVudHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KCcgJyk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBldmVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZ0ID0gZXZlbnRzW2ldOwogICAgICAgICAgICAgICAgaWYoZXZ0LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNbaV0gPSBldnQgKyBuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50cy5qb2luKCcgJyk7CiAgICAgICAgfQogICAgfQogICAgLyoKICAgIENsb25lIGpxdWVyeQogICAgUmVtb3ZlIGFsbCBleGNlc3MgbWV0aG9kcyB3ZSBkb24ndCB3YW50IHRvIGV4cG9zZSBuYXRpdmVseS4KICAgIG92ZXJybG9hZCBhbnkgbWV0aG9kcyB3ZSB3YW50IHRvIGNoYW5nZSBiZWhhdmlvciBvZiAobm90ZWFibHkgb24sIG9uZSwgYW5kIG9mZikKICAgIAogICAgSW5zdGVhZCBvZiBkdXBsaWNhdGluZyB0aGUganF1ZXJ5IGJlaGF2aW9yIHdlIGluc3RlYWQgcmVhbGlnbiBpdCB0byBvdXIgb3duLgogICAgKi8KICAgIC8vIGpRdWVyeSBzdWIKICAgIGZ1bmN0aW9uIHN1YkpRdWVyeSgpIHsKICAgICAgICB2YXIgdFF1ZXJ5ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB0UXVlcnkucHJvdG90eXBlLmluaXQoc2VsZWN0b3IsIGNvbnRleHQsIG5hbWVzcGFjZSB8fCAodGhpcyAmJiB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgIH07CiAgICAgICAgXy5tZXJnZSh0UXVlcnksIGpRdWVyeSk7CiAgICAgICAgLy8gRG8gbm90IGxpa2UKICAgICAgICAvLyBwcm9iYWJseSBuZWVkZWQgaW4gc29tZSBzcGVjaWFsIHVuaXF1ZSBjYXNlcwogICAgICAgIHRRdWVyeS5qUXVlcnkgPSBqUXVlcnk7CiAgICAgICAgLy8gZXhwb3NlIGV2ZW50cyBmb3IgZG9pbmcgc3BlY2lhbCBldmVudHMgYXMgcmVxdWlyZWQuCiAgICAgICAgdFF1ZXJ5LmV2ZW50ID0gKGpRdWVyeSkuZXZlbnQ7CiAgICAgICAgdFF1ZXJ5LmZuID0gdFF1ZXJ5LnByb3RvdHlwZSA9IGV4dGVuZCh7CiAgICAgICAgfSwgalF1ZXJ5LmZuKTsKICAgICAgICB0UXVlcnkuZm4uY29uc3RydWN0b3IgPSB0UXVlcnk7CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiBpbml0KHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgdmFyIGlvRG9tID0gY29udGV4dCBpbnN0YW5jZW9mIHRRdWVyeTsKICAgICAgICAgICAgaWYoY29udGV4dCAmJiBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ICYmICEoaW9Eb20pKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gdFF1ZXJ5KGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBqUXVlcnkuZm4uaW5pdC5jYWxsKHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCB0UXVlcnlSb290KTsKICAgICAgICAgICAgaWYobmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICByZXN1bHQubmFtZXNwYWNlID0gbmFtZXNwYWNlOwogICAgICAgICAgICB9IGVsc2UgaWYoaW9Eb20pIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5uYW1lc3BhY2UgPSBjb250ZXh0Lm5hbWVzcGFjZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQucHJvdG90eXBlID0gdFF1ZXJ5LmZuOwogICAgICAgIHZhciB0UXVlcnlSb290ID0gdFF1ZXJ5KGRvY3VtZW50KTsKICAgICAgICAvLyByZW1vdmUgYWxsIG5vdCBhcHBsaWNhYmxlIG1ldGhvZHMgb2ZmIG9mIGZuLgogICAgICAgIGVhY2goalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIGlmKHRRdWVyeS5mblt4XSkgewogICAgICAgICAgICAgICAgdFF1ZXJ5LmZuW3hdID0gbnVsbDsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0UXVlcnkuZm5beF07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBfLmVhY2goWwogICAgICAgICAgICAnb24nLCAKICAgICAgICAgICAgJ29uZScsIAogICAgICAgICAgICAnb2ZmJwogICAgICAgIF0sIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHRRdWVyeS5mblt4XSA9IF8ud3JhcCh0UXVlcnkuZm5beF0sIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCd0UXVlcnlbezB9XTogQmluZGluZyAnICsgeCArICcgZXZlbnRzLi4uJywgdGhpcy5uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIGFyZ3NbMF0gPSBub3JtYWxpemVFdmVudHMoYXJnc1swXSwgdGhpcy5uYW1lc3BhY2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIGYuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIHRRdWVyeS5mbi5xdWVyeSA9IHRRdWVyeS5mbi4kID0gdFF1ZXJ5LmZuLmZpbmQ7CiAgICAgICAgcmV0dXJuIHRRdWVyeTsKICAgIH0KICAgIGV4cG9ydHMudFF1ZXJ5ID0gc3ViSlF1ZXJ5KCk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXN1YmpxdWVyeS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9hY3Rpb24nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4uL3N1YmpxdWVyeSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18sIF9fc3VianF1ZXJ5X18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2NvbnZlbnRpb24vYWN0aW9uLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgc3VianF1ZXJ5ID0gX19zdWJqcXVlcnlfXzsKCiAgICB2YXIgJCA9IHN1YmpxdWVyeS50UXVlcnk7CiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIEFDVElPTlMgPSAnY29uZmlnLmRvbS5hY3Rpb25zJywgQUNUSU9OU1NJTkdMRSA9ICdhY3Rpb25zJywgU1RSSU5HID0gJ3N0cmluZycsIFJFR0lTVFJBVElPTlMgPSAnX3JlZ2lzdHJhdGlvbnMnLCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBpc1N0cmluZyA9IF8uaXNTdHJpbmcsIGlzQXJyYXkgPSBfLmlzQXJyYXk7CiAgICB2YXIgZ2V0QWN0aW9uQXR0cmlidXRlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgICAgIHJldHVybiAnZGF0YS1hY3Rpb24tJyArIGV2ZW50TmFtZTsKICAgIH07CiAgICB2YXIgQWN0aW9uSGFuZGxlciA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQWN0aW9uSGFuZGxlcigpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIEFjdGlvbkhhbmRsZXIucHJvdG90eXBlLnJlZ2lzdGVyID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgYWN0aW9uTmFtZSwgYWN0aW9uKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50czsKICAgICAgICAgICAgaWYoIWV2ZW50c1tldmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBldmVudHNbZXZlbnROYW1lXSA9IHsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIWV2ZW50c1tldmVudE5hbWVdW2FjdGlvbk5hbWVdKSB7CiAgICAgICAgICAgICAgICBldmVudHNbZXZlbnROYW1lXVthY3Rpb25OYW1lXSA9IGFjdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ1RoZSBhY3Rpb24gezF9IGhhbmRsZXIgInswfSIgaGFzIGFscmVhZHkgYmVlbiB0YWtlbiEnLCBhY3Rpb25OYW1lLCBldmVudE5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5wcm90b3R5cGUudW5yZWdpc3RlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGFjdGlvbk5hbWUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuZXZlbnRzOwogICAgICAgICAgICBpZihldmVudHNbZXZlbnROYW1lXSAmJiBldmVudHNbZXZlbnROYW1lXVthY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBBY3Rpb25IYW5kbGVyLnByb3RvdHlwZS5jYWxsYmFja0ZvciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIHJldHVyblJlc3VsdHMpIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuZXZlbnRzLCBhY3Rpb25BdHRyaWJ1dGUgPSBnZXRBY3Rpb25BdHRyaWJ1dGUoZXZlbnROYW1lKSwgcmV0dXJuUmVzdWx0c0RlZmluZWQgPSB0eXBlb2YgcmV0dXJuUmVzdWx0cyAhPT0gJ3VuZGVmaW5lZCc7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlVmFsdWUgPSAkKHRoaXMpLmF0dHIoYWN0aW9uQXR0cmlidXRlKTsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBhdHRyaWJ1dGVWYWx1ZSA9PT0gU1RSSU5HKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGV2ZW50c1tldmVudE5hbWVdW2F0dHJpYnV0ZVZhbHVlXTsKICAgICAgICAgICAgICAgICAgICBpZihhY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uLmhhbmRsZXIuYXBwbHkoYWN0aW9uLmNvbnRleHQgfHwgdGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYocmV0dXJuUmVzdWx0c0RlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldHVyblJlc3VsdHM7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIEFjdGlvbkhhbmRsZXIuYWN0aW9uSGFuZGxlcnMgPSB7CiAgICAgICAgfTsKICAgICAgICBBY3Rpb25IYW5kbGVyLmdldEZvciA9IGZ1bmN0aW9uIGdldEZvcihuYW1lKSB7CiAgICAgICAgICAgIGlmKHRoaXMuYWN0aW9uSGFuZGxlcnNbbmFtZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFjdGlvbkhhbmRsZXJzW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAodGhpcy5hY3Rpb25IYW5kbGVyc1tuYW1lXSA9IG5ldyBBY3Rpb25IYW5kbGVyKCkpOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIEFjdGlvbkhhbmRsZXI7CiAgICB9KSgpOyAgICAKICAgIHZhciBldmVudHMgPSB7CiAgICAgICAgY2xpY2s6IFsKICAgICAgICAgICAgJ2EnLCAKICAgICAgICAgICAgJ2J1dHRvbicsIAogICAgICAgICAgICAnaW5wdXRbdHlwZT0iYnV0dG9uIl0nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9InN1Ym1pdCJdJwogICAgICAgIF0sCiAgICAgICAgZGJsY2xpY2s6IFsKICAgICAgICAgICAgJ2EnLCAKICAgICAgICAgICAgJ2J1dHRvbicsIAogICAgICAgICAgICAnaW5wdXRbdHlwZT0iYnV0dG9uIl0nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9InN1Ym1pdCJdJwogICAgICAgIF0sCiAgICAgICAgbW91c2VlbnRlcjogWwogICAgICAgICAgICAnJwogICAgICAgIF0sCiAgICAgICAgbW91c2VsZWF2ZTogWwogICAgICAgICAgICAnJwogICAgICAgIF0sCiAgICAgICAgZm9jdXM6IFsKICAgICAgICAgICAgJ2lucHV0JwogICAgICAgIF0sCiAgICAgICAgYmx1cjogWwogICAgICAgICAgICAnaW5wdXQnCiAgICAgICAgXQogICAgfTsKICAgIHZhciBhcnJheVNob3J0SGFuZEFyZ3NJbk9yZGVyID0gWwogICAgICAgICduYW1lJywgCiAgICAgICAgJ2hhbmRsZXInLCAKICAgICAgICAnY29udGV4dCcKICAgIF07CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIEFDVElPTlMKICAgICAgICBdLAogICAgICAgIGlnbml0ZTogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgdGhydXN0LmRvbS5hY3Rpb25IYW5kbGVyID0gYWN0aW9uSGFuZGxlcjsKICAgICAgICAgICAgdmFyICRib2R5ID0gJCh3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgICAgICAgIF8uZWFjaChldmVudHMsIGZ1bmN0aW9uIChldmVudFNlbGVjdG9ycywgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAvLyB1c2luZyB0aHJ1c3QgbmFtZSwgYXMgY2FsbGJhY2sgbmVlZHMgdG8gYmUgcGVyIHRocnVzdCBpbnN0YW5jZQogICAgICAgICAgICAgICAgLy8gaW4gdGhlIGV2ZW50IG9mIG11bHRpcGxlIHRocnVzdCBpbnN0YW5jZXMuCiAgICAgICAgICAgICAgICAkYm9keS5vbihldmVudE5hbWUgKyAnLicgKyBBQ1RJT05TU0lOR0xFICsgdGhydXN0Lm5hbWUsIGV2ZW50U2VsZWN0b3JzLmpvaW4oZ2V0QWN0aW9uQXR0cmlidXRlKGV2ZW50TmFtZSkgKyAnLCAnKSwgYWN0aW9uSGFuZGxlci5jYWxsYmFja0ZvcihldmVudE5hbWUsIHRydWUpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBkZW9yYml0OiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25IYW5kbGVyID0gQWN0aW9uSGFuZGxlci5nZXRGb3IodGhydXN0Lm5hbWUpOwogICAgICAgICAgICB2YXIgJGJvZHkgPSAkKHdpbmRvdy5kb2N1bWVudC5ib2R5KTsKICAgICAgICAgICAgXy5lYWNoKGV2ZW50cywgZnVuY3Rpb24gKGV2ZW50U2VsZWN0b3JzLCBldmVudE5hbWUpIHsKICAgICAgICAgICAgICAgICRib2R5Lm9mZignLicgKyBBQ1RJT05TU0lOR0xFICsgdGhydXN0Lm5hbWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbnMgPSBtb2QuY29udmVudGlvbihBQ1RJT05TKSwgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKG1vZC50aHJ1c3QubmFtZSksIGRvbSA9IGZhY2FkZSwgbW9kdWxlSW5zdGFuY2UgPSBtb2QuaW5zdGFuY2U7CiAgICAgICAgICAgIGlmKGFjdGlvbnMpIHsKICAgICAgICAgICAgICAgIF8uZm9yT3duKGFjdGlvbnMsIGZ1bmN0aW9uIChhY3Rpb25Db2xsZWN0aW9uLCBldmVudE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZighaXNBcnJheShhY3Rpb25Db2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihhY3Rpb25Db2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoYWN0aW9uQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoYWN0aW9uQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Db2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8uZWFjaChhY3Rpb25Db2xsZWN0aW9uLCBmdW5jdGlvbiAoYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzQXJyYXkoYWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0FjdGlvbiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmVhY2goYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciwgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4ID09PSAnaGFuZGxlcicgJiYgaXNTdHJpbmcoYWN0aW9uW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25baV0gPSBtb2QuaW5zdGFuY2VbYWN0aW9uW2ldXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3QWN0aW9uW3hdID0gYWN0aW9uW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSBuZXdBY3Rpb247CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbk5hbWUgPSBhY3Rpb24ubmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWFjdGlvbi5oYW5kbGVyICYmIGFjdGlvbi5tb2R1bGVIYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24uaGFuZGxlciA9IG1vZC5pbnN0YW5jZVthY3Rpb24ubW9kdWxlSGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZighYWN0aW9uLmhhbmRsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTXVzdCBkZWZpbmUgZWl0aGVyIGEgaGFuZGxlciBvciBtb2R1bGUgaGFuZGxlci4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25IYW5kbGVyLnJlZ2lzdGVyKGV2ZW50TmFtZSwgYWN0aW9uTmFtZSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbnMgPSBtb2QuY29udmVudGlvbihBQ1RJT05TKSwgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKG1vZC50aHJ1c3QubmFtZSksIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICBmb3IodmFyIGFjdGlvbkV2ZW50IGluIGFjdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYWN0aW9uQ29sbGVjdGlvbiA9IGFjdGlvbnNbYWN0aW9uRXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGZvcih2YXIgYWN0aW9uTmFtZSBpbiBhY3Rpb25Db2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkhhbmRsZXIudW5yZWdpc3RlcihhY3Rpb25FdmVudCwgYWN0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuYWN0aW9uID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWFjdGlvbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9hbmltYXRlLmNvbnRhaW5lcicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2NvbnRleHQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBldmVudCA9IHsKICAgICAgICBhbnlDb250YWluZXI6ICd0aHJ1c3QtY29udmVudGlvbi1jb250YWluZXItYW55JywKICAgICAgICBjaGFuZ2VDb250YWluZXI6ICd0aHJ1c3QtY29udmVudGlvbi1jb250YWluZXItY2hhbmdlJwogICAgfSwgYW55ID0gXy5hbnksIGRlZmVyID0gXy5kZWZlciwgYmluZCA9IF8uYmluZCwgU1RBUlQgPSAnc3RhcnQtc3RhdHVzJywgQU5JTUFURSA9ICdhbmltYXRlJywgQ09OVEFJTkVSID0gJ2NvbnRhaW5lcicsIENPTlRFWFQgPSAnY29udGV4dCc7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIEFOSU1BVEUKICAgICAgICBdLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1lZGlhdG9yID0gbW9kLmluc3RhbmNlLm1lZGlhdG9yOwogICAgICAgICAgICBtZWRpYXRvci5zdWJzY3JpYmUoZXZlbnQuY2hhbmdlQ29udGFpbmVyLCBiaW5kKHRoYXQuY2hhbmdlLCB0aGF0LCBtb2QpKTsKICAgICAgICB9LAogICAgICAgIGNoYW5nZTogZnVuY3Rpb24gKG1vZHVsZSwgY29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmKG1vZHVsZS5jb252ZW50aW9uKENPTlRBSU5FUikgPT09IGNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgaWYobW9kdWxlLmNvbnZlbnRpb24oU1RBUlQpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFuaW1hdGUgPSBtb2R1bGUuY29udmVudGlvbihBTklNQVRFKTsKICAgICAgICAgICAgICAgICAgICBpZihhbmltYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb250ZXh0Tm9kZSA9IG1vZHVsZS5pbnN0YW5jZS5kb20oKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dE5vZGUucmVtb3ZlQ2xhc3MoYW5pbWF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgYW5pbWF0ZSA9IG1vZC5jb252ZW50aW9uKEFOSU1BVEUpLCBjb250YWluZXIgPSBtb2QuY29udmVudGlvbihDT05UQUlORVIpLCBjb250ZXh0ID0gbW9kLmNvbnZlbnRpb24oQ09OVEVYVCksIGRvbSA9IGZhY2FkZTsKICAgICAgICAgICAgaWYoYW5pbWF0ZSAmJiBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IGRvbS5jb250ZXh0LmNsb25lKCkuYXBwZW5kVG8oZG9tLmNvbnRleHQucGFyZW50KCkpOwogICAgICAgICAgICAgICAgY2xvbmUuYWRkQ2xhc3MoYW5pbWF0ZS5yZXBsYWNlKC9cLi9nLCAnICcpLnRyaW0oKSk7CiAgICAgICAgICAgICAgICBtb2QuaW5zdGFuY2UuZG9tID0gbW9kLmluc3RhbmNlLiQgPSBjbG9uZTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYmluZCh0aGF0LmNsZWFudXAsIHRoYXQsIGRvbS5jb250ZXh0LnBhcmVudCgpLCBhbmltYXRlLCBjb250ZXh0KSwgMjAwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNsZWFudXA6IGZ1bmN0aW9uIChjb250YWluZXIsIGFuaW1hdGUsIGNvbnRleHQpIHsKICAgICAgICAgICAgY29udGFpbmVyLmZpbmQoY29udGV4dCkuZmlsdGVyKCc6bm90KCcgKyBhbmltYXRlICsgJyknKS5yZW1vdmUoKTsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5hbmltYXRlQ29udGFpbmVyID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWFuaW1hdGUuY29udGFpbmVyLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2NvbnRleHQnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4uL3N1YmpxdWVyeSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18sIF9fc3VianF1ZXJ5X18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2NvbnZlbnRpb24vY29udGV4dC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyIHRRdWVyeSA9IHN1YmpxdWVyeS50UXVlcnk7CiAgICB2YXIgQ09OVEVYVCA9ICdjb25maWcuZG9tLmNvbnRleHQnOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBDT05URVhUCiAgICAgICAgXSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0gbW9kLmNvbnZlbnRpb24oQ09OVEVYVCk7CiAgICAgICAgICAgIGlmKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIG1vZC5pbnN0YW5jZS5kb20gPSBtb2QuaW5zdGFuY2UuJCA9IHRRdWVyeShjb250ZXh0LCBmYWNhZGUuY29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5jb250ZXh0ID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbnRleHQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vZXZlbnQnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vY29udmVudGlvbi9ldmVudC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIENPTlRFWFQgPSAnY29uZmlnLmRvbS5jb250ZXh0JywgRVZFTlRTID0gJ2NvbmZpZy5kb20uZXZlbnRzJywgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgdmFyIGV2ZW50UHJvcGVydHlMb2FkT3JkZXIgPSBbCiAgICAgICAgJ3NlbGVjdG9yJywgCiAgICAgICAgJ2RhdGEnLCAKICAgICAgICAnaGFuZGxlcicKICAgIF07CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIEVWRU5UUwogICAgICAgIF0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gbW9kLmNvbnZlbnRpb24oRVZFTlRTKSwgJGNvbnRleHQgPSBmYWNhZGUuY29udGV4dCwgbW9kdWxlSW5zdGFuY2UgPSBtb2QuaW5zdGFuY2U7CiAgICAgICAgICAgIGlmKGV2ZW50cykgewogICAgICAgICAgICAgICAgXy5mb3JJbihldmVudHMsIGZ1bmN0aW9uIChldmVudHNDb2xsZWN0aW9uLCBldmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vdmFyIGV2ZW50c0NvbGxlY3Rpb24gPSBldmVudHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGlmKCFpc0FycmF5KGV2ZW50c0NvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0NvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGV2ZW50c0NvbGxlY3Rpb24ubGVuZ3RoICYmICghaXNBcnJheShldmVudHNDb2xsZWN0aW9uWzBdKSB8fCBpc1N0cmluZyhldmVudHNDb2xsZWN0aW9uWzBdKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzQ29sbGVjdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0NvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGV2ZW50c0NvbGxlY3Rpb24sIGZ1bmN0aW9uIChkZWZpbml0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiaW5kRXZlbnQgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudAogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KGRlZmluaXRpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnQucHVzaC5hcHBseShiaW5kRXZlbnQsIGRlZmluaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgaGF2ZSBvbmUgZWRnZWNhc2UgaGVyZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHNob3J0IGhhbmQgYXJyYXksIGhhcyBhIGNvbnRleHQgdGhhdCBpcyBhIHN0cmluZyBvciBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGl0IGRvZXNudCBoYXZlIGluZm9ybWF0aW9uIGZvciBib3RoIHNlbGVjdG9yIGFuZCBkYXRhLCB0aGlzIHdpbGwgZmFpbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuIHJlY292ZXIgd2hlbiBhbGwgNSBwb3NzaWJsZSBpdGVtcyBhcmUgZGVmaW5lZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYW5kbGVyID0gYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIHdlcmUgYXNrZWQgZm9yIGEgbWV0aG9kIG9uIHRoZSBtb2R1bGUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyhoYW5kbGVyKSAmJiBiaW5kRXZlbnQubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAxXSA9IG1vZC5pbnN0YW5jZVtoYW5kbGVyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSAvLyBXZSBkaWRudCBmaW5kIGEgZnVuY3Rpb24gOigKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICBFREdFIENBU0U6IElmIGNvbnRleHQgaXMgYSBmdW5jdGlvbiwgd2Ugd2lsbCBhc3N1bWUgYWxsIGlzIHdlbGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICBFdmVuIGlmIHRoZSBoYW5kbGVyIGlzIGEgc3RyaW5nIHRoYXQgbmVlZHMgdG8gYmUgcmVmZXJlbmNlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdvcmsgYXJyb3VuZHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgIFNob3J0aGFuZDogYWRkIG51bGwvZW1wdHkgdmFsdWVzIGZvciBzZWxlY3RvciBhbmQgZGF0YQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICBMb25naGFuZDogc3dpdGNoIHRvIGxvbmcgaGFuZCBhcyBpdCBoYXMgbW9yZSBleHBsaWNpdCBzeW50YXguCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighaXNTdHJpbmcoaGFuZGxlcikgJiYgIWlzRnVuY3Rpb24oaGFuZGxlcikgJiYgYmluZEV2ZW50Lmxlbmd0aCA+IDIgfHwgYmluZEV2ZW50Lmxlbmd0aCA9PT0gNSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGhhbmRsZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMl0gPSBtb2QuaW5zdGFuY2VbaGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMl0gPSBfLmJpbmQoYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAyXSwgYmluZEV2ZW50LnBvcCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc1N0cmluZyhoYW5kbGVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV0gPSBtb2QuaW5zdGFuY2VbaGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmVhY2goZXZlbnRQcm9wZXJ0eUxvYWRPcmRlciwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkZWZpbml0aW9uW3hdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGRlZmluaXRpb25beF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHggPT09ICdoYW5kbGVyJyAmJiBkZWZpbml0aW9uLmNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gXy5iaW5kKHZhbHVlLCBkZWZpbml0aW9uLmNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudC5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxsIHRoZSBvbiBtZXRob2QsIHdpdGggb3VyIGFyZ3VtZW50cy4KICAgICAgICAgICAgICAgICAgICAgICAgJGNvbnRleHQub24uYXBwbHkoJGNvbnRleHQsIGJpbmRFdmVudCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSBtb2QuY29udmVudGlvbihFVkVOVFMpLCAkY29udGV4dCA9IGZhY2FkZS5jb250ZXh0OwogICAgICAgICAgICBpZigkY29udGV4dCkgewogICAgICAgICAgICAgICAgJGNvbnRleHQub2ZmKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5ldmVudCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LnRlbXBsYXRlCiAgICBAc3VibW9kdWxlIHRocnVzdC50ZW1wbGF0ZS5jb25maWcKICAgICoqLwogICAgLyoqCiAgICBSZXNvbHZlcyB0aGUgZ2l2ZW4gcHJvcGVydGllcyB3aGVuIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoZSBwbHVnaW4uCiAgICAKICAgIFRoaXMgaXMgZm9yIGludGVybmFsIHRocnVzdCB1c2UuICBUaHJ1c3QgdXNlcyB0aGlzIGFycmF5IHRvIGdlbmVyYXRlIHRoZSBwcm9wZXJ0aWVzIHRoYXQgbmVlZCB0byBiZSBoYW5kZWQKICAgIHRvIHRoZSBwbHVnaW4gY29uc3RydWN0b3IgbWV0aG9kLgogICAgCiAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnY2ZnJywgCiAgICAgICAgJ2RhdGEnCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvdGVtcGxhdGUuCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL3RlbXBsYXRlJywgCiAgICAgICAgJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL2tub2Nrb3V0LmVuZ2luZScKICAgIF07CiAgICAvKioKICAgIE1hcHMgdGhlIGF2YWlsYWJsZSB0ZW1wbGF0ZXMsIHRvIHRoZWlyIGFwcHJvcHJpYXRlIG1vZHVsZSBuYW1lLgogICAgCiAgICAqKnByZWNvbXBpbGVkIGlzIGEgc3BlY2lhbCBjYXNlLCBhbmQgdGhvc2UgbWV0aG9kcyBhcmUgZXhwZWN0ZWQgdG8gYmUgY29kZSBidWlsdCBmdW5jdGlvbnMuCiAgICAKICAgIEBwcm9wZXJ0eSB0eXBlcwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7T2JqZWN0fQogICAgKiovCiAgICBleHBvcnRzLnR5cGVzID0gewogICAgICAgICdkb1QnOiAnZG9UJywKICAgICAgICAncHJlY29tcGlsZWQnOiB0cnVlCiAgICB9OwogICAgLyoqCiAgICBNYXBzIHRoZSB0ZW1wbGF0ZSBldmFsdWF0b3JzLCBzbyB0aGF0IHdoZW4gY3JlYXRpbmcgYSB0ZW1wbGF0ZSBmb3Iga25vY2tvdXQsIGl0IGtub3dzIGhvdyB0byBwcm9wZXJseSBvdXRwdXQgdGhlIGluZm9ybWF0aW9uLgogICAgCiAgICBAcHJvcGVydHkgZXZhbHVhdG9ycwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7T2JqZWN0fQogICAgKiovCiAgICBleHBvcnRzLmV2YWx1YXRvcnMgPSB7CiAgICAgICAgJ2RvVCc6IHsKICAgICAgICAgICAgbGVmdDogJ3t7PSAnLAogICAgICAgICAgICByaWdodDogJ319JwogICAgICAgIH0KICAgIH07CiAgICAvKioKICAgIFRoZSBkZWZhdWx0IHRlbXBsYXRlIHR5cGUsIHVzZWQgd2hlbiBleHRlbnNpb24gaXNuJ3QgZ2l2ZW4uCiAgICAKICAgIEBwcm9wZXJ0eSBkZWZhdWx0VHlwZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJ2RvVCcKICAgICoqLwogICAgZXhwb3J0cy5kZWZhdWx0VHlwZSA9ICdkb1QnOwogICAgLyoqCiAgICBUaGUgYmFzZSBsb2NhdGlvbiwgcmVsYXRpdmUgdG8gdGhlIGFwcGxpY2F0aW9uIHBhdGggZm9yIHRlbXBsYXRlIGxvY2F0aW9uLgogICAgSWYgdGVtcGxhdGUgcGF0aHMgYXJlIGdpdmVuIHJlbGF0aXZlIHRvIGFwcGxpY2F0aW9uIHBhdGgsIHRoaXMgY2FuIGJlIGxlZnQgZW1wdHkuCiAgICAKICAgIEBwcm9wZXJ0eSBiYXNlVXJsCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtTdHJpbmd9CiAgICBAZGVmYXVsdCAnJwogICAgKiovCiAgICBleHBvcnRzLmJhc2VVcmwgPSAnJzsKICAgIC8qKgogICAgRGVmaW5lcyB0aGUgZXh0ZW5zaW9uIHVzZWQgZm9yIHRlbXBsYXRlcyBzdG9yZWQgb24gdGhlIHNlcnZlci4KICAgIAogICAgQHByb3BlcnR5IGV4dGVuc2lvbgogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJy50bXBsJwogICAgKiovCiAgICBleHBvcnRzLmV4dGVuc2lvbiA9ICcudG1wbCc7CiAgICAvKioKICAgIERlZmluZXMgdGhlIEFNRCBwYXRocyB0byBmaW5kIHRoZSBnaXZlbiB0ZW1wbGF0ZSB0eXBlCiAgICAKICAgIEBwcm9wZXJ0eSB0ZW1wbGF0ZVBhdGhzCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtTdHJpbmd9CiAgICBAZGVmYXVsdCB7fQogICAgKiovCiAgICBleHBvcnRzLnRlbXBsYXRlUGF0aHMgPSB7CiAgICAgICAgJ2RvVCc6ICdkb1QnCiAgICB9Owp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi9rbm9ja291dC5lbmdpbmUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJ2tub2Nrb3V0J10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19rb19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RlbXBsYXRlL3RlbXBsYXRlLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGtvID0gX19rb19fOwoKICAgIHZhciB3aGVuID0gdXRpbC53aGVuLCBlYWNoID0gXy5lYWNoLCBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LCBmaW5kID0gXy5maW5kLCBrbm9ja291dFRlbXBsYXRlcyA9IHsKICAgIH07CiAgICB2YXIgaW5pdEtub2Nrb3V0SW50ZWdyYXRpb24gPSBmdW5jdGlvbiAodGVtcGxhdGVNYW5hZ2VyKSB7CiAgICAgICAgdmFyIFRocnVzdFRlbXBsYXRlU291cmNlID0gKGtvKS50ZW1wbGF0ZVNvdXJjZXMudGhydXN0VGVtcGxhdGUgPSBmdW5jdGlvbiAodGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0VGVtcGxhdGVTb3VyY2UucHJvdG90eXBlID0gewogICAgICAgICAgICB0ZXh0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICBpZihhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQudGVtcGxhdGUuaHRtbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZS5odG1sID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKCdUaHJ1c3QgVGVtcGxhdGUgZG9lcyBub3Qgc3VwcG9ydCByZXdyaXRpbmcuLi4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICBpZighdGhhdC50ZW1wbGF0ZS5kYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZS5kYXRhID0gewogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQudGVtcGxhdGUuZGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRlbXBsYXRlLmRhdGFba2V5XSA9IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgLy8gQmVnaW4gaW50ZWdyYXRpb24gb2YgdGVtcGxhdGUgcGx1Z2luLCB3aXRoIEtub2Nrb3V0LgogICAgICAgIHZhciBvbGRFbmdpbmUgPSAoa28pLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlOwogICAgICAgIHZhciBjb252ZW50aW9uVGVtcGxhdGVFbmdpbmUgPSAoa28pLmNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB9OwogICAgICAgIGNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGUgPSBrby51dGlscy5leHRlbmQobmV3IChrbykudGVtcGxhdGVFbmdpbmUoKSwgewogICAgICAgICAgICByZW5kZXJUZW1wbGF0ZVNvdXJjZTogZnVuY3Rpb24gKHRlbXBsYXRlU291cmNlLCBiaW5kaW5nQ29udGV4dCwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgaWYodGVtcGxhdGVTb3VyY2UudGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdG9ycyA9IHRoaXMuZXZhbHVhdG9yczsKICAgICAgICAgICAgICAgICAgICBpZighZXZhbHVhdG9ycykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV2YWx1YXRvcnMgPSBldmFsdWF0b3JzID0gdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5ldmFsdWF0b3JzW3RlbXBsYXRlTWFuYWdlci5jb25maWcuZGVmYXVsdFR5cGVdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcpOwogICAgICAgICAgICAgICAgICAgIGlmKCFwcmVjb21waWxlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVjb21waWxlZCA9IHRlbXBsYXRlTWFuYWdlci5jb21waWxlKCd7eyB3aXRoKCRkYXRhKSB7IH19ICcgKyB0ZW1wbGF0ZVNvdXJjZS50ZXh0KCkgKyAiIHt7IH0gfX0iKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVTb3VyY2VbJ2RhdGEnXSgncHJlY29tcGlsZWQnLCBwcmVjb21waWxlZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIFJ1biB0aGUgdGVtcGxhdGUgYW5kIHBhcnNlIGl0cyBvdXRwdXQgaW50byBhbiBhcnJheSBvZiBET00gZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRNYXJrdXAgPSB0ZW1wbGF0ZVNvdXJjZS50ZW1wbGF0ZS5jb21waWxlZChiaW5kaW5nQ29udGV4dCkucmVwbGFjZSgvXHMrL2csICIgIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChrbykudXRpbHMucGFyc2VIdG1sRnJhZ21lbnQocmVuZGVyZWRNYXJrdXApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9sZEVuZ2luZS5yZW5kZXJUZW1wbGF0ZVNvdXJjZS5hcHBseShvbGRFbmdpbmUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jazogZnVuY3Rpb24gKHNjcmlwdCkgewogICAgICAgICAgICAgICAgaWYoIXRoaXMuZXZhbHVhdG9yQ2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZhbHVhdG9ycyA9IHRlbXBsYXRlTWFuYWdlci5jb25maWcuZXZhbHVhdG9yc1t0ZW1wbGF0ZU1hbmFnZXIuY29uZmlnLmRlZmF1bHRUeXBlXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV2YWx1YXRvckNhY2hlID0gZXZhbHVhdG9ycy5sZWZ0ICsgc2NyaXB0ICsgZXZhbHVhdG9ycy5yaWdodDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV2YWx1YXRvckNhY2hlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBtYWtlVGVtcGxhdGVTb3VyY2U6IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCkgewogICAgICAgICAgICAgICAgLy8gTmFtZWQgdGVtcGxhdGUKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiB0ZW1wbGF0ZSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZpbml0aW9uID0gdGVtcGxhdGVNYW5hZ2VyLmdldCh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRocnVzdFRlbXBsYXRlU291cmNlKGRlZmluaXRpb24pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBvbGRFbmdpbmUubWFrZVRlbXBsYXRlU291cmNlLmFwcGx5KG9sZEVuZ2luZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIChrbykuc2V0VGVtcGxhdGVFbmdpbmUobmV3IChrbykuY29udmVudGlvblRlbXBsYXRlRW5naW5lKCkpOwogICAgfTsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIGNvdW50ZG93bjogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICBpbml0S25vY2tvdXRJbnRlZ3JhdGlvbih0aHJ1c3QudGVtcGxhdGUpOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmtub2Nrb3V0RW5naW5lID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWtub2Nrb3V0LmVuZ2luZS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9jb252ZW50aW9uL3RlbXBsYXRlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGVtcGxhdGUvdGVtcGxhdGUuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgVEVNUExBVEVTID0gJ3RlbXBsYXRlcycsIHdoZW4gPSB1dGlsLndoZW4sIGVhY2ggPSBfLmVhY2gsIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksIGZpbmQgPSBfLmZpbmQ7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIFRFTVBMQVRFUwogICAgICAgIF0sCiAgICAgICAgaW5pdDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlcyA9IG1vZC5jb252ZW50aW9uKFRFTVBMQVRFUyksIGludmVydGVkVGVtcGxhdGVzID0gdXRpbC5pbnZlcnQodGVtcGxhdGVzKSwgbW9kdWxlSW5zdGFuY2UgPSBtb2QuaW5zdGFuY2U7CiAgICAgICAgICAgIGlmKHRlbXBsYXRlcykgewogICAgICAgICAgICAgICAgdmFyIGRlZmVycyA9IFtdOwogICAgICAgICAgICAgICAgZWFjaCh0ZW1wbGF0ZXMsIGZ1bmN0aW9uICh0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJzLnB1c2goZmFjYWRlLmZldGNoKHRlbXBsYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmYWNhZGUubG9hZGluZ1Byb21pc2UgPSB3aGVuLmFsbChkZWZlcnMpLnRoZW4oZnVuY3Rpb24gKGxvYWRlZFRlbXBsYXRlcykgewogICAgICAgICAgICAgICAgICAgIC8qanNoaW50IGxvb3BmdW5jOnRydWUgKi8KICAgICAgICAgICAgICAgICAgICBfLmVhY2goaW52ZXJ0ZWRUZW1wbGF0ZXMsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IF8uZmluZChsb2FkZWRUZW1wbGF0ZXMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geC5zaG9ydE5hbWUgPT09IGkgfHwgeC5uYW1lID09PSBpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlSW5zdGFuY2UudGVtcGxhdGVzW2ldID0gdGVtcGxhdGUuY29tcGlsZWQ7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICByZXR1cm4gZmFjYWRlLmxvYWRpbmdQcm9taXNlIHx8IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy50ZW1wbGF0ZSA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD10ZW1wbGF0ZS5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9zcGEvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5zcGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LnNwYS5jb25maWcKICAgICoqLwogICAgLyoqCiAgICBSZXNvbHZlcyB0aGUgZ2l2ZW4gcHJvcGVydGllcyB3aGVuIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoZSBwbHVnaW4uCiAgICAKICAgIFRoaXMgaXMgZm9yIGludGVybmFsIHRocnVzdCB1c2UuICBUaHJ1c3QgdXNlcyB0aGlzIGFycmF5IHRvIGdlbmVyYXRlIHRoZSBwcm9wZXJ0aWVzIHRoYXQgbmVlZCB0byBiZSBoYW5kZWQKICAgIHRvIHRoZSBwbHVnaW4gY29uc3RydWN0b3IgbWV0aG9kLgogICAgCiAgICBAZm9yIHRocnVzdC5zcGEuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ2NmZycsIAogICAgICAgICduYW1lJywgCiAgICAgICAgJ21lZGlhdG9yJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L21lZGlhdG9yLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3RhcnQnLCAKICAgICAgICAndGhydXN0L3NwYS9jb252ZW50aW9uL3NwYWxpbmsnCiAgICBdOwogICAgLyoqCiAgICBEZWZpbmVzIHRoZSB2YWx1ZSBvZiBjdXN0b20gcGFyYW1ldGVycy4KICAgIFlvdSBjYW4gYWxzbyBkZWZpbmUgY3VzdG9tIHBhcmFtZXRlcnMgdG8gYmUgYSByZWd1bGFyIGV4cHJlc3Npb24sIGFuZCB0aGVuIHVzZSB0aGVtIGluIHlvdXIgcm91dGVzCiAgICAKICAgIEBwcm9wZXJ0eSBwYXJhbXMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy5wYXJhbXMgPSB7CiAgICB9OwogICAgLyoqCiAgICBUaGUgcHJlZGZpbmVkIHJvdXRlcyB0byBiZSB1c2VkIGJ5IHNwYS4KICAgIAogICAgQHByb3BlcnR5IHJvdXRlcwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7T2JqZWN0fQogICAgKiovCiAgICBleHBvcnRzLnJvdXRlcyA9IHsKICAgIH07CiAgICAvKioKICAgIFRoZSBmaWxlIGV4c3RlbmlvbiB0aGF0IHNob3VsZCBiZSByZW1vdmVkIHdoZW4gcmVzb2x2aW5nIHJvdXRlcyBhbmQgc3RhcnRpbmcgbW9kdWxlcy4KICAgIAogICAgQHByb3BlcnR5IGZpbGVFeHRlbnNpb24KICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgICoqLwogICAgZXhwb3J0cy5maWxlRXh0ZW5zaW9uID0gJy5odG1sJzsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYS9jb252ZW50aW9uL3NwYWxpbmsnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJ3RocnVzdC9kb20vc3VianF1ZXJ5J10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19zdWJqcXVlcnlfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3NwYS9zcGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgc3VianF1ZXJ5ID0gX19zdWJqcXVlcnlfXzsKCiAgICB2YXIgJCA9IHN1YmpxdWVyeS50UXVlcnk7CiAgICB2YXIgcGFyc2VGdWxsSHJlZiA9IGZ1bmN0aW9uIChocmVmKSB7CiAgICAgICAgdmFyIGJhc2VVcmwgPSBsb2NhdGlvbi5wYXRobmFtZS5zdWJzdHJpbmcoMCwgbG9jYXRpb24ucGF0aG5hbWUubGFzdEluZGV4T2YoJy8nKSk7CiAgICAgICAgaWYoaHJlZi5pbmRleE9mKCcvJykgIT0gLTEpIHsKICAgICAgICAgICAgaHJlZiA9IGhyZWYuc3Vic3RyaW5nKGhyZWYubGFzdEluZGV4T2YoJy8nKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHJlZiA9ICcvJyArIGhyZWY7CiAgICAgICAgfQogICAgICAgIHJldHVybiBiYXNlVXJsICsgaHJlZjsKICAgIH07CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LmRvbQogICAgQHN1Ym1vZHVsZSB0aHJ1c3QuZG9tLmNvbnZlbnRpb24KICAgICoqLwogICAgLyoqCiAgICAqICMgX190aHJ1c3QvZG9tX18gQ29udmVudGlvbiAtIFNpbmdsZSBQYWdlIEFwcCBMaW5rCiAgICAqCiAgICAqIFJlcXVpcmVzIHRocnVzdC9kb20KICAgICoKICAgICogQGZvciB0aHJ1c3QuZG9tLmNvbnZlbnRpb24KICAgICogQHByb3BlcnR5IHNwYTtpbmsKICAgICoqLwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIGNvbmZpZyA9IHRocnVzdC5jb25maWcsIHNwYSA9IHRocnVzdC5zcGE7CiAgICAgICAgICAgICQub24oJ2NsaWNrJywgJ2EnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgdmFyIGxpbmsgPSBwYXJzZUZ1bGxIcmVmKHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJykpOwogICAgICAgICAgICAgICAgaWYobGluay5pbmRleE9mKGNvbmZpZy51cmwucGF0aCkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBzcGEubmF2aWdhdGUobGluayk7CiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5zcGFsaW5rID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXNwYWxpbmsuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3Qvc3BhL2NvbnZlbnRpb24vc3RhcnQnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9zcGEvc3BhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RlbXBsYXRlL3RlbXBsYXRlLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5zcGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LnNwYS5jb252ZW50aW9uCiAgICAqKi8KICAgIC8qKgogICAgKiAjIF9fdGhydXN0L3NwYV9fIENvbnZlbnRpb24gLSBTdGFydAogICAgKgogICAgKiBUaGUgc2luZ2xlIHBhZ2UgYXBwIHN0YXJ0IGNvbnZlbnRpb24sIGRvZXMgdGhlIGFjdHVhbCBzdGFydGluZyBvZiB0aGUgcGx1Z2luLCBpbiBhZGRpdGlvbiBpdCBhbHNvIGRlbGF5cwogICAgKiBmdWxsIG9yYml0LCB1bnRpbCBhbnkgbW9kdWxlIGl0IGhhcyBzdGFydGVkIGhhcyBiZWVuIGxvYWRlZC4KICAgICoKICAgICogQGZvciB0aHJ1c3Quc3BhLmNvbnZlbnRpb24KICAgICogQHByb3BlcnR5IHN0YXJ0CiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gewogICAgICAgIG9yYml0OiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciByb3V0ZXIgPSB0aHJ1c3Quc3BhOwogICAgICAgICAgICByb3V0ZXIuc3RhcnQoKTsKICAgICAgICAgICAgcmV0dXJuIHRocnVzdC5zcGEuc3RhcnRpbmdNb2R1bGVQcm9taXNlIHx8IG51bGw7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuc3RhcnQgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9c3RhcnQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICd0aHJ1c3QvZXZlbnRzJywgJ3RocnVzdC9mYWNhZGUnLCAnaGFzJywgJ3RocnVzdC9jb25maWcnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fbG9nX18sIF9fZXZlbnRzX18sIF9fZmFjYWRlX18sIF9faGFzX18sIF9fY29uZmlnX18sIF9fbWVkaWF0b3JDb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaGFzLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIC8vaW1wb3J0IGV2ZW50cyA9IG1vZHVsZSgndGhydXN0L2V2ZW50cycpOwogICAgdmFyIGV2ZW50cyA9IF9fZXZlbnRzX187CgogICAgdmFyIEV2ZW50cyA9IGV2ZW50cy5FdmVudHM7CiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgY29uZmlnID0gX19jb25maWdfXzsKCiAgICB2YXIgbWVkaWF0b3JDb25maWcgPSBfX21lZGlhdG9yQ29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnTWVkaWF0b3InOwogICAgLy8gVmFyaWFibGUgZGVjbGFyYXRpb24uCiAgICAgICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBleHRlbmQgPSAvLyBzdHJpbmcgZm9ybWF0IG1ldGhvZAogICAgXy5leHRlbmQsIHdoZW4gPSAvLyBvYmplY3QgZXh0ZW5zaW9uIG1ldGhvZAogICAgdXRpbC53aGVuLCBtZW1vaXplID0gXy5tZW1vaXplLCBtZWRpYXRvciwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgICB2YXIgYyA9IGNvbmZpZzsKICAgIC8vI3JlZ2lvbiBGYWNhZGUKICAgIC8qKgogICAgQ3JlYXRlcyBhIG5ldyBtZWRpYXRvciBmYWNhZGUgZm9yIHRoZSBnaXZlbiBtb2R1bGUuCiAgICAKICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yCiAgICBAY2xhc3MgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICBAcGFyYW0ge3RocnVzdC5NZWRpYXRvcn0gcGFyZW50IFRoZSBwYXJlbnQgbWVkaWF0b3IgdG8gY3JlYXRlIHRoZSBmYWNhZGUgb24uCiAgICAqKi8KICAgIHZhciBNZWRpYXRvckZhY2FkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG1lZGlhdG9yRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kdWxlLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbW9kdWxlLm5hbWU7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gcGFyZW50Ll9fY29udmVudGlvbnM7CiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IHBhcmVudC5fY2FsbGJhY2tzOwogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMobW9kdWxlKTsKICAgICAgICB9KTsKICAgICAgICBfLmV4dGVuZChtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUsIEV2ZW50cyk7CiAgICAgICAgLyoqCiAgICAgICAgRHVyaW5nIHRoZSBzdGFydCBvZiBhIG1lZGlhdG9yIGZhY2FkZSwgc3RhcnQgY3JlYXRlcyB0aGUgaW50ZXJuYWwgc3Vic2NyaXB0aW9ucyBhcnJheS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5tZWRpYXRvci5NZWRpYXRvckZhY2FkZQogICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAqKi8KICAgICAgICBtZWRpYXRvckZhY2FkZS5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgbWVkaWF0b3JGYWNhZGUucHJvdG90eXBlLnN0YXJ0ID0gbWVkaWF0b3JGYWNhZGUucHJvdG90eXBlLmluaXQ7CiAgICAgICAgLyoqCiAgICAgICAgT3ZlcnJpZGVzIHRoZSBzdWJzY3JpYmUgbWV0aG9kLCBhbmQgdHJhY2tzIHRoZSBhbnkgZXZlbnQgdGhhdCBpcyBib3VuZC4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5tZWRpYXRvci5NZWRpYXRvckZhY2FkZQogICAgICAgIEBtZXRob2Qgc3Vic2NyaWJlCiAgICAgICAgKiovCiAgICAgICAgKG1lZGlhdG9yRmFjYWRlKS5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnRzOiBldmVudHMsCiAgICAgICAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBFdmVudHMuc3Vic2NyaWJlLmNhbGwodGhpcywgZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgfTsKICAgICAgICAvKioKICAgICAgICBVbnN1YnNjcmliZXMgZnJvbSBhbGwgZXZlbnRzIHRoYXQgd2VyZSBzdWJzY3JpYmVkIHRvLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yRmFjYWRlCiAgICAgICAgQG1ldGhvZCBzdG9wCiAgICAgICAgKiovCiAgICAgICAgbWVkaWF0b3JGYWNhZGUucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICBpZih0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMpIHsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdWIgPSB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnNbaV07CiAgICAgICAgICAgICAgICAgICAgdGhpcy51bnN1YnNjcmliZShzdWIuZXZlbnRzLCBzdWIuY2FsbGJhY2ssIHN1Yi5jb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbWVkaWF0b3JGYWNhZGU7CiAgICB9KSgpOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyBPdXIgZGVmYXVsdCBuYW1lc3BhY2UgcHJlZml4LgogICAgLyoqCiAgICBNZWRpYXRvciBjbGFzcy4KICAgIFRoaXMgY3JlYXRlcyBhIGluc3RhbmNlIG9mIHRoZSBtZWRpYXRvciwgZm9yIHVzZSBpbnNpZGUgdGhydXN0LgogICAgCiAgICBAZm9yIHRocnVzdC5tZWRpYXRvcgogICAgQGNsYXNzIHRocnVzdC5tZWRpYXRvci5NZWRpYXRvcgogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbWVkaWF0b3IuCiAgICAqKi8KICAgIHZhciBNZWRpYXRvciA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8jZW5kcmVnaW9uCiAgICAgICAgZnVuY3Rpb24gTWVkaWF0b3IobmFtZSwgY29uZmlnKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgYXBwUGF0aCA9IGNvbmZpZyAmJiBjb25maWcudXJsICYmIGNvbmZpZy51cmwucGF0aDsKICAgICAgICAgICAgdGhhdC5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdNZWRpYXRvcjogQ3JlYXRpbmcgbmV3IE1lZGlhdG9yIHswfScsIG5hbWUpKTsKICAgICAgICAgICAgdGhhdC5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoYXQuc3Vic2NyaWJlKCd0aHJ1c3QvcmVhZHknLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0cnVlICYmIGxvZy5pbmZvKCdNZWRpYXRvcjogUmVhZHkhJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZihmYWNhZGVzLm1lZGlhdG9yICYmICEoZmFjYWRlcy5tZWRpYXRvciBpbnN0YW5jZW9mIE1lZGlhdG9yRmFjYWRlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCcibWVkaWF0b3IiIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWVkaWF0b3I7CiAgICAgICAgICAgIGlmKGZhY2FkZXMubWVkaWF0b3IpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IudXBkYXRlRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgICAgICBtZWRpYXRvciA9IGZhY2FkZXMubWVkaWF0b3I7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZWRpYXRvciA9IGZhY2FkZXMubWVkaWF0b3IgPSAobW9kKS5tZWRpYXRvciA9IG5ldyBNZWRpYXRvckZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtZWRpYXRvcjsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLmNvbmZpZyA9IG1lZGlhdG9yQ29uZmlnOwogICAgICAgIHJldHVybiBNZWRpYXRvcjsKICAgIH0pKCk7CiAgICBleHBvcnRzLk1lZGlhdG9yID0gTWVkaWF0b3I7ICAgIAogICAgLy8gR2V0IHRoZSBhY3R1YWwgZXZlbnQgbWV0aG9kcyBvbnRvIHRoZSBNZWRpYXRvcgogICAgXy5leHRlbmQoTWVkaWF0b3IucHJvdG90eXBlLCBFdmVudHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21lZGlhdG9yJywgWyd0aHJ1c3QvbWVkaWF0b3IvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9kYXRhL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJ2pxdWVyeScsICd0aHJ1c3QvbG9nJywgJy4vY29uZmlnJywgJ3RocnVzdC9jb25maWcnLCAnLi9ldmVudC5mYWN0b3J5JywgJy4vcmVzcG9uc2UucXVldWUnLCAndGhydXN0L2V2ZW50cycsICd0aHJ1c3QvZmFjYWRlJywgJy4vZXZlbnQudHlwZXMnLCAnaGFzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19qUXVlcnlfXywgX19sb2dfXywgX19jb25maWdfXywgX190Q29uZmlnX18sIF9fZXZlbnRGYWN0b3J5X18sIF9fcmVzcG9uc2VRdWV1ZV9fLCBfX2V2ZW50c19fLCBfX2ZhY2FkZV9fLCBfX2V2ZW50VHlwZXNfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2pxdWVyeS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGpRdWVyeSA9IF9falF1ZXJ5X187CgogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgZXZlbnRGYWN0b3J5ID0gX19ldmVudEZhY3RvcnlfXzsKCiAgICB2YXIgcmVzcG9uc2VRdWV1ZSA9IF9fcmVzcG9uc2VRdWV1ZV9fOwoKICAgIHZhciBSZXNwb25zZVF1ZXVlID0gcmVzcG9uc2VRdWV1ZS5SZXNwb25zZVF1ZXVlOwogICAgdmFyIGV2ZW50cyA9IF9fZXZlbnRzX187CgogICAgdmFyIEV2ZW50cyA9IGV2ZW50cy5FdmVudHM7CiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ0RhdGEnOwogICAgY29uZmlnOwogICAgLy8gVmFyaWFibGUgZGVjbGFyYXRpb24uCiAgICAgICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIGFqYXggPSBqUXVlcnkuYWpheCwgdWlkID0gXy51bmlxdWVJZCwgZGF0YUV2ZW50V2FpdCA9IGV2ZW50VHlwZXNbJ3dhaXQnXSwgZGF0YUV2ZW50U3RhcnQgPSBldmVudFR5cGVzWydzdGFydCddLCBkYXRhRXZlbnRTdG9wID0gZXZlbnRUeXBlc1snc3RvcCddLCBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzWydzdGF0dXMnXSwgYXJndW1lbnRSZXNvbHZlciA9IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gbWV0aG9kKF8udG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgICB9OwogICAgfTsKICAgIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWwgPSAhIXRDb25maWcudXJsLnRyYWRpdGlvbmFsRW5jb2Rpbmc7CiAgICB2YXIgakRvYyA9IGpRdWVyeShkb2N1bWVudCk7CiAgICBldmVudEZhY3RvcnkuaW5pdChqRG9jKTsKICAgIC8vI3JlZ2lvbiBEYXRhRmFjYWRlCiAgICAvKioKICAgIFRoZSBkYXRhIGZhY2FkZSB0aGF0IGlzIGhhbmRlZCBvZmYgdG8gbW9kdWxlcy4KICAgIAogICAgCiAgICBFbmFibGVzIGRhdGEgdHJhbnNwb3J0LCB1c2luZyBqUXVlcnkgZm9yIHRocnVzdC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgQGNsYXNzIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICBAcGFyYW0ge3RocnVzdC5kYXRhLkRhdGF9IHBhcmVudCBUaGUgcGFyZW50IHRocnVzdCBkYXRhIG9iamVjdCB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IuCiAgICBAY29uc3RydWN0b3IKICAgICoqLwogICAgdmFyIERhdGFGYWNhZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBkYXRhRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kdWxlLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbW9kdWxlLm5hbWUgKyAnLWRhdGEnOwogICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSBwYXJlbnQuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5yZXNwb25zZVF1ZXVlID0gcGFyZW50LnJlc3BvbnNlUXVldWU7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgICAgICB0aGlzLmRlZmF1bHRzID0gcGFyZW50LmRlZmF1bHRzOwogICAgICAgICAgICB0aGlzLmFwcFBhdGggPSBwYXJlbnQuYXBwUGF0aDsKICAgICAgICB9KTsKICAgICAgICBfLmV4dGVuZChkYXRhRmFjYWRlLnByb3RvdHlwZSwgZXZlbnRzKTsKICAgICAgICByZXR1cm4gZGF0YUZhY2FkZTsKICAgIH0pKCk7CiAgICAvLyNlbmRyZWdpb24KICAgIC8qKgogICAgVGhlIG1hc3RlciBkYXRhIHBsdWdpbi4KICAgIAogICAgCiAgICBFbmFibGVzIGRhdGEgdHJhbnNwb3J0LCB1c2luZyBqUXVlcnkgZm9yIHRocnVzdC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgQGNsYXNzIHRocnVzdC5kYXRhLkRhdGEKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZS4KICAgIEBwYXJhbSB7dGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yfSBtZWRpYXRvciBUaGUgdGhydXN0IG1lZGlhdG9yIGluc3RhbmNlLgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGluc3RhbmNlIGNvbmZpZ3VyYXRpb24uCiAgICBAY29uc3RydWN0b3IKICAgICoqLwogICAgdmFyIERhdGEgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vI2VuZHJlZ2lvbgogICAgICAgIGZ1bmN0aW9uIERhdGEobmFtZSwgbWVkaWF0b3IsIGNvbmZpZykgewogICAgICAgICAgICBpZighbmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEYXRhOiBtb2R1bGUgbmFtZSBtdXN0IGJlIGRlZmluZWQuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy5yZXNwb25zZVF1ZXVlID0gbmV3IFJlc3BvbnNlUXVldWUodGhpcywgY29uZmlnLmRhdGEuc3RhcnRUaW1lb3V0LCBjb25maWcuZGF0YS5maW5pc2hUaW1lb3V0KTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoJ0RhdGE6IENyZWF0aW5nIG5ldyBEYXRhJyk7CiAgICAgICAgICAgIHRoaXMubWVkaWF0b3IgPSBtZWRpYXRvcjsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gKHRoaXMpLm1lZGlhdG9yLl9jYWxsYmFja3M7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgICAgICB0aGlzLmRlZmF1bHRzID0gewogICAgICAgICAgICAgICAgY2FjaGU6IGNvbmZpZy5kYXRhLmNhY2hlLAogICAgICAgICAgICAgICAgYmVmb3JlU2VuZDogZXZlbnRGYWN0b3J5LmJlZm9yZVNlbmRNZXRob2QsCiAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAgdHlwZTogJ1BPU1QnLAogICAgICAgICAgICAgICAgdXJsOiAnJywKICAgICAgICAgICAgICAgIGRhdGE6ICcnLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJywKICAgICAgICAgICAgICAgIF9fbWVkaWF0b3JfZGF0YV9maXJlZF9fOiB0cnVlLAogICAgICAgICAgICAgICAgc2lsZW50OiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmFwcFBhdGggPSBjb25maWcudXJsLnBhdGggKyAnLyc7CiAgICAgICAgfQogICAgICAgIERhdGEucHJvdG90eXBlLmluaXRFdmVudHMgPSAvLyNyZWdpb24gRXZlbnRzCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIG9uY2UpIHsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIERhdGFGYWNhZGUgZm9yIHRoZSBnaXZlbiBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBjcmVhdGVGYWNhZGUKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICBAcGFyYW0ge01vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgYXZhaWxhYmxlIGZhY2FkZXMKICAgICAgICBAcmV0dXJucyB7RGF0YUZhY2FkZX0gVGhlIG5ldyBEYXRhRmFjYWRlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIGlmKG1vZC5kYXRhICYmICEoZmFjYWRlcy5kYXRhIGluc3RhbmNlb2YgRGF0YUZhY2FkZSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignImRhdGEiIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGF0YTsKICAgICAgICAgICAgaWYoZmFjYWRlcy5kYXRhKSB7CiAgICAgICAgICAgICAgICBmYWNhZGVzLmRhdGEudXBkYXRlRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgICAgICBkYXRhID0gZmFjYWRlcy5kYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGF0YSA9IGZhY2FkZXMuZGF0YSA9IG1vZC5kYXRhID0gbmV3IERhdGFGYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmdldERhdGEgPSAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIGZvciB0aGUgZ2l2ZW4gZGF0YSBhbmQgc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBnZXREYXRhCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBwYXNzIHRvIHRoZSBnaXZlbiB1cmwKICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhIEdFVCB0byB0aGUgc2VydmVyLCBmb3IgdGhlIGdpdmVuIGRhdGEgYW5kIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgZ2V0RGF0YQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgdG8gcGFzcyB0byB0aGUgZ2l2ZW4gdXJsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh1cmwsIGRhdGEsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIHNldHRpbmdzID0gIXNldHRpbmdzID8gewogICAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9IDogZXh0ZW5kKHNldHRpbmdzLCB7CiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQodXJsLCBzZXR0aW5ncyk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5wb3N0RGF0YSA9IC8qKgogICAgICAgIERvZXMgYSBQT1NUIHRvIHRoZSBzZXJ2ZXIsIGZvciB0aGUgZ2l2ZW4gZGF0YSBhbmQgc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBwb3N0RGF0YQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgdG8gcGFzcyB0byB0aGUgZ2l2ZW4gdXJsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYSBQT1NUIHRvIHRoZSBzZXJ2ZXIsIGZvciB0aGUgZ2l2ZW4gZGF0YSBhbmQgc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBwb3N0RGF0YQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgdG8gcGFzcyB0byB0aGUgZ2l2ZW4gdXJsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh1cmwsIGRhdGEsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIHNldHRpbmdzID0gIXNldHRpbmdzID8gewogICAgICAgICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoZGF0YSkKICAgICAgICAgICAgfSA6IGV4dGVuZChzZXR0aW5ncywgewogICAgICAgICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoZGF0YSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvc3QodXJsLCBzZXR0aW5ncyk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5nZXQgPSAvKioKICAgICAgICBEb2VzIGEgR0VUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBnZXREYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhIEdFVCB0byB0aGUgc2VydmVyLCB1c2luZyB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgRGF0YSBtdXN0IGJlIHBhc3NlZCBpbiB1c2luZyBzZXR0aW5nczogeyBkYXRhOiB7fSB9IG90aGVyd2lzZSB1c2UgZ2V0RGF0YS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh1cmwsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIGlmKHNldHRpbmdzID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLnVybCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdXJsIGlzIGRlZmluZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgZXh0ZW5kKHNldHRpbmdzIHx8IHsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgdHlwZTogJ2dldCcKICAgICAgICAgICAgfSkpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUucG9zdCA9IC8qKgogICAgICAgIERvZXMgYSBQT1NUIHRvIHRoZSBzZXJ2ZXIsIHVzaW5nIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBEYXRhIG11c3QgYmUgcGFzc2VkIGluIHVzaW5nIHNldHRpbmdzOiB7IGRhdGE6IHt9IH0gb3RoZXJ3aXNlIHVzZSBwb3N0RGF0YS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIHBvc3QKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgUE9TVCB0byB0aGUgc2VydmVyLCB1c2luZyB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgRGF0YSBtdXN0IGJlIHBhc3NlZCBpbiB1c2luZyBzZXR0aW5nczogeyBkYXRhOiB7fSB9IG90aGVyd2lzZSB1c2UgcG9zdERhdGEuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBwb3N0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHVybCwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgaWYoc2V0dGluZ3MgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdXJsID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB1cmw7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodXJsID09PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MudXJsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyB1cmwgaXMgZGVmaW5lZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCBleHRlbmQoc2V0dGluZ3MgfHwgewogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICB0eXBlOiAncG9zdCcKICAgICAgICAgICAgfSkpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuYWpheCA9IC8qKgogICAgICAgIERvZXMgYW4gYWpheCBjYWxsIHRvIHRoZSBnaXZlbiB1cmwsIHdpdGggdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgYWpheAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYW4gYWpheCBjYWxsIHRvIHRoZSBnaXZlbiB1cmwsIHdpdGggdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgYWpheAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh1cmwsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgb3B0aW9ucywgdHlwZSwgYmVmb3JlU2VuZDsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ0RhdGFbezB9XTogRmV0Y2hpbmcgZGF0YSBmcm9tICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHVybCkpOwogICAgICAgICAgICBpZihzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVybCA9IHV0aWwuZml4dXBVcmwodXJsLCB0aGF0LmFwcFBhdGgpOwogICAgICAgICAgICBpZihzZXR0aW5ncy5zaWxlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBkZm8gPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgcXVlcnlJZCA9IHVpZCgnZHEnKTsKICAgICAgICAgICAgICAgIHR5cGUgPSBzZXR0aW5ncy50eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgICAgICAgIH0sIHRoYXQuZGVmYXVsdHMsIHsKICAgICAgICAgICAgICAgICAgICBiZWZvcmVTZW5kOiB1dGlsLm5vb3AKICAgICAgICAgICAgICAgIH0sIHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIGFqYXgodXJsLCBvcHRpb25zKS50aGVuKGFyZ3VtZW50UmVzb2x2ZXIoZGZvLnJlc29sdmUpLCBhcmd1bWVudFJlc29sdmVyKGRmby5yZWplY3QpKTsKICAgICAgICAgICAgICAgIHJldHVybiBkZm8ucHJvbWlzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgICAgfSwgdGhhdC5kZWZhdWx0cywgc2V0dGluZ3MsIHsKICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IGV2ZW50RmFjdG9yeS5iZWZvcmVTZW5kTWV0aG9kCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0eXBlID0gb3B0aW9ucy50eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3BvbnNlUXVldWUuYWRkVG9RdWV1ZSh0eXBlLCB1cmwsIG9wdGlvbnMpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5jb25maWcgPSBjb25maWc7CiAgICAgICAgcmV0dXJuIERhdGE7CiAgICB9KSgpOwogICAgZXhwb3J0cy5EYXRhID0gRGF0YTsgICAgCiAgICBfLmV4dGVuZChEYXRhLnByb3RvdHlwZSwgRXZlbnRzKTsKICAgIF8uZXh0ZW5kKERhdGFGYWNhZGUucHJvdG90eXBlLCBEYXRhLnByb3RvdHlwZSk7CiAgICAvLyBUYWtlIGEgaG9sZCBvZiBqUXVlcnkuLi4gdGhpcyBpcyBzdXJlIHRvIGJlIGNvbnRyYXZlc2lhbAogICAgalF1ZXJ5LmFqYXggPSAoRGF0YSkucHJvdG90eXBlLmFqYXg7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YScsIFsndGhydXN0L2RhdGEvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9kb20vbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAnLi9zdWJqcXVlcnknLCAndGhydXN0L3V0aWwnLCAndGhydXN0L2xvZycsICd0aHJ1c3QvZmFjYWRlJywgJ2hhcycsICd0aHJ1c3QvaW5zdGFuY2UnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19zdWJqcXVlcnlfXywgX191dGlsX18sIF9fbG9nX18sIF9fZmFjYWRlX18sIF9faGFzX18sIF9faW5zdGFuY2VfXywgX19jb25maWdfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyIHRRdWVyeSA9IHN1YmpxdWVyeS50UXVlcnk7CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGZhY2FkZSA9IF9fZmFjYWRlX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGluc3RhbmNlID0gX19pbnN0YW5jZV9fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ0RvbSc7CiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGV4dGVuZCA9IF8uZXh0ZW5kLCBiaW5kID0gXy5iaW5kLCBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LCBpc09iamVjdCA9IF8uaXNPYmplY3QsIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCB3aGVuID0gdXRpbC53aGVuLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgLy8jcmVnaW9uIERvbUZhY2FkZQogICAgdmFyIERvbUZhY2FkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRvbUZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZCwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IHBhcmVudC5uYW1lOwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gdFF1ZXJ5KGRvY3VtZW50LCB1bmRlZmluZWQsIHRoaXMubmFtZSk7CiAgICAgICAgfSk7CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKGZha2UpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMgPSB0aGlzLl9pbnRlcm5hbEV2ZW50cyB8fCBbXTsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogSW5pdGFsaXppbmcgezF9RG9tIGZhY2FkZScsIHRoaXMubmFtZSwgZmFrZSA/ICdmYWtlICcgOiAnJykpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIGRvbUZhY2FkZS5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICB0cnVlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBTdGFydGluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogU3RvcHBpbmcgRG9tIGZhY2FkZScsIHRoaXMubmFtZSkpOwogICAgICAgICAgICBmb3IodmFyIGkgPSB0aGlzLl9pbnRlcm5hbEV2ZW50cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdmFyIHN1YiA9IHRoaXMuX2ludGVybmFsRXZlbnRzW2ldOwogICAgICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxFdmVudHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgc3ViLmNvbnRleHQub2ZmLmFwcGx5KHRoaXMsIChpc0FycmF5KHN1YikpID8gc3ViIDogKGlzQXJyYXkoc3ViLmFyZ3MpKSA/IHN1Yi5hcmdzIDogW10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZG9tRmFjYWRlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogRGVzdHJveWluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lKSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbnRlcm5hbEV2ZW50czsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZG9tRmFjYWRlOwogICAgfSkoKTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIERvbQogICAgdmFyIERvbSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8jZW5kcmVnaW9uCiAgICAgICAgZnVuY3Rpb24gRG9tKG5hbWUsIG1lZGlhdG9yKSB7CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbTogbW9kdWxlIG5hbWUgbXVzdCBiZSBkZWZpbmVkLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKCdEYXRhOiBDcmVhdGluZyBuZXcgRGF0YScpOwogICAgICAgICAgICB0aGlzLm1lZGlhdG9yID0gbWVkaWF0b3I7CiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IChtZWRpYXRvcikuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShuYW1lKS5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICAgICAgdmFyIG1vZCA9IHsKICAgICAgICAgICAgICAgIH0sIGZhY2FkZSA9IHRoYXQuY3JlYXRlRmFjYWRlKHRocnVzdCwgbW9kLCB7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBEb20ucHJvdG90eXBlLmluaXRFdmVudHMgPSAvLyNyZWdpb24gRXZlbnRzCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIH07CiAgICAgICAgRG9tLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbiAodG8sIGluaXQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBEb20ucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgfTsKICAgICAgICBEb20ucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBEb20uY29uZmlnID0gY29uZmlnOwogICAgICAgIERvbS5wcm90b3R5cGUuY3JlYXRlRmFjYWRlID0gZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIGlmKGZhY2FkZXMuZG9tICYmICEoZmFjYWRlcy5kb20gaW5zdGFuY2VvZiBEb21GYWNhZGUpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyJkb20iIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZG9tOwogICAgICAgICAgICBpZihmYWNhZGVzLmRvbSkgewogICAgICAgICAgICAgICAgZmFjYWRlcy5kb20udXBkYXRlRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgICAgICBkb20gPSBmYWNhZGVzLmRvbTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRvbSA9IGZhY2FkZXMuZG9tID0gbmV3IERvbUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkb207CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gRG9tOwogICAgfSkoKTsKICAgIGV4cG9ydHMuRG9tID0gRG9tOyAgICAKICAgIC8vI2VuZHJlZ2lvbgogICAgfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20nLCBbJ3RocnVzdC9kb20vbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICdkb21SZWFkeScsICd0aHJ1c3QvZmFjYWRlJywgJy4vY29uZmlnJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX2RvbVJlYWR5X18sIF9fZmFjYWRlX18sIF9fY29uZmlnX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RlbXBsYXRlL3RlbXBsYXRlLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIAogICAgCiAgICB2YXIgZG9tUmVhZHkgPSBfX2RvbVJlYWR5X187CgogICAgdmFyIGZhY2FkZSA9IF9fZmFjYWRlX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnVGVtcGxhdGUnOwogICAgY29uZmlnOwogICAgdmFyIExPTkcgPSAnbG9uZycsIFNIT1JUID0gJ3Nob3J0JywgSUQgPSAnaWQnLCBkZWVwQ29weSA9IF8ubWVyZ2UsIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBlYWNoID0gXy5lYWNoLCBiaW5kID0gXy5iaW5kLCB3aGVuID0gdXRpbC53aGVuLCByZWR1Y2UgPSBfLnJlZHVjZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZSwgbWFwID0gXy5tYXAsIGV4dGVuZCA9IF8uZXh0ZW5kLCBnZXRMb25nTmFtZSA9IGZ1bmN0aW9uIChuYW1lLCB0eXBlKSB7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCByZXN1bHQgPSAodGhhdC5zaG9ydE5hbWUobmFtZSkgKyAnLicgKyAodHlwZSB8fCB0aGF0LmNvbmZpZy5kZWZhdWx0VHlwZSkgKyB0aGF0LmNvbmZpZy5leHRlbnNpb24pLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sIGdldFNob3J0TmFtZSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCByZXN1bHQgPSByZWR1Y2UodGhhdC50ZW1wbGF0ZVR5cGVzLCBmdW5jdGlvbiAobWVtbywgeCkgewogICAgICAgICAgICByZXR1cm4gbWVtby5yZXBsYWNlKCcuJyArIHgudG9Mb3dlckNhc2UoKSArIHRoYXQuY29uZmlnLmV4dGVuc2lvbiwgJycpOwogICAgICAgIH0sIG5hbWUudG9Mb3dlckNhc2UoKSkudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwgZ2V0VGVtcGxhdGVJZCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCByZXN1bHQgPSB0aGF0LnNob3J0TmFtZShuYW1lKS5yZXBsYWNlKC9cLy9nLCAnLScpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC50ZW1wbGF0ZQogICAgQHJlcXVpcmVzIHRocnVzdC5kYXRhCiAgICAqKi8KICAgIC8qKgogICAgVGhlIHRlbXBsYXRlIHBsdWdpbiBjb25zdHVyY3Rvci4KICAgIAogICAgQGZvciB0aHJ1c3QudGVtcGxhdGUKICAgIEBjbGFzcyB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRocnVzdCBjb25maWcgb2JqZWN0CiAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgdGhydXN0IGRhdGEgaW5zdGFuY2UKICAgIEB1c2VzIHRocnVzdC5kYXRhLkRhdGEKICAgIEBjb25zdHJ1Y3RvcgogICAgKiovCiAgICB2YXIgVGVtcGxhdGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFRlbXBsYXRlKGNvbmZpZywgZGF0YSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRlbXBsYXRlQ29uZmlnID0gdGhpcy5jb25maWcgPSBjb25maWcudGVtcGxhdGU7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVUeXBlcyA9IG1hcCh0ZW1wbGF0ZUNvbmZpZy50eXBlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZXMgPSB7CiAgICAgICAgICAgICAgICBsb25nOiB7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2hvcnQ6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpZDogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGF0LmxvbmdOYW1lID0gbWVtb2l6ZShiaW5kKGdldExvbmdOYW1lLCB0aGF0KSk7CiAgICAgICAgICAgIHRoYXQuc2hvcnROYW1lID0gbWVtb2l6ZShiaW5kKGdldFNob3J0TmFtZSwgdGhhdCkpOwogICAgICAgICAgICB0aGF0LnRlbXBsYXRlSWQgPSBtZW1vaXplKGJpbmQoZ2V0VGVtcGxhdGVJZCwgdGhhdCkpOwogICAgICAgICAgICB0aGF0LmVuZ2luZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoYXQuZGF0YSA9IGRhdGE7CiAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgKHRlbXBsYXRlQ29uZmlnLnRlbXBsYXRlUGF0aHNbdGVtcGxhdGVDb25maWcuZGVmYXVsdFR5cGVdIHx8ICd0aHJ1c3QvdGVtcGxhdGUvJyArIHRlbXBsYXRlQ29uZmlnLmRlZmF1bHRUeXBlKQogICAgICAgICAgICBdLCBmdW5jdGlvbiAoZW5naW5lKSB7CiAgICAgICAgICAgICAgICB0aGF0LmVuZ2luZXNbdGVtcGxhdGVDb25maWcuZGVmYXVsdFR5cGVdID0gZW5naW5lOwogICAgICAgICAgICAgICAgZG9tUmVhZHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIChfKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKSkpLmZpbHRlcihmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gISF4LmdldEF0dHJpYnV0ZSgnZGF0YS10ZW1wbGF0ZScpOwogICAgICAgICAgICAgICAgICAgIH0pLmVhY2goYmluZCh0aGF0LmNyZWF0ZUZyb21Eb21Ob2RlLCB0aGF0KSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5nZXQgPSAvKioKICAgICAgICBHZXRzIGEgdGVtcGxhdGUgZnJvbSB0aGUgY2FjaGUgaWYgaXQgaGFzIGJlZW4gZmV0Y2hlZC4gRmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBnZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZSB0byB0cnkgYW5kIGdldC4KICAgICAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSB0ZW1wbGF0ZSBvYmplY3QKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBHZXRzIGEgdGVtcGxhdGUgZnJvbSB0aGUgY2FjaGUgaWYgaXQgaGFzIGJlZW4gZmV0Y2hlZC4gRmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlRmFjYWRlCiAgICAgICAgQG1ldGhvZCBnZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZSB0byB0cnkgYW5kIGdldC4KICAgICAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSB0ZW1wbGF0ZSBvYmplY3QKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBudWxsLCB0aGF0ID0gdGhpcywgdGVtcGxhdGVzID0gdGhhdC50ZW1wbGF0ZXM7CiAgICAgICAgICAgIGlmKHRlbXBsYXRlID0gdGVtcGxhdGVzLmxvbmdbdGhhdC5sb25nTmFtZShuYW1lKV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgICAgICAgfSBlbHNlIGlmKHRlbXBsYXRlID0gdGVtcGxhdGVzLnNob3J0W3RoYXQuc2hvcnROYW1lKG5hbWUpXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICB9IGVsc2UgaWYodGVtcGxhdGUgPSB0ZW1wbGF0ZXMuaWRbdGhhdC50ZW1wbGF0ZUlkKG5hbWUpXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLnNldCA9IC8qKgogICAgICAgIFNldHMgYSB0ZW1wbGF0ZSB0byB0aGUgY2FjaGUsIHdpdGggdGhlIGdpdmVuIGluZm9ybWF0aW9uCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIHNldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHRlbXBsYXRlIGVuZ2luZSB0eXBlCiAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY29tcGlsZWRUZW1wbGF0ZSBUaGUgY29tcGlsZWQgdGVtcGxhdGUgbWV0aG9kCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGh0bWwgVGhlIHRlbXBsYXRlIEhUTUwuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIHR5cGUsIGNvbXBpbGVkVGVtcGxhdGUsIGh0bWwpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBzaG9ydE5hbWUgPSB0aGF0LnNob3J0TmFtZShuYW1lKSwgdGVtcGxhdGVJZCA9IHRoYXQudGVtcGxhdGVJZChuYW1lKSwgbG9uZ05hbWUgPSB0aGF0LmxvbmdOYW1lKG5hbWUsIHR5cGUpLCB0ZW1wbGF0ZXMgPSB0aGF0LnRlbXBsYXRlczsKICAgICAgICAgICAgdGVtcGxhdGVzLmxvbmdbbG9uZ05hbWVdID0gdGVtcGxhdGVzLnNob3J0W3Nob3J0TmFtZV0gPSB0ZW1wbGF0ZXMuaWRbdGVtcGxhdGVJZF0gPSB7CiAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgc2hvcnROYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgaWQ6IHRlbXBsYXRlSWQsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgaHRtbDogaHRtbCwKICAgICAgICAgICAgICAgIGNvbXBpbGVkOiBjb21waWxlZFRlbXBsYXRlCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuaGFzID0gLyoqCiAgICAgICAgQ2hlY2tzIGlmIHRoZSB0ZW1wbGF0ZSBleGlzdHMgaW4gdGhlIGNhY2hlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBoYXMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEByZXR1cm5zIHtCb29sZWFufSBXZXRoZXIgdGhlIHRlbXBsYXRlIGV4aXN0cyBvciBub3QuCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgQ2hlY2tzIGlmIHRoZSB0ZW1wbGF0ZSBleGlzdHMgaW4gdGhlIGNhY2hlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlRmFjYWRlCiAgICAgICAgQG1ldGhvZCBoYXMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEByZXR1cm5zIHtCb29sZWFufSBXZXRoZXIgdGhlIHRlbXBsYXRlIGV4aXN0cyBvciBub3QuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gISF0aGF0LmdldChuYW1lKTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5uZXdUZW1wbGF0ZSA9IC8qKgogICAgICAgIENyZWF0ZXMgYSBuZXcgdGVtcGxhdGUgZ2l2ZW4gdGhlIGluZm9ybWF0aW9uCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIG5ld1RlbXBsYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdGVtcGxhdGUgZW5naW5lIHR5cGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaHRtbCBUaGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICBAcGFyYW0ge1N0cmluZ30gZW5naW5lIFRoZSB0ZW1wbGF0ZSBlbmdpbmUKICAgICAgICBAcmV0dXJucyB7T2JqZWN0fSBUaGUgbmV3IHRlbXBsYXRlIGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCB0eXBlLCBodG1sLCBlbmdpbmUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCB0ZW1wbGF0ZSA9IHRoYXQuZ2V0KG5hbWUpOwogICAgICAgICAgICBpZighdGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgIGlmKHR5cGUgPT0gJ3ByZWNvbXBpbGVkJykgewogICAgICAgICAgICAgICAgICAgIHRoYXQuc2V0KG5hbWUsIHR5cGUsIGh0bWwsIGh0bWwudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0aW5nTWV0aG9kOwogICAgICAgICAgICAgICAgICAgIHZhciBjb21waWxlZFRlbXBsYXRlID0gdGhpcy5jb21waWxlKGh0bWwsIGVuZ2luZSk7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5zZXQobmFtZSwgdHlwZSwgY29tcGlsZWRUZW1wbGF0ZSwgaHRtbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoYXQuZ2V0KG5hbWUpOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmNvbXBpbGUgPSAvKioKICAgICAgICBDb21waWxlcyBhIHRlbXBsYXRlIGdpdmVuIHRoZSBodG1sIGFuZCB0aGUgZW5naW5lIHR5cGUuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGUKICAgICAgICBAbWV0aG9kIGNvbXBpbGUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaHRtbCBUaGUgaHRtbCB0byBnZW5lcmF0ZSB0aGUgdGVtcGxhdGUgZnJvbQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBlbmdpbmUgVGhlIHRlbXBsYXRlIGVuZ2luZSB0aGF0IGlzIGJlaW5nIHVzZWQuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgY29tcGlsZWQgdGVtcGxhdGUgbWV0aG9kCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGh0bWwsIGVuZ2luZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRlbXBsYXRpbmdNZXRob2Q7CiAgICAgICAgICAgIGlmKCFlbmdpbmUpIHsKICAgICAgICAgICAgICAgIGVuZ2luZSA9IHRoYXQuZW5naW5lc1t0aGF0LmNvbmZpZy5kZWZhdWx0VHlwZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodHlwZW9mIGVuZ2luZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgdGVtcGxhdGluZ01ldGhvZCA9IGVuZ2luZTsKICAgICAgICAgICAgfSBlbHNlIGlmKHR5cGVvZiBlbmdpbmUudGVtcGxhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHRlbXBsYXRpbmdNZXRob2QgPSBlbmdpbmUudGVtcGxhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRpbmdNZXRob2QoaHRtbCk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuZmV0Y2ggPSAvKioKICAgICAgICBGZXRjaHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBzZXJ2ZXIsIG9yIHRlbXBsYXRlIHN0b3JlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBmZXRjaAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IFt0eXBlXSBUaGUgdGVtcGxhdGUgdHlwZSBpZiBub3QgdGhlIGRlZmF1bHQKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgZm9yIHdoZW4gdGhlIHRlbXBsYXRlIGhhcyBiZWVuIGxvYWRlZC4KICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBGZXRjaHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBzZXJ2ZXIsIG9yIHRlbXBsYXRlIHN0b3JlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlRmFjYWRlCiAgICAgICAgQG1ldGhvZCBmZXRjaAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IFt0eXBlXSBUaGUgdGVtcGxhdGUgdHlwZSBpZiBub3QgdGhlIGRlZmF1bHQKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgZm9yIHdoZW4gdGhlIHRlbXBsYXRlIGhhcyBiZWVuIGxvYWRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSwgdHlwZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHR5cGUgPSB0eXBlIHx8IHRoYXQuY29uZmlnLmRlZmF1bHRUeXBlLCBzaG9ydE5hbWUgPSB0aGF0LnNob3J0TmFtZShuYW1lKSwgbG9uZ05hbWUgPSB0aGF0LmxvbmdOYW1lKG5hbWUsIHR5cGUpLCB0ZW1wbGF0ZTsKICAgICAgICAgICAgdmFyIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICBpZih0ZW1wbGF0ZSA9IHRoYXQuZ2V0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoYXQuZGF0YS5nZXQodGhhdC5jb25maWcuYmFzZVVybCArIGxvbmdOYW1lLCB7CiAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogJ3RleHQvcGxhaW4nLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6ICd0ZXh0JywKICAgICAgICAgICAgICAgIHNpbGVudDogdHJ1ZQogICAgICAgICAgICB9KS50aGVuKHdoZW4uYXBwbHkoZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgIGlmKHR5cGUgPT0gJ3ByZWNvbXBpbGVkJykgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoYXQubmV3VGVtcGxhdGUobmFtZSwgdHlwZSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmKHRoYXQuZW5naW5lc1t0eXBlXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGF0Lm5ld1RlbXBsYXRlKG5hbWUsIHR5cGUsIGRhdGEsIHRoYXQuZW5naW5lc1t0eXBlXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRoYXQuY29uZmlnLnRlbXBsYXRlUGF0aHNbdHlwZV0gfHwgJ3RocnVzdC90ZW1wbGF0ZS8nICsgdHlwZSkKICAgICAgICAgICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKGVuZ2luZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5lbmdpbmVzW3R5cGVdID0gZW5naW5lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhLCBlbmdpbmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSksIGRlZmVyLnJlamVjdCk7CiAgICAgICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmNyZWF0ZUZyb21Eb21Ob2RlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0ZW1wbGF0ZSBmcm9tIHRoZSBnaXZlbiBET00gTm9kZQogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBjcmVhdGVGcm9tRG9tTm9kZQogICAgICAgIEBwcm90ZWN0ZWQKICAgICAgICBAcGFyYW0ge05vZGV9IGVsZW1lbnQgVEhlIGRvbWUgZWxlbWVudC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoYXQubmV3VGVtcGxhdGUoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGVtcGxhdGUnKSwgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdHlwZScpLCBlbGVtZW50LnRleHQpOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IC8qKgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBjcmVhdGVGYWNhZGUKICAgICAgICBAcGFyYW0ge3RocnVzdC5UaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBhbHJlYWR5IGFkZGVkIGZvciB0aGlzIG1vZHVsZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlSW5zdGFuY2UgPSB0aHJ1c3QudGVtcGxhdGU7CiAgICAgICAgICAgIHZhciBmYWNhZGUgPSBmYWNhZGVzLnRlbXBsYXRlID0gbmV3IFRlbXBsYXRlRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgIG1vZC50ZW1wbGF0ZXMgPSB7CiAgICAgICAgICAgICAgICBmZXRjaDogYmluZCh0ZW1wbGF0ZUluc3RhbmNlLmZldGNoLCB0ZW1wbGF0ZUluc3RhbmNlKSwKICAgICAgICAgICAgICAgIGdldDogYmluZCh0ZW1wbGF0ZUluc3RhbmNlLmdldCwgdGVtcGxhdGVJbnN0YW5jZSksCiAgICAgICAgICAgICAgICBoYXM6IGJpbmQodGVtcGxhdGVJbnN0YW5jZS5oYXMsIHRlbXBsYXRlSW5zdGFuY2UpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBmYWNhZGU7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5jb25maWcgPSBjb25maWc7CiAgICAgICAgcmV0dXJuIFRlbXBsYXRlOwogICAgfSkoKTsKICAgIGV4cG9ydHMuVGVtcGxhdGUgPSBUZW1wbGF0ZTsgICAgCiAgICAvKioKICAgIAogICAgQGZvciB0aHJ1c3QudGVtcGxhdGUKICAgIEBjbGFzcyB0aHJ1c3QudGVtcGxhdGUuVGVtcGxhdGVGYWNhZGUKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgIEBwYXJhbSB7dGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlfSBwYXJlbnQgVGhlIHRlbXBsYXRlIGluc3RhbmNlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvci4KICAgICoqLwogICAgdmFyIFRlbXBsYXRlRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdGVtcGxhdGVGYWNhZGUgPSBmYWNhZGUuY3JlYXRlRmFjYWRlKGZ1bmN0aW9uIChtb2R1bGUsIHBhcmVudCkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBtb2R1bGUubmFtZSArICctdGVtcGxhdGUnOwogICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICBleHRlbmQodGhpcywgewogICAgICAgICAgICAgICAgZmV0Y2g6IGJpbmQocGFyZW50LmZldGNoLCBwYXJlbnQpLAogICAgICAgICAgICAgICAgZ2V0OiBiaW5kKHBhcmVudC5nZXQsIHBhcmVudCksCiAgICAgICAgICAgICAgICBoYXM6IGJpbmQocGFyZW50LmhhcywgcGFyZW50KQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGVtcGxhdGVGYWNhZGU7CiAgICB9KSgpOwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSB0aHJ1c3QvdGVtcGxhdGUgYnkgcGF0aC4KICAgIFJlcXVpcmVzIHRoZSBpbnN0YW5jZSwgdGhhdCB0aGUgdGVtcGxhdGUgaXMgZXhwZWN0ZWQgdG8gY29tZSBmcm9tLgogICAgdGhydXN0SW5zdGFuY2VbOmVuZ2luZU5hbWVdOnRlbXBsYXRlUGF0aAogICAgCiAgICBQcmVmaXggd2l0aCA8ZW5naW5lTmFtZT46IHRvIHNlbGVjdCBhIHNwZWNpZmljIHRlbXBsYXRlIGVuZ2luZS4KICAgIHRocnVzdC90ZW1wbGF0ZSFnbG9iYWw6dGVtcGxhdGVzL215VGVtcGxhdGUudG1wbCA9IFNwZWNpZmljIHRlbXBsYXRlCiAgICB0aHJ1c3QvdGVtcGxhdGUhaW5zdGFuY2UyOnRlbXBsYXRlcy9teVRlbXBsYXRlID0gVXNlcyBkZWZhdWx0IGV4dGVuc2lvbiBmcm9tIGNvbmZpZwogICAgdGhydXN0L3RlbXBsYXRlIWluc3RhbmNlMjprZW5kbzp0ZW1wbGF0ZXMvbXlUZW1wbGF0ZS50bXBsID0gVXNlcyB0aGUga2VuZG8gdGVtcGxhdGUgZW5naW5lLgogICAgdGhydXN0L3RlbXBsYXRlIWluc3RhbmNlMzprZW5kbzp0ZW1wbGF0ZXMvbXlUZW1wbGF0ZS50bXBsID0gVXNlcyB0aGUga2VuZG8gdGVtcGxhdGUgZW5naW5lIHdpdGggdGhlIGRlZmF1bHQgZXh0ZW5zaW9uCiAgICAKICAgIAogICAgQG1ldGhvZCBsb2FkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgdGVtcGxhdGUgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgLy8gTm90IGNvbXBsZXRlZCB5ZXQKICAgIC8vIFNob3VsZCBiZWhhdmUgc2ltaWxhcmx5IHRvIHRleHQhCiAgICAvL2V4cG9ydCBmdW5jdGlvbiBsb2FkKG5hbWU6IHN0cmluZywgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKQogICAgLy97CiAgICAvLyAgICB2YXIgdGVtcGxhdGVQYXRoID0gbmFtZSwKICAgIC8vICAgICAgICB0ZW1wbGF0ZUVuZ2luZSwKICAgIC8vICAgICAgICBjb2xvbiA9IHRlbXBsYXRlUGF0aC5pbmRleE9mKCc6Jyk7CiAgICAvLwl2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksCiAgICAvLyAgICAgICAgaW5zdGFuY2VOYW1lID0gcGFydHNbMF0sCiAgICAvLwkJdGVtcGxhdGVFbmdpbmUgPSBwYXJ0c1sxXSwKICAgIC8vCQl0ZW1wbGF0ZVBhdGggPSBwYXJ0c1syXSB8fCB0ZW1wbGF0ZUVuZ2luZTsKICAgIC8vICAgIGlmIChwYXJ0cy5sZW5ndGggPT09IDIpCiAgICAvLyAgICAgICAgdGVtcGxhdGVFbmdpbmUgPSBudWxsOwogICAgLy8JLy92YXIgaW5zdGFuY2VQcm9taXNlID0gVGhydXN0Ll9fZmV0Y2hJbnN0YW5jZShyZWFsTmFtZSk7CiAgICAvLyAgICAvLyBHZXQgdGhlIGRhdGEgcGx1Z2luLgogICAgLy8gICAgcGFyZW50UmVxdWlyZShbJ3RocnVzdCFkYXRhOicgKyBpbnN0YW5jZU5hbWVdLCAoZGF0YVBsdWdpbikgPT4KICAgIC8vICAgIHsKICAgIC8vICAgICAgICB2YXIgZGF0YVBsdWdpbiA9IGRhdGFQbHVnaW4KICAgIC8vICAgIH0pOwogICAgLy99CiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3RlbXBsYXRlJywgWyd0aHJ1c3QvdGVtcGxhdGUvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9zcGEvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAndGhydXN0JywgJ3RocnVzdC9sb2cnLCAnaGFzJywgJ2ZsYXRpcm9uL2RpcmVjdG9yJywgJ3RocnVzdC9pbnN0YW5jZScsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX190aHJ1c3RfXywgX19sb2dfXywgX19oYXNfXywgX19mbGF0aXJvblJvdXRlcl9fLCBfX2luc3RhbmNlX18sIF9fY29uZmlnX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvc3BhL3NwYS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgdGhydXN0ID0gX190aHJ1c3RfXzsKCiAgICB2YXIgVGhydXN0ID0gdGhydXN0LlRocnVzdDsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBmbGF0aXJvblJvdXRlciA9IF9fZmxhdGlyb25Sb3V0ZXJfXzsKCiAgICB2YXIgUm91dGVyID0gZmxhdGlyb25Sb3V0ZXIuUm91dGVyIHx8IGZsYXRpcm9uUm91dGVyOwogICAgCiAgICB2YXIgaW5zdGFuY2UgPSBfX2luc3RhbmNlX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnU2luZ2xlUGFnZUFwcGxpY2F0aW9uJzsKICAgIGNvbmZpZzsKICAgIHZhciBlYWNoID0gXy5lYWNoLCBpc1N0cmluZyA9IF8uaXNTdHJpbmcsIGlzQXJyYXkgPSBfLmlzQXJyYXksIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgaXNSZWdFeHAgPSBfLmlzUmVnRXhwLCBleHRlbmQgPSBfLmV4dGVuZCwgb25jZSA9IF8ub25jZSwgd2hlbiA9IHV0aWwud2hlbiwgYmluZCA9IF8uYmluZCwgaW52b2tlID0gXy5pbnZva2UsIHBsdWNrID0gXy5wbHVjaywgbWFwID0gXy5tYXAsIGRlZmVyID0gXy5kZWZlciwgcmVkdWNlID0gXy5yZWR1Y2UsIG1lbW9pemUgPSBfLm1lbW9pemUsIHRvQXJyYXkgPSBfLnRvQXJyYXksIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBTVEFSVCA9ICdzdGFydCc7CiAgICB2YXIgZXh0cmFjdFBhcmFtcyA9IGZ1bmN0aW9uIChyb3V0ZSkgewogICAgICAgIHZhciBwYXJhbXMgPSBbXSwgaW5kZXggPSByb3V0ZS5pbmRleE9mKCc6JyksIHNsYXNoSW5kZXg7CiAgICAgICAgd2hpbGUoaW5kZXggPiAtMSkgewogICAgICAgICAgICBzbGFzaEluZGV4ID0gcm91dGUuaW5kZXhPZignLycsIGluZGV4KTsKICAgICAgICAgICAgaWYoc2xhc2hJbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHNsYXNoSW5kZXggPSByb3V0ZS5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyYW1zLnB1c2gocm91dGUuc3Vic3RyaW5nKGluZGV4LCBzbGFzaEluZGV4IC0gaW5kZXggKyAxKSk7CiAgICAgICAgICAgIHJvdXRlID0gcm91dGUuc3Vic3RyaW5nKHNsYXNoSW5kZXgpOwogICAgICAgICAgICBpbmRleCA9IHJvdXRlLmluZGV4T2YoJzonKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH07CiAgICB2YXIgZXZlbnRGYWN0b3J5ID0gZnVuY3Rpb24gKGV2ZW50LCBtZWRpYXRvcikgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRydWUgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRmlyaW5nIHNwYSAiezB9IiB3aXRoIFt7MX1dJywgZXZlbnQsIHRvQXJyYXkoYXJndW1lbnRzKS5qb2luKCcsJykpKTsKICAgICAgICAgICAgbWVkaWF0b3IuZmlyZS5hc3luYy5hcHBseShtZWRpYXRvciwgWwogICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgICAgfTsKICAgIH07CiAgICAvKioKICAgIAogICAgQGZvciB0aHJ1c3Quc3BhCiAgICBAY2xhc3MgdGhydXN0LnNwYS5TaW5nbGVQYWdlQXBwCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRocnVzdCBpbnN0YW5jZSBjb25maWd1cmF0aW9uCiAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZQogICAgQHBhcmFtIHt0aHJ1c3QubWVkaWF0b3JNZWRpYXRvcn0gbWVkaWF0b3IgVGhlIHRocnVzdCBpbnN0YW5jZSBtZWRpYXRvcgogICAgKiovCiAgICB2YXIgU2luZ2xlUGFnZUFwcGxpY2F0aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBTaW5nbGVQYWdlQXBwbGljYXRpb24oY29uZmlnLCBpbnN0YW5jZU5hbWUsIG1lZGlhdG9yKSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnRpbmdNb2R1bGVQcm9taXNlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LmJhc2VVcmwgPSBjb25maWcudXJsLnBhdGg7CiAgICAgICAgICAgIHZhciBzcGFDb25maWcgPSBjb25maWcuc3BhOwogICAgICAgICAgICB0aGF0LmZpbGVFeHRlbnNpb24gPSBzcGFDb25maWcuZmlsZUV4dGVuc2lvbjsKICAgICAgICAgICAgdmFyIHJvdXRlcyA9IHRoYXQuY29uZmlndXJlUm91dGVzKHNwYUNvbmZpZy5yb3V0ZXMpLCBwYXJhbXMgPSBzcGFDb25maWcucGFyYW1zOwogICAgICAgICAgICB2YXIgZXZlbnRGYWN0b3J5ID0gbWVtb2l6ZShmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ1ZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdGaXJpbmcgc3BhICJ7MH0iIHdpdGggW3sxfV0nLCBldmVudCwgdG9BcnJheShhcmd1bWVudHMpLmpvaW4oJywnKSkpOwogICAgICAgICAgICAgICAgICAgIG1lZGlhdG9yLmZpcmUuYXN5bmMuYXBwbHkobWVkaWF0b3IsIFsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgICAgICBdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgcm91dGVyID0gdGhhdC5yb3V0ZXIgPSBuZXcgUm91dGVyKHJvdXRlcykuY29uZmlndXJlKHsKICAgICAgICAgICAgICAgIHJlY3Vyc2U6IGZhbHNlLAogICAgICAgICAgICAgICAgc3RyaWN0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgICAgICAgICAgIGh0bWw1aGlzdG9yeTogdHJ1ZSwKICAgICAgICAgICAgICAgIG5vdGZvdW5kOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvbm90Zm91bmQnKSwKICAgICAgICAgICAgICAgIGJlZm9yZTogZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL2JlZm9yZScpLAogICAgICAgICAgICAgICAgb246IGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9ydW4nKSwKICAgICAgICAgICAgICAgIGFmdGVyOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvYWZ0ZXInKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgXy5lYWNoKHBhcmFtcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJvdXRlci5wYXJhbShpLCB4KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBTdGFydCB0aGUgc2luZ2xlIHBhZ2UgYXBwIHJvdXRlci4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHRoYXQuc3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGF0LnRocnVzdCA9IGluc3RhbmNlLmdldEluc3RhbmNlKGluc3RhbmNlTmFtZSk7CiAgICAgICAgICAgICAgICB0aGF0LnJvdXRlci5pbml0KCk7CiAgICAgICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jKCd0aHJ1c3Qvc3BhL3N0YXJ0Jyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoYXQubmF2aWdhdGUgPSB0aGF0Lm5hdmlnYXRlLmJpbmQodGhhdCk7CiAgICAgICAgfQogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUubmF2aWdhdGUgPSAvKioKICAgICAgICBOYXZpZ2F0ZXMgdG8gdGhlIGdpdmVuIHVybC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIG5hdmlnYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGxvY2F0aW9uIFRoZSBsb2NhdGlvbiB0byBuYXZpZ2F0ZSB0by4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobG9jYXRpb24pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgdXJsID0gdXRpbC5maXh1cFVybChsb2NhdGlvbiwgdGhhdC5iYXNlVXJsKTsKICAgICAgICAgICAgdGhhdC5yb3V0ZXIuc2V0Um91dGUodXJsKTsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUuc3RhcnQgPSAvKioKICAgICAgICBTdGFydCB0aGUgc2luZ2xlIHBhZ2UgYXBwIHJvdXRlci4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnRocnVzdCA9IGluc3RhbmNlLmdldEluc3RhbmNlKHRoaXMuaW5zdGFuY2VOYW1lKTsKICAgICAgICAgICAgdGhpcy5yb3V0ZXIuaW5pdCgpOwogICAgICAgICAgICB0aGlzLnRocnVzdC5tZWRpYXRvci5maXJlLmFzeW5jKCd0aHJ1c3Qvc3BhL3N0YXJ0Jyk7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLmNvbmZpZ3VyZVJvdXRlcyA9IC8qKgogICAgICAgIENvbmZpZ3VyZXMgdGhlIHJvdXRlIG9iamVjdCBmb3IgdGhlIHNwYSBpbnN0YW5jZQogICAgICAgIAogICAgICAgIFJvdXRlcyBjYW4gYmUgaW4gNCBmb3JtcwogICAgICAgIAogICAgICAgIHsKICAgICAgICAnL3BhdGgvdG8vOmZvbyc6ICdwYXRoL3RvL21vZHVsZScsCiAgICAgICAgJy9wYXRoL3RvLzpiYXInOiBbJ3BhdGgvdG8vbW9kdWxlMScsICdwYXRoL3RvL21vZHVsZTInXSwKICAgICAgICAnL3BhdGgvdG8vOmZiJzogeyBwYXRoOiAncGF0aC90by9tb2R1bGUnLCBhcmdzOiBbJ2FyZ3MnLCAndG8nLCAnaGFuZCBvZmYgdG8gc3RhcnQnXSB9CiAgICAgICAgJy9wYXRoL3RvLzpmb28vOmJhcic6IGZ1bmN0aW9uKGZvbywgYmFyKXsgIGN1c3RvbSBoYW5kbGVyIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjb25maWd1cmVSb3V0ZXMKICAgICAgICBAcGFyYW0ge09iamVjdH0gcm91dGVzIE9iamVjdCBvZiByb3V0ZXMuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHJvdXRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGNvbmZpZ3VyZWRSb3V0ZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIGVhY2gocm91dGVzLCBmdW5jdGlvbiAodmFsdWUsIHJvdXRlKSB7CiAgICAgICAgICAgIGZvcih2YXIgcm91dGUgaW4gcm91dGVzKSB7CiAgICAgICAgICAgICAgICBpZihfLmhhcyhyb3V0ZXMsIHJvdXRlKSkgewogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHJvdXRlc1tyb3V0ZV07CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlYWxSb3V0ZSA9IHV0aWwuZml4dXBVcmwocm91dGUsIHRoYXQuYmFzZVVybCk7CiAgICAgICAgICAgICAgICAgICAgaWYoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJlZFJvdXRlc1tyZWFsUm91dGVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVzID0gW10sIG1ldGhvZHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IHZhbHVlLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHYgPSB2YWx1ZVt2XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKHYpIHx8IGlzT2JqZWN0KHYpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzRnVuY3Rpb24odikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2RzLnB1c2godik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUNhbGxiYWNrID0gdGhhdC5tb2R1bGVTdGFydENhbGxiYWNrKHJvdXRlLCBtb2R1bGVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kcy5wdXNoKG1vZHVsZUNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJlZFJvdXRlc1tyZWFsUm91dGVdID0gbWV0aG9kczsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVDYWxsYmFjayA9IHRoYXQubW9kdWxlU3RhcnRDYWxsYmFjayhyb3V0ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmVkUm91dGVzW3JlYWxSb3V0ZV0gPSBtb2R1bGVDYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy99KTsKICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ3VyZWRSb3V0ZXM7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLm1vZHVsZVN0YXJ0Q2FsbGJhY2sgPSAvKioKICAgICAgICAKICAgICAgICBAbWV0aG9kIG1vZHVsZVN0YXJ0Q2FsbGJhY2sKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nIHwgQXJyYXkgfCBPYmplY3R9IG1vZHVsZXMgU3RyaW5nIHRvIHN0YXJ0IGEgc2luZ2xlIG1vZHVsZSwgQXJyYXkgdG8gc3RhcnQgbWFueSBtb2R1bGVzLCBPYmplY3QgdG8gc3RhcnQgYSBtb2R1bGUgd2l0aCBzcGVjaWZpYyBhcmd1bWVudHMuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHJvdXRlLCBtb2R1bGVzKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW10sIHBhcmFtcyA9IGV4dHJhY3RQYXJhbXMocm91dGUpLCB0aGF0ID0gdGhpcywgZmlsZUV4dGVuc2lvbiA9IHRoYXQuZmlsZUV4dGVuc2lvbjsKICAgICAgICAgICAgaWYoaXNPYmplY3QobW9kdWxlcykpIHsKICAgICAgICAgICAgICAgIGFyZ3MgPSBtb2R1bGVzLmFyZ3MgfHwgYXJnczsKICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBtb2R1bGVzLnBhdGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoaXNTdHJpbmcobW9kdWxlcykpIHsKICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlcwogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGFyID0gdG9BcnJheShhcmd1bWVudHMpLCB0aHJ1c3QgPSB0aGF0LnRocnVzdCwgbWFwcGVkTW9kdWxlcyA9IG1hcChtb2R1bGVzLCBmdW5jdGlvbiAobW9kdWxlUGF0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZWR1Y2UoYXIsIGZ1bmN0aW9uIChtZW1vLCBhcmcsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lbW8ucmVwbGFjZShwYXJhbXNbaV0sIGFyZy50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICB9LCBtb2R1bGVQYXRoKS5yZXBsYWNlKGZpbGVFeHRlbnNpb24sICcnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aHJ1c3Quc3RhcnQuYXBwbHkodGhydXN0LCBbCiAgICAgICAgICAgICAgICAgICAgbWFwcGVkTW9kdWxlcwogICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICAgICAgaWYoIXRoYXQudGhydXN0LnN0YXJ0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJ1c3QucmVhZHkobWFwcGVkTW9kdWxlcywgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0aW5nTW9kdWxlUHJvbWlzZSA9IHByb21pc2U7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IC8qKgogICAgICAgIEhhbmRzIHRoZSBuYXZpZ2F0ZSBtZXRob2Qgb2ZmIHRvIHRoZSBtb2R1bGUsIHNvIGFueSBtb2R1bGUgY2FuIHRyaWdnZXIgYSBuYXZpZ2F0aW9uIGV2ZW50LgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnNwYS5TaW5nbGVQYWdlQXBwCiAgICAgICAgQG1ldGhvZCBjcmVhdGVGYWNhZGUKICAgICAgICBAcGFyYW0ge3RocnVzdC5UaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2QgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBhbHJlYWR5IGFkZGVkIGZvciB0aGlzIG1vZHVsZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZihtb2QubmF2aWdhdGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignIm5hdmlnYXRlIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQWxyZWFkeSBwcmUgYm91bmQsIHNvIHdlIG9ubHkgcGFzcyBhcm91bmQgMSBmdW5jdGlvbiBwZXIgaW5zdGFuY2UuCiAgICAgICAgICAgIG1vZC5uYXZpZ2F0ZSA9IHRoYXQubmF2aWdhdGUuYmluZCh0aGF0KTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24uY29uZmlnID0gY29uZmlnOwogICAgICAgIHJldHVybiBTaW5nbGVQYWdlQXBwbGljYXRpb247CiAgICB9KSgpOwogICAgZXhwb3J0cy5TaW5nbGVQYWdlQXBwbGljYXRpb24gPSBTaW5nbGVQYWdlQXBwbGljYXRpb247ICAgIAp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYScsIFsndGhydXN0L3NwYS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 20:05:27 GMT",
                    "Content-Length": "231837",
                    "Date": "Sat, 08 Nov 2014 20:05:27 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}