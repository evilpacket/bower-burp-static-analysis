{
    "url": "http://localhost:9999/highslide-software/highcharts.com/lib/mootools-core-1.4.5-full-nocompat.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>url = document.location.pathname;</li><li>url = url.substr(0, trimPosition);</li><li>xhr.open(method.toUpperCase(), url, this.options.async, this.options.user, this.options.password);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/highslide-software/highcharts.com/lib/mootools-core-1.4.5-full-nocompat.js",
                "path": "/highslide-software/highcharts.com/lib/mootools-core-1.4.5-full-nocompat.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9oaWdoc2xpZGUtc29mdHdhcmUvaGlnaGNoYXJ0cy5jb20vbGliL21vb3Rvb2xzLWNvcmUtMS40LjUtZnVsbC1ub2NvbXBhdC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTUwODEyDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDAzOjExOjI5IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwMzoxMToyNyBHTVQNCg0KLyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzc2YmY0NzA2MmQ2YzE5ODNkNjZjZTQ3YWQ2NmFhMGUwCgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EZWxlZ2F0aW9uIENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi4uLgoqLwoKLyoKLS0tCgpuYW1lOiBDb3JlCgpkZXNjcmlwdGlvbjogVGhlIGhlYXJ0IG9mIE1vb1Rvb2xzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjb3B5cmlnaHQ6IENvcHlyaWdodCAoYykgMjAwNi0yMDEyIFtWYWxlcmlvIFByb2lldHRpXShodHRwOi8vbWFkNG1pbGsubmV0LykuCgphdXRob3JzOiBUaGUgTW9vVG9vbHMgcHJvZHVjdGlvbiB0ZWFtIChodHRwOi8vbW9vdG9vbHMubmV0L2RldmVsb3BlcnMvKQoKaW5zcGlyYXRpb246CiAgLSBDbGFzcyBpbXBsZW1lbnRhdGlvbiBpbnNwaXJlZCBieSBbQmFzZS5qc10oaHR0cDovL2RlYW4uZWR3YXJkcy5uYW1lL3dlYmxvZy8yMDA2LzAzL2Jhc2UvKSBDb3B5cmlnaHQgKGMpIDIwMDYgRGVhbiBFZHdhcmRzLCBbR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbGdwbC1saWNlbnNlLnBocCkKICAtIFNvbWUgZnVuY3Rpb25hbGl0eSBpbnNwaXJlZCBieSBbUHJvdG90eXBlLmpzXShodHRwOi8vcHJvdG90eXBlanMub3JnKSBDb3B5cmlnaHQgKGMpIDIwMDUtMjAwNyBTYW0gU3RlcGhlbnNvbiwgW01JVCBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoKcHJvdmlkZXM6IFtDb3JlLCBNb29Ub29scywgVHlwZSwgdHlwZU9mLCBpbnN0YW5jZU9mLCBOYXRpdmVdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5Nb29Ub29scyA9IHsKCXZlcnNpb246ICcxLjQuNScsCglidWlsZDogJzc0ZTM0Nzk2ZjVmNzY2NDBjZGI5ODg1MzAwNDY1MGFlYTE0OTlkNjknCn07CgovLyB0eXBlT2YsIGluc3RhbmNlT2YKCnZhciB0eXBlT2YgPSB0aGlzLnR5cGVPZiA9IGZ1bmN0aW9uKGl0ZW0pewoJaWYgKGl0ZW0gPT0gbnVsbCkgcmV0dXJuICdudWxsJzsKCWlmIChpdGVtLiRmYW1pbHkgIT0gbnVsbCkgcmV0dXJuIGl0ZW0uJGZhbWlseSgpOwoKCWlmIChpdGVtLm5vZGVOYW1lKXsKCQlpZiAoaXRlbS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gJ2VsZW1lbnQnOwoJCWlmIChpdGVtLm5vZGVUeXBlID09IDMpIHJldHVybiAoL1xTLykudGVzdChpdGVtLm5vZGVWYWx1ZSkgPyAndGV4dG5vZGUnIDogJ3doaXRlc3BhY2UnOwoJfSBlbHNlIGlmICh0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicpewoJCWlmIChpdGVtLmNhbGxlZSkgcmV0dXJuICdhcmd1bWVudHMnOwoJCWlmICgnaXRlbScgaW4gaXRlbSkgcmV0dXJuICdjb2xsZWN0aW9uJzsKCX0KCglyZXR1cm4gdHlwZW9mIGl0ZW07Cn07Cgp2YXIgaW5zdGFuY2VPZiA9IHRoaXMuaW5zdGFuY2VPZiA9IGZ1bmN0aW9uKGl0ZW0sIG9iamVjdCl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gZmFsc2U7Cgl2YXIgY29uc3RydWN0b3IgPSBpdGVtLiRjb25zdHJ1Y3RvciB8fCBpdGVtLmNvbnN0cnVjdG9yOwoJd2hpbGUgKGNvbnN0cnVjdG9yKXsKCQlpZiAoY29uc3RydWN0b3IgPT09IG9iamVjdCkgcmV0dXJuIHRydWU7CgkJY29uc3RydWN0b3IgPSBjb25zdHJ1Y3Rvci5wYXJlbnQ7Cgl9CgkvKjxsdElFOD4qLwoJaWYgKCFpdGVtLmhhc093blByb3BlcnR5KSByZXR1cm4gZmFsc2U7CgkvKjwvbHRJRTg+Ki8KCXJldHVybiBpdGVtIGluc3RhbmNlb2Ygb2JqZWN0Owp9OwoKLy8gRnVuY3Rpb24gb3ZlcmxvYWRpbmcKCnZhciBGdW5jdGlvbiA9IHRoaXMuRnVuY3Rpb247Cgp2YXIgZW51bWVyYWJsZXMgPSB0cnVlOwpmb3IgKHZhciBpIGluIHt0b1N0cmluZzogMX0pIGVudW1lcmFibGVzID0gbnVsbDsKaWYgKGVudW1lcmFibGVzKSBlbnVtZXJhYmxlcyA9IFsnaGFzT3duUHJvcGVydHknLCAndmFsdWVPZicsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ2NvbnN0cnVjdG9yJ107CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRTZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewoJCWlmIChhID09IG51bGwpIHJldHVybiB0aGlzOwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpewoJCQlmb3IgKHZhciBrIGluIGEpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJaWYgKGVudW1lcmFibGVzKSBmb3IgKHZhciBpID0gZW51bWVyYWJsZXMubGVuZ3RoOyBpLS07KXsKCQkJCWsgPSBlbnVtZXJhYmxlc1tpXTsKCQkJCWlmIChhLmhhc093blByb3BlcnR5KGspKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCX0KCQl9IGVsc2UgewoJCQlzZWxmLmNhbGwodGhpcywgYSwgYik7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZEdldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSl7CgkJdmFyIGFyZ3MsIHJlc3VsdDsKCQlpZiAodHlwZW9mIGEgIT0gJ3N0cmluZycpIGFyZ3MgPSBhOwoJCWVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSBhcmdzID0gYXJndW1lbnRzOwoJCWVsc2UgaWYgKHVzZVBsdXJhbCkgYXJncyA9IFthXTsKCQlpZiAoYXJncyl7CgkJCXJlc3VsdCA9IHt9OwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHJlc3VsdFthcmdzW2ldXSA9IHNlbGYuY2FsbCh0aGlzLCBhcmdzW2ldKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSBzZWxmLmNhbGwodGhpcywgYSk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpc1trZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXMucHJvdG90eXBlW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKLy8gRnJvbQoKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKRnVuY3Rpb24uZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gJ2Z1bmN0aW9uJykgPyBpdGVtIDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gaXRlbTsKCX07Cn07CgpBcnJheS5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gW107CglyZXR1cm4gKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pICYmIHR5cGVvZiBpdGVtICE9ICdzdHJpbmcnKSA/ICh0eXBlT2YoaXRlbSkgPT0gJ2FycmF5JykgPyBpdGVtIDogc2xpY2UuY2FsbChpdGVtKSA6IFtpdGVtXTsKfTsKCk51bWJlci5mcm9tID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgbnVtYmVyID0gcGFyc2VGbG9hdChpdGVtKTsKCXJldHVybiBpc0Zpbml0ZShudW1iZXIpID8gbnVtYmVyIDogbnVsbDsKfTsKClN0cmluZy5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbSArICcnOwp9OwoKLy8gaGlkZSwgcHJvdGVjdAoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgloaWRlOiBmdW5jdGlvbigpewoJCXRoaXMuJGhpZGRlbiA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByb3RlY3Q6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kcHJvdGVjdGVkID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gVHlwZQoKdmFyIFR5cGUgPSB0aGlzLlR5cGUgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QpewoJaWYgKG5hbWUpewoJCXZhciBsb3dlciA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQl2YXIgdHlwZUNoZWNrID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiAodHlwZU9mKGl0ZW0pID09IGxvd2VyKTsKCQl9OwoKCQlUeXBlWydpcycgKyBuYW1lXSA9IHR5cGVDaGVjazsKCQlpZiAob2JqZWN0ICE9IG51bGwpewoJCQlvYmplY3QucHJvdG90eXBlLiRmYW1pbHkgPSAoZnVuY3Rpb24oKXsKCQkJCXJldHVybiBsb3dlcjsKCQkJfSkuaGlkZSgpOwoJCQkKCQl9Cgl9CgoJaWYgKG9iamVjdCA9PSBudWxsKSByZXR1cm4gbnVsbDsKCglvYmplY3QuZXh0ZW5kKHRoaXMpOwoJb2JqZWN0LiRjb25zdHJ1Y3RvciA9IFR5cGU7CglvYmplY3QucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG9iamVjdDsKCglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKClR5cGUuaXNFbnVtZXJhYmxlID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gKGl0ZW0gIT0gbnVsbCAmJiB0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicgJiYgdG9TdHJpbmcuY2FsbChpdGVtKSAhPSAnW29iamVjdCBGdW5jdGlvbl0nICk7Cn07Cgp2YXIgaG9va3MgPSB7fTsKCnZhciBob29rc09mID0gZnVuY3Rpb24ob2JqZWN0KXsKCXZhciB0eXBlID0gdHlwZU9mKG9iamVjdC5wcm90b3R5cGUpOwoJcmV0dXJuIGhvb2tzW3R5cGVdIHx8IChob29rc1t0eXBlXSA9IFtdKTsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuOwoKCXZhciBob29rcyA9IGhvb2tzT2YodGhpcyk7CgoJZm9yICh2YXIgaSA9IDA7IGkgPCBob29rcy5sZW5ndGg7IGkrKyl7CgkJdmFyIGhvb2sgPSBob29rc1tpXTsKCQlpZiAodHlwZU9mKGhvb2spID09ICd0eXBlJykgaW1wbGVtZW50LmNhbGwoaG9vaywgbmFtZSwgbWV0aG9kKTsKCQllbHNlIGhvb2suY2FsbCh0aGlzLCBuYW1lLCBtZXRob2QpOwoJfQoKCXZhciBwcmV2aW91cyA9IHRoaXMucHJvdG90eXBlW25hbWVdOwoJaWYgKHByZXZpb3VzID09IG51bGwgfHwgIXByZXZpb3VzLiRwcm90ZWN0ZWQpIHRoaXMucHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoKCWlmICh0aGlzW25hbWVdID09IG51bGwgJiYgdHlwZU9mKG1ldGhvZCkgPT0gJ2Z1bmN0aW9uJykgZXh0ZW5kLmNhbGwodGhpcywgbmFtZSwgZnVuY3Rpb24oaXRlbSl7CgkJcmV0dXJuIG1ldGhvZC5hcHBseShpdGVtLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJfSk7Cn07Cgp2YXIgZXh0ZW5kID0gZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWlmIChtZXRob2QgJiYgbWV0aG9kLiRoaWRkZW4pIHJldHVybjsKCXZhciBwcmV2aW91cyA9IHRoaXNbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpc1tuYW1lXSA9IG1ldGhvZDsKfTsKClR5cGUuaW1wbGVtZW50KHsKCglpbXBsZW1lbnQ6IGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpLAoKCWV4dGVuZDogZXh0ZW5kLm92ZXJsb2FkU2V0dGVyKCksCgoJYWxpYXM6IGZ1bmN0aW9uKG5hbWUsIGV4aXN0aW5nKXsKCQlpbXBsZW1lbnQuY2FsbCh0aGlzLCBuYW1lLCB0aGlzLnByb3RvdHlwZVtleGlzdGluZ10pOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCW1pcnJvcjogZnVuY3Rpb24oaG9vayl7CgkJaG9va3NPZih0aGlzKS5wdXNoKGhvb2spOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpuZXcgVHlwZSgnVHlwZScsIFR5cGUpOwoKLy8gRGVmYXVsdCBUeXBlcwoKdmFyIGZvcmNlID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0LCBtZXRob2RzKXsKCXZhciBpc1R5cGUgPSAob2JqZWN0ICE9IE9iamVjdCksCgkJcHJvdG90eXBlID0gb2JqZWN0LnByb3RvdHlwZTsKCglpZiAoaXNUeXBlKSBvYmplY3QgPSBuZXcgVHlwZShuYW1lLCBvYmplY3QpOwoKCWZvciAodmFyIGkgPSAwLCBsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCXZhciBrZXkgPSBtZXRob2RzW2ldLAoJCQlnZW5lcmljID0gb2JqZWN0W2tleV0sCgkJCXByb3RvID0gcHJvdG90eXBlW2tleV07CgoJCWlmIChnZW5lcmljKSBnZW5lcmljLnByb3RlY3QoKTsKCQlpZiAoaXNUeXBlICYmIHByb3RvKSBvYmplY3QuaW1wbGVtZW50KGtleSwgcHJvdG8ucHJvdGVjdCgpKTsKCX0KCglpZiAoaXNUeXBlKXsKCQl2YXIgbWV0aG9kc0VudW1lcmFibGUgPSBwcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGUobWV0aG9kc1swXSk7CgkJb2JqZWN0LmZvckVhY2hNZXRob2QgPSBmdW5jdGlvbihmbil7CgkJCWlmICghbWV0aG9kc0VudW1lcmFibGUpIGZvciAodmFyIGkgPSAwLCBsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQkJZm4uY2FsbChwcm90b3R5cGUsIHByb3RvdHlwZVttZXRob2RzW2ldXSwgbWV0aG9kc1tpXSk7CgkJCX0KCQkJZm9yICh2YXIga2V5IGluIHByb3RvdHlwZSkgZm4uY2FsbChwcm90b3R5cGUsIHByb3RvdHlwZVtrZXldLCBrZXkpCgkJfTsKCX0KCglyZXR1cm4gZm9yY2U7Cn07Cgpmb3JjZSgnU3RyaW5nJywgU3RyaW5nLCBbCgknY2hhckF0JywgJ2NoYXJDb2RlQXQnLCAnY29uY2F0JywgJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAnbWF0Y2gnLCAncXVvdGUnLCAncmVwbGFjZScsICdzZWFyY2gnLAoJJ3NsaWNlJywgJ3NwbGl0JywgJ3N1YnN0cicsICdzdWJzdHJpbmcnLCAndHJpbScsICd0b0xvd2VyQ2FzZScsICd0b1VwcGVyQ2FzZScKXSkoJ0FycmF5JywgQXJyYXksIFsKCSdwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnLCAnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnLAoJJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAnZmlsdGVyJywgJ2ZvckVhY2gnLCAnZXZlcnknLCAnbWFwJywgJ3NvbWUnLCAncmVkdWNlJywgJ3JlZHVjZVJpZ2h0JwpdKSgnTnVtYmVyJywgTnVtYmVyLCBbCgkndG9FeHBvbmVudGlhbCcsICd0b0ZpeGVkJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvUHJlY2lzaW9uJwpdKSgnRnVuY3Rpb24nLCBGdW5jdGlvbiwgWwoJJ2FwcGx5JywgJ2NhbGwnLCAnYmluZCcKXSkoJ1JlZ0V4cCcsIFJlZ0V4cCwgWwoJJ2V4ZWMnLCAndGVzdCcKXSkoJ09iamVjdCcsIE9iamVjdCwgWwoJJ2NyZWF0ZScsICdkZWZpbmVQcm9wZXJ0eScsICdkZWZpbmVQcm9wZXJ0aWVzJywgJ2tleXMnLAoJJ2dldFByb3RvdHlwZU9mJywgJ2dldE93blByb3BlcnR5RGVzY3JpcHRvcicsICdnZXRPd25Qcm9wZXJ0eU5hbWVzJywKCSdwcmV2ZW50RXh0ZW5zaW9ucycsICdpc0V4dGVuc2libGUnLCAnc2VhbCcsICdpc1NlYWxlZCcsICdmcmVlemUnLCAnaXNGcm96ZW4nCl0pKCdEYXRlJywgRGF0ZSwgWydub3cnXSk7CgpPYmplY3QuZXh0ZW5kID0gZXh0ZW5kLm92ZXJsb2FkU2V0dGVyKCk7CgpEYXRlLmV4dGVuZCgnbm93JywgZnVuY3Rpb24oKXsKCXJldHVybiArKG5ldyBEYXRlKTsKfSk7CgpuZXcgVHlwZSgnQm9vbGVhbicsIEJvb2xlYW4pOwoKLy8gZml4ZXMgTmFOIHJldHVybmluZyBhcyBOdW1iZXIKCk51bWJlci5wcm90b3R5cGUuJGZhbWlseSA9IGZ1bmN0aW9uKCl7CglyZXR1cm4gaXNGaW5pdGUodGhpcykgPyAnbnVtYmVyJyA6ICdudWxsJzsKfS5oaWRlKCk7CgovLyBOdW1iZXIucmFuZG9tCgpOdW1iZXIuZXh0ZW5kKCdyYW5kb20nLCBmdW5jdGlvbihtaW4sIG1heCl7CglyZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpICsgbWluKTsKfSk7CgovLyBmb3JFYWNoLCBlYWNoCgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwpPYmplY3QuZXh0ZW5kKCdmb3JFYWNoJywgZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7Cglmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCX0KfSk7CgpPYmplY3QuZWFjaCA9IE9iamVjdC5mb3JFYWNoOwoKQXJyYXkuaW1wbGVtZW50KHsKCglmb3JFYWNoOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmIChpIGluIHRoaXMpIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcyk7CgkJfQoJfSwKCgllYWNoOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJQXJyYXkuZm9yRWFjaCh0aGlzLCBmbiwgYmluZCk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8vIEFycmF5ICYgT2JqZWN0IGNsb25pbmcsIE9iamVjdCBtZXJnaW5nIGFuZCBhcHBlbmRpbmcKCnZhciBjbG9uZU9mID0gZnVuY3Rpb24oaXRlbSl7Cglzd2l0Y2ggKHR5cGVPZihpdGVtKSl7CgkJY2FzZSAnYXJyYXknOiByZXR1cm4gaXRlbS5jbG9uZSgpOwoJCWNhc2UgJ29iamVjdCc6IHJldHVybiBPYmplY3QuY2xvbmUoaXRlbSk7CgkJZGVmYXVsdDogcmV0dXJuIGl0ZW07Cgl9Cn07CgpBcnJheS5pbXBsZW1lbnQoJ2Nsb25lJywgZnVuY3Rpb24oKXsKCXZhciBpID0gdGhpcy5sZW5ndGgsIGNsb25lID0gbmV3IEFycmF5KGkpOwoJd2hpbGUgKGktLSkgY2xvbmVbaV0gPSBjbG9uZU9mKHRoaXNbaV0pOwoJcmV0dXJuIGNsb25lOwp9KTsKCnZhciBtZXJnZU9uZSA9IGZ1bmN0aW9uKHNvdXJjZSwga2V5LCBjdXJyZW50KXsKCXN3aXRjaCAodHlwZU9mKGN1cnJlbnQpKXsKCQljYXNlICdvYmplY3QnOgoJCQlpZiAodHlwZU9mKHNvdXJjZVtrZXldKSA9PSAnb2JqZWN0JykgT2JqZWN0Lm1lcmdlKHNvdXJjZVtrZXldLCBjdXJyZW50KTsKCQkJZWxzZSBzb3VyY2Vba2V5XSA9IE9iamVjdC5jbG9uZShjdXJyZW50KTsKCQlicmVhazsKCQljYXNlICdhcnJheSc6IHNvdXJjZVtrZXldID0gY3VycmVudC5jbG9uZSgpOyBicmVhazsKCQlkZWZhdWx0OiBzb3VyY2Vba2V5XSA9IGN1cnJlbnQ7Cgl9CglyZXR1cm4gc291cmNlOwp9OwoKT2JqZWN0LmV4dGVuZCh7CgoJbWVyZ2U6IGZ1bmN0aW9uKHNvdXJjZSwgaywgdil7CgkJaWYgKHR5cGVPZihrKSA9PSAnc3RyaW5nJykgcmV0dXJuIG1lcmdlT25lKHNvdXJjZSwgaywgdik7CgkJZm9yICh2YXIgaSA9IDEsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIG9iamVjdCA9IGFyZ3VtZW50c1tpXTsKCQkJZm9yICh2YXIga2V5IGluIG9iamVjdCkgbWVyZ2VPbmUoc291cmNlLCBrZXksIG9iamVjdFtrZXldKTsKCQl9CgkJcmV0dXJuIHNvdXJjZTsKCX0sCgoJY2xvbmU6IGZ1bmN0aW9uKG9iamVjdCl7CgkJdmFyIGNsb25lID0ge307CgkJZm9yICh2YXIga2V5IGluIG9iamVjdCkgY2xvbmVba2V5XSA9IGNsb25lT2Yob2JqZWN0W2tleV0pOwoJCXJldHVybiBjbG9uZTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbihvcmlnaW5hbCl7CgkJZm9yICh2YXIgaSA9IDEsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGV4dGVuZGVkID0gYXJndW1lbnRzW2ldIHx8IHt9OwoJCQlmb3IgKHZhciBrZXkgaW4gZXh0ZW5kZWQpIG9yaWdpbmFsW2tleV0gPSBleHRlbmRlZFtrZXldOwoJCX0KCQlyZXR1cm4gb3JpZ2luYWw7Cgl9Cgp9KTsKCi8vIE9iamVjdC1sZXNzIHR5cGVzCgpbJ09iamVjdCcsICdXaGl0ZVNwYWNlJywgJ1RleHROb2RlJywgJ0NvbGxlY3Rpb24nLCAnQXJndW1lbnRzJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCW5ldyBUeXBlKG5hbWUpOwp9KTsKCi8vIFVuaXF1ZSBJRAoKdmFyIFVJRCA9IERhdGUubm93KCk7CgpTdHJpbmcuZXh0ZW5kKCd1bmlxdWVJRCcsIGZ1bmN0aW9uKCl7CglyZXR1cm4gKFVJRCsrKS50b1N0cmluZygzNik7Cn0pOwoKCgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQXJyYXkKCmRlc2NyaXB0aW9uOiBDb250YWlucyBBcnJheSBQcm90b3R5cGVzIGxpa2UgZWFjaCwgY29udGFpbnMsIGFuZCBlcmFzZS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBBcnJheQoKLi4uCiovCgpBcnJheS5pbXBsZW1lbnQoewoKCS8qPCFFUzU+Ki8KCWV2ZXJ5OiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCA+Pj4gMDsgaSA8IGw7IGkrKyl7CgkJCWlmICgoaSBpbiB0aGlzKSAmJiAhZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJZmlsdGVyOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSBbXTsKCQlmb3IgKHZhciB2YWx1ZSwgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCA+Pj4gMDsgaSA8IGw7IGkrKykgaWYgKGkgaW4gdGhpcyl7CgkJCXZhbHVlID0gdGhpc1tpXTsKCQkJaWYgKGZuLmNhbGwoYmluZCwgdmFsdWUsIGksIHRoaXMpKSByZXN1bHRzLnB1c2godmFsdWUpOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJaW5kZXhPZjogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoID4+PiAwOwoJCWZvciAodmFyIGkgPSAoZnJvbSA8IDApID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgZnJvbSkgOiBmcm9tIHx8IDA7IGkgPCBsZW5ndGg7IGkrKyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsKCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggPj4+IDAsIHJlc3VsdHMgPSBBcnJheShsZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSByZXN1bHRzW2ldID0gZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoID4+PiAwOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoJLyo8LyFFUzU+Ki8KCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtICE9IG51bGw7CgkJfSk7Cgl9LAoKCWludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSl7CgkJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW1bbWV0aG9kTmFtZV0uYXBwbHkoaXRlbSwgYXJncyk7CgkJfSk7Cgl9LAoKCWFzc29jaWF0ZTogZnVuY3Rpb24oa2V5cyl7CgkJdmFyIG9iaiA9IHt9LCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmxlbmd0aCwga2V5cy5sZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIG9ialtrZXlzW2ldXSA9IHRoaXNbaV07CgkJcmV0dXJuIG9iajsKCX0sCgoJbGluazogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgcmVzdWx0ID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQkJaWYgKG9iamVjdFtrZXldKHRoaXNbaV0pKXsKCQkJCQlyZXN1bHRba2V5XSA9IHRoaXNbaV07CgkJCQkJZGVsZXRlIG9iamVjdFtrZXldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGFycmF5KXsKCQl0aGlzLnB1c2guYXBwbHkodGhpcywgYXJyYXkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1t0aGlzLmxlbmd0aCAtIDFdIDogbnVsbDsKCX0sCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1tOdW1iZXIucmFuZG9tKDAsIHRoaXMubGVuZ3RoIC0gMSldIDogbnVsbDsKCX0sCgoJaW5jbHVkZTogZnVuY3Rpb24oaXRlbSl7CgkJaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW0pKSB0aGlzLnB1c2goaXRlbSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGl0ZW0pewoJCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSB0aGlzLnNwbGljZShpLCAxKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmxhdHRlbjogZnVuY3Rpb24oKXsKCQl2YXIgYXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIHR5cGUgPSB0eXBlT2YodGhpc1tpXSk7CgkJCWlmICh0eXBlID09ICdudWxsJykgY29udGludWU7CgkJCWFycmF5ID0gYXJyYXkuY29uY2F0KCh0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnY29sbGVjdGlvbicgfHwgdHlwZSA9PSAnYXJndW1lbnRzJyB8fCBpbnN0YW5jZU9mKHRoaXNbaV0sIEFycmF5KSkgPyBBcnJheS5mbGF0dGVuKHRoaXNbaV0pIDogdGhpc1tpXSk7CgkJfQoJCXJldHVybiBhcnJheTsKCX0sCgoJcGljazogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gIT0gbnVsbCkgcmV0dXJuIHRoaXNbaV07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gbnVsbDsKCQl2YXIgcmdiID0gdGhpcy5tYXAoZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubGVuZ3RoID09IDEpIHZhbHVlICs9IHZhbHVlOwoJCQlyZXR1cm4gdmFsdWUudG9JbnQoMTYpOwoJCX0pOwoJCXJldHVybiAoYXJyYXkpID8gcmdiIDogJ3JnYignICsgcmdiICsgJyknOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gKGFycmF5KSA/IGhleCA6ICcjJyArIGhleC5qb2luKCcnKTsKCX0KCn0pOwoKCgoKLyoKLS0tCgpuYW1lOiBTdHJpbmcKCmRlc2NyaXB0aW9uOiBDb250YWlucyBTdHJpbmcgUHJvdG90eXBlcyBsaWtlIGNhbWVsQ2FzZSwgY2FwaXRhbGl6ZSwgdGVzdCwgYW5kIHRvSW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFN0cmluZwoKLi4uCiovCgpTdHJpbmcuaW1wbGVtZW50KHsKCgl0ZXN0OiBmdW5jdGlvbihyZWdleCwgcGFyYW1zKXsKCQlyZXR1cm4gKCh0eXBlT2YocmVnZXgpID09ICdyZWdleHAnKSA/IHJlZ2V4IDogbmV3IFJlZ0V4cCgnJyArIHJlZ2V4LCBwYXJhbXMpKS50ZXN0KHRoaXMpOwoJfSwKCgljb250YWluczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpewoJCXJldHVybiAoc2VwYXJhdG9yKSA/IChzZXBhcmF0b3IgKyB0aGlzICsgc2VwYXJhdG9yKS5pbmRleE9mKHNlcGFyYXRvciArIHN0cmluZyArIHNlcGFyYXRvcikgPiAtMSA6IFN0cmluZyh0aGlzKS5pbmRleE9mKHN0cmluZykgPiAtMTsKCX0sCgoJdHJpbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbigpewoJCXJldHVybiBTdHJpbmcodGhpcykucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwoJfSwKCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC8tXEQvZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWh5cGhlbmF0ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuICgnLScgKyBtYXRjaC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSk7CgkJfSk7Cgl9LAoKCWNhcGl0YWxpemU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC9cYlthLXpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWVzY2FwZVJlZ0V4cDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoLyhbLS4qKz9eJHt9KCl8W1xdXC9cXF0pL2csICdcXCQxJyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCWhleFRvUmdiOiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIGhleCA9IFN0cmluZyh0aGlzKS5tYXRjaCgvXiM/KFx3ezEsMn0pKFx3ezEsMn0pKFx3ezEsMn0pJC8pOwoJCXJldHVybiAoaGV4KSA/IGhleC5zbGljZSgxKS5oZXhUb1JnYihhcnJheSkgOiBudWxsOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCXZhciByZ2IgPSBTdHJpbmcodGhpcykubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IG51bGw7Cgl9LAoKCXN1YnN0aXR1dGU6IGZ1bmN0aW9uKG9iamVjdCwgcmVnZXhwKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UocmVnZXhwIHx8ICgvXFw/XHsoW157fV0rKVx9L2cpLCBmdW5jdGlvbihtYXRjaCwgbmFtZSl7CgkJCWlmIChtYXRjaC5jaGFyQXQoMCkgPT0gJ1xcJykgcmV0dXJuIG1hdGNoLnNsaWNlKDEpOwoJCQlyZXR1cm4gKG9iamVjdFtuYW1lXSAhPSBudWxsKSA/IG9iamVjdFtuYW1lXSA6ICcnOwoJCX0pOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBOdW1iZXIKCmRlc2NyaXB0aW9uOiBDb250YWlucyBOdW1iZXIgUHJvdG90eXBlcyBsaWtlIGxpbWl0LCByb3VuZCwgdGltZXMsIGFuZCBjZWlsLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IE51bWJlcgoKLi4uCiovCgpOdW1iZXIuaW1wbGVtZW50KHsKCglsaW1pdDogZnVuY3Rpb24obWluLCBtYXgpewoJCXJldHVybiBNYXRoLm1pbihtYXgsIE1hdGgubWF4KG1pbiwgdGhpcykpOwoJfSwKCglyb3VuZDogZnVuY3Rpb24ocHJlY2lzaW9uKXsKCQlwcmVjaXNpb24gPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uIHx8IDApLnRvRml4ZWQocHJlY2lzaW9uIDwgMCA/IC1wcmVjaXNpb24gOiAwKTsKCQlyZXR1cm4gTWF0aC5yb3VuZCh0aGlzICogcHJlY2lzaW9uKSAvIHByZWNpc2lvbjsKCX0sCgoJdGltZXM6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXM7IGkrKykgZm4uY2FsbChiaW5kLCBpLCB0aGlzKTsKCX0sCgoJdG9GbG9hdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh0aGlzKTsKCX0sCgoJdG9JbnQ6IGZ1bmN0aW9uKGJhc2UpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCBiYXNlIHx8IDEwKTsKCX0KCn0pOwoKTnVtYmVyLmFsaWFzKCdlYWNoJywgJ3RpbWVzJyk7CgooZnVuY3Rpb24obWF0aCl7Cgl2YXIgbWV0aG9kcyA9IHt9OwoJbWF0aC5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJCWlmICghTnVtYmVyW25hbWVdKSBtZXRob2RzW25hbWVdID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIE1hdGhbbmFtZV0uYXBwbHkobnVsbCwgW3RoaXNdLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQl9OwoJfSk7CglOdW1iZXIuaW1wbGVtZW50KG1ldGhvZHMpOwp9KShbJ2FicycsICdhY29zJywgJ2FzaW4nLCAnYXRhbicsICdhdGFuMicsICdjZWlsJywgJ2NvcycsICdleHAnLCAnZmxvb3InLCAnbG9nJywgJ21heCcsICdtaW4nLCAncG93JywgJ3NpbicsICdzcXJ0JywgJ3RhbiddKTsKCgovKgotLS0KCm5hbWU6IEZ1bmN0aW9uCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRnVuY3Rpb24gUHJvdG90eXBlcyBsaWtlIGNyZWF0ZSwgYmluZCwgcGFzcywgYW5kIGRlbGF5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEZ1bmN0aW9uCgouLi4KKi8KCkZ1bmN0aW9uLmV4dGVuZCh7CgoJYXR0ZW1wdDogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl0cnkgewoJCQkJcmV0dXJuIGFyZ3VtZW50c1tpXSgpOwoJCQl9IGNhdGNoIChlKXt9CgkJfQoJCXJldHVybiBudWxsOwoJfQoKfSk7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLmFwcGx5KGJpbmQsIEFycmF5LmZyb20oYXJncykpOwoJCX0gY2F0Y2ggKGUpe30KCgkJcmV0dXJuIG51bGw7Cgl9LAoKCS8qPCFFUzUtYmluZD4qLwoJYmluZDogZnVuY3Rpb24odGhhdCl7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbCwKCQkJRiA9IGZ1bmN0aW9uKCl7fTsKCgkJdmFyIGJvdW5kID0gZnVuY3Rpb24oKXsKCQkJdmFyIGNvbnRleHQgPSB0aGF0LCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwoJCQlpZiAodGhpcyBpbnN0YW5jZW9mIGJvdW5kKXsKCQkJCUYucHJvdG90eXBlID0gc2VsZi5wcm90b3R5cGU7CgkJCQljb250ZXh0ID0gbmV3IEY7CgkJCX0KCQkJdmFyIHJlc3VsdCA9ICghYXJncyAmJiAhbGVuZ3RoKQoJCQkJPyBzZWxmLmNhbGwoY29udGV4dCkKCQkJCTogc2VsZi5hcHBseShjb250ZXh0LCBhcmdzICYmIGxlbmd0aCA/IGFyZ3MuY29uY2F0KEFycmF5LnNsaWNlKGFyZ3VtZW50cykpIDogYXJncyB8fCBhcmd1bWVudHMpOwoJCQlyZXR1cm4gY29udGV4dCA9PSB0aGF0ID8gcmVzdWx0IDogY29udGV4dDsKCQl9OwoJCXJldHVybiBib3VuZDsKCX0sCgkvKjwvIUVTNS1iaW5kPiovCgoJcGFzczogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJZGVsYXk6IGZ1bmN0aW9uKGRlbGF5LCBiaW5kLCBhcmdzKXsKCQlyZXR1cm4gc2V0VGltZW91dCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBkZWxheSk7Cgl9LAoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKHBlcmlvZGljYWwsIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRJbnRlcnZhbCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBwZXJpb2RpY2FsKTsKCX0KCn0pOwoKCgoKLyoKLS0tCgpuYW1lOiBPYmplY3QKCmRlc2NyaXB0aW9uOiBPYmplY3QgZ2VuZXJpYyBtZXRob2RzCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogW09iamVjdCwgSGFzaF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKT2JqZWN0LmV4dGVuZCh7CgoJc3Vic2V0OiBmdW5jdGlvbihvYmplY3QsIGtleXMpewoJCXZhciByZXN1bHRzID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBrID0ga2V5c1tpXTsKCQkJaWYgKGsgaW4gb2JqZWN0KSByZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSAmJiBmbi5jYWxsKGJpbmQsIHZhbHVlLCBrZXksIG9iamVjdCkpIHJlc3VsdHNba2V5XSA9IHZhbHVlOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKfSkoKTsKCgoKCi8qCi0tLQoKbmFtZTogQnJvd3NlcgoKZGVzY3JpcHRpb246IFRoZSBCcm93c2VyIE9iamVjdC4gQ29udGFpbnMgQnJvd3NlciBpbml0aWFsaXphdGlvbiwgV2luZG93IGFuZCBEb2N1bWVudCwgYW5kIHRoZSBCcm93c2VyIEhhc2guCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIEZ1bmN0aW9uLCBOdW1iZXIsIFN0cmluZ10KCnByb3ZpZGVzOiBbQnJvd3NlciwgV2luZG93LCBEb2N1bWVudF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50Owp2YXIgd2luZG93ID0gZG9jdW1lbnQud2luZG93ID0gdGhpczsKCnZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSwKCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLnRvTG93ZXJDYXNlKCksCglVQSA9IHVhLm1hdGNoKC8ob3BlcmF8aWV8ZmlyZWZveHxjaHJvbWV8dmVyc2lvbilbXHNcLzpdKFtcd1xkXC5dKyk/Lio/KHNhZmFyaXx2ZXJzaW9uW1xzXC86XShbXHdcZFwuXSspfCQpLykgfHwgW251bGwsICd1bmtub3duJywgMF0sCgltb2RlID0gVUFbMV0gPT0gJ2llJyAmJiBkb2N1bWVudC5kb2N1bWVudE1vZGU7Cgp2YXIgQnJvd3NlciA9IHRoaXMuQnJvd3NlciA9IHsKCglleHRlbmQ6IEZ1bmN0aW9uLnByb3RvdHlwZS5leHRlbmQsCgoJbmFtZTogKFVBWzFdID09ICd2ZXJzaW9uJykgPyBVQVszXSA6IFVBWzFdLAoKCXZlcnNpb246IG1vZGUgfHwgcGFyc2VGbG9hdCgoVUFbMV0gPT0gJ29wZXJhJyAmJiBVQVs0XSkgPyBVQVs0XSA6IFVBWzJdKSwKCglQbGF0Zm9ybTogewoJCW5hbWU6IHVhLm1hdGNoKC9pcCg/OmFkfG9kfGhvbmUpLykgPyAnaW9zJyA6ICh1YS5tYXRjaCgvKD86d2Vib3N8YW5kcm9pZCkvKSB8fCBwbGF0Zm9ybS5tYXRjaCgvbWFjfHdpbnxsaW51eC8pIHx8IFsnb3RoZXInXSlbMF0KCX0sCgoJRmVhdHVyZXM6IHsKCQl4cGF0aDogISEoZG9jdW1lbnQuZXZhbHVhdGUpLAoJCWFpcjogISEod2luZG93LnJ1bnRpbWUpLAoJCXF1ZXJ5OiAhIShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKSwKCQlqc29uOiAhISh3aW5kb3cuSlNPTikKCX0sCgoJUGx1Z2luczoge30KCn07CgpCcm93c2VyW0Jyb3dzZXIubmFtZV0gPSB0cnVlOwpCcm93c2VyW0Jyb3dzZXIubmFtZSArIHBhcnNlSW50KEJyb3dzZXIudmVyc2lvbiwgMTApXSA9IHRydWU7CkJyb3dzZXIuUGxhdGZvcm1bQnJvd3Nlci5QbGF0Zm9ybS5uYW1lXSA9IHRydWU7CgovLyBSZXF1ZXN0CgpCcm93c2VyLlJlcXVlc3QgPSAoZnVuY3Rpb24oKXsKCgl2YXIgWE1MSFRUUCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJfTsKCgl2YXIgTVNYTUwyID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01TWE1MMi5YTUxIVFRQJyk7Cgl9OwoKCXZhciBNU1hNTCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwoJfTsKCglyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCVhNTEhUVFAoKTsKCQlyZXR1cm4gWE1MSFRUUDsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwyKCk7CgkJcmV0dXJuIE1TWE1MMjsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwoKTsKCQlyZXR1cm4gTVNYTUw7Cgl9KTsKCn0pKCk7CgpCcm93c2VyLkZlYXR1cmVzLnhociA9ICEhKEJyb3dzZXIuUmVxdWVzdCk7CgovLyBGbGFzaCBkZXRlY3Rpb24KCnZhciB2ZXJzaW9uID0gKEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCXJldHVybiBuYXZpZ2F0b3IucGx1Z2luc1snU2hvY2t3YXZlIEZsYXNoJ10uZGVzY3JpcHRpb247Cn0sIGZ1bmN0aW9uKCl7CglyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ1Nob2Nrd2F2ZUZsYXNoLlNob2Nrd2F2ZUZsYXNoJykuR2V0VmFyaWFibGUoJyR2ZXJzaW9uJyk7Cn0pIHx8ICcwIHIwJykubWF0Y2goL1xkKy9nKTsKCkJyb3dzZXIuUGx1Z2lucy5GbGFzaCA9IHsKCXZlcnNpb246IE51bWJlcih2ZXJzaW9uWzBdIHx8ICcwLicgKyB2ZXJzaW9uWzFdKSB8fCAwLAoJYnVpbGQ6IE51bWJlcih2ZXJzaW9uWzJdKSB8fCAwCn07CgovLyBTdHJpbmcgc2NyaXB0cwoKQnJvd3Nlci5leGVjID0gZnVuY3Rpb24odGV4dCl7CglpZiAoIXRleHQpIHJldHVybiB0ZXh0OwoJaWYgKHdpbmRvdy5leGVjU2NyaXB0KXsKCQl3aW5kb3cuZXhlY1NjcmlwdCh0ZXh0KTsKCX0gZWxzZSB7CgkJdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCXNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7CgkJc2NyaXB0LnRleHQgPSB0ZXh0OwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQlkb2N1bWVudC5oZWFkLnJlbW92ZUNoaWxkKHNjcmlwdCk7Cgl9CglyZXR1cm4gdGV4dDsKfTsKClN0cmluZy5pbXBsZW1lbnQoJ3N0cmlwU2NyaXB0cycsIGZ1bmN0aW9uKGV4ZWMpewoJdmFyIHNjcmlwdHMgPSAnJzsKCXZhciB0ZXh0ID0gdGhpcy5yZXBsYWNlKC88c2NyaXB0W14+XSo+KFtcc1xTXSo/KTxcL3NjcmlwdD4vZ2ksIGZ1bmN0aW9uKGFsbCwgY29kZSl7CgkJc2NyaXB0cyArPSBjb2RlICsgJ1xuJzsKCQlyZXR1cm4gJyc7Cgl9KTsKCWlmIChleGVjID09PSB0cnVlKSBCcm93c2VyLmV4ZWMoc2NyaXB0cyk7CgllbHNlIGlmICh0eXBlT2YoZXhlYykgPT0gJ2Z1bmN0aW9uJykgZXhlYyhzY3JpcHRzLCB0ZXh0KTsKCXJldHVybiB0ZXh0Owp9KTsKCi8vIFdpbmRvdywgRG9jdW1lbnQKCkJyb3dzZXIuZXh0ZW5kKHsKCURvY3VtZW50OiB0aGlzLkRvY3VtZW50LAoJV2luZG93OiB0aGlzLldpbmRvdywKCUVsZW1lbnQ6IHRoaXMuRWxlbWVudCwKCUV2ZW50OiB0aGlzLkV2ZW50Cn0pOwoKdGhpcy5XaW5kb3cgPSB0aGlzLiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdXaW5kb3cnLCBmdW5jdGlvbigpe30pOwoKdGhpcy4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnd2luZG93JykuaGlkZSgpOwoKV2luZG93Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJd2luZG93W25hbWVdID0gbWV0aG9kOwp9KTsKCnRoaXMuRG9jdW1lbnQgPSBkb2N1bWVudC4kY29uc3RydWN0b3IgPSBuZXcgVHlwZSgnRG9jdW1lbnQnLCBmdW5jdGlvbigpe30pOwoKZG9jdW1lbnQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2RvY3VtZW50JykuaGlkZSgpOwoKRG9jdW1lbnQubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cglkb2N1bWVudFtuYW1lXSA9IG1ldGhvZDsKfSk7Cgpkb2N1bWVudC5odG1sID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwppZiAoIWRvY3VtZW50LmhlYWQpIGRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgovKjxsdElFOT4qLwppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KLyo8L2x0SUU5PiovCgoKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFdmVudAoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBFdmVudCBUeXBlLCB0byBtYWtlIHRoZSBldmVudCBvYmplY3QgY3Jvc3MtYnJvd3Nlci4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtXaW5kb3csIERvY3VtZW50LCBBcnJheSwgRnVuY3Rpb24sIFN0cmluZywgT2JqZWN0XQoKcHJvdmlkZXM6IEV2ZW50CgouLi4KKi8KCihmdW5jdGlvbigpIHsKCnZhciBfa2V5cyA9IHt9OwoKdmFyIERPTUV2ZW50ID0gdGhpcy5ET01FdmVudCA9IG5ldyBUeXBlKCdET01FdmVudCcsIGZ1bmN0aW9uKGV2ZW50LCB3aW4pewoJaWYgKCF3aW4pIHdpbiA9IHdpbmRvdzsKCWV2ZW50ID0gZXZlbnQgfHwgd2luLmV2ZW50OwoJaWYgKGV2ZW50LiRleHRlbmRlZCkgcmV0dXJuIGV2ZW50OwoJdGhpcy5ldmVudCA9IGV2ZW50OwoJdGhpcy4kZXh0ZW5kZWQgPSB0cnVlOwoJdGhpcy5zaGlmdCA9IGV2ZW50LnNoaWZ0S2V5OwoJdGhpcy5jb250cm9sID0gZXZlbnQuY3RybEtleTsKCXRoaXMuYWx0ID0gZXZlbnQuYWx0S2V5OwoJdGhpcy5tZXRhID0gZXZlbnQubWV0YUtleTsKCXZhciB0eXBlID0gdGhpcy50eXBlID0gZXZlbnQudHlwZTsKCXZhciB0YXJnZXQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudDsKCXdoaWxlICh0YXJnZXQgJiYgdGFyZ2V0Lm5vZGVUeXBlID09IDMpIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJdGhpcy50YXJnZXQgPSBkb2N1bWVudC5pZCh0YXJnZXQpOwoKCWlmICh0eXBlLmluZGV4T2YoJ2tleScpID09IDApewoJCXZhciBjb2RlID0gdGhpcy5jb2RlID0gKGV2ZW50LndoaWNoIHx8IGV2ZW50LmtleUNvZGUpOwoJCXRoaXMua2V5ID0gX2tleXNbY29kZV07CgkJaWYgKHR5cGUgPT0gJ2tleWRvd24nKXsKCQkJaWYgKGNvZGUgPiAxMTEgJiYgY29kZSA8IDEyNCkgdGhpcy5rZXkgPSAnZicgKyAoY29kZSAtIDExMSk7CgkJCWVsc2UgaWYgKGNvZGUgPiA5NSAmJiBjb2RlIDwgMTA2KSB0aGlzLmtleSA9IGNvZGUgLSA5NjsKCQl9CgkJaWYgKHRoaXMua2V5ID09IG51bGwpIHRoaXMua2V5ID0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlKS50b0xvd2VyQ2FzZSgpOwoJfSBlbHNlIGlmICh0eXBlID09ICdjbGljaycgfHwgdHlwZSA9PSAnZGJsY2xpY2snIHx8IHR5cGUgPT0gJ2NvbnRleHRtZW51JyB8fCB0eXBlID09ICdET01Nb3VzZVNjcm9sbCcgfHwgdHlwZS5pbmRleE9mKCdtb3VzZScpID09IDApewoJCXZhciBkb2MgPSB3aW4uZG9jdW1lbnQ7CgkJZG9jID0gKCFkb2MuY29tcGF0TW9kZSB8fCBkb2MuY29tcGF0TW9kZSA9PSAnQ1NTMUNvbXBhdCcpID8gZG9jLmh0bWwgOiBkb2MuYm9keTsKCQl0aGlzLnBhZ2UgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIDogZXZlbnQuY2xpZW50WCArIGRvYy5zY3JvbGxMZWZ0LAoJCQl5OiAoZXZlbnQucGFnZVkgIT0gbnVsbCkgPyBldmVudC5wYWdlWSA6IGV2ZW50LmNsaWVudFkgKyBkb2Muc2Nyb2xsVG9wCgkJfTsKCQl0aGlzLmNsaWVudCA9IHsKCQkJeDogKGV2ZW50LnBhZ2VYICE9IG51bGwpID8gZXZlbnQucGFnZVggLSB3aW4ucGFnZVhPZmZzZXQgOiBldmVudC5jbGllbnRYLAoJCQl5OiAoZXZlbnQucGFnZVkgIT0gbnVsbCkgPyBldmVudC5wYWdlWSAtIHdpbi5wYWdlWU9mZnNldCA6IGV2ZW50LmNsaWVudFkKCQl9OwoJCWlmICh0eXBlID09ICdET01Nb3VzZVNjcm9sbCcgfHwgdHlwZSA9PSAnbW91c2V3aGVlbCcpCgkJCXRoaXMud2hlZWwgPSAoZXZlbnQud2hlZWxEZWx0YSkgPyBldmVudC53aGVlbERlbHRhIC8gMTIwIDogLShldmVudC5kZXRhaWwgfHwgMCkgLyAzOwoKCQl0aGlzLnJpZ2h0Q2xpY2sgPSAoZXZlbnQud2hpY2ggPT0gMyB8fCBldmVudC5idXR0b24gPT0gMik7CgkJaWYgKHR5cGUgPT0gJ21vdXNlb3ZlcicgfHwgdHlwZSA9PSAnbW91c2VvdXQnKXsKCQkJdmFyIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0IHx8IGV2ZW50Wyh0eXBlID09ICdtb3VzZW92ZXInID8gJ2Zyb20nIDogJ3RvJykgKyAnRWxlbWVudCddOwoJCQl3aGlsZSAocmVsYXRlZCAmJiByZWxhdGVkLm5vZGVUeXBlID09IDMpIHJlbGF0ZWQgPSByZWxhdGVkLnBhcmVudE5vZGU7CgkJCXRoaXMucmVsYXRlZFRhcmdldCA9IGRvY3VtZW50LmlkKHJlbGF0ZWQpOwoJCX0KCX0gZWxzZSBpZiAodHlwZS5pbmRleE9mKCd0b3VjaCcpID09IDAgfHwgdHlwZS5pbmRleE9mKCdnZXN0dXJlJykgPT0gMCl7CgkJdGhpcy5yb3RhdGlvbiA9IGV2ZW50LnJvdGF0aW9uOwoJCXRoaXMuc2NhbGUgPSBldmVudC5zY2FsZTsKCQl0aGlzLnRhcmdldFRvdWNoZXMgPSBldmVudC50YXJnZXRUb3VjaGVzOwoJCXRoaXMuY2hhbmdlZFRvdWNoZXMgPSBldmVudC5jaGFuZ2VkVG91Y2hlczsKCQl2YXIgdG91Y2hlcyA9IHRoaXMudG91Y2hlcyA9IGV2ZW50LnRvdWNoZXM7CgkJaWYgKHRvdWNoZXMgJiYgdG91Y2hlc1swXSl7CgkJCXZhciB0b3VjaCA9IHRvdWNoZXNbMF07CgkJCXRoaXMucGFnZSA9IHt4OiB0b3VjaC5wYWdlWCwgeTogdG91Y2gucGFnZVl9OwoJCQl0aGlzLmNsaWVudCA9IHt4OiB0b3VjaC5jbGllbnRYLCB5OiB0b3VjaC5jbGllbnRZfTsKCQl9Cgl9CgoJaWYgKCF0aGlzLmNsaWVudCkgdGhpcy5jbGllbnQgPSB7fTsKCWlmICghdGhpcy5wYWdlKSB0aGlzLnBhZ2UgPSB7fTsKfSk7CgpET01FdmVudC5pbXBsZW1lbnQoewoKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucHJldmVudERlZmF1bHQoKS5zdG9wUHJvcGFnYXRpb24oKTsKCX0sCgoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnN0b3BQcm9wYWdhdGlvbikgdGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQllbHNlIHRoaXMuZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQpIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQllbHNlIHRoaXMuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKRE9NRXZlbnQuZGVmaW5lS2V5ID0gZnVuY3Rpb24oY29kZSwga2V5KXsKCV9rZXlzW2NvZGVdID0ga2V5OwoJcmV0dXJuIHRoaXM7Cn07CgpET01FdmVudC5kZWZpbmVLZXlzID0gRE9NRXZlbnQuZGVmaW5lS2V5Lm92ZXJsb2FkU2V0dGVyKHRydWUpOwoKRE9NRXZlbnQuZGVmaW5lS2V5cyh7CgknMzgnOiAndXAnLCAnNDAnOiAnZG93bicsICczNyc6ICdsZWZ0JywgJzM5JzogJ3JpZ2h0JywKCScyNyc6ICdlc2MnLCAnMzInOiAnc3BhY2UnLCAnOCc6ICdiYWNrc3BhY2UnLCAnOSc6ICd0YWInLAoJJzQ2JzogJ2RlbGV0ZScsICcxMyc6ICdlbnRlcicKfSk7Cgp9KSgpOwoKCgoKCgovKgotLS0KCm5hbWU6IENsYXNzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENsYXNzIEZ1bmN0aW9uIGZvciBlYXNpbHkgY3JlYXRpbmcsIGV4dGVuZGluZywgYW5kIGltcGxlbWVudGluZyByZXVzYWJsZSBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIEZ1bmN0aW9uLCBOdW1iZXJdCgpwcm92aWRlczogQ2xhc3MKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgQ2xhc3MgPSB0aGlzLkNsYXNzID0gbmV3IFR5cGUoJ0NsYXNzJywgZnVuY3Rpb24ocGFyYW1zKXsKCWlmIChpbnN0YW5jZU9mKHBhcmFtcywgRnVuY3Rpb24pKSBwYXJhbXMgPSB7aW5pdGlhbGl6ZTogcGFyYW1zfTsKCgl2YXIgbmV3Q2xhc3MgPSBmdW5jdGlvbigpewoJCXJlc2V0KHRoaXMpOwoJCWlmIChuZXdDbGFzcy4kcHJvdG90eXBpbmcpIHJldHVybiB0aGlzOwoJCXRoaXMuJGNhbGxlciA9IG51bGw7CgkJdmFyIHZhbHVlID0gKHRoaXMuaW5pdGlhbGl6ZSkgPyB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXM7CgkJdGhpcy4kY2FsbGVyID0gdGhpcy5jYWxsZXIgPSBudWxsOwoJCXJldHVybiB2YWx1ZTsKCX0uZXh0ZW5kKHRoaXMpLmltcGxlbWVudChwYXJhbXMpOwoKCW5ld0NsYXNzLiRjb25zdHJ1Y3RvciA9IENsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG5ld0NsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLnBhcmVudCA9IHBhcmVudDsKCglyZXR1cm4gbmV3Q2xhc3M7Cn0pOwoKdmFyIHBhcmVudCA9IGZ1bmN0aW9uKCl7CglpZiAoIXRoaXMuJGNhbGxlcikgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICJwYXJlbnQiIGNhbm5vdCBiZSBjYWxsZWQuJyk7Cgl2YXIgbmFtZSA9IHRoaXMuJGNhbGxlci4kbmFtZSwKCQlwYXJlbnQgPSB0aGlzLiRjYWxsZXIuJG93bmVyLnBhcmVudCwKCQlwcmV2aW91cyA9IChwYXJlbnQpID8gcGFyZW50LnByb3RvdHlwZVtuYW1lXSA6IG51bGw7CglpZiAoIXByZXZpb3VzKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgIicgKyBuYW1lICsgJyIgaGFzIG5vIHBhcmVudC4nKTsKCXJldHVybiBwcmV2aW91cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKdmFyIHJlc2V0ID0gZnVuY3Rpb24ob2JqZWN0KXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCXZhciB2YWx1ZSA9IG9iamVjdFtrZXldOwoJCXN3aXRjaCAodHlwZU9mKHZhbHVlKSl7CgkJCWNhc2UgJ29iamVjdCc6CgkJCQl2YXIgRiA9IGZ1bmN0aW9uKCl7fTsKCQkJCUYucHJvdG90eXBlID0gdmFsdWU7CgkJCQlvYmplY3Rba2V5XSA9IHJlc2V0KG5ldyBGKTsKCQkJYnJlYWs7CgkJCWNhc2UgJ2FycmF5Jzogb2JqZWN0W2tleV0gPSB2YWx1ZS5jbG9uZSgpOyBicmVhazsKCQl9Cgl9CglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHdyYXAgPSBmdW5jdGlvbihzZWxmLCBrZXksIG1ldGhvZCl7CglpZiAobWV0aG9kLiRvcmlnaW4pIG1ldGhvZCA9IG1ldGhvZC4kb3JpZ2luOwoJdmFyIHdyYXBwZXIgPSBmdW5jdGlvbigpewoJCWlmIChtZXRob2QuJHByb3RlY3RlZCAmJiB0aGlzLiRjYWxsZXIgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICInICsga2V5ICsgJyIgY2Fubm90IGJlIGNhbGxlZC4nKTsKCQl2YXIgY2FsbGVyID0gdGhpcy5jYWxsZXIsIGN1cnJlbnQgPSB0aGlzLiRjYWxsZXI7CgkJdGhpcy5jYWxsZXIgPSBjdXJyZW50OyB0aGlzLiRjYWxsZXIgPSB3cmFwcGVyOwoJCXZhciByZXN1bHQgPSBtZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl0aGlzLiRjYWxsZXIgPSBjdXJyZW50OyB0aGlzLmNhbGxlciA9IGNhbGxlcjsKCQlyZXR1cm4gcmVzdWx0OwoJfS5leHRlbmQoeyRvd25lcjogc2VsZiwgJG9yaWdpbjogbWV0aG9kLCAkbmFtZToga2V5fSk7CglyZXR1cm4gd3JhcHBlcjsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlLCByZXRhaW4pewoJaWYgKENsYXNzLk11dGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpewoJCXZhbHVlID0gQ2xhc3MuTXV0YXRvcnNba2V5XS5jYWxsKHRoaXMsIHZhbHVlKTsKCQlpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuIHRoaXM7Cgl9CgoJaWYgKHR5cGVPZih2YWx1ZSkgPT0gJ2Z1bmN0aW9uJyl7CgkJaWYgKHZhbHVlLiRoaWRkZW4pIHJldHVybiB0aGlzOwoJCXRoaXMucHJvdG90eXBlW2tleV0gPSAocmV0YWluKSA/IHZhbHVlIDogd3JhcCh0aGlzLCBrZXksIHZhbHVlKTsKCX0gZWxzZSB7CgkJT2JqZWN0Lm1lcmdlKHRoaXMucHJvdG90eXBlLCBrZXksIHZhbHVlKTsKCX0KCglyZXR1cm4gdGhpczsKfTsKCnZhciBnZXRJbnN0YW5jZSA9IGZ1bmN0aW9uKGtsYXNzKXsKCWtsYXNzLiRwcm90b3R5cGluZyA9IHRydWU7Cgl2YXIgcHJvdG8gPSBuZXcga2xhc3M7CglkZWxldGUga2xhc3MuJHByb3RvdHlwaW5nOwoJcmV0dXJuIHByb3RvOwp9OwoKQ2xhc3MuaW1wbGVtZW50KCdpbXBsZW1lbnQnLCBpbXBsZW1lbnQub3ZlcmxvYWRTZXR0ZXIoKSk7CgpDbGFzcy5NdXRhdG9ycyA9IHsKCglFeHRlbmRzOiBmdW5jdGlvbihwYXJlbnQpewoJCXRoaXMucGFyZW50ID0gcGFyZW50OwoJCXRoaXMucHJvdG90eXBlID0gZ2V0SW5zdGFuY2UocGFyZW50KTsKCX0sCgoJSW1wbGVtZW50czogZnVuY3Rpb24oaXRlbXMpewoJCUFycmF5LmZyb20oaXRlbXMpLmVhY2goZnVuY3Rpb24oaXRlbSl7CgkJCXZhciBpbnN0YW5jZSA9IG5ldyBpdGVtOwoJCQlmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2UpIGltcGxlbWVudC5jYWxsKHRoaXMsIGtleSwgaW5zdGFuY2Vba2V5XSwgdHJ1ZSk7CgkJfSwgdGhpcyk7Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQ2xhc3MuRXh0cmFzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgVXRpbGl0eSBDbGFzc2VzIHRoYXQgY2FuIGJlIGltcGxlbWVudGVkIGludG8geW91ciBvd24gQ2xhc3NlcyB0byBlYXNlIHRoZSBleGVjdXRpb24gb2YgbWFueSBjb21tb24gdGFza3MuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBDbGFzcwoKcHJvdmlkZXM6IFtDbGFzcy5FeHRyYXMsIENoYWluLCBFdmVudHMsIE9wdGlvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5DaGFpbiA9IG5ldyBDbGFzcyh7CgoJJGNoYWluOiBbXSwKCgljaGFpbjogZnVuY3Rpb24oKXsKCQl0aGlzLiRjaGFpbi5hcHBlbmQoQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FsbENoYWluOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy4kY2hhaW4ubGVuZ3RoKSA/IHRoaXMuJGNoYWluLnNoaWZ0KCkuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGZhbHNlOwoJfSwKCgljbGVhckNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmVtcHR5KCk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciByZW1vdmVPbiA9IGZ1bmN0aW9uKHN0cmluZyl7CglyZXR1cm4gc3RyaW5nLnJlcGxhY2UoL15vbihbQS1aXSkvLCBmdW5jdGlvbihmdWxsLCBmaXJzdCl7CgkJcmV0dXJuIGZpcnN0LnRvTG93ZXJDYXNlKCk7Cgl9KTsKfTsKCnRoaXMuRXZlbnRzID0gbmV3IENsYXNzKHsKCgkkZXZlbnRzOiB7fSwKCglhZGRFdmVudDogZnVuY3Rpb24odHlwZSwgZm4sIGludGVybmFsKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgoJCQoKCQl0aGlzLiRldmVudHNbdHlwZV0gPSAodGhpcy4kZXZlbnRzW3R5cGVdIHx8IFtdKS5pbmNsdWRlKGZuKTsKCQlpZiAoaW50ZXJuYWwpIGZuLmludGVybmFsID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJYWRkRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCWZvciAodmFyIHR5cGUgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KHR5cGUsIGV2ZW50c1t0eXBlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCQl2YXIgZXZlbnRzID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlldmVudHMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCQl2YXIgZXZlbnRzID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCWlmIChldmVudHMgJiYgIWZuLmludGVybmFsKXsKCQkJdmFyIGluZGV4ID0gIGV2ZW50cy5pbmRleE9mKGZuKTsKCQkJaWYgKGluZGV4ICE9IC0xKSBkZWxldGUgZXZlbnRzW2luZGV4XTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKXsKCQl2YXIgdHlwZTsKCQlpZiAodHlwZU9mKGV2ZW50cykgPT0gJ29iamVjdCcpewoJCQlmb3IgKHR5cGUgaW4gZXZlbnRzKSB0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGV2ZW50c1t0eXBlXSk7CgkJCXJldHVybiB0aGlzOwoJCX0KCQlpZiAoZXZlbnRzKSBldmVudHMgPSByZW1vdmVPbihldmVudHMpOwoJCWZvciAodHlwZSBpbiB0aGlzLiRldmVudHMpewoJCQlpZiAoZXZlbnRzICYmIGV2ZW50cyAhPSB0eXBlKSBjb250aW51ZTsKCQkJdmFyIGZucyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQkJZm9yICh2YXIgaSA9IGZucy5sZW5ndGg7IGktLTspIGlmIChpIGluIGZucyl7CgkJCQl0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGZuc1tpXSk7CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnRoaXMuT3B0aW9ucyA9IG5ldyBDbGFzcyh7CgoJc2V0T3B0aW9uczogZnVuY3Rpb24oKXsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyA9IE9iamVjdC5tZXJnZS5hcHBseShudWxsLCBbe30sIHRoaXMub3B0aW9uc10uYXBwZW5kKGFyZ3VtZW50cykpOwoJCWlmICh0aGlzLmFkZEV2ZW50KSBmb3IgKHZhciBvcHRpb24gaW4gb3B0aW9ucyl7CgkJCWlmICh0eXBlT2Yob3B0aW9uc1tvcHRpb25dKSAhPSAnZnVuY3Rpb24nIHx8ICEoL15vbltBLVpdLykudGVzdChvcHRpb24pKSBjb250aW51ZTsKCQkJdGhpcy5hZGRFdmVudChvcHRpb24sIG9wdGlvbnNbb3B0aW9uXSk7CgkJCWRlbGV0ZSBvcHRpb25zW29wdGlvbl07CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp9KSgpOwoKCi8qCi0tLQpuYW1lOiBTbGljay5QYXJzZXIKZGVzY3JpcHRpb246IFN0YW5kYWxvbmUgQ1NTMyBTZWxlY3RvciBwYXJzZXIKcHJvdmlkZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCjsoZnVuY3Rpb24oKXsKCnZhciBwYXJzZWQsCglzZXBhcmF0b3JJbmRleCwKCWNvbWJpbmF0b3JJbmRleCwKCXJldmVyc2VkLAoJY2FjaGUgPSB7fSwKCXJldmVyc2VDYWNoZSA9IHt9LAoJcmVVbmVzY2FwZSA9IC9cXC9nOwoKdmFyIHBhcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgaXNSZXZlcnNlZCl7CglpZiAoZXhwcmVzc2lvbiA9PSBudWxsKSByZXR1cm4gbnVsbDsKCWlmIChleHByZXNzaW9uLlNsaWNrID09PSB0cnVlKSByZXR1cm4gZXhwcmVzc2lvbjsKCWV4cHJlc3Npb24gPSAoJycgKyBleHByZXNzaW9uKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwoJcmV2ZXJzZWQgPSAhIWlzUmV2ZXJzZWQ7Cgl2YXIgY3VycmVudENhY2hlID0gKHJldmVyc2VkKSA/IHJldmVyc2VDYWNoZSA6IGNhY2hlOwoJaWYgKGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXSkgcmV0dXJuIGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXTsKCXBhcnNlZCA9IHsKCQlTbGljazogdHJ1ZSwKCQlleHByZXNzaW9uczogW10sCgkJcmF3OiBleHByZXNzaW9uLAoJCXJldmVyc2U6IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBwYXJzZSh0aGlzLnJhdywgdHJ1ZSk7CgkJfQoJfTsKCXNlcGFyYXRvckluZGV4ID0gLTE7Cgl3aGlsZSAoZXhwcmVzc2lvbiAhPSAoZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShyZWdleHAsIHBhcnNlcikpKTsKCXBhcnNlZC5sZW5ndGggPSBwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoOwoJcmV0dXJuIGN1cnJlbnRDYWNoZVtwYXJzZWQucmF3XSA9IChyZXZlcnNlZCkgPyByZXZlcnNlKHBhcnNlZCkgOiBwYXJzZWQ7Cn07Cgp2YXIgcmV2ZXJzZUNvbWJpbmF0b3IgPSBmdW5jdGlvbihjb21iaW5hdG9yKXsKCWlmIChjb21iaW5hdG9yID09PSAnIScpIHJldHVybiAnICc7CgllbHNlIGlmIChjb21iaW5hdG9yID09PSAnICcpIHJldHVybiAnISc7CgllbHNlIGlmICgoL14hLykudGVzdChjb21iaW5hdG9yKSkgcmV0dXJuIGNvbWJpbmF0b3IucmVwbGFjZSgvXiEvLCAnJyk7CgllbHNlIHJldHVybiAnIScgKyBjb21iaW5hdG9yOwp9OwoKdmFyIHJldmVyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uKXsKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gMDsgaSA8IGV4cHJlc3Npb25zLmxlbmd0aDsgaSsrKXsKCQl2YXIgZXhwID0gZXhwcmVzc2lvbnNbaV07CgkJdmFyIGxhc3QgPSB7cGFydHM6IFtdLCB0YWc6ICcqJywgY29tYmluYXRvcjogcmV2ZXJzZUNvbWJpbmF0b3IoZXhwWzBdLmNvbWJpbmF0b3IpfTsKCgkJZm9yICh2YXIgaiA9IDA7IGogPCBleHAubGVuZ3RoOyBqKyspewoJCQl2YXIgY2V4cCA9IGV4cFtqXTsKCQkJaWYgKCFjZXhwLnJldmVyc2VDb21iaW5hdG9yKSBjZXhwLnJldmVyc2VDb21iaW5hdG9yID0gJyAnOwoJCQljZXhwLmNvbWJpbmF0b3IgPSBjZXhwLnJldmVyc2VDb21iaW5hdG9yOwoJCQlkZWxldGUgY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQl9CgoJCWV4cC5yZXZlcnNlKCkucHVzaChsYXN0KTsKCX0KCXJldHVybiBleHByZXNzaW9uOwp9OwoKdmFyIGVzY2FwZVJlZ0V4cCA9IGZ1bmN0aW9uKHN0cmluZyl7Ly8gQ3JlZGl0OiBYUmVnRXhwIDAuNi4xIChjKSAyMDA3LTIwMDggU3RldmVuIExldml0aGFuIDxodHRwOi8vc3RldmVubGV2aXRoYW4uY29tL3JlZ2V4L3hyZWdleHAvPiBNSVQgTGljZW5zZQoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVtcXXt9KCkqKz8uXFxeJHwsI1xzXS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJcmV0dXJuICdcXCcgKyBtYXRjaDsKCX0pOwp9OwoKdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAoCi8qCiMhL3Vzci9iaW4vZW52IHJ1YnkKcHV0cyAiXHRcdCIgKyBEQVRBLnJlYWQuZ3N1YigvXChcP3hcKXxccysjLiokfFxzK3xcXCR8XFxuLywnJykKX19FTkRfXwoJIig/eCleKD86XAoJICBcXHMqICggLCApIFxccyogICAgICAgICAgICAgICAjIFNlcGFyYXRvciAgICAgICAgICBcblwKCXwgXFxzKiAoIDxjb21iaW5hdG9yPisgKSBcXHMqICAgIyBDb21iaW5hdG9yICAgICAgICAgXG5cCgl8ICAgICAgKCBcXHMrICkgICAgICAgICAgICAgICAgICMgQ29tYmluYXRvckNoaWxkcmVuIFxuXAoJfCAgICAgICggPHVuaWNvZGU+KyB8IFxcKiApICAgICAjIFRhZyAgICAgICAgICAgICAgICBcblwKCXwgXFwjICAoIDx1bmljb2RlPisgICAgICAgKSAgICAgIyBJRCAgICAgICAgICAgICAgICAgXG5cCgl8IFxcLiAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgQ2xhc3NOYW1lICAgICAgICAgIFxuXAoJfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEF0dHJpYnV0ZSAgICAgICAgICBcblwKCVxcWyAgXAoJCVxccyogKDx1bmljb2RlMT4rKSAgKD86ICBcCgkJCVxccyogKFsqXiQhfnxdPz0pICAoPzogIFwKCQkJCVxccyogKD86XAoJCQkJCShbXCInXT8pKC4qPylcXDkgXAoJCQkJKVwKCQkJKSAgXAoJCSk/ICBcXHMqICBcCglcXF0oPyFcXF0pIFxuXAoJfCAgIDorICggPHVuaWNvZGU+KyApKD86XAoJXFwoICg/OlwKCQkoPzooW1wiJ10pKFteXFwxMl0qKVxcMTIpfCgoPzpcXChbXildK1xcKXxbXigpXSopKylcCgkpIFxcKVwKCSk/XAoJKSIKKi8KCSJeKD86XFxzKigsKVxccyp8XFxzKig8Y29tYmluYXRvcj4rKVxccyp8KFxccyspfCg8dW5pY29kZT4rfFxcKil8XFwjKDx1bmljb2RlPispfFxcLig8dW5pY29kZT4rKXxcXFtcXHMqKDx1bmljb2RlMT4rKSg/OlxccyooWypeJCF+fF0/PSkoPzpcXHMqKD86KFtcIiddPykoLio/KVxcOSkpKT9cXHMqXFxdKD8hXFxdKXwoOispKDx1bmljb2RlPispKD86XFwoKD86KD86KFtcIiddKShbXlxcMTNdKilcXDEzKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspKVxcKSk/KSIKCS5yZXBsYWNlKC88Y29tYmluYXRvcj4vLCAnWycgKyBlc2NhcGVSZWdFeHAoIj4rfmAhQCQlXiY9e31cXDs8LyIpICsgJ10nKQoJLnJlcGxhY2UoLzx1bmljb2RlPi9nLCAnKD86W1xcd1xcdTAwYTEtXFx1RkZGRi1dfFxcXFxbXlxcczAtOWEtZl0pJykKCS5yZXBsYWNlKC88dW5pY29kZTE+L2csICcoPzpbOlxcd1xcdTAwYTEtXFx1RkZGRi1dfFxcXFxbXlxcczAtOWEtZl0pJykKKTsKCmZ1bmN0aW9uIHBhcnNlcigKCXJhd01hdGNoLAoKCXNlcGFyYXRvciwKCWNvbWJpbmF0b3IsCgljb21iaW5hdG9yQ2hpbGRyZW4sCgoJdGFnTmFtZSwKCWlkLAoJY2xhc3NOYW1lLAoKCWF0dHJpYnV0ZUtleSwKCWF0dHJpYnV0ZU9wZXJhdG9yLAoJYXR0cmlidXRlUXVvdGUsCglhdHRyaWJ1dGVWYWx1ZSwKCglwc2V1ZG9NYXJrZXIsCglwc2V1ZG9DbGFzcywKCXBzZXVkb1F1b3RlLAoJcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZSwKCXBzZXVkb0NsYXNzVmFsdWUKKXsKCWlmIChzZXBhcmF0b3IgfHwgc2VwYXJhdG9ySW5kZXggPT09IC0xKXsKCQlwYXJzZWQuZXhwcmVzc2lvbnNbKytzZXBhcmF0b3JJbmRleF0gPSBbXTsKCQljb21iaW5hdG9ySW5kZXggPSAtMTsKCQlpZiAoc2VwYXJhdG9yKSByZXR1cm4gJyc7Cgl9CgoJaWYgKGNvbWJpbmF0b3IgfHwgY29tYmluYXRvckNoaWxkcmVuIHx8IGNvbWJpbmF0b3JJbmRleCA9PT0gLTEpewoJCWNvbWJpbmF0b3IgPSBjb21iaW5hdG9yIHx8ICcgJzsKCQl2YXIgY3VycmVudFNlcGFyYXRvciA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF07CgkJaWYgKHJldmVyc2VkICYmIGN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XSkKCQkJY3VycmVudFNlcGFyYXRvcltjb21iaW5hdG9ySW5kZXhdLnJldmVyc2VDb21iaW5hdG9yID0gcmV2ZXJzZUNvbWJpbmF0b3IoY29tYmluYXRvcik7CgkJY3VycmVudFNlcGFyYXRvclsrK2NvbWJpbmF0b3JJbmRleF0gPSB7Y29tYmluYXRvcjogY29tYmluYXRvciwgdGFnOiAnKid9OwoJfQoKCXZhciBjdXJyZW50UGFyc2VkID0gcGFyc2VkLmV4cHJlc3Npb25zW3NlcGFyYXRvckluZGV4XVtjb21iaW5hdG9ySW5kZXhdOwoKCWlmICh0YWdOYW1lKXsKCQljdXJyZW50UGFyc2VkLnRhZyA9IHRhZ05hbWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJfSBlbHNlIGlmIChpZCl7CgkJY3VycmVudFBhcnNlZC5pZCA9IGlkLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoY2xhc3NOYW1lKXsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc0xpc3QpIGN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0ID0gW107CgkJaWYgKCFjdXJyZW50UGFyc2VkLmNsYXNzZXMpIGN1cnJlbnRQYXJzZWQuY2xhc3NlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0LnB1c2goY2xhc3NOYW1lKTsKCQljdXJyZW50UGFyc2VkLmNsYXNzZXMucHVzaCh7CgkJCXZhbHVlOiBjbGFzc05hbWUsCgkJCXJlZ2V4cDogbmV3IFJlZ0V4cCgnKF58XFxzKScgKyBlc2NhcGVSZWdFeHAoY2xhc3NOYW1lKSArICcoXFxzfCQpJykKCQl9KTsKCgl9IGVsc2UgaWYgKHBzZXVkb0NsYXNzKXsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSB8fCBwc2V1ZG9DbGFzc1F1b3RlZFZhbHVlOwoJCXBzZXVkb0NsYXNzVmFsdWUgPSBwc2V1ZG9DbGFzc1ZhbHVlID8gcHNldWRvQ2xhc3NWYWx1ZS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKSA6IG51bGw7CgoJCWlmICghY3VycmVudFBhcnNlZC5wc2V1ZG9zKSBjdXJyZW50UGFyc2VkLnBzZXVkb3MgPSBbXTsKCQljdXJyZW50UGFyc2VkLnBzZXVkb3MucHVzaCh7CgkJCWtleTogcHNldWRvQ2xhc3MucmVwbGFjZShyZVVuZXNjYXBlLCAnJyksCgkJCXZhbHVlOiBwc2V1ZG9DbGFzc1ZhbHVlLAoJCQl0eXBlOiBwc2V1ZG9NYXJrZXIubGVuZ3RoID09IDEgPyAnY2xhc3MnIDogJ2VsZW1lbnQnCgkJfSk7CgoJfSBlbHNlIGlmIChhdHRyaWJ1dGVLZXkpewoJCWF0dHJpYnV0ZUtleSA9IGF0dHJpYnV0ZUtleS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCQlhdHRyaWJ1dGVWYWx1ZSA9IChhdHRyaWJ1dGVWYWx1ZSB8fCAnJykucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJCXZhciB0ZXN0LCByZWdleHA7CgoJCXN3aXRjaCAoYXR0cmlidXRlT3BlcmF0b3IpewoJCQljYXNlICdePScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAnXicrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgICAgICAgICAgICApOyBicmVhazsKCQkJY2FzZSAnJD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgICAgICBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnJCcgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJ349JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICcoXnxcXHMpJysgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyhcXHN8JCknICk7IGJyZWFrOwoJCQljYXNlICd8PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAnXicrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoLXwkKScgICApOyBicmVhazsKCQkJY2FzZSAgJz0nIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiBhdHRyaWJ1dGVWYWx1ZSA9PSB2YWx1ZTsKCQkJfTsgYnJlYWs7CgkJCWNhc2UgJyo9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gdmFsdWUgJiYgdmFsdWUuaW5kZXhPZihhdHRyaWJ1dGVWYWx1ZSkgPiAtMTsKCQkJfTsgYnJlYWs7CgkJCWNhc2UgJyE9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgIT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQlkZWZhdWx0ICAgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuICEhdmFsdWU7CgkJCX07CgkJfQoKCQlpZiAoYXR0cmlidXRlVmFsdWUgPT0gJycgJiYgKC9eWyokXl09JC8pLnRlc3QoYXR0cmlidXRlT3BlcmF0b3IpKSB0ZXN0ID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJCWlmICghdGVzdCkgdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlICYmIHJlZ2V4cC50ZXN0KHZhbHVlKTsKCQl9OwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcykgY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzID0gW107CgkJY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzLnB1c2goewoJCQlrZXk6IGF0dHJpYnV0ZUtleSwKCQkJb3BlcmF0b3I6IGF0dHJpYnV0ZU9wZXJhdG9yLAoJCQl2YWx1ZTogYXR0cmlidXRlVmFsdWUsCgkJCXRlc3Q6IHRlc3QKCQl9KTsKCgl9CgoJcmV0dXJuICcnOwp9OwoKLy8gU2xpY2sgTlMKCnZhciBTbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnBhcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7CglyZXR1cm4gcGFyc2UoZXhwcmVzc2lvbik7Cn07CgpTbGljay5lc2NhcGVSZWdFeHAgPSBlc2NhcGVSZWdFeHA7CgppZiAoIXRoaXMuU2xpY2spIHRoaXMuU2xpY2sgPSBTbGljazsKCn0pLmFwcGx5KC8qPENvbW1vbkpTPiovKHR5cGVvZiBleHBvcnRzICE9ICd1bmRlZmluZWQnKSA/IGV4cG9ydHMgOiAvKjwvQ29tbW9uSlM+Ki90aGlzKTsKCgovKgotLS0KbmFtZTogU2xpY2suRmluZGVyCmRlc2NyaXB0aW9uOiBUaGUgbmV3LCBzdXBlcmZhc3QgY3NzIHNlbGVjdG9yIGVuZ2luZS4KcHJvdmlkZXM6IFNsaWNrLkZpbmRlcgpyZXF1aXJlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKOyhmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge30sCglmZWF0dXJlc0NhY2hlID0ge30sCgl0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8ICh0b1N0cmluZy5jYWxsKGRvY3VtZW50KSA9PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09IDkgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9ICdIVE1MJyk7Cn07Cgpsb2NhbC5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCgkvLyBjb252ZXJ0IGVsZW1lbnRzIC8gd2luZG93IGFyZ3VtZW50cyB0byBkb2N1bWVudC4gaWYgZG9jdW1lbnQgY2Fubm90IGJlIGV4dHJhcG9sYXRlZCwgdGhlIGZ1bmN0aW9uIHJldHVybnMuCgl2YXIgbm9kZVR5cGUgPSBkb2N1bWVudC5ub2RlVHlwZTsKCWlmIChub2RlVHlwZSA9PSA5KTsgLy8gZG9jdW1lbnQKCWVsc2UgaWYgKG5vZGVUeXBlKSBkb2N1bWVudCA9IGRvY3VtZW50Lm93bmVyRG9jdW1lbnQ7IC8vIG5vZGUKCWVsc2UgaWYgKGRvY3VtZW50Lm5hdmlnYXRvcikgZG9jdW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudDsgLy8gd2luZG93CgllbHNlIHJldHVybjsKCgkvLyBjaGVjayBpZiBpdCdzIHRoZSBvbGQgZG9jdW1lbnQKCglpZiAodGhpcy5kb2N1bWVudCA9PT0gZG9jdW1lbnQpIHJldHVybjsKCXRoaXMuZG9jdW1lbnQgPSBkb2N1bWVudDsKCgkvLyBjaGVjayBpZiB3ZSBoYXZlIGRvbmUgZmVhdHVyZSBkZXRlY3Rpb24gb24gdGhpcyBkb2N1bWVudCBiZWZvcmUKCgl2YXIgcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlyb290VWlkID0gdGhpcy5nZXRVSURYTUwocm9vdCksCgkJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdLAoJCWZlYXR1cmU7CgoJaWYgKGZlYXR1cmVzKXsKCQlmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCQl0aGlzW2ZlYXR1cmVdID0gZmVhdHVyZXNbZmVhdHVyZV07CgkJfQoJCXJldHVybjsKCX0KCglmZWF0dXJlcyA9IGZlYXR1cmVzQ2FjaGVbcm9vdFVpZF0gPSB7fTsKCglmZWF0dXJlcy5yb290ID0gcm9vdDsKCWZlYXR1cmVzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCglmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4KCT0gZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EKCT0gZmVhdHVyZXMuaWRHZXRzTmFtZQoJPSBmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EKCT0gZmVhdHVyZXMuYnJva2VuR0VCQ04KCT0gZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQQoJPSBmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQQoJPSBmZWF0dXJlcy5pc0hUTUxEb2N1bWVudAoJPSBmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lLAoJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXI7CgoJdmFyIHNlbGVjdGVkLCBpZCA9ICdzbGlja191bmlxdWVpZCc7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCgl2YXIgdGVzdFJvb3QgPSBkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF0gfHwgcm9vdDsKCXRlc3RSb290LmFwcGVuZENoaWxkKHRlc3ROb2RlKTsKCgkvLyBvbiBub24tSFRNTCBkb2N1bWVudHMgaW5uZXJIVE1MIGFuZCBnZXRFbGVtZW50c0J5SWQgZG9lc250IHdvcmsgcHJvcGVybHkKCXRyeSB7CgkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGlkPSInK2lkKyciPjwvYT4nOwoJCWZlYXR1cmVzLmlzSFRNTERvY3VtZW50ID0gISFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7Cgl9IGNhdGNoKGUpe307CgoJaWYgKGZlYXR1cmVzLmlzSFRNTERvY3VtZW50KXsKCgkJdGVzdE5vZGUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCgkJLy8gSUUgcmV0dXJucyBjb21tZW50IG5vZGVzIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRlc3ROb2RlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJycpKTsKCQlzdGFyU2VsZWN0c0NvbW1lbnRzID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoID4gMSk7CgoJCS8vIElFIHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJc3RhclNlbGVjdHNDbG9zZWQgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJfSBjYXRjaChlKXt9OwoKCQlmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4gPSBzdGFyU2VsZWN0c0NvbW1lbnRzIHx8IHN0YXJTZWxlY3RzQ2xvc2VkOwoKCQkvLyBJRSByZXR1cm5zIGVsZW1lbnRzIHdpdGggdGhlIG5hbWUgaW5zdGVhZCBvZiBqdXN0IGlkIGZvciBnZXRFbGVtZW50c0J5SWQgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIG5hbWU9IicrIGlkICsnIj48L2E+PGIgaWQ9IicrIGlkICsnIj48L2I+JzsKCQkJZmVhdHVyZXMuaWRHZXRzTmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSA9PT0gdGVzdE5vZGUuZmlyc3RDaGlsZDsKCQl9IGNhdGNoKGUpe307CgoJCWlmICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKXsKCgkJCS8vIFNhZmFyaSAzLjIgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYWNoZXMgcmVzdWx0cwoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJmIj48L2E+PGEgY2xhc3M9ImIiPjwvYT4nOwoJCQkJdGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYicpLmxlbmd0aDsKCQkJCXRlc3ROb2RlLmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gJ2InOwoJCQkJY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoICE9IDIpOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBPcGVyYSA5LjYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBkb2VzbnQgZGV0ZWN0cyB0aGUgY2xhc3MgaWYgaXRzIG5vdCB0aGUgZmlyc3Qgb25lCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9ImEiPjwvYT48YSBjbGFzcz0iZiBiIGEiPjwvYT4nOwoJCQkJYnJva2VuU2Vjb25kQ2xhc3NOYW1lR0VCQ04gPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYScpLmxlbmd0aCAhPSAyKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJZmVhdHVyZXMuYnJva2VuR0VCQ04gPSBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHx8IGJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOOwoJCX0KCgkJaWYgKHRlc3ROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwpewoJCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICdmb288L2Zvbz4nOwoJCQkJc2VsZWN0ZWQgPSB0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcqJyk7CgkJCQlmZWF0dXJlcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSA9IChzZWxlY3RlZCAmJiAhIXNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gU2FmYXJpIDMuMiBxdWVyeVNlbGVjdG9yQWxsIGRvZXNudCB3b3JrIHdpdGggbWl4ZWRjYXNlIG9uIHF1aXJrc21vZGUKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iTWlYIj48L2E+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYJykubGVuZ3RoOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBXZWJraXQgYW5kIE9wZXJhIGRvbnQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQkJZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCc6Y2hlY2tlZCcpLmxlbmd0aCA9PSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gSUUgcmV0dXJucyBpbmNvcnJlY3QgcmVzdWx0cyBmb3IgYXR0clsqXiRdPSIiIHNlbGVjdG9ycyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9IiI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQl9CgoJCS8vIElFNi03LCBpZiBhIGZvcm0gaGFzIGFuIGlucHV0IG9mIGlkIHgsIGZvcm0uZ2V0QXR0cmlidXRlKHgpIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGlucHV0CgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxmb3JtIGFjdGlvbj0icyI+PGlucHV0IGlkPSJhY3Rpb24iLz48L2Zvcm0+JzsKCQkJYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlciA9ICh0ZXN0Tm9kZS5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgnYWN0aW9uJykgIT0gJ3MnKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIG5hdGl2ZSBtYXRjaGVzU2VsZWN0b3IgZnVuY3Rpb24KCgkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yID0gcm9vdC5tYXRjaGVzU2VsZWN0b3IgfHwgLypyb290Lm1zTWF0Y2hlc1NlbGVjdG9yIHx8Ki8gcm9vdC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgcm9vdC53ZWJraXRNYXRjaGVzU2VsZWN0b3I7CgkJaWYgKGZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvcikgdHJ5IHsKCQkJLy8gaWYgbWF0Y2hlc1NlbGVjdG9yIHRyb3dzIGVycm9ycyBvbiBpbmNvcnJlY3Qgc2ludGF4ZXMgd2UgY2FuIHVzZSBpdAoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IuY2FsbChyb290LCAnOnNsaWNrJyk7CgkJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IG51bGw7CgkJfSBjYXRjaChlKXt9OwoKCX0KCgl0cnkgewoJCXJvb3Quc2xpY2tfZXhwYW5kbyA9IDE7CgkJZGVsZXRlIHJvb3Quc2xpY2tfZXhwYW5kbzsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJREhUTUw7Cgl9IGNhdGNoKGUpIHsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJRFhNTDsKCX0KCgl0ZXN0Um9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IHNlbGVjdGVkID0gdGVzdFJvb3QgPSBudWxsOwoKCS8vIGdldEF0dHJpYnV0ZQoKCWZlYXR1cmVzLmdldEF0dHJpYnV0ZSA9IChmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCAmJiBicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyKSA/IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJCXZhciBhdHRyaWJ1dGVOb2RlID0gbm9kZS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpOwoJCXJldHVybiAoYXR0cmlidXRlTm9kZSkgPyBhdHRyaWJ1dGVOb2RlLm5vZGVWYWx1ZSA6IG51bGw7Cgl9IDogZnVuY3Rpb24obm9kZSwgbmFtZSl7CgkJdmFyIG1ldGhvZCA9IHRoaXMuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKCQlyZXR1cm4gKG1ldGhvZCkgPyBtZXRob2QuY2FsbChub2RlKSA6IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwoJfTsKCgkvLyBoYXNBdHRyaWJ1dGUKCglmZWF0dXJlcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCXZhciBuYXRpdmVSb290Q29udGFpbnMgPSByb290ICYmIHRoaXMuaXNOYXRpdmVDb2RlKHJvb3QuY29udGFpbnMpLAoJCW5hdGl2ZURvY3VtZW50Q29udGFpbnMgPSBkb2N1bWVudCAmJiB0aGlzLmlzTmF0aXZlQ29kZShkb2N1bWVudC5jb250YWlucyk7CgoJZmVhdHVyZXMuY29udGFpbnMgPSAobmF0aXZlUm9vdENvbnRhaW5zICYmIG5hdGl2ZURvY3VtZW50Q29udGFpbnMpID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJcmV0dXJuIGNvbnRleHQuY29udGFpbnMobm9kZSk7Cgl9IDogKG5hdGl2ZVJvb3RDb250YWlucyAmJiAhbmF0aXZlRG9jdW1lbnRDb250YWlucykgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQkvLyBJRTggZG9lcyBub3QgaGF2ZSAuY29udGFpbnMgb24gZG9jdW1lbnQuCgkJcmV0dXJuIGNvbnRleHQgPT09IG5vZGUgfHwgKChjb250ZXh0ID09PSBkb2N1bWVudCkgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgOiBjb250ZXh0KS5jb250YWlucyhub2RlKTsKCX0gOiAocm9vdCAmJiByb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0ID09PSBub2RlIHx8ICEhKGNvbnRleHQuY29tcGFyZURvY3VtZW50UG9zaXRpb24obm9kZSkgJiAxNik7Cgl9IDogZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJaWYgKG5vZGUpIGRvIHsKCQkJaWYgKG5vZGUgPT09IGNvbnRleHQpIHJldHVybiB0cnVlOwoJCX0gd2hpbGUgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSk7CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkvLyBkb2N1bWVudCBvcmRlciBzb3J0aW5nCgkvLyBjcmVkaXRzIHRvIFNpenpsZSAoaHR0cDovL3NpenpsZWpzLmNvbS8pCgoJZmVhdHVyZXMuZG9jdW1lbnRTb3J0ZXIgPSAocm9vdC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gfHwgIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb24pIHJldHVybiAwOwoJCXJldHVybiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGIpICYgNCA/IC0xIDogYSA9PT0gYiA/IDAgOiAxOwoJfSA6ICgnc291cmNlSW5kZXgnIGluIHJvb3QpID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLnNvdXJjZUluZGV4IHx8ICFiLnNvdXJjZUluZGV4KSByZXR1cm4gMDsKCQlyZXR1cm4gYS5zb3VyY2VJbmRleCAtIGIuc291cmNlSW5kZXg7Cgl9IDogKGRvY3VtZW50LmNyZWF0ZVJhbmdlKSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5vd25lckRvY3VtZW50IHx8ICFiLm93bmVyRG9jdW1lbnQpIHJldHVybiAwOwoJCXZhciBhUmFuZ2UgPSBhLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKSwgYlJhbmdlID0gYi5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7CgkJYVJhbmdlLnNldFN0YXJ0KGEsIDApOwoJCWFSYW5nZS5zZXRFbmQoYSwgMCk7CgkJYlJhbmdlLnNldFN0YXJ0KGIsIDApOwoJCWJSYW5nZS5zZXRFbmQoYiwgMCk7CgkJcmV0dXJuIGFSYW5nZS5jb21wYXJlQm91bmRhcnlQb2ludHMoUmFuZ2UuU1RBUlRfVE9fRU5ELCBiUmFuZ2UpOwoJfSA6IG51bGwgOwoKCXJvb3QgPSBudWxsOwoKCWZvciAoZmVhdHVyZSBpbiBmZWF0dXJlcyl7CgkJdGhpc1tmZWF0dXJlXSA9IGZlYXR1cmVzW2ZlYXR1cmVdOwoJfQp9OwoKLy8gTWFpbiBNZXRob2QKCnZhciByZVNpbXBsZVNlbGVjdG9yID0gL14oWyMuXT8pKCg/Oltcdy1dK3xcKikpJC8sCglyZUVtcHR5QXR0cmlidXRlID0gL1xbLitbKiReXT0oPzoiInwnJyk/XF0vLAoJcXNhRmFpbEV4cENhY2hlID0ge307Cgpsb2NhbC5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQsIGZpcnN0KXsKCgl2YXIgZm91bmQgPSB0aGlzLmZvdW5kID0gKGZpcnN0KSA/IG51bGwgOiAoYXBwZW5kIHx8IFtdKTsKCglpZiAoIWNvbnRleHQpIHJldHVybiBmb3VuZDsKCWVsc2UgaWYgKGNvbnRleHQubmF2aWdhdG9yKSBjb250ZXh0ID0gY29udGV4dC5kb2N1bWVudDsgLy8gQ29udmVydCB0aGUgbm9kZSBmcm9tIGEgd2luZG93IHRvIGEgZG9jdW1lbnQKCWVsc2UgaWYgKCFjb250ZXh0Lm5vZGVUeXBlKSByZXR1cm4gZm91bmQ7CgoJLy8gc2V0dXAKCgl2YXIgcGFyc2VkLCBpLAoJCXVuaXF1ZXMgPSB0aGlzLnVuaXF1ZXMgPSB7fSwKCQloYXNPdGhlcnMgPSAhIShhcHBlbmQgJiYgYXBwZW5kLmxlbmd0aCksCgkJY29udGV4dElzRG9jdW1lbnQgPSAoY29udGV4dC5ub2RlVHlwZSA9PSA5KTsKCglpZiAodGhpcy5kb2N1bWVudCAhPT0gKGNvbnRleHRJc0RvY3VtZW50ID8gY29udGV4dCA6IGNvbnRleHQub3duZXJEb2N1bWVudCkpIHRoaXMuc2V0RG9jdW1lbnQoY29udGV4dCk7CgoJLy8gYXZvaWQgZHVwbGljYXRpbmcgaXRlbXMgYWxyZWFkeSBpbiB0aGUgYXBwZW5kIGFycmF5CglpZiAoaGFzT3RoZXJzKSBmb3IgKGkgPSBmb3VuZC5sZW5ndGg7IGktLTspIHVuaXF1ZXNbdGhpcy5nZXRVSUQoZm91bmRbaV0pXSA9IHRydWU7CgoJLy8gZXhwcmVzc2lvbiBjaGVja3MKCglpZiAodHlwZW9mIGV4cHJlc3Npb24gPT0gJ3N0cmluZycpeyAvLyBleHByZXNzaW9uIGlzIGEgc3RyaW5nCgoJCS8qPHNpbXBsZS1zZWxlY3RvcnMtb3ZlcnJpZGU+Ki8KCQl2YXIgc2ltcGxlU2VsZWN0b3IgPSBleHByZXNzaW9uLm1hdGNoKHJlU2ltcGxlU2VsZWN0b3IpOwoJCXNpbXBsZVNlbGVjdG9yczogaWYgKHNpbXBsZVNlbGVjdG9yKSB7CgoJCQl2YXIgc3ltYm9sID0gc2ltcGxlU2VsZWN0b3JbMV0sCgkJCQluYW1lID0gc2ltcGxlU2VsZWN0b3JbMl0sCgkJCQlub2RlLCBub2RlczsKCgkJCWlmICghc3ltYm9sKXsKCgkJCQlpZiAobmFtZSA9PSAnKicgJiYgdGhpcy5icm9rZW5TdGFyR0VCVE4pIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKTsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGVzWzBdIHx8IG51bGw7CgkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnIycpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAhY29udGV4dElzRG9jdW1lbnQpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCW5vZGUgPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKG5hbWUpOwoJCQkJaWYgKCFub2RlKSByZXR1cm4gZm91bmQ7CgkJCQlpZiAodGhpcy5pZEdldHNOYW1lICYmIG5vZGUuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgIT0gbmFtZSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZSB8fCBudWxsOwoJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCgkJCX0gZWxzZSBpZiAoc3ltYm9sID09ICcuJyl7CgoJCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50IHx8ICgoIWNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCB0aGlzLmJyb2tlbkdFQkNOKSAmJiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwpKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlpZiAoY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShuYW1lKTsKCQkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgbWF0Y2hDbGFzcyA9IG5ldyBSZWdFeHAoJyhefFxccyknKyBTbGljay5lc2NhcGVSZWdFeHAobmFtZSkgKycoXFxzfCQpJyk7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQkJY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CgkJCQkJCWlmICghKGNsYXNzTmFtZSAmJiBtYXRjaENsYXNzLnRlc3QoY2xhc3NOYW1lKSkpIGNvbnRpbnVlOwoJCQkJCQlpZiAoZmlyc3QpIHJldHVybiBub2RlOwoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0KCgkJCX0KCgkJCWlmIChoYXNPdGhlcnMpIHRoaXMuc29ydChmb3VuZCk7CgkJCXJldHVybiAoZmlyc3QpID8gbnVsbCA6IGZvdW5kOwoKCQl9CgkJLyo8L3NpbXBsZS1zZWxlY3RvcnMtb3ZlcnJpZGU+Ki8KCgkJLyo8cXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCQlxdWVyeVNlbGVjdG9yOiBpZiAoY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSB7CgoJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQKCQkJCXx8IHFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXQoJCQkJLy9UT0RPOiBvbmx5IHNraXAgd2hlbiBleHByZXNzaW9uIGlzIGFjdHVhbGx5IG1peGVkIGNhc2UKCQkJCXx8IHRoaXMuYnJva2VuTWl4ZWRDYXNlUVNBCgkJCQl8fCAodGhpcy5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKQoJCQkJfHwgKHRoaXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EgJiYgcmVFbXB0eUF0dHJpYnV0ZS50ZXN0KGV4cHJlc3Npb24pKQoJCQkJfHwgKCFjb250ZXh0SXNEb2N1bWVudCAvL0Fib3J0IHdoZW4gIWNvbnRleHRJc0RvY3VtZW50IGFuZC4uLgoJCQkJCS8vICB0aGVyZSBhcmUgbXVsdGlwbGUgZXhwcmVzc2lvbnMgaW4gdGhlIHNlbGVjdG9yCgkJCQkJLy8gIHNpbmNlIHdlIGN1cnJlbnRseSBvbmx5IGZpeCBub24tZG9jdW1lbnQgcm9vdGVkIFFTQSBmb3Igc2luZ2xlIGV4cHJlc3Npb24gc2VsZWN0b3JzCgkJCQkJJiYgZXhwcmVzc2lvbi5pbmRleE9mKCcsJykgPiAtMQoJCQkJKQoJCQkJfHwgU2xpY2suZGlzYWJsZVFTQQoJCQkpIGJyZWFrIHF1ZXJ5U2VsZWN0b3I7CgoJCQl2YXIgX2V4cHJlc3Npb24gPSBleHByZXNzaW9uLCBfY29udGV4dCA9IGNvbnRleHQ7CgkJCWlmICghY29udGV4dElzRG9jdW1lbnQpewoJCQkJLy8gbm9uLWRvY3VtZW50IHJvb3RlZCBRU0EKCQkJCS8vIGNyZWRpdHMgdG8gQW5kcmV3IER1cG9udAoJCQkJdmFyIGN1cnJlbnRJZCA9IF9jb250ZXh0LmdldEF0dHJpYnV0ZSgnaWQnKSwgc2xpY2tpZCA9ICdzbGlja2lkX18nOwoJCQkJX2NvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIHNsaWNraWQpOwoJCQkJX2V4cHJlc3Npb24gPSAnIycgKyBzbGlja2lkICsgJyAnICsgX2V4cHJlc3Npb247CgkJCQljb250ZXh0ID0gX2NvbnRleHQucGFyZW50Tm9kZTsKCQkJfQoKCQkJdHJ5IHsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvcihfZXhwcmVzc2lvbikgfHwgbnVsbDsKCQkJCWVsc2Ugbm9kZXMgPSBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoX2V4cHJlc3Npb24pOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXSA9IDE7CgkJCQlicmVhayBxdWVyeVNlbGVjdG9yOwoJCQl9IGZpbmFsbHkgewoJCQkJaWYgKCFjb250ZXh0SXNEb2N1bWVudCl7CgkJCQkJaWYgKGN1cnJlbnRJZCkgX2NvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIGN1cnJlbnRJZCk7CgkJCQkJZWxzZSBfY29udGV4dC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCQkJY29udGV4dCA9IF9jb250ZXh0OwoJCQkJfQoJCQl9CgoJCQlpZiAodGhpcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSkgZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCWlmIChub2RlLm5vZGVOYW1lID4gJ0AnICYmICEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gZm91bmQ7CgoJCX0KCQkvKjwvcXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCgkJcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShleHByZXNzaW9uKTsKCQlpZiAoIXBhcnNlZC5sZW5ndGgpIHJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbiA9PSBudWxsKXsgLy8gdGhlcmUgaXMgbm8gZXhwcmVzc2lvbgoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbi5TbGljayl7IC8vIGV4cHJlc3Npb24gaXMgYSBwYXJzZWQgU2xpY2sgb2JqZWN0CgkJcGFyc2VkID0gZXhwcmVzc2lvbjsKCX0gZWxzZSBpZiAodGhpcy5jb250YWlucyhjb250ZXh0LmRvY3VtZW50RWxlbWVudCB8fCBjb250ZXh0LCBleHByZXNzaW9uKSl7IC8vIGV4cHJlc3Npb24gaXMgYSBub2RlCgkJKGZvdW5kKSA/IGZvdW5kLnB1c2goZXhwcmVzc2lvbikgOiBmb3VuZCA9IGV4cHJlc3Npb247CgkJcmV0dXJuIGZvdW5kOwoJfSBlbHNlIHsgLy8gb3RoZXIganVuawoJCXJldHVybiBmb3VuZDsKCX0KCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjYWNoZSBlbGVtZW50cyBmb3IgdGhlIG50aCBzZWxlY3RvcnMKCgl0aGlzLnBvc05USCA9IHt9OwoJdGhpcy5wb3NOVEhMYXN0ID0ge307Cgl0aGlzLnBvc05USFR5cGUgPSB7fTsKCXRoaXMucG9zTlRIVHlwZUxhc3QgPSB7fTsKCgkvKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8vKjwvcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGlmIGFwcGVuZCBpcyBudWxsIGFuZCB0aGVyZSBpcyBvbmx5IGEgc2luZ2xlIHNlbGVjdG9yIHdpdGggb25lIGV4cHJlc3Npb24gdXNlIHB1c2hBcnJheSwgZWxzZSB1c2UgcHVzaFVJRAoJdGhpcy5wdXNoID0gKCFoYXNPdGhlcnMgJiYgKGZpcnN0IHx8IChwYXJzZWQubGVuZ3RoID09IDEgJiYgcGFyc2VkLmV4cHJlc3Npb25zWzBdLmxlbmd0aCA9PSAxKSkpID8gdGhpcy5wdXNoQXJyYXkgOiB0aGlzLnB1c2hVSUQ7CgoJaWYgKGZvdW5kID09IG51bGwpIGZvdW5kID0gW107CgoJLy8gZGVmYXVsdCBlbmdpbmUKCgl2YXIgaiwgbSwgbjsKCXZhciBjb21iaW5hdG9yLCB0YWcsIGlkLCBjbGFzc0xpc3QsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3M7Cgl2YXIgY3VycmVudEl0ZW1zLCBjdXJyZW50RXhwcmVzc2lvbiwgY3VycmVudEJpdCwgbGFzdEJpdCwgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnM7CgoJc2VhcmNoOiBmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKykgZm9yIChqID0gMDsgKGN1cnJlbnRCaXQgPSBjdXJyZW50RXhwcmVzc2lvbltqXSk7IGorKyl7CgoJCWNvbWJpbmF0b3IgPSAnY29tYmluYXRvcjonICsgY3VycmVudEJpdC5jb21iaW5hdG9yOwoJCWlmICghdGhpc1tjb21iaW5hdG9yXSkgY29udGludWUgc2VhcmNoOwoKCQl0YWcgICAgICAgID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBjdXJyZW50Qml0LnRhZyA6IGN1cnJlbnRCaXQudGFnLnRvVXBwZXJDYXNlKCk7CgkJaWQgICAgICAgICA9IGN1cnJlbnRCaXQuaWQ7CgkJY2xhc3NMaXN0ICA9IGN1cnJlbnRCaXQuY2xhc3NMaXN0OwoJCWNsYXNzZXMgICAgPSBjdXJyZW50Qml0LmNsYXNzZXM7CgkJYXR0cmlidXRlcyA9IGN1cnJlbnRCaXQuYXR0cmlidXRlczsKCQlwc2V1ZG9zICAgID0gY3VycmVudEJpdC5wc2V1ZG9zOwoJCWxhc3RCaXQgICAgPSAoaiA9PT0gKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCAtIDEpKTsKCgkJdGhpcy5iaXRVbmlxdWVzID0ge307CgoJCWlmIChsYXN0Qml0KXsKCQkJdGhpcy51bmlxdWVzID0gdW5pcXVlczsKCQkJdGhpcy5mb3VuZCA9IGZvdW5kOwoJCX0gZWxzZSB7CgkJCXRoaXMudW5pcXVlcyA9IHt9OwoJCQl0aGlzLmZvdW5kID0gW107CgkJfQoKCQlpZiAoaiA9PT0gMCl7CgkJCXRoaXNbY29tYmluYXRvcl0oY29udGV4dCwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQgJiYgZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJfSBlbHNlIHsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQpIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKXsKCQkJCXRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQkJaWYgKGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCQl9IGVsc2UgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspIHRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCX0KCgkJY3VycmVudEl0ZW1zID0gdGhpcy5mb3VuZDsKCX0KCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCWlmIChoYXNPdGhlcnMgfHwgKHBhcnNlZC5leHByZXNzaW9ucy5sZW5ndGggPiAxKSkgdGhpcy5zb3J0KGZvdW5kKTsKCglyZXR1cm4gKGZpcnN0KSA/IChmb3VuZFswXSB8fCBudWxsKSA6IGZvdW5kOwp9OwoKLy8gVXRpbHMKCmxvY2FsLnVpZHggPSAxOwpsb2NhbC51aWRrID0gJ3NsaWNrLXVuaXF1ZWlkJzsKCmxvY2FsLmdldFVJRFhNTCA9IGZ1bmN0aW9uKG5vZGUpewoJdmFyIHVpZCA9IG5vZGUuZ2V0QXR0cmlidXRlKHRoaXMudWlkayk7CglpZiAoIXVpZCl7CgkJdWlkID0gdGhpcy51aWR4Kys7CgkJbm9kZS5zZXRBdHRyaWJ1dGUodGhpcy51aWRrLCB1aWQpOwoJfQoJcmV0dXJuIHVpZDsKfTsKCmxvY2FsLmdldFVJREhUTUwgPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiBub2RlLnVuaXF1ZU51bWJlciB8fCAobm9kZS51bmlxdWVOdW1iZXIgPSB0aGlzLnVpZHgrKyk7Cn07CgovLyBzb3J0IGJhc2VkIG9uIHRoZSBzZXREb2N1bWVudCBkb2N1bWVudFNvcnRlciBtZXRob2QuCgpsb2NhbC5zb3J0ID0gZnVuY3Rpb24ocmVzdWx0cyl7CglpZiAoIXRoaXMuZG9jdW1lbnRTb3J0ZXIpIHJldHVybiByZXN1bHRzOwoJcmVzdWx0cy5zb3J0KHRoaXMuZG9jdW1lbnRTb3J0ZXIpOwoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLmNhY2hlTlRIID0ge307Cgpsb2NhbC5tYXRjaE5USCA9IC9eKFsrLV0/XGQqKT8oW2Etel0rKT8oWystXVxkKyk/JC87Cgpsb2NhbC5wYXJzZU5USEFyZ3VtZW50ID0gZnVuY3Rpb24oYXJndW1lbnQpewoJdmFyIHBhcnNlZCA9IGFyZ3VtZW50Lm1hdGNoKHRoaXMubWF0Y2hOVEgpOwoJaWYgKCFwYXJzZWQpIHJldHVybiBmYWxzZTsKCXZhciBzcGVjaWFsID0gcGFyc2VkWzJdIHx8IGZhbHNlOwoJdmFyIGEgPSBwYXJzZWRbMV0gfHwgMTsKCWlmIChhID09ICctJykgYSA9IC0xOwoJdmFyIGIgPSArcGFyc2VkWzNdIHx8IDA7CglwYXJzZWQgPQoJCShzcGVjaWFsID09ICduJykJPyB7YTogYSwgYjogYn0gOgoJCShzcGVjaWFsID09ICdvZGQnKQk/IHthOiAyLCBiOiAxfSA6CgkJKHNwZWNpYWwgPT0gJ2V2ZW4nKQk/IHthOiAyLCBiOiAwfSA6IHthOiAwLCBiOiBhfTsKCglyZXR1cm4gKHRoaXMuY2FjaGVOVEhbYXJndW1lbnRdID0gcGFyc2VkKTsKfTsKCmxvY2FsLmNyZWF0ZU5USFBzZXVkbyA9IGZ1bmN0aW9uKGNoaWxkLCBzaWJsaW5nLCBwb3NpdGlvbnMsIG9mVHlwZSl7CglyZXR1cm4gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQlpZiAoIXRoaXNbcG9zaXRpb25zXVt1aWRdKXsKCQkJdmFyIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKCQkJaWYgKCFwYXJlbnQpIHJldHVybiBmYWxzZTsKCQkJdmFyIGVsID0gcGFyZW50W2NoaWxkXSwgY291bnQgPSAxOwoJCQlpZiAob2ZUeXBlKXsKCQkJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVOYW1lICE9IG5vZGVOYW1lKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9IGVsc2UgewoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAodGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvcil7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwobm9kZSwgc2VsZWN0b3IucmVwbGFjZSgvXFsoW149XSspPVxzKihbXiciXF1dKz8pXHMqXF0vZywgJ1skMT0iJDIiXScpKTsKCQl9IGNhdGNoKG1hdGNoRXJyb3IpIHt9Cgl9CgoJdmFyIHBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2Uoc2VsZWN0b3IpOwoJaWYgKCFwYXJzZWQpIHJldHVybiB0cnVlOwoKCS8vIHNpbXBsZSAoc2luZ2xlKSBzZWxlY3RvcnMKCXZhciBleHByZXNzaW9ucyA9IHBhcnNlZC5leHByZXNzaW9ucywgc2ltcGxlRXhwQ291bnRlciA9IDAsIGk7Cglmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKyl7CgkJaWYgKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCA9PSAxKXsKCQkJdmFyIGV4cCA9IGN1cnJlbnRFeHByZXNzaW9uWzBdOwoJCQlpZiAodGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gZXhwLnRhZyA6IGV4cC50YWcudG9VcHBlckNhc2UoKSwgZXhwLmlkLCBleHAuY2xhc3NlcywgZXhwLmF0dHJpYnV0ZXMsIGV4cC5wc2V1ZG9zKSkgcmV0dXJuIHRydWU7CgkJCXNpbXBsZUV4cENvdW50ZXIrKzsKCQl9Cgl9CgoJaWYgKHNpbXBsZUV4cENvdW50ZXIgPT0gcGFyc2VkLmxlbmd0aCkgcmV0dXJuIGZhbHNlOwoKCXZhciBub2RlcyA9IHRoaXMuc2VhcmNoKHRoaXMuZG9jdW1lbnQsIHBhcnNlZCksIGl0ZW07Cglmb3IgKGkgPSAwOyBpdGVtID0gbm9kZXNbaSsrXTspewoJCWlmIChpdGVtID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCX0KCXJldHVybiBmYWxzZTsKfTsKCmxvY2FsLm1hdGNoUHNldWRvID0gZnVuY3Rpb24obm9kZSwgbmFtZSwgYXJndW1lbnQpewoJdmFyIHBzZXVkb05hbWUgPSAncHNldWRvOicgKyBuYW1lOwoJaWYgKHRoaXNbcHNldWRvTmFtZV0pIHJldHVybiB0aGlzW3BzZXVkb05hbWVdKG5vZGUsIGFyZ3VtZW50KTsKCXZhciBhdHRyaWJ1dGUgPSB0aGlzLmdldEF0dHJpYnV0ZShub2RlLCBuYW1lKTsKCXJldHVybiAoYXJndW1lbnQpID8gYXJndW1lbnQgPT0gYXR0cmlidXRlIDogISFhdHRyaWJ1dGU7Cn07Cgpsb2NhbC5tYXRjaFNlbGVjdG9yID0gZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7CglpZiAodGFnKXsKCQl2YXIgbm9kZU5hbWUgPSAodGhpcy5pc1hNTERvY3VtZW50KSA/IG5vZGUubm9kZU5hbWUgOiBub2RlLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCk7CgkJaWYgKHRhZyA9PSAnKicpewoJCQlpZiAobm9kZU5hbWUgPCAnQCcpIHJldHVybiBmYWxzZTsgLy8gRml4IGZvciBjb21tZW50IG5vZGVzIGFuZCBjbG9zZWQgbm9kZXMKCQl9IGVsc2UgewoJCQlpZiAobm9kZU5hbWUgIT0gdGFnKSByZXR1cm4gZmFsc2U7CgkJfQoJfQoKCWlmIChpZCAmJiBub2RlLmdldEF0dHJpYnV0ZSgnaWQnKSAhPSBpZCkgcmV0dXJuIGZhbHNlOwoKCXZhciBpLCBwYXJ0LCBjbHM7CglpZiAoY2xhc3NlcykgZm9yIChpID0gY2xhc3Nlcy5sZW5ndGg7IGktLTspewoJCWNscyA9IHRoaXMuZ2V0QXR0cmlidXRlKG5vZGUsICdjbGFzcycpOwoJCWlmICghKGNscyAmJiBjbGFzc2VzW2ldLnJlZ2V4cC50ZXN0KGNscykpKSByZXR1cm4gZmFsc2U7Cgl9CglpZiAoYXR0cmlidXRlcykgZm9yIChpID0gYXR0cmlidXRlcy5sZW5ndGg7IGktLTspewoJCXBhcnQgPSBhdHRyaWJ1dGVzW2ldOwoJCWlmIChwYXJ0Lm9wZXJhdG9yID8gIXBhcnQudGVzdCh0aGlzLmdldEF0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIDogIXRoaXMuaGFzQXR0cmlidXRlKG5vZGUsIHBhcnQua2V5KSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKHBzZXVkb3MpIGZvciAoaSA9IHBzZXVkb3MubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gcHNldWRvc1tpXTsKCQlpZiAoIXRoaXMubWF0Y2hQc2V1ZG8obm9kZSwgcGFydC5rZXksIHBhcnQudmFsdWUpKSByZXR1cm4gZmFsc2U7Cgl9CglyZXR1cm4gdHJ1ZTsKfTsKCnZhciBjb21iaW5hdG9ycyA9IHsKCgknICc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCl7IC8vIGFsbCBjaGlsZCBub2RlcywgYW55IGxldmVsCgoJCXZhciBpLCBpdGVtLCBjaGlsZHJlbjsKCgkJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQpewoJCQlnZXRCeUlkOiBpZiAoaWQpewoJCQkJaXRlbSA9IHRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJCQkJaWYgKCghaXRlbSAmJiBub2RlLmFsbCkgfHwgKHRoaXMuaWRHZXRzTmFtZSAmJiBpdGVtICYmIGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgIT0gaWQpKXsKCQkJCQkvLyBhbGxbaWRdIHJldHVybnMgYWxsIHRoZSBlbGVtZW50cyB3aXRoIHRoYXQgbmFtZSBvciBpZCBpbnNpZGUgbm9kZQoJCQkJCS8vIGlmIHRoZXJlcyBqdXN0IG9uZSBpdCB3aWxsIHJldHVybiB0aGUgZWxlbWVudCwgZWxzZSBpdCB3aWxsIGJlIGEgY29sbGVjdGlvbgoJCQkJCWNoaWxkcmVuID0gbm9kZS5hbGxbaWRdOwoJCQkJCWlmICghY2hpbGRyZW4pIHJldHVybjsKCQkJCQlpZiAoIWNoaWxkcmVuWzBdKSBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CgkJCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KXsKCQkJCQkJdmFyIGlkTm9kZSA9IGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKTsKCQkJCQkJaWYgKGlkTm9kZSAmJiBpZE5vZGUubm9kZVZhbHVlID09IGlkKXsKCQkJCQkJCXRoaXMucHVzaChpdGVtLCB0YWcsIG51bGwsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFpdGVtKXsKCQkJCQkvLyBpZiB0aGUgY29udGV4dCBpcyBpbiB0aGUgZG9tIHdlIHJldHVybiwgZWxzZSB3ZSB3aWxsIHRyeSBHRUJUTiwgYnJlYWtpbmcgdGhlIGdldEJ5SWQgbGFiZWwKCQkJCQlpZiAodGhpcy5jb250YWlucyh0aGlzLnJvb3QsIG5vZGUpKSByZXR1cm47CgkJCQkJZWxzZSBicmVhayBnZXRCeUlkOwoJCQkJfSBlbHNlIGlmICh0aGlzLmRvY3VtZW50ICE9PSBub2RlICYmICF0aGlzLmNvbnRhaW5zKG5vZGUsIGl0ZW0pKSByZXR1cm47CgkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCXJldHVybjsKCQkJfQoJCQlnZXRCeUNsYXNzOiBpZiAoY2xhc3NlcyAmJiBub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgIXRoaXMuYnJva2VuR0VCQ04pewoJCQkJY2hpbGRyZW4gPSBub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NMaXN0LmpvaW4oJyAnKSk7CgkJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeUNsYXNzOwoJCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgbnVsbCwgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJZ2V0QnlUYWc6IHsKCQkJY2hpbGRyZW4gPSBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CgkJCWlmICghKGNoaWxkcmVuICYmIGNoaWxkcmVuLmxlbmd0aCkpIGJyZWFrIGdldEJ5VGFnOwoJCQlpZiAoIXRoaXMuYnJva2VuU3RhckdFQlROKSB0YWcgPSBudWxsOwoJCQlmb3IgKGkgPSAwOyBpdGVtID0gY2hpbGRyZW5baSsrXTspIHRoaXMucHVzaChpdGVtLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSc+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGRpcmVjdCBjaGlsZHJlbgoJCWlmICgobm9kZSA9IG5vZGUuZmlyc3RDaGlsZCkpIGRvIHsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0gd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpOwoJfSwKCgknKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmcKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBmaXJzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWVsc2UgdGhpc1snY29tYmluYXRvcjorJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmdzCgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpewoJCQlpZiAobm9kZS5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCScrKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmcgYW5kIHByZXZpb3VzIHNpYmxpbmcKCQl0aGlzWydjb21iaW5hdG9yOisnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl0aGlzWydjb21iaW5hdG9yOiErJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSd+fic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmdzIGFuZCBwcmV2aW91cyBzaWJsaW5ncwoJCXRoaXNbJ2NvbWJpbmF0b3I6fiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6IX4nXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyEnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gYWxsIHBhcmVudCBub2RlcyB1cCB0byBkb2N1bWVudAoJCXdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpIGlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgcGFyZW50IChvbmUgbGV2ZWwpCgkJbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCQlpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISsnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknIV4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbGFzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmxhc3RDaGlsZDsKCQlpZiAobm9kZSl7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJZWxzZSB0aGlzWydjb21iaW5hdG9yOiErJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknIX4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZ3MKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpewoJCQlpZiAobm9kZS5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9Cgp9OwoKZm9yICh2YXIgYyBpbiBjb21iaW5hdG9ycykgbG9jYWxbJ2NvbWJpbmF0b3I6JyArIGNdID0gY29tYmluYXRvcnNbY107Cgp2YXIgcHNldWRvcyA9IHsKCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2VtcHR5JzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIGNoaWxkID0gbm9kZS5maXJzdENoaWxkOwoJCXJldHVybiAhKGNoaWxkICYmIGNoaWxkLm5vZGVUeXBlID09IDEpICYmICEobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykubGVuZ3RoOwoJfSwKCgknbm90JzogZnVuY3Rpb24obm9kZSwgZXhwcmVzc2lvbil7CgkJcmV0dXJuICF0aGlzLm1hdGNoTm9kZShub2RlLCBleHByZXNzaW9uKTsKCX0sCgoJJ2NvbnRhaW5zJzogZnVuY3Rpb24obm9kZSwgdGV4dCl7CgkJcmV0dXJuIChub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5pbmRleE9mKHRleHQpID4gLTE7Cgl9LAoKCSdmaXJzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LWNoaWxkJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIHByZXYgPSBub2RlOwoJCXdoaWxlICgocHJldiA9IHByZXYucHJldmlvdXNTaWJsaW5nKSkgaWYgKHByZXYubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgkvKjxudGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdudGgtY2hpbGQnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2ZpcnN0Q2hpbGQnLCAnbmV4dFNpYmxpbmcnLCAncG9zTlRIJyksCgoJJ250aC1sYXN0LWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdsYXN0Q2hpbGQnLCAncHJldmlvdXNTaWJsaW5nJywgJ3Bvc05USExhc3QnKSwKCgknbnRoLW9mLXR5cGUnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2ZpcnN0Q2hpbGQnLCAnbmV4dFNpYmxpbmcnLCAncG9zTlRIVHlwZScsIHRydWUpLAoKCSdudGgtbGFzdC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdsYXN0Q2hpbGQnLCAncHJldmlvdXNTaWJsaW5nJywgJ3Bvc05USFR5cGVMYXN0JywgdHJ1ZSksCgoJJ2luZGV4JzogZnVuY3Rpb24obm9kZSwgaW5kZXgpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJycgKyAoaW5kZXggKyAxKSk7Cgl9LAoKCSdldmVuJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4nKTsKCX0sCgoJJ29kZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJzJuKzEnKTsKCX0sCgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLyo8b2YtdHlwZS1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2ZpcnN0LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3Qtb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGUsIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJdmFyIG5leHQgPSBub2RlOwoJCXdoaWxlICgobmV4dCA9IG5leHQubmV4dFNpYmxpbmcpKSBpZiAobmV4dC5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgkvKjwvb2YtdHlwZS1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLy8gY3VzdG9tIHBzZXVkb3MKCgknZW5hYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAhbm9kZS5kaXNhYmxlZDsKCX0sCgoJJ2Rpc2FibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuZGlzYWJsZWQ7Cgl9LAoKCSdjaGVja2VkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuY2hlY2tlZCB8fCBub2RlLnNlbGVjdGVkOwoJfSwKCgknZm9jdXMnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IG5vZGUgJiYgKG5vZGUuaHJlZiB8fCBub2RlLnR5cGUgfHwgdGhpcy5oYXNBdHRyaWJ1dGUobm9kZSwgJ3RhYmluZGV4JykpOwoJfSwKCgkncm9vdCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZSA9PT0gdGhpcy5yb290KTsKCX0sCgoJJ3NlbGVjdGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuc2VsZWN0ZWQ7Cgl9CgoJLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KfTsKCmZvciAodmFyIHAgaW4gcHNldWRvcykgbG9jYWxbJ3BzZXVkbzonICsgcF0gPSBwc2V1ZG9zW3BdOwoKLy8gYXR0cmlidXRlcyBtZXRob2RzCgp2YXIgYXR0cmlidXRlR2V0dGVycyA9IGxvY2FsLmF0dHJpYnV0ZUdldHRlcnMgPSB7CgoJJ2Zvcic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHRtbEZvcicgaW4gdGhpcykgPyB0aGlzLmh0bWxGb3IgOiB0aGlzLmdldEF0dHJpYnV0ZSgnZm9yJyk7Cgl9LAoKCSdocmVmJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdocmVmJyBpbiB0aGlzKSA/IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJywgMikgOiB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5zdHlsZSkgPyB0aGlzLnN0eWxlLmNzc1RleHQgOiB0aGlzLmdldEF0dHJpYnV0ZSgnc3R5bGUnKTsKCX0sCgoJJ3RhYmluZGV4JzogZnVuY3Rpb24oKXsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgndGFiaW5kZXgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSwKCgkndHlwZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0QXR0cmlidXRlKCd0eXBlJyk7Cgl9LAoKCSdtYXhsZW5ndGgnOiBmdW5jdGlvbigpewoJCXZhciBhdHRyaWJ1dGVOb2RlID0gdGhpcy5nZXRBdHRyaWJ1dGVOb2RlKCdtYXhMZW5ndGgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfQoKfTsKCmF0dHJpYnV0ZUdldHRlcnMuTUFYTEVOR1RIID0gYXR0cmlidXRlR2V0dGVycy5tYXhMZW5ndGggPSBhdHRyaWJ1dGVHZXR0ZXJzLm1heGxlbmd0aDsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMS4xLjcnOwoKLy8gU2xpY2sgZmluZGVyCgpTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwp9OwoKU2xpY2suZmluZCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24pewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBudWxsLCB0cnVlKTsKfTsKCi8vIFNsaWNrIGNvbnRhaW5tZW50IGNoZWNrZXIKClNsaWNrLmNvbnRhaW5zID0gZnVuY3Rpb24oY29udGFpbmVyLCBub2RlKXsKCWxvY2FsLnNldERvY3VtZW50KGNvbnRhaW5lcik7CglyZXR1cm4gbG9jYWwuY29udGFpbnMoY29udGFpbmVyLCBub2RlKTsKfTsKCi8vIFNsaWNrIGF0dHJpYnV0ZSBnZXR0ZXIKClNsaWNrLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJbG9jYWwuc2V0RG9jdW1lbnQobm9kZSk7CglyZXR1cm4gbG9jYWwuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwp9OwoKU2xpY2suaGFzQXR0cmlidXRlID0gZnVuY3Rpb24obm9kZSwgbmFtZSl7Cglsb2NhbC5zZXREb2N1bWVudChub2RlKTsKCXJldHVybiBsb2NhbC5oYXNBdHRyaWJ1dGUobm9kZSwgbmFtZSk7Cn07CgovLyBTbGljayBtYXRjaGVyCgpTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCWlmICghKG5vZGUgJiYgc2VsZWN0b3IpKSByZXR1cm4gZmFsc2U7CglpZiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCWxvY2FsLnNldERvY3VtZW50KG5vZGUpOwoJcmV0dXJuIGxvY2FsLm1hdGNoTm9kZShub2RlLCBzZWxlY3Rvcik7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgYWNjZXNzb3IKClNsaWNrLmRlZmluZUF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV0gPSBmbjsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSl7CglyZXR1cm4gbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKfTsKCi8vIFNsaWNrIHBzZXVkbyBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lUHNldWRvID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWxbJ3BzZXVkbzonICsgbmFtZV0gPSBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIGZuLmNhbGwobm9kZSwgYXJndW1lbnQpOwoJfTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwUHNldWRvID0gZnVuY3Rpb24obmFtZSl7Cgl2YXIgcHNldWRvID0gbG9jYWxbJ3BzZXVkbzonICsgbmFtZV07CglpZiAocHNldWRvKSByZXR1cm4gZnVuY3Rpb24oYXJndW1lbnQpewoJCXJldHVybiBwc2V1ZG8uY2FsbCh0aGlzLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIG51bGw7Cn07CgovLyBTbGljayBvdmVycmlkZXMgYWNjZXNzb3IKClNsaWNrLm92ZXJyaWRlID0gZnVuY3Rpb24ocmVnZXhwLCBmbil7Cglsb2NhbC5vdmVycmlkZShyZWdleHAsIGZuKTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2suaXNYTUwgPSBsb2NhbC5pc1hNTDsKClNsaWNrLnVpZE9mID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbG9jYWwuZ2V0VUlESFRNTChub2RlKTsKfTsKCmlmICghdGhpcy5TbGljaykgdGhpcy5TbGljayA9IFNsaWNrOwoKfSkuYXBwbHkoLyo8Q29tbW9uSlM+Ki8odHlwZW9mIGV4cG9ydHMgIT0gJ3VuZGVmaW5lZCcpID8gZXhwb3J0cyA6IC8qPC9Db21tb25KUz4qL3RoaXMpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudAoKZGVzY3JpcHRpb246IE9uZSBvZiB0aGUgbW9zdCBpbXBvcnRhbnQgaXRlbXMgaW4gTW9vVG9vbHMuIENvbnRhaW5zIHRoZSBkb2xsYXIgZnVuY3Rpb24sIHRoZSBkb2xsYXJzIGZ1bmN0aW9uLCBhbmQgYW4gaGFuZGZ1bCBvZiBjcm9zcy1icm93c2VyLCB0aW1lLXNhdmVyIG1ldGhvZHMgdG8gbGV0IHlvdSBlYXNpbHkgd29yayB3aXRoIEhUTUwgRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE9iamVjdCwgTnVtYmVyLCBTbGljay5QYXJzZXIsIFNsaWNrLkZpbmRlcl0KCnByb3ZpZGVzOiBbRWxlbWVudCwgRWxlbWVudHMsICQsICQkLCBJZnJhbWUsIFNlbGVjdG9yc10KCi4uLgoqLwoKdmFyIEVsZW1lbnQgPSBmdW5jdGlvbih0YWcsIHByb3BzKXsKCXZhciBrb25zdHJ1Y3RvciA9IEVsZW1lbnQuQ29uc3RydWN0b3JzW3RhZ107CglpZiAoa29uc3RydWN0b3IpIHJldHVybiBrb25zdHJ1Y3Rvcihwcm9wcyk7CglpZiAodHlwZW9mIHRhZyAhPSAnc3RyaW5nJykgcmV0dXJuIGRvY3VtZW50LmlkKHRhZykuc2V0KHByb3BzKTsKCglpZiAoIXByb3BzKSBwcm9wcyA9IHt9OwoKCWlmICghKC9eW1x3LV0rJC8pLnRlc3QodGFnKSl7CgkJdmFyIHBhcnNlZCA9IFNsaWNrLnBhcnNlKHRhZykuZXhwcmVzc2lvbnNbMF1bMF07CgkJdGFnID0gKHBhcnNlZC50YWcgPT0gJyonKSA/ICdkaXYnIDogcGFyc2VkLnRhZzsKCQlpZiAocGFyc2VkLmlkICYmIHByb3BzLmlkID09IG51bGwpIHByb3BzLmlkID0gcGFyc2VkLmlkOwoKCQl2YXIgYXR0cmlidXRlcyA9IHBhcnNlZC5hdHRyaWJ1dGVzOwoJCWlmIChhdHRyaWJ1dGVzKSBmb3IgKHZhciBhdHRyLCBpID0gMCwgbCA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJYXR0ciA9IGF0dHJpYnV0ZXNbaV07CgkJCWlmIChwcm9wc1thdHRyLmtleV0gIT0gbnVsbCkgY29udGludWU7CgoJCQlpZiAoYXR0ci52YWx1ZSAhPSBudWxsICYmIGF0dHIub3BlcmF0b3IgPT0gJz0nKSBwcm9wc1thdHRyLmtleV0gPSBhdHRyLnZhbHVlOwoJCQllbHNlIGlmICghYXR0ci52YWx1ZSAmJiAhYXR0ci5vcGVyYXRvcikgcHJvcHNbYXR0ci5rZXldID0gdHJ1ZTsKCQl9CgoJCWlmIChwYXJzZWQuY2xhc3NMaXN0ICYmIHByb3BzWydjbGFzcyddID09IG51bGwpIHByb3BzWydjbGFzcyddID0gcGFyc2VkLmNsYXNzTGlzdC5qb2luKCcgJyk7Cgl9CgoJcmV0dXJuIGRvY3VtZW50Lm5ld0VsZW1lbnQodGFnLCBwcm9wcyk7Cn07CgoKaWYgKEJyb3dzZXIuRWxlbWVudCl7CglFbGVtZW50LnByb3RvdHlwZSA9IEJyb3dzZXIuRWxlbWVudC5wcm90b3R5cGU7CgkvLyBJRTggYW5kIElFOSByZXF1aXJlIHRoZSB3cmFwcGluZy4KCUVsZW1lbnQucHJvdG90eXBlLl9maXJlRXZlbnQgPSAoZnVuY3Rpb24oZmlyZUV2ZW50KXsKCQlyZXR1cm4gZnVuY3Rpb24odHlwZSwgZXZlbnQpewoJCQlyZXR1cm4gZmlyZUV2ZW50LmNhbGwodGhpcywgdHlwZSwgZXZlbnQpOwoJCX07Cgl9KShFbGVtZW50LnByb3RvdHlwZS5maXJlRXZlbnQpOwp9CgpuZXcgVHlwZSgnRWxlbWVudCcsIEVsZW1lbnQpLm1pcnJvcihmdW5jdGlvbihuYW1lKXsKCWlmIChBcnJheS5wcm90b3R5cGVbbmFtZV0pIHJldHVybjsKCgl2YXIgb2JqID0ge307CglvYmpbbmFtZV0gPSBmdW5jdGlvbigpewoJCXZhciByZXN1bHRzID0gW10sIGFyZ3MgPSBhcmd1bWVudHMsIGVsZW1lbnRzID0gdHJ1ZTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSB0aGlzW2ldLCByZXN1bHQgPSByZXN1bHRzW2ldID0gZWxlbWVudFtuYW1lXS5hcHBseShlbGVtZW50LCBhcmdzKTsKCQkJZWxlbWVudHMgPSAoZWxlbWVudHMgJiYgdHlwZU9mKHJlc3VsdCkgPT0gJ2VsZW1lbnQnKTsKCQl9CgkJcmV0dXJuIChlbGVtZW50cykgPyBuZXcgRWxlbWVudHMocmVzdWx0cykgOiByZXN1bHRzOwoJfTsKCglFbGVtZW50cy5pbXBsZW1lbnQob2JqKTsKfSk7CgppZiAoIUJyb3dzZXIuRWxlbWVudCl7CglFbGVtZW50LnBhcmVudCA9IE9iamVjdDsKCglFbGVtZW50LlByb3RvdHlwZSA9IHsKCQknJGNvbnN0cnVjdG9yJzogRWxlbWVudCwKCQknJGZhbWlseSc6IEZ1bmN0aW9uLmZyb20oJ2VsZW1lbnQnKS5oaWRlKCkKCX07CgoJRWxlbWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCQlFbGVtZW50LlByb3RvdHlwZVtuYW1lXSA9IG1ldGhvZDsKCX0pOwp9CgpFbGVtZW50LkNvbnN0cnVjdG9ycyA9IHt9OwoKCgp2YXIgSUZyYW1lID0gbmV3IFR5cGUoJ0lGcmFtZScsIGZ1bmN0aW9uKCl7Cgl2YXIgcGFyYW1zID0gQXJyYXkubGluayhhcmd1bWVudHMsIHsKCQlwcm9wZXJ0aWVzOiBUeXBlLmlzT2JqZWN0LAoJCWlmcmFtZTogZnVuY3Rpb24ob2JqKXsKCQkJcmV0dXJuIChvYmogIT0gbnVsbCk7CgkJfQoJfSk7CgoJdmFyIHByb3BzID0gcGFyYW1zLnByb3BlcnRpZXMgfHwge30sIGlmcmFtZTsKCWlmIChwYXJhbXMuaWZyYW1lKSBpZnJhbWUgPSBkb2N1bWVudC5pZChwYXJhbXMuaWZyYW1lKTsKCXZhciBvbmxvYWQgPSBwcm9wcy5vbmxvYWQgfHwgZnVuY3Rpb24oKXt9OwoJZGVsZXRlIHByb3BzLm9ubG9hZDsKCXByb3BzLmlkID0gcHJvcHMubmFtZSA9IFtwcm9wcy5pZCwgcHJvcHMubmFtZSwgaWZyYW1lID8gKGlmcmFtZS5pZCB8fCBpZnJhbWUubmFtZSkgOiAnSUZyYW1lXycgKyBTdHJpbmcudW5pcXVlSUQoKV0ucGljaygpOwoJaWZyYW1lID0gbmV3IEVsZW1lbnQoaWZyYW1lIHx8ICdpZnJhbWUnLCBwcm9wcyk7CgoJdmFyIG9uTG9hZCA9IGZ1bmN0aW9uKCl7CgkJb25sb2FkLmNhbGwoaWZyYW1lLmNvbnRlbnRXaW5kb3cpOwoJfTsKCglpZiAod2luZG93LmZyYW1lc1twcm9wcy5pZF0pIG9uTG9hZCgpOwoJZWxzZSBpZnJhbWUuYWRkTGlzdGVuZXIoJ2xvYWQnLCBvbkxvYWQpOwoJcmV0dXJuIGlmcmFtZTsKfSk7Cgp2YXIgRWxlbWVudHMgPSB0aGlzLkVsZW1lbnRzID0gZnVuY3Rpb24obm9kZXMpewoJaWYgKG5vZGVzICYmIG5vZGVzLmxlbmd0aCl7CgkJdmFyIHVuaXF1ZXMgPSB7fSwgbm9kZTsKCQlmb3IgKHZhciBpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJdmFyIHVpZCA9IFNsaWNrLnVpZE9mKG5vZGUpOwoJCQlpZiAoIXVuaXF1ZXNbdWlkXSl7CgkJCQl1bmlxdWVzW3VpZF0gPSB0cnVlOwoJCQkJdGhpcy5wdXNoKG5vZGUpOwoJCQl9CgkJfQoJfQp9OwoKRWxlbWVudHMucHJvdG90eXBlID0ge2xlbmd0aDogMH07CkVsZW1lbnRzLnBhcmVudCA9IEFycmF5OwoKbmV3IFR5cGUoJ0VsZW1lbnRzJywgRWxlbWVudHMpLmltcGxlbWVudCh7CgoJZmlsdGVyOiBmdW5jdGlvbihmaWx0ZXIsIGJpbmQpewoJCWlmICghZmlsdGVyKSByZXR1cm4gdGhpczsKCQlyZXR1cm4gbmV3IEVsZW1lbnRzKEFycmF5LmZpbHRlcih0aGlzLCAodHlwZU9mKGZpbHRlcikgPT0gJ3N0cmluZycpID8gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtLm1hdGNoKGZpbHRlcik7CgkJfSA6IGZpbHRlciwgYmluZCkpOwoJfS5wcm90ZWN0KCksCgoJcHVzaDogZnVuY3Rpb24oKXsKCQl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5pZChhcmd1bWVudHNbaV0pOwoJCQlpZiAoaXRlbSkgdGhpc1tsZW5ndGgrK10gPSBpdGVtOwoJCX0KCQlyZXR1cm4gKHRoaXMubGVuZ3RoID0gbGVuZ3RoKTsKCX0ucHJvdGVjdCgpLAoKCXVuc2hpZnQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGl0ZW1zID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5pZChhcmd1bWVudHNbaV0pOwoJCQlpZiAoaXRlbSkgaXRlbXMucHVzaChpdGVtKTsKCQl9CgkJcmV0dXJuIEFycmF5LnByb3RvdHlwZS51bnNoaWZ0LmFwcGx5KHRoaXMsIGl0ZW1zKTsKCX0ucHJvdGVjdCgpLAoKCWNvbmNhdDogZnVuY3Rpb24oKXsKCQl2YXIgbmV3RWxlbWVudHMgPSBuZXcgRWxlbWVudHModGhpcyk7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBhcmd1bWVudHNbaV07CgkJCWlmIChUeXBlLmlzRW51bWVyYWJsZShpdGVtKSkgbmV3RWxlbWVudHMuYXBwZW5kKGl0ZW0pOwoJCQllbHNlIG5ld0VsZW1lbnRzLnB1c2goaXRlbSk7CgkJfQoJCXJldHVybiBuZXdFbGVtZW50czsKCX0ucHJvdGVjdCgpLAoKCWFwcGVuZDogZnVuY3Rpb24oY29sbGVjdGlvbil7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBjb2xsZWN0aW9uLmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5wdXNoKGNvbGxlY3Rpb25baV0pOwoJCXJldHVybiB0aGlzOwoJfS5wcm90ZWN0KCksCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJd2hpbGUgKHRoaXMubGVuZ3RoKSBkZWxldGUgdGhpc1stLXRoaXMubGVuZ3RoXTsKCQlyZXR1cm4gdGhpczsKCX0ucHJvdGVjdCgpCgp9KTsKCgoKKGZ1bmN0aW9uKCl7CgovLyBGRiwgSUUKdmFyIHNwbGljZSA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UsIG9iamVjdCA9IHsnMCc6IDAsICcxJzogMSwgbGVuZ3RoOiAyfTsKCnNwbGljZS5jYWxsKG9iamVjdCwgMSwgMSk7CmlmIChvYmplY3RbMV0gPT0gMSkgRWxlbWVudHMuaW1wbGVtZW50KCdzcGxpY2UnLCBmdW5jdGlvbigpewoJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwoJdmFyIHJlc3VsdCA9IHNwbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJd2hpbGUgKGxlbmd0aCA+PSB0aGlzLmxlbmd0aCkgZGVsZXRlIHRoaXNbbGVuZ3RoLS1dOwoJcmV0dXJuIHJlc3VsdDsKfS5wcm90ZWN0KCkpOwoKQXJyYXkuZm9yRWFjaE1ldGhvZChmdW5jdGlvbihtZXRob2QsIG5hbWUpewoJRWxlbWVudHMuaW1wbGVtZW50KG5hbWUsIG1ldGhvZCk7Cn0pOwoKQXJyYXkubWlycm9yKEVsZW1lbnRzKTsKCi8qPGx0SUU4PiovCnZhciBjcmVhdGVFbGVtZW50QWNjZXB0c0hUTUw7CnRyeSB7CiAgICBjcmVhdGVFbGVtZW50QWNjZXB0c0hUTUwgPSAoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnPGlucHV0IG5hbWU9eD4nKS5uYW1lID09ICd4Jyk7Cn0gY2F0Y2ggKGUpe30KCnZhciBlc2NhcGVRdW90ZXMgPSBmdW5jdGlvbihodG1sKXsKCXJldHVybiAoJycgKyBodG1sKS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9OwovKjwvbHRJRTg+Ki8KCkRvY3VtZW50LmltcGxlbWVudCh7CgoJbmV3RWxlbWVudDogZnVuY3Rpb24odGFnLCBwcm9wcyl7CgkJaWYgKHByb3BzICYmIHByb3BzLmNoZWNrZWQgIT0gbnVsbCkgcHJvcHMuZGVmYXVsdENoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwoJCS8qPGx0SUU4PiovLy8gRml4IGZvciByZWFkb25seSBuYW1lIGFuZCB0eXBlIHByb3BlcnRpZXMgaW4gSUUgPCA4CgkJaWYgKGNyZWF0ZUVsZW1lbnRBY2NlcHRzSFRNTCAmJiBwcm9wcyl7CgkJCXRhZyA9ICc8JyArIHRhZzsKCQkJaWYgKHByb3BzLm5hbWUpIHRhZyArPSAnIG5hbWU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMubmFtZSkgKyAnIic7CgkJCWlmIChwcm9wcy50eXBlKSB0YWcgKz0gJyB0eXBlPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLnR5cGUpICsgJyInOwoJCQl0YWcgKz0gJz4nOwoJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJZGVsZXRlIHByb3BzLnR5cGU7CgkJfQoJCS8qPC9sdElFOD4qLwoJCXJldHVybiB0aGlzLmlkKHRoaXMuY3JlYXRlRWxlbWVudCh0YWcpKS5zZXQocHJvcHMpOwoJfQoKfSk7Cgp9KSgpOwoKKGZ1bmN0aW9uKCl7CgpTbGljay51aWRPZih3aW5kb3cpOwpTbGljay51aWRPZihkb2N1bWVudCk7CgpEb2N1bWVudC5pbXBsZW1lbnQoewoKCW5ld1RleHROb2RlOiBmdW5jdGlvbih0ZXh0KXsKCQlyZXR1cm4gdGhpcy5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy53aW5kb3c7Cgl9LAoKCWlkOiAoZnVuY3Rpb24oKXsKCgkJdmFyIHR5cGVzID0gewoKCQkJc3RyaW5nOiBmdW5jdGlvbihpZCwgbm9jYXNoLCBkb2MpewoJCQkJaWQgPSBTbGljay5maW5kKGRvYywgJyMnICsgaWQucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKTsKCQkJCXJldHVybiAoaWQpID8gdHlwZXMuZWxlbWVudChpZCwgbm9jYXNoKSA6IG51bGw7CgkJCX0sCgoJCQllbGVtZW50OiBmdW5jdGlvbihlbCwgbm9jYXNoKXsKCQkJCVNsaWNrLnVpZE9mKGVsKTsKCQkJCWlmICghbm9jYXNoICYmICFlbC4kZmFtaWx5ICYmICEoL14oPzpvYmplY3R8ZW1iZWQpJC9pKS50ZXN0KGVsLnRhZ05hbWUpKXsKCQkJCQl2YXIgZmlyZUV2ZW50ID0gZWwuZmlyZUV2ZW50OwoJCQkJCS8vIHdyYXBwaW5nIG5lZWRlZCBpbiBJRTcsIG9yIGVsc2UgY3Jhc2gKCQkJCQllbC5fZmlyZUV2ZW50ID0gZnVuY3Rpb24odHlwZSwgZXZlbnQpewoJCQkJCQlyZXR1cm4gZmlyZUV2ZW50KHR5cGUsIGV2ZW50KTsKCQkJCQl9OwoJCQkJCU9iamVjdC5hcHBlbmQoZWwsIEVsZW1lbnQuUHJvdG90eXBlKTsKCQkJCX0KCQkJCXJldHVybiBlbDsKCQkJfSwKCgkJCW9iamVjdDogZnVuY3Rpb24ob2JqLCBub2Nhc2gsIGRvYyl7CgkJCQlpZiAob2JqLnRvRWxlbWVudCkgcmV0dXJuIHR5cGVzLmVsZW1lbnQob2JqLnRvRWxlbWVudChkb2MpLCBub2Nhc2gpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJfTsKCgkJdHlwZXMudGV4dG5vZGUgPSB0eXBlcy53aGl0ZXNwYWNlID0gdHlwZXMud2luZG93ID0gdHlwZXMuZG9jdW1lbnQgPSBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGVsLCBub2Nhc2gsIGRvYyl7CgkJCWlmIChlbCAmJiBlbC4kZmFtaWx5ICYmIGVsLnVuaXF1ZU51bWJlcikgcmV0dXJuIGVsOwoJCQl2YXIgdHlwZSA9IHR5cGVPZihlbCk7CgkJCXJldHVybiAodHlwZXNbdHlwZV0pID8gdHlwZXNbdHlwZV0oZWwsIG5vY2FzaCwgZG9jIHx8IGRvY3VtZW50KSA6IG51bGw7CgkJfTsKCgl9KSgpCgp9KTsKCmlmICh3aW5kb3cuJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJywgZnVuY3Rpb24oZWwsIG5jKXsKCXJldHVybiBkb2N1bWVudC5pZChlbCwgbmMsIHRoaXMuZG9jdW1lbnQpOwp9KTsKCldpbmRvdy5pbXBsZW1lbnQoewoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmRvY3VtZW50OwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCltEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgZXhwcmVzc2lvbiwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0RWxlbWVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgZXhwcmVzc2lvbikpOwoJfQoKfSk7Cgp2YXIgY29udGFpbnMgPSB7Y29udGFpbnM6IGZ1bmN0aW9uKGVsZW1lbnQpewoJcmV0dXJuIFNsaWNrLmNvbnRhaW5zKHRoaXMsIGVsZW1lbnQpOwp9fTsKCmlmICghZG9jdW1lbnQuY29udGFpbnMpIERvY3VtZW50LmltcGxlbWVudChjb250YWlucyk7CmlmICghZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykuY29udGFpbnMpIEVsZW1lbnQuaW1wbGVtZW50KGNvbnRhaW5zKTsKCgoKLy8gdHJlZSB3YWxraW5nCgp2YXIgaW5qZWN0Q29tYmluYXRvciA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGNvbWJpbmF0b3IpewoJaWYgKCFleHByZXNzaW9uKSByZXR1cm4gY29tYmluYXRvcjsKCglleHByZXNzaW9uID0gT2JqZWN0LmNsb25lKFNsaWNrLnBhcnNlKGV4cHJlc3Npb24pKTsKCgl2YXIgZXhwcmVzc2lvbnMgPSBleHByZXNzaW9uLmV4cHJlc3Npb25zOwoJZm9yICh2YXIgaSA9IGV4cHJlc3Npb25zLmxlbmd0aDsgaS0tOykKCQlleHByZXNzaW9uc1tpXVswXS5jb21iaW5hdG9yID0gY29tYmluYXRvcjsKCglyZXR1cm4gZXhwcmVzc2lvbjsKfTsKCk9iamVjdC5mb3JFYWNoKHsKCWdldE5leHQ6ICd+JywKCWdldFByZXZpb3VzOiAnIX4nLAoJZ2V0UGFyZW50OiAnIScKfSwgZnVuY3Rpb24oY29tYmluYXRvciwgbWV0aG9kKXsKCUVsZW1lbnQuaW1wbGVtZW50KG1ldGhvZCwgZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIHRoaXMuZ2V0RWxlbWVudChpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sIGNvbWJpbmF0b3IpKTsKCX0pOwp9KTsKCk9iamVjdC5mb3JFYWNoKHsKCWdldEFsbE5leHQ6ICd+JywKCWdldEFsbFByZXZpb3VzOiAnIX4nLAoJZ2V0U2libGluZ3M6ICd+ficsCglnZXRDaGlsZHJlbjogJz4nLAoJZ2V0UGFyZW50czogJyEnCn0sIGZ1bmN0aW9uKGNvbWJpbmF0b3IsIG1ldGhvZCl7CglFbGVtZW50LmltcGxlbWVudChtZXRob2QsIGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiB0aGlzLmdldEVsZW1lbnRzKGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgY29tYmluYXRvcikpOwoJfSk7Cn0pOwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWdldEZpcnN0OiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suc2VhcmNoKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJz4nKSlbMF0pOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suc2VhcmNoKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJz4nKSkuZ2V0TGFzdCgpKTsKCX0sCgoJZ2V0V2luZG93OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLm93bmVyRG9jdW1lbnQud2luZG93OwoJfSwKCglnZXREb2N1bWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50OwoJfSwKCglnZXRFbGVtZW50QnlJZDogZnVuY3Rpb24oaWQpewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsICcjJyArICgnJyArIGlkKS5yZXBsYWNlKC8oXFcpL2csICdcXCQxJykpKTsKCX0sCgoJbWF0Y2g6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiAhZXhwcmVzc2lvbiB8fCBTbGljay5tYXRjaCh0aGlzLCBleHByZXNzaW9uKTsKCX0KCn0pOwoKCgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CgkJaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBzZWxlY3RvciwgbmV3IEVsZW1lbnRzKTsKCQllbHNlIGlmIChUeXBlLmlzRW51bWVyYWJsZShzZWxlY3RvcikpIHJldHVybiBuZXcgRWxlbWVudHMoc2VsZWN0b3IpOwoJfQoJcmV0dXJuIG5ldyBFbGVtZW50cyhhcmd1bWVudHMpOwp9KTsKCi8vIEluc2VydGVycwoKdmFyIGluc2VydGVycyA9IHsKCgliZWZvcmU6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50Lm5leHRTaWJsaW5nKTsKCX0sCgoJYm90dG9tOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50LmFwcGVuZENoaWxkKGNvbnRleHQpOwoJfSwKCgl0b3A6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7Cgl9Cgp9OwoKaW5zZXJ0ZXJzLmluc2lkZSA9IGluc2VydGVycy5ib3R0b207CgoKCi8vIGdldFByb3BlcnR5IC8gc2V0UHJvcGVydHkKCnZhciBwcm9wZXJ0eUdldHRlcnMgPSB7fSwgcHJvcGVydHlTZXR0ZXJzID0ge307CgovLyBwcm9wZXJ0aWVzCgp2YXIgcHJvcGVydGllcyA9IHt9OwpBcnJheS5mb3JFYWNoKFsKCSd0eXBlJywgJ3ZhbHVlJywgJ2RlZmF1bHRWYWx1ZScsICdhY2Nlc3NLZXknLCAnY2VsbFBhZGRpbmcnLCAnY2VsbFNwYWNpbmcnLCAnY29sU3BhbicsCgknZnJhbWVCb3JkZXInLCAncm93U3BhbicsICd0YWJJbmRleCcsICd1c2VNYXAnCl0sIGZ1bmN0aW9uKHByb3BlcnR5KXsKCXByb3BlcnRpZXNbcHJvcGVydHkudG9Mb3dlckNhc2UoKV0gPSBwcm9wZXJ0eTsKfSk7Cgpwcm9wZXJ0aWVzLmh0bWwgPSAnaW5uZXJIVE1MJzsKcHJvcGVydGllcy50ZXh0ID0gKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLnRleHRDb250ZW50ID09IG51bGwpID8gJ2lubmVyVGV4dCc6ICd0ZXh0Q29udGVudCc7CgpPYmplY3QuZm9yRWFjaChwcm9wZXJ0aWVzLCBmdW5jdGlvbihyZWFsLCBrZXkpewoJcHJvcGVydHlTZXR0ZXJzW2tleV0gPSBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJbm9kZVtyZWFsXSA9IHZhbHVlOwoJfTsKCXByb3BlcnR5R2V0dGVyc1trZXldID0gZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGVbcmVhbF07Cgl9Owp9KTsKCi8vIEJvb2xlYW5zCgp2YXIgYm9vbHMgPSBbCgknY29tcGFjdCcsICdub3dyYXAnLCAnaXNtYXAnLCAnZGVjbGFyZScsICdub3NoYWRlJywgJ2NoZWNrZWQnLAoJJ2Rpc2FibGVkJywgJ3JlYWRPbmx5JywgJ211bHRpcGxlJywgJ3NlbGVjdGVkJywgJ25vcmVzaXplJywKCSdkZWZlcicsICdkZWZhdWx0Q2hlY2tlZCcsICdhdXRvZm9jdXMnLCAnY29udHJvbHMnLCAnYXV0b3BsYXknLAoJJ2xvb3AnCl07Cgp2YXIgYm9vbGVhbnMgPSB7fTsKQXJyYXkuZm9yRWFjaChib29scywgZnVuY3Rpb24oYm9vbCl7Cgl2YXIgbG93ZXIgPSBib29sLnRvTG93ZXJDYXNlKCk7Cglib29sZWFuc1tsb3dlcl0gPSBib29sOwoJcHJvcGVydHlTZXR0ZXJzW2xvd2VyXSA9IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQlub2RlW2Jvb2xdID0gISF2YWx1ZTsKCX07Cglwcm9wZXJ0eUdldHRlcnNbbG93ZXJdID0gZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuICEhbm9kZVtib29sXTsKCX07Cn0pOwoKLy8gU3BlY2lhbCBjYXNlcwoKT2JqZWN0LmFwcGVuZChwcm9wZXJ0eVNldHRlcnMsIHsKCgknY2xhc3MnOiBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJKCdjbGFzc05hbWUnIGluIG5vZGUpID8gbm9kZS5jbGFzc05hbWUgPSAodmFsdWUgfHwgJycpIDogbm9kZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdmFsdWUpOwoJfSwKCgknZm9yJzogZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCSgnaHRtbEZvcicgaW4gbm9kZSkgPyBub2RlLmh0bWxGb3IgPSB2YWx1ZSA6IG5vZGUuc2V0QXR0cmlidXRlKCdmb3InLCB2YWx1ZSk7Cgl9LAoKCSdzdHlsZSc6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQkobm9kZS5zdHlsZSkgPyBub2RlLnN0eWxlLmNzc1RleHQgPSB2YWx1ZSA6IG5vZGUuc2V0QXR0cmlidXRlKCdzdHlsZScsIHZhbHVlKTsKCX0sCgoJJ3ZhbHVlJzogZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCW5vZGUudmFsdWUgPSAodmFsdWUgIT0gbnVsbCkgPyB2YWx1ZSA6ICcnOwoJfQoKfSk7Cgpwcm9wZXJ0eUdldHRlcnNbJ2NsYXNzJ10gPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiAoJ2NsYXNzTmFtZScgaW4gbm9kZSkgPyBub2RlLmNsYXNzTmFtZSB8fCBudWxsIDogbm9kZS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJyk7Cn07CgovKiA8d2Via2l0PiAqLwp2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKTsKLy8gSUUgc2V0cyB0eXBlIGFzIHJlYWRvbmx5IGFuZCB0aHJvd3MKdHJ5IHsgZWwudHlwZSA9ICdidXR0b24nOyB9IGNhdGNoKGUpe30KaWYgKGVsLnR5cGUgIT0gJ2J1dHRvbicpIHByb3BlcnR5U2V0dGVycy50eXBlID0gZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJbm9kZS5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCB2YWx1ZSk7Cn07CmVsID0gbnVsbDsKLyogPC93ZWJraXQ+ICovCgovKjxJRT4qLwp2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOwppbnB1dC52YWx1ZSA9ICd0JzsKaW5wdXQudHlwZSA9ICdzdWJtaXQnOwppZiAoaW5wdXQudmFsdWUgIT0gJ3QnKSBwcm9wZXJ0eVNldHRlcnMudHlwZSA9IGZ1bmN0aW9uKG5vZGUsIHR5cGUpewoJdmFyIHZhbHVlID0gbm9kZS52YWx1ZTsKCW5vZGUudHlwZSA9IHR5cGU7Cglub2RlLnZhbHVlID0gdmFsdWU7Cn07CmlucHV0ID0gbnVsbDsKLyo8L0lFPiovCgovKiBnZXRQcm9wZXJ0eSwgc2V0UHJvcGVydHkgKi8KCi8qIDxsdElFOT4gKi8KdmFyIHBvbGx1dGVzR2V0QXR0cmlidXRlID0gKGZ1bmN0aW9uKGRpdil7CglkaXYucmFuZG9tID0gJ2F0dHJpYnV0ZSc7CglyZXR1cm4gKGRpdi5nZXRBdHRyaWJ1dGUoJ3JhbmRvbScpID09ICdhdHRyaWJ1dGUnKTsKfSkoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykpOwoKLyogPGx0SUU5PiAqLwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldFByb3BlcnR5OiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CgkJdmFyIHNldHRlciA9IHByb3BlcnR5U2V0dGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldOwoJCWlmIChzZXR0ZXIpewoJCQlzZXR0ZXIodGhpcywgdmFsdWUpOwoJCX0gZWxzZSB7CgkJCS8qIDxsdElFOT4gKi8KCQkJaWYgKHBvbGx1dGVzR2V0QXR0cmlidXRlKSB2YXIgYXR0cmlidXRlV2hpdGVMaXN0ID0gdGhpcy5yZXRyaWV2ZSgnJGF0dHJpYnV0ZVdoaXRlTGlzdCcsIHt9KTsKCQkJLyogPC9sdElFOT4gKi8KCgkJCWlmICh2YWx1ZSA9PSBudWxsKXsKCQkJCXRoaXMucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwoJCQkJLyogPGx0SUU5PiAqLwoJCQkJaWYgKHBvbGx1dGVzR2V0QXR0cmlidXRlKSBkZWxldGUgYXR0cmlidXRlV2hpdGVMaXN0W25hbWVdOwoJCQkJLyogPC9sdElFOT4gKi8KCQkJfSBlbHNlIHsKCQkJCXRoaXMuc2V0QXR0cmlidXRlKG5hbWUsICcnICsgdmFsdWUpOwoJCQkJLyogPGx0SUU5PiAqLwoJCQkJaWYgKHBvbGx1dGVzR2V0QXR0cmlidXRlKSBhdHRyaWJ1dGVXaGl0ZUxpc3RbbmFtZV0gPSB0cnVlOwoJCQkJLyogPC9sdElFOT4gKi8KCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJc2V0UHJvcGVydGllczogZnVuY3Rpb24oYXR0cmlidXRlcyl7CgkJZm9yICh2YXIgYXR0cmlidXRlIGluIGF0dHJpYnV0ZXMpIHRoaXMuc2V0UHJvcGVydHkoYXR0cmlidXRlLCBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRQcm9wZXJ0eTogZnVuY3Rpb24obmFtZSl7CgkJdmFyIGdldHRlciA9IHByb3BlcnR5R2V0dGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldOwoJCWlmIChnZXR0ZXIpIHJldHVybiBnZXR0ZXIodGhpcyk7CgkJLyogPGx0SUU5PiAqLwoJCWlmIChwb2xsdXRlc0dldEF0dHJpYnV0ZSl7CgkJCXZhciBhdHRyID0gdGhpcy5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpLCBhdHRyaWJ1dGVXaGl0ZUxpc3QgPSB0aGlzLnJldHJpZXZlKCckYXR0cmlidXRlV2hpdGVMaXN0Jywge30pOwoJCQlpZiAoIWF0dHIpIHJldHVybiBudWxsOwoJCQlpZiAoYXR0ci5leHBhbmRvICYmICFhdHRyaWJ1dGVXaGl0ZUxpc3RbbmFtZV0pewoJCQkJdmFyIG91dGVyID0gdGhpcy5vdXRlckhUTUw7CgkJCQkvLyBzZWdtZW50IGJ5IHRoZSBvcGVuaW5nIHRhZyBhbmQgZmluZCBtZW50aW9uIG9mIGF0dHJpYnV0ZSBuYW1lCgkJCQlpZiAob3V0ZXIuc3Vic3RyKDAsIG91dGVyLnNlYXJjaCgvXC8/WyciXT8+KD8hW148XSo8WyciXSkvKSkuaW5kZXhPZihuYW1lKSA8IDApIHJldHVybiBudWxsOwoJCQkJYXR0cmlidXRlV2hpdGVMaXN0W25hbWVdID0gdHJ1ZTsKCQkJfQoJCX0KCQkvKiA8L2x0SUU5PiAqLwoJCXZhciByZXN1bHQgPSBTbGljay5nZXRBdHRyaWJ1dGUodGhpcywgbmFtZSk7CgkJcmV0dXJuICghcmVzdWx0ICYmICFTbGljay5oYXNBdHRyaWJ1dGUodGhpcywgbmFtZSkpID8gbnVsbCA6IHJlc3VsdDsKCX0sCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKCQlyZXR1cm4gYXJncy5tYXAodGhpcy5nZXRQcm9wZXJ0eSwgdGhpcykuYXNzb2NpYXRlKGFyZ3MpOwoJfSwKCglyZW1vdmVQcm9wZXJ0eTogZnVuY3Rpb24obmFtZSl7CgkJcmV0dXJuIHRoaXMuc2V0UHJvcGVydHkobmFtZSwgbnVsbCk7Cgl9LAoKCXJlbW92ZVByb3BlcnRpZXM6IGZ1bmN0aW9uKCl7CgkJQXJyYXkuZWFjaChhcmd1bWVudHMsIHRoaXMucmVtb3ZlUHJvcGVydHksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXQ6IGZ1bmN0aW9uKHByb3AsIHZhbHVlKXsKCQl2YXIgcHJvcGVydHkgPSBFbGVtZW50LlByb3BlcnRpZXNbcHJvcF07CgkJKHByb3BlcnR5ICYmIHByb3BlcnR5LnNldCkgPyBwcm9wZXJ0eS5zZXQuY2FsbCh0aGlzLCB2YWx1ZSkgOiB0aGlzLnNldFByb3BlcnR5KHByb3AsIHZhbHVlKTsKCX0ub3ZlcmxvYWRTZXR0ZXIoKSwKCglnZXQ6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQlyZXR1cm4gKHByb3BlcnR5ICYmIHByb3BlcnR5LmdldCkgPyBwcm9wZXJ0eS5nZXQuYXBwbHkodGhpcykgOiB0aGlzLmdldFByb3BlcnR5KHByb3ApOwoJfS5vdmVybG9hZEdldHRlcigpLAoKCWVyYXNlOiBmdW5jdGlvbihwcm9wKXsKCQl2YXIgcHJvcGVydHkgPSBFbGVtZW50LlByb3BlcnRpZXNbcHJvcF07CgkJKHByb3BlcnR5ICYmIHByb3BlcnR5LmVyYXNlKSA/IHByb3BlcnR5LmVyYXNlLmFwcGx5KHRoaXMpIDogdGhpcy5yZW1vdmVQcm9wZXJ0eShwcm9wKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJcmV0dXJuIHRoaXMuY2xhc3NOYW1lLmNsZWFuKCkuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCglhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgdGhpcy5jbGFzc05hbWUgPSAodGhpcy5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWUpLmNsZWFuKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUucmVwbGFjZShuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGNsYXNzTmFtZSArICcoPzpcXHN8JCknKSwgJyQxJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUsIGZvcmNlKXsKCQlpZiAoZm9yY2UgPT0gbnVsbCkgZm9yY2UgPSAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpOwoJCXJldHVybiAoZm9yY2UpID8gdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwoJfSwKCglhZG9wdDogZnVuY3Rpb24oKXsKCQl2YXIgcGFyZW50ID0gdGhpcywgZnJhZ21lbnQsIGVsZW1lbnRzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLCBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgkJaWYgKGxlbmd0aCA+IDEpIHBhcmVudCA9IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50c1tpXSwgdHJ1ZSk7CgkJCWlmIChlbGVtZW50KSBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJfQoKCQlpZiAoZnJhZ21lbnQpIHRoaXMuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJYXBwZW5kVGV4dDogZnVuY3Rpb24odGV4dCwgd2hlcmUpewoJCXJldHVybiB0aGlzLmdyYWIodGhpcy5nZXREb2N1bWVudCgpLm5ld1RleHROb2RlKHRleHQpLCB3aGVyZSk7Cgl9LAoKCWdyYWI6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXShkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmplY3Q6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXSh0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWwpewoJCWVsID0gZG9jdW1lbnQuaWQoZWwsIHRydWUpOwoJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMsIGVsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcHM6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJcmV0dXJuIHRoaXMucmVwbGFjZXMoZWwpLmdyYWIoZWwsIHdoZXJlKTsKCX0sCgoJZ2V0U2VsZWN0ZWQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zZWxlY3RlZEluZGV4OyAvLyBTYWZhcmkgMy4yLjEKCQlyZXR1cm4gbmV3IEVsZW1lbnRzKEFycmF5LmZyb20odGhpcy5vcHRpb25zKS5maWx0ZXIoZnVuY3Rpb24ob3B0aW9uKXsKCQkJcmV0dXJuIG9wdGlvbi5zZWxlY3RlZDsKCQl9KSk7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKCl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgkJdGhpcy5nZXRFbGVtZW50cygnaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEnKS5lYWNoKGZ1bmN0aW9uKGVsKXsKCQkJdmFyIHR5cGUgPSBlbC50eXBlOwoJCQlpZiAoIWVsLm5hbWUgfHwgZWwuZGlzYWJsZWQgfHwgdHlwZSA9PSAnc3VibWl0JyB8fCB0eXBlID09ICdyZXNldCcgfHwgdHlwZSA9PSAnZmlsZScgfHwgdHlwZSA9PSAnaW1hZ2UnKSByZXR1cm47CgoJCQl2YXIgdmFsdWUgPSAoZWwuZ2V0KCd0YWcnKSA9PSAnc2VsZWN0JykgPyBlbC5nZXRTZWxlY3RlZCgpLm1hcChmdW5jdGlvbihvcHQpewoJCQkJLy8gSUUKCQkJCXJldHVybiBkb2N1bWVudC5pZChvcHQpLmdldCgndmFsdWUnKTsKCQkJfSkgOiAoKHR5cGUgPT0gJ3JhZGlvJyB8fCB0eXBlID09ICdjaGVja2JveCcpICYmICFlbC5jaGVja2VkKSA/IG51bGwgOiBlbC5nZXQoJ3ZhbHVlJyk7CgoJCQlBcnJheS5mcm9tKHZhbHVlKS5lYWNoKGZ1bmN0aW9uKHZhbCl7CgkJCQlpZiAodHlwZW9mIHZhbCAhPSAndW5kZWZpbmVkJykgcXVlcnlTdHJpbmcucHVzaChlbmNvZGVVUklDb21wb25lbnQoZWwubmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsKSk7CgkJCX0pOwoJCX0pOwoJCXJldHVybiBxdWVyeVN0cmluZy5qb2luKCcmJyk7Cgl9Cgp9KTsKCnZhciBjb2xsZWN0ZWQgPSB7fSwgc3RvcmFnZSA9IHt9OwoKdmFyIGdldCA9IGZ1bmN0aW9uKHVpZCl7CglyZXR1cm4gKHN0b3JhZ2VbdWlkXSB8fCAoc3RvcmFnZVt1aWRdID0ge30pKTsKfTsKCnZhciBjbGVhbiA9IGZ1bmN0aW9uKGl0ZW0pewoJdmFyIHVpZCA9IGl0ZW0udW5pcXVlTnVtYmVyOwoJaWYgKGl0ZW0ucmVtb3ZlRXZlbnRzKSBpdGVtLnJlbW92ZUV2ZW50cygpOwoJaWYgKGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKSBpdGVtLmNsZWFyQXR0cmlidXRlcygpOwoJaWYgKHVpZCAhPSBudWxsKXsKCQlkZWxldGUgY29sbGVjdGVkW3VpZF07CgkJZGVsZXRlIHN0b3JhZ2VbdWlkXTsKCX0KCXJldHVybiBpdGVtOwp9OwoKdmFyIGZvcm1Qcm9wcyA9IHtpbnB1dDogJ2NoZWNrZWQnLCBvcHRpb246ICdzZWxlY3RlZCcsIHRleHRhcmVhOiAndmFsdWUnfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglkZXN0cm95OiBmdW5jdGlvbigpewoJCXZhciBjaGlsZHJlbiA9IGNsZWFuKHRoaXMpLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJQXJyYXkuZWFjaChjaGlsZHJlbiwgY2xlYW4pOwoJCUVsZW1lbnQuZGlzcG9zZSh0aGlzKTsKCQlyZXR1cm4gbnVsbDsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJQXJyYXkuZnJvbSh0aGlzLmNoaWxkTm9kZXMpLmVhY2goRWxlbWVudC5kaXNwb3NlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMucGFyZW50Tm9kZSkgPyB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcykgOiB0aGlzOwoJfSwKCgljbG9uZTogZnVuY3Rpb24oY29udGVudHMsIGtlZXBpZCl7CgkJY29udGVudHMgPSBjb250ZW50cyAhPT0gZmFsc2U7CgkJdmFyIGNsb25lID0gdGhpcy5jbG9uZU5vZGUoY29udGVudHMpLCBjZSA9IFtjbG9uZV0sIHRlID0gW3RoaXNdLCBpOwoKCQlpZiAoY29udGVudHMpewoJCQljZS5hcHBlbmQoQXJyYXkuZnJvbShjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpKSk7CgkJCXRlLmFwcGVuZChBcnJheS5mcm9tKHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSkpOwoJCX0KCgkJZm9yIChpID0gY2UubGVuZ3RoOyBpLS07KXsKCQkJdmFyIG5vZGUgPSBjZVtpXSwgZWxlbWVudCA9IHRlW2ldOwoJCQlpZiAoIWtlZXBpZCkgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCS8qPGx0SUU5PiovCgkJCWlmIChub2RlLmNsZWFyQXR0cmlidXRlcyl7CgkJCQlub2RlLmNsZWFyQXR0cmlidXRlcygpOwoJCQkJbm9kZS5tZXJnZUF0dHJpYnV0ZXMoZWxlbWVudCk7CgkJCQlub2RlLnJlbW92ZUF0dHJpYnV0ZSgndW5pcXVlTnVtYmVyJyk7CgkJCQlpZiAobm9kZS5vcHRpb25zKXsKCQkJCQl2YXIgbm8gPSBub2RlLm9wdGlvbnMsIGVvID0gZWxlbWVudC5vcHRpb25zOwoJCQkJCWZvciAodmFyIGogPSBuby5sZW5ndGg7IGotLTspIG5vW2pdLnNlbGVjdGVkID0gZW9bal0uc2VsZWN0ZWQ7CgkJCQl9CgkJCX0KCQkJLyo8L2x0SUU5PiovCgkJCXZhciBwcm9wID0gZm9ybVByb3BzW2VsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpXTsKCQkJaWYgKHByb3AgJiYgZWxlbWVudFtwcm9wXSkgbm9kZVtwcm9wXSA9IGVsZW1lbnRbcHJvcF07CgkJfQoKCQkvKjxsdElFOT4qLwoJCWlmIChCcm93c2VyLmllKXsKCQkJdmFyIGNvID0gY2xvbmUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ29iamVjdCcpLCB0byA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ29iamVjdCcpOwoJCQlmb3IgKGkgPSBjby5sZW5ndGg7IGktLTspIGNvW2ldLm91dGVySFRNTCA9IHRvW2ldLm91dGVySFRNTDsKCQl9CgkJLyo8L2x0SUU5PiovCgkJcmV0dXJuIGRvY3VtZW50LmlkKGNsb25lKTsKCX0KCn0pOwoKW0VsZW1lbnQsIFdpbmRvdywgRG9jdW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWFkZExpc3RlbmVyOiBmdW5jdGlvbih0eXBlLCBmbil7CgkJaWYgKHR5cGUgPT0gJ3VubG9hZCcpewoJCQl2YXIgb2xkID0gZm4sIHNlbGYgPSB0aGlzOwoJCQlmbiA9IGZ1bmN0aW9uKCl7CgkJCQlzZWxmLnJlbW92ZUxpc3RlbmVyKCd1bmxvYWQnLCBmbik7CgkJCQlvbGQoKTsKCQkJfTsKCQl9IGVsc2UgewoJCQljb2xsZWN0ZWRbU2xpY2sudWlkT2YodGhpcyldID0gdGhpczsKCQl9CgkJaWYgKHRoaXMuYWRkRXZlbnRMaXN0ZW5lcikgdGhpcy5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZuLCAhIWFyZ3VtZW50c1syXSk7CgkJZWxzZSB0aGlzLmF0dGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUxpc3RlbmVyOiBmdW5jdGlvbih0eXBlLCBmbil7CgkJaWYgKHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcikgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGZuLCAhIWFyZ3VtZW50c1syXSk7CgkJZWxzZSB0aGlzLmRldGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJldHJpZXZlOiBmdW5jdGlvbihwcm9wZXJ0eSwgZGZsdCl7CgkJdmFyIHN0b3JhZ2UgPSBnZXQoU2xpY2sudWlkT2YodGhpcykpLCBwcm9wID0gc3RvcmFnZVtwcm9wZXJ0eV07CgkJaWYgKGRmbHQgIT0gbnVsbCAmJiBwcm9wID09IG51bGwpIHByb3AgPSBzdG9yYWdlW3Byb3BlcnR5XSA9IGRmbHQ7CgkJcmV0dXJuIHByb3AgIT0gbnVsbCA/IHByb3AgOiBudWxsOwoJfSwKCglzdG9yZTogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKCQl2YXIgc3RvcmFnZSA9IGdldChTbGljay51aWRPZih0aGlzKSk7CgkJc3RvcmFnZVtwcm9wZXJ0eV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZWxpbWluYXRlOiBmdW5jdGlvbihwcm9wZXJ0eSl7CgkJdmFyIHN0b3JhZ2UgPSBnZXQoU2xpY2sudWlkT2YodGhpcykpOwoJCWRlbGV0ZSBzdG9yYWdlW3Byb3BlcnR5XTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLyo8bHRJRTk+Ki8KaWYgKHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHdpbmRvdy5hZGRMaXN0ZW5lcigndW5sb2FkJywgZnVuY3Rpb24oKXsKCU9iamVjdC5lYWNoKGNvbGxlY3RlZCwgY2xlYW4pOwoJaWYgKHdpbmRvdy5Db2xsZWN0R2FyYmFnZSkgQ29sbGVjdEdhcmJhZ2UoKTsKfSk7Ci8qPC9sdElFOT4qLwoKRWxlbWVudC5Qcm9wZXJ0aWVzID0ge307CgoKCkVsZW1lbnQuUHJvcGVydGllcy5zdHlsZSA9IHsKCglzZXQ6IGZ1bmN0aW9uKHN0eWxlKXsKCQl0aGlzLnN0eWxlLmNzc1RleHQgPSBzdHlsZTsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnN0eWxlLmNzc1RleHQ7Cgl9LAoKCWVyYXNlOiBmdW5jdGlvbigpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9ICcnOwoJfQoKfTsKCkVsZW1lbnQuUHJvcGVydGllcy50YWcgPSB7CgoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCX0KCn07CgpFbGVtZW50LlByb3BlcnRpZXMuaHRtbCA9IHsKCglzZXQ6IGZ1bmN0aW9uKGh0bWwpewoJCWlmIChodG1sID09IG51bGwpIGh0bWwgPSAnJzsKCQllbHNlIGlmICh0eXBlT2YoaHRtbCkgPT0gJ2FycmF5JykgaHRtbCA9IGh0bWwuam9pbignJyk7CgkJdGhpcy5pbm5lckhUTUwgPSBodG1sOwoJfSwKCgllcmFzZTogZnVuY3Rpb24oKXsKCQl0aGlzLmlubmVySFRNTCA9ICcnOwoJfQoKfTsKCi8qPGx0SUU5PiovCi8vIHRlY2huaXF1ZSBieSBqZGJhcmxldHQgLSBodHRwOi8vamRiYXJ0bGV0dC5jb20vaW5uZXJzaGl2Lwp2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmRpdi5pbm5lckhUTUwgPSAnPG5hdj48L25hdj4nOwp2YXIgc3VwcG9ydHNIVE1MNUVsZW1lbnRzID0gKGRpdi5jaGlsZE5vZGVzLmxlbmd0aCA9PSAxKTsKaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpewoJdmFyIHRhZ3MgPSAnYWJiciBhcnRpY2xlIGFzaWRlIGF1ZGlvIGNhbnZhcyBkYXRhbGlzdCBkZXRhaWxzIGZpZ2NhcHRpb24gZmlndXJlIGZvb3RlciBoZWFkZXIgaGdyb3VwIG1hcmsgbWV0ZXIgbmF2IG91dHB1dCBwcm9ncmVzcyBzZWN0aW9uIHN1bW1hcnkgdGltZSB2aWRlbycuc3BsaXQoJyAnKSwKCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwgbCA9IHRhZ3MubGVuZ3RoOwoJd2hpbGUgKGwtLSkgZnJhZ21lbnQuY3JlYXRlRWxlbWVudCh0YWdzW2xdKTsKfQpkaXYgPSBudWxsOwovKjwvbHRJRTk+Ki8KCi8qPElFPiovCnZhciBzdXBwb3J0c1RhYmxlSW5uZXJIVE1MID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJdmFyIHRhYmxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGFibGUnKTsKCXRhYmxlLmlubmVySFRNTCA9ICc8dHI+PHRkPjwvdGQ+PC90cj4nOwoJcmV0dXJuIHRydWU7Cn0pOwoKLyo8bHRGRjQ+Ki8KdmFyIHRyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndHInKSwgaHRtbCA9ICc8dGQ+PC90ZD4nOwp0ci5pbm5lckhUTUwgPSBodG1sOwp2YXIgc3VwcG9ydHNUUklubmVySFRNTCA9ICh0ci5pbm5lckhUTUwgPT0gaHRtbCk7CnRyID0gbnVsbDsKLyo8L2x0RkY0PiovCgppZiAoIXN1cHBvcnRzVGFibGVJbm5lckhUTUwgfHwgIXN1cHBvcnRzVFJJbm5lckhUTUwgfHwgIXN1cHBvcnRzSFRNTDVFbGVtZW50cyl7CgoJRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwuc2V0ID0gKGZ1bmN0aW9uKHNldCl7CgoJCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJCXRhYmxlOiBbMSwgJzx0YWJsZT4nLCAnPC90YWJsZT4nXSwKCQkJc2VsZWN0OiBbMSwgJzxzZWxlY3Q+JywgJzwvc2VsZWN0PiddLAoJCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJCXRyOiBbMywgJzx0YWJsZT48dGJvZHk+PHRyPicsICc8L3RyPjwvdGJvZHk+PC90YWJsZT4nXQoJCX07CgoJCXRyYW5zbGF0aW9ucy50aGVhZCA9IHRyYW5zbGF0aW9ucy50Zm9vdCA9IHRyYW5zbGF0aW9ucy50Ym9keTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGh0bWwpewoJCQl2YXIgd3JhcCA9IHRyYW5zbGF0aW9uc1t0aGlzLmdldCgndGFnJyldOwoJCQlpZiAoIXdyYXAgJiYgIXN1cHBvcnRzSFRNTDVFbGVtZW50cykgd3JhcCA9IFswLCAnJywgJyddOwoJCQlpZiAoIXdyYXApIHJldHVybiBzZXQuY2FsbCh0aGlzLCBodG1sKTsKCgkJCXZhciBsZXZlbCA9IHdyYXBbMF0sIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgdGFyZ2V0ID0gd3JhcHBlcjsKCQkJaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpIGZyYWdtZW50LmFwcGVuZENoaWxkKHdyYXBwZXIpOwoJCQl3cmFwcGVyLmlubmVySFRNTCA9IFt3cmFwWzFdLCBodG1sLCB3cmFwWzJdXS5mbGF0dGVuKCkuam9pbignJyk7CgkJCXdoaWxlIChsZXZlbC0tKSB0YXJnZXQgPSB0YXJnZXQuZmlyc3RDaGlsZDsKCQkJdGhpcy5lbXB0eSgpLmFkb3B0KHRhcmdldC5jaGlsZE5vZGVzKTsKCQkJaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpIGZyYWdtZW50LnJlbW92ZUNoaWxkKHdyYXBwZXIpOwoJCQl3cmFwcGVyID0gbnVsbDsKCQl9OwoKCX0pKEVsZW1lbnQuUHJvcGVydGllcy5odG1sLnNldCk7Cn0KLyo8L0lFPiovCgovKjxsdElFOT4qLwp2YXIgdGVzdEZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdmb3JtJyk7CnRlc3RGb3JtLmlubmVySFRNTCA9ICc8c2VsZWN0PjxvcHRpb24+czwvb3B0aW9uPjwvc2VsZWN0Pic7CgppZiAodGVzdEZvcm0uZmlyc3RDaGlsZC52YWx1ZSAhPSAncycpIEVsZW1lbnQuUHJvcGVydGllcy52YWx1ZSA9IHsKCglzZXQ6IGZ1bmN0aW9uKHZhbHVlKXsKCQl2YXIgdGFnID0gdGhpcy5nZXQoJ3RhZycpOwoJCWlmICh0YWcgIT0gJ3NlbGVjdCcpIHJldHVybiB0aGlzLnNldFByb3BlcnR5KCd2YWx1ZScsIHZhbHVlKTsKCQl2YXIgb3B0aW9ucyA9IHRoaXMuZ2V0RWxlbWVudHMoJ29wdGlvbicpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKyl7CgkJCXZhciBvcHRpb24gPSBvcHRpb25zW2ldLAoJCQkJYXR0ciA9IG9wdGlvbi5nZXRBdHRyaWJ1dGVOb2RlKCd2YWx1ZScpLAoJCQkJb3B0aW9uVmFsdWUgPSAoYXR0ciAmJiBhdHRyLnNwZWNpZmllZCkgPyBvcHRpb24udmFsdWUgOiBvcHRpb24uZ2V0KCd0ZXh0Jyk7CgkJCWlmIChvcHRpb25WYWx1ZSA9PSB2YWx1ZSkgcmV0dXJuIG9wdGlvbi5zZWxlY3RlZCA9IHRydWU7CgkJfQoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbiA9IHRoaXMsIHRhZyA9IG9wdGlvbi5nZXQoJ3RhZycpOwoKCQlpZiAodGFnICE9ICdzZWxlY3QnICYmIHRhZyAhPSAnb3B0aW9uJykgcmV0dXJuIHRoaXMuZ2V0UHJvcGVydHkoJ3ZhbHVlJyk7CgoJCWlmICh0YWcgPT0gJ3NlbGVjdCcgJiYgIShvcHRpb24gPSBvcHRpb24uZ2V0U2VsZWN0ZWQoKVswXSkpIHJldHVybiAnJzsKCgkJdmFyIGF0dHIgPSBvcHRpb24uZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKTsKCQlyZXR1cm4gKGF0dHIgJiYgYXR0ci5zcGVjaWZpZWQpID8gb3B0aW9uLnZhbHVlIDogb3B0aW9uLmdldCgndGV4dCcpOwoJfQoKfTsKdGVzdEZvcm0gPSBudWxsOwovKjwvbHRJRTk+Ki8KCi8qPElFPiovCmlmIChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpKSBFbGVtZW50LlByb3BlcnRpZXMuaWQgPSB7CglzZXQ6IGZ1bmN0aW9uKGlkKXsKCQl0aGlzLmlkID0gdGhpcy5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpLnZhbHVlID0gaWQ7Cgl9LAoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmlkIHx8IG51bGw7Cgl9LAoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5pZCA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS52YWx1ZSA9ICcnOwoJfQp9OwovKjwvSUU+Ki8KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LlN0eWxlCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgbWV0aG9kcyBmb3IgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgc3R5bGVzIG9mIEVsZW1lbnRzIGluIGEgZmFzaGlvbmFibGUgd2F5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRWxlbWVudAoKcHJvdmlkZXM6IEVsZW1lbnQuU3R5bGUKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaHRtbCA9IGRvY3VtZW50Lmh0bWw7CgovLzxsdElFOT4KLy8gQ2hlY2sgZm9yIG9sZElFLCB3aGljaCBkb2VzIG5vdCByZW1vdmUgc3R5bGVzIHdoZW4gdGhleSdyZSBzZXQgdG8gbnVsbAp2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKZWwuc3R5bGUuY29sb3IgPSAncmVkJzsKZWwuc3R5bGUuY29sb3IgPSBudWxsOwp2YXIgZG9lc05vdFJlbW92ZVN0eWxlcyA9IGVsLnN0eWxlLmNvbG9yID09ICdyZWQnOwplbCA9IG51bGw7Ci8vPC9sdElFOT4KCkVsZW1lbnQuUHJvcGVydGllcy5zdHlsZXMgPSB7c2V0OiBmdW5jdGlvbihzdHlsZXMpewoJdGhpcy5zZXRTdHlsZXMoc3R5bGVzKTsKfX07Cgp2YXIgaGFzT3BhY2l0eSA9IChodG1sLnN0eWxlLm9wYWNpdHkgIT0gbnVsbCksCgloYXNGaWx0ZXIgPSAoaHRtbC5zdHlsZS5maWx0ZXIgIT0gbnVsbCksCglyZUFscGhhID0gL2FscGhhXChvcGFjaXR5PShbXGQuXSspXCkvaTsKCnZhciBzZXRWaXNpYmlsaXR5ID0gZnVuY3Rpb24oZWxlbWVudCwgb3BhY2l0eSl7CgllbGVtZW50LnN0b3JlKCckb3BhY2l0eScsIG9wYWNpdHkpOwoJZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gb3BhY2l0eSA+IDAgfHwgb3BhY2l0eSA9PSBudWxsID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7Cn07Cgp2YXIgc2V0T3BhY2l0eSA9IChoYXNPcGFjaXR5ID8gZnVuY3Rpb24oZWxlbWVudCwgb3BhY2l0eSl7CgllbGVtZW50LnN0eWxlLm9wYWNpdHkgPSBvcGFjaXR5Owp9IDogKGhhc0ZpbHRlciA/IGZ1bmN0aW9uKGVsZW1lbnQsIG9wYWNpdHkpewoJdmFyIHN0eWxlID0gZWxlbWVudC5zdHlsZTsKCWlmICghZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgIWVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkgc3R5bGUuem9vbSA9IDE7CglpZiAob3BhY2l0eSA9PSBudWxsIHx8IG9wYWNpdHkgPT0gMSkgb3BhY2l0eSA9ICcnOwoJZWxzZSBvcGFjaXR5ID0gJ2FscGhhKG9wYWNpdHk9JyArIChvcGFjaXR5ICogMTAwKS5saW1pdCgwLCAxMDApLnJvdW5kKCkgKyAnKSc7Cgl2YXIgZmlsdGVyID0gc3R5bGUuZmlsdGVyIHx8IGVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykgfHwgJyc7CglzdHlsZS5maWx0ZXIgPSByZUFscGhhLnRlc3QoZmlsdGVyKSA/IGZpbHRlci5yZXBsYWNlKHJlQWxwaGEsIG9wYWNpdHkpIDogZmlsdGVyICsgb3BhY2l0eTsKCWlmICghc3R5bGUuZmlsdGVyKSBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUoJ2ZpbHRlcicpOwp9IDogc2V0VmlzaWJpbGl0eSkpOwoKdmFyIGdldE9wYWNpdHkgPSAoaGFzT3BhY2l0eSA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIG9wYWNpdHkgPSBlbGVtZW50LnN0eWxlLm9wYWNpdHkgfHwgZWxlbWVudC5nZXRDb21wdXRlZFN0eWxlKCdvcGFjaXR5Jyk7CglyZXR1cm4gKG9wYWNpdHkgPT0gJycpID8gMSA6IG9wYWNpdHkudG9GbG9hdCgpOwp9IDogKGhhc0ZpbHRlciA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIGZpbHRlciA9IChlbGVtZW50LnN0eWxlLmZpbHRlciB8fCBlbGVtZW50LmdldENvbXB1dGVkU3R5bGUoJ2ZpbHRlcicpKSwKCQlvcGFjaXR5OwoJaWYgKGZpbHRlcikgb3BhY2l0eSA9IGZpbHRlci5tYXRjaChyZUFscGhhKTsKCXJldHVybiAob3BhY2l0eSA9PSBudWxsIHx8IGZpbHRlciA9PSBudWxsKSA/IDEgOiAob3BhY2l0eVsxXSAvIDEwMCk7Cn0gOiBmdW5jdGlvbihlbGVtZW50KXsKCXZhciBvcGFjaXR5ID0gZWxlbWVudC5yZXRyaWV2ZSgnJG9wYWNpdHknKTsKCWlmIChvcGFjaXR5ID09IG51bGwpIG9wYWNpdHkgPSAoZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID09ICdoaWRkZW4nID8gMCA6IDEpOwoJcmV0dXJuIG9wYWNpdHk7Cn0pKTsKCnZhciBmbG9hdE5hbWUgPSAoaHRtbC5zdHlsZS5jc3NGbG9hdCA9PSBudWxsKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgpFbGVtZW50LmltcGxlbWVudCh7CgoJZ2V0Q29tcHV0ZWRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmICh0aGlzLmN1cnJlbnRTdHlsZSkgcmV0dXJuIHRoaXMuY3VycmVudFN0eWxlW3Byb3BlcnR5LmNhbWVsQ2FzZSgpXTsKCQl2YXIgZGVmYXVsdFZpZXcgPSBFbGVtZW50LmdldERvY3VtZW50KHRoaXMpLmRlZmF1bHRWaWV3LAoJCQljb21wdXRlZCA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCBudWxsKSA6IG51bGw7CgkJcmV0dXJuIChjb21wdXRlZCkgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKChwcm9wZXJ0eSA9PSBmbG9hdE5hbWUpID8gJ2Zsb2F0JyA6IHByb3BlcnR5Lmh5cGhlbmF0ZSgpKSA6IG51bGw7Cgl9LAoKCXNldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCWlmIChwcm9wZXJ0eSA9PSAnb3BhY2l0eScpewoJCQlpZiAodmFsdWUgIT0gbnVsbCkgdmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKCQkJc2V0T3BhY2l0eSh0aGlzLCB2YWx1ZSk7CgkJCXJldHVybiB0aGlzOwoJCX0KCQlwcm9wZXJ0eSA9IChwcm9wZXJ0eSA9PSAnZmxvYXQnID8gZmxvYXROYW1lIDogcHJvcGVydHkpLmNhbWVsQ2FzZSgpOwoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdzdHJpbmcnKXsKCQkJdmFyIG1hcCA9IChFbGVtZW50LlN0eWxlc1twcm9wZXJ0eV0gfHwgJ0AnKS5zcGxpdCgnICcpOwoJCQl2YWx1ZSA9IEFycmF5LmZyb20odmFsdWUpLm1hcChmdW5jdGlvbih2YWwsIGkpewoJCQkJaWYgKCFtYXBbaV0pIHJldHVybiAnJzsKCQkJCXJldHVybiAodHlwZU9mKHZhbCkgPT0gJ251bWJlcicpID8gbWFwW2ldLnJlcGxhY2UoJ0AnLCBNYXRoLnJvdW5kKHZhbCkpIDogdmFsOwoJCQl9KS5qb2luKCcgJyk7CgkJfSBlbHNlIGlmICh2YWx1ZSA9PSBTdHJpbmcoTnVtYmVyKHZhbHVlKSkpewoJCQl2YWx1ZSA9IE1hdGgucm91bmQodmFsdWUpOwoJCX0KCQl0aGlzLnN0eWxlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCS8vPGx0SUU5PgoJCWlmICgodmFsdWUgPT0gJycgfHwgdmFsdWUgPT0gbnVsbCkgJiYgZG9lc05vdFJlbW92ZVN0eWxlcyAmJiB0aGlzLnN0eWxlLnJlbW92ZUF0dHJpYnV0ZSl7CgkJCXRoaXMuc3R5bGUucmVtb3ZlQXR0cmlidXRlKHByb3BlcnR5KTsKCQl9CgkJLy88L2x0SUU5PgoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmIChwcm9wZXJ0eSA9PSAnb3BhY2l0eScpIHJldHVybiBnZXRPcGFjaXR5KHRoaXMpOwoJCXByb3BlcnR5ID0gKHByb3BlcnR5ID09ICdmbG9hdCcgPyBmbG9hdE5hbWUgOiBwcm9wZXJ0eSkuY2FtZWxDYXNlKCk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuc3R5bGVbcHJvcGVydHldOwoJCWlmICghcmVzdWx0IHx8IHByb3BlcnR5ID09ICd6SW5kZXgnKXsKCQkJcmVzdWx0ID0gW107CgkJCWZvciAodmFyIHN0eWxlIGluIEVsZW1lbnQuU2hvcnRTdHlsZXMpewoJCQkJaWYgKHByb3BlcnR5ICE9IHN0eWxlKSBjb250aW51ZTsKCQkJCWZvciAodmFyIHMgaW4gRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJlc3VsdC5wdXNoKHRoaXMuZ2V0U3R5bGUocykpOwoJCQkJcmV0dXJuIHJlc3VsdC5qb2luKCcgJyk7CgkJCX0KCQkJcmVzdWx0ID0gdGhpcy5nZXRDb21wdXRlZFN0eWxlKHByb3BlcnR5KTsKCQl9CgkJaWYgKHJlc3VsdCl7CgkJCXJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwoJCQl2YXIgY29sb3IgPSByZXN1bHQubWF0Y2goL3JnYmE/XChbXGRccyxdK1wpLyk7CgkJCWlmIChjb2xvcikgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoY29sb3JbMF0sIGNvbG9yWzBdLnJnYlRvSGV4KCkpOwoJCX0KCQlpZiAoQnJvd3Nlci5pZSAmJiBpc05hTihwYXJzZUZsb2F0KHJlc3VsdCkpKXsKCQkJaWYgKCgvXihoZWlnaHR8d2lkdGgpJC8pLnRlc3QocHJvcGVydHkpKXsKCQkJCXZhciB2YWx1ZXMgPSAocHJvcGVydHkgPT0gJ3dpZHRoJykgPyBbJ2xlZnQnLCAncmlnaHQnXSA6IFsndG9wJywgJ2JvdHRvbSddLCBzaXplID0gMDsKCQkJCXZhbHVlcy5lYWNoKGZ1bmN0aW9uKHZhbHVlKXsKCQkJCQlzaXplICs9IHRoaXMuZ2V0U3R5bGUoJ2JvcmRlci0nICsgdmFsdWUgKyAnLXdpZHRoJykudG9JbnQoKSArIHRoaXMuZ2V0U3R5bGUoJ3BhZGRpbmctJyArIHZhbHVlKS50b0ludCgpOwoJCQkJfSwgdGhpcyk7CgkJCQlyZXR1cm4gdGhpc1snb2Zmc2V0JyArIHByb3BlcnR5LmNhcGl0YWxpemUoKV0gLSBzaXplICsgJ3B4JzsKCQkJfQoJCQlpZiAoQnJvd3Nlci5vcGVyYSAmJiBTdHJpbmcocmVzdWx0KS5pbmRleE9mKCdweCcpICE9IC0xKSByZXR1cm4gcmVzdWx0OwoJCQlpZiAoKC9eYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykudGVzdChwcm9wZXJ0eSkpIHJldHVybiAnMHB4JzsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewoJCWZvciAodmFyIHN0eWxlIGluIHN0eWxlcykgdGhpcy5zZXRTdHlsZShzdHlsZSwgc3R5bGVzW3N0eWxlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0ID0ge307CgkJQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLmVhY2goZnVuY3Rpb24oa2V5KXsKCQkJcmVzdWx0W2tleV0gPSB0aGlzLmdldFN0eWxlKGtleSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCn0pOwoKRWxlbWVudC5TdHlsZXMgPSB7CglsZWZ0OiAnQHB4JywgdG9wOiAnQHB4JywgYm90dG9tOiAnQHB4JywgcmlnaHQ6ICdAcHgnLAoJd2lkdGg6ICdAcHgnLCBoZWlnaHQ6ICdAcHgnLCBtYXhXaWR0aDogJ0BweCcsIG1heEhlaWdodDogJ0BweCcsIG1pbldpZHRoOiAnQHB4JywgbWluSGVpZ2h0OiAnQHB4JywKCWJhY2tncm91bmRDb2xvcjogJ3JnYihALCBALCBAKScsIGJhY2tncm91bmRQb3NpdGlvbjogJ0BweCBAcHgnLCBjb2xvcjogJ3JnYihALCBALCBAKScsCglmb250U2l6ZTogJ0BweCcsIGxldHRlclNwYWNpbmc6ICdAcHgnLCBsaW5lSGVpZ2h0OiAnQHB4JywgY2xpcDogJ3JlY3QoQHB4IEBweCBAcHggQHB4KScsCgltYXJnaW46ICdAcHggQHB4IEBweCBAcHgnLCBwYWRkaW5nOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyOiAnQHB4IEAgcmdiKEAsIEAsIEApIEBweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCknLAoJYm9yZGVyV2lkdGg6ICdAcHggQHB4IEBweCBAcHgnLCBib3JkZXJTdHlsZTogJ0AgQCBAIEAnLCBib3JkZXJDb2xvcjogJ3JnYihALCBALCBAKSByZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKScsCgl6SW5kZXg6ICdAJywgJ3pvb20nOiAnQCcsIGZvbnRXZWlnaHQ6ICdAJywgdGV4dEluZGVudDogJ0BweCcsIG9wYWNpdHk6ICdAJwp9OwoKCgoKCkVsZW1lbnQuU2hvcnRTdHlsZXMgPSB7bWFyZ2luOiB7fSwgcGFkZGluZzoge30sIGJvcmRlcjoge30sIGJvcmRlcldpZHRoOiB7fSwgYm9yZGVyU3R5bGU6IHt9LCBib3JkZXJDb2xvcjoge319OwoKWydUb3AnLCAnUmlnaHQnLCAnQm90dG9tJywgJ0xlZnQnXS5lYWNoKGZ1bmN0aW9uKGRpcmVjdGlvbil7Cgl2YXIgU2hvcnQgPSBFbGVtZW50LlNob3J0U3R5bGVzOwoJdmFyIEFsbCA9IEVsZW1lbnQuU3R5bGVzOwoJWydtYXJnaW4nLCAncGFkZGluZyddLmVhY2goZnVuY3Rpb24oc3R5bGUpewoJCXZhciBzZCA9IHN0eWxlICsgZGlyZWN0aW9uOwoJCVNob3J0W3N0eWxlXVtzZF0gPSBBbGxbc2RdID0gJ0BweCc7Cgl9KTsKCXZhciBiZCA9ICdib3JkZXInICsgZGlyZWN0aW9uOwoJU2hvcnQuYm9yZGVyW2JkXSA9IEFsbFtiZF0gPSAnQHB4IEAgcmdiKEAsIEAsIEApJzsKCXZhciBiZHcgPSBiZCArICdXaWR0aCcsIGJkcyA9IGJkICsgJ1N0eWxlJywgYmRjID0gYmQgKyAnQ29sb3InOwoJU2hvcnRbYmRdID0ge307CglTaG9ydC5ib3JkZXJXaWR0aFtiZHddID0gU2hvcnRbYmRdW2Jkd10gPSBBbGxbYmR3XSA9ICdAcHgnOwoJU2hvcnQuYm9yZGVyU3R5bGVbYmRzXSA9IFNob3J0W2JkXVtiZHNdID0gQWxsW2Jkc10gPSAnQCc7CglTaG9ydC5ib3JkZXJDb2xvcltiZGNdID0gU2hvcnRbYmRdW2JkY10gPSBBbGxbYmRjXSA9ICdyZ2IoQCwgQCwgQCknOwp9KTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRWxlbWVudCBtZXRob2RzIGZvciBkZWFsaW5nIHdpdGggZXZlbnRzLiBUaGlzIGZpbGUgYWxzbyBpbmNsdWRlcyBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlIGN1c3RvbSBFbGVtZW50IEV2ZW50cywgaWYgbmVjZXNzYXJ5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQsIEV2ZW50XQoKcHJvdmlkZXM6IEVsZW1lbnQuRXZlbnQKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7CgpFbGVtZW50LlByb3BlcnRpZXMuZXZlbnRzID0ge3NldDogZnVuY3Rpb24oZXZlbnRzKXsKCXRoaXMuYWRkRXZlbnRzKGV2ZW50cyk7Cn19OwoKW0VsZW1lbnQsIFdpbmRvdywgRG9jdW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycsIHt9KTsKCQlpZiAoIWV2ZW50c1t0eXBlXSkgZXZlbnRzW3R5cGVdID0ge2tleXM6IFtdLCB2YWx1ZXM6IFtdfTsKCQlpZiAoZXZlbnRzW3R5cGVdLmtleXMuY29udGFpbnMoZm4pKSByZXR1cm4gdGhpczsKCQlldmVudHNbdHlwZV0ua2V5cy5wdXNoKGZuKTsKCQl2YXIgcmVhbFR5cGUgPSB0eXBlLAoJCQljdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXSwKCQkJY29uZGl0aW9uID0gZm4sCgkJCXNlbGYgPSB0aGlzOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLm9uQWRkKSBjdXN0b20ub25BZGQuY2FsbCh0aGlzLCBmbiwgdHlwZSk7CgkJCWlmIChjdXN0b20uY29uZGl0aW9uKXsKCQkJCWNvbmRpdGlvbiA9IGZ1bmN0aW9uKGV2ZW50KXsKCQkJCQlpZiAoY3VzdG9tLmNvbmRpdGlvbi5jYWxsKHRoaXMsIGV2ZW50LCB0eXBlKSkgcmV0dXJuIGZuLmNhbGwodGhpcywgZXZlbnQpOwoJCQkJCXJldHVybiB0cnVlOwoJCQkJfTsKCQkJfQoJCQlpZiAoY3VzdG9tLmJhc2UpIHJlYWxUeXBlID0gRnVuY3Rpb24uZnJvbShjdXN0b20uYmFzZSkuY2FsbCh0aGlzLCB0eXBlKTsKCQl9CgkJdmFyIGRlZm4gPSBmdW5jdGlvbigpewoJCQlyZXR1cm4gZm4uY2FsbChzZWxmKTsKCQl9OwoJCXZhciBuYXRpdmVFdmVudCA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzW3JlYWxUeXBlXTsKCQlpZiAobmF0aXZlRXZlbnQpewoJCQlpZiAobmF0aXZlRXZlbnQgPT0gMil7CgkJCQlkZWZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWV2ZW50ID0gbmV3IERPTUV2ZW50KGV2ZW50LCBzZWxmLmdldFdpbmRvdygpKTsKCQkJCQlpZiAoY29uZGl0aW9uLmNhbGwoc2VsZiwgZXZlbnQpID09PSBmYWxzZSkgZXZlbnQuc3RvcCgpOwoJCQkJfTsKCQkJfQoJCQl0aGlzLmFkZExpc3RlbmVyKHJlYWxUeXBlLCBkZWZuLCBhcmd1bWVudHNbMl0pOwoJCX0KCQlldmVudHNbdHlwZV0udmFsdWVzLnB1c2goZGVmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzIHx8ICFldmVudHNbdHlwZV0pIHJldHVybiB0aGlzOwoJCXZhciBsaXN0ID0gZXZlbnRzW3R5cGVdOwoJCXZhciBpbmRleCA9IGxpc3Qua2V5cy5pbmRleE9mKGZuKTsKCQlpZiAoaW5kZXggPT0gLTEpIHJldHVybiB0aGlzOwoJCXZhciB2YWx1ZSA9IGxpc3QudmFsdWVzW2luZGV4XTsKCQlkZWxldGUgbGlzdC5rZXlzW2luZGV4XTsKCQlkZWxldGUgbGlzdC52YWx1ZXNbaW5kZXhdOwoJCXZhciBjdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXTsKCQlpZiAoY3VzdG9tKXsKCQkJaWYgKGN1c3RvbS5vblJlbW92ZSkgY3VzdG9tLm9uUmVtb3ZlLmNhbGwodGhpcywgZm4sIHR5cGUpOwoJCQlpZiAoY3VzdG9tLmJhc2UpIHR5cGUgPSBGdW5jdGlvbi5mcm9tKGN1c3RvbS5iYXNlKS5jYWxsKHRoaXMsIHR5cGUpOwoJCX0KCQlyZXR1cm4gKEVsZW1lbnQuTmF0aXZlRXZlbnRzW3R5cGVdKSA/IHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgdmFsdWUsIGFyZ3VtZW50c1syXSkgOiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KGV2ZW50LCBldmVudHNbZXZlbnRdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXZhciBhdHRhY2hlZCA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghYXR0YWNoZWQpIHJldHVybiB0aGlzOwoJCWlmICghZXZlbnRzKXsKCQkJZm9yICh0eXBlIGluIGF0dGFjaGVkKSB0aGlzLnJlbW92ZUV2ZW50cyh0eXBlKTsKCQkJdGhpcy5lbGltaW5hdGUoJ2V2ZW50cycpOwoJCX0gZWxzZSBpZiAoYXR0YWNoZWRbZXZlbnRzXSl7CgkJCWF0dGFjaGVkW2V2ZW50c10ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQoZXZlbnRzLCBmbik7CgkJCX0sIHRoaXMpOwoJCQlkZWxldGUgYXR0YWNoZWRbZXZlbnRzXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCgkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZUV2ZW50czogZnVuY3Rpb24oZnJvbSwgdHlwZSl7CgkJZnJvbSA9IGRvY3VtZW50LmlkKGZyb20pOwoJCXZhciBldmVudHMgPSBmcm9tLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJaWYgKCF0eXBlKXsKCQkJZm9yICh2YXIgZXZlbnRUeXBlIGluIGV2ZW50cykgdGhpcy5jbG9uZUV2ZW50cyhmcm9tLCBldmVudFR5cGUpOwoJCX0gZWxzZSBpZiAoZXZlbnRzW3R5cGVdKXsKCQkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLmFkZEV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpFbGVtZW50Lk5hdGl2ZUV2ZW50cyA9IHsKCWNsaWNrOiAyLCBkYmxjbGljazogMiwgbW91c2V1cDogMiwgbW91c2Vkb3duOiAyLCBjb250ZXh0bWVudTogMiwgLy9tb3VzZSBidXR0b25zCgltb3VzZXdoZWVsOiAyLCBET01Nb3VzZVNjcm9sbDogMiwgLy9tb3VzZSB3aGVlbAoJbW91c2VvdmVyOiAyLCBtb3VzZW91dDogMiwgbW91c2Vtb3ZlOiAyLCBzZWxlY3RzdGFydDogMiwgc2VsZWN0ZW5kOiAyLCAvL21vdXNlIG1vdmVtZW50CglrZXlkb3duOiAyLCBrZXlwcmVzczogMiwga2V5dXA6IDIsIC8va2V5Ym9hcmQKCW9yaWVudGF0aW9uY2hhbmdlOiAyLCAvLyBtb2JpbGUKCXRvdWNoc3RhcnQ6IDIsIHRvdWNobW92ZTogMiwgdG91Y2hlbmQ6IDIsIHRvdWNoY2FuY2VsOiAyLCAvLyB0b3VjaAoJZ2VzdHVyZXN0YXJ0OiAyLCBnZXN0dXJlY2hhbmdlOiAyLCBnZXN0dXJlZW5kOiAyLCAvLyBnZXN0dXJlCglmb2N1czogMiwgYmx1cjogMiwgY2hhbmdlOiAyLCByZXNldDogMiwgc2VsZWN0OiAyLCBzdWJtaXQ6IDIsIHBhc3RlOiAyLCBpbnB1dDogMiwgLy9mb3JtIGVsZW1lbnRzCglsb2FkOiAyLCB1bmxvYWQ6IDEsIGJlZm9yZXVubG9hZDogMiwgcmVzaXplOiAxLCBtb3ZlOiAxLCBET01Db250ZW50TG9hZGVkOiAxLCByZWFkeXN0YXRlY2hhbmdlOiAxLCAvL3dpbmRvdwoJZXJyb3I6IDEsIGFib3J0OiAxLCBzY3JvbGw6IDEgLy9taXNjCn07CgpFbGVtZW50LkV2ZW50cyA9IHttb3VzZXdoZWVsOiB7CgliYXNlOiAoQnJvd3Nlci5maXJlZm94KSA/ICdET01Nb3VzZVNjcm9sbCcgOiAnbW91c2V3aGVlbCcKfX07CgppZiAoJ29ubW91c2VlbnRlcicgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KXsKCUVsZW1lbnQuTmF0aXZlRXZlbnRzLm1vdXNlZW50ZXIgPSBFbGVtZW50Lk5hdGl2ZUV2ZW50cy5tb3VzZWxlYXZlID0gMjsKfSBlbHNlIHsKCXZhciBjaGVjayA9IGZ1bmN0aW9uKGV2ZW50KXsKCQl2YXIgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CgkJaWYgKHJlbGF0ZWQgPT0gbnVsbCkgcmV0dXJuIHRydWU7CgkJaWYgKCFyZWxhdGVkKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIChyZWxhdGVkICE9IHRoaXMgJiYgcmVsYXRlZC5wcmVmaXggIT0gJ3h1bCcgJiYgdHlwZU9mKHRoaXMpICE9ICdkb2N1bWVudCcgJiYgIXRoaXMuY29udGFpbnMocmVsYXRlZCkpOwoJfTsKCglFbGVtZW50LkV2ZW50cy5tb3VzZWVudGVyID0gewoJCWJhc2U6ICdtb3VzZW92ZXInLAoJCWNvbmRpdGlvbjogY2hlY2sKCX07CgoJRWxlbWVudC5FdmVudHMubW91c2VsZWF2ZSA9IHsKCQliYXNlOiAnbW91c2VvdXQnLAoJCWNvbmRpdGlvbjogY2hlY2sKCX07Cn0KCi8qPGx0SUU5PiovCmlmICghd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpewoJRWxlbWVudC5OYXRpdmVFdmVudHMucHJvcGVydHljaGFuZ2UgPSAyOwoJRWxlbWVudC5FdmVudHMuY2hhbmdlID0gewoJCWJhc2U6IGZ1bmN0aW9uKCl7CgkJCXZhciB0eXBlID0gdGhpcy50eXBlOwoJCQlyZXR1cm4gKHRoaXMuZ2V0KCd0YWcnKSA9PSAnaW5wdXQnICYmICh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSkgPyAncHJvcGVydHljaGFuZ2UnIDogJ2NoYW5nZScKCQl9LAoJCWNvbmRpdGlvbjogZnVuY3Rpb24oZXZlbnQpewoJCQlyZXR1cm4gdGhpcy50eXBlICE9ICdyYWRpbycgfHwgKGV2ZW50LmV2ZW50LnByb3BlcnR5TmFtZSA9PSAnY2hlY2tlZCcgJiYgdGhpcy5jaGVja2VkKTsKCQl9Cgl9Cn0KLyo8L2x0SUU5PiovCgoKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkRlbGVnYXRpb24KCmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBFbGVtZW50IG5hdGl2ZSBvYmplY3QgdG8gaW5jbHVkZSB0aGUgZGVsZWdhdGUgbWV0aG9kIGZvciBtb3JlIGVmZmljaWVudCBldmVudCBtYW5hZ2VtZW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0VsZW1lbnQuRGVsZWdhdGlvbl0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZXZlbnRMaXN0ZW5lclN1cHBvcnQgPSAhIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyOwoKRWxlbWVudC5OYXRpdmVFdmVudHMuZm9jdXNpbiA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzLmZvY3Vzb3V0ID0gMjsKCnZhciBidWJibGVVcCA9IGZ1bmN0aW9uKHNlbGYsIG1hdGNoLCBmbiwgZXZlbnQsIHRhcmdldCl7Cgl3aGlsZSAodGFyZ2V0ICYmIHRhcmdldCAhPSBzZWxmKXsKCQlpZiAobWF0Y2godGFyZ2V0LCBldmVudCkpIHJldHVybiBmbi5jYWxsKHRhcmdldCwgZXZlbnQsIHRhcmdldCk7CgkJdGFyZ2V0ID0gZG9jdW1lbnQuaWQodGFyZ2V0LnBhcmVudE5vZGUpOwoJfQp9OwoKdmFyIG1hcCA9IHsKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJwoJfSwKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnCgl9LAoJZm9jdXM6IHsKCQliYXNlOiAnZm9jdXMnICsgKGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJycgOiAnaW4nKSwKCQljYXB0dXJlOiB0cnVlCgl9LAoJYmx1cjogewoJCWJhc2U6IGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJ2JsdXInIDogJ2ZvY3Vzb3V0JywKCQljYXB0dXJlOiB0cnVlCgl9Cn07CgovKjxsdElFOT4qLwp2YXIgX2tleSA9ICckZGVsZWdhdGlvbjonOwp2YXIgZm9ybU9ic2VydmVyID0gZnVuY3Rpb24odHlwZSl7CgoJcmV0dXJuIHsKCgkJYmFzZTogJ2ZvY3VzaW4nLAoKCQlyZW1vdmU6IGZ1bmN0aW9uKHNlbGYsIHVpZCl7CgkJCXZhciBsaXN0ID0gc2VsZi5yZXRyaWV2ZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCB7fSlbdWlkXTsKCQkJaWYgKGxpc3QgJiYgbGlzdC5mb3JtcykgZm9yICh2YXIgaSA9IGxpc3QuZm9ybXMubGVuZ3RoOyBpLS07KXsKCQkJCWxpc3QuZm9ybXNbaV0ucmVtb3ZlRXZlbnQodHlwZSwgbGlzdC5mbnNbaV0pOwoJCQl9CgkJfSwKCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCl7CgkJCXZhciBmb3JtID0gKHRhcmdldC5nZXQoJ3RhZycpID09ICdmb3JtJykgPyB0YXJnZXQgOiBldmVudC50YXJnZXQuZ2V0UGFyZW50KCdmb3JtJyk7CgkJCWlmICghZm9ybSkgcmV0dXJuOwoKCQkJdmFyIGxpc3RlbmVycyA9IHNlbGYucmV0cmlldmUoX2tleSArIHR5cGUgKyAnbGlzdGVuZXJzJywge30pLAoJCQkJbGlzdGVuZXIgPSBsaXN0ZW5lcnNbdWlkXSB8fCB7Zm9ybXM6IFtdLCBmbnM6IFtdfSwKCQkJCWZvcm1zID0gbGlzdGVuZXIuZm9ybXMsIGZucyA9IGxpc3RlbmVyLmZuczsKCgkJCWlmIChmb3Jtcy5pbmRleE9mKGZvcm0pICE9IC0xKSByZXR1cm47CgkJCWZvcm1zLnB1c2goZm9ybSk7CgoJCQl2YXIgX2ZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZm9ybS5hZGRFdmVudCh0eXBlLCBfZm4pOwoJCQlmbnMucHVzaChfZm4pOwoKCQkJbGlzdGVuZXJzW3VpZF0gPSBsaXN0ZW5lcjsKCQkJc2VsZi5zdG9yZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCBsaXN0ZW5lcnMpOwoJCX0KCX07Cn07Cgp2YXIgaW5wdXRPYnNlcnZlciA9IGZ1bmN0aW9uKHR5cGUpewoJcmV0dXJuIHsKCQliYXNlOiAnZm9jdXNpbicsCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQpewoJCQl2YXIgZXZlbnRzID0ge2JsdXI6IGZ1bmN0aW9uKCl7CgkJCQl0aGlzLnJlbW92ZUV2ZW50cyhldmVudHMpOwoJCQl9fTsKCQkJZXZlbnRzW3R5cGVdID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZXZlbnQudGFyZ2V0LmFkZEV2ZW50cyhldmVudHMpOwoJCX0KCX07Cn07CgppZiAoIWV2ZW50TGlzdGVuZXJTdXBwb3J0KSBPYmplY3QuYXBwZW5kKG1hcCwgewoJc3VibWl0OiBmb3JtT2JzZXJ2ZXIoJ3N1Ym1pdCcpLAoJcmVzZXQ6IGZvcm1PYnNlcnZlcigncmVzZXQnKSwKCWNoYW5nZTogaW5wdXRPYnNlcnZlcignY2hhbmdlJyksCglzZWxlY3Q6IGlucHV0T2JzZXJ2ZXIoJ3NlbGVjdCcpCn0pOwovKjwvbHRJRTk+Ki8KCnZhciBwcm90byA9IEVsZW1lbnQucHJvdG90eXBlLAoJYWRkRXZlbnQgPSBwcm90by5hZGRFdmVudCwKCXJlbW92ZUV2ZW50ID0gcHJvdG8ucmVtb3ZlRXZlbnQ7Cgp2YXIgcmVsYXkgPSBmdW5jdGlvbihvbGQsIG1ldGhvZCl7CglyZXR1cm4gZnVuY3Rpb24odHlwZSwgZm4sIHVzZUNhcHR1cmUpewoJCWlmICh0eXBlLmluZGV4T2YoJzpyZWxheScpID09IC0xKSByZXR1cm4gb2xkLmNhbGwodGhpcywgdHlwZSwgZm4sIHVzZUNhcHR1cmUpOwoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0eXBlKS5leHByZXNzaW9uc1swXVswXTsKCQlpZiAocGFyc2VkLnBzZXVkb3NbMF0ua2V5ICE9ICdyZWxheScpIHJldHVybiBvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbiwgdXNlQ2FwdHVyZSk7CgkJdmFyIG5ld1R5cGUgPSBwYXJzZWQudGFnOwoJCXBhcnNlZC5wc2V1ZG9zLnNsaWNlKDEpLmVhY2goZnVuY3Rpb24ocHNldWRvKXsKCQkJbmV3VHlwZSArPSAnOicgKyBwc2V1ZG8ua2V5ICsgKHBzZXVkby52YWx1ZSA/ICcoJyArIHBzZXVkby52YWx1ZSArICcpJyA6ICcnKTsKCQl9KTsKCQlvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbik7CgkJcmV0dXJuIG1ldGhvZC5jYWxsKHRoaXMsIG5ld1R5cGUsIHBhcnNlZC5wc2V1ZG9zWzBdLnZhbHVlLCBmbik7Cgl9Owp9OwoKdmFyIGRlbGVnYXRpb24gPSB7CgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIG1hdGNoLCBmbil7CgkJdmFyIHN0b3JhZ2UgPSB0aGlzLnJldHJpZXZlKCckZGVsZWdhdGVzJywge30pLCBzdG9yZWQgPSBzdG9yYWdlW3R5cGVdOwoJCWlmIChzdG9yZWQpIGZvciAodmFyIF91aWQgaW4gc3RvcmVkKXsKCQkJaWYgKHN0b3JlZFtfdWlkXS5mbiA9PSBmbiAmJiBzdG9yZWRbX3VpZF0ubWF0Y2ggPT0gbWF0Y2gpIHJldHVybiB0aGlzOwoJCX0KCgkJdmFyIF90eXBlID0gdHlwZSwgX21hdGNoID0gbWF0Y2gsIF9mbiA9IGZuLCBfbWFwID0gbWFwW3R5cGVdIHx8IHt9OwoJCXR5cGUgPSBfbWFwLmJhc2UgfHwgX3R5cGU7CgoJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0KXsKCQkJcmV0dXJuIFNsaWNrLm1hdGNoKHRhcmdldCwgX21hdGNoKTsKCQl9OwoKCQl2YXIgZWxlbWVudEV2ZW50ID0gRWxlbWVudC5FdmVudHNbX3R5cGVdOwoJCWlmIChlbGVtZW50RXZlbnQgJiYgZWxlbWVudEV2ZW50LmNvbmRpdGlvbil7CgkJCXZhciBfX21hdGNoID0gbWF0Y2gsIGNvbmRpdGlvbiA9IGVsZW1lbnRFdmVudC5jb25kaXRpb247CgkJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0LCBldmVudCl7CgkJCQlyZXR1cm4gX19tYXRjaCh0YXJnZXQsIGV2ZW50KSAmJiBjb25kaXRpb24uY2FsbCh0YXJnZXQsIGV2ZW50LCB0eXBlKTsKCQkJfTsKCQl9CgoJCXZhciBzZWxmID0gdGhpcywgdWlkID0gU3RyaW5nLnVuaXF1ZUlEKCk7CgkJdmFyIGRlbGVnYXRvciA9IF9tYXAubGlzdGVuID8gZnVuY3Rpb24oZXZlbnQsIHRhcmdldCl7CgkJCWlmICghdGFyZ2V0ICYmIGV2ZW50ICYmIGV2ZW50LnRhcmdldCkgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCQlpZiAodGFyZ2V0KSBfbWFwLmxpc3RlbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCk7CgkJfSA6IGZ1bmN0aW9uKGV2ZW50LCB0YXJnZXQpewoJCQlpZiAoIXRhcmdldCAmJiBldmVudCAmJiBldmVudC50YXJnZXQpIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQkJaWYgKHRhcmdldCkgYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQl9OwoKCQlpZiAoIXN0b3JlZCkgc3RvcmVkID0ge307CgkJc3RvcmVkW3VpZF0gPSB7CgkJCW1hdGNoOiBfbWF0Y2gsCgkJCWZuOiBfZm4sCgkJCWRlbGVnYXRvcjogZGVsZWdhdG9yCgkJfTsKCQlzdG9yYWdlW190eXBlXSA9IHN0b3JlZDsKCQlyZXR1cm4gYWRkRXZlbnQuY2FsbCh0aGlzLCB0eXBlLCBkZWxlZ2F0b3IsIF9tYXAuY2FwdHVyZSk7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBtYXRjaCwgZm4sIF91aWQpewoJCXZhciBzdG9yYWdlID0gdGhpcy5yZXRyaWV2ZSgnJGRlbGVnYXRlcycsIHt9KSwgc3RvcmVkID0gc3RvcmFnZVt0eXBlXTsKCQlpZiAoIXN0b3JlZCkgcmV0dXJuIHRoaXM7CgoJCWlmIChfdWlkKXsKCQkJdmFyIF90eXBlID0gdHlwZSwgZGVsZWdhdG9yID0gc3RvcmVkW191aWRdLmRlbGVnYXRvciwgX21hcCA9IG1hcFt0eXBlXSB8fCB7fTsKCQkJdHlwZSA9IF9tYXAuYmFzZSB8fCBfdHlwZTsKCQkJaWYgKF9tYXAucmVtb3ZlKSBfbWFwLnJlbW92ZSh0aGlzLCBfdWlkKTsKCQkJZGVsZXRlIHN0b3JlZFtfdWlkXTsKCQkJc3RvcmFnZVtfdHlwZV0gPSBzdG9yZWQ7CgkJCXJldHVybiByZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIGRlbGVnYXRvcik7CgkJfQoKCQl2YXIgX191aWQsIHM7CgkJaWYgKGZuKSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCAmJiBzLmZuID09IGZuKSByZXR1cm4gZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBmbiwgX191aWQpOwoJCX0gZWxzZSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCkgZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBzLmZuLCBfX3VpZCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfTsKCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCWFkZEV2ZW50OiByZWxheShhZGRFdmVudCwgZGVsZWdhdGlvbi5hZGRFdmVudCksCglyZW1vdmVFdmVudDogcmVsYXkocmVtb3ZlRXZlbnQsIGRlbGVnYXRpb24ucmVtb3ZlRXZlbnQpCn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQuRGltZW5zaW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgdG8gd29yayB3aXRoIHNpemUsIHNjcm9sbCwgb3IgcG9zaXRpb25pbmcgb2YgRWxlbWVudHMgYW5kIHRoZSB3aW5kb3cgb2JqZWN0LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRWxlbWVudCBwb3NpdGlvbmluZyBiYXNlZCBvbiB0aGUgW3Fvb3hkb29dKGh0dHA6Ly9xb294ZG9vLm9yZy8pIGNvZGUgYW5kIHNtYXJ0IGJyb3dzZXIgZml4ZXMsIFtMR1BMIExpY2Vuc2VdKGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWwpLgogIC0gVmlld3BvcnQgZGltZW5zaW9ucyBiYXNlZCBvbiBbWVVJXShodHRwOi8vZGV2ZWxvcGVyLnlhaG9vLmNvbS95dWkvKSBjb2RlLCBbQlNEIExpY2Vuc2VdKGh0dHA6Ly9kZXZlbG9wZXIueWFob28uY29tL3l1aS9saWNlbnNlLmh0bWwpLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBFbGVtZW50LlN0eWxlXQoKcHJvdmlkZXM6IFtFbGVtZW50LkRpbWVuc2lvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKCWNoaWxkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJzAnOwplbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKdmFyIGJyb2tlbk9mZnNldFBhcmVudCA9IChjaGlsZC5vZmZzZXRQYXJlbnQgPT09IGVsZW1lbnQpOwplbGVtZW50ID0gY2hpbGQgPSBudWxsOwoKdmFyIGlzT2Zmc2V0ID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIHN0eWxlU3RyaW5nKGVsLCAncG9zaXRpb24nKSAhPSAnc3RhdGljJyB8fCBpc0JvZHkoZWwpOwp9OwoKdmFyIGlzT2Zmc2V0U3RhdGljID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIGlzT2Zmc2V0KGVsKSB8fCAoL14oPzp0YWJsZXx0ZHx0aCkkL2kpLnRlc3QoZWwudGFnTmFtZSk7Cn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2Nyb2xsVG86IGZ1bmN0aW9uKHgsIHkpewoJCWlmIChpc0JvZHkodGhpcykpewoJCQl0aGlzLmdldFdpbmRvdygpLnNjcm9sbFRvKHgsIHkpOwoJCX0gZWxzZSB7CgkJCXRoaXMuc2Nyb2xsTGVmdCA9IHg7CgkJCXRoaXMuc2Nyb2xsVG9wID0geTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFNpemU6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2l6ZSgpOwoJCXJldHVybiB7eDogdGhpcy5vZmZzZXRXaWR0aCwgeTogdGhpcy5vZmZzZXRIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGxTaXplOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbFNpemUoKTsKCQlyZXR1cm4ge3g6IHRoaXMuc2Nyb2xsV2lkdGgsIHk6IHRoaXMuc2Nyb2xsSGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbCgpOwoJCXJldHVybiB7eDogdGhpcy5zY3JvbGxMZWZ0LCB5OiB0aGlzLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbHM6IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzLnBhcmVudE5vZGUsIHBvc2l0aW9uID0ge3g6IDAsIHk6IDB9OwoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQuc2Nyb2xsTGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50LnNjcm9sbFRvcDsKCQkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRPZmZzZXRQYXJlbnQ6IGJyb2tlbk9mZnNldFBhcmVudCA/IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzOwoJCWlmIChpc0JvZHkoZWxlbWVudCkgfHwgc3R5bGVTdHJpbmcoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJykgcmV0dXJuIG51bGw7CgoJCXZhciBpc09mZnNldENoZWNrID0gKHN0eWxlU3RyaW5nKGVsZW1lbnQsICdwb3NpdGlvbicpID09ICdzdGF0aWMnKSA/IGlzT2Zmc2V0U3RhdGljIDogaXNPZmZzZXQ7CgkJd2hpbGUgKChlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlKSl7CgkJCWlmIChpc09mZnNldENoZWNrKGVsZW1lbnQpKSByZXR1cm4gZWxlbWVudDsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9IDogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXM7CgkJaWYgKGlzQm9keShlbGVtZW50KSB8fCBzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSByZXR1cm4gbnVsbDsKCgkJdHJ5IHsKCQkJcmV0dXJuIGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0gY2F0Y2goZSkge30KCQlyZXR1cm4gbnVsbDsKCX0sCgoJZ2V0T2Zmc2V0czogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QgJiYgIUJyb3dzZXIuUGxhdGZvcm0uaW9zKXsKCQkJdmFyIGJvdW5kID0gdGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKCQkJCWh0bWwgPSBkb2N1bWVudC5pZCh0aGlzLmdldERvY3VtZW50KCkuZG9jdW1lbnRFbGVtZW50KSwKCQkJCWh0bWxTY3JvbGwgPSBodG1sLmdldFNjcm9sbCgpLAoJCQkJZWxlbVNjcm9sbHMgPSB0aGlzLmdldFNjcm9sbHMoKSwKCQkJCWlzRml4ZWQgPSAoc3R5bGVTdHJpbmcodGhpcywgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJyk7CgoJCQlyZXR1cm4gewoJCQkJeDogYm91bmQubGVmdC50b0ludCgpICsgZWxlbVNjcm9sbHMueCArICgoaXNGaXhlZCkgPyAwIDogaHRtbFNjcm9sbC54KSAtIGh0bWwuY2xpZW50TGVmdCwKCQkJCXk6IGJvdW5kLnRvcC50b0ludCgpICArIGVsZW1TY3JvbGxzLnkgKyAoKGlzRml4ZWQpID8gMCA6IGh0bWxTY3JvbGwueSkgLSBodG1sLmNsaWVudFRvcAoJCQl9OwoJCX0KCgkJdmFyIGVsZW1lbnQgPSB0aGlzLCBwb3NpdGlvbiA9IHt4OiAwLCB5OiAwfTsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gcG9zaXRpb247CgoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQub2Zmc2V0TGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50Lm9mZnNldFRvcDsKCgkJCWlmIChCcm93c2VyLmZpcmVmb3gpewoJCQkJaWYgKCFib3JkZXJCb3goZWxlbWVudCkpewoJCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihlbGVtZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJCX0KCQkJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJCQlpZiAocGFyZW50ICYmIHN0eWxlU3RyaW5nKHBhcmVudCwgJ292ZXJmbG93JykgIT0gJ3Zpc2libGUnKXsKCQkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIocGFyZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihwYXJlbnQpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKGVsZW1lbnQgIT0gdGhpcyAmJiBCcm93c2VyLnNhZmFyaSl7CgkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIoZWxlbWVudCk7CgkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJfQoKCQkJZWxlbWVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0KCQlpZiAoQnJvd3Nlci5maXJlZm94ICYmICFib3JkZXJCb3godGhpcykpewoJCQlwb3NpdGlvbi54IC09IGxlZnRCb3JkZXIodGhpcyk7CgkJCXBvc2l0aW9uLnkgLT0gdG9wQm9yZGVyKHRoaXMpOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldFBvc2l0aW9uOiBmdW5jdGlvbihyZWxhdGl2ZSl7CgkJdmFyIG9mZnNldCA9IHRoaXMuZ2V0T2Zmc2V0cygpLAoJCQlzY3JvbGwgPSB0aGlzLmdldFNjcm9sbHMoKTsKCQl2YXIgcG9zaXRpb24gPSB7CgkJCXg6IG9mZnNldC54IC0gc2Nyb2xsLngsCgkJCXk6IG9mZnNldC55IC0gc2Nyb2xsLnkKCQl9OwoKCQlpZiAocmVsYXRpdmUgJiYgKHJlbGF0aXZlID0gZG9jdW1lbnQuaWQocmVsYXRpdmUpKSl7CgkJCXZhciByZWxhdGl2ZVBvc2l0aW9uID0gcmVsYXRpdmUuZ2V0UG9zaXRpb24oKTsKCQkJcmV0dXJuIHt4OiBwb3NpdGlvbi54IC0gcmVsYXRpdmVQb3NpdGlvbi54IC0gbGVmdEJvcmRlcihyZWxhdGl2ZSksIHk6IHBvc2l0aW9uLnkgLSByZWxhdGl2ZVBvc2l0aW9uLnkgLSB0b3BCb3JkZXIocmVsYXRpdmUpfTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0Q29vcmRpbmF0ZXMoKTsKCQl2YXIgcG9zaXRpb24gPSB0aGlzLmdldFBvc2l0aW9uKGVsZW1lbnQpLAoJCQlzaXplID0gdGhpcy5nZXRTaXplKCk7CgkJdmFyIG9iaiA9IHsKCQkJbGVmdDogcG9zaXRpb24ueCwKCQkJdG9wOiBwb3NpdGlvbi55LAoJCQl3aWR0aDogc2l6ZS54LAoJCQloZWlnaHQ6IHNpemUueQoJCX07CgkJb2JqLnJpZ2h0ID0gb2JqLmxlZnQgKyBvYmoud2lkdGg7CgkJb2JqLmJvdHRvbSA9IG9iai50b3AgKyBvYmouaGVpZ2h0OwoJCXJldHVybiBvYmo7Cgl9LAoKCWNvbXB1dGVQb3NpdGlvbjogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gewoJCQlsZWZ0OiBvYmoueCAtIHN0eWxlTnVtYmVyKHRoaXMsICdtYXJnaW4tbGVmdCcpLAoJCQl0b3A6IG9iai55IC0gc3R5bGVOdW1iZXIodGhpcywgJ21hcmdpbi10b3AnKQoJCX07Cgl9LAoKCXNldFBvc2l0aW9uOiBmdW5jdGlvbihvYmopewoJCXJldHVybiB0aGlzLnNldFN0eWxlcyh0aGlzLmNvbXB1dGVQb3NpdGlvbihvYmopKTsKCX0KCn0pOwoKCltEb2N1bWVudCwgV2luZG93XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglnZXRTaXplOiBmdW5jdGlvbigpewoJCXZhciBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogZG9jLmNsaWVudFdpZHRoLCB5OiBkb2MuY2xpZW50SGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCXZhciB3aW4gPSB0aGlzLmdldFdpbmRvdygpLCBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogd2luLnBhZ2VYT2Zmc2V0IHx8IGRvYy5zY3JvbGxMZWZ0LCB5OiB3aW4ucGFnZVlPZmZzZXQgfHwgZG9jLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJdmFyIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyksCgkJCW1pbiA9IHRoaXMuZ2V0U2l6ZSgpLAoJCQlib2R5ID0gdGhpcy5nZXREb2N1bWVudCgpLmJvZHk7CgoJCXJldHVybiB7eDogTWF0aC5tYXgoZG9jLnNjcm9sbFdpZHRoLCBib2R5LnNjcm9sbFdpZHRoLCBtaW4ueCksIHk6IE1hdGgubWF4KGRvYy5zY3JvbGxIZWlnaHQsIGJvZHkuc2Nyb2xsSGVpZ2h0LCBtaW4ueSl9OwoJfSwKCglnZXRQb3NpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4ge3g6IDAsIHk6IDB9OwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oKXsKCQl2YXIgc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXJldHVybiB7dG9wOiAwLCBsZWZ0OiAwLCBib3R0b206IHNpemUueSwgcmlnaHQ6IHNpemUueCwgaGVpZ2h0OiBzaXplLnksIHdpZHRoOiBzaXplLnh9OwoJfQoKfSk7CgovLyBwcml2YXRlIG1ldGhvZHMKCnZhciBzdHlsZVN0cmluZyA9IEVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZTsKCmZ1bmN0aW9uIHN0eWxlTnVtYmVyKGVsZW1lbnQsIHN0eWxlKXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCBzdHlsZSkudG9JbnQoKSB8fCAwOwp9CgpmdW5jdGlvbiBib3JkZXJCb3goZWxlbWVudCl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWxlbWVudCwgJy1tb3otYm94LXNpemluZycpID09ICdib3JkZXItYm94JzsKfQoKZnVuY3Rpb24gdG9wQm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItdG9wLXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGxlZnRCb3JkZXIoZWxlbWVudCl7CglyZXR1cm4gc3R5bGVOdW1iZXIoZWxlbWVudCwgJ2JvcmRlci1sZWZ0LXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGlzQm9keShlbGVtZW50KXsKCXJldHVybiAoL14oPzpib2R5fGh0bWwpJC9pKS50ZXN0KGVsZW1lbnQudGFnTmFtZSk7Cn0KCmZ1bmN0aW9uIGdldENvbXBhdEVsZW1lbnQoZWxlbWVudCl7Cgl2YXIgZG9jID0gZWxlbWVudC5nZXREb2N1bWVudCgpOwoJcmV0dXJuICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7Cn0KCn0pKCk7CgovL2FsaWFzZXMKRWxlbWVudC5hbGlhcyh7cG9zaXRpb246ICdzZXRQb3NpdGlvbid9KTsgLy9jb21wYXRhYmlsaXR5CgpbV2luZG93LCBEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0SGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNpemUoKS55OwoJfSwKCglnZXRXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTaXplKCkueDsKCX0sCgoJZ2V0U2Nyb2xsVG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbCgpLnk7Cgl9LAoKCWdldFNjcm9sbExlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsKCkueDsKCX0sCgoJZ2V0U2Nyb2xsSGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbFNpemUoKS55OwoJfSwKCglnZXRTY3JvbGxXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGxTaXplKCkueDsKCX0sCgoJZ2V0VG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKCkueTsKCX0sCgoJZ2V0TGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbigpLng7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIGJhc2ljIGFuaW1hdGlvbiBsb2dpYyB0byBiZSBleHRlbmRlZCBieSBhbGwgb3RoZXIgRnggQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXQoKcHJvdmlkZXM6IEZ4CgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIEZ4ID0gdGhpcy5GeCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsKCQkvKgoJCW9uU3RhcnQ6IG5pbCwKCQlvbkNhbmNlbDogbmlsLAoJCW9uQ29tcGxldGU6IG5pbCwKCQkqLwoJCWZwczogNjAsCgkJdW5pdDogZmFsc2UsCgkJZHVyYXRpb246IDUwMCwKCQlmcmFtZXM6IG51bGwsCgkJZnJhbWVTa2lwOiB0cnVlLAoJCWxpbms6ICdpZ25vcmUnCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuc3ViamVjdCA9IHRoaXMuc3ViamVjdCB8fCB0aGlzOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCX0sCgoJZ2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gZnVuY3Rpb24ocCl7CgkJCXJldHVybiAtKE1hdGguY29zKE1hdGguUEkgKiBwKSAtIDEpIC8gMjsKCQl9OwoJfSwKCglzdGVwOiBmdW5jdGlvbihub3cpewoJCWlmICh0aGlzLm9wdGlvbnMuZnJhbWVTa2lwKXsKCQkJdmFyIGRpZmYgPSAodGhpcy50aW1lICE9IG51bGwpID8gKG5vdyAtIHRoaXMudGltZSkgOiAwLCBmcmFtZXMgPSBkaWZmIC8gdGhpcy5mcmFtZUludGVydmFsOwoJCQl0aGlzLnRpbWUgPSBub3c7CgkJCXRoaXMuZnJhbWUgKz0gZnJhbWVzOwoJCX0gZWxzZSB7CgkJCXRoaXMuZnJhbWUrKzsKCQl9CgoJCWlmICh0aGlzLmZyYW1lIDwgdGhpcy5mcmFtZXMpewoJCQl2YXIgZGVsdGEgPSB0aGlzLnRyYW5zaXRpb24odGhpcy5mcmFtZSAvIHRoaXMuZnJhbWVzKTsKCQkJdGhpcy5zZXQodGhpcy5jb21wdXRlKHRoaXMuZnJvbSwgdGhpcy50bywgZGVsdGEpKTsKCQl9IGVsc2UgewoJCQl0aGlzLmZyYW1lID0gdGhpcy5mcmFtZXM7CgkJCXRoaXMuc2V0KHRoaXMuY29tcHV0ZSh0aGlzLmZyb20sIHRoaXMudG8sIDEpKTsKCQkJdGhpcy5zdG9wKCk7CgkJfQoJfSwKCglzZXQ6IGZ1bmN0aW9uKG5vdyl7CgkJcmV0dXJuIG5vdzsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQlyZXR1cm4gRnguY29tcHV0ZShmcm9tLCB0bywgZGVsdGEpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMuaXNSdW5uaW5nKCkpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzdGFydDogZnVuY3Rpb24oZnJvbSwgdG8pewoJCWlmICghdGhpcy5jaGVjayhmcm9tLCB0bykpIHJldHVybiB0aGlzOwoJCXRoaXMuZnJvbSA9IGZyb207CgkJdGhpcy50byA9IHRvOwoJCXRoaXMuZnJhbWUgPSAodGhpcy5vcHRpb25zLmZyYW1lU2tpcCkgPyAwIDogLTE7CgkJdGhpcy50aW1lID0gbnVsbDsKCQl0aGlzLnRyYW5zaXRpb24gPSB0aGlzLmdldFRyYW5zaXRpb24oKTsKCQl2YXIgZnJhbWVzID0gdGhpcy5vcHRpb25zLmZyYW1lcywgZnBzID0gdGhpcy5vcHRpb25zLmZwcywgZHVyYXRpb24gPSB0aGlzLm9wdGlvbnMuZHVyYXRpb247CgkJdGhpcy5kdXJhdGlvbiA9IEZ4LkR1cmF0aW9uc1tkdXJhdGlvbl0gfHwgZHVyYXRpb24udG9JbnQoKTsKCQl0aGlzLmZyYW1lSW50ZXJ2YWwgPSAxMDAwIC8gZnBzOwoJCXRoaXMuZnJhbWVzID0gZnJhbWVzIHx8IE1hdGgucm91bmQodGhpcy5kdXJhdGlvbiAvIHRoaXMuZnJhbWVJbnRlcnZhbCk7CgkJdGhpcy5maXJlRXZlbnQoJ3N0YXJ0JywgdGhpcy5zdWJqZWN0KTsKCQlwdXNoSW5zdGFuY2UuY2FsbCh0aGlzLCBmcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdG9wOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCWlmICh0aGlzLmZyYW1lcyA9PSB0aGlzLmZyYW1lKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIHRoaXMuc3ViamVjdCk7CgkJCQlpZiAoIXRoaXMuY2FsbENoYWluKCkpIHRoaXMuZmlyZUV2ZW50KCdjaGFpbkNvbXBsZXRlJywgdGhpcy5zdWJqZWN0KTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZmlyZUV2ZW50KCdzdG9wJywgdGhpcy5zdWJqZWN0KTsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCXRoaXMuZnJhbWUgPSB0aGlzLmZyYW1lczsKCQkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcsIHRoaXMuc3ViamVjdCkuY2xlYXJDaGFpbigpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJcGF1c2U6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlc3VtZTogZnVuY3Rpb24oKXsKCQlpZiAoKHRoaXMuZnJhbWUgPCB0aGlzLmZyYW1lcykgJiYgIXRoaXMuaXNSdW5uaW5nKCkpIHB1c2hJbnN0YW5jZS5jYWxsKHRoaXMsIHRoaXMub3B0aW9ucy5mcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJdmFyIGxpc3QgPSBpbnN0YW5jZXNbdGhpcy5vcHRpb25zLmZwc107CgkJcmV0dXJuIGxpc3QgJiYgbGlzdC5jb250YWlucyh0aGlzKTsKCX0KCn0pOwoKRnguY29tcHV0ZSA9IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CglyZXR1cm4gKHRvIC0gZnJvbSkgKiBkZWx0YSArIGZyb207Cn07CgpGeC5EdXJhdGlvbnMgPSB7J3Nob3J0JzogMjUwLCAnbm9ybWFsJzogNTAwLCAnbG9uZyc6IDEwMDB9OwoKLy8gZ2xvYmFsIHRpbWVycwoKdmFyIGluc3RhbmNlcyA9IHt9LCB0aW1lcnMgPSB7fTsKCnZhciBsb29wID0gZnVuY3Rpb24oKXsKCXZhciBub3cgPSBEYXRlLm5vdygpOwoJZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoOyBpLS07KXsKCQl2YXIgaW5zdGFuY2UgPSB0aGlzW2ldOwoJCWlmIChpbnN0YW5jZSkgaW5zdGFuY2Uuc3RlcChub3cpOwoJfQp9OwoKdmFyIHB1c2hJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdIHx8IChpbnN0YW5jZXNbZnBzXSA9IFtdKTsKCWxpc3QucHVzaCh0aGlzKTsKCWlmICghdGltZXJzW2Zwc10pIHRpbWVyc1tmcHNdID0gbG9vcC5wZXJpb2RpY2FsKE1hdGgucm91bmQoMTAwMCAvIGZwcyksIGxpc3QpOwp9OwoKdmFyIHB1bGxJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdOwoJaWYgKGxpc3QpewoJCWxpc3QuZXJhc2UodGhpcyk7CgkJaWYgKCFsaXN0Lmxlbmd0aCAmJiB0aW1lcnNbZnBzXSl7CgkJCWRlbGV0ZSBpbnN0YW5jZXNbZnBzXTsKCQkJdGltZXJzW2Zwc10gPSBjbGVhckludGVydmFsKHRpbWVyc1tmcHNdKTsKCQl9Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRnguQ1NTCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENTUyBhbmltYXRpb24gbG9naWMuIFVzZWQgYnkgRnguVHdlZW4sIEZ4Lk1vcnBoLCBGeC5FbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtGeCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBGeC5DU1MKCi4uLgoqLwoKRnguQ1NTID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeCwKCgkvL3ByZXBhcmVzIHRoZSBiYXNlIGZyb20vdG8gb2JqZWN0CgoJcHJlcGFyZTogZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHksIHZhbHVlcyl7CgkJdmFsdWVzID0gQXJyYXkuZnJvbSh2YWx1ZXMpOwoJCXZhciBmcm9tID0gdmFsdWVzWzBdLCB0byA9IHZhbHVlc1sxXTsKCQlpZiAodG8gPT0gbnVsbCl7CgkJCXRvID0gZnJvbTsKCQkJZnJvbSA9IGVsZW1lbnQuZ2V0U3R5bGUocHJvcGVydHkpOwoJCQl2YXIgdW5pdCA9IHRoaXMub3B0aW9ucy51bml0OwoJCQkvLyBhZGFwdGVkIGZyb206IGh0dHBzOi8vZ2l0aHViLmNvbS9yeWFubW9yci9meC9ibG9iL21hc3Rlci9meC5qcyNMMjk5CgkJCWlmICh1bml0ICYmIGZyb20uc2xpY2UoLXVuaXQubGVuZ3RoKSAhPSB1bml0ICYmIHBhcnNlRmxvYXQoZnJvbSkgIT0gMCl7CgkJCQllbGVtZW50LnNldFN0eWxlKHByb3BlcnR5LCB0byArIHVuaXQpOwoJCQkJdmFyIHZhbHVlID0gZWxlbWVudC5nZXRDb21wdXRlZFN0eWxlKHByb3BlcnR5KTsKCQkJCS8vIElFIGFuZCBPcGVyYSBzdXBwb3J0IHBpeGVsTGVmdCBvciBwaXhlbFdpZHRoCgkJCQlpZiAoISgvcHgkLy50ZXN0KHZhbHVlKSkpewoJCQkJCXZhbHVlID0gZWxlbWVudC5zdHlsZVsoJ3BpeGVsLScgKyBwcm9wZXJ0eSkuY2FtZWxDYXNlKCldOwoJCQkJCWlmICh2YWx1ZSA9PSBudWxsKXsKCQkJCQkJLy8gYWRhcHRlZCBmcm9tIERlYW4gRWR3YXJkcycgaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQoJCQkJCQl2YXIgbGVmdCA9IGVsZW1lbnQuc3R5bGUubGVmdDsKCQkJCQkJZWxlbWVudC5zdHlsZS5sZWZ0ID0gdG8gKyB1bml0OwoJCQkJCQl2YWx1ZSA9IGVsZW1lbnQuc3R5bGUucGl4ZWxMZWZ0OwoJCQkJCQllbGVtZW50LnN0eWxlLmxlZnQgPSBsZWZ0OwoJCQkJCX0KCQkJCX0KCQkJCWZyb20gPSAodG8gfHwgMSkgLyAocGFyc2VGbG9hdCh2YWx1ZSkgfHwgMSkgKiAocGFyc2VGbG9hdChmcm9tKSB8fCAwKTsKCQkJCWVsZW1lbnQuc2V0U3R5bGUocHJvcGVydHksIGZyb20gKyB1bml0KTsKCQkJfQoJCX0KCQlyZXR1cm4ge2Zyb206IHRoaXMucGFyc2UoZnJvbSksIHRvOiB0aGlzLnBhcnNlKHRvKX07Cgl9LAoKCS8vcGFyc2VzIGEgdmFsdWUgaW50byBhbiBhcnJheQoKCXBhcnNlOiBmdW5jdGlvbih2YWx1ZSl7CgkJdmFsdWUgPSBGdW5jdGlvbi5mcm9tKHZhbHVlKSgpOwoJCXZhbHVlID0gKHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJykgPyB2YWx1ZS5zcGxpdCgnICcpIDogQXJyYXkuZnJvbSh2YWx1ZSk7CgkJcmV0dXJuIHZhbHVlLm1hcChmdW5jdGlvbih2YWwpewoJCQl2YWwgPSBTdHJpbmcodmFsKTsKCQkJdmFyIGZvdW5kID0gZmFsc2U7CgkJCU9iamVjdC5lYWNoKEZ4LkNTUy5QYXJzZXJzLCBmdW5jdGlvbihwYXJzZXIsIGtleSl7CgkJCQlpZiAoZm91bmQpIHJldHVybjsKCQkJCXZhciBwYXJzZWQgPSBwYXJzZXIucGFyc2UodmFsKTsKCQkJCWlmIChwYXJzZWQgfHwgcGFyc2VkID09PSAwKSBmb3VuZCA9IHt2YWx1ZTogcGFyc2VkLCBwYXJzZXI6IHBhcnNlcn07CgkJCX0pOwoJCQlmb3VuZCA9IGZvdW5kIHx8IHt2YWx1ZTogdmFsLCBwYXJzZXI6IEZ4LkNTUy5QYXJzZXJzLlN0cmluZ307CgkJCXJldHVybiBmb3VuZDsKCQl9KTsKCX0sCgoJLy9jb21wdXRlcyBieSBhIGZyb20gYW5kIHRvIHByZXBhcmVkIG9iamVjdHMsIHVzaW5nIHRoZWlyIHBhcnNlcnMuCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgY29tcHV0ZWQgPSBbXTsKCQkoTWF0aC5taW4oZnJvbS5sZW5ndGgsIHRvLmxlbmd0aCkpLnRpbWVzKGZ1bmN0aW9uKGkpewoJCQljb21wdXRlZC5wdXNoKHt2YWx1ZTogZnJvbVtpXS5wYXJzZXIuY29tcHV0ZShmcm9tW2ldLnZhbHVlLCB0b1tpXS52YWx1ZSwgZGVsdGEpLCBwYXJzZXI6IGZyb21baV0ucGFyc2VyfSk7CgkJfSk7CgkJY29tcHV0ZWQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2Z4OmNzczp2YWx1ZScpOwoJCXJldHVybiBjb21wdXRlZDsKCX0sCgoJLy9zZXJ2ZXMgdGhlIHZhbHVlIGFzIHNldHRhYmxlCgoJc2VydmU6IGZ1bmN0aW9uKHZhbHVlLCB1bml0KXsKCQlpZiAodHlwZU9mKHZhbHVlKSAhPSAnZng6Y3NzOnZhbHVlJykgdmFsdWUgPSB0aGlzLnBhcnNlKHZhbHVlKTsKCQl2YXIgcmV0dXJuZWQgPSBbXTsKCQl2YWx1ZS5lYWNoKGZ1bmN0aW9uKGJpdCl7CgkJCXJldHVybmVkID0gcmV0dXJuZWQuY29uY2F0KGJpdC5wYXJzZXIuc2VydmUoYml0LnZhbHVlLCB1bml0KSk7CgkJfSk7CgkJcmV0dXJuIHJldHVybmVkOwoJfSwKCgkvL3JlbmRlcnMgdGhlIGNoYW5nZSB0byBhbiBlbGVtZW50CgoJcmVuZGVyOiBmdW5jdGlvbihlbGVtZW50LCBwcm9wZXJ0eSwgdmFsdWUsIHVuaXQpewoJCWVsZW1lbnQuc2V0U3R5bGUocHJvcGVydHksIHRoaXMuc2VydmUodmFsdWUsIHVuaXQpKTsKCX0sCgoJLy9zZWFyY2hlcyBpbnNpZGUgdGhlIHBhZ2UgY3NzIHRvIGZpbmQgdGhlIHZhbHVlcyBmb3IgYSBzZWxlY3RvcgoKCXNlYXJjaDogZnVuY3Rpb24oc2VsZWN0b3IpewoJCWlmIChGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdKSByZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXTsKCQl2YXIgdG8gPSB7fSwgc2VsZWN0b3JUZXN0ID0gbmV3IFJlZ0V4cCgnXicgKyBzZWxlY3Rvci5lc2NhcGVSZWdFeHAoKSArICckJyk7CgkJQXJyYXkuZWFjaChkb2N1bWVudC5zdHlsZVNoZWV0cywgZnVuY3Rpb24oc2hlZXQsIGopewoJCQl2YXIgaHJlZiA9IHNoZWV0LmhyZWY7CgkJCWlmIChocmVmICYmIGhyZWYuY29udGFpbnMoJzovLycpICYmICFocmVmLmNvbnRhaW5zKGRvY3VtZW50LmRvbWFpbikpIHJldHVybjsKCQkJdmFyIHJ1bGVzID0gc2hlZXQucnVsZXMgfHwgc2hlZXQuY3NzUnVsZXM7CgkJCUFycmF5LmVhY2gocnVsZXMsIGZ1bmN0aW9uKHJ1bGUsIGkpewoJCQkJaWYgKCFydWxlLnN0eWxlKSByZXR1cm47CgkJCQl2YXIgc2VsZWN0b3JUZXh0ID0gKHJ1bGUuc2VsZWN0b3JUZXh0KSA/IHJ1bGUuc2VsZWN0b3JUZXh0LnJlcGxhY2UoL15cdysvLCBmdW5jdGlvbihtKXsKCQkJCQlyZXR1cm4gbS50b0xvd2VyQ2FzZSgpOwoJCQkJfSkgOiBudWxsOwoJCQkJaWYgKCFzZWxlY3RvclRleHQgfHwgIXNlbGVjdG9yVGVzdC50ZXN0KHNlbGVjdG9yVGV4dCkpIHJldHVybjsKCQkJCU9iamVjdC5lYWNoKEVsZW1lbnQuU3R5bGVzLCBmdW5jdGlvbih2YWx1ZSwgc3R5bGUpewoJCQkJCWlmICghcnVsZS5zdHlsZVtzdHlsZV0gfHwgRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJldHVybjsKCQkJCQl2YWx1ZSA9IFN0cmluZyhydWxlLnN0eWxlW3N0eWxlXSk7CgkJCQkJdG9bc3R5bGVdID0gKCgvXnJnYi8pLnRlc3QodmFsdWUpKSA/IHZhbHVlLnJnYlRvSGV4KCkgOiB2YWx1ZTsKCQkJCX0pOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXSA9IHRvOwoJfQoKfSk7CgpGeC5DU1MuQ2FjaGUgPSB7fTsKCkZ4LkNTUy5QYXJzZXJzID0gewoKCUNvbG9yOiB7CgkJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJaWYgKHZhbHVlLm1hdGNoKC9eI1swLTlhLWZdezMsNn0kL2kpKSByZXR1cm4gdmFsdWUuaGV4VG9SZ2IodHJ1ZSk7CgkJCXJldHVybiAoKHZhbHVlID0gdmFsdWUubWF0Y2goLyhcZCspLFxzKihcZCspLFxzKihcZCspLykpKSA/IFt2YWx1ZVsxXSwgdmFsdWVbMl0sIHZhbHVlWzNdXSA6IGZhbHNlOwoJCX0sCgkJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQkJcmV0dXJuIGZyb20ubWFwKGZ1bmN0aW9uKHZhbHVlLCBpKXsKCQkJCXJldHVybiBNYXRoLnJvdW5kKEZ4LmNvbXB1dGUoZnJvbVtpXSwgdG9baV0sIGRlbHRhKSk7CgkJCX0pOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlLm1hcChOdW1iZXIpOwoJCX0KCX0sCgoJTnVtYmVyOiB7CgkJcGFyc2U6IHBhcnNlRmxvYXQsCgkJY29tcHV0ZTogRnguY29tcHV0ZSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCQlyZXR1cm4gKHVuaXQpID8gdmFsdWUgKyB1bml0IDogdmFsdWU7CgkJfQoJfSwKCglTdHJpbmc6IHsKCQlwYXJzZTogRnVuY3Rpb24uZnJvbShmYWxzZSksCgkJY29tcHV0ZTogZnVuY3Rpb24oemVybywgb25lKXsKCQkJcmV0dXJuIG9uZTsKCQl9LAoJCXNlcnZlOiBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfQoJfQoKfTsKCgoKCi8qCi0tLQoKbmFtZTogRnguVHdlZW4KCmRlc2NyaXB0aW9uOiBGb3JtZXJseSBGeC5TdHlsZSwgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IENTUyBwcm9wZXJ0eSBmb3IgYW4gZWxlbWVudC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IFtGeC5Ud2VlbiwgRWxlbWVudC5mYWRlLCBFbGVtZW50LmhpZ2hsaWdodF0KCi4uLgoqLwoKRnguVHdlZW4gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihwcm9wZXJ0eSwgbm93KXsKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQkJbm93ID0gcHJvcGVydHk7CgkJCXByb3BlcnR5ID0gdGhpcy5wcm9wZXJ0eSB8fCB0aGlzLm9wdGlvbnMucHJvcGVydHk7CgkJfQoJCXRoaXMucmVuZGVyKHRoaXMuZWxlbWVudCwgcHJvcGVydHksIG5vdywgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdGFydDogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydHksIGZyb20sIHRvKSkgcmV0dXJuIHRoaXM7CgkJdmFyIGFyZ3MgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyk7CgkJdGhpcy5wcm9wZXJ0eSA9IHRoaXMub3B0aW9ucy5wcm9wZXJ0eSB8fCBhcmdzLnNoaWZ0KCk7CgkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHRoaXMucHJvcGVydHksIGFyZ3MpOwoJCXJldHVybiB0aGlzLnBhcmVudChwYXJzZWQuZnJvbSwgcGFyc2VkLnRvKTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnR3ZWVuID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5nZXQoJ3R3ZWVuJykuY2FuY2VsKCkuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciB0d2VlbiA9IHRoaXMucmV0cmlldmUoJ3R3ZWVuJyk7CgkJaWYgKCF0d2Vlbil7CgkJCXR3ZWVuID0gbmV3IEZ4LlR3ZWVuKHRoaXMsIHtsaW5rOiAnY2FuY2VsJ30pOwoJCQl0aGlzLnN0b3JlKCd0d2VlbicsIHR3ZWVuKTsKCQl9CgkJcmV0dXJuIHR3ZWVuOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCgl0d2VlbjogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQl0aGlzLmdldCgndHdlZW4nKS5zdGFydChwcm9wZXJ0eSwgZnJvbSwgdG8pOwoJCXJldHVybiB0aGlzOwoJfSwKCglmYWRlOiBmdW5jdGlvbihob3cpewoJCXZhciBmYWRlID0gdGhpcy5nZXQoJ3R3ZWVuJyksIG1ldGhvZCwgYXJncyA9IFsnb3BhY2l0eSddLmFwcGVuZChhcmd1bWVudHMpLCB0b2dnbGU7CgkJaWYgKGFyZ3NbMV0gPT0gbnVsbCkgYXJnc1sxXSA9ICd0b2dnbGUnOwoJCXN3aXRjaCAoYXJnc1sxXSl7CgkJCWNhc2UgJ2luJzogbWV0aG9kID0gJ3N0YXJ0JzsgYXJnc1sxXSA9IDE7IGJyZWFrOwoJCQljYXNlICdvdXQnOiBtZXRob2QgPSAnc3RhcnQnOyBhcmdzWzFdID0gMDsgYnJlYWs7CgkJCWNhc2UgJ3Nob3cnOiBtZXRob2QgPSAnc2V0JzsgYXJnc1sxXSA9IDE7IGJyZWFrOwoJCQljYXNlICdoaWRlJzogbWV0aG9kID0gJ3NldCc7IGFyZ3NbMV0gPSAwOyBicmVhazsKCQkJY2FzZSAndG9nZ2xlJzoKCQkJCXZhciBmbGFnID0gdGhpcy5yZXRyaWV2ZSgnZmFkZTpmbGFnJywgdGhpcy5nZXRTdHlsZSgnb3BhY2l0eScpID09IDEpOwoJCQkJbWV0aG9kID0gJ3N0YXJ0JzsKCQkJCWFyZ3NbMV0gPSBmbGFnID8gMCA6IDE7CgkJCQl0aGlzLnN0b3JlKCdmYWRlOmZsYWcnLCAhZmxhZyk7CgkJCQl0b2dnbGUgPSB0cnVlOwoJCQlicmVhazsKCQkJZGVmYXVsdDogbWV0aG9kID0gJ3N0YXJ0JzsKCQl9CgkJaWYgKCF0b2dnbGUpIHRoaXMuZWxpbWluYXRlKCdmYWRlOmZsYWcnKTsKCQlmYWRlW21ldGhvZF0uYXBwbHkoZmFkZSwgYXJncyk7CgkJdmFyIHRvID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdOwoJCWlmIChtZXRob2QgPT0gJ3NldCcgfHwgdG8gIT0gMCkgdGhpcy5zZXRTdHlsZSgndmlzaWJpbGl0eScsIHRvID09IDAgPyAnaGlkZGVuJyA6ICd2aXNpYmxlJyk7CgkJZWxzZSBmYWRlLmNoYWluKGZ1bmN0aW9uKCl7CgkJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSgndmlzaWJpbGl0eScsICdoaWRkZW4nKTsKCQkJdGhpcy5jYWxsQ2hhaW4oKTsKCQl9KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGlnaGxpZ2h0OiBmdW5jdGlvbihzdGFydCwgZW5kKXsKCQlpZiAoIWVuZCl7CgkJCWVuZCA9IHRoaXMucmV0cmlldmUoJ2hpZ2hsaWdodDpvcmlnaW5hbCcsIHRoaXMuZ2V0U3R5bGUoJ2JhY2tncm91bmQtY29sb3InKSk7CgkJCWVuZCA9IChlbmQgPT0gJ3RyYW5zcGFyZW50JykgPyAnI2ZmZicgOiBlbmQ7CgkJfQoJCXZhciB0d2VlbiA9IHRoaXMuZ2V0KCd0d2VlbicpOwoJCXR3ZWVuLnN0YXJ0KCdiYWNrZ3JvdW5kLWNvbG9yJywgc3RhcnQgfHwgJyNmZmZmODgnLCBlbmQpLmNoYWluKGZ1bmN0aW9uKCl7CgkJCXRoaXMuc2V0U3R5bGUoJ2JhY2tncm91bmQtY29sb3InLCB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnKSk7CgkJCXR3ZWVuLmNhbGxDaGFpbigpOwoJCX0uYmluZCh0aGlzKSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4Lk1vcnBoCgpkZXNjcmlwdGlvbjogRm9ybWVybHkgRnguU3R5bGVzLCBlZmZlY3QgdG8gdHJhbnNpdGlvbiBhbnkgbnVtYmVyIG9mIENTUyBwcm9wZXJ0aWVzIGZvciBhbiBlbGVtZW50IHVzaW5nIGFuIG9iamVjdCBvZiBydWxlcywgb3IgQ1NTIGJhc2VkIHNlbGVjdG9yIHJ1bGVzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRnguQ1NTCgpwcm92aWRlczogRnguTW9ycGgKCi4uLgoqLwoKRnguTW9ycGggPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihub3cpewoJCWlmICh0eXBlb2Ygbm93ID09ICdzdHJpbmcnKSBub3cgPSB0aGlzLnNlYXJjaChub3cpOwoJCWZvciAodmFyIHAgaW4gbm93KSB0aGlzLnJlbmRlcih0aGlzLmVsZW1lbnQsIHAsIG5vd1twXSwgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBub3cgPSB7fTsKCQlmb3IgKHZhciBwIGluIGZyb20pIG5vd1twXSA9IHRoaXMucGFyZW50KGZyb21bcF0sIHRvW3BdLCBkZWx0YSk7CgkJcmV0dXJuIG5vdzsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJCWlmICghdGhpcy5jaGVjayhwcm9wZXJ0aWVzKSkgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZiBwcm9wZXJ0aWVzID09ICdzdHJpbmcnKSBwcm9wZXJ0aWVzID0gdGhpcy5zZWFyY2gocHJvcGVydGllcyk7CgkJdmFyIGZyb20gPSB7fSwgdG8gPSB7fTsKCQlmb3IgKHZhciBwIGluIHByb3BlcnRpZXMpewoJCQl2YXIgcGFyc2VkID0gdGhpcy5wcmVwYXJlKHRoaXMuZWxlbWVudCwgcCwgcHJvcGVydGllc1twXSk7CgkJCWZyb21bcF0gPSBwYXJzZWQuZnJvbTsKCQkJdG9bcF0gPSBwYXJzZWQudG87CgkJfQoJCXJldHVybiB0aGlzLnBhcmVudChmcm9tLCB0byk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5tb3JwaCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuZ2V0KCdtb3JwaCcpLmNhbmNlbCgpLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgbW9ycGggPSB0aGlzLnJldHJpZXZlKCdtb3JwaCcpOwoJCWlmICghbW9ycGgpewoJCQltb3JwaCA9IG5ldyBGeC5Nb3JwaCh0aGlzLCB7bGluazogJ2NhbmNlbCd9KTsKCQkJdGhpcy5zdG9yZSgnbW9ycGgnLCBtb3JwaCk7CgkJfQoJCXJldHVybiBtb3JwaDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbW9ycGg6IGZ1bmN0aW9uKHByb3BzKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5zdGFydChwcm9wcyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4LlRyYW5zaXRpb25zCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgYSBzZXQgb2YgYWR2YW5jZWQgdHJhbnNpdGlvbnMgdG8gYmUgdXNlZCB3aXRoIGFueSBvZiB0aGUgRnggQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEVhc2luZyBFcXVhdGlvbnMgYnkgUm9iZXJ0IFBlbm5lciwgPGh0dHA6Ly93d3cucm9iZXJ0cGVubmVyLmNvbS9lYXNpbmcvPiwgbW9kaWZpZWQgYW5kIG9wdGltaXplZCB0byBiZSB1c2VkIHdpdGggTW9vVG9vbHMuCgpyZXF1aXJlczogRngKCnByb3ZpZGVzOiBGeC5UcmFuc2l0aW9ucwoKLi4uCiovCgpGeC5pbXBsZW1lbnQoewoKCWdldFRyYW5zaXRpb246IGZ1bmN0aW9uKCl7CgkJdmFyIHRyYW5zID0gdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gfHwgRnguVHJhbnNpdGlvbnMuU2luZS5lYXNlSW5PdXQ7CgkJaWYgKHR5cGVvZiB0cmFucyA9PSAnc3RyaW5nJyl7CgkJCXZhciBkYXRhID0gdHJhbnMuc3BsaXQoJzonKTsKCQkJdHJhbnMgPSBGeC5UcmFuc2l0aW9uczsKCQkJdHJhbnMgPSB0cmFuc1tkYXRhWzBdXSB8fCB0cmFuc1tkYXRhWzBdLmNhcGl0YWxpemUoKV07CgkJCWlmIChkYXRhWzFdKSB0cmFucyA9IHRyYW5zWydlYXNlJyArIGRhdGFbMV0uY2FwaXRhbGl6ZSgpICsgKGRhdGFbMl0gPyBkYXRhWzJdLmNhcGl0YWxpemUoKSA6ICcnKV07CgkJfQoJCXJldHVybiB0cmFuczsKCX0KCn0pOwoKRnguVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKHRyYW5zaXRpb24sIHBhcmFtcyl7CglwYXJhbXMgPSBBcnJheS5mcm9tKHBhcmFtcyk7Cgl2YXIgZWFzZUluID0gZnVuY3Rpb24ocG9zKXsKCQlyZXR1cm4gdHJhbnNpdGlvbihwb3MsIHBhcmFtcyk7Cgl9OwoJcmV0dXJuIE9iamVjdC5hcHBlbmQoZWFzZUluLCB7CgkJZWFzZUluOiBlYXNlSW4sCgkJZWFzZU91dDogZnVuY3Rpb24ocG9zKXsKCQkJcmV0dXJuIDEgLSB0cmFuc2l0aW9uKDEgLSBwb3MsIHBhcmFtcyk7CgkJfSwKCQllYXNlSW5PdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAocG9zIDw9IDAuNSA/IHRyYW5zaXRpb24oMiAqIHBvcywgcGFyYW1zKSA6ICgyIC0gdHJhbnNpdGlvbigyICogKDEgLSBwb3MpLCBwYXJhbXMpKSkgLyAyOwoJCX0KCX0pOwp9OwoKRnguVHJhbnNpdGlvbnMgPSB7CgoJbGluZWFyOiBmdW5jdGlvbih6ZXJvKXsKCQlyZXR1cm4gemVybzsKCX0KCn07CgoKCkZ4LlRyYW5zaXRpb25zLmV4dGVuZCA9IGZ1bmN0aW9uKHRyYW5zaXRpb25zKXsKCWZvciAodmFyIHRyYW5zaXRpb24gaW4gdHJhbnNpdGlvbnMpIEZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb25dID0gbmV3IEZ4LlRyYW5zaXRpb24odHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0pOwp9OwoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kKHsKCglQb3c6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdyhwLCB4ICYmIHhbMF0gfHwgNik7Cgl9LAoKCUV4cG86IGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdygyLCA4ICogKHAgLSAxKSk7Cgl9LAoKCUNpcmM6IGZ1bmN0aW9uKHApewoJCXJldHVybiAxIC0gTWF0aC5zaW4oTWF0aC5hY29zKHApKTsKCX0sCgoJU2luZTogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLmNvcyhwICogTWF0aC5QSSAvIDIpOwoJfSwKCglCYWNrOiBmdW5jdGlvbihwLCB4KXsKCQl4ID0geCAmJiB4WzBdIHx8IDEuNjE4OwoJCXJldHVybiBNYXRoLnBvdyhwLCAyKSAqICgoeCArIDEpICogcCAtIHgpOwoJfSwKCglCb3VuY2U6IGZ1bmN0aW9uKHApewoJCXZhciB2YWx1ZTsKCQlmb3IgKHZhciBhID0gMCwgYiA9IDE7IDE7IGEgKz0gYiwgYiAvPSAyKXsKCQkJaWYgKHAgPj0gKDcgLSA0ICogYSkgLyAxMSl7CgkJCQl2YWx1ZSA9IGIgKiBiIC0gTWF0aC5wb3coKDExIC0gNiAqIGEgLSAxMSAqIHApIC8gNCwgMik7CgkJCQlicmVhazsKCQkJfQoJCX0KCQlyZXR1cm4gdmFsdWU7Cgl9LAoKCUVsYXN0aWM6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdygyLCAxMCAqIC0tcCkgKiBNYXRoLmNvcygyMCAqIHAgKiBNYXRoLlBJICogKHggJiYgeFswXSB8fCAxKSAvIDMpOwoJfQoKfSk7CgpbJ1F1YWQnLCAnQ3ViaWMnLCAnUXVhcnQnLCAnUXVpbnQnXS5lYWNoKGZ1bmN0aW9uKHRyYW5zaXRpb24sIGkpewoJRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbihmdW5jdGlvbihwKXsKCQlyZXR1cm4gTWF0aC5wb3cocCwgaSArIDIpOwoJfSk7Cn0pOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdAoKZGVzY3JpcHRpb246IFBvd2VyZnVsIGFsbCBwdXJwb3NlIFJlcXVlc3QgQ2xhc3MuIFVzZXMgWE1MSFRUUFJlcXVlc3QuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbT2JqZWN0LCBFbGVtZW50LCBDaGFpbiwgRXZlbnRzLCBPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IFJlcXVlc3QKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZW1wdHkgPSBmdW5jdGlvbigpe30sCglwcm9ncmVzc1N1cHBvcnQgPSAoJ29ucHJvZ3Jlc3MnIGluIG5ldyBCcm93c2VyLlJlcXVlc3QpOwoKdmFyIFJlcXVlc3QgPSB0aGlzLlJlcXVlc3QgPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXSwKCglvcHRpb25zOiB7LyoKCQlvblJlcXVlc3Q6IGZ1bmN0aW9uKCl7fSwKCQlvbkxvYWRzdGFydDogZnVuY3Rpb24oZXZlbnQsIHhocil7fSwKCQlvblByb2dyZXNzOiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uQ29tcGxldGU6IGZ1bmN0aW9uKCl7fSwKCQlvbkNhbmNlbDogZnVuY3Rpb24oKXt9LAoJCW9uU3VjY2VzczogZnVuY3Rpb24ocmVzcG9uc2VUZXh0LCByZXNwb25zZVhNTCl7fSwKCQlvbkZhaWx1cmU6IGZ1bmN0aW9uKHhocil7fSwKCQlvbkV4Y2VwdGlvbjogZnVuY3Rpb24oaGVhZGVyTmFtZSwgdmFsdWUpe30sCgkJb25UaW1lb3V0OiBmdW5jdGlvbigpe30sCgkJdXNlcjogJycsCgkJcGFzc3dvcmQ6ICcnLCovCgkJdXJsOiAnJywKCQlkYXRhOiAnJywKCQloZWFkZXJzOiB7CgkJCSdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JywKCQkJJ0FjY2VwdCc6ICd0ZXh0L2phdmFzY3JpcHQsIHRleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0sCgkJYXN5bmM6IHRydWUsCgkJZm9ybWF0OiBmYWxzZSwKCQltZXRob2Q6ICdwb3N0JywKCQlsaW5rOiAnaWdub3JlJywKCQlpc1N1Y2Nlc3M6IG51bGwsCgkJZW11bGF0aW9uOiB0cnVlLAoJCXVybEVuY29kZWQ6IHRydWUsCgkJZW5jb2Rpbmc6ICd1dGYtOCcsCgkJZXZhbFNjcmlwdHM6IGZhbHNlLAoJCWV2YWxSZXNwb25zZTogZmFsc2UsCgkJdGltZW91dDogMCwKCQlub0NhY2hlOiBmYWxzZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJdGhpcy5oZWFkZXJzID0gdGhpcy5vcHRpb25zLmhlYWRlcnM7Cgl9LAoKCW9uU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uKCl7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCWlmICh4aHIucmVhZHlTdGF0ZSAhPSA0IHx8ICF0aGlzLnJ1bm5pbmcpIHJldHVybjsKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCQl0aGlzLnN0YXR1cyA9IDA7CgkJRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQl2YXIgc3RhdHVzID0geGhyLnN0YXR1czsKCQkJdGhpcy5zdGF0dXMgPSAoc3RhdHVzID09IDEyMjMpID8gMjA0IDogc3RhdHVzOwoJCX0uYmluZCh0aGlzKSk7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5OwoJCWlmIChwcm9ncmVzc1N1cHBvcnQpIHhoci5vbnByb2dyZXNzID0geGhyLm9ubG9hZHN0YXJ0ID0gZW1wdHk7CgkJY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwoKCQl0aGlzLnJlc3BvbnNlID0ge3RleHQ6IHRoaXMueGhyLnJlc3BvbnNlVGV4dCB8fCAnJywgeG1sOiB0aGlzLnhoci5yZXNwb25zZVhNTH07CgkJaWYgKHRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MuY2FsbCh0aGlzLCB0aGlzLnN0YXR1cykpCgkJCXRoaXMuc3VjY2Vzcyh0aGlzLnJlc3BvbnNlLnRleHQsIHRoaXMucmVzcG9uc2UueG1sKTsKCQllbHNlCgkJCXRoaXMuZmFpbHVyZSgpOwoJfSwKCglpc1N1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdmFyIHN0YXR1cyA9IHRoaXMuc3RhdHVzOwoJCXJldHVybiAoc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDApOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICEhdGhpcy5ydW5uaW5nOwoJfSwKCglwcm9jZXNzU2NyaXB0czogZnVuY3Rpb24odGV4dCl7CgkJaWYgKHRoaXMub3B0aW9ucy5ldmFsUmVzcG9uc2UgfHwgKC8oZWNtYXxqYXZhKXNjcmlwdC8pLnRlc3QodGhpcy5nZXRIZWFkZXIoJ0NvbnRlbnQtdHlwZScpKSkgcmV0dXJuIEJyb3dzZXIuZXhlYyh0ZXh0KTsKCQlyZXR1cm4gdGV4dC5zdHJpcFNjcmlwdHModGhpcy5vcHRpb25zLmV2YWxTY3JpcHRzKTsKCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCwgeG1sKXsKCQl0aGlzLm9uU3VjY2Vzcyh0aGlzLnByb2Nlc3NTY3JpcHRzKHRleHQpLCB4bWwpOwoJfSwKCglvblN1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJywgYXJndW1lbnRzKS5maXJlRXZlbnQoJ3N1Y2Nlc3MnLCBhcmd1bWVudHMpLmNhbGxDaGFpbigpOwoJfSwKCglmYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMub25GYWlsdXJlKCk7Cgl9LAoKCW9uRmFpbHVyZTogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnY29tcGxldGUnKS5maXJlRXZlbnQoJ2ZhaWx1cmUnLCB0aGlzLnhocik7Cgl9LAoKCWxvYWRzdGFydDogZnVuY3Rpb24oZXZlbnQpewoJCXRoaXMuZmlyZUV2ZW50KCdsb2Fkc3RhcnQnLCBbZXZlbnQsIHRoaXMueGhyXSk7Cgl9LAoKCXByb2dyZXNzOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ3Byb2dyZXNzJywgW2V2ZW50LCB0aGlzLnhocl0pOwoJfSwKCgl0aW1lb3V0OiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCd0aW1lb3V0JywgdGhpcy54aHIpOwoJfSwKCglzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKCQl0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0SGVhZGVyOiBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy54aHIuZ2V0UmVzcG9uc2VIZWFkZXIobmFtZSk7CgkJfS5iaW5kKHRoaXMpKTsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzZW5kOiBmdW5jdGlvbihvcHRpb25zKXsKCQlpZiAoIXRoaXMuY2hlY2sob3B0aW9ucykpIHJldHVybiB0aGlzOwoKCQl0aGlzLm9wdGlvbnMuaXNTdWNjZXNzID0gdGhpcy5vcHRpb25zLmlzU3VjY2VzcyB8fCB0aGlzLmlzU3VjY2VzczsKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKCQl2YXIgdHlwZSA9IHR5cGVPZihvcHRpb25zKTsKCQlpZiAodHlwZSA9PSAnc3RyaW5nJyB8fCB0eXBlID09ICdlbGVtZW50Jykgb3B0aW9ucyA9IHtkYXRhOiBvcHRpb25zfTsKCgkJdmFyIG9sZCA9IHRoaXMub3B0aW9uczsKCQlvcHRpb25zID0gT2JqZWN0LmFwcGVuZCh7ZGF0YTogb2xkLmRhdGEsIHVybDogb2xkLnVybCwgbWV0aG9kOiBvbGQubWV0aG9kfSwgb3B0aW9ucyk7CgkJdmFyIGRhdGEgPSBvcHRpb25zLmRhdGEsIHVybCA9IFN0cmluZyhvcHRpb25zLnVybCksIG1ldGhvZCA9IG9wdGlvbnMubWV0aG9kLnRvTG93ZXJDYXNlKCk7CgoJCXN3aXRjaCAodHlwZU9mKGRhdGEpKXsKCQkJY2FzZSAnZWxlbWVudCc6IGRhdGEgPSBkb2N1bWVudC5pZChkYXRhKS50b1F1ZXJ5U3RyaW5nKCk7IGJyZWFrOwoJCQljYXNlICdvYmplY3QnOiBjYXNlICdoYXNoJzogZGF0YSA9IE9iamVjdC50b1F1ZXJ5U3RyaW5nKGRhdGEpOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy5mb3JtYXQpewoJCQl2YXIgZm9ybWF0ID0gJ2Zvcm1hdD0nICsgdGhpcy5vcHRpb25zLmZvcm1hdDsKCQkJZGF0YSA9IChkYXRhKSA/IGZvcm1hdCArICcmJyArIGRhdGEgOiBmb3JtYXQ7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmVtdWxhdGlvbiAmJiAhWydnZXQnLCAncG9zdCddLmNvbnRhaW5zKG1ldGhvZCkpewoJCQl2YXIgX21ldGhvZCA9ICdfbWV0aG9kPScgKyBtZXRob2Q7CgkJCWRhdGEgPSAoZGF0YSkgPyBfbWV0aG9kICsgJyYnICsgZGF0YSA6IF9tZXRob2Q7CgkJCW1ldGhvZCA9ICdwb3N0JzsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMudXJsRW5jb2RlZCAmJiBbJ3Bvc3QnLCAncHV0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBlbmNvZGluZyA9ICh0aGlzLm9wdGlvbnMuZW5jb2RpbmcpID8gJzsgY2hhcnNldD0nICsgdGhpcy5vcHRpb25zLmVuY29kaW5nIDogJyc7CgkJCXRoaXMuaGVhZGVyc1snQ29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyArIGVuY29kaW5nOwoJCX0KCgkJaWYgKCF1cmwpIHVybCA9IGRvY3VtZW50LmxvY2F0aW9uLnBhdGhuYW1lOwoKCQl2YXIgdHJpbVBvc2l0aW9uID0gdXJsLmxhc3RJbmRleE9mKCcvJyk7CgkJaWYgKHRyaW1Qb3NpdGlvbiA+IC0xICYmICh0cmltUG9zaXRpb24gPSB1cmwuaW5kZXhPZignIycpKSA+IC0xKSB1cmwgPSB1cmwuc3Vic3RyKDAsIHRyaW1Qb3NpdGlvbik7CgoJCWlmICh0aGlzLm9wdGlvbnMubm9DYWNoZSkKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBTdHJpbmcudW5pcXVlSUQoKTsKCgkJaWYgKGRhdGEgJiYgbWV0aG9kID09ICdnZXQnKXsKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBkYXRhOwoJCQlkYXRhID0gbnVsbDsKCQl9CgoJCXZhciB4aHIgPSB0aGlzLnhocjsKCQlpZiAocHJvZ3Jlc3NTdXBwb3J0KXsKCQkJeGhyLm9ubG9hZHN0YXJ0ID0gdGhpcy5sb2Fkc3RhcnQuYmluZCh0aGlzKTsKCQkJeGhyLm9ucHJvZ3Jlc3MgPSB0aGlzLnByb2dyZXNzLmJpbmQodGhpcyk7CgkJfQoKCQl4aHIub3BlbihtZXRob2QudG9VcHBlckNhc2UoKSwgdXJsLCB0aGlzLm9wdGlvbnMuYXN5bmMsIHRoaXMub3B0aW9ucy51c2VyLCB0aGlzLm9wdGlvbnMucGFzc3dvcmQpOwoJCWlmICh0aGlzLm9wdGlvbnMudXNlciAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHIpIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwoKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7CgoJCU9iamVjdC5lYWNoKHRoaXMuaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCXRyeSB7CgkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKCQkJfSBjYXRjaCAoZSl7CgkJCQl0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgW2tleSwgdmFsdWVdKTsKCQkJfQoJCX0sIHRoaXMpOwoKCQl0aGlzLmZpcmVFdmVudCgncmVxdWVzdCcpOwoJCXhoci5zZW5kKGRhdGEpOwoJCWlmICghdGhpcy5vcHRpb25zLmFzeW5jKSB0aGlzLm9uU3RhdGVDaGFuZ2UoKTsKCQllbHNlIGlmICh0aGlzLm9wdGlvbnMudGltZW91dCkgdGhpcy50aW1lciA9IHRoaXMudGltZW91dC5kZWxheSh0aGlzLm9wdGlvbnMudGltZW91dCwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNhbmNlbDogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCXhoci5hYm9ydCgpOwoJCWNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLmZpcmVFdmVudCgnY2FuY2VsJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciBtZXRob2RzID0ge307ClsnZ2V0JywgJ3Bvc3QnLCAncHV0JywgJ2RlbGV0ZScsICdHRVQnLCAnUE9TVCcsICdQVVQnLCAnREVMRVRFJ10uZWFjaChmdW5jdGlvbihtZXRob2QpewoJbWV0aG9kc1ttZXRob2RdID0gZnVuY3Rpb24oZGF0YSl7CgkJdmFyIG9iamVjdCA9IHsKCQkJbWV0aG9kOiBtZXRob2QKCQl9OwoJCWlmIChkYXRhICE9IG51bGwpIG9iamVjdC5kYXRhID0gZGF0YTsKCQlyZXR1cm4gdGhpcy5zZW5kKG9iamVjdCk7Cgl9Owp9KTsKClJlcXVlc3QuaW1wbGVtZW50KG1ldGhvZHMpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnNlbmQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgc2VuZCA9IHRoaXMuZ2V0KCdzZW5kJykuY2FuY2VsKCk7CgkJc2VuZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHNlbmQgPSB0aGlzLnJldHJpZXZlKCdzZW5kJyk7CgkJaWYgKCFzZW5kKXsKCQkJc2VuZCA9IG5ldyBSZXF1ZXN0KHsKCQkJCWRhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCBtZXRob2Q6IHRoaXMuZ2V0KCdtZXRob2QnKSB8fCAncG9zdCcsIHVybDogdGhpcy5nZXQoJ2FjdGlvbicpCgkJCX0pOwoJCQl0aGlzLnN0b3JlKCdzZW5kJywgc2VuZCk7CgkJfQoJCXJldHVybiBzZW5kOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzZW5kOiBmdW5jdGlvbih1cmwpewoJCXZhciBzZW5kZXIgPSB0aGlzLmdldCgnc2VuZCcpOwoJCXNlbmRlci5zZW5kKHtkYXRhOiB0aGlzLCB1cmw6IHVybCB8fCBzZW5kZXIub3B0aW9ucy51cmx9KTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSFRNTAoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggSFRNTCByZXNwb25zZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgUmVxdWVzdF0KCnByb3ZpZGVzOiBSZXF1ZXN0LkhUTUwKCi4uLgoqLwoKUmVxdWVzdC5IVE1MID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQl1cGRhdGU6IGZhbHNlLAoJCWFwcGVuZDogZmFsc2UsCgkJZXZhbFNjcmlwdHM6IHRydWUsCgkJZmlsdGVyOiBmYWxzZSwKCQloZWFkZXJzOiB7CgkJCUFjY2VwdDogJ3RleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0KCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZTsKCgkJcmVzcG9uc2UuaHRtbCA9IHRleHQuc3RyaXBTY3JpcHRzKGZ1bmN0aW9uKHNjcmlwdCl7CgkJCXJlc3BvbnNlLmphdmFzY3JpcHQgPSBzY3JpcHQ7CgkJfSk7CgoJCXZhciBtYXRjaCA9IHJlc3BvbnNlLmh0bWwubWF0Y2goLzxib2R5W14+XSo+KFtcc1xTXSo/KTxcL2JvZHk+L2kpOwoJCWlmIChtYXRjaCkgcmVzcG9uc2UuaHRtbCA9IG1hdGNoWzFdOwoJCXZhciB0ZW1wID0gbmV3IEVsZW1lbnQoJ2RpdicpLnNldCgnaHRtbCcsIHJlc3BvbnNlLmh0bWwpOwoKCQlyZXNwb25zZS50cmVlID0gdGVtcC5jaGlsZE5vZGVzOwoJCXJlc3BvbnNlLmVsZW1lbnRzID0gdGVtcC5nZXRFbGVtZW50cyhvcHRpb25zLmZpbHRlciB8fCAnKicpOwoKCQlpZiAob3B0aW9ucy5maWx0ZXIpIHJlc3BvbnNlLnRyZWUgPSByZXNwb25zZS5lbGVtZW50czsKCQlpZiAob3B0aW9ucy51cGRhdGUpewoJCQl2YXIgdXBkYXRlID0gZG9jdW1lbnQuaWQob3B0aW9ucy51cGRhdGUpLmVtcHR5KCk7CgkJCWlmIChvcHRpb25zLmZpbHRlcikgdXBkYXRlLmFkb3B0KHJlc3BvbnNlLmVsZW1lbnRzKTsKCQkJZWxzZSB1cGRhdGUuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgkJfSBlbHNlIGlmIChvcHRpb25zLmFwcGVuZCl7CgkJCXZhciBhcHBlbmQgPSBkb2N1bWVudC5pZChvcHRpb25zLmFwcGVuZCk7CgkJCWlmIChvcHRpb25zLmZpbHRlcikgcmVzcG9uc2UuZWxlbWVudHMucmV2ZXJzZSgpLmluamVjdChhcHBlbmQpOwoJCQllbHNlIGFwcGVuZC5hZG9wdCh0ZW1wLmdldENoaWxkcmVuKCkpOwoJCX0KCQlpZiAob3B0aW9ucy5ldmFsU2NyaXB0cykgQnJvd3Nlci5leGVjKHJlc3BvbnNlLmphdmFzY3JpcHQpOwoKCQl0aGlzLm9uU3VjY2VzcyhyZXNwb25zZS50cmVlLCByZXNwb25zZS5lbGVtZW50cywgcmVzcG9uc2UuaHRtbCwgcmVzcG9uc2UuamF2YXNjcmlwdCk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5sb2FkID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIGxvYWQgPSB0aGlzLmdldCgnbG9hZCcpLmNhbmNlbCgpOwoJCWxvYWQuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciBsb2FkID0gdGhpcy5yZXRyaWV2ZSgnbG9hZCcpOwoJCWlmICghbG9hZCl7CgkJCWxvYWQgPSBuZXcgUmVxdWVzdC5IVE1MKHtkYXRhOiB0aGlzLCBsaW5rOiAnY2FuY2VsJywgdXBkYXRlOiB0aGlzLCBtZXRob2Q6ICdnZXQnfSk7CgkJCXRoaXMuc3RvcmUoJ2xvYWQnLCBsb2FkKTsKCQl9CgkJcmV0dXJuIGxvYWQ7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWxvYWQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5nZXQoJ2xvYWQnKS5zZW5kKEFycmF5LmxpbmsoYXJndW1lbnRzLCB7ZGF0YTogVHlwZS5pc09iamVjdCwgdXJsOiBUeXBlLmlzU3RyaW5nfSkpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBKU09OCgpkZXNjcmlwdGlvbjogSlNPTiBlbmNvZGVyIGFuZCBkZWNvZGVyLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpTZWVBbHNvOiA8aHR0cDovL3d3dy5qc29uLm9yZy8+CgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIE51bWJlciwgRnVuY3Rpb25dCgpwcm92aWRlczogSlNPTgoKLi4uCiovCgppZiAodHlwZW9mIEpTT04gPT0gJ3VuZGVmaW5lZCcpIHRoaXMuSlNPTiA9IHt9OwoKCgooZnVuY3Rpb24oKXsKCnZhciBzcGVjaWFsID0geydcYic6ICdcXGInLCAnXHQnOiAnXFx0JywgJ1xuJzogJ1xcbicsICdcZic6ICdcXGYnLCAnXHInOiAnXFxyJywgJyInIDogJ1xcIicsICdcXCc6ICdcXFxcJ307Cgp2YXIgZXNjYXBlID0gZnVuY3Rpb24oY2hyKXsKCXJldHVybiBzcGVjaWFsW2Nocl0gfHwgJ1xcdScgKyAoJzAwMDAnICsgY2hyLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpKS5zbGljZSgtNCk7Cn07CgpKU09OLnZhbGlkYXRlID0gZnVuY3Rpb24oc3RyaW5nKXsKCXN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICdAJykuCgkJCQkJcmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICddJykuCgkJCQkJcmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAnJyk7CgoJcmV0dXJuICgvXltcXSw6e31cc10qJC8pLnRlc3Qoc3RyaW5nKTsKfTsKCkpTT04uZW5jb2RlID0gSlNPTi5zdHJpbmdpZnkgPyBmdW5jdGlvbihvYmopewoJcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaik7Cn0gOiBmdW5jdGlvbihvYmopewoJaWYgKG9iaiAmJiBvYmoudG9KU09OKSBvYmogPSBvYmoudG9KU09OKCk7CgoJc3dpdGNoICh0eXBlT2Yob2JqKSl7CgkJY2FzZSAnc3RyaW5nJzoKCQkJcmV0dXJuICciJyArIG9iai5yZXBsYWNlKC9bXHgwMC1ceDFmXFwiXS9nLCBlc2NhcGUpICsgJyInOwoJCWNhc2UgJ2FycmF5JzoKCQkJcmV0dXJuICdbJyArIG9iai5tYXAoSlNPTi5lbmNvZGUpLmNsZWFuKCkgKyAnXSc7CgkJY2FzZSAnb2JqZWN0JzogY2FzZSAnaGFzaCc6CgkJCXZhciBzdHJpbmcgPSBbXTsKCQkJT2JqZWN0LmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJCXZhciBqc29uID0gSlNPTi5lbmNvZGUodmFsdWUpOwoJCQkJaWYgKGpzb24pIHN0cmluZy5wdXNoKEpTT04uZW5jb2RlKGtleSkgKyAnOicgKyBqc29uKTsKCQkJfSk7CgkJCXJldHVybiAneycgKyBzdHJpbmcgKyAnfSc7CgkJY2FzZSAnbnVtYmVyJzogY2FzZSAnYm9vbGVhbic6IHJldHVybiAnJyArIG9iajsKCQljYXNlICdudWxsJzogcmV0dXJuICdudWxsJzsKCX0KCglyZXR1cm4gbnVsbDsKfTsKCkpTT04uZGVjb2RlID0gZnVuY3Rpb24oc3RyaW5nLCBzZWN1cmUpewoJaWYgKCFzdHJpbmcgfHwgdHlwZU9mKHN0cmluZykgIT0gJ3N0cmluZycpIHJldHVybiBudWxsOwoKCWlmIChzZWN1cmUgfHwgSlNPTi5zZWN1cmUpewoJCWlmIChKU09OLnBhcnNlKSByZXR1cm4gSlNPTi5wYXJzZShzdHJpbmcpOwoJCWlmICghSlNPTi52YWxpZGF0ZShzdHJpbmcpKSB0aHJvdyBuZXcgRXJyb3IoJ0pTT04gY291bGQgbm90IGRlY29kZSB0aGUgaW5wdXQ7IHNlY3VyaXR5IGlzIGVuYWJsZWQgYW5kIHRoZSB2YWx1ZSBpcyBub3Qgc2VjdXJlLicpOwoJfQoKCXJldHVybiBldmFsKCcoJyArIHN0cmluZyArICcpJyk7Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdC5KU09OCgpkZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgYmFzaWMgUmVxdWVzdCBDbGFzcyB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcyBmb3Igc2VuZGluZyBhbmQgcmVjZWl2aW5nIEpTT04gZGF0YS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtSZXF1ZXN0LCBKU09OXQoKcHJvdmlkZXM6IFJlcXVlc3QuSlNPTgoKLi4uCiovCgpSZXF1ZXN0LkpTT04gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IFJlcXVlc3QsCgoJb3B0aW9uczogewoJCS8qb25FcnJvcjogZnVuY3Rpb24odGV4dCwgZXJyb3Ipe30sKi8KCQlzZWN1cmU6IHRydWUKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7CgkJT2JqZWN0LmFwcGVuZCh0aGlzLmhlYWRlcnMsIHsKCQkJJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKCQkJJ1gtUmVxdWVzdCc6ICdKU09OJwoJCX0pOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIganNvbjsKCQl0cnkgewoJCQlqc29uID0gdGhpcy5yZXNwb25zZS5qc29uID0gSlNPTi5kZWNvZGUodGV4dCwgdGhpcy5vcHRpb25zLnNlY3VyZSk7CgkJfSBjYXRjaCAoZXJyb3IpewoJCQl0aGlzLmZpcmVFdmVudCgnZXJyb3InLCBbdGV4dCwgZXJyb3JdKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoanNvbiA9PSBudWxsKSB0aGlzLm9uRmFpbHVyZSgpOwoJCWVsc2UgdGhpcy5vblN1Y2Nlc3MoanNvbiwgdGV4dCk7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IENvb2tpZQoKZGVzY3JpcHRpb246IENsYXNzIGZvciBjcmVhdGluZywgcmVhZGluZywgYW5kIGRlbGV0aW5nIGJyb3dzZXIgQ29va2llcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEJhc2VkIG9uIHRoZSBmdW5jdGlvbnMgYnkgUGV0ZXItUGF1bCBLb2NoIChodHRwOi8vcXVpcmtzbW9kZS5vcmcpLgoKcmVxdWlyZXM6IFtPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IENvb2tpZQoKLi4uCiovCgp2YXIgQ29va2llID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlwYXRoOiAnLycsCgkJZG9tYWluOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZSwKCQlkb2N1bWVudDogZG9jdW1lbnQsCgkJZW5jb2RlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGtleSwgb3B0aW9ucyl7CgkJdGhpcy5rZXkgPSBrZXk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCgl3cml0ZTogZnVuY3Rpb24odmFsdWUpewoJCWlmICh0aGlzLm9wdGlvbnMuZW5jb2RlKSB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJaWYgKHRoaXMub3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgdGhpcy5vcHRpb25zLmRvbWFpbjsKCQlpZiAodGhpcy5vcHRpb25zLnBhdGgpIHZhbHVlICs9ICc7IHBhdGg9JyArIHRoaXMub3B0aW9ucy5wYXRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pewoJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIDI0ICogNjAgKiA2MCAqIDEwMDApOwoJCQl2YWx1ZSArPSAnOyBleHBpcmVzPScgKyBkYXRlLnRvR01UU3RyaW5nKCk7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCXRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWFkOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUubWF0Y2goJyg/Ol58OylcXHMqJyArIHRoaXMua2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuICh2YWx1ZSkgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWVbMV0pIDogbnVsbDsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQluZXcgQ29va2llKHRoaXMua2V5LCBPYmplY3QubWVyZ2Uoe30sIHRoaXMub3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKS53cml0ZSgnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkNvb2tpZS53cml0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS53cml0ZSh2YWx1ZSk7Cn07CgpDb29raWUucmVhZCA9IGZ1bmN0aW9uKGtleSl7CglyZXR1cm4gbmV3IENvb2tpZShrZXkpLnJlYWQoKTsKfTsKCkNvb2tpZS5kaXNwb3NlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCXJldHVybiBuZXcgQ29va2llKGtleSwgb3B0aW9ucykuZGlzcG9zZSgpOwp9OwoKCi8qCi0tLQoKbmFtZTogRE9NUmVhZHkKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgY3VzdG9tIGV2ZW50IGRvbXJlYWR5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0Jyb3dzZXIsIEVsZW1lbnQsIEVsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0RPTVJlYWR5LCBEb21SZWFkeV0KCi4uLgoqLwoKKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQpewoKdmFyIHJlYWR5LAoJbG9hZGVkLAoJY2hlY2tzID0gW10sCglzaG91bGRQb2xsLAoJdGltZXIsCgl0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKdmFyIGRvbXJlYWR5ID0gZnVuY3Rpb24oKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CglpZiAocmVhZHkpIHJldHVybjsKCUJyb3dzZXIubG9hZGVkID0gcmVhZHkgPSB0cnVlOwoJZG9jdW1lbnQucmVtb3ZlTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSkucmVtb3ZlTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CgoJZG9jdW1lbnQuZmlyZUV2ZW50KCdkb21yZWFkeScpOwoJd2luZG93LmZpcmVFdmVudCgnZG9tcmVhZHknKTsKfTsKCnZhciBjaGVjayA9IGZ1bmN0aW9uKCl7Cglmb3IgKHZhciBpID0gY2hlY2tzLmxlbmd0aDsgaS0tOykgaWYgKGNoZWNrc1tpXSgpKXsKCQlkb21yZWFkeSgpOwoJCXJldHVybiB0cnVlOwoJfQoJcmV0dXJuIGZhbHNlOwp9OwoKdmFyIHBvbGwgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmICghY2hlY2soKSkgdGltZXIgPSBzZXRUaW1lb3V0KHBvbGwsIDEwKTsKfTsKCmRvY3VtZW50LmFkZExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZG9tcmVhZHkpOwoKLyo8bHRJRTg+Ki8KLy8gZG9TY3JvbGwgdGVjaG5pcXVlIGJ5IERpZWdvIFBlcmluaSBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwovLyB0ZXN0RWxlbWVudC5kb1Njcm9sbCgpIHRocm93cyB3aGVuIHRoZSBET00gaXMgbm90IHJlYWR5LCBvbmx5IGluIHRoZSB0b3Agd2luZG93CnZhciBkb1Njcm9sbFdvcmtzID0gZnVuY3Rpb24oKXsKCXRyeSB7CgkJdGVzdEVsZW1lbnQuZG9TY3JvbGwoKTsKCQlyZXR1cm4gdHJ1ZTsKCX0gY2F0Y2ggKGUpe30KCXJldHVybiBmYWxzZTsKfTsKLy8gSWYgZG9TY3JvbGwgd29ya3MgYWxyZWFkeSwgaXQgY2FuJ3QgYmUgdXNlZCB0byBkZXRlcm1pbmUgZG9tcmVhZHkKLy8gICBlLmcuIGluIGFuIGlmcmFtZQppZiAodGVzdEVsZW1lbnQuZG9TY3JvbGwgJiYgIWRvU2Nyb2xsV29ya3MoKSl7CgljaGVja3MucHVzaChkb1Njcm9sbFdvcmtzKTsKCXNob3VsZFBvbGwgPSB0cnVlOwp9Ci8qPC9sdElFOD4qLwoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUpIGNoZWNrcy5wdXNoKGZ1bmN0aW9uKCl7Cgl2YXIgc3RhdGUgPSBkb2N1bWVudC5yZWFkeVN0YXRlOwoJcmV0dXJuIChzdGF0ZSA9PSAnbG9hZGVkJyB8fCBzdGF0ZSA9PSAnY29tcGxldGUnKTsKfSk7CgppZiAoJ29ucmVhZHlzdGF0ZWNoYW5nZScgaW4gZG9jdW1lbnQpIGRvY3VtZW50LmFkZExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgY2hlY2spOwplbHNlIHNob3VsZFBvbGwgPSB0cnVlOwoKaWYgKHNob3VsZFBvbGwpIHBvbGwoKTsKCkVsZW1lbnQuRXZlbnRzLmRvbXJlYWR5ID0gewoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAocmVhZHkpIGZuLmNhbGwodGhpcyk7Cgl9Cn07CgovLyBNYWtlIHN1cmUgdGhhdCBkb21yZWFkeSBmaXJlcyBiZWZvcmUgbG9hZApFbGVtZW50LkV2ZW50cy5sb2FkID0gewoJYmFzZTogJ2xvYWQnLAoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAobG9hZGVkICYmIHRoaXMgPT0gd2luZG93KSBmbi5jYWxsKHRoaXMpOwoJfSwKCWNvbmRpdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcyA9PSB3aW5kb3cpewoJCQlkb21yZWFkeSgpOwoJCQlkZWxldGUgRWxlbWVudC5FdmVudHMubG9hZDsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9Cn07CgovLyBUaGlzIGlzIGJhc2VkIG9uIHRoZSBjdXN0b20gbG9hZCBldmVudAp3aW5kb3cuYWRkRXZlbnQoJ2xvYWQnLCBmdW5jdGlvbigpewoJbG9hZGVkID0gdHJ1ZTsKfSk7Cgp9KSh3aW5kb3csIGRvY3VtZW50KTsKCgovKgotLS0KCm5hbWU6IFN3aWZmCgpkZXNjcmlwdGlvbjogV3JhcHBlciBmb3IgZW1iZWRkaW5nIFNXRiBtb3ZpZXMuIFN1cHBvcnRzIEV4dGVybmFsIEludGVyZmFjZSBDb21tdW5pY2F0aW9uLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRmxhc2ggZGV0ZWN0aW9uICYgSW50ZXJuZXQgRXhwbG9yZXIgKyBGbGFzaCBQbGF5ZXIgOSBmaXggaW5zcGlyZWQgYnkgU1dGT2JqZWN0LgoKcmVxdWlyZXM6IFtPcHRpb25zLCBPYmplY3QsIEVsZW1lbnRdCgpwcm92aWRlczogU3dpZmYKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgU3dpZmYgPSB0aGlzLlN3aWZmID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlpZDogbnVsbCwKCQloZWlnaHQ6IDEsCgkJd2lkdGg6IDEsCgkJY29udGFpbmVyOiBudWxsLAoJCXByb3BlcnRpZXM6IHt9LAoJCXBhcmFtczogewoJCQlxdWFsaXR5OiAnaGlnaCcsCgkJCWFsbG93U2NyaXB0QWNjZXNzOiAnYWx3YXlzJywKCQkJd01vZGU6ICd3aW5kb3cnLAoJCQlzd0xpdmVDb25uZWN0OiB0cnVlCgkJfSwKCQljYWxsQmFja3M6IHt9LAoJCXZhcnM6IHt9Cgl9LAoKCXRvRWxlbWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vYmplY3Q7Cgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKHBhdGgsIG9wdGlvbnMpewoJCXRoaXMuaW5zdGFuY2UgPSAnU3dpZmZfJyArIFN0cmluZy51bmlxdWVJRCgpOwoKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCQl2YXIgaWQgPSB0aGlzLmlkID0gb3B0aW9ucy5pZCB8fCB0aGlzLmluc3RhbmNlOwoJCXZhciBjb250YWluZXIgPSBkb2N1bWVudC5pZChvcHRpb25zLmNvbnRhaW5lcik7CgoJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXSA9IHt9OwoKCQl2YXIgcGFyYW1zID0gb3B0aW9ucy5wYXJhbXMsIHZhcnMgPSBvcHRpb25zLnZhcnMsIGNhbGxCYWNrcyA9IG9wdGlvbnMuY2FsbEJhY2tzOwoJCXZhciBwcm9wZXJ0aWVzID0gT2JqZWN0LmFwcGVuZCh7aGVpZ2h0OiBvcHRpb25zLmhlaWdodCwgd2lkdGg6IG9wdGlvbnMud2lkdGh9LCBvcHRpb25zLnByb3BlcnRpZXMpOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWZvciAodmFyIGNhbGxCYWNrIGluIGNhbGxCYWNrcyl7CgkJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXVtjYWxsQmFja10gPSAoZnVuY3Rpb24ob3B0aW9uKXsKCQkJCXJldHVybiBmdW5jdGlvbigpewoJCQkJCXJldHVybiBvcHRpb24uYXBwbHkoc2VsZi5vYmplY3QsIGFyZ3VtZW50cyk7CgkJCQl9OwoJCQl9KShjYWxsQmFja3NbY2FsbEJhY2tdKTsKCQkJdmFyc1tjYWxsQmFja10gPSAnU3dpZmYuQ2FsbEJhY2tzLicgKyB0aGlzLmluc3RhbmNlICsgJy4nICsgY2FsbEJhY2s7CgkJfQoKCQlwYXJhbXMuZmxhc2hWYXJzID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFycyk7CgkJaWYgKEJyb3dzZXIuaWUpewoJCQlwcm9wZXJ0aWVzLmNsYXNzaWQgPSAnY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwJzsKCQkJcGFyYW1zLm1vdmllID0gcGF0aDsKCQl9IGVsc2UgewoJCQlwcm9wZXJ0aWVzLnR5cGUgPSAnYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2gnOwoJCX0KCQlwcm9wZXJ0aWVzLmRhdGEgPSBwYXRoOwoKCQl2YXIgYnVpbGQgPSAnPG9iamVjdCBpZD0iJyArIGlkICsgJyInOwoJCWZvciAodmFyIHByb3BlcnR5IGluIHByb3BlcnRpZXMpIGJ1aWxkICs9ICcgJyArIHByb3BlcnR5ICsgJz0iJyArIHByb3BlcnRpZXNbcHJvcGVydHldICsgJyInOwoJCWJ1aWxkICs9ICc+JzsKCQlmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpewoJCQlpZiAocGFyYW1zW3BhcmFtXSkgYnVpbGQgKz0gJzxwYXJhbSBuYW1lPSInICsgcGFyYW0gKyAnIiB2YWx1ZT0iJyArIHBhcmFtc1twYXJhbV0gKyAnIiAvPic7CgkJfQoJCWJ1aWxkICs9ICc8L29iamVjdD4nOwoJCXRoaXMub2JqZWN0ID0gKChjb250YWluZXIpID8gY29udGFpbmVyLmVtcHR5KCkgOiBuZXcgRWxlbWVudCgnZGl2JykpLnNldCgnaHRtbCcsIGJ1aWxkKS5maXJzdENoaWxkOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJZWxlbWVudCA9IGRvY3VtZW50LmlkKGVsZW1lbnQsIHRydWUpOwoJCWVsZW1lbnQucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy50b0VsZW1lbnQoKSwgZWxlbWVudCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWxlbWVudCl7CgkJZG9jdW1lbnQuaWQoZWxlbWVudCwgdHJ1ZSkuYXBwZW5kQ2hpbGQodGhpcy50b0VsZW1lbnQoKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW90ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3dpZmYucmVtb3RlLmFwcGx5KFN3aWZmLCBbdGhpcy50b0VsZW1lbnQoKV0uYXBwZW5kKGFyZ3VtZW50cykpOwoJfQoKfSk7CgpTd2lmZi5DYWxsQmFja3MgPSB7fTsKClN3aWZmLnJlbW90ZSA9IGZ1bmN0aW9uKG9iaiwgZm4pewoJdmFyIHJzID0gb2JqLkNhbGxGdW5jdGlvbignPGludm9rZSBuYW1lPSInICsgZm4gKyAnIiByZXR1cm50eXBlPSJqYXZhc2NyaXB0Ij4nICsgX19mbGFzaF9fYXJndW1lbnRzVG9YTUwoYXJndW1lbnRzLCAyKSArICc8L2ludm9rZT4nKTsKCXJldHVybiBldmFsKHJzKTsKfTsKCn0pKCk7Cgo=",
                "body": "LyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzc2YmY0NzA2MmQ2YzE5ODNkNjZjZTQ3YWQ2NmFhMGUwCgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EZWxlZ2F0aW9uIENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi4uLgoqLwoKLyoKLS0tCgpuYW1lOiBDb3JlCgpkZXNjcmlwdGlvbjogVGhlIGhlYXJ0IG9mIE1vb1Rvb2xzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjb3B5cmlnaHQ6IENvcHlyaWdodCAoYykgMjAwNi0yMDEyIFtWYWxlcmlvIFByb2lldHRpXShodHRwOi8vbWFkNG1pbGsubmV0LykuCgphdXRob3JzOiBUaGUgTW9vVG9vbHMgcHJvZHVjdGlvbiB0ZWFtIChodHRwOi8vbW9vdG9vbHMubmV0L2RldmVsb3BlcnMvKQoKaW5zcGlyYXRpb246CiAgLSBDbGFzcyBpbXBsZW1lbnRhdGlvbiBpbnNwaXJlZCBieSBbQmFzZS5qc10oaHR0cDovL2RlYW4uZWR3YXJkcy5uYW1lL3dlYmxvZy8yMDA2LzAzL2Jhc2UvKSBDb3B5cmlnaHQgKGMpIDIwMDYgRGVhbiBFZHdhcmRzLCBbR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbGdwbC1saWNlbnNlLnBocCkKICAtIFNvbWUgZnVuY3Rpb25hbGl0eSBpbnNwaXJlZCBieSBbUHJvdG90eXBlLmpzXShodHRwOi8vcHJvdG90eXBlanMub3JnKSBDb3B5cmlnaHQgKGMpIDIwMDUtMjAwNyBTYW0gU3RlcGhlbnNvbiwgW01JVCBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoKcHJvdmlkZXM6IFtDb3JlLCBNb29Ub29scywgVHlwZSwgdHlwZU9mLCBpbnN0YW5jZU9mLCBOYXRpdmVdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5Nb29Ub29scyA9IHsKCXZlcnNpb246ICcxLjQuNScsCglidWlsZDogJzc0ZTM0Nzk2ZjVmNzY2NDBjZGI5ODg1MzAwNDY1MGFlYTE0OTlkNjknCn07CgovLyB0eXBlT2YsIGluc3RhbmNlT2YKCnZhciB0eXBlT2YgPSB0aGlzLnR5cGVPZiA9IGZ1bmN0aW9uKGl0ZW0pewoJaWYgKGl0ZW0gPT0gbnVsbCkgcmV0dXJuICdudWxsJzsKCWlmIChpdGVtLiRmYW1pbHkgIT0gbnVsbCkgcmV0dXJuIGl0ZW0uJGZhbWlseSgpOwoKCWlmIChpdGVtLm5vZGVOYW1lKXsKCQlpZiAoaXRlbS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gJ2VsZW1lbnQnOwoJCWlmIChpdGVtLm5vZGVUeXBlID09IDMpIHJldHVybiAoL1xTLykudGVzdChpdGVtLm5vZGVWYWx1ZSkgPyAndGV4dG5vZGUnIDogJ3doaXRlc3BhY2UnOwoJfSBlbHNlIGlmICh0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicpewoJCWlmIChpdGVtLmNhbGxlZSkgcmV0dXJuICdhcmd1bWVudHMnOwoJCWlmICgnaXRlbScgaW4gaXRlbSkgcmV0dXJuICdjb2xsZWN0aW9uJzsKCX0KCglyZXR1cm4gdHlwZW9mIGl0ZW07Cn07Cgp2YXIgaW5zdGFuY2VPZiA9IHRoaXMuaW5zdGFuY2VPZiA9IGZ1bmN0aW9uKGl0ZW0sIG9iamVjdCl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gZmFsc2U7Cgl2YXIgY29uc3RydWN0b3IgPSBpdGVtLiRjb25zdHJ1Y3RvciB8fCBpdGVtLmNvbnN0cnVjdG9yOwoJd2hpbGUgKGNvbnN0cnVjdG9yKXsKCQlpZiAoY29uc3RydWN0b3IgPT09IG9iamVjdCkgcmV0dXJuIHRydWU7CgkJY29uc3RydWN0b3IgPSBjb25zdHJ1Y3Rvci5wYXJlbnQ7Cgl9CgkvKjxsdElFOD4qLwoJaWYgKCFpdGVtLmhhc093blByb3BlcnR5KSByZXR1cm4gZmFsc2U7CgkvKjwvbHRJRTg+Ki8KCXJldHVybiBpdGVtIGluc3RhbmNlb2Ygb2JqZWN0Owp9OwoKLy8gRnVuY3Rpb24gb3ZlcmxvYWRpbmcKCnZhciBGdW5jdGlvbiA9IHRoaXMuRnVuY3Rpb247Cgp2YXIgZW51bWVyYWJsZXMgPSB0cnVlOwpmb3IgKHZhciBpIGluIHt0b1N0cmluZzogMX0pIGVudW1lcmFibGVzID0gbnVsbDsKaWYgKGVudW1lcmFibGVzKSBlbnVtZXJhYmxlcyA9IFsnaGFzT3duUHJvcGVydHknLCAndmFsdWVPZicsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ2NvbnN0cnVjdG9yJ107CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRTZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewoJCWlmIChhID09IG51bGwpIHJldHVybiB0aGlzOwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpewoJCQlmb3IgKHZhciBrIGluIGEpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJaWYgKGVudW1lcmFibGVzKSBmb3IgKHZhciBpID0gZW51bWVyYWJsZXMubGVuZ3RoOyBpLS07KXsKCQkJCWsgPSBlbnVtZXJhYmxlc1tpXTsKCQkJCWlmIChhLmhhc093blByb3BlcnR5KGspKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCX0KCQl9IGVsc2UgewoJCQlzZWxmLmNhbGwodGhpcywgYSwgYik7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZEdldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSl7CgkJdmFyIGFyZ3MsIHJlc3VsdDsKCQlpZiAodHlwZW9mIGEgIT0gJ3N0cmluZycpIGFyZ3MgPSBhOwoJCWVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSBhcmdzID0gYXJndW1lbnRzOwoJCWVsc2UgaWYgKHVzZVBsdXJhbCkgYXJncyA9IFthXTsKCQlpZiAoYXJncyl7CgkJCXJlc3VsdCA9IHt9OwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHJlc3VsdFthcmdzW2ldXSA9IHNlbGYuY2FsbCh0aGlzLCBhcmdzW2ldKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSBzZWxmLmNhbGwodGhpcywgYSk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpc1trZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXMucHJvdG90eXBlW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKLy8gRnJvbQoKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKRnVuY3Rpb24uZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gJ2Z1bmN0aW9uJykgPyBpdGVtIDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gaXRlbTsKCX07Cn07CgpBcnJheS5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gW107CglyZXR1cm4gKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pICYmIHR5cGVvZiBpdGVtICE9ICdzdHJpbmcnKSA/ICh0eXBlT2YoaXRlbSkgPT0gJ2FycmF5JykgPyBpdGVtIDogc2xpY2UuY2FsbChpdGVtKSA6IFtpdGVtXTsKfTsKCk51bWJlci5mcm9tID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgbnVtYmVyID0gcGFyc2VGbG9hdChpdGVtKTsKCXJldHVybiBpc0Zpbml0ZShudW1iZXIpID8gbnVtYmVyIDogbnVsbDsKfTsKClN0cmluZy5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbSArICcnOwp9OwoKLy8gaGlkZSwgcHJvdGVjdAoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgloaWRlOiBmdW5jdGlvbigpewoJCXRoaXMuJGhpZGRlbiA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByb3RlY3Q6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kcHJvdGVjdGVkID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gVHlwZQoKdmFyIFR5cGUgPSB0aGlzLlR5cGUgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QpewoJaWYgKG5hbWUpewoJCXZhciBsb3dlciA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQl2YXIgdHlwZUNoZWNrID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiAodHlwZU9mKGl0ZW0pID09IGxvd2VyKTsKCQl9OwoKCQlUeXBlWydpcycgKyBuYW1lXSA9IHR5cGVDaGVjazsKCQlpZiAob2JqZWN0ICE9IG51bGwpewoJCQlvYmplY3QucHJvdG90eXBlLiRmYW1pbHkgPSAoZnVuY3Rpb24oKXsKCQkJCXJldHVybiBsb3dlcjsKCQkJfSkuaGlkZSgpOwoJCQkKCQl9Cgl9CgoJaWYgKG9iamVjdCA9PSBudWxsKSByZXR1cm4gbnVsbDsKCglvYmplY3QuZXh0ZW5kKHRoaXMpOwoJb2JqZWN0LiRjb25zdHJ1Y3RvciA9IFR5cGU7CglvYmplY3QucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG9iamVjdDsKCglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKClR5cGUuaXNFbnVtZXJhYmxlID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gKGl0ZW0gIT0gbnVsbCAmJiB0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicgJiYgdG9TdHJpbmcuY2FsbChpdGVtKSAhPSAnW29iamVjdCBGdW5jdGlvbl0nICk7Cn07Cgp2YXIgaG9va3MgPSB7fTsKCnZhciBob29rc09mID0gZnVuY3Rpb24ob2JqZWN0KXsKCXZhciB0eXBlID0gdHlwZU9mKG9iamVjdC5wcm90b3R5cGUpOwoJcmV0dXJuIGhvb2tzW3R5cGVdIHx8IChob29rc1t0eXBlXSA9IFtdKTsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuOwoKCXZhciBob29rcyA9IGhvb2tzT2YodGhpcyk7CgoJZm9yICh2YXIgaSA9IDA7IGkgPCBob29rcy5sZW5ndGg7IGkrKyl7CgkJdmFyIGhvb2sgPSBob29rc1tpXTsKCQlpZiAodHlwZU9mKGhvb2spID09ICd0eXBlJykgaW1wbGVtZW50LmNhbGwoaG9vaywgbmFtZSwgbWV0aG9kKTsKCQllbHNlIGhvb2suY2FsbCh0aGlzLCBuYW1lLCBtZXRob2QpOwoJfQoKCXZhciBwcmV2aW91cyA9IHRoaXMucHJvdG90eXBlW25hbWVdOwoJaWYgKHByZXZpb3VzID09IG51bGwgfHwgIXByZXZpb3VzLiRwcm90ZWN0ZWQpIHRoaXMucHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoKCWlmICh0aGlzW25hbWVdID09IG51bGwgJiYgdHlwZU9mKG1ldGhvZCkgPT0gJ2Z1bmN0aW9uJykgZXh0ZW5kLmNhbGwodGhpcywgbmFtZSwgZnVuY3Rpb24oaXRlbSl7CgkJcmV0dXJuIG1ldGhvZC5hcHBseShpdGVtLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJfSk7Cn07Cgp2YXIgZXh0ZW5kID0gZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWlmIChtZXRob2QgJiYgbWV0aG9kLiRoaWRkZW4pIHJldHVybjsKCXZhciBwcmV2aW91cyA9IHRoaXNbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpc1tuYW1lXSA9IG1ldGhvZDsKfTsKClR5cGUuaW1wbGVtZW50KHsKCglpbXBsZW1lbnQ6IGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpLAoKCWV4dGVuZDogZXh0ZW5kLm92ZXJsb2FkU2V0dGVyKCksCgoJYWxpYXM6IGZ1bmN0aW9uKG5hbWUsIGV4aXN0aW5nKXsKCQlpbXBsZW1lbnQuY2FsbCh0aGlzLCBuYW1lLCB0aGlzLnByb3RvdHlwZVtleGlzdGluZ10pOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCW1pcnJvcjogZnVuY3Rpb24oaG9vayl7CgkJaG9va3NPZih0aGlzKS5wdXNoKGhvb2spOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpuZXcgVHlwZSgnVHlwZScsIFR5cGUpOwoKLy8gRGVmYXVsdCBUeXBlcwoKdmFyIGZvcmNlID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0LCBtZXRob2RzKXsKCXZhciBpc1R5cGUgPSAob2JqZWN0ICE9IE9iamVjdCksCgkJcHJvdG90eXBlID0gb2JqZWN0LnByb3RvdHlwZTsKCglpZiAoaXNUeXBlKSBvYmplY3QgPSBuZXcgVHlwZShuYW1lLCBvYmplY3QpOwoKCWZvciAodmFyIGkgPSAwLCBsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCXZhciBrZXkgPSBtZXRob2RzW2ldLAoJCQlnZW5lcmljID0gb2JqZWN0W2tleV0sCgkJCXByb3RvID0gcHJvdG90eXBlW2tleV07CgoJCWlmIChnZW5lcmljKSBnZW5lcmljLnByb3RlY3QoKTsKCQlpZiAoaXNUeXBlICYmIHByb3RvKSBvYmplY3QuaW1wbGVtZW50KGtleSwgcHJvdG8ucHJvdGVjdCgpKTsKCX0KCglpZiAoaXNUeXBlKXsKCQl2YXIgbWV0aG9kc0VudW1lcmFibGUgPSBwcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGUobWV0aG9kc1swXSk7CgkJb2JqZWN0LmZvckVhY2hNZXRob2QgPSBmdW5jdGlvbihmbil7CgkJCWlmICghbWV0aG9kc0VudW1lcmFibGUpIGZvciAodmFyIGkgPSAwLCBsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQkJZm4uY2FsbChwcm90b3R5cGUsIHByb3RvdHlwZVttZXRob2RzW2ldXSwgbWV0aG9kc1tpXSk7CgkJCX0KCQkJZm9yICh2YXIga2V5IGluIHByb3RvdHlwZSkgZm4uY2FsbChwcm90b3R5cGUsIHByb3RvdHlwZVtrZXldLCBrZXkpCgkJfTsKCX0KCglyZXR1cm4gZm9yY2U7Cn07Cgpmb3JjZSgnU3RyaW5nJywgU3RyaW5nLCBbCgknY2hhckF0JywgJ2NoYXJDb2RlQXQnLCAnY29uY2F0JywgJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAnbWF0Y2gnLCAncXVvdGUnLCAncmVwbGFjZScsICdzZWFyY2gnLAoJJ3NsaWNlJywgJ3NwbGl0JywgJ3N1YnN0cicsICdzdWJzdHJpbmcnLCAndHJpbScsICd0b0xvd2VyQ2FzZScsICd0b1VwcGVyQ2FzZScKXSkoJ0FycmF5JywgQXJyYXksIFsKCSdwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnLCAnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnLAoJJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAnZmlsdGVyJywgJ2ZvckVhY2gnLCAnZXZlcnknLCAnbWFwJywgJ3NvbWUnLCAncmVkdWNlJywgJ3JlZHVjZVJpZ2h0JwpdKSgnTnVtYmVyJywgTnVtYmVyLCBbCgkndG9FeHBvbmVudGlhbCcsICd0b0ZpeGVkJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvUHJlY2lzaW9uJwpdKSgnRnVuY3Rpb24nLCBGdW5jdGlvbiwgWwoJJ2FwcGx5JywgJ2NhbGwnLCAnYmluZCcKXSkoJ1JlZ0V4cCcsIFJlZ0V4cCwgWwoJJ2V4ZWMnLCAndGVzdCcKXSkoJ09iamVjdCcsIE9iamVjdCwgWwoJJ2NyZWF0ZScsICdkZWZpbmVQcm9wZXJ0eScsICdkZWZpbmVQcm9wZXJ0aWVzJywgJ2tleXMnLAoJJ2dldFByb3RvdHlwZU9mJywgJ2dldE93blByb3BlcnR5RGVzY3JpcHRvcicsICdnZXRPd25Qcm9wZXJ0eU5hbWVzJywKCSdwcmV2ZW50RXh0ZW5zaW9ucycsICdpc0V4dGVuc2libGUnLCAnc2VhbCcsICdpc1NlYWxlZCcsICdmcmVlemUnLCAnaXNGcm96ZW4nCl0pKCdEYXRlJywgRGF0ZSwgWydub3cnXSk7CgpPYmplY3QuZXh0ZW5kID0gZXh0ZW5kLm92ZXJsb2FkU2V0dGVyKCk7CgpEYXRlLmV4dGVuZCgnbm93JywgZnVuY3Rpb24oKXsKCXJldHVybiArKG5ldyBEYXRlKTsKfSk7CgpuZXcgVHlwZSgnQm9vbGVhbicsIEJvb2xlYW4pOwoKLy8gZml4ZXMgTmFOIHJldHVybmluZyBhcyBOdW1iZXIKCk51bWJlci5wcm90b3R5cGUuJGZhbWlseSA9IGZ1bmN0aW9uKCl7CglyZXR1cm4gaXNGaW5pdGUodGhpcykgPyAnbnVtYmVyJyA6ICdudWxsJzsKfS5oaWRlKCk7CgovLyBOdW1iZXIucmFuZG9tCgpOdW1iZXIuZXh0ZW5kKCdyYW5kb20nLCBmdW5jdGlvbihtaW4sIG1heCl7CglyZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpICsgbWluKTsKfSk7CgovLyBmb3JFYWNoLCBlYWNoCgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwpPYmplY3QuZXh0ZW5kKCdmb3JFYWNoJywgZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7Cglmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCX0KfSk7CgpPYmplY3QuZWFjaCA9IE9iamVjdC5mb3JFYWNoOwoKQXJyYXkuaW1wbGVtZW50KHsKCglmb3JFYWNoOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmIChpIGluIHRoaXMpIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcyk7CgkJfQoJfSwKCgllYWNoOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJQXJyYXkuZm9yRWFjaCh0aGlzLCBmbiwgYmluZCk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8vIEFycmF5ICYgT2JqZWN0IGNsb25pbmcsIE9iamVjdCBtZXJnaW5nIGFuZCBhcHBlbmRpbmcKCnZhciBjbG9uZU9mID0gZnVuY3Rpb24oaXRlbSl7Cglzd2l0Y2ggKHR5cGVPZihpdGVtKSl7CgkJY2FzZSAnYXJyYXknOiByZXR1cm4gaXRlbS5jbG9uZSgpOwoJCWNhc2UgJ29iamVjdCc6IHJldHVybiBPYmplY3QuY2xvbmUoaXRlbSk7CgkJZGVmYXVsdDogcmV0dXJuIGl0ZW07Cgl9Cn07CgpBcnJheS5pbXBsZW1lbnQoJ2Nsb25lJywgZnVuY3Rpb24oKXsKCXZhciBpID0gdGhpcy5sZW5ndGgsIGNsb25lID0gbmV3IEFycmF5KGkpOwoJd2hpbGUgKGktLSkgY2xvbmVbaV0gPSBjbG9uZU9mKHRoaXNbaV0pOwoJcmV0dXJuIGNsb25lOwp9KTsKCnZhciBtZXJnZU9uZSA9IGZ1bmN0aW9uKHNvdXJjZSwga2V5LCBjdXJyZW50KXsKCXN3aXRjaCAodHlwZU9mKGN1cnJlbnQpKXsKCQljYXNlICdvYmplY3QnOgoJCQlpZiAodHlwZU9mKHNvdXJjZVtrZXldKSA9PSAnb2JqZWN0JykgT2JqZWN0Lm1lcmdlKHNvdXJjZVtrZXldLCBjdXJyZW50KTsKCQkJZWxzZSBzb3VyY2Vba2V5XSA9IE9iamVjdC5jbG9uZShjdXJyZW50KTsKCQlicmVhazsKCQljYXNlICdhcnJheSc6IHNvdXJjZVtrZXldID0gY3VycmVudC5jbG9uZSgpOyBicmVhazsKCQlkZWZhdWx0OiBzb3VyY2Vba2V5XSA9IGN1cnJlbnQ7Cgl9CglyZXR1cm4gc291cmNlOwp9OwoKT2JqZWN0LmV4dGVuZCh7CgoJbWVyZ2U6IGZ1bmN0aW9uKHNvdXJjZSwgaywgdil7CgkJaWYgKHR5cGVPZihrKSA9PSAnc3RyaW5nJykgcmV0dXJuIG1lcmdlT25lKHNvdXJjZSwgaywgdik7CgkJZm9yICh2YXIgaSA9IDEsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIG9iamVjdCA9IGFyZ3VtZW50c1tpXTsKCQkJZm9yICh2YXIga2V5IGluIG9iamVjdCkgbWVyZ2VPbmUoc291cmNlLCBrZXksIG9iamVjdFtrZXldKTsKCQl9CgkJcmV0dXJuIHNvdXJjZTsKCX0sCgoJY2xvbmU6IGZ1bmN0aW9uKG9iamVjdCl7CgkJdmFyIGNsb25lID0ge307CgkJZm9yICh2YXIga2V5IGluIG9iamVjdCkgY2xvbmVba2V5XSA9IGNsb25lT2Yob2JqZWN0W2tleV0pOwoJCXJldHVybiBjbG9uZTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbihvcmlnaW5hbCl7CgkJZm9yICh2YXIgaSA9IDEsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGV4dGVuZGVkID0gYXJndW1lbnRzW2ldIHx8IHt9OwoJCQlmb3IgKHZhciBrZXkgaW4gZXh0ZW5kZWQpIG9yaWdpbmFsW2tleV0gPSBleHRlbmRlZFtrZXldOwoJCX0KCQlyZXR1cm4gb3JpZ2luYWw7Cgl9Cgp9KTsKCi8vIE9iamVjdC1sZXNzIHR5cGVzCgpbJ09iamVjdCcsICdXaGl0ZVNwYWNlJywgJ1RleHROb2RlJywgJ0NvbGxlY3Rpb24nLCAnQXJndW1lbnRzJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCW5ldyBUeXBlKG5hbWUpOwp9KTsKCi8vIFVuaXF1ZSBJRAoKdmFyIFVJRCA9IERhdGUubm93KCk7CgpTdHJpbmcuZXh0ZW5kKCd1bmlxdWVJRCcsIGZ1bmN0aW9uKCl7CglyZXR1cm4gKFVJRCsrKS50b1N0cmluZygzNik7Cn0pOwoKCgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQXJyYXkKCmRlc2NyaXB0aW9uOiBDb250YWlucyBBcnJheSBQcm90b3R5cGVzIGxpa2UgZWFjaCwgY29udGFpbnMsIGFuZCBlcmFzZS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBBcnJheQoKLi4uCiovCgpBcnJheS5pbXBsZW1lbnQoewoKCS8qPCFFUzU+Ki8KCWV2ZXJ5OiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCA+Pj4gMDsgaSA8IGw7IGkrKyl7CgkJCWlmICgoaSBpbiB0aGlzKSAmJiAhZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJZmlsdGVyOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSBbXTsKCQlmb3IgKHZhciB2YWx1ZSwgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCA+Pj4gMDsgaSA8IGw7IGkrKykgaWYgKGkgaW4gdGhpcyl7CgkJCXZhbHVlID0gdGhpc1tpXTsKCQkJaWYgKGZuLmNhbGwoYmluZCwgdmFsdWUsIGksIHRoaXMpKSByZXN1bHRzLnB1c2godmFsdWUpOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJaW5kZXhPZjogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoID4+PiAwOwoJCWZvciAodmFyIGkgPSAoZnJvbSA8IDApID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgZnJvbSkgOiBmcm9tIHx8IDA7IGkgPCBsZW5ndGg7IGkrKyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsKCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggPj4+IDAsIHJlc3VsdHMgPSBBcnJheShsZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSByZXN1bHRzW2ldID0gZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoID4+PiAwOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoJLyo8LyFFUzU+Ki8KCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtICE9IG51bGw7CgkJfSk7Cgl9LAoKCWludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSl7CgkJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW1bbWV0aG9kTmFtZV0uYXBwbHkoaXRlbSwgYXJncyk7CgkJfSk7Cgl9LAoKCWFzc29jaWF0ZTogZnVuY3Rpb24oa2V5cyl7CgkJdmFyIG9iaiA9IHt9LCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmxlbmd0aCwga2V5cy5sZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIG9ialtrZXlzW2ldXSA9IHRoaXNbaV07CgkJcmV0dXJuIG9iajsKCX0sCgoJbGluazogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgcmVzdWx0ID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQkJaWYgKG9iamVjdFtrZXldKHRoaXNbaV0pKXsKCQkJCQlyZXN1bHRba2V5XSA9IHRoaXNbaV07CgkJCQkJZGVsZXRlIG9iamVjdFtrZXldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGFycmF5KXsKCQl0aGlzLnB1c2guYXBwbHkodGhpcywgYXJyYXkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1t0aGlzLmxlbmd0aCAtIDFdIDogbnVsbDsKCX0sCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1tOdW1iZXIucmFuZG9tKDAsIHRoaXMubGVuZ3RoIC0gMSldIDogbnVsbDsKCX0sCgoJaW5jbHVkZTogZnVuY3Rpb24oaXRlbSl7CgkJaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW0pKSB0aGlzLnB1c2goaXRlbSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGl0ZW0pewoJCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSB0aGlzLnNwbGljZShpLCAxKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmxhdHRlbjogZnVuY3Rpb24oKXsKCQl2YXIgYXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIHR5cGUgPSB0eXBlT2YodGhpc1tpXSk7CgkJCWlmICh0eXBlID09ICdudWxsJykgY29udGludWU7CgkJCWFycmF5ID0gYXJyYXkuY29uY2F0KCh0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnY29sbGVjdGlvbicgfHwgdHlwZSA9PSAnYXJndW1lbnRzJyB8fCBpbnN0YW5jZU9mKHRoaXNbaV0sIEFycmF5KSkgPyBBcnJheS5mbGF0dGVuKHRoaXNbaV0pIDogdGhpc1tpXSk7CgkJfQoJCXJldHVybiBhcnJheTsKCX0sCgoJcGljazogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gIT0gbnVsbCkgcmV0dXJuIHRoaXNbaV07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gbnVsbDsKCQl2YXIgcmdiID0gdGhpcy5tYXAoZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubGVuZ3RoID09IDEpIHZhbHVlICs9IHZhbHVlOwoJCQlyZXR1cm4gdmFsdWUudG9JbnQoMTYpOwoJCX0pOwoJCXJldHVybiAoYXJyYXkpID8gcmdiIDogJ3JnYignICsgcmdiICsgJyknOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gKGFycmF5KSA/IGhleCA6ICcjJyArIGhleC5qb2luKCcnKTsKCX0KCn0pOwoKCgoKLyoKLS0tCgpuYW1lOiBTdHJpbmcKCmRlc2NyaXB0aW9uOiBDb250YWlucyBTdHJpbmcgUHJvdG90eXBlcyBsaWtlIGNhbWVsQ2FzZSwgY2FwaXRhbGl6ZSwgdGVzdCwgYW5kIHRvSW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFN0cmluZwoKLi4uCiovCgpTdHJpbmcuaW1wbGVtZW50KHsKCgl0ZXN0OiBmdW5jdGlvbihyZWdleCwgcGFyYW1zKXsKCQlyZXR1cm4gKCh0eXBlT2YocmVnZXgpID09ICdyZWdleHAnKSA/IHJlZ2V4IDogbmV3IFJlZ0V4cCgnJyArIHJlZ2V4LCBwYXJhbXMpKS50ZXN0KHRoaXMpOwoJfSwKCgljb250YWluczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpewoJCXJldHVybiAoc2VwYXJhdG9yKSA/IChzZXBhcmF0b3IgKyB0aGlzICsgc2VwYXJhdG9yKS5pbmRleE9mKHNlcGFyYXRvciArIHN0cmluZyArIHNlcGFyYXRvcikgPiAtMSA6IFN0cmluZyh0aGlzKS5pbmRleE9mKHN0cmluZykgPiAtMTsKCX0sCgoJdHJpbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbigpewoJCXJldHVybiBTdHJpbmcodGhpcykucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwoJfSwKCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC8tXEQvZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWh5cGhlbmF0ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuICgnLScgKyBtYXRjaC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSk7CgkJfSk7Cgl9LAoKCWNhcGl0YWxpemU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC9cYlthLXpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWVzY2FwZVJlZ0V4cDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoLyhbLS4qKz9eJHt9KCl8W1xdXC9cXF0pL2csICdcXCQxJyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCWhleFRvUmdiOiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIGhleCA9IFN0cmluZyh0aGlzKS5tYXRjaCgvXiM/KFx3ezEsMn0pKFx3ezEsMn0pKFx3ezEsMn0pJC8pOwoJCXJldHVybiAoaGV4KSA/IGhleC5zbGljZSgxKS5oZXhUb1JnYihhcnJheSkgOiBudWxsOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCXZhciByZ2IgPSBTdHJpbmcodGhpcykubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IG51bGw7Cgl9LAoKCXN1YnN0aXR1dGU6IGZ1bmN0aW9uKG9iamVjdCwgcmVnZXhwKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UocmVnZXhwIHx8ICgvXFw/XHsoW157fV0rKVx9L2cpLCBmdW5jdGlvbihtYXRjaCwgbmFtZSl7CgkJCWlmIChtYXRjaC5jaGFyQXQoMCkgPT0gJ1xcJykgcmV0dXJuIG1hdGNoLnNsaWNlKDEpOwoJCQlyZXR1cm4gKG9iamVjdFtuYW1lXSAhPSBudWxsKSA/IG9iamVjdFtuYW1lXSA6ICcnOwoJCX0pOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBOdW1iZXIKCmRlc2NyaXB0aW9uOiBDb250YWlucyBOdW1iZXIgUHJvdG90eXBlcyBsaWtlIGxpbWl0LCByb3VuZCwgdGltZXMsIGFuZCBjZWlsLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IE51bWJlcgoKLi4uCiovCgpOdW1iZXIuaW1wbGVtZW50KHsKCglsaW1pdDogZnVuY3Rpb24obWluLCBtYXgpewoJCXJldHVybiBNYXRoLm1pbihtYXgsIE1hdGgubWF4KG1pbiwgdGhpcykpOwoJfSwKCglyb3VuZDogZnVuY3Rpb24ocHJlY2lzaW9uKXsKCQlwcmVjaXNpb24gPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uIHx8IDApLnRvRml4ZWQocHJlY2lzaW9uIDwgMCA/IC1wcmVjaXNpb24gOiAwKTsKCQlyZXR1cm4gTWF0aC5yb3VuZCh0aGlzICogcHJlY2lzaW9uKSAvIHByZWNpc2lvbjsKCX0sCgoJdGltZXM6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXM7IGkrKykgZm4uY2FsbChiaW5kLCBpLCB0aGlzKTsKCX0sCgoJdG9GbG9hdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh0aGlzKTsKCX0sCgoJdG9JbnQ6IGZ1bmN0aW9uKGJhc2UpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCBiYXNlIHx8IDEwKTsKCX0KCn0pOwoKTnVtYmVyLmFsaWFzKCdlYWNoJywgJ3RpbWVzJyk7CgooZnVuY3Rpb24obWF0aCl7Cgl2YXIgbWV0aG9kcyA9IHt9OwoJbWF0aC5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJCWlmICghTnVtYmVyW25hbWVdKSBtZXRob2RzW25hbWVdID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIE1hdGhbbmFtZV0uYXBwbHkobnVsbCwgW3RoaXNdLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQl9OwoJfSk7CglOdW1iZXIuaW1wbGVtZW50KG1ldGhvZHMpOwp9KShbJ2FicycsICdhY29zJywgJ2FzaW4nLCAnYXRhbicsICdhdGFuMicsICdjZWlsJywgJ2NvcycsICdleHAnLCAnZmxvb3InLCAnbG9nJywgJ21heCcsICdtaW4nLCAncG93JywgJ3NpbicsICdzcXJ0JywgJ3RhbiddKTsKCgovKgotLS0KCm5hbWU6IEZ1bmN0aW9uCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRnVuY3Rpb24gUHJvdG90eXBlcyBsaWtlIGNyZWF0ZSwgYmluZCwgcGFzcywgYW5kIGRlbGF5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEZ1bmN0aW9uCgouLi4KKi8KCkZ1bmN0aW9uLmV4dGVuZCh7CgoJYXR0ZW1wdDogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl0cnkgewoJCQkJcmV0dXJuIGFyZ3VtZW50c1tpXSgpOwoJCQl9IGNhdGNoIChlKXt9CgkJfQoJCXJldHVybiBudWxsOwoJfQoKfSk7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLmFwcGx5KGJpbmQsIEFycmF5LmZyb20oYXJncykpOwoJCX0gY2F0Y2ggKGUpe30KCgkJcmV0dXJuIG51bGw7Cgl9LAoKCS8qPCFFUzUtYmluZD4qLwoJYmluZDogZnVuY3Rpb24odGhhdCl7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbCwKCQkJRiA9IGZ1bmN0aW9uKCl7fTsKCgkJdmFyIGJvdW5kID0gZnVuY3Rpb24oKXsKCQkJdmFyIGNvbnRleHQgPSB0aGF0LCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwoJCQlpZiAodGhpcyBpbnN0YW5jZW9mIGJvdW5kKXsKCQkJCUYucHJvdG90eXBlID0gc2VsZi5wcm90b3R5cGU7CgkJCQljb250ZXh0ID0gbmV3IEY7CgkJCX0KCQkJdmFyIHJlc3VsdCA9ICghYXJncyAmJiAhbGVuZ3RoKQoJCQkJPyBzZWxmLmNhbGwoY29udGV4dCkKCQkJCTogc2VsZi5hcHBseShjb250ZXh0LCBhcmdzICYmIGxlbmd0aCA/IGFyZ3MuY29uY2F0KEFycmF5LnNsaWNlKGFyZ3VtZW50cykpIDogYXJncyB8fCBhcmd1bWVudHMpOwoJCQlyZXR1cm4gY29udGV4dCA9PSB0aGF0ID8gcmVzdWx0IDogY29udGV4dDsKCQl9OwoJCXJldHVybiBib3VuZDsKCX0sCgkvKjwvIUVTNS1iaW5kPiovCgoJcGFzczogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJZGVsYXk6IGZ1bmN0aW9uKGRlbGF5LCBiaW5kLCBhcmdzKXsKCQlyZXR1cm4gc2V0VGltZW91dCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBkZWxheSk7Cgl9LAoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKHBlcmlvZGljYWwsIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRJbnRlcnZhbCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBwZXJpb2RpY2FsKTsKCX0KCn0pOwoKCgoKLyoKLS0tCgpuYW1lOiBPYmplY3QKCmRlc2NyaXB0aW9uOiBPYmplY3QgZ2VuZXJpYyBtZXRob2RzCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogW09iamVjdCwgSGFzaF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKT2JqZWN0LmV4dGVuZCh7CgoJc3Vic2V0OiBmdW5jdGlvbihvYmplY3QsIGtleXMpewoJCXZhciByZXN1bHRzID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBrID0ga2V5c1tpXTsKCQkJaWYgKGsgaW4gb2JqZWN0KSByZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSAmJiBmbi5jYWxsKGJpbmQsIHZhbHVlLCBrZXksIG9iamVjdCkpIHJlc3VsdHNba2V5XSA9IHZhbHVlOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKfSkoKTsKCgoKCi8qCi0tLQoKbmFtZTogQnJvd3NlcgoKZGVzY3JpcHRpb246IFRoZSBCcm93c2VyIE9iamVjdC4gQ29udGFpbnMgQnJvd3NlciBpbml0aWFsaXphdGlvbiwgV2luZG93IGFuZCBEb2N1bWVudCwgYW5kIHRoZSBCcm93c2VyIEhhc2guCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIEZ1bmN0aW9uLCBOdW1iZXIsIFN0cmluZ10KCnByb3ZpZGVzOiBbQnJvd3NlciwgV2luZG93LCBEb2N1bWVudF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50Owp2YXIgd2luZG93ID0gZG9jdW1lbnQud2luZG93ID0gdGhpczsKCnZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSwKCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLnRvTG93ZXJDYXNlKCksCglVQSA9IHVhLm1hdGNoKC8ob3BlcmF8aWV8ZmlyZWZveHxjaHJvbWV8dmVyc2lvbilbXHNcLzpdKFtcd1xkXC5dKyk/Lio/KHNhZmFyaXx2ZXJzaW9uW1xzXC86XShbXHdcZFwuXSspfCQpLykgfHwgW251bGwsICd1bmtub3duJywgMF0sCgltb2RlID0gVUFbMV0gPT0gJ2llJyAmJiBkb2N1bWVudC5kb2N1bWVudE1vZGU7Cgp2YXIgQnJvd3NlciA9IHRoaXMuQnJvd3NlciA9IHsKCglleHRlbmQ6IEZ1bmN0aW9uLnByb3RvdHlwZS5leHRlbmQsCgoJbmFtZTogKFVBWzFdID09ICd2ZXJzaW9uJykgPyBVQVszXSA6IFVBWzFdLAoKCXZlcnNpb246IG1vZGUgfHwgcGFyc2VGbG9hdCgoVUFbMV0gPT0gJ29wZXJhJyAmJiBVQVs0XSkgPyBVQVs0XSA6IFVBWzJdKSwKCglQbGF0Zm9ybTogewoJCW5hbWU6IHVhLm1hdGNoKC9pcCg/OmFkfG9kfGhvbmUpLykgPyAnaW9zJyA6ICh1YS5tYXRjaCgvKD86d2Vib3N8YW5kcm9pZCkvKSB8fCBwbGF0Zm9ybS5tYXRjaCgvbWFjfHdpbnxsaW51eC8pIHx8IFsnb3RoZXInXSlbMF0KCX0sCgoJRmVhdHVyZXM6IHsKCQl4cGF0aDogISEoZG9jdW1lbnQuZXZhbHVhdGUpLAoJCWFpcjogISEod2luZG93LnJ1bnRpbWUpLAoJCXF1ZXJ5OiAhIShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKSwKCQlqc29uOiAhISh3aW5kb3cuSlNPTikKCX0sCgoJUGx1Z2luczoge30KCn07CgpCcm93c2VyW0Jyb3dzZXIubmFtZV0gPSB0cnVlOwpCcm93c2VyW0Jyb3dzZXIubmFtZSArIHBhcnNlSW50KEJyb3dzZXIudmVyc2lvbiwgMTApXSA9IHRydWU7CkJyb3dzZXIuUGxhdGZvcm1bQnJvd3Nlci5QbGF0Zm9ybS5uYW1lXSA9IHRydWU7CgovLyBSZXF1ZXN0CgpCcm93c2VyLlJlcXVlc3QgPSAoZnVuY3Rpb24oKXsKCgl2YXIgWE1MSFRUUCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJfTsKCgl2YXIgTVNYTUwyID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01TWE1MMi5YTUxIVFRQJyk7Cgl9OwoKCXZhciBNU1hNTCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwoJfTsKCglyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCVhNTEhUVFAoKTsKCQlyZXR1cm4gWE1MSFRUUDsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwyKCk7CgkJcmV0dXJuIE1TWE1MMjsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwoKTsKCQlyZXR1cm4gTVNYTUw7Cgl9KTsKCn0pKCk7CgpCcm93c2VyLkZlYXR1cmVzLnhociA9ICEhKEJyb3dzZXIuUmVxdWVzdCk7CgovLyBGbGFzaCBkZXRlY3Rpb24KCnZhciB2ZXJzaW9uID0gKEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCXJldHVybiBuYXZpZ2F0b3IucGx1Z2luc1snU2hvY2t3YXZlIEZsYXNoJ10uZGVzY3JpcHRpb247Cn0sIGZ1bmN0aW9uKCl7CglyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ1Nob2Nrd2F2ZUZsYXNoLlNob2Nrd2F2ZUZsYXNoJykuR2V0VmFyaWFibGUoJyR2ZXJzaW9uJyk7Cn0pIHx8ICcwIHIwJykubWF0Y2goL1xkKy9nKTsKCkJyb3dzZXIuUGx1Z2lucy5GbGFzaCA9IHsKCXZlcnNpb246IE51bWJlcih2ZXJzaW9uWzBdIHx8ICcwLicgKyB2ZXJzaW9uWzFdKSB8fCAwLAoJYnVpbGQ6IE51bWJlcih2ZXJzaW9uWzJdKSB8fCAwCn07CgovLyBTdHJpbmcgc2NyaXB0cwoKQnJvd3Nlci5leGVjID0gZnVuY3Rpb24odGV4dCl7CglpZiAoIXRleHQpIHJldHVybiB0ZXh0OwoJaWYgKHdpbmRvdy5leGVjU2NyaXB0KXsKCQl3aW5kb3cuZXhlY1NjcmlwdCh0ZXh0KTsKCX0gZWxzZSB7CgkJdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCXNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7CgkJc2NyaXB0LnRleHQgPSB0ZXh0OwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQlkb2N1bWVudC5oZWFkLnJlbW92ZUNoaWxkKHNjcmlwdCk7Cgl9CglyZXR1cm4gdGV4dDsKfTsKClN0cmluZy5pbXBsZW1lbnQoJ3N0cmlwU2NyaXB0cycsIGZ1bmN0aW9uKGV4ZWMpewoJdmFyIHNjcmlwdHMgPSAnJzsKCXZhciB0ZXh0ID0gdGhpcy5yZXBsYWNlKC88c2NyaXB0W14+XSo+KFtcc1xTXSo/KTxcL3NjcmlwdD4vZ2ksIGZ1bmN0aW9uKGFsbCwgY29kZSl7CgkJc2NyaXB0cyArPSBjb2RlICsgJ1xuJzsKCQlyZXR1cm4gJyc7Cgl9KTsKCWlmIChleGVjID09PSB0cnVlKSBCcm93c2VyLmV4ZWMoc2NyaXB0cyk7CgllbHNlIGlmICh0eXBlT2YoZXhlYykgPT0gJ2Z1bmN0aW9uJykgZXhlYyhzY3JpcHRzLCB0ZXh0KTsKCXJldHVybiB0ZXh0Owp9KTsKCi8vIFdpbmRvdywgRG9jdW1lbnQKCkJyb3dzZXIuZXh0ZW5kKHsKCURvY3VtZW50OiB0aGlzLkRvY3VtZW50LAoJV2luZG93OiB0aGlzLldpbmRvdywKCUVsZW1lbnQ6IHRoaXMuRWxlbWVudCwKCUV2ZW50OiB0aGlzLkV2ZW50Cn0pOwoKdGhpcy5XaW5kb3cgPSB0aGlzLiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdXaW5kb3cnLCBmdW5jdGlvbigpe30pOwoKdGhpcy4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnd2luZG93JykuaGlkZSgpOwoKV2luZG93Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJd2luZG93W25hbWVdID0gbWV0aG9kOwp9KTsKCnRoaXMuRG9jdW1lbnQgPSBkb2N1bWVudC4kY29uc3RydWN0b3IgPSBuZXcgVHlwZSgnRG9jdW1lbnQnLCBmdW5jdGlvbigpe30pOwoKZG9jdW1lbnQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2RvY3VtZW50JykuaGlkZSgpOwoKRG9jdW1lbnQubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cglkb2N1bWVudFtuYW1lXSA9IG1ldGhvZDsKfSk7Cgpkb2N1bWVudC5odG1sID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwppZiAoIWRvY3VtZW50LmhlYWQpIGRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgovKjxsdElFOT4qLwppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KLyo8L2x0SUU5PiovCgoKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFdmVudAoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBFdmVudCBUeXBlLCB0byBtYWtlIHRoZSBldmVudCBvYmplY3QgY3Jvc3MtYnJvd3Nlci4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtXaW5kb3csIERvY3VtZW50LCBBcnJheSwgRnVuY3Rpb24sIFN0cmluZywgT2JqZWN0XQoKcHJvdmlkZXM6IEV2ZW50CgouLi4KKi8KCihmdW5jdGlvbigpIHsKCnZhciBfa2V5cyA9IHt9OwoKdmFyIERPTUV2ZW50ID0gdGhpcy5ET01FdmVudCA9IG5ldyBUeXBlKCdET01FdmVudCcsIGZ1bmN0aW9uKGV2ZW50LCB3aW4pewoJaWYgKCF3aW4pIHdpbiA9IHdpbmRvdzsKCWV2ZW50ID0gZXZlbnQgfHwgd2luLmV2ZW50OwoJaWYgKGV2ZW50LiRleHRlbmRlZCkgcmV0dXJuIGV2ZW50OwoJdGhpcy5ldmVudCA9IGV2ZW50OwoJdGhpcy4kZXh0ZW5kZWQgPSB0cnVlOwoJdGhpcy5zaGlmdCA9IGV2ZW50LnNoaWZ0S2V5OwoJdGhpcy5jb250cm9sID0gZXZlbnQuY3RybEtleTsKCXRoaXMuYWx0ID0gZXZlbnQuYWx0S2V5OwoJdGhpcy5tZXRhID0gZXZlbnQubWV0YUtleTsKCXZhciB0eXBlID0gdGhpcy50eXBlID0gZXZlbnQudHlwZTsKCXZhciB0YXJnZXQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudDsKCXdoaWxlICh0YXJnZXQgJiYgdGFyZ2V0Lm5vZGVUeXBlID09IDMpIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJdGhpcy50YXJnZXQgPSBkb2N1bWVudC5pZCh0YXJnZXQpOwoKCWlmICh0eXBlLmluZGV4T2YoJ2tleScpID09IDApewoJCXZhciBjb2RlID0gdGhpcy5jb2RlID0gKGV2ZW50LndoaWNoIHx8IGV2ZW50LmtleUNvZGUpOwoJCXRoaXMua2V5ID0gX2tleXNbY29kZV07CgkJaWYgKHR5cGUgPT0gJ2tleWRvd24nKXsKCQkJaWYgKGNvZGUgPiAxMTEgJiYgY29kZSA8IDEyNCkgdGhpcy5rZXkgPSAnZicgKyAoY29kZSAtIDExMSk7CgkJCWVsc2UgaWYgKGNvZGUgPiA5NSAmJiBjb2RlIDwgMTA2KSB0aGlzLmtleSA9IGNvZGUgLSA5NjsKCQl9CgkJaWYgKHRoaXMua2V5ID09IG51bGwpIHRoaXMua2V5ID0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlKS50b0xvd2VyQ2FzZSgpOwoJfSBlbHNlIGlmICh0eXBlID09ICdjbGljaycgfHwgdHlwZSA9PSAnZGJsY2xpY2snIHx8IHR5cGUgPT0gJ2NvbnRleHRtZW51JyB8fCB0eXBlID09ICdET01Nb3VzZVNjcm9sbCcgfHwgdHlwZS5pbmRleE9mKCdtb3VzZScpID09IDApewoJCXZhciBkb2MgPSB3aW4uZG9jdW1lbnQ7CgkJZG9jID0gKCFkb2MuY29tcGF0TW9kZSB8fCBkb2MuY29tcGF0TW9kZSA9PSAnQ1NTMUNvbXBhdCcpID8gZG9jLmh0bWwgOiBkb2MuYm9keTsKCQl0aGlzLnBhZ2UgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIDogZXZlbnQuY2xpZW50WCArIGRvYy5zY3JvbGxMZWZ0LAoJCQl5OiAoZXZlbnQucGFnZVkgIT0gbnVsbCkgPyBldmVudC5wYWdlWSA6IGV2ZW50LmNsaWVudFkgKyBkb2Muc2Nyb2xsVG9wCgkJfTsKCQl0aGlzLmNsaWVudCA9IHsKCQkJeDogKGV2ZW50LnBhZ2VYICE9IG51bGwpID8gZXZlbnQucGFnZVggLSB3aW4ucGFnZVhPZmZzZXQgOiBldmVudC5jbGllbnRYLAoJCQl5OiAoZXZlbnQucGFnZVkgIT0gbnVsbCkgPyBldmVudC5wYWdlWSAtIHdpbi5wYWdlWU9mZnNldCA6IGV2ZW50LmNsaWVudFkKCQl9OwoJCWlmICh0eXBlID09ICdET01Nb3VzZVNjcm9sbCcgfHwgdHlwZSA9PSAnbW91c2V3aGVlbCcpCgkJCXRoaXMud2hlZWwgPSAoZXZlbnQud2hlZWxEZWx0YSkgPyBldmVudC53aGVlbERlbHRhIC8gMTIwIDogLShldmVudC5kZXRhaWwgfHwgMCkgLyAzOwoKCQl0aGlzLnJpZ2h0Q2xpY2sgPSAoZXZlbnQud2hpY2ggPT0gMyB8fCBldmVudC5idXR0b24gPT0gMik7CgkJaWYgKHR5cGUgPT0gJ21vdXNlb3ZlcicgfHwgdHlwZSA9PSAnbW91c2VvdXQnKXsKCQkJdmFyIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0IHx8IGV2ZW50Wyh0eXBlID09ICdtb3VzZW92ZXInID8gJ2Zyb20nIDogJ3RvJykgKyAnRWxlbWVudCddOwoJCQl3aGlsZSAocmVsYXRlZCAmJiByZWxhdGVkLm5vZGVUeXBlID09IDMpIHJlbGF0ZWQgPSByZWxhdGVkLnBhcmVudE5vZGU7CgkJCXRoaXMucmVsYXRlZFRhcmdldCA9IGRvY3VtZW50LmlkKHJlbGF0ZWQpOwoJCX0KCX0gZWxzZSBpZiAodHlwZS5pbmRleE9mKCd0b3VjaCcpID09IDAgfHwgdHlwZS5pbmRleE9mKCdnZXN0dXJlJykgPT0gMCl7CgkJdGhpcy5yb3RhdGlvbiA9IGV2ZW50LnJvdGF0aW9uOwoJCXRoaXMuc2NhbGUgPSBldmVudC5zY2FsZTsKCQl0aGlzLnRhcmdldFRvdWNoZXMgPSBldmVudC50YXJnZXRUb3VjaGVzOwoJCXRoaXMuY2hhbmdlZFRvdWNoZXMgPSBldmVudC5jaGFuZ2VkVG91Y2hlczsKCQl2YXIgdG91Y2hlcyA9IHRoaXMudG91Y2hlcyA9IGV2ZW50LnRvdWNoZXM7CgkJaWYgKHRvdWNoZXMgJiYgdG91Y2hlc1swXSl7CgkJCXZhciB0b3VjaCA9IHRvdWNoZXNbMF07CgkJCXRoaXMucGFnZSA9IHt4OiB0b3VjaC5wYWdlWCwgeTogdG91Y2gucGFnZVl9OwoJCQl0aGlzLmNsaWVudCA9IHt4OiB0b3VjaC5jbGllbnRYLCB5OiB0b3VjaC5jbGllbnRZfTsKCQl9Cgl9CgoJaWYgKCF0aGlzLmNsaWVudCkgdGhpcy5jbGllbnQgPSB7fTsKCWlmICghdGhpcy5wYWdlKSB0aGlzLnBhZ2UgPSB7fTsKfSk7CgpET01FdmVudC5pbXBsZW1lbnQoewoKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucHJldmVudERlZmF1bHQoKS5zdG9wUHJvcGFnYXRpb24oKTsKCX0sCgoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnN0b3BQcm9wYWdhdGlvbikgdGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQllbHNlIHRoaXMuZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQpIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQllbHNlIHRoaXMuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKRE9NRXZlbnQuZGVmaW5lS2V5ID0gZnVuY3Rpb24oY29kZSwga2V5KXsKCV9rZXlzW2NvZGVdID0ga2V5OwoJcmV0dXJuIHRoaXM7Cn07CgpET01FdmVudC5kZWZpbmVLZXlzID0gRE9NRXZlbnQuZGVmaW5lS2V5Lm92ZXJsb2FkU2V0dGVyKHRydWUpOwoKRE9NRXZlbnQuZGVmaW5lS2V5cyh7CgknMzgnOiAndXAnLCAnNDAnOiAnZG93bicsICczNyc6ICdsZWZ0JywgJzM5JzogJ3JpZ2h0JywKCScyNyc6ICdlc2MnLCAnMzInOiAnc3BhY2UnLCAnOCc6ICdiYWNrc3BhY2UnLCAnOSc6ICd0YWInLAoJJzQ2JzogJ2RlbGV0ZScsICcxMyc6ICdlbnRlcicKfSk7Cgp9KSgpOwoKCgoKCgovKgotLS0KCm5hbWU6IENsYXNzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENsYXNzIEZ1bmN0aW9uIGZvciBlYXNpbHkgY3JlYXRpbmcsIGV4dGVuZGluZywgYW5kIGltcGxlbWVudGluZyByZXVzYWJsZSBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIEZ1bmN0aW9uLCBOdW1iZXJdCgpwcm92aWRlczogQ2xhc3MKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgQ2xhc3MgPSB0aGlzLkNsYXNzID0gbmV3IFR5cGUoJ0NsYXNzJywgZnVuY3Rpb24ocGFyYW1zKXsKCWlmIChpbnN0YW5jZU9mKHBhcmFtcywgRnVuY3Rpb24pKSBwYXJhbXMgPSB7aW5pdGlhbGl6ZTogcGFyYW1zfTsKCgl2YXIgbmV3Q2xhc3MgPSBmdW5jdGlvbigpewoJCXJlc2V0KHRoaXMpOwoJCWlmIChuZXdDbGFzcy4kcHJvdG90eXBpbmcpIHJldHVybiB0aGlzOwoJCXRoaXMuJGNhbGxlciA9IG51bGw7CgkJdmFyIHZhbHVlID0gKHRoaXMuaW5pdGlhbGl6ZSkgPyB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXM7CgkJdGhpcy4kY2FsbGVyID0gdGhpcy5jYWxsZXIgPSBudWxsOwoJCXJldHVybiB2YWx1ZTsKCX0uZXh0ZW5kKHRoaXMpLmltcGxlbWVudChwYXJhbXMpOwoKCW5ld0NsYXNzLiRjb25zdHJ1Y3RvciA9IENsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG5ld0NsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLnBhcmVudCA9IHBhcmVudDsKCglyZXR1cm4gbmV3Q2xhc3M7Cn0pOwoKdmFyIHBhcmVudCA9IGZ1bmN0aW9uKCl7CglpZiAoIXRoaXMuJGNhbGxlcikgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICJwYXJlbnQiIGNhbm5vdCBiZSBjYWxsZWQuJyk7Cgl2YXIgbmFtZSA9IHRoaXMuJGNhbGxlci4kbmFtZSwKCQlwYXJlbnQgPSB0aGlzLiRjYWxsZXIuJG93bmVyLnBhcmVudCwKCQlwcmV2aW91cyA9IChwYXJlbnQpID8gcGFyZW50LnByb3RvdHlwZVtuYW1lXSA6IG51bGw7CglpZiAoIXByZXZpb3VzKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgIicgKyBuYW1lICsgJyIgaGFzIG5vIHBhcmVudC4nKTsKCXJldHVybiBwcmV2aW91cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKdmFyIHJlc2V0ID0gZnVuY3Rpb24ob2JqZWN0KXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCXZhciB2YWx1ZSA9IG9iamVjdFtrZXldOwoJCXN3aXRjaCAodHlwZU9mKHZhbHVlKSl7CgkJCWNhc2UgJ29iamVjdCc6CgkJCQl2YXIgRiA9IGZ1bmN0aW9uKCl7fTsKCQkJCUYucHJvdG90eXBlID0gdmFsdWU7CgkJCQlvYmplY3Rba2V5XSA9IHJlc2V0KG5ldyBGKTsKCQkJYnJlYWs7CgkJCWNhc2UgJ2FycmF5Jzogb2JqZWN0W2tleV0gPSB2YWx1ZS5jbG9uZSgpOyBicmVhazsKCQl9Cgl9CglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHdyYXAgPSBmdW5jdGlvbihzZWxmLCBrZXksIG1ldGhvZCl7CglpZiAobWV0aG9kLiRvcmlnaW4pIG1ldGhvZCA9IG1ldGhvZC4kb3JpZ2luOwoJdmFyIHdyYXBwZXIgPSBmdW5jdGlvbigpewoJCWlmIChtZXRob2QuJHByb3RlY3RlZCAmJiB0aGlzLiRjYWxsZXIgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICInICsga2V5ICsgJyIgY2Fubm90IGJlIGNhbGxlZC4nKTsKCQl2YXIgY2FsbGVyID0gdGhpcy5jYWxsZXIsIGN1cnJlbnQgPSB0aGlzLiRjYWxsZXI7CgkJdGhpcy5jYWxsZXIgPSBjdXJyZW50OyB0aGlzLiRjYWxsZXIgPSB3cmFwcGVyOwoJCXZhciByZXN1bHQgPSBtZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl0aGlzLiRjYWxsZXIgPSBjdXJyZW50OyB0aGlzLmNhbGxlciA9IGNhbGxlcjsKCQlyZXR1cm4gcmVzdWx0OwoJfS5leHRlbmQoeyRvd25lcjogc2VsZiwgJG9yaWdpbjogbWV0aG9kLCAkbmFtZToga2V5fSk7CglyZXR1cm4gd3JhcHBlcjsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlLCByZXRhaW4pewoJaWYgKENsYXNzLk11dGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpewoJCXZhbHVlID0gQ2xhc3MuTXV0YXRvcnNba2V5XS5jYWxsKHRoaXMsIHZhbHVlKTsKCQlpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuIHRoaXM7Cgl9CgoJaWYgKHR5cGVPZih2YWx1ZSkgPT0gJ2Z1bmN0aW9uJyl7CgkJaWYgKHZhbHVlLiRoaWRkZW4pIHJldHVybiB0aGlzOwoJCXRoaXMucHJvdG90eXBlW2tleV0gPSAocmV0YWluKSA/IHZhbHVlIDogd3JhcCh0aGlzLCBrZXksIHZhbHVlKTsKCX0gZWxzZSB7CgkJT2JqZWN0Lm1lcmdlKHRoaXMucHJvdG90eXBlLCBrZXksIHZhbHVlKTsKCX0KCglyZXR1cm4gdGhpczsKfTsKCnZhciBnZXRJbnN0YW5jZSA9IGZ1bmN0aW9uKGtsYXNzKXsKCWtsYXNzLiRwcm90b3R5cGluZyA9IHRydWU7Cgl2YXIgcHJvdG8gPSBuZXcga2xhc3M7CglkZWxldGUga2xhc3MuJHByb3RvdHlwaW5nOwoJcmV0dXJuIHByb3RvOwp9OwoKQ2xhc3MuaW1wbGVtZW50KCdpbXBsZW1lbnQnLCBpbXBsZW1lbnQub3ZlcmxvYWRTZXR0ZXIoKSk7CgpDbGFzcy5NdXRhdG9ycyA9IHsKCglFeHRlbmRzOiBmdW5jdGlvbihwYXJlbnQpewoJCXRoaXMucGFyZW50ID0gcGFyZW50OwoJCXRoaXMucHJvdG90eXBlID0gZ2V0SW5zdGFuY2UocGFyZW50KTsKCX0sCgoJSW1wbGVtZW50czogZnVuY3Rpb24oaXRlbXMpewoJCUFycmF5LmZyb20oaXRlbXMpLmVhY2goZnVuY3Rpb24oaXRlbSl7CgkJCXZhciBpbnN0YW5jZSA9IG5ldyBpdGVtOwoJCQlmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2UpIGltcGxlbWVudC5jYWxsKHRoaXMsIGtleSwgaW5zdGFuY2Vba2V5XSwgdHJ1ZSk7CgkJfSwgdGhpcyk7Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQ2xhc3MuRXh0cmFzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgVXRpbGl0eSBDbGFzc2VzIHRoYXQgY2FuIGJlIGltcGxlbWVudGVkIGludG8geW91ciBvd24gQ2xhc3NlcyB0byBlYXNlIHRoZSBleGVjdXRpb24gb2YgbWFueSBjb21tb24gdGFza3MuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBDbGFzcwoKcHJvdmlkZXM6IFtDbGFzcy5FeHRyYXMsIENoYWluLCBFdmVudHMsIE9wdGlvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5DaGFpbiA9IG5ldyBDbGFzcyh7CgoJJGNoYWluOiBbXSwKCgljaGFpbjogZnVuY3Rpb24oKXsKCQl0aGlzLiRjaGFpbi5hcHBlbmQoQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FsbENoYWluOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy4kY2hhaW4ubGVuZ3RoKSA/IHRoaXMuJGNoYWluLnNoaWZ0KCkuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGZhbHNlOwoJfSwKCgljbGVhckNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmVtcHR5KCk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciByZW1vdmVPbiA9IGZ1bmN0aW9uKHN0cmluZyl7CglyZXR1cm4gc3RyaW5nLnJlcGxhY2UoL15vbihbQS1aXSkvLCBmdW5jdGlvbihmdWxsLCBmaXJzdCl7CgkJcmV0dXJuIGZpcnN0LnRvTG93ZXJDYXNlKCk7Cgl9KTsKfTsKCnRoaXMuRXZlbnRzID0gbmV3IENsYXNzKHsKCgkkZXZlbnRzOiB7fSwKCglhZGRFdmVudDogZnVuY3Rpb24odHlwZSwgZm4sIGludGVybmFsKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgoJCQoKCQl0aGlzLiRldmVudHNbdHlwZV0gPSAodGhpcy4kZXZlbnRzW3R5cGVdIHx8IFtdKS5pbmNsdWRlKGZuKTsKCQlpZiAoaW50ZXJuYWwpIGZuLmludGVybmFsID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJYWRkRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCWZvciAodmFyIHR5cGUgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KHR5cGUsIGV2ZW50c1t0eXBlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCQl2YXIgZXZlbnRzID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlldmVudHMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCQl2YXIgZXZlbnRzID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCWlmIChldmVudHMgJiYgIWZuLmludGVybmFsKXsKCQkJdmFyIGluZGV4ID0gIGV2ZW50cy5pbmRleE9mKGZuKTsKCQkJaWYgKGluZGV4ICE9IC0xKSBkZWxldGUgZXZlbnRzW2luZGV4XTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKXsKCQl2YXIgdHlwZTsKCQlpZiAodHlwZU9mKGV2ZW50cykgPT0gJ29iamVjdCcpewoJCQlmb3IgKHR5cGUgaW4gZXZlbnRzKSB0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGV2ZW50c1t0eXBlXSk7CgkJCXJldHVybiB0aGlzOwoJCX0KCQlpZiAoZXZlbnRzKSBldmVudHMgPSByZW1vdmVPbihldmVudHMpOwoJCWZvciAodHlwZSBpbiB0aGlzLiRldmVudHMpewoJCQlpZiAoZXZlbnRzICYmIGV2ZW50cyAhPSB0eXBlKSBjb250aW51ZTsKCQkJdmFyIGZucyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQkJZm9yICh2YXIgaSA9IGZucy5sZW5ndGg7IGktLTspIGlmIChpIGluIGZucyl7CgkJCQl0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGZuc1tpXSk7CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnRoaXMuT3B0aW9ucyA9IG5ldyBDbGFzcyh7CgoJc2V0T3B0aW9uczogZnVuY3Rpb24oKXsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyA9IE9iamVjdC5tZXJnZS5hcHBseShudWxsLCBbe30sIHRoaXMub3B0aW9uc10uYXBwZW5kKGFyZ3VtZW50cykpOwoJCWlmICh0aGlzLmFkZEV2ZW50KSBmb3IgKHZhciBvcHRpb24gaW4gb3B0aW9ucyl7CgkJCWlmICh0eXBlT2Yob3B0aW9uc1tvcHRpb25dKSAhPSAnZnVuY3Rpb24nIHx8ICEoL15vbltBLVpdLykudGVzdChvcHRpb24pKSBjb250aW51ZTsKCQkJdGhpcy5hZGRFdmVudChvcHRpb24sIG9wdGlvbnNbb3B0aW9uXSk7CgkJCWRlbGV0ZSBvcHRpb25zW29wdGlvbl07CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp9KSgpOwoKCi8qCi0tLQpuYW1lOiBTbGljay5QYXJzZXIKZGVzY3JpcHRpb246IFN0YW5kYWxvbmUgQ1NTMyBTZWxlY3RvciBwYXJzZXIKcHJvdmlkZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCjsoZnVuY3Rpb24oKXsKCnZhciBwYXJzZWQsCglzZXBhcmF0b3JJbmRleCwKCWNvbWJpbmF0b3JJbmRleCwKCXJldmVyc2VkLAoJY2FjaGUgPSB7fSwKCXJldmVyc2VDYWNoZSA9IHt9LAoJcmVVbmVzY2FwZSA9IC9cXC9nOwoKdmFyIHBhcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgaXNSZXZlcnNlZCl7CglpZiAoZXhwcmVzc2lvbiA9PSBudWxsKSByZXR1cm4gbnVsbDsKCWlmIChleHByZXNzaW9uLlNsaWNrID09PSB0cnVlKSByZXR1cm4gZXhwcmVzc2lvbjsKCWV4cHJlc3Npb24gPSAoJycgKyBleHByZXNzaW9uKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwoJcmV2ZXJzZWQgPSAhIWlzUmV2ZXJzZWQ7Cgl2YXIgY3VycmVudENhY2hlID0gKHJldmVyc2VkKSA/IHJldmVyc2VDYWNoZSA6IGNhY2hlOwoJaWYgKGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXSkgcmV0dXJuIGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXTsKCXBhcnNlZCA9IHsKCQlTbGljazogdHJ1ZSwKCQlleHByZXNzaW9uczogW10sCgkJcmF3OiBleHByZXNzaW9uLAoJCXJldmVyc2U6IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBwYXJzZSh0aGlzLnJhdywgdHJ1ZSk7CgkJfQoJfTsKCXNlcGFyYXRvckluZGV4ID0gLTE7Cgl3aGlsZSAoZXhwcmVzc2lvbiAhPSAoZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShyZWdleHAsIHBhcnNlcikpKTsKCXBhcnNlZC5sZW5ndGggPSBwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoOwoJcmV0dXJuIGN1cnJlbnRDYWNoZVtwYXJzZWQucmF3XSA9IChyZXZlcnNlZCkgPyByZXZlcnNlKHBhcnNlZCkgOiBwYXJzZWQ7Cn07Cgp2YXIgcmV2ZXJzZUNvbWJpbmF0b3IgPSBmdW5jdGlvbihjb21iaW5hdG9yKXsKCWlmIChjb21iaW5hdG9yID09PSAnIScpIHJldHVybiAnICc7CgllbHNlIGlmIChjb21iaW5hdG9yID09PSAnICcpIHJldHVybiAnISc7CgllbHNlIGlmICgoL14hLykudGVzdChjb21iaW5hdG9yKSkgcmV0dXJuIGNvbWJpbmF0b3IucmVwbGFjZSgvXiEvLCAnJyk7CgllbHNlIHJldHVybiAnIScgKyBjb21iaW5hdG9yOwp9OwoKdmFyIHJldmVyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uKXsKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gMDsgaSA8IGV4cHJlc3Npb25zLmxlbmd0aDsgaSsrKXsKCQl2YXIgZXhwID0gZXhwcmVzc2lvbnNbaV07CgkJdmFyIGxhc3QgPSB7cGFydHM6IFtdLCB0YWc6ICcqJywgY29tYmluYXRvcjogcmV2ZXJzZUNvbWJpbmF0b3IoZXhwWzBdLmNvbWJpbmF0b3IpfTsKCgkJZm9yICh2YXIgaiA9IDA7IGogPCBleHAubGVuZ3RoOyBqKyspewoJCQl2YXIgY2V4cCA9IGV4cFtqXTsKCQkJaWYgKCFjZXhwLnJldmVyc2VDb21iaW5hdG9yKSBjZXhwLnJldmVyc2VDb21iaW5hdG9yID0gJyAnOwoJCQljZXhwLmNvbWJpbmF0b3IgPSBjZXhwLnJldmVyc2VDb21iaW5hdG9yOwoJCQlkZWxldGUgY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQl9CgoJCWV4cC5yZXZlcnNlKCkucHVzaChsYXN0KTsKCX0KCXJldHVybiBleHByZXNzaW9uOwp9OwoKdmFyIGVzY2FwZVJlZ0V4cCA9IGZ1bmN0aW9uKHN0cmluZyl7Ly8gQ3JlZGl0OiBYUmVnRXhwIDAuNi4xIChjKSAyMDA3LTIwMDggU3RldmVuIExldml0aGFuIDxodHRwOi8vc3RldmVubGV2aXRoYW4uY29tL3JlZ2V4L3hyZWdleHAvPiBNSVQgTGljZW5zZQoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVtcXXt9KCkqKz8uXFxeJHwsI1xzXS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJcmV0dXJuICdcXCcgKyBtYXRjaDsKCX0pOwp9OwoKdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAoCi8qCiMhL3Vzci9iaW4vZW52IHJ1YnkKcHV0cyAiXHRcdCIgKyBEQVRBLnJlYWQuZ3N1YigvXChcP3hcKXxccysjLiokfFxzK3xcXCR8XFxuLywnJykKX19FTkRfXwoJIig/eCleKD86XAoJICBcXHMqICggLCApIFxccyogICAgICAgICAgICAgICAjIFNlcGFyYXRvciAgICAgICAgICBcblwKCXwgXFxzKiAoIDxjb21iaW5hdG9yPisgKSBcXHMqICAgIyBDb21iaW5hdG9yICAgICAgICAgXG5cCgl8ICAgICAgKCBcXHMrICkgICAgICAgICAgICAgICAgICMgQ29tYmluYXRvckNoaWxkcmVuIFxuXAoJfCAgICAgICggPHVuaWNvZGU+KyB8IFxcKiApICAgICAjIFRhZyAgICAgICAgICAgICAgICBcblwKCXwgXFwjICAoIDx1bmljb2RlPisgICAgICAgKSAgICAgIyBJRCAgICAgICAgICAgICAgICAgXG5cCgl8IFxcLiAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgQ2xhc3NOYW1lICAgICAgICAgIFxuXAoJfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEF0dHJpYnV0ZSAgICAgICAgICBcblwKCVxcWyAgXAoJCVxccyogKDx1bmljb2RlMT4rKSAgKD86ICBcCgkJCVxccyogKFsqXiQhfnxdPz0pICAoPzogIFwKCQkJCVxccyogKD86XAoJCQkJCShbXCInXT8pKC4qPylcXDkgXAoJCQkJKVwKCQkJKSAgXAoJCSk/ICBcXHMqICBcCglcXF0oPyFcXF0pIFxuXAoJfCAgIDorICggPHVuaWNvZGU+KyApKD86XAoJXFwoICg/OlwKCQkoPzooW1wiJ10pKFteXFwxMl0qKVxcMTIpfCgoPzpcXChbXildK1xcKXxbXigpXSopKylcCgkpIFxcKVwKCSk/XAoJKSIKKi8KCSJeKD86XFxzKigsKVxccyp8XFxzKig8Y29tYmluYXRvcj4rKVxccyp8KFxccyspfCg8dW5pY29kZT4rfFxcKil8XFwjKDx1bmljb2RlPispfFxcLig8dW5pY29kZT4rKXxcXFtcXHMqKDx1bmljb2RlMT4rKSg/OlxccyooWypeJCF+fF0/PSkoPzpcXHMqKD86KFtcIiddPykoLio/KVxcOSkpKT9cXHMqXFxdKD8hXFxdKXwoOispKDx1bmljb2RlPispKD86XFwoKD86KD86KFtcIiddKShbXlxcMTNdKilcXDEzKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspKVxcKSk/KSIKCS5yZXBsYWNlKC88Y29tYmluYXRvcj4vLCAnWycgKyBlc2NhcGVSZWdFeHAoIj4rfmAhQCQlXiY9e31cXDs8LyIpICsgJ10nKQoJLnJlcGxhY2UoLzx1bmljb2RlPi9nLCAnKD86W1xcd1xcdTAwYTEtXFx1RkZGRi1dfFxcXFxbXlxcczAtOWEtZl0pJykKCS5yZXBsYWNlKC88dW5pY29kZTE+L2csICcoPzpbOlxcd1xcdTAwYTEtXFx1RkZGRi1dfFxcXFxbXlxcczAtOWEtZl0pJykKKTsKCmZ1bmN0aW9uIHBhcnNlcigKCXJhd01hdGNoLAoKCXNlcGFyYXRvciwKCWNvbWJpbmF0b3IsCgljb21iaW5hdG9yQ2hpbGRyZW4sCgoJdGFnTmFtZSwKCWlkLAoJY2xhc3NOYW1lLAoKCWF0dHJpYnV0ZUtleSwKCWF0dHJpYnV0ZU9wZXJhdG9yLAoJYXR0cmlidXRlUXVvdGUsCglhdHRyaWJ1dGVWYWx1ZSwKCglwc2V1ZG9NYXJrZXIsCglwc2V1ZG9DbGFzcywKCXBzZXVkb1F1b3RlLAoJcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZSwKCXBzZXVkb0NsYXNzVmFsdWUKKXsKCWlmIChzZXBhcmF0b3IgfHwgc2VwYXJhdG9ySW5kZXggPT09IC0xKXsKCQlwYXJzZWQuZXhwcmVzc2lvbnNbKytzZXBhcmF0b3JJbmRleF0gPSBbXTsKCQljb21iaW5hdG9ySW5kZXggPSAtMTsKCQlpZiAoc2VwYXJhdG9yKSByZXR1cm4gJyc7Cgl9CgoJaWYgKGNvbWJpbmF0b3IgfHwgY29tYmluYXRvckNoaWxkcmVuIHx8IGNvbWJpbmF0b3JJbmRleCA9PT0gLTEpewoJCWNvbWJpbmF0b3IgPSBjb21iaW5hdG9yIHx8ICcgJzsKCQl2YXIgY3VycmVudFNlcGFyYXRvciA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF07CgkJaWYgKHJldmVyc2VkICYmIGN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XSkKCQkJY3VycmVudFNlcGFyYXRvcltjb21iaW5hdG9ySW5kZXhdLnJldmVyc2VDb21iaW5hdG9yID0gcmV2ZXJzZUNvbWJpbmF0b3IoY29tYmluYXRvcik7CgkJY3VycmVudFNlcGFyYXRvclsrK2NvbWJpbmF0b3JJbmRleF0gPSB7Y29tYmluYXRvcjogY29tYmluYXRvciwgdGFnOiAnKid9OwoJfQoKCXZhciBjdXJyZW50UGFyc2VkID0gcGFyc2VkLmV4cHJlc3Npb25zW3NlcGFyYXRvckluZGV4XVtjb21iaW5hdG9ySW5kZXhdOwoKCWlmICh0YWdOYW1lKXsKCQljdXJyZW50UGFyc2VkLnRhZyA9IHRhZ05hbWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJfSBlbHNlIGlmIChpZCl7CgkJY3VycmVudFBhcnNlZC5pZCA9IGlkLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoY2xhc3NOYW1lKXsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc0xpc3QpIGN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0ID0gW107CgkJaWYgKCFjdXJyZW50UGFyc2VkLmNsYXNzZXMpIGN1cnJlbnRQYXJzZWQuY2xhc3NlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0LnB1c2goY2xhc3NOYW1lKTsKCQljdXJyZW50UGFyc2VkLmNsYXNzZXMucHVzaCh7CgkJCXZhbHVlOiBjbGFzc05hbWUsCgkJCXJlZ2V4cDogbmV3IFJlZ0V4cCgnKF58XFxzKScgKyBlc2NhcGVSZWdFeHAoY2xhc3NOYW1lKSArICcoXFxzfCQpJykKCQl9KTsKCgl9IGVsc2UgaWYgKHBzZXVkb0NsYXNzKXsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSB8fCBwc2V1ZG9DbGFzc1F1b3RlZFZhbHVlOwoJCXBzZXVkb0NsYXNzVmFsdWUgPSBwc2V1ZG9DbGFzc1ZhbHVlID8gcHNldWRvQ2xhc3NWYWx1ZS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKSA6IG51bGw7CgoJCWlmICghY3VycmVudFBhcnNlZC5wc2V1ZG9zKSBjdXJyZW50UGFyc2VkLnBzZXVkb3MgPSBbXTsKCQljdXJyZW50UGFyc2VkLnBzZXVkb3MucHVzaCh7CgkJCWtleTogcHNldWRvQ2xhc3MucmVwbGFjZShyZVVuZXNjYXBlLCAnJyksCgkJCXZhbHVlOiBwc2V1ZG9DbGFzc1ZhbHVlLAoJCQl0eXBlOiBwc2V1ZG9NYXJrZXIubGVuZ3RoID09IDEgPyAnY2xhc3MnIDogJ2VsZW1lbnQnCgkJfSk7CgoJfSBlbHNlIGlmIChhdHRyaWJ1dGVLZXkpewoJCWF0dHJpYnV0ZUtleSA9IGF0dHJpYnV0ZUtleS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCQlhdHRyaWJ1dGVWYWx1ZSA9IChhdHRyaWJ1dGVWYWx1ZSB8fCAnJykucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJCXZhciB0ZXN0LCByZWdleHA7CgoJCXN3aXRjaCAoYXR0cmlidXRlT3BlcmF0b3IpewoJCQljYXNlICdePScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAnXicrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgICAgICAgICAgICApOyBicmVhazsKCQkJY2FzZSAnJD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgICAgICBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnJCcgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJ349JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICcoXnxcXHMpJysgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyhcXHN8JCknICk7IGJyZWFrOwoJCQljYXNlICd8PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAnXicrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoLXwkKScgICApOyBicmVhazsKCQkJY2FzZSAgJz0nIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiBhdHRyaWJ1dGVWYWx1ZSA9PSB2YWx1ZTsKCQkJfTsgYnJlYWs7CgkJCWNhc2UgJyo9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gdmFsdWUgJiYgdmFsdWUuaW5kZXhPZihhdHRyaWJ1dGVWYWx1ZSkgPiAtMTsKCQkJfTsgYnJlYWs7CgkJCWNhc2UgJyE9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgIT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQlkZWZhdWx0ICAgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuICEhdmFsdWU7CgkJCX07CgkJfQoKCQlpZiAoYXR0cmlidXRlVmFsdWUgPT0gJycgJiYgKC9eWyokXl09JC8pLnRlc3QoYXR0cmlidXRlT3BlcmF0b3IpKSB0ZXN0ID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJCWlmICghdGVzdCkgdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlICYmIHJlZ2V4cC50ZXN0KHZhbHVlKTsKCQl9OwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcykgY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzID0gW107CgkJY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzLnB1c2goewoJCQlrZXk6IGF0dHJpYnV0ZUtleSwKCQkJb3BlcmF0b3I6IGF0dHJpYnV0ZU9wZXJhdG9yLAoJCQl2YWx1ZTogYXR0cmlidXRlVmFsdWUsCgkJCXRlc3Q6IHRlc3QKCQl9KTsKCgl9CgoJcmV0dXJuICcnOwp9OwoKLy8gU2xpY2sgTlMKCnZhciBTbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnBhcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7CglyZXR1cm4gcGFyc2UoZXhwcmVzc2lvbik7Cn07CgpTbGljay5lc2NhcGVSZWdFeHAgPSBlc2NhcGVSZWdFeHA7CgppZiAoIXRoaXMuU2xpY2spIHRoaXMuU2xpY2sgPSBTbGljazsKCn0pLmFwcGx5KC8qPENvbW1vbkpTPiovKHR5cGVvZiBleHBvcnRzICE9ICd1bmRlZmluZWQnKSA/IGV4cG9ydHMgOiAvKjwvQ29tbW9uSlM+Ki90aGlzKTsKCgovKgotLS0KbmFtZTogU2xpY2suRmluZGVyCmRlc2NyaXB0aW9uOiBUaGUgbmV3LCBzdXBlcmZhc3QgY3NzIHNlbGVjdG9yIGVuZ2luZS4KcHJvdmlkZXM6IFNsaWNrLkZpbmRlcgpyZXF1aXJlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKOyhmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge30sCglmZWF0dXJlc0NhY2hlID0ge30sCgl0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8ICh0b1N0cmluZy5jYWxsKGRvY3VtZW50KSA9PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09IDkgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9ICdIVE1MJyk7Cn07Cgpsb2NhbC5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCgkvLyBjb252ZXJ0IGVsZW1lbnRzIC8gd2luZG93IGFyZ3VtZW50cyB0byBkb2N1bWVudC4gaWYgZG9jdW1lbnQgY2Fubm90IGJlIGV4dHJhcG9sYXRlZCwgdGhlIGZ1bmN0aW9uIHJldHVybnMuCgl2YXIgbm9kZVR5cGUgPSBkb2N1bWVudC5ub2RlVHlwZTsKCWlmIChub2RlVHlwZSA9PSA5KTsgLy8gZG9jdW1lbnQKCWVsc2UgaWYgKG5vZGVUeXBlKSBkb2N1bWVudCA9IGRvY3VtZW50Lm93bmVyRG9jdW1lbnQ7IC8vIG5vZGUKCWVsc2UgaWYgKGRvY3VtZW50Lm5hdmlnYXRvcikgZG9jdW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudDsgLy8gd2luZG93CgllbHNlIHJldHVybjsKCgkvLyBjaGVjayBpZiBpdCdzIHRoZSBvbGQgZG9jdW1lbnQKCglpZiAodGhpcy5kb2N1bWVudCA9PT0gZG9jdW1lbnQpIHJldHVybjsKCXRoaXMuZG9jdW1lbnQgPSBkb2N1bWVudDsKCgkvLyBjaGVjayBpZiB3ZSBoYXZlIGRvbmUgZmVhdHVyZSBkZXRlY3Rpb24gb24gdGhpcyBkb2N1bWVudCBiZWZvcmUKCgl2YXIgcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlyb290VWlkID0gdGhpcy5nZXRVSURYTUwocm9vdCksCgkJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdLAoJCWZlYXR1cmU7CgoJaWYgKGZlYXR1cmVzKXsKCQlmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCQl0aGlzW2ZlYXR1cmVdID0gZmVhdHVyZXNbZmVhdHVyZV07CgkJfQoJCXJldHVybjsKCX0KCglmZWF0dXJlcyA9IGZlYXR1cmVzQ2FjaGVbcm9vdFVpZF0gPSB7fTsKCglmZWF0dXJlcy5yb290ID0gcm9vdDsKCWZlYXR1cmVzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCglmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4KCT0gZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EKCT0gZmVhdHVyZXMuaWRHZXRzTmFtZQoJPSBmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EKCT0gZmVhdHVyZXMuYnJva2VuR0VCQ04KCT0gZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQQoJPSBmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQQoJPSBmZWF0dXJlcy5pc0hUTUxEb2N1bWVudAoJPSBmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lLAoJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXI7CgoJdmFyIHNlbGVjdGVkLCBpZCA9ICdzbGlja191bmlxdWVpZCc7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCgl2YXIgdGVzdFJvb3QgPSBkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF0gfHwgcm9vdDsKCXRlc3RSb290LmFwcGVuZENoaWxkKHRlc3ROb2RlKTsKCgkvLyBvbiBub24tSFRNTCBkb2N1bWVudHMgaW5uZXJIVE1MIGFuZCBnZXRFbGVtZW50c0J5SWQgZG9lc250IHdvcmsgcHJvcGVybHkKCXRyeSB7CgkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGlkPSInK2lkKyciPjwvYT4nOwoJCWZlYXR1cmVzLmlzSFRNTERvY3VtZW50ID0gISFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7Cgl9IGNhdGNoKGUpe307CgoJaWYgKGZlYXR1cmVzLmlzSFRNTERvY3VtZW50KXsKCgkJdGVzdE5vZGUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCgkJLy8gSUUgcmV0dXJucyBjb21tZW50IG5vZGVzIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRlc3ROb2RlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJycpKTsKCQlzdGFyU2VsZWN0c0NvbW1lbnRzID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoID4gMSk7CgoJCS8vIElFIHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJc3RhclNlbGVjdHNDbG9zZWQgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJfSBjYXRjaChlKXt9OwoKCQlmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4gPSBzdGFyU2VsZWN0c0NvbW1lbnRzIHx8IHN0YXJTZWxlY3RzQ2xvc2VkOwoKCQkvLyBJRSByZXR1cm5zIGVsZW1lbnRzIHdpdGggdGhlIG5hbWUgaW5zdGVhZCBvZiBqdXN0IGlkIGZvciBnZXRFbGVtZW50c0J5SWQgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIG5hbWU9IicrIGlkICsnIj48L2E+PGIgaWQ9IicrIGlkICsnIj48L2I+JzsKCQkJZmVhdHVyZXMuaWRHZXRzTmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSA9PT0gdGVzdE5vZGUuZmlyc3RDaGlsZDsKCQl9IGNhdGNoKGUpe307CgoJCWlmICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKXsKCgkJCS8vIFNhZmFyaSAzLjIgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYWNoZXMgcmVzdWx0cwoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJmIj48L2E+PGEgY2xhc3M9ImIiPjwvYT4nOwoJCQkJdGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYicpLmxlbmd0aDsKCQkJCXRlc3ROb2RlLmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gJ2InOwoJCQkJY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoICE9IDIpOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBPcGVyYSA5LjYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBkb2VzbnQgZGV0ZWN0cyB0aGUgY2xhc3MgaWYgaXRzIG5vdCB0aGUgZmlyc3Qgb25lCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9ImEiPjwvYT48YSBjbGFzcz0iZiBiIGEiPjwvYT4nOwoJCQkJYnJva2VuU2Vjb25kQ2xhc3NOYW1lR0VCQ04gPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYScpLmxlbmd0aCAhPSAyKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJZmVhdHVyZXMuYnJva2VuR0VCQ04gPSBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHx8IGJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOOwoJCX0KCgkJaWYgKHRlc3ROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwpewoJCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICdmb288L2Zvbz4nOwoJCQkJc2VsZWN0ZWQgPSB0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcqJyk7CgkJCQlmZWF0dXJlcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSA9IChzZWxlY3RlZCAmJiAhIXNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gU2FmYXJpIDMuMiBxdWVyeVNlbGVjdG9yQWxsIGRvZXNudCB3b3JrIHdpdGggbWl4ZWRjYXNlIG9uIHF1aXJrc21vZGUKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iTWlYIj48L2E+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYJykubGVuZ3RoOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBXZWJraXQgYW5kIE9wZXJhIGRvbnQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQkJZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCc6Y2hlY2tlZCcpLmxlbmd0aCA9PSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gSUUgcmV0dXJucyBpbmNvcnJlY3QgcmVzdWx0cyBmb3IgYXR0clsqXiRdPSIiIHNlbGVjdG9ycyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9IiI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQl9CgoJCS8vIElFNi03LCBpZiBhIGZvcm0gaGFzIGFuIGlucHV0IG9mIGlkIHgsIGZvcm0uZ2V0QXR0cmlidXRlKHgpIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGlucHV0CgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxmb3JtIGFjdGlvbj0icyI+PGlucHV0IGlkPSJhY3Rpb24iLz48L2Zvcm0+JzsKCQkJYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlciA9ICh0ZXN0Tm9kZS5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgnYWN0aW9uJykgIT0gJ3MnKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIG5hdGl2ZSBtYXRjaGVzU2VsZWN0b3IgZnVuY3Rpb24KCgkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yID0gcm9vdC5tYXRjaGVzU2VsZWN0b3IgfHwgLypyb290Lm1zTWF0Y2hlc1NlbGVjdG9yIHx8Ki8gcm9vdC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgcm9vdC53ZWJraXRNYXRjaGVzU2VsZWN0b3I7CgkJaWYgKGZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvcikgdHJ5IHsKCQkJLy8gaWYgbWF0Y2hlc1NlbGVjdG9yIHRyb3dzIGVycm9ycyBvbiBpbmNvcnJlY3Qgc2ludGF4ZXMgd2UgY2FuIHVzZSBpdAoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IuY2FsbChyb290LCAnOnNsaWNrJyk7CgkJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IG51bGw7CgkJfSBjYXRjaChlKXt9OwoKCX0KCgl0cnkgewoJCXJvb3Quc2xpY2tfZXhwYW5kbyA9IDE7CgkJZGVsZXRlIHJvb3Quc2xpY2tfZXhwYW5kbzsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJREhUTUw7Cgl9IGNhdGNoKGUpIHsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJRFhNTDsKCX0KCgl0ZXN0Um9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IHNlbGVjdGVkID0gdGVzdFJvb3QgPSBudWxsOwoKCS8vIGdldEF0dHJpYnV0ZQoKCWZlYXR1cmVzLmdldEF0dHJpYnV0ZSA9IChmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCAmJiBicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyKSA/IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJCXZhciBhdHRyaWJ1dGVOb2RlID0gbm9kZS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpOwoJCXJldHVybiAoYXR0cmlidXRlTm9kZSkgPyBhdHRyaWJ1dGVOb2RlLm5vZGVWYWx1ZSA6IG51bGw7Cgl9IDogZnVuY3Rpb24obm9kZSwgbmFtZSl7CgkJdmFyIG1ldGhvZCA9IHRoaXMuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKCQlyZXR1cm4gKG1ldGhvZCkgPyBtZXRob2QuY2FsbChub2RlKSA6IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwoJfTsKCgkvLyBoYXNBdHRyaWJ1dGUKCglmZWF0dXJlcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCXZhciBuYXRpdmVSb290Q29udGFpbnMgPSByb290ICYmIHRoaXMuaXNOYXRpdmVDb2RlKHJvb3QuY29udGFpbnMpLAoJCW5hdGl2ZURvY3VtZW50Q29udGFpbnMgPSBkb2N1bWVudCAmJiB0aGlzLmlzTmF0aXZlQ29kZShkb2N1bWVudC5jb250YWlucyk7CgoJZmVhdHVyZXMuY29udGFpbnMgPSAobmF0aXZlUm9vdENvbnRhaW5zICYmIG5hdGl2ZURvY3VtZW50Q29udGFpbnMpID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJcmV0dXJuIGNvbnRleHQuY29udGFpbnMobm9kZSk7Cgl9IDogKG5hdGl2ZVJvb3RDb250YWlucyAmJiAhbmF0aXZlRG9jdW1lbnRDb250YWlucykgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQkvLyBJRTggZG9lcyBub3QgaGF2ZSAuY29udGFpbnMgb24gZG9jdW1lbnQuCgkJcmV0dXJuIGNvbnRleHQgPT09IG5vZGUgfHwgKChjb250ZXh0ID09PSBkb2N1bWVudCkgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgOiBjb250ZXh0KS5jb250YWlucyhub2RlKTsKCX0gOiAocm9vdCAmJiByb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0ID09PSBub2RlIHx8ICEhKGNvbnRleHQuY29tcGFyZURvY3VtZW50UG9zaXRpb24obm9kZSkgJiAxNik7Cgl9IDogZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJaWYgKG5vZGUpIGRvIHsKCQkJaWYgKG5vZGUgPT09IGNvbnRleHQpIHJldHVybiB0cnVlOwoJCX0gd2hpbGUgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSk7CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkvLyBkb2N1bWVudCBvcmRlciBzb3J0aW5nCgkvLyBjcmVkaXRzIHRvIFNpenpsZSAoaHR0cDovL3NpenpsZWpzLmNvbS8pCgoJZmVhdHVyZXMuZG9jdW1lbnRTb3J0ZXIgPSAocm9vdC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gfHwgIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb24pIHJldHVybiAwOwoJCXJldHVybiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGIpICYgNCA/IC0xIDogYSA9PT0gYiA/IDAgOiAxOwoJfSA6ICgnc291cmNlSW5kZXgnIGluIHJvb3QpID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLnNvdXJjZUluZGV4IHx8ICFiLnNvdXJjZUluZGV4KSByZXR1cm4gMDsKCQlyZXR1cm4gYS5zb3VyY2VJbmRleCAtIGIuc291cmNlSW5kZXg7Cgl9IDogKGRvY3VtZW50LmNyZWF0ZVJhbmdlKSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5vd25lckRvY3VtZW50IHx8ICFiLm93bmVyRG9jdW1lbnQpIHJldHVybiAwOwoJCXZhciBhUmFuZ2UgPSBhLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKSwgYlJhbmdlID0gYi5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7CgkJYVJhbmdlLnNldFN0YXJ0KGEsIDApOwoJCWFSYW5nZS5zZXRFbmQoYSwgMCk7CgkJYlJhbmdlLnNldFN0YXJ0KGIsIDApOwoJCWJSYW5nZS5zZXRFbmQoYiwgMCk7CgkJcmV0dXJuIGFSYW5nZS5jb21wYXJlQm91bmRhcnlQb2ludHMoUmFuZ2UuU1RBUlRfVE9fRU5ELCBiUmFuZ2UpOwoJfSA6IG51bGwgOwoKCXJvb3QgPSBudWxsOwoKCWZvciAoZmVhdHVyZSBpbiBmZWF0dXJlcyl7CgkJdGhpc1tmZWF0dXJlXSA9IGZlYXR1cmVzW2ZlYXR1cmVdOwoJfQp9OwoKLy8gTWFpbiBNZXRob2QKCnZhciByZVNpbXBsZVNlbGVjdG9yID0gL14oWyMuXT8pKCg/Oltcdy1dK3xcKikpJC8sCglyZUVtcHR5QXR0cmlidXRlID0gL1xbLitbKiReXT0oPzoiInwnJyk/XF0vLAoJcXNhRmFpbEV4cENhY2hlID0ge307Cgpsb2NhbC5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQsIGZpcnN0KXsKCgl2YXIgZm91bmQgPSB0aGlzLmZvdW5kID0gKGZpcnN0KSA/IG51bGwgOiAoYXBwZW5kIHx8IFtdKTsKCglpZiAoIWNvbnRleHQpIHJldHVybiBmb3VuZDsKCWVsc2UgaWYgKGNvbnRleHQubmF2aWdhdG9yKSBjb250ZXh0ID0gY29udGV4dC5kb2N1bWVudDsgLy8gQ29udmVydCB0aGUgbm9kZSBmcm9tIGEgd2luZG93IHRvIGEgZG9jdW1lbnQKCWVsc2UgaWYgKCFjb250ZXh0Lm5vZGVUeXBlKSByZXR1cm4gZm91bmQ7CgoJLy8gc2V0dXAKCgl2YXIgcGFyc2VkLCBpLAoJCXVuaXF1ZXMgPSB0aGlzLnVuaXF1ZXMgPSB7fSwKCQloYXNPdGhlcnMgPSAhIShhcHBlbmQgJiYgYXBwZW5kLmxlbmd0aCksCgkJY29udGV4dElzRG9jdW1lbnQgPSAoY29udGV4dC5ub2RlVHlwZSA9PSA5KTsKCglpZiAodGhpcy5kb2N1bWVudCAhPT0gKGNvbnRleHRJc0RvY3VtZW50ID8gY29udGV4dCA6IGNvbnRleHQub3duZXJEb2N1bWVudCkpIHRoaXMuc2V0RG9jdW1lbnQoY29udGV4dCk7CgoJLy8gYXZvaWQgZHVwbGljYXRpbmcgaXRlbXMgYWxyZWFkeSBpbiB0aGUgYXBwZW5kIGFycmF5CglpZiAoaGFzT3RoZXJzKSBmb3IgKGkgPSBmb3VuZC5sZW5ndGg7IGktLTspIHVuaXF1ZXNbdGhpcy5nZXRVSUQoZm91bmRbaV0pXSA9IHRydWU7CgoJLy8gZXhwcmVzc2lvbiBjaGVja3MKCglpZiAodHlwZW9mIGV4cHJlc3Npb24gPT0gJ3N0cmluZycpeyAvLyBleHByZXNzaW9uIGlzIGEgc3RyaW5nCgoJCS8qPHNpbXBsZS1zZWxlY3RvcnMtb3ZlcnJpZGU+Ki8KCQl2YXIgc2ltcGxlU2VsZWN0b3IgPSBleHByZXNzaW9uLm1hdGNoKHJlU2ltcGxlU2VsZWN0b3IpOwoJCXNpbXBsZVNlbGVjdG9yczogaWYgKHNpbXBsZVNlbGVjdG9yKSB7CgoJCQl2YXIgc3ltYm9sID0gc2ltcGxlU2VsZWN0b3JbMV0sCgkJCQluYW1lID0gc2ltcGxlU2VsZWN0b3JbMl0sCgkJCQlub2RlLCBub2RlczsKCgkJCWlmICghc3ltYm9sKXsKCgkJCQlpZiAobmFtZSA9PSAnKicgJiYgdGhpcy5icm9rZW5TdGFyR0VCVE4pIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKTsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGVzWzBdIHx8IG51bGw7CgkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnIycpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAhY29udGV4dElzRG9jdW1lbnQpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCW5vZGUgPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKG5hbWUpOwoJCQkJaWYgKCFub2RlKSByZXR1cm4gZm91bmQ7CgkJCQlpZiAodGhpcy5pZEdldHNOYW1lICYmIG5vZGUuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgIT0gbmFtZSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZSB8fCBudWxsOwoJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCgkJCX0gZWxzZSBpZiAoc3ltYm9sID09ICcuJyl7CgoJCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50IHx8ICgoIWNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCB0aGlzLmJyb2tlbkdFQkNOKSAmJiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwpKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlpZiAoY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShuYW1lKTsKCQkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgbWF0Y2hDbGFzcyA9IG5ldyBSZWdFeHAoJyhefFxccyknKyBTbGljay5lc2NhcGVSZWdFeHAobmFtZSkgKycoXFxzfCQpJyk7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQkJY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CgkJCQkJCWlmICghKGNsYXNzTmFtZSAmJiBtYXRjaENsYXNzLnRlc3QoY2xhc3NOYW1lKSkpIGNvbnRpbnVlOwoJCQkJCQlpZiAoZmlyc3QpIHJldHVybiBub2RlOwoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0KCgkJCX0KCgkJCWlmIChoYXNPdGhlcnMpIHRoaXMuc29ydChmb3VuZCk7CgkJCXJldHVybiAoZmlyc3QpID8gbnVsbCA6IGZvdW5kOwoKCQl9CgkJLyo8L3NpbXBsZS1zZWxlY3RvcnMtb3ZlcnJpZGU+Ki8KCgkJLyo8cXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCQlxdWVyeVNlbGVjdG9yOiBpZiAoY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSB7CgoJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQKCQkJCXx8IHFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXQoJCQkJLy9UT0RPOiBvbmx5IHNraXAgd2hlbiBleHByZXNzaW9uIGlzIGFjdHVhbGx5IG1peGVkIGNhc2UKCQkJCXx8IHRoaXMuYnJva2VuTWl4ZWRDYXNlUVNBCgkJCQl8fCAodGhpcy5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKQoJCQkJfHwgKHRoaXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EgJiYgcmVFbXB0eUF0dHJpYnV0ZS50ZXN0KGV4cHJlc3Npb24pKQoJCQkJfHwgKCFjb250ZXh0SXNEb2N1bWVudCAvL0Fib3J0IHdoZW4gIWNvbnRleHRJc0RvY3VtZW50IGFuZC4uLgoJCQkJCS8vICB0aGVyZSBhcmUgbXVsdGlwbGUgZXhwcmVzc2lvbnMgaW4gdGhlIHNlbGVjdG9yCgkJCQkJLy8gIHNpbmNlIHdlIGN1cnJlbnRseSBvbmx5IGZpeCBub24tZG9jdW1lbnQgcm9vdGVkIFFTQSBmb3Igc2luZ2xlIGV4cHJlc3Npb24gc2VsZWN0b3JzCgkJCQkJJiYgZXhwcmVzc2lvbi5pbmRleE9mKCcsJykgPiAtMQoJCQkJKQoJCQkJfHwgU2xpY2suZGlzYWJsZVFTQQoJCQkpIGJyZWFrIHF1ZXJ5U2VsZWN0b3I7CgoJCQl2YXIgX2V4cHJlc3Npb24gPSBleHByZXNzaW9uLCBfY29udGV4dCA9IGNvbnRleHQ7CgkJCWlmICghY29udGV4dElzRG9jdW1lbnQpewoJCQkJLy8gbm9uLWRvY3VtZW50IHJvb3RlZCBRU0EKCQkJCS8vIGNyZWRpdHMgdG8gQW5kcmV3IER1cG9udAoJCQkJdmFyIGN1cnJlbnRJZCA9IF9jb250ZXh0LmdldEF0dHJpYnV0ZSgnaWQnKSwgc2xpY2tpZCA9ICdzbGlja2lkX18nOwoJCQkJX2NvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIHNsaWNraWQpOwoJCQkJX2V4cHJlc3Npb24gPSAnIycgKyBzbGlja2lkICsgJyAnICsgX2V4cHJlc3Npb247CgkJCQljb250ZXh0ID0gX2NvbnRleHQucGFyZW50Tm9kZTsKCQkJfQoKCQkJdHJ5IHsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvcihfZXhwcmVzc2lvbikgfHwgbnVsbDsKCQkJCWVsc2Ugbm9kZXMgPSBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoX2V4cHJlc3Npb24pOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXSA9IDE7CgkJCQlicmVhayBxdWVyeVNlbGVjdG9yOwoJCQl9IGZpbmFsbHkgewoJCQkJaWYgKCFjb250ZXh0SXNEb2N1bWVudCl7CgkJCQkJaWYgKGN1cnJlbnRJZCkgX2NvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIGN1cnJlbnRJZCk7CgkJCQkJZWxzZSBfY29udGV4dC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCQkJY29udGV4dCA9IF9jb250ZXh0OwoJCQkJfQoJCQl9CgoJCQlpZiAodGhpcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSkgZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCWlmIChub2RlLm5vZGVOYW1lID4gJ0AnICYmICEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gZm91bmQ7CgoJCX0KCQkvKjwvcXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCgkJcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShleHByZXNzaW9uKTsKCQlpZiAoIXBhcnNlZC5sZW5ndGgpIHJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbiA9PSBudWxsKXsgLy8gdGhlcmUgaXMgbm8gZXhwcmVzc2lvbgoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbi5TbGljayl7IC8vIGV4cHJlc3Npb24gaXMgYSBwYXJzZWQgU2xpY2sgb2JqZWN0CgkJcGFyc2VkID0gZXhwcmVzc2lvbjsKCX0gZWxzZSBpZiAodGhpcy5jb250YWlucyhjb250ZXh0LmRvY3VtZW50RWxlbWVudCB8fCBjb250ZXh0LCBleHByZXNzaW9uKSl7IC8vIGV4cHJlc3Npb24gaXMgYSBub2RlCgkJKGZvdW5kKSA/IGZvdW5kLnB1c2goZXhwcmVzc2lvbikgOiBmb3VuZCA9IGV4cHJlc3Npb247CgkJcmV0dXJuIGZvdW5kOwoJfSBlbHNlIHsgLy8gb3RoZXIganVuawoJCXJldHVybiBmb3VuZDsKCX0KCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjYWNoZSBlbGVtZW50cyBmb3IgdGhlIG50aCBzZWxlY3RvcnMKCgl0aGlzLnBvc05USCA9IHt9OwoJdGhpcy5wb3NOVEhMYXN0ID0ge307Cgl0aGlzLnBvc05USFR5cGUgPSB7fTsKCXRoaXMucG9zTlRIVHlwZUxhc3QgPSB7fTsKCgkvKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8vKjwvcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGlmIGFwcGVuZCBpcyBudWxsIGFuZCB0aGVyZSBpcyBvbmx5IGEgc2luZ2xlIHNlbGVjdG9yIHdpdGggb25lIGV4cHJlc3Npb24gdXNlIHB1c2hBcnJheSwgZWxzZSB1c2UgcHVzaFVJRAoJdGhpcy5wdXNoID0gKCFoYXNPdGhlcnMgJiYgKGZpcnN0IHx8IChwYXJzZWQubGVuZ3RoID09IDEgJiYgcGFyc2VkLmV4cHJlc3Npb25zWzBdLmxlbmd0aCA9PSAxKSkpID8gdGhpcy5wdXNoQXJyYXkgOiB0aGlzLnB1c2hVSUQ7CgoJaWYgKGZvdW5kID09IG51bGwpIGZvdW5kID0gW107CgoJLy8gZGVmYXVsdCBlbmdpbmUKCgl2YXIgaiwgbSwgbjsKCXZhciBjb21iaW5hdG9yLCB0YWcsIGlkLCBjbGFzc0xpc3QsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3M7Cgl2YXIgY3VycmVudEl0ZW1zLCBjdXJyZW50RXhwcmVzc2lvbiwgY3VycmVudEJpdCwgbGFzdEJpdCwgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnM7CgoJc2VhcmNoOiBmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKykgZm9yIChqID0gMDsgKGN1cnJlbnRCaXQgPSBjdXJyZW50RXhwcmVzc2lvbltqXSk7IGorKyl7CgoJCWNvbWJpbmF0b3IgPSAnY29tYmluYXRvcjonICsgY3VycmVudEJpdC5jb21iaW5hdG9yOwoJCWlmICghdGhpc1tjb21iaW5hdG9yXSkgY29udGludWUgc2VhcmNoOwoKCQl0YWcgICAgICAgID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBjdXJyZW50Qml0LnRhZyA6IGN1cnJlbnRCaXQudGFnLnRvVXBwZXJDYXNlKCk7CgkJaWQgICAgICAgICA9IGN1cnJlbnRCaXQuaWQ7CgkJY2xhc3NMaXN0ICA9IGN1cnJlbnRCaXQuY2xhc3NMaXN0OwoJCWNsYXNzZXMgICAgPSBjdXJyZW50Qml0LmNsYXNzZXM7CgkJYXR0cmlidXRlcyA9IGN1cnJlbnRCaXQuYXR0cmlidXRlczsKCQlwc2V1ZG9zICAgID0gY3VycmVudEJpdC5wc2V1ZG9zOwoJCWxhc3RCaXQgICAgPSAoaiA9PT0gKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCAtIDEpKTsKCgkJdGhpcy5iaXRVbmlxdWVzID0ge307CgoJCWlmIChsYXN0Qml0KXsKCQkJdGhpcy51bmlxdWVzID0gdW5pcXVlczsKCQkJdGhpcy5mb3VuZCA9IGZvdW5kOwoJCX0gZWxzZSB7CgkJCXRoaXMudW5pcXVlcyA9IHt9OwoJCQl0aGlzLmZvdW5kID0gW107CgkJfQoKCQlpZiAoaiA9PT0gMCl7CgkJCXRoaXNbY29tYmluYXRvcl0oY29udGV4dCwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQgJiYgZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJfSBlbHNlIHsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQpIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKXsKCQkJCXRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQkJaWYgKGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCQl9IGVsc2UgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspIHRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCX0KCgkJY3VycmVudEl0ZW1zID0gdGhpcy5mb3VuZDsKCX0KCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCWlmIChoYXNPdGhlcnMgfHwgKHBhcnNlZC5leHByZXNzaW9ucy5sZW5ndGggPiAxKSkgdGhpcy5zb3J0KGZvdW5kKTsKCglyZXR1cm4gKGZpcnN0KSA/IChmb3VuZFswXSB8fCBudWxsKSA6IGZvdW5kOwp9OwoKLy8gVXRpbHMKCmxvY2FsLnVpZHggPSAxOwpsb2NhbC51aWRrID0gJ3NsaWNrLXVuaXF1ZWlkJzsKCmxvY2FsLmdldFVJRFhNTCA9IGZ1bmN0aW9uKG5vZGUpewoJdmFyIHVpZCA9IG5vZGUuZ2V0QXR0cmlidXRlKHRoaXMudWlkayk7CglpZiAoIXVpZCl7CgkJdWlkID0gdGhpcy51aWR4Kys7CgkJbm9kZS5zZXRBdHRyaWJ1dGUodGhpcy51aWRrLCB1aWQpOwoJfQoJcmV0dXJuIHVpZDsKfTsKCmxvY2FsLmdldFVJREhUTUwgPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiBub2RlLnVuaXF1ZU51bWJlciB8fCAobm9kZS51bmlxdWVOdW1iZXIgPSB0aGlzLnVpZHgrKyk7Cn07CgovLyBzb3J0IGJhc2VkIG9uIHRoZSBzZXREb2N1bWVudCBkb2N1bWVudFNvcnRlciBtZXRob2QuCgpsb2NhbC5zb3J0ID0gZnVuY3Rpb24ocmVzdWx0cyl7CglpZiAoIXRoaXMuZG9jdW1lbnRTb3J0ZXIpIHJldHVybiByZXN1bHRzOwoJcmVzdWx0cy5zb3J0KHRoaXMuZG9jdW1lbnRTb3J0ZXIpOwoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLmNhY2hlTlRIID0ge307Cgpsb2NhbC5tYXRjaE5USCA9IC9eKFsrLV0/XGQqKT8oW2Etel0rKT8oWystXVxkKyk/JC87Cgpsb2NhbC5wYXJzZU5USEFyZ3VtZW50ID0gZnVuY3Rpb24oYXJndW1lbnQpewoJdmFyIHBhcnNlZCA9IGFyZ3VtZW50Lm1hdGNoKHRoaXMubWF0Y2hOVEgpOwoJaWYgKCFwYXJzZWQpIHJldHVybiBmYWxzZTsKCXZhciBzcGVjaWFsID0gcGFyc2VkWzJdIHx8IGZhbHNlOwoJdmFyIGEgPSBwYXJzZWRbMV0gfHwgMTsKCWlmIChhID09ICctJykgYSA9IC0xOwoJdmFyIGIgPSArcGFyc2VkWzNdIHx8IDA7CglwYXJzZWQgPQoJCShzcGVjaWFsID09ICduJykJPyB7YTogYSwgYjogYn0gOgoJCShzcGVjaWFsID09ICdvZGQnKQk/IHthOiAyLCBiOiAxfSA6CgkJKHNwZWNpYWwgPT0gJ2V2ZW4nKQk/IHthOiAyLCBiOiAwfSA6IHthOiAwLCBiOiBhfTsKCglyZXR1cm4gKHRoaXMuY2FjaGVOVEhbYXJndW1lbnRdID0gcGFyc2VkKTsKfTsKCmxvY2FsLmNyZWF0ZU5USFBzZXVkbyA9IGZ1bmN0aW9uKGNoaWxkLCBzaWJsaW5nLCBwb3NpdGlvbnMsIG9mVHlwZSl7CglyZXR1cm4gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQlpZiAoIXRoaXNbcG9zaXRpb25zXVt1aWRdKXsKCQkJdmFyIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKCQkJaWYgKCFwYXJlbnQpIHJldHVybiBmYWxzZTsKCQkJdmFyIGVsID0gcGFyZW50W2NoaWxkXSwgY291bnQgPSAxOwoJCQlpZiAob2ZUeXBlKXsKCQkJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVOYW1lICE9IG5vZGVOYW1lKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9IGVsc2UgewoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAodGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvcil7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwobm9kZSwgc2VsZWN0b3IucmVwbGFjZSgvXFsoW149XSspPVxzKihbXiciXF1dKz8pXHMqXF0vZywgJ1skMT0iJDIiXScpKTsKCQl9IGNhdGNoKG1hdGNoRXJyb3IpIHt9Cgl9CgoJdmFyIHBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2Uoc2VsZWN0b3IpOwoJaWYgKCFwYXJzZWQpIHJldHVybiB0cnVlOwoKCS8vIHNpbXBsZSAoc2luZ2xlKSBzZWxlY3RvcnMKCXZhciBleHByZXNzaW9ucyA9IHBhcnNlZC5leHByZXNzaW9ucywgc2ltcGxlRXhwQ291bnRlciA9IDAsIGk7Cglmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKyl7CgkJaWYgKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCA9PSAxKXsKCQkJdmFyIGV4cCA9IGN1cnJlbnRFeHByZXNzaW9uWzBdOwoJCQlpZiAodGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gZXhwLnRhZyA6IGV4cC50YWcudG9VcHBlckNhc2UoKSwgZXhwLmlkLCBleHAuY2xhc3NlcywgZXhwLmF0dHJpYnV0ZXMsIGV4cC5wc2V1ZG9zKSkgcmV0dXJuIHRydWU7CgkJCXNpbXBsZUV4cENvdW50ZXIrKzsKCQl9Cgl9CgoJaWYgKHNpbXBsZUV4cENvdW50ZXIgPT0gcGFyc2VkLmxlbmd0aCkgcmV0dXJuIGZhbHNlOwoKCXZhciBub2RlcyA9IHRoaXMuc2VhcmNoKHRoaXMuZG9jdW1lbnQsIHBhcnNlZCksIGl0ZW07Cglmb3IgKGkgPSAwOyBpdGVtID0gbm9kZXNbaSsrXTspewoJCWlmIChpdGVtID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCX0KCXJldHVybiBmYWxzZTsKfTsKCmxvY2FsLm1hdGNoUHNldWRvID0gZnVuY3Rpb24obm9kZSwgbmFtZSwgYXJndW1lbnQpewoJdmFyIHBzZXVkb05hbWUgPSAncHNldWRvOicgKyBuYW1lOwoJaWYgKHRoaXNbcHNldWRvTmFtZV0pIHJldHVybiB0aGlzW3BzZXVkb05hbWVdKG5vZGUsIGFyZ3VtZW50KTsKCXZhciBhdHRyaWJ1dGUgPSB0aGlzLmdldEF0dHJpYnV0ZShub2RlLCBuYW1lKTsKCXJldHVybiAoYXJndW1lbnQpID8gYXJndW1lbnQgPT0gYXR0cmlidXRlIDogISFhdHRyaWJ1dGU7Cn07Cgpsb2NhbC5tYXRjaFNlbGVjdG9yID0gZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7CglpZiAodGFnKXsKCQl2YXIgbm9kZU5hbWUgPSAodGhpcy5pc1hNTERvY3VtZW50KSA/IG5vZGUubm9kZU5hbWUgOiBub2RlLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCk7CgkJaWYgKHRhZyA9PSAnKicpewoJCQlpZiAobm9kZU5hbWUgPCAnQCcpIHJldHVybiBmYWxzZTsgLy8gRml4IGZvciBjb21tZW50IG5vZGVzIGFuZCBjbG9zZWQgbm9kZXMKCQl9IGVsc2UgewoJCQlpZiAobm9kZU5hbWUgIT0gdGFnKSByZXR1cm4gZmFsc2U7CgkJfQoJfQoKCWlmIChpZCAmJiBub2RlLmdldEF0dHJpYnV0ZSgnaWQnKSAhPSBpZCkgcmV0dXJuIGZhbHNlOwoKCXZhciBpLCBwYXJ0LCBjbHM7CglpZiAoY2xhc3NlcykgZm9yIChpID0gY2xhc3Nlcy5sZW5ndGg7IGktLTspewoJCWNscyA9IHRoaXMuZ2V0QXR0cmlidXRlKG5vZGUsICdjbGFzcycpOwoJCWlmICghKGNscyAmJiBjbGFzc2VzW2ldLnJlZ2V4cC50ZXN0KGNscykpKSByZXR1cm4gZmFsc2U7Cgl9CglpZiAoYXR0cmlidXRlcykgZm9yIChpID0gYXR0cmlidXRlcy5sZW5ndGg7IGktLTspewoJCXBhcnQgPSBhdHRyaWJ1dGVzW2ldOwoJCWlmIChwYXJ0Lm9wZXJhdG9yID8gIXBhcnQudGVzdCh0aGlzLmdldEF0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIDogIXRoaXMuaGFzQXR0cmlidXRlKG5vZGUsIHBhcnQua2V5KSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKHBzZXVkb3MpIGZvciAoaSA9IHBzZXVkb3MubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gcHNldWRvc1tpXTsKCQlpZiAoIXRoaXMubWF0Y2hQc2V1ZG8obm9kZSwgcGFydC5rZXksIHBhcnQudmFsdWUpKSByZXR1cm4gZmFsc2U7Cgl9CglyZXR1cm4gdHJ1ZTsKfTsKCnZhciBjb21iaW5hdG9ycyA9IHsKCgknICc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCl7IC8vIGFsbCBjaGlsZCBub2RlcywgYW55IGxldmVsCgoJCXZhciBpLCBpdGVtLCBjaGlsZHJlbjsKCgkJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQpewoJCQlnZXRCeUlkOiBpZiAoaWQpewoJCQkJaXRlbSA9IHRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJCQkJaWYgKCghaXRlbSAmJiBub2RlLmFsbCkgfHwgKHRoaXMuaWRHZXRzTmFtZSAmJiBpdGVtICYmIGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgIT0gaWQpKXsKCQkJCQkvLyBhbGxbaWRdIHJldHVybnMgYWxsIHRoZSBlbGVtZW50cyB3aXRoIHRoYXQgbmFtZSBvciBpZCBpbnNpZGUgbm9kZQoJCQkJCS8vIGlmIHRoZXJlcyBqdXN0IG9uZSBpdCB3aWxsIHJldHVybiB0aGUgZWxlbWVudCwgZWxzZSBpdCB3aWxsIGJlIGEgY29sbGVjdGlvbgoJCQkJCWNoaWxkcmVuID0gbm9kZS5hbGxbaWRdOwoJCQkJCWlmICghY2hpbGRyZW4pIHJldHVybjsKCQkJCQlpZiAoIWNoaWxkcmVuWzBdKSBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CgkJCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KXsKCQkJCQkJdmFyIGlkTm9kZSA9IGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKTsKCQkJCQkJaWYgKGlkTm9kZSAmJiBpZE5vZGUubm9kZVZhbHVlID09IGlkKXsKCQkJCQkJCXRoaXMucHVzaChpdGVtLCB0YWcsIG51bGwsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFpdGVtKXsKCQkJCQkvLyBpZiB0aGUgY29udGV4dCBpcyBpbiB0aGUgZG9tIHdlIHJldHVybiwgZWxzZSB3ZSB3aWxsIHRyeSBHRUJUTiwgYnJlYWtpbmcgdGhlIGdldEJ5SWQgbGFiZWwKCQkJCQlpZiAodGhpcy5jb250YWlucyh0aGlzLnJvb3QsIG5vZGUpKSByZXR1cm47CgkJCQkJZWxzZSBicmVhayBnZXRCeUlkOwoJCQkJfSBlbHNlIGlmICh0aGlzLmRvY3VtZW50ICE9PSBub2RlICYmICF0aGlzLmNvbnRhaW5zKG5vZGUsIGl0ZW0pKSByZXR1cm47CgkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCXJldHVybjsKCQkJfQoJCQlnZXRCeUNsYXNzOiBpZiAoY2xhc3NlcyAmJiBub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgIXRoaXMuYnJva2VuR0VCQ04pewoJCQkJY2hpbGRyZW4gPSBub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NMaXN0LmpvaW4oJyAnKSk7CgkJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeUNsYXNzOwoJCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgbnVsbCwgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJZ2V0QnlUYWc6IHsKCQkJY2hpbGRyZW4gPSBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CgkJCWlmICghKGNoaWxkcmVuICYmIGNoaWxkcmVuLmxlbmd0aCkpIGJyZWFrIGdldEJ5VGFnOwoJCQlpZiAoIXRoaXMuYnJva2VuU3RhckdFQlROKSB0YWcgPSBudWxsOwoJCQlmb3IgKGkgPSAwOyBpdGVtID0gY2hpbGRyZW5baSsrXTspIHRoaXMucHVzaChpdGVtLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSc+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGRpcmVjdCBjaGlsZHJlbgoJCWlmICgobm9kZSA9IG5vZGUuZmlyc3RDaGlsZCkpIGRvIHsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0gd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpOwoJfSwKCgknKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmcKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBmaXJzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWVsc2UgdGhpc1snY29tYmluYXRvcjorJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmdzCgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpewoJCQlpZiAobm9kZS5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCScrKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmcgYW5kIHByZXZpb3VzIHNpYmxpbmcKCQl0aGlzWydjb21iaW5hdG9yOisnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl0aGlzWydjb21iaW5hdG9yOiErJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSd+fic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmdzIGFuZCBwcmV2aW91cyBzaWJsaW5ncwoJCXRoaXNbJ2NvbWJpbmF0b3I6fiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6IX4nXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyEnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gYWxsIHBhcmVudCBub2RlcyB1cCB0byBkb2N1bWVudAoJCXdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpIGlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgcGFyZW50IChvbmUgbGV2ZWwpCgkJbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCQlpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISsnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknIV4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbGFzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmxhc3RDaGlsZDsKCQlpZiAobm9kZSl7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJZWxzZSB0aGlzWydjb21iaW5hdG9yOiErJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknIX4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZ3MKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpewoJCQlpZiAobm9kZS5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9Cgp9OwoKZm9yICh2YXIgYyBpbiBjb21iaW5hdG9ycykgbG9jYWxbJ2NvbWJpbmF0b3I6JyArIGNdID0gY29tYmluYXRvcnNbY107Cgp2YXIgcHNldWRvcyA9IHsKCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2VtcHR5JzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIGNoaWxkID0gbm9kZS5maXJzdENoaWxkOwoJCXJldHVybiAhKGNoaWxkICYmIGNoaWxkLm5vZGVUeXBlID09IDEpICYmICEobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykubGVuZ3RoOwoJfSwKCgknbm90JzogZnVuY3Rpb24obm9kZSwgZXhwcmVzc2lvbil7CgkJcmV0dXJuICF0aGlzLm1hdGNoTm9kZShub2RlLCBleHByZXNzaW9uKTsKCX0sCgoJJ2NvbnRhaW5zJzogZnVuY3Rpb24obm9kZSwgdGV4dCl7CgkJcmV0dXJuIChub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5pbmRleE9mKHRleHQpID4gLTE7Cgl9LAoKCSdmaXJzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LWNoaWxkJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIHByZXYgPSBub2RlOwoJCXdoaWxlICgocHJldiA9IHByZXYucHJldmlvdXNTaWJsaW5nKSkgaWYgKHByZXYubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgkvKjxudGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdudGgtY2hpbGQnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2ZpcnN0Q2hpbGQnLCAnbmV4dFNpYmxpbmcnLCAncG9zTlRIJyksCgoJJ250aC1sYXN0LWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdsYXN0Q2hpbGQnLCAncHJldmlvdXNTaWJsaW5nJywgJ3Bvc05USExhc3QnKSwKCgknbnRoLW9mLXR5cGUnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2ZpcnN0Q2hpbGQnLCAnbmV4dFNpYmxpbmcnLCAncG9zTlRIVHlwZScsIHRydWUpLAoKCSdudGgtbGFzdC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdsYXN0Q2hpbGQnLCAncHJldmlvdXNTaWJsaW5nJywgJ3Bvc05USFR5cGVMYXN0JywgdHJ1ZSksCgoJJ2luZGV4JzogZnVuY3Rpb24obm9kZSwgaW5kZXgpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJycgKyAoaW5kZXggKyAxKSk7Cgl9LAoKCSdldmVuJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4nKTsKCX0sCgoJJ29kZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJzJuKzEnKTsKCX0sCgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLyo8b2YtdHlwZS1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2ZpcnN0LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3Qtb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGUsIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJdmFyIG5leHQgPSBub2RlOwoJCXdoaWxlICgobmV4dCA9IG5leHQubmV4dFNpYmxpbmcpKSBpZiAobmV4dC5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgkvKjwvb2YtdHlwZS1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLy8gY3VzdG9tIHBzZXVkb3MKCgknZW5hYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAhbm9kZS5kaXNhYmxlZDsKCX0sCgoJJ2Rpc2FibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuZGlzYWJsZWQ7Cgl9LAoKCSdjaGVja2VkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuY2hlY2tlZCB8fCBub2RlLnNlbGVjdGVkOwoJfSwKCgknZm9jdXMnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IG5vZGUgJiYgKG5vZGUuaHJlZiB8fCBub2RlLnR5cGUgfHwgdGhpcy5oYXNBdHRyaWJ1dGUobm9kZSwgJ3RhYmluZGV4JykpOwoJfSwKCgkncm9vdCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZSA9PT0gdGhpcy5yb290KTsKCX0sCgoJJ3NlbGVjdGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuc2VsZWN0ZWQ7Cgl9CgoJLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KfTsKCmZvciAodmFyIHAgaW4gcHNldWRvcykgbG9jYWxbJ3BzZXVkbzonICsgcF0gPSBwc2V1ZG9zW3BdOwoKLy8gYXR0cmlidXRlcyBtZXRob2RzCgp2YXIgYXR0cmlidXRlR2V0dGVycyA9IGxvY2FsLmF0dHJpYnV0ZUdldHRlcnMgPSB7CgoJJ2Zvcic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHRtbEZvcicgaW4gdGhpcykgPyB0aGlzLmh0bWxGb3IgOiB0aGlzLmdldEF0dHJpYnV0ZSgnZm9yJyk7Cgl9LAoKCSdocmVmJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdocmVmJyBpbiB0aGlzKSA/IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJywgMikgOiB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5zdHlsZSkgPyB0aGlzLnN0eWxlLmNzc1RleHQgOiB0aGlzLmdldEF0dHJpYnV0ZSgnc3R5bGUnKTsKCX0sCgoJJ3RhYmluZGV4JzogZnVuY3Rpb24oKXsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgndGFiaW5kZXgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSwKCgkndHlwZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0QXR0cmlidXRlKCd0eXBlJyk7Cgl9LAoKCSdtYXhsZW5ndGgnOiBmdW5jdGlvbigpewoJCXZhciBhdHRyaWJ1dGVOb2RlID0gdGhpcy5nZXRBdHRyaWJ1dGVOb2RlKCdtYXhMZW5ndGgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfQoKfTsKCmF0dHJpYnV0ZUdldHRlcnMuTUFYTEVOR1RIID0gYXR0cmlidXRlR2V0dGVycy5tYXhMZW5ndGggPSBhdHRyaWJ1dGVHZXR0ZXJzLm1heGxlbmd0aDsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMS4xLjcnOwoKLy8gU2xpY2sgZmluZGVyCgpTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwp9OwoKU2xpY2suZmluZCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24pewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBudWxsLCB0cnVlKTsKfTsKCi8vIFNsaWNrIGNvbnRhaW5tZW50IGNoZWNrZXIKClNsaWNrLmNvbnRhaW5zID0gZnVuY3Rpb24oY29udGFpbmVyLCBub2RlKXsKCWxvY2FsLnNldERvY3VtZW50KGNvbnRhaW5lcik7CglyZXR1cm4gbG9jYWwuY29udGFpbnMoY29udGFpbmVyLCBub2RlKTsKfTsKCi8vIFNsaWNrIGF0dHJpYnV0ZSBnZXR0ZXIKClNsaWNrLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJbG9jYWwuc2V0RG9jdW1lbnQobm9kZSk7CglyZXR1cm4gbG9jYWwuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwp9OwoKU2xpY2suaGFzQXR0cmlidXRlID0gZnVuY3Rpb24obm9kZSwgbmFtZSl7Cglsb2NhbC5zZXREb2N1bWVudChub2RlKTsKCXJldHVybiBsb2NhbC5oYXNBdHRyaWJ1dGUobm9kZSwgbmFtZSk7Cn07CgovLyBTbGljayBtYXRjaGVyCgpTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCWlmICghKG5vZGUgJiYgc2VsZWN0b3IpKSByZXR1cm4gZmFsc2U7CglpZiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCWxvY2FsLnNldERvY3VtZW50KG5vZGUpOwoJcmV0dXJuIGxvY2FsLm1hdGNoTm9kZShub2RlLCBzZWxlY3Rvcik7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgYWNjZXNzb3IKClNsaWNrLmRlZmluZUF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV0gPSBmbjsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSl7CglyZXR1cm4gbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKfTsKCi8vIFNsaWNrIHBzZXVkbyBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lUHNldWRvID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWxbJ3BzZXVkbzonICsgbmFtZV0gPSBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIGZuLmNhbGwobm9kZSwgYXJndW1lbnQpOwoJfTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwUHNldWRvID0gZnVuY3Rpb24obmFtZSl7Cgl2YXIgcHNldWRvID0gbG9jYWxbJ3BzZXVkbzonICsgbmFtZV07CglpZiAocHNldWRvKSByZXR1cm4gZnVuY3Rpb24oYXJndW1lbnQpewoJCXJldHVybiBwc2V1ZG8uY2FsbCh0aGlzLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIG51bGw7Cn07CgovLyBTbGljayBvdmVycmlkZXMgYWNjZXNzb3IKClNsaWNrLm92ZXJyaWRlID0gZnVuY3Rpb24ocmVnZXhwLCBmbil7Cglsb2NhbC5vdmVycmlkZShyZWdleHAsIGZuKTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2suaXNYTUwgPSBsb2NhbC5pc1hNTDsKClNsaWNrLnVpZE9mID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbG9jYWwuZ2V0VUlESFRNTChub2RlKTsKfTsKCmlmICghdGhpcy5TbGljaykgdGhpcy5TbGljayA9IFNsaWNrOwoKfSkuYXBwbHkoLyo8Q29tbW9uSlM+Ki8odHlwZW9mIGV4cG9ydHMgIT0gJ3VuZGVmaW5lZCcpID8gZXhwb3J0cyA6IC8qPC9Db21tb25KUz4qL3RoaXMpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudAoKZGVzY3JpcHRpb246IE9uZSBvZiB0aGUgbW9zdCBpbXBvcnRhbnQgaXRlbXMgaW4gTW9vVG9vbHMuIENvbnRhaW5zIHRoZSBkb2xsYXIgZnVuY3Rpb24sIHRoZSBkb2xsYXJzIGZ1bmN0aW9uLCBhbmQgYW4gaGFuZGZ1bCBvZiBjcm9zcy1icm93c2VyLCB0aW1lLXNhdmVyIG1ldGhvZHMgdG8gbGV0IHlvdSBlYXNpbHkgd29yayB3aXRoIEhUTUwgRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE9iamVjdCwgTnVtYmVyLCBTbGljay5QYXJzZXIsIFNsaWNrLkZpbmRlcl0KCnByb3ZpZGVzOiBbRWxlbWVudCwgRWxlbWVudHMsICQsICQkLCBJZnJhbWUsIFNlbGVjdG9yc10KCi4uLgoqLwoKdmFyIEVsZW1lbnQgPSBmdW5jdGlvbih0YWcsIHByb3BzKXsKCXZhciBrb25zdHJ1Y3RvciA9IEVsZW1lbnQuQ29uc3RydWN0b3JzW3RhZ107CglpZiAoa29uc3RydWN0b3IpIHJldHVybiBrb25zdHJ1Y3Rvcihwcm9wcyk7CglpZiAodHlwZW9mIHRhZyAhPSAnc3RyaW5nJykgcmV0dXJuIGRvY3VtZW50LmlkKHRhZykuc2V0KHByb3BzKTsKCglpZiAoIXByb3BzKSBwcm9wcyA9IHt9OwoKCWlmICghKC9eW1x3LV0rJC8pLnRlc3QodGFnKSl7CgkJdmFyIHBhcnNlZCA9IFNsaWNrLnBhcnNlKHRhZykuZXhwcmVzc2lvbnNbMF1bMF07CgkJdGFnID0gKHBhcnNlZC50YWcgPT0gJyonKSA/ICdkaXYnIDogcGFyc2VkLnRhZzsKCQlpZiAocGFyc2VkLmlkICYmIHByb3BzLmlkID09IG51bGwpIHByb3BzLmlkID0gcGFyc2VkLmlkOwoKCQl2YXIgYXR0cmlidXRlcyA9IHBhcnNlZC5hdHRyaWJ1dGVzOwoJCWlmIChhdHRyaWJ1dGVzKSBmb3IgKHZhciBhdHRyLCBpID0gMCwgbCA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJYXR0ciA9IGF0dHJpYnV0ZXNbaV07CgkJCWlmIChwcm9wc1thdHRyLmtleV0gIT0gbnVsbCkgY29udGludWU7CgoJCQlpZiAoYXR0ci52YWx1ZSAhPSBudWxsICYmIGF0dHIub3BlcmF0b3IgPT0gJz0nKSBwcm9wc1thdHRyLmtleV0gPSBhdHRyLnZhbHVlOwoJCQllbHNlIGlmICghYXR0ci52YWx1ZSAmJiAhYXR0ci5vcGVyYXRvcikgcHJvcHNbYXR0ci5rZXldID0gdHJ1ZTsKCQl9CgoJCWlmIChwYXJzZWQuY2xhc3NMaXN0ICYmIHByb3BzWydjbGFzcyddID09IG51bGwpIHByb3BzWydjbGFzcyddID0gcGFyc2VkLmNsYXNzTGlzdC5qb2luKCcgJyk7Cgl9CgoJcmV0dXJuIGRvY3VtZW50Lm5ld0VsZW1lbnQodGFnLCBwcm9wcyk7Cn07CgoKaWYgKEJyb3dzZXIuRWxlbWVudCl7CglFbGVtZW50LnByb3RvdHlwZSA9IEJyb3dzZXIuRWxlbWVudC5wcm90b3R5cGU7CgkvLyBJRTggYW5kIElFOSByZXF1aXJlIHRoZSB3cmFwcGluZy4KCUVsZW1lbnQucHJvdG90eXBlLl9maXJlRXZlbnQgPSAoZnVuY3Rpb24oZmlyZUV2ZW50KXsKCQlyZXR1cm4gZnVuY3Rpb24odHlwZSwgZXZlbnQpewoJCQlyZXR1cm4gZmlyZUV2ZW50LmNhbGwodGhpcywgdHlwZSwgZXZlbnQpOwoJCX07Cgl9KShFbGVtZW50LnByb3RvdHlwZS5maXJlRXZlbnQpOwp9CgpuZXcgVHlwZSgnRWxlbWVudCcsIEVsZW1lbnQpLm1pcnJvcihmdW5jdGlvbihuYW1lKXsKCWlmIChBcnJheS5wcm90b3R5cGVbbmFtZV0pIHJldHVybjsKCgl2YXIgb2JqID0ge307CglvYmpbbmFtZV0gPSBmdW5jdGlvbigpewoJCXZhciByZXN1bHRzID0gW10sIGFyZ3MgPSBhcmd1bWVudHMsIGVsZW1lbnRzID0gdHJ1ZTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSB0aGlzW2ldLCByZXN1bHQgPSByZXN1bHRzW2ldID0gZWxlbWVudFtuYW1lXS5hcHBseShlbGVtZW50LCBhcmdzKTsKCQkJZWxlbWVudHMgPSAoZWxlbWVudHMgJiYgdHlwZU9mKHJlc3VsdCkgPT0gJ2VsZW1lbnQnKTsKCQl9CgkJcmV0dXJuIChlbGVtZW50cykgPyBuZXcgRWxlbWVudHMocmVzdWx0cykgOiByZXN1bHRzOwoJfTsKCglFbGVtZW50cy5pbXBsZW1lbnQob2JqKTsKfSk7CgppZiAoIUJyb3dzZXIuRWxlbWVudCl7CglFbGVtZW50LnBhcmVudCA9IE9iamVjdDsKCglFbGVtZW50LlByb3RvdHlwZSA9IHsKCQknJGNvbnN0cnVjdG9yJzogRWxlbWVudCwKCQknJGZhbWlseSc6IEZ1bmN0aW9uLmZyb20oJ2VsZW1lbnQnKS5oaWRlKCkKCX07CgoJRWxlbWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCQlFbGVtZW50LlByb3RvdHlwZVtuYW1lXSA9IG1ldGhvZDsKCX0pOwp9CgpFbGVtZW50LkNvbnN0cnVjdG9ycyA9IHt9OwoKCgp2YXIgSUZyYW1lID0gbmV3IFR5cGUoJ0lGcmFtZScsIGZ1bmN0aW9uKCl7Cgl2YXIgcGFyYW1zID0gQXJyYXkubGluayhhcmd1bWVudHMsIHsKCQlwcm9wZXJ0aWVzOiBUeXBlLmlzT2JqZWN0LAoJCWlmcmFtZTogZnVuY3Rpb24ob2JqKXsKCQkJcmV0dXJuIChvYmogIT0gbnVsbCk7CgkJfQoJfSk7CgoJdmFyIHByb3BzID0gcGFyYW1zLnByb3BlcnRpZXMgfHwge30sIGlmcmFtZTsKCWlmIChwYXJhbXMuaWZyYW1lKSBpZnJhbWUgPSBkb2N1bWVudC5pZChwYXJhbXMuaWZyYW1lKTsKCXZhciBvbmxvYWQgPSBwcm9wcy5vbmxvYWQgfHwgZnVuY3Rpb24oKXt9OwoJZGVsZXRlIHByb3BzLm9ubG9hZDsKCXByb3BzLmlkID0gcHJvcHMubmFtZSA9IFtwcm9wcy5pZCwgcHJvcHMubmFtZSwgaWZyYW1lID8gKGlmcmFtZS5pZCB8fCBpZnJhbWUubmFtZSkgOiAnSUZyYW1lXycgKyBTdHJpbmcudW5pcXVlSUQoKV0ucGljaygpOwoJaWZyYW1lID0gbmV3IEVsZW1lbnQoaWZyYW1lIHx8ICdpZnJhbWUnLCBwcm9wcyk7CgoJdmFyIG9uTG9hZCA9IGZ1bmN0aW9uKCl7CgkJb25sb2FkLmNhbGwoaWZyYW1lLmNvbnRlbnRXaW5kb3cpOwoJfTsKCglpZiAod2luZG93LmZyYW1lc1twcm9wcy5pZF0pIG9uTG9hZCgpOwoJZWxzZSBpZnJhbWUuYWRkTGlzdGVuZXIoJ2xvYWQnLCBvbkxvYWQpOwoJcmV0dXJuIGlmcmFtZTsKfSk7Cgp2YXIgRWxlbWVudHMgPSB0aGlzLkVsZW1lbnRzID0gZnVuY3Rpb24obm9kZXMpewoJaWYgKG5vZGVzICYmIG5vZGVzLmxlbmd0aCl7CgkJdmFyIHVuaXF1ZXMgPSB7fSwgbm9kZTsKCQlmb3IgKHZhciBpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJdmFyIHVpZCA9IFNsaWNrLnVpZE9mKG5vZGUpOwoJCQlpZiAoIXVuaXF1ZXNbdWlkXSl7CgkJCQl1bmlxdWVzW3VpZF0gPSB0cnVlOwoJCQkJdGhpcy5wdXNoKG5vZGUpOwoJCQl9CgkJfQoJfQp9OwoKRWxlbWVudHMucHJvdG90eXBlID0ge2xlbmd0aDogMH07CkVsZW1lbnRzLnBhcmVudCA9IEFycmF5OwoKbmV3IFR5cGUoJ0VsZW1lbnRzJywgRWxlbWVudHMpLmltcGxlbWVudCh7CgoJZmlsdGVyOiBmdW5jdGlvbihmaWx0ZXIsIGJpbmQpewoJCWlmICghZmlsdGVyKSByZXR1cm4gdGhpczsKCQlyZXR1cm4gbmV3IEVsZW1lbnRzKEFycmF5LmZpbHRlcih0aGlzLCAodHlwZU9mKGZpbHRlcikgPT0gJ3N0cmluZycpID8gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtLm1hdGNoKGZpbHRlcik7CgkJfSA6IGZpbHRlciwgYmluZCkpOwoJfS5wcm90ZWN0KCksCgoJcHVzaDogZnVuY3Rpb24oKXsKCQl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5pZChhcmd1bWVudHNbaV0pOwoJCQlpZiAoaXRlbSkgdGhpc1tsZW5ndGgrK10gPSBpdGVtOwoJCX0KCQlyZXR1cm4gKHRoaXMubGVuZ3RoID0gbGVuZ3RoKTsKCX0ucHJvdGVjdCgpLAoKCXVuc2hpZnQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGl0ZW1zID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5pZChhcmd1bWVudHNbaV0pOwoJCQlpZiAoaXRlbSkgaXRlbXMucHVzaChpdGVtKTsKCQl9CgkJcmV0dXJuIEFycmF5LnByb3RvdHlwZS51bnNoaWZ0LmFwcGx5KHRoaXMsIGl0ZW1zKTsKCX0ucHJvdGVjdCgpLAoKCWNvbmNhdDogZnVuY3Rpb24oKXsKCQl2YXIgbmV3RWxlbWVudHMgPSBuZXcgRWxlbWVudHModGhpcyk7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBhcmd1bWVudHNbaV07CgkJCWlmIChUeXBlLmlzRW51bWVyYWJsZShpdGVtKSkgbmV3RWxlbWVudHMuYXBwZW5kKGl0ZW0pOwoJCQllbHNlIG5ld0VsZW1lbnRzLnB1c2goaXRlbSk7CgkJfQoJCXJldHVybiBuZXdFbGVtZW50czsKCX0ucHJvdGVjdCgpLAoKCWFwcGVuZDogZnVuY3Rpb24oY29sbGVjdGlvbil7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBjb2xsZWN0aW9uLmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5wdXNoKGNvbGxlY3Rpb25baV0pOwoJCXJldHVybiB0aGlzOwoJfS5wcm90ZWN0KCksCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJd2hpbGUgKHRoaXMubGVuZ3RoKSBkZWxldGUgdGhpc1stLXRoaXMubGVuZ3RoXTsKCQlyZXR1cm4gdGhpczsKCX0ucHJvdGVjdCgpCgp9KTsKCgoKKGZ1bmN0aW9uKCl7CgovLyBGRiwgSUUKdmFyIHNwbGljZSA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UsIG9iamVjdCA9IHsnMCc6IDAsICcxJzogMSwgbGVuZ3RoOiAyfTsKCnNwbGljZS5jYWxsKG9iamVjdCwgMSwgMSk7CmlmIChvYmplY3RbMV0gPT0gMSkgRWxlbWVudHMuaW1wbGVtZW50KCdzcGxpY2UnLCBmdW5jdGlvbigpewoJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwoJdmFyIHJlc3VsdCA9IHNwbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJd2hpbGUgKGxlbmd0aCA+PSB0aGlzLmxlbmd0aCkgZGVsZXRlIHRoaXNbbGVuZ3RoLS1dOwoJcmV0dXJuIHJlc3VsdDsKfS5wcm90ZWN0KCkpOwoKQXJyYXkuZm9yRWFjaE1ldGhvZChmdW5jdGlvbihtZXRob2QsIG5hbWUpewoJRWxlbWVudHMuaW1wbGVtZW50KG5hbWUsIG1ldGhvZCk7Cn0pOwoKQXJyYXkubWlycm9yKEVsZW1lbnRzKTsKCi8qPGx0SUU4PiovCnZhciBjcmVhdGVFbGVtZW50QWNjZXB0c0hUTUw7CnRyeSB7CiAgICBjcmVhdGVFbGVtZW50QWNjZXB0c0hUTUwgPSAoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnPGlucHV0IG5hbWU9eD4nKS5uYW1lID09ICd4Jyk7Cn0gY2F0Y2ggKGUpe30KCnZhciBlc2NhcGVRdW90ZXMgPSBmdW5jdGlvbihodG1sKXsKCXJldHVybiAoJycgKyBodG1sKS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9OwovKjwvbHRJRTg+Ki8KCkRvY3VtZW50LmltcGxlbWVudCh7CgoJbmV3RWxlbWVudDogZnVuY3Rpb24odGFnLCBwcm9wcyl7CgkJaWYgKHByb3BzICYmIHByb3BzLmNoZWNrZWQgIT0gbnVsbCkgcHJvcHMuZGVmYXVsdENoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwoJCS8qPGx0SUU4PiovLy8gRml4IGZvciByZWFkb25seSBuYW1lIGFuZCB0eXBlIHByb3BlcnRpZXMgaW4gSUUgPCA4CgkJaWYgKGNyZWF0ZUVsZW1lbnRBY2NlcHRzSFRNTCAmJiBwcm9wcyl7CgkJCXRhZyA9ICc8JyArIHRhZzsKCQkJaWYgKHByb3BzLm5hbWUpIHRhZyArPSAnIG5hbWU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMubmFtZSkgKyAnIic7CgkJCWlmIChwcm9wcy50eXBlKSB0YWcgKz0gJyB0eXBlPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLnR5cGUpICsgJyInOwoJCQl0YWcgKz0gJz4nOwoJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJZGVsZXRlIHByb3BzLnR5cGU7CgkJfQoJCS8qPC9sdElFOD4qLwoJCXJldHVybiB0aGlzLmlkKHRoaXMuY3JlYXRlRWxlbWVudCh0YWcpKS5zZXQocHJvcHMpOwoJfQoKfSk7Cgp9KSgpOwoKKGZ1bmN0aW9uKCl7CgpTbGljay51aWRPZih3aW5kb3cpOwpTbGljay51aWRPZihkb2N1bWVudCk7CgpEb2N1bWVudC5pbXBsZW1lbnQoewoKCW5ld1RleHROb2RlOiBmdW5jdGlvbih0ZXh0KXsKCQlyZXR1cm4gdGhpcy5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy53aW5kb3c7Cgl9LAoKCWlkOiAoZnVuY3Rpb24oKXsKCgkJdmFyIHR5cGVzID0gewoKCQkJc3RyaW5nOiBmdW5jdGlvbihpZCwgbm9jYXNoLCBkb2MpewoJCQkJaWQgPSBTbGljay5maW5kKGRvYywgJyMnICsgaWQucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKTsKCQkJCXJldHVybiAoaWQpID8gdHlwZXMuZWxlbWVudChpZCwgbm9jYXNoKSA6IG51bGw7CgkJCX0sCgoJCQllbGVtZW50OiBmdW5jdGlvbihlbCwgbm9jYXNoKXsKCQkJCVNsaWNrLnVpZE9mKGVsKTsKCQkJCWlmICghbm9jYXNoICYmICFlbC4kZmFtaWx5ICYmICEoL14oPzpvYmplY3R8ZW1iZWQpJC9pKS50ZXN0KGVsLnRhZ05hbWUpKXsKCQkJCQl2YXIgZmlyZUV2ZW50ID0gZWwuZmlyZUV2ZW50OwoJCQkJCS8vIHdyYXBwaW5nIG5lZWRlZCBpbiBJRTcsIG9yIGVsc2UgY3Jhc2gKCQkJCQllbC5fZmlyZUV2ZW50ID0gZnVuY3Rpb24odHlwZSwgZXZlbnQpewoJCQkJCQlyZXR1cm4gZmlyZUV2ZW50KHR5cGUsIGV2ZW50KTsKCQkJCQl9OwoJCQkJCU9iamVjdC5hcHBlbmQoZWwsIEVsZW1lbnQuUHJvdG90eXBlKTsKCQkJCX0KCQkJCXJldHVybiBlbDsKCQkJfSwKCgkJCW9iamVjdDogZnVuY3Rpb24ob2JqLCBub2Nhc2gsIGRvYyl7CgkJCQlpZiAob2JqLnRvRWxlbWVudCkgcmV0dXJuIHR5cGVzLmVsZW1lbnQob2JqLnRvRWxlbWVudChkb2MpLCBub2Nhc2gpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJfTsKCgkJdHlwZXMudGV4dG5vZGUgPSB0eXBlcy53aGl0ZXNwYWNlID0gdHlwZXMud2luZG93ID0gdHlwZXMuZG9jdW1lbnQgPSBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGVsLCBub2Nhc2gsIGRvYyl7CgkJCWlmIChlbCAmJiBlbC4kZmFtaWx5ICYmIGVsLnVuaXF1ZU51bWJlcikgcmV0dXJuIGVsOwoJCQl2YXIgdHlwZSA9IHR5cGVPZihlbCk7CgkJCXJldHVybiAodHlwZXNbdHlwZV0pID8gdHlwZXNbdHlwZV0oZWwsIG5vY2FzaCwgZG9jIHx8IGRvY3VtZW50KSA6IG51bGw7CgkJfTsKCgl9KSgpCgp9KTsKCmlmICh3aW5kb3cuJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJywgZnVuY3Rpb24oZWwsIG5jKXsKCXJldHVybiBkb2N1bWVudC5pZChlbCwgbmMsIHRoaXMuZG9jdW1lbnQpOwp9KTsKCldpbmRvdy5pbXBsZW1lbnQoewoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmRvY3VtZW50OwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCltEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgZXhwcmVzc2lvbiwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0RWxlbWVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgZXhwcmVzc2lvbikpOwoJfQoKfSk7Cgp2YXIgY29udGFpbnMgPSB7Y29udGFpbnM6IGZ1bmN0aW9uKGVsZW1lbnQpewoJcmV0dXJuIFNsaWNrLmNvbnRhaW5zKHRoaXMsIGVsZW1lbnQpOwp9fTsKCmlmICghZG9jdW1lbnQuY29udGFpbnMpIERvY3VtZW50LmltcGxlbWVudChjb250YWlucyk7CmlmICghZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykuY29udGFpbnMpIEVsZW1lbnQuaW1wbGVtZW50KGNvbnRhaW5zKTsKCgoKLy8gdHJlZSB3YWxraW5nCgp2YXIgaW5qZWN0Q29tYmluYXRvciA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGNvbWJpbmF0b3IpewoJaWYgKCFleHByZXNzaW9uKSByZXR1cm4gY29tYmluYXRvcjsKCglleHByZXNzaW9uID0gT2JqZWN0LmNsb25lKFNsaWNrLnBhcnNlKGV4cHJlc3Npb24pKTsKCgl2YXIgZXhwcmVzc2lvbnMgPSBleHByZXNzaW9uLmV4cHJlc3Npb25zOwoJZm9yICh2YXIgaSA9IGV4cHJlc3Npb25zLmxlbmd0aDsgaS0tOykKCQlleHByZXNzaW9uc1tpXVswXS5jb21iaW5hdG9yID0gY29tYmluYXRvcjsKCglyZXR1cm4gZXhwcmVzc2lvbjsKfTsKCk9iamVjdC5mb3JFYWNoKHsKCWdldE5leHQ6ICd+JywKCWdldFByZXZpb3VzOiAnIX4nLAoJZ2V0UGFyZW50OiAnIScKfSwgZnVuY3Rpb24oY29tYmluYXRvciwgbWV0aG9kKXsKCUVsZW1lbnQuaW1wbGVtZW50KG1ldGhvZCwgZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIHRoaXMuZ2V0RWxlbWVudChpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sIGNvbWJpbmF0b3IpKTsKCX0pOwp9KTsKCk9iamVjdC5mb3JFYWNoKHsKCWdldEFsbE5leHQ6ICd+JywKCWdldEFsbFByZXZpb3VzOiAnIX4nLAoJZ2V0U2libGluZ3M6ICd+ficsCglnZXRDaGlsZHJlbjogJz4nLAoJZ2V0UGFyZW50czogJyEnCn0sIGZ1bmN0aW9uKGNvbWJpbmF0b3IsIG1ldGhvZCl7CglFbGVtZW50LmltcGxlbWVudChtZXRob2QsIGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiB0aGlzLmdldEVsZW1lbnRzKGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgY29tYmluYXRvcikpOwoJfSk7Cn0pOwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWdldEZpcnN0OiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suc2VhcmNoKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJz4nKSlbMF0pOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suc2VhcmNoKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJz4nKSkuZ2V0TGFzdCgpKTsKCX0sCgoJZ2V0V2luZG93OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLm93bmVyRG9jdW1lbnQud2luZG93OwoJfSwKCglnZXREb2N1bWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50OwoJfSwKCglnZXRFbGVtZW50QnlJZDogZnVuY3Rpb24oaWQpewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsICcjJyArICgnJyArIGlkKS5yZXBsYWNlKC8oXFcpL2csICdcXCQxJykpKTsKCX0sCgoJbWF0Y2g6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiAhZXhwcmVzc2lvbiB8fCBTbGljay5tYXRjaCh0aGlzLCBleHByZXNzaW9uKTsKCX0KCn0pOwoKCgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CgkJaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBzZWxlY3RvciwgbmV3IEVsZW1lbnRzKTsKCQllbHNlIGlmIChUeXBlLmlzRW51bWVyYWJsZShzZWxlY3RvcikpIHJldHVybiBuZXcgRWxlbWVudHMoc2VsZWN0b3IpOwoJfQoJcmV0dXJuIG5ldyBFbGVtZW50cyhhcmd1bWVudHMpOwp9KTsKCi8vIEluc2VydGVycwoKdmFyIGluc2VydGVycyA9IHsKCgliZWZvcmU6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50Lm5leHRTaWJsaW5nKTsKCX0sCgoJYm90dG9tOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50LmFwcGVuZENoaWxkKGNvbnRleHQpOwoJfSwKCgl0b3A6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7Cgl9Cgp9OwoKaW5zZXJ0ZXJzLmluc2lkZSA9IGluc2VydGVycy5ib3R0b207CgoKCi8vIGdldFByb3BlcnR5IC8gc2V0UHJvcGVydHkKCnZhciBwcm9wZXJ0eUdldHRlcnMgPSB7fSwgcHJvcGVydHlTZXR0ZXJzID0ge307CgovLyBwcm9wZXJ0aWVzCgp2YXIgcHJvcGVydGllcyA9IHt9OwpBcnJheS5mb3JFYWNoKFsKCSd0eXBlJywgJ3ZhbHVlJywgJ2RlZmF1bHRWYWx1ZScsICdhY2Nlc3NLZXknLCAnY2VsbFBhZGRpbmcnLCAnY2VsbFNwYWNpbmcnLCAnY29sU3BhbicsCgknZnJhbWVCb3JkZXInLCAncm93U3BhbicsICd0YWJJbmRleCcsICd1c2VNYXAnCl0sIGZ1bmN0aW9uKHByb3BlcnR5KXsKCXByb3BlcnRpZXNbcHJvcGVydHkudG9Mb3dlckNhc2UoKV0gPSBwcm9wZXJ0eTsKfSk7Cgpwcm9wZXJ0aWVzLmh0bWwgPSAnaW5uZXJIVE1MJzsKcHJvcGVydGllcy50ZXh0ID0gKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLnRleHRDb250ZW50ID09IG51bGwpID8gJ2lubmVyVGV4dCc6ICd0ZXh0Q29udGVudCc7CgpPYmplY3QuZm9yRWFjaChwcm9wZXJ0aWVzLCBmdW5jdGlvbihyZWFsLCBrZXkpewoJcHJvcGVydHlTZXR0ZXJzW2tleV0gPSBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJbm9kZVtyZWFsXSA9IHZhbHVlOwoJfTsKCXByb3BlcnR5R2V0dGVyc1trZXldID0gZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGVbcmVhbF07Cgl9Owp9KTsKCi8vIEJvb2xlYW5zCgp2YXIgYm9vbHMgPSBbCgknY29tcGFjdCcsICdub3dyYXAnLCAnaXNtYXAnLCAnZGVjbGFyZScsICdub3NoYWRlJywgJ2NoZWNrZWQnLAoJJ2Rpc2FibGVkJywgJ3JlYWRPbmx5JywgJ211bHRpcGxlJywgJ3NlbGVjdGVkJywgJ25vcmVzaXplJywKCSdkZWZlcicsICdkZWZhdWx0Q2hlY2tlZCcsICdhdXRvZm9jdXMnLCAnY29udHJvbHMnLCAnYXV0b3BsYXknLAoJJ2xvb3AnCl07Cgp2YXIgYm9vbGVhbnMgPSB7fTsKQXJyYXkuZm9yRWFjaChib29scywgZnVuY3Rpb24oYm9vbCl7Cgl2YXIgbG93ZXIgPSBib29sLnRvTG93ZXJDYXNlKCk7Cglib29sZWFuc1tsb3dlcl0gPSBib29sOwoJcHJvcGVydHlTZXR0ZXJzW2xvd2VyXSA9IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQlub2RlW2Jvb2xdID0gISF2YWx1ZTsKCX07Cglwcm9wZXJ0eUdldHRlcnNbbG93ZXJdID0gZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuICEhbm9kZVtib29sXTsKCX07Cn0pOwoKLy8gU3BlY2lhbCBjYXNlcwoKT2JqZWN0LmFwcGVuZChwcm9wZXJ0eVNldHRlcnMsIHsKCgknY2xhc3MnOiBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJKCdjbGFzc05hbWUnIGluIG5vZGUpID8gbm9kZS5jbGFzc05hbWUgPSAodmFsdWUgfHwgJycpIDogbm9kZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdmFsdWUpOwoJfSwKCgknZm9yJzogZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCSgnaHRtbEZvcicgaW4gbm9kZSkgPyBub2RlLmh0bWxGb3IgPSB2YWx1ZSA6IG5vZGUuc2V0QXR0cmlidXRlKCdmb3InLCB2YWx1ZSk7Cgl9LAoKCSdzdHlsZSc6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQkobm9kZS5zdHlsZSkgPyBub2RlLnN0eWxlLmNzc1RleHQgPSB2YWx1ZSA6IG5vZGUuc2V0QXR0cmlidXRlKCdzdHlsZScsIHZhbHVlKTsKCX0sCgoJJ3ZhbHVlJzogZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCW5vZGUudmFsdWUgPSAodmFsdWUgIT0gbnVsbCkgPyB2YWx1ZSA6ICcnOwoJfQoKfSk7Cgpwcm9wZXJ0eUdldHRlcnNbJ2NsYXNzJ10gPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiAoJ2NsYXNzTmFtZScgaW4gbm9kZSkgPyBub2RlLmNsYXNzTmFtZSB8fCBudWxsIDogbm9kZS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJyk7Cn07CgovKiA8d2Via2l0PiAqLwp2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKTsKLy8gSUUgc2V0cyB0eXBlIGFzIHJlYWRvbmx5IGFuZCB0aHJvd3MKdHJ5IHsgZWwudHlwZSA9ICdidXR0b24nOyB9IGNhdGNoKGUpe30KaWYgKGVsLnR5cGUgIT0gJ2J1dHRvbicpIHByb3BlcnR5U2V0dGVycy50eXBlID0gZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJbm9kZS5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCB2YWx1ZSk7Cn07CmVsID0gbnVsbDsKLyogPC93ZWJraXQ+ICovCgovKjxJRT4qLwp2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOwppbnB1dC52YWx1ZSA9ICd0JzsKaW5wdXQudHlwZSA9ICdzdWJtaXQnOwppZiAoaW5wdXQudmFsdWUgIT0gJ3QnKSBwcm9wZXJ0eVNldHRlcnMudHlwZSA9IGZ1bmN0aW9uKG5vZGUsIHR5cGUpewoJdmFyIHZhbHVlID0gbm9kZS52YWx1ZTsKCW5vZGUudHlwZSA9IHR5cGU7Cglub2RlLnZhbHVlID0gdmFsdWU7Cn07CmlucHV0ID0gbnVsbDsKLyo8L0lFPiovCgovKiBnZXRQcm9wZXJ0eSwgc2V0UHJvcGVydHkgKi8KCi8qIDxsdElFOT4gKi8KdmFyIHBvbGx1dGVzR2V0QXR0cmlidXRlID0gKGZ1bmN0aW9uKGRpdil7CglkaXYucmFuZG9tID0gJ2F0dHJpYnV0ZSc7CglyZXR1cm4gKGRpdi5nZXRBdHRyaWJ1dGUoJ3JhbmRvbScpID09ICdhdHRyaWJ1dGUnKTsKfSkoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykpOwoKLyogPGx0SUU5PiAqLwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldFByb3BlcnR5OiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CgkJdmFyIHNldHRlciA9IHByb3BlcnR5U2V0dGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldOwoJCWlmIChzZXR0ZXIpewoJCQlzZXR0ZXIodGhpcywgdmFsdWUpOwoJCX0gZWxzZSB7CgkJCS8qIDxsdElFOT4gKi8KCQkJaWYgKHBvbGx1dGVzR2V0QXR0cmlidXRlKSB2YXIgYXR0cmlidXRlV2hpdGVMaXN0ID0gdGhpcy5yZXRyaWV2ZSgnJGF0dHJpYnV0ZVdoaXRlTGlzdCcsIHt9KTsKCQkJLyogPC9sdElFOT4gKi8KCgkJCWlmICh2YWx1ZSA9PSBudWxsKXsKCQkJCXRoaXMucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwoJCQkJLyogPGx0SUU5PiAqLwoJCQkJaWYgKHBvbGx1dGVzR2V0QXR0cmlidXRlKSBkZWxldGUgYXR0cmlidXRlV2hpdGVMaXN0W25hbWVdOwoJCQkJLyogPC9sdElFOT4gKi8KCQkJfSBlbHNlIHsKCQkJCXRoaXMuc2V0QXR0cmlidXRlKG5hbWUsICcnICsgdmFsdWUpOwoJCQkJLyogPGx0SUU5PiAqLwoJCQkJaWYgKHBvbGx1dGVzR2V0QXR0cmlidXRlKSBhdHRyaWJ1dGVXaGl0ZUxpc3RbbmFtZV0gPSB0cnVlOwoJCQkJLyogPC9sdElFOT4gKi8KCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJc2V0UHJvcGVydGllczogZnVuY3Rpb24oYXR0cmlidXRlcyl7CgkJZm9yICh2YXIgYXR0cmlidXRlIGluIGF0dHJpYnV0ZXMpIHRoaXMuc2V0UHJvcGVydHkoYXR0cmlidXRlLCBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRQcm9wZXJ0eTogZnVuY3Rpb24obmFtZSl7CgkJdmFyIGdldHRlciA9IHByb3BlcnR5R2V0dGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldOwoJCWlmIChnZXR0ZXIpIHJldHVybiBnZXR0ZXIodGhpcyk7CgkJLyogPGx0SUU5PiAqLwoJCWlmIChwb2xsdXRlc0dldEF0dHJpYnV0ZSl7CgkJCXZhciBhdHRyID0gdGhpcy5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpLCBhdHRyaWJ1dGVXaGl0ZUxpc3QgPSB0aGlzLnJldHJpZXZlKCckYXR0cmlidXRlV2hpdGVMaXN0Jywge30pOwoJCQlpZiAoIWF0dHIpIHJldHVybiBudWxsOwoJCQlpZiAoYXR0ci5leHBhbmRvICYmICFhdHRyaWJ1dGVXaGl0ZUxpc3RbbmFtZV0pewoJCQkJdmFyIG91dGVyID0gdGhpcy5vdXRlckhUTUw7CgkJCQkvLyBzZWdtZW50IGJ5IHRoZSBvcGVuaW5nIHRhZyBhbmQgZmluZCBtZW50aW9uIG9mIGF0dHJpYnV0ZSBuYW1lCgkJCQlpZiAob3V0ZXIuc3Vic3RyKDAsIG91dGVyLnNlYXJjaCgvXC8/WyciXT8+KD8hW148XSo8WyciXSkvKSkuaW5kZXhPZihuYW1lKSA8IDApIHJldHVybiBudWxsOwoJCQkJYXR0cmlidXRlV2hpdGVMaXN0W25hbWVdID0gdHJ1ZTsKCQkJfQoJCX0KCQkvKiA8L2x0SUU5PiAqLwoJCXZhciByZXN1bHQgPSBTbGljay5nZXRBdHRyaWJ1dGUodGhpcywgbmFtZSk7CgkJcmV0dXJuICghcmVzdWx0ICYmICFTbGljay5oYXNBdHRyaWJ1dGUodGhpcywgbmFtZSkpID8gbnVsbCA6IHJlc3VsdDsKCX0sCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKCQlyZXR1cm4gYXJncy5tYXAodGhpcy5nZXRQcm9wZXJ0eSwgdGhpcykuYXNzb2NpYXRlKGFyZ3MpOwoJfSwKCglyZW1vdmVQcm9wZXJ0eTogZnVuY3Rpb24obmFtZSl7CgkJcmV0dXJuIHRoaXMuc2V0UHJvcGVydHkobmFtZSwgbnVsbCk7Cgl9LAoKCXJlbW92ZVByb3BlcnRpZXM6IGZ1bmN0aW9uKCl7CgkJQXJyYXkuZWFjaChhcmd1bWVudHMsIHRoaXMucmVtb3ZlUHJvcGVydHksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXQ6IGZ1bmN0aW9uKHByb3AsIHZhbHVlKXsKCQl2YXIgcHJvcGVydHkgPSBFbGVtZW50LlByb3BlcnRpZXNbcHJvcF07CgkJKHByb3BlcnR5ICYmIHByb3BlcnR5LnNldCkgPyBwcm9wZXJ0eS5zZXQuY2FsbCh0aGlzLCB2YWx1ZSkgOiB0aGlzLnNldFByb3BlcnR5KHByb3AsIHZhbHVlKTsKCX0ub3ZlcmxvYWRTZXR0ZXIoKSwKCglnZXQ6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQlyZXR1cm4gKHByb3BlcnR5ICYmIHByb3BlcnR5LmdldCkgPyBwcm9wZXJ0eS5nZXQuYXBwbHkodGhpcykgOiB0aGlzLmdldFByb3BlcnR5KHByb3ApOwoJfS5vdmVybG9hZEdldHRlcigpLAoKCWVyYXNlOiBmdW5jdGlvbihwcm9wKXsKCQl2YXIgcHJvcGVydHkgPSBFbGVtZW50LlByb3BlcnRpZXNbcHJvcF07CgkJKHByb3BlcnR5ICYmIHByb3BlcnR5LmVyYXNlKSA/IHByb3BlcnR5LmVyYXNlLmFwcGx5KHRoaXMpIDogdGhpcy5yZW1vdmVQcm9wZXJ0eShwcm9wKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJcmV0dXJuIHRoaXMuY2xhc3NOYW1lLmNsZWFuKCkuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCglhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgdGhpcy5jbGFzc05hbWUgPSAodGhpcy5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWUpLmNsZWFuKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUucmVwbGFjZShuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGNsYXNzTmFtZSArICcoPzpcXHN8JCknKSwgJyQxJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUsIGZvcmNlKXsKCQlpZiAoZm9yY2UgPT0gbnVsbCkgZm9yY2UgPSAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpOwoJCXJldHVybiAoZm9yY2UpID8gdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwoJfSwKCglhZG9wdDogZnVuY3Rpb24oKXsKCQl2YXIgcGFyZW50ID0gdGhpcywgZnJhZ21lbnQsIGVsZW1lbnRzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLCBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgkJaWYgKGxlbmd0aCA+IDEpIHBhcmVudCA9IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50c1tpXSwgdHJ1ZSk7CgkJCWlmIChlbGVtZW50KSBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJfQoKCQlpZiAoZnJhZ21lbnQpIHRoaXMuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJYXBwZW5kVGV4dDogZnVuY3Rpb24odGV4dCwgd2hlcmUpewoJCXJldHVybiB0aGlzLmdyYWIodGhpcy5nZXREb2N1bWVudCgpLm5ld1RleHROb2RlKHRleHQpLCB3aGVyZSk7Cgl9LAoKCWdyYWI6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXShkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmplY3Q6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXSh0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWwpewoJCWVsID0gZG9jdW1lbnQuaWQoZWwsIHRydWUpOwoJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMsIGVsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcHM6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJcmV0dXJuIHRoaXMucmVwbGFjZXMoZWwpLmdyYWIoZWwsIHdoZXJlKTsKCX0sCgoJZ2V0U2VsZWN0ZWQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zZWxlY3RlZEluZGV4OyAvLyBTYWZhcmkgMy4yLjEKCQlyZXR1cm4gbmV3IEVsZW1lbnRzKEFycmF5LmZyb20odGhpcy5vcHRpb25zKS5maWx0ZXIoZnVuY3Rpb24ob3B0aW9uKXsKCQkJcmV0dXJuIG9wdGlvbi5zZWxlY3RlZDsKCQl9KSk7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKCl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgkJdGhpcy5nZXRFbGVtZW50cygnaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEnKS5lYWNoKGZ1bmN0aW9uKGVsKXsKCQkJdmFyIHR5cGUgPSBlbC50eXBlOwoJCQlpZiAoIWVsLm5hbWUgfHwgZWwuZGlzYWJsZWQgfHwgdHlwZSA9PSAnc3VibWl0JyB8fCB0eXBlID09ICdyZXNldCcgfHwgdHlwZSA9PSAnZmlsZScgfHwgdHlwZSA9PSAnaW1hZ2UnKSByZXR1cm47CgoJCQl2YXIgdmFsdWUgPSAoZWwuZ2V0KCd0YWcnKSA9PSAnc2VsZWN0JykgPyBlbC5nZXRTZWxlY3RlZCgpLm1hcChmdW5jdGlvbihvcHQpewoJCQkJLy8gSUUKCQkJCXJldHVybiBkb2N1bWVudC5pZChvcHQpLmdldCgndmFsdWUnKTsKCQkJfSkgOiAoKHR5cGUgPT0gJ3JhZGlvJyB8fCB0eXBlID09ICdjaGVja2JveCcpICYmICFlbC5jaGVja2VkKSA/IG51bGwgOiBlbC5nZXQoJ3ZhbHVlJyk7CgoJCQlBcnJheS5mcm9tKHZhbHVlKS5lYWNoKGZ1bmN0aW9uKHZhbCl7CgkJCQlpZiAodHlwZW9mIHZhbCAhPSAndW5kZWZpbmVkJykgcXVlcnlTdHJpbmcucHVzaChlbmNvZGVVUklDb21wb25lbnQoZWwubmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsKSk7CgkJCX0pOwoJCX0pOwoJCXJldHVybiBxdWVyeVN0cmluZy5qb2luKCcmJyk7Cgl9Cgp9KTsKCnZhciBjb2xsZWN0ZWQgPSB7fSwgc3RvcmFnZSA9IHt9OwoKdmFyIGdldCA9IGZ1bmN0aW9uKHVpZCl7CglyZXR1cm4gKHN0b3JhZ2VbdWlkXSB8fCAoc3RvcmFnZVt1aWRdID0ge30pKTsKfTsKCnZhciBjbGVhbiA9IGZ1bmN0aW9uKGl0ZW0pewoJdmFyIHVpZCA9IGl0ZW0udW5pcXVlTnVtYmVyOwoJaWYgKGl0ZW0ucmVtb3ZlRXZlbnRzKSBpdGVtLnJlbW92ZUV2ZW50cygpOwoJaWYgKGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKSBpdGVtLmNsZWFyQXR0cmlidXRlcygpOwoJaWYgKHVpZCAhPSBudWxsKXsKCQlkZWxldGUgY29sbGVjdGVkW3VpZF07CgkJZGVsZXRlIHN0b3JhZ2VbdWlkXTsKCX0KCXJldHVybiBpdGVtOwp9OwoKdmFyIGZvcm1Qcm9wcyA9IHtpbnB1dDogJ2NoZWNrZWQnLCBvcHRpb246ICdzZWxlY3RlZCcsIHRleHRhcmVhOiAndmFsdWUnfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglkZXN0cm95OiBmdW5jdGlvbigpewoJCXZhciBjaGlsZHJlbiA9IGNsZWFuKHRoaXMpLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJQXJyYXkuZWFjaChjaGlsZHJlbiwgY2xlYW4pOwoJCUVsZW1lbnQuZGlzcG9zZSh0aGlzKTsKCQlyZXR1cm4gbnVsbDsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJQXJyYXkuZnJvbSh0aGlzLmNoaWxkTm9kZXMpLmVhY2goRWxlbWVudC5kaXNwb3NlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMucGFyZW50Tm9kZSkgPyB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcykgOiB0aGlzOwoJfSwKCgljbG9uZTogZnVuY3Rpb24oY29udGVudHMsIGtlZXBpZCl7CgkJY29udGVudHMgPSBjb250ZW50cyAhPT0gZmFsc2U7CgkJdmFyIGNsb25lID0gdGhpcy5jbG9uZU5vZGUoY29udGVudHMpLCBjZSA9IFtjbG9uZV0sIHRlID0gW3RoaXNdLCBpOwoKCQlpZiAoY29udGVudHMpewoJCQljZS5hcHBlbmQoQXJyYXkuZnJvbShjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpKSk7CgkJCXRlLmFwcGVuZChBcnJheS5mcm9tKHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSkpOwoJCX0KCgkJZm9yIChpID0gY2UubGVuZ3RoOyBpLS07KXsKCQkJdmFyIG5vZGUgPSBjZVtpXSwgZWxlbWVudCA9IHRlW2ldOwoJCQlpZiAoIWtlZXBpZCkgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCS8qPGx0SUU5PiovCgkJCWlmIChub2RlLmNsZWFyQXR0cmlidXRlcyl7CgkJCQlub2RlLmNsZWFyQXR0cmlidXRlcygpOwoJCQkJbm9kZS5tZXJnZUF0dHJpYnV0ZXMoZWxlbWVudCk7CgkJCQlub2RlLnJlbW92ZUF0dHJpYnV0ZSgndW5pcXVlTnVtYmVyJyk7CgkJCQlpZiAobm9kZS5vcHRpb25zKXsKCQkJCQl2YXIgbm8gPSBub2RlLm9wdGlvbnMsIGVvID0gZWxlbWVudC5vcHRpb25zOwoJCQkJCWZvciAodmFyIGogPSBuby5sZW5ndGg7IGotLTspIG5vW2pdLnNlbGVjdGVkID0gZW9bal0uc2VsZWN0ZWQ7CgkJCQl9CgkJCX0KCQkJLyo8L2x0SUU5PiovCgkJCXZhciBwcm9wID0gZm9ybVByb3BzW2VsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpXTsKCQkJaWYgKHByb3AgJiYgZWxlbWVudFtwcm9wXSkgbm9kZVtwcm9wXSA9IGVsZW1lbnRbcHJvcF07CgkJfQoKCQkvKjxsdElFOT4qLwoJCWlmIChCcm93c2VyLmllKXsKCQkJdmFyIGNvID0gY2xvbmUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ29iamVjdCcpLCB0byA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ29iamVjdCcpOwoJCQlmb3IgKGkgPSBjby5sZW5ndGg7IGktLTspIGNvW2ldLm91dGVySFRNTCA9IHRvW2ldLm91dGVySFRNTDsKCQl9CgkJLyo8L2x0SUU5PiovCgkJcmV0dXJuIGRvY3VtZW50LmlkKGNsb25lKTsKCX0KCn0pOwoKW0VsZW1lbnQsIFdpbmRvdywgRG9jdW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWFkZExpc3RlbmVyOiBmdW5jdGlvbih0eXBlLCBmbil7CgkJaWYgKHR5cGUgPT0gJ3VubG9hZCcpewoJCQl2YXIgb2xkID0gZm4sIHNlbGYgPSB0aGlzOwoJCQlmbiA9IGZ1bmN0aW9uKCl7CgkJCQlzZWxmLnJlbW92ZUxpc3RlbmVyKCd1bmxvYWQnLCBmbik7CgkJCQlvbGQoKTsKCQkJfTsKCQl9IGVsc2UgewoJCQljb2xsZWN0ZWRbU2xpY2sudWlkT2YodGhpcyldID0gdGhpczsKCQl9CgkJaWYgKHRoaXMuYWRkRXZlbnRMaXN0ZW5lcikgdGhpcy5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZuLCAhIWFyZ3VtZW50c1syXSk7CgkJZWxzZSB0aGlzLmF0dGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUxpc3RlbmVyOiBmdW5jdGlvbih0eXBlLCBmbil7CgkJaWYgKHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcikgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGZuLCAhIWFyZ3VtZW50c1syXSk7CgkJZWxzZSB0aGlzLmRldGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJldHJpZXZlOiBmdW5jdGlvbihwcm9wZXJ0eSwgZGZsdCl7CgkJdmFyIHN0b3JhZ2UgPSBnZXQoU2xpY2sudWlkT2YodGhpcykpLCBwcm9wID0gc3RvcmFnZVtwcm9wZXJ0eV07CgkJaWYgKGRmbHQgIT0gbnVsbCAmJiBwcm9wID09IG51bGwpIHByb3AgPSBzdG9yYWdlW3Byb3BlcnR5XSA9IGRmbHQ7CgkJcmV0dXJuIHByb3AgIT0gbnVsbCA/IHByb3AgOiBudWxsOwoJfSwKCglzdG9yZTogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKCQl2YXIgc3RvcmFnZSA9IGdldChTbGljay51aWRPZih0aGlzKSk7CgkJc3RvcmFnZVtwcm9wZXJ0eV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZWxpbWluYXRlOiBmdW5jdGlvbihwcm9wZXJ0eSl7CgkJdmFyIHN0b3JhZ2UgPSBnZXQoU2xpY2sudWlkT2YodGhpcykpOwoJCWRlbGV0ZSBzdG9yYWdlW3Byb3BlcnR5XTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLyo8bHRJRTk+Ki8KaWYgKHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHdpbmRvdy5hZGRMaXN0ZW5lcigndW5sb2FkJywgZnVuY3Rpb24oKXsKCU9iamVjdC5lYWNoKGNvbGxlY3RlZCwgY2xlYW4pOwoJaWYgKHdpbmRvdy5Db2xsZWN0R2FyYmFnZSkgQ29sbGVjdEdhcmJhZ2UoKTsKfSk7Ci8qPC9sdElFOT4qLwoKRWxlbWVudC5Qcm9wZXJ0aWVzID0ge307CgoKCkVsZW1lbnQuUHJvcGVydGllcy5zdHlsZSA9IHsKCglzZXQ6IGZ1bmN0aW9uKHN0eWxlKXsKCQl0aGlzLnN0eWxlLmNzc1RleHQgPSBzdHlsZTsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnN0eWxlLmNzc1RleHQ7Cgl9LAoKCWVyYXNlOiBmdW5jdGlvbigpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9ICcnOwoJfQoKfTsKCkVsZW1lbnQuUHJvcGVydGllcy50YWcgPSB7CgoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCX0KCn07CgpFbGVtZW50LlByb3BlcnRpZXMuaHRtbCA9IHsKCglzZXQ6IGZ1bmN0aW9uKGh0bWwpewoJCWlmIChodG1sID09IG51bGwpIGh0bWwgPSAnJzsKCQllbHNlIGlmICh0eXBlT2YoaHRtbCkgPT0gJ2FycmF5JykgaHRtbCA9IGh0bWwuam9pbignJyk7CgkJdGhpcy5pbm5lckhUTUwgPSBodG1sOwoJfSwKCgllcmFzZTogZnVuY3Rpb24oKXsKCQl0aGlzLmlubmVySFRNTCA9ICcnOwoJfQoKfTsKCi8qPGx0SUU5PiovCi8vIHRlY2huaXF1ZSBieSBqZGJhcmxldHQgLSBodHRwOi8vamRiYXJ0bGV0dC5jb20vaW5uZXJzaGl2Lwp2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmRpdi5pbm5lckhUTUwgPSAnPG5hdj48L25hdj4nOwp2YXIgc3VwcG9ydHNIVE1MNUVsZW1lbnRzID0gKGRpdi5jaGlsZE5vZGVzLmxlbmd0aCA9PSAxKTsKaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpewoJdmFyIHRhZ3MgPSAnYWJiciBhcnRpY2xlIGFzaWRlIGF1ZGlvIGNhbnZhcyBkYXRhbGlzdCBkZXRhaWxzIGZpZ2NhcHRpb24gZmlndXJlIGZvb3RlciBoZWFkZXIgaGdyb3VwIG1hcmsgbWV0ZXIgbmF2IG91dHB1dCBwcm9ncmVzcyBzZWN0aW9uIHN1bW1hcnkgdGltZSB2aWRlbycuc3BsaXQoJyAnKSwKCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwgbCA9IHRhZ3MubGVuZ3RoOwoJd2hpbGUgKGwtLSkgZnJhZ21lbnQuY3JlYXRlRWxlbWVudCh0YWdzW2xdKTsKfQpkaXYgPSBudWxsOwovKjwvbHRJRTk+Ki8KCi8qPElFPiovCnZhciBzdXBwb3J0c1RhYmxlSW5uZXJIVE1MID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJdmFyIHRhYmxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGFibGUnKTsKCXRhYmxlLmlubmVySFRNTCA9ICc8dHI+PHRkPjwvdGQ+PC90cj4nOwoJcmV0dXJuIHRydWU7Cn0pOwoKLyo8bHRGRjQ+Ki8KdmFyIHRyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndHInKSwgaHRtbCA9ICc8dGQ+PC90ZD4nOwp0ci5pbm5lckhUTUwgPSBodG1sOwp2YXIgc3VwcG9ydHNUUklubmVySFRNTCA9ICh0ci5pbm5lckhUTUwgPT0gaHRtbCk7CnRyID0gbnVsbDsKLyo8L2x0RkY0PiovCgppZiAoIXN1cHBvcnRzVGFibGVJbm5lckhUTUwgfHwgIXN1cHBvcnRzVFJJbm5lckhUTUwgfHwgIXN1cHBvcnRzSFRNTDVFbGVtZW50cyl7CgoJRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwuc2V0ID0gKGZ1bmN0aW9uKHNldCl7CgoJCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJCXRhYmxlOiBbMSwgJzx0YWJsZT4nLCAnPC90YWJsZT4nXSwKCQkJc2VsZWN0OiBbMSwgJzxzZWxlY3Q+JywgJzwvc2VsZWN0PiddLAoJCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJCXRyOiBbMywgJzx0YWJsZT48dGJvZHk+PHRyPicsICc8L3RyPjwvdGJvZHk+PC90YWJsZT4nXQoJCX07CgoJCXRyYW5zbGF0aW9ucy50aGVhZCA9IHRyYW5zbGF0aW9ucy50Zm9vdCA9IHRyYW5zbGF0aW9ucy50Ym9keTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGh0bWwpewoJCQl2YXIgd3JhcCA9IHRyYW5zbGF0aW9uc1t0aGlzLmdldCgndGFnJyldOwoJCQlpZiAoIXdyYXAgJiYgIXN1cHBvcnRzSFRNTDVFbGVtZW50cykgd3JhcCA9IFswLCAnJywgJyddOwoJCQlpZiAoIXdyYXApIHJldHVybiBzZXQuY2FsbCh0aGlzLCBodG1sKTsKCgkJCXZhciBsZXZlbCA9IHdyYXBbMF0sIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgdGFyZ2V0ID0gd3JhcHBlcjsKCQkJaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpIGZyYWdtZW50LmFwcGVuZENoaWxkKHdyYXBwZXIpOwoJCQl3cmFwcGVyLmlubmVySFRNTCA9IFt3cmFwWzFdLCBodG1sLCB3cmFwWzJdXS5mbGF0dGVuKCkuam9pbignJyk7CgkJCXdoaWxlIChsZXZlbC0tKSB0YXJnZXQgPSB0YXJnZXQuZmlyc3RDaGlsZDsKCQkJdGhpcy5lbXB0eSgpLmFkb3B0KHRhcmdldC5jaGlsZE5vZGVzKTsKCQkJaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpIGZyYWdtZW50LnJlbW92ZUNoaWxkKHdyYXBwZXIpOwoJCQl3cmFwcGVyID0gbnVsbDsKCQl9OwoKCX0pKEVsZW1lbnQuUHJvcGVydGllcy5odG1sLnNldCk7Cn0KLyo8L0lFPiovCgovKjxsdElFOT4qLwp2YXIgdGVzdEZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdmb3JtJyk7CnRlc3RGb3JtLmlubmVySFRNTCA9ICc8c2VsZWN0PjxvcHRpb24+czwvb3B0aW9uPjwvc2VsZWN0Pic7CgppZiAodGVzdEZvcm0uZmlyc3RDaGlsZC52YWx1ZSAhPSAncycpIEVsZW1lbnQuUHJvcGVydGllcy52YWx1ZSA9IHsKCglzZXQ6IGZ1bmN0aW9uKHZhbHVlKXsKCQl2YXIgdGFnID0gdGhpcy5nZXQoJ3RhZycpOwoJCWlmICh0YWcgIT0gJ3NlbGVjdCcpIHJldHVybiB0aGlzLnNldFByb3BlcnR5KCd2YWx1ZScsIHZhbHVlKTsKCQl2YXIgb3B0aW9ucyA9IHRoaXMuZ2V0RWxlbWVudHMoJ29wdGlvbicpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKyl7CgkJCXZhciBvcHRpb24gPSBvcHRpb25zW2ldLAoJCQkJYXR0ciA9IG9wdGlvbi5nZXRBdHRyaWJ1dGVOb2RlKCd2YWx1ZScpLAoJCQkJb3B0aW9uVmFsdWUgPSAoYXR0ciAmJiBhdHRyLnNwZWNpZmllZCkgPyBvcHRpb24udmFsdWUgOiBvcHRpb24uZ2V0KCd0ZXh0Jyk7CgkJCWlmIChvcHRpb25WYWx1ZSA9PSB2YWx1ZSkgcmV0dXJuIG9wdGlvbi5zZWxlY3RlZCA9IHRydWU7CgkJfQoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbiA9IHRoaXMsIHRhZyA9IG9wdGlvbi5nZXQoJ3RhZycpOwoKCQlpZiAodGFnICE9ICdzZWxlY3QnICYmIHRhZyAhPSAnb3B0aW9uJykgcmV0dXJuIHRoaXMuZ2V0UHJvcGVydHkoJ3ZhbHVlJyk7CgoJCWlmICh0YWcgPT0gJ3NlbGVjdCcgJiYgIShvcHRpb24gPSBvcHRpb24uZ2V0U2VsZWN0ZWQoKVswXSkpIHJldHVybiAnJzsKCgkJdmFyIGF0dHIgPSBvcHRpb24uZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKTsKCQlyZXR1cm4gKGF0dHIgJiYgYXR0ci5zcGVjaWZpZWQpID8gb3B0aW9uLnZhbHVlIDogb3B0aW9uLmdldCgndGV4dCcpOwoJfQoKfTsKdGVzdEZvcm0gPSBudWxsOwovKjwvbHRJRTk+Ki8KCi8qPElFPiovCmlmIChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpKSBFbGVtZW50LlByb3BlcnRpZXMuaWQgPSB7CglzZXQ6IGZ1bmN0aW9uKGlkKXsKCQl0aGlzLmlkID0gdGhpcy5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpLnZhbHVlID0gaWQ7Cgl9LAoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmlkIHx8IG51bGw7Cgl9LAoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5pZCA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS52YWx1ZSA9ICcnOwoJfQp9OwovKjwvSUU+Ki8KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LlN0eWxlCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgbWV0aG9kcyBmb3IgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgc3R5bGVzIG9mIEVsZW1lbnRzIGluIGEgZmFzaGlvbmFibGUgd2F5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRWxlbWVudAoKcHJvdmlkZXM6IEVsZW1lbnQuU3R5bGUKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaHRtbCA9IGRvY3VtZW50Lmh0bWw7CgovLzxsdElFOT4KLy8gQ2hlY2sgZm9yIG9sZElFLCB3aGljaCBkb2VzIG5vdCByZW1vdmUgc3R5bGVzIHdoZW4gdGhleSdyZSBzZXQgdG8gbnVsbAp2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKZWwuc3R5bGUuY29sb3IgPSAncmVkJzsKZWwuc3R5bGUuY29sb3IgPSBudWxsOwp2YXIgZG9lc05vdFJlbW92ZVN0eWxlcyA9IGVsLnN0eWxlLmNvbG9yID09ICdyZWQnOwplbCA9IG51bGw7Ci8vPC9sdElFOT4KCkVsZW1lbnQuUHJvcGVydGllcy5zdHlsZXMgPSB7c2V0OiBmdW5jdGlvbihzdHlsZXMpewoJdGhpcy5zZXRTdHlsZXMoc3R5bGVzKTsKfX07Cgp2YXIgaGFzT3BhY2l0eSA9IChodG1sLnN0eWxlLm9wYWNpdHkgIT0gbnVsbCksCgloYXNGaWx0ZXIgPSAoaHRtbC5zdHlsZS5maWx0ZXIgIT0gbnVsbCksCglyZUFscGhhID0gL2FscGhhXChvcGFjaXR5PShbXGQuXSspXCkvaTsKCnZhciBzZXRWaXNpYmlsaXR5ID0gZnVuY3Rpb24oZWxlbWVudCwgb3BhY2l0eSl7CgllbGVtZW50LnN0b3JlKCckb3BhY2l0eScsIG9wYWNpdHkpOwoJZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gb3BhY2l0eSA+IDAgfHwgb3BhY2l0eSA9PSBudWxsID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7Cn07Cgp2YXIgc2V0T3BhY2l0eSA9IChoYXNPcGFjaXR5ID8gZnVuY3Rpb24oZWxlbWVudCwgb3BhY2l0eSl7CgllbGVtZW50LnN0eWxlLm9wYWNpdHkgPSBvcGFjaXR5Owp9IDogKGhhc0ZpbHRlciA/IGZ1bmN0aW9uKGVsZW1lbnQsIG9wYWNpdHkpewoJdmFyIHN0eWxlID0gZWxlbWVudC5zdHlsZTsKCWlmICghZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgIWVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkgc3R5bGUuem9vbSA9IDE7CglpZiAob3BhY2l0eSA9PSBudWxsIHx8IG9wYWNpdHkgPT0gMSkgb3BhY2l0eSA9ICcnOwoJZWxzZSBvcGFjaXR5ID0gJ2FscGhhKG9wYWNpdHk9JyArIChvcGFjaXR5ICogMTAwKS5saW1pdCgwLCAxMDApLnJvdW5kKCkgKyAnKSc7Cgl2YXIgZmlsdGVyID0gc3R5bGUuZmlsdGVyIHx8IGVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykgfHwgJyc7CglzdHlsZS5maWx0ZXIgPSByZUFscGhhLnRlc3QoZmlsdGVyKSA/IGZpbHRlci5yZXBsYWNlKHJlQWxwaGEsIG9wYWNpdHkpIDogZmlsdGVyICsgb3BhY2l0eTsKCWlmICghc3R5bGUuZmlsdGVyKSBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUoJ2ZpbHRlcicpOwp9IDogc2V0VmlzaWJpbGl0eSkpOwoKdmFyIGdldE9wYWNpdHkgPSAoaGFzT3BhY2l0eSA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIG9wYWNpdHkgPSBlbGVtZW50LnN0eWxlLm9wYWNpdHkgfHwgZWxlbWVudC5nZXRDb21wdXRlZFN0eWxlKCdvcGFjaXR5Jyk7CglyZXR1cm4gKG9wYWNpdHkgPT0gJycpID8gMSA6IG9wYWNpdHkudG9GbG9hdCgpOwp9IDogKGhhc0ZpbHRlciA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIGZpbHRlciA9IChlbGVtZW50LnN0eWxlLmZpbHRlciB8fCBlbGVtZW50LmdldENvbXB1dGVkU3R5bGUoJ2ZpbHRlcicpKSwKCQlvcGFjaXR5OwoJaWYgKGZpbHRlcikgb3BhY2l0eSA9IGZpbHRlci5tYXRjaChyZUFscGhhKTsKCXJldHVybiAob3BhY2l0eSA9PSBudWxsIHx8IGZpbHRlciA9PSBudWxsKSA/IDEgOiAob3BhY2l0eVsxXSAvIDEwMCk7Cn0gOiBmdW5jdGlvbihlbGVtZW50KXsKCXZhciBvcGFjaXR5ID0gZWxlbWVudC5yZXRyaWV2ZSgnJG9wYWNpdHknKTsKCWlmIChvcGFjaXR5ID09IG51bGwpIG9wYWNpdHkgPSAoZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID09ICdoaWRkZW4nID8gMCA6IDEpOwoJcmV0dXJuIG9wYWNpdHk7Cn0pKTsKCnZhciBmbG9hdE5hbWUgPSAoaHRtbC5zdHlsZS5jc3NGbG9hdCA9PSBudWxsKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgpFbGVtZW50LmltcGxlbWVudCh7CgoJZ2V0Q29tcHV0ZWRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmICh0aGlzLmN1cnJlbnRTdHlsZSkgcmV0dXJuIHRoaXMuY3VycmVudFN0eWxlW3Byb3BlcnR5LmNhbWVsQ2FzZSgpXTsKCQl2YXIgZGVmYXVsdFZpZXcgPSBFbGVtZW50LmdldERvY3VtZW50KHRoaXMpLmRlZmF1bHRWaWV3LAoJCQljb21wdXRlZCA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCBudWxsKSA6IG51bGw7CgkJcmV0dXJuIChjb21wdXRlZCkgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKChwcm9wZXJ0eSA9PSBmbG9hdE5hbWUpID8gJ2Zsb2F0JyA6IHByb3BlcnR5Lmh5cGhlbmF0ZSgpKSA6IG51bGw7Cgl9LAoKCXNldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCWlmIChwcm9wZXJ0eSA9PSAnb3BhY2l0eScpewoJCQlpZiAodmFsdWUgIT0gbnVsbCkgdmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKCQkJc2V0T3BhY2l0eSh0aGlzLCB2YWx1ZSk7CgkJCXJldHVybiB0aGlzOwoJCX0KCQlwcm9wZXJ0eSA9IChwcm9wZXJ0eSA9PSAnZmxvYXQnID8gZmxvYXROYW1lIDogcHJvcGVydHkpLmNhbWVsQ2FzZSgpOwoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdzdHJpbmcnKXsKCQkJdmFyIG1hcCA9IChFbGVtZW50LlN0eWxlc1twcm9wZXJ0eV0gfHwgJ0AnKS5zcGxpdCgnICcpOwoJCQl2YWx1ZSA9IEFycmF5LmZyb20odmFsdWUpLm1hcChmdW5jdGlvbih2YWwsIGkpewoJCQkJaWYgKCFtYXBbaV0pIHJldHVybiAnJzsKCQkJCXJldHVybiAodHlwZU9mKHZhbCkgPT0gJ251bWJlcicpID8gbWFwW2ldLnJlcGxhY2UoJ0AnLCBNYXRoLnJvdW5kKHZhbCkpIDogdmFsOwoJCQl9KS5qb2luKCcgJyk7CgkJfSBlbHNlIGlmICh2YWx1ZSA9PSBTdHJpbmcoTnVtYmVyKHZhbHVlKSkpewoJCQl2YWx1ZSA9IE1hdGgucm91bmQodmFsdWUpOwoJCX0KCQl0aGlzLnN0eWxlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCS8vPGx0SUU5PgoJCWlmICgodmFsdWUgPT0gJycgfHwgdmFsdWUgPT0gbnVsbCkgJiYgZG9lc05vdFJlbW92ZVN0eWxlcyAmJiB0aGlzLnN0eWxlLnJlbW92ZUF0dHJpYnV0ZSl7CgkJCXRoaXMuc3R5bGUucmVtb3ZlQXR0cmlidXRlKHByb3BlcnR5KTsKCQl9CgkJLy88L2x0SUU5PgoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmIChwcm9wZXJ0eSA9PSAnb3BhY2l0eScpIHJldHVybiBnZXRPcGFjaXR5KHRoaXMpOwoJCXByb3BlcnR5ID0gKHByb3BlcnR5ID09ICdmbG9hdCcgPyBmbG9hdE5hbWUgOiBwcm9wZXJ0eSkuY2FtZWxDYXNlKCk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuc3R5bGVbcHJvcGVydHldOwoJCWlmICghcmVzdWx0IHx8IHByb3BlcnR5ID09ICd6SW5kZXgnKXsKCQkJcmVzdWx0ID0gW107CgkJCWZvciAodmFyIHN0eWxlIGluIEVsZW1lbnQuU2hvcnRTdHlsZXMpewoJCQkJaWYgKHByb3BlcnR5ICE9IHN0eWxlKSBjb250aW51ZTsKCQkJCWZvciAodmFyIHMgaW4gRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJlc3VsdC5wdXNoKHRoaXMuZ2V0U3R5bGUocykpOwoJCQkJcmV0dXJuIHJlc3VsdC5qb2luKCcgJyk7CgkJCX0KCQkJcmVzdWx0ID0gdGhpcy5nZXRDb21wdXRlZFN0eWxlKHByb3BlcnR5KTsKCQl9CgkJaWYgKHJlc3VsdCl7CgkJCXJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwoJCQl2YXIgY29sb3IgPSByZXN1bHQubWF0Y2goL3JnYmE/XChbXGRccyxdK1wpLyk7CgkJCWlmIChjb2xvcikgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoY29sb3JbMF0sIGNvbG9yWzBdLnJnYlRvSGV4KCkpOwoJCX0KCQlpZiAoQnJvd3Nlci5pZSAmJiBpc05hTihwYXJzZUZsb2F0KHJlc3VsdCkpKXsKCQkJaWYgKCgvXihoZWlnaHR8d2lkdGgpJC8pLnRlc3QocHJvcGVydHkpKXsKCQkJCXZhciB2YWx1ZXMgPSAocHJvcGVydHkgPT0gJ3dpZHRoJykgPyBbJ2xlZnQnLCAncmlnaHQnXSA6IFsndG9wJywgJ2JvdHRvbSddLCBzaXplID0gMDsKCQkJCXZhbHVlcy5lYWNoKGZ1bmN0aW9uKHZhbHVlKXsKCQkJCQlzaXplICs9IHRoaXMuZ2V0U3R5bGUoJ2JvcmRlci0nICsgdmFsdWUgKyAnLXdpZHRoJykudG9JbnQoKSArIHRoaXMuZ2V0U3R5bGUoJ3BhZGRpbmctJyArIHZhbHVlKS50b0ludCgpOwoJCQkJfSwgdGhpcyk7CgkJCQlyZXR1cm4gdGhpc1snb2Zmc2V0JyArIHByb3BlcnR5LmNhcGl0YWxpemUoKV0gLSBzaXplICsgJ3B4JzsKCQkJfQoJCQlpZiAoQnJvd3Nlci5vcGVyYSAmJiBTdHJpbmcocmVzdWx0KS5pbmRleE9mKCdweCcpICE9IC0xKSByZXR1cm4gcmVzdWx0OwoJCQlpZiAoKC9eYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykudGVzdChwcm9wZXJ0eSkpIHJldHVybiAnMHB4JzsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewoJCWZvciAodmFyIHN0eWxlIGluIHN0eWxlcykgdGhpcy5zZXRTdHlsZShzdHlsZSwgc3R5bGVzW3N0eWxlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0ID0ge307CgkJQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLmVhY2goZnVuY3Rpb24oa2V5KXsKCQkJcmVzdWx0W2tleV0gPSB0aGlzLmdldFN0eWxlKGtleSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCn0pOwoKRWxlbWVudC5TdHlsZXMgPSB7CglsZWZ0OiAnQHB4JywgdG9wOiAnQHB4JywgYm90dG9tOiAnQHB4JywgcmlnaHQ6ICdAcHgnLAoJd2lkdGg6ICdAcHgnLCBoZWlnaHQ6ICdAcHgnLCBtYXhXaWR0aDogJ0BweCcsIG1heEhlaWdodDogJ0BweCcsIG1pbldpZHRoOiAnQHB4JywgbWluSGVpZ2h0OiAnQHB4JywKCWJhY2tncm91bmRDb2xvcjogJ3JnYihALCBALCBAKScsIGJhY2tncm91bmRQb3NpdGlvbjogJ0BweCBAcHgnLCBjb2xvcjogJ3JnYihALCBALCBAKScsCglmb250U2l6ZTogJ0BweCcsIGxldHRlclNwYWNpbmc6ICdAcHgnLCBsaW5lSGVpZ2h0OiAnQHB4JywgY2xpcDogJ3JlY3QoQHB4IEBweCBAcHggQHB4KScsCgltYXJnaW46ICdAcHggQHB4IEBweCBAcHgnLCBwYWRkaW5nOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyOiAnQHB4IEAgcmdiKEAsIEAsIEApIEBweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCknLAoJYm9yZGVyV2lkdGg6ICdAcHggQHB4IEBweCBAcHgnLCBib3JkZXJTdHlsZTogJ0AgQCBAIEAnLCBib3JkZXJDb2xvcjogJ3JnYihALCBALCBAKSByZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKScsCgl6SW5kZXg6ICdAJywgJ3pvb20nOiAnQCcsIGZvbnRXZWlnaHQ6ICdAJywgdGV4dEluZGVudDogJ0BweCcsIG9wYWNpdHk6ICdAJwp9OwoKCgoKCkVsZW1lbnQuU2hvcnRTdHlsZXMgPSB7bWFyZ2luOiB7fSwgcGFkZGluZzoge30sIGJvcmRlcjoge30sIGJvcmRlcldpZHRoOiB7fSwgYm9yZGVyU3R5bGU6IHt9LCBib3JkZXJDb2xvcjoge319OwoKWydUb3AnLCAnUmlnaHQnLCAnQm90dG9tJywgJ0xlZnQnXS5lYWNoKGZ1bmN0aW9uKGRpcmVjdGlvbil7Cgl2YXIgU2hvcnQgPSBFbGVtZW50LlNob3J0U3R5bGVzOwoJdmFyIEFsbCA9IEVsZW1lbnQuU3R5bGVzOwoJWydtYXJnaW4nLCAncGFkZGluZyddLmVhY2goZnVuY3Rpb24oc3R5bGUpewoJCXZhciBzZCA9IHN0eWxlICsgZGlyZWN0aW9uOwoJCVNob3J0W3N0eWxlXVtzZF0gPSBBbGxbc2RdID0gJ0BweCc7Cgl9KTsKCXZhciBiZCA9ICdib3JkZXInICsgZGlyZWN0aW9uOwoJU2hvcnQuYm9yZGVyW2JkXSA9IEFsbFtiZF0gPSAnQHB4IEAgcmdiKEAsIEAsIEApJzsKCXZhciBiZHcgPSBiZCArICdXaWR0aCcsIGJkcyA9IGJkICsgJ1N0eWxlJywgYmRjID0gYmQgKyAnQ29sb3InOwoJU2hvcnRbYmRdID0ge307CglTaG9ydC5ib3JkZXJXaWR0aFtiZHddID0gU2hvcnRbYmRdW2Jkd10gPSBBbGxbYmR3XSA9ICdAcHgnOwoJU2hvcnQuYm9yZGVyU3R5bGVbYmRzXSA9IFNob3J0W2JkXVtiZHNdID0gQWxsW2Jkc10gPSAnQCc7CglTaG9ydC5ib3JkZXJDb2xvcltiZGNdID0gU2hvcnRbYmRdW2JkY10gPSBBbGxbYmRjXSA9ICdyZ2IoQCwgQCwgQCknOwp9KTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRWxlbWVudCBtZXRob2RzIGZvciBkZWFsaW5nIHdpdGggZXZlbnRzLiBUaGlzIGZpbGUgYWxzbyBpbmNsdWRlcyBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlIGN1c3RvbSBFbGVtZW50IEV2ZW50cywgaWYgbmVjZXNzYXJ5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQsIEV2ZW50XQoKcHJvdmlkZXM6IEVsZW1lbnQuRXZlbnQKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7CgpFbGVtZW50LlByb3BlcnRpZXMuZXZlbnRzID0ge3NldDogZnVuY3Rpb24oZXZlbnRzKXsKCXRoaXMuYWRkRXZlbnRzKGV2ZW50cyk7Cn19OwoKW0VsZW1lbnQsIFdpbmRvdywgRG9jdW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycsIHt9KTsKCQlpZiAoIWV2ZW50c1t0eXBlXSkgZXZlbnRzW3R5cGVdID0ge2tleXM6IFtdLCB2YWx1ZXM6IFtdfTsKCQlpZiAoZXZlbnRzW3R5cGVdLmtleXMuY29udGFpbnMoZm4pKSByZXR1cm4gdGhpczsKCQlldmVudHNbdHlwZV0ua2V5cy5wdXNoKGZuKTsKCQl2YXIgcmVhbFR5cGUgPSB0eXBlLAoJCQljdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXSwKCQkJY29uZGl0aW9uID0gZm4sCgkJCXNlbGYgPSB0aGlzOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLm9uQWRkKSBjdXN0b20ub25BZGQuY2FsbCh0aGlzLCBmbiwgdHlwZSk7CgkJCWlmIChjdXN0b20uY29uZGl0aW9uKXsKCQkJCWNvbmRpdGlvbiA9IGZ1bmN0aW9uKGV2ZW50KXsKCQkJCQlpZiAoY3VzdG9tLmNvbmRpdGlvbi5jYWxsKHRoaXMsIGV2ZW50LCB0eXBlKSkgcmV0dXJuIGZuLmNhbGwodGhpcywgZXZlbnQpOwoJCQkJCXJldHVybiB0cnVlOwoJCQkJfTsKCQkJfQoJCQlpZiAoY3VzdG9tLmJhc2UpIHJlYWxUeXBlID0gRnVuY3Rpb24uZnJvbShjdXN0b20uYmFzZSkuY2FsbCh0aGlzLCB0eXBlKTsKCQl9CgkJdmFyIGRlZm4gPSBmdW5jdGlvbigpewoJCQlyZXR1cm4gZm4uY2FsbChzZWxmKTsKCQl9OwoJCXZhciBuYXRpdmVFdmVudCA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzW3JlYWxUeXBlXTsKCQlpZiAobmF0aXZlRXZlbnQpewoJCQlpZiAobmF0aXZlRXZlbnQgPT0gMil7CgkJCQlkZWZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWV2ZW50ID0gbmV3IERPTUV2ZW50KGV2ZW50LCBzZWxmLmdldFdpbmRvdygpKTsKCQkJCQlpZiAoY29uZGl0aW9uLmNhbGwoc2VsZiwgZXZlbnQpID09PSBmYWxzZSkgZXZlbnQuc3RvcCgpOwoJCQkJfTsKCQkJfQoJCQl0aGlzLmFkZExpc3RlbmVyKHJlYWxUeXBlLCBkZWZuLCBhcmd1bWVudHNbMl0pOwoJCX0KCQlldmVudHNbdHlwZV0udmFsdWVzLnB1c2goZGVmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzIHx8ICFldmVudHNbdHlwZV0pIHJldHVybiB0aGlzOwoJCXZhciBsaXN0ID0gZXZlbnRzW3R5cGVdOwoJCXZhciBpbmRleCA9IGxpc3Qua2V5cy5pbmRleE9mKGZuKTsKCQlpZiAoaW5kZXggPT0gLTEpIHJldHVybiB0aGlzOwoJCXZhciB2YWx1ZSA9IGxpc3QudmFsdWVzW2luZGV4XTsKCQlkZWxldGUgbGlzdC5rZXlzW2luZGV4XTsKCQlkZWxldGUgbGlzdC52YWx1ZXNbaW5kZXhdOwoJCXZhciBjdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXTsKCQlpZiAoY3VzdG9tKXsKCQkJaWYgKGN1c3RvbS5vblJlbW92ZSkgY3VzdG9tLm9uUmVtb3ZlLmNhbGwodGhpcywgZm4sIHR5cGUpOwoJCQlpZiAoY3VzdG9tLmJhc2UpIHR5cGUgPSBGdW5jdGlvbi5mcm9tKGN1c3RvbS5iYXNlKS5jYWxsKHRoaXMsIHR5cGUpOwoJCX0KCQlyZXR1cm4gKEVsZW1lbnQuTmF0aXZlRXZlbnRzW3R5cGVdKSA/IHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgdmFsdWUsIGFyZ3VtZW50c1syXSkgOiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KGV2ZW50LCBldmVudHNbZXZlbnRdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXZhciBhdHRhY2hlZCA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghYXR0YWNoZWQpIHJldHVybiB0aGlzOwoJCWlmICghZXZlbnRzKXsKCQkJZm9yICh0eXBlIGluIGF0dGFjaGVkKSB0aGlzLnJlbW92ZUV2ZW50cyh0eXBlKTsKCQkJdGhpcy5lbGltaW5hdGUoJ2V2ZW50cycpOwoJCX0gZWxzZSBpZiAoYXR0YWNoZWRbZXZlbnRzXSl7CgkJCWF0dGFjaGVkW2V2ZW50c10ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQoZXZlbnRzLCBmbik7CgkJCX0sIHRoaXMpOwoJCQlkZWxldGUgYXR0YWNoZWRbZXZlbnRzXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCgkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZUV2ZW50czogZnVuY3Rpb24oZnJvbSwgdHlwZSl7CgkJZnJvbSA9IGRvY3VtZW50LmlkKGZyb20pOwoJCXZhciBldmVudHMgPSBmcm9tLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJaWYgKCF0eXBlKXsKCQkJZm9yICh2YXIgZXZlbnRUeXBlIGluIGV2ZW50cykgdGhpcy5jbG9uZUV2ZW50cyhmcm9tLCBldmVudFR5cGUpOwoJCX0gZWxzZSBpZiAoZXZlbnRzW3R5cGVdKXsKCQkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLmFkZEV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpFbGVtZW50Lk5hdGl2ZUV2ZW50cyA9IHsKCWNsaWNrOiAyLCBkYmxjbGljazogMiwgbW91c2V1cDogMiwgbW91c2Vkb3duOiAyLCBjb250ZXh0bWVudTogMiwgLy9tb3VzZSBidXR0b25zCgltb3VzZXdoZWVsOiAyLCBET01Nb3VzZVNjcm9sbDogMiwgLy9tb3VzZSB3aGVlbAoJbW91c2VvdmVyOiAyLCBtb3VzZW91dDogMiwgbW91c2Vtb3ZlOiAyLCBzZWxlY3RzdGFydDogMiwgc2VsZWN0ZW5kOiAyLCAvL21vdXNlIG1vdmVtZW50CglrZXlkb3duOiAyLCBrZXlwcmVzczogMiwga2V5dXA6IDIsIC8va2V5Ym9hcmQKCW9yaWVudGF0aW9uY2hhbmdlOiAyLCAvLyBtb2JpbGUKCXRvdWNoc3RhcnQ6IDIsIHRvdWNobW92ZTogMiwgdG91Y2hlbmQ6IDIsIHRvdWNoY2FuY2VsOiAyLCAvLyB0b3VjaAoJZ2VzdHVyZXN0YXJ0OiAyLCBnZXN0dXJlY2hhbmdlOiAyLCBnZXN0dXJlZW5kOiAyLCAvLyBnZXN0dXJlCglmb2N1czogMiwgYmx1cjogMiwgY2hhbmdlOiAyLCByZXNldDogMiwgc2VsZWN0OiAyLCBzdWJtaXQ6IDIsIHBhc3RlOiAyLCBpbnB1dDogMiwgLy9mb3JtIGVsZW1lbnRzCglsb2FkOiAyLCB1bmxvYWQ6IDEsIGJlZm9yZXVubG9hZDogMiwgcmVzaXplOiAxLCBtb3ZlOiAxLCBET01Db250ZW50TG9hZGVkOiAxLCByZWFkeXN0YXRlY2hhbmdlOiAxLCAvL3dpbmRvdwoJZXJyb3I6IDEsIGFib3J0OiAxLCBzY3JvbGw6IDEgLy9taXNjCn07CgpFbGVtZW50LkV2ZW50cyA9IHttb3VzZXdoZWVsOiB7CgliYXNlOiAoQnJvd3Nlci5maXJlZm94KSA/ICdET01Nb3VzZVNjcm9sbCcgOiAnbW91c2V3aGVlbCcKfX07CgppZiAoJ29ubW91c2VlbnRlcicgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KXsKCUVsZW1lbnQuTmF0aXZlRXZlbnRzLm1vdXNlZW50ZXIgPSBFbGVtZW50Lk5hdGl2ZUV2ZW50cy5tb3VzZWxlYXZlID0gMjsKfSBlbHNlIHsKCXZhciBjaGVjayA9IGZ1bmN0aW9uKGV2ZW50KXsKCQl2YXIgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CgkJaWYgKHJlbGF0ZWQgPT0gbnVsbCkgcmV0dXJuIHRydWU7CgkJaWYgKCFyZWxhdGVkKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIChyZWxhdGVkICE9IHRoaXMgJiYgcmVsYXRlZC5wcmVmaXggIT0gJ3h1bCcgJiYgdHlwZU9mKHRoaXMpICE9ICdkb2N1bWVudCcgJiYgIXRoaXMuY29udGFpbnMocmVsYXRlZCkpOwoJfTsKCglFbGVtZW50LkV2ZW50cy5tb3VzZWVudGVyID0gewoJCWJhc2U6ICdtb3VzZW92ZXInLAoJCWNvbmRpdGlvbjogY2hlY2sKCX07CgoJRWxlbWVudC5FdmVudHMubW91c2VsZWF2ZSA9IHsKCQliYXNlOiAnbW91c2VvdXQnLAoJCWNvbmRpdGlvbjogY2hlY2sKCX07Cn0KCi8qPGx0SUU5PiovCmlmICghd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpewoJRWxlbWVudC5OYXRpdmVFdmVudHMucHJvcGVydHljaGFuZ2UgPSAyOwoJRWxlbWVudC5FdmVudHMuY2hhbmdlID0gewoJCWJhc2U6IGZ1bmN0aW9uKCl7CgkJCXZhciB0eXBlID0gdGhpcy50eXBlOwoJCQlyZXR1cm4gKHRoaXMuZ2V0KCd0YWcnKSA9PSAnaW5wdXQnICYmICh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSkgPyAncHJvcGVydHljaGFuZ2UnIDogJ2NoYW5nZScKCQl9LAoJCWNvbmRpdGlvbjogZnVuY3Rpb24oZXZlbnQpewoJCQlyZXR1cm4gdGhpcy50eXBlICE9ICdyYWRpbycgfHwgKGV2ZW50LmV2ZW50LnByb3BlcnR5TmFtZSA9PSAnY2hlY2tlZCcgJiYgdGhpcy5jaGVja2VkKTsKCQl9Cgl9Cn0KLyo8L2x0SUU5PiovCgoKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkRlbGVnYXRpb24KCmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBFbGVtZW50IG5hdGl2ZSBvYmplY3QgdG8gaW5jbHVkZSB0aGUgZGVsZWdhdGUgbWV0aG9kIGZvciBtb3JlIGVmZmljaWVudCBldmVudCBtYW5hZ2VtZW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0VsZW1lbnQuRGVsZWdhdGlvbl0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZXZlbnRMaXN0ZW5lclN1cHBvcnQgPSAhIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyOwoKRWxlbWVudC5OYXRpdmVFdmVudHMuZm9jdXNpbiA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzLmZvY3Vzb3V0ID0gMjsKCnZhciBidWJibGVVcCA9IGZ1bmN0aW9uKHNlbGYsIG1hdGNoLCBmbiwgZXZlbnQsIHRhcmdldCl7Cgl3aGlsZSAodGFyZ2V0ICYmIHRhcmdldCAhPSBzZWxmKXsKCQlpZiAobWF0Y2godGFyZ2V0LCBldmVudCkpIHJldHVybiBmbi5jYWxsKHRhcmdldCwgZXZlbnQsIHRhcmdldCk7CgkJdGFyZ2V0ID0gZG9jdW1lbnQuaWQodGFyZ2V0LnBhcmVudE5vZGUpOwoJfQp9OwoKdmFyIG1hcCA9IHsKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJwoJfSwKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnCgl9LAoJZm9jdXM6IHsKCQliYXNlOiAnZm9jdXMnICsgKGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJycgOiAnaW4nKSwKCQljYXB0dXJlOiB0cnVlCgl9LAoJYmx1cjogewoJCWJhc2U6IGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJ2JsdXInIDogJ2ZvY3Vzb3V0JywKCQljYXB0dXJlOiB0cnVlCgl9Cn07CgovKjxsdElFOT4qLwp2YXIgX2tleSA9ICckZGVsZWdhdGlvbjonOwp2YXIgZm9ybU9ic2VydmVyID0gZnVuY3Rpb24odHlwZSl7CgoJcmV0dXJuIHsKCgkJYmFzZTogJ2ZvY3VzaW4nLAoKCQlyZW1vdmU6IGZ1bmN0aW9uKHNlbGYsIHVpZCl7CgkJCXZhciBsaXN0ID0gc2VsZi5yZXRyaWV2ZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCB7fSlbdWlkXTsKCQkJaWYgKGxpc3QgJiYgbGlzdC5mb3JtcykgZm9yICh2YXIgaSA9IGxpc3QuZm9ybXMubGVuZ3RoOyBpLS07KXsKCQkJCWxpc3QuZm9ybXNbaV0ucmVtb3ZlRXZlbnQodHlwZSwgbGlzdC5mbnNbaV0pOwoJCQl9CgkJfSwKCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCl7CgkJCXZhciBmb3JtID0gKHRhcmdldC5nZXQoJ3RhZycpID09ICdmb3JtJykgPyB0YXJnZXQgOiBldmVudC50YXJnZXQuZ2V0UGFyZW50KCdmb3JtJyk7CgkJCWlmICghZm9ybSkgcmV0dXJuOwoKCQkJdmFyIGxpc3RlbmVycyA9IHNlbGYucmV0cmlldmUoX2tleSArIHR5cGUgKyAnbGlzdGVuZXJzJywge30pLAoJCQkJbGlzdGVuZXIgPSBsaXN0ZW5lcnNbdWlkXSB8fCB7Zm9ybXM6IFtdLCBmbnM6IFtdfSwKCQkJCWZvcm1zID0gbGlzdGVuZXIuZm9ybXMsIGZucyA9IGxpc3RlbmVyLmZuczsKCgkJCWlmIChmb3Jtcy5pbmRleE9mKGZvcm0pICE9IC0xKSByZXR1cm47CgkJCWZvcm1zLnB1c2goZm9ybSk7CgoJCQl2YXIgX2ZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZm9ybS5hZGRFdmVudCh0eXBlLCBfZm4pOwoJCQlmbnMucHVzaChfZm4pOwoKCQkJbGlzdGVuZXJzW3VpZF0gPSBsaXN0ZW5lcjsKCQkJc2VsZi5zdG9yZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCBsaXN0ZW5lcnMpOwoJCX0KCX07Cn07Cgp2YXIgaW5wdXRPYnNlcnZlciA9IGZ1bmN0aW9uKHR5cGUpewoJcmV0dXJuIHsKCQliYXNlOiAnZm9jdXNpbicsCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQpewoJCQl2YXIgZXZlbnRzID0ge2JsdXI6IGZ1bmN0aW9uKCl7CgkJCQl0aGlzLnJlbW92ZUV2ZW50cyhldmVudHMpOwoJCQl9fTsKCQkJZXZlbnRzW3R5cGVdID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZXZlbnQudGFyZ2V0LmFkZEV2ZW50cyhldmVudHMpOwoJCX0KCX07Cn07CgppZiAoIWV2ZW50TGlzdGVuZXJTdXBwb3J0KSBPYmplY3QuYXBwZW5kKG1hcCwgewoJc3VibWl0OiBmb3JtT2JzZXJ2ZXIoJ3N1Ym1pdCcpLAoJcmVzZXQ6IGZvcm1PYnNlcnZlcigncmVzZXQnKSwKCWNoYW5nZTogaW5wdXRPYnNlcnZlcignY2hhbmdlJyksCglzZWxlY3Q6IGlucHV0T2JzZXJ2ZXIoJ3NlbGVjdCcpCn0pOwovKjwvbHRJRTk+Ki8KCnZhciBwcm90byA9IEVsZW1lbnQucHJvdG90eXBlLAoJYWRkRXZlbnQgPSBwcm90by5hZGRFdmVudCwKCXJlbW92ZUV2ZW50ID0gcHJvdG8ucmVtb3ZlRXZlbnQ7Cgp2YXIgcmVsYXkgPSBmdW5jdGlvbihvbGQsIG1ldGhvZCl7CglyZXR1cm4gZnVuY3Rpb24odHlwZSwgZm4sIHVzZUNhcHR1cmUpewoJCWlmICh0eXBlLmluZGV4T2YoJzpyZWxheScpID09IC0xKSByZXR1cm4gb2xkLmNhbGwodGhpcywgdHlwZSwgZm4sIHVzZUNhcHR1cmUpOwoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0eXBlKS5leHByZXNzaW9uc1swXVswXTsKCQlpZiAocGFyc2VkLnBzZXVkb3NbMF0ua2V5ICE9ICdyZWxheScpIHJldHVybiBvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbiwgdXNlQ2FwdHVyZSk7CgkJdmFyIG5ld1R5cGUgPSBwYXJzZWQudGFnOwoJCXBhcnNlZC5wc2V1ZG9zLnNsaWNlKDEpLmVhY2goZnVuY3Rpb24ocHNldWRvKXsKCQkJbmV3VHlwZSArPSAnOicgKyBwc2V1ZG8ua2V5ICsgKHBzZXVkby52YWx1ZSA/ICcoJyArIHBzZXVkby52YWx1ZSArICcpJyA6ICcnKTsKCQl9KTsKCQlvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbik7CgkJcmV0dXJuIG1ldGhvZC5jYWxsKHRoaXMsIG5ld1R5cGUsIHBhcnNlZC5wc2V1ZG9zWzBdLnZhbHVlLCBmbik7Cgl9Owp9OwoKdmFyIGRlbGVnYXRpb24gPSB7CgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIG1hdGNoLCBmbil7CgkJdmFyIHN0b3JhZ2UgPSB0aGlzLnJldHJpZXZlKCckZGVsZWdhdGVzJywge30pLCBzdG9yZWQgPSBzdG9yYWdlW3R5cGVdOwoJCWlmIChzdG9yZWQpIGZvciAodmFyIF91aWQgaW4gc3RvcmVkKXsKCQkJaWYgKHN0b3JlZFtfdWlkXS5mbiA9PSBmbiAmJiBzdG9yZWRbX3VpZF0ubWF0Y2ggPT0gbWF0Y2gpIHJldHVybiB0aGlzOwoJCX0KCgkJdmFyIF90eXBlID0gdHlwZSwgX21hdGNoID0gbWF0Y2gsIF9mbiA9IGZuLCBfbWFwID0gbWFwW3R5cGVdIHx8IHt9OwoJCXR5cGUgPSBfbWFwLmJhc2UgfHwgX3R5cGU7CgoJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0KXsKCQkJcmV0dXJuIFNsaWNrLm1hdGNoKHRhcmdldCwgX21hdGNoKTsKCQl9OwoKCQl2YXIgZWxlbWVudEV2ZW50ID0gRWxlbWVudC5FdmVudHNbX3R5cGVdOwoJCWlmIChlbGVtZW50RXZlbnQgJiYgZWxlbWVudEV2ZW50LmNvbmRpdGlvbil7CgkJCXZhciBfX21hdGNoID0gbWF0Y2gsIGNvbmRpdGlvbiA9IGVsZW1lbnRFdmVudC5jb25kaXRpb247CgkJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0LCBldmVudCl7CgkJCQlyZXR1cm4gX19tYXRjaCh0YXJnZXQsIGV2ZW50KSAmJiBjb25kaXRpb24uY2FsbCh0YXJnZXQsIGV2ZW50LCB0eXBlKTsKCQkJfTsKCQl9CgoJCXZhciBzZWxmID0gdGhpcywgdWlkID0gU3RyaW5nLnVuaXF1ZUlEKCk7CgkJdmFyIGRlbGVnYXRvciA9IF9tYXAubGlzdGVuID8gZnVuY3Rpb24oZXZlbnQsIHRhcmdldCl7CgkJCWlmICghdGFyZ2V0ICYmIGV2ZW50ICYmIGV2ZW50LnRhcmdldCkgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCQlpZiAodGFyZ2V0KSBfbWFwLmxpc3RlbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCk7CgkJfSA6IGZ1bmN0aW9uKGV2ZW50LCB0YXJnZXQpewoJCQlpZiAoIXRhcmdldCAmJiBldmVudCAmJiBldmVudC50YXJnZXQpIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQkJaWYgKHRhcmdldCkgYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQl9OwoKCQlpZiAoIXN0b3JlZCkgc3RvcmVkID0ge307CgkJc3RvcmVkW3VpZF0gPSB7CgkJCW1hdGNoOiBfbWF0Y2gsCgkJCWZuOiBfZm4sCgkJCWRlbGVnYXRvcjogZGVsZWdhdG9yCgkJfTsKCQlzdG9yYWdlW190eXBlXSA9IHN0b3JlZDsKCQlyZXR1cm4gYWRkRXZlbnQuY2FsbCh0aGlzLCB0eXBlLCBkZWxlZ2F0b3IsIF9tYXAuY2FwdHVyZSk7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBtYXRjaCwgZm4sIF91aWQpewoJCXZhciBzdG9yYWdlID0gdGhpcy5yZXRyaWV2ZSgnJGRlbGVnYXRlcycsIHt9KSwgc3RvcmVkID0gc3RvcmFnZVt0eXBlXTsKCQlpZiAoIXN0b3JlZCkgcmV0dXJuIHRoaXM7CgoJCWlmIChfdWlkKXsKCQkJdmFyIF90eXBlID0gdHlwZSwgZGVsZWdhdG9yID0gc3RvcmVkW191aWRdLmRlbGVnYXRvciwgX21hcCA9IG1hcFt0eXBlXSB8fCB7fTsKCQkJdHlwZSA9IF9tYXAuYmFzZSB8fCBfdHlwZTsKCQkJaWYgKF9tYXAucmVtb3ZlKSBfbWFwLnJlbW92ZSh0aGlzLCBfdWlkKTsKCQkJZGVsZXRlIHN0b3JlZFtfdWlkXTsKCQkJc3RvcmFnZVtfdHlwZV0gPSBzdG9yZWQ7CgkJCXJldHVybiByZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIGRlbGVnYXRvcik7CgkJfQoKCQl2YXIgX191aWQsIHM7CgkJaWYgKGZuKSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCAmJiBzLmZuID09IGZuKSByZXR1cm4gZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBmbiwgX191aWQpOwoJCX0gZWxzZSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCkgZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBzLmZuLCBfX3VpZCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfTsKCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCWFkZEV2ZW50OiByZWxheShhZGRFdmVudCwgZGVsZWdhdGlvbi5hZGRFdmVudCksCglyZW1vdmVFdmVudDogcmVsYXkocmVtb3ZlRXZlbnQsIGRlbGVnYXRpb24ucmVtb3ZlRXZlbnQpCn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQuRGltZW5zaW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgdG8gd29yayB3aXRoIHNpemUsIHNjcm9sbCwgb3IgcG9zaXRpb25pbmcgb2YgRWxlbWVudHMgYW5kIHRoZSB3aW5kb3cgb2JqZWN0LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRWxlbWVudCBwb3NpdGlvbmluZyBiYXNlZCBvbiB0aGUgW3Fvb3hkb29dKGh0dHA6Ly9xb294ZG9vLm9yZy8pIGNvZGUgYW5kIHNtYXJ0IGJyb3dzZXIgZml4ZXMsIFtMR1BMIExpY2Vuc2VdKGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWwpLgogIC0gVmlld3BvcnQgZGltZW5zaW9ucyBiYXNlZCBvbiBbWVVJXShodHRwOi8vZGV2ZWxvcGVyLnlhaG9vLmNvbS95dWkvKSBjb2RlLCBbQlNEIExpY2Vuc2VdKGh0dHA6Ly9kZXZlbG9wZXIueWFob28uY29tL3l1aS9saWNlbnNlLmh0bWwpLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBFbGVtZW50LlN0eWxlXQoKcHJvdmlkZXM6IFtFbGVtZW50LkRpbWVuc2lvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKCWNoaWxkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJzAnOwplbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKdmFyIGJyb2tlbk9mZnNldFBhcmVudCA9IChjaGlsZC5vZmZzZXRQYXJlbnQgPT09IGVsZW1lbnQpOwplbGVtZW50ID0gY2hpbGQgPSBudWxsOwoKdmFyIGlzT2Zmc2V0ID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIHN0eWxlU3RyaW5nKGVsLCAncG9zaXRpb24nKSAhPSAnc3RhdGljJyB8fCBpc0JvZHkoZWwpOwp9OwoKdmFyIGlzT2Zmc2V0U3RhdGljID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIGlzT2Zmc2V0KGVsKSB8fCAoL14oPzp0YWJsZXx0ZHx0aCkkL2kpLnRlc3QoZWwudGFnTmFtZSk7Cn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2Nyb2xsVG86IGZ1bmN0aW9uKHgsIHkpewoJCWlmIChpc0JvZHkodGhpcykpewoJCQl0aGlzLmdldFdpbmRvdygpLnNjcm9sbFRvKHgsIHkpOwoJCX0gZWxzZSB7CgkJCXRoaXMuc2Nyb2xsTGVmdCA9IHg7CgkJCXRoaXMuc2Nyb2xsVG9wID0geTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFNpemU6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2l6ZSgpOwoJCXJldHVybiB7eDogdGhpcy5vZmZzZXRXaWR0aCwgeTogdGhpcy5vZmZzZXRIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGxTaXplOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbFNpemUoKTsKCQlyZXR1cm4ge3g6IHRoaXMuc2Nyb2xsV2lkdGgsIHk6IHRoaXMuc2Nyb2xsSGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbCgpOwoJCXJldHVybiB7eDogdGhpcy5zY3JvbGxMZWZ0LCB5OiB0aGlzLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbHM6IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzLnBhcmVudE5vZGUsIHBvc2l0aW9uID0ge3g6IDAsIHk6IDB9OwoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQuc2Nyb2xsTGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50LnNjcm9sbFRvcDsKCQkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRPZmZzZXRQYXJlbnQ6IGJyb2tlbk9mZnNldFBhcmVudCA/IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzOwoJCWlmIChpc0JvZHkoZWxlbWVudCkgfHwgc3R5bGVTdHJpbmcoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJykgcmV0dXJuIG51bGw7CgoJCXZhciBpc09mZnNldENoZWNrID0gKHN0eWxlU3RyaW5nKGVsZW1lbnQsICdwb3NpdGlvbicpID09ICdzdGF0aWMnKSA/IGlzT2Zmc2V0U3RhdGljIDogaXNPZmZzZXQ7CgkJd2hpbGUgKChlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlKSl7CgkJCWlmIChpc09mZnNldENoZWNrKGVsZW1lbnQpKSByZXR1cm4gZWxlbWVudDsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9IDogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXM7CgkJaWYgKGlzQm9keShlbGVtZW50KSB8fCBzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSByZXR1cm4gbnVsbDsKCgkJdHJ5IHsKCQkJcmV0dXJuIGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0gY2F0Y2goZSkge30KCQlyZXR1cm4gbnVsbDsKCX0sCgoJZ2V0T2Zmc2V0czogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QgJiYgIUJyb3dzZXIuUGxhdGZvcm0uaW9zKXsKCQkJdmFyIGJvdW5kID0gdGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKCQkJCWh0bWwgPSBkb2N1bWVudC5pZCh0aGlzLmdldERvY3VtZW50KCkuZG9jdW1lbnRFbGVtZW50KSwKCQkJCWh0bWxTY3JvbGwgPSBodG1sLmdldFNjcm9sbCgpLAoJCQkJZWxlbVNjcm9sbHMgPSB0aGlzLmdldFNjcm9sbHMoKSwKCQkJCWlzRml4ZWQgPSAoc3R5bGVTdHJpbmcodGhpcywgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJyk7CgoJCQlyZXR1cm4gewoJCQkJeDogYm91bmQubGVmdC50b0ludCgpICsgZWxlbVNjcm9sbHMueCArICgoaXNGaXhlZCkgPyAwIDogaHRtbFNjcm9sbC54KSAtIGh0bWwuY2xpZW50TGVmdCwKCQkJCXk6IGJvdW5kLnRvcC50b0ludCgpICArIGVsZW1TY3JvbGxzLnkgKyAoKGlzRml4ZWQpID8gMCA6IGh0bWxTY3JvbGwueSkgLSBodG1sLmNsaWVudFRvcAoJCQl9OwoJCX0KCgkJdmFyIGVsZW1lbnQgPSB0aGlzLCBwb3NpdGlvbiA9IHt4OiAwLCB5OiAwfTsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gcG9zaXRpb247CgoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQub2Zmc2V0TGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50Lm9mZnNldFRvcDsKCgkJCWlmIChCcm93c2VyLmZpcmVmb3gpewoJCQkJaWYgKCFib3JkZXJCb3goZWxlbWVudCkpewoJCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihlbGVtZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJCX0KCQkJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJCQlpZiAocGFyZW50ICYmIHN0eWxlU3RyaW5nKHBhcmVudCwgJ292ZXJmbG93JykgIT0gJ3Zpc2libGUnKXsKCQkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIocGFyZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihwYXJlbnQpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKGVsZW1lbnQgIT0gdGhpcyAmJiBCcm93c2VyLnNhZmFyaSl7CgkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIoZWxlbWVudCk7CgkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJfQoKCQkJZWxlbWVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0KCQlpZiAoQnJvd3Nlci5maXJlZm94ICYmICFib3JkZXJCb3godGhpcykpewoJCQlwb3NpdGlvbi54IC09IGxlZnRCb3JkZXIodGhpcyk7CgkJCXBvc2l0aW9uLnkgLT0gdG9wQm9yZGVyKHRoaXMpOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldFBvc2l0aW9uOiBmdW5jdGlvbihyZWxhdGl2ZSl7CgkJdmFyIG9mZnNldCA9IHRoaXMuZ2V0T2Zmc2V0cygpLAoJCQlzY3JvbGwgPSB0aGlzLmdldFNjcm9sbHMoKTsKCQl2YXIgcG9zaXRpb24gPSB7CgkJCXg6IG9mZnNldC54IC0gc2Nyb2xsLngsCgkJCXk6IG9mZnNldC55IC0gc2Nyb2xsLnkKCQl9OwoKCQlpZiAocmVsYXRpdmUgJiYgKHJlbGF0aXZlID0gZG9jdW1lbnQuaWQocmVsYXRpdmUpKSl7CgkJCXZhciByZWxhdGl2ZVBvc2l0aW9uID0gcmVsYXRpdmUuZ2V0UG9zaXRpb24oKTsKCQkJcmV0dXJuIHt4OiBwb3NpdGlvbi54IC0gcmVsYXRpdmVQb3NpdGlvbi54IC0gbGVmdEJvcmRlcihyZWxhdGl2ZSksIHk6IHBvc2l0aW9uLnkgLSByZWxhdGl2ZVBvc2l0aW9uLnkgLSB0b3BCb3JkZXIocmVsYXRpdmUpfTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0Q29vcmRpbmF0ZXMoKTsKCQl2YXIgcG9zaXRpb24gPSB0aGlzLmdldFBvc2l0aW9uKGVsZW1lbnQpLAoJCQlzaXplID0gdGhpcy5nZXRTaXplKCk7CgkJdmFyIG9iaiA9IHsKCQkJbGVmdDogcG9zaXRpb24ueCwKCQkJdG9wOiBwb3NpdGlvbi55LAoJCQl3aWR0aDogc2l6ZS54LAoJCQloZWlnaHQ6IHNpemUueQoJCX07CgkJb2JqLnJpZ2h0ID0gb2JqLmxlZnQgKyBvYmoud2lkdGg7CgkJb2JqLmJvdHRvbSA9IG9iai50b3AgKyBvYmouaGVpZ2h0OwoJCXJldHVybiBvYmo7Cgl9LAoKCWNvbXB1dGVQb3NpdGlvbjogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gewoJCQlsZWZ0OiBvYmoueCAtIHN0eWxlTnVtYmVyKHRoaXMsICdtYXJnaW4tbGVmdCcpLAoJCQl0b3A6IG9iai55IC0gc3R5bGVOdW1iZXIodGhpcywgJ21hcmdpbi10b3AnKQoJCX07Cgl9LAoKCXNldFBvc2l0aW9uOiBmdW5jdGlvbihvYmopewoJCXJldHVybiB0aGlzLnNldFN0eWxlcyh0aGlzLmNvbXB1dGVQb3NpdGlvbihvYmopKTsKCX0KCn0pOwoKCltEb2N1bWVudCwgV2luZG93XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglnZXRTaXplOiBmdW5jdGlvbigpewoJCXZhciBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogZG9jLmNsaWVudFdpZHRoLCB5OiBkb2MuY2xpZW50SGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCXZhciB3aW4gPSB0aGlzLmdldFdpbmRvdygpLCBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogd2luLnBhZ2VYT2Zmc2V0IHx8IGRvYy5zY3JvbGxMZWZ0LCB5OiB3aW4ucGFnZVlPZmZzZXQgfHwgZG9jLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJdmFyIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyksCgkJCW1pbiA9IHRoaXMuZ2V0U2l6ZSgpLAoJCQlib2R5ID0gdGhpcy5nZXREb2N1bWVudCgpLmJvZHk7CgoJCXJldHVybiB7eDogTWF0aC5tYXgoZG9jLnNjcm9sbFdpZHRoLCBib2R5LnNjcm9sbFdpZHRoLCBtaW4ueCksIHk6IE1hdGgubWF4KGRvYy5zY3JvbGxIZWlnaHQsIGJvZHkuc2Nyb2xsSGVpZ2h0LCBtaW4ueSl9OwoJfSwKCglnZXRQb3NpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4ge3g6IDAsIHk6IDB9OwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oKXsKCQl2YXIgc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXJldHVybiB7dG9wOiAwLCBsZWZ0OiAwLCBib3R0b206IHNpemUueSwgcmlnaHQ6IHNpemUueCwgaGVpZ2h0OiBzaXplLnksIHdpZHRoOiBzaXplLnh9OwoJfQoKfSk7CgovLyBwcml2YXRlIG1ldGhvZHMKCnZhciBzdHlsZVN0cmluZyA9IEVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZTsKCmZ1bmN0aW9uIHN0eWxlTnVtYmVyKGVsZW1lbnQsIHN0eWxlKXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCBzdHlsZSkudG9JbnQoKSB8fCAwOwp9CgpmdW5jdGlvbiBib3JkZXJCb3goZWxlbWVudCl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWxlbWVudCwgJy1tb3otYm94LXNpemluZycpID09ICdib3JkZXItYm94JzsKfQoKZnVuY3Rpb24gdG9wQm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItdG9wLXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGxlZnRCb3JkZXIoZWxlbWVudCl7CglyZXR1cm4gc3R5bGVOdW1iZXIoZWxlbWVudCwgJ2JvcmRlci1sZWZ0LXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGlzQm9keShlbGVtZW50KXsKCXJldHVybiAoL14oPzpib2R5fGh0bWwpJC9pKS50ZXN0KGVsZW1lbnQudGFnTmFtZSk7Cn0KCmZ1bmN0aW9uIGdldENvbXBhdEVsZW1lbnQoZWxlbWVudCl7Cgl2YXIgZG9jID0gZWxlbWVudC5nZXREb2N1bWVudCgpOwoJcmV0dXJuICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7Cn0KCn0pKCk7CgovL2FsaWFzZXMKRWxlbWVudC5hbGlhcyh7cG9zaXRpb246ICdzZXRQb3NpdGlvbid9KTsgLy9jb21wYXRhYmlsaXR5CgpbV2luZG93LCBEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0SGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNpemUoKS55OwoJfSwKCglnZXRXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTaXplKCkueDsKCX0sCgoJZ2V0U2Nyb2xsVG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbCgpLnk7Cgl9LAoKCWdldFNjcm9sbExlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsKCkueDsKCX0sCgoJZ2V0U2Nyb2xsSGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbFNpemUoKS55OwoJfSwKCglnZXRTY3JvbGxXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGxTaXplKCkueDsKCX0sCgoJZ2V0VG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKCkueTsKCX0sCgoJZ2V0TGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbigpLng7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIGJhc2ljIGFuaW1hdGlvbiBsb2dpYyB0byBiZSBleHRlbmRlZCBieSBhbGwgb3RoZXIgRnggQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXQoKcHJvdmlkZXM6IEZ4CgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIEZ4ID0gdGhpcy5GeCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsKCQkvKgoJCW9uU3RhcnQ6IG5pbCwKCQlvbkNhbmNlbDogbmlsLAoJCW9uQ29tcGxldGU6IG5pbCwKCQkqLwoJCWZwczogNjAsCgkJdW5pdDogZmFsc2UsCgkJZHVyYXRpb246IDUwMCwKCQlmcmFtZXM6IG51bGwsCgkJZnJhbWVTa2lwOiB0cnVlLAoJCWxpbms6ICdpZ25vcmUnCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuc3ViamVjdCA9IHRoaXMuc3ViamVjdCB8fCB0aGlzOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCX0sCgoJZ2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gZnVuY3Rpb24ocCl7CgkJCXJldHVybiAtKE1hdGguY29zKE1hdGguUEkgKiBwKSAtIDEpIC8gMjsKCQl9OwoJfSwKCglzdGVwOiBmdW5jdGlvbihub3cpewoJCWlmICh0aGlzLm9wdGlvbnMuZnJhbWVTa2lwKXsKCQkJdmFyIGRpZmYgPSAodGhpcy50aW1lICE9IG51bGwpID8gKG5vdyAtIHRoaXMudGltZSkgOiAwLCBmcmFtZXMgPSBkaWZmIC8gdGhpcy5mcmFtZUludGVydmFsOwoJCQl0aGlzLnRpbWUgPSBub3c7CgkJCXRoaXMuZnJhbWUgKz0gZnJhbWVzOwoJCX0gZWxzZSB7CgkJCXRoaXMuZnJhbWUrKzsKCQl9CgoJCWlmICh0aGlzLmZyYW1lIDwgdGhpcy5mcmFtZXMpewoJCQl2YXIgZGVsdGEgPSB0aGlzLnRyYW5zaXRpb24odGhpcy5mcmFtZSAvIHRoaXMuZnJhbWVzKTsKCQkJdGhpcy5zZXQodGhpcy5jb21wdXRlKHRoaXMuZnJvbSwgdGhpcy50bywgZGVsdGEpKTsKCQl9IGVsc2UgewoJCQl0aGlzLmZyYW1lID0gdGhpcy5mcmFtZXM7CgkJCXRoaXMuc2V0KHRoaXMuY29tcHV0ZSh0aGlzLmZyb20sIHRoaXMudG8sIDEpKTsKCQkJdGhpcy5zdG9wKCk7CgkJfQoJfSwKCglzZXQ6IGZ1bmN0aW9uKG5vdyl7CgkJcmV0dXJuIG5vdzsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQlyZXR1cm4gRnguY29tcHV0ZShmcm9tLCB0bywgZGVsdGEpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMuaXNSdW5uaW5nKCkpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzdGFydDogZnVuY3Rpb24oZnJvbSwgdG8pewoJCWlmICghdGhpcy5jaGVjayhmcm9tLCB0bykpIHJldHVybiB0aGlzOwoJCXRoaXMuZnJvbSA9IGZyb207CgkJdGhpcy50byA9IHRvOwoJCXRoaXMuZnJhbWUgPSAodGhpcy5vcHRpb25zLmZyYW1lU2tpcCkgPyAwIDogLTE7CgkJdGhpcy50aW1lID0gbnVsbDsKCQl0aGlzLnRyYW5zaXRpb24gPSB0aGlzLmdldFRyYW5zaXRpb24oKTsKCQl2YXIgZnJhbWVzID0gdGhpcy5vcHRpb25zLmZyYW1lcywgZnBzID0gdGhpcy5vcHRpb25zLmZwcywgZHVyYXRpb24gPSB0aGlzLm9wdGlvbnMuZHVyYXRpb247CgkJdGhpcy5kdXJhdGlvbiA9IEZ4LkR1cmF0aW9uc1tkdXJhdGlvbl0gfHwgZHVyYXRpb24udG9JbnQoKTsKCQl0aGlzLmZyYW1lSW50ZXJ2YWwgPSAxMDAwIC8gZnBzOwoJCXRoaXMuZnJhbWVzID0gZnJhbWVzIHx8IE1hdGgucm91bmQodGhpcy5kdXJhdGlvbiAvIHRoaXMuZnJhbWVJbnRlcnZhbCk7CgkJdGhpcy5maXJlRXZlbnQoJ3N0YXJ0JywgdGhpcy5zdWJqZWN0KTsKCQlwdXNoSW5zdGFuY2UuY2FsbCh0aGlzLCBmcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdG9wOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCWlmICh0aGlzLmZyYW1lcyA9PSB0aGlzLmZyYW1lKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIHRoaXMuc3ViamVjdCk7CgkJCQlpZiAoIXRoaXMuY2FsbENoYWluKCkpIHRoaXMuZmlyZUV2ZW50KCdjaGFpbkNvbXBsZXRlJywgdGhpcy5zdWJqZWN0KTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZmlyZUV2ZW50KCdzdG9wJywgdGhpcy5zdWJqZWN0KTsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCXRoaXMuZnJhbWUgPSB0aGlzLmZyYW1lczsKCQkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcsIHRoaXMuc3ViamVjdCkuY2xlYXJDaGFpbigpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJcGF1c2U6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlc3VtZTogZnVuY3Rpb24oKXsKCQlpZiAoKHRoaXMuZnJhbWUgPCB0aGlzLmZyYW1lcykgJiYgIXRoaXMuaXNSdW5uaW5nKCkpIHB1c2hJbnN0YW5jZS5jYWxsKHRoaXMsIHRoaXMub3B0aW9ucy5mcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJdmFyIGxpc3QgPSBpbnN0YW5jZXNbdGhpcy5vcHRpb25zLmZwc107CgkJcmV0dXJuIGxpc3QgJiYgbGlzdC5jb250YWlucyh0aGlzKTsKCX0KCn0pOwoKRnguY29tcHV0ZSA9IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CglyZXR1cm4gKHRvIC0gZnJvbSkgKiBkZWx0YSArIGZyb207Cn07CgpGeC5EdXJhdGlvbnMgPSB7J3Nob3J0JzogMjUwLCAnbm9ybWFsJzogNTAwLCAnbG9uZyc6IDEwMDB9OwoKLy8gZ2xvYmFsIHRpbWVycwoKdmFyIGluc3RhbmNlcyA9IHt9LCB0aW1lcnMgPSB7fTsKCnZhciBsb29wID0gZnVuY3Rpb24oKXsKCXZhciBub3cgPSBEYXRlLm5vdygpOwoJZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoOyBpLS07KXsKCQl2YXIgaW5zdGFuY2UgPSB0aGlzW2ldOwoJCWlmIChpbnN0YW5jZSkgaW5zdGFuY2Uuc3RlcChub3cpOwoJfQp9OwoKdmFyIHB1c2hJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdIHx8IChpbnN0YW5jZXNbZnBzXSA9IFtdKTsKCWxpc3QucHVzaCh0aGlzKTsKCWlmICghdGltZXJzW2Zwc10pIHRpbWVyc1tmcHNdID0gbG9vcC5wZXJpb2RpY2FsKE1hdGgucm91bmQoMTAwMCAvIGZwcyksIGxpc3QpOwp9OwoKdmFyIHB1bGxJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdOwoJaWYgKGxpc3QpewoJCWxpc3QuZXJhc2UodGhpcyk7CgkJaWYgKCFsaXN0Lmxlbmd0aCAmJiB0aW1lcnNbZnBzXSl7CgkJCWRlbGV0ZSBpbnN0YW5jZXNbZnBzXTsKCQkJdGltZXJzW2Zwc10gPSBjbGVhckludGVydmFsKHRpbWVyc1tmcHNdKTsKCQl9Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRnguQ1NTCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENTUyBhbmltYXRpb24gbG9naWMuIFVzZWQgYnkgRnguVHdlZW4sIEZ4Lk1vcnBoLCBGeC5FbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtGeCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBGeC5DU1MKCi4uLgoqLwoKRnguQ1NTID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeCwKCgkvL3ByZXBhcmVzIHRoZSBiYXNlIGZyb20vdG8gb2JqZWN0CgoJcHJlcGFyZTogZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHksIHZhbHVlcyl7CgkJdmFsdWVzID0gQXJyYXkuZnJvbSh2YWx1ZXMpOwoJCXZhciBmcm9tID0gdmFsdWVzWzBdLCB0byA9IHZhbHVlc1sxXTsKCQlpZiAodG8gPT0gbnVsbCl7CgkJCXRvID0gZnJvbTsKCQkJZnJvbSA9IGVsZW1lbnQuZ2V0U3R5bGUocHJvcGVydHkpOwoJCQl2YXIgdW5pdCA9IHRoaXMub3B0aW9ucy51bml0OwoJCQkvLyBhZGFwdGVkIGZyb206IGh0dHBzOi8vZ2l0aHViLmNvbS9yeWFubW9yci9meC9ibG9iL21hc3Rlci9meC5qcyNMMjk5CgkJCWlmICh1bml0ICYmIGZyb20uc2xpY2UoLXVuaXQubGVuZ3RoKSAhPSB1bml0ICYmIHBhcnNlRmxvYXQoZnJvbSkgIT0gMCl7CgkJCQllbGVtZW50LnNldFN0eWxlKHByb3BlcnR5LCB0byArIHVuaXQpOwoJCQkJdmFyIHZhbHVlID0gZWxlbWVudC5nZXRDb21wdXRlZFN0eWxlKHByb3BlcnR5KTsKCQkJCS8vIElFIGFuZCBPcGVyYSBzdXBwb3J0IHBpeGVsTGVmdCBvciBwaXhlbFdpZHRoCgkJCQlpZiAoISgvcHgkLy50ZXN0KHZhbHVlKSkpewoJCQkJCXZhbHVlID0gZWxlbWVudC5zdHlsZVsoJ3BpeGVsLScgKyBwcm9wZXJ0eSkuY2FtZWxDYXNlKCldOwoJCQkJCWlmICh2YWx1ZSA9PSBudWxsKXsKCQkJCQkJLy8gYWRhcHRlZCBmcm9tIERlYW4gRWR3YXJkcycgaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQoJCQkJCQl2YXIgbGVmdCA9IGVsZW1lbnQuc3R5bGUubGVmdDsKCQkJCQkJZWxlbWVudC5zdHlsZS5sZWZ0ID0gdG8gKyB1bml0OwoJCQkJCQl2YWx1ZSA9IGVsZW1lbnQuc3R5bGUucGl4ZWxMZWZ0OwoJCQkJCQllbGVtZW50LnN0eWxlLmxlZnQgPSBsZWZ0OwoJCQkJCX0KCQkJCX0KCQkJCWZyb20gPSAodG8gfHwgMSkgLyAocGFyc2VGbG9hdCh2YWx1ZSkgfHwgMSkgKiAocGFyc2VGbG9hdChmcm9tKSB8fCAwKTsKCQkJCWVsZW1lbnQuc2V0U3R5bGUocHJvcGVydHksIGZyb20gKyB1bml0KTsKCQkJfQoJCX0KCQlyZXR1cm4ge2Zyb206IHRoaXMucGFyc2UoZnJvbSksIHRvOiB0aGlzLnBhcnNlKHRvKX07Cgl9LAoKCS8vcGFyc2VzIGEgdmFsdWUgaW50byBhbiBhcnJheQoKCXBhcnNlOiBmdW5jdGlvbih2YWx1ZSl7CgkJdmFsdWUgPSBGdW5jdGlvbi5mcm9tKHZhbHVlKSgpOwoJCXZhbHVlID0gKHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJykgPyB2YWx1ZS5zcGxpdCgnICcpIDogQXJyYXkuZnJvbSh2YWx1ZSk7CgkJcmV0dXJuIHZhbHVlLm1hcChmdW5jdGlvbih2YWwpewoJCQl2YWwgPSBTdHJpbmcodmFsKTsKCQkJdmFyIGZvdW5kID0gZmFsc2U7CgkJCU9iamVjdC5lYWNoKEZ4LkNTUy5QYXJzZXJzLCBmdW5jdGlvbihwYXJzZXIsIGtleSl7CgkJCQlpZiAoZm91bmQpIHJldHVybjsKCQkJCXZhciBwYXJzZWQgPSBwYXJzZXIucGFyc2UodmFsKTsKCQkJCWlmIChwYXJzZWQgfHwgcGFyc2VkID09PSAwKSBmb3VuZCA9IHt2YWx1ZTogcGFyc2VkLCBwYXJzZXI6IHBhcnNlcn07CgkJCX0pOwoJCQlmb3VuZCA9IGZvdW5kIHx8IHt2YWx1ZTogdmFsLCBwYXJzZXI6IEZ4LkNTUy5QYXJzZXJzLlN0cmluZ307CgkJCXJldHVybiBmb3VuZDsKCQl9KTsKCX0sCgoJLy9jb21wdXRlcyBieSBhIGZyb20gYW5kIHRvIHByZXBhcmVkIG9iamVjdHMsIHVzaW5nIHRoZWlyIHBhcnNlcnMuCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgY29tcHV0ZWQgPSBbXTsKCQkoTWF0aC5taW4oZnJvbS5sZW5ndGgsIHRvLmxlbmd0aCkpLnRpbWVzKGZ1bmN0aW9uKGkpewoJCQljb21wdXRlZC5wdXNoKHt2YWx1ZTogZnJvbVtpXS5wYXJzZXIuY29tcHV0ZShmcm9tW2ldLnZhbHVlLCB0b1tpXS52YWx1ZSwgZGVsdGEpLCBwYXJzZXI6IGZyb21baV0ucGFyc2VyfSk7CgkJfSk7CgkJY29tcHV0ZWQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2Z4OmNzczp2YWx1ZScpOwoJCXJldHVybiBjb21wdXRlZDsKCX0sCgoJLy9zZXJ2ZXMgdGhlIHZhbHVlIGFzIHNldHRhYmxlCgoJc2VydmU6IGZ1bmN0aW9uKHZhbHVlLCB1bml0KXsKCQlpZiAodHlwZU9mKHZhbHVlKSAhPSAnZng6Y3NzOnZhbHVlJykgdmFsdWUgPSB0aGlzLnBhcnNlKHZhbHVlKTsKCQl2YXIgcmV0dXJuZWQgPSBbXTsKCQl2YWx1ZS5lYWNoKGZ1bmN0aW9uKGJpdCl7CgkJCXJldHVybmVkID0gcmV0dXJuZWQuY29uY2F0KGJpdC5wYXJzZXIuc2VydmUoYml0LnZhbHVlLCB1bml0KSk7CgkJfSk7CgkJcmV0dXJuIHJldHVybmVkOwoJfSwKCgkvL3JlbmRlcnMgdGhlIGNoYW5nZSB0byBhbiBlbGVtZW50CgoJcmVuZGVyOiBmdW5jdGlvbihlbGVtZW50LCBwcm9wZXJ0eSwgdmFsdWUsIHVuaXQpewoJCWVsZW1lbnQuc2V0U3R5bGUocHJvcGVydHksIHRoaXMuc2VydmUodmFsdWUsIHVuaXQpKTsKCX0sCgoJLy9zZWFyY2hlcyBpbnNpZGUgdGhlIHBhZ2UgY3NzIHRvIGZpbmQgdGhlIHZhbHVlcyBmb3IgYSBzZWxlY3RvcgoKCXNlYXJjaDogZnVuY3Rpb24oc2VsZWN0b3IpewoJCWlmIChGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdKSByZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXTsKCQl2YXIgdG8gPSB7fSwgc2VsZWN0b3JUZXN0ID0gbmV3IFJlZ0V4cCgnXicgKyBzZWxlY3Rvci5lc2NhcGVSZWdFeHAoKSArICckJyk7CgkJQXJyYXkuZWFjaChkb2N1bWVudC5zdHlsZVNoZWV0cywgZnVuY3Rpb24oc2hlZXQsIGopewoJCQl2YXIgaHJlZiA9IHNoZWV0LmhyZWY7CgkJCWlmIChocmVmICYmIGhyZWYuY29udGFpbnMoJzovLycpICYmICFocmVmLmNvbnRhaW5zKGRvY3VtZW50LmRvbWFpbikpIHJldHVybjsKCQkJdmFyIHJ1bGVzID0gc2hlZXQucnVsZXMgfHwgc2hlZXQuY3NzUnVsZXM7CgkJCUFycmF5LmVhY2gocnVsZXMsIGZ1bmN0aW9uKHJ1bGUsIGkpewoJCQkJaWYgKCFydWxlLnN0eWxlKSByZXR1cm47CgkJCQl2YXIgc2VsZWN0b3JUZXh0ID0gKHJ1bGUuc2VsZWN0b3JUZXh0KSA/IHJ1bGUuc2VsZWN0b3JUZXh0LnJlcGxhY2UoL15cdysvLCBmdW5jdGlvbihtKXsKCQkJCQlyZXR1cm4gbS50b0xvd2VyQ2FzZSgpOwoJCQkJfSkgOiBudWxsOwoJCQkJaWYgKCFzZWxlY3RvclRleHQgfHwgIXNlbGVjdG9yVGVzdC50ZXN0KHNlbGVjdG9yVGV4dCkpIHJldHVybjsKCQkJCU9iamVjdC5lYWNoKEVsZW1lbnQuU3R5bGVzLCBmdW5jdGlvbih2YWx1ZSwgc3R5bGUpewoJCQkJCWlmICghcnVsZS5zdHlsZVtzdHlsZV0gfHwgRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJldHVybjsKCQkJCQl2YWx1ZSA9IFN0cmluZyhydWxlLnN0eWxlW3N0eWxlXSk7CgkJCQkJdG9bc3R5bGVdID0gKCgvXnJnYi8pLnRlc3QodmFsdWUpKSA/IHZhbHVlLnJnYlRvSGV4KCkgOiB2YWx1ZTsKCQkJCX0pOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXSA9IHRvOwoJfQoKfSk7CgpGeC5DU1MuQ2FjaGUgPSB7fTsKCkZ4LkNTUy5QYXJzZXJzID0gewoKCUNvbG9yOiB7CgkJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJaWYgKHZhbHVlLm1hdGNoKC9eI1swLTlhLWZdezMsNn0kL2kpKSByZXR1cm4gdmFsdWUuaGV4VG9SZ2IodHJ1ZSk7CgkJCXJldHVybiAoKHZhbHVlID0gdmFsdWUubWF0Y2goLyhcZCspLFxzKihcZCspLFxzKihcZCspLykpKSA/IFt2YWx1ZVsxXSwgdmFsdWVbMl0sIHZhbHVlWzNdXSA6IGZhbHNlOwoJCX0sCgkJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQkJcmV0dXJuIGZyb20ubWFwKGZ1bmN0aW9uKHZhbHVlLCBpKXsKCQkJCXJldHVybiBNYXRoLnJvdW5kKEZ4LmNvbXB1dGUoZnJvbVtpXSwgdG9baV0sIGRlbHRhKSk7CgkJCX0pOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlLm1hcChOdW1iZXIpOwoJCX0KCX0sCgoJTnVtYmVyOiB7CgkJcGFyc2U6IHBhcnNlRmxvYXQsCgkJY29tcHV0ZTogRnguY29tcHV0ZSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCQlyZXR1cm4gKHVuaXQpID8gdmFsdWUgKyB1bml0IDogdmFsdWU7CgkJfQoJfSwKCglTdHJpbmc6IHsKCQlwYXJzZTogRnVuY3Rpb24uZnJvbShmYWxzZSksCgkJY29tcHV0ZTogZnVuY3Rpb24oemVybywgb25lKXsKCQkJcmV0dXJuIG9uZTsKCQl9LAoJCXNlcnZlOiBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfQoJfQoKfTsKCgoKCi8qCi0tLQoKbmFtZTogRnguVHdlZW4KCmRlc2NyaXB0aW9uOiBGb3JtZXJseSBGeC5TdHlsZSwgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IENTUyBwcm9wZXJ0eSBmb3IgYW4gZWxlbWVudC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IFtGeC5Ud2VlbiwgRWxlbWVudC5mYWRlLCBFbGVtZW50LmhpZ2hsaWdodF0KCi4uLgoqLwoKRnguVHdlZW4gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihwcm9wZXJ0eSwgbm93KXsKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQkJbm93ID0gcHJvcGVydHk7CgkJCXByb3BlcnR5ID0gdGhpcy5wcm9wZXJ0eSB8fCB0aGlzLm9wdGlvbnMucHJvcGVydHk7CgkJfQoJCXRoaXMucmVuZGVyKHRoaXMuZWxlbWVudCwgcHJvcGVydHksIG5vdywgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdGFydDogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydHksIGZyb20sIHRvKSkgcmV0dXJuIHRoaXM7CgkJdmFyIGFyZ3MgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyk7CgkJdGhpcy5wcm9wZXJ0eSA9IHRoaXMub3B0aW9ucy5wcm9wZXJ0eSB8fCBhcmdzLnNoaWZ0KCk7CgkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHRoaXMucHJvcGVydHksIGFyZ3MpOwoJCXJldHVybiB0aGlzLnBhcmVudChwYXJzZWQuZnJvbSwgcGFyc2VkLnRvKTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnR3ZWVuID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5nZXQoJ3R3ZWVuJykuY2FuY2VsKCkuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciB0d2VlbiA9IHRoaXMucmV0cmlldmUoJ3R3ZWVuJyk7CgkJaWYgKCF0d2Vlbil7CgkJCXR3ZWVuID0gbmV3IEZ4LlR3ZWVuKHRoaXMsIHtsaW5rOiAnY2FuY2VsJ30pOwoJCQl0aGlzLnN0b3JlKCd0d2VlbicsIHR3ZWVuKTsKCQl9CgkJcmV0dXJuIHR3ZWVuOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCgl0d2VlbjogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQl0aGlzLmdldCgndHdlZW4nKS5zdGFydChwcm9wZXJ0eSwgZnJvbSwgdG8pOwoJCXJldHVybiB0aGlzOwoJfSwKCglmYWRlOiBmdW5jdGlvbihob3cpewoJCXZhciBmYWRlID0gdGhpcy5nZXQoJ3R3ZWVuJyksIG1ldGhvZCwgYXJncyA9IFsnb3BhY2l0eSddLmFwcGVuZChhcmd1bWVudHMpLCB0b2dnbGU7CgkJaWYgKGFyZ3NbMV0gPT0gbnVsbCkgYXJnc1sxXSA9ICd0b2dnbGUnOwoJCXN3aXRjaCAoYXJnc1sxXSl7CgkJCWNhc2UgJ2luJzogbWV0aG9kID0gJ3N0YXJ0JzsgYXJnc1sxXSA9IDE7IGJyZWFrOwoJCQljYXNlICdvdXQnOiBtZXRob2QgPSAnc3RhcnQnOyBhcmdzWzFdID0gMDsgYnJlYWs7CgkJCWNhc2UgJ3Nob3cnOiBtZXRob2QgPSAnc2V0JzsgYXJnc1sxXSA9IDE7IGJyZWFrOwoJCQljYXNlICdoaWRlJzogbWV0aG9kID0gJ3NldCc7IGFyZ3NbMV0gPSAwOyBicmVhazsKCQkJY2FzZSAndG9nZ2xlJzoKCQkJCXZhciBmbGFnID0gdGhpcy5yZXRyaWV2ZSgnZmFkZTpmbGFnJywgdGhpcy5nZXRTdHlsZSgnb3BhY2l0eScpID09IDEpOwoJCQkJbWV0aG9kID0gJ3N0YXJ0JzsKCQkJCWFyZ3NbMV0gPSBmbGFnID8gMCA6IDE7CgkJCQl0aGlzLnN0b3JlKCdmYWRlOmZsYWcnLCAhZmxhZyk7CgkJCQl0b2dnbGUgPSB0cnVlOwoJCQlicmVhazsKCQkJZGVmYXVsdDogbWV0aG9kID0gJ3N0YXJ0JzsKCQl9CgkJaWYgKCF0b2dnbGUpIHRoaXMuZWxpbWluYXRlKCdmYWRlOmZsYWcnKTsKCQlmYWRlW21ldGhvZF0uYXBwbHkoZmFkZSwgYXJncyk7CgkJdmFyIHRvID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdOwoJCWlmIChtZXRob2QgPT0gJ3NldCcgfHwgdG8gIT0gMCkgdGhpcy5zZXRTdHlsZSgndmlzaWJpbGl0eScsIHRvID09IDAgPyAnaGlkZGVuJyA6ICd2aXNpYmxlJyk7CgkJZWxzZSBmYWRlLmNoYWluKGZ1bmN0aW9uKCl7CgkJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSgndmlzaWJpbGl0eScsICdoaWRkZW4nKTsKCQkJdGhpcy5jYWxsQ2hhaW4oKTsKCQl9KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGlnaGxpZ2h0OiBmdW5jdGlvbihzdGFydCwgZW5kKXsKCQlpZiAoIWVuZCl7CgkJCWVuZCA9IHRoaXMucmV0cmlldmUoJ2hpZ2hsaWdodDpvcmlnaW5hbCcsIHRoaXMuZ2V0U3R5bGUoJ2JhY2tncm91bmQtY29sb3InKSk7CgkJCWVuZCA9IChlbmQgPT0gJ3RyYW5zcGFyZW50JykgPyAnI2ZmZicgOiBlbmQ7CgkJfQoJCXZhciB0d2VlbiA9IHRoaXMuZ2V0KCd0d2VlbicpOwoJCXR3ZWVuLnN0YXJ0KCdiYWNrZ3JvdW5kLWNvbG9yJywgc3RhcnQgfHwgJyNmZmZmODgnLCBlbmQpLmNoYWluKGZ1bmN0aW9uKCl7CgkJCXRoaXMuc2V0U3R5bGUoJ2JhY2tncm91bmQtY29sb3InLCB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnKSk7CgkJCXR3ZWVuLmNhbGxDaGFpbigpOwoJCX0uYmluZCh0aGlzKSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4Lk1vcnBoCgpkZXNjcmlwdGlvbjogRm9ybWVybHkgRnguU3R5bGVzLCBlZmZlY3QgdG8gdHJhbnNpdGlvbiBhbnkgbnVtYmVyIG9mIENTUyBwcm9wZXJ0aWVzIGZvciBhbiBlbGVtZW50IHVzaW5nIGFuIG9iamVjdCBvZiBydWxlcywgb3IgQ1NTIGJhc2VkIHNlbGVjdG9yIHJ1bGVzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRnguQ1NTCgpwcm92aWRlczogRnguTW9ycGgKCi4uLgoqLwoKRnguTW9ycGggPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihub3cpewoJCWlmICh0eXBlb2Ygbm93ID09ICdzdHJpbmcnKSBub3cgPSB0aGlzLnNlYXJjaChub3cpOwoJCWZvciAodmFyIHAgaW4gbm93KSB0aGlzLnJlbmRlcih0aGlzLmVsZW1lbnQsIHAsIG5vd1twXSwgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBub3cgPSB7fTsKCQlmb3IgKHZhciBwIGluIGZyb20pIG5vd1twXSA9IHRoaXMucGFyZW50KGZyb21bcF0sIHRvW3BdLCBkZWx0YSk7CgkJcmV0dXJuIG5vdzsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJCWlmICghdGhpcy5jaGVjayhwcm9wZXJ0aWVzKSkgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZiBwcm9wZXJ0aWVzID09ICdzdHJpbmcnKSBwcm9wZXJ0aWVzID0gdGhpcy5zZWFyY2gocHJvcGVydGllcyk7CgkJdmFyIGZyb20gPSB7fSwgdG8gPSB7fTsKCQlmb3IgKHZhciBwIGluIHByb3BlcnRpZXMpewoJCQl2YXIgcGFyc2VkID0gdGhpcy5wcmVwYXJlKHRoaXMuZWxlbWVudCwgcCwgcHJvcGVydGllc1twXSk7CgkJCWZyb21bcF0gPSBwYXJzZWQuZnJvbTsKCQkJdG9bcF0gPSBwYXJzZWQudG87CgkJfQoJCXJldHVybiB0aGlzLnBhcmVudChmcm9tLCB0byk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5tb3JwaCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuZ2V0KCdtb3JwaCcpLmNhbmNlbCgpLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgbW9ycGggPSB0aGlzLnJldHJpZXZlKCdtb3JwaCcpOwoJCWlmICghbW9ycGgpewoJCQltb3JwaCA9IG5ldyBGeC5Nb3JwaCh0aGlzLCB7bGluazogJ2NhbmNlbCd9KTsKCQkJdGhpcy5zdG9yZSgnbW9ycGgnLCBtb3JwaCk7CgkJfQoJCXJldHVybiBtb3JwaDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbW9ycGg6IGZ1bmN0aW9uKHByb3BzKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5zdGFydChwcm9wcyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4LlRyYW5zaXRpb25zCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgYSBzZXQgb2YgYWR2YW5jZWQgdHJhbnNpdGlvbnMgdG8gYmUgdXNlZCB3aXRoIGFueSBvZiB0aGUgRnggQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEVhc2luZyBFcXVhdGlvbnMgYnkgUm9iZXJ0IFBlbm5lciwgPGh0dHA6Ly93d3cucm9iZXJ0cGVubmVyLmNvbS9lYXNpbmcvPiwgbW9kaWZpZWQgYW5kIG9wdGltaXplZCB0byBiZSB1c2VkIHdpdGggTW9vVG9vbHMuCgpyZXF1aXJlczogRngKCnByb3ZpZGVzOiBGeC5UcmFuc2l0aW9ucwoKLi4uCiovCgpGeC5pbXBsZW1lbnQoewoKCWdldFRyYW5zaXRpb246IGZ1bmN0aW9uKCl7CgkJdmFyIHRyYW5zID0gdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gfHwgRnguVHJhbnNpdGlvbnMuU2luZS5lYXNlSW5PdXQ7CgkJaWYgKHR5cGVvZiB0cmFucyA9PSAnc3RyaW5nJyl7CgkJCXZhciBkYXRhID0gdHJhbnMuc3BsaXQoJzonKTsKCQkJdHJhbnMgPSBGeC5UcmFuc2l0aW9uczsKCQkJdHJhbnMgPSB0cmFuc1tkYXRhWzBdXSB8fCB0cmFuc1tkYXRhWzBdLmNhcGl0YWxpemUoKV07CgkJCWlmIChkYXRhWzFdKSB0cmFucyA9IHRyYW5zWydlYXNlJyArIGRhdGFbMV0uY2FwaXRhbGl6ZSgpICsgKGRhdGFbMl0gPyBkYXRhWzJdLmNhcGl0YWxpemUoKSA6ICcnKV07CgkJfQoJCXJldHVybiB0cmFuczsKCX0KCn0pOwoKRnguVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKHRyYW5zaXRpb24sIHBhcmFtcyl7CglwYXJhbXMgPSBBcnJheS5mcm9tKHBhcmFtcyk7Cgl2YXIgZWFzZUluID0gZnVuY3Rpb24ocG9zKXsKCQlyZXR1cm4gdHJhbnNpdGlvbihwb3MsIHBhcmFtcyk7Cgl9OwoJcmV0dXJuIE9iamVjdC5hcHBlbmQoZWFzZUluLCB7CgkJZWFzZUluOiBlYXNlSW4sCgkJZWFzZU91dDogZnVuY3Rpb24ocG9zKXsKCQkJcmV0dXJuIDEgLSB0cmFuc2l0aW9uKDEgLSBwb3MsIHBhcmFtcyk7CgkJfSwKCQllYXNlSW5PdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAocG9zIDw9IDAuNSA/IHRyYW5zaXRpb24oMiAqIHBvcywgcGFyYW1zKSA6ICgyIC0gdHJhbnNpdGlvbigyICogKDEgLSBwb3MpLCBwYXJhbXMpKSkgLyAyOwoJCX0KCX0pOwp9OwoKRnguVHJhbnNpdGlvbnMgPSB7CgoJbGluZWFyOiBmdW5jdGlvbih6ZXJvKXsKCQlyZXR1cm4gemVybzsKCX0KCn07CgoKCkZ4LlRyYW5zaXRpb25zLmV4dGVuZCA9IGZ1bmN0aW9uKHRyYW5zaXRpb25zKXsKCWZvciAodmFyIHRyYW5zaXRpb24gaW4gdHJhbnNpdGlvbnMpIEZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb25dID0gbmV3IEZ4LlRyYW5zaXRpb24odHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0pOwp9OwoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kKHsKCglQb3c6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdyhwLCB4ICYmIHhbMF0gfHwgNik7Cgl9LAoKCUV4cG86IGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdygyLCA4ICogKHAgLSAxKSk7Cgl9LAoKCUNpcmM6IGZ1bmN0aW9uKHApewoJCXJldHVybiAxIC0gTWF0aC5zaW4oTWF0aC5hY29zKHApKTsKCX0sCgoJU2luZTogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLmNvcyhwICogTWF0aC5QSSAvIDIpOwoJfSwKCglCYWNrOiBmdW5jdGlvbihwLCB4KXsKCQl4ID0geCAmJiB4WzBdIHx8IDEuNjE4OwoJCXJldHVybiBNYXRoLnBvdyhwLCAyKSAqICgoeCArIDEpICogcCAtIHgpOwoJfSwKCglCb3VuY2U6IGZ1bmN0aW9uKHApewoJCXZhciB2YWx1ZTsKCQlmb3IgKHZhciBhID0gMCwgYiA9IDE7IDE7IGEgKz0gYiwgYiAvPSAyKXsKCQkJaWYgKHAgPj0gKDcgLSA0ICogYSkgLyAxMSl7CgkJCQl2YWx1ZSA9IGIgKiBiIC0gTWF0aC5wb3coKDExIC0gNiAqIGEgLSAxMSAqIHApIC8gNCwgMik7CgkJCQlicmVhazsKCQkJfQoJCX0KCQlyZXR1cm4gdmFsdWU7Cgl9LAoKCUVsYXN0aWM6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdygyLCAxMCAqIC0tcCkgKiBNYXRoLmNvcygyMCAqIHAgKiBNYXRoLlBJICogKHggJiYgeFswXSB8fCAxKSAvIDMpOwoJfQoKfSk7CgpbJ1F1YWQnLCAnQ3ViaWMnLCAnUXVhcnQnLCAnUXVpbnQnXS5lYWNoKGZ1bmN0aW9uKHRyYW5zaXRpb24sIGkpewoJRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbihmdW5jdGlvbihwKXsKCQlyZXR1cm4gTWF0aC5wb3cocCwgaSArIDIpOwoJfSk7Cn0pOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdAoKZGVzY3JpcHRpb246IFBvd2VyZnVsIGFsbCBwdXJwb3NlIFJlcXVlc3QgQ2xhc3MuIFVzZXMgWE1MSFRUUFJlcXVlc3QuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbT2JqZWN0LCBFbGVtZW50LCBDaGFpbiwgRXZlbnRzLCBPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IFJlcXVlc3QKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZW1wdHkgPSBmdW5jdGlvbigpe30sCglwcm9ncmVzc1N1cHBvcnQgPSAoJ29ucHJvZ3Jlc3MnIGluIG5ldyBCcm93c2VyLlJlcXVlc3QpOwoKdmFyIFJlcXVlc3QgPSB0aGlzLlJlcXVlc3QgPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXSwKCglvcHRpb25zOiB7LyoKCQlvblJlcXVlc3Q6IGZ1bmN0aW9uKCl7fSwKCQlvbkxvYWRzdGFydDogZnVuY3Rpb24oZXZlbnQsIHhocil7fSwKCQlvblByb2dyZXNzOiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uQ29tcGxldGU6IGZ1bmN0aW9uKCl7fSwKCQlvbkNhbmNlbDogZnVuY3Rpb24oKXt9LAoJCW9uU3VjY2VzczogZnVuY3Rpb24ocmVzcG9uc2VUZXh0LCByZXNwb25zZVhNTCl7fSwKCQlvbkZhaWx1cmU6IGZ1bmN0aW9uKHhocil7fSwKCQlvbkV4Y2VwdGlvbjogZnVuY3Rpb24oaGVhZGVyTmFtZSwgdmFsdWUpe30sCgkJb25UaW1lb3V0OiBmdW5jdGlvbigpe30sCgkJdXNlcjogJycsCgkJcGFzc3dvcmQ6ICcnLCovCgkJdXJsOiAnJywKCQlkYXRhOiAnJywKCQloZWFkZXJzOiB7CgkJCSdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JywKCQkJJ0FjY2VwdCc6ICd0ZXh0L2phdmFzY3JpcHQsIHRleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0sCgkJYXN5bmM6IHRydWUsCgkJZm9ybWF0OiBmYWxzZSwKCQltZXRob2Q6ICdwb3N0JywKCQlsaW5rOiAnaWdub3JlJywKCQlpc1N1Y2Nlc3M6IG51bGwsCgkJZW11bGF0aW9uOiB0cnVlLAoJCXVybEVuY29kZWQ6IHRydWUsCgkJZW5jb2Rpbmc6ICd1dGYtOCcsCgkJZXZhbFNjcmlwdHM6IGZhbHNlLAoJCWV2YWxSZXNwb25zZTogZmFsc2UsCgkJdGltZW91dDogMCwKCQlub0NhY2hlOiBmYWxzZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJdGhpcy5oZWFkZXJzID0gdGhpcy5vcHRpb25zLmhlYWRlcnM7Cgl9LAoKCW9uU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uKCl7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCWlmICh4aHIucmVhZHlTdGF0ZSAhPSA0IHx8ICF0aGlzLnJ1bm5pbmcpIHJldHVybjsKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCQl0aGlzLnN0YXR1cyA9IDA7CgkJRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQl2YXIgc3RhdHVzID0geGhyLnN0YXR1czsKCQkJdGhpcy5zdGF0dXMgPSAoc3RhdHVzID09IDEyMjMpID8gMjA0IDogc3RhdHVzOwoJCX0uYmluZCh0aGlzKSk7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5OwoJCWlmIChwcm9ncmVzc1N1cHBvcnQpIHhoci5vbnByb2dyZXNzID0geGhyLm9ubG9hZHN0YXJ0ID0gZW1wdHk7CgkJY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwoKCQl0aGlzLnJlc3BvbnNlID0ge3RleHQ6IHRoaXMueGhyLnJlc3BvbnNlVGV4dCB8fCAnJywgeG1sOiB0aGlzLnhoci5yZXNwb25zZVhNTH07CgkJaWYgKHRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MuY2FsbCh0aGlzLCB0aGlzLnN0YXR1cykpCgkJCXRoaXMuc3VjY2Vzcyh0aGlzLnJlc3BvbnNlLnRleHQsIHRoaXMucmVzcG9uc2UueG1sKTsKCQllbHNlCgkJCXRoaXMuZmFpbHVyZSgpOwoJfSwKCglpc1N1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdmFyIHN0YXR1cyA9IHRoaXMuc3RhdHVzOwoJCXJldHVybiAoc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDApOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICEhdGhpcy5ydW5uaW5nOwoJfSwKCglwcm9jZXNzU2NyaXB0czogZnVuY3Rpb24odGV4dCl7CgkJaWYgKHRoaXMub3B0aW9ucy5ldmFsUmVzcG9uc2UgfHwgKC8oZWNtYXxqYXZhKXNjcmlwdC8pLnRlc3QodGhpcy5nZXRIZWFkZXIoJ0NvbnRlbnQtdHlwZScpKSkgcmV0dXJuIEJyb3dzZXIuZXhlYyh0ZXh0KTsKCQlyZXR1cm4gdGV4dC5zdHJpcFNjcmlwdHModGhpcy5vcHRpb25zLmV2YWxTY3JpcHRzKTsKCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCwgeG1sKXsKCQl0aGlzLm9uU3VjY2Vzcyh0aGlzLnByb2Nlc3NTY3JpcHRzKHRleHQpLCB4bWwpOwoJfSwKCglvblN1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJywgYXJndW1lbnRzKS5maXJlRXZlbnQoJ3N1Y2Nlc3MnLCBhcmd1bWVudHMpLmNhbGxDaGFpbigpOwoJfSwKCglmYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMub25GYWlsdXJlKCk7Cgl9LAoKCW9uRmFpbHVyZTogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnY29tcGxldGUnKS5maXJlRXZlbnQoJ2ZhaWx1cmUnLCB0aGlzLnhocik7Cgl9LAoKCWxvYWRzdGFydDogZnVuY3Rpb24oZXZlbnQpewoJCXRoaXMuZmlyZUV2ZW50KCdsb2Fkc3RhcnQnLCBbZXZlbnQsIHRoaXMueGhyXSk7Cgl9LAoKCXByb2dyZXNzOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ3Byb2dyZXNzJywgW2V2ZW50LCB0aGlzLnhocl0pOwoJfSwKCgl0aW1lb3V0OiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCd0aW1lb3V0JywgdGhpcy54aHIpOwoJfSwKCglzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKCQl0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0SGVhZGVyOiBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy54aHIuZ2V0UmVzcG9uc2VIZWFkZXIobmFtZSk7CgkJfS5iaW5kKHRoaXMpKTsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzZW5kOiBmdW5jdGlvbihvcHRpb25zKXsKCQlpZiAoIXRoaXMuY2hlY2sob3B0aW9ucykpIHJldHVybiB0aGlzOwoKCQl0aGlzLm9wdGlvbnMuaXNTdWNjZXNzID0gdGhpcy5vcHRpb25zLmlzU3VjY2VzcyB8fCB0aGlzLmlzU3VjY2VzczsKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKCQl2YXIgdHlwZSA9IHR5cGVPZihvcHRpb25zKTsKCQlpZiAodHlwZSA9PSAnc3RyaW5nJyB8fCB0eXBlID09ICdlbGVtZW50Jykgb3B0aW9ucyA9IHtkYXRhOiBvcHRpb25zfTsKCgkJdmFyIG9sZCA9IHRoaXMub3B0aW9uczsKCQlvcHRpb25zID0gT2JqZWN0LmFwcGVuZCh7ZGF0YTogb2xkLmRhdGEsIHVybDogb2xkLnVybCwgbWV0aG9kOiBvbGQubWV0aG9kfSwgb3B0aW9ucyk7CgkJdmFyIGRhdGEgPSBvcHRpb25zLmRhdGEsIHVybCA9IFN0cmluZyhvcHRpb25zLnVybCksIG1ldGhvZCA9IG9wdGlvbnMubWV0aG9kLnRvTG93ZXJDYXNlKCk7CgoJCXN3aXRjaCAodHlwZU9mKGRhdGEpKXsKCQkJY2FzZSAnZWxlbWVudCc6IGRhdGEgPSBkb2N1bWVudC5pZChkYXRhKS50b1F1ZXJ5U3RyaW5nKCk7IGJyZWFrOwoJCQljYXNlICdvYmplY3QnOiBjYXNlICdoYXNoJzogZGF0YSA9IE9iamVjdC50b1F1ZXJ5U3RyaW5nKGRhdGEpOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy5mb3JtYXQpewoJCQl2YXIgZm9ybWF0ID0gJ2Zvcm1hdD0nICsgdGhpcy5vcHRpb25zLmZvcm1hdDsKCQkJZGF0YSA9IChkYXRhKSA/IGZvcm1hdCArICcmJyArIGRhdGEgOiBmb3JtYXQ7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmVtdWxhdGlvbiAmJiAhWydnZXQnLCAncG9zdCddLmNvbnRhaW5zKG1ldGhvZCkpewoJCQl2YXIgX21ldGhvZCA9ICdfbWV0aG9kPScgKyBtZXRob2Q7CgkJCWRhdGEgPSAoZGF0YSkgPyBfbWV0aG9kICsgJyYnICsgZGF0YSA6IF9tZXRob2Q7CgkJCW1ldGhvZCA9ICdwb3N0JzsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMudXJsRW5jb2RlZCAmJiBbJ3Bvc3QnLCAncHV0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBlbmNvZGluZyA9ICh0aGlzLm9wdGlvbnMuZW5jb2RpbmcpID8gJzsgY2hhcnNldD0nICsgdGhpcy5vcHRpb25zLmVuY29kaW5nIDogJyc7CgkJCXRoaXMuaGVhZGVyc1snQ29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyArIGVuY29kaW5nOwoJCX0KCgkJaWYgKCF1cmwpIHVybCA9IGRvY3VtZW50LmxvY2F0aW9uLnBhdGhuYW1lOwoKCQl2YXIgdHJpbVBvc2l0aW9uID0gdXJsLmxhc3RJbmRleE9mKCcvJyk7CgkJaWYgKHRyaW1Qb3NpdGlvbiA+IC0xICYmICh0cmltUG9zaXRpb24gPSB1cmwuaW5kZXhPZignIycpKSA+IC0xKSB1cmwgPSB1cmwuc3Vic3RyKDAsIHRyaW1Qb3NpdGlvbik7CgoJCWlmICh0aGlzLm9wdGlvbnMubm9DYWNoZSkKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBTdHJpbmcudW5pcXVlSUQoKTsKCgkJaWYgKGRhdGEgJiYgbWV0aG9kID09ICdnZXQnKXsKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBkYXRhOwoJCQlkYXRhID0gbnVsbDsKCQl9CgoJCXZhciB4aHIgPSB0aGlzLnhocjsKCQlpZiAocHJvZ3Jlc3NTdXBwb3J0KXsKCQkJeGhyLm9ubG9hZHN0YXJ0ID0gdGhpcy5sb2Fkc3RhcnQuYmluZCh0aGlzKTsKCQkJeGhyLm9ucHJvZ3Jlc3MgPSB0aGlzLnByb2dyZXNzLmJpbmQodGhpcyk7CgkJfQoKCQl4aHIub3BlbihtZXRob2QudG9VcHBlckNhc2UoKSwgdXJsLCB0aGlzLm9wdGlvbnMuYXN5bmMsIHRoaXMub3B0aW9ucy51c2VyLCB0aGlzLm9wdGlvbnMucGFzc3dvcmQpOwoJCWlmICh0aGlzLm9wdGlvbnMudXNlciAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHIpIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwoKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7CgoJCU9iamVjdC5lYWNoKHRoaXMuaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCXRyeSB7CgkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKCQkJfSBjYXRjaCAoZSl7CgkJCQl0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgW2tleSwgdmFsdWVdKTsKCQkJfQoJCX0sIHRoaXMpOwoKCQl0aGlzLmZpcmVFdmVudCgncmVxdWVzdCcpOwoJCXhoci5zZW5kKGRhdGEpOwoJCWlmICghdGhpcy5vcHRpb25zLmFzeW5jKSB0aGlzLm9uU3RhdGVDaGFuZ2UoKTsKCQllbHNlIGlmICh0aGlzLm9wdGlvbnMudGltZW91dCkgdGhpcy50aW1lciA9IHRoaXMudGltZW91dC5kZWxheSh0aGlzLm9wdGlvbnMudGltZW91dCwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNhbmNlbDogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCXhoci5hYm9ydCgpOwoJCWNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLmZpcmVFdmVudCgnY2FuY2VsJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciBtZXRob2RzID0ge307ClsnZ2V0JywgJ3Bvc3QnLCAncHV0JywgJ2RlbGV0ZScsICdHRVQnLCAnUE9TVCcsICdQVVQnLCAnREVMRVRFJ10uZWFjaChmdW5jdGlvbihtZXRob2QpewoJbWV0aG9kc1ttZXRob2RdID0gZnVuY3Rpb24oZGF0YSl7CgkJdmFyIG9iamVjdCA9IHsKCQkJbWV0aG9kOiBtZXRob2QKCQl9OwoJCWlmIChkYXRhICE9IG51bGwpIG9iamVjdC5kYXRhID0gZGF0YTsKCQlyZXR1cm4gdGhpcy5zZW5kKG9iamVjdCk7Cgl9Owp9KTsKClJlcXVlc3QuaW1wbGVtZW50KG1ldGhvZHMpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnNlbmQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgc2VuZCA9IHRoaXMuZ2V0KCdzZW5kJykuY2FuY2VsKCk7CgkJc2VuZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHNlbmQgPSB0aGlzLnJldHJpZXZlKCdzZW5kJyk7CgkJaWYgKCFzZW5kKXsKCQkJc2VuZCA9IG5ldyBSZXF1ZXN0KHsKCQkJCWRhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCBtZXRob2Q6IHRoaXMuZ2V0KCdtZXRob2QnKSB8fCAncG9zdCcsIHVybDogdGhpcy5nZXQoJ2FjdGlvbicpCgkJCX0pOwoJCQl0aGlzLnN0b3JlKCdzZW5kJywgc2VuZCk7CgkJfQoJCXJldHVybiBzZW5kOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzZW5kOiBmdW5jdGlvbih1cmwpewoJCXZhciBzZW5kZXIgPSB0aGlzLmdldCgnc2VuZCcpOwoJCXNlbmRlci5zZW5kKHtkYXRhOiB0aGlzLCB1cmw6IHVybCB8fCBzZW5kZXIub3B0aW9ucy51cmx9KTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSFRNTAoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggSFRNTCByZXNwb25zZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgUmVxdWVzdF0KCnByb3ZpZGVzOiBSZXF1ZXN0LkhUTUwKCi4uLgoqLwoKUmVxdWVzdC5IVE1MID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQl1cGRhdGU6IGZhbHNlLAoJCWFwcGVuZDogZmFsc2UsCgkJZXZhbFNjcmlwdHM6IHRydWUsCgkJZmlsdGVyOiBmYWxzZSwKCQloZWFkZXJzOiB7CgkJCUFjY2VwdDogJ3RleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0KCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZTsKCgkJcmVzcG9uc2UuaHRtbCA9IHRleHQuc3RyaXBTY3JpcHRzKGZ1bmN0aW9uKHNjcmlwdCl7CgkJCXJlc3BvbnNlLmphdmFzY3JpcHQgPSBzY3JpcHQ7CgkJfSk7CgoJCXZhciBtYXRjaCA9IHJlc3BvbnNlLmh0bWwubWF0Y2goLzxib2R5W14+XSo+KFtcc1xTXSo/KTxcL2JvZHk+L2kpOwoJCWlmIChtYXRjaCkgcmVzcG9uc2UuaHRtbCA9IG1hdGNoWzFdOwoJCXZhciB0ZW1wID0gbmV3IEVsZW1lbnQoJ2RpdicpLnNldCgnaHRtbCcsIHJlc3BvbnNlLmh0bWwpOwoKCQlyZXNwb25zZS50cmVlID0gdGVtcC5jaGlsZE5vZGVzOwoJCXJlc3BvbnNlLmVsZW1lbnRzID0gdGVtcC5nZXRFbGVtZW50cyhvcHRpb25zLmZpbHRlciB8fCAnKicpOwoKCQlpZiAob3B0aW9ucy5maWx0ZXIpIHJlc3BvbnNlLnRyZWUgPSByZXNwb25zZS5lbGVtZW50czsKCQlpZiAob3B0aW9ucy51cGRhdGUpewoJCQl2YXIgdXBkYXRlID0gZG9jdW1lbnQuaWQob3B0aW9ucy51cGRhdGUpLmVtcHR5KCk7CgkJCWlmIChvcHRpb25zLmZpbHRlcikgdXBkYXRlLmFkb3B0KHJlc3BvbnNlLmVsZW1lbnRzKTsKCQkJZWxzZSB1cGRhdGUuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgkJfSBlbHNlIGlmIChvcHRpb25zLmFwcGVuZCl7CgkJCXZhciBhcHBlbmQgPSBkb2N1bWVudC5pZChvcHRpb25zLmFwcGVuZCk7CgkJCWlmIChvcHRpb25zLmZpbHRlcikgcmVzcG9uc2UuZWxlbWVudHMucmV2ZXJzZSgpLmluamVjdChhcHBlbmQpOwoJCQllbHNlIGFwcGVuZC5hZG9wdCh0ZW1wLmdldENoaWxkcmVuKCkpOwoJCX0KCQlpZiAob3B0aW9ucy5ldmFsU2NyaXB0cykgQnJvd3Nlci5leGVjKHJlc3BvbnNlLmphdmFzY3JpcHQpOwoKCQl0aGlzLm9uU3VjY2VzcyhyZXNwb25zZS50cmVlLCByZXNwb25zZS5lbGVtZW50cywgcmVzcG9uc2UuaHRtbCwgcmVzcG9uc2UuamF2YXNjcmlwdCk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5sb2FkID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIGxvYWQgPSB0aGlzLmdldCgnbG9hZCcpLmNhbmNlbCgpOwoJCWxvYWQuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciBsb2FkID0gdGhpcy5yZXRyaWV2ZSgnbG9hZCcpOwoJCWlmICghbG9hZCl7CgkJCWxvYWQgPSBuZXcgUmVxdWVzdC5IVE1MKHtkYXRhOiB0aGlzLCBsaW5rOiAnY2FuY2VsJywgdXBkYXRlOiB0aGlzLCBtZXRob2Q6ICdnZXQnfSk7CgkJCXRoaXMuc3RvcmUoJ2xvYWQnLCBsb2FkKTsKCQl9CgkJcmV0dXJuIGxvYWQ7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWxvYWQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5nZXQoJ2xvYWQnKS5zZW5kKEFycmF5LmxpbmsoYXJndW1lbnRzLCB7ZGF0YTogVHlwZS5pc09iamVjdCwgdXJsOiBUeXBlLmlzU3RyaW5nfSkpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBKU09OCgpkZXNjcmlwdGlvbjogSlNPTiBlbmNvZGVyIGFuZCBkZWNvZGVyLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpTZWVBbHNvOiA8aHR0cDovL3d3dy5qc29uLm9yZy8+CgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIE51bWJlciwgRnVuY3Rpb25dCgpwcm92aWRlczogSlNPTgoKLi4uCiovCgppZiAodHlwZW9mIEpTT04gPT0gJ3VuZGVmaW5lZCcpIHRoaXMuSlNPTiA9IHt9OwoKCgooZnVuY3Rpb24oKXsKCnZhciBzcGVjaWFsID0geydcYic6ICdcXGInLCAnXHQnOiAnXFx0JywgJ1xuJzogJ1xcbicsICdcZic6ICdcXGYnLCAnXHInOiAnXFxyJywgJyInIDogJ1xcIicsICdcXCc6ICdcXFxcJ307Cgp2YXIgZXNjYXBlID0gZnVuY3Rpb24oY2hyKXsKCXJldHVybiBzcGVjaWFsW2Nocl0gfHwgJ1xcdScgKyAoJzAwMDAnICsgY2hyLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpKS5zbGljZSgtNCk7Cn07CgpKU09OLnZhbGlkYXRlID0gZnVuY3Rpb24oc3RyaW5nKXsKCXN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICdAJykuCgkJCQkJcmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICddJykuCgkJCQkJcmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAnJyk7CgoJcmV0dXJuICgvXltcXSw6e31cc10qJC8pLnRlc3Qoc3RyaW5nKTsKfTsKCkpTT04uZW5jb2RlID0gSlNPTi5zdHJpbmdpZnkgPyBmdW5jdGlvbihvYmopewoJcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaik7Cn0gOiBmdW5jdGlvbihvYmopewoJaWYgKG9iaiAmJiBvYmoudG9KU09OKSBvYmogPSBvYmoudG9KU09OKCk7CgoJc3dpdGNoICh0eXBlT2Yob2JqKSl7CgkJY2FzZSAnc3RyaW5nJzoKCQkJcmV0dXJuICciJyArIG9iai5yZXBsYWNlKC9bXHgwMC1ceDFmXFwiXS9nLCBlc2NhcGUpICsgJyInOwoJCWNhc2UgJ2FycmF5JzoKCQkJcmV0dXJuICdbJyArIG9iai5tYXAoSlNPTi5lbmNvZGUpLmNsZWFuKCkgKyAnXSc7CgkJY2FzZSAnb2JqZWN0JzogY2FzZSAnaGFzaCc6CgkJCXZhciBzdHJpbmcgPSBbXTsKCQkJT2JqZWN0LmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJCXZhciBqc29uID0gSlNPTi5lbmNvZGUodmFsdWUpOwoJCQkJaWYgKGpzb24pIHN0cmluZy5wdXNoKEpTT04uZW5jb2RlKGtleSkgKyAnOicgKyBqc29uKTsKCQkJfSk7CgkJCXJldHVybiAneycgKyBzdHJpbmcgKyAnfSc7CgkJY2FzZSAnbnVtYmVyJzogY2FzZSAnYm9vbGVhbic6IHJldHVybiAnJyArIG9iajsKCQljYXNlICdudWxsJzogcmV0dXJuICdudWxsJzsKCX0KCglyZXR1cm4gbnVsbDsKfTsKCkpTT04uZGVjb2RlID0gZnVuY3Rpb24oc3RyaW5nLCBzZWN1cmUpewoJaWYgKCFzdHJpbmcgfHwgdHlwZU9mKHN0cmluZykgIT0gJ3N0cmluZycpIHJldHVybiBudWxsOwoKCWlmIChzZWN1cmUgfHwgSlNPTi5zZWN1cmUpewoJCWlmIChKU09OLnBhcnNlKSByZXR1cm4gSlNPTi5wYXJzZShzdHJpbmcpOwoJCWlmICghSlNPTi52YWxpZGF0ZShzdHJpbmcpKSB0aHJvdyBuZXcgRXJyb3IoJ0pTT04gY291bGQgbm90IGRlY29kZSB0aGUgaW5wdXQ7IHNlY3VyaXR5IGlzIGVuYWJsZWQgYW5kIHRoZSB2YWx1ZSBpcyBub3Qgc2VjdXJlLicpOwoJfQoKCXJldHVybiBldmFsKCcoJyArIHN0cmluZyArICcpJyk7Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdC5KU09OCgpkZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgYmFzaWMgUmVxdWVzdCBDbGFzcyB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcyBmb3Igc2VuZGluZyBhbmQgcmVjZWl2aW5nIEpTT04gZGF0YS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtSZXF1ZXN0LCBKU09OXQoKcHJvdmlkZXM6IFJlcXVlc3QuSlNPTgoKLi4uCiovCgpSZXF1ZXN0LkpTT04gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IFJlcXVlc3QsCgoJb3B0aW9uczogewoJCS8qb25FcnJvcjogZnVuY3Rpb24odGV4dCwgZXJyb3Ipe30sKi8KCQlzZWN1cmU6IHRydWUKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7CgkJT2JqZWN0LmFwcGVuZCh0aGlzLmhlYWRlcnMsIHsKCQkJJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKCQkJJ1gtUmVxdWVzdCc6ICdKU09OJwoJCX0pOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIganNvbjsKCQl0cnkgewoJCQlqc29uID0gdGhpcy5yZXNwb25zZS5qc29uID0gSlNPTi5kZWNvZGUodGV4dCwgdGhpcy5vcHRpb25zLnNlY3VyZSk7CgkJfSBjYXRjaCAoZXJyb3IpewoJCQl0aGlzLmZpcmVFdmVudCgnZXJyb3InLCBbdGV4dCwgZXJyb3JdKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoanNvbiA9PSBudWxsKSB0aGlzLm9uRmFpbHVyZSgpOwoJCWVsc2UgdGhpcy5vblN1Y2Nlc3MoanNvbiwgdGV4dCk7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IENvb2tpZQoKZGVzY3JpcHRpb246IENsYXNzIGZvciBjcmVhdGluZywgcmVhZGluZywgYW5kIGRlbGV0aW5nIGJyb3dzZXIgQ29va2llcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEJhc2VkIG9uIHRoZSBmdW5jdGlvbnMgYnkgUGV0ZXItUGF1bCBLb2NoIChodHRwOi8vcXVpcmtzbW9kZS5vcmcpLgoKcmVxdWlyZXM6IFtPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IENvb2tpZQoKLi4uCiovCgp2YXIgQ29va2llID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlwYXRoOiAnLycsCgkJZG9tYWluOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZSwKCQlkb2N1bWVudDogZG9jdW1lbnQsCgkJZW5jb2RlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGtleSwgb3B0aW9ucyl7CgkJdGhpcy5rZXkgPSBrZXk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCgl3cml0ZTogZnVuY3Rpb24odmFsdWUpewoJCWlmICh0aGlzLm9wdGlvbnMuZW5jb2RlKSB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJaWYgKHRoaXMub3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgdGhpcy5vcHRpb25zLmRvbWFpbjsKCQlpZiAodGhpcy5vcHRpb25zLnBhdGgpIHZhbHVlICs9ICc7IHBhdGg9JyArIHRoaXMub3B0aW9ucy5wYXRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pewoJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIDI0ICogNjAgKiA2MCAqIDEwMDApOwoJCQl2YWx1ZSArPSAnOyBleHBpcmVzPScgKyBkYXRlLnRvR01UU3RyaW5nKCk7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCXRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWFkOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUubWF0Y2goJyg/Ol58OylcXHMqJyArIHRoaXMua2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuICh2YWx1ZSkgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWVbMV0pIDogbnVsbDsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQluZXcgQ29va2llKHRoaXMua2V5LCBPYmplY3QubWVyZ2Uoe30sIHRoaXMub3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKS53cml0ZSgnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkNvb2tpZS53cml0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS53cml0ZSh2YWx1ZSk7Cn07CgpDb29raWUucmVhZCA9IGZ1bmN0aW9uKGtleSl7CglyZXR1cm4gbmV3IENvb2tpZShrZXkpLnJlYWQoKTsKfTsKCkNvb2tpZS5kaXNwb3NlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCXJldHVybiBuZXcgQ29va2llKGtleSwgb3B0aW9ucykuZGlzcG9zZSgpOwp9OwoKCi8qCi0tLQoKbmFtZTogRE9NUmVhZHkKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgY3VzdG9tIGV2ZW50IGRvbXJlYWR5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0Jyb3dzZXIsIEVsZW1lbnQsIEVsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0RPTVJlYWR5LCBEb21SZWFkeV0KCi4uLgoqLwoKKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQpewoKdmFyIHJlYWR5LAoJbG9hZGVkLAoJY2hlY2tzID0gW10sCglzaG91bGRQb2xsLAoJdGltZXIsCgl0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKdmFyIGRvbXJlYWR5ID0gZnVuY3Rpb24oKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CglpZiAocmVhZHkpIHJldHVybjsKCUJyb3dzZXIubG9hZGVkID0gcmVhZHkgPSB0cnVlOwoJZG9jdW1lbnQucmVtb3ZlTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSkucmVtb3ZlTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CgoJZG9jdW1lbnQuZmlyZUV2ZW50KCdkb21yZWFkeScpOwoJd2luZG93LmZpcmVFdmVudCgnZG9tcmVhZHknKTsKfTsKCnZhciBjaGVjayA9IGZ1bmN0aW9uKCl7Cglmb3IgKHZhciBpID0gY2hlY2tzLmxlbmd0aDsgaS0tOykgaWYgKGNoZWNrc1tpXSgpKXsKCQlkb21yZWFkeSgpOwoJCXJldHVybiB0cnVlOwoJfQoJcmV0dXJuIGZhbHNlOwp9OwoKdmFyIHBvbGwgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmICghY2hlY2soKSkgdGltZXIgPSBzZXRUaW1lb3V0KHBvbGwsIDEwKTsKfTsKCmRvY3VtZW50LmFkZExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZG9tcmVhZHkpOwoKLyo8bHRJRTg+Ki8KLy8gZG9TY3JvbGwgdGVjaG5pcXVlIGJ5IERpZWdvIFBlcmluaSBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwovLyB0ZXN0RWxlbWVudC5kb1Njcm9sbCgpIHRocm93cyB3aGVuIHRoZSBET00gaXMgbm90IHJlYWR5LCBvbmx5IGluIHRoZSB0b3Agd2luZG93CnZhciBkb1Njcm9sbFdvcmtzID0gZnVuY3Rpb24oKXsKCXRyeSB7CgkJdGVzdEVsZW1lbnQuZG9TY3JvbGwoKTsKCQlyZXR1cm4gdHJ1ZTsKCX0gY2F0Y2ggKGUpe30KCXJldHVybiBmYWxzZTsKfTsKLy8gSWYgZG9TY3JvbGwgd29ya3MgYWxyZWFkeSwgaXQgY2FuJ3QgYmUgdXNlZCB0byBkZXRlcm1pbmUgZG9tcmVhZHkKLy8gICBlLmcuIGluIGFuIGlmcmFtZQppZiAodGVzdEVsZW1lbnQuZG9TY3JvbGwgJiYgIWRvU2Nyb2xsV29ya3MoKSl7CgljaGVja3MucHVzaChkb1Njcm9sbFdvcmtzKTsKCXNob3VsZFBvbGwgPSB0cnVlOwp9Ci8qPC9sdElFOD4qLwoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUpIGNoZWNrcy5wdXNoKGZ1bmN0aW9uKCl7Cgl2YXIgc3RhdGUgPSBkb2N1bWVudC5yZWFkeVN0YXRlOwoJcmV0dXJuIChzdGF0ZSA9PSAnbG9hZGVkJyB8fCBzdGF0ZSA9PSAnY29tcGxldGUnKTsKfSk7CgppZiAoJ29ucmVhZHlzdGF0ZWNoYW5nZScgaW4gZG9jdW1lbnQpIGRvY3VtZW50LmFkZExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgY2hlY2spOwplbHNlIHNob3VsZFBvbGwgPSB0cnVlOwoKaWYgKHNob3VsZFBvbGwpIHBvbGwoKTsKCkVsZW1lbnQuRXZlbnRzLmRvbXJlYWR5ID0gewoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAocmVhZHkpIGZuLmNhbGwodGhpcyk7Cgl9Cn07CgovLyBNYWtlIHN1cmUgdGhhdCBkb21yZWFkeSBmaXJlcyBiZWZvcmUgbG9hZApFbGVtZW50LkV2ZW50cy5sb2FkID0gewoJYmFzZTogJ2xvYWQnLAoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAobG9hZGVkICYmIHRoaXMgPT0gd2luZG93KSBmbi5jYWxsKHRoaXMpOwoJfSwKCWNvbmRpdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcyA9PSB3aW5kb3cpewoJCQlkb21yZWFkeSgpOwoJCQlkZWxldGUgRWxlbWVudC5FdmVudHMubG9hZDsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9Cn07CgovLyBUaGlzIGlzIGJhc2VkIG9uIHRoZSBjdXN0b20gbG9hZCBldmVudAp3aW5kb3cuYWRkRXZlbnQoJ2xvYWQnLCBmdW5jdGlvbigpewoJbG9hZGVkID0gdHJ1ZTsKfSk7Cgp9KSh3aW5kb3csIGRvY3VtZW50KTsKCgovKgotLS0KCm5hbWU6IFN3aWZmCgpkZXNjcmlwdGlvbjogV3JhcHBlciBmb3IgZW1iZWRkaW5nIFNXRiBtb3ZpZXMuIFN1cHBvcnRzIEV4dGVybmFsIEludGVyZmFjZSBDb21tdW5pY2F0aW9uLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRmxhc2ggZGV0ZWN0aW9uICYgSW50ZXJuZXQgRXhwbG9yZXIgKyBGbGFzaCBQbGF5ZXIgOSBmaXggaW5zcGlyZWQgYnkgU1dGT2JqZWN0LgoKcmVxdWlyZXM6IFtPcHRpb25zLCBPYmplY3QsIEVsZW1lbnRdCgpwcm92aWRlczogU3dpZmYKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgU3dpZmYgPSB0aGlzLlN3aWZmID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlpZDogbnVsbCwKCQloZWlnaHQ6IDEsCgkJd2lkdGg6IDEsCgkJY29udGFpbmVyOiBudWxsLAoJCXByb3BlcnRpZXM6IHt9LAoJCXBhcmFtczogewoJCQlxdWFsaXR5OiAnaGlnaCcsCgkJCWFsbG93U2NyaXB0QWNjZXNzOiAnYWx3YXlzJywKCQkJd01vZGU6ICd3aW5kb3cnLAoJCQlzd0xpdmVDb25uZWN0OiB0cnVlCgkJfSwKCQljYWxsQmFja3M6IHt9LAoJCXZhcnM6IHt9Cgl9LAoKCXRvRWxlbWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vYmplY3Q7Cgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKHBhdGgsIG9wdGlvbnMpewoJCXRoaXMuaW5zdGFuY2UgPSAnU3dpZmZfJyArIFN0cmluZy51bmlxdWVJRCgpOwoKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCQl2YXIgaWQgPSB0aGlzLmlkID0gb3B0aW9ucy5pZCB8fCB0aGlzLmluc3RhbmNlOwoJCXZhciBjb250YWluZXIgPSBkb2N1bWVudC5pZChvcHRpb25zLmNvbnRhaW5lcik7CgoJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXSA9IHt9OwoKCQl2YXIgcGFyYW1zID0gb3B0aW9ucy5wYXJhbXMsIHZhcnMgPSBvcHRpb25zLnZhcnMsIGNhbGxCYWNrcyA9IG9wdGlvbnMuY2FsbEJhY2tzOwoJCXZhciBwcm9wZXJ0aWVzID0gT2JqZWN0LmFwcGVuZCh7aGVpZ2h0OiBvcHRpb25zLmhlaWdodCwgd2lkdGg6IG9wdGlvbnMud2lkdGh9LCBvcHRpb25zLnByb3BlcnRpZXMpOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWZvciAodmFyIGNhbGxCYWNrIGluIGNhbGxCYWNrcyl7CgkJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXVtjYWxsQmFja10gPSAoZnVuY3Rpb24ob3B0aW9uKXsKCQkJCXJldHVybiBmdW5jdGlvbigpewoJCQkJCXJldHVybiBvcHRpb24uYXBwbHkoc2VsZi5vYmplY3QsIGFyZ3VtZW50cyk7CgkJCQl9OwoJCQl9KShjYWxsQmFja3NbY2FsbEJhY2tdKTsKCQkJdmFyc1tjYWxsQmFja10gPSAnU3dpZmYuQ2FsbEJhY2tzLicgKyB0aGlzLmluc3RhbmNlICsgJy4nICsgY2FsbEJhY2s7CgkJfQoKCQlwYXJhbXMuZmxhc2hWYXJzID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFycyk7CgkJaWYgKEJyb3dzZXIuaWUpewoJCQlwcm9wZXJ0aWVzLmNsYXNzaWQgPSAnY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwJzsKCQkJcGFyYW1zLm1vdmllID0gcGF0aDsKCQl9IGVsc2UgewoJCQlwcm9wZXJ0aWVzLnR5cGUgPSAnYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2gnOwoJCX0KCQlwcm9wZXJ0aWVzLmRhdGEgPSBwYXRoOwoKCQl2YXIgYnVpbGQgPSAnPG9iamVjdCBpZD0iJyArIGlkICsgJyInOwoJCWZvciAodmFyIHByb3BlcnR5IGluIHByb3BlcnRpZXMpIGJ1aWxkICs9ICcgJyArIHByb3BlcnR5ICsgJz0iJyArIHByb3BlcnRpZXNbcHJvcGVydHldICsgJyInOwoJCWJ1aWxkICs9ICc+JzsKCQlmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpewoJCQlpZiAocGFyYW1zW3BhcmFtXSkgYnVpbGQgKz0gJzxwYXJhbSBuYW1lPSInICsgcGFyYW0gKyAnIiB2YWx1ZT0iJyArIHBhcmFtc1twYXJhbV0gKyAnIiAvPic7CgkJfQoJCWJ1aWxkICs9ICc8L29iamVjdD4nOwoJCXRoaXMub2JqZWN0ID0gKChjb250YWluZXIpID8gY29udGFpbmVyLmVtcHR5KCkgOiBuZXcgRWxlbWVudCgnZGl2JykpLnNldCgnaHRtbCcsIGJ1aWxkKS5maXJzdENoaWxkOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJZWxlbWVudCA9IGRvY3VtZW50LmlkKGVsZW1lbnQsIHRydWUpOwoJCWVsZW1lbnQucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy50b0VsZW1lbnQoKSwgZWxlbWVudCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWxlbWVudCl7CgkJZG9jdW1lbnQuaWQoZWxlbWVudCwgdHJ1ZSkuYXBwZW5kQ2hpbGQodGhpcy50b0VsZW1lbnQoKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW90ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3dpZmYucmVtb3RlLmFwcGx5KFN3aWZmLCBbdGhpcy50b0VsZW1lbnQoKV0uYXBwZW5kKGFyZ3VtZW50cykpOwoJfQoKfSk7CgpTd2lmZi5DYWxsQmFja3MgPSB7fTsKClN3aWZmLnJlbW90ZSA9IGZ1bmN0aW9uKG9iaiwgZm4pewoJdmFyIHJzID0gb2JqLkNhbGxGdW5jdGlvbignPGludm9rZSBuYW1lPSInICsgZm4gKyAnIiByZXR1cm50eXBlPSJqYXZhc2NyaXB0Ij4nICsgX19mbGFzaF9fYXJndW1lbnRzVG9YTUwoYXJndW1lbnRzLCAyKSArICc8L2ludm9rZT4nKTsKCXJldHVybiBldmFsKHJzKTsKfTsKCn0pKCk7Cgo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 03:11:27 GMT",
                    "Content-Length": "150812",
                    "Date": "Fri, 07 Nov 2014 03:11:29 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}