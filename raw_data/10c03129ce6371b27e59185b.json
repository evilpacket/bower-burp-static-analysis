{
    "url": "http://localhost:9999/piwik/piwik/tests/javascript/frameworks/mootools/mootools-1.3.1.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>url = document.location.pathname;</li><li>url = url.substr(0, trimPosition);</li><li>xhr.open(method.toUpperCase(), url, this.options.async, this.options.user, this.options.password);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/piwik/piwik/tests/javascript/frameworks/mootools/mootools-1.3.1.js",
                "path": "/piwik/piwik/tests/javascript/frameworks/mootools/mootools-1.3.1.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9waXdpay9waXdpay90ZXN0cy9qYXZhc2NyaXB0L2ZyYW1ld29ya3MvbW9vdG9vbHMvbW9vdG9vbHMtMS4zLjEuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTM2MTk2DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDIyOjA3OjMyIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAyMjowNzoxNCBHTVQNCg0KLyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzdjNTZjZmVmOWRkZGNmMTcwYTVkNjhlM2ZiNjFjZmQ3CgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi8qCi0tLQoKbmFtZTogQ29yZQoKZGVzY3JpcHRpb246IFRoZSBoZWFydCBvZiBNb29Ub29scy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY29weXJpZ2h0OiBDb3B5cmlnaHQgKGMpIDIwMDYtMjAxMCBbVmFsZXJpbyBQcm9pZXR0aV0oaHR0cDovL21hZDRtaWxrLm5ldC8pLgoKYXV0aG9yczogVGhlIE1vb1Rvb2xzIHByb2R1Y3Rpb24gdGVhbSAoaHR0cDovL21vb3Rvb2xzLm5ldC9kZXZlbG9wZXJzLykKCmluc3BpcmF0aW9uOgogIC0gQ2xhc3MgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0Jhc2UuanNdKGh0dHA6Ly9kZWFuLmVkd2FyZHMubmFtZS93ZWJsb2cvMjAwNi8wMy9iYXNlLykgQ29weXJpZ2h0IChjKSAyMDA2IERlYW4gRWR3YXJkcywgW0dOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2xncGwtbGljZW5zZS5waHApCiAgLSBTb21lIGZ1bmN0aW9uYWxpdHkgaW5zcGlyZWQgYnkgW1Byb3RvdHlwZS5qc10oaHR0cDovL3Byb3RvdHlwZWpzLm9yZykgQ29weXJpZ2h0IChjKSAyMDA1LTIwMDcgU2FtIFN0ZXBoZW5zb24sIFtNSVQgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCnByb3ZpZGVzOiBbQ29yZSwgTW9vVG9vbHMsIFR5cGUsIHR5cGVPZiwgaW5zdGFuY2VPZiwgTmF0aXZlXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnRoaXMuTW9vVG9vbHMgPSB7Cgl2ZXJzaW9uOiAnMS4zLjEnLAoJYnVpbGQ6ICdhZjQ4YzhkNTg5ZjQzZjMyMjEyZjliYjhmZjY4YTEyN2U2YTNiYTZjJwp9OwoKLy8gdHlwZU9mLCBpbnN0YW5jZU9mCgp2YXIgdHlwZU9mID0gdGhpcy50eXBlT2YgPSBmdW5jdGlvbihpdGVtKXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiAnbnVsbCc7CglpZiAoaXRlbS4kZmFtaWx5KSByZXR1cm4gaXRlbS4kZmFtaWx5KCk7CgoJaWYgKGl0ZW0ubm9kZU5hbWUpewoJCWlmIChpdGVtLm5vZGVUeXBlID09IDEpIHJldHVybiAnZWxlbWVudCc7CgkJaWYgKGl0ZW0ubm9kZVR5cGUgPT0gMykgcmV0dXJuICgvXFMvKS50ZXN0KGl0ZW0ubm9kZVZhbHVlKSA/ICd0ZXh0bm9kZScgOiAnd2hpdGVzcGFjZSc7Cgl9IGVsc2UgaWYgKHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyl7CgkJaWYgKGl0ZW0uY2FsbGVlKSByZXR1cm4gJ2FyZ3VtZW50cyc7CgkJaWYgKCdpdGVtJyBpbiBpdGVtKSByZXR1cm4gJ2NvbGxlY3Rpb24nOwoJfQoKCXJldHVybiB0eXBlb2YgaXRlbTsKfTsKCnZhciBpbnN0YW5jZU9mID0gdGhpcy5pbnN0YW5jZU9mID0gZnVuY3Rpb24oaXRlbSwgb2JqZWN0KXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiBmYWxzZTsKCXZhciBjb25zdHJ1Y3RvciA9IGl0ZW0uJGNvbnN0cnVjdG9yIHx8IGl0ZW0uY29uc3RydWN0b3I7Cgl3aGlsZSAoY29uc3RydWN0b3IpewoJCWlmIChjb25zdHJ1Y3RvciA9PT0gb2JqZWN0KSByZXR1cm4gdHJ1ZTsKCQljb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yLnBhcmVudDsKCX0KCXJldHVybiBpdGVtIGluc3RhbmNlb2Ygb2JqZWN0Owp9OwoKLy8gRnVuY3Rpb24gb3ZlcmxvYWRpbmcKCnZhciBGdW5jdGlvbiA9IHRoaXMuRnVuY3Rpb247Cgp2YXIgZW51bWVyYWJsZXMgPSB0cnVlOwpmb3IgKHZhciBpIGluIHt0b1N0cmluZzogMX0pIGVudW1lcmFibGVzID0gbnVsbDsKaWYgKGVudW1lcmFibGVzKSBlbnVtZXJhYmxlcyA9IFsnaGFzT3duUHJvcGVydHknLCAndmFsdWVPZicsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ2NvbnN0cnVjdG9yJ107CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRTZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewoJCWlmIChhID09IG51bGwpIHJldHVybiB0aGlzOwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpewoJCQlmb3IgKHZhciBrIGluIGEpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJaWYgKGVudW1lcmFibGVzKSBmb3IgKHZhciBpID0gZW51bWVyYWJsZXMubGVuZ3RoOyBpLS07KXsKCQkJCWsgPSBlbnVtZXJhYmxlc1tpXTsKCQkJCWlmIChhLmhhc093blByb3BlcnR5KGspKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCX0KCQl9IGVsc2UgewoJCQlzZWxmLmNhbGwodGhpcywgYSwgYik7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZEdldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSl7CgkJdmFyIGFyZ3MsIHJlc3VsdDsKCQlpZiAodXNlUGx1cmFsIHx8IHR5cGVvZiBhICE9ICdzdHJpbmcnKSBhcmdzID0gYTsKCQllbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgYXJncyA9IGFyZ3VtZW50czsKCQlpZiAoYXJncyl7CgkJCXJlc3VsdCA9IHt9OwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHJlc3VsdFthcmdzW2ldXSA9IHNlbGYuY2FsbCh0aGlzLCBhcmdzW2ldKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSBzZWxmLmNhbGwodGhpcywgYSk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpc1trZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXMucHJvdG90eXBlW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKLy8gRnJvbQoKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKRnVuY3Rpb24uZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gJ2Z1bmN0aW9uJykgPyBpdGVtIDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gaXRlbTsKCX07Cn07CgpBcnJheS5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gW107CglyZXR1cm4gKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pICYmIHR5cGVvZiBpdGVtICE9ICdzdHJpbmcnKSA/ICh0eXBlT2YoaXRlbSkgPT0gJ2FycmF5JykgPyBpdGVtIDogc2xpY2UuY2FsbChpdGVtKSA6IFtpdGVtXTsKfTsKCk51bWJlci5mcm9tID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgbnVtYmVyID0gcGFyc2VGbG9hdChpdGVtKTsKCXJldHVybiBpc0Zpbml0ZShudW1iZXIpID8gbnVtYmVyIDogbnVsbDsKfTsKClN0cmluZy5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbSArICcnOwp9OwoKLy8gaGlkZSwgcHJvdGVjdAoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgloaWRlOiBmdW5jdGlvbigpewoJCXRoaXMuJGhpZGRlbiA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByb3RlY3Q6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kcHJvdGVjdGVkID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gVHlwZQoKdmFyIFR5cGUgPSB0aGlzLlR5cGUgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QpewoJaWYgKG5hbWUpewoJCXZhciBsb3dlciA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQl2YXIgdHlwZUNoZWNrID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiAodHlwZU9mKGl0ZW0pID09IGxvd2VyKTsKCQl9OwoKCQlUeXBlWydpcycgKyBuYW1lXSA9IHR5cGVDaGVjazsKCQlpZiAob2JqZWN0ICE9IG51bGwpewoJCQlvYmplY3QucHJvdG90eXBlLiRmYW1pbHkgPSAoZnVuY3Rpb24oKXsKCQkJCXJldHVybiBsb3dlcjsKCQkJfSkuaGlkZSgpOwoKCQl9Cgl9CgoJaWYgKG9iamVjdCA9PSBudWxsKSByZXR1cm4gbnVsbDsKCglvYmplY3QuZXh0ZW5kKHRoaXMpOwoJb2JqZWN0LiRjb25zdHJ1Y3RvciA9IFR5cGU7CglvYmplY3QucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG9iamVjdDsKCglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKClR5cGUuaXNFbnVtZXJhYmxlID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gKGl0ZW0gIT0gbnVsbCAmJiB0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicgJiYgdG9TdHJpbmcuY2FsbChpdGVtKSAhPSAnW29iamVjdCBGdW5jdGlvbl0nICk7Cn07Cgp2YXIgaG9va3MgPSB7fTsKCnZhciBob29rc09mID0gZnVuY3Rpb24ob2JqZWN0KXsKCXZhciB0eXBlID0gdHlwZU9mKG9iamVjdC5wcm90b3R5cGUpOwoJcmV0dXJuIGhvb2tzW3R5cGVdIHx8IChob29rc1t0eXBlXSA9IFtdKTsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuOwoKCXZhciBob29rcyA9IGhvb2tzT2YodGhpcyk7CgoJZm9yICh2YXIgaSA9IDA7IGkgPCBob29rcy5sZW5ndGg7IGkrKyl7CgkJdmFyIGhvb2sgPSBob29rc1tpXTsKCQlpZiAodHlwZU9mKGhvb2spID09ICd0eXBlJykgaW1wbGVtZW50LmNhbGwoaG9vaywgbmFtZSwgbWV0aG9kKTsKCQllbHNlIGhvb2suY2FsbCh0aGlzLCBuYW1lLCBtZXRob2QpOwoJfQoKCXZhciBwcmV2aW91cyA9IHRoaXMucHJvdG90eXBlW25hbWVdOwoJaWYgKHByZXZpb3VzID09IG51bGwgfHwgIXByZXZpb3VzLiRwcm90ZWN0ZWQpIHRoaXMucHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoKCWlmICh0aGlzW25hbWVdID09IG51bGwgJiYgdHlwZU9mKG1ldGhvZCkgPT0gJ2Z1bmN0aW9uJykgZXh0ZW5kLmNhbGwodGhpcywgbmFtZSwgZnVuY3Rpb24oaXRlbSl7CgkJcmV0dXJuIG1ldGhvZC5hcHBseShpdGVtLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJfSk7Cn07Cgp2YXIgZXh0ZW5kID0gZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWlmIChtZXRob2QgJiYgbWV0aG9kLiRoaWRkZW4pIHJldHVybjsKCXZhciBwcmV2aW91cyA9IHRoaXNbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpc1tuYW1lXSA9IG1ldGhvZDsKfTsKClR5cGUuaW1wbGVtZW50KHsKCglpbXBsZW1lbnQ6IGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpLAoKCWV4dGVuZDogZXh0ZW5kLm92ZXJsb2FkU2V0dGVyKCksCgoJYWxpYXM6IGZ1bmN0aW9uKG5hbWUsIGV4aXN0aW5nKXsKCQlpbXBsZW1lbnQuY2FsbCh0aGlzLCBuYW1lLCB0aGlzLnByb3RvdHlwZVtleGlzdGluZ10pOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCW1pcnJvcjogZnVuY3Rpb24oaG9vayl7CgkJaG9va3NPZih0aGlzKS5wdXNoKGhvb2spOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpuZXcgVHlwZSgnVHlwZScsIFR5cGUpOwoKLy8gRGVmYXVsdCBUeXBlcwoKdmFyIGZvcmNlID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0LCBtZXRob2RzKXsKCXZhciBpc1R5cGUgPSAob2JqZWN0ICE9IE9iamVjdCksCgkJcHJvdG90eXBlID0gb2JqZWN0LnByb3RvdHlwZTsKCglpZiAoaXNUeXBlKSBvYmplY3QgPSBuZXcgVHlwZShuYW1lLCBvYmplY3QpOwoKCWZvciAodmFyIGkgPSAwLCBsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCXZhciBrZXkgPSBtZXRob2RzW2ldLAoJCQlnZW5lcmljID0gb2JqZWN0W2tleV0sCgkJCXByb3RvID0gcHJvdG90eXBlW2tleV07CgoJCWlmIChnZW5lcmljKSBnZW5lcmljLnByb3RlY3QoKTsKCgkJaWYgKGlzVHlwZSAmJiBwcm90byl7CgkJCWRlbGV0ZSBwcm90b3R5cGVba2V5XTsKCQkJcHJvdG90eXBlW2tleV0gPSBwcm90by5wcm90ZWN0KCk7CgkJfQoJfQoKCWlmIChpc1R5cGUpIG9iamVjdC5pbXBsZW1lbnQocHJvdG90eXBlKTsKCglyZXR1cm4gZm9yY2U7Cn07Cgpmb3JjZSgnU3RyaW5nJywgU3RyaW5nLCBbCgknY2hhckF0JywgJ2NoYXJDb2RlQXQnLCAnY29uY2F0JywgJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAnbWF0Y2gnLCAncXVvdGUnLCAncmVwbGFjZScsICdzZWFyY2gnLAoJJ3NsaWNlJywgJ3NwbGl0JywgJ3N1YnN0cicsICdzdWJzdHJpbmcnLCAndG9Mb3dlckNhc2UnLCAndG9VcHBlckNhc2UnCl0pKCdBcnJheScsIEFycmF5LCBbCgkncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJywKCSdpbmRleE9mJywgJ2xhc3RJbmRleE9mJywgJ2ZpbHRlcicsICdmb3JFYWNoJywgJ2V2ZXJ5JywgJ21hcCcsICdzb21lJywgJ3JlZHVjZScsICdyZWR1Y2VSaWdodCcKXSkoJ051bWJlcicsIE51bWJlciwgWwoJJ3RvRXhwb25lbnRpYWwnLCAndG9GaXhlZCcsICd0b0xvY2FsZVN0cmluZycsICd0b1ByZWNpc2lvbicKXSkoJ0Z1bmN0aW9uJywgRnVuY3Rpb24sIFsKCSdhcHBseScsICdjYWxsJywgJ2JpbmQnCl0pKCdSZWdFeHAnLCBSZWdFeHAsIFsKCSdleGVjJywgJ3Rlc3QnCl0pKCdPYmplY3QnLCBPYmplY3QsIFsKCSdjcmVhdGUnLCAnZGVmaW5lUHJvcGVydHknLCAnZGVmaW5lUHJvcGVydGllcycsICdrZXlzJywKCSdnZXRQcm90b3R5cGVPZicsICdnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3InLCAnZ2V0T3duUHJvcGVydHlOYW1lcycsCgkncHJldmVudEV4dGVuc2lvbnMnLCAnaXNFeHRlbnNpYmxlJywgJ3NlYWwnLCAnaXNTZWFsZWQnLCAnZnJlZXplJywgJ2lzRnJvemVuJwpdKSgnRGF0ZScsIERhdGUsIFsnbm93J10pOwoKT2JqZWN0LmV4dGVuZCA9IGV4dGVuZC5vdmVybG9hZFNldHRlcigpOwoKRGF0ZS5leHRlbmQoJ25vdycsIGZ1bmN0aW9uKCl7CglyZXR1cm4gKyhuZXcgRGF0ZSk7Cn0pOwoKbmV3IFR5cGUoJ0Jvb2xlYW4nLCBCb29sZWFuKTsKCi8vIGZpeGVzIE5hTiByZXR1cm5pbmcgYXMgTnVtYmVyCgpOdW1iZXIucHJvdG90eXBlLiRmYW1pbHkgPSBmdW5jdGlvbigpewoJcmV0dXJuIGlzRmluaXRlKHRoaXMpID8gJ251bWJlcicgOiAnbnVsbCc7Cn0uaGlkZSgpOwoKLy8gTnVtYmVyLnJhbmRvbQoKTnVtYmVyLmV4dGVuZCgncmFuZG9tJywgZnVuY3Rpb24obWluLCBtYXgpewoJcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSArIG1pbik7Cn0pOwoKLy8gZm9yRWFjaCwgZWFjaAoKdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKT2JqZWN0LmV4dGVuZCgnZm9yRWFjaCcsIGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSBmbi5jYWxsKGJpbmQsIG9iamVjdFtrZXldLCBrZXksIG9iamVjdCk7Cgl9Cn0pOwoKT2JqZWN0LmVhY2ggPSBPYmplY3QuZm9yRWFjaDsKCkFycmF5LmltcGxlbWVudCh7CgoJZm9yRWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJCX0KCX0sCgoJZWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCUFycmF5LmZvckVhY2godGhpcywgZm4sIGJpbmQpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBBcnJheSAmIE9iamVjdCBjbG9uaW5nLCBPYmplY3QgbWVyZ2luZyBhbmQgYXBwZW5kaW5nCgp2YXIgY2xvbmVPZiA9IGZ1bmN0aW9uKGl0ZW0pewoJc3dpdGNoICh0eXBlT2YoaXRlbSkpewoJCWNhc2UgJ2FycmF5JzogcmV0dXJuIGl0ZW0uY2xvbmUoKTsKCQljYXNlICdvYmplY3QnOiByZXR1cm4gT2JqZWN0LmNsb25lKGl0ZW0pOwoJCWRlZmF1bHQ6IHJldHVybiBpdGVtOwoJfQp9OwoKQXJyYXkuaW1wbGVtZW50KCdjbG9uZScsIGZ1bmN0aW9uKCl7Cgl2YXIgaSA9IHRoaXMubGVuZ3RoLCBjbG9uZSA9IG5ldyBBcnJheShpKTsKCXdoaWxlIChpLS0pIGNsb25lW2ldID0gY2xvbmVPZih0aGlzW2ldKTsKCXJldHVybiBjbG9uZTsKfSk7Cgp2YXIgbWVyZ2VPbmUgPSBmdW5jdGlvbihzb3VyY2UsIGtleSwgY3VycmVudCl7Cglzd2l0Y2ggKHR5cGVPZihjdXJyZW50KSl7CgkJY2FzZSAnb2JqZWN0JzoKCQkJaWYgKHR5cGVPZihzb3VyY2Vba2V5XSkgPT0gJ29iamVjdCcpIE9iamVjdC5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CgkJCWVsc2Ugc291cmNlW2tleV0gPSBPYmplY3QuY2xvbmUoY3VycmVudCk7CgkJYnJlYWs7CgkJY2FzZSAnYXJyYXknOiBzb3VyY2Vba2V5XSA9IGN1cnJlbnQuY2xvbmUoKTsgYnJlYWs7CgkJZGVmYXVsdDogc291cmNlW2tleV0gPSBjdXJyZW50OwoJfQoJcmV0dXJuIHNvdXJjZTsKfTsKCk9iamVjdC5leHRlbmQoewoKCW1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewoJCWlmICh0eXBlT2YoaykgPT0gJ3N0cmluZycpIHJldHVybiBtZXJnZU9uZShzb3VyY2UsIGssIHYpOwoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBvYmplY3QgPSBhcmd1bWVudHNbaV07CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiBzb3VyY2U7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciBjbG9uZSA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIGNsb25lW2tleV0gPSBjbG9uZU9mKG9iamVjdFtrZXldKTsKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWFwcGVuZDogZnVuY3Rpb24ob3JpZ2luYWwpewoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBleHRlbmRlZCA9IGFyZ3VtZW50c1tpXSB8fCB7fTsKCQkJZm9yICh2YXIga2V5IGluIGV4dGVuZGVkKSBvcmlnaW5hbFtrZXldID0gZXh0ZW5kZWRba2V5XTsKCQl9CgkJcmV0dXJuIG9yaWdpbmFsOwoJfQoKfSk7CgovLyBPYmplY3QtbGVzcyB0eXBlcwoKWydPYmplY3QnLCAnV2hpdGVTcGFjZScsICdUZXh0Tm9kZScsICdDb2xsZWN0aW9uJywgJ0FyZ3VtZW50cyddLmVhY2goZnVuY3Rpb24obmFtZSl7CgluZXcgVHlwZShuYW1lKTsKfSk7CgovLyBVbmlxdWUgSUQKCnZhciBVSUQgPSBEYXRlLm5vdygpOwoKU3RyaW5nLmV4dGVuZCgndW5pcXVlSUQnLCBmdW5jdGlvbigpewoJcmV0dXJuIChVSUQrKykudG9TdHJpbmcoMzYpOwp9KTsKCn0pLmNhbGwodGhpcyk7CgovKgotLS0KCm5hbWU6IEFycmF5CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgQXJyYXkgUHJvdG90eXBlcyBsaWtlIGVhY2gsIGNvbnRhaW5zLCBhbmQgZXJhc2UuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogQXJyYXkKCi4uLgoqLwoKQXJyYXkuaW1wbGVtZW50KHsKCglpbnZva2U6IGZ1bmN0aW9uKG1ldGhvZE5hbWUpewoJCXZhciBhcmdzID0gQXJyYXkuc2xpY2UoYXJndW1lbnRzLCAxKTsKCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtW21ldGhvZE5hbWVdLmFwcGx5KGl0ZW0sIGFyZ3MpOwoJCX0pOwoJfSwKCglldmVyeTogZnVuY3Rpb24oZm4sIGJpbmQpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoKGkgaW4gdGhpcykgJiYgIWZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXZhciByZXN1bHRzID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmICgoaSBpbiB0aGlzKSAmJiBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXN1bHRzLnB1c2godGhpc1tpXSk7CgkJfQoJCXJldHVybiByZXN1bHRzOwoJfSwKCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtICE9IG51bGw7CgkJfSk7Cgl9LAoKCWluZGV4T2Y6IGZ1bmN0aW9uKGl0ZW0sIGZyb20pewoJCXZhciBsZW4gPSB0aGlzLmxlbmd0aDsKCQlmb3IgKHZhciBpID0gKGZyb20gPCAwKSA/IE1hdGgubWF4KDAsIGxlbiArIGZyb20pIDogZnJvbSB8fCAwOyBpIDwgbGVuOyBpKyspewoJCQlpZiAodGhpc1tpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CgkJfQoJCXJldHVybiAtMTsKCX0sCgoJbWFwOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKGkgaW4gdGhpcykgcmVzdWx0c1tpXSA9IGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcyk7CgkJfQoJCXJldHVybiByZXN1bHRzOwoJfSwKCglzb21lOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmICgoaSBpbiB0aGlzKSAmJiBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gdHJ1ZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglhc3NvY2lhdGU6IGZ1bmN0aW9uKGtleXMpewoJCXZhciBvYmogPSB7fSwgbGVuZ3RoID0gTWF0aC5taW4odGhpcy5sZW5ndGgsIGtleXMubGVuZ3RoKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSBvYmpba2V5c1tpXV0gPSB0aGlzW2ldOwoJCXJldHVybiBvYmo7Cgl9LAoKCWxpbms6IGZ1bmN0aW9uKG9iamVjdCl7CgkJdmFyIHJlc3VsdCA9IHt9OwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJCWlmIChvYmplY3Rba2V5XSh0aGlzW2ldKSl7CgkJCQkJcmVzdWx0W2tleV0gPSB0aGlzW2ldOwoJCQkJCWRlbGV0ZSBvYmplY3Rba2V5XTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgljb250YWluczogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJcmV0dXJuIHRoaXMuaW5kZXhPZihpdGVtLCBmcm9tKSAhPSAtMTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbihhcnJheSl7CgkJdGhpcy5wdXNoLmFwcGx5KHRoaXMsIGFycmF5KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMubGVuZ3RoKSA/IHRoaXNbdGhpcy5sZW5ndGggLSAxXSA6IG51bGw7Cgl9LAoKCWdldFJhbmRvbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMubGVuZ3RoKSA/IHRoaXNbTnVtYmVyLnJhbmRvbSgwLCB0aGlzLmxlbmd0aCAtIDEpXSA6IG51bGw7Cgl9LAoKCWluY2x1ZGU6IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICghdGhpcy5jb250YWlucyhpdGVtKSkgdGhpcy5wdXNoKGl0ZW0pOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21iaW5lOiBmdW5jdGlvbihhcnJheSl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpKyspIHRoaXMuaW5jbHVkZShhcnJheVtpXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVyYXNlOiBmdW5jdGlvbihpdGVtKXsKCQlmb3IgKHZhciBpID0gdGhpcy5sZW5ndGg7IGktLTspewoJCQlpZiAodGhpc1tpXSA9PT0gaXRlbSkgdGhpcy5zcGxpY2UoaSwgMSk7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQl0aGlzLmxlbmd0aCA9IDA7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZsYXR0ZW46IGZ1bmN0aW9uKCl7CgkJdmFyIGFycmF5ID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciB0eXBlID0gdHlwZU9mKHRoaXNbaV0pOwoJCQlpZiAodHlwZSA9PSAnbnVsbCcpIGNvbnRpbnVlOwoJCQlhcnJheSA9IGFycmF5LmNvbmNhdCgodHlwZSA9PSAnYXJyYXknIHx8IHR5cGUgPT0gJ2NvbGxlY3Rpb24nIHx8IHR5cGUgPT0gJ2FyZ3VtZW50cycgfHwgaW5zdGFuY2VPZih0aGlzW2ldLCBBcnJheSkpID8gQXJyYXkuZmxhdHRlbih0aGlzW2ldKSA6IHRoaXNbaV0pOwoJCX0KCQlyZXR1cm4gYXJyYXk7Cgl9LAoKCXBpY2s6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmICh0aGlzW2ldICE9IG51bGwpIHJldHVybiB0aGlzW2ldOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgoJaGV4VG9SZ2I6IGZ1bmN0aW9uKGFycmF5KXsKCQlpZiAodGhpcy5sZW5ndGggIT0gMykgcmV0dXJuIG51bGw7CgkJdmFyIHJnYiA9IHRoaXMubWFwKGZ1bmN0aW9uKHZhbHVlKXsKCQkJaWYgKHZhbHVlLmxlbmd0aCA9PSAxKSB2YWx1ZSArPSB2YWx1ZTsKCQkJcmV0dXJuIHZhbHVlLnRvSW50KDE2KTsKCQl9KTsKCQlyZXR1cm4gKGFycmF5KSA/IHJnYiA6ICdyZ2IoJyArIHJnYiArICcpJzsKCX0sCgoJcmdiVG9IZXg6IGZ1bmN0aW9uKGFycmF5KXsKCQlpZiAodGhpcy5sZW5ndGggPCAzKSByZXR1cm4gbnVsbDsKCQlpZiAodGhpcy5sZW5ndGggPT0gNCAmJiB0aGlzWzNdID09IDAgJiYgIWFycmF5KSByZXR1cm4gJ3RyYW5zcGFyZW50JzsKCQl2YXIgaGV4ID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCAzOyBpKyspewoJCQl2YXIgYml0ID0gKHRoaXNbaV0gLSAwKS50b1N0cmluZygxNik7CgkJCWhleC5wdXNoKChiaXQubGVuZ3RoID09IDEpID8gJzAnICsgYml0IDogYml0KTsKCQl9CgkJcmV0dXJuIChhcnJheSkgPyBoZXggOiAnIycgKyBoZXguam9pbignJyk7Cgl9Cgp9KTsKCi8qCi0tLQoKbmFtZTogU3RyaW5nCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgU3RyaW5nIFByb3RvdHlwZXMgbGlrZSBjYW1lbENhc2UsIGNhcGl0YWxpemUsIHRlc3QsIGFuZCB0b0ludC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBTdHJpbmcKCi4uLgoqLwoKU3RyaW5nLmltcGxlbWVudCh7CgoJdGVzdDogZnVuY3Rpb24ocmVnZXgsIHBhcmFtcyl7CgkJcmV0dXJuICgodHlwZU9mKHJlZ2V4KSA9PSAncmVnZXhwJykgPyByZWdleCA6IG5ldyBSZWdFeHAoJycgKyByZWdleCwgcGFyYW1zKSkudGVzdCh0aGlzKTsKCX0sCgoJY29udGFpbnM6IGZ1bmN0aW9uKHN0cmluZywgc2VwYXJhdG9yKXsKCQlyZXR1cm4gKHNlcGFyYXRvcikgPyAoc2VwYXJhdG9yICsgdGhpcyArIHNlcGFyYXRvcikuaW5kZXhPZihzZXBhcmF0b3IgKyBzdHJpbmcgKyBzZXBhcmF0b3IpID4gLTEgOiB0aGlzLmluZGV4T2Yoc3RyaW5nKSA+IC0xOwoJfSwKCgl0cmltOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoL1xzKy9nLCAnICcpLnRyaW0oKTsKCX0sCgoJY2FtZWxDYXNlOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoLy1cRC9nLCBmdW5jdGlvbihtYXRjaCl7CgkJCXJldHVybiBtYXRjaC5jaGFyQXQoMSkudG9VcHBlckNhc2UoKTsKCQl9KTsKCX0sCgoJaHlwaGVuYXRlOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuICgnLScgKyBtYXRjaC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSk7CgkJfSk7Cgl9LAoKCWNhcGl0YWxpemU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXGJbYS16XS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJCXJldHVybiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCX0pOwoJfSwKCgllc2NhcGVSZWdFeHA6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvKFstLiorP14ke30oKXxbXF1cL1xcXSkvZywgJ1xcJDEnKTsKCX0sCgoJdG9JbnQ6IGZ1bmN0aW9uKGJhc2UpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCBiYXNlIHx8IDEwKTsKCX0sCgoJdG9GbG9hdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh0aGlzKTsKCX0sCgoJaGV4VG9SZ2I6IGZ1bmN0aW9uKGFycmF5KXsKCQl2YXIgaGV4ID0gdGhpcy5tYXRjaCgvXiM/KFx3ezEsMn0pKFx3ezEsMn0pKFx3ezEsMn0pJC8pOwoJCXJldHVybiAoaGV4KSA/IGhleC5zbGljZSgxKS5oZXhUb1JnYihhcnJheSkgOiBudWxsOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCXZhciByZ2IgPSB0aGlzLm1hdGNoKC9cZHsxLDN9L2cpOwoJCXJldHVybiAocmdiKSA/IHJnYi5yZ2JUb0hleChhcnJheSkgOiBudWxsOwoJfSwKCglzdWJzdGl0dXRlOiBmdW5jdGlvbihvYmplY3QsIHJlZ2V4cCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZShyZWdleHAgfHwgKC9cXD9ceyhbXnt9XSspXH0vZyksIGZ1bmN0aW9uKG1hdGNoLCBuYW1lKXsKCQkJaWYgKG1hdGNoLmNoYXJBdCgwKSA9PSAnXFwnKSByZXR1cm4gbWF0Y2guc2xpY2UoMSk7CgkJCXJldHVybiAob2JqZWN0W25hbWVdICE9IG51bGwpID8gb2JqZWN0W25hbWVdIDogJyc7CgkJfSk7Cgl9Cgp9KTsKCi8qCi0tLQoKbmFtZTogTnVtYmVyCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgTnVtYmVyIFByb3RvdHlwZXMgbGlrZSBsaW1pdCwgcm91bmQsIHRpbWVzLCBhbmQgY2VpbC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBOdW1iZXIKCi4uLgoqLwoKTnVtYmVyLmltcGxlbWVudCh7CgoJbGltaXQ6IGZ1bmN0aW9uKG1pbiwgbWF4KXsKCQlyZXR1cm4gTWF0aC5taW4obWF4LCBNYXRoLm1heChtaW4sIHRoaXMpKTsKCX0sCgoJcm91bmQ6IGZ1bmN0aW9uKHByZWNpc2lvbil7CgkJcHJlY2lzaW9uID0gTWF0aC5wb3coMTAsIHByZWNpc2lvbiB8fCAwKS50b0ZpeGVkKHByZWNpc2lvbiA8IDAgPyAtcHJlY2lzaW9uIDogMCk7CgkJcmV0dXJuIE1hdGgucm91bmQodGhpcyAqIHByZWNpc2lvbikgLyBwcmVjaXNpb247Cgl9LAoKCXRpbWVzOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzOyBpKyspIGZuLmNhbGwoYmluZCwgaSwgdGhpcyk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9Cgp9KTsKCk51bWJlci5hbGlhcygnZWFjaCcsICd0aW1lcycpOwoKKGZ1bmN0aW9uKG1hdGgpewoJdmFyIG1ldGhvZHMgPSB7fTsKCW1hdGguZWFjaChmdW5jdGlvbihuYW1lKXsKCQlpZiAoIU51bWJlcltuYW1lXSkgbWV0aG9kc1tuYW1lXSA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBNYXRoW25hbWVdLmFwcGx5KG51bGwsIFt0aGlzXS5jb25jYXQoQXJyYXkuZnJvbShhcmd1bWVudHMpKSk7CgkJfTsKCX0pOwoJTnVtYmVyLmltcGxlbWVudChtZXRob2RzKTsKfSkoWydhYnMnLCAnYWNvcycsICdhc2luJywgJ2F0YW4nLCAnYXRhbjInLCAnY2VpbCcsICdjb3MnLCAnZXhwJywgJ2Zsb29yJywgJ2xvZycsICdtYXgnLCAnbWluJywgJ3BvdycsICdzaW4nLCAnc3FydCcsICd0YW4nXSk7CgovKgotLS0KCm5hbWU6IEZ1bmN0aW9uCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRnVuY3Rpb24gUHJvdG90eXBlcyBsaWtlIGNyZWF0ZSwgYmluZCwgcGFzcywgYW5kIGRlbGF5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEZ1bmN0aW9uCgouLi4KKi8KCkZ1bmN0aW9uLmV4dGVuZCh7CgoJYXR0ZW1wdDogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl0cnkgewoJCQkJcmV0dXJuIGFyZ3VtZW50c1tpXSgpOwoJCQl9IGNhdGNoIChlKXt9CgkJfQoJCXJldHVybiBudWxsOwoJfQoKfSk7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLmFwcGx5KGJpbmQsIEFycmF5LmZyb20oYXJncykpOwoJCX0gY2F0Y2ggKGUpe30KCgkJcmV0dXJuIG51bGw7Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKGJpbmQpewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJncyA9IChhcmd1bWVudHMubGVuZ3RoID4gMSkgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbDsKCgkJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJCWlmICghYXJncyAmJiAhYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIHNlbGYuY2FsbChiaW5kKTsKCQkJaWYgKGFyZ3MgJiYgYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncy5jb25jYXQoQXJyYXkuZnJvbShhcmd1bWVudHMpKSk7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIGFyZ3MgfHwgYXJndW1lbnRzKTsKCQl9OwoJfSwKCglwYXNzOiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJaWYgKGFyZ3MgIT0gbnVsbCkgYXJncyA9IEFycmF5LmZyb20oYXJncyk7CgkJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIGFyZ3MgfHwgYXJndW1lbnRzKTsKCQl9OwoJfSwKCglkZWxheTogZnVuY3Rpb24oZGVsYXksIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRUaW1lb3V0KHRoaXMucGFzcygoYXJncyA9PSBudWxsID8gW10gOiBhcmdzKSwgYmluZCksIGRlbGF5KTsKCX0sCgoJcGVyaW9kaWNhbDogZnVuY3Rpb24ocGVyaW9kaWNhbCwgYmluZCwgYXJncyl7CgkJcmV0dXJuIHNldEludGVydmFsKHRoaXMucGFzcygoYXJncyA9PSBudWxsID8gW10gOiBhcmdzKSwgYmluZCksIHBlcmlvZGljYWwpOwoJfQoKfSk7CgovKgotLS0KCm5hbWU6IE9iamVjdAoKZGVzY3JpcHRpb246IE9iamVjdCBnZW5lcmljIG1ldGhvZHMKCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBbT2JqZWN0LCBIYXNoXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgpPYmplY3QuZXh0ZW5kKHsKCglzdWJzZXQ6IGZ1bmN0aW9uKG9iamVjdCwga2V5cyl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGsgPSBrZXlzW2ldOwoJCQlyZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlPYmplY3QuZWFjaChvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQlpZiAoZm4uY2FsbChiaW5kLCB2YWx1ZSwga2V5LCBvYmplY3QpKSByZXN1bHRzW2tleV0gPSB2YWx1ZTsKCQl9KTsKCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKfSkoKTsKCi8qCi0tLQoKbmFtZTogQnJvd3NlcgoKZGVzY3JpcHRpb246IFRoZSBCcm93c2VyIE9iamVjdC4gQ29udGFpbnMgQnJvd3NlciBpbml0aWFsaXphdGlvbiwgV2luZG93IGFuZCBEb2N1bWVudCwgYW5kIHRoZSBCcm93c2VyIEhhc2guCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIEZ1bmN0aW9uLCBOdW1iZXIsIFN0cmluZ10KCnByb3ZpZGVzOiBbQnJvd3NlciwgV2luZG93LCBEb2N1bWVudF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50Owp2YXIgd2luZG93ID0gZG9jdW1lbnQud2luZG93ID0gdGhpczsKCnZhciBVSUQgPSAxOwoKdGhpcy4kdWlkID0gKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSA/IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIChpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBbVUlEKytdKSlbMF07Cn0gOiBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBVSUQrKyk7Cn07CgokdWlkKHdpbmRvdyk7CiR1aWQoZG9jdW1lbnQpOwoKdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLAoJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0udG9Mb3dlckNhc2UoKSwKCVVBID0gdWEubWF0Y2goLyhvcGVyYXxpZXxmaXJlZm94fGNocm9tZXx2ZXJzaW9uKVtcc1wvOl0oW1x3XGRcLl0rKT8uKj8oc2FmYXJpfHZlcnNpb25bXHNcLzpdKFtcd1xkXC5dKyl8JCkvKSB8fCBbbnVsbCwgJ3Vua25vd24nLCAwXSwKCW1vZGUgPSBVQVsxXSA9PSAnaWUnICYmIGRvY3VtZW50LmRvY3VtZW50TW9kZTsKCnZhciBCcm93c2VyID0gdGhpcy5Ccm93c2VyID0gewoKCWV4dGVuZDogRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCwKCgluYW1lOiAoVUFbMV0gPT0gJ3ZlcnNpb24nKSA/IFVBWzNdIDogVUFbMV0sCgoJdmVyc2lvbjogbW9kZSB8fCBwYXJzZUZsb2F0KChVQVsxXSA9PSAnb3BlcmEnICYmIFVBWzRdKSA/IFVBWzRdIDogVUFbMl0pLAoKCVBsYXRmb3JtOiB7CgkJbmFtZTogdWEubWF0Y2goL2lwKD86YWR8b2R8aG9uZSkvKSA/ICdpb3MnIDogKHVhLm1hdGNoKC8oPzp3ZWJvc3xhbmRyb2lkKS8pIHx8IHBsYXRmb3JtLm1hdGNoKC9tYWN8d2lufGxpbnV4LykgfHwgWydvdGhlciddKVswXQoJfSwKCglGZWF0dXJlczogewoJCXhwYXRoOiAhIShkb2N1bWVudC5ldmFsdWF0ZSksCgkJYWlyOiAhISh3aW5kb3cucnVudGltZSksCgkJcXVlcnk6ICEhKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IpLAoJCWpzb246ICEhKHdpbmRvdy5KU09OKQoJfSwKCglQbHVnaW5zOiB7fQoKfTsKCkJyb3dzZXJbQnJvd3Nlci5uYW1lXSA9IHRydWU7CkJyb3dzZXJbQnJvd3Nlci5uYW1lICsgcGFyc2VJbnQoQnJvd3Nlci52ZXJzaW9uLCAxMCldID0gdHJ1ZTsKQnJvd3Nlci5QbGF0Zm9ybVtCcm93c2VyLlBsYXRmb3JtLm5hbWVdID0gdHJ1ZTsKCi8vIFJlcXVlc3QKCkJyb3dzZXIuUmVxdWVzdCA9IChmdW5jdGlvbigpewoKCXZhciBYTUxIVFRQID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7Cgl9OwoKCXZhciBNU1hNTDIgPSBmdW5jdGlvbigpewoJCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTVNYTUwyLlhNTEhUVFAnKTsKCX07CgoJdmFyIE1TWE1MID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01pY3Jvc29mdC5YTUxIVFRQJyk7Cgl9OwoKCXJldHVybiBGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJWE1MSFRUUCgpOwoJCXJldHVybiBYTUxIVFRQOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTDIoKTsKCQlyZXR1cm4gTVNYTUwyOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTCgpOwoJCXJldHVybiBNU1hNTDsKCX0pOwoKfSkoKTsKCkJyb3dzZXIuRmVhdHVyZXMueGhyID0gISEoQnJvd3Nlci5SZXF1ZXN0KTsKCi8vIEZsYXNoIGRldGVjdGlvbgoKdmFyIHZlcnNpb24gPSAoRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJcmV0dXJuIG5hdmlnYXRvci5wbHVnaW5zWydTaG9ja3dhdmUgRmxhc2gnXS5kZXNjcmlwdGlvbjsKfSwgZnVuY3Rpb24oKXsKCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2gnKS5HZXRWYXJpYWJsZSgnJHZlcnNpb24nKTsKfSkgfHwgJzAgcjAnKS5tYXRjaCgvXGQrL2cpOwoKQnJvd3Nlci5QbHVnaW5zLkZsYXNoID0gewoJdmVyc2lvbjogTnVtYmVyKHZlcnNpb25bMF0gfHwgJzAuJyArIHZlcnNpb25bMV0pIHx8IDAsCglidWlsZDogTnVtYmVyKHZlcnNpb25bMl0pIHx8IDAKfTsKCi8vIFN0cmluZyBzY3JpcHRzCgpCcm93c2VyLmV4ZWMgPSBmdW5jdGlvbih0ZXh0KXsKCWlmICghdGV4dCkgcmV0dXJuIHRleHQ7CglpZiAod2luZG93LmV4ZWNTY3JpcHQpewoJCXdpbmRvdy5leGVjU2NyaXB0KHRleHQpOwoJfSBlbHNlIHsKCQl2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJc2NyaXB0LnNldEF0dHJpYnV0ZSgndHlwZScsICd0ZXh0L2phdmFzY3JpcHQnKTsKCQlzY3JpcHQudGV4dCA9IHRleHQ7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCWRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKCX0KCXJldHVybiB0ZXh0Owp9OwoKU3RyaW5nLmltcGxlbWVudCgnc3RyaXBTY3JpcHRzJywgZnVuY3Rpb24oZXhlYyl7Cgl2YXIgc2NyaXB0cyA9ICcnOwoJdmFyIHRleHQgPSB0aGlzLnJlcGxhY2UoLzxzY3JpcHRbXj5dKj4oW1xzXFNdKj8pPFwvc2NyaXB0Pi9naSwgZnVuY3Rpb24oYWxsLCBjb2RlKXsKCQlzY3JpcHRzICs9IGNvZGUgKyAnXG4nOwoJCXJldHVybiAnJzsKCX0pOwoJaWYgKGV4ZWMgPT09IHRydWUpIEJyb3dzZXIuZXhlYyhzY3JpcHRzKTsKCWVsc2UgaWYgKHR5cGVPZihleGVjKSA9PSAnZnVuY3Rpb24nKSBleGVjKHNjcmlwdHMsIHRleHQpOwoJcmV0dXJuIHRleHQ7Cn0pOwoKLy8gV2luZG93LCBEb2N1bWVudAoKQnJvd3Nlci5leHRlbmQoewoJRG9jdW1lbnQ6IHRoaXMuRG9jdW1lbnQsCglXaW5kb3c6IHRoaXMuV2luZG93LAoJRWxlbWVudDogdGhpcy5FbGVtZW50LAoJRXZlbnQ6IHRoaXMuRXZlbnQKfSk7Cgp0aGlzLldpbmRvdyA9IHRoaXMuJGNvbnN0cnVjdG9yID0gbmV3IFR5cGUoJ1dpbmRvdycsIGZ1bmN0aW9uKCl7fSk7Cgp0aGlzLiRmYW1pbHkgPSBGdW5jdGlvbi5mcm9tKCd3aW5kb3cnKS5oaWRlKCk7CgpXaW5kb3cubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cgl3aW5kb3dbbmFtZV0gPSBtZXRob2Q7Cn0pOwoKdGhpcy5Eb2N1bWVudCA9IGRvY3VtZW50LiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdEb2N1bWVudCcsIGZ1bmN0aW9uKCl7fSk7Cgpkb2N1bWVudC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZG9jdW1lbnQnKS5oaWRlKCk7CgpEb2N1bWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWRvY3VtZW50W25hbWVdID0gbWV0aG9kOwp9KTsKCmRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CmRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KCn0pLmNhbGwodGhpcyk7CgovKgotLS0KCm5hbWU6IEV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIEV2ZW50IENsYXNzLCB0byBtYWtlIHRoZSBldmVudCBvYmplY3QgY3Jvc3MtYnJvd3Nlci4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtXaW5kb3csIERvY3VtZW50LCBBcnJheSwgRnVuY3Rpb24sIFN0cmluZywgT2JqZWN0XQoKcHJvdmlkZXM6IEV2ZW50CgouLi4KKi8KCnZhciBFdmVudCA9IG5ldyBUeXBlKCdFdmVudCcsIGZ1bmN0aW9uKGV2ZW50LCB3aW4pewoJaWYgKCF3aW4pIHdpbiA9IHdpbmRvdzsKCXZhciBkb2MgPSB3aW4uZG9jdW1lbnQ7CglldmVudCA9IGV2ZW50IHx8IHdpbi5ldmVudDsKCWlmIChldmVudC4kZXh0ZW5kZWQpIHJldHVybiBldmVudDsKCXRoaXMuJGV4dGVuZGVkID0gdHJ1ZTsKCXZhciB0eXBlID0gZXZlbnQudHlwZSwKCQl0YXJnZXQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudCwKCQlwYWdlID0ge30sCgkJY2xpZW50ID0ge30sCgkJcmVsYXRlZCA9IG51bGwsCgkJcmlnaHRDbGljaywgd2hlZWwsIGNvZGUsIGtleTsKCXdoaWxlICh0YXJnZXQgJiYgdGFyZ2V0Lm5vZGVUeXBlID09IDMpIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoKCWlmICh0eXBlLmluZGV4T2YoJ2tleScpICE9IC0xKXsKCQljb2RlID0gZXZlbnQud2hpY2ggfHwgZXZlbnQua2V5Q29kZTsKCQlrZXkgPSBPYmplY3Qua2V5T2YoRXZlbnQuS2V5cywgY29kZSk7CgkJaWYgKHR5cGUgPT0gJ2tleWRvd24nKXsKCQkJdmFyIGZLZXkgPSBjb2RlIC0gMTExOwoJCQlpZiAoZktleSA+IDAgJiYgZktleSA8IDEzKSBrZXkgPSAnZicgKyBmS2V5OwoJCX0KCQlpZiAoIWtleSkga2V5ID0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlKS50b0xvd2VyQ2FzZSgpOwoJfSBlbHNlIGlmICgoL2NsaWNrfG1vdXNlfG1lbnUvaSkudGVzdCh0eXBlKSl7CgkJZG9jID0gKCFkb2MuY29tcGF0TW9kZSB8fCBkb2MuY29tcGF0TW9kZSA9PSAnQ1NTMUNvbXBhdCcpID8gZG9jLmh0bWwgOiBkb2MuYm9keTsKCQlwYWdlID0gewoJCQl4OiAoZXZlbnQucGFnZVggIT0gbnVsbCkgPyBldmVudC5wYWdlWCA6IGV2ZW50LmNsaWVudFggKyBkb2Muc2Nyb2xsTGVmdCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgOiBldmVudC5jbGllbnRZICsgZG9jLnNjcm9sbFRvcAoJCX07CgkJY2xpZW50ID0gewoJCQl4OiAoZXZlbnQucGFnZVggIT0gbnVsbCkgPyBldmVudC5wYWdlWCAtIHdpbi5wYWdlWE9mZnNldCA6IGV2ZW50LmNsaWVudFgsCgkJCXk6IChldmVudC5wYWdlWSAhPSBudWxsKSA/IGV2ZW50LnBhZ2VZIC0gd2luLnBhZ2VZT2Zmc2V0IDogZXZlbnQuY2xpZW50WQoJCX07CgkJaWYgKCgvRE9NTW91c2VTY3JvbGx8bW91c2V3aGVlbC8pLnRlc3QodHlwZSkpewoJCQl3aGVlbCA9IChldmVudC53aGVlbERlbHRhKSA/IGV2ZW50LndoZWVsRGVsdGEgLyAxMjAgOiAtKGV2ZW50LmRldGFpbCB8fCAwKSAvIDM7CgkJfQoJCXJpZ2h0Q2xpY2sgPSAoZXZlbnQud2hpY2ggPT0gMykgfHwgKGV2ZW50LmJ1dHRvbiA9PSAyKTsKCQlpZiAoKC9vdmVyfG91dC8pLnRlc3QodHlwZSkpewoJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCB8fCBldmVudFsodHlwZSA9PSAnbW91c2VvdmVyJyA/ICdmcm9tJyA6ICd0bycpICsgJ0VsZW1lbnQnXTsKCQkJdmFyIHRlc3RSZWxhdGVkID0gZnVuY3Rpb24oKXsKCQkJCXdoaWxlIChyZWxhdGVkICYmIHJlbGF0ZWQubm9kZVR5cGUgPT0gMykgcmVsYXRlZCA9IHJlbGF0ZWQucGFyZW50Tm9kZTsKCQkJCXJldHVybiB0cnVlOwoJCQl9OwoJCQl2YXIgaGFzUmVsYXRlZCA9IChCcm93c2VyLmZpcmVmb3gyKSA/IHRlc3RSZWxhdGVkLmF0dGVtcHQoKSA6IHRlc3RSZWxhdGVkKCk7CgkJCXJlbGF0ZWQgPSAoaGFzUmVsYXRlZCkgPyByZWxhdGVkIDogbnVsbDsKCQl9Cgl9IGVsc2UgaWYgKCgvZ2VzdHVyZXx0b3VjaC9pKS50ZXN0KHR5cGUpKXsKCQl0aGlzLnJvdGF0aW9uID0gZXZlbnQucm90YXRpb247CgkJdGhpcy5zY2FsZSA9IGV2ZW50LnNjYWxlOwoJCXRoaXMudGFyZ2V0VG91Y2hlcyA9IGV2ZW50LnRhcmdldFRvdWNoZXM7CgkJdGhpcy5jaGFuZ2VkVG91Y2hlcyA9IGV2ZW50LmNoYW5nZWRUb3VjaGVzOwoJCXZhciB0b3VjaGVzID0gdGhpcy50b3VjaGVzID0gZXZlbnQudG91Y2hlczsKCQlpZiAodG91Y2hlcyAmJiB0b3VjaGVzWzBdKXsKCQkJdmFyIHRvdWNoID0gdG91Y2hlc1swXTsKCQkJcGFnZSA9IHt4OiB0b3VjaC5wYWdlWCwgeTogdG91Y2gucGFnZVl9OwoJCQljbGllbnQgPSB7eDogdG91Y2guY2xpZW50WCwgeTogdG91Y2guY2xpZW50WX07CgkJfQoJfQoKCXJldHVybiBPYmplY3QuYXBwZW5kKHRoaXMsIHsKCQlldmVudDogZXZlbnQsCgkJdHlwZTogdHlwZSwKCgkJcGFnZTogcGFnZSwKCQljbGllbnQ6IGNsaWVudCwKCQlyaWdodENsaWNrOiByaWdodENsaWNrLAoKCQl3aGVlbDogd2hlZWwsCgoJCXJlbGF0ZWRUYXJnZXQ6IGRvY3VtZW50LmlkKHJlbGF0ZWQpLAoJCXRhcmdldDogZG9jdW1lbnQuaWQodGFyZ2V0KSwKCgkJY29kZTogY29kZSwKCQlrZXk6IGtleSwKCgkJc2hpZnQ6IGV2ZW50LnNoaWZ0S2V5LAoJCWNvbnRyb2w6IGV2ZW50LmN0cmxLZXksCgkJYWx0OiBldmVudC5hbHRLZXksCgkJbWV0YTogZXZlbnQubWV0YUtleQoJfSk7Cn0pOwoKRXZlbnQuS2V5cyA9IHsKCSdlbnRlcic6IDEzLAoJJ3VwJzogMzgsCgknZG93bic6IDQwLAoJJ2xlZnQnOiAzNywKCSdyaWdodCc6IDM5LAoJJ2VzYyc6IDI3LAoJJ3NwYWNlJzogMzIsCgknYmFja3NwYWNlJzogOCwKCSd0YWInOiA5LAoJJ2RlbGV0ZSc6IDQ2Cn07CgpFdmVudC5pbXBsZW1lbnQoewoKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCkucHJldmVudERlZmF1bHQoKTsKCX0sCgoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnN0b3BQcm9wYWdhdGlvbikgdGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQllbHNlIHRoaXMuZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQpIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQllbHNlIHRoaXMuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLyoKLS0tCgpuYW1lOiBDbGFzcwoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBDbGFzcyBGdW5jdGlvbiBmb3IgZWFzaWx5IGNyZWF0aW5nLCBleHRlbmRpbmcsIGFuZCBpbXBsZW1lbnRpbmcgcmV1c2FibGUgQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtBcnJheSwgU3RyaW5nLCBGdW5jdGlvbiwgTnVtYmVyXQoKcHJvdmlkZXM6IENsYXNzCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIENsYXNzID0gdGhpcy5DbGFzcyA9IG5ldyBUeXBlKCdDbGFzcycsIGZ1bmN0aW9uKHBhcmFtcyl7CglpZiAoaW5zdGFuY2VPZihwYXJhbXMsIEZ1bmN0aW9uKSkgcGFyYW1zID0ge2luaXRpYWxpemU6IHBhcmFtc307CgoJdmFyIG5ld0NsYXNzID0gZnVuY3Rpb24oKXsKCQlyZXNldCh0aGlzKTsKCQlpZiAobmV3Q2xhc3MuJHByb3RvdHlwaW5nKSByZXR1cm4gdGhpczsKCQl0aGlzLiRjYWxsZXIgPSBudWxsOwoJCXZhciB2YWx1ZSA9ICh0aGlzLmluaXRpYWxpemUpID8gdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiB0aGlzOwoJCXRoaXMuJGNhbGxlciA9IHRoaXMuY2FsbGVyID0gbnVsbDsKCQlyZXR1cm4gdmFsdWU7Cgl9LmV4dGVuZCh0aGlzKS5pbXBsZW1lbnQocGFyYW1zKTsKCgluZXdDbGFzcy4kY29uc3RydWN0b3IgPSBDbGFzczsKCW5ld0NsYXNzLnByb3RvdHlwZS4kY29uc3RydWN0b3IgPSBuZXdDbGFzczsKCW5ld0NsYXNzLnByb3RvdHlwZS5wYXJlbnQgPSBwYXJlbnQ7CgoJcmV0dXJuIG5ld0NsYXNzOwp9KTsKCnZhciBwYXJlbnQgPSBmdW5jdGlvbigpewoJaWYgKCF0aGlzLiRjYWxsZXIpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAicGFyZW50IiBjYW5ub3QgYmUgY2FsbGVkLicpOwoJdmFyIG5hbWUgPSB0aGlzLiRjYWxsZXIuJG5hbWUsCgkJcGFyZW50ID0gdGhpcy4kY2FsbGVyLiRvd25lci5wYXJlbnQsCgkJcHJldmlvdXMgPSAocGFyZW50KSA/IHBhcmVudC5wcm90b3R5cGVbbmFtZV0gOiBudWxsOwoJaWYgKCFwcmV2aW91cykgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICInICsgbmFtZSArICciIGhhcyBubyBwYXJlbnQuJyk7CglyZXR1cm4gcHJldmlvdXMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKCnZhciByZXNldCA9IGZ1bmN0aW9uKG9iamVjdCl7Cglmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQl2YXIgdmFsdWUgPSBvYmplY3Rba2V5XTsKCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQljYXNlICdvYmplY3QnOgoJCQkJdmFyIEYgPSBmdW5jdGlvbigpe307CgkJCQlGLnByb3RvdHlwZSA9IHZhbHVlOwoJCQkJb2JqZWN0W2tleV0gPSByZXNldChuZXcgRik7CgkJCWJyZWFrOwoJCQljYXNlICdhcnJheSc6IG9iamVjdFtrZXldID0gdmFsdWUuY2xvbmUoKTsgYnJlYWs7CgkJfQoJfQoJcmV0dXJuIG9iamVjdDsKfTsKCnZhciB3cmFwID0gZnVuY3Rpb24oc2VsZiwga2V5LCBtZXRob2QpewoJaWYgKG1ldGhvZC4kb3JpZ2luKSBtZXRob2QgPSBtZXRob2QuJG9yaWdpbjsKCXZhciB3cmFwcGVyID0gZnVuY3Rpb24oKXsKCQlpZiAobWV0aG9kLiRwcm90ZWN0ZWQgJiYgdGhpcy4kY2FsbGVyID09IG51bGwpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAiJyArIGtleSArICciIGNhbm5vdCBiZSBjYWxsZWQuJyk7CgkJdmFyIGNhbGxlciA9IHRoaXMuY2FsbGVyLCBjdXJyZW50ID0gdGhpcy4kY2FsbGVyOwoJCXRoaXMuY2FsbGVyID0gY3VycmVudDsgdGhpcy4kY2FsbGVyID0gd3JhcHBlcjsKCQl2YXIgcmVzdWx0ID0gbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJdGhpcy4kY2FsbGVyID0gY3VycmVudDsgdGhpcy5jYWxsZXIgPSBjYWxsZXI7CgkJcmV0dXJuIHJlc3VsdDsKCX0uZXh0ZW5kKHskb3duZXI6IHNlbGYsICRvcmlnaW46IG1ldGhvZCwgJG5hbWU6IGtleX0pOwoJcmV0dXJuIHdyYXBwZXI7Cn07Cgp2YXIgaW1wbGVtZW50ID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgcmV0YWluKXsKCWlmIChDbGFzcy5NdXRhdG9ycy5oYXNPd25Qcm9wZXJ0eShrZXkpKXsKCQl2YWx1ZSA9IENsYXNzLk11dGF0b3JzW2tleV0uY2FsbCh0aGlzLCB2YWx1ZSk7CgkJaWYgKHZhbHVlID09IG51bGwpIHJldHVybiB0aGlzOwoJfQoKCWlmICh0eXBlT2YodmFsdWUpID09ICdmdW5jdGlvbicpewoJCWlmICh2YWx1ZS4kaGlkZGVuKSByZXR1cm4gdGhpczsKCQl0aGlzLnByb3RvdHlwZVtrZXldID0gKHJldGFpbikgPyB2YWx1ZSA6IHdyYXAodGhpcywga2V5LCB2YWx1ZSk7Cgl9IGVsc2UgewoJCU9iamVjdC5tZXJnZSh0aGlzLnByb3RvdHlwZSwga2V5LCB2YWx1ZSk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07Cgp2YXIgZ2V0SW5zdGFuY2UgPSBmdW5jdGlvbihrbGFzcyl7CglrbGFzcy4kcHJvdG90eXBpbmcgPSB0cnVlOwoJdmFyIHByb3RvID0gbmV3IGtsYXNzOwoJZGVsZXRlIGtsYXNzLiRwcm90b3R5cGluZzsKCXJldHVybiBwcm90bzsKfTsKCkNsYXNzLmltcGxlbWVudCgnaW1wbGVtZW50JywgaW1wbGVtZW50Lm92ZXJsb2FkU2V0dGVyKCkpOwoKQ2xhc3MuTXV0YXRvcnMgPSB7CgoJRXh0ZW5kczogZnVuY3Rpb24ocGFyZW50KXsKCQl0aGlzLnBhcmVudCA9IHBhcmVudDsKCQl0aGlzLnByb3RvdHlwZSA9IGdldEluc3RhbmNlKHBhcmVudCk7Cgl9LAoKCUltcGxlbWVudHM6IGZ1bmN0aW9uKGl0ZW1zKXsKCQlBcnJheS5mcm9tKGl0ZW1zKS5lYWNoKGZ1bmN0aW9uKGl0ZW0pewoJCQl2YXIgaW5zdGFuY2UgPSBuZXcgaXRlbTsKCQkJZm9yICh2YXIga2V5IGluIGluc3RhbmNlKSBpbXBsZW1lbnQuY2FsbCh0aGlzLCBrZXksIGluc3RhbmNlW2tleV0sIHRydWUpOwoJCX0sIHRoaXMpOwoJfQp9OwoKfSkuY2FsbCh0aGlzKTsKCi8qCi0tLQoKbmFtZTogQ2xhc3MuRXh0cmFzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgVXRpbGl0eSBDbGFzc2VzIHRoYXQgY2FuIGJlIGltcGxlbWVudGVkIGludG8geW91ciBvd24gQ2xhc3NlcyB0byBlYXNlIHRoZSBleGVjdXRpb24gb2YgbWFueSBjb21tb24gdGFza3MuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBDbGFzcwoKcHJvdmlkZXM6IFtDbGFzcy5FeHRyYXMsIENoYWluLCBFdmVudHMsIE9wdGlvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5DaGFpbiA9IG5ldyBDbGFzcyh7CgoJJGNoYWluOiBbXSwKCgljaGFpbjogZnVuY3Rpb24oKXsKCQl0aGlzLiRjaGFpbi5hcHBlbmQoQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FsbENoYWluOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy4kY2hhaW4ubGVuZ3RoKSA/IHRoaXMuJGNoYWluLnNoaWZ0KCkuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGZhbHNlOwoJfSwKCgljbGVhckNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmVtcHR5KCk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciByZW1vdmVPbiA9IGZ1bmN0aW9uKHN0cmluZyl7CglyZXR1cm4gc3RyaW5nLnJlcGxhY2UoL15vbihbQS1aXSkvLCBmdW5jdGlvbihmdWxsLCBmaXJzdCl7CgkJcmV0dXJuIGZpcnN0LnRvTG93ZXJDYXNlKCk7Cgl9KTsKfTsKCnRoaXMuRXZlbnRzID0gbmV3IENsYXNzKHsKCgkkZXZlbnRzOiB7fSwKCglhZGRFdmVudDogZnVuY3Rpb24odHlwZSwgZm4sIGludGVybmFsKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgoJCXRoaXMuJGV2ZW50c1t0eXBlXSA9ICh0aGlzLiRldmVudHNbdHlwZV0gfHwgW10pLmluY2x1ZGUoZm4pOwoJCWlmIChpbnRlcm5hbCkgZm4uaW50ZXJuYWwgPSB0cnVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgdHlwZSBpbiBldmVudHMpIHRoaXMuYWRkRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmlyZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBhcmdzLCBkZWxheSl7CgkJdHlwZSA9IHJlbW92ZU9uKHR5cGUpOwoJCXZhciBldmVudHMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJaWYgKCFldmVudHMpIHJldHVybiB0aGlzOwoJCWFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCWV2ZW50cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJaWYgKGRlbGF5KSBmbi5kZWxheShkZWxheSwgdGhpcywgYXJncyk7CgkJCWVsc2UgZm4uYXBwbHkodGhpcywgYXJncyk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdHlwZSA9IHJlbW92ZU9uKHR5cGUpOwoJCXZhciBldmVudHMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJaWYgKGV2ZW50cyAmJiAhZm4uaW50ZXJuYWwpewoJCQl2YXIgaW5kZXggPSAgZXZlbnRzLmluZGV4T2YoZm4pOwoJCQlpZiAoaW5kZXggIT0gLTEpIGRlbGV0ZSBldmVudHNbaW5kZXhdOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCWlmIChldmVudHMpIGV2ZW50cyA9IHJlbW92ZU9uKGV2ZW50cyk7CgkJZm9yICh0eXBlIGluIHRoaXMuJGV2ZW50cyl7CgkJCWlmIChldmVudHMgJiYgZXZlbnRzICE9IHR5cGUpIGNvbnRpbnVlOwoJCQl2YXIgZm5zID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCQlmb3IgKHZhciBpID0gZm5zLmxlbmd0aDsgaS0tOykgaWYgKGkgaW4gZm5zKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZm5zW2ldKTsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdGhpcy5PcHRpb25zID0gbmV3IENsYXNzKHsKCglzZXRPcHRpb25zOiBmdW5jdGlvbigpewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zID0gT2JqZWN0Lm1lcmdlLmFwcGx5KG51bGwsIFt7fSwgdGhpcy5vcHRpb25zXS5hcHBlbmQoYXJndW1lbnRzKSk7CgkJaWYgKHRoaXMuYWRkRXZlbnQpIGZvciAodmFyIG9wdGlvbiBpbiBvcHRpb25zKXsKCQkJaWYgKHR5cGVPZihvcHRpb25zW29wdGlvbl0pICE9ICdmdW5jdGlvbicgfHwgISgvXm9uW0EtWl0vKS50ZXN0KG9wdGlvbikpIGNvbnRpbnVlOwoJCQl0aGlzLmFkZEV2ZW50KG9wdGlvbiwgb3B0aW9uc1tvcHRpb25dKTsKCQkJZGVsZXRlIG9wdGlvbnNbb3B0aW9uXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCn0pLmNhbGwodGhpcyk7CgovKgotLS0KbmFtZTogU2xpY2suUGFyc2VyCmRlc2NyaXB0aW9uOiBTdGFuZGFsb25lIENTUzMgU2VsZWN0b3IgcGFyc2VyCnByb3ZpZGVzOiBTbGljay5QYXJzZXIKLi4uCiovCgo7KGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VkLAoJc2VwYXJhdG9ySW5kZXgsCgljb21iaW5hdG9ySW5kZXgsCglyZXZlcnNlZCwKCWNhY2hlID0ge30sCglyZXZlcnNlQ2FjaGUgPSB7fSwKCXJlVW5lc2NhcGUgPSAvXFwvZzsKCnZhciBwYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGlzUmV2ZXJzZWQpewoJaWYgKGV4cHJlc3Npb24gPT0gbnVsbCkgcmV0dXJuIG51bGw7CglpZiAoZXhwcmVzc2lvbi5TbGljayA9PT0gdHJ1ZSkgcmV0dXJuIGV4cHJlc3Npb247CglleHByZXNzaW9uID0gKCcnICsgZXhwcmVzc2lvbikucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCXJldmVyc2VkID0gISFpc1JldmVyc2VkOwoJdmFyIGN1cnJlbnRDYWNoZSA9IChyZXZlcnNlZCkgPyByZXZlcnNlQ2FjaGUgOiBjYWNoZTsKCWlmIChjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl0pIHJldHVybiBjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl07CglwYXJzZWQgPSB7CgkJU2xpY2s6IHRydWUsCgkJZXhwcmVzc2lvbnM6IFtdLAoJCXJhdzogZXhwcmVzc2lvbiwKCQlyZXZlcnNlOiBmdW5jdGlvbigpewoJCQlyZXR1cm4gcGFyc2UodGhpcy5yYXcsIHRydWUpOwoJCX0KCX07CglzZXBhcmF0b3JJbmRleCA9IC0xOwoJd2hpbGUgKGV4cHJlc3Npb24gIT0gKGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2UocmVnZXhwLCBwYXJzZXIpKSk7CglwYXJzZWQubGVuZ3RoID0gcGFyc2VkLmV4cHJlc3Npb25zLmxlbmd0aDsKCXJldHVybiBjdXJyZW50Q2FjaGVbcGFyc2VkLnJhd10gPSAocmV2ZXJzZWQpID8gcmV2ZXJzZShwYXJzZWQpIDogcGFyc2VkOwp9OwoKdmFyIHJldmVyc2VDb21iaW5hdG9yID0gZnVuY3Rpb24oY29tYmluYXRvcil7CglpZiAoY29tYmluYXRvciA9PT0gJyEnKSByZXR1cm4gJyAnOwoJZWxzZSBpZiAoY29tYmluYXRvciA9PT0gJyAnKSByZXR1cm4gJyEnOwoJZWxzZSBpZiAoKC9eIS8pLnRlc3QoY29tYmluYXRvcikpIHJldHVybiBjb21iaW5hdG9yLnJlcGxhY2UoL14hLywgJycpOwoJZWxzZSByZXR1cm4gJyEnICsgY29tYmluYXRvcjsKfTsKCnZhciByZXZlcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7Cgl2YXIgZXhwcmVzc2lvbnMgPSBleHByZXNzaW9uLmV4cHJlc3Npb25zOwoJZm9yICh2YXIgaSA9IDA7IGkgPCBleHByZXNzaW9ucy5sZW5ndGg7IGkrKyl7CgkJdmFyIGV4cCA9IGV4cHJlc3Npb25zW2ldOwoJCXZhciBsYXN0ID0ge3BhcnRzOiBbXSwgdGFnOiAnKicsIGNvbWJpbmF0b3I6IHJldmVyc2VDb21iaW5hdG9yKGV4cFswXS5jb21iaW5hdG9yKX07CgoJCWZvciAodmFyIGogPSAwOyBqIDwgZXhwLmxlbmd0aDsgaisrKXsKCQkJdmFyIGNleHAgPSBleHBbal07CgkJCWlmICghY2V4cC5yZXZlcnNlQ29tYmluYXRvcikgY2V4cC5yZXZlcnNlQ29tYmluYXRvciA9ICcgJzsKCQkJY2V4cC5jb21iaW5hdG9yID0gY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQkJZGVsZXRlIGNleHAucmV2ZXJzZUNvbWJpbmF0b3I7CgkJfQoKCQlleHAucmV2ZXJzZSgpLnB1c2gobGFzdCk7Cgl9CglyZXR1cm4gZXhwcmVzc2lvbjsKfTsKCnZhciBlc2NhcGVSZWdFeHAgPSBmdW5jdGlvbihzdHJpbmcpey8vIENyZWRpdDogWFJlZ0V4cCAwLjYuMSAoYykgMjAwNy0yMDA4IFN0ZXZlbiBMZXZpdGhhbiA8aHR0cDovL3N0ZXZlbmxldml0aGFuLmNvbS9yZWdleC94cmVnZXhwLz4gTUlUIExpY2Vuc2UKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvWy1bXF17fSgpKis/LlxcXiR8LCNcc10vZywgZnVuY3Rpb24obWF0Y2gpewoJCXJldHVybiAnXFwnICsgbWF0Y2g7Cgl9KTsKfTsKCnZhciByZWdleHAgPSBuZXcgUmVnRXhwKAovKgojIS91c3IvYmluL2VudiBydWJ5CnB1dHMgIlx0XHQiICsgREFUQS5yZWFkLmdzdWIoL1woXD94XCl8XHMrIy4qJHxccyt8XFwkfFxcbi8sJycpCl9fRU5EX18KCSIoP3gpXig/OlwKCSAgXFxzKiAoICwgKSBcXHMqICAgICAgICAgICAgICAgIyBTZXBhcmF0b3IgICAgICAgICAgXG5cCgl8IFxccyogKCA8Y29tYmluYXRvcj4rICkgXFxzKiAgICMgQ29tYmluYXRvciAgICAgICAgIFxuXAoJfCAgICAgICggXFxzKyApICAgICAgICAgICAgICAgICAjIENvbWJpbmF0b3JDaGlsZHJlbiBcblwKCXwgICAgICAoIDx1bmljb2RlPisgfCBcXCogKSAgICAgIyBUYWcgICAgICAgICAgICAgICAgXG5cCgl8IFxcIyAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgSUQgICAgICAgICAgICAgICAgIFxuXAoJfCBcXC4gICggPHVuaWNvZGU+KyAgICAgICApICAgICAjIENsYXNzTmFtZSAgICAgICAgICBcblwKCXwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBBdHRyaWJ1dGUgICAgICAgICAgXG5cCglcXFsgIFwKCQlcXHMqICg8dW5pY29kZTE+KykgICg/OiAgXAoJCQlcXHMqIChbKl4kIX58XT89KSAgKD86ICBcCgkJCQlcXHMqICg/OlwKCQkJCQkoW1wiJ10/KSguKj8pXFw5IFwKCQkJCSlcCgkJCSkgIFwKCQkpPyAgXFxzKiAgXAoJXFxdKD8hXFxdKSBcblwKCXwgICA6KyAoIDx1bmljb2RlPisgKSg/OlwKCVxcKCAoPzpcCgkJKD86KFtcIiddKShbXlxcMTJdKilcXDEyKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspXAoJKSBcXClcCgkpP1wKCSkiCiovCgkiXig/OlxccyooLClcXHMqfFxccyooPGNvbWJpbmF0b3I+KylcXHMqfChcXHMrKXwoPHVuaWNvZGU+K3xcXCopfFxcIyg8dW5pY29kZT4rKXxcXC4oPHVuaWNvZGU+Kyl8XFxbXFxzKig8dW5pY29kZTE+KykoPzpcXHMqKFsqXiQhfnxdPz0pKD86XFxzKig/OihbXCInXT8pKC4qPylcXDkpKSk/XFxzKlxcXSg/IVxcXSl8KDorKSg8dW5pY29kZT4rKSg/OlxcKCg/Oig/OihbXCInXSkoW15cXDEzXSopXFwxMyl8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKSlcXCkpPykiCgkucmVwbGFjZSgvPGNvbWJpbmF0b3I+LywgJ1snICsgZXNjYXBlUmVnRXhwKCI+K35gIUAkJV4mPXt9XFw7PC8iKSArICddJykKCS5yZXBsYWNlKC88dW5pY29kZT4vZywgJyg/OltcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCgkucmVwbGFjZSgvPHVuaWNvZGUxPi9nLCAnKD86WzpcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCik7CgpmdW5jdGlvbiBwYXJzZXIoCglyYXdNYXRjaCwKCglzZXBhcmF0b3IsCgljb21iaW5hdG9yLAoJY29tYmluYXRvckNoaWxkcmVuLAoKCXRhZ05hbWUsCglpZCwKCWNsYXNzTmFtZSwKCglhdHRyaWJ1dGVLZXksCglhdHRyaWJ1dGVPcGVyYXRvciwKCWF0dHJpYnV0ZVF1b3RlLAoJYXR0cmlidXRlVmFsdWUsCgoJcHNldWRvTWFya2VyLAoJcHNldWRvQ2xhc3MsCglwc2V1ZG9RdW90ZSwKCXBzZXVkb0NsYXNzUXVvdGVkVmFsdWUsCglwc2V1ZG9DbGFzc1ZhbHVlCil7CglpZiAoc2VwYXJhdG9yIHx8IHNlcGFyYXRvckluZGV4ID09PSAtMSl7CgkJcGFyc2VkLmV4cHJlc3Npb25zWysrc2VwYXJhdG9ySW5kZXhdID0gW107CgkJY29tYmluYXRvckluZGV4ID0gLTE7CgkJaWYgKHNlcGFyYXRvcikgcmV0dXJuICcnOwoJfQoKCWlmIChjb21iaW5hdG9yIHx8IGNvbWJpbmF0b3JDaGlsZHJlbiB8fCBjb21iaW5hdG9ySW5kZXggPT09IC0xKXsKCQljb21iaW5hdG9yID0gY29tYmluYXRvciB8fCAnICc7CgkJdmFyIGN1cnJlbnRTZXBhcmF0b3IgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdOwoJCWlmIChyZXZlcnNlZCAmJiBjdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0pCgkJCWN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XS5yZXZlcnNlQ29tYmluYXRvciA9IHJldmVyc2VDb21iaW5hdG9yKGNvbWJpbmF0b3IpOwoJCWN1cnJlbnRTZXBhcmF0b3JbKytjb21iaW5hdG9ySW5kZXhdID0ge2NvbWJpbmF0b3I6IGNvbWJpbmF0b3IsIHRhZzogJyonfTsKCX0KCgl2YXIgY3VycmVudFBhcnNlZCA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF1bY29tYmluYXRvckluZGV4XTsKCglpZiAodGFnTmFtZSl7CgkJY3VycmVudFBhcnNlZC50YWcgPSB0YWdOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoaWQpewoJCWN1cnJlbnRQYXJzZWQuaWQgPSBpZC5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGNsYXNzTmFtZSl7CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0KSBjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCA9IFtdOwoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc2VzKSBjdXJyZW50UGFyc2VkLmNsYXNzZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7CgkJY3VycmVudFBhcnNlZC5jbGFzc2VzLnB1c2goewoJCQl2YWx1ZTogY2xhc3NOYW1lLAoJCQlyZWdleHA6IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXNjYXBlUmVnRXhwKGNsYXNzTmFtZSkgKyAnKFxcc3wkKScpCgkJfSk7CgoJfSBlbHNlIGlmIChwc2V1ZG9DbGFzcyl7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgfHwgcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZTsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSA/IHBzZXVkb0NsYXNzVmFsdWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJykgOiBudWxsOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQucHNldWRvcykgY3VycmVudFBhcnNlZC5wc2V1ZG9zID0gW107CgkJY3VycmVudFBhcnNlZC5wc2V1ZG9zLnB1c2goewoJCQlrZXk6IHBzZXVkb0NsYXNzLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpLAoJCQl2YWx1ZTogcHNldWRvQ2xhc3NWYWx1ZSwKCQkJdHlwZTogcHNldWRvTWFya2VyLmxlbmd0aCA9PSAxID8gJ2NsYXNzJyA6ICdlbGVtZW50JwoJCX0pOwoKCX0gZWxzZSBpZiAoYXR0cmlidXRlS2V5KXsKCQlhdHRyaWJ1dGVLZXkgPSBhdHRyaWJ1dGVLZXkucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgkJYXR0cmlidXRlVmFsdWUgPSAoYXR0cmlidXRlVmFsdWUgfHwgJycpLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQl2YXIgdGVzdCwgcmVnZXhwOwoKCQlzd2l0Y2ggKGF0dHJpYnV0ZU9wZXJhdG9yKXsKCQkJY2FzZSAnXj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICAgICAgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJyQ9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICAgICAgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyQnICAgICAgICk7IGJyZWFrOwoJCQljYXNlICd+PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAnKF58XFxzKScrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoXFxzfCQpJyApOyBicmVhazsKCQkJY2FzZSAnfD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKC18JCknICAgKTsgYnJlYWs7CgkJCWNhc2UgICc9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgPT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQljYXNlICcqPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIHZhbHVlICYmIHZhbHVlLmluZGV4T2YoYXR0cmlidXRlVmFsdWUpID4gLTE7CgkJCX07IGJyZWFrOwoJCQljYXNlICchPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlICE9IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJZGVmYXVsdCAgIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiAhIXZhbHVlOwoJCQl9OwoJCX0KCgkJaWYgKGF0dHJpYnV0ZVZhbHVlID09ICcnICYmICgvXlsqJF5dPSQvKS50ZXN0KGF0dHJpYnV0ZU9wZXJhdG9yKSkgdGVzdCA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlpZiAoIXRlc3QpIHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiB2YWx1ZSAmJiByZWdleHAudGVzdCh2YWx1ZSk7CgkJfTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMpIGN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcy5wdXNoKHsKCQkJa2V5OiBhdHRyaWJ1dGVLZXksCgkJCW9wZXJhdG9yOiBhdHRyaWJ1dGVPcGVyYXRvciwKCQkJdmFsdWU6IGF0dHJpYnV0ZVZhbHVlLAoJCQl0ZXN0OiB0ZXN0CgkJfSk7CgoJfQoKCXJldHVybiAnJzsKfTsKCi8vIFNsaWNrIE5TCgp2YXIgU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay5wYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJcmV0dXJuIHBhcnNlKGV4cHJlc3Npb24pOwp9OwoKU2xpY2suZXNjYXBlUmVnRXhwID0gZXNjYXBlUmVnRXhwOwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgovKgotLS0KbmFtZTogU2xpY2suRmluZGVyCmRlc2NyaXB0aW9uOiBUaGUgbmV3LCBzdXBlcmZhc3QgY3NzIHNlbGVjdG9yIGVuZ2luZS4KcHJvdmlkZXM6IFNsaWNrLkZpbmRlcgpyZXF1aXJlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKOyhmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge30sCglmZWF0dXJlc0NhY2hlID0ge30sCgl0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8ICh0b1N0cmluZy5jYWxsKGRvY3VtZW50KSA9PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09IDkgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9ICdIVE1MJyk7Cn07Cgpsb2NhbC5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCgkvLyBjb252ZXJ0IGVsZW1lbnRzIC8gd2luZG93IGFyZ3VtZW50cyB0byBkb2N1bWVudC4gaWYgZG9jdW1lbnQgY2Fubm90IGJlIGV4dHJhcG9sYXRlZCwgdGhlIGZ1bmN0aW9uIHJldHVybnMuCgl2YXIgbm9kZVR5cGUgPSBkb2N1bWVudC5ub2RlVHlwZTsKCWlmIChub2RlVHlwZSA9PSA5KTsgLy8gZG9jdW1lbnQKCWVsc2UgaWYgKG5vZGVUeXBlKSBkb2N1bWVudCA9IGRvY3VtZW50Lm93bmVyRG9jdW1lbnQ7IC8vIG5vZGUKCWVsc2UgaWYgKGRvY3VtZW50Lm5hdmlnYXRvcikgZG9jdW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudDsgLy8gd2luZG93CgllbHNlIHJldHVybjsKCgkvLyBjaGVjayBpZiBpdCdzIHRoZSBvbGQgZG9jdW1lbnQKCglpZiAodGhpcy5kb2N1bWVudCA9PT0gZG9jdW1lbnQpIHJldHVybjsKCXRoaXMuZG9jdW1lbnQgPSBkb2N1bWVudDsKCgkvLyBjaGVjayBpZiB3ZSBoYXZlIGRvbmUgZmVhdHVyZSBkZXRlY3Rpb24gb24gdGhpcyBkb2N1bWVudCBiZWZvcmUKCgl2YXIgcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlyb290VWlkID0gdGhpcy5nZXRVSURYTUwocm9vdCksCgkJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdLAoJCWZlYXR1cmU7CgoJaWYgKGZlYXR1cmVzKXsKCQlmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCQl0aGlzW2ZlYXR1cmVdID0gZmVhdHVyZXNbZmVhdHVyZV07CgkJfQoJCXJldHVybjsKCX0KCglmZWF0dXJlcyA9IGZlYXR1cmVzQ2FjaGVbcm9vdFVpZF0gPSB7fTsKCglmZWF0dXJlcy5yb290ID0gcm9vdDsKCWZlYXR1cmVzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCglmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4KCT0gZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EKCT0gZmVhdHVyZXMuaWRHZXRzTmFtZQoJPSBmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EKCT0gZmVhdHVyZXMuYnJva2VuR0VCQ04KCT0gZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQQoJPSBmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQQoJPSBmZWF0dXJlcy5pc0hUTUxEb2N1bWVudAoJPSBmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lLAoJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXI7CgoJdmFyIHNlbGVjdGVkLCBpZCA9ICdzbGlja191bmlxdWVpZCc7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCgl2YXIgdGVzdFJvb3QgPSBkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF0gfHwgcm9vdDsKCXRlc3RSb290LmFwcGVuZENoaWxkKHRlc3ROb2RlKTsKCgkvLyBvbiBub24tSFRNTCBkb2N1bWVudHMgaW5uZXJIVE1MIGFuZCBnZXRFbGVtZW50c0J5SWQgZG9lc250IHdvcmsgcHJvcGVybHkKCXRyeSB7CgkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGlkPSInK2lkKyciPjwvYT4nOwoJCWZlYXR1cmVzLmlzSFRNTERvY3VtZW50ID0gISFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7Cgl9IGNhdGNoKGUpe307CgoJaWYgKGZlYXR1cmVzLmlzSFRNTERvY3VtZW50KXsKCgkJdGVzdE5vZGUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCgkJLy8gSUUgcmV0dXJucyBjb21tZW50IG5vZGVzIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRlc3ROb2RlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJycpKTsKCQlzdGFyU2VsZWN0c0NvbW1lbnRzID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoID4gMSk7CgoJCS8vIElFIHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJc3RhclNlbGVjdHNDbG9zZWQgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJfSBjYXRjaChlKXt9OwoKCQlmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4gPSBzdGFyU2VsZWN0c0NvbW1lbnRzIHx8IHN0YXJTZWxlY3RzQ2xvc2VkOwoKCQkvLyBJRSByZXR1cm5zIGVsZW1lbnRzIHdpdGggdGhlIG5hbWUgaW5zdGVhZCBvZiBqdXN0IGlkIGZvciBnZXRFbGVtZW50c0J5SWQgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIG5hbWU9IicrIGlkICsnIj48L2E+PGIgaWQ9IicrIGlkICsnIj48L2I+JzsKCQkJZmVhdHVyZXMuaWRHZXRzTmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSA9PT0gdGVzdE5vZGUuZmlyc3RDaGlsZDsKCQl9IGNhdGNoKGUpe307CgoJCWlmICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKXsKCgkJCS8vIFNhZmFyaSAzLjIgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYWNoZXMgcmVzdWx0cwoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJmIj48L2E+PGEgY2xhc3M9ImIiPjwvYT4nOwoJCQkJdGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYicpLmxlbmd0aDsKCQkJCXRlc3ROb2RlLmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gJ2InOwoJCQkJY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoICE9IDIpOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBPcGVyYSA5LjYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBkb2VzbnQgZGV0ZWN0cyB0aGUgY2xhc3MgaWYgaXRzIG5vdCB0aGUgZmlyc3Qgb25lCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9ImEiPjwvYT48YSBjbGFzcz0iZiBiIGEiPjwvYT4nOwoJCQkJYnJva2VuU2Vjb25kQ2xhc3NOYW1lR0VCQ04gPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYScpLmxlbmd0aCAhPSAyKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJZmVhdHVyZXMuYnJva2VuR0VCQ04gPSBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHx8IGJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOOwoJCX0KCgkJaWYgKHRlc3ROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwpewoJCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICdmb288L2Zvbz4nOwoJCQkJc2VsZWN0ZWQgPSB0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcqJyk7CgkJCQlmZWF0dXJlcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSA9IChzZWxlY3RlZCAmJiAhIXNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gU2FmYXJpIDMuMiBxdWVyeVNlbGVjdG9yQWxsIGRvZXNudCB3b3JrIHdpdGggbWl4ZWRjYXNlIG9uIHF1aXJrc21vZGUKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iTWlYIj48L2E+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYJykubGVuZ3RoOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBXZWJraXQgYW5kIE9wZXJhIGRvbnQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQkJZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCc6Y2hlY2tlZCcpLmxlbmd0aCA9PSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gSUUgcmV0dXJucyBpbmNvcnJlY3QgcmVzdWx0cyBmb3IgYXR0clsqXiRdPSIiIHNlbGVjdG9ycyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9IiI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQl9CgoJCS8vIElFNi03LCBpZiBhIGZvcm0gaGFzIGFuIGlucHV0IG9mIGlkIHgsIGZvcm0uZ2V0QXR0cmlidXRlKHgpIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGlucHV0CgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxmb3JtIGFjdGlvbj0icyI+PGlucHV0IGlkPSJhY3Rpb24iLz48L2Zvcm0+JzsKCQkJYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlciA9ICh0ZXN0Tm9kZS5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgnYWN0aW9uJykgIT0gJ3MnKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIG5hdGl2ZSBtYXRjaGVzU2VsZWN0b3IgZnVuY3Rpb24KCgkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yID0gcm9vdC5tYXRjaGVzU2VsZWN0b3IgfHwgLypyb290Lm1zTWF0Y2hlc1NlbGVjdG9yIHx8Ki8gcm9vdC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgcm9vdC53ZWJraXRNYXRjaGVzU2VsZWN0b3I7CgkJaWYgKGZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvcikgdHJ5IHsKCQkJLy8gaWYgbWF0Y2hlc1NlbGVjdG9yIHRyb3dzIGVycm9ycyBvbiBpbmNvcnJlY3Qgc2ludGF4ZXMgd2UgY2FuIHVzZSBpdAoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IuY2FsbChyb290LCAnOnNsaWNrJyk7CgkJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IG51bGw7CgkJfSBjYXRjaChlKXt9OwoKCX0KCgl0cnkgewoJCXJvb3Quc2xpY2tfZXhwYW5kbyA9IDE7CgkJZGVsZXRlIHJvb3Quc2xpY2tfZXhwYW5kbzsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJREhUTUw7Cgl9IGNhdGNoKGUpIHsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJRFhNTDsKCX0KCgl0ZXN0Um9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IHNlbGVjdGVkID0gdGVzdFJvb3QgPSBudWxsOwoKCS8vIGdldEF0dHJpYnV0ZQoKCWZlYXR1cmVzLmdldEF0dHJpYnV0ZSA9IChmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCAmJiBicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyKSA/IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJCXZhciBhdHRyaWJ1dGVOb2RlID0gbm9kZS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpOwoJCXJldHVybiAoYXR0cmlidXRlTm9kZSkgPyBhdHRyaWJ1dGVOb2RlLm5vZGVWYWx1ZSA6IG51bGw7Cgl9IDogZnVuY3Rpb24obm9kZSwgbmFtZSl7CgkJdmFyIG1ldGhvZCA9IHRoaXMuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKCQlyZXR1cm4gKG1ldGhvZCkgPyBtZXRob2QuY2FsbChub2RlKSA6IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwoJfTsKCgkvLyBoYXNBdHRyaWJ1dGUKCglmZWF0dXJlcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCWZlYXR1cmVzLmNvbnRhaW5zID0gKHJvb3QgJiYgdGhpcy5pc05hdGl2ZUNvZGUocm9vdC5jb250YWlucykpID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJcmV0dXJuIGNvbnRleHQuY29udGFpbnMobm9kZSk7Cgl9IDogKHJvb3QgJiYgcm9vdC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dCA9PT0gbm9kZSB8fCAhIShjb250ZXh0LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpOwoJfSA6IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCWlmIChub2RlKSBkbyB7CgkJCWlmIChub2RlID09PSBjb250ZXh0KSByZXR1cm4gdHJ1ZTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpOwoJCXJldHVybiBmYWxzZTsKCX07CgoJLy8gZG9jdW1lbnQgb3JkZXIgc29ydGluZwoJLy8gY3JlZGl0cyB0byBTaXp6bGUgKGh0dHA6Ly9zaXp6bGVqcy5jb20vKQoKCWZlYXR1cmVzLmRvY3VtZW50U29ydGVyID0gKHJvb3QuY29tcGFyZURvY3VtZW50UG9zaXRpb24pID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIHx8ICFiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSByZXR1cm4gMDsKCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDQgPyAtMSA6IGEgPT09IGIgPyAwIDogMTsKCX0gOiAoJ3NvdXJjZUluZGV4JyBpbiByb290KSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5zb3VyY2VJbmRleCB8fCAhYi5zb3VyY2VJbmRleCkgcmV0dXJuIDA7CgkJcmV0dXJuIGEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4OwoJfSA6IChkb2N1bWVudC5jcmVhdGVSYW5nZSkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEub3duZXJEb2N1bWVudCB8fCAhYi5vd25lckRvY3VtZW50KSByZXR1cm4gMDsKCQl2YXIgYVJhbmdlID0gYS5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCksIGJSYW5nZSA9IGIub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpOwoJCWFSYW5nZS5zZXRTdGFydChhLCAwKTsKCQlhUmFuZ2Uuc2V0RW5kKGEsIDApOwoJCWJSYW5nZS5zZXRTdGFydChiLCAwKTsKCQliUmFuZ2Uuc2V0RW5kKGIsIDApOwoJCXJldHVybiBhUmFuZ2UuY29tcGFyZUJvdW5kYXJ5UG9pbnRzKFJhbmdlLlNUQVJUX1RPX0VORCwgYlJhbmdlKTsKCX0gOiBudWxsIDsKCglyb290ID0gbnVsbDsKCglmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCXRoaXNbZmVhdHVyZV0gPSBmZWF0dXJlc1tmZWF0dXJlXTsKCX0KfTsKCi8vIE1haW4gTWV0aG9kCgp2YXIgcmVTaW1wbGVTZWxlY3RvciA9IC9eKFsjLl0/KSgoPzpbXHctXSt8XCopKSQvLAoJcmVFbXB0eUF0dHJpYnV0ZSA9IC9cWy4rWyokXl09KD86IiJ8JycpP1xdLywKCXFzYUZhaWxFeHBDYWNoZSA9IHt9OwoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgoJaWYgKCFjb250ZXh0KSByZXR1cm4gZm91bmQ7CgllbHNlIGlmIChjb250ZXh0Lm5hdmlnYXRvcikgY29udGV4dCA9IGNvbnRleHQuZG9jdW1lbnQ7IC8vIENvbnZlcnQgdGhlIG5vZGUgZnJvbSBhIHdpbmRvdyB0byBhIGRvY3VtZW50CgllbHNlIGlmICghY29udGV4dC5ub2RlVHlwZSkgcmV0dXJuIGZvdW5kOwoKCS8vIHNldHVwCgoJdmFyIHBhcnNlZCwgaSwKCQl1bmlxdWVzID0gdGhpcy51bmlxdWVzID0ge30sCgkJaGFzT3RoZXJzID0gISEoYXBwZW5kICYmIGFwcGVuZC5sZW5ndGgpLAoJCWNvbnRleHRJc0RvY3VtZW50ID0gKGNvbnRleHQubm9kZVR5cGUgPT0gOSk7CgoJaWYgKHRoaXMuZG9jdW1lbnQgIT09IChjb250ZXh0SXNEb2N1bWVudCA/IGNvbnRleHQgOiBjb250ZXh0Lm93bmVyRG9jdW1lbnQpKSB0aGlzLnNldERvY3VtZW50KGNvbnRleHQpOwoKCS8vIGF2b2lkIGR1cGxpY2F0aW5nIGl0ZW1zIGFscmVhZHkgaW4gdGhlIGFwcGVuZCBhcnJheQoJaWYgKGhhc090aGVycykgZm9yIChpID0gZm91bmQubGVuZ3RoOyBpLS07KSB1bmlxdWVzW3RoaXMuZ2V0VUlEKGZvdW5kW2ldKV0gPSB0cnVlOwoKCS8vIGV4cHJlc3Npb24gY2hlY2tzCgoJaWYgKHR5cGVvZiBleHByZXNzaW9uID09ICdzdHJpbmcnKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHN0cmluZwoKCQkvKjxzaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgkJdmFyIHNpbXBsZVNlbGVjdG9yID0gZXhwcmVzc2lvbi5tYXRjaChyZVNpbXBsZVNlbGVjdG9yKTsKCQlzaW1wbGVTZWxlY3RvcnM6IGlmIChzaW1wbGVTZWxlY3RvcikgewoKCQkJdmFyIHN5bWJvbCA9IHNpbXBsZVNlbGVjdG9yWzFdLAoJCQkJbmFtZSA9IHNpbXBsZVNlbGVjdG9yWzJdLAoJCQkJbm9kZSwgbm9kZXM7CgoJCQlpZiAoIXN5bWJvbCl7CgoJCQkJaWYgKG5hbWUgPT0gJyonICYmIHRoaXMuYnJva2VuU3RhckdFQlROKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUobmFtZSk7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJfQoKCQkJfSBlbHNlIGlmIChzeW1ib2wgPT0gJyMnKXsKCgkJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQgfHwgIWNvbnRleHRJc0RvY3VtZW50KSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChuYW1lKTsKCQkJCWlmICghbm9kZSkgcmV0dXJuIGZvdW5kOwoJCQkJaWYgKHRoaXMuaWRHZXRzTmFtZSAmJiBub2RlLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IG5hbWUpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGUgfHwgbnVsbDsKCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnLicpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAoKCFjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgdGhpcy5icm9rZW5HRUJDTikgJiYgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiAhdGhpcy5icm9rZW5HRUJDTil7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobmFtZSk7CgkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCQkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdmFyIG1hdGNoQ2xhc3MgPSBuZXcgUmVnRXhwKCcoXnxcXHMpJysgU2xpY2suZXNjYXBlUmVnRXhwKG5hbWUpICsnKFxcc3wkKScpOwoJCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWNsYXNzTmFtZSA9IG5vZGUuY2xhc3NOYW1lOwoJCQkJCQlpZiAoIShjbGFzc05hbWUgJiYgbWF0Y2hDbGFzcy50ZXN0KGNsYXNzTmFtZSkpKSBjb250aW51ZTsKCQkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZTsKCQkJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJCQl9CgkJCQl9CgoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gKGZpcnN0KSA/IG51bGwgOiBmb3VuZDsKCgkJfQoJCS8qPC9zaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgoJCS8qPHF1ZXJ5LXNlbGVjdG9yLW92ZXJyaWRlPiovCgkJcXVlcnlTZWxlY3RvcjogaWYgKGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCkgewoKCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50IHx8IHRoaXMuYnJva2VuTWl4ZWRDYXNlUVNBIHx8IHFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXSB8fAoJCQkodGhpcy5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKSB8fAoJCQkodGhpcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSAmJiByZUVtcHR5QXR0cmlidXRlLnRlc3QoZXhwcmVzc2lvbikpIHx8IFNsaWNrLmRpc2FibGVRU0EpIGJyZWFrIHF1ZXJ5U2VsZWN0b3I7CgoJCQl2YXIgX2V4cHJlc3Npb24gPSBleHByZXNzaW9uOwoJCQlpZiAoIWNvbnRleHRJc0RvY3VtZW50KXsKCQkJCS8vIG5vbi1kb2N1bWVudCByb290ZWQgUVNBCgkJCQkvLyBjcmVkaXRzIHRvIEFuZHJldyBEdXBvbnQKCQkJCXZhciBjdXJyZW50SWQgPSBjb250ZXh0LmdldEF0dHJpYnV0ZSgnaWQnKSwgc2xpY2tpZCA9ICdzbGlja2lkX18nOwoJCQkJY29udGV4dC5zZXRBdHRyaWJ1dGUoJ2lkJywgc2xpY2tpZCk7CgkJCQlfZXhwcmVzc2lvbiA9ICcjJyArIHNsaWNraWQgKyAnICcgKyBfZXhwcmVzc2lvbjsKCQkJfQoKCQkJdHJ5IHsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvcihfZXhwcmVzc2lvbikgfHwgbnVsbDsKCQkJCWVsc2Ugbm9kZXMgPSBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoX2V4cHJlc3Npb24pOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXSA9IDE7CgkJCQlicmVhayBxdWVyeVNlbGVjdG9yOwoJCQl9IGZpbmFsbHkgewoJCQkJaWYgKCFjb250ZXh0SXNEb2N1bWVudCl7CgkJCQkJaWYgKGN1cnJlbnRJZCkgY29udGV4dC5zZXRBdHRyaWJ1dGUoJ2lkJywgY3VycmVudElkKTsKCQkJCQllbHNlIGNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwoJCQkJfQoJCQl9CgoJCQlpZiAodGhpcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSkgZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCWlmIChub2RlLm5vZGVOYW1lID4gJ0AnICYmICEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gZm91bmQ7CgoJCX0KCQkvKjwvcXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCgkJcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShleHByZXNzaW9uKTsKCQlpZiAoIXBhcnNlZC5sZW5ndGgpIHJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbiA9PSBudWxsKXsgLy8gdGhlcmUgaXMgbm8gZXhwcmVzc2lvbgoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbi5TbGljayl7IC8vIGV4cHJlc3Npb24gaXMgYSBwYXJzZWQgU2xpY2sgb2JqZWN0CgkJcGFyc2VkID0gZXhwcmVzc2lvbjsKCX0gZWxzZSBpZiAodGhpcy5jb250YWlucyhjb250ZXh0LmRvY3VtZW50RWxlbWVudCB8fCBjb250ZXh0LCBleHByZXNzaW9uKSl7IC8vIGV4cHJlc3Npb24gaXMgYSBub2RlCgkJKGZvdW5kKSA/IGZvdW5kLnB1c2goZXhwcmVzc2lvbikgOiBmb3VuZCA9IGV4cHJlc3Npb247CgkJcmV0dXJuIGZvdW5kOwoJfSBlbHNlIHsgLy8gb3RoZXIganVuawoJCXJldHVybiBmb3VuZDsKCX0KCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjYWNoZSBlbGVtZW50cyBmb3IgdGhlIG50aCBzZWxlY3RvcnMKCgl0aGlzLnBvc05USCA9IHt9OwoJdGhpcy5wb3NOVEhMYXN0ID0ge307Cgl0aGlzLnBvc05USFR5cGUgPSB7fTsKCXRoaXMucG9zTlRIVHlwZUxhc3QgPSB7fTsKCgkvKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8vKjwvcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGlmIGFwcGVuZCBpcyBudWxsIGFuZCB0aGVyZSBpcyBvbmx5IGEgc2luZ2xlIHNlbGVjdG9yIHdpdGggb25lIGV4cHJlc3Npb24gdXNlIHB1c2hBcnJheSwgZWxzZSB1c2UgcHVzaFVJRAoJdGhpcy5wdXNoID0gKCFoYXNPdGhlcnMgJiYgKGZpcnN0IHx8IChwYXJzZWQubGVuZ3RoID09IDEgJiYgcGFyc2VkLmV4cHJlc3Npb25zWzBdLmxlbmd0aCA9PSAxKSkpID8gdGhpcy5wdXNoQXJyYXkgOiB0aGlzLnB1c2hVSUQ7CgoJaWYgKGZvdW5kID09IG51bGwpIGZvdW5kID0gW107CgoJLy8gZGVmYXVsdCBlbmdpbmUKCgl2YXIgaiwgbSwgbjsKCXZhciBjb21iaW5hdG9yLCB0YWcsIGlkLCBjbGFzc0xpc3QsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3M7Cgl2YXIgY3VycmVudEl0ZW1zLCBjdXJyZW50RXhwcmVzc2lvbiwgY3VycmVudEJpdCwgbGFzdEJpdCwgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnM7CgoJc2VhcmNoOiBmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKykgZm9yIChqID0gMDsgKGN1cnJlbnRCaXQgPSBjdXJyZW50RXhwcmVzc2lvbltqXSk7IGorKyl7CgoJCWNvbWJpbmF0b3IgPSAnY29tYmluYXRvcjonICsgY3VycmVudEJpdC5jb21iaW5hdG9yOwoJCWlmICghdGhpc1tjb21iaW5hdG9yXSkgY29udGludWUgc2VhcmNoOwoKCQl0YWcgICAgICAgID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBjdXJyZW50Qml0LnRhZyA6IGN1cnJlbnRCaXQudGFnLnRvVXBwZXJDYXNlKCk7CgkJaWQgICAgICAgICA9IGN1cnJlbnRCaXQuaWQ7CgkJY2xhc3NMaXN0ICA9IGN1cnJlbnRCaXQuY2xhc3NMaXN0OwoJCWNsYXNzZXMgICAgPSBjdXJyZW50Qml0LmNsYXNzZXM7CgkJYXR0cmlidXRlcyA9IGN1cnJlbnRCaXQuYXR0cmlidXRlczsKCQlwc2V1ZG9zICAgID0gY3VycmVudEJpdC5wc2V1ZG9zOwoJCWxhc3RCaXQgICAgPSAoaiA9PT0gKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCAtIDEpKTsKCgkJdGhpcy5iaXRVbmlxdWVzID0ge307CgoJCWlmIChsYXN0Qml0KXsKCQkJdGhpcy51bmlxdWVzID0gdW5pcXVlczsKCQkJdGhpcy5mb3VuZCA9IGZvdW5kOwoJCX0gZWxzZSB7CgkJCXRoaXMudW5pcXVlcyA9IHt9OwoJCQl0aGlzLmZvdW5kID0gW107CgkJfQoKCQlpZiAoaiA9PT0gMCl7CgkJCXRoaXNbY29tYmluYXRvcl0oY29udGV4dCwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQgJiYgZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJfSBlbHNlIHsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQpIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKXsKCQkJCXRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQkJaWYgKGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCQl9IGVsc2UgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspIHRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCX0KCgkJY3VycmVudEl0ZW1zID0gdGhpcy5mb3VuZDsKCX0KCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCWlmIChoYXNPdGhlcnMgfHwgKHBhcnNlZC5leHByZXNzaW9ucy5sZW5ndGggPiAxKSkgdGhpcy5zb3J0KGZvdW5kKTsKCglyZXR1cm4gKGZpcnN0KSA/IChmb3VuZFswXSB8fCBudWxsKSA6IGZvdW5kOwp9OwoKLy8gVXRpbHMKCmxvY2FsLnVpZHggPSAxOwpsb2NhbC51aWRrID0gJ3NsaWNrLXVuaXF1ZWlkJzsKCmxvY2FsLmdldFVJRFhNTCA9IGZ1bmN0aW9uKG5vZGUpewoJdmFyIHVpZCA9IG5vZGUuZ2V0QXR0cmlidXRlKHRoaXMudWlkayk7CglpZiAoIXVpZCl7CgkJdWlkID0gdGhpcy51aWR4Kys7CgkJbm9kZS5zZXRBdHRyaWJ1dGUodGhpcy51aWRrLCB1aWQpOwoJfQoJcmV0dXJuIHVpZDsKfTsKCmxvY2FsLmdldFVJREhUTUwgPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiBub2RlLnVuaXF1ZU51bWJlciB8fCAobm9kZS51bmlxdWVOdW1iZXIgPSB0aGlzLnVpZHgrKyk7Cn07CgovLyBzb3J0IGJhc2VkIG9uIHRoZSBzZXREb2N1bWVudCBkb2N1bWVudFNvcnRlciBtZXRob2QuCgpsb2NhbC5zb3J0ID0gZnVuY3Rpb24ocmVzdWx0cyl7CglpZiAoIXRoaXMuZG9jdW1lbnRTb3J0ZXIpIHJldHVybiByZXN1bHRzOwoJcmVzdWx0cy5zb3J0KHRoaXMuZG9jdW1lbnRTb3J0ZXIpOwoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLmNhY2hlTlRIID0ge307Cgpsb2NhbC5tYXRjaE5USCA9IC9eKFsrLV0/XGQqKT8oW2Etel0rKT8oWystXVxkKyk/JC87Cgpsb2NhbC5wYXJzZU5USEFyZ3VtZW50ID0gZnVuY3Rpb24oYXJndW1lbnQpewoJdmFyIHBhcnNlZCA9IGFyZ3VtZW50Lm1hdGNoKHRoaXMubWF0Y2hOVEgpOwoJaWYgKCFwYXJzZWQpIHJldHVybiBmYWxzZTsKCXZhciBzcGVjaWFsID0gcGFyc2VkWzJdIHx8IGZhbHNlOwoJdmFyIGEgPSBwYXJzZWRbMV0gfHwgMTsKCWlmIChhID09ICctJykgYSA9IC0xOwoJdmFyIGIgPSArcGFyc2VkWzNdIHx8IDA7CglwYXJzZWQgPQoJCShzcGVjaWFsID09ICduJykJPyB7YTogYSwgYjogYn0gOgoJCShzcGVjaWFsID09ICdvZGQnKQk/IHthOiAyLCBiOiAxfSA6CgkJKHNwZWNpYWwgPT0gJ2V2ZW4nKQk/IHthOiAyLCBiOiAwfSA6IHthOiAwLCBiOiBhfTsKCglyZXR1cm4gKHRoaXMuY2FjaGVOVEhbYXJndW1lbnRdID0gcGFyc2VkKTsKfTsKCmxvY2FsLmNyZWF0ZU5USFBzZXVkbyA9IGZ1bmN0aW9uKGNoaWxkLCBzaWJsaW5nLCBwb3NpdGlvbnMsIG9mVHlwZSl7CglyZXR1cm4gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQlpZiAoIXRoaXNbcG9zaXRpb25zXVt1aWRdKXsKCQkJdmFyIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKCQkJaWYgKCFwYXJlbnQpIHJldHVybiBmYWxzZTsKCQkJdmFyIGVsID0gcGFyZW50W2NoaWxkXSwgY291bnQgPSAxOwoJCQlpZiAob2ZUeXBlKXsKCQkJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVOYW1lICE9IG5vZGVOYW1lKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9IGVsc2UgewoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAodGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvcil7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwobm9kZSwgc2VsZWN0b3IucmVwbGFjZSgvXFsoW149XSspPVxzKihbXiciXF1dKz8pXHMqXF0vZywgJ1skMT0iJDIiXScpKTsKCQl9IGNhdGNoKG1hdGNoRXJyb3IpIHt9Cgl9CgoJdmFyIHBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2Uoc2VsZWN0b3IpOwoJaWYgKCFwYXJzZWQpIHJldHVybiB0cnVlOwoKCS8vIHNpbXBsZSAoc2luZ2xlKSBzZWxlY3RvcnMKCXZhciBleHByZXNzaW9ucyA9IHBhcnNlZC5leHByZXNzaW9ucywgcmV2ZXJzZWRFeHByZXNzaW9ucywgc2ltcGxlRXhwQ291bnRlciA9IDAsIGk7Cglmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKyl7CgkJaWYgKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCA9PSAxKXsKCQkJdmFyIGV4cCA9IGN1cnJlbnRFeHByZXNzaW9uWzBdOwoJCQlpZiAodGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gZXhwLnRhZyA6IGV4cC50YWcudG9VcHBlckNhc2UoKSwgZXhwLmlkLCBleHAuY2xhc3NlcywgZXhwLmF0dHJpYnV0ZXMsIGV4cC5wc2V1ZG9zKSkgcmV0dXJuIHRydWU7CgkJCXNpbXBsZUV4cENvdW50ZXIrKzsKCQl9Cgl9CgoJaWYgKHNpbXBsZUV4cENvdW50ZXIgPT0gcGFyc2VkLmxlbmd0aCkgcmV0dXJuIGZhbHNlOwoKCXZhciBub2RlcyA9IHRoaXMuc2VhcmNoKHRoaXMuZG9jdW1lbnQsIHBhcnNlZCksIGl0ZW07Cglmb3IgKGkgPSAwOyBpdGVtID0gbm9kZXNbaSsrXTspewoJCWlmIChpdGVtID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCX0KCXJldHVybiBmYWxzZTsKfTsKCmxvY2FsLm1hdGNoUHNldWRvID0gZnVuY3Rpb24obm9kZSwgbmFtZSwgYXJndW1lbnQpewoJdmFyIHBzZXVkb05hbWUgPSAncHNldWRvOicgKyBuYW1lOwoJaWYgKHRoaXNbcHNldWRvTmFtZV0pIHJldHVybiB0aGlzW3BzZXVkb05hbWVdKG5vZGUsIGFyZ3VtZW50KTsKCXZhciBhdHRyaWJ1dGUgPSB0aGlzLmdldEF0dHJpYnV0ZShub2RlLCBuYW1lKTsKCXJldHVybiAoYXJndW1lbnQpID8gYXJndW1lbnQgPT0gYXR0cmlidXRlIDogISFhdHRyaWJ1dGU7Cn07Cgpsb2NhbC5tYXRjaFNlbGVjdG9yID0gZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7CglpZiAodGFnKXsKCQl2YXIgbm9kZU5hbWUgPSAodGhpcy5pc1hNTERvY3VtZW50KSA/IG5vZGUubm9kZU5hbWUgOiBub2RlLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCk7CgkJaWYgKHRhZyA9PSAnKicpewoJCQlpZiAobm9kZU5hbWUgPCAnQCcpIHJldHVybiBmYWxzZTsgLy8gRml4IGZvciBjb21tZW50IG5vZGVzIGFuZCBjbG9zZWQgbm9kZXMKCQl9IGVsc2UgewoJCQlpZiAobm9kZU5hbWUgIT0gdGFnKSByZXR1cm4gZmFsc2U7CgkJfQoJfQoKCWlmIChpZCAmJiBub2RlLmdldEF0dHJpYnV0ZSgnaWQnKSAhPSBpZCkgcmV0dXJuIGZhbHNlOwoKCXZhciBpLCBwYXJ0LCBjbHM7CglpZiAoY2xhc3NlcykgZm9yIChpID0gY2xhc3Nlcy5sZW5ndGg7IGktLTspewoJCWNscyA9IG5vZGUuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8IG5vZGUuY2xhc3NOYW1lOwoJCWlmICghKGNscyAmJiBjbGFzc2VzW2ldLnJlZ2V4cC50ZXN0KGNscykpKSByZXR1cm4gZmFsc2U7Cgl9CglpZiAoYXR0cmlidXRlcykgZm9yIChpID0gYXR0cmlidXRlcy5sZW5ndGg7IGktLTspewoJCXBhcnQgPSBhdHRyaWJ1dGVzW2ldOwoJCWlmIChwYXJ0Lm9wZXJhdG9yID8gIXBhcnQudGVzdCh0aGlzLmdldEF0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIDogIXRoaXMuaGFzQXR0cmlidXRlKG5vZGUsIHBhcnQua2V5KSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKHBzZXVkb3MpIGZvciAoaSA9IHBzZXVkb3MubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gcHNldWRvc1tpXTsKCQlpZiAoIXRoaXMubWF0Y2hQc2V1ZG8obm9kZSwgcGFydC5rZXksIHBhcnQudmFsdWUpKSByZXR1cm4gZmFsc2U7Cgl9CglyZXR1cm4gdHJ1ZTsKfTsKCnZhciBjb21iaW5hdG9ycyA9IHsKCgknICc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCl7IC8vIGFsbCBjaGlsZCBub2RlcywgYW55IGxldmVsCgoJCXZhciBpLCBpdGVtLCBjaGlsZHJlbjsKCgkJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQpewoJCQlnZXRCeUlkOiBpZiAoaWQpewoJCQkJaXRlbSA9IHRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJCQkJaWYgKCghaXRlbSAmJiBub2RlLmFsbCkgfHwgKHRoaXMuaWRHZXRzTmFtZSAmJiBpdGVtICYmIGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgIT0gaWQpKXsKCQkJCQkvLyBhbGxbaWRdIHJldHVybnMgYWxsIHRoZSBlbGVtZW50cyB3aXRoIHRoYXQgbmFtZSBvciBpZCBpbnNpZGUgbm9kZQoJCQkJCS8vIGlmIHRoZXJlcyBqdXN0IG9uZSBpdCB3aWxsIHJldHVybiB0aGUgZWxlbWVudCwgZWxzZSBpdCB3aWxsIGJlIGEgY29sbGVjdGlvbgoJCQkJCWNoaWxkcmVuID0gbm9kZS5hbGxbaWRdOwoJCQkJCWlmICghY2hpbGRyZW4pIHJldHVybjsKCQkJCQlpZiAoIWNoaWxkcmVuWzBdKSBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CgkJCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KXsKCQkJCQkJdmFyIGlkTm9kZSA9IGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKTsKCQkJCQkJaWYgKGlkTm9kZSAmJiBpZE5vZGUubm9kZVZhbHVlID09IGlkKXsKCQkJCQkJCXRoaXMucHVzaChpdGVtLCB0YWcsIG51bGwsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFpdGVtKXsKCQkJCQkvLyBpZiB0aGUgY29udGV4dCBpcyBpbiB0aGUgZG9tIHdlIHJldHVybiwgZWxzZSB3ZSB3aWxsIHRyeSBHRUJUTiwgYnJlYWtpbmcgdGhlIGdldEJ5SWQgbGFiZWwKCQkJCQlpZiAodGhpcy5jb250YWlucyh0aGlzLnJvb3QsIG5vZGUpKSByZXR1cm47CgkJCQkJZWxzZSBicmVhayBnZXRCeUlkOwoJCQkJfSBlbHNlIGlmICh0aGlzLmRvY3VtZW50ICE9PSBub2RlICYmICF0aGlzLmNvbnRhaW5zKG5vZGUsIGl0ZW0pKSByZXR1cm47CgkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCXJldHVybjsKCQkJfQoJCQlnZXRCeUNsYXNzOiBpZiAoY2xhc3NlcyAmJiBub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgIXRoaXMuYnJva2VuR0VCQ04pewoJCQkJY2hpbGRyZW4gPSBub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NMaXN0LmpvaW4oJyAnKSk7CgkJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeUNsYXNzOwoJCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgbnVsbCwgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJZ2V0QnlUYWc6IHsKCQkJY2hpbGRyZW4gPSBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CgkJCWlmICghKGNoaWxkcmVuICYmIGNoaWxkcmVuLmxlbmd0aCkpIGJyZWFrIGdldEJ5VGFnOwoJCQlpZiAoIXRoaXMuYnJva2VuU3RhckdFQlROKSB0YWcgPSBudWxsOwoJCQlmb3IgKGkgPSAwOyBpdGVtID0gY2hpbGRyZW5baSsrXTspIHRoaXMucHVzaChpdGVtLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSc+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGRpcmVjdCBjaGlsZHJlbgoJCWlmICgobm9kZSA9IG5vZGUuZmlyc3RDaGlsZCkpIGRvIHsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0gd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpOwoJfSwKCgknKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmcKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBmaXJzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWVsc2UgdGhpc1snY29tYmluYXRvcjorJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmdzCgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpewoJCQlpZiAobm9kZS5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCScrKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmcgYW5kIHByZXZpb3VzIHNpYmxpbmcKCQl0aGlzWydjb21iaW5hdG9yOisnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl0aGlzWydjb21iaW5hdG9yOiErJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSd+fic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmdzIGFuZCBwcmV2aW91cyBzaWJsaW5ncwoJCXRoaXNbJ2NvbWJpbmF0b3I6fiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6IX4nXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyEnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gYWxsIHBhcmVudCBub2RlcyB1cCB0byBkb2N1bWVudAoJCXdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpIGlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgcGFyZW50IChvbmUgbGV2ZWwpCgkJbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCQlpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISsnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknIV4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbGFzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmxhc3RDaGlsZDsKCQlpZiAobm9kZSl7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJZWxzZSB0aGlzWydjb21iaW5hdG9yOiErJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknIX4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZ3MKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpewoJCQlpZiAobm9kZS5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9Cgp9OwoKZm9yICh2YXIgYyBpbiBjb21iaW5hdG9ycykgbG9jYWxbJ2NvbWJpbmF0b3I6JyArIGNdID0gY29tYmluYXRvcnNbY107Cgp2YXIgcHNldWRvcyA9IHsKCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2VtcHR5JzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIGNoaWxkID0gbm9kZS5maXJzdENoaWxkOwoJCXJldHVybiAhKGNoaWxkICYmIGNoaWxkLm5vZGVUeXBlID09IDEpICYmICEobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykubGVuZ3RoOwoJfSwKCgknbm90JzogZnVuY3Rpb24obm9kZSwgZXhwcmVzc2lvbil7CgkJcmV0dXJuICF0aGlzLm1hdGNoTm9kZShub2RlLCBleHByZXNzaW9uKTsKCX0sCgoJJ2NvbnRhaW5zJzogZnVuY3Rpb24obm9kZSwgdGV4dCl7CgkJcmV0dXJuIChub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5pbmRleE9mKHRleHQpID4gLTE7Cgl9LAoKCSdmaXJzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LWNoaWxkJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIHByZXYgPSBub2RlOwoJCXdoaWxlICgocHJldiA9IHByZXYucHJldmlvdXNTaWJsaW5nKSkgaWYgKHByZXYubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgkvKjxudGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdudGgtY2hpbGQnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2ZpcnN0Q2hpbGQnLCAnbmV4dFNpYmxpbmcnLCAncG9zTlRIJyksCgoJJ250aC1sYXN0LWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdsYXN0Q2hpbGQnLCAncHJldmlvdXNTaWJsaW5nJywgJ3Bvc05USExhc3QnKSwKCgknbnRoLW9mLXR5cGUnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2ZpcnN0Q2hpbGQnLCAnbmV4dFNpYmxpbmcnLCAncG9zTlRIVHlwZScsIHRydWUpLAoKCSdudGgtbGFzdC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdsYXN0Q2hpbGQnLCAncHJldmlvdXNTaWJsaW5nJywgJ3Bvc05USFR5cGVMYXN0JywgdHJ1ZSksCgoJJ2luZGV4JzogZnVuY3Rpb24obm9kZSwgaW5kZXgpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJycgKyBpbmRleCArIDEpOwoJfSwKCgknZXZlbic6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJzJuJyk7Cgl9LAoKCSdvZGQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybisxJyk7Cgl9LAoKCS8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8qPG9mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdmaXJzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdsYXN0LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknb25seS1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIHByZXYgPSBub2RlLCBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8L29mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGN1c3RvbSBwc2V1ZG9zCgoJJ2VuYWJsZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gIW5vZGUuZGlzYWJsZWQ7Cgl9LAoKCSdkaXNhYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLmRpc2FibGVkOwoJfSwKCgknY2hlY2tlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLmNoZWNrZWQgfHwgbm9kZS5zZWxlY3RlZDsKCX0sCgoJJ2ZvY3VzJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXMuaXNIVE1MRG9jdW1lbnQgJiYgdGhpcy5kb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSBub2RlICYmIChub2RlLmhyZWYgfHwgbm9kZS50eXBlIHx8IHRoaXMuaGFzQXR0cmlidXRlKG5vZGUsICd0YWJpbmRleCcpKTsKCX0sCgoJJ3Jvb3QnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gKG5vZGUgPT09IHRoaXMucm9vdCk7Cgl9LAoKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCB0aGlzLmNsYXNzTmFtZTsKCX0sCgoJJ2Zvcic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHRtbEZvcicgaW4gdGhpcykgPyB0aGlzLmh0bWxGb3IgOiB0aGlzLmdldEF0dHJpYnV0ZSgnZm9yJyk7Cgl9LAoKCSdocmVmJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdocmVmJyBpbiB0aGlzKSA/IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJywgMikgOiB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5zdHlsZSkgPyB0aGlzLnN0eWxlLmNzc1RleHQgOiB0aGlzLmdldEF0dHJpYnV0ZSgnc3R5bGUnKTsKCX0sCgoJJ3RhYmluZGV4JzogZnVuY3Rpb24oKXsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgndGFiaW5kZXgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSwKCgkndHlwZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0QXR0cmlidXRlKCd0eXBlJyk7Cgl9Cgp9OwoKLy8gU2xpY2sKCnZhciBTbGljayA9IGxvY2FsLlNsaWNrID0gKHRoaXMuU2xpY2sgfHwge30pOwoKU2xpY2sudmVyc2lvbiA9ICcxLjEuNSc7CgovLyBTbGljayBmaW5kZXIKClNsaWNrLnNlYXJjaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCl7CglyZXR1cm4gbG9jYWwuc2VhcmNoKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCk7Cn07CgpTbGljay5maW5kID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbil7CglyZXR1cm4gbG9jYWwuc2VhcmNoKGNvbnRleHQsIGV4cHJlc3Npb24sIG51bGwsIHRydWUpOwp9OwoKLy8gU2xpY2sgY29udGFpbm1lbnQgY2hlY2tlcgoKU2xpY2suY29udGFpbnMgPSBmdW5jdGlvbihjb250YWluZXIsIG5vZGUpewoJbG9jYWwuc2V0RG9jdW1lbnQoY29udGFpbmVyKTsKCXJldHVybiBsb2NhbC5jb250YWlucyhjb250YWluZXIsIG5vZGUpOwp9OwoKLy8gU2xpY2sgYXR0cmlidXRlIGdldHRlcgoKU2xpY2suZ2V0QXR0cmlidXRlID0gZnVuY3Rpb24obm9kZSwgbmFtZSl7CglyZXR1cm4gbG9jYWwuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwp9OwoKLy8gU2xpY2sgbWF0Y2hlcgoKU2xpY2subWF0Y2ggPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAoIShub2RlICYmIHNlbGVjdG9yKSkgcmV0dXJuIGZhbHNlOwoJaWYgKCFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cglsb2NhbC5zZXREb2N1bWVudChub2RlKTsKCXJldHVybiBsb2NhbC5tYXRjaE5vZGUobm9kZSwgc2VsZWN0b3IpOwp9OwoKLy8gU2xpY2sgYXR0cmlidXRlIGFjY2Vzc29yCgpTbGljay5kZWZpbmVBdHRyaWJ1dGVHZXR0ZXIgPSBmdW5jdGlvbihuYW1lLCBmbil7Cglsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdID0gZm47CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmxvb2t1cEF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUpewoJcmV0dXJuIGxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07Cn07CgovLyBTbGljayBwc2V1ZG8gYWNjZXNzb3IKClNsaWNrLmRlZmluZVBzZXVkbyA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsWydwc2V1ZG86JyArIG5hbWVdID0gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXJldHVybiBmbi5jYWxsKG5vZGUsIGFyZ3VtZW50KTsKCX07CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmxvb2t1cFBzZXVkbyA9IGZ1bmN0aW9uKG5hbWUpewoJdmFyIHBzZXVkbyA9IGxvY2FsWydwc2V1ZG86JyArIG5hbWVdOwoJaWYgKHBzZXVkbykgcmV0dXJuIGZ1bmN0aW9uKGFyZ3VtZW50KXsKCQlyZXR1cm4gcHNldWRvLmNhbGwodGhpcywgYXJndW1lbnQpOwoJfTsKCXJldHVybiBudWxsOwp9OwoKLy8gU2xpY2sgb3ZlcnJpZGVzIGFjY2Vzc29yCgpTbGljay5vdmVycmlkZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgZm4pewoJbG9jYWwub3ZlcnJpZGUocmVnZXhwLCBmbik7CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmlzWE1MID0gbG9jYWwuaXNYTUw7CgpTbGljay51aWRPZiA9IGZ1bmN0aW9uKG5vZGUpewoJcmV0dXJuIGxvY2FsLmdldFVJREhUTUwobm9kZSk7Cn07CgppZiAoIXRoaXMuU2xpY2spIHRoaXMuU2xpY2sgPSBTbGljazsKCn0pLmFwcGx5KC8qPENvbW1vbkpTPiovKHR5cGVvZiBleHBvcnRzICE9ICd1bmRlZmluZWQnKSA/IGV4cG9ydHMgOiAvKjwvQ29tbW9uSlM+Ki90aGlzKTsKCi8qCi0tLQoKbmFtZTogRWxlbWVudAoKZGVzY3JpcHRpb246IE9uZSBvZiB0aGUgbW9zdCBpbXBvcnRhbnQgaXRlbXMgaW4gTW9vVG9vbHMuIENvbnRhaW5zIHRoZSBkb2xsYXIgZnVuY3Rpb24sIHRoZSBkb2xsYXJzIGZ1bmN0aW9uLCBhbmQgYW4gaGFuZGZ1bCBvZiBjcm9zcy1icm93c2VyLCB0aW1lLXNhdmVyIG1ldGhvZHMgdG8gbGV0IHlvdSBlYXNpbHkgd29yayB3aXRoIEhUTUwgRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE51bWJlciwgU2xpY2suUGFyc2VyLCBTbGljay5GaW5kZXJdCgpwcm92aWRlczogW0VsZW1lbnQsIEVsZW1lbnRzLCAkLCAkJCwgSWZyYW1lLCBTZWxlY3RvcnNdCgouLi4KKi8KCnZhciBFbGVtZW50ID0gZnVuY3Rpb24odGFnLCBwcm9wcyl7Cgl2YXIga29uc3RydWN0b3IgPSBFbGVtZW50LkNvbnN0cnVjdG9yc1t0YWddOwoJaWYgKGtvbnN0cnVjdG9yKSByZXR1cm4ga29uc3RydWN0b3IocHJvcHMpOwoJaWYgKHR5cGVvZiB0YWcgIT0gJ3N0cmluZycpIHJldHVybiBkb2N1bWVudC5pZCh0YWcpLnNldChwcm9wcyk7CgoJaWYgKCFwcm9wcykgcHJvcHMgPSB7fTsKCglpZiAoISgvXltcdy1dKyQvKS50ZXN0KHRhZykpewoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0YWcpLmV4cHJlc3Npb25zWzBdWzBdOwoJCXRhZyA9IChwYXJzZWQudGFnID09ICcqJykgPyAnZGl2JyA6IHBhcnNlZC50YWc7CgkJaWYgKHBhcnNlZC5pZCAmJiBwcm9wcy5pZCA9PSBudWxsKSBwcm9wcy5pZCA9IHBhcnNlZC5pZDsKCgkJdmFyIGF0dHJpYnV0ZXMgPSBwYXJzZWQuYXR0cmlidXRlczsKCQlpZiAoYXR0cmlidXRlcykgZm9yICh2YXIgaSA9IDAsIGwgPSBhdHRyaWJ1dGVzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBhdHRyID0gYXR0cmlidXRlc1tpXTsKCQkJaWYgKGF0dHIudmFsdWUgIT0gbnVsbCAmJiBhdHRyLm9wZXJhdG9yID09ICc9JyAmJiBwcm9wc1thdHRyLmtleV0gPT0gbnVsbCkKCQkJCXByb3BzW2F0dHIua2V5XSA9IGF0dHIudmFsdWU7CgkJfQoKCQlpZiAocGFyc2VkLmNsYXNzTGlzdCAmJiBwcm9wc1snY2xhc3MnXSA9PSBudWxsKSBwcm9wc1snY2xhc3MnXSA9IHBhcnNlZC5jbGFzc0xpc3Quam9pbignICcpOwoJfQoKCXJldHVybiBkb2N1bWVudC5uZXdFbGVtZW50KHRhZywgcHJvcHMpOwp9OwoKaWYgKEJyb3dzZXIuRWxlbWVudCkgRWxlbWVudC5wcm90b3R5cGUgPSBCcm93c2VyLkVsZW1lbnQucHJvdG90eXBlOwoKbmV3IFR5cGUoJ0VsZW1lbnQnLCBFbGVtZW50KS5taXJyb3IoZnVuY3Rpb24obmFtZSl7CglpZiAoQXJyYXkucHJvdG90eXBlW25hbWVdKSByZXR1cm47CgoJdmFyIG9iaiA9IHt9OwoJb2JqW25hbWVdID0gZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0cyA9IFtdLCBhcmdzID0gYXJndW1lbnRzLCBlbGVtZW50cyA9IHRydWU7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBlbGVtZW50ID0gdGhpc1tpXSwgcmVzdWx0ID0gcmVzdWx0c1tpXSA9IGVsZW1lbnRbbmFtZV0uYXBwbHkoZWxlbWVudCwgYXJncyk7CgkJCWVsZW1lbnRzID0gKGVsZW1lbnRzICYmIHR5cGVPZihyZXN1bHQpID09ICdlbGVtZW50Jyk7CgkJfQoJCXJldHVybiAoZWxlbWVudHMpID8gbmV3IEVsZW1lbnRzKHJlc3VsdHMpIDogcmVzdWx0czsKCX07CgoJRWxlbWVudHMuaW1wbGVtZW50KG9iaik7Cn0pOwoKaWYgKCFCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wYXJlbnQgPSBPYmplY3Q7CgoJRWxlbWVudC5Qcm90b3R5cGUgPSB7JyRmYW1pbHknOiBGdW5jdGlvbi5mcm9tKCdlbGVtZW50JykuaGlkZSgpfTsKCglFbGVtZW50Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJCUVsZW1lbnQuUHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoJfSk7Cn0KCkVsZW1lbnQuQ29uc3RydWN0b3JzID0ge307Cgp2YXIgSUZyYW1lID0gbmV3IFR5cGUoJ0lGcmFtZScsIGZ1bmN0aW9uKCl7Cgl2YXIgcGFyYW1zID0gQXJyYXkubGluayhhcmd1bWVudHMsIHsKCQlwcm9wZXJ0aWVzOiBUeXBlLmlzT2JqZWN0LAoJCWlmcmFtZTogZnVuY3Rpb24ob2JqKXsKCQkJcmV0dXJuIChvYmogIT0gbnVsbCk7CgkJfQoJfSk7CgoJdmFyIHByb3BzID0gcGFyYW1zLnByb3BlcnRpZXMgfHwge30sIGlmcmFtZTsKCWlmIChwYXJhbXMuaWZyYW1lKSBpZnJhbWUgPSBkb2N1bWVudC5pZChwYXJhbXMuaWZyYW1lKTsKCXZhciBvbmxvYWQgPSBwcm9wcy5vbmxvYWQgfHwgZnVuY3Rpb24oKXt9OwoJZGVsZXRlIHByb3BzLm9ubG9hZDsKCXByb3BzLmlkID0gcHJvcHMubmFtZSA9IFtwcm9wcy5pZCwgcHJvcHMubmFtZSwgaWZyYW1lID8gKGlmcmFtZS5pZCB8fCBpZnJhbWUubmFtZSkgOiAnSUZyYW1lXycgKyBTdHJpbmcudW5pcXVlSUQoKV0ucGljaygpOwoJaWZyYW1lID0gbmV3IEVsZW1lbnQoaWZyYW1lIHx8ICdpZnJhbWUnLCBwcm9wcyk7CgoJdmFyIG9uTG9hZCA9IGZ1bmN0aW9uKCl7CgkJb25sb2FkLmNhbGwoaWZyYW1lLmNvbnRlbnRXaW5kb3cpOwoJfTsKCglpZiAod2luZG93LmZyYW1lc1twcm9wcy5pZF0pIG9uTG9hZCgpOwoJZWxzZSBpZnJhbWUuYWRkTGlzdGVuZXIoJ2xvYWQnLCBvbkxvYWQpOwoJcmV0dXJuIGlmcmFtZTsKfSk7Cgp2YXIgRWxlbWVudHMgPSB0aGlzLkVsZW1lbnRzID0gZnVuY3Rpb24obm9kZXMpewoJaWYgKG5vZGVzICYmIG5vZGVzLmxlbmd0aCl7CgkJdmFyIHVuaXF1ZXMgPSB7fSwgbm9kZTsKCQlmb3IgKHZhciBpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJdmFyIHVpZCA9IFNsaWNrLnVpZE9mKG5vZGUpOwoJCQlpZiAoIXVuaXF1ZXNbdWlkXSl7CgkJCQl1bmlxdWVzW3VpZF0gPSB0cnVlOwoJCQkJdGhpcy5wdXNoKG5vZGUpOwoJCQl9CgkJfQoJfQp9OwoKRWxlbWVudHMucHJvdG90eXBlID0ge2xlbmd0aDogMH07CkVsZW1lbnRzLnBhcmVudCA9IEFycmF5OwoKbmV3IFR5cGUoJ0VsZW1lbnRzJywgRWxlbWVudHMpLmltcGxlbWVudCh7CgoJZmlsdGVyOiBmdW5jdGlvbihmaWx0ZXIsIGJpbmQpewoJCWlmICghZmlsdGVyKSByZXR1cm4gdGhpczsKCQlyZXR1cm4gbmV3IEVsZW1lbnRzKEFycmF5LmZpbHRlcih0aGlzLCAodHlwZU9mKGZpbHRlcikgPT0gJ3N0cmluZycpID8gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtLm1hdGNoKGZpbHRlcik7CgkJfSA6IGZpbHRlciwgYmluZCkpOwoJfS5wcm90ZWN0KCksCgoJcHVzaDogZnVuY3Rpb24oKXsKCQl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5pZChhcmd1bWVudHNbaV0pOwoJCQlpZiAoaXRlbSkgdGhpc1tsZW5ndGgrK10gPSBpdGVtOwoJCX0KCQlyZXR1cm4gKHRoaXMubGVuZ3RoID0gbGVuZ3RoKTsKCX0ucHJvdGVjdCgpLAoKCXVuc2hpZnQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGl0ZW1zID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5pZChhcmd1bWVudHNbaV0pOwoJCQlpZiAoaXRlbSkgaXRlbXMucHVzaChpdGVtKTsKCQl9CgkJcmV0dXJuIEFycmF5LnByb3RvdHlwZS51bnNoaWZ0LmFwcGx5KHRoaXMsIGl0ZW1zKTsKCX0ucHJvdGVjdCgpLAoKCWNvbmNhdDogZnVuY3Rpb24oKXsKCQl2YXIgbmV3RWxlbWVudHMgPSBuZXcgRWxlbWVudHModGhpcyk7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBhcmd1bWVudHNbaV07CgkJCWlmIChUeXBlLmlzRW51bWVyYWJsZShpdGVtKSkgbmV3RWxlbWVudHMuYXBwZW5kKGl0ZW0pOwoJCQllbHNlIG5ld0VsZW1lbnRzLnB1c2goaXRlbSk7CgkJfQoJCXJldHVybiBuZXdFbGVtZW50czsKCX0ucHJvdGVjdCgpLAoKCWFwcGVuZDogZnVuY3Rpb24oY29sbGVjdGlvbil7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBjb2xsZWN0aW9uLmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5wdXNoKGNvbGxlY3Rpb25baV0pOwoJCXJldHVybiB0aGlzOwoJfS5wcm90ZWN0KCksCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJd2hpbGUgKHRoaXMubGVuZ3RoKSBkZWxldGUgdGhpc1stLXRoaXMubGVuZ3RoXTsKCQlyZXR1cm4gdGhpczsKCX0ucHJvdGVjdCgpCgp9KTsKCihmdW5jdGlvbigpewoKLy8gRkYsIElFCnZhciBzcGxpY2UgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLCBvYmplY3QgPSB7JzAnOiAwLCAnMSc6IDEsIGxlbmd0aDogMn07CgpzcGxpY2UuY2FsbChvYmplY3QsIDEsIDEpOwppZiAob2JqZWN0WzFdID09IDEpIEVsZW1lbnRzLmltcGxlbWVudCgnc3BsaWNlJywgZnVuY3Rpb24oKXsKCXZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCXNwbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJd2hpbGUgKGxlbmd0aCA+PSB0aGlzLmxlbmd0aCkgZGVsZXRlIHRoaXNbbGVuZ3RoLS1dOwoJcmV0dXJuIHRoaXM7Cn0ucHJvdGVjdCgpKTsKCkVsZW1lbnRzLmltcGxlbWVudChBcnJheS5wcm90b3R5cGUpOwoKQXJyYXkubWlycm9yKEVsZW1lbnRzKTsKCi8qPGx0SUU4PiovCnZhciBjcmVhdGVFbGVtZW50QWNjZXB0c0hUTUw7CnRyeSB7Cgl2YXIgeCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJzxpbnB1dCBuYW1lPXg+Jyk7CgljcmVhdGVFbGVtZW50QWNjZXB0c0hUTUwgPSAoeC5uYW1lID09ICd4Jyk7Cn0gY2F0Y2goZSl7fQoKdmFyIGVzY2FwZVF1b3RlcyA9IGZ1bmN0aW9uKGh0bWwpewoJcmV0dXJuICgnJyArIGh0bWwpLnJlcGxhY2UoLyYvZywgJyZhbXA7JykucmVwbGFjZSgvIi9nLCAnJnF1b3Q7Jyk7Cn07Ci8qPC9sdElFOD4qLwoKRG9jdW1lbnQuaW1wbGVtZW50KHsKCgluZXdFbGVtZW50OiBmdW5jdGlvbih0YWcsIHByb3BzKXsKCQlpZiAocHJvcHMgJiYgcHJvcHMuY2hlY2tlZCAhPSBudWxsKSBwcm9wcy5kZWZhdWx0Q2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CgkJLyo8bHRJRTg+Ki8vLyBGaXggZm9yIHJlYWRvbmx5IG5hbWUgYW5kIHR5cGUgcHJvcGVydGllcyBpbiBJRSA8IDgKCQlpZiAoY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MICYmIHByb3BzKXsKCQkJdGFnID0gJzwnICsgdGFnOwoJCQlpZiAocHJvcHMubmFtZSkgdGFnICs9ICcgbmFtZT0iJyArIGVzY2FwZVF1b3Rlcyhwcm9wcy5uYW1lKSArICciJzsKCQkJaWYgKHByb3BzLnR5cGUpIHRhZyArPSAnIHR5cGU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMudHlwZSkgKyAnIic7CgkJCXRhZyArPSAnPic7CgkJCWRlbGV0ZSBwcm9wcy5uYW1lOwoJCQlkZWxldGUgcHJvcHMudHlwZTsKCQl9CgkJLyo8L2x0SUU4PiovCgkJcmV0dXJuIHRoaXMuaWQodGhpcy5jcmVhdGVFbGVtZW50KHRhZykpLnNldChwcm9wcyk7Cgl9Cgp9KTsKCn0pKCk7CgpEb2N1bWVudC5pbXBsZW1lbnQoewoKCW5ld1RleHROb2RlOiBmdW5jdGlvbih0ZXh0KXsKCQlyZXR1cm4gdGhpcy5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy53aW5kb3c7Cgl9LAoKCWlkOiAoZnVuY3Rpb24oKXsKCgkJdmFyIHR5cGVzID0gewoKCQkJc3RyaW5nOiBmdW5jdGlvbihpZCwgbm9jYXNoLCBkb2MpewoJCQkJaWQgPSBTbGljay5maW5kKGRvYywgJyMnICsgaWQucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKTsKCQkJCXJldHVybiAoaWQpID8gdHlwZXMuZWxlbWVudChpZCwgbm9jYXNoKSA6IG51bGw7CgkJCX0sCgoJCQllbGVtZW50OiBmdW5jdGlvbihlbCwgbm9jYXNoKXsKCQkJCSR1aWQoZWwpOwoJCQkJaWYgKCFub2Nhc2ggJiYgIWVsLiRmYW1pbHkgJiYgISgvXig/Om9iamVjdHxlbWJlZCkkL2kpLnRlc3QoZWwudGFnTmFtZSkpewoJCQkJCU9iamVjdC5hcHBlbmQoZWwsIEVsZW1lbnQuUHJvdG90eXBlKTsKCQkJCX0KCQkJCXJldHVybiBlbDsKCQkJfSwKCgkJCW9iamVjdDogZnVuY3Rpb24ob2JqLCBub2Nhc2gsIGRvYyl7CgkJCQlpZiAob2JqLnRvRWxlbWVudCkgcmV0dXJuIHR5cGVzLmVsZW1lbnQob2JqLnRvRWxlbWVudChkb2MpLCBub2Nhc2gpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJfTsKCgkJdHlwZXMudGV4dG5vZGUgPSB0eXBlcy53aGl0ZXNwYWNlID0gdHlwZXMud2luZG93ID0gdHlwZXMuZG9jdW1lbnQgPSBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGVsLCBub2Nhc2gsIGRvYyl7CgkJCWlmIChlbCAmJiBlbC4kZmFtaWx5ICYmIGVsLnVpZCkgcmV0dXJuIGVsOwoJCQl2YXIgdHlwZSA9IHR5cGVPZihlbCk7CgkJCXJldHVybiAodHlwZXNbdHlwZV0pID8gdHlwZXNbdHlwZV0oZWwsIG5vY2FzaCwgZG9jIHx8IGRvY3VtZW50KSA6IG51bGw7CgkJfTsKCgl9KSgpCgp9KTsKCmlmICh3aW5kb3cuJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJywgZnVuY3Rpb24oZWwsIG5jKXsKCXJldHVybiBkb2N1bWVudC5pZChlbCwgbmMsIHRoaXMuZG9jdW1lbnQpOwp9KTsKCldpbmRvdy5pbXBsZW1lbnQoewoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmRvY3VtZW50OwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCltEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgZXhwcmVzc2lvbiwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0RWxlbWVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgZXhwcmVzc2lvbikpOwoJfQoKfSk7CgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CgkJaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBzZWxlY3RvciwgbmV3IEVsZW1lbnRzKTsKCQllbHNlIGlmIChUeXBlLmlzRW51bWVyYWJsZShzZWxlY3RvcikpIHJldHVybiBuZXcgRWxlbWVudHMoc2VsZWN0b3IpOwoJfQoJcmV0dXJuIG5ldyBFbGVtZW50cyhhcmd1bWVudHMpOwp9KTsKCihmdW5jdGlvbigpewoKdmFyIGNvbGxlY3RlZCA9IHt9LCBzdG9yYWdlID0ge307CnZhciBmb3JtUHJvcHMgPSB7aW5wdXQ6ICdjaGVja2VkJywgb3B0aW9uOiAnc2VsZWN0ZWQnLCB0ZXh0YXJlYTogJ3ZhbHVlJ307Cgp2YXIgZ2V0ID0gZnVuY3Rpb24odWlkKXsKCXJldHVybiAoc3RvcmFnZVt1aWRdIHx8IChzdG9yYWdlW3VpZF0gPSB7fSkpOwp9OwoKdmFyIGNsZWFuID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgdWlkID0gaXRlbS51aWQ7CglpZiAoaXRlbS5yZW1vdmVFdmVudHMpIGl0ZW0ucmVtb3ZlRXZlbnRzKCk7CglpZiAoaXRlbS5jbGVhckF0dHJpYnV0ZXMpIGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKCk7CglpZiAodWlkICE9IG51bGwpewoJCWRlbGV0ZSBjb2xsZWN0ZWRbdWlkXTsKCQlkZWxldGUgc3RvcmFnZVt1aWRdOwoJfQoJcmV0dXJuIGl0ZW07Cn07Cgp2YXIgY2FtZWxzID0gWydkZWZhdWx0VmFsdWUnLCAnYWNjZXNzS2V5JywgJ2NlbGxQYWRkaW5nJywgJ2NlbGxTcGFjaW5nJywgJ2NvbFNwYW4nLCAnZnJhbWVCb3JkZXInLCAnbWF4TGVuZ3RoJywgJ3JlYWRPbmx5JywKCSdyb3dTcGFuJywgJ3RhYkluZGV4JywgJ3VzZU1hcCcKXTsKdmFyIGJvb2xzID0gWydjb21wYWN0JywgJ25vd3JhcCcsICdpc21hcCcsICdkZWNsYXJlJywgJ25vc2hhZGUnLCAnY2hlY2tlZCcsICdkaXNhYmxlZCcsICdyZWFkT25seScsICdtdWx0aXBsZScsICdzZWxlY3RlZCcsCgknbm9yZXNpemUnLCAnZGVmZXInLCAnZGVmYXVsdENoZWNrZWQnCl07CiB2YXIgYXR0cmlidXRlcyA9IHsKCSdodG1sJzogJ2lubmVySFRNTCcsCgknY2xhc3MnOiAnY2xhc3NOYW1lJywKCSdmb3InOiAnaHRtbEZvcicsCgkndGV4dCc6IChmdW5jdGlvbigpewoJCXZhciB0ZW1wID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJcmV0dXJuICh0ZW1wLnRleHRDb250ZW50ID09IG51bGwpID8gJ2lubmVyVGV4dCcgOiAndGV4dENvbnRlbnQnOwoJfSkoKQp9Owp2YXIgcmVhZE9ubHkgPSBbJ3R5cGUnXTsKdmFyIGV4cGFuZG9zID0gWyd2YWx1ZScsICdkZWZhdWx0VmFsdWUnXTsKdmFyIHVyaUF0dHJzID0gL14oPzpocmVmfHNyY3x1c2VtYXApJC9pOwoKYm9vbHMgPSBib29scy5hc3NvY2lhdGUoYm9vbHMpOwpjYW1lbHMgPSBjYW1lbHMuYXNzb2NpYXRlKGNhbWVscy5tYXAoU3RyaW5nLnRvTG93ZXJDYXNlKSk7CnJlYWRPbmx5ID0gcmVhZE9ubHkuYXNzb2NpYXRlKHJlYWRPbmx5KTsKCk9iamVjdC5hcHBlbmQoYXR0cmlidXRlcywgZXhwYW5kb3MuYXNzb2NpYXRlKGV4cGFuZG9zKSk7Cgp2YXIgaW5zZXJ0ZXJzID0gewoKCWJlZm9yZTogZnVuY3Rpb24oY29udGV4dCwgZWxlbWVudCl7CgkJdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQlpZiAocGFyZW50KSBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQpOwoJfSwKCglhZnRlcjogZnVuY3Rpb24oY29udGV4dCwgZWxlbWVudCl7CgkJdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQlpZiAocGFyZW50KSBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQubmV4dFNpYmxpbmcpOwoJfSwKCglib3R0b206IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuYXBwZW5kQ2hpbGQoY29udGV4dCk7Cgl9LAoKCXRvcDogZnVuY3Rpb24oY29udGV4dCwgZWxlbWVudCl7CgkJZWxlbWVudC5pbnNlcnRCZWZvcmUoY29udGV4dCwgZWxlbWVudC5maXJzdENoaWxkKTsKCX0KCn07CgppbnNlcnRlcnMuaW5zaWRlID0gaW5zZXJ0ZXJzLmJvdHRvbTsKCnZhciBpbmplY3RDb21iaW5hdG9yID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgY29tYmluYXRvcil7CglpZiAoIWV4cHJlc3Npb24pIHJldHVybiBjb21iaW5hdG9yOwoKCWV4cHJlc3Npb24gPSBPYmplY3QuY2xvbmUoU2xpY2sucGFyc2UoZXhwcmVzc2lvbikpOwoKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gZXhwcmVzc2lvbnMubGVuZ3RoOyBpLS07KQoJCWV4cHJlc3Npb25zW2ldWzBdLmNvbWJpbmF0b3IgPSBjb21iaW5hdG9yOwoKCXJldHVybiBleHByZXNzaW9uOwp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlLCB2YWx1ZSl7CgkJYXR0cmlidXRlID0gY2FtZWxzW2F0dHJpYnV0ZV0gfHwgYXR0cmlidXRlOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpcy5yZW1vdmVQcm9wZXJ0eShhdHRyaWJ1dGUpOwoJCXZhciBrZXkgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CgkJKGtleSkgPyB0aGlzW2tleV0gPSB2YWx1ZSA6CgkJCShib29sc1thdHRyaWJ1dGVdKSA/IHRoaXNbYXR0cmlidXRlXSA9ICEhdmFsdWUgOiB0aGlzLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUsICcnICsgdmFsdWUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihhdHRyaWJ1dGVzKXsKCQlmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgdGhpcy5zZXRQcm9wZXJ0eShhdHRyaWJ1dGUsIGF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFByb3BlcnR5OiBmdW5jdGlvbihhdHRyaWJ1dGUpewoJCWF0dHJpYnV0ZSA9IGNhbWVsc1thdHRyaWJ1dGVdIHx8IGF0dHJpYnV0ZTsKCQl2YXIga2V5ID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdIHx8IHJlYWRPbmx5W2F0dHJpYnV0ZV07CgkJcmV0dXJuIChrZXkpID8gdGhpc1trZXldIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gISF0aGlzW2F0dHJpYnV0ZV0gOgoJCQkodXJpQXR0cnMudGVzdChhdHRyaWJ1dGUpID8gdGhpcy5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCAyKSA6CgkJCShrZXkgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKSkgPyBrZXkubm9kZVZhbHVlIDogbnVsbCkgfHwgbnVsbDsKCX0sCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKCQlyZXR1cm4gYXJncy5tYXAodGhpcy5nZXRQcm9wZXJ0eSwgdGhpcykuYXNzb2NpYXRlKGFyZ3MpOwoJfSwKCglyZW1vdmVQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlKXsKCQlhdHRyaWJ1dGUgPSBjYW1lbHNbYXR0cmlidXRlXSB8fCBhdHRyaWJ1dGU7CgkJdmFyIGtleSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlXTsKCQkoa2V5KSA/IHRoaXNba2V5XSA9ICcnIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gdGhpc1thdHRyaWJ1dGVdID0gZmFsc2UgOiB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCUFycmF5LmVhY2goYXJndW1lbnRzLCB0aGlzLnJlbW92ZVByb3BlcnR5LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJcmV0dXJuIHRoaXMuY2xhc3NOYW1lLmNsZWFuKCkuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCglhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgdGhpcy5jbGFzc05hbWUgPSAodGhpcy5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWUpLmNsZWFuKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUucmVwbGFjZShuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGNsYXNzTmFtZSArICcoPzpcXHN8JCknKSwgJyQxJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUsIGZvcmNlKXsKCQlpZiAoZm9yY2UgPT0gbnVsbCkgZm9yY2UgPSAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpOwoJCXJldHVybiAoZm9yY2UpID8gdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwoJfSwKCglhZG9wdDogZnVuY3Rpb24oKXsKCQl2YXIgcGFyZW50ID0gdGhpcywgZnJhZ21lbnQsIGVsZW1lbnRzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLCBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgkJaWYgKGxlbmd0aCA+IDEpIHBhcmVudCA9IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50c1tpXSwgdHJ1ZSk7CgkJCWlmIChlbGVtZW50KSBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJfQoKCQlpZiAoZnJhZ21lbnQpIHRoaXMuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJYXBwZW5kVGV4dDogZnVuY3Rpb24odGV4dCwgd2hlcmUpewoJCXJldHVybiB0aGlzLmdyYWIodGhpcy5nZXREb2N1bWVudCgpLm5ld1RleHROb2RlKHRleHQpLCB3aGVyZSk7Cgl9LAoKCWdyYWI6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXShkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmplY3Q6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXSh0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWwpewoJCWVsID0gZG9jdW1lbnQuaWQoZWwsIHRydWUpOwoJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMsIGVsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcHM6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJcmV0dXJuIHRoaXMucmVwbGFjZXMoZWwpLmdyYWIoZWwsIHdoZXJlKTsKCX0sCgoJZ2V0UHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJyF+JykpKTsKCX0sCgoJZ2V0QWxsUHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIX4nKSwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0TmV4dDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpKSk7Cgl9LAoKCWdldEFsbE5leHQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRGaXJzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpWzBdKTsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpLmdldExhc3QoKSk7Cgl9LAoKCWdldFBhcmVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpKSk7Cgl9LAoKCWdldFBhcmVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRTaWJsaW5nczogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICd+ficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRDaGlsZHJlbjogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JyksIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LndpbmRvdzsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMub3duZXJEb2N1bWVudDsKCX0sCgoJZ2V0RWxlbWVudEJ5SWQ6IGZ1bmN0aW9uKGlkKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suZmluZCh0aGlzLCAnIycgKyAoJycgKyBpZCkucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKSk7Cgl9LAoKCWdldFNlbGVjdGVkOiBmdW5jdGlvbigpewoJCXRoaXMuc2VsZWN0ZWRJbmRleDsgLy8gU2FmYXJpIDMuMi4xCgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5mcm9tKHRoaXMub3B0aW9ucykuZmlsdGVyKGZ1bmN0aW9uKG9wdGlvbil7CgkJCXJldHVybiBvcHRpb24uc2VsZWN0ZWQ7CgkJfSkpOwoJfSwKCgl0b1F1ZXJ5U3RyaW5nOiBmdW5jdGlvbigpewoJCXZhciBxdWVyeVN0cmluZyA9IFtdOwoJCXRoaXMuZ2V0RWxlbWVudHMoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbihlbCl7CgkJCXZhciB0eXBlID0gZWwudHlwZTsKCQkJaWYgKCFlbC5uYW1lIHx8IGVsLmRpc2FibGVkIHx8IHR5cGUgPT0gJ3N1Ym1pdCcgfHwgdHlwZSA9PSAncmVzZXQnIHx8IHR5cGUgPT0gJ2ZpbGUnIHx8IHR5cGUgPT0gJ2ltYWdlJykgcmV0dXJuOwoKCQkJdmFyIHZhbHVlID0gKGVsLmdldCgndGFnJykgPT0gJ3NlbGVjdCcpID8gZWwuZ2V0U2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24ob3B0KXsKCQkJCS8vIElFCgkJCQlyZXR1cm4gZG9jdW1lbnQuaWQob3B0KS5nZXQoJ3ZhbHVlJyk7CgkJCX0pIDogKCh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSAmJiAhZWwuY2hlY2tlZCkgPyBudWxsIDogZWwuZ2V0KCd2YWx1ZScpOwoKCQkJQXJyYXkuZnJvbSh2YWx1ZSkuZWFjaChmdW5jdGlvbih2YWwpewoJCQkJaWYgKHR5cGVvZiB2YWwgIT0gJ3VuZGVmaW5lZCcpIHF1ZXJ5U3RyaW5nLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGVsLm5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkpOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwoJfSwKCglkZXN0cm95OiBmdW5jdGlvbigpewoJCXZhciBjaGlsZHJlbiA9IGNsZWFuKHRoaXMpLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJQXJyYXkuZWFjaChjaGlsZHJlbiwgY2xlYW4pOwoJCUVsZW1lbnQuZGlzcG9zZSh0aGlzKTsKCQlyZXR1cm4gbnVsbDsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJQXJyYXkuZnJvbSh0aGlzLmNoaWxkTm9kZXMpLmVhY2goRWxlbWVudC5kaXNwb3NlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMucGFyZW50Tm9kZSkgPyB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcykgOiB0aGlzOwoJfSwKCgltYXRjaDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuICFleHByZXNzaW9uIHx8IFNsaWNrLm1hdGNoKHRoaXMsIGV4cHJlc3Npb24pOwoJfQoKfSk7Cgp2YXIgY2xlYW5DbG9uZSA9IGZ1bmN0aW9uKG5vZGUsIGVsZW1lbnQsIGtlZXBpZCl7CglpZiAoIWtlZXBpZCkgbm9kZS5zZXRBdHRyaWJ1dGVOb2RlKGRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZSgnaWQnKSk7CglpZiAobm9kZS5jbGVhckF0dHJpYnV0ZXMpewoJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJbm9kZS5tZXJnZUF0dHJpYnV0ZXMoZWxlbWVudCk7CgkJbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ3VpZCcpOwoJCWlmIChub2RlLm9wdGlvbnMpewoJCQl2YXIgbm8gPSBub2RlLm9wdGlvbnMsIGVvID0gZWxlbWVudC5vcHRpb25zOwoJCQlmb3IgKHZhciBpID0gbm8ubGVuZ3RoOyBpLS07KSBub1tpXS5zZWxlY3RlZCA9IGVvW2ldLnNlbGVjdGVkOwoJCX0KCX0KCgl2YXIgcHJvcCA9IGZvcm1Qcm9wc1tlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKV07CglpZiAocHJvcCAmJiBlbGVtZW50W3Byb3BdKSBub2RlW3Byb3BdID0gZWxlbWVudFtwcm9wXTsKfTsKCkVsZW1lbnQuaW1wbGVtZW50KCdjbG9uZScsIGZ1bmN0aW9uKGNvbnRlbnRzLCBrZWVwaWQpewoJY29udGVudHMgPSBjb250ZW50cyAhPT0gZmFsc2U7Cgl2YXIgY2xvbmUgPSB0aGlzLmNsb25lTm9kZShjb250ZW50cyksIGk7CgoJaWYgKGNvbnRlbnRzKXsKCQl2YXIgY2UgPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpLCB0ZSA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlmb3IgKGkgPSBjZS5sZW5ndGg7IGktLTspIGNsZWFuQ2xvbmUoY2VbaV0sIHRlW2ldLCBrZWVwaWQpOwoJfQoKCWNsZWFuQ2xvbmUoY2xvbmUsIHRoaXMsIGtlZXBpZCk7CgoJaWYgKEJyb3dzZXIuaWUpewoJCXZhciBjbyA9IGNsb25lLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdvYmplY3QnKSwgdG8gPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdvYmplY3QnKTsKCQlmb3IgKGkgPSBjby5sZW5ndGg7IGktLTspIGNvW2ldLm91dGVySFRNTCA9IHRvW2ldLm91dGVySFRNTDsKCX0KCXJldHVybiBkb2N1bWVudC5pZChjbG9uZSk7Cn0pOwoKdmFyIGNvbnRhaW5zID0ge2NvbnRhaW5zOiBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiBTbGljay5jb250YWlucyh0aGlzLCBlbGVtZW50KTsKfX07CgppZiAoIWRvY3VtZW50LmNvbnRhaW5zKSBEb2N1bWVudC5pbXBsZW1lbnQoY29udGFpbnMpOwppZiAoIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmNvbnRhaW5zKSBFbGVtZW50LmltcGxlbWVudChjb250YWlucyk7CgpbRWxlbWVudCwgV2luZG93LCBEb2N1bWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJYWRkTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodHlwZSA9PSAndW5sb2FkJyl7CgkJCXZhciBvbGQgPSBmbiwgc2VsZiA9IHRoaXM7CgkJCWZuID0gZnVuY3Rpb24oKXsKCQkJCXNlbGYucmVtb3ZlTGlzdGVuZXIoJ3VubG9hZCcsIGZuKTsKCQkJCW9sZCgpOwoJCQl9OwoJCX0gZWxzZSB7CgkJCWNvbGxlY3RlZFskdWlkKHRoaXMpXSA9IHRoaXM7CgkJfQoJCWlmICh0aGlzLmFkZEV2ZW50TGlzdGVuZXIpIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgISFhcmd1bWVudHNbMl0pOwoJCWVsc2UgdGhpcy5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgISFhcmd1bWVudHNbMl0pOwoJCWVsc2UgdGhpcy5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXRyaWV2ZTogZnVuY3Rpb24ocHJvcGVydHksIGRmbHQpewoJCXZhciBzdG9yYWdlID0gZ2V0KCR1aWQodGhpcykpLCBwcm9wID0gc3RvcmFnZVtwcm9wZXJ0eV07CgkJaWYgKGRmbHQgIT0gbnVsbCAmJiBwcm9wID09IG51bGwpIHByb3AgPSBzdG9yYWdlW3Byb3BlcnR5XSA9IGRmbHQ7CgkJcmV0dXJuIHByb3AgIT0gbnVsbCA/IHByb3AgOiBudWxsOwoJfSwKCglzdG9yZTogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKCQl2YXIgc3RvcmFnZSA9IGdldCgkdWlkKHRoaXMpKTsKCQlzdG9yYWdlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgllbGltaW5hdGU6IGZ1bmN0aW9uKHByb3BlcnR5KXsKCQl2YXIgc3RvcmFnZSA9IGdldCgkdWlkKHRoaXMpKTsKCQlkZWxldGUgc3RvcmFnZVtwcm9wZXJ0eV07CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8vIElFIHB1cmdlCmlmICh3aW5kb3cuYXR0YWNoRXZlbnQgJiYgIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKSB3aW5kb3cuYWRkTGlzdGVuZXIoJ3VubG9hZCcsIGZ1bmN0aW9uKCl7CglPYmplY3QuZWFjaChjb2xsZWN0ZWQsIGNsZWFuKTsKCWlmICh3aW5kb3cuQ29sbGVjdEdhcmJhZ2UpIENvbGxlY3RHYXJiYWdlKCk7Cn0pOwoKfSkoKTsKCkVsZW1lbnQuUHJvcGVydGllcyA9IHt9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlID0gewoKCXNldDogZnVuY3Rpb24oc3R5bGUpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9IHN0eWxlOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3R5bGUuY3NzVGV4dDsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdHlsZS5jc3NUZXh0ID0gJyc7Cgl9Cgp9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnRhZyA9IHsKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoKfTsKCihmdW5jdGlvbihtYXhMZW5ndGgpewoJaWYgKG1heExlbmd0aCAhPSBudWxsKSBFbGVtZW50LlByb3BlcnRpZXMubWF4bGVuZ3RoID0gRWxlbWVudC5Qcm9wZXJ0aWVzLm1heExlbmd0aCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBtYXhsZW5ndGggPSB0aGlzLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJyk7CgkJCXJldHVybiBtYXhsZW5ndGggPT0gbWF4TGVuZ3RoID8gbnVsbCA6IG1heGxlbmd0aDsKCQl9Cgl9Owp9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJykpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdGFibGVUZXN0ID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCXZhciB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7CgkJdGFibGUuaW5uZXJIVE1MID0gJzx0cj48dGQ+PC90ZD48L3RyPic7Cgl9KTsKCgl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJdGFibGU6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAoJCXNlbGVjdDogWzEsICc8c2VsZWN0PicsICc8L3NlbGVjdD4nXSwKCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJdHI6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddCgl9OwoJdHJhbnNsYXRpb25zLnRoZWFkID0gdHJhbnNsYXRpb25zLnRmb290ID0gdHJhbnNsYXRpb25zLnRib2R5OwoKCXZhciBodG1sID0gewoJCXNldDogZnVuY3Rpb24oKXsKCQkJdmFyIGh0bWwgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykuam9pbignJyk7CgkJCXZhciB3cmFwID0gKCF0YWJsZVRlc3QgJiYgdHJhbnNsYXRpb25zW3RoaXMuZ2V0KCd0YWcnKV0pOwoJCQlpZiAod3JhcCl7CgkJCQl2YXIgZmlyc3QgPSB3cmFwcGVyOwoJCQkJZmlyc3QuaW5uZXJIVE1MID0gd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdOwoJCQkJZm9yICh2YXIgaSA9IHdyYXBbMF07IGktLTspIGZpcnN0ID0gZmlyc3QuZmlyc3RDaGlsZDsKCQkJCXRoaXMuZW1wdHkoKS5hZG9wdChmaXJzdC5jaGlsZE5vZGVzKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaW5uZXJIVE1MID0gaHRtbDsKCQkJfQoJCX0KCX07CgoJaHRtbC5lcmFzZSA9IGh0bWwuc2V0OwoKCXJldHVybiBodG1sOwp9KSgpOwoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LlN0eWxlCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgbWV0aG9kcyBmb3IgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgc3R5bGVzIG9mIEVsZW1lbnRzIGluIGEgZmFzaGlvbmFibGUgd2F5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRWxlbWVudAoKcHJvdmlkZXM6IEVsZW1lbnQuU3R5bGUKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaHRtbCA9IGRvY3VtZW50Lmh0bWw7CgpFbGVtZW50LlByb3BlcnRpZXMuc3R5bGVzID0ge3NldDogZnVuY3Rpb24oc3R5bGVzKXsKCXRoaXMuc2V0U3R5bGVzKHN0eWxlcyk7Cn19OwoKdmFyIGhhc09wYWNpdHkgPSAoaHRtbC5zdHlsZS5vcGFjaXR5ICE9IG51bGwpOwp2YXIgcmVBbHBoYSA9IC9hbHBoYVwob3BhY2l0eT0oW1xkLl0rKVwpL2k7Cgp2YXIgc2V0T3BhY2l0eSA9IGZ1bmN0aW9uKGVsZW1lbnQsIG9wYWNpdHkpewoJaWYgKCFlbGVtZW50LmN1cnJlbnRTdHlsZSB8fCAhZWxlbWVudC5jdXJyZW50U3R5bGUuaGFzTGF5b3V0KSBlbGVtZW50LnN0eWxlLnpvb20gPSAxOwoJaWYgKGhhc09wYWNpdHkpewoJCWVsZW1lbnQuc3R5bGUub3BhY2l0eSA9IG9wYWNpdHk7Cgl9IGVsc2UgewoJCW9wYWNpdHkgPSAob3BhY2l0eSA9PSAxKSA/ICcnIDogJ2FscGhhKG9wYWNpdHk9JyArIG9wYWNpdHkgKiAxMDAgKyAnKSc7CgkJdmFyIGZpbHRlciA9IGVsZW1lbnQuc3R5bGUuZmlsdGVyIHx8IGVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykgfHwgJyc7CgkJZWxlbWVudC5zdHlsZS5maWx0ZXIgPSByZUFscGhhLnRlc3QoZmlsdGVyKSA/IGZpbHRlci5yZXBsYWNlKHJlQWxwaGEsIG9wYWNpdHkpIDogZmlsdGVyICsgb3BhY2l0eTsKCX0KfTsKCkVsZW1lbnQuUHJvcGVydGllcy5vcGFjaXR5ID0gewoKCXNldDogZnVuY3Rpb24ob3BhY2l0eSl7CgkJdmFyIHZpc2liaWxpdHkgPSB0aGlzLnN0eWxlLnZpc2liaWxpdHk7CgkJaWYgKG9wYWNpdHkgPT0gMCAmJiB2aXNpYmlsaXR5ICE9ICdoaWRkZW4nKSB0aGlzLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQllbHNlIGlmIChvcGFjaXR5ICE9IDAgJiYgdmlzaWJpbGl0eSAhPSAndmlzaWJsZScpIHRoaXMuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJc2V0T3BhY2l0eSh0aGlzLCBvcGFjaXR5KTsKCX0sCgoJZ2V0OiAoaGFzT3BhY2l0eSkgPyBmdW5jdGlvbigpewoJCXZhciBvcGFjaXR5ID0gdGhpcy5zdHlsZS5vcGFjaXR5IHx8IHRoaXMuZ2V0Q29tcHV0ZWRTdHlsZSgnb3BhY2l0eScpOwoJCXJldHVybiAob3BhY2l0eSA9PSAnJykgPyAxIDogb3BhY2l0eTsKCX0gOiBmdW5jdGlvbigpewoJCXZhciBvcGFjaXR5LCBmaWx0ZXIgPSAodGhpcy5zdHlsZS5maWx0ZXIgfHwgdGhpcy5nZXRDb21wdXRlZFN0eWxlKCdmaWx0ZXInKSk7CgkJaWYgKGZpbHRlcikgb3BhY2l0eSA9IGZpbHRlci5tYXRjaChyZUFscGhhKTsKCQlyZXR1cm4gKG9wYWNpdHkgPT0gbnVsbCB8fCBmaWx0ZXIgPT0gbnVsbCkgPyAxIDogKG9wYWNpdHlbMV0gLyAxMDApOwoJfQoKfTsKCnZhciBmbG9hdE5hbWUgPSAoaHRtbC5zdHlsZS5jc3NGbG9hdCA9PSBudWxsKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgpFbGVtZW50LmltcGxlbWVudCh7CgoJZ2V0Q29tcHV0ZWRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmICh0aGlzLmN1cnJlbnRTdHlsZSkgcmV0dXJuIHRoaXMuY3VycmVudFN0eWxlW3Byb3BlcnR5LmNhbWVsQ2FzZSgpXTsKCQl2YXIgZGVmYXVsdFZpZXcgPSBFbGVtZW50LmdldERvY3VtZW50KHRoaXMpLmRlZmF1bHRWaWV3LAoJCQljb21wdXRlZCA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCBudWxsKSA6IG51bGw7CgkJcmV0dXJuIChjb21wdXRlZCkgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKChwcm9wZXJ0eSA9PSBmbG9hdE5hbWUpID8gJ2Zsb2F0JyA6IHByb3BlcnR5Lmh5cGhlbmF0ZSgpKSA6IG51bGw7Cgl9LAoKCXNldE9wYWNpdHk6IGZ1bmN0aW9uKHZhbHVlKXsKCQlzZXRPcGFjaXR5KHRoaXMsIHZhbHVlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0T3BhY2l0eTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXQoJ29wYWNpdHknKTsKCX0sCgoJc2V0U3R5bGU6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSl7CgkJc3dpdGNoIChwcm9wZXJ0eSl7CgkJCWNhc2UgJ29wYWNpdHknOiByZXR1cm4gdGhpcy5zZXQoJ29wYWNpdHknLCBwYXJzZUZsb2F0KHZhbHVlKSk7CgkJCWNhc2UgJ2Zsb2F0JzogcHJvcGVydHkgPSBmbG9hdE5hbWU7CgkJfQoJCXByb3BlcnR5ID0gcHJvcGVydHkuY2FtZWxDYXNlKCk7CgkJaWYgKHR5cGVPZih2YWx1ZSkgIT0gJ3N0cmluZycpewoJCQl2YXIgbWFwID0gKEVsZW1lbnQuU3R5bGVzW3Byb3BlcnR5XSB8fCAnQCcpLnNwbGl0KCcgJyk7CgkJCXZhbHVlID0gQXJyYXkuZnJvbSh2YWx1ZSkubWFwKGZ1bmN0aW9uKHZhbCwgaSl7CgkJCQlpZiAoIW1hcFtpXSkgcmV0dXJuICcnOwoJCQkJcmV0dXJuICh0eXBlT2YodmFsKSA9PSAnbnVtYmVyJykgPyBtYXBbaV0ucmVwbGFjZSgnQCcsIE1hdGgucm91bmQodmFsKSkgOiB2YWw7CgkJCX0pLmpvaW4oJyAnKTsKCQl9IGVsc2UgaWYgKHZhbHVlID09IFN0cmluZyhOdW1iZXIodmFsdWUpKSl7CgkJCXZhbHVlID0gTWF0aC5yb3VuZCh2YWx1ZSk7CgkJfQoJCXRoaXMuc3R5bGVbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSl7CgkJc3dpdGNoIChwcm9wZXJ0eSl7CgkJCWNhc2UgJ29wYWNpdHknOiByZXR1cm4gdGhpcy5nZXQoJ29wYWNpdHknKTsKCQkJY2FzZSAnZmxvYXQnOiBwcm9wZXJ0eSA9IGZsb2F0TmFtZTsKCQl9CgkJcHJvcGVydHkgPSBwcm9wZXJ0eS5jYW1lbENhc2UoKTsKCQl2YXIgcmVzdWx0ID0gdGhpcy5zdHlsZVtwcm9wZXJ0eV07CgkJaWYgKCFyZXN1bHQgfHwgcHJvcGVydHkgPT0gJ3pJbmRleCcpewoJCQlyZXN1bHQgPSBbXTsKCQkJZm9yICh2YXIgc3R5bGUgaW4gRWxlbWVudC5TaG9ydFN0eWxlcyl7CgkJCQlpZiAocHJvcGVydHkgIT0gc3R5bGUpIGNvbnRpbnVlOwoJCQkJZm9yICh2YXIgcyBpbiBFbGVtZW50LlNob3J0U3R5bGVzW3N0eWxlXSkgcmVzdWx0LnB1c2godGhpcy5nZXRTdHlsZShzKSk7CgkJCQlyZXR1cm4gcmVzdWx0LmpvaW4oJyAnKTsKCQkJfQoJCQlyZXN1bHQgPSB0aGlzLmdldENvbXB1dGVkU3R5bGUocHJvcGVydHkpOwoJCX0KCQlpZiAocmVzdWx0KXsKCQkJcmVzdWx0ID0gU3RyaW5nKHJlc3VsdCk7CgkJCXZhciBjb2xvciA9IHJlc3VsdC5tYXRjaCgvcmdiYT9cKFtcZFxzLF0rXCkvKTsKCQkJaWYgKGNvbG9yKSByZXN1bHQgPSByZXN1bHQucmVwbGFjZShjb2xvclswXSwgY29sb3JbMF0ucmdiVG9IZXgoKSk7CgkJfQoJCWlmIChCcm93c2VyLm9wZXJhIHx8IChCcm93c2VyLmllICYmIGlzTmFOKHBhcnNlRmxvYXQocmVzdWx0KSkpKXsKCQkJaWYgKCgvXihoZWlnaHR8d2lkdGgpJC8pLnRlc3QocHJvcGVydHkpKXsKCQkJCXZhciB2YWx1ZXMgPSAocHJvcGVydHkgPT0gJ3dpZHRoJykgPyBbJ2xlZnQnLCAncmlnaHQnXSA6IFsndG9wJywgJ2JvdHRvbSddLCBzaXplID0gMDsKCQkJCXZhbHVlcy5lYWNoKGZ1bmN0aW9uKHZhbHVlKXsKCQkJCQlzaXplICs9IHRoaXMuZ2V0U3R5bGUoJ2JvcmRlci0nICsgdmFsdWUgKyAnLXdpZHRoJykudG9JbnQoKSArIHRoaXMuZ2V0U3R5bGUoJ3BhZGRpbmctJyArIHZhbHVlKS50b0ludCgpOwoJCQkJfSwgdGhpcyk7CgkJCQlyZXR1cm4gdGhpc1snb2Zmc2V0JyArIHByb3BlcnR5LmNhcGl0YWxpemUoKV0gLSBzaXplICsgJ3B4JzsKCQkJfQoJCQlpZiAoQnJvd3Nlci5vcGVyYSAmJiBTdHJpbmcocmVzdWx0KS5pbmRleE9mKCdweCcpICE9IC0xKSByZXR1cm4gcmVzdWx0OwoJCQlpZiAoKC9eYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykudGVzdChwcm9wZXJ0eSkpIHJldHVybiAnMHB4JzsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewoJCWZvciAodmFyIHN0eWxlIGluIHN0eWxlcykgdGhpcy5zZXRTdHlsZShzdHlsZSwgc3R5bGVzW3N0eWxlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0ID0ge307CgkJQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLmVhY2goZnVuY3Rpb24oa2V5KXsKCQkJcmVzdWx0W2tleV0gPSB0aGlzLmdldFN0eWxlKGtleSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCn0pOwoKRWxlbWVudC5TdHlsZXMgPSB7CglsZWZ0OiAnQHB4JywgdG9wOiAnQHB4JywgYm90dG9tOiAnQHB4JywgcmlnaHQ6ICdAcHgnLAoJd2lkdGg6ICdAcHgnLCBoZWlnaHQ6ICdAcHgnLCBtYXhXaWR0aDogJ0BweCcsIG1heEhlaWdodDogJ0BweCcsIG1pbldpZHRoOiAnQHB4JywgbWluSGVpZ2h0OiAnQHB4JywKCWJhY2tncm91bmRDb2xvcjogJ3JnYihALCBALCBAKScsIGJhY2tncm91bmRQb3NpdGlvbjogJ0BweCBAcHgnLCBjb2xvcjogJ3JnYihALCBALCBAKScsCglmb250U2l6ZTogJ0BweCcsIGxldHRlclNwYWNpbmc6ICdAcHgnLCBsaW5lSGVpZ2h0OiAnQHB4JywgY2xpcDogJ3JlY3QoQHB4IEBweCBAcHggQHB4KScsCgltYXJnaW46ICdAcHggQHB4IEBweCBAcHgnLCBwYWRkaW5nOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyOiAnQHB4IEAgcmdiKEAsIEAsIEApIEBweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCknLAoJYm9yZGVyV2lkdGg6ICdAcHggQHB4IEBweCBAcHgnLCBib3JkZXJTdHlsZTogJ0AgQCBAIEAnLCBib3JkZXJDb2xvcjogJ3JnYihALCBALCBAKSByZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKScsCgl6SW5kZXg6ICdAJywgJ3pvb20nOiAnQCcsIGZvbnRXZWlnaHQ6ICdAJywgdGV4dEluZGVudDogJ0BweCcsIG9wYWNpdHk6ICdAJwp9OwoKRWxlbWVudC5TaG9ydFN0eWxlcyA9IHttYXJnaW46IHt9LCBwYWRkaW5nOiB7fSwgYm9yZGVyOiB7fSwgYm9yZGVyV2lkdGg6IHt9LCBib3JkZXJTdHlsZToge30sIGJvcmRlckNvbG9yOiB7fX07CgpbJ1RvcCcsICdSaWdodCcsICdCb3R0b20nLCAnTGVmdCddLmVhY2goZnVuY3Rpb24oZGlyZWN0aW9uKXsKCXZhciBTaG9ydCA9IEVsZW1lbnQuU2hvcnRTdHlsZXM7Cgl2YXIgQWxsID0gRWxlbWVudC5TdHlsZXM7CglbJ21hcmdpbicsICdwYWRkaW5nJ10uZWFjaChmdW5jdGlvbihzdHlsZSl7CgkJdmFyIHNkID0gc3R5bGUgKyBkaXJlY3Rpb247CgkJU2hvcnRbc3R5bGVdW3NkXSA9IEFsbFtzZF0gPSAnQHB4JzsKCX0pOwoJdmFyIGJkID0gJ2JvcmRlcicgKyBkaXJlY3Rpb247CglTaG9ydC5ib3JkZXJbYmRdID0gQWxsW2JkXSA9ICdAcHggQCByZ2IoQCwgQCwgQCknOwoJdmFyIGJkdyA9IGJkICsgJ1dpZHRoJywgYmRzID0gYmQgKyAnU3R5bGUnLCBiZGMgPSBiZCArICdDb2xvcic7CglTaG9ydFtiZF0gPSB7fTsKCVNob3J0LmJvcmRlcldpZHRoW2Jkd10gPSBTaG9ydFtiZF1bYmR3XSA9IEFsbFtiZHddID0gJ0BweCc7CglTaG9ydC5ib3JkZXJTdHlsZVtiZHNdID0gU2hvcnRbYmRdW2Jkc10gPSBBbGxbYmRzXSA9ICdAJzsKCVNob3J0LmJvcmRlckNvbG9yW2JkY10gPSBTaG9ydFtiZF1bYmRjXSA9IEFsbFtiZGNdID0gJ3JnYihALCBALCBAKSc7Cn0pOwoKfSkuY2FsbCh0aGlzKTsKCi8qCi0tLQoKbmFtZTogRWxlbWVudC5FdmVudAoKZGVzY3JpcHRpb246IENvbnRhaW5zIEVsZW1lbnQgbWV0aG9kcyBmb3IgZGVhbGluZyB3aXRoIGV2ZW50cy4gVGhpcyBmaWxlIGFsc28gaW5jbHVkZXMgbW91c2VlbnRlciBhbmQgbW91c2VsZWF2ZSBjdXN0b20gRWxlbWVudCBFdmVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgRXZlbnRdCgpwcm92aWRlczogRWxlbWVudC5FdmVudAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCkVsZW1lbnQuUHJvcGVydGllcy5ldmVudHMgPSB7c2V0OiBmdW5jdGlvbihldmVudHMpewoJdGhpcy5hZGRFdmVudHMoZXZlbnRzKTsKfX07CgpbRWxlbWVudCwgV2luZG93LCBEb2N1bWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl2YXIgZXZlbnRzID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJywge30pOwoJCWlmICghZXZlbnRzW3R5cGVdKSBldmVudHNbdHlwZV0gPSB7a2V5czogW10sIHZhbHVlczogW119OwoJCWlmIChldmVudHNbdHlwZV0ua2V5cy5jb250YWlucyhmbikpIHJldHVybiB0aGlzOwoJCWV2ZW50c1t0eXBlXS5rZXlzLnB1c2goZm4pOwoJCXZhciByZWFsVHlwZSA9IHR5cGUsCgkJCWN1c3RvbSA9IEVsZW1lbnQuRXZlbnRzW3R5cGVdLAoJCQljb25kaXRpb24gPSBmbiwKCQkJc2VsZiA9IHRoaXM7CgkJaWYgKGN1c3RvbSl7CgkJCWlmIChjdXN0b20ub25BZGQpIGN1c3RvbS5vbkFkZC5jYWxsKHRoaXMsIGZuKTsKCQkJaWYgKGN1c3RvbS5jb25kaXRpb24pewoJCQkJY29uZGl0aW9uID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWlmIChjdXN0b20uY29uZGl0aW9uLmNhbGwodGhpcywgZXZlbnQpKSByZXR1cm4gZm4uY2FsbCh0aGlzLCBldmVudCk7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9OwoJCQl9CgkJCXJlYWxUeXBlID0gY3VzdG9tLmJhc2UgfHwgcmVhbFR5cGU7CgkJfQoJCXZhciBkZWZuID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIGZuLmNhbGwoc2VsZik7CgkJfTsKCQl2YXIgbmF0aXZlRXZlbnQgPSBFbGVtZW50Lk5hdGl2ZUV2ZW50c1tyZWFsVHlwZV07CgkJaWYgKG5hdGl2ZUV2ZW50KXsKCQkJaWYgKG5hdGl2ZUV2ZW50ID09IDIpewoJCQkJZGVmbiA9IGZ1bmN0aW9uKGV2ZW50KXsKCQkJCQlldmVudCA9IG5ldyBFdmVudChldmVudCwgc2VsZi5nZXRXaW5kb3coKSk7CgkJCQkJaWYgKGNvbmRpdGlvbi5jYWxsKHNlbGYsIGV2ZW50KSA9PT0gZmFsc2UpIGV2ZW50LnN0b3AoKTsKCQkJCX07CgkJCX0KCQkJdGhpcy5hZGRMaXN0ZW5lcihyZWFsVHlwZSwgZGVmbiwgYXJndW1lbnRzWzJdKTsKCQl9CgkJZXZlbnRzW3R5cGVdLnZhbHVlcy5wdXNoKGRlZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQl2YXIgbGlzdCA9IGV2ZW50c1t0eXBlXTsKCQl2YXIgaW5kZXggPSBsaXN0LmtleXMuaW5kZXhPZihmbik7CgkJaWYgKGluZGV4ID09IC0xKSByZXR1cm4gdGhpczsKCQl2YXIgdmFsdWUgPSBsaXN0LnZhbHVlc1tpbmRleF07CgkJZGVsZXRlIGxpc3Qua2V5c1tpbmRleF07CgkJZGVsZXRlIGxpc3QudmFsdWVzW2luZGV4XTsKCQl2YXIgY3VzdG9tID0gRWxlbWVudC5FdmVudHNbdHlwZV07CgkJaWYgKGN1c3RvbSl7CgkJCWlmIChjdXN0b20ub25SZW1vdmUpIGN1c3RvbS5vblJlbW92ZS5jYWxsKHRoaXMsIGZuKTsKCQkJdHlwZSA9IGN1c3RvbS5iYXNlIHx8IHR5cGU7CgkJfQoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHNbdHlwZV0pID8gdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCB2YWx1ZSwgYXJndW1lbnRzWzJdKSA6IHRoaXM7Cgl9LAoKCWFkZEV2ZW50czogZnVuY3Rpb24oZXZlbnRzKXsKCQlmb3IgKHZhciBldmVudCBpbiBldmVudHMpIHRoaXMuYWRkRXZlbnQoZXZlbnQsIGV2ZW50c1tldmVudF0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJdmFyIGF0dGFjaGVkID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJyk7CgkJaWYgKCFhdHRhY2hlZCkgcmV0dXJuIHRoaXM7CgkJaWYgKCFldmVudHMpewoJCQlmb3IgKHR5cGUgaW4gYXR0YWNoZWQpIHRoaXMucmVtb3ZlRXZlbnRzKHR5cGUpOwoJCQl0aGlzLmVsaW1pbmF0ZSgnZXZlbnRzJyk7CgkJfSBlbHNlIGlmIChhdHRhY2hlZFtldmVudHNdKXsKCQkJYXR0YWNoZWRbZXZlbnRzXS5rZXlzLmVhY2goZnVuY3Rpb24oZm4pewoJCQkJdGhpcy5yZW1vdmVFdmVudChldmVudHMsIGZuKTsKCQkJfSwgdGhpcyk7CgkJCWRlbGV0ZSBhdHRhY2hlZFtldmVudHNdOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJZmlyZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBhcmdzLCBkZWxheSl7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzIHx8ICFldmVudHNbdHlwZV0pIHJldHVybiB0aGlzOwoJCWFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoKCQlldmVudHNbdHlwZV0ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJaWYgKGRlbGF5KSBmbi5kZWxheShkZWxheSwgdGhpcywgYXJncyk7CgkJCWVsc2UgZm4uYXBwbHkodGhpcywgYXJncyk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb25lRXZlbnRzOiBmdW5jdGlvbihmcm9tLCB0eXBlKXsKCQlmcm9tID0gZG9jdW1lbnQuaWQoZnJvbSk7CgkJdmFyIGV2ZW50cyA9IGZyb20ucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlpZiAoIXR5cGUpewoJCQlmb3IgKHZhciBldmVudFR5cGUgaW4gZXZlbnRzKSB0aGlzLmNsb25lRXZlbnRzKGZyb20sIGV2ZW50VHlwZSk7CgkJfSBlbHNlIGlmIChldmVudHNbdHlwZV0pewoJCQlldmVudHNbdHlwZV0ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMuYWRkRXZlbnQodHlwZSwgZm4pOwoJCQl9LCB0aGlzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkVsZW1lbnQuTmF0aXZlRXZlbnRzID0gewoJY2xpY2s6IDIsIGRibGNsaWNrOiAyLCBtb3VzZXVwOiAyLCBtb3VzZWRvd246IDIsIGNvbnRleHRtZW51OiAyLCAvL21vdXNlIGJ1dHRvbnMKCW1vdXNld2hlZWw6IDIsIERPTU1vdXNlU2Nyb2xsOiAyLCAvL21vdXNlIHdoZWVsCgltb3VzZW92ZXI6IDIsIG1vdXNlb3V0OiAyLCBtb3VzZW1vdmU6IDIsIHNlbGVjdHN0YXJ0OiAyLCBzZWxlY3RlbmQ6IDIsIC8vbW91c2UgbW92ZW1lbnQKCWtleWRvd246IDIsIGtleXByZXNzOiAyLCBrZXl1cDogMiwgLy9rZXlib2FyZAoJb3JpZW50YXRpb25jaGFuZ2U6IDIsIC8vIG1vYmlsZQoJdG91Y2hzdGFydDogMiwgdG91Y2htb3ZlOiAyLCB0b3VjaGVuZDogMiwgdG91Y2hjYW5jZWw6IDIsIC8vIHRvdWNoCglnZXN0dXJlc3RhcnQ6IDIsIGdlc3R1cmVjaGFuZ2U6IDIsIGdlc3R1cmVlbmQ6IDIsIC8vIGdlc3R1cmUKCWZvY3VzOiAyLCBibHVyOiAyLCBjaGFuZ2U6IDIsIHJlc2V0OiAyLCBzZWxlY3Q6IDIsIHN1Ym1pdDogMiwgLy9mb3JtIGVsZW1lbnRzCglsb2FkOiAyLCB1bmxvYWQ6IDEsIGJlZm9yZXVubG9hZDogMiwgcmVzaXplOiAxLCBtb3ZlOiAxLCBET01Db250ZW50TG9hZGVkOiAxLCByZWFkeXN0YXRlY2hhbmdlOiAxLCAvL3dpbmRvdwoJZXJyb3I6IDEsIGFib3J0OiAxLCBzY3JvbGw6IDEgLy9taXNjCn07Cgp2YXIgY2hlY2sgPSBmdW5jdGlvbihldmVudCl7Cgl2YXIgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CglpZiAocmVsYXRlZCA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKCWlmICghcmVsYXRlZCkgcmV0dXJuIGZhbHNlOwoJcmV0dXJuIChyZWxhdGVkICE9IHRoaXMgJiYgcmVsYXRlZC5wcmVmaXggIT0gJ3h1bCcgJiYgdHlwZU9mKHRoaXMpICE9ICdkb2N1bWVudCcgJiYgIXRoaXMuY29udGFpbnMocmVsYXRlZCkpOwp9OwoKRWxlbWVudC5FdmVudHMgPSB7CgoJbW91c2VlbnRlcjogewoJCWJhc2U6ICdtb3VzZW92ZXInLAoJCWNvbmRpdGlvbjogY2hlY2sKCX0sCgoJbW91c2VsZWF2ZTogewoJCWJhc2U6ICdtb3VzZW91dCcsCgkJY29uZGl0aW9uOiBjaGVjawoJfSwKCgltb3VzZXdoZWVsOiB7CgkJYmFzZTogKEJyb3dzZXIuZmlyZWZveCkgPyAnRE9NTW91c2VTY3JvbGwnIDogJ21vdXNld2hlZWwnCgl9Cgp9OwoKfSkuY2FsbCh0aGlzKTsKCi8qCi0tLQoKbmFtZTogRWxlbWVudC5EaW1lbnNpb25zCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgbWV0aG9kcyB0byB3b3JrIHdpdGggc2l6ZSwgc2Nyb2xsLCBvciBwb3NpdGlvbmluZyBvZiBFbGVtZW50cyBhbmQgdGhlIHdpbmRvdyBvYmplY3QuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBFbGVtZW50IHBvc2l0aW9uaW5nIGJhc2VkIG9uIHRoZSBbcW9veGRvb10oaHR0cDovL3Fvb3hkb28ub3JnLykgY29kZSBhbmQgc21hcnQgYnJvd3NlciBmaXhlcywgW0xHUEwgTGljZW5zZV0oaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2xncGwuaHRtbCkuCiAgLSBWaWV3cG9ydCBkaW1lbnNpb25zIGJhc2VkIG9uIFtZVUldKGh0dHA6Ly9kZXZlbG9wZXIueWFob28uY29tL3l1aS8pIGNvZGUsIFtCU0QgTGljZW5zZV0oaHR0cDovL2RldmVsb3Blci55YWhvby5jb20veXVpL2xpY2Vuc2UuaHRtbCkuCgpyZXF1aXJlczogW0VsZW1lbnQsIEVsZW1lbnQuU3R5bGVdCgpwcm92aWRlczogW0VsZW1lbnQuRGltZW5zaW9uc10KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAoJY2hpbGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKZWxlbWVudC5zdHlsZS5oZWlnaHQgPSAnMCc7CmVsZW1lbnQuYXBwZW5kQ2hpbGQoY2hpbGQpOwp2YXIgYnJva2VuT2Zmc2V0UGFyZW50ID0gKGNoaWxkLm9mZnNldFBhcmVudCA9PT0gZWxlbWVudCk7CmVsZW1lbnQgPSBjaGlsZCA9IG51bGw7Cgp2YXIgaXNPZmZzZXQgPSBmdW5jdGlvbihlbCl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWwsICdwb3NpdGlvbicpICE9ICdzdGF0aWMnIHx8IGlzQm9keShlbCk7Cn07Cgp2YXIgaXNPZmZzZXRTdGF0aWMgPSBmdW5jdGlvbihlbCl7CglyZXR1cm4gaXNPZmZzZXQoZWwpIHx8ICgvXig/OnRhYmxlfHRkfHRoKSQvaSkudGVzdChlbC50YWdOYW1lKTsKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzY3JvbGxUbzogZnVuY3Rpb24oeCwgeSl7CgkJaWYgKGlzQm9keSh0aGlzKSl7CgkJCXRoaXMuZ2V0V2luZG93KCkuc2Nyb2xsVG8oeCwgeSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5zY3JvbGxMZWZ0ID0geDsKCQkJdGhpcy5zY3JvbGxUb3AgPSB5OwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0U2l6ZTogZnVuY3Rpb24oKXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gdGhpcy5nZXRXaW5kb3coKS5nZXRTaXplKCk7CgkJcmV0dXJuIHt4OiB0aGlzLm9mZnNldFdpZHRoLCB5OiB0aGlzLm9mZnNldEhlaWdodH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2Nyb2xsU2l6ZSgpOwoJCXJldHVybiB7eDogdGhpcy5zY3JvbGxXaWR0aCwgeTogdGhpcy5zY3JvbGxIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGw6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2Nyb2xsKCk7CgkJcmV0dXJuIHt4OiB0aGlzLnNjcm9sbExlZnQsIHk6IHRoaXMuc2Nyb2xsVG9wfTsKCX0sCgoJZ2V0U2Nyb2xsczogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXMucGFyZW50Tm9kZSwgcG9zaXRpb24gPSB7eDogMCwgeTogMH07CgkJd2hpbGUgKGVsZW1lbnQgJiYgIWlzQm9keShlbGVtZW50KSl7CgkJCXBvc2l0aW9uLnggKz0gZWxlbWVudC5zY3JvbGxMZWZ0OwoJCQlwb3NpdGlvbi55ICs9IGVsZW1lbnQuc2Nyb2xsVG9wOwoJCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldE9mZnNldFBhcmVudDogYnJva2VuT2Zmc2V0UGFyZW50ID8gZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXM7CgkJaWYgKGlzQm9keShlbGVtZW50KSB8fCBzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSByZXR1cm4gbnVsbDsKCgkJdmFyIGlzT2Zmc2V0Q2hlY2sgPSAoc3R5bGVTdHJpbmcoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT0gJ3N0YXRpYycpID8gaXNPZmZzZXRTdGF0aWMgOiBpc09mZnNldDsKCQl3aGlsZSAoKGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGUpKXsKCQkJaWYgKGlzT2Zmc2V0Q2hlY2soZWxlbWVudCkpIHJldHVybiBlbGVtZW50OwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0gOiBmdW5jdGlvbigpewoJCXZhciBlbGVtZW50ID0gdGhpczsKCQlpZiAoaXNCb2R5KGVsZW1lbnQpIHx8IHN0eWxlU3RyaW5nKGVsZW1lbnQsICdwb3NpdGlvbicpID09ICdmaXhlZCcpIHJldHVybiBudWxsOwoKCQl0cnkgewoJCQlyZXR1cm4gZWxlbWVudC5vZmZzZXRQYXJlbnQ7CgkJfSBjYXRjaChlKSB7fQoJCXJldHVybiBudWxsOwoJfSwKCglnZXRPZmZzZXRzOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCAmJiAhQnJvd3Nlci5QbGF0Zm9ybS5pb3MpewoJCQl2YXIgYm91bmQgPSB0aGlzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLAoJCQkJaHRtbCA9IGRvY3VtZW50LmlkKHRoaXMuZ2V0RG9jdW1lbnQoKS5kb2N1bWVudEVsZW1lbnQpLAoJCQkJaHRtbFNjcm9sbCA9IGh0bWwuZ2V0U2Nyb2xsKCksCgkJCQllbGVtU2Nyb2xscyA9IHRoaXMuZ2V0U2Nyb2xscygpLAoJCQkJaXNGaXhlZCA9IChzdHlsZVN0cmluZyh0aGlzLCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKTsKCgkJCXJldHVybiB7CgkJCQl4OiBib3VuZC5sZWZ0LnRvSW50KCkgKyBlbGVtU2Nyb2xscy54ICsgKChpc0ZpeGVkKSA/IDAgOiBodG1sU2Nyb2xsLngpIC0gaHRtbC5jbGllbnRMZWZ0LAoJCQkJeTogYm91bmQudG9wLnRvSW50KCkgICsgZWxlbVNjcm9sbHMueSArICgoaXNGaXhlZCkgPyAwIDogaHRtbFNjcm9sbC55KSAtIGh0bWwuY2xpZW50VG9wCgkJCX07CgkJfQoKCQl2YXIgZWxlbWVudCA9IHRoaXMsIHBvc2l0aW9uID0ge3g6IDAsIHk6IDB9OwoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiBwb3NpdGlvbjsKCgkJd2hpbGUgKGVsZW1lbnQgJiYgIWlzQm9keShlbGVtZW50KSl7CgkJCXBvc2l0aW9uLnggKz0gZWxlbWVudC5vZmZzZXRMZWZ0OwoJCQlwb3NpdGlvbi55ICs9IGVsZW1lbnQub2Zmc2V0VG9wOwoKCQkJaWYgKEJyb3dzZXIuZmlyZWZveCl7CgkJCQlpZiAoIWJvcmRlckJveChlbGVtZW50KSl7CgkJCQkJcG9zaXRpb24ueCArPSBsZWZ0Qm9yZGVyKGVsZW1lbnQpOwoJCQkJCXBvc2l0aW9uLnkgKz0gdG9wQm9yZGVyKGVsZW1lbnQpOwoJCQkJfQoJCQkJdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQkJCWlmIChwYXJlbnQgJiYgc3R5bGVTdHJpbmcocGFyZW50LCAnb3ZlcmZsb3cnKSAhPSAndmlzaWJsZScpewoJCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihwYXJlbnQpOwoJCQkJCXBvc2l0aW9uLnkgKz0gdG9wQm9yZGVyKHBhcmVudCk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoZWxlbWVudCAhPSB0aGlzICYmIEJyb3dzZXIuc2FmYXJpKXsKCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihlbGVtZW50KTsKCQkJCXBvc2l0aW9uLnkgKz0gdG9wQm9yZGVyKGVsZW1lbnQpOwoJCQl9CgoJCQllbGVtZW50ID0gZWxlbWVudC5vZmZzZXRQYXJlbnQ7CgkJfQoJCWlmIChCcm93c2VyLmZpcmVmb3ggJiYgIWJvcmRlckJveCh0aGlzKSl7CgkJCXBvc2l0aW9uLnggLT0gbGVmdEJvcmRlcih0aGlzKTsKCQkJcG9zaXRpb24ueSAtPSB0b3BCb3JkZXIodGhpcyk7CgkJfQoJCXJldHVybiBwb3NpdGlvbjsKCX0sCgoJZ2V0UG9zaXRpb246IGZ1bmN0aW9uKHJlbGF0aXZlKXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4ge3g6IDAsIHk6IDB9OwoJCXZhciBvZmZzZXQgPSB0aGlzLmdldE9mZnNldHMoKSwKCQkJc2Nyb2xsID0gdGhpcy5nZXRTY3JvbGxzKCk7CgkJdmFyIHBvc2l0aW9uID0gewoJCQl4OiBvZmZzZXQueCAtIHNjcm9sbC54LAoJCQl5OiBvZmZzZXQueSAtIHNjcm9sbC55CgkJfTsKCgkJaWYgKHJlbGF0aXZlICYmIChyZWxhdGl2ZSA9IGRvY3VtZW50LmlkKHJlbGF0aXZlKSkpewoJCQl2YXIgcmVsYXRpdmVQb3NpdGlvbiA9IHJlbGF0aXZlLmdldFBvc2l0aW9uKCk7CgkJCXJldHVybiB7eDogcG9zaXRpb24ueCAtIHJlbGF0aXZlUG9zaXRpb24ueCAtIGxlZnRCb3JkZXIocmVsYXRpdmUpLCB5OiBwb3NpdGlvbi55IC0gcmVsYXRpdmVQb3NpdGlvbi55IC0gdG9wQm9yZGVyKHJlbGF0aXZlKX07CgkJfQoJCXJldHVybiBwb3NpdGlvbjsKCX0sCgoJZ2V0Q29vcmRpbmF0ZXM6IGZ1bmN0aW9uKGVsZW1lbnQpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldENvb3JkaW5hdGVzKCk7CgkJdmFyIHBvc2l0aW9uID0gdGhpcy5nZXRQb3NpdGlvbihlbGVtZW50KSwKCQkJc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXZhciBvYmogPSB7CgkJCWxlZnQ6IHBvc2l0aW9uLngsCgkJCXRvcDogcG9zaXRpb24ueSwKCQkJd2lkdGg6IHNpemUueCwKCQkJaGVpZ2h0OiBzaXplLnkKCQl9OwoJCW9iai5yaWdodCA9IG9iai5sZWZ0ICsgb2JqLndpZHRoOwoJCW9iai5ib3R0b20gPSBvYmoudG9wICsgb2JqLmhlaWdodDsKCQlyZXR1cm4gb2JqOwoJfSwKCgljb21wdXRlUG9zaXRpb246IGZ1bmN0aW9uKG9iail7CgkJcmV0dXJuIHsKCQkJbGVmdDogb2JqLnggLSBzdHlsZU51bWJlcih0aGlzLCAnbWFyZ2luLWxlZnQnKSwKCQkJdG9wOiBvYmoueSAtIHN0eWxlTnVtYmVyKHRoaXMsICdtYXJnaW4tdG9wJykKCQl9OwoJfSwKCglzZXRQb3NpdGlvbjogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gdGhpcy5zZXRTdHlsZXModGhpcy5jb21wdXRlUG9zaXRpb24ob2JqKSk7Cgl9Cgp9KTsKCltEb2N1bWVudCwgV2luZG93XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglnZXRTaXplOiBmdW5jdGlvbigpewoJCXZhciBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogZG9jLmNsaWVudFdpZHRoLCB5OiBkb2MuY2xpZW50SGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCXZhciB3aW4gPSB0aGlzLmdldFdpbmRvdygpLCBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogd2luLnBhZ2VYT2Zmc2V0IHx8IGRvYy5zY3JvbGxMZWZ0LCB5OiB3aW4ucGFnZVlPZmZzZXQgfHwgZG9jLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJdmFyIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyksCgkJCW1pbiA9IHRoaXMuZ2V0U2l6ZSgpLAoJCQlib2R5ID0gdGhpcy5nZXREb2N1bWVudCgpLmJvZHk7CgoJCXJldHVybiB7eDogTWF0aC5tYXgoZG9jLnNjcm9sbFdpZHRoLCBib2R5LnNjcm9sbFdpZHRoLCBtaW4ueCksIHk6IE1hdGgubWF4KGRvYy5zY3JvbGxIZWlnaHQsIGJvZHkuc2Nyb2xsSGVpZ2h0LCBtaW4ueSl9OwoJfSwKCglnZXRQb3NpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4ge3g6IDAsIHk6IDB9OwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oKXsKCQl2YXIgc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXJldHVybiB7dG9wOiAwLCBsZWZ0OiAwLCBib3R0b206IHNpemUueSwgcmlnaHQ6IHNpemUueCwgaGVpZ2h0OiBzaXplLnksIHdpZHRoOiBzaXplLnh9OwoJfQoKfSk7CgovLyBwcml2YXRlIG1ldGhvZHMKCnZhciBzdHlsZVN0cmluZyA9IEVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZTsKCmZ1bmN0aW9uIHN0eWxlTnVtYmVyKGVsZW1lbnQsIHN0eWxlKXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCBzdHlsZSkudG9JbnQoKSB8fCAwOwp9CgpmdW5jdGlvbiBib3JkZXJCb3goZWxlbWVudCl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWxlbWVudCwgJy1tb3otYm94LXNpemluZycpID09ICdib3JkZXItYm94JzsKfQoKZnVuY3Rpb24gdG9wQm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItdG9wLXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGxlZnRCb3JkZXIoZWxlbWVudCl7CglyZXR1cm4gc3R5bGVOdW1iZXIoZWxlbWVudCwgJ2JvcmRlci1sZWZ0LXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGlzQm9keShlbGVtZW50KXsKCXJldHVybiAoL14oPzpib2R5fGh0bWwpJC9pKS50ZXN0KGVsZW1lbnQudGFnTmFtZSk7Cn0KCmZ1bmN0aW9uIGdldENvbXBhdEVsZW1lbnQoZWxlbWVudCl7Cgl2YXIgZG9jID0gZWxlbWVudC5nZXREb2N1bWVudCgpOwoJcmV0dXJuICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7Cn0KCn0pLmNhbGwodGhpcyk7CgovL2FsaWFzZXMKRWxlbWVudC5hbGlhcyh7cG9zaXRpb246ICdzZXRQb3NpdGlvbid9KTsgLy9jb21wYXRhYmlsaXR5CgpbV2luZG93LCBEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0SGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNpemUoKS55OwoJfSwKCglnZXRXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTaXplKCkueDsKCX0sCgoJZ2V0U2Nyb2xsVG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbCgpLnk7Cgl9LAoKCWdldFNjcm9sbExlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsKCkueDsKCX0sCgoJZ2V0U2Nyb2xsSGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbFNpemUoKS55OwoJfSwKCglnZXRTY3JvbGxXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGxTaXplKCkueDsKCX0sCgoJZ2V0VG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKCkueTsKCX0sCgoJZ2V0TGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbigpLng7Cgl9Cgp9KTsKCi8qCi0tLQoKbmFtZTogRngKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgYmFzaWMgYW5pbWF0aW9uIGxvZ2ljIHRvIGJlIGV4dGVuZGVkIGJ5IGFsbCBvdGhlciBGeCBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdCgpwcm92aWRlczogRngKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgRnggPSB0aGlzLkZ4ID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBbQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10sCgoJb3B0aW9uczogewoJCS8qCgkJb25TdGFydDogbmlsLAoJCW9uQ2FuY2VsOiBuaWwsCgkJb25Db21wbGV0ZTogbmlsLAoJCSovCgkJZnBzOiA2MCwKCQl1bml0OiBmYWxzZSwKCQlkdXJhdGlvbjogNTAwLAoJCWZyYW1lczogbnVsbCwKCQlmcmFtZVNraXA6IHRydWUsCgkJbGluazogJ2lnbm9yZScKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5zdWJqZWN0ID0gdGhpcy5zdWJqZWN0IHx8IHRoaXM7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXJldHVybiBmdW5jdGlvbihwKXsKCQkJcmV0dXJuIC0oTWF0aC5jb3MoTWF0aC5QSSAqIHApIC0gMSkgLyAyOwoJCX07Cgl9LAoKCXN0ZXA6IGZ1bmN0aW9uKG5vdyl7CgkJaWYgKHRoaXMub3B0aW9ucy5mcmFtZVNraXApewoJCQl2YXIgZGlmZiA9ICh0aGlzLnRpbWUgIT0gbnVsbCkgPyAobm93IC0gdGhpcy50aW1lKSA6IDAsIGZyYW1lcyA9IGRpZmYgLyB0aGlzLmZyYW1lSW50ZXJ2YWw7CgkJCXRoaXMudGltZSA9IG5vdzsKCQkJdGhpcy5mcmFtZSArPSBmcmFtZXM7CgkJfSBlbHNlIHsKCQkJdGhpcy5mcmFtZSsrOwoJCX0KCgkJaWYgKHRoaXMuZnJhbWUgPCB0aGlzLmZyYW1lcyl7CgkJCXZhciBkZWx0YSA9IHRoaXMudHJhbnNpdGlvbih0aGlzLmZyYW1lIC8gdGhpcy5mcmFtZXMpOwoJCQl0aGlzLnNldCh0aGlzLmNvbXB1dGUodGhpcy5mcm9tLCB0aGlzLnRvLCBkZWx0YSkpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZnJhbWUgPSB0aGlzLmZyYW1lczsKCQkJdGhpcy5zZXQodGhpcy5jb21wdXRlKHRoaXMuZnJvbSwgdGhpcy50bywgMSkpOwoJCQl0aGlzLnN0b3AoKTsKCQl9Cgl9LAoKCXNldDogZnVuY3Rpb24obm93KXsKCQlyZXR1cm4gbm93OwoJfSwKCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXJldHVybiBGeC5jb21wdXRlKGZyb20sIHRvLCBkZWx0YSk7Cgl9LAoKCWNoZWNrOiBmdW5jdGlvbigpewoJCWlmICghdGhpcy5pc1J1bm5pbmcoKSkgcmV0dXJuIHRydWU7CgkJc3dpdGNoICh0aGlzLm9wdGlvbnMubGluayl7CgkJCWNhc2UgJ2NhbmNlbCc6IHRoaXMuY2FuY2VsKCk7IHJldHVybiB0cnVlOwoJCQljYXNlICdjaGFpbic6IHRoaXMuY2hhaW4odGhpcy5jYWxsZXIucGFzcyhhcmd1bWVudHMsIHRoaXMpKTsgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihmcm9tLCB0byl7CgkJaWYgKCF0aGlzLmNoZWNrKGZyb20sIHRvKSkgcmV0dXJuIHRoaXM7CgkJdGhpcy5mcm9tID0gZnJvbTsKCQl0aGlzLnRvID0gdG87CgkJdGhpcy5mcmFtZSA9ICh0aGlzLm9wdGlvbnMuZnJhbWVTa2lwKSA/IDAgOiAtMTsKCQl0aGlzLnRpbWUgPSBudWxsOwoJCXRoaXMudHJhbnNpdGlvbiA9IHRoaXMuZ2V0VHJhbnNpdGlvbigpOwoJCXZhciBmcmFtZXMgPSB0aGlzLm9wdGlvbnMuZnJhbWVzLCBmcHMgPSB0aGlzLm9wdGlvbnMuZnBzLCBkdXJhdGlvbiA9IHRoaXMub3B0aW9ucy5kdXJhdGlvbjsKCQl0aGlzLmR1cmF0aW9uID0gRnguRHVyYXRpb25zW2R1cmF0aW9uXSB8fCBkdXJhdGlvbi50b0ludCgpOwoJCXRoaXMuZnJhbWVJbnRlcnZhbCA9IDEwMDAgLyBmcHM7CgkJdGhpcy5mcmFtZXMgPSBmcmFtZXMgfHwgTWF0aC5yb3VuZCh0aGlzLmR1cmF0aW9uIC8gdGhpcy5mcmFtZUludGVydmFsKTsKCQl0aGlzLmZpcmVFdmVudCgnc3RhcnQnLCB0aGlzLnN1YmplY3QpOwoJCXB1c2hJbnN0YW5jZS5jYWxsKHRoaXMsIGZwcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQkJaWYgKHRoaXMuZnJhbWVzID09IHRoaXMuZnJhbWUpewoJCQkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJywgdGhpcy5zdWJqZWN0KTsKCQkJCWlmICghdGhpcy5jYWxsQ2hhaW4oKSkgdGhpcy5maXJlRXZlbnQoJ2NoYWluQ29tcGxldGUnLCB0aGlzLnN1YmplY3QpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5maXJlRXZlbnQoJ3N0b3AnLCB0aGlzLnN1YmplY3QpOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgljYW5jZWw6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQkJdGhpcy5mcmFtZSA9IHRoaXMuZnJhbWVzOwoJCQl0aGlzLmZpcmVFdmVudCgnY2FuY2VsJywgdGhpcy5zdWJqZWN0KS5jbGVhckNoYWluKCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglwYXVzZTogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5pc1J1bm5pbmcoKSl7CgkJCXRoaXMudGltZSA9IG51bGw7CgkJCXB1bGxJbnN0YW5jZS5jYWxsKHRoaXMsIHRoaXMub3B0aW9ucy5mcHMpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVzdW1lOiBmdW5jdGlvbigpewoJCWlmICgodGhpcy5mcmFtZSA8IHRoaXMuZnJhbWVzKSAmJiAhdGhpcy5pc1J1bm5pbmcoKSkgcHVzaEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWlzUnVubmluZzogZnVuY3Rpb24oKXsKCQl2YXIgbGlzdCA9IGluc3RhbmNlc1t0aGlzLm9wdGlvbnMuZnBzXTsKCQlyZXR1cm4gbGlzdCAmJiBsaXN0LmNvbnRhaW5zKHRoaXMpOwoJfQoKfSk7CgpGeC5jb21wdXRlID0gZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCXJldHVybiAodG8gLSBmcm9tKSAqIGRlbHRhICsgZnJvbTsKfTsKCkZ4LkR1cmF0aW9ucyA9IHsnc2hvcnQnOiAyNTAsICdub3JtYWwnOiA1MDAsICdsb25nJzogMTAwMH07CgovLyBnbG9iYWwgdGltZXJzCgp2YXIgaW5zdGFuY2VzID0ge30sIHRpbWVycyA9IHt9OwoKdmFyIGxvb3AgPSBmdW5jdGlvbigpewoJdmFyIG5vdyA9IERhdGUubm93KCk7Cglmb3IgKHZhciBpID0gdGhpcy5sZW5ndGg7IGktLTspewoJCXZhciBpbnN0YW5jZSA9IHRoaXNbaV07CgkJaWYgKGluc3RhbmNlKSBpbnN0YW5jZS5zdGVwKG5vdyk7Cgl9Cn07Cgp2YXIgcHVzaEluc3RhbmNlID0gZnVuY3Rpb24oZnBzKXsKCXZhciBsaXN0ID0gaW5zdGFuY2VzW2Zwc10gfHwgKGluc3RhbmNlc1tmcHNdID0gW10pOwoJbGlzdC5wdXNoKHRoaXMpOwoJaWYgKCF0aW1lcnNbZnBzXSkgdGltZXJzW2Zwc10gPSBsb29wLnBlcmlvZGljYWwoTWF0aC5yb3VuZCgxMDAwIC8gZnBzKSwgbGlzdCk7Cn07Cgp2YXIgcHVsbEluc3RhbmNlID0gZnVuY3Rpb24oZnBzKXsKCXZhciBsaXN0ID0gaW5zdGFuY2VzW2Zwc107CglpZiAobGlzdCl7CgkJbGlzdC5lcmFzZSh0aGlzKTsKCQlpZiAoIWxpc3QubGVuZ3RoICYmIHRpbWVyc1tmcHNdKXsKCQkJZGVsZXRlIGluc3RhbmNlc1tmcHNdOwoJCQl0aW1lcnNbZnBzXSA9IGNsZWFySW50ZXJ2YWwodGltZXJzW2Zwc10pOwoJCX0KCX0KfTsKCn0pLmNhbGwodGhpcyk7CgovKgotLS0KCm5hbWU6IEZ4LkNTUwoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBDU1MgYW5pbWF0aW9uIGxvZ2ljLiBVc2VkIGJ5IEZ4LlR3ZWVuLCBGeC5Nb3JwaCwgRnguRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRngsIEVsZW1lbnQuU3R5bGVdCgpwcm92aWRlczogRnguQ1NTCgouLi4KKi8KCkZ4LkNTUyA9IG5ldyBDbGFzcyh7CgoJRXh0ZW5kczogRngsCgoJLy9wcmVwYXJlcyB0aGUgYmFzZSBmcm9tL3RvIG9iamVjdAoKCXByZXBhcmU6IGZ1bmN0aW9uKGVsZW1lbnQsIHByb3BlcnR5LCB2YWx1ZXMpewoJCXZhbHVlcyA9IEFycmF5LmZyb20odmFsdWVzKTsKCQlpZiAodmFsdWVzWzFdID09IG51bGwpewoJCQl2YWx1ZXNbMV0gPSB2YWx1ZXNbMF07CgkJCXZhbHVlc1swXSA9IGVsZW1lbnQuZ2V0U3R5bGUocHJvcGVydHkpOwoJCX0KCQl2YXIgcGFyc2VkID0gdmFsdWVzLm1hcCh0aGlzLnBhcnNlKTsKCQlyZXR1cm4ge2Zyb206IHBhcnNlZFswXSwgdG86IHBhcnNlZFsxXX07Cgl9LAoKCS8vcGFyc2VzIGEgdmFsdWUgaW50byBhbiBhcnJheQoKCXBhcnNlOiBmdW5jdGlvbih2YWx1ZSl7CgkJdmFsdWUgPSBGdW5jdGlvbi5mcm9tKHZhbHVlKSgpOwoJCXZhbHVlID0gKHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJykgPyB2YWx1ZS5zcGxpdCgnICcpIDogQXJyYXkuZnJvbSh2YWx1ZSk7CgkJcmV0dXJuIHZhbHVlLm1hcChmdW5jdGlvbih2YWwpewoJCQl2YWwgPSBTdHJpbmcodmFsKTsKCQkJdmFyIGZvdW5kID0gZmFsc2U7CgkJCU9iamVjdC5lYWNoKEZ4LkNTUy5QYXJzZXJzLCBmdW5jdGlvbihwYXJzZXIsIGtleSl7CgkJCQlpZiAoZm91bmQpIHJldHVybjsKCQkJCXZhciBwYXJzZWQgPSBwYXJzZXIucGFyc2UodmFsKTsKCQkJCWlmIChwYXJzZWQgfHwgcGFyc2VkID09PSAwKSBmb3VuZCA9IHt2YWx1ZTogcGFyc2VkLCBwYXJzZXI6IHBhcnNlcn07CgkJCX0pOwoJCQlmb3VuZCA9IGZvdW5kIHx8IHt2YWx1ZTogdmFsLCBwYXJzZXI6IEZ4LkNTUy5QYXJzZXJzLlN0cmluZ307CgkJCXJldHVybiBmb3VuZDsKCQl9KTsKCX0sCgoJLy9jb21wdXRlcyBieSBhIGZyb20gYW5kIHRvIHByZXBhcmVkIG9iamVjdHMsIHVzaW5nIHRoZWlyIHBhcnNlcnMuCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgY29tcHV0ZWQgPSBbXTsKCQkoTWF0aC5taW4oZnJvbS5sZW5ndGgsIHRvLmxlbmd0aCkpLnRpbWVzKGZ1bmN0aW9uKGkpewoJCQljb21wdXRlZC5wdXNoKHt2YWx1ZTogZnJvbVtpXS5wYXJzZXIuY29tcHV0ZShmcm9tW2ldLnZhbHVlLCB0b1tpXS52YWx1ZSwgZGVsdGEpLCBwYXJzZXI6IGZyb21baV0ucGFyc2VyfSk7CgkJfSk7CgkJY29tcHV0ZWQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2Z4OmNzczp2YWx1ZScpOwoJCXJldHVybiBjb21wdXRlZDsKCX0sCgoJLy9zZXJ2ZXMgdGhlIHZhbHVlIGFzIHNldHRhYmxlCgoJc2VydmU6IGZ1bmN0aW9uKHZhbHVlLCB1bml0KXsKCQlpZiAodHlwZU9mKHZhbHVlKSAhPSAnZng6Y3NzOnZhbHVlJykgdmFsdWUgPSB0aGlzLnBhcnNlKHZhbHVlKTsKCQl2YXIgcmV0dXJuZWQgPSBbXTsKCQl2YWx1ZS5lYWNoKGZ1bmN0aW9uKGJpdCl7CgkJCXJldHVybmVkID0gcmV0dXJuZWQuY29uY2F0KGJpdC5wYXJzZXIuc2VydmUoYml0LnZhbHVlLCB1bml0KSk7CgkJfSk7CgkJcmV0dXJuIHJldHVybmVkOwoJfSwKCgkvL3JlbmRlcnMgdGhlIGNoYW5nZSB0byBhbiBlbGVtZW50CgoJcmVuZGVyOiBmdW5jdGlvbihlbGVtZW50LCBwcm9wZXJ0eSwgdmFsdWUsIHVuaXQpewoJCWVsZW1lbnQuc2V0U3R5bGUocHJvcGVydHksIHRoaXMuc2VydmUodmFsdWUsIHVuaXQpKTsKCX0sCgoJLy9zZWFyY2hlcyBpbnNpZGUgdGhlIHBhZ2UgY3NzIHRvIGZpbmQgdGhlIHZhbHVlcyBmb3IgYSBzZWxlY3RvcgoKCXNlYXJjaDogZnVuY3Rpb24oc2VsZWN0b3IpewoJCWlmIChGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdKSByZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXTsKCQl2YXIgdG8gPSB7fSwgc2VsZWN0b3JUZXN0ID0gbmV3IFJlZ0V4cCgnXicgKyBzZWxlY3Rvci5lc2NhcGVSZWdFeHAoKSArICckJyk7CgkJQXJyYXkuZWFjaChkb2N1bWVudC5zdHlsZVNoZWV0cywgZnVuY3Rpb24oc2hlZXQsIGopewoJCQl2YXIgaHJlZiA9IHNoZWV0LmhyZWY7CgkJCWlmIChocmVmICYmIGhyZWYuY29udGFpbnMoJzovLycpICYmICFocmVmLmNvbnRhaW5zKGRvY3VtZW50LmRvbWFpbikpIHJldHVybjsKCQkJdmFyIHJ1bGVzID0gc2hlZXQucnVsZXMgfHwgc2hlZXQuY3NzUnVsZXM7CgkJCUFycmF5LmVhY2gocnVsZXMsIGZ1bmN0aW9uKHJ1bGUsIGkpewoJCQkJaWYgKCFydWxlLnN0eWxlKSByZXR1cm47CgkJCQl2YXIgc2VsZWN0b3JUZXh0ID0gKHJ1bGUuc2VsZWN0b3JUZXh0KSA/IHJ1bGUuc2VsZWN0b3JUZXh0LnJlcGxhY2UoL15cdysvLCBmdW5jdGlvbihtKXsKCQkJCQlyZXR1cm4gbS50b0xvd2VyQ2FzZSgpOwoJCQkJfSkgOiBudWxsOwoJCQkJaWYgKCFzZWxlY3RvclRleHQgfHwgIXNlbGVjdG9yVGVzdC50ZXN0KHNlbGVjdG9yVGV4dCkpIHJldHVybjsKCQkJCU9iamVjdC5lYWNoKEVsZW1lbnQuU3R5bGVzLCBmdW5jdGlvbih2YWx1ZSwgc3R5bGUpewoJCQkJCWlmICghcnVsZS5zdHlsZVtzdHlsZV0gfHwgRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJldHVybjsKCQkJCQl2YWx1ZSA9IFN0cmluZyhydWxlLnN0eWxlW3N0eWxlXSk7CgkJCQkJdG9bc3R5bGVdID0gKCgvXnJnYi8pLnRlc3QodmFsdWUpKSA/IHZhbHVlLnJnYlRvSGV4KCkgOiB2YWx1ZTsKCQkJCX0pOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXSA9IHRvOwoJfQoKfSk7CgpGeC5DU1MuQ2FjaGUgPSB7fTsKCkZ4LkNTUy5QYXJzZXJzID0gewoKCUNvbG9yOiB7CgkJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJaWYgKHZhbHVlLm1hdGNoKC9eI1swLTlhLWZdezMsNn0kL2kpKSByZXR1cm4gdmFsdWUuaGV4VG9SZ2IodHJ1ZSk7CgkJCXJldHVybiAoKHZhbHVlID0gdmFsdWUubWF0Y2goLyhcZCspLFxzKihcZCspLFxzKihcZCspLykpKSA/IFt2YWx1ZVsxXSwgdmFsdWVbMl0sIHZhbHVlWzNdXSA6IGZhbHNlOwoJCX0sCgkJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQkJcmV0dXJuIGZyb20ubWFwKGZ1bmN0aW9uKHZhbHVlLCBpKXsKCQkJCXJldHVybiBNYXRoLnJvdW5kKEZ4LmNvbXB1dGUoZnJvbVtpXSwgdG9baV0sIGRlbHRhKSk7CgkJCX0pOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlLm1hcChOdW1iZXIpOwoJCX0KCX0sCgoJTnVtYmVyOiB7CgkJcGFyc2U6IHBhcnNlRmxvYXQsCgkJY29tcHV0ZTogRnguY29tcHV0ZSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCQlyZXR1cm4gKHVuaXQpID8gdmFsdWUgKyB1bml0IDogdmFsdWU7CgkJfQoJfSwKCglTdHJpbmc6IHsKCQlwYXJzZTogRnVuY3Rpb24uZnJvbShmYWxzZSksCgkJY29tcHV0ZTogZnVuY3Rpb24oemVybywgb25lKXsKCQkJcmV0dXJuIG9uZTsKCQl9LAoJCXNlcnZlOiBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfQoJfQoKfTsKCi8qCi0tLQoKbmFtZTogRnguVHdlZW4KCmRlc2NyaXB0aW9uOiBGb3JtZXJseSBGeC5TdHlsZSwgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IENTUyBwcm9wZXJ0eSBmb3IgYW4gZWxlbWVudC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IFtGeC5Ud2VlbiwgRWxlbWVudC5mYWRlLCBFbGVtZW50LmhpZ2hsaWdodF0KCi4uLgoqLwoKRnguVHdlZW4gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihwcm9wZXJ0eSwgbm93KXsKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQkJbm93ID0gcHJvcGVydHk7CgkJCXByb3BlcnR5ID0gdGhpcy5wcm9wZXJ0eSB8fCB0aGlzLm9wdGlvbnMucHJvcGVydHk7CgkJfQoJCXRoaXMucmVuZGVyKHRoaXMuZWxlbWVudCwgcHJvcGVydHksIG5vdywgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdGFydDogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydHksIGZyb20sIHRvKSkgcmV0dXJuIHRoaXM7CgkJdmFyIGFyZ3MgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyk7CgkJdGhpcy5wcm9wZXJ0eSA9IHRoaXMub3B0aW9ucy5wcm9wZXJ0eSB8fCBhcmdzLnNoaWZ0KCk7CgkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHRoaXMucHJvcGVydHksIGFyZ3MpOwoJCXJldHVybiB0aGlzLnBhcmVudChwYXJzZWQuZnJvbSwgcGFyc2VkLnRvKTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnR3ZWVuID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5nZXQoJ3R3ZWVuJykuY2FuY2VsKCkuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciB0d2VlbiA9IHRoaXMucmV0cmlldmUoJ3R3ZWVuJyk7CgkJaWYgKCF0d2Vlbil7CgkJCXR3ZWVuID0gbmV3IEZ4LlR3ZWVuKHRoaXMsIHtsaW5rOiAnY2FuY2VsJ30pOwoJCQl0aGlzLnN0b3JlKCd0d2VlbicsIHR3ZWVuKTsKCQl9CgkJcmV0dXJuIHR3ZWVuOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCgl0d2VlbjogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQl0aGlzLmdldCgndHdlZW4nKS5zdGFydChhcmd1bWVudHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglmYWRlOiBmdW5jdGlvbihob3cpewoJCXZhciBmYWRlID0gdGhpcy5nZXQoJ3R3ZWVuJyksIG8gPSAnb3BhY2l0eScsIHRvZ2dsZTsKCQlob3cgPSBbaG93LCAndG9nZ2xlJ10ucGljaygpOwoJCXN3aXRjaCAoaG93KXsKCQkJY2FzZSAnaW4nOiBmYWRlLnN0YXJ0KG8sIDEpOyBicmVhazsKCQkJY2FzZSAnb3V0JzogZmFkZS5zdGFydChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3Nob3cnOiBmYWRlLnNldChvLCAxKTsgYnJlYWs7CgkJCWNhc2UgJ2hpZGUnOiBmYWRlLnNldChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3RvZ2dsZSc6CgkJCQl2YXIgZmxhZyA9IHRoaXMucmV0cmlldmUoJ2ZhZGU6ZmxhZycsIHRoaXMuZ2V0KCdvcGFjaXR5JykgPT0gMSk7CgkJCQlmYWRlLnN0YXJ0KG8sIChmbGFnKSA/IDAgOiAxKTsKCQkJCXRoaXMuc3RvcmUoJ2ZhZGU6ZmxhZycsICFmbGFnKTsKCQkJCXRvZ2dsZSA9IHRydWU7CgkJCWJyZWFrOwoJCQlkZWZhdWx0OiBmYWRlLnN0YXJ0KG8sIGFyZ3VtZW50cyk7CgkJfQoJCWlmICghdG9nZ2xlKSB0aGlzLmVsaW1pbmF0ZSgnZmFkZTpmbGFnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWhpZ2hsaWdodDogZnVuY3Rpb24oc3RhcnQsIGVuZCl7CgkJaWYgKCFlbmQpewoJCQllbmQgPSB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnLCB0aGlzLmdldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJykpOwoJCQllbmQgPSAoZW5kID09ICd0cmFuc3BhcmVudCcpID8gJyNmZmYnIDogZW5kOwoJCX0KCQl2YXIgdHdlZW4gPSB0aGlzLmdldCgndHdlZW4nKTsKCQl0d2Vlbi5zdGFydCgnYmFja2dyb3VuZC1jb2xvcicsIHN0YXJ0IHx8ICcjZmZmZjg4JywgZW5kKS5jaGFpbihmdW5jdGlvbigpewoJCQl0aGlzLnNldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJywgdGhpcy5yZXRyaWV2ZSgnaGlnaGxpZ2h0Om9yaWdpbmFsJykpOwoJCQl0d2Vlbi5jYWxsQ2hhaW4oKTsKCQl9LmJpbmQodGhpcykpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovKgotLS0KCm5hbWU6IEZ4Lk1vcnBoCgpkZXNjcmlwdGlvbjogRm9ybWVybHkgRnguU3R5bGVzLCBlZmZlY3QgdG8gdHJhbnNpdGlvbiBhbnkgbnVtYmVyIG9mIENTUyBwcm9wZXJ0aWVzIGZvciBhbiBlbGVtZW50IHVzaW5nIGFuIG9iamVjdCBvZiBydWxlcywgb3IgQ1NTIGJhc2VkIHNlbGVjdG9yIHJ1bGVzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRnguQ1NTCgpwcm92aWRlczogRnguTW9ycGgKCi4uLgoqLwoKRnguTW9ycGggPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihub3cpewoJCWlmICh0eXBlb2Ygbm93ID09ICdzdHJpbmcnKSBub3cgPSB0aGlzLnNlYXJjaChub3cpOwoJCWZvciAodmFyIHAgaW4gbm93KSB0aGlzLnJlbmRlcih0aGlzLmVsZW1lbnQsIHAsIG5vd1twXSwgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBub3cgPSB7fTsKCQlmb3IgKHZhciBwIGluIGZyb20pIG5vd1twXSA9IHRoaXMucGFyZW50KGZyb21bcF0sIHRvW3BdLCBkZWx0YSk7CgkJcmV0dXJuIG5vdzsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJCWlmICghdGhpcy5jaGVjayhwcm9wZXJ0aWVzKSkgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZiBwcm9wZXJ0aWVzID09ICdzdHJpbmcnKSBwcm9wZXJ0aWVzID0gdGhpcy5zZWFyY2gocHJvcGVydGllcyk7CgkJdmFyIGZyb20gPSB7fSwgdG8gPSB7fTsKCQlmb3IgKHZhciBwIGluIHByb3BlcnRpZXMpewoJCQl2YXIgcGFyc2VkID0gdGhpcy5wcmVwYXJlKHRoaXMuZWxlbWVudCwgcCwgcHJvcGVydGllc1twXSk7CgkJCWZyb21bcF0gPSBwYXJzZWQuZnJvbTsKCQkJdG9bcF0gPSBwYXJzZWQudG87CgkJfQoJCXJldHVybiB0aGlzLnBhcmVudChmcm9tLCB0byk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5tb3JwaCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuZ2V0KCdtb3JwaCcpLmNhbmNlbCgpLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgbW9ycGggPSB0aGlzLnJldHJpZXZlKCdtb3JwaCcpOwoJCWlmICghbW9ycGgpewoJCQltb3JwaCA9IG5ldyBGeC5Nb3JwaCh0aGlzLCB7bGluazogJ2NhbmNlbCd9KTsKCQkJdGhpcy5zdG9yZSgnbW9ycGgnLCBtb3JwaCk7CgkJfQoJCXJldHVybiBtb3JwaDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbW9ycGg6IGZ1bmN0aW9uKHByb3BzKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5zdGFydChwcm9wcyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8qCi0tLQoKbmFtZTogRnguVHJhbnNpdGlvbnMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBhIHNldCBvZiBhZHZhbmNlZCB0cmFuc2l0aW9ucyB0byBiZSB1c2VkIHdpdGggYW55IG9mIHRoZSBGeCBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRWFzaW5nIEVxdWF0aW9ucyBieSBSb2JlcnQgUGVubmVyLCA8aHR0cDovL3d3dy5yb2JlcnRwZW5uZXIuY29tL2Vhc2luZy8+LCBtb2RpZmllZCBhbmQgb3B0aW1pemVkIHRvIGJlIHVzZWQgd2l0aCBNb29Ub29scy4KCnJlcXVpcmVzOiBGeAoKcHJvdmlkZXM6IEZ4LlRyYW5zaXRpb25zCgouLi4KKi8KCkZ4LmltcGxlbWVudCh7CgoJZ2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oKXsKCQl2YXIgdHJhbnMgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiB8fCBGeC5UcmFuc2l0aW9ucy5TaW5lLmVhc2VJbk91dDsKCQlpZiAodHlwZW9mIHRyYW5zID09ICdzdHJpbmcnKXsKCQkJdmFyIGRhdGEgPSB0cmFucy5zcGxpdCgnOicpOwoJCQl0cmFucyA9IEZ4LlRyYW5zaXRpb25zOwoJCQl0cmFucyA9IHRyYW5zW2RhdGFbMF1dIHx8IHRyYW5zW2RhdGFbMF0uY2FwaXRhbGl6ZSgpXTsKCQkJaWYgKGRhdGFbMV0pIHRyYW5zID0gdHJhbnNbJ2Vhc2UnICsgZGF0YVsxXS5jYXBpdGFsaXplKCkgKyAoZGF0YVsyXSA/IGRhdGFbMl0uY2FwaXRhbGl6ZSgpIDogJycpXTsKCQl9CgkJcmV0dXJuIHRyYW5zOwoJfQoKfSk7CgpGeC5UcmFuc2l0aW9uID0gZnVuY3Rpb24odHJhbnNpdGlvbiwgcGFyYW1zKXsKCXBhcmFtcyA9IEFycmF5LmZyb20ocGFyYW1zKTsKCXZhciBlYXNlSW4gPSBmdW5jdGlvbihwb3MpewoJCXJldHVybiB0cmFuc2l0aW9uKHBvcywgcGFyYW1zKTsKCX07CglyZXR1cm4gT2JqZWN0LmFwcGVuZChlYXNlSW4sIHsKCQllYXNlSW46IGVhc2VJbiwKCQllYXNlT3V0OiBmdW5jdGlvbihwb3MpewoJCQlyZXR1cm4gMSAtIHRyYW5zaXRpb24oMSAtIHBvcywgcGFyYW1zKTsKCQl9LAoJCWVhc2VJbk91dDogZnVuY3Rpb24ocG9zKXsKCQkJcmV0dXJuIChwb3MgPD0gMC41ID8gdHJhbnNpdGlvbigyICogcG9zLCBwYXJhbXMpIDogKDIgLSB0cmFuc2l0aW9uKDIgKiAoMSAtIHBvcyksIHBhcmFtcykpKSAvIDI7CgkJfQoJfSk7Cn07CgpGeC5UcmFuc2l0aW9ucyA9IHsKCglsaW5lYXI6IGZ1bmN0aW9uKHplcm8pewoJCXJldHVybiB6ZXJvOwoJfQoKfTsKCkZ4LlRyYW5zaXRpb25zLmV4dGVuZCA9IGZ1bmN0aW9uKHRyYW5zaXRpb25zKXsKCWZvciAodmFyIHRyYW5zaXRpb24gaW4gdHJhbnNpdGlvbnMpIEZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb25dID0gbmV3IEZ4LlRyYW5zaXRpb24odHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0pOwp9OwoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kKHsKCglQb3c6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdyhwLCB4ICYmIHhbMF0gfHwgNik7Cgl9LAoKCUV4cG86IGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdygyLCA4ICogKHAgLSAxKSk7Cgl9LAoKCUNpcmM6IGZ1bmN0aW9uKHApewoJCXJldHVybiAxIC0gTWF0aC5zaW4oTWF0aC5hY29zKHApKTsKCX0sCgoJU2luZTogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLmNvcyhwICogTWF0aC5QSSAvIDIpOwoJfSwKCglCYWNrOiBmdW5jdGlvbihwLCB4KXsKCQl4ID0geCAmJiB4WzBdIHx8IDEuNjE4OwoJCXJldHVybiBNYXRoLnBvdyhwLCAyKSAqICgoeCArIDEpICogcCAtIHgpOwoJfSwKCglCb3VuY2U6IGZ1bmN0aW9uKHApewoJCXZhciB2YWx1ZTsKCQlmb3IgKHZhciBhID0gMCwgYiA9IDE7IDE7IGEgKz0gYiwgYiAvPSAyKXsKCQkJaWYgKHAgPj0gKDcgLSA0ICogYSkgLyAxMSl7CgkJCQl2YWx1ZSA9IGIgKiBiIC0gTWF0aC5wb3coKDExIC0gNiAqIGEgLSAxMSAqIHApIC8gNCwgMik7CgkJCQlicmVhazsKCQkJfQoJCX0KCQlyZXR1cm4gdmFsdWU7Cgl9LAoKCUVsYXN0aWM6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdygyLCAxMCAqIC0tcCkgKiBNYXRoLmNvcygyMCAqIHAgKiBNYXRoLlBJICogKHggJiYgeFswXSB8fCAxKSAvIDMpOwoJfQoKfSk7CgpbJ1F1YWQnLCAnQ3ViaWMnLCAnUXVhcnQnLCAnUXVpbnQnXS5lYWNoKGZ1bmN0aW9uKHRyYW5zaXRpb24sIGkpewoJRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbihmdW5jdGlvbihwKXsKCQlyZXR1cm4gTWF0aC5wb3cocCwgaSArIDIpOwoJfSk7Cn0pOwoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0CgpkZXNjcmlwdGlvbjogUG93ZXJmdWwgYWxsIHB1cnBvc2UgUmVxdWVzdCBDbGFzcy4gVXNlcyBYTUxIVFRQUmVxdWVzdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtPYmplY3QsIEVsZW1lbnQsIENoYWluLCBFdmVudHMsIE9wdGlvbnMsIEJyb3dzZXJdCgpwcm92aWRlczogUmVxdWVzdAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBlbXB0eSA9IGZ1bmN0aW9uKCl7fSwKCXByb2dyZXNzU3VwcG9ydCA9ICgnb25wcm9ncmVzcycgaW4gbmV3IEJyb3dzZXIuUmVxdWVzdCk7Cgp2YXIgUmVxdWVzdCA9IHRoaXMuUmVxdWVzdCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsvKgoJCW9uUmVxdWVzdDogZnVuY3Rpb24oKXt9LAoJCW9uTG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uUHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50LCB4aHIpe30sCgkJb25Db21wbGV0ZTogZnVuY3Rpb24oKXt9LAoJCW9uQ2FuY2VsOiBmdW5jdGlvbigpe30sCgkJb25TdWNjZXNzOiBmdW5jdGlvbihyZXNwb25zZVRleHQsIHJlc3BvbnNlWE1MKXt9LAoJCW9uRmFpbHVyZTogZnVuY3Rpb24oeGhyKXt9LAoJCW9uRXhjZXB0aW9uOiBmdW5jdGlvbihoZWFkZXJOYW1lLCB2YWx1ZSl7fSwKCQlvblRpbWVvdXQ6IGZ1bmN0aW9uKCl7fSwKCQl1c2VyOiAnJywKCQlwYXNzd29yZDogJycsKi8KCQl1cmw6ICcnLAoJCWRhdGE6ICcnLAoJCWhlYWRlcnM6IHsKCQkJJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnLAoJCQknQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfSwKCQlhc3luYzogdHJ1ZSwKCQlmb3JtYXQ6IGZhbHNlLAoJCW1ldGhvZDogJ3Bvc3QnLAoJCWxpbms6ICdpZ25vcmUnLAoJCWlzU3VjY2VzczogbnVsbCwKCQllbXVsYXRpb246IHRydWUsCgkJdXJsRW5jb2RlZDogdHJ1ZSwKCQllbmNvZGluZzogJ3V0Zi04JywKCQlldmFsU2NyaXB0czogZmFsc2UsCgkJZXZhbFJlc3BvbnNlOiBmYWxzZSwKCQl0aW1lb3V0OiAwLAoJCW5vQ2FjaGU6IGZhbHNlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLm9wdGlvbnMuaGVhZGVyczsKCX0sCgoJb25TdGF0ZUNoYW5nZTogZnVuY3Rpb24oKXsKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHhoci5yZWFkeVN0YXRlICE9IDQgfHwgIXRoaXMucnVubmluZykgcmV0dXJuOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXRoaXMuc3RhdHVzID0gMDsKCQlGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXZhciBzdGF0dXMgPSB4aHIuc3RhdHVzOwoJCQl0aGlzLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXM7CgkJfS5iaW5kKHRoaXMpKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgoJCXRoaXMucmVzcG9uc2UgPSB7dGV4dDogdGhpcy54aHIucmVzcG9uc2VUZXh0IHx8ICcnLCB4bWw6IHRoaXMueGhyLnJlc3BvbnNlWE1MfTsKCQlpZiAodGhpcy5vcHRpb25zLmlzU3VjY2Vzcy5jYWxsKHRoaXMsIHRoaXMuc3RhdHVzKSkKCQkJdGhpcy5zdWNjZXNzKHRoaXMucmVzcG9uc2UudGV4dCwgdGhpcy5yZXNwb25zZS54bWwpOwoJCWVsc2UKCQkJdGhpcy5mYWlsdXJlKCk7Cgl9LAoKCWlzU3VjY2VzczogZnVuY3Rpb24oKXsKCQl2YXIgc3RhdHVzID0gdGhpcy5zdGF0dXM7CgkJcmV0dXJuIChzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCk7Cgl9LAoKCWlzUnVubmluZzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gISF0aGlzLnJ1bm5pbmc7Cgl9LAoKCXByb2Nlc3NTY3JpcHRzOiBmdW5jdGlvbih0ZXh0KXsKCQlpZiAodGhpcy5vcHRpb25zLmV2YWxSZXNwb25zZSB8fCAoLyhlY21hfGphdmEpc2NyaXB0LykudGVzdCh0aGlzLmdldEhlYWRlcignQ29udGVudC10eXBlJykpKSByZXR1cm4gQnJvd3Nlci5leGVjKHRleHQpOwoJCXJldHVybiB0ZXh0LnN0cmlwU2NyaXB0cyh0aGlzLm9wdGlvbnMuZXZhbFNjcmlwdHMpOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0LCB4bWwpewoJCXRoaXMub25TdWNjZXNzKHRoaXMucHJvY2Vzc1NjcmlwdHModGV4dCksIHhtbCk7Cgl9LAoKCW9uU3VjY2VzczogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnY29tcGxldGUnLCBhcmd1bWVudHMpLmZpcmVFdmVudCgnc3VjY2VzcycsIGFyZ3VtZW50cykuY2FsbENoYWluKCk7Cgl9LAoKCWZhaWx1cmU6IGZ1bmN0aW9uKCl7CgkJdGhpcy5vbkZhaWx1cmUoKTsKCX0sCgoJb25GYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScpLmZpcmVFdmVudCgnZmFpbHVyZScsIHRoaXMueGhyKTsKCX0sCgoJbG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ2xvYWRzdGFydCcsIFtldmVudCwgdGhpcy54aHJdKTsKCX0sCgoJcHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50KXsKCQl0aGlzLmZpcmVFdmVudCgncHJvZ3Jlc3MnLCBbZXZlbnQsIHRoaXMueGhyXSk7Cgl9LAoKCXRpbWVvdXQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ3RpbWVvdXQnLCB0aGlzLnhocik7Cgl9LAoKCXNldEhlYWRlcjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewoJCXRoaXMuaGVhZGVyc1tuYW1lXSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUpewoJCXJldHVybiBGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXJldHVybiB0aGlzLnhoci5nZXRSZXNwb25zZUhlYWRlcihuYW1lKTsKCQl9LmJpbmQodGhpcykpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRydWU7CgkJc3dpdGNoICh0aGlzLm9wdGlvbnMubGluayl7CgkJCWNhc2UgJ2NhbmNlbCc6IHRoaXMuY2FuY2VsKCk7IHJldHVybiB0cnVlOwoJCQljYXNlICdjaGFpbic6IHRoaXMuY2hhaW4odGhpcy5jYWxsZXIucGFzcyhhcmd1bWVudHMsIHRoaXMpKTsgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCXNlbmQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCWlmICghdGhpcy5jaGVjayhvcHRpb25zKSkgcmV0dXJuIHRoaXM7CgoJCXRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgPSB0aGlzLm9wdGlvbnMuaXNTdWNjZXNzIHx8IHRoaXMuaXNTdWNjZXNzOwoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCXZhciB0eXBlID0gdHlwZU9mKG9wdGlvbnMpOwoJCWlmICh0eXBlID09ICdzdHJpbmcnIHx8IHR5cGUgPT0gJ2VsZW1lbnQnKSBvcHRpb25zID0ge2RhdGE6IG9wdGlvbnN9OwoKCQl2YXIgb2xkID0gdGhpcy5vcHRpb25zOwoJCW9wdGlvbnMgPSBPYmplY3QuYXBwZW5kKHtkYXRhOiBvbGQuZGF0YSwgdXJsOiBvbGQudXJsLCBtZXRob2Q6IG9sZC5tZXRob2R9LCBvcHRpb25zKTsKCQl2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKSwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKTsKCgkJc3dpdGNoICh0eXBlT2YoZGF0YSkpewoJCQljYXNlICdlbGVtZW50JzogZGF0YSA9IGRvY3VtZW50LmlkKGRhdGEpLnRvUXVlcnlTdHJpbmcoKTsgYnJlYWs7CgkJCWNhc2UgJ29iamVjdCc6IGNhc2UgJ2hhc2gnOiBkYXRhID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcoZGF0YSk7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmZvcm1hdCl7CgkJCXZhciBmb3JtYXQgPSAnZm9ybWF0PScgKyB0aGlzLm9wdGlvbnMuZm9ybWF0OwoJCQlkYXRhID0gKGRhdGEpID8gZm9ybWF0ICsgJyYnICsgZGF0YSA6IGZvcm1hdDsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMuZW11bGF0aW9uICYmICFbJ2dldCcsICdwb3N0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZDsKCQkJZGF0YSA9IChkYXRhKSA/IF9tZXRob2QgKyAnJicgKyBkYXRhIDogX21ldGhvZDsKCQkJbWV0aG9kID0gJ3Bvc3QnOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy51cmxFbmNvZGVkICYmIFsncG9zdCcsICdwdXQnXS5jb250YWlucyhtZXRob2QpKXsKCQkJdmFyIGVuY29kaW5nID0gKHRoaXMub3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyB0aGlzLm9wdGlvbnMuZW5jb2RpbmcgOiAnJzsKCQkJdGhpcy5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2Rpbmc7CgkJfQoKCQlpZiAoIXVybCkgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWU7CgoJCXZhciB0cmltUG9zaXRpb24gPSB1cmwubGFzdEluZGV4T2YoJy8nKTsKCQlpZiAodHJpbVBvc2l0aW9uID4gLTEgJiYgKHRyaW1Qb3NpdGlvbiA9IHVybC5pbmRleE9mKCcjJykpID4gLTEpIHVybCA9IHVybC5zdWJzdHIoMCwgdHJpbVBvc2l0aW9uKTsKCgkJaWYgKHRoaXMub3B0aW9ucy5ub0NhY2hlKQoJCQl1cmwgKz0gKHVybC5jb250YWlucygnPycpID8gJyYnIDogJz8nKSArIFN0cmluZy51bmlxdWVJRCgpOwoKCQlpZiAoZGF0YSAmJiBtZXRob2QgPT0gJ2dldCcpewoJCQl1cmwgKz0gKHVybC5jb250YWlucygnPycpID8gJyYnIDogJz8nKSArIGRhdGE7CgkJCWRhdGEgPSBudWxsOwoJCX0KCgkJdmFyIHhociA9IHRoaXMueGhyOwoJCWlmIChwcm9ncmVzc1N1cHBvcnQpewoJCQl4aHIub25sb2Fkc3RhcnQgPSB0aGlzLmxvYWRzdGFydC5iaW5kKHRoaXMpOwoJCQl4aHIub25wcm9ncmVzcyA9IHRoaXMucHJvZ3Jlc3MuYmluZCh0aGlzKTsKCQl9CgoJCXhoci5vcGVuKG1ldGhvZC50b1VwcGVyQ2FzZSgpLCB1cmwsIHRoaXMub3B0aW9ucy5hc3luYywgdGhpcy5vcHRpb25zLnVzZXIsIHRoaXMub3B0aW9ucy5wYXNzd29yZCk7CgkJaWYgKHRoaXMub3B0aW9ucy51c2VyICYmICd3aXRoQ3JlZGVudGlhbHMnIGluIHhocikgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CgoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB0aGlzLm9uU3RhdGVDaGFuZ2UuYmluZCh0aGlzKTsKCgkJT2JqZWN0LmVhY2godGhpcy5oZWFkZXJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJdHJ5IHsKCQkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwoJCQl9IGNhdGNoIChlKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCBba2V5LCB2YWx1ZV0pOwoJCQl9CgkJfSwgdGhpcyk7CgoJCXRoaXMuZmlyZUV2ZW50KCdyZXF1ZXN0Jyk7CgkJeGhyLnNlbmQoZGF0YSk7CgkJaWYgKCF0aGlzLm9wdGlvbnMuYXN5bmMpIHRoaXMub25TdGF0ZUNoYW5nZSgpOwoJCWlmICh0aGlzLm9wdGlvbnMudGltZW91dCkgdGhpcy50aW1lciA9IHRoaXMudGltZW91dC5kZWxheSh0aGlzLm9wdGlvbnMudGltZW91dCwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNhbmNlbDogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCXhoci5hYm9ydCgpOwoJCWNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLmZpcmVFdmVudCgnY2FuY2VsJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciBtZXRob2RzID0ge307ClsnZ2V0JywgJ3Bvc3QnLCAncHV0JywgJ2RlbGV0ZScsICdHRVQnLCAnUE9TVCcsICdQVVQnLCAnREVMRVRFJ10uZWFjaChmdW5jdGlvbihtZXRob2QpewoJbWV0aG9kc1ttZXRob2RdID0gZnVuY3Rpb24oZGF0YSl7CgkJdmFyIG9iamVjdCA9IHsKCQkJbWV0aG9kOiBtZXRob2QKCQl9OwoJCWlmIChkYXRhICE9IG51bGwpIG9iamVjdC5kYXRhID0gZGF0YTsKCQlyZXR1cm4gdGhpcy5zZW5kKG9iamVjdCk7Cgl9Owp9KTsKClJlcXVlc3QuaW1wbGVtZW50KG1ldGhvZHMpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnNlbmQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgc2VuZCA9IHRoaXMuZ2V0KCdzZW5kJykuY2FuY2VsKCk7CgkJc2VuZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHNlbmQgPSB0aGlzLnJldHJpZXZlKCdzZW5kJyk7CgkJaWYgKCFzZW5kKXsKCQkJc2VuZCA9IG5ldyBSZXF1ZXN0KHsKCQkJCWRhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCBtZXRob2Q6IHRoaXMuZ2V0KCdtZXRob2QnKSB8fCAncG9zdCcsIHVybDogdGhpcy5nZXQoJ2FjdGlvbicpCgkJCX0pOwoJCQl0aGlzLnN0b3JlKCdzZW5kJywgc2VuZCk7CgkJfQoJCXJldHVybiBzZW5kOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzZW5kOiBmdW5jdGlvbih1cmwpewoJCXZhciBzZW5kZXIgPSB0aGlzLmdldCgnc2VuZCcpOwoJCXNlbmRlci5zZW5kKHtkYXRhOiB0aGlzLCB1cmw6IHVybCB8fCBzZW5kZXIub3B0aW9ucy51cmx9KTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKfSkoKTsKCi8qCi0tLQoKbmFtZTogUmVxdWVzdC5IVE1MCgpkZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgYmFzaWMgUmVxdWVzdCBDbGFzcyB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcyBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBIVE1MIHJlc3BvbnNlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBSZXF1ZXN0XQoKcHJvdmlkZXM6IFJlcXVlc3QuSFRNTAoKLi4uCiovCgpSZXF1ZXN0LkhUTUwgPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IFJlcXVlc3QsCgoJb3B0aW9uczogewoJCXVwZGF0ZTogZmFsc2UsCgkJYXBwZW5kOiBmYWxzZSwKCQlldmFsU2NyaXB0czogdHJ1ZSwKCQlmaWx0ZXI6IGZhbHNlLAoJCWhlYWRlcnM6IHsKCQkJQWNjZXB0OiAndGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfQoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywgcmVzcG9uc2UgPSB0aGlzLnJlc3BvbnNlOwoKCQlyZXNwb25zZS5odG1sID0gdGV4dC5zdHJpcFNjcmlwdHMoZnVuY3Rpb24oc2NyaXB0KXsKCQkJcmVzcG9uc2UuamF2YXNjcmlwdCA9IHNjcmlwdDsKCQl9KTsKCgkJdmFyIG1hdGNoID0gcmVzcG9uc2UuaHRtbC5tYXRjaCgvPGJvZHlbXj5dKj4oW1xzXFNdKj8pPFwvYm9keT4vaSk7CgkJaWYgKG1hdGNoKSByZXNwb25zZS5odG1sID0gbWF0Y2hbMV07CgkJdmFyIHRlbXAgPSBuZXcgRWxlbWVudCgnZGl2Jykuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgoJCXJlc3BvbnNlLnRyZWUgPSB0ZW1wLmNoaWxkTm9kZXM7CgkJcmVzcG9uc2UuZWxlbWVudHMgPSB0ZW1wLmdldEVsZW1lbnRzKCcqJyk7CgoJCWlmIChvcHRpb25zLmZpbHRlcikgcmVzcG9uc2UudHJlZSA9IHJlc3BvbnNlLmVsZW1lbnRzLmZpbHRlcihvcHRpb25zLmZpbHRlcik7CgkJaWYgKG9wdGlvbnMudXBkYXRlKSBkb2N1bWVudC5pZChvcHRpb25zLnVwZGF0ZSkuZW1wdHkoKS5zZXQoJ2h0bWwnLCByZXNwb25zZS5odG1sKTsKCQllbHNlIGlmIChvcHRpb25zLmFwcGVuZCkgZG9jdW1lbnQuaWQob3B0aW9ucy5hcHBlbmQpLmFkb3B0KHRlbXAuZ2V0Q2hpbGRyZW4oKSk7CgkJaWYgKG9wdGlvbnMuZXZhbFNjcmlwdHMpIEJyb3dzZXIuZXhlYyhyZXNwb25zZS5qYXZhc2NyaXB0KTsKCgkJdGhpcy5vblN1Y2Nlc3MocmVzcG9uc2UudHJlZSwgcmVzcG9uc2UuZWxlbWVudHMsIHJlc3BvbnNlLmh0bWwsIHJlc3BvbnNlLmphdmFzY3JpcHQpOwoJfQoKfSk7CgpFbGVtZW50LlByb3BlcnRpZXMubG9hZCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXZhciBsb2FkID0gdGhpcy5nZXQoJ2xvYWQnKS5jYW5jZWwoKTsKCQlsb2FkLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgbG9hZCA9IHRoaXMucmV0cmlldmUoJ2xvYWQnKTsKCQlpZiAoIWxvYWQpewoJCQlsb2FkID0gbmV3IFJlcXVlc3QuSFRNTCh7ZGF0YTogdGhpcywgbGluazogJ2NhbmNlbCcsIHVwZGF0ZTogdGhpcywgbWV0aG9kOiAnZ2V0J30pOwoJCQl0aGlzLnN0b3JlKCdsb2FkJywgbG9hZCk7CgkJfQoJCXJldHVybiBsb2FkOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglsb2FkOiBmdW5jdGlvbigpewoJCXRoaXMuZ2V0KCdsb2FkJykuc2VuZChBcnJheS5saW5rKGFyZ3VtZW50cywge2RhdGE6IFR5cGUuaXNPYmplY3QsIHVybDogVHlwZS5pc1N0cmluZ30pKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLyoKLS0tCgpuYW1lOiBKU09OCgpkZXNjcmlwdGlvbjogSlNPTiBlbmNvZGVyIGFuZCBkZWNvZGVyLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpTZWUgQWxzbzogPGh0dHA6Ly93d3cuanNvbi5vcmcvPgoKcmVxdWlyZXM6IFtBcnJheSwgU3RyaW5nLCBOdW1iZXIsIEZ1bmN0aW9uXQoKcHJvdmlkZXM6IEpTT04KCi4uLgoqLwoKaWYgKHR5cGVvZiBKU09OID09ICd1bmRlZmluZWQnKSB0aGlzLkpTT04gPSB7fTsKCihmdW5jdGlvbigpewoKdmFyIHNwZWNpYWwgPSB7J1xiJzogJ1xcYicsICdcdCc6ICdcXHQnLCAnXG4nOiAnXFxuJywgJ1xmJzogJ1xcZicsICdccic6ICdcXHInLCAnIicgOiAnXFwiJywgJ1xcJzogJ1xcXFwnfTsKCnZhciBlc2NhcGUgPSBmdW5jdGlvbihjaHIpewoJcmV0dXJuIHNwZWNpYWxbY2hyXSB8fCAnXFx1JyArICgnMDAwMCcgKyBjaHIuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC00KTsKfTsKCkpTT04udmFsaWRhdGUgPSBmdW5jdGlvbihzdHJpbmcpewoJc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoL1xcKD86WyJcXFwvYmZucnRdfHVbMC05YS1mQS1GXXs0fSkvZywgJ0AnKS4KCQkJCQlyZXBsYWNlKC8iW14iXFxcblxyXSoifHRydWV8ZmFsc2V8bnVsbHwtP1xkKyg/OlwuXGQqKT8oPzpbZUVdWytcLV0/XGQrKT8vZywgJ10nKS4KCQkJCQlyZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICcnKTsKCglyZXR1cm4gKC9eW1xdLDp7fVxzXSokLykudGVzdChzdHJpbmcpOwp9OwoKSlNPTi5lbmNvZGUgPSBKU09OLnN0cmluZ2lmeSA/IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqKTsKfSA6IGZ1bmN0aW9uKG9iail7CglpZiAob2JqICYmIG9iai50b0pTT04pIG9iaiA9IG9iai50b0pTT04oKTsKCglzd2l0Y2ggKHR5cGVPZihvYmopKXsKCQljYXNlICdzdHJpbmcnOgoJCQlyZXR1cm4gJyInICsgb2JqLnJlcGxhY2UoL1tceDAwLVx4MWZcXCJdL2csIGVzY2FwZSkgKyAnIic7CgkJY2FzZSAnYXJyYXknOgoJCQlyZXR1cm4gJ1snICsgb2JqLm1hcChKU09OLmVuY29kZSkuY2xlYW4oKSArICddJzsKCQljYXNlICdvYmplY3QnOiBjYXNlICdoYXNoJzoKCQkJdmFyIHN0cmluZyA9IFtdOwoJCQlPYmplY3QuZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQkJdmFyIGpzb24gPSBKU09OLmVuY29kZSh2YWx1ZSk7CgkJCQlpZiAoanNvbikgc3RyaW5nLnB1c2goSlNPTi5lbmNvZGUoa2V5KSArICc6JyArIGpzb24pOwoJCQl9KTsKCQkJcmV0dXJuICd7JyArIHN0cmluZyArICd9JzsKCQljYXNlICdudW1iZXInOiBjYXNlICdib29sZWFuJzogcmV0dXJuICcnICsgb2JqOwoJCWNhc2UgJ251bGwnOiByZXR1cm4gJ251bGwnOwoJfQoKCXJldHVybiBudWxsOwp9OwoKSlNPTi5kZWNvZGUgPSBmdW5jdGlvbihzdHJpbmcsIHNlY3VyZSl7CglpZiAoIXN0cmluZyB8fCB0eXBlT2Yoc3RyaW5nKSAhPSAnc3RyaW5nJykgcmV0dXJuIG51bGw7CgoJaWYgKHNlY3VyZSB8fCBKU09OLnNlY3VyZSl7CgkJaWYgKEpTT04ucGFyc2UpIHJldHVybiBKU09OLnBhcnNlKHN0cmluZyk7CgkJaWYgKCFKU09OLnZhbGlkYXRlKHN0cmluZykpIHRocm93IG5ldyBFcnJvcignSlNPTiBjb3VsZCBub3QgZGVjb2RlIHRoZSBpbnB1dDsgc2VjdXJpdHkgaXMgZW5hYmxlZCBhbmQgdGhlIHZhbHVlIGlzIG5vdCBzZWN1cmUuJyk7Cgl9CgoJcmV0dXJuIGV2YWwoJygnICsgc3RyaW5nICsgJyknKTsKfTsKCn0pLmNhbGwodGhpcyk7CgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSlNPTgoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIHNlbmRpbmcgYW5kIHJlY2VpdmluZyBKU09OIGRhdGEuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbUmVxdWVzdCwgSlNPTl0KCnByb3ZpZGVzOiBSZXF1ZXN0LkpTT04KCi4uLgoqLwoKUmVxdWVzdC5KU09OID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQkvKm9uRXJyb3I6IGZ1bmN0aW9uKHRleHQsIGVycm9yKXt9LCovCgkJc2VjdXJlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMucGFyZW50KG9wdGlvbnMpOwoJCU9iamVjdC5hcHBlbmQodGhpcy5oZWFkZXJzLCB7CgkJCSdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsCgkJCSdYLVJlcXVlc3QnOiAnSlNPTicKCQl9KTsKCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCl7CgkJdmFyIGpzb247CgkJdHJ5IHsKCQkJanNvbiA9IHRoaXMucmVzcG9uc2UuanNvbiA9IEpTT04uZGVjb2RlKHRleHQsIHRoaXMub3B0aW9ucy5zZWN1cmUpOwoJCX0gY2F0Y2ggKGVycm9yKXsKCQkJdGhpcy5maXJlRXZlbnQoJ2Vycm9yJywgW3RleHQsIGVycm9yXSk7CgkJCXJldHVybjsKCQl9CgkJaWYgKGpzb24gPT0gbnVsbCkgdGhpcy5vbkZhaWx1cmUoKTsKCQllbHNlIHRoaXMub25TdWNjZXNzKGpzb24sIHRleHQpOwoJfQoKfSk7CgovKgotLS0KCm5hbWU6IENvb2tpZQoKZGVzY3JpcHRpb246IENsYXNzIGZvciBjcmVhdGluZywgcmVhZGluZywgYW5kIGRlbGV0aW5nIGJyb3dzZXIgQ29va2llcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEJhc2VkIG9uIHRoZSBmdW5jdGlvbnMgYnkgUGV0ZXItUGF1bCBLb2NoIChodHRwOi8vcXVpcmtzbW9kZS5vcmcpLgoKcmVxdWlyZXM6IFtPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IENvb2tpZQoKLi4uCiovCgp2YXIgQ29va2llID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlwYXRoOiAnLycsCgkJZG9tYWluOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZSwKCQlkb2N1bWVudDogZG9jdW1lbnQsCgkJZW5jb2RlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGtleSwgb3B0aW9ucyl7CgkJdGhpcy5rZXkgPSBrZXk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCgl3cml0ZTogZnVuY3Rpb24odmFsdWUpewoJCWlmICh0aGlzLm9wdGlvbnMuZW5jb2RlKSB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJaWYgKHRoaXMub3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgdGhpcy5vcHRpb25zLmRvbWFpbjsKCQlpZiAodGhpcy5vcHRpb25zLnBhdGgpIHZhbHVlICs9ICc7IHBhdGg9JyArIHRoaXMub3B0aW9ucy5wYXRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pewoJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIDI0ICogNjAgKiA2MCAqIDEwMDApOwoJCQl2YWx1ZSArPSAnOyBleHBpcmVzPScgKyBkYXRlLnRvR01UU3RyaW5nKCk7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCXRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWFkOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUubWF0Y2goJyg/Ol58OylcXHMqJyArIHRoaXMua2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuICh2YWx1ZSkgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWVbMV0pIDogbnVsbDsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQluZXcgQ29va2llKHRoaXMua2V5LCBPYmplY3QubWVyZ2Uoe30sIHRoaXMub3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKS53cml0ZSgnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkNvb2tpZS53cml0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS53cml0ZSh2YWx1ZSk7Cn07CgpDb29raWUucmVhZCA9IGZ1bmN0aW9uKGtleSl7CglyZXR1cm4gbmV3IENvb2tpZShrZXkpLnJlYWQoKTsKfTsKCkNvb2tpZS5kaXNwb3NlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCXJldHVybiBuZXcgQ29va2llKGtleSwgb3B0aW9ucykuZGlzcG9zZSgpOwp9OwoKLyoKLS0tCgpuYW1lOiBET01SZWFkeQoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBjdXN0b20gZXZlbnQgZG9tcmVhZHkuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQnJvd3NlciwgRWxlbWVudCwgRWxlbWVudC5FdmVudF0KCnByb3ZpZGVzOiBbRE9NUmVhZHksIERvbVJlYWR5XQoKLi4uCiovCgooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCl7Cgp2YXIgcmVhZHksCglsb2FkZWQsCgljaGVja3MgPSBbXSwKCXNob3VsZFBvbGwsCgl0aW1lciwKCWlzRnJhbWVkID0gdHJ1ZTsKCi8vIFRoYW5rcyB0byBSaWNoIERvdWdoZXJ0eSA8aHR0cDovL3d3dy5yaWNoZG91Z2hlcnR5LmNvbS8+CnRyeSB7Cglpc0ZyYW1lZCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgIT0gbnVsbDsKfSBjYXRjaChlKXt9Cgp2YXIgZG9tcmVhZHkgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmIChyZWFkeSkgcmV0dXJuOwoJQnJvd3Nlci5sb2FkZWQgPSByZWFkeSA9IHRydWU7Cglkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KS5yZW1vdmVMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrKTsKCglkb2N1bWVudC5maXJlRXZlbnQoJ2RvbXJlYWR5Jyk7Cgl3aW5kb3cuZmlyZUV2ZW50KCdkb21yZWFkeScpOwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oKXsKCWZvciAodmFyIGkgPSBjaGVja3MubGVuZ3RoOyBpLS07KSBpZiAoY2hlY2tzW2ldKCkpewoJCWRvbXJlYWR5KCk7CgkJcmV0dXJuIHRydWU7Cgl9CgoJcmV0dXJuIGZhbHNlOwp9OwoKdmFyIHBvbGwgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmICghY2hlY2soKSkgdGltZXIgPSBzZXRUaW1lb3V0KHBvbGwsIDEwKTsKfTsKCmRvY3VtZW50LmFkZExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZG9tcmVhZHkpOwoKLy8gZG9TY3JvbGwgdGVjaG5pcXVlIGJ5IERpZWdvIFBlcmluaSBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwp2YXIgdGVzdEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKaWYgKHRlc3RFbGVtZW50LmRvU2Nyb2xsICYmICFpc0ZyYW1lZCl7CgljaGVja3MucHVzaChmdW5jdGlvbigpewoJCXRyeSB7CgkJCXRlc3RFbGVtZW50LmRvU2Nyb2xsKCk7CgkJCXJldHVybiB0cnVlOwoJCX0gY2F0Y2ggKGUpe30KCgkJcmV0dXJuIGZhbHNlOwoJfSk7CglzaG91bGRQb2xsID0gdHJ1ZTsKfQoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUpIGNoZWNrcy5wdXNoKGZ1bmN0aW9uKCl7Cgl2YXIgc3RhdGUgPSBkb2N1bWVudC5yZWFkeVN0YXRlOwoJcmV0dXJuIChzdGF0ZSA9PSAnbG9hZGVkJyB8fCBzdGF0ZSA9PSAnY29tcGxldGUnKTsKfSk7CgppZiAoJ29ucmVhZHlzdGF0ZWNoYW5nZScgaW4gZG9jdW1lbnQpIGRvY3VtZW50LmFkZExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgY2hlY2spOwplbHNlIHNob3VsZFBvbGwgPSB0cnVlOwoKaWYgKHNob3VsZFBvbGwpIHBvbGwoKTsKCkVsZW1lbnQuRXZlbnRzLmRvbXJlYWR5ID0gewoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAocmVhZHkpIGZuLmNhbGwodGhpcyk7Cgl9Cn07CgovLyBNYWtlIHN1cmUgdGhhdCBkb21yZWFkeSBmaXJlcyBiZWZvcmUgbG9hZApFbGVtZW50LkV2ZW50cy5sb2FkID0gewoJYmFzZTogJ2xvYWQnLAoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAobG9hZGVkICYmIHRoaXMgPT0gd2luZG93KSBmbi5jYWxsKHRoaXMpOwoJfSwKCWNvbmRpdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcyA9PSB3aW5kb3cpewoJCQlkb21yZWFkeSgpOwoJCQlkZWxldGUgRWxlbWVudC5FdmVudHMubG9hZDsKCQl9CgoJCXJldHVybiB0cnVlOwoJfQp9OwoKLy8gVGhpcyBpcyBiYXNlZCBvbiB0aGUgY3VzdG9tIGxvYWQgZXZlbnQKd2luZG93LmFkZEV2ZW50KCdsb2FkJywgZnVuY3Rpb24oKXsKCWxvYWRlZCA9IHRydWU7Cn0pOwoKfSkod2luZG93LCBkb2N1bWVudCk7CgovKgotLS0KCm5hbWU6IFN3aWZmCgpkZXNjcmlwdGlvbjogV3JhcHBlciBmb3IgZW1iZWRkaW5nIFNXRiBtb3ZpZXMuIFN1cHBvcnRzIEV4dGVybmFsIEludGVyZmFjZSBDb21tdW5pY2F0aW9uLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRmxhc2ggZGV0ZWN0aW9uICYgSW50ZXJuZXQgRXhwbG9yZXIgKyBGbGFzaCBQbGF5ZXIgOSBmaXggaW5zcGlyZWQgYnkgU1dGT2JqZWN0LgoKcmVxdWlyZXM6IFtPcHRpb25zLCBPYmplY3QsIEVsZW1lbnRdCgpwcm92aWRlczogU3dpZmYKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgU3dpZmYgPSB0aGlzLlN3aWZmID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlpZDogbnVsbCwKCQloZWlnaHQ6IDEsCgkJd2lkdGg6IDEsCgkJY29udGFpbmVyOiBudWxsLAoJCXByb3BlcnRpZXM6IHt9LAoJCXBhcmFtczogewoJCQlxdWFsaXR5OiAnaGlnaCcsCgkJCWFsbG93U2NyaXB0QWNjZXNzOiAnYWx3YXlzJywKCQkJd01vZGU6ICd3aW5kb3cnLAoJCQlzd0xpdmVDb25uZWN0OiB0cnVlCgkJfSwKCQljYWxsQmFja3M6IHt9LAoJCXZhcnM6IHt9Cgl9LAoKCXRvRWxlbWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vYmplY3Q7Cgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKHBhdGgsIG9wdGlvbnMpewoJCXRoaXMuaW5zdGFuY2UgPSAnU3dpZmZfJyArIFN0cmluZy51bmlxdWVJRCgpOwoKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCQl2YXIgaWQgPSB0aGlzLmlkID0gb3B0aW9ucy5pZCB8fCB0aGlzLmluc3RhbmNlOwoJCXZhciBjb250YWluZXIgPSBkb2N1bWVudC5pZChvcHRpb25zLmNvbnRhaW5lcik7CgoJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXSA9IHt9OwoKCQl2YXIgcGFyYW1zID0gb3B0aW9ucy5wYXJhbXMsIHZhcnMgPSBvcHRpb25zLnZhcnMsIGNhbGxCYWNrcyA9IG9wdGlvbnMuY2FsbEJhY2tzOwoJCXZhciBwcm9wZXJ0aWVzID0gT2JqZWN0LmFwcGVuZCh7aGVpZ2h0OiBvcHRpb25zLmhlaWdodCwgd2lkdGg6IG9wdGlvbnMud2lkdGh9LCBvcHRpb25zLnByb3BlcnRpZXMpOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWZvciAodmFyIGNhbGxCYWNrIGluIGNhbGxCYWNrcyl7CgkJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXVtjYWxsQmFja10gPSAoZnVuY3Rpb24ob3B0aW9uKXsKCQkJCXJldHVybiBmdW5jdGlvbigpewoJCQkJCXJldHVybiBvcHRpb24uYXBwbHkoc2VsZi5vYmplY3QsIGFyZ3VtZW50cyk7CgkJCQl9OwoJCQl9KShjYWxsQmFja3NbY2FsbEJhY2tdKTsKCQkJdmFyc1tjYWxsQmFja10gPSAnU3dpZmYuQ2FsbEJhY2tzLicgKyB0aGlzLmluc3RhbmNlICsgJy4nICsgY2FsbEJhY2s7CgkJfQoKCQlwYXJhbXMuZmxhc2hWYXJzID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFycyk7CgkJaWYgKEJyb3dzZXIuaWUpewoJCQlwcm9wZXJ0aWVzLmNsYXNzaWQgPSAnY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwJzsKCQkJcGFyYW1zLm1vdmllID0gcGF0aDsKCQl9IGVsc2UgewoJCQlwcm9wZXJ0aWVzLnR5cGUgPSAnYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2gnOwoJCX0KCQlwcm9wZXJ0aWVzLmRhdGEgPSBwYXRoOwoKCQl2YXIgYnVpbGQgPSAnPG9iamVjdCBpZD0iJyArIGlkICsgJyInOwoJCWZvciAodmFyIHByb3BlcnR5IGluIHByb3BlcnRpZXMpIGJ1aWxkICs9ICcgJyArIHByb3BlcnR5ICsgJz0iJyArIHByb3BlcnRpZXNbcHJvcGVydHldICsgJyInOwoJCWJ1aWxkICs9ICc+JzsKCQlmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpewoJCQlpZiAocGFyYW1zW3BhcmFtXSkgYnVpbGQgKz0gJzxwYXJhbSBuYW1lPSInICsgcGFyYW0gKyAnIiB2YWx1ZT0iJyArIHBhcmFtc1twYXJhbV0gKyAnIiAvPic7CgkJfQoJCWJ1aWxkICs9ICc8L29iamVjdD4nOwoJCXRoaXMub2JqZWN0ID0gKChjb250YWluZXIpID8gY29udGFpbmVyLmVtcHR5KCkgOiBuZXcgRWxlbWVudCgnZGl2JykpLnNldCgnaHRtbCcsIGJ1aWxkKS5maXJzdENoaWxkOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJZWxlbWVudCA9IGRvY3VtZW50LmlkKGVsZW1lbnQsIHRydWUpOwoJCWVsZW1lbnQucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy50b0VsZW1lbnQoKSwgZWxlbWVudCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWxlbWVudCl7CgkJZG9jdW1lbnQuaWQoZWxlbWVudCwgdHJ1ZSkuYXBwZW5kQ2hpbGQodGhpcy50b0VsZW1lbnQoKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW90ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3dpZmYucmVtb3RlLmFwcGx5KFN3aWZmLCBbdGhpcy50b0VsZW1lbnQoKV0uYXBwZW5kKGFyZ3VtZW50cykpOwoJfQoKfSk7CgpTd2lmZi5DYWxsQmFja3MgPSB7fTsKClN3aWZmLnJlbW90ZSA9IGZ1bmN0aW9uKG9iaiwgZm4pewoJdmFyIHJzID0gb2JqLkNhbGxGdW5jdGlvbignPGludm9rZSBuYW1lPSInICsgZm4gKyAnIiByZXR1cm50eXBlPSJqYXZhc2NyaXB0Ij4nICsgX19mbGFzaF9fYXJndW1lbnRzVG9YTUwoYXJndW1lbnRzLCAyKSArICc8L2ludm9rZT4nKTsKCXJldHVybiBldmFsKHJzKTsKfTsKCn0pLmNhbGwodGhpcyk7Cgo=",
                "body": "LyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzdjNTZjZmVmOWRkZGNmMTcwYTVkNjhlM2ZiNjFjZmQ3CgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi8qCi0tLQoKbmFtZTogQ29yZQoKZGVzY3JpcHRpb246IFRoZSBoZWFydCBvZiBNb29Ub29scy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY29weXJpZ2h0OiBDb3B5cmlnaHQgKGMpIDIwMDYtMjAxMCBbVmFsZXJpbyBQcm9pZXR0aV0oaHR0cDovL21hZDRtaWxrLm5ldC8pLgoKYXV0aG9yczogVGhlIE1vb1Rvb2xzIHByb2R1Y3Rpb24gdGVhbSAoaHR0cDovL21vb3Rvb2xzLm5ldC9kZXZlbG9wZXJzLykKCmluc3BpcmF0aW9uOgogIC0gQ2xhc3MgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0Jhc2UuanNdKGh0dHA6Ly9kZWFuLmVkd2FyZHMubmFtZS93ZWJsb2cvMjAwNi8wMy9iYXNlLykgQ29weXJpZ2h0IChjKSAyMDA2IERlYW4gRWR3YXJkcywgW0dOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2xncGwtbGljZW5zZS5waHApCiAgLSBTb21lIGZ1bmN0aW9uYWxpdHkgaW5zcGlyZWQgYnkgW1Byb3RvdHlwZS5qc10oaHR0cDovL3Byb3RvdHlwZWpzLm9yZykgQ29weXJpZ2h0IChjKSAyMDA1LTIwMDcgU2FtIFN0ZXBoZW5zb24sIFtNSVQgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCnByb3ZpZGVzOiBbQ29yZSwgTW9vVG9vbHMsIFR5cGUsIHR5cGVPZiwgaW5zdGFuY2VPZiwgTmF0aXZlXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnRoaXMuTW9vVG9vbHMgPSB7Cgl2ZXJzaW9uOiAnMS4zLjEnLAoJYnVpbGQ6ICdhZjQ4YzhkNTg5ZjQzZjMyMjEyZjliYjhmZjY4YTEyN2U2YTNiYTZjJwp9OwoKLy8gdHlwZU9mLCBpbnN0YW5jZU9mCgp2YXIgdHlwZU9mID0gdGhpcy50eXBlT2YgPSBmdW5jdGlvbihpdGVtKXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiAnbnVsbCc7CglpZiAoaXRlbS4kZmFtaWx5KSByZXR1cm4gaXRlbS4kZmFtaWx5KCk7CgoJaWYgKGl0ZW0ubm9kZU5hbWUpewoJCWlmIChpdGVtLm5vZGVUeXBlID09IDEpIHJldHVybiAnZWxlbWVudCc7CgkJaWYgKGl0ZW0ubm9kZVR5cGUgPT0gMykgcmV0dXJuICgvXFMvKS50ZXN0KGl0ZW0ubm9kZVZhbHVlKSA/ICd0ZXh0bm9kZScgOiAnd2hpdGVzcGFjZSc7Cgl9IGVsc2UgaWYgKHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyl7CgkJaWYgKGl0ZW0uY2FsbGVlKSByZXR1cm4gJ2FyZ3VtZW50cyc7CgkJaWYgKCdpdGVtJyBpbiBpdGVtKSByZXR1cm4gJ2NvbGxlY3Rpb24nOwoJfQoKCXJldHVybiB0eXBlb2YgaXRlbTsKfTsKCnZhciBpbnN0YW5jZU9mID0gdGhpcy5pbnN0YW5jZU9mID0gZnVuY3Rpb24oaXRlbSwgb2JqZWN0KXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiBmYWxzZTsKCXZhciBjb25zdHJ1Y3RvciA9IGl0ZW0uJGNvbnN0cnVjdG9yIHx8IGl0ZW0uY29uc3RydWN0b3I7Cgl3aGlsZSAoY29uc3RydWN0b3IpewoJCWlmIChjb25zdHJ1Y3RvciA9PT0gb2JqZWN0KSByZXR1cm4gdHJ1ZTsKCQljb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yLnBhcmVudDsKCX0KCXJldHVybiBpdGVtIGluc3RhbmNlb2Ygb2JqZWN0Owp9OwoKLy8gRnVuY3Rpb24gb3ZlcmxvYWRpbmcKCnZhciBGdW5jdGlvbiA9IHRoaXMuRnVuY3Rpb247Cgp2YXIgZW51bWVyYWJsZXMgPSB0cnVlOwpmb3IgKHZhciBpIGluIHt0b1N0cmluZzogMX0pIGVudW1lcmFibGVzID0gbnVsbDsKaWYgKGVudW1lcmFibGVzKSBlbnVtZXJhYmxlcyA9IFsnaGFzT3duUHJvcGVydHknLCAndmFsdWVPZicsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ2NvbnN0cnVjdG9yJ107CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRTZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewoJCWlmIChhID09IG51bGwpIHJldHVybiB0aGlzOwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpewoJCQlmb3IgKHZhciBrIGluIGEpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJaWYgKGVudW1lcmFibGVzKSBmb3IgKHZhciBpID0gZW51bWVyYWJsZXMubGVuZ3RoOyBpLS07KXsKCQkJCWsgPSBlbnVtZXJhYmxlc1tpXTsKCQkJCWlmIChhLmhhc093blByb3BlcnR5KGspKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCX0KCQl9IGVsc2UgewoJCQlzZWxmLmNhbGwodGhpcywgYSwgYik7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZEdldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSl7CgkJdmFyIGFyZ3MsIHJlc3VsdDsKCQlpZiAodXNlUGx1cmFsIHx8IHR5cGVvZiBhICE9ICdzdHJpbmcnKSBhcmdzID0gYTsKCQllbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgYXJncyA9IGFyZ3VtZW50czsKCQlpZiAoYXJncyl7CgkJCXJlc3VsdCA9IHt9OwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHJlc3VsdFthcmdzW2ldXSA9IHNlbGYuY2FsbCh0aGlzLCBhcmdzW2ldKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSBzZWxmLmNhbGwodGhpcywgYSk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpc1trZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXMucHJvdG90eXBlW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKLy8gRnJvbQoKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKRnVuY3Rpb24uZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gJ2Z1bmN0aW9uJykgPyBpdGVtIDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gaXRlbTsKCX07Cn07CgpBcnJheS5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gW107CglyZXR1cm4gKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pICYmIHR5cGVvZiBpdGVtICE9ICdzdHJpbmcnKSA/ICh0eXBlT2YoaXRlbSkgPT0gJ2FycmF5JykgPyBpdGVtIDogc2xpY2UuY2FsbChpdGVtKSA6IFtpdGVtXTsKfTsKCk51bWJlci5mcm9tID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgbnVtYmVyID0gcGFyc2VGbG9hdChpdGVtKTsKCXJldHVybiBpc0Zpbml0ZShudW1iZXIpID8gbnVtYmVyIDogbnVsbDsKfTsKClN0cmluZy5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbSArICcnOwp9OwoKLy8gaGlkZSwgcHJvdGVjdAoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgloaWRlOiBmdW5jdGlvbigpewoJCXRoaXMuJGhpZGRlbiA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByb3RlY3Q6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kcHJvdGVjdGVkID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gVHlwZQoKdmFyIFR5cGUgPSB0aGlzLlR5cGUgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QpewoJaWYgKG5hbWUpewoJCXZhciBsb3dlciA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQl2YXIgdHlwZUNoZWNrID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiAodHlwZU9mKGl0ZW0pID09IGxvd2VyKTsKCQl9OwoKCQlUeXBlWydpcycgKyBuYW1lXSA9IHR5cGVDaGVjazsKCQlpZiAob2JqZWN0ICE9IG51bGwpewoJCQlvYmplY3QucHJvdG90eXBlLiRmYW1pbHkgPSAoZnVuY3Rpb24oKXsKCQkJCXJldHVybiBsb3dlcjsKCQkJfSkuaGlkZSgpOwoKCQl9Cgl9CgoJaWYgKG9iamVjdCA9PSBudWxsKSByZXR1cm4gbnVsbDsKCglvYmplY3QuZXh0ZW5kKHRoaXMpOwoJb2JqZWN0LiRjb25zdHJ1Y3RvciA9IFR5cGU7CglvYmplY3QucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG9iamVjdDsKCglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKClR5cGUuaXNFbnVtZXJhYmxlID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gKGl0ZW0gIT0gbnVsbCAmJiB0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicgJiYgdG9TdHJpbmcuY2FsbChpdGVtKSAhPSAnW29iamVjdCBGdW5jdGlvbl0nICk7Cn07Cgp2YXIgaG9va3MgPSB7fTsKCnZhciBob29rc09mID0gZnVuY3Rpb24ob2JqZWN0KXsKCXZhciB0eXBlID0gdHlwZU9mKG9iamVjdC5wcm90b3R5cGUpOwoJcmV0dXJuIGhvb2tzW3R5cGVdIHx8IChob29rc1t0eXBlXSA9IFtdKTsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuOwoKCXZhciBob29rcyA9IGhvb2tzT2YodGhpcyk7CgoJZm9yICh2YXIgaSA9IDA7IGkgPCBob29rcy5sZW5ndGg7IGkrKyl7CgkJdmFyIGhvb2sgPSBob29rc1tpXTsKCQlpZiAodHlwZU9mKGhvb2spID09ICd0eXBlJykgaW1wbGVtZW50LmNhbGwoaG9vaywgbmFtZSwgbWV0aG9kKTsKCQllbHNlIGhvb2suY2FsbCh0aGlzLCBuYW1lLCBtZXRob2QpOwoJfQoKCXZhciBwcmV2aW91cyA9IHRoaXMucHJvdG90eXBlW25hbWVdOwoJaWYgKHByZXZpb3VzID09IG51bGwgfHwgIXByZXZpb3VzLiRwcm90ZWN0ZWQpIHRoaXMucHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoKCWlmICh0aGlzW25hbWVdID09IG51bGwgJiYgdHlwZU9mKG1ldGhvZCkgPT0gJ2Z1bmN0aW9uJykgZXh0ZW5kLmNhbGwodGhpcywgbmFtZSwgZnVuY3Rpb24oaXRlbSl7CgkJcmV0dXJuIG1ldGhvZC5hcHBseShpdGVtLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJfSk7Cn07Cgp2YXIgZXh0ZW5kID0gZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWlmIChtZXRob2QgJiYgbWV0aG9kLiRoaWRkZW4pIHJldHVybjsKCXZhciBwcmV2aW91cyA9IHRoaXNbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpc1tuYW1lXSA9IG1ldGhvZDsKfTsKClR5cGUuaW1wbGVtZW50KHsKCglpbXBsZW1lbnQ6IGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpLAoKCWV4dGVuZDogZXh0ZW5kLm92ZXJsb2FkU2V0dGVyKCksCgoJYWxpYXM6IGZ1bmN0aW9uKG5hbWUsIGV4aXN0aW5nKXsKCQlpbXBsZW1lbnQuY2FsbCh0aGlzLCBuYW1lLCB0aGlzLnByb3RvdHlwZVtleGlzdGluZ10pOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCW1pcnJvcjogZnVuY3Rpb24oaG9vayl7CgkJaG9va3NPZih0aGlzKS5wdXNoKGhvb2spOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpuZXcgVHlwZSgnVHlwZScsIFR5cGUpOwoKLy8gRGVmYXVsdCBUeXBlcwoKdmFyIGZvcmNlID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0LCBtZXRob2RzKXsKCXZhciBpc1R5cGUgPSAob2JqZWN0ICE9IE9iamVjdCksCgkJcHJvdG90eXBlID0gb2JqZWN0LnByb3RvdHlwZTsKCglpZiAoaXNUeXBlKSBvYmplY3QgPSBuZXcgVHlwZShuYW1lLCBvYmplY3QpOwoKCWZvciAodmFyIGkgPSAwLCBsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCXZhciBrZXkgPSBtZXRob2RzW2ldLAoJCQlnZW5lcmljID0gb2JqZWN0W2tleV0sCgkJCXByb3RvID0gcHJvdG90eXBlW2tleV07CgoJCWlmIChnZW5lcmljKSBnZW5lcmljLnByb3RlY3QoKTsKCgkJaWYgKGlzVHlwZSAmJiBwcm90byl7CgkJCWRlbGV0ZSBwcm90b3R5cGVba2V5XTsKCQkJcHJvdG90eXBlW2tleV0gPSBwcm90by5wcm90ZWN0KCk7CgkJfQoJfQoKCWlmIChpc1R5cGUpIG9iamVjdC5pbXBsZW1lbnQocHJvdG90eXBlKTsKCglyZXR1cm4gZm9yY2U7Cn07Cgpmb3JjZSgnU3RyaW5nJywgU3RyaW5nLCBbCgknY2hhckF0JywgJ2NoYXJDb2RlQXQnLCAnY29uY2F0JywgJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAnbWF0Y2gnLCAncXVvdGUnLCAncmVwbGFjZScsICdzZWFyY2gnLAoJJ3NsaWNlJywgJ3NwbGl0JywgJ3N1YnN0cicsICdzdWJzdHJpbmcnLCAndG9Mb3dlckNhc2UnLCAndG9VcHBlckNhc2UnCl0pKCdBcnJheScsIEFycmF5LCBbCgkncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJywKCSdpbmRleE9mJywgJ2xhc3RJbmRleE9mJywgJ2ZpbHRlcicsICdmb3JFYWNoJywgJ2V2ZXJ5JywgJ21hcCcsICdzb21lJywgJ3JlZHVjZScsICdyZWR1Y2VSaWdodCcKXSkoJ051bWJlcicsIE51bWJlciwgWwoJJ3RvRXhwb25lbnRpYWwnLCAndG9GaXhlZCcsICd0b0xvY2FsZVN0cmluZycsICd0b1ByZWNpc2lvbicKXSkoJ0Z1bmN0aW9uJywgRnVuY3Rpb24sIFsKCSdhcHBseScsICdjYWxsJywgJ2JpbmQnCl0pKCdSZWdFeHAnLCBSZWdFeHAsIFsKCSdleGVjJywgJ3Rlc3QnCl0pKCdPYmplY3QnLCBPYmplY3QsIFsKCSdjcmVhdGUnLCAnZGVmaW5lUHJvcGVydHknLCAnZGVmaW5lUHJvcGVydGllcycsICdrZXlzJywKCSdnZXRQcm90b3R5cGVPZicsICdnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3InLCAnZ2V0T3duUHJvcGVydHlOYW1lcycsCgkncHJldmVudEV4dGVuc2lvbnMnLCAnaXNFeHRlbnNpYmxlJywgJ3NlYWwnLCAnaXNTZWFsZWQnLCAnZnJlZXplJywgJ2lzRnJvemVuJwpdKSgnRGF0ZScsIERhdGUsIFsnbm93J10pOwoKT2JqZWN0LmV4dGVuZCA9IGV4dGVuZC5vdmVybG9hZFNldHRlcigpOwoKRGF0ZS5leHRlbmQoJ25vdycsIGZ1bmN0aW9uKCl7CglyZXR1cm4gKyhuZXcgRGF0ZSk7Cn0pOwoKbmV3IFR5cGUoJ0Jvb2xlYW4nLCBCb29sZWFuKTsKCi8vIGZpeGVzIE5hTiByZXR1cm5pbmcgYXMgTnVtYmVyCgpOdW1iZXIucHJvdG90eXBlLiRmYW1pbHkgPSBmdW5jdGlvbigpewoJcmV0dXJuIGlzRmluaXRlKHRoaXMpID8gJ251bWJlcicgOiAnbnVsbCc7Cn0uaGlkZSgpOwoKLy8gTnVtYmVyLnJhbmRvbQoKTnVtYmVyLmV4dGVuZCgncmFuZG9tJywgZnVuY3Rpb24obWluLCBtYXgpewoJcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSArIG1pbik7Cn0pOwoKLy8gZm9yRWFjaCwgZWFjaAoKdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKT2JqZWN0LmV4dGVuZCgnZm9yRWFjaCcsIGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSBmbi5jYWxsKGJpbmQsIG9iamVjdFtrZXldLCBrZXksIG9iamVjdCk7Cgl9Cn0pOwoKT2JqZWN0LmVhY2ggPSBPYmplY3QuZm9yRWFjaDsKCkFycmF5LmltcGxlbWVudCh7CgoJZm9yRWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJCX0KCX0sCgoJZWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCUFycmF5LmZvckVhY2godGhpcywgZm4sIGJpbmQpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBBcnJheSAmIE9iamVjdCBjbG9uaW5nLCBPYmplY3QgbWVyZ2luZyBhbmQgYXBwZW5kaW5nCgp2YXIgY2xvbmVPZiA9IGZ1bmN0aW9uKGl0ZW0pewoJc3dpdGNoICh0eXBlT2YoaXRlbSkpewoJCWNhc2UgJ2FycmF5JzogcmV0dXJuIGl0ZW0uY2xvbmUoKTsKCQljYXNlICdvYmplY3QnOiByZXR1cm4gT2JqZWN0LmNsb25lKGl0ZW0pOwoJCWRlZmF1bHQ6IHJldHVybiBpdGVtOwoJfQp9OwoKQXJyYXkuaW1wbGVtZW50KCdjbG9uZScsIGZ1bmN0aW9uKCl7Cgl2YXIgaSA9IHRoaXMubGVuZ3RoLCBjbG9uZSA9IG5ldyBBcnJheShpKTsKCXdoaWxlIChpLS0pIGNsb25lW2ldID0gY2xvbmVPZih0aGlzW2ldKTsKCXJldHVybiBjbG9uZTsKfSk7Cgp2YXIgbWVyZ2VPbmUgPSBmdW5jdGlvbihzb3VyY2UsIGtleSwgY3VycmVudCl7Cglzd2l0Y2ggKHR5cGVPZihjdXJyZW50KSl7CgkJY2FzZSAnb2JqZWN0JzoKCQkJaWYgKHR5cGVPZihzb3VyY2Vba2V5XSkgPT0gJ29iamVjdCcpIE9iamVjdC5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CgkJCWVsc2Ugc291cmNlW2tleV0gPSBPYmplY3QuY2xvbmUoY3VycmVudCk7CgkJYnJlYWs7CgkJY2FzZSAnYXJyYXknOiBzb3VyY2Vba2V5XSA9IGN1cnJlbnQuY2xvbmUoKTsgYnJlYWs7CgkJZGVmYXVsdDogc291cmNlW2tleV0gPSBjdXJyZW50OwoJfQoJcmV0dXJuIHNvdXJjZTsKfTsKCk9iamVjdC5leHRlbmQoewoKCW1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewoJCWlmICh0eXBlT2YoaykgPT0gJ3N0cmluZycpIHJldHVybiBtZXJnZU9uZShzb3VyY2UsIGssIHYpOwoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBvYmplY3QgPSBhcmd1bWVudHNbaV07CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiBzb3VyY2U7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciBjbG9uZSA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIGNsb25lW2tleV0gPSBjbG9uZU9mKG9iamVjdFtrZXldKTsKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWFwcGVuZDogZnVuY3Rpb24ob3JpZ2luYWwpewoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBleHRlbmRlZCA9IGFyZ3VtZW50c1tpXSB8fCB7fTsKCQkJZm9yICh2YXIga2V5IGluIGV4dGVuZGVkKSBvcmlnaW5hbFtrZXldID0gZXh0ZW5kZWRba2V5XTsKCQl9CgkJcmV0dXJuIG9yaWdpbmFsOwoJfQoKfSk7CgovLyBPYmplY3QtbGVzcyB0eXBlcwoKWydPYmplY3QnLCAnV2hpdGVTcGFjZScsICdUZXh0Tm9kZScsICdDb2xsZWN0aW9uJywgJ0FyZ3VtZW50cyddLmVhY2goZnVuY3Rpb24obmFtZSl7CgluZXcgVHlwZShuYW1lKTsKfSk7CgovLyBVbmlxdWUgSUQKCnZhciBVSUQgPSBEYXRlLm5vdygpOwoKU3RyaW5nLmV4dGVuZCgndW5pcXVlSUQnLCBmdW5jdGlvbigpewoJcmV0dXJuIChVSUQrKykudG9TdHJpbmcoMzYpOwp9KTsKCn0pLmNhbGwodGhpcyk7CgovKgotLS0KCm5hbWU6IEFycmF5CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgQXJyYXkgUHJvdG90eXBlcyBsaWtlIGVhY2gsIGNvbnRhaW5zLCBhbmQgZXJhc2UuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogQXJyYXkKCi4uLgoqLwoKQXJyYXkuaW1wbGVtZW50KHsKCglpbnZva2U6IGZ1bmN0aW9uKG1ldGhvZE5hbWUpewoJCXZhciBhcmdzID0gQXJyYXkuc2xpY2UoYXJndW1lbnRzLCAxKTsKCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtW21ldGhvZE5hbWVdLmFwcGx5KGl0ZW0sIGFyZ3MpOwoJCX0pOwoJfSwKCglldmVyeTogZnVuY3Rpb24oZm4sIGJpbmQpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoKGkgaW4gdGhpcykgJiYgIWZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXZhciByZXN1bHRzID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmICgoaSBpbiB0aGlzKSAmJiBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXN1bHRzLnB1c2godGhpc1tpXSk7CgkJfQoJCXJldHVybiByZXN1bHRzOwoJfSwKCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtICE9IG51bGw7CgkJfSk7Cgl9LAoKCWluZGV4T2Y6IGZ1bmN0aW9uKGl0ZW0sIGZyb20pewoJCXZhciBsZW4gPSB0aGlzLmxlbmd0aDsKCQlmb3IgKHZhciBpID0gKGZyb20gPCAwKSA/IE1hdGgubWF4KDAsIGxlbiArIGZyb20pIDogZnJvbSB8fCAwOyBpIDwgbGVuOyBpKyspewoJCQlpZiAodGhpc1tpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CgkJfQoJCXJldHVybiAtMTsKCX0sCgoJbWFwOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKGkgaW4gdGhpcykgcmVzdWx0c1tpXSA9IGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcyk7CgkJfQoJCXJldHVybiByZXN1bHRzOwoJfSwKCglzb21lOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmICgoaSBpbiB0aGlzKSAmJiBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gdHJ1ZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglhc3NvY2lhdGU6IGZ1bmN0aW9uKGtleXMpewoJCXZhciBvYmogPSB7fSwgbGVuZ3RoID0gTWF0aC5taW4odGhpcy5sZW5ndGgsIGtleXMubGVuZ3RoKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSBvYmpba2V5c1tpXV0gPSB0aGlzW2ldOwoJCXJldHVybiBvYmo7Cgl9LAoKCWxpbms6IGZ1bmN0aW9uKG9iamVjdCl7CgkJdmFyIHJlc3VsdCA9IHt9OwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJCWlmIChvYmplY3Rba2V5XSh0aGlzW2ldKSl7CgkJCQkJcmVzdWx0W2tleV0gPSB0aGlzW2ldOwoJCQkJCWRlbGV0ZSBvYmplY3Rba2V5XTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgljb250YWluczogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJcmV0dXJuIHRoaXMuaW5kZXhPZihpdGVtLCBmcm9tKSAhPSAtMTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbihhcnJheSl7CgkJdGhpcy5wdXNoLmFwcGx5KHRoaXMsIGFycmF5KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMubGVuZ3RoKSA/IHRoaXNbdGhpcy5sZW5ndGggLSAxXSA6IG51bGw7Cgl9LAoKCWdldFJhbmRvbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMubGVuZ3RoKSA/IHRoaXNbTnVtYmVyLnJhbmRvbSgwLCB0aGlzLmxlbmd0aCAtIDEpXSA6IG51bGw7Cgl9LAoKCWluY2x1ZGU6IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICghdGhpcy5jb250YWlucyhpdGVtKSkgdGhpcy5wdXNoKGl0ZW0pOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21iaW5lOiBmdW5jdGlvbihhcnJheSl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpKyspIHRoaXMuaW5jbHVkZShhcnJheVtpXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVyYXNlOiBmdW5jdGlvbihpdGVtKXsKCQlmb3IgKHZhciBpID0gdGhpcy5sZW5ndGg7IGktLTspewoJCQlpZiAodGhpc1tpXSA9PT0gaXRlbSkgdGhpcy5zcGxpY2UoaSwgMSk7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQl0aGlzLmxlbmd0aCA9IDA7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZsYXR0ZW46IGZ1bmN0aW9uKCl7CgkJdmFyIGFycmF5ID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciB0eXBlID0gdHlwZU9mKHRoaXNbaV0pOwoJCQlpZiAodHlwZSA9PSAnbnVsbCcpIGNvbnRpbnVlOwoJCQlhcnJheSA9IGFycmF5LmNvbmNhdCgodHlwZSA9PSAnYXJyYXknIHx8IHR5cGUgPT0gJ2NvbGxlY3Rpb24nIHx8IHR5cGUgPT0gJ2FyZ3VtZW50cycgfHwgaW5zdGFuY2VPZih0aGlzW2ldLCBBcnJheSkpID8gQXJyYXkuZmxhdHRlbih0aGlzW2ldKSA6IHRoaXNbaV0pOwoJCX0KCQlyZXR1cm4gYXJyYXk7Cgl9LAoKCXBpY2s6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmICh0aGlzW2ldICE9IG51bGwpIHJldHVybiB0aGlzW2ldOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgoJaGV4VG9SZ2I6IGZ1bmN0aW9uKGFycmF5KXsKCQlpZiAodGhpcy5sZW5ndGggIT0gMykgcmV0dXJuIG51bGw7CgkJdmFyIHJnYiA9IHRoaXMubWFwKGZ1bmN0aW9uKHZhbHVlKXsKCQkJaWYgKHZhbHVlLmxlbmd0aCA9PSAxKSB2YWx1ZSArPSB2YWx1ZTsKCQkJcmV0dXJuIHZhbHVlLnRvSW50KDE2KTsKCQl9KTsKCQlyZXR1cm4gKGFycmF5KSA/IHJnYiA6ICdyZ2IoJyArIHJnYiArICcpJzsKCX0sCgoJcmdiVG9IZXg6IGZ1bmN0aW9uKGFycmF5KXsKCQlpZiAodGhpcy5sZW5ndGggPCAzKSByZXR1cm4gbnVsbDsKCQlpZiAodGhpcy5sZW5ndGggPT0gNCAmJiB0aGlzWzNdID09IDAgJiYgIWFycmF5KSByZXR1cm4gJ3RyYW5zcGFyZW50JzsKCQl2YXIgaGV4ID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCAzOyBpKyspewoJCQl2YXIgYml0ID0gKHRoaXNbaV0gLSAwKS50b1N0cmluZygxNik7CgkJCWhleC5wdXNoKChiaXQubGVuZ3RoID09IDEpID8gJzAnICsgYml0IDogYml0KTsKCQl9CgkJcmV0dXJuIChhcnJheSkgPyBoZXggOiAnIycgKyBoZXguam9pbignJyk7Cgl9Cgp9KTsKCi8qCi0tLQoKbmFtZTogU3RyaW5nCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgU3RyaW5nIFByb3RvdHlwZXMgbGlrZSBjYW1lbENhc2UsIGNhcGl0YWxpemUsIHRlc3QsIGFuZCB0b0ludC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBTdHJpbmcKCi4uLgoqLwoKU3RyaW5nLmltcGxlbWVudCh7CgoJdGVzdDogZnVuY3Rpb24ocmVnZXgsIHBhcmFtcyl7CgkJcmV0dXJuICgodHlwZU9mKHJlZ2V4KSA9PSAncmVnZXhwJykgPyByZWdleCA6IG5ldyBSZWdFeHAoJycgKyByZWdleCwgcGFyYW1zKSkudGVzdCh0aGlzKTsKCX0sCgoJY29udGFpbnM6IGZ1bmN0aW9uKHN0cmluZywgc2VwYXJhdG9yKXsKCQlyZXR1cm4gKHNlcGFyYXRvcikgPyAoc2VwYXJhdG9yICsgdGhpcyArIHNlcGFyYXRvcikuaW5kZXhPZihzZXBhcmF0b3IgKyBzdHJpbmcgKyBzZXBhcmF0b3IpID4gLTEgOiB0aGlzLmluZGV4T2Yoc3RyaW5nKSA+IC0xOwoJfSwKCgl0cmltOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoL1xzKy9nLCAnICcpLnRyaW0oKTsKCX0sCgoJY2FtZWxDYXNlOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoLy1cRC9nLCBmdW5jdGlvbihtYXRjaCl7CgkJCXJldHVybiBtYXRjaC5jaGFyQXQoMSkudG9VcHBlckNhc2UoKTsKCQl9KTsKCX0sCgoJaHlwaGVuYXRlOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuICgnLScgKyBtYXRjaC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSk7CgkJfSk7Cgl9LAoKCWNhcGl0YWxpemU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXGJbYS16XS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJCXJldHVybiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCX0pOwoJfSwKCgllc2NhcGVSZWdFeHA6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvKFstLiorP14ke30oKXxbXF1cL1xcXSkvZywgJ1xcJDEnKTsKCX0sCgoJdG9JbnQ6IGZ1bmN0aW9uKGJhc2UpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCBiYXNlIHx8IDEwKTsKCX0sCgoJdG9GbG9hdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh0aGlzKTsKCX0sCgoJaGV4VG9SZ2I6IGZ1bmN0aW9uKGFycmF5KXsKCQl2YXIgaGV4ID0gdGhpcy5tYXRjaCgvXiM/KFx3ezEsMn0pKFx3ezEsMn0pKFx3ezEsMn0pJC8pOwoJCXJldHVybiAoaGV4KSA/IGhleC5zbGljZSgxKS5oZXhUb1JnYihhcnJheSkgOiBudWxsOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCXZhciByZ2IgPSB0aGlzLm1hdGNoKC9cZHsxLDN9L2cpOwoJCXJldHVybiAocmdiKSA/IHJnYi5yZ2JUb0hleChhcnJheSkgOiBudWxsOwoJfSwKCglzdWJzdGl0dXRlOiBmdW5jdGlvbihvYmplY3QsIHJlZ2V4cCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZShyZWdleHAgfHwgKC9cXD9ceyhbXnt9XSspXH0vZyksIGZ1bmN0aW9uKG1hdGNoLCBuYW1lKXsKCQkJaWYgKG1hdGNoLmNoYXJBdCgwKSA9PSAnXFwnKSByZXR1cm4gbWF0Y2guc2xpY2UoMSk7CgkJCXJldHVybiAob2JqZWN0W25hbWVdICE9IG51bGwpID8gb2JqZWN0W25hbWVdIDogJyc7CgkJfSk7Cgl9Cgp9KTsKCi8qCi0tLQoKbmFtZTogTnVtYmVyCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgTnVtYmVyIFByb3RvdHlwZXMgbGlrZSBsaW1pdCwgcm91bmQsIHRpbWVzLCBhbmQgY2VpbC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBOdW1iZXIKCi4uLgoqLwoKTnVtYmVyLmltcGxlbWVudCh7CgoJbGltaXQ6IGZ1bmN0aW9uKG1pbiwgbWF4KXsKCQlyZXR1cm4gTWF0aC5taW4obWF4LCBNYXRoLm1heChtaW4sIHRoaXMpKTsKCX0sCgoJcm91bmQ6IGZ1bmN0aW9uKHByZWNpc2lvbil7CgkJcHJlY2lzaW9uID0gTWF0aC5wb3coMTAsIHByZWNpc2lvbiB8fCAwKS50b0ZpeGVkKHByZWNpc2lvbiA8IDAgPyAtcHJlY2lzaW9uIDogMCk7CgkJcmV0dXJuIE1hdGgucm91bmQodGhpcyAqIHByZWNpc2lvbikgLyBwcmVjaXNpb247Cgl9LAoKCXRpbWVzOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzOyBpKyspIGZuLmNhbGwoYmluZCwgaSwgdGhpcyk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9Cgp9KTsKCk51bWJlci5hbGlhcygnZWFjaCcsICd0aW1lcycpOwoKKGZ1bmN0aW9uKG1hdGgpewoJdmFyIG1ldGhvZHMgPSB7fTsKCW1hdGguZWFjaChmdW5jdGlvbihuYW1lKXsKCQlpZiAoIU51bWJlcltuYW1lXSkgbWV0aG9kc1tuYW1lXSA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBNYXRoW25hbWVdLmFwcGx5KG51bGwsIFt0aGlzXS5jb25jYXQoQXJyYXkuZnJvbShhcmd1bWVudHMpKSk7CgkJfTsKCX0pOwoJTnVtYmVyLmltcGxlbWVudChtZXRob2RzKTsKfSkoWydhYnMnLCAnYWNvcycsICdhc2luJywgJ2F0YW4nLCAnYXRhbjInLCAnY2VpbCcsICdjb3MnLCAnZXhwJywgJ2Zsb29yJywgJ2xvZycsICdtYXgnLCAnbWluJywgJ3BvdycsICdzaW4nLCAnc3FydCcsICd0YW4nXSk7CgovKgotLS0KCm5hbWU6IEZ1bmN0aW9uCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRnVuY3Rpb24gUHJvdG90eXBlcyBsaWtlIGNyZWF0ZSwgYmluZCwgcGFzcywgYW5kIGRlbGF5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEZ1bmN0aW9uCgouLi4KKi8KCkZ1bmN0aW9uLmV4dGVuZCh7CgoJYXR0ZW1wdDogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl0cnkgewoJCQkJcmV0dXJuIGFyZ3VtZW50c1tpXSgpOwoJCQl9IGNhdGNoIChlKXt9CgkJfQoJCXJldHVybiBudWxsOwoJfQoKfSk7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLmFwcGx5KGJpbmQsIEFycmF5LmZyb20oYXJncykpOwoJCX0gY2F0Y2ggKGUpe30KCgkJcmV0dXJuIG51bGw7Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKGJpbmQpewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJncyA9IChhcmd1bWVudHMubGVuZ3RoID4gMSkgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbDsKCgkJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJCWlmICghYXJncyAmJiAhYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIHNlbGYuY2FsbChiaW5kKTsKCQkJaWYgKGFyZ3MgJiYgYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncy5jb25jYXQoQXJyYXkuZnJvbShhcmd1bWVudHMpKSk7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIGFyZ3MgfHwgYXJndW1lbnRzKTsKCQl9OwoJfSwKCglwYXNzOiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJaWYgKGFyZ3MgIT0gbnVsbCkgYXJncyA9IEFycmF5LmZyb20oYXJncyk7CgkJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIGFyZ3MgfHwgYXJndW1lbnRzKTsKCQl9OwoJfSwKCglkZWxheTogZnVuY3Rpb24oZGVsYXksIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRUaW1lb3V0KHRoaXMucGFzcygoYXJncyA9PSBudWxsID8gW10gOiBhcmdzKSwgYmluZCksIGRlbGF5KTsKCX0sCgoJcGVyaW9kaWNhbDogZnVuY3Rpb24ocGVyaW9kaWNhbCwgYmluZCwgYXJncyl7CgkJcmV0dXJuIHNldEludGVydmFsKHRoaXMucGFzcygoYXJncyA9PSBudWxsID8gW10gOiBhcmdzKSwgYmluZCksIHBlcmlvZGljYWwpOwoJfQoKfSk7CgovKgotLS0KCm5hbWU6IE9iamVjdAoKZGVzY3JpcHRpb246IE9iamVjdCBnZW5lcmljIG1ldGhvZHMKCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBbT2JqZWN0LCBIYXNoXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgpPYmplY3QuZXh0ZW5kKHsKCglzdWJzZXQ6IGZ1bmN0aW9uKG9iamVjdCwga2V5cyl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGsgPSBrZXlzW2ldOwoJCQlyZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlPYmplY3QuZWFjaChvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQlpZiAoZm4uY2FsbChiaW5kLCB2YWx1ZSwga2V5LCBvYmplY3QpKSByZXN1bHRzW2tleV0gPSB2YWx1ZTsKCQl9KTsKCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKfSkoKTsKCi8qCi0tLQoKbmFtZTogQnJvd3NlcgoKZGVzY3JpcHRpb246IFRoZSBCcm93c2VyIE9iamVjdC4gQ29udGFpbnMgQnJvd3NlciBpbml0aWFsaXphdGlvbiwgV2luZG93IGFuZCBEb2N1bWVudCwgYW5kIHRoZSBCcm93c2VyIEhhc2guCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIEZ1bmN0aW9uLCBOdW1iZXIsIFN0cmluZ10KCnByb3ZpZGVzOiBbQnJvd3NlciwgV2luZG93LCBEb2N1bWVudF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50Owp2YXIgd2luZG93ID0gZG9jdW1lbnQud2luZG93ID0gdGhpczsKCnZhciBVSUQgPSAxOwoKdGhpcy4kdWlkID0gKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSA/IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIChpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBbVUlEKytdKSlbMF07Cn0gOiBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBVSUQrKyk7Cn07CgokdWlkKHdpbmRvdyk7CiR1aWQoZG9jdW1lbnQpOwoKdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLAoJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0udG9Mb3dlckNhc2UoKSwKCVVBID0gdWEubWF0Y2goLyhvcGVyYXxpZXxmaXJlZm94fGNocm9tZXx2ZXJzaW9uKVtcc1wvOl0oW1x3XGRcLl0rKT8uKj8oc2FmYXJpfHZlcnNpb25bXHNcLzpdKFtcd1xkXC5dKyl8JCkvKSB8fCBbbnVsbCwgJ3Vua25vd24nLCAwXSwKCW1vZGUgPSBVQVsxXSA9PSAnaWUnICYmIGRvY3VtZW50LmRvY3VtZW50TW9kZTsKCnZhciBCcm93c2VyID0gdGhpcy5Ccm93c2VyID0gewoKCWV4dGVuZDogRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCwKCgluYW1lOiAoVUFbMV0gPT0gJ3ZlcnNpb24nKSA/IFVBWzNdIDogVUFbMV0sCgoJdmVyc2lvbjogbW9kZSB8fCBwYXJzZUZsb2F0KChVQVsxXSA9PSAnb3BlcmEnICYmIFVBWzRdKSA/IFVBWzRdIDogVUFbMl0pLAoKCVBsYXRmb3JtOiB7CgkJbmFtZTogdWEubWF0Y2goL2lwKD86YWR8b2R8aG9uZSkvKSA/ICdpb3MnIDogKHVhLm1hdGNoKC8oPzp3ZWJvc3xhbmRyb2lkKS8pIHx8IHBsYXRmb3JtLm1hdGNoKC9tYWN8d2lufGxpbnV4LykgfHwgWydvdGhlciddKVswXQoJfSwKCglGZWF0dXJlczogewoJCXhwYXRoOiAhIShkb2N1bWVudC5ldmFsdWF0ZSksCgkJYWlyOiAhISh3aW5kb3cucnVudGltZSksCgkJcXVlcnk6ICEhKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IpLAoJCWpzb246ICEhKHdpbmRvdy5KU09OKQoJfSwKCglQbHVnaW5zOiB7fQoKfTsKCkJyb3dzZXJbQnJvd3Nlci5uYW1lXSA9IHRydWU7CkJyb3dzZXJbQnJvd3Nlci5uYW1lICsgcGFyc2VJbnQoQnJvd3Nlci52ZXJzaW9uLCAxMCldID0gdHJ1ZTsKQnJvd3Nlci5QbGF0Zm9ybVtCcm93c2VyLlBsYXRmb3JtLm5hbWVdID0gdHJ1ZTsKCi8vIFJlcXVlc3QKCkJyb3dzZXIuUmVxdWVzdCA9IChmdW5jdGlvbigpewoKCXZhciBYTUxIVFRQID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7Cgl9OwoKCXZhciBNU1hNTDIgPSBmdW5jdGlvbigpewoJCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTVNYTUwyLlhNTEhUVFAnKTsKCX07CgoJdmFyIE1TWE1MID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01pY3Jvc29mdC5YTUxIVFRQJyk7Cgl9OwoKCXJldHVybiBGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJWE1MSFRUUCgpOwoJCXJldHVybiBYTUxIVFRQOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTDIoKTsKCQlyZXR1cm4gTVNYTUwyOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTCgpOwoJCXJldHVybiBNU1hNTDsKCX0pOwoKfSkoKTsKCkJyb3dzZXIuRmVhdHVyZXMueGhyID0gISEoQnJvd3Nlci5SZXF1ZXN0KTsKCi8vIEZsYXNoIGRldGVjdGlvbgoKdmFyIHZlcnNpb24gPSAoRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJcmV0dXJuIG5hdmlnYXRvci5wbHVnaW5zWydTaG9ja3dhdmUgRmxhc2gnXS5kZXNjcmlwdGlvbjsKfSwgZnVuY3Rpb24oKXsKCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2gnKS5HZXRWYXJpYWJsZSgnJHZlcnNpb24nKTsKfSkgfHwgJzAgcjAnKS5tYXRjaCgvXGQrL2cpOwoKQnJvd3Nlci5QbHVnaW5zLkZsYXNoID0gewoJdmVyc2lvbjogTnVtYmVyKHZlcnNpb25bMF0gfHwgJzAuJyArIHZlcnNpb25bMV0pIHx8IDAsCglidWlsZDogTnVtYmVyKHZlcnNpb25bMl0pIHx8IDAKfTsKCi8vIFN0cmluZyBzY3JpcHRzCgpCcm93c2VyLmV4ZWMgPSBmdW5jdGlvbih0ZXh0KXsKCWlmICghdGV4dCkgcmV0dXJuIHRleHQ7CglpZiAod2luZG93LmV4ZWNTY3JpcHQpewoJCXdpbmRvdy5leGVjU2NyaXB0KHRleHQpOwoJfSBlbHNlIHsKCQl2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJc2NyaXB0LnNldEF0dHJpYnV0ZSgndHlwZScsICd0ZXh0L2phdmFzY3JpcHQnKTsKCQlzY3JpcHQudGV4dCA9IHRleHQ7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCWRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKCX0KCXJldHVybiB0ZXh0Owp9OwoKU3RyaW5nLmltcGxlbWVudCgnc3RyaXBTY3JpcHRzJywgZnVuY3Rpb24oZXhlYyl7Cgl2YXIgc2NyaXB0cyA9ICcnOwoJdmFyIHRleHQgPSB0aGlzLnJlcGxhY2UoLzxzY3JpcHRbXj5dKj4oW1xzXFNdKj8pPFwvc2NyaXB0Pi9naSwgZnVuY3Rpb24oYWxsLCBjb2RlKXsKCQlzY3JpcHRzICs9IGNvZGUgKyAnXG4nOwoJCXJldHVybiAnJzsKCX0pOwoJaWYgKGV4ZWMgPT09IHRydWUpIEJyb3dzZXIuZXhlYyhzY3JpcHRzKTsKCWVsc2UgaWYgKHR5cGVPZihleGVjKSA9PSAnZnVuY3Rpb24nKSBleGVjKHNjcmlwdHMsIHRleHQpOwoJcmV0dXJuIHRleHQ7Cn0pOwoKLy8gV2luZG93LCBEb2N1bWVudAoKQnJvd3Nlci5leHRlbmQoewoJRG9jdW1lbnQ6IHRoaXMuRG9jdW1lbnQsCglXaW5kb3c6IHRoaXMuV2luZG93LAoJRWxlbWVudDogdGhpcy5FbGVtZW50LAoJRXZlbnQ6IHRoaXMuRXZlbnQKfSk7Cgp0aGlzLldpbmRvdyA9IHRoaXMuJGNvbnN0cnVjdG9yID0gbmV3IFR5cGUoJ1dpbmRvdycsIGZ1bmN0aW9uKCl7fSk7Cgp0aGlzLiRmYW1pbHkgPSBGdW5jdGlvbi5mcm9tKCd3aW5kb3cnKS5oaWRlKCk7CgpXaW5kb3cubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cgl3aW5kb3dbbmFtZV0gPSBtZXRob2Q7Cn0pOwoKdGhpcy5Eb2N1bWVudCA9IGRvY3VtZW50LiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdEb2N1bWVudCcsIGZ1bmN0aW9uKCl7fSk7Cgpkb2N1bWVudC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZG9jdW1lbnQnKS5oaWRlKCk7CgpEb2N1bWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWRvY3VtZW50W25hbWVdID0gbWV0aG9kOwp9KTsKCmRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CmRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KCn0pLmNhbGwodGhpcyk7CgovKgotLS0KCm5hbWU6IEV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIEV2ZW50IENsYXNzLCB0byBtYWtlIHRoZSBldmVudCBvYmplY3QgY3Jvc3MtYnJvd3Nlci4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtXaW5kb3csIERvY3VtZW50LCBBcnJheSwgRnVuY3Rpb24sIFN0cmluZywgT2JqZWN0XQoKcHJvdmlkZXM6IEV2ZW50CgouLi4KKi8KCnZhciBFdmVudCA9IG5ldyBUeXBlKCdFdmVudCcsIGZ1bmN0aW9uKGV2ZW50LCB3aW4pewoJaWYgKCF3aW4pIHdpbiA9IHdpbmRvdzsKCXZhciBkb2MgPSB3aW4uZG9jdW1lbnQ7CglldmVudCA9IGV2ZW50IHx8IHdpbi5ldmVudDsKCWlmIChldmVudC4kZXh0ZW5kZWQpIHJldHVybiBldmVudDsKCXRoaXMuJGV4dGVuZGVkID0gdHJ1ZTsKCXZhciB0eXBlID0gZXZlbnQudHlwZSwKCQl0YXJnZXQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudCwKCQlwYWdlID0ge30sCgkJY2xpZW50ID0ge30sCgkJcmVsYXRlZCA9IG51bGwsCgkJcmlnaHRDbGljaywgd2hlZWwsIGNvZGUsIGtleTsKCXdoaWxlICh0YXJnZXQgJiYgdGFyZ2V0Lm5vZGVUeXBlID09IDMpIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoKCWlmICh0eXBlLmluZGV4T2YoJ2tleScpICE9IC0xKXsKCQljb2RlID0gZXZlbnQud2hpY2ggfHwgZXZlbnQua2V5Q29kZTsKCQlrZXkgPSBPYmplY3Qua2V5T2YoRXZlbnQuS2V5cywgY29kZSk7CgkJaWYgKHR5cGUgPT0gJ2tleWRvd24nKXsKCQkJdmFyIGZLZXkgPSBjb2RlIC0gMTExOwoJCQlpZiAoZktleSA+IDAgJiYgZktleSA8IDEzKSBrZXkgPSAnZicgKyBmS2V5OwoJCX0KCQlpZiAoIWtleSkga2V5ID0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlKS50b0xvd2VyQ2FzZSgpOwoJfSBlbHNlIGlmICgoL2NsaWNrfG1vdXNlfG1lbnUvaSkudGVzdCh0eXBlKSl7CgkJZG9jID0gKCFkb2MuY29tcGF0TW9kZSB8fCBkb2MuY29tcGF0TW9kZSA9PSAnQ1NTMUNvbXBhdCcpID8gZG9jLmh0bWwgOiBkb2MuYm9keTsKCQlwYWdlID0gewoJCQl4OiAoZXZlbnQucGFnZVggIT0gbnVsbCkgPyBldmVudC5wYWdlWCA6IGV2ZW50LmNsaWVudFggKyBkb2Muc2Nyb2xsTGVmdCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgOiBldmVudC5jbGllbnRZICsgZG9jLnNjcm9sbFRvcAoJCX07CgkJY2xpZW50ID0gewoJCQl4OiAoZXZlbnQucGFnZVggIT0gbnVsbCkgPyBldmVudC5wYWdlWCAtIHdpbi5wYWdlWE9mZnNldCA6IGV2ZW50LmNsaWVudFgsCgkJCXk6IChldmVudC5wYWdlWSAhPSBudWxsKSA/IGV2ZW50LnBhZ2VZIC0gd2luLnBhZ2VZT2Zmc2V0IDogZXZlbnQuY2xpZW50WQoJCX07CgkJaWYgKCgvRE9NTW91c2VTY3JvbGx8bW91c2V3aGVlbC8pLnRlc3QodHlwZSkpewoJCQl3aGVlbCA9IChldmVudC53aGVlbERlbHRhKSA/IGV2ZW50LndoZWVsRGVsdGEgLyAxMjAgOiAtKGV2ZW50LmRldGFpbCB8fCAwKSAvIDM7CgkJfQoJCXJpZ2h0Q2xpY2sgPSAoZXZlbnQud2hpY2ggPT0gMykgfHwgKGV2ZW50LmJ1dHRvbiA9PSAyKTsKCQlpZiAoKC9vdmVyfG91dC8pLnRlc3QodHlwZSkpewoJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCB8fCBldmVudFsodHlwZSA9PSAnbW91c2VvdmVyJyA/ICdmcm9tJyA6ICd0bycpICsgJ0VsZW1lbnQnXTsKCQkJdmFyIHRlc3RSZWxhdGVkID0gZnVuY3Rpb24oKXsKCQkJCXdoaWxlIChyZWxhdGVkICYmIHJlbGF0ZWQubm9kZVR5cGUgPT0gMykgcmVsYXRlZCA9IHJlbGF0ZWQucGFyZW50Tm9kZTsKCQkJCXJldHVybiB0cnVlOwoJCQl9OwoJCQl2YXIgaGFzUmVsYXRlZCA9IChCcm93c2VyLmZpcmVmb3gyKSA/IHRlc3RSZWxhdGVkLmF0dGVtcHQoKSA6IHRlc3RSZWxhdGVkKCk7CgkJCXJlbGF0ZWQgPSAoaGFzUmVsYXRlZCkgPyByZWxhdGVkIDogbnVsbDsKCQl9Cgl9IGVsc2UgaWYgKCgvZ2VzdHVyZXx0b3VjaC9pKS50ZXN0KHR5cGUpKXsKCQl0aGlzLnJvdGF0aW9uID0gZXZlbnQucm90YXRpb247CgkJdGhpcy5zY2FsZSA9IGV2ZW50LnNjYWxlOwoJCXRoaXMudGFyZ2V0VG91Y2hlcyA9IGV2ZW50LnRhcmdldFRvdWNoZXM7CgkJdGhpcy5jaGFuZ2VkVG91Y2hlcyA9IGV2ZW50LmNoYW5nZWRUb3VjaGVzOwoJCXZhciB0b3VjaGVzID0gdGhpcy50b3VjaGVzID0gZXZlbnQudG91Y2hlczsKCQlpZiAodG91Y2hlcyAmJiB0b3VjaGVzWzBdKXsKCQkJdmFyIHRvdWNoID0gdG91Y2hlc1swXTsKCQkJcGFnZSA9IHt4OiB0b3VjaC5wYWdlWCwgeTogdG91Y2gucGFnZVl9OwoJCQljbGllbnQgPSB7eDogdG91Y2guY2xpZW50WCwgeTogdG91Y2guY2xpZW50WX07CgkJfQoJfQoKCXJldHVybiBPYmplY3QuYXBwZW5kKHRoaXMsIHsKCQlldmVudDogZXZlbnQsCgkJdHlwZTogdHlwZSwKCgkJcGFnZTogcGFnZSwKCQljbGllbnQ6IGNsaWVudCwKCQlyaWdodENsaWNrOiByaWdodENsaWNrLAoKCQl3aGVlbDogd2hlZWwsCgoJCXJlbGF0ZWRUYXJnZXQ6IGRvY3VtZW50LmlkKHJlbGF0ZWQpLAoJCXRhcmdldDogZG9jdW1lbnQuaWQodGFyZ2V0KSwKCgkJY29kZTogY29kZSwKCQlrZXk6IGtleSwKCgkJc2hpZnQ6IGV2ZW50LnNoaWZ0S2V5LAoJCWNvbnRyb2w6IGV2ZW50LmN0cmxLZXksCgkJYWx0OiBldmVudC5hbHRLZXksCgkJbWV0YTogZXZlbnQubWV0YUtleQoJfSk7Cn0pOwoKRXZlbnQuS2V5cyA9IHsKCSdlbnRlcic6IDEzLAoJJ3VwJzogMzgsCgknZG93bic6IDQwLAoJJ2xlZnQnOiAzNywKCSdyaWdodCc6IDM5LAoJJ2VzYyc6IDI3LAoJJ3NwYWNlJzogMzIsCgknYmFja3NwYWNlJzogOCwKCSd0YWInOiA5LAoJJ2RlbGV0ZSc6IDQ2Cn07CgpFdmVudC5pbXBsZW1lbnQoewoKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCkucHJldmVudERlZmF1bHQoKTsKCX0sCgoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnN0b3BQcm9wYWdhdGlvbikgdGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQllbHNlIHRoaXMuZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQpIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQllbHNlIHRoaXMuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLyoKLS0tCgpuYW1lOiBDbGFzcwoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBDbGFzcyBGdW5jdGlvbiBmb3IgZWFzaWx5IGNyZWF0aW5nLCBleHRlbmRpbmcsIGFuZCBpbXBsZW1lbnRpbmcgcmV1c2FibGUgQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtBcnJheSwgU3RyaW5nLCBGdW5jdGlvbiwgTnVtYmVyXQoKcHJvdmlkZXM6IENsYXNzCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIENsYXNzID0gdGhpcy5DbGFzcyA9IG5ldyBUeXBlKCdDbGFzcycsIGZ1bmN0aW9uKHBhcmFtcyl7CglpZiAoaW5zdGFuY2VPZihwYXJhbXMsIEZ1bmN0aW9uKSkgcGFyYW1zID0ge2luaXRpYWxpemU6IHBhcmFtc307CgoJdmFyIG5ld0NsYXNzID0gZnVuY3Rpb24oKXsKCQlyZXNldCh0aGlzKTsKCQlpZiAobmV3Q2xhc3MuJHByb3RvdHlwaW5nKSByZXR1cm4gdGhpczsKCQl0aGlzLiRjYWxsZXIgPSBudWxsOwoJCXZhciB2YWx1ZSA9ICh0aGlzLmluaXRpYWxpemUpID8gdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiB0aGlzOwoJCXRoaXMuJGNhbGxlciA9IHRoaXMuY2FsbGVyID0gbnVsbDsKCQlyZXR1cm4gdmFsdWU7Cgl9LmV4dGVuZCh0aGlzKS5pbXBsZW1lbnQocGFyYW1zKTsKCgluZXdDbGFzcy4kY29uc3RydWN0b3IgPSBDbGFzczsKCW5ld0NsYXNzLnByb3RvdHlwZS4kY29uc3RydWN0b3IgPSBuZXdDbGFzczsKCW5ld0NsYXNzLnByb3RvdHlwZS5wYXJlbnQgPSBwYXJlbnQ7CgoJcmV0dXJuIG5ld0NsYXNzOwp9KTsKCnZhciBwYXJlbnQgPSBmdW5jdGlvbigpewoJaWYgKCF0aGlzLiRjYWxsZXIpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAicGFyZW50IiBjYW5ub3QgYmUgY2FsbGVkLicpOwoJdmFyIG5hbWUgPSB0aGlzLiRjYWxsZXIuJG5hbWUsCgkJcGFyZW50ID0gdGhpcy4kY2FsbGVyLiRvd25lci5wYXJlbnQsCgkJcHJldmlvdXMgPSAocGFyZW50KSA/IHBhcmVudC5wcm90b3R5cGVbbmFtZV0gOiBudWxsOwoJaWYgKCFwcmV2aW91cykgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICInICsgbmFtZSArICciIGhhcyBubyBwYXJlbnQuJyk7CglyZXR1cm4gcHJldmlvdXMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKCnZhciByZXNldCA9IGZ1bmN0aW9uKG9iamVjdCl7Cglmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQl2YXIgdmFsdWUgPSBvYmplY3Rba2V5XTsKCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQljYXNlICdvYmplY3QnOgoJCQkJdmFyIEYgPSBmdW5jdGlvbigpe307CgkJCQlGLnByb3RvdHlwZSA9IHZhbHVlOwoJCQkJb2JqZWN0W2tleV0gPSByZXNldChuZXcgRik7CgkJCWJyZWFrOwoJCQljYXNlICdhcnJheSc6IG9iamVjdFtrZXldID0gdmFsdWUuY2xvbmUoKTsgYnJlYWs7CgkJfQoJfQoJcmV0dXJuIG9iamVjdDsKfTsKCnZhciB3cmFwID0gZnVuY3Rpb24oc2VsZiwga2V5LCBtZXRob2QpewoJaWYgKG1ldGhvZC4kb3JpZ2luKSBtZXRob2QgPSBtZXRob2QuJG9yaWdpbjsKCXZhciB3cmFwcGVyID0gZnVuY3Rpb24oKXsKCQlpZiAobWV0aG9kLiRwcm90ZWN0ZWQgJiYgdGhpcy4kY2FsbGVyID09IG51bGwpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAiJyArIGtleSArICciIGNhbm5vdCBiZSBjYWxsZWQuJyk7CgkJdmFyIGNhbGxlciA9IHRoaXMuY2FsbGVyLCBjdXJyZW50ID0gdGhpcy4kY2FsbGVyOwoJCXRoaXMuY2FsbGVyID0gY3VycmVudDsgdGhpcy4kY2FsbGVyID0gd3JhcHBlcjsKCQl2YXIgcmVzdWx0ID0gbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJdGhpcy4kY2FsbGVyID0gY3VycmVudDsgdGhpcy5jYWxsZXIgPSBjYWxsZXI7CgkJcmV0dXJuIHJlc3VsdDsKCX0uZXh0ZW5kKHskb3duZXI6IHNlbGYsICRvcmlnaW46IG1ldGhvZCwgJG5hbWU6IGtleX0pOwoJcmV0dXJuIHdyYXBwZXI7Cn07Cgp2YXIgaW1wbGVtZW50ID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgcmV0YWluKXsKCWlmIChDbGFzcy5NdXRhdG9ycy5oYXNPd25Qcm9wZXJ0eShrZXkpKXsKCQl2YWx1ZSA9IENsYXNzLk11dGF0b3JzW2tleV0uY2FsbCh0aGlzLCB2YWx1ZSk7CgkJaWYgKHZhbHVlID09IG51bGwpIHJldHVybiB0aGlzOwoJfQoKCWlmICh0eXBlT2YodmFsdWUpID09ICdmdW5jdGlvbicpewoJCWlmICh2YWx1ZS4kaGlkZGVuKSByZXR1cm4gdGhpczsKCQl0aGlzLnByb3RvdHlwZVtrZXldID0gKHJldGFpbikgPyB2YWx1ZSA6IHdyYXAodGhpcywga2V5LCB2YWx1ZSk7Cgl9IGVsc2UgewoJCU9iamVjdC5tZXJnZSh0aGlzLnByb3RvdHlwZSwga2V5LCB2YWx1ZSk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07Cgp2YXIgZ2V0SW5zdGFuY2UgPSBmdW5jdGlvbihrbGFzcyl7CglrbGFzcy4kcHJvdG90eXBpbmcgPSB0cnVlOwoJdmFyIHByb3RvID0gbmV3IGtsYXNzOwoJZGVsZXRlIGtsYXNzLiRwcm90b3R5cGluZzsKCXJldHVybiBwcm90bzsKfTsKCkNsYXNzLmltcGxlbWVudCgnaW1wbGVtZW50JywgaW1wbGVtZW50Lm92ZXJsb2FkU2V0dGVyKCkpOwoKQ2xhc3MuTXV0YXRvcnMgPSB7CgoJRXh0ZW5kczogZnVuY3Rpb24ocGFyZW50KXsKCQl0aGlzLnBhcmVudCA9IHBhcmVudDsKCQl0aGlzLnByb3RvdHlwZSA9IGdldEluc3RhbmNlKHBhcmVudCk7Cgl9LAoKCUltcGxlbWVudHM6IGZ1bmN0aW9uKGl0ZW1zKXsKCQlBcnJheS5mcm9tKGl0ZW1zKS5lYWNoKGZ1bmN0aW9uKGl0ZW0pewoJCQl2YXIgaW5zdGFuY2UgPSBuZXcgaXRlbTsKCQkJZm9yICh2YXIga2V5IGluIGluc3RhbmNlKSBpbXBsZW1lbnQuY2FsbCh0aGlzLCBrZXksIGluc3RhbmNlW2tleV0sIHRydWUpOwoJCX0sIHRoaXMpOwoJfQp9OwoKfSkuY2FsbCh0aGlzKTsKCi8qCi0tLQoKbmFtZTogQ2xhc3MuRXh0cmFzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgVXRpbGl0eSBDbGFzc2VzIHRoYXQgY2FuIGJlIGltcGxlbWVudGVkIGludG8geW91ciBvd24gQ2xhc3NlcyB0byBlYXNlIHRoZSBleGVjdXRpb24gb2YgbWFueSBjb21tb24gdGFza3MuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBDbGFzcwoKcHJvdmlkZXM6IFtDbGFzcy5FeHRyYXMsIENoYWluLCBFdmVudHMsIE9wdGlvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5DaGFpbiA9IG5ldyBDbGFzcyh7CgoJJGNoYWluOiBbXSwKCgljaGFpbjogZnVuY3Rpb24oKXsKCQl0aGlzLiRjaGFpbi5hcHBlbmQoQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FsbENoYWluOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy4kY2hhaW4ubGVuZ3RoKSA/IHRoaXMuJGNoYWluLnNoaWZ0KCkuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGZhbHNlOwoJfSwKCgljbGVhckNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmVtcHR5KCk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciByZW1vdmVPbiA9IGZ1bmN0aW9uKHN0cmluZyl7CglyZXR1cm4gc3RyaW5nLnJlcGxhY2UoL15vbihbQS1aXSkvLCBmdW5jdGlvbihmdWxsLCBmaXJzdCl7CgkJcmV0dXJuIGZpcnN0LnRvTG93ZXJDYXNlKCk7Cgl9KTsKfTsKCnRoaXMuRXZlbnRzID0gbmV3IENsYXNzKHsKCgkkZXZlbnRzOiB7fSwKCglhZGRFdmVudDogZnVuY3Rpb24odHlwZSwgZm4sIGludGVybmFsKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgoJCXRoaXMuJGV2ZW50c1t0eXBlXSA9ICh0aGlzLiRldmVudHNbdHlwZV0gfHwgW10pLmluY2x1ZGUoZm4pOwoJCWlmIChpbnRlcm5hbCkgZm4uaW50ZXJuYWwgPSB0cnVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgdHlwZSBpbiBldmVudHMpIHRoaXMuYWRkRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmlyZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBhcmdzLCBkZWxheSl7CgkJdHlwZSA9IHJlbW92ZU9uKHR5cGUpOwoJCXZhciBldmVudHMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJaWYgKCFldmVudHMpIHJldHVybiB0aGlzOwoJCWFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCWV2ZW50cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJaWYgKGRlbGF5KSBmbi5kZWxheShkZWxheSwgdGhpcywgYXJncyk7CgkJCWVsc2UgZm4uYXBwbHkodGhpcywgYXJncyk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdHlwZSA9IHJlbW92ZU9uKHR5cGUpOwoJCXZhciBldmVudHMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJaWYgKGV2ZW50cyAmJiAhZm4uaW50ZXJuYWwpewoJCQl2YXIgaW5kZXggPSAgZXZlbnRzLmluZGV4T2YoZm4pOwoJCQlpZiAoaW5kZXggIT0gLTEpIGRlbGV0ZSBldmVudHNbaW5kZXhdOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCWlmIChldmVudHMpIGV2ZW50cyA9IHJlbW92ZU9uKGV2ZW50cyk7CgkJZm9yICh0eXBlIGluIHRoaXMuJGV2ZW50cyl7CgkJCWlmIChldmVudHMgJiYgZXZlbnRzICE9IHR5cGUpIGNvbnRpbnVlOwoJCQl2YXIgZm5zID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCQlmb3IgKHZhciBpID0gZm5zLmxlbmd0aDsgaS0tOykgaWYgKGkgaW4gZm5zKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZm5zW2ldKTsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdGhpcy5PcHRpb25zID0gbmV3IENsYXNzKHsKCglzZXRPcHRpb25zOiBmdW5jdGlvbigpewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zID0gT2JqZWN0Lm1lcmdlLmFwcGx5KG51bGwsIFt7fSwgdGhpcy5vcHRpb25zXS5hcHBlbmQoYXJndW1lbnRzKSk7CgkJaWYgKHRoaXMuYWRkRXZlbnQpIGZvciAodmFyIG9wdGlvbiBpbiBvcHRpb25zKXsKCQkJaWYgKHR5cGVPZihvcHRpb25zW29wdGlvbl0pICE9ICdmdW5jdGlvbicgfHwgISgvXm9uW0EtWl0vKS50ZXN0KG9wdGlvbikpIGNvbnRpbnVlOwoJCQl0aGlzLmFkZEV2ZW50KG9wdGlvbiwgb3B0aW9uc1tvcHRpb25dKTsKCQkJZGVsZXRlIG9wdGlvbnNbb3B0aW9uXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCn0pLmNhbGwodGhpcyk7CgovKgotLS0KbmFtZTogU2xpY2suUGFyc2VyCmRlc2NyaXB0aW9uOiBTdGFuZGFsb25lIENTUzMgU2VsZWN0b3IgcGFyc2VyCnByb3ZpZGVzOiBTbGljay5QYXJzZXIKLi4uCiovCgo7KGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VkLAoJc2VwYXJhdG9ySW5kZXgsCgljb21iaW5hdG9ySW5kZXgsCglyZXZlcnNlZCwKCWNhY2hlID0ge30sCglyZXZlcnNlQ2FjaGUgPSB7fSwKCXJlVW5lc2NhcGUgPSAvXFwvZzsKCnZhciBwYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGlzUmV2ZXJzZWQpewoJaWYgKGV4cHJlc3Npb24gPT0gbnVsbCkgcmV0dXJuIG51bGw7CglpZiAoZXhwcmVzc2lvbi5TbGljayA9PT0gdHJ1ZSkgcmV0dXJuIGV4cHJlc3Npb247CglleHByZXNzaW9uID0gKCcnICsgZXhwcmVzc2lvbikucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCXJldmVyc2VkID0gISFpc1JldmVyc2VkOwoJdmFyIGN1cnJlbnRDYWNoZSA9IChyZXZlcnNlZCkgPyByZXZlcnNlQ2FjaGUgOiBjYWNoZTsKCWlmIChjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl0pIHJldHVybiBjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl07CglwYXJzZWQgPSB7CgkJU2xpY2s6IHRydWUsCgkJZXhwcmVzc2lvbnM6IFtdLAoJCXJhdzogZXhwcmVzc2lvbiwKCQlyZXZlcnNlOiBmdW5jdGlvbigpewoJCQlyZXR1cm4gcGFyc2UodGhpcy5yYXcsIHRydWUpOwoJCX0KCX07CglzZXBhcmF0b3JJbmRleCA9IC0xOwoJd2hpbGUgKGV4cHJlc3Npb24gIT0gKGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2UocmVnZXhwLCBwYXJzZXIpKSk7CglwYXJzZWQubGVuZ3RoID0gcGFyc2VkLmV4cHJlc3Npb25zLmxlbmd0aDsKCXJldHVybiBjdXJyZW50Q2FjaGVbcGFyc2VkLnJhd10gPSAocmV2ZXJzZWQpID8gcmV2ZXJzZShwYXJzZWQpIDogcGFyc2VkOwp9OwoKdmFyIHJldmVyc2VDb21iaW5hdG9yID0gZnVuY3Rpb24oY29tYmluYXRvcil7CglpZiAoY29tYmluYXRvciA9PT0gJyEnKSByZXR1cm4gJyAnOwoJZWxzZSBpZiAoY29tYmluYXRvciA9PT0gJyAnKSByZXR1cm4gJyEnOwoJZWxzZSBpZiAoKC9eIS8pLnRlc3QoY29tYmluYXRvcikpIHJldHVybiBjb21iaW5hdG9yLnJlcGxhY2UoL14hLywgJycpOwoJZWxzZSByZXR1cm4gJyEnICsgY29tYmluYXRvcjsKfTsKCnZhciByZXZlcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7Cgl2YXIgZXhwcmVzc2lvbnMgPSBleHByZXNzaW9uLmV4cHJlc3Npb25zOwoJZm9yICh2YXIgaSA9IDA7IGkgPCBleHByZXNzaW9ucy5sZW5ndGg7IGkrKyl7CgkJdmFyIGV4cCA9IGV4cHJlc3Npb25zW2ldOwoJCXZhciBsYXN0ID0ge3BhcnRzOiBbXSwgdGFnOiAnKicsIGNvbWJpbmF0b3I6IHJldmVyc2VDb21iaW5hdG9yKGV4cFswXS5jb21iaW5hdG9yKX07CgoJCWZvciAodmFyIGogPSAwOyBqIDwgZXhwLmxlbmd0aDsgaisrKXsKCQkJdmFyIGNleHAgPSBleHBbal07CgkJCWlmICghY2V4cC5yZXZlcnNlQ29tYmluYXRvcikgY2V4cC5yZXZlcnNlQ29tYmluYXRvciA9ICcgJzsKCQkJY2V4cC5jb21iaW5hdG9yID0gY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQkJZGVsZXRlIGNleHAucmV2ZXJzZUNvbWJpbmF0b3I7CgkJfQoKCQlleHAucmV2ZXJzZSgpLnB1c2gobGFzdCk7Cgl9CglyZXR1cm4gZXhwcmVzc2lvbjsKfTsKCnZhciBlc2NhcGVSZWdFeHAgPSBmdW5jdGlvbihzdHJpbmcpey8vIENyZWRpdDogWFJlZ0V4cCAwLjYuMSAoYykgMjAwNy0yMDA4IFN0ZXZlbiBMZXZpdGhhbiA8aHR0cDovL3N0ZXZlbmxldml0aGFuLmNvbS9yZWdleC94cmVnZXhwLz4gTUlUIExpY2Vuc2UKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvWy1bXF17fSgpKis/LlxcXiR8LCNcc10vZywgZnVuY3Rpb24obWF0Y2gpewoJCXJldHVybiAnXFwnICsgbWF0Y2g7Cgl9KTsKfTsKCnZhciByZWdleHAgPSBuZXcgUmVnRXhwKAovKgojIS91c3IvYmluL2VudiBydWJ5CnB1dHMgIlx0XHQiICsgREFUQS5yZWFkLmdzdWIoL1woXD94XCl8XHMrIy4qJHxccyt8XFwkfFxcbi8sJycpCl9fRU5EX18KCSIoP3gpXig/OlwKCSAgXFxzKiAoICwgKSBcXHMqICAgICAgICAgICAgICAgIyBTZXBhcmF0b3IgICAgICAgICAgXG5cCgl8IFxccyogKCA8Y29tYmluYXRvcj4rICkgXFxzKiAgICMgQ29tYmluYXRvciAgICAgICAgIFxuXAoJfCAgICAgICggXFxzKyApICAgICAgICAgICAgICAgICAjIENvbWJpbmF0b3JDaGlsZHJlbiBcblwKCXwgICAgICAoIDx1bmljb2RlPisgfCBcXCogKSAgICAgIyBUYWcgICAgICAgICAgICAgICAgXG5cCgl8IFxcIyAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgSUQgICAgICAgICAgICAgICAgIFxuXAoJfCBcXC4gICggPHVuaWNvZGU+KyAgICAgICApICAgICAjIENsYXNzTmFtZSAgICAgICAgICBcblwKCXwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBBdHRyaWJ1dGUgICAgICAgICAgXG5cCglcXFsgIFwKCQlcXHMqICg8dW5pY29kZTE+KykgICg/OiAgXAoJCQlcXHMqIChbKl4kIX58XT89KSAgKD86ICBcCgkJCQlcXHMqICg/OlwKCQkJCQkoW1wiJ10/KSguKj8pXFw5IFwKCQkJCSlcCgkJCSkgIFwKCQkpPyAgXFxzKiAgXAoJXFxdKD8hXFxdKSBcblwKCXwgICA6KyAoIDx1bmljb2RlPisgKSg/OlwKCVxcKCAoPzpcCgkJKD86KFtcIiddKShbXlxcMTJdKilcXDEyKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspXAoJKSBcXClcCgkpP1wKCSkiCiovCgkiXig/OlxccyooLClcXHMqfFxccyooPGNvbWJpbmF0b3I+KylcXHMqfChcXHMrKXwoPHVuaWNvZGU+K3xcXCopfFxcIyg8dW5pY29kZT4rKXxcXC4oPHVuaWNvZGU+Kyl8XFxbXFxzKig8dW5pY29kZTE+KykoPzpcXHMqKFsqXiQhfnxdPz0pKD86XFxzKig/OihbXCInXT8pKC4qPylcXDkpKSk/XFxzKlxcXSg/IVxcXSl8KDorKSg8dW5pY29kZT4rKSg/OlxcKCg/Oig/OihbXCInXSkoW15cXDEzXSopXFwxMyl8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKSlcXCkpPykiCgkucmVwbGFjZSgvPGNvbWJpbmF0b3I+LywgJ1snICsgZXNjYXBlUmVnRXhwKCI+K35gIUAkJV4mPXt9XFw7PC8iKSArICddJykKCS5yZXBsYWNlKC88dW5pY29kZT4vZywgJyg/OltcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCgkucmVwbGFjZSgvPHVuaWNvZGUxPi9nLCAnKD86WzpcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCik7CgpmdW5jdGlvbiBwYXJzZXIoCglyYXdNYXRjaCwKCglzZXBhcmF0b3IsCgljb21iaW5hdG9yLAoJY29tYmluYXRvckNoaWxkcmVuLAoKCXRhZ05hbWUsCglpZCwKCWNsYXNzTmFtZSwKCglhdHRyaWJ1dGVLZXksCglhdHRyaWJ1dGVPcGVyYXRvciwKCWF0dHJpYnV0ZVF1b3RlLAoJYXR0cmlidXRlVmFsdWUsCgoJcHNldWRvTWFya2VyLAoJcHNldWRvQ2xhc3MsCglwc2V1ZG9RdW90ZSwKCXBzZXVkb0NsYXNzUXVvdGVkVmFsdWUsCglwc2V1ZG9DbGFzc1ZhbHVlCil7CglpZiAoc2VwYXJhdG9yIHx8IHNlcGFyYXRvckluZGV4ID09PSAtMSl7CgkJcGFyc2VkLmV4cHJlc3Npb25zWysrc2VwYXJhdG9ySW5kZXhdID0gW107CgkJY29tYmluYXRvckluZGV4ID0gLTE7CgkJaWYgKHNlcGFyYXRvcikgcmV0dXJuICcnOwoJfQoKCWlmIChjb21iaW5hdG9yIHx8IGNvbWJpbmF0b3JDaGlsZHJlbiB8fCBjb21iaW5hdG9ySW5kZXggPT09IC0xKXsKCQljb21iaW5hdG9yID0gY29tYmluYXRvciB8fCAnICc7CgkJdmFyIGN1cnJlbnRTZXBhcmF0b3IgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdOwoJCWlmIChyZXZlcnNlZCAmJiBjdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0pCgkJCWN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XS5yZXZlcnNlQ29tYmluYXRvciA9IHJldmVyc2VDb21iaW5hdG9yKGNvbWJpbmF0b3IpOwoJCWN1cnJlbnRTZXBhcmF0b3JbKytjb21iaW5hdG9ySW5kZXhdID0ge2NvbWJpbmF0b3I6IGNvbWJpbmF0b3IsIHRhZzogJyonfTsKCX0KCgl2YXIgY3VycmVudFBhcnNlZCA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF1bY29tYmluYXRvckluZGV4XTsKCglpZiAodGFnTmFtZSl7CgkJY3VycmVudFBhcnNlZC50YWcgPSB0YWdOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoaWQpewoJCWN1cnJlbnRQYXJzZWQuaWQgPSBpZC5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGNsYXNzTmFtZSl7CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0KSBjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCA9IFtdOwoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc2VzKSBjdXJyZW50UGFyc2VkLmNsYXNzZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7CgkJY3VycmVudFBhcnNlZC5jbGFzc2VzLnB1c2goewoJCQl2YWx1ZTogY2xhc3NOYW1lLAoJCQlyZWdleHA6IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXNjYXBlUmVnRXhwKGNsYXNzTmFtZSkgKyAnKFxcc3wkKScpCgkJfSk7CgoJfSBlbHNlIGlmIChwc2V1ZG9DbGFzcyl7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgfHwgcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZTsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSA/IHBzZXVkb0NsYXNzVmFsdWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJykgOiBudWxsOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQucHNldWRvcykgY3VycmVudFBhcnNlZC5wc2V1ZG9zID0gW107CgkJY3VycmVudFBhcnNlZC5wc2V1ZG9zLnB1c2goewoJCQlrZXk6IHBzZXVkb0NsYXNzLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpLAoJCQl2YWx1ZTogcHNldWRvQ2xhc3NWYWx1ZSwKCQkJdHlwZTogcHNldWRvTWFya2VyLmxlbmd0aCA9PSAxID8gJ2NsYXNzJyA6ICdlbGVtZW50JwoJCX0pOwoKCX0gZWxzZSBpZiAoYXR0cmlidXRlS2V5KXsKCQlhdHRyaWJ1dGVLZXkgPSBhdHRyaWJ1dGVLZXkucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgkJYXR0cmlidXRlVmFsdWUgPSAoYXR0cmlidXRlVmFsdWUgfHwgJycpLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQl2YXIgdGVzdCwgcmVnZXhwOwoKCQlzd2l0Y2ggKGF0dHJpYnV0ZU9wZXJhdG9yKXsKCQkJY2FzZSAnXj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICAgICAgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJyQ9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICAgICAgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyQnICAgICAgICk7IGJyZWFrOwoJCQljYXNlICd+PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAnKF58XFxzKScrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoXFxzfCQpJyApOyBicmVhazsKCQkJY2FzZSAnfD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKC18JCknICAgKTsgYnJlYWs7CgkJCWNhc2UgICc9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgPT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQljYXNlICcqPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIHZhbHVlICYmIHZhbHVlLmluZGV4T2YoYXR0cmlidXRlVmFsdWUpID4gLTE7CgkJCX07IGJyZWFrOwoJCQljYXNlICchPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlICE9IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJZGVmYXVsdCAgIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiAhIXZhbHVlOwoJCQl9OwoJCX0KCgkJaWYgKGF0dHJpYnV0ZVZhbHVlID09ICcnICYmICgvXlsqJF5dPSQvKS50ZXN0KGF0dHJpYnV0ZU9wZXJhdG9yKSkgdGVzdCA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlpZiAoIXRlc3QpIHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiB2YWx1ZSAmJiByZWdleHAudGVzdCh2YWx1ZSk7CgkJfTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMpIGN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcy5wdXNoKHsKCQkJa2V5OiBhdHRyaWJ1dGVLZXksCgkJCW9wZXJhdG9yOiBhdHRyaWJ1dGVPcGVyYXRvciwKCQkJdmFsdWU6IGF0dHJpYnV0ZVZhbHVlLAoJCQl0ZXN0OiB0ZXN0CgkJfSk7CgoJfQoKCXJldHVybiAnJzsKfTsKCi8vIFNsaWNrIE5TCgp2YXIgU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay5wYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJcmV0dXJuIHBhcnNlKGV4cHJlc3Npb24pOwp9OwoKU2xpY2suZXNjYXBlUmVnRXhwID0gZXNjYXBlUmVnRXhwOwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgovKgotLS0KbmFtZTogU2xpY2suRmluZGVyCmRlc2NyaXB0aW9uOiBUaGUgbmV3LCBzdXBlcmZhc3QgY3NzIHNlbGVjdG9yIGVuZ2luZS4KcHJvdmlkZXM6IFNsaWNrLkZpbmRlcgpyZXF1aXJlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKOyhmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge30sCglmZWF0dXJlc0NhY2hlID0ge30sCgl0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8ICh0b1N0cmluZy5jYWxsKGRvY3VtZW50KSA9PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09IDkgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9ICdIVE1MJyk7Cn07Cgpsb2NhbC5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCgkvLyBjb252ZXJ0IGVsZW1lbnRzIC8gd2luZG93IGFyZ3VtZW50cyB0byBkb2N1bWVudC4gaWYgZG9jdW1lbnQgY2Fubm90IGJlIGV4dHJhcG9sYXRlZCwgdGhlIGZ1bmN0aW9uIHJldHVybnMuCgl2YXIgbm9kZVR5cGUgPSBkb2N1bWVudC5ub2RlVHlwZTsKCWlmIChub2RlVHlwZSA9PSA5KTsgLy8gZG9jdW1lbnQKCWVsc2UgaWYgKG5vZGVUeXBlKSBkb2N1bWVudCA9IGRvY3VtZW50Lm93bmVyRG9jdW1lbnQ7IC8vIG5vZGUKCWVsc2UgaWYgKGRvY3VtZW50Lm5hdmlnYXRvcikgZG9jdW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudDsgLy8gd2luZG93CgllbHNlIHJldHVybjsKCgkvLyBjaGVjayBpZiBpdCdzIHRoZSBvbGQgZG9jdW1lbnQKCglpZiAodGhpcy5kb2N1bWVudCA9PT0gZG9jdW1lbnQpIHJldHVybjsKCXRoaXMuZG9jdW1lbnQgPSBkb2N1bWVudDsKCgkvLyBjaGVjayBpZiB3ZSBoYXZlIGRvbmUgZmVhdHVyZSBkZXRlY3Rpb24gb24gdGhpcyBkb2N1bWVudCBiZWZvcmUKCgl2YXIgcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlyb290VWlkID0gdGhpcy5nZXRVSURYTUwocm9vdCksCgkJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdLAoJCWZlYXR1cmU7CgoJaWYgKGZlYXR1cmVzKXsKCQlmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCQl0aGlzW2ZlYXR1cmVdID0gZmVhdHVyZXNbZmVhdHVyZV07CgkJfQoJCXJldHVybjsKCX0KCglmZWF0dXJlcyA9IGZlYXR1cmVzQ2FjaGVbcm9vdFVpZF0gPSB7fTsKCglmZWF0dXJlcy5yb290ID0gcm9vdDsKCWZlYXR1cmVzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCglmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4KCT0gZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EKCT0gZmVhdHVyZXMuaWRHZXRzTmFtZQoJPSBmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EKCT0gZmVhdHVyZXMuYnJva2VuR0VCQ04KCT0gZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQQoJPSBmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQQoJPSBmZWF0dXJlcy5pc0hUTUxEb2N1bWVudAoJPSBmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lLAoJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXI7CgoJdmFyIHNlbGVjdGVkLCBpZCA9ICdzbGlja191bmlxdWVpZCc7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCgl2YXIgdGVzdFJvb3QgPSBkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF0gfHwgcm9vdDsKCXRlc3RSb290LmFwcGVuZENoaWxkKHRlc3ROb2RlKTsKCgkvLyBvbiBub24tSFRNTCBkb2N1bWVudHMgaW5uZXJIVE1MIGFuZCBnZXRFbGVtZW50c0J5SWQgZG9lc250IHdvcmsgcHJvcGVybHkKCXRyeSB7CgkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGlkPSInK2lkKyciPjwvYT4nOwoJCWZlYXR1cmVzLmlzSFRNTERvY3VtZW50ID0gISFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7Cgl9IGNhdGNoKGUpe307CgoJaWYgKGZlYXR1cmVzLmlzSFRNTERvY3VtZW50KXsKCgkJdGVzdE5vZGUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCgkJLy8gSUUgcmV0dXJucyBjb21tZW50IG5vZGVzIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRlc3ROb2RlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJycpKTsKCQlzdGFyU2VsZWN0c0NvbW1lbnRzID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoID4gMSk7CgoJCS8vIElFIHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJc3RhclNlbGVjdHNDbG9zZWQgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJfSBjYXRjaChlKXt9OwoKCQlmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4gPSBzdGFyU2VsZWN0c0NvbW1lbnRzIHx8IHN0YXJTZWxlY3RzQ2xvc2VkOwoKCQkvLyBJRSByZXR1cm5zIGVsZW1lbnRzIHdpdGggdGhlIG5hbWUgaW5zdGVhZCBvZiBqdXN0IGlkIGZvciBnZXRFbGVtZW50c0J5SWQgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIG5hbWU9IicrIGlkICsnIj48L2E+PGIgaWQ9IicrIGlkICsnIj48L2I+JzsKCQkJZmVhdHVyZXMuaWRHZXRzTmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSA9PT0gdGVzdE5vZGUuZmlyc3RDaGlsZDsKCQl9IGNhdGNoKGUpe307CgoJCWlmICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKXsKCgkJCS8vIFNhZmFyaSAzLjIgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYWNoZXMgcmVzdWx0cwoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJmIj48L2E+PGEgY2xhc3M9ImIiPjwvYT4nOwoJCQkJdGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYicpLmxlbmd0aDsKCQkJCXRlc3ROb2RlLmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gJ2InOwoJCQkJY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoICE9IDIpOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBPcGVyYSA5LjYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBkb2VzbnQgZGV0ZWN0cyB0aGUgY2xhc3MgaWYgaXRzIG5vdCB0aGUgZmlyc3Qgb25lCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9ImEiPjwvYT48YSBjbGFzcz0iZiBiIGEiPjwvYT4nOwoJCQkJYnJva2VuU2Vjb25kQ2xhc3NOYW1lR0VCQ04gPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYScpLmxlbmd0aCAhPSAyKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJZmVhdHVyZXMuYnJva2VuR0VCQ04gPSBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHx8IGJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOOwoJCX0KCgkJaWYgKHRlc3ROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwpewoJCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICdmb288L2Zvbz4nOwoJCQkJc2VsZWN0ZWQgPSB0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcqJyk7CgkJCQlmZWF0dXJlcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSA9IChzZWxlY3RlZCAmJiAhIXNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gU2FmYXJpIDMuMiBxdWVyeVNlbGVjdG9yQWxsIGRvZXNudCB3b3JrIHdpdGggbWl4ZWRjYXNlIG9uIHF1aXJrc21vZGUKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iTWlYIj48L2E+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYJykubGVuZ3RoOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBXZWJraXQgYW5kIE9wZXJhIGRvbnQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQkJZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCc6Y2hlY2tlZCcpLmxlbmd0aCA9PSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gSUUgcmV0dXJucyBpbmNvcnJlY3QgcmVzdWx0cyBmb3IgYXR0clsqXiRdPSIiIHNlbGVjdG9ycyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9IiI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQl9CgoJCS8vIElFNi03LCBpZiBhIGZvcm0gaGFzIGFuIGlucHV0IG9mIGlkIHgsIGZvcm0uZ2V0QXR0cmlidXRlKHgpIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGlucHV0CgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxmb3JtIGFjdGlvbj0icyI+PGlucHV0IGlkPSJhY3Rpb24iLz48L2Zvcm0+JzsKCQkJYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlciA9ICh0ZXN0Tm9kZS5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgnYWN0aW9uJykgIT0gJ3MnKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIG5hdGl2ZSBtYXRjaGVzU2VsZWN0b3IgZnVuY3Rpb24KCgkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yID0gcm9vdC5tYXRjaGVzU2VsZWN0b3IgfHwgLypyb290Lm1zTWF0Y2hlc1NlbGVjdG9yIHx8Ki8gcm9vdC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgcm9vdC53ZWJraXRNYXRjaGVzU2VsZWN0b3I7CgkJaWYgKGZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvcikgdHJ5IHsKCQkJLy8gaWYgbWF0Y2hlc1NlbGVjdG9yIHRyb3dzIGVycm9ycyBvbiBpbmNvcnJlY3Qgc2ludGF4ZXMgd2UgY2FuIHVzZSBpdAoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IuY2FsbChyb290LCAnOnNsaWNrJyk7CgkJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IG51bGw7CgkJfSBjYXRjaChlKXt9OwoKCX0KCgl0cnkgewoJCXJvb3Quc2xpY2tfZXhwYW5kbyA9IDE7CgkJZGVsZXRlIHJvb3Quc2xpY2tfZXhwYW5kbzsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJREhUTUw7Cgl9IGNhdGNoKGUpIHsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJRFhNTDsKCX0KCgl0ZXN0Um9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IHNlbGVjdGVkID0gdGVzdFJvb3QgPSBudWxsOwoKCS8vIGdldEF0dHJpYnV0ZQoKCWZlYXR1cmVzLmdldEF0dHJpYnV0ZSA9IChmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCAmJiBicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyKSA/IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJCXZhciBhdHRyaWJ1dGVOb2RlID0gbm9kZS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpOwoJCXJldHVybiAoYXR0cmlidXRlTm9kZSkgPyBhdHRyaWJ1dGVOb2RlLm5vZGVWYWx1ZSA6IG51bGw7Cgl9IDogZnVuY3Rpb24obm9kZSwgbmFtZSl7CgkJdmFyIG1ldGhvZCA9IHRoaXMuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKCQlyZXR1cm4gKG1ldGhvZCkgPyBtZXRob2QuY2FsbChub2RlKSA6IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwoJfTsKCgkvLyBoYXNBdHRyaWJ1dGUKCglmZWF0dXJlcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCWZlYXR1cmVzLmNvbnRhaW5zID0gKHJvb3QgJiYgdGhpcy5pc05hdGl2ZUNvZGUocm9vdC5jb250YWlucykpID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJcmV0dXJuIGNvbnRleHQuY29udGFpbnMobm9kZSk7Cgl9IDogKHJvb3QgJiYgcm9vdC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dCA9PT0gbm9kZSB8fCAhIShjb250ZXh0LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpOwoJfSA6IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCWlmIChub2RlKSBkbyB7CgkJCWlmIChub2RlID09PSBjb250ZXh0KSByZXR1cm4gdHJ1ZTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpOwoJCXJldHVybiBmYWxzZTsKCX07CgoJLy8gZG9jdW1lbnQgb3JkZXIgc29ydGluZwoJLy8gY3JlZGl0cyB0byBTaXp6bGUgKGh0dHA6Ly9zaXp6bGVqcy5jb20vKQoKCWZlYXR1cmVzLmRvY3VtZW50U29ydGVyID0gKHJvb3QuY29tcGFyZURvY3VtZW50UG9zaXRpb24pID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIHx8ICFiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSByZXR1cm4gMDsKCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDQgPyAtMSA6IGEgPT09IGIgPyAwIDogMTsKCX0gOiAoJ3NvdXJjZUluZGV4JyBpbiByb290KSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5zb3VyY2VJbmRleCB8fCAhYi5zb3VyY2VJbmRleCkgcmV0dXJuIDA7CgkJcmV0dXJuIGEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4OwoJfSA6IChkb2N1bWVudC5jcmVhdGVSYW5nZSkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEub3duZXJEb2N1bWVudCB8fCAhYi5vd25lckRvY3VtZW50KSByZXR1cm4gMDsKCQl2YXIgYVJhbmdlID0gYS5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCksIGJSYW5nZSA9IGIub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpOwoJCWFSYW5nZS5zZXRTdGFydChhLCAwKTsKCQlhUmFuZ2Uuc2V0RW5kKGEsIDApOwoJCWJSYW5nZS5zZXRTdGFydChiLCAwKTsKCQliUmFuZ2Uuc2V0RW5kKGIsIDApOwoJCXJldHVybiBhUmFuZ2UuY29tcGFyZUJvdW5kYXJ5UG9pbnRzKFJhbmdlLlNUQVJUX1RPX0VORCwgYlJhbmdlKTsKCX0gOiBudWxsIDsKCglyb290ID0gbnVsbDsKCglmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCXRoaXNbZmVhdHVyZV0gPSBmZWF0dXJlc1tmZWF0dXJlXTsKCX0KfTsKCi8vIE1haW4gTWV0aG9kCgp2YXIgcmVTaW1wbGVTZWxlY3RvciA9IC9eKFsjLl0/KSgoPzpbXHctXSt8XCopKSQvLAoJcmVFbXB0eUF0dHJpYnV0ZSA9IC9cWy4rWyokXl09KD86IiJ8JycpP1xdLywKCXFzYUZhaWxFeHBDYWNoZSA9IHt9OwoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgoJaWYgKCFjb250ZXh0KSByZXR1cm4gZm91bmQ7CgllbHNlIGlmIChjb250ZXh0Lm5hdmlnYXRvcikgY29udGV4dCA9IGNvbnRleHQuZG9jdW1lbnQ7IC8vIENvbnZlcnQgdGhlIG5vZGUgZnJvbSBhIHdpbmRvdyB0byBhIGRvY3VtZW50CgllbHNlIGlmICghY29udGV4dC5ub2RlVHlwZSkgcmV0dXJuIGZvdW5kOwoKCS8vIHNldHVwCgoJdmFyIHBhcnNlZCwgaSwKCQl1bmlxdWVzID0gdGhpcy51bmlxdWVzID0ge30sCgkJaGFzT3RoZXJzID0gISEoYXBwZW5kICYmIGFwcGVuZC5sZW5ndGgpLAoJCWNvbnRleHRJc0RvY3VtZW50ID0gKGNvbnRleHQubm9kZVR5cGUgPT0gOSk7CgoJaWYgKHRoaXMuZG9jdW1lbnQgIT09IChjb250ZXh0SXNEb2N1bWVudCA/IGNvbnRleHQgOiBjb250ZXh0Lm93bmVyRG9jdW1lbnQpKSB0aGlzLnNldERvY3VtZW50KGNvbnRleHQpOwoKCS8vIGF2b2lkIGR1cGxpY2F0aW5nIGl0ZW1zIGFscmVhZHkgaW4gdGhlIGFwcGVuZCBhcnJheQoJaWYgKGhhc090aGVycykgZm9yIChpID0gZm91bmQubGVuZ3RoOyBpLS07KSB1bmlxdWVzW3RoaXMuZ2V0VUlEKGZvdW5kW2ldKV0gPSB0cnVlOwoKCS8vIGV4cHJlc3Npb24gY2hlY2tzCgoJaWYgKHR5cGVvZiBleHByZXNzaW9uID09ICdzdHJpbmcnKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHN0cmluZwoKCQkvKjxzaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgkJdmFyIHNpbXBsZVNlbGVjdG9yID0gZXhwcmVzc2lvbi5tYXRjaChyZVNpbXBsZVNlbGVjdG9yKTsKCQlzaW1wbGVTZWxlY3RvcnM6IGlmIChzaW1wbGVTZWxlY3RvcikgewoKCQkJdmFyIHN5bWJvbCA9IHNpbXBsZVNlbGVjdG9yWzFdLAoJCQkJbmFtZSA9IHNpbXBsZVNlbGVjdG9yWzJdLAoJCQkJbm9kZSwgbm9kZXM7CgoJCQlpZiAoIXN5bWJvbCl7CgoJCQkJaWYgKG5hbWUgPT0gJyonICYmIHRoaXMuYnJva2VuU3RhckdFQlROKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUobmFtZSk7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJfQoKCQkJfSBlbHNlIGlmIChzeW1ib2wgPT0gJyMnKXsKCgkJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQgfHwgIWNvbnRleHRJc0RvY3VtZW50KSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChuYW1lKTsKCQkJCWlmICghbm9kZSkgcmV0dXJuIGZvdW5kOwoJCQkJaWYgKHRoaXMuaWRHZXRzTmFtZSAmJiBub2RlLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IG5hbWUpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGUgfHwgbnVsbDsKCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnLicpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAoKCFjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgdGhpcy5icm9rZW5HRUJDTikgJiYgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiAhdGhpcy5icm9rZW5HRUJDTil7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobmFtZSk7CgkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCQkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdmFyIG1hdGNoQ2xhc3MgPSBuZXcgUmVnRXhwKCcoXnxcXHMpJysgU2xpY2suZXNjYXBlUmVnRXhwKG5hbWUpICsnKFxcc3wkKScpOwoJCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWNsYXNzTmFtZSA9IG5vZGUuY2xhc3NOYW1lOwoJCQkJCQlpZiAoIShjbGFzc05hbWUgJiYgbWF0Y2hDbGFzcy50ZXN0KGNsYXNzTmFtZSkpKSBjb250aW51ZTsKCQkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZTsKCQkJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJCQl9CgkJCQl9CgoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gKGZpcnN0KSA/IG51bGwgOiBmb3VuZDsKCgkJfQoJCS8qPC9zaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgoJCS8qPHF1ZXJ5LXNlbGVjdG9yLW92ZXJyaWRlPiovCgkJcXVlcnlTZWxlY3RvcjogaWYgKGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCkgewoKCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50IHx8IHRoaXMuYnJva2VuTWl4ZWRDYXNlUVNBIHx8IHFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXSB8fAoJCQkodGhpcy5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKSB8fAoJCQkodGhpcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSAmJiByZUVtcHR5QXR0cmlidXRlLnRlc3QoZXhwcmVzc2lvbikpIHx8IFNsaWNrLmRpc2FibGVRU0EpIGJyZWFrIHF1ZXJ5U2VsZWN0b3I7CgoJCQl2YXIgX2V4cHJlc3Npb24gPSBleHByZXNzaW9uOwoJCQlpZiAoIWNvbnRleHRJc0RvY3VtZW50KXsKCQkJCS8vIG5vbi1kb2N1bWVudCByb290ZWQgUVNBCgkJCQkvLyBjcmVkaXRzIHRvIEFuZHJldyBEdXBvbnQKCQkJCXZhciBjdXJyZW50SWQgPSBjb250ZXh0LmdldEF0dHJpYnV0ZSgnaWQnKSwgc2xpY2tpZCA9ICdzbGlja2lkX18nOwoJCQkJY29udGV4dC5zZXRBdHRyaWJ1dGUoJ2lkJywgc2xpY2tpZCk7CgkJCQlfZXhwcmVzc2lvbiA9ICcjJyArIHNsaWNraWQgKyAnICcgKyBfZXhwcmVzc2lvbjsKCQkJfQoKCQkJdHJ5IHsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvcihfZXhwcmVzc2lvbikgfHwgbnVsbDsKCQkJCWVsc2Ugbm9kZXMgPSBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoX2V4cHJlc3Npb24pOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXSA9IDE7CgkJCQlicmVhayBxdWVyeVNlbGVjdG9yOwoJCQl9IGZpbmFsbHkgewoJCQkJaWYgKCFjb250ZXh0SXNEb2N1bWVudCl7CgkJCQkJaWYgKGN1cnJlbnRJZCkgY29udGV4dC5zZXRBdHRyaWJ1dGUoJ2lkJywgY3VycmVudElkKTsKCQkJCQllbHNlIGNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwoJCQkJfQoJCQl9CgoJCQlpZiAodGhpcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSkgZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCWlmIChub2RlLm5vZGVOYW1lID4gJ0AnICYmICEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gZm91bmQ7CgoJCX0KCQkvKjwvcXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCgkJcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShleHByZXNzaW9uKTsKCQlpZiAoIXBhcnNlZC5sZW5ndGgpIHJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbiA9PSBudWxsKXsgLy8gdGhlcmUgaXMgbm8gZXhwcmVzc2lvbgoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbi5TbGljayl7IC8vIGV4cHJlc3Npb24gaXMgYSBwYXJzZWQgU2xpY2sgb2JqZWN0CgkJcGFyc2VkID0gZXhwcmVzc2lvbjsKCX0gZWxzZSBpZiAodGhpcy5jb250YWlucyhjb250ZXh0LmRvY3VtZW50RWxlbWVudCB8fCBjb250ZXh0LCBleHByZXNzaW9uKSl7IC8vIGV4cHJlc3Npb24gaXMgYSBub2RlCgkJKGZvdW5kKSA/IGZvdW5kLnB1c2goZXhwcmVzc2lvbikgOiBmb3VuZCA9IGV4cHJlc3Npb247CgkJcmV0dXJuIGZvdW5kOwoJfSBlbHNlIHsgLy8gb3RoZXIganVuawoJCXJldHVybiBmb3VuZDsKCX0KCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjYWNoZSBlbGVtZW50cyBmb3IgdGhlIG50aCBzZWxlY3RvcnMKCgl0aGlzLnBvc05USCA9IHt9OwoJdGhpcy5wb3NOVEhMYXN0ID0ge307Cgl0aGlzLnBvc05USFR5cGUgPSB7fTsKCXRoaXMucG9zTlRIVHlwZUxhc3QgPSB7fTsKCgkvKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8vKjwvcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGlmIGFwcGVuZCBpcyBudWxsIGFuZCB0aGVyZSBpcyBvbmx5IGEgc2luZ2xlIHNlbGVjdG9yIHdpdGggb25lIGV4cHJlc3Npb24gdXNlIHB1c2hBcnJheSwgZWxzZSB1c2UgcHVzaFVJRAoJdGhpcy5wdXNoID0gKCFoYXNPdGhlcnMgJiYgKGZpcnN0IHx8IChwYXJzZWQubGVuZ3RoID09IDEgJiYgcGFyc2VkLmV4cHJlc3Npb25zWzBdLmxlbmd0aCA9PSAxKSkpID8gdGhpcy5wdXNoQXJyYXkgOiB0aGlzLnB1c2hVSUQ7CgoJaWYgKGZvdW5kID09IG51bGwpIGZvdW5kID0gW107CgoJLy8gZGVmYXVsdCBlbmdpbmUKCgl2YXIgaiwgbSwgbjsKCXZhciBjb21iaW5hdG9yLCB0YWcsIGlkLCBjbGFzc0xpc3QsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3M7Cgl2YXIgY3VycmVudEl0ZW1zLCBjdXJyZW50RXhwcmVzc2lvbiwgY3VycmVudEJpdCwgbGFzdEJpdCwgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnM7CgoJc2VhcmNoOiBmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKykgZm9yIChqID0gMDsgKGN1cnJlbnRCaXQgPSBjdXJyZW50RXhwcmVzc2lvbltqXSk7IGorKyl7CgoJCWNvbWJpbmF0b3IgPSAnY29tYmluYXRvcjonICsgY3VycmVudEJpdC5jb21iaW5hdG9yOwoJCWlmICghdGhpc1tjb21iaW5hdG9yXSkgY29udGludWUgc2VhcmNoOwoKCQl0YWcgICAgICAgID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBjdXJyZW50Qml0LnRhZyA6IGN1cnJlbnRCaXQudGFnLnRvVXBwZXJDYXNlKCk7CgkJaWQgICAgICAgICA9IGN1cnJlbnRCaXQuaWQ7CgkJY2xhc3NMaXN0ICA9IGN1cnJlbnRCaXQuY2xhc3NMaXN0OwoJCWNsYXNzZXMgICAgPSBjdXJyZW50Qml0LmNsYXNzZXM7CgkJYXR0cmlidXRlcyA9IGN1cnJlbnRCaXQuYXR0cmlidXRlczsKCQlwc2V1ZG9zICAgID0gY3VycmVudEJpdC5wc2V1ZG9zOwoJCWxhc3RCaXQgICAgPSAoaiA9PT0gKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCAtIDEpKTsKCgkJdGhpcy5iaXRVbmlxdWVzID0ge307CgoJCWlmIChsYXN0Qml0KXsKCQkJdGhpcy51bmlxdWVzID0gdW5pcXVlczsKCQkJdGhpcy5mb3VuZCA9IGZvdW5kOwoJCX0gZWxzZSB7CgkJCXRoaXMudW5pcXVlcyA9IHt9OwoJCQl0aGlzLmZvdW5kID0gW107CgkJfQoKCQlpZiAoaiA9PT0gMCl7CgkJCXRoaXNbY29tYmluYXRvcl0oY29udGV4dCwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQgJiYgZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJfSBlbHNlIHsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQpIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKXsKCQkJCXRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQkJaWYgKGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCQl9IGVsc2UgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspIHRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCX0KCgkJY3VycmVudEl0ZW1zID0gdGhpcy5mb3VuZDsKCX0KCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCWlmIChoYXNPdGhlcnMgfHwgKHBhcnNlZC5leHByZXNzaW9ucy5sZW5ndGggPiAxKSkgdGhpcy5zb3J0KGZvdW5kKTsKCglyZXR1cm4gKGZpcnN0KSA/IChmb3VuZFswXSB8fCBudWxsKSA6IGZvdW5kOwp9OwoKLy8gVXRpbHMKCmxvY2FsLnVpZHggPSAxOwpsb2NhbC51aWRrID0gJ3NsaWNrLXVuaXF1ZWlkJzsKCmxvY2FsLmdldFVJRFhNTCA9IGZ1bmN0aW9uKG5vZGUpewoJdmFyIHVpZCA9IG5vZGUuZ2V0QXR0cmlidXRlKHRoaXMudWlkayk7CglpZiAoIXVpZCl7CgkJdWlkID0gdGhpcy51aWR4Kys7CgkJbm9kZS5zZXRBdHRyaWJ1dGUodGhpcy51aWRrLCB1aWQpOwoJfQoJcmV0dXJuIHVpZDsKfTsKCmxvY2FsLmdldFVJREhUTUwgPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiBub2RlLnVuaXF1ZU51bWJlciB8fCAobm9kZS51bmlxdWVOdW1iZXIgPSB0aGlzLnVpZHgrKyk7Cn07CgovLyBzb3J0IGJhc2VkIG9uIHRoZSBzZXREb2N1bWVudCBkb2N1bWVudFNvcnRlciBtZXRob2QuCgpsb2NhbC5zb3J0ID0gZnVuY3Rpb24ocmVzdWx0cyl7CglpZiAoIXRoaXMuZG9jdW1lbnRTb3J0ZXIpIHJldHVybiByZXN1bHRzOwoJcmVzdWx0cy5zb3J0KHRoaXMuZG9jdW1lbnRTb3J0ZXIpOwoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLmNhY2hlTlRIID0ge307Cgpsb2NhbC5tYXRjaE5USCA9IC9eKFsrLV0/XGQqKT8oW2Etel0rKT8oWystXVxkKyk/JC87Cgpsb2NhbC5wYXJzZU5USEFyZ3VtZW50ID0gZnVuY3Rpb24oYXJndW1lbnQpewoJdmFyIHBhcnNlZCA9IGFyZ3VtZW50Lm1hdGNoKHRoaXMubWF0Y2hOVEgpOwoJaWYgKCFwYXJzZWQpIHJldHVybiBmYWxzZTsKCXZhciBzcGVjaWFsID0gcGFyc2VkWzJdIHx8IGZhbHNlOwoJdmFyIGEgPSBwYXJzZWRbMV0gfHwgMTsKCWlmIChhID09ICctJykgYSA9IC0xOwoJdmFyIGIgPSArcGFyc2VkWzNdIHx8IDA7CglwYXJzZWQgPQoJCShzcGVjaWFsID09ICduJykJPyB7YTogYSwgYjogYn0gOgoJCShzcGVjaWFsID09ICdvZGQnKQk/IHthOiAyLCBiOiAxfSA6CgkJKHNwZWNpYWwgPT0gJ2V2ZW4nKQk/IHthOiAyLCBiOiAwfSA6IHthOiAwLCBiOiBhfTsKCglyZXR1cm4gKHRoaXMuY2FjaGVOVEhbYXJndW1lbnRdID0gcGFyc2VkKTsKfTsKCmxvY2FsLmNyZWF0ZU5USFBzZXVkbyA9IGZ1bmN0aW9uKGNoaWxkLCBzaWJsaW5nLCBwb3NpdGlvbnMsIG9mVHlwZSl7CglyZXR1cm4gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQlpZiAoIXRoaXNbcG9zaXRpb25zXVt1aWRdKXsKCQkJdmFyIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKCQkJaWYgKCFwYXJlbnQpIHJldHVybiBmYWxzZTsKCQkJdmFyIGVsID0gcGFyZW50W2NoaWxkXSwgY291bnQgPSAxOwoJCQlpZiAob2ZUeXBlKXsKCQkJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVOYW1lICE9IG5vZGVOYW1lKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9IGVsc2UgewoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAodGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvcil7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwobm9kZSwgc2VsZWN0b3IucmVwbGFjZSgvXFsoW149XSspPVxzKihbXiciXF1dKz8pXHMqXF0vZywgJ1skMT0iJDIiXScpKTsKCQl9IGNhdGNoKG1hdGNoRXJyb3IpIHt9Cgl9CgoJdmFyIHBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2Uoc2VsZWN0b3IpOwoJaWYgKCFwYXJzZWQpIHJldHVybiB0cnVlOwoKCS8vIHNpbXBsZSAoc2luZ2xlKSBzZWxlY3RvcnMKCXZhciBleHByZXNzaW9ucyA9IHBhcnNlZC5leHByZXNzaW9ucywgcmV2ZXJzZWRFeHByZXNzaW9ucywgc2ltcGxlRXhwQ291bnRlciA9IDAsIGk7Cglmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKyl7CgkJaWYgKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCA9PSAxKXsKCQkJdmFyIGV4cCA9IGN1cnJlbnRFeHByZXNzaW9uWzBdOwoJCQlpZiAodGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gZXhwLnRhZyA6IGV4cC50YWcudG9VcHBlckNhc2UoKSwgZXhwLmlkLCBleHAuY2xhc3NlcywgZXhwLmF0dHJpYnV0ZXMsIGV4cC5wc2V1ZG9zKSkgcmV0dXJuIHRydWU7CgkJCXNpbXBsZUV4cENvdW50ZXIrKzsKCQl9Cgl9CgoJaWYgKHNpbXBsZUV4cENvdW50ZXIgPT0gcGFyc2VkLmxlbmd0aCkgcmV0dXJuIGZhbHNlOwoKCXZhciBub2RlcyA9IHRoaXMuc2VhcmNoKHRoaXMuZG9jdW1lbnQsIHBhcnNlZCksIGl0ZW07Cglmb3IgKGkgPSAwOyBpdGVtID0gbm9kZXNbaSsrXTspewoJCWlmIChpdGVtID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCX0KCXJldHVybiBmYWxzZTsKfTsKCmxvY2FsLm1hdGNoUHNldWRvID0gZnVuY3Rpb24obm9kZSwgbmFtZSwgYXJndW1lbnQpewoJdmFyIHBzZXVkb05hbWUgPSAncHNldWRvOicgKyBuYW1lOwoJaWYgKHRoaXNbcHNldWRvTmFtZV0pIHJldHVybiB0aGlzW3BzZXVkb05hbWVdKG5vZGUsIGFyZ3VtZW50KTsKCXZhciBhdHRyaWJ1dGUgPSB0aGlzLmdldEF0dHJpYnV0ZShub2RlLCBuYW1lKTsKCXJldHVybiAoYXJndW1lbnQpID8gYXJndW1lbnQgPT0gYXR0cmlidXRlIDogISFhdHRyaWJ1dGU7Cn07Cgpsb2NhbC5tYXRjaFNlbGVjdG9yID0gZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7CglpZiAodGFnKXsKCQl2YXIgbm9kZU5hbWUgPSAodGhpcy5pc1hNTERvY3VtZW50KSA/IG5vZGUubm9kZU5hbWUgOiBub2RlLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCk7CgkJaWYgKHRhZyA9PSAnKicpewoJCQlpZiAobm9kZU5hbWUgPCAnQCcpIHJldHVybiBmYWxzZTsgLy8gRml4IGZvciBjb21tZW50IG5vZGVzIGFuZCBjbG9zZWQgbm9kZXMKCQl9IGVsc2UgewoJCQlpZiAobm9kZU5hbWUgIT0gdGFnKSByZXR1cm4gZmFsc2U7CgkJfQoJfQoKCWlmIChpZCAmJiBub2RlLmdldEF0dHJpYnV0ZSgnaWQnKSAhPSBpZCkgcmV0dXJuIGZhbHNlOwoKCXZhciBpLCBwYXJ0LCBjbHM7CglpZiAoY2xhc3NlcykgZm9yIChpID0gY2xhc3Nlcy5sZW5ndGg7IGktLTspewoJCWNscyA9IG5vZGUuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8IG5vZGUuY2xhc3NOYW1lOwoJCWlmICghKGNscyAmJiBjbGFzc2VzW2ldLnJlZ2V4cC50ZXN0KGNscykpKSByZXR1cm4gZmFsc2U7Cgl9CglpZiAoYXR0cmlidXRlcykgZm9yIChpID0gYXR0cmlidXRlcy5sZW5ndGg7IGktLTspewoJCXBhcnQgPSBhdHRyaWJ1dGVzW2ldOwoJCWlmIChwYXJ0Lm9wZXJhdG9yID8gIXBhcnQudGVzdCh0aGlzLmdldEF0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIDogIXRoaXMuaGFzQXR0cmlidXRlKG5vZGUsIHBhcnQua2V5KSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKHBzZXVkb3MpIGZvciAoaSA9IHBzZXVkb3MubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gcHNldWRvc1tpXTsKCQlpZiAoIXRoaXMubWF0Y2hQc2V1ZG8obm9kZSwgcGFydC5rZXksIHBhcnQudmFsdWUpKSByZXR1cm4gZmFsc2U7Cgl9CglyZXR1cm4gdHJ1ZTsKfTsKCnZhciBjb21iaW5hdG9ycyA9IHsKCgknICc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCl7IC8vIGFsbCBjaGlsZCBub2RlcywgYW55IGxldmVsCgoJCXZhciBpLCBpdGVtLCBjaGlsZHJlbjsKCgkJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQpewoJCQlnZXRCeUlkOiBpZiAoaWQpewoJCQkJaXRlbSA9IHRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJCQkJaWYgKCghaXRlbSAmJiBub2RlLmFsbCkgfHwgKHRoaXMuaWRHZXRzTmFtZSAmJiBpdGVtICYmIGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgIT0gaWQpKXsKCQkJCQkvLyBhbGxbaWRdIHJldHVybnMgYWxsIHRoZSBlbGVtZW50cyB3aXRoIHRoYXQgbmFtZSBvciBpZCBpbnNpZGUgbm9kZQoJCQkJCS8vIGlmIHRoZXJlcyBqdXN0IG9uZSBpdCB3aWxsIHJldHVybiB0aGUgZWxlbWVudCwgZWxzZSBpdCB3aWxsIGJlIGEgY29sbGVjdGlvbgoJCQkJCWNoaWxkcmVuID0gbm9kZS5hbGxbaWRdOwoJCQkJCWlmICghY2hpbGRyZW4pIHJldHVybjsKCQkJCQlpZiAoIWNoaWxkcmVuWzBdKSBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CgkJCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KXsKCQkJCQkJdmFyIGlkTm9kZSA9IGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKTsKCQkJCQkJaWYgKGlkTm9kZSAmJiBpZE5vZGUubm9kZVZhbHVlID09IGlkKXsKCQkJCQkJCXRoaXMucHVzaChpdGVtLCB0YWcsIG51bGwsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFpdGVtKXsKCQkJCQkvLyBpZiB0aGUgY29udGV4dCBpcyBpbiB0aGUgZG9tIHdlIHJldHVybiwgZWxzZSB3ZSB3aWxsIHRyeSBHRUJUTiwgYnJlYWtpbmcgdGhlIGdldEJ5SWQgbGFiZWwKCQkJCQlpZiAodGhpcy5jb250YWlucyh0aGlzLnJvb3QsIG5vZGUpKSByZXR1cm47CgkJCQkJZWxzZSBicmVhayBnZXRCeUlkOwoJCQkJfSBlbHNlIGlmICh0aGlzLmRvY3VtZW50ICE9PSBub2RlICYmICF0aGlzLmNvbnRhaW5zKG5vZGUsIGl0ZW0pKSByZXR1cm47CgkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCXJldHVybjsKCQkJfQoJCQlnZXRCeUNsYXNzOiBpZiAoY2xhc3NlcyAmJiBub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgIXRoaXMuYnJva2VuR0VCQ04pewoJCQkJY2hpbGRyZW4gPSBub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NMaXN0LmpvaW4oJyAnKSk7CgkJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeUNsYXNzOwoJCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgbnVsbCwgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJZ2V0QnlUYWc6IHsKCQkJY2hpbGRyZW4gPSBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CgkJCWlmICghKGNoaWxkcmVuICYmIGNoaWxkcmVuLmxlbmd0aCkpIGJyZWFrIGdldEJ5VGFnOwoJCQlpZiAoIXRoaXMuYnJva2VuU3RhckdFQlROKSB0YWcgPSBudWxsOwoJCQlmb3IgKGkgPSAwOyBpdGVtID0gY2hpbGRyZW5baSsrXTspIHRoaXMucHVzaChpdGVtLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSc+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGRpcmVjdCBjaGlsZHJlbgoJCWlmICgobm9kZSA9IG5vZGUuZmlyc3RDaGlsZCkpIGRvIHsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0gd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpOwoJfSwKCgknKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmcKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBmaXJzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWVsc2UgdGhpc1snY29tYmluYXRvcjorJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmdzCgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpewoJCQlpZiAobm9kZS5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCScrKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmcgYW5kIHByZXZpb3VzIHNpYmxpbmcKCQl0aGlzWydjb21iaW5hdG9yOisnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl0aGlzWydjb21iaW5hdG9yOiErJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSd+fic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBuZXh0IHNpYmxpbmdzIGFuZCBwcmV2aW91cyBzaWJsaW5ncwoJCXRoaXNbJ2NvbWJpbmF0b3I6fiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6IX4nXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyEnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gYWxsIHBhcmVudCBub2RlcyB1cCB0byBkb2N1bWVudAoJCXdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpIGlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgcGFyZW50IChvbmUgbGV2ZWwpCgkJbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCQlpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISsnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknIV4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbGFzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmxhc3RDaGlsZDsKCQlpZiAobm9kZSl7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJZWxzZSB0aGlzWydjb21iaW5hdG9yOiErJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknIX4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZ3MKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpewoJCQlpZiAobm9kZS5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9Cgp9OwoKZm9yICh2YXIgYyBpbiBjb21iaW5hdG9ycykgbG9jYWxbJ2NvbWJpbmF0b3I6JyArIGNdID0gY29tYmluYXRvcnNbY107Cgp2YXIgcHNldWRvcyA9IHsKCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2VtcHR5JzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIGNoaWxkID0gbm9kZS5maXJzdENoaWxkOwoJCXJldHVybiAhKGNoaWxkICYmIGNoaWxkLm5vZGVUeXBlID09IDEpICYmICEobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykubGVuZ3RoOwoJfSwKCgknbm90JzogZnVuY3Rpb24obm9kZSwgZXhwcmVzc2lvbil7CgkJcmV0dXJuICF0aGlzLm1hdGNoTm9kZShub2RlLCBleHByZXNzaW9uKTsKCX0sCgoJJ2NvbnRhaW5zJzogZnVuY3Rpb24obm9kZSwgdGV4dCl7CgkJcmV0dXJuIChub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5pbmRleE9mKHRleHQpID4gLTE7Cgl9LAoKCSdmaXJzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LWNoaWxkJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIHByZXYgPSBub2RlOwoJCXdoaWxlICgocHJldiA9IHByZXYucHJldmlvdXNTaWJsaW5nKSkgaWYgKHByZXYubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgkvKjxudGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdudGgtY2hpbGQnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2ZpcnN0Q2hpbGQnLCAnbmV4dFNpYmxpbmcnLCAncG9zTlRIJyksCgoJJ250aC1sYXN0LWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdsYXN0Q2hpbGQnLCAncHJldmlvdXNTaWJsaW5nJywgJ3Bvc05USExhc3QnKSwKCgknbnRoLW9mLXR5cGUnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2ZpcnN0Q2hpbGQnLCAnbmV4dFNpYmxpbmcnLCAncG9zTlRIVHlwZScsIHRydWUpLAoKCSdudGgtbGFzdC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdsYXN0Q2hpbGQnLCAncHJldmlvdXNTaWJsaW5nJywgJ3Bvc05USFR5cGVMYXN0JywgdHJ1ZSksCgoJJ2luZGV4JzogZnVuY3Rpb24obm9kZSwgaW5kZXgpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJycgKyBpbmRleCArIDEpOwoJfSwKCgknZXZlbic6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJzJuJyk7Cgl9LAoKCSdvZGQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybisxJyk7Cgl9LAoKCS8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8qPG9mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdmaXJzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdsYXN0LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknb25seS1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIHByZXYgPSBub2RlLCBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8L29mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGN1c3RvbSBwc2V1ZG9zCgoJJ2VuYWJsZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gIW5vZGUuZGlzYWJsZWQ7Cgl9LAoKCSdkaXNhYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLmRpc2FibGVkOwoJfSwKCgknY2hlY2tlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLmNoZWNrZWQgfHwgbm9kZS5zZWxlY3RlZDsKCX0sCgoJJ2ZvY3VzJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXMuaXNIVE1MRG9jdW1lbnQgJiYgdGhpcy5kb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSBub2RlICYmIChub2RlLmhyZWYgfHwgbm9kZS50eXBlIHx8IHRoaXMuaGFzQXR0cmlidXRlKG5vZGUsICd0YWJpbmRleCcpKTsKCX0sCgoJJ3Jvb3QnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gKG5vZGUgPT09IHRoaXMucm9vdCk7Cgl9LAoKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCB0aGlzLmNsYXNzTmFtZTsKCX0sCgoJJ2Zvcic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHRtbEZvcicgaW4gdGhpcykgPyB0aGlzLmh0bWxGb3IgOiB0aGlzLmdldEF0dHJpYnV0ZSgnZm9yJyk7Cgl9LAoKCSdocmVmJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdocmVmJyBpbiB0aGlzKSA/IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJywgMikgOiB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5zdHlsZSkgPyB0aGlzLnN0eWxlLmNzc1RleHQgOiB0aGlzLmdldEF0dHJpYnV0ZSgnc3R5bGUnKTsKCX0sCgoJJ3RhYmluZGV4JzogZnVuY3Rpb24oKXsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgndGFiaW5kZXgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSwKCgkndHlwZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0QXR0cmlidXRlKCd0eXBlJyk7Cgl9Cgp9OwoKLy8gU2xpY2sKCnZhciBTbGljayA9IGxvY2FsLlNsaWNrID0gKHRoaXMuU2xpY2sgfHwge30pOwoKU2xpY2sudmVyc2lvbiA9ICcxLjEuNSc7CgovLyBTbGljayBmaW5kZXIKClNsaWNrLnNlYXJjaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCl7CglyZXR1cm4gbG9jYWwuc2VhcmNoKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCk7Cn07CgpTbGljay5maW5kID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbil7CglyZXR1cm4gbG9jYWwuc2VhcmNoKGNvbnRleHQsIGV4cHJlc3Npb24sIG51bGwsIHRydWUpOwp9OwoKLy8gU2xpY2sgY29udGFpbm1lbnQgY2hlY2tlcgoKU2xpY2suY29udGFpbnMgPSBmdW5jdGlvbihjb250YWluZXIsIG5vZGUpewoJbG9jYWwuc2V0RG9jdW1lbnQoY29udGFpbmVyKTsKCXJldHVybiBsb2NhbC5jb250YWlucyhjb250YWluZXIsIG5vZGUpOwp9OwoKLy8gU2xpY2sgYXR0cmlidXRlIGdldHRlcgoKU2xpY2suZ2V0QXR0cmlidXRlID0gZnVuY3Rpb24obm9kZSwgbmFtZSl7CglyZXR1cm4gbG9jYWwuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwp9OwoKLy8gU2xpY2sgbWF0Y2hlcgoKU2xpY2subWF0Y2ggPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAoIShub2RlICYmIHNlbGVjdG9yKSkgcmV0dXJuIGZhbHNlOwoJaWYgKCFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cglsb2NhbC5zZXREb2N1bWVudChub2RlKTsKCXJldHVybiBsb2NhbC5tYXRjaE5vZGUobm9kZSwgc2VsZWN0b3IpOwp9OwoKLy8gU2xpY2sgYXR0cmlidXRlIGFjY2Vzc29yCgpTbGljay5kZWZpbmVBdHRyaWJ1dGVHZXR0ZXIgPSBmdW5jdGlvbihuYW1lLCBmbil7Cglsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdID0gZm47CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmxvb2t1cEF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUpewoJcmV0dXJuIGxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07Cn07CgovLyBTbGljayBwc2V1ZG8gYWNjZXNzb3IKClNsaWNrLmRlZmluZVBzZXVkbyA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsWydwc2V1ZG86JyArIG5hbWVdID0gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXJldHVybiBmbi5jYWxsKG5vZGUsIGFyZ3VtZW50KTsKCX07CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmxvb2t1cFBzZXVkbyA9IGZ1bmN0aW9uKG5hbWUpewoJdmFyIHBzZXVkbyA9IGxvY2FsWydwc2V1ZG86JyArIG5hbWVdOwoJaWYgKHBzZXVkbykgcmV0dXJuIGZ1bmN0aW9uKGFyZ3VtZW50KXsKCQlyZXR1cm4gcHNldWRvLmNhbGwodGhpcywgYXJndW1lbnQpOwoJfTsKCXJldHVybiBudWxsOwp9OwoKLy8gU2xpY2sgb3ZlcnJpZGVzIGFjY2Vzc29yCgpTbGljay5vdmVycmlkZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgZm4pewoJbG9jYWwub3ZlcnJpZGUocmVnZXhwLCBmbik7CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmlzWE1MID0gbG9jYWwuaXNYTUw7CgpTbGljay51aWRPZiA9IGZ1bmN0aW9uKG5vZGUpewoJcmV0dXJuIGxvY2FsLmdldFVJREhUTUwobm9kZSk7Cn07CgppZiAoIXRoaXMuU2xpY2spIHRoaXMuU2xpY2sgPSBTbGljazsKCn0pLmFwcGx5KC8qPENvbW1vbkpTPiovKHR5cGVvZiBleHBvcnRzICE9ICd1bmRlZmluZWQnKSA/IGV4cG9ydHMgOiAvKjwvQ29tbW9uSlM+Ki90aGlzKTsKCi8qCi0tLQoKbmFtZTogRWxlbWVudAoKZGVzY3JpcHRpb246IE9uZSBvZiB0aGUgbW9zdCBpbXBvcnRhbnQgaXRlbXMgaW4gTW9vVG9vbHMuIENvbnRhaW5zIHRoZSBkb2xsYXIgZnVuY3Rpb24sIHRoZSBkb2xsYXJzIGZ1bmN0aW9uLCBhbmQgYW4gaGFuZGZ1bCBvZiBjcm9zcy1icm93c2VyLCB0aW1lLXNhdmVyIG1ldGhvZHMgdG8gbGV0IHlvdSBlYXNpbHkgd29yayB3aXRoIEhUTUwgRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE51bWJlciwgU2xpY2suUGFyc2VyLCBTbGljay5GaW5kZXJdCgpwcm92aWRlczogW0VsZW1lbnQsIEVsZW1lbnRzLCAkLCAkJCwgSWZyYW1lLCBTZWxlY3RvcnNdCgouLi4KKi8KCnZhciBFbGVtZW50ID0gZnVuY3Rpb24odGFnLCBwcm9wcyl7Cgl2YXIga29uc3RydWN0b3IgPSBFbGVtZW50LkNvbnN0cnVjdG9yc1t0YWddOwoJaWYgKGtvbnN0cnVjdG9yKSByZXR1cm4ga29uc3RydWN0b3IocHJvcHMpOwoJaWYgKHR5cGVvZiB0YWcgIT0gJ3N0cmluZycpIHJldHVybiBkb2N1bWVudC5pZCh0YWcpLnNldChwcm9wcyk7CgoJaWYgKCFwcm9wcykgcHJvcHMgPSB7fTsKCglpZiAoISgvXltcdy1dKyQvKS50ZXN0KHRhZykpewoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0YWcpLmV4cHJlc3Npb25zWzBdWzBdOwoJCXRhZyA9IChwYXJzZWQudGFnID09ICcqJykgPyAnZGl2JyA6IHBhcnNlZC50YWc7CgkJaWYgKHBhcnNlZC5pZCAmJiBwcm9wcy5pZCA9PSBudWxsKSBwcm9wcy5pZCA9IHBhcnNlZC5pZDsKCgkJdmFyIGF0dHJpYnV0ZXMgPSBwYXJzZWQuYXR0cmlidXRlczsKCQlpZiAoYXR0cmlidXRlcykgZm9yICh2YXIgaSA9IDAsIGwgPSBhdHRyaWJ1dGVzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBhdHRyID0gYXR0cmlidXRlc1tpXTsKCQkJaWYgKGF0dHIudmFsdWUgIT0gbnVsbCAmJiBhdHRyLm9wZXJhdG9yID09ICc9JyAmJiBwcm9wc1thdHRyLmtleV0gPT0gbnVsbCkKCQkJCXByb3BzW2F0dHIua2V5XSA9IGF0dHIudmFsdWU7CgkJfQoKCQlpZiAocGFyc2VkLmNsYXNzTGlzdCAmJiBwcm9wc1snY2xhc3MnXSA9PSBudWxsKSBwcm9wc1snY2xhc3MnXSA9IHBhcnNlZC5jbGFzc0xpc3Quam9pbignICcpOwoJfQoKCXJldHVybiBkb2N1bWVudC5uZXdFbGVtZW50KHRhZywgcHJvcHMpOwp9OwoKaWYgKEJyb3dzZXIuRWxlbWVudCkgRWxlbWVudC5wcm90b3R5cGUgPSBCcm93c2VyLkVsZW1lbnQucHJvdG90eXBlOwoKbmV3IFR5cGUoJ0VsZW1lbnQnLCBFbGVtZW50KS5taXJyb3IoZnVuY3Rpb24obmFtZSl7CglpZiAoQXJyYXkucHJvdG90eXBlW25hbWVdKSByZXR1cm47CgoJdmFyIG9iaiA9IHt9OwoJb2JqW25hbWVdID0gZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0cyA9IFtdLCBhcmdzID0gYXJndW1lbnRzLCBlbGVtZW50cyA9IHRydWU7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBlbGVtZW50ID0gdGhpc1tpXSwgcmVzdWx0ID0gcmVzdWx0c1tpXSA9IGVsZW1lbnRbbmFtZV0uYXBwbHkoZWxlbWVudCwgYXJncyk7CgkJCWVsZW1lbnRzID0gKGVsZW1lbnRzICYmIHR5cGVPZihyZXN1bHQpID09ICdlbGVtZW50Jyk7CgkJfQoJCXJldHVybiAoZWxlbWVudHMpID8gbmV3IEVsZW1lbnRzKHJlc3VsdHMpIDogcmVzdWx0czsKCX07CgoJRWxlbWVudHMuaW1wbGVtZW50KG9iaik7Cn0pOwoKaWYgKCFCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wYXJlbnQgPSBPYmplY3Q7CgoJRWxlbWVudC5Qcm90b3R5cGUgPSB7JyRmYW1pbHknOiBGdW5jdGlvbi5mcm9tKCdlbGVtZW50JykuaGlkZSgpfTsKCglFbGVtZW50Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJCUVsZW1lbnQuUHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoJfSk7Cn0KCkVsZW1lbnQuQ29uc3RydWN0b3JzID0ge307Cgp2YXIgSUZyYW1lID0gbmV3IFR5cGUoJ0lGcmFtZScsIGZ1bmN0aW9uKCl7Cgl2YXIgcGFyYW1zID0gQXJyYXkubGluayhhcmd1bWVudHMsIHsKCQlwcm9wZXJ0aWVzOiBUeXBlLmlzT2JqZWN0LAoJCWlmcmFtZTogZnVuY3Rpb24ob2JqKXsKCQkJcmV0dXJuIChvYmogIT0gbnVsbCk7CgkJfQoJfSk7CgoJdmFyIHByb3BzID0gcGFyYW1zLnByb3BlcnRpZXMgfHwge30sIGlmcmFtZTsKCWlmIChwYXJhbXMuaWZyYW1lKSBpZnJhbWUgPSBkb2N1bWVudC5pZChwYXJhbXMuaWZyYW1lKTsKCXZhciBvbmxvYWQgPSBwcm9wcy5vbmxvYWQgfHwgZnVuY3Rpb24oKXt9OwoJZGVsZXRlIHByb3BzLm9ubG9hZDsKCXByb3BzLmlkID0gcHJvcHMubmFtZSA9IFtwcm9wcy5pZCwgcHJvcHMubmFtZSwgaWZyYW1lID8gKGlmcmFtZS5pZCB8fCBpZnJhbWUubmFtZSkgOiAnSUZyYW1lXycgKyBTdHJpbmcudW5pcXVlSUQoKV0ucGljaygpOwoJaWZyYW1lID0gbmV3IEVsZW1lbnQoaWZyYW1lIHx8ICdpZnJhbWUnLCBwcm9wcyk7CgoJdmFyIG9uTG9hZCA9IGZ1bmN0aW9uKCl7CgkJb25sb2FkLmNhbGwoaWZyYW1lLmNvbnRlbnRXaW5kb3cpOwoJfTsKCglpZiAod2luZG93LmZyYW1lc1twcm9wcy5pZF0pIG9uTG9hZCgpOwoJZWxzZSBpZnJhbWUuYWRkTGlzdGVuZXIoJ2xvYWQnLCBvbkxvYWQpOwoJcmV0dXJuIGlmcmFtZTsKfSk7Cgp2YXIgRWxlbWVudHMgPSB0aGlzLkVsZW1lbnRzID0gZnVuY3Rpb24obm9kZXMpewoJaWYgKG5vZGVzICYmIG5vZGVzLmxlbmd0aCl7CgkJdmFyIHVuaXF1ZXMgPSB7fSwgbm9kZTsKCQlmb3IgKHZhciBpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJdmFyIHVpZCA9IFNsaWNrLnVpZE9mKG5vZGUpOwoJCQlpZiAoIXVuaXF1ZXNbdWlkXSl7CgkJCQl1bmlxdWVzW3VpZF0gPSB0cnVlOwoJCQkJdGhpcy5wdXNoKG5vZGUpOwoJCQl9CgkJfQoJfQp9OwoKRWxlbWVudHMucHJvdG90eXBlID0ge2xlbmd0aDogMH07CkVsZW1lbnRzLnBhcmVudCA9IEFycmF5OwoKbmV3IFR5cGUoJ0VsZW1lbnRzJywgRWxlbWVudHMpLmltcGxlbWVudCh7CgoJZmlsdGVyOiBmdW5jdGlvbihmaWx0ZXIsIGJpbmQpewoJCWlmICghZmlsdGVyKSByZXR1cm4gdGhpczsKCQlyZXR1cm4gbmV3IEVsZW1lbnRzKEFycmF5LmZpbHRlcih0aGlzLCAodHlwZU9mKGZpbHRlcikgPT0gJ3N0cmluZycpID8gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtLm1hdGNoKGZpbHRlcik7CgkJfSA6IGZpbHRlciwgYmluZCkpOwoJfS5wcm90ZWN0KCksCgoJcHVzaDogZnVuY3Rpb24oKXsKCQl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5pZChhcmd1bWVudHNbaV0pOwoJCQlpZiAoaXRlbSkgdGhpc1tsZW5ndGgrK10gPSBpdGVtOwoJCX0KCQlyZXR1cm4gKHRoaXMubGVuZ3RoID0gbGVuZ3RoKTsKCX0ucHJvdGVjdCgpLAoKCXVuc2hpZnQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGl0ZW1zID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5pZChhcmd1bWVudHNbaV0pOwoJCQlpZiAoaXRlbSkgaXRlbXMucHVzaChpdGVtKTsKCQl9CgkJcmV0dXJuIEFycmF5LnByb3RvdHlwZS51bnNoaWZ0LmFwcGx5KHRoaXMsIGl0ZW1zKTsKCX0ucHJvdGVjdCgpLAoKCWNvbmNhdDogZnVuY3Rpb24oKXsKCQl2YXIgbmV3RWxlbWVudHMgPSBuZXcgRWxlbWVudHModGhpcyk7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGl0ZW0gPSBhcmd1bWVudHNbaV07CgkJCWlmIChUeXBlLmlzRW51bWVyYWJsZShpdGVtKSkgbmV3RWxlbWVudHMuYXBwZW5kKGl0ZW0pOwoJCQllbHNlIG5ld0VsZW1lbnRzLnB1c2goaXRlbSk7CgkJfQoJCXJldHVybiBuZXdFbGVtZW50czsKCX0ucHJvdGVjdCgpLAoKCWFwcGVuZDogZnVuY3Rpb24oY29sbGVjdGlvbil7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBjb2xsZWN0aW9uLmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5wdXNoKGNvbGxlY3Rpb25baV0pOwoJCXJldHVybiB0aGlzOwoJfS5wcm90ZWN0KCksCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJd2hpbGUgKHRoaXMubGVuZ3RoKSBkZWxldGUgdGhpc1stLXRoaXMubGVuZ3RoXTsKCQlyZXR1cm4gdGhpczsKCX0ucHJvdGVjdCgpCgp9KTsKCihmdW5jdGlvbigpewoKLy8gRkYsIElFCnZhciBzcGxpY2UgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLCBvYmplY3QgPSB7JzAnOiAwLCAnMSc6IDEsIGxlbmd0aDogMn07CgpzcGxpY2UuY2FsbChvYmplY3QsIDEsIDEpOwppZiAob2JqZWN0WzFdID09IDEpIEVsZW1lbnRzLmltcGxlbWVudCgnc3BsaWNlJywgZnVuY3Rpb24oKXsKCXZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCXNwbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJd2hpbGUgKGxlbmd0aCA+PSB0aGlzLmxlbmd0aCkgZGVsZXRlIHRoaXNbbGVuZ3RoLS1dOwoJcmV0dXJuIHRoaXM7Cn0ucHJvdGVjdCgpKTsKCkVsZW1lbnRzLmltcGxlbWVudChBcnJheS5wcm90b3R5cGUpOwoKQXJyYXkubWlycm9yKEVsZW1lbnRzKTsKCi8qPGx0SUU4PiovCnZhciBjcmVhdGVFbGVtZW50QWNjZXB0c0hUTUw7CnRyeSB7Cgl2YXIgeCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJzxpbnB1dCBuYW1lPXg+Jyk7CgljcmVhdGVFbGVtZW50QWNjZXB0c0hUTUwgPSAoeC5uYW1lID09ICd4Jyk7Cn0gY2F0Y2goZSl7fQoKdmFyIGVzY2FwZVF1b3RlcyA9IGZ1bmN0aW9uKGh0bWwpewoJcmV0dXJuICgnJyArIGh0bWwpLnJlcGxhY2UoLyYvZywgJyZhbXA7JykucmVwbGFjZSgvIi9nLCAnJnF1b3Q7Jyk7Cn07Ci8qPC9sdElFOD4qLwoKRG9jdW1lbnQuaW1wbGVtZW50KHsKCgluZXdFbGVtZW50OiBmdW5jdGlvbih0YWcsIHByb3BzKXsKCQlpZiAocHJvcHMgJiYgcHJvcHMuY2hlY2tlZCAhPSBudWxsKSBwcm9wcy5kZWZhdWx0Q2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CgkJLyo8bHRJRTg+Ki8vLyBGaXggZm9yIHJlYWRvbmx5IG5hbWUgYW5kIHR5cGUgcHJvcGVydGllcyBpbiBJRSA8IDgKCQlpZiAoY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MICYmIHByb3BzKXsKCQkJdGFnID0gJzwnICsgdGFnOwoJCQlpZiAocHJvcHMubmFtZSkgdGFnICs9ICcgbmFtZT0iJyArIGVzY2FwZVF1b3Rlcyhwcm9wcy5uYW1lKSArICciJzsKCQkJaWYgKHByb3BzLnR5cGUpIHRhZyArPSAnIHR5cGU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMudHlwZSkgKyAnIic7CgkJCXRhZyArPSAnPic7CgkJCWRlbGV0ZSBwcm9wcy5uYW1lOwoJCQlkZWxldGUgcHJvcHMudHlwZTsKCQl9CgkJLyo8L2x0SUU4PiovCgkJcmV0dXJuIHRoaXMuaWQodGhpcy5jcmVhdGVFbGVtZW50KHRhZykpLnNldChwcm9wcyk7Cgl9Cgp9KTsKCn0pKCk7CgpEb2N1bWVudC5pbXBsZW1lbnQoewoKCW5ld1RleHROb2RlOiBmdW5jdGlvbih0ZXh0KXsKCQlyZXR1cm4gdGhpcy5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy53aW5kb3c7Cgl9LAoKCWlkOiAoZnVuY3Rpb24oKXsKCgkJdmFyIHR5cGVzID0gewoKCQkJc3RyaW5nOiBmdW5jdGlvbihpZCwgbm9jYXNoLCBkb2MpewoJCQkJaWQgPSBTbGljay5maW5kKGRvYywgJyMnICsgaWQucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKTsKCQkJCXJldHVybiAoaWQpID8gdHlwZXMuZWxlbWVudChpZCwgbm9jYXNoKSA6IG51bGw7CgkJCX0sCgoJCQllbGVtZW50OiBmdW5jdGlvbihlbCwgbm9jYXNoKXsKCQkJCSR1aWQoZWwpOwoJCQkJaWYgKCFub2Nhc2ggJiYgIWVsLiRmYW1pbHkgJiYgISgvXig/Om9iamVjdHxlbWJlZCkkL2kpLnRlc3QoZWwudGFnTmFtZSkpewoJCQkJCU9iamVjdC5hcHBlbmQoZWwsIEVsZW1lbnQuUHJvdG90eXBlKTsKCQkJCX0KCQkJCXJldHVybiBlbDsKCQkJfSwKCgkJCW9iamVjdDogZnVuY3Rpb24ob2JqLCBub2Nhc2gsIGRvYyl7CgkJCQlpZiAob2JqLnRvRWxlbWVudCkgcmV0dXJuIHR5cGVzLmVsZW1lbnQob2JqLnRvRWxlbWVudChkb2MpLCBub2Nhc2gpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJfTsKCgkJdHlwZXMudGV4dG5vZGUgPSB0eXBlcy53aGl0ZXNwYWNlID0gdHlwZXMud2luZG93ID0gdHlwZXMuZG9jdW1lbnQgPSBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGVsLCBub2Nhc2gsIGRvYyl7CgkJCWlmIChlbCAmJiBlbC4kZmFtaWx5ICYmIGVsLnVpZCkgcmV0dXJuIGVsOwoJCQl2YXIgdHlwZSA9IHR5cGVPZihlbCk7CgkJCXJldHVybiAodHlwZXNbdHlwZV0pID8gdHlwZXNbdHlwZV0oZWwsIG5vY2FzaCwgZG9jIHx8IGRvY3VtZW50KSA6IG51bGw7CgkJfTsKCgl9KSgpCgp9KTsKCmlmICh3aW5kb3cuJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJywgZnVuY3Rpb24oZWwsIG5jKXsKCXJldHVybiBkb2N1bWVudC5pZChlbCwgbmMsIHRoaXMuZG9jdW1lbnQpOwp9KTsKCldpbmRvdy5pbXBsZW1lbnQoewoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmRvY3VtZW50OwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCltEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgZXhwcmVzc2lvbiwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0RWxlbWVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgZXhwcmVzc2lvbikpOwoJfQoKfSk7CgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CgkJaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBzZWxlY3RvciwgbmV3IEVsZW1lbnRzKTsKCQllbHNlIGlmIChUeXBlLmlzRW51bWVyYWJsZShzZWxlY3RvcikpIHJldHVybiBuZXcgRWxlbWVudHMoc2VsZWN0b3IpOwoJfQoJcmV0dXJuIG5ldyBFbGVtZW50cyhhcmd1bWVudHMpOwp9KTsKCihmdW5jdGlvbigpewoKdmFyIGNvbGxlY3RlZCA9IHt9LCBzdG9yYWdlID0ge307CnZhciBmb3JtUHJvcHMgPSB7aW5wdXQ6ICdjaGVja2VkJywgb3B0aW9uOiAnc2VsZWN0ZWQnLCB0ZXh0YXJlYTogJ3ZhbHVlJ307Cgp2YXIgZ2V0ID0gZnVuY3Rpb24odWlkKXsKCXJldHVybiAoc3RvcmFnZVt1aWRdIHx8IChzdG9yYWdlW3VpZF0gPSB7fSkpOwp9OwoKdmFyIGNsZWFuID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgdWlkID0gaXRlbS51aWQ7CglpZiAoaXRlbS5yZW1vdmVFdmVudHMpIGl0ZW0ucmVtb3ZlRXZlbnRzKCk7CglpZiAoaXRlbS5jbGVhckF0dHJpYnV0ZXMpIGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKCk7CglpZiAodWlkICE9IG51bGwpewoJCWRlbGV0ZSBjb2xsZWN0ZWRbdWlkXTsKCQlkZWxldGUgc3RvcmFnZVt1aWRdOwoJfQoJcmV0dXJuIGl0ZW07Cn07Cgp2YXIgY2FtZWxzID0gWydkZWZhdWx0VmFsdWUnLCAnYWNjZXNzS2V5JywgJ2NlbGxQYWRkaW5nJywgJ2NlbGxTcGFjaW5nJywgJ2NvbFNwYW4nLCAnZnJhbWVCb3JkZXInLCAnbWF4TGVuZ3RoJywgJ3JlYWRPbmx5JywKCSdyb3dTcGFuJywgJ3RhYkluZGV4JywgJ3VzZU1hcCcKXTsKdmFyIGJvb2xzID0gWydjb21wYWN0JywgJ25vd3JhcCcsICdpc21hcCcsICdkZWNsYXJlJywgJ25vc2hhZGUnLCAnY2hlY2tlZCcsICdkaXNhYmxlZCcsICdyZWFkT25seScsICdtdWx0aXBsZScsICdzZWxlY3RlZCcsCgknbm9yZXNpemUnLCAnZGVmZXInLCAnZGVmYXVsdENoZWNrZWQnCl07CiB2YXIgYXR0cmlidXRlcyA9IHsKCSdodG1sJzogJ2lubmVySFRNTCcsCgknY2xhc3MnOiAnY2xhc3NOYW1lJywKCSdmb3InOiAnaHRtbEZvcicsCgkndGV4dCc6IChmdW5jdGlvbigpewoJCXZhciB0ZW1wID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJcmV0dXJuICh0ZW1wLnRleHRDb250ZW50ID09IG51bGwpID8gJ2lubmVyVGV4dCcgOiAndGV4dENvbnRlbnQnOwoJfSkoKQp9Owp2YXIgcmVhZE9ubHkgPSBbJ3R5cGUnXTsKdmFyIGV4cGFuZG9zID0gWyd2YWx1ZScsICdkZWZhdWx0VmFsdWUnXTsKdmFyIHVyaUF0dHJzID0gL14oPzpocmVmfHNyY3x1c2VtYXApJC9pOwoKYm9vbHMgPSBib29scy5hc3NvY2lhdGUoYm9vbHMpOwpjYW1lbHMgPSBjYW1lbHMuYXNzb2NpYXRlKGNhbWVscy5tYXAoU3RyaW5nLnRvTG93ZXJDYXNlKSk7CnJlYWRPbmx5ID0gcmVhZE9ubHkuYXNzb2NpYXRlKHJlYWRPbmx5KTsKCk9iamVjdC5hcHBlbmQoYXR0cmlidXRlcywgZXhwYW5kb3MuYXNzb2NpYXRlKGV4cGFuZG9zKSk7Cgp2YXIgaW5zZXJ0ZXJzID0gewoKCWJlZm9yZTogZnVuY3Rpb24oY29udGV4dCwgZWxlbWVudCl7CgkJdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQlpZiAocGFyZW50KSBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQpOwoJfSwKCglhZnRlcjogZnVuY3Rpb24oY29udGV4dCwgZWxlbWVudCl7CgkJdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQlpZiAocGFyZW50KSBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQubmV4dFNpYmxpbmcpOwoJfSwKCglib3R0b206IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuYXBwZW5kQ2hpbGQoY29udGV4dCk7Cgl9LAoKCXRvcDogZnVuY3Rpb24oY29udGV4dCwgZWxlbWVudCl7CgkJZWxlbWVudC5pbnNlcnRCZWZvcmUoY29udGV4dCwgZWxlbWVudC5maXJzdENoaWxkKTsKCX0KCn07CgppbnNlcnRlcnMuaW5zaWRlID0gaW5zZXJ0ZXJzLmJvdHRvbTsKCnZhciBpbmplY3RDb21iaW5hdG9yID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgY29tYmluYXRvcil7CglpZiAoIWV4cHJlc3Npb24pIHJldHVybiBjb21iaW5hdG9yOwoKCWV4cHJlc3Npb24gPSBPYmplY3QuY2xvbmUoU2xpY2sucGFyc2UoZXhwcmVzc2lvbikpOwoKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gZXhwcmVzc2lvbnMubGVuZ3RoOyBpLS07KQoJCWV4cHJlc3Npb25zW2ldWzBdLmNvbWJpbmF0b3IgPSBjb21iaW5hdG9yOwoKCXJldHVybiBleHByZXNzaW9uOwp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlLCB2YWx1ZSl7CgkJYXR0cmlidXRlID0gY2FtZWxzW2F0dHJpYnV0ZV0gfHwgYXR0cmlidXRlOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpcy5yZW1vdmVQcm9wZXJ0eShhdHRyaWJ1dGUpOwoJCXZhciBrZXkgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CgkJKGtleSkgPyB0aGlzW2tleV0gPSB2YWx1ZSA6CgkJCShib29sc1thdHRyaWJ1dGVdKSA/IHRoaXNbYXR0cmlidXRlXSA9ICEhdmFsdWUgOiB0aGlzLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUsICcnICsgdmFsdWUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihhdHRyaWJ1dGVzKXsKCQlmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgdGhpcy5zZXRQcm9wZXJ0eShhdHRyaWJ1dGUsIGF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFByb3BlcnR5OiBmdW5jdGlvbihhdHRyaWJ1dGUpewoJCWF0dHJpYnV0ZSA9IGNhbWVsc1thdHRyaWJ1dGVdIHx8IGF0dHJpYnV0ZTsKCQl2YXIga2V5ID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdIHx8IHJlYWRPbmx5W2F0dHJpYnV0ZV07CgkJcmV0dXJuIChrZXkpID8gdGhpc1trZXldIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gISF0aGlzW2F0dHJpYnV0ZV0gOgoJCQkodXJpQXR0cnMudGVzdChhdHRyaWJ1dGUpID8gdGhpcy5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCAyKSA6CgkJCShrZXkgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKSkgPyBrZXkubm9kZVZhbHVlIDogbnVsbCkgfHwgbnVsbDsKCX0sCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKCQlyZXR1cm4gYXJncy5tYXAodGhpcy5nZXRQcm9wZXJ0eSwgdGhpcykuYXNzb2NpYXRlKGFyZ3MpOwoJfSwKCglyZW1vdmVQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlKXsKCQlhdHRyaWJ1dGUgPSBjYW1lbHNbYXR0cmlidXRlXSB8fCBhdHRyaWJ1dGU7CgkJdmFyIGtleSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlXTsKCQkoa2V5KSA/IHRoaXNba2V5XSA9ICcnIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gdGhpc1thdHRyaWJ1dGVdID0gZmFsc2UgOiB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCUFycmF5LmVhY2goYXJndW1lbnRzLCB0aGlzLnJlbW92ZVByb3BlcnR5LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJcmV0dXJuIHRoaXMuY2xhc3NOYW1lLmNsZWFuKCkuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCglhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgdGhpcy5jbGFzc05hbWUgPSAodGhpcy5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWUpLmNsZWFuKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUucmVwbGFjZShuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGNsYXNzTmFtZSArICcoPzpcXHN8JCknKSwgJyQxJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUsIGZvcmNlKXsKCQlpZiAoZm9yY2UgPT0gbnVsbCkgZm9yY2UgPSAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpOwoJCXJldHVybiAoZm9yY2UpID8gdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwoJfSwKCglhZG9wdDogZnVuY3Rpb24oKXsKCQl2YXIgcGFyZW50ID0gdGhpcywgZnJhZ21lbnQsIGVsZW1lbnRzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLCBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgkJaWYgKGxlbmd0aCA+IDEpIHBhcmVudCA9IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50c1tpXSwgdHJ1ZSk7CgkJCWlmIChlbGVtZW50KSBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJfQoKCQlpZiAoZnJhZ21lbnQpIHRoaXMuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJYXBwZW5kVGV4dDogZnVuY3Rpb24odGV4dCwgd2hlcmUpewoJCXJldHVybiB0aGlzLmdyYWIodGhpcy5nZXREb2N1bWVudCgpLm5ld1RleHROb2RlKHRleHQpLCB3aGVyZSk7Cgl9LAoKCWdyYWI6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXShkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmplY3Q6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXSh0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWwpewoJCWVsID0gZG9jdW1lbnQuaWQoZWwsIHRydWUpOwoJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMsIGVsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcHM6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJcmV0dXJuIHRoaXMucmVwbGFjZXMoZWwpLmdyYWIoZWwsIHdoZXJlKTsKCX0sCgoJZ2V0UHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJyF+JykpKTsKCX0sCgoJZ2V0QWxsUHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIX4nKSwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0TmV4dDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpKSk7Cgl9LAoKCWdldEFsbE5leHQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRGaXJzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpWzBdKTsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpLmdldExhc3QoKSk7Cgl9LAoKCWdldFBhcmVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpKSk7Cgl9LAoKCWdldFBhcmVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRTaWJsaW5nczogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICd+ficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRDaGlsZHJlbjogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JyksIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LndpbmRvdzsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMub3duZXJEb2N1bWVudDsKCX0sCgoJZ2V0RWxlbWVudEJ5SWQ6IGZ1bmN0aW9uKGlkKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suZmluZCh0aGlzLCAnIycgKyAoJycgKyBpZCkucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKSk7Cgl9LAoKCWdldFNlbGVjdGVkOiBmdW5jdGlvbigpewoJCXRoaXMuc2VsZWN0ZWRJbmRleDsgLy8gU2FmYXJpIDMuMi4xCgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5mcm9tKHRoaXMub3B0aW9ucykuZmlsdGVyKGZ1bmN0aW9uKG9wdGlvbil7CgkJCXJldHVybiBvcHRpb24uc2VsZWN0ZWQ7CgkJfSkpOwoJfSwKCgl0b1F1ZXJ5U3RyaW5nOiBmdW5jdGlvbigpewoJCXZhciBxdWVyeVN0cmluZyA9IFtdOwoJCXRoaXMuZ2V0RWxlbWVudHMoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbihlbCl7CgkJCXZhciB0eXBlID0gZWwudHlwZTsKCQkJaWYgKCFlbC5uYW1lIHx8IGVsLmRpc2FibGVkIHx8IHR5cGUgPT0gJ3N1Ym1pdCcgfHwgdHlwZSA9PSAncmVzZXQnIHx8IHR5cGUgPT0gJ2ZpbGUnIHx8IHR5cGUgPT0gJ2ltYWdlJykgcmV0dXJuOwoKCQkJdmFyIHZhbHVlID0gKGVsLmdldCgndGFnJykgPT0gJ3NlbGVjdCcpID8gZWwuZ2V0U2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24ob3B0KXsKCQkJCS8vIElFCgkJCQlyZXR1cm4gZG9jdW1lbnQuaWQob3B0KS5nZXQoJ3ZhbHVlJyk7CgkJCX0pIDogKCh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSAmJiAhZWwuY2hlY2tlZCkgPyBudWxsIDogZWwuZ2V0KCd2YWx1ZScpOwoKCQkJQXJyYXkuZnJvbSh2YWx1ZSkuZWFjaChmdW5jdGlvbih2YWwpewoJCQkJaWYgKHR5cGVvZiB2YWwgIT0gJ3VuZGVmaW5lZCcpIHF1ZXJ5U3RyaW5nLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGVsLm5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkpOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwoJfSwKCglkZXN0cm95OiBmdW5jdGlvbigpewoJCXZhciBjaGlsZHJlbiA9IGNsZWFuKHRoaXMpLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJQXJyYXkuZWFjaChjaGlsZHJlbiwgY2xlYW4pOwoJCUVsZW1lbnQuZGlzcG9zZSh0aGlzKTsKCQlyZXR1cm4gbnVsbDsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJQXJyYXkuZnJvbSh0aGlzLmNoaWxkTm9kZXMpLmVhY2goRWxlbWVudC5kaXNwb3NlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMucGFyZW50Tm9kZSkgPyB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcykgOiB0aGlzOwoJfSwKCgltYXRjaDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuICFleHByZXNzaW9uIHx8IFNsaWNrLm1hdGNoKHRoaXMsIGV4cHJlc3Npb24pOwoJfQoKfSk7Cgp2YXIgY2xlYW5DbG9uZSA9IGZ1bmN0aW9uKG5vZGUsIGVsZW1lbnQsIGtlZXBpZCl7CglpZiAoIWtlZXBpZCkgbm9kZS5zZXRBdHRyaWJ1dGVOb2RlKGRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZSgnaWQnKSk7CglpZiAobm9kZS5jbGVhckF0dHJpYnV0ZXMpewoJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJbm9kZS5tZXJnZUF0dHJpYnV0ZXMoZWxlbWVudCk7CgkJbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ3VpZCcpOwoJCWlmIChub2RlLm9wdGlvbnMpewoJCQl2YXIgbm8gPSBub2RlLm9wdGlvbnMsIGVvID0gZWxlbWVudC5vcHRpb25zOwoJCQlmb3IgKHZhciBpID0gbm8ubGVuZ3RoOyBpLS07KSBub1tpXS5zZWxlY3RlZCA9IGVvW2ldLnNlbGVjdGVkOwoJCX0KCX0KCgl2YXIgcHJvcCA9IGZvcm1Qcm9wc1tlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKV07CglpZiAocHJvcCAmJiBlbGVtZW50W3Byb3BdKSBub2RlW3Byb3BdID0gZWxlbWVudFtwcm9wXTsKfTsKCkVsZW1lbnQuaW1wbGVtZW50KCdjbG9uZScsIGZ1bmN0aW9uKGNvbnRlbnRzLCBrZWVwaWQpewoJY29udGVudHMgPSBjb250ZW50cyAhPT0gZmFsc2U7Cgl2YXIgY2xvbmUgPSB0aGlzLmNsb25lTm9kZShjb250ZW50cyksIGk7CgoJaWYgKGNvbnRlbnRzKXsKCQl2YXIgY2UgPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpLCB0ZSA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlmb3IgKGkgPSBjZS5sZW5ndGg7IGktLTspIGNsZWFuQ2xvbmUoY2VbaV0sIHRlW2ldLCBrZWVwaWQpOwoJfQoKCWNsZWFuQ2xvbmUoY2xvbmUsIHRoaXMsIGtlZXBpZCk7CgoJaWYgKEJyb3dzZXIuaWUpewoJCXZhciBjbyA9IGNsb25lLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdvYmplY3QnKSwgdG8gPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdvYmplY3QnKTsKCQlmb3IgKGkgPSBjby5sZW5ndGg7IGktLTspIGNvW2ldLm91dGVySFRNTCA9IHRvW2ldLm91dGVySFRNTDsKCX0KCXJldHVybiBkb2N1bWVudC5pZChjbG9uZSk7Cn0pOwoKdmFyIGNvbnRhaW5zID0ge2NvbnRhaW5zOiBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiBTbGljay5jb250YWlucyh0aGlzLCBlbGVtZW50KTsKfX07CgppZiAoIWRvY3VtZW50LmNvbnRhaW5zKSBEb2N1bWVudC5pbXBsZW1lbnQoY29udGFpbnMpOwppZiAoIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmNvbnRhaW5zKSBFbGVtZW50LmltcGxlbWVudChjb250YWlucyk7CgpbRWxlbWVudCwgV2luZG93LCBEb2N1bWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJYWRkTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodHlwZSA9PSAndW5sb2FkJyl7CgkJCXZhciBvbGQgPSBmbiwgc2VsZiA9IHRoaXM7CgkJCWZuID0gZnVuY3Rpb24oKXsKCQkJCXNlbGYucmVtb3ZlTGlzdGVuZXIoJ3VubG9hZCcsIGZuKTsKCQkJCW9sZCgpOwoJCQl9OwoJCX0gZWxzZSB7CgkJCWNvbGxlY3RlZFskdWlkKHRoaXMpXSA9IHRoaXM7CgkJfQoJCWlmICh0aGlzLmFkZEV2ZW50TGlzdGVuZXIpIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgISFhcmd1bWVudHNbMl0pOwoJCWVsc2UgdGhpcy5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgISFhcmd1bWVudHNbMl0pOwoJCWVsc2UgdGhpcy5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXRyaWV2ZTogZnVuY3Rpb24ocHJvcGVydHksIGRmbHQpewoJCXZhciBzdG9yYWdlID0gZ2V0KCR1aWQodGhpcykpLCBwcm9wID0gc3RvcmFnZVtwcm9wZXJ0eV07CgkJaWYgKGRmbHQgIT0gbnVsbCAmJiBwcm9wID09IG51bGwpIHByb3AgPSBzdG9yYWdlW3Byb3BlcnR5XSA9IGRmbHQ7CgkJcmV0dXJuIHByb3AgIT0gbnVsbCA/IHByb3AgOiBudWxsOwoJfSwKCglzdG9yZTogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKCQl2YXIgc3RvcmFnZSA9IGdldCgkdWlkKHRoaXMpKTsKCQlzdG9yYWdlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgllbGltaW5hdGU6IGZ1bmN0aW9uKHByb3BlcnR5KXsKCQl2YXIgc3RvcmFnZSA9IGdldCgkdWlkKHRoaXMpKTsKCQlkZWxldGUgc3RvcmFnZVtwcm9wZXJ0eV07CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8vIElFIHB1cmdlCmlmICh3aW5kb3cuYXR0YWNoRXZlbnQgJiYgIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKSB3aW5kb3cuYWRkTGlzdGVuZXIoJ3VubG9hZCcsIGZ1bmN0aW9uKCl7CglPYmplY3QuZWFjaChjb2xsZWN0ZWQsIGNsZWFuKTsKCWlmICh3aW5kb3cuQ29sbGVjdEdhcmJhZ2UpIENvbGxlY3RHYXJiYWdlKCk7Cn0pOwoKfSkoKTsKCkVsZW1lbnQuUHJvcGVydGllcyA9IHt9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlID0gewoKCXNldDogZnVuY3Rpb24oc3R5bGUpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9IHN0eWxlOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3R5bGUuY3NzVGV4dDsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdHlsZS5jc3NUZXh0ID0gJyc7Cgl9Cgp9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnRhZyA9IHsKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoKfTsKCihmdW5jdGlvbihtYXhMZW5ndGgpewoJaWYgKG1heExlbmd0aCAhPSBudWxsKSBFbGVtZW50LlByb3BlcnRpZXMubWF4bGVuZ3RoID0gRWxlbWVudC5Qcm9wZXJ0aWVzLm1heExlbmd0aCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBtYXhsZW5ndGggPSB0aGlzLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJyk7CgkJCXJldHVybiBtYXhsZW5ndGggPT0gbWF4TGVuZ3RoID8gbnVsbCA6IG1heGxlbmd0aDsKCQl9Cgl9Owp9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJykpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdGFibGVUZXN0ID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCXZhciB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7CgkJdGFibGUuaW5uZXJIVE1MID0gJzx0cj48dGQ+PC90ZD48L3RyPic7Cgl9KTsKCgl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJdGFibGU6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAoJCXNlbGVjdDogWzEsICc8c2VsZWN0PicsICc8L3NlbGVjdD4nXSwKCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJdHI6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddCgl9OwoJdHJhbnNsYXRpb25zLnRoZWFkID0gdHJhbnNsYXRpb25zLnRmb290ID0gdHJhbnNsYXRpb25zLnRib2R5OwoKCXZhciBodG1sID0gewoJCXNldDogZnVuY3Rpb24oKXsKCQkJdmFyIGh0bWwgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykuam9pbignJyk7CgkJCXZhciB3cmFwID0gKCF0YWJsZVRlc3QgJiYgdHJhbnNsYXRpb25zW3RoaXMuZ2V0KCd0YWcnKV0pOwoJCQlpZiAod3JhcCl7CgkJCQl2YXIgZmlyc3QgPSB3cmFwcGVyOwoJCQkJZmlyc3QuaW5uZXJIVE1MID0gd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdOwoJCQkJZm9yICh2YXIgaSA9IHdyYXBbMF07IGktLTspIGZpcnN0ID0gZmlyc3QuZmlyc3RDaGlsZDsKCQkJCXRoaXMuZW1wdHkoKS5hZG9wdChmaXJzdC5jaGlsZE5vZGVzKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaW5uZXJIVE1MID0gaHRtbDsKCQkJfQoJCX0KCX07CgoJaHRtbC5lcmFzZSA9IGh0bWwuc2V0OwoKCXJldHVybiBodG1sOwp9KSgpOwoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LlN0eWxlCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgbWV0aG9kcyBmb3IgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgc3R5bGVzIG9mIEVsZW1lbnRzIGluIGEgZmFzaGlvbmFibGUgd2F5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRWxlbWVudAoKcHJvdmlkZXM6IEVsZW1lbnQuU3R5bGUKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaHRtbCA9IGRvY3VtZW50Lmh0bWw7CgpFbGVtZW50LlByb3BlcnRpZXMuc3R5bGVzID0ge3NldDogZnVuY3Rpb24oc3R5bGVzKXsKCXRoaXMuc2V0U3R5bGVzKHN0eWxlcyk7Cn19OwoKdmFyIGhhc09wYWNpdHkgPSAoaHRtbC5zdHlsZS5vcGFjaXR5ICE9IG51bGwpOwp2YXIgcmVBbHBoYSA9IC9hbHBoYVwob3BhY2l0eT0oW1xkLl0rKVwpL2k7Cgp2YXIgc2V0T3BhY2l0eSA9IGZ1bmN0aW9uKGVsZW1lbnQsIG9wYWNpdHkpewoJaWYgKCFlbGVtZW50LmN1cnJlbnRTdHlsZSB8fCAhZWxlbWVudC5jdXJyZW50U3R5bGUuaGFzTGF5b3V0KSBlbGVtZW50LnN0eWxlLnpvb20gPSAxOwoJaWYgKGhhc09wYWNpdHkpewoJCWVsZW1lbnQuc3R5bGUub3BhY2l0eSA9IG9wYWNpdHk7Cgl9IGVsc2UgewoJCW9wYWNpdHkgPSAob3BhY2l0eSA9PSAxKSA/ICcnIDogJ2FscGhhKG9wYWNpdHk9JyArIG9wYWNpdHkgKiAxMDAgKyAnKSc7CgkJdmFyIGZpbHRlciA9IGVsZW1lbnQuc3R5bGUuZmlsdGVyIHx8IGVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykgfHwgJyc7CgkJZWxlbWVudC5zdHlsZS5maWx0ZXIgPSByZUFscGhhLnRlc3QoZmlsdGVyKSA/IGZpbHRlci5yZXBsYWNlKHJlQWxwaGEsIG9wYWNpdHkpIDogZmlsdGVyICsgb3BhY2l0eTsKCX0KfTsKCkVsZW1lbnQuUHJvcGVydGllcy5vcGFjaXR5ID0gewoKCXNldDogZnVuY3Rpb24ob3BhY2l0eSl7CgkJdmFyIHZpc2liaWxpdHkgPSB0aGlzLnN0eWxlLnZpc2liaWxpdHk7CgkJaWYgKG9wYWNpdHkgPT0gMCAmJiB2aXNpYmlsaXR5ICE9ICdoaWRkZW4nKSB0aGlzLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQllbHNlIGlmIChvcGFjaXR5ICE9IDAgJiYgdmlzaWJpbGl0eSAhPSAndmlzaWJsZScpIHRoaXMuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJc2V0T3BhY2l0eSh0aGlzLCBvcGFjaXR5KTsKCX0sCgoJZ2V0OiAoaGFzT3BhY2l0eSkgPyBmdW5jdGlvbigpewoJCXZhciBvcGFjaXR5ID0gdGhpcy5zdHlsZS5vcGFjaXR5IHx8IHRoaXMuZ2V0Q29tcHV0ZWRTdHlsZSgnb3BhY2l0eScpOwoJCXJldHVybiAob3BhY2l0eSA9PSAnJykgPyAxIDogb3BhY2l0eTsKCX0gOiBmdW5jdGlvbigpewoJCXZhciBvcGFjaXR5LCBmaWx0ZXIgPSAodGhpcy5zdHlsZS5maWx0ZXIgfHwgdGhpcy5nZXRDb21wdXRlZFN0eWxlKCdmaWx0ZXInKSk7CgkJaWYgKGZpbHRlcikgb3BhY2l0eSA9IGZpbHRlci5tYXRjaChyZUFscGhhKTsKCQlyZXR1cm4gKG9wYWNpdHkgPT0gbnVsbCB8fCBmaWx0ZXIgPT0gbnVsbCkgPyAxIDogKG9wYWNpdHlbMV0gLyAxMDApOwoJfQoKfTsKCnZhciBmbG9hdE5hbWUgPSAoaHRtbC5zdHlsZS5jc3NGbG9hdCA9PSBudWxsKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgpFbGVtZW50LmltcGxlbWVudCh7CgoJZ2V0Q29tcHV0ZWRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmICh0aGlzLmN1cnJlbnRTdHlsZSkgcmV0dXJuIHRoaXMuY3VycmVudFN0eWxlW3Byb3BlcnR5LmNhbWVsQ2FzZSgpXTsKCQl2YXIgZGVmYXVsdFZpZXcgPSBFbGVtZW50LmdldERvY3VtZW50KHRoaXMpLmRlZmF1bHRWaWV3LAoJCQljb21wdXRlZCA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCBudWxsKSA6IG51bGw7CgkJcmV0dXJuIChjb21wdXRlZCkgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKChwcm9wZXJ0eSA9PSBmbG9hdE5hbWUpID8gJ2Zsb2F0JyA6IHByb3BlcnR5Lmh5cGhlbmF0ZSgpKSA6IG51bGw7Cgl9LAoKCXNldE9wYWNpdHk6IGZ1bmN0aW9uKHZhbHVlKXsKCQlzZXRPcGFjaXR5KHRoaXMsIHZhbHVlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0T3BhY2l0eTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXQoJ29wYWNpdHknKTsKCX0sCgoJc2V0U3R5bGU6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSl7CgkJc3dpdGNoIChwcm9wZXJ0eSl7CgkJCWNhc2UgJ29wYWNpdHknOiByZXR1cm4gdGhpcy5zZXQoJ29wYWNpdHknLCBwYXJzZUZsb2F0KHZhbHVlKSk7CgkJCWNhc2UgJ2Zsb2F0JzogcHJvcGVydHkgPSBmbG9hdE5hbWU7CgkJfQoJCXByb3BlcnR5ID0gcHJvcGVydHkuY2FtZWxDYXNlKCk7CgkJaWYgKHR5cGVPZih2YWx1ZSkgIT0gJ3N0cmluZycpewoJCQl2YXIgbWFwID0gKEVsZW1lbnQuU3R5bGVzW3Byb3BlcnR5XSB8fCAnQCcpLnNwbGl0KCcgJyk7CgkJCXZhbHVlID0gQXJyYXkuZnJvbSh2YWx1ZSkubWFwKGZ1bmN0aW9uKHZhbCwgaSl7CgkJCQlpZiAoIW1hcFtpXSkgcmV0dXJuICcnOwoJCQkJcmV0dXJuICh0eXBlT2YodmFsKSA9PSAnbnVtYmVyJykgPyBtYXBbaV0ucmVwbGFjZSgnQCcsIE1hdGgucm91bmQodmFsKSkgOiB2YWw7CgkJCX0pLmpvaW4oJyAnKTsKCQl9IGVsc2UgaWYgKHZhbHVlID09IFN0cmluZyhOdW1iZXIodmFsdWUpKSl7CgkJCXZhbHVlID0gTWF0aC5yb3VuZCh2YWx1ZSk7CgkJfQoJCXRoaXMuc3R5bGVbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSl7CgkJc3dpdGNoIChwcm9wZXJ0eSl7CgkJCWNhc2UgJ29wYWNpdHknOiByZXR1cm4gdGhpcy5nZXQoJ29wYWNpdHknKTsKCQkJY2FzZSAnZmxvYXQnOiBwcm9wZXJ0eSA9IGZsb2F0TmFtZTsKCQl9CgkJcHJvcGVydHkgPSBwcm9wZXJ0eS5jYW1lbENhc2UoKTsKCQl2YXIgcmVzdWx0ID0gdGhpcy5zdHlsZVtwcm9wZXJ0eV07CgkJaWYgKCFyZXN1bHQgfHwgcHJvcGVydHkgPT0gJ3pJbmRleCcpewoJCQlyZXN1bHQgPSBbXTsKCQkJZm9yICh2YXIgc3R5bGUgaW4gRWxlbWVudC5TaG9ydFN0eWxlcyl7CgkJCQlpZiAocHJvcGVydHkgIT0gc3R5bGUpIGNvbnRpbnVlOwoJCQkJZm9yICh2YXIgcyBpbiBFbGVtZW50LlNob3J0U3R5bGVzW3N0eWxlXSkgcmVzdWx0LnB1c2godGhpcy5nZXRTdHlsZShzKSk7CgkJCQlyZXR1cm4gcmVzdWx0LmpvaW4oJyAnKTsKCQkJfQoJCQlyZXN1bHQgPSB0aGlzLmdldENvbXB1dGVkU3R5bGUocHJvcGVydHkpOwoJCX0KCQlpZiAocmVzdWx0KXsKCQkJcmVzdWx0ID0gU3RyaW5nKHJlc3VsdCk7CgkJCXZhciBjb2xvciA9IHJlc3VsdC5tYXRjaCgvcmdiYT9cKFtcZFxzLF0rXCkvKTsKCQkJaWYgKGNvbG9yKSByZXN1bHQgPSByZXN1bHQucmVwbGFjZShjb2xvclswXSwgY29sb3JbMF0ucmdiVG9IZXgoKSk7CgkJfQoJCWlmIChCcm93c2VyLm9wZXJhIHx8IChCcm93c2VyLmllICYmIGlzTmFOKHBhcnNlRmxvYXQocmVzdWx0KSkpKXsKCQkJaWYgKCgvXihoZWlnaHR8d2lkdGgpJC8pLnRlc3QocHJvcGVydHkpKXsKCQkJCXZhciB2YWx1ZXMgPSAocHJvcGVydHkgPT0gJ3dpZHRoJykgPyBbJ2xlZnQnLCAncmlnaHQnXSA6IFsndG9wJywgJ2JvdHRvbSddLCBzaXplID0gMDsKCQkJCXZhbHVlcy5lYWNoKGZ1bmN0aW9uKHZhbHVlKXsKCQkJCQlzaXplICs9IHRoaXMuZ2V0U3R5bGUoJ2JvcmRlci0nICsgdmFsdWUgKyAnLXdpZHRoJykudG9JbnQoKSArIHRoaXMuZ2V0U3R5bGUoJ3BhZGRpbmctJyArIHZhbHVlKS50b0ludCgpOwoJCQkJfSwgdGhpcyk7CgkJCQlyZXR1cm4gdGhpc1snb2Zmc2V0JyArIHByb3BlcnR5LmNhcGl0YWxpemUoKV0gLSBzaXplICsgJ3B4JzsKCQkJfQoJCQlpZiAoQnJvd3Nlci5vcGVyYSAmJiBTdHJpbmcocmVzdWx0KS5pbmRleE9mKCdweCcpICE9IC0xKSByZXR1cm4gcmVzdWx0OwoJCQlpZiAoKC9eYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykudGVzdChwcm9wZXJ0eSkpIHJldHVybiAnMHB4JzsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewoJCWZvciAodmFyIHN0eWxlIGluIHN0eWxlcykgdGhpcy5zZXRTdHlsZShzdHlsZSwgc3R5bGVzW3N0eWxlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0ID0ge307CgkJQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLmVhY2goZnVuY3Rpb24oa2V5KXsKCQkJcmVzdWx0W2tleV0gPSB0aGlzLmdldFN0eWxlKGtleSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCn0pOwoKRWxlbWVudC5TdHlsZXMgPSB7CglsZWZ0OiAnQHB4JywgdG9wOiAnQHB4JywgYm90dG9tOiAnQHB4JywgcmlnaHQ6ICdAcHgnLAoJd2lkdGg6ICdAcHgnLCBoZWlnaHQ6ICdAcHgnLCBtYXhXaWR0aDogJ0BweCcsIG1heEhlaWdodDogJ0BweCcsIG1pbldpZHRoOiAnQHB4JywgbWluSGVpZ2h0OiAnQHB4JywKCWJhY2tncm91bmRDb2xvcjogJ3JnYihALCBALCBAKScsIGJhY2tncm91bmRQb3NpdGlvbjogJ0BweCBAcHgnLCBjb2xvcjogJ3JnYihALCBALCBAKScsCglmb250U2l6ZTogJ0BweCcsIGxldHRlclNwYWNpbmc6ICdAcHgnLCBsaW5lSGVpZ2h0OiAnQHB4JywgY2xpcDogJ3JlY3QoQHB4IEBweCBAcHggQHB4KScsCgltYXJnaW46ICdAcHggQHB4IEBweCBAcHgnLCBwYWRkaW5nOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyOiAnQHB4IEAgcmdiKEAsIEAsIEApIEBweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCknLAoJYm9yZGVyV2lkdGg6ICdAcHggQHB4IEBweCBAcHgnLCBib3JkZXJTdHlsZTogJ0AgQCBAIEAnLCBib3JkZXJDb2xvcjogJ3JnYihALCBALCBAKSByZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKScsCgl6SW5kZXg6ICdAJywgJ3pvb20nOiAnQCcsIGZvbnRXZWlnaHQ6ICdAJywgdGV4dEluZGVudDogJ0BweCcsIG9wYWNpdHk6ICdAJwp9OwoKRWxlbWVudC5TaG9ydFN0eWxlcyA9IHttYXJnaW46IHt9LCBwYWRkaW5nOiB7fSwgYm9yZGVyOiB7fSwgYm9yZGVyV2lkdGg6IHt9LCBib3JkZXJTdHlsZToge30sIGJvcmRlckNvbG9yOiB7fX07CgpbJ1RvcCcsICdSaWdodCcsICdCb3R0b20nLCAnTGVmdCddLmVhY2goZnVuY3Rpb24oZGlyZWN0aW9uKXsKCXZhciBTaG9ydCA9IEVsZW1lbnQuU2hvcnRTdHlsZXM7Cgl2YXIgQWxsID0gRWxlbWVudC5TdHlsZXM7CglbJ21hcmdpbicsICdwYWRkaW5nJ10uZWFjaChmdW5jdGlvbihzdHlsZSl7CgkJdmFyIHNkID0gc3R5bGUgKyBkaXJlY3Rpb247CgkJU2hvcnRbc3R5bGVdW3NkXSA9IEFsbFtzZF0gPSAnQHB4JzsKCX0pOwoJdmFyIGJkID0gJ2JvcmRlcicgKyBkaXJlY3Rpb247CglTaG9ydC5ib3JkZXJbYmRdID0gQWxsW2JkXSA9ICdAcHggQCByZ2IoQCwgQCwgQCknOwoJdmFyIGJkdyA9IGJkICsgJ1dpZHRoJywgYmRzID0gYmQgKyAnU3R5bGUnLCBiZGMgPSBiZCArICdDb2xvcic7CglTaG9ydFtiZF0gPSB7fTsKCVNob3J0LmJvcmRlcldpZHRoW2Jkd10gPSBTaG9ydFtiZF1bYmR3XSA9IEFsbFtiZHddID0gJ0BweCc7CglTaG9ydC5ib3JkZXJTdHlsZVtiZHNdID0gU2hvcnRbYmRdW2Jkc10gPSBBbGxbYmRzXSA9ICdAJzsKCVNob3J0LmJvcmRlckNvbG9yW2JkY10gPSBTaG9ydFtiZF1bYmRjXSA9IEFsbFtiZGNdID0gJ3JnYihALCBALCBAKSc7Cn0pOwoKfSkuY2FsbCh0aGlzKTsKCi8qCi0tLQoKbmFtZTogRWxlbWVudC5FdmVudAoKZGVzY3JpcHRpb246IENvbnRhaW5zIEVsZW1lbnQgbWV0aG9kcyBmb3IgZGVhbGluZyB3aXRoIGV2ZW50cy4gVGhpcyBmaWxlIGFsc28gaW5jbHVkZXMgbW91c2VlbnRlciBhbmQgbW91c2VsZWF2ZSBjdXN0b20gRWxlbWVudCBFdmVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgRXZlbnRdCgpwcm92aWRlczogRWxlbWVudC5FdmVudAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCkVsZW1lbnQuUHJvcGVydGllcy5ldmVudHMgPSB7c2V0OiBmdW5jdGlvbihldmVudHMpewoJdGhpcy5hZGRFdmVudHMoZXZlbnRzKTsKfX07CgpbRWxlbWVudCwgV2luZG93LCBEb2N1bWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl2YXIgZXZlbnRzID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJywge30pOwoJCWlmICghZXZlbnRzW3R5cGVdKSBldmVudHNbdHlwZV0gPSB7a2V5czogW10sIHZhbHVlczogW119OwoJCWlmIChldmVudHNbdHlwZV0ua2V5cy5jb250YWlucyhmbikpIHJldHVybiB0aGlzOwoJCWV2ZW50c1t0eXBlXS5rZXlzLnB1c2goZm4pOwoJCXZhciByZWFsVHlwZSA9IHR5cGUsCgkJCWN1c3RvbSA9IEVsZW1lbnQuRXZlbnRzW3R5cGVdLAoJCQljb25kaXRpb24gPSBmbiwKCQkJc2VsZiA9IHRoaXM7CgkJaWYgKGN1c3RvbSl7CgkJCWlmIChjdXN0b20ub25BZGQpIGN1c3RvbS5vbkFkZC5jYWxsKHRoaXMsIGZuKTsKCQkJaWYgKGN1c3RvbS5jb25kaXRpb24pewoJCQkJY29uZGl0aW9uID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWlmIChjdXN0b20uY29uZGl0aW9uLmNhbGwodGhpcywgZXZlbnQpKSByZXR1cm4gZm4uY2FsbCh0aGlzLCBldmVudCk7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9OwoJCQl9CgkJCXJlYWxUeXBlID0gY3VzdG9tLmJhc2UgfHwgcmVhbFR5cGU7CgkJfQoJCXZhciBkZWZuID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIGZuLmNhbGwoc2VsZik7CgkJfTsKCQl2YXIgbmF0aXZlRXZlbnQgPSBFbGVtZW50Lk5hdGl2ZUV2ZW50c1tyZWFsVHlwZV07CgkJaWYgKG5hdGl2ZUV2ZW50KXsKCQkJaWYgKG5hdGl2ZUV2ZW50ID09IDIpewoJCQkJZGVmbiA9IGZ1bmN0aW9uKGV2ZW50KXsKCQkJCQlldmVudCA9IG5ldyBFdmVudChldmVudCwgc2VsZi5nZXRXaW5kb3coKSk7CgkJCQkJaWYgKGNvbmRpdGlvbi5jYWxsKHNlbGYsIGV2ZW50KSA9PT0gZmFsc2UpIGV2ZW50LnN0b3AoKTsKCQkJCX07CgkJCX0KCQkJdGhpcy5hZGRMaXN0ZW5lcihyZWFsVHlwZSwgZGVmbiwgYXJndW1lbnRzWzJdKTsKCQl9CgkJZXZlbnRzW3R5cGVdLnZhbHVlcy5wdXNoKGRlZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQl2YXIgbGlzdCA9IGV2ZW50c1t0eXBlXTsKCQl2YXIgaW5kZXggPSBsaXN0LmtleXMuaW5kZXhPZihmbik7CgkJaWYgKGluZGV4ID09IC0xKSByZXR1cm4gdGhpczsKCQl2YXIgdmFsdWUgPSBsaXN0LnZhbHVlc1tpbmRleF07CgkJZGVsZXRlIGxpc3Qua2V5c1tpbmRleF07CgkJZGVsZXRlIGxpc3QudmFsdWVzW2luZGV4XTsKCQl2YXIgY3VzdG9tID0gRWxlbWVudC5FdmVudHNbdHlwZV07CgkJaWYgKGN1c3RvbSl7CgkJCWlmIChjdXN0b20ub25SZW1vdmUpIGN1c3RvbS5vblJlbW92ZS5jYWxsKHRoaXMsIGZuKTsKCQkJdHlwZSA9IGN1c3RvbS5iYXNlIHx8IHR5cGU7CgkJfQoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHNbdHlwZV0pID8gdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCB2YWx1ZSwgYXJndW1lbnRzWzJdKSA6IHRoaXM7Cgl9LAoKCWFkZEV2ZW50czogZnVuY3Rpb24oZXZlbnRzKXsKCQlmb3IgKHZhciBldmVudCBpbiBldmVudHMpIHRoaXMuYWRkRXZlbnQoZXZlbnQsIGV2ZW50c1tldmVudF0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJdmFyIGF0dGFjaGVkID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJyk7CgkJaWYgKCFhdHRhY2hlZCkgcmV0dXJuIHRoaXM7CgkJaWYgKCFldmVudHMpewoJCQlmb3IgKHR5cGUgaW4gYXR0YWNoZWQpIHRoaXMucmVtb3ZlRXZlbnRzKHR5cGUpOwoJCQl0aGlzLmVsaW1pbmF0ZSgnZXZlbnRzJyk7CgkJfSBlbHNlIGlmIChhdHRhY2hlZFtldmVudHNdKXsKCQkJYXR0YWNoZWRbZXZlbnRzXS5rZXlzLmVhY2goZnVuY3Rpb24oZm4pewoJCQkJdGhpcy5yZW1vdmVFdmVudChldmVudHMsIGZuKTsKCQkJfSwgdGhpcyk7CgkJCWRlbGV0ZSBhdHRhY2hlZFtldmVudHNdOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJZmlyZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBhcmdzLCBkZWxheSl7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzIHx8ICFldmVudHNbdHlwZV0pIHJldHVybiB0aGlzOwoJCWFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoKCQlldmVudHNbdHlwZV0ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJaWYgKGRlbGF5KSBmbi5kZWxheShkZWxheSwgdGhpcywgYXJncyk7CgkJCWVsc2UgZm4uYXBwbHkodGhpcywgYXJncyk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb25lRXZlbnRzOiBmdW5jdGlvbihmcm9tLCB0eXBlKXsKCQlmcm9tID0gZG9jdW1lbnQuaWQoZnJvbSk7CgkJdmFyIGV2ZW50cyA9IGZyb20ucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlpZiAoIXR5cGUpewoJCQlmb3IgKHZhciBldmVudFR5cGUgaW4gZXZlbnRzKSB0aGlzLmNsb25lRXZlbnRzKGZyb20sIGV2ZW50VHlwZSk7CgkJfSBlbHNlIGlmIChldmVudHNbdHlwZV0pewoJCQlldmVudHNbdHlwZV0ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMuYWRkRXZlbnQodHlwZSwgZm4pOwoJCQl9LCB0aGlzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkVsZW1lbnQuTmF0aXZlRXZlbnRzID0gewoJY2xpY2s6IDIsIGRibGNsaWNrOiAyLCBtb3VzZXVwOiAyLCBtb3VzZWRvd246IDIsIGNvbnRleHRtZW51OiAyLCAvL21vdXNlIGJ1dHRvbnMKCW1vdXNld2hlZWw6IDIsIERPTU1vdXNlU2Nyb2xsOiAyLCAvL21vdXNlIHdoZWVsCgltb3VzZW92ZXI6IDIsIG1vdXNlb3V0OiAyLCBtb3VzZW1vdmU6IDIsIHNlbGVjdHN0YXJ0OiAyLCBzZWxlY3RlbmQ6IDIsIC8vbW91c2UgbW92ZW1lbnQKCWtleWRvd246IDIsIGtleXByZXNzOiAyLCBrZXl1cDogMiwgLy9rZXlib2FyZAoJb3JpZW50YXRpb25jaGFuZ2U6IDIsIC8vIG1vYmlsZQoJdG91Y2hzdGFydDogMiwgdG91Y2htb3ZlOiAyLCB0b3VjaGVuZDogMiwgdG91Y2hjYW5jZWw6IDIsIC8vIHRvdWNoCglnZXN0dXJlc3RhcnQ6IDIsIGdlc3R1cmVjaGFuZ2U6IDIsIGdlc3R1cmVlbmQ6IDIsIC8vIGdlc3R1cmUKCWZvY3VzOiAyLCBibHVyOiAyLCBjaGFuZ2U6IDIsIHJlc2V0OiAyLCBzZWxlY3Q6IDIsIHN1Ym1pdDogMiwgLy9mb3JtIGVsZW1lbnRzCglsb2FkOiAyLCB1bmxvYWQ6IDEsIGJlZm9yZXVubG9hZDogMiwgcmVzaXplOiAxLCBtb3ZlOiAxLCBET01Db250ZW50TG9hZGVkOiAxLCByZWFkeXN0YXRlY2hhbmdlOiAxLCAvL3dpbmRvdwoJZXJyb3I6IDEsIGFib3J0OiAxLCBzY3JvbGw6IDEgLy9taXNjCn07Cgp2YXIgY2hlY2sgPSBmdW5jdGlvbihldmVudCl7Cgl2YXIgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CglpZiAocmVsYXRlZCA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKCWlmICghcmVsYXRlZCkgcmV0dXJuIGZhbHNlOwoJcmV0dXJuIChyZWxhdGVkICE9IHRoaXMgJiYgcmVsYXRlZC5wcmVmaXggIT0gJ3h1bCcgJiYgdHlwZU9mKHRoaXMpICE9ICdkb2N1bWVudCcgJiYgIXRoaXMuY29udGFpbnMocmVsYXRlZCkpOwp9OwoKRWxlbWVudC5FdmVudHMgPSB7CgoJbW91c2VlbnRlcjogewoJCWJhc2U6ICdtb3VzZW92ZXInLAoJCWNvbmRpdGlvbjogY2hlY2sKCX0sCgoJbW91c2VsZWF2ZTogewoJCWJhc2U6ICdtb3VzZW91dCcsCgkJY29uZGl0aW9uOiBjaGVjawoJfSwKCgltb3VzZXdoZWVsOiB7CgkJYmFzZTogKEJyb3dzZXIuZmlyZWZveCkgPyAnRE9NTW91c2VTY3JvbGwnIDogJ21vdXNld2hlZWwnCgl9Cgp9OwoKfSkuY2FsbCh0aGlzKTsKCi8qCi0tLQoKbmFtZTogRWxlbWVudC5EaW1lbnNpb25zCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgbWV0aG9kcyB0byB3b3JrIHdpdGggc2l6ZSwgc2Nyb2xsLCBvciBwb3NpdGlvbmluZyBvZiBFbGVtZW50cyBhbmQgdGhlIHdpbmRvdyBvYmplY3QuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBFbGVtZW50IHBvc2l0aW9uaW5nIGJhc2VkIG9uIHRoZSBbcW9veGRvb10oaHR0cDovL3Fvb3hkb28ub3JnLykgY29kZSBhbmQgc21hcnQgYnJvd3NlciBmaXhlcywgW0xHUEwgTGljZW5zZV0oaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2xncGwuaHRtbCkuCiAgLSBWaWV3cG9ydCBkaW1lbnNpb25zIGJhc2VkIG9uIFtZVUldKGh0dHA6Ly9kZXZlbG9wZXIueWFob28uY29tL3l1aS8pIGNvZGUsIFtCU0QgTGljZW5zZV0oaHR0cDovL2RldmVsb3Blci55YWhvby5jb20veXVpL2xpY2Vuc2UuaHRtbCkuCgpyZXF1aXJlczogW0VsZW1lbnQsIEVsZW1lbnQuU3R5bGVdCgpwcm92aWRlczogW0VsZW1lbnQuRGltZW5zaW9uc10KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAoJY2hpbGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKZWxlbWVudC5zdHlsZS5oZWlnaHQgPSAnMCc7CmVsZW1lbnQuYXBwZW5kQ2hpbGQoY2hpbGQpOwp2YXIgYnJva2VuT2Zmc2V0UGFyZW50ID0gKGNoaWxkLm9mZnNldFBhcmVudCA9PT0gZWxlbWVudCk7CmVsZW1lbnQgPSBjaGlsZCA9IG51bGw7Cgp2YXIgaXNPZmZzZXQgPSBmdW5jdGlvbihlbCl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWwsICdwb3NpdGlvbicpICE9ICdzdGF0aWMnIHx8IGlzQm9keShlbCk7Cn07Cgp2YXIgaXNPZmZzZXRTdGF0aWMgPSBmdW5jdGlvbihlbCl7CglyZXR1cm4gaXNPZmZzZXQoZWwpIHx8ICgvXig/OnRhYmxlfHRkfHRoKSQvaSkudGVzdChlbC50YWdOYW1lKTsKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzY3JvbGxUbzogZnVuY3Rpb24oeCwgeSl7CgkJaWYgKGlzQm9keSh0aGlzKSl7CgkJCXRoaXMuZ2V0V2luZG93KCkuc2Nyb2xsVG8oeCwgeSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5zY3JvbGxMZWZ0ID0geDsKCQkJdGhpcy5zY3JvbGxUb3AgPSB5OwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0U2l6ZTogZnVuY3Rpb24oKXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gdGhpcy5nZXRXaW5kb3coKS5nZXRTaXplKCk7CgkJcmV0dXJuIHt4OiB0aGlzLm9mZnNldFdpZHRoLCB5OiB0aGlzLm9mZnNldEhlaWdodH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2Nyb2xsU2l6ZSgpOwoJCXJldHVybiB7eDogdGhpcy5zY3JvbGxXaWR0aCwgeTogdGhpcy5zY3JvbGxIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGw6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2Nyb2xsKCk7CgkJcmV0dXJuIHt4OiB0aGlzLnNjcm9sbExlZnQsIHk6IHRoaXMuc2Nyb2xsVG9wfTsKCX0sCgoJZ2V0U2Nyb2xsczogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXMucGFyZW50Tm9kZSwgcG9zaXRpb24gPSB7eDogMCwgeTogMH07CgkJd2hpbGUgKGVsZW1lbnQgJiYgIWlzQm9keShlbGVtZW50KSl7CgkJCXBvc2l0aW9uLnggKz0gZWxlbWVudC5zY3JvbGxMZWZ0OwoJCQlwb3NpdGlvbi55ICs9IGVsZW1lbnQuc2Nyb2xsVG9wOwoJCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldE9mZnNldFBhcmVudDogYnJva2VuT2Zmc2V0UGFyZW50ID8gZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXM7CgkJaWYgKGlzQm9keShlbGVtZW50KSB8fCBzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSByZXR1cm4gbnVsbDsKCgkJdmFyIGlzT2Zmc2V0Q2hlY2sgPSAoc3R5bGVTdHJpbmcoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT0gJ3N0YXRpYycpID8gaXNPZmZzZXRTdGF0aWMgOiBpc09mZnNldDsKCQl3aGlsZSAoKGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGUpKXsKCQkJaWYgKGlzT2Zmc2V0Q2hlY2soZWxlbWVudCkpIHJldHVybiBlbGVtZW50OwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0gOiBmdW5jdGlvbigpewoJCXZhciBlbGVtZW50ID0gdGhpczsKCQlpZiAoaXNCb2R5KGVsZW1lbnQpIHx8IHN0eWxlU3RyaW5nKGVsZW1lbnQsICdwb3NpdGlvbicpID09ICdmaXhlZCcpIHJldHVybiBudWxsOwoKCQl0cnkgewoJCQlyZXR1cm4gZWxlbWVudC5vZmZzZXRQYXJlbnQ7CgkJfSBjYXRjaChlKSB7fQoJCXJldHVybiBudWxsOwoJfSwKCglnZXRPZmZzZXRzOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCAmJiAhQnJvd3Nlci5QbGF0Zm9ybS5pb3MpewoJCQl2YXIgYm91bmQgPSB0aGlzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLAoJCQkJaHRtbCA9IGRvY3VtZW50LmlkKHRoaXMuZ2V0RG9jdW1lbnQoKS5kb2N1bWVudEVsZW1lbnQpLAoJCQkJaHRtbFNjcm9sbCA9IGh0bWwuZ2V0U2Nyb2xsKCksCgkJCQllbGVtU2Nyb2xscyA9IHRoaXMuZ2V0U2Nyb2xscygpLAoJCQkJaXNGaXhlZCA9IChzdHlsZVN0cmluZyh0aGlzLCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKTsKCgkJCXJldHVybiB7CgkJCQl4OiBib3VuZC5sZWZ0LnRvSW50KCkgKyBlbGVtU2Nyb2xscy54ICsgKChpc0ZpeGVkKSA/IDAgOiBodG1sU2Nyb2xsLngpIC0gaHRtbC5jbGllbnRMZWZ0LAoJCQkJeTogYm91bmQudG9wLnRvSW50KCkgICsgZWxlbVNjcm9sbHMueSArICgoaXNGaXhlZCkgPyAwIDogaHRtbFNjcm9sbC55KSAtIGh0bWwuY2xpZW50VG9wCgkJCX07CgkJfQoKCQl2YXIgZWxlbWVudCA9IHRoaXMsIHBvc2l0aW9uID0ge3g6IDAsIHk6IDB9OwoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiBwb3NpdGlvbjsKCgkJd2hpbGUgKGVsZW1lbnQgJiYgIWlzQm9keShlbGVtZW50KSl7CgkJCXBvc2l0aW9uLnggKz0gZWxlbWVudC5vZmZzZXRMZWZ0OwoJCQlwb3NpdGlvbi55ICs9IGVsZW1lbnQub2Zmc2V0VG9wOwoKCQkJaWYgKEJyb3dzZXIuZmlyZWZveCl7CgkJCQlpZiAoIWJvcmRlckJveChlbGVtZW50KSl7CgkJCQkJcG9zaXRpb24ueCArPSBsZWZ0Qm9yZGVyKGVsZW1lbnQpOwoJCQkJCXBvc2l0aW9uLnkgKz0gdG9wQm9yZGVyKGVsZW1lbnQpOwoJCQkJfQoJCQkJdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQkJCWlmIChwYXJlbnQgJiYgc3R5bGVTdHJpbmcocGFyZW50LCAnb3ZlcmZsb3cnKSAhPSAndmlzaWJsZScpewoJCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihwYXJlbnQpOwoJCQkJCXBvc2l0aW9uLnkgKz0gdG9wQm9yZGVyKHBhcmVudCk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoZWxlbWVudCAhPSB0aGlzICYmIEJyb3dzZXIuc2FmYXJpKXsKCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihlbGVtZW50KTsKCQkJCXBvc2l0aW9uLnkgKz0gdG9wQm9yZGVyKGVsZW1lbnQpOwoJCQl9CgoJCQllbGVtZW50ID0gZWxlbWVudC5vZmZzZXRQYXJlbnQ7CgkJfQoJCWlmIChCcm93c2VyLmZpcmVmb3ggJiYgIWJvcmRlckJveCh0aGlzKSl7CgkJCXBvc2l0aW9uLnggLT0gbGVmdEJvcmRlcih0aGlzKTsKCQkJcG9zaXRpb24ueSAtPSB0b3BCb3JkZXIodGhpcyk7CgkJfQoJCXJldHVybiBwb3NpdGlvbjsKCX0sCgoJZ2V0UG9zaXRpb246IGZ1bmN0aW9uKHJlbGF0aXZlKXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4ge3g6IDAsIHk6IDB9OwoJCXZhciBvZmZzZXQgPSB0aGlzLmdldE9mZnNldHMoKSwKCQkJc2Nyb2xsID0gdGhpcy5nZXRTY3JvbGxzKCk7CgkJdmFyIHBvc2l0aW9uID0gewoJCQl4OiBvZmZzZXQueCAtIHNjcm9sbC54LAoJCQl5OiBvZmZzZXQueSAtIHNjcm9sbC55CgkJfTsKCgkJaWYgKHJlbGF0aXZlICYmIChyZWxhdGl2ZSA9IGRvY3VtZW50LmlkKHJlbGF0aXZlKSkpewoJCQl2YXIgcmVsYXRpdmVQb3NpdGlvbiA9IHJlbGF0aXZlLmdldFBvc2l0aW9uKCk7CgkJCXJldHVybiB7eDogcG9zaXRpb24ueCAtIHJlbGF0aXZlUG9zaXRpb24ueCAtIGxlZnRCb3JkZXIocmVsYXRpdmUpLCB5OiBwb3NpdGlvbi55IC0gcmVsYXRpdmVQb3NpdGlvbi55IC0gdG9wQm9yZGVyKHJlbGF0aXZlKX07CgkJfQoJCXJldHVybiBwb3NpdGlvbjsKCX0sCgoJZ2V0Q29vcmRpbmF0ZXM6IGZ1bmN0aW9uKGVsZW1lbnQpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldENvb3JkaW5hdGVzKCk7CgkJdmFyIHBvc2l0aW9uID0gdGhpcy5nZXRQb3NpdGlvbihlbGVtZW50KSwKCQkJc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXZhciBvYmogPSB7CgkJCWxlZnQ6IHBvc2l0aW9uLngsCgkJCXRvcDogcG9zaXRpb24ueSwKCQkJd2lkdGg6IHNpemUueCwKCQkJaGVpZ2h0OiBzaXplLnkKCQl9OwoJCW9iai5yaWdodCA9IG9iai5sZWZ0ICsgb2JqLndpZHRoOwoJCW9iai5ib3R0b20gPSBvYmoudG9wICsgb2JqLmhlaWdodDsKCQlyZXR1cm4gb2JqOwoJfSwKCgljb21wdXRlUG9zaXRpb246IGZ1bmN0aW9uKG9iail7CgkJcmV0dXJuIHsKCQkJbGVmdDogb2JqLnggLSBzdHlsZU51bWJlcih0aGlzLCAnbWFyZ2luLWxlZnQnKSwKCQkJdG9wOiBvYmoueSAtIHN0eWxlTnVtYmVyKHRoaXMsICdtYXJnaW4tdG9wJykKCQl9OwoJfSwKCglzZXRQb3NpdGlvbjogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gdGhpcy5zZXRTdHlsZXModGhpcy5jb21wdXRlUG9zaXRpb24ob2JqKSk7Cgl9Cgp9KTsKCltEb2N1bWVudCwgV2luZG93XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglnZXRTaXplOiBmdW5jdGlvbigpewoJCXZhciBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogZG9jLmNsaWVudFdpZHRoLCB5OiBkb2MuY2xpZW50SGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCXZhciB3aW4gPSB0aGlzLmdldFdpbmRvdygpLCBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogd2luLnBhZ2VYT2Zmc2V0IHx8IGRvYy5zY3JvbGxMZWZ0LCB5OiB3aW4ucGFnZVlPZmZzZXQgfHwgZG9jLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJdmFyIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyksCgkJCW1pbiA9IHRoaXMuZ2V0U2l6ZSgpLAoJCQlib2R5ID0gdGhpcy5nZXREb2N1bWVudCgpLmJvZHk7CgoJCXJldHVybiB7eDogTWF0aC5tYXgoZG9jLnNjcm9sbFdpZHRoLCBib2R5LnNjcm9sbFdpZHRoLCBtaW4ueCksIHk6IE1hdGgubWF4KGRvYy5zY3JvbGxIZWlnaHQsIGJvZHkuc2Nyb2xsSGVpZ2h0LCBtaW4ueSl9OwoJfSwKCglnZXRQb3NpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4ge3g6IDAsIHk6IDB9OwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oKXsKCQl2YXIgc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXJldHVybiB7dG9wOiAwLCBsZWZ0OiAwLCBib3R0b206IHNpemUueSwgcmlnaHQ6IHNpemUueCwgaGVpZ2h0OiBzaXplLnksIHdpZHRoOiBzaXplLnh9OwoJfQoKfSk7CgovLyBwcml2YXRlIG1ldGhvZHMKCnZhciBzdHlsZVN0cmluZyA9IEVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZTsKCmZ1bmN0aW9uIHN0eWxlTnVtYmVyKGVsZW1lbnQsIHN0eWxlKXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCBzdHlsZSkudG9JbnQoKSB8fCAwOwp9CgpmdW5jdGlvbiBib3JkZXJCb3goZWxlbWVudCl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWxlbWVudCwgJy1tb3otYm94LXNpemluZycpID09ICdib3JkZXItYm94JzsKfQoKZnVuY3Rpb24gdG9wQm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItdG9wLXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGxlZnRCb3JkZXIoZWxlbWVudCl7CglyZXR1cm4gc3R5bGVOdW1iZXIoZWxlbWVudCwgJ2JvcmRlci1sZWZ0LXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGlzQm9keShlbGVtZW50KXsKCXJldHVybiAoL14oPzpib2R5fGh0bWwpJC9pKS50ZXN0KGVsZW1lbnQudGFnTmFtZSk7Cn0KCmZ1bmN0aW9uIGdldENvbXBhdEVsZW1lbnQoZWxlbWVudCl7Cgl2YXIgZG9jID0gZWxlbWVudC5nZXREb2N1bWVudCgpOwoJcmV0dXJuICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7Cn0KCn0pLmNhbGwodGhpcyk7CgovL2FsaWFzZXMKRWxlbWVudC5hbGlhcyh7cG9zaXRpb246ICdzZXRQb3NpdGlvbid9KTsgLy9jb21wYXRhYmlsaXR5CgpbV2luZG93LCBEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0SGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNpemUoKS55OwoJfSwKCglnZXRXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTaXplKCkueDsKCX0sCgoJZ2V0U2Nyb2xsVG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbCgpLnk7Cgl9LAoKCWdldFNjcm9sbExlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsKCkueDsKCX0sCgoJZ2V0U2Nyb2xsSGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbFNpemUoKS55OwoJfSwKCglnZXRTY3JvbGxXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGxTaXplKCkueDsKCX0sCgoJZ2V0VG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKCkueTsKCX0sCgoJZ2V0TGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbigpLng7Cgl9Cgp9KTsKCi8qCi0tLQoKbmFtZTogRngKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgYmFzaWMgYW5pbWF0aW9uIGxvZ2ljIHRvIGJlIGV4dGVuZGVkIGJ5IGFsbCBvdGhlciBGeCBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdCgpwcm92aWRlczogRngKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgRnggPSB0aGlzLkZ4ID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBbQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10sCgoJb3B0aW9uczogewoJCS8qCgkJb25TdGFydDogbmlsLAoJCW9uQ2FuY2VsOiBuaWwsCgkJb25Db21wbGV0ZTogbmlsLAoJCSovCgkJZnBzOiA2MCwKCQl1bml0OiBmYWxzZSwKCQlkdXJhdGlvbjogNTAwLAoJCWZyYW1lczogbnVsbCwKCQlmcmFtZVNraXA6IHRydWUsCgkJbGluazogJ2lnbm9yZScKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5zdWJqZWN0ID0gdGhpcy5zdWJqZWN0IHx8IHRoaXM7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXJldHVybiBmdW5jdGlvbihwKXsKCQkJcmV0dXJuIC0oTWF0aC5jb3MoTWF0aC5QSSAqIHApIC0gMSkgLyAyOwoJCX07Cgl9LAoKCXN0ZXA6IGZ1bmN0aW9uKG5vdyl7CgkJaWYgKHRoaXMub3B0aW9ucy5mcmFtZVNraXApewoJCQl2YXIgZGlmZiA9ICh0aGlzLnRpbWUgIT0gbnVsbCkgPyAobm93IC0gdGhpcy50aW1lKSA6IDAsIGZyYW1lcyA9IGRpZmYgLyB0aGlzLmZyYW1lSW50ZXJ2YWw7CgkJCXRoaXMudGltZSA9IG5vdzsKCQkJdGhpcy5mcmFtZSArPSBmcmFtZXM7CgkJfSBlbHNlIHsKCQkJdGhpcy5mcmFtZSsrOwoJCX0KCgkJaWYgKHRoaXMuZnJhbWUgPCB0aGlzLmZyYW1lcyl7CgkJCXZhciBkZWx0YSA9IHRoaXMudHJhbnNpdGlvbih0aGlzLmZyYW1lIC8gdGhpcy5mcmFtZXMpOwoJCQl0aGlzLnNldCh0aGlzLmNvbXB1dGUodGhpcy5mcm9tLCB0aGlzLnRvLCBkZWx0YSkpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZnJhbWUgPSB0aGlzLmZyYW1lczsKCQkJdGhpcy5zZXQodGhpcy5jb21wdXRlKHRoaXMuZnJvbSwgdGhpcy50bywgMSkpOwoJCQl0aGlzLnN0b3AoKTsKCQl9Cgl9LAoKCXNldDogZnVuY3Rpb24obm93KXsKCQlyZXR1cm4gbm93OwoJfSwKCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXJldHVybiBGeC5jb21wdXRlKGZyb20sIHRvLCBkZWx0YSk7Cgl9LAoKCWNoZWNrOiBmdW5jdGlvbigpewoJCWlmICghdGhpcy5pc1J1bm5pbmcoKSkgcmV0dXJuIHRydWU7CgkJc3dpdGNoICh0aGlzLm9wdGlvbnMubGluayl7CgkJCWNhc2UgJ2NhbmNlbCc6IHRoaXMuY2FuY2VsKCk7IHJldHVybiB0cnVlOwoJCQljYXNlICdjaGFpbic6IHRoaXMuY2hhaW4odGhpcy5jYWxsZXIucGFzcyhhcmd1bWVudHMsIHRoaXMpKTsgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihmcm9tLCB0byl7CgkJaWYgKCF0aGlzLmNoZWNrKGZyb20sIHRvKSkgcmV0dXJuIHRoaXM7CgkJdGhpcy5mcm9tID0gZnJvbTsKCQl0aGlzLnRvID0gdG87CgkJdGhpcy5mcmFtZSA9ICh0aGlzLm9wdGlvbnMuZnJhbWVTa2lwKSA/IDAgOiAtMTsKCQl0aGlzLnRpbWUgPSBudWxsOwoJCXRoaXMudHJhbnNpdGlvbiA9IHRoaXMuZ2V0VHJhbnNpdGlvbigpOwoJCXZhciBmcmFtZXMgPSB0aGlzLm9wdGlvbnMuZnJhbWVzLCBmcHMgPSB0aGlzLm9wdGlvbnMuZnBzLCBkdXJhdGlvbiA9IHRoaXMub3B0aW9ucy5kdXJhdGlvbjsKCQl0aGlzLmR1cmF0aW9uID0gRnguRHVyYXRpb25zW2R1cmF0aW9uXSB8fCBkdXJhdGlvbi50b0ludCgpOwoJCXRoaXMuZnJhbWVJbnRlcnZhbCA9IDEwMDAgLyBmcHM7CgkJdGhpcy5mcmFtZXMgPSBmcmFtZXMgfHwgTWF0aC5yb3VuZCh0aGlzLmR1cmF0aW9uIC8gdGhpcy5mcmFtZUludGVydmFsKTsKCQl0aGlzLmZpcmVFdmVudCgnc3RhcnQnLCB0aGlzLnN1YmplY3QpOwoJCXB1c2hJbnN0YW5jZS5jYWxsKHRoaXMsIGZwcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQkJaWYgKHRoaXMuZnJhbWVzID09IHRoaXMuZnJhbWUpewoJCQkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJywgdGhpcy5zdWJqZWN0KTsKCQkJCWlmICghdGhpcy5jYWxsQ2hhaW4oKSkgdGhpcy5maXJlRXZlbnQoJ2NoYWluQ29tcGxldGUnLCB0aGlzLnN1YmplY3QpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5maXJlRXZlbnQoJ3N0b3AnLCB0aGlzLnN1YmplY3QpOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgljYW5jZWw6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQkJdGhpcy5mcmFtZSA9IHRoaXMuZnJhbWVzOwoJCQl0aGlzLmZpcmVFdmVudCgnY2FuY2VsJywgdGhpcy5zdWJqZWN0KS5jbGVhckNoYWluKCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglwYXVzZTogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5pc1J1bm5pbmcoKSl7CgkJCXRoaXMudGltZSA9IG51bGw7CgkJCXB1bGxJbnN0YW5jZS5jYWxsKHRoaXMsIHRoaXMub3B0aW9ucy5mcHMpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVzdW1lOiBmdW5jdGlvbigpewoJCWlmICgodGhpcy5mcmFtZSA8IHRoaXMuZnJhbWVzKSAmJiAhdGhpcy5pc1J1bm5pbmcoKSkgcHVzaEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWlzUnVubmluZzogZnVuY3Rpb24oKXsKCQl2YXIgbGlzdCA9IGluc3RhbmNlc1t0aGlzLm9wdGlvbnMuZnBzXTsKCQlyZXR1cm4gbGlzdCAmJiBsaXN0LmNvbnRhaW5zKHRoaXMpOwoJfQoKfSk7CgpGeC5jb21wdXRlID0gZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCXJldHVybiAodG8gLSBmcm9tKSAqIGRlbHRhICsgZnJvbTsKfTsKCkZ4LkR1cmF0aW9ucyA9IHsnc2hvcnQnOiAyNTAsICdub3JtYWwnOiA1MDAsICdsb25nJzogMTAwMH07CgovLyBnbG9iYWwgdGltZXJzCgp2YXIgaW5zdGFuY2VzID0ge30sIHRpbWVycyA9IHt9OwoKdmFyIGxvb3AgPSBmdW5jdGlvbigpewoJdmFyIG5vdyA9IERhdGUubm93KCk7Cglmb3IgKHZhciBpID0gdGhpcy5sZW5ndGg7IGktLTspewoJCXZhciBpbnN0YW5jZSA9IHRoaXNbaV07CgkJaWYgKGluc3RhbmNlKSBpbnN0YW5jZS5zdGVwKG5vdyk7Cgl9Cn07Cgp2YXIgcHVzaEluc3RhbmNlID0gZnVuY3Rpb24oZnBzKXsKCXZhciBsaXN0ID0gaW5zdGFuY2VzW2Zwc10gfHwgKGluc3RhbmNlc1tmcHNdID0gW10pOwoJbGlzdC5wdXNoKHRoaXMpOwoJaWYgKCF0aW1lcnNbZnBzXSkgdGltZXJzW2Zwc10gPSBsb29wLnBlcmlvZGljYWwoTWF0aC5yb3VuZCgxMDAwIC8gZnBzKSwgbGlzdCk7Cn07Cgp2YXIgcHVsbEluc3RhbmNlID0gZnVuY3Rpb24oZnBzKXsKCXZhciBsaXN0ID0gaW5zdGFuY2VzW2Zwc107CglpZiAobGlzdCl7CgkJbGlzdC5lcmFzZSh0aGlzKTsKCQlpZiAoIWxpc3QubGVuZ3RoICYmIHRpbWVyc1tmcHNdKXsKCQkJZGVsZXRlIGluc3RhbmNlc1tmcHNdOwoJCQl0aW1lcnNbZnBzXSA9IGNsZWFySW50ZXJ2YWwodGltZXJzW2Zwc10pOwoJCX0KCX0KfTsKCn0pLmNhbGwodGhpcyk7CgovKgotLS0KCm5hbWU6IEZ4LkNTUwoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBDU1MgYW5pbWF0aW9uIGxvZ2ljLiBVc2VkIGJ5IEZ4LlR3ZWVuLCBGeC5Nb3JwaCwgRnguRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRngsIEVsZW1lbnQuU3R5bGVdCgpwcm92aWRlczogRnguQ1NTCgouLi4KKi8KCkZ4LkNTUyA9IG5ldyBDbGFzcyh7CgoJRXh0ZW5kczogRngsCgoJLy9wcmVwYXJlcyB0aGUgYmFzZSBmcm9tL3RvIG9iamVjdAoKCXByZXBhcmU6IGZ1bmN0aW9uKGVsZW1lbnQsIHByb3BlcnR5LCB2YWx1ZXMpewoJCXZhbHVlcyA9IEFycmF5LmZyb20odmFsdWVzKTsKCQlpZiAodmFsdWVzWzFdID09IG51bGwpewoJCQl2YWx1ZXNbMV0gPSB2YWx1ZXNbMF07CgkJCXZhbHVlc1swXSA9IGVsZW1lbnQuZ2V0U3R5bGUocHJvcGVydHkpOwoJCX0KCQl2YXIgcGFyc2VkID0gdmFsdWVzLm1hcCh0aGlzLnBhcnNlKTsKCQlyZXR1cm4ge2Zyb206IHBhcnNlZFswXSwgdG86IHBhcnNlZFsxXX07Cgl9LAoKCS8vcGFyc2VzIGEgdmFsdWUgaW50byBhbiBhcnJheQoKCXBhcnNlOiBmdW5jdGlvbih2YWx1ZSl7CgkJdmFsdWUgPSBGdW5jdGlvbi5mcm9tKHZhbHVlKSgpOwoJCXZhbHVlID0gKHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJykgPyB2YWx1ZS5zcGxpdCgnICcpIDogQXJyYXkuZnJvbSh2YWx1ZSk7CgkJcmV0dXJuIHZhbHVlLm1hcChmdW5jdGlvbih2YWwpewoJCQl2YWwgPSBTdHJpbmcodmFsKTsKCQkJdmFyIGZvdW5kID0gZmFsc2U7CgkJCU9iamVjdC5lYWNoKEZ4LkNTUy5QYXJzZXJzLCBmdW5jdGlvbihwYXJzZXIsIGtleSl7CgkJCQlpZiAoZm91bmQpIHJldHVybjsKCQkJCXZhciBwYXJzZWQgPSBwYXJzZXIucGFyc2UodmFsKTsKCQkJCWlmIChwYXJzZWQgfHwgcGFyc2VkID09PSAwKSBmb3VuZCA9IHt2YWx1ZTogcGFyc2VkLCBwYXJzZXI6IHBhcnNlcn07CgkJCX0pOwoJCQlmb3VuZCA9IGZvdW5kIHx8IHt2YWx1ZTogdmFsLCBwYXJzZXI6IEZ4LkNTUy5QYXJzZXJzLlN0cmluZ307CgkJCXJldHVybiBmb3VuZDsKCQl9KTsKCX0sCgoJLy9jb21wdXRlcyBieSBhIGZyb20gYW5kIHRvIHByZXBhcmVkIG9iamVjdHMsIHVzaW5nIHRoZWlyIHBhcnNlcnMuCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgY29tcHV0ZWQgPSBbXTsKCQkoTWF0aC5taW4oZnJvbS5sZW5ndGgsIHRvLmxlbmd0aCkpLnRpbWVzKGZ1bmN0aW9uKGkpewoJCQljb21wdXRlZC5wdXNoKHt2YWx1ZTogZnJvbVtpXS5wYXJzZXIuY29tcHV0ZShmcm9tW2ldLnZhbHVlLCB0b1tpXS52YWx1ZSwgZGVsdGEpLCBwYXJzZXI6IGZyb21baV0ucGFyc2VyfSk7CgkJfSk7CgkJY29tcHV0ZWQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2Z4OmNzczp2YWx1ZScpOwoJCXJldHVybiBjb21wdXRlZDsKCX0sCgoJLy9zZXJ2ZXMgdGhlIHZhbHVlIGFzIHNldHRhYmxlCgoJc2VydmU6IGZ1bmN0aW9uKHZhbHVlLCB1bml0KXsKCQlpZiAodHlwZU9mKHZhbHVlKSAhPSAnZng6Y3NzOnZhbHVlJykgdmFsdWUgPSB0aGlzLnBhcnNlKHZhbHVlKTsKCQl2YXIgcmV0dXJuZWQgPSBbXTsKCQl2YWx1ZS5lYWNoKGZ1bmN0aW9uKGJpdCl7CgkJCXJldHVybmVkID0gcmV0dXJuZWQuY29uY2F0KGJpdC5wYXJzZXIuc2VydmUoYml0LnZhbHVlLCB1bml0KSk7CgkJfSk7CgkJcmV0dXJuIHJldHVybmVkOwoJfSwKCgkvL3JlbmRlcnMgdGhlIGNoYW5nZSB0byBhbiBlbGVtZW50CgoJcmVuZGVyOiBmdW5jdGlvbihlbGVtZW50LCBwcm9wZXJ0eSwgdmFsdWUsIHVuaXQpewoJCWVsZW1lbnQuc2V0U3R5bGUocHJvcGVydHksIHRoaXMuc2VydmUodmFsdWUsIHVuaXQpKTsKCX0sCgoJLy9zZWFyY2hlcyBpbnNpZGUgdGhlIHBhZ2UgY3NzIHRvIGZpbmQgdGhlIHZhbHVlcyBmb3IgYSBzZWxlY3RvcgoKCXNlYXJjaDogZnVuY3Rpb24oc2VsZWN0b3IpewoJCWlmIChGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdKSByZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXTsKCQl2YXIgdG8gPSB7fSwgc2VsZWN0b3JUZXN0ID0gbmV3IFJlZ0V4cCgnXicgKyBzZWxlY3Rvci5lc2NhcGVSZWdFeHAoKSArICckJyk7CgkJQXJyYXkuZWFjaChkb2N1bWVudC5zdHlsZVNoZWV0cywgZnVuY3Rpb24oc2hlZXQsIGopewoJCQl2YXIgaHJlZiA9IHNoZWV0LmhyZWY7CgkJCWlmIChocmVmICYmIGhyZWYuY29udGFpbnMoJzovLycpICYmICFocmVmLmNvbnRhaW5zKGRvY3VtZW50LmRvbWFpbikpIHJldHVybjsKCQkJdmFyIHJ1bGVzID0gc2hlZXQucnVsZXMgfHwgc2hlZXQuY3NzUnVsZXM7CgkJCUFycmF5LmVhY2gocnVsZXMsIGZ1bmN0aW9uKHJ1bGUsIGkpewoJCQkJaWYgKCFydWxlLnN0eWxlKSByZXR1cm47CgkJCQl2YXIgc2VsZWN0b3JUZXh0ID0gKHJ1bGUuc2VsZWN0b3JUZXh0KSA/IHJ1bGUuc2VsZWN0b3JUZXh0LnJlcGxhY2UoL15cdysvLCBmdW5jdGlvbihtKXsKCQkJCQlyZXR1cm4gbS50b0xvd2VyQ2FzZSgpOwoJCQkJfSkgOiBudWxsOwoJCQkJaWYgKCFzZWxlY3RvclRleHQgfHwgIXNlbGVjdG9yVGVzdC50ZXN0KHNlbGVjdG9yVGV4dCkpIHJldHVybjsKCQkJCU9iamVjdC5lYWNoKEVsZW1lbnQuU3R5bGVzLCBmdW5jdGlvbih2YWx1ZSwgc3R5bGUpewoJCQkJCWlmICghcnVsZS5zdHlsZVtzdHlsZV0gfHwgRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJldHVybjsKCQkJCQl2YWx1ZSA9IFN0cmluZyhydWxlLnN0eWxlW3N0eWxlXSk7CgkJCQkJdG9bc3R5bGVdID0gKCgvXnJnYi8pLnRlc3QodmFsdWUpKSA/IHZhbHVlLnJnYlRvSGV4KCkgOiB2YWx1ZTsKCQkJCX0pOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXSA9IHRvOwoJfQoKfSk7CgpGeC5DU1MuQ2FjaGUgPSB7fTsKCkZ4LkNTUy5QYXJzZXJzID0gewoKCUNvbG9yOiB7CgkJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJaWYgKHZhbHVlLm1hdGNoKC9eI1swLTlhLWZdezMsNn0kL2kpKSByZXR1cm4gdmFsdWUuaGV4VG9SZ2IodHJ1ZSk7CgkJCXJldHVybiAoKHZhbHVlID0gdmFsdWUubWF0Y2goLyhcZCspLFxzKihcZCspLFxzKihcZCspLykpKSA/IFt2YWx1ZVsxXSwgdmFsdWVbMl0sIHZhbHVlWzNdXSA6IGZhbHNlOwoJCX0sCgkJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQkJcmV0dXJuIGZyb20ubWFwKGZ1bmN0aW9uKHZhbHVlLCBpKXsKCQkJCXJldHVybiBNYXRoLnJvdW5kKEZ4LmNvbXB1dGUoZnJvbVtpXSwgdG9baV0sIGRlbHRhKSk7CgkJCX0pOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlLm1hcChOdW1iZXIpOwoJCX0KCX0sCgoJTnVtYmVyOiB7CgkJcGFyc2U6IHBhcnNlRmxvYXQsCgkJY29tcHV0ZTogRnguY29tcHV0ZSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCQlyZXR1cm4gKHVuaXQpID8gdmFsdWUgKyB1bml0IDogdmFsdWU7CgkJfQoJfSwKCglTdHJpbmc6IHsKCQlwYXJzZTogRnVuY3Rpb24uZnJvbShmYWxzZSksCgkJY29tcHV0ZTogZnVuY3Rpb24oemVybywgb25lKXsKCQkJcmV0dXJuIG9uZTsKCQl9LAoJCXNlcnZlOiBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfQoJfQoKfTsKCi8qCi0tLQoKbmFtZTogRnguVHdlZW4KCmRlc2NyaXB0aW9uOiBGb3JtZXJseSBGeC5TdHlsZSwgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IENTUyBwcm9wZXJ0eSBmb3IgYW4gZWxlbWVudC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IFtGeC5Ud2VlbiwgRWxlbWVudC5mYWRlLCBFbGVtZW50LmhpZ2hsaWdodF0KCi4uLgoqLwoKRnguVHdlZW4gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihwcm9wZXJ0eSwgbm93KXsKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQkJbm93ID0gcHJvcGVydHk7CgkJCXByb3BlcnR5ID0gdGhpcy5wcm9wZXJ0eSB8fCB0aGlzLm9wdGlvbnMucHJvcGVydHk7CgkJfQoJCXRoaXMucmVuZGVyKHRoaXMuZWxlbWVudCwgcHJvcGVydHksIG5vdywgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdGFydDogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydHksIGZyb20sIHRvKSkgcmV0dXJuIHRoaXM7CgkJdmFyIGFyZ3MgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyk7CgkJdGhpcy5wcm9wZXJ0eSA9IHRoaXMub3B0aW9ucy5wcm9wZXJ0eSB8fCBhcmdzLnNoaWZ0KCk7CgkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHRoaXMucHJvcGVydHksIGFyZ3MpOwoJCXJldHVybiB0aGlzLnBhcmVudChwYXJzZWQuZnJvbSwgcGFyc2VkLnRvKTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnR3ZWVuID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5nZXQoJ3R3ZWVuJykuY2FuY2VsKCkuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciB0d2VlbiA9IHRoaXMucmV0cmlldmUoJ3R3ZWVuJyk7CgkJaWYgKCF0d2Vlbil7CgkJCXR3ZWVuID0gbmV3IEZ4LlR3ZWVuKHRoaXMsIHtsaW5rOiAnY2FuY2VsJ30pOwoJCQl0aGlzLnN0b3JlKCd0d2VlbicsIHR3ZWVuKTsKCQl9CgkJcmV0dXJuIHR3ZWVuOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCgl0d2VlbjogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQl0aGlzLmdldCgndHdlZW4nKS5zdGFydChhcmd1bWVudHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglmYWRlOiBmdW5jdGlvbihob3cpewoJCXZhciBmYWRlID0gdGhpcy5nZXQoJ3R3ZWVuJyksIG8gPSAnb3BhY2l0eScsIHRvZ2dsZTsKCQlob3cgPSBbaG93LCAndG9nZ2xlJ10ucGljaygpOwoJCXN3aXRjaCAoaG93KXsKCQkJY2FzZSAnaW4nOiBmYWRlLnN0YXJ0KG8sIDEpOyBicmVhazsKCQkJY2FzZSAnb3V0JzogZmFkZS5zdGFydChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3Nob3cnOiBmYWRlLnNldChvLCAxKTsgYnJlYWs7CgkJCWNhc2UgJ2hpZGUnOiBmYWRlLnNldChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3RvZ2dsZSc6CgkJCQl2YXIgZmxhZyA9IHRoaXMucmV0cmlldmUoJ2ZhZGU6ZmxhZycsIHRoaXMuZ2V0KCdvcGFjaXR5JykgPT0gMSk7CgkJCQlmYWRlLnN0YXJ0KG8sIChmbGFnKSA/IDAgOiAxKTsKCQkJCXRoaXMuc3RvcmUoJ2ZhZGU6ZmxhZycsICFmbGFnKTsKCQkJCXRvZ2dsZSA9IHRydWU7CgkJCWJyZWFrOwoJCQlkZWZhdWx0OiBmYWRlLnN0YXJ0KG8sIGFyZ3VtZW50cyk7CgkJfQoJCWlmICghdG9nZ2xlKSB0aGlzLmVsaW1pbmF0ZSgnZmFkZTpmbGFnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWhpZ2hsaWdodDogZnVuY3Rpb24oc3RhcnQsIGVuZCl7CgkJaWYgKCFlbmQpewoJCQllbmQgPSB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnLCB0aGlzLmdldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJykpOwoJCQllbmQgPSAoZW5kID09ICd0cmFuc3BhcmVudCcpID8gJyNmZmYnIDogZW5kOwoJCX0KCQl2YXIgdHdlZW4gPSB0aGlzLmdldCgndHdlZW4nKTsKCQl0d2Vlbi5zdGFydCgnYmFja2dyb3VuZC1jb2xvcicsIHN0YXJ0IHx8ICcjZmZmZjg4JywgZW5kKS5jaGFpbihmdW5jdGlvbigpewoJCQl0aGlzLnNldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJywgdGhpcy5yZXRyaWV2ZSgnaGlnaGxpZ2h0Om9yaWdpbmFsJykpOwoJCQl0d2Vlbi5jYWxsQ2hhaW4oKTsKCQl9LmJpbmQodGhpcykpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovKgotLS0KCm5hbWU6IEZ4Lk1vcnBoCgpkZXNjcmlwdGlvbjogRm9ybWVybHkgRnguU3R5bGVzLCBlZmZlY3QgdG8gdHJhbnNpdGlvbiBhbnkgbnVtYmVyIG9mIENTUyBwcm9wZXJ0aWVzIGZvciBhbiBlbGVtZW50IHVzaW5nIGFuIG9iamVjdCBvZiBydWxlcywgb3IgQ1NTIGJhc2VkIHNlbGVjdG9yIHJ1bGVzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRnguQ1NTCgpwcm92aWRlczogRnguTW9ycGgKCi4uLgoqLwoKRnguTW9ycGggPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihub3cpewoJCWlmICh0eXBlb2Ygbm93ID09ICdzdHJpbmcnKSBub3cgPSB0aGlzLnNlYXJjaChub3cpOwoJCWZvciAodmFyIHAgaW4gbm93KSB0aGlzLnJlbmRlcih0aGlzLmVsZW1lbnQsIHAsIG5vd1twXSwgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBub3cgPSB7fTsKCQlmb3IgKHZhciBwIGluIGZyb20pIG5vd1twXSA9IHRoaXMucGFyZW50KGZyb21bcF0sIHRvW3BdLCBkZWx0YSk7CgkJcmV0dXJuIG5vdzsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJCWlmICghdGhpcy5jaGVjayhwcm9wZXJ0aWVzKSkgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZiBwcm9wZXJ0aWVzID09ICdzdHJpbmcnKSBwcm9wZXJ0aWVzID0gdGhpcy5zZWFyY2gocHJvcGVydGllcyk7CgkJdmFyIGZyb20gPSB7fSwgdG8gPSB7fTsKCQlmb3IgKHZhciBwIGluIHByb3BlcnRpZXMpewoJCQl2YXIgcGFyc2VkID0gdGhpcy5wcmVwYXJlKHRoaXMuZWxlbWVudCwgcCwgcHJvcGVydGllc1twXSk7CgkJCWZyb21bcF0gPSBwYXJzZWQuZnJvbTsKCQkJdG9bcF0gPSBwYXJzZWQudG87CgkJfQoJCXJldHVybiB0aGlzLnBhcmVudChmcm9tLCB0byk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5tb3JwaCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuZ2V0KCdtb3JwaCcpLmNhbmNlbCgpLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgbW9ycGggPSB0aGlzLnJldHJpZXZlKCdtb3JwaCcpOwoJCWlmICghbW9ycGgpewoJCQltb3JwaCA9IG5ldyBGeC5Nb3JwaCh0aGlzLCB7bGluazogJ2NhbmNlbCd9KTsKCQkJdGhpcy5zdG9yZSgnbW9ycGgnLCBtb3JwaCk7CgkJfQoJCXJldHVybiBtb3JwaDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbW9ycGg6IGZ1bmN0aW9uKHByb3BzKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5zdGFydChwcm9wcyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8qCi0tLQoKbmFtZTogRnguVHJhbnNpdGlvbnMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBhIHNldCBvZiBhZHZhbmNlZCB0cmFuc2l0aW9ucyB0byBiZSB1c2VkIHdpdGggYW55IG9mIHRoZSBGeCBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRWFzaW5nIEVxdWF0aW9ucyBieSBSb2JlcnQgUGVubmVyLCA8aHR0cDovL3d3dy5yb2JlcnRwZW5uZXIuY29tL2Vhc2luZy8+LCBtb2RpZmllZCBhbmQgb3B0aW1pemVkIHRvIGJlIHVzZWQgd2l0aCBNb29Ub29scy4KCnJlcXVpcmVzOiBGeAoKcHJvdmlkZXM6IEZ4LlRyYW5zaXRpb25zCgouLi4KKi8KCkZ4LmltcGxlbWVudCh7CgoJZ2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oKXsKCQl2YXIgdHJhbnMgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiB8fCBGeC5UcmFuc2l0aW9ucy5TaW5lLmVhc2VJbk91dDsKCQlpZiAodHlwZW9mIHRyYW5zID09ICdzdHJpbmcnKXsKCQkJdmFyIGRhdGEgPSB0cmFucy5zcGxpdCgnOicpOwoJCQl0cmFucyA9IEZ4LlRyYW5zaXRpb25zOwoJCQl0cmFucyA9IHRyYW5zW2RhdGFbMF1dIHx8IHRyYW5zW2RhdGFbMF0uY2FwaXRhbGl6ZSgpXTsKCQkJaWYgKGRhdGFbMV0pIHRyYW5zID0gdHJhbnNbJ2Vhc2UnICsgZGF0YVsxXS5jYXBpdGFsaXplKCkgKyAoZGF0YVsyXSA/IGRhdGFbMl0uY2FwaXRhbGl6ZSgpIDogJycpXTsKCQl9CgkJcmV0dXJuIHRyYW5zOwoJfQoKfSk7CgpGeC5UcmFuc2l0aW9uID0gZnVuY3Rpb24odHJhbnNpdGlvbiwgcGFyYW1zKXsKCXBhcmFtcyA9IEFycmF5LmZyb20ocGFyYW1zKTsKCXZhciBlYXNlSW4gPSBmdW5jdGlvbihwb3MpewoJCXJldHVybiB0cmFuc2l0aW9uKHBvcywgcGFyYW1zKTsKCX07CglyZXR1cm4gT2JqZWN0LmFwcGVuZChlYXNlSW4sIHsKCQllYXNlSW46IGVhc2VJbiwKCQllYXNlT3V0OiBmdW5jdGlvbihwb3MpewoJCQlyZXR1cm4gMSAtIHRyYW5zaXRpb24oMSAtIHBvcywgcGFyYW1zKTsKCQl9LAoJCWVhc2VJbk91dDogZnVuY3Rpb24ocG9zKXsKCQkJcmV0dXJuIChwb3MgPD0gMC41ID8gdHJhbnNpdGlvbigyICogcG9zLCBwYXJhbXMpIDogKDIgLSB0cmFuc2l0aW9uKDIgKiAoMSAtIHBvcyksIHBhcmFtcykpKSAvIDI7CgkJfQoJfSk7Cn07CgpGeC5UcmFuc2l0aW9ucyA9IHsKCglsaW5lYXI6IGZ1bmN0aW9uKHplcm8pewoJCXJldHVybiB6ZXJvOwoJfQoKfTsKCkZ4LlRyYW5zaXRpb25zLmV4dGVuZCA9IGZ1bmN0aW9uKHRyYW5zaXRpb25zKXsKCWZvciAodmFyIHRyYW5zaXRpb24gaW4gdHJhbnNpdGlvbnMpIEZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb25dID0gbmV3IEZ4LlRyYW5zaXRpb24odHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0pOwp9OwoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kKHsKCglQb3c6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdyhwLCB4ICYmIHhbMF0gfHwgNik7Cgl9LAoKCUV4cG86IGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdygyLCA4ICogKHAgLSAxKSk7Cgl9LAoKCUNpcmM6IGZ1bmN0aW9uKHApewoJCXJldHVybiAxIC0gTWF0aC5zaW4oTWF0aC5hY29zKHApKTsKCX0sCgoJU2luZTogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLmNvcyhwICogTWF0aC5QSSAvIDIpOwoJfSwKCglCYWNrOiBmdW5jdGlvbihwLCB4KXsKCQl4ID0geCAmJiB4WzBdIHx8IDEuNjE4OwoJCXJldHVybiBNYXRoLnBvdyhwLCAyKSAqICgoeCArIDEpICogcCAtIHgpOwoJfSwKCglCb3VuY2U6IGZ1bmN0aW9uKHApewoJCXZhciB2YWx1ZTsKCQlmb3IgKHZhciBhID0gMCwgYiA9IDE7IDE7IGEgKz0gYiwgYiAvPSAyKXsKCQkJaWYgKHAgPj0gKDcgLSA0ICogYSkgLyAxMSl7CgkJCQl2YWx1ZSA9IGIgKiBiIC0gTWF0aC5wb3coKDExIC0gNiAqIGEgLSAxMSAqIHApIC8gNCwgMik7CgkJCQlicmVhazsKCQkJfQoJCX0KCQlyZXR1cm4gdmFsdWU7Cgl9LAoKCUVsYXN0aWM6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdygyLCAxMCAqIC0tcCkgKiBNYXRoLmNvcygyMCAqIHAgKiBNYXRoLlBJICogKHggJiYgeFswXSB8fCAxKSAvIDMpOwoJfQoKfSk7CgpbJ1F1YWQnLCAnQ3ViaWMnLCAnUXVhcnQnLCAnUXVpbnQnXS5lYWNoKGZ1bmN0aW9uKHRyYW5zaXRpb24sIGkpewoJRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbihmdW5jdGlvbihwKXsKCQlyZXR1cm4gTWF0aC5wb3cocCwgaSArIDIpOwoJfSk7Cn0pOwoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0CgpkZXNjcmlwdGlvbjogUG93ZXJmdWwgYWxsIHB1cnBvc2UgUmVxdWVzdCBDbGFzcy4gVXNlcyBYTUxIVFRQUmVxdWVzdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtPYmplY3QsIEVsZW1lbnQsIENoYWluLCBFdmVudHMsIE9wdGlvbnMsIEJyb3dzZXJdCgpwcm92aWRlczogUmVxdWVzdAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBlbXB0eSA9IGZ1bmN0aW9uKCl7fSwKCXByb2dyZXNzU3VwcG9ydCA9ICgnb25wcm9ncmVzcycgaW4gbmV3IEJyb3dzZXIuUmVxdWVzdCk7Cgp2YXIgUmVxdWVzdCA9IHRoaXMuUmVxdWVzdCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsvKgoJCW9uUmVxdWVzdDogZnVuY3Rpb24oKXt9LAoJCW9uTG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uUHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50LCB4aHIpe30sCgkJb25Db21wbGV0ZTogZnVuY3Rpb24oKXt9LAoJCW9uQ2FuY2VsOiBmdW5jdGlvbigpe30sCgkJb25TdWNjZXNzOiBmdW5jdGlvbihyZXNwb25zZVRleHQsIHJlc3BvbnNlWE1MKXt9LAoJCW9uRmFpbHVyZTogZnVuY3Rpb24oeGhyKXt9LAoJCW9uRXhjZXB0aW9uOiBmdW5jdGlvbihoZWFkZXJOYW1lLCB2YWx1ZSl7fSwKCQlvblRpbWVvdXQ6IGZ1bmN0aW9uKCl7fSwKCQl1c2VyOiAnJywKCQlwYXNzd29yZDogJycsKi8KCQl1cmw6ICcnLAoJCWRhdGE6ICcnLAoJCWhlYWRlcnM6IHsKCQkJJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnLAoJCQknQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfSwKCQlhc3luYzogdHJ1ZSwKCQlmb3JtYXQ6IGZhbHNlLAoJCW1ldGhvZDogJ3Bvc3QnLAoJCWxpbms6ICdpZ25vcmUnLAoJCWlzU3VjY2VzczogbnVsbCwKCQllbXVsYXRpb246IHRydWUsCgkJdXJsRW5jb2RlZDogdHJ1ZSwKCQllbmNvZGluZzogJ3V0Zi04JywKCQlldmFsU2NyaXB0czogZmFsc2UsCgkJZXZhbFJlc3BvbnNlOiBmYWxzZSwKCQl0aW1lb3V0OiAwLAoJCW5vQ2FjaGU6IGZhbHNlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLm9wdGlvbnMuaGVhZGVyczsKCX0sCgoJb25TdGF0ZUNoYW5nZTogZnVuY3Rpb24oKXsKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHhoci5yZWFkeVN0YXRlICE9IDQgfHwgIXRoaXMucnVubmluZykgcmV0dXJuOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXRoaXMuc3RhdHVzID0gMDsKCQlGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXZhciBzdGF0dXMgPSB4aHIuc3RhdHVzOwoJCQl0aGlzLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXM7CgkJfS5iaW5kKHRoaXMpKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgoJCXRoaXMucmVzcG9uc2UgPSB7dGV4dDogdGhpcy54aHIucmVzcG9uc2VUZXh0IHx8ICcnLCB4bWw6IHRoaXMueGhyLnJlc3BvbnNlWE1MfTsKCQlpZiAodGhpcy5vcHRpb25zLmlzU3VjY2Vzcy5jYWxsKHRoaXMsIHRoaXMuc3RhdHVzKSkKCQkJdGhpcy5zdWNjZXNzKHRoaXMucmVzcG9uc2UudGV4dCwgdGhpcy5yZXNwb25zZS54bWwpOwoJCWVsc2UKCQkJdGhpcy5mYWlsdXJlKCk7Cgl9LAoKCWlzU3VjY2VzczogZnVuY3Rpb24oKXsKCQl2YXIgc3RhdHVzID0gdGhpcy5zdGF0dXM7CgkJcmV0dXJuIChzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCk7Cgl9LAoKCWlzUnVubmluZzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gISF0aGlzLnJ1bm5pbmc7Cgl9LAoKCXByb2Nlc3NTY3JpcHRzOiBmdW5jdGlvbih0ZXh0KXsKCQlpZiAodGhpcy5vcHRpb25zLmV2YWxSZXNwb25zZSB8fCAoLyhlY21hfGphdmEpc2NyaXB0LykudGVzdCh0aGlzLmdldEhlYWRlcignQ29udGVudC10eXBlJykpKSByZXR1cm4gQnJvd3Nlci5leGVjKHRleHQpOwoJCXJldHVybiB0ZXh0LnN0cmlwU2NyaXB0cyh0aGlzLm9wdGlvbnMuZXZhbFNjcmlwdHMpOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0LCB4bWwpewoJCXRoaXMub25TdWNjZXNzKHRoaXMucHJvY2Vzc1NjcmlwdHModGV4dCksIHhtbCk7Cgl9LAoKCW9uU3VjY2VzczogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnY29tcGxldGUnLCBhcmd1bWVudHMpLmZpcmVFdmVudCgnc3VjY2VzcycsIGFyZ3VtZW50cykuY2FsbENoYWluKCk7Cgl9LAoKCWZhaWx1cmU6IGZ1bmN0aW9uKCl7CgkJdGhpcy5vbkZhaWx1cmUoKTsKCX0sCgoJb25GYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScpLmZpcmVFdmVudCgnZmFpbHVyZScsIHRoaXMueGhyKTsKCX0sCgoJbG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ2xvYWRzdGFydCcsIFtldmVudCwgdGhpcy54aHJdKTsKCX0sCgoJcHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50KXsKCQl0aGlzLmZpcmVFdmVudCgncHJvZ3Jlc3MnLCBbZXZlbnQsIHRoaXMueGhyXSk7Cgl9LAoKCXRpbWVvdXQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ3RpbWVvdXQnLCB0aGlzLnhocik7Cgl9LAoKCXNldEhlYWRlcjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewoJCXRoaXMuaGVhZGVyc1tuYW1lXSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUpewoJCXJldHVybiBGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXJldHVybiB0aGlzLnhoci5nZXRSZXNwb25zZUhlYWRlcihuYW1lKTsKCQl9LmJpbmQodGhpcykpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRydWU7CgkJc3dpdGNoICh0aGlzLm9wdGlvbnMubGluayl7CgkJCWNhc2UgJ2NhbmNlbCc6IHRoaXMuY2FuY2VsKCk7IHJldHVybiB0cnVlOwoJCQljYXNlICdjaGFpbic6IHRoaXMuY2hhaW4odGhpcy5jYWxsZXIucGFzcyhhcmd1bWVudHMsIHRoaXMpKTsgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCXNlbmQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCWlmICghdGhpcy5jaGVjayhvcHRpb25zKSkgcmV0dXJuIHRoaXM7CgoJCXRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgPSB0aGlzLm9wdGlvbnMuaXNTdWNjZXNzIHx8IHRoaXMuaXNTdWNjZXNzOwoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCXZhciB0eXBlID0gdHlwZU9mKG9wdGlvbnMpOwoJCWlmICh0eXBlID09ICdzdHJpbmcnIHx8IHR5cGUgPT0gJ2VsZW1lbnQnKSBvcHRpb25zID0ge2RhdGE6IG9wdGlvbnN9OwoKCQl2YXIgb2xkID0gdGhpcy5vcHRpb25zOwoJCW9wdGlvbnMgPSBPYmplY3QuYXBwZW5kKHtkYXRhOiBvbGQuZGF0YSwgdXJsOiBvbGQudXJsLCBtZXRob2Q6IG9sZC5tZXRob2R9LCBvcHRpb25zKTsKCQl2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKSwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKTsKCgkJc3dpdGNoICh0eXBlT2YoZGF0YSkpewoJCQljYXNlICdlbGVtZW50JzogZGF0YSA9IGRvY3VtZW50LmlkKGRhdGEpLnRvUXVlcnlTdHJpbmcoKTsgYnJlYWs7CgkJCWNhc2UgJ29iamVjdCc6IGNhc2UgJ2hhc2gnOiBkYXRhID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcoZGF0YSk7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmZvcm1hdCl7CgkJCXZhciBmb3JtYXQgPSAnZm9ybWF0PScgKyB0aGlzLm9wdGlvbnMuZm9ybWF0OwoJCQlkYXRhID0gKGRhdGEpID8gZm9ybWF0ICsgJyYnICsgZGF0YSA6IGZvcm1hdDsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMuZW11bGF0aW9uICYmICFbJ2dldCcsICdwb3N0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZDsKCQkJZGF0YSA9IChkYXRhKSA/IF9tZXRob2QgKyAnJicgKyBkYXRhIDogX21ldGhvZDsKCQkJbWV0aG9kID0gJ3Bvc3QnOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy51cmxFbmNvZGVkICYmIFsncG9zdCcsICdwdXQnXS5jb250YWlucyhtZXRob2QpKXsKCQkJdmFyIGVuY29kaW5nID0gKHRoaXMub3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyB0aGlzLm9wdGlvbnMuZW5jb2RpbmcgOiAnJzsKCQkJdGhpcy5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2Rpbmc7CgkJfQoKCQlpZiAoIXVybCkgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWU7CgoJCXZhciB0cmltUG9zaXRpb24gPSB1cmwubGFzdEluZGV4T2YoJy8nKTsKCQlpZiAodHJpbVBvc2l0aW9uID4gLTEgJiYgKHRyaW1Qb3NpdGlvbiA9IHVybC5pbmRleE9mKCcjJykpID4gLTEpIHVybCA9IHVybC5zdWJzdHIoMCwgdHJpbVBvc2l0aW9uKTsKCgkJaWYgKHRoaXMub3B0aW9ucy5ub0NhY2hlKQoJCQl1cmwgKz0gKHVybC5jb250YWlucygnPycpID8gJyYnIDogJz8nKSArIFN0cmluZy51bmlxdWVJRCgpOwoKCQlpZiAoZGF0YSAmJiBtZXRob2QgPT0gJ2dldCcpewoJCQl1cmwgKz0gKHVybC5jb250YWlucygnPycpID8gJyYnIDogJz8nKSArIGRhdGE7CgkJCWRhdGEgPSBudWxsOwoJCX0KCgkJdmFyIHhociA9IHRoaXMueGhyOwoJCWlmIChwcm9ncmVzc1N1cHBvcnQpewoJCQl4aHIub25sb2Fkc3RhcnQgPSB0aGlzLmxvYWRzdGFydC5iaW5kKHRoaXMpOwoJCQl4aHIub25wcm9ncmVzcyA9IHRoaXMucHJvZ3Jlc3MuYmluZCh0aGlzKTsKCQl9CgoJCXhoci5vcGVuKG1ldGhvZC50b1VwcGVyQ2FzZSgpLCB1cmwsIHRoaXMub3B0aW9ucy5hc3luYywgdGhpcy5vcHRpb25zLnVzZXIsIHRoaXMub3B0aW9ucy5wYXNzd29yZCk7CgkJaWYgKHRoaXMub3B0aW9ucy51c2VyICYmICd3aXRoQ3JlZGVudGlhbHMnIGluIHhocikgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CgoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB0aGlzLm9uU3RhdGVDaGFuZ2UuYmluZCh0aGlzKTsKCgkJT2JqZWN0LmVhY2godGhpcy5oZWFkZXJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJdHJ5IHsKCQkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwoJCQl9IGNhdGNoIChlKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCBba2V5LCB2YWx1ZV0pOwoJCQl9CgkJfSwgdGhpcyk7CgoJCXRoaXMuZmlyZUV2ZW50KCdyZXF1ZXN0Jyk7CgkJeGhyLnNlbmQoZGF0YSk7CgkJaWYgKCF0aGlzLm9wdGlvbnMuYXN5bmMpIHRoaXMub25TdGF0ZUNoYW5nZSgpOwoJCWlmICh0aGlzLm9wdGlvbnMudGltZW91dCkgdGhpcy50aW1lciA9IHRoaXMudGltZW91dC5kZWxheSh0aGlzLm9wdGlvbnMudGltZW91dCwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNhbmNlbDogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCXhoci5hYm9ydCgpOwoJCWNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLmZpcmVFdmVudCgnY2FuY2VsJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciBtZXRob2RzID0ge307ClsnZ2V0JywgJ3Bvc3QnLCAncHV0JywgJ2RlbGV0ZScsICdHRVQnLCAnUE9TVCcsICdQVVQnLCAnREVMRVRFJ10uZWFjaChmdW5jdGlvbihtZXRob2QpewoJbWV0aG9kc1ttZXRob2RdID0gZnVuY3Rpb24oZGF0YSl7CgkJdmFyIG9iamVjdCA9IHsKCQkJbWV0aG9kOiBtZXRob2QKCQl9OwoJCWlmIChkYXRhICE9IG51bGwpIG9iamVjdC5kYXRhID0gZGF0YTsKCQlyZXR1cm4gdGhpcy5zZW5kKG9iamVjdCk7Cgl9Owp9KTsKClJlcXVlc3QuaW1wbGVtZW50KG1ldGhvZHMpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnNlbmQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgc2VuZCA9IHRoaXMuZ2V0KCdzZW5kJykuY2FuY2VsKCk7CgkJc2VuZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHNlbmQgPSB0aGlzLnJldHJpZXZlKCdzZW5kJyk7CgkJaWYgKCFzZW5kKXsKCQkJc2VuZCA9IG5ldyBSZXF1ZXN0KHsKCQkJCWRhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCBtZXRob2Q6IHRoaXMuZ2V0KCdtZXRob2QnKSB8fCAncG9zdCcsIHVybDogdGhpcy5nZXQoJ2FjdGlvbicpCgkJCX0pOwoJCQl0aGlzLnN0b3JlKCdzZW5kJywgc2VuZCk7CgkJfQoJCXJldHVybiBzZW5kOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzZW5kOiBmdW5jdGlvbih1cmwpewoJCXZhciBzZW5kZXIgPSB0aGlzLmdldCgnc2VuZCcpOwoJCXNlbmRlci5zZW5kKHtkYXRhOiB0aGlzLCB1cmw6IHVybCB8fCBzZW5kZXIub3B0aW9ucy51cmx9KTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKfSkoKTsKCi8qCi0tLQoKbmFtZTogUmVxdWVzdC5IVE1MCgpkZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgYmFzaWMgUmVxdWVzdCBDbGFzcyB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcyBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBIVE1MIHJlc3BvbnNlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBSZXF1ZXN0XQoKcHJvdmlkZXM6IFJlcXVlc3QuSFRNTAoKLi4uCiovCgpSZXF1ZXN0LkhUTUwgPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IFJlcXVlc3QsCgoJb3B0aW9uczogewoJCXVwZGF0ZTogZmFsc2UsCgkJYXBwZW5kOiBmYWxzZSwKCQlldmFsU2NyaXB0czogdHJ1ZSwKCQlmaWx0ZXI6IGZhbHNlLAoJCWhlYWRlcnM6IHsKCQkJQWNjZXB0OiAndGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfQoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywgcmVzcG9uc2UgPSB0aGlzLnJlc3BvbnNlOwoKCQlyZXNwb25zZS5odG1sID0gdGV4dC5zdHJpcFNjcmlwdHMoZnVuY3Rpb24oc2NyaXB0KXsKCQkJcmVzcG9uc2UuamF2YXNjcmlwdCA9IHNjcmlwdDsKCQl9KTsKCgkJdmFyIG1hdGNoID0gcmVzcG9uc2UuaHRtbC5tYXRjaCgvPGJvZHlbXj5dKj4oW1xzXFNdKj8pPFwvYm9keT4vaSk7CgkJaWYgKG1hdGNoKSByZXNwb25zZS5odG1sID0gbWF0Y2hbMV07CgkJdmFyIHRlbXAgPSBuZXcgRWxlbWVudCgnZGl2Jykuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgoJCXJlc3BvbnNlLnRyZWUgPSB0ZW1wLmNoaWxkTm9kZXM7CgkJcmVzcG9uc2UuZWxlbWVudHMgPSB0ZW1wLmdldEVsZW1lbnRzKCcqJyk7CgoJCWlmIChvcHRpb25zLmZpbHRlcikgcmVzcG9uc2UudHJlZSA9IHJlc3BvbnNlLmVsZW1lbnRzLmZpbHRlcihvcHRpb25zLmZpbHRlcik7CgkJaWYgKG9wdGlvbnMudXBkYXRlKSBkb2N1bWVudC5pZChvcHRpb25zLnVwZGF0ZSkuZW1wdHkoKS5zZXQoJ2h0bWwnLCByZXNwb25zZS5odG1sKTsKCQllbHNlIGlmIChvcHRpb25zLmFwcGVuZCkgZG9jdW1lbnQuaWQob3B0aW9ucy5hcHBlbmQpLmFkb3B0KHRlbXAuZ2V0Q2hpbGRyZW4oKSk7CgkJaWYgKG9wdGlvbnMuZXZhbFNjcmlwdHMpIEJyb3dzZXIuZXhlYyhyZXNwb25zZS5qYXZhc2NyaXB0KTsKCgkJdGhpcy5vblN1Y2Nlc3MocmVzcG9uc2UudHJlZSwgcmVzcG9uc2UuZWxlbWVudHMsIHJlc3BvbnNlLmh0bWwsIHJlc3BvbnNlLmphdmFzY3JpcHQpOwoJfQoKfSk7CgpFbGVtZW50LlByb3BlcnRpZXMubG9hZCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXZhciBsb2FkID0gdGhpcy5nZXQoJ2xvYWQnKS5jYW5jZWwoKTsKCQlsb2FkLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgbG9hZCA9IHRoaXMucmV0cmlldmUoJ2xvYWQnKTsKCQlpZiAoIWxvYWQpewoJCQlsb2FkID0gbmV3IFJlcXVlc3QuSFRNTCh7ZGF0YTogdGhpcywgbGluazogJ2NhbmNlbCcsIHVwZGF0ZTogdGhpcywgbWV0aG9kOiAnZ2V0J30pOwoJCQl0aGlzLnN0b3JlKCdsb2FkJywgbG9hZCk7CgkJfQoJCXJldHVybiBsb2FkOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglsb2FkOiBmdW5jdGlvbigpewoJCXRoaXMuZ2V0KCdsb2FkJykuc2VuZChBcnJheS5saW5rKGFyZ3VtZW50cywge2RhdGE6IFR5cGUuaXNPYmplY3QsIHVybDogVHlwZS5pc1N0cmluZ30pKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLyoKLS0tCgpuYW1lOiBKU09OCgpkZXNjcmlwdGlvbjogSlNPTiBlbmNvZGVyIGFuZCBkZWNvZGVyLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpTZWUgQWxzbzogPGh0dHA6Ly93d3cuanNvbi5vcmcvPgoKcmVxdWlyZXM6IFtBcnJheSwgU3RyaW5nLCBOdW1iZXIsIEZ1bmN0aW9uXQoKcHJvdmlkZXM6IEpTT04KCi4uLgoqLwoKaWYgKHR5cGVvZiBKU09OID09ICd1bmRlZmluZWQnKSB0aGlzLkpTT04gPSB7fTsKCihmdW5jdGlvbigpewoKdmFyIHNwZWNpYWwgPSB7J1xiJzogJ1xcYicsICdcdCc6ICdcXHQnLCAnXG4nOiAnXFxuJywgJ1xmJzogJ1xcZicsICdccic6ICdcXHInLCAnIicgOiAnXFwiJywgJ1xcJzogJ1xcXFwnfTsKCnZhciBlc2NhcGUgPSBmdW5jdGlvbihjaHIpewoJcmV0dXJuIHNwZWNpYWxbY2hyXSB8fCAnXFx1JyArICgnMDAwMCcgKyBjaHIuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC00KTsKfTsKCkpTT04udmFsaWRhdGUgPSBmdW5jdGlvbihzdHJpbmcpewoJc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoL1xcKD86WyJcXFwvYmZucnRdfHVbMC05YS1mQS1GXXs0fSkvZywgJ0AnKS4KCQkJCQlyZXBsYWNlKC8iW14iXFxcblxyXSoifHRydWV8ZmFsc2V8bnVsbHwtP1xkKyg/OlwuXGQqKT8oPzpbZUVdWytcLV0/XGQrKT8vZywgJ10nKS4KCQkJCQlyZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICcnKTsKCglyZXR1cm4gKC9eW1xdLDp7fVxzXSokLykudGVzdChzdHJpbmcpOwp9OwoKSlNPTi5lbmNvZGUgPSBKU09OLnN0cmluZ2lmeSA/IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqKTsKfSA6IGZ1bmN0aW9uKG9iail7CglpZiAob2JqICYmIG9iai50b0pTT04pIG9iaiA9IG9iai50b0pTT04oKTsKCglzd2l0Y2ggKHR5cGVPZihvYmopKXsKCQljYXNlICdzdHJpbmcnOgoJCQlyZXR1cm4gJyInICsgb2JqLnJlcGxhY2UoL1tceDAwLVx4MWZcXCJdL2csIGVzY2FwZSkgKyAnIic7CgkJY2FzZSAnYXJyYXknOgoJCQlyZXR1cm4gJ1snICsgb2JqLm1hcChKU09OLmVuY29kZSkuY2xlYW4oKSArICddJzsKCQljYXNlICdvYmplY3QnOiBjYXNlICdoYXNoJzoKCQkJdmFyIHN0cmluZyA9IFtdOwoJCQlPYmplY3QuZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQkJdmFyIGpzb24gPSBKU09OLmVuY29kZSh2YWx1ZSk7CgkJCQlpZiAoanNvbikgc3RyaW5nLnB1c2goSlNPTi5lbmNvZGUoa2V5KSArICc6JyArIGpzb24pOwoJCQl9KTsKCQkJcmV0dXJuICd7JyArIHN0cmluZyArICd9JzsKCQljYXNlICdudW1iZXInOiBjYXNlICdib29sZWFuJzogcmV0dXJuICcnICsgb2JqOwoJCWNhc2UgJ251bGwnOiByZXR1cm4gJ251bGwnOwoJfQoKCXJldHVybiBudWxsOwp9OwoKSlNPTi5kZWNvZGUgPSBmdW5jdGlvbihzdHJpbmcsIHNlY3VyZSl7CglpZiAoIXN0cmluZyB8fCB0eXBlT2Yoc3RyaW5nKSAhPSAnc3RyaW5nJykgcmV0dXJuIG51bGw7CgoJaWYgKHNlY3VyZSB8fCBKU09OLnNlY3VyZSl7CgkJaWYgKEpTT04ucGFyc2UpIHJldHVybiBKU09OLnBhcnNlKHN0cmluZyk7CgkJaWYgKCFKU09OLnZhbGlkYXRlKHN0cmluZykpIHRocm93IG5ldyBFcnJvcignSlNPTiBjb3VsZCBub3QgZGVjb2RlIHRoZSBpbnB1dDsgc2VjdXJpdHkgaXMgZW5hYmxlZCBhbmQgdGhlIHZhbHVlIGlzIG5vdCBzZWN1cmUuJyk7Cgl9CgoJcmV0dXJuIGV2YWwoJygnICsgc3RyaW5nICsgJyknKTsKfTsKCn0pLmNhbGwodGhpcyk7CgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSlNPTgoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIHNlbmRpbmcgYW5kIHJlY2VpdmluZyBKU09OIGRhdGEuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbUmVxdWVzdCwgSlNPTl0KCnByb3ZpZGVzOiBSZXF1ZXN0LkpTT04KCi4uLgoqLwoKUmVxdWVzdC5KU09OID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQkvKm9uRXJyb3I6IGZ1bmN0aW9uKHRleHQsIGVycm9yKXt9LCovCgkJc2VjdXJlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMucGFyZW50KG9wdGlvbnMpOwoJCU9iamVjdC5hcHBlbmQodGhpcy5oZWFkZXJzLCB7CgkJCSdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsCgkJCSdYLVJlcXVlc3QnOiAnSlNPTicKCQl9KTsKCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCl7CgkJdmFyIGpzb247CgkJdHJ5IHsKCQkJanNvbiA9IHRoaXMucmVzcG9uc2UuanNvbiA9IEpTT04uZGVjb2RlKHRleHQsIHRoaXMub3B0aW9ucy5zZWN1cmUpOwoJCX0gY2F0Y2ggKGVycm9yKXsKCQkJdGhpcy5maXJlRXZlbnQoJ2Vycm9yJywgW3RleHQsIGVycm9yXSk7CgkJCXJldHVybjsKCQl9CgkJaWYgKGpzb24gPT0gbnVsbCkgdGhpcy5vbkZhaWx1cmUoKTsKCQllbHNlIHRoaXMub25TdWNjZXNzKGpzb24sIHRleHQpOwoJfQoKfSk7CgovKgotLS0KCm5hbWU6IENvb2tpZQoKZGVzY3JpcHRpb246IENsYXNzIGZvciBjcmVhdGluZywgcmVhZGluZywgYW5kIGRlbGV0aW5nIGJyb3dzZXIgQ29va2llcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEJhc2VkIG9uIHRoZSBmdW5jdGlvbnMgYnkgUGV0ZXItUGF1bCBLb2NoIChodHRwOi8vcXVpcmtzbW9kZS5vcmcpLgoKcmVxdWlyZXM6IFtPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IENvb2tpZQoKLi4uCiovCgp2YXIgQ29va2llID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlwYXRoOiAnLycsCgkJZG9tYWluOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZSwKCQlkb2N1bWVudDogZG9jdW1lbnQsCgkJZW5jb2RlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGtleSwgb3B0aW9ucyl7CgkJdGhpcy5rZXkgPSBrZXk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCgl3cml0ZTogZnVuY3Rpb24odmFsdWUpewoJCWlmICh0aGlzLm9wdGlvbnMuZW5jb2RlKSB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJaWYgKHRoaXMub3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgdGhpcy5vcHRpb25zLmRvbWFpbjsKCQlpZiAodGhpcy5vcHRpb25zLnBhdGgpIHZhbHVlICs9ICc7IHBhdGg9JyArIHRoaXMub3B0aW9ucy5wYXRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pewoJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIDI0ICogNjAgKiA2MCAqIDEwMDApOwoJCQl2YWx1ZSArPSAnOyBleHBpcmVzPScgKyBkYXRlLnRvR01UU3RyaW5nKCk7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCXRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWFkOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUubWF0Y2goJyg/Ol58OylcXHMqJyArIHRoaXMua2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuICh2YWx1ZSkgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWVbMV0pIDogbnVsbDsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQluZXcgQ29va2llKHRoaXMua2V5LCBPYmplY3QubWVyZ2Uoe30sIHRoaXMub3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKS53cml0ZSgnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkNvb2tpZS53cml0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS53cml0ZSh2YWx1ZSk7Cn07CgpDb29raWUucmVhZCA9IGZ1bmN0aW9uKGtleSl7CglyZXR1cm4gbmV3IENvb2tpZShrZXkpLnJlYWQoKTsKfTsKCkNvb2tpZS5kaXNwb3NlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCXJldHVybiBuZXcgQ29va2llKGtleSwgb3B0aW9ucykuZGlzcG9zZSgpOwp9OwoKLyoKLS0tCgpuYW1lOiBET01SZWFkeQoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBjdXN0b20gZXZlbnQgZG9tcmVhZHkuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQnJvd3NlciwgRWxlbWVudCwgRWxlbWVudC5FdmVudF0KCnByb3ZpZGVzOiBbRE9NUmVhZHksIERvbVJlYWR5XQoKLi4uCiovCgooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCl7Cgp2YXIgcmVhZHksCglsb2FkZWQsCgljaGVja3MgPSBbXSwKCXNob3VsZFBvbGwsCgl0aW1lciwKCWlzRnJhbWVkID0gdHJ1ZTsKCi8vIFRoYW5rcyB0byBSaWNoIERvdWdoZXJ0eSA8aHR0cDovL3d3dy5yaWNoZG91Z2hlcnR5LmNvbS8+CnRyeSB7Cglpc0ZyYW1lZCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgIT0gbnVsbDsKfSBjYXRjaChlKXt9Cgp2YXIgZG9tcmVhZHkgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmIChyZWFkeSkgcmV0dXJuOwoJQnJvd3Nlci5sb2FkZWQgPSByZWFkeSA9IHRydWU7Cglkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KS5yZW1vdmVMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrKTsKCglkb2N1bWVudC5maXJlRXZlbnQoJ2RvbXJlYWR5Jyk7Cgl3aW5kb3cuZmlyZUV2ZW50KCdkb21yZWFkeScpOwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oKXsKCWZvciAodmFyIGkgPSBjaGVja3MubGVuZ3RoOyBpLS07KSBpZiAoY2hlY2tzW2ldKCkpewoJCWRvbXJlYWR5KCk7CgkJcmV0dXJuIHRydWU7Cgl9CgoJcmV0dXJuIGZhbHNlOwp9OwoKdmFyIHBvbGwgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmICghY2hlY2soKSkgdGltZXIgPSBzZXRUaW1lb3V0KHBvbGwsIDEwKTsKfTsKCmRvY3VtZW50LmFkZExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZG9tcmVhZHkpOwoKLy8gZG9TY3JvbGwgdGVjaG5pcXVlIGJ5IERpZWdvIFBlcmluaSBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwp2YXIgdGVzdEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKaWYgKHRlc3RFbGVtZW50LmRvU2Nyb2xsICYmICFpc0ZyYW1lZCl7CgljaGVja3MucHVzaChmdW5jdGlvbigpewoJCXRyeSB7CgkJCXRlc3RFbGVtZW50LmRvU2Nyb2xsKCk7CgkJCXJldHVybiB0cnVlOwoJCX0gY2F0Y2ggKGUpe30KCgkJcmV0dXJuIGZhbHNlOwoJfSk7CglzaG91bGRQb2xsID0gdHJ1ZTsKfQoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUpIGNoZWNrcy5wdXNoKGZ1bmN0aW9uKCl7Cgl2YXIgc3RhdGUgPSBkb2N1bWVudC5yZWFkeVN0YXRlOwoJcmV0dXJuIChzdGF0ZSA9PSAnbG9hZGVkJyB8fCBzdGF0ZSA9PSAnY29tcGxldGUnKTsKfSk7CgppZiAoJ29ucmVhZHlzdGF0ZWNoYW5nZScgaW4gZG9jdW1lbnQpIGRvY3VtZW50LmFkZExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgY2hlY2spOwplbHNlIHNob3VsZFBvbGwgPSB0cnVlOwoKaWYgKHNob3VsZFBvbGwpIHBvbGwoKTsKCkVsZW1lbnQuRXZlbnRzLmRvbXJlYWR5ID0gewoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAocmVhZHkpIGZuLmNhbGwodGhpcyk7Cgl9Cn07CgovLyBNYWtlIHN1cmUgdGhhdCBkb21yZWFkeSBmaXJlcyBiZWZvcmUgbG9hZApFbGVtZW50LkV2ZW50cy5sb2FkID0gewoJYmFzZTogJ2xvYWQnLAoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAobG9hZGVkICYmIHRoaXMgPT0gd2luZG93KSBmbi5jYWxsKHRoaXMpOwoJfSwKCWNvbmRpdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcyA9PSB3aW5kb3cpewoJCQlkb21yZWFkeSgpOwoJCQlkZWxldGUgRWxlbWVudC5FdmVudHMubG9hZDsKCQl9CgoJCXJldHVybiB0cnVlOwoJfQp9OwoKLy8gVGhpcyBpcyBiYXNlZCBvbiB0aGUgY3VzdG9tIGxvYWQgZXZlbnQKd2luZG93LmFkZEV2ZW50KCdsb2FkJywgZnVuY3Rpb24oKXsKCWxvYWRlZCA9IHRydWU7Cn0pOwoKfSkod2luZG93LCBkb2N1bWVudCk7CgovKgotLS0KCm5hbWU6IFN3aWZmCgpkZXNjcmlwdGlvbjogV3JhcHBlciBmb3IgZW1iZWRkaW5nIFNXRiBtb3ZpZXMuIFN1cHBvcnRzIEV4dGVybmFsIEludGVyZmFjZSBDb21tdW5pY2F0aW9uLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRmxhc2ggZGV0ZWN0aW9uICYgSW50ZXJuZXQgRXhwbG9yZXIgKyBGbGFzaCBQbGF5ZXIgOSBmaXggaW5zcGlyZWQgYnkgU1dGT2JqZWN0LgoKcmVxdWlyZXM6IFtPcHRpb25zLCBPYmplY3QsIEVsZW1lbnRdCgpwcm92aWRlczogU3dpZmYKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgU3dpZmYgPSB0aGlzLlN3aWZmID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlpZDogbnVsbCwKCQloZWlnaHQ6IDEsCgkJd2lkdGg6IDEsCgkJY29udGFpbmVyOiBudWxsLAoJCXByb3BlcnRpZXM6IHt9LAoJCXBhcmFtczogewoJCQlxdWFsaXR5OiAnaGlnaCcsCgkJCWFsbG93U2NyaXB0QWNjZXNzOiAnYWx3YXlzJywKCQkJd01vZGU6ICd3aW5kb3cnLAoJCQlzd0xpdmVDb25uZWN0OiB0cnVlCgkJfSwKCQljYWxsQmFja3M6IHt9LAoJCXZhcnM6IHt9Cgl9LAoKCXRvRWxlbWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vYmplY3Q7Cgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKHBhdGgsIG9wdGlvbnMpewoJCXRoaXMuaW5zdGFuY2UgPSAnU3dpZmZfJyArIFN0cmluZy51bmlxdWVJRCgpOwoKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCQl2YXIgaWQgPSB0aGlzLmlkID0gb3B0aW9ucy5pZCB8fCB0aGlzLmluc3RhbmNlOwoJCXZhciBjb250YWluZXIgPSBkb2N1bWVudC5pZChvcHRpb25zLmNvbnRhaW5lcik7CgoJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXSA9IHt9OwoKCQl2YXIgcGFyYW1zID0gb3B0aW9ucy5wYXJhbXMsIHZhcnMgPSBvcHRpb25zLnZhcnMsIGNhbGxCYWNrcyA9IG9wdGlvbnMuY2FsbEJhY2tzOwoJCXZhciBwcm9wZXJ0aWVzID0gT2JqZWN0LmFwcGVuZCh7aGVpZ2h0OiBvcHRpb25zLmhlaWdodCwgd2lkdGg6IG9wdGlvbnMud2lkdGh9LCBvcHRpb25zLnByb3BlcnRpZXMpOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWZvciAodmFyIGNhbGxCYWNrIGluIGNhbGxCYWNrcyl7CgkJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXVtjYWxsQmFja10gPSAoZnVuY3Rpb24ob3B0aW9uKXsKCQkJCXJldHVybiBmdW5jdGlvbigpewoJCQkJCXJldHVybiBvcHRpb24uYXBwbHkoc2VsZi5vYmplY3QsIGFyZ3VtZW50cyk7CgkJCQl9OwoJCQl9KShjYWxsQmFja3NbY2FsbEJhY2tdKTsKCQkJdmFyc1tjYWxsQmFja10gPSAnU3dpZmYuQ2FsbEJhY2tzLicgKyB0aGlzLmluc3RhbmNlICsgJy4nICsgY2FsbEJhY2s7CgkJfQoKCQlwYXJhbXMuZmxhc2hWYXJzID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFycyk7CgkJaWYgKEJyb3dzZXIuaWUpewoJCQlwcm9wZXJ0aWVzLmNsYXNzaWQgPSAnY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwJzsKCQkJcGFyYW1zLm1vdmllID0gcGF0aDsKCQl9IGVsc2UgewoJCQlwcm9wZXJ0aWVzLnR5cGUgPSAnYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2gnOwoJCX0KCQlwcm9wZXJ0aWVzLmRhdGEgPSBwYXRoOwoKCQl2YXIgYnVpbGQgPSAnPG9iamVjdCBpZD0iJyArIGlkICsgJyInOwoJCWZvciAodmFyIHByb3BlcnR5IGluIHByb3BlcnRpZXMpIGJ1aWxkICs9ICcgJyArIHByb3BlcnR5ICsgJz0iJyArIHByb3BlcnRpZXNbcHJvcGVydHldICsgJyInOwoJCWJ1aWxkICs9ICc+JzsKCQlmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpewoJCQlpZiAocGFyYW1zW3BhcmFtXSkgYnVpbGQgKz0gJzxwYXJhbSBuYW1lPSInICsgcGFyYW0gKyAnIiB2YWx1ZT0iJyArIHBhcmFtc1twYXJhbV0gKyAnIiAvPic7CgkJfQoJCWJ1aWxkICs9ICc8L29iamVjdD4nOwoJCXRoaXMub2JqZWN0ID0gKChjb250YWluZXIpID8gY29udGFpbmVyLmVtcHR5KCkgOiBuZXcgRWxlbWVudCgnZGl2JykpLnNldCgnaHRtbCcsIGJ1aWxkKS5maXJzdENoaWxkOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJZWxlbWVudCA9IGRvY3VtZW50LmlkKGVsZW1lbnQsIHRydWUpOwoJCWVsZW1lbnQucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy50b0VsZW1lbnQoKSwgZWxlbWVudCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWxlbWVudCl7CgkJZG9jdW1lbnQuaWQoZWxlbWVudCwgdHJ1ZSkuYXBwZW5kQ2hpbGQodGhpcy50b0VsZW1lbnQoKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW90ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3dpZmYucmVtb3RlLmFwcGx5KFN3aWZmLCBbdGhpcy50b0VsZW1lbnQoKV0uYXBwZW5kKGFyZ3VtZW50cykpOwoJfQoKfSk7CgpTd2lmZi5DYWxsQmFja3MgPSB7fTsKClN3aWZmLnJlbW90ZSA9IGZ1bmN0aW9uKG9iaiwgZm4pewoJdmFyIHJzID0gb2JqLkNhbGxGdW5jdGlvbignPGludm9rZSBuYW1lPSInICsgZm4gKyAnIiByZXR1cm50eXBlPSJqYXZhc2NyaXB0Ij4nICsgX19mbGFzaF9fYXJndW1lbnRzVG9YTUwoYXJndW1lbnRzLCAyKSArICc8L2ludm9rZT4nKTsKCXJldHVybiBldmFsKHJzKTsKfTsKCn0pLmNhbGwodGhpcyk7Cgo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 22:07:14 GMT",
                    "Content-Length": "136196",
                    "Date": "Fri, 07 Nov 2014 22:07:32 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}