{
    "url": "http://localhost:9999/feedhenry/fh-js-sdk/src/appforms/src/core/000-api-v2.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>window.location</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statements:<ul><li>var xir = (xiRedirectUrl) ? xiRedirectUrl : window.location;</li><li>this.setAttribute('xiRedirectUrl', xir);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/feedhenry/fh-js-sdk/src/appforms/src/core/000-api-v2.js",
                "path": "/feedhenry/fh-js-sdk/src/appforms/src/core/000-api-v2.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9mZWVkaGVucnkvZmgtanMtc2RrL3NyYy9hcHBmb3Jtcy9zcmMvY29yZS8wMDAtYXBpLXYyLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjQzNDENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDA6MTQ6MTUgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDAwOjE0OjE0IEdNVA0KDQo7CihmdW5jdGlvbihyb290KSB7CgogIC8vISEhbGliIHN0YXJ0ISEhCiAgLyoKICAgIGpzb24yLmpzCiAgICAyMDA4LTAzLTI0CgogICAgUHVibGljIERvbWFpbi4KCiAgICBOTyBXQVJSQU5UWSBFWFBSRVNTRUQgT1IgSU1QTElFRC4gVVNFIEFUIFlPVVIgT1dOIFJJU0suCgogICAgU2VlIGh0dHA6Ly93d3cuSlNPTi5vcmcvanMuaHRtbAoKICAgIFRoaXMgZmlsZSBjcmVhdGVzIGEgZ2xvYmFsIEpTT04gb2JqZWN0IGNvbnRhaW5pbmcgdGhyZWUgbWV0aG9kczogc3RyaW5naWZ5LAogICAgcGFyc2UsIGFuZCBxdW90ZS4KCgogICAgICAgIEpTT04uc3RyaW5naWZ5KHZhbHVlLCByZXBsYWNlciwgc3BhY2UpCiAgICAgICAgICAgIHZhbHVlICAgICAgIGFueSBKYXZhU2NyaXB0IHZhbHVlLCB1c3VhbGx5IGFuIG9iamVjdCBvciBhcnJheS4KCiAgICAgICAgICAgIHJlcGxhY2VyICAgIGFuIG9wdGlvbmFsIHBhcmFtZXRlciB0aGF0IGRldGVybWluZXMgaG93IG9iamVjdAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgYXJlIHN0cmluZ2lmaWVkIGZvciBvYmplY3RzIHdpdGhvdXQgYSB0b0pTT04KICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kLiBJdCBjYW4gYmUgYSBmdW5jdGlvbiBvciBhbiBhcnJheS4KCiAgICAgICAgICAgIHNwYWNlICAgICAgIGFuIG9wdGlvbmFsIHBhcmFtZXRlciB0aGF0IHNwZWNpZmllcyB0aGUgaW5kZW50YXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgb2YgbmVzdGVkIHN0cnVjdHVyZXMuIElmIGl0IGlzIG9taXR0ZWQsIHRoZSB0ZXh0IHdpbGwKICAgICAgICAgICAgICAgICAgICAgICAgYmUgcGFja2VkIHdpdGhvdXQgZXh0cmEgd2hpdGVzcGFjZS4gSWYgaXQgaXMgYSBudW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIGl0IHdpbGwgc3BlY2lmeSB0aGUgbnVtYmVyIG9mIHNwYWNlcyB0byBpbmRlbnQgYXQgZWFjaAogICAgICAgICAgICAgICAgICAgICAgICBsZXZlbC4gSWYgaXQgaXMgYSBzdHJpbmcgKHN1Y2ggYXMgJ1x0JyksIGl0IGNvbnRhaW5zIHRoZQogICAgICAgICAgICAgICAgICAgICAgICBjaGFyYWN0ZXJzIHVzZWQgdG8gaW5kZW50IGF0IGVhY2ggbGV2ZWwuCgogICAgICAgICAgICBUaGlzIG1ldGhvZCBwcm9kdWNlcyBhIEpTT04gdGV4dCBmcm9tIGEgSmF2YVNjcmlwdCB2YWx1ZS4KCiAgICAgICAgICAgIFdoZW4gYW4gb2JqZWN0IHZhbHVlIGlzIGZvdW5kLCBpZiB0aGUgb2JqZWN0IGNvbnRhaW5zIGEgdG9KU09OCiAgICAgICAgICAgIG1ldGhvZCwgaXRzIHRvSlNPTiBtZXRob2Qgd2l0aCBiZSBjYWxsZWQgYW5kIHRoZSByZXN1bHQgd2lsbCBiZQogICAgICAgICAgICBzdHJpbmdpZmllZC4gQSB0b0pTT04gbWV0aG9kIGRvZXMgbm90IHNlcmlhbGl6ZTogaXQgcmV0dXJucyB0aGUKICAgICAgICAgICAgdmFsdWUgcmVwcmVzZW50ZWQgYnkgdGhlIG5hbWUvdmFsdWUgcGFpciB0aGF0IHNob3VsZCBiZSBzZXJpYWxpemVkLAogICAgICAgICAgICBvciB1bmRlZmluZWQgaWYgbm90aGluZyBzaG91bGQgYmUgc2VyaWFsaXplZC4gVGhlIHRvSlNPTiBtZXRob2Qgd2lsbAogICAgICAgICAgICBiZSBwYXNzZWQgdGhlIGtleSBhc3NvY2lhdGVkIHdpdGggdGhlIHZhbHVlLCBhbmQgdGhpcyB3aWxsIGJlIGJvdW5kCiAgICAgICAgICAgIHRvIHRoZSBvYmplY3QgaG9sZGluZyB0aGUga2V5LgoKICAgICAgICAgICAgVGhpcyBpcyB0aGUgdG9KU09OIG1ldGhvZCBhZGRlZCB0byBEYXRlczoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiB0b0pTT04oa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VVRDRnVsbFllYXIoKSAgICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENNb250aCgpICsgMSkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ0RhdGUoKSkgICAgICArICdUJyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDSG91cnMoKSkgICAgICsgJzonICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENNaW51dGVzKCkpICAgKyAnOicgKwogICAgICAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ1NlY29uZHMoKSkgICArICdaJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFlvdSBjYW4gcHJvdmlkZSBhbiBvcHRpb25hbCByZXBsYWNlciBtZXRob2QuIEl0IHdpbGwgYmUgcGFzc2VkIHRoZQogICAgICAgICAgICBrZXkgYW5kIHZhbHVlIG9mIGVhY2ggbWVtYmVyLCB3aXRoIHRoaXMgYm91bmQgdG8gdGhlIGNvbnRhaW5pbmcKICAgICAgICAgICAgb2JqZWN0LiBUaGUgdmFsdWUgdGhhdCBpcyByZXR1cm5lZCBmcm9tIHlvdXIgbWV0aG9kIHdpbGwgYmUKICAgICAgICAgICAgc2VyaWFsaXplZC4gSWYgeW91ciBtZXRob2QgcmV0dXJucyB1bmRlZmluZWQsIHRoZW4gdGhlIG1lbWJlciB3aWxsCiAgICAgICAgICAgIGJlIGV4Y2x1ZGVkIGZyb20gdGhlIHNlcmlhbGl6YXRpb24uCgogICAgICAgICAgICBJZiBubyByZXBsYWNlciBwYXJhbWV0ZXIgaXMgcHJvdmlkZWQsIHRoZW4gYSBkZWZhdWx0IHJlcGxhY2VyCiAgICAgICAgICAgIHdpbGwgYmUgdXNlZDoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZXBsYWNlcihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsIGtleSkgPwogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFRoZSBkZWZhdWx0IHJlcGxhY2VyIGlzIHBhc3NlZCB0aGUga2V5IGFuZCB2YWx1ZSBmb3IgZWFjaCBpdGVtIGluCiAgICAgICAgICAgIHRoZSBzdHJ1Y3R1cmUuIEl0IGV4Y2x1ZGVzIGluaGVyaXRlZCBtZW1iZXJzLgoKICAgICAgICAgICAgSWYgdGhlIHJlcGxhY2VyIHBhcmFtZXRlciBpcyBhbiBhcnJheSwgdGhlbiBpdCB3aWxsIGJlIHVzZWQgdG8KICAgICAgICAgICAgc2VsZWN0IHRoZSBtZW1iZXJzIHRvIGJlIHNlcmlhbGl6ZWQuIEl0IGZpbHRlcnMgdGhlIHJlc3VsdHMgc3VjaAogICAgICAgICAgICB0aGF0IG9ubHkgbWVtYmVycyB3aXRoIGtleXMgbGlzdGVkIGluIHRoZSByZXBsYWNlciBhcnJheSBhcmUKICAgICAgICAgICAgc3RyaW5naWZpZWQuCgogICAgICAgICAgICBWYWx1ZXMgdGhhdCBkbyBub3QgaGF2ZSBKU09OIHJlcHJlc2VudGFpb25zLCBzdWNoIGFzIHVuZGVmaW5lZCBvcgogICAgICAgICAgICBmdW5jdGlvbnMsIHdpbGwgbm90IGJlIHNlcmlhbGl6ZWQuIFN1Y2ggdmFsdWVzIGluIG9iamVjdHMgd2lsbCBiZQogICAgICAgICAgICBkcm9wcGVkOyBpbiBhcnJheXMgdGhleSB3aWxsIGJlIHJlcGxhY2VkIHdpdGggbnVsbC4gWW91IGNhbiB1c2UKICAgICAgICAgICAgYSByZXBsYWNlciBmdW5jdGlvbiB0byByZXBsYWNlIHRob3NlIHdpdGggSlNPTiB2YWx1ZXMuCiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHVuZGVmaW5lZCkgcmV0dXJucyB1bmRlZmluZWQuCgogICAgICAgICAgICBUaGUgb3B0aW9uYWwgc3BhY2UgcGFyYW1ldGVyIHByb2R1Y2VzIGEgc3RyaW5naWZpY2F0aW9uIG9mIHRoZSB2YWx1ZQogICAgICAgICAgICB0aGF0IGlzIGZpbGxlZCB3aXRoIGxpbmUgYnJlYWtzIGFuZCBpbmRlbnRhdGlvbiB0byBtYWtlIGl0IGVhc2llciB0bwogICAgICAgICAgICByZWFkLgoKICAgICAgICAgICAgSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIG5vbi1lbXB0eSBzdHJpbmcsIHRoZW4gdGhhdCBzdHJpbmcgd2lsbAogICAgICAgICAgICBiZSB1c2VkIGZvciBpbmRlbnRhdGlvbi4gSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIG51bWJlciwgdGhlbgogICAgICAgICAgICB0aGVuIGluZGVudGF0aW9uIHdpbGwgYmUgdGhhdCBtYW55IHNwYWNlcy4KCiAgICAgICAgICAgIEV4YW1wbGU6CgogICAgICAgICAgICB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoWydlJywge3BsdXJpYnVzOiAndW51bSd9XSk7CiAgICAgICAgICAgIC8vIHRleHQgaXMgJ1siZSIseyJwbHVyaWJ1cyI6InVudW0ifV0nCgoKICAgICAgICAgICAgdGV4dCA9IEpTT04uc3RyaW5naWZ5KFsnZScsIHtwbHVyaWJ1czogJ3VudW0nfV0sIG51bGwsICdcdCcpOwogICAgICAgICAgICAvLyB0ZXh0IGlzICdbXG5cdCJlIixcblx0e1xuXHRcdCJwbHVyaWJ1cyI6ICJ1bnVtIlxuXHR9XG5dJwoKCiAgICAgICAgSlNPTi5wYXJzZSh0ZXh0LCByZXZpdmVyKQogICAgICAgICAgICBUaGlzIG1ldGhvZCBwYXJzZXMgYSBKU09OIHRleHQgdG8gcHJvZHVjZSBhbiBvYmplY3Qgb3IgYXJyYXkuCiAgICAgICAgICAgIEl0IGNhbiB0aHJvdyBhIFN5bnRheEVycm9yIGV4Y2VwdGlvbi4KCiAgICAgICAgICAgIFRoZSBvcHRpb25hbCByZXZpdmVyIHBhcmFtZXRlciBpcyBhIGZ1bmN0aW9uIHRoYXQgY2FuIGZpbHRlciBhbmQKICAgICAgICAgICAgdHJhbnNmb3JtIHRoZSByZXN1bHRzLiBJdCByZWNlaXZlcyBlYWNoIG9mIHRoZSBrZXlzIGFuZCB2YWx1ZXMsIGFuZAogICAgICAgICAgICBpdHMgcmV0dXJuIHZhbHVlIGlzIHVzZWQgaW5zdGVhZCBvZiB0aGUgb3JpZ2luYWwgdmFsdWUuIElmIGl0CiAgICAgICAgICAgIHJldHVybnMgd2hhdCBpdCByZWNlaXZlZCwgdGhlbiBzdHJ1Y3R1cmUgaXMgbm90IG1vZGlmaWVkLiBJZiBpdAogICAgICAgICAgICByZXR1cm5zIHVuZGVmaW5lZCB0aGVuIHRoZSBtZW1iZXIgaXMgZGVsZXRlZC4KCiAgICAgICAgICAgIEV4YW1wbGU6CgogICAgICAgICAgICAvLyBQYXJzZSB0aGUgdGV4dC4gVmFsdWVzIHRoYXQgbG9vayBsaWtlIElTTyBkYXRlIHN0cmluZ3Mgd2lsbAogICAgICAgICAgICAvLyBiZSBjb252ZXJ0ZWQgdG8gRGF0ZSBvYmplY3RzLgoKICAgICAgICAgICAgbXlEYXRhID0gSlNPTi5wYXJzZSh0ZXh0LCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGE7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIGEgPQovXihcZHs0fSktKFxkezJ9KS0oXGR7Mn0pVChcZHsyfSk6KFxkezJ9KTooXGR7Mn0oPzpcLlxkKik/KVokLy5leGVjKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERhdGUoRGF0ZS5VVEMoK2FbMV0sICthWzJdIC0gMSwgK2FbM10sICthWzRdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgK2FbNV0sICthWzZdKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9KTsKCgogICAgICAgIEpTT04ucXVvdGUodGV4dCkKICAgICAgICAgICAgVGhpcyBtZXRob2Qgd3JhcHMgYSBzdHJpbmcgaW4gcXVvdGVzLCBlc2NhcGluZyBzb21lIGNoYXJhY3RlcnMKICAgICAgICAgICAgYXMgbmVlZGVkLgoKCiAgICBUaGlzIGlzIGEgcmVmZXJlbmNlIGltcGxlbWVudGF0aW9uLiBZb3UgYXJlIGZyZWUgdG8gY29weSwgbW9kaWZ5LCBvcgogICAgcmVkaXN0cmlidXRlLgoKICAgIFVTRSBZT1VSIE9XTiBDT1BZLiBJVCBJUyBFWFRSRU1FTFkgVU5XSVNFIFRPIExPQUQgVEhJUkQgUEFSVFkKICAgIENPREUgSU5UTyBZT1VSIFBBR0VTLgoqLwoKICAvKmpzbGludCByZWdleHA6IHRydWUsIGZvcmluOiB0cnVlLCBldmlsOiB0cnVlICovCgogIC8qZ2xvYmFsIEpTT04gKi8KCiAgLyptZW1iZXJzICIiLCAiXGIiLCAiXHQiLCAiXG4iLCAiXGYiLCAiXHIiLCAiXCIiLCBKU09OLCAiXFwiLCBhcHBseSwKICAgIGNhbGwsIGNoYXJDb2RlQXQsIGZsb29yLCBnZXRVVENEYXRlLCBnZXRVVENGdWxsWWVhciwgZ2V0VVRDSG91cnMsCiAgICBnZXRVVENNaW51dGVzLCBnZXRVVENNb250aCwgZ2V0VVRDU2Vjb25kcywgaGFzT3duUHJvcGVydHksIGpvaW4sIGxlbmd0aCwKICAgIHBhcnNlLCBwcm9wZXJ0eUlzRW51bWVyYWJsZSwgcHJvdG90eXBlLCBwdXNoLCBxdW90ZSwgcmVwbGFjZSwgc3RyaW5naWZ5LAogICAgdGVzdCwgdG9KU09OLCB0b1N0cmluZwoqLwoKICBpZiAoIUpTT04pIHsKCiAgICAvLyBDcmVhdGUgYSBKU09OIG9iamVjdCBvbmx5IGlmIG9uZSBkb2VzIG5vdCBhbHJlYWR5IGV4aXN0LiBXZSBjcmVhdGUgdGhlCiAgICAvLyBvYmplY3QgaW4gYSBjbG9zdXJlIHRvIGF2b2lkIGdsb2JhbCB2YXJpYWJsZXMuCgogICAgdmFyIEpTT04gPSBmdW5jdGlvbigpIHsKCiAgICAgIGZ1bmN0aW9uIGYobikgeyAvLyBGb3JtYXQgaW50ZWdlcnMgdG8gaGF2ZSBhdCBsZWFzdCB0d28gZGlnaXRzLgogICAgICAgIHJldHVybiBuIDwgMTAgPyAnMCcgKyBuIDogbjsKICAgICAgfQoKICAgICAgRGF0ZS5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIEV2ZW50dWFsbHksIHRoaXMgbWV0aG9kIHdpbGwgYmUgYmFzZWQgb24gdGhlIGRhdGUudG9JU09TdHJpbmcgbWV0aG9kLgoKICAgICAgICByZXR1cm4gdGhpcy5nZXRVVENGdWxsWWVhcigpICsgJy0nICsKICAgICAgICAgIGYodGhpcy5nZXRVVENNb250aCgpICsgMSkgKyAnLScgKwogICAgICAgICAgZih0aGlzLmdldFVUQ0RhdGUoKSkgKyAnVCcgKwogICAgICAgICAgZih0aGlzLmdldFVUQ0hvdXJzKCkpICsgJzonICsKICAgICAgICAgIGYodGhpcy5nZXRVVENNaW51dGVzKCkpICsgJzonICsKICAgICAgICAgIGYodGhpcy5nZXRVVENTZWNvbmRzKCkpICsgJ1onOwogICAgICB9OwoKCiAgICAgIHZhciBlc2NhcGVhYmxlID0gL1siXFxceDAwLVx4MWZceDdmLVx4OWZdL2csCiAgICAgICAgZ2FwLAogICAgICAgIGluZGVudCwKICAgICAgICBtZXRhID0geyAvLyB0YWJsZSBvZiBjaGFyYWN0ZXIgc3Vic3RpdHV0aW9ucwogICAgICAgICAgJ1xiJzogJ1xcYicsCiAgICAgICAgICAnXHQnOiAnXFx0JywKICAgICAgICAgICdcbic6ICdcXG4nLAogICAgICAgICAgJ1xmJzogJ1xcZicsCiAgICAgICAgICAnXHInOiAnXFxyJywKICAgICAgICAgICciJzogJ1xcIicsCiAgICAgICAgICAnXFwnOiAnXFxcXCcKICAgICAgICB9LAogICAgICAgIHJlcDsKCgogICAgICBmdW5jdGlvbiBxdW90ZShzdHJpbmcpIHsKCiAgICAgICAgLy8gSWYgdGhlIHN0cmluZyBjb250YWlucyBubyBjb250cm9sIGNoYXJhY3RlcnMsIG5vIHF1b3RlIGNoYXJhY3RlcnMsIGFuZCBubwogICAgICAgIC8vIGJhY2tzbGFzaCBjaGFyYWN0ZXJzLCB0aGVuIHdlIGNhbiBzYWZlbHkgc2xhcCBzb21lIHF1b3RlcyBhcm91bmQgaXQuCiAgICAgICAgLy8gT3RoZXJ3aXNlIHdlIG11c3QgYWxzbyByZXBsYWNlIHRoZSBvZmZlbmRpbmcgY2hhcmFjdGVycyB3aXRoIHNhZmUgZXNjYXBlCiAgICAgICAgLy8gc2VxdWVuY2VzLgoKICAgICAgICByZXR1cm4gZXNjYXBlYWJsZS50ZXN0KHN0cmluZykgPwogICAgICAgICAgJyInICsgc3RyaW5nLnJlcGxhY2UoZXNjYXBlYWJsZSwgZnVuY3Rpb24oYSkgewogICAgICAgICAgICB2YXIgYyA9IG1ldGFbYV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgYyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICByZXR1cm4gYzsKICAgICAgICAgICAgfQogICAgICAgICAgICBjID0gYS5jaGFyQ29kZUF0KCk7CiAgICAgICAgICAgIHJldHVybiAnXFx1MDAnICsgTWF0aC5mbG9vcihjIC8gMTYpLnRvU3RyaW5nKDE2KSArCiAgICAgICAgICAgICAgKGMgJSAxNikudG9TdHJpbmcoMTYpOwogICAgICAgICAgfSkgKyAnIicgOgogICAgICAgICAgJyInICsgc3RyaW5nICsgJyInOwogICAgICB9CgoKICAgICAgZnVuY3Rpb24gc3RyKGtleSwgaG9sZGVyKSB7CgogICAgICAgIC8vIFByb2R1Y2UgYSBzdHJpbmcgZnJvbSBob2xkZXJba2V5XS4KCiAgICAgICAgdmFyIGksIC8vIFRoZSBsb29wIGNvdW50ZXIuCiAgICAgICAgICBrLCAvLyBUaGUgbWVtYmVyIGtleS4KICAgICAgICAgIHYsIC8vIFRoZSBtZW1iZXIgdmFsdWUuCiAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICBtaW5kID0gZ2FwLAogICAgICAgICAgcGFydGlhbCwKICAgICAgICAgIHZhbHVlID0gaG9sZGVyW2tleV07CgogICAgICAgIC8vIElmIHRoZSB2YWx1ZSBoYXMgYSB0b0pTT04gbWV0aG9kLCBjYWxsIGl0IHRvIG9idGFpbiBhIHJlcGxhY2VtZW50IHZhbHVlLgoKICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJgogICAgICAgICAgdHlwZW9mIHZhbHVlLnRvSlNPTiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgdmFsdWUgPSB2YWx1ZS50b0pTT04oa2V5KTsKICAgICAgICB9CgogICAgICAgIC8vIElmIHdlIHdlcmUgY2FsbGVkIHdpdGggYSByZXBsYWNlciBmdW5jdGlvbiwgdGhlbiBjYWxsIHRoZSByZXBsYWNlciB0bwogICAgICAgIC8vIG9idGFpbiBhIHJlcGxhY2VtZW50IHZhbHVlLgoKICAgICAgICBpZiAodHlwZW9mIHJlcCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgdmFsdWUgPSByZXAuY2FsbChob2xkZXIsIGtleSwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gV2hhdCBoYXBwZW5zIG5leHQgZGVwZW5kcyBvbiB0aGUgdmFsdWUncyB0eXBlLgoKICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgcmV0dXJuIHF1b3RlKHZhbHVlKTsKCiAgICAgICAgICBjYXNlICdudW1iZXInOgoKICAgICAgICAgICAgLy8gSlNPTiBudW1iZXJzIG11c3QgYmUgZmluaXRlLiBFbmNvZGUgbm9uLWZpbml0ZSBudW1iZXJzIGFzIG51bGwuCgogICAgICAgICAgICByZXR1cm4gaXNGaW5pdGUodmFsdWUpID8gU3RyaW5nKHZhbHVlKSA6ICdudWxsJzsKCiAgICAgICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICAgIGNhc2UgJ251bGwnOgoKICAgICAgICAgICAgLy8gSWYgdGhlIHZhbHVlIGlzIGEgYm9vbGVhbiBvciBudWxsLCBjb252ZXJ0IGl0IHRvIGEgc3RyaW5nLiBOb3RlOgogICAgICAgICAgICAvLyB0eXBlb2YgbnVsbCBkb2VzIG5vdCBwcm9kdWNlICdudWxsJy4gVGhlIGNhc2UgaXMgaW5jbHVkZWQgaGVyZSBpbgogICAgICAgICAgICAvLyB0aGUgcmVtb3RlIGNoYW5jZSB0aGF0IHRoaXMgZ2V0cyBmaXhlZCBzb21lZGF5LgoKICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7CgogICAgICAgICAgICAvLyBJZiB0aGUgdHlwZSBpcyAnb2JqZWN0Jywgd2UgbWlnaHQgYmUgZGVhbGluZyB3aXRoIGFuIG9iamVjdCBvciBhbiBhcnJheSBvcgogICAgICAgICAgICAvLyBudWxsLgoKICAgICAgICAgIGNhc2UgJ29iamVjdCc6CgogICAgICAgICAgICAvLyBEdWUgdG8gYSBzcGVjaWZpY2F0aW9uIGJsdW5kZXIgaW4gRUNNQVNjcmlwdCwgdHlwZW9mIG51bGwgaXMgJ29iamVjdCcsCiAgICAgICAgICAgIC8vIHNvIHdhdGNoIG91dCBmb3IgdGhhdCBjYXNlLgoKICAgICAgICAgICAgaWYgKCF2YWx1ZSkgewogICAgICAgICAgICAgIHJldHVybiAnbnVsbCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1ha2UgYW4gYXJyYXkgdG8gaG9sZCB0aGUgcGFydGlhbCByZXN1bHRzIG9mIHN0cmluZ2lmeWluZyB0aGlzIG9iamVjdCB2YWx1ZS4KCiAgICAgICAgICAgIGdhcCArPSBpbmRlbnQ7CiAgICAgICAgICAgIHBhcnRpYWwgPSBbXTsKCiAgICAgICAgICAgIC8vIElmIHRoZSBvYmplY3QgaGFzIGEgZG9udEVudW0gbGVuZ3RoIHByb3BlcnR5LCB3ZSdsbCB0cmVhdCBpdCBhcyBhbiBhcnJheS4KCiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUubGVuZ3RoID09PSAnbnVtYmVyJyAmJiAhKHZhbHVlLnByb3BlcnR5SXNFbnVtZXJhYmxlKCdsZW5ndGgnKSkpIHsKCiAgICAgICAgICAgICAgLy8gVGhlIG9iamVjdCBpcyBhbiBhcnJheS4gU3RyaW5naWZ5IGV2ZXJ5IGVsZW1lbnQuIFVzZSBudWxsIGFzIGEgcGxhY2Vob2xkZXIKICAgICAgICAgICAgICAvLyBmb3Igbm9uLUpTT04gdmFsdWVzLgoKICAgICAgICAgICAgICBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICBwYXJ0aWFsW2ldID0gc3RyKGksIHZhbHVlKSB8fCAnbnVsbCc7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBKb2luIGFsbCBvZiB0aGUgZWxlbWVudHMgdG9nZXRoZXIsIHNlcGFyYXRlZCB3aXRoIGNvbW1hcywgYW5kIHdyYXAgdGhlbSBpbgogICAgICAgICAgICAgIC8vIGJyYWNrZXRzLgoKICAgICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAgPyAnW10nIDoKICAgICAgICAgICAgICAgIGdhcCA/ICdbXG4nICsgZ2FwICsgcGFydGlhbC5qb2luKCcsXG4nICsgZ2FwKSArCiAgICAgICAgICAgICAgICAnXG4nICsgbWluZCArICddJyA6CiAgICAgICAgICAgICAgICAnWycgKyBwYXJ0aWFsLmpvaW4oJywnKSArICddJzsKICAgICAgICAgICAgICBnYXAgPSBtaW5kOwogICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB0aGUgcmVwbGFjZXIgaXMgYW4gYXJyYXksIHVzZSBpdCB0byBzZWxlY3QgdGhlIG1lbWJlcnMgdG8gYmUgc3RyaW5naWZpZWQuCgogICAgICAgICAgICBpZiAodHlwZW9mIHJlcCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICBsZW5ndGggPSByZXAubGVuZ3RoOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgayA9IHJlcFtpXTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgayA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgdiA9IHN0cihrLCB2YWx1ZSwgcmVwKTsKICAgICAgICAgICAgICAgICAgaWYgKHYpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0aWFsLnB1c2gocXVvdGUoaykgKyAoZ2FwID8gJzogJyA6ICc6JykgKyB2KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBpdGVyYXRlIHRocm91Z2ggYWxsIG9mIHRoZSBrZXlzIGluIHRoZSBvYmplY3QuCgogICAgICAgICAgICAgIGZvciAoayBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgdiA9IHN0cihrLCB2YWx1ZSwgcmVwKTsKICAgICAgICAgICAgICAgIGlmICh2KSB7CiAgICAgICAgICAgICAgICAgIHBhcnRpYWwucHVzaChxdW90ZShrKSArIChnYXAgPyAnOiAnIDogJzonKSArIHYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSm9pbiBhbGwgb2YgdGhlIG1lbWJlciB0ZXh0cyB0b2dldGhlciwgc2VwYXJhdGVkIHdpdGggY29tbWFzLAogICAgICAgICAgICAvLyBhbmQgd3JhcCB0aGVtIGluIGJyYWNlcy4KCiAgICAgICAgICAgIHYgPSBwYXJ0aWFsLmxlbmd0aCA9PT0gMCA/ICd7fScgOgogICAgICAgICAgICAgIGdhcCA/ICd7XG4nICsgZ2FwICsgcGFydGlhbC5qb2luKCcsXG4nICsgZ2FwKSArCiAgICAgICAgICAgICAgJ1xuJyArIG1pbmQgKyAnfScgOgogICAgICAgICAgICAgICd7JyArIHBhcnRpYWwuam9pbignLCcpICsgJ30nOwogICAgICAgICAgICBnYXAgPSBtaW5kOwogICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICB9CiAgICAgIH0KCgogICAgICAvLyBSZXR1cm4gdGhlIEpTT04gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHN0cmluZ2lmeSwgcGFyc2UsIGFuZCBxdW90ZSBtZXRob2RzLgoKICAgICAgcmV0dXJuIHsKICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKHZhbHVlLCByZXBsYWNlciwgc3BhY2UpIHsKCiAgICAgICAgICAvLyBUaGUgc3RyaW5naWZ5IG1ldGhvZCB0YWtlcyBhIHZhbHVlIGFuZCBhbiBvcHRpb25hbCByZXBsYWNlciwgYW5kIGFuIG9wdGlvbmFsCiAgICAgICAgICAvLyBzcGFjZSBwYXJhbWV0ZXIsIGFuZCByZXR1cm5zIGEgSlNPTiB0ZXh0LiBUaGUgcmVwbGFjZXIgY2FuIGJlIGEgZnVuY3Rpb24KICAgICAgICAgIC8vIHRoYXQgY2FuIHJlcGxhY2UgdmFsdWVzLCBvciBhbiBhcnJheSBvZiBzdHJpbmdzIHRoYXQgd2lsbCBzZWxlY3QgdGhlIGtleXMuCiAgICAgICAgICAvLyBBIGRlZmF1bHQgcmVwbGFjZXIgbWV0aG9kIGNhbiBiZSBwcm92aWRlZC4gVXNlIG9mIHRoZSBzcGFjZSBwYXJhbWV0ZXIgY2FuCiAgICAgICAgICAvLyBwcm9kdWNlIHRleHQgdGhhdCBpcyBtb3JlIGVhc2lseSByZWFkYWJsZS4KCiAgICAgICAgICB2YXIgaTsKICAgICAgICAgIGdhcCA9ICcnOwogICAgICAgICAgaW5kZW50ID0gJyc7CiAgICAgICAgICBpZiAoc3BhY2UpIHsKCiAgICAgICAgICAgIC8vIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIG1ha2UgYW4gaW5kZW50IHN0cmluZyBjb250YWluaW5nIHRoYXQKICAgICAgICAgICAgLy8gbWFueSBzcGFjZXMuCgogICAgICAgICAgICBpZiAodHlwZW9mIHNwYWNlID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzcGFjZTsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICBpbmRlbnQgKz0gJyAnOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIHN0cmluZywgaXQgd2lsbCBiZSB1c2VkIGFzIHRoZSBpbmRlbnQgc3RyaW5nLgoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgaW5kZW50ID0gc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyByZXBsYWNlciBwYXJhbWV0ZXIsIHVzZSB0aGUgZGVmYXVsdCByZXBsYWNlci4KCiAgICAgICAgICBpZiAoIXJlcGxhY2VyKSB7CiAgICAgICAgICAgIHJlcCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICBpZiAoIU9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsIGtleSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbiBvciBhbiBhcnJheS4gT3RoZXJ3aXNlLCB0aHJvdyBhbiBlcnJvci4KCiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZXBsYWNlciA9PT0gJ2Z1bmN0aW9uJyB8fAogICAgICAgICAgICAodHlwZW9mIHJlcGxhY2VyID09PSAnb2JqZWN0JyAmJgogICAgICAgICAgICAgIHR5cGVvZiByZXBsYWNlci5sZW5ndGggPT09ICdudW1iZXInKSkgewogICAgICAgICAgICByZXAgPSByZXBsYWNlcjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSlNPTi5zdHJpbmdpZnknKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBNYWtlIGEgZmFrZSByb290IG9iamVjdCBjb250YWluaW5nIG91ciB2YWx1ZSB1bmRlciB0aGUga2V5IG9mICcnLgogICAgICAgICAgLy8gUmV0dXJuIHRoZSByZXN1bHQgb2Ygc3RyaW5naWZ5aW5nIHRoZSB2YWx1ZS4KCiAgICAgICAgICByZXR1cm4gc3RyKCcnLCB7CiAgICAgICAgICAgICcnOiB2YWx1ZQogICAgICAgICAgfSk7CiAgICAgICAgfSwKCgogICAgICAgIHBhcnNlOiBmdW5jdGlvbih0ZXh0LCByZXZpdmVyKSB7CgogICAgICAgICAgLy8gVGhlIHBhcnNlIG1ldGhvZCB0YWtlcyBhIHRleHQgYW5kIGFuIG9wdGlvbmFsIHJldml2ZXIgZnVuY3Rpb24sIGFuZCByZXR1cm5zCiAgICAgICAgICAvLyBhIEphdmFTY3JpcHQgdmFsdWUgaWYgdGhlIHRleHQgaXMgYSB2YWxpZCBKU09OIHRleHQuCgogICAgICAgICAgdmFyIGo7CgogICAgICAgICAgZnVuY3Rpb24gd2Fsayhob2xkZXIsIGtleSkgewoKICAgICAgICAgICAgLy8gVGhlIHdhbGsgbWV0aG9kIGlzIHVzZWQgdG8gcmVjdXJzaXZlbHkgd2FsayB0aGUgcmVzdWx0aW5nIHN0cnVjdHVyZSBzbwogICAgICAgICAgICAvLyB0aGF0IG1vZGlmaWNhdGlvbnMgY2FuIGJlIG1hZGUuCgogICAgICAgICAgICB2YXIgaywgdiwgdmFsdWUgPSBob2xkZXJba2V5XTsKICAgICAgICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICBmb3IgKGsgaW4gdmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgaykpIHsKICAgICAgICAgICAgICAgICAgdiA9IHdhbGsodmFsdWUsIGspOwogICAgICAgICAgICAgICAgICBpZiAodiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWVba10gPSB2OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2YWx1ZVtrXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV2aXZlci5jYWxsKGhvbGRlciwga2V5LCB2YWx1ZSk7CiAgICAgICAgICB9CgoKICAgICAgICAgIC8vIFBhcnNpbmcgaGFwcGVucyBpbiB0aHJlZSBzdGFnZXMuIEluIHRoZSBmaXJzdCBzdGFnZSwgd2UgcnVuIHRoZSB0ZXh0IGFnYWluc3QKICAgICAgICAgIC8vIHJlZ3VsYXIgZXhwcmVzc2lvbnMgdGhhdCBsb29rIGZvciBub24tSlNPTiBwYXR0ZXJucy4gV2UgYXJlIGVzcGVjaWFsbHkKICAgICAgICAgIC8vIGNvbmNlcm5lZCB3aXRoICcoKScgYW5kICduZXcnIGJlY2F1c2UgdGhleSBjYW4gY2F1c2UgaW52b2NhdGlvbiwgYW5kICc9JwogICAgICAgICAgLy8gYmVjYXVzZSBpdCBjYW4gY2F1c2UgbXV0YXRpb24uIEJ1dCBqdXN0IHRvIGJlIHNhZmUsIHdlIHdhbnQgdG8gcmVqZWN0IGFsbAogICAgICAgICAgLy8gdW5leHBlY3RlZCBmb3Jtcy4KCiAgICAgICAgICAvLyBXZSBzcGxpdCB0aGUgZmlyc3Qgc3RhZ2UgaW50byA0IHJlZ2V4cCBvcGVyYXRpb25zIGluIG9yZGVyIHRvIHdvcmsgYXJvdW5kCiAgICAgICAgICAvLyBjcmlwcGxpbmcgaW5lZmZpY2llbmNpZXMgaW4gSUUncyBhbmQgU2FmYXJpJ3MgcmVnZXhwIGVuZ2luZXMuIEZpcnN0IHdlCiAgICAgICAgICAvLyByZXBsYWNlIGFsbCBiYWNrc2xhc2ggcGFpcnMgd2l0aCAnQCcgKGEgbm9uLUpTT04gY2hhcmFjdGVyKS4gU2Vjb25kLCB3ZQogICAgICAgICAgLy8gcmVwbGFjZSBhbGwgc2ltcGxlIHZhbHVlIHRva2VucyB3aXRoICddJyBjaGFyYWN0ZXJzLiBUaGlyZCwgd2UgZGVsZXRlIGFsbAogICAgICAgICAgLy8gb3BlbiBicmFja2V0cyB0aGF0IGZvbGxvdyBhIGNvbG9uIG9yIGNvbW1hIG9yIHRoYXQgYmVnaW4gdGhlIHRleHQuIEZpbmFsbHksCiAgICAgICAgICAvLyB3ZSBsb29rIHRvIHNlZSB0aGF0IHRoZSByZW1haW5pbmcgY2hhcmFjdGVycyBhcmUgb25seSB3aGl0ZXNwYWNlIG9yICddJyBvcgogICAgICAgICAgLy8gJywnIG9yICc6JyBvciAneycgb3IgJ30nLiBJZiB0aGF0IGlzIHNvLCB0aGVuIHRoZSB0ZXh0IGlzIHNhZmUgZm9yIGV2YWwuCgogICAgICAgICAgaWYgKC9eW1xdLDp7fVxzXSokLy50ZXN0KHRleHQucmVwbGFjZSgvXFxbIlxcXC9iZm5ydHVdL2csICdAJykucmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICddJykucmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAnJykpKSB7CgogICAgICAgICAgICAvLyBJbiB0aGUgc2Vjb25kIHN0YWdlIHdlIHVzZSB0aGUgZXZhbCBmdW5jdGlvbiB0byBjb21waWxlIHRoZSB0ZXh0IGludG8gYQogICAgICAgICAgICAvLyBKYXZhU2NyaXB0IHN0cnVjdHVyZS4gVGhlICd7JyBvcGVyYXRvciBpcyBzdWJqZWN0IHRvIGEgc3ludGFjdGljIGFtYmlndWl0eQogICAgICAgICAgICAvLyBpbiBKYXZhU2NyaXB0OiBpdCBjYW4gYmVnaW4gYSBibG9jayBvciBhbiBvYmplY3QgbGl0ZXJhbC4gV2Ugd3JhcCB0aGUgdGV4dAogICAgICAgICAgICAvLyBpbiBwYXJlbnMgdG8gZWxpbWluYXRlIHRoZSBhbWJpZ3VpdHkuCgogICAgICAgICAgICBqID0gZXZhbCgnKCcgKyB0ZXh0ICsgJyknKTsKCiAgICAgICAgICAgIC8vIEluIHRoZSBvcHRpb25hbCB0aGlyZCBzdGFnZSwgd2UgcmVjdXJzaXZlbHkgd2FsayB0aGUgbmV3IHN0cnVjdHVyZSwgcGFzc2luZwogICAgICAgICAgICAvLyBlYWNoIG5hbWUvdmFsdWUgcGFpciB0byBhIHJldml2ZXIgZnVuY3Rpb24gZm9yIHBvc3NpYmxlIHRyYW5zZm9ybWF0aW9uLgoKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiByZXZpdmVyID09PSAnZnVuY3Rpb24nID8KICAgICAgICAgICAgICB3YWxrKHsKICAgICAgICAgICAgICAgICcnOiBqCiAgICAgICAgICAgICAgfSwgJycpIDogajsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBJZiB0aGUgdGV4dCBpcyBub3QgSlNPTiBwYXJzZWFibGUsIHRoZW4gYSBTeW50YXhFcnJvciBpcyB0aHJvd24uCgogICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCdKU09OLnBhcnNlJyk7CiAgICAgICAgfSwKCiAgICAgICAgcXVvdGU6IHF1b3RlCiAgICAgIH07CiAgICB9KCk7CiAgfQoKICAvL2pzb24gZW5kCgogIC8vcGVyc2lzdC1taW4gc3RhcnQKCiAgKGZ1bmN0aW9uKCkgewogICAgaWYgKHdpbmRvdy5nb29nbGUgJiYgZ29vZ2xlLmdlYXJzKQogICAgICByZXR1cm47CiAgICB2YXIgRiA9IG51bGw7CiAgICBpZiAodHlwZW9mIEdlYXJzRmFjdG9yeSAhPSAndW5kZWZpbmVkJykgewogICAgICBGID0gbmV3IEdlYXJzRmFjdG9yeSgpOwogICAgfSBlbHNlIHsKICAgICAgdHJ5IHsKICAgICAgICBGID0gbmV3IEFjdGl2ZVhPYmplY3QoJ0dlYXJzLkZhY3RvcnknKTsKICAgICAgICBpZiAoRi5nZXRCdWlsZEluZm8oKS5pbmRleE9mKCdpZV9tb2JpbGUnKSAhPSAtMSkKICAgICAgICAgIEYucHJpdmF0ZVNldEdsb2JhbE9iamVjdCh0aGlzKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmICgodHlwZW9mIG5hdmlnYXRvci5taW1lVHlwZXMgIT0gJ3VuZGVmaW5lZCcpICYmIG5hdmlnYXRvci5taW1lVHlwZXNbImFwcGxpY2F0aW9uL3gtZ29vZ2xlZ2VhcnMiXSkgewogICAgICAgICAgRiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9iamVjdCIpOwogICAgICAgICAgRi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgRi53aWR0aCA9IDA7CiAgICAgICAgICBGLmhlaWdodCA9IDA7CiAgICAgICAgICBGLnR5cGUgPSAiYXBwbGljYXRpb24veC1nb29nbGVnZWFycyI7CiAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoRik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoIUYpCiAgICAgIHJldHVybjsKICAgIGlmICghd2luZG93Lmdvb2dsZSkKICAgICAgZ29vZ2xlID0ge307CiAgICBpZiAoIWdvb2dsZS5nZWFycykKICAgICAgZ29vZ2xlLmdlYXJzID0gewogICAgICAgIGZhY3Rvcnk6IEYKICAgICAgfTsKICB9KSgpOwogIFBlcnNpc3QgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgVkVSU0lPTiA9ICcwLjIuMCcsCiAgICAgIFAsIEIsIGVzYywgaW5pdCwgZW1wdHksIGVjOwogICAgZWMgPSAoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBFUE9DSCA9ICdUaHUsIDAxLUphbi0xOTcwIDAwOjAwOjAxIEdNVCcsCiAgICAgICAgUkFUSU8gPSAxMDAwICogNjAgKiA2MCAqIDI0LAogICAgICAgIEtFWVMgPSBbJ2V4cGlyZXMnLCAncGF0aCcsICdkb21haW4nXSwKICAgICAgICBlc2MgPSBlc2NhcGUsCiAgICAgICAgdW4gPSB1bmVzY2FwZSwKICAgICAgICBkb2MgPSBkb2N1bWVudCwKICAgICAgICBtZTsKICAgICAgdmFyIGdldF9ub3cgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgciA9IG5ldyBEYXRlKCk7CiAgICAgICAgci5zZXRUaW1lKHIuZ2V0VGltZSgpKTsKICAgICAgICByZXR1cm4gcjsKICAgICAgfQogICAgICB2YXIgY29va2lmeSA9IGZ1bmN0aW9uKGNfa2V5LCBjX3ZhbCkgewogICAgICAgIHZhciBpLCBrZXksIHZhbCwgciA9IFtdLAogICAgICAgICAgb3B0ID0gKGFyZ3VtZW50cy5sZW5ndGggPiAyKSA/IGFyZ3VtZW50c1syXSA6IHt9OwogICAgICAgIHIucHVzaChlc2MoY19rZXkpICsgJz0nICsgZXNjKGNfdmFsKSk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IEtFWVMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGtleSA9IEtFWVNbaV07CiAgICAgICAgICBpZiAodmFsID0gb3B0W2tleV0pCiAgICAgICAgICAgIHIucHVzaChrZXkgKyAnPScgKyB2YWwpOwogICAgICAgIH0KICAgICAgICBpZiAob3B0LnNlY3VyZSkKICAgICAgICAgIHIucHVzaCgnc2VjdXJlJyk7CiAgICAgICAgcmV0dXJuIHIuam9pbignOyAnKTsKICAgICAgfQogICAgICB2YXIgYWxpdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgayA9ICdfX0VDX1RFU1RfXycsCiAgICAgICAgICB2ID0gbmV3IERhdGUoKTsKICAgICAgICB2ID0gdi50b0dNVFN0cmluZygpOwogICAgICAgIHRoaXMuc2V0KGssIHYpOwogICAgICAgIHRoaXMuZW5hYmxlZCA9ICh0aGlzLnJlbW92ZShrKSA9PSB2KTsKICAgICAgICByZXR1cm4gdGhpcy5lbmFibGVkOwogICAgICB9CiAgICAgIG1lID0gewogICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwpIHsKICAgICAgICAgIHZhciBvcHQgPSAoYXJndW1lbnRzLmxlbmd0aCA+IDIpID8gYXJndW1lbnRzWzJdIDoge30sIG5vdyA9IGdldF9ub3coKSwKICAgICAgICAgICAgZXhwaXJlX2F0LCBjZmcgPSB7fTsKICAgICAgICAgIGlmIChvcHQuZXhwaXJlcykgewogICAgICAgICAgICBvcHQuZXhwaXJlcyAqPSBSQVRJTzsKICAgICAgICAgICAgY2ZnLmV4cGlyZXMgPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpICsgb3B0LmV4cGlyZXMpOwogICAgICAgICAgICBjZmcuZXhwaXJlcyA9IGNmZy5leHBpcmVzLnRvR01UU3RyaW5nKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5cyA9IFsncGF0aCcsICdkb21haW4nLCAnc2VjdXJlJ107CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgaWYgKG9wdFtrZXlzW2ldXSkKICAgICAgICAgICAgICBjZmdba2V5c1tpXV0gPSBvcHRba2V5c1tpXV07CiAgICAgICAgICB2YXIgciA9IGNvb2tpZnkoa2V5LCB2YWwsIGNmZyk7CiAgICAgICAgICBkb2MuY29va2llID0gcjsKICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfSwKICAgICAgICBoYXM6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAga2V5ID0gZXNjKGtleSk7CiAgICAgICAgICB2YXIgYyA9IGRvYy5jb29raWUsCiAgICAgICAgICAgIG9mcyA9IGMuaW5kZXhPZihrZXkgKyAnPScpLAogICAgICAgICAgICBsZW4gPSBvZnMgKyBrZXkubGVuZ3RoICsgMSwKICAgICAgICAgICAgc3ViID0gYy5zdWJzdHJpbmcoMCwga2V5Lmxlbmd0aCk7CiAgICAgICAgICByZXR1cm4gKCghb2ZzICYmIGtleSAhPSBzdWIpIHx8IG9mcyA8IDApID8gZmFsc2UgOiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgdmFyIGMgPSBkb2MuY29va2llLAogICAgICAgICAgICBvZnMgPSBjLmluZGV4T2Yoa2V5ICsgJz0nKSwKICAgICAgICAgICAgbGVuID0gb2ZzICsga2V5Lmxlbmd0aCArIDEsCiAgICAgICAgICAgIHN1YiA9IGMuc3Vic3RyaW5nKDAsIGtleS5sZW5ndGgpLAogICAgICAgICAgICBlbmQ7CiAgICAgICAgICBpZiAoKCFvZnMgJiYga2V5ICE9IHN1YikgfHwgb2ZzIDwgMCkKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICBlbmQgPSBjLmluZGV4T2YoJzsnLCBsZW4pOwogICAgICAgICAgaWYgKGVuZCA8IDApCiAgICAgICAgICAgIGVuZCA9IGMubGVuZ3RoOwogICAgICAgICAgcmV0dXJuIHVuKGMuc3Vic3RyaW5nKGxlbiwgZW5kKSk7CiAgICAgICAgfSwKICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGspIHsKICAgICAgICAgIHZhciByID0gbWUuZ2V0KGspLAogICAgICAgICAgICBvcHQgPSB7CiAgICAgICAgICAgICAgZXhwaXJlczogRVBPQ0gKICAgICAgICAgICAgfTsKICAgICAgICAgIGRvYy5jb29raWUgPSBjb29raWZ5KGssICcnLCBvcHQpOwogICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSwKICAgICAgICBrZXlzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBjID0gZG9jLmNvb2tpZSwKICAgICAgICAgICAgcHMgPSBjLnNwbGl0KCc7ICcpLAogICAgICAgICAgICBpLCBwLCByID0gW107CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcCA9IHBzW2ldLnNwbGl0KCc9Jyk7CiAgICAgICAgICAgIHIucHVzaCh1bihwWzBdKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcjsKICAgICAgICB9LAogICAgICAgIGFsbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYyA9IGRvYy5jb29raWUsCiAgICAgICAgICAgIHBzID0gYy5zcGxpdCgnOyAnKSwKICAgICAgICAgICAgaSwgcCwgciA9IFtdOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHAgPSBwc1tpXS5zcGxpdCgnPScpOwogICAgICAgICAgICByLnB1c2goW3VuKHBbMF0pLCB1bihwWzFdKV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSwKICAgICAgICB2ZXJzaW9uOiAnMC4yLjEnLAogICAgICAgIGVuYWJsZWQ6IGZhbHNlCiAgICAgIH07CiAgICAgIG1lLmVuYWJsZWQgPSBhbGl2ZS5jYWxsKG1lKTsKICAgICAgcmV0dXJuIG1lOwogICAgfSgpKTsKICAgIHZhciBpbmRleF9vZiA9IChmdW5jdGlvbigpIHsKICAgICAgaWYgKEFycmF5LnByb3RvdHlwZS5pbmRleE9mKQogICAgICAgIHJldHVybiBmdW5jdGlvbihhcnksIHZhbCkgewogICAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5pbmRleE9mLmNhbGwoYXJ5LCB2YWwpOwogICAgICAgIH07CiAgICAgIGVsc2UKICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJ5LCB2YWwpIHsKICAgICAgICAgIHZhciBpLCBsOwogICAgICAgICAgZm9yIChpID0gMCwgbCA9IGFyeS5sZW5ndGg7IGkgPCBsOyBpKyspCiAgICAgICAgICAgIGlmIChhcnlbaV0gPT0gdmFsKQogICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH07CiAgICB9KSgpOwogICAgZW1wdHkgPSBmdW5jdGlvbigpIHt9OwogICAgZXNjID0gZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiAnUFMnICsgc3RyLnJlcGxhY2UoL18vZywgJ19fJykucmVwbGFjZSgvIC9nLCAnX3MnKTsKICAgIH07CiAgICBDID0gewogICAgICBzZWFyY2hfb3JkZXI6IFsnbG9jYWxzdG9yYWdlJywgJ3doYXR3Z19kYicsICdnbG9iYWxzdG9yYWdlJywgJ2dlYXJzJywgJ2llJywgJ2ZsYXNoJywgJ2Nvb2tpZSddLAogICAgICBuYW1lX3JlOiAvXlthLXpdW2EtejAtOV8gLV0rJC9pLAogICAgICBtZXRob2RzOiBbJ2luaXQnLCAnZ2V0JywgJ3NldCcsICdyZW1vdmUnLCAnbG9hZCcsICdzYXZlJ10sCiAgICAgIHNxbDogewogICAgICAgIHZlcnNpb246ICcxJywKICAgICAgICBjcmVhdGU6ICJDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBwZXJzaXN0X2RhdGEgKGsgVEVYVCBVTklRVUUgTk9UIE5VTEwgUFJJTUFSWSBLRVksIHYgVEVYVCBOT1QgTlVMTCkiLAogICAgICAgIGdldDogIlNFTEVDVCB2IEZST00gcGVyc2lzdF9kYXRhIFdIRVJFIGsgPSA/IiwKICAgICAgICBzZXQ6ICJJTlNFUlQgSU5UTyBwZXJzaXN0X2RhdGEoaywgdikgVkFMVUVTICg/LCA/KSIsCiAgICAgICAgcmVtb3ZlOiAiREVMRVRFIEZST00gcGVyc2lzdF9kYXRhIFdIRVJFIGsgPSA/IgogICAgICB9LAogICAgICBmbGFzaDogewogICAgICAgIGRpdl9pZDogJ19wZXJzaXN0X2ZsYXNoX3dyYXAnLAogICAgICAgIGlkOiAnX3BlcnNpc3RfZmxhc2gnLAogICAgICAgIHBhdGg6ICdwZXJzaXN0LnN3ZicsCiAgICAgICAgc2l6ZTogewogICAgICAgICAgdzogMSwKICAgICAgICAgIGg6IDEKICAgICAgICB9LAogICAgICAgIGFyZ3M6IHsKICAgICAgICAgIGF1dG9zdGFydDogdHJ1ZQogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIEIgPSB7CiAgICAgIGdlYXJzOiB7CiAgICAgICAgc2l6ZTogLTEsCiAgICAgICAgdGVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gKHdpbmRvdy5nb29nbGUgJiYgd2luZG93Lmdvb2dsZS5nZWFycykgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgfSwKICAgICAgICBtZXRob2RzOiB7CiAgICAgICAgICB0cmFuc2FjdGlvbjogZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgdmFyIGRiID0gdGhpcy5kYjsKICAgICAgICAgICAgZGIuZXhlY3V0ZSgnQkVHSU4nKS5jbG9zZSgpOwogICAgICAgICAgICBmbi5jYWxsKHRoaXMsIGRiKTsKICAgICAgICAgICAgZGIuZXhlY3V0ZSgnQ09NTUlUJykuY2xvc2UoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGRiOwogICAgICAgICAgICBkYiA9IHRoaXMuZGIgPSBnb29nbGUuZ2VhcnMuZmFjdG9yeS5jcmVhdGUoJ2JldGEuZGF0YWJhc2UnKTsKICAgICAgICAgICAgZGIub3Blbihlc2ModGhpcy5uYW1lKSk7CiAgICAgICAgICAgIGRiLmV4ZWN1dGUoQy5zcWwuY3JlYXRlKS5jbG9zZSgpOwogICAgICAgICAgfSwKICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHIsIHNxbCA9IEMuc3FsLmdldDsKICAgICAgICAgICAgaWYgKCFmbikKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHZhciBpc192YWxpZCwgdmFsOwogICAgICAgICAgICAgIHIgPSB0LmV4ZWN1dGUoc3FsLCBba2V5XSk7CiAgICAgICAgICAgICAgaXNfdmFsaWQgPSByLmlzVmFsaWRSb3coKTsKICAgICAgICAgICAgICB2YWwgPSBpc192YWxpZCA/IHIuZmllbGQoMCkgOiBudWxsOwogICAgICAgICAgICAgIHIuY2xvc2UoKTsKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIGlzX3ZhbGlkLCB2YWwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHJtX3NxbCA9IEMuc3FsLnJlbW92ZSwKICAgICAgICAgICAgICBzcWwgPSBDLnNxbC5zZXQsCiAgICAgICAgICAgICAgcjsKICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgdC5leGVjdXRlKHJtX3NxbCwgW2tleV0pLmNsb3NlKCk7CiAgICAgICAgICAgICAgdC5leGVjdXRlKHNxbCwgW2tleSwgdmFsXSkuY2xvc2UoKTsKICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIGdldF9zcWwgPSBDLnNxbC5nZXQ7CiAgICAgICAgICAgIHNxbCA9IEMuc3FsLnJlbW92ZSwgciwgdmFsID0gbnVsbCwgaXNfdmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgICByID0gdC5leGVjdXRlKGdldF9zcWwsIFtrZXldKTsKICAgICAgICAgICAgICAgIGlzX3ZhbGlkID0gci5pc1ZhbGlkUm93KCk7CiAgICAgICAgICAgICAgICB2YWwgPSBpc192YWxpZCA/IHIuZmllbGQoMCkgOiBudWxsOwogICAgICAgICAgICAgICAgci5jbG9zZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWZuIHx8IGlzX3ZhbGlkKSB7CiAgICAgICAgICAgICAgICB0LmV4ZWN1dGUoc3FsLCBba2V5XSkuY2xvc2UoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCBpc192YWxpZCwgdmFsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICB3aGF0d2dfZGI6IHsKICAgICAgICBzaXplOiAyMDAgKiAxMDI0LAogICAgICAgIHRlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5hbWUgPSAnUGVyc2lzdEpTIFRlc3QnLAogICAgICAgICAgICAgIGRlc2MgPSAnUGVyc2lzdGVudCBkYXRhYmFzZSB0ZXN0Lic7CiAgICAgICAgICAgIGlmICghd2luZG93Lm9wZW5EYXRhYmFzZSkKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGlmICghd2luZG93Lm9wZW5EYXRhYmFzZShuYW1lLCBDLnNxbC52ZXJzaW9uLCBkZXNjLCBCLndoYXR3Z19kYi5zaXplKSkKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgIH0sCiAgICAgICAgbWV0aG9kczogewogICAgICAgICAgdHJhbnNhY3Rpb246IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kYl9jcmVhdGVkKSB7CiAgICAgICAgICAgICAgdGhpcy5kYi50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICB0LmV4ZWN1dGVTcWwoQy5zcWwuY3JlYXRlLCBbXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuZGJfY3JlYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9LCBlbXB0eSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5kYi50cmFuc2FjdGlvbihmbik7CiAgICAgICAgICB9LAogICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuZGIgPSBvcGVuRGF0YWJhc2UodGhpcy5uYW1lLCBDLnNxbC52ZXJzaW9uLCB0aGlzLm8uYWJvdXQgfHwgKCJQZXJzaXN0ZW50IHN0b3JhZ2UgZm9yICIgKyB0aGlzLm5hbWUpLCB0aGlzLm8uc2l6ZSB8fCBCLndoYXR3Z19kYi5zaXplKTsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciBzcWwgPSBDLnNxbC5nZXQ7CiAgICAgICAgICAgIGlmICghZm4pCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBzY29wZSA9IHNjb3BlIHx8IHRoaXM7CiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHQuZXhlY3V0ZVNxbChzcWwsIFtrZXldLCBmdW5jdGlvbih0LCByKSB7CiAgICAgICAgICAgICAgICBpZiAoci5yb3dzLmxlbmd0aCA+IDApCiAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUsIHRydWUsIHIucm93cy5pdGVtKDApWyd2J10pOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIGZuLCBzY29wZSkgewogICAgICAgICAgICB2YXIgcm1fc3FsID0gQy5zcWwucmVtb3ZlLAogICAgICAgICAgICAgIHNxbCA9IEMuc3FsLnNldDsKICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKHJtX3NxbCwgW2tleV0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKHNxbCwgW2tleSwgdmFsXSwgZnVuY3Rpb24odCwgcikgewogICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgICAgfSwKICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIGdldF9zcWwgPSBDLnNxbC5nZXQ7CiAgICAgICAgICAgIHNxbCA9IEMuc3FsLnJlbW92ZTsKICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgICB0LmV4ZWN1dGVTcWwoZ2V0X3NxbCwgW2tleV0sIGZ1bmN0aW9uKHQsIHIpIHsKICAgICAgICAgICAgICAgICAgaWYgKHIucm93cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IHIucm93cy5pdGVtKDApWyd2J107CiAgICAgICAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKHNxbCwgW2tleV0sIGZ1bmN0aW9uKHQsIHIpIHsKICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIGZhbHNlLCBudWxsKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHQuZXhlY3V0ZVNxbChzcWwsIFtrZXldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgZ2xvYmFsc3RvcmFnZTogewogICAgICAgIHNpemU6IDUgKiAxMDI0ICogMTAyNCwKICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiB3aW5kb3cuZ2xvYmFsU3RvcmFnZSA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbWV0aG9kczogewogICAgICAgICAga2V5OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIGVzYyh0aGlzLm5hbWUpICsgZXNjKGtleSk7CiAgICAgICAgICB9LAogICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGFsZXJ0KCdkb21haW4gPSAnICsgdGhpcy5vLmRvbWFpbik7CiAgICAgICAgICAgIHRoaXMuc3RvcmUgPSBnbG9iYWxTdG9yYWdlW3RoaXMuby5kb21haW5dOwogICAgICAgICAgfSwKICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdGhpcy5zdG9yZS5nZXRJdGVtKGtleSkpOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIGZuLCBzY29wZSkgewogICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICB0aGlzLnN0b3JlLnNldEl0ZW0oa2V5LCB2YWwpOwogICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgfSwKICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgdmFsID0gdGhpcy5zdG9yZVtrZXldOwogICAgICAgICAgICB0aGlzLnN0b3JlLnJlbW92ZUl0ZW0oa2V5KTsKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgKHZhbCAhPT0gbnVsbCksIHZhbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBsb2NhbHN0b3JhZ2U6IHsKICAgICAgICBzaXplOiAtMSwKICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiB3aW5kb3cubG9jYWxTdG9yYWdlID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgIH0sCiAgICAgICAgbWV0aG9kczogewogICAgICAgICAga2V5OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIGVzYyh0aGlzLm5hbWUpICsgZXNjKGtleSk7CiAgICAgICAgICB9LAogICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuc3RvcmUgPSBsb2NhbFN0b3JhZ2U7CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB0aGlzLnN0b3JlLmdldEl0ZW0oa2V5KSk7CiAgICAgICAgICB9LAogICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIGtleSA9IHRoaXMua2V5KGtleSk7CiAgICAgICAgICAgIHRoaXMuc3RvcmUuc2V0SXRlbShrZXksIHZhbCk7CiAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICB2YXIgdmFsOwogICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICB2YWwgPSB0aGlzLnN0b3JlLmdldEl0ZW0oa2V5KTsKICAgICAgICAgICAgdGhpcy5zdG9yZS5yZW1vdmVJdGVtKGtleSk7CiAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsICh2YWwgIT09IG51bGwpLCB2YWwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgaWU6IHsKICAgICAgICBwcmVmaXg6ICdfcGVyc2lzdF9kYXRhLScsCiAgICAgICAgc2l6ZTogNjQgKiAxMDI0LAogICAgICAgIHRlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5BY3RpdmVYT2JqZWN0ID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgIH0sCiAgICAgICAgbWFrZV91c2VyZGF0YTogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgZWwuaWQgPSBpZDsKICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICBlbC5hZGRCZWhhdmlvcignI2RlZmF1bHQjdXNlcmRhdGEnKTsKICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgcmV0dXJuIGVsOwogICAgICAgIH0sCiAgICAgICAgbWV0aG9kczogewogICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBpZCA9IEIuaWUucHJlZml4ICsgZXNjKHRoaXMubmFtZSk7CiAgICAgICAgICAgIHRoaXMuZWwgPSBCLmllLm1ha2VfdXNlcmRhdGEoaWQpOwogICAgICAgICAgICBpZiAodGhpcy5vLmRlZmVyKQogICAgICAgICAgICAgIHRoaXMubG9hZCgpOwogICAgICAgICAgfSwKICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAga2V5ID0gZXNjKGtleSk7CiAgICAgICAgICAgIGlmICghdGhpcy5vLmRlZmVyKQogICAgICAgICAgICAgIHRoaXMubG9hZCgpOwogICAgICAgICAgICB2YWwgPSB0aGlzLmVsLmdldEF0dHJpYnV0ZShrZXkpOwogICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB2YWwgPyB0cnVlIDogZmFsc2UsIHZhbCk7CiAgICAgICAgICB9LAogICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICB0aGlzLmVsLnNldEF0dHJpYnV0ZShrZXksIHZhbCk7CiAgICAgICAgICAgIGlmICghdGhpcy5vLmRlZmVyKQogICAgICAgICAgICAgIHRoaXMuc2F2ZSgpOwogICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgfSwKICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAga2V5ID0gZXNjKGtleSk7CiAgICAgICAgICAgIGlmICghdGhpcy5vLmRlZmVyKQogICAgICAgICAgICAgIHRoaXMubG9hZCgpOwogICAgICAgICAgICB2YWwgPSB0aGlzLmVsLmdldEF0dHJpYnV0ZShrZXkpOwogICAgICAgICAgICB0aGlzLmVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgICAgICAgICBpZiAoIXRoaXMuby5kZWZlcikKICAgICAgICAgICAgICB0aGlzLnNhdmUoKTsKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdmFsID8gdHJ1ZSA6IGZhbHNlLCB2YWwpOwogICAgICAgICAgfSwKICAgICAgICAgIGxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmVsLmxvYWQoZXNjKHRoaXMubmFtZSkpOwogICAgICAgICAgfSwKICAgICAgICAgIHNhdmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmVsLnNhdmUoZXNjKHRoaXMubmFtZSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgY29va2llOiB7CiAgICAgICAgZGVsaW06ICc6JywKICAgICAgICBzaXplOiA0MDAwLAogICAgICAgIHRlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIFAuQ29va2llLmVuYWJsZWQgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgfSwKICAgICAgICBtZXRob2RzOiB7CiAgICAgICAgICBrZXk6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5uYW1lICsgQi5jb29raWUuZGVsaW0gKyBrZXk7CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICB2YXIgdmFsOwogICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICB2YWwgPSBlYy5nZXQoa2V5KTsKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdmFsICE9IG51bGwsIHZhbCk7CiAgICAgICAgICB9LAogICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIGtleSA9IHRoaXMua2V5KGtleSk7CiAgICAgICAgICAgIGVjLnNldChrZXksIHZhbCwgdGhpcy5vKTsKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgdmFsID0gZWMucmVtb3ZlKGtleSkKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdmFsICE9IG51bGwsIHZhbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBmbGFzaDogewogICAgICAgIHRlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKCFkZWNvbmNlcHQgfHwgIWRlY29uY2VwdC5TV0ZPYmplY3RVdGlsKQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgdmFyIG1ham9yID0gZGVjb25jZXB0LlNXRk9iamVjdFV0aWwuZ2V0UGxheWVyVmVyc2lvbigpLm1ham9yOwogICAgICAgICAgICByZXR1cm4gKG1ham9yID49IDgpID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgIH0sCiAgICAgICAgbWV0aG9kczogewogICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghQi5mbGFzaC5lbCkgewogICAgICAgICAgICAgIHZhciBvLCBrZXksIGVsLCBjZmcgPSBDLmZsYXNoOwogICAgICAgICAgICAgIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgZWwuaWQgPSBjZmcuZGl2X2lkOwogICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICAgIG8gPSBuZXcgZGVjb25jZXB0LlNXRk9iamVjdCh0aGlzLm8uc3dmX3BhdGggfHwgY2ZnLnBhdGgsIGNmZy5pZCwgY2ZnLnNpemUudywgY2ZnLnNpemUuaCwgJzgnKTsKICAgICAgICAgICAgICBmb3IgKGtleSBpbiBjZmcuYXJncykKICAgICAgICAgICAgICAgIG8uYWRkVmFyaWFibGUoa2V5LCBjZmcuYXJnc1trZXldKTsKICAgICAgICAgICAgICBvLndyaXRlKGVsKTsKICAgICAgICAgICAgICBCLmZsYXNoLmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY2ZnLmlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVsID0gQi5mbGFzaC5lbDsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICB2YWwgPSB0aGlzLmVsLmdldCh0aGlzLm5hbWUsIGtleSk7CiAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHZhbCAhPT0gbnVsbCwgdmFsKTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIG9sZF92YWw7CiAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICBvbGRfdmFsID0gdGhpcy5lbC5zZXQodGhpcy5uYW1lLCBrZXksIHZhbCk7CiAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICB2YXIgdmFsOwogICAgICAgICAgICBrZXkgPSBlc2Moa2V5KTsKICAgICAgICAgICAgdmFsID0gdGhpcy5lbC5yZW1vdmUodGhpcy5uYW1lLCBrZXkpOwogICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHZhciBpbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpLCBsLCBiLCBrZXksIGZucyA9IEMubWV0aG9kcywKICAgICAgICBrZXlzID0gQy5zZWFyY2hfb3JkZXI7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBmbnMubGVuZ3RoOyBpIDwgbDsgaSsrKQogICAgICAgIFAuU3RvcmUucHJvdG90eXBlW2Zuc1tpXV0gPSBlbXB0eTsKICAgICAgUC50eXBlID0gbnVsbDsKICAgICAgUC5zaXplID0gLTE7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgIVAudHlwZSAmJiBpIDwgbDsgaSsrKSB7CiAgICAgICAgYiA9IEJba2V5c1tpXV07CiAgICAgICAgaWYgKGIudGVzdCgpKSB7CiAgICAgICAgICBQLnR5cGUgPSBrZXlzW2ldOwogICAgICAgICAgUC5zaXplID0gYi5zaXplOwogICAgICAgICAgZm9yIChrZXkgaW4gYi5tZXRob2RzKQogICAgICAgICAgICBQLlN0b3JlLnByb3RvdHlwZVtrZXldID0gYi5tZXRob2RzW2tleV07CiAgICAgICAgfQogICAgICB9CiAgICAgIFAuX2luaXQgPSB0cnVlOwogICAgfTsKICAgIFAgPSB7CiAgICAgIFZFUlNJT046IFZFUlNJT04sCiAgICAgIHR5cGU6IG51bGwsCiAgICAgIHNpemU6IDAsCiAgICAgIGFkZDogZnVuY3Rpb24obykgewogICAgICAgIEJbby5pZF0gPSBvOwogICAgICAgIEMuc2VhcmNoX29yZGVyID0gW28uaWRdLmNvbmNhdChDLnNlYXJjaF9vcmRlcik7CiAgICAgICAgaW5pdCgpOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgdmFyIG9mcyA9IGluZGV4X29mKEMuc2VhcmNoX29yZGVyLCBpZCk7CiAgICAgICAgaWYgKG9mcyA8IDApCiAgICAgICAgICByZXR1cm47CiAgICAgICAgQy5zZWFyY2hfb3JkZXIuc3BsaWNlKG9mcywgMSk7CiAgICAgICAgZGVsZXRlIEJbaWRdOwogICAgICAgIGluaXQoKTsKICAgICAgfSwKICAgICAgQ29va2llOiBlYywKICAgICAgU3RvcmU6IGZ1bmN0aW9uKG5hbWUsIG8pIHsKICAgICAgICBpZiAoIUMubmFtZV9yZS5leGVjKG5hbWUpKQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIG5hbWUiKTsKICAgICAgICBpZiAoIVAudHlwZSkKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gc3VpdGFibGUgc3RvcmFnZSBmb3VuZCIpOwogICAgICAgIG8gPSBvIHx8IHt9OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgby5kb21haW4gPSBvLmRvbWFpbiB8fCBsb2NhdGlvbi5ob3N0IHx8ICdsb2NhbGhvc3QnOwogICAgICAgIG8uZG9tYWluID0gby5kb21haW4ucmVwbGFjZSgvOlxkKyQvLCAnJykKICAgICAgICB0aGlzLm8gPSBvOwogICAgICAgIG8uZXhwaXJlcyA9IG8uZXhwaXJlcyB8fCAzNjUgKiAyOwogICAgICAgIG8ucGF0aCA9IG8ucGF0aCB8fCAnLyc7CiAgICAgICAgdGhpcy5pbml0KCk7CiAgICAgIH0KICAgIH07CiAgICBpbml0KCk7CiAgICByZXR1cm4gUDsKICB9KSgpOwogIC8vcGVyc2lzdC1taW4gZW5kCgogIC8vc3dmb2JqZWN0LW1pbiBzdGFydAoKICBpZiAodHlwZW9mIGRlY29uY2VwdCA9PSAidW5kZWZpbmVkIikgdmFyIGRlY29uY2VwdCA9IG5ldyBPYmplY3QoKTsKICBpZiAodHlwZW9mIGRlY29uY2VwdC51dGlsID09ICJ1bmRlZmluZWQiKSBkZWNvbmNlcHQudXRpbCA9IG5ldyBPYmplY3QoKTsKICBpZiAodHlwZW9mIGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsID09ICJ1bmRlZmluZWQiKSBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbCA9IG5ldyBPYmplY3QoKTsKICBkZWNvbmNlcHQuU1dGT2JqZWN0ID0gZnVuY3Rpb24oc3dmLCBpZCwgdywgaCwgdmVyLCBjLCBxdWFsaXR5LCB4aVJlZGlyZWN0VXJsLCByZWRpcmVjdFVybCwgZGV0ZWN0S2V5KSB7CiAgICBpZiAoIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuREVURUNUX0tFWSA9IGRldGVjdEtleSA/IGRldGVjdEtleSA6ICdkZXRlY3RmbGFzaCc7CiAgICB0aGlzLnNraXBEZXRlY3QgPSBkZWNvbmNlcHQudXRpbC5nZXRSZXF1ZXN0UGFyYW1ldGVyKHRoaXMuREVURUNUX0tFWSk7CiAgICB0aGlzLnBhcmFtcyA9IG5ldyBPYmplY3QoKTsKICAgIHRoaXMudmFyaWFibGVzID0gbmV3IE9iamVjdCgpOwogICAgdGhpcy5hdHRyaWJ1dGVzID0gbmV3IEFycmF5KCk7CiAgICBpZiAoc3dmKSB7CiAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdzd2YnLCBzd2YpOwogICAgfQogICAgaWYgKGlkKSB7CiAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdpZCcsIGlkKTsKICAgIH0KICAgIGlmICh3KSB7CiAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCd3aWR0aCcsIHcpOwogICAgfQogICAgaWYgKGgpIHsKICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ2hlaWdodCcsIGgpOwogICAgfQogICAgaWYgKHZlcikgewogICAgICB0aGlzLnNldEF0dHJpYnV0ZSgndmVyc2lvbicsIG5ldyBkZWNvbmNlcHQuUGxheWVyVmVyc2lvbih2ZXIudG9TdHJpbmcoKS5zcGxpdCgiLiIpKSk7CiAgICB9CiAgICB0aGlzLmluc3RhbGxlZFZlciA9IGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsLmdldFBsYXllclZlcnNpb24oKTsKICAgIGlmICghd2luZG93Lm9wZXJhICYmIGRvY3VtZW50LmFsbCAmJiB0aGlzLmluc3RhbGxlZFZlci5tYWpvciA+IDcpIHsKICAgICAgZGVjb25jZXB0LlNXRk9iamVjdC5kb1ByZXBVbmxvYWQgPSB0cnVlOwogICAgfQogICAgaWYgKGMpIHsKICAgICAgdGhpcy5hZGRQYXJhbSgnYmdjb2xvcicsIGMpOwogICAgfQogICAgdmFyIHEgPSBxdWFsaXR5ID8gcXVhbGl0eSA6ICdoaWdoJzsKICAgIHRoaXMuYWRkUGFyYW0oJ3F1YWxpdHknLCBxKTsKICAgIHRoaXMuc2V0QXR0cmlidXRlKCd1c2VFeHByZXNzSW5zdGFsbCcsIGZhbHNlKTsKICAgIHRoaXMuc2V0QXR0cmlidXRlKCdkb0V4cHJlc3NJbnN0YWxsJywgZmFsc2UpOwogICAgdmFyIHhpciA9ICh4aVJlZGlyZWN0VXJsKSA/IHhpUmVkaXJlY3RVcmwgOiB3aW5kb3cubG9jYXRpb247CiAgICB0aGlzLnNldEF0dHJpYnV0ZSgneGlSZWRpcmVjdFVybCcsIHhpcik7CiAgICB0aGlzLnNldEF0dHJpYnV0ZSgncmVkaXJlY3RVcmwnLCAnJyk7CiAgICBpZiAocmVkaXJlY3RVcmwpIHsKICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3JlZGlyZWN0VXJsJywgcmVkaXJlY3RVcmwpOwogICAgfQogIH0KICBkZWNvbmNlcHQuU1dGT2JqZWN0LnByb3RvdHlwZSA9IHsKICAgIHVzZUV4cHJlc3NJbnN0YWxsOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgIHRoaXMueGlTV0ZQYXRoID0gIXBhdGggPyAiZXhwcmVzc2luc3RhbGwuc3dmIiA6IHBhdGg7CiAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCd1c2VFeHByZXNzSW5zdGFsbCcsIHRydWUpOwogICAgfSwKICAgIHNldEF0dHJpYnV0ZTogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgdGhpcy5hdHRyaWJ1dGVzW25hbWVdID0gdmFsdWU7CiAgICB9LAogICAgZ2V0QXR0cmlidXRlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CiAgICB9LAogICAgYWRkUGFyYW06IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMucGFyYW1zW25hbWVdID0gdmFsdWU7CiAgICB9LAogICAgZ2V0UGFyYW1zOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucGFyYW1zOwogICAgfSwKICAgIGFkZFZhcmlhYmxlOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICB0aGlzLnZhcmlhYmxlc1tuYW1lXSA9IHZhbHVlOwogICAgfSwKICAgIGdldFZhcmlhYmxlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLnZhcmlhYmxlc1tuYW1lXTsKICAgIH0sCiAgICBnZXRWYXJpYWJsZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy52YXJpYWJsZXM7CiAgICB9LAogICAgZ2V0VmFyaWFibGVQYWlyczogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YXJpYWJsZVBhaXJzID0gbmV3IEFycmF5KCk7CiAgICAgIHZhciBrZXk7CiAgICAgIHZhciB2YXJpYWJsZXMgPSB0aGlzLmdldFZhcmlhYmxlcygpOwogICAgICBmb3IgKGtleSBpbiB2YXJpYWJsZXMpIHsKICAgICAgICB2YXJpYWJsZVBhaXJzLnB1c2goa2V5ICsgIj0iICsgdmFyaWFibGVzW2tleV0pOwogICAgICB9CiAgICAgIHJldHVybiB2YXJpYWJsZVBhaXJzOwogICAgfSwKICAgIGdldFNXRkhUTUw6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc3dmTm9kZSA9ICIiOwogICAgICBpZiAobmF2aWdhdG9yLnBsdWdpbnMgJiYgbmF2aWdhdG9yLm1pbWVUeXBlcyAmJiBuYXZpZ2F0b3IubWltZVR5cGVzLmxlbmd0aCkgewogICAgICAgIGlmICh0aGlzLmdldEF0dHJpYnV0ZSgiZG9FeHByZXNzSW5zdGFsbCIpKSB7CiAgICAgICAgICB0aGlzLmFkZFZhcmlhYmxlKCJNTXBsYXllclR5cGUiLCAiUGx1Z0luIik7CiAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnc3dmJywgdGhpcy54aVNXRlBhdGgpOwogICAgICAgIH0KICAgICAgICBzd2ZOb2RlID0gJzxlbWJlZCB0eXBlPSJhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCIgc3JjPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ3N3ZicpICsgJyIgd2lkdGg9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSArICciIGhlaWdodD0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCdoZWlnaHQnKSArICciJzsKICAgICAgICBzd2ZOb2RlICs9ICcgaWQ9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnaWQnKSArICciIG5hbWU9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnaWQnKSArICciICc7CiAgICAgICAgdmFyIHBhcmFtcyA9IHRoaXMuZ2V0UGFyYW1zKCk7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHBhcmFtcykgewogICAgICAgICAgc3dmTm9kZSArPSBba2V5XSArICc9IicgKyBwYXJhbXNba2V5XSArICciICc7CiAgICAgICAgfQogICAgICAgIHZhciBwYWlycyA9IHRoaXMuZ2V0VmFyaWFibGVQYWlycygpLmpvaW4oIiYiKTsKICAgICAgICBpZiAocGFpcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgc3dmTm9kZSArPSAnZmxhc2h2YXJzPSInICsgcGFpcnMgKyAnIic7CiAgICAgICAgfQogICAgICAgIHN3Zk5vZGUgKz0gJy8+JzsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5nZXRBdHRyaWJ1dGUoImRvRXhwcmVzc0luc3RhbGwiKSkgewogICAgICAgICAgdGhpcy5hZGRWYXJpYWJsZSgiTU1wbGF5ZXJUeXBlIiwgIkFjdGl2ZVgiKTsKICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdzd2YnLCB0aGlzLnhpU1dGUGF0aCk7CiAgICAgICAgfQogICAgICAgIHN3Zk5vZGUgPSAnPG9iamVjdCBpZD0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCdpZCcpICsgJyIgY2xhc3NpZD0iY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwIiB3aWR0aD0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCd3aWR0aCcpICsgJyIgaGVpZ2h0PSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ2hlaWdodCcpICsgJyI+JzsKICAgICAgICBzd2ZOb2RlICs9ICc8cGFyYW0gbmFtZT0ibW92aWUiIHZhbHVlPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ3N3ZicpICsgJyIgLz4nOwogICAgICAgIHZhciBwYXJhbXMgPSB0aGlzLmdldFBhcmFtcygpOwogICAgICAgIGZvciAodmFyIGtleSBpbiBwYXJhbXMpIHsKICAgICAgICAgIHN3Zk5vZGUgKz0gJzxwYXJhbSBuYW1lPSInICsga2V5ICsgJyIgdmFsdWU9IicgKyBwYXJhbXNba2V5XSArICciIC8+JzsKICAgICAgICB9CiAgICAgICAgdmFyIHBhaXJzID0gdGhpcy5nZXRWYXJpYWJsZVBhaXJzKCkuam9pbigiJiIpOwogICAgICAgIGlmIChwYWlycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBzd2ZOb2RlICs9ICc8cGFyYW0gbmFtZT0iZmxhc2h2YXJzIiB2YWx1ZT0iJyArIHBhaXJzICsgJyIgLz4nOwogICAgICAgIH0KICAgICAgICBzd2ZOb2RlICs9ICI8L29iamVjdD4iOwogICAgICB9CiAgICAgIHJldHVybiBzd2ZOb2RlOwogICAgfSwKICAgIHdyaXRlOiBmdW5jdGlvbihlbGVtZW50SWQpIHsKICAgICAgaWYgKHRoaXMuZ2V0QXR0cmlidXRlKCd1c2VFeHByZXNzSW5zdGFsbCcpKSB7CiAgICAgICAgdmFyIGV4cHJlc3NJbnN0YWxsUmVxVmVyID0gbmV3IGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uKFs2LCAwLCA2NV0pOwogICAgICAgIGlmICh0aGlzLmluc3RhbGxlZFZlci52ZXJzaW9uSXNWYWxpZChleHByZXNzSW5zdGFsbFJlcVZlcikgJiYgIXRoaXMuaW5zdGFsbGVkVmVyLnZlcnNpb25Jc1ZhbGlkKHRoaXMuZ2V0QXR0cmlidXRlKCd2ZXJzaW9uJykpKSB7CiAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnZG9FeHByZXNzSW5zdGFsbCcsIHRydWUpOwogICAgICAgICAgdGhpcy5hZGRWYXJpYWJsZSgiTU1yZWRpcmVjdFVSTCIsIGVzY2FwZSh0aGlzLmdldEF0dHJpYnV0ZSgneGlSZWRpcmVjdFVybCcpKSk7CiAgICAgICAgICBkb2N1bWVudC50aXRsZSA9IGRvY3VtZW50LnRpdGxlLnNsaWNlKDAsIDQ3KSArICIgLSBGbGFzaCBQbGF5ZXIgSW5zdGFsbGF0aW9uIjsKICAgICAgICAgIHRoaXMuYWRkVmFyaWFibGUoIk1NZG9jdGl0bGUiLCBkb2N1bWVudC50aXRsZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLnNraXBEZXRlY3QgfHwgdGhpcy5nZXRBdHRyaWJ1dGUoJ2RvRXhwcmVzc0luc3RhbGwnKSB8fCB0aGlzLmluc3RhbGxlZFZlci52ZXJzaW9uSXNWYWxpZCh0aGlzLmdldEF0dHJpYnV0ZSgndmVyc2lvbicpKSkgewogICAgICAgIHZhciBuID0gKHR5cGVvZiBlbGVtZW50SWQgPT0gJ3N0cmluZycpID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxlbWVudElkKSA6IGVsZW1lbnRJZDsKICAgICAgICBuLmlubmVySFRNTCA9IHRoaXMuZ2V0U1dGSFRNTCgpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0aGlzLmdldEF0dHJpYnV0ZSgncmVkaXJlY3RVcmwnKSAhPSAiIikgewogICAgICAgICAgZG9jdW1lbnQubG9jYXRpb24ucmVwbGFjZSh0aGlzLmdldEF0dHJpYnV0ZSgncmVkaXJlY3RVcmwnKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgZGVjb25jZXB0LlNXRk9iamVjdFV0aWwuZ2V0UGxheWVyVmVyc2lvbiA9IGZ1bmN0aW9uKCkgewogICAgdmFyIFBsYXllclZlcnNpb24gPSBuZXcgZGVjb25jZXB0LlBsYXllclZlcnNpb24oWzAsIDAsIDBdKTsKICAgIGlmIChuYXZpZ2F0b3IucGx1Z2lucyAmJiBuYXZpZ2F0b3IubWltZVR5cGVzLmxlbmd0aCkgewogICAgICB2YXIgeCA9IG5hdmlnYXRvci5wbHVnaW5zWyJTaG9ja3dhdmUgRmxhc2giXTsKICAgICAgaWYgKHggJiYgeC5kZXNjcmlwdGlvbikgewogICAgICAgIFBsYXllclZlcnNpb24gPSBuZXcgZGVjb25jZXB0LlBsYXllclZlcnNpb24oeC5kZXNjcmlwdGlvbi5yZXBsYWNlKC8oW2EtekEtWl18XHMpKy8sICIiKS5yZXBsYWNlKC8oXHMrcnxccytiWzAtOV0rKS8sICIuIikuc3BsaXQoIi4iKSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIGF4byA9IG5ldyBBY3RpdmVYT2JqZWN0KCJTaG9ja3dhdmVGbGFzaC5TaG9ja3dhdmVGbGFzaC43Iik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGF4byA9IG5ldyBBY3RpdmVYT2JqZWN0KCJTaG9ja3dhdmVGbGFzaC5TaG9ja3dhdmVGbGFzaC42Iik7CiAgICAgICAgICBQbGF5ZXJWZXJzaW9uID0gbmV3IGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uKFs2LCAwLCAyMV0pOwogICAgICAgICAgYXhvLkFsbG93U2NyaXB0QWNjZXNzID0gImFsd2F5cyI7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgaWYgKFBsYXllclZlcnNpb24ubWFqb3IgPT0gNikgewogICAgICAgICAgICByZXR1cm4gUGxheWVyVmVyc2lvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF4byA9IG5ldyBBY3RpdmVYT2JqZWN0KCJTaG9ja3dhdmVGbGFzaC5TaG9ja3dhdmVGbGFzaCIpOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgIH0KICAgICAgaWYgKGF4byAhPSBudWxsKSB7CiAgICAgICAgUGxheWVyVmVyc2lvbiA9IG5ldyBkZWNvbmNlcHQuUGxheWVyVmVyc2lvbihheG8uR2V0VmFyaWFibGUoIiR2ZXJzaW9uIikuc3BsaXQoIiAiKVsxXS5zcGxpdCgiLCIpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIFBsYXllclZlcnNpb247CiAgfQogIGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uID0gZnVuY3Rpb24oYXJyVmVyc2lvbikgewogICAgdGhpcy5tYWpvciA9IGFyclZlcnNpb25bMF0gIT0gbnVsbCA/IHBhcnNlSW50KGFyclZlcnNpb25bMF0pIDogMDsKICAgIHRoaXMubWlub3IgPSBhcnJWZXJzaW9uWzFdICE9IG51bGwgPyBwYXJzZUludChhcnJWZXJzaW9uWzFdKSA6IDA7CiAgICB0aGlzLnJldiA9IGFyclZlcnNpb25bMl0gIT0gbnVsbCA/IHBhcnNlSW50KGFyclZlcnNpb25bMl0pIDogMDsKICB9CiAgZGVjb25jZXB0LlBsYXllclZlcnNpb24ucHJvdG90eXBlLnZlcnNpb25Jc1ZhbGlkID0gZnVuY3Rpb24oZnYpIHsKICAgIGlmICh0aGlzLm1ham9yIDwgZnYubWFqb3IpIHJldHVybiBmYWxzZTsKICAgIGlmICh0aGlzLm1ham9yID4gZnYubWFqb3IpIHJldHVybiB0cnVlOwogICAgaWYgKHRoaXMubWlub3IgPCBmdi5taW5vcikgcmV0dXJuIGZhbHNlOwogICAgaWYgKHRoaXMubWlub3IgPiBmdi5taW5vcikgcmV0dXJuIHRydWU7CiAgICBpZiAodGhpcy5yZXYgPCBmdi5yZXYpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH0KICBkZWNvbmNlcHQudXRpbCA9IHsKICAgIGdldFJlcXVlc3RQYXJhbWV0ZXI6IGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgIHZhciBxID0gZG9jdW1lbnQubG9jYXRpb24uc2VhcmNoIHx8IGRvY3VtZW50LmxvY2F0aW9uLmhhc2g7CiAgICAgIGlmIChxKSB7CiAgICAgICAgdmFyIHBhaXJzID0gcS5zdWJzdHJpbmcoMSkuc3BsaXQoIiYiKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhaXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAocGFpcnNbaV0uc3Vic3RyaW5nKDAsIHBhaXJzW2ldLmluZGV4T2YoIj0iKSkgPT0gcGFyYW0pIHsKICAgICAgICAgICAgcmV0dXJuIHBhaXJzW2ldLnN1YnN0cmluZygocGFpcnNbaV0uaW5kZXhPZigiPSIpICsgMSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gIiI7CiAgICB9CiAgfQogIGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsLmNsZWFudXBTV0ZzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgb2JqZWN0cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJPQkpFQ1QiKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqZWN0cy5sZW5ndGg7IGkrKykgewogICAgICBvYmplY3RzW2ldLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIGZvciAodmFyIHggaW4gb2JqZWN0c1tpXSkgewogICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0c1tpXVt4XSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBvYmplY3RzW2ldW3hdID0gZnVuY3Rpb24oKSB7fTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgaWYgKGRlY29uY2VwdC5TV0ZPYmplY3QuZG9QcmVwVW5sb2FkKSB7CiAgICBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbC5wcmVwVW5sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgIF9fZmxhc2hfdW5sb2FkSGFuZGxlciA9IGZ1bmN0aW9uKCkge307CiAgICAgIF9fZmxhc2hfc2F2ZWRVbmxvYWRIYW5kbGVyID0gZnVuY3Rpb24oKSB7fTsKICAgICAgd2luZG93LmF0dGFjaEV2ZW50KCJvbnVubG9hZCIsIGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsLmNsZWFudXBTV0ZzKTsKICAgIH0KICAgIHdpbmRvdy5hdHRhY2hFdmVudCgib25iZWZvcmV1bmxvYWQiLCBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbC5wcmVwVW5sb2FkKTsKICB9CiAgaWYgKEFycmF5LnByb3RvdHlwZS5wdXNoID09IG51bGwpIHsKICAgIEFycmF5LnByb3RvdHlwZS5wdXNoID0gZnVuY3Rpb24oaXRlbSkgewogICAgICB0aGlzW3RoaXMubGVuZ3RoXSA9IGl0ZW07CiAgICAgIHJldHVybiB0aGlzLmxlbmd0aDsKICAgIH0KICB9CiAgdmFyIGdldFF1ZXJ5UGFyYW1WYWx1ZSA9IGRlY29uY2VwdC51dGlsLmdldFJlcXVlc3RQYXJhbWV0ZXI7CiAgdmFyIEZsYXNoT2JqZWN0ID0gZGVjb25jZXB0LlNXRk9iamVjdDsKICB2YXIgU1dGT2JqZWN0ID0gZGVjb25jZXB0LlNXRk9iamVjdDsKICAvL3N3Zm9iamVjdC1taW4gZW5kCgogIC8vISEhbGliIGVuZCEhIQoKICB2YXIgJGZoID0gcm9vdC4kZmggfHwge307CiAgaWYgKHR5cGVvZiBmaF9hcHBfcHJvcHMgPT09ICJvYmplY3QiKSB7CiAgICAkZmguYXBwX3Byb3BzID0gZmhfYXBwX3Byb3BzOwogIH0KCiAgJGZoLmxlZ2FjeSA9IHt9OwoKICB2YXIgZGVmYXVsdGFyZ3MgPSB7CiAgICBzdWNjZXNzOiBmdW5jdGlvbigpIHt9LAogICAgZmFpbHVyZTogZnVuY3Rpb24oKSB7fSwKICAgIHBhcmFtczoge30KICB9OwoKICB2YXIgaGFuZGxlYXJncyA9IGZ1bmN0aW9uKGluYXJncywgZGVmYXVsdHBhcmFtcywgYXBwbHl0bykgewogICAgdmFyIG91dGFyZ3MgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICB2YXIgb3JpZ2FyZ3MgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICB2YXIgbnVtYXJncyA9IGluYXJncy5sZW5ndGg7CgogICAgaWYgKDIgPCBudW1hcmdzKSB7CiAgICAgIG9yaWdhcmdzWzBdID0gaW5hcmdzW251bWFyZ3MgLSAzXTsKICAgICAgb3JpZ2FyZ3NbMV0gPSBpbmFyZ3NbbnVtYXJncyAtIDJdOwogICAgICBvcmlnYXJnc1syXSA9IGluYXJnc1tudW1hcmdzIC0gMV07CiAgICB9IGVsc2UgaWYgKDIgPT0gbnVtYXJncykgewogICAgICBvcmlnYXJnc1sxXSA9IGluYXJnc1swXTsKICAgICAgb3JpZ2FyZ3NbMl0gPSBpbmFyZ3NbMV07CiAgICB9IGVsc2UgaWYgKDEgPT0gbnVtYXJncykgewogICAgICBvcmlnYXJnc1syXSA9IGluYXJnc1swXTsKICAgIH0KCiAgICB2YXIgaSA9IDAsCiAgICAgIGogPSAwOwogICAgZm9yICg7IGkgPCAzOyBpKyspIHsKICAgICAgdmFyIGEgPSBvcmlnYXJnc1tpXTsKICAgICAgdmFyIHRhID0gdHlwZW9mIGE7CiAgICAgIC8vY29uc29sZS5sb2coJ2l0ZXIgaTonK2krJyBqOicraisnIHRhOicrdGEpOwogICAgICBpZiAoYSAmJiAwID09IGogJiYgKCdvYmplY3QnID09IHRhIHx8ICdib29sZWFuJyA9PSB0YSkpIHsKICAgICAgICAvL2NvbnNvbGUubG9nKCdvYmplY3QgaTonK2krJyBqOicraisnIHRhOicrdGEpOwogICAgICAgIG91dGFyZ3NbaisrXSA9IGE7CiAgICAgIH0gZWxzZSBpZiAoYSAmJiAnZnVuY3Rpb24nID09IHRhKSB7CiAgICAgICAgaiA9IDAgPT0gaiA/IDEgOiBqOwogICAgICAgIC8vY29uc29sZS5sb2coJ2Z1bmN0aW9uIGk6JytpKycgajonK2orJyB0YTonK3RhKTsKICAgICAgICBvdXRhcmdzW2orK10gPSBhOwogICAgICB9CiAgICB9CgogICAgaWYgKG51bGwgPT0gb3V0YXJnc1swXSkgewogICAgICBvdXRhcmdzWzBdID0gZGVmYXVsdHBhcmFtcyA/IGRlZmF1bHRwYXJhbXMgOiBkZWZhdWx0YXJncy5wYXJhbXM7CiAgICB9IGVsc2UgewogICAgICB2YXIgcGFyYW1zYXJnID0gb3V0YXJnc1swXTsKICAgICAgcGFyYW1zYXJnLl9kZWZhdWx0cyA9IFtdOwogICAgICBmb3IgKHZhciBuIGluIGRlZmF1bHRwYXJhbXMpIHsKICAgICAgICBpZiAoZGVmYXVsdHBhcmFtcy5oYXNPd25Qcm9wZXJ0eShuKSkgewogICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNhcmdbbl0gPT09ICJ1bmRlZmluZWQiKSB7IC8vd2UgZG9uJ3Qgd2FudCB0byB1c2UgIXBhcmFtc2FyZ1tuXSBoZXJlIGJlY2F1c2UgdGhlIHBhcmFtZXRlciBjb3VsZCBleGlzdHMgaW4gdGhlIGFyZ3VtZW50IGFuZCBpdCBjb3VsZCBiZSBmYWxzZQogICAgICAgICAgICBwYXJhbXNhcmdbbl0gPSBkZWZhdWx0cGFyYW1zW25dOwogICAgICAgICAgICBwYXJhbXNhcmcuX2RlZmF1bHRzLnB1c2gobik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgb3V0YXJnc1sxXSA9IG51bGwgPT0gb3V0YXJnc1sxXSA/IGRlZmF1bHRhcmdzLnN1Y2Nlc3MgOiBvdXRhcmdzWzFdOwogICAgb3V0YXJnc1syXSA9IG51bGwgPT0gb3V0YXJnc1syXSA/IGRlZmF1bHRhcmdzLmZhaWx1cmUgOiBvdXRhcmdzWzJdOwoKICAgIGFwcGx5dG8ob3V0YXJnc1swXSwgb3V0YXJnc1sxXSwgb3V0YXJnc1syXSk7CiAgfQoKICB2YXIgZXZlbnRTdXBwb3J0ZWQgPSBmdW5jdGlvbihldmVudCkgewogICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpJyk7CiAgICByZXR1cm4gZXZlbnQgaW4gZWxlbWVudCB8fCBlbGVtZW50LnNldEF0dHJpYnV0ZSAmJiBlbGVtZW50LnNldEF0dHJpYnV0ZShldmVudCwgInJldHVybjsiKSB8fCBmYWxzZTsKICB9CgogIHZhciBfX2lzX3JlYWR5ID0gZmFsc2U7CiAgdmFyIF9fcmVhZHlfbGlzdCA9IFtdOwogIHZhciBfX3JlYWR5X2JvdW5kID0gZmFsc2U7CiAgdmFyIGJveHByZWZpeCA9ICIvYm94L3Nydi8xLjEvIjsKCiAgX2dldEhvc3RQcmVmaXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiAkZmguYXBwX3Byb3BzLmhvc3QgKyBib3hwcmVmaXg7CiAgfQoKICB2YXIgX19yZWFkeSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKCFfX2lzX3JlYWR5KSB7CiAgICAgIF9faXNfcmVhZHkgPSB0cnVlOwogICAgICBpZiAoX19yZWFkeV9saXN0KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHdoaWxlIChfX3JlYWR5X2xpc3RbMF0pIHsKICAgICAgICAgICAgX19yZWFkeV9saXN0LnNoaWZ0KCkuYXBwbHkoZG9jdW1lbnQsIFtdKTsKICAgICAgICAgIH0KCiAgICAgICAgfSBmaW5hbGx5IHsKCiAgICAgICAgfQogICAgICAgIF9fcmVhZHlfbGlzdCA9IG51bGw7CiAgICAgIH0KICAgIH0KICB9OwoKICB2YXIgX19iaW5kX3JlYWR5ID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoX19yZWFkeV9ib3VuZCkgcmV0dXJuOwogICAgX19yZWFkeV9ib3VuZCA9IHRydWU7CgogICAgLy8gTW96aWxsYSwgT3BlcmEgYW5kIHdlYmtpdCBuaWdodGxpZXMgY3VycmVudGx5IHN1cHBvcnQgdGhpcyBldmVudAogICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGFyZ3VtZW50cy5jYWxsZWUsIGZhbHNlKTsKICAgICAgICBfX3JlYWR5KCk7CiAgICAgIH0sIGZhbHNlKTsKCiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgX19yZWFkeSwgZmFsc2UpOwoKICAgICAgLy8gSWYgSUUgZXZlbnQgbW9kZWwgaXMgdXNlZAogICAgfSBlbHNlIGlmIChkb2N1bWVudC5hdHRhY2hFdmVudCkgewogICAgICAvLyBlbnN1cmUgZmlyaW5nIGJlZm9yZSBvbmxvYWQsCiAgICAgIC8vIG1heWJlIGxhdGUgYnV0IHNhZmUgYWxzbyBmb3IgaWZyYW1lcwogICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICAgIGRvY3VtZW50LmRldGFjaEV2ZW50KCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBhcmd1bWVudHMuY2FsbGVlKTsKICAgICAgICAgIF9fcmVhZHkoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgd2luZG93LmF0dGFjaEV2ZW50KCJvbmxvYWQiLCBfX3JlYWR5KTsKCiAgICAgIC8vIElmIElFIGFuZCBub3QgYW4gaWZyYW1lCiAgICAgIC8vIGNvbnRpbnVhbGx5IGNoZWNrIHRvIHNlZSBpZiB0aGUgZG9jdW1lbnQgaXMgcmVhZHkKICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCAmJiB3aW5kb3cgPT0gd2luZG93LnRvcCkoZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKF9faXNfcmVhZHkpIHJldHVybjsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIC8vIElmIElFIGlzIHVzZWQsIHVzZSB0aGUgdHJpY2sgYnkgRGllZ28gUGVyaW5pCiAgICAgICAgICAvLyBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwogICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsKCJsZWZ0Iik7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIHNldFRpbWVvdXQoYXJndW1lbnRzLmNhbGxlZSwgMCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBhbmQgZXhlY3V0ZSBhbnkgd2FpdGluZyBmdW5jdGlvbnMKICAgICAgICBfX3JlYWR5KCk7CiAgICAgIH0pKCk7CiAgICB9CiAgfTsKCiAgX19iaW5kX3JlYWR5KCk7CgogIC8vIGRlc3RpbmF0aW9uIGZ1bmN0aW9ucwogIHZhciBfbWFwU2NyaXB0TG9hZGVkID0gKHR5cGVvZiBnb29nbGUgIT0gInVuZGVmaW5lZCIpICYmICh0eXBlb2YgZ29vZ2xlLm1hcHMgIT0gInVuZGVmaW5lZCIpICYmICh0eXBlb2YgZ29vZ2xlLm1hcHMuTWFwICE9ICJ1bmRlZmluZWQiKTsKICAvL0NvbnRhaW5zIHRoZSB0YXJnZXQgZWxlbWVudCBhbmQgc3VjY2VzcyBmdW5jdGlvbiBmb3IgJGZoLm1hcCBmdW5jdGlvbnMKICB2YXIgX21hcExvYWRTdWNjZXNzUGFyYW1ldGVycyA9IFtdOwogIC8vRmxhZyB0byBzaG93IGlmIGEgbWFwIHNjcmlwdCBpcyBsb2FkaW5nIG9yIG5vdC4KICB2YXIgX21hcFNjcmlwdExvYWRpbmcgPSBmYWxzZTsgCiAgdmFyIF9sb2FkTWFwU2NyaXB0ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICBzY3JpcHQudHlwZSA9ICJ0ZXh0L2phdmFzY3JpcHQiOwogICAgdmFyIHByb3RvY29sID0gZG9jdW1lbnQubG9jYXRpb24ucHJvdG9jb2w7CiAgICBwcm90b2NvbCA9IChwcm90b2NvbCA9PT0gImh0dHA6IiB8fCBwcm90b2NvbCA9PT0gImh0dHBzOiIpID8gcHJvdG9jb2wgOiAiaHR0cHM6IjsKICAgIHNjcmlwdC5zcmMgPSBwcm90b2NvbCArICIvL21hcHMuZ29vZ2xlLmNvbS9tYXBzL2FwaS9qcz9zZW5zb3I9dHJ1ZSZjYWxsYmFjaz0kZmguX21hcExvYWRlZCI7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgfTsKCiAgdmFyIGF1ZGlvX29iaiA9IG51bGw7CiAgdmFyIGF1ZGlvX2lzX3BsYXlpbmcgPSBmYWxzZTsKCiAgJGZoLl9fZGVzdF9fID0gewogICAgc2VuZDogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBmKCdzZW5kX25vc3VwcG9ydCcpOwogICAgfSwKICAgIG5vdGlmeTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBmKCdub3RpZnlfbm9zdXBwb3J0Jyk7CiAgICB9LAogICAgY29udGFjdHM6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgZignY29udGFjdHNfbm9zdXBwb3J0Jyk7CiAgICB9LAogICAgYWNjOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgIGYoJ2FjY19ub3N1cHBvcnQnKTsKICAgIH0sCiAgICBnZW86IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgZignZ2VvX25vc3VwcG9ydCcpOwogICAgfSwKICAgIGNhbTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBmKCdjYW1fbm9zdXBwb3J0Jyk7CiAgICB9LAogICAgZGV2aWNlOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgIGYoJ2RldmljZV9ub3N1cHBvcnQnKTsKICAgIH0sCiAgICBsaXN0ZW46IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgZignbGlzdGVuX25vc3VwcG9ydCcpOwogICAgfSwKICAgIGhhbmRsZXJzOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgIGYoJ2hhbmRsZXJzX25vX3N1cHBvcnQnKTsKICAgIH0sCiAgICBmaWxlOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgIGYoJ2ZpbGVfbm9zdXBwb3J0Jyk7CiAgICB9LAogICAgcHVzaDogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBmKCdwdXNoX25vc3VwcG9ydCcpOwogICAgfSwKICAgIGVudjogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBzKHsKICAgICAgICBoZWlnaHQ6IHdpbmRvdy5pbm5lckhlaWdodCwKICAgICAgICB3aWR0aDogd2luZG93LmlubmVyV2lkdGgKICAgICAgfSk7CiAgICB9CgogICAgLAogICAgZGF0YTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBpZiAoISRmaC5fcGVyc2lzdCkgewogICAgICAgICRmaC5fcGVyc2lzdCA9IG5ldyBQZXJzaXN0LlN0b3JlKCdGSCcgKyAkZmguYXBwX3Byb3BzLmFwcGlkLCB7CiAgICAgICAgICBzd2ZfcGF0aDogJy9zdGF0aWMvYy9zdGFydC9zd2YvcGVyc2lzdC5zd2YnCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmICghcC5rZXkpIHsKICAgICAgICBmKCdkYXRhX25va2V5Jyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgYWN0cyA9IHsKICAgICAgICBsb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICRmaC5fcGVyc2lzdC5nZXQocC5rZXksIGZ1bmN0aW9uKG9rLCB2YWwpIHsKICAgICAgICAgICAgb2sgPyBzKHsKICAgICAgICAgICAgICBrZXk6IHAua2V5LAogICAgICAgICAgICAgIHZhbDogdmFsCiAgICAgICAgICAgIH0pIDogcyh7CiAgICAgICAgICAgICAga2V5OiBwLmtleSwKICAgICAgICAgICAgICB2YWw6IG51bGwKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHNhdmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKCFwLnZhbCkgewogICAgICAgICAgICBmKCdkYXRhX25vdmFsJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICRmaC5fcGVyc2lzdC5zZXQocC5rZXksIHAudmFsKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgZignZGF0YV9lcnJvcicsIHt9LCBwKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcygpOwogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICRmaC5fcGVyc2lzdC5yZW1vdmUocC5rZXksIGZ1bmN0aW9uKG9rLCB2YWwpIHsKICAgICAgICAgICAgb2sgPyBzKHsKICAgICAgICAgICAgICBrZXk6IHAua2V5LAogICAgICAgICAgICAgIHZhbDogdmFsCiAgICAgICAgICAgIH0pIDogcyh7CiAgICAgICAgICAgICAga2V5OiBwLmtleSwKICAgICAgICAgICAgICB2YWw6IG51bGwKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBhY3RzW3AuYWN0XSA/IGFjdHNbcC5hY3RdKCkgOiBmKCdkYXRhX2JhZGFjdCcsIHApOwogICAgfQoKICAgICwKICAgIGxvZzogZnVuY3Rpb24ocCwgcywgZikgewogICAgICB0eXBlb2YgY29uc29sZSA9PT0gInVuZGVmaW5lZCIgPyBmKCdsb2dfbm9zdXBwb3J0JykgOiBjb25zb2xlLmxvZyhwLm1lc3NhZ2UpOwogICAgfQoKICAgICwKICAgIG9yaTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBpZiAodHlwZW9mIHAuYWN0ID09ICJ1bmRlZmluZWQiIHx8IHAuYWN0ID09ICJsaXN0ZW4iKSB7CiAgICAgICAgaWYgKGV2ZW50U3VwcG9ydGVkKCdvbm9yaWVudGF0aW9uY2hhbmdlJykpIHsKICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvcmllbnRhdGlvbmNoYW5nZScsIHMsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZignb3JpX25vc3VwcG9ydCcsIHt9LCBwKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAocC5hY3QgPT0gInNldCIpIHsKICAgICAgICBpZiAoIXAudmFsdWUpIHsKICAgICAgICAgIGYoJ29yaV9ub192YWx1ZScsIHt9LCBwKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHAudmFsdWUgPT0gInBvcnRyYWl0IikgewogICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXS5zdHlsZVsnLW1vei10cmFuc2Zvcm0nXSA9ICIiOwogICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXS5zdHlsZVsnLXdlYmtpdC10cmFuc2Zvcm0nXSA9ICIiOwogICAgICAgICAgcyh7CiAgICAgICAgICAgIG9yaWVudGF0aW9uOiAncG9ydHJhaXQnCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXS5zdHlsZVsnLW1vei10cmFuc2Zvcm0nXSA9ICdyb3RhdGUoOTBkZWcpJzsKICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0uc3R5bGVbJy13ZWJraXQtdHJhbnNmb3JtJ10gPSAncm90YXRlKDkwZGVnKSc7CiAgICAgICAgICBzKHsKICAgICAgICAgICAgb3JpZW50YXRpb246ICdsYW5kc2NhcGUnCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZignb3JpX2JhZGFjdCcsIHt9LCBwKTsKICAgICAgfQogICAgfSwKICAgIG1hcDogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBpZiAoIXAudGFyZ2V0KSB7CiAgICAgICAgZignbWFwX25vdGFyZ2V0Jywge30sIHApOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoIXAubGF0KSB7CiAgICAgICAgZignbWFwX25vbGF0aXR1ZGUnLCB7fSwgcCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghcC5sb24pIHsKICAgICAgICBmKCdtYXBfbm9sb2dpdHVkZScsIHt9LCBwKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHRhcmdldCA9IHAudGFyZ2V0OwogICAgICBpZiAodHlwZW9mIHRhcmdldCA9PT0gInN0cmluZyIpIHsKICAgICAgICB2YXIgdGFyZ2V0X2RvbSA9IG51bGw7CiAgICAgICAgaWYgKHR5cGVvZiBqUXVlcnkgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBqcV9vYmogPSBqUXVlcnkodGFyZ2V0KTsKICAgICAgICAgICAgaWYgKGpxX29iai5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdGFyZ2V0X2RvbSA9IGpxX29ialswXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0YXJnZXRfZG9tID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG51bGwgPT0gdGFyZ2V0X2RvbSkgewogICAgICAgICAgdGFyZ2V0X2RvbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRhcmdldCk7CiAgICAgICAgfQogICAgICAgIHRhcmdldCA9IHRhcmdldF9kb207CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRhcmdldCA9PT0gIm9iamVjdCIpIHsKICAgICAgICBpZiAodGFyZ2V0Lm5vZGVUeXBlID09PSAxICYmIHR5cGVvZiB0YXJnZXQubm9kZU5hbWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAvLyBBIERPTSBFbGVtZW50LCBkbyBub3RoaW5nCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vQSBqUXVlcnkgbm9kZQogICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0WzBdOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0YXJnZXQgPSBudWxsOwogICAgICB9CgogICAgICBpZiAoIXRhcmdldCkgewogICAgICAgIGYoJ21hcF9ub2NvbnRhaW5lcicsIHt9LCBwKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCgoKCiAgICAgIGlmICghX21hcFNjcmlwdExvYWRlZCkgewoKICAgICAgICAvL1F1ZXVlIHRoZSBzdWNjZXNzIGZ1bmN0aW9uCiAgICAgICAgaWYodHlwZW9mKHMpID09PSAnZnVuY3Rpb24nKXsKICAgICAgICAgICAgX21hcExvYWRTdWNjZXNzUGFyYW1ldGVycy5wdXNoKHt0YXJnZXQ6IHRhcmdldCwgc3VjY2Vzc0Z1bmN0aW9uOiBzLCBtT3B0aW9uczogcH0pOyAgICAKICAgICAgICB9CiAgICAgICAgCgogICAgICAgICRmaC5fbWFwTG9hZGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBfbWFwU2NyaXB0TG9hZGVkID0gdHJ1ZTsKICAgICAgICAgIHZhciBtYXBMb2FkU3VjY2Vzc1BhcmFtZXRlciA9IF9tYXBMb2FkU3VjY2Vzc1BhcmFtZXRlcnMuc2hpZnQoKTsKCiAgICAgICAgICB3aGlsZSh0eXBlb2YobWFwTG9hZFN1Y2Nlc3NQYXJhbWV0ZXIpICE9PSAndW5kZWZpbmVkJyl7CiAgICAgICAgICAgIHZhciBtT3B0aW9ucyA9IG1hcExvYWRTdWNjZXNzUGFyYW1ldGVyLm1PcHRpb25zOwogICAgICAgICAgICB2YXIgbWFwT3B0aW9ucyA9IHt9OwogICAgICAgICAgICBtYXBPcHRpb25zLnpvb20gPSBtT3B0aW9ucy56b29tID8gbU9wdGlvbnMuem9vbSA6IDg7CiAgICAgICAgICAgIG1hcE9wdGlvbnMuY2VudGVyID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhtT3B0aW9ucy5sYXQsIG1PcHRpb25zLmxvbik7CiAgICAgICAgICAgIG1hcE9wdGlvbnMubWFwVHlwZUlkID0gZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlJPQURNQVA7CgogICAgICAgICAgICB2YXIgbWFwID0gbmV3IGdvb2dsZS5tYXBzLk1hcChtYXBMb2FkU3VjY2Vzc1BhcmFtZXRlci50YXJnZXQsIG1hcE9wdGlvbnMpOwogICAgICAgICAgICBtYXBMb2FkU3VjY2Vzc1BhcmFtZXRlci5zdWNjZXNzRnVuY3Rpb24oe21hcDogbWFwfSk7ICAKICAgICAgICAgICAgbWFwTG9hZFN1Y2Nlc3NQYXJhbWV0ZXIgPSBfbWFwTG9hZFN1Y2Nlc3NQYXJhbWV0ZXJzLnNoaWZ0KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgaWYoIV9tYXBTY3JpcHRMb2FkaW5nKXsKICAgICAgICAgICAgX21hcFNjcmlwdExvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICBfbG9hZE1hcFNjcmlwdCgpOyAgICAKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy9hZnRlciAyMCBzZWNzLCBpZiB0aGUgbWFwIHNjcmlwdCBpcyBzdGlsbCBub3QgbG9hZGVkLCBydW4gdGhlIGZhaWwgZnVuY3Rpb24KICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKCFfbWFwU2NyaXB0TG9hZGVkKSB7CiAgICAgICAgICAgIGYoJ21hcF90aW1lb3V0Jywge30sIHApOwogICAgICAgICAgfQogICAgICAgIH0sIDIwMDAwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgbWFwT3B0aW9ucyA9IHt9OwogICAgICAgIG1hcE9wdGlvbnMuem9vbSA9IHAuem9vbSA/IHAuem9vbSA6IDg7CiAgICAgICAgbWFwT3B0aW9ucy5jZW50ZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKHAubGF0LCBwLmxvbik7CiAgICAgICAgbWFwT3B0aW9ucy5tYXBUeXBlSWQgPSBnb29nbGUubWFwcy5NYXBUeXBlSWQuUk9BRE1BUDsKICAgICAgICB2YXIgbWFwID0gbmV3IGdvb2dsZS5tYXBzLk1hcCh0YXJnZXQsIG1hcE9wdGlvbnMpOwogICAgICAgIHMoewogICAgICAgICAgbWFwOiBtYXAKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgICwKICAgIGF1ZGlvOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgIGlmICghYXVkaW9fb2JqID09IG51bGwgJiYgcC5hY3QgPT0gInBsYXkiICYmICghcC5wYXRoIHx8IHAucGF0aCA9PSAiIikpIHsKICAgICAgICBmKCdub19hdWRpb19wYXRoJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBhY3RzID0gewogICAgICAgICdwbGF5JzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAobnVsbCA9PSBhdWRpb19vYmopIHsKICAgICAgICAgICAgYXVkaW9fb2JqID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYXVkaW8iKTsKICAgICAgICAgICAgaWYgKCEoKGF1ZGlvX29iai5wbGF5KSA/IHRydWUgOiBmYWxzZSkpIHsKICAgICAgICAgICAgICBmKCdhdWRpb19ub3Rfc3VwcG9ydCcpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocC50eXBlKSB7CiAgICAgICAgICAgICAgdmFyIGNhbnBsYXkgPSBhdWRpb19vYmouY2FuUGxheVR5cGUocC50eXBlKTsKICAgICAgICAgICAgICBpZiAoY2FucGxheSA9PSAibm8iIHx8IGNhbnBsYXkgPT0gIiIpIHsKICAgICAgICAgICAgICAgIGYoImF1ZGlvX3R5cGVfbm90X3N1cHBvcnRlZCIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBhdWRpb19vYmouc3JjID0gcC5wYXRoOwogICAgICAgICAgICBpZiAocC5jb250cm9scykgewogICAgICAgICAgICAgIGF1ZGlvX29iai5jb250cm9scyA9ICJjb250cm9scyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHAuYXV0b3BsYXkpIHsKICAgICAgICAgICAgICBhdWRpb19vYmouYXV0b3BsYXkgPSAiYXV0b3BsYXkiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwLmxvb3ApIHsKICAgICAgICAgICAgICBhdWRpb19vYmoubG9vcCA9ICJsb29wIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGF1ZGlvX29iaik7CiAgICAgICAgICAgIGF1ZGlvX29iai5wbGF5KCk7CiAgICAgICAgICAgIGF1ZGlvX2lzX3BsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICBzKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvL3BsYXlpbmcgYSBuZXcgYXVkaW8KICAgICAgICAgICAgaWYgKHAucGF0aCAmJiAocC5wYXRoICE9IGF1ZGlvX29iai5zcmMpKSB7CiAgICAgICAgICAgICAgaWYgKGF1ZGlvX2lzX3BsYXlpbmcpIHsKICAgICAgICAgICAgICAgIGFjdHNbJ3N0b3AnXSh0cnVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYWN0c1sncGxheSddKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy9yZXN1bWUgdGhlIGV4aXN0aW5nIGF1ZGlvCiAgICAgICAgICAgICAgaWYgKCFhdWRpb19pc19wbGF5aW5nKSB7CiAgICAgICAgICAgICAgICBhdWRpb19vYmoucGxheSgpOwogICAgICAgICAgICAgICAgYXVkaW9faXNfcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgICAgICBzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgJ3BhdXNlJzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAobnVsbCAhPSBhdWRpb19vYmogJiYgYXVkaW9faXNfcGxheWluZykgewogICAgICAgICAgICBpZiAodHlwZW9mIGF1ZGlvX29iai5wYXVzZSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgYXVkaW9fb2JqLnBhdXNlKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGF1ZGlvX29iai5zdG9wID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBhdWRpb19vYmouc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGF1ZGlvX2lzX3BsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcygpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZignbm9fYXVkaW9fcGxheWluZycpOwogICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgICdzdG9wJzogZnVuY3Rpb24obm9jYWxsYmFjaykgewogICAgICAgICAgaWYgKG51bGwgIT0gYXVkaW9fb2JqKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXVkaW9fb2JqLnN0b3AgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGF1ZGlvX29iai5zdG9wKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGF1ZGlvX29iai5wYXVzZSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgYXVkaW9fb2JqLnBhdXNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChhdWRpb19vYmopOwogICAgICAgICAgICBhdWRpb19vYmogPSBudWxsOwogICAgICAgICAgICBhdWRpb19pc19wbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGlmICghbm9jYWxsYmFjaykgewogICAgICAgICAgICAgIHMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZignbm9fYXVkaW8nKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGFjdHNbcC5hY3RdID8gYWN0c1twLmFjdF0oKSA6IGYoJ2RhdGFfYmFkYWN0JywgcCk7CiAgICB9CgogICAgLAogICAgd2VidmlldzogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBmKCd3ZWJ2aWV3X25vc3VwcG9ydCcpOwogICAgfSwKCiAgICByZWFkeTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBfX2JpbmRfcmVhZHkoKTsKICAgICAgaWYgKF9faXNfcmVhZHkpIHsKICAgICAgICBzLmFwcGx5KGRvY3VtZW50LCBbXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX19yZWFkeV9saXN0LnB1c2gocyk7CiAgICAgIH0KICAgIH0KICB9CgogICRmaC5zZW5kID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICB0eXBlOiAnZW1haWwnCiAgICB9LCAkZmguX19kZXN0X18uc2VuZCk7CiAgfQoKICAkZmgubm90aWZ5ID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICB0eXBlOiAndmlicmF0ZScKICAgIH0sICRmaC5fX2Rlc3RfXy5ub3RpZnkpOwogIH0KCiAgJGZoLmNvbnRhY3RzID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICBhY3Q6ICdsaXN0JwogICAgfSwgJGZoLl9fZGVzdF9fLmNvbnRhY3RzKTsKICB9CgogICRmaC5hY2MgPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgIGFjdDogJ3JlZ2lzdGVyJywKICAgICAgaW50ZXJ2YWw6IDAKICAgIH0sICRmaC5fX2Rlc3RfXy5hY2MpOwogIH0KCiAgJGZoLmdlbyA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgYWN0OiAncmVnaXN0ZXInLAogICAgICBpbnRlcnZhbDogMAogICAgfSwgJGZoLl9fZGVzdF9fLmdlbyk7CiAgfQoKICAkZmguY2FtID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICBhY3Q6ICdwaWN0dXJlJwogICAgfSwgJGZoLl9fZGVzdF9fLmNhbSk7CiAgfQoKICAkZmguZGF0YSA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgYWN0OiAnbG9hZCcKICAgIH0sICRmaC5fX2Rlc3RfXy5kYXRhKTsKICB9CgogICRmaC5sb2cgPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgIG1lc3NhZ2U6ICdub25lJwogICAgfSwgJGZoLl9fZGVzdF9fLmxvZyk7CiAgfQoKICAkZmguZGV2aWNlID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sICRmaC5fX2Rlc3RfXy5kZXZpY2UpOwogIH0KCiAgJGZoLmxpc3RlbiA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgYWN0OiAnYWRkJwogICAgfSwgJGZoLl9fZGVzdF9fLmxpc3Rlbik7CiAgfQoKICAkZmgub3JpID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sICRmaC5fX2Rlc3RfXy5vcmkpOwogIH0KCiAgJGZoLm1hcCA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18ubWFwKTsKICB9CgogICRmaC5hdWRpbyA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18uYXVkaW8pOwogIH0KCiAgJGZoLndlYnZpZXcgPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgJGZoLl9fZGVzdF9fLndlYnZpZXcpOwogIH0KCiAgJGZoLnJlYWR5ID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sICRmaC5fX2Rlc3RfXy5yZWFkeSk7CiAgfTsKCiAgJGZoLmhhbmRsZXJzID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICB0eXBlOiAnYmFjaycKICAgIH0sICRmaC5fX2Rlc3RfXy5oYW5kbGVycyk7CiAgfTsKCiAgJGZoLmZpbGUgPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgIGFjdDogJ3VwbG9hZCcKICAgIH0sICRmaC5fX2Rlc3RfXy5maWxlKTsKICB9OwoKICAkZmgucHVzaCA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18ucHVzaCk7CiAgfTsKCiAgLy8gbmV3IGZ1bmN0aW9ucwogICRmaC5lbnYgPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgZnVuY3Rpb24ocCwgcywgZikgewogICAgICAvLyBmbGF0IHByb3BlcnR5IHNldCAtIG5vIHN1YiBvYmplY3RzIQogICAgICAkZmguX19kZXN0X18uZW52KHt9LCBmdW5jdGlvbihkZXN0RW52KSB7CiAgICAgICAgZGVzdEVudi5hcHBsaWNhdGlvbiA9ICRmaC5hcHBfcHJvcHMuYXBwaWQ7CiAgICAgICAgaWYgKCRmaC5fZ2V0RGV2aWNlSWQpIHsKICAgICAgICAgIGRlc3RFbnYudXVpZCA9ICRmaC5fZ2V0RGV2aWNlSWQoKTsKICAgICAgICB9CiAgICAgICAgZGVzdEVudi5hZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQgfHwgJ3Vua25vd24nOwogICAgICAgIHMoZGVzdEVudik7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAkZmguZGV2aWNlID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sIGZ1bmN0aW9uKHAsIHMsIGYpIHsKCiAgICB9KTsKICB9CgoKICAvLyBkZWZhdWx0czogCiAgLy8gICAge2FjdDonZ2V0J30gLT4ge2dlb2lwOnsuLi59fQogIC8vICBmYWlsdXJlczogZ2VvaXBfYmFkYWN0CiAgLy8KICAkZmguZ2VvaXAgPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgIGFjdDogJ2dldCcKICAgIH0sIGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgaWYgKCdnZXQnID09IHAuYWN0KSB7CiAgICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgICBpbnN0YW5jZTogJGZoLmFwcF9wcm9wcy5hcHBpZCwKICAgICAgICAgIGRvbWFpbjogJGZoLmNsb3VkX3Byb3BzLmRvbWFpbgogICAgICAgIH0KICAgICAgICAkZmguX19hamF4KHsKICAgICAgICAgICJ1cmwiOiBfZ2V0SG9zdFByZWZpeCgpICsgImFjdC93aWQvZ2VvaXAvcmVzb2x2ZSIsCiAgICAgICAgICAidHlwZSI6ICJQT1NUIiwKICAgICAgICAgICJkYXRhIjogSlNPTi5zdHJpbmdpZnkoZGF0YSksCiAgICAgICAgICAic3VjY2VzcyI6IGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICAvLyBiYWNrd2FyZHMgY29tcGF0CiAgICAgICAgICAgIGZvciAodmFyIG4gaW4gcmVzLmdlb2lwKSB7CiAgICAgICAgICAgICAgcmVzW25dID0gcmVzWydnZW9pcCddW25dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHMocmVzKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmKCdnZW9pcF9iYWRhY3QnLCBwKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgJGZoLndlYiA9IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgIG1ldGhvZDogJ0dFVCcKICAgIH0sIGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgaWYgKCFwLnVybCkgewogICAgICAgIGYoJ2JhZF91cmwnKTsKICAgICAgfQoKICAgICAgaWYgKHAuaXNfbG9jYWwpIHsKICAgICAgICAkZmguX19hamF4KHsKICAgICAgICAgIHVybDogcC51cmwsCiAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgIGRhdGFUeXBlOiAiaHRtbCIsCiAgICAgICAgICAvL3hocjogJGZoLnhociwKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgdmFyIHJlcyA9IHt9OwogICAgICAgICAgICByZXMuc3RhdHVzID0gMjAwOwogICAgICAgICAgICByZXMuYm9keSA9IGRhdGE7CiAgICAgICAgICAgIHMocmVzKTsKICAgICAgICAgIH0sCiAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGYoKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9IGVsc2UgewogICAgICAgICRmaC5fX2FqYXgoewogICAgICAgICAgInVybCI6IF9nZXRIb3N0UHJlZml4KCkgKyAiYWN0L3dpZC93ZWIiLAogICAgICAgICAgInR5cGUiOiAiUE9TVCIsCiAgICAgICAgICAiZGF0YSI6IEpTT04uc3RyaW5naWZ5KHApLAogICAgICAgICAgInN1Y2Nlc3MiOiBmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgcyhyZXMpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9OwoKICAkZmguX193ZWJ2aWV3X3dpbiA9IHVuZGVmaW5lZDsKICAkZmguX19kZXN0X18ud2VidmlldyA9IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgIGlmICghKCdhY3QnIGluIHApIHx8IHAuYWN0ID09PSAnb3BlbicpIHsKICAgICAgaWYgKCFwLnVybCkgewogICAgICAgIGYoJ25vX3VybCcpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgb2xkX3VybCA9IHAudXJsOwogICAgICAkZmguX193ZWJ2aWV3X3dpbiA9IHdpbmRvdy5vcGVuKHAudXJsLCAnX2JsYW5rJyk7CiAgICAgIHMoIm9wZW5lZCIpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHAuYWN0ID09PSAnY2xvc2UnKSB7CiAgICAgICAgaWYgKHR5cGVvZiAkZmguX193ZWJ2aWV3X3dpbiAhPSAndW5kZWZpbmVkJykgewogICAgICAgICAgJGZoLl9fd2Vidmlld193aW4uY2xvc2UoKTsKICAgICAgICAgICRmaC5fX3dlYnZpZXdfd2luID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICBzKCJjbG9zZWQiKTsKICAgICAgfQogICAgfQogIH07CgogIGlmICh0eXBlb2Yod2luZG93LlBob25lR2FwKSAhPT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKHdpbmRvdy5jb3Jkb3ZhKSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICRmaC5fcmVhZHlDYWxsYmFja3MgPSBbXTsKICAgICRmaC5fcmVhZHlTdGF0ZSA9IGZhbHNlOwogICAgJGZoLl9fZGVzdF9fLnJlYWR5ID0gZnVuY3Rpb24ocCwgcywgZikgewogICAgICBpZiAoJGZoLl9yZWFkeVN0YXRlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHMoKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygiRXJyb3IgZHVyaW5nICRmaC5yZWFkeS4gU2tpcC4gRXJyb3IgPSAiICsgZS5tZXNzYWdlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgJGZoLl9yZWFkeUNhbGxiYWNrcy5wdXNoKHMpOwogICAgICB9CiAgICB9OwogIH0KCiAgJGZoLl9fZGVzdF9fLmdlbyA9IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgIGlmICh0eXBlb2YgbmF2aWdhdG9yLmdlb2xvY2F0aW9uICE9ICd1bmRlZmluZWQnKSB7CiAgICAgIGlmICghcC5hY3QgfHwgcC5hY3QgPT0gInJlZ2lzdGVyIikgewogICAgICAgIGlmICgkZmguX19kZXN0X18uX2dlb1dhdGNoZXIpIHsKICAgICAgICAgIGYoJ2dlb19pbnVzZScsIHt9LCBwKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHAuaW50ZXJ2YWwgPT0gMCkgewogICAgICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihmdW5jdGlvbihwb3NpdGlvbikgewogICAgICAgICAgICB2YXIgY29vcmRzID0gcG9zaXRpb24uY29vcmRzOwogICAgICAgICAgICB2YXIgcmVzZGF0YSA9IHsKICAgICAgICAgICAgICBsb246IGNvb3Jkcy5sb25naXR1ZGUsCiAgICAgICAgICAgICAgbGF0OiBjb29yZHMubGF0aXR1ZGUsCiAgICAgICAgICAgICAgYWx0OiBjb29yZHMuYWx0aXR1ZGUsCiAgICAgICAgICAgICAgYWNjOiBjb29yZHMuYWNjdXJhY3ksCiAgICAgICAgICAgICAgaGVhZDogY29vcmRzLmhlYWRpbmcsCiAgICAgICAgICAgICAgc3BlZWQ6IGNvb3Jkcy5zcGVlZCwKICAgICAgICAgICAgICB3aGVuOiBwb3NpdGlvbi50aW1lc3RhbXAKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcyhyZXNkYXRhKTsKICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmKCdlcnJvcl9nZW8nLCB7fSwgcCk7CiAgICAgICAgICB9KQogICAgICAgIH07CiAgICAgICAgaWYgKHAuaW50ZXJ2YWwgPiAwKSB7CiAgICAgICAgICB2YXIgaW50ZXJuYWxXYXRjaGVyID0gbmF2aWdhdG9yLmdlb2xvY2F0aW9uLndhdGNoUG9zaXRpb24oZnVuY3Rpb24ocG9zaXRpb24pIHsKICAgICAgICAgICAgdmFyIGNvb3JkcyA9IHBvc2l0aW9uLmNvb3JkczsKICAgICAgICAgICAgdmFyIHJlc2RhdGEgPSB7CiAgICAgICAgICAgICAgbG9uOiBjb29yZHMubG9uZ2l0dWRlLAogICAgICAgICAgICAgIGxhdDogY29vcmRzLmxhdGl0dWRlLAogICAgICAgICAgICAgIGFsdDogY29vcmRzLmFsdGl0dWRlLAogICAgICAgICAgICAgIGFjYzogY29vcmRzLmFjY3VyYWN5LAogICAgICAgICAgICAgIGhlYWQ6IGNvb3Jkcy5oZWFkaW5nLAogICAgICAgICAgICAgIHNwZWVkOiBjb29yZHMuc3BlZWQsCiAgICAgICAgICAgICAgd2hlbjogcG9zaXRpb24udGltZXN0YW1wCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHMocmVzZGF0YSk7CiAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZignZXJyb3JfZ2VvJywge30sIHApOwogICAgICAgICAgfSwgewogICAgICAgICAgICBmcmVxdWVuY3k6IHAuaW50ZXJ2YWwKICAgICAgICAgIH0pOwogICAgICAgICAgJGZoLl9fZGVzdF9fLl9nZW9XYXRjaGVyID0gaW50ZXJuYWxXYXRjaGVyOwogICAgICAgIH07CiAgICAgIH0gZWxzZSBpZiAocC5hY3QgPT0gInVucmVnaXN0ZXIiKSB7CiAgICAgICAgaWYgKCRmaC5fX2Rlc3RfXy5fZ2VvV2F0Y2hlcikgewogICAgICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmNsZWFyV2F0Y2goJGZoLl9fZGVzdF9fLl9nZW9XYXRjaGVyKTsKICAgICAgICAgICRmaC5fX2Rlc3RfXy5fZ2VvV2F0Y2hlciA9IHVuZGVmaW5lZDsKICAgICAgICB9OwogICAgICAgIHMoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmKCdnZW9fYmFkYWN0Jywge30sIHApOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmKCdnZW9fbm9zdXBwb3J0Jywge30sIHApOwogICAgfQogIH07CgogICRmaC5fX2Rlc3RfXy5hY2MgPSBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICBzKHsKICAgICAgeDogKE1hdGgucmFuZG9tKCkgKiA0KSAtIDIsCiAgICAgIHk6IChNYXRoLnJhbmRvbSgpICogNCkgLSAyLAogICAgICB6OiAoTWF0aC5yYW5kb20oKSAqIDQpIC0gMiwKICAgICAgd2hlbjogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgIH0pOwogIH0KCiAgcm9vdC4kZmggPSAkZmg7Cgp9KSh0aGlzKTs=",
                "body": "OwooZnVuY3Rpb24ocm9vdCkgewoKICAvLyEhIWxpYiBzdGFydCEhIQogIC8qCiAgICBqc29uMi5qcwogICAgMjAwOC0wMy0yNAoKICAgIFB1YmxpYyBEb21haW4uCgogICAgTk8gV0FSUkFOVFkgRVhQUkVTU0VEIE9SIElNUExJRUQuIFVTRSBBVCBZT1VSIE9XTiBSSVNLLgoKICAgIFNlZSBodHRwOi8vd3d3LkpTT04ub3JnL2pzLmh0bWwKCiAgICBUaGlzIGZpbGUgY3JlYXRlcyBhIGdsb2JhbCBKU09OIG9iamVjdCBjb250YWluaW5nIHRocmVlIG1ldGhvZHM6IHN0cmluZ2lmeSwKICAgIHBhcnNlLCBhbmQgcXVvdGUuCgoKICAgICAgICBKU09OLnN0cmluZ2lmeSh2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKQogICAgICAgICAgICB2YWx1ZSAgICAgICBhbnkgSmF2YVNjcmlwdCB2YWx1ZSwgdXN1YWxseSBhbiBvYmplY3Qgb3IgYXJyYXkuCgogICAgICAgICAgICByZXBsYWNlciAgICBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgdGhhdCBkZXRlcm1pbmVzIGhvdyBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzIGFyZSBzdHJpbmdpZmllZCBmb3Igb2JqZWN0cyB3aXRob3V0IGEgdG9KU09OCiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZC4gSXQgY2FuIGJlIGEgZnVuY3Rpb24gb3IgYW4gYXJyYXkuCgogICAgICAgICAgICBzcGFjZSAgICAgICBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgdGhhdCBzcGVjaWZpZXMgdGhlIGluZGVudGF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIG9mIG5lc3RlZCBzdHJ1Y3R1cmVzLiBJZiBpdCBpcyBvbWl0dGVkLCB0aGUgdGV4dCB3aWxsCiAgICAgICAgICAgICAgICAgICAgICAgIGJlIHBhY2tlZCB3aXRob3V0IGV4dHJhIHdoaXRlc3BhY2UuIElmIGl0IGlzIGEgbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICBpdCB3aWxsIHNwZWNpZnkgdGhlIG51bWJlciBvZiBzcGFjZXMgdG8gaW5kZW50IGF0IGVhY2gKICAgICAgICAgICAgICAgICAgICAgICAgbGV2ZWwuIElmIGl0IGlzIGEgc3RyaW5nIChzdWNoIGFzICdcdCcpLCBpdCBjb250YWlucyB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgY2hhcmFjdGVycyB1c2VkIHRvIGluZGVudCBhdCBlYWNoIGxldmVsLgoKICAgICAgICAgICAgVGhpcyBtZXRob2QgcHJvZHVjZXMgYSBKU09OIHRleHQgZnJvbSBhIEphdmFTY3JpcHQgdmFsdWUuCgogICAgICAgICAgICBXaGVuIGFuIG9iamVjdCB2YWx1ZSBpcyBmb3VuZCwgaWYgdGhlIG9iamVjdCBjb250YWlucyBhIHRvSlNPTgogICAgICAgICAgICBtZXRob2QsIGl0cyB0b0pTT04gbWV0aG9kIHdpdGggYmUgY2FsbGVkIGFuZCB0aGUgcmVzdWx0IHdpbGwgYmUKICAgICAgICAgICAgc3RyaW5naWZpZWQuIEEgdG9KU09OIG1ldGhvZCBkb2VzIG5vdCBzZXJpYWxpemU6IGl0IHJldHVybnMgdGhlCiAgICAgICAgICAgIHZhbHVlIHJlcHJlc2VudGVkIGJ5IHRoZSBuYW1lL3ZhbHVlIHBhaXIgdGhhdCBzaG91bGQgYmUgc2VyaWFsaXplZCwKICAgICAgICAgICAgb3IgdW5kZWZpbmVkIGlmIG5vdGhpbmcgc2hvdWxkIGJlIHNlcmlhbGl6ZWQuIFRoZSB0b0pTT04gbWV0aG9kIHdpbGwKICAgICAgICAgICAgYmUgcGFzc2VkIHRoZSBrZXkgYXNzb2NpYXRlZCB3aXRoIHRoZSB2YWx1ZSwgYW5kIHRoaXMgd2lsbCBiZSBib3VuZAogICAgICAgICAgICB0byB0aGUgb2JqZWN0IGhvbGRpbmcgdGhlIGtleS4KCiAgICAgICAgICAgIFRoaXMgaXMgdGhlIHRvSlNPTiBtZXRob2QgYWRkZWQgdG8gRGF0ZXM6CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gdG9KU09OKGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFVUQ0Z1bGxZZWFyKCkgICArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTW9udGgoKSArIDEpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENEYXRlKCkpICAgICAgKyAnVCcgKwogICAgICAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ0hvdXJzKCkpICAgICArICc6JyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTWludXRlcygpKSAgICsgJzonICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENTZWNvbmRzKCkpICAgKyAnWic7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICBZb3UgY2FuIHByb3ZpZGUgYW4gb3B0aW9uYWwgcmVwbGFjZXIgbWV0aG9kLiBJdCB3aWxsIGJlIHBhc3NlZCB0aGUKICAgICAgICAgICAga2V5IGFuZCB2YWx1ZSBvZiBlYWNoIG1lbWJlciwgd2l0aCB0aGlzIGJvdW5kIHRvIHRoZSBjb250YWluaW5nCiAgICAgICAgICAgIG9iamVjdC4gVGhlIHZhbHVlIHRoYXQgaXMgcmV0dXJuZWQgZnJvbSB5b3VyIG1ldGhvZCB3aWxsIGJlCiAgICAgICAgICAgIHNlcmlhbGl6ZWQuIElmIHlvdXIgbWV0aG9kIHJldHVybnMgdW5kZWZpbmVkLCB0aGVuIHRoZSBtZW1iZXIgd2lsbAogICAgICAgICAgICBiZSBleGNsdWRlZCBmcm9tIHRoZSBzZXJpYWxpemF0aW9uLgoKICAgICAgICAgICAgSWYgbm8gcmVwbGFjZXIgcGFyYW1ldGVyIGlzIHByb3ZpZGVkLCB0aGVuIGEgZGVmYXVsdCByZXBsYWNlcgogICAgICAgICAgICB3aWxsIGJlIHVzZWQ6CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCBrZXkpID8KICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICBUaGUgZGVmYXVsdCByZXBsYWNlciBpcyBwYXNzZWQgdGhlIGtleSBhbmQgdmFsdWUgZm9yIGVhY2ggaXRlbSBpbgogICAgICAgICAgICB0aGUgc3RydWN0dXJlLiBJdCBleGNsdWRlcyBpbmhlcml0ZWQgbWVtYmVycy4KCiAgICAgICAgICAgIElmIHRoZSByZXBsYWNlciBwYXJhbWV0ZXIgaXMgYW4gYXJyYXksIHRoZW4gaXQgd2lsbCBiZSB1c2VkIHRvCiAgICAgICAgICAgIHNlbGVjdCB0aGUgbWVtYmVycyB0byBiZSBzZXJpYWxpemVkLiBJdCBmaWx0ZXJzIHRoZSByZXN1bHRzIHN1Y2gKICAgICAgICAgICAgdGhhdCBvbmx5IG1lbWJlcnMgd2l0aCBrZXlzIGxpc3RlZCBpbiB0aGUgcmVwbGFjZXIgYXJyYXkgYXJlCiAgICAgICAgICAgIHN0cmluZ2lmaWVkLgoKICAgICAgICAgICAgVmFsdWVzIHRoYXQgZG8gbm90IGhhdmUgSlNPTiByZXByZXNlbnRhaW9ucywgc3VjaCBhcyB1bmRlZmluZWQgb3IKICAgICAgICAgICAgZnVuY3Rpb25zLCB3aWxsIG5vdCBiZSBzZXJpYWxpemVkLiBTdWNoIHZhbHVlcyBpbiBvYmplY3RzIHdpbGwgYmUKICAgICAgICAgICAgZHJvcHBlZDsgaW4gYXJyYXlzIHRoZXkgd2lsbCBiZSByZXBsYWNlZCB3aXRoIG51bGwuIFlvdSBjYW4gdXNlCiAgICAgICAgICAgIGEgcmVwbGFjZXIgZnVuY3Rpb24gdG8gcmVwbGFjZSB0aG9zZSB3aXRoIEpTT04gdmFsdWVzLgogICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh1bmRlZmluZWQpIHJldHVybnMgdW5kZWZpbmVkLgoKICAgICAgICAgICAgVGhlIG9wdGlvbmFsIHNwYWNlIHBhcmFtZXRlciBwcm9kdWNlcyBhIHN0cmluZ2lmaWNhdGlvbiBvZiB0aGUgdmFsdWUKICAgICAgICAgICAgdGhhdCBpcyBmaWxsZWQgd2l0aCBsaW5lIGJyZWFrcyBhbmQgaW5kZW50YXRpb24gdG8gbWFrZSBpdCBlYXNpZXIgdG8KICAgICAgICAgICAgcmVhZC4KCiAgICAgICAgICAgIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBub24tZW1wdHkgc3RyaW5nLCB0aGVuIHRoYXQgc3RyaW5nIHdpbGwKICAgICAgICAgICAgYmUgdXNlZCBmb3IgaW5kZW50YXRpb24uIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIHRoZW4KICAgICAgICAgICAgdGhlbiBpbmRlbnRhdGlvbiB3aWxsIGJlIHRoYXQgbWFueSBzcGFjZXMuCgogICAgICAgICAgICBFeGFtcGxlOgoKICAgICAgICAgICAgdGV4dCA9IEpTT04uc3RyaW5naWZ5KFsnZScsIHtwbHVyaWJ1czogJ3VudW0nfV0pOwogICAgICAgICAgICAvLyB0ZXh0IGlzICdbImUiLHsicGx1cmlidXMiOiJ1bnVtIn1dJwoKCiAgICAgICAgICAgIHRleHQgPSBKU09OLnN0cmluZ2lmeShbJ2UnLCB7cGx1cmlidXM6ICd1bnVtJ31dLCBudWxsLCAnXHQnKTsKICAgICAgICAgICAgLy8gdGV4dCBpcyAnW1xuXHQiZSIsXG5cdHtcblx0XHQicGx1cmlidXMiOiAidW51bSJcblx0fVxuXScKCgogICAgICAgIEpTT04ucGFyc2UodGV4dCwgcmV2aXZlcikKICAgICAgICAgICAgVGhpcyBtZXRob2QgcGFyc2VzIGEgSlNPTiB0ZXh0IHRvIHByb2R1Y2UgYW4gb2JqZWN0IG9yIGFycmF5LgogICAgICAgICAgICBJdCBjYW4gdGhyb3cgYSBTeW50YXhFcnJvciBleGNlcHRpb24uCgogICAgICAgICAgICBUaGUgb3B0aW9uYWwgcmV2aXZlciBwYXJhbWV0ZXIgaXMgYSBmdW5jdGlvbiB0aGF0IGNhbiBmaWx0ZXIgYW5kCiAgICAgICAgICAgIHRyYW5zZm9ybSB0aGUgcmVzdWx0cy4gSXQgcmVjZWl2ZXMgZWFjaCBvZiB0aGUga2V5cyBhbmQgdmFsdWVzLCBhbmQKICAgICAgICAgICAgaXRzIHJldHVybiB2YWx1ZSBpcyB1c2VkIGluc3RlYWQgb2YgdGhlIG9yaWdpbmFsIHZhbHVlLiBJZiBpdAogICAgICAgICAgICByZXR1cm5zIHdoYXQgaXQgcmVjZWl2ZWQsIHRoZW4gc3RydWN0dXJlIGlzIG5vdCBtb2RpZmllZC4gSWYgaXQKICAgICAgICAgICAgcmV0dXJucyB1bmRlZmluZWQgdGhlbiB0aGUgbWVtYmVyIGlzIGRlbGV0ZWQuCgogICAgICAgICAgICBFeGFtcGxlOgoKICAgICAgICAgICAgLy8gUGFyc2UgdGhlIHRleHQuIFZhbHVlcyB0aGF0IGxvb2sgbGlrZSBJU08gZGF0ZSBzdHJpbmdzIHdpbGwKICAgICAgICAgICAgLy8gYmUgY29udmVydGVkIHRvIERhdGUgb2JqZWN0cy4KCiAgICAgICAgICAgIG15RGF0YSA9IEpTT04ucGFyc2UodGV4dCwgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBhOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBhID0KL14oXGR7NH0pLShcZHsyfSktKFxkezJ9KVQoXGR7Mn0pOihcZHsyfSk6KFxkezJ9KD86XC5cZCopPylaJC8uZXhlYyh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKCthWzFdLCArYVsyXSAtIDEsICthWzNdLCArYVs0XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICthWzVdLCArYVs2XSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSk7CgoKICAgICAgICBKU09OLnF1b3RlKHRleHQpCiAgICAgICAgICAgIFRoaXMgbWV0aG9kIHdyYXBzIGEgc3RyaW5nIGluIHF1b3RlcywgZXNjYXBpbmcgc29tZSBjaGFyYWN0ZXJzCiAgICAgICAgICAgIGFzIG5lZWRlZC4KCgogICAgVGhpcyBpcyBhIHJlZmVyZW5jZSBpbXBsZW1lbnRhdGlvbi4gWW91IGFyZSBmcmVlIHRvIGNvcHksIG1vZGlmeSwgb3IKICAgIHJlZGlzdHJpYnV0ZS4KCiAgICBVU0UgWU9VUiBPV04gQ09QWS4gSVQgSVMgRVhUUkVNRUxZIFVOV0lTRSBUTyBMT0FEIFRISVJEIFBBUlRZCiAgICBDT0RFIElOVE8gWU9VUiBQQUdFUy4KKi8KCiAgLypqc2xpbnQgcmVnZXhwOiB0cnVlLCBmb3JpbjogdHJ1ZSwgZXZpbDogdHJ1ZSAqLwoKICAvKmdsb2JhbCBKU09OICovCgogIC8qbWVtYmVycyAiIiwgIlxiIiwgIlx0IiwgIlxuIiwgIlxmIiwgIlxyIiwgIlwiIiwgSlNPTiwgIlxcIiwgYXBwbHksCiAgICBjYWxsLCBjaGFyQ29kZUF0LCBmbG9vciwgZ2V0VVRDRGF0ZSwgZ2V0VVRDRnVsbFllYXIsIGdldFVUQ0hvdXJzLAogICAgZ2V0VVRDTWludXRlcywgZ2V0VVRDTW9udGgsIGdldFVUQ1NlY29uZHMsIGhhc093blByb3BlcnR5LCBqb2luLCBsZW5ndGgsCiAgICBwYXJzZSwgcHJvcGVydHlJc0VudW1lcmFibGUsIHByb3RvdHlwZSwgcHVzaCwgcXVvdGUsIHJlcGxhY2UsIHN0cmluZ2lmeSwKICAgIHRlc3QsIHRvSlNPTiwgdG9TdHJpbmcKKi8KCiAgaWYgKCFKU09OKSB7CgogICAgLy8gQ3JlYXRlIGEgSlNPTiBvYmplY3Qgb25seSBpZiBvbmUgZG9lcyBub3QgYWxyZWFkeSBleGlzdC4gV2UgY3JlYXRlIHRoZQogICAgLy8gb2JqZWN0IGluIGEgY2xvc3VyZSB0byBhdm9pZCBnbG9iYWwgdmFyaWFibGVzLgoKICAgIHZhciBKU09OID0gZnVuY3Rpb24oKSB7CgogICAgICBmdW5jdGlvbiBmKG4pIHsgLy8gRm9ybWF0IGludGVnZXJzIHRvIGhhdmUgYXQgbGVhc3QgdHdvIGRpZ2l0cy4KICAgICAgICByZXR1cm4gbiA8IDEwID8gJzAnICsgbiA6IG47CiAgICAgIH0KCiAgICAgIERhdGUucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAvLyBFdmVudHVhbGx5LCB0aGlzIG1ldGhvZCB3aWxsIGJlIGJhc2VkIG9uIHRoZSBkYXRlLnRvSVNPU3RyaW5nIG1ldGhvZC4KCiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VVRDRnVsbFllYXIoKSArICctJyArCiAgICAgICAgICBmKHRoaXMuZ2V0VVRDTW9udGgoKSArIDEpICsgJy0nICsKICAgICAgICAgIGYodGhpcy5nZXRVVENEYXRlKCkpICsgJ1QnICsKICAgICAgICAgIGYodGhpcy5nZXRVVENIb3VycygpKSArICc6JyArCiAgICAgICAgICBmKHRoaXMuZ2V0VVRDTWludXRlcygpKSArICc6JyArCiAgICAgICAgICBmKHRoaXMuZ2V0VVRDU2Vjb25kcygpKSArICdaJzsKICAgICAgfTsKCgogICAgICB2YXIgZXNjYXBlYWJsZSA9IC9bIlxcXHgwMC1ceDFmXHg3Zi1ceDlmXS9nLAogICAgICAgIGdhcCwKICAgICAgICBpbmRlbnQsCiAgICAgICAgbWV0YSA9IHsgLy8gdGFibGUgb2YgY2hhcmFjdGVyIHN1YnN0aXR1dGlvbnMKICAgICAgICAgICdcYic6ICdcXGInLAogICAgICAgICAgJ1x0JzogJ1xcdCcsCiAgICAgICAgICAnXG4nOiAnXFxuJywKICAgICAgICAgICdcZic6ICdcXGYnLAogICAgICAgICAgJ1xyJzogJ1xccicsCiAgICAgICAgICAnIic6ICdcXCInLAogICAgICAgICAgJ1xcJzogJ1xcXFwnCiAgICAgICAgfSwKICAgICAgICByZXA7CgoKICAgICAgZnVuY3Rpb24gcXVvdGUoc3RyaW5nKSB7CgogICAgICAgIC8vIElmIHRoZSBzdHJpbmcgY29udGFpbnMgbm8gY29udHJvbCBjaGFyYWN0ZXJzLCBubyBxdW90ZSBjaGFyYWN0ZXJzLCBhbmQgbm8KICAgICAgICAvLyBiYWNrc2xhc2ggY2hhcmFjdGVycywgdGhlbiB3ZSBjYW4gc2FmZWx5IHNsYXAgc29tZSBxdW90ZXMgYXJvdW5kIGl0LgogICAgICAgIC8vIE90aGVyd2lzZSB3ZSBtdXN0IGFsc28gcmVwbGFjZSB0aGUgb2ZmZW5kaW5nIGNoYXJhY3RlcnMgd2l0aCBzYWZlIGVzY2FwZQogICAgICAgIC8vIHNlcXVlbmNlcy4KCiAgICAgICAgcmV0dXJuIGVzY2FwZWFibGUudGVzdChzdHJpbmcpID8KICAgICAgICAgICciJyArIHN0cmluZy5yZXBsYWNlKGVzY2FwZWFibGUsIGZ1bmN0aW9uKGEpIHsKICAgICAgICAgICAgdmFyIGMgPSBtZXRhW2FdOwogICAgICAgICAgICBpZiAodHlwZW9mIGMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYyA9IGEuY2hhckNvZGVBdCgpOwogICAgICAgICAgICByZXR1cm4gJ1xcdTAwJyArIE1hdGguZmxvb3IoYyAvIDE2KS50b1N0cmluZygxNikgKwogICAgICAgICAgICAgIChjICUgMTYpLnRvU3RyaW5nKDE2KTsKICAgICAgICAgIH0pICsgJyInIDoKICAgICAgICAgICciJyArIHN0cmluZyArICciJzsKICAgICAgfQoKCiAgICAgIGZ1bmN0aW9uIHN0cihrZXksIGhvbGRlcikgewoKICAgICAgICAvLyBQcm9kdWNlIGEgc3RyaW5nIGZyb20gaG9sZGVyW2tleV0uCgogICAgICAgIHZhciBpLCAvLyBUaGUgbG9vcCBjb3VudGVyLgogICAgICAgICAgaywgLy8gVGhlIG1lbWJlciBrZXkuCiAgICAgICAgICB2LCAvLyBUaGUgbWVtYmVyIHZhbHVlLgogICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgbWluZCA9IGdhcCwKICAgICAgICAgIHBhcnRpYWwsCiAgICAgICAgICB2YWx1ZSA9IGhvbGRlcltrZXldOwoKICAgICAgICAvLyBJZiB0aGUgdmFsdWUgaGFzIGEgdG9KU09OIG1ldGhvZCwgY2FsbCBpdCB0byBvYnRhaW4gYSByZXBsYWNlbWVudCB2YWx1ZS4KCiAgICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYKICAgICAgICAgIHR5cGVvZiB2YWx1ZS50b0pTT04gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9KU09OKGtleSk7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB3ZSB3ZXJlIGNhbGxlZCB3aXRoIGEgcmVwbGFjZXIgZnVuY3Rpb24sIHRoZW4gY2FsbCB0aGUgcmVwbGFjZXIgdG8KICAgICAgICAvLyBvYnRhaW4gYSByZXBsYWNlbWVudCB2YWx1ZS4KCiAgICAgICAgaWYgKHR5cGVvZiByZXAgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHZhbHVlID0gcmVwLmNhbGwoaG9sZGVyLCBrZXksIHZhbHVlKTsKICAgICAgICB9CgogICAgICAgIC8vIFdoYXQgaGFwcGVucyBuZXh0IGRlcGVuZHMgb24gdGhlIHZhbHVlJ3MgdHlwZS4KCiAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICAgIHJldHVybiBxdW90ZSh2YWx1ZSk7CgogICAgICAgICAgY2FzZSAnbnVtYmVyJzoKCiAgICAgICAgICAgIC8vIEpTT04gbnVtYmVycyBtdXN0IGJlIGZpbml0ZS4gRW5jb2RlIG5vbi1maW5pdGUgbnVtYmVycyBhcyBudWxsLgoKICAgICAgICAgICAgcmV0dXJuIGlzRmluaXRlKHZhbHVlKSA/IFN0cmluZyh2YWx1ZSkgOiAnbnVsbCc7CgogICAgICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgICBjYXNlICdudWxsJzoKCiAgICAgICAgICAgIC8vIElmIHRoZSB2YWx1ZSBpcyBhIGJvb2xlYW4gb3IgbnVsbCwgY29udmVydCBpdCB0byBhIHN0cmluZy4gTm90ZToKICAgICAgICAgICAgLy8gdHlwZW9mIG51bGwgZG9lcyBub3QgcHJvZHVjZSAnbnVsbCcuIFRoZSBjYXNlIGlzIGluY2x1ZGVkIGhlcmUgaW4KICAgICAgICAgICAgLy8gdGhlIHJlbW90ZSBjaGFuY2UgdGhhdCB0aGlzIGdldHMgZml4ZWQgc29tZWRheS4KCiAgICAgICAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpOwoKICAgICAgICAgICAgLy8gSWYgdGhlIHR5cGUgaXMgJ29iamVjdCcsIHdlIG1pZ2h0IGJlIGRlYWxpbmcgd2l0aCBhbiBvYmplY3Qgb3IgYW4gYXJyYXkgb3IKICAgICAgICAgICAgLy8gbnVsbC4KCiAgICAgICAgICBjYXNlICdvYmplY3QnOgoKICAgICAgICAgICAgLy8gRHVlIHRvIGEgc3BlY2lmaWNhdGlvbiBibHVuZGVyIGluIEVDTUFTY3JpcHQsIHR5cGVvZiBudWxsIGlzICdvYmplY3QnLAogICAgICAgICAgICAvLyBzbyB3YXRjaCBvdXQgZm9yIHRoYXQgY2FzZS4KCiAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gJ251bGwnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNYWtlIGFuIGFycmF5IHRvIGhvbGQgdGhlIHBhcnRpYWwgcmVzdWx0cyBvZiBzdHJpbmdpZnlpbmcgdGhpcyBvYmplY3QgdmFsdWUuCgogICAgICAgICAgICBnYXAgKz0gaW5kZW50OwogICAgICAgICAgICBwYXJ0aWFsID0gW107CgogICAgICAgICAgICAvLyBJZiB0aGUgb2JqZWN0IGhhcyBhIGRvbnRFbnVtIGxlbmd0aCBwcm9wZXJ0eSwgd2UnbGwgdHJlYXQgaXQgYXMgYW4gYXJyYXkuCgogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlLmxlbmd0aCA9PT0gJ251bWJlcicgJiYgISh2YWx1ZS5wcm9wZXJ0eUlzRW51bWVyYWJsZSgnbGVuZ3RoJykpKSB7CgogICAgICAgICAgICAgIC8vIFRoZSBvYmplY3QgaXMgYW4gYXJyYXkuIFN0cmluZ2lmeSBldmVyeSBlbGVtZW50LiBVc2UgbnVsbCBhcyBhIHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgLy8gZm9yIG5vbi1KU09OIHZhbHVlcy4KCiAgICAgICAgICAgICAgbGVuZ3RoID0gdmFsdWUubGVuZ3RoOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgcGFydGlhbFtpXSA9IHN0cihpLCB2YWx1ZSkgfHwgJ251bGwnOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gSm9pbiBhbGwgb2YgdGhlIGVsZW1lbnRzIHRvZ2V0aGVyLCBzZXBhcmF0ZWQgd2l0aCBjb21tYXMsIGFuZCB3cmFwIHRoZW0gaW4KICAgICAgICAgICAgICAvLyBicmFja2V0cy4KCiAgICAgICAgICAgICAgdiA9IHBhcnRpYWwubGVuZ3RoID09PSAwID8gJ1tdJyA6CiAgICAgICAgICAgICAgICBnYXAgPyAnW1xuJyArIGdhcCArIHBhcnRpYWwuam9pbignLFxuJyArIGdhcCkgKwogICAgICAgICAgICAgICAgJ1xuJyArIG1pbmQgKyAnXScgOgogICAgICAgICAgICAgICAgJ1snICsgcGFydGlhbC5qb2luKCcsJykgKyAnXSc7CiAgICAgICAgICAgICAgZ2FwID0gbWluZDsKICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgdGhlIHJlcGxhY2VyIGlzIGFuIGFycmF5LCB1c2UgaXQgdG8gc2VsZWN0IHRoZSBtZW1iZXJzIHRvIGJlIHN0cmluZ2lmaWVkLgoKICAgICAgICAgICAgaWYgKHR5cGVvZiByZXAgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgbGVuZ3RoID0gcmVwLmxlbmd0aDsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgIGsgPSByZXBbaV07CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGsgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgIHYgPSBzdHIoaywgdmFsdWUsIHJlcCk7CiAgICAgICAgICAgICAgICAgIGlmICh2KSB7CiAgICAgICAgICAgICAgICAgICAgcGFydGlhbC5wdXNoKHF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgaXRlcmF0ZSB0aHJvdWdoIGFsbCBvZiB0aGUga2V5cyBpbiB0aGUgb2JqZWN0LgoKICAgICAgICAgICAgICBmb3IgKGsgaW4gdmFsdWUpIHsKICAgICAgICAgICAgICAgIHYgPSBzdHIoaywgdmFsdWUsIHJlcCk7CiAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICBwYXJ0aWFsLnB1c2gocXVvdGUoaykgKyAoZ2FwID8gJzogJyA6ICc6JykgKyB2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEpvaW4gYWxsIG9mIHRoZSBtZW1iZXIgdGV4dHMgdG9nZXRoZXIsIHNlcGFyYXRlZCB3aXRoIGNvbW1hcywKICAgICAgICAgICAgLy8gYW5kIHdyYXAgdGhlbSBpbiBicmFjZXMuCgogICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAgPyAne30nIDoKICAgICAgICAgICAgICBnYXAgPyAne1xuJyArIGdhcCArIHBhcnRpYWwuam9pbignLFxuJyArIGdhcCkgKwogICAgICAgICAgICAgICdcbicgKyBtaW5kICsgJ30nIDoKICAgICAgICAgICAgICAneycgKyBwYXJ0aWFsLmpvaW4oJywnKSArICd9JzsKICAgICAgICAgICAgZ2FwID0gbWluZDsKICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgfQogICAgICB9CgoKICAgICAgLy8gUmV0dXJuIHRoZSBKU09OIG9iamVjdCBjb250YWluaW5nIHRoZSBzdHJpbmdpZnksIHBhcnNlLCBhbmQgcXVvdGUgbWV0aG9kcy4KCiAgICAgIHJldHVybiB7CiAgICAgICAgc3RyaW5naWZ5OiBmdW5jdGlvbih2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKSB7CgogICAgICAgICAgLy8gVGhlIHN0cmluZ2lmeSBtZXRob2QgdGFrZXMgYSB2YWx1ZSBhbmQgYW4gb3B0aW9uYWwgcmVwbGFjZXIsIGFuZCBhbiBvcHRpb25hbAogICAgICAgICAgLy8gc3BhY2UgcGFyYW1ldGVyLCBhbmQgcmV0dXJucyBhIEpTT04gdGV4dC4gVGhlIHJlcGxhY2VyIGNhbiBiZSBhIGZ1bmN0aW9uCiAgICAgICAgICAvLyB0aGF0IGNhbiByZXBsYWNlIHZhbHVlcywgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncyB0aGF0IHdpbGwgc2VsZWN0IHRoZSBrZXlzLgogICAgICAgICAgLy8gQSBkZWZhdWx0IHJlcGxhY2VyIG1ldGhvZCBjYW4gYmUgcHJvdmlkZWQuIFVzZSBvZiB0aGUgc3BhY2UgcGFyYW1ldGVyIGNhbgogICAgICAgICAgLy8gcHJvZHVjZSB0ZXh0IHRoYXQgaXMgbW9yZSBlYXNpbHkgcmVhZGFibGUuCgogICAgICAgICAgdmFyIGk7CiAgICAgICAgICBnYXAgPSAnJzsKICAgICAgICAgIGluZGVudCA9ICcnOwogICAgICAgICAgaWYgKHNwYWNlKSB7CgogICAgICAgICAgICAvLyBJZiB0aGUgc3BhY2UgcGFyYW1ldGVyIGlzIGEgbnVtYmVyLCBtYWtlIGFuIGluZGVudCBzdHJpbmcgY29udGFpbmluZyB0aGF0CiAgICAgICAgICAgIC8vIG1hbnkgc3BhY2VzLgoKICAgICAgICAgICAgaWYgKHR5cGVvZiBzcGFjZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3BhY2U7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgaW5kZW50ICs9ICcgJzsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBzdHJpbmcsIGl0IHdpbGwgYmUgdXNlZCBhcyB0aGUgaW5kZW50IHN0cmluZy4KCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNwYWNlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgIGluZGVudCA9IHNwYWNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gcmVwbGFjZXIgcGFyYW1ldGVyLCB1c2UgdGhlIGRlZmF1bHQgcmVwbGFjZXIuCgogICAgICAgICAgaWYgKCFyZXBsYWNlcikgewogICAgICAgICAgICByZXAgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKCFPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCBrZXkpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBUaGUgcmVwbGFjZXIgY2FuIGJlIGEgZnVuY3Rpb24gb3IgYW4gYXJyYXkuIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3IuCgogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVwbGFjZXIgPT09ICdmdW5jdGlvbicgfHwKICAgICAgICAgICAgKHR5cGVvZiByZXBsYWNlciA9PT0gJ29iamVjdCcgJiYKICAgICAgICAgICAgICB0eXBlb2YgcmVwbGFjZXIubGVuZ3RoID09PSAnbnVtYmVyJykpIHsKICAgICAgICAgICAgcmVwID0gcmVwbGFjZXI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0pTT04uc3RyaW5naWZ5Jyk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTWFrZSBhIGZha2Ugcm9vdCBvYmplY3QgY29udGFpbmluZyBvdXIgdmFsdWUgdW5kZXIgdGhlIGtleSBvZiAnJy4KICAgICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0IG9mIHN0cmluZ2lmeWluZyB0aGUgdmFsdWUuCgogICAgICAgICAgcmV0dXJuIHN0cignJywgewogICAgICAgICAgICAnJzogdmFsdWUKICAgICAgICAgIH0pOwogICAgICAgIH0sCgoKICAgICAgICBwYXJzZTogZnVuY3Rpb24odGV4dCwgcmV2aXZlcikgewoKICAgICAgICAgIC8vIFRoZSBwYXJzZSBtZXRob2QgdGFrZXMgYSB0ZXh0IGFuZCBhbiBvcHRpb25hbCByZXZpdmVyIGZ1bmN0aW9uLCBhbmQgcmV0dXJucwogICAgICAgICAgLy8gYSBKYXZhU2NyaXB0IHZhbHVlIGlmIHRoZSB0ZXh0IGlzIGEgdmFsaWQgSlNPTiB0ZXh0LgoKICAgICAgICAgIHZhciBqOwoKICAgICAgICAgIGZ1bmN0aW9uIHdhbGsoaG9sZGVyLCBrZXkpIHsKCiAgICAgICAgICAgIC8vIFRoZSB3YWxrIG1ldGhvZCBpcyB1c2VkIHRvIHJlY3Vyc2l2ZWx5IHdhbGsgdGhlIHJlc3VsdGluZyBzdHJ1Y3R1cmUgc28KICAgICAgICAgICAgLy8gdGhhdCBtb2RpZmljYXRpb25zIGNhbiBiZSBtYWRlLgoKICAgICAgICAgICAgdmFyIGssIHYsIHZhbHVlID0gaG9sZGVyW2tleV07CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgZm9yIChrIGluIHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGspKSB7CiAgICAgICAgICAgICAgICAgIHYgPSB3YWxrKHZhbHVlLCBrKTsKICAgICAgICAgICAgICAgICAgaWYgKHYgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlW2tdID0gdjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdmFsdWVba107CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldml2ZXIuY2FsbChob2xkZXIsIGtleSwgdmFsdWUpOwogICAgICAgICAgfQoKCiAgICAgICAgICAvLyBQYXJzaW5nIGhhcHBlbnMgaW4gdGhyZWUgc3RhZ2VzLiBJbiB0aGUgZmlyc3Qgc3RhZ2UsIHdlIHJ1biB0aGUgdGV4dCBhZ2FpbnN0CiAgICAgICAgICAvLyByZWd1bGFyIGV4cHJlc3Npb25zIHRoYXQgbG9vayBmb3Igbm9uLUpTT04gcGF0dGVybnMuIFdlIGFyZSBlc3BlY2lhbGx5CiAgICAgICAgICAvLyBjb25jZXJuZWQgd2l0aCAnKCknIGFuZCAnbmV3JyBiZWNhdXNlIHRoZXkgY2FuIGNhdXNlIGludm9jYXRpb24sIGFuZCAnPScKICAgICAgICAgIC8vIGJlY2F1c2UgaXQgY2FuIGNhdXNlIG11dGF0aW9uLiBCdXQganVzdCB0byBiZSBzYWZlLCB3ZSB3YW50IHRvIHJlamVjdCBhbGwKICAgICAgICAgIC8vIHVuZXhwZWN0ZWQgZm9ybXMuCgogICAgICAgICAgLy8gV2Ugc3BsaXQgdGhlIGZpcnN0IHN0YWdlIGludG8gNCByZWdleHAgb3BlcmF0aW9ucyBpbiBvcmRlciB0byB3b3JrIGFyb3VuZAogICAgICAgICAgLy8gY3JpcHBsaW5nIGluZWZmaWNpZW5jaWVzIGluIElFJ3MgYW5kIFNhZmFyaSdzIHJlZ2V4cCBlbmdpbmVzLiBGaXJzdCB3ZQogICAgICAgICAgLy8gcmVwbGFjZSBhbGwgYmFja3NsYXNoIHBhaXJzIHdpdGggJ0AnIChhIG5vbi1KU09OIGNoYXJhY3RlcikuIFNlY29uZCwgd2UKICAgICAgICAgIC8vIHJlcGxhY2UgYWxsIHNpbXBsZSB2YWx1ZSB0b2tlbnMgd2l0aCAnXScgY2hhcmFjdGVycy4gVGhpcmQsIHdlIGRlbGV0ZSBhbGwKICAgICAgICAgIC8vIG9wZW4gYnJhY2tldHMgdGhhdCBmb2xsb3cgYSBjb2xvbiBvciBjb21tYSBvciB0aGF0IGJlZ2luIHRoZSB0ZXh0LiBGaW5hbGx5LAogICAgICAgICAgLy8gd2UgbG9vayB0byBzZWUgdGhhdCB0aGUgcmVtYWluaW5nIGNoYXJhY3RlcnMgYXJlIG9ubHkgd2hpdGVzcGFjZSBvciAnXScgb3IKICAgICAgICAgIC8vICcsJyBvciAnOicgb3IgJ3snIG9yICd9Jy4gSWYgdGhhdCBpcyBzbywgdGhlbiB0aGUgdGV4dCBpcyBzYWZlIGZvciBldmFsLgoKICAgICAgICAgIGlmICgvXltcXSw6e31cc10qJC8udGVzdCh0ZXh0LnJlcGxhY2UoL1xcWyJcXFwvYmZucnR1XS9nLCAnQCcpLnJlcGxhY2UoLyJbXiJcXFxuXHJdKiJ8dHJ1ZXxmYWxzZXxudWxsfC0/XGQrKD86XC5cZCopPyg/OltlRV1bK1wtXT9cZCspPy9nLCAnXScpLnJlcGxhY2UoLyg/Ol58OnwsKSg/OlxzKlxbKSsvZywgJycpKSkgewoKICAgICAgICAgICAgLy8gSW4gdGhlIHNlY29uZCBzdGFnZSB3ZSB1c2UgdGhlIGV2YWwgZnVuY3Rpb24gdG8gY29tcGlsZSB0aGUgdGV4dCBpbnRvIGEKICAgICAgICAgICAgLy8gSmF2YVNjcmlwdCBzdHJ1Y3R1cmUuIFRoZSAneycgb3BlcmF0b3IgaXMgc3ViamVjdCB0byBhIHN5bnRhY3RpYyBhbWJpZ3VpdHkKICAgICAgICAgICAgLy8gaW4gSmF2YVNjcmlwdDogaXQgY2FuIGJlZ2luIGEgYmxvY2sgb3IgYW4gb2JqZWN0IGxpdGVyYWwuIFdlIHdyYXAgdGhlIHRleHQKICAgICAgICAgICAgLy8gaW4gcGFyZW5zIHRvIGVsaW1pbmF0ZSB0aGUgYW1iaWd1aXR5LgoKICAgICAgICAgICAgaiA9IGV2YWwoJygnICsgdGV4dCArICcpJyk7CgogICAgICAgICAgICAvLyBJbiB0aGUgb3B0aW9uYWwgdGhpcmQgc3RhZ2UsIHdlIHJlY3Vyc2l2ZWx5IHdhbGsgdGhlIG5ldyBzdHJ1Y3R1cmUsIHBhc3NpbmcKICAgICAgICAgICAgLy8gZWFjaCBuYW1lL3ZhbHVlIHBhaXIgdG8gYSByZXZpdmVyIGZ1bmN0aW9uIGZvciBwb3NzaWJsZSB0cmFuc2Zvcm1hdGlvbi4KCiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgcmV2aXZlciA9PT0gJ2Z1bmN0aW9uJyA/CiAgICAgICAgICAgICAgd2Fsayh7CiAgICAgICAgICAgICAgICAnJzogagogICAgICAgICAgICAgIH0sICcnKSA6IGo7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gSWYgdGhlIHRleHQgaXMgbm90IEpTT04gcGFyc2VhYmxlLCB0aGVuIGEgU3ludGF4RXJyb3IgaXMgdGhyb3duLgoKICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignSlNPTi5wYXJzZScpOwogICAgICAgIH0sCgogICAgICAgIHF1b3RlOiBxdW90ZQogICAgICB9OwogICAgfSgpOwogIH0KCiAgLy9qc29uIGVuZAoKICAvL3BlcnNpc3QtbWluIHN0YXJ0CgogIChmdW5jdGlvbigpIHsKICAgIGlmICh3aW5kb3cuZ29vZ2xlICYmIGdvb2dsZS5nZWFycykKICAgICAgcmV0dXJuOwogICAgdmFyIEYgPSBudWxsOwogICAgaWYgKHR5cGVvZiBHZWFyc0ZhY3RvcnkgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgRiA9IG5ldyBHZWFyc0ZhY3RvcnkoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRyeSB7CiAgICAgICAgRiA9IG5ldyBBY3RpdmVYT2JqZWN0KCdHZWFycy5GYWN0b3J5Jyk7CiAgICAgICAgaWYgKEYuZ2V0QnVpbGRJbmZvKCkuaW5kZXhPZignaWVfbW9iaWxlJykgIT0gLTEpCiAgICAgICAgICBGLnByaXZhdGVTZXRHbG9iYWxPYmplY3QodGhpcyk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAoKHR5cGVvZiBuYXZpZ2F0b3IubWltZVR5cGVzICE9ICd1bmRlZmluZWQnKSAmJiBuYXZpZ2F0b3IubWltZVR5cGVzWyJhcHBsaWNhdGlvbi94LWdvb2dsZWdlYXJzIl0pIHsKICAgICAgICAgIEYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvYmplY3QiKTsKICAgICAgICAgIEYuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgIEYud2lkdGggPSAwOwogICAgICAgICAgRi5oZWlnaHQgPSAwOwogICAgICAgICAgRi50eXBlID0gImFwcGxpY2F0aW9uL3gtZ29vZ2xlZ2VhcnMiOwogICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKEYpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKCFGKQogICAgICByZXR1cm47CiAgICBpZiAoIXdpbmRvdy5nb29nbGUpCiAgICAgIGdvb2dsZSA9IHt9OwogICAgaWYgKCFnb29nbGUuZ2VhcnMpCiAgICAgIGdvb2dsZS5nZWFycyA9IHsKICAgICAgICBmYWN0b3J5OiBGCiAgICAgIH07CiAgfSkoKTsKICBQZXJzaXN0ID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIFZFUlNJT04gPSAnMC4yLjAnLAogICAgICBQLCBCLCBlc2MsIGluaXQsIGVtcHR5LCBlYzsKICAgIGVjID0gKGZ1bmN0aW9uKCkgewogICAgICB2YXIgRVBPQ0ggPSAnVGh1LCAwMS1KYW4tMTk3MCAwMDowMDowMSBHTVQnLAogICAgICAgIFJBVElPID0gMTAwMCAqIDYwICogNjAgKiAyNCwKICAgICAgICBLRVlTID0gWydleHBpcmVzJywgJ3BhdGgnLCAnZG9tYWluJ10sCiAgICAgICAgZXNjID0gZXNjYXBlLAogICAgICAgIHVuID0gdW5lc2NhcGUsCiAgICAgICAgZG9jID0gZG9jdW1lbnQsCiAgICAgICAgbWU7CiAgICAgIHZhciBnZXRfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHIgPSBuZXcgRGF0ZSgpOwogICAgICAgIHIuc2V0VGltZShyLmdldFRpbWUoKSk7CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KICAgICAgdmFyIGNvb2tpZnkgPSBmdW5jdGlvbihjX2tleSwgY192YWwpIHsKICAgICAgICB2YXIgaSwga2V5LCB2YWwsIHIgPSBbXSwKICAgICAgICAgIG9wdCA9IChhcmd1bWVudHMubGVuZ3RoID4gMikgPyBhcmd1bWVudHNbMl0gOiB7fTsKICAgICAgICByLnB1c2goZXNjKGNfa2V5KSArICc9JyArIGVzYyhjX3ZhbCkpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBLRVlTLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBrZXkgPSBLRVlTW2ldOwogICAgICAgICAgaWYgKHZhbCA9IG9wdFtrZXldKQogICAgICAgICAgICByLnB1c2goa2V5ICsgJz0nICsgdmFsKTsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdC5zZWN1cmUpCiAgICAgICAgICByLnB1c2goJ3NlY3VyZScpOwogICAgICAgIHJldHVybiByLmpvaW4oJzsgJyk7CiAgICAgIH0KICAgICAgdmFyIGFsaXZlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGsgPSAnX19FQ19URVNUX18nLAogICAgICAgICAgdiA9IG5ldyBEYXRlKCk7CiAgICAgICAgdiA9IHYudG9HTVRTdHJpbmcoKTsKICAgICAgICB0aGlzLnNldChrLCB2KTsKICAgICAgICB0aGlzLmVuYWJsZWQgPSAodGhpcy5yZW1vdmUoaykgPT0gdik7CiAgICAgICAgcmV0dXJuIHRoaXMuZW5hYmxlZDsKICAgICAgfQogICAgICBtZSA9IHsKICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsKSB7CiAgICAgICAgICB2YXIgb3B0ID0gKGFyZ3VtZW50cy5sZW5ndGggPiAyKSA/IGFyZ3VtZW50c1syXSA6IHt9LCBub3cgPSBnZXRfbm93KCksCiAgICAgICAgICAgIGV4cGlyZV9hdCwgY2ZnID0ge307CiAgICAgICAgICBpZiAob3B0LmV4cGlyZXMpIHsKICAgICAgICAgICAgb3B0LmV4cGlyZXMgKj0gUkFUSU87CiAgICAgICAgICAgIGNmZy5leHBpcmVzID0gbmV3IERhdGUobm93LmdldFRpbWUoKSArIG9wdC5leHBpcmVzKTsKICAgICAgICAgICAgY2ZnLmV4cGlyZXMgPSBjZmcuZXhwaXJlcy50b0dNVFN0cmluZygpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGtleXMgPSBbJ3BhdGgnLCAnZG9tYWluJywgJ3NlY3VyZSddOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIGlmIChvcHRba2V5c1tpXV0pCiAgICAgICAgICAgICAgY2ZnW2tleXNbaV1dID0gb3B0W2tleXNbaV1dOwogICAgICAgICAgdmFyIHIgPSBjb29raWZ5KGtleSwgdmFsLCBjZmcpOwogICAgICAgICAgZG9jLmNvb2tpZSA9IHI7CiAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0sCiAgICAgICAgaGFzOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgdmFyIGMgPSBkb2MuY29va2llLAogICAgICAgICAgICBvZnMgPSBjLmluZGV4T2Yoa2V5ICsgJz0nKSwKICAgICAgICAgICAgbGVuID0gb2ZzICsga2V5Lmxlbmd0aCArIDEsCiAgICAgICAgICAgIHN1YiA9IGMuc3Vic3RyaW5nKDAsIGtleS5sZW5ndGgpOwogICAgICAgICAgcmV0dXJuICgoIW9mcyAmJiBrZXkgIT0gc3ViKSB8fCBvZnMgPCAwKSA/IGZhbHNlIDogdHJ1ZTsKICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICBrZXkgPSBlc2Moa2V5KTsKICAgICAgICAgIHZhciBjID0gZG9jLmNvb2tpZSwKICAgICAgICAgICAgb2ZzID0gYy5pbmRleE9mKGtleSArICc9JyksCiAgICAgICAgICAgIGxlbiA9IG9mcyArIGtleS5sZW5ndGggKyAxLAogICAgICAgICAgICBzdWIgPSBjLnN1YnN0cmluZygwLCBrZXkubGVuZ3RoKSwKICAgICAgICAgICAgZW5kOwogICAgICAgICAgaWYgKCghb2ZzICYmIGtleSAhPSBzdWIpIHx8IG9mcyA8IDApCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgZW5kID0gYy5pbmRleE9mKCc7JywgbGVuKTsKICAgICAgICAgIGlmIChlbmQgPCAwKQogICAgICAgICAgICBlbmQgPSBjLmxlbmd0aDsKICAgICAgICAgIHJldHVybiB1bihjLnN1YnN0cmluZyhsZW4sIGVuZCkpOwogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrKSB7CiAgICAgICAgICB2YXIgciA9IG1lLmdldChrKSwKICAgICAgICAgICAgb3B0ID0gewogICAgICAgICAgICAgIGV4cGlyZXM6IEVQT0NICiAgICAgICAgICAgIH07CiAgICAgICAgICBkb2MuY29va2llID0gY29va2lmeShrLCAnJywgb3B0KTsKICAgICAgICAgIHJldHVybiByOwogICAgICAgIH0sCiAgICAgICAga2V5czogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYyA9IGRvYy5jb29raWUsCiAgICAgICAgICAgIHBzID0gYy5zcGxpdCgnOyAnKSwKICAgICAgICAgICAgaSwgcCwgciA9IFtdOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHAgPSBwc1tpXS5zcGxpdCgnPScpOwogICAgICAgICAgICByLnB1c2godW4ocFswXSkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSwKICAgICAgICBhbGw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGMgPSBkb2MuY29va2llLAogICAgICAgICAgICBwcyA9IGMuc3BsaXQoJzsgJyksCiAgICAgICAgICAgIGksIHAsIHIgPSBbXTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBwID0gcHNbaV0uc3BsaXQoJz0nKTsKICAgICAgICAgICAgci5wdXNoKFt1bihwWzBdKSwgdW4ocFsxXSldKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByOwogICAgICAgIH0sCiAgICAgICAgdmVyc2lvbjogJzAuMi4xJywKICAgICAgICBlbmFibGVkOiBmYWxzZQogICAgICB9OwogICAgICBtZS5lbmFibGVkID0gYWxpdmUuY2FsbChtZSk7CiAgICAgIHJldHVybiBtZTsKICAgIH0oKSk7CiAgICB2YXIgaW5kZXhfb2YgPSAoZnVuY3Rpb24oKSB7CiAgICAgIGlmIChBcnJheS5wcm90b3R5cGUuaW5kZXhPZikKICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJ5LCB2YWwpIHsKICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFyeSwgdmFsKTsKICAgICAgICB9OwogICAgICBlbHNlCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFyeSwgdmFsKSB7CiAgICAgICAgICB2YXIgaSwgbDsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBhcnkubGVuZ3RoOyBpIDwgbDsgaSsrKQogICAgICAgICAgICBpZiAoYXJ5W2ldID09IHZhbCkKICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9OwogICAgfSkoKTsKICAgIGVtcHR5ID0gZnVuY3Rpb24oKSB7fTsKICAgIGVzYyA9IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gJ1BTJyArIHN0ci5yZXBsYWNlKC9fL2csICdfXycpLnJlcGxhY2UoLyAvZywgJ19zJyk7CiAgICB9OwogICAgQyA9IHsKICAgICAgc2VhcmNoX29yZGVyOiBbJ2xvY2Fsc3RvcmFnZScsICd3aGF0d2dfZGInLCAnZ2xvYmFsc3RvcmFnZScsICdnZWFycycsICdpZScsICdmbGFzaCcsICdjb29raWUnXSwKICAgICAgbmFtZV9yZTogL15bYS16XVthLXowLTlfIC1dKyQvaSwKICAgICAgbWV0aG9kczogWydpbml0JywgJ2dldCcsICdzZXQnLCAncmVtb3ZlJywgJ2xvYWQnLCAnc2F2ZSddLAogICAgICBzcWw6IHsKICAgICAgICB2ZXJzaW9uOiAnMScsCiAgICAgICAgY3JlYXRlOiAiQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgcGVyc2lzdF9kYXRhIChrIFRFWFQgVU5JUVVFIE5PVCBOVUxMIFBSSU1BUlkgS0VZLCB2IFRFWFQgTk9UIE5VTEwpIiwKICAgICAgICBnZXQ6ICJTRUxFQ1QgdiBGUk9NIHBlcnNpc3RfZGF0YSBXSEVSRSBrID0gPyIsCiAgICAgICAgc2V0OiAiSU5TRVJUIElOVE8gcGVyc2lzdF9kYXRhKGssIHYpIFZBTFVFUyAoPywgPykiLAogICAgICAgIHJlbW92ZTogIkRFTEVURSBGUk9NIHBlcnNpc3RfZGF0YSBXSEVSRSBrID0gPyIKICAgICAgfSwKICAgICAgZmxhc2g6IHsKICAgICAgICBkaXZfaWQ6ICdfcGVyc2lzdF9mbGFzaF93cmFwJywKICAgICAgICBpZDogJ19wZXJzaXN0X2ZsYXNoJywKICAgICAgICBwYXRoOiAncGVyc2lzdC5zd2YnLAogICAgICAgIHNpemU6IHsKICAgICAgICAgIHc6IDEsCiAgICAgICAgICBoOiAxCiAgICAgICAgfSwKICAgICAgICBhcmdzOiB7CiAgICAgICAgICBhdXRvc3RhcnQ6IHRydWUKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBCID0gewogICAgICBnZWFyczogewogICAgICAgIHNpemU6IC0xLAogICAgICAgIHRlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuICh3aW5kb3cuZ29vZ2xlICYmIHdpbmRvdy5nb29nbGUuZ2VhcnMpID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgIH0sCiAgICAgICAgbWV0aG9kczogewogICAgICAgICAgdHJhbnNhY3Rpb246IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIHZhciBkYiA9IHRoaXMuZGI7CiAgICAgICAgICAgIGRiLmV4ZWN1dGUoJ0JFR0lOJykuY2xvc2UoKTsKICAgICAgICAgICAgZm4uY2FsbCh0aGlzLCBkYik7CiAgICAgICAgICAgIGRiLmV4ZWN1dGUoJ0NPTU1JVCcpLmNsb3NlKCk7CiAgICAgICAgICB9LAogICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBkYjsKICAgICAgICAgICAgZGIgPSB0aGlzLmRiID0gZ29vZ2xlLmdlYXJzLmZhY3RvcnkuY3JlYXRlKCdiZXRhLmRhdGFiYXNlJyk7CiAgICAgICAgICAgIGRiLm9wZW4oZXNjKHRoaXMubmFtZSkpOwogICAgICAgICAgICBkYi5leGVjdXRlKEMuc3FsLmNyZWF0ZSkuY2xvc2UoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciByLCBzcWwgPSBDLnNxbC5nZXQ7CiAgICAgICAgICAgIGlmICghZm4pCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uKGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICB2YXIgaXNfdmFsaWQsIHZhbDsKICAgICAgICAgICAgICByID0gdC5leGVjdXRlKHNxbCwgW2tleV0pOwogICAgICAgICAgICAgIGlzX3ZhbGlkID0gci5pc1ZhbGlkUm93KCk7CiAgICAgICAgICAgICAgdmFsID0gaXNfdmFsaWQgPyByLmZpZWxkKDApIDogbnVsbDsKICAgICAgICAgICAgICByLmNsb3NlKCk7CiAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCBpc192YWxpZCwgdmFsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciBybV9zcWwgPSBDLnNxbC5yZW1vdmUsCiAgICAgICAgICAgICAgc3FsID0gQy5zcWwuc2V0LAogICAgICAgICAgICAgIHI7CiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHQuZXhlY3V0ZShybV9zcWwsIFtrZXldKS5jbG9zZSgpOwogICAgICAgICAgICAgIHQuZXhlY3V0ZShzcWwsIFtrZXksIHZhbF0pLmNsb3NlKCk7CiAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciBnZXRfc3FsID0gQy5zcWwuZ2V0OwogICAgICAgICAgICBzcWwgPSBDLnNxbC5yZW1vdmUsIHIsIHZhbCA9IG51bGwsIGlzX3ZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICAgICAgciA9IHQuZXhlY3V0ZShnZXRfc3FsLCBba2V5XSk7CiAgICAgICAgICAgICAgICBpc192YWxpZCA9IHIuaXNWYWxpZFJvdygpOwogICAgICAgICAgICAgICAgdmFsID0gaXNfdmFsaWQgPyByLmZpZWxkKDApIDogbnVsbDsKICAgICAgICAgICAgICAgIHIuY2xvc2UoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFmbiB8fCBpc192YWxpZCkgewogICAgICAgICAgICAgICAgdC5leGVjdXRlKHNxbCwgW2tleV0pLmNsb3NlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgaXNfdmFsaWQsIHZhbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgd2hhdHdnX2RiOiB7CiAgICAgICAgc2l6ZTogMjAwICogMTAyNCwKICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gJ1BlcnNpc3RKUyBUZXN0JywKICAgICAgICAgICAgICBkZXNjID0gJ1BlcnNpc3RlbnQgZGF0YWJhc2UgdGVzdC4nOwogICAgICAgICAgICBpZiAoIXdpbmRvdy5vcGVuRGF0YWJhc2UpCiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAoIXdpbmRvdy5vcGVuRGF0YWJhc2UobmFtZSwgQy5zcWwudmVyc2lvbiwgZGVzYywgQi53aGF0d2dfZGIuc2l6ZSkpCiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQoKICAgICAgICB9LAogICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgIHRyYW5zYWN0aW9uOiBmdW5jdGlvbihmbikgewogICAgICAgICAgICBpZiAoIXRoaXMuZGJfY3JlYXRlZCkgewogICAgICAgICAgICAgIHRoaXMuZGIudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKEMuc3FsLmNyZWF0ZSwgW10sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aGlzLmRiX2NyZWF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSwgZW1wdHkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZGIudHJhbnNhY3Rpb24oZm4pOwogICAgICAgICAgfSwKICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmRiID0gb3BlbkRhdGFiYXNlKHRoaXMubmFtZSwgQy5zcWwudmVyc2lvbiwgdGhpcy5vLmFib3V0IHx8ICgiUGVyc2lzdGVudCBzdG9yYWdlIGZvciAiICsgdGhpcy5uYW1lKSwgdGhpcy5vLnNpemUgfHwgQi53aGF0d2dfZGIuc2l6ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICB2YXIgc3FsID0gQy5zcWwuZ2V0OwogICAgICAgICAgICBpZiAoIWZuKQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgc2NvcGUgPSBzY29wZSB8fCB0aGlzOwogICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uKGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICB0LmV4ZWN1dGVTcWwoc3FsLCBba2V5XSwgZnVuY3Rpb24odCwgcikgewogICAgICAgICAgICAgICAgaWYgKHIucm93cy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlLCB0cnVlLCByLnJvd3MuaXRlbSgwKVsndiddKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSwgZmFsc2UsIG51bGwpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHJtX3NxbCA9IEMuc3FsLnJlbW92ZSwKICAgICAgICAgICAgICBzcWwgPSBDLnNxbC5zZXQ7CiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHQuZXhlY3V0ZVNxbChybV9zcWwsIFtrZXldLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHQuZXhlY3V0ZVNxbChzcWwsIFtrZXksIHZhbF0sIGZ1bmN0aW9uKHQsIHIpIHsKICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciBnZXRfc3FsID0gQy5zcWwuZ2V0OwogICAgICAgICAgICBzcWwgPSBDLnNxbC5yZW1vdmU7CiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKGdldF9zcWwsIFtrZXldLCBmdW5jdGlvbih0LCByKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyLnJvd3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciB2YWwgPSByLnJvd3MuaXRlbSgwKVsndiddOwogICAgICAgICAgICAgICAgICAgIHQuZXhlY3V0ZVNxbChzcWwsIFtrZXldLCBmdW5jdGlvbih0LCByKSB7CiAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0LmV4ZWN1dGVTcWwoc3FsLCBba2V5XSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdsb2JhbHN0b3JhZ2U6IHsKICAgICAgICBzaXplOiA1ICogMTAyNCAqIDEwMjQsCiAgICAgICAgdGVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gd2luZG93Lmdsb2JhbFN0b3JhZ2UgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgIGtleTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBlc2ModGhpcy5uYW1lKSArIGVzYyhrZXkpOwogICAgICAgICAgfSwKICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBhbGVydCgnZG9tYWluID0gJyArIHRoaXMuby5kb21haW4pOwogICAgICAgICAgICB0aGlzLnN0b3JlID0gZ2xvYmFsU3RvcmFnZVt0aGlzLm8uZG9tYWluXTsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIGtleSA9IHRoaXMua2V5KGtleSk7CiAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHRoaXMuc3RvcmUuZ2V0SXRlbShrZXkpKTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgdGhpcy5zdG9yZS5zZXRJdGVtKGtleSwgdmFsKTsKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgIGtleSA9IHRoaXMua2V5KGtleSk7CiAgICAgICAgICAgIHZhbCA9IHRoaXMuc3RvcmVba2V5XTsKICAgICAgICAgICAgdGhpcy5zdG9yZS5yZW1vdmVJdGVtKGtleSk7CiAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsICh2YWwgIT09IG51bGwpLCB2YWwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgbG9jYWxzdG9yYWdlOiB7CiAgICAgICAgc2l6ZTogLTEsCiAgICAgICAgdGVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gd2luZG93LmxvY2FsU3RvcmFnZSA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQoKICAgICAgICB9LAogICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgIGtleTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBlc2ModGhpcy5uYW1lKSArIGVzYyhrZXkpOwogICAgICAgICAgfSwKICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnN0b3JlID0gbG9jYWxTdG9yYWdlOwogICAgICAgICAgfSwKICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdGhpcy5zdG9yZS5nZXRJdGVtKGtleSkpOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIGZuLCBzY29wZSkgewogICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICB0aGlzLnN0b3JlLnNldEl0ZW0oa2V5LCB2YWwpOwogICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgfSwKICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgdmFsID0gdGhpcy5zdG9yZS5nZXRJdGVtKGtleSk7CiAgICAgICAgICAgIHRoaXMuc3RvcmUucmVtb3ZlSXRlbShrZXkpOwogICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCAodmFsICE9PSBudWxsKSwgdmFsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGllOiB7CiAgICAgICAgcHJlZml4OiAnX3BlcnNpc3RfZGF0YS0nLAogICAgICAgIHNpemU6IDY0ICogMTAyNCwKICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiB3aW5kb3cuQWN0aXZlWE9iamVjdCA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQoKICAgICAgICB9LAogICAgICAgIG1ha2VfdXNlcmRhdGE6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgIGVsLmlkID0gaWQ7CiAgICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgZWwuYWRkQmVoYXZpb3IoJyNkZWZhdWx0I3VzZXJkYXRhJyk7CiAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGVsKTsKICAgICAgICAgIHJldHVybiBlbDsKICAgICAgICB9LAogICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaWQgPSBCLmllLnByZWZpeCArIGVzYyh0aGlzLm5hbWUpOwogICAgICAgICAgICB0aGlzLmVsID0gQi5pZS5tYWtlX3VzZXJkYXRhKGlkKTsKICAgICAgICAgICAgaWYgKHRoaXMuby5kZWZlcikKICAgICAgICAgICAgICB0aGlzLmxvYWQoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICBpZiAoIXRoaXMuby5kZWZlcikKICAgICAgICAgICAgICB0aGlzLmxvYWQoKTsKICAgICAgICAgICAgdmFsID0gdGhpcy5lbC5nZXRBdHRyaWJ1dGUoa2V5KTsKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdmFsID8gdHJ1ZSA6IGZhbHNlLCB2YWwpOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIGZuLCBzY29wZSkgewogICAgICAgICAgICBrZXkgPSBlc2Moa2V5KTsKICAgICAgICAgICAgdGhpcy5lbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWwpOwogICAgICAgICAgICBpZiAoIXRoaXMuby5kZWZlcikKICAgICAgICAgICAgICB0aGlzLnNhdmUoKTsKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICBpZiAoIXRoaXMuby5kZWZlcikKICAgICAgICAgICAgICB0aGlzLmxvYWQoKTsKICAgICAgICAgICAgdmFsID0gdGhpcy5lbC5nZXRBdHRyaWJ1dGUoa2V5KTsKICAgICAgICAgICAgdGhpcy5lbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgICAgICAgICAgaWYgKCF0aGlzLm8uZGVmZXIpCiAgICAgICAgICAgICAgdGhpcy5zYXZlKCk7CiAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHZhbCA/IHRydWUgOiBmYWxzZSwgdmFsKTsKICAgICAgICAgIH0sCiAgICAgICAgICBsb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5lbC5sb2FkKGVzYyh0aGlzLm5hbWUpKTsKICAgICAgICAgIH0sCiAgICAgICAgICBzYXZlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5lbC5zYXZlKGVzYyh0aGlzLm5hbWUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvb2tpZTogewogICAgICAgIGRlbGltOiAnOicsCiAgICAgICAgc2l6ZTogNDAwMCwKICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBQLkNvb2tpZS5lbmFibGVkID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgIH0sCiAgICAgICAgbWV0aG9kczogewogICAgICAgICAga2V5OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubmFtZSArIEIuY29va2llLmRlbGltICsga2V5OwogICAgICAgICAgfSwKICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgdmFsID0gZWMuZ2V0KGtleSk7CiAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHZhbCAhPSBudWxsLCB2YWwpOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIGZuLCBzY29wZSkgewogICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICBlYy5zZXQoa2V5LCB2YWwsIHRoaXMubyk7CiAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgIGtleSA9IHRoaXMua2V5KGtleSk7CiAgICAgICAgICAgIHZhbCA9IGVjLnJlbW92ZShrZXkpCiAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHZhbCAhPSBudWxsLCB2YWwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgZmxhc2g6IHsKICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmICghZGVjb25jZXB0IHx8ICFkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbCkKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHZhciBtYWpvciA9IGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsLmdldFBsYXllclZlcnNpb24oKS5tYWpvcjsKICAgICAgICAgICAgcmV0dXJuIChtYWpvciA+PSA4KSA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQoKICAgICAgICB9LAogICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIUIuZmxhc2guZWwpIHsKICAgICAgICAgICAgICB2YXIgbywga2V5LCBlbCwgY2ZnID0gQy5mbGFzaDsKICAgICAgICAgICAgICBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgIGVsLmlkID0gY2ZnLmRpdl9pZDsKICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGVsKTsKICAgICAgICAgICAgICBvID0gbmV3IGRlY29uY2VwdC5TV0ZPYmplY3QodGhpcy5vLnN3Zl9wYXRoIHx8IGNmZy5wYXRoLCBjZmcuaWQsIGNmZy5zaXplLncsIGNmZy5zaXplLmgsICc4Jyk7CiAgICAgICAgICAgICAgZm9yIChrZXkgaW4gY2ZnLmFyZ3MpCiAgICAgICAgICAgICAgICBvLmFkZFZhcmlhYmxlKGtleSwgY2ZnLmFyZ3Nba2V5XSk7CiAgICAgICAgICAgICAgby53cml0ZShlbCk7CiAgICAgICAgICAgICAgQi5mbGFzaC5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNmZy5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5lbCA9IEIuZmxhc2guZWw7CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICB2YXIgdmFsOwogICAgICAgICAgICBrZXkgPSBlc2Moa2V5KTsKICAgICAgICAgICAgdmFsID0gdGhpcy5lbC5nZXQodGhpcy5uYW1lLCBrZXkpOwogICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB2YWwgIT09IG51bGwsIHZhbCk7CiAgICAgICAgICB9LAogICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciBvbGRfdmFsOwogICAgICAgICAgICBrZXkgPSBlc2Moa2V5KTsKICAgICAgICAgICAgb2xkX3ZhbCA9IHRoaXMuZWwuc2V0KHRoaXMubmFtZSwga2V5LCB2YWwpOwogICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgfSwKICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAga2V5ID0gZXNjKGtleSk7CiAgICAgICAgICAgIHZhbCA9IHRoaXMuZWwucmVtb3ZlKHRoaXMubmFtZSwga2V5KTsKICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaSwgbCwgYiwga2V5LCBmbnMgPSBDLm1ldGhvZHMsCiAgICAgICAga2V5cyA9IEMuc2VhcmNoX29yZGVyOwogICAgICBmb3IgKGkgPSAwLCBsID0gZm5zLmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgICBQLlN0b3JlLnByb3RvdHlwZVtmbnNbaV1dID0gZW1wdHk7CiAgICAgIFAudHlwZSA9IG51bGw7CiAgICAgIFAuc2l6ZSA9IC0xOwogICAgICBmb3IgKGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7ICFQLnR5cGUgJiYgaSA8IGw7IGkrKykgewogICAgICAgIGIgPSBCW2tleXNbaV1dOwogICAgICAgIGlmIChiLnRlc3QoKSkgewogICAgICAgICAgUC50eXBlID0ga2V5c1tpXTsKICAgICAgICAgIFAuc2l6ZSA9IGIuc2l6ZTsKICAgICAgICAgIGZvciAoa2V5IGluIGIubWV0aG9kcykKICAgICAgICAgICAgUC5TdG9yZS5wcm90b3R5cGVba2V5XSA9IGIubWV0aG9kc1trZXldOwogICAgICAgIH0KICAgICAgfQogICAgICBQLl9pbml0ID0gdHJ1ZTsKICAgIH07CiAgICBQID0gewogICAgICBWRVJTSU9OOiBWRVJTSU9OLAogICAgICB0eXBlOiBudWxsLAogICAgICBzaXplOiAwLAogICAgICBhZGQ6IGZ1bmN0aW9uKG8pIHsKICAgICAgICBCW28uaWRdID0gbzsKICAgICAgICBDLnNlYXJjaF9vcmRlciA9IFtvLmlkXS5jb25jYXQoQy5zZWFyY2hfb3JkZXIpOwogICAgICAgIGluaXQoKTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihpZCkgewogICAgICAgIHZhciBvZnMgPSBpbmRleF9vZihDLnNlYXJjaF9vcmRlciwgaWQpOwogICAgICAgIGlmIChvZnMgPCAwKQogICAgICAgICAgcmV0dXJuOwogICAgICAgIEMuc2VhcmNoX29yZGVyLnNwbGljZShvZnMsIDEpOwogICAgICAgIGRlbGV0ZSBCW2lkXTsKICAgICAgICBpbml0KCk7CiAgICAgIH0sCiAgICAgIENvb2tpZTogZWMsCiAgICAgIFN0b3JlOiBmdW5jdGlvbihuYW1lLCBvKSB7CiAgICAgICAgaWYgKCFDLm5hbWVfcmUuZXhlYyhuYW1lKSkKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBuYW1lIik7CiAgICAgICAgaWYgKCFQLnR5cGUpCiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vIHN1aXRhYmxlIHN0b3JhZ2UgZm91bmQiKTsKICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgIG8uZG9tYWluID0gby5kb21haW4gfHwgbG9jYXRpb24uaG9zdCB8fCAnbG9jYWxob3N0JzsKICAgICAgICBvLmRvbWFpbiA9IG8uZG9tYWluLnJlcGxhY2UoLzpcZCskLywgJycpCiAgICAgICAgdGhpcy5vID0gbzsKICAgICAgICBvLmV4cGlyZXMgPSBvLmV4cGlyZXMgfHwgMzY1ICogMjsKICAgICAgICBvLnBhdGggPSBvLnBhdGggfHwgJy8nOwogICAgICAgIHRoaXMuaW5pdCgpOwogICAgICB9CiAgICB9OwogICAgaW5pdCgpOwogICAgcmV0dXJuIFA7CiAgfSkoKTsKICAvL3BlcnNpc3QtbWluIGVuZAoKICAvL3N3Zm9iamVjdC1taW4gc3RhcnQKCiAgaWYgKHR5cGVvZiBkZWNvbmNlcHQgPT0gInVuZGVmaW5lZCIpIHZhciBkZWNvbmNlcHQgPSBuZXcgT2JqZWN0KCk7CiAgaWYgKHR5cGVvZiBkZWNvbmNlcHQudXRpbCA9PSAidW5kZWZpbmVkIikgZGVjb25jZXB0LnV0aWwgPSBuZXcgT2JqZWN0KCk7CiAgaWYgKHR5cGVvZiBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbCA9PSAidW5kZWZpbmVkIikgZGVjb25jZXB0LlNXRk9iamVjdFV0aWwgPSBuZXcgT2JqZWN0KCk7CiAgZGVjb25jZXB0LlNXRk9iamVjdCA9IGZ1bmN0aW9uKHN3ZiwgaWQsIHcsIGgsIHZlciwgYywgcXVhbGl0eSwgeGlSZWRpcmVjdFVybCwgcmVkaXJlY3RVcmwsIGRldGVjdEtleSkgewogICAgaWYgKCFkb2N1bWVudC5nZXRFbGVtZW50QnlJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLkRFVEVDVF9LRVkgPSBkZXRlY3RLZXkgPyBkZXRlY3RLZXkgOiAnZGV0ZWN0Zmxhc2gnOwogICAgdGhpcy5za2lwRGV0ZWN0ID0gZGVjb25jZXB0LnV0aWwuZ2V0UmVxdWVzdFBhcmFtZXRlcih0aGlzLkRFVEVDVF9LRVkpOwogICAgdGhpcy5wYXJhbXMgPSBuZXcgT2JqZWN0KCk7CiAgICB0aGlzLnZhcmlhYmxlcyA9IG5ldyBPYmplY3QoKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IG5ldyBBcnJheSgpOwogICAgaWYgKHN3ZikgewogICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnc3dmJywgc3dmKTsKICAgIH0KICAgIGlmIChpZCkgewogICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnaWQnLCBpZCk7CiAgICB9CiAgICBpZiAodykgewogICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnd2lkdGgnLCB3KTsKICAgIH0KICAgIGlmIChoKSB7CiAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdoZWlnaHQnLCBoKTsKICAgIH0KICAgIGlmICh2ZXIpIHsKICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3ZlcnNpb24nLCBuZXcgZGVjb25jZXB0LlBsYXllclZlcnNpb24odmVyLnRvU3RyaW5nKCkuc3BsaXQoIi4iKSkpOwogICAgfQogICAgdGhpcy5pbnN0YWxsZWRWZXIgPSBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbC5nZXRQbGF5ZXJWZXJzaW9uKCk7CiAgICBpZiAoIXdpbmRvdy5vcGVyYSAmJiBkb2N1bWVudC5hbGwgJiYgdGhpcy5pbnN0YWxsZWRWZXIubWFqb3IgPiA3KSB7CiAgICAgIGRlY29uY2VwdC5TV0ZPYmplY3QuZG9QcmVwVW5sb2FkID0gdHJ1ZTsKICAgIH0KICAgIGlmIChjKSB7CiAgICAgIHRoaXMuYWRkUGFyYW0oJ2JnY29sb3InLCBjKTsKICAgIH0KICAgIHZhciBxID0gcXVhbGl0eSA/IHF1YWxpdHkgOiAnaGlnaCc7CiAgICB0aGlzLmFkZFBhcmFtKCdxdWFsaXR5JywgcSk7CiAgICB0aGlzLnNldEF0dHJpYnV0ZSgndXNlRXhwcmVzc0luc3RhbGwnLCBmYWxzZSk7CiAgICB0aGlzLnNldEF0dHJpYnV0ZSgnZG9FeHByZXNzSW5zdGFsbCcsIGZhbHNlKTsKICAgIHZhciB4aXIgPSAoeGlSZWRpcmVjdFVybCkgPyB4aVJlZGlyZWN0VXJsIDogd2luZG93LmxvY2F0aW9uOwogICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3hpUmVkaXJlY3RVcmwnLCB4aXIpOwogICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3JlZGlyZWN0VXJsJywgJycpOwogICAgaWYgKHJlZGlyZWN0VXJsKSB7CiAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdyZWRpcmVjdFVybCcsIHJlZGlyZWN0VXJsKTsKICAgIH0KICB9CiAgZGVjb25jZXB0LlNXRk9iamVjdC5wcm90b3R5cGUgPSB7CiAgICB1c2VFeHByZXNzSW5zdGFsbDogZnVuY3Rpb24ocGF0aCkgewogICAgICB0aGlzLnhpU1dGUGF0aCA9ICFwYXRoID8gImV4cHJlc3NpbnN0YWxsLnN3ZiIgOiBwYXRoOwogICAgICB0aGlzLnNldEF0dHJpYnV0ZSgndXNlRXhwcmVzc0luc3RhbGwnLCB0cnVlKTsKICAgIH0sCiAgICBzZXRBdHRyaWJ1dGU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMuYXR0cmlidXRlc1tuYW1lXSA9IHZhbHVlOwogICAgfSwKICAgIGdldEF0dHJpYnV0ZTogZnVuY3Rpb24obmFtZSkgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW25hbWVdOwogICAgfSwKICAgIGFkZFBhcmFtOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICB0aGlzLnBhcmFtc1tuYW1lXSA9IHZhbHVlOwogICAgfSwKICAgIGdldFBhcmFtczogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnBhcmFtczsKICAgIH0sCiAgICBhZGRWYXJpYWJsZTogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgdGhpcy52YXJpYWJsZXNbbmFtZV0gPSB2YWx1ZTsKICAgIH0sCiAgICBnZXRWYXJpYWJsZTogZnVuY3Rpb24obmFtZSkgewogICAgICByZXR1cm4gdGhpcy52YXJpYWJsZXNbbmFtZV07CiAgICB9LAogICAgZ2V0VmFyaWFibGVzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMudmFyaWFibGVzOwogICAgfSwKICAgIGdldFZhcmlhYmxlUGFpcnM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFyaWFibGVQYWlycyA9IG5ldyBBcnJheSgpOwogICAgICB2YXIga2V5OwogICAgICB2YXIgdmFyaWFibGVzID0gdGhpcy5nZXRWYXJpYWJsZXMoKTsKICAgICAgZm9yIChrZXkgaW4gdmFyaWFibGVzKSB7CiAgICAgICAgdmFyaWFibGVQYWlycy5wdXNoKGtleSArICI9IiArIHZhcmlhYmxlc1trZXldKTsKICAgICAgfQogICAgICByZXR1cm4gdmFyaWFibGVQYWlyczsKICAgIH0sCiAgICBnZXRTV0ZIVE1MOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHN3Zk5vZGUgPSAiIjsKICAgICAgaWYgKG5hdmlnYXRvci5wbHVnaW5zICYmIG5hdmlnYXRvci5taW1lVHlwZXMgJiYgbmF2aWdhdG9yLm1pbWVUeXBlcy5sZW5ndGgpIHsKICAgICAgICBpZiAodGhpcy5nZXRBdHRyaWJ1dGUoImRvRXhwcmVzc0luc3RhbGwiKSkgewogICAgICAgICAgdGhpcy5hZGRWYXJpYWJsZSgiTU1wbGF5ZXJUeXBlIiwgIlBsdWdJbiIpOwogICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3N3ZicsIHRoaXMueGlTV0ZQYXRoKTsKICAgICAgICB9CiAgICAgICAgc3dmTm9kZSA9ICc8ZW1iZWQgdHlwZT0iYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2giIHNyYz0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCdzd2YnKSArICciIHdpZHRoPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ3dpZHRoJykgKyAnIiBoZWlnaHQ9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnaGVpZ2h0JykgKyAnIic7CiAgICAgICAgc3dmTm9kZSArPSAnIGlkPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ2lkJykgKyAnIiBuYW1lPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ2lkJykgKyAnIiAnOwogICAgICAgIHZhciBwYXJhbXMgPSB0aGlzLmdldFBhcmFtcygpOwogICAgICAgIGZvciAodmFyIGtleSBpbiBwYXJhbXMpIHsKICAgICAgICAgIHN3Zk5vZGUgKz0gW2tleV0gKyAnPSInICsgcGFyYW1zW2tleV0gKyAnIiAnOwogICAgICAgIH0KICAgICAgICB2YXIgcGFpcnMgPSB0aGlzLmdldFZhcmlhYmxlUGFpcnMoKS5qb2luKCImIik7CiAgICAgICAgaWYgKHBhaXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHN3Zk5vZGUgKz0gJ2ZsYXNodmFycz0iJyArIHBhaXJzICsgJyInOwogICAgICAgIH0KICAgICAgICBzd2ZOb2RlICs9ICcvPic7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRoaXMuZ2V0QXR0cmlidXRlKCJkb0V4cHJlc3NJbnN0YWxsIikpIHsKICAgICAgICAgIHRoaXMuYWRkVmFyaWFibGUoIk1NcGxheWVyVHlwZSIsICJBY3RpdmVYIik7CiAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnc3dmJywgdGhpcy54aVNXRlBhdGgpOwogICAgICAgIH0KICAgICAgICBzd2ZOb2RlID0gJzxvYmplY3QgaWQ9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnaWQnKSArICciIGNsYXNzaWQ9ImNsc2lkOkQyN0NEQjZFLUFFNkQtMTFjZi05NkI4LTQ0NDU1MzU0MDAwMCIgd2lkdGg9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSArICciIGhlaWdodD0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCdoZWlnaHQnKSArICciPic7CiAgICAgICAgc3dmTm9kZSArPSAnPHBhcmFtIG5hbWU9Im1vdmllIiB2YWx1ZT0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCdzd2YnKSArICciIC8+JzsKICAgICAgICB2YXIgcGFyYW1zID0gdGhpcy5nZXRQYXJhbXMoKTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gcGFyYW1zKSB7CiAgICAgICAgICBzd2ZOb2RlICs9ICc8cGFyYW0gbmFtZT0iJyArIGtleSArICciIHZhbHVlPSInICsgcGFyYW1zW2tleV0gKyAnIiAvPic7CiAgICAgICAgfQogICAgICAgIHZhciBwYWlycyA9IHRoaXMuZ2V0VmFyaWFibGVQYWlycygpLmpvaW4oIiYiKTsKICAgICAgICBpZiAocGFpcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgc3dmTm9kZSArPSAnPHBhcmFtIG5hbWU9ImZsYXNodmFycyIgdmFsdWU9IicgKyBwYWlycyArICciIC8+JzsKICAgICAgICB9CiAgICAgICAgc3dmTm9kZSArPSAiPC9vYmplY3Q+IjsKICAgICAgfQogICAgICByZXR1cm4gc3dmTm9kZTsKICAgIH0sCiAgICB3cml0ZTogZnVuY3Rpb24oZWxlbWVudElkKSB7CiAgICAgIGlmICh0aGlzLmdldEF0dHJpYnV0ZSgndXNlRXhwcmVzc0luc3RhbGwnKSkgewogICAgICAgIHZhciBleHByZXNzSW5zdGFsbFJlcVZlciA9IG5ldyBkZWNvbmNlcHQuUGxheWVyVmVyc2lvbihbNiwgMCwgNjVdKTsKICAgICAgICBpZiAodGhpcy5pbnN0YWxsZWRWZXIudmVyc2lvbklzVmFsaWQoZXhwcmVzc0luc3RhbGxSZXFWZXIpICYmICF0aGlzLmluc3RhbGxlZFZlci52ZXJzaW9uSXNWYWxpZCh0aGlzLmdldEF0dHJpYnV0ZSgndmVyc2lvbicpKSkgewogICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ2RvRXhwcmVzc0luc3RhbGwnLCB0cnVlKTsKICAgICAgICAgIHRoaXMuYWRkVmFyaWFibGUoIk1NcmVkaXJlY3RVUkwiLCBlc2NhcGUodGhpcy5nZXRBdHRyaWJ1dGUoJ3hpUmVkaXJlY3RVcmwnKSkpOwogICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSBkb2N1bWVudC50aXRsZS5zbGljZSgwLCA0NykgKyAiIC0gRmxhc2ggUGxheWVyIEluc3RhbGxhdGlvbiI7CiAgICAgICAgICB0aGlzLmFkZFZhcmlhYmxlKCJNTWRvY3RpdGxlIiwgZG9jdW1lbnQudGl0bGUpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodGhpcy5za2lwRGV0ZWN0IHx8IHRoaXMuZ2V0QXR0cmlidXRlKCdkb0V4cHJlc3NJbnN0YWxsJykgfHwgdGhpcy5pbnN0YWxsZWRWZXIudmVyc2lvbklzVmFsaWQodGhpcy5nZXRBdHRyaWJ1dGUoJ3ZlcnNpb24nKSkpIHsKICAgICAgICB2YXIgbiA9ICh0eXBlb2YgZWxlbWVudElkID09ICdzdHJpbmcnKSA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsZW1lbnRJZCkgOiBlbGVtZW50SWQ7CiAgICAgICAgbi5pbm5lckhUTUwgPSB0aGlzLmdldFNXRkhUTUwoKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5nZXRBdHRyaWJ1dGUoJ3JlZGlyZWN0VXJsJykgIT0gIiIpIHsKICAgICAgICAgIGRvY3VtZW50LmxvY2F0aW9uLnJlcGxhY2UodGhpcy5nZXRBdHRyaWJ1dGUoJ3JlZGlyZWN0VXJsJykpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsLmdldFBsYXllclZlcnNpb24gPSBmdW5jdGlvbigpIHsKICAgIHZhciBQbGF5ZXJWZXJzaW9uID0gbmV3IGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uKFswLCAwLCAwXSk7CiAgICBpZiAobmF2aWdhdG9yLnBsdWdpbnMgJiYgbmF2aWdhdG9yLm1pbWVUeXBlcy5sZW5ndGgpIHsKICAgICAgdmFyIHggPSBuYXZpZ2F0b3IucGx1Z2luc1siU2hvY2t3YXZlIEZsYXNoIl07CiAgICAgIGlmICh4ICYmIHguZGVzY3JpcHRpb24pIHsKICAgICAgICBQbGF5ZXJWZXJzaW9uID0gbmV3IGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uKHguZGVzY3JpcHRpb24ucmVwbGFjZSgvKFthLXpBLVpdfFxzKSsvLCAiIikucmVwbGFjZSgvKFxzK3J8XHMrYlswLTldKykvLCAiLiIpLnNwbGl0KCIuIikpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0cnkgewogICAgICAgIHZhciBheG8gPSBuZXcgQWN0aXZlWE9iamVjdCgiU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2guNyIpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBheG8gPSBuZXcgQWN0aXZlWE9iamVjdCgiU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2guNiIpOwogICAgICAgICAgUGxheWVyVmVyc2lvbiA9IG5ldyBkZWNvbmNlcHQuUGxheWVyVmVyc2lvbihbNiwgMCwgMjFdKTsKICAgICAgICAgIGF4by5BbGxvd1NjcmlwdEFjY2VzcyA9ICJhbHdheXMiOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGlmIChQbGF5ZXJWZXJzaW9uLm1ham9yID09IDYpIHsKICAgICAgICAgICAgcmV0dXJuIFBsYXllclZlcnNpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICBheG8gPSBuZXcgQWN0aXZlWE9iamVjdCgiU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2giKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICB9CiAgICAgIGlmIChheG8gIT0gbnVsbCkgewogICAgICAgIFBsYXllclZlcnNpb24gPSBuZXcgZGVjb25jZXB0LlBsYXllclZlcnNpb24oYXhvLkdldFZhcmlhYmxlKCIkdmVyc2lvbiIpLnNwbGl0KCIgIilbMV0uc3BsaXQoIiwiKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBQbGF5ZXJWZXJzaW9uOwogIH0KICBkZWNvbmNlcHQuUGxheWVyVmVyc2lvbiA9IGZ1bmN0aW9uKGFyclZlcnNpb24pIHsKICAgIHRoaXMubWFqb3IgPSBhcnJWZXJzaW9uWzBdICE9IG51bGwgPyBwYXJzZUludChhcnJWZXJzaW9uWzBdKSA6IDA7CiAgICB0aGlzLm1pbm9yID0gYXJyVmVyc2lvblsxXSAhPSBudWxsID8gcGFyc2VJbnQoYXJyVmVyc2lvblsxXSkgOiAwOwogICAgdGhpcy5yZXYgPSBhcnJWZXJzaW9uWzJdICE9IG51bGwgPyBwYXJzZUludChhcnJWZXJzaW9uWzJdKSA6IDA7CiAgfQogIGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uLnByb3RvdHlwZS52ZXJzaW9uSXNWYWxpZCA9IGZ1bmN0aW9uKGZ2KSB7CiAgICBpZiAodGhpcy5tYWpvciA8IGZ2Lm1ham9yKSByZXR1cm4gZmFsc2U7CiAgICBpZiAodGhpcy5tYWpvciA+IGZ2Lm1ham9yKSByZXR1cm4gdHJ1ZTsKICAgIGlmICh0aGlzLm1pbm9yIDwgZnYubWlub3IpIHJldHVybiBmYWxzZTsKICAgIGlmICh0aGlzLm1pbm9yID4gZnYubWlub3IpIHJldHVybiB0cnVlOwogICAgaWYgKHRoaXMucmV2IDwgZnYucmV2KSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZGVjb25jZXB0LnV0aWwgPSB7CiAgICBnZXRSZXF1ZXN0UGFyYW1ldGVyOiBmdW5jdGlvbihwYXJhbSkgewogICAgICB2YXIgcSA9IGRvY3VtZW50LmxvY2F0aW9uLnNlYXJjaCB8fCBkb2N1bWVudC5sb2NhdGlvbi5oYXNoOwogICAgICBpZiAocSkgewogICAgICAgIHZhciBwYWlycyA9IHEuc3Vic3RyaW5nKDEpLnNwbGl0KCImIik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYWlycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHBhaXJzW2ldLnN1YnN0cmluZygwLCBwYWlyc1tpXS5pbmRleE9mKCI9IikpID09IHBhcmFtKSB7CiAgICAgICAgICAgIHJldHVybiBwYWlyc1tpXS5zdWJzdHJpbmcoKHBhaXJzW2ldLmluZGV4T2YoIj0iKSArIDEpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuICIiOwogICAgfQogIH0KICBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbC5jbGVhbnVwU1dGcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIG9iamVjdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiT0JKRUNUIik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iamVjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgb2JqZWN0c1tpXS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICBmb3IgKHZhciB4IGluIG9iamVjdHNbaV0pIHsKICAgICAgICBpZiAodHlwZW9mIG9iamVjdHNbaV1beF0gPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgb2JqZWN0c1tpXVt4XSA9IGZ1bmN0aW9uKCkge307CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGlmIChkZWNvbmNlcHQuU1dGT2JqZWN0LmRvUHJlcFVubG9hZCkgewogICAgZGVjb25jZXB0LlNXRk9iamVjdFV0aWwucHJlcFVubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICBfX2ZsYXNoX3VubG9hZEhhbmRsZXIgPSBmdW5jdGlvbigpIHt9OwogICAgICBfX2ZsYXNoX3NhdmVkVW5sb2FkSGFuZGxlciA9IGZ1bmN0aW9uKCkge307CiAgICAgIHdpbmRvdy5hdHRhY2hFdmVudCgib251bmxvYWQiLCBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbC5jbGVhbnVwU1dGcyk7CiAgICB9CiAgICB3aW5kb3cuYXR0YWNoRXZlbnQoIm9uYmVmb3JldW5sb2FkIiwgZGVjb25jZXB0LlNXRk9iamVjdFV0aWwucHJlcFVubG9hZCk7CiAgfQogIGlmIChBcnJheS5wcm90b3R5cGUucHVzaCA9PSBudWxsKSB7CiAgICBBcnJheS5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpc1t0aGlzLmxlbmd0aF0gPSBpdGVtOwogICAgICByZXR1cm4gdGhpcy5sZW5ndGg7CiAgICB9CiAgfQogIHZhciBnZXRRdWVyeVBhcmFtVmFsdWUgPSBkZWNvbmNlcHQudXRpbC5nZXRSZXF1ZXN0UGFyYW1ldGVyOwogIHZhciBGbGFzaE9iamVjdCA9IGRlY29uY2VwdC5TV0ZPYmplY3Q7CiAgdmFyIFNXRk9iamVjdCA9IGRlY29uY2VwdC5TV0ZPYmplY3Q7CiAgLy9zd2ZvYmplY3QtbWluIGVuZAoKICAvLyEhIWxpYiBlbmQhISEKCiAgdmFyICRmaCA9IHJvb3QuJGZoIHx8IHt9OwogIGlmICh0eXBlb2YgZmhfYXBwX3Byb3BzID09PSAib2JqZWN0IikgewogICAgJGZoLmFwcF9wcm9wcyA9IGZoX2FwcF9wcm9wczsKICB9CgogICRmaC5sZWdhY3kgPSB7fTsKCiAgdmFyIGRlZmF1bHRhcmdzID0gewogICAgc3VjY2VzczogZnVuY3Rpb24oKSB7fSwKICAgIGZhaWx1cmU6IGZ1bmN0aW9uKCkge30sCiAgICBwYXJhbXM6IHt9CiAgfTsKCiAgdmFyIGhhbmRsZWFyZ3MgPSBmdW5jdGlvbihpbmFyZ3MsIGRlZmF1bHRwYXJhbXMsIGFwcGx5dG8pIHsKICAgIHZhciBvdXRhcmdzID0gW251bGwsIG51bGwsIG51bGxdOwogICAgdmFyIG9yaWdhcmdzID0gW251bGwsIG51bGwsIG51bGxdOwogICAgdmFyIG51bWFyZ3MgPSBpbmFyZ3MubGVuZ3RoOwoKICAgIGlmICgyIDwgbnVtYXJncykgewogICAgICBvcmlnYXJnc1swXSA9IGluYXJnc1tudW1hcmdzIC0gM107CiAgICAgIG9yaWdhcmdzWzFdID0gaW5hcmdzW251bWFyZ3MgLSAyXTsKICAgICAgb3JpZ2FyZ3NbMl0gPSBpbmFyZ3NbbnVtYXJncyAtIDFdOwogICAgfSBlbHNlIGlmICgyID09IG51bWFyZ3MpIHsKICAgICAgb3JpZ2FyZ3NbMV0gPSBpbmFyZ3NbMF07CiAgICAgIG9yaWdhcmdzWzJdID0gaW5hcmdzWzFdOwogICAgfSBlbHNlIGlmICgxID09IG51bWFyZ3MpIHsKICAgICAgb3JpZ2FyZ3NbMl0gPSBpbmFyZ3NbMF07CiAgICB9CgogICAgdmFyIGkgPSAwLAogICAgICBqID0gMDsKICAgIGZvciAoOyBpIDwgMzsgaSsrKSB7CiAgICAgIHZhciBhID0gb3JpZ2FyZ3NbaV07CiAgICAgIHZhciB0YSA9IHR5cGVvZiBhOwogICAgICAvL2NvbnNvbGUubG9nKCdpdGVyIGk6JytpKycgajonK2orJyB0YTonK3RhKTsKICAgICAgaWYgKGEgJiYgMCA9PSBqICYmICgnb2JqZWN0JyA9PSB0YSB8fCAnYm9vbGVhbicgPT0gdGEpKSB7CiAgICAgICAgLy9jb25zb2xlLmxvZygnb2JqZWN0IGk6JytpKycgajonK2orJyB0YTonK3RhKTsKICAgICAgICBvdXRhcmdzW2orK10gPSBhOwogICAgICB9IGVsc2UgaWYgKGEgJiYgJ2Z1bmN0aW9uJyA9PSB0YSkgewogICAgICAgIGogPSAwID09IGogPyAxIDogajsKICAgICAgICAvL2NvbnNvbGUubG9nKCdmdW5jdGlvbiBpOicraSsnIGo6JytqKycgdGE6Jyt0YSk7CiAgICAgICAgb3V0YXJnc1tqKytdID0gYTsKICAgICAgfQogICAgfQoKICAgIGlmIChudWxsID09IG91dGFyZ3NbMF0pIHsKICAgICAgb3V0YXJnc1swXSA9IGRlZmF1bHRwYXJhbXMgPyBkZWZhdWx0cGFyYW1zIDogZGVmYXVsdGFyZ3MucGFyYW1zOwogICAgfSBlbHNlIHsKICAgICAgdmFyIHBhcmFtc2FyZyA9IG91dGFyZ3NbMF07CiAgICAgIHBhcmFtc2FyZy5fZGVmYXVsdHMgPSBbXTsKICAgICAgZm9yICh2YXIgbiBpbiBkZWZhdWx0cGFyYW1zKSB7CiAgICAgICAgaWYgKGRlZmF1bHRwYXJhbXMuaGFzT3duUHJvcGVydHkobikpIHsKICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zYXJnW25dID09PSAidW5kZWZpbmVkIikgeyAvL3dlIGRvbid0IHdhbnQgdG8gdXNlICFwYXJhbXNhcmdbbl0gaGVyZSBiZWNhdXNlIHRoZSBwYXJhbWV0ZXIgY291bGQgZXhpc3RzIGluIHRoZSBhcmd1bWVudCBhbmQgaXQgY291bGQgYmUgZmFsc2UKICAgICAgICAgICAgcGFyYW1zYXJnW25dID0gZGVmYXVsdHBhcmFtc1tuXTsKICAgICAgICAgICAgcGFyYW1zYXJnLl9kZWZhdWx0cy5wdXNoKG4pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIG91dGFyZ3NbMV0gPSBudWxsID09IG91dGFyZ3NbMV0gPyBkZWZhdWx0YXJncy5zdWNjZXNzIDogb3V0YXJnc1sxXTsKICAgIG91dGFyZ3NbMl0gPSBudWxsID09IG91dGFyZ3NbMl0gPyBkZWZhdWx0YXJncy5mYWlsdXJlIDogb3V0YXJnc1syXTsKCiAgICBhcHBseXRvKG91dGFyZ3NbMF0sIG91dGFyZ3NbMV0sIG91dGFyZ3NbMl0pOwogIH0KCiAgdmFyIGV2ZW50U3VwcG9ydGVkID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaScpOwogICAgcmV0dXJuIGV2ZW50IGluIGVsZW1lbnQgfHwgZWxlbWVudC5zZXRBdHRyaWJ1dGUgJiYgZWxlbWVudC5zZXRBdHRyaWJ1dGUoZXZlbnQsICJyZXR1cm47IikgfHwgZmFsc2U7CiAgfQoKICB2YXIgX19pc19yZWFkeSA9IGZhbHNlOwogIHZhciBfX3JlYWR5X2xpc3QgPSBbXTsKICB2YXIgX19yZWFkeV9ib3VuZCA9IGZhbHNlOwogIHZhciBib3hwcmVmaXggPSAiL2JveC9zcnYvMS4xLyI7CgogIF9nZXRIb3N0UHJlZml4ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gJGZoLmFwcF9wcm9wcy5ob3N0ICsgYm94cHJlZml4OwogIH0KCiAgdmFyIF9fcmVhZHkgPSBmdW5jdGlvbigpIHsKICAgIGlmICghX19pc19yZWFkeSkgewogICAgICBfX2lzX3JlYWR5ID0gdHJ1ZTsKICAgICAgaWYgKF9fcmVhZHlfbGlzdCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB3aGlsZSAoX19yZWFkeV9saXN0WzBdKSB7CiAgICAgICAgICAgIF9fcmVhZHlfbGlzdC5zaGlmdCgpLmFwcGx5KGRvY3VtZW50LCBbXSk7CiAgICAgICAgICB9CgogICAgICAgIH0gZmluYWxseSB7CgogICAgICAgIH0KICAgICAgICBfX3JlYWR5X2xpc3QgPSBudWxsOwogICAgICB9CiAgICB9CiAgfTsKCiAgdmFyIF9fYmluZF9yZWFkeSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKF9fcmVhZHlfYm91bmQpIHJldHVybjsKICAgIF9fcmVhZHlfYm91bmQgPSB0cnVlOwoKICAgIC8vIE1vemlsbGEsIE9wZXJhIGFuZCB3ZWJraXQgbmlnaHRsaWVzIGN1cnJlbnRseSBzdXBwb3J0IHRoaXMgZXZlbnQKICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgIC8vIFVzZSB0aGUgaGFuZHkgZXZlbnQgY2FsbGJhY2sKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGZ1bmN0aW9uKCkgewogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBhcmd1bWVudHMuY2FsbGVlLCBmYWxzZSk7CiAgICAgICAgX19yZWFkeSgpOwogICAgICB9LCBmYWxzZSk7CgogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIF9fcmVhZHksIGZhbHNlKTsKCiAgICAgIC8vIElmIElFIGV2ZW50IG1vZGVsIGlzIHVzZWQKICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuYXR0YWNoRXZlbnQpIHsKICAgICAgLy8gZW5zdXJlIGZpcmluZyBiZWZvcmUgb25sb2FkLAogICAgICAvLyBtYXliZSBsYXRlIGJ1dCBzYWZlIGFsc28gZm9yIGlmcmFtZXMKICAgICAgZG9jdW1lbnQuYXR0YWNoRXZlbnQoIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSB7CiAgICAgICAgICBkb2N1bWVudC5kZXRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgYXJndW1lbnRzLmNhbGxlZSk7CiAgICAgICAgICBfX3JlYWR5KCk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHdpbmRvdy5hdHRhY2hFdmVudCgib25sb2FkIiwgX19yZWFkeSk7CgogICAgICAvLyBJZiBJRSBhbmQgbm90IGFuIGlmcmFtZQogICAgICAvLyBjb250aW51YWxseSBjaGVjayB0byBzZWUgaWYgdGhlIGRvY3VtZW50IGlzIHJlYWR5CiAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwgJiYgd2luZG93ID09IHdpbmRvdy50b3ApKGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChfX2lzX3JlYWR5KSByZXR1cm47CgogICAgICAgIHRyeSB7CiAgICAgICAgICAvLyBJZiBJRSBpcyB1c2VkLCB1c2UgdGhlIHRyaWNrIGJ5IERpZWdvIFBlcmluaQogICAgICAgICAgLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCgibGVmdCIpOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGFyZ3VtZW50cy5jYWxsZWUsIDApOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gYW5kIGV4ZWN1dGUgYW55IHdhaXRpbmcgZnVuY3Rpb25zCiAgICAgICAgX19yZWFkeSgpOwogICAgICB9KSgpOwogICAgfQogIH07CgogIF9fYmluZF9yZWFkeSgpOwoKICAvLyBkZXN0aW5hdGlvbiBmdW5jdGlvbnMKICB2YXIgX21hcFNjcmlwdExvYWRlZCA9ICh0eXBlb2YgZ29vZ2xlICE9ICJ1bmRlZmluZWQiKSAmJiAodHlwZW9mIGdvb2dsZS5tYXBzICE9ICJ1bmRlZmluZWQiKSAmJiAodHlwZW9mIGdvb2dsZS5tYXBzLk1hcCAhPSAidW5kZWZpbmVkIik7CiAgLy9Db250YWlucyB0aGUgdGFyZ2V0IGVsZW1lbnQgYW5kIHN1Y2Nlc3MgZnVuY3Rpb24gZm9yICRmaC5tYXAgZnVuY3Rpb25zCiAgdmFyIF9tYXBMb2FkU3VjY2Vzc1BhcmFtZXRlcnMgPSBbXTsKICAvL0ZsYWcgdG8gc2hvdyBpZiBhIG1hcCBzY3JpcHQgaXMgbG9hZGluZyBvciBub3QuCiAgdmFyIF9tYXBTY3JpcHRMb2FkaW5nID0gZmFsc2U7IAogIHZhciBfbG9hZE1hcFNjcmlwdCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgc2NyaXB0LnR5cGUgPSAidGV4dC9qYXZhc2NyaXB0IjsKICAgIHZhciBwcm90b2NvbCA9IGRvY3VtZW50LmxvY2F0aW9uLnByb3RvY29sOwogICAgcHJvdG9jb2wgPSAocHJvdG9jb2wgPT09ICJodHRwOiIgfHwgcHJvdG9jb2wgPT09ICJodHRwczoiKSA/IHByb3RvY29sIDogImh0dHBzOiI7CiAgICBzY3JpcHQuc3JjID0gcHJvdG9jb2wgKyAiLy9tYXBzLmdvb2dsZS5jb20vbWFwcy9hcGkvanM/c2Vuc29yPXRydWUmY2FsbGJhY2s9JGZoLl9tYXBMb2FkZWQiOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwogIH07CgogIHZhciBhdWRpb19vYmogPSBudWxsOwogIHZhciBhdWRpb19pc19wbGF5aW5nID0gZmFsc2U7CgogICRmaC5fX2Rlc3RfXyA9IHsKICAgIHNlbmQ6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgZignc2VuZF9ub3N1cHBvcnQnKTsKICAgIH0sCiAgICBub3RpZnk6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgZignbm90aWZ5X25vc3VwcG9ydCcpOwogICAgfSwKICAgIGNvbnRhY3RzOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgIGYoJ2NvbnRhY3RzX25vc3VwcG9ydCcpOwogICAgfSwKICAgIGFjYzogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBmKCdhY2Nfbm9zdXBwb3J0Jyk7CiAgICB9LAogICAgZ2VvOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgIGYoJ2dlb19ub3N1cHBvcnQnKTsKICAgIH0sCiAgICBjYW06IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgZignY2FtX25vc3VwcG9ydCcpOwogICAgfSwKICAgIGRldmljZTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBmKCdkZXZpY2Vfbm9zdXBwb3J0Jyk7CiAgICB9LAogICAgbGlzdGVuOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgIGYoJ2xpc3Rlbl9ub3N1cHBvcnQnKTsKICAgIH0sCiAgICBoYW5kbGVyczogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBmKCdoYW5kbGVyc19ub19zdXBwb3J0Jyk7CiAgICB9LAogICAgZmlsZTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBmKCdmaWxlX25vc3VwcG9ydCcpOwogICAgfSwKICAgIHB1c2g6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgZigncHVzaF9ub3N1cHBvcnQnKTsKICAgIH0sCiAgICBlbnY6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgcyh7CiAgICAgICAgaGVpZ2h0OiB3aW5kb3cuaW5uZXJIZWlnaHQsCiAgICAgICAgd2lkdGg6IHdpbmRvdy5pbm5lcldpZHRoCiAgICAgIH0pOwogICAgfQoKICAgICwKICAgIGRhdGE6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgaWYgKCEkZmguX3BlcnNpc3QpIHsKICAgICAgICAkZmguX3BlcnNpc3QgPSBuZXcgUGVyc2lzdC5TdG9yZSgnRkgnICsgJGZoLmFwcF9wcm9wcy5hcHBpZCwgewogICAgICAgICAgc3dmX3BhdGg6ICcvc3RhdGljL2Mvc3RhcnQvc3dmL3BlcnNpc3Quc3dmJwogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAoIXAua2V5KSB7CiAgICAgICAgZignZGF0YV9ub2tleScpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGFjdHMgPSB7CiAgICAgICAgbG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAkZmguX3BlcnNpc3QuZ2V0KHAua2V5LCBmdW5jdGlvbihvaywgdmFsKSB7CiAgICAgICAgICAgIG9rID8gcyh7CiAgICAgICAgICAgICAga2V5OiBwLmtleSwKICAgICAgICAgICAgICB2YWw6IHZhbAogICAgICAgICAgICB9KSA6IHMoewogICAgICAgICAgICAgIGtleTogcC5rZXksCiAgICAgICAgICAgICAgdmFsOiBudWxsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBzYXZlOiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICghcC52YWwpIHsKICAgICAgICAgICAgZignZGF0YV9ub3ZhbCcpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICAkZmguX3BlcnNpc3Quc2V0KHAua2V5LCBwLnZhbCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGYoJ2RhdGFfZXJyb3InLCB7fSwgcCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHMoKTsKICAgICAgICB9LAogICAgICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAkZmguX3BlcnNpc3QucmVtb3ZlKHAua2V5LCBmdW5jdGlvbihvaywgdmFsKSB7CiAgICAgICAgICAgIG9rID8gcyh7CiAgICAgICAgICAgICAga2V5OiBwLmtleSwKICAgICAgICAgICAgICB2YWw6IHZhbAogICAgICAgICAgICB9KSA6IHMoewogICAgICAgICAgICAgIGtleTogcC5rZXksCiAgICAgICAgICAgICAgdmFsOiBudWxsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgYWN0c1twLmFjdF0gPyBhY3RzW3AuYWN0XSgpIDogZignZGF0YV9iYWRhY3QnLCBwKTsKICAgIH0KCiAgICAsCiAgICBsb2c6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgdHlwZW9mIGNvbnNvbGUgPT09ICJ1bmRlZmluZWQiID8gZignbG9nX25vc3VwcG9ydCcpIDogY29uc29sZS5sb2cocC5tZXNzYWdlKTsKICAgIH0KCiAgICAsCiAgICBvcmk6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgaWYgKHR5cGVvZiBwLmFjdCA9PSAidW5kZWZpbmVkIiB8fCBwLmFjdCA9PSAibGlzdGVuIikgewogICAgICAgIGlmIChldmVudFN1cHBvcnRlZCgnb25vcmllbnRhdGlvbmNoYW5nZScpKSB7CiAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb3JpZW50YXRpb25jaGFuZ2UnLCBzLCBmYWxzZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGYoJ29yaV9ub3N1cHBvcnQnLCB7fSwgcCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHAuYWN0ID09ICJzZXQiKSB7CiAgICAgICAgaWYgKCFwLnZhbHVlKSB7CiAgICAgICAgICBmKCdvcmlfbm9fdmFsdWUnLCB7fSwgcCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChwLnZhbHVlID09ICJwb3J0cmFpdCIpIHsKICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0uc3R5bGVbJy1tb3otdHJhbnNmb3JtJ10gPSAiIjsKICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0uc3R5bGVbJy13ZWJraXQtdHJhbnNmb3JtJ10gPSAiIjsKICAgICAgICAgIHMoewogICAgICAgICAgICBvcmllbnRhdGlvbjogJ3BvcnRyYWl0JwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0uc3R5bGVbJy1tb3otdHJhbnNmb3JtJ10gPSAncm90YXRlKDkwZGVnKSc7CiAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdLnN0eWxlWyctd2Via2l0LXRyYW5zZm9ybSddID0gJ3JvdGF0ZSg5MGRlZyknOwogICAgICAgICAgcyh7CiAgICAgICAgICAgIG9yaWVudGF0aW9uOiAnbGFuZHNjYXBlJwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGYoJ29yaV9iYWRhY3QnLCB7fSwgcCk7CiAgICAgIH0KICAgIH0sCiAgICBtYXA6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgaWYgKCFwLnRhcmdldCkgewogICAgICAgIGYoJ21hcF9ub3RhcmdldCcsIHt9LCBwKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKCFwLmxhdCkgewogICAgICAgIGYoJ21hcF9ub2xhdGl0dWRlJywge30sIHApOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoIXAubG9uKSB7CiAgICAgICAgZignbWFwX25vbG9naXR1ZGUnLCB7fSwgcCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciB0YXJnZXQgPSBwLnRhcmdldDsKICAgICAgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICJzdHJpbmciKSB7CiAgICAgICAgdmFyIHRhcmdldF9kb20gPSBudWxsOwogICAgICAgIGlmICh0eXBlb2YgalF1ZXJ5ICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIganFfb2JqID0galF1ZXJ5KHRhcmdldCk7CiAgICAgICAgICAgIGlmIChqcV9vYmoubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHRhcmdldF9kb20gPSBqcV9vYmpbMF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgdGFyZ2V0X2RvbSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChudWxsID09IHRhcmdldF9kb20pIHsKICAgICAgICAgIHRhcmdldF9kb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YXJnZXQpOwogICAgICAgIH0KICAgICAgICB0YXJnZXQgPSB0YXJnZXRfZG9tOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICJvYmplY3QiKSB7CiAgICAgICAgaWYgKHRhcmdldC5ub2RlVHlwZSA9PT0gMSAmJiB0eXBlb2YgdGFyZ2V0Lm5vZGVOYW1lID09PSAic3RyaW5nIikgewogICAgICAgICAgLy8gQSBET00gRWxlbWVudCwgZG8gbm90aGluZwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvL0EgalF1ZXJ5IG5vZGUKICAgICAgICAgIHRhcmdldCA9IHRhcmdldFswXTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0ID0gbnVsbDsKICAgICAgfQoKICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICBmKCdtYXBfbm9jb250YWluZXInLCB7fSwgcCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgoKCgogICAgICBpZiAoIV9tYXBTY3JpcHRMb2FkZWQpIHsKCiAgICAgICAgLy9RdWV1ZSB0aGUgc3VjY2VzcyBmdW5jdGlvbgogICAgICAgIGlmKHR5cGVvZihzKSA9PT0gJ2Z1bmN0aW9uJyl7CiAgICAgICAgICAgIF9tYXBMb2FkU3VjY2Vzc1BhcmFtZXRlcnMucHVzaCh7dGFyZ2V0OiB0YXJnZXQsIHN1Y2Nlc3NGdW5jdGlvbjogcywgbU9wdGlvbnM6IHB9KTsgICAgCiAgICAgICAgfQogICAgICAgIAoKICAgICAgICAkZmguX21hcExvYWRlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgX21hcFNjcmlwdExvYWRlZCA9IHRydWU7CiAgICAgICAgICB2YXIgbWFwTG9hZFN1Y2Nlc3NQYXJhbWV0ZXIgPSBfbWFwTG9hZFN1Y2Nlc3NQYXJhbWV0ZXJzLnNoaWZ0KCk7CgogICAgICAgICAgd2hpbGUodHlwZW9mKG1hcExvYWRTdWNjZXNzUGFyYW1ldGVyKSAhPT0gJ3VuZGVmaW5lZCcpewogICAgICAgICAgICB2YXIgbU9wdGlvbnMgPSBtYXBMb2FkU3VjY2Vzc1BhcmFtZXRlci5tT3B0aW9uczsKICAgICAgICAgICAgdmFyIG1hcE9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgbWFwT3B0aW9ucy56b29tID0gbU9wdGlvbnMuem9vbSA/IG1PcHRpb25zLnpvb20gOiA4OwogICAgICAgICAgICBtYXBPcHRpb25zLmNlbnRlciA9IG5ldyBnb29nbGUubWFwcy5MYXRMbmcobU9wdGlvbnMubGF0LCBtT3B0aW9ucy5sb24pOwogICAgICAgICAgICBtYXBPcHRpb25zLm1hcFR5cGVJZCA9IGdvb2dsZS5tYXBzLk1hcFR5cGVJZC5ST0FETUFQOwoKICAgICAgICAgICAgdmFyIG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAobWFwTG9hZFN1Y2Nlc3NQYXJhbWV0ZXIudGFyZ2V0LCBtYXBPcHRpb25zKTsKICAgICAgICAgICAgbWFwTG9hZFN1Y2Nlc3NQYXJhbWV0ZXIuc3VjY2Vzc0Z1bmN0aW9uKHttYXA6IG1hcH0pOyAgCiAgICAgICAgICAgIG1hcExvYWRTdWNjZXNzUGFyYW1ldGVyID0gX21hcExvYWRTdWNjZXNzUGFyYW1ldGVycy5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGlmKCFfbWFwU2NyaXB0TG9hZGluZyl7CiAgICAgICAgICAgIF9tYXBTY3JpcHRMb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgX2xvYWRNYXBTY3JpcHQoKTsgICAgCiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vYWZ0ZXIgMjAgc2VjcywgaWYgdGhlIG1hcCBzY3JpcHQgaXMgc3RpbGwgbm90IGxvYWRlZCwgcnVuIHRoZSBmYWlsIGZ1bmN0aW9uCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICghX21hcFNjcmlwdExvYWRlZCkgewogICAgICAgICAgICBmKCdtYXBfdGltZW91dCcsIHt9LCBwKTsKICAgICAgICAgIH0KICAgICAgICB9LCAyMDAwMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG1hcE9wdGlvbnMgPSB7fTsKICAgICAgICBtYXBPcHRpb25zLnpvb20gPSBwLnpvb20gPyBwLnpvb20gOiA4OwogICAgICAgIG1hcE9wdGlvbnMuY2VudGVyID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhwLmxhdCwgcC5sb24pOwogICAgICAgIG1hcE9wdGlvbnMubWFwVHlwZUlkID0gZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlJPQURNQVA7CiAgICAgICAgdmFyIG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAodGFyZ2V0LCBtYXBPcHRpb25zKTsKICAgICAgICBzKHsKICAgICAgICAgIG1hcDogbWFwCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICAsCiAgICBhdWRpbzogZnVuY3Rpb24ocCwgcywgZikgewogICAgICBpZiAoIWF1ZGlvX29iaiA9PSBudWxsICYmIHAuYWN0ID09ICJwbGF5IiAmJiAoIXAucGF0aCB8fCBwLnBhdGggPT0gIiIpKSB7CiAgICAgICAgZignbm9fYXVkaW9fcGF0aCcpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgYWN0cyA9IHsKICAgICAgICAncGxheSc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKG51bGwgPT0gYXVkaW9fb2JqKSB7CiAgICAgICAgICAgIGF1ZGlvX29iaiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImF1ZGlvIik7CiAgICAgICAgICAgIGlmICghKChhdWRpb19vYmoucGxheSkgPyB0cnVlIDogZmFsc2UpKSB7CiAgICAgICAgICAgICAgZignYXVkaW9fbm90X3N1cHBvcnQnKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHAudHlwZSkgewogICAgICAgICAgICAgIHZhciBjYW5wbGF5ID0gYXVkaW9fb2JqLmNhblBsYXlUeXBlKHAudHlwZSk7CiAgICAgICAgICAgICAgaWYgKGNhbnBsYXkgPT0gIm5vIiB8fCBjYW5wbGF5ID09ICIiKSB7CiAgICAgICAgICAgICAgICBmKCJhdWRpb190eXBlX25vdF9zdXBwb3J0ZWQiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXVkaW9fb2JqLnNyYyA9IHAucGF0aDsKICAgICAgICAgICAgaWYgKHAuY29udHJvbHMpIHsKICAgICAgICAgICAgICBhdWRpb19vYmouY29udHJvbHMgPSAiY29udHJvbHMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwLmF1dG9wbGF5KSB7CiAgICAgICAgICAgICAgYXVkaW9fb2JqLmF1dG9wbGF5ID0gImF1dG9wbGF5IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocC5sb29wKSB7CiAgICAgICAgICAgICAgYXVkaW9fb2JqLmxvb3AgPSAibG9vcCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhdWRpb19vYmopOwogICAgICAgICAgICBhdWRpb19vYmoucGxheSgpOwogICAgICAgICAgICBhdWRpb19pc19wbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgcygpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9wbGF5aW5nIGEgbmV3IGF1ZGlvCiAgICAgICAgICAgIGlmIChwLnBhdGggJiYgKHAucGF0aCAhPSBhdWRpb19vYmouc3JjKSkgewogICAgICAgICAgICAgIGlmIChhdWRpb19pc19wbGF5aW5nKSB7CiAgICAgICAgICAgICAgICBhY3RzWydzdG9wJ10odHJ1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFjdHNbJ3BsYXknXSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vcmVzdW1lIHRoZSBleGlzdGluZyBhdWRpbwogICAgICAgICAgICAgIGlmICghYXVkaW9faXNfcGxheWluZykgewogICAgICAgICAgICAgICAgYXVkaW9fb2JqLnBsYXkoKTsKICAgICAgICAgICAgICAgIGF1ZGlvX2lzX3BsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgcygpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgICdwYXVzZSc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKG51bGwgIT0gYXVkaW9fb2JqICYmIGF1ZGlvX2lzX3BsYXlpbmcpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhdWRpb19vYmoucGF1c2UgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGF1ZGlvX29iai5wYXVzZSgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhdWRpb19vYmouc3RvcCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgYXVkaW9fb2JqLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhdWRpb19pc19wbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHMoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGYoJ25vX2F1ZGlvX3BsYXlpbmcnKTsKICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAnc3RvcCc6IGZ1bmN0aW9uKG5vY2FsbGJhY2spIHsKICAgICAgICAgIGlmIChudWxsICE9IGF1ZGlvX29iaikgewogICAgICAgICAgICBpZiAodHlwZW9mIGF1ZGlvX29iai5zdG9wID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBhdWRpb19vYmouc3RvcCgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhdWRpb19vYmoucGF1c2UgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGF1ZGlvX29iai5wYXVzZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoYXVkaW9fb2JqKTsKICAgICAgICAgICAgYXVkaW9fb2JqID0gbnVsbDsKICAgICAgICAgICAgYXVkaW9faXNfcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBpZiAoIW5vY2FsbGJhY2spIHsKICAgICAgICAgICAgICBzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGYoJ25vX2F1ZGlvJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBhY3RzW3AuYWN0XSA/IGFjdHNbcC5hY3RdKCkgOiBmKCdkYXRhX2JhZGFjdCcsIHApOwogICAgfQoKICAgICwKICAgIHdlYnZpZXc6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgZignd2Vidmlld19ub3N1cHBvcnQnKTsKICAgIH0sCgogICAgcmVhZHk6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgX19iaW5kX3JlYWR5KCk7CiAgICAgIGlmIChfX2lzX3JlYWR5KSB7CiAgICAgICAgcy5hcHBseShkb2N1bWVudCwgW10pOwogICAgICB9IGVsc2UgewogICAgICAgIF9fcmVhZHlfbGlzdC5wdXNoKHMpOwogICAgICB9CiAgICB9CiAgfQoKICAkZmguc2VuZCA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgdHlwZTogJ2VtYWlsJwogICAgfSwgJGZoLl9fZGVzdF9fLnNlbmQpOwogIH0KCiAgJGZoLm5vdGlmeSA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgdHlwZTogJ3ZpYnJhdGUnCiAgICB9LCAkZmguX19kZXN0X18ubm90aWZ5KTsKICB9CgogICRmaC5jb250YWN0cyA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgYWN0OiAnbGlzdCcKICAgIH0sICRmaC5fX2Rlc3RfXy5jb250YWN0cyk7CiAgfQoKICAkZmguYWNjID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICBhY3Q6ICdyZWdpc3RlcicsCiAgICAgIGludGVydmFsOiAwCiAgICB9LCAkZmguX19kZXN0X18uYWNjKTsKICB9CgogICRmaC5nZW8gPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgIGFjdDogJ3JlZ2lzdGVyJywKICAgICAgaW50ZXJ2YWw6IDAKICAgIH0sICRmaC5fX2Rlc3RfXy5nZW8pOwogIH0KCiAgJGZoLmNhbSA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgYWN0OiAncGljdHVyZScKICAgIH0sICRmaC5fX2Rlc3RfXy5jYW0pOwogIH0KCiAgJGZoLmRhdGEgPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgIGFjdDogJ2xvYWQnCiAgICB9LCAkZmguX19kZXN0X18uZGF0YSk7CiAgfQoKICAkZmgubG9nID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICBtZXNzYWdlOiAnbm9uZScKICAgIH0sICRmaC5fX2Rlc3RfXy5sb2cpOwogIH0KCiAgJGZoLmRldmljZSA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18uZGV2aWNlKTsKICB9CgogICRmaC5saXN0ZW4gPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgIGFjdDogJ2FkZCcKICAgIH0sICRmaC5fX2Rlc3RfXy5saXN0ZW4pOwogIH0KCiAgJGZoLm9yaSA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18ub3JpKTsKICB9CgogICRmaC5tYXAgPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgJGZoLl9fZGVzdF9fLm1hcCk7CiAgfQoKICAkZmguYXVkaW8gPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgJGZoLl9fZGVzdF9fLmF1ZGlvKTsKICB9CgogICRmaC53ZWJ2aWV3ID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sICRmaC5fX2Rlc3RfXy53ZWJ2aWV3KTsKICB9CgogICRmaC5yZWFkeSA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18ucmVhZHkpOwogIH07CgogICRmaC5oYW5kbGVycyA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgdHlwZTogJ2JhY2snCiAgICB9LCAkZmguX19kZXN0X18uaGFuZGxlcnMpOwogIH07CgogICRmaC5maWxlID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICBhY3Q6ICd1cGxvYWQnCiAgICB9LCAkZmguX19kZXN0X18uZmlsZSk7CiAgfTsKCiAgJGZoLnB1c2ggPSBmdW5jdGlvbigpIHsKICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgJGZoLl9fZGVzdF9fLnB1c2gpOwogIH07CgogIC8vIG5ldyBmdW5jdGlvbnMKICAkZmguZW52ID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sIGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgLy8gZmxhdCBwcm9wZXJ0eSBzZXQgLSBubyBzdWIgb2JqZWN0cyEKICAgICAgJGZoLl9fZGVzdF9fLmVudih7fSwgZnVuY3Rpb24oZGVzdEVudikgewogICAgICAgIGRlc3RFbnYuYXBwbGljYXRpb24gPSAkZmguYXBwX3Byb3BzLmFwcGlkOwogICAgICAgIGlmICgkZmguX2dldERldmljZUlkKSB7CiAgICAgICAgICBkZXN0RW52LnV1aWQgPSAkZmguX2dldERldmljZUlkKCk7CiAgICAgICAgfQogICAgICAgIGRlc3RFbnYuYWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50IHx8ICd1bmtub3duJzsKICAgICAgICBzKGRlc3RFbnYpOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgJGZoLmRldmljZSA9IGZ1bmN0aW9uKCkgewogICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCBmdW5jdGlvbihwLCBzLCBmKSB7CgogICAgfSk7CiAgfQoKCiAgLy8gZGVmYXVsdHM6IAogIC8vICAgIHthY3Q6J2dldCd9IC0+IHtnZW9pcDp7Li4ufX0KICAvLyAgZmFpbHVyZXM6IGdlb2lwX2JhZGFjdAogIC8vCiAgJGZoLmdlb2lwID0gZnVuY3Rpb24oKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICBhY3Q6ICdnZXQnCiAgICB9LCBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgIGlmICgnZ2V0JyA9PSBwLmFjdCkgewogICAgICAgIHZhciBkYXRhID0gewogICAgICAgICAgaW5zdGFuY2U6ICRmaC5hcHBfcHJvcHMuYXBwaWQsCiAgICAgICAgICBkb21haW46ICRmaC5jbG91ZF9wcm9wcy5kb21haW4KICAgICAgICB9CiAgICAgICAgJGZoLl9fYWpheCh7CiAgICAgICAgICAidXJsIjogX2dldEhvc3RQcmVmaXgoKSArICJhY3Qvd2lkL2dlb2lwL3Jlc29sdmUiLAogICAgICAgICAgInR5cGUiOiAiUE9TVCIsCiAgICAgICAgICAiZGF0YSI6IEpTT04uc3RyaW5naWZ5KGRhdGEpLAogICAgICAgICAgInN1Y2Nlc3MiOiBmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgLy8gYmFja3dhcmRzIGNvbXBhdAogICAgICAgICAgICBmb3IgKHZhciBuIGluIHJlcy5nZW9pcCkgewogICAgICAgICAgICAgIHJlc1tuXSA9IHJlc1snZ2VvaXAnXVtuXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzKHJlcyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZignZ2VvaXBfYmFkYWN0JywgcCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogICRmaC53ZWIgPSBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICBtZXRob2Q6ICdHRVQnCiAgICB9LCBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgIGlmICghcC51cmwpIHsKICAgICAgICBmKCdiYWRfdXJsJyk7CiAgICAgIH0KCiAgICAgIGlmIChwLmlzX2xvY2FsKSB7CiAgICAgICAgJGZoLl9fYWpheCh7CiAgICAgICAgICB1cmw6IHAudXJsLAogICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICBkYXRhVHlwZTogImh0bWwiLAogICAgICAgICAgLy94aHI6ICRmaC54aHIsCiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIHZhciByZXMgPSB7fTsKICAgICAgICAgICAgcmVzLnN0YXR1cyA9IDIwMDsKICAgICAgICAgICAgcmVzLmJvZHkgPSBkYXRhOwogICAgICAgICAgICBzKHJlcyk7CiAgICAgICAgICB9LAogICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmKCk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSBlbHNlIHsKICAgICAgICAkZmguX19hamF4KHsKICAgICAgICAgICJ1cmwiOiBfZ2V0SG9zdFByZWZpeCgpICsgImFjdC93aWQvd2ViIiwKICAgICAgICAgICJ0eXBlIjogIlBPU1QiLAogICAgICAgICAgImRhdGEiOiBKU09OLnN0cmluZ2lmeShwKSwKICAgICAgICAgICJzdWNjZXNzIjogZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICAgIHMocmVzKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgJGZoLl9fd2Vidmlld193aW4gPSB1bmRlZmluZWQ7CiAgJGZoLl9fZGVzdF9fLndlYnZpZXcgPSBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICBpZiAoISgnYWN0JyBpbiBwKSB8fCBwLmFjdCA9PT0gJ29wZW4nKSB7CiAgICAgIGlmICghcC51cmwpIHsKICAgICAgICBmKCdub191cmwnKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIG9sZF91cmwgPSBwLnVybDsKICAgICAgJGZoLl9fd2Vidmlld193aW4gPSB3aW5kb3cub3BlbihwLnVybCwgJ19ibGFuaycpOwogICAgICBzKCJvcGVuZWQiKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChwLmFjdCA9PT0gJ2Nsb3NlJykgewogICAgICAgIGlmICh0eXBlb2YgJGZoLl9fd2Vidmlld193aW4gIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICRmaC5fX3dlYnZpZXdfd2luLmNsb3NlKCk7CiAgICAgICAgICAkZmguX193ZWJ2aWV3X3dpbiA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgICAgcygiY2xvc2VkIik7CiAgICAgIH0KICAgIH0KICB9OwoKICBpZiAodHlwZW9mKHdpbmRvdy5QaG9uZUdhcCkgIT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZih3aW5kb3cuY29yZG92YSkgIT09ICd1bmRlZmluZWQnKSB7CiAgICAkZmguX3JlYWR5Q2FsbGJhY2tzID0gW107CiAgICAkZmguX3JlYWR5U3RhdGUgPSBmYWxzZTsKICAgICRmaC5fX2Rlc3RfXy5yZWFkeSA9IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgaWYgKCRmaC5fcmVhZHlTdGF0ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBzKCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29uc29sZS5sb2coIkVycm9yIGR1cmluZyAkZmgucmVhZHkuIFNraXAuIEVycm9yID0gIiArIGUubWVzc2FnZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgICRmaC5fcmVhZHlDYWxsYmFja3MucHVzaChzKTsKICAgICAgfQogICAgfTsKICB9CgogICRmaC5fX2Rlc3RfXy5nZW8gPSBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICBpZiAodHlwZW9mIG5hdmlnYXRvci5nZW9sb2NhdGlvbiAhPSAndW5kZWZpbmVkJykgewogICAgICBpZiAoIXAuYWN0IHx8IHAuYWN0ID09ICJyZWdpc3RlciIpIHsKICAgICAgICBpZiAoJGZoLl9fZGVzdF9fLl9nZW9XYXRjaGVyKSB7CiAgICAgICAgICBmKCdnZW9faW51c2UnLCB7fSwgcCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChwLmludGVydmFsID09IDApIHsKICAgICAgICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oZnVuY3Rpb24ocG9zaXRpb24pIHsKICAgICAgICAgICAgdmFyIGNvb3JkcyA9IHBvc2l0aW9uLmNvb3JkczsKICAgICAgICAgICAgdmFyIHJlc2RhdGEgPSB7CiAgICAgICAgICAgICAgbG9uOiBjb29yZHMubG9uZ2l0dWRlLAogICAgICAgICAgICAgIGxhdDogY29vcmRzLmxhdGl0dWRlLAogICAgICAgICAgICAgIGFsdDogY29vcmRzLmFsdGl0dWRlLAogICAgICAgICAgICAgIGFjYzogY29vcmRzLmFjY3VyYWN5LAogICAgICAgICAgICAgIGhlYWQ6IGNvb3Jkcy5oZWFkaW5nLAogICAgICAgICAgICAgIHNwZWVkOiBjb29yZHMuc3BlZWQsCiAgICAgICAgICAgICAgd2hlbjogcG9zaXRpb24udGltZXN0YW1wCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHMocmVzZGF0YSk7CiAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZignZXJyb3JfZ2VvJywge30sIHApOwogICAgICAgICAgfSkKICAgICAgICB9OwogICAgICAgIGlmIChwLmludGVydmFsID4gMCkgewogICAgICAgICAgdmFyIGludGVybmFsV2F0Y2hlciA9IG5hdmlnYXRvci5nZW9sb2NhdGlvbi53YXRjaFBvc2l0aW9uKGZ1bmN0aW9uKHBvc2l0aW9uKSB7CiAgICAgICAgICAgIHZhciBjb29yZHMgPSBwb3NpdGlvbi5jb29yZHM7CiAgICAgICAgICAgIHZhciByZXNkYXRhID0gewogICAgICAgICAgICAgIGxvbjogY29vcmRzLmxvbmdpdHVkZSwKICAgICAgICAgICAgICBsYXQ6IGNvb3Jkcy5sYXRpdHVkZSwKICAgICAgICAgICAgICBhbHQ6IGNvb3Jkcy5hbHRpdHVkZSwKICAgICAgICAgICAgICBhY2M6IGNvb3Jkcy5hY2N1cmFjeSwKICAgICAgICAgICAgICBoZWFkOiBjb29yZHMuaGVhZGluZywKICAgICAgICAgICAgICBzcGVlZDogY29vcmRzLnNwZWVkLAogICAgICAgICAgICAgIHdoZW46IHBvc2l0aW9uLnRpbWVzdGFtcAogICAgICAgICAgICB9OwogICAgICAgICAgICBzKHJlc2RhdGEpOwogICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGYoJ2Vycm9yX2dlbycsIHt9LCBwKTsKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgZnJlcXVlbmN5OiBwLmludGVydmFsCiAgICAgICAgICB9KTsKICAgICAgICAgICRmaC5fX2Rlc3RfXy5fZ2VvV2F0Y2hlciA9IGludGVybmFsV2F0Y2hlcjsKICAgICAgICB9OwogICAgICB9IGVsc2UgaWYgKHAuYWN0ID09ICJ1bnJlZ2lzdGVyIikgewogICAgICAgIGlmICgkZmguX19kZXN0X18uX2dlb1dhdGNoZXIpIHsKICAgICAgICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5jbGVhcldhdGNoKCRmaC5fX2Rlc3RfXy5fZ2VvV2F0Y2hlcik7CiAgICAgICAgICAkZmguX19kZXN0X18uX2dlb1dhdGNoZXIgPSB1bmRlZmluZWQ7CiAgICAgICAgfTsKICAgICAgICBzKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZignZ2VvX2JhZGFjdCcsIHt9LCBwKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZignZ2VvX25vc3VwcG9ydCcsIHt9LCBwKTsKICAgIH0KICB9OwoKICAkZmguX19kZXN0X18uYWNjID0gZnVuY3Rpb24ocCwgcywgZikgewogICAgcyh7CiAgICAgIHg6IChNYXRoLnJhbmRvbSgpICogNCkgLSAyLAogICAgICB5OiAoTWF0aC5yYW5kb20oKSAqIDQpIC0gMiwKICAgICAgejogKE1hdGgucmFuZG9tKCkgKiA0KSAtIDIsCiAgICAgIHdoZW46IG5ldyBEYXRlKCkuZ2V0VGltZSgpCiAgICB9KTsKICB9CgogIHJvb3QuJGZoID0gJGZoOwoKfSkodGhpcyk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 00:14:14 GMT",
                    "Content-Length": "64341",
                    "Date": "Fri, 07 Nov 2014 00:14:15 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}