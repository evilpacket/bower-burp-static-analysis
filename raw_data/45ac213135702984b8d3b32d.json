{
    "url": "http://localhost:9999/jsguy/mithril.sugartags/tests/mithril.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>element.href = window.location.pathname + modes[m.route.mode] + element.pathname</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/jsguy/mithril.sugartags/tests/mithril.js",
                "path": "/jsguy/mithril.sugartags/tests/mithril.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9qc2d1eS9taXRocmlsLnN1Z2FydGFncy90ZXN0cy9taXRocmlsLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzAxNDANCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMTY6MTI6MjMgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDE2OjEyOjIzIEdNVA0KDQpNaXRocmlsID0gbSA9IG5ldyBmdW5jdGlvbiBhcHAod2luZG93LCB1bmRlZmluZWQpIHsKCXZhciB0eXBlID0ge30udG9TdHJpbmcKCXZhciBwYXJzZXIgPSAvKD86KF58I3xcLikoW14jXC5cW1xdXSspKXwoXFsuKz9cXSkvZywgYXR0clBhcnNlciA9IC9cWyguKz8pKD86PSgifCd8KSguKj8pXDIpP1xdLwoJdmFyIHZvaWRFbGVtZW50cyA9IC9BUkVBfEJBU0V8QlJ8Q09MfENPTU1BTkR8RU1CRUR8SFJ8SU1HfElOUFVUfEtFWUdFTnxMSU5LfE1FVEF8UEFSQU18U09VUkNFfFRS4oCM4oCLQUNLfFdCUi8KCglmdW5jdGlvbiBtKCkgewoJCXZhciBhcmdzID0gYXJndW1lbnRzCgkJdmFyIGhhc0F0dHJzID0gYXJnc1sxXSAhPSBudWxsICYmIHR5cGUuY2FsbChhcmdzWzFdKSA9PSAiW29iamVjdCBPYmplY3RdIiAmJiAhKCJ0YWciIGluIGFyZ3NbMV0pICYmICEoInN1YnRyZWUiIGluIGFyZ3NbMV0pCgkJdmFyIGF0dHJzID0gaGFzQXR0cnMgPyBhcmdzWzFdIDoge30KCQl2YXIgY2xhc3NBdHRyTmFtZSA9ICJjbGFzcyIgaW4gYXR0cnMgPyAiY2xhc3MiIDogImNsYXNzTmFtZSIKCQl2YXIgY2VsbCA9IHt0YWc6ICJkaXYiLCBhdHRyczoge319CgkJdmFyIG1hdGNoLCBjbGFzc2VzID0gW10KCQl3aGlsZSAobWF0Y2ggPSBwYXJzZXIuZXhlYyhhcmdzWzBdKSkgewoJCQlpZiAobWF0Y2hbMV0gPT0gIiIpIGNlbGwudGFnID0gbWF0Y2hbMl0KCQkJZWxzZSBpZiAobWF0Y2hbMV0gPT0gIiMiKSBjZWxsLmF0dHJzLmlkID0gbWF0Y2hbMl0KCQkJZWxzZSBpZiAobWF0Y2hbMV0gPT0gIi4iKSBjbGFzc2VzLnB1c2gobWF0Y2hbMl0pCgkJCWVsc2UgaWYgKG1hdGNoWzNdWzBdID09ICJbIikgewoJCQkJdmFyIHBhaXIgPSBhdHRyUGFyc2VyLmV4ZWMobWF0Y2hbM10pCgkJCQljZWxsLmF0dHJzW3BhaXJbMV1dID0gcGFpclszXSB8fCAocGFpclsyXSA/ICIiIDp0cnVlKQoJCQl9CgkJfQoJCWlmIChjbGFzc2VzLmxlbmd0aCA+IDApIGNlbGwuYXR0cnNbY2xhc3NBdHRyTmFtZV0gPSBjbGFzc2VzLmpvaW4oIiAiKQoKCQljZWxsLmNoaWxkcmVuID0gaGFzQXR0cnMgPyBhcmdzWzJdIDogYXJnc1sxXQoKCQlmb3IgKHZhciBhdHRyTmFtZSBpbiBhdHRycykgewoJCQlpZiAoYXR0ck5hbWUgPT0gY2xhc3NBdHRyTmFtZSkgY2VsbC5hdHRyc1thdHRyTmFtZV0gPSAoY2VsbC5hdHRyc1thdHRyTmFtZV0gfHwgIiIpICsgIiAiICsgYXR0cnNbYXR0ck5hbWVdCgkJCWVsc2UgY2VsbC5hdHRyc1thdHRyTmFtZV0gPSBhdHRyc1thdHRyTmFtZV0KCQl9CgkJcmV0dXJuIGNlbGwKCX0KCWZ1bmN0aW9uIGJ1aWxkKHBhcmVudEVsZW1lbnQsIHBhcmVudFRhZywgcGFyZW50Q2FjaGUsIHBhcmVudEluZGV4LCBkYXRhLCBjYWNoZWQsIHNob3VsZFJlYXR0YWNoLCBpbmRleCwgZWRpdGFibGUsIG5hbWVzcGFjZSwgY29uZmlncykgewoJCS8vYGJ1aWxkYCBpcyBhIHJlY3Vyc2l2ZSBmdW5jdGlvbiB0aGF0IG1hbmFnZXMgY3JlYXRpb24vZGlmZmluZy9yZW1vdmFsIG9mIERPTSBlbGVtZW50cyBiYXNlZCBvbiBjb21wYXJpc29uIGJldHdlZW4gYGRhdGFgIGFuZCBgY2FjaGVkYAoJCS8vdGhlIGRpZmYgYWxnb3JpdGhtIGNhbiBiZSBzdW1tYXJpemVkIGFzIHRoaXM6CgkJLy8xIC0gY29tcGFyZSBgZGF0YWAgYW5kIGBjYWNoZWRgCgkJLy8yIC0gaWYgdGhleSBhcmUgZGlmZmVyZW50LCBjb3B5IGBkYXRhYCB0byBgY2FjaGVkYCBhbmQgdXBkYXRlIHRoZSBET00gYmFzZWQgb24gd2hhdCB0aGUgZGlmZmVyZW5jZSBpcwoJCS8vMyAtIHJlY3Vyc2l2ZWx5IGFwcGx5IHRoaXMgYWxnb3JpdGhtIGZvciBldmVyeSBhcnJheSBhbmQgZm9yIHRoZSBjaGlsZHJlbiBvZiBldmVyeSB2aXJ0dWFsIGVsZW1lbnQKCQkKCQkvL3RoZSBgY2FjaGVkYCBkYXRhIHN0cnVjdHVyZSBpcyBlc3NlbnRpYWxseSB0aGUgc2FtZSBhcyB0aGUgcHJldmlvdXMgcmVkcmF3J3MgYGRhdGFgIGRhdGEgc3RydWN0dXJlLCB3aXRoIGEgZmV3IGFkZGl0aW9uczoKCQkvLy0gYGNhY2hlZGAgYWx3YXlzIGhhcyBhIHByb3BlcnR5IGNhbGxlZCBgbm9kZXNgLCB3aGljaCBpcyBhIGxpc3Qgb2YgRE9NIGVsZW1lbnRzIHRoYXQgY29ycmVzcG9uZCB0byB0aGUgZGF0YSByZXByZXNlbnRlZCBieSB0aGUgcmVzcGVjdGl2ZSB2aXJ0dWFsIGVsZW1lbnQKCQkvLy0gaW4gb3JkZXIgdG8gc3VwcG9ydCBhdHRhY2hpbmcgYG5vZGVzYCBhcyBhIHByb3BlcnR5IG9mIGBjYWNoZWRgLCBgY2FjaGVkYCBpcyAqYWx3YXlzKiBhIG5vbi1wcmltaXRpdmUgb2JqZWN0LCBpLmUuIGlmIHRoZSBkYXRhIHdhcyBhIHN0cmluZywgdGhlbiBjYWNoZWQgaXMgYSBTdHJpbmcgaW5zdGFuY2UuIElmIGRhdGEgd2FzIGBudWxsYCBvciBgdW5kZWZpbmVkYCwgY2FjaGVkIGlzIGBuZXcgU3RyaW5nKCIiKWAKCQkvLy0gYGNhY2hlZCBhbHNvIGhhcyBhIGBjb25maWdDb250ZXh0YCBwcm9wZXJ0eSwgd2hpY2ggaXMgdGhlIHN0YXRlIHN0b3JhZ2Ugb2JqZWN0IGV4cG9zZWQgYnkgY29uZmlnKGVsZW1lbnQsIGlzSW5pdGlhbGl6ZWQsIGNvbnRleHQpCgkJLy8tIHdoZW4gYGNhY2hlZGAgaXMgYW4gT2JqZWN0LCBpdCByZXByZXNlbnRzIGEgdmlydHVhbCBlbGVtZW50OyB3aGVuIGl0J3MgYW4gQXJyYXksIGl0IHJlcHJlc2VudHMgYSBsaXN0IG9mIGVsZW1lbnRzOyB3aGVuIGl0J3MgYSBTdHJpbmcsIE51bWJlciBvciBCb29sZWFuLCBpdCByZXByZXNlbnRzIGEgdGV4dCBub2RlCgoJCS8vYHBhcmVudEVsZW1lbnRgIGlzIGEgRE9NIGVsZW1lbnQgdXNlZCBmb3IgVzNDIERPTSBBUEkgY2FsbHMKCQkvL2BwYXJlbnRUYWdgIGlzIG9ubHkgdXNlZCBmb3IgaGFuZGxpbmcgYSBjb3JuZXIgY2FzZSBmb3IgdGV4dGFyZWEgdmFsdWVzCgkJLy9gcGFyZW50Q2FjaGVgIGlzIHVzZWQgdG8gcmVtb3ZlIG5vZGVzIGluIHNvbWUgbXVsdGktbm9kZSBjYXNlcwoJCS8vYHBhcmVudEluZGV4YCBhbmQgYGluZGV4YCBhcmUgdXNlZCB0byBmaWd1cmUgb3V0IHRoZSBvZmZzZXQgb2Ygbm9kZXMuIFRoZXkncmUgYXJ0aWZhY3RzIGZyb20gYmVmb3JlIGFycmF5cyBzdGFydGVkIGJlaW5nIGZsYXR0ZW5lZCBhbmQgYXJlIGxpa2VseSByZWZhY3RvcmFibGUKCQkvL2BkYXRhYCBhbmQgYGNhY2hlZGAgYXJlLCByZXNwZWN0aXZlbHksIHRoZSBuZXcgYW5kIG9sZCBub2RlcyBiZWluZyBkaWZmZWQKCQkvL2BzaG91bGRSZWF0dGFjaGAgaXMgYSBmbGFnIGluZGljYXRpbmcgd2hldGhlciBhIHBhcmVudCBub2RlIHdhcyByZWNyZWF0ZWQgKGlmIHNvLCBhbmQgaWYgdGhpcyBub2RlIGlzIHJldXNlZCwgdGhlbiB0aGlzIG5vZGUgbXVzdCByZWF0dGFjaCBpdHNlbGYgdG8gdGhlIG5ldyBwYXJlbnQpCgkJLy9gZWRpdGFibGVgIGlzIGEgZmxhZyB0aGF0IGluZGljYXRlcyB3aGV0aGVyIGFuIGFuY2VzdG9yIGlzIGNvbnRlbnRlZGl0YWJsZQoJCS8vYG5hbWVzcGFjZWAgaW5kaWNhdGVzIHRoZSBjbG9zZXN0IEhUTUwgbmFtZXNwYWNlIGFzIGl0IGNhc2NhZGVzIGRvd24gZnJvbSBhbiBhbmNlc3RvcgoJCS8vYGNvbmZpZ3NgIGlzIGEgbGlzdCBvZiBjb25maWcgZnVuY3Rpb25zIHRvIHJ1biBhZnRlciB0aGUgdG9wbW9zdCBgYnVpbGRgIGNhbGwgZmluaXNoZXMgcnVubmluZwoKCQkvL3RoZXJlJ3MgbG9naWMgdGhhdCByZWxpZXMgb24gdGhlIGFzc3VtcHRpb24gdGhhdCBudWxsIGFuZCB1bmRlZmluZWQgZGF0YSBhcmUgZXF1aXZhbGVudCB0byBlbXB0eSBzdHJpbmdzCgkJLy8tIHRoaXMgcHJldmVudHMgbGlmZWN5Y2xlIHN1cnByaXNlcyBmcm9tIHByb2NlZHVyYWwgaGVscGVycyB0aGF0IG1peCBpbXBsaWNpdCBhbmQgZXhwbGljaXQgcmV0dXJuIHN0YXRlbWVudHMKCQkvLy0gaXQgc2ltcGxpZmllcyBkaWZmaW5nIGNvZGUKCQlpZiAoZGF0YSA9PSBudWxsKSBkYXRhID0gIiIKCQlpZiAoZGF0YS5zdWJ0cmVlID09PSAicmV0YWluIikgcmV0dXJuIGNhY2hlZAoKCQl2YXIgY2FjaGVkVHlwZSA9IHR5cGUuY2FsbChjYWNoZWQpLCBkYXRhVHlwZSA9IHR5cGUuY2FsbChkYXRhKQoJCWlmIChjYWNoZWQgPT0gbnVsbCB8fCBjYWNoZWRUeXBlICE9IGRhdGFUeXBlKSB7CgkJCWlmIChjYWNoZWQgIT0gbnVsbCkgewoJCQkJaWYgKHBhcmVudENhY2hlICYmIHBhcmVudENhY2hlLm5vZGVzKSB7CgkJCQkJdmFyIG9mZnNldCA9IGluZGV4IC0gcGFyZW50SW5kZXgKCQkJCQl2YXIgZW5kID0gb2Zmc2V0ICsgKGRhdGFUeXBlID09ICJbb2JqZWN0IEFycmF5XSIgPyBkYXRhIDogY2FjaGVkLm5vZGVzKS5sZW5ndGgKCQkJCQljbGVhcihwYXJlbnRDYWNoZS5ub2Rlcy5zbGljZShvZmZzZXQsIGVuZCksIHBhcmVudENhY2hlLnNsaWNlKG9mZnNldCwgZW5kKSkKCQkJCX0KCQkJCWVsc2UgaWYgKGNhY2hlZC5ub2RlcykgY2xlYXIoY2FjaGVkLm5vZGVzLCBjYWNoZWQpCgkJCX0KCQkJY2FjaGVkID0gbmV3IGRhdGEuY29uc3RydWN0b3IKCQkJY2FjaGVkLm5vZGVzID0gW10KCQl9CgoJCWlmIChkYXRhVHlwZSA9PSAiW29iamVjdCBBcnJheV0iKSB7CgkJCWRhdGEgPSBmbGF0dGVuKGRhdGEpCgkJCXZhciBub2RlcyA9IFtdLCBpbnRhY3QgPSBjYWNoZWQubGVuZ3RoID09PSBkYXRhLmxlbmd0aCwgc3ViQXJyYXlDb3VudCA9IDAKCgkJCS8va2V5cyBhbGdvcml0aG06IHNvcnQgZWxlbWVudHMgd2l0aG91dCByZWNyZWF0aW5nIHRoZW0gaWYga2V5cyBhcmUgcHJlc2VudAoJCQkvLzEpIGNyZWF0ZSBhIG1hcCBvZiBhbGwgZXhpc3Rpbmcga2V5cywgYW5kIG1hcmsgYWxsIGZvciBkZWxldGlvbgoJCQkvLzIpIGFkZCBuZXcga2V5cyB0byBtYXAgYW5kIG1hcmsgdGhlbSBmb3IgYWRkaXRpb24KCQkJLy8zKSBpZiBrZXkgZXhpc3RzIGluIG5ldyBsaXN0LCBjaGFuZ2UgYWN0aW9uIGZyb20gZGVsZXRpb24gdG8gYSBtb3ZlCgkJCS8vNCkgZm9yIGVhY2gga2V5LCBoYW5kbGUgaXRzIGNvcnJlc3BvbmRpbmcgYWN0aW9uIGFzIG1hcmtlZCBpbiBwcmV2aW91cyBzdGVwcwoJCQkvLzUpIGNvcHkgdW5rZXllZCBpdGVtcyBpbnRvIHRoZWlyIHJlc3BlY3RpdmUgZ2FwcwoJCQl2YXIgREVMRVRJT04gPSAxLCBJTlNFUlRJT04gPSAyICwgTU9WRSA9IDMKCQkJdmFyIGV4aXN0aW5nID0ge30sIHVua2V5ZWQgPSBbXSwgc2hvdWxkTWFpbnRhaW5JZGVudGl0aWVzID0gZmFsc2UKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjYWNoZWQubGVuZ3RoOyBpKyspIHsKCQkJCWlmIChjYWNoZWRbaV0gJiYgY2FjaGVkW2ldLmF0dHJzICYmIGNhY2hlZFtpXS5hdHRycy5rZXkgIT0gbnVsbCkgewoJCQkJCXNob3VsZE1haW50YWluSWRlbnRpdGllcyA9IHRydWUKCQkJCQlleGlzdGluZ1tjYWNoZWRbaV0uYXR0cnMua2V5XSA9IHthY3Rpb246IERFTEVUSU9OLCBpbmRleDogaX0KCQkJCX0KCQkJfQoJCQlpZiAoc2hvdWxkTWFpbnRhaW5JZGVudGl0aWVzKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKCQkJCQlpZiAoZGF0YVtpXSAmJiBkYXRhW2ldLmF0dHJzKSB7CgkJCQkJCWlmIChkYXRhW2ldLmF0dHJzLmtleSAhPSBudWxsKSB7CgkJCQkJCQl2YXIga2V5ID0gZGF0YVtpXS5hdHRycy5rZXkKCQkJCQkJCWlmICghZXhpc3Rpbmdba2V5XSkgZXhpc3Rpbmdba2V5XSA9IHthY3Rpb246IElOU0VSVElPTiwgaW5kZXg6IGl9CgkJCQkJCQllbHNlIGV4aXN0aW5nW2tleV0gPSB7YWN0aW9uOiBNT1ZFLCBpbmRleDogaSwgZnJvbTogZXhpc3Rpbmdba2V5XS5pbmRleCwgZWxlbWVudDogcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2V4aXN0aW5nW2tleV0uaW5kZXhdfQoJCQkJCQl9CgkJCQkJCWVsc2UgdW5rZXllZC5wdXNoKHtpbmRleDogaSwgZWxlbWVudDogcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2ldfSkKCQkJCQl9CgkJCQl9CgkJCQl2YXIgYWN0aW9ucyA9IE9iamVjdC5rZXlzKGV4aXN0aW5nKS5tYXAoZnVuY3Rpb24oa2V5KSB7cmV0dXJuIGV4aXN0aW5nW2tleV19KQoJCQkJdmFyIGNoYW5nZXMgPSBhY3Rpb25zLnNvcnQoZnVuY3Rpb24oYSwgYikge3JldHVybiBhLmFjdGlvbiAtIGIuYWN0aW9uIHx8IGEuaW5kZXggLSBiLmluZGV4fSkKCQkJCXZhciBuZXdDYWNoZWQgPSBjYWNoZWQuc2xpY2UoKQoKCQkJCWZvciAodmFyIGkgPSAwLCBjaGFuZ2U7IGNoYW5nZSA9IGNoYW5nZXNbaV07IGkrKykgewoJCQkJCWlmIChjaGFuZ2UuYWN0aW9uID09IERFTEVUSU9OKSB7CgkJCQkJCWNsZWFyKGNhY2hlZFtjaGFuZ2UuaW5kZXhdLm5vZGVzLCBjYWNoZWRbY2hhbmdlLmluZGV4XSkKCQkJCQkJbmV3Q2FjaGVkLnNwbGljZShjaGFuZ2UuaW5kZXgsIDEpCgkJCQkJfQoJCQkJCWlmIChjaGFuZ2UuYWN0aW9uID09IElOU0VSVElPTikgewoJCQkJCQl2YXIgZHVtbXkgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQkJCQkJZHVtbXkua2V5ID0gZGF0YVtjaGFuZ2UuaW5kZXhdLmF0dHJzLmtleQoJCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShkdW1teSwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2NoYW5nZS5pbmRleF0pCgkJCQkJCW5ld0NhY2hlZC5zcGxpY2UoY2hhbmdlLmluZGV4LCAwLCB7YXR0cnM6IHtrZXk6IGRhdGFbY2hhbmdlLmluZGV4XS5hdHRycy5rZXl9LCBub2RlczogW2R1bW15XX0pCgkJCQkJfQoKCQkJCQlpZiAoY2hhbmdlLmFjdGlvbiA9PSBNT1ZFKSB7CgkJCQkJCWlmIChwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbY2hhbmdlLmluZGV4XSAhPT0gY2hhbmdlLmVsZW1lbnQgJiYgY2hhbmdlLmVsZW1lbnQgIT09IG51bGwpIHsKCQkJCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNoYW5nZS5lbGVtZW50LCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbY2hhbmdlLmluZGV4XSkKCQkJCQkJfQoJCQkJCQluZXdDYWNoZWRbY2hhbmdlLmluZGV4XSA9IGNhY2hlZFtjaGFuZ2UuZnJvbV0KCQkJCQl9CgkJCQl9CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHVua2V5ZWQubGVuZ3RoOyBpKyspIHsKCQkJCQl2YXIgY2hhbmdlID0gdW5rZXllZFtpXQoJCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNoYW5nZS5lbGVtZW50LCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbY2hhbmdlLmluZGV4XSkKCQkJCQluZXdDYWNoZWRbY2hhbmdlLmluZGV4XSA9IGNhY2hlZFtjaGFuZ2UuaW5kZXhdCgkJCQl9CgkJCQljYWNoZWQgPSBuZXdDYWNoZWQKCQkJCWNhY2hlZC5ub2RlcyA9IFtdCgkJCQlmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2ldOyBpKyspIGNhY2hlZC5ub2Rlcy5wdXNoKGNoaWxkKQoJCQl9CgkJCS8vZW5kIGtleSBhbGdvcml0aG0KCgkJCWZvciAodmFyIGkgPSAwLCBjYWNoZUNvdW50ID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKCQkJCS8vZGlmZiBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5CgkJCQl2YXIgaXRlbSA9IGJ1aWxkKHBhcmVudEVsZW1lbnQsIHBhcmVudFRhZywgY2FjaGVkLCBpbmRleCwgZGF0YVtpXSwgY2FjaGVkW2NhY2hlQ291bnRdLCBzaG91bGRSZWF0dGFjaCwgaW5kZXggKyBzdWJBcnJheUNvdW50IHx8IHN1YkFycmF5Q291bnQsIGVkaXRhYmxlLCBuYW1lc3BhY2UsIGNvbmZpZ3MpCgkJCQlpZiAoaXRlbSA9PT0gdW5kZWZpbmVkKSBjb250aW51ZQoJCQkJaWYgKCFpdGVtLm5vZGVzLmludGFjdCkgaW50YWN0ID0gZmFsc2UKCQkJCXZhciBpc0FycmF5ID0gdHlwZS5jYWxsKGl0ZW0pID09ICJbb2JqZWN0IEFycmF5XSIKCQkJCXN1YkFycmF5Q291bnQgKz0gaXNBcnJheSA/IGl0ZW0ubGVuZ3RoIDogMQoJCQkJY2FjaGVkW2NhY2hlQ291bnQrK10gPSBpdGVtCgkJCX0KCQkJaWYgKCFpbnRhY3QpIHsKCQkJCS8vZGlmZiB0aGUgYXJyYXkgaXRzZWxmCgkJCQkKCQkJCS8vdXBkYXRlIHRoZSBsaXN0IG9mIERPTSBub2RlcyBieSBjb2xsZWN0aW5nIHRoZSBub2RlcyBmcm9tIGVhY2ggaXRlbQoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQkJaWYgKGNhY2hlZFtpXSAhPSBudWxsKSBub2RlcyA9IG5vZGVzLmNvbmNhdChjYWNoZWRbaV0ubm9kZXMpCgkJCQl9CgkJCQkvL3JlbW92ZSBpdGVtcyBmcm9tIHRoZSBlbmQgb2YgdGhlIGFycmF5IGlmIHRoZSBuZXcgYXJyYXkgaXMgc2hvcnRlciB0aGFuIHRoZSBvbGQgb25lCgkJCQkvL2lmIGVycm9ycyBldmVyIGhhcHBlbiBoZXJlLCB0aGUgaXNzdWUgaXMgbW9zdCBsaWtlbHkgYSBidWcgaW4gdGhlIGNvbnN0cnVjdGlvbiBvZiB0aGUgYGNhY2hlZGAgZGF0YSBzdHJ1Y3R1cmUgc29tZXdoZXJlIGVhcmxpZXIgaW4gdGhlIHByb2dyYW0KCQkJCWZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gY2FjaGVkLm5vZGVzW2ldOyBpKyspIHsKCQkJCQlpZiAobm9kZS5wYXJlbnROb2RlICE9IG51bGwgJiYgbm9kZXMuaW5kZXhPZihub2RlKSA8IDApIGNsZWFyKFtub2RlXSwgW2NhY2hlZFtpXV0pCgkJCQl9CgkJCQkvL2FkZCBpdGVtcyB0byB0aGUgZW5kIGlmIHRoZSBuZXcgYXJyYXkgaXMgbG9uZ2VyIHRoYW4gdGhlIG9sZCBvbmUKCQkJCWZvciAodmFyIGkgPSBjYWNoZWQubm9kZXMubGVuZ3RoLCBub2RlOyBub2RlID0gbm9kZXNbaV07IGkrKykgewoJCQkJCWlmIChub2RlLnBhcmVudE5vZGUgPT0gbnVsbCkgcGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZChub2RlKQoJCQkJfQoJCQkJaWYgKGRhdGEubGVuZ3RoIDwgY2FjaGVkLmxlbmd0aCkgY2FjaGVkLmxlbmd0aCA9IGRhdGEubGVuZ3RoCgkJCQljYWNoZWQubm9kZXMgPSBub2RlcwoJCQl9CgkJfQoJCWVsc2UgaWYgKGRhdGEgIT0gbnVsbCAmJiBkYXRhVHlwZSA9PSAiW29iamVjdCBPYmplY3RdIikgewoJCQkvL2lmIGFuIGVsZW1lbnQgaXMgZGlmZmVyZW50IGVub3VnaCBmcm9tIHRoZSBvbmUgaW4gY2FjaGUsIHJlY3JlYXRlIGl0CgkJCWlmIChkYXRhLnRhZyAhPSBjYWNoZWQudGFnIHx8IE9iamVjdC5rZXlzKGRhdGEuYXR0cnMpLmpvaW4oKSAhPSBPYmplY3Qua2V5cyhjYWNoZWQuYXR0cnMpLmpvaW4oKSB8fCBkYXRhLmF0dHJzLmlkICE9IGNhY2hlZC5hdHRycy5pZCkgewoJCQkJY2xlYXIoY2FjaGVkLm5vZGVzKQoJCQkJaWYgKGNhY2hlZC5jb25maWdDb250ZXh0ICYmIHR5cGVvZiBjYWNoZWQuY29uZmlnQ29udGV4dC5vbnVubG9hZCA9PSAiZnVuY3Rpb24iKSBjYWNoZWQuY29uZmlnQ29udGV4dC5vbnVubG9hZCgpCgkJCX0KCQkJaWYgKHR5cGVvZiBkYXRhLnRhZyAhPSAic3RyaW5nIikgcmV0dXJuCgoJCQl2YXIgbm9kZSwgaXNOZXcgPSBjYWNoZWQubm9kZXMubGVuZ3RoID09PSAwCgkJCWlmIChkYXRhLmF0dHJzLnhtbG5zKSBuYW1lc3BhY2UgPSBkYXRhLmF0dHJzLnhtbG5zCgkJCWVsc2UgaWYgKGRhdGEudGFnID09PSAic3ZnIikgbmFtZXNwYWNlID0gImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgoJCQllbHNlIGlmIChkYXRhLnRhZyA9PT0gIm1hdGgiKSBuYW1lc3BhY2UgPSAiaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCIKCQkJaWYgKGlzTmV3KSB7CgkJCQlub2RlID0gbmFtZXNwYWNlID09PSB1bmRlZmluZWQgPyB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudChkYXRhLnRhZykgOiB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZSwgZGF0YS50YWcpCgkJCQljYWNoZWQgPSB7CgkJCQkJdGFnOiBkYXRhLnRhZywKCQkJCQkvL3Byb2Nlc3MgY2hpbGRyZW4gYmVmb3JlIGF0dHJzIHNvIHRoYXQgc2VsZWN0LnZhbHVlIHdvcmtzIGNvcnJlY3RseQoJCQkJCWNoaWxkcmVuOiBidWlsZChub2RlLCBkYXRhLnRhZywgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGRhdGEuY2hpbGRyZW4sIGNhY2hlZC5jaGlsZHJlbiwgdHJ1ZSwgMCwgZGF0YS5hdHRycy5jb250ZW50ZWRpdGFibGUgPyBub2RlIDogZWRpdGFibGUsIG5hbWVzcGFjZSwgY29uZmlncyksCgkJCQkJYXR0cnM6IHNldEF0dHJpYnV0ZXMobm9kZSwgZGF0YS50YWcsIGRhdGEuYXR0cnMsIHt9LCBuYW1lc3BhY2UpLAoJCQkJCW5vZGVzOiBbbm9kZV0KCQkJCX0KCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJfQoJCQllbHNlIHsKCQkJCW5vZGUgPSBjYWNoZWQubm9kZXNbMF0KCQkJCXNldEF0dHJpYnV0ZXMobm9kZSwgZGF0YS50YWcsIGRhdGEuYXR0cnMsIGNhY2hlZC5hdHRycywgbmFtZXNwYWNlKQoJCQkJY2FjaGVkLmNoaWxkcmVuID0gYnVpbGQobm9kZSwgZGF0YS50YWcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBkYXRhLmNoaWxkcmVuLCBjYWNoZWQuY2hpbGRyZW4sIGZhbHNlLCAwLCBkYXRhLmF0dHJzLmNvbnRlbnRlZGl0YWJsZSA/IG5vZGUgOiBlZGl0YWJsZSwgbmFtZXNwYWNlLCBjb25maWdzKQoJCQkJY2FjaGVkLm5vZGVzLmludGFjdCA9IHRydWUKCQkJCWlmIChzaG91bGRSZWF0dGFjaCA9PT0gdHJ1ZSAmJiBub2RlICE9IG51bGwpIHBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJfQoJCQkvL3NjaGVkdWxlIGNvbmZpZ3MgdG8gYmUgY2FsbGVkLiBUaGV5IGFyZSBjYWxsZWQgYWZ0ZXIgYGJ1aWxkYCBmaW5pc2hlcyBydW5uaW5nCgkJCWlmICh0eXBlb2YgZGF0YS5hdHRyc1siY29uZmlnIl0gPT09ICJmdW5jdGlvbiIpIHsKCQkJCWNvbmZpZ3MucHVzaChkYXRhLmF0dHJzWyJjb25maWciXS5iaW5kKHdpbmRvdywgbm9kZSwgIWlzTmV3LCBjYWNoZWQuY29uZmlnQ29udGV4dCA9IGNhY2hlZC5jb25maWdDb250ZXh0IHx8IHt9LCBjYWNoZWQpKQoJCQl9CgkJfQoJCWVsc2UgaWYgKHR5cGVvZiBkYXRhVHlwZSAhPSAiZnVuY3Rpb24iKSB7CgkJCS8vaGFuZGxlIHRleHQgbm9kZXMKCQkJdmFyIG5vZGVzCgkJCWlmIChjYWNoZWQubm9kZXMubGVuZ3RoID09PSAwKSB7CgkJCQlpZiAoZGF0YS4kdHJ1c3RlZCkgewoJCQkJCW5vZGVzID0gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkKCQkJCX0KCQkJCWVsc2UgewoJCQkJCW5vZGVzID0gW3dpbmRvdy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShkYXRhKV0KCQkJCQlpZiAoIXBhcmVudEVsZW1lbnQubm9kZU5hbWUubWF0Y2godm9pZEVsZW1lbnRzKSkgcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUobm9kZXNbMF0sIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJCX0KCQkJCWNhY2hlZCA9ICJzdHJpbmcgbnVtYmVyIGJvb2xlYW4iLmluZGV4T2YodHlwZW9mIGRhdGEpID4gLTEgPyBuZXcgZGF0YS5jb25zdHJ1Y3RvcihkYXRhKSA6IGRhdGEKCQkJCWNhY2hlZC5ub2RlcyA9IG5vZGVzCgkJCX0KCQkJZWxzZSBpZiAoY2FjaGVkLnZhbHVlT2YoKSAhPT0gZGF0YS52YWx1ZU9mKCkgfHwgc2hvdWxkUmVhdHRhY2ggPT09IHRydWUpIHsKCQkJCW5vZGVzID0gY2FjaGVkLm5vZGVzCgkJCQlpZiAoIWVkaXRhYmxlIHx8IGVkaXRhYmxlICE9PSB3aW5kb3cuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgewoJCQkJCWlmIChkYXRhLiR0cnVzdGVkKSB7CgkJCQkJCWNsZWFyKG5vZGVzLCBjYWNoZWQpCgkJCQkJCW5vZGVzID0gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkKCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCS8vY29ybmVyIGNhc2U6IHJlcGxhY2luZyB0aGUgbm9kZVZhbHVlIG9mIGEgdGV4dCBub2RlIHRoYXQgaXMgYSBjaGlsZCBvZiBhIHRleHRhcmVhL2NvbnRlbnRlZGl0YWJsZSBkb2Vzbid0IHdvcmsKCQkJCQkJLy93ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgdmFsdWUgcHJvcGVydHkgb2YgdGhlIHBhcmVudCB0ZXh0YXJlYSBvciB0aGUgaW5uZXJIVE1MIG9mIHRoZSBjb250ZW50ZWRpdGFibGUgZWxlbWVudCBpbnN0ZWFkCgkJCQkJCWlmIChwYXJlbnRUYWcgPT09ICJ0ZXh0YXJlYSIpIHBhcmVudEVsZW1lbnQudmFsdWUgPSBkYXRhCgkJCQkJCWVsc2UgaWYgKGVkaXRhYmxlKSBlZGl0YWJsZS5pbm5lckhUTUwgPSBkYXRhCgkJCQkJCWVsc2UgewoJCQkJCQkJaWYgKG5vZGVzWzBdLm5vZGVUeXBlID09IDEgfHwgbm9kZXMubGVuZ3RoID4gMSkgeyAvL3dhcyBhIHRydXN0ZWQgc3RyaW5nCgkJCQkJCQkJY2xlYXIoY2FjaGVkLm5vZGVzLCBjYWNoZWQpCgkJCQkJCQkJbm9kZXMgPSBbd2luZG93LmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGRhdGEpXQoJCQkJCQkJfQoJCQkJCQkJcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUobm9kZXNbMF0sIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJCQkJCW5vZGVzWzBdLm5vZGVWYWx1ZSA9IGRhdGEKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJCWNhY2hlZCA9IG5ldyBkYXRhLmNvbnN0cnVjdG9yKGRhdGEpCgkJCQljYWNoZWQubm9kZXMgPSBub2RlcwoJCQl9CgkJCWVsc2UgY2FjaGVkLm5vZGVzLmludGFjdCA9IHRydWUKCQl9CgoJCXJldHVybiBjYWNoZWQKCX0KCWZ1bmN0aW9uIHNldEF0dHJpYnV0ZXMobm9kZSwgdGFnLCBkYXRhQXR0cnMsIGNhY2hlZEF0dHJzLCBuYW1lc3BhY2UpIHsKCQl2YXIgZ3JvdXBzID0ge30KCQlmb3IgKHZhciBhdHRyTmFtZSBpbiBkYXRhQXR0cnMpIHsKCQkJdmFyIGRhdGFBdHRyID0gZGF0YUF0dHJzW2F0dHJOYW1lXQoJCQl2YXIgY2FjaGVkQXR0ciA9IGNhY2hlZEF0dHJzW2F0dHJOYW1lXQoJCQlpZiAoIShhdHRyTmFtZSBpbiBjYWNoZWRBdHRycykgfHwgKGNhY2hlZEF0dHIgIT09IGRhdGFBdHRyKSB8fCBub2RlID09PSB3aW5kb3cuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgewoJCQkJY2FjaGVkQXR0cnNbYXR0ck5hbWVdID0gZGF0YUF0dHIKCQkJCWlmIChhdHRyTmFtZSA9PT0gImNvbmZpZyIpIGNvbnRpbnVlCgkJCQllbHNlIGlmICh0eXBlb2YgZGF0YUF0dHIgPT0gImZ1bmN0aW9uIiAmJiBhdHRyTmFtZS5pbmRleE9mKCJvbiIpID09IDApIHsKCQkJCQlub2RlW2F0dHJOYW1lXSA9IGF1dG9yZWRyYXcoZGF0YUF0dHIsIG5vZGUpCgkJCQl9CgkJCQllbHNlIGlmIChhdHRyTmFtZSA9PT0gInN0eWxlIiAmJiB0eXBlb2YgZGF0YUF0dHIgPT0gIm9iamVjdCIpIHsKCQkJCQlmb3IgKHZhciBydWxlIGluIGRhdGFBdHRyKSB7CgkJCQkJCWlmIChjYWNoZWRBdHRyID09IG51bGwgfHwgY2FjaGVkQXR0cltydWxlXSAhPT0gZGF0YUF0dHJbcnVsZV0pIG5vZGUuc3R5bGVbcnVsZV0gPSBkYXRhQXR0cltydWxlXQoJCQkJCX0KCQkJCQlmb3IgKHZhciBydWxlIGluIGNhY2hlZEF0dHIpIHsKCQkJCQkJaWYgKCEocnVsZSBpbiBkYXRhQXR0cikpIG5vZGUuc3R5bGVbcnVsZV0gPSAiIgoJCQkJCX0KCQkJCX0KCQkJCWVsc2UgaWYgKG5hbWVzcGFjZSAhPSBudWxsKSB7CgkJCQkJaWYgKGF0dHJOYW1lID09PSAiaHJlZiIpIG5vZGUuc2V0QXR0cmlidXRlTlMoImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLCAiaHJlZiIsIGRhdGFBdHRyKQoJCQkJCWVsc2UgaWYgKGF0dHJOYW1lID09PSAiY2xhc3NOYW1lIikgbm9kZS5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgZGF0YUF0dHIpCgkJCQkJZWxzZSBub2RlLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgZGF0YUF0dHIpCgkJCQl9CgkJCQllbHNlIGlmIChhdHRyTmFtZSA9PT0gInZhbHVlIiAmJiB0YWcgPT09ICJpbnB1dCIpIHsKCQkJCQlpZiAobm9kZS52YWx1ZSAhPT0gZGF0YUF0dHIpIG5vZGUudmFsdWUgPSBkYXRhQXR0cgoJCQkJfQoJCQkJZWxzZSBpZiAoYXR0ck5hbWUgaW4gbm9kZSAmJiAhKGF0dHJOYW1lID09ICJsaXN0IiB8fCBhdHRyTmFtZSA9PSAic3R5bGUiKSkgewoJCQkJCW5vZGVbYXR0ck5hbWVdID0gZGF0YUF0dHIKCQkJCX0KCQkJCWVsc2Ugbm9kZS5zZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGRhdGFBdHRyKQoJCQl9CgkJfQoJCXJldHVybiBjYWNoZWRBdHRycwoJfQoJZnVuY3Rpb24gY2xlYXIobm9kZXMsIGNhY2hlZCkgewoJCWZvciAodmFyIGkgPSBub2Rlcy5sZW5ndGggLSAxOyBpID4gLTE7IGktLSkgewoJCQlpZiAobm9kZXNbaV0gJiYgbm9kZXNbaV0ucGFyZW50Tm9kZSkgewoJCQkJbm9kZXNbaV0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2Rlc1tpXSkKCQkJCWNhY2hlZCA9IFtdLmNvbmNhdChjYWNoZWQpCgkJCQlpZiAoY2FjaGVkW2ldKSB1bmxvYWQoY2FjaGVkW2ldKQoJCQl9CgkJfQoJCWlmIChub2Rlcy5sZW5ndGggIT0gMCkgbm9kZXMubGVuZ3RoID0gMAoJfQoJZnVuY3Rpb24gdW5sb2FkKGNhY2hlZCkgewoJCWlmIChjYWNoZWQuY29uZmlnQ29udGV4dCAmJiB0eXBlb2YgY2FjaGVkLmNvbmZpZ0NvbnRleHQub251bmxvYWQgPT0gImZ1bmN0aW9uIikgY2FjaGVkLmNvbmZpZ0NvbnRleHQub251bmxvYWQoKQoJCWlmIChjYWNoZWQuY2hpbGRyZW4pIHsKCQkJaWYgKHR5cGUuY2FsbChjYWNoZWQuY2hpbGRyZW4pID09ICJbb2JqZWN0IEFycmF5XSIpIGZvciAodmFyIGkgPSAwOyBpIDwgY2FjaGVkLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB1bmxvYWQoY2FjaGVkLmNoaWxkcmVuW2ldKQoJCQllbHNlIGlmIChjYWNoZWQuY2hpbGRyZW4udGFnKSB1bmxvYWQoY2FjaGVkLmNoaWxkcmVuKQoJCX0KCX0KCWZ1bmN0aW9uIGluamVjdEhUTUwocGFyZW50RWxlbWVudCwgaW5kZXgsIGRhdGEpIHsKCQl2YXIgbmV4dFNpYmxpbmcgPSBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdCgkJaWYgKG5leHRTaWJsaW5nKSB7CgkJCXZhciBpc0VsZW1lbnQgPSBuZXh0U2libGluZy5ub2RlVHlwZSAhPSAxCgkJCXZhciBwbGFjZWhvbGRlciA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIikKCQkJaWYgKGlzRWxlbWVudCkgewoJCQkJcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUocGxhY2Vob2xkZXIsIG5leHRTaWJsaW5nKQoJCQkJcGxhY2Vob2xkZXIuaW5zZXJ0QWRqYWNlbnRIVE1MKCJiZWZvcmViZWdpbiIsIGRhdGEpCgkJCQlwYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKHBsYWNlaG9sZGVyKQoJCQl9CgkJCWVsc2UgbmV4dFNpYmxpbmcuaW5zZXJ0QWRqYWNlbnRIVE1MKCJiZWZvcmViZWdpbiIsIGRhdGEpCgkJfQoJCWVsc2UgcGFyZW50RWxlbWVudC5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWVuZCIsIGRhdGEpCgkJdmFyIG5vZGVzID0gW10KCQl3aGlsZSAocGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSAhPT0gbmV4dFNpYmxpbmcpIHsKCQkJbm9kZXMucHVzaChwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdKQoJCQlpbmRleCsrCgkJfQoJCXJldHVybiBub2RlcwoJfQoJZnVuY3Rpb24gZmxhdHRlbihkYXRhKSB7CgkJdmFyIGZsYXR0ZW5lZCA9IFtdCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBpdGVtID0gZGF0YVtpXQoJCQlpZiAodHlwZS5jYWxsKGl0ZW0pID09ICJbb2JqZWN0IEFycmF5XSIpIGZsYXR0ZW5lZC5wdXNoLmFwcGx5KGZsYXR0ZW5lZCwgZmxhdHRlbihpdGVtKSkKCQkJZWxzZSBmbGF0dGVuZWQucHVzaChpdGVtKQoJCX0KCQlyZXR1cm4gZmxhdHRlbmVkCgl9CglmdW5jdGlvbiBhdXRvcmVkcmF3KGNhbGxiYWNrLCBvYmplY3QsIGdyb3VwKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKGUpIHsKCQkJZSA9IGUgfHwgZXZlbnQKCQkJbS5yZWRyYXcuc3RyYXRlZ3koImRpZmYiKQoJCQltLnN0YXJ0Q29tcHV0YXRpb24oKQoJCQl0cnkge3JldHVybiBjYWxsYmFjay5jYWxsKG9iamVjdCwgZSl9CgkJCWZpbmFsbHkgewoJCQkJaWYgKCFsYXN0UmVkcmF3SWQpIGxhc3RSZWRyYXdJZCA9IC0xOwoJCQkJbS5lbmRDb21wdXRhdGlvbigpCgkJCX0KCQl9Cgl9CgoJdmFyIGh0bWwKCXZhciBkb2N1bWVudE5vZGUgPSB7CgkJaW5zZXJ0QWRqYWNlbnRIVE1MOiBmdW5jdGlvbihfLCBkYXRhKSB7CgkJCXdpbmRvdy5kb2N1bWVudC53cml0ZShkYXRhKQoJCQl3aW5kb3cuZG9jdW1lbnQuY2xvc2UoKQoJCX0sCgkJYXBwZW5kQ2hpbGQ6IGZ1bmN0aW9uKG5vZGUpIHsKCQkJaWYgKGh0bWwgPT09IHVuZGVmaW5lZCkgaHRtbCA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJodG1sIikKCQkJaWYgKG5vZGUubm9kZU5hbWUgPT0gIkhUTUwiKSBodG1sID0gbm9kZQoJCQllbHNlIGh0bWwuYXBwZW5kQ2hpbGQobm9kZSkKCQkJaWYgKHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAhPT0gaHRtbCkgewoJCQkJd2luZG93LmRvY3VtZW50LnJlcGxhY2VDaGlsZChodG1sLCB3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KQoJCQl9CgkJCWVsc2Ugd2luZG93LmRvY3VtZW50LmFwcGVuZENoaWxkKGh0bWwpCgkJfSwKCQlpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKG5vZGUpIHsKCQkJdGhpcy5hcHBlbmRDaGlsZChub2RlKQoJCX0sCgkJY2hpbGROb2RlczogW10KCX0KCXZhciBub2RlQ2FjaGUgPSBbXSwgY2VsbENhY2hlID0ge30KCW0ucmVuZGVyID0gZnVuY3Rpb24ocm9vdCwgY2VsbCwgZm9yY2VSZWNyZWF0aW9uKSB7CgkJdmFyIGNvbmZpZ3MgPSBbXQoJCWlmICghcm9vdCkgdGhyb3cgbmV3IEVycm9yKCJQbGVhc2UgZW5zdXJlIHRoZSBET00gZWxlbWVudCBleGlzdHMgYmVmb3JlIHJlbmRlcmluZyBhIHRlbXBsYXRlIGludG8gaXQuIikKCQl2YXIgaWQgPSBnZXRDZWxsQ2FjaGVLZXkocm9vdCkKCQl2YXIgbm9kZSA9IHJvb3QgPT0gd2luZG93LmRvY3VtZW50IHx8IHJvb3QgPT0gd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCA/IGRvY3VtZW50Tm9kZSA6IHJvb3QKCQlpZiAoY2VsbENhY2hlW2lkXSA9PT0gdW5kZWZpbmVkKSBjbGVhcihub2RlLmNoaWxkTm9kZXMpCgkJaWYgKGZvcmNlUmVjcmVhdGlvbiA9PT0gdHJ1ZSkgcmVzZXQocm9vdCkKCQljZWxsQ2FjaGVbaWRdID0gYnVpbGQobm9kZSwgbnVsbCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNlbGwsIGNlbGxDYWNoZVtpZF0sIGZhbHNlLCAwLCBudWxsLCB1bmRlZmluZWQsIGNvbmZpZ3MpCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb25maWdzLmxlbmd0aDsgaSsrKSBjb25maWdzW2ldKCkKCX0KCWZ1bmN0aW9uIGdldENlbGxDYWNoZUtleShlbGVtZW50KSB7CgkJdmFyIGluZGV4ID0gbm9kZUNhY2hlLmluZGV4T2YoZWxlbWVudCkKCQlyZXR1cm4gaW5kZXggPCAwID8gbm9kZUNhY2hlLnB1c2goZWxlbWVudCkgLSAxIDogaW5kZXgKCX0KCgltLnRydXN0ID0gZnVuY3Rpb24odmFsdWUpIHsKCQl2YWx1ZSA9IG5ldyBTdHJpbmcodmFsdWUpCgkJdmFsdWUuJHRydXN0ZWQgPSB0cnVlCgkJcmV0dXJuIHZhbHVlCgl9CgoJZnVuY3Rpb24gX3Byb3Aoc3RvcmUpIHsKCQl2YXIgcHJvcCA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCkgc3RvcmUgPSBhcmd1bWVudHNbMF0KCQkJcmV0dXJuIHN0b3JlCgkJfQoKCQlwcm9wLnRvSlNPTiA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc3RvcmUKCQl9CgoJCXJldHVybiBwcm9wCgl9CgoJbS5wcm9wID0gZnVuY3Rpb24gKHN0b3JlKSB7CgkJaWYgKCh0eXBlb2Ygc3RvcmUgPT09ICdvYmplY3QnIHx8IHR5cGVvZiBzdG9yZSA9PT0gJ2Z1bmN0aW9uJykgJiYgc3RvcmUgIT09IG51bGwgJiYKCQkJCXR5cGVvZiBzdG9yZS50aGVuID09PSAnZnVuY3Rpb24nKSB7CgkJCXZhciBwcm9wID0gX3Byb3AoKQoJCQluZXdQcm9taXNlZFByb3AocHJvcCwgc3RvcmUpLnRoZW4ocHJvcCkKCgkJCXJldHVybiBwcm9wCgkJfQoKCQlyZXR1cm4gX3Byb3Aoc3RvcmUpCgl9CgoJdmFyIHJvb3RzID0gW10sIG1vZHVsZXMgPSBbXSwgY29udHJvbGxlcnMgPSBbXSwgbGFzdFJlZHJhd0lkID0gMCwgY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gbnVsbCwgcHJldmVudGVkID0gZmFsc2UKCW0ubW9kdWxlID0gZnVuY3Rpb24ocm9vdCwgbW9kdWxlKSB7CgkJdmFyIGluZGV4ID0gcm9vdHMuaW5kZXhPZihyb290KQoJCWlmIChpbmRleCA8IDApIGluZGV4ID0gcm9vdHMubGVuZ3RoCgkJdmFyIGlzUHJldmVudGVkID0gZmFsc2UKCQlpZiAoY29udHJvbGxlcnNbaW5kZXhdICYmIHR5cGVvZiBjb250cm9sbGVyc1tpbmRleF0ub251bmxvYWQgPT0gImZ1bmN0aW9uIikgewoJCQl2YXIgZXZlbnQgPSB7CgkJCQlwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7aXNQcmV2ZW50ZWQgPSB0cnVlfQoJCQl9CgkJCWNvbnRyb2xsZXJzW2luZGV4XS5vbnVubG9hZChldmVudCkKCQl9CgkJaWYgKCFpc1ByZXZlbnRlZCkgewoJCQltLnJlZHJhdy5zdHJhdGVneSgiYWxsIikKCQkJbS5zdGFydENvbXB1dGF0aW9uKCkKCQkJcm9vdHNbaW5kZXhdID0gcm9vdAoJCQltb2R1bGVzW2luZGV4XSA9IG1vZHVsZQoJCQljb250cm9sbGVyc1tpbmRleF0gPSBuZXcgbW9kdWxlLmNvbnRyb2xsZXIKCQkJbS5lbmRDb21wdXRhdGlvbigpCgkJfQoJfQoJbS5yZWRyYXcgPSBmdW5jdGlvbihmb3JjZSkgewoJCXZhciBjYW5jZWwgPSB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwgd2luZG93LmNsZWFyVGltZW91dAoJCXZhciBkZWZlciA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgd2luZG93LnNldFRpbWVvdXQKCQlpZiAobGFzdFJlZHJhd0lkICYmIGZvcmNlICE9PSB0cnVlKSB7CgkJCWNhbmNlbChsYXN0UmVkcmF3SWQpCgkJCWxhc3RSZWRyYXdJZCA9IGRlZmVyKHJlZHJhdywgMCkKCQl9CgkJZWxzZSB7CgkJCXJlZHJhdygpCgkJCWxhc3RSZWRyYXdJZCA9IGRlZmVyKGZ1bmN0aW9uKCkge2xhc3RSZWRyYXdJZCA9IG51bGx9LCAwKQoJCX0KCX0KCW0ucmVkcmF3LnN0cmF0ZWd5ID0gbS5wcm9wKCkKCWZ1bmN0aW9uIHJlZHJhdygpIHsKCQl2YXIgbW9kZSA9IG0ucmVkcmF3LnN0cmF0ZWd5KCkKCQlmb3IgKHZhciBpID0gMDsgaSA8IHJvb3RzLmxlbmd0aDsgaSsrKSB7CgkJCWlmIChjb250cm9sbGVyc1tpXSAmJiBtb2RlICE9ICJub25lIikgbS5yZW5kZXIocm9vdHNbaV0sIG1vZHVsZXNbaV0udmlldyhjb250cm9sbGVyc1tpXSksIG1vZGUgPT0gImFsbCIpCgkJfQoJCWlmIChjb21wdXRlUG9zdFJlZHJhd0hvb2spIHsKCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rKCkKCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gbnVsbAoJCX0KCQlsYXN0UmVkcmF3SWQgPSBudWxsCgkJbS5yZWRyYXcuc3RyYXRlZ3koImRpZmYiKQoJfQoKCXZhciBwZW5kaW5nUmVxdWVzdHMgPSAwCgltLnN0YXJ0Q29tcHV0YXRpb24gPSBmdW5jdGlvbigpIHtwZW5kaW5nUmVxdWVzdHMrK30KCW0uZW5kQ29tcHV0YXRpb24gPSBmdW5jdGlvbigpIHsKCQlwZW5kaW5nUmVxdWVzdHMgPSBNYXRoLm1heChwZW5kaW5nUmVxdWVzdHMgLSAxLCAwKQoJCWlmIChwZW5kaW5nUmVxdWVzdHMgPT0gMCkgbS5yZWRyYXcoKQoJfQoKCW0ud2l0aEF0dHIgPSBmdW5jdGlvbihwcm9wLCB3aXRoQXR0ckNhbGxiYWNrKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKGUpIHsKCQkJZSA9IGUgfHwgZXZlbnQKCQkJdmFyIGN1cnJlbnRUYXJnZXQgPSBlLmN1cnJlbnRUYXJnZXQgfHwgdGhpcwoJCQl3aXRoQXR0ckNhbGxiYWNrKHByb3AgaW4gY3VycmVudFRhcmdldCA/IGN1cnJlbnRUYXJnZXRbcHJvcF0gOiBjdXJyZW50VGFyZ2V0LmdldEF0dHJpYnV0ZShwcm9wKSkKCQl9Cgl9CgoJLy9yb3V0aW5nCgl2YXIgbW9kZXMgPSB7cGF0aG5hbWU6ICIiLCBoYXNoOiAiIyIsIHNlYXJjaDogIj8ifQoJdmFyIHJlZGlyZWN0ID0gZnVuY3Rpb24oKSB7fSwgcm91dGVQYXJhbXMgPSB7fSwgY3VycmVudFJvdXRlCgltLnJvdXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHJldHVybiBjdXJyZW50Um91dGUKCQllbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAzICYmIHR5cGVvZiBhcmd1bWVudHNbMV0gPT0gInN0cmluZyIpIHsKCQkJdmFyIHJvb3QgPSBhcmd1bWVudHNbMF0sIGRlZmF1bHRSb3V0ZSA9IGFyZ3VtZW50c1sxXSwgcm91dGVyID0gYXJndW1lbnRzWzJdCgkJCXJlZGlyZWN0ID0gZnVuY3Rpb24oc291cmNlKSB7CgkJCQl2YXIgcGF0aCA9IGN1cnJlbnRSb3V0ZSA9IG5vcm1hbGl6ZVJvdXRlKHNvdXJjZSkKCQkJCWlmICghcm91dGVCeVZhbHVlKHJvb3QsIHJvdXRlciwgcGF0aCkpIHsKCQkJCQltLnJvdXRlKGRlZmF1bHRSb3V0ZSwgdHJ1ZSkKCQkJCX0KCQkJfQoJCQl2YXIgbGlzdGVuZXIgPSBtLnJvdXRlLm1vZGUgPT0gImhhc2giID8gIm9uaGFzaGNoYW5nZSIgOiAib25wb3BzdGF0ZSIKCQkJd2luZG93W2xpc3RlbmVyXSA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKGN1cnJlbnRSb3V0ZSAhPSBub3JtYWxpemVSb3V0ZSh3aW5kb3cubG9jYXRpb25bbS5yb3V0ZS5tb2RlXSkpIHsKCQkJCQlyZWRpcmVjdCh3aW5kb3cubG9jYXRpb25bbS5yb3V0ZS5tb2RlXSkKCQkJCX0KCQkJfQoJCQljb21wdXRlUG9zdFJlZHJhd0hvb2sgPSBzZXRTY3JvbGwKCQkJd2luZG93W2xpc3RlbmVyXSgpCgkJfQoJCWVsc2UgaWYgKGFyZ3VtZW50c1swXS5hZGRFdmVudExpc3RlbmVyKSB7CgkJCXZhciBlbGVtZW50ID0gYXJndW1lbnRzWzBdCgkJCXZhciBpc0luaXRpYWxpemVkID0gYXJndW1lbnRzWzFdCgkJCWlmIChlbGVtZW50LmhyZWYuaW5kZXhPZihtb2Rlc1ttLnJvdXRlLm1vZGVdKSA8IDApIHsKCQkJCWVsZW1lbnQuaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSArIG1vZGVzW20ucm91dGUubW9kZV0gKyBlbGVtZW50LnBhdGhuYW1lCgkJCX0KCQkJaWYgKCFpc0luaXRpYWxpemVkKSB7CgkJCQllbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgcm91dGVVbm9idHJ1c2l2ZSkKCQkJCWVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCByb3V0ZVVub2J0cnVzaXZlKQoJCQl9CgkJfQoJCWVsc2UgaWYgKHR5cGVvZiBhcmd1bWVudHNbMF0gPT0gInN0cmluZyIpIHsKCQkJY3VycmVudFJvdXRlID0gYXJndW1lbnRzWzBdCgkJCXZhciBxdWVyeXN0cmluZyA9IHR5cGVvZiBhcmd1bWVudHNbMV0gPT0gIm9iamVjdCIgPyBidWlsZFF1ZXJ5U3RyaW5nKGFyZ3VtZW50c1sxXSkgOiBudWxsCgkJCWlmIChxdWVyeXN0cmluZykgY3VycmVudFJvdXRlICs9IChjdXJyZW50Um91dGUuaW5kZXhPZigiPyIpID09PSAtMSA/ICI/IiA6ICImIikgKyBxdWVyeXN0cmluZwoKCQkJdmFyIHNob3VsZFJlcGxhY2VIaXN0b3J5RW50cnkgPSAoYXJndW1lbnRzLmxlbmd0aCA9PSAzID8gYXJndW1lbnRzWzJdIDogYXJndW1lbnRzWzFdKSA9PT0gdHJ1ZQoKCQkJaWYgKHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSkgewoJCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gZnVuY3Rpb24oKSB7CgkJCQkJd2luZG93Lmhpc3Rvcnlbc2hvdWxkUmVwbGFjZUhpc3RvcnlFbnRyeSA/ICJyZXBsYWNlU3RhdGUiIDogInB1c2hTdGF0ZSJdKG51bGwsIHdpbmRvdy5kb2N1bWVudC50aXRsZSwgbW9kZXNbbS5yb3V0ZS5tb2RlXSArIGN1cnJlbnRSb3V0ZSkKCQkJCQlzZXRTY3JvbGwoKQoJCQkJfQoJCQkJcmVkaXJlY3QobW9kZXNbbS5yb3V0ZS5tb2RlXSArIGN1cnJlbnRSb3V0ZSkKCQkJfQoJCQllbHNlIHdpbmRvdy5sb2NhdGlvblttLnJvdXRlLm1vZGVdID0gY3VycmVudFJvdXRlCgkJfQoJfQoJbS5yb3V0ZS5wYXJhbSA9IGZ1bmN0aW9uKGtleSkge3JldHVybiByb3V0ZVBhcmFtc1trZXldfQoJbS5yb3V0ZS5tb2RlID0gInNlYXJjaCIKCWZ1bmN0aW9uIG5vcm1hbGl6ZVJvdXRlKHJvdXRlKSB7cmV0dXJuIHJvdXRlLnNsaWNlKG1vZGVzW20ucm91dGUubW9kZV0ubGVuZ3RoKX0KCWZ1bmN0aW9uIHJvdXRlQnlWYWx1ZShyb290LCByb3V0ZXIsIHBhdGgpIHsKCQlyb3V0ZVBhcmFtcyA9IHt9CgoJCXZhciBxdWVyeVN0YXJ0ID0gcGF0aC5pbmRleE9mKCI/IikKCQlpZiAocXVlcnlTdGFydCAhPT0gLTEpIHsKCQkJcm91dGVQYXJhbXMgPSBwYXJzZVF1ZXJ5U3RyaW5nKHBhdGguc3Vic3RyKHF1ZXJ5U3RhcnQgKyAxLCBwYXRoLmxlbmd0aCkpCgkJCXBhdGggPSBwYXRoLnN1YnN0cigwLCBxdWVyeVN0YXJ0KQoJCX0KCgkJZm9yICh2YXIgcm91dGUgaW4gcm91dGVyKSB7CgkJCWlmIChyb3V0ZSA9PSBwYXRoKSB7CgkJCQltLm1vZHVsZShyb290LCByb3V0ZXJbcm91dGVdKQoJCQkJcmV0dXJuIHRydWUKCQkJfQoKCQkJdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKCJeIiArIHJvdXRlLnJlcGxhY2UoLzpbXlwvXSs/XC57M30vZywgIiguKj8pIikucmVwbGFjZSgvOlteXC9dKy9nLCAiKFteXFwvXSspIikgKyAiXC8/JCIpCgoJCQlpZiAobWF0Y2hlci50ZXN0KHBhdGgpKSB7CgkJCQlwYXRoLnJlcGxhY2UobWF0Y2hlciwgZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGtleXMgPSByb3V0ZS5tYXRjaCgvOlteXC9dKy9nKSB8fCBbXQoJCQkJCXZhciB2YWx1ZXMgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSwgLTIpCgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSByb3V0ZVBhcmFtc1trZXlzW2ldLnJlcGxhY2UoLzp8XC4vZywgIiIpXSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZXNbaV0pCgkJCQkJbS5tb2R1bGUocm9vdCwgcm91dGVyW3JvdXRlXSkKCQkJCX0pCgkJCQlyZXR1cm4gdHJ1ZQoJCQl9CgkJfQoJfQoJZnVuY3Rpb24gcm91dGVVbm9idHJ1c2l2ZShlKSB7CgkJZSA9IGUgfHwgZXZlbnQKCQlpZiAoZS5jdHJsS2V5IHx8IGUubWV0YUtleSB8fCBlLndoaWNoID09IDIpIHJldHVybgoJCWUucHJldmVudERlZmF1bHQoKQoJCW0ucm91dGUoZS5jdXJyZW50VGFyZ2V0W20ucm91dGUubW9kZV0uc2xpY2UobW9kZXNbbS5yb3V0ZS5tb2RlXS5sZW5ndGgpKQoJfQoJZnVuY3Rpb24gc2V0U2Nyb2xsKCkgewoJCWlmIChtLnJvdXRlLm1vZGUgIT0gImhhc2giICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoKSB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoCgkJZWxzZSB3aW5kb3cuc2Nyb2xsVG8oMCwgMCkKCX0KCWZ1bmN0aW9uIGJ1aWxkUXVlcnlTdHJpbmcob2JqZWN0LCBwcmVmaXgpIHsKCQl2YXIgc3RyID0gW10KCQlmb3IodmFyIHByb3AgaW4gb2JqZWN0KSB7CgkJCXZhciBrZXkgPSBwcmVmaXggPyBwcmVmaXggKyAiWyIgKyBwcm9wICsgIl0iIDogcHJvcCwgdmFsdWUgPSBvYmplY3RbcHJvcF0KCQkJc3RyLnB1c2godHlwZW9mIHZhbHVlID09ICJvYmplY3QiID8gYnVpbGRRdWVyeVN0cmluZyh2YWx1ZSwga2V5KSA6IGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKSkKCQl9CgkJcmV0dXJuIHN0ci5qb2luKCImIikKCX0KCWZ1bmN0aW9uIHBhcnNlUXVlcnlTdHJpbmcoc3RyKSB7CgkJdmFyIHBhaXJzID0gc3RyLnNwbGl0KCImIiksIHBhcmFtcyA9IHt9CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBwYWlycy5sZW5ndGg7IGkrKykgewoJCQl2YXIgcGFpciA9IHBhaXJzW2ldLnNwbGl0KCI9IikKCQkJcGFyYW1zW2RlY29kZVNwYWNlKHBhaXJbMF0pXSA9IHBhaXJbMV0gPyBkZWNvZGVTcGFjZShwYWlyWzFdKSA6IChwYWlyLmxlbmd0aCA9PT0gMSA/IHRydWUgOiAiIikKCQl9CgkJcmV0dXJuIHBhcmFtcwoJfQoJZnVuY3Rpb24gZGVjb2RlU3BhY2Uoc3RyaW5nKSB7CgkJcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChzdHJpbmcucmVwbGFjZSgvXCsvZywgIiAiKSkKCX0KCWZ1bmN0aW9uIHJlc2V0KHJvb3QpIHsKCQl2YXIgY2FjaGVLZXkgPSBnZXRDZWxsQ2FjaGVLZXkocm9vdCkKCQljbGVhcihyb290LmNoaWxkTm9kZXMsIGNlbGxDYWNoZVtjYWNoZUtleV0pCgkJY2VsbENhY2hlW2NhY2hlS2V5XSA9IHVuZGVmaW5lZAoJfQoKCWZ1bmN0aW9uIG5ld1Byb21pc2VkUHJvcChwcm9wLCBwcm9taXNlKSB7CgkJcHJvcC50aGVuID0gZnVuY3Rpb24gKCkgewoJCQl2YXIgbmV3UHJvcCA9IG0ucHJvcCgpCgkJCXJldHVybiBuZXdQcm9taXNlZFByb3AobmV3UHJvcCwKCQkJCXByb21pc2UudGhlbi5hcHBseShwcm9taXNlLCBhcmd1bWVudHMpLnRoZW4obmV3UHJvcCkpCgkJfQoJCXByb3AucHJvbWlzZSA9IHByb3AKCQlwcm9wLnJlc29sdmUgPSBmdW5jdGlvbiAodmFsKSB7CgkJCXByb3AodmFsKQoJCQlwcm9taXNlID0gcHJvbWlzZS5yZXNvbHZlLmFwcGx5KHByb21pc2UsIGFyZ3VtZW50cykKCQkJcmV0dXJuIHByb3AKCQl9CgkJcHJvcC5yZWplY3QgPSBmdW5jdGlvbiAoKSB7CgkJCXByb21pc2UgPSBwcm9taXNlLnJlamVjdC5hcHBseShwcm9taXNlLCBhcmd1bWVudHMpCgkJCXJldHVybiBwcm9wCgkJfQoKCQlyZXR1cm4gcHJvcAoJfQoJbS5kZWZlcnJlZCA9IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gbmV3UHJvbWlzZWRQcm9wKG0ucHJvcCgpLCBuZXcgRGVmZXJyZWQoKSkKCX0KCS8vIFByb21pei5taXRocmlsLmpzIHwgWm9sbWVpc3RlciB8IE1JVAoJZnVuY3Rpb24gRGVmZXJyZWQoZm4sIGVyKSB7CgkJLy8gc3RhdGVzCgkJLy8gMDogcGVuZGluZwoJCS8vIDE6IHJlc29sdmluZwoJCS8vIDI6IHJlamVjdGluZwoJCS8vIDM6IHJlc29sdmVkCgkJLy8gNDogcmVqZWN0ZWQKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXN0YXRlID0gMCwKCQkJdmFsID0gMCwKCQkJbmV4dCA9IFtdOwoKCQlzZWxmWydwcm9taXNlJ10gPSBzZWxmCgoJCXNlbGZbJ3Jlc29sdmUnXSA9IGZ1bmN0aW9uICh2KSB7CgkJCWlmICghc3RhdGUpIHsKCQkJCXZhbCA9IHYKCQkJCXN0YXRlID0gMQoKCQkJCWZpcmUoKQoJCQl9CgkJCXJldHVybiB0aGlzCgkJfQoKCQlzZWxmWydyZWplY3QnXSA9IGZ1bmN0aW9uICh2KSB7CgkJCWlmICghc3RhdGUpIHsKCQkJCXZhbCA9IHYKCQkJCXN0YXRlID0gMgoKCQkJCWZpcmUoKQoJCQl9CgkJCXJldHVybiB0aGlzCgkJfQoKCQlzZWxmWyd0aGVuJ10gPSBmdW5jdGlvbiAoZm4sIGVyKSB7CgkJCXZhciBkID0gbmV3IERlZmVycmVkKGZuLCBlcikKCQkJaWYgKHN0YXRlID09IDMpIHsKCQkJCWQucmVzb2x2ZSh2YWwpCgkJCX0KCQkJZWxzZSBpZiAoc3RhdGUgPT0gNCkgewoJCQkJZC5yZWplY3QodmFsKQoJCQl9CgkJCWVsc2UgewoJCQkJbmV4dC5wdXNoKGQpCgkJCX0KCQkJcmV0dXJuIGQKCQl9CgoJCXZhciBmaW5pc2ggPSBmdW5jdGlvbiAodHlwZSkgewoJCQlzdGF0ZSA9IHR5cGUgfHwgNAoJCQluZXh0Lm1hcChmdW5jdGlvbiAocCkgewoJCQkJc3RhdGUgPT0gMyAmJiBwLnJlc29sdmUodmFsKSB8fCBwLnJlamVjdCh2YWwpCgkJCX0pCgkJfQoKCQkvLyByZWYgOiByZWZlcmVuY2UgdG8gJ3RoZW4nIGZ1bmN0aW9uCgkJLy8gY2IsIGVjLCBjbiA6IHN1Y2Nlc3NDYWxsYmFjaywgZmFpbHVyZUNhbGxiYWNrLCBub3RUaGVubmFibGVDYWxsYmFjawoJCWZ1bmN0aW9uIHRoZW5uYWJsZSAocmVmLCBjYiwgZWMsIGNuKSB7CgkJCWlmICgodHlwZW9mIHZhbCA9PSAnb2JqZWN0JyB8fCB0eXBlb2YgdmFsID09ICdmdW5jdGlvbicpICYmIHR5cGVvZiByZWYgPT0gJ2Z1bmN0aW9uJykgewoJCQkJdHJ5IHsKCgkJCQkJLy8gY250IHByb3RlY3RzIGFnYWluc3QgYWJ1c2UgY2FsbHMgZnJvbSBzcGVjIGNoZWNrZXIKCQkJCQl2YXIgY250ID0gMAoJCQkJCXJlZi5jYWxsKHZhbCwgZnVuY3Rpb24gKHYpIHsKCQkJCQkJaWYgKGNudCsrKSByZXR1cm4KCQkJCQkJdmFsID0gdgoJCQkJCQljYigpCgkJCQkJfSwgZnVuY3Rpb24gKHYpIHsKCQkJCQkJaWYgKGNudCsrKSByZXR1cm4KCQkJCQkJdmFsID0gdgoJCQkJCQllYygpCgkJCQkJfSkKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQl2YWwgPSBlCgkJCQkJZWMoKQoJCQkJfQoJCQl9IGVsc2UgewoJCQkJY24oKQoJCQl9CgkJfTsKCgkJZnVuY3Rpb24gZmlyZSgpIHsKCgkJCS8vIGNoZWNrIGlmIGl0J3MgYSB0aGVuYWJsZQoJCQl2YXIgcmVmOwoJCQl0cnkgewoJCQkJcmVmID0gdmFsICYmIHZhbC50aGVuCgkJCX0gY2F0Y2ggKGUpIHsKCQkJCXZhbCA9IGUKCQkJCXN0YXRlID0gMgoJCQkJcmV0dXJuIGZpcmUoKQoJCQl9CgkJCXRoZW5uYWJsZShyZWYsIGZ1bmN0aW9uICgpIHsKCQkJCXN0YXRlID0gMQoJCQkJZmlyZSgpCgkJCX0sIGZ1bmN0aW9uICgpIHsKCQkJCXN0YXRlID0gMgoJCQkJZmlyZSgpCgkJCX0sIGZ1bmN0aW9uICgpIHsKCQkJCXRyeSB7CgkJCQkJaWYgKHN0YXRlID09IDEgJiYgdHlwZW9mIGZuID09ICdmdW5jdGlvbicpIHsKCQkJCQkJdmFsID0gZm4odmFsKQoJCQkJCX0KCgkJCQkJZWxzZSBpZiAoc3RhdGUgPT0gMiAmJiB0eXBlb2YgZXIgPT0gJ2Z1bmN0aW9uJykgewoJCQkJCQl2YWwgPSBlcih2YWwpCgkJCQkJCXN0YXRlID0gMQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQl2YWwgPSBlCgkJCQkJcmV0dXJuIGZpbmlzaCgpCgkJCQl9CgoJCQkJaWYgKHZhbCA9PSBzZWxmKSB7CgkJCQkJdmFsID0gVHlwZUVycm9yKCkKCQkJCQlmaW5pc2goKQoJCQkJfSBlbHNlIHRoZW5uYWJsZShyZWYsIGZ1bmN0aW9uICgpIHsKCQkJCQkJZmluaXNoKDMpCgkJCQkJfSwgZmluaXNoLCBmdW5jdGlvbiAoKSB7CgkJCQkJCWZpbmlzaChzdGF0ZSA9PSAxICYmIDMpCgkJCQkJfSkKCgkJCX0pCgkJfQoJfQoKCW0uc3luYyA9IGZ1bmN0aW9uKGFyZ3MpIHsKCQl2YXIgbWV0aG9kID0gInJlc29sdmUiCgkJZnVuY3Rpb24gc3luY2hyb25pemVyKHBvcywgcmVzb2x2ZWQpIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQlyZXN1bHRzW3Bvc10gPSB2YWx1ZQoJCQkJaWYgKCFyZXNvbHZlZCkgbWV0aG9kID0gInJlamVjdCIKCQkJCWlmICgtLW91dHN0YW5kaW5nID09IDApIHsKCQkJCQlkZWZlcnJlZC5wcm9taXNlKHJlc3VsdHMpCgkJCQkJZGVmZXJyZWRbbWV0aG9kXShyZXN1bHRzKQoJCQkJfQoJCQkJcmV0dXJuIHZhbHVlCgkJCX0KCQl9CgoJCXZhciBkZWZlcnJlZCA9IG0uZGVmZXJyZWQoKQoJCXZhciBvdXRzdGFuZGluZyA9IGFyZ3MubGVuZ3RoCgkJdmFyIHJlc3VsdHMgPSBuZXcgQXJyYXkob3V0c3RhbmRpbmcpCgkJaWYgKGFyZ3MubGVuZ3RoID4gMCkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKCQkJCWFyZ3NbaV0udGhlbihzeW5jaHJvbml6ZXIoaSwgdHJ1ZSksIHN5bmNocm9uaXplcihpLCBmYWxzZSkpCgkJCX0KCQl9CgkJZWxzZSBkZWZlcnJlZC5yZXNvbHZlKCkKCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UKCX0KCWZ1bmN0aW9uIGlkZW50aXR5KHZhbHVlKSB7cmV0dXJuIHZhbHVlfQoKCWZ1bmN0aW9uIGFqYXgob3B0aW9ucykgewoJCXZhciB4aHIgPSBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0CgkJeGhyLm9wZW4ob3B0aW9ucy5tZXRob2QsIG9wdGlvbnMudXJsLCB0cnVlLCBvcHRpb25zLnVzZXIsIG9wdGlvbnMucGFzc3dvcmQpCgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoeGhyLnJlYWR5U3RhdGUgPT09IDQpIHsKCQkJCWlmICh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSBvcHRpb25zLm9ubG9hZCh7dHlwZTogImxvYWQiLCB0YXJnZXQ6IHhocn0pCgkJCQllbHNlIG9wdGlvbnMub25lcnJvcih7dHlwZTogImVycm9yIiwgdGFyZ2V0OiB4aHJ9KQoJCQl9CgkJfQoJCWlmIChvcHRpb25zLnNlcmlhbGl6ZSA9PSBKU09OLnN0cmluZ2lmeSAmJiBvcHRpb25zLm1ldGhvZCAhPSAiR0VUIikgewoJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcigiQ29udGVudC1UeXBlIiwgImFwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgiKTsKCQl9CgkJaWYgKHR5cGVvZiBvcHRpb25zLmNvbmZpZyA9PSAiZnVuY3Rpb24iKSB7CgkJCXZhciBtYXliZVhociA9IG9wdGlvbnMuY29uZmlnKHhociwgb3B0aW9ucykKCQkJaWYgKG1heWJlWGhyICE9IG51bGwpIHhociA9IG1heWJlWGhyCgkJfQoJCXhoci5zZW5kKG9wdGlvbnMubWV0aG9kID09ICJHRVQiID8gIiIgOiBvcHRpb25zLmRhdGEpCgkJcmV0dXJuIHhocgoJfQoJZnVuY3Rpb24gYmluZERhdGEoeGhyT3B0aW9ucywgZGF0YSwgc2VyaWFsaXplKSB7CgkJaWYgKGRhdGEgJiYgT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoID4gMCkgewoJCQlpZiAoeGhyT3B0aW9ucy5tZXRob2QgPT0gIkdFVCIpIHsKCQkJCXhock9wdGlvbnMudXJsID0geGhyT3B0aW9ucy51cmwgKyAoeGhyT3B0aW9ucy51cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyBidWlsZFF1ZXJ5U3RyaW5nKGRhdGEpCgkJCX0KCQkJZWxzZSB4aHJPcHRpb25zLmRhdGEgPSBzZXJpYWxpemUoZGF0YSkKCQl9CgkJcmV0dXJuIHhock9wdGlvbnMKCX0KCWZ1bmN0aW9uIHBhcmFtZXRlcml6ZVVybCh1cmwsIGRhdGEpIHsKCQl2YXIgdG9rZW5zID0gdXJsLm1hdGNoKC86W2Etel1cdysvZ2kpCgkJaWYgKHRva2VucyAmJiBkYXRhKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CgkJCQl2YXIga2V5ID0gdG9rZW5zW2ldLnNsaWNlKDEpCgkJCQl1cmwgPSB1cmwucmVwbGFjZSh0b2tlbnNbaV0sIGRhdGFba2V5XSkKCQkJCWRlbGV0ZSBkYXRhW2tleV0KCQkJfQoJCX0KCQlyZXR1cm4gdXJsCgl9CgoJbS5yZXF1ZXN0ID0gZnVuY3Rpb24oeGhyT3B0aW9ucykgewoJCWlmICh4aHJPcHRpb25zLmJhY2tncm91bmQgIT09IHRydWUpIG0uc3RhcnRDb21wdXRhdGlvbigpCgkJdmFyIGRlZmVycmVkID0gbS5kZWZlcnJlZCgpCgkJdmFyIHNlcmlhbGl6ZSA9IHhock9wdGlvbnMuc2VyaWFsaXplID0geGhyT3B0aW9ucy5zZXJpYWxpemUgfHwgSlNPTi5zdHJpbmdpZnkKCQl2YXIgZGVzZXJpYWxpemUgPSB4aHJPcHRpb25zLmRlc2VyaWFsaXplID0geGhyT3B0aW9ucy5kZXNlcmlhbGl6ZSB8fCBKU09OLnBhcnNlCgkJdmFyIGV4dHJhY3QgPSB4aHJPcHRpb25zLmV4dHJhY3QgfHwgZnVuY3Rpb24oeGhyKSB7CgkJCXJldHVybiB4aHIucmVzcG9uc2VUZXh0Lmxlbmd0aCA9PT0gMCAmJiBkZXNlcmlhbGl6ZSA9PT0gSlNPTi5wYXJzZSA/IG51bGwgOiB4aHIucmVzcG9uc2VUZXh0CgkJfQoJCXhock9wdGlvbnMudXJsID0gcGFyYW1ldGVyaXplVXJsKHhock9wdGlvbnMudXJsLCB4aHJPcHRpb25zLmRhdGEpCgkJeGhyT3B0aW9ucyA9IGJpbmREYXRhKHhock9wdGlvbnMsIHhock9wdGlvbnMuZGF0YSwgc2VyaWFsaXplKQoJCXhock9wdGlvbnMub25sb2FkID0geGhyT3B0aW9ucy5vbmVycm9yID0gZnVuY3Rpb24oZSkgewoJCQl0cnkgewoJCQkJZSA9IGUgfHwgZXZlbnQKCQkJCXZhciB1bndyYXAgPSAoZS50eXBlID09ICJsb2FkIiA/IHhock9wdGlvbnMudW53cmFwU3VjY2VzcyA6IHhock9wdGlvbnMudW53cmFwRXJyb3IpIHx8IGlkZW50aXR5CgkJCQl2YXIgcmVzcG9uc2UgPSB1bndyYXAoZGVzZXJpYWxpemUoZXh0cmFjdChlLnRhcmdldCwgeGhyT3B0aW9ucykpKQoJCQkJaWYgKGUudHlwZSA9PSAibG9hZCIpIHsKCQkJCQlpZiAodHlwZS5jYWxsKHJlc3BvbnNlKSA9PSAiW29iamVjdCBBcnJheV0iICYmIHhock9wdGlvbnMudHlwZSkgewoJCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHJlc3BvbnNlLmxlbmd0aDsgaSsrKSByZXNwb25zZVtpXSA9IG5ldyB4aHJPcHRpb25zLnR5cGUocmVzcG9uc2VbaV0pCgkJCQkJfQoJCQkJCWVsc2UgaWYgKHhock9wdGlvbnMudHlwZSkgcmVzcG9uc2UgPSBuZXcgeGhyT3B0aW9ucy50eXBlKHJlc3BvbnNlKQoJCQkJfQoJCQkJZGVmZXJyZWRbZS50eXBlID09ICJsb2FkIiA/ICJyZXNvbHZlIiA6ICJyZWplY3QiXShyZXNwb25zZSkKCQkJfQoJCQljYXRjaCAoZSkgewoJCQkJaWYgKGUgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikgdGhyb3cgbmV3IFN5bnRheEVycm9yKCJDb3VsZCBub3QgcGFyc2UgSFRUUCByZXNwb25zZS4gU2VlIGh0dHA6Ly9saG9yaWUuZ2l0aHViLmlvL21pdGhyaWwvbWl0aHJpbC5yZXF1ZXN0Lmh0bWwjdXNpbmctdmFyaWFibGUtZGF0YS1mb3JtYXRzIikKCQkJCWVsc2UgaWYgKHR5cGUuY2FsbChlKSA9PSAiW29iamVjdCBFcnJvcl0iICYmIGUuY29uc3RydWN0b3IgIT09IEVycm9yKSB0aHJvdyBlCgkJCQllbHNlIGRlZmVycmVkLnJlamVjdChlKQoJCQl9CgkJCWlmICh4aHJPcHRpb25zLmJhY2tncm91bmQgIT09IHRydWUpIG0uZW5kQ29tcHV0YXRpb24oKQoJCX0KCQlhamF4KHhock9wdGlvbnMpCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UKCX0KCgkvL3Rlc3RpbmcgQVBJCgltLmRlcHMgPSBmdW5jdGlvbihtb2NrKSB7cmV0dXJuIHdpbmRvdyA9IG1vY2t9CgkvL2ZvciBpbnRlcm5hbCB0ZXN0aW5nIG9ubHksIGRvIG5vdCB1c2UgYG0uZGVwcy5mYWN0b3J5YAoJbS5kZXBzLmZhY3RvcnkgPSBhcHAKCglyZXR1cm4gbQp9KHR5cGVvZiB3aW5kb3cgIT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKCmlmICh0eXBlb2YgbW9kdWxlICE9ICJ1bmRlZmluZWQiICYmIG1vZHVsZSAhPT0gbnVsbCkgbW9kdWxlLmV4cG9ydHMgPSBtCmlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKGZ1bmN0aW9uKCkge3JldHVybiBtfSkKCjs7Ow==",
                "body": "TWl0aHJpbCA9IG0gPSBuZXcgZnVuY3Rpb24gYXBwKHdpbmRvdywgdW5kZWZpbmVkKSB7Cgl2YXIgdHlwZSA9IHt9LnRvU3RyaW5nCgl2YXIgcGFyc2VyID0gLyg/OihefCN8XC4pKFteI1wuXFtcXV0rKSl8KFxbLis/XF0pL2csIGF0dHJQYXJzZXIgPSAvXFsoLis/KSg/Oj0oInwnfCkoLio/KVwyKT9cXS8KCXZhciB2b2lkRWxlbWVudHMgPSAvQVJFQXxCQVNFfEJSfENPTHxDT01NQU5EfEVNQkVEfEhSfElNR3xJTlBVVHxLRVlHRU58TElOS3xNRVRBfFBBUkFNfFNPVVJDRXxUUuKAjOKAi0FDS3xXQlIvCgoJZnVuY3Rpb24gbSgpIHsKCQl2YXIgYXJncyA9IGFyZ3VtZW50cwoJCXZhciBoYXNBdHRycyA9IGFyZ3NbMV0gIT0gbnVsbCAmJiB0eXBlLmNhbGwoYXJnc1sxXSkgPT0gIltvYmplY3QgT2JqZWN0XSIgJiYgISgidGFnIiBpbiBhcmdzWzFdKSAmJiAhKCJzdWJ0cmVlIiBpbiBhcmdzWzFdKQoJCXZhciBhdHRycyA9IGhhc0F0dHJzID8gYXJnc1sxXSA6IHt9CgkJdmFyIGNsYXNzQXR0ck5hbWUgPSAiY2xhc3MiIGluIGF0dHJzID8gImNsYXNzIiA6ICJjbGFzc05hbWUiCgkJdmFyIGNlbGwgPSB7dGFnOiAiZGl2IiwgYXR0cnM6IHt9fQoJCXZhciBtYXRjaCwgY2xhc3NlcyA9IFtdCgkJd2hpbGUgKG1hdGNoID0gcGFyc2VyLmV4ZWMoYXJnc1swXSkpIHsKCQkJaWYgKG1hdGNoWzFdID09ICIiKSBjZWxsLnRhZyA9IG1hdGNoWzJdCgkJCWVsc2UgaWYgKG1hdGNoWzFdID09ICIjIikgY2VsbC5hdHRycy5pZCA9IG1hdGNoWzJdCgkJCWVsc2UgaWYgKG1hdGNoWzFdID09ICIuIikgY2xhc3Nlcy5wdXNoKG1hdGNoWzJdKQoJCQllbHNlIGlmIChtYXRjaFszXVswXSA9PSAiWyIpIHsKCQkJCXZhciBwYWlyID0gYXR0clBhcnNlci5leGVjKG1hdGNoWzNdKQoJCQkJY2VsbC5hdHRyc1twYWlyWzFdXSA9IHBhaXJbM10gfHwgKHBhaXJbMl0gPyAiIiA6dHJ1ZSkKCQkJfQoJCX0KCQlpZiAoY2xhc3Nlcy5sZW5ndGggPiAwKSBjZWxsLmF0dHJzW2NsYXNzQXR0ck5hbWVdID0gY2xhc3Nlcy5qb2luKCIgIikKCgkJY2VsbC5jaGlsZHJlbiA9IGhhc0F0dHJzID8gYXJnc1syXSA6IGFyZ3NbMV0KCgkJZm9yICh2YXIgYXR0ck5hbWUgaW4gYXR0cnMpIHsKCQkJaWYgKGF0dHJOYW1lID09IGNsYXNzQXR0ck5hbWUpIGNlbGwuYXR0cnNbYXR0ck5hbWVdID0gKGNlbGwuYXR0cnNbYXR0ck5hbWVdIHx8ICIiKSArICIgIiArIGF0dHJzW2F0dHJOYW1lXQoJCQllbHNlIGNlbGwuYXR0cnNbYXR0ck5hbWVdID0gYXR0cnNbYXR0ck5hbWVdCgkJfQoJCXJldHVybiBjZWxsCgl9CglmdW5jdGlvbiBidWlsZChwYXJlbnRFbGVtZW50LCBwYXJlbnRUYWcsIHBhcmVudENhY2hlLCBwYXJlbnRJbmRleCwgZGF0YSwgY2FjaGVkLCBzaG91bGRSZWF0dGFjaCwgaW5kZXgsIGVkaXRhYmxlLCBuYW1lc3BhY2UsIGNvbmZpZ3MpIHsKCQkvL2BidWlsZGAgaXMgYSByZWN1cnNpdmUgZnVuY3Rpb24gdGhhdCBtYW5hZ2VzIGNyZWF0aW9uL2RpZmZpbmcvcmVtb3ZhbCBvZiBET00gZWxlbWVudHMgYmFzZWQgb24gY29tcGFyaXNvbiBiZXR3ZWVuIGBkYXRhYCBhbmQgYGNhY2hlZGAKCQkvL3RoZSBkaWZmIGFsZ29yaXRobSBjYW4gYmUgc3VtbWFyaXplZCBhcyB0aGlzOgoJCS8vMSAtIGNvbXBhcmUgYGRhdGFgIGFuZCBgY2FjaGVkYAoJCS8vMiAtIGlmIHRoZXkgYXJlIGRpZmZlcmVudCwgY29weSBgZGF0YWAgdG8gYGNhY2hlZGAgYW5kIHVwZGF0ZSB0aGUgRE9NIGJhc2VkIG9uIHdoYXQgdGhlIGRpZmZlcmVuY2UgaXMKCQkvLzMgLSByZWN1cnNpdmVseSBhcHBseSB0aGlzIGFsZ29yaXRobSBmb3IgZXZlcnkgYXJyYXkgYW5kIGZvciB0aGUgY2hpbGRyZW4gb2YgZXZlcnkgdmlydHVhbCBlbGVtZW50CgkJCgkJLy90aGUgYGNhY2hlZGAgZGF0YSBzdHJ1Y3R1cmUgaXMgZXNzZW50aWFsbHkgdGhlIHNhbWUgYXMgdGhlIHByZXZpb3VzIHJlZHJhdydzIGBkYXRhYCBkYXRhIHN0cnVjdHVyZSwgd2l0aCBhIGZldyBhZGRpdGlvbnM6CgkJLy8tIGBjYWNoZWRgIGFsd2F5cyBoYXMgYSBwcm9wZXJ0eSBjYWxsZWQgYG5vZGVzYCwgd2hpY2ggaXMgYSBsaXN0IG9mIERPTSBlbGVtZW50cyB0aGF0IGNvcnJlc3BvbmQgdG8gdGhlIGRhdGEgcmVwcmVzZW50ZWQgYnkgdGhlIHJlc3BlY3RpdmUgdmlydHVhbCBlbGVtZW50CgkJLy8tIGluIG9yZGVyIHRvIHN1cHBvcnQgYXR0YWNoaW5nIGBub2Rlc2AgYXMgYSBwcm9wZXJ0eSBvZiBgY2FjaGVkYCwgYGNhY2hlZGAgaXMgKmFsd2F5cyogYSBub24tcHJpbWl0aXZlIG9iamVjdCwgaS5lLiBpZiB0aGUgZGF0YSB3YXMgYSBzdHJpbmcsIHRoZW4gY2FjaGVkIGlzIGEgU3RyaW5nIGluc3RhbmNlLiBJZiBkYXRhIHdhcyBgbnVsbGAgb3IgYHVuZGVmaW5lZGAsIGNhY2hlZCBpcyBgbmV3IFN0cmluZygiIilgCgkJLy8tIGBjYWNoZWQgYWxzbyBoYXMgYSBgY29uZmlnQ29udGV4dGAgcHJvcGVydHksIHdoaWNoIGlzIHRoZSBzdGF0ZSBzdG9yYWdlIG9iamVjdCBleHBvc2VkIGJ5IGNvbmZpZyhlbGVtZW50LCBpc0luaXRpYWxpemVkLCBjb250ZXh0KQoJCS8vLSB3aGVuIGBjYWNoZWRgIGlzIGFuIE9iamVjdCwgaXQgcmVwcmVzZW50cyBhIHZpcnR1YWwgZWxlbWVudDsgd2hlbiBpdCdzIGFuIEFycmF5LCBpdCByZXByZXNlbnRzIGEgbGlzdCBvZiBlbGVtZW50czsgd2hlbiBpdCdzIGEgU3RyaW5nLCBOdW1iZXIgb3IgQm9vbGVhbiwgaXQgcmVwcmVzZW50cyBhIHRleHQgbm9kZQoKCQkvL2BwYXJlbnRFbGVtZW50YCBpcyBhIERPTSBlbGVtZW50IHVzZWQgZm9yIFczQyBET00gQVBJIGNhbGxzCgkJLy9gcGFyZW50VGFnYCBpcyBvbmx5IHVzZWQgZm9yIGhhbmRsaW5nIGEgY29ybmVyIGNhc2UgZm9yIHRleHRhcmVhIHZhbHVlcwoJCS8vYHBhcmVudENhY2hlYCBpcyB1c2VkIHRvIHJlbW92ZSBub2RlcyBpbiBzb21lIG11bHRpLW5vZGUgY2FzZXMKCQkvL2BwYXJlbnRJbmRleGAgYW5kIGBpbmRleGAgYXJlIHVzZWQgdG8gZmlndXJlIG91dCB0aGUgb2Zmc2V0IG9mIG5vZGVzLiBUaGV5J3JlIGFydGlmYWN0cyBmcm9tIGJlZm9yZSBhcnJheXMgc3RhcnRlZCBiZWluZyBmbGF0dGVuZWQgYW5kIGFyZSBsaWtlbHkgcmVmYWN0b3JhYmxlCgkJLy9gZGF0YWAgYW5kIGBjYWNoZWRgIGFyZSwgcmVzcGVjdGl2ZWx5LCB0aGUgbmV3IGFuZCBvbGQgbm9kZXMgYmVpbmcgZGlmZmVkCgkJLy9gc2hvdWxkUmVhdHRhY2hgIGlzIGEgZmxhZyBpbmRpY2F0aW5nIHdoZXRoZXIgYSBwYXJlbnQgbm9kZSB3YXMgcmVjcmVhdGVkIChpZiBzbywgYW5kIGlmIHRoaXMgbm9kZSBpcyByZXVzZWQsIHRoZW4gdGhpcyBub2RlIG11c3QgcmVhdHRhY2ggaXRzZWxmIHRvIHRoZSBuZXcgcGFyZW50KQoJCS8vYGVkaXRhYmxlYCBpcyBhIGZsYWcgdGhhdCBpbmRpY2F0ZXMgd2hldGhlciBhbiBhbmNlc3RvciBpcyBjb250ZW50ZWRpdGFibGUKCQkvL2BuYW1lc3BhY2VgIGluZGljYXRlcyB0aGUgY2xvc2VzdCBIVE1MIG5hbWVzcGFjZSBhcyBpdCBjYXNjYWRlcyBkb3duIGZyb20gYW4gYW5jZXN0b3IKCQkvL2Bjb25maWdzYCBpcyBhIGxpc3Qgb2YgY29uZmlnIGZ1bmN0aW9ucyB0byBydW4gYWZ0ZXIgdGhlIHRvcG1vc3QgYGJ1aWxkYCBjYWxsIGZpbmlzaGVzIHJ1bm5pbmcKCgkJLy90aGVyZSdzIGxvZ2ljIHRoYXQgcmVsaWVzIG9uIHRoZSBhc3N1bXB0aW9uIHRoYXQgbnVsbCBhbmQgdW5kZWZpbmVkIGRhdGEgYXJlIGVxdWl2YWxlbnQgdG8gZW1wdHkgc3RyaW5ncwoJCS8vLSB0aGlzIHByZXZlbnRzIGxpZmVjeWNsZSBzdXJwcmlzZXMgZnJvbSBwcm9jZWR1cmFsIGhlbHBlcnMgdGhhdCBtaXggaW1wbGljaXQgYW5kIGV4cGxpY2l0IHJldHVybiBzdGF0ZW1lbnRzCgkJLy8tIGl0IHNpbXBsaWZpZXMgZGlmZmluZyBjb2RlCgkJaWYgKGRhdGEgPT0gbnVsbCkgZGF0YSA9ICIiCgkJaWYgKGRhdGEuc3VidHJlZSA9PT0gInJldGFpbiIpIHJldHVybiBjYWNoZWQKCgkJdmFyIGNhY2hlZFR5cGUgPSB0eXBlLmNhbGwoY2FjaGVkKSwgZGF0YVR5cGUgPSB0eXBlLmNhbGwoZGF0YSkKCQlpZiAoY2FjaGVkID09IG51bGwgfHwgY2FjaGVkVHlwZSAhPSBkYXRhVHlwZSkgewoJCQlpZiAoY2FjaGVkICE9IG51bGwpIHsKCQkJCWlmIChwYXJlbnRDYWNoZSAmJiBwYXJlbnRDYWNoZS5ub2RlcykgewoJCQkJCXZhciBvZmZzZXQgPSBpbmRleCAtIHBhcmVudEluZGV4CgkJCQkJdmFyIGVuZCA9IG9mZnNldCArIChkYXRhVHlwZSA9PSAiW29iamVjdCBBcnJheV0iID8gZGF0YSA6IGNhY2hlZC5ub2RlcykubGVuZ3RoCgkJCQkJY2xlYXIocGFyZW50Q2FjaGUubm9kZXMuc2xpY2Uob2Zmc2V0LCBlbmQpLCBwYXJlbnRDYWNoZS5zbGljZShvZmZzZXQsIGVuZCkpCgkJCQl9CgkJCQllbHNlIGlmIChjYWNoZWQubm9kZXMpIGNsZWFyKGNhY2hlZC5ub2RlcywgY2FjaGVkKQoJCQl9CgkJCWNhY2hlZCA9IG5ldyBkYXRhLmNvbnN0cnVjdG9yCgkJCWNhY2hlZC5ub2RlcyA9IFtdCgkJfQoKCQlpZiAoZGF0YVR5cGUgPT0gIltvYmplY3QgQXJyYXldIikgewoJCQlkYXRhID0gZmxhdHRlbihkYXRhKQoJCQl2YXIgbm9kZXMgPSBbXSwgaW50YWN0ID0gY2FjaGVkLmxlbmd0aCA9PT0gZGF0YS5sZW5ndGgsIHN1YkFycmF5Q291bnQgPSAwCgoJCQkvL2tleXMgYWxnb3JpdGhtOiBzb3J0IGVsZW1lbnRzIHdpdGhvdXQgcmVjcmVhdGluZyB0aGVtIGlmIGtleXMgYXJlIHByZXNlbnQKCQkJLy8xKSBjcmVhdGUgYSBtYXAgb2YgYWxsIGV4aXN0aW5nIGtleXMsIGFuZCBtYXJrIGFsbCBmb3IgZGVsZXRpb24KCQkJLy8yKSBhZGQgbmV3IGtleXMgdG8gbWFwIGFuZCBtYXJrIHRoZW0gZm9yIGFkZGl0aW9uCgkJCS8vMykgaWYga2V5IGV4aXN0cyBpbiBuZXcgbGlzdCwgY2hhbmdlIGFjdGlvbiBmcm9tIGRlbGV0aW9uIHRvIGEgbW92ZQoJCQkvLzQpIGZvciBlYWNoIGtleSwgaGFuZGxlIGl0cyBjb3JyZXNwb25kaW5nIGFjdGlvbiBhcyBtYXJrZWQgaW4gcHJldmlvdXMgc3RlcHMKCQkJLy81KSBjb3B5IHVua2V5ZWQgaXRlbXMgaW50byB0aGVpciByZXNwZWN0aXZlIGdhcHMKCQkJdmFyIERFTEVUSU9OID0gMSwgSU5TRVJUSU9OID0gMiAsIE1PVkUgPSAzCgkJCXZhciBleGlzdGluZyA9IHt9LCB1bmtleWVkID0gW10sIHNob3VsZE1haW50YWluSWRlbnRpdGllcyA9IGZhbHNlCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgY2FjaGVkLmxlbmd0aDsgaSsrKSB7CgkJCQlpZiAoY2FjaGVkW2ldICYmIGNhY2hlZFtpXS5hdHRycyAmJiBjYWNoZWRbaV0uYXR0cnMua2V5ICE9IG51bGwpIHsKCQkJCQlzaG91bGRNYWludGFpbklkZW50aXRpZXMgPSB0cnVlCgkJCQkJZXhpc3RpbmdbY2FjaGVkW2ldLmF0dHJzLmtleV0gPSB7YWN0aW9uOiBERUxFVElPTiwgaW5kZXg6IGl9CgkJCQl9CgkJCX0KCQkJaWYgKHNob3VsZE1haW50YWluSWRlbnRpdGllcykgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQkJaWYgKGRhdGFbaV0gJiYgZGF0YVtpXS5hdHRycykgewoJCQkJCQlpZiAoZGF0YVtpXS5hdHRycy5rZXkgIT0gbnVsbCkgewoJCQkJCQkJdmFyIGtleSA9IGRhdGFbaV0uYXR0cnMua2V5CgkJCQkJCQlpZiAoIWV4aXN0aW5nW2tleV0pIGV4aXN0aW5nW2tleV0gPSB7YWN0aW9uOiBJTlNFUlRJT04sIGluZGV4OiBpfQoJCQkJCQkJZWxzZSBleGlzdGluZ1trZXldID0ge2FjdGlvbjogTU9WRSwgaW5kZXg6IGksIGZyb206IGV4aXN0aW5nW2tleV0uaW5kZXgsIGVsZW1lbnQ6IHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tleGlzdGluZ1trZXldLmluZGV4XX0KCQkJCQkJfQoJCQkJCQllbHNlIHVua2V5ZWQucHVzaCh7aW5kZXg6IGksIGVsZW1lbnQ6IHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpXX0pCgkJCQkJfQoJCQkJfQoJCQkJdmFyIGFjdGlvbnMgPSBPYmplY3Qua2V5cyhleGlzdGluZykubWFwKGZ1bmN0aW9uKGtleSkge3JldHVybiBleGlzdGluZ1trZXldfSkKCQkJCXZhciBjaGFuZ2VzID0gYWN0aW9ucy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHtyZXR1cm4gYS5hY3Rpb24gLSBiLmFjdGlvbiB8fCBhLmluZGV4IC0gYi5pbmRleH0pCgkJCQl2YXIgbmV3Q2FjaGVkID0gY2FjaGVkLnNsaWNlKCkKCgkJCQlmb3IgKHZhciBpID0gMCwgY2hhbmdlOyBjaGFuZ2UgPSBjaGFuZ2VzW2ldOyBpKyspIHsKCQkJCQlpZiAoY2hhbmdlLmFjdGlvbiA9PSBERUxFVElPTikgewoJCQkJCQljbGVhcihjYWNoZWRbY2hhbmdlLmluZGV4XS5ub2RlcywgY2FjaGVkW2NoYW5nZS5pbmRleF0pCgkJCQkJCW5ld0NhY2hlZC5zcGxpY2UoY2hhbmdlLmluZGV4LCAxKQoJCQkJCX0KCQkJCQlpZiAoY2hhbmdlLmFjdGlvbiA9PSBJTlNFUlRJT04pIHsKCQkJCQkJdmFyIGR1bW15ID0gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJCQkJCWR1bW15LmtleSA9IGRhdGFbY2hhbmdlLmluZGV4XS5hdHRycy5rZXkKCQkJCQkJcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUoZHVtbXksIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tjaGFuZ2UuaW5kZXhdKQoJCQkJCQluZXdDYWNoZWQuc3BsaWNlKGNoYW5nZS5pbmRleCwgMCwge2F0dHJzOiB7a2V5OiBkYXRhW2NoYW5nZS5pbmRleF0uYXR0cnMua2V5fSwgbm9kZXM6IFtkdW1teV19KQoJCQkJCX0KCgkJCQkJaWYgKGNoYW5nZS5hY3Rpb24gPT0gTU9WRSkgewoJCQkJCQlpZiAocGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2NoYW5nZS5pbmRleF0gIT09IGNoYW5nZS5lbGVtZW50ICYmIGNoYW5nZS5lbGVtZW50ICE9PSBudWxsKSB7CgkJCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShjaGFuZ2UuZWxlbWVudCwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2NoYW5nZS5pbmRleF0pCgkJCQkJCX0KCQkJCQkJbmV3Q2FjaGVkW2NoYW5nZS5pbmRleF0gPSBjYWNoZWRbY2hhbmdlLmZyb21dCgkJCQkJfQoJCQkJfQoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCB1bmtleWVkLmxlbmd0aDsgaSsrKSB7CgkJCQkJdmFyIGNoYW5nZSA9IHVua2V5ZWRbaV0KCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShjaGFuZ2UuZWxlbWVudCwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2NoYW5nZS5pbmRleF0pCgkJCQkJbmV3Q2FjaGVkW2NoYW5nZS5pbmRleF0gPSBjYWNoZWRbY2hhbmdlLmluZGV4XQoJCQkJfQoJCQkJY2FjaGVkID0gbmV3Q2FjaGVkCgkJCQljYWNoZWQubm9kZXMgPSBbXQoJCQkJZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpXTsgaSsrKSBjYWNoZWQubm9kZXMucHVzaChjaGlsZCkKCQkJfQoJCQkvL2VuZCBrZXkgYWxnb3JpdGhtCgoJCQlmb3IgKHZhciBpID0gMCwgY2FjaGVDb3VudCA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQkvL2RpZmYgZWFjaCBpdGVtIGluIHRoZSBhcnJheQoJCQkJdmFyIGl0ZW0gPSBidWlsZChwYXJlbnRFbGVtZW50LCBwYXJlbnRUYWcsIGNhY2hlZCwgaW5kZXgsIGRhdGFbaV0sIGNhY2hlZFtjYWNoZUNvdW50XSwgc2hvdWxkUmVhdHRhY2gsIGluZGV4ICsgc3ViQXJyYXlDb3VudCB8fCBzdWJBcnJheUNvdW50LCBlZGl0YWJsZSwgbmFtZXNwYWNlLCBjb25maWdzKQoJCQkJaWYgKGl0ZW0gPT09IHVuZGVmaW5lZCkgY29udGludWUKCQkJCWlmICghaXRlbS5ub2Rlcy5pbnRhY3QpIGludGFjdCA9IGZhbHNlCgkJCQl2YXIgaXNBcnJheSA9IHR5cGUuY2FsbChpdGVtKSA9PSAiW29iamVjdCBBcnJheV0iCgkJCQlzdWJBcnJheUNvdW50ICs9IGlzQXJyYXkgPyBpdGVtLmxlbmd0aCA6IDEKCQkJCWNhY2hlZFtjYWNoZUNvdW50KytdID0gaXRlbQoJCQl9CgkJCWlmICghaW50YWN0KSB7CgkJCQkvL2RpZmYgdGhlIGFycmF5IGl0c2VsZgoJCQkJCgkJCQkvL3VwZGF0ZSB0aGUgbGlzdCBvZiBET00gbm9kZXMgYnkgY29sbGVjdGluZyB0aGUgbm9kZXMgZnJvbSBlYWNoIGl0ZW0KCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQkJCWlmIChjYWNoZWRbaV0gIT0gbnVsbCkgbm9kZXMgPSBub2Rlcy5jb25jYXQoY2FjaGVkW2ldLm5vZGVzKQoJCQkJfQoJCQkJLy9yZW1vdmUgaXRlbXMgZnJvbSB0aGUgZW5kIG9mIHRoZSBhcnJheSBpZiB0aGUgbmV3IGFycmF5IGlzIHNob3J0ZXIgdGhhbiB0aGUgb2xkIG9uZQoJCQkJLy9pZiBlcnJvcnMgZXZlciBoYXBwZW4gaGVyZSwgdGhlIGlzc3VlIGlzIG1vc3QgbGlrZWx5IGEgYnVnIGluIHRoZSBjb25zdHJ1Y3Rpb24gb2YgdGhlIGBjYWNoZWRgIGRhdGEgc3RydWN0dXJlIHNvbWV3aGVyZSBlYXJsaWVyIGluIHRoZSBwcm9ncmFtCgkJCQlmb3IgKHZhciBpID0gMCwgbm9kZTsgbm9kZSA9IGNhY2hlZC5ub2Rlc1tpXTsgaSsrKSB7CgkJCQkJaWYgKG5vZGUucGFyZW50Tm9kZSAhPSBudWxsICYmIG5vZGVzLmluZGV4T2Yobm9kZSkgPCAwKSBjbGVhcihbbm9kZV0sIFtjYWNoZWRbaV1dKQoJCQkJfQoJCQkJLy9hZGQgaXRlbXMgdG8gdGhlIGVuZCBpZiB0aGUgbmV3IGFycmF5IGlzIGxvbmdlciB0aGFuIHRoZSBvbGQgb25lCgkJCQlmb3IgKHZhciBpID0gY2FjaGVkLm5vZGVzLmxlbmd0aCwgbm9kZTsgbm9kZSA9IG5vZGVzW2ldOyBpKyspIHsKCQkJCQlpZiAobm9kZS5wYXJlbnROb2RlID09IG51bGwpIHBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQobm9kZSkKCQkJCX0KCQkJCWlmIChkYXRhLmxlbmd0aCA8IGNhY2hlZC5sZW5ndGgpIGNhY2hlZC5sZW5ndGggPSBkYXRhLmxlbmd0aAoJCQkJY2FjaGVkLm5vZGVzID0gbm9kZXMKCQkJfQoJCX0KCQllbHNlIGlmIChkYXRhICE9IG51bGwgJiYgZGF0YVR5cGUgPT0gIltvYmplY3QgT2JqZWN0XSIpIHsKCQkJLy9pZiBhbiBlbGVtZW50IGlzIGRpZmZlcmVudCBlbm91Z2ggZnJvbSB0aGUgb25lIGluIGNhY2hlLCByZWNyZWF0ZSBpdAoJCQlpZiAoZGF0YS50YWcgIT0gY2FjaGVkLnRhZyB8fCBPYmplY3Qua2V5cyhkYXRhLmF0dHJzKS5qb2luKCkgIT0gT2JqZWN0LmtleXMoY2FjaGVkLmF0dHJzKS5qb2luKCkgfHwgZGF0YS5hdHRycy5pZCAhPSBjYWNoZWQuYXR0cnMuaWQpIHsKCQkJCWNsZWFyKGNhY2hlZC5ub2RlcykKCQkJCWlmIChjYWNoZWQuY29uZmlnQ29udGV4dCAmJiB0eXBlb2YgY2FjaGVkLmNvbmZpZ0NvbnRleHQub251bmxvYWQgPT0gImZ1bmN0aW9uIikgY2FjaGVkLmNvbmZpZ0NvbnRleHQub251bmxvYWQoKQoJCQl9CgkJCWlmICh0eXBlb2YgZGF0YS50YWcgIT0gInN0cmluZyIpIHJldHVybgoKCQkJdmFyIG5vZGUsIGlzTmV3ID0gY2FjaGVkLm5vZGVzLmxlbmd0aCA9PT0gMAoJCQlpZiAoZGF0YS5hdHRycy54bWxucykgbmFtZXNwYWNlID0gZGF0YS5hdHRycy54bWxucwoJCQllbHNlIGlmIChkYXRhLnRhZyA9PT0gInN2ZyIpIG5hbWVzcGFjZSA9ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKCQkJZWxzZSBpZiAoZGF0YS50YWcgPT09ICJtYXRoIikgbmFtZXNwYWNlID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTgvTWF0aC9NYXRoTUwiCgkJCWlmIChpc05ldykgewoJCQkJbm9kZSA9IG5hbWVzcGFjZSA9PT0gdW5kZWZpbmVkID8gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoZGF0YS50YWcpIDogd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2UsIGRhdGEudGFnKQoJCQkJY2FjaGVkID0gewoJCQkJCXRhZzogZGF0YS50YWcsCgkJCQkJLy9wcm9jZXNzIGNoaWxkcmVuIGJlZm9yZSBhdHRycyBzbyB0aGF0IHNlbGVjdC52YWx1ZSB3b3JrcyBjb3JyZWN0bHkKCQkJCQljaGlsZHJlbjogYnVpbGQobm9kZSwgZGF0YS50YWcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBkYXRhLmNoaWxkcmVuLCBjYWNoZWQuY2hpbGRyZW4sIHRydWUsIDAsIGRhdGEuYXR0cnMuY29udGVudGVkaXRhYmxlID8gbm9kZSA6IGVkaXRhYmxlLCBuYW1lc3BhY2UsIGNvbmZpZ3MpLAoJCQkJCWF0dHJzOiBzZXRBdHRyaWJ1dGVzKG5vZGUsIGRhdGEudGFnLCBkYXRhLmF0dHJzLCB7fSwgbmFtZXNwYWNlKSwKCQkJCQlub2RlczogW25vZGVdCgkJCQl9CgkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2RlLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCX0KCQkJZWxzZSB7CgkJCQlub2RlID0gY2FjaGVkLm5vZGVzWzBdCgkJCQlzZXRBdHRyaWJ1dGVzKG5vZGUsIGRhdGEudGFnLCBkYXRhLmF0dHJzLCBjYWNoZWQuYXR0cnMsIG5hbWVzcGFjZSkKCQkJCWNhY2hlZC5jaGlsZHJlbiA9IGJ1aWxkKG5vZGUsIGRhdGEudGFnLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgZGF0YS5jaGlsZHJlbiwgY2FjaGVkLmNoaWxkcmVuLCBmYWxzZSwgMCwgZGF0YS5hdHRycy5jb250ZW50ZWRpdGFibGUgPyBub2RlIDogZWRpdGFibGUsIG5hbWVzcGFjZSwgY29uZmlncykKCQkJCWNhY2hlZC5ub2Rlcy5pbnRhY3QgPSB0cnVlCgkJCQlpZiAoc2hvdWxkUmVhdHRhY2ggPT09IHRydWUgJiYgbm9kZSAhPSBudWxsKSBwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2RlLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCX0KCQkJLy9zY2hlZHVsZSBjb25maWdzIHRvIGJlIGNhbGxlZC4gVGhleSBhcmUgY2FsbGVkIGFmdGVyIGBidWlsZGAgZmluaXNoZXMgcnVubmluZwoJCQlpZiAodHlwZW9mIGRhdGEuYXR0cnNbImNvbmZpZyJdID09PSAiZnVuY3Rpb24iKSB7CgkJCQljb25maWdzLnB1c2goZGF0YS5hdHRyc1siY29uZmlnIl0uYmluZCh3aW5kb3csIG5vZGUsICFpc05ldywgY2FjaGVkLmNvbmZpZ0NvbnRleHQgPSBjYWNoZWQuY29uZmlnQ29udGV4dCB8fCB7fSwgY2FjaGVkKSkKCQkJfQoJCX0KCQllbHNlIGlmICh0eXBlb2YgZGF0YVR5cGUgIT0gImZ1bmN0aW9uIikgewoJCQkvL2hhbmRsZSB0ZXh0IG5vZGVzCgkJCXZhciBub2RlcwoJCQlpZiAoY2FjaGVkLm5vZGVzLmxlbmd0aCA9PT0gMCkgewoJCQkJaWYgKGRhdGEuJHRydXN0ZWQpIHsKCQkJCQlub2RlcyA9IGluamVjdEhUTUwocGFyZW50RWxlbWVudCwgaW5kZXgsIGRhdGEpCgkJCQl9CgkJCQllbHNlIHsKCQkJCQlub2RlcyA9IFt3aW5kb3cuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoZGF0YSldCgkJCQkJaWYgKCFwYXJlbnRFbGVtZW50Lm5vZGVOYW1lLm1hdGNoKHZvaWRFbGVtZW50cykpIHBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGVzWzBdLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCQl9CgkJCQljYWNoZWQgPSAic3RyaW5nIG51bWJlciBib29sZWFuIi5pbmRleE9mKHR5cGVvZiBkYXRhKSA+IC0xID8gbmV3IGRhdGEuY29uc3RydWN0b3IoZGF0YSkgOiBkYXRhCgkJCQljYWNoZWQubm9kZXMgPSBub2RlcwoJCQl9CgkJCWVsc2UgaWYgKGNhY2hlZC52YWx1ZU9mKCkgIT09IGRhdGEudmFsdWVPZigpIHx8IHNob3VsZFJlYXR0YWNoID09PSB0cnVlKSB7CgkJCQlub2RlcyA9IGNhY2hlZC5ub2RlcwoJCQkJaWYgKCFlZGl0YWJsZSB8fCBlZGl0YWJsZSAhPT0gd2luZG93LmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHsKCQkJCQlpZiAoZGF0YS4kdHJ1c3RlZCkgewoJCQkJCQljbGVhcihub2RlcywgY2FjaGVkKQoJCQkJCQlub2RlcyA9IGluamVjdEhUTUwocGFyZW50RWxlbWVudCwgaW5kZXgsIGRhdGEpCgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQkvL2Nvcm5lciBjYXNlOiByZXBsYWNpbmcgdGhlIG5vZGVWYWx1ZSBvZiBhIHRleHQgbm9kZSB0aGF0IGlzIGEgY2hpbGQgb2YgYSB0ZXh0YXJlYS9jb250ZW50ZWRpdGFibGUgZG9lc24ndCB3b3JrCgkJCQkJCS8vd2UgbmVlZCB0byB1cGRhdGUgdGhlIHZhbHVlIHByb3BlcnR5IG9mIHRoZSBwYXJlbnQgdGV4dGFyZWEgb3IgdGhlIGlubmVySFRNTCBvZiB0aGUgY29udGVudGVkaXRhYmxlIGVsZW1lbnQgaW5zdGVhZAoJCQkJCQlpZiAocGFyZW50VGFnID09PSAidGV4dGFyZWEiKSBwYXJlbnRFbGVtZW50LnZhbHVlID0gZGF0YQoJCQkJCQllbHNlIGlmIChlZGl0YWJsZSkgZWRpdGFibGUuaW5uZXJIVE1MID0gZGF0YQoJCQkJCQllbHNlIHsKCQkJCQkJCWlmIChub2Rlc1swXS5ub2RlVHlwZSA9PSAxIHx8IG5vZGVzLmxlbmd0aCA+IDEpIHsgLy93YXMgYSB0cnVzdGVkIHN0cmluZwoJCQkJCQkJCWNsZWFyKGNhY2hlZC5ub2RlcywgY2FjaGVkKQoJCQkJCQkJCW5vZGVzID0gW3dpbmRvdy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShkYXRhKV0KCQkJCQkJCX0KCQkJCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGVzWzBdLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCQkJCQlub2Rlc1swXS5ub2RlVmFsdWUgPSBkYXRhCgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQljYWNoZWQgPSBuZXcgZGF0YS5jb25zdHJ1Y3RvcihkYXRhKQoJCQkJY2FjaGVkLm5vZGVzID0gbm9kZXMKCQkJfQoJCQllbHNlIGNhY2hlZC5ub2Rlcy5pbnRhY3QgPSB0cnVlCgkJfQoKCQlyZXR1cm4gY2FjaGVkCgl9CglmdW5jdGlvbiBzZXRBdHRyaWJ1dGVzKG5vZGUsIHRhZywgZGF0YUF0dHJzLCBjYWNoZWRBdHRycywgbmFtZXNwYWNlKSB7CgkJdmFyIGdyb3VwcyA9IHt9CgkJZm9yICh2YXIgYXR0ck5hbWUgaW4gZGF0YUF0dHJzKSB7CgkJCXZhciBkYXRhQXR0ciA9IGRhdGFBdHRyc1thdHRyTmFtZV0KCQkJdmFyIGNhY2hlZEF0dHIgPSBjYWNoZWRBdHRyc1thdHRyTmFtZV0KCQkJaWYgKCEoYXR0ck5hbWUgaW4gY2FjaGVkQXR0cnMpIHx8IChjYWNoZWRBdHRyICE9PSBkYXRhQXR0cikgfHwgbm9kZSA9PT0gd2luZG93LmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHsKCQkJCWNhY2hlZEF0dHJzW2F0dHJOYW1lXSA9IGRhdGFBdHRyCgkJCQlpZiAoYXR0ck5hbWUgPT09ICJjb25maWciKSBjb250aW51ZQoJCQkJZWxzZSBpZiAodHlwZW9mIGRhdGFBdHRyID09ICJmdW5jdGlvbiIgJiYgYXR0ck5hbWUuaW5kZXhPZigib24iKSA9PSAwKSB7CgkJCQkJbm9kZVthdHRyTmFtZV0gPSBhdXRvcmVkcmF3KGRhdGFBdHRyLCBub2RlKQoJCQkJfQoJCQkJZWxzZSBpZiAoYXR0ck5hbWUgPT09ICJzdHlsZSIgJiYgdHlwZW9mIGRhdGFBdHRyID09ICJvYmplY3QiKSB7CgkJCQkJZm9yICh2YXIgcnVsZSBpbiBkYXRhQXR0cikgewoJCQkJCQlpZiAoY2FjaGVkQXR0ciA9PSBudWxsIHx8IGNhY2hlZEF0dHJbcnVsZV0gIT09IGRhdGFBdHRyW3J1bGVdKSBub2RlLnN0eWxlW3J1bGVdID0gZGF0YUF0dHJbcnVsZV0KCQkJCQl9CgkJCQkJZm9yICh2YXIgcnVsZSBpbiBjYWNoZWRBdHRyKSB7CgkJCQkJCWlmICghKHJ1bGUgaW4gZGF0YUF0dHIpKSBub2RlLnN0eWxlW3J1bGVdID0gIiIKCQkJCQl9CgkJCQl9CgkJCQllbHNlIGlmIChuYW1lc3BhY2UgIT0gbnVsbCkgewoJCQkJCWlmIChhdHRyTmFtZSA9PT0gImhyZWYiKSBub2RlLnNldEF0dHJpYnV0ZU5TKCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwgImhyZWYiLCBkYXRhQXR0cikKCQkJCQllbHNlIGlmIChhdHRyTmFtZSA9PT0gImNsYXNzTmFtZSIpIG5vZGUuc2V0QXR0cmlidXRlKCJjbGFzcyIsIGRhdGFBdHRyKQoJCQkJCWVsc2Ugbm9kZS5zZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGRhdGFBdHRyKQoJCQkJfQoJCQkJZWxzZSBpZiAoYXR0ck5hbWUgPT09ICJ2YWx1ZSIgJiYgdGFnID09PSAiaW5wdXQiKSB7CgkJCQkJaWYgKG5vZGUudmFsdWUgIT09IGRhdGFBdHRyKSBub2RlLnZhbHVlID0gZGF0YUF0dHIKCQkJCX0KCQkJCWVsc2UgaWYgKGF0dHJOYW1lIGluIG5vZGUgJiYgIShhdHRyTmFtZSA9PSAibGlzdCIgfHwgYXR0ck5hbWUgPT0gInN0eWxlIikpIHsKCQkJCQlub2RlW2F0dHJOYW1lXSA9IGRhdGFBdHRyCgkJCQl9CgkJCQllbHNlIG5vZGUuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBkYXRhQXR0cikKCQkJfQoJCX0KCQlyZXR1cm4gY2FjaGVkQXR0cnMKCX0KCWZ1bmN0aW9uIGNsZWFyKG5vZGVzLCBjYWNoZWQpIHsKCQlmb3IgKHZhciBpID0gbm9kZXMubGVuZ3RoIC0gMTsgaSA+IC0xOyBpLS0pIHsKCQkJaWYgKG5vZGVzW2ldICYmIG5vZGVzW2ldLnBhcmVudE5vZGUpIHsKCQkJCW5vZGVzW2ldLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZXNbaV0pCgkJCQljYWNoZWQgPSBbXS5jb25jYXQoY2FjaGVkKQoJCQkJaWYgKGNhY2hlZFtpXSkgdW5sb2FkKGNhY2hlZFtpXSkKCQkJfQoJCX0KCQlpZiAobm9kZXMubGVuZ3RoICE9IDApIG5vZGVzLmxlbmd0aCA9IDAKCX0KCWZ1bmN0aW9uIHVubG9hZChjYWNoZWQpIHsKCQlpZiAoY2FjaGVkLmNvbmZpZ0NvbnRleHQgJiYgdHlwZW9mIGNhY2hlZC5jb25maWdDb250ZXh0Lm9udW5sb2FkID09ICJmdW5jdGlvbiIpIGNhY2hlZC5jb25maWdDb250ZXh0Lm9udW5sb2FkKCkKCQlpZiAoY2FjaGVkLmNoaWxkcmVuKSB7CgkJCWlmICh0eXBlLmNhbGwoY2FjaGVkLmNoaWxkcmVuKSA9PSAiW29iamVjdCBBcnJheV0iKSBmb3IgKHZhciBpID0gMDsgaSA8IGNhY2hlZC5jaGlsZHJlbi5sZW5ndGg7IGkrKykgdW5sb2FkKGNhY2hlZC5jaGlsZHJlbltpXSkKCQkJZWxzZSBpZiAoY2FjaGVkLmNoaWxkcmVuLnRhZykgdW5sb2FkKGNhY2hlZC5jaGlsZHJlbikKCQl9Cgl9CglmdW5jdGlvbiBpbmplY3RIVE1MKHBhcmVudEVsZW1lbnQsIGluZGV4LCBkYXRhKSB7CgkJdmFyIG5leHRTaWJsaW5nID0gcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XQoJCWlmIChuZXh0U2libGluZykgewoJCQl2YXIgaXNFbGVtZW50ID0gbmV4dFNpYmxpbmcubm9kZVR5cGUgIT0gMQoJCQl2YXIgcGxhY2Vob2xkZXIgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpCgkJCWlmIChpc0VsZW1lbnQpIHsKCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKHBsYWNlaG9sZGVyLCBuZXh0U2libGluZykKCQkJCXBsYWNlaG9sZGVyLmluc2VydEFkamFjZW50SFRNTCgiYmVmb3JlYmVnaW4iLCBkYXRhKQoJCQkJcGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZChwbGFjZWhvbGRlcikKCQkJfQoJCQllbHNlIG5leHRTaWJsaW5nLmluc2VydEFkamFjZW50SFRNTCgiYmVmb3JlYmVnaW4iLCBkYXRhKQoJCX0KCQllbHNlIHBhcmVudEVsZW1lbnQuaW5zZXJ0QWRqYWNlbnRIVE1MKCJiZWZvcmVlbmQiLCBkYXRhKQoJCXZhciBub2RlcyA9IFtdCgkJd2hpbGUgKHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gIT09IG5leHRTaWJsaW5nKSB7CgkJCW5vZGVzLnB1c2gocGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSkKCQkJaW5kZXgrKwoJCX0KCQlyZXR1cm4gbm9kZXMKCX0KCWZ1bmN0aW9uIGZsYXR0ZW4oZGF0YSkgewoJCXZhciBmbGF0dGVuZWQgPSBbXQoJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQl2YXIgaXRlbSA9IGRhdGFbaV0KCQkJaWYgKHR5cGUuY2FsbChpdGVtKSA9PSAiW29iamVjdCBBcnJheV0iKSBmbGF0dGVuZWQucHVzaC5hcHBseShmbGF0dGVuZWQsIGZsYXR0ZW4oaXRlbSkpCgkJCWVsc2UgZmxhdHRlbmVkLnB1c2goaXRlbSkKCQl9CgkJcmV0dXJuIGZsYXR0ZW5lZAoJfQoJZnVuY3Rpb24gYXV0b3JlZHJhdyhjYWxsYmFjaywgb2JqZWN0LCBncm91cCkgewoJCXJldHVybiBmdW5jdGlvbihlKSB7CgkJCWUgPSBlIHx8IGV2ZW50CgkJCW0ucmVkcmF3LnN0cmF0ZWd5KCJkaWZmIikKCQkJbS5zdGFydENvbXB1dGF0aW9uKCkKCQkJdHJ5IHtyZXR1cm4gY2FsbGJhY2suY2FsbChvYmplY3QsIGUpfQoJCQlmaW5hbGx5IHsKCQkJCWlmICghbGFzdFJlZHJhd0lkKSBsYXN0UmVkcmF3SWQgPSAtMTsKCQkJCW0uZW5kQ29tcHV0YXRpb24oKQoJCQl9CgkJfQoJfQoKCXZhciBodG1sCgl2YXIgZG9jdW1lbnROb2RlID0gewoJCWluc2VydEFkamFjZW50SFRNTDogZnVuY3Rpb24oXywgZGF0YSkgewoJCQl3aW5kb3cuZG9jdW1lbnQud3JpdGUoZGF0YSkKCQkJd2luZG93LmRvY3VtZW50LmNsb3NlKCkKCQl9LAoJCWFwcGVuZENoaWxkOiBmdW5jdGlvbihub2RlKSB7CgkJCWlmIChodG1sID09PSB1bmRlZmluZWQpIGh0bWwgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaHRtbCIpCgkJCWlmIChub2RlLm5vZGVOYW1lID09ICJIVE1MIikgaHRtbCA9IG5vZGUKCQkJZWxzZSBodG1sLmFwcGVuZENoaWxkKG5vZGUpCgkJCWlmICh3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgIT09IGh0bWwpIHsKCQkJCXdpbmRvdy5kb2N1bWVudC5yZXBsYWNlQ2hpbGQoaHRtbCwgd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkKCQkJfQoJCQllbHNlIHdpbmRvdy5kb2N1bWVudC5hcHBlbmRDaGlsZChodG1sKQoJCX0sCgkJaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbihub2RlKSB7CgkJCXRoaXMuYXBwZW5kQ2hpbGQobm9kZSkKCQl9LAoJCWNoaWxkTm9kZXM6IFtdCgl9Cgl2YXIgbm9kZUNhY2hlID0gW10sIGNlbGxDYWNoZSA9IHt9CgltLnJlbmRlciA9IGZ1bmN0aW9uKHJvb3QsIGNlbGwsIGZvcmNlUmVjcmVhdGlvbikgewoJCXZhciBjb25maWdzID0gW10KCQlpZiAoIXJvb3QpIHRocm93IG5ldyBFcnJvcigiUGxlYXNlIGVuc3VyZSB0aGUgRE9NIGVsZW1lbnQgZXhpc3RzIGJlZm9yZSByZW5kZXJpbmcgYSB0ZW1wbGF0ZSBpbnRvIGl0LiIpCgkJdmFyIGlkID0gZ2V0Q2VsbENhY2hlS2V5KHJvb3QpCgkJdmFyIG5vZGUgPSByb290ID09IHdpbmRvdy5kb2N1bWVudCB8fCByb290ID09IHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudE5vZGUgOiByb290CgkJaWYgKGNlbGxDYWNoZVtpZF0gPT09IHVuZGVmaW5lZCkgY2xlYXIobm9kZS5jaGlsZE5vZGVzKQoJCWlmIChmb3JjZVJlY3JlYXRpb24gPT09IHRydWUpIHJlc2V0KHJvb3QpCgkJY2VsbENhY2hlW2lkXSA9IGJ1aWxkKG5vZGUsIG51bGwsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjZWxsLCBjZWxsQ2FjaGVbaWRdLCBmYWxzZSwgMCwgbnVsbCwgdW5kZWZpbmVkLCBjb25maWdzKQoJCWZvciAodmFyIGkgPSAwOyBpIDwgY29uZmlncy5sZW5ndGg7IGkrKykgY29uZmlnc1tpXSgpCgl9CglmdW5jdGlvbiBnZXRDZWxsQ2FjaGVLZXkoZWxlbWVudCkgewoJCXZhciBpbmRleCA9IG5vZGVDYWNoZS5pbmRleE9mKGVsZW1lbnQpCgkJcmV0dXJuIGluZGV4IDwgMCA/IG5vZGVDYWNoZS5wdXNoKGVsZW1lbnQpIC0gMSA6IGluZGV4Cgl9CgoJbS50cnVzdCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJdmFsdWUgPSBuZXcgU3RyaW5nKHZhbHVlKQoJCXZhbHVlLiR0cnVzdGVkID0gdHJ1ZQoJCXJldHVybiB2YWx1ZQoJfQoKCWZ1bmN0aW9uIF9wcm9wKHN0b3JlKSB7CgkJdmFyIHByb3AgPSBmdW5jdGlvbigpIHsKCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHN0b3JlID0gYXJndW1lbnRzWzBdCgkJCXJldHVybiBzdG9yZQoJCX0KCgkJcHJvcC50b0pTT04gPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHN0b3JlCgkJfQoKCQlyZXR1cm4gcHJvcAoJfQoKCW0ucHJvcCA9IGZ1bmN0aW9uIChzdG9yZSkgewoJCWlmICgodHlwZW9mIHN0b3JlID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygc3RvcmUgPT09ICdmdW5jdGlvbicpICYmIHN0b3JlICE9PSBudWxsICYmCgkJCQl0eXBlb2Ygc3RvcmUudGhlbiA9PT0gJ2Z1bmN0aW9uJykgewoJCQl2YXIgcHJvcCA9IF9wcm9wKCkKCQkJbmV3UHJvbWlzZWRQcm9wKHByb3AsIHN0b3JlKS50aGVuKHByb3ApCgoJCQlyZXR1cm4gcHJvcAoJCX0KCgkJcmV0dXJuIF9wcm9wKHN0b3JlKQoJfQoKCXZhciByb290cyA9IFtdLCBtb2R1bGVzID0gW10sIGNvbnRyb2xsZXJzID0gW10sIGxhc3RSZWRyYXdJZCA9IDAsIGNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IG51bGwsIHByZXZlbnRlZCA9IGZhbHNlCgltLm1vZHVsZSA9IGZ1bmN0aW9uKHJvb3QsIG1vZHVsZSkgewoJCXZhciBpbmRleCA9IHJvb3RzLmluZGV4T2Yocm9vdCkKCQlpZiAoaW5kZXggPCAwKSBpbmRleCA9IHJvb3RzLmxlbmd0aAoJCXZhciBpc1ByZXZlbnRlZCA9IGZhbHNlCgkJaWYgKGNvbnRyb2xsZXJzW2luZGV4XSAmJiB0eXBlb2YgY29udHJvbGxlcnNbaW5kZXhdLm9udW5sb2FkID09ICJmdW5jdGlvbiIpIHsKCQkJdmFyIGV2ZW50ID0gewoJCQkJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkge2lzUHJldmVudGVkID0gdHJ1ZX0KCQkJfQoJCQljb250cm9sbGVyc1tpbmRleF0ub251bmxvYWQoZXZlbnQpCgkJfQoJCWlmICghaXNQcmV2ZW50ZWQpIHsKCQkJbS5yZWRyYXcuc3RyYXRlZ3koImFsbCIpCgkJCW0uc3RhcnRDb21wdXRhdGlvbigpCgkJCXJvb3RzW2luZGV4XSA9IHJvb3QKCQkJbW9kdWxlc1tpbmRleF0gPSBtb2R1bGUKCQkJY29udHJvbGxlcnNbaW5kZXhdID0gbmV3IG1vZHVsZS5jb250cm9sbGVyCgkJCW0uZW5kQ29tcHV0YXRpb24oKQoJCX0KCX0KCW0ucmVkcmF3ID0gZnVuY3Rpb24oZm9yY2UpIHsKCQl2YXIgY2FuY2VsID0gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8IHdpbmRvdy5jbGVhclRpbWVvdXQKCQl2YXIgZGVmZXIgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IHdpbmRvdy5zZXRUaW1lb3V0CgkJaWYgKGxhc3RSZWRyYXdJZCAmJiBmb3JjZSAhPT0gdHJ1ZSkgewoJCQljYW5jZWwobGFzdFJlZHJhd0lkKQoJCQlsYXN0UmVkcmF3SWQgPSBkZWZlcihyZWRyYXcsIDApCgkJfQoJCWVsc2UgewoJCQlyZWRyYXcoKQoJCQlsYXN0UmVkcmF3SWQgPSBkZWZlcihmdW5jdGlvbigpIHtsYXN0UmVkcmF3SWQgPSBudWxsfSwgMCkKCQl9Cgl9CgltLnJlZHJhdy5zdHJhdGVneSA9IG0ucHJvcCgpCglmdW5jdGlvbiByZWRyYXcoKSB7CgkJdmFyIG1vZGUgPSBtLnJlZHJhdy5zdHJhdGVneSgpCgkJZm9yICh2YXIgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykgewoJCQlpZiAoY29udHJvbGxlcnNbaV0gJiYgbW9kZSAhPSAibm9uZSIpIG0ucmVuZGVyKHJvb3RzW2ldLCBtb2R1bGVzW2ldLnZpZXcoY29udHJvbGxlcnNbaV0pLCBtb2RlID09ICJhbGwiKQoJCX0KCQlpZiAoY29tcHV0ZVBvc3RSZWRyYXdIb29rKSB7CgkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vaygpCgkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IG51bGwKCQl9CgkJbGFzdFJlZHJhd0lkID0gbnVsbAoJCW0ucmVkcmF3LnN0cmF0ZWd5KCJkaWZmIikKCX0KCgl2YXIgcGVuZGluZ1JlcXVlc3RzID0gMAoJbS5zdGFydENvbXB1dGF0aW9uID0gZnVuY3Rpb24oKSB7cGVuZGluZ1JlcXVlc3RzKyt9CgltLmVuZENvbXB1dGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJcGVuZGluZ1JlcXVlc3RzID0gTWF0aC5tYXgocGVuZGluZ1JlcXVlc3RzIC0gMSwgMCkKCQlpZiAocGVuZGluZ1JlcXVlc3RzID09IDApIG0ucmVkcmF3KCkKCX0KCgltLndpdGhBdHRyID0gZnVuY3Rpb24ocHJvcCwgd2l0aEF0dHJDYWxsYmFjaykgewoJCXJldHVybiBmdW5jdGlvbihlKSB7CgkJCWUgPSBlIHx8IGV2ZW50CgkJCXZhciBjdXJyZW50VGFyZ2V0ID0gZS5jdXJyZW50VGFyZ2V0IHx8IHRoaXMKCQkJd2l0aEF0dHJDYWxsYmFjayhwcm9wIGluIGN1cnJlbnRUYXJnZXQgPyBjdXJyZW50VGFyZ2V0W3Byb3BdIDogY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUocHJvcCkpCgkJfQoJfQoKCS8vcm91dGluZwoJdmFyIG1vZGVzID0ge3BhdGhuYW1lOiAiIiwgaGFzaDogIiMiLCBzZWFyY2g6ICI/In0KCXZhciByZWRpcmVjdCA9IGZ1bmN0aW9uKCkge30sIHJvdXRlUGFyYW1zID0ge30sIGN1cnJlbnRSb3V0ZQoJbS5yb3V0ZSA9IGZ1bmN0aW9uKCkgewoJCWlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gY3VycmVudFJvdXRlCgkJZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMyAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09ICJzdHJpbmciKSB7CgkJCXZhciByb290ID0gYXJndW1lbnRzWzBdLCBkZWZhdWx0Um91dGUgPSBhcmd1bWVudHNbMV0sIHJvdXRlciA9IGFyZ3VtZW50c1syXQoJCQlyZWRpcmVjdCA9IGZ1bmN0aW9uKHNvdXJjZSkgewoJCQkJdmFyIHBhdGggPSBjdXJyZW50Um91dGUgPSBub3JtYWxpemVSb3V0ZShzb3VyY2UpCgkJCQlpZiAoIXJvdXRlQnlWYWx1ZShyb290LCByb3V0ZXIsIHBhdGgpKSB7CgkJCQkJbS5yb3V0ZShkZWZhdWx0Um91dGUsIHRydWUpCgkJCQl9CgkJCX0KCQkJdmFyIGxpc3RlbmVyID0gbS5yb3V0ZS5tb2RlID09ICJoYXNoIiA/ICJvbmhhc2hjaGFuZ2UiIDogIm9ucG9wc3RhdGUiCgkJCXdpbmRvd1tsaXN0ZW5lcl0gPSBmdW5jdGlvbigpIHsKCQkJCWlmIChjdXJyZW50Um91dGUgIT0gbm9ybWFsaXplUm91dGUod2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0pKSB7CgkJCQkJcmVkaXJlY3Qod2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0pCgkJCQl9CgkJCX0KCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gc2V0U2Nyb2xsCgkJCXdpbmRvd1tsaXN0ZW5lcl0oKQoJCX0KCQllbHNlIGlmIChhcmd1bWVudHNbMF0uYWRkRXZlbnRMaXN0ZW5lcikgewoJCQl2YXIgZWxlbWVudCA9IGFyZ3VtZW50c1swXQoJCQl2YXIgaXNJbml0aWFsaXplZCA9IGFyZ3VtZW50c1sxXQoJCQlpZiAoZWxlbWVudC5ocmVmLmluZGV4T2YobW9kZXNbbS5yb3V0ZS5tb2RlXSkgPCAwKSB7CgkJCQllbGVtZW50LmhyZWYgPSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyBtb2Rlc1ttLnJvdXRlLm1vZGVdICsgZWxlbWVudC5wYXRobmFtZQoJCQl9CgkJCWlmICghaXNJbml0aWFsaXplZCkgewoJCQkJZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJjbGljayIsIHJvdXRlVW5vYnRydXNpdmUpCgkJCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgcm91dGVVbm9idHJ1c2l2ZSkKCQkJfQoJCX0KCQllbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09ICJzdHJpbmciKSB7CgkJCWN1cnJlbnRSb3V0ZSA9IGFyZ3VtZW50c1swXQoJCQl2YXIgcXVlcnlzdHJpbmcgPSB0eXBlb2YgYXJndW1lbnRzWzFdID09ICJvYmplY3QiID8gYnVpbGRRdWVyeVN0cmluZyhhcmd1bWVudHNbMV0pIDogbnVsbAoJCQlpZiAocXVlcnlzdHJpbmcpIGN1cnJlbnRSb3V0ZSArPSAoY3VycmVudFJvdXRlLmluZGV4T2YoIj8iKSA9PT0gLTEgPyAiPyIgOiAiJiIpICsgcXVlcnlzdHJpbmcKCgkJCXZhciBzaG91bGRSZXBsYWNlSGlzdG9yeUVudHJ5ID0gKGFyZ3VtZW50cy5sZW5ndGggPT0gMyA/IGFyZ3VtZW50c1syXSA6IGFyZ3VtZW50c1sxXSkgPT09IHRydWUKCgkJCWlmICh3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUpIHsKCQkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IGZ1bmN0aW9uKCkgewoJCQkJCXdpbmRvdy5oaXN0b3J5W3Nob3VsZFJlcGxhY2VIaXN0b3J5RW50cnkgPyAicmVwbGFjZVN0YXRlIiA6ICJwdXNoU3RhdGUiXShudWxsLCB3aW5kb3cuZG9jdW1lbnQudGl0bGUsIG1vZGVzW20ucm91dGUubW9kZV0gKyBjdXJyZW50Um91dGUpCgkJCQkJc2V0U2Nyb2xsKCkKCQkJCX0KCQkJCXJlZGlyZWN0KG1vZGVzW20ucm91dGUubW9kZV0gKyBjdXJyZW50Um91dGUpCgkJCX0KCQkJZWxzZSB3aW5kb3cubG9jYXRpb25bbS5yb3V0ZS5tb2RlXSA9IGN1cnJlbnRSb3V0ZQoJCX0KCX0KCW0ucm91dGUucGFyYW0gPSBmdW5jdGlvbihrZXkpIHtyZXR1cm4gcm91dGVQYXJhbXNba2V5XX0KCW0ucm91dGUubW9kZSA9ICJzZWFyY2giCglmdW5jdGlvbiBub3JtYWxpemVSb3V0ZShyb3V0ZSkge3JldHVybiByb3V0ZS5zbGljZShtb2Rlc1ttLnJvdXRlLm1vZGVdLmxlbmd0aCl9CglmdW5jdGlvbiByb3V0ZUJ5VmFsdWUocm9vdCwgcm91dGVyLCBwYXRoKSB7CgkJcm91dGVQYXJhbXMgPSB7fQoKCQl2YXIgcXVlcnlTdGFydCA9IHBhdGguaW5kZXhPZigiPyIpCgkJaWYgKHF1ZXJ5U3RhcnQgIT09IC0xKSB7CgkJCXJvdXRlUGFyYW1zID0gcGFyc2VRdWVyeVN0cmluZyhwYXRoLnN1YnN0cihxdWVyeVN0YXJ0ICsgMSwgcGF0aC5sZW5ndGgpKQoJCQlwYXRoID0gcGF0aC5zdWJzdHIoMCwgcXVlcnlTdGFydCkKCQl9CgoJCWZvciAodmFyIHJvdXRlIGluIHJvdXRlcikgewoJCQlpZiAocm91dGUgPT0gcGF0aCkgewoJCQkJbS5tb2R1bGUocm9vdCwgcm91dGVyW3JvdXRlXSkKCQkJCXJldHVybiB0cnVlCgkJCX0KCgkJCXZhciBtYXRjaGVyID0gbmV3IFJlZ0V4cCgiXiIgKyByb3V0ZS5yZXBsYWNlKC86W15cL10rP1wuezN9L2csICIoLio/KSIpLnJlcGxhY2UoLzpbXlwvXSsvZywgIihbXlxcL10rKSIpICsgIlwvPyQiKQoKCQkJaWYgKG1hdGNoZXIudGVzdChwYXRoKSkgewoJCQkJcGF0aC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBrZXlzID0gcm91dGUubWF0Y2goLzpbXlwvXSsvZykgfHwgW10KCQkJCQl2YXIgdmFsdWVzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEsIC0yKQoJCQkJCWZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgcm91dGVQYXJhbXNba2V5c1tpXS5yZXBsYWNlKC86fFwuL2csICIiKV0gPSBkZWNvZGVVUklDb21wb25lbnQodmFsdWVzW2ldKQoJCQkJCW0ubW9kdWxlKHJvb3QsIHJvdXRlcltyb3V0ZV0pCgkJCQl9KQoJCQkJcmV0dXJuIHRydWUKCQkJfQoJCX0KCX0KCWZ1bmN0aW9uIHJvdXRlVW5vYnRydXNpdmUoZSkgewoJCWUgPSBlIHx8IGV2ZW50CgkJaWYgKGUuY3RybEtleSB8fCBlLm1ldGFLZXkgfHwgZS53aGljaCA9PSAyKSByZXR1cm4KCQllLnByZXZlbnREZWZhdWx0KCkKCQltLnJvdXRlKGUuY3VycmVudFRhcmdldFttLnJvdXRlLm1vZGVdLnNsaWNlKG1vZGVzW20ucm91dGUubW9kZV0ubGVuZ3RoKSkKCX0KCWZ1bmN0aW9uIHNldFNjcm9sbCgpIHsKCQlpZiAobS5yb3V0ZS5tb2RlICE9ICJoYXNoIiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaCkgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaAoJCWVsc2Ugd2luZG93LnNjcm9sbFRvKDAsIDApCgl9CglmdW5jdGlvbiBidWlsZFF1ZXJ5U3RyaW5nKG9iamVjdCwgcHJlZml4KSB7CgkJdmFyIHN0ciA9IFtdCgkJZm9yKHZhciBwcm9wIGluIG9iamVjdCkgewoJCQl2YXIga2V5ID0gcHJlZml4ID8gcHJlZml4ICsgIlsiICsgcHJvcCArICJdIiA6IHByb3AsIHZhbHVlID0gb2JqZWN0W3Byb3BdCgkJCXN0ci5wdXNoKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IiA/IGJ1aWxkUXVlcnlTdHJpbmcodmFsdWUsIGtleSkgOiBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpCgkJfQoJCXJldHVybiBzdHIuam9pbigiJiIpCgl9CglmdW5jdGlvbiBwYXJzZVF1ZXJ5U3RyaW5nKHN0cikgewoJCXZhciBwYWlycyA9IHN0ci5zcGxpdCgiJiIpLCBwYXJhbXMgPSB7fQoJCWZvciAodmFyIGkgPSAwOyBpIDwgcGFpcnMubGVuZ3RoOyBpKyspIHsKCQkJdmFyIHBhaXIgPSBwYWlyc1tpXS5zcGxpdCgiPSIpCgkJCXBhcmFtc1tkZWNvZGVTcGFjZShwYWlyWzBdKV0gPSBwYWlyWzFdID8gZGVjb2RlU3BhY2UocGFpclsxXSkgOiAocGFpci5sZW5ndGggPT09IDEgPyB0cnVlIDogIiIpCgkJfQoJCXJldHVybiBwYXJhbXMKCX0KCWZ1bmN0aW9uIGRlY29kZVNwYWNlKHN0cmluZykgewoJCXJldHVybiBkZWNvZGVVUklDb21wb25lbnQoc3RyaW5nLnJlcGxhY2UoL1wrL2csICIgIikpCgl9CglmdW5jdGlvbiByZXNldChyb290KSB7CgkJdmFyIGNhY2hlS2V5ID0gZ2V0Q2VsbENhY2hlS2V5KHJvb3QpCgkJY2xlYXIocm9vdC5jaGlsZE5vZGVzLCBjZWxsQ2FjaGVbY2FjaGVLZXldKQoJCWNlbGxDYWNoZVtjYWNoZUtleV0gPSB1bmRlZmluZWQKCX0KCglmdW5jdGlvbiBuZXdQcm9taXNlZFByb3AocHJvcCwgcHJvbWlzZSkgewoJCXByb3AudGhlbiA9IGZ1bmN0aW9uICgpIHsKCQkJdmFyIG5ld1Byb3AgPSBtLnByb3AoKQoJCQlyZXR1cm4gbmV3UHJvbWlzZWRQcm9wKG5ld1Byb3AsCgkJCQlwcm9taXNlLnRoZW4uYXBwbHkocHJvbWlzZSwgYXJndW1lbnRzKS50aGVuKG5ld1Byb3ApKQoJCX0KCQlwcm9wLnByb21pc2UgPSBwcm9wCgkJcHJvcC5yZXNvbHZlID0gZnVuY3Rpb24gKHZhbCkgewoJCQlwcm9wKHZhbCkKCQkJcHJvbWlzZSA9IHByb21pc2UucmVzb2x2ZS5hcHBseShwcm9taXNlLCBhcmd1bWVudHMpCgkJCXJldHVybiBwcm9wCgkJfQoJCXByb3AucmVqZWN0ID0gZnVuY3Rpb24gKCkgewoJCQlwcm9taXNlID0gcHJvbWlzZS5yZWplY3QuYXBwbHkocHJvbWlzZSwgYXJndW1lbnRzKQoJCQlyZXR1cm4gcHJvcAoJCX0KCgkJcmV0dXJuIHByb3AKCX0KCW0uZGVmZXJyZWQgPSBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuIG5ld1Byb21pc2VkUHJvcChtLnByb3AoKSwgbmV3IERlZmVycmVkKCkpCgl9CgkvLyBQcm9taXoubWl0aHJpbC5qcyB8IFpvbG1laXN0ZXIgfCBNSVQKCWZ1bmN0aW9uIERlZmVycmVkKGZuLCBlcikgewoJCS8vIHN0YXRlcwoJCS8vIDA6IHBlbmRpbmcKCQkvLyAxOiByZXNvbHZpbmcKCQkvLyAyOiByZWplY3RpbmcKCQkvLyAzOiByZXNvbHZlZAoJCS8vIDQ6IHJlamVjdGVkCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzdGF0ZSA9IDAsCgkJCXZhbCA9IDAsCgkJCW5leHQgPSBbXTsKCgkJc2VsZlsncHJvbWlzZSddID0gc2VsZgoKCQlzZWxmWydyZXNvbHZlJ10gPSBmdW5jdGlvbiAodikgewoJCQlpZiAoIXN0YXRlKSB7CgkJCQl2YWwgPSB2CgkJCQlzdGF0ZSA9IDEKCgkJCQlmaXJlKCkKCQkJfQoJCQlyZXR1cm4gdGhpcwoJCX0KCgkJc2VsZlsncmVqZWN0J10gPSBmdW5jdGlvbiAodikgewoJCQlpZiAoIXN0YXRlKSB7CgkJCQl2YWwgPSB2CgkJCQlzdGF0ZSA9IDIKCgkJCQlmaXJlKCkKCQkJfQoJCQlyZXR1cm4gdGhpcwoJCX0KCgkJc2VsZlsndGhlbiddID0gZnVuY3Rpb24gKGZuLCBlcikgewoJCQl2YXIgZCA9IG5ldyBEZWZlcnJlZChmbiwgZXIpCgkJCWlmIChzdGF0ZSA9PSAzKSB7CgkJCQlkLnJlc29sdmUodmFsKQoJCQl9CgkJCWVsc2UgaWYgKHN0YXRlID09IDQpIHsKCQkJCWQucmVqZWN0KHZhbCkKCQkJfQoJCQllbHNlIHsKCQkJCW5leHQucHVzaChkKQoJCQl9CgkJCXJldHVybiBkCgkJfQoKCQl2YXIgZmluaXNoID0gZnVuY3Rpb24gKHR5cGUpIHsKCQkJc3RhdGUgPSB0eXBlIHx8IDQKCQkJbmV4dC5tYXAoZnVuY3Rpb24gKHApIHsKCQkJCXN0YXRlID09IDMgJiYgcC5yZXNvbHZlKHZhbCkgfHwgcC5yZWplY3QodmFsKQoJCQl9KQoJCX0KCgkJLy8gcmVmIDogcmVmZXJlbmNlIHRvICd0aGVuJyBmdW5jdGlvbgoJCS8vIGNiLCBlYywgY24gOiBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaywgbm90VGhlbm5hYmxlQ2FsbGJhY2sKCQlmdW5jdGlvbiB0aGVubmFibGUgKHJlZiwgY2IsIGVjLCBjbikgewoJCQlpZiAoKHR5cGVvZiB2YWwgPT0gJ29iamVjdCcgfHwgdHlwZW9mIHZhbCA9PSAnZnVuY3Rpb24nKSAmJiB0eXBlb2YgcmVmID09ICdmdW5jdGlvbicpIHsKCQkJCXRyeSB7CgoJCQkJCS8vIGNudCBwcm90ZWN0cyBhZ2FpbnN0IGFidXNlIGNhbGxzIGZyb20gc3BlYyBjaGVja2VyCgkJCQkJdmFyIGNudCA9IDAKCQkJCQlyZWYuY2FsbCh2YWwsIGZ1bmN0aW9uICh2KSB7CgkJCQkJCWlmIChjbnQrKykgcmV0dXJuCgkJCQkJCXZhbCA9IHYKCQkJCQkJY2IoKQoJCQkJCX0sIGZ1bmN0aW9uICh2KSB7CgkJCQkJCWlmIChjbnQrKykgcmV0dXJuCgkJCQkJCXZhbCA9IHYKCQkJCQkJZWMoKQoJCQkJCX0pCgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJdmFsID0gZQoJCQkJCWVjKCkKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWNuKCkKCQkJfQoJCX07CgoJCWZ1bmN0aW9uIGZpcmUoKSB7CgoJCQkvLyBjaGVjayBpZiBpdCdzIGEgdGhlbmFibGUKCQkJdmFyIHJlZjsKCQkJdHJ5IHsKCQkJCXJlZiA9IHZhbCAmJiB2YWwudGhlbgoJCQl9IGNhdGNoIChlKSB7CgkJCQl2YWwgPSBlCgkJCQlzdGF0ZSA9IDIKCQkJCXJldHVybiBmaXJlKCkKCQkJfQoJCQl0aGVubmFibGUocmVmLCBmdW5jdGlvbiAoKSB7CgkJCQlzdGF0ZSA9IDEKCQkJCWZpcmUoKQoJCQl9LCBmdW5jdGlvbiAoKSB7CgkJCQlzdGF0ZSA9IDIKCQkJCWZpcmUoKQoJCQl9LCBmdW5jdGlvbiAoKSB7CgkJCQl0cnkgewoJCQkJCWlmIChzdGF0ZSA9PSAxICYmIHR5cGVvZiBmbiA9PSAnZnVuY3Rpb24nKSB7CgkJCQkJCXZhbCA9IGZuKHZhbCkKCQkJCQl9CgoJCQkJCWVsc2UgaWYgKHN0YXRlID09IDIgJiYgdHlwZW9mIGVyID09ICdmdW5jdGlvbicpIHsKCQkJCQkJdmFsID0gZXIodmFsKQoJCQkJCQlzdGF0ZSA9IDEKCQkJCQl9CgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJdmFsID0gZQoJCQkJCXJldHVybiBmaW5pc2goKQoJCQkJfQoKCQkJCWlmICh2YWwgPT0gc2VsZikgewoJCQkJCXZhbCA9IFR5cGVFcnJvcigpCgkJCQkJZmluaXNoKCkKCQkJCX0gZWxzZSB0aGVubmFibGUocmVmLCBmdW5jdGlvbiAoKSB7CgkJCQkJCWZpbmlzaCgzKQoJCQkJCX0sIGZpbmlzaCwgZnVuY3Rpb24gKCkgewoJCQkJCQlmaW5pc2goc3RhdGUgPT0gMSAmJiAzKQoJCQkJCX0pCgoJCQl9KQoJCX0KCX0KCgltLnN5bmMgPSBmdW5jdGlvbihhcmdzKSB7CgkJdmFyIG1ldGhvZCA9ICJyZXNvbHZlIgoJCWZ1bmN0aW9uIHN5bmNocm9uaXplcihwb3MsIHJlc29sdmVkKSB7CgkJCXJldHVybiBmdW5jdGlvbih2YWx1ZSkgewoJCQkJcmVzdWx0c1twb3NdID0gdmFsdWUKCQkJCWlmICghcmVzb2x2ZWQpIG1ldGhvZCA9ICJyZWplY3QiCgkJCQlpZiAoLS1vdXRzdGFuZGluZyA9PSAwKSB7CgkJCQkJZGVmZXJyZWQucHJvbWlzZShyZXN1bHRzKQoJCQkJCWRlZmVycmVkW21ldGhvZF0ocmVzdWx0cykKCQkJCX0KCQkJCXJldHVybiB2YWx1ZQoJCQl9CgkJfQoKCQl2YXIgZGVmZXJyZWQgPSBtLmRlZmVycmVkKCkKCQl2YXIgb3V0c3RhbmRpbmcgPSBhcmdzLmxlbmd0aAoJCXZhciByZXN1bHRzID0gbmV3IEFycmF5KG91dHN0YW5kaW5nKQoJCWlmIChhcmdzLmxlbmd0aCA+IDApIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CgkJCQlhcmdzW2ldLnRoZW4oc3luY2hyb25pemVyKGksIHRydWUpLCBzeW5jaHJvbml6ZXIoaSwgZmFsc2UpKQoJCQl9CgkJfQoJCWVsc2UgZGVmZXJyZWQucmVzb2x2ZSgpCgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlCgl9CglmdW5jdGlvbiBpZGVudGl0eSh2YWx1ZSkge3JldHVybiB2YWx1ZX0KCglmdW5jdGlvbiBhamF4KG9wdGlvbnMpIHsKCQl2YXIgeGhyID0gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdAoJCXhoci5vcGVuKG9wdGlvbnMubWV0aG9kLCBvcHRpb25zLnVybCwgdHJ1ZSwgb3B0aW9ucy51c2VyLCBvcHRpb25zLnBhc3N3b3JkKQoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQkJaWYgKHhoci5yZWFkeVN0YXRlID09PSA0KSB7CgkJCQlpZiAoeGhyLnN0YXR1cyA+PSAyMDAgJiYgeGhyLnN0YXR1cyA8IDMwMCkgb3B0aW9ucy5vbmxvYWQoe3R5cGU6ICJsb2FkIiwgdGFyZ2V0OiB4aHJ9KQoJCQkJZWxzZSBvcHRpb25zLm9uZXJyb3Ioe3R5cGU6ICJlcnJvciIsIHRhcmdldDogeGhyfSkKCQkJfQoJCX0KCQlpZiAob3B0aW9ucy5zZXJpYWxpemUgPT0gSlNPTi5zdHJpbmdpZnkgJiYgb3B0aW9ucy5tZXRob2QgIT0gIkdFVCIpIHsKCQkJeGhyLnNldFJlcXVlc3RIZWFkZXIoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04Iik7CgkJfQoJCWlmICh0eXBlb2Ygb3B0aW9ucy5jb25maWcgPT0gImZ1bmN0aW9uIikgewoJCQl2YXIgbWF5YmVYaHIgPSBvcHRpb25zLmNvbmZpZyh4aHIsIG9wdGlvbnMpCgkJCWlmIChtYXliZVhociAhPSBudWxsKSB4aHIgPSBtYXliZVhocgoJCX0KCQl4aHIuc2VuZChvcHRpb25zLm1ldGhvZCA9PSAiR0VUIiA/ICIiIDogb3B0aW9ucy5kYXRhKQoJCXJldHVybiB4aHIKCX0KCWZ1bmN0aW9uIGJpbmREYXRhKHhock9wdGlvbnMsIGRhdGEsIHNlcmlhbGl6ZSkgewoJCWlmIChkYXRhICYmIE9iamVjdC5rZXlzKGRhdGEpLmxlbmd0aCA+IDApIHsKCQkJaWYgKHhock9wdGlvbnMubWV0aG9kID09ICJHRVQiKSB7CgkJCQl4aHJPcHRpb25zLnVybCA9IHhock9wdGlvbnMudXJsICsgKHhock9wdGlvbnMudXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgYnVpbGRRdWVyeVN0cmluZyhkYXRhKQoJCQl9CgkJCWVsc2UgeGhyT3B0aW9ucy5kYXRhID0gc2VyaWFsaXplKGRhdGEpCgkJfQoJCXJldHVybiB4aHJPcHRpb25zCgl9CglmdW5jdGlvbiBwYXJhbWV0ZXJpemVVcmwodXJsLCBkYXRhKSB7CgkJdmFyIHRva2VucyA9IHVybC5tYXRjaCgvOlthLXpdXHcrL2dpKQoJCWlmICh0b2tlbnMgJiYgZGF0YSkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKykgewoJCQkJdmFyIGtleSA9IHRva2Vuc1tpXS5zbGljZSgxKQoJCQkJdXJsID0gdXJsLnJlcGxhY2UodG9rZW5zW2ldLCBkYXRhW2tleV0pCgkJCQlkZWxldGUgZGF0YVtrZXldCgkJCX0KCQl9CgkJcmV0dXJuIHVybAoJfQoKCW0ucmVxdWVzdCA9IGZ1bmN0aW9uKHhock9wdGlvbnMpIHsKCQlpZiAoeGhyT3B0aW9ucy5iYWNrZ3JvdW5kICE9PSB0cnVlKSBtLnN0YXJ0Q29tcHV0YXRpb24oKQoJCXZhciBkZWZlcnJlZCA9IG0uZGVmZXJyZWQoKQoJCXZhciBzZXJpYWxpemUgPSB4aHJPcHRpb25zLnNlcmlhbGl6ZSA9IHhock9wdGlvbnMuc2VyaWFsaXplIHx8IEpTT04uc3RyaW5naWZ5CgkJdmFyIGRlc2VyaWFsaXplID0geGhyT3B0aW9ucy5kZXNlcmlhbGl6ZSA9IHhock9wdGlvbnMuZGVzZXJpYWxpemUgfHwgSlNPTi5wYXJzZQoJCXZhciBleHRyYWN0ID0geGhyT3B0aW9ucy5leHRyYWN0IHx8IGZ1bmN0aW9uKHhocikgewoJCQlyZXR1cm4geGhyLnJlc3BvbnNlVGV4dC5sZW5ndGggPT09IDAgJiYgZGVzZXJpYWxpemUgPT09IEpTT04ucGFyc2UgPyBudWxsIDogeGhyLnJlc3BvbnNlVGV4dAoJCX0KCQl4aHJPcHRpb25zLnVybCA9IHBhcmFtZXRlcml6ZVVybCh4aHJPcHRpb25zLnVybCwgeGhyT3B0aW9ucy5kYXRhKQoJCXhock9wdGlvbnMgPSBiaW5kRGF0YSh4aHJPcHRpb25zLCB4aHJPcHRpb25zLmRhdGEsIHNlcmlhbGl6ZSkKCQl4aHJPcHRpb25zLm9ubG9hZCA9IHhock9wdGlvbnMub25lcnJvciA9IGZ1bmN0aW9uKGUpIHsKCQkJdHJ5IHsKCQkJCWUgPSBlIHx8IGV2ZW50CgkJCQl2YXIgdW53cmFwID0gKGUudHlwZSA9PSAibG9hZCIgPyB4aHJPcHRpb25zLnVud3JhcFN1Y2Nlc3MgOiB4aHJPcHRpb25zLnVud3JhcEVycm9yKSB8fCBpZGVudGl0eQoJCQkJdmFyIHJlc3BvbnNlID0gdW53cmFwKGRlc2VyaWFsaXplKGV4dHJhY3QoZS50YXJnZXQsIHhock9wdGlvbnMpKSkKCQkJCWlmIChlLnR5cGUgPT0gImxvYWQiKSB7CgkJCQkJaWYgKHR5cGUuY2FsbChyZXNwb25zZSkgPT0gIltvYmplY3QgQXJyYXldIiAmJiB4aHJPcHRpb25zLnR5cGUpIHsKCQkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNwb25zZS5sZW5ndGg7IGkrKykgcmVzcG9uc2VbaV0gPSBuZXcgeGhyT3B0aW9ucy50eXBlKHJlc3BvbnNlW2ldKQoJCQkJCX0KCQkJCQllbHNlIGlmICh4aHJPcHRpb25zLnR5cGUpIHJlc3BvbnNlID0gbmV3IHhock9wdGlvbnMudHlwZShyZXNwb25zZSkKCQkJCX0KCQkJCWRlZmVycmVkW2UudHlwZSA9PSAibG9hZCIgPyAicmVzb2x2ZSIgOiAicmVqZWN0Il0ocmVzcG9uc2UpCgkJCX0KCQkJY2F0Y2ggKGUpIHsKCQkJCWlmIChlIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpIHRocm93IG5ldyBTeW50YXhFcnJvcigiQ291bGQgbm90IHBhcnNlIEhUVFAgcmVzcG9uc2UuIFNlZSBodHRwOi8vbGhvcmllLmdpdGh1Yi5pby9taXRocmlsL21pdGhyaWwucmVxdWVzdC5odG1sI3VzaW5nLXZhcmlhYmxlLWRhdGEtZm9ybWF0cyIpCgkJCQllbHNlIGlmICh0eXBlLmNhbGwoZSkgPT0gIltvYmplY3QgRXJyb3JdIiAmJiBlLmNvbnN0cnVjdG9yICE9PSBFcnJvcikgdGhyb3cgZQoJCQkJZWxzZSBkZWZlcnJlZC5yZWplY3QoZSkKCQkJfQoJCQlpZiAoeGhyT3B0aW9ucy5iYWNrZ3JvdW5kICE9PSB0cnVlKSBtLmVuZENvbXB1dGF0aW9uKCkKCQl9CgkJYWpheCh4aHJPcHRpb25zKQoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlCgl9CgoJLy90ZXN0aW5nIEFQSQoJbS5kZXBzID0gZnVuY3Rpb24obW9jaykge3JldHVybiB3aW5kb3cgPSBtb2NrfQoJLy9mb3IgaW50ZXJuYWwgdGVzdGluZyBvbmx5LCBkbyBub3QgdXNlIGBtLmRlcHMuZmFjdG9yeWAKCW0uZGVwcy5mYWN0b3J5ID0gYXBwCgoJcmV0dXJuIG0KfSh0eXBlb2Ygd2luZG93ICE9ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCgppZiAodHlwZW9mIG1vZHVsZSAhPSAidW5kZWZpbmVkIiAmJiBtb2R1bGUgIT09IG51bGwpIG1vZHVsZS5leHBvcnRzID0gbQppZiAodHlwZW9mIGRlZmluZSA9PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIGRlZmluZShmdW5jdGlvbigpIHtyZXR1cm4gbX0pCgo7Ozs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 16:12:23 GMT",
                    "Content-Length": "30140",
                    "Date": "Fri, 07 Nov 2014 16:12:23 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}