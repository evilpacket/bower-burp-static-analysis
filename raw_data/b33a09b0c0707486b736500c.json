{
    "url": "http://localhost:9999/ariya/esprima/test/3rdparty/jquery.mobile-1.4.2.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statement:<ul><li>location.href = location.href.replace( /#.*/, '' ) + history_hash;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/ariya/esprima/test/3rdparty/jquery.mobile-1.4.2.js",
                "path": "/ariya/esprima/test/3rdparty/jquery.mobile-1.4.2.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9hcml5YS9lc3ByaW1hL3Rlc3QvM3JkcGFydHkvanF1ZXJ5Lm1vYmlsZS0xLjQuMi5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDUyODA0DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDIzOjI0OjU0IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAyMzoyNDo1MyBHTVQNCg0KLyohCiogalF1ZXJ5IE1vYmlsZSAxLjQuMgoqIEdpdCBIRUFEIGhhc2g6IDlkOWE0MmEyN2QwYzY5M2U4YjU1NjljM2ExMGQ3NzE5MTZhZjUwNDUgPD4gRGF0ZTogRnJpIEZlYiAyOCAyMDE0IDE3OjMyOjAxIFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxNCBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwoKCihmdW5jdGlvbiAoIHJvb3QsIGRvYywgZmFjdG9yeSApIHsKCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlkZWZpbmUoIFsgImpxdWVyeSIgXSwgZnVuY3Rpb24gKCAkICkgewoJCQlmYWN0b3J5KCAkLCByb290LCBkb2MgKTsKCQkJcmV0dXJuICQubW9iaWxlOwoJCX0pOwoJfSBlbHNlIHsKCQkvLyBCcm93c2VyIGdsb2JhbHMKCQlmYWN0b3J5KCByb290LmpRdWVyeSwgcm9vdCwgZG9jICk7Cgl9Cn0oIHRoaXMsIGRvY3VtZW50LCBmdW5jdGlvbiAoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewooZnVuY3Rpb24oICQgKSB7CgkkLm1vYmlsZSA9IHt9Owp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuNC4yIiwKCgkJLy8gRGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIHVzZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCWhpZGVVcmxCYXI6IHRydWUsCgoJCS8vIEtlZXBuYXRpdmUgU2VsZWN0b3IKCQlrZWVwTmF0aXZlOiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQkvLyBEZXByZWNhdGVkIHJlbW92ZSBpbiAxLjUKCQltaW5TY3JvbGxCYWNrOiAwLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZXM/CgkJcGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZTogImEiLAoKCQkvLyByZXBsYWNlIGNhbGxzIHRvIHdpbmRvdy5oaXN0b3J5LmJhY2sgd2l0aCBwaG9uZWdhcHMgbmF2aWdhdGlvbiBoZWxwZXIKCQkvLyB3aGVyZSBpdCBpcyBwcm92aWRlZCBvbiB0aGUgd2luZG93IG9iamVjdAoJCXBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQ6IGZhbHNlLAoKCQkvL2F1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgRE9NIHdoZW4gaXQncyByZWFkeQoJCWF1dG9Jbml0aWFsaXplUGFnZTogdHJ1ZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gYWxsb3dzIHVzZXJzIHRvIG9wdCBpbiB0byBpZ25vcmluZyBjb250ZW50IGJ5IG1hcmtpbmcgYSBwYXJlbnQgZWxlbWVudCBhcwoJCS8vIGRhdGEtaWdub3JlZAoJCWlnbm9yZUNvbnRlbnRFbmFibGVkOiBmYWxzZSwKCgkJYnV0dG9uTWFya3VwOiB7CgkJCWhvdmVyRGVsYXk6IDIwMAoJCX0sCgoJCS8vIGRpc2FibGUgdGhlIGFsdGVyYXRpb24gb2YgdGhlIGR5bmFtaWMgYmFzZSB0YWcgb3IgbGlua3MgaW4gdGhlIGNhc2UKCQkvLyB0aGF0IGEgZHluYW1pYyBiYXNlIHRhZyBpc24ndCBzdXBwb3J0ZWQKCQlkeW5hbWljQmFzZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGRlZmF1bHQgdGhlIHByb3BlcnR5IHRvIHJlbW92ZSBkZXBlbmRlbmN5IG9uIGFzc2lnbm1lbnQgaW4gaW5pdCBtb2R1bGUKCQlwYWdlQ29udGFpbmVyOiAkKCksCgoJCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCQlhbGxvd0Nyb3NzRG9tYWluUGFnZXM6IGZhbHNlLAoKCQlkaWFsb2dIYXNoS2V5OiAiJnVpLXN0YXRlPWRpYWxvZyIKCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9LAoJCW9sZEZpbmQgPSAkLmZpbmQsCgkJcmJyYWNlID0gLyg/Olx7W1xzXFNdKlx9fFxbW1xzXFNdKlxdKSQvLAoJCWpxbURhdGFSRSA9IC86anFtRGF0YVwoKFteKV0qKVwpL2c7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIE5hbWVzcGFjZSB1c2VkIGZyYW1ld29yay13aWRlIGZvciBkYXRhLWF0dHJzLiBEZWZhdWx0IGlzIG5vIG5hbWVzcGFjZQoKCQluczogIiIsCgoJCS8vIFJldHJpZXZlIGFuIGF0dHJpYnV0ZSBmcm9tIGFuIGVsZW1lbnQgYW5kIHBlcmZvcm0gc29tZSBtYXNzYWdpbmcgb2YgdGhlIHZhbHVlCgoJCWdldEF0dHJpYnV0ZTogZnVuY3Rpb24oIGVsZW1lbnQsIGtleSApIHsKCQkJdmFyIGRhdGE7CgoJCQllbGVtZW50ID0gZWxlbWVudC5qcXVlcnkgPyBlbGVtZW50WzBdIDogZWxlbWVudDsKCgkJCWlmICggZWxlbWVudCAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZSApIHsKCQkJCWRhdGEgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsga2V5ICk7CgkJCX0KCgkJCS8vIENvcGllZCBmcm9tIGNvcmUncyBzcmMvZGF0YS5qczpkYXRhQXR0cigpCgkJCS8vIENvbnZlcnQgZnJvbSBhIHN0cmluZyB0byBhIHByb3BlciBkYXRhIHR5cGUKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQlkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkJK2RhdGEgKyAiIiA9PT0gZGF0YSA/ICtkYXRhIDoKCQkJCQlyYnJhY2UudGVzdCggZGF0YSApID8gSlNPTi5wYXJzZSggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlcnIgKSB7fQoKCQkJcmV0dXJuIGRhdGE7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8CgkJCQkoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCS5kYXRhKCAibW9iaWxlLXBhZ2UiICk7CgkJfQoKCX0pOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlpZiAoIHByb3AgKSB7CgkJCQlwcm9wID0gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKTsKCQkJfQoKCQkJLy8gdW5kZWZpbmVkIGlzIHBlcm1pdHRlZCBhcyBhbiBleHBsaWNpdCBpbnB1dCBmb3IgdGhlIHNlY29uZCBwYXJhbQoJCQkvLyBpbiB0aGlzIGNhc2UgaXQgcmV0dXJucyB0aGUgdmFsdWUgYW5kIGRvZXMgbm90IHNldCBpdCB0byB1bmRlZmluZWQKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5maW5kID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICkgewoJCWlmICggc2VsZWN0b3IuaW5kZXhPZiggIjpqcW1EYXRhIiApID4gLTEgKSB7CgkJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgganFtRGF0YVJFLCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICIkMV0iICk7CgkJfQoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKiEKICogalF1ZXJ5IFVJIENvcmUgYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MAogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NhdGVnb3J5L3VpLWNvcmUvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXJ1bmlxdWVJZCA9IC9edWktaWQtXGQrJC87CgovLyAkLnVpIG1pZ2h0IGV4aXN0IGZyb20gY29tcG9uZW50cyB3aXRoIG5vIGRlcGVuZGVuY2llcywgZS5nLiwgJC51aS5wb3NpdGlvbgokLnVpID0gJC51aSB8fCB7fTsKCiQuZXh0ZW5kKCAkLnVpLCB7Cgl2ZXJzaW9uOiAiYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MCIsCgoJa2V5Q29kZTogewoJCUJBQ0tTUEFDRTogOCwKCQlDT01NQTogMTg4LAoJCURFTEVURTogNDYsCgkJRE9XTjogNDAsCgkJRU5EOiAzNSwKCQlFTlRFUjogMTMsCgkJRVNDQVBFOiAyNywKCQlIT01FOiAzNiwKCQlMRUZUOiAzNywKCQlQQUdFX0RPV046IDM0LAoJCVBBR0VfVVA6IDMzLAoJCVBFUklPRDogMTkwLAoJCVJJR0hUOiAzOSwKCQlTUEFDRTogMzIsCgkJVEFCOiA5LAoJCVVQOiAzOAoJfQp9KTsKCi8vIHBsdWdpbnMKJC5mbi5leHRlbmQoewoJZm9jdXM6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGRlbGF5LCBmbiApIHsKCQkJcmV0dXJuIHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgPwoJCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtID0gdGhpczsKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJCQkJaWYgKCBmbiApIHsKCQkJCQkJCWZuLmNhbGwoIGVsZW0gKTsKCQkJCQkJfQoJCQkJCX0sIGRlbGF5ICk7CgkJCQl9KSA6CgkJCQlvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSkoICQuZm4uZm9jdXMgKSwKCglzY3JvbGxQYXJlbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JvbGxQYXJlbnQ7CgkJaWYgKCgkLnVpLmllICYmICgvKHN0YXRpY3xyZWxhdGl2ZSkvKS50ZXN0KHRoaXMuY3NzKCJwb3NpdGlvbiIpKSkgfHwgKC9hYnNvbHV0ZS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB7CgkJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoLyhyZWxhdGl2ZXxhYnNvbHV0ZXxmaXhlZCkvKS50ZXN0KCQuY3NzKHRoaXMsInBvc2l0aW9uIikpICYmICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfSBlbHNlIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfQoKCQlyZXR1cm4gKCAvZml4ZWQvICkudGVzdCggdGhpcy5jc3MoICJwb3NpdGlvbiIpICkgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApIDogc2Nyb2xsUGFyZW50OwoJfSwKCgl1bmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5pZCApIHsKCQkJCXRoaXMuaWQgPSAidWktaWQtIiArICgrK3V1aWQpOwoJCQl9CgkJfSk7Cgl9LAoKCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHJ1bmlxdWVJZC50ZXN0KCB0aGlzLmlkICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggImlkIiApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy8gc2VsZWN0b3JzCmZ1bmN0aW9uIGZvY3VzYWJsZSggZWxlbWVudCwgaXNUYWJJbmRleE5vdE5hTiApIHsKCXZhciBtYXAsIG1hcE5hbWUsIGltZywKCQlub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsKCQltYXAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJbWFwTmFtZSA9IG1hcC5uYW1lOwoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaW1nID0gJCggImltZ1t1c2VtYXA9IyIgKyBtYXBOYW1lICsgIl0iIClbMF07CgkJcmV0dXJuICEhaW1nICYmIHZpc2libGUoIGltZyApOwoJfQoJcmV0dXJuICggL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0Ly50ZXN0KCBub2RlTmFtZSApID8KCQkhZWxlbWVudC5kaXNhYmxlZCA6CgkJImEiID09PSBub2RlTmFtZSA/CgkJCWVsZW1lbnQuaHJlZiB8fCBpc1RhYkluZGV4Tm90TmFOIDoKCQkJaXNUYWJJbmRleE5vdE5hTikgJiYKCQkvLyB0aGUgZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBhbmNlc3RvcnMgbXVzdCBiZSB2aXNpYmxlCgkJdmlzaWJsZSggZWxlbWVudCApOwp9CgpmdW5jdGlvbiB2aXNpYmxlKCBlbGVtZW50ICkgewoJcmV0dXJuICQuZXhwci5maWx0ZXJzLnZpc2libGUoIGVsZW1lbnQgKSAmJgoJCSEkKCBlbGVtZW50ICkucGFyZW50cygpLmFkZEJhY2soKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLmNzcyggdGhpcywgInZpc2liaWxpdHkiICkgPT09ICJoaWRkZW4iOwoJCX0pLmxlbmd0aDsKfQoKJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oZnVuY3Rpb24oIGRhdGFOYW1lICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGRhdGFOYW1lICk7CgkJCX07CgkJfSkgOgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9LAoKCWZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzTmFOKCAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSApICk7Cgl9LAoKCXRhYmJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwKCQkJaXNUYWJJbmRleE5hTiA9IGlzTmFOKCB0YWJJbmRleCApOwoJCXJldHVybiAoIGlzVGFiSW5kZXhOYU4gfHwgdGFiSW5kZXggPj0gMCApICYmIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzVGFiSW5kZXhOYU4gKTsKCX0KfSk7CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkKCAiPGE+IiApLm91dGVyV2lkdGgoIDEgKS5qcXVlcnkgKSB7CgkkLmVhY2goIFsgIldpZHRoIiwgIkhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJdmFyIHNpZGUgPSBuYW1lID09PSAiV2lkdGgiID8gWyAiTGVmdCIsICJSaWdodCIgXSA6IFsgIlRvcCIsICJCb3R0b20iIF0sCgkJCXR5cGUgPSBuYW1lLnRvTG93ZXJDYXNlKCksCgkJCW9yaWcgPSB7CgkJCQlpbm5lcldpZHRoOiAkLmZuLmlubmVyV2lkdGgsCgkJCQlpbm5lckhlaWdodDogJC5mbi5pbm5lckhlaWdodCwKCQkJCW91dGVyV2lkdGg6ICQuZm4ub3V0ZXJXaWR0aCwKCQkJCW91dGVySGVpZ2h0OiAkLmZuLm91dGVySGVpZ2h0CgkJCX07CgoJCWZ1bmN0aW9uIHJlZHVjZSggZWxlbSwgc2l6ZSwgYm9yZGVyLCBtYXJnaW4gKSB7CgkJCSQuZWFjaCggc2lkZSwgZnVuY3Rpb24oKSB7CgkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAicGFkZGluZyIgKyB0aGlzICkgKSB8fCAwOwoJCQkJaWYgKCBib3JkZXIgKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgImJvcmRlciIgKyB0aGlzICsgIldpZHRoIiApICkgfHwgMDsKCQkJCX0KCQkJCWlmICggbWFyZ2luICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJtYXJnaW4iICsgdGhpcyApICkgfHwgMDsKCQkJCX0KCQkJfSk7CgkJCXJldHVybiBzaXplOwoJCX0KCgkJJC5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplICkgewoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBvcmlnWyAiaW5uZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOwoJCQl9KTsKCQl9OwoKCQkkLmZuWyAib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgewoJCQlpZiAoIHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiApIHsKCQkJCXJldHVybiBvcmlnWyAib3V0ZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMsIHNpemUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMpLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplLCB0cnVlLCBtYXJnaW4gKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCX0pOwp9CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgovLyBzdXBwb3J0OiBqUXVlcnkgMS42LjEsIDEuNi4yIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzKQppZiAoICQoICI8YT4iICkuZGF0YSggImEtYiIsICJhIiApLnJlbW92ZURhdGEoICJhLWIiICkuZGF0YSggImEtYiIgKSApIHsKCSQuZm4ucmVtb3ZlRGF0YSA9IChmdW5jdGlvbiggcmVtb3ZlRGF0YSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGtleSApIHsKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcywgJC5jYW1lbENhc2UoIGtleSApICk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4ucmVtb3ZlRGF0YSApOwp9CgoKCgoKLy8gZGVwcmVjYXRlZAokLnVpLmllID0gISEvbXNpZSBbXHcuXSsvLmV4ZWMoIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSApOwoKJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CiQuZm4uZXh0ZW5kKHsKCWRpc2FibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmJpbmQoICggJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID8gInNlbGVjdHN0YXJ0IiA6ICJtb3VzZWRvd24iICkgKwoJCQkiLnVpLWRpc2FibGVTZWxlY3Rpb24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0sCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy51bmJpbmQoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0sCgoJekluZGV4OiBmdW5jdGlvbiggekluZGV4ICkgewoJCWlmICggekluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmNzcyggInpJbmRleCIsIHpJbmRleCApOwoJCX0KCgkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzWyAwIF0gKSwgcG9zaXRpb24sIHZhbHVlOwoJCQl3aGlsZSAoIGVsZW0ubGVuZ3RoICYmIGVsZW1bIDAgXSAhPT0gZG9jdW1lbnQgKSB7CgkJCQkvLyBJZ25vcmUgei1pbmRleCBpZiBwb3NpdGlvbiBpcyBzZXQgdG8gYSB2YWx1ZSB3aGVyZSB6LWluZGV4IGlzIGlnbm9yZWQgYnkgdGhlIGJyb3dzZXIKCQkJCS8vIFRoaXMgbWFrZXMgYmVoYXZpb3Igb2YgdGhpcyBmdW5jdGlvbiBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycwoJCQkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZAoJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gInJlbGF0aXZlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQkvLyBJRSByZXR1cm5zIDAgd2hlbiB6SW5kZXggaXMgbm90IHNwZWNpZmllZAoJCQkJCS8vIG90aGVyIGJyb3dzZXJzIHJldHVybiBhIHN0cmluZwoJCQkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwCgkJCQkJLy8gPGRpdiBzdHlsZT0iei1pbmRleDogLTEwOyI+PGRpdiBzdHlsZT0iei1pbmRleDogMDsiPjwvZGl2PjwvZGl2PgoJCQkJCXZhbHVlID0gcGFyc2VJbnQoIGVsZW0uY3NzKCAiekluZGV4IiApLCAxMCApOwoJCQkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgewoJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJfQoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ucGFyZW50KCk7CgkJCX0KCQl9CgoJCXJldHVybiAwOwoJfQp9KTsKCi8vICQudWkucGx1Z2luIGlzIGRlcHJlY2F0ZWQuIFVzZSAkLndpZGdldCgpIGV4dGVuc2lvbnMgaW5zdGVhZC4KJC51aS5wbHVnaW4gPSB7CglhZGQ6IGZ1bmN0aW9uKCBtb2R1bGUsIG9wdGlvbiwgc2V0ICkgewoJCXZhciBpLAoJCQlwcm90byA9ICQudWlbIG1vZHVsZSBdLnByb3RvdHlwZTsKCQlmb3IgKCBpIGluIHNldCApIHsKCQkJcHJvdG8ucGx1Z2luc1sgaSBdID0gcHJvdG8ucGx1Z2luc1sgaSBdIHx8IFtdOwoJCQlwcm90by5wbHVnaW5zWyBpIF0ucHVzaCggWyBvcHRpb24sIHNldFsgaSBdIF0gKTsKCQl9Cgl9LAoJY2FsbDogZnVuY3Rpb24oIGluc3RhbmNlLCBuYW1lLCBhcmdzLCBhbGxvd0Rpc2Nvbm5lY3RlZCApIHsKCQl2YXIgaSwKCQkJc2V0ID0gaW5zdGFuY2UucGx1Z2luc1sgbmFtZSBdOwoKCQlpZiAoICFzZXQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIWFsbG93RGlzY29ubmVjdGVkICYmICggIWluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlIHx8IGluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQlzZXRbIGkgXVsgMSBdLmFwcGx5KCBpbnN0YW5jZS5lbGVtZW50LCBhcmdzICk7CgkJCX0KCQl9Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKCS8vIFN1YnRyYWN0IHRoZSBoZWlnaHQgb2YgZXh0ZXJuYWwgdG9vbGJhcnMgZnJvbSB0aGUgcGFnZSBoZWlnaHQsIGlmIHRoZSBwYWdlIGRvZXMgbm90IGhhdmUKCS8vIGludGVybmFsIHRvb2xiYXJzIG9mIHRoZSBzYW1lIHR5cGUKCXZhciBjb21wZW5zYXRlVG9vbGJhcnMgPSBmdW5jdGlvbiggcGFnZSwgZGVzaXJlZEhlaWdodCApIHsKCQl2YXIgcGFnZVBhcmVudCA9IHBhZ2UucGFyZW50KCksCgkJCXRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0ID0gW10sCgkJCWV4dGVybmFsSGVhZGVycyA9IHBhZ2VQYXJlbnQuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSwKCQkJaW50ZXJuYWxIZWFkZXJzID0gcGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLAoJCQlleHRlcm5hbEZvb3RlcnMgPSBwYWdlUGFyZW50LmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nZm9vdGVyJykiICksCgkJCWludGVybmFsRm9vdGVycyA9IHBhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKTsKCgkJLy8gSWYgd2UgaGF2ZSBubyBpbnRlcm5hbCBoZWFkZXJzLCBidXQgd2UgZG8gaGF2ZSBleHRlcm5hbCBoZWFkZXJzLCB0aGVuIHRoZWlyIGhlaWdodAoJCS8vIHJlZHVjZXMgdGhlIHBhZ2UgaGVpZ2h0CgkJaWYgKCBpbnRlcm5hbEhlYWRlcnMubGVuZ3RoID09PSAwICYmIGV4dGVybmFsSGVhZGVycy5sZW5ndGggPiAwICkgewoJCQl0b29sYmFyc0FmZmVjdGluZ0hlaWdodCA9IHRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0LmNvbmNhdCggZXh0ZXJuYWxIZWFkZXJzLnRvQXJyYXkoKSApOwoJCX0KCgkJLy8gSWYgd2UgaGF2ZSBubyBpbnRlcm5hbCBmb290ZXJzLCBidXQgd2UgZG8gaGF2ZSBleHRlcm5hbCBmb290ZXJzLCB0aGVuIHRoZWlyIGhlaWdodAoJCS8vIHJlZHVjZXMgdGhlIHBhZ2UgaGVpZ2h0CgkJaWYgKCBpbnRlcm5hbEZvb3RlcnMubGVuZ3RoID09PSAwICYmIGV4dGVybmFsRm9vdGVycy5sZW5ndGggPiAwICkgewoJCQl0b29sYmFyc0FmZmVjdGluZ0hlaWdodCA9IHRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0LmNvbmNhdCggZXh0ZXJuYWxGb290ZXJzLnRvQXJyYXkoKSApOwoJCX0KCgkJJC5lYWNoKCB0b29sYmFyc0FmZmVjdGluZ0hlaWdodCwgZnVuY3Rpb24oIGluZGV4LCB2YWx1ZSApIHsKCQkJZGVzaXJlZEhlaWdodCAtPSAkKCB2YWx1ZSApLm91dGVySGVpZ2h0KCk7CgkJfSk7CgoJCS8vIEhlaWdodCBtdXN0IGJlIGF0IGxlYXN0IHplcm8KCQlyZXR1cm4gTWF0aC5tYXgoIDAsIGRlc2lyZWRIZWlnaHQgKTsKCX07CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETzogUmVtb3ZlIGFuZCB1c2UgJC51aS5rZXlDb2RlIGRpcmVjdGx5CgkJa2V5Q29kZTogJC51aS5rZXlDb2RlLAoKCQkvLyBQbGFjZSB0byBzdG9yZSB2YXJpb3VzIHdpZGdldCBleHRlbnNpb25zCgkJYmVoYXZpb3JzOiB7fSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJZ2V0Q2xvc2VzdEJhc2VVcmw6IGZ1bmN0aW9uKCBlbGUgKQl7CgkJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQkJYmFzZSA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgfHwgIXVybCB8fCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIHVybCApICkgewoJCQkJdXJsID0gYmFzZTsKCQkJfQoKCQkJcmV0dXJuICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UgKTsKCQl9LAoJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzczogZnVuY3Rpb24oIGZvcmNlUmVtb3ZhbCApIHsKCQkJaWYgKCAhISQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkoICEkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwKCQkJCQlmb3JjZVJlbW92YWwgKSApIHsKCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9IG51bGw7CgkJfSwKCgkJLy8gREVQUkVDQVRFRCBpbiAxLjQKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCBlbGVtZW50cyApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoIGVsZW1lbnRzLCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggZWxlbWVudHMgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCBlbGVtZW50cywgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gZWxlbWVudHM7CgkJCX0KCgkJCXZhciBjb3VudCA9IGVsZW1lbnRzLmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQsCgkJCQlpLCBjOwoKCQkJZm9yICggaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSBlbGVtZW50cy5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSBlbGVtZW50c1sgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQljID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0sCgoJCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCQlyZXNldEFjdGl2ZVBhZ2VIZWlnaHQ6IGZ1bmN0aW9uKCBoZWlnaHQgKSB7CgkJCXZhciBwYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCQlwYWdlSGVpZ2h0ID0gcGFnZS5oZWlnaHQoKSwKCQkJCXBhZ2VPdXRlckhlaWdodCA9IHBhZ2Uub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCWhlaWdodCA9IGNvbXBlbnNhdGVUb29sYmFycyggcGFnZSwKCQkJCSggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKSA/IGhlaWdodCA6ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpICk7CgoJCQlwYWdlLmNzcyggIm1pbi1oZWlnaHQiLCBoZWlnaHQgLSAoIHBhZ2VPdXRlckhlaWdodCAtIHBhZ2VIZWlnaHQgKSApOwoJCX0sCgoJCWxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCBjYWxsIHRvIHRoaXMgZnVuY3Rpb24sIGluc3RhbnRpYXRlIGEgbG9hZGVyIHdpZGdldAoJCQl2YXIgbG9hZGVyID0gdGhpcy5sb2FkaW5nLl93aWRnZXQgfHwgJCggJC5tb2JpbGUubG9hZGVyLnByb3RvdHlwZS5kZWZhdWx0SHRtbCApLmxvYWRlcigpLAoKCQkJCS8vIENhbGwgdGhlIGFwcHJvcHJpYXRlIG1ldGhvZCBvbiB0aGUgbG9hZGVyCgkJCQlyZXR1cm5WYWx1ZSA9IGxvYWRlci5sb2FkZXIuYXBwbHkoIGxvYWRlciwgYXJndW1lbnRzICk7CgoJCQkvLyBNYWtlIHN1cmUgdGhlIGxvYWRlciBpcyByZXRhaW5lZCBmb3IgZnV0dXJlIGNhbGxzIHRvIHRoaXMgZnVuY3Rpb24uCgkJCXRoaXMubG9hZGluZy5fd2lkZ2V0ID0gbG9hZGVyOwoKCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCX0KCX0pOwoKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtLCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKSwKCQkJZGVwZW5kZW50cyA9ICRlbGVtLmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKTsKCgkJJGVsZW0uanFtRGF0YSggImRlcGVuZGVudHMiLCAkKCBkZXBlbmRlbnRzICkuYWRkKCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJLy8gcGx1Z2lucwoJJC5mbi5leHRlbmQoewoJCXJlbW92ZVdpdGhEZXBlbmRlbnRzOiBmdW5jdGlvbigpIHsKCQkJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyggdGhpcyApOwoJCX0sCgoJCS8vIEVuaGFuY2UgY2hpbGQgZWxlbWVudHMKCQllbmhhbmNlV2l0aGluOiBmdW5jdGlvbigpIHsKCQkJdmFyIGluZGV4LAoJCQkJd2lkZ2V0RWxlbWVudHMgPSB7fSwKCQkJCWtlZXBOYXRpdmUgPSAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSwKCQkJCXRoYXQgPSB0aGlzOwoKCQkJLy8gQWRkIG5vIGpzIGNsYXNzIHRvIGVsZW1lbnRzCgkJCWlmICggJC5tb2JpbGUubm9qcyApIHsKCQkJCSQubW9iaWxlLm5vanMoIHRoaXMgKTsKCQkJfQoKCQkJLy8gQmluZCBsaW5rcyBmb3IgYWpheCBuYXYKCQkJaWYgKCAkLm1vYmlsZS5saW5rcyApIHsKCQkJCSQubW9iaWxlLmxpbmtzKCB0aGlzICk7CgkJCX0KCgkJCS8vIERlZ3JhZGUgaW5wdXRzIGZvciBzdHlsZWluZwoJCQlpZiAoICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNXaXRoaW4gKSB7CgkJCQkkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluKCB0aGlzICk7CgkJCX0KCgkJCS8vIFJ1biBidXR0b25tYXJrdXAKCQkJaWYgKCAkLmZuLmJ1dHRvbk1hcmt1cCApIHsKCQkJCXRoaXMuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkubm90KCBrZWVwTmF0aXZlICkKCQkJCS5qcW1FbmhhbmNlYWJsZSgpLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgoJCQkvLyBBZGQgY2xhc3NlcyBmb3IgZmllbGRDb250YWluCgkJCWlmICggJC5mbi5maWVsZGNvbnRhaW4gKSB7CgkJCQl0aGlzLmZpbmQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIgKS5ub3QoIGtlZXBOYXRpdmUgKQoJCQkJLmpxbUVuaGFuY2VhYmxlKCkuZmllbGRjb250YWluKCk7CgkJCX0KCgkJCS8vIEVuaGFuY2Ugd2lkZ2V0cwoJCQkkLmVhY2goICQubW9iaWxlLndpZGdldHMsIGZ1bmN0aW9uKCBuYW1lLCBjb25zdHJ1Y3RvciApIHsKCgkJCQkvLyBJZiBpbml0U2VsZWN0b3Igbm90IGZhbHNlIGZpbmQgZWxlbWVudHMKCQkJCWlmICggY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yICkgewoKCQkJCQkvLyBGaWx0ZXIgZWxlbWVudHMgdGhhdCBzaG91bGQgbm90IGJlIGVuaGFuY2VkIGJhc2VkIG9uIHBhcmVudHMKCQkJCQl2YXIgZWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhhdC5maW5kKCBjb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgKSApOwoKCQkJCQkvLyBJZiBhbnkgbWF0Y2hpbmcgZWxlbWVudHMgcmVtYWluIGZpbHRlciBvbmVzIHdpdGgga2VlcE5hdGl2ZVNlbGVjdG9yCgkJCQkJaWYgKCBlbGVtZW50cy5sZW5ndGggPiAwICkgewoKCQkJCQkJLy8gJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yIGlzIGRlcHJlY2F0ZWQgdGhpcyBpcyBqdXN0IGZvciBiYWNrY29tcGF0CgkJCQkJCS8vIFN3aXRjaCB0byAkLm1vYmlsZS5rZWVwTmF0aXZlIGluIDEuNSB3aGljaCBpcyBqdXN0IGEgdmFsdWUgbm90IGEgZnVuY3Rpb24KCQkJCQkJZWxlbWVudHMgPSBlbGVtZW50cy5ub3QoIGtlZXBOYXRpdmUgKTsKCQkJCQl9CgoJCQkJCS8vIEVuaGFuY2Ugd2hhdGV2ZXIgaXMgbGVmdAoJCQkJCWlmICggZWxlbWVudHMubGVuZ3RoID4gMCApIHsKCQkJCQkJd2lkZ2V0RWxlbWVudHNbIGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lIF0gPSBlbGVtZW50czsKCQkJCQl9CgkJCQl9CgkJCX0pOwoKCQkJZm9yICggaW5kZXggaW4gd2lkZ2V0RWxlbWVudHMgKSB7CgkJCQl3aWRnZXRFbGVtZW50c1sgaW5kZXggXVsgaW5kZXggXSgpOwoJCQl9CgoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlhZGREZXBlbmRlbnRzOiBmdW5jdGlvbiggbmV3RGVwZW5kZW50cyApIHsKCQkJJC5hZGREZXBlbmRlbnRzKCB0aGlzLCBuZXdEZXBlbmRlbnRzICk7CgkJfSwKCgkJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkJLy8gb3Igc2V0dGluZyBvZiBhbiBodG1sIGVsZW1lbnQncyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkJLy8gdG8gcmV0dXJuIHRoZSBodG1sIGVuY29kZWQgdmVyc2lvbiBvZiB0aGUgdGV4dCBpbiBhbGwgY2FzZXMuICh0aHVzIHRoZSBuYW1lKQoJCWdldEVuY29kZWRUZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQoICI8YT4iICkudGV4dCggdGhpcy50ZXh0KCkgKS5odG1sKCk7CgkJfSwKCgkJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCQlqcW1FbmhhbmNlYWJsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhpcyApOwoJCX0sCgoJCWpxbUhpamFja2FibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGlqYWNrYWJsZSggdGhpcyApOwoJCX0KCX0pOwoKCSQucmVtb3ZlV2l0aERlcGVuZGVudHMgPSBmdW5jdGlvbiggbmF0aXZlRWxlbWVudCApIHsKCQl2YXIgZWxlbWVudCA9ICQoIG5hdGl2ZUVsZW1lbnQgKTsKCgkJKCBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKSApLnJlbW92ZSgpOwoJCWVsZW1lbnQucmVtb3ZlKCk7Cgl9OwoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQsIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICksCgkJCWRlcGVuZGVudHMgPSBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKTsKCgkJZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIsICQoIGRlcGVuZGVudHMgKS5hZGQoIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkkLmZpbmQubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cgl9OwoKCSQuZmluZC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBbIG5vZGUgXSApLmxlbmd0aCA+IDA7Cgl9OwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IGMwYWI3MTA1NmI5MzY2MjdlOGE3ODIxZjAzYzA0NGFlYzYyODBhNDAKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9qUXVlcnkud2lkZ2V0LwogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdXVpZCA9IDAsCglzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKCV9jbGVhbkRhdGEgPSAkLmNsZWFuRGF0YTsKJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7Cglmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQl0cnkgewoJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODIzNQoJCX0gY2F0Y2goIGUgKSB7fQoJfQoJX2NsZWFuRGF0YSggZWxlbXMgKTsKfTsKCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBmdWxsTmFtZSwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgY29uc3RydWN0b3IsIGJhc2VQcm90b3R5cGUsCgkJLy8gcHJveGllZFByb3RvdHlwZSBhbGxvd3MgdGhlIHByb3ZpZGVkIHByb3RvdHlwZSB0byByZW1haW4gdW5tb2RpZmllZAoJCS8vIHNvIHRoYXQgaXQgY2FuIGJlIHVzZWQgYXMgYSBtaXhpbiBmb3IgbXVsdGlwbGUgd2lkZ2V0cyAoIzg4NzYpCgkJcHJveGllZFByb3RvdHlwZSA9IHt9LAoJCW5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF07CgoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZS50b0xvd2VyQ2FzZSgpIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCAibmV3IiBrZXl3b3JkCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgewoJCQlyZXR1cm4gbmV3IGNvbnN0cnVjdG9yKCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQkvLyBtdXN0IHVzZSAibmV3IiBrZXl3b3JkICh0aGUgY29kZSBhYm92ZSBhbHdheXMgcGFzc2VzIGFyZ3MpCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoJLy8gZXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzCgkkLmV4dGVuZCggY29uc3RydWN0b3IsIGV4aXN0aW5nQ29uc3RydWN0b3IsIHsKCQl2ZXJzaW9uOiBwcm90b3R5cGUudmVyc2lvbiwKCQkvLyBjb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoJCS8vIHRyYWNrIHdpZGdldHMgdGhhdCBpbmhlcml0IGZyb20gdGhpcyB3aWRnZXQgaW4gY2FzZSB0aGlzIHdpZGdldCBpcwoJCS8vIHJlZGVmaW5lZCBhZnRlciBhIHdpZGdldCBpbmhlcml0cyBmcm9tIGl0CgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQoJfSk7CgoJYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggISQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gdmFsdWU7CgkJCXJldHVybjsKCQl9CgkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gKGZ1bmN0aW9uKCkgewoJCQl2YXIgX3N1cGVyID0gZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJfSwKCQkJCV9zdXBlckFwcGx5ID0gZnVuY3Rpb24oIGFyZ3MgKSB7CgkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCQkJCX07CgkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXIsCgkJCQkJX19zdXBlckFwcGx5ID0gdGhpcy5fc3VwZXJBcHBseSwKCQkJCQlyZXR1cm5WYWx1ZTsKCgkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfc3VwZXJBcHBseTsKCgkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX19zdXBlckFwcGx5OwoKCQkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQkJfTsKCQl9KSgpOwoJfSk7Cgljb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAkLndpZGdldC5leHRlbmQoIGJhc2VQcm90b3R5cGUsIHsKCQkvLyBUT0RPOiByZW1vdmUgc3VwcG9ydCBmb3Igd2lkZ2V0RXZlbnRQcmVmaXgKCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQKCQkvLyBkb24ndCBwcmVmaXggZm9yIHdpZGdldHMgdGhhdCBhcmVuJ3QgRE9NLWJhc2VkCgkJd2lkZ2V0RXZlbnRQcmVmaXg6IGV4aXN0aW5nQ29uc3RydWN0b3IgPyAoYmFzZVByb3RvdHlwZS53aWRnZXRFdmVudFByZWZpeCB8fCBuYW1lKSA6IG5hbWUKCX0sIHByb3hpZWRQcm90b3R5cGUsIHsKCQljb25zdHJ1Y3RvcjogY29uc3RydWN0b3IsCgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7CgoJcmV0dXJuIGNvbnN0cnVjdG9yOwp9OwoKJC53aWRnZXQuZXh0ZW5kID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCXZhciBpbnB1dCA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCWlucHV0SW5kZXggPSAwLAoJCWlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAoJCWtleSwKCQl2YWx1ZTsKCWZvciAoIDsgaW5wdXRJbmRleCA8IGlucHV0TGVuZ3RoOyBpbnB1dEluZGV4KysgKSB7CgkJZm9yICgga2V5IGluIGlucHV0WyBpbnB1dEluZGV4IF0gKSB7CgkJCXZhbHVlID0gaW5wdXRbIGlucHV0SW5kZXggXVsga2V5IF07CgkJCWlmICggaW5wdXRbIGlucHV0SW5kZXggXS5oYXNPd25Qcm9wZXJ0eSgga2V5ICkgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCS8vIENsb25lIG9iamVjdHMKCQkJCWlmICggJC5pc1BsYWluT2JqZWN0KCB2YWx1ZSApICkgewoJCQkJCXRhcmdldFsga2V5IF0gPSAkLmlzUGxhaW5PYmplY3QoIHRhcmdldFsga2V5IF0gKSA/CgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHRhcmdldFsga2V5IF0sIHZhbHVlICkgOgoJCQkJCQkvLyBEb24ndCBleHRlbmQgc3RyaW5ncywgYXJyYXlzLCBldGMuIHdpdGggb2JqZWN0cwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB2YWx1ZSApOwoJCQkJLy8gQ29weSBldmVyeXRoaW5nIGVsc2UgYnkgcmVmZXJlbmNlCgkJCQl9IGVsc2UgewoJCQkJCXRhcmdldFsga2V5IF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCX0KCXJldHVybiB0YXJnZXQ7Cn07CgokLndpZGdldC5icmlkZ2UgPSBmdW5jdGlvbiggbmFtZSwgb2JqZWN0ICkgewoJdmFyIGZ1bGxOYW1lID0gb2JqZWN0LnByb3RvdHlwZS53aWRnZXRGdWxsTmFtZSB8fCBuYW1lOwoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlzTWV0aG9kQ2FsbCA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiwKCQkJYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC53aWRnZXQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIG9wdGlvbnMgXS5jb25jYXQoYXJncykgKSA6CgkJCW9wdGlvbnM7CgoJCWlmICggaXNNZXRob2RDYWxsICkgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgbWV0aG9kVmFsdWUsCgkJCQkJaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoIG9wdGlvbnMgPT09ICJpbnN0YW5jZSIgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBpbnN0YW5jZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKyAiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyAiICsKCQkJCQkJImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyIgKTsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSB8fCBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJubyBzdWNoIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyBmb3IgIiArIG5hbWUgKyAiIHdpZGdldCBpbnN0YW5jZSIgKTsKCQkJCX0KCQkJCW1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZSAmJiBtZXRob2RWYWx1ZS5qcXVlcnkgPwoJCQkJCQlyZXR1cm5WYWx1ZS5wdXNoU3RhY2soIG1ldGhvZFZhbHVlLmdldCgpICkgOgoJCQkJCQltZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICkuX2luaXQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSwgbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfTsKfTsKCiQuV2lkZ2V0ID0gZnVuY3Rpb24oIC8qIG9wdGlvbnMsIGVsZW1lbnQgKi8gKSB7fTsKJC5XaWRnZXQuX2NoaWxkQ29uc3RydWN0b3JzID0gW107CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCWRlZmF1bHRFbGVtZW50OiAiPGRpdj4iLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBmYWxzZSwKCgkJLy8gY2FsbGJhY2tzCgkJY3JlYXRlOiBudWxsCgl9LAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJZWxlbWVudCA9ICQoIGVsZW1lbnQgfHwgdGhpcy5kZWZhdWx0RWxlbWVudCB8fCB0aGlzIClbIDAgXTsKCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJdGhpcy51dWlkID0gdXVpZCsrOwoJCXRoaXMuZXZlbnROYW1lc3BhY2UgPSAiLiIgKyB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQ7CgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdGhpcy5iaW5kaW5ncyA9ICQoKTsKCQl0aGlzLmhvdmVyYWJsZSA9ICQoKTsKCQl0aGlzLmZvY3VzYWJsZSA9ICQoKTsKCgkJaWYgKCBlbGVtZW50ICE9PSB0aGlzICkgewoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsKCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZWxlbWVudCwgewoJCQkJcmVtb3ZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50YXJnZXQgPT09IGVsZW1lbnQgKSB7CgkJCQkJCXRoaXMuZGVzdHJveSgpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJCXRoaXMuZG9jdW1lbnQgPSAkKCBlbGVtZW50LnN0eWxlID8KCQkJCS8vIGVsZW1lbnQgd2l0aGluIHRoZSBkb2N1bWVudAoJCQkJZWxlbWVudC5vd25lckRvY3VtZW50IDoKCQkJCS8vIGVsZW1lbnQgaXMgd2luZG93IG9yIGRvY3VtZW50CgkJCQllbGVtZW50LmRvY3VtZW50IHx8IGVsZW1lbnQgKTsKCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmRlZmF1bHRWaWV3IHx8IHRoaXMuZG9jdW1lbnRbMF0ucGFyZW50V2luZG93ICk7CgkJfQoKCQl0aGlzLl9jcmVhdGUoKTsKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiwgbnVsbCwgdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoJX2dldENyZWF0ZU9wdGlvbnM6ICQubm9vcCwKCV9nZXRDcmVhdGVFdmVudERhdGE6ICQubm9vcCwKCV9jcmVhdGU6ICQubm9vcCwKCV9pbml0OiAkLm5vb3AsCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZGVzdHJveSgpOwoJCS8vIHdlIGNhbiBwcm9iYWJseSByZW1vdmUgdGhlIHVuYmluZCBjYWxscyBpbiAyLjAKCQkvLyBhbGwgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGdvIHRocm91Z2ggdGhpcy5fb24oKQoJCXRoaXMuZWxlbWVudAoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCIsICEhdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb25zKHsgZGlzYWJsZWQ6IGZhbHNlIH0pOwoJfSwKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb25zKHsgZGlzYWJsZWQ6IHRydWUgfSk7Cgl9LAoKCV9vbjogZnVuY3Rpb24oIHN1cHByZXNzRGlzYWJsZWRDaGVjaywgZWxlbWVudCwgaGFuZGxlcnMgKSB7CgkJdmFyIGRlbGVnYXRlRWxlbWVudCwKCQkJaW5zdGFuY2UgPSB0aGlzOwoKCQkvLyBubyBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgZmxhZywgc2h1ZmZsZSBhcmd1bWVudHMKCQlpZiAoIHR5cGVvZiBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgIT09ICJib29sZWFuIiApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gc3VwcHJlc3NEaXNhYmxlZENoZWNrOwoJCQlzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgPSBmYWxzZTsKCQl9CgoJCS8vIG5vIGVsZW1lbnQgYXJndW1lbnQsIHNodWZmbGUgYW5kIHVzZSB0aGlzLmVsZW1lbnQKCQlpZiAoICFoYW5kbGVycyApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50OwoJCQlkZWxlZ2F0ZUVsZW1lbnQgPSB0aGlzLndpZGdldCgpOwoJCX0gZWxzZSB7CgkJCS8vIGFjY2VwdCBzZWxlY3RvcnMsIERPTSBlbGVtZW50cwoJCQllbGVtZW50ID0gZGVsZWdhdGVFbGVtZW50ID0gJCggZWxlbWVudCApOwoJCQl0aGlzLmJpbmRpbmdzID0gdGhpcy5iaW5kaW5ncy5hZGQoIGVsZW1lbnQgKTsKCQl9CgoJCSQuZWFjaCggaGFuZGxlcnMsIGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlciApIHsKCQkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQkJLy8gYWxsb3cgd2lkZ2V0cyB0byBjdXN0b21pemUgdGhlIGRpc2FibGVkIGhhbmRsaW5nCgkJCQkvLyAtIGRpc2FibGVkIGFzIGFuIGFycmF5IGluc3RlYWQgb2YgYm9vbGVhbgoJCQkJLy8gLSBkaXNhYmxlZCBjbGFzcyBhcyBtZXRob2QgZm9yIGRpc2FibGluZyBpbmRpdmlkdWFsIHBhcnRzCgkJCQlpZiAoICFzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgJiYKCQkJCQkJKCBpbnN0YW5jZS5vcHRpb25zLmRpc2FibGVkID09PSB0cnVlIHx8CgkJCQkJCQkkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQkJfQoKCQkJLy8gY29weSB0aGUgZ3VpZCBzbyBkaXJlY3QgdW5iaW5kaW5nIHdvcmtzCgkJCWlmICggdHlwZW9mIGhhbmRsZXIgIT09ICJzdHJpbmciICkgewoJCQkJaGFuZGxlclByb3h5Lmd1aWQgPSBoYW5kbGVyLmd1aWQgPQoJCQkJCWhhbmRsZXIuZ3VpZCB8fCBoYW5kbGVyUHJveHkuZ3VpZCB8fCAkLmd1aWQrKzsKCQkJfQoKCQkJdmFyIG1hdGNoID0gZXZlbnQubWF0Y2goIC9eKFx3KylccyooLiopJC8gKSwKCQkJCWV2ZW50TmFtZSA9IG1hdGNoWzFdICsgaW5zdGFuY2UuZXZlbnROYW1lc3BhY2UsCgkJCQlzZWxlY3RvciA9IG1hdGNoWzJdOwoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJZGVsZWdhdGVFbGVtZW50LmRlbGVnYXRlKCBzZWxlY3RvciwgZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfSBlbHNlIHsKCQkJCWVsZW1lbnQuYmluZCggZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfQoJCX0pOwoJfSwKCglfb2ZmOiBmdW5jdGlvbiggZWxlbWVudCwgZXZlbnROYW1lICkgewoJCWV2ZW50TmFtZSA9IChldmVudE5hbWUgfHwgIiIpLnNwbGl0KCAiICIgKS5qb2luKCB0aGlzLmV2ZW50TmFtZXNwYWNlICsgIiAiICkgKyB0aGlzLmV2ZW50TmFtZXNwYWNlOwoJCWVsZW1lbnQudW5iaW5kKCBldmVudE5hbWUgKS51bmRlbGVnYXRlKCBldmVudE5hbWUgKTsKCX0sCgoJX2RlbGF5OiBmdW5jdGlvbiggaGFuZGxlciwgZGVsYXkgKSB7CgkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQl9CgkJdmFyIGluc3RhbmNlID0gdGhpczsKCQlyZXR1cm4gc2V0VGltZW91dCggaGFuZGxlclByb3h5LCBkZWxheSB8fCAwICk7Cgl9LAoKCV9ob3ZlcmFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuaG92ZXJhYmxlID0gdGhpcy5ob3ZlcmFibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJbW91c2VlbnRlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0sCgkJCW1vdXNlbGVhdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV9mb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuZm9jdXNhYmxlID0gdGhpcy5mb2N1c2FibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJZm9jdXNpbjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0sCgkJCWZvY3Vzb3V0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfQoJCX0pOwoJfSwKCglfdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGV2ZW50LCBkYXRhICkgewoJCXZhciBwcm9wLCBvcmlnLAoJCQljYWxsYmFjayA9IHRoaXMub3B0aW9uc1sgdHlwZSBdOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCQlldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CgkJZXZlbnQudHlwZSA9ICggdHlwZSA9PT0gdGhpcy53aWRnZXRFdmVudFByZWZpeCA/CgkJCXR5cGUgOgoJCQl0aGlzLndpZGdldEV2ZW50UHJlZml4ICsgdHlwZSApLnRvTG93ZXJDYXNlKCk7CgkJLy8gdGhlIG9yaWdpbmFsIGV2ZW50IG1heSBjb21lIGZyb20gYW55IGVsZW1lbnQKCQkvLyBzbyB3ZSBuZWVkIHRvIHJlc2V0IHRoZSB0YXJnZXQgb24gdGhlIG5ldyBldmVudAoJCWV2ZW50LnRhcmdldCA9IHRoaXMuZWxlbWVudFsgMCBdOwoKCQkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkJb3JpZyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7CgkJaWYgKCBvcmlnICkgewoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQlpZiAoICEoIHByb3AgaW4gZXZlbnQgKSApIHsKCQkJCQlldmVudFsgcHJvcCBdID0gb3JpZ1sgcHJvcCBdOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggZXZlbnQsIGRhdGEgKTsKCQlyZXR1cm4gISggJC5pc0Z1bmN0aW9uKCBjYWxsYmFjayApICYmCgkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLmVsZW1lbnRbMF0sIFsgZXZlbnQgXS5jb25jYXQoIGRhdGEgKSApID09PSBmYWxzZSB8fAoJCQlldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApOwoJfQp9OwoKJC5lYWNoKCB7IHNob3c6ICJmYWRlSW4iLCBoaWRlOiAiZmFkZU91dCIgfSwgZnVuY3Rpb24oIG1ldGhvZCwgZGVmYXVsdEVmZmVjdCApIHsKCSQuV2lkZ2V0LnByb3RvdHlwZVsgIl8iICsgbWV0aG9kIF0gPSBmdW5jdGlvbiggZWxlbWVudCwgb3B0aW9ucywgY2FsbGJhY2sgKSB7CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgKSB7CgkJCW9wdGlvbnMgPSB7IGVmZmVjdDogb3B0aW9ucyB9OwoJCX0KCQl2YXIgaGFzT3B0aW9ucywKCQkJZWZmZWN0TmFtZSA9ICFvcHRpb25zID8KCQkJCW1ldGhvZCA6CgkJCQlvcHRpb25zID09PSB0cnVlIHx8IHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiA/CgkJCQkJZGVmYXVsdEVmZmVjdCA6CgkJCQkJb3B0aW9ucy5lZmZlY3QgfHwgZGVmYXVsdEVmZmVjdDsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiApIHsKCQkJb3B0aW9ucyA9IHsgZHVyYXRpb246IG9wdGlvbnMgfTsKCQl9CgkJaGFzT3B0aW9ucyA9ICEkLmlzRW1wdHlPYmplY3QoIG9wdGlvbnMgKTsKCQlvcHRpb25zLmNvbXBsZXRlID0gY2FsbGJhY2s7CgkJaWYgKCBvcHRpb25zLmRlbGF5ICkgewoJCQllbGVtZW50LmRlbGF5KCBvcHRpb25zLmRlbGF5ICk7CgkJfQoJCWlmICggaGFzT3B0aW9ucyAmJiAkLmVmZmVjdHMgJiYgJC5lZmZlY3RzLmVmZmVjdFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBtZXRob2QgXSggb3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIGVmZmVjdE5hbWUgIT09IG1ldGhvZCAmJiBlbGVtZW50WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIGVmZmVjdE5hbWUgXSggb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudC5xdWV1ZShmdW5jdGlvbiggbmV4dCApIHsKCQkJCSQoIHRoaXMgKVsgbWV0aG9kIF0oKTsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7CgkJCQl9CgkJCQluZXh0KCk7CgkJCX0pOwoJCX0KCX07Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcmNhcGl0YWxzID0gL1tBLVpdL2csCglyZXBsYWNlRnVuY3Rpb24gPSBmdW5jdGlvbiggYyApIHsKCQlyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwoJfTsKCiQuZXh0ZW5kKCAkLldpZGdldC5wcm90b3R5cGUsIHsKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9uLCB2YWx1ZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudFsgMCBdLAoJCQlvcHRpb25zID0ge307CgoJCS8vCgkJaWYgKCAhJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBlbGVtLCAiZGVmYXVsdHMiICkgKSB7CgkJCWZvciAoIG9wdGlvbiBpbiB0aGlzLm9wdGlvbnMgKSB7CgkJCQl2YWx1ZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggZWxlbSwgb3B0aW9uLnJlcGxhY2UoIHJjYXBpdGFscywgcmVwbGFjZUZ1bmN0aW9uICkgKTsKCgkJCQlpZiAoIHZhbHVlICE9IG51bGwgKSB7CgkJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIG9wdGlvbnM7Cgl9Cn0pOwoKLy9UT0RPOiBSZW1vdmUgaW4gMS41IGZvciBiYWNrY29tcGF0IG9ubHkKJC5tb2JpbGUud2lkZ2V0ID0gJC5XaWRnZXQ7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoJLy8gVE9ETyBtb3ZlIGxvYWRlciBjbGFzcyBkb3duIGludG8gdGhlIHdpZGdldCBzZXR0aW5ncwoJdmFyIGxvYWRlckNsYXNzID0gInVpLWxvYWRlciIsICRodG1sID0gJCggImh0bWwiICk7CgoJJC53aWRnZXQoICJtb2JpbGUubG9hZGVyIiwgewoJCS8vIE5PVEUgaWYgdGhlIGdsb2JhbCBjb25maWcgc2V0dGluZ3MgYXJlIGRlZmluZWQgdGhleSB3aWxsIG92ZXJyaWRlIHRoZXNlCgkJLy8gICAgICBvcHRpb25zCgkJb3B0aW9uczogewoJCQkvLyB0aGUgdGhlbWUgZm9yIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhlbWU6ICJhIiwKCgkJCS8vIHdoZXRoZXIgdGhlIHRleHQgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZSBpcyBzaG93bgoJCQl0ZXh0VmlzaWJsZTogZmFsc2UsCgoJCQkvLyBjdXN0b20gaHRtbCBmb3IgdGhlIGlubmVyIGNvbnRlbnQgb2YgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQlodG1sOiAiIiwKCgkJCS8vIHRoZSB0ZXh0IHRvIGJlIGRpc3BsYXllZCB3aGVuIHRoZSBwb3B1cCBpcyBzaG93bgoJCQl0ZXh0OiAibG9hZGluZyIKCQl9LAoKCQlkZWZhdWx0SHRtbDogIjxkaXYgY2xhc3M9JyIgKyBsb2FkZXJDbGFzcyArICInPiIgKwoJCQkiPHNwYW4gY2xhc3M9J3VpLWljb24tbG9hZGluZyc+PC9zcGFuPiIgKwoJCQkiPGgxPjwvaDE+IiArCgkJCSI8L2Rpdj4iLAoKCQkvLyBGb3Igbm9uLWZpeGVkIHN1cHBvcnRpbiBicm93c2Vycy4gUG9zaXRpb24gYXQgeSBjZW50ZXIgKGlmIHNjcm9sbFRvcCBzdXBwb3J0ZWQpLCBhYm92ZSB0aGUgYWN0aXZlQnRuIChpZiBkZWZpbmVkKSwgb3IganVzdCAxMDBweCBmcm9tIHRvcAoJCWZha2VGaXhMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkJdGhpcy5lbGVtZW50CgkJCQkuY3NzKHsKCQkJCQl0b3A6ICQuc3VwcG9ydC5zY3JvbGxUb3AgJiYgdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCkgKyB0aGlzLndpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQkJfSk7CgkJfSwKCgkJLy8gY2hlY2sgcG9zaXRpb24gb2YgbG9hZGVyIHRvIHNlZSBpZiBpdCBhcHBlYXJzIHRvIGJlICJmaXhlZCIgdG8gY2VudGVyCgkJLy8gaWYgbm90LCB1c2UgYWJzIHBvc2l0aW9uaW5nCgkJY2hlY2tMb2FkZXJQb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCksCgkJCQlzY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJaWYgKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8ICggb2Zmc2V0LnRvcCAtIHNjcm9sbFRvcCApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCQl0aGlzLmZha2VGaXhMb2FkZXIoKTsKCQkJCXRoaXMud2luZG93CgkJCQkJLnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApCgkJCQkJLmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmZha2VGaXhMb2FkZXIsIHRoaXMgKSApOwoJCQl9CgkJfSwKCgkJcmVzZXRIdG1sOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmh0bWwoICQoIHRoaXMuZGVmYXVsdEh0bWwgKS5odG1sKCkgKTsKCQl9LAoKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJLy8gVE9ETyBzd2VldCBqZXN1cyB3ZSBuZWVkIHRvIGJyZWFrIHNvbWUgb2YgdGhpcyBvdXQKCQlzaG93OiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQl2YXIgdGV4dFZpc2libGUsIG1lc3NhZ2UsIGxvYWRTZXR0aW5nczsKCgkJCXRoaXMucmVzZXRIdG1sKCk7CgoJCQkvLyB1c2UgdGhlIHByb3RvdHlwZSBvcHRpb25zIHNvIHRoYXQgcGVvcGxlIGNhbiBzZXQgdGhlbSBnbG9iYWxseSBhdAoJCQkvLyBtb2JpbGUgaW5pdC4gQ29uc2lzdGVuY3ksIGl0J3Mgd2hhdCdzIGZvciBkaW5uZXIKCQkJaWYgKCAkLnR5cGUoIHRoZW1lICkgPT09ICJvYmplY3QiICkgewoJCQkJbG9hZFNldHRpbmdzID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIHRoZW1lICk7CgoJCQkJdGhlbWUgPSBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0gZWxzZSB7CgkJCQlsb2FkU2V0dGluZ3MgPSB0aGlzLm9wdGlvbnM7CgoJCQkJLy8gaGVyZSB3ZSBwcmVmZXIgdGhlIHRoZW1lIHZhbHVlIHBhc3NlZCBhcyBhIHN0cmluZyBhcmd1bWVudCwgdGhlbgoJCQkJLy8gd2UgcHJlZmVyIHRoZSBnbG9iYWwgb3B0aW9uIGJlY2F1c2Ugd2UgY2FuJ3QgdXNlIHVuZGVmaW5lZCBkZWZhdWx0CgkJCQkvLyBwcm90b3R5cGUgb3B0aW9ucywgdGhlbiB0aGUgcHJvdG90eXBlIG9wdGlvbgoJCQkJdGhlbWUgPSB0aGVtZSB8fCBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0KCgkJCS8vIHNldCB0aGUgbWVzc2FnZSB0ZXh0LCBwcmVmZXIgdGhlIHBhcmFtLCB0aGVuIHRoZSBzZXR0aW5ncyBvYmplY3QKCQkJLy8gdGhlbiBsb2FkaW5nIG1lc3NhZ2UKCQkJbWVzc2FnZSA9IG1zZ1RleHQgfHwgKCBsb2FkU2V0dGluZ3MudGV4dCA9PT0gZmFsc2UgPyAiIiA6IGxvYWRTZXR0aW5ncy50ZXh0ICk7CgoJCQkvLyBwcmVwYXJlIHRoZSBkb20KCQkJJGh0bWwuYWRkQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJdGV4dFZpc2libGUgPSBsb2FkU2V0dGluZ3MudGV4dFZpc2libGU7CgoJCQkvLyBhZGQgdGhlIHByb3BlciBjc3MgZ2l2ZW4gdGhlIG9wdGlvbnMgKHRoZW1lLCB0ZXh0LCBldGMpCgkJCS8vIEZvcmNlIHRleHQgdmlzaWJpbGl0eSBpZiB0aGUgc2Vjb25kIGFyZ3VtZW50IHdhcyBzdXBwbGllZCwgb3IKCQkJLy8gaWYgdGhlIHRleHQgd2FzIGV4cGxpY2l0bHkgc2V0IGluIHRoZSBvYmplY3QgYXJncwoJCQl0aGlzLmVsZW1lbnQuYXR0cigiY2xhc3MiLCBsb2FkZXJDbGFzcyArCgkJCQkiIHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgdGhlbWUgKwoJCQkJIiB1aS1sb2FkZXItIiArICggdGV4dFZpc2libGUgfHwgbXNnVGV4dCB8fCB0aGVtZS50ZXh0ID8gInZlcmJvc2UiIDogImRlZmF1bHQiICkgKwoJCQkJKCBsb2FkU2V0dGluZ3MudGV4dG9ubHkgfHwgdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICk7CgoJCQkvLyBUT0RPIHZlcmlmeSB0aGF0IGpxdWVyeS5mbi5odG1sIGlzIG9rIHRvIHVzZSBpbiBib3RoIGNhc2VzIGhlcmUKCQkJLy8gICAgICB0aGlzIG1pZ2h0IGJlIG92ZXJseSBkZWZlbnNpdmUgaW4gcHJldmVudGluZyB1bmtub3dpbmcgeHNzCgkJCS8vIGlmIHRoZSBodG1sIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIHRoZSBsb2FkaW5nIHNldHRpbmdzLCB1c2UgdGhhdAoJCQkvLyBvdGhlcndpc2UgdXNlIHRoZSBmYWxsYmFja3MgZnJvbSBhYm92ZQoJCQlpZiAoIGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIGxvYWRTZXR0aW5ncy5odG1sICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggImgxIiApLnRleHQoIG1lc3NhZ2UgKTsKCQkJfQoKCQkJLy8gYXR0YWNoIHRoZSBsb2FkZXIgdG8gdGhlIERPTQoJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCS8vIGNoZWNrIHRoYXQgdGhlIGxvYWRlciBpcyB2aXNpYmxlCgkJCXRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbigpOwoKCQkJLy8gb24gc2Nyb2xsIGNoZWNrIHRoZSBsb2FkZXIgcG9zaXRpb24KCQkJdGhpcy53aW5kb3cuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiwgdGhpcyApICk7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oKSB7CgkJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLnRleHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJfQoKCQkJJC5tb2JpbGUud2luZG93LnVuYmluZCggInNjcm9sbCIsIHRoaXMuZmFrZUZpeExvYWRlciApOwoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICk7CgkJfQoJfSk7Cgp9KShqUXVlcnksIHRoaXMpOwoKCi8qIQogKiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCAtIHYxLjMgLSA3LzIxLzIwMTAKICogaHR0cDovL2JlbmFsbWFuLmNvbS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS1wbHVnaW4vCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgogKiBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCiAqLwoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLwovLyAqVmVyc2lvbjogMS4zLCBMYXN0IHVwZGF0ZWQ6IDcvMjEvMjAxMCoKLy8gCi8vIFByb2plY3QgSG9tZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UtcGx1Z2luLwovLyBHaXRIdWIgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvCi8vIFNvdXJjZSAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLmpzCi8vIChNaW5pZmllZCkgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLm1pbi5qcyAoMC44a2IgZ3ppcHBlZCkKLy8gCi8vIEFib3V0OiBMaWNlbnNlCi8vIAovLyBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuLAovLyBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlcy4KLy8gaHR0cDovL2JlbmFsbWFuLmNvbS9hYm91dC9saWNlbnNlLwovLyAKLy8gQWJvdXQ6IEV4YW1wbGVzCi8vIAovLyBUaGVzZSB3b3JraW5nIGV4YW1wbGVzLCBjb21wbGV0ZSB3aXRoIGZ1bGx5IGNvbW1lbnRlZCBjb2RlLCBpbGx1c3RyYXRlIGEgZmV3Ci8vIHdheXMgaW4gd2hpY2ggdGhpcyBwbHVnaW4gY2FuIGJlIHVzZWQuCi8vIAovLyBoYXNoY2hhbmdlIGV2ZW50IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2hhc2hjaGFuZ2UvCi8vIGRvY3VtZW50LmRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9kb2N1bWVudF9kb21haW4vCi8vIAovLyBBYm91dDogU3VwcG9ydCBhbmQgVGVzdGluZwovLyAKLy8gSW5mb3JtYXRpb24gYWJvdXQgd2hhdCB2ZXJzaW9uIG9yIHZlcnNpb25zIG9mIGpRdWVyeSB0aGlzIHBsdWdpbiBoYXMgYmVlbgovLyB0ZXN0ZWQgd2l0aCwgd2hhdCBicm93c2VycyBpdCBoYXMgYmVlbiB0ZXN0ZWQgaW4sIGFuZCB3aGVyZSB0aGUgdW5pdCB0ZXN0cwovLyByZXNpZGUgKHNvIHlvdSBjYW4gdGVzdCBpdCB5b3Vyc2VsZikuCi8vIAovLyBqUXVlcnkgVmVyc2lvbnMgLSAxLjIuNiwgMS4zLjIsIDEuNC4xLCAxLjQuMgovLyBCcm93c2VycyBUZXN0ZWQgLSBJbnRlcm5ldCBFeHBsb3JlciA2LTgsIEZpcmVmb3ggMi00LCBDaHJvbWUgNS02LCBTYWZhcmkgMy4yLTUsCi8vICAgICAgICAgICAgICAgICAgIE9wZXJhIDkuNi0xMC42MCwgaVBob25lIDMuMSwgQW5kcm9pZCAxLjYtMi4yLCBCbGFja0JlcnJ5IDQuNi01LgovLyBVbml0IFRlc3RzICAgICAgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvdW5pdC8KLy8gCi8vIEFib3V0OiBLbm93biBpc3N1ZXMKLy8gCi8vIFdoaWxlIHRoaXMgalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQgaW1wbGVtZW50YXRpb24gaXMgcXVpdGUgc3RhYmxlIGFuZAovLyByb2J1c3QsIHRoZXJlIGFyZSBhIGZldyB1bmZvcnR1bmF0ZSBicm93c2VyIGJ1Z3Mgc3Vycm91bmRpbmcgZXhwZWN0ZWQKLy8gaGFzaGNoYW5nZSBldmVudC1iYXNlZCBiZWhhdmlvcnMsIGluZGVwZW5kZW50IG9mIGFueSBKYXZhU2NyaXB0Ci8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgYWJzdHJhY3Rpb24uIFNlZSB0aGUgZm9sbG93aW5nIGV4YW1wbGVzIGZvciBtb3JlCi8vIGluZm9ybWF0aW9uOgovLyAKLy8gQ2hyb21lOiBCYWNrIEJ1dHRvbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctY2hyb21lLWJhY2stYnV0dG9uLwovLyBGaXJlZm94OiBSZW1vdGUgWE1MSHR0cFJlcXVlc3QgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWZpcmVmb3gtcmVtb3RlLXhoci8KLy8gV2ViS2l0OiBCYWNrIEJ1dHRvbiBpbiBhbiBJZnJhbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXdlYmtpdC1oYXNoLWlmcmFtZS8KLy8gU2FmYXJpOiBCYWNrIEJ1dHRvbiBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctc2FmYXJpLWJhY2stZnJvbS1kaWZmLWRvbWFpbi8KLy8gCi8vIEFsc28gbm90ZSB0aGF0IHNob3VsZCBhIGJyb3dzZXIgbmF0aXZlbHkgc3VwcG9ydCB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSAKLy8gZXZlbnQsIGJ1dCBub3QgcmVwb3J0IHRoYXQgaXQgZG9lcywgdGhlIGZhbGxiYWNrIHBvbGxpbmcgbG9vcCB3aWxsIGJlIHVzZWQuCi8vIAovLyBBYm91dDogUmVsZWFzZSBIaXN0b3J5Ci8vIAovLyAxLjMgICAtICg3LzIxLzIwMTApIFJlb3JnYW5pemVkIElFNi83IElmcmFtZSBjb2RlIHRvIG1ha2UgaXQgbW9yZQovLyAgICAgICAgICJyZW1vdmFibGUiIGZvciBtb2JpbGUtb25seSBkZXZlbG9wbWVudC4gQWRkZWQgSUU2LzcgZG9jdW1lbnQudGl0bGUKLy8gICAgICAgICBzdXBwb3J0LiBBdHRlbXB0ZWQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlIGJ5IHVzaW5nCi8vICAgICAgICAgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuIEFkZGVkIAovLyAgICAgICAgIHN1cHBvcnQgZm9yIHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKHdpbmRvdykuaGFzaGNoYW5nZSggZm4gKSBhbmQKLy8gICAgICAgICAkKHdpbmRvdykuaGFzaGNoYW5nZSgpIGxpa2UgalF1ZXJ5IHByb3ZpZGVzIGZvciBidWlsdC1pbiBldmVudHMuCi8vICAgICAgICAgUmVuYW1lZCBqUXVlcnkuaGFzaGNoYW5nZURlbGF5IHRvIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gYW5kCi8vICAgICAgICAgbG93ZXJlZCBpdHMgZGVmYXVsdCB2YWx1ZSB0byA1MC4gQWRkZWQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4KLy8gICAgICAgICBhbmQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydGllcyBwbHVzIGRvY3VtZW50LWRvbWFpbi5odG1sCi8vICAgICAgICAgZmlsZSB0byBhZGRyZXNzIGFjY2VzcyBkZW5pZWQgaXNzdWVzIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4KLy8gICAgICAgICBJRTYvNy4KLy8gMS4yICAgLSAoMi8xMS8yMDEwKSBGaXhlZCBhIGJ1ZyB3aGVyZSBjb21pbmcgYmFjayB0byBhIHBhZ2UgdXNpbmcgdGhpcyBwbHVnaW4KLy8gICAgICAgICBmcm9tIGEgcGFnZSBvbiBhbm90aGVyIGRvbWFpbiB3b3VsZCBjYXVzZSBhbiBlcnJvciBpbiBTYWZhcmkgNC4gQWxzbywKLy8gICAgICAgICBJRTYvNyBJZnJhbWUgaXMgbm93IGluc2VydGVkIGFmdGVyIHRoZSBib2R5ICh0aGlzIGFjdHVhbGx5IHdvcmtzKSwKLy8gICAgICAgICB3aGljaCBwcmV2ZW50cyB0aGUgcGFnZSBmcm9tIHNjcm9sbGluZyB3aGVuIHRoZSBldmVudCBpcyBmaXJzdCBib3VuZC4KLy8gICAgICAgICBFdmVudCBjYW4gYWxzbyBub3cgYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IGl0IHdvbid0IGJlIHVzYWJsZQovLyAgICAgICAgIGJlZm9yZSB0aGVuIGluIElFNi83LgovLyAxLjEgICAtICgxLzIxLzIwMTApIEluY29ycG9yYXRlZCBkb2N1bWVudC5kb2N1bWVudE1vZGUgdGVzdCB0byBmaXggSUU4IGJ1ZwovLyAgICAgICAgIHdoZXJlIGJyb3dzZXIgdmVyc2lvbiBpcyBpbmNvcnJlY3RseSByZXBvcnRlZCBhcyA4LjAsIGRlc3BpdGUKLy8gICAgICAgICBpbmNsdXNpb24gb2YgdGhlIFgtVUEtQ29tcGF0aWJsZSBJRT1FbXVsYXRlSUU3IG1ldGEgdGFnLgovLyAxLjAgICAtICgxLzkvMjAxMCkgSW5pdGlhbCBSZWxlYXNlLiBCcm9rZSBvdXQgdGhlIGpRdWVyeSBCQlEgZXZlbnQuc3BlY2lhbAovLyAgICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZnVuY3Rpb25hbGl0eSBpbnRvIGEgc2VwYXJhdGUgcGx1Z2luIGZvciB1c2VycwovLyAgICAgICAgIHdobyB3YW50IGp1c3QgdGhlIGJhc2ljIGV2ZW50ICYgYmFjayBidXR0b24gc3VwcG9ydCwgd2l0aG91dCBhbGwgdGhlCi8vICAgICAgICAgZXh0cmEgYXdlc29tZW5lc3MgdGhhdCBCQlEgcHJvdmlkZXMuIFRoaXMgcGx1Z2luIHdpbGwgYmUgaW5jbHVkZWQgYXMKLy8gICAgICAgICBwYXJ0IG9mIGpRdWVyeSBCQlEsIGJ1dCBhbHNvIGJlIGF2YWlsYWJsZSBzZXBhcmF0ZWx5LgoKKGZ1bmN0aW9uKCQsd2luZG93LHVuZGVmaW5lZCl7CiAgJyQ6bm9tdW5nZSc7IC8vIFVzZWQgYnkgWVVJIGNvbXByZXNzb3IuCiAgCiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCl7CiAgICB2YXIgc2VsZiA9IHt9LAogICAgICB0aW1lb3V0X2lkLAogICAgICAKICAgICAgLy8gUmVtZW1iZXIgdGhlIGluaXRpYWwgaGFzaCBzbyBpdCBkb2Vzbid0IGdldCB0cmlnZ2VyZWQgaW1tZWRpYXRlbHkuCiAgICAgIGxhc3RfaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAKICAgICAgZm5fcmV0dmFsID0gZnVuY3Rpb24odmFsKXsgcmV0dXJuIHZhbDsgfSwKICAgICAgaGlzdG9yeV9zZXQgPSBmbl9yZXR2YWwsCiAgICAgIGhpc3RvcnlfZ2V0ID0gZm5fcmV0dmFsOwogICAgCiAgICAvLyBTdGFydCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkIHx8IHBvbGwoKTsKICAgIH07CiAgICAKICAgIC8vIFN0b3AgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkICYmIGNsZWFyVGltZW91dCggdGltZW91dF9pZCApOwogICAgICB0aW1lb3V0X2lkID0gdW5kZWZpbmVkOwogICAgfTsKICAgIAogICAgLy8gVGhpcyBwb2xsaW5nIGxvb3AgY2hlY2tzIGV2ZXJ5ICQuZm4uaGFzaGNoYW5nZS5kZWxheSBtaWxsaXNlY29uZHMgdG8gc2VlCiAgICAvLyBpZiBsb2NhdGlvbi5oYXNoIGhhcyBjaGFuZ2VkLCBhbmQgdHJpZ2dlcnMgdGhlICdoYXNoY2hhbmdlJyBldmVudCBvbgogICAgLy8gd2luZG93IHdoZW4gbmVjZXNzYXJ5LgogICAgZnVuY3Rpb24gcG9sbCgpIHsKICAgICAgdmFyIGhhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgICBoaXN0b3J5X2hhc2ggPSBoaXN0b3J5X2dldCggbGFzdF9oYXNoICk7CiAgICAgIAogICAgICBpZiAoIGhhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBoaXN0b3J5X3NldCggbGFzdF9oYXNoID0gaGFzaCwgaGlzdG9yeV9oYXNoICk7CiAgICAgICAgCiAgICAgICAgJCh3aW5kb3cpLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgICAgICAgCiAgICAgIH0gZWxzZSBpZiAoIGhpc3RvcnlfaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGxvY2F0aW9uLmhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIC8jLiovLCAnJyApICsgaGlzdG9yeV9oYXNoOwogICAgICB9CiAgICAgIAogICAgICB0aW1lb3V0X2lkID0gc2V0VGltZW91dCggcG9sbCwgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSApOwogICAgfTsKICAgIAogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2IFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgd2luZG93LmF0dGFjaEV2ZW50ICYmICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciAmJiAhc3VwcG9ydHNfb25oYXNoY2hhbmdlICYmIChmdW5jdGlvbigpewogICAgICAvLyBOb3Qgb25seSBkbyBJRTYvNyBuZWVkIHRoZSAibWFnaWNhbCIgSWZyYW1lIHRyZWF0bWVudCwgYnV0IHNvIGRvZXMgSUU4CiAgICAgIC8vIHdoZW4gcnVubmluZyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUuCiAgICAgIAogICAgICB2YXIgaWZyYW1lLAogICAgICAgIGlmcmFtZV9zcmM7CiAgICAgIAogICAgICAvLyBXaGVuIHRoZSBldmVudCBpcyBib3VuZCBhbmQgcG9sbGluZyBzdGFydHMgaW4gSUUgNi83LCBjcmVhdGUgYSBoaWRkZW4KICAgICAgLy8gSWZyYW1lIGZvciBoaXN0b3J5IGhhbmRsaW5nLgogICAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKXsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgCiAgICAgICAgICAvLyBXaGVuZXZlciBgZG9jdW1lbnQudGl0bGVgIGNoYW5nZXMsIHVwZGF0ZSB0aGUgSWZyYW1lJ3MgdGl0bGUgdG8KICAgICAgICAgIC8vIHByZXR0aWZ5IHRoZSBiYWNrL25leHQgaGlzdG9yeSBtZW51IGVudHJpZXMuIFNpbmNlIElFIHNvbWV0aW1lcwogICAgICAgICAgLy8gZXJyb3JzIHdpdGggIlVuc3BlY2lmaWVkIGVycm9yIiB0aGUgdmVyeSBmaXJzdCB0aW1lIHRoaXMgaXMgc2V0CiAgICAgICAgICAvLyAoeWVzLCB2ZXJ5IHVzZWZ1bCkgd3JhcCB0aGlzIHdpdGggYSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgICBkb2Mub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwogICAgICAgICAgCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgLy8gT3ZlcnJpZGUgdGhlICJzdG9wIiBtZXRob2Qgc2luY2UgYW4gSUU2LzcgSWZyYW1lIHdhcyBjcmVhdGVkLiBFdmVuCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IGJvdW5kIGV2ZW50IGhhbmRsZXJzLCB0aGUgcG9sbGluZyBsb29wCiAgICAgIC8vIGlzIHN0aWxsIG5lY2Vzc2FyeSBmb3IgYmFjay9uZXh0IHRvIHdvcmsgYXQgYWxsIQogICAgICBzZWxmLnN0b3AgPSBmbl9yZXR2YWw7CiAgICAgIAogICAgICAvLyBHZXQgaGlzdG9yeSBieSBsb29raW5nIGF0IHRoZSBoaWRkZW4gSWZyYW1lJ3MgbG9jYXRpb24uaGFzaC4KICAgICAgaGlzdG9yeV9nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0X2ZyYWdtZW50KCBpZnJhbWUubG9jYXRpb24uaHJlZiApOwogICAgICB9OwogICAgICAKICAgICAgLy8gU2V0IGEgbmV3IGhpc3RvcnkgaXRlbSBieSBvcGVuaW5nIGFuZCB0aGVuIGNsb3NpbmcgdGhlIElmcmFtZQogICAgICAvLyBkb2N1bWVudCwgKnRoZW4qIHNldHRpbmcgaXRzIGxvY2F0aW9uLmhhc2guIElmIGRvY3VtZW50LmRvbWFpbiBoYXMKICAgICAgLy8gYmVlbiBzZXQsIHVwZGF0ZSB0aGF0IGFzIHdlbGwuCiAgICAgIGhpc3Rvcnlfc2V0ID0gZnVuY3Rpb24oIGhhc2gsIGhpc3RvcnlfaGFzaCApIHsKICAgICAgICB2YXIgaWZyYW1lX2RvYyA9IGlmcmFtZS5kb2N1bWVudCwKICAgICAgICAgIGRvbWFpbiA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluOwogICAgICAgIAogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgCiAgICAgICAgICAvLyBPcGVuaW5nIHRoZSBJZnJhbWUncyBkb2N1bWVudCBhZnRlciBpdCBoYXMgYmVlbiBjbG9zZWQgaXMgd2hhdAogICAgICAgICAgLy8gYWN0dWFsbHkgYWRkcyBhIGhpc3RvcnkgZW50cnkuCiAgICAgICAgICBpZnJhbWVfZG9jLm9wZW4oKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0IGRvY3VtZW50LmRvbWFpbiBmb3IgdGhlIElmcmFtZSBkb2N1bWVudCBhcyB3ZWxsLCBpZiBuZWNlc3NhcnkuCiAgICAgICAgICBkb21haW4gJiYgaWZyYW1lX2RvYy53cml0ZSggJzxzY3JpcHQ+ZG9jdW1lbnQuZG9tYWluPSInICsgZG9tYWluICsgJyI8L3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLyohIG1hdGNoTWVkaWEoKSBwb2x5ZmlsbCAtIFRlc3QgYSBDU1MgbWVkaWEgdHlwZS9xdWVyeSBpbiBKUy4gQXV0aG9ycyAmIGNvcHlyaWdodCAoYykgMjAxMjogU2NvdHQgSmVobCwgUGF1bCBJcmlzaCwgTmljaG9sYXMgWmFrYXMuIER1YWwgTUlUL0JTRCBsaWNlbnNlICovCgl3aW5kb3cubWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhIHx8IChmdW5jdGlvbiggZG9jLCB1bmRlZmluZWQgKSB7CgoJCXZhciBib29sLAoJCQlkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudCwKCQkJcmVmTm9kZSA9IGRvY0VsZW0uZmlyc3RFbGVtZW50Q2hpbGQgfHwgZG9jRWxlbS5maXJzdENoaWxkLAoJCQkvLyBmYWtlQm9keSByZXF1aXJlZCBmb3IgPEZGNCB3aGVuIGV4ZWN1dGVkIGluIDxoZWFkPgoJCQlmYWtlQm9keSA9IGRvYy5jcmVhdGVFbGVtZW50KCAiYm9keSIgKSwKCQkJZGl2ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgoJCWRpdi5pZCA9ICJtcS10ZXN0LTEiOwoJCWRpdi5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOmFic29sdXRlO3RvcDotMTAwZW0iOwoJCWZha2VCb2R5LnN0eWxlLmJhY2tncm91bmQgPSAibm9uZSI7CgkJZmFrZUJvZHkuYXBwZW5kQ2hpbGQoZGl2KTsKCgkJcmV0dXJuIGZ1bmN0aW9uKHEpewoKCQkJZGl2LmlubmVySFRNTCA9ICImc2h5OzxzdHlsZSBtZWRpYT1cIiIgKyBxICsgIlwiPiAjbXEtdGVzdC0xIHsgd2lkdGg6IDQycHg7IH08L3N0eWxlPiI7CgoJCQlkb2NFbGVtLmluc2VydEJlZm9yZSggZmFrZUJvZHksIHJlZk5vZGUgKTsKCQkJYm9vbCA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gNDI7CgkJCWRvY0VsZW0ucmVtb3ZlQ2hpbGQoIGZha2VCb2R5ICk7CgoJCQlyZXR1cm4gewoJCQkJbWF0Y2hlczogYm9vbCwKCQkJCW1lZGlhOiBxCgkJCX07CgoJCX07CgoJfSggZG9jdW1lbnQgKSk7CgoJLy8gJC5tb2JpbGUubWVkaWEgdXNlcyBtYXRjaE1lZGlhIHRvIHJldHVybiBhIGJvb2xlYW4uCgkkLm1vYmlsZS5tZWRpYSA9IGZ1bmN0aW9uKCBxICkgewoJCXJldHVybiB3aW5kb3cubWF0Y2hNZWRpYSggcSApLm1hdGNoZXM7Cgl9OwoKfSkoalF1ZXJ5KTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgc3VwcG9ydCA9IHsKCQkJdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudAoJCX07CgoJCSQubW9iaWxlLnN1cHBvcnQgPSAkLm1vYmlsZS5zdXBwb3J0IHx8IHt9OwoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHN1cHBvcnQgKTsKCQkkLmV4dGVuZCggJC5tb2JpbGUuc3VwcG9ydCwgc3VwcG9ydCApOwoJfSggalF1ZXJ5ICkpOwoKCShmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCQkJb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIgaW4gd2luZG93ICYmICJvbm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cKCQl9KTsKCX0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gdGh4IE1vZGVybml6cgpmdW5jdGlvbiBwcm9wRXhpc3RzKCBwcm9wICkgewoJdmFyIHVjX3Byb3AgPSBwcm9wLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnN1YnN0ciggMSApLAoJCXByb3BzID0gKCBwcm9wICsgIiAiICsgdmVuZG9ycy5qb2luKCB1Y19wcm9wICsgIiAiICkgKyB1Y19wcm9wICkuc3BsaXQoICIgIiApLAoJCXY7CgoJZm9yICggdiBpbiBwcm9wcyApIHsKCQlpZiAoIGZiQ1NTWyBwcm9wc1sgdiBdIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQp9Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5ICYmICFwcm9wRXhpc3RzKCAiLXdlYmtpdC10cmFuc2Zvcm0iICksIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQiA1IGFuZCBsb3dlcgoJbm9raWFMVEU3XzM7CgovLyBpbmxpbmUgU1ZHIHN1cHBvcnQgdGVzdApmdW5jdGlvbiBpbmxpbmVTVkcoKSB7CgkvLyBUaGFua3MgTW9kZXJuaXpyICYgRXJpayBEYWhsc3Ryb20KCXZhciB3ID0gd2luZG93LAoJCXN2ZyA9ICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMgJiYgISF3LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyggImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwgInN2ZyIgKS5jcmVhdGVTVkdSZWN0ICYmICEoIHcub3BlcmEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQ2hyb21lIiApID09PSAtMSApLAoJCXN1cHBvcnQgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJaWYgKCAhKCBkYXRhICYmIHN2ZyApICkgewoJCQkJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub3N2ZyIgKTsKCQkJfQoJCX0sCgkJaW1nID0gbmV3IHcuSW1hZ2UoKTsKCglpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGZhbHNlICk7Cgl9OwoJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGltZy53aWR0aCA9PT0gMSAmJiBpbWcuaGVpZ2h0ID09PSAxICk7Cgl9OwoJaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFBQUFBUC8vL3l3QUFBQUFBUUFCQUFBQ0FVd0FPdz09IjsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKSwKCQllbCwgdHJhbnNmb3JtcywgdDsKCglpZiAoIHJldCApIHsKCQlyZXR1cm4gISFyZXQ7Cgl9CgoJZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJdHJhbnNmb3JtcyA9IHsKCQkvLyBXZeKAmXJlIG9taXR0aW5nIE9wZXJhIGZvciB0aGUgdGltZSBiZWluZzsgTVMgdXNlcyB1bnByZWZpeGVkLgoJCSJNb3pUcmFuc2Zvcm0iOiAiLW1vei10cmFuc2Zvcm0iLAoJCSJ0cmFuc2Zvcm0iOiAidHJhbnNmb3JtIgoJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdCBpbiB0cmFuc2Zvcm1zICkgewoJCWlmICggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICkgewoJCQllbC5zdHlsZVsgdCBdID0gInRyYW5zbGF0ZTNkKCAxMDBweCwgMXB4LCAxcHggKSI7CgkJCXJldCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbCApLmdldFByb3BlcnR5VmFsdWUoIHRyYW5zZm9ybXNbIHQgXSApOwoJCX0KCX0KCXJldHVybiAoICEhcmV0ICYmIHJldCAhPT0gIm5vbmUiICk7Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKLy8gVGhhbmtzIE1vZGVybml6cgpmdW5jdGlvbiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpIHsKCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIngiICksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiAoICEoICJwb2ludGVyRXZlbnRzIiBpbiBlbGVtZW50LnN0eWxlICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJ4IjsKCWRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCggZWxlbWVudCApOwoJc3VwcG9ydHMgPSBnZXRDb21wdXRlZFN0eWxlICYmCglnZXRDb21wdXRlZFN0eWxlKCBlbGVtZW50LCAiIiApLnBvaW50ZXJFdmVudHMgPT09ICJhdXRvIjsKCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggZWxlbWVudCApOwoJcmV0dXJuICEhc3VwcG9ydHM7Cn0KCmZ1bmN0aW9uIGJvdW5kaW5nUmVjdCgpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJcmV0dXJuIHR5cGVvZiBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIjsKfQoKLy8gbm9uLVVBLWJhc2VkIElFIHZlcnNpb24gY2hlY2sgYnkgSmFtZXMgUGFkb2xzZXksIG1vZGlmaWVkIGJ5IGpkYWx0b24gLSBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTI3NjgzCi8vIGFsbG93cyBmb3IgaW5jbHVzaW9uIG9mIElFIDYrLCBpbmNsdWRpbmcgV2luZG93cyBNb2JpbGUgNwokLmV4dGVuZCggJC5tb2JpbGUsIHsgYnJvd3Nlcjoge30gfSApOwokLm1vYmlsZS5icm93c2VyLm9sZElFID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJYSA9IGRpdi5hbGwgfHwgW107CgoJZG8gewoJCWRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iOwoJfSB3aGlsZSggYVswXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCmZ1bmN0aW9uIGZpeGVkUG9zaXRpb24oKSB7Cgl2YXIgdyA9IHdpbmRvdywKCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCglpZiAoCgkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCS8vIE9wZXJhIE1pbmkKCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCS8vIE1lZUdvCgkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJcmV0dXJuIHRydWU7Cn0KCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCS8vIE5vdGUsIENocm9tZSBmb3IgaU9TIGhhcyBhbiBleHRyZW1lbHkgcXVpcmt5IGltcGxlbWVudGF0aW9uIG9mIHBvcHN0YXRlLgoJLy8gV2UndmUgY2hvc2VuIHRvIHRha2UgdGhlIHNob3J0ZXN0IHBhdGggdG8gYSBidWcgZml4IGhlcmUgZm9yIGlzc3VlICM1NDI2CgkvLyBTZWUgdGhlIGZvbGxvd2luZyBsaW5rIGZvciBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcmVnZXggY2hvc2VuCgkvLyBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9jaHJvbWUvbW9iaWxlL2RvY3MvdXNlci1hZ2VudCNjaHJvbWVfZm9yX2lvc191c2VyLWFnZW50CglwdXNoU3RhdGU6ICJwdXNoU3RhdGUiIGluIGhpc3RvcnkgJiYKCQkicmVwbGFjZVN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJLy8gV2hlbiBydW5uaW5nIGluc2lkZSBhIEZGIGlmcmFtZSwgY2FsbGluZyByZXBsYWNlU3RhdGUgY2F1c2VzIGFuIGVycm9yCgkJISggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkZpcmVmb3giICkgPj0gMCAmJiB3aW5kb3cudG9wICE9PSB3aW5kb3cgKSAmJgoJCSggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuc2VhcmNoKC9DcmlPUy8pID09PSAtMSApLAoKCW1lZGlhcXVlcnk6ICQubW9iaWxlLm1lZGlhKCAib25seSBhbGwiICksCgljc3NQc2V1ZG9FbGVtZW50OiAhIXByb3BFeGlzdHMoICJjb250ZW50IiApLAoJdG91Y2hPdmVyZmxvdzogISFwcm9wRXhpc3RzKCAib3ZlcmZsb3dTY3JvbGxpbmciICksCgljc3NUcmFuc2Zvcm0zZDogdHJhbnNmb3JtM2RUZXN0KCksCglib3hTaGFkb3c6ICEhcHJvcEV4aXN0cyggImJveFNoYWRvdyIgKSAmJiAhYmIsCglmaXhlZFBvc2l0aW9uOiBmaXhlZFBvc2l0aW9uKCksCglzY3JvbGxUb3A6ICgicGFnZVhPZmZzZXQiIGluIHdpbmRvdyB8fAoJCSJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fAoJCSJzY3JvbGxUb3AiIGluIGZha2VCb2R5WyAwIF0pICYmICF3ZWJvcyAmJiAhb3BlcmFtaW5pLAoKCWR5bmFtaWNCYXNlVGFnOiBiYXNlVGFnVGVzdCgpLAoJY3NzUG9pbnRlckV2ZW50czogY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSwKCWJvdW5kaW5nUmVjdDogYm91bmRpbmdSZWN0KCksCglpbmxpbmVTVkc6IGlubGluZVNWRwp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKLy8gJC5tb2JpbGUuYWpheEJsYWNrbGlzdCBpcyB1c2VkIHRvIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMgKEJCNSwgU3ltYmlhbikKLy8gb3IgdGhhdCBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChPcGVyYSBNaW5pKQovLyBOb3RlOiBUaGlzIGRldGVjdGlvbiBiZWxvdyBpcyB1c2VkIGFzIGEgbGFzdCByZXNvcnQuCi8vIFdlIHJlY29tbWVuZCBvbmx5IHVzaW5nIHRoZXNlIGRldGVjdGlvbiBtZXRob2RzIHdoZW4gYWxsIG90aGVyIG1vcmUgcmVsaWFibGUvZm9yd2FyZC1sb29raW5nIGFwcHJvYWNoZXMgYXJlIG5vdCBwb3NzaWJsZQpub2tpYUxURTdfMyA9IChmdW5jdGlvbigpIHsKCgl2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCgkvL1RoZSBmb2xsb3dpbmcgaXMgYW4gYXR0ZW1wdCB0byBtYXRjaCBOb2tpYSBicm93c2VycyB0aGF0IGFyZSBydW5uaW5nIFN5bWJpYW4vczYwLCB3aXRoIHdlYmtpdCwgdmVyc2lvbiA3LjMgb3Igb2xkZXIKCXJldHVybiB1YS5pbmRleE9mKCAiTm9raWEiICkgPiAtMSAmJgoJCQkoIHVhLmluZGV4T2YoICJTeW1iaWFuLzMiICkgPiAtMSB8fCB1YS5pbmRleE9mKCAiU2VyaWVzNjAvNSIgKSA+IC0xICkgJiYKCQkJdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgJiYKCQkJdWEubWF0Y2goIC8oQnJvd3Nlck5HfE5va2lhQnJvd3NlcilcLzdcLlswLTNdLyApOwp9KSgpOwoKLy8gU3VwcG9ydCBjb25kaXRpb25zIHRoYXQgbXVzdCBiZSBtZXQgaW4gb3JkZXIgdG8gcHJvY2VlZAovLyBkZWZhdWx0IGVuaGFuY2VkIHF1YWxpZmljYXRpb25zIGFyZSBtZWRpYSBxdWVyeSBzdXBwb3J0IE9SIElFIDcrCgokLm1vYmlsZS5ncmFkZUEgPSBmdW5jdGlvbigpIHsKCXJldHVybiAoICggJC5zdXBwb3J0Lm1lZGlhcXVlcnkgJiYgJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQgKSB8fCAkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICQubW9iaWxlLmJyb3dzZXIub2xkSUUgPj0gOCApICYmICggJC5zdXBwb3J0LmJvdW5kaW5nUmVjdCB8fCAkLmZuLmpxdWVyeS5tYXRjaCgvMVwuWzAtNytdXC5bMC05K10/LykgIT09IG51bGwgKTsKfTsKCiQubW9iaWxlLmFqYXhCbGFja2xpc3QgPQoJCQkvLyBCbGFja0JlcnJ5IGJyb3dzZXJzLCBwcmUtd2Via2l0CgkJCXdpbmRvdy5ibGFja2JlcnJ5ICYmICF3aW5kb3cuV2ViS2l0UG9pbnQgfHwKCQkJLy8gT3BlcmEgTWluaQoJCQlvcGVyYW1pbmkgfHwKCQkJLy8gU3ltYmlhbiB3ZWJraXRzIHByZSA3LjMKCQkJbm9raWFMVEU3XzM7CgovLyBMYXN0bHksIHRoaXMgd29ya2Fyb3VuZCBpcyB0aGUgb25seSB3YXkgd2UndmUgZm91bmQgc28gZmFyIHRvIGdldCBwcmUgNy4zIFN5bWJpYW4gd2Via2l0IGRldmljZXMKLy8gdG8gcmVuZGVyIHRoZSBzdHlsZXNoZWV0cyB3aGVuIHRoZXkncmUgcmVmZXJlbmNlZCBiZWZvcmUgdGhpcyBzY3JpcHQsIGFzIHdlJ2QgcmVjb21tZW5kIGRvaW5nLgovLyBUaGlzIHNpbXBseSByZWFwcGVuZHMgdGhlIENTUyBpbiBwbGFjZSwgd2hpY2ggZm9yIHNvbWUgcmVhc29uIG1ha2VzIGl0IGFwcGx5CmlmICggbm9raWFMVEU3XzMgKSB7CgkkKGZ1bmN0aW9uKCkgewoJCSQoICJoZWFkIGxpbmtbcmVsPSdzdHlsZXNoZWV0J10iICkuYXR0ciggInJlbCIsICJhbHRlcm5hdGUgc3R5bGVzaGVldCIgKS5hdHRyKCAicmVsIiwgInN0eWxlc2hlZXQiICk7Cgl9KTsKfQoKLy8gRm9yIHJ1bGluZyBvdXQgc2hhZG93cyB2aWEgY3NzCmlmICggISQuc3VwcG9ydC5ib3hTaGFkb3cgKSB7CgkkKCAiaHRtbCIgKS5hZGRDbGFzcyggInVpLW5vYm94c2hhZG93IiApOwp9Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdywgc2VsZiwKCQlkdW1teUZuVG9Jbml0TmF2aWdhdGUgPSBmdW5jdGlvbigpIHsKCQl9OwoKCSQuZXZlbnQuc3BlY2lhbC5iZWZvcmVuYXZpZ2F0ZSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSR3aW4ub24oICJuYXZpZ2F0ZSIsIGR1bW15Rm5Ub0luaXROYXZpZ2F0ZSApOwoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJHdpbi5vZmYoICJuYXZpZ2F0ZSIsIGR1bW15Rm5Ub0luaXROYXZpZ2F0ZSApOwoJCX0KCX07CgoJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlID0gc2VsZiA9IHsKCQlib3VuZDogZmFsc2UsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCW9yaWdpbmFsRXZlbnROYW1lOiB1bmRlZmluZWQsCgoJCS8vIElmIHB1c2hzdGF0ZSBzdXBwb3J0IGlzIHByZXNlbnQgYW5kIHB1c2ggc3RhdGUgc3VwcG9ydCBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgdHJ1ZSBvbiB0aGUgbW9iaWxlIG5hbWVzcGFjZS4KCQlpc1B1c2hTdGF0ZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5zdXBwb3J0LnB1c2hTdGF0ZSAmJgoJCQkJJC5tb2JpbGUucHVzaFN0YXRlRW5hYmxlZCA9PT0gdHJ1ZSAmJgoJCQkJdGhpcy5pc0hhc2hDaGFuZ2VFbmFibGVkKCk7CgkJfSwKCgkJLy8gISEgYXNzdW1lcyBtb2JpbGUgbmFtZXNwYWNlIGlzIHByZXNlbnQKCQlpc0hhc2hDaGFuZ2VFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkID09PSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gYSBsb3Qgb2YgZHVwbGljYXRpb24gYmV0d2VlbiBwb3BzdGF0ZSBhbmQgaGFzaGNoYW5nZQoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICksCgkJCQlzdGF0ZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge307CgoJCQliZWZvcmVOYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmICggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggZXZlbnQuaGlzdG9yeVN0YXRlICkgewoJCQkJJC5leHRlbmQoc3RhdGUsIGV2ZW50Lmhpc3RvcnlTdGF0ZSk7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBOT1RFIHdlIGxldCB0aGUgY3VycmVudCBzdGFjayB1bndpbmQgYmVjYXVzZSBhbnkgYXNzaWdubWVudCB0bwoJCQkvLyAgICAgIGxvY2F0aW9uLmhhc2ggd2lsbCBzdG9wIHRoZSB3b3JsZCBhbmQgcnVuIHRoaXMgZXZlbnQgaGFuZGxlci4gQnkKCQkJLy8gICAgICBkb2luZyB0aGlzIHdlIGNyZWF0ZSBhIHNpbWlsYXIgYmVoYXZpb3IgdG8gaGFzaGNoYW5nZSBvbiBoYXNoCgkJCS8vICAgICAgYXNzaWdubWVudAoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJJHdpbi50cmlnZ2VyKCBuZXdFdmVudCwgewoJCQkJCXN0YXRlOiBzdGF0ZQoJCQkJfSk7CgkJCX0sIDApOwoJCX0sCgoJCWhhc2hjaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCAvKiwgZGF0YSAqLyApIHsKCQkJdmFyIG5ld0V2ZW50ID0gbmV3ICQuRXZlbnQoICJuYXZpZ2F0ZSIgKSwKCQkJCWJlZm9yZU5hdmlnYXRlID0gbmV3ICQuRXZlbnQoICJiZWZvcmVuYXZpZ2F0ZSIgKTsKCgkJCWJlZm9yZU5hdmlnYXRlLm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYgKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIFRyaWdnZXIgdGhlIGhhc2hjaGFuZ2Ugd2l0aCBzdGF0ZSBwcm92aWRlZCBieSB0aGUgdXNlcgoJCQkvLyB0aGF0IGFsdGVyZWQgdGhlIGhhc2gKCQkJJHdpbi50cmlnZ2VyKCBuZXdFdmVudCwgewoJCQkJLy8gVXNlcnMgdGhhdCB3YW50IHRvIGZ1bGx5IG5vcm1hbGl6ZSB0aGUgdHdvIGV2ZW50cwoJCQkJLy8gd2lsbCBuZWVkIHRvIGRvIGhpc3RvcnkgbWFuYWdlbWVudCBkb3duIHRoZSBzdGFjayBhbmQKCQkJCS8vIGFkZCB0aGUgc3RhdGUgdG8gdGhlIGV2ZW50IGJlZm9yZSB0aGlzIGJpbmRpbmcgaXMgZmlyZWQKCQkJCS8vIFRPRE8gY29uc2lkZXIgYWxsb3dpbmcgZm9yIHRoZSBleHBsaWNpdCBhZGRpdGlvbiBvZiBjYWxsYmFja3MKCQkJCS8vICAgICAgdG8gYmUgZmlyZWQgYmVmb3JlIHRoaXMgdmFsdWUgaXMgc2V0IHRvIGF2b2lkIGV2ZW50IHRpbWluZyBpc3N1ZXMKCQkJCXN0YXRlOiBldmVudC5oYXNoY2hhbmdlU3RhdGUgfHwge30KCQkJfSk7CgkJfSwKCgkJLy8gVE9ETyBXZSByZWFsbHkgb25seSB3YW50IHRvIHNldCB0aGlzIHVwIG9uY2UKCQkvLyAgICAgIGJ1dCBJJ20gbm90IGNsZWFyIGlmIHRoZXJlJ3MgYSBiZXRlciB3YXkgdG8gYWNoaWV2ZQoJCS8vICAgICAgdGhpcyB3aXRoIHRoZSBqUXVlcnkgc3BlY2lhbCBldmVudCBzdHJ1Y3R1cmUKCQlzZXR1cDogZnVuY3Rpb24oIC8qIGRhdGEsIG5hbWVzcGFjZXMgKi8gKSB7CgkJCWlmICggc2VsZi5ib3VuZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJc2VsZi5ib3VuZCA9IHRydWU7CgoJCQlpZiAoIHNlbGYuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gInBvcHN0YXRlIjsKCQkJCSR3aW4uYmluZCggInBvcHN0YXRlLm5hdmlnYXRlIiwgc2VsZi5wb3BzdGF0ZSApOwoJCQl9IGVsc2UgaWYgKCBzZWxmLmlzSGFzaENoYW5nZUVuYWJsZWQoKSApIHsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAiaGFzaGNoYW5nZSI7CgkJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlLm5hdmlnYXRlIiwgc2VsZi5oYXNoY2hhbmdlICk7CgkJCX0KCQl9Cgl9Owp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCXZhciBwYXRoLCAkYmFzZSwgZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIjsKCgkJJC5tb2JpbGUucGF0aCA9IHBhdGggPSB7CgkJCXVpU3RhdGVLZXk6ICImdWktc3RhdGUiLAoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXlxzKigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy8gQWJzdHJhY3Rpb24gdG8gYWRkcmVzcyB4c3MgKElzc3VlICM0Nzg3KSBieSByZW1vdmluZyB0aGUgYXV0aG9yaXR5IGluCgkJCS8vIGJyb3dzZXJzIHRoYXQgYXV0bwlkZWNvZGUgaXQuIEFsbCByZWZlcmVuY2VzIHRvIGxvY2F0aW9uLmhyZWYgc2hvdWxkIGJlCgkJCS8vIHJlcGxhY2VkIHdpdGggYSBjYWxsIHRvIHRoaXMgbWV0aG9kIHNvIHRoYXQgaXQgY2FuIGJlIGRlYWx0IHdpdGggcHJvcGVybHkgaGVyZQoJCQlnZXRMb2NhdGlvbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1cmkgPSB1cmwgPyB0aGlzLnBhcnNlVXJsKCB1cmwgKSA6IGxvY2F0aW9uLAoJCQkJCWhhc2ggPSB0aGlzLnBhcnNlVXJsKCB1cmwgfHwgbG9jYXRpb24uaHJlZiApLmhhc2g7CgoJCQkJLy8gbWltaWMgdGhlIGJyb3dzZXIgd2l0aCBhbiBlbXB0eSBzdHJpbmcgd2hlbiB0aGUgaGFzaCBpcyBlbXB0eQoJCQkJaGFzaCA9IGhhc2ggPT09ICIjIiA/ICIiIDogaGFzaDsKCgkJCQkvLyBNYWtlIHN1cmUgdG8gcGFyc2UgdGhlIHVybCBvciB0aGUgbG9jYXRpb24gb2JqZWN0IGZvciB0aGUgaGFzaCBiZWNhdXNlIHVzaW5nIGxvY2F0aW9uLmhhc2gKCQkJCS8vIGlzIGF1dG9kZWNvZGVkIGluIGZpcmVmb3gsIHRoZSByZXN0IG9mIHRoZSB1cmwgc2hvdWxkIGJlIGZyb20gdGhlIG9iamVjdCAobG9jYXRpb24gdW5sZXNzCgkJCQkvLyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZSBhdXRob3JpdHkKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKyAiLy8iICsgdXJpLmhvc3QgKyB1cmkucGF0aG5hbWUgKyB1cmkuc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQkJZ2V0RG9jdW1lbnRVcmw6IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudFVybCApIDogcGF0aC5kb2N1bWVudFVybC5ocmVmOwoJCQl9LAoKCQkJcGFyc2VMb2NhdGlvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5wYXJzZVVybCggdGhpcy5nZXRMb2NhdGlvbigpICk7CgkJCX0sCgoJCQkvL1BhcnNlIGEgVVJMIGludG8gYSBzdHJ1Y3R1cmUgdGhhdCBhbGxvd3MgZWFzeSBhY2Nlc3MgdG8KCQkJLy9hbGwgb2YgdGhlIFVSTCBjb21wb25lbnRzIGJ5IG5hbWUuCgkJCXBhcnNlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gSWYgd2UncmUgcGFzc2VkIGFuIG9iamVjdCwgd2UnbGwgYXNzdW1lIHRoYXQgaXQgaXMKCQkJCS8vIGEgcGFyc2VkIHVybCBvYmplY3QgYW5kIGp1c3QgcmV0dXJuIGl0IGJhY2sgdG8gdGhlIGNhbGxlci4KCQkJCWlmICggJC50eXBlKCB1cmwgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQkJcmV0dXJuIHVybDsKCQkJCX0KCgkJCQl2YXIgbWF0Y2hlcyA9IHBhdGgudXJsUGFyc2VSRS5leGVjKCB1cmwgfHwgIiIgKSB8fCBbXTsKCgkJCQkJLy8gQ3JlYXRlIGFuIG9iamVjdCB0aGF0IGFsbG93cyB0aGUgY2FsbGVyIHRvIGFjY2VzcyB0aGUgc3ViLW1hdGNoZXMKCQkJCQkvLyBieSBuYW1lLiBOb3RlIHRoYXQgSUUgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiB1bmRlZmluZWQsCgkJCQkJLy8gbGlrZSBhbGwgb3RoZXIgYnJvd3NlcnMgZG8sIHNvIHdlIG5vcm1hbGl6ZSBldmVyeXRoaW5nIHNvIGl0cyBjb25zaXN0ZW50CgkJCQkJLy8gbm8gbWF0dGVyIHdoYXQgYnJvd3NlciB3ZSdyZSBydW5uaW5nIG9uLgoJCQkJCXJldHVybiB7CgkJCQkJCWhyZWY6ICAgICAgICAgbWF0Y2hlc1sgIDAgXSB8fCAiIiwKCQkJCQkJaHJlZk5vSGFzaDogICBtYXRjaGVzWyAgMSBdIHx8ICIiLAoJCQkJCQlocmVmTm9TZWFyY2g6IG1hdGNoZXNbICAyIF0gfHwgIiIsCgkJCQkJCWRvbWFpbjogICAgICAgbWF0Y2hlc1sgIDMgXSB8fCAiIiwKCQkJCQkJcHJvdG9jb2w6ICAgICBtYXRjaGVzWyAgNCBdIHx8ICIiLAoJCQkJCQlkb3VibGVTbGFzaDogIG1hdGNoZXNbICA1IF0gfHwgIiIsCgkJCQkJCWF1dGhvcml0eTogICAgbWF0Y2hlc1sgIDYgXSB8fCAiIiwKCQkJCQkJdXNlcm5hbWU6ICAgICBtYXRjaGVzWyAgOCBdIHx8ICIiLAoJCQkJCQlwYXNzd29yZDogICAgIG1hdGNoZXNbICA5IF0gfHwgIiIsCgkJCQkJCWhvc3Q6ICAgICAgICAgbWF0Y2hlc1sgMTAgXSB8fCAiIiwKCQkJCQkJaG9zdG5hbWU6ICAgICBtYXRjaGVzWyAxMSBdIHx8ICIiLAoJCQkJCQlwb3J0OiAgICAgICAgIG1hdGNoZXNbIDEyIF0gfHwgIiIsCgkJCQkJCXBhdGhuYW1lOiAgICAgbWF0Y2hlc1sgMTMgXSB8fCAiIiwKCQkJCQkJZGlyZWN0b3J5OiAgICBtYXRjaGVzWyAxNCBdIHx8ICIiLAoJCQkJCQlmaWxlbmFtZTogICAgIG1hdGNoZXNbIDE1IF0gfHwgIiIsCgkJCQkJCXNlYXJjaDogICAgICAgbWF0Y2hlc1sgMTYgXSB8fCAiIiwKCQkJCQkJaGFzaDogICAgICAgICBtYXRjaGVzWyAxNyBdIHx8ICIiCgkJCQkJfTsKCQkJfSwKCgkJCS8vVHVybiByZWxQYXRoIGludG8gYW4gYXNib2x1dGUgcGF0aC4gYWJzUGF0aCBpcwoJCQkvL2FuIG9wdGlvbmFsIGFic29sdXRlIHBhdGggd2hpY2ggZGVzY3JpYmVzIHdoYXQKCQkJLy9yZWxQYXRoIGlzIHJlbGF0aXZlIHRvLgoJCQltYWtlUGF0aEFic29sdXRlOiBmdW5jdGlvbiggcmVsUGF0aCwgYWJzUGF0aCApIHsKCQkJCXZhciBhYnNTdGFjaywKCQkJCQlyZWxTdGFjaywKCQkJCQlpLCBkOwoKCQkJCWlmICggcmVsUGF0aCAmJiByZWxQYXRoLmNoYXJBdCggMCApID09PSAiLyIgKSB7CgkJCQkJcmV0dXJuIHJlbFBhdGg7CgkJCQl9CgoJCQkJcmVsUGF0aCA9IHJlbFBhdGggfHwgIiI7CgkJCQlhYnNQYXRoID0gYWJzUGF0aCA/IGFic1BhdGgucmVwbGFjZSggL15cL3woXC9bXlwvXSp8W15cL10rKSQvZywgIiIgKSA6ICIiOwoKCQkJCWFic1N0YWNrID0gYWJzUGF0aCA/IGFic1BhdGguc3BsaXQoICIvIiApIDogW107CgkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoKCQkJCWZvciAoIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJZCA9IHJlbFN0YWNrWyBpIF07CgkJCQkJc3dpdGNoICggZCApIHsKCQkJCQkJY2FzZSAiLiI6CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiLi4iOgoJCQkJCQkJaWYgKCBhYnNTdGFjay5sZW5ndGggKSB7CgkJCQkJCQkJYWJzU3RhY2sucG9wKCk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCWFic1N0YWNrLnB1c2goIGQgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAiLyIgKyBhYnNTdGFjay5qb2luKCAiLyIgKTsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGlmIGJvdGggdXJscyBoYXZlIHRoZSBzYW1lIGRvbWFpbi4KCQkJaXNTYW1lRG9tYWluOiBmdW5jdGlvbiggYWJzVXJsMSwgYWJzVXJsMiApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCBhYnNVcmwxICkuZG9tYWluID09PSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwyICkuZG9tYWluOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFueSByZWxhdGl2ZSB2YXJpYW50LgoJCQlpc1JlbGF0aXZlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gQWxsIHJlbGF0aXZlIFVybCB2YXJpYW50cyBoYXZlIG9uZSB0aGluZyBpbiBjb21tb24sIG5vIHByb3RvY29sLgoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sID09PSAiIjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbiBhYnNvbHV0ZSB1cmwuCgkJCWlzQWJzb2x1dGVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgIT09ICIiOwoJCQl9LAoKCQkJLy9UdXJuIHRoZSBzcGVjaWZpZWQgcmVhbHRpdmUgVVJMIGludG8gYW4gYWJzb2x1dGUgb25lLiBUaGlzIGZ1bmN0aW9uCgkJCS8vY2FuIGhhbmRsZSBhbGwgcmVsYXRpdmUgdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGZyYWdtZW50KS4KCQkJbWFrZVVybEFic29sdXRlOiBmdW5jdGlvbiggcmVsVXJsLCBhYnNVcmwgKSB7CgkJCQlpZiAoICFwYXRoLmlzUmVsYXRpdmVVcmwoIHJlbFVybCApICkgewoJCQkJCXJldHVybiByZWxVcmw7CgkJCQl9CgoJCQkJaWYgKCBhYnNVcmwgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlhYnNVcmwgPSB0aGlzLmRvY3VtZW50QmFzZTsKCQkJCX0KCgkJCQl2YXIgcmVsT2JqID0gcGF0aC5wYXJzZVVybCggcmVsVXJsICksCgkJCQkJYWJzT2JqID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICksCgkJCQkJcHJvdG9jb2wgPSByZWxPYmoucHJvdG9jb2wgfHwgYWJzT2JqLnByb3RvY29sLAoJCQkJCWRvdWJsZVNsYXNoID0gcmVsT2JqLnByb3RvY29sID8gcmVsT2JqLmRvdWJsZVNsYXNoIDogKCByZWxPYmouZG91YmxlU2xhc2ggfHwgYWJzT2JqLmRvdWJsZVNsYXNoICksCgkJCQkJYXV0aG9yaXR5ID0gcmVsT2JqLmF1dGhvcml0eSB8fCBhYnNPYmouYXV0aG9yaXR5LAoJCQkJCWhhc1BhdGggPSByZWxPYmoucGF0aG5hbWUgIT09ICIiLAoJCQkJCXBhdGhuYW1lID0gcGF0aC5tYWtlUGF0aEFic29sdXRlKCByZWxPYmoucGF0aG5hbWUgfHwgYWJzT2JqLmZpbGVuYW1lLCBhYnNPYmoucGF0aG5hbWUgKSwKCQkJCQlzZWFyY2ggPSByZWxPYmouc2VhcmNoIHx8ICggIWhhc1BhdGggJiYgYWJzT2JqLnNlYXJjaCApIHx8ICIiLAoJCQkJCWhhc2ggPSByZWxPYmouaGFzaDsKCgkJCQlyZXR1cm4gcHJvdG9jb2wgKyBkb3VibGVTbGFzaCArIGF1dGhvcml0eSArIHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCS8vQWRkIHNlYXJjaCAoYWthIHF1ZXJ5KSBwYXJhbXMgdG8gdGhlIHNwZWNpZmllZCB1cmwuCgkJCWFkZFNlYXJjaFBhcmFtczogZnVuY3Rpb24oIHVybCwgcGFyYW1zICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwID0gKCB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApID8gJC5wYXJhbSggcGFyYW1zICkgOiBwYXJhbXMsCgkJCQkJcyA9IHUuc2VhcmNoIHx8ICI/IjsKCQkJCXJldHVybiB1LmhyZWZOb1NlYXJjaCArIHMgKyAoIHMuY2hhckF0KCBzLmxlbmd0aCAtIDEgKSAhPT0gIj8iID8gIiYiIDogIiIgKSArIHAgKyAoIHUuaGFzaCB8fCAiIiApOwoJCQl9LAoKCQkJY29udmVydFVybFRvRGF0YVVybDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICk7CgkJCQlpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIHUgKSApIHsKCQkJCQkvLyBGb3IgZW1iZWRkZWQgcGFnZXMsIHJlbW92ZSB0aGUgZGlhbG9nIGhhc2gga2V5IGFzIGluIGdldEZpbGVQYXRoKCksCgkJCQkJLy8gYW5kIHJlbW92ZSBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoCgkJCQkJCS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdCgkJCQkJCS5yZXBsYWNlKCAvXiMvLCAiIiApCgkJCQkJCS5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1NhbWVEb21haW4oIHUsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSB7CgkJCQkJcmV0dXJuIHUuaHJlZk5vSGFzaC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJCX0KCgkJCQlyZXR1cm4gd2luZG93LmRlY29kZVVSSUNvbXBvbmVudChhYnNVcmwpOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYgKCBuZXdQYXRoID09PSB1bmRlZmluZWQgKSB7CgkJCQkJbmV3UGF0aCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCQl9CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIG5ld1BhdGggKS5yZXBsYWNlKCAvW15cL10qXC5bXlwvKl0rJC8sICIiICk7CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKTsKCQkJfSwKCgkJCS8vanVzdCByZXR1cm4gdGhlIHVybCB3aXRob3V0IGFuIGluaXRpYWwgIwoJCQlzdHJpcEhhc2g6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCX0sCgoJCQlzdHJpcFF1ZXJ5UGFyYW1zOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJaXNIYXNoVmFsaWQ6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuICggL14jW14jXSskLyApLnRlc3QoIGhhc2ggKTsKCQkJfSwKCgkJCS8vY2hlY2sgd2hldGhlciBhIHVybCBpcyByZWZlcmVuY2luZyB0aGUgc2FtZSBkb21haW4sIG9yIGFuIGV4dGVybmFsIGRvbWFpbiBvciBkaWZmZXJlbnQgcHJvdG9jb2wKCQkJLy9jb3VsZCBiZSBtYWlsdG8sIGV0YwoJCQlpc0V4dGVybmFsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCQkJCXJldHVybiB1LnByb3RvY29sICYmIHUuZG9tYWluICE9PSB0aGlzLmRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgdGhpcy5kb2N1bWVudFVybCBhbmQgdGhlIGRvY3VtZW50QmFzZS4gVGhlIG1haW4gcmVhc29uIGZvciB0aGlzCgkJCQkvL2lzIHRoYXQgbGlua3MgZW1iZWRkZWQgd2l0aGluIGV4dGVybmFsIGRvY3VtZW50cyB3aWxsIHJlZmVyIHRvIHRoZQoJCQkJLy9hcHBsaWNhdGlvbiBkb2N1bWVudCwgd2hlcmVhcyBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gdGhlIGFwcGxpY2F0aW9uCgkJCQkvL2RvY3VtZW50IHdpbGwgYmUgcmVzb2x2ZWQgYWdhaW5zdCB0aGUgZG9jdW1lbnQgYmFzZS4KCQkJCWlmICggdS5wcm90b2NvbCAhPT0gIiIgKSB7CgkJCQkJcmV0dXJuICggIXRoaXMuaXNQYXRoKHUuaGFzaCkgJiYgdS5oYXNoICYmICggdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwgKCB0aGlzLmRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgKSApOwoJCQkJfQoJCQkJcmV0dXJuICggL14jLyApLnRlc3QoIHUuaHJlZiApOwoJCQl9LAoKCQkJc3F1YXNoOiBmdW5jdGlvbiggdXJsLCByZXNvbHV0aW9uVXJsICkgewoJCQkJdmFyIGhyZWYsIGNsZWFuZWRVcmwsIHNlYXJjaCwgc3RhdGVJbmRleCwKCQkJCQlpc1BhdGggPSB0aGlzLmlzUGF0aCggdXJsICksCgkJCQkJdXJpID0gdGhpcy5wYXJzZVVybCggdXJsICksCgkJCQkJcHJlc2VydmVkSGFzaCA9IHVyaS5oYXNoLAoJCQkJCXVpU3RhdGUgPSAiIjsKCgkJCQkvLyBwcm9kdWNlIGEgdXJsIGFnYWluc3Qgd2hpY2ggd2UgY2FuIHJlc29sZSB0aGUgcHJvdmlkZWQgcGF0aAoJCQkJcmVzb2x1dGlvblVybCA9IHJlc29sdXRpb25VcmwgfHwgKHBhdGguaXNQYXRoKHVybCkgPyBwYXRoLmdldExvY2F0aW9uKCkgOiBwYXRoLmdldERvY3VtZW50VXJsKCkpOwoKCQkJCS8vIElmIHRoZSB1cmwgaXMgYW55dGhpbmcgYnV0IGEgc2ltcGxlIHN0cmluZywgcmVtb3ZlIGFueSBwcmVjZWRpbmcgaGFzaAoJCQkJLy8gZWcgI2Zvby9iYXIgLT4gZm9vL2JhcgoJCQkJLy8gICAgI2ZvbyAtPiAjZm9vCgkJCQljbGVhbmVkVXJsID0gaXNQYXRoID8gcGF0aC5zdHJpcEhhc2goIHVybCApIDogdXJsOwoKCQkJCS8vIElmIHRoZSB1cmwgaXMgYSBmdWxsIHVybCB3aXRoIGEgaGFzaCBjaGVjayBpZiB0aGUgcGFyc2VkIGhhc2ggaXMgYSBwYXRoCgkJCQkvLyBpZiBpdCBpcywgc3RyaXAgdGhlICMsIGFuZCB1c2UgaXQgb3RoZXJ3aXNlIGNvbnRpbnVlIHdpdGhvdXQgY2hhbmdlCgkJCQljbGVhbmVkVXJsID0gcGF0aC5pc1BhdGgoIHVyaS5oYXNoICkgPyBwYXRoLnN0cmlwSGFzaCggdXJpLmhhc2ggKSA6IGNsZWFuZWRVcmw7CgoJCQkJLy8gU3BsaXQgdGhlIFVJIFN0YXRlIGtleXMgb2ZmIHRoZSBocmVmCgkJCQlzdGF0ZUluZGV4ID0gY2xlYW5lZFVybC5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKTsKCgkJCQkvLyBzdG9yZSB0aGUgdWkgc3RhdGUga2V5cyBmb3IgdXNlCgkJCQlpZiAoIHN0YXRlSW5kZXggPiAtMSApIHsKCQkJCQl1aVN0YXRlID0gY2xlYW5lZFVybC5zbGljZSggc3RhdGVJbmRleCApOwoJCQkJCWNsZWFuZWRVcmwgPSBjbGVhbmVkVXJsLnNsaWNlKCAwLCBzdGF0ZUluZGV4ICk7CgkJCQl9CgoJCQkJLy8gbWFrZSB0aGUgY2xlYW5lZFVybCBhYnNvbHV0ZSByZWxhdGl2ZSB0byB0aGUgcmVzb2x1dGlvbiB1cmwKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggY2xlYW5lZFVybCwgcmVzb2x1dGlvblVybCApOwoKCQkJCS8vIGdyYWIgdGhlIHNlYXJjaCBmcm9tIHRoZSByZXNvbHZlZCB1cmwgc2luY2UgcGFyc2luZyBmcm9tCgkJCQkvLyB0aGUgcGFzc2VkIHVybCBtYXkgbm90IHlpZWxkIHRoZSBjb3JyZWN0IHJlc3VsdAoJCQkJc2VhcmNoID0gdGhpcy5wYXJzZVVybCggaHJlZiApLnNlYXJjaDsKCgkJCQkvLyBUT0RPIGFsbCB0aGlzIGNyYXAgaXMgdGVycmlibGUsIGNsZWFuIGl0IHVwCgkJCQlpZiAoIGlzUGF0aCApIHsKCQkJCQkvLyByZWplY3QgdGhlIGhhc2ggaWYgaXQncyBhIHBhdGggb3IgaXQncyBqdXN0IGEgZGlhbG9nIGtleQoJCQkJCWlmICggcGF0aC5pc1BhdGgoIHByZXNlcnZlZEhhc2ggKSB8fCBwcmVzZXJ2ZWRIYXNoLnJlcGxhY2UoIiMiLCAiIikuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDApIHsKCQkJCQkJcHJlc2VydmVkSGFzaCA9ICIiOwoJCQkJCX0KCgkJCQkJLy8gQXBwZW5kIHRoZSBVSSBTdGF0ZSBrZXlzIHdoZXJlIGl0IGV4aXN0cyBhbmQgaXQncyBiZWVuIHJlbW92ZWQKCQkJCQkvLyBmcm9tIHRoZSB1cmwKCQkJCQlpZiAoIHVpU3RhdGUgJiYgcHJlc2VydmVkSGFzaC5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gLTEpIHsKCQkJCQkJcHJlc2VydmVkSGFzaCArPSB1aVN0YXRlOwoJCQkJCX0KCgkJCQkJLy8gbWFrZSBzdXJlIHRoYXQgcG91bmQgaXMgb24gdGhlIGZyb250IG9mIHRoZSBoYXNoCgkJCQkJaWYgKCBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoICIjIiApID09PSAtMSAmJiBwcmVzZXJ2ZWRIYXNoICE9PSAiIiApIHsKCQkJCQkJcHJlc2VydmVkSGFzaCA9ICIjIiArIHByZXNlcnZlZEhhc2g7CgkJCQkJfQoKCQkJCQkvLyByZWNvbnN0cnVjdCBlYWNoIG9mIHRoZSBwaWVjZXMgd2l0aCB0aGUgbmV3IHNlYXJjaCBzdHJpbmcgYW5kIGhhc2gKCQkJCQlocmVmID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJCWhyZWYgPSBocmVmLnByb3RvY29sICsgIi8vIiArIGhyZWYuaG9zdCArIGhyZWYucGF0aG5hbWUgKyBzZWFyY2ggKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJfSBlbHNlIHsKCQkJCQlocmVmICs9IGhyZWYuaW5kZXhPZiggIiMiICkgPiAtMSA/IHVpU3RhdGUgOiAiIyIgKyB1aVN0YXRlOwoJCQkJfQoKCQkJCXJldHVybiBocmVmOwoJCQl9LAoKCQkJaXNQcmVzZXJ2YWJsZUhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIGhhc2gucmVwbGFjZSggIiMiLCAiIiApLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAwOwoJCQl9LAoKCQkJLy8gRXNjYXBlIHdlaXJkIGNoYXJhY3RlcnMgaW4gdGhlIGhhc2ggaWYgaXQgaXMgdG8gYmUgdXNlZCBhcyBhIHNlbGVjdG9yCgkJCWhhc2hUb1NlbGVjdG9yOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXZhciBoYXNIYXNoID0gKCBoYXNoLnN1YnN0cmluZyggMCwgMSApID09PSAiIyIgKTsKCQkJCWlmICggaGFzSGFzaCApIHsKCQkJCQloYXNoID0gaGFzaC5zdWJzdHJpbmcoIDEgKTsKCQkJCX0KCQkJCXJldHVybiAoIGhhc0hhc2ggPyAiIyIgOiAiIiApICsgaGFzaC5yZXBsYWNlKCAvKFshIiMkJSYnKCkqKywuLzo7PD0+P0BbXF1eYHt8fX5dKS9nLCAiXFwkMSIgKTsKCQkJfSwKCgkJCS8vIHJldHVybiB0aGUgc3Vic3RyaW5nIG9mIGEgZmlsZXBhdGggYmVmb3JlIHRoZSBzdWItcGFnZSBrZXksIGZvciBtYWtpbmcKCQkJLy8gYSBzZXJ2ZXIgcmVxdWVzdAoJCQlnZXRGaWxlUGF0aDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQl2YXIgc3BsaXRrZXkgPSAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5OwoJCQkJcmV0dXJuIHBhdGggJiYgcGF0aC5zcGxpdCggc3BsaXRrZXkgKVswXS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQl9LAoKCQkJLy8gY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluCgkJCS8vIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCB0aGlzLmRvY3VtZW50QmFzZSApICksCgoJCQkJCS8vIERvZXMgdGhlIHVybCBoYXZlIHRoZSBzYW1lIHBhdGggYXMgdGhlIGRvY3VtZW50PwoJCQkJCXNhbWVQYXRoID0gdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwKCQkJCQkJKCB0aGlzLmRvY3VtZW50QmFzZURpZmZlcnMgJiYKCQkJCQkJCXUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJLy8gVGhlIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaWYgdGhlIHBhdGggbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYW5kCgkJCQkvLyBpdCBlaXRoZXIgaGFzIG5vIGhhc2ggdmFsdWUsIG9yIHRoZSBoYXNoIGlzIGV4YWN0bHkgZXF1YWwgdG8gdGhlIGlkCgkJCQkvLyBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJcmV0dXJuIHNhbWVQYXRoICYmCgkJCQkJKCAhdS5oYXNoIHx8CgkJCQkJCXUuaGFzaCA9PT0gIiMiIHx8CgkJCQkJCSggZnBJZCAmJiB1Lmhhc2gucmVwbGFjZSggL14jLywgIiIgKSA9PT0gZnBJZCApICk7CgkJCX0sCgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93CgkJCS8vIGNyb3NzLWRvbWFpbiBYSFIgcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQKCQkJLy8gdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLiBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvCgkJCS8vICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlcgoJCQkvLyBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUgYWxsb3dDcm9zc0RvbWFpblBhZ2VzCgkJCS8vIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzIHJlcXVlc3RzIHRvIGdvCgkJCS8vIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCQkJaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3Q6IGZ1bmN0aW9uKCBkb2NVcmwsIHJlcVVybCApIHsKCQkJCXJldHVybiAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgJiYKCQkJCQkoZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiIHx8IGRvY1VybC5wcm90b2NvbCA9PT0gImNvbnRlbnQ6IikgJiYKCQkJCQlyZXFVcmwuc2VhcmNoKCAvXmh0dHBzPzovICkgIT09IC0xOwoJCQl9CgkJfTsKCgkJcGF0aC5kb2N1bWVudFVybCA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkkYmFzZSA9ICQoICJoZWFkIiApLmZpbmQoICJiYXNlIiApOwoKCQlwYXRoLmRvY3VtZW50QmFzZSA9ICRiYXNlLmxlbmd0aCA/CgkJCXBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCAkYmFzZS5hdHRyKCAiaHJlZiIgKSwgcGF0aC5kb2N1bWVudFVybC5ocmVmICkgKSA6CgkJCXBhdGguZG9jdW1lbnRVcmw7CgoJCXBhdGguZG9jdW1lbnRCYXNlRGlmZmVycyA9IChwYXRoLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggIT09IHBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2gpOwoKCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQlwYXRoLmdldERvY3VtZW50QmFzZSA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50QmFzZSApIDogcGF0aC5kb2N1bWVudEJhc2UuaHJlZjsKCQl9OwoKCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIGluIDEuNS4wCgkJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkJCWdldERvY3VtZW50VXJsOiBwYXRoLmdldERvY3VtZW50VXJsLAoKCQkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkJCWdldERvY3VtZW50QmFzZTogcGF0aC5nZXREb2N1bWVudEJhc2UKCQl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQubW9iaWxlLkhpc3RvcnkgPSBmdW5jdGlvbiggc3RhY2ssIGluZGV4ICkgewoJCXRoaXMuc3RhY2sgPSBzdGFjayB8fCBbXTsKCQl0aGlzLmFjdGl2ZUluZGV4ID0gaW5kZXggfHwgMDsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuSGlzdG9yeS5wcm90b3R5cGUsIHsKCQlnZXRBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCBdOwoJCX0sCgoJCWdldExhc3Q6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5wcmV2aW91c0luZGV4IF07CgkJfSwKCgkJZ2V0TmV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4ICsgMSBdOwoJCX0sCgoJCWdldFByZXY6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCAtIDEgXTsKCQl9LAoKCQkvLyBhZGROZXcgaXMgdXNlZCB3aGVuZXZlciBhIG5ldyBwYWdlIGlzIGFkZGVkCgkJYWRkOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJCS8vaWYgdGhlcmUncyBmb3J3YXJkIGhpc3RvcnksIHdpcGUgaXQKCQkJaWYgKCB0aGlzLmdldE5leHQoKSApIHsKCQkJCXRoaXMuY2xlYXJGb3J3YXJkKCk7CgkJCX0KCgkJCS8vIGlmIHRoZSBoYXNoIGlzIGluY2x1ZGVkIGluIHRoZSBkYXRhIG1ha2Ugc3VyZSB0aGUgc2hhcGUKCQkJLy8gaXMgY29uc2lzdGVudCBmb3IgY29tcGFyaXNvbgoJCQlpZiAoIGRhdGEuaGFzaCAmJiBkYXRhLmhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xKSB7CgkJCQlkYXRhLmhhc2ggPSAiIyIgKyBkYXRhLmhhc2g7CgkJCX0KCgkJCWRhdGEudXJsID0gdXJsOwoJCQl0aGlzLnN0YWNrLnB1c2goIGRhdGEgKTsKCQkJdGhpcy5hY3RpdmVJbmRleCA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsKCQl9LAoKCQkvL3dpcGUgdXJscyBhaGVhZCBvZiBhY3RpdmUgaW5kZXgKCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnN0YWNrID0gdGhpcy5zdGFjay5zbGljZSggMCwgdGhpcy5hY3RpdmVJbmRleCArIDEgKTsKCQl9LAoKCQlmaW5kOiBmdW5jdGlvbiggdXJsLCBzdGFjaywgZWFybHlSZXR1cm4gKSB7CgkJCXN0YWNrID0gc3RhY2sgfHwgdGhpcy5zdGFjazsKCgkJCXZhciBlbnRyeSwgaSwgbGVuZ3RoID0gc3RhY2subGVuZ3RoLCBpbmRleDsKCgkJCWZvciAoIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQllbnRyeSA9IHN0YWNrW2ldOwoKCQkJCWlmICggZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS51cmwpIHx8CgkJCQkJZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS5oYXNoKSApIHsKCQkJCQlpbmRleCA9IGk7CgoJCQkJCWlmICggZWFybHlSZXR1cm4gKSB7CgkJCQkJCXJldHVybiBpbmRleDsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXJldHVybiBpbmRleDsKCQl9LAoKCQljbG9zZXN0OiBmdW5jdGlvbiggdXJsICkgewoJCQl2YXIgY2xvc2VzdCwgYSA9IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkvLyBGaXJzdCwgdGFrZSB0aGUgc2xpY2Ugb2YgdGhlIGhpc3Rvcnkgc3RhY2sgYmVmb3JlIHRoZSBjdXJyZW50IGluZGV4IGFuZCBzZWFyY2gKCQkJLy8gZm9yIGEgdXJsIG1hdGNoLiBJZiBvbmUgaXMgZm91bmQsIHdlJ2xsIGF2b2lkIGF2b2lkIGxvb2tpbmcgdGhyb3VnaCBmb3J3YXJkIGhpc3RvcnkKCQkJLy8gTk9URSB0aGUgcHJlZmVyZW5jZSBmb3IgYmFja3dhcmQgaGlzdG9yeSBtb3ZlbWVudCBpcyBkcml2ZW4gYnkgdGhlIGZhY3QgdGhhdAoJCQkvLyAgICAgIG1vc3QgbW9iaWxlIGJyb3dzZXJzIG9ubHkgaGF2ZSBhIGRlZGljYXRlZCBiYWNrIGJ1dHRvbiwgYW5kIHVzZXJzIHJhcmVseSB1c2UKCQkJLy8gICAgICB0aGUgZm9yd2FyZCBidXR0b24gaW4gZGVza3RvcCBicm93c2VyIGFueWhvdwoJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoMCwgYSkgKTsKCgkJCS8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGluIGJhY2t3YXJkIGhpc3RvcnkgY2hlY2sgZm9yd2FyZC4gVGhlIGB0cnVlYAoJCQkvLyB2YWx1ZSBwYXNzZWQgYXMgdGhlIHRoaXJkIHBhcmFtZXRlciBjYXVzZXMgdGhlIGZpbmQgbWV0aG9kIHRvIGJyZWFrCgkJCS8vIG9uIHRoZSBmaXJzdCBtYXRjaCBpbiB0aGUgZm9yd2FyZCBoaXN0b3J5IHNsaWNlLiBUaGUgc3RhcnRpbmcgaW5kZXgKCQkJLy8gb2YgdGhlIHNsaWNlIG11c3QgdGhlbiBiZSBhZGRlZCB0byB0aGUgcmVzdWx0IHRvIGdldCB0aGUgZWxlbWVudCBpbmRleAoJCQkvLyBpbiB0aGUgb3JpZ2luYWwgaGlzdG9yeSBzdGFjayA6KCA6KAoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgaHlwZXIgY29uZnVzaW5nIGFuZCBzaG91bGQgYmUgY2xlYW5lZCB1cCAodWdoIHNvIGJhZCkKCQkJaWYgKCBjbG9zZXN0ID09PSB1bmRlZmluZWQgKSB7CgkJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoYSksIHRydWUgKTsKCQkJCWNsb3Nlc3QgPSBjbG9zZXN0ID09PSB1bmRlZmluZWQgPyBjbG9zZXN0IDogY2xvc2VzdCArIGE7CgkJCX0KCgkJCXJldHVybiBjbG9zZXN0OwoJCX0sCgoJCWRpcmVjdDogZnVuY3Rpb24oIG9wdHMgKSB7CgkJCXZhciBuZXdBY3RpdmVJbmRleCA9IHRoaXMuY2xvc2VzdCggb3B0cy51cmwgKSwgYSA9IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCS8vIHJlY29yZCB0aGUgcHJldmlvdXMgaW5kZXggZm9yIHJlZmVyZW5jZQoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXg7CgkJCQl0aGlzLnByZXZpb3VzSW5kZXggPSBhOwoJCQl9CgoJCQkvLyBpbnZva2UgY2FsbGJhY2tzIHdoZXJlIGFwcHJvcHJpYXRlCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBhbHNvIGNvbnZvbHV0ZWQgYW5kIGNvbmZ1c2luZwoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4IDwgYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuYmFjayB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgImJhY2siICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID4gYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuZm9yd2FyZCB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgImZvcndhcmQiICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID09PSB1bmRlZmluZWQgJiYgb3B0cy5taXNzaW5nICkgewoJCQkJb3B0cy5taXNzaW5nKCB0aGlzLmdldEFjdGl2ZSgpICk7CgkJCX0KCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aCwKCQlpbml0aWFsSHJlZiA9IGxvY2F0aW9uLmhyZWY7CgoJJC5tb2JpbGUuTmF2aWdhdG9yID0gZnVuY3Rpb24oIGhpc3RvcnkgKSB7CgkJdGhpcy5oaXN0b3J5ID0gaGlzdG9yeTsKCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gdHJ1ZTsKCgkJJC5tb2JpbGUud2luZG93LmJpbmQoewoJCQkicG9wc3RhdGUuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMucG9wc3RhdGUsIHRoaXMgKSwKCQkJImhhc2hjaGFuZ2UuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMuaGFzaGNoYW5nZSwgdGhpcyApCgkJfSk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLk5hdmlnYXRvci5wcm90b3R5cGUsIHsKCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCXZhciBzdGF0ZSwgaHJlZiwgaGFzaCA9IHBhdGguaXNQYXRoKHVybCkgPyBwYXRoLnN0cmlwSGFzaCh1cmwpIDogdXJsOwoKCQkJaHJlZiA9IHBhdGguc3F1YXNoKCB1cmwgKTsKCgkJCS8vIG1ha2Ugc3VyZSB0byBwcm92aWRlIHRoaXMgaW5mb3JtYXRpb24gd2hlbiBpdCBpc24ndCBleHBsaWNpdGx5IHNldCBpbiB0aGUKCQkJLy8gZGF0YSBvYmplY3QgdGhhdCB3YXMgcGFzc2VkIHRvIHRoZSBzcXVhc2ggbWV0aG9kCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJaGFzaDogaGFzaCwKCQkJCXVybDogaHJlZgoJCQl9LCBkYXRhKTsKCgkJCS8vIHJlcGxhY2UgdGhlIGN1cnJlbnQgdXJsIHdpdGggdGhlIG5ldyBocmVmIGFuZCBzdG9yZSB0aGUgc3RhdGUKCQkJLy8gTm90ZSB0aGF0IGluIHNvbWUgY2FzZXMgd2UgbWlnaHQgYmUgcmVwbGFjaW5nIGFuIHVybCB3aXRoIHRoZQoJCQkvLyBzYW1lIHVybC4gV2UgZG8gdGhpcyBhbnl3YXlzIGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdAoJCQkvLyBhbGwgb2Ygb3VyIGhpc3RvcnkgZW50cmllcyBoYXZlIGEgc3RhdGUgb2JqZWN0IGFzc29jaWF0ZWQgd2l0aAoJCQkvLyB0aGVtLiBUaGlzIGFsbG93cyB1cyB0byB3b3JrIGFyb3VuZCB0aGUgY2FzZSB3aGVyZSAkLm1vYmlsZS5iYWNrKCkKCQkJLy8gaXMgY2FsbGVkIHRvIHRyYW5zaXRpb24gZnJvbSBhbiBleHRlcm5hbCBwYWdlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuCgkJCS8vIEluIHRoYXQgcGFydGljdWxhciBjYXNlLCBhIGhhc2hjaGFuZ2UgZXZlbnQgaXMgKk5PVCogZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLgoJCQkvLyBFbnN1cmluZyBlYWNoIGhpc3RvcnkgZW50cnkgaGFzIGEgc3RhdGUgb2JqZWN0IG1lYW5zIHRoYXQgb25Qb3BTdGF0ZSgpCgkJCS8vIHdpbGwgYWx3YXlzIHRyaWdnZXIgb3VyIGhhc2hjaGFuZ2UgY2FsbGJhY2sgZXZlbiB3aGVuIGEgaGFzaGNoYW5nZSBldmVudAoJCQkvLyBpcyBub3QgZmlyZWQuCgkJCXdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSggc3RhdGUsIHN0YXRlLnRpdGxlIHx8IGRvY3VtZW50LnRpdGxlLCBocmVmICk7CgoJCQlyZXR1cm4gc3RhdGU7CgkJfSwKCgkJaGFzaDogZnVuY3Rpb24oIHVybCwgaHJlZiApIHsKCQkJdmFyIHBhcnNlZCwgbG9jLCBoYXNoLCByZXNvbHZlZDsKCgkJCS8vIEdyYWIgdGhlIGhhc2ggZm9yIHJlY29yZGluZy4gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoCgkJCS8vIHdlIHVzZWQgdGhlIHBhcnNlZCB2ZXJzaW9uIG9mIHRoZSBzcXVhc2hlZCB1cmwgdG8gcmVjb25zdHJ1Y3QsCgkJCS8vIG90aGVyd2lzZSB3ZSBhc3N1bWUgaXQncyBhIGhhc2ggYW5kIHN0b3JlIGl0IGRpcmVjdGx5CgkJCXBhcnNlZCA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQlsb2MgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJCWlmICggbG9jLnBhdGhuYW1lICsgbG9jLnNlYXJjaCA9PT0gcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaCApIHsKCQkJCS8vIElmIHRoZSBwYXRobmFtZSBhbmQgc2VhcmNoIG9mIHRoZSBwYXNzZWQgdXJsIGlzIGlkZW50aWNhbCB0byB0aGUgY3VycmVudCBsb2MKCQkJCS8vIHRoZW4gd2UgbXVzdCB1c2UgdGhlIGhhc2guIE90aGVyd2lzZSB0aGVyZSB3aWxsIGJlIG5vIGV2ZW50CgkJCQkvLyBlZywgdXJsID0gIi9mb28vYmFyP2JheiNiYW5nIiwgbG9jYXRpb24uaHJlZiA9ICJodHRwOi8vZXhhbXBsZS5jb20vZm9vL2Jhcj9iYXoiCgkJCQloYXNoID0gcGFyc2VkLmhhc2ggPyBwYXJzZWQuaGFzaCA6IHBhcnNlZC5wYXRobmFtZSArIHBhcnNlZC5zZWFyY2g7CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKHVybCkgKSB7CgkJCQlyZXNvbHZlZCA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCS8vIElmIHRoZSBwYXNzZWQgdXJsIGlzIGEgcGF0aCwgbWFrZSBpdCBkb21haW4gcmVsYXRpdmUgYW5kIHJlbW92ZSBhbnkgdHJhaWxpbmcgaGFzaAoJCQkJaGFzaCA9IHJlc29sdmVkLnBhdGhuYW1lICsgcmVzb2x2ZWQuc2VhcmNoICsgKHBhdGguaXNQcmVzZXJ2YWJsZUhhc2goIHJlc29sdmVkLmhhc2ggKT8gcmVzb2x2ZWQuaGFzaC5yZXBsYWNlKCAiIyIsICIiICkgOiAiIik7CgkJCX0gZWxzZSB7CgkJCQloYXNoID0gdXJsOwoJCQl9CgoJCQlyZXR1cm4gaGFzaDsKCQl9LAoKCQkvLyBUT0RPIHJlY29uc2lkZXIgbmFtZQoJCWdvOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoLCBwb3BzdGF0ZUV2ZW50LAoJCQkJaXNQb3BTdGF0ZUV2ZW50ID0gJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpOwoKCQkJLy8gR2V0IHRoZSB1cmwgYXMgaXQgd291bGQgbG9vayBzcXVhc2hlZCBvbiB0byB0aGUgY3VycmVudCByZXNvbHV0aW9uIHVybAoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gc29ydCBvdXQgd2hhdCB0aGUgaGFzaCBzb3VsZCBiZSBmcm9tIHRoZSB1cmwKCQkJaGFzaCA9IHRoaXMuaGFzaCggdXJsLCBocmVmICk7CgoJCQkvLyBIZXJlIHdlIHByZXZlbnQgdGhlIG5leHQgaGFzaCBjaGFuZ2Ugb3IgcG9wc3RhdGUgZXZlbnQgZnJvbSBkb2luZyBhbnkKCQkJLy8gaGlzdG9yeSBtYW5hZ2VtZW50LiBJbiB0aGUgY2FzZSBvZiBoYXNoY2hhbmdlIHdlIGRvbid0IHN3YWxsb3cgaXQKCQkJLy8gaWYgdGhlcmUgd2lsbCBiZSBubyBoYXNoY2hhbmdlIGZpcmVkIChzaW5jZSB0aGF0IHdvbid0IHJlc2V0IHRoZSB2YWx1ZSkKCQkJLy8gYW5kIHdpbGwgc3dhbGxvdyB0aGUgZm9sbG93aW5nIGhhc2hjaGFuZ2UKCQkJaWYgKCBub0V2ZW50cyAmJiBoYXNoICE9PSBwYXRoLnN0cmlwSGFzaChwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApIHsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gbm9FdmVudHM7CgkJCX0KCgkJCS8vIElNUE9SVEFOVCBpbiB0aGUgY2FzZSB3aGVyZSBwb3BzdGF0ZSBpcyBzdXBwb3J0ZWQgdGhlIGV2ZW50IHdpbGwgYmUgdHJpZ2dlcmVkCgkJCS8vICAgICAgZGlyZWN0bHksIHN0b3BwaW5nIGZ1cnRoZXIgZXhlY3V0aW9uIC0gaWUsIGludGVydXB0aW5nIHRoZSBmbG93IG9mIHRoaXMKCQkJLy8gICAgICBtZXRob2QgY2FsbCB0byBmaXJlIGJpbmRpbmdzIGF0IHRoaXMgZXhwcmVzc2lvbi4gQmVsb3cgdGhlIG5hdmlnYXRlIG1ldGhvZAoJCQkvLyAgICAgIHRoZXJlIGlzIGEgYmluZGluZyB0byBjYXRjaCB0aGlzIGV2ZW50IGFuZCBzdG9wIGl0cyBwcm9wYWdhdGlvbi4KCQkJLy8KCQkJLy8gICAgICBXZSB0aGVuIHRyaWdnZXIgYSBuZXcgcG9wc3RhdGUgZXZlbnQgb24gdGhlIHdpbmRvdyB3aXRoIGEgbnVsbCBzdGF0ZQoJCQkvLyAgICAgIHNvIHRoYXQgdGhlIG5hdmlnYXRlIGV2ZW50cyBjYW4gY29uY2x1ZGUgdGhlaXIgd29yayBwcm9wZXJseQoJCQkvLwoJCQkvLyBpZiB0aGUgdXJsIGlzIGEgcGF0aCB3ZSB3YW50IHRvIHByZXNlcnZlIHRoZSBxdWVyeSBwYXJhbXMgdGhhdCBhcmUgYXZhaWxhYmxlIG9uCgkJCS8vIHRoZSBjdXJyZW50IHVybC4KCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gdHJ1ZTsKCQkJd2luZG93LmxvY2F0aW9uLmhhc2ggPSBoYXNoOwoKCQkJLy8gSWYgcG9wc3RhdGUgaXMgZW5hYmxlZCBhbmQgdGhlIGJyb3dzZXIgdHJpZ2dlcnMgYHBvcHN0YXRlYCBldmVudHMgd2hlbiB0aGUgaGFzaAoJCQkvLyBpcyBzZXQgKHRoaXMgb2Z0ZW4gaGFwcGVucyBpbW1lZGlhdGVseSBpbiBicm93c2VycyBsaWtlIENocm9tZSksIHRoZW4gdGhlCgkJCS8vIHRoaXMgZmxhZyB3aWxsIGJlIHNldCB0byBmYWxzZSBhbHJlYWR5LiBJZiBpdCdzIGEgYnJvd3NlciB0aGF0IGRvZXMgbm90IHRyaWdnZXIKCQkJLy8gYSBgcG9wc3RhdGVgIG9uIGhhc2ggYXNzaWduZW1lbnQgb3IgYHJlcGxhY2VTdGF0ZWAgdGhlbiB3ZSBuZWVkIGF2b2lkIHRoZSBicmFuY2gKCQkJLy8gdGhhdCBzd2FsbG93cyB0aGUgZXZlbnQgY3JlYXRlZCBieSB0aGUgcG9wc3RhdGUgZ2VuZXJhdGVkIGJ5IHRoZSBoYXNoIGFzc2lnbm1lbnQKCQkJLy8gQXQgdGhlIHRpbWUgb2YgdGhpcyB3cml0aW5nIHRoaXMgaGFwcGVucyB3aXRoIE9wZXJhIDEyIGFuZCBzb21lIHZlcnNpb24gb2YgSUUKCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gZmFsc2U7CgoJCQlzdGF0ZSA9ICQuZXh0ZW5kKHsKCQkJCXVybDogaHJlZiwKCQkJCWhhc2g6IGhhc2gsCgkJCQl0aXRsZTogZG9jdW1lbnQudGl0bGUKCQkJfSwgZGF0YSk7CgoJCQlpZiAoIGlzUG9wU3RhdGVFdmVudCApIHsKCQkJCXBvcHN0YXRlRXZlbnQgPSBuZXcgJC5FdmVudCggInBvcHN0YXRlIiApOwoJCQkJcG9wc3RhdGVFdmVudC5vcmlnaW5hbEV2ZW50ID0gewoJCQkJCXR5cGU6ICJwb3BzdGF0ZSIsCgkJCQkJc3RhdGU6IG51bGwKCQkJCX07CgoJCQkJdGhpcy5zcXVhc2goIHVybCwgc3RhdGUgKTsKCgkJCQkvLyBUcmlnZ2VyIGEgbmV3IGZhdXggcG9wc3RhdGUgZXZlbnQgdG8gcmVwbGFjZSB0aGUgb25lIHRoYXQgd2UKCQkJCS8vIGNhdWdodCB0aGF0IHdhcyB0cmlnZ2VyZWQgYnkgdGhlIGhhc2ggc2V0dGluZyBhYm92ZS4KCQkJCWlmICggIW5vRXZlbnRzICkgewoJCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSB0cnVlOwoJCQkJCSQubW9iaWxlLndpbmRvdy50cmlnZ2VyKCBwb3BzdGF0ZUV2ZW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIHJlY29yZCB0aGUgaGlzdG9yeSBlbnRyeSBzbyB0aGF0IHRoZSBpbmZvcm1hdGlvbiBjYW4gYmUgaW5jbHVkZWQKCQkJLy8gaW4gaGFzaGNoYW5nZSBldmVudCBkcml2ZW4gbmF2aWdhdGUgZXZlbnRzIGluIGEgc2ltaWxhciBmYXNoaW9uIHRvCgkJCS8vIHRoZSBzdGF0ZSB0aGF0J3MgcHJvdmlkZWQgYnkgcG9wc3RhdGUKCQkJdGhpcy5oaXN0b3J5LmFkZCggc3RhdGUudXJsLCBzdGF0ZSApOwoJCX0sCgoJCS8vIFRoaXMgYmluZGluZyBpcyBpbnRlbmRlZCB0byBjYXRjaCB0aGUgcG9wc3RhdGUgZXZlbnRzIHRoYXQgYXJlIGZpcmVkCgkJLy8gd2hlbiBleGVjdXRpb24gb2YgdGhlIGAkLm5hdmlnYXRlYCBtZXRob2Qgc3RvcHMgYXQgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7CgkJLy8gYW5kIGNvbXBsZXRlbHkgcHJldmVudCB0aGVtIGZyb20gcHJvcGFnYXRpbmcuIFRoZSBwb3BzdGF0ZSBldmVudCB3aWxsIHRoZW4gYmUKCQkvLyByZXRyaWdnZXJlZCBhZnRlciBleGVjdXRpb24gcmVzdW1lcwoJCS8vCgkJLy8gVE9ETyBncmFiIHRoZSBvcmlnaW5hbCBldmVudCBoZXJlIGFuZCB1c2UgaXQgZm9yIHRoZSBzeW50aGV0aWMgZXZlbnQgaW4gdGhlCgkJLy8gICAgICBzZWNvbmQgaGFsZiBvZiB0aGUgbmF2aWdhdGUgZXhlY3V0aW9uIHRoYXQgd2lsbCBmb2xsb3cgdGhpcyBiaW5kaW5nCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGhhc2gsIHN0YXRlOwoKCQkJLy8gUGFydGx5IHRvIHN1cHBvcnQgb3VyIHRlc3Qgc3VpdGUgd2hpY2ggbWFudWFsbHkgYWx0ZXJzIHRoZSBzdXBwb3J0CgkJCS8vIHZhbHVlIHRvIHRlc3QgaGFzaGNoYW5nZS4gUGFydGx5IHRvIHByZXZlbnQgYWxsIGFyb3VuZCB3ZWlyZG5lc3MKCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYnkgdGhlIGFjdHVhbCBhbHRlcmF0aW9uIG9mIHRoZSBoYXNoCgkJCS8vIHByZXZlbnQgaXQgY29tcGxldGVseS4gSGlzdG9yeSBpcyB0cmFja2VkIG1hbnVhbGx5CgkJCWlmICggdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlICkgewoJCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gaWYgdGhpcyBpcyB0aGUgcG9wc3RhdGUgdHJpZ2dlcmVkIGFmdGVyIHRoZSBgcmVwbGFjZVN0YXRlYCBjYWxsIGluIHRoZSBnbwoJCQkvLyBtZXRob2QsIHRoZW4gc2ltcGx5IGlnbm9yZSBpdC4gVGhlIGhpc3RvcnkgZW50cnkgaGFzIGFscmVhZHkgYmVlbiBjYXB0dXJlZAoJCQlpZiAoIHRoaXMuaWdub3JlUG9wU3RhdGUgKSB7CgkJCQl0aGlzLmlnbm9yZVBvcFN0YXRlID0gZmFsc2U7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoZXJlIGlzIG5vIHN0YXRlLCBhbmQgdGhlIGhpc3Rvcnkgc3RhY2sgbGVuZ3RoIGlzIG9uZSB3ZXJlCgkJCS8vIHByb2JhYmx5IGdldHRpbmcgdGhlIHBhZ2UgbG9hZCBwb3BzdGF0ZSBmaXJlZCBieSBicm93c2VycyBsaWtlIGNocm9tZQoJCQkvLyBhdm9pZCBpdCBhbmQgc2V0IHRoZSBvbmUgdGltZSBmbGFnIHRvIGZhbHNlLgoJCQkvLyBUT0RPOiBEbyB3ZSByZWFsbHkgbmVlZCBhbGwgdGhlc2UgY29uZGl0aW9ucz8gQ29tcGFyaW5nIGxvY2F0aW9uIGhyZWZzCgkJCS8vIHNob3VsZCBiZSBzdWZmaWNpZW50LgoJCQlpZiAoICFldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlICYmCgkJCQl0aGlzLmhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAxICYmCgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlICkgewoJCQkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSA9IGZhbHNlOwoKCQkJCWlmICggbG9jYXRpb24uaHJlZiA9PT0gaW5pdGlhbEhyZWYgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIGFjY291bnQgZm9yIGRpcmVjdCBtYW5pcHVsYXRpb24gb2YgdGhlIGhhc2guIFRoYXQgaXMsIHdlIHdpbGwgcmVjZWl2ZSBhIHBvcHN0YXRlCgkJCS8vIHdoZW4gdGhlIGhhc2ggaXMgY2hhbmdlZCBieSBhc3NpZ25tZW50LCBhbmQgaXQgd29uJ3QgaGF2ZSBhIHN0YXRlIGFzc29jaWF0ZWQuIFdlCgkJCS8vIHRoZW4gbmVlZCB0byBzcXVhc2ggdGhlIGhhc2guIFNlZSBiZWxvdyBmb3IgaGFuZGxpbmcgb2YgaGFzaCBhc3NpZ25tZW50IHRoYXQKCQkJLy8gbWF0Y2hlcyBhbiBleGlzdGluZyBoaXN0b3J5IGVudHJ5CgkJCS8vIFRPRE8gaXQgbWlnaHQgYmUgYmV0dGVyIHRvIG9ubHkgYWRkIHRvIHRoZSBoaXN0b3J5IHN0YWNrCgkJCS8vICAgICAgd2hlbiB0aGUgaGFzaCBpcyBhZGphY2VudCB0byB0aGUgYWN0aXZlIGhpc3RvcnkgZW50cnkKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCWlmICggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYgaGFzaCApIHsKCQkJCS8vIHNxdWFzaCB0aGUgaGFzaCB0aGF0J3MgYmVlbiBhc3NpZ25lZCBvbiB0aGUgVVJMIHdpdGggcmVwbGFjZVN0YXRlCgkJCQkvLyBhbHNvIGdyYWIgdGhlIHJlc3VsdGluZyBzdGF0ZSBvYmplY3QgZm9yIHN0b3JhZ2UKCQkJCXN0YXRlID0gdGhpcy5zcXVhc2goIGhhc2ggKTsKCgkJCQkvLyByZWNvcmQgdGhlIG5ldyBoYXNoIGFzIGFuIGFkZGl0aW9uYWwgaGlzdG9yeSBlbnRyeQoJCQkJLy8gdG8gbWF0Y2ggdGhlIGJyb3dzZXIncyB0cmVhdG1lbnQgb2YgaGFzaCBhc3NpZ25tZW50CgkJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgoJCQkJLy8gcGFzcyB0aGUgbmV3bHkgY3JlYXRlZCBzdGF0ZSBpbmZvcm1hdGlvbgoJCQkJLy8gYWxvbmcgd2l0aCB0aGUgZXZlbnQKCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZSA9IHN0YXRlOwoKCQkJCS8vIGRvIG5vdCBhbHRlciBoaXN0b3J5LCB3ZSd2ZSBhZGRlZCBhIG5ldyBoaXN0b3J5IGVudHJ5CgkJCQkvLyBzbyB3ZSBrbm93IHdoZXJlIHdlIGFyZQoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiBhbGwgZWxzZSBmYWlscyB0aGlzIGlzIGEgcG9wc3RhdGUgdGhhdCBjb21lcyBmcm9tIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9ucwoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseSwgYW5kIHJlY29yZCB0aGUgZGlyZWN0aW9uYWxpdHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IChldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlIHx8IHt9KS51cmwgfHwgaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGlzdG9yeVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0KCQkJfSk7CgkJfSwKCgkJLy8gTk9URSBtdXN0IGJpbmQgYmVmb3JlIGBuYXZpZ2F0ZWAgc3BlY2lhbCBldmVudCBoYXNoY2hhbmdlIGJpbmRpbmcgb3RoZXJ3aXNlIHRoZQoJCS8vICAgICAgbmF2aWdhdGlvbiBkYXRhIHdvbid0IGJlIGF0dGFjaGVkIHRvIHRoZSBoYXNoY2hhbmdlIGV2ZW50IGluIHRpbWUgZm9yIHRob3NlCgkJLy8gICAgICBiaW5kaW5ncyB0byBhdHRhY2ggaXQgdG8gdGhlIGBuYXZpZ2F0ZWAgc3BlY2lhbCBldmVudAoJCS8vIFRPRE8gYWRkIGEgY2hlY2sgaGVyZSB0aGF0IGBoYXNoY2hhbmdlLm5hdmlnYXRlYCBpcyBib3VuZCBhbHJlYWR5IG90aGVyd2lzZSBpdCdzCgkJLy8gICAgICBicm9rZW4gKGV4Y2VwdGlvbj8pCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgaGlzdG9yeSwgaGFzaDsKCgkJCS8vIElmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGV4cGxpY2l0bHkgZGlzYWJsZWQgb3IgcHVzaHN0YXRlIGlzIHN1cHBvcnRlZAoJCQkvLyBhdm9pZCBtYWtpbmcgdXNlIG9mIHRoZSBoYXNoY2hhbmdlIGhhbmRsZXIuCgkJCWlmICghJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzSGFzaENoYW5nZUVuYWJsZWQoKSB8fAoJCQkJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBPbiBvY2Nhc2lvbiBleHBsaWNpdGx5IHdhbnQgdG8gcHJldmVudCB0aGUgbmV4dCBoYXNoIGZyb20gcHJvcG9nYXRpbmcgYmVjYXVzZSB3ZSBvbmx5CgkJCS8vIHdpdGggdG8gYWx0ZXIgdGhlIHVybCB0byByZXByZXNlbnQgdGhlIG5ldyBzdGF0ZSBkbyBzbyBoZXJlCgkJCWlmICggdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSA9IGZhbHNlOwoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWhpc3RvcnkgPSB0aGlzLmhpc3Rvcnk7CgkJCWhhc2ggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoKCQkJLy8gSWYgdGhpcyBpcyBhIGhhc2hjaGFuZ2UgY2F1c2VkIGJ5IHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5CgkJCXRoaXMuaGlzdG9yeS5kaXJlY3QoewoJCQkJdXJsOiBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oYXNoY2hhbmdlU3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oYXNoY2hhbmdlU3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfSwKCgkJCQkvLyBXaGVuIHdlIGRvbid0IGZpbmQgYSBoYXNoIGluIG91ciBoaXN0b3J5IGNsZWFybHkgd2UncmUgYWltaW5nIHRvIGdvIHRoZXJlCgkJCQkvLyByZWNvcmQgdGhlIGVudHJ5IGFzIG5ldyBmb3IgZnV0dXJlIHRyYXZlcnNhbAoJCQkJLy8KCQkJCS8vIE5PVEUgaXQncyBub3QgZW50aXJlbHkgY2xlYXIgdGhhdCB0aGlzIGlzIHRoZSByaWdodCB0aGluZyB0byBkbyBnaXZlbiB0aGF0IHdlCgkJCQkvLyAgICAgIGNhbid0IGtub3cgdGhlIHVzZXJzIGludGVudGlvbi4gSXQgbWlnaHQgYmUgYmV0dGVyIHRvIGV4cGxpY2l0bHkgX25vdF8KCQkJCS8vICAgICAgc3VwcG9ydCBsb2NhdGlvbi5oYXNoIGFzc2lnbm1lbnQgaW4gcHJlZmVyZW5jZSB0byAkLm5hdmlnYXRlIGNhbGxzCgkJCQkvLyBUT0RPIGZpcnN0IGFyZyB0byBhZGQgc2hvdWxkIGJlIHRoZSBocmVmLCBidXQgaXQgY2F1c2VzIGlzc3VlcyBpbiBpZGVudGlmeWluZwoJCQkJLy8gICAgICBlbWJlZGVkIHBhZ2VzCgkJCQltaXNzaW5nOiBmdW5jdGlvbigpIHsKCQkJCQloaXN0b3J5LmFkZCggaGFzaCwgewoJCQkJCQloYXNoOiBoYXNoLAoJCQkJCQl0aXRsZTogZG9jdW1lbnQudGl0bGUKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkvLyBUT0RPIGNvbnNpZGVyIHF1ZXVlaW5nIG5hdmlnYXRpb24gYWN0aXZpdHkgdW50aWwgcHJldmlvdXMgYWN0aXZpdGllcyBoYXZlIGNvbXBsZXRlZAoJLy8gICAgICBzbyB0aGF0IGVuZCB1c2VycyBkb24ndCBoYXZlIHRvIHRoaW5rIGFib3V0IGl0LiBQdW50aW5nIGZvciBub3cKCS8vIFRPRE8gISEgbW92ZSB0aGUgZXZlbnQgYmluZGluZ3MgaW50byBjYWxsYmFja3Mgb24gdGhlIG5hdmlnYXRlIGV2ZW50CgkkLm1vYmlsZS5uYXZpZ2F0ZSA9IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvci5nbyggdXJsLCBkYXRhLCBub0V2ZW50cyApOwoJfTsKCgkvLyBleHBvc2UgdGhlIGhpc3Rvcnkgb24gdGhlIG5hdmlnYXRlIG1ldGhvZCBpbiBhbnRpY2lwYXRpb24gb2YgZnVsbCBpbnRlZ3JhdGlvbiB3aXRoCgkvLyBleGlzdGluZyBuYXZpZ2F0aW9uIGZ1bmN0aW9uYWx0eSB0aGF0IGlzIHRpZ2h0bHkgY291cGxlZCB0byB0aGUgaGlzdG9yeSBpbmZvcm1hdGlvbgoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSA9IG5ldyAkLm1vYmlsZS5IaXN0b3J5KCk7CgoJLy8gaW5zdGFudGlhdGUgYW4gaW5zdGFuY2Ugb2YgdGhlIG5hdmlnYXRvciBmb3IgdXNlIHdpdGhpbiB0aGUgJC5uYXZpZ2F0ZSBtZXRob2QKCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvciA9IG5ldyAkLm1vYmlsZS5OYXZpZ2F0b3IoICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgKTsKCgl2YXIgbG9jID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCk7CgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFkZCggbG9jLmhyZWYsIHtoYXNoOiBsb2MuaGFzaH0gKTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHByb3BzID0gewoJCQkiYW5pbWF0aW9uIjoge30sCgkJCSJ0cmFuc2l0aW9uIjoge30KCQl9LAoJCXRlc3RFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJdmVuZG9yUHJlZml4ZXMgPSBbICIiLCAid2Via2l0LSIsICJtb3otIiwgIm8tIiBdOwoKCSQuZWFjaCggWyAiYW5pbWF0aW9uIiwgInRyYW5zaXRpb24iIF0sIGZ1bmN0aW9uKCBpLCB0ZXN0ICkgewoKCQkvLyBHZXQgY29ycmVjdCBuYW1lIGZvciB0ZXN0CgkJdmFyIHRlc3ROYW1lID0gKCBpID09PSAwICkgPyB0ZXN0ICsgIi0iICsgIm5hbWUiIDogdGVzdDsKCgkJJC5lYWNoKCB2ZW5kb3JQcmVmaXhlcywgZnVuY3Rpb24oIGosIHByZWZpeCApIHsKCQkJaWYgKCB0ZXN0RWxlbWVudC5zdHlsZVsgJC5jYW1lbENhc2UoIHByZWZpeCArIHRlc3ROYW1lICkgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJIHByb3BzWyB0ZXN0IF1bICJwcmVmaXgiIF0gPSBwcmVmaXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9KTsKCgkJLy8gU2V0IGV2ZW50IGFuZCBkdXJhdGlvbiBuYW1lcyBmb3IgbGF0ZXIgdXNlCgkJcHJvcHNbIHRlc3QgXVsgImR1cmF0aW9uIiBdID0KCQkJJC5jYW1lbENhc2UoIHByb3BzWyB0ZXN0IF1bICJwcmVmaXgiIF0gKyB0ZXN0ICsgIi0iICsgImR1cmF0aW9uIiApOwoJCXByb3BzWyB0ZXN0IF1bICJldmVudCIgXSA9CgkJCSQuY2FtZWxDYXNlKCBwcm9wc1sgdGVzdCBdWyAicHJlZml4IiBdICsgdGVzdCArICItIiArICJlbmQiICk7CgoJCS8vIEFsbCBsb3dlciBjYXNlIGlmIG5vdCBhIHZlbmRvciBwcm9wCgkJaWYgKCBwcm9wc1sgdGVzdCBdWyAicHJlZml4IiBdID09PSAiIiApIHsKCQkJcHJvcHNbIHRlc3QgXVsgImV2ZW50IiBdID0gcHJvcHNbIHRlc3QgXVsgImV2ZW50IiBdLnRvTG93ZXJDYXNlKCk7CgkJfQoJfSk7CgoJLy8gSWYgYSB2YWxpZCBwcmVmaXggd2FzIGZvdW5kIHRoZW4gdGhlIGl0IGlzIHN1cHBvcnRlZCBieSB0aGUgYnJvd3NlcgoJJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zID0gKCBwcm9wc1sgInRyYW5zaXRpb24iIF1bICJwcmVmaXgiIF0gIT09IHVuZGVmaW5lZCApOwoJJC5zdXBwb3J0LmNzc0FuaW1hdGlvbnMgPSAoIHByb3BzWyAiYW5pbWF0aW9uIiBdWyAicHJlZml4IiBdICE9PSB1bmRlZmluZWQgKTsKCgkvLyBSZW1vdmUgdGhlIHRlc3RFbGVtZW50CgkkKCB0ZXN0RWxlbWVudCApLnJlbW92ZSgpOwoKCS8vIEFuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjaywgdHlwZSwgZmFsbGJhY2tUaW1lICkgewoJCXZhciB0aW1lciwgZHVyYXRpb24sCgkJCXRoYXQgPSB0aGlzLAoJCQlhbmltYXRpb25UeXBlID0gKCAhdHlwZSB8fCB0eXBlID09PSAiYW5pbWF0aW9uIiApID8gImFuaW1hdGlvbiIgOiAidHJhbnNpdGlvbiI7CgoJCS8vIE1ha2Ugc3VyZSBzZWxlY3RlZCB0eXBlIGlzIHN1cHBvcnRlZCBieSBicm93c2VyCgkJaWYgKCAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyAmJiBhbmltYXRpb25UeXBlID09PSAidHJhbnNpdGlvbiIgKSB8fAoJCQkoICQuc3VwcG9ydC5jc3NBbmltYXRpb25zICYmIGFuaW1hdGlvblR5cGUgPT09ICJhbmltYXRpb24iICkgKSB7CgoJCQkvLyBJZiBhIGZhbGxiYWNrIHRpbWUgd2FzIG5vdCBwYXNzZWQgc2V0IG9uZQoJCQlpZiAoIGZhbGxiYWNrVGltZSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCS8vIE1ha2Ugc3VyZSB0aGUgd2FzIG5vdCBib3VuZCB0byBkb2N1bWVudCBiZWZvcmUgY2hlY2tpbmcgLmNzcwoJCQkJaWYgKCAkKCB0aGlzICkuY29udGV4dCAhPT0gZG9jdW1lbnQgKSB7CgoJCQkJCS8vIFBhcnNlIHRoZSBkdXJyYXRpb24gc2luY2UgaXRzIGluIHNlY29uZCBtdWx0aXBsZSBieSAxMDAwIGZvciBtaWxsaXNlY29uZHMKCQkJCQkvLyBNdWx0aXBseSBieSAzIHRvIG1ha2Ugc3VyZSB3ZSBnaXZlIHRoZSBhbmltYXRpb24gcGxlbnR5IG9mIHRpbWUuCgkJCQkJZHVyYXRpb24gPSBwYXJzZUZsb2F0KAoJCQkJCQkkKCB0aGlzICkuY3NzKCBwcm9wc1sgYW5pbWF0aW9uVHlwZSBdLmR1cmF0aW9uICkKCQkJCQkpICogMzAwMDsKCQkJCX0KCgkJCQkvLyBJZiB3ZSBjb3VsZCBub3QgcmVhZCBhIGR1cmF0aW9uIHVzZSB0aGUgZGVmYXVsdAoJCQkJaWYgKCBkdXJhdGlvbiA9PT0gMCB8fCBkdXJhdGlvbiA9PT0gdW5kZWZpbmVkIHx8IGlzTmFOKCBkdXJhdGlvbiApICkgewoJCQkJCWR1cmF0aW9uID0gJC5mbi5hbmltYXRpb25Db21wbGV0ZS5kZWZhdWx0RHVyYXRpb247CgkJCQl9CgkJCX0KCgkJCS8vIFNldHMgdXAgdGhlIGZhbGxiYWNrIGlmIGV2ZW50IG5ldmVyIGNvbWVzCgkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGF0ICkub2ZmKCBwcm9wc1sgYW5pbWF0aW9uVHlwZSBdLmV2ZW50ICk7CgkJCQljYWxsYmFjay5hcHBseSggdGhhdCApOwoJCQl9LCBkdXJhdGlvbiApOwoKCQkJLy8gQmluZCB0aGUgZXZlbnQKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoIHByb3BzWyBhbmltYXRpb25UeXBlIF0uZXZlbnQsIGZ1bmN0aW9uKCkgewoKCQkJCS8vIENsZWFyIHRoZSB0aW1lciBzbyB3ZSBkb250IGNhbGwgY2FsbGJhY2sgdHdpY2UKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCWNhbGxiYWNrLmNhbGwoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9KTsKCQl9IGVsc2UgewoKCQkJLy8gQ1NTIGFuaW1hdGlvbiAvIHRyYW5zaXRpb25zIG5vdCBzdXBwb3J0ZWQKCQkJLy8gRGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoICQucHJveHkoIGNhbGxiYWNrLCB0aGlzICksIDAgKTsKCQkJcmV0dXJuICQoIHRoaXMgKTsKCQl9Cgl9OwoKCS8vIEFsbG93IGRlZmF1bHQgY2FsbGJhY2sgdG8gYmUgY29uZmlndXJlZCBvbiBtb2JpbGVJbml0CgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlLmRlZmF1bHREdXJhdGlvbiA9IDEwMDA7Cn0pKCBqUXVlcnkgKTsKCi8vIFRoaXMgcGx1Z2luIGlzIGFuIGV4cGVyaW1lbnQgZm9yIGFic3RyYWN0aW5nIGF3YXkgdGhlIHRvdWNoIGFuZCBtb3VzZQovLyBldmVudHMgc28gdGhhdCBkZXZlbG9wZXJzIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgd2hpY2ggbWV0aG9kIG9mIGlucHV0Ci8vIHRoZSBkZXZpY2UgdGhlaXIgZG9jdW1lbnQgaXMgbG9hZGVkIG9uIHN1cHBvcnRzLgovLwovLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGFsbG93IHRoZSBkZXZlbG9wZXIgdG8gcmVnaXN0ZXIgbGlzdGVuZXJzIGZvciB0aGUKLy8gYmFzaWMgbW91c2UgZXZlbnRzLCBzdWNoIGFzIG1vdXNlZG93biwgbW91c2Vtb3ZlLCBtb3VzZXVwLCBhbmQgY2xpY2ssCi8vIGFuZCB0aGUgcGx1Z2luIHdpbGwgdGFrZSBjYXJlIG9mIHJlZ2lzdGVyaW5nIHRoZSBjb3JyZWN0IGxpc3RlbmVycwovLyBiZWhpbmQgdGhlIHNjZW5lcyB0byBpbnZva2UgdGhlIGxpc3RlbmVyIGF0IHRoZSBmYXN0ZXN0IHBvc3NpYmxlIHRpbWUKLy8gZm9yIHRoYXQgZGV2aWNlLCB3aGlsZSBzdGlsbCByZXRhaW5pbmcgdGhlIG9yZGVyIG9mIGV2ZW50IGZpcmluZyBpbgovLyB0aGUgdHJhZGl0aW9uYWwgbW91c2UgZW52aXJvbm1lbnQsIHNob3VsZCBtdWx0aXBsZSBoYW5kbGVycyBiZSByZWdpc3RlcmVkCi8vIG9uIHRoZSBzYW1lIGVsZW1lbnQgZm9yIGRpZmZlcmVudCBldmVudHMuCi8vCi8vIFRoZSBjdXJyZW50IHZlcnNpb24gZXhwb3NlcyB0aGUgZm9sbG93aW5nIHZpcnR1YWwgZXZlbnRzIHRvIGpRdWVyeSBiaW5kIG1ldGhvZHM6Ci8vICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIKCihmdW5jdGlvbiggJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewoKdmFyIGRhdGFQcm9wZXJ0eU5hbWUgPSAidmlydHVhbE1vdXNlQmluZGluZ3MiLAoJdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgPSAidmlydHVhbFRvdWNoSUQiLAoJdmlydHVhbEV2ZW50TmFtZXMgPSAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiLnNwbGl0KCAiICIgKSwKCXRvdWNoRXZlbnRQcm9wcyA9ICJjbGllbnRYIGNsaWVudFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIi5zcGxpdCggIiAiICksCgltb3VzZUhvb2tQcm9wcyA9ICQuZXZlbnQubW91c2VIb29rcyA/ICQuZXZlbnQubW91c2VIb29rcy5wcm9wcyA6IFtdLAoJbW91c2VFdmVudFByb3BzID0gJC5ldmVudC5wcm9wcy5jb25jYXQoIG1vdXNlSG9va1Byb3BzICksCglhY3RpdmVEb2NIYW5kbGVycyA9IHt9LAoJcmVzZXRUaW1lcklEID0gMCwKCXN0YXJ0WCA9IDAsCglzdGFydFkgPSAwLAoJZGlkU2Nyb2xsID0gZmFsc2UsCgljbGlja0Jsb2NrTGlzdCA9IFtdLAoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2UsCglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZSwKCWV2ZW50Q2FwdHVyZVN1cHBvcnRlZCA9ICJhZGRFdmVudExpc3RlbmVyIiBpbiBkb2N1bWVudCwKCSRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgluZXh0VG91Y2hJRCA9IDEsCglsYXN0VG91Y2hJRCA9IDAsIHRocmVzaG9sZCwKCWk7CgokLnZtb3VzZSA9IHsKCW1vdmVEaXN0YW5jZVRocmVzaG9sZDogMTAsCgljbGlja0Rpc3RhbmNlVGhyZXNob2xkOiAxMCwKCXJlc2V0VGltZXJEdXJhdGlvbjogMTUwMAp9OwoKZnVuY3Rpb24gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkgewoKCXdoaWxlICggZXZlbnQgJiYgdHlwZW9mIGV2ZW50Lm9yaWdpbmFsRXZlbnQgIT09ICJ1bmRlZmluZWQiICkgewoJCWV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCX0KCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICkgewoKCXZhciB0ID0gZXZlbnQudHlwZSwKCQlvZSwgcHJvcHMsIG5lLCBwcm9wLCBjdCwgdG91Y2gsIGksIGosIGxlbjsKCglldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CglldmVudC50eXBlID0gZXZlbnRUeXBlOwoKCW9lID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCXByb3BzID0gJC5ldmVudC5wcm9wczsKCgkvLyBhZGRyZXNzZXMgc2VwYXJhdGlvbiBvZiAkLmV2ZW50LnByb3BzIGluIHRvICQuZXZlbnQubW91c2VIb29rLnByb3BzIGFuZCBJc3N1ZSAzMjgwCgkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzMyODAKCWlmICggdC5zZWFyY2goIC9eKG1vdXNlfGNsaWNrKS8gKSA+IC0xICkgewoJCXByb3BzID0gbW91c2VFdmVudFByb3BzOwoJfQoKCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJaWYgKCBvZSApIHsKCQlmb3IgKCBpID0gcHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJcHJvcCA9IHByb3BzWyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9lWyBwcm9wIF07CgkJfQoJfQoKCS8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBtb3VzZSBhbmQgY2xpY2sgdmlydHVhbCBldmVudHMgYXJlIGdlbmVyYXRlZAoJLy8gd2l0aG91dCBhIC53aGljaCBvbmUgaXMgZGVmaW5lZAoJaWYgKCB0LnNlYXJjaCgvbW91c2UoZG93bnx1cCl8Y2xpY2svKSA+IC0xICYmICFldmVudC53aGljaCApIHsKCQlldmVudC53aGljaCA9IDE7Cgl9CgoJaWYgKCB0LnNlYXJjaCgvXnRvdWNoLykgIT09IC0xICkgewoJCW5lID0gZ2V0TmF0aXZlRXZlbnQoIG9lICk7CgkJdCA9IG5lLnRvdWNoZXM7CgkJY3QgPSBuZS5jaGFuZ2VkVG91Y2hlczsKCQl0b3VjaCA9ICggdCAmJiB0Lmxlbmd0aCApID8gdFswXSA6ICggKCBjdCAmJiBjdC5sZW5ndGggKSA/IGN0WyAwIF0gOiB1bmRlZmluZWQgKTsKCgkJaWYgKCB0b3VjaCApIHsKCQkJZm9yICggaiA9IDAsIGxlbiA9IHRvdWNoRXZlbnRQcm9wcy5sZW5ndGg7IGogPCBsZW47IGorKykgewoJCQkJcHJvcCA9IHRvdWNoRXZlbnRQcm9wc1sgaiBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IHRvdWNoWyBwcm9wIF07CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBlbGVtZW50ICkgewoKCXZhciBmbGFncyA9IHt9LAoJCWIsIGs7CgoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWZvciAoICBrIGluIGIgKSB7CgkJCWlmICggYlsgayBdICkgewoJCQkJZmxhZ3NbIGsgXSA9IGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nID0gdHJ1ZTsKCQkJfQoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIGZsYWdzOwp9CgpmdW5jdGlvbiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZWxlbWVudCwgZXZlbnRUeXBlICkgewoJdmFyIGI7Cgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJaWYgKCBiICYmICggIWV2ZW50VHlwZSB8fCBiWyBldmVudFR5cGUgXSApICkgewoJCQlyZXR1cm4gZWxlbWVudDsKCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBudWxsOwp9CgpmdW5jdGlvbiBlbmFibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGRpc2FibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gdHJ1ZTsKfQoKZnVuY3Rpb24gZW5hYmxlTW91c2VCaW5kaW5ncygpIHsKCWxhc3RUb3VjaElEID0gMDsKCWNsaWNrQmxvY2tMaXN0Lmxlbmd0aCA9IDA7CglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZTsKCgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBlbmFibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBkaXNhYmxlZC4KCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIGRpc2FibGVNb3VzZUJpbmRpbmdzKCkgewoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZGlzYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGVuYWJsZWQuCgllbmFibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIHN0YXJ0UmVzZXRUaW1lcigpIHsKCWNsZWFyUmVzZXRUaW1lcigpOwoJcmVzZXRUaW1lcklEID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJcmVzZXRUaW1lcklEID0gMDsKCQllbmFibGVNb3VzZUJpbmRpbmdzKCk7Cgl9LCAkLnZtb3VzZS5yZXNldFRpbWVyRHVyYXRpb24gKTsKfQoKZnVuY3Rpb24gY2xlYXJSZXNldFRpbWVyKCkgewoJaWYgKCByZXNldFRpbWVySUQgKSB7CgkJY2xlYXJUaW1lb3V0KCByZXNldFRpbWVySUQgKTsKCQlyZXNldFRpbWVySUQgPSAwOwoJfQp9CgpmdW5jdGlvbiB0cmlnZ2VyVmlydHVhbEV2ZW50KCBldmVudFR5cGUsIGV2ZW50LCBmbGFncyApIHsKCXZhciB2ZTsKCglpZiAoICggZmxhZ3MgJiYgZmxhZ3NbIGV2ZW50VHlwZSBdICkgfHwKCQkJCSggIWZsYWdzICYmIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBldmVudC50YXJnZXQsIGV2ZW50VHlwZSApICkgKSB7CgoJCXZlID0gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICk7CgoJCSQoIGV2ZW50LnRhcmdldCkudHJpZ2dlciggdmUgKTsKCX0KCglyZXR1cm4gdmU7Cn0KCmZ1bmN0aW9uIG1vdXNlRXZlbnRDYWxsYmFjayggZXZlbnQgKSB7Cgl2YXIgdG91Y2hJRCA9ICQuZGF0YSggZXZlbnQudGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApLAoJCXZlOwoKCWlmICggIWJsb2NrTW91c2VUcmlnZ2VycyAmJiAoICFsYXN0VG91Y2hJRCB8fCBsYXN0VG91Y2hJRCAhPT0gdG91Y2hJRCApICkgewoJCXZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInYiICsgZXZlbnQudHlwZSwgZXZlbnQgKTsKCQlpZiAoIHZlICkgewoJCQlpZiAoIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCQlpZiAoIHZlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCQlpZiAoIHZlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJdmFyIHRvdWNoZXMgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzLAoJCXRhcmdldCwgZmxhZ3MsIHQ7CgoJaWYgKCB0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoID09PSAxICkgewoKCQl0YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCB0YXJnZXQgKTsKCgkJaWYgKCBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyApIHsKCgkJCWxhc3RUb3VjaElEID0gbmV4dFRvdWNoSUQrKzsKCQkJJC5kYXRhKCB0YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lLCBsYXN0VG91Y2hJRCApOwoKCQkJY2xlYXJSZXNldFRpbWVyKCk7CgoJCQlkaXNhYmxlTW91c2VCaW5kaW5ncygpOwoJCQlkaWRTY3JvbGwgPSBmYWxzZTsKCgkJCXQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF07CgkJCXN0YXJ0WCA9IHQucGFnZVg7CgkJCXN0YXJ0WSA9IHQucGFnZVk7CgoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3ZlciIsIGV2ZW50LCBmbGFncyApOwoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlZG93biIsIGV2ZW50LCBmbGFncyApOwoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlU2Nyb2xsKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSApOwoJfQoKCWRpZFNjcm9sbCA9IHRydWU7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCgl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXSwKCQlkaWRDYW5jZWwgPSBkaWRTY3JvbGwsCgkJbW92ZVRocmVzaG9sZCA9ICQudm1vdXNlLm1vdmVEaXN0YW5jZVRocmVzaG9sZCwKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApOwoKCQlkaWRTY3JvbGwgPSBkaWRTY3JvbGwgfHwKCQkJKCBNYXRoLmFicyggdC5wYWdlWCAtIHN0YXJ0WCApID4gbW92ZVRocmVzaG9sZCB8fAoJCQkJTWF0aC5hYnMoIHQucGFnZVkgLSBzdGFydFkgKSA+IG1vdmVUaHJlc2hvbGQgKTsKCglpZiAoIGRpZFNjcm9sbCAmJiAhZGlkQ2FuY2VsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZmxhZ3MgKTsKCX0KCgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlbW92ZSIsIGV2ZW50LCBmbGFncyApOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwoKCXZhciBmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApLAoJCXZlLCB0OwoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZXVwIiwgZXZlbnQsIGZsYWdzICk7CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInZjbGljayIsIGV2ZW50LCBmbGFncyApOwoJCWlmICggdmUgJiYgdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCS8vIFRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyB0aGUgdG91Y2hlbmQKCQkJLy8gZXZlbnQgZG9uJ3QgbmVjZXNzYXJpbHkgbWF0Y2ggdGhlIHRhcmdldCB1c2VkIGR1cmluZyB0aGUKCQkJLy8gdG91Y2guIFRoaXMgbWVhbnMgd2UgbmVlZCB0byByZWx5IG9uIGNvb3JkaW5hdGVzIGZvciBibG9ja2luZwoJCQkvLyBhbnkgY2xpY2sgdGhhdCBpcyBnZW5lcmF0ZWQuCgkJCXQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS5jaGFuZ2VkVG91Y2hlc1sgMCBdOwoJCQljbGlja0Jsb2NrTGlzdC5wdXNoKHsKCQkJCXRvdWNoSUQ6IGxhc3RUb3VjaElELAoJCQkJeDogdC5jbGllbnRYLAoJCQkJeTogdC5jbGllbnRZCgkJCX0pOwoKCQkJLy8gUHJldmVudCBhbnkgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IGZyb20gdHJpZ2dlcmluZwoJCQkvLyB2aXJ0dWFsIGV2ZW50IG5vdGlmaWNhdGlvbnMuCgkJCWJsb2NrTW91c2VUcmlnZ2VycyA9IHRydWU7CgkJfQoJfQoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW91dCIsIGV2ZW50LCBmbGFncyk7CglkaWRTY3JvbGwgPSBmYWxzZTsKCglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFzVmlydHVhbEJpbmRpbmdzKCBlbGUgKSB7Cgl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIGVsZSwgZGF0YVByb3BlcnR5TmFtZSApLAoJCWs7CgoJaWYgKCBiaW5kaW5ncyApIHsKCQlmb3IgKCBrIGluIGJpbmRpbmdzICkgewoJCQlpZiAoIGJpbmRpbmdzWyBrIF0gKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCX0KCXJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gZHVtbXlNb3VzZUhhbmRsZXIoKSB7fQoKZnVuY3Rpb24gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCBldmVudFR5cGUgKSB7Cgl2YXIgcmVhbFR5cGUgPSBldmVudFR5cGUuc3Vic3RyKCAxICk7CgoJcmV0dXJuIHsKCQlzZXR1cDogZnVuY3Rpb24oLyogZGF0YSwgbmFtZXNwYWNlICovKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhpcyBlbGVtZW50LAoJCQkvLyBhZGQgYSBiaW5kaW5ncyBvYmplY3QgdG8gaXRzIGRhdGEuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSwge30gKTsKCQkJfQoKCQkJLy8gSWYgc2V0dXAgaXMgY2FsbGVkLCB3ZSBrbm93IGl0IGlzIHRoZSBmaXJzdCBiaW5kaW5nIGZvciB0aGlzCgkJCS8vIGV2ZW50VHlwZSwgc28gaW5pdGlhbGl6ZSB0aGUgY291bnQgZm9yIHRoZSBldmVudFR5cGUgdG8gemVyby4KCQkJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IHRydWU7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGV2ZW50IGZvciB0aGlzIHR5cGUsCgkJCS8vIHJlZ2lzdGVyIGEgZ2xvYmFsIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gfHwgMCApICsgMTsKCgkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID09PSAxICkgewoJCQkJJGRvY3VtZW50LmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJLy8gU29tZSBicm93c2VycywgbGlrZSBPcGVyYSBNaW5pLCB3b24ndCBkaXNwYXRjaCBtb3VzZS9jbGljayBldmVudHMKCQkJLy8gZm9yIGVsZW1lbnRzIHVubGVzcyB0aGV5IGFjdHVhbGx5IGhhdmUgaGFuZGxlcnMgcmVnaXN0ZXJlZCBvbiB0aGVtLgoJCQkvLyBUbyBnZXQgYXJvdW5kIHRoaXMsIHdlIHJlZ2lzdGVyIGR1bW15IGhhbmRsZXJzIG9uIHRoZSBlbGVtZW50cy4KCgkJCSQoIHRoaXMgKS5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIEZvciBub3csIGlmIGV2ZW50IGNhcHR1cmUgaXMgbm90IHN1cHBvcnRlZCwgd2UgcmVseSBvbiBtb3VzZSBoYW5kbGVycy4KCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoZSBkb2N1bWVudCwKCQkJCS8vIHJlZ2lzdGVyIG91ciB0b3VjaHN0YXJ0IGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJCWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdIHx8IDApICsgMTsKCgkJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9PT0gMSApIHsKCQkJCQkkZG9jdW1lbnQuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCgkJCQkJCS8vIE9uIHRvdWNoIHBsYXRmb3JtcywgdG91Y2hpbmcgdGhlIHNjcmVlbiBhbmQgdGhlbiBkcmFnZ2luZyB5b3VyIGZpbmdlcgoJCQkJCQkvLyBjYXVzZXMgdGhlIHdpbmRvdyBjb250ZW50IHRvIHNjcm9sbCBhZnRlciBzb21lIGRpc3RhbmNlIHRocmVzaG9sZCBpcwoJCQkJCQkvLyBleGNlZWRlZC4gT24gdGhlc2UgcGxhdGZvcm1zLCBhIHNjcm9sbCBwcmV2ZW50cyBhIGNsaWNrIGV2ZW50IGZyb20gYmVpbmcKCQkJCQkJLy8gZGlzcGF0Y2hlZCwgYW5kIG9uIHNvbWUgcGxhdGZvcm1zLCBldmVuIHRoZSB0b3VjaGVuZCBpcyBzdXBwcmVzc2VkLiBUbwoJCQkJCQkvLyBtaW1pYyB0aGUgc3VwcHJlc3Npb24gb2YgdGhlIGNsaWNrIGV2ZW50LCB3ZSBuZWVkIHRvIHdhdGNoIGZvciBhIHNjcm9sbAoJCQkJCQkvLyBldmVudC4gVW5mb3J0dW5hdGVseSwgc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MgZG9uJ3QgZGlzcGF0Y2ggc2Nyb2xsCgkJCQkJCS8vIGV2ZW50cyB1bnRpbCAqQUZURVIqIHRoZSB1c2VyIGxpZnRzIHRoZWlyIGZpbmdlciAodG91Y2hlbmQpLiBUaGlzIG1lYW5zCgkJCQkJCS8vIHdlIG5lZWQgdG8gd2F0Y2ggYm90aCBzY3JvbGwgYW5kIHRvdWNobW92ZSBldmVudHMgdG8gZmlndXJlIG91dCB3aGV0aGVyCgkJCQkJCS8vIG9yIG5vdCBhIHNjcm9sbCBoYXBwZW5lbnMgYmVmb3JlIHRoZSB0b3VjaGVuZCBldmVudCBpcyBmaXJlZC4KCgkJCQkJCS5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIGJpbmRpbmcgZm9yIHRoaXMgZXZlbnRUeXBlLAoJCQkvLyByZW1vdmUgaXRzIGdsb2JhbCBoYW5kbGVyIGZyb20gdGhlIGRvY3VtZW50LgoKCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF07CgoJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gKSB7CgkJCQkkZG9jdW1lbnQudW5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgaW4gZXhpc3RlbmNlLAoJCQkJLy8gcmVtb3ZlIG91ciBkb2N1bWVudCB0b3VjaHN0YXJ0IGxpc3RlbmVyLgoKCQkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdOwoKCQkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSApIHsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkudW5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLnVuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoJCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCWJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCQkvLyB0ZWFyZG93biBtYXkgYmUgY2FsbGVkIHdoZW4gYW4gZWxlbWVudCB3YXMKCQkJLy8gcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIHRoaXMgaXMgdGhlIGNhc2UsCgkJCS8vIGpRdWVyeSBjb3JlIG1heSBoYXZlIGFscmVhZHkgc3RyaXBwZWQgdGhlIGVsZW1lbnQKCQkJLy8gb2YgYW55IGRhdGEgYmluZGluZ3Mgc28gd2UgbmVlZCB0byBjaGVjayBpdCBiZWZvcmUKCQkJLy8gdXNpbmcgaXQuCgkJCWlmICggYmluZGluZ3MgKSB7CgkJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSBmYWxzZTsKCQkJfQoKCQkJLy8gVW5yZWdpc3RlciB0aGUgZHVtbXkgZXZlbnQgaGFuZGxlci4KCgkJCSR0aGlzLnVuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBvbiB0aGUKCQkJLy8gZWxlbWVudCwgcmVtb3ZlIHRoZSBiaW5kaW5nIGRhdGEgZnJvbSB0aGUgZWxlbWVudC4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJHRoaXMucmVtb3ZlRGF0YSggZGF0YVByb3BlcnR5TmFtZSApOwoJCQl9CgkJfQoJfTsKfQoKLy8gRXhwb3NlIG91ciBjdXN0b20gZXZlbnRzIHRvIHRoZSBqUXVlcnkgYmluZC91bmJpbmQgbWVjaGFuaXNtLgoKZm9yICggaSA9IDA7IGkgPCB2aXJ0dWFsRXZlbnROYW1lcy5sZW5ndGg7IGkrKyApIHsKCSQuZXZlbnQuc3BlY2lhbFsgdmlydHVhbEV2ZW50TmFtZXNbIGkgXSBdID0gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdICk7Cn0KCi8vIEFkZCBhIGNhcHR1cmUgY2xpY2sgaGFuZGxlciB0byBibG9jayBjbGlja3MuCi8vIE5vdGUgdGhhdCB3ZSByZXF1aXJlIGV2ZW50IGNhcHR1cmUgc3VwcG9ydCBmb3IgdGhpcyBzbyBpZiB0aGUgZGV2aWNlCi8vIGRvZXNuJ3Qgc3VwcG9ydCBpdCwgd2UgcHVudCBmb3Igbm93IGFuZCByZWx5IHNvbGVseSBvbiBtb3VzZSBldmVudHMuCmlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJdmFyIGNudCA9IGNsaWNrQmxvY2tMaXN0Lmxlbmd0aCwKCQkJdGFyZ2V0ID0gZS50YXJnZXQsCgkJCXgsIHksIGVsZSwgaSwgbywgdG91Y2hJRDsKCgkJaWYgKCBjbnQgKSB7CgkJCXggPSBlLmNsaWVudFg7CgkJCXkgPSBlLmNsaWVudFk7CgkJCXRocmVzaG9sZCA9ICQudm1vdXNlLmNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ7CgoJCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIHJ1biB0aHJvdWdoIHRoZSBjbGlja0Jsb2NrTGlzdCB0byBzZWUgaWYKCQkJLy8gdGhlIGN1cnJlbnQgY2xpY2sgZXZlbnQgaXMgaW4gdGhlIHByb3hpbWl0eSBvZiBvbmUgb2Ygb3VyCgkJCS8vIHZjbGljayBldmVudHMgdGhhdCBoYWQgcHJldmVudERlZmF1bHQoKSBjYWxsZWQgb24gaXQuIElmIHdlIGZpbmQKCQkJLy8gb25lLCB0aGVuIHdlIGJsb2NrIHRoZSBjbGljay4KCQkJLy8KCQkJLy8gV2h5IGRvIHdlIGhhdmUgdG8gcmVseSBvbiBwcm94aW1pdHk/CgkJCS8vCgkJCS8vIEJlY2F1c2UgdGhlIHRhcmdldCBvZiB0aGUgdG91Y2ggZXZlbnQgdGhhdCB0cmlnZ2VyZWQgdGhlIHZjbGljawoJCQkvLyBjYW4gYmUgZGlmZmVyZW50IGZyb20gdGhlIHRhcmdldCBvZiB0aGUgY2xpY2sgZXZlbnQgc3ludGhlc2l6ZWQKCQkJLy8gYnkgdGhlIGJyb3dzZXIuIFRoZSB0YXJnZXQgb2YgYSBtb3VzZS9jbGljayBldmVudCB0aGF0IGlzIHN5bnRoZXNpemVkCgkJCS8vIGZyb20gYSB0b3VjaCBldmVudCBzZWVtcyB0byBiZSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYy4gRm9yIGV4YW1wbGUsCgkJCS8vIHNvbWUgYnJvd3NlcnMgd2lsbCBmaXJlIG1vdXNlL2NsaWNrIGV2ZW50cyBmb3IgYSBsaW5rIHRoYXQgaXMgbmVhcgoJCQkvLyBhIHRvdWNoIGV2ZW50LCBldmVuIHRob3VnaCB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaHN0YXJ0L3RvdWNoZW5kIGV2ZW50CgkJCS8vIHNheXMgdGhlIHVzZXIgdG91Y2hlZCBvdXRzaWRlIHRoZSBsaW5rLiBBbHNvLCBpdCBzZWVtcyB0aGF0IHdpdGggbW9zdAoJCQkvLyBicm93c2VycywgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgZXZlbnQgaXMgbm90IGNhbGN1bGF0ZWQgdW50aWwgdGhlCgkJCS8vIHRpbWUgaXQgaXMgZGlzcGF0Y2hlZCwgc28gaWYgeW91IHJlcGxhY2UgYW4gZWxlbWVudCB0aGF0IHlvdSB0b3VjaGVkCgkJCS8vIHdpdGggYW5vdGhlciBlbGVtZW50LCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayB3aWxsIGJlIHRoZSBuZXcKCQkJLy8gZWxlbWVudCB1bmRlcm5lYXRoIHRoYXQgcG9pbnQuCgkJCS8vCgkJCS8vIEFzaWRlIGZyb20gcHJveGltaXR5LCB3ZSBhbHNvIGNoZWNrIHRvIHNlZSBpZiB0aGUgdGFyZ2V0IGFuZCBhbnkKCQkJLy8gb2YgaXRzIGFuY2VzdG9ycyB3ZXJlIHRoZSBvbmVzIHRoYXQgYmxvY2tlZCBhIGNsaWNrLiBUaGlzIGlzIG5lY2Vzc2FyeQoJCQkvLyBiZWNhdXNlIG9mIHRoZSBzdHJhbmdlIG1vdXNlL2NsaWNrIHRhcmdldCBjYWxjdWxhdGlvbiBkb25lIGluIHRoZQoJCQkvLyBBbmRyb2lkIDIuMSBicm93c2VyLCB3aGVyZSBpZiB5b3UgY2xpY2sgb24gYW4gZWxlbWVudCwgYW5kIHRoZXJlIGlzIGEKCQkJLy8gbW91c2UvY2xpY2sgaGFuZGxlciBvbiBvbmUgb2YgaXRzIGFuY2VzdG9ycywgdGhlIHRhcmdldCB3aWxsIGJlIHRoZQoJCQkvLyBpbm5lcm1vc3QgY2hpbGQgb2YgdGhlIHRvdWNoZWQgZWxlbWVudCwgZXZlbiBpZiB0aGF0IGNoaWxkIGlzIG5vIHdoZXJlCgkJCS8vIG5lYXIgdGhlIHBvaW50IG9mIHRvdWNoLgoKCQkJZWxlID0gdGFyZ2V0OwoKCQkJd2hpbGUgKCBlbGUgKSB7CgkJCQlmb3IgKCBpID0gMDsgaSA8IGNudDsgaSsrICkgewoJCQkJCW8gPSBjbGlja0Jsb2NrTGlzdFsgaSBdOwoJCQkJCXRvdWNoSUQgPSAwOwoKCQkJCQlpZiAoICggZWxlID09PSB0YXJnZXQgJiYgTWF0aC5hYnMoIG8ueCAtIHggKSA8IHRocmVzaG9sZCAmJiBNYXRoLmFicyggby55IC0geSApIDwgdGhyZXNob2xkICkgfHwKCQkJCQkJCQkkLmRhdGEoIGVsZSwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSA9PT0gby50b3VjaElEICkgewoJCQkJCQkvLyBYWFg6IFdlIG1heSB3YW50IHRvIGNvbnNpZGVyIHJlbW92aW5nIG1hdGNoZXMgZnJvbSB0aGUgYmxvY2sgbGlzdAoJCQkJCQkvLyAgICAgIGluc3RlYWQgb2Ygd2FpdGluZyBmb3IgdGhlIHJlc2V0IHRpbWVyIHRvIGZpcmUuCgkJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCQkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCQl9CgkJfQoJfSwgdHJ1ZSk7Cn0KfSkoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCQlzdXBwb3J0VG91Y2ggPSAkLm1vYmlsZS5zdXBwb3J0LnRvdWNoLAoJCXNjcm9sbEV2ZW50ID0gInRvdWNobW92ZSBzY3JvbGwiLAoJCXRvdWNoU3RhcnRFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaHN0YXJ0IiA6ICJtb3VzZWRvd24iLAoJCXRvdWNoU3RvcEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoZW5kIiA6ICJtb3VzZXVwIiwKCQl0b3VjaE1vdmVFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaG1vdmUiIDogIm1vdXNlbW92ZSI7CgoJLy8gc2V0dXAgbmV3IGV2ZW50IHNob3J0Y3V0cwoJJC5lYWNoKCAoICJ0b3VjaHN0YXJ0IHRvdWNobW92ZSB0b3VjaGVuZCAiICsKCQkidGFwIHRhcGhvbGQgIiArCgkJInN3aXBlIHN3aXBlbGVmdCBzd2lwZXJpZ2h0ICIgKwoJCSJzY3JvbGxzdGFydCBzY3JvbGxzdG9wIiApLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7CgkJfTsKCgkJLy8galF1ZXJ5IDwgMS44CgkJaWYgKCAkLmF0dHJGbiApIHsKCQkJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7CgkJfQoJfSk7CgoJZnVuY3Rpb24gdHJpZ2dlckN1c3RvbUV2ZW50KCBvYmosIGV2ZW50VHlwZSwgZXZlbnQsIGJ1YmJsZSApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCWlmICggYnViYmxlICkgewoJCQkkLmV2ZW50LnRyaWdnZXIoIGV2ZW50LCB1bmRlZmluZWQsIG9iaiApOwoJCX0gZWxzZSB7CgkJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCX0KCQlldmVudC50eXBlID0gb3JpZ2luYWxUeXBlOwoJfQoKCS8vIGFsc28gaGFuZGxlcyBzY3JvbGxzdG9wCgkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQgPSB7CgoJCWVuYWJsZWQ6IHRydWUsCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlzY3JvbGxpbmcsCgkJCQl0aW1lcjsKCgkJCWZ1bmN0aW9uIHRyaWdnZXIoIGV2ZW50LCBzdGF0ZSApIHsKCQkJCXNjcm9sbGluZyA9IHN0YXRlOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCQl9CgoJCQkvLyBpUGhvbmUgdHJpZ2dlcnMgc2Nyb2xsIGFmdGVyIGEgc21hbGwgZGVsYXk7IHVzZSB0b3VjaG1vdmUgaW5zdGVhZAoJCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoICFzY3JvbGxpbmcgKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIHRydWUgKTsKCQkJCX0KCgkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCBmYWxzZSApOwoJCQkJfSwgNTAgKTsKCQkJfSk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS51bmJpbmQoIHNjcm9sbEV2ZW50ICk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAoJJC5ldmVudC5zcGVjaWFsLnRhcCA9IHsKCQl0YXBob2xkVGhyZXNob2xkOiA3NTAsCgkJZW1pdFRhcE9uVGFwaG9sZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApLAoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgoJCQkkdGhpcy5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlzVGFwaG9sZCA9IGZhbHNlOwoJCQkJaWYgKCBldmVudC53aGljaCAmJiBldmVudC53aGljaCAhPT0gMSApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJdmFyIG9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQkJdGltZXI7CgoJCQkJZnVuY3Rpb24gY2xlYXJUYXBUaW1lcigpIHsKCQkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xlYXJUYXBIYW5kbGVycygpIHsKCQkJCQljbGVhclRhcFRpbWVyKCk7CgoJCQkJCSR0aGlzLnVuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApCgkJCQkJCS51bmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKTsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsaWNrSGFuZGxlciggZXZlbnQgKSB7CgkJCQkJY2xlYXJUYXBIYW5kbGVycygpOwoKCQkJCQkvLyBPTkxZIHRyaWdnZXIgYSAndGFwJyBldmVudCBpZiB0aGUgc3RhcnQgdGFyZ2V0IGlzCgkJCQkJLy8gdGhlIHNhbWUgYXMgdGhlIHN0b3AgdGFyZ2V0LgoJCQkJCWlmICggIWlzVGFwaG9sZCAmJiBvcmlnVGFyZ2V0ID09PSBldmVudC50YXJnZXQgKSB7CgkJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcCIsIGV2ZW50ICk7CgkJCQkJfSBlbHNlIGlmICggaXNUYXBob2xkICkgewoJCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRoaXMuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkJLmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKTsKCQkJCSRkb2N1bWVudC5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnRhcC5lbWl0VGFwT25UYXBob2xkICkgewoJCQkJCQlpc1RhcGhvbGQgPSB0cnVlOwoJCQkJCX0KCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXBob2xkIiwgJC5FdmVudCggInRhcGhvbGQiLCB7IHRhcmdldDogb3JpZ1RhcmdldCB9ICkgKTsKCQkJCX0sICQuZXZlbnQuc3BlY2lhbC50YXAudGFwaG9sZFRocmVzaG9sZCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggInZtb3VzZWRvd24iICkudW5iaW5kKCAidmNsaWNrIiApLnVuYmluZCggInZtb3VzZXVwIiApOwoJCQkkZG9jdW1lbnQudW5iaW5kKCAidm1vdXNlY2FuY2VsIiApOwoJCX0KCX07CgoJLy8gQWxzbyBoYW5kbGVzIHN3aXBlbGVmdCwgc3dpcGVyaWdodAoJJC5ldmVudC5zcGVjaWFsLnN3aXBlID0gewoKCQkvLyBNb3JlIHRoYW4gdGhpcyBob3Jpem9udGFsIGRpc3BsYWNlbWVudCwgYW5kIHdlIHdpbGwgc3VwcHJlc3Mgc2Nyb2xsaW5nLgoJCXNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQ6IDMwLAoKCQkvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCQlkdXJhdGlvblRocmVzaG9sZDogMTAwMCwKCgkJLy8gU3dpcGUgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBtb3JlIHRoYW4gdGhpcy4KCQlob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQ6IDMwLAoKCQkvLyBTd2lwZSB2ZXJ0aWNhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBsZXNzIHRoYW4gdGhpcy4KCQl2ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwKCgkJZ2V0TG9jYXRpb246IGZ1bmN0aW9uICggZXZlbnQgKSB7CgkJCXZhciB3aW5QYWdlWCA9IHdpbmRvdy5wYWdlWE9mZnNldCwKCQkJCXdpblBhZ2VZID0gd2luZG93LnBhZ2VZT2Zmc2V0LAoJCQkJeCA9IGV2ZW50LmNsaWVudFgsCgkJCQl5ID0gZXZlbnQuY2xpZW50WTsKCgkJCWlmICggZXZlbnQucGFnZVkgPT09IDAgJiYgTWF0aC5mbG9vciggeSApID4gTWF0aC5mbG9vciggZXZlbnQucGFnZVkgKSB8fAoJCQkJZXZlbnQucGFnZVggPT09IDAgJiYgTWF0aC5mbG9vciggeCApID4gTWF0aC5mbG9vciggZXZlbnQucGFnZVggKSApIHsKCgkJCQkvLyBpT1M0IGNsaWVudFgvY2xpZW50WSBoYXZlIHRoZSB2YWx1ZSB0aGF0IHNob3VsZCBoYXZlIGJlZW4KCQkJCS8vIGluIHBhZ2VYL3BhZ2VZLiBXaGlsZSBwYWdlWC9wYWdlLyBoYXZlIHRoZSB2YWx1ZSAwCgkJCQl4ID0geCAtIHdpblBhZ2VYOwoJCQkJeSA9IHkgLSB3aW5QYWdlWTsKCQkJfSBlbHNlIGlmICggeSA8ICggZXZlbnQucGFnZVkgLSB3aW5QYWdlWSkgfHwgeCA8ICggZXZlbnQucGFnZVggLSB3aW5QYWdlWCApICkgewoKCQkJCS8vIFNvbWUgQW5kcm9pZCBicm93c2VycyBoYXZlIHRvdGFsbHkgYm9ndXMgdmFsdWVzIGZvciBjbGllbnRYL1kKCQkJCS8vIHdoZW4gc2Nyb2xsaW5nL3pvb21pbmcgYSBwYWdlLiBEZXRlY3RhYmxlIHNpbmNlIGNsaWVudFgvY2xpZW50WQoJCQkJLy8gc2hvdWxkIG5ldmVyIGJlIHNtYWxsZXIgdGhhbiBwYWdlWC9wYWdlWSBtaW51cyBwYWdlIHNjcm9sbAoJCQkJeCA9IGV2ZW50LnBhZ2VYIC0gd2luUGFnZVg7CgkJCQl5ID0gZXZlbnQucGFnZVkgLSB3aW5QYWdlWTsKCQkJfQoKCQkJcmV0dXJuIHsKCQkJCXg6IHgsCgkJCQl5OiB5CgkJCX07CgkJfSwKCgkJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQsCgkJCQlsb2NhdGlvbiA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5nZXRMb2NhdGlvbiggZGF0YSApOwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBsb2NhdGlvbi54LCBsb2NhdGlvbi55IF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQsCgkJCQlsb2NhdGlvbiA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5nZXRMb2NhdGlvbiggZGF0YSApOwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBsb2NhdGlvbi54LCBsb2NhdGlvbi55IF0KCQkJCQl9OwoJCX0sCgoJCWhhbmRsZVN3aXBlOiBmdW5jdGlvbiggc3RhcnQsIHN0b3AsIHRoaXNPYmplY3QsIG9yaWdUYXJnZXQgKSB7CgkJCWlmICggc3RvcC50aW1lIC0gc3RhcnQudGltZSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5kdXJhdGlvblRocmVzaG9sZCAmJgoJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZCAmJgoJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMSBdIC0gc3RvcC5jb29yZHNbIDEgXSApIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLnZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQgKSB7CgkJCQl2YXIgZGlyZWN0aW9uID0gc3RhcnQuY29vcmRzWzBdID4gc3RvcC5jb29yZHNbIDAgXSA/ICJzd2lwZWxlZnQiIDogInN3aXBlcmlnaHQiOwoKCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInN3aXBlIiwgJC5FdmVudCggInN3aXBlIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQsIHN3aXBlc3RhcnQ6IHN0YXJ0LCBzd2lwZXN0b3A6IHN0b3AgfSksIHRydWUgKTsKCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgZGlyZWN0aW9uLCQuRXZlbnQoIGRpcmVjdGlvbiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQsIHN3aXBlc3RhcnQ6IHN0YXJ0LCBzd2lwZXN0b3A6IHN0b3AgfSApLCB0cnVlICk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgoJCX0sCgoJCS8vIFRoaXMgc2VydmVzIGFzIGEgZmxhZyB0byBlbnN1cmUgdGhhdCBhdCBtb3N0IG9uZSBzd2lwZSBldmVudCBldmVudCBpcwoJCS8vIGluIHdvcmsgYXQgYW55IGdpdmVuIHRpbWUKCQlldmVudEluUHJvZ3Jlc3M6IGZhbHNlLAoKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCXZhciBldmVudHMsCgkJCQl0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApLAoJCQkJY29udGV4dCA9IHt9OwoKCQkJLy8gUmV0cmlldmUgdGhlIGV2ZW50cyBkYXRhIGZvciB0aGlzIGVsZW1lbnQgYW5kIGFkZCB0aGUgc3dpcGUgY29udGV4dAoJCQlldmVudHMgPSAkLmRhdGEoIHRoaXMsICJtb2JpbGUtZXZlbnRzIiApOwoJCQlpZiAoICFldmVudHMgKSB7CgkJCQlldmVudHMgPSB7IGxlbmd0aDogMCB9OwoJCQkJJC5kYXRhKCB0aGlzLCAibW9iaWxlLWV2ZW50cyIsIGV2ZW50cyApOwoJCQl9CgkJCWV2ZW50cy5sZW5ndGgrKzsKCQkJZXZlbnRzLnN3aXBlID0gY29udGV4dDsKCgkJCWNvbnRleHQuc3RhcnQgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gQmFpbCBpZiB3ZSdyZSBhbHJlYWR5IHdvcmtpbmcgb24gYSBzd2lwZSBldmVudAoJCQkJaWYgKCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZXZlbnRJblByb2dyZXNzICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCSQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ldmVudEluUHJvZ3Jlc3MgPSB0cnVlOwoKCQkJCXZhciBzdG9wLAoJCQkJCXN0YXJ0ID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0YXJ0KCBldmVudCApLAoJCQkJCW9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQkJZW1pdHRlZCA9IGZhbHNlOwoKCQkJCWNvbnRleHQubW92ZSA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoICFzdGFydCApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJc3RvcCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zdG9wKCBldmVudCApOwoJCQkJCWlmICggIWVtaXR0ZWQgKSB7CgkJCQkJCWVtaXR0ZWQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaGFuZGxlU3dpcGUoIHN0YXJ0LCBzdG9wLCB0aGlzT2JqZWN0LCBvcmlnVGFyZ2V0ICk7CgkJCQkJCWlmICggZW1pdHRlZCApIHsKCgkJCQkJCQkvLyBSZXNldCB0aGUgY29udGV4dCB0byBtYWtlIHdheSBmb3IgdGhlIG5leHQgc3dpcGUgZXZlbnQKCQkJCQkJCSQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ldmVudEluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJCQkJfQoJCQkJCX0KCQkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJCWlmICggTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfTsKCgkJCQljb250ZXh0LnN0b3AgPSBmdW5jdGlvbigpIHsKCQkJCQkJZW1pdHRlZCA9IHRydWU7CgoJCQkJCQkvLyBSZXNldCB0aGUgY29udGV4dCB0byBtYWtlIHdheSBmb3IgdGhlIG5leHQgc3dpcGUgZXZlbnQKCQkJCQkJJC5ldmVudC5zcGVjaWFsLnN3aXBlLmV2ZW50SW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQkJCQkkZG9jdW1lbnQub2ZmKCB0b3VjaE1vdmVFdmVudCwgY29udGV4dC5tb3ZlICk7CgkJCQkJCWNvbnRleHQubW92ZSA9IG51bGw7CgkJCQl9OwoKCQkJCSRkb2N1bWVudC5vbiggdG91Y2hNb3ZlRXZlbnQsIGNvbnRleHQubW92ZSApCgkJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGNvbnRleHQuc3RvcCApOwoJCQl9OwoJCQkkdGhpcy5vbiggdG91Y2hTdGFydEV2ZW50LCBjb250ZXh0LnN0YXJ0ICk7CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQl2YXIgZXZlbnRzLCBjb250ZXh0OwoKCQkJZXZlbnRzID0gJC5kYXRhKCB0aGlzLCAibW9iaWxlLWV2ZW50cyIgKTsKCQkJaWYgKCBldmVudHMgKSB7CgkJCQljb250ZXh0ID0gZXZlbnRzLnN3aXBlOwoJCQkJZGVsZXRlIGV2ZW50cy5zd2lwZTsKCQkJCWV2ZW50cy5sZW5ndGgtLTsKCQkJCWlmICggZXZlbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkkLnJlbW92ZURhdGEoIHRoaXMsICJtb2JpbGUtZXZlbnRzIiApOwoJCQkJfQoJCQl9CgoJCQlpZiAoIGNvbnRleHQgKSB7CgkJCQlpZiAoIGNvbnRleHQuc3RhcnQgKSB7CgkJCQkJJCggdGhpcyApLm9mZiggdG91Y2hTdGFydEV2ZW50LCBjb250ZXh0LnN0YXJ0ICk7CgkJCQl9CgkJCQlpZiAoIGNvbnRleHQubW92ZSApIHsKCQkJCQkkZG9jdW1lbnQub2ZmKCB0b3VjaE1vdmVFdmVudCwgY29udGV4dC5tb3ZlICk7CgkJCQl9CgkJCQlpZiAoIGNvbnRleHQuc3RvcCApIHsKCQkJCQkkZG9jdW1lbnQub2ZmKCB0b3VjaFN0b3BFdmVudCwgY29udGV4dC5zdG9wICk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoJJC5lYWNoKHsKCQlzY3JvbGxzdG9wOiAic2Nyb2xsc3RhcnQiLAoJCXRhcGhvbGQ6ICJ0YXAiLAoJCXN3aXBlbGVmdDogInN3aXBlIiwKCQlzd2lwZXJpZ2h0OiAic3dpcGUiCgl9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCQkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoIHNvdXJjZUV2ZW50ICk7CgkJCX0KCQl9OwoJfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKCS8vIHRocm90dGxlZCByZXNpemUgZXZlbnQKCShmdW5jdGlvbiggJCApIHsKCQkkLmV2ZW50LnNwZWNpYWwudGhyb3R0bGVkcmVzaXplID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfQoJCX07CgoJCXZhciB0aHJvdHRsZSA9IDI1MCwKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQkJY3VyciA9ICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCQkJCWRpZmYgPSBjdXJyIC0gbGFzdENhbGw7CgoJCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCQlsYXN0Q2FsbCA9IGN1cnI7CgkJCQkJJCggdGhpcyApLnRyaWdnZXIoICJ0aHJvdHRsZWRyZXNpemUiICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaWYgKCBoZWxkQ2FsbCApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBoZWxkQ2FsbCApOwoJCQkJCX0KCgkJCQkJLy8gUHJvbWlzZSBhIGhlbGQgY2FsbCB3aWxsIHN0aWxsIGV4ZWN1dGUKCQkJCQloZWxkQ2FsbCA9IHNldFRpbWVvdXQoIGhhbmRsZXIsIHRocm90dGxlIC0gZGlmZiApOwoJCQkJfQoJCQl9LAoJCQlsYXN0Q2FsbCA9IDAsCgkJCWhlbGRDYWxsLAoJCQljdXJyLAoJCQlkaWZmOwoJfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfSwKCQl3dywgd2gsIGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgd2luLndpZHRoKCk7CgkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgd2luLmhlaWdodCgpOwoJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgkJLy8gTm93IGNoZWNrIHRvIHNlZSBpZiB0aGUgY3VycmVudCB3aW5kb3cub3JpZW50YXRpb24gaXMgMCBvciAxODAuCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCgkJLy8gSWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgbGFuZHNjYXBlLCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgMCBvciAxODAsICpPUioKCQkvLyBpZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBwb3J0cmFpdCwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDkwIG9yIC05MCwgd2UKCQkvLyBuZWVkIHRvIGZsaXAgb3VyIHBvcnRyYWl0X21hcCB2YWx1ZXMgYmVjYXVzZSBsYW5kc2NhcGUgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gZm9yCgkJLy8gdGhpcyBkZXZpY2UvYnJvd3Nlci4KCQlpZiAoICggaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgfHwgKCAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgIWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApICkgewoJCQlwb3J0cmFpdF9tYXAgPSB7ICItOTAiOiB0cnVlLCAiOTAiOiB0cnVlIH07CgkJfQoJfQoKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSA9ICQuZXh0ZW5kKCB7fSwgJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLCB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdCBqUXVlcnkKCQkJLy8gd2lsbCBiaW5kIHRvIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdAoJCQkvLyBqUXVlcnkgd2lsbCB1bmJpbmQgdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCB1bmJpbmQgdGhlCgkJCS8vIHJlc2l6ZSBldmVudCBoYW5kbGVyLgoJCQl3aW4udW5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJYWRkOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBib3VuZCBldmVudCBoYW5kbGVyLgoJCQl2YXIgb2xkX2hhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlcjsKCgkJCWhhbmRsZU9iai5oYW5kbGVyID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJLy8gTW9kaWZ5IGV2ZW50IG9iamVjdCwgYWRkaW5nIHRoZSAub3JpZW50YXRpb24gcHJvcGVydHkuCgkJCQlldmVudC5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJCS8vIENhbGwgdGhlIG9yaWdpbmFsbHktYm91bmQgZXZlbnQgaGFuZGxlciBhbmQgcmV0dXJuIGl0cyByZXN1bHQuCgkJCQlyZXR1cm4gb2xkX2hhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9OwoJCX0KCX0pOwoKCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGlzIGhhbmRsZXIgd2lsbCBiZSBib3VuZCB0bwoJLy8gdGhlIHdpbmRvdyByZXNpemUgZXZlbnQgdG8gc2ltdWxhdGUgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJZnVuY3Rpb24gaGFuZGxlcigpIHsKCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24uCgkJdmFyIG9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCWlmICggb3JpZW50YXRpb24gIT09IGxhc3Rfb3JpZW50YXRpb24gKSB7CgkJCS8vIFRoZSBvcmllbnRhdGlvbiBoYXMgY2hhbmdlZCwgc28gdHJpZ2dlciB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBvcmllbnRhdGlvbjsKCQkJd2luLnRyaWdnZXIoIGV2ZW50X25hbWUgKTsKCQl9Cgl9CgoJLy8gR2V0IHRoZSBjdXJyZW50IHBhZ2Ugb3JpZW50YXRpb24uIFRoaXMgbWV0aG9kIGlzIGV4cG9zZWQgcHVibGljbHksIHNob3VsZCBpdAoJLy8gYmUgbmVlZGVkLCBhcyBqUXVlcnkuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbigpCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24gPSBmdW5jdGlvbigpIHsKCQl2YXIgaXNQb3J0cmFpdCA9IHRydWUsIGVsZW0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgoJCS8vIHByZWZlciB3aW5kb3cgb3JpZW50YXRpb24gdG8gdGhlIGNhbGN1bGF0aW9uIGJhc2VkIG9uIHNjcmVlbnNpemUgYXMKCQkvLyB0aGUgYWN0dWFsIHNjcmVlbiByZXNpemUgdGFrZXMgcGxhY2UgYmVmb3JlIG9yIGFmdGVyIHRoZSBvcmllbnRhdGlvbiBjaGFuZ2UgZXZlbnQKCQkvLyBoYXMgYmVlbiBmaXJlZCBkZXBlbmRpbmcgb24gaW1wbGVtZW50YXRpb24gKGVnIGFuZHJvaWQgMi4zIGlzIGJlZm9yZSwgaXBob25lIGFmdGVyKS4KCQkvLyBNb3JlIHRlc3RpbmcgaXMgcmVxdWlyZWQgdG8gZGV0ZXJtaW5lIGlmIGEgbW9yZSByZWxpYWJsZSBtZXRob2Qgb2YgZGV0ZXJtaW5pbmcgdGhlIG5ldyBzY3JlZW5zaXplCgkJLy8gaXMgcG9zc2libGUgd2hlbiBvcmllbnRhdGlvbmNoYW5nZSBpcyBmaXJlZC4gKGVnLCB1c2UgbWVkaWEgcXVlcmllcyArIGVsZW1lbnQgKyBvcGFjaXR5KQoJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoJCQkvLyBpZiB0aGUgd2luZG93IG9yaWVudGF0aW9uIHJlZ2lzdGVycyBhcyAwIG9yIDE4MCBkZWdyZWVzIHJlcG9ydAoJCQkvLyBwb3J0cmFpdCwgb3RoZXJ3aXNlIGxhbmRzY2FwZQoJCQlpc1BvcnRyYWl0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCQl9IGVsc2UgewoJCQlpc1BvcnRyYWl0ID0gZWxlbSAmJiBlbGVtLmNsaWVudFdpZHRoIC8gZWxlbS5jbGllbnRIZWlnaHQgPCAxLjE7CgkJfQoKCQlyZXR1cm4gaXNQb3J0cmFpdCA/ICJwb3J0cmFpdCIgOiAibGFuZHNjYXBlIjsKCX07CgoJJC5mblsgZXZlbnRfbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiBmbiA/IHRoaXMuYmluZCggZXZlbnRfbmFtZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggZXZlbnRfbmFtZSApOwoJfTsKCgkvLyBqUXVlcnkgPCAxLjgKCWlmICggJC5hdHRyRm4gKSB7CgkJJC5hdHRyRm5bIGV2ZW50X25hbWUgXSA9IHRydWU7Cgl9Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvLyBleGlzdGluZyBiYXNlIHRhZz8KCXZhciBiYXNlRWxlbWVudCA9ICQoICJoZWFkIiApLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkvLyBiYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkvLyBUT0RPIG1vdmUgdG8gZXh0ZXJuYWwgd2lkZ2V0CgliYXNlID0gewoKCQkvLyBkZWZpbmUgYmFzZSBlbGVtZW50LCBmb3IgdXNlIGluIHJvdXRpbmcgYXNzZXQgdXJscyB0aGF0IGFyZSByZWZlcmVuY2VkCgkJLy8gaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJZWxlbWVudDogKCBiYXNlRWxlbWVudC5sZW5ndGggPyBiYXNlRWxlbWVudCA6CgkJCSQoICI8YmFzZT4iLCB7IGhyZWY6ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggfSApLnByZXBlbmRUbyggJCggImhlYWQiICkgKSApLAoKCQlsaW5rU2VsZWN0b3I6ICJbc3JjXSwgbGlua1tocmVmXSwgYVtyZWw9J2V4dGVybmFsJ10sIDpqcW1EYXRhKGFqYXg9J2ZhbHNlJyksIGFbdGFyZ2V0XSIsCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXNldDogZnVuY3Rpb24oIGhyZWYgKSB7CgoJCQkvLyB3ZSBzaG91bGQgZG8gbm90aGluZyBpZiB0aGUgdXNlciB3YW50cyB0byBtYW5hZ2UgdGhlaXIgdXJsIGJhc2UKCQkJLy8gbWFudWFsbHkKCQkJaWYgKCAhJC5tb2JpbGUuZHluYW1pY0Jhc2VFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyB3ZSBzaG91bGQgdXNlIHRoZSBiYXNlIHRhZyBpZiB3ZSBjYW4gbWFuaXB1bGF0ZSBpdCBkeW5hbWljYWxseQoJCQlpZiAoICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyApIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsCgkJCQkJJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlICkgKTsKCQkJfQoJCX0sCgoJCXJld3JpdGU6IGZ1bmN0aW9uKCBocmVmLCBwYWdlICkgewoJCQl2YXIgbmV3UGF0aCA9ICQubW9iaWxlLnBhdGguZ2V0KCBocmVmICk7CgoJCQlwYWdlLmZpbmQoIGJhc2UubGlua1NlbGVjdG9yICkuZWFjaChmdW5jdGlvbiggaSwgbGluayApIHsKCQkJCXZhciB0aGlzQXR0ciA9ICQoIGxpbmsgKS5pcyggIltocmVmXSIgKSA/ICJocmVmIiA6CgkJCQkJJCggbGluayApLmlzKCAiW3NyY10iICkgPyAic3JjIiA6ICJhY3Rpb24iLAoJCQkJdGhpc1VybCA9ICQoIGxpbmsgKS5hdHRyKCB0aGlzQXR0ciApOwoKCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkvLyAgICAgICAgICAgIGJhc2UgVVJMLCBhbmQgdGhlbiBwcmVwZW5kcyB3aXRoIHRoZSBuZXcgcGFnZSBVUkwuCgkJCQkvLyBpZiBmdWxsIHBhdGggZXhpc3RzIGFuZCBpcyBzYW1lLCBjaG9wIGl0IC0gaGVscHMgSUUgb3V0CgkJCQl0aGlzVXJsID0gdGhpc1VybC5yZXBsYWNlKCBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKwoJCQkJCWxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgIiIgKTsKCgkJCQlpZiAoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJJCggbGluayApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBzZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQlyZXNldDogZnVuY3Rpb24oLyogaHJlZiAqLykgewoJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9TZWFyY2ggKTsKCQl9Cgl9OwoKCSQubW9iaWxlLmJhc2UgPSBiYXNlOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewokLm1vYmlsZS53aWRnZXRzID0ge307Cgp2YXIgb3JpZ2luYWxXaWRnZXQgPSAkLndpZGdldCwKCgkvLyBSZWNvcmQgdGhlIG9yaWdpbmFsLCBub24tbW9iaWxlaW5pdC1tb2RpZmllZCB2ZXJzaW9uIG9mICQubW9iaWxlLmtlZXBOYXRpdmUKCS8vIHNvIHdlIGNhbiBsYXRlciBkZXRlcm1pbmUgd2hldGhlciBzb21lb25lIGhhcyBtb2RpZmllZCAkLm1vYmlsZS5rZWVwTmF0aXZlCglrZWVwTmF0aXZlRmFjdG9yeURlZmF1bHQgPSAkLm1vYmlsZS5rZWVwTmF0aXZlOwoKJC53aWRnZXQgPSAoZnVuY3Rpb24oIG9yaWcgKSB7CglyZXR1cm4gZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnN0cnVjdG9yID0gb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICksCgkJCW5hbWUgPSBjb25zdHJ1Y3Rvci5wcm90b3R5cGUud2lkZ2V0TmFtZTsKCgkJY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yID0gKCAoIGNvbnN0cnVjdG9yLnByb3RvdHlwZS5pbml0U2VsZWN0b3IgIT09IHVuZGVmaW5lZCApID8KCQkJY29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciA6ICI6anFtRGF0YShyb2xlPSciICsgbmFtZSArICInKSIgKTsKCgkJJC5tb2JpbGUud2lkZ2V0c1sgbmFtZSBdID0gY29uc3RydWN0b3I7CgoJCXJldHVybiBjb25zdHJ1Y3RvcjsKCX07Cn0pKCAkLndpZGdldCApOwoKLy8gTWFrZSBzdXJlICQud2lkZ2V0IHN0aWxsIGhhcyBicmlkZ2UgYW5kIGV4dGVuZCBtZXRob2RzCiQuZXh0ZW5kKCAkLndpZGdldCwgb3JpZ2luYWxXaWRnZXQgKTsKCi8vIEZvciBiYWNrY29tcGF0IHJlbW92ZSBpbiAxLjUKJC5tb2JpbGUuZG9jdW1lbnQub24oICJjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkkKCBldmVudC50YXJnZXQgKS5lbmhhbmNlV2l0aGluKCk7Cn0pOwoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImEiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCWtlZXBOYXRpdmVEZWZhdWx0OiAkLm1vYmlsZS5rZWVwTmF0aXZlLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJY29udGVudFRoZW1lOiBudWxsLAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCgkvLyBERVBSRUNBVEVEIGZvciA+IDEuNAoJLy8gVE9ETyByZW1vdmUgYXQgMS41CglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQkkLldpZGdldC5wcm90b3R5cGUuX2NyZWF0ZVdpZGdldC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fdHJpZ2dlciggImluaXQiICk7Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCS8vIElmIGZhbHNlIGlzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFja3MgZG8gbm90IGNyZWF0ZSB0aGUgcGFnZQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWNyZWF0ZSIgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudCwgewoJCQlwYWdlYmVmb3JlaGlkZTogInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiLAoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIKCQl9KTsKCgkJdGhpcy5lbGVtZW50LmVuaGFuY2VXaXRoaW4oKTsKCQkvLyBEaWFsb2cgd2lkZ2V0IGlzIGRlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSB0aGlzIGluIDEuNQoJCWlmICggJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLmVsZW1lbnRbMF0sICJyb2xlIiApID09PSAiZGlhbG9nIiAmJiAkLm1vYmlsZS5kaWFsb2cgKSB7CgkJCXRoaXMuZWxlbWVudC5kaWFsb2coKTsKCQl9Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbiAoKSB7CgkJdmFyIGF0dHJQcmVmaXggPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5yb2xlICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCB0aGlzLm9wdGlvbnMucm9sZSApOwoJCX0KCgkJdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wYWdlIHVpLXBhZ2UtdGhlbWUtIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoKCQkvLyBNYW5pcHVsYXRpb24gb2YgY29udGVudCBvcyBEZXByZWNhdGVkIGFzIG9mIDEuNCByZW1vdmUgaW4gMS41CgkJdGhpcy5lbGVtZW50LmZpbmQoICJbIiArIGF0dHJQcmVmaXggKyAicm9sZT0nY29udGVudCddIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQl0aGVtZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCBhdHRyUHJlZml4ICsgInRoZW1lIiApIHx8IHVuZGVmaW5lZDsKCQkJCXNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgPSB0aGVtZSB8fCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lIHx8ICggc2VsZi5vcHRpb25zLmRpYWxvZyAmJiBzZWxmLm9wdGlvbnMudGhlbWUgKSB8fCAoIHNlbGYuZWxlbWVudC5qcW1EYXRhKCJyb2xlIikgPT09ICJkaWFsb2ciICYmICBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJCSR0aGlzLmFkZENsYXNzKCAidWktY29udGVudCIgKTsKCQkJCWlmICggc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSApIHsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSApICk7CgkJCQl9CgkJCQkvLyBBZGQgQVJJQSByb2xlCgkJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApLmFkZENsYXNzKCAidWktY29udGVudCIgKTsKCQl9KTsKCX0sCgoJYmluZFJlbW92ZTogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXZhciBwYWdlID0gdGhpcy5lbGVtZW50OwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiAoICFwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlICYmCgkJCXBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgKSB7CgoJCQkvLyBUT0RPIHVzZSBfb24gLSB0aGF0IGlzLCBzb3J0IG91dCB3aHkgaXQgZG9lc24ndCB3b3JrIGluIHRoaXMgY2FzZQoJCQlwYWdlLmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiLCBjYWxsYmFjayB8fCBmdW5jdGlvbiggZSwgZGF0YSApIHsKCgkJCQkvL2NoZWNrIGlmIHRoaXMgaXMgYSBzYW1lIHBhZ2UgdHJhbnNpdGlvbiBhbmQgaWYgc28gZG9uJ3QgcmVtb3ZlIHRoZSBwYWdlCgkJCQlpZiggIWRhdGEuc2FtZVBhZ2UgKXsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJCSR0aGlzLnRyaWdnZXIoIHByRXZlbnQgKTsKCgkJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJJHRoaXMucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCWlmICggby50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLXRoZW1lLSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKS5hZGRDbGFzcyggInVpLXBhZ2UtdGhlbWUtIiArIG8udGhlbWUgKTsKCQl9CgoJCWlmICggby5jb250ZW50VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiPSdjb250ZW50J10iICkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyB0aGlzLm9wdGlvbnMuY29udGVudFRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIG8uY29udGVudFRoZW1lICk7CgkJfQoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQl0aGlzLnNldENvbnRhaW5lckJhY2tncm91bmQoKTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CglyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIjptb2JpbGUtcGFnZWNvbnRhaW5lciIgKS5wYWdlY29udGFpbmVyKHsgInRoZW1lIjogIm5vbmUiIH0pOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCS8vIHNldCB0aGUgcGFnZSBjb250YWluZXIgYmFja2dyb3VuZCB0byB0aGUgcGFnZSB0aGVtZQoJc2V0Q29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oIHRoZW1lICkgewoJCXRoaXMuZWxlbWVudC5wYXJlbnQoKS5wYWdlY29udGFpbmVyKCB7ICJ0aGVtZSI6IHRoZW1lIHx8IHRoaXMub3B0aW9ucy50aGVtZSB9ICk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJa2VlcE5hdGl2ZVNlbGVjdG9yOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJa2VlcE5hdGl2ZSA9ICQudHJpbSggb3B0aW9ucy5rZWVwTmF0aXZlIHx8ICIiICksCgkJCWdsb2JhbFZhbHVlID0gJC50cmltKCAkLm1vYmlsZS5rZWVwTmF0aXZlICksCgkJCW9wdGlvblZhbHVlID0gJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0ICksCgoJCQkvLyBDaGVjayBpZiAkLm1vYmlsZS5rZWVwTmF0aXZlIGhhcyBjaGFuZ2VkIGZyb20gdGhlIGZhY3RvcnkgZGVmYXVsdAoJCQluZXdEZWZhdWx0ID0gKCBrZWVwTmF0aXZlRmFjdG9yeURlZmF1bHQgPT09IGdsb2JhbFZhbHVlID8KCQkJCSIiIDogZ2xvYmFsVmFsdWUgKSwKCgkJCS8vIElmICQubW9iaWxlLmtlZXBOYXRpdmUgaGFzIG5vdCBjaGFuZ2VkLCB1c2Ugb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdAoJCQlvbGREZWZhdWx0ID0gKCBuZXdEZWZhdWx0ID09PSAiIiA/IG9wdGlvblZhbHVlIDogIiIgKTsKCgkJLy8gQ29uY2F0ZW5hdGUga2VlcE5hdGl2ZSBzZWxlY3RvcnMgZnJvbSBhbGwgc291cmNlcyB3aGVyZSB0aGUgdmFsdWUgaGFzCgkJLy8gY2hhbmdlZCBvciwgaWYgbm90aGluZyBoYXMgY2hhbmdlZCwgcmV0dXJuIHRoZSBkZWZhdWx0CgkJcmV0dXJuICggKCBrZWVwTmF0aXZlID8gWyBrZWVwTmF0aXZlIF0gOiBbXSApCgkJCS5jb25jYXQoIG5ld0RlZmF1bHQgPyBbIG5ld0RlZmF1bHQgXSA6IFtdICkKCQkJLmNvbmNhdCggb2xkRGVmYXVsdCA/IFsgb2xkRGVmYXVsdCBdIDogW10gKQoJCQkuam9pbiggIiwgIiApICk7Cgl9Cn0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS5wYWdlY29udGFpbmVyIiwgewoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6ICJhIgoJCX0sCgoJCWluaXRTZWxlY3RvcjogZmFsc2UsCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgewoJCQkJLy8gZGlzYWJsZSBhbiBzY3JvbGwgc2V0dGluZyB3aGVuIGEgaGFzaGNoYW5nZSBoYXMgYmVlbiBmaXJlZCwKCQkJCS8vIHRoaXMgb25seSB3b3JrcyBiZWNhdXNlIHRoZSByZWNvcmRpbmcgb2YgdGhlIHNjcm9sbCBwb3NpdGlvbgoJCQkJLy8gaXMgZGVsYXllZCBmb3IgMTAwbXMgYWZ0ZXIgdGhlIGJyb3dzZXIgbWlnaHQgaGF2ZSBjaGFuZ2VkIHRoZQoJCQkJLy8gcG9zaXRpb24gYmVjYXVzZSBvZiB0aGUgaGFzaGNoYW5nZQoJCQkJbmF2aWdhdGU6ICJfZGlzYWJsZVJlY29yZFNjcm9sbCIsCgoJCQkJLy8gYmluZCB0byBzY3JvbGxzdG9wIGZvciB0aGUgZmlyc3QgcGFnZSwgInBhZ2VjaGFuZ2UiIHdvbid0IGJlCgkJCQkvLyBmaXJlZCBpbiB0aGF0IGNhc2UKCQkJCXNjcm9sbHN0b3A6ICJfZGVsYXllZFJlY29yZFNjcm9sbCIKCQkJfSk7CgoJCQkvLyBUT0RPIGNvbnNpZGVyIG1vdmluZyB0aGUgbmF2aWdhdGlvbiBoYW5kbGVyIE9VVCBvZiB3aWRnZXQgaW50bwoJCQkvLyAgICAgIHNvbWUgb3RoZXIgb2JqZWN0IGFzIGdsdWUgYmV0d2VlbiB0aGUgbmF2aWdhdGUgZXZlbnQgYW5kIHRoZQoJCQkvLyAgICAgIGNvbnRlbnQgd2lkZ2V0IGxvYWQgYW5kIGNoYW5nZSBtZXRob2RzCgkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgeyBuYXZpZ2F0ZTogIl9maWx0ZXJOYXZpZ2F0ZUV2ZW50cyIgfSk7CgoJCQkvLyBUT0RPIG1vdmUgZnJvbSBwYWdlKiBldmVudHMgdG8gY29udGVudCogZXZlbnRzCgkJCXRoaXMuX29uKHsgcGFnZWNoYW5nZTogIl9hZnRlckNvbnRlbnRDaGFuZ2UiIH0pOwoKCQkJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJCQl0aGlzLndpbmRvdy5vbmUoICJuYXZpZ2F0ZSIsICQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgJiYgb3B0aW9ucy50aGVtZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyBvcHRpb25zLnRoZW1lICk7CgkJCX0gZWxzZSBpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJCX0sCgoJCV9kaXNhYmxlUmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJCX0sCgoJCV9lbmFibGVSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCQl9LAoKCQkvLyBUT0RPIGNvbnNpZGVyIHRoZSBuYW1lIGhlcmUsIHNpbmNlIGl0J3MgcHVycG9zZSBzcGVjaWZpYwoJCV9hZnRlckNvbnRlbnRDaGFuZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBvbmNlIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLCByZS1lbmFibGUgdGhlIHNjcm9sbCByZWNvcmRpbmcKCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgoJCQkvLyByZW1vdmUgYW55IGJpbmRpbmcgdGhhdCBwcmV2aW91c2x5IGV4aXN0ZWQgb24gdGhlIGdldCBzY3JvbGwKCQkJLy8gd2hpY2ggbWF5IG9yIG1heSBub3QgYmUgZGlmZmVyZW50IHRoYW4gdGhlIHNjcm9sbCBlbGVtZW50CgkJCS8vIGRldGVybWluZWQgZm9yIHRoaXMgcGFnZSBwcmV2aW91c2x5CgkJCXRoaXMuX29mZiggdGhpcy53aW5kb3csICJzY3JvbGxzdG9wIiApOwoKCQkJLy8gZGV0ZXJtaW5lIGFuZCBiaW5kIHRvIHRoZSBjdXJyZW50IHNjb2xsIGVsZW1lbnQgd2hpY2ggbWF5IGJlIHRoZQoJCQkvLyB3aW5kb3cgb3IgaW4gdGhlIGNhc2Ugb2YgdG91Y2ggb3ZlcmZsb3cgdGhlIGVsZW1lbnQgdG91Y2ggb3ZlcmZsb3cKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7IHNjcm9sbHN0b3A6ICJfZGVsYXllZFJlY29yZFNjcm9sbCIgfSk7CgkJfSwKCgkJX3JlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCS8vIHRoaXMgYmFycmllciBwcmV2ZW50cyBzZXR0aW5nIHRoZSBzY3JvbGwgdmFsdWUgYmFzZWQgb24KCQkJLy8gdGhlIGJyb3dzZXIgc2Nyb2xsaW5nIHRoZSB3aW5kb3cgYmFzZWQgb24gYSBoYXNoY2hhbmdlCgkJCWlmICggIXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBhY3RpdmUgPSB0aGlzLl9nZXRBY3RpdmVIaXN0b3J5KCksCgkJCQljdXJyZW50U2Nyb2xsLCBtaW5TY3JvbGwsIGRlZmF1bHRTY3JvbGw7CgoJCQlpZiAoIGFjdGl2ZSApIHsKCQkJCWN1cnJlbnRTY3JvbGwgPSB0aGlzLl9nZXRTY3JvbGwoKTsKCQkJCW1pblNjcm9sbCA9IHRoaXMuX2dldE1pblNjcm9sbCgpOwoJCQkJZGVmYXVsdFNjcm9sbCA9IHRoaXMuX2dldERlZmF1bHRTY3JvbGwoKTsKCgkJCQkvLyBTZXQgYWN0aXZlIHBhZ2UncyBsYXN0U2Nyb2xsIHByb3AuIElmIHRoZSBsb2NhdGlvbiB3ZSdyZQoJCQkJLy8gc2Nyb2xsaW5nIHRvIGlzIGxlc3MgdGhhbiBtaW5TY3JvbGxCYWNrLCBsZXQgaXQgZ28uCgkJCQlhY3RpdmUubGFzdFNjcm9sbCA9IGN1cnJlbnRTY3JvbGwgPCBtaW5TY3JvbGwgPyBkZWZhdWx0U2Nyb2xsIDogY3VycmVudFNjcm9sbDsKCQkJfQoJCX0sCgoJCV9kZWxheWVkUmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJc2V0VGltZW91dCggJC5wcm94eSh0aGlzLCAiX3JlY29yZFNjcm9sbCIpLCAxMDAgKTsKCQl9LAoKCQlfZ2V0U2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMud2luZG93LnNjcm9sbFRvcCgpOwoJCX0sCgoJCV9nZXRNaW5TY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubWluU2Nyb2xsQmFjazsKCQl9LAoKCQlfZ2V0RGVmYXVsdFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQl9LAoKCQlfZmlsdGVyTmF2aWdhdGVFdmVudHM6IGZ1bmN0aW9uKCBlLCBkYXRhICkgewoJCQl2YXIgdXJsOwoKCQkJaWYgKCBlLm9yaWdpbmFsRXZlbnQgJiYgZS5vcmlnaW5hbEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl1cmwgPSBlLm9yaWdpbmFsRXZlbnQudHlwZS5pbmRleE9mKCAiaGFzaGNoYW5nZSIgKSA+IC0xID8gZGF0YS5zdGF0ZS5oYXNoIDogZGF0YS5zdGF0ZS51cmw7CgoJCQlpZiAoICF1cmwgKSB7CgkJCQl1cmwgPSB0aGlzLl9nZXRIYXNoKCk7CgkJCX0KCgkJCWlmICggIXVybCB8fCB1cmwgPT09ICIjIiB8fCB1cmwuaW5kZXhPZiggIiMiICsgJC5tb2JpbGUucGF0aC51aVN0YXRlS2V5ICkgPT09IDAgKSB7CgkJCQl1cmwgPSBsb2NhdGlvbi5ocmVmOwoJCQl9CgoJCQl0aGlzLl9oYW5kbGVOYXZpZ2F0ZSggdXJsLCBkYXRhLnN0YXRlICk7CgkJfSwKCgkJX2dldEhhc2g6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQl9LAoKCQkvLyBUT0RPIGFjdGl2ZSBwYWdlIHNob3VsZCBiZSBtYW5hZ2VkIGJ5IHRoZSBjb250YWluZXIgKGllLCBpdCBzaG91bGQgYmUgYSBwcm9wZXJ0eSkKCQlnZXRBY3RpdmVQYWdlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuYWN0aXZlUGFnZTsKCQl9LAoKCQkvLyBUT0RPIHRoZSBmaXJzdCBwYWdlIHNob3VsZCBiZSBhIHByb3BlcnR5IHNldCBkdXJpbmcgX2NyZWF0ZSB1c2luZyB0aGUgbG9naWMKCQkvLyAgICAgIHRoYXQgY3VycmVudGx5IHJlc2lkZXMgaW4gaW5pdAoJCV9nZXRJbml0aWFsQ29udGVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJfSwKCgkJLy8gVE9ETyBlYWNoIGNvbnRlbnQgY29udGFpbmVyIHNob3VsZCBoYXZlIGEgaGlzdG9yeSBvYmplY3QKCQlfZ2V0SGlzdG9yeTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoJCX0sCgoJCS8vIFRPRE8gdXNlIF9nZXRIaXN0b3J5CgkJX2dldEFjdGl2ZUhpc3Rvcnk6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKTsKCQl9LAoKCQkvLyBUT0RPIHRoZSBkb2N1bWVudCBiYXNlIHNob3VsZCBiZSBkZXRlcm1pbmVkIGF0IGNyZWF0aW9uCgkJX2dldERvY3VtZW50QmFzZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZTsKCQl9LAoKCQliYWNrOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5nbyggLTEgKTsKCQl9LAoKCQlmb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5nbyggMSApOwoJCX0sCgoJCWdvOiBmdW5jdGlvbiggc3RlcHMgKSB7CgoJCQkvL2lmIGhhc2hsaXN0ZW5pbmcgaXMgZW5hYmxlZCB1c2UgbmF0aXZlIGhpc3RvcnkgbWV0aG9kCgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQl3aW5kb3cuaGlzdG9yeS5nbyggc3RlcHMgKTsKCQkJfSBlbHNlIHsKCgkJCQkvL3dlIGFyZSBub3QgbGlzdGVuaW5nIHRvIHRoZSBoYXNoIHNvIGhhbmRsZSBoaXN0b3J5IGludGVybmFsbHkKCQkJCXZhciBhY3RpdmVJbmRleCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWN0aXZlSW5kZXgsCgkJCQkJaW5kZXggPSBhY3RpdmVJbmRleCArIHBhcnNlSW50KCBzdGVwcywgMTAgKSwKCQkJCQl1cmwgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnN0YWNrWyBpbmRleCBdLnVybCwKCQkJCQlkaXJlY3Rpb24gPSAoIHN0ZXBzID49IDEgKT8gImZvcndhcmQiIDogImJhY2siOwoKCQkJCS8vdXBkYXRlIHRoZSBoaXN0b3J5IG9iamVjdAoJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9IGluZGV4OwoJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5wcmV2aW91c0luZGV4ID0gYWN0aXZlSW5kZXg7CgoJCQkJLy9jaGFuZ2UgdG8gdGhlIG5ldyBwYWdlCgkJCQl0aGlzLmNoYW5nZSggdXJsLCB7IGRpcmVjdGlvbjogZGlyZWN0aW9uLCBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJfSwKCgkJLy8gVE9ETyByZW5hbWUgX2hhbmRsZURlc3RpbmF0aW9uCgkJX2hhbmRsZURlc3RpbmF0aW9uOiBmdW5jdGlvbiggdG8gKSB7CgkJCXZhciBoaXN0b3J5OwoKCQkJLy8gY2xlYW4gdGhlIGhhc2ggZm9yIGNvbXBhcmlzb24gaWYgaXQncyBhIHVybAoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJdG8gPSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggdG8gKTsKCQkJfQoKCQkJaWYgKCB0byApIHsKCQkJCWhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCk7CgoJCQkJLy8gQXQgdGhpcyBwb2ludCwgJ3RvJyBjYW4gYmUgb25lIG9mIDMgdGhpbmdzLCBhIGNhY2hlZCBwYWdlCgkJCQkvLyBlbGVtZW50IGZyb20gYSBoaXN0b3J5IHN0YWNrIGVudHJ5LCBhbiBpZCwgb3Igc2l0ZS1yZWxhdGl2ZSAvCgkJCQkvLyBhYnNvbHV0ZSBVUkwuIElmICd0bycgaXMgYW4gaWQsIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBhZ2FpbnN0CgkJCQkvLyB0aGUgZG9jdW1lbnRCYXNlLCBub3QgdGhlIGxvY2F0aW9uLmhyZWYsIHNpbmNlIHRoZSBoYXNoY2hhbmdlCgkJCQkvLyBjb3VsZCd2ZSBiZWVuIHRoZSByZXN1bHQgb2YgYSBmb3J3YXJkL2JhY2t3YXJkIG5hdmlnYXRpb24KCQkJCS8vIHRoYXQgY3Jvc3NlcyBmcm9tIGFuIGV4dGVybmFsIHBhZ2UvZGlhbG9nIHRvIGFuIGludGVybmFsCgkJCQkvLyBwYWdlL2RpYWxvZy4KCQkJCS8vCgkJCQkvLyBUT0RPIG1vdmUgY2hlY2sgdG8gaGlzdG9yeSBvYmplY3Qgb3IgcGF0aCBvYmplY3Q/CgkJCQl0byA9ICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggdG8gKSA/ICggJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIHRvLCB0aGlzLl9nZXREb2N1bWVudEJhc2UoKSApICkgOiB0bzsKCgkJCQkvLyBJZiB3ZSdyZSBhYm91dCB0byBnbyB0byBhbiBpbml0aWFsIFVSTCB0aGF0IGNvbnRhaW5zIGEKCQkJCS8vIHJlZmVyZW5jZSB0byBhIG5vbi1leGlzdGVudCBpbnRlcm5hbCBwYWdlLCBnbyB0byB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgaW5zdGVhZC4gV2Uga25vdyB0aGF0IHRoZSBpbml0aWFsIGhhc2ggcmVmZXJzIHRvIGEKCQkJCS8vIG5vbi1leGlzdGVudCBwYWdlLCBiZWNhdXNlIHRoZSBpbml0aWFsIGhhc2ggZGlkIG5vdCBlbmQKCQkJCS8vIHVwIGluIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdD8KCQkJCWlmICggdG8gPT09ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBoaXN0b3J5LmluaXRpYWxEc3QsIHRoaXMuX2dldERvY3VtZW50QmFzZSgpICkgJiYKCQkJCQloaXN0b3J5LnN0YWNrLmxlbmd0aCAmJgoJCQkJCWhpc3Rvcnkuc3RhY2tbMF0udXJsICE9PSBoaXN0b3J5LmluaXRpYWxEc3QucmVwbGFjZSggJC5tb2JpbGUuZGlhbG9nSGFzaEtleSwgIiIgKSApIHsKCQkJCQl0byA9IHRoaXMuX2dldEluaXRpYWxDb250ZW50KCk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRvIHx8IHRoaXMuX2dldEluaXRpYWxDb250ZW50KCk7CgkJfSwKCgkJX2hhbmRsZURpYWxvZzogZnVuY3Rpb24oIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhICkgewoJCQl2YXIgdG8sIGFjdGl2ZSwgYWN0aXZlQ29udGVudCA9IHRoaXMuZ2V0QWN0aXZlUGFnZSgpOwoKCQkJLy8gSWYgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBub3QgYSBkaWFsb2cgc2tpcCB0aGUgZGlhbG9nIGFuZCBjb250aW51ZQoJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJaWYgKCBhY3RpdmVDb250ZW50ICYmICFhY3RpdmVDb250ZW50Lmhhc0NsYXNzKCAidWktZGlhbG9nIiApICkgewoJCQkJLy8gZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUKCQkJCS8vIGFjY29yZGluZ2x5IHBhc3QgdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQlpZiAoIGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIgKSB7CgkJCQkJdGhpcy5iYWNrKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZm9yd2FyZCgpOwoJCQkJfQoKCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJLy8gdG8gYSBkaWFsb2cgdXNlIHRoZSBkaWFsb2cgb2JqZWN0ZWQgc2F2ZWQgaW4gdGhlIHN0YWNrCgkJCQl0byA9IGRhdGEucGFnZVVybDsKCQkJCWFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKTsKCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJLy8gYXMgbW9zdCBvZiB0aGlzIGlzIGxvc3QgYnkgdGhlIGRvbUNhY2hlIGNsZWFuaW5nCgkJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIHsKCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQl0cmFuc2l0aW9uOiBhY3RpdmUudHJhbnNpdGlvbiwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9KTsKCQkJfQoKCQkJcmV0dXJuIHRvOwoJCX0sCgoJCV9oYW5kbGVOYXZpZ2F0ZTogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJLy9maW5kIGZpcnN0IHBhZ2UgdmlhIGhhc2gKCQkJLy8gVE9ETyBzdHJpcHBpbmcgdGhlIGhhc2ggdHdpY2Ugd2l0aCBoYW5kbGVVcmwKCQkJdmFyIHRvID0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIHVybCApLCBoaXN0b3J5ID0gdGhpcy5fZ2V0SGlzdG9yeSgpLAoKCQkJCS8vIHRyYW5zaXRpb24gaXMgZmFsc2UgaWYgaXQncyB0aGUgZmlyc3QgcGFnZSwgdW5kZWZpbmVkCgkJCQkvLyBvdGhlcndpc2UgKGFuZCBtYXkgYmUgb3ZlcnJpZGRlbiBieSBkZWZhdWx0KQoJCQkJdHJhbnNpdGlvbiA9IGhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAwID8gIm5vbmUiIDogdW5kZWZpbmVkLAoKCQkJCS8vIGRlZmF1bHQgb3B0aW9ucyBmb3IgdGhlIGNoYW5nUGFnZSBjYWxscyBtYWRlIGFmdGVyIGV4YW1pbmluZwoJCQkJLy8gdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIHBhZ2UgYW5kIHRoZSBoYXNoLCBOT1RFIHRoYXQgdGhlCgkJCQkvLyB0cmFuc2l0aW9uIGlzIGRlcml2ZWQgZnJvbSB0aGUgcHJldmlvdXMgaGlzdG9yeSBlbnRyeQoJCQkJY2hhbmdlUGFnZU9wdGlvbnMgPSB7CgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUsCgkJCQkJcmV2ZXJzZTogZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIgoJCQkJfTsKCgkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgZGF0YSwgewoJCQkJdHJhbnNpdGlvbjogKCBoaXN0b3J5LmdldExhc3QoKSB8fCB7fSApLnRyYW5zaXRpb24gfHwgdHJhbnNpdGlvbgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSB0byBfaGFuZGxlRGVzdGluYXRpb24gPwoJCQkvLyBJZiB0aGlzIGlzbid0IHRoZSBmaXJzdCBwYWdlLCBpZiB0aGUgY3VycmVudCB1cmwgaXMgYSBkaWFsb2cgaGFzaAoJCQkvLyBrZXksIGFuZCB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbiBpc24ndCBlcXVhbCB0byB0aGUgY3VycmVudCB0YXJnZXQKCQkJLy8gcGFnZSwgdXNlIHRoZSBzcGVjaWFsIGRpYWxvZyBoYW5kbGluZwoJCQlpZiAoIGhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICYmCgkJCQl0by5pbmRleE9mKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJaGlzdG9yeS5pbml0aWFsRHN0ICE9PSB0byApIHsKCgkJCQl0byA9IHRoaXMuX2hhbmRsZURpYWxvZyggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKTsKCgkJCQlpZiAoIHRvID09PSBmYWxzZSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCXRoaXMuX2NoYW5nZUNvbnRlbnQoIHRoaXMuX2hhbmRsZURlc3RpbmF0aW9uKCB0byApLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCX0sCgoJCV9jaGFuZ2VDb250ZW50OiBmdW5jdGlvbiggdG8sIG9wdHMgKSB7CgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHRvLCBvcHRzICk7CgkJfSwKCgkJX2dldEJhc2U6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuYmFzZTsKCQl9LAoKCQlfZ2V0TnM6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubnM7CgkJfSwKCgkJX2VuaGFuY2U6IGZ1bmN0aW9uKCBjb250ZW50LCByb2xlICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIHN1cHBvcnRpbmcgYSBjdXN0b20gY2FsbGJhY2ssIGFuZCBwYXNzaW5nIGluCgkJCS8vIHRoZSBzZXR0aW5ncyB3aGljaCBpbmNsdWRlcyB0aGUgcm9sZQoJCQlyZXR1cm4gY29udGVudC5wYWdlKHsgcm9sZTogcm9sZSB9KTsKCQl9LAoKCQlfaW5jbHVkZTogZnVuY3Rpb24oIHBhZ2UsIHNldHRpbmdzICkgewoJCQkvLyBhcHBlbmQgdG8gcGFnZSBhbmQgZW5oYW5jZQoJCQlwYWdlLmFwcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCgkJCS8vIHVzZSB0aGUgcGFnZSB3aWRnZXQgdG8gZW5oYW5jZQoJCQl0aGlzLl9lbmhhbmNlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCQkvLyByZW1vdmUgcGFnZSBvbiBoaWRlCgkJCXBhZ2UucGFnZSggImJpbmRSZW1vdmUiICk7CgkJfSwKCgkJX2ZpbmQ6IGZ1bmN0aW9uKCBhYnNVcmwgKSB7CgkJCS8vIFRPRE8gY29uc2lkZXIgc3VwcG9ydGluZyBhIGN1c3RvbSBjYWxsYmFjawoJCQl2YXIgZmlsZVVybCA9IHRoaXMuX2NyZWF0ZUZpbGVVcmwoIGFic1VybCApLAoJCQkJZGF0YVVybCA9IHRoaXMuX2NyZWF0ZURhdGFVcmwoIGFic1VybCApLAoJCQkJcGFnZSwgaW5pdGlhbENvbnRlbnQgPSB0aGlzLl9nZXRJbml0aWFsQ29udGVudCgpOwoKCQkJLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBwYWdlIGFscmVhZHkgZXhpc3RzIGluIHRoZSBET00uCgkJCS8vIE5PVEUgZG8gX25vdF8gdXNlIHRoZSA6anFtRGF0YSBwc2V1ZG8gc2VsZWN0b3IgYmVjYXVzZSBwYXJlbnRoZXNpcwoJCQkvLyAgICAgIGFyZSBhIHZhbGlkIHVybCBjaGFyIGFuZCBpdCBicmVha3Mgb24gdGhlIGZpcnN0IG9jY3VyZW5jZQoJCQlwYWdlID0gdGhpcy5lbGVtZW50CgkJCQkuY2hpbGRyZW4oICJbZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgoJCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCB0aGUgcGFnZSwgY2hlY2sgdG8gc2VlIGlmIHRoZSB1cmwgaXMgYQoJCQkvLyByZWZlcmVuY2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4gSWYgc28sIGl0IG1heSBoYXZlIGJlZW4gZHluYW1pY2FsbHkKCQkJLy8gaW5qZWN0ZWQgYnkgYSBkZXZlbG9wZXIsIGluIHdoaWNoIGNhc2UgaXQgd291bGQgYmUgbGFja2luZyBhCgkJCS8vIGRhdGEtdXJsIGF0dHJpYnV0ZSBhbmQgaW4gbmVlZCBvZiBlbmhhbmNlbWVudC4KCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJiBkYXRhVXJsICYmICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZGF0YVVybCApICkgewoJCQkJcGFnZSA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggJC5tb2JpbGUucGF0aC5oYXNoVG9TZWxlY3RvcigiIyIgKyBkYXRhVXJsKSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybCIsIGRhdGFVcmwgKQoJCQkJCS5qcW1EYXRhKCAidXJsIiwgZGF0YVVybCApOwoJCQl9CgoJCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCBhIHBhZ2UgaW4gdGhlIERPTSwgY2hlY2sgdGhlIFVSTCB0byBzZWUgaWYgaXQKCQkJLy8gcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBhcHBsaWNhdGlvbi4gQWxzbyBjaGVjayB0byBtYWtlIHN1cmUKCQkJLy8gb3VyIGNhY2hlZC1maXJzdC1wYWdlIGlzIGFjdHVhbGx5IGluIHRoZSBET00uIFNvbWUgdXNlciBkZXBsb3llZAoJCQkvLyBhcHBzIGFyZSBwcnVuaW5nIHRoZSBmaXJzdCBwYWdlIGZyb20gdGhlIERPTSBmb3IgdmFyaW91cyByZWFzb25zLgoJCQkvLyBXZSBjaGVjayBmb3IgdGhpcyBjYXNlIGhlcmUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGEgZmlyc3QtcGFnZSB3aXRoCgkJCS8vIGFuIGlkIGZhbGxpbmcgdGhyb3VnaCB0byB0aGUgbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UgZXJyb3IgY2FzZS4KCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0ZpcnN0UGFnZVVybCggZmlsZVVybCApICYmCgkJCQlpbml0aWFsQ29udGVudCAmJgoJCQkJaW5pdGlhbENvbnRlbnQucGFyZW50KCkubGVuZ3RoICkgewoJCQkJcGFnZSA9ICQoIGluaXRpYWxDb250ZW50ICk7CgkJCX0KCgkJCXJldHVybiBwYWdlOwoJCX0sCgoJCV9nZXRMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubG9hZGluZygpOwoJCX0sCgoJCV9zaG93TG9hZGluZzogZnVuY3Rpb24oIGRlbGF5LCB0aGVtZSwgbXNnLCB0ZXh0b25seSApIHsKCQkJLy8gVGhpcyBjb25maWd1cmFibGUgdGltZW91dCBhbGxvd3MgY2FjaGVkIHBhZ2VzIGEgYnJpZWYKCQkJLy8gZGVsYXkgdG8gbG9hZCB3aXRob3V0IHNob3dpbmcgYSBtZXNzYWdlCgkJCWlmICggdGhpcy5fbG9hZE1zZyApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdGhpcy5fbG9hZE1zZyA9IHNldFRpbWVvdXQoJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2dldExvYWRlcigpLmxvYWRlciggInNob3ciLCB0aGVtZSwgbXNnLCB0ZXh0b25seSApOwoJCQkJdGhpcy5fbG9hZE1zZyA9IDA7CgkJCX0sIHRoaXMpLCBkZWxheSApOwoJCX0sCgoJCV9oaWRlTG9hZGluZzogZnVuY3Rpb24oKSB7CgkJCS8vIFN0b3AgbWVzc2FnZSBzaG93IHRpbWVyCgkJCWNsZWFyVGltZW91dCggdGhpcy5fbG9hZE1zZyApOwoJCQl0aGlzLl9sb2FkTXNnID0gMDsKCgkJCS8vIEhpZGUgbG9hZGluZyBtZXNzYWdlCgkJCXRoaXMuX2dldExvYWRlcigpLmxvYWRlciggImhpZGUiICk7CgkJfSwKCgkJX3Nob3dFcnJvcjogZnVuY3Rpb24oKSB7CgkJCS8vIG1ha2Ugc3VyZSB0byByZW1vdmUgdGhlIGN1cnJlbnQgbG9hZGluZyBtZXNzYWdlCgkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgoJCQkvLyBzaG93IHRoZSBlcnJvciBtZXNzYWdlCgkJCXRoaXMuX3Nob3dMb2FkaW5nKCAwLCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lLCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZSwgdHJ1ZSApOwoKCQkJLy8gaGlkZSB0aGUgZXJyb3IgbWVzc2FnZSBhZnRlciBhIGRlbGF5CgkJCS8vIFRPRE8gY29uZmlndXJhdGlvbgoJCQlzZXRUaW1lb3V0KCAkLnByb3h5KHRoaXMsICJfaGlkZUxvYWRpbmciKSwgMTUwMCApOwoJCX0sCgoJCV9wYXJzZTogZnVuY3Rpb24oIGh0bWwsIGZpbGVVcmwgKSB7CgkJCS8vIFRPRE8gY29uc2lkZXIgYWxsb3dpbmcgY3VzdG9taXphdGlvbiBvZiB0aGlzIG1ldGhvZC4gSXQncyB2ZXJ5IEpRTSBzcGVjaWZpYwoJCQl2YXIgcGFnZSwgYWxsID0gJCggIjxkaXY+PC9kaXY+IiApOwoKCQkJLy93b3JrYXJvdW5kIHRvIGFsbG93IHNjcmlwdHMgdG8gZXhlY3V0ZSB3aGVuIGluY2x1ZGVkIGluIHBhZ2UgZGl2cwoJCQlhbGwuZ2V0KCAwICkuaW5uZXJIVE1MID0gaHRtbDsKCgkJCXBhZ2UgPSBhbGwuZmluZCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmlyc3QoKTsKCgkJCS8vaWYgcGFnZSBlbGVtIGNvdWxkbid0IGJlIGZvdW5kLCBjcmVhdGUgb25lIGFuZCBpbnNlcnQgdGhlIGJvZHkgZWxlbWVudCdzIGNvbnRlbnRzCgkJCWlmICggIXBhZ2UubGVuZ3RoICkgewoJCQkJcGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAicm9sZT0ncGFnZSc+IiArCgkJCQkJKCBodG1sLnNwbGl0KCAvPFwvP2JvZHlbXj5dKj4vZ21pIClbMV0gfHwgIiIgKSArCgkJCQkJIjwvZGl2PiIgKTsKCQkJfQoKCQkJLy8gVE9ETyB0YWdnaW5nIGEgcGFnZSB3aXRoIGV4dGVybmFsIHRvIG1ha2Ugc3VyZSB0aGF0IGVtYmVkZGVkIHBhZ2VzIGFyZW4ndAoJCQkvLyByZW1vdmVkIGJ5IHRoZSB2YXJpb3VzIHBhZ2UgaGFuZGxpbmcgY29kZSBpcyBiYWQuIEhhdmluZyBwYWdlIGhhbmRsaW5nIGNvZGUKCQkJLy8gaW4gbWFueSBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJcGFnZS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmwiLCAkLm1vYmlsZS5wYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoZmlsZVVybCkgKQoJCQkJLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICk7CgoJCQlyZXR1cm4gcGFnZTsKCQl9LAoKCQlfc2V0TG9hZGVkVGl0bGU6IGZ1bmN0aW9uKCBwYWdlLCBodG1sICkgewoJCQkvL3BhZ2UgdGl0bGUgcmVnZXhwCgkJCXZhciBuZXdQYWdlVGl0bGUgPSBodG1sLm1hdGNoKCAvPHRpdGxlW14+XSo+KFtePF0qKS8gKSAmJiBSZWdFeHAuJDE7CgoJCQlpZiAoIG5ld1BhZ2VUaXRsZSAmJiAhcGFnZS5qcW1EYXRhKCJ0aXRsZSIpICkgewoJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJcGFnZS5qcW1EYXRhKCAidGl0bGUiLCBuZXdQYWdlVGl0bGUgKTsKCQkJfQoJCX0sCgoJCV9pc1Jld3JpdGFibGVCYXNlVGFnOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmR5bmFtaWNCYXNlRW5hYmxlZCAmJiAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnOwoJCX0sCgoJCV9jcmVhdGVEYXRhVXJsOiBmdW5jdGlvbiggYWJzb2x1dGVVcmwgKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic29sdXRlVXJsICk7CgkJfSwKCgkJX2NyZWF0ZUZpbGVVcmw6IGZ1bmN0aW9uKCBhYnNvbHV0ZVVybCApIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoIGFic29sdXRlVXJsICk7CgkJfSwKCgkJX3RyaWdnZXJXaXRoRGVwcmVjYXRlZDogZnVuY3Rpb24oIG5hbWUsIGRhdGEsIHBhZ2UgKSB7CgkJCXZhciBkZXByZWNhdGVkRXZlbnQgPSAkLkV2ZW50KCAicGFnZSIgKyBuYW1lICksCgkJCQluZXdFdmVudCA9ICQuRXZlbnQoIHRoaXMud2lkZ2V0TmFtZSArIG5hbWUgKTsKCgkJCS8vIERFUFJFQ0FURUQKCQkJLy8gdHJpZ2dlciB0aGUgb2xkIGRlcHJlY2F0ZWQgZXZlbnQgb24gdGhlIHBhZ2UgaWYgaXQncyBwcm92aWRlZAoJCQkoIHBhZ2UgfHwgdGhpcy5lbGVtZW50ICkudHJpZ2dlciggZGVwcmVjYXRlZEV2ZW50LCBkYXRhICk7CgoJCQkvLyB1c2UgdGhlIHdpZGdldCB0cmlnZ2VyIG1ldGhvZCBmb3IgdGhlIG5ldyBjb250ZW50KiBldmVudAoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggbmV3RXZlbnQsIGRhdGEgKTsKCgkJCXJldHVybiB7CgkJCQlkZXByZWNhdGVkRXZlbnQ6IGRlcHJlY2F0ZWRFdmVudCwKCQkJCWV2ZW50OiBuZXdFdmVudAoJCQl9OwoJCX0sCgoJCS8vIFRPRE8gaXQgd291bGQgYmUgbmljZSB0byBzcGxpdCB0aGlzIHVwIG1vcmUgYnV0IGV2ZXJ5dGhpbmcgYXBwZWFycyB0byBiZSAib25lIG9mZiIKCQkvLyAgICAgIG9yIHJlcXVpcmUgb3JkZXJpbmcgc3VjaCB0aGF0IG90aGVyIGJpdHMgYXJlIHNwcmlua2xlZCBpbiBiZXR3ZWVuIHBhcnRzIHRoYXQKCQkvLyAgICAgIGNvdWxkIGJlIGFic3RyYWN0ZWQgb3V0IGFzIGEgZ3JvdXAKCQlfbG9hZFN1Y2Nlc3M6IGZ1bmN0aW9uKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSB7CgkJCXZhciBmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICksCgkJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICk7CgoJCQlyZXR1cm4gJC5wcm94eShmdW5jdGlvbiggaHRtbCwgdGV4dFN0YXR1cywgeGhyICkgewoJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCS8vdXNlIGl0IGFzIHRoZSBuZXcgZmlsZVVybCwgYmFzZSBwYXRoLCBldGMKCQkJCXZhciBjb250ZW50LAoKCQkJCQkvLyBUT0RPIGhhbmRsZSBkaWFsb2dzIGFnYWluCgkJCQkJcGFnZUVsZW1SZWdleCA9IG5ldyBSZWdFeHAoICIoPFtePl0rXFxiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoKCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmw9W1wiJ10/KFteXCInPl0qKVtcIiddPyIgKTsKCgkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMKCQkJCS8vIGNhbiBiZSBkaXJlY3RlZCB0byB0aGUgY29ycmVjdCB1cmwuIGxvYWRpbmcgaW50byBhIHRlbXByb3JhcnkKCQkJCS8vIGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCWlmICggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkgJiYKCQkJCQlSZWdFeHAuJDEgJiYKCQkJCQlkYXRhVXJsUmVnZXgudGVzdCggUmVnRXhwLiQxICkgJiYKCQkJCQlSZWdFeHAuJDEgKSB7CgkJCQkJZmlsZVVybCA9ICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoICQoIjxkaXY+IiArIFJlZ0V4cC4kMSArICI8L2Rpdj4iKS50ZXh0KCkgKTsKCQkJCX0KCgkJCQkvL2RvbnQgdXBkYXRlIHRoZSBiYXNlIHRhZyBpZiB3ZSBhcmUgcHJlZmV0Y2hpbmcKCQkJCWlmICggc2V0dGluZ3MucHJlZmV0Y2ggPT09IHVuZGVmaW5lZCApIHsKCQkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCBmaWxlVXJsICk7CgkJCQl9CgoJCQkJY29udGVudCA9IHRoaXMuX3BhcnNlKCBodG1sLCBmaWxlVXJsICk7CgoJCQkJdGhpcy5fc2V0TG9hZGVkVGl0bGUoIGNvbnRlbnQsIGh0bWwgKTsKCgkJCQkvLyBBZGQgdGhlIGNvbnRlbnQgcmVmZXJlbmNlIGFuZCB4aHIgdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgoJCQkJLy8gREVQUkVDQVRFRAoJCQkJdHJpZ2dlckRhdGEucGFnZSA9IGNvbnRlbnQ7CgoJCQkJdHJpZ2dlckRhdGEuY29udGVudCA9IGNvbnRlbnQ7CgoJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkvLyBOb3RlIHRoYXQgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBsaXN0ZW5lci9oYW5kbGVyCgkJCQkvLyB0aGF0IGNhbGxlZCBwcmV2ZW50RGVmYXVsdCgpLCB0byByZXNvbHZlL3JlamVjdCB0aGUKCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJaWYgKCAhdGhpcy5fdHJpZ2dlciggImxvYWQiLCB1bmRlZmluZWQsIHRyaWdnZXJEYXRhICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIHJld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsIGlmIHRoZSBiYXNlIHRhZyB3b24ndCB3b3JrCgkJCQlpZiAoIHRoaXMuX2lzUmV3cml0YWJsZUJhc2VUYWcoKSAmJiBjb250ZW50ICkgewoJCQkJCXRoaXMuX2dldEJhc2UoKS5yZXdyaXRlKCBmaWxlVXJsLCBjb250ZW50ICk7CgkJCQl9CgoJCQkJdGhpcy5faW5jbHVkZSggY29udGVudCwgc2V0dGluZ3MgKTsKCgkJCQkvLyBFbmhhbmNpbmcgdGhlIGNvbnRlbnQgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgY29udGVudCBiZWluZyBpbnNlcnRlZAoJCQkJLy8gaW50byB0aGUgRE9NLiBJZiB0aGUgb3JpZ2luYWwgYWJzVXJsIHJlZmVycyB0byBhIHN1Yi1jb250ZW50LCB0aGF0IGlzIHRoZQoJCQkJLy8gcmVhbCBjb250ZW50IHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJaWYgKCBhYnNVcmwuaW5kZXhPZiggIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSApID4gLTEgKSB7CgkJCQkJY29udGVudCA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggIltkYXRhLSIgKyB0aGlzLl9nZXROcygpICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCQkJCX0KCgkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoJCQkJfQoKCQkJCS8vIEJFR0lOIERFUFJFQ0FURUQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIGNvbnRlbnQgbG9hZGVkIHN1Y2Nlc3NmdWxseS4KCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAicGFnZWxvYWQiICk7CgkJCQkvLyBFTkQgREVQUkVDQVRFRCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgc2V0dGluZ3MsIGNvbnRlbnQgKTsKCQkJfSwgdGhpcyk7CgkJfSwKCgkJX2xvYWREZWZhdWx0czogewoJCQl0eXBlOiAiZ2V0IiwKCQkJZGF0YTogdW5kZWZpbmVkLAoKCQkJLy8gREVQUkVDQVRFRAoJCQlyZWxvYWRQYWdlOiBmYWxzZSwKCgkJCXJlbG9hZDogZmFsc2UsCgoJCQkvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJCXJvbGU6IHVuZGVmaW5lZCwKCgkJCXNob3dMb2FkTXNnOiBmYWxzZSwKCgkJCS8vIFRoaXMgZGVsYXkgYWxsb3dzIGxvYWRzIHRoYXQgcHVsbCBmcm9tIGJyb3dzZXIgY2FjaGUgdG8KCQkJLy8gb2NjdXIgd2l0aG91dCBzaG93aW5nIHRoZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCWxvYWRNc2dEZWxheTogNTAKCQl9LAoKCQlsb2FkOiBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCQkvLyBUaGlzIGZ1bmN0aW9uIHVzZXMgZGVmZXJyZWQgbm90aWZpY2F0aW9ucyB0byBsZXQgY2FsbGVycwoJCQkvLyBrbm93IHdoZW4gdGhlIGNvbnRlbnQgaXMgZG9uZSBsb2FkaW5nLCBvciBpZiBhbiBlcnJvciBoYXMgb2NjdXJyZWQuCgkJCXZhciBkZWZlcnJlZCA9ICggb3B0aW9ucyAmJiBvcHRpb25zLmRlZmVycmVkICkgfHwgJC5EZWZlcnJlZCgpLAoKCQkJCS8vIFRoZSBkZWZhdWx0IGxvYWQgb3B0aW9ucyB3aXRoIG92ZXJyaWRlcyBzcGVjaWZpZWQgYnkgdGhlIGNhbGxlci4KCQkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCB0aGlzLl9sb2FkRGVmYXVsdHMsIG9wdGlvbnMgKSwKCgkJCQkvLyBUaGUgRE9NIGVsZW1lbnQgZm9yIHRoZSBjb250ZW50IGFmdGVyIGl0IGhhcyBiZWVuIGxvYWRlZC4KCQkJCWNvbnRlbnQgPSBudWxsLAoKCQkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgcGFzc2VkIGludG8gdGhlIGZ1bmN0aW9uLiBUaGlzCgkJCQkvLyB2ZXJzaW9uIG9mIHRoZSBVUkwgbWF5IGNvbnRhaW4gZGlhbG9nL3N1YmNvbnRlbnQgcGFyYW1zIGluIGl0LgoJCQkJYWJzVXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgdGhpcy5fZmluZEJhc2VXaXRoRGVmYXVsdCgpICksCgkJCQlmaWxlVXJsLCBkYXRhVXJsLCBwYmxFdmVudCwgdHJpZ2dlckRhdGE7CgoJCQkvLyBERVBSRUNBVEVEIHJlbG9hZFBhZ2UKCQkJc2V0dGluZ3MucmVsb2FkID0gc2V0dGluZ3MucmVsb2FkUGFnZTsKCgkJCS8vIElmIHRoZSBjYWxsZXIgcHJvdmlkZWQgZGF0YSwgYW5kIHdlJ3JlIHVzaW5nICJnZXQiIHJlcXVlc3QsCgkJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gImdldCIgKSB7CgkJCQlhYnNVcmwgPSAkLm1vYmlsZS5wYXRoLmFkZFNlYXJjaFBhcmFtcyggYWJzVXJsLCBzZXR0aW5ncy5kYXRhICk7CgkJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCQl9CgoJCQkvLyBJZiB0aGUgY2FsbGVyIGlzIHVzaW5nIGEgInBvc3QiIHJlcXVlc3QsIHJlbG9hZCBtdXN0IGJlIHRydWUKCQkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJwb3N0IiApIHsKCQkJCXNldHRpbmdzLnJlbG9hZCA9IHRydWU7CgkJCX0KCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJjb250ZW50IHBhcmFtcy4KCQkJLy8gSW4gb3RoZXJ3b3JkcyB0aGUgcmVhbCBVUkwgb2YgdGhlIGNvbnRlbnQgdG8gYmUgbG9hZGVkLgoJCQlmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICk7CgoJCQkvLyBUaGUgdmVyc2lvbiBvZiB0aGUgVXJsIGFjdHVhbGx5IHN0b3JlZCBpbiB0aGUgZGF0YS11cmwgYXR0cmlidXRlIG9mCgkJCS8vIHRoZSBjb250ZW50LiBGb3IgZW1iZWRkZWQgY29udGVudCwgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvcgoJCQkvLyBjb250ZW50IHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlCgkJCS8vIHJlbGF0aXZlIHBhdGguIEZvciBjcm9zcy1kb21haW4gY29udGVudCAoUGhvbmUgR2FwIG9ubHkpIHRoZSBlbnRpcmUKCQkJLy8gYWJzb2x1dGUgVXJsIGlzIHVzZWQgdG8gbG9hZCB0aGUgY29udGVudC4KCQkJZGF0YVVybCA9IHRoaXMuX2NyZWF0ZURhdGFVcmwoIGFic1VybCApOwoKCQkJY29udGVudCA9IHRoaXMuX2ZpbmQoIGFic1VybCApOwoKCQkJLy8gSWYgaXQgaXNuJ3QgYSByZWZlcmVuY2UgdG8gdGhlIGZpcnN0IGNvbnRlbnQgYW5kIHJlZmVycyB0byBtaXNzaW5nCgkJCS8vIGVtYmVkZGVkIGNvbnRlbnQgcmVqZWN0IHRoZSBkZWZlcnJlZCBhbmQgcmV0dXJuCgkJCWlmICggY29udGVudC5sZW5ndGggPT09IDAgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNFbWJlZGRlZFBhZ2UoZmlsZVVybCkgJiYKCQkJCSEkLm1vYmlsZS5wYXRoLmlzRmlyc3RQYWdlVXJsKGZpbGVVcmwpICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIHNldHRpbmdzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZQoJCQkvLyBUT0RPIGZpZ3VyZSBvdXQgd2h5IHdlIGRvZSB0aGlzCgkJCXRoaXMuX2dldEJhc2UoKS5yZXNldCgpOwoKCQkJLy8gSWYgdGhlIGNvbnRlbnQgd2UgYXJlIGludGVyZXN0ZWQgaW4gaXMgYWxyZWFkeSBpbiB0aGUgRE9NLAoJCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkJLy8gcmVsb2FkIG9mIHRoZSBmaWxlLCB3ZSBhcmUgZG9uZS4gUmVzb2x2ZSB0aGUgZGVmZXJycmVkIHNvIHRoYXQKCQkJLy8gdXNlcnMgY2FuIGJpbmQgdG8gLmRvbmUgb24gdGhlIHByb21pc2UKCQkJaWYgKCBjb250ZW50Lmxlbmd0aCAmJiAhc2V0dGluZ3MucmVsb2FkICkgewoJCQkJdGhpcy5fZW5oYW5jZSggY29udGVudCwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBzZXR0aW5ncywgY29udGVudCApOwoKCQkJCS8vaWYgd2UgYXJlIHJlbG9hZGluZyB0aGUgY29udGVudCBtYWtlIHN1cmUgd2UgdXBkYXRlCgkJCQkvLyB0aGUgYmFzZSBpZiBpdHMgbm90IGEgcHJlZmV0Y2gKCQkJCWlmICggIXNldHRpbmdzLnByZWZldGNoICkgewoJCQkJCXRoaXMuX2dldEJhc2UoKS5zZXQodXJsKTsKCQkJCX0KCgkJCQlyZXR1cm47CgkJCX0KCgkJCXRyaWdnZXJEYXRhID0gewoJCQkJdXJsOiB1cmwsCgkJCQlhYnNVcmw6IGFic1VybCwKCQkJCWRhdGFVcmw6IGRhdGFVcmwsCgkJCQlkZWZlcnJlZDogZGVmZXJyZWQsCgkJCQlvcHRpb25zOiBzZXR0aW5ncwoJCQl9OwoKCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGxvYWQgY29udGVudC4KCQkJcGJsRXZlbnQgPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJiZWZvcmVsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQlpZiAoIHBibEV2ZW50LmRlcHJlY2F0ZWRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAoJCQkJcGJsRXZlbnQuZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQl0aGlzLl9zaG93TG9hZGluZyggc2V0dGluZ3MubG9hZE1zZ0RlbGF5ICk7CgkJCX0KCgkJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQkJLy8gb25seSByZXNldCBpZiB3ZSBhcmUgbm90IHByZWZldGNoaW5nCgkJCWlmICggc2V0dGluZ3MucHJlZmV0Y2ggPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX2dldEJhc2UoKS5yZXNldCgpOwoJCQl9CgoJCQlpZiAoICEoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyB8fAoJCQkJJC5tb2JpbGUucGF0aC5pc1NhbWVEb21haW4oJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBMb2FkIHRoZSBuZXcgY29udGVudC4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJY29udGVudFR5cGU6IHNldHRpbmdzLmNvbnRlbnRUeXBlLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IHRoaXMuX2xvYWRTdWNjZXNzKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSwKCQkJCWVycm9yOiB0aGlzLl9sb2FkRXJyb3IoIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApCgkJCX0pOwoJCX0sCgoJCV9sb2FkRXJyb3I6IGZ1bmN0aW9uKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSB7CgkJCXJldHVybiAkLnByb3h5KGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJLy9zZXQgYmFzZSBiYWNrIHRvIGN1cnJlbnQgcGF0aAoJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCggJC5tb2JpbGUucGF0aC5nZXQoKSApOwoKCQkJCS8vIEFkZCBlcnJvciBpbmZvIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJdHJpZ2dlckRhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKCgkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQl2YXIgcGxmRXZlbnQgPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJsb2FkZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQlpZiAoIHBsZkV2ZW50LmRlcHJlY2F0ZWRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAoJCQkJCXBsZkV2ZW50LmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQl0aGlzLl9zaG93RXJyb3IoKTsKCQkJCX0KCgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJfSwgdGhpcyk7CgkJfSwKCgkJX2dldFRyYW5zaXRpb25IYW5kbGVyOiBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB0cmFuc2l0aW9uICk7CgoJCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCQkvL2lzbid0IG9uZSBpbiBvdXIgdHJhbnNpdGlvbkhhbmRsZXJzIGRpY3Rpb25hcnksIHVzZSB0aGUgZGVmYXVsdCBvbmUuCgkJCS8vY2FsbCB0aGUgaGFuZGxlciBpbW1lZGlhdGVseSB0byBraWNrLW9mZiB0aGUgdHJhbnNpdGlvbi4KCQkJcmV0dXJuICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVyc1sgdHJhbnNpdGlvbiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlcjsKCQl9LAoKCQkvLyBUT0RPIG1vdmUgaW50byB0cmFuc2l0aW9uIGhhbmRsZXJzPwoJCV90cmlnZ2VyQ3NzVHJhbnNpdGlvbkV2ZW50czogZnVuY3Rpb24oIHRvLCBmcm9tLCBwcmVmaXggKSB7CgkJCXZhciBzYW1lUGFnZSA9IGZhbHNlOwoKCQkJcHJlZml4ID0gcHJlZml4IHx8ICIiOwoKCQkJLy8gVE9ETyBkZWNpZGUgaWYgdGhlc2UgZXZlbnRzIHNob3VsZCBpbiBmYWN0IGJlIHRyaWdnZXJlZCBvbiB0aGUgY29udGFpbmVyCgkJCWlmICggZnJvbSApIHsKCgkJCQkvL0NoZWNrIGlmIHRoaXMgaXMgYSBzYW1lIHBhZ2UgdHJhbnNpdGlvbiBhbmQgdGVsbCB0aGUgaGFuZGxlciBpbiBwYWdlCgkJCQlpZiggdG9bMF0gPT09IGZyb21bMF0gKXsKCQkJCQlzYW1lUGFnZSA9IHRydWU7CgkJCQl9CgoJCQkJLy90cmlnZ2VyIGJlZm9yZSBzaG93L2hpZGUgZXZlbnRzCgkJCQkvLyBUT0RPIGRlcHJlY2F0ZSBuZXh0UGFnZSBpbiBmYXZvciBvZiBuZXh0CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoIHByZWZpeCArICJoaWRlIiwgeyBuZXh0UGFnZTogdG8sIHNhbWVQYWdlOiBzYW1lUGFnZSB9LCBmcm9tICk7CgkJCX0KCgkJCS8vIFRPRE8gZGVwcmVjYXRlIHByZXZQYWdlIGluIGZhdm9yIG9mIHByZXZpb3VzCgkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggcHJlZml4ICsgInNob3ciLCB7IHByZXZQYWdlOiBmcm9tIHx8ICQoICIiICkgfSwgdG8gKTsKCQl9LAoKCQkvLyBUT0RPIG1ha2UgcHJpdmF0ZSBvbmNlIGNoYW5nZSBoYXMgYmVlbiBkZWZpbmVkIGluIHRoZSB3aWRnZXQKCQlfY3NzVHJhbnNpdGlvbjogZnVuY3Rpb24oIHRvLCBmcm9tLCBvcHRpb25zICkgewoJCQl2YXIgdHJhbnNpdGlvbiA9IG9wdGlvbnMudHJhbnNpdGlvbiwKCQkJCXJldmVyc2UgPSBvcHRpb25zLnJldmVyc2UsCgkJCQlkZWZlcnJlZCA9IG9wdGlvbnMuZGVmZXJyZWQsCgkJCQlUcmFuc2l0aW9uSGFuZGxlciwKCQkJCXByb21pc2U7CgoJCQl0aGlzLl90cmlnZ2VyQ3NzVHJhbnNpdGlvbkV2ZW50cyggdG8sIGZyb20sICJiZWZvcmUiICk7CgoJCQkvLyBUT0RPIHB1dCB0aGlzIGluIGEgYmluZGluZyB0byBldmVudHMgKm91dHNpZGUqIHRoZSB3aWRnZXQKCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCgkJCVRyYW5zaXRpb25IYW5kbGVyID0gdGhpcy5fZ2V0VHJhbnNpdGlvbkhhbmRsZXIoIHRyYW5zaXRpb24gKTsKCgkJCXByb21pc2UgPSAoIG5ldyBUcmFuc2l0aW9uSGFuZGxlciggdHJhbnNpdGlvbiwgcmV2ZXJzZSwgdG8sIGZyb20gKSApLnRyYW5zaXRpb24oKTsKCgkJCS8vIFRPRE8gdGVtcG9yYXJ5IGFjY29tb2RhdGlvbiBvZiBhcmd1bWVudCBkZWZlcnJlZAoJCQlwcm9taXNlLmRvbmUoZnVuY3Rpb24oKSB7CgkJCQlkZWZlcnJlZC5yZXNvbHZlLmFwcGx5KCBkZWZlcnJlZCwgYXJndW1lbnRzICk7CgkJCX0pOwoKCQkJcHJvbWlzZS5kb25lKCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl90cmlnZ2VyQ3NzVHJhbnNpdGlvbkV2ZW50cyggdG8sIGZyb20gKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCV9yZWxlYXNlVHJhbnNpdGlvbkxvY2s6IGZ1bmN0aW9uKCkgewoJCQkvL3JlbGVhc2UgdHJhbnNpdGlvbiBsb2NrIHNvIG5hdmlnYXRpb24gaXMgZnJlZSBhZ2FpbgoJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCWlmICggcGFnZVRyYW5zaXRpb25RdWV1ZS5sZW5ndGggPiAwICkgewoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZS5hcHBseSggbnVsbCwgcGFnZVRyYW5zaXRpb25RdWV1ZS5wb3AoKSApOwoJCQl9CgkJfSwKCgkJX3JlbW92ZUFjdGl2ZUxpbmtDbGFzczogZnVuY3Rpb24oIGZvcmNlICkgewoJCQkvL2NsZWFyIG91dCB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZQoJCQkkLm1vYmlsZS5yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIGZvcmNlICk7CgkJfSwKCgkJX2xvYWRVcmw6IGZ1bmN0aW9uKCB0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQkvLyBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUKCQkJLy8gc2ltcGxpZmllZCBlZywgcmVtb3ZpbmcgdWktc3RhdGUsIGFuZCByZW1vdmluZyBxdWVyeSBwYXJhbXMKCQkJLy8gZnJvbSB0aGUgaGFzaCB0aGlzIGlzIHNvIHRoYXQgdXNlcnMgd2hvIHdhbnQgdG8gdXNlIHF1ZXJ5CgkJCS8vIHBhcmFtcyBoYXZlIGFjY2VzcyB0byB0aGVtIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UKCQkJLy8gbGlmZSBjeWNsZSBTZWUgaXNzdWUgIzUwODUKCQkJc2V0dGluZ3MudGFyZ2V0ID0gdG87CgkJCXNldHRpbmdzLmRlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCQkJdGhpcy5sb2FkKCB0bywgc2V0dGluZ3MgKTsKCgkJCXNldHRpbmdzLmRlZmVycmVkLmRvbmUoJC5wcm94eShmdW5jdGlvbiggdXJsLCBvcHRpb25zLCBjb250ZW50ICkgewoJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoKCQkJCS8vIHN0b3JlIHRoZSBvcmlnaW5hbCBhYnNvbHV0ZSB1cmwgc28gdGhhdCBpdCBjYW4gYmUgcHJvdmlkZWQKCQkJCS8vIHRvIGV2ZW50cyBpbiB0aGUgdHJpZ2dlckRhdGEgb2YgdGhlIHN1YnNlcXVlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQlvcHRpb25zLmFic1VybCA9IHRyaWdnZXJEYXRhLmFic1VybDsKCgkJCQl0aGlzLnRyYW5zaXRpb24oIGNvbnRlbnQsIHRyaWdnZXJEYXRhLCBvcHRpb25zICk7CgkJCX0sIHRoaXMpKTsKCgkJCXNldHRpbmdzLmRlZmVycmVkLmZhaWwoJC5wcm94eShmdW5jdGlvbigvKiB1cmwsIG9wdGlvbnMgKi8pIHsKCQkJCXRoaXMuX3JlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJdGhpcy5fcmVsZWFzZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3RyaWdnZXJQYWdlQmVmb3JlQ2hhbmdlOiBmdW5jdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApIHsKCQkJdmFyIHBiY0V2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlY2hhbmdlIiApOwoKCQkJJC5leHRlbmQodHJpZ2dlckRhdGEsIHsgdG9QYWdlOiB0bywgb3B0aW9uczogc2V0dGluZ3MgfSk7CgoJCQkvLyBOT1RFOiBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUKCQkJLy8gc2ltcGxpZmllZCBlZywgcmVtb3ZpbmcgdWktc3RhdGUsIGFuZCByZW1vdmluZyBxdWVyeSBwYXJhbXMgZnJvbQoJCQkvLyB0aGUgaGFzaCB0aGlzIGlzIHNvIHRoYXQgdXNlcnMgd2hvIHdhbnQgdG8gdXNlIHF1ZXJ5IHBhcmFtcyBoYXZlCgkJCS8vIGFjY2VzcyB0byB0aGVtIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UgbGlmZSBjeWNsZQoJCQkvLyBTZWUgaXNzdWUgIzUwODUKCQkJaWYgKCAkLnR5cGUodG8pID09PSAic3RyaW5nIiApIHsKCQkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBzdHJpbmcgc2ltcGx5IGNvbnZlcnQgaXQKCQkJCXRyaWdnZXJEYXRhLmFic1VybCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB0bywgdGhpcy5fZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgkJCX0gZWxzZSB7CgkJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgalF1ZXJ5IG9iamVjdCBncmFiIHRoZSBhYnNvbHV0ZSB1cmwgc3RvcmVkCgkJCQkvLyBpbiB0aGUgbG9hZFBhZ2UgY2FsbGJhY2sgd2hlcmUgaXQgZXhpc3RzCgkJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSBzZXR0aW5ncy5hYnNVcmw7CgkJCX0KCgkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZS4KCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIHBiY0V2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCWlmICggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXJldHVybiB0cnVlOwoJCX0sCgoJCWNoYW5nZTogZnVuY3Rpb24oIHRvLCBvcHRpb25zICkgewoJCQkvLyBJZiB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGEgdHJhbnNpdGlvbiwgcXVldWUgdGhlIGN1cnJlbnQgcmVxdWVzdC4KCQkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbgoJCQkvLyB0byBzZXJ2aWNlIHRoZSByZXF1ZXN0LgoJCQlpZiAoIGlzUGFnZVRyYW5zaXRpb25pbmcgKSB7CgkJCQlwYWdlVHJhbnNpdGlvblF1ZXVlLnVuc2hpZnQoIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sICQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKSwKCQkJCXRyaWdnZXJEYXRhID0ge307CgoJCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIGZyb21QYWdlLgoJCQlzZXR0aW5ncy5mcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlIHx8IHRoaXMuYWN0aXZlUGFnZTsKCgkJCS8vIGlmIHRoZSBwYWdlIGJlZm9yZWNoYW5nZSBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJaWYgKCAhdGhpcy5fdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2UodG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncykgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0byBpbgoJCQkvLyB0aGUgdHJpZ2dlciBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG8gaXMKCQkJLy8gdXBkYXRlZC4gV2UgYWxzbyBuZWVkIHRvIHJlLWV2YWx1YXRlIHdoZXRoZXIgaXQgaXMgYSBzdHJpbmcsCgkJCS8vIGJlY2F1c2UgYW4gb2JqZWN0IGNhbiBhbHNvIGJlIHJlcGxhY2VkIGJ5IGEgc3RyaW5nCgkJCXRvID0gdHJpZ2dlckRhdGEudG9QYWdlOwoKCQkJLy8gSWYgdGhlIGNhbGxlciBwYXNzZWQgdXMgYSB1cmwsIGNhbGwgbG9hZFBhZ2UoKQoJCQkvLyB0byBtYWtlIHN1cmUgaXQgaXMgbG9hZGVkIGludG8gdGhlIERPTS4gV2UnbGwgbGlzdGVuCgkJCS8vIHRvIHRoZSBwcm9taXNlIG9iamVjdCBpdCByZXR1cm5zIHNvIHdlIGtub3cgd2hlbgoJCQkvLyBpdCBpcyBkb25lIGxvYWRpbmcgb3IgaWYgYW4gZXJyb3Igb2N1cnJlZC4KCQkJaWYgKCAkLnR5cGUodG8pID09PSAic3RyaW5nIiApIHsKCQkJCS8vIFNldCB0aGUgaXNQYWdlVHJhbnNpdGlvbmluZyBmbGFnIHRvIHByZXZlbnQgYW55IHJlcXVlc3RzIGZyb20KCQkJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJCQl0aGlzLl9sb2FkVXJsKCB0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLnRyYW5zaXRpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKTsKCQkJfQoJCX0sCgoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKCB0b1BhZ2UsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApIHsKCQkJdmFyIGZyb21QYWdlLCB1cmwsIHBhZ2VVcmwsIGZpbGVVcmwsCgkJCQlhY3RpdmUsIGFjdGl2ZUlzSW5pdGlhbFBhZ2UsCgkJCQloaXN0b3J5RGlyLCBwYWdlVGl0bGUsIGlzRGlhbG9nLAoJCQkJYWxyZWFkeVRoZXJlLCBuZXdQYWdlVGl0bGUsCgkJCQlwYXJhbXMsCWNzc1RyYW5zaXRpb25EZWZlcnJlZCwKCQkJCWJlZm9yZVRyYW5zaXRpb247CgoJCQkvLyBJZiB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGEgdHJhbnNpdGlvbiwgcXVldWUgdGhlIGN1cnJlbnQgcmVxdWVzdC4KCQkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbgoJCQkvLyB0byBzZXJ2aWNlIHRoZSByZXF1ZXN0LgoJCQlpZiAoIGlzUGFnZVRyYW5zaXRpb25pbmcgKSB7CgkJCQkvLyBtYWtlIHN1cmUgdG8gb25seSBxdWV1ZSB0aGUgdG8gYW5kIHNldHRpbmdzIHZhbHVlcyBzbyB0aGUgYXJndW1lbnRzCgkJCQkvLyB3b3JrIHdpdGggYSBjYWxsIHRvIHRoZSBjaGFuZ2UgbWV0aG9kCgkJCQlwYWdlVHJhbnNpdGlvblF1ZXVlLnVuc2hpZnQoIFt0b1BhZ2UsIHNldHRpbmdzXSApOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBERVBSRUNBVEVEIC0gdGhpcyBjYWxsIG9ubHksIGluIGZhdm9yIG9mIHRoZSBiZWZvcmUgdHJhbnNpdGlvbgoJCQkvLyBpZiB0aGUgcGFnZSBiZWZvcmVjaGFuZ2UgZGVmYXVsdCBpcyBwcmV2ZW50ZWQgcmV0dXJuIGVhcmx5CgkJCWlmICggIXRoaXMuX3RyaWdnZXJQYWdlQmVmb3JlQ2hhbmdlKHRvUGFnZSwgdHJpZ2dlckRhdGEsIHNldHRpbmdzKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gaWYgdGhlIChjb250ZW50fHBhZ2UpYmVmb3JldHJhbnNpdGlvbiBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJLy8gTm90ZSwgd2UgaGF2ZSB0byBjaGVjayBmb3IgYm90aCB0aGUgZGVwcmVjYXRlZCBhbmQgbmV3IGV2ZW50cwoJCQliZWZvcmVUcmFuc2l0aW9uID0gdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiYmVmb3JldHJhbnNpdGlvbiIsIHRyaWdnZXJEYXRhICk7CgkJCWlmIChiZWZvcmVUcmFuc2l0aW9uLmRlcHJlY2F0ZWRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAoJCQkJYmVmb3JlVHJhbnNpdGlvbi5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCQkvLyBlbnRlcmluZyB0aGlzIG1ldGhvZCB3aGlsZSB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGxvYWRpbmcgYSBwYWdlCgkJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkJLy8gSWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBmaXJzdC1wYWdlIG9mIHRoZSBhcHBsaWNhdGlvbiwgd2UgbmVlZCB0byBtYWtlCgkJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkJLy8gdXMgdG8gYXZvaWQgZ2VuZXJhdGluZyBhIGRvY3VtZW50IHVybCB3aXRoIGFuIGlkIGhhc2ggaW4gdGhlIGNhc2Ugd2hlcmUgdGhlCgkJCS8vIGZpcnN0LXBhZ2Ugb2YgdGhlIGRvY3VtZW50IGhhcyBhbiBpZCBhdHRyaWJ1dGUgc3BlY2lmaWVkLgoJCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJCXNldHRpbmdzLmRhdGFVcmwgPSAkLm1vYmlsZS5wYXRoLmRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJCX0KCgkJCS8vIFRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgcmVhbCBwYWdlIERPTSBlbGVtZW50LiBVcGRhdGUgb3VyCgkJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCQlmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlOwoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgJC5tb2JpbGUucGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKHNldHRpbmdzLmRhdGFVcmwpICkgfHwKCQkJCXRvUGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQKCQkJLy8gYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmw7CgkJCWZpbGVVcmwgPSAkLm1vYmlsZS5wYXRoLmdldEZpbGVQYXRoKCB1cmwgKTsKCQkJYWN0aXZlID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKTsKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDA7CgkJCWhpc3RvcnlEaXIgPSAwOwoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZTsKCQkJaXNEaWFsb2cgPSAoIHNldHRpbmdzLnJvbGUgPT09ICJkaWFsb2ciIHx8CgkJCQl0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciICkgJiYKCQkJCXRvUGFnZS5qcW1EYXRhKCAiZGlhbG9nIiApICE9PSB0cnVlOwoKCQkJLy8gQnkgZGVmYXVsdCwgd2UgcHJldmVudCBjaGFuZ2VQYWdlIHJlcXVlc3RzIHdoZW4gdGhlIGZyb21QYWdlIGFuZCB0b1BhZ2UKCQkJLy8gYXJlIHRoZSBzYW1lIGVsZW1lbnQsIGJ1dCBmb2xrcyB0aGF0IGdlbmVyYXRlIGNvbnRlbnQKCQkJLy8gbWFudWFsbHkvZHluYW1pY2FsbHkgYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvCgkJCS8vIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93IHRoaXMsIHRoZXkgd2lsbCBuZWVkIHRvIGNoYW5nZSB0aGUgZGVmYXVsdAoJCQkvLyB2YWx1ZSBvZiBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiB0byB0cnVlLCAqT1IqLCBwYXNzIGl0IGluIGFzIGFuCgkJCS8vIG9wdGlvbiB3aGVuIHRoZXkgbWFudWFsbHkgY2FsbCBjaGFuZ2VQYWdlKCkuIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0CgkJCS8vIG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUgZm9ybVBhZ2UgYW5kIHRvUGFnZQoJCQkvLyBhcmUgZGlmZmVyZW50IGVsZW1lbnRzLCBzbyB0aGV5IG1heSBiZWhhdmUgdW5leHBlY3RlZGx5LiBJdCBpcyB1cCB0bwoJCQkvLyB0aGUgZGV2ZWxvcGVyIHRoYXQgdHVybnMgb24gdGhlIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uYSBvcHRpb24gdG8KCQkJLy8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkJLy8gYW5pbWF0aW9uIHRyYW5zaXRpb24gaXMgdXNlZC4KCQkJaWYgKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmCgkJCQkhc2V0dGluZ3MuYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gKSB7CgoJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAidHJhbnNpdGlvbiIsIHRyaWdnZXJEYXRhICk7CgkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCS8vIEV2ZW4gaWYgdGhlcmUgaXMgbm8gcGFnZSBjaGFuZ2UgdG8gYmUgZG9uZSwgd2Ugc2hvdWxkIGtlZXAgdGhlCgkJCQkvLyB1cmxIaXN0b3J5IGluIHN5bmMgd2l0aCB0aGUgaGFzaCBjaGFuZ2VzCgkJCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZGlyZWN0KHsgdXJsOiB1cmwgfSk7CgkJCQl9CgoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFnZSB3ZSBhcmUgZ2l2ZW4gaGFzIGFscmVhZHkgYmVlbiBlbmhhbmNlZC4KCQkJdG9QYWdlLnBhZ2UoeyByb2xlOiBzZXR0aW5ncy5yb2xlIH0pOwoKCQkJLy8gSWYgdGhlIGNoYW5nZVBhZ2UgcmVxdWVzdCB3YXMgc2VudCBmcm9tIGEgaGFzaENoYW5nZSBldmVudCwgY2hlY2sgdG8KCQkJLy8gc2VlIGlmIHRoZSBwYWdlIGlzIGFscmVhZHkgd2l0aGluIHRoZSB1cmxIaXN0b3J5IHN0YWNrLiBJZiBzbywgd2UnbGwKCQkJLy8gYXNzdW1lIHRoZSB1c2VyIGhpdCB0aGUgZm9yd2FyZC9iYWNrIGJ1dHRvbiBhbmQgd2lsbCB0cnkgdG8gbWF0Y2ggdGhlCgkJCS8vIHRyYW5zaXRpb24gYWNjb3JkaW5nbHkuCgkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQloaXN0b3J5RGlyID0gc2V0dGluZ3MuZGlyZWN0aW9uID09PSAiYmFjayIgPyAtMSA6IDE7CgkJCX0KCgkJCS8vIEtpbGwgdGhlIGtleWJvYXJkLgoJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gc3RvcCBjcmF3bGluZyB0aGUgZW50aXJlIGRvY3VtZW50IHRvIGtpbGwgZm9jdXMuCgkJCS8vICAgICAgICAgICAgSW5zdGVhZCwgd2Ugc2hvdWxkIGJlIHRyYWNraW5nIGZvY3VzIHdpdGggYSBkZWxlZ2F0ZSgpCgkJCS8vICAgICAgICAgICAgaGFuZGxlciBzbyB3ZSBhbHJlYWR5IGhhdmUgdGhlIGVsZW1lbnQgaW4gaGFuZCBhdCB0aGlzCgkJCS8vICAgICAgICAgICAgcG9pbnQuCgkJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZgoJCQkvLyBkb2N1bWVudC5hY3RpdmVFbGVtZW50IGlzIHVuZGVmaW5lZCB3aGVuIHdlIGFyZSBpbiBhbiBJRnJhbWUuCgkJCXRyeSB7CgkJCQlpZiAoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYKCQkJCQlkb2N1bWVudC5hY3RpdmVFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJib2R5IiApIHsKCgkJCQkJJCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCApLmJsdXIoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJCX0KCQkJfSBjYXRjaCggZSApIHt9CgoJCQkvLyBSZWNvcmQgd2hldGhlciB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHdoZXJlIGEgZGlhbG9nIHVzZWQgdG8gYmUgLQoJCQkvLyBpZiBzbywgZG8gbm90IGFkZCBhIG5ldyBoaXN0b3J5IGVudHJ5IGFuZCBkbyBub3QgY2hhbmdlIHRoZSBoYXNoIGVpdGhlcgoJCQlhbHJlYWR5VGhlcmUgPSBmYWxzZTsKCgkJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCQkvLyBmb3IgdGhlIGRpYWxvZyBjb250ZW50IHRvIGJlIHVzZWQgaW4gdGhlIGhhc2guIEluc3RlYWQsIHdlIHdhbnQKCQkJLy8gdG8gYXBwZW5kIHRoZSBkaWFsb2dIYXNoS2V5IHRvIHRoZSB1cmwgb2YgdGhlIGN1cnJlbnQgcGFnZS4KCQkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCQkvLyBvbiB0aGUgaW5pdGlhbCBwYWdlIGxvYWQgYWN0aXZlLnVybCBpcyB1bmRlZmluZWQgYW5kIGluIHRoYXQgY2FzZQoJCQkJLy8gc2hvdWxkIGJlIGFuIGVtcHR5IHN0cmluZy4gTW92aW5nIHRoZSB1bmRlZmluZWQgLT4gZW1wdHkgc3RyaW5nIGJhY2sKCQkJCS8vIGludG8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyCgkJCQkvLyByZXByZXNlbnRzIHRoZSB1cmwgc3RhdGUKCgkJCQkvLyBJZiB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHRoYXQgb25jZSBiZWxvbmdlZCB0byBhIGRpYWxvZywgcmV1c2UKCQkJCS8vIHRoaXMgc3RhdGUgd2l0aG91dCBhZGRpbmcgdG8gdXJsSGlzdG9yeSBhbmQgd2l0aG91dCBtb2RpZnlpbmcgdGhlCgkJCQkvLyBoYXNoLiBIb3dldmVyLCBpZiBhIGRpYWxvZyBpcyBhbHJlYWR5IGRpc3BsYXllZCBhdCB0aGlzIHBvaW50LCBhbmQKCQkJCS8vIHdlJ3JlIGFib3V0IHRvIGRpc3BsYXkgYW5vdGhlciBkaWFsb2csIHRoZW4gd2UgbXVzdCBhZGQgYW5vdGhlciBoYXNoCgkJCQkvLyBhbmQgaGlzdG9yeSBlbnRyeSBvbiB0b3Agc28gdGhhdCBvbmUgbWF5IG5hdmlnYXRlIGJhY2sgdG8gdGhlCgkJCQkvLyBvcmlnaW5hbCBkaWFsb2cKCQkJCWlmICggYWN0aXZlLnVybCAmJgoJCQkJCWFjdGl2ZS51cmwuaW5kZXhPZiggJC5tb2JpbGUuZGlhbG9nSGFzaEtleSApID4gLTEgJiYKCQkJCQl0aGlzLmFjdGl2ZVBhZ2UgJiYKCQkJCQkhdGhpcy5hY3RpdmVQYWdlLmhhc0NsYXNzKCAidWktZGlhbG9nIiApICYmCgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKSB7CgoJCQkJCXNldHRpbmdzLmNoYW5nZUhhc2ggPSBmYWxzZTsKCQkJCQlhbHJlYWR5VGhlcmUgPSB0cnVlOwoJCQkJfQoKCQkJCS8vIE5vcm1hbGx5LCB3ZSB0YWNrIG9uIGEgZGlhbG9nIGhhc2gga2V5LCBidXQgaWYgdGhpcyBpcyB0aGUgbG9jYXRpb24KCQkJCS8vIG9mIGEgc3RhbGUgZGlhbG9nLCB3ZSByZXVzZSB0aGUgVVJMIGZyb20gdGhlIGVudHJ5CgkJCQl1cmwgPSAoIGFjdGl2ZS51cmwgfHwgIiIgKTsKCgkJCQkvLyBhY2NvdW50IGZvciBhYnNvbHV0ZSB1cmxzIGluc3RlYWQgb2YganVzdCByZWxhdGl2ZSB1cmxzIHVzZSBhcyBoYXNoZXMKCQkJCWlmICggIWFscmVhZHlUaGVyZSAmJiB1cmwuaW5kZXhPZigiIyIpID4gLTEgKSB7CgkJCQkJdXJsICs9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCQl9IGVsc2UgewoJCQkJCXVybCArPSAiIyIgKyAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCQkJfQoKCQkJCS8vIHRhY2sgb24gYW5vdGhlciBkaWFsb2dIYXNoS2V5IGlmIHRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIGluaXRpYWwgaGFzaAoJCQkJLy8gdGhpcyBtYWtlcyBzdXJlIHRoYXQgYSBoaXN0b3J5IGVudHJ5IGlzIGNyZWF0ZWQgZm9yIHRoaXMgZGlhbG9nCgkJCQlpZiAoICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCQkJdXJsICs9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCQl9CgkJCX0KCgkJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkJLy8gSWYgdGhpcyBpcyBhIGRlZXAtbGluayBvciBhIHJlbG9hZCAoIGFjdGl2ZSA9PT0gdW5kZWZpbmVkICkgdGhlbiBqdXN0CgkJCS8vIHVzZSBwYWdlVGl0bGUKCQkJbmV3UGFnZVRpdGxlID0gKCAhYWN0aXZlICkgPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8CgkJCQl0b1BhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maW5kKCAiLnVpLXRpdGxlIiApLnRleHQoKTsKCQkJaWYgKCAhIW5ld1BhZ2VUaXRsZSAmJiBwYWdlVGl0bGUgPT09IGRvY3VtZW50LnRpdGxlICkgewoJCQkJcGFnZVRpdGxlID0gbmV3UGFnZVRpdGxlOwoJCQl9CgkJCWlmICggIXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCQl0b1BhZ2UuanFtRGF0YSggInRpdGxlIiwgcGFnZVRpdGxlICk7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJhbnNpdGlvbiBkZWZpbmVkLgoJCQlzZXR0aW5ncy50cmFuc2l0aW9uID0gc2V0dGluZ3MudHJhbnNpdGlvbiB8fAoJCQkJKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkgfHwKCQkJCSggaXNEaWFsb2cgPyAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiA6ICQubW9iaWxlLmRlZmF1bHRQYWdlVHJhbnNpdGlvbiApOwoKCQkJLy9hZGQgcGFnZSB0byBoaXN0b3J5IHN0YWNrIGlmIGl0J3Mgbm90IGJhY2sgb3IgZm9yd2FyZAoJCQlpZiAoICFoaXN0b3J5RGlyICYmIGFscmVhZHlUaGVyZSApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkucGFnZVVybCA9IHBhZ2VVcmw7CgkJCX0KCgkJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQkJaWYgKCB1cmwgJiYgIXNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoKCQkJCS8vIHJlYnVpbGRpbmcgdGhlIGhhc2ggaGVyZSBzaW5jZSB3ZSBsb29zZSBpdCBlYXJsaWVyIG9uCgkJCQkvLyBUT0RPIHByZXNlcnZlIHRoZSBvcmlnaW5hbGx5IHBhc3NlZCBpbiBwYXRoCgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggdXJsICkgJiYgdXJsLmluZGV4T2YoICIjIiApIDwgMCApIHsKCQkJCQl1cmwgPSAiIyIgKyB1cmw7CgkJCQl9CgoJCQkJLy8gVE9ETyB0aGUgcHJvcGVydHkgbmFtZXMgaGVyZSBhcmUganVzdCBzaWxseQoJCQkJcGFyYW1zID0gewoJCQkJCXRyYW5zaXRpb246IHNldHRpbmdzLnRyYW5zaXRpb24sCgkJCQkJdGl0bGU6IHBhZ2VUaXRsZSwKCQkJCQlwYWdlVXJsOiBwYWdlVXJsLAoJCQkJCXJvbGU6IHNldHRpbmdzLnJvbGUKCQkJCX07CgoJCQkJaWYgKCBzZXR0aW5ncy5jaGFuZ2VIYXNoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZSggdXJsLCBwYXJhbXMsIHRydWUpOwoJCQkJfSBlbHNlIGlmICggdG9QYWdlWyAwIF0gIT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCB1cmwsIHBhcmFtcyApOwoJCQkJfQoJCQl9CgoJCQkvL3NldCBwYWdlIHRpdGxlCgkJCWRvY3VtZW50LnRpdGxlID0gcGFnZVRpdGxlOwoKCQkJLy9zZXQgInRvUGFnZSIgYXMgYWN0aXZlUGFnZSBkZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCQkvL25ldyB3YXkgdG8gaGFuZGxlIGFjdGl2ZVBhZ2UKCQkJdGhpcy5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkJLy8gSWYgd2UncmUgbmF2aWdhdGluZyBiYWNrIGluIHRoZSBVUkwgaGlzdG9yeSwgc2V0IHJldmVyc2UgYWNjb3JkaW5nbHkuCgkJCXNldHRpbmdzLnJldmVyc2UgPSBzZXR0aW5ncy5yZXZlcnNlIHx8IGhpc3RvcnlEaXIgPCAwOwoKCQkJY3NzVHJhbnNpdGlvbkRlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCQkJdGhpcy5fY3NzVHJhbnNpdGlvbih0b1BhZ2UsIGZyb21QYWdlLCB7CgkJCQl0cmFuc2l0aW9uOiBzZXR0aW5ncy50cmFuc2l0aW9uLAoJCQkJcmV2ZXJzZTogc2V0dGluZ3MucmV2ZXJzZSwKCQkJCWRlZmVycmVkOiBjc3NUcmFuc2l0aW9uRGVmZXJyZWQKCQkJfSk7CgoJCQljc3NUcmFuc2l0aW9uRGVmZXJyZWQuZG9uZSgkLnByb3h5KGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tLCBhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCSQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcygpOwoKCQkJCS8vaWYgdGhlcmUncyBhIGR1cGxpY2F0ZUNhY2hlZFBhZ2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gbm93IHRoYXQgaXQncyBoaWRkZW4KCQkJCWlmICggc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZSApIHsKCQkJCQlzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlLnJlbW92ZSgpOwoJCQkJfQoKCQkJCS8vIGRlc3BpdGUgdmlzaWJpbGl0eTogaGlkZGVuIGFkZHJlc3NlcyBpc3N1ZSAjMjk2NQoJCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8yOTY1CgkJCQlpZiAoICFhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRvUGFnZSApOwoJCQkJfQoKCQkJCXRoaXMuX3JlbGVhc2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggInRyYW5zaXRpb24iLCB0cmlnZ2VyRGF0YSApOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJLy8gZGV0ZXJtaW5lIHRoZSBjdXJyZW50IGJhc2UgdXJsCgkJX2ZpbmRCYXNlV2l0aERlZmF1bHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgY2xvc2VzdEJhc2UgPSAoIHRoaXMuYWN0aXZlUGFnZSAmJgoJCQkkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggdGhpcy5hY3RpdmVQYWdlICkgKTsKCQlyZXR1cm4gY2xvc2VzdEJhc2UgfHwgJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCQl9Cgl9KTsKCgkvLyBUaGUgZm9sbG93aW5nIGhhbmRsZXJzIHNob3VsZCBiZSBib3VuZCBhZnRlciBtb2JpbGVpbml0IGhhcyBiZWVuIHRyaWdnZXJlZAoJLy8gdGhlIGZvbGxvd2luZyBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCS8vdGhlc2UgdmFyaWFibGVzIG1ha2UgYWxsIHBhZ2UgY29udGFpbmVycyB1c2UgdGhlIHNhbWUgcXVldWUgYW5kIG9ubHkgbmF2aWdhdGUgb25lIGF0IGEgdGltZQoJLy8gcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJdmFyIHBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy8gaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHBhZ2UgaXMgaW4gcHJvY2VzcyBvZiB0cmFuc2l0aW9uaW5nCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJCS8vIHJlc29sdmVkIG9uIGRvbXJlYWR5Cgl2YXIgZG9tcmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJLy8gcmVzb2x2ZWQgYW5kIG51bGxlZCBvbiB3aW5kb3cubG9hZCgpCgkJbG9hZERlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoJCWRvY3VtZW50VXJsID0gJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybCwKCgkJLy8gdXNlZCB0byB0cmFjayBsYXN0IHZjbGlja2VkIGVsZW1lbnQgdG8gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyBhZGRlZCB0byBmb3JtIGRhdGEKCQkkbGFzdFZDbGlja2VkID0gbnVsbDsKCgkvKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0cyApIHsKCQl2YXIgY29udGFpbmVyOwoKCQlvcHRzID0gb3B0cyB8fCB7fTsKCQljb250YWluZXIgPSAoIG9wdHMucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCS8vIGNyZWF0ZSB0aGUgZGVmZXJyZWQgdGhhdCB3aWxsIGJlIHN1cHBsaWVkIHRvIGxvYWRQYWdlIGNhbGxlcnMKCQkvLyBhbmQgcmVzb2x2ZWQgYnkgdGhlIGNvbnRlbnQgd2lkZ2V0J3MgbG9hZCBtZXRob2QKCQlvcHRzLmRlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCQkvLyBQcmVmZXJyaW5nIHRvIGFsbG93IGV4Y2VwdGlvbnMgZm9yIHVuaW5pdGlhbGl6ZWQgb3B0cy5wYWdlQ29udGFpbmVyCgkJLy8gd2lkZ2V0cyBzbyB3ZSBrbm93IGlmIHdlIG5lZWQgdG8gZm9yY2UgaW5pdCBoZXJlIGZvciB1c2VycwoJCWNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAibG9hZCIsIHVybCwgb3B0cyApOwoKCQkvLyBwcm92aWRlIHRoZSBkZWZlcnJlZAoJCXJldHVybiBvcHRzLmRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYgKCB0aGlzLnBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQgJiYKCQkJbmF2ICYmCgkJCW5hdi5hcHAgJiYKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSApIHsKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSgpOwoJCX0gZWxzZSB7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImJhY2siICk7CgkJfQoJfTsKCgkvLyBEaXJlY3QgZm9jdXMgdG8gdGhlIHBhZ2UgdGl0bGUsIG9yIG90aGVyd2lzZSBmaXJzdCBmb2N1c2FibGUgZWxlbWVudAoJJC5tb2JpbGUuZm9jdXNQYWdlID0gZnVuY3Rpb24gKCBwYWdlICkgewoJCXZhciBhdXRvZm9jdXMgPSBwYWdlLmZpbmQoICJbYXV0b2ZvY3VzXSIgKSwKCQkJcGFnZVRpdGxlID0gcGFnZS5maW5kKCAiLnVpLXRpdGxlOmVxKDApIiApOwoKCQlpZiAoIGF1dG9mb2N1cy5sZW5ndGggKSB7CgkJCWF1dG9mb2N1cy5mb2N1cygpOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBhZ2VUaXRsZS5sZW5ndGggKSB7CgkJCXBhZ2VUaXRsZS5mb2N1cygpOwoJCX0gZWxzZXsKCQkJcGFnZS5mb2N1cygpOwoJCX0KCX07CgoJLy8gTm8tb3AgaW1wbGVtZW50YXRpb24gb2YgdHJhbnNpdGlvbiBkZWdyYWRhdGlvbgoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiB8fCBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy8gRXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzCgoJJC5tb2JpbGUuY2hhbmdlUGFnZSA9IGZ1bmN0aW9uKCB0bywgb3B0aW9ucyApIHsKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnBhZ2Vjb250YWluZXIoICJjaGFuZ2UiLCB0bywgb3B0aW9ucyApOwoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzID0gewoJCXRyYW5zaXRpb246IHVuZGVmaW5lZCwKCQlyZXZlcnNlOiBmYWxzZSwKCQljaGFuZ2VIYXNoOiB0cnVlLAoJCWZyb21IYXNoQ2hhbmdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlkdXBsaWNhdGVDYWNoZWRQYWdlOiB1bmRlZmluZWQsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCXNob3dMb2FkTXNnOiB0cnVlLCAvL2xvYWRpbmcgbWVzc2FnZSBzaG93cyBieSBkZWZhdWx0IHdoZW4gcGFnZXMgYXJlIGJlaW5nIGZldGNoZWQgZHVyaW5nIGNoYW5nZVBhZ2UKCQlkYXRhVXJsOiB1bmRlZmluZWQsCgkJZnJvbVBhZ2U6IHVuZGVmaW5lZCwKCQlhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbjogZmFsc2UKCX07CgoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgPSBmdW5jdGlvbigpIHsKCQl2YXIgZ2V0QWpheEZvcm1EYXRhID0gZnVuY3Rpb24oICRmb3JtLCBjYWxjdWxhdGVPbmx5ICkgewoJCQl2YXIgdXJsLCByZXQgPSB0cnVlLCBmb3JtRGF0YSwgdmNsaWNrZWROYW1lLCBtZXRob2Q7CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkIHx8CgkJCQkJLy8gdGVzdCB0aGF0IHRoZSBmb3JtIGlzLCBpdHNlbGYsIGFqYXggZmFsc2UKCQkJCQkkZm9ybS5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IGFuZAoJCQkJCS8vIHRoZSBmb3JtIG9yIG9uZSBvZiBpdCdzIHBhcmVudHMgaXMgYWpheD1mYWxzZQoJCQkJCSEkZm9ybS5qcW1IaWphY2thYmxlKCkubGVuZ3RoIHx8CgkJCQkJJGZvcm0uYXR0ciggInRhcmdldCIgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdXJsID0gKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWQuYXR0ciggImZvcm1hY3Rpb24iICkgKSB8fAoJCQkJJGZvcm0uYXR0ciggImFjdGlvbiIgKTsKCQkJbWV0aG9kID0gKCAkZm9ybS5hdHRyKCAibWV0aG9kIiApIHx8ICJnZXQiICkudG9Mb3dlckNhc2UoKTsKCgkJCS8vIElmIG5vIGFjdGlvbiBpcyBzcGVjaWZpZWQsIGJyb3dzZXJzIGRlZmF1bHQgdG8gdXNpbmcgdGhlCgkJCS8vIFVSTCBvZiB0aGUgZG9jdW1lbnQgY29udGFpbmluZyB0aGUgZm9ybS4gU2luY2Ugd2UgZHluYW1pY2FsbHkKCQkJLy8gcHVsbCBpbiBwYWdlcyBmcm9tIGV4dGVybmFsIGRvY3VtZW50cywgdGhlIGZvcm0gc2hvdWxkIHN1Ym1pdAoJCQkvLyB0byB0aGUgVVJMIGZvciB0aGUgc291cmNlIGRvY3VtZW50IG9mIHRoZSBwYWdlIGNvbnRhaW5pbmcKCQkJLy8gdGhlIGZvcm0uCgkJCWlmICggIXVybCApIHsKCQkJCS8vIEdldCB0aGUgQGRhdGEtdXJsIGZvciB0aGUgcGFnZSBjb250YWluaW5nIHRoZSBmb3JtLgoJCQkJdXJsID0gJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICk7CgoJCQkJLy8gTk9URTogSWYgdGhlIG1ldGhvZCBpcyAiZ2V0Iiwgd2UgbmVlZCB0byBzdHJpcCBvZmYgdGhlIHF1ZXJ5IHN0cmluZwoJCQkJLy8gYmVjYXVzZSBpdCB3aWxsIGdldCByZXBsYWNlZCB3aXRoIHRoZSBuZXcgZm9ybSBkYXRhLiBTZWUgaXNzdWUgIzU3MTAuCgkJCQlpZiAoIG1ldGhvZCA9PT0gImdldCIgKSB7CgkJCQkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggdXJsICkuaHJlZk5vU2VhcmNoOwoJCQkJfQoKCQkJCWlmICggdXJsID09PSAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgewoJCQkJCS8vIFRoZSB1cmwgd2UgZ290IGJhY2sgbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYmFzZSwKCQkJCQkvLyB3aGljaCBtZWFucyB0aGUgcGFnZSBtdXN0IGJlIGFuIGludGVybmFsL2VtYmVkZGVkIHBhZ2UsCgkJCQkJLy8gc28gZGVmYXVsdCB0byB1c2luZyB0aGUgYWN0dWFsIGRvY3VtZW50IHVybCBhcyBhIGJyb3dzZXIKCQkJCQkvLyB3b3VsZC4KCQkJCQl1cmwgPSBkb2N1bWVudFVybC5ocmVmTm9TZWFyY2g7CgkJCQl9CgkJCX0KCgkJCXVybCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAgdXJsLCAkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKSApOwoKCQkJaWYgKCAoICQubW9iaWxlLnBhdGguaXNFeHRlcm5hbCggdXJsICkgJiYgISQubW9iaWxlLnBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCB1cmwgKSApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQlpZiAoICFjYWxjdWxhdGVPbmx5ICkgewoJCQkJZm9ybURhdGEgPSAkZm9ybS5zZXJpYWxpemVBcnJheSgpOwoKCQkJCWlmICggJGxhc3RWQ2xpY2tlZCAmJiAkbGFzdFZDbGlja2VkWyAwIF0uZm9ybSA9PT0gJGZvcm1bIDAgXSApIHsKCQkJCQl2Y2xpY2tlZE5hbWUgPSAkbGFzdFZDbGlja2VkLmF0dHIoICJuYW1lIiApOwoJCQkJCWlmICggdmNsaWNrZWROYW1lICkgewoJCQkJCQkvLyBNYWtlIHN1cmUgdGhlIGxhc3QgY2xpY2tlZCBlbGVtZW50IGlzIGluY2x1ZGVkIGluIHRoZSBmb3JtCgkJCQkJCSQuZWFjaCggZm9ybURhdGEsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJCQkJaWYgKCB2YWx1ZS5uYW1lID09PSB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCQkJLy8gVW5zZXQgdmNsaWNrZWROYW1lIC0gd2UndmUgZm91bmQgaXQgaW4gdGhlIHNlcmlhbGl6ZWQgZGF0YSBhbHJlYWR5CgkJCQkJCQkJdmNsaWNrZWROYW1lID0gIiI7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCQlmb3JtRGF0YS5wdXNoKCB7IG5hbWU6IHZjbGlja2VkTmFtZSwgdmFsdWU6ICRsYXN0VkNsaWNrZWQuYXR0ciggInZhbHVlIiApIH0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQlyZXQgPSB7CgkJCQkJdXJsOiB1cmwsCgkJCQkJb3B0aW9uczogewoJCQkJCQl0eXBlOgkJbWV0aG9kLAoJCQkJCQlkYXRhOgkJJC5wYXJhbSggZm9ybURhdGEgKSwKCQkJCQkJdHJhbnNpdGlvbjoJJGZvcm0uanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQkJCXJldmVyc2U6CSRmb3JtLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiwKCQkJCQkJcmVsb2FkUGFnZToJdHJ1ZQoJCQkJCX0KCQkJCX07CgkJCX0KCgkJCXJldHVybiByZXQ7CgkJfTsKCgkJLy9iaW5kIHRvIGZvcm0gc3VibWl0IGV2ZW50cywgaGFuZGxlIHdpdGggQWpheAoJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiZm9ybSIsICJzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmb3JtRGF0YTsKCgkJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZm9ybURhdGEgPSBnZXRBamF4Rm9ybURhdGEoICQoIHRoaXMgKSApOwoJCQkJaWYgKCBmb3JtRGF0YSApIHsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBmb3JtRGF0YS51cmwsIGZvcm1EYXRhLm9wdGlvbnMgKTsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vYWRkIGFjdGl2ZSBzdGF0ZSBvbiB2Y2xpY2sKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJGJ0biwgYnRuRWxzLCB0YXJnZXQgPSBldmVudC50YXJnZXQsIG5lZWRDbG9zZXN0ID0gZmFsc2U7CgkJCS8vIGlmIHRoaXMgaXNuJ3QgYSBsZWZ0IGNsaWNrIHdlIGRvbid0IGNhcmUuIEl0cyBpbXBvcnRhbnQgdG8gbm90ZQoJCQkvLyB0aGF0IHdoZW4gdGhlIHZpcnR1YWwgZXZlbnQgaXMgZ2VuZXJhdGVkIGl0IHdpbGwgY3JlYXRlIHRoZSB3aGljaCBhdHRyCgkJCWlmICggZXZlbnQud2hpY2ggPiAxIHx8ICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFJlY29yZCB0aGF0IHRoaXMgZWxlbWVudCB3YXMgY2xpY2tlZCwgaW4gY2FzZSB3ZSBuZWVkIGl0IGZvciBjb3JyZWN0CgkJCS8vIGZvcm0gc3VibWlzc2lvbiBkdXJpbmcgdGhlICJzdWJtaXQiIGhhbmRsZXIgYWJvdmUKCQkJJGxhc3RWQ2xpY2tlZCA9ICQoIHRhcmdldCApOwoKCQkJLy8gVHJ5IHRvIGZpbmQgYSB0YXJnZXQgZWxlbWVudCB0byB3aGljaCB0aGUgYWN0aXZlIGNsYXNzIHdpbGwgYmUgYXBwbGllZAoJCQlpZiAoICQuZGF0YSggdGFyZ2V0LCAibW9iaWxlLWJ1dHRvbiIgKSApIHsKCQkJCS8vIElmIHRoZSBmb3JtIHdpbGwgbm90IGJlIHN1Ym1pdHRlZCB2aWEgQUpBWCwgZG8gbm90IGFkZCBhY3RpdmUgY2xhc3MKCQkJCWlmICggIWdldEFqYXhGb3JtRGF0YSggJCggdGFyZ2V0ICkuY2xvc2VzdCggImZvcm0iICksIHRydWUgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkvLyBXZSB3aWxsIGFwcGx5IHRoZSBhY3RpdmUgc3RhdGUgdG8gdGhpcyBidXR0b24gd2lkZ2V0IC0gdGhlIHBhcmVudAoJCQkJLy8gb2YgdGhlIGlucHV0IHRoYXQgd2FzIGNsaWNrZWQgd2lsbCBoYXZlIHRoZSBhc3NvY2lhdGVkIGRhdGEKCQkJCWlmICggdGFyZ2V0LnBhcmVudE5vZGUgKSB7CgkJCQkJdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl0YXJnZXQgPSBmaW5kQ2xvc2VzdExpbmsoIHRhcmdldCApOwoJCQkJaWYgKCAhKCB0YXJnZXQgJiYgJC5tb2JpbGUucGF0aC5wYXJzZVVybCggdGFyZ2V0LmdldEF0dHJpYnV0ZSggImhyZWYiICkgfHwgIiMiICkuaGFzaCAhPT0gIiMiICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFRPRE8gdGVhY2ggJC5tb2JpbGUuaGlqYWNrYWJsZSB0byBvcGVyYXRlIG9uIHJhdyBkb20gZWxlbWVudHMgc28gdGhlCgkJCQkvLyBsaW5rIHdyYXBwaW5nIGNhbiBiZSBhdm9pZGVkCgkJCQlpZiAoICEkKCB0YXJnZXQgKS5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gQXZvaWQgY2FsbGluZyAuY2xvc2VzdCBieSB1c2luZyB0aGUgZGF0YSBzZXQgZHVyaW5nIC5idXR0b25NYXJrdXAoKQoJCQkvLyBMaXN0IGl0ZW1zIGhhdmUgdGhlIGJ1dHRvbiBkYXRhIGluIHRoZSBwYXJlbnQgb2YgdGhlIGVsZW1lbnQgY2xpY2tlZAoJCQlpZiAoICEhfnRhcmdldC5jbGFzc05hbWUuaW5kZXhPZiggInVpLWxpbmstaW5oZXJpdCIgKSApIHsKCQkJCWlmICggdGFyZ2V0LnBhcmVudE5vZGUgKSB7CgkJCQkJYnRuRWxzID0gJC5kYXRhKCB0YXJnZXQucGFyZW50Tm9kZSwgImJ1dHRvbkVsZW1lbnRzIiApOwoJCQkJfQoJCQkvLyBPdGhlcndpc2UsIGxvb2sgZm9yIHRoZSBkYXRhIG9uIHRoZSB0YXJnZXQgaXRzZWxmCgkJCX0gZWxzZSB7CgkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldCwgImJ1dHRvbkVsZW1lbnRzIiApOwoJCQl9CgkJCS8vIElmIGZvdW5kLCBncmFiIHRoZSBidXR0b24ncyBvdXRlciBlbGVtZW50CgkJCWlmICggYnRuRWxzICkgewoJCQkJdGFyZ2V0ID0gYnRuRWxzLm91dGVyOwoJCQl9IGVsc2UgewoJCQkJbmVlZENsb3Nlc3QgPSB0cnVlOwoJCQl9CgoJCQkkYnRuID0gJCggdGFyZ2V0ICk7CgkJCS8vIElmIHRoZSBvdXRlciBlbGVtZW50IHdhc24ndCBmb3VuZCBieSB0aGUgb3VyIGhldXJpc3RpY3MsIHVzZSAuY2xvc2VzdCgpCgkJCWlmICggbmVlZENsb3Nlc3QgKSB7CgkJCQkkYnRuID0gJGJ0bi5jbG9zZXN0KCAiLnVpLWJ0biIgKTsKCQkJfQoKCQkJaWYgKCAkYnRuLmxlbmd0aCA+IDAgJiYKCQkJCSEoICRidG4uaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgfHwKCgkJCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSBhZnRlciAxLjQuMCByZWxlYXNlCgkJCQkJLy8gb25seSB1aS1zdGF0ZS1kaXNhYmxlZCBzaG91bGQgYmUgcHJlc2VudCB0aGVyZWFmdGVyCgkJCQkJJGJ0bi5oYXNDbGFzcyggInVpLWRpc2FibGVkIiApICkgKSApIHsKCQkJCSQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJJC5tb2JpbGUuYWN0aXZlQ2xpY2tlZExpbmsgPSAkYnRuOwoJCQkJJC5tb2JpbGUuYWN0aXZlQ2xpY2tlZExpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0KCQl9KTsKCgkJLy8gY2xpY2sgcm91dGluZyAtIGRpcmVjdCB0byBIVFRQIG9yIEFqYXgsIGFjY29yZGluZ2x5CgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgfHwgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKSwKCQkJCSRsaW5rID0gJCggbGluayApLAoKCQkJCS8vcmVtb3ZlIGFjdGl2ZSBsaW5rIGNsYXNzIGlmIGV4dGVybmFsICh0aGVuIGl0IHdvbid0IGJlIHRoZXJlIGlmIHlvdSBjb21lIGJhY2spCgkJCQlodHRwQ2xlYW51cCA9IGZ1bmN0aW9uKCkgewoJCQkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCQl9LAoJCQkJYmFzZVVybCwgaHJlZiwKCQkJCXVzZURlZmF1bHRVcmxIYW5kbGluZywgaXNFeHRlcm5hbCwKCQkJCXRyYW5zaXRpb24sIHJldmVyc2UsIHJvbGU7CgoJCQkvLyBJZiBhIGJ1dHRvbiB3YXMgY2xpY2tlZCwgY2xlYW4gdXAgdGhlIGFjdGl2ZSBjbGFzcyBhZGRlZCBieSB2Y2xpY2sgYWJvdmUKCQkJaWYgKCAkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayAmJgoJCQkJJC5tb2JpbGUuYWN0aXZlQ2xpY2tlZExpbmtbIDAgXSA9PT0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGUgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQl9CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBsaW5rIGFzc29jaWF0ZWQgd2l0aCB0aGUgY2xpY2sgb3IgaXRzIG5vdCBhIGxlZnQKCQkJLy8gY2xpY2sgd2Ugd2FudCB0byBpZ25vcmUgdGhlIGNsaWNrCgkJCS8vIFRPRE8gdGVhY2ggJC5tb2JpbGUuaGlqYWNrYWJsZSB0byBvcGVyYXRlIG9uIHJhdyBkb20gZWxlbWVudHMgc28gdGhlIGxpbmsgd3JhcHBpbmcKCQkJLy8gY2FuIGJlIGF2b2lkZWQKCQkJaWYgKCAhbGluayB8fCBldmVudC53aGljaCA+IDEgfHwgISRsaW5rLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmICggJGxpbmsuaXMoICI6anFtRGF0YShyZWw9J2JhY2snKSIgKSApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJYmFzZVVybCA9ICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApOwoKCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICRsaW5rLmF0dHIoICJocmVmIiApIHx8ICIjIiwgYmFzZVVybCApOwoKCQkJLy9pZiBhamF4IGlzIGRpc2FibGVkLCBleGl0IGVhcmx5CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkICYmICEkLm1vYmlsZS5wYXRoLmlzRW1iZWRkZWRQYWdlKCBocmVmICkgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPT0gLTEgKSB7CgkJCQlocmVmID0gaHJlZi5yZXBsYWNlKCAvW14jXSojLywgIiIgKTsKCQkJCWlmICggIWhyZWYgKSB7CgkJCQkJLy9saW5rIHdhcyBhbiBlbXB0eSBoYXNoIG1lYW50IHB1cmVseQoJCQkJCS8vZm9yIGludGVyYWN0aW9uLCBzbyB3ZSBpZ25vcmUgaXQuCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgaWYgKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggaHJlZiApICkgewoJCQkJCS8vd2UgaGF2ZSBhcGF0aCBzbyBtYWtlIGl0IHRoZSBocmVmIHdlIHdhbnQgdG8gbG9hZC4KCQkJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGJhc2VVcmwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy93ZSBoYXZlIGEgc2ltcGxlIGlkIHNvIHVzZSB0aGUgZG9jdW1lbnRVcmwgYXMgaXRzIGJhc2UuCgkJCQkJaHJlZiA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBocmVmLCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICk7CgkJCQl9CgkJCX0KCgkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICk7CgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCS8vY2hlY2sgZm9yIHByb3RvY29sIG9yIHJlbCBhbmQgaXRzIG5vdCBhbiBlbWJlZGRlZCBwYWdlCgkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJaXNFeHRlcm5hbCA9IHVzZURlZmF1bHRVcmxIYW5kbGluZyB8fCAoICQubW9iaWxlLnBhdGguaXNFeHRlcm5hbCggaHJlZiApICYmICEkLm1vYmlsZS5wYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgaHJlZiApICk7CgoJCQlpZiAoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXRyYW5zaXRpb24gPSAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKTsKCQkJcmV2ZXJzZSA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiB8fAoJCQkJCQkvLyBkZXByZWNhdGVkIC0gcmVtb3ZlIGJ5IDEuMAoJCQkJCQkkbGluay5qcW1EYXRhKCAiYmFjayIgKTsKCgkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCXJvbGUgPSAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApIHx8IHVuZGVmaW5lZDsKCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGhyZWYsIHsgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgcmV2ZXJzZTogcmV2ZXJzZSwgcm9sZTogcm9sZSwgbGluazogJGxpbmsgfSApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL3ByZWZldGNoIHBhZ2VzIHdoZW4gYW5jaG9ycyB3aXRoIGRhdGEtcHJlZmV0Y2ggYXJlIGVuY291bnRlcmVkCgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlc2hvdy5wcmVmZXRjaCIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgdXJscyA9IFtdOwoJCQkkKCB0aGlzICkuZmluZCggImE6anFtRGF0YShwcmVmZXRjaCkiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKSwKCQkJCQl1cmwgPSAkbGluay5hdHRyKCAiaHJlZiIgKTsKCgkJCQlpZiAoIHVybCAmJiAkLmluQXJyYXkoIHVybCwgdXJscyApID09PSAtMSApIHsKCQkJCQl1cmxzLnB1c2goIHVybCApOwoKCQkJCQkkLm1vYmlsZS5sb2FkUGFnZSggdXJsLCB7IHJvbGU6ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkscHJlZmV0Y2g6IHRydWUgfSApOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJLy8gVE9ETyBlbnN1cmUgdGhhdCB0aGUgbmF2aWdhdGUgYmluZGluZyBpbiB0aGUgY29udGVudCB3aWRnZXQgaGFwcGVucyBhdCB0aGUgcmlnaHQgdGltZQoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lcigpOwoKCQkvL3NldCBwYWdlIG1pbi1oZWlnaHRzIHRvIGJlIGRldmljZSBzcGVjaWZpYwoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoKCQkJLy8gV2UgbmVlZCB0byB3YWl0IGZvciB3aW5kb3cubG9hZCB0byBtYWtlIHN1cmUgdGhhdCBzdHlsZXMgaGF2ZSBhbHJlYWR5IGJlZW4gcmVuZGVyZWQsCgkJCS8vIG90aGVyd2lzZSBoZWlnaHRzIG9mIGV4dGVybmFsIHRvb2xiYXJzIHdpbGwgaGF2ZSB0aGUgd3JvbmcgdmFsdWUKCQkJaWYgKCBsb2FkRGVmZXJyZWQgKSB7CgkJCQlsb2FkRGVmZXJyZWQuZG9uZSggJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgkJCX0gZWxzZSB7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCQkJfQoJCX0pOwoJCSQubW9iaWxlLndpbmRvdy5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfTsvL25hdnJlYWR5RGVmZXJyZWQgZG9uZSBjYWxsYmFjawoKCSQoIGZ1bmN0aW9uKCkgeyBkb21yZWFkeURlZmVycmVkLnJlc29sdmUoKTsgfSApOwoKCSQubW9iaWxlLndpbmRvdy5sb2FkKCBmdW5jdGlvbigpIHsKCgkJLy8gUmVzb2x2ZSBhbmQgbnVsbCB0aGUgZGVmZXJyZWQKCQlsb2FkRGVmZXJyZWQucmVzb2x2ZSgpOwoJCWxvYWREZWZlcnJlZCA9IG51bGw7Cgl9KTsKCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsICQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgKS5kb25lKCBmdW5jdGlvbigpIHsgJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMoKTsgfSApOwp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgkvLyBUT0RPIHJlbW92ZSBkaXJlY3QgcmVmZXJlbmNlcyB0byAkLm1vYmlsZSBhbmQgcHJvcGVydGllcywgd2Ugc2hvdWxkCgkvLyAgICAgIGZhdm9yIGluamVjdGlvbiB3aXRoIHBhcmFtcyB0byB0aGUgY29uc3RydWN0b3IKCSQubW9iaWxlLlRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXRvUHJlQ2xhc3M6ICIgdWktcGFnZS1wcmUtaW4iLAoKCQlpbml0OiBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApIHsKCQkJJC5leHRlbmQodGhpcywgewoJCQkJbmFtZTogbmFtZSwKCQkJCXJldmVyc2U6IHJldmVyc2UsCgkJCQkkdG86ICR0bywKCQkJCSRmcm9tOiAkZnJvbSwKCQkJCWRlZmVycmVkOiBuZXcgJC5EZWZlcnJlZCgpCgkJCX0pOwoJCX0sCgoJCWNsZWFuRnJvbTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuJGZyb20KCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiBvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkKCQkJCS5oZWlnaHQoICIiICk7CgkJfSwKCgkJLy8gTk9URSBvdmVycmlkZGVuIGJ5IGNoaWxkIG9iamVjdCBwcm90b3R5cGVzLCBub29wJ2QgaGVyZSBhcyBkZWZhdWx0cwoJCWJlZm9yZURvbmVJbjogZnVuY3Rpb24oKSB7fSwKCQliZWZvcmVEb25lT3V0OiBmdW5jdGlvbigpIHt9LAoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbigpIHt9LAoKCQlkb25lSW46IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmJlZm9yZURvbmVJbigpOwoKCQkJdGhpcy4kdG8ucmVtb3ZlQ2xhc3MoICJvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkuaGVpZ2h0KCAiIiApOwoKCQkJdGhpcy50b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQkvLyBJbiBzb21lIGJyb3dzZXJzIChpT1M1KSwgM0QgdHJhbnNpdGlvbnMgYmxvY2sgdGhlIGFiaWxpdHkgdG8gc2Nyb2xsIHRvIHRoZSBkZXNpcmVkIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0aW9uCgkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCWlmICggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpICE9PSB0aGlzLnRvU2Nyb2xsICkgewoJCQkJdGhpcy5zY3JvbGxQYWdlKCk7CgkJCX0KCQkJaWYgKCAhdGhpcy5zZXF1ZW50aWFsICkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoJCQl9CgkJCXRoaXMuZGVmZXJyZWQucmVzb2x2ZSggdGhpcy5uYW1lLCB0aGlzLnJldmVyc2UsIHRoaXMuJHRvLCB0aGlzLiRmcm9tLCB0cnVlICk7CgkJfSwKCgkJZG9uZU91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuYmVmb3JlRG9uZU91dCgpOwoJCQl0aGlzLnN0YXJ0SW4oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKTsKCQl9LAoKCQloaWRlSW46IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJdGhpcy4kdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoJCQljYWxsYmFjay5jYWxsKCB0aGlzICk7CgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAiIiApOwoJCX0sCgoJCXNjcm9sbFBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCS8vaWYgd2UgYXJlIGhpZGluZyB0aGUgdXJsIGJhciBvciB0aGUgcGFnZSB3YXMgcHJldmlvdXNseSBzY3JvbGxlZCBzY3JvbGwgdG8gaGlkZSBvciByZXR1cm4gdG8gcG9zaXRpb24KCQkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyIHx8IHRoaXMudG9TY3JvbGwgIT09ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLnRvU2Nyb2xsICk7CgkJCX0KCgkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJc3RhcnRJbjogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuaGlkZUluKGZ1bmN0aW9uKCkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRoaXMudG9QcmVDbGFzcyApOwoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCWlmICggIXByZXZlbnRGb2N1cyApIHsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRoaXMuJHRvICk7CgkJCQl9CgoJCQkJLy8gU2V0IHRvIHBhZ2UgaGVpZ2h0CgkJCQl0aGlzLiR0by5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRoaXMudG9TY3JvbGwgKTsKCiAgICAgICAgICAgICAgICBpZiAoICFub25lICkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsUGFnZSgpOwogICAgICAgICAgICAgICAgfQoJCQl9KTsKCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCAhbm9uZSApIHsKCQkJCXRoaXMuJHRvLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJCXRoaXMuZG9uZUluKCk7CgkJCQl9LCB0aGlzICkpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoJCXRvZ2dsZVZpZXdwb3J0Q2xhc3M6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIHRoaXMubmFtZSApOwoJCX0sCgoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewoJCQkvLyBOT1RFIG1hbnkgb2YgdGhlc2UgY291bGQgYmUgY2FsY3VsYXRlZC9yZWNvcmRlZCBpbiB0aGUgY29uc3RydWN0b3IsIGl0J3MgbXkKCQkJLy8gICAgICBvcGluaW9uIHRoYXQgYmluZGluZyB0aGVtIGFzIGxhdGUgYXMgcG9zc2libGUgaGFzIHZhbHVlIHdpdGggcmVnYXJkcyB0bwoJCQkvLyAgICAgIGJldHRlciB0cmFuc2l0aW9ucyB3aXRoIGZld2VyIGJ1Z3MuIEllLCBpdCdzIG5vdCBndWFyYW50ZWVkIHRoYXQgdGhlCgkJCS8vICAgICAgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgdHJhbnNpdGlvbiB3aWxsIGJlIHJ1biBpbW1lZGlhdGVseSBhZnRlciBhcwoJCQkvLyAgICAgIGl0IGlzIHRvZGF5LiBTbyB3ZSB3YWl0IHVudGlsIHRyYW5zaXRpb24gaXMgaW52b2tlZCB0byBnYXRoZXIgdGhlIGZvbGxvd2luZwoJCQl2YXIgbm9uZSwKCQkJCXJldmVyc2VDbGFzcyA9IHRoaXMucmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJgoJCQkJCSQubW9iaWxlLndpbmRvdy53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoOwoKCQkJdGhpcy50b1Njcm9sbCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkubGFzdFNjcm9sbCB8fCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCgkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8ICEkLnN1cHBvcnQuY3NzQW5pbWF0aW9ucyB8fAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlIHx8ICF0aGlzLm5hbWUgfHwgdGhpcy5uYW1lID09PSAibm9uZSIgfHwKCQkJCU1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRoaXMudG9TY3JvbGwgKSA+CgkJCQkJJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbigpOwoKCQkJdGhpcy50b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQlpZiAoIHRoaXMuJGZyb20gJiYgIW5vbmUgKSB7CgkJCQl0aGlzLnN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5kb25lT3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgdHJ1ZSApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5kZWZlcnJlZC5wcm9taXNlKCk7CgkJfQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5TZXJpYWxUcmFuc2l0aW9uLnByb3RvdHlwZSwgJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQlzZXF1ZW50aWFsOiB0cnVlLAoKCQliZWZvcmVEb25lT3V0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLiRmcm9tICkgewoJCQkJdGhpcy5jbGVhbkZyb20oKTsKCQkJfQoJCX0sCgoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbiggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKSB7CgkJCXRoaXMuJGZyb20uYW5pbWF0aW9uQ29tcGxldGUoJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQkJfSwgdGhpcyApKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24ucHJvdG90eXBlLCAkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXNlcXVlbnRpYWw6IGZhbHNlLAoKCQliZWZvcmVEb25lSW46IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMuJGZyb20gKSB7CgkJCQl0aGlzLmNsZWFuRnJvbSgpOwoJCQl9CgkJfSwKCgkJYmVmb3JlU3RhcnRPdXQ6IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApIHsKCQkJdGhpcy5kb25lT3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCApIHsKCgkvLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKCXZhciBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKCS8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwoJJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJCSJzZXF1ZW50aWFsIjogJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbiwKCQkic2ltdWx0YW5lb3VzIjogJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24KCX07CgoJLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KCSQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zZXF1ZW50aWFsOwoKCSQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCgkvLyBJZiB0cmFuc2l0aW9uIGlzIGRlZmluZWQsIGNoZWNrIGlmIGNzcyAzRCB0cmFuc2Zvcm1zIGFyZSBzdXBwb3J0ZWQsIGFuZCBpZiBub3QsIGlmIGEgZmFsbGJhY2sgaXMgc3BlY2lmaWVkCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCWlmICggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXTsKCQl9CgoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvLyBTZXQgdGhlIGdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gdG8gZGVmYXVsdCBpZiBubyBpbXBsZW1lbnRhdGlvbiB3YXMgc2V0IGJ5IHVzZXIKCSQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHx8IGRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBwb3AgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnBvcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBVc2UgdGhlIHNpbXVsdGFuZW91cyB0cmFuc2l0aW9ucyBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWRvd24gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZG93biA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVmYWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZmFkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGV1cCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGV1cCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgdHVybiBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MudHVybiA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07Ci8vIEJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzOwoKLy8gQXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgl0YXJnZXQgPSAkKCB0YXJnZXQgKTsKCgkvLyBEZWdyYWRlIGlucHV0cyB0byBhdm9pZCBwb29ybHkgaW1wbGVtZW50ZWQgbmF0aXZlIGZ1bmN0aW9uYWxpdHkKCXRhcmdldC5maW5kKCAiaW5wdXQiICkubm90KCAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSApLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gfHwgInRleHQiLAoJCQlodG1sLCBoYXNUeXBlLCBmaW5kc3RyLCByZXBzdHI7CgoJCWlmICggJC5tb2JpbGUuZGVncmFkZUlucHV0c1sgdHlwZSBdICkgewoJCQlodG1sID0gJCggIjxkaXY+IiApLmh0bWwoIGVsZW1lbnQuY2xvbmUoKSApLmh0bWwoKTsKCQkJLy8gSW4gSUUgYnJvd3NlcnMsIHRoZSB0eXBlIHNvbWV0aW1lcyBkb2Vzbid0IGV4aXN0IGluIHRoZSBjbG9uZWQgbWFya3VwLCBzbyB3ZSByZXBsYWNlIHRoZSBjbG9zaW5nIHRhZyBpbnN0ZWFkCgkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMTsKCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LzsKCQkJcmVwc3RyID0gIiB0eXBlPVwiIiArIG9wdFR5cGUgKyAiXCIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT1cIiIgKyB0eXBlICsgIlwiIiArICggaGFzVHlwZSA/ICIiIDogIj4iICk7CgoJCQllbGVtZW50LnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS5wYWdlLCB7CglvcHRpb25zOiB7CgoJCS8vIEFjY2VwdHMgbGVmdCwgcmlnaHQgYW5kIG5vbmUKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlLAoJCWRpYWxvZzogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaWFsb2cgKSB7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lubmVyOiB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKSwKCQkJCV9oZWFkZXJDbG9zZUJ1dHRvbjogbnVsbAoJCQl9KTsKCgkJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJCXRoaXMuX3NldENsb3NlQnRuKCB0aGlzLm9wdGlvbnMuY2xvc2VCdG4gKTsKCQkJfQoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nIGFuZCB3cmFwIGludGVyaW9yCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlhbG9nICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1kaWFsb2ciICkKCQkJCS53cmFwSW5uZXIoICQoICI8ZGl2Lz4iLCB7CgoJCQkJCS8vIEFSSUEgcm9sZQoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsKCQkJCQkJKCB0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApCgkJCQl9KSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2lubmVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsICEhb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJCWN1cnJlbnRPcHRzLm92ZXJsYXlUaGVtZSA9IG9wdGlvbnMub3ZlcmxheVRoZW1lOwoJCQkJdGhpcy5faGFuZGxlUGFnZUJlZm9yZVNob3coKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gY3VycmVudE9wdHMuY2xvc2VCdG47CgkJCWNsb3NlQnV0dG9uVGV4dCA9IG9wdGlvbnMuY2xvc2VCdG5UZXh0OwoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBvcHRpb25zLmNsb3NlQnRuOwoJCX0KCgkJaWYgKCBjbG9zZUJ1dHRvbkxvY2F0aW9uICkgewoJCQl0aGlzLl9zZXRDbG9zZUJ0biggY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0ICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uICgpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgJiYgdGhpcy5vcHRpb25zLmRpYWxvZyApIHsKCQkJdGhpcy5yZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kKCk7CgkJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJfQoJfSwKCglfc2V0Q2xvc2VCdG46IGZ1bmN0aW9uKCBsb2NhdGlvbiwgdGV4dCApIHsKCQl2YXIgZHN0LAoJCQlidG4gPSB0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbjsKCgkJLy8gU2FuaXRpemUgdmFsdWUKCQlsb2NhdGlvbiA9ICJsZWZ0IiA9PT0gbG9jYXRpb24gPyAibGVmdCIgOiAicmlnaHQiID09PSBsb2NhdGlvbiA/ICJyaWdodCIgOiAibm9uZSI7CgoJCWlmICggIm5vbmUiID09PSBsb2NhdGlvbiApIHsKCQkJaWYgKCBidG4gKSB7CgkJCQlidG4ucmVtb3ZlKCk7CgkJCQlidG4gPSBudWxsOwoJCQl9CgkJfSBlbHNlIGlmICggYnRuICkgewoJCQlidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIGxvY2F0aW9uICk7CgkJCWlmICggdGV4dCApIHsKCQkJCWJ0bi50ZXh0KCB0ZXh0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlkc3QgPSB0aGlzLl9pbm5lci5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKTsKCQkJYnRuID0gJCggIjxhPjwvYT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJImNsYXNzIjogInVpLWJ0biB1aS1jb3JuZXItYWxsIHVpLWljb24tZGVsZXRlIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1idG4tIiArIGxvY2F0aW9uCgkJCQl9KQoJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiLCAiYmFjayIgKQoJCQkJLnRleHQoIHRleHQgfHwgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCB8fCAiIiApCgkJCQkucHJlcGVuZFRvKCBkc3QgKTsKCQl9CgoJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gYnRuOwoJfQp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCB7CglvcHRpb25zOiB7CgoJCS8vIEFjY2VwdHMgbGVmdCwgcmlnaHQgYW5kIG5vbmUKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlCgl9LAoKCS8vIE92ZXJyaWRlIHRoZSB0aGVtZSBzZXQgYnkgdGhlIHBhZ2UgcGx1Z2luIG9uIHBhZ2VzaG93CglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gdHJ1ZTsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkucGFnZSggInNldENvbnRhaW5lckJhY2tncm91bmQiLCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfQoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7Cgl9LAoKCS8vIGNsaWNrIGFuZCBzdWJtaXQgZXZlbnRzOgoJLy8gLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZwoJLy8gICBvcGVuZWQgd2l0aCB1bmxlc3MgYSBkYXRhLXRyYW5zaXRpb24gaXMgc3BlY2lmaWVkIG9uIHRoZSBsaW5rL2Zvcm0KCS8vIC0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIKCS8vICAgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJX2hhbmRsZVZDbGlja1N1Ym1pdDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBhdHRycywKCQkJJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICk7CgoJCWlmICggJHRhcmdldC5sZW5ndGggJiYgISR0YXJnZXQuanFtRGF0YSggInRyYW5zaXRpb24iICkgKSB7CgkJCWF0dHJzID0ge307CgkJCWF0dHJzWyAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIgXSA9CgkJCQkoICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge30gKVsgInRyYW5zaXRpb24iIF0gfHwKCQkJCSQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOwoJCQlhdHRyc1sgImRhdGEtIiArICQubW9iaWxlLm5zICsgImRpcmVjdGlvbiIgXSA9ICJyZXZlcnNlIjsKCQkJJHRhcmdldC5hdHRyKCBhdHRycyApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nIGFuZCB3cmFwIGludGVyaW9yCgkJZWxlbS5hZGRDbGFzcyggInVpLWRpYWxvZyIgKQoJCQkud3JhcElubmVyKCAkKCAiPGRpdi8+IiwgewoKCQkJCS8vIEFSSUEgcm9sZQoJCQkJInJvbGUiIDogImRpYWxvZyIsCgkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArCgkJCQkJKCAhIW9wdHMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApCgkJCX0pKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2lzQ2xvc2VhYmxlOiBmYWxzZSwKCQkJX2lubmVyOiBlbGVtLmNoaWxkcmVuKCksCgkJCV9oZWFkZXJDbG9zZUJ1dHRvbjogbnVsbAoJCX0pOwoKCQl0aGlzLl9vbiggZWxlbSwgewoJCQl2Y2xpY2s6ICJfaGFuZGxlVkNsaWNrU3VibWl0IiwKCQkJc3VibWl0OiAiX2hhbmRsZVZDbGlja1N1Ym1pdCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJcGFnZWJlZm9yZWhpZGU6ICJfaGFuZGxlUGFnZUJlZm9yZUhpZGUiCgkJfSk7CgoJCXRoaXMuX3NldENsb3NlQnRuKCBvcHRzLmNsb3NlQnRuICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0LAoJCQljdXJyZW50T3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faW5uZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgISFvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5vdmVybGF5VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAkLm1vYmlsZS5hY3RpdmVQYWdlWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQkJY3VycmVudE9wdHMub3ZlcmxheVRoZW1lID0gb3B0aW9ucy5vdmVybGF5VGhlbWU7CgkJCQl0aGlzLl9oYW5kbGVQYWdlQmVmb3JlU2hvdygpOwoJCQl9CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG5UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBjdXJyZW50T3B0cy5jbG9zZUJ0bjsKCQkJY2xvc2VCdXR0b25UZXh0ID0gb3B0aW9ucy5jbG9zZUJ0blRleHQ7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IG9wdGlvbnMuY2xvc2VCdG47CgkJfQoKCQlpZiAoIGNsb3NlQnV0dG9uTG9jYXRpb24gKSB7CgkJCXRoaXMuX3NldENsb3NlQnRuKCBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRDbG9zZUJ0bjogZnVuY3Rpb24oIGxvY2F0aW9uLCB0ZXh0ICkgewoJCXZhciBkc3QsCgkJCWJ0biA9IHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uOwoKCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCWxvY2F0aW9uID0gImxlZnQiID09PSBsb2NhdGlvbiA/ICJsZWZ0IiA6ICJyaWdodCIgPT09IGxvY2F0aW9uID8gInJpZ2h0IiA6ICJub25lIjsKCgkJaWYgKCAibm9uZSIgPT09IGxvY2F0aW9uICkgewoJCQlpZiAoIGJ0biApIHsKCQkJCWJ0bi5yZW1vdmUoKTsKCQkJCWJ0biA9IG51bGw7CgkJCX0KCQl9IGVsc2UgaWYgKCBidG4gKSB7CgkJCWJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi0iICsgbG9jYXRpb24gKTsKCQkJaWYgKCB0ZXh0ICkgewoJCQkJYnRuLnRleHQoIHRleHQgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWRzdCA9IHRoaXMuX2lubmVyLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maXJzdCgpOwoJCQlidG4gPSAkKCAiPGE+PC9hPiIsIHsKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBoaXN0ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeTsKCgkJaWYgKCB0aGlzLl9pc0Nsb3NlYWJsZSApIHsKCQkJdGhpcy5faXNDbG9zZWFibGUgPSBmYWxzZTsKCQkJLy8gSWYgdGhlIGhhc2ggbGlzdGVuaW5nIGlzIGVuYWJsZWQgYW5kIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBwcmVjZWRpbmcgaGlzdG9yeQoJCQkvLyBlbnRyeSBpdCdzIG9rIHRvIGdvIGJhY2suIEluaXRpYWwgcGFnZXMgd2l0aCB0aGUgZGlhbG9nIGhhc2ggc3RhdGUgYXJlIGFuIGV4YW1wbGUKCQkJLy8gd2hlcmUgdGhlIHN0YWNrIGNoZWNrIGlzIG5lY2Vzc2FyeQoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmIGhpc3QuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAiYmFjayIgKTsKCQkJfQoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBySW5pdGlhbExldHRlciA9IC8oW0EtWl0pL2csCgoJLy8gQ29uc3RydWN0IGljb25wb3MgY2xhc3MgZnJvbSBpY29ucG9zIHZhbHVlCglpY29ucG9zQ2xhc3MgPSBmdW5jdGlvbiggaWNvbnBvcyApIHsKCQlyZXR1cm4gKCAidWktYnRuLWljb24tIiArICggaWNvbnBvcyA9PT0gbnVsbCA/ICJsZWZ0IiA6IGljb25wb3MgKSApOwoJfTsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JyksIiArCgkJCQkJCSI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZXNldCcpIiArCgkJCQkJCSggJC5tb2JpbGUuY29sbGFwc2libGVzZXQgPyAiLCA6bW9iaWxlLWNvbGxhcHNpYmxlc2V0IiA6CgkJCQkJCQkiIiApICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICkKCQkJfTsKCgkJdGhpcy5fdWkgPSB1aTsKCQl0aGlzLl9yZW5kZXJlZE9wdGlvbnMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoJCQl1aS5jb250ZW50ID0gdWkuaGVhZGluZy5uZXh0KCk7CgkJCXVpLmFuY2hvciA9ICQoICJhIiwgdWkuaGVhZGluZ1sgMCBdICkuZmlyc3QoKTsKCQkJdWkuc3RhdHVzID0gdWkuYW5jaG9yLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2VuaGFuY2UoIGVsZW0sIHVpICk7CgkJfQoKCQl0aGlzLl9vbiggdWkuaGVhZGluZywgewoJCQkidGFwIjogZnVuY3Rpb24oKSB7CgkJCQl1aS5oZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0sCgoJCQkiY2xpY2siOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggIXVpLmhlYWRpbmcuaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIEFkanVzdCB0aGUga2V5cyBpbnNpZGUgb3B0aW9ucyBmb3IgaW5oZXJpdGVkIHZhbHVlcwoJX2dldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXksCgkJCWFjY29yZGlvbiA9IHRoaXMuX3VpLmFjY29yZGlvbiwKCQkJYWNjb3JkaW9uV2lkZ2V0ID0gdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0OwoKCQkvLyBDb3B5IG9wdGlvbnMKCQlvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJCWlmICggYWNjb3JkaW9uLmxlbmd0aCAmJiAhYWNjb3JkaW9uV2lkZ2V0ICkgewoJCQl0aGlzLl91aS5hY2NvcmRpb25XaWRnZXQgPQoJCQlhY2NvcmRpb25XaWRnZXQgPSBhY2NvcmRpb24uZGF0YSggIm1vYmlsZS1jb2xsYXBzaWJsZXNldCIgKTsKCQl9CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoKCQkJLy8gUmV0cmlldmUgdGhlIG9wdGlvbiB2YWx1ZSBmaXJzdCBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW4gYW5kLCBpZgoJCQkvLyBudWxsLCBmcm9tIHRoZSBwYXJlbnQgYWNjb3JkaW9uIG9yLCBpZiB0aGF0J3MgbnVsbCB0b28sIG9yIGlmIHRoZXJlJ3Mgbm8KCQkJLy8gcGFyZW50IGFjY29yZGlvbiwgdGhlbiBmcm9tIHRoZSBkZWZhdWx0cy4KCQkJb3B0aW9uc1sga2V5IF0gPQoJCQkJKCBvcHRpb25zWyBrZXkgXSAhPSBudWxsICkgPyBvcHRpb25zWyBrZXkgXSA6CgkJCQkoIGFjY29yZGlvbldpZGdldCApID8gYWNjb3JkaW9uV2lkZ2V0Lm9wdGlvbnNbIGtleSBdIDoKCQkJCWFjY29yZGlvbi5sZW5ndGggPyAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGFjY29yZGlvblsgMCBdLAoJCQkJCWtleS5yZXBsYWNlKCBySW5pdGlhbExldHRlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICk6CgkJCQludWxsOwoKCQkJaWYgKCBudWxsID09IG9wdGlvbnNbIGtleSBdICkgewoJCQkJb3B0aW9uc1sga2V5IF0gPSAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0c1sga2V5IF07CgkJCX0KCQl9CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCBlbGVtLCB1aSApIHsKCQl2YXIgaWNvbmNsYXNzLAoJCQlvcHRzID0gdGhpcy5fcmVuZGVyZWRPcHRpb25zLAoJCQljb250ZW50VGhlbWVDbGFzcyA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvcHRzLmNvbnRlbnRUaGVtZSApOwoKCQllbGVtLmFkZENsYXNzKCAidWktY29sbGFwc2libGUgIiArCgkJCSggb3B0cy5pbnNldCA/ICJ1aS1jb2xsYXBzaWJsZS1pbnNldCAiIDogIiIgKSArCgkJCSggb3B0cy5pbnNldCAmJiBvcHRzLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSArCgkJCSggY29udGVudFRoZW1lQ2xhc3MgPyAidWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQgIiA6ICIiICkgKTsKCQl1aS5vcmlnaW5hbEhlYWRpbmcgPSBlbGVtLmNoaWxkcmVuKCB0aGlzLm9wdGlvbnMuaGVhZGluZyApLmZpcnN0KCksCgkJdWkuY29udGVudCA9IGVsZW0KCQkJLndyYXBJbm5lciggIjxkaXYgIiArCgkJCQkiY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWNvbnRlbnQgIiArCgkJCQljb250ZW50VGhlbWVDbGFzcyArICInPjwvZGl2PiIgKQoJCQkuY2hpbGRyZW4oICIudWktY29sbGFwc2libGUtY29udGVudCIgKSwKCQl1aS5oZWFkaW5nID0gdWkub3JpZ2luYWxIZWFkaW5nOwoKCQkvLyBSZXBsYWNlIGNvbGxhcHNpYmxlSGVhZGluZyBpZiBpdCdzIGEgbGVnZW5kCgkJaWYgKCB1aS5oZWFkaW5nLmlzKCAibGVnZW5kIiApICkgewoJCQl1aS5oZWFkaW5nID0gJCggIjxkaXYgcm9sZT0naGVhZGluZyc+IisgdWkuaGVhZGluZy5odG1sKCkgKyI8L2Rpdj4iICk7CgkJCXVpLnBsYWNlaG9sZGVyID0gJCggIjxkaXY+PCEtLSBwbGFjZWhvbGRlciBmb3IgbGVnZW5kIC0tPjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoIHVpLm9yaWdpbmFsSGVhZGluZyApOwoJCQl1aS5vcmlnaW5hbEhlYWRpbmcucmVtb3ZlKCk7CgkJfQoKCQlpY29uY2xhc3MgPSAoIG9wdHMuY29sbGFwc2VkID8gKCBvcHRzLmNvbGxhcHNlZEljb24gPyAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uIDogIiIgKToKCQkJKCBvcHRzLmV4cGFuZGVkSWNvbiA/ICJ1aS1pY29uLSIgKyBvcHRzLmV4cGFuZGVkSWNvbiA6ICIiICkgKTsKCgkJdWkuc3RhdHVzID0gJCggIjxzcGFuIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyc+PC9zcGFuPiIgKTsKCQl1aS5hbmNob3IgPSB1aS5oZWFkaW5nCgkJCS5kZXRhY2goKQoJCQkvL21vZGlmeSBtYXJrdXAgJiBhdHRyaWJ1dGVzCgkJCS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkKCQkJLmFwcGVuZCggdWkuc3RhdHVzICkKCQkJLndyYXBJbm5lciggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXRvZ2dsZSc+PC9hPiIgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4gIiArCgkJCQkJKCBpY29uY2xhc3MgPyBpY29uY2xhc3MgKyAiICIgOiAiIiApICsKCQkJCQkoIGljb25jbGFzcyA/IGljb25wb3NDbGFzcyggb3B0cy5pY29ucG9zICkgKwoJCQkJCQkiICIgOiAiIiApICsKCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKTsKCgkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQl1aS5oZWFkaW5nLmluc2VydEJlZm9yZSggdWkuY29udGVudCApOwoKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggdGhpcy5vcHRpb25zLmNvbGxhcHNlZCApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2FwcGx5T3B0aW9ucyggdGhpcy5vcHRpb25zICk7CgkJdGhpcy5fcmVuZGVyZWRPcHRpb25zID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICk7Cgl9LAoKCV9hcHBseU9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpc0NvbGxhcHNlZCwgbmV3VGhlbWUsIG9sZFRoZW1lLCBoYXNDb3JuZXJzLCBoYXNJY29uLAoJCQllbGVtID0gdGhpcy5lbGVtZW50LAoJCQljdXJyZW50T3B0cyA9IHRoaXMuX3JlbmRlcmVkT3B0aW9ucywKCQkJdWkgPSB0aGlzLl91aSwKCQkJYW5jaG9yID0gdWkuYW5jaG9yLAoJCQlzdGF0dXMgPSB1aS5zdGF0dXMsCgkJCW9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCS8vIEZpcnN0IGFuZCBmb3JlbW9zdCB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgY29sbGFwc2libGUgaXMgaW4gdGhlIHByb3BlcgoJCS8vIHN0YXRlLCBpbiBjYXNlIHNvbWVib2R5IGRlY2lkZWQgdG8gY2hhbmdlIHRoZSBjb2xsYXBzZWQgb3B0aW9uIGF0IHRoZQoJCS8vIHNhbWUgdGltZSBhcyBhbm90aGVyIG9wdGlvbgoJCWlmICggb3B0aW9ucy5jb2xsYXBzZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIG9wdGlvbnMuY29sbGFwc2VkICk7CgkJfQoKCQlpc0NvbGxhcHNlZCA9IGVsZW0uaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiICk7CgoJCS8vIFdlIG9ubHkgbmVlZCB0byBhcHBseSB0aGUgY3VlIHRleHQgZm9yIHRoZSBjdXJyZW50IHN0YXRlIHJpZ2h0IGF3YXkuCgkJLy8gVGhlIGN1ZSB0ZXh0IGZvciB0aGUgYWx0ZXJuYXRlIHN0YXRlIHdpbGwgYmUgc3RvcmVkIGluIHRoZSBvcHRpb25zCgkJLy8gYW5kIGFwcGxpZWQgdGhlIG5leHQgdGltZSB0aGUgY29sbGFwc2libGUncyBzdGF0ZSBpcyB0b2dnbGVkCgkJaWYgKCBpc0NvbGxhcHNlZCApIHsKCQkJaWYgKCBvcHRzLmV4cGFuZEN1ZVRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXN0YXR1cy50ZXh0KCBvcHRzLmV4cGFuZEN1ZVRleHQgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWlmICggb3B0cy5jb2xsYXBzZUN1ZVRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXN0YXR1cy50ZXh0KCBvcHRzLmNvbGxhcHNlQ3VlVGV4dCApOwoJCQl9CgkJfQoKCQkvLyBVcGRhdGUgaWNvbgoKCQkvLyBJcyBpdCBzdXBwb3NlZCB0byBoYXZlIGFuIGljb24/CgkJaGFzSWNvbiA9CgoJCQkvLyBJZiB0aGUgY29sbGFwc2VkSWNvbiBpcyBiZWluZyBzZXQsIGNvbnN1bHQgdGhhdAoJCQkoIG9wdHMuY29sbGFwc2VkSWNvbiAhPT0gdW5kZWZpbmVkID8gb3B0cy5jb2xsYXBzZWRJY29uICE9PSBmYWxzZSA6CgoJCQkJLy8gT3RoZXJ3aXNlIGNvbnN1bHQgdGhlIGV4aXN0aW5nIG9wdGlvbiB2YWx1ZQoJCQkJY3VycmVudE9wdHMuY29sbGFwc2VkSWNvbiAhPT0gZmFsc2UgKTsKCgoJCS8vIElmIGFueSBpY29uLXJlbGF0ZWQgb3B0aW9ucyBoYXZlIGNoYW5nZWQsIG1ha2Ugc3VyZSB0aGUgbmV3IGljb24KCQkvLyBzdGF0ZSBpcyByZWZsZWN0ZWQgYnkgZmlyc3QgcmVtb3ZpbmcgYWxsIGljb24tcmVsYXRlZCBjbGFzc2VzCgkJLy8gcmVmbGVjdGluZyB0aGUgY3VycmVudCBzdGF0ZSBhbmQgdGhlbiBhZGRpbmcgYWxsIGljb24tcmVsYXRlZAoJCS8vIGNsYXNzZXMgZm9yIHRoZSBuZXcgc3RhdGUKCQlpZiAoICEoIG9wdHMuaWNvbnBvcyA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdHMuY29sbGFwc2VkSWNvbiA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdHMuZXhwYW5kZWRJY29uID09PSB1bmRlZmluZWQgKSApIHsKCgkJCS8vIFJlbW92ZSBhbGwgY3VycmVudCBpY29uLXJlbGF0ZWQgY2xhc3NlcwoJCQlhbmNob3IucmVtb3ZlQ2xhc3MoIFsgaWNvbnBvc0NsYXNzKCBjdXJyZW50T3B0cy5pY29ucG9zICkgXQoJCQkJLmNvbmNhdCggKCBjdXJyZW50T3B0cy5leHBhbmRlZEljb24gPwoJCQkJCVsgInVpLWljb24tIiArIGN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiBdIDogW10gKSApCgkJCQkuY29uY2F0KCAoIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gPwoJCQkJCVsgInVpLWljb24tIiArIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gXSA6IFtdICkgKQoJCQkJLmpvaW4oICIgIiApICk7CgoJCQkvLyBBZGQgbmV3IGNsYXNzZXMgaWYgYW4gaWNvbiBpcyBzdXBwb3NlZCB0byBiZSBwcmVzZW50CgkJCWlmICggaGFzSWNvbiApIHsKCQkJCWFuY2hvci5hZGRDbGFzcygKCQkJCQlbIGljb25wb3NDbGFzcyggb3B0cy5pY29ucG9zICE9PSB1bmRlZmluZWQgPwoJCQkJCQlvcHRzLmljb25wb3MgOiBjdXJyZW50T3B0cy5pY29ucG9zICkgXQoJCQkJCQkuY29uY2F0KCBpc0NvbGxhcHNlZCA/CgkJCQkJCQlbICJ1aS1pY29uLSIgKyAoIG9wdHMuY29sbGFwc2VkSWNvbiAhPT0gdW5kZWZpbmVkID8KCQkJCQkJCQlvcHRzLmNvbGxhcHNlZEljb24gOgoJCQkJCQkJCWN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gKSBdIDoKCQkJCQkJCVsgInVpLWljb24tIiArICggb3B0cy5leHBhbmRlZEljb24gIT09IHVuZGVmaW5lZCA/CgkJCQkJCQkJb3B0cy5leHBhbmRlZEljb24gOgoJCQkJCQkJCWN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiApIF0gKQoJCQkJCQkuam9pbiggIiAiICkgKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRzLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW9sZFRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgY3VycmVudE9wdHMudGhlbWUgKTsKCQkJbmV3VGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICk7CgkJCWFuY2hvci5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQl9CgoJCWlmICggb3B0cy5jb250ZW50VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJb2xkVGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwKCQkJCWN1cnJlbnRPcHRzLmNvbnRlbnRUaGVtZSApOwoJCQluZXdUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLAoJCQkJb3B0cy5jb250ZW50VGhlbWUgKTsKCQkJdWkuY29udGVudC5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQl9CgoJCWlmICggb3B0cy5pbnNldCAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaW5zZXQiLCBvcHRzLmluc2V0ICk7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5pbnNldCAmJiAoIG9wdHMuY29ybmVycyB8fCBjdXJyZW50T3B0cy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0cy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5jb3JuZXJzICYmICggb3B0cy5pbnNldCB8fCBjdXJyZW50T3B0cy5pbnNldCApICk7CgkJfQoKCQlpZiAoIGhhc0Nvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBoYXNDb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdHMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlhbmNob3IudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0cy5taW5pICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdGhpcy5fYXBwbHlPcHRpb25zKCBvcHRpb25zICk7CgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQl0aGlzLl9yZW5kZXJlZE9wdGlvbnMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKTsKCX0sCgoJX2hhbmRsZUV4cGFuZENvbGxhcHNlOiBmdW5jdGlvbiggaXNDb2xsYXBzZSApIHsKCQl2YXIgb3B0cyA9IHRoaXMuX3JlbmRlcmVkT3B0aW9ucywKCQkJdWkgPSB0aGlzLl91aTsKCgkJdWkuc3RhdHVzLnRleHQoIGlzQ29sbGFwc2UgPyBvcHRzLmV4cGFuZEN1ZVRleHQgOiBvcHRzLmNvbGxhcHNlQ3VlVGV4dCApOwoJCXVpLmhlYWRpbmcKCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkKCQkJLmZpbmQoICJhIiApLmZpcnN0KCkKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24sICFpc0NvbGxhcHNlICkKCgkJCS8vIGxvZ2ljIG9yIGNhdXNlIHNhbWUgaWNvbiBmb3IgZXhwYW5kZWQvY29sbGFwc2VkIHN0YXRlIHdvdWxkIHJlbW92ZSB0aGUgdWktaWNvbi1jbGFzcwoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24sICggaXNDb2xsYXBzZSB8fCBvcHRzLmV4cGFuZGVkSWNvbiA9PT0gb3B0cy5jb2xsYXBzZWRJY29uICkgKQoJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQl1aS5jb250ZW50CgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICkKCQkJLnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJdGhpcy5vcHRpb25zLmNvbGxhcHNlZCA9IGlzQ29sbGFwc2U7CgkJdGhpcy5fdHJpZ2dlciggaXNDb2xsYXBzZSA/ICJjb2xsYXBzZSIgOiAiZXhwYW5kIiApOwoJfSwKCglleHBhbmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCBmYWxzZSApOwoJfSwKCgljb2xsYXBzZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIHRydWUgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB1aSA9IHRoaXMuX3VpLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdWkucGxhY2Vob2xkZXIgKSB7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5pbnNlcnRCZWZvcmUoIHVpLnBsYWNlaG9sZGVyICk7CgkJCXVpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJCQl1aS5oZWFkaW5nLnJlbW92ZSgpOwoJCX0gZWxzZSB7CgkJCXVpLnN0YXR1cy5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZwoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyB1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKQoJCQkJLmNoaWxkcmVuKCkKCQkJCQkuY29udGVudHMoKQoJCQkJCQkudW53cmFwKCk7CgkJfQoKCQl1aS5hbmNob3IuY29udGVudHMoKS51bndyYXAoKTsKCQl1aS5jb250ZW50LmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlIHVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCAiICsKCQkJCSJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCB1aS1jb2xsYXBzaWJsZS1pbnNldCB1aS1jb3JuZXItYWxsIiApOwoJfQp9KTsKCi8vIERlZmF1bHRzIHRvIGJlIHVzZWQgYnkgYWxsIGluc3RhbmNlcyBvZiBjb2xsYXBzaWJsZSBpZiBwZXItaW5zdGFuY2UgdmFsdWVzCi8vIGFyZSB1bnNldCBvciBpZiBub3RoaW5nIGlzIHNwZWNpZmllZCBieSB3YXkgb2YgaW5oZXJpdGFuY2UgZnJvbSBhbiBhY2NvcmRpb24uCi8vIE5vdGUgdGhhdCB0aGlzIGhhc2ggZG9lcyBub3QgY29udGFpbiBvcHRpb25zICJjb2xsYXBzZWQiIG9yICJoZWFkaW5nIiwKLy8gYmVjYXVzZSB0aG9zZSBhcmUgbm90IGluaGVyaXRhYmxlLgokLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0cyA9IHsKCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCWNvbGxhcHNlQ3VlVGV4dDogIiBjbGljayB0byBjb2xsYXBzZSBjb250ZW50cyIsCgljb2xsYXBzZWRJY29uOiAicGx1cyIsCgljb250ZW50VGhlbWU6ICJpbmhlcml0IiwKCWV4cGFuZGVkSWNvbjogIm1pbnVzIiwKCWljb25wb3M6ICJsZWZ0IiwKCWluc2V0OiB0cnVlLAoJY29ybmVyczogdHJ1ZSwKCXRoZW1lOiAiaW5oZXJpdCIsCgltaW5pOiBmYWxzZQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyA9IHsKCV9nZXRWaXNpYmxlczogZnVuY3Rpb24oICRlbHMsIGNyZWF0ZSApIHsKCQl2YXIgdmlzaWJsZXM7CgoJCWlmICggY3JlYXRlICkgewoJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdmlzaWJsZXMgPSAkZWxzLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQlpZiAoIHZpc2libGVzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHZpc2libGVzOwoJfSwKCglfYWRkRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMsICR2aXNpYmxlcywgY3JlYXRlICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJCSR2aXNpYmxlcy5lcSggMCApLmFkZENsYXNzKCAidWktZmlyc3QtY2hpbGQiICkuZW5kKCkubGFzdCgpLmFkZENsYXNzKCAidWktbGFzdC1jaGlsZCIgKTsKCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJX3JlbW92ZUZpcnN0TGFzdENsYXNzZXM6IGZ1bmN0aW9uKCAkZWxzICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciA9ICI6bW9iaWxlLWNvbGxhcHNpYmxlLCAiICsgJC5tb2JpbGUuY29sbGFwc2libGUuaW5pdFNlbGVjdG9yOwoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLmV4dGVuZCggewoKCS8vIFRoZSBpbml0U2VsZWN0b3IgaXMgZGVwcmVjYXRlZCBhcyBvZiAxLjQuMC4gSW4gMS41LjAgd2Ugd2lsbCB1c2UKCS8vIDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlc2V0Jykgd2hpY2ggd2lsbCBhbGxvdyB1cyB0byBnZXQgcmlkIG9mIHRoZSBsaW5lCgkvLyBiZWxvdyBhbHRvZ2V0aGVyLCBiZWNhdXNlIHRoZSBhdXRvaW5pdCB3aWxsIGdlbmVyYXRlIHN1Y2ggYW4gaW5pdFNlbGVjdG9yCglpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSw6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZXNldCcpIiwKCglvcHRpb25zOiAkLmV4dGVuZCggewoJCWVuaGFuY2VkOiBmYWxzZQoJfSwgJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHMgKSwKCglfaGFuZGxlQ29sbGFwc2libGVFeHBhbmQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgY2xvc2VzdENvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1jb2xsYXBzaWJsZSIgKTsKCgkJaWYgKCBjbG9zZXN0Q29sbGFwc2libGUucGFyZW50KCkuaXMoICI6bW9iaWxlLWNvbGxhcHNpYmxlc2V0LCA6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKSApIHsKCQkJY2xvc2VzdENvbGxhcHNpYmxlCgkJCQkuc2libGluZ3MoICIudWktY29sbGFwc2libGU6bm90KC51aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQpIiApCgkJCQkuY29sbGFwc2libGUoICJjb2xsYXBzZSIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY2xhc3NlczogIiIKCQl9KTsKCgkJaWYgKCAhb3B0cy5lbmhhbmNlZCApIHsKCQkJZWxlbS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktZ3JvdXAtdGhlbWUtIiwgb3B0cy50aGVtZSApICsgIiAiICsKCQkJCSggb3B0cy5jb3JuZXJzICYmIG9wdHMuaW5zZXQgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSApOwoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGUuY29sbGFwc2libGUuaW5pdFNlbGVjdG9yICkuY29sbGFwc2libGUoKTsKCQl9CgoJCXRoaXMuX29uKCBlbGVtLCB7IGNvbGxhcHNpYmxlZXhwYW5kOiAiX2hhbmRsZUNvbGxhcHNpYmxlRXhwYW5kIiB9ICk7Cgl9LAoKCV90aGVtZUNsYXNzRnJvbU9wdGlvbjogZnVuY3Rpb24oIHByZWZpeCwgdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6IHByZWZpeCArIHZhbHVlICkgOiAiIiApOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCggdHJ1ZSApOwoKCQkvLyBCZWNhdXNlIHRoZSBjb3JuZXJzIGFyZSBoYW5kbGVkIGJ5IHRoZSBjb2xsYXBzaWJsZSBpdHNlbGYgYW5kIHRoZSBkZWZhdWx0IHN0YXRlIGlzIGNvbGxhcHNlZAoJCS8vIFRoYXQgd2FzIGNhdXNpbmcgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80MTE2CgkJdGhpcy5lbGVtZW50CgkJCS5jaGlsZHJlbiggY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciApCgkJCS5maWx0ZXIoICI6anFtRGF0YShjb2xsYXBzZWQ9J2ZhbHNlJykiICkKCQkJLmNvbGxhcHNpYmxlKCAiZXhwYW5kIiApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJldCwgaGFzQ29ybmVycywKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJdGhlbWVDbGFzcyA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktZ3JvdXAtdGhlbWUtIiwgb3B0aW9ucy50aGVtZSApOwoKCQlpZiAoIHRoZW1lQ2xhc3MgKSB7CgkJCWVsZW0KCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCB0aGlzLm9wdGlvbnMudGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoZW1lQ2xhc3MgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5pbnNldCAhPT0gdW5kZWZpbmVkICkgewoJCQloYXNDb3JuZXJzID0gISEoIG9wdGlvbnMuaW5zZXQgJiYgKCBvcHRpb25zLmNvcm5lcnMgfHwgdGhpcy5vcHRpb25zLmNvcm5lcnMgKSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJaGFzQ29ybmVycyA9ICEhKCBvcHRpb25zLmNvcm5lcnMgJiYgKCBvcHRpb25zLmluc2V0IHx8IHRoaXMub3B0aW9ucy5pbnNldCApICk7CgkJfQoKCQlpZiAoIGhhc0Nvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBoYXNDb3JuZXJzICk7CgkJfQoKCQlyZXQgPSB0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJCXRoaXMuZWxlbWVudC5jaGlsZHJlbiggIjptb2JpbGUtY29sbGFwc2libGUiICkuY29sbGFwc2libGUoICJyZWZyZXNoIiApOwoJCXJldHVybiByZXQ7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCXRoaXMuX3JlbW92ZUZpcnN0TGFzdENsYXNzZXMoIGVsLmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICkgKTsKCQllbAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQgdWktY29ybmVyLWFsbCAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktZ3JvdXAtdGhlbWUtIiwgdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkuY2hpbGRyZW4oICI6bW9iaWxlLWNvbGxhcHNpYmxlIiApCgkJCS5jb2xsYXBzaWJsZSggImRlc3Ryb3kiICk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBjb2xsYXBzaWJsZXNJblNldCA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciApOwoKCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGUuY29sbGFwc2libGUuaW5pdFNlbGVjdG9yICkubm90KCAiLnVpLWNvbGxhcHNpYmxlIiApLmNvbGxhcHNpYmxlKCk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGNvbGxhcHNpYmxlc0luU2V0LCB0aGlzLl9nZXRWaXNpYmxlcyggY29sbGFwc2libGVzSW5TZXQsIGNyZWF0ZSApLCBjcmVhdGUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBEZXByZWNhdGVkIGluIDEuNAokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKC8qIG9wdGlvbnMgKi8pIHsKCXJldHVybiB0aGlzLmFkZENsYXNzKCAidWktZmllbGQtY29udGFpbiIgKTsKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5ncmlkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQlncmlkOiBudWxsCgkJCX0sIG9wdGlvbnMgKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHsgc29sbzoxLCBhOjIsIGI6MywgYzo0LCBkOjUgfSwKCQkJZ3JpZCA9IG8uZ3JpZCwKCQkJaXRlcmF0b3IsCgkJCWxldHRlcjsKCgkJCWlmICggIWdyaWQgKSB7CgkJCQlpZiAoICRraWRzLmxlbmd0aCA8PSA1ICkgewoJCQkJCWZvciAoIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLWR1byIgKTsKCQkJCX0KCQkJfQoJCQlpdGVyYXRvciA9IGdyaWRDb2xzW2dyaWRdOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtIiArIGdyaWQgKTsKCgkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisxKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWEiICk7CgoJCWlmICggaXRlcmF0b3IgPiAxICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzIpIiApLmFkZENsYXNzKCAidWktYmxvY2stYiIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDIgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMykiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1jIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMyApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis0KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWQiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiA0ICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzUpIiApLmFkZENsYXNzKCAidWktYmxvY2stZSIgKTsKCQl9Cgl9KTsKfTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCB7CglvcHRpb25zOiB7CgkJaWNvbnBvczogInRvcCIsCgkJZ3JpZDogbnVsbAoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/IHRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIiApCgkJCS5hdHRyKCAicm9sZSIsICJuYXZpZ2F0aW9uIiApCgkJCS5maW5kKCAidWwiICkKCQkJLmpxbUVuaGFuY2VhYmxlKCkKCQkJLmdyaWQoeyBncmlkOiB0aGlzLm9wdGlvbnMuZ3JpZCB9KTsKCgkJJG5hdmJ0bnMKCQkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIGljb24gPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJpY29uIiApLAoJCQkJCXRoZW1lID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAidGhlbWUiICksCgkJCQkJY2xhc3NlcyA9ICJ1aS1idG4iOwoKCQkJCWlmICggdGhlbWUgKSB7CgkJCQkJY2xhc3NlcyArPSAiIHVpLWJ0bi0iICsgdGhlbWU7CgkJCQl9CgkJCQlpZiAoIGljb24gKSB7CgkJCQkJY2xhc3NlcyArPSAiIHVpLWljb24tIiArIGljb24gKyAiIHVpLWJ0bi1pY29uLSIgKyBpY29ucG9zOwoJCQkJfQoJCQkJJCggdGhpcyApLmFkZENsYXNzKCBjbGFzc2VzICk7CgkJCX0pOwoKCQkkbmF2YmFyLmRlbGVnYXRlKCAiYSIsICJ2Y2xpY2siLCBmdW5jdGlvbiggLyogZXZlbnQgKi8gKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCB0aGlzICk7CgoJCQlpZiAoICEoIGFjdGl2ZUJ0bi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApIHx8CgoJCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSBhZnRlciAxLjQuMCByZWxlYXNlCgkJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJCWFjdGl2ZUJ0bi5oYXNDbGFzcyggInVpLWRpc2FibGVkIiApIHx8CgkJCQlhY3RpdmVCdG4uaGFzQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkgKSApIHsKCgkJCQkkbmF2YnRucy5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCWFjdGl2ZUJ0bi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvLyBUaGUgY29kZSBiZWxvdyBpcyBhIHdvcmthcm91bmQgdG8gZml4ICMxMTgxCgkJCQkkKCBkb2N1bWVudCApLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJYWN0aXZlQnRuLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfSk7CgkJCX0KCQl9KTsKCgkJLy8gQnV0dG9ucyBpbiB0aGUgbmF2YmFyIHdpdGggdWktc3RhdGUtcGVyc2lzdCBjbGFzcyBzaG91bGQgcmVnYWluIHRoZWlyIGFjdGl2ZSBzdGF0ZSBiZWZvcmUgcGFnZSBzaG93CgkJJG5hdmJhci5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCSRuYXZidG5zLmZpbHRlciggIi51aS1zdGF0ZS1wZXJzaXN0IiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGdldEF0dHIgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGU7CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQuZXh0ZW5kKCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6IG51bGwsIC8qIERlcHJlY2F0ZWQgaW4gMS40ICovCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWljb246ICJjYXJhdC1yIiwKCQlzcGxpdEljb246ICJjYXJhdC1yIiwKCQlzcGxpdFRoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWluc2V0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCIgOiAiIjsKCgkJaWYgKCAhIXQub3B0aW9ucy5pbnNldCApIHsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiOwoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCX0KCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyggIiB1aS1saXN0dmlldyIgKyBsaXN0dmlld0NsYXNzZXMgKTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUKCV9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBuZXh0UHJvcCwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS41CglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApIHsKCQl2YXIgaSwgaW1nLCBsZW4gPSBjb250YWluZXJzLmxlbmd0aDsKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlpbWcgPSAkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBjb250YWluZXJzWyBpIF0uZmlyc3RDaGlsZCwgIm5leHRTaWJsaW5nIiwgImltZyIsICJJTUciICkgKTsKCQkJaWYgKCBpbWcubGVuZ3RoICkgewoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmhhc0NsYXNzKCAidWktbGktaWNvbiIgKSA/ICJ1aS1saS1oYXMtaWNvbiIgOiAidWktbGktaGFzLXRodW1iIiApOwoJCQl9CgkJfQoJfSwKCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglfYmVmb3JlTGlzdHZpZXdSZWZyZXNoOiAkLm5vb3AsCglfYWZ0ZXJMaXN0dmlld1JlZnJlc2g6ICQubm9vcCwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBidXR0b25DbGFzcywgcG9zLCBudW1saSwgaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsIGl0ZW1JY29uLCBpY29uLCBhLAoJCQlpc0RpdmlkZXIsIHN0YXJ0Q291bnQsIG5ld1N0YXJ0Q291bnQsIHZhbHVlLCBsYXN0LCBzcGxpdHRoZW1lLCBzcGxpdFRoZW1lQ2xhc3MsIHNwbGl0aWNvbiwKCQkJYWx0QnV0dG9uQ2xhc3MsIGRpdmlkZXJUaGVtZSwgbGksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCSRsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlvbCA9ICEhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApLAoJCQlzdGFydCA9ICRsaXN0LmF0dHIoICJzdGFydCIgKSwKCQkJaXRlbUNsYXNzRGljdCA9IHt9LAoJCQljb3VudEJ1YmJsZXMgPSAkbGlzdC5maW5kKCAiLnVpLWxpLWNvdW50IiApLAoJCQljb3VudFRoZW1lID0gZ2V0QXR0ciggJGxpc3RbIDAgXSwgImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUsCgkJCWNvdW50VGhlbWVDbGFzcyA9IGNvdW50VGhlbWUgPyAidWktYm9keS0iICsgY291bnRUaGVtZSA6ICJ1aS1ib2R5LWluaGVyaXQiOwoKCQlpZiAoIG8udGhlbWUgKSB7CgkJCSRsaXN0LmFkZENsYXNzKCAidWktZ3JvdXAtdGhlbWUtIiArIG8udGhlbWUgKTsKCQl9CgoJCS8vIENoZWNrIGlmIGEgc3RhcnQgYXR0cmlidXRlIGhhcyBiZWVuIHNldCB3aGlsZSB0YWtpbmcgYSB2YWx1ZSBvZiAwIGludG8gYWNjb3VudAoJCWlmICggb2wgJiYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApICkgewoJCQlzdGFydENvdW50ID0gcGFyc2VJbnQoIHN0YXJ0LCAxMCApIC0gMTsKCQkJJGxpc3QuY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBzdGFydENvdW50ICk7CgkJfQoKCQl0aGlzLl9iZWZvcmVMaXN0dmlld1JlZnJlc2goKTsKCgkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApOwoKCQlmb3IgKCBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAiIjsKCgkJCWlmICggY3JlYXRlIHx8IGl0ZW1bIDAgXS5jbGFzc05hbWUuc2VhcmNoKCAvXGJ1aS1saS1zdGF0aWNcYnxcYnVpLWxpLWRpdmlkZXJcYi8gKSA8IDAgKSB7CgkJCQlhID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIGl0ZW1bIDAgXSwgImEiLCAiQSIgKTsKCQkJCWlzRGl2aWRlciA9ICggZ2V0QXR0ciggaXRlbVsgMCBdLCAicm9sZSIgKSA9PT0gImxpc3QtZGl2aWRlciIgKTsKCQkJCXZhbHVlID0gaXRlbS5hdHRyKCAidmFsdWUiICk7CgkJCQlpdGVtVGhlbWUgPSBnZXRBdHRyKCBpdGVtWyAwIF0sICJ0aGVtZSIgKTsKCgkJCQlpZiAoIGEubGVuZ3RoICYmIGFbIDAgXS5jbGFzc05hbWUuc2VhcmNoKCAvXGJ1aS1idG5cYi8gKSA8IDAgJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpdGVtSWNvbiA9IGdldEF0dHIoIGl0ZW1bIDAgXSwgImljb24iICk7CgkJCQkJaWNvbiA9ICggaXRlbUljb24gPT09IGZhbHNlICkgPyBmYWxzZSA6ICggaXRlbUljb24gfHwgby5pY29uICk7CgoJCQkJCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUgdG9nZXRoZXIgd2l0aCBsaW5rcy5qcyAobGlua3MuanMgLyAudWktbGluayBkZXByZWNhdGVkIGluIDEuNCkKCQkJCQlhLnJlbW92ZUNsYXNzKCAidWktbGluayIgKTsKCgkJCQkJYnV0dG9uQ2xhc3MgPSAidWktYnRuIjsKCgkJCQkJaWYgKCBpdGVtVGhlbWUgKSB7CgkJCQkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLSIgKyBpdGVtVGhlbWU7CgkJCQkJfQoKCQkJCQlpZiAoIGEubGVuZ3RoID4gMSApIHsKCQkJCQkJaXRlbUNsYXNzID0gInVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gZ2V0QXR0ciggbGFzdFsgMCBdLCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lIHx8IGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiwgdHJ1ZSApOwoJCQkJCQlzcGxpdFRoZW1lQ2xhc3MgPSBzcGxpdHRoZW1lID8gIiB1aS1idG4tIiArIHNwbGl0dGhlbWUgOiAiIjsKCQkJCQkJc3BsaXRpY29uID0gZ2V0QXR0ciggbGFzdFsgMCBdLCAiaWNvbiIgKSB8fCBnZXRBdHRyKCBpdGVtWyAwIF0sICJpY29uIiApIHx8IG8uc3BsaXRJY29uOwoJCQkJCQlhbHRCdXR0b25DbGFzcyA9ICJ1aS1idG4gdWktYnRuLWljb24tbm90ZXh0IHVpLWljb24tIiArIHNwbGl0aWNvbiArIHNwbGl0VGhlbWVDbGFzczsKCgkJCQkJCWxhc3QKCQkJCQkJCS5hdHRyKCAidGl0bGUiLCAkLnRyaW0oIGxhc3QuZ2V0RW5jb2RlZFRleHQoKSApICkKCQkJCQkJCS5hZGRDbGFzcyggYWx0QnV0dG9uQ2xhc3MgKQoJCQkJCQkJLmVtcHR5KCk7CgkJCQkJfSBlbHNlIGlmICggaWNvbiApIHsKCQkJCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taWNvbi1yaWdodCB1aS1pY29uLSIgKyBpY29uOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLmFkZENsYXNzKCBidXR0b25DbGFzcyApOwoJCQkJfSBlbHNlIGlmICggaXNEaXZpZGVyICkgewoJCQkJCWRpdmlkZXJUaGVtZSA9ICggZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUgfHwgby50aGVtZSApOwoKCQkJCQlpdGVtQ2xhc3MgPSAidWktbGktZGl2aWRlciB1aS1iYXItIiArICggZGl2aWRlclRoZW1lID8gZGl2aWRlclRoZW1lIDogImluaGVyaXQiICk7CgoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCQkJCX0gZWxzZSBpZiAoIGEubGVuZ3RoIDw9IDAgKSB7CgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLXN0YXRpYyB1aS1ib2R5LSIgKyAoIGl0ZW1UaGVtZSA/IGl0ZW1UaGVtZSA6ICJpbmhlcml0IiApOwoJCQkJfQoJCQkJaWYgKCBvbCAmJiB2YWx1ZSApIHsKCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VJbnQoIHZhbHVlICwgMTAgKSAtIDE7CgoJCQkJCWl0ZW0uY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBuZXdTdGFydENvdW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIEluc3RlYWQgb2Ygc2V0dGluZyBpdGVtIGNsYXNzIGRpcmVjdGx5IG9uIHRoZSBsaXN0IGl0ZW0KCQkJLy8gYXQgdGhpcyBwb2ludCBpbiB0aW1lLCBwdXNoIHRoZSBpdGVtIGludG8gYSBkaWN0aW9uYXJ5CgkJCS8vIHRoYXQgdGVsbHMgdXMgd2hhdCBjbGFzcyB0byBzZXQgb24gaXQgc28gd2UgY2FuIGRvIHRoaXMgYWZ0ZXIgdGhpcwoJCQkvLyBwcm9jZXNzaW5nIGxvb3AgaXMgZmluaXNoZWQuCgoJCQlpZiAoICFpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSApIHsKCQkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdID0gW107CgkJCX0KCgkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdLnB1c2goIGl0ZW1bIDAgXSApOwoJCX0KCgkJLy8gU2V0IHRoZSBhcHByb3ByaWF0ZSBsaXN0dmlldyBpdGVtIGNsYXNzZXMgb24gZWFjaCBsaXN0IGl0ZW0uCgkJLy8gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQljb3VudEJ1YmJsZXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJfSk7CgkJaWYgKCBjb3VudFRoZW1lQ2xhc3MgKSB7CgkJCWNvdW50QnViYmxlcy5hZGRDbGFzcyggY291bnRUaGVtZUNsYXNzICk7CgkJfQoKCQkvLyBEZXByZWNhdGVkIGluIDEuNC4gRnJvbSAxLjUgeW91IGhhdmUgdG8gYWRkIGNsYXNzIHVpLWxpLWhhcy10aHVtYiBvciB1aS1saS1oYXMtaWNvbiB0byB0aGUgTEkuCgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaSApOwoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkuZmluZCggIi51aS1idG4iICkgKTsKCgkJdGhpcy5fYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggbGksIHRoaXMuX2dldFZpc2libGVzKCBsaSwgY3JlYXRlICksIGNyZWF0ZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCmZ1bmN0aW9uIGRlZmF1bHRBdXRvZGl2aWRlcnNTZWxlY3RvciggZWx0ICkgewoJLy8gbG9vayBmb3IgdGhlIHRleHQgaW4gdGhlIGdpdmVuIGVsZW1lbnQKCXZhciB0ZXh0ID0gJC50cmltKCBlbHQudGV4dCgpICkgfHwgbnVsbDsKCglpZiAoICF0ZXh0ICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIGNyZWF0ZSB0aGUgdGV4dCBmb3IgdGhlIGRpdmlkZXIgKGZpcnN0IHVwcGVyY2FzZWQgbGV0dGVyKQoJdGV4dCA9IHRleHQuc2xpY2UoIDAsIDEgKS50b1VwcGVyQ2FzZSgpOwoKCXJldHVybiB0ZXh0Owp9CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLmxpc3R2aWV3LCB7CglvcHRpb25zOiB7CgkJYXV0b2RpdmlkZXJzOiBmYWxzZSwKCQlhdXRvZGl2aWRlcnNTZWxlY3RvcjogZGVmYXVsdEF1dG9kaXZpZGVyc1NlbGVjdG9yCgl9LAoKCV9iZWZvcmVMaXN0dmlld1JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmF1dG9kaXZpZGVycyApIHsKCQkJdGhpcy5fcmVwbGFjZURpdmlkZXJzKCk7CgkJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoJCX0KCX0sCgoJX3JlcGxhY2VEaXZpZGVyczogZnVuY3Rpb24oKSB7CgkJdmFyIGksIGxpcywgbGksIGRpdmlkZXJUZXh0LAoJCQlsYXN0RGl2aWRlclRleHQgPSBudWxsLAoJCQlsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlkaXZpZGVyOwoKCQlsaXN0LmNoaWxkcmVuKCAibGk6anFtRGF0YShyb2xlPSdsaXN0LWRpdmlkZXInKSIgKS5yZW1vdmUoKTsKCgkJbGlzID0gbGlzdC5jaGlsZHJlbiggImxpIiApOwoKCQlmb3IgKCBpID0gMDsgaSA8IGxpcy5sZW5ndGggOyBpKysgKSB7CgkJCWxpID0gbGlzWyBpIF07CgkJCWRpdmlkZXJUZXh0ID0gdGhpcy5vcHRpb25zLmF1dG9kaXZpZGVyc1NlbGVjdG9yKCAkKCBsaSApICk7CgoJCQlpZiAoIGRpdmlkZXJUZXh0ICYmIGxhc3REaXZpZGVyVGV4dCAhPT0gZGl2aWRlclRleHQgKSB7CgkJCQlkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxpIiApOwoJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGRpdmlkZXJUZXh0ICkgKTsKCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsICJsaXN0LWRpdmlkZXIiICk7CgkJCQlsaS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZGl2aWRlciwgbGkgKTsKCQkJfQoKCQkJbGFzdERpdmlkZXJUZXh0ID0gZGl2aWRlclRleHQ7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJkaXZpZGVyID0gLyhefFxzKXVpLWxpLWRpdmlkZXIoJHxccykvLAoJcmhpZGRlbiA9IC8oXnxccyl1aS1zY3JlZW4taGlkZGVuKCR8XHMpLzsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUubGlzdHZpZXcsIHsKCW9wdGlvbnM6IHsKCQloaWRlRGl2aWRlcnM6IGZhbHNlCgl9LAoKCV9hZnRlckxpc3R2aWV3UmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGl0ZW1zLCBpZHgsIGl0ZW0sIGhpZGVEaXZpZGVyID0gdHJ1ZTsKCgkJdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhpZGVEaXZpZGVycyApIHsKCQkJaXRlbXMgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggdGhpcy5lbGVtZW50WyAwIF0sICJsaSIsICJMSSIgKTsKCQkJZm9yICggaWR4ID0gaXRlbXMubGVuZ3RoIC0gMSA7IGlkeCA+IC0xIDsgaWR4LS0gKSB7CgkJCQlpdGVtID0gaXRlbXNbIGlkeCBdOwoJCQkJaWYgKCBpdGVtLmNsYXNzTmFtZS5tYXRjaCggcmRpdmlkZXIgKSApIHsKCQkJCQlpZiAoIGhpZGVEaXZpZGVyICkgewoJCQkJCQlpdGVtLmNsYXNzTmFtZSA9IGl0ZW0uY2xhc3NOYW1lICsgIiB1aS1zY3JlZW4taGlkZGVuIjsKCQkJCQl9CgkJCQkJaGlkZURpdmlkZXIgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQlpZiAoICFpdGVtLmNsYXNzTmFtZS5tYXRjaCggcmhpZGRlbiApICkgewoJCQkJCQloaWRlRGl2aWRlciA9IGZhbHNlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLm5vanMgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJJCggIjpqcW1EYXRhKHJvbGU9J25vanMnKSIsIHRhcmdldCApLmFkZENsYXNzKCAidWktbm9qcyIgKTsKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCA9IHsKCV9oYW5kbGVGb3JtUmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZGVsYXkoICJfcmVzZXQiICk7CgkJCX0KCQl9KTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgZXNjYXBlSWQgPSAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yOwoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQuZXh0ZW5kKCB7CgoJaW5pdFNlbGVjdG9yOiAiaW5wdXQ6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJyApIClbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcgKSkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogImluaGVyaXQiLAoJCW1pbmk6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJaWNvbnBvczogImxlZnQiCgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJaW5oZXJpdEF0dHIgPSBmdW5jdGlvbiggaW5wdXQsIGRhdGFBdHRyICkgewoJCQkJcmV0dXJuIGlucHV0LmpxbURhdGEoIGRhdGFBdHRyICkgfHwKCQkJCQlpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gaW5wdXQuY2xvc2VzdCggImxhYmVsIiApLAoJCQlsYWJlbCA9IHBhcmVudExhYmVsLmxlbmd0aCA/IHBhcmVudExhYmVsIDoKCQkJCWlucHV0CgkJCQkJLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkJCS5maW5kKCAibGFiZWwiICkKCQkJCQkuZmlsdGVyKCAiW2Zvcj0nIiArIGVzY2FwZUlkKCBpbnB1dFswXS5pZCApICsgIiddIiApCgkJCQkJLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyBpbnB1dHR5cGUgKyAiLW9mZiI7CgoJCWlmICggaW5wdXR0eXBlICE9PSAiY2hlY2tib3giICYmIGlucHV0dHlwZSAhPT0gInJhZGlvIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0aGlzLmVsZW1lbnRbMF0uZGlzYWJsZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlvLmljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApIHx8IGxhYmVsLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiApIHx8IG8uaWNvbnBvcywKCgkJLy8gRXN0YWJsaXNoIG9wdGlvbnMKCQlvLm1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaTsKCgkJLy8gRXhwb3NlIGZvciBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJaW5wdXQ6IGlucHV0LAoJCQlsYWJlbDogbGFiZWwsCgkJCXBhcmVudExhYmVsOiBwYXJlbnRMYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MKCQl9KTsKCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggbGFiZWwsIHsKCQkJdm1vdXNlb3ZlcjogIl9oYW5kbGVMYWJlbFZNb3VzZU92ZXIiLAoJCQl2Y2xpY2s6ICJfaGFuZGxlTGFiZWxWQ2xpY2siCgkJfSk7CgoJCXRoaXMuX29uKCBpbnB1dCwgewoJCQl2bW91c2Vkb3duOiAiX2NhY2hlVmFscyIsCgkJCXZjbGljazogIl9oYW5kbGVJbnB1dFZDbGljayIsCgkJCWZvY3VzOiAiX2hhbmRsZUlucHV0Rm9jdXMiLAoJCQlibHVyOiAiX2hhbmRsZUlucHV0Qmx1ciIKCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAidWktYnRuIHVpLWNvcm5lci1hbGwiKTsKCgkJaWYgKCB0aGlzLnBhcmVudExhYmVsLmxlbmd0aCA+IDAgKSB7CgkJCXRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICk7CgkJfSBlbHNlIHsKCQkJLy90aGlzLmVsZW1lbnQucmVwbGFjZVdpdGgoIHRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICkgKTsKCQkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX3dyYXBwZXIoKSApOwoJCQl0aGlzLmVsZW1lbnQucGFyZW50KCkucHJlcGVuZCggdGhpcy5sYWJlbCApOwoJCX0KCgkJLy8gV3JhcCB0aGUgaW5wdXQgKyBsYWJlbCBpbiBhIGRpdgoKCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJInRoZW1lIjogdGhpcy5vcHRpb25zLnRoZW1lLAoJCQkiaWNvbnBvcyI6IHRoaXMub3B0aW9ucy5pY29ucG9zLAoJCQkibWluaSI6IHRoaXMub3B0aW9ucy5taW5pCgkJfSk7CgoJfSwKCglfd3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSciICArCgkJCSggdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA/IHRoaXMub3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsKCQkJIiB1aS0iICsgdGhpcy5pbnB1dHR5cGUgKwoJCQkoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArICInID48L2Rpdj4iICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX2hhbmRsZUlucHV0VkNsaWNrOiBmdW5jdGlvbigpIHsKCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgdGhpcy5lbGVtZW50LmlzKCAiOmNoZWNrZWQiICkgKTsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLm5vdCggdGhpcy5lbGVtZW50ICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCXRoaXMuX3VwZGF0ZUFsbCgpOwoJfSwKCglfaGFuZGxlTGFiZWxWTW91c2VPdmVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLmxhYmVsLnBhcmVudCgpLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCX0sCgoJX2hhbmRsZUxhYmVsVkNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50OwoKCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9jYWNoZVZhbHMoKTsKCgkJaW5wdXQucHJvcCggImNoZWNrZWQiLCB0aGlzLmlucHV0dHlwZSA9PT0gInJhZGlvIiAmJiB0cnVlIHx8ICFpbnB1dC5wcm9wKCAiY2hlY2tlZCIgKSApOwoKCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCS8vIFRPRE86IGl0IHdvdWxkIGJlIG5pY2UgdG8gbGV0IHRoZSBicm93c2VyJ3MgaGFuZGxlIHRoZSBjbGlja3MgYW5kIHBhc3MgdGhlbQoJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJaW5wdXQudHJpZ2dlckhhbmRsZXIoICJjbGljayIgKTsKCgkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJLy8gb2Ygb3RoZXIgcmFkaW9zIGVuc3VyZXMgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUgaXMgYXBwbGllZCBwcm9wZXJseQoJCXRoaXMuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJdGhpcy5fdXBkYXRlQWxsKCk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfY2FjaGVWYWxzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuYXR0cigiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy8gUmV0dXJucyB0aG9zZSByYWRpbyBidXR0b25zIHRoYXQgYXJlIHN1cHBvc2VkIHRvIGJlIGluIHRoZSBzYW1lIGdyb3VwIGFzCgkvLyB0aGlzIHJhZGlvIGJ1dHRvbi4gSW4gdGhlIGNhc2Ugb2YgYSBjaGVja2JveCBvciBhIHJhZGlvIGxhY2tpbmcgYSBuYW1lCgkvLyBhdHRyaWJ1dGUsIGl0IHJldHVybnMgdGhpcy5lbGVtZW50LgoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0b3IsIGZvcm1JZCwKCQkJcmFkaW8gPSB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJbmFtZSA9IHJhZGlvLm5hbWUsCgkJCWZvcm0gPSByYWRpby5mb3JtLAoJCQlkb2MgPSB0aGlzLmVsZW1lbnQucGFyZW50cygpLmxhc3QoKS5nZXQoIDAgKSwKCgkJCS8vIEEgcmFkaW8gaXMgYWx3YXlzIGEgbWVtYmVyIG9mIGl0cyBvd24gZ3JvdXAKCQkJcmFkaW9zID0gdGhpcy5lbGVtZW50OwoKCQkvLyBPbmx5IHN0YXJ0IHJ1bm5pbmcgc2VsZWN0b3JzIGlmIHRoaXMgaXMgYW4gYXR0YWNoZWQgcmFkaW8gYnV0dG9uIHdpdGggYSBuYW1lCgkJaWYgKCBuYW1lICYmIHRoaXMuaW5wdXR0eXBlID09PSAicmFkaW8iICYmIGRvYyApIHsKCQkJc2VsZWN0b3IgPSAiaW5wdXRbdHlwZT0ncmFkaW8nXVtuYW1lPSciICsgZXNjYXBlSWQoIG5hbWUgKSArICInXSI7CgoJCQkvLyBJZiB3ZSdyZSBpbnNpZGUgYSBmb3JtCgkJCWlmICggZm9ybSApIHsKCQkJCWZvcm1JZCA9IGZvcm0uaWQ7CgoJCQkJLy8gSWYgdGhlIGZvcm0gaGFzIGFuIElELCBjb2xsZWN0IHJhZGlvcyBzY2F0dGVyZWQgdGhyb3VnaHQgdGhlIGRvY3VtZW50IHdoaWNoCgkJCQkvLyBuZXZlcnRoZWxlc3MgYXJlIHBhcnQgb2YgdGhlIGZvcm0gYnkgd2F5IG9mIHRoZSB2YWx1ZSBvZiB0aGVpciBmb3JtIGF0dHJpYnV0ZQoJCQkJaWYgKCBmb3JtSWQgKSB7CgkJCQkJcmFkaW9zID0gJCggc2VsZWN0b3IgKyAiW2Zvcm09JyIgKyBlc2NhcGVJZCggZm9ybUlkICkgKyAiJ10iLCBkb2MgKTsKCQkJCX0KCgkJCQkvLyBBbHNvIGFkZCB0byB0aG9zZSB0aGUgcmFkaW9zIGluIHRoZSBmb3JtIGl0c2VsZgoJCQkJcmFkaW9zID0gJCggZm9ybSApLmZpbmQoIHNlbGVjdG9yICkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCgkJCQkJLy8gU29tZSByYWRpb3MgaW5zaWRlIHRoZSBmb3JtIG1heSBiZWxvbmcgdG8gc29tZSBvdGhlciBmb3JtIGJ5IHZpcnR1ZSBvZgoJCQkJCS8vIGhhdmluZyBhIGZvcm0gYXR0cmlidXRlIGRlZmluZWQgb24gdGhlbSwgc28gd2UgbXVzdCBmaWx0ZXIgdGhlbSBvdXQgaGVyZQoJCQkJCXJldHVybiAoIHRoaXMuZm9ybSA9PT0gZm9ybSApOwoJCQkJfSkuYWRkKCByYWRpb3MgKTsKCgkJCS8vIElmIHdlJ3JlIG91dHNpZGUgYSBmb3JtCgkJCX0gZWxzZSB7CgoJCQkJLy8gQ29sbGVjdCBhbGwgdGhvc2UgcmFkaW9zIHdoaWNoIGFyZSBhbHNvIG91dHNpZGUgb2YgYSBmb3JtIGFuZCBtYXRjaCBvdXIgbmFtZQoJCQkJcmFkaW9zID0gJCggc2VsZWN0b3IsIGRvYyApLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICF0aGlzLmZvcm07CgkJCQl9KTsKCQkJfQoJCX0KCQlyZXR1cm4gcmFkaW9zOwoJfSwKCglfdXBkYXRlQWxsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggdGhpcy5jaGVja2VkIHx8IHNlbGYuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJJHRoaXMudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0pCgkJLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCgkvLyBJcyB0aGUgd2lkZ2V0IHN1cHBvc2VkIHRvIGRpc3BsYXkgYW4gaWNvbj8KCV9oYXNJY29uOiBmdW5jdGlvbigpIHsKCQl2YXIgY29udHJvbGdyb3VwLCBjb250cm9sZ3JvdXBXaWRnZXQsCgkJCWNvbnRyb2xncm91cENvbnN0cnVjdG9yID0gJC5tb2JpbGUuY29udHJvbGdyb3VwOwoKCQkvLyBJZiB0aGUgY29udHJvbGdyb3VwIHdpZGdldCBpcyBkZWZpbmVkIC4uLgoJCWlmICggY29udHJvbGdyb3VwQ29uc3RydWN0b3IgKSB7CgkJCWNvbnRyb2xncm91cCA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KAoJCQkJIjptb2JpbGUtY29udHJvbGdyb3VwLCIgKwoJCQkJY29udHJvbGdyb3VwQ29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciApOwoKCQkJLy8gLi4uIGFuZCB0aGUgY2hlY2tib3ggaXMgaW4gYSBjb250cm9sZ3JvdXAgLi4uCgkJCWlmICggY29udHJvbGdyb3VwLmxlbmd0aCA+IDAgKSB7CgoJCQkJLy8gLi4uIGxvb2sgZm9yIGEgY29udHJvbGdyb3VwIHdpZGdldCBpbnN0YW5jZSwgYW5kIC4uLgoJCQkJY29udHJvbGdyb3VwV2lkZ2V0ID0gJC5kYXRhKCBjb250cm9sZ3JvdXBbIDAgXSwgIm1vYmlsZS1jb250cm9sZ3JvdXAiICk7CgoJCQkJLy8gLi4uIGlmIGZvdW5kLCBkZWNpZGUgYmFzZWQgb24gdGhlIG9wdGlvbiB2YWx1ZSwgLi4uCgkJCQlyZXR1cm4gKCAoIGNvbnRyb2xncm91cFdpZGdldCA/IGNvbnRyb2xncm91cFdpZGdldC5vcHRpb25zLnR5cGUgOgoKCQkJCQkvLyAuLi4gb3RoZXJ3aXNlIGRlY2lkZSBiYXNlZCBvbiB0aGUgInR5cGUiIGRhdGEgYXR0cmlidXRlLgoJCQkJCWNvbnRyb2xncm91cC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIgKSApICE9PSAiaG9yaXpvbnRhbCIgKTsKCQkJfQoJCX0KCgkJLy8gTm9ybWFsbHksIHRoZSB3aWRnZXQgZGlzcGxheXMgYW4gaWNvbi4KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGhhc0ljb24gPSB0aGlzLl9oYXNJY29uKCksCgkJCWlzQ2hlY2tlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQsCgkJCWFjdGl2ZSA9ICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzLAoJCQlpY29ucG9zQ2xhc3MgPSAidWktYnRuLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29ucG9zLAoJCQlhZGRDbGFzc2VzID0gW10sCgkJCXJlbW92ZUNsYXNzZXMgPSBbXTsKCgkJaWYgKCBoYXNJY29uICkgewoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIGFjdGl2ZSApOwoJCQlhZGRDbGFzc2VzLnB1c2goIGljb25wb3NDbGFzcyApOwoJCX0gZWxzZSB7CgkJCXJlbW92ZUNsYXNzZXMucHVzaCggaWNvbnBvc0NsYXNzICk7CgkJCSggaXNDaGVja2VkID8gYWRkQ2xhc3NlcyA6IHJlbW92ZUNsYXNzZXMgKS5wdXNoKCBhY3RpdmUgKTsKCQl9CgoJCWlmICggaXNDaGVja2VkICkgewoJCQlhZGRDbGFzc2VzLnB1c2goIHRoaXMuY2hlY2tlZENsYXNzICk7CgkJCXJlbW92ZUNsYXNzZXMucHVzaCggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCX0gZWxzZSB7CgkJCWFkZENsYXNzZXMucHVzaCggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIHRoaXMuY2hlY2tlZENsYXNzICk7CgkJfQoKCQl0aGlzLmxhYmVsCgkJCS5hZGRDbGFzcyggYWRkQ2xhc3Nlcy5qb2luKCAiICIgKSApCgkJCS5yZW1vdmVDbGFzcyggcmVtb3ZlQ2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmxhYmVsLnBhcmVudCgpOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGxhYmVsID0gdGhpcy5sYWJlbCwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCW91dGVyID0gdGhpcy53aWRnZXQoKSwKCQkJaGFzSWNvbiA9IHRoaXMuX2hhc0ljb24oKTsKCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuaW5wdXQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISFvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWxhYmVsCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIGN1cnJlbnRPcHRpb25zLnRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMud3JhcHBlckNsYXNzICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyCgkJCQkucmVtb3ZlQ2xhc3MoIGN1cnJlbnRPcHRpb25zLndyYXBwZXJDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIG9wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoJCWlmICggb3B0aW9ucy5pY29ucG9zICE9PSB1bmRlZmluZWQgJiYgaGFzSWNvbiApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgY3VycmVudE9wdGlvbnMuaWNvbnBvcyApLmFkZENsYXNzKCAidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApOwoJCX0gZWxzZSBpZiAoICFoYXNJY29uICkgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggInVpLWJ0bi1pY29uLSIgKyBjdXJyZW50T3B0aW9ucy5pY29ucG9zICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9Cgp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuYnV0dG9uIiwgewoKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2J1dHRvbiddLCBpbnB1dFt0eXBlPSdzdWJtaXQnXSwgaW5wdXRbdHlwZT0ncmVzZXQnXSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogImxlZnQiLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbmxpbmU6IG51bGwsCgkJbWluaTogbnVsbCwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQlpZiAoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJd3JhcHBlcjogdGhpcy5lbGVtZW50LnBhcmVudCgpCgkJfSk7CgoJCXRoaXMuX29uKCB7CgkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSwKCgkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9CgkJfSk7CgoJCXRoaXMucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX2J1dHRvbigpICk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpY29uQ2xhc3NlcyA9IHRoaXMuX2dldEljb25DbGFzc2VzKCB0aGlzLm9wdGlvbnMgKTsKCgkJcmV0dXJuICQoIjxkaXYgY2xhc3M9J3VpLWJ0biB1aS1pbnB1dC1idG4iICsKCQkJKCBvcHRpb25zLndyYXBwZXJDbGFzcyA/ICIgIiArIG9wdGlvbnMud3JhcHBlckNsYXNzIDogIiIgKSArCgkJCSggb3B0aW9ucy50aGVtZSA/ICIgdWktYnRuLSIgKyBvcHRpb25zLnRoZW1lIDogIiIgKSArCgkJCSggb3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkgKwoJCQkoIG9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSArCgkJCSggb3B0aW9ucy5pbmxpbmUgPyAiIHVpLWJ0bi1pbmxpbmUiIDogIiIgKSArCgkJCSggb3B0aW9ucy5taW5pID8gIiB1aS1taW5pIiA6ICIiICkgKwoJCQkoIG9wdGlvbnMuZGlzYWJsZWQgPyAiIHVpLXN0YXRlLWRpc2FibGVkIiA6ICIiICkgKwoJCQkoIGljb25DbGFzc2VzID8gKCAiICIgKyBpY29uQ2xhc3NlcyApIDogIiIgKSArCgkJCSInID4iICsgdGhpcy5lbGVtZW50LnZhbCgpICsgIjwvZGl2PiIgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy53cmFwcGVyOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5pbnNlcnRCZWZvcmUoIHRoaXMuYnV0dG9uICk7CgkJCXRoaXMuYnV0dG9uLnJlbW92ZSgpOwoJfSwKCglfZ2V0SWNvbkNsYXNzZXM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXJldHVybiAoIG9wdGlvbnMuaWNvbiA/ICggInVpLWljb24tIiArIG9wdGlvbnMuaWNvbiArCgkJCSggb3B0aW9ucy5pY29uc2hhZG93ID8gIiB1aS1zaGFkb3ctaWNvbiIgOiAiIiApICsgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJCSIgdWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApIDogIiIgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvdXRlciA9IHRoaXMud2lkZ2V0KCk7CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmlubGluZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLWJ0bi1pbmxpbmUiLCBvcHRpb25zLmlubGluZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaWNvbiAhPT0gdW5kZWZpbmVkIHx8CgkJCQlvcHRpb25zLmljb25zaGFkb3cgIT09IHVuZGVmaW5lZCB8fCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQkJCW9wdGlvbnMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl9nZXRJY29uQ2xhc3NlcyggdGhpcy5vcHRpb25zICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl9nZXRJY29uQ2xhc3NlcygKCQkJCQkkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyApICkgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyIG9yaWdpbmFsRWxlbWVudCwKCQkJaXNEaXNhYmxlZCA9IHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICk7CgoJCWlmICggdGhpcy5vcHRpb25zLmljb24gJiYgdGhpcy5vcHRpb25zLmljb25wb3MgPT09ICJub3RleHQiICYmIHRoaXMuZWxlbWVudC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAidGl0bGUiLCB0aGlzLmVsZW1lbnQudmFsKCkgKTsKCQl9CgkJaWYgKCAhY3JlYXRlICkgewoJCQlvcmlnaW5hbEVsZW1lbnQgPSB0aGlzLmVsZW1lbnQuZGV0YWNoKCk7CgkJCSQoIHRoaXMud3JhcHBlciApLnRleHQoIHRoaXMuZWxlbWVudC52YWwoKSApLmFwcGVuZCggb3JpZ2luYWxFbGVtZW50ICk7CgkJfQoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICE9PSBpc0Rpc2FibGVkICkgewoJCQl0aGlzLl9zZXRPcHRpb25zKHsgZGlzYWJsZWQ6IGlzRGlzYWJsZWQgfSk7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCgkJaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAoJCWRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAoJCWVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCgkkLm1vYmlsZS56b29tID0gJC5leHRlbmQoIHt9LCB7CgkJZW5hYmxlZDogIWRpc2FibGVkSW5pdGlhbGx5LAoJCWxvY2tlZDogZmFsc2UsCgkJZGlzYWJsZTogZnVuY3Rpb24oIGxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICggISQubW9iaWxlLnpvb20ubG9ja2VkIHx8IHVubG9jayA9PT0gdHJ1ZSApICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGluaXRpYWxDb250ZW50ICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoJfSk7Cgp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsIHsKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwiICsKCQkiaW5wdXRbdHlwZT0nc2VhcmNoJ10sIiArCgkJIjpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCIgKwoJCSJpbnB1dFt0eXBlPSdudW1iZXInXSwiICsKCQkiOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIiArCgkJImlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIiArCgkJImlucHV0W3R5cGU9J2VtYWlsJ10sIiArCgkJImlucHV0W3R5cGU9J3VybCddLCIgKwoJCSJpbnB1dFt0eXBlPSd0ZWwnXSwiICsKCQkidGV4dGFyZWEsIiArCgkJImlucHV0W3R5cGU9J3RpbWUnXSwiICsKCQkiaW5wdXRbdHlwZT0nZGF0ZSddLCIgKwoJCSJpbnB1dFt0eXBlPSdtb250aCddLCIgKwoJCSJpbnB1dFt0eXBlPSd3ZWVrJ10sIiArCgkJImlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIiArCgkJImlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIiArCgkJImlucHV0W3R5cGU9J2NvbG9yJ10sIiArCgkJImlucHV0Om5vdChbdHlwZV0pLCIgKwoJCSJpbnB1dFt0eXBlPSdmaWxlJ10iLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJd3JhcHBlckNsYXNzOiAiIiwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpc1NlYXJjaCA9IHRoaXMuZWxlbWVudC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWlzVGV4dGFyZWEgPSB0aGlzLmVsZW1lbnRbIDAgXS50YWdOYW1lID09PSAiVEVYVEFSRUEiLAoJCQlpc1JhbmdlID0gdGhpcy5lbGVtZW50LmlzKCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ0eXBlPSdyYW5nZSddIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9ICggKHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApIHx8CgkJCQl0aGlzLmVsZW1lbnQuaXMoICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInR5cGU9J3NlYXJjaCddIiApICkgJiYKCQkJCQkhaXNSYW5nZSApOwoKCQlpZiAoIHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICkgKSB7CgkJCW9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJY2xhc3NlczogdGhpcy5fY2xhc3Nlc0Zyb21PcHRpb25zKCksCgkJCWlzU2VhcmNoOiBpc1NlYXJjaCwKCQkJaXNUZXh0YXJlYTogaXNUZXh0YXJlYSwKCQkJaXNSYW5nZTogaXNSYW5nZSwKCQkJaW5wdXROZWVkc1dyYXA6IGlucHV0TmVlZHNXcmFwCgkJfSk7CgoJCXRoaXMuX2F1dG9Db3JyZWN0KCk7CgoJCWlmICggIW9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCXRoaXMuX29uKCB7CgkJCSJmb2N1cyI6ICJfaGFuZGxlRm9jdXMiLAoJCQkiYmx1ciI6ICJfaGFuZGxlQmx1ciIKCQl9KTsKCgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0T3B0aW9ucyh7CgkJCSJkaXNhYmxlZCIgOiB0aGlzLmVsZW1lbnQuaXMoICI6ZGlzYWJsZWQiICkKCQl9KTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50Q2xhc3NlcyA9IFtdOwoKCQlpZiAoIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJZWxlbWVudENsYXNzZXMucHVzaCggInVpLWlucHV0LXRleHQiICk7CgkJfQoKCQlpZiAoIHRoaXMuaXNUZXh0YXJlYSB8fCB0aGlzLmlzUmFuZ2UgKSB7CgkJCWVsZW1lbnRDbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ctaW5zZXQiICk7CgkJfQoKCQkvLyJzZWFyY2giIGFuZCAidGV4dCIgaW5wdXQgd2lkZ2V0cwoJCWlmICggdGhpcy5pbnB1dE5lZWRzV3JhcCApIHsKCQkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX3dyYXAoKSApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnRDbGFzc2VzID0gZWxlbWVudENsYXNzZXMuY29uY2F0KCB0aGlzLmNsYXNzZXMgKTsKCQl9CgoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggZWxlbWVudENsYXNzZXMuam9pbiggIiAiICkgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLmlucHV0TmVlZHNXcmFwICkgPyB0aGlzLmVsZW1lbnQucGFyZW50KCkgOiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCV9jbGFzc2VzRnJvbU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQljbGFzc2VzID0gW107CgoJCWNsYXNzZXMucHVzaCggInVpLWJvZHktIiArICggKCBvcHRpb25zLnRoZW1lID09PSBudWxsICkgPyAiaW5oZXJpdCIgOiBvcHRpb25zLnRoZW1lICkgKTsKCQlpZiAoIG9wdGlvbnMuY29ybmVycyApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktY29ybmVyLWFsbCIgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLW1pbmkiICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktc3RhdGUtZGlzYWJsZWQiICk7CgkJfQoJCWlmICggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKSB7CgkJCWNsYXNzZXMucHVzaCggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgoJCXJldHVybiBjbGFzc2VzOwoJfSwKCglfd3JhcDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSciICsKCQkJKCB0aGlzLmlzU2VhcmNoID8gInVpLWlucHV0LXNlYXJjaCAiIDogInVpLWlucHV0LXRleHQgIiApICsKCQkJdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICsgIiAiICsKCQkJInVpLXNoYWRvdy1pbnNldCc+PC9kaXY+IiApOwoJfSwKCglfYXV0b0NvcnJlY3Q6IGZ1bmN0aW9uKCkgewoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LgoJCS8vICAgICAgLSBqYmxhcwoJCWlmICggdHlwZW9mIHRoaXMuZWxlbWVudFswXS5hdXRvY29ycmVjdCAhPT0gInVuZGVmaW5lZCIgJiYKCQkJISQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICkgewoKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCX0sCgoJX2hhbmRsZUJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMud2lkZ2V0KCkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCX0KCX0sCgoJX2hhbmRsZUZvY3VzOiBmdW5jdGlvbigpIHsKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgaW5wdXQgdXBvbiB0YXAsIHRoaXMKCQkvLyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJaWYgKCB0aGlzLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJfQoJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uICggb3B0aW9ucyApIHsKCQl2YXIgb3V0ZXIgPSB0aGlzLndpZGdldCgpOwoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQlpZiAoICEoIG9wdGlvbnMuZGlzYWJsZWQgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLm1pbmkgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLmNvcm5lcnMgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLnRoZW1lID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy53cmFwcGVyQ2xhc3MgPT09IHVuZGVmaW5lZCApICkgewoKCQkJb3V0ZXIucmVtb3ZlQ2xhc3MoIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJCQl0aGlzLmNsYXNzZXMgPSB0aGlzLl9jbGFzc2VzRnJvbU9wdGlvbnMoKTsKCQkJb3V0ZXIuYWRkQ2xhc3MoIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC51bndyYXAoKTsKCQl9CgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaW5wdXQtdGV4dCAiICsgdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zbGlkZXIiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiLAoKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQl0cmFja1RoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaGlnaGxpZ2h0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGNvbnRyb2xbIDAgXSwgInRoZW1lIiApLAoJCQl0cmFja1RoZW1lQ2xhc3MgPSB0cmFja1RoZW1lID8gIiB1aS1iYXItIiArIHRyYWNrVGhlbWUgOiAiIHVpLWJhci1pbmhlcml0IiwKCQkJY29ybmVyQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5jb3JuZXJzIHx8IGNvbnRyb2wuanFtRGF0YSggImNvcm5lcnMiICkgKSA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJbWluaUNsYXNzID0gKCB0aGlzLm9wdGlvbnMubWluaSB8fCBjb250cm9sLmpxbURhdGEoICJtaW5pIiApICkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzVG9nZ2xlU3dpdGNoID0gKCBjVHlwZSA9PT0gInNlbGVjdCIgKSwKCQkJaXNSYW5nZXNsaWRlciA9IGNvbnRyb2wucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiApLAoJCQlzZWxlY3RDbGFzcyA9ICggaXNUb2dnbGVTd2l0Y2ggKSA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICIiLAoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCQkJJGxhYmVsID0gJCggIltmb3I9JyIgKyBjb250cm9sSUQgKyAiJ10iICksCgkJCWxhYmVsSUQgPSAkbGFiZWwuYXR0ciggImlkIiApIHx8IGNvbnRyb2xJRCArICItbGFiZWwiLAoJCQltaW4gPSAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9ICAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCQkJc3RlcCA9IHdpbmRvdy5wYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApIHx8IDEgKSwKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCQkJdmFsdWViZyA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIWlzVG9nZ2xlU3dpdGNoID8gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfSkoKSA6IGZhbHNlLAoJCQlvcHRpb25zLAoJCQl3cmFwcGVyLAoJCQlqLCBsZW5ndGgsCgkJCWksIG9wdGlvbnNDb3VudCwgb3JpZ1RhYkluZGV4LAoJCQlzaWRlLCBhY3RpdmVDbGFzcywgc2xpZGVySW1nOwoKCQkkbGFiZWwuYXR0ciggImlkIiwgbGFiZWxJRCApOwoJCXRoaXMuaXNUb2dnbGVTd2l0Y2ggPSBpc1RvZ2dsZVN3aXRjaDsKCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJhcHBsaWNhdGlvbiIgKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0ICIgOiAidWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCAiLCBzZWxlY3RDbGFzcywgdHJhY2tUaGVtZUNsYXNzLCBjb3JuZXJDbGFzcywgbWluaUNsYXNzIF0uam9pbiggIiIgKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gInVpLXNsaWRlci1oYW5kbGUiOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggZG9tSGFuZGxlICk7CgoJCWhhbmRsZS5hdHRyKHsKCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJImFyaWEtdmFsdWVtaW4iOiBtaW4sCgkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkiYXJpYS12YWx1ZW5vdyI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLXZhbHVldGV4dCI6IHRoaXMuX3ZhbHVlKCksCgkJCSJ0aXRsZSI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNsaWRlcjogc2xpZGVyLAoJCQloYW5kbGU6IGhhbmRsZSwKCQkJY29udHJvbDogY29udHJvbCwKCQkJdHlwZTogY1R5cGUsCgkJCXN0ZXA6IHN0ZXAsCgkJCW1heDogbWF4LAoJCQltaW46IG1pbiwKCQkJdmFsdWViZzogdmFsdWViZywKCQkJaXNSYW5nZXNsaWRlcjogaXNSYW5nZXNsaWRlciwKCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQliZWZvcmVTdGFydDogbnVsbCwKCQkJdXNlck1vZGlmaWVkOiBmYWxzZSwKCQkJbW91c2VNb3ZlZDogZmFsc2UKCQl9KTsKCgkJaWYgKCBpc1RvZ2dsZVN3aXRjaCApIHsKCQkJLy8gVE9ETzogcmVzdG9yZSBvcmlnaW5hbCB0YWJpbmRleCAoaWYgYW55KSBpbiBhIGRlc3Ryb3kgbWV0aG9kCgkJCW9yaWdUYWJJbmRleCA9IGNvbnRyb2wuYXR0ciggInRhYmluZGV4IiApOwoJCQlpZiAoIG9yaWdUYWJJbmRleCApIHsKCQkJCWhhbmRsZS5hdHRyKCAidGFiaW5kZXgiLCBvcmlnVGFiSW5kZXggKTsKCQkJfQoJCQljb250cm9sLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQloYW5kbGUuZm9jdXMoKTsKCQkJfSk7CgoJCQl3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAidWktc2xpZGVyLWlubmVyb2Zmc2V0IjsKCgkJCWZvciAoIGogPSAwLCBsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7IGogPCBsZW5ndGg7IGorKyApIHsKCQkJCXdyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdICk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggd3JhcHBlciApOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yICggaSA9IDAsIG9wdGlvbnNDb3VudCA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgb3B0aW9uc0NvdW50OyBpKysgKSB7CgkJCQlzaWRlID0gIWkgPyAiYiIgOiAiYSI7CgkJCQlhY3RpdmVDbGFzcyA9ICFpID8gIiIgOiAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbICJ1aS1zbGlkZXItbGFiZWwgdWktc2xpZGVyLWxhYmVsLSIsIHNpZGUsIGFjdGl2ZUNsYXNzIF0uam9pbiggIiIgKTsKCQkJCXNsaWRlckltZy5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImltZyIgKTsKCQkJCXNsaWRlckltZy5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdGlvbnNbaV0uaW5uZXJIVE1MICkgKTsKCQkJCSQoIHNsaWRlckltZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyLXN3aXRjaCIgOiAidWktc2xpZGVyLWlucHV0IiApOwoKCQl0aGlzLl9vbiggY29udHJvbCwgewoJCQkiY2hhbmdlIjogIl9jb250cm9sQ2hhbmdlIiwKCQkJImtleXVwIjogIl9jb250cm9sS2V5dXAiLAoJCQkiYmx1ciI6ICJfY29udHJvbEJsdXIiLAoJCQkidm1vdXNldXAiOiAiX2NvbnRyb2xWTW91c2VVcCIKCQl9KTsKCgkJc2xpZGVyLmJpbmQoICJ2bW91c2Vkb3duIiwgJC5wcm94eSggdGhpcy5fc2xpZGVyVk1vdXNlRG93biwgdGhpcyApICkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQkvLyBXZSBoYXZlIHRvIGluc3RhbnRpYXRlIGEgbmV3IGZ1bmN0aW9uIG9iamVjdCBmb3IgdGhlIHVuYmluZCB0byB3b3JrIHByb3Blcmx5CgkJLy8gc2luY2UgdGhlIG1ldGhvZCBpdHNlbGYgaXMgZGVmaW5lZCBpbiB0aGUgcHJvdG90eXBlIChjYXVzaW5nIGl0IHRvIHVuYmluZCBldmVyeXRoaW5nKQoJCXRoaXMuX29uKCBkb2N1bWVudCwgeyAidm1vdXNlbW92ZSI6ICJfcHJldmVudERvY3VtZW50RHJhZyIgfSk7CgkJdGhpcy5fb24oIHNsaWRlci5hZGQoIGRvY3VtZW50ICksIHsgInZtb3VzZXVwIjogIl9zbGlkZXJWTW91c2VVcCIgfSk7CgoJCXNsaWRlci5pbnNlcnRBZnRlciggY29udHJvbCApOwoKCQkvLyB3cmFwIGluIGEgZGl2IGZvciBzdHlsaW5nIHB1cnBvc2VzCgkJaWYgKCAhaXNUb2dnbGVTd2l0Y2ggJiYgIWlzUmFuZ2VzbGlkZXIgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLm9wdGlvbnMubWluaSA/ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXIgdWktbWluaSc+IiA6ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXInPiI7CgoJCQljb250cm9sLmFkZCggc2xpZGVyICkud3JhcEFsbCggd3JhcHBlciApOwoJCX0KCgkJLy8gYmluZCB0aGUgaGFuZGxlIGV2ZW50IGNhbGxiYWNrcyBhbmQgc2V0IHRoZSBjb250ZXh0IHRvIHRoZSB3aWRnZXQgaW5zdGFuY2UKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGUsIHsKCQkJInZtb3VzZWRvd24iOiAiX2hhbmRsZVZNb3VzZURvd24iLAoJCQkia2V5ZG93biI6ICJfaGFuZGxlS2V5ZG93biIsCgkJCSJrZXl1cCI6ICJfaGFuZGxlS2V5dXAiCgkJfSk7CgoJCXRoaXMuaGFuZGxlLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRoZW1lKCBvcHRpb25zLnRoZW1lICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMudHJhY2tUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUcmFja1RoZW1lKCBvcHRpb25zLnRyYWNrVGhlbWUgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldENvcm5lcnMoIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0TWluaSggb3B0aW9ucy5taW5pICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaGlnaGxpZ2h0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldEhpZ2hsaWdodCggb3B0aW9ucy5oaWdobGlnaHQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXREaXNhYmxlZCggb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfY29udHJvbENoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIGlmIHRoZSB1c2VyIGRyYWdnZWQgdGhlIGhhbmRsZSwgdGhlICJjaGFuZ2UiIGV2ZW50IHdhcyB0cmlnZ2VyZWQgZnJvbSBpbnNpZGUgcmVmcmVzaCgpOyBkb24ndCBjYWxsIHJlZnJlc2goKSBhZ2FpbgoJCWlmICggdGhpcy5fdHJpZ2dlciggImNvbnRyb2xjaGFuZ2UiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoICF0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJCX0KCX0sCgoJX2NvbnRyb2xLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsgLy8gbmVjZXNzYXJ5PwoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSwgdHJ1ZSApOwoJfSwKCglfY29udHJvbEJsdXI6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7Cgl9LAoKCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkvLyBibHVycmVkLiBIZXJlIHdlIGNoZWNrIHRoaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkIGFuZCByZWZyZXNoCglfY29udHJvbFZNb3VzZVVwOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMuX2NoZWNrZWRSZWZyZXNoKCk7Cgl9LAoKCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCglfaGFuZGxlVk1vdXNlRG93bjogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLmhhbmRsZS5mb2N1cygpOwoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpbmRleCA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQlpZiAoICF0aGlzLl9rZXlTbGlkaW5nICkgewoJCQkJCXRoaXMuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOyAvKiBUT0RPOiBXZSBkb24ndCB1c2UgdGhpcyBjbGFzcyBmb3Igc3R5bGluZy4gRG8gd2UgbmVlZCB0byBhZGQgaXQ/ICovCgkJCQl9CgoJCQkJYnJlYWs7CgkJfQoKCQkvLyBtb3ZlIHRoZSBzbGlkZXIgYWNjb3JkaW5nIHRvIHRoZSBrZXlwcmVzcwoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1pbiApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWF4ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCArIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggLSB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCX0KCX0sIC8vIHJlbW92ZSBhY3RpdmUgbWFyawoKCV9oYW5kbGVLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQlpZiAoIHRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7IC8qIFNlZSBjb21tZW50IGFib3ZlLiAqLwoJCX0KCX0sCgoJX3NsaWRlclZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhKCBldmVudC53aGljaCA9PT0gMSB8fCBldmVudC53aGljaCA9PT0gMCB8fCBldmVudC53aGljaCA9PT0gdW5kZWZpbmVkICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3Jlc3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCQl0aGlzLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuYmVmb3JlU3RhcnQgPSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQl9CgoJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiICk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfc2xpZGVyVk1vdXNlVXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5kcmFnZ2luZyApIHsKCQkJdGhpcy5kcmFnZ2luZyA9IGZhbHNlOwoKCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQkJaWYgKCB0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJaWYgKCB0aGlzLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfcHJldmVudERvY3VtZW50RHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggdGhpcy5fdHJpZ2dlciggImRyYWciLCBldmVudCApID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggdGhpcy5kcmFnZ2luZyAmJiAhdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoKCQkJCS8vIHRoaXMubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJdGhpcy5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgdGhpcy51c2VyTW9kaWZpZWQKCQkJCXRoaXMudXNlck1vZGlmaWVkID0gdGhpcy5iZWZvcmVTdGFydCAhPT0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCV9jaGVja2VkUmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnZhbHVlICE9PSB0aGlzLl92YWx1ZSgpICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCkgKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXggOiBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQudmFsKCkgKSA7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIGZhbHNlLCB0cnVlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCB2YWwsIGlzZnJvbUNvbnRyb2wsIHByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCByZXR1cm4gaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gc3VwcG9ydCBwcm9ncmFtbWF0aWMKCQkvLyAgICAgICBhbHRlcmF0aW9uIG9mIHRoZSBpbnB1dCB2YWx1ZSwgd2hpY2ggc2hvdWxkIHN0aWxsIHVwZGF0ZSB0aGUgc2xpZGVyCgoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFsgMCBdLCAidGhlbWUiICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0aGVtZUNsYXNzID0gIHRoZW1lID8gIiB1aS1idG4tIiArIHRoZW1lIDogIiIsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdHJhY2tUaGVtZUNsYXNzID0gdHJhY2tUaGVtZSA/ICIgdWktYmFyLSIgKyB0cmFja1RoZW1lIDogIiB1aS1iYXItaW5oZXJpdCIsCgkJCWNvcm5lckNsYXNzID0gdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCW1pbmlDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gIiB1aS1taW5pIiA6ICIiLAoJCQlsZWZ0LCB3aWR0aCwgZGF0YSwgdG9sLAoJCQlweFN0ZXAsIHBlcmNlbnQsCgkJCWNvbnRyb2wsIGlzSW5wdXQsIG9wdGlvbkVsZW1lbnRzLCBtaW4sIG1heCwgc3RlcCwKCQkJbmV3dmFsLCB2YWxNb2RTdGVwLCBhbGlnblZhbHVlLCBwZXJjZW50UGVyU3RlcCwKCQkJaGFuZGxlUGVyY2VudCwgYVBlcmNlbnQsIGJQZXJjZW50LAoJCQl2YWx1ZUNoYW5nZWQ7CgoJCXNlbGYuc2xpZGVyWzBdLmNsYXNzTmFtZSA9IFsgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgdWktc2xpZGVyLXN3aXRjaCB1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0IiA6ICJ1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0IiwgdHJhY2tUaGVtZUNsYXNzLCBjb3JuZXJDbGFzcywgbWluaUNsYXNzIF0uam9pbiggIiIgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIHNldCB0aGUgc3RvcmVkIHZhbHVlIGZvciBjb21wYXJpc29uIGxhdGVyCgkJdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmIHRoaXMuc2xpZGVyLmZpbmQoICIudWktc2xpZGVyLWJnIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy52YWx1ZWJnID0gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzZWxmLnNsaWRlciApOwoJCQl9KSgpOwoJCX0KCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLWJ0biIgKyB0aGVtZUNsYXNzICsgIiB1aS1zaGFkb3ciICk7CgoJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQ7CgkJaXNJbnB1dCA9ICF0aGlzLmlzVG9nZ2xlU3dpdGNoOwoJCW9wdGlvbkVsZW1lbnRzID0gaXNJbnB1dCA/IFtdIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoJCW1pbiA9ICBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwOwoJCW1heCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IG9wdGlvbkVsZW1lbnRzLmxlbmd0aCAtIDE7CgkJc3RlcCA9ICggaXNJbnB1dCAmJiBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgPiAwICkgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgOiAxOwoKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICkgewoJCQlkYXRhID0gdmFsOwoJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCXRvbCA9IDg7CgoJCQlsZWZ0ID0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdDsKCQkJd2lkdGggPSB0aGlzLnNsaWRlci53aWR0aCgpOwoJCQlweFN0ZXAgPSB3aWR0aC8oKG1heC1taW4pL3N0ZXApOwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IGxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gbGVmdCArIHdpZHRoICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggcHhTdGVwID4gMSApIHsKCQkJCXBlcmNlbnQgPSAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDA7CgkJCX0gZWxzZSB7CgkJCQlwZXJjZW50ID0gTWF0aC5yb3VuZCggKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQluZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YWxNb2RTdGVwID0gKCBuZXd2YWwgLSBtaW4gKSAlIHN0ZXA7CgkJYWxpZ25WYWx1ZSA9IG5ld3ZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCgkJcGVyY2VudFBlclN0ZXAgPSAxMDAvKChtYXgtbWluKS9zdGVwKTsKCQkvLyBTaW5jZSBKYXZhU2NyaXB0IGhhcyBwcm9ibGVtcyB3aXRoIGxhcmdlIGZsb2F0cywgcm91bmQKCQkvLyB0aGUgZmluYWwgdmFsdWUgdG8gNSBkaWdpdHMgYWZ0ZXIgdGhlIGRlY2ltYWwgcG9pbnQgKHNlZSBqUXVlcnlVSTogIzQxMjQpCgkJbmV3dmFsID0gcGFyc2VGbG9hdCggYWxpZ25WYWx1ZS50b0ZpeGVkKDUpICk7CgoJCWlmICggdHlwZW9mIHB4U3RlcCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCXB4U3RlcCA9IHdpZHRoIC8gKCAobWF4LW1pbikgLyBzdGVwICk7CgkJfQoJCWlmICggcHhTdGVwID4gMSAmJiBpc0lucHV0ICkgewoJCQlwZXJjZW50ID0gKCBuZXd2YWwgLSBtaW4gKSAqIHBlcmNlbnRQZXJTdGVwICogKCAxIC8gc3RlcCApOwoJCX0KCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCWlmICggbmV3dmFsIDwgbWluICkgewoJCQluZXd2YWwgPSBtaW47CgkJfQoKCQlpZiAoIG5ld3ZhbCA+IG1heCApIHsKCQkJbmV3dmFsID0gbWF4OwoJCX0KCgkJdGhpcy5oYW5kbGUuY3NzKCAibGVmdCIsIHBlcmNlbnQgKyAiJSIgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZW5vdyIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWV0ZXh0IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggInRpdGxlIiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCWlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgkJfQoKCQkvLyBkcmFnIHRoZSBsYWJlbCB3aWR0aHMKCQlpZiAoIHRoaXMuX2xhYmVscyApIHsKCQkJaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwOwoJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMDsKCQkJYlBlcmNlbnQgPSBwZXJjZW50ID09PSAxMDAgPyAwIDogTWF0aC5taW4oIGhhbmRsZVBlcmNlbnQgKyAxMDAgLSBhUGVyY2VudCwgMTAwICk7CgoJCQl0aGlzLl9sYWJlbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBhYiA9ICQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggaXNJbnB1dCApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjaGFuZ2UiLCB2YWwgKSA9PT0gZmFsc2UpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCV9zZXRIaWdobGlnaHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCB2YWx1ZSApIHsKCQkJdGhpcy5vcHRpb25zLmhpZ2hsaWdodCA9ICEhdmFsdWU7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0gZWxzZSBpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLnJlbW92ZSgpOwoJCQl0aGlzLnZhbHVlYmcgPSBmYWxzZTsKCQl9Cgl9LAoKCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuaGFuZGxlCgkJCS5yZW1vdmVDbGFzcyggInVpLWJ0bi0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyB2YWx1ZSApOwoKCQl2YXIgY3VycmVudFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQluZXdUaGVtZSA9IHZhbHVlID8gdmFsdWUgOiAiaW5oZXJpdCI7CgoJCXRoaXMuY29udHJvbAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBuZXdUaGVtZSApOwoJfSwKCglfc2V0VHJhY2tUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBjdXJyZW50VHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lID8gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgOiAiaW5oZXJpdCIsCgkJCW5ld1RyYWNrVGhlbWUgPSB2YWx1ZSA/IHZhbHVlIDogImluaGVyaXQiOwoKCQl0aGlzLnNsaWRlcgoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VHJhY2tUaGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIG5ld1RyYWNrVGhlbWUgKTsKCX0sCgoJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiAhdGhpcy5pc1Jhbmdlc2xpZGVyICkgewoJCQl0aGlzLnNsaWRlci5wYXJlbnQoKS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQl9CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCX0sCgoJX3NldENvcm5lcnM6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmNvbnRyb2wudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9Cgl9LAoKCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhbHVlID0gISF2YWx1ZTsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLnNsaWRlcgoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIHZhbHVlICkKCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcG9wdXA7CgpmdW5jdGlvbiBnZXRQb3B1cCgpIHsKCWlmICggIXBvcHVwICkgewoJCXBvcHVwID0gJCggIjxkaXY+PC9kaXY+IiwgewoJCQkiY2xhc3MiOiAidWktc2xpZGVyLXBvcHVwIHVpLXNoYWRvdyB1aS1jb3JuZXItYWxsIgoJCX0pOwoJfQoJcmV0dXJuIHBvcHVwLmNsb25lKCk7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLnNsaWRlciwgewoJb3B0aW9uczogewoJCXBvcHVwRW5hYmxlZDogZmFsc2UsCgkJc2hvd1ZhbHVlOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3VycmVudFZhbHVlOiBudWxsLAoJCQlfcG9wdXA6IG51bGwsCgkJCV9wb3B1cFZpc2libGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldE9wdGlvbiggInBvcHVwRW5hYmxlZCIsIHRoaXMub3B0aW9ucy5wb3B1cEVuYWJsZWQgKTsKCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7ICJ2bW91c2Vkb3duIiA6ICJfc2hvd1BvcHVwIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMuc2xpZGVyLmFkZCggdGhpcy5kb2N1bWVudCApLCB7ICJ2bW91c2V1cCIgOiAiX2hpZGVQb3B1cCIgfSApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJLy8gcG9zaXRpb24gdGhlIHBvcHVwIGNlbnRlcmVkIDVweCBhYm92ZSB0aGUgaGFuZGxlCglfcG9zaXRpb25Qb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIGRzdE9mZnNldCA9IHRoaXMuaGFuZGxlLm9mZnNldCgpOwoKCQl0aGlzLl9wb3B1cC5vZmZzZXQoIHsKCQkJbGVmdDogZHN0T2Zmc2V0LmxlZnQgKyAoIHRoaXMuaGFuZGxlLndpZHRoKCkgLSB0aGlzLl9wb3B1cC53aWR0aCgpICkgLyAyLAoJCQl0b3A6IGRzdE9mZnNldC50b3AgLSB0aGlzLl9wb3B1cC5vdXRlckhlaWdodCgpIC0gNQoJCX0pOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gInNob3dWYWx1ZSIgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoIHZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSA/IHRoaXMuX3ZhbHVlKCkgOiAiIiApOwoJCX0gZWxzZSBpZiAoIGtleSA9PT0gInBvcHVwRW5hYmxlZCIgKSB7CgkJCWlmICggdmFsdWUgJiYgIXRoaXMuX3BvcHVwICkgewoJCQkJdGhpcy5fcG9wdXAgPSBnZXRQb3B1cCgpCgkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgfHwgImEiICkgKQoJCQkJCS5oaWRlKCkKCQkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsKCQkJfQoJCX0KCX0sCgoJLy8gc2hvdyB2YWx1ZSBvbiB0aGUgaGFuZGxlIGFuZCBpbiBwb3B1cAoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zLCBuZXdWYWx1ZTsKCgkJaWYgKCBvLnBvcHVwRW5hYmxlZCApIHsKCQkJLy8gcmVtb3ZlIHRoZSB0aXRsZSBhdHRyaWJ1dGUgZnJvbSB0aGUgaGFuZGxlICh3aGljaCBpcwoJCQkvLyByZXNwb25zaWJsZSBmb3IgdGhlIGFubm95aW5nIHRvb2x0aXApOyBOQiB3ZSBoYXZlCgkJCS8vIHRvIGRvIGl0IGhlcmUgYXMgdGhlIGpxbSBzbGlkZXIgc2V0cyBpdCBldmVyeSB0aW1lCgkJCS8vIHRoZSBzbGlkZXIncyB2YWx1ZSBjaGFuZ2VzIDooCgkJCXRoaXMuaGFuZGxlLnJlbW92ZUF0dHIoICJ0aXRsZSIgKTsKCQl9CgoJCW5ld1ZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIG5ld1ZhbHVlID09PSB0aGlzLl9jdXJyZW50VmFsdWUgKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fY3VycmVudFZhbHVlID0gbmV3VmFsdWU7CgoJCWlmICggby5wb3B1cEVuYWJsZWQgJiYgdGhpcy5fcG9wdXAgKSB7CgkJCXRoaXMuX3Bvc2l0aW9uUG9wdXAoKTsKCQkJdGhpcy5fcG9wdXAuaHRtbCggbmV3VmFsdWUgKTsKCQl9IGVsc2UgaWYgKCBvLnNob3dWYWx1ZSAmJiAhdGhpcy5vcHRpb25zLm1pbmkgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoIG5ld1ZhbHVlICk7CgkJfQoJfSwKCglfc2hvd1BvcHVwOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5wb3B1cEVuYWJsZWQgJiYgIXRoaXMuX3BvcHVwVmlzaWJsZSApIHsKCQkJdGhpcy5oYW5kbGUuaHRtbCggIiIgKTsKCQkJdGhpcy5fcG9wdXAuc2hvdygpOwoJCQl0aGlzLl9wb3NpdGlvblBvcHVwKCk7CgkJCXRoaXMuX3BvcHVwVmlzaWJsZSA9IHRydWU7CgkJfQoJfSwKCglfaGlkZVBvcHVwOiBmdW5jdGlvbigpIHsKCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvLnBvcHVwRW5hYmxlZCAmJiB0aGlzLl9wb3B1cFZpc2libGUgKSB7CgkJCWlmICggby5zaG93VmFsdWUgJiYgIW8ubWluaSApIHsKCQkJCXRoaXMuaGFuZGxlLmh0bWwoIHRoaXMuX3ZhbHVlKCkgKTsKCQkJfQoJCQl0aGlzLl9wb3B1cC5oaWRlKCk7CgkJCXRoaXMuX3BvcHVwVmlzaWJsZSA9IGZhbHNlOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmZsaXBzd2l0Y2giLCAkLmV4dGVuZCh7CgoJb3B0aW9uczogewoJCW9uVGV4dDogIk9uIiwKCQlvZmZUZXh0OiAiT2ZmIiwKCQl0aGVtZTogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJd3JhcHBlckNsYXNzOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJCXRoaXMuX2VuaGFuY2UoKTsKCQkJfSBlbHNlIHsKCQkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQkJZmxpcHN3aXRjaDogdGhpcy5lbGVtZW50LnBhcmVudCgpLAoJCQkJCW9uOiB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1mbGlwc3dpdGNoLW9uIiApLmVxKCAwICksCgkJCQkJb2ZmOiB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1mbGlwc3dpdGNoLW9mZiIgKS5lcSgwKSwKCQkJCQl0eXBlOiB0aGlzLmVsZW1lbnQuZ2V0KCAwICkudGFnTmFtZQoJCQkJfSk7CgkJCX0KCgkJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQkJLy8gVHJhbnNmZXIgdGFiaW5kZXggdG8gIm9uIiBlbGVtZW50IGFuZCBtYWtlIGlucHV0IHVuZm9jdXNhYmxlCgkJCXRoaXMuX29yaWdpbmFsVGFiSW5kZXggPSB0aGlzLmVsZW1lbnQuYXR0ciggInRhYmluZGV4IiApOwoJCQlpZiAoIHRoaXMuX29yaWdpbmFsVGFiSW5kZXggIT0gbnVsbCApIHsKCQkJCXRoaXMub24uYXR0ciggInRhYmluZGV4IiwgdGhpcy5fb3JpZ2luYWxUYWJJbmRleCApOwoJCQl9CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCXRoaXMuX29uKHsKCQkJCSJmb2N1cyIgOiAiX2hhbmRsZUlucHV0Rm9jdXMiCgkJCX0pOwoKCQkJaWYgKCB0aGlzLmVsZW1lbnQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJCQkiZGlzYWJsZWQiOiB0cnVlCgkJCQl9KTsKCQkJfQoKCQkJdGhpcy5fb24oIHRoaXMuZmxpcHN3aXRjaCwgewoJCQkJImNsaWNrIjogIl90b2dnbGUiLAoJCQkJInN3aXBlbGVmdCI6ICJfbGVmdCIsCgkJCQkic3dpcGVyaWdodCI6ICJfcmlnaHQiCgkJCX0pOwoKCQkJdGhpcy5fb24oIHRoaXMub24sIHsKCQkJCSJrZXlkb3duIjogIl9rZXlkb3duIgoJCQl9KTsKCgkJCXRoaXMuX29uKCB7CgkJCQkiY2hhbmdlIjogInJlZnJlc2giCgkJCX0pOwoJfSwKCglfaGFuZGxlSW5wdXRGb2N1czogZnVuY3Rpb24oKSB7CgkJdGhpcy5vbi5mb2N1cygpOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmZsaXBzd2l0Y2g7Cgl9LAoKCV9sZWZ0OiBmdW5jdGlvbigpIHsKCQl0aGlzLmZsaXBzd2l0Y2gucmVtb3ZlQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKTsKCQlpZiAoIHRoaXMudHlwZSA9PT0gIlNFTEVDVCIgKSB7CgkJCXRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID0gMDsKCQl9IGVsc2UgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCX0KCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNoYW5nZSIgKTsKCX0sCgoJX3JpZ2h0OiBmdW5jdGlvbigpIHsKCQl0aGlzLmZsaXBzd2l0Y2guYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKTsKCQlpZiAoIHRoaXMudHlwZSA9PT0gIlNFTEVDVCIgKSB7CgkJCXRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID0gMTsKCQl9IGVsc2UgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImNoZWNrZWQiLCB0cnVlICk7CgkJfQoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGZsaXBzd2l0Y2ggPSAkKCAiPGRpdj4iICksCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCXRoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgoJCQkvLyBUaGUgIm9uIiBidXR0b24gaXMgYW4gYW5jaG9yIHNvIGl0J3MgZm9jdXNhYmxlCgkJCW9uID0gJCggIjxhPjwvYT4iLCB7CgkJCQkiaHJlZiI6ICIjIgoJCQl9KSwKCQkJb2ZmID0gJCggIjxzcGFuPjwvc3Bhbj4iICksCgkJCXR5cGUgPSBlbGVtZW50LmdldCggMCApLnRhZ05hbWUsCgkJCW9uVGV4dCA9ICggdHlwZSA9PT0gIklOUFVUIiApID8KCQkJCW9wdGlvbnMub25UZXh0IDogZWxlbWVudC5maW5kKCAib3B0aW9uIiApLmVxKCAxICkudGV4dCgpLAoJCQlvZmZUZXh0ID0gKCB0eXBlID09PSAiSU5QVVQiICkgPwoJCQkJb3B0aW9ucy5vZmZUZXh0IDogZWxlbWVudC5maW5kKCAib3B0aW9uIiApLmVxKCAwICkudGV4dCgpOwoKCQkJb24KCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtb24gdWktYnRuIHVpLXNoYWRvdyB1aS1idG4taW5oZXJpdCIgKQoJCQkJLnRleHQoIG9uVGV4dCApOwoJCQlvZmYKCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtb2ZmIiApCgkJCQkudGV4dCggb2ZmVGV4dCApOwoKCQkJZmxpcHN3aXRjaAoJCQkJLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaCB1aS1zaGFkb3ctaW5zZXQgIiArCgkJCQkJInVpLWJhci0iICsgdGhlbWUgKyAiICIgKwoJCQkJCSggb3B0aW9ucy53cmFwcGVyQ2xhc3MgPyBvcHRpb25zLndyYXBwZXJDbGFzcyA6ICIiICkgKyAiICIgKwoJCQkJCSggKCBlbGVtZW50LmlzKCAiOmNoZWNrZWQiICkgfHwKCQkJCQkJZWxlbWVudAoJCQkJCQkJLmZpbmQoICJvcHRpb24iICkKCQkJCQkJCS5lcSggMSApCgkJCQkJCQkuaXMoICI6c2VsZWN0ZWQiICkgKSA/ICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgOiAiIiApICsKCQkJCQkoIGVsZW1lbnQuaXMoIjpkaXNhYmxlZCIpID8gIiB1aS1zdGF0ZS1kaXNhYmxlZCI6ICIiKSArCgkJCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiOiAiIiApICsKCQkJCQkoIG9wdGlvbnMubWluaSA/ICIgdWktbWluaSI6ICIiICkgKQoJCQkJLmFwcGVuZCggb24sIG9mZiApOwoKCQkJZWxlbWVudAoJCQkJLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1pbnB1dCIgKQoJCQkJLmFmdGVyKCBmbGlwc3dpdGNoICkKCQkJCS5hcHBlbmRUbyggZmxpcHN3aXRjaCApOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlmbGlwc3dpdGNoOiBmbGlwc3dpdGNoLAoJCQlvbjogb24sCgkJCW9mZjogb2ZmLAoJCQl0eXBlOiB0eXBlCgkJfSk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBkaXJlY3Rpb24sCgkJCWV4aXN0aW5nRGlyZWN0aW9uID0gdGhpcy5mbGlwc3dpdGNoLmhhc0NsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICkgPyAiX3JpZ2h0IiA6ICJfbGVmdCI7CgoJCWlmICggdGhpcy50eXBlID09PSAiU0VMRUNUIiApIHsKCQkJZGlyZWN0aW9uID0gKCB0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA+IDAgKSA/ICJfcmlnaHQiOiAiX2xlZnQiOwoJCX0gZWxzZSB7CgkJCWRpcmVjdGlvbiA9IHRoaXMuZWxlbWVudC5wcm9wKCAiY2hlY2tlZCIgKSA/ICJfcmlnaHQiOiAiX2xlZnQiOwoJCX0KCgkJaWYgKCBkaXJlY3Rpb24gIT09IGV4aXN0aW5nRGlyZWN0aW9uICkgewoJCQl0aGlzWyBkaXJlY3Rpb24gXSgpOwoJCX0KCX0sCgoJX3RvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdmFyIGRpcmVjdGlvbiA9IHRoaXMuZmxpcHN3aXRjaC5oYXNDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApID8gIl9sZWZ0IiA6ICJfcmlnaHQiOwoKCQl0aGlzWyBkaXJlY3Rpb24gXSgpOwoJfSwKCglfa2V5ZG93bjogZnVuY3Rpb24oIGUgKSB7CgkJaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQgKSB7CgkJCXRoaXMuX2xlZnQoKTsKCQl9IGVsc2UgaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUICkgewoJCQl0aGlzLl9yaWdodCgpOwoJCX0gZWxzZSBpZiAoIGUud2hpY2ggPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UgKSB7CgkJCXRoaXMuX3RvZ2dsZSgpOwoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXZhciBjdXJyZW50VGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJCW5ld1RoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCI7CgoJCQl0aGlzLndpZGdldCgpCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1iYXItIiArIG5ld1RoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5vblRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vbi50ZXh0KCBvcHRpb25zLm9uVGV4dCApOwoJCX0KCQlpZiAoIG9wdGlvbnMub2ZmVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLm9mZi50ZXh0KCBvcHRpb25zLm9mZlRleHQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuX29yaWdpbmFsVGFiSW5kZXggIT0gbnVsbCApIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJ0YWJpbmRleCIsIHRoaXMuX29yaWdpbmFsVGFiSW5kZXggKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoJCX0KCQl0aGlzLm9uLnJlbW92ZSgpOwoJCXRoaXMub2ZmLnJlbW92ZSgpOwoJCXRoaXMuZWxlbWVudC51bndyYXAoKTsKCQl0aGlzLmZsaXBzd2l0Y2gucmVtb3ZlKCk7CgkJdGhpcy5yZW1vdmVDbGFzcyggInVpLWZsaXBzd2l0Y2gtaW5wdXQiICk7Cgl9Cgp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC53aWRnZXQoICJtb2JpbGUucmFuZ2VzbGlkZXIiLCAkLmV4dGVuZCggewoKCQlvcHRpb25zOiB7CgkJCXRoZW1lOiBudWxsLAoJCQl0cmFja1RoZW1lOiBudWxsLAoJCQljb3JuZXJzOiB0cnVlLAoJCQltaW5pOiBmYWxzZSwKCQkJaGlnaGxpZ2h0OiB0cnVlCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWVsQ2xhc3MgPSB0aGlzLm9wdGlvbnMubWluaSA/ICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiA6ICJ1aS1yYW5nZXNsaWRlciIsCgkJCV9pbnB1dEZpcnN0ID0gJGVsLmZpbmQoICJpbnB1dCIgKS5maXJzdCgpLAoJCQlfaW5wdXRMYXN0ID0gJGVsLmZpbmQoICJpbnB1dCIgKS5sYXN0KCksCgkJCV9sYWJlbCA9ICRlbC5maW5kKCAibGFiZWwiICkuZmlyc3QoKSwKCQkJX3NsaWRlcldpZGdldEZpcnN0ID0gJC5kYXRhKCBfaW5wdXRGaXJzdC5nZXQoIDAgKSwgIm1vYmlsZS1zbGlkZXIiICkgfHwKCQkJCSQuZGF0YSggX2lucHV0Rmlyc3Quc2xpZGVyKCkuZ2V0KCAwICksICJtb2JpbGUtc2xpZGVyIiApLAoJCQlfc2xpZGVyV2lkZ2V0TGFzdCA9ICQuZGF0YSggX2lucHV0TGFzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApIHx8CgkJCQkkLmRhdGEoIF9pbnB1dExhc3Quc2xpZGVyKCkuZ2V0KCAwICksICJtb2JpbGUtc2xpZGVyIiApLAoJCQlfc2xpZGVyRmlyc3QgPSBfc2xpZGVyV2lkZ2V0Rmlyc3Quc2xpZGVyLAoJCQlfc2xpZGVyTGFzdCA9IF9zbGlkZXJXaWRnZXRMYXN0LnNsaWRlciwKCQkJZmlyc3RIYW5kbGUgPSBfc2xpZGVyV2lkZ2V0Rmlyc3QuaGFuZGxlLAoJCQlfc2xpZGVycyA9ICQoICI8ZGl2IGNsYXNzPSd1aS1yYW5nZXNsaWRlci1zbGlkZXJzJyAvPiIgKS5hcHBlbmRUbyggJGVsICk7CgoJCQlfaW5wdXRGaXJzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IiApOwoJCQlfaW5wdXRMYXN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItbGFzdCIgKTsKCQkJJGVsLmFkZENsYXNzKCBlbENsYXNzICk7CgoJCQlfc2xpZGVyRmlyc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCV9zbGlkZXJMYXN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfbGFiZWwuaW5zZXJ0QmVmb3JlKCAkZWwgKTsKCQkJZmlyc3RIYW5kbGUucHJlcGVuZFRvKCBfc2xpZGVyTGFzdCApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbnB1dEZpcnN0OiBfaW5wdXRGaXJzdCwKCQkJCV9pbnB1dExhc3Q6IF9pbnB1dExhc3QsCgkJCQlfc2xpZGVyRmlyc3Q6IF9zbGlkZXJGaXJzdCwKCQkJCV9zbGlkZXJMYXN0OiBfc2xpZGVyTGFzdCwKCQkJCV9sYWJlbDogX2xhYmVsLAoJCQkJX3RhcmdldFZhbDogbnVsbCwKCQkJCV9zbGlkZXJUYXJnZXQ6IGZhbHNlLAoJCQkJX3NsaWRlcnM6IF9zbGlkZXJzLAoJCQkJX3Byb3h5OiBmYWxzZQoJCQl9KTsKCgkJCXRoaXMucmVmcmVzaCgpOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dC51aS1zbGlkZXItaW5wdXQiICksIHsKCQkJCSJzbGlkZWJlZm9yZXN0YXJ0IjogIl9zbGlkZWJlZm9yZXN0YXJ0IiwKCQkJCSJzbGlkZXN0b3AiOiAiX3NsaWRlc3RvcCIsCgkJCQkic2xpZGVkcmFnIjogIl9zbGlkZWRyYWciLAoJCQkJInNsaWRlYmVmb3JlY2hhbmdlIjogIl9jaGFuZ2UiLAoJCQkJImJsdXIiOiAiX2NoYW5nZSIsCgkJCQkia2V5dXAiOiAiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKHsKCQkJCSJtb3VzZWRvd24iOiJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQkJInJlc2V0IjoiX2hhbmRsZVJlc2V0IgoJCQl9KTsKCQkJdGhpcy5fb24oIGZpcnN0SGFuZGxlLCB7CgkJCQkidm1vdXNlZG93biI6ICJfZHJhZ0ZpcnN0SGFuZGxlIgoJCQl9KTsKCQl9LAoJCV9oYW5kbGVSZXNldDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy93ZSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYmVmb3JlIHVwZGF0ZWluZyBvdGhlciB3aXNlIHNsaWRlcnMgd2lsbCBub3QgaGF2ZSB1cGRhdGVkIHlldAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQl9LDApOwoJCX0sCgoJCV9kcmFnRmlyc3RIYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy9pZiB0aGUgZmlyc3QgaGFuZGxlIGlzIGRyYWdnZWQgc2VuZCB0aGUgZXZlbnQgdG8gdGhlIGZpcnN0IHNsaWRlcgoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9LAoKCQlfc2xpZGVkcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICksCgkJCQlvdGhlclNsaWRlciA9ICggZmlyc3QgKSA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgZHJhZyB3YXMgaW5pdGlhdGVkIG9uIGFuIGV4dHJlbWUgYW5kIHRoZSBvdGhlciBoYW5kbGUgaXMgZm9jdXNlZCBzZW5kIHRoZSBldmVudHMgdG8KCQkJLy90aGUgY2xvc2VzdCBoYW5kbGUKCQkJaWYgKCAoIHRoaXMuX3Byb3h5ID09PSAiZmlyc3QiICYmIGZpcnN0ICkgfHwgKCB0aGlzLl9wcm94eSA9PT0gImxhc3QiICYmICFmaXJzdCApICkgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3NsaWRlc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApOwoKCQkJdGhpcy5fcHJveHkgPSBmYWxzZTsKCQkJLy90aGlzIHN0b3BzIGRyYWdnaW5nIG9mIHRoZSBoYW5kbGUgYW5kIGJyaW5ncyB0aGUgYWN0aXZlIHRyYWNrIHRvIHRoZSBmcm9udAoJCQkvL3RoaXMgbWFrZXMgY2xpY2tzIG9uIHRoZSB0cmFjayBnbyB0aGUgdGhlIGxhc3QgaGFuZGxlIHVzZWQKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS50cmlnZ2VyKCAidm1vdXNldXAiICk7CgkJCXRoaXMuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/IDEgOiAiIiApOwoJCX0sCgoJCV9zbGlkZWJlZm9yZXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSB0cmFjayBpcyB0aGUgdGFyZ2V0IHJlbWVtYmVyIHRoaXMgYW5kIHRoZSBvcmlnaW5hbCB2YWx1ZQoJCQlpZiAoICQoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1zbGlkZXItdHJhY2siICkgKSB7CgkJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSB0cnVlOwoJCQkJdGhpcy5fdGFyZ2V0VmFsID0gJCggZXZlbnQudGFyZ2V0ICkudmFsKCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0VGhlbWUoIG9wdGlvbnMudGhlbWUgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLnRyYWNrVGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldFRyYWNrVGhlbWUoIG9wdGlvbnMudHJhY2tUaGVtZSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0TWluaSggb3B0aW9ucy5taW5pICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy5oaWdobGlnaHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldEhpZ2hsaWdodCggb3B0aW9ucy5oaWdobGlnaHQgKTsKCQkJfQoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCQlpZiAoIHRoaXMuX2lucHV0Rmlyc3QuaXMoICI6ZGlzYWJsZWQiICkgfHwgdGhpcy5faW5wdXRMYXN0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQkJfQoKCQkJJGVsLmZpbmQoICJpbnB1dCIgKS5zbGlkZXIoewoJCQkJdGhlbWU6IG8udGhlbWUsCgkJCQl0cmFja1RoZW1lOiBvLnRyYWNrVGhlbWUsCgkJCQlkaXNhYmxlZDogby5kaXNhYmxlZCwKCQkJCWNvcm5lcnM6IG8uY29ybmVycywKCQkJCW1pbmk6IG8ubWluaSwKCQkJCWhpZ2hsaWdodDogby5oaWdobGlnaHQKCQkJfSkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJfSwKCgkJX2NoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoIGV2ZW50LnR5cGUgPT09ICJrZXl1cCIgKSB7CgkJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbWluID0gcGFyc2VGbG9hdCggdGhpcy5faW5wdXRGaXJzdC52YWwoKSwgMTAgKSwKCQkJCW1heCA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0TGFzdC52YWwoKSwgMTAgKSwKCQkJCWZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKSwKCQkJCXRoaXNTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0Rmlyc3QgOiB0aGlzLl9pbnB1dExhc3QsCgkJCQlvdGhlclNsaWRlciA9IGZpcnN0ID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCgkJCWlmICggKCB0aGlzLl9pbnB1dEZpcnN0LnZhbCgpID4gdGhpcy5faW5wdXRMYXN0LnZhbCgpICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICYmICEkKGV2ZW50LnRhcmdldCkuaGFzQ2xhc3MoInVpLXNsaWRlci1oYW5kbGUiKSkgKSB7CgkJCQl0aGlzU2xpZGVyLmJsdXIoKTsKCQkJfSBlbHNlIGlmICggZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBtaW4gPiBtYXggJiYgIXRoaXMuX3NsaWRlclRhcmdldCApIHsKCQkJCS8vdGhpcyBwcmV2ZW50cyBtaW4gZnJvbSBiZWluZyBncmVhdGVyIHRoZW4gbWF4CgkJCQl0aGlzU2xpZGVyLnZhbCggZmlyc3QgPyBtYXg6IG1pbiApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQl0aGlzLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQl9IGVsc2UgaWYgKCBtaW4gPiBtYXggKSB7CgkJCQkvL3RoaXMgbWFrZXMgaXQgc28gY2xpY2tzIG9uIHRoZSB0YXJnZXQgb24gZWl0aGVyIGV4dHJlbWUgZ28gdG8gdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCQl0aGlzU2xpZGVyLnZhbCggdGhpcy5fdGFyZ2V0VmFsICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCgkJCQkvL1lvdSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgc28gZmlyc3Qgc2xpZGVyIGlzIHVwZGF0ZWQgYmVmb3JlIHVwZGF0aW5nIHNlY29uZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJb3RoZXJTbGlkZXIudmFsKCBmaXJzdCA/IG1pbjogbWF4ICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmZvY3VzKCk7CgkJCQkJc2VsZi5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gIiIgOiAxICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJCX0sIDAgKTsKCQkJCXRoaXMuX3Byb3h5ID0gKCBmaXJzdCApID8gImZpcnN0IiA6ICJsYXN0IjsKCQkJfQoJCQkvL2ZpeGVzIGlzc3VlIHdoZXJlIHdoZW4gYm90aCBfc2xpZGVycyBhcmUgYXQgbWluIHRoZXkgY2Fubm90IGJlIGFkanVzdGVkCgkJCWlmICggbWluID09PSBtYXggKSB7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDEgKTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDAgKTsKCQkJfSBlbHNlIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCX0KCgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoKCQkJaWYgKCBtaW4gPj0gbWF4ICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3VwZGF0ZUhpZ2hsaWdodDogZnVuY3Rpb24oKSB7CgkJCXZhciBtaW4gPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJbWF4ID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJd2lkdGggPSAobWF4IC0gbWluKTsKCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5jc3MoewoJCQkJIm1hcmdpbi1sZWZ0IjogbWluICsgIiUiLAoJCQkJIndpZHRoIjogd2lkdGggKyAiJSIKCQkJfSk7CgkJfSwKCgkJX3NldFRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgInRoZW1lIiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJ0aGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldFRyYWNrVGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW1pbmkiLCAhIXZhbHVlICk7CgkJfSwKCgkJX3NldEhpZ2hsaWdodDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJoaWdobGlnaHQiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgImhpZ2hsaWdodCIsIHZhbHVlICk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9sYWJlbC5wcmVwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiApOwoJCQl0aGlzLl9pbnB1dEZpcnN0LmFmdGVyKCB0aGlzLl9zbGlkZXJGaXJzdCApOwoJCQl0aGlzLl9pbnB1dExhc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckxhc3QgKTsKCQkJdGhpcy5fc2xpZGVycy5yZW1vdmUoKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IHVpLXJhbmdlc2xpZGVyLWxhc3QiICkuc2xpZGVyKCAiZGVzdHJveSIgKTsKCQl9CgoJfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS50ZXh0aW5wdXQsIHsKCQlvcHRpb25zOiB7CgkJCWNsZWFyQnRuOiBmYWxzZSwKCQkJY2xlYXJCdG5UZXh0OiAiQ2xlYXIgdGV4dCIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCgkJCWlmICggISF0aGlzLm9wdGlvbnMuY2xlYXJCdG4gfHwgdGhpcy5pc1NlYXJjaCApIHsKCQkJCXRoaXMuX2FkZENsZWFyQnRuKCk7CgkJCX0KCQl9LAoKCQljbGVhckJ1dHRvbjogZnVuY3Rpb24oKSB7CgoJCQlyZXR1cm4gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1pbnB1dC1jbGVhciB1aS1idG4gdWktaWNvbi1kZWxldGUgdWktYnRuLWljb24tbm90ZXh0IHVpLWNvcm5lci1hbGwiICsKICAgICInIHRpdGxlPSciICsgdGhpcy5vcHRpb25zLmNsZWFyQnRuVGV4dCArICInPiIgKyB0aGlzLm9wdGlvbnMuY2xlYXJCdG5UZXh0ICsgIjwvYT4iICk7CgoJCX0sCgoJCV9jbGVhckJ0bkNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXRoaXMuZWxlbWVudC52YWwoICIiICkKCQkJCQkuZm9jdXMoKQoJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoKCQkJdGhpcy5fY2xlYXJCdG4uYWRkQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSwKCgkJX2FkZENsZWFyQnRuOiBmdW5jdGlvbigpIHsKCgkJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJCXRoaXMuX2VuaGFuY2VDbGVhcigpOwoJCQl9CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2NsZWFyQnRuOiB0aGlzLndpZGdldCgpLmZpbmQoImEudWktaW5wdXQtY2xlYXIiKQoJCQl9KTsKCgkJCXRoaXMuX2JpbmRDbGVhckV2ZW50cygpOwoKCQkJdGhpcy5fdG9nZ2xlQ2xlYXIoKTsKCgkJfSwKCgkJX2VuaGFuY2VDbGVhcjogZnVuY3Rpb24oKSB7CgoJCQl0aGlzLmNsZWFyQnV0dG9uKCkuYXBwZW5kVG8oIHRoaXMud2lkZ2V0KCkgKTsKCQkJdGhpcy53aWRnZXQoKS5hZGRDbGFzcyggInVpLWlucHV0LWhhcy1jbGVhciIgKTsKCgkJfSwKCgkJX2JpbmRDbGVhckV2ZW50czogZnVuY3Rpb24oKSB7CgoJCQl0aGlzLl9vbiggdGhpcy5fY2xlYXJCdG4sIHsKCQkJCSJjbGljayI6ICJfY2xlYXJCdG5DbGljayIKCQkJfSk7CgoJCQl0aGlzLl9vbih7CgkJCQkia2V5dXAiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJjaGFuZ2UiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJpbnB1dCI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImZvY3VzIjogIl90b2dnbGVDbGVhciIsCgkJCQkiYmx1ciI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImN1dCI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJInBhc3RlIjogIl90b2dnbGVDbGVhciIKCgkJCX0pOwoKCQl9LAoKCQlfdW5iaW5kQ2xlYXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9vZmYoIHRoaXMuX2NsZWFyQnRuLCAiY2xpY2siKTsKCQkJdGhpcy5fb2ZmKCB0aGlzLmVsZW1lbnQsICJrZXl1cCBjaGFuZ2UgaW5wdXQgZm9jdXMgYmx1ciBjdXQgcGFzdGUiICk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkJaWYgKCBvcHRpb25zLmNsZWFyQnRuICE9PSB1bmRlZmluZWQgJiYKCQkJCSF0aGlzLmVsZW1lbnQuaXMoICJ0ZXh0YXJlYSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSApIHsKCQkJCWlmICggb3B0aW9ucy5jbGVhckJ0biApIHsKCQkJCQl0aGlzLl9hZGRDbGVhckJ0bigpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl9kZXN0cm95Q2xlYXIoKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvcHRpb25zLmNsZWFyQnRuVGV4dCAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX2NsZWFyQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9jbGVhckJ0bi50ZXh0KCBvcHRpb25zLmNsZWFyQnRuVGV4dCApCgkJCQkJLmF0dHIoInRpdGxlIiwgb3B0aW9ucy5jbGVhckJ0blRleHQpOwoJCQl9CgkJfSwKCgkJX3RvZ2dsZUNsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fZGVsYXkoICJfdG9nZ2xlQ2xlYXJDbGFzcyIsIDAgKTsKCQl9LAoKCQlfdG9nZ2xlQ2xlYXJDbGFzczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2NsZWFyQnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIXRoaXMuZWxlbWVudC52YWwoKSApOwoJCX0sCgoJCV9kZXN0cm95Q2xlYXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoJCQl0aGlzLl91bmJpbmRDbGVhcigpOwoJCQl0aGlzLl9jbGVhckJ0bi5yZW1vdmUoKTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCXRoaXMuX2Rlc3Ryb3lDbGVhcigpOwoJCX0KCgl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsICQubW9iaWxlLnRleHRpbnB1dCwgewoJCW9wdGlvbnM6IHsKCQkJYXV0b2dyb3c6dHJ1ZSwKCQkJa2V5dXBUaW1lb3V0QnVmZmVyOiAxMDAKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLmF1dG9ncm93ICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCXRoaXMuX2F1dG9ncm93KCk7CgkJCX0KCQl9LAoKCQlfYXV0b2dyb3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ciICk7CgoJCQl0aGlzLl9vbih7CgkJCQkia2V5dXAiOiAiX3RpbWVvdXQiLAoJCQkJImNoYW5nZSI6ICJfdGltZW91dCIsCgkJCQkiaW5wdXQiOiAiX3RpbWVvdXQiLAoJCQkJInBhc3RlIjogIl90aW1lb3V0IgoJCQl9KTsKCgkJCS8vIEF0dGFjaCB0byB0aGUgdmFyaW91cyB5b3UtaGF2ZS1iZWNvbWUtdmlzaWJsZSBub3RpZmljYXRpb25zIHRoYXQgdGhlCgkJCS8vIHZhcmlvdXMgZnJhbWV3b3JrIGVsZW1lbnRzIGVtaXQuCgkJCS8vIFRPRE86IFJlbW92ZSBhbGwgYnV0IHRoZSB1cGRhdGVsYXlvdXQgaGFuZGxlciBvbmNlICM2NDI2IGlzIGZpeGVkLgoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5kb2N1bWVudCwgewoKCQkJCS8vIFRPRE86IE1vdmUgdG8gbm9uLWRlcHJlY2F0ZWQgZXZlbnQKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlU2hvdyIsCgkJCQkicG9wdXBiZWZvcmVwb3NpdGlvbiI6ICJfaGFuZGxlU2hvdyIsCgkJCQkidXBkYXRlbGF5b3V0IjogIl9oYW5kbGVTaG93IiwKCQkJCSJwYW5lbG9wZW4iOiAiX2hhbmRsZVNob3ciCgkJCX0pOwoJCX0sCgoJCS8vIFN5bmNocm9ub3VzbHkgZml4IHRoZSB3aWRnZXQgaGVpZ2h0IGlmIHRoaXMgd2lkZ2V0J3MgcGFyZW50cyBhcmUgc3VjaAoJCS8vIHRoYXQgdGhleSBzaG93L2hpZGUgY29udGVudCBhdCBydW50aW1lLiBXZSBzdGlsbCBuZWVkIHRvIGNoZWNrIHdoZXRoZXIKCQkvLyB0aGUgd2lkZ2V0IGlzIGFjdHVhbGx5IHZpc2libGUgaW4gY2FzZSBpdCBpcyBjb250YWluZWQgaW5zaWRlIG11bHRpcGxlCgkJLy8gc3VjaCBjb250YWluZXJzLiBGb3IgZXhhbXBsZTogcGFuZWwgY29udGFpbnMgY29sbGFwc2libGUgY29udGFpbnMKCQkvLyBhdXRvZ3JvdyB0ZXh0aW5wdXQuIFRoZSBwYW5lbCBtYXkgZW1pdCAicGFuZWxvcGVuIiBpbmRpY2F0aW5nIHRoYXQgaXRzCgkJLy8gY29udGVudCBoYXMgYmVjb21lIHZpc2libGUsIGJ1dCB0aGUgY29sbGFwc2libGUgaXMgc3RpbGwgY29sbGFwc2VkLCBzbwoJCS8vIHRoZSBhdXRvZ3JvdyB0ZXh0YXJlYSBpcyBzdGlsbCBub3QgdmlzaWJsZS4KCQlfaGFuZGxlU2hvdzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICQuY29udGFpbnMoIGV2ZW50LnRhcmdldCwgdGhpcy5lbGVtZW50WyAwIF0gKSAmJgoJCQkJdGhpcy5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgoJCQkJaWYgKCBldmVudC50eXBlICE9PSAicG9wdXBiZWZvcmVwb3NpdGlvbiIgKSB7CgkJCQkJdGhpcy5lbGVtZW50CgkJCQkJCS5hZGRDbGFzcyggInVpLXRleHRpbnB1dC1hdXRvZ3Jvdy1yZXNpemUiICkKCQkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKAoJCQkJCQkJJC5wcm94eSggZnVuY3Rpb24oKSB7CgkJCQkJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGV4dGlucHV0LWF1dG9ncm93LXJlc2l6ZSIgKTsKCQkJCQkJCX0sIHRoaXMgKSwKCQkJCQkJInRyYW5zaXRpb24iICk7CgkJCQl9CgkJCQl0aGlzLl90aW1lb3V0KCk7CgkJCX0KCQl9LAoKCQlfdW5iaW5kQXV0b2dyb3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ciICk7CgkJCXRoaXMuX29mZiggdGhpcy5lbGVtZW50LCAia2V5dXAgY2hhbmdlIGlucHV0IHBhc3RlIiApOwoJCQl0aGlzLl9vZmYoIHRoaXMuZG9jdW1lbnQsCgkJCQkicGFnZXNob3cgcG9wdXBiZWZvcmVwb3NpdGlvbiB1cGRhdGVsYXlvdXQgcGFuZWxvcGVuIiApOwoJCX0sCgoJCWtleXVwVGltZW91dDogbnVsbCwKCgkJX3ByZXBhcmVIZWlnaHRVcGRhdGU6IGZ1bmN0aW9uKCBkZWxheSApIHsKCQkJaWYgKCB0aGlzLmtleXVwVGltZW91dCApIHsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5rZXl1cFRpbWVvdXQgKTsKCQkJfQoJCQlpZiAoIGRlbGF5ID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl91cGRhdGVIZWlnaHQoKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMua2V5dXBUaW1lb3V0ID0gdGhpcy5fZGVsYXkoICJfdXBkYXRlSGVpZ2h0IiwgZGVsYXkgKTsKCQkJfQoJCX0sCgoJCV90aW1lb3V0OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fcHJlcGFyZUhlaWdodFVwZGF0ZSggdGhpcy5vcHRpb25zLmtleXVwVGltZW91dEJ1ZmZlciApOwoJCX0sCgoJCV91cGRhdGVIZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFkZGluZ1RvcCwgcGFkZGluZ0JvdHRvbSwgcGFkZGluZ0hlaWdodCwgc2Nyb2xsSGVpZ2h0LCBjbGllbnRIZWlnaHQsCgkJCQlib3JkZXJUb3AsIGJvcmRlckJvdHRvbSwgYm9yZGVySGVpZ2h0LCBoZWlnaHQsCgkJCQlzY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKTsKCQkJdGhpcy5rZXl1cFRpbWVvdXQgPSAwOwoKCQkJLy8gSUU4IHRleHRhcmVhcyBoYXZlIHRoZSBvbnBhZ2UgcHJvcGVydHkgLSBvdGhlcnMgZG8gbm90CgkJCWlmICggISggIm9ucGFnZSIgaW4gdGhpcy5lbGVtZW50WyAwIF0gKSApIHsKCQkJCXRoaXMuZWxlbWVudC5jc3MoewoJCQkJCSJoZWlnaHQiOiAwLAoJCQkJCSJtaW4taGVpZ2h0IjogMCwKCQkJCQkibWF4LWhlaWdodCI6IDAKCQkJCX0pOwoJCQl9CgoJCQlzY3JvbGxIZWlnaHQgPSB0aGlzLmVsZW1lbnRbIDAgXS5zY3JvbGxIZWlnaHQ7CgkJCWNsaWVudEhlaWdodCA9IHRoaXMuZWxlbWVudFsgMCBdLmNsaWVudEhlaWdodDsKCQkJYm9yZGVyVG9wID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggImJvcmRlci10b3Atd2lkdGgiICkgKTsKCQkJYm9yZGVyQm90dG9tID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggImJvcmRlci1ib3R0b20td2lkdGgiICkgKTsKCQkJYm9yZGVySGVpZ2h0ID0gYm9yZGVyVG9wICsgYm9yZGVyQm90dG9tOwoJCQloZWlnaHQgPSBzY3JvbGxIZWlnaHQgKyBib3JkZXJIZWlnaHQgKyAxNTsKCgkJCS8vIElzc3VlIDYxNzk6IFBhZGRpbmcgaXMgbm90IGluY2x1ZGVkIGluIHNjcm9sbEhlaWdodCBhbmQKCQkJLy8gY2xpZW50SGVpZ2h0IGJ5IEZpcmVmb3ggaWYgbm8gc2Nyb2xsYmFyIGlzIHZpc2libGUuIEJlY2F1c2UKCQkJLy8gdGV4dGFyZWFzIHVzZSB0aGUgYm9yZGVyLWJveCBib3gtc2l6aW5nIG1vZGVsLCBwYWRkaW5nIHNob3VsZCBiZQoJCQkvLyBpbmNsdWRlZCBpbiB0aGUgbmV3IChhc3NpZ25lZCkgaGVpZ2h0LiBCZWNhdXNlIHRoZSBoZWlnaHQgaXMgc2V0CgkJCS8vIHRvIDAsIGNsaWVudEhlaWdodCA9PSAwIGluIEZpcmVmb3guIFRoZXJlZm9yZSwgd2UgY2FuIHVzZSB0aGlzIHRvCgkJCS8vIGNoZWNrIGlmIHBhZGRpbmcgbXVzdCBiZSBhZGRlZC4KCQkJaWYgKCBjbGllbnRIZWlnaHQgPT09IDAgKSB7CgkJCQlwYWRkaW5nVG9wID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggInBhZGRpbmctdG9wIiApICk7CgkJCQlwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCQlwYWRkaW5nSGVpZ2h0ID0gcGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b207CgoJCQkJaGVpZ2h0ICs9IHBhZGRpbmdIZWlnaHQ7CgkJCX0KCgkJCXRoaXMuZWxlbWVudC5jc3MoewoJCQkJImhlaWdodCI6IGhlaWdodCwKCQkJCSJtaW4taGVpZ2h0IjogIiIsCgkJCQkibWF4LWhlaWdodCI6ICIiCgkJCX0pOwoKCQkJdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCBzY3JvbGxUb3AgKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2dyb3cgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICkgewoJCQkJCXRoaXMuX2F1dG9ncm93KCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX3VuYmluZEF1dG9ncm93KCk7CgkJCQl9CgkJCX0KCQl9CgoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQuZXh0ZW5kKCB7Cglpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSk6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJykgKSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246ICJjYXJhdC1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogZmFsc2UsIC8qIFRPRE86IERlcHJlY2F0ZWQgaW4gMS40LCByZW1vdmUgaW4gMS41LiAqLwoJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQlkaXZpZGVyVGhlbWU6IG51bGwsCgkJaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zOiB0cnVlLAoJCWNsb3NlVGV4dDogIkNsb3NlIiwKCQluYXRpdmVNZW51OiB0cnVlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJbWluaTogZmFsc2UKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICk7Cgl9LAoKCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXRoaXMuYnV0dG9uLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJfSwKCglfZm9jdXNCdXR0b24gOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQlzZWxmLmJ1dHRvbi5mb2N1cygpOwoJCX0sIDQwKTsKCX0sCgoJX3NlbGVjdE9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnNlbGVjdC5maW5kKCAib3B0aW9uIiApOwoJfSwKCgkvLyBzZXR1cCBpdGVtcyB0aGF0IGFyZSBnZW5lcmFsbHkgbmVjZXNzYXJ5IGZvciBzZWxlY3QgbWVudSBleHRlbnNpb24KCV9wcmVFeHRlbnNpb246IGZ1bmN0aW9uKCkgewoJCXZhciBpbmxpbmUgPSB0aGlzLm9wdGlvbnMuaW5saW5lIHx8IHRoaXMuZWxlbWVudC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQltaW5pID0gdGhpcy5vcHRpb25zLm1pbmkgfHwgdGhpcy5lbGVtZW50LmpxbURhdGEoICJtaW5pIiApLAoJCQljbGFzc2VzID0gIiI7CgkJLy8gVE9ETzogUG9zdCAxLjEtLW9uY2Ugd2UgaGF2ZSB0aW1lIHRvIHRlc3QgdGhvcm91Z2hseS0tYW55IGNsYXNzZXMgbWFudWFsbHkgYXBwbGllZCB0byB0aGUgb3JpZ2luYWwgZWxlbWVudCBzaG91bGQgYmUgY2FycmllZCBvdmVyIHRvIHRoZSBlbmhhbmNlZCBlbGVtZW50LCB3aXRoIGFuIGAtZW5oYW5jZWRgIHN1ZmZpeC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU3NwoJCS8qIGlmICggJGVsWzBdLmNsYXNzTmFtZS5sZW5ndGggKSB7CgkJCWNsYXNzZXMgPSAkZWxbMF0uY2xhc3NOYW1lOwoJCX0gKi8KCQlpZiAoICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tbGVmdCI7CgkJfQoKCQlpZiAoICAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1yaWdodCI7CgkJfQoKCQlpZiAoIGlubGluZSApIHsKCQkJY2xhc3NlcyArPSAiIHVpLWJ0bi1pbmxpbmUiOwoJCX0KCQlpZiAoIG1pbmkgKSB7CgkJCWNsYXNzZXMgKz0gIiB1aS1taW5pIjsKCQl9CgoJCXRoaXMuc2VsZWN0ID0gdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLndyYXAoICI8ZGl2IGNsYXNzPSd1aS1zZWxlY3QiICsgY2xhc3NlcyArICInPiIgKTsKCQl0aGlzLnNlbGVjdElkICA9IHRoaXMuc2VsZWN0LmF0dHIoICJpZCIgKSB8fCAoICJzZWxlY3QtIiArIHRoaXMudXVpZCApOwoJCXRoaXMuYnV0dG9uSWQgPSB0aGlzLnNlbGVjdElkICsgIi1idXR0b24iOwoJCXRoaXMubGFiZWwgPSAkKCAibGFiZWxbZm9yPSciKyB0aGlzLnNlbGVjdElkICsiJ10iICk7CgkJdGhpcy5pc011bHRpcGxlID0gdGhpcy5zZWxlY3RbIDAgXS5tdWx0aXBsZTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB3cmFwcGVyID0gdGhpcy5lbGVtZW50LnBhcmVudHMoICIudWktc2VsZWN0IiApOwoJCWlmICggd3JhcHBlci5sZW5ndGggPiAwICkgewoJCQlpZiAoIHdyYXBwZXIuaXMoICIudWktYnRuLWxlZnQsIC51aS1idG4tcmlnaHQiICkgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHdyYXBwZXIuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKSA/ICJ1aS1idG4tbGVmdCIgOiAidWktYnRuLXJpZ2h0IiApOwoJCQl9CgkJCXRoaXMuZWxlbWVudC5pbnNlcnRBZnRlciggd3JhcHBlciApOwoJCQl3cmFwcGVyLnJlbW92ZSgpOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcHJlRXh0ZW5zaW9uKCk7CgoJCXRoaXMuYnV0dG9uID0gdGhpcy5fYnV0dG9uKCk7CgoJCXZhciBzZWxmID0gdGhpcywKCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgoJCQlpY29ucG9zID0gb3B0aW9ucy5pY29uID8gKCBvcHRpb25zLmljb25wb3MgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImljb25wb3MiICkgKSA6IGZhbHNlLAoKCQkJYnV0dG9uID0gdGhpcy5idXR0b24KCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXMuc2VsZWN0ICkKCQkJCS5hdHRyKCAiaWQiLCB0aGlzLmJ1dHRvbklkICkKCQkJCS5hZGRDbGFzcyggInVpLWJ0biIgKwoJCQkJCSggb3B0aW9ucy5pY29uID8gKCAiIHVpLWljb24tIiArIG9wdGlvbnMuaWNvbiArICIgdWktYnRuLWljb24tIiArIGljb25wb3MgKwoJCQkJCSggb3B0aW9ucy5pY29uc2hhZG93ID8gIiB1aS1zaGFkb3ctaWNvbiIgOiAiIiApICkgOgkiIiApICsgLyogVE9ETzogUmVtb3ZlIGluIDEuNS4gKi8KCQkJCQkoIG9wdGlvbnMudGhlbWUgPyAiIHVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSA6ICIiICkgKwoJCQkJCSggb3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkgKwoJCQkJCSggb3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIiApICk7CgoJCXRoaXMuc2V0QnV0dG9uVGV4dCgpOwoKCQkvLyBPcGVyYSBkb2VzIG5vdCBwcm9wZXJseSBzdXBwb3J0IG9wYWNpdHkgb24gc2VsZWN0IGVsZW1lbnRzCgkJLy8gSW4gTWluaSwgaXQgaGlkZXMgdGhlIGVsZW1lbnQsIGJ1dCBub3QgaXRzIHRleHQKCQkvLyBPbiB0aGUgZGVza3RvcCxpdCBzZWVtcyB0byBkbyB0aGUgb3Bwb3NpdGUKCQkvLyBmb3IgdGhlc2UgcmVhc29ucywgdXNpbmcgdGhlIG5hdGl2ZU1lbnUgb3B0aW9uIHJlc3VsdHMgaW4gYSBmdWxsIG5hdGl2ZSBzZWxlY3QgaW4gT3BlcmEKCQlpZiAoIG9wdGlvbnMubmF0aXZlTWVudSAmJiB3aW5kb3cub3BlcmEgJiYgd2luZG93Lm9wZXJhLnZlcnNpb24gKSB7CgkJCWJ1dHRvbi5hZGRDbGFzcyggInVpLXNlbGVjdC1uYXRpdmVvbmx5IiApOwoJCX0KCgkJLy8gQWRkIGNvdW50ZXIgZm9yIG11bHRpIHNlbGVjdHMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudCA9ICQoICI8c3Bhbj4iICkKCQkJCS5hZGRDbGFzcyggInVpLWxpLWNvdW50IHVpLWJvZHktaW5oZXJpdCIgKQoJCQkJLmhpZGUoKQoJCQkJLmFwcGVuZFRvKCBidXR0b24uYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICkgKTsKCQl9CgoJCS8vIERpc2FibGUgaWYgc3BlY2lmaWVkCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiICkpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBFdmVudHMgb24gbmF0aXZlIHNlbGVjdAoJCXRoaXMuc2VsZWN0LmNoYW5nZShmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQlpZiAoICEhb3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQkJdGhpcy5ibHVyKCk7CgkJCX0KCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMuX29uKCB0aGlzLmJ1dHRvbiwgewoJCQlrZXlkb3duOiAiX2hhbmRsZUtleWRvd24iCgkJfSk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMgdm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgkJCX0pCgkJCS5iaW5kKCAidm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gUmVtb3ZlIGFjdGl2ZSBjbGFzcyBvbiBzY3JvbGwvdG91Y2htb3ZlCgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciB2bW91c2VvdXQiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdXQiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pOwoKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlzZWxmLmJ1dHRvbi5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5sYWJlbC5iaW5kKCAiY2xpY2sgZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuc2VsZWN0LmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5idXR0b24uYmluZCggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCX0sIDAgKTsKCQkJfQoJCX0pOwoJCXNlbGYuc2VsZWN0LmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQiICk7Cgl9LAoKCXNlbGVjdGVkSW5kaWNlczogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlyZXR1cm4gdGhpcy5zZWxlY3RlZCgpLm1hcChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpLAoJCQl0ZXh0ID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJc3BhbiA9ICQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICk7CgoJCXRoaXMuYnV0dG9uLmNoaWxkcmVuKCAic3BhbiIgKS5ub3QoICIudWktbGktY291bnQiICkucmVtb3ZlKCkuZW5kKCkuZW5kKCkucHJlcGVuZCggKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGVjdGVkLmxlbmd0aCApIHsKCQkJCXRleHQgPSBzZWxlY3RlZC5tYXAoZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICQoIHRoaXMgKS50ZXh0KCk7CgkJCQl9KS5nZXQoKS5qb2luKCAiLCAiICk7CgkJCX0gZWxzZSB7CgkJCQl0ZXh0ID0gc2VsZi5wbGFjZWhvbGRlcjsKCQkJfQoKCQkJaWYgKCB0ZXh0ICkgewoJCQkJc3Bhbi50ZXh0KCB0ZXh0ICk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gU2V0IHRoZSBjb250ZW50cyB0byAmbmJzcDsgd2hpY2ggd2Ugd3JpdGUgYXMgJiMxNjA7IHRvIGJlIFhIVE1MIGNvbXBsaWFudCAtIHNlZSBnaC02Njk5CgkJCQlzcGFuLmh0bWwoICImIzE2MDsiICk7CgkJCX0KCgkJCS8vIFRPRE8gcG9zc2libHkgYWdncmVnYXRlIG11bHRpcGxlIHNlbGVjdCBvcHRpb24gY2xhc3NlcwoJCQlyZXR1cm4gc3BhbgoJCQkJLmFkZENsYXNzKCBzZWxmLnNlbGVjdC5hdHRyKCAiY2xhc3MiICkgKQoJCQkJLmFkZENsYXNzKCBzZWxlY3RlZC5hdHRyKCAiY2xhc3MiICkgKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9KSgpKTsKCX0sCgoJc2V0QnV0dG9uQ291bnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKTsKCgkJLy8gbXVsdGlwbGUgY291bnQgaW5zaWRlIGJ1dHRvbgoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50WyBzZWxlY3RlZC5sZW5ndGggPiAxID8gInNob3ciIDogImhpZGUiIF0oKS50ZXh0KCBzZWxlY3RlZC5sZW5ndGggKTsKCQl9Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggLyogZXZlbnQgKi8gKSB7CgkJdGhpcy5fZGVsYXkoICJfcmVmcmVzaEJ1dHRvbiIgKTsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3JlZnJlc2hCdXR0b246IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0QnV0dG9uVGV4dCgpOwoJCXRoaXMuc2V0QnV0dG9uQ291bnQoKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaEJ1dHRvbigpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpbmtzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgkvL2xpbmtzIHdpdGhpbiBjb250ZW50IGFyZWFzLCB0ZXN0cyBpbmNsdWRlZCB3aXRoIHBhZ2UKCSQoIHRhcmdldCApCgkJLmZpbmQoICJhIiApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZmlsdGVyKCAiOmpxbURhdGEocmVsPSdwb3B1cCcpW2hyZWZdW2hyZWYhPScnXSIgKQoJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJLy8gQWNjZXNzaWJpbGl0eSBpbmZvIGZvciBwb3B1cHMKCQkJdmFyIGVsZW1lbnQgPSB0aGlzLAoJCQkJaWRyZWYgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSggImhyZWYiICkuc3Vic3RyaW5nKCAxICk7CgoJCQlpZiAoIGlkcmVmICkgewoJCQkJZWxlbWVudC5zZXRBdHRyaWJ1dGUoICJhcmlhLWhhc3BvcHVwIiwgdHJ1ZSApOwoJCQkJZWxlbWVudC5zZXRBdHRyaWJ1dGUoICJhcmlhLW93bnMiLCBpZHJlZiApOwoJCQkJZWxlbWVudC5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQkJfQoJCX0pCgkJLmVuZCgpCgkJLm5vdCggIi51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn07Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggd2luZG93U2l6ZSwgc2VnbWVudFNpemUsIG9mZnNldCwgZGVzaXJlZCApIHsKCXZhciByZXR1cm5WYWx1ZSA9IGRlc2lyZWQ7CgoJaWYgKCB3aW5kb3dTaXplIDwgc2VnbWVudFNpemUgKSB7CgkJLy8gQ2VudGVyIHNlZ21lbnQgaWYgaXQncyBiaWdnZXIgdGhhbiB0aGUgd2luZG93CgkJcmV0dXJuVmFsdWUgPSBvZmZzZXQgKyAoIHdpbmRvd1NpemUgLSBzZWdtZW50U2l6ZSApIC8gMjsKCX0gZWxzZSB7CgkJLy8gT3RoZXJ3aXNlIGNlbnRlciBpdCBhdCB0aGUgZGVzaXJlZCBjb29yZGluYXRlIHdoaWxlIGtlZXBpbmcgaXQgY29tcGxldGVseSBpbnNpZGUgdGhlIHdpbmRvdwoJCXJldHVyblZhbHVlID0gTWF0aC5taW4oIE1hdGgubWF4KCBvZmZzZXQsIGRlc2lyZWQgLSBzZWdtZW50U2l6ZSAvIDIgKSwgb2Zmc2V0ICsgd2luZG93U2l6ZSAtIHNlZ21lbnRTaXplICk7Cgl9CgoJcmV0dXJuIHJldHVyblZhbHVlOwp9CgpmdW5jdGlvbiBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhlV2luZG93ICkgewoJcmV0dXJuIHsKCQl4OiB0aGVXaW5kb3cuc2Nyb2xsTGVmdCgpLAoJCXk6IHRoZVdpbmRvdy5zY3JvbGxUb3AoKSwKCQljeDogKCB0aGVXaW5kb3dbIDAgXS5pbm5lcldpZHRoIHx8IHRoZVdpbmRvdy53aWR0aCgpICksCgkJY3k6ICggdGhlV2luZG93WyAwIF0uaW5uZXJIZWlnaHQgfHwgdGhlV2luZG93LmhlaWdodCgpICkKCX07Cn0KCiQud2lkZ2V0KCAibW9iaWxlLnBvcHVwIiwgewoJb3B0aW9uczogewoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQlvdmVybGF5VGhlbWU6IG51bGwsCgkJc2hhZG93OiB0cnVlLAoJCWNvcm5lcnM6IHRydWUsCgkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCXBvc2l0aW9uVG86ICJvcmlnaW4iLAoJCXRvbGVyYW5jZTogbnVsbCwKCQljbG9zZUxpbmtTZWxlY3RvcjogImE6anFtRGF0YShyZWw9J2JhY2snKSIsCgkJY2xvc2VMaW5rRXZlbnRzOiAiY2xpY2sucG9wdXAiLAoJCW5hdmlnYXRlRXZlbnRzOiAibmF2aWdhdGUucG9wdXAiLAoJCWNsb3NlRXZlbnRzOiAibmF2aWdhdGUucG9wdXAgcGFnZWJlZm9yZWNoYW5nZS5wb3B1cCIsCgkJZGlzbWlzc2libGU6IHRydWUsCgkJZW5oYW5jZWQ6IGZhbHNlLAoKCQkvLyBOT1RFIFdpbmRvd3MgUGhvbmUgNyBoYXMgYSBzY3JvbGwgcG9zaXRpb24gY2FjaGluZyBpc3N1ZSB0aGF0CgkJLy8gICAgICByZXF1aXJlcyB1cyB0byBkaXNhYmxlIHBvcHVwIGhpc3RvcnkgbWFuYWdlbWVudCBieSBkZWZhdWx0CgkJLy8gICAgICBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ3ODQKCQkvLwoJCS8vIE5PVEUgdGhpcyBvcHRpb24gaXMgbW9kaWZpZWQgaW4gX2NyZWF0ZSEKCQloaXN0b3J5OiAhJC5tb2JpbGUuYnJvd3Nlci5vbGRJRQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhlRWxlbWVudCA9IHRoaXMuZWxlbWVudCwKCQkJbXlJZCA9IHRoZUVsZW1lbnQuYXR0ciggImlkIiApLAoJCQljdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJLy8gV2UgbmVlZCB0byBhZGp1c3QgdGhlIGhpc3Rvcnkgb3B0aW9uIHRvIGJlIGZhbHNlIGlmIHRoZXJlJ3Mgbm8gQUpBWCBuYXYuCgkJLy8gV2UgY2FuJ3QgZG8gaXQgaW4gdGhlIG9wdGlvbiBkZWNsYXJhdGlvbnMgYmVjYXVzZSB0aG9zZSBhcmUgcnVuIGJlZm9yZQoJCS8vIGl0IGlzIGRldGVybWluZWQgd2hldGhlciB0aGVyZSBzaGFsbCBiZSBBSkFYIG5hdi4KCQljdXJyZW50T3B0aW9ucy5oaXN0b3J5ID0gY3VycmVudE9wdGlvbnMuaGlzdG9yeSAmJiAkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZDsKCgkJLy8gRGVmaW5lIGluc3RhbmNlIHZhcmlhYmxlcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9zY3JvbGxUb3A6IDAsCgkJCV9wYWdlOiB0aGVFbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJX3VpOiBudWxsLAoJCQlfZmFsbGJhY2tUcmFuc2l0aW9uOiAiIiwKCQkJX2N1cnJlbnRUcmFuc2l0aW9uOiBmYWxzZSwKCQkJX3ByZXJlcXVpc2l0ZXM6IG51bGwsCgkJCV9pc09wZW46IGZhbHNlLAoJCQlfdG9sZXJhbmNlOiBudWxsLAoJCQlfcmVzaXplRGF0YTogbnVsbCwKCQkJX2lnbm9yZVJlc2l6ZVRvOiAwLAoJCQlfb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzOiBmYWxzZQoJCX0pOwoKCQlpZiAoIHRoaXMuX3BhZ2UubGVuZ3RoID09PSAwICkgewoJCQl0aGlzLl9wYWdlID0gJCggImJvZHkiICk7CgkJfQoKCQlpZiAoIGN1cnJlbnRPcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl91aSA9IHsKCQkJCWNvbnRhaW5lcjogdGhlRWxlbWVudC5wYXJlbnQoKSwKCQkJCXNjcmVlbjogdGhlRWxlbWVudC5wYXJlbnQoKS5wcmV2KCksCgkJCQlwbGFjZWhvbGRlcjogJCggdGhpcy5kb2N1bWVudFsgMCBdLmdldEVsZW1lbnRCeUlkKCBteUlkICsgIi1wbGFjZWhvbGRlciIgKSApCgkJCX07CgkJfSBlbHNlIHsKCQkJdGhpcy5fdWkgPSB0aGlzLl9lbmhhbmNlKCB0aGVFbGVtZW50LCBteUlkICk7CgkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggY3VycmVudE9wdGlvbnMudHJhbnNpdGlvbiApOwoJCX0KCQl0aGlzCgkJCS5fc2V0VG9sZXJhbmNlKCBjdXJyZW50T3B0aW9ucy50b2xlcmFuY2UgKQoJCQkuX3VpLmZvY3VzRWxlbWVudCA9IHRoaXMuX3VpLmNvbnRhaW5lcjsKCgkJLy8gRXZlbnQgaGFuZGxlcnMKCQl0aGlzLl9vbiggdGhpcy5fdWkuc2NyZWVuLCB7ICJ2Y2xpY2siOiAiX2VhdEV2ZW50QW5kQ2xvc2UiIH0gKTsKCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsKCQkJb3JpZW50YXRpb25jaGFuZ2U6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2UiICksCgkJCXJlc2l6ZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dSZXNpemUiICksCgkJCWtleXVwOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd0tleVVwIiApCgkJfSk7CgkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsgImZvY3VzaW4iOiAiX2hhbmRsZURvY3VtZW50Rm9jdXNJbiIgfSApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oIHRoZUVsZW1lbnQsIG15SWQgKSB7CgkJdmFyIGN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQl3cmFwcGVyQ2xhc3MgPSBjdXJyZW50T3B0aW9ucy53cmFwcGVyQ2xhc3MsCgkJCXVpID0gewoJCQkJc2NyZWVuOiAkKCAiPGRpdiBjbGFzcz0ndWktc2NyZWVuLWhpZGRlbiB1aS1wb3B1cC1zY3JlZW4gIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgY3VycmVudE9wdGlvbnMub3ZlcmxheVRoZW1lICkgKyAiJz48L2Rpdj4iICksCgkJCQlwbGFjZWhvbGRlcjogJCggIjxkaXYgc3R5bGU9J2Rpc3BsYXk6IG5vbmU7Jz48IS0tIHBsYWNlaG9sZGVyIC0tPjwvZGl2PiIgKSwKCQkJCWNvbnRhaW5lcjogJCggIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWNvbnRhaW5lciB1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICsKCQkJCQkoIHdyYXBwZXJDbGFzcyA/ICggIiAiICsgd3JhcHBlckNsYXNzICkgOiAiIiApICsgIic+PC9kaXY+IiApCgkJCX0sCgkJCWZyYWdtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHVpLnNjcmVlblsgMCBdICk7CgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHVpLmNvbnRhaW5lclsgMCBdICk7CgoJCWlmICggbXlJZCApIHsKCQkJdWkuc2NyZWVuLmF0dHIoICJpZCIsIG15SWQgKyAiLXNjcmVlbiIgKTsKCQkJdWkuY29udGFpbmVyLmF0dHIoICJpZCIsIG15SWQgKyAiLXBvcHVwIiApOwoJCQl1aS5wbGFjZWhvbGRlcgoJCQkJLmF0dHIoICJpZCIsIG15SWQgKyAiLXBsYWNlaG9sZGVyIiApCgkJCQkuaHRtbCggIjwhLS0gcGxhY2Vob2xkZXIgZm9yICIgKyBteUlkICsgIiAtLT4iICk7CgkJfQoKCQkvLyBBcHBseSB0aGUgcHJvdG8KCQl0aGlzLl9wYWdlWyAwIF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgkJLy8gTGVhdmUgYSBwbGFjZWhvbGRlciB3aGVyZSB0aGUgZWxlbWVudCB1c2VkIHRvIGJlCgkJdWkucGxhY2Vob2xkZXIuaW5zZXJ0QWZ0ZXIoIHRoZUVsZW1lbnQgKTsKCQl0aGVFbGVtZW50CgkJCS5kZXRhY2goKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cCAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBjdXJyZW50T3B0aW9ucy50aGVtZSApICsgIiAiICsKCQkJCSggY3VycmVudE9wdGlvbnMuc2hhZG93ID8gInVpLW92ZXJsYXktc2hhZG93ICIgOiAiIiApICsKCQkJCSggY3VycmVudE9wdGlvbnMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICkKCQkJLmFwcGVuZFRvKCB1aS5jb250YWluZXIgKTsKCgkJcmV0dXJuIHVpOwoJfSwKCglfZWF0RXZlbnRBbmRDbG9zZTogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJdGhlRXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCgkvLyBNYWtlIHN1cmUgdGhlIHNjcmVlbiBjb3ZlcnMgdGhlIGVudGlyZSBkb2N1bWVudCAtIENTUyBpcyBzb21ldGltZXMgbm90CgkvLyBlbm91Z2ggdG8gYWNjb21wbGlzaCB0aGlzLgoJX3Jlc2l6ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdmFyIHNjcmVlbiA9IHRoaXMuX3VpLnNjcmVlbiwKCQkJcG9wdXBIZWlnaHQgPSB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKSwKCQkJc2NyZWVuSGVpZ2h0ID0gc2NyZWVuLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5oZWlnaHQoKSwKCgkJCS8vIFN1YnRyYWN0aW5nIDEgaGVyZSBpcyBuZWNlc3NhcnkgZm9yIGFuIG9ic2N1cmUgQW5kcmRvaWQgNC4wIGJ1ZyB3aGVyZQoJCQkvLyB0aGUgYnJvd3NlciBoYW5ncyBpZiB0aGUgc2NyZWVuIGNvdmVycyB0aGUgZW50aXJlIGRvY3VtZW50IDovCgkJCWRvY3VtZW50SGVpZ2h0ID0gdGhpcy5kb2N1bWVudC5oZWlnaHQoKSAtIDE7CgoJCWlmICggc2NyZWVuSGVpZ2h0IDwgZG9jdW1lbnRIZWlnaHQgKSB7CgkJCXNjcmVlbi5oZWlnaHQoIGRvY3VtZW50SGVpZ2h0ICk7CgkJfSBlbHNlIGlmICggcG9wdXBIZWlnaHQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCXNjcmVlbi5oZWlnaHQoIHBvcHVwSGVpZ2h0ICk7CgkJfQoJfSwKCglfaGFuZGxlV2luZG93S2V5VXA6IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiB0aGVFdmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVTQ0FQRSApIHsKCQkJcmV0dXJuIHRoaXMuX2VhdEV2ZW50QW5kQ2xvc2UoIHRoZUV2ZW50ICk7CgkJfQoJfSwKCglfZXhwZWN0UmVzaXplRXZlbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciB3aW5kb3dDb29yZGluYXRlcyA9IGdldFdpbmRvd0Nvb3JkaW5hdGVzKCB0aGlzLndpbmRvdyApOwoKCQlpZiAoIHRoaXMuX3Jlc2l6ZURhdGEgKSB7CgkJCWlmICggd2luZG93Q29vcmRpbmF0ZXMueCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy54ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy55ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLnkgJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLmN4ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLmN4ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy5jeSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy5jeSApIHsKCQkJCS8vIHRpbWVvdXQgbm90IHJlZnJlc2hlZAoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgewoJCQkJLy8gY2xlYXIgZXhpc3RpbmcgdGltZW91dCAtIGl0IHdpbGwgYmUgcmVmcmVzaGVkIGJlbG93CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuX3Jlc2l6ZURhdGEudGltZW91dElkICk7CgkJCX0KCQl9CgoJCXRoaXMuX3Jlc2l6ZURhdGEgPSB7CgkJCXRpbWVvdXRJZDogdGhpcy5fZGVsYXkoICJfcmVzaXplVGltZW91dCIsIDIwMCApLAoJCQl3aW5kb3dDb29yZGluYXRlczogd2luZG93Q29vcmRpbmF0ZXMKCQl9OwoKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJX3Jlc2l6ZVRpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQlpZiAoICF0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpICkgewoJCQkJaWYgKCB0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtb3BlbiB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKTsKCQkJCQl0aGlzLnJlcG9zaXRpb24oIHsgcG9zaXRpb25UbzogIndpbmRvdyIgfSApOwoJCQkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCQkJfQoKCQkJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJfQoJCX0gZWxzZSB7CgkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQl9Cgl9LAoKCV9zdG9wSWdub3JpbmdSZXNpemVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gMDsKCX0sCgoJX2lnbm9yZVJlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pZ25vcmVSZXNpemVUbyApIHsKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9pZ25vcmVSZXNpemVUbyApOwoJCX0KCQl0aGlzLl9pZ25vcmVSZXNpemVUbyA9IHRoaXMuX2RlbGF5KCAiX3N0b3BJZ25vcmluZ1Jlc2l6ZUV2ZW50cyIsIDEwMDAgKTsKCX0sCgoJX2hhbmRsZVdpbmRvd1Jlc2l6ZTogZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJaWYgKCAoIHRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgfHwgdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICkgJiYKCQkJCSF0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1jbG9zZSB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiApCgkJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQkJfQoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlOiBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCWlmICggIXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyAmJiB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCk7CgkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IHRydWU7CgkJfQoJfSwKCgkvLyBXaGVuIHRoZSBwb3B1cCBpcyBvcGVuLCBhdHRlbXB0aW5nIHRvIGZvY3VzIG9uIGFuIGVsZW1lbnQgdGhhdCBpcyBub3QgYQoJLy8gY2hpbGQgb2YgdGhlIHBvcHVwIHdpbGwgcmVkaXJlY3QgZm9jdXMgdG8gdGhlIHBvcHVwCglfaGFuZGxlRG9jdW1lbnRGb2N1c0luOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJdmFyIHRhcmdldCwKCQkJdGFyZ2V0RWxlbWVudCA9IHRoZUV2ZW50LnRhcmdldCwKCQkJdWkgPSB0aGlzLl91aTsKCgkJaWYgKCAhdGhpcy5faXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRhcmdldEVsZW1lbnQgIT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQl0YXJnZXQgPSAkKCB0YXJnZXRFbGVtZW50ICk7CgkJCWlmICggMCA9PT0gdGFyZ2V0LnBhcmVudHMoKS5maWx0ZXIoIHVpLmNvbnRhaW5lclsgMCBdICkubGVuZ3RoICkgewoJCQkJJCggdGhpcy5kb2N1bWVudFsgMCBdLmFjdGl2ZUVsZW1lbnQgKS5vbmUoICJmb2N1cyIsIGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJCQkJdGFyZ2V0LmJsdXIoKTsKCQkJCX0pOwoJCQkJdWkuZm9jdXNFbGVtZW50LmZvY3VzKCk7CgkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJdGhlRXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHVpLmZvY3VzRWxlbWVudFsgMCBdID09PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJCXVpLmZvY3VzRWxlbWVudCA9IHRhcmdldDsKCQkJfQoJCX0KCgkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7Cgl9LAoKCV90aGVtZUNsYXNzRnJvbU9wdGlvbjogZnVuY3Rpb24oIHByZWZpeCwgdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICggcHJlZml4ICsgdmFsdWUgKSApIDogKCBwcmVmaXggKyAiaW5oZXJpdCIgKSApOwoJfSwKCglfYXBwbHlUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJaWYgKCB2YWx1ZSApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJaWYgKCB2YWx1ZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCQlpZiAoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9PT0gIm5vbmUiICkgewoJCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICIiOwoJCQkJfQoJCQkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbmV3T3B0aW9ucyApIHsKCQl2YXIgY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCXRoZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCXNjcmVlbiA9IHRoaXMuX3VpLnNjcmVlbjsKCgkJaWYgKCBuZXdPcHRpb25zLndyYXBwZXJDbGFzcyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCS5yZW1vdmVDbGFzcyggY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzICkKCQkJCS5hZGRDbGFzcyggbmV3T3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50CgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBjdXJyZW50T3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG5ld09wdGlvbnMudGhlbWUgKSApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlzY3JlZW4KCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIGN1cnJlbnRPcHRpb25zLm92ZXJsYXlUaGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIG5ld09wdGlvbnMub3ZlcmxheVRoZW1lICkgKTsKCgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJc2NyZWVuLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQl9CgoJCWlmICggbmV3T3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudC50b2dnbGVDbGFzcyggInVpLW92ZXJsYXktc2hhZG93IiwgbmV3T3B0aW9ucy5zaGFkb3cgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgbmV3T3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudHJhbnNpdGlvbiAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICF0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggbmV3T3B0aW9ucy50cmFuc2l0aW9uICk7CgkJCX0KCQl9CgoJCWlmICggbmV3T3B0aW9ucy50b2xlcmFuY2UgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0VG9sZXJhbmNlKCBuZXdPcHRpb25zLnRvbGVyYW5jZSApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggbmV3T3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCXRoaXMuY2xvc2UoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCBuZXdPcHRpb25zICk7Cgl9LAoKCV9zZXRUb2xlcmFuY2U6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgdG9sID0geyB0OiAzMCwgcjogMTUsIGI6IDMwLCBsOiAxNSB9LAoJCQlhcjsKCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQlhciA9IFN0cmluZyggdmFsdWUgKS5zcGxpdCggIiwiICk7CgoJCQkkLmVhY2goIGFyLCBmdW5jdGlvbiggaWR4LCB2YWwgKSB7IGFyWyBpZHggXSA9IHBhcnNlSW50KCB2YWwsIDEwICk7IH0gKTsKCgkJCXN3aXRjaCggYXIubGVuZ3RoICkgewoJCQkJLy8gQWxsIHZhbHVlcyBhcmUgdG8gYmUgdGhlIHNhbWUKCQkJCWNhc2UgMToKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IHRvbC5yID0gdG9sLmIgPSB0b2wubCA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCS8vIFRoZSBmaXJzdCB2YWx1ZSBkZW5vdGVzIHRvcC9ib3R0b20gdG9sZXJhbmNlLCBhbmQgdGhlIHNlY29uZCB2YWx1ZSBkZW5vdGVzIGxlZnQvcmlnaHQgdG9sZXJhbmNlCgkJCQljYXNlIDI6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSB0b2wuYiA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCXRvbC5sID0gdG9sLnIgPSBhclsgMSBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQkvLyBUaGUgYXJyYXkgY29udGFpbnMgdmFsdWVzIGluIHRoZSBvcmRlciB0b3AsIHJpZ2h0LCBib3R0b20sIGxlZnQKCQkJCWNhc2UgNDoKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCXRvbC5yID0gYXJbIDEgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAyIF0gKSApIHsKCQkJCQkJdG9sLmIgPSBhclsgMiBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDMgXSApICkgewoJCQkJCQl0b2wubCA9IGFyWyAzIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCWRlZmF1bHQ6CgkJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXRoaXMuX3RvbGVyYW5jZSA9IHRvbDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2NsYW1wUG9wdXBXaWR0aDogZnVuY3Rpb24oIGluZm9Pbmx5ICkgewoJCXZhciBtZW51U2l6ZSwKCQkJd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhpcy53aW5kb3cgKSwKCQkJLy8gcmVjdGFuZ2xlIHdpdGhpbiB3aGljaCB0aGUgcG9wdXAgbXVzdCBmaXQKCQkJcmVjdGFuZ2xlID0gewoJCQkJeDogdGhpcy5fdG9sZXJhbmNlLmwsCgkJCQl5OiB3aW5kb3dDb29yZGluYXRlcy55ICsgdGhpcy5fdG9sZXJhbmNlLnQsCgkJCQljeDogd2luZG93Q29vcmRpbmF0ZXMuY3ggLSB0aGlzLl90b2xlcmFuY2UubCAtIHRoaXMuX3RvbGVyYW5jZS5yLAoJCQkJY3k6IHdpbmRvd0Nvb3JkaW5hdGVzLmN5IC0gdGhpcy5fdG9sZXJhbmNlLnQgLSB0aGlzLl90b2xlcmFuY2UuYgoJCQl9OwoKCQlpZiAoICFpbmZvT25seSApIHsKCQkJLy8gQ2xhbXAgdGhlIHdpZHRoIG9mIHRoZSBtZW51IGJlZm9yZSBncmFiYmluZyBpdHMgc2l6ZQoJCQl0aGlzLl91aS5jb250YWluZXIuY3NzKCAibWF4LXdpZHRoIiwgcmVjdGFuZ2xlLmN4ICk7CgkJfQoKCQltZW51U2l6ZSA9IHsKCQkJY3g6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlcldpZHRoKCB0cnVlICksCgkJCWN5OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKQoJCX07CgoJCXJldHVybiB7IHJjOiByZWN0YW5nbGUsIG1lbnVTaXplOiBtZW51U2l6ZSB9OwoJfSwKCglfY2FsY3VsYXRlRmluYWxMb2NhdGlvbjogZnVuY3Rpb24oIGRlc2lyZWQsIGNsYW1wSW5mbyApIHsKCQl2YXIgcmV0dXJuVmFsdWUsCgkJCXJlY3RhbmdsZSA9IGNsYW1wSW5mby5yYywKCQkJbWVudVNpemUgPSBjbGFtcEluZm8ubWVudVNpemU7CgoJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzCgkJLy8gdG9vIGxhcmdlLgoJCXJldHVyblZhbHVlID0gewoJCQlsZWZ0OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmVjdGFuZ2xlLmN4LCBtZW51U2l6ZS5jeCwgcmVjdGFuZ2xlLngsIGRlc2lyZWQueCApLAoJCQl0b3A6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByZWN0YW5nbGUuY3ksIG1lbnVTaXplLmN5LCByZWN0YW5nbGUueSwgZGVzaXJlZC55ICkKCQl9OwoKCQkvLyBNYWtlIHN1cmUgdGhlIHRvcCBvZiB0aGUgbWVudSBpcyB2aXNpYmxlCgkJcmV0dXJuVmFsdWUudG9wID0gTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCApOwoKCQkvLyBJZiB0aGUgaGVpZ2h0IG9mIHRoZSBtZW51IGlzIHNtYWxsZXIgdGhhbiB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudAoJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQlyZXR1cm5WYWx1ZS50b3AgLT0gTWF0aC5taW4oIHJldHVyblZhbHVlLnRvcCwKCQkJTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCArIG1lbnVTaXplLmN5IC0gdGhpcy5kb2N1bWVudC5oZWlnaHQoKSApICk7CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX0sCgoJLy8gVHJ5IGFuZCBjZW50ZXIgdGhlIG92ZXJsYXkgb3ZlciB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMKCV9wbGFjZW1lbnRDb29yZHM6IGZ1bmN0aW9uKCBkZXNpcmVkICkgewoJCXJldHVybiB0aGlzLl9jYWxjdWxhdGVGaW5hbExvY2F0aW9uKCBkZXNpcmVkLCB0aGlzLl9jbGFtcFBvcHVwV2lkdGgoKSApOwoJfSwKCglfY3JlYXRlUHJlcmVxdWlzaXRlczogZnVuY3Rpb24oIHNjcmVlblByZXJlcXVpc2l0ZSwgY29udGFpbmVyUHJlcmVxdWlzaXRlLCB3aGVuRG9uZSApIHsKCQl2YXIgcHJlcmVxdWlzaXRlcywKCQkJc2VsZiA9IHRoaXM7CgoJCS8vIEl0IGlzIGltcG9ydGFudCB0byBtYWludGFpbiBib3RoIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXF1aXNpdGVzIGFuZAoJCS8vIHNlbGYuX3ByZXJlcXVpc2l0ZXMuIFRoZSBsb2NhbCB2YXJpYWJsZSByZW1haW5zIGluIHRoZSBjbG9zdXJlIG9mIHRoZQoJCS8vIGZ1bmN0aW9ucyB3aGljaCBjYWxsIHRoZSBjYWxsYmFja3MgcGFzc2VkIGluLiBUaGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZQoJCS8vIGxvY2FsIHZhcmlhYmxlIGFuZCBzZWxmLl9wcmVyZXF1aXNpdGVzIGlzIG5lY2Vzc2FyeSwgYmVjYXVzZSBvbmNlIGEKCQkvLyBmdW5jdGlvbiBoYXMgYmVlbiBwYXNzZWQgdG8gLmFuaW1hdGlvbkNvbXBsZXRlKCkgaXQgd2lsbCBiZSBjYWxsZWQgbmV4dAoJCS8vIHRpbWUgYW4gYW5pbWF0aW9uIGNvbXBsZXRlcywgZXZlbiBpZiB0aGF0J3Mgbm90IHRoZSBhbmltYXRpb24gd2hvc2UgZW5kCgkJLy8gdGhlIGZ1bmN0aW9uIHdhcyBzdXBwb3NlZCB0byBjYXRjaCAoZm9yIGV4YW1wbGUsIGlmIGFuIGFib3J0IGhhcHBlbnMKCQkvLyBkdXJpbmcgdGhlIG9wZW5pbmcgYW5pbWF0aW9uLCB0aGUgLmFuaW1hdGlvbkNvbXBsZXRlIGhhbmRsZXIgaXMgbm90CgkJLy8gY2FsbGVkIGZvciB0aGF0IGFuaW1hdGlvbiBhbnltb3JlLCBidXQgdGhlIGhhbmRsZXIgcmVtYWlucyBhdHRhY2hlZCwgc28KCQkvLyBpdCBpcyBjYWxsZWQgdGhlIG5leHQgdGltZSB0aGUgcG9wdXAgaXMgb3BlbmVkIC0gbWFraW5nIGl0IHN0YWxlLgoJCS8vIENvbXBhcmluZyB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxdWlzaXRlcyB0byB0aGUgd2lkZ2V0LWxldmVsIHZhcmlhYmxlCgkJLy8gc2VsZi5fcHJlcmVxdWlzaXRlcyBlbnN1cmVzIHRoYXQgY2FsbGJhY2tzIHRyaWdnZXJlZCBieSBhIHN0YWxlCgkJLy8gLmFuaW1hdGlvbkNvbXBsZXRlIHdpbGwgYmUgaWdub3JlZC4KCgkJcHJlcmVxdWlzaXRlcyA9IHsKCQkJc2NyZWVuOiAkLkRlZmVycmVkKCksCgkJCWNvbnRhaW5lcjogJC5EZWZlcnJlZCgpCgkJfTsKCgkJcHJlcmVxdWlzaXRlcy5zY3JlZW4udGhlbiggZnVuY3Rpb24oKSB7CgkJCWlmICggcHJlcmVxdWlzaXRlcyA9PT0gc2VsZi5fcHJlcmVxdWlzaXRlcyApIHsKCQkJCXNjcmVlblByZXJlcXVpc2l0ZSgpOwoJCQl9CgkJfSk7CgoJCXByZXJlcXVpc2l0ZXMuY29udGFpbmVyLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQljb250YWluZXJQcmVyZXF1aXNpdGUoKTsKCQkJfQoJCX0pOwoKCQkkLndoZW4oIHByZXJlcXVpc2l0ZXMuc2NyZWVuLCBwcmVyZXF1aXNpdGVzLmNvbnRhaW5lciApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQlzZWxmLl9wcmVyZXF1aXNpdGVzID0gbnVsbDsKCQkJCXdoZW5Eb25lKCk7CgkJCX0KCQl9KTsKCgkJc2VsZi5fcHJlcmVxdWlzaXRlcyA9IHByZXJlcXVpc2l0ZXM7Cgl9LAoKCV9hbmltYXRlOiBmdW5jdGlvbiggYXJncyApIHsKCQkvLyBOT1RFIGJlZm9yZSByZW1vdmluZyB0aGUgZGVmYXVsdCBhbmltYXRpb24gb2YgdGhlIHNjcmVlbgoJCS8vICAgICAgdGhpcyBoYWQgYW4gYW5pbWF0ZSBjYWxsYmFjayB0aGF0IHdvdWxkIHJlc29sdmUgdGhlIGRlZmVycmVkCgkJLy8gICAgICBub3cgdGhlIGRlZmVycmVkIGlzIHJlc29sdmVkIGltbWVkaWF0ZWx5CgkJLy8gVE9ETyByZW1vdmUgdGhlIGRlcGVuZGVuY3kgb24gdGhlIHNjcmVlbiBkZWZlcnJlZAoJCXRoaXMuX3VpLnNjcmVlbgoJCQkucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApCgkJCS5hZGRDbGFzcyggYXJncy5zY3JlZW5DbGFzc1RvQWRkICk7CgoJCWFyZ3MucHJlcmVxdWlzaXRlcy5zY3JlZW4ucmVzb2x2ZSgpOwoKCQlpZiAoIGFyZ3MudHJhbnNpdGlvbiAmJiBhcmdzLnRyYW5zaXRpb24gIT09ICJub25lIiApIHsKCQkJaWYgKCBhcmdzLmFwcGx5VHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggYXJncy50cmFuc2l0aW9uICk7CgkJCX0KCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYWRkQ2xhc3MoIGFyZ3MuY29udGFpbmVyQ2xhc3NUb0FkZCApCgkJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZSggJC5wcm94eSggYXJncy5wcmVyZXF1aXNpdGVzLmNvbnRhaW5lciwgInJlc29sdmUiICkgKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApOwoJCWFyZ3MucHJlcmVxdWlzaXRlcy5jb250YWluZXIucmVzb2x2ZSgpOwoJfSwKCgkvLyBUaGUgZGVzaXJlZCBjb29yZGluYXRlcyBwYXNzZWQgaW4gd2lsbCBiZSByZXR1cm5lZCB1bnRvdWNoZWQgaWYgbm8gcmVmZXJlbmNlIGVsZW1lbnQgY2FuIGJlIGlkZW50aWZpZWQgdmlhCgkvLyBkZXNpcmVkUG9zaXRpb24ucG9zaXRpb25Uby4gTmV2ZXJ0aGVsZXNzLCB0aGlzIGZ1bmN0aW9uIGVuc3VyZXMgdGhhdCBpdHMgcmV0dXJuIHZhbHVlIGFsd2F5cyBjb250YWlucyB2YWxpZAoJLy8geCBhbmQgeSBjb29yZGluYXRlcyBieSBzcGVjaWZ5aW5nIHRoZSBjZW50ZXIgbWlkZGxlIG9mIHRoZSB3aW5kb3cgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSBhYnNlbnQuCgkvLyBvcHRpb25zOiB7IHg6IGNvb3JkaW5hdGUsIHk6IGNvb3JkaW5hdGUsIHBvc2l0aW9uVG86IHN0cmluZzogIm9yaWdpbiIsICJ3aW5kb3ciLCBvciBqUXVlcnkgc2VsZWN0b3IKCV9kZXNpcmVkQ29vcmRzOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJdmFyIG9mZnNldCwKCQkJZHN0ID0gbnVsbCwKCQkJd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhpcy53aW5kb3cgKSwKCQkJeCA9IG9wZW5PcHRpb25zLngsCgkJCXkgPSBvcGVuT3B0aW9ucy55LAoJCQlwVG8gPSBvcGVuT3B0aW9ucy5wb3NpdGlvblRvOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggZWxlbWVudCB3aWxsIHNlcnZlIGFzIHRoZSByZWZlcmVuY2UKCQlpZiAoIHBUbyAmJiBwVG8gIT09ICJvcmlnaW4iICkgewoJCQlpZiAoIHBUbyA9PT0gIndpbmRvdyIgKSB7CgkJCQl4ID0gd2luZG93Q29vcmRpbmF0ZXMuY3ggLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueDsKCQkJCXkgPSB3aW5kb3dDb29yZGluYXRlcy5jeSAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy55OwoJCQl9IGVsc2UgewoJCQkJdHJ5IHsKCQkJCQlkc3QgPSAkKCBwVG8gKTsKCQkJCX0gY2F0Y2goIGVyciApIHsKCQkJCQlkc3QgPSBudWxsOwoJCQkJfQoJCQkJaWYgKCBkc3QgKSB7CgkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCWlmICggZHN0ICkgewoJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQl5ID0gb2Zmc2V0LnRvcCArIGRzdC5vdXRlckhlaWdodCgpIC8gMjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCWlmICggJC50eXBlKCB4ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB4ICkgKSB7CgkJCXggPSB3aW5kb3dDb29yZGluYXRlcy5jeCAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy54OwoJCX0KCQlpZiAoICQudHlwZSggeSApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeSApICkgewoJCQl5ID0gd2luZG93Q29vcmRpbmF0ZXMuY3kgLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueTsKCQl9CgoJCXJldHVybiB7IHg6IHgsIHk6IHkgfTsKCX0sCgoJX3JlcG9zaXRpb246IGZ1bmN0aW9uKCBvcGVuT3B0aW9ucyApIHsKCQkvLyBXZSBvbmx5IGNhcmUgYWJvdXQgcG9zaXRpb24tcmVsYXRlZCBwYXJhbWV0ZXJzIGZvciByZXBvc2l0aW9uaW5nCgkJb3Blbk9wdGlvbnMgPSB7CgkJCXg6IG9wZW5PcHRpb25zLngsCgkJCXk6IG9wZW5PcHRpb25zLnksCgkJCXBvc2l0aW9uVG86IG9wZW5PcHRpb25zLnBvc2l0aW9uVG8KCQl9OwoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIsIHVuZGVmaW5lZCwgb3Blbk9wdGlvbnMgKTsKCQl0aGlzLl91aS5jb250YWluZXIub2Zmc2V0KCB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIG9wZW5PcHRpb25zICkgKSApOwoJfSwKCglyZXBvc2l0aW9uOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCXRoaXMuX3JlcG9zaXRpb24oIG9wZW5PcHRpb25zICk7CgkJfQoJfSwKCglfb3BlblByZXJlcXVpc2l0ZXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkID0gdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKTsKCgkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX2lzT3BlbiA9IHRydWU7CgkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJdGhpcy5fdWkuY29udGFpbmVyLmF0dHIoICJ0YWJpbmRleCIsICIwIiApLmZvY3VzKCk7CgkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJaWYgKCBpZCApIHsKCQkJdGhpcy5kb2N1bWVudC5maW5kKCAiW2FyaWEtaGFzcG9wdXA9J3RydWUnXVthcmlhLW93bnM9JyIgKyAgaWQgKyAiJ10iICkuYXR0ciggImFyaWEtZXhwYW5kZWQiLCB0cnVlICk7CgkJfQoJCXRoaXMuX3RyaWdnZXIoICJhZnRlcm9wZW4iICk7Cgl9LAoKCV9vcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgb3Blbk9wdGlvbnMgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyApLAoJCQkvLyBUT0RPIG1vdmUgYmxhY2tsaXN0IHRvIHByaXZhdGUgbWV0aG9kCgkJCWFuZHJvaWRCbGFja2xpc3QgPSAoIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOVwuXSspLyApLAoJCQkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCQkJYW5kcm9pZG1hdGNoID0gdWEubWF0Y2goIC9BbmRyb2lkIChcZCsoPzpcLlxkKykpLyApLAoJCQkJCWFuZHZlcnNpb24gPSAhIWFuZHJvaWRtYXRjaCAmJiBhbmRyb2lkbWF0Y2hbIDEgXSwKCQkJCQljaHJvbWVtYXRjaCA9IHVhLmluZGV4T2YoICJDaHJvbWUiICkgPiAtMTsKCgkJCQkvLyBQbGF0Zm9ybSBpcyBBbmRyb2lkLCBXZWJLaXQgdmVyc2lvbiBpcyBncmVhdGVyIHRoYW4gNTM0LjEzICggQW5kcm9pZCAzLjIuMSApIGFuZCBub3QgQ2hyb21lLgoJCQkJaWYgKCBhbmRyb2lkbWF0Y2ggIT09IG51bGwgJiYgYW5kdmVyc2lvbiA9PT0gIjQuMCIgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA+IDUzNC4xMyAmJiAhY2hyb21lbWF0Y2ggKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0oKSk7CgoJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcm9wZW4iIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IGFuaW1hdGlvbiBjb21wbGV0ZXMgKGNvbnRhaW5lcigpKQoJCS8vIDIuIFRoZSBzY3JlZW4gb3BhY2l0eSBhbmltYXRpb24gY29tcGxldGVzIChzY3JlZW4oKSkKCQl0aGlzLl9jcmVhdGVQcmVyZXF1aXNpdGVzKAoJCQkkLm5vb3AsCgkJCSQubm9vcCwKCQkJJC5wcm94eSggdGhpcywgIl9vcGVuUHJlcmVxdWlzaXRlc0NvbXBsZXRlIiApICk7CgoJCXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uID0gb3Blbk9wdGlvbnMudHJhbnNpdGlvbjsKCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIG9wZW5PcHRpb25zLnRyYW5zaXRpb24gKTsKCgkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC10cnVuY2F0ZSIgKTsKCgkJLy8gR2l2ZSBhcHBsaWNhdGlvbnMgYSBjaGFuY2UgdG8gbW9kaWZ5IHRoZSBjb250ZW50cyBvZiB0aGUgY29udGFpbmVyIGJlZm9yZSBpdCBhcHBlYXJzCgkJdGhpcy5fcmVwb3NpdGlvbiggb3Blbk9wdGlvbnMgKTsKCgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgJiYgYW5kcm9pZEJsYWNrbGlzdCApIHsKCQkJLyogVE9ETzogVGhlIG5hdGl2ZSBicm93c2VyIG9uIEFuZHJvaWQgNC4wLlggKCJJY2UgQ3JlYW0gU2FuZHdpY2giKSBzdWZmZXJzIGZyb20gYW4gaXNzdWUgd2hlcmUgdGhlIHBvcHVwIG92ZXJsYXkgYXBwZWFycyB0byBiZSB6LWluZGV4ZWQgYWJvdmUgdGhlIHBvcHVwIGl0c2VsZiB3aGVuIGNlcnRhaW4gb3RoZXIgc3R5bGVzIGV4aXN0IG9uIHRoZSBzYW1lIHBhZ2UgLS0gbmFtZWx5LCBhbnkgZWxlbWVudCBzZXQgdG8gYHBvc2l0aW9uOiBmaXhlZGAgYW5kIGNlcnRhaW4gdHlwZXMgb2YgaW5wdXQuIFRoZXNlIGlzc3VlcyBhcmUgcmVtaW5pc2NlbnQgb2YgcHJldmlvdXNseSB1bmNvdmVyZWQgYnVncyBpbiBvbGRlciB2ZXJzaW9ucyBvZiBBbmRyb2lkJ3MgbmF0aXZlIGJyb3dzZXI6IGh0dHBzOi8vZ2l0aHViLmNvbS9zY290dGplaGwvRGV2aWNlLUJ1Z3MvaXNzdWVzLzMKCQkJVGhpcyBmaXggY2xvc2VzIHRoZSBmb2xsb3dpbmcgYnVncyAoIEkgdXNlICJjbG9zZXMiIHdpdGggcmVsdWN0YW5jZSwgYW5kIHN0cmVzcyB0aGF0IHRoaXMgaXNzdWUgc2hvdWxkIGJlIHJldmlzaXRlZCBhcyBzb29uIGFzIHBvc3NpYmxlICk6CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDgxNgoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NDQKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODc0CgkJCSovCgoJCQkvLyBUT0RPIHNvcnQgb3V0IHdoeSB0aGlzLl9wYWdlIGlzbid0IHdvcmtpbmcKCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKS5hZGRDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgkJfQoJCXRoaXMuX2FuaW1hdGUoewoJCQlhZGRpdGlvbmFsQ29uZGl0aW9uOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiBvcGVuT3B0aW9ucy50cmFuc2l0aW9uLAoJCQljbGFzc1RvUmVtb3ZlOiAiIiwKCQkJc2NyZWVuQ2xhc3NUb0FkZDogImluIiwKCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogImluIiwKCQkJYXBwbHlUcmFuc2l0aW9uOiBmYWxzZSwKCQkJcHJlcmVxdWlzaXRlczogdGhpcy5fcHJlcmVxdWlzaXRlcwoJCX0pOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVTY3JlZW46IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VpLnNjcmVlbgoJCQkucmVtb3ZlQ2xhc3MoICJvdXQiICkKCQkJLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlQ29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl91aS5jb250YWluZXIKCQkJLnJlbW92ZUNsYXNzKCAicmV2ZXJzZSBvdXQiICkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiApCgkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZXNEb25lOiBmdW5jdGlvbigpIHsKCQl2YXIgY29udGFpbmVyID0gdGhpcy5fdWkuY29udGFpbmVyLAoJCQlpZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICk7CgoJCWNvbnRhaW5lci5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgoJCS8vIHJlbW92ZSB0aGUgZ2xvYmFsIG11dGV4IGZvciBwb3B1cHMKCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB1bmRlZmluZWQ7CgoJCS8vIEJsdXIgZWxlbWVudHMgaW5zaWRlIHRoZSBjb250YWluZXIsIGluY2x1ZGluZyB0aGUgY29udGFpbmVyCgkJJCggIjpmb2N1cyIsIGNvbnRhaW5lclsgMCBdICkuYWRkKCBjb250YWluZXJbIDAgXSApLmJsdXIoKTsKCgkJaWYgKCBpZCApIHsKCQkJdGhpcy5kb2N1bWVudC5maW5kKCAiW2FyaWEtaGFzcG9wdXA9J3RydWUnXVthcmlhLW93bnM9JyIgKyAgaWQgKyAiJ10iICkuYXR0ciggImFyaWEtZXhwYW5kZWQiLCBmYWxzZSApOwoJCX0KCgkJLy8gYWxlcnQgdXNlcnMgdGhhdCB0aGUgcG9wdXAgaXMgY2xvc2VkCgkJdGhpcy5fdHJpZ2dlciggImFmdGVyY2xvc2UiICk7Cgl9LAoKCV9jbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgoJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJjbG9zZSIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgcmV2ZXJzZSBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxdWlzaXRlcygKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbiIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZUNvbnRhaW5lciIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZXNEb25lIiApICk7CgoJCXRoaXMuX2FuaW1hdGUoIHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdGhpcy5fdWkuc2NyZWVuLmhhc0NsYXNzKCAiaW4iICksCgkJCXRyYW5zaXRpb246ICggaW1tZWRpYXRlID8gIm5vbmUiIDogKCB0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApICksCgkJCWNsYXNzVG9SZW1vdmU6ICJpbiIsCgkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJvdXQiLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAicmV2ZXJzZSBvdXQiLAoJCQlhcHBseVRyYW5zaXRpb246IHRydWUsCgkJCXByZXJlcXVpc2l0ZXM6IHRoaXMuX3ByZXJlcXVpc2l0ZXMKCQl9KTsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCXRoaXMuX3NldE9wdGlvbnMoIHsgdGhlbWU6ICQubW9iaWxlLnBvcHVwLnByb3RvdHlwZS5vcHRpb25zLnRoZW1lIH0gKTsKCQl0aGlzLmVsZW1lbnQKCQkJLy8gQ2Fubm90IGRpcmVjdGx5IGluc2VydEFmdGVyKCkgLSB3ZSBuZWVkIHRvIGRldGFjaCgpIGZpcnN0LCBiZWNhdXNlCgkJCS8vIGluc2VydEFmdGVyKCkgd2lsbCBkbyBub3RoaW5nIGlmIHRoZSBwYXlsb2FkIGRpdiB3YXMgbm90IGF0dGFjaGVkCgkJCS8vIHRvIHRoZSBET00gYXQgdGhlIHRpbWUgdGhlIHdpZGdldCB3YXMgY3JlYXRlZCwgYW5kIHNvIHRoZSBwYXlsb2FkCgkJCS8vIHdpbGwgcmVtYWluIGluc2lkZSB0aGUgY29udGFpbmVyIGV2ZW4gYWZ0ZXIgd2UgY2FsbCBpbnNlcnRBZnRlcigpLgoJCQkvLyBJZiB0aGF0IGhhcHBlbnMgYW5kIHdlIHJlbW92ZSB0aGUgY29udGFpbmVyIGEgZmV3IGxpbmVzIGJlbG93LCB3ZQoJCQkvLyB3aWxsIGNhdXNlIGFuIGluZmluaXRlIHJlY3Vyc2lvbiAtICM1MjQ0CgkJCS5kZXRhY2goKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuX3VpLnBsYWNlaG9sZGVyICkKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCB1aS1ib2R5LWluaGVyaXQiICk7CgkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZSgpOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmUoKTsKCQl0aGlzLl91aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlID09PSB0aGlzICkgewoJCQl0aGlzLmVsZW1lbnQub25lKCAicG9wdXBhZnRlcmNsb3NlIiwgJC5wcm94eSggdGhpcywgIl91bmVuaGFuY2UiICkgKTsKCQkJdGhpcy5jbG9zZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VuZW5oYW5jZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jbG9zZVBvcHVwOiBmdW5jdGlvbiggdGhlRXZlbnQsIGRhdGEgKSB7CgkJdmFyIHBhcnNlZERzdCwgdG9VcmwsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpbW1lZGlhdGUgPSBmYWxzZTsKCgkJaWYgKCAoIHRoZUV2ZW50ICYmIHRoZUV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgfHwgJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyByZXN0b3JlIGxvY2F0aW9uIG9uIHNjcmVlbgoJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy5fc2Nyb2xsVG9wICk7CgoJCWlmICggdGhlRXZlbnQgJiYgdGhlRXZlbnQudHlwZSA9PT0gInBhZ2ViZWZvcmVjaGFuZ2UiICYmIGRhdGEgKSB7CgkJCS8vIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgdG8gcmFwaWQtY2xvc2UgdGhlIHBvcHVwLCBvciB3aGV0aGVyIHdlIGNhbgoJCQkvLyB0YWtlIHRoZSB0aW1lIHRvIHJ1biB0aGUgY2xvc2luZyB0cmFuc2l0aW9uCgkJCWlmICggdHlwZW9mIGRhdGEudG9QYWdlID09PSAic3RyaW5nIiApIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlOwoJCQl9IGVsc2UgewoJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJfQoJCQlwYXJzZWREc3QgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCBwYXJzZWREc3QgKTsKCQkJdG9VcmwgPSBwYXJzZWREc3QucGF0aG5hbWUgKyBwYXJzZWREc3Quc2VhcmNoICsgcGFyc2VkRHN0Lmhhc2g7CgoJCQlpZiAoIHRoaXMuX215VXJsICE9PSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG9VcmwgKSApIHsKCQkJCS8vIEdvaW5nIHRvIGEgZGlmZmVyZW50IHBhZ2UgLSBjbG9zZSBpbW1lZGlhdGVseQoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgoJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MKCQl0aGlzLndpbmRvdy5vZmYoIGN1cnJlbnRPcHRpb25zLmNsb3NlRXZlbnRzICk7CgkJLy8gdW5iaW5kIGNsaWNrIGhhbmRsZXJzIGFkZGVkIHdoZW4gaGlzdG9yeSBpcyBkaXNhYmxlZAoJCXRoaXMuZWxlbWVudC51bmRlbGVnYXRlKCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtTZWxlY3RvciwgY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rRXZlbnRzICk7CgoJCXRoaXMuX2Nsb3NlKCBpbW1lZGlhdGUgKTsKCX0sCgoJLy8gYW55IG5hdmlnYXRpb24gZXZlbnQgYWZ0ZXIgYSBwb3B1cCBpcyBvcGVuZWQgc2hvdWxkIGNsb3NlIHRoZSBwb3B1cAoJLy8gTk9URSB0aGUgcGFnZWJlZm9yZWNoYW5nZSBpcyBib3VuZCB0byBjYXRjaCBuYXZpZ2F0aW9uIGV2ZW50cyB0aGF0IGRvbid0CgkvLyAgICAgIGFsdGVyIHRoZSB1cmwgKGVnLCBkaWFsb2dzIGZyb20gcG9wdXBzKQoJX2JpbmRDb250YWluZXJDbG9zZTogZnVuY3Rpb24oKSB7CgkJdGhpcy53aW5kb3cKCQkJLm9uKCB0aGlzLm9wdGlvbnMuY2xvc2VFdmVudHMsICQucHJveHkoIHRoaXMsICJfY2xvc2VQb3B1cCIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl91aS5jb250YWluZXI7Cgl9LAoKCS8vIFRPRE8gbm8gY2xlYXIgZGVsaW5pYXRpb24gb2Ygd2hhdCBzaG91bGQgYmUgaGVyZSBhbmQKCS8vIHdoYXQgc2hvdWxkIGJlIGluIF9vcGVuLiBTZWVtcyB0byBiZSAidmlzdWFsIiB2cyAiaGlzdG9yeSIgZm9yIG5vdwoJb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHVybCwgaGFzaGtleSwgYWN0aXZlUGFnZSwgY3VycmVudElzRGlhbG9nLCBoYXNIYXNoLCB1cmxIaXN0b3J5LAoJCQlzZWxmID0gdGhpcywKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIG1ha2Ugc3VyZSBvcGVuIGlzIGlkZW1wb3RlbnQKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSB8fCBjdXJyZW50T3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBzZXQgdGhlIGdsb2JhbCBwb3B1cCBtdXRleAoJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHRoaXM7CgkJdGhpcy5fc2Nyb2xsVG9wID0gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCS8vIGlmIGhpc3RvcnkgYWx0ZXJhdGlvbiBpcyBkaXNhYmxlZCBjbG9zZSBvbiBuYXZpZ2F0ZSBldmVudHMKCQkvLyBhbmQgbGVhdmUgdGhlIHVybCBhcyBpcwoJCWlmICggISggY3VycmVudE9wdGlvbnMuaGlzdG9yeSApICkgewoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoKCQkJLy8gV2hlbiBoaXN0b3kgaXMgZGlzYWJsZWQgd2UgaGF2ZSB0byBncmFiIHRoZSBkYXRhLXJlbAoJCQkvLyBiYWNrIGxpbmsgY2xpY2tzIHNvIHdlIGNhbiBjbG9zZSB0aGUgcG9wdXAgaW5zdGVhZCBvZgoJCQkvLyByZWx5aW5nIG9uIGhpc3RvcnkgdG8gZG8gaXQgZm9yIHVzCgkJCXNlbGYuZWxlbWVudAoJCQkJLmRlbGVnYXRlKCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtTZWxlY3RvciwgY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gY2FjaGUgc29tZSB2YWx1ZXMgZm9yIG1pbi9yZWFkYWJpbGl0eQoJCXVybEhpc3RvcnkgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoJCWhhc2hrZXkgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCWFjdGl2ZVBhZ2UgPSAkLm1vYmlsZS5hY3RpdmVQYWdlOwoJCWN1cnJlbnRJc0RpYWxvZyA9ICggYWN0aXZlUGFnZSA/IGFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgOiBmYWxzZSApOwoJCXRoaXMuX215VXJsID0gdXJsID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS51cmw7CgkJaGFzSGFzaCA9ICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA+IC0xICkgJiYgIWN1cnJlbnRJc0RpYWxvZyAmJiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICk7CgoJCWlmICggaGFzSGFzaCApIHsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCS8vIG90aGVyd2lzZSwgaWYgdGhlIHBhZ2UgaXMgYSBkaWFsb2cgc2ltcGx5IHRhY2sgb24gdGhlIGhhc2gga2V5CgkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICkgewoJCQl1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoICIjIiApID4gLTEgPyBoYXNoa2V5IDogIiMiICsgaGFzaGtleSk7CgkJfSBlbHNlIHsKCQkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCArIGhhc2hrZXk7CgkJfQoKCQkvLyBUYWNrIG9uIGFuIGV4dHJhIGhhc2hrZXkgaWYgdGhpcyBpcyB0aGUgZmlyc3QgcGFnZSBhbmQgd2UndmUganVzdCByZWNvbnN0cnVjdGVkIHRoZSBpbml0aWFsIGhhc2gKCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCXVybCArPSBoYXNoa2V5OwoJCX0KCgkJLy8gc3dhbGxvdyB0aGUgdGhlIGluaXRpYWwgbmF2aWdhdGlvbiBldmVudCwgYW5kIGJpbmQgZm9yIHRoZSBuZXh0CgkJdGhpcy53aW5kb3cub25lKCAiYmVmb3JlbmF2aWdhdGUiLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJfSk7CgoJCXRoaXMudXJsQWx0ZXJlZCA9IHRydWU7CgkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgeyByb2xlOiAiZGlhbG9nIiB9ICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJLy8gbWFrZSBzdXJlIGNsb3NlIGlzIGlkZW1wb3RlbnQKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl0aGlzLl9zY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlzdG9yeSAmJiB0aGlzLnVybEFsdGVyZWQgKSB7CgkJCSQubW9iaWxlLmJhY2soKTsKCQkJdGhpcy51cmxBbHRlcmVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJLy8gc2ltdWxhdGUgdGhlIG5hdiBiaW5kaW5ncyBoYXZpbmcgZmlyZWQKCQkJdGhpcy5fY2xvc2VQb3B1cCgpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9Cn0pOwoKLy8gVE9ETyB0aGlzIGNhbiBiZSBtb3ZlZCBpbnNpZGUgdGhlIHdpZGdldAokLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rID0gZnVuY3Rpb24oICRsaW5rICkgewoJdmFyIG9mZnNldCwKCQlwYXRoID0gJC5tb2JpbGUucGF0aCwKCgkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2ggZnJvbSB0aGUgaHJlZiBiZWNhdXNlIGllNyAod3A3KQoJCS8vICAgICAgcmV0dXJucyB0aGUgYWJzb2x1dGUgaHJlZiBpbiB0aGlzIGNhc2UgcnVpbmluZyB0aGUgZWxlbWVudCBzZWxlY3Rpb24KCQlwb3B1cCA9ICQoIHBhdGguaGFzaFRvU2VsZWN0b3IoIHBhdGgucGFyc2VVcmwoICRsaW5rLmF0dHIoICJocmVmIiApICkuaGFzaCApICkuZmlyc3QoKTsKCglpZiAoIHBvcHVwLmxlbmd0aCA+IDAgJiYgcG9wdXAuZGF0YSggIm1vYmlsZS1wb3B1cCIgKSApIHsKCQlvZmZzZXQgPSAkbGluay5vZmZzZXQoKTsKCQlwb3B1cC5wb3B1cCggIm9wZW4iLCB7CgkJCXg6IG9mZnNldC5sZWZ0ICsgJGxpbmsub3V0ZXJXaWR0aCgpIC8gMiwKCQkJeTogb2Zmc2V0LnRvcCArICRsaW5rLm91dGVySGVpZ2h0KCkgLyAyLAoJCQl0cmFuc2l0aW9uOiAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJcG9zaXRpb25UbzogJGxpbmsuanFtRGF0YSggInBvc2l0aW9uLXRvIiApCgkJfSk7Cgl9CgoJLy9yZW1vdmUgYWZ0ZXIgZGVsYXkKCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJfSwgMzAwICk7Cn07CgovLyBUT0RPIG1vdmUgaW5zaWRlIF9jcmVhdGUKJC5tb2JpbGUuZG9jdW1lbnQub24oICJwYWdlYmVmb3JlY2hhbmdlIiwgZnVuY3Rpb24oIHRoZUV2ZW50LCBkYXRhICkgewoJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgPSAiLnVpLWRpc2FibGVkLC51aS1zdGF0ZS1kaXNhYmxlZCwudWktbGktZGl2aWRlciwudWktc2NyZWVuLWhpZGRlbiw6anFtRGF0YShyb2xlPSdwbGFjZWhvbGRlcicpIiwKCWdvVG9BZGphY2VudEl0ZW0gPSBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0LCBkaXJlY3Rpb24gKSB7CgkJdmFyIGFkamFjZW50ID0gaXRlbVsgZGlyZWN0aW9uICsgIkFsbCIgXSgpCgkJCS5ub3QoIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICkKCQkJLmZpcnN0KCk7CgoJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJaWYgKCBhZGphY2VudC5sZW5ndGggKSB7CgkJCXRhcmdldAoJCQkJLmJsdXIoKQoJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCWFkamFjZW50LmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQl9Cgl9OwoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLnNlbGVjdG1lbnUsIHsKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDdXN0b20gc2VsZWN0cyBjYW5ub3QgZXhpc3QgaW5zaWRlIHBvcHVwcywgc28gcmV2ZXJ0IHRoZSAibmF0aXZlTWVudSIKCQkvLyBvcHRpb24gdG8gdHJ1ZSBpZiBhIHBhcmVudCBpcyBhIHBvcHVwCgkJby5uYXRpdmVNZW51ID0gby5uYXRpdmVNZW51IHx8ICggdGhpcy5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpLDptb2JpbGUtcG9wdXAiICkubGVuZ3RoID4gMCApOwoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJX2hhbmRsZVNlbGVjdEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYmx1cigpOwoJCXRoaXMuYnV0dG9uLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fc3VwZXIoIGV2ZW50ICk7CgkJdGhpcy5faGFuZGxlQnV0dG9uVmNsaWNrS2V5ZG93biggZXZlbnQgKTsKCX0sCgoJX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmlzT3BlbiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8IGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UpKSB7CgoJCQl0aGlzLl9kZWNpZGVGb3JtYXQoKTsKCQkJaWYgKCB0aGlzLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCQl0aGlzLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHRoaXMucG9wdXBJZCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgInBvcHVwIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyB0aGlzLmRpYWxvZ0lkICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAiZGlhbG9nIiApOwoJCQl9CgkJCXRoaXMuaXNPcGVuID0gdHJ1ZTsKCQkJLy8gRG8gbm90IHByZXZlbnQgZGVmYXVsdCwgc28gdGhlIG5hdmlnYXRpb24gbWF5IGhhdmUgYSBjaGFuY2UgdG8gYWN0dWFsbHkgb3BlbiB0aGUgY2hvc2VuIGZvcm1hdAoJCX0KCX0sCgoJX2hhbmRsZUxpc3RGb2N1czogZnVuY3Rpb24oIGUgKSB7CgkJdmFyIHBhcmFtcyA9ICggZS50eXBlID09PSAiZm9jdXNpbiIgKSA/CgkJCXsgdGFiaW5kZXg6ICIwIiwgZXZlbnQ6ICJ2bW91c2VvdmVyIiB9OgoJCQl7IHRhYmluZGV4OiAiLTEiLCBldmVudDogInZtb3VzZW91dCIgfTsKCgkJJCggZS50YXJnZXQgKQoJCQkuYXR0ciggInRhYmluZGV4IiwgcGFyYW1zLnRhYmluZGV4ICkKCQkJLnRyaWdnZXIoIHBhcmFtcy5ldmVudCApOwoJfSwKCglfaGFuZGxlTGlzdEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKTsKCgkJLy8gc3dpdGNoIGxvZ2ljIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCWNhc2UgMzg6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJwcmV2IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCWNhc2UgNDA6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJuZXh0IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQljYXNlIDEzOgoJCWNhc2UgMzI6CgkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9oYW5kbGVNZW51UGFnZUhpZGU6IGZ1bmN0aW9uKCkgewoJCS8vIFRPRE8gY2VudHJhbGl6ZSBwYWdlIHJlbW92YWwgYmluZGluZyAvIGhhbmRsaW5nIGluIHRoZSBwYWdlIHBsdWdpbi4KCQkvLyBTdWdnZXN0aW9uIGZyb20gQGpibGFzIHRvIGRvIHJlZmNvdW50aW5nCgkJLy8KCQkvLyBUT0RPIGV4dHJlbWVseSBjb25mdXNpbmcgZGVwZW5kZW5jeSBvbiB0aGUgb3BlbiBtZXRob2Qgd2hlcmUgdGhlIHBhZ2VoaWRlLnJlbW92ZQoJCS8vIGJpbmRpbmdzIGFyZSBzdHJpcHBlZCB0byBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGRpc2FwcGVhcmluZy4gVGhlIHdheQoJCS8vIHdlJ3JlIGtlZXBpbmcgcGFnZXMgaW4gdGhlIERPTSByaWdodCBub3cgc3Vja3MKCQkvLwoJCS8vIHJlYmluZCB0aGUgcGFnZSByZW1vdmUgdGhhdCB3YXMgdW5ib3VuZCBpbiB0aGUgb3BlbiBmdW5jdGlvbgoJCS8vIHRvIGFsbG93IGZvciB0aGUgcGFyZW50IHBhZ2UgcmVtb3ZhbCBmcm9tIGFjdGlvbnMgb3RoZXIgdGhhbiB0aGUgdXNlCgkJLy8gb2YgYSBkaWFsb2cgc2l6ZWQgY3VzdG9tIHNlbGVjdAoJCS8vCgkJLy8gZG9pbmcgdGhpcyBoZXJlIHByb3ZpZGVzIGZvciB0aGUgYmFjayBidXR0b24gb24gdGhlIGN1c3RvbSBzZWxlY3QgZGlhbG9nCgkJdGhpcy50aGlzUGFnZS5wYWdlKCAiYmluZFJlbW92ZSIgKTsKCX0sCgoJX2hhbmRsZUhlYWRlckNsb3NlQ2xpY2s6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0SWQsIHBvcHVwSWQsIGRpYWxvZ0lkLCBsYWJlbCwgdGhpc1BhZ2UsIGlzTXVsdGlwbGUsIG1lbnVJZCwKCQkJdGhlbWVBdHRyLCBvdmVybGF5VGhlbWUsIG92ZXJsYXlUaGVtZUF0dHIsIGRpdmlkZXJUaGVtZUF0dHIsCgkJCW1lbnVQYWdlLCBsaXN0Ym94LCBsaXN0LCBoZWFkZXIsIGhlYWRlclRpdGxlLCBtZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2UsIGhlYWRlckNsb3NlLCBzZWxmLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG8ubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7CgkJfQoKCQlzZWxmID0gdGhpczsKCQlzZWxlY3RJZCA9IHRoaXMuc2VsZWN0SWQ7CgkJcG9wdXBJZCA9IHNlbGVjdElkICsgIi1saXN0Ym94IjsKCQlkaWFsb2dJZCA9IHNlbGVjdElkICsgIi1kaWFsb2ciOwoJCWxhYmVsID0gdGhpcy5sYWJlbDsKCQl0aGlzUGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJaXNNdWx0aXBsZSA9IHRoaXMuZWxlbWVudFsgMCBdLm11bHRpcGxlOwoJCW1lbnVJZCA9IHNlbGVjdElkICsgIi1tZW51IjsKCQl0aGVtZUF0dHIgPSBvLnRoZW1lID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lPSciICsgby50aGVtZSArICInIiApIDogIiI7CgkJb3ZlcmxheVRoZW1lID0gby5vdmVybGF5VGhlbWUgfHwgby50aGVtZSB8fCBudWxsOwoJCW92ZXJsYXlUaGVtZUF0dHIgPSBvdmVybGF5VGhlbWUgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKwoJCQkib3ZlcmxheS10aGVtZT0nIiArIG92ZXJsYXlUaGVtZSArICInIiApIDogIiI7CgkJZGl2aWRlclRoZW1lQXR0ciA9ICggby5kaXZpZGVyVGhlbWUgJiYgaXNNdWx0aXBsZSApID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgImRpdmlkZXItdGhlbWU9JyIgKyBvLmRpdmlkZXJUaGVtZSArICInIiApIDogIiI7CgkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGNsYXNzPSd1aS1zZWxlY3RtZW51JyBpZD0nIiArIGRpYWxvZ0lkICsgIiciICsgdGhlbWVBdHRyICsgb3ZlcmxheVRoZW1lQXR0ciArICI+IiArCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2hlYWRlcic+IiArCgkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJIjwvZGl2PiIrCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PiIrCgkJCSI8L2Rpdj4iICk7CgkJbGlzdGJveCA9ICQoICI8ZGl2IGlkPSciICsgcG9wdXBJZCArICInIGNsYXNzPSd1aS1zZWxlY3RtZW51Jz48L2Rpdj4iICkuaW5zZXJ0QWZ0ZXIoIHRoaXMuc2VsZWN0ICkucG9wdXAoeyB0aGVtZTogby5vdmVybGF5VGhlbWUgfSk7CgkJbGlzdCA9ICQoICI8dWwgY2xhc3M9J3VpLXNlbGVjdG1lbnUtbGlzdCcgaWQ9JyIgKyBtZW51SWQgKyAiJyByb2xlPSdsaXN0Ym94JyBhcmlhLWxhYmVsbGVkYnk9JyIgKyB0aGlzLmJ1dHRvbklkICsgIiciICsgdGhlbWVBdHRyICsgZGl2aWRlclRoZW1lQXR0ciArICI+PC91bD4iICkuYXBwZW5kVG8oIGxpc3Rib3ggKTsKCQloZWFkZXIgPSAkKCAiPGRpdiBjbGFzcz0ndWktaGVhZGVyIHVpLWJhci0iICsgKCBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IiApICsgIic+PC9kaXY+IiApLnByZXBlbmRUbyggbGlzdGJveCApOwoJCWhlYWRlclRpdGxlID0gJCggIjxoMSBjbGFzcz0ndWktdGl0bGUnPjwvaDE+IiApLmFwcGVuZFRvKCBoZWFkZXIgKTsKCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkidGV4dCI6IG8uY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuIHVpLWNvcm5lci1hbGwgdWktYnRuLWxlZnQgdWktYnRuLWljb24tbm90ZXh0IHVpLWljb24tZGVsZXRlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICk7CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzZWxlY3RJZDogc2VsZWN0SWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQlwb3B1cElkOiBwb3B1cElkLAoJCQlkaWFsb2dJZDogZGlhbG9nSWQsCgkJCXRoaXNQYWdlOiB0aGlzUGFnZSwKCQkJbWVudVBhZ2U6IG1lbnVQYWdlLAoJCQlsYWJlbDogbGFiZWwsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiBvLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIKCQl9KTsKCgkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCXRoaXMucmVmcmVzaCgpOwoKCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQkvLyBNYXAgdW5kZWZpbmVkIHRvIGZhbHNlLCBiZWNhdXNlIHRoaXMuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkCgkJCS8vIGluZGljYXRlcyB0aGF0IHdlIGhhdmUgbm90IHlldCBjaGVja2VkIHdoZXRoZXIgdGhlIHNlbGVjdCBoYXMKCQkJLy8gb3JpZ2luYWxseSBoYWQgYSB0YWJpbmRleCBhdHRyaWJ1dGUsIHdoZXJlYXMgZmFsc2UgaW5kaWNhdGVzIHRoYXQKCQkJLy8gd2UgaGF2ZSBjaGVja2VkIHRoZSBzZWxlY3QgZm9yIHN1Y2ggYW4gYXR0cmlidXRlLCBhbmQgaGF2ZSBmb3VuZAoJCQkvLyBub25lIHByZXNlbnQuCgkJCXRoaXMuX29yaWdUYWJJbmRleCA9ICggdGhpcy5zZWxlY3RbIDAgXS5nZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIgKSA9PT0gbnVsbCApID8gZmFsc2UgOiB0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiICk7CgkJfQoJCXRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCQl0aGlzLl9vbiggdGhpcy5zZWxlY3QsIHsgZm9jdXMgOiAiX2hhbmRsZVNlbGVjdEZvY3VzIiB9ICk7CgoJCS8vIEJ1dHRvbiBldmVudHMKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHsKCQkJdmNsaWNrOiAiX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd24iCgkJfSk7CgoJCS8vIEV2ZW50cyBmb3IgbGlzdCBpdGVtcwoJCXRoaXMubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApOwoJCXRoaXMuX29uKCB0aGlzLmxpc3QsIHsKCQkJZm9jdXNpbiA6ICJfaGFuZGxlTGlzdEZvY3VzIiwKCQkJZm9jdXNvdXQgOiAiX2hhbmRsZUxpc3RGb2N1cyIsCgkJCWtleWRvd246ICJfaGFuZGxlTGlzdEtleWRvd24iCgkJfSk7CgkJdGhpcy5saXN0CgkJCS5kZWxlZ2F0ZSggImxpOm5vdCgudWktZGlzYWJsZWQsLnVpLXN0YXRlLWRpc2FibGVkLC51aS1saS1kaXZpZGVyKSIsICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkvLyBpbmRleCBvZiBvcHRpb24gdGFnIHRvIGJlIHNlbGVjdGVkCgkJCQl2YXIgb2xkSW5kZXggPSBzZWxmLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgkJCQkJbmV3SW5kZXggPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJvcHRpb24taW5kZXgiICksCgkJCQkJb3B0aW9uID0gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmVxKCBuZXdJbmRleCApWyAwIF07CgoJCQkJLy8gdG9nZ2xlIHNlbGVjdGVkIHN0YXR1cyBvbiB0aGUgdGFnIGZvciBtdWx0aSBzZWxlY3RzCgkJCQlvcHRpb24uc2VsZWN0ZWQgPSBzZWxmLmlzTXVsdGlwbGUgPyAhb3B0aW9uLnNlbGVjdGVkIDogdHJ1ZTsKCgkJCQkvLyB0b2dnbGUgY2hlY2tib3ggY2xhc3MgZm9yIG11bHRpcGxlIHNlbGVjdHMKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCSQoIHRoaXMgKS5maW5kKCAiYSIgKQoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNoZWNrYm94LW9mZiIsICFvcHRpb24uc2VsZWN0ZWQgKTsKCQkJCX0KCgkJCQkvLyB0cmlnZ2VyIGNoYW5nZSBpZiB2YWx1ZSBjaGFuZ2VkCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSB8fCBvbGRJbmRleCAhPT0gbmV3SW5kZXggKSB7CgkJCQkJc2VsZi5zZWxlY3QudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCX0KCgkJCQkvLyBoaWRlIGN1c3RvbSBzZWxlY3QgZm9yIHNpbmdsZSBzZWxlY3RzIG9ubHkgLSBvdGhlcndpc2UgZm9jdXMgY2xpY2tlZCBpdGVtCgkJCQkvLyBXZSBuZWVkIHRvIGdyYWIgdGhlIGNsaWNrZWQgaXRlbSB0aGUgaGFyZCB3YXksIGJlY2F1c2UgdGhlIGxpc3QgbWF5IGhhdmUgYmVlbiByZWJ1aWx0CgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuZXEoIG5ld0luZGV4ICkKCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCgkJLy8gYnV0dG9uIHJlZm9jdXMgZW5zdXJlcyBwcm9wZXIgaGVpZ2h0IGNhbGN1bGF0aW9uCgkJLy8gYnkgcmVtb3ZpbmcgdGhlIGlubGluZSBzdHlsZSBhbmQgZW5zdXJpbmcgcGFnZSBpbmNsdXNpb24KCQl0aGlzLl9vbiggdGhpcy5tZW51UGFnZSwgeyBwYWdlaGlkZTogIl9oYW5kbGVNZW51UGFnZUhpZGUiIH0gKTsKCgkJLy8gRXZlbnRzIG9uIHRoZSBwb3B1cAoJCXRoaXMuX29uKCB0aGlzLmxpc3Rib3gsIHsgcG9wdXBhZnRlcmNsb3NlOiAiY2xvc2UiIH0gKTsKCgkJLy8gQ2xvc2UgYnV0dG9uIG9uIHNtYWxsIG92ZXJsYXlzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuX29uKCB0aGlzLmhlYWRlckNsb3NlLCB7IGNsaWNrOiAiX2hhbmRsZUhlYWRlckNsb3NlQ2xpY2siIH0gKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfaXNSZWJ1aWxkUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewoJCXZhciBsaXN0ID0gdGhpcy5saXN0LmZpbmQoICJsaSIgKSwKCQkJb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCgkJLy8gVE9ETyBleGNlZWRpbmdseSBuYWl2ZSBtZXRob2QgdG8gZGV0ZXJtaW5lIGRpZmZlcmVuY2UKCQkvLyBpZ25vcmVzIHZhbHVlIGNoYW5nZXMgZXRjIGluIGZhdm9yIG9mIGEgZm9yY2VkUmVidWlsZAoJCS8vIGZyb20gdGhlIHVzZXIgaW4gdGhlIHJlZnJlc2ggbWV0aG9kCgkJcmV0dXJuIG9wdGlvbnMudGV4dCgpICE9PSBsaXN0LnRleHQoKTsKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkOm5vdCggOmpxbURhdGEocGxhY2Vob2xkZXI9J3RydWUnKSApIiApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggZm9yY2UgKSB7CgkJdmFyIHNlbGYsIGluZGljZXM7CgoJCWlmICggdGhpcy5vcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCXJldHVybiB0aGlzLl9zdXBlciggZm9yY2UgKTsKCQl9CgoJCXNlbGYgPSB0aGlzOwoJCWlmICggZm9yY2UgfHwgdGhpcy5faXNSZWJ1aWxkUmVxdWlyZWQoKSApIHsKCQkJc2VsZi5fYnVpbGRMaXN0KCk7CgkJfQoKCQlpbmRpY2VzID0gdGhpcy5zZWxlY3RlZEluZGljZXMoKTsKCgkJc2VsZi5zZXRCdXR0b25UZXh0KCk7CgkJc2VsZi5zZXRCdXR0b25Db3VudCgpOwoKCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkKCQkJLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmVuZCgpCgkJCS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIGZhbHNlICkKCQkJLmVhY2goZnVuY3Rpb24oIGkgKSB7CgoJCQkJaWYgKCAkLmluQXJyYXkoIGksIGluZGljZXMgKSA+IC0xICkgewoJCQkJCXZhciBpdGVtID0gJCggdGhpcyApOwoKCQkJCQkvLyBBcmlhIHNlbGVjdGVkIGF0dHIKCQkJCQlpdGVtLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgdHJ1ZSApOwoKCQkJCQkvLyBNdWx0aXBsZSBzZWxlY3RzOiBhZGQgdGhlICJvbiIgY2hlY2tib3ggc3RhdGUgdG8gdGhlIGljb24KCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJaXRlbS5maW5kKCAiYSIgKS5yZW1vdmVDbGFzcyggInVpLWNoZWNrYm94LW9mZiIgKS5hZGRDbGFzcyggInVpLWNoZWNrYm94LW9uIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmICggaXRlbS5oYXNDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICkgKSB7CgkJCQkJCQlpdGVtLm5leHQoKS5maW5kKCAiYSIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWl0ZW0uZmluZCggImEiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0pOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gInBhZ2UiICkgewoJCQlzZWxmLm1lbnVQYWdlLmRpYWxvZyggImNsb3NlIiApOwoJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCX0gZWxzZSB7CgkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCX0KCgkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCXNlbGYuaXNPcGVuID0gZmFsc2U7Cgl9LAoKCW9wZW46IGZ1bmN0aW9uKCkgewoJCXRoaXMuYnV0dG9uLmNsaWNrKCk7Cgl9LAoKCV9mb2N1c01lbnVJdGVtOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0b3IgPSB0aGlzLmxpc3QuZmluZCggImEuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJaWYgKCBzZWxlY3Rvci5sZW5ndGggPT09IDAgKSB7CgkJCXNlbGVjdG9yID0gdGhpcy5saXN0LmZpbmQoICJsaTpub3QoIiArIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICsgIikgYS51aS1idG4iICk7CgkJfQoJCXNlbGVjdG9yLmZpcnN0KCkuZm9jdXMoKTsKCX0sCgoJX2RlY2lkZUZvcm1hdDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkd2luZG93ID0gdGhpcy53aW5kb3csCgkJCXNlbGZMaXN0UGFyZW50ID0gc2VsZi5saXN0LnBhcmVudCgpLAoJCQltZW51SGVpZ2h0ID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJIZWlnaHQoKSwKCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJYnRuT2Zmc2V0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkudG9wLAoJCQlzY3JlZW5IZWlnaHQgPSAkd2luZG93LmhlaWdodCgpOwoKCQlpZiAoIG1lbnVIZWlnaHQgPiBzY3JlZW5IZWlnaHQgLSA4MCB8fCAhJC5zdXBwb3J0LnNjcm9sbFRvcCApIHsKCgkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCXNlbGYubWVudVBhZ2VDb250ZW50ID0gc2VsZi5tZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCXNlbGYubWVudVBhZ2VDbG9zZSA9IHNlbGYubWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCS8vIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sCgkJCS8vIG90aGVyd2lzZSB0aGUgcmVzdWx0cyBvZiBzZWxlY3RpbmcgYSBsaXN0IGl0ZW0gaW4gdGhlIGRpYWxvZwoJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCXNlbGYudGhpc1BhZ2UudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApOwoKCQkJLy9mb3IgV2ViT1MvT3BlcmEgTWluaSAoc2V0IGxhc3RzY3JvbGwgdXNpbmcgYnV0dG9uIG9mZnNldCkKCQkJaWYgKCBzY3JvbGxUb3AgPT09IDAgJiYgYnRuT2Zmc2V0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJc2VsZi50aGlzUGFnZS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJfSk7CgkJCX0KCgkJCXNlbGYubWVudVBhZ2Uub25lKCB7CgkJCQlwYWdlc2hvdzogJC5wcm94eSggdGhpcywgIl9mb2N1c01lbnVJdGVtIiApLAoJCQkJcGFnZWhpZGU6ICQucHJveHkoIHRoaXMsICJjbG9zZSIgKQoJCQl9KTsKCgkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCXNlbGYubWVudVBhZ2VDb250ZW50LmFwcGVuZCggc2VsZi5saXN0ICk7CgkJCXNlbGYubWVudVBhZ2UuZmluZCggImRpdiAudWktdGl0bGUiICkudGV4dCggc2VsZi5sYWJlbC50ZXh0KCkgKTsKCQl9IGVsc2UgewoJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJc2VsZi5saXN0Ym94Lm9uZSggeyBwb3B1cGFmdGVyb3BlbjogJC5wcm94eSggdGhpcywgIl9mb2N1c01lbnVJdGVtIiApIH0gKTsKCQl9Cgl9LAoKCV9idWlsZExpc3Q6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJcGxhY2Vob2xkZXIgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQlkYXRhSWNvbiA9ICJmYWxzZSIsCgkJCSRvcHRpb25zLCBudW1PcHRpb25zLCBzZWxlY3QsCgkJCWRhdGFQcmVmaXggPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCWRhdGFJbmRleEF0dHIgPSBkYXRhUHJlZml4ICsgIm9wdGlvbi1pbmRleCIsCgkJCWRhdGFJY29uQXR0ciA9IGRhdGFQcmVmaXggKyAiaWNvbiIsCgkJCWRhdGFSb2xlQXR0ciA9IGRhdGFQcmVmaXggKyAicm9sZSIsCgkJCWRhdGFQbGFjZWhvbGRlckF0dHIgPSBkYXRhUHJlZml4ICsgInBsYWNlaG9sZGVyIiwKCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCWlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UsCgkJCW9wdEdyb3VwLAoJCQlpLAoJCQlvcHRpb24sICRvcHRpb24sIHBhcmVudCwgdGV4dCwgYW5jaG9yLCBjbGFzc2VzLAoJCQlvcHRMYWJlbCwgZGl2aWRlciwgaXRlbTsKCgkJc2VsZi5saXN0LmVtcHR5KCkuZmlsdGVyKCAiLnVpLWxpc3R2aWV3IiApLmxpc3R2aWV3KCAiZGVzdHJveSIgKTsKCQkkb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKTsKCQludW1PcHRpb25zID0gJG9wdGlvbnMubGVuZ3RoOwoJCXNlbGVjdCA9IHRoaXMuc2VsZWN0WyAwIF07CgoJCWZvciAoIGkgPSAwOyBpIDwgbnVtT3B0aW9ucztpKyssIGlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UpIHsKCQkJb3B0aW9uID0gJG9wdGlvbnNbaV07CgkJCSRvcHRpb24gPSAkKCBvcHRpb24gKTsKCgkJCS8vIERvIG5vdCBjcmVhdGUgb3B0aW9ucyBiYXNlZCBvbiB1aS1zY3JlZW4taGlkZGVuIHNlbGVjdCBvcHRpb25zCgkJCWlmICggJG9wdGlvbi5oYXNDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICkgKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJcGFyZW50ID0gb3B0aW9uLnBhcmVudE5vZGU7CgkJCXRleHQgPSAkb3B0aW9uLnRleHQoKTsKCQkJYW5jaG9yICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJCQljbGFzc2VzID0gW107CgoJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAiaHJlZiIsICIjIiApOwoJCQlhbmNob3IuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCgkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQlvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICJsYWJlbCIgKTsKCQkJCWlmICggb3B0TGFiZWwgIT09IG9wdEdyb3VwICkgewoJCQkJCWRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoIGRhdGFSb2xlQXR0ciwgImxpc3QtZGl2aWRlciIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAib3B0aW9uIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdExhYmVsICkgKTsKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQl9CgkJCX0KCgkJCWlmICggbmVlZFBsYWNlaG9sZGVyICYmICggIW9wdGlvbi5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSB8fCB0ZXh0Lmxlbmd0aCA9PT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSApICkgewoJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJLy8gSWYgd2UgaGF2ZSBpZGVudGlmaWVkIGEgcGxhY2Vob2xkZXIsIHJlY29yZCB0aGUgZmFjdCB0aGF0IGl0IHdhcwoJCQkJLy8gdXMgd2hvIGhhdmUgYWRkZWQgdGhlIHBsYWNlaG9sZGVyIHRvIHRoZSBvcHRpb24gYW5kIG1hcmsgaXQKCQkJCS8vIHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQlpZiAoIG51bGwgPT09IG9wdGlvbi5nZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIgKSApIHsKCQkJCQl0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgPSB0cnVlOwoJCQkJfQoJCQkJb3B0aW9uLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJfQoJCQkJaWYgKCBwbGFjZWhvbGRlciAhPT0gdGV4dCApIHsKCQkJCQlwbGFjZWhvbGRlciA9IHNlbGYucGxhY2Vob2xkZXIgPSB0ZXh0OwoJCQkJfQoJCQl9CgoJCQlpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxpIiApOwoJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCWNsYXNzZXMucHVzaCggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSW5kZXhBdHRyLCBpICk7CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSWNvbkF0dHIsIGRhdGFJY29uICk7CgkJCWlmICggaXNQbGFjZWhvbGRlckl0ZW0gKSB7CgkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCAiICIgKTsKCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgIm9wdGlvbiIgKTsKCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggInRhYmluZGV4IiwgIi0xIiApOwoJCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJCSQoIGFuY2hvciApLmFkZENsYXNzKCAidWktYnRuIHVpLWNoZWNrYm94LW9mZiB1aS1idG4taWNvbi1yaWdodCIgKTsKCQkJfQoKCQkJaXRlbS5hcHBlbmRDaGlsZCggYW5jaG9yICk7CgkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpdGVtICk7CgkJfQoKCQlzZWxmLmxpc3RbMF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgoJCS8vIEhpZGUgaGVhZGVyIGlmIGl0J3Mgbm90IGEgbXVsdGlzZWxlY3QgYW5kIHRoZXJlJ3Mgbm8gcGxhY2Vob2xkZXIKCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJdGhpcy5oZWFkZXIuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCX0KCgkJLy8gTm93IHBvcHVsYXRlZCwgY3JlYXRlIGxpc3R2aWV3CgkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSA/CgkJCXRoaXMuX3N1cGVyKCkgOgoJCQkkKCAiPGE+IiwgewoJCQkJImhyZWYiOiAiIyIsCgkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwKCgkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCX0pOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgoJCWlmICggIXRoaXMub3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQl0aGlzLmNsb3NlKCk7CgoJCQkvLyBSZXN0b3JlIHRoZSB0YWJpbmRleCBhdHRyaWJ1dGUgdG8gaXRzIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gZmFsc2UgKSB7CgkJCQkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgdGhpcy5fb3JpZ1RhYkluZGV4ICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuc2VsZWN0LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIHRoZSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgaWYgd2Ugd2VyZSB0aGUgb25lcyB0byBhZGQgaXQKCQkJaWYgKCB0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgKSB7CgkJCQl0aGlzLl9zZWxlY3RPcHRpb25zKCkucmVtb3ZlQXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInBsYWNlaG9sZGVyIiApOwoJCQl9CgoJCQkvLyBSZW1vdmUgdGhlIHBvcHVwCgkJCXRoaXMubGlzdGJveC5yZW1vdmUoKTsKCgkJCS8vIFJlbW92ZSB0aGUgZGlhbG9nCgkJCXRoaXMubWVudVBhZ2UucmVtb3ZlKCk7CgkJfQoKCQkvLyBDaGFpbiB1cAoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCi8vIGJ1dHRvbk1hcmt1cCBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gMS41LjAuCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIEdlbmVyYWwgcG9saWN5OiBEbyBub3QgYWNjZXNzIGRhdGEtKiBhdHRyaWJ1dGVzIGV4Y2VwdCBkdXJpbmcgZW5oYW5jZW1lbnQuCi8vIEluIGFsbCBvdGhlciBjYXNlcyB3ZSBkZXRlcm1pbmUgdGhlIHN0YXRlIG9mIHRoZSBidXR0b24gZXhjbHVzaXZlbHkgZnJvbSBpdHMKLy8gY2xhc3NOYW1lLiBUaGF0J3Mgd2h5IG9wdGlvbnNUb0NsYXNzZXMgZXhwZWN0cyBhIGZ1bGwgY29tcGxlbWVudCBvZiBvcHRpb25zLAovLyBhbmQgdGhlIGpRdWVyeSBwbHVnaW4gY29tcGxldGVzIHRoZSBzZXQgb2Ygb3B0aW9ucyBmcm9tIHRoZSBkZWZhdWx0IHZhbHVlcy4KCi8vIE1hcCBjbGFzc2VzIHRvIGJ1dHRvbk1hcmt1cCBib29sZWFuIG9wdGlvbnMgLSB1c2VkIGluIGNsYXNzTmFtZVRvT3B0aW9ucygpCnZhciByZXZlcnNlQm9vbE9wdGlvbk1hcCA9IHsKCQkidWktc2hhZG93IiA6ICJzaGFkb3ciLAoJCSJ1aS1jb3JuZXItYWxsIiA6ICJjb3JuZXJzIiwKCQkidWktYnRuLWlubGluZSIgOiAiaW5saW5lIiwKCQkidWktc2hhZG93LWljb24iIDogImljb25zaGFkb3ciLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41ICovCgkJInVpLW1pbmkiIDogIm1pbmkiCgl9LAoJZ2V0QXR0ckZpeGVkID0gZnVuY3Rpb24oKSB7CgkJdmFyIHJldCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCXJldHVybiAoIHJldCA9PSBudWxsID8gdW5kZWZpbmVkIDogcmV0ICk7Cgl9LAoJY2FwaXRhbExldHRlcnNSRSA9IC9bQS1aXS9nOwoKLy8gb3B0aW9uc1RvQ2xhc3NlczoKLy8gQG9wdGlvbnM6IEEgY29tcGxldGUgc2V0IG9mIG9wdGlvbnMgdG8gY29udmVydCB0byBjbGFzcyBuYW1lcy4KLy8gQGV4aXN0aW5nQ2xhc3NlczogZXh0cmEgY2xhc3NlcyB0byBhZGQgdG8gdGhlIHJlc3VsdAovLwovLyBDb252ZXJ0cyBAb3B0aW9ucyB0byBidXR0b25NYXJrdXAgY2xhc3NlcyBhbmQgcmV0dXJucyB0aGUgcmVzdWx0IGFzIGFuIGFycmF5Ci8vIHRoYXQgY2FuIGJlIGNvbnZlcnRlZCB0byBhbiBlbGVtZW50J3MgY2xhc3NOYW1lIHdpdGggLmpvaW4oICIgIiApLiBBbGwKLy8gcG9zc2libGUgb3B0aW9ucyBtdXN0IGJlIHNldCBpbnNpZGUgQG9wdGlvbnMuIFVzZSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cwovLyB0byBnZXQgYSBjb21wbGV0ZSBzZXQgYW5kIHVzZSAkLmV4dGVuZCB0byBvdmVycmlkZSB5b3VyIGNob2ljZSBvZiBvcHRpb25zCi8vIGZyb20gdGhhdCBzZXQuCmZ1bmN0aW9uIG9wdGlvbnNUb0NsYXNzZXMoIG9wdGlvbnMsIGV4aXN0aW5nQ2xhc3NlcyApIHsKCXZhciBjbGFzc2VzID0gZXhpc3RpbmdDbGFzc2VzID8gZXhpc3RpbmdDbGFzc2VzIDogW107CgoJLy8gQWRkIGNsYXNzZXMgdG8gdGhlIGFycmF5IC0gZmlyc3QgdWktYnRuCgljbGFzc2VzLnB1c2goICJ1aS1idG4iICk7CgoJLy8gSWYgdGhlcmUgaXMgYSB0aGVtZQoJaWYgKCBvcHRpb25zLnRoZW1lICkgewoJCWNsYXNzZXMucHVzaCggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJfQoKCS8vIElmIHRoZXJlJ3MgYW4gaWNvbiwgYWRkIHRoZSBpY29uLXJlbGF0ZWQgY2xhc3NlcwoJaWYgKCBvcHRpb25zLmljb24gKSB7CgkJY2xhc3NlcyA9IGNsYXNzZXMuY29uY2F0KFsKCQkJInVpLWljb24tIiArIG9wdGlvbnMuaWNvbiwKCQkJInVpLWJ0bi1pY29uLSIgKyBvcHRpb25zLmljb25wb3MKCQldKTsKCQlpZiAoIG9wdGlvbnMuaWNvbnNoYWRvdyApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktc2hhZG93LWljb24iICk7IC8qIFRPRE86IFJlbW92ZSBpbiAxLjUgKi8KCQl9Cgl9CgoJLy8gQWRkIHRoZSBhcHByb3ByaWF0ZSBjbGFzcyBmb3IgZWFjaCBib29sZWFuIG9wdGlvbgoJaWYgKCBvcHRpb25zLmlubGluZSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1idG4taW5saW5lIiApOwoJfQoJaWYgKCBvcHRpb25zLnNoYWRvdyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ciICk7Cgl9CglpZiAoIG9wdGlvbnMuY29ybmVycyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1jb3JuZXItYWxsIiApOwoJfQoJaWYgKCBvcHRpb25zLm1pbmkgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktbWluaSIgKTsKCX0KCgkvLyBDcmVhdGUgYSBzdHJpbmcgZnJvbSB0aGUgYXJyYXkgYW5kIHJldHVybiBpdAoJcmV0dXJuIGNsYXNzZXM7Cn0KCi8vIGNsYXNzTmFtZVRvT3B0aW9uczoKLy8gQGNsYXNzZXM6IEEgc3RyaW5nIGNvbnRhaW5pbmcgYSAuY2xhc3NOYW1lLXN0eWxlIHNwYWNlLXNlcGFyYXRlZCBjbGFzcyBsaXN0Ci8vCi8vIExvb3BzIG92ZXIgQGNsYXNzZXMgYW5kIGNhbGN1bGF0ZXMgYW4gb3B0aW9ucyBvYmplY3QgYmFzZWQgb24gdGhlCi8vIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgaXQgZmluZHMuIEl0IHJlY29yZHMgdW5yZWNvZ25pemVkIGNsYXNzZXMgaW4gYW4KLy8gYXJyYXkuCi8vCi8vIFJldHVybnM6IEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBmb2xsb3dpbmcgaXRlbXM6Ci8vCi8vICJvcHRpb25zIjogYnV0dG9uTWFya3VwIG9wdGlvbnMgZm91bmQgdG8gYmUgcHJlc2VudCBiZWNhdXNlIG9mIHRoZQovLyBwcmVzZW5jZS9hYnNlbmNlIG9mIGNvcnJlc3BvbmRpbmcgY2xhc3NlcwovLwovLyAidW5rbm93bkNsYXNzZXMiOiBhIHN0cmluZyBjb250YWluaW5nIGFsbCB0aGUgbm9uLWJ1dHRvbk1hcmt1cC1yZWxhdGVkCi8vIGNsYXNzZXMgZm91bmQgaW4gQGNsYXNzZXMKLy8KLy8gImFscmVhZHlFbmhhbmNlZCI6IEEgYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHVpLWJ0biBjbGFzcyB3YXMgYW1vbmcKLy8gdGhvc2UgZm91bmQgdG8gYmUgcHJlc2VudApmdW5jdGlvbiBjbGFzc05hbWVUb09wdGlvbnMoIGNsYXNzZXMgKSB7Cgl2YXIgaWR4LCBtYXAsIHVua25vd25DbGFzcywKCQlhbHJlYWR5RW5oYW5jZWQgPSBmYWxzZSwKCQlub0ljb24gPSB0cnVlLAoJCW8gPSB7CgkJCWljb246ICIiLAoJCQlpbmxpbmU6IGZhbHNlLAoJCQlzaGFkb3c6IGZhbHNlLAoJCQljb3JuZXJzOiBmYWxzZSwKCQkJaWNvbnNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IGZhbHNlCgkJfSwKCQl1bmtub3duQ2xhc3NlcyA9IFtdOwoKCWNsYXNzZXMgPSBjbGFzc2VzLnNwbGl0KCAiICIgKTsKCgkvLyBMb29wIG92ZXIgdGhlIGNsYXNzZXMKCWZvciAoIGlkeCA9IDAgOyBpZHggPCBjbGFzc2VzLmxlbmd0aCA7IGlkeCsrICkgewoKCQkvLyBBc3N1bWUgaXQncyBhbiB1bnJlY29nbml6ZWQgY2xhc3MKCQl1bmtub3duQ2xhc3MgPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgYm9vbGVhbiBvcHRpb25zIGZyb20gdGhlIHByZXNlbmNlIG9mIGNsYXNzZXMKCQltYXAgPSByZXZlcnNlQm9vbE9wdGlvbk1hcFsgY2xhc3Nlc1sgaWR4IF0gXTsKCQlpZiAoIG1hcCAhPT0gdW5kZWZpbmVkICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJb1sgbWFwIF0gPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgdGhlIHByZXNlbmNlIG9mIGFuIGljb24gYW5kIGVzdGFibGlzaCB0aGUgaWNvbiBwb3NpdGlvbgoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1idG4taWNvbi0iICkgPT09IDAgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlub0ljb24gPSBmYWxzZTsKCQkJby5pY29ucG9zID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCAxMiApOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggaWNvbiBpcyBwcmVzZW50CgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWljb24tIiApID09PSAwICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJby5pY29uID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA4ICk7CgoJCS8vIEVzdGFibGlzaCB0aGUgdGhlbWUgLSB0aGlzIHJlY29nbml6ZXMgb25lLWxldHRlciB0aGVtZSBzd2F0Y2ggbmFtZXMKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktYnRuLSIgKSA9PT0gMCAmJiBjbGFzc2VzWyBpZHggXS5sZW5ndGggPT09IDggKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvLnRoZW1lID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA3ICk7CgoJCS8vIFJlY29nbml6ZSB0aGF0IHRoaXMgZWxlbWVudCBoYXMgYWxyZWFkeSBiZWVuIGJ1dHRvbk1hcmt1cC1lbmhhbmNlZAoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdID09PSAidWktYnRuIiApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCWFscmVhZHlFbmhhbmNlZCA9IHRydWU7CgkJfQoKCQkvLyBJZiB0aGlzIGNsYXNzIGhhcyBub3QgYmVlbiByZWNvZ25pemVkLCBhZGQgaXQgdG8gdGhlIGxpc3QKCQlpZiAoIHVua25vd25DbGFzcyApIHsKCQkJdW5rbm93bkNsYXNzZXMucHVzaCggY2xhc3Nlc1sgaWR4IF0gKTsKCQl9Cgl9CgoJLy8gSWYgYSAidWktYnRuLWljb24tKiIgaWNvbiBwb3NpdGlvbiBjbGFzcyBpcyBhYnNlbnQgdGhlcmUgY2Fubm90IGJlIGFuIGljb24KCWlmICggbm9JY29uICkgewoJCW8uaWNvbiA9ICIiOwoJfQoKCXJldHVybiB7CgkJb3B0aW9uczogbywKCQl1bmtub3duQ2xhc3NlczogdW5rbm93bkNsYXNzZXMsCgkJYWxyZWFkeUVuaGFuY2VkOiBhbHJlYWR5RW5oYW5jZWQKCX07Cn0KCmZ1bmN0aW9uIGNhbWVsQ2FzZTJIeXBoZW5hdGVkKCBjICkgewoJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKfQoKLy8gJC5mbi5idXR0b25NYXJrdXA6Ci8vIERPTTogZ2V0cy9zZXRzIC5jbGFzc05hbWUKLy8KLy8gQG9wdGlvbnM6IG9wdGlvbnMgdG8gYXBwbHkgdG8gdGhlIGVsZW1lbnRzIGluIHRoZSBqUXVlcnkgb2JqZWN0Ci8vIEBvdmVyd3JpdGVDbGFzc2VzOiBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0byBob25vdXIgZXhpc3RpbmcgY2xhc3NlcwovLwovLyBDYWxjdWxhdGVzIHRoZSBjbGFzc2VzIHRvIGFwcGx5IHRvIHRoZSBlbGVtZW50cyBpbiB0aGUgalF1ZXJ5IG9iamVjdCBiYXNlZCBvbgovLyB0aGUgb3B0aW9ucyBwYXNzZWQgaW4uIElmIEBvdmVyd3JpdGVDbGFzc2VzIGlzIHRydWUsIGl0IHNldHMgdGhlIGNsYXNzTmFtZQovLyBwcm9wZXJ0eSBvZiBlYWNoIGVsZW1lbnQgaW4gdGhlIGpRdWVyeSBvYmplY3QgdG8gdGhlIGJ1dHRvbk1hcmt1cCBjbGFzc2VzCi8vIGl0IGNhbGN1bGF0ZXMgYmFzZWQgb24gdGhlIG9wdGlvbnMgcGFzc2VkIGluLgovLwovLyBJZiB5b3Ugd2lzaCB0byBwcmVzZXJ2ZSBhbnkgY2xhc3NlcyB0aGF0IGFyZSBhbHJlYWR5IHByZXNlbnQgb24gdGhlIGVsZW1lbnRzCi8vIGluc2lkZSB0aGUgalF1ZXJ5IG9iamVjdCwgaW5jbHVkaW5nIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgdGhhdCB3ZXJlCi8vIGFkZGVkIGJ5IGEgcHJldmlvdXMgY2FsbCB0byAkLmZuLmJ1dHRvbk1hcmt1cCgpIG9yIGR1cmluZyBwYWdlIGVuaGFuY2VtZW50Ci8vIHRoZW4geW91IHNob3VsZCBvbWl0IEBvdmVyd3JpdGVDbGFzc2VzIG9yIHNldCBpdCB0byBmYWxzZS4KJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucywgb3ZlcndyaXRlQ2xhc3NlcyApIHsKCXZhciBpZHgsIGRhdGEsIGVsLCByZXRyaWV2ZWRPcHRpb25zLCBvcHRpb25LZXksCgkJZGVmYXVsdHMgPSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0czsKCglmb3IgKCBpZHggPSAwIDsgaWR4IDwgdGhpcy5sZW5ndGggOyBpZHgrKyApIHsKCQllbCA9IHRoaXNbIGlkeCBdOwoJCWRhdGEgPSBvdmVyd3JpdGVDbGFzc2VzID8KCgkJCS8vIEFzc3VtZSB0aGlzIGVsZW1lbnQgaXMgbm90IGVuaGFuY2VkIGFuZCBpZ25vcmUgaXRzIGNsYXNzZXMKCQkJeyBhbHJlYWR5RW5oYW5jZWQ6IGZhbHNlLCB1bmtub3duQ2xhc3NlczogW10gfSA6CgoJCQkvLyBPdGhlcndpc2UgYW5hbHl6ZSBleGlzdGluZyBjbGFzc2VzIHRvIGVzdGFibGlzaCBleGlzdGluZyBvcHRpb25zIGFuZAoJCQkvLyBjbGFzc2VzCgkJCWNsYXNzTmFtZVRvT3B0aW9ucyggZWwuY2xhc3NOYW1lICk7CgoJCXJldHJpZXZlZE9wdGlvbnMgPSAkLmV4dGVuZCgge30sCgoJCQkvLyBJZiB0aGUgZWxlbWVudCBhbHJlYWR5IGhhcyB0aGUgY2xhc3MgdWktYnRuLCB0aGVuIHdlIGFzc3VtZSB0aGF0CgkJCS8vIGl0IGhhcyBwYXNzZWQgdGhyb3VnaCBidXR0b25NYXJrdXAgYmVmb3JlIC0gb3RoZXJ3aXNlLCB0aGUgb3B0aW9ucwoJCQkvLyByZXR1cm5lZCBieSBjbGFzc05hbWVUb09wdGlvbnMgZG8gbm90IGNvcnJlY3RseSByZWZsZWN0IHRoZSBzdGF0ZSBvZgoJCQkvLyB0aGUgZWxlbWVudAoJCQkoIGRhdGEuYWxyZWFkeUVuaGFuY2VkID8gZGF0YS5vcHRpb25zIDoge30gKSwKCgkJCS8vIEZpbmFsbHksIGFwcGx5IHRoZSBvcHRpb25zIHBhc3NlZCBpbgoJCQlvcHRpb25zICk7CgoJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IGNhbGwgb24gdGhpcyBlbGVtZW50LCByZXRyaWV2ZSByZW1haW5pbmcgb3B0aW9ucwoJCS8vIGZyb20gdGhlIGRhdGEtYXR0cmlidXRlcwoJCWlmICggIWRhdGEuYWxyZWFkeUVuaGFuY2VkICkgewoJCQlmb3IgKCBvcHRpb25LZXkgaW4gZGVmYXVsdHMgKSB7CgkJCQlpZiAoIHJldHJpZXZlZE9wdGlvbnNbIG9wdGlvbktleSBdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0cmlldmVkT3B0aW9uc1sgb3B0aW9uS2V5IF0gPSBnZXRBdHRyRml4ZWQoIGVsLAoJCQkJCQlvcHRpb25LZXkucmVwbGFjZSggY2FwaXRhbExldHRlcnNSRSwgY2FtZWxDYXNlMkh5cGhlbmF0ZWQgKQoJCQkJCSk7CgkJCQl9CgkJCX0KCQl9CgoJCWVsLmNsYXNzTmFtZSA9IG9wdGlvbnNUb0NsYXNzZXMoCgoJCQkvLyBNZXJnZSBhbGwgdGhlIG9wdGlvbnMgYW5kIGFwcGx5IHRoZW0gYXMgY2xhc3NlcwoJCQkkLmV4dGVuZCgge30sCgoJCQkJLy8gVGhlIGRlZmF1bHRzIGZvcm0gdGhlIGJhc2lzCgkJCQlkZWZhdWx0cywKCgkJCQkvLyBBZGQgdGhlIGNvbXB1dGVkIG9wdGlvbnMKCQkJCXJldHJpZXZlZE9wdGlvbnMKCQkJKSwKCgkJCS8vIC4uLiBhbmQgcmUtYXBwbHkgYW55IHVucmVjb2duaXplZCBjbGFzc2VzIHRoYXQgd2VyZSBmb3VuZAoJCQlkYXRhLnVua25vd25DbGFzc2VzICkuam9pbiggIiAiICk7CgkJaWYgKCBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJidXR0b24iICkgewoJCQllbC5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImJ1dHRvbiIgKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovLyBidXR0b25NYXJrdXAgZGVmYXVsdHMuIFRoaXMgbXVzdCBiZSBhIGNvbXBsZXRlIHNldCwgaS5lLiwgYSB2YWx1ZSBtdXN0IGJlCi8vIGdpdmVuIGhlcmUgZm9yIGFsbCByZWNvZ25pemVkIG9wdGlvbnMKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7CglpY29uOiAiIiwKCWljb25wb3M6ICJsZWZ0IiwKCXRoZW1lOiBudWxsLAoJaW5saW5lOiBmYWxzZSwKCXNoYWRvdzogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCglpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogUmVtb3ZlIGluIDEuNS4gT3B0aW9uIGRlcHJlY2F0ZWQgaW4gMS40LiAqLwoJbWluaTogZmFsc2UKfTsKCiQuZXh0ZW5kKCAkLmZuLmJ1dHRvbk1hcmt1cCwgewoJaW5pdFNlbGVjdG9yOiAiYTpqcW1EYXRhKHJvbGU9J2J1dHRvbicpLCAudWktYmFyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSwgYnV0dG9uIgp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbnRyb2xncm91cCIsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJZW5oYW5jZWQ6IGZhbHNlLAoJCXRoZW1lOiBudWxsLAoJCXNoYWRvdzogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCXR5cGU6ICJ2ZXJ0aWNhbCIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFJ1biBidXR0b25tYXJrdXAKCQlpZiAoICQuZm4uYnV0dG9uTWFya3VwICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkuYnV0dG9uTWFya3VwKCk7CgkJfQoJCS8vIEVuaGFuY2UgY2hpbGQgd2lkZ2V0cwoJCSQuZWFjaCggdGhpcy5fY2hpbGRXaWRnZXRzLCAkLnByb3h5KCBmdW5jdGlvbiggbnVtYmVyLCB3aWRnZXROYW1lICkgewoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXROYW1lIF0gKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGVbIHdpZGdldE5hbWUgXS5pbml0U2VsZWN0b3IgKS5ub3QoICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvcigpIClbIHdpZGdldE5hbWUgXSgpOwoJCQl9CgkJfSwgdGhpcyApKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3VpOiBudWxsLAoJCQlfaW5pdGlhbFJlZnJlc2g6IHRydWUKCQl9KTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl91aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKS5jaGlsZHJlbigpLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgl9LAoKCV9jaGlsZFdpZGdldHM6IFsgImNoZWNrYm94cmFkaW8iLCAic2VsZWN0bWVudSIsICJidXR0b24iIF0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICJ1aS1ncm91cC10aGVtZS0iICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdWkgPSB7CgkJCQlncm91cExlZ2VuZDogZWxlbS5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJCWNoaWxkV3JhcHBlcjogZWxlbQoJCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCQkJInVpLWNvbnRyb2xncm91cC0iICsKCQkJCQkJCSggb3B0cy50eXBlID09PSAiaG9yaXpvbnRhbCIgPyAiaG9yaXpvbnRhbCIgOiAidmVydGljYWwiICkgKyAiICIgKwoJCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICsgIiAiICsKCQkJCQkJKCBvcHRzLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSArCgkJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKQoJCQkJCS53cmFwSW5uZXIoICI8ZGl2ICIgKwoJCQkJCQkiY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyAiICsKCQkJCQkJCSggb3B0cy5zaGFkb3cgPT09IHRydWUgPyAidWktc2hhZG93IiA6ICIiICkgKyAiJz48L2Rpdj4iICkKCQkJCQkuY2hpbGRyZW4oKQoJCQl9OwoKCQlpZiAoIHVpLmdyb3VwTGVnZW5kLmxlbmd0aCA+IDAgKSB7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPjwvZGl2PiIgKQoJCQkJLmFwcGVuZCggdWkuZ3JvdXBMZWdlbmQgKQoJCQkJLnByZXBlbmRUbyggZWxlbSApOwoJCX0KCgkJcmV0dXJuIHVpOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2FsbFJlZnJlc2gsIHJldHVyblZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50OwoKCQkvLyBNdXN0IGhhdmUgb25lIG9mIGhvcml6b250YWwgb3IgdmVydGljYWwKCQlpZiAoIG9wdGlvbnMudHlwZSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwiICkKCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC0iICsgKCBvcHRpb25zLnR5cGUgPT09ICJob3Jpem9udGFsIiA/ICJob3Jpem9udGFsIiA6ICJ2ZXJ0aWNhbCIgKSApOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0aW9ucy50aGVtZSApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fdWkuY2hpbGRXcmFwcGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID0gb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlyZXR1cm5WYWx1ZSA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggY2FsbFJlZnJlc2ggKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfSwKCgljb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl91aS5jaGlsZFdyYXBwZXI7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmNvbnRhaW5lcigpLAoJCQllbHMgPSAkZWwuZmluZCggIi51aS1idG4iICkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICksCgkJCWNyZWF0ZSA9IHRoaXMuX2luaXRpYWxSZWZyZXNoOwoJCWlmICggJC5tb2JpbGUuY2hlY2tib3hyYWRpbyApIHsKCQkJJGVsLmZpbmQoICI6bW9iaWxlLWNoZWNrYm94cmFkaW8iICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfQoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGVscywKCQkJdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPyB0aGlzLl9nZXRWaXNpYmxlcyggZWxzLCBjcmVhdGUgKSA6IGVscywKCQkJY3JlYXRlICk7CgkJdGhpcy5faW5pdGlhbFJlZnJlc2ggPSBmYWxzZTsKCX0sCgoJLy8gQ2F2ZWF0OiBJZiB0aGUgbGVnZW5kIGlzIG5vdCB0aGUgZmlyc3QgY2hpbGQgb2YgdGhlIGNvbnRyb2xncm91cCBhdCBlbmhhbmNlCgkvLyB0aW1lLCBpdCB3aWxsIGJlIGFmdGVyIF9kZXN0cm95KCkuCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHVpLCBidXR0b25zLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdWkgPSB0aGlzLl91aTsKCQlidXR0b25zID0gdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCSJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwgdWktY29ybmVyLWFsbCB1aS1taW5pICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oIG9wdHMudGhlbWUgKSApCgkJCS5maW5kKCAiLnVpLWJ0biIgKQoJCQkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICk7CgoJCXRoaXMuX3JlbW92ZUZpcnN0TGFzdENsYXNzZXMoIGJ1dHRvbnMgKTsKCgkJdWkuZ3JvdXBMZWdlbmQudW53cmFwKCk7CgkJdWkuY2hpbGRXcmFwcGVyLmNoaWxkcmVuKCkudW53cmFwKCk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdoZWFkZXInKSIsCgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCWFkZEJhY2tCdG46IGZhbHNlLAoJCQliYWNrQnRuVGhlbWU6IG51bGwsCgkJCWJhY2tCdG5UZXh0OiAiQmFjayIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIGxlZnRidG4sIHJpZ2h0YnRuLAoJCQkJcm9sZSA9ICB0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJCXBhZ2UgPSBmYWxzZTsKCQkJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCQkJInBhZ2VzaG93IjogInJlZnJlc2giCgkJCQl9KTsKCQkJfQoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJcm9sZTogcm9sZSwKCQkJCXBhZ2U6IHBhZ2UsCgkJCQlsZWZ0YnRuOiBsZWZ0YnRuLAoJCQkJcmlnaHRidG46IHJpZ2h0YnRuCgkJCX0pOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIG8uYWRkQmFja0J0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWRkQmFja0J0biAmJgoJCQkJCXRoaXMucm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJCXRoaXMucGFnZVsgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJCSF0aGlzLmxlZnRidG4gKSB7CgkJCQkJCXRoaXMuX2FkZEJhY2tCdXR0b24oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biIgKS5yZW1vdmUoKTsKCQkJCX0KCQkJfQoJCQlpZiAoIG8uYmFja0J0blRoZW1lICE9IG51bGwgKSB7CgkJCQl0aGlzLmVsZW1lbnQKCQkJCQkuZmluZCggIi51aS10b29sYmFyLWJhY2stYnRuIiApCgkJCQkJLmFkZENsYXNzKCAidWktYnRuIHVpLWJ0bi0iICsgby5iYWNrQnRuVGhlbWUgKTsKCQkJfQoJCQlpZiAoIG8uYmFja0J0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4gLnVpLWJ0bi10ZXh0IiApLnRleHQoIG8uYmFja0J0blRleHQgKTsKCQkJfQoJCQlpZiAoIG8udGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXZhciBjdXJyZW50VGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQkJbmV3VGhlbWUgPSBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IjsKCgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggbyApOwoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5yb2xlID09PSAiaGVhZGVyIiApIHsKCQkJCXRoaXMuX2FkZEhlYWRlckJ1dHRvbkNsYXNzZXMoKTsKCQkJfQoJCQlpZiAoICF0aGlzLnBhZ2UgKSB7CgkJCQl0aGlzLl9zZXRSZWxhdGl2ZSgpOwoJCQkJaWYgKCB0aGlzLnJvbGUgPT09ICJmb290ZXIiICkgewoJCQkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggImJvZHkiICk7CgkJCQl9CgkJCX0KCQkJdGhpcy5fYWRkSGVhZGluZ0NsYXNzZXMoKTsKCQkJdGhpcy5fYnRuTWFya3VwKCk7CgkJfSwKCgkJLy93ZSBvbmx5IHdhbnQgdGhpcyB0byBydW4gb24gbm9uIGZpeGVkIHRvb2xiYXJzIHNvIG1ha2UgaXQgZWFzeSB0byBvdmVycmlkZQoJCV9zZXRSZWxhdGl2ZTogZnVuY3Rpb24oKSB7CgkJCSQoICJbZGF0YS0iKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJ10iICkuY3NzKHsgInBvc2l0aW9uIjogInJlbGF0aXZlIiB9KTsKCQl9LAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNC4gQXMgZnJvbSAxLjUgYnV0dG9uIGNsYXNzZXMgaGF2ZSB0byBiZSBwcmVzZW50IGluIHRoZSBtYXJrdXAuCgkJX2J0bk1hcmt1cDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLmNoaWxkcmVuKCAiYSIgKQoJCQkJLmZpbHRlciggIjpub3QoW2RhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J25vbmUnXSkiICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsICJidXR0b24iICk7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiY3JlYXRlIiApOwoJCX0sCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEFzIGZyb20gMS41IHVpLWJ0bi1sZWZ0L3JpZ2h0IGNsYXNzZXMgaGF2ZSB0byBiZSBwcmVzZW50IGluIHRoZSBtYXJrdXAuCgkJX2FkZEhlYWRlckJ1dHRvbkNsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGhlYWRlcmFuY2hvcnMgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJhLCBidXR0b24iICk7CgkJCXRoaXMubGVmdGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICk7CgkJCXRoaXMucmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCXRoaXMubGVmdGJ0biA9IHRoaXMubGVmdGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKS5sZW5ndGg7CgoJCQl0aGlzLnJpZ2h0YnRuID0gdGhpcy5yaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCgkJfSwKCQlfYWRkQmFja0J1dHRvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQkJdGhlbWUgPSBvcHRpb25zLmJhY2tCdG5UaGVtZSB8fCBvcHRpb25zLnRoZW1lOwoKCQkJJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgIiArCgkJCQkiY2xhc3M9J3VpLWJ0biB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyB1aS1idG4tbGVmdCAiICsKCQkJCQkoIHRoZW1lID8gInVpLWJ0bi0iICsgdGhlbWUgKyAiICIgOiAiIiApICsKCQkJCQkidWktdG9vbGJhci1iYWNrLWJ0biB1aS1pY29uLWNhcmF0LWwgdWktYnRuLWljb24tbGVmdCcgIiArCgkJCQkiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsPSdiYWNrJz4iICsgb3B0aW9ucy5iYWNrQnRuVGV4dCArICI8L2E+IiApCgkJCQkJLnByZXBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgkJfSwKCQlfYWRkSGVhZGluZ0NsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJoZWFkaW5nIiwKCQkJCQkiYXJpYS1sZXZlbCI6ICIxIgoJCQkJfSk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgJC5tb2JpbGUudG9vbGJhciwgewoJCW9wdGlvbnM6IHsKCQkJcG9zaXRpb246bnVsbCwKCQkJdmlzaWJsZU9uUGFnZVNob3c6IHRydWUsCgkJCWRpc2FibGVQYWdlWm9vbTogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogInNsaWRlIiwgLy9jYW4gYmUgbm9uZSwgZmFkZSwgc2xpZGUgKHNsaWRlIG1hcHMgdG8gc2xpZGV1cCBvciBzbGlkZWRvd24pCgkJCWZ1bGxzY3JlZW46IGZhbHNlLAoJCQl0YXBUb2dnbGU6IHRydWUsCgkJCXRhcFRvZ2dsZUJsYWNrbGlzdDogImEsIGJ1dHRvbiwgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIC51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQsIC51aS1mbGlwc3dpdGNoLCAudWktcG9wdXAsIC51aS1wYW5lbCwgLnVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCWhpZGVEdXJpbmdGb2N1czogImlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0IiwKCQkJdXBkYXRlUGFnZVBhZGRpbmc6IHRydWUsCgkJCXRyYWNrUGVyc2lzdGVudFRvb2xiYXJzOiB0cnVlLAoKCQkJLy8gQnJvd3NlciBkZXRlY3Rpb24hIFdlZWVlLCBoZXJlIHdlIGdvLi4uCgkJCS8vIFVuZm9ydHVuYXRlbHksIHBvc2l0aW9uOmZpeGVkIGlzIGNvc3RseSwgbm90IHRvIG1lbnRpb24gcHJvYmFibHkgaW1wb3NzaWJsZSwgdG8gZmVhdHVyZS1kZXRlY3QgYWNjdXJhdGVseS4KCQkJLy8gU29tZSB0ZXN0cyBleGlzdCwgYnV0IHRoZXkgY3VycmVudGx5IHJldHVybiBmYWxzZSByZXN1bHRzIGluIGNyaXRpY2FsIGRldmljZXMgYW5kIGJyb3dzZXJzLCB3aGljaCBjb3VsZCBsZWFkIHRvIGEgYnJva2VuIGV4cGVyaWVuY2UuCgkJCS8vIFRlc3RpbmcgZml4ZWQgcG9zaXRpb25pbmcgaXMgYWxzbyBwcmV0dHkgb2J0cnVzaXZlIHRvIHBhZ2UgbG9hZCwgcmVxdWlyaW5nIGluamVjdGVkIGVsZW1lbnRzIGFuZCBzY3JvbGxpbmcgdGhlIHdpbmRvdwoJCQkvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIHNlcnZlcyB0byBydWxlIG91dCBzb21lIHBvcHVsYXIgYnJvd3NlcnMgd2l0aCBrbm93biBmaXhlZC1wb3NpdGlvbmluZyBpc3N1ZXMKCQkJLy8gVGhpcyBpcyBhIHBsdWdpbiBvcHRpb24gbGlrZSBhbnkgb3RoZXIsIHNvIGZlZWwgZnJlZSB0byBpbXByb3ZlIG9yIG92ZXJ3cml0ZSBpdAoJCQlzdXBwb3J0QmxhY2tsaXN0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhJC5zdXBwb3J0LmZpeGVkUG9zaXRpb247CgkJCX0KCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMucG9zaXRpb24gPT09ICJmaXhlZCIgJiYgIXRoaXMub3B0aW9ucy5zdXBwb3J0QmxhY2tsaXN0KCkgKSB7CgkJCQl0aGlzLl9tYWtlRml4ZWQoKTsKCQkJfQoJCX0sCgoJCV9tYWtlRml4ZWQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS0iKyB0aGlzLnJvbGUgKyItZml4ZWQiICk7CgkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoKTsKCQkJdGhpcy5fYWRkVHJhbnNpdGlvbkNsYXNzKCk7CgkJCXRoaXMuX2JpbmRQYWdlRXZlbnRzKCk7CgkJCXRoaXMuX2JpbmRUb2dnbGVIYW5kbGVycygpOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApIHsKCQkJaWYgKCBvLnBvc2l0aW9uID09PSAiZml4ZWQiICYmIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJCWlmICggdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAiZml4ZWQiICYmICF0aGlzLm9wdGlvbnMuc3VwcG9ydEJsYWNrbGlzdCgpICkgewoJCQkJdmFyICRwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICggJCgiLnVpLXBhZ2UtYWN0aXZlIikubGVuZ3RoID4gMCApPyAkKCIudWktcGFnZS1hY3RpdmUiKTogJCgiLnVpLXBhZ2UiKS5lcSgwKTsKCgkJCQlpZiAoIG8uZnVsbHNjcmVlbiAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSArICItZnVsbHNjcmVlbiIgKTsKCQkJCQl9CgkJCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJCQllbHNlIHsKCQkJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkJCSRwYWdlLnJlbW92ZUNsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlICsgIi1mdWxsc2NyZWVuIiApLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlKyAiLWZpeGVkIiApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zdXBlcihvKTsKCQl9LAoKCQlfYWRkVHJhbnNpdGlvbkNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYgKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKSB7CgkJCQkvLyB1c2UgYXBwcm9wcmlhdGUgc2xpZGUgZm9yIGhlYWRlciBvciBmb290ZXIKCQkJCWlmICggdGNsYXNzID09PSAic2xpZGUiICkgewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5oYXNDbGFzcyggInVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTogdGhpcy5kb2N1bWVudDsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHBhZ2UgLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJdGhpcy5oaWRlKCB0cnVlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlQW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VTaG93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICIudWktcGFnZS1hY3RpdmUiICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAidXBkYXRlUGFnZVBhZGRpbmciIH0gKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oIGUsIHVpICkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJCXRoaXNGb290ZXIsIHRoaXNIZWFkZXIsIG5leHRGb290ZXIsIG5leHRIZWFkZXI7CgoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vZmYoIHRoaXMud2luZG93LCAidGhyb3R0bGVkcmVzaXplIiApOwoJCQl9CgoJCQlpZiAoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKSB7CgkJCQl0aGlzRm9vdGVyID0gJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLnBhZ2UgKTsKCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMucGFnZSApOwoJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gKCB0aGlzLnJvbGUgPT09ImhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCQkJLy8gdGJQYWdlIGFyZ3VtZW50IGNhbiBiZSBhIFBhZ2Ugb2JqZWN0IG9yIGFuIGV2ZW50LCBpZiBjb21pbmcgZnJvbSB0aHJvdHRsZWQgcmVzaXplLgoJCQl0YlBhZ2UgPSAoIHRiUGFnZSAmJiB0YlBhZ2UudHlwZSA9PT0gdW5kZWZpbmVkICYmIHRiUGFnZSApIHx8IHRoaXMucGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQl0YlBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSI7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSArIHBvcyApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9IHRoaXMud2luZG93LAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICggISF0aGlzLnBhZ2UgKT8gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5oZWlnaHQoKTokKCIudWktcGFnZS1hY3RpdmUiKS5oZWlnaHQoKSwKCQkJCXZpZXdwb3J0SGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlyZXR1cm4gIW5vdHJhbnNpdGlvbiAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAmJiB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAhPT0gIm5vbmUiICYmCgkJCQkoCgkJCQkJKCB0aGlzLnJvbGUgPT09ICJoZWFkZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgPiBlbEhlaWdodCApIHx8CgkJCQkJKCB0aGlzLnJvbGUgPT09ICJmb290ZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgKyB2aWV3cG9ydEhlaWdodCA8IHBIZWlnaHQgLSBlbEhlaWdodCApCgkJCQkpIHx8IHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuCgkJCQkpOwoJCX0sCgoJCXNob3c6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24gKCkgewoJCQkJCQkkZWwucmVtb3ZlQ2xhc3MoICJpbiIgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5yZW1vdmVDbGFzcyggaGlkZUNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IHRydWU7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLmFkZENsYXNzKCBvdXRjbGFzcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSBmYWxzZTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCWRlbGF5U2hvdywgZGVsYXlIaWRlLAoJCQkJaXNWaXNpYmxlID0gdHJ1ZSwKCQkJCXBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogJCgiLnVpLXBhZ2UiKTsKCgkJCS8vIHRhcCB0b2dnbGUKCQkJcGFnZQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJCQlpZiAoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICkgewoJCQkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImZvY3VzaW4gZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkvL3RoaXMgaGlkZXMgdGhlIHRvb2xiYXJzIG9uIGEga2V5Ym9hcmQgcG9wIHRvIGdpdmUgbW9yZSBzY3JlZW4gcm9vbSBhbmQgcHJldmVudCBpb3MgYnVnIHdoaWNoCgkJCQkJLy9wb3NpdGlvbnMgZml4ZWQgdG9vbGJhcnMgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuIG9uIHBvcCBpZiB0aGUgaW5wdXQgaXMgbmVhciB0aGUgdG9wIG9yCgkJCQkJLy9ib3R0b20gb2YgdGhlIHNjcmVlbiBhZGRyZXNzZXMgaXNzdWVzICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCS8vYW5kIGlzc3VlICM0MTEzIEhlYWRlciBhbmQgZm9vdGVyIGNoYW5nZSB0aGVpciBwb3NpdGlvbiBhZnRlciBrZXlib2FyZCBwb3B1cCAtIGlPUwoJCQkJCS8vYW5kIGlzc3VlICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgMTAyNSAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApIHsKCQkJCQkJLy9GaXggZm9yIGlzc3VlICM0NzI0IE1vdmluZyB0aHJvdWdoIGZvcm0gaW4gTW9iaWxlIFNhZmFyaSB3aXRoICJOZXh0IiBhbmQgIlByZXZpb3VzIiBzeXN0ZW0KCQkJCQkJLy9jb250cm9scyBjYXVzZXMgZml4ZWQgcG9zaXRpb24sIHRhcC10b2dnbGUgZmFsc2UgSGVhZGVyIHRvIHJldmVhbCBpdHNlbGYKCQkJCQkJLy8gaXNWaXNpYmxlIGluc3RlYWQgb2Ygc2VsZi5fdmlzaWJsZSBiZWNhdXNlIHRoZSBmb2N1c2luIGFuZCBmb2N1c291dCBldmVudHMgZmlyZSB0d2ljZSBhdCB0aGUgc2FtZSB0aW1lCgkJCQkJCS8vIEFsc28gdXNlIGEgZGVsYXkgZm9yIGhpZGluZyB0aGUgdG9vbGJhcnMgYmVjYXVzZSBvbiBBbmRyb2lkIG5hdGl2ZSBicm93c2VyIGZvY3VzaW4gaXMgZGlyZWNsdHkgZm9sbG93ZWQKCQkJCQkJLy8gYnkgYSBmb2N1c291dCB3aGVuIGEgbmF0aXZlIHNlbGVjdHMgb3BlbnMgYW5kIHRoZSBvdGhlciB3YXkgYXJvdW5kIHdoZW4gaXQgY2xvc2VzLgoJCQkJCQlpZiAoIGUudHlwZSA9PT0gImZvY3Vzb3V0IiAmJiAhaXNWaXNpYmxlICkgewoJCQkJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCQkJCQkJCS8vd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBhbmQgc2VlIGlmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQKCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlIaWRlICk7CgkJCQkJCQlkZWxheVNob3cgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLnNob3coKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfSBlbHNlIGlmICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgISFpc1Zpc2libGUgKSB7CgkJCQkJCQkvL2lmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQgY2xlYXIgdGhlIHRpbWUgb3V0IHRvIGNhbmNlbCB0aGUgc2hvdy4KCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlTaG93ICk7CgkJCQkJCQlpc1Zpc2libGUgPSBmYWxzZTsKCQkJCQkJCWRlbGF5SGlkZSA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuaGlkZSgpOwoJCQkJCQkJfSwgMCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX3NldFJlbGF0aXZlOiBmdW5jdGlvbigpIHsKCQkJaWYoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApewoJCQkJJCggIltkYXRhLSIrICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnXSIgKS5jc3MoeyAicG9zaXRpb24iOiAicmVsYXRpdmUiIH0pOwoJCQl9CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmhhc0NsYXNzKCAidWktaGVhZGVyIiApOwoKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgIiIgKTsKCQkJJGVsLnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCAkLm1vYmlsZS50b29sYmFyLCB7CgoJCV9tYWtlRml4ZWQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl93b3JrYXJvdW5kcygpOwoJCX0sCgoJCS8vY2hlY2sgdGhlIGJyb3dzZXIgYW5kIHZlcnNpb24gYW5kIHJ1biBuZWVkZWQgd29ya2Fyb3VuZHMKCQlfd29ya2Fyb3VuZHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQlvcyA9IG51bGwsCgkJCXNlbGYgPSB0aGlzOwoJCQkvL3NldCB0aGUgb3Mgd2UgYXJlIHdvcmtpbmcgaW4gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQlpZiAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgewoJCQkJb3MgPSAiaW9zIjsKCQkJfSBlbHNlIGlmICggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSApIHsKCQkJCW9zID0gImFuZHJvaWQiOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vY2hlY2sgb3MgdmVyc2lvbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCWlmICggb3MgPT09ICJpb3MiICkgewoJCQkJLy9pT1MgIHdvcmthcm91bmRzCgkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQl9IGVsc2UgaWYgKCBvcyA9PT0gImFuZHJvaWQiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB7CgkJCQkvL0FuZHJvaWQgMi4zIHJ1biBhbGwgQW5kcm9pZCAyLjMgd29ya2Fyb3VuZAoJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJCXNlbGYuX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kKCk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9LAoKCQkvL1V0aWxpdHkgY2xhc3MgZm9yIGNoZWNraW5nIGhlYWRlciBhbmQgZm9vdGVyIHBvc2l0aW9ucyByZWxhdGl2ZSB0byB2aWV3cG9ydAoJCV92aWV3cG9ydE9mZnNldDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICksCgkJCQlvZmZzZXQgPSBNYXRoLmFicyggJGVsLm9mZnNldCgpLnRvcCAtIHRoaXMud2luZG93LnNjcm9sbFRvcCgpICk7CgkJCWlmICggIWhlYWRlciApIHsKCQkJCW9mZnNldCA9IE1hdGgucm91bmQoIG9mZnNldCAtIHRoaXMud2luZG93LmhlaWdodCgpICsgJGVsLm91dGVySGVpZ2h0KCkgKSAtIDYwOwoJCQl9CgkJCXJldHVybiBvZmZzZXQ7CgkJfSwKCgkJLy9iaW5kIGV2ZW50cyBmb3IgX3RyaWdnZXJSZWRyYXcoKSBmdW5jdGlvbgoJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy9iaW5kIHRvIHNjcm9sbHN0b3AgYW5kIGNoZWNrIGlmIHRoZSB0b29sYmFycyBhcmUgY29ycmVjdGx5IHBvc2l0aW9uZWQKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7IHNjcm9sbHN0b3A6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHZpZXdwb3J0T2Zmc2V0ID0gc2VsZi5fdmlld3BvcnRPZmZzZXQoKTsKCQkJCS8vY2hlY2sgaWYgdGhlIGhlYWRlciBpcyB2aXNpYmxlIGFuZCBpZiBpdHMgaW4gdGhlIHJpZ2h0IHBsYWNlCgkJCQlpZiAoIHZpZXdwb3J0T2Zmc2V0ID4gMiAmJiBzZWxmLl92aXNpYmxlICkgewoJCQkJCXNlbGYuX3RyaWdnZXJSZWRyYXcoKTsKCQkJCX0KCQkJfX0pOwoJCX0sCgoJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWUgIzQyNTAgUGVyc2lzdGVudCBmb290ZXIgaW5zdGFiaWxpdHkgaW4gdjEuMSB3aXRoIGxvbmcgc2VsZWN0IGxpc3RzIGluIEFuZHJvaWQgMi4zLjMKCQkvL2FuZCBpc3N1ZSAjMzc0OCBBbmRyb2lkIDIueDogUGFnZSB0cmFuc2l0aW9ucyBicm9rZW4gd2hlbiBmaXhlZCB0b29sYmFycyB1c2VkCgkJLy90aGUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHRodW1ibmFpbCBpbiBhIGxpc3QgdmlldyBjYXVzZXMgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbiBidXR0b25zIGFib3ZlIGluIGEgbmF2IGJhcgoJCS8vc2V0dGluZyB0aGUgbGkncyB0byAtd2Via2l0LXRyYW5zZm9ybTp0cmFuc2xhdGUzZCgwLDAsMCk7IHNvbHZlcyB0aGlzIHByb2JsZW0gdG8gYXZvaWRlIHBvdGVudGlhbCBpc3N1ZXMgaW4gb3RoZXIKCQkvL3BsYXRmb3JtcyB3ZSBzY29wZSB0aGlzIHdpdGggdGhlIGNsYXNzIHVpLWFuZHJvaWQtMngtZml4CgkJX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKS5hZGRDbGFzcyggInVpLWFuZHJvaWQtMngtZml4ZWQiICk7CgkJfSwKCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlcyAjNDMzNyBGaXhlZCBoZWFkZXIgcHJvYmxlbSBhZnRlciBzY3JvbGxpbmcgY29udGVudCBvbiBpT1MgYW5kIEFuZHJvaWQKCQkvL2FuZCBkZXZpY2UgYnVncyBwcm9qZWN0IGlzc3VlICMxIEZvcm0gZWxlbWVudHMgY2FuIGxvc2UgY2xpY2sgaGl0IGFyZWEgaW4gcG9zaXRpb246IGZpeGVkIGNvbnRhaW5lcnMuCgkJLy90aGlzIGFsc28gYWRkcmVzc2VzIG5vdCBvbiBmaXhlZCB0b29sYmFycyBwYWdlIGluIGRvY3MKCQkvL2FkZGluZyAxcHggb2YgcGFkZGluZyB0byB0aGUgYm90dG9tIHRoZW4gcmVtb3ZpbmcgaXQgY2F1c2VzIGEgInJlZHJhdyIKCQkvL3doaWNoIHBvc2l0aW9ucyB0aGUgdG9vbGJhcnMgY29ycmVjdGx5ICh0aGV5IHdpbGwgYWx3YXlzIGJlIHZpc3VhbGx5IGNvcnJlY3QpCgkJX3RyaWdnZXJSZWRyYXc6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoICQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKTsKCQkJLy90cmlnZ2VyIHBhZ2UgcmVkcmF3IHRvIGZpeCBpbmNvcnJlY3RseSBwb3NpdGlvbmVkIGZpeGVkIGVsZW1lbnRzCgkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCAoIHBhZGRpbmdCb3R0b20gKyAxICkgKyAicHgiICk7CgkJCS8vaWYgdGhlIHBhZGRpbmcgaXMgcmVzZXQgd2l0aCBvdXQgYSB0aW1lb3V0IHRoZSByZXBvc2l0aW9uIHdpbGwgbm90IG9jY3VyZS4KCQkJLy90aGlzIGlzIGluZGVwZW5kYW50IG9mIEpRTSB0aGUgYnJvd3NlciBzZWVtcyB0byBuZWVkIHRoZSB0aW1lIHRvIHJlYWN0LgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCBwYWRkaW5nQm90dG9tICsgInB4IiApOwoJCQl9LCAwICk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCS8vUmVtb3ZlIHRoZSBjbGFzcyB3ZSBhZGRlZCB0byB0aGUgcGFnZSBwcmV2aW91c2x5IGluIGFuZHJvaWQgMi54CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UtYWN0aXZlIiApLnJlbW92ZUNsYXNzKCAidWktYW5kcm9pZC0yeC1maXgiICk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGllSGFjayA9ICggJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFIDw9IDggKSwKCXVpVGVtcGxhdGUgPSAkKAoJCSI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1hcnJvdy1ndWlkZSc+PC9kaXY+IiArCgkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWNvbnRhaW5lciIgKyAoIGllSGFjayA/ICIgaWUiIDogIiIgKSArICInPiIgKwoJCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3cnPjwvZGl2PiIgKwoJCSI8L2Rpdj4iCgkpOwoKZnVuY3Rpb24gZ2V0QXJyb3coKSB7Cgl2YXIgY2xvbmUgPSB1aVRlbXBsYXRlLmNsb25lKCksCgkJZ2QgPSBjbG9uZS5lcSggMCApLAoJCWN0ID0gY2xvbmUuZXEoIDEgKSwKCQlhciA9IGN0LmNoaWxkcmVuKCk7CgoJcmV0dXJuIHsgYXJFbHM6IGN0LmFkZCggZ2QgKSwgZ2Q6IGdkLCBjdDogY3QsIGFyOiBhciB9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsICQubW9iaWxlLnBvcHVwLCB7CglvcHRpb25zOiB7CgoJCWFycm93OiAiIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgYXIsCgkJCXJldCA9IHRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmFycm93ICkgewoJCQl0aGlzLl91aS5hcnJvdyA9IGFyID0gdGhpcy5fYWRkQXJyb3coKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCV9hZGRBcnJvdzogZnVuY3Rpb24oKSB7CgkJdmFyIHRoZW1lLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlhciA9IGdldEFycm93KCk7CgoJCXRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQlhci5hci5hZGRDbGFzcyggdGhlbWUgKyAoIG9wdHMuc2hhZG93ID8gIiB1aS1vdmVybGF5LXNoYWRvdyIgOiAiIiApICk7CgkJYXIuYXJFbHMuaGlkZSgpLmFwcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCgkJcmV0dXJuIGFyOwoJfSwKCglfdW5lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCBhciApIHsKCQkJYXIuYXJFbHMucmVtb3ZlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJLy8gUHJldGVuZCB0byBzaG93IGFuIGFycm93IGRlc2NyaWJlZCBieSBAcCBhbmQgQGRpciBhbmQgY2FsY3VsYXRlIHRoZQoJLy8gZGlzdGFuY2UgZnJvbSB0aGUgZGVzaXJlZCBwb2ludC4gSWYgYSBiZXN0LWRpc3RhbmNlIGlzIHBhc3NlZCBpbiwgcmV0dXJuCgkvLyB0aGUgbWluaW11bSBvZiB0aGUgb25lIHBhc3NlZCBpbiBhbmQgdGhlIG9uZSBjYWxjdWxhdGVkLgoJX3RyeUFuQXJyb3c6IGZ1bmN0aW9uKCBwLCBkaXIsIGRlc2lyZWQsIHMsIGJlc3QgKSB7CgkJdmFyIHJlc3VsdCwgciwgZGlmZiwgZGVzaXJlZEZvckFycm93ID0ge30sIHRpcCA9IHt9OwoKCQkvLyBJZiB0aGUgYXJyb3cgaGFzIG5vIHdpZ2dsZSByb29tIGFsb25nIHRoZSBlZGdlIG9mIHRoZSBwb3B1cCwgaXQgY2Fubm90CgkJLy8gYmUgZGlzcGxheWVkIGFsb25nIHRoZSByZXF1ZXN0ZWQgZWRnZSB3aXRob3V0IGl0IHN0aWNraW5nIG91dC4KCQlpZiAoIHMuYXJGdWxsWyBwLmRpbUtleSBdID4gcy5ndWlkZURpbXNbIHAuZGltS2V5IF0gKSB7CgkJCXJldHVybiBiZXN0OwoJCX0KCgkJZGVzaXJlZEZvckFycm93WyBwLmZzdCBdID0gZGVzaXJlZFsgcC5mc3QgXSArCgkJCSggcy5hckhhbGZbIHAub0RpbUtleSBdICsgcy5tZW51SGFsZlsgcC5vRGltS2V5IF0gKSAqIHAub2Zmc2V0RmFjdG9yIC0KCQkJcy5jb250ZW50Qm94WyBwLmZzdCBdICsgKCBzLmNsYW1wSW5mby5tZW51U2l6ZVsgcC5vRGltS2V5IF0gLSBzLmNvbnRlbnRCb3hbIHAub0RpbUtleSBdICkgKiBwLmFycm93T2Zmc2V0RmFjdG9yOwoJCWRlc2lyZWRGb3JBcnJvd1sgcC5zbmQgXSA9IGRlc2lyZWRbIHAuc25kIF07CgoJCXJlc3VsdCA9IHMucmVzdWx0IHx8IHRoaXMuX2NhbGN1bGF0ZUZpbmFsTG9jYXRpb24oIGRlc2lyZWRGb3JBcnJvdywgcy5jbGFtcEluZm8gKTsKCQlyID0geyB4OiByZXN1bHQubGVmdCwgeTogcmVzdWx0LnRvcCB9OwoKCQl0aXBbIHAuZnN0IF0gPSByWyBwLmZzdCBdICsgcy5jb250ZW50Qm94WyBwLmZzdCBdICsgcC50aXBPZmZzZXQ7CgkJdGlwWyBwLnNuZCBdID0gTWF0aC5tYXgoIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmd1aWRlT2Zmc2V0WyBwLnByb3AgXSArIHMuYXJIYWxmWyBwLmRpbUtleSBdLAoJCQlNYXRoLm1pbiggcmVzdWx0WyBwLnByb3AgXSArIHMuZ3VpZGVPZmZzZXRbIHAucHJvcCBdICsgcy5ndWlkZURpbXNbIHAuZGltS2V5IF0gLSBzLmFySGFsZlsgcC5kaW1LZXkgXSwKCQkJCWRlc2lyZWRbIHAuc25kIF0gKSApOwoKCQlkaWZmID0gTWF0aC5hYnMoIGRlc2lyZWQueCAtIHRpcC54ICkgKyBNYXRoLmFicyggZGVzaXJlZC55IC0gdGlwLnkgKTsKCQlpZiAoICFiZXN0IHx8IGRpZmYgPCBiZXN0LmRpZmYgKSB7CgkJCS8vIENvbnZlcnQgdGlwIG9mZnNldCB0byBjb29yZGluYXRlcyBpbnNpZGUgdGhlIHBvcHVwCgkJCXRpcFsgcC5zbmQgXSAtPSBzLmFySGFsZlsgcC5kaW1LZXkgXSArIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmNvbnRlbnRCb3hbIHAuc25kIF07CgkJCWJlc3QgPSB7IGRpcjogZGlyLCBkaWZmOiBkaWZmLCByZXN1bHQ6IHJlc3VsdCwgcG9zUHJvcDogcC5wcm9wLCBwb3NWYWw6IHRpcFsgcC5zbmQgXSB9OwoJCX0KCgkJcmV0dXJuIGJlc3Q7Cgl9LAoKCV9nZXRQbGFjZW1lbnRTdGF0ZTogZnVuY3Rpb24oIGNsYW1wICkgewoJCXZhciBvZmZzZXQsIGdkT2Zmc2V0LAoJCQlhciA9IHRoaXMuX3VpLmFycm93LAoJCQlzdGF0ZSA9IHsKCQkJCWNsYW1wSW5mbzogdGhpcy5fY2xhbXBQb3B1cFdpZHRoKCAhY2xhbXAgKSwKCQkJCWFyRnVsbDogeyBjeDogYXIuY3Qud2lkdGgoKSwgY3k6IGFyLmN0LmhlaWdodCgpIH0sCgkJCQlndWlkZURpbXM6IHsgY3g6IGFyLmdkLndpZHRoKCksIGN5OiBhci5nZC5oZWlnaHQoKSB9LAoJCQkJZ3VpZGVPZmZzZXQ6IGFyLmdkLm9mZnNldCgpCgkJCX07CgoJCW9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCgkJYXIuZ2QuY3NzKCB7IGxlZnQ6IDAsIHRvcDogMCwgcmlnaHQ6IDAsIGJvdHRvbTogMCB9ICk7CgkJZ2RPZmZzZXQgPSBhci5nZC5vZmZzZXQoKTsKCQlzdGF0ZS5jb250ZW50Qm94ID0gewoJCQl4OiBnZE9mZnNldC5sZWZ0IC0gb2Zmc2V0LmxlZnQsCgkJCXk6IGdkT2Zmc2V0LnRvcCAtIG9mZnNldC50b3AsCgkJCWN4OiBhci5nZC53aWR0aCgpLAoJCQljeTogYXIuZ2QuaGVpZ2h0KCkKCQl9OwoJCWFyLmdkLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCgkJLy8gVGhlIGFycm93IGJveCBtb3ZlcyBiZXR3ZWVuIGd1aWRlT2Zmc2V0IGFuZCBndWlkZU9mZnNldCArIGd1aWRlRGltcyAtIGFyRnVsbAoJCXN0YXRlLmd1aWRlT2Zmc2V0ID0geyBsZWZ0OiBzdGF0ZS5ndWlkZU9mZnNldC5sZWZ0IC0gb2Zmc2V0LmxlZnQsIHRvcDogc3RhdGUuZ3VpZGVPZmZzZXQudG9wIC0gb2Zmc2V0LnRvcCB9OwoJCXN0YXRlLmFySGFsZiA9IHsgY3g6IHN0YXRlLmFyRnVsbC5jeCAvIDIsIGN5OiBzdGF0ZS5hckZ1bGwuY3kgLyAyIH07CgkJc3RhdGUubWVudUhhbGYgPSB7IGN4OiBzdGF0ZS5jbGFtcEluZm8ubWVudVNpemUuY3ggLyAyLCBjeTogc3RhdGUuY2xhbXBJbmZvLm1lbnVTaXplLmN5IC8gMiB9OwoKCQlyZXR1cm4gc3RhdGU7Cgl9LAoKCV9wbGFjZW1lbnRDb29yZHM6IGZ1bmN0aW9uKCBkZXNpcmVkICkgewoJCXZhciBzdGF0ZSwgYmVzdCwgcGFyYW1zLCBlbE9mZnNldCwgYmdSZWYsCgkJCW9wdGlvblZhbHVlID0gdGhpcy5vcHRpb25zLmFycm93LAoJCQlhciA9IHRoaXMuX3VpLmFycm93OwoKCQlpZiAoICFhciApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBkZXNpcmVkICk7CgkJfQoKCQlhci5hckVscy5zaG93KCk7CgoJCWJnUmVmID0ge307CgkJc3RhdGUgPSB0aGlzLl9nZXRQbGFjZW1lbnRTdGF0ZSggdHJ1ZSApOwoJCXBhcmFtcyA9IHsKCQkJImwiOiB7IGZzdDogIngiLCBzbmQ6ICJ5IiwgcHJvcDogInRvcCIsIGRpbUtleTogImN5Iiwgb0RpbUtleTogImN4Iiwgb2Zmc2V0RmFjdG9yOiAxLCB0aXBPZmZzZXQ6ICAtc3RhdGUuYXJIYWxmLmN4LCBhcnJvd09mZnNldEZhY3RvcjogMCB9LAoJCQkiciI6IHsgZnN0OiAieCIsIHNuZDogInkiLCBwcm9wOiAidG9wIiwgZGltS2V5OiAiY3kiLCBvRGltS2V5OiAiY3giLCBvZmZzZXRGYWN0b3I6IC0xLCB0aXBPZmZzZXQ6IHN0YXRlLmFySGFsZi5jeCArIHN0YXRlLmNvbnRlbnRCb3guY3gsIGFycm93T2Zmc2V0RmFjdG9yOiAxIH0sCgkJCSJiIjogeyBmc3Q6ICJ5Iiwgc25kOiAieCIsIHByb3A6ICJsZWZ0IiwgZGltS2V5OiAiY3giLCBvRGltS2V5OiAiY3kiLCBvZmZzZXRGYWN0b3I6IC0xLCB0aXBPZmZzZXQ6IHN0YXRlLmFySGFsZi5jeSArIHN0YXRlLmNvbnRlbnRCb3guY3ksIGFycm93T2Zmc2V0RmFjdG9yOiAxIH0sCgkJCSJ0IjogeyBmc3Q6ICJ5Iiwgc25kOiAieCIsIHByb3A6ICJsZWZ0IiwgZGltS2V5OiAiY3giLCBvRGltS2V5OiAiY3kiLCBvZmZzZXRGYWN0b3I6IDEsIHRpcE9mZnNldDogLXN0YXRlLmFySGFsZi5jeSwgYXJyb3dPZmZzZXRGYWN0b3I6IDAgfQoJCX07CgoJCS8vIFRyeSBlYWNoIHNpZGUgc3BlY2lmaWVkIGluIHRoZSBvcHRpb25zIHRvIHNlZSBvbiB3aGljaCBvbmUgdGhlIGFycm93CgkJLy8gc2hvdWxkIGJlIHBsYWNlZCBzdWNoIHRoYXQgdGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIHRpcCBvZiB0aGUgYXJyb3cgYW5kCgkJLy8gdGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgaXMgdGhlIHNob3J0ZXN0LgoJCSQuZWFjaCggKCBvcHRpb25WYWx1ZSA9PT0gdHJ1ZSA/ICJsLHQscixiIiA6IG9wdGlvblZhbHVlICkuc3BsaXQoICIsIiApLAoJCQkkLnByb3h5KCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCWJlc3QgPSB0aGlzLl90cnlBbkFycm93KCBwYXJhbXNbIHZhbHVlIF0sIHZhbHVlLCBkZXNpcmVkLCBzdGF0ZSwgYmVzdCApOwoJCQl9LCB0aGlzICkgKTsKCgkJLy8gQ291bGQgbm90IHBsYWNlIHRoZSBhcnJvdyBhbG9uZyBhbnkgb2YgdGhlIGVkZ2VzIC0gYmVoYXZlIGFzIGlmIHNob3dpbmcKCQkvLyB0aGUgYXJyb3cgd2FzIHR1cm5lZCBvZmYuCgkJaWYgKCAhYmVzdCApIHsKCQkJYXIuYXJFbHMuaGlkZSgpOwoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoIGRlc2lyZWQgKTsKCQl9CgoJCS8vIE1vdmUgdGhlIGFycm93IGludG8gcGxhY2UKCQlhci5jdAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hcnJvdy1sIHVpLXBvcHVwLWFycm93LXQgdWktcG9wdXAtYXJyb3ctciB1aS1wb3B1cC1hcnJvdy1iIiApCgkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWFycm93LSIgKyBiZXN0LmRpciApCgkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICkuY3NzKCBiZXN0LnBvc1Byb3AsIGJlc3QucG9zVmFsICkKCQkJLnNob3coKTsKCgkJLy8gRG8gbm90IG1vdmUvc2l6ZSB0aGUgYmFja2dyb3VuZCBkaXYgb24gSUUsIGJlY2F1c2Ugd2UgdXNlIHRoZSBhcnJvdyBkaXYgZm9yIGJhY2tncm91bmQgYXMgd2VsbC4KCQlpZiAoICFpZUhhY2sgKSB7CgkJCWVsT2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpOwoJCQliZ1JlZlsgcGFyYW1zWyBiZXN0LmRpciBdLmZzdCBdID0gYXIuY3Qub2Zmc2V0KCk7CgkJCWJnUmVmWyBwYXJhbXNbIGJlc3QuZGlyIF0uc25kIF0gPSB7CgkJCQlsZWZ0OiBlbE9mZnNldC5sZWZ0ICsgc3RhdGUuY29udGVudEJveC54LAoJCQkJdG9wOiBlbE9mZnNldC50b3AgKyBzdGF0ZS5jb250ZW50Qm94LnkKCQkJfTsKCQl9CgoJCXJldHVybiBiZXN0LnJlc3VsdDsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRzICkgewoJCXZhciBuZXdUaGVtZSwKCQkJb2xkVGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCWFyID0gdGhpcy5fdWkuYXJyb3csCgkJCXJldCA9IHRoaXMuX3N1cGVyKCBvcHRzICk7CgoJCWlmICggb3B0cy5hcnJvdyAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICFhciAmJiBvcHRzLmFycm93ICkgewoJCQkJdGhpcy5fdWkuYXJyb3cgPSB0aGlzLl9hZGRBcnJvdygpOwoKCQkJCS8vIEltcG9ydGFudCB0byByZXR1cm4gaGVyZSBzbyB3ZSBkb24ndCBzZXQgdGhlIHNhbWUgb3B0aW9ucyBhbGwgb3ZlcgoJCQkJLy8gYWdhaW4gYmVsb3cuCgkJCQlyZXR1cm47CgkJCX0gZWxzZSBpZiAoIGFyICYmICFvcHRzLmFycm93ICkgewoJCQkJYXIuYXJFbHMucmVtb3ZlKCk7CgkJCQl0aGlzLl91aS5hcnJvdyA9IG51bGw7CgkJCX0KCQl9CgoJCS8vIFJlYXNzaWduIHdpdGggcG90ZW50aWFsbHkgbmV3IGFycm93CgkJYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCBhciApIHsKCQkJaWYgKCBvcHRzLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvbGRUaGVtZSApOwoJCQkJbmV3VGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb3B0cy50aGVtZSApOwoJCQkJYXIuYXIucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0cy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJCWFyLmFyLnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBvcHRzLnNoYWRvdyApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFuZWwiLCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQlwYW5lbDogInVpLXBhbmVsIiwKCQkJcGFuZWxPcGVuOiAidWktcGFuZWwtb3BlbiIsCgkJCXBhbmVsQ2xvc2VkOiAidWktcGFuZWwtY2xvc2VkIiwKCQkJcGFuZWxGaXhlZDogInVpLXBhbmVsLWZpeGVkIiwKCQkJcGFuZWxJbm5lcjogInVpLXBhbmVsLWlubmVyIiwKCQkJbW9kYWw6ICJ1aS1wYW5lbC1kaXNtaXNzIiwKCQkJbW9kYWxPcGVuOiAidWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJcGFnZUNvbnRhaW5lcjogInVpLXBhbmVsLXBhZ2UtY29udGFpbmVyIiwKCQkJcGFnZVdyYXBwZXI6ICJ1aS1wYW5lbC13cmFwcGVyIiwKCQkJcGFnZUZpeGVkVG9vbGJhcjogInVpLXBhbmVsLWZpeGVkLXRvb2xiYXIiLAoJCQlwYWdlQ29udGVudFByZWZpeDogInVpLXBhbmVsLXBhZ2UtY29udGVudCIsIC8qIFVzZWQgZm9yIHdyYXBwZXIgYW5kIGZpeGVkIHRvb2xiYXJzIHBvc2l0aW9uLCBkaXNwbGF5IGFuZCBvcGVuIGNsYXNzZXMuICovCgkJCWFuaW1hdGU6ICJ1aS1wYW5lbC1hbmltYXRlIgoJCX0sCgkJYW5pbWF0ZTogdHJ1ZSwKCQl0aGVtZTogbnVsbCwKCQlwb3NpdGlvbjogImxlZnQiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWRpc3BsYXk6ICJyZXZlYWwiLCAvL2FjY2VwdHMgcmV2ZWFsLCBwdXNoLCBvdmVybGF5CgkJc3dpcGVDbG9zZTogdHJ1ZSwKCQlwb3NpdGlvbkZpeGVkOiBmYWxzZQoJfSwKCglfY2xvc2VMaW5rOiBudWxsLAoJX3BhcmVudFBhZ2U6IG51bGwsCglfcGFnZTogbnVsbCwKCV9tb2RhbDogbnVsbCwKCV9wYW5lbElubmVyOiBudWxsLAoJX3dyYXBwZXI6IG51bGwsCglfZml4ZWRUb29sYmFyczogbnVsbCwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWwgPSB0aGlzLmVsZW1lbnQsCgkJCXBhcmVudFBhZ2UgPSBlbC5jbG9zZXN0KCAiLnVpLXBhZ2UsIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKTsKCgkJLy8gZXhwb3NlIHNvbWUgcHJpdmF0ZSBwcm9wcyB0byBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2Nsb3NlTGluazogZWwuZmluZCggIjpqcW1EYXRhKHJlbD0nY2xvc2UnKSIgKSwKCQkJX3BhcmVudFBhZ2U6ICggcGFyZW50UGFnZS5sZW5ndGggPiAwICkgPyBwYXJlbnRQYWdlIDogZmFsc2UsCgkJCV9vcGVuZWRQYWdlOiBudWxsLAoJCQlfcGFnZTogdGhpcy5fZ2V0UGFnZSwKCQkJX3BhbmVsSW5uZXI6IHRoaXMuX2dldFBhbmVsSW5uZXIoKSwKCQkJX2ZpeGVkVG9vbGJhcnM6IHRoaXMuX2dldEZpeGVkVG9vbGJhcnMKCQl9KTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKXsKCQkJdGhpcy5fZ2V0V3JhcHBlcigpOwoJCX0KCQl0aGlzLl9hZGRQYW5lbENsYXNzZXMoKTsKCgkJLy8gaWYgYW5pbWF0aW5nLCBhZGQgdGhlIGNsYXNzIHRvIGRvIHNvCgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISF0aGlzLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5hbmltYXRlICk7CgkJfQoKCQl0aGlzLl9iaW5kVXBkYXRlTGF5b3V0KCk7CgkJdGhpcy5fYmluZENsb3NlRXZlbnRzKCk7CgkJdGhpcy5fYmluZExpbmtMaXN0ZW5lcnMoKTsKCQl0aGlzLl9iaW5kUGFnZUV2ZW50cygpOwoKCQlpZiAoICEhdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLl9jcmVhdGVNb2RhbCgpOwoJCX0KCgkJdGhpcy5fYmluZFN3aXBlRXZlbnRzKCk7Cgl9LAoKCV9nZXRQYW5lbElubmVyOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFuZWxJbm5lciA9IHRoaXMuZWxlbWVudC5maW5kKCAiLiIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICk7CgoJCWlmICggcGFuZWxJbm5lci5sZW5ndGggPT09IDAgKSB7CgkJCXBhbmVsSW5uZXIgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS53cmFwQWxsKCAiPGRpdiBjbGFzcz0nIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKyAiJyAvPiIgKS5wYXJlbnQoKTsKCQl9CgoJCXJldHVybiBwYW5lbElubmVyOwoJfSwKCglfY3JlYXRlTW9kYWw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJdGFyZ2V0ID0gc2VsZi5fcGFyZW50UGFnZSA/IHNlbGYuX3BhcmVudFBhZ2UucGFyZW50KCkgOiBzZWxmLmVsZW1lbnQucGFyZW50KCk7CgoJCXNlbGYuX21vZGFsID0gJCggIjxkaXYgY2xhc3M9JyIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5tb2RhbCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0YXJnZXQgKTsKCX0sCgoJX2dldFBhZ2U6IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gdGhpcy5fb3BlbmVkUGFnZSB8fCB0aGlzLl9wYXJlbnRQYWdlIHx8ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoKCQlyZXR1cm4gcGFnZTsKCX0sCgoJX2dldFdyYXBwZXI6IGZ1bmN0aW9uKCkgewoJCXZhciB3cmFwcGVyID0gdGhpcy5fcGFnZSgpLmZpbmQoICIuIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VXcmFwcGVyICk7CgkJaWYgKCB3cmFwcGVyLmxlbmd0aCA9PT0gMCApIHsKCQkJd3JhcHBlciA9IHRoaXMuX3BhZ2UoKS5jaGlsZHJlbiggIi51aS1oZWFkZXI6bm90KC51aS1oZWFkZXItZml4ZWQpLCAudWktY29udGVudDpub3QoLnVpLXBvcHVwKSwgLnVpLWZvb3Rlcjpub3QoLnVpLWZvb3Rlci1maXhlZCkiICkKCQkJCS53cmFwQWxsKCAiPGRpdiBjbGFzcz0nIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VXcmFwcGVyICsgIic+PC9kaXY+IiApCgkJCQkucGFyZW50KCk7CgkJfQoKCQl0aGlzLl93cmFwcGVyID0gd3JhcHBlcjsKCX0sCgoJX2dldEZpeGVkVG9vbGJhcnM6IGZ1bmN0aW9uKCkgewoJCXZhciBleHRGaXhlZFRvb2xiYXJzID0gJCggImJvZHkiICkuY2hpbGRyZW4oICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLAoJCQlpbnRGaXhlZFRvb2xiYXJzID0gdGhpcy5fcGFnZSgpLmZpbmQoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLAoJCQlmaXhlZFRvb2xiYXJzID0gZXh0Rml4ZWRUb29sYmFycy5hZGQoIGludEZpeGVkVG9vbGJhcnMgKS5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFnZUZpeGVkVG9vbGJhciApOwoKCQlyZXR1cm4gZml4ZWRUb29sYmFyczsKCX0sCgoJX2dldFBvc0Rpc3BsYXlDbGFzc2VzOiBmdW5jdGlvbiggcHJlZml4ICkgewoJCXJldHVybiBwcmVmaXggKyAiLXBvc2l0aW9uLSIgKyB0aGlzLm9wdGlvbnMucG9zaXRpb24gKyAiICIgKyBwcmVmaXggKyAiLWRpc3BsYXktIiArIHRoaXMub3B0aW9ucy5kaXNwbGF5OwoJfSwKCglfZ2V0UGFuZWxDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFuZWxDbGFzc2VzID0gdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWwgKwoJCQkiICIgKyB0aGlzLl9nZXRQb3NEaXNwbGF5Q2xhc3NlcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWwgKSArCgkJCSIgIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsQ2xvc2VkICsKCQkJIiAiICsgInVpLWJvZHktIiArICggdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiICk7CgoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJcGFuZWxDbGFzc2VzICs9ICIgIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQ7CgkJfQoKCQlyZXR1cm4gcGFuZWxDbGFzc2VzOwoJfSwKCglfYWRkUGFuZWxDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMuX2dldFBhbmVsQ2xhc3NlcygpICk7Cgl9LAoKCV9oYW5kbGVDbG9zZUNsaWNrQW5kRWF0RXZlbnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5jbG9zZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfaGFuZGxlQ2xvc2VDbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5fY2xvc2VMaW5rLCB7CgkJCSJjbGljayI6ICJfaGFuZGxlQ2xvc2VDbGljayIKCQl9KTsKCgkJdGhpcy5fb24oewoJCQkiY2xpY2sgYTpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiOiAiX2hhbmRsZUNsb3NlQ2xpY2siCgkJfSk7Cgl9LAoKCV9wb3NpdGlvblBhbmVsOiBmdW5jdGlvbiggc2Nyb2xsVG9Ub3AgKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYW5lbElubmVySGVpZ2h0ID0gc2VsZi5fcGFuZWxJbm5lci5vdXRlckhlaWdodCgpLAoJCQlleHBhbmQgPSBwYW5lbElubmVySGVpZ2h0ID4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmICggZXhwYW5kIHx8ICFzZWxmLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJaWYgKCBleHBhbmQgKSB7CgkJCQlzZWxmLl91bmZpeFBhbmVsKCk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQkJfQoJCQlpZiAoIHNjcm9sbFRvVG9wICkgewoJCQkJdGhpcy53aW5kb3dbIDAgXS5zY3JvbGxUbyggMCwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJfQoJfSwKCglfYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggJCggd2luZG93ICksIHsgInRocm90dGxlZHJlc2l6ZSI6ICJfcG9zaXRpb25QYW5lbCIgfSk7Cgl9LAoKCV91bmJpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCAkKCB3aW5kb3cgKSwgInRocm90dGxlZHJlc2l6ZSIgKTsKCX0sCgoJX3VuZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfYmluZFVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLmVsZW1lbnQub24oICJ1cGRhdGVsYXlvdXQiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAiYm9keSIsIHsKCQkJImNsaWNrIGEiOiAiX2hhbmRsZUNsaWNrIgoJCX0pOwoKCX0sCgoJX2hhbmRsZUNsaWNrOiBmdW5jdGlvbiggZSApIHsKCQl2YXIgbGluaywKCQkJcGFuZWxJZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICk7CgoJCWlmICggZS5jdXJyZW50VGFyZ2V0LmhyZWYuc3BsaXQoICIjIiApWyAxIF0gPT09IHBhbmVsSWQgJiYgcGFuZWxJZCAhPT0gdW5kZWZpbmVkICkgewoKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlsaW5rID0gJCggZS50YXJnZXQgKTsKCQkJaWYgKCBsaW5rLmhhc0NsYXNzKCAidWktYnRuIiApICkgewoJCQkJbGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCXRoaXMuZWxlbWVudC5vbmUoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCQl0aGlzLnRvZ2dsZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfYmluZFN3aXBlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWFyZWEgPSBzZWxmLl9tb2RhbCA/IHNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX21vZGFsICkgOiBzZWxmLmVsZW1lbnQ7CgoJCS8vIG9uIHN3aXBlLCBjbG9zZSB0aGUgcGFuZWwKCQlpZiAoICEhc2VsZi5vcHRpb25zLnN3aXBlQ2xvc2UgKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnBvc2l0aW9uID09PSAibGVmdCIgKSB7CgkJCQlhcmVhLm9uKCAic3dpcGVsZWZ0LnBhbmVsIiwgZnVuY3Rpb24oLyogZSAqLykgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJYXJlYS5vbiggInN3aXBlcmlnaHQucGFuZWwiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0KCQl9Cgl9LAoKCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLmRvY3VtZW50CgkJCS8vIENsb3NlIHRoZSBwYW5lbCBpZiBhbm90aGVyIHBhbmVsIG9uIHRoZSBwYWdlIG9wZW5zCgkJCS5vbiggInBhbmVsYmVmb3Jlb3BlbiIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBzZWxmLl9vcGVuICYmIGUudGFyZ2V0ICE9PSBzZWxmLmVsZW1lbnRbIDAgXSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pCgkJCS8vIE9uIGVzY2FwZSwgY2xvc2U/IG1pZ2h0IG5lZWQgdG8gaGF2ZSBhIHRhcmdldCBjaGVjayB0b28uLi4KCQkJLm9uKCAia2V5dXAucGFuZWwiLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggZS5rZXlDb2RlID09PSAyNyAmJiBzZWxmLl9vcGVuICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSk7CgkJaWYgKCAhdGhpcy5fcGFyZW50UGFnZSAmJiB0aGlzLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQl0aGlzLl9vbiggdGhpcy5kb2N1bWVudCwgewoJCQkJInBhZ2VzaG93IjogIl9nZXRXcmFwcGVyIgoJCQl9KTsKCQl9CgkJLy8gQ2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJaWYgKCBzZWxmLl9wYXJlbnRQYWdlICkgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWhpZGUiLCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCX0KCX0sCgoJLy8gc3RhdGUgc3RvcmFnZSBvZiBvcGVuIG9yIGNsb3NlZAoJX29wZW46IGZhbHNlLAoJX3BhZ2VDb250ZW50T3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgoJCQkJX29wZW5QYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuZG9jdW1lbnQub2ZmKCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLmFkZENsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQlzZWxmLmVsZW1lbnQuYW5pbWF0aW9uQ29tcGxldGUoIGNvbXBsZXRlLCAidHJhbnNpdGlvbiIgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCgkJCQkJaWYgKCBvLnRoZW1lICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkKCQkJCQkJCS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLXRoZW1lZCAiICsgby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLSIgKyBvLnRoZW1lICk7CgkJCQkJfQoKCQkJCQlzZWxmLmVsZW1lbnQKCQkJCQkJLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKQoJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCgkJCQkJc2VsZi5fcG9zaXRpb25QYW5lbCggdHJ1ZSApOwoKCQkJCQlzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCApOwoKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICk7CgkJCQkJCXNlbGYuX3dyYXBwZXIuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9tb2RhbE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5tb2RhbCApICsgIiAiICsgby5jbGFzc2VzLm1vZGFsT3BlbjsKCQkJCQlpZiAoIHNlbGYuX21vZGFsICkgewoJCQkJCQlzZWxmLl9tb2RhbAoJCQkJCQkJLmFkZENsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICkKCQkJCQkJCS5oZWlnaHQoIE1hdGgubWF4KCBzZWxmLl9tb2RhbC5oZWlnaHQoKSwgc2VsZi5kb2N1bWVudC5oZWlnaHQoKSApICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9iaW5kRml4TGlzdGVuZXIoKTsKCgkJCQkJc2VsZi5fdHJpZ2dlciggIm9wZW4iICk7CgoJCQkJCXNlbGYuX29wZW5lZFBhZ2UgPSBzZWxmLl9wYWdlKCk7CgkJCQl9OwoKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZW9wZW4iICk7CgoJCQlpZiAoIHNlbGYuX3BhZ2UoKS5qcW1EYXRhKCAicGFuZWwiICkgPT09ICJvcGVuIiApIHsKCQkJCXNlbGYuZG9jdW1lbnQub24oICJwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJX29wZW5QYW5lbCgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlfb3BlblBhbmVsKCk7CgkJCX0KCgkJCXNlbGYuX29wZW4gPSB0cnVlOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gdGhpcy5vcHRpb25zLAoKCQkJCV9jbG9zZVBhbmVsID0gZnVuY3Rpb24oKSB7CgoJCQkJCXNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCgkJCQkJaWYgKCAhaW1tZWRpYXRlICYmICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQkJc2VsZi5lbGVtZW50LmFuaW1hdGlvbkNvbXBsZXRlKCBjb21wbGV0ZSwgInRyYW5zaXRpb24iICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsLnJlbW92ZUNsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCBvLnRoZW1lICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCX0KCgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgJiYgby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJCQkJc2VsZi5fdW5iaW5kRml4TGlzdGVuZXIoKTsKCQkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCgkJCQkJc2VsZi5fcGFnZSgpLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCgkJCQkJc2VsZi5fdHJpZ2dlciggImNsb3NlIiApOwoKCQkJCQlzZWxmLl9vcGVuZWRQYWdlID0gbnVsbDsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3JlY2xvc2UiICk7CgoJCQlfY2xvc2VQYW5lbCgpOwoKCQkJc2VsZi5fb3BlbiA9IGZhbHNlOwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl0aGlzWyB0aGlzLl9vcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgb3RoZXJQYW5lbHMsCgkJbyA9IHRoaXMub3B0aW9ucywKCQltdWx0aXBsZVBhbmVscyA9ICggJCggImJvZHkgPiA6bW9iaWxlLXBhbmVsIiApLmxlbmd0aCArICQubW9iaWxlLmFjdGl2ZVBhZ2UuZmluZCggIjptb2JpbGUtcGFuZWwiICkubGVuZ3RoICkgPiAxOwoKCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoKCQkJLy8gIHJlbW92ZSB0aGUgd3JhcHBlciBpZiBub3QgaW4gdXNlIGJ5IGFub3RoZXIgcGFuZWwKCQkJb3RoZXJQYW5lbHMgPSAkKCAiYm9keSA+IDptb2JpbGUtcGFuZWwiICkuYWRkKCAkLm1vYmlsZS5hY3RpdmVQYWdlLmZpbmQoICI6bW9iaWxlLXBhbmVsIiApICk7CgkJCWlmICggb3RoZXJQYW5lbHMubm90KCAiLnVpLXBhbmVsLWRpc3BsYXktb3ZlcmxheSIgKS5ub3QoIHRoaXMuZWxlbWVudCApLmxlbmd0aCA9PT0gMCApIHsKCQkJCXRoaXMuX3dyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCQkJfQoKCQkJaWYgKCB0aGlzLl9vcGVuICkgewoKCQkJCXRoaXMuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoKCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCXRoaXMuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCX0KCgkJCQl0aGlzLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICk7CgoJCQkJaWYgKCBvLnRoZW1lICkgewoJCQkJCXRoaXMuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLXRoZW1lZCAiICsgby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLSIgKyBvLnRoZW1lICk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggIW11bHRpcGxlUGFuZWxzICkgewoKCQkJdGhpcy5kb2N1bWVudC5vZmYoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIgKTsKCgkJfQoKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXRoaXMuX3BhZ2UoKS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJfQoKCQl0aGlzLl9wYW5lbElubmVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoIFsgdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCksIG8uY2xhc3Nlcy5wYW5lbE9wZW4sIG8uY2xhc3Nlcy5hbmltYXRlIF0uam9pbiggIiAiICkgKQoJCQkub2ZmKCAic3dpcGVsZWZ0LnBhbmVsIHN3aXBlcmlnaHQucGFuZWwiICkKCQkJLm9mZiggInBhbmVsYmVmb3Jlb3BlbiIgKQoJCQkub2ZmKCAicGFuZWxoaWRlIiApCgkJCS5vZmYoICJrZXl1cC5wYW5lbCIgKQoJCQkub2ZmKCAidXBkYXRlbGF5b3V0IiApOwoKCQlpZiAoIHRoaXMuX21vZGFsICkgewoJCQl0aGlzLl9tb2RhbC5yZW1vdmUoKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsIHsKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCXRhYmxlOiAidWktdGFibGUiCgkJfSwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnRhYmxlICk7CgkJfQoKCQkvLyBleHRlbmQgaGVyZSwgYXNzaWduIG9uIHJlZnJlc2ggPiBfc2V0SGVhZGVycwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgoJCQkvLyBFeHBvc2UgaGVhZGVycyBhbmQgYWxsSGVhZGVycyBwcm9wZXJ0aWVzIG9uIHRoZSB3aWRnZXQKCQkJLy8gaGVhZGVycyByZWZlcmVuY2VzIHRoZSBUSHMgd2l0aGluIHRoZSBmaXJzdCBUUiBpbiB0aGUgdGFibGUKCQkJaGVhZGVyczogdW5kZWZpbmVkLAoKCQkJLy8gYWxsSGVhZGVycyByZWZlcmVuY2VzIGhlYWRlcnMsIHBsdXMgYWxsIFRIcyBpbiB0aGUgdGhlYWQsIHdoaWNoIG1heQoJCQkvLyBpbmNsdWRlIHNldmVyYWwgcm93cywgb3Igbm90CgkJCWFsbEhlYWRlcnM6IHVuZGVmaW5lZAoJCX0pOwoKCQl0aGlzLl9yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9zZXRIZWFkZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgdHJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0aGVhZCB0ciIgKTsKCgkJdGhpcy5oZWFkZXJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0cjplcSgwKSIgKS5jaGlsZHJlbigpOwoJCXRoaXMuYWxsSGVhZGVycyA9IHRoaXMuaGVhZGVycy5hZGQoIHRycy5jaGlsZHJlbigpICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJcmVidWlsZDogJC5ub29wLAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggLyogY3JlYXRlICovICkgewoJCXZhciB0YWJsZSA9IHRoaXMuZWxlbWVudCwKCQkJdHJzID0gdGFibGUuZmluZCggInRoZWFkIHRyIiApOwoKCQkvLyB1cGRhdGluZyBoZWFkZXJzIG9uIHJlZnJlc2ggKGZpeGVzICM1ODgwKQoJCXRoaXMuX3NldEhlYWRlcnMoKTsKCgkJLy8gSXRlcmF0ZSBvdmVyIHRoZSB0cnMKCQl0cnMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBjb2x1bW5Db3VudCA9IDA7CgoJCQkvLyBJdGVyYXRlIG92ZXIgdGhlIGNoaWxkcmVuIG9mIHRoZSB0cgoJCQkkKCB0aGlzICkuY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBzcGFuID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKSwKCQkJCQlzZWxlY3RvciA9ICI6bnRoLWNoaWxkKCIgKyAoIGNvbHVtbkNvdW50ICsgMSApICsgIikiLAoJCQkJCWo7CgoJCQkJdGhpcy5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJjb2xzdGFydCIsIGNvbHVtbkNvdW50ICsgMSApOwoKCQkJCWlmICggc3BhbiApIHsKCQkJCQlmb3IoIGogPSAwOyBqIDwgc3BhbiAtIDE7IGorKyApIHsKCQkJCQkJY29sdW1uQ291bnQrKzsKCQkJCQkJc2VsZWN0b3IgKz0gIiwgOm50aC1jaGlsZCgiICsgKCBjb2x1bW5Db3VudCArIDEgKSArICIpIjsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU3RvcmUgImNlbGxzIiBkYXRhIG9uIGhlYWRlciBhcyBhIHJlZmVyZW5jZSB0byBhbGwgY2VsbHMgaW4gdGhlCgkJCQkvLyBzYW1lIGNvbHVtbiBhcyB0aGlzIFRICgkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiwgdGFibGUuZmluZCggInRyIiApLm5vdCggdHJzLmVxKCAwICkgKS5ub3QoIHRoaXMgKS5jaGlsZHJlbiggc2VsZWN0b3IgKSApOwoKCQkJCWNvbHVtbkNvdW50Kys7CgkJCX0pOwoJCX0pOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgJC5tb2JpbGUudGFibGUsIHsKCW9wdGlvbnM6IHsKCQltb2RlOiAiY29sdW1udG9nZ2xlIiwKCQljb2x1bW5CdG5UaGVtZTogbnVsbCwKCQljb2x1bW5Qb3B1cFRoZW1lOiBudWxsLAoJCWNvbHVtbkJ0blRleHQ6ICJDb2x1bW5zLi4uIiwKCQljbGFzc2VzOiAkLmV4dGVuZCggJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcywgewoJCQlwb3B1cDogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1wb3B1cCIsCgkJCWNvbHVtbkJ0bjogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1idG4iLAoJCQlwcmlvcml0eVByZWZpeDogInVpLXRhYmxlLXByaW9yaXR5LSIsCgkJCWNvbHVtblRvZ2dsZVRhYmxlOiAidWktdGFibGUtY29sdW1udG9nZ2xlIgoJCX0pCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgIT09ICJjb2x1bW50b2dnbGUiICkgewoJCQlyZXR1cm47CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfbWVudTogbnVsbAoJCX0pOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fbWVudSA9ICQoIHRoaXMuZG9jdW1lbnRbIDAgXS5nZXRFbGVtZW50QnlJZCggdGhpcy5faWQoKSArICItcG9wdXAiICkgKS5jaGlsZHJlbigpLmZpcnN0KCk7CgkJCXRoaXMuX2FkZFRvZ2dsZXMoIHRoaXMuX21lbnUsIHRydWUgKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9tZW51ID0gdGhpcy5fZW5oYW5jZUNvbFRvZ2dsZSgpOwoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmNvbHVtblRvZ2dsZVRhYmxlICk7CgkJfQoKCQl0aGlzLl9zZXR1cEV2ZW50cygpOwoKCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJfSwKCglfaWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICkgfHwgKCB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQgKSApOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCkgewoJCS8vTk9URTogaW5wdXRzIGFyZSBib3VuZCBpbiBiaW5kVG9nZ2xlcywKCQkvLyBzbyBpdCBjYW4gYmUgY2FsbGVkIG9uIHJlZnJlc2gsIHRvbwoKCQkvLyB1cGRhdGUgY29sdW1uIHRvZ2dsZXMgb24gcmVzaXplCgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCXRocm90dGxlZHJlc2l6ZTogIl9zZXRUb2dnbGVTdGF0ZSIKCQl9KTsKCQl0aGlzLl9vbiggdGhpcy5fbWVudSwgewoJCQkiY2hhbmdlIGlucHV0IjogIl9tZW51SW5wdXRDaGFuZ2UiCgkJfSk7Cgl9LAoKCV9hZGRUb2dnbGVzOiBmdW5jdGlvbiggbWVudSwga2VlcCApIHsKCQl2YXIgaW5wdXRzLAoJCQljaGVja2JveEluZGV4ID0gMCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJY29udGFpbmVyID0gbWVudS5jb250cm9sZ3JvdXAoICJjb250YWluZXIiICk7CgoJCS8vIGFsbG93IHVwZGF0ZSBvZiBtZW51IG9uIHJlZnJlc2ggKGZpeGVzICM1ODgwKQoJCWlmICgga2VlcCApIHsKCQkJaW5wdXRzID0gbWVudS5maW5kKCAiaW5wdXQiICk7CgkJfSBlbHNlIHsKCQkJY29udGFpbmVyLmVtcHR5KCk7CgkJfQoKCQkvLyBjcmVhdGUgdGhlIGhpZGUvc2hvdyB0b2dnbGVzCgkJdGhpcy5oZWFkZXJzLm5vdCggInRkIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgaGVhZGVyID0gJCggdGhpcyApLAoJCQkJcHJpb3JpdHkgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJwcmlvcml0eSIgKSwKCQkJCWNlbGxzID0gaGVhZGVyLmFkZCggaGVhZGVyLmpxbURhdGEoICJjZWxscyIgKSApOwoKCQkJaWYgKCBwcmlvcml0eSApIHsKCQkJCWNlbGxzLmFkZENsYXNzKCBvcHRzLmNsYXNzZXMucHJpb3JpdHlQcmVmaXggKyBwcmlvcml0eSApOwoKCQkJCSgga2VlcCA/IGlucHV0cy5lcSggY2hlY2tib3hJbmRleCsrICkgOgoJCQkJCSQoIjxsYWJlbD48aW5wdXQgdHlwZT0nY2hlY2tib3gnIGNoZWNrZWQgLz4iICsKCQkJCQkJKCBoZWFkZXIuY2hpbGRyZW4oICJhYmJyIiApLmZpcnN0KCkuYXR0ciggInRpdGxlIiApIHx8CgkJCQkJCQloZWFkZXIudGV4dCgpICkgKwoJCQkJCQkiPC9sYWJlbD4iICkKCQkJCQkJLmFwcGVuZFRvKCBjb250YWluZXIgKQoJCQkJCQkuY2hpbGRyZW4oIDAgKQoJCQkJCQkuY2hlY2tib3hyYWRpbyggewoJCQkJCQkJdGhlbWU6IG9wdHMuY29sdW1uUG9wdXBUaGVtZQoJCQkJCQl9KSApCgkJCQkJLmpxbURhdGEoICJjZWxscyIsIGNlbGxzICk7CgkJCX0KCQl9KTsKCgkJLy8gc2V0IGJpbmRpbmdzIGhlcmUKCQlpZiAoICFrZWVwICkgewoJCQltZW51LmNvbnRyb2xncm91cCggInJlZnJlc2giICk7CgkJfQoJfSwKCglfbWVudUlucHV0Q2hhbmdlOiBmdW5jdGlvbiggZXZ0ICkgewoJCXZhciBpbnB1dCA9ICQoIGV2dC50YXJnZXQgKSwKCQkJY2hlY2tlZCA9IGlucHV0WyAwIF0uY2hlY2tlZDsKCgkJaW5wdXQuanFtRGF0YSggImNlbGxzIiApCgkJCS50b2dnbGVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIiwgIWNoZWNrZWQgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLXZpc2libGUiLCBjaGVja2VkICk7CgoJCWlmICggaW5wdXRbIDAgXS5nZXRBdHRyaWJ1dGUoICJsb2NrZWQiICkgKSB7CgkJCWlucHV0LnJlbW92ZUF0dHIoICJsb2NrZWQiICk7CgoJCQl0aGlzLl91bmxvY2tDZWxscyggaW5wdXQuanFtRGF0YSggImNlbGxzIiApICk7CgkJfSBlbHNlIHsKCQkJaW5wdXQuYXR0ciggImxvY2tlZCIsIHRydWUgKTsKCQl9Cgl9LAoKCV91bmxvY2tDZWxsczogZnVuY3Rpb24oIGNlbGxzICkgewoJCS8vIGFsbG93IGhpZGUvc2hvdyB2aWEgQ1NTIG9ubHkgPSByZW1vdmUgYWxsIHRvZ2dsZS1sb2NrcwoJCWNlbGxzLnJlbW92ZUNsYXNzKCAidWktdGFibGUtY2VsbC1oaWRkZW4gdWktdGFibGUtY2VsbC12aXNpYmxlIik7Cgl9LAoKCV9lbmhhbmNlQ29sVG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWQgLCBtZW51QnV0dG9uLCBwb3B1cCwgbWVudSwKCQkJdGFibGUgPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCW5zID0gJC5tb2JpbGUubnMsCgkJCWZyYWdtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCgkJaWQgPSB0aGlzLl9pZCgpICsgIi1wb3B1cCI7CgkJbWVudUJ1dHRvbiA9ICQoICI8YSBocmVmPScjIiArIGlkICsgIicgIiArCgkJCSJjbGFzcz0nIiArIG9wdHMuY2xhc3Nlcy5jb2x1bW5CdG4gKyAiIHVpLWJ0biAiICsKCQkJInVpLWJ0bi0iICsgKCBvcHRzLmNvbHVtbkJ0blRoZW1lIHx8ICJhIiApICsKCQkJIiB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyB1aS1taW5pJyAiICsKCQkJImRhdGEtIiArIG5zICsgInJlbD0ncG9wdXAnPiIgKyBvcHRzLmNvbHVtbkJ0blRleHQgKyAiPC9hPiIgKTsKCQlwb3B1cCA9ICQoICI8ZGl2IGNsYXNzPSciICsgb3B0cy5jbGFzc2VzLnBvcHVwICsgIicgaWQ9JyIgKyBpZCArICInPjwvZGl2PiIgKTsKCQltZW51ID0gJCggIjxmaWVsZHNldD48L2ZpZWxkc2V0PiIgKS5jb250cm9sZ3JvdXAoKTsKCgkJLy8gc2V0IGV4dGVuc2lvbiBoZXJlLCBzZW5kICJmYWxzZSIgdG8gdHJpZ2dlciBidWlsZC9yZWJ1aWxkCgkJdGhpcy5fYWRkVG9nZ2xlcyggbWVudSwgZmFsc2UgKTsKCgkJbWVudS5hcHBlbmRUbyggcG9wdXAgKTsKCgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHBvcHVwWyAwIF0gKTsKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggbWVudUJ1dHRvblsgMCBdICk7CgkJdGFibGUuYmVmb3JlKCBmcmFnbWVudCApOwoKCQlwb3B1cC5wb3B1cCgpOwoKCQlyZXR1cm4gbWVudTsKCX0sCgoJcmVidWlsZDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSA9PT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJCS8vIE5PVEU6IHJlYnVpbGQgcGFzc2VzICJmYWxzZSIsIHdoaWxlIHJlZnJlc2ggcGFzc2VzICJ1bmRlZmluZWQiCgkJCS8vIGJvdGggcmVmcmVzaCB0aGUgdGFibGUsIGJ1dCBpbnNpZGUgYWRkVG9nZ2xlcywgIWZhbHNlIHdpbGwgYmUgdHJ1ZSwKCQkJLy8gc28gYSByZWJ1aWxkIGNhbGwgY2FuIGJlIGluZGVudGlmaWVkCgkJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7CgkJfQoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLl9zdXBlciggY3JlYXRlICk7CgoJCWlmICggIWNyZWF0ZSAmJiB0aGlzLm9wdGlvbnMubW9kZSA9PT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJCS8vIGNvbHVtbnMgbm90IGJlaW5nIHJlcGxhY2VkIG11c3QgYmUgY2xlYXJlZCBmcm9tIGlucHV0IHRvZ2dsZS1sb2NrcwoJCQl0aGlzLl91bmxvY2tDZWxscyggdGhpcy5lbGVtZW50LmZpbmQoICIudWktdGFibGUtY2VsbC1oaWRkZW4sICIgKwoJCQkJIi51aS10YWJsZS1jZWxsLXZpc2libGUiICkgKTsKCgkJCS8vIHVwZGF0ZSBjb2x1bW50b2dnbGVzIGFuZCBjZWxscwoJCQl0aGlzLl9hZGRUb2dnbGVzKCB0aGlzLl9tZW51LCBjcmVhdGUgKTsKCgkJCS8vIGNoZWNrL3VuY2hlY2sKCQkJdGhpcy5fc2V0VG9nZ2xlU3RhdGUoKTsKCQl9Cgl9LAoKCV9zZXRUb2dnbGVTdGF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fbWVudS5maW5kKCAiaW5wdXQiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBjaGVja2JveCA9ICQoIHRoaXMgKTsKCgkJCXRoaXMuY2hlY2tlZCA9IGNoZWNrYm94LmpxbURhdGEoICJjZWxscyIgKS5lcSggMCApLmNzcyggImRpc3BsYXkiICkgPT09ICJ0YWJsZS1jZWxsIjsKCQkJY2hlY2tib3guY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfSk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCAkLm1vYmlsZS50YWJsZSwgewoJb3B0aW9uczogewoJCW1vZGU6ICJyZWZsb3ciLAoJCWNsYXNzZXM6ICQuZXh0ZW5kKCAkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLCB7CgkJCXJlZmxvd1RhYmxlOiAidWktdGFibGUtcmVmbG93IiwKCQkJY2VsbExhYmVsczogInVpLXRhYmxlLWNlbGwtbGFiZWwiCgkJfSkKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJLy8gSWYgaXQncyBub3QgcmVmbG93IG1vZGUsIHJldHVybiBoZXJlLgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgIT09ICJyZWZsb3ciICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucmVmbG93VGFibGUgKTsKCgkJCXRoaXMuX3VwZGF0ZVJlZmxvdygpOwoJCX0KCX0sCgoJcmVidWlsZDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSA9PT0gInJlZmxvdyIgKSB7CgkJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7CgkJfQoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLl9zdXBlciggY3JlYXRlICk7CgkJaWYgKCAhY3JlYXRlICYmIHRoaXMub3B0aW9ucy5tb2RlID09PSAicmVmbG93IiApIHsKCQkJdGhpcy5fdXBkYXRlUmVmbG93KCApOwoJCX0KCX0sCgoJX3VwZGF0ZVJlZmxvdzogZnVuY3Rpb24oKSB7CgkJdmFyIHRhYmxlID0gdGhpcywKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gZ2V0IGhlYWRlcnMgaW4gcmV2ZXJzZSBvcmRlciBzbyB0aGF0IHRvcC1sZXZlbCBoZWFkZXJzIGFyZSBhcHBlbmRlZCBsYXN0CgkJJCggdGFibGUuYWxsSGVhZGVycy5nZXQoKS5yZXZlcnNlKCkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNlbGxzID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSwKCQkJCWNvbHN0YXJ0ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiY29sc3RhcnQiICksCgkJCQloaWVyYXJjaHlDbGFzcyA9IGNlbGxzLm5vdCggdGhpcyApLmZpbHRlciggInRoZWFkIHRoIiApLmxlbmd0aCAmJiAiIHVpLXRhYmxlLWNlbGwtbGFiZWwtdG9wIiwKCQkJCXRleHQgPSAkKCB0aGlzICkudGV4dCgpLAoJCQkJaXRlcmF0aW9uLCBmaWx0ZXI7CgoJCQkJaWYgKCB0ZXh0ICE9PSAiIiAgKSB7CgoJCQkJCWlmICggaGllcmFyY2h5Q2xhc3MgKSB7CgkJCQkJCWl0ZXJhdGlvbiA9IHBhcnNlSW50KCB0aGlzLmdldEF0dHJpYnV0ZSggImNvbHNwYW4iICksIDEwICk7CgkJCQkJCWZpbHRlciA9ICIiOwoKCQkJCQkJaWYgKCBpdGVyYXRpb24gKSB7CgkJCQkJCQlmaWx0ZXIgPSAidGQ6bnRoLWNoaWxkKCIrIGl0ZXJhdGlvbiArIm4gKyAiICsgKCBjb2xzdGFydCApICsiKSI7CgkJCQkJCX0KCgkJCQkJCXRhYmxlLl9hZGRMYWJlbHMoIGNlbGxzLmZpbHRlciggZmlsdGVyICksIG9wdHMuY2xhc3Nlcy5jZWxsTGFiZWxzICsgaGllcmFyY2h5Q2xhc3MsIHRleHQgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0YWJsZS5fYWRkTGFiZWxzKCBjZWxscywgb3B0cy5jbGFzc2VzLmNlbGxMYWJlbHMsIHRleHQgKTsKCQkJCQl9CgoJCQkJfQoJCX0pOwoJfSwKCglfYWRkTGFiZWxzOiBmdW5jdGlvbiggY2VsbHMsIGxhYmVsLCB0ZXh0ICkgewoJCS8vIC5ub3QgZml4ZXMgIzYwMDYKCQljZWxscy5ub3QoICI6aGFzKGIuIiArIGxhYmVsICsgIikiICkucHJlcGVuZCggIjxiIGNsYXNzPSciICsgbGFiZWwgKyAiJz4iICsgdGV4dCArICI8L2I+IiAgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIFRPRE8gcmVuYW1lIGZpbHRlckNhbGxiYWNrL2RlcHJlY2F0ZSBhbmQgZGVmYXVsdCB0byB0aGUgaXRlbSBpdHNlbGYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CnZhciBkZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICggKCAiIiArICggJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiZmlsdGVydGV4dCIgKSB8fCAkKCB0aGlzICkudGV4dCgpICkgKQoJCS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xICk7Cn07CgokLndpZGdldCggIm1vYmlsZS5maWx0ZXJhYmxlIiwgewoKCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKGZpbHRlcj0ndHJ1ZScpIiwKCglvcHRpb25zOiB7CgkJZmlsdGVyUmV2ZWFsOiBmYWxzZSwKCQlmaWx0ZXJDYWxsYmFjazogZGVmYXVsdEZpbHRlckNhbGxiYWNrLAoJCWVuaGFuY2VkOiBmYWxzZSwKCQlpbnB1dDogbnVsbCwKCQljaGlsZHJlbjogIj4gbGksID4gb3B0aW9uLCA+IG9wdGdyb3VwIG9wdGlvbiwgPiB0Ym9keSB0ciwgPiAudWktY29udHJvbGdyb3VwLWNvbnRyb2xzID4gLnVpLWJ0biwgPiAudWktY29udHJvbGdyb3VwLWNvbnRyb2xzID4gLnVpLWNoZWNrYm94LCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktcmFkaW8iCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2VhcmNoOiBudWxsLAoJCQlfdGltZXI6IDAKCQl9KTsKCgkJdGhpcy5fc2V0SW5wdXQoIG9wdHMuaW5wdXQgKTsKCQlpZiAoICFvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl9maWx0ZXJJdGVtcyggKCAoIHRoaXMuX3NlYXJjaCAmJiB0aGlzLl9zZWFyY2gudmFsKCkgKSB8fCAiIiApLnRvTG93ZXJDYXNlKCkgKTsKCQl9Cgl9LAoKCV9vbktleVVwOiBmdW5jdGlvbigpIHsKCQl2YXIgdmFsLCBsYXN0dmFsLAoJCQlzZWFyY2ggPSB0aGlzLl9zZWFyY2g7CgoJCWlmICggc2VhcmNoICkgewoJCQl2YWwgPSBzZWFyY2gudmFsKCkudG9Mb3dlckNhc2UoKSwKCQkJbGFzdHZhbCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggc2VhcmNoWyAwIF0sICJsYXN0dmFsIiApICsgIiI7CgoJCQlpZiAoIGxhc3R2YWwgJiYgbGFzdHZhbCA9PT0gdmFsICkgewoJCQkJLy8gRXhlY3V0ZSB0aGUgaGFuZGxlciBvbmx5IG9uY2UgcGVyIHZhbHVlIGNoYW5nZQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHRoaXMuX3RpbWVyICkgewoJCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJCXRoaXMuX3RpbWVyID0gMDsKCQkJfQoKCQkJdGhpcy5fdGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlZmlsdGVyIiwgbnVsbCwgeyBpbnB1dDogc2VhcmNoIH0gKTsKCgkJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCQlzZWFyY2hbIDAgXS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJsYXN0dmFsIiwgdmFsICk7CgoJCQkJdGhpcy5fZmlsdGVySXRlbXMoIHZhbCApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9LCAyNTAgKTsKCQl9Cgl9LAoKCV9nZXRGaWx0ZXJhYmxlSXRlbXM6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQljaGlsZHJlbiA9IHRoaXMub3B0aW9ucy5jaGlsZHJlbiwKCQkJaXRlbXMgPSAhY2hpbGRyZW4gPyB7IGxlbmd0aDogMCB9OgoJCQkJJC5pc0Z1bmN0aW9uKCBjaGlsZHJlbiApID8gY2hpbGRyZW4oKToKCQkJCWNoaWxkcmVuLm5vZGVOYW1lID8gJCggY2hpbGRyZW4gKToKCQkJCWNoaWxkcmVuLmpxdWVyeSA/IGNoaWxkcmVuOgoJCQkJdGhpcy5lbGVtZW50LmZpbmQoIGNoaWxkcmVuICk7CgoJCWlmICggaXRlbXMubGVuZ3RoID09PSAwICkgewoJCQlpdGVtcyA9IGVsZW0uY2hpbGRyZW4oKTsKCQl9CgoJCXJldHVybiBpdGVtczsKCX0sCgoJX2ZpbHRlckl0ZW1zOiBmdW5jdGlvbiggdmFsICkgewoJCXZhciBpZHgsIGNhbGxiYWNrLCBsZW5ndGgsIGRzdCwKCQkJc2hvdyA9IFtdLAoJCQloaWRlID0gW10sCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWZpbHRlckl0ZW1zID0gdGhpcy5fZ2V0RmlsdGVyYWJsZUl0ZW1zKCk7CgoJCWlmICggdmFsICE9IG51bGwgKSB7CgkJCWNhbGxiYWNrID0gb3B0cy5maWx0ZXJDYWxsYmFjayB8fCBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgkJCWxlbmd0aCA9IGZpbHRlckl0ZW1zLmxlbmd0aDsKCgkJCS8vIFBhcnRpdGlvbiB0aGUgaXRlbXMgaW50byB0aG9zZSB0byBiZSBoaWRkZW4gYW5kIHRob3NlIHRvIGJlIHNob3duCgkJCWZvciAoIGlkeCA9IDAgOyBpZHggPCBsZW5ndGggOyBpZHgrKyApIHsKCQkJCWRzdCA9ICggY2FsbGJhY2suY2FsbCggZmlsdGVySXRlbXNbIGlkeCBdLCBpZHgsIHZhbCApICkgPyBoaWRlIDogc2hvdzsKCQkJCWRzdC5wdXNoKCBmaWx0ZXJJdGVtc1sgaWR4IF0gKTsKCQkJfQoJCX0KCgkJLy8gSWYgbm90aGluZyBpcyBoaWRkZW4sIHRoZW4gdGhlIGRlY2lzaW9uIHdoZXRoZXIgdG8gaGlkZSBvciBzaG93IHRoZSBpdGVtcwoJCS8vIGlzIGJhc2VkIG9uIHRoZSAiZmlsdGVyUmV2ZWFsIiBvcHRpb24uCgkJaWYgKCBoaWRlLmxlbmd0aCA9PT0gMCApIHsKCQkJZmlsdGVySXRlbXNbIG9wdHMuZmlsdGVyUmV2ZWFsID8gImFkZENsYXNzIiA6ICJyZW1vdmVDbGFzcyIgXSggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJJCggaGlkZSApLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJJCggc2hvdyApLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9CgoJCXRoaXMuX3JlZnJlc2hDaGlsZFdpZGdldCgpOwoKCQl0aGlzLl90cmlnZ2VyKCAiZmlsdGVyIiwgbnVsbCwgewoJCQlpdGVtczogZmlsdGVySXRlbXMKCQl9KTsKCX0sCgoJLy8gVGhlIERlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgX3JlZnJlc2hDaGlsZFdpZGdldCBhdHRlbXB0cyB0byBjYWxsCgkvLyByZWZyZXNoIG9uIGNvbGxhcHNpYmxlc2V0LCBjb250cm9sZ3JvdXAsIHNlbGVjdG1lbnUsIG9yIGxpc3R2aWV3CglfcmVmcmVzaENoaWxkV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQl2YXIgd2lkZ2V0LCBpZHgsCgkJCXJlY29nbml6ZWRXaWRnZXRzID0gWyAiY29sbGFwc2libGVzZXQiLCAic2VsZWN0bWVudSIsICJjb250cm9sZ3JvdXAiLCAibGlzdHZpZXciIF07CgoJCWZvciAoIGlkeCA9IHJlY29nbml6ZWRXaWRnZXRzLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQl3aWRnZXQgPSByZWNvZ25pemVkV2lkZ2V0c1sgaWR4IF07CgkJCWlmICggJC5tb2JpbGVbIHdpZGdldCBdICkgewoJCQkJd2lkZ2V0ID0gdGhpcy5lbGVtZW50LmRhdGEoICJtb2JpbGUtIiArIHdpZGdldCApOwoJCQkJaWYgKCB3aWRnZXQgJiYgJC5pc0Z1bmN0aW9uKCB3aWRnZXQucmVmcmVzaCApICkgewoJCQkJCXdpZGdldC5yZWZyZXNoKCk7CgkJCQl9CgkJCX0KCQl9Cgl9LAoKCS8vIFRPRE86IFdoZW4gdGhlIGlucHV0IGlzIG5vdCBpbnRlcm5hbCwgZG8gbm90IGV2ZW4gc3RvcmUgaXQgaW4gdGhpcy5fc2VhcmNoCglfc2V0SW5wdXQ6IGZ1bmN0aW9uICggc2VsZWN0b3IgKSB7CgkJdmFyIHNlYXJjaCA9IHRoaXMuX3NlYXJjaDsKCgkJLy8gU3RvcCBhIHBlbmRpbmcgZmlsdGVyIG9wZXJhdGlvbgoJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCXRoaXMuX3RpbWVyID0gMDsKCQl9CgoJCWlmICggc2VhcmNoICkgewoJCQl0aGlzLl9vZmYoIHNlYXJjaCwgImtleXVwIGNoYW5nZSBpbnB1dCIgKTsKCQkJc2VhcmNoID0gbnVsbDsKCQl9CgoJCWlmICggc2VsZWN0b3IgKSB7CgkJCXNlYXJjaCA9IHNlbGVjdG9yLmpxdWVyeSA/IHNlbGVjdG9yOgoJCQkJc2VsZWN0b3Iubm9kZU5hbWUgPyAkKCBzZWxlY3RvciApOgoJCQkJdGhpcy5kb2N1bWVudC5maW5kKCBzZWxlY3RvciApOwoKCQkJdGhpcy5fb24oIHNlYXJjaCwgewoJCQkJa2V5dXA6ICJfb25LZXlVcCIsCgkJCQljaGFuZ2U6ICJfb25LZXlVcCIsCgkJCQlpbnB1dDogIl9vbktleVVwIgoJCQl9KTsKCQl9CgoJCXRoaXMuX3NlYXJjaCA9IHNlYXJjaDsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZWZpbHRlciA9ICEoICggb3B0aW9ucy5maWx0ZXJSZXZlYWwgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuY2hpbGRyZW4gPT09IHVuZGVmaW5lZCApICk7CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggb3B0aW9ucy5pbnB1dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRJbnB1dCggb3B0aW9ucy5pbnB1dCApOwoJCQlyZWZpbHRlciA9IHRydWU7CgkJfQoKCQlpZiAoIHJlZmlsdGVyICkgewoJCQl0aGlzLnJlZnJlc2goKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJaXRlbXMgPSB0aGlzLl9nZXRGaWx0ZXJhYmxlSXRlbXMoKTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlpdGVtcy50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBvcHRzLmZpbHRlclJldmVhbCApOwoJCX0gZWxzZSB7CgkJCWl0ZW1zLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCXRoaXMuX3RpbWVyID0gMDsKCQl9CgkJdGhpcy5fZmlsdGVySXRlbXMoICggKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLnZhbCgpICkgfHwgIiIgKS50b0xvd2VyQ2FzZSgpICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBDcmVhdGUgYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmVwbGFjZSB0aGUgX3NldE9wdGlvbnMgZnVuY3Rpb24gb2YgYSB3aWRnZXQsCi8vIGFuZCB3aWxsIHBhc3MgdGhlIG9wdGlvbnMgb24gdG8gdGhlIGlucHV0IG9mIHRoZSBmaWx0ZXJhYmxlLgp2YXIgcmVwbGFjZVNldE9wdGlvbnMgPSBmdW5jdGlvbiggc2VsZiwgb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCW9yaWcuY2FsbCggdGhpcywgb3B0aW9ucyApOwoJCQlzZWxmLl9zeW5jVGV4dElucHV0T3B0aW9ucyggb3B0aW9ucyApOwoJCX07Cgl9LAoJckRpdmlkZXJMaXN0SXRlbSA9IC8oXnxccyl1aS1saS1kaXZpZGVyKFxzfCQpLywKCW9yaWdEZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSAkLm1vYmlsZS5maWx0ZXJhYmxlLnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrOwoKLy8gT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZmlsdGVyIGNhbGxiYWNrIHdpdGggb25lIHRoYXQgZG9lcyBub3QgaGlkZSBsaXN0IGRpdmlkZXJzCiQubW9iaWxlLmZpbHRlcmFibGUucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICF0aGlzLmNsYXNzTmFtZS5tYXRjaCggckRpdmlkZXJMaXN0SXRlbSApICYmCgkJb3JpZ0RlZmF1bHRGaWx0ZXJDYWxsYmFjay5jYWxsKCB0aGlzLCBpbmRleCwgc2VhcmNoVmFsdWUgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCAkLm1vYmlsZS5maWx0ZXJhYmxlLCB7CglvcHRpb25zOiB7CgkJZmlsdGVyUGxhY2Vob2xkZXI6ICJGaWx0ZXIgaXRlbXMuLi4iLAoJCWZpbHRlclRoZW1lOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIHdpZGdldE5hbWUsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCXJlY29nbml6ZWRXaWRnZXRzID0gWyAiY29sbGFwc2libGVzZXQiLCAic2VsZWN0bWVudSIsICJjb250cm9sZ3JvdXAiLCAibGlzdHZpZXciIF0sCgkJCWNyZWF0ZUhhbmRsZXJzID0ge307CgoJCXRoaXMuX3N1cGVyKCk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV93aWRnZXQ6IG51bGwKCQl9KTsKCgkJZm9yICggaWR4ID0gcmVjb2duaXplZFdpZGdldHMubGVuZ3RoIC0gMSA7IGlkeCA+IC0xIDsgaWR4LS0gKSB7CgkJCXdpZGdldE5hbWUgPSByZWNvZ25pemVkV2lkZ2V0c1sgaWR4IF07CgkJCWlmICggJC5tb2JpbGVbIHdpZGdldE5hbWUgXSApIHsKCQkJCWlmICggdGhpcy5fc2V0V2lkZ2V0KCBlbGVtLmRhdGEoICJtb2JpbGUtIiArIHdpZGdldE5hbWUgKSApICkgewoJCQkJCWJyZWFrOwoJCQkJfSBlbHNlIHsKCQkJCQljcmVhdGVIYW5kbGVyc1sgd2lkZ2V0TmFtZSArICJjcmVhdGUiIF0gPSAiX2hhbmRsZUNyZWF0ZSI7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggIXRoaXMuX3dpZGdldCApIHsKCQkJdGhpcy5fb24oIGVsZW0sIGNyZWF0ZUhhbmRsZXJzICk7CgkJfQoJfSwKCglfaGFuZGxlQ3JlYXRlOiBmdW5jdGlvbiggZXZ0ICkgewoJCXRoaXMuX3NldFdpZGdldCggdGhpcy5lbGVtZW50LmRhdGEoICJtb2JpbGUtIiArIGV2dC50eXBlLnN1YnN0cmluZyggMCwgZXZ0LnR5cGUubGVuZ3RoIC0gNiApICkgKTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQlpZiAoIHRoaXMuX3dpZGdldCAmJiB0aGlzLl93aWRnZXQud2lkZ2V0RnVsbE5hbWUgPT09ICJtb2JpbGUtbGlzdHZpZXciICYmCgkJCXR5cGUgPT09ICJiZWZvcmVmaWx0ZXIiICkgewoKCQkJLy8gQWxzbyB0cmlnZ2VyIGxpc3R2aWV3YmVmb3JlZmlsdGVyIGlmIHRoaXMgd2lkZ2V0IGlzIGFsc28gYSBsaXN0dmlldwoJCQl0aGlzLl93aWRnZXQuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCBldmVudCwgZGF0YSApOwoJCX0KCQl0aGlzLl9zdXBlciggdHlwZSwgZXZlbnQsIGRhdGEgKTsKCX0sCgoJX3NldFdpZGdldDogZnVuY3Rpb24oIHdpZGdldCApIHsKCQlpZiAoICF0aGlzLl93aWRnZXQgJiYgd2lkZ2V0ICkgewoJCQl0aGlzLl93aWRnZXQgPSB3aWRnZXQ7CgkJCXRoaXMuX3dpZGdldC5fc2V0T3B0aW9ucyA9IHJlcGxhY2VTZXRPcHRpb25zKCB0aGlzLCB0aGlzLl93aWRnZXQuX3NldE9wdGlvbnMgKTsKCQl9CgoJCWlmICggISF0aGlzLl93aWRnZXQgKSB7CgkJCXRoaXMuX3N5bmNUZXh0SW5wdXRPcHRpb25zKCB0aGlzLl93aWRnZXQub3B0aW9ucyApOwoJCQlpZiAoIHRoaXMuX3dpZGdldC53aWRnZXROYW1lID09PSAibGlzdHZpZXciICkgewoJCQkJdGhpcy5fd2lkZ2V0Lm9wdGlvbnMuaGlkZURpdmlkZXJzID0gdHJ1ZTsKCQkJCXRoaXMuX3dpZGdldC5lbGVtZW50Lmxpc3R2aWV3KCAicmVmcmVzaCIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuICEhdGhpcy5fd2lkZ2V0OwoJfSwKCglfaXNTZWFyY2hJbnRlcm5hbDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC5qcW1EYXRhKCAidWktZmlsdGVyYWJsZS0iICsgdGhpcy51dWlkICsgIi1pbnRlcm5hbCIgKSApOwoJfSwKCglfc2V0SW5wdXQ6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdXBkYXRlUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQl0ZXh0aW5wdXRPcHRzID0ge307CgoJCWlmICggIXNlbGVjdG9yICkgewoJCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSApIHsKCgkJCQkvLyBJZ25vcmUgdGhlIGNhbGwgdG8gc2V0IGEgbmV3IGlucHV0IGlmIHRoZSBzZWxlY3RvciBnb2VzIHRvIGZhbHN5IGFuZAoJCQkJLy8gdGhlIGN1cnJlbnQgdGV4dGlucHV0IGlzIGFscmVhZHkgb2YgdGhlIGludGVybmFsbHkgZ2VuZXJhdGVkIHZhcmlldHkuCgkJCQlyZXR1cm47CgkJCX0gZWxzZSB7CgoJCQkJLy8gR2VuZXJhdGluZyBhIG5ldyB0ZXh0aW5wdXQgd2lkZ2V0LiBObyBuZWVkIHRvIHNldCB0aGUgcGxhY2Vob2xkZXIKCQkJCS8vIGZ1cnRoZXIgZG93biB0aGUgZnVuY3Rpb24uCgkJCQl1cGRhdGVQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJc2VsZWN0b3IgPSAkKCAiPGlucHV0ICIgKwoJCQkJCSJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPSdzZWFyY2gnICIgKwoJCQkJCSJwbGFjZWhvbGRlcj0nIiArIG9wdHMuZmlsdGVyUGxhY2Vob2xkZXIgKyAiJz48L2lucHV0PiIgKQoJCQkJCS5qcW1EYXRhKCAidWktZmlsdGVyYWJsZS0iICsgdGhpcy51dWlkICsgIi1pbnRlcm5hbCIsIHRydWUgKTsKCQkJCSQoICI8Zm9ybSBjbGFzcz0ndWktZmlsdGVyYWJsZSc+PC9mb3JtPiIgKQoJCQkJCS5hcHBlbmQoIHNlbGVjdG9yICkKCQkJCQkuc3VibWl0KCBmdW5jdGlvbiggZXZ0ICkgewoJCQkJCQlldnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJc2VsZWN0b3IuYmx1cigpOwoJCQkJCX0pCgkJCQkJLmluc2VydEJlZm9yZSggdGhpcy5lbGVtZW50ICk7CgkJCQlpZiAoICQubW9iaWxlLnRleHRpbnB1dCApIHsKCQkJCQlpZiAoIHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZSAhPSBudWxsICkgewoJCQkJCQl0ZXh0aW5wdXRPcHRzWyAidGhlbWUiIF0gPSBvcHRzLmZpbHRlclRoZW1lOwoJCQkJCX0KCgkJCQkJc2VsZWN0b3IudGV4dGlucHV0KCB0ZXh0aW5wdXRPcHRzICk7CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuX3N1cGVyKCBzZWxlY3RvciApOwoKCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSAmJiB1cGRhdGVQbGFjZWhvbGRlciApIHsKCQkJdGhpcy5fc2VhcmNoLmF0dHIoICJwbGFjZWhvbGRlciIsIHRoaXMub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciApOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZXQgPSB0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkvLyBOZWVkIHRvIHNldCB0aGUgZmlsdGVyUGxhY2Vob2xkZXIgYWZ0ZXIgaGF2aW5nIGVzdGFibGlzaGVkIHRoZSBzZWFyY2ggaW5wdXQKCQlpZiAoIG9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgkJCQl0aGlzLl9zZWFyY2guYXR0ciggInBsYWNlaG9sZGVyIiwgb3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciApOwoJCQl9CgkJfQoKCQlpZiAoIG9wdGlvbnMuZmlsdGVyVGhlbWUgIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9zZWFyY2ggJiYgJC5tb2JpbGUudGV4dGlucHV0ICkgewoJCQl0aGlzLl9zZWFyY2gudGV4dGlucHV0KCAib3B0aW9uIiwgInRoZW1lIiwgb3B0aW9ucy5maWx0ZXJUaGVtZSApOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoJCQl0aGlzLl9zZWFyY2gucmVtb3ZlKCk7CgkJfQoJCXRoaXMuX3N1cGVyKCk7Cgl9LAoKCV9zeW5jVGV4dElucHV0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlkeCwKCQkJdGV4dGlucHV0T3B0aW9ucyA9IHt9OwoKCQkvLyBXZSBvbmx5IHN5bmMgb3B0aW9ucyBpZiB0aGUgZmlsdGVyYWJsZSdzIHRleHRpbnB1dCBpcyBvZiB0aGUgaW50ZXJuYWxseQoJCS8vIGdlbmVyYXRlZCB2YXJpZXR5LCByYXRoZXIgdGhhbiBvbmUgc3BlY2lmaWVkIGJ5IHRoZSB1c2VyLgoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICYmICQubW9iaWxlLnRleHRpbnB1dCApIHsKCgkJCS8vIEFwcGx5IG9ubHkgdGhlIG9wdGlvbnMgdW5kZXJzdG9vZCBieSB0ZXh0aW5wdXQKCQkJZm9yICggaWR4IGluICQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUub3B0aW9ucyApIHsKCQkJCWlmICggb3B0aW9uc1sgaWR4IF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCQlpZiAoIGlkeCA9PT0gInRoZW1lIiAmJiB0aGlzLm9wdGlvbnMuZmlsdGVyVGhlbWUgIT0gbnVsbCApIHsKCQkJCQkJdGV4dGlucHV0T3B0aW9uc1sgaWR4IF0gPSB0aGlzLm9wdGlvbnMuZmlsdGVyVGhlbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGV4dGlucHV0T3B0aW9uc1sgaWR4IF0gPSBvcHRpb25zWyBpZHggXTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJdGhpcy5fc2VhcmNoLnRleHRpbnB1dCggIm9wdGlvbiIsIHRleHRpbnB1dE9wdGlvbnMgKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyohCiAqIGpRdWVyeSBVSSBUYWJzIGZhZGYyYjMxMmEwNTA0MDQzNjQ1MWM2NGJiZmFmNDgxNGJjNjJjNTYKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS90YWJzLwogKgogKiBEZXBlbmRzOgogKglqcXVlcnkudWkuY29yZS5qcwogKglqcXVlcnkudWkud2lkZ2V0LmpzCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB0YWJJZCA9IDAsCglyaGFzaCA9IC8jLiokLzsKCmZ1bmN0aW9uIGdldE5leHRUYWJJZCgpIHsKCXJldHVybiArK3RhYklkOwp9CgpmdW5jdGlvbiBpc0xvY2FsKCBhbmNob3IgKSB7CglyZXR1cm4gYW5jaG9yLmhhc2gubGVuZ3RoID4gMSAmJgoJCWRlY29kZVVSSUNvbXBvbmVudCggYW5jaG9yLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICkgKSA9PT0KCQkJZGVjb2RlVVJJQ29tcG9uZW50KCBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApICk7Cn0KCiQud2lkZ2V0KCAidWkudGFicyIsIHsKCXZlcnNpb246ICJmYWRmMmIzMTJhMDUwNDA0MzY0NTFjNjRiYmZhZjQ4MTRiYzYyYzU2IiwKCWRlbGF5OiAzMDAsCglvcHRpb25zOiB7CgkJYWN0aXZlOiBudWxsLAoJCWNvbGxhcHNpYmxlOiBmYWxzZSwKCQlldmVudDogImNsaWNrIiwKCQloZWlnaHRTdHlsZTogImNvbnRlbnQiLAoJCWhpZGU6IG51bGwsCgkJc2hvdzogbnVsbCwKCgkJLy8gY2FsbGJhY2tzCgkJYWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlQWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlTG9hZDogbnVsbCwKCQlsb2FkOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgoJCXRoaXMuZWxlbWVudAoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIiApCgkJCS50b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCBvcHRpb25zLmNvbGxhcHNpYmxlICkKCQkJLy8gUHJldmVudCB1c2VycyBmcm9tIGZvY3VzaW5nIGRpc2FibGVkIHRhYnMgdmlhIGNsaWNrCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLW5hdiA+IGxpIiwgIm1vdXNlZG93biIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9KQoJCQkvLyBzdXBwb3J0OiBJRSA8OQoJCQkvLyBQcmV2ZW50aW5nIHRoZSBkZWZhdWx0IGFjdGlvbiBpbiBtb3VzZWRvd24gZG9lc24ndCBwcmV2ZW50IElFCgkJCS8vIGZyb20gZm9jdXNpbmcgdGhlIGVsZW1lbnQsIHNvIGlmIHRoZSBhbmNob3IgZ2V0cyBmb2N1c2VkLCBibHVyLgoJCQkvLyBXZSBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IGZvY3VzaW5nIHRoZSBwcmV2aW91c2x5IGZvY3VzZWQKCQkJLy8gZWxlbWVudCBzaW5jZSBjbGlja2luZyBvbiBhIG5vbi1mb2N1c2FibGUgZWxlbWVudCBzaG91bGQgZm9jdXMKCQkJLy8gdGhlIGJvZHkgYW55d2F5LgoJCQkuZGVsZWdhdGUoICIudWktdGFicy1hbmNob3IiLCAiZm9jdXMiICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCQkJdGhpcy5ibHVyKCk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLl9wcm9jZXNzVGFicygpOwoJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy5faW5pdGlhbEFjdGl2ZSgpOwoKCQkvLyBUYWtlIGRpc2FibGluZyB0YWJzIHZpYSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gaW50byBhY2NvdW50IGFuZCB1cGRhdGUgb3B0aW9uIHByb3Blcmx5LgoJCWlmICggJC5pc0FycmF5KCBvcHRpb25zLmRpc2FibGVkICkgKSB7CgkJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLnVuaXF1ZSggb3B0aW9ucy5kaXNhYmxlZC5jb25jYXQoCgkJCQkkLm1hcCggdGhpcy50YWJzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIGxpICkgewoJCQkJCXJldHVybiB0aGF0LnRhYnMuaW5kZXgoIGxpICk7CgkJCQl9KQoJCQkpICkuc29ydCgpOwoJCX0KCgkJLy8gY2hlY2sgZm9yIGxlbmd0aCBhdm9pZHMgZXJyb3Igd2hlbiBpbml0aWFsaXppbmcgZW1wdHkgbGlzdAoJCWlmICggdGhpcy5vcHRpb25zLmFjdGl2ZSAhPT0gZmFsc2UgJiYgdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJdGhpcy5hY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBvcHRpb25zLmFjdGl2ZSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoKCQlpZiAoIHRoaXMuYWN0aXZlLmxlbmd0aCApIHsKCQkJdGhpcy5sb2FkKCBvcHRpb25zLmFjdGl2ZSApOwoJCX0KCX0sCgoJX2luaXRpYWxBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCXZhciBhY3RpdmUgPSB0aGlzLm9wdGlvbnMuYWN0aXZlLAoJCQljb2xsYXBzaWJsZSA9IHRoaXMub3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJbG9jYXRpb25IYXNoID0gbG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoIDEgKTsKCgkJaWYgKCBhY3RpdmUgPT09IG51bGwgKSB7CgkJCS8vIGNoZWNrIHRoZSBmcmFnbWVudCBpZGVudGlmaWVyIGluIHRoZSBVUkwKCQkJaWYgKCBsb2NhdGlvbkhhc2ggKSB7CgkJCQl0aGlzLnRhYnMuZWFjaChmdW5jdGlvbiggaSwgdGFiICkgewoJCQkJCWlmICggJCggdGFiICkuYXR0ciggImFyaWEtY29udHJvbHMiICkgPT09IGxvY2F0aW9uSGFzaCApIHsKCQkJCQkJYWN0aXZlID0gaTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQkvLyBjaGVjayBmb3IgYSB0YWIgbWFya2VkIGFjdGl2ZSB2aWEgYSBjbGFzcwoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmZpbHRlciggIi51aS10YWJzLWFjdGl2ZSIgKSApOwoJCQl9CgoJCQkvLyBubyBhY3RpdmUgdGFiLCBzZXQgdG8gZmFsc2UKCQkJaWYgKCBhY3RpdmUgPT09IG51bGwgfHwgYWN0aXZlID09PSAtMSApIHsKCQkJCWFjdGl2ZSA9IHRoaXMudGFicy5sZW5ndGggPyAwIDogZmFsc2U7CgkJCX0KCQl9CgoJCS8vIGhhbmRsZSBudW1iZXJzOiBuZWdhdGl2ZSwgb3V0IG9mIHJhbmdlCgkJaWYgKCBhY3RpdmUgIT09IGZhbHNlICkgewoJCQlhY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMudGFicy5lcSggYWN0aXZlICkgKTsKCQkJaWYgKCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gY29sbGFwc2libGUgPyBmYWxzZSA6IDA7CgkJCX0KCQl9CgoJCS8vIGRvbid0IGFsbG93IGNvbGxhcHNpYmxlOiBmYWxzZSBhbmQgYWN0aXZlOiBmYWxzZQoJCWlmICggIWNvbGxhcHNpYmxlICYmIGFjdGl2ZSA9PT0gZmFsc2UgJiYgdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJYWN0aXZlID0gMDsKCQl9CgoJCXJldHVybiBhY3RpdmU7Cgl9LAoKCV9nZXRDcmVhdGVFdmVudERhdGE6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB7CgkJCXRhYjogdGhpcy5hY3RpdmUsCgkJCXBhbmVsOiAhdGhpcy5hY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkKCQl9OwoJfSwKCglfdGFiS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBmb2N1c2VkVGFiID0gJCggdGhpcy5kb2N1bWVudFswXS5hY3RpdmVFbGVtZW50ICkuY2xvc2VzdCggImxpIiApLAoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy50YWJzLmluZGV4KCBmb2N1c2VkVGFiICksCgkJCWdvaW5nRm9yd2FyZCA9IHRydWU7CgoJCWlmICggdGhpcy5faGFuZGxlUGFnZU5hdiggZXZlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLnVpLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC51aS5rZXlDb2RlLkRPV046CgkJCQlzZWxlY3RlZEluZGV4Kys7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuVVA6CgkJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6CgkJCQlnb2luZ0ZvcndhcmQgPSBmYWxzZTsKCQkJCXNlbGVjdGVkSW5kZXgtLTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5FTkQ6CgkJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5hbmNob3JzLmxlbmd0aCAtIDE7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJCXNlbGVjdGVkSW5kZXggPSAwOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOgoJCQkJLy8gQWN0aXZhdGUgb25seSwgbm8gY29sbGFwc2luZwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoKCQkJCS8vIFRvZ2dsZSAoY2FuY2VsIGRlbGF5ZWQgYWN0aXZhdGlvbiwgYWxsb3cgY29sbGFwc2luZykKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCQkJLy8gRGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBjb2xsYXBzZSBvciBhY3RpdmF0ZQoJCQkJdGhpcy5fYWN0aXZhdGUoIHNlbGVjdGVkSW5kZXggPT09IHRoaXMub3B0aW9ucy5hY3RpdmUgPyBmYWxzZSA6IHNlbGVjdGVkSW5kZXggKTsKCQkJCXJldHVybjsKCQkJZGVmYXVsdDoKCQkJCXJldHVybjsKCQl9CgoJCS8vIEZvY3VzIHRoZSBhcHByb3ByaWF0ZSB0YWIsIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5fZm9jdXNOZXh0VGFiKCBzZWxlY3RlZEluZGV4LCBnb2luZ0ZvcndhcmQgKTsKCgkJLy8gTmF2aWdhdGluZyB3aXRoIGNvbnRyb2wga2V5IHdpbGwgcHJldmVudCBhdXRvbWF0aWMgYWN0aXZhdGlvbgoJCWlmICggIWV2ZW50LmN0cmxLZXkgKSB7CgkJCS8vIFVwZGF0ZSBhcmlhLXNlbGVjdGVkIGltbWVkaWF0ZWx5IHNvIHRoYXQgQVQgdGhpbmsgdGhlIHRhYiBpcyBhbHJlYWR5IHNlbGVjdGVkLgoJCQkvLyBPdGhlcndpc2UgQVQgbWF5IGNvbmZ1c2UgdGhlIHVzZXIgYnkgc3RhdGluZyB0aGF0IHRoZXkgbmVlZCB0byBhY3RpdmF0ZSB0aGUgdGFiLAoJCQkvLyBidXQgdGhlIHRhYiB3aWxsIGFscmVhZHkgYmUgYWN0aXZhdGVkIGJ5IHRoZSB0aW1lIHRoZSBhbm5vdW5jZW1lbnQgZmluaXNoZXMuCgkJCWZvY3VzZWRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJCXRoaXMudGFicy5lcSggc2VsZWN0ZWRJbmRleCApLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgInRydWUiICk7CgoJCQl0aGlzLmFjdGl2YXRpbmcgPSB0aGlzLl9kZWxheShmdW5jdGlvbigpIHsKCQkJCXRoaXMub3B0aW9uKCAiYWN0aXZlIiwgc2VsZWN0ZWRJbmRleCApOwoJCQl9LCB0aGlzLmRlbGF5ICk7CgkJfQoJfSwKCglfcGFuZWxLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDdHJsK3VwIG1vdmVzIGZvY3VzIHRvIHRoZSBjdXJyZW50IHRhYgoJCWlmICggZXZlbnQuY3RybEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuVVAgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXRoaXMuYWN0aXZlLmZvY3VzKCk7CgkJfQoJfSwKCgkvLyBBbHQrcGFnZSB1cC9kb3duIG1vdmVzIGZvY3VzIHRvIHRoZSBwcmV2aW91cy9uZXh0IHRhYiAoYW5kIGFjdGl2YXRlcykKCV9oYW5kbGVQYWdlTmF2OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudC5hbHRLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlBBR0VfVVAgKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgLSAxLCBmYWxzZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZm9jdXNOZXh0VGFiKCB0aGlzLm9wdGlvbnMuYWN0aXZlICsgMSwgdHJ1ZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0sCgoJX2ZpbmROZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQl2YXIgbGFzdFRhYkluZGV4ID0gdGhpcy50YWJzLmxlbmd0aCAtIDE7CgoJCWZ1bmN0aW9uIGNvbnN0cmFpbigpIHsKCQkJaWYgKCBpbmRleCA+IGxhc3RUYWJJbmRleCApIHsKCQkJCWluZGV4ID0gMDsKCQkJfQoJCQlpZiAoIGluZGV4IDwgMCApIHsKCQkJCWluZGV4ID0gbGFzdFRhYkluZGV4OwoJCQl9CgkJCXJldHVybiBpbmRleDsKCQl9CgoJCXdoaWxlICggJC5pbkFycmF5KCBjb25zdHJhaW4oKSwgdGhpcy5vcHRpb25zLmRpc2FibGVkICkgIT09IC0xICkgewoJCQlpbmRleCA9IGdvaW5nRm9yd2FyZCA/IGluZGV4ICsgMSA6IGluZGV4IC0gMTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2ZvY3VzTmV4dFRhYjogZnVuY3Rpb24oIGluZGV4LCBnb2luZ0ZvcndhcmQgKSB7CgkJaW5kZXggPSB0aGlzLl9maW5kTmV4dFRhYiggaW5kZXgsIGdvaW5nRm9yd2FyZCApOwoJCXRoaXMudGFicy5lcSggaW5kZXggKS5mb2N1cygpOwoJCXJldHVybiBpbmRleDsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJhY3RpdmUiICkgewoJCQkvLyBfYWN0aXZhdGUoKSB3aWxsIGhhbmRsZSBpbnZhbGlkIHZhbHVlcyBhbmQgdXBkYXRlIHRoaXMub3B0aW9ucwoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCS8vIGRvbid0IHVzZSB0aGUgd2lkZ2V0IGZhY3RvcnkncyBkaXNhYmxlZCBoYW5kbGluZwoJCQl0aGlzLl9zZXR1cERpc2FibGVkKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSk7CgoJCWlmICgga2V5ID09PSAiY29sbGFwc2libGUiICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS10YWJzLWNvbGxhcHNpYmxlIiwgdmFsdWUgKTsKCQkJLy8gU2V0dGluZyBjb2xsYXBzaWJsZTogZmFsc2Ugd2hpbGUgY29sbGFwc2VkOyBvcGVuIGZpcnN0IHBhbmVsCgkJCWlmICggIXZhbHVlICYmIHRoaXMub3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgewoJCQkJdGhpcy5fYWN0aXZhdGUoIDAgKTsKCQkJfQoJCX0KCgkJaWYgKCBrZXkgPT09ICJldmVudCIgKSB7CgkJCXRoaXMuX3NldHVwRXZlbnRzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJoZWlnaHRTdHlsZSIgKSB7CgkJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHZhbHVlICk7CgkJfQoJfSwKCglfdGFiSWQ6IGZ1bmN0aW9uKCB0YWIgKSB7CgkJcmV0dXJuIHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKSB8fCAidWktdGFicy0iICsgZ2V0TmV4dFRhYklkKCk7Cgl9LAoKCV9zYW5pdGl6ZVNlbGVjdG9yOiBmdW5jdGlvbiggaGFzaCApIHsKCQlyZXR1cm4gaGFzaCA/IGhhc2gucmVwbGFjZSggL1shIiQlJicoKSorLC5cLzo7PD0+P0BcW1xdXF5ge3x9fl0vZywgIlxcJCYiICkgOiAiIjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWxpcyA9IHRoaXMudGFibGlzdC5jaGlsZHJlbiggIjpoYXMoYVtocmVmXSkiICk7CgoJCS8vIGdldCBkaXNhYmxlZCB0YWJzIGZyb20gY2xhc3MgYXR0cmlidXRlIGZyb20gSFRNTAoJCS8vIHRoaXMgd2lsbCBnZXQgY29udmVydGVkIHRvIGEgYm9vbGVhbiBpZiBuZWVkZWQgaW4gX3JlZnJlc2goKQoJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLm1hcCggbGlzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIHRhYiApIHsKCQkJcmV0dXJuIGxpcy5pbmRleCggdGFiICk7CgkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgoJCS8vIHdhcyBjb2xsYXBzZWQgb3Igbm8gdGFicwoJCWlmICggb3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlIHx8ICF0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkvLyB3YXMgYWN0aXZlLCBidXQgYWN0aXZlIHRhYiBpcyBnb25lCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLnRhYmxpc3RbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoJCQkvLyBhbGwgcmVtYWluaW5nIHRhYnMgYXJlIGRpc2FibGVkCgkJCWlmICggdGhpcy50YWJzLmxlbmd0aCA9PT0gb3B0aW9ucy5kaXNhYmxlZC5sZW5ndGggKSB7CgkJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJCS8vIGFjdGl2YXRlIHByZXZpb3VzIHRhYgoJCQl9IGVsc2UgewoJCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZpbmROZXh0VGFiKCBNYXRoLm1heCggMCwgb3B0aW9ucy5hY3RpdmUgLSAxICksIGZhbHNlICkgKTsKCQkJfQoJCS8vIHdhcyBhY3RpdmUsIGFjdGl2ZSB0YWIgc3RpbGwgZXhpc3RzCgkJfSBlbHNlIHsKCQkJLy8gbWFrZSBzdXJlIGFjdGl2ZSBpbmRleCBpcyBjb3JyZWN0CgkJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLmFjdGl2ZSApOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggdGhpcy5vcHRpb25zLmRpc2FibGVkICk7CgkJdGhpcy5fc2V0dXBFdmVudHMoIHRoaXMub3B0aW9ucy5ldmVudCApOwoJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSApOwoKCQl0aGlzLnRhYnMubm90KCB0aGlzLmFjdGl2ZSApLmF0dHIoewoJCQkiYXJpYS1zZWxlY3RlZCI6ICJmYWxzZSIsCgkJCXRhYkluZGV4OiAtMQoJCX0pOwoJCXRoaXMucGFuZWxzLm5vdCggdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKHsKCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCQl9KTsKCgkJLy8gTWFrZSBzdXJlIG9uZSB0YWIgaXMgaW4gdGhlIHRhYiBvcmRlcgoJCWlmICggIXRoaXMuYWN0aXZlLmxlbmd0aCApIHsKCQkJdGhpcy50YWJzLmVxKCAwICkuYXR0ciggInRhYkluZGV4IiwgMCApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYWN0aXZlCgkJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJCQl0YWJJbmRleDogMAoJCQkJfSk7CgkJCXRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApCgkJCQkuc2hvdygpCgkJCQkuYXR0cih7CgkJCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsCgkJCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCQkJfSk7CgkJfQoJfSwKCglfcHJvY2Vzc1RhYnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJdGhpcy50YWJsaXN0ID0gdGhpcy5fZ2V0TGlzdCgpCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtbmF2IHVpLWhlbHBlci1yZXNldCB1aS1oZWxwZXItY2xlYXJmaXggdWktd2lkZ2V0LWhlYWRlciB1aS1jb3JuZXItYWxsIiApCgkJCS5hdHRyKCAicm9sZSIsICJ0YWJsaXN0IiApOwoKCQl0aGlzLnRhYnMgPSB0aGlzLnRhYmxpc3QuZmluZCggIj4gbGk6aGFzKGFbaHJlZl0pIiApCgkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktY29ybmVyLXRvcCIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAidGFiIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5hbmNob3JzID0gdGhpcy50YWJzLm1hcChmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCAiYSIsIHRoaXMgKVsgMCBdOwoJCQl9KQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAicHJlc2VudGF0aW9uIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5wYW5lbHMgPSAkKCk7CgoJCXRoaXMuYW5jaG9ycy5lYWNoKGZ1bmN0aW9uKCBpLCBhbmNob3IgKSB7CgkJCXZhciBzZWxlY3RvciwgcGFuZWwsIHBhbmVsSWQsCgkJCQlhbmNob3JJZCA9ICQoIGFuY2hvciApLnVuaXF1ZUlkKCkuYXR0ciggImlkIiApLAoJCQkJdGFiID0gJCggYW5jaG9yICkuY2xvc2VzdCggImxpIiApLAoJCQkJb3JpZ2luYWxBcmlhQ29udHJvbHMgPSB0YWIuYXR0ciggImFyaWEtY29udHJvbHMiICk7CgoJCQkvLyBpbmxpbmUgdGFiCgkJCWlmICggaXNMb2NhbCggYW5jaG9yICkgKSB7CgkJCQlzZWxlY3RvciA9IGFuY2hvci5oYXNoOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggdGhhdC5fc2FuaXRpemVTZWxlY3Rvciggc2VsZWN0b3IgKSApOwoJCQkvLyByZW1vdGUgdGFiCgkJCX0gZWxzZSB7CgkJCQlwYW5lbElkID0gdGhhdC5fdGFiSWQoIHRhYiApOwoJCQkJc2VsZWN0b3IgPSAiIyIgKyBwYW5lbElkOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggc2VsZWN0b3IgKTsKCQkJCWlmICggIXBhbmVsLmxlbmd0aCApIHsKCQkJCQlwYW5lbCA9IHRoYXQuX2NyZWF0ZVBhbmVsKCBwYW5lbElkICk7CgkJCQkJcGFuZWwuaW5zZXJ0QWZ0ZXIoIHRoYXQucGFuZWxzWyBpIC0gMSBdIHx8IHRoYXQudGFibGlzdCApOwoJCQkJfQoJCQkJcGFuZWwuYXR0ciggImFyaWEtbGl2ZSIsICJwb2xpdGUiICk7CgkJCX0KCgkJCWlmICggcGFuZWwubGVuZ3RoKSB7CgkJCQl0aGF0LnBhbmVscyA9IHRoYXQucGFuZWxzLmFkZCggcGFuZWwgKTsKCQkJfQoJCQlpZiAoIG9yaWdpbmFsQXJpYUNvbnRyb2xzICkgewoJCQkJdGFiLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiLCBvcmlnaW5hbEFyaWFDb250cm9scyApOwoJCQl9CgkJCXRhYi5hdHRyKHsKCQkJCSJhcmlhLWNvbnRyb2xzIjogc2VsZWN0b3Iuc3Vic3RyaW5nKCAxICksCgkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogYW5jaG9ySWQKCQkJfSk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWxhYmVsbGVkYnkiLCBhbmNob3JJZCApOwoJCX0pOwoKCQl0aGlzLnBhbmVscwoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYnBhbmVsIiApOwoJfSwKCgkvLyBhbGxvdyBvdmVycmlkaW5nIGhvdyB0byBmaW5kIHRoZSBsaXN0IGZvciByYXJlIHVzYWdlIHNjZW5hcmlvcyAoIzc3MTUpCglfZ2V0TGlzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudC5maW5kKCAib2wsdWwiICkuZXEoIDAgKTsKCX0sCgoJX2NyZWF0ZVBhbmVsOiBmdW5jdGlvbiggaWQgKSB7CgkJcmV0dXJuICQoICI8ZGl2PiIgKQoJCQkuYXR0ciggImlkIiwgaWQgKQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmRhdGEoICJ1aS10YWJzLWRlc3Ryb3kiLCB0cnVlICk7Cgl9LAoKCV9zZXR1cERpc2FibGVkOiBmdW5jdGlvbiggZGlzYWJsZWQgKSB7CgkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCWlmICggIWRpc2FibGVkLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIGRpc2FibGVkLmxlbmd0aCA9PT0gdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gZGlzYWJsZSB0YWJzCgkJZm9yICggdmFyIGkgPSAwLCBsaTsgKCBsaSA9IHRoaXMudGFic1sgaSBdICk7IGkrKyApIHsKCQkJaWYgKCBkaXNhYmxlZCA9PT0gdHJ1ZSB8fCAkLmluQXJyYXkoIGksIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJJCggbGkgKQoJCQkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgInRydWUiICk7CgkJCX0gZWxzZSB7CgkJCQkkKCBsaSApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICk7CgkJCX0KCQl9CgoJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGRpc2FibGVkOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZXZlbnRzID0gewoJCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX07CgkJaWYgKCBldmVudCApIHsKCQkJJC5lYWNoKCBldmVudC5zcGxpdCgiICIpLCBmdW5jdGlvbiggaW5kZXgsIGV2ZW50TmFtZSApIHsKCQkJCWV2ZW50c1sgZXZlbnROYW1lIF0gPSAiX2V2ZW50SGFuZGxlciI7CgkJCX0pOwoJCX0KCgkJdGhpcy5fb2ZmKCB0aGlzLmFuY2hvcnMuYWRkKCB0aGlzLnRhYnMgKS5hZGQoIHRoaXMucGFuZWxzICkgKTsKCQl0aGlzLl9vbiggdGhpcy5hbmNob3JzLCBldmVudHMgKTsKCQl0aGlzLl9vbiggdGhpcy50YWJzLCB7IGtleWRvd246ICJfdGFiS2V5ZG93biIgfSApOwoJCXRoaXMuX29uKCB0aGlzLnBhbmVscywgeyBrZXlkb3duOiAiX3BhbmVsS2V5ZG93biIgfSApOwoKCQl0aGlzLl9mb2N1c2FibGUoIHRoaXMudGFicyApOwoJCXRoaXMuX2hvdmVyYWJsZSggdGhpcy50YWJzICk7Cgl9LAoKCV9zZXR1cEhlaWdodFN0eWxlOiBmdW5jdGlvbiggaGVpZ2h0U3R5bGUgKSB7CgkJdmFyIG1heEhlaWdodCwKCQkJcGFyZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoKCQlpZiAoIGhlaWdodFN0eWxlID09PSAiZmlsbCIgKSB7CgkJCW1heEhlaWdodCA9IHBhcmVudC5oZWlnaHQoKTsKCQkJbWF4SGVpZ2h0IC09IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpIC0gdGhpcy5lbGVtZW50LmhlaWdodCgpOwoKCQkJdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiOnZpc2libGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gJCggdGhpcyApLAoJCQkJCXBvc2l0aW9uID0gZWxlbS5jc3MoICJwb3NpdGlvbiIgKTsKCgkJCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCW1heEhlaWdodCAtPSBlbGVtLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkubm90KCB0aGlzLnBhbmVscyApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQltYXhIZWlnaHQgLT0gJCggdGhpcyApLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5oZWlnaHQoIE1hdGgubWF4KCAwLCBtYXhIZWlnaHQgLQoJCQkJCSQoIHRoaXMgKS5pbm5lckhlaWdodCgpICsgJCggdGhpcyApLmhlaWdodCgpICkgKTsKCQkJfSkKCQkJLmNzcyggIm92ZXJmbG93IiwgImF1dG8iICk7CgkJfSBlbHNlIGlmICggaGVpZ2h0U3R5bGUgPT09ICJhdXRvIiApIHsKCQkJbWF4SGVpZ2h0ID0gMDsKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCA9IE1hdGgubWF4KCBtYXhIZWlnaHQsICQoIHRoaXMgKS5oZWlnaHQoICIiICkuaGVpZ2h0KCkgKTsKCQkJfSkuaGVpZ2h0KCBtYXhIZWlnaHQgKTsKCQl9Cgl9LAoKCV9ldmVudEhhbmRsZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJYWN0aXZlID0gdGhpcy5hY3RpdmUsCgkJCWFuY2hvciA9ICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwKCQkJdGFiID0gYW5jaG9yLmNsb3Nlc3QoICJsaSIgKSwKCQkJY2xpY2tlZElzQWN0aXZlID0gdGFiWyAwIF0gPT09IGFjdGl2ZVsgMCBdLAoJCQljb2xsYXBzaW5nID0gY2xpY2tlZElzQWN0aXZlICYmIG9wdGlvbnMuY29sbGFwc2libGUsCgkJCXRvU2hvdyA9IGNvbGxhcHNpbmcgPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCXRvSGlkZSA9ICFhY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIGFjdGl2ZSApLAoJCQlldmVudERhdGEgPSB7CgkJCQlvbGRUYWI6IGFjdGl2ZSwKCQkJCW9sZFBhbmVsOiB0b0hpZGUsCgkJCQluZXdUYWI6IGNvbGxhcHNpbmcgPyAkKCkgOiB0YWIsCgkJCQluZXdQYW5lbDogdG9TaG93CgkJCX07CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCWlmICggdGFiLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgfHwKCQkJCS8vIHRhYiBpcyBhbHJlYWR5IGxvYWRpbmcKCQkJCXRhYi5oYXNDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKSB8fAoJCQkJLy8gY2FuJ3Qgc3dpdGNoIGR1cm5pbmcgYW4gYW5pbWF0aW9uCgkJCQl0aGlzLnJ1bm5pbmcgfHwKCQkJCS8vIGNsaWNrIG9uIGFjdGl2ZSBoZWFkZXIsIGJ1dCBub3QgY29sbGFwc2libGUKCQkJCSggY2xpY2tlZElzQWN0aXZlICYmICFvcHRpb25zLmNvbGxhcHNpYmxlICkgfHwKCQkJCS8vIGFsbG93IGNhbmNlbGluZyBhY3RpdmF0aW9uCgkJCQkoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVBY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKSA9PT0gZmFsc2UgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJb3B0aW9ucy5hY3RpdmUgPSBjb2xsYXBzaW5nID8gZmFsc2UgOiB0aGlzLnRhYnMuaW5kZXgoIHRhYiApOwoKCQl0aGlzLmFjdGl2ZSA9IGNsaWNrZWRJc0FjdGl2ZSA/ICQoKSA6IHRhYjsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJaWYgKCAhdG9IaWRlLmxlbmd0aCAmJiAhdG9TaG93Lmxlbmd0aCApIHsKCQkJJC5lcnJvciggImpRdWVyeSBVSSBUYWJzOiBNaXNtYXRjaGluZyBmcmFnbWVudCBpZGVudGlmaWVyLiIgKTsKCQl9CgoJCWlmICggdG9TaG93Lmxlbmd0aCApIHsKCQkJdGhpcy5sb2FkKCB0aGlzLnRhYnMuaW5kZXgoIHRhYiApLCBldmVudCApOwoJCX0KCQl0aGlzLl90b2dnbGUoIGV2ZW50LCBldmVudERhdGEgKTsKCX0sCgoJLy8gaGFuZGxlcyBzaG93L2hpZGUgZm9yIHNlbGVjdGluZyB0YWJzCglfdG9nZ2xlOiBmdW5jdGlvbiggZXZlbnQsIGV2ZW50RGF0YSApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRvU2hvdyA9IGV2ZW50RGF0YS5uZXdQYW5lbCwKCQkJdG9IaWRlID0gZXZlbnREYXRhLm9sZFBhbmVsOwoKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKCQlmdW5jdGlvbiBjb21wbGV0ZSgpIHsKCQkJdGhhdC5ydW5uaW5nID0gZmFsc2U7CgkJCXRoYXQuX3RyaWdnZXIoICJhY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKTsKCQl9CgoJCWZ1bmN0aW9uIHNob3coKSB7CgkJCWV2ZW50RGF0YS5uZXdUYWIuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoKCQkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRoYXQub3B0aW9ucy5zaG93ICkgewoJCQkJdGhhdC5fc2hvdyggdG9TaG93LCB0aGF0Lm9wdGlvbnMuc2hvdywgY29tcGxldGUgKTsKCQkJfSBlbHNlIHsKCQkJCXRvU2hvdy5zaG93KCk7CgkJCQljb21wbGV0ZSgpOwoJCQl9CgkJfQoKCQkvLyBzdGFydCBvdXQgYnkgaGlkaW5nLCB0aGVuIHNob3dpbmcsIHRoZW4gY29tcGxldGluZwoJCWlmICggdG9IaWRlLmxlbmd0aCAmJiB0aGlzLm9wdGlvbnMuaGlkZSApIHsKCQkJdGhpcy5faGlkZSggdG9IaWRlLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7CgkJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCXNob3coKTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5jbG9zZXN0KCAibGkiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCXRvSGlkZS5oaWRlKCk7CgkJCXNob3coKTsKCQl9CgoJCXRvSGlkZS5hdHRyKHsKCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQl9KTsKCQlldmVudERhdGEub2xkVGFiLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgImZhbHNlIiApOwoJCS8vIElmIHdlJ3JlIHN3aXRjaGluZyB0YWJzLCByZW1vdmUgdGhlIG9sZCB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIG9wZW5pbmcgZnJvbSBjb2xsYXBzZWQgc3RhdGUsIHJlbW92ZSB0aGUgcHJldmlvdXMgdGFiIGZyb20gdGhlIHRhYiBvcmRlci4KCQkvLyBJZiB3ZSdyZSBjb2xsYXBzaW5nLCB0aGVuIGtlZXAgdGhlIGNvbGxhcHNpbmcgdGFiIGluIHRoZSB0YWIgb3JkZXIuCgkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRvSGlkZS5sZW5ndGggKSB7CgkJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggInRhYkluZGV4IiwgLTEgKTsKCQl9IGVsc2UgaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5hdHRyKCAidGFiSW5kZXgiICkgPT09IDA7CgkJCX0pCgkJCS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0KCgkJdG9TaG93LmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCX0pOwoJCWV2ZW50RGF0YS5uZXdUYWIuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQl0YWJJbmRleDogMAoJCX0pOwoJfSwKCglfYWN0aXZhdGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgYW5jaG9yLAoJCQlhY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBpbmRleCApOwoKCQkvLyB0cnlpbmcgdG8gYWN0aXZhdGUgdGhlIGFscmVhZHkgYWN0aXZlIHBhbmVsCgkJaWYgKCBhY3RpdmVbIDAgXSA9PT0gdGhpcy5hY3RpdmVbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gdHJ5aW5nIHRvIGNvbGxhcHNlLCBzaW11bGF0ZSBhIGNsaWNrIG9uIHRoZSBjdXJyZW50IGFjdGl2ZSBoZWFkZXIKCQlpZiAoICFhY3RpdmUubGVuZ3RoICkgewoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZTsKCQl9CgoJCWFuY2hvciA9IGFjdGl2ZS5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApWyAwIF07CgkJdGhpcy5fZXZlbnRIYW5kbGVyKHsKCQkJdGFyZ2V0OiBhbmNob3IsCgkJCWN1cnJlbnRUYXJnZXQ6IGFuY2hvciwKCQkJcHJldmVudERlZmF1bHQ6ICQubm9vcAoJCX0pOwoJfSwKCglfZmluZEFjdGl2ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXJldHVybiBpbmRleCA9PT0gZmFsc2UgPyAkKCkgOiB0aGlzLnRhYnMuZXEoIGluZGV4ICk7Cgl9LAoKCV9nZXRJbmRleDogZnVuY3Rpb24oIGluZGV4ICkgewoJCS8vIG1ldGEtZnVuY3Rpb24gdG8gZ2l2ZSB1c2VycyBvcHRpb24gdG8gcHJvdmlkZSBhIGhyZWYgc3RyaW5nIGluc3RlYWQgb2YgYSBudW1lcmljYWwgaW5kZXguCgkJaWYgKCB0eXBlb2YgaW5kZXggPT09ICJzdHJpbmciICkgewoJCQlpbmRleCA9IHRoaXMuYW5jaG9ycy5pbmRleCggdGhpcy5hbmNob3JzLmZpbHRlciggIltocmVmJD0nIiArIGluZGV4ICsgIiddIiApICk7CgkJfQoKCQlyZXR1cm4gaW5kZXg7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGFicyB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWFsbCB1aS10YWJzLWNvbGxhcHNpYmxlIiApOwoKCQl0aGlzLnRhYmxpc3QKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApOwoKCQl0aGlzLmFuY2hvcnMKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1hbmNob3IiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApCgkJCS5yZW1vdmVBdHRyKCAidGFiSW5kZXgiICkKCQkJLnJlbW92ZVVuaXF1ZUlkKCk7CgoJCXRoaXMudGFicy5hZGQoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAkLmRhdGEoIHRoaXMsICJ1aS10YWJzLWRlc3Ryb3kiICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kZWZhdWx0IHVpLXN0YXRlLWFjdGl2ZSB1aS1zdGF0ZS1kaXNhYmxlZCAiICsKCQkJCQkJInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSB1aS13aWRnZXQtY29udGVudCB1aS10YWJzLWFjdGl2ZSB1aS10YWJzLXBhbmVsIiApCgkJCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1saXZlIiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWJ1c3kiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtc2VsZWN0ZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtbGFiZWxsZWRieSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1oaWRkZW4iICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZXhwYW5kZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy50YWJzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBsaSA9ICQoIHRoaXMgKSwKCQkJCXByZXYgPSBsaS5kYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQlpZiAoIHByZXYgKSB7CgkJCQlsaQoJCQkJCS5hdHRyKCAiYXJpYS1jb250cm9scyIsIHByZXYgKQoJCQkJCS5yZW1vdmVEYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQl9IGVsc2UgewoJCQkJbGkucmVtb3ZlQXR0ciggImFyaWEtY29udHJvbHMiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5wYW5lbHMuc2hvdygpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgewoJCQl0aGlzLnBhbmVscy5jc3MoICJoZWlnaHQiLCAiIiApOwoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWFwKCBkaXNhYmxlZCwgZnVuY3Rpb24oIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIHRoaXMudGFicywgZnVuY3Rpb24oIGxpLCBudW0gKSB7CgkJCQkJcmV0dXJuIG51bSAhPT0gaW5kZXggPyBudW0gOiBudWxsOwoJCQkJfSk7CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBkaXNhYmxlZCA9IHRoaXMub3B0aW9ucy5kaXNhYmxlZDsKCQlpZiAoIGRpc2FibGVkID09PSB0cnVlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gdHJ1ZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaW5BcnJheSggaW5kZXgsIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggJC5pc0FycmF5KCBkaXNhYmxlZCApICkgewoJCQkJZGlzYWJsZWQgPSAkLm1lcmdlKCBbIGluZGV4IF0sIGRpc2FibGVkICkuc29ydCgpOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSBbIGluZGV4IF07CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJbG9hZDogZnVuY3Rpb24oIGluZGV4LCBldmVudCApIHsKCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCXZhciB0aGF0ID0gdGhpcywKCQkJdGFiID0gdGhpcy50YWJzLmVxKCBpbmRleCApLAoJCQlhbmNob3IgPSB0YWIuZmluZCggIi51aS10YWJzLWFuY2hvciIgKSwKCQkJcGFuZWwgPSB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCXRhYjogdGFiLAoJCQkJcGFuZWw6IHBhbmVsCgkJCX07CgoJCS8vIG5vdCByZW1vdGUKCQlpZiAoIGlzTG9jYWwoIGFuY2hvclsgMCBdICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMueGhyID0gJC5hamF4KCB0aGlzLl9hamF4U2V0dGluZ3MoIGFuY2hvciwgZXZlbnQsIGV2ZW50RGF0YSApICk7CgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJLy8galF1ZXJ5IDwxLjggcmV0dXJucyBmYWxzZSBpZiB0aGUgcmVxdWVzdCBpcyBjYW5jZWxlZCBpbiBiZWZvcmVTZW5kLAoJCS8vIGJ1dCBhcyBvZiAxLjgsICQuYWpheCgpIGFsd2F5cyByZXR1cm5zIGEganFYSFIgb2JqZWN0LgoJCWlmICggdGhpcy54aHIgJiYgdGhpcy54aHIuc3RhdHVzVGV4dCAhPT0gImNhbmNlbGVkIiApIHsKCQkJdGFiLmFkZENsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQlwYW5lbC5hdHRyKCAiYXJpYS1idXN5IiwgInRydWUiICk7CgoJCQl0aGlzLnhocgoJCQkJLnN1Y2Nlc3MoZnVuY3Rpb24oIHJlc3BvbnNlICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlwYW5lbC5odG1sKCByZXNwb25zZSApOwoJCQkJCQl0aGF0Ll90cmlnZ2VyKCAibG9hZCIsIGV2ZW50LCBldmVudERhdGEgKTsKCQkJCQl9LCAxICk7CgkJCQl9KQoJCQkJLmNvbXBsZXRlKGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHN0YXR1cyA9PT0gImFib3J0IiApIHsKCQkJCQkJCXRoYXQucGFuZWxzLnN0b3AoIGZhbHNlLCB0cnVlICk7CgkJCQkJCX0KCgkJCQkJCXRhYi5yZW1vdmVDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKTsKCQkJCQkJcGFuZWwucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKTsKCgkJCQkJCWlmICgganFYSFIgPT09IHRoYXQueGhyICkgewoJCQkJCQkJZGVsZXRlIHRoYXQueGhyOwoJCQkJCQl9CgkJCQkJfSwgMSApOwoJCQkJfSk7CgkJfQoJfSwKCglfYWpheFNldHRpbmdzOiBmdW5jdGlvbiggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpczsKCQlyZXR1cm4gewoJCQl1cmw6IGFuY2hvci5hdHRyKCAiaHJlZiIgKSwKCQkJYmVmb3JlU2VuZDogZnVuY3Rpb24oIGpxWEhSLCBzZXR0aW5ncyApIHsKCQkJCXJldHVybiB0aGF0Ll90cmlnZ2VyKCAiYmVmb3JlTG9hZCIsIGV2ZW50LAoJCQkJCSQuZXh0ZW5kKCB7IGpxWEhSIDoganFYSFIsIGFqYXhTZXR0aW5nczogc2V0dGluZ3MgfSwgZXZlbnREYXRhICkgKTsKCQkJfQoJCX07Cgl9LAoKCV9nZXRQYW5lbEZvclRhYjogZnVuY3Rpb24oIHRhYiApIHsKCQl2YXIgaWQgPSAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMuX3Nhbml0aXplU2VsZWN0b3IoICIjIiArIGlkICkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IHRydWU7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCgl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCXpvb20sCgkJZXZ0LCB4LCB5LCB6LCBhaWc7CglpZiAoICEoIC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiAvT1MgWzEtNV1fWzAtOV9dKiBsaWtlIE1hYyBPUyBYL2kudGVzdCggdWEgKSAmJiB1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSApICkgewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl6b29tID0gJC5tb2JpbGUuem9vbTsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICkgewoJCQkkLm1vYmlsZS53aW5kb3cKCQkJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoJCX0KCX0pOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJZnVuY3Rpb24gaGlkZVJlbmRlcmluZ0NsYXNzKCkgewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCQkJJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICksCgkJCQloYXNoID0gcGF0aC5zdHJpcEhhc2goIHBhdGguc3RyaXBRdWVyeVBhcmFtcyhwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApLAoJCQkJaGFzaFBhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaGFzaCApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRwYWdlcyA9ICQoICJib2R5IiApLndyYXBJbm5lciggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+PC9kaXY+IiApLmNoaWxkcmVuKCAwICk7CgkJCX0KCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJLy8gdW5sZXNzIHRoZSBkYXRhIHVybCBpcyBhbHJlYWR5IHNldCBzZXQgaXQgdG8gdGhlIHBhdGhuYW1lCgkJCQlpZiAoICEkdGhpc1sgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkLm1vYmlsZS5maXJzdFBhZ2UKCQkJCS5wYXJlbnQoKQoJCQkJLmFkZENsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0IiApCgkJCQkucGFnZWNvbnRhaW5lcigpOwoKCQkJLy8gaW5pdGlhbGl6ZSBuYXZpZ2F0aW9uIGV2ZW50cyBub3csIGFmdGVyIG1vYmlsZWluaXQgaGFzIG9jY3VycmVkIGFuZCB0aGUgcGFnZSBjb250YWluZXIKCQkJLy8gaGFzIGJlZW4gY3JlYXRlZCBidXQgYmVmb3JlIHRoZSByZXN0IG9mIHRoZSBsaWJyYXJ5IGlzIGFsZXJ0ZWQgdG8gdGhhdCBmYWN0CgkJCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOwoKCQkJLy8gYWxlcnQgbGlzdGVuZXJzIHRoYXQgdGhlIHBhZ2Vjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCBmb3IgYmluZGluZwoJCQkvLyB0byBldmVudHMgdHJpZ2dlcmVkIG9uIGl0CgkJCSR3aW5kb3cudHJpZ2dlciggInBhZ2Vjb250YWluZXJjcmVhdGUiICk7CgoJCQkvLyBjdWUgcGFnZSBsb2FkaW5nIG1lc3NhZ2UKCQkJJC5tb2JpbGUubG9hZGluZyggInNob3ciICk7CgoJCQkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCgkJCWhpZGVSZW5kZXJpbmdDbGFzcygpOwoKCQkJLy8gaWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQsIHRoZXJlJ3Mgbm8gaGFzaCBkZWVwbGluaywKCQkJLy8gdGhlIGhhc2ggaXMgbm90IHZhbGlkIChjb250YWlucyBtb3JlIHRoYW4gb25lICMgb3IgZG9lcyBub3Qgc3RhcnQgd2l0aCAjKQoJCQkvLyBvciB0aGVyZSBpcyBubyBwYWdlIHdpdGggdGhhdCBoYXNoLCBjaGFuZ2UgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIERPTQoJCQkvLyBSZW1lbWJlciwgaG93ZXZlciwgdGhhdCB0aGUgaGFzaCBjYW4gYWxzbyBiZSBhIHBhdGghCgkJCWlmICggISAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSggJCggaGFzaFBhZ2UgKS5pcyggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSB8fAoJCQkJCSQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICkgfHwKCQkJCQloYXNoID09PSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgKSApIHsKCgkJCQkvLyBTdG9yZSB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbgoJCQkJaWYgKCAkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5pbml0aWFsRHN0ID0gaGFzaC5yZXBsYWNlKCAiIyIsICIiICk7CgkJCQl9CgoJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCBpbml0aWFsIHBvcHN0YXRlIHN0YXRlIGlmIGl0IGV4aXN0cwoJCQkJLy8gc28gdGhhdCBuYXZpZ2F0aW9uIGJhY2sgdG8gdGhlIGluaXRpYWwgcGFnZSB3b3JrcyBwcm9wZXJseQoJCQkJaWYgKCAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLnNxdWFzaCggcGF0aC5wYXJzZUxvY2F0aW9uKCkuaHJlZiApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgewoJCQkJCXRyYW5zaXRpb246ICJub25lIiwKCQkJCQlyZXZlcnNlOiB0cnVlLAoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCS8vIHRyaWdnZXIgaGFzaGNoYW5nZSBvciBuYXZpZ2F0ZSB0byBzcXVhc2ggYW5kIHJlY29yZCB0aGUgY29ycmVjdAoJCQkJLy8gaGlzdG9yeSBlbnRyeSBmb3IgYW4gaW5pdGlhbCBoYXNoIHBhdGgKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkd2luZG93LnRyaWdnZXIoICJoYXNoY2hhbmdlIiwgW3RydWVdICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIFRPRE8gZmlndXJlIG91dCBob3cgdG8gc2ltcGxpZnkgdGhpcyBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCQkvLyBhdCB0aGUgYm90dG9tIGpzL25hdmlnYXRlL25hdmlnYXRlLmpzCgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5zdGFjayA9IFtdOwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggbG9jYXRpb24uaGFzaCApID8gbG9jYXRpb24uaGFzaCA6IGxvY2F0aW9uLmhyZWYgKTsKCQkJCX0KCQkJfQoJCX0KCX0pOwoKCSQoZnVuY3Rpb24oKSB7CgkJLy9SdW4gaW5saW5lU1ZHIHN1cHBvcnQgdGVzdAoJCSQuc3VwcG9ydC5pbmxpbmVTVkcoKTsKCgkJLy8gY2hlY2sgd2hpY2ggc2Nyb2xsVG9wIHZhbHVlIHNob3VsZCBiZSB1c2VkIGJ5IHNjcm9sbGluZyB0byAxIGltbWVkaWF0ZWx5IGF0IGRvbXJlYWR5CgkJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCQkvLyBub3RlIHRoYXQgdGhpcyBpbml0aWFsIHNjcm9sbCB3b24ndCBoaWRlIHRoZSBhZGRyZXNzIGJhci4gSXQncyBqdXN0IGZvciB0aGUgY2hlY2suCgoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQgaWYgaGlkZVVybEJhciBpcyB0cnVlIHRoaXMgaXMgdG8gdHJ5IGFuZCBkbyBpdCBhcyBzb29uIGFzIHBvc3NpYmxlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCQl9CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkIGlmIGhpZGVVcmxCYXIgaXMgdHJ1ZSB0aGlzIGlzIGFzIGZhbGwgYmFjayBpbmNhc2Ugd2Ugd2VyZSB0b28gZWFybHkgYmVmb3JlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoJCX0KCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSB1aS1kaXNhYmxlZCBhZnRlciAxLjQuMCByZWxlYXNlCgkJCS8vIG9ubHkgdWktc3RhdGUtZGlzYWJsZWQgc2hvdWxkIGJlIHByZXNlbnQgdGhlcmVhZnRlcgoJCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1zdGF0ZS1kaXNhYmxlZCwudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "body": "LyohCiogalF1ZXJ5IE1vYmlsZSAxLjQuMgoqIEdpdCBIRUFEIGhhc2g6IDlkOWE0MmEyN2QwYzY5M2U4YjU1NjljM2ExMGQ3NzE5MTZhZjUwNDUgPD4gRGF0ZTogRnJpIEZlYiAyOCAyMDE0IDE3OjMyOjAxIFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxNCBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwoKCihmdW5jdGlvbiAoIHJvb3QsIGRvYywgZmFjdG9yeSApIHsKCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlkZWZpbmUoIFsgImpxdWVyeSIgXSwgZnVuY3Rpb24gKCAkICkgewoJCQlmYWN0b3J5KCAkLCByb290LCBkb2MgKTsKCQkJcmV0dXJuICQubW9iaWxlOwoJCX0pOwoJfSBlbHNlIHsKCQkvLyBCcm93c2VyIGdsb2JhbHMKCQlmYWN0b3J5KCByb290LmpRdWVyeSwgcm9vdCwgZG9jICk7Cgl9Cn0oIHRoaXMsIGRvY3VtZW50LCBmdW5jdGlvbiAoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewooZnVuY3Rpb24oICQgKSB7CgkkLm1vYmlsZSA9IHt9Owp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuNC4yIiwKCgkJLy8gRGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIHVzZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCWhpZGVVcmxCYXI6IHRydWUsCgoJCS8vIEtlZXBuYXRpdmUgU2VsZWN0b3IKCQlrZWVwTmF0aXZlOiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQkvLyBEZXByZWNhdGVkIHJlbW92ZSBpbiAxLjUKCQltaW5TY3JvbGxCYWNrOiAwLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZXM/CgkJcGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZTogImEiLAoKCQkvLyByZXBsYWNlIGNhbGxzIHRvIHdpbmRvdy5oaXN0b3J5LmJhY2sgd2l0aCBwaG9uZWdhcHMgbmF2aWdhdGlvbiBoZWxwZXIKCQkvLyB3aGVyZSBpdCBpcyBwcm92aWRlZCBvbiB0aGUgd2luZG93IG9iamVjdAoJCXBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQ6IGZhbHNlLAoKCQkvL2F1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgRE9NIHdoZW4gaXQncyByZWFkeQoJCWF1dG9Jbml0aWFsaXplUGFnZTogdHJ1ZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gYWxsb3dzIHVzZXJzIHRvIG9wdCBpbiB0byBpZ25vcmluZyBjb250ZW50IGJ5IG1hcmtpbmcgYSBwYXJlbnQgZWxlbWVudCBhcwoJCS8vIGRhdGEtaWdub3JlZAoJCWlnbm9yZUNvbnRlbnRFbmFibGVkOiBmYWxzZSwKCgkJYnV0dG9uTWFya3VwOiB7CgkJCWhvdmVyRGVsYXk6IDIwMAoJCX0sCgoJCS8vIGRpc2FibGUgdGhlIGFsdGVyYXRpb24gb2YgdGhlIGR5bmFtaWMgYmFzZSB0YWcgb3IgbGlua3MgaW4gdGhlIGNhc2UKCQkvLyB0aGF0IGEgZHluYW1pYyBiYXNlIHRhZyBpc24ndCBzdXBwb3J0ZWQKCQlkeW5hbWljQmFzZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGRlZmF1bHQgdGhlIHByb3BlcnR5IHRvIHJlbW92ZSBkZXBlbmRlbmN5IG9uIGFzc2lnbm1lbnQgaW4gaW5pdCBtb2R1bGUKCQlwYWdlQ29udGFpbmVyOiAkKCksCgoJCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCQlhbGxvd0Nyb3NzRG9tYWluUGFnZXM6IGZhbHNlLAoKCQlkaWFsb2dIYXNoS2V5OiAiJnVpLXN0YXRlPWRpYWxvZyIKCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9LAoJCW9sZEZpbmQgPSAkLmZpbmQsCgkJcmJyYWNlID0gLyg/Olx7W1xzXFNdKlx9fFxbW1xzXFNdKlxdKSQvLAoJCWpxbURhdGFSRSA9IC86anFtRGF0YVwoKFteKV0qKVwpL2c7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIE5hbWVzcGFjZSB1c2VkIGZyYW1ld29yay13aWRlIGZvciBkYXRhLWF0dHJzLiBEZWZhdWx0IGlzIG5vIG5hbWVzcGFjZQoKCQluczogIiIsCgoJCS8vIFJldHJpZXZlIGFuIGF0dHJpYnV0ZSBmcm9tIGFuIGVsZW1lbnQgYW5kIHBlcmZvcm0gc29tZSBtYXNzYWdpbmcgb2YgdGhlIHZhbHVlCgoJCWdldEF0dHJpYnV0ZTogZnVuY3Rpb24oIGVsZW1lbnQsIGtleSApIHsKCQkJdmFyIGRhdGE7CgoJCQllbGVtZW50ID0gZWxlbWVudC5qcXVlcnkgPyBlbGVtZW50WzBdIDogZWxlbWVudDsKCgkJCWlmICggZWxlbWVudCAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZSApIHsKCQkJCWRhdGEgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsga2V5ICk7CgkJCX0KCgkJCS8vIENvcGllZCBmcm9tIGNvcmUncyBzcmMvZGF0YS5qczpkYXRhQXR0cigpCgkJCS8vIENvbnZlcnQgZnJvbSBhIHN0cmluZyB0byBhIHByb3BlciBkYXRhIHR5cGUKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQlkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkJK2RhdGEgKyAiIiA9PT0gZGF0YSA/ICtkYXRhIDoKCQkJCQlyYnJhY2UudGVzdCggZGF0YSApID8gSlNPTi5wYXJzZSggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlcnIgKSB7fQoKCQkJcmV0dXJuIGRhdGE7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8CgkJCQkoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCS5kYXRhKCAibW9iaWxlLXBhZ2UiICk7CgkJfQoKCX0pOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlpZiAoIHByb3AgKSB7CgkJCQlwcm9wID0gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKTsKCQkJfQoKCQkJLy8gdW5kZWZpbmVkIGlzIHBlcm1pdHRlZCBhcyBhbiBleHBsaWNpdCBpbnB1dCBmb3IgdGhlIHNlY29uZCBwYXJhbQoJCQkvLyBpbiB0aGlzIGNhc2UgaXQgcmV0dXJucyB0aGUgdmFsdWUgYW5kIGRvZXMgbm90IHNldCBpdCB0byB1bmRlZmluZWQKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5maW5kID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICkgewoJCWlmICggc2VsZWN0b3IuaW5kZXhPZiggIjpqcW1EYXRhIiApID4gLTEgKSB7CgkJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgganFtRGF0YVJFLCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICIkMV0iICk7CgkJfQoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKiEKICogalF1ZXJ5IFVJIENvcmUgYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MAogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NhdGVnb3J5L3VpLWNvcmUvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXJ1bmlxdWVJZCA9IC9edWktaWQtXGQrJC87CgovLyAkLnVpIG1pZ2h0IGV4aXN0IGZyb20gY29tcG9uZW50cyB3aXRoIG5vIGRlcGVuZGVuY2llcywgZS5nLiwgJC51aS5wb3NpdGlvbgokLnVpID0gJC51aSB8fCB7fTsKCiQuZXh0ZW5kKCAkLnVpLCB7Cgl2ZXJzaW9uOiAiYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MCIsCgoJa2V5Q29kZTogewoJCUJBQ0tTUEFDRTogOCwKCQlDT01NQTogMTg4LAoJCURFTEVURTogNDYsCgkJRE9XTjogNDAsCgkJRU5EOiAzNSwKCQlFTlRFUjogMTMsCgkJRVNDQVBFOiAyNywKCQlIT01FOiAzNiwKCQlMRUZUOiAzNywKCQlQQUdFX0RPV046IDM0LAoJCVBBR0VfVVA6IDMzLAoJCVBFUklPRDogMTkwLAoJCVJJR0hUOiAzOSwKCQlTUEFDRTogMzIsCgkJVEFCOiA5LAoJCVVQOiAzOAoJfQp9KTsKCi8vIHBsdWdpbnMKJC5mbi5leHRlbmQoewoJZm9jdXM6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGRlbGF5LCBmbiApIHsKCQkJcmV0dXJuIHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgPwoJCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtID0gdGhpczsKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJCQkJaWYgKCBmbiApIHsKCQkJCQkJCWZuLmNhbGwoIGVsZW0gKTsKCQkJCQkJfQoJCQkJCX0sIGRlbGF5ICk7CgkJCQl9KSA6CgkJCQlvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSkoICQuZm4uZm9jdXMgKSwKCglzY3JvbGxQYXJlbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JvbGxQYXJlbnQ7CgkJaWYgKCgkLnVpLmllICYmICgvKHN0YXRpY3xyZWxhdGl2ZSkvKS50ZXN0KHRoaXMuY3NzKCJwb3NpdGlvbiIpKSkgfHwgKC9hYnNvbHV0ZS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB7CgkJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoLyhyZWxhdGl2ZXxhYnNvbHV0ZXxmaXhlZCkvKS50ZXN0KCQuY3NzKHRoaXMsInBvc2l0aW9uIikpICYmICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfSBlbHNlIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfQoKCQlyZXR1cm4gKCAvZml4ZWQvICkudGVzdCggdGhpcy5jc3MoICJwb3NpdGlvbiIpICkgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApIDogc2Nyb2xsUGFyZW50OwoJfSwKCgl1bmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5pZCApIHsKCQkJCXRoaXMuaWQgPSAidWktaWQtIiArICgrK3V1aWQpOwoJCQl9CgkJfSk7Cgl9LAoKCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHJ1bmlxdWVJZC50ZXN0KCB0aGlzLmlkICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggImlkIiApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy8gc2VsZWN0b3JzCmZ1bmN0aW9uIGZvY3VzYWJsZSggZWxlbWVudCwgaXNUYWJJbmRleE5vdE5hTiApIHsKCXZhciBtYXAsIG1hcE5hbWUsIGltZywKCQlub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsKCQltYXAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJbWFwTmFtZSA9IG1hcC5uYW1lOwoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaW1nID0gJCggImltZ1t1c2VtYXA9IyIgKyBtYXBOYW1lICsgIl0iIClbMF07CgkJcmV0dXJuICEhaW1nICYmIHZpc2libGUoIGltZyApOwoJfQoJcmV0dXJuICggL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0Ly50ZXN0KCBub2RlTmFtZSApID8KCQkhZWxlbWVudC5kaXNhYmxlZCA6CgkJImEiID09PSBub2RlTmFtZSA/CgkJCWVsZW1lbnQuaHJlZiB8fCBpc1RhYkluZGV4Tm90TmFOIDoKCQkJaXNUYWJJbmRleE5vdE5hTikgJiYKCQkvLyB0aGUgZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBhbmNlc3RvcnMgbXVzdCBiZSB2aXNpYmxlCgkJdmlzaWJsZSggZWxlbWVudCApOwp9CgpmdW5jdGlvbiB2aXNpYmxlKCBlbGVtZW50ICkgewoJcmV0dXJuICQuZXhwci5maWx0ZXJzLnZpc2libGUoIGVsZW1lbnQgKSAmJgoJCSEkKCBlbGVtZW50ICkucGFyZW50cygpLmFkZEJhY2soKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLmNzcyggdGhpcywgInZpc2liaWxpdHkiICkgPT09ICJoaWRkZW4iOwoJCX0pLmxlbmd0aDsKfQoKJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oZnVuY3Rpb24oIGRhdGFOYW1lICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGRhdGFOYW1lICk7CgkJCX07CgkJfSkgOgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9LAoKCWZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzTmFOKCAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSApICk7Cgl9LAoKCXRhYmJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwKCQkJaXNUYWJJbmRleE5hTiA9IGlzTmFOKCB0YWJJbmRleCApOwoJCXJldHVybiAoIGlzVGFiSW5kZXhOYU4gfHwgdGFiSW5kZXggPj0gMCApICYmIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzVGFiSW5kZXhOYU4gKTsKCX0KfSk7CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkKCAiPGE+IiApLm91dGVyV2lkdGgoIDEgKS5qcXVlcnkgKSB7CgkkLmVhY2goIFsgIldpZHRoIiwgIkhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJdmFyIHNpZGUgPSBuYW1lID09PSAiV2lkdGgiID8gWyAiTGVmdCIsICJSaWdodCIgXSA6IFsgIlRvcCIsICJCb3R0b20iIF0sCgkJCXR5cGUgPSBuYW1lLnRvTG93ZXJDYXNlKCksCgkJCW9yaWcgPSB7CgkJCQlpbm5lcldpZHRoOiAkLmZuLmlubmVyV2lkdGgsCgkJCQlpbm5lckhlaWdodDogJC5mbi5pbm5lckhlaWdodCwKCQkJCW91dGVyV2lkdGg6ICQuZm4ub3V0ZXJXaWR0aCwKCQkJCW91dGVySGVpZ2h0OiAkLmZuLm91dGVySGVpZ2h0CgkJCX07CgoJCWZ1bmN0aW9uIHJlZHVjZSggZWxlbSwgc2l6ZSwgYm9yZGVyLCBtYXJnaW4gKSB7CgkJCSQuZWFjaCggc2lkZSwgZnVuY3Rpb24oKSB7CgkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAicGFkZGluZyIgKyB0aGlzICkgKSB8fCAwOwoJCQkJaWYgKCBib3JkZXIgKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgImJvcmRlciIgKyB0aGlzICsgIldpZHRoIiApICkgfHwgMDsKCQkJCX0KCQkJCWlmICggbWFyZ2luICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJtYXJnaW4iICsgdGhpcyApICkgfHwgMDsKCQkJCX0KCQkJfSk7CgkJCXJldHVybiBzaXplOwoJCX0KCgkJJC5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplICkgewoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBvcmlnWyAiaW5uZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOwoJCQl9KTsKCQl9OwoKCQkkLmZuWyAib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgewoJCQlpZiAoIHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiApIHsKCQkJCXJldHVybiBvcmlnWyAib3V0ZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMsIHNpemUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMpLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplLCB0cnVlLCBtYXJnaW4gKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCX0pOwp9CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgovLyBzdXBwb3J0OiBqUXVlcnkgMS42LjEsIDEuNi4yIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzKQppZiAoICQoICI8YT4iICkuZGF0YSggImEtYiIsICJhIiApLnJlbW92ZURhdGEoICJhLWIiICkuZGF0YSggImEtYiIgKSApIHsKCSQuZm4ucmVtb3ZlRGF0YSA9IChmdW5jdGlvbiggcmVtb3ZlRGF0YSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGtleSApIHsKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcywgJC5jYW1lbENhc2UoIGtleSApICk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4ucmVtb3ZlRGF0YSApOwp9CgoKCgoKLy8gZGVwcmVjYXRlZAokLnVpLmllID0gISEvbXNpZSBbXHcuXSsvLmV4ZWMoIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSApOwoKJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CiQuZm4uZXh0ZW5kKHsKCWRpc2FibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmJpbmQoICggJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID8gInNlbGVjdHN0YXJ0IiA6ICJtb3VzZWRvd24iICkgKwoJCQkiLnVpLWRpc2FibGVTZWxlY3Rpb24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0sCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy51bmJpbmQoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0sCgoJekluZGV4OiBmdW5jdGlvbiggekluZGV4ICkgewoJCWlmICggekluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmNzcyggInpJbmRleCIsIHpJbmRleCApOwoJCX0KCgkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzWyAwIF0gKSwgcG9zaXRpb24sIHZhbHVlOwoJCQl3aGlsZSAoIGVsZW0ubGVuZ3RoICYmIGVsZW1bIDAgXSAhPT0gZG9jdW1lbnQgKSB7CgkJCQkvLyBJZ25vcmUgei1pbmRleCBpZiBwb3NpdGlvbiBpcyBzZXQgdG8gYSB2YWx1ZSB3aGVyZSB6LWluZGV4IGlzIGlnbm9yZWQgYnkgdGhlIGJyb3dzZXIKCQkJCS8vIFRoaXMgbWFrZXMgYmVoYXZpb3Igb2YgdGhpcyBmdW5jdGlvbiBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycwoJCQkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZAoJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gInJlbGF0aXZlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQkvLyBJRSByZXR1cm5zIDAgd2hlbiB6SW5kZXggaXMgbm90IHNwZWNpZmllZAoJCQkJCS8vIG90aGVyIGJyb3dzZXJzIHJldHVybiBhIHN0cmluZwoJCQkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwCgkJCQkJLy8gPGRpdiBzdHlsZT0iei1pbmRleDogLTEwOyI+PGRpdiBzdHlsZT0iei1pbmRleDogMDsiPjwvZGl2PjwvZGl2PgoJCQkJCXZhbHVlID0gcGFyc2VJbnQoIGVsZW0uY3NzKCAiekluZGV4IiApLCAxMCApOwoJCQkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgewoJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJfQoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ucGFyZW50KCk7CgkJCX0KCQl9CgoJCXJldHVybiAwOwoJfQp9KTsKCi8vICQudWkucGx1Z2luIGlzIGRlcHJlY2F0ZWQuIFVzZSAkLndpZGdldCgpIGV4dGVuc2lvbnMgaW5zdGVhZC4KJC51aS5wbHVnaW4gPSB7CglhZGQ6IGZ1bmN0aW9uKCBtb2R1bGUsIG9wdGlvbiwgc2V0ICkgewoJCXZhciBpLAoJCQlwcm90byA9ICQudWlbIG1vZHVsZSBdLnByb3RvdHlwZTsKCQlmb3IgKCBpIGluIHNldCApIHsKCQkJcHJvdG8ucGx1Z2luc1sgaSBdID0gcHJvdG8ucGx1Z2luc1sgaSBdIHx8IFtdOwoJCQlwcm90by5wbHVnaW5zWyBpIF0ucHVzaCggWyBvcHRpb24sIHNldFsgaSBdIF0gKTsKCQl9Cgl9LAoJY2FsbDogZnVuY3Rpb24oIGluc3RhbmNlLCBuYW1lLCBhcmdzLCBhbGxvd0Rpc2Nvbm5lY3RlZCApIHsKCQl2YXIgaSwKCQkJc2V0ID0gaW5zdGFuY2UucGx1Z2luc1sgbmFtZSBdOwoKCQlpZiAoICFzZXQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIWFsbG93RGlzY29ubmVjdGVkICYmICggIWluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlIHx8IGluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQlzZXRbIGkgXVsgMSBdLmFwcGx5KCBpbnN0YW5jZS5lbGVtZW50LCBhcmdzICk7CgkJCX0KCQl9Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKCS8vIFN1YnRyYWN0IHRoZSBoZWlnaHQgb2YgZXh0ZXJuYWwgdG9vbGJhcnMgZnJvbSB0aGUgcGFnZSBoZWlnaHQsIGlmIHRoZSBwYWdlIGRvZXMgbm90IGhhdmUKCS8vIGludGVybmFsIHRvb2xiYXJzIG9mIHRoZSBzYW1lIHR5cGUKCXZhciBjb21wZW5zYXRlVG9vbGJhcnMgPSBmdW5jdGlvbiggcGFnZSwgZGVzaXJlZEhlaWdodCApIHsKCQl2YXIgcGFnZVBhcmVudCA9IHBhZ2UucGFyZW50KCksCgkJCXRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0ID0gW10sCgkJCWV4dGVybmFsSGVhZGVycyA9IHBhZ2VQYXJlbnQuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSwKCQkJaW50ZXJuYWxIZWFkZXJzID0gcGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLAoJCQlleHRlcm5hbEZvb3RlcnMgPSBwYWdlUGFyZW50LmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nZm9vdGVyJykiICksCgkJCWludGVybmFsRm9vdGVycyA9IHBhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKTsKCgkJLy8gSWYgd2UgaGF2ZSBubyBpbnRlcm5hbCBoZWFkZXJzLCBidXQgd2UgZG8gaGF2ZSBleHRlcm5hbCBoZWFkZXJzLCB0aGVuIHRoZWlyIGhlaWdodAoJCS8vIHJlZHVjZXMgdGhlIHBhZ2UgaGVpZ2h0CgkJaWYgKCBpbnRlcm5hbEhlYWRlcnMubGVuZ3RoID09PSAwICYmIGV4dGVybmFsSGVhZGVycy5sZW5ndGggPiAwICkgewoJCQl0b29sYmFyc0FmZmVjdGluZ0hlaWdodCA9IHRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0LmNvbmNhdCggZXh0ZXJuYWxIZWFkZXJzLnRvQXJyYXkoKSApOwoJCX0KCgkJLy8gSWYgd2UgaGF2ZSBubyBpbnRlcm5hbCBmb290ZXJzLCBidXQgd2UgZG8gaGF2ZSBleHRlcm5hbCBmb290ZXJzLCB0aGVuIHRoZWlyIGhlaWdodAoJCS8vIHJlZHVjZXMgdGhlIHBhZ2UgaGVpZ2h0CgkJaWYgKCBpbnRlcm5hbEZvb3RlcnMubGVuZ3RoID09PSAwICYmIGV4dGVybmFsRm9vdGVycy5sZW5ndGggPiAwICkgewoJCQl0b29sYmFyc0FmZmVjdGluZ0hlaWdodCA9IHRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0LmNvbmNhdCggZXh0ZXJuYWxGb290ZXJzLnRvQXJyYXkoKSApOwoJCX0KCgkJJC5lYWNoKCB0b29sYmFyc0FmZmVjdGluZ0hlaWdodCwgZnVuY3Rpb24oIGluZGV4LCB2YWx1ZSApIHsKCQkJZGVzaXJlZEhlaWdodCAtPSAkKCB2YWx1ZSApLm91dGVySGVpZ2h0KCk7CgkJfSk7CgoJCS8vIEhlaWdodCBtdXN0IGJlIGF0IGxlYXN0IHplcm8KCQlyZXR1cm4gTWF0aC5tYXgoIDAsIGRlc2lyZWRIZWlnaHQgKTsKCX07CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETzogUmVtb3ZlIGFuZCB1c2UgJC51aS5rZXlDb2RlIGRpcmVjdGx5CgkJa2V5Q29kZTogJC51aS5rZXlDb2RlLAoKCQkvLyBQbGFjZSB0byBzdG9yZSB2YXJpb3VzIHdpZGdldCBleHRlbnNpb25zCgkJYmVoYXZpb3JzOiB7fSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJZ2V0Q2xvc2VzdEJhc2VVcmw6IGZ1bmN0aW9uKCBlbGUgKQl7CgkJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQkJYmFzZSA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgfHwgIXVybCB8fCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIHVybCApICkgewoJCQkJdXJsID0gYmFzZTsKCQkJfQoKCQkJcmV0dXJuICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UgKTsKCQl9LAoJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzczogZnVuY3Rpb24oIGZvcmNlUmVtb3ZhbCApIHsKCQkJaWYgKCAhISQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkoICEkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwKCQkJCQlmb3JjZVJlbW92YWwgKSApIHsKCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9IG51bGw7CgkJfSwKCgkJLy8gREVQUkVDQVRFRCBpbiAxLjQKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCBlbGVtZW50cyApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoIGVsZW1lbnRzLCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggZWxlbWVudHMgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCBlbGVtZW50cywgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gZWxlbWVudHM7CgkJCX0KCgkJCXZhciBjb3VudCA9IGVsZW1lbnRzLmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQsCgkJCQlpLCBjOwoKCQkJZm9yICggaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSBlbGVtZW50cy5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSBlbGVtZW50c1sgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQljID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0sCgoJCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCQlyZXNldEFjdGl2ZVBhZ2VIZWlnaHQ6IGZ1bmN0aW9uKCBoZWlnaHQgKSB7CgkJCXZhciBwYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCQlwYWdlSGVpZ2h0ID0gcGFnZS5oZWlnaHQoKSwKCQkJCXBhZ2VPdXRlckhlaWdodCA9IHBhZ2Uub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCWhlaWdodCA9IGNvbXBlbnNhdGVUb29sYmFycyggcGFnZSwKCQkJCSggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKSA/IGhlaWdodCA6ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpICk7CgoJCQlwYWdlLmNzcyggIm1pbi1oZWlnaHQiLCBoZWlnaHQgLSAoIHBhZ2VPdXRlckhlaWdodCAtIHBhZ2VIZWlnaHQgKSApOwoJCX0sCgoJCWxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCBjYWxsIHRvIHRoaXMgZnVuY3Rpb24sIGluc3RhbnRpYXRlIGEgbG9hZGVyIHdpZGdldAoJCQl2YXIgbG9hZGVyID0gdGhpcy5sb2FkaW5nLl93aWRnZXQgfHwgJCggJC5tb2JpbGUubG9hZGVyLnByb3RvdHlwZS5kZWZhdWx0SHRtbCApLmxvYWRlcigpLAoKCQkJCS8vIENhbGwgdGhlIGFwcHJvcHJpYXRlIG1ldGhvZCBvbiB0aGUgbG9hZGVyCgkJCQlyZXR1cm5WYWx1ZSA9IGxvYWRlci5sb2FkZXIuYXBwbHkoIGxvYWRlciwgYXJndW1lbnRzICk7CgoJCQkvLyBNYWtlIHN1cmUgdGhlIGxvYWRlciBpcyByZXRhaW5lZCBmb3IgZnV0dXJlIGNhbGxzIHRvIHRoaXMgZnVuY3Rpb24uCgkJCXRoaXMubG9hZGluZy5fd2lkZ2V0ID0gbG9hZGVyOwoKCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCX0KCX0pOwoKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtLCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKSwKCQkJZGVwZW5kZW50cyA9ICRlbGVtLmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKTsKCgkJJGVsZW0uanFtRGF0YSggImRlcGVuZGVudHMiLCAkKCBkZXBlbmRlbnRzICkuYWRkKCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJLy8gcGx1Z2lucwoJJC5mbi5leHRlbmQoewoJCXJlbW92ZVdpdGhEZXBlbmRlbnRzOiBmdW5jdGlvbigpIHsKCQkJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyggdGhpcyApOwoJCX0sCgoJCS8vIEVuaGFuY2UgY2hpbGQgZWxlbWVudHMKCQllbmhhbmNlV2l0aGluOiBmdW5jdGlvbigpIHsKCQkJdmFyIGluZGV4LAoJCQkJd2lkZ2V0RWxlbWVudHMgPSB7fSwKCQkJCWtlZXBOYXRpdmUgPSAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSwKCQkJCXRoYXQgPSB0aGlzOwoKCQkJLy8gQWRkIG5vIGpzIGNsYXNzIHRvIGVsZW1lbnRzCgkJCWlmICggJC5tb2JpbGUubm9qcyApIHsKCQkJCSQubW9iaWxlLm5vanMoIHRoaXMgKTsKCQkJfQoKCQkJLy8gQmluZCBsaW5rcyBmb3IgYWpheCBuYXYKCQkJaWYgKCAkLm1vYmlsZS5saW5rcyApIHsKCQkJCSQubW9iaWxlLmxpbmtzKCB0aGlzICk7CgkJCX0KCgkJCS8vIERlZ3JhZGUgaW5wdXRzIGZvciBzdHlsZWluZwoJCQlpZiAoICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNXaXRoaW4gKSB7CgkJCQkkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluKCB0aGlzICk7CgkJCX0KCgkJCS8vIFJ1biBidXR0b25tYXJrdXAKCQkJaWYgKCAkLmZuLmJ1dHRvbk1hcmt1cCApIHsKCQkJCXRoaXMuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkubm90KCBrZWVwTmF0aXZlICkKCQkJCS5qcW1FbmhhbmNlYWJsZSgpLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgoJCQkvLyBBZGQgY2xhc3NlcyBmb3IgZmllbGRDb250YWluCgkJCWlmICggJC5mbi5maWVsZGNvbnRhaW4gKSB7CgkJCQl0aGlzLmZpbmQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIgKS5ub3QoIGtlZXBOYXRpdmUgKQoJCQkJLmpxbUVuaGFuY2VhYmxlKCkuZmllbGRjb250YWluKCk7CgkJCX0KCgkJCS8vIEVuaGFuY2Ugd2lkZ2V0cwoJCQkkLmVhY2goICQubW9iaWxlLndpZGdldHMsIGZ1bmN0aW9uKCBuYW1lLCBjb25zdHJ1Y3RvciApIHsKCgkJCQkvLyBJZiBpbml0U2VsZWN0b3Igbm90IGZhbHNlIGZpbmQgZWxlbWVudHMKCQkJCWlmICggY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yICkgewoKCQkJCQkvLyBGaWx0ZXIgZWxlbWVudHMgdGhhdCBzaG91bGQgbm90IGJlIGVuaGFuY2VkIGJhc2VkIG9uIHBhcmVudHMKCQkJCQl2YXIgZWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhhdC5maW5kKCBjb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgKSApOwoKCQkJCQkvLyBJZiBhbnkgbWF0Y2hpbmcgZWxlbWVudHMgcmVtYWluIGZpbHRlciBvbmVzIHdpdGgga2VlcE5hdGl2ZVNlbGVjdG9yCgkJCQkJaWYgKCBlbGVtZW50cy5sZW5ndGggPiAwICkgewoKCQkJCQkJLy8gJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yIGlzIGRlcHJlY2F0ZWQgdGhpcyBpcyBqdXN0IGZvciBiYWNrY29tcGF0CgkJCQkJCS8vIFN3aXRjaCB0byAkLm1vYmlsZS5rZWVwTmF0aXZlIGluIDEuNSB3aGljaCBpcyBqdXN0IGEgdmFsdWUgbm90IGEgZnVuY3Rpb24KCQkJCQkJZWxlbWVudHMgPSBlbGVtZW50cy5ub3QoIGtlZXBOYXRpdmUgKTsKCQkJCQl9CgoJCQkJCS8vIEVuaGFuY2Ugd2hhdGV2ZXIgaXMgbGVmdAoJCQkJCWlmICggZWxlbWVudHMubGVuZ3RoID4gMCApIHsKCQkJCQkJd2lkZ2V0RWxlbWVudHNbIGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lIF0gPSBlbGVtZW50czsKCQkJCQl9CgkJCQl9CgkJCX0pOwoKCQkJZm9yICggaW5kZXggaW4gd2lkZ2V0RWxlbWVudHMgKSB7CgkJCQl3aWRnZXRFbGVtZW50c1sgaW5kZXggXVsgaW5kZXggXSgpOwoJCQl9CgoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlhZGREZXBlbmRlbnRzOiBmdW5jdGlvbiggbmV3RGVwZW5kZW50cyApIHsKCQkJJC5hZGREZXBlbmRlbnRzKCB0aGlzLCBuZXdEZXBlbmRlbnRzICk7CgkJfSwKCgkJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkJLy8gb3Igc2V0dGluZyBvZiBhbiBodG1sIGVsZW1lbnQncyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkJLy8gdG8gcmV0dXJuIHRoZSBodG1sIGVuY29kZWQgdmVyc2lvbiBvZiB0aGUgdGV4dCBpbiBhbGwgY2FzZXMuICh0aHVzIHRoZSBuYW1lKQoJCWdldEVuY29kZWRUZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQoICI8YT4iICkudGV4dCggdGhpcy50ZXh0KCkgKS5odG1sKCk7CgkJfSwKCgkJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCQlqcW1FbmhhbmNlYWJsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhpcyApOwoJCX0sCgoJCWpxbUhpamFja2FibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGlqYWNrYWJsZSggdGhpcyApOwoJCX0KCX0pOwoKCSQucmVtb3ZlV2l0aERlcGVuZGVudHMgPSBmdW5jdGlvbiggbmF0aXZlRWxlbWVudCApIHsKCQl2YXIgZWxlbWVudCA9ICQoIG5hdGl2ZUVsZW1lbnQgKTsKCgkJKCBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKSApLnJlbW92ZSgpOwoJCWVsZW1lbnQucmVtb3ZlKCk7Cgl9OwoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQsIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICksCgkJCWRlcGVuZGVudHMgPSBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKTsKCgkJZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIsICQoIGRlcGVuZGVudHMgKS5hZGQoIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkkLmZpbmQubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cgl9OwoKCSQuZmluZC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBbIG5vZGUgXSApLmxlbmd0aCA+IDA7Cgl9OwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IGMwYWI3MTA1NmI5MzY2MjdlOGE3ODIxZjAzYzA0NGFlYzYyODBhNDAKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9qUXVlcnkud2lkZ2V0LwogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdXVpZCA9IDAsCglzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKCV9jbGVhbkRhdGEgPSAkLmNsZWFuRGF0YTsKJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7Cglmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQl0cnkgewoJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODIzNQoJCX0gY2F0Y2goIGUgKSB7fQoJfQoJX2NsZWFuRGF0YSggZWxlbXMgKTsKfTsKCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBmdWxsTmFtZSwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgY29uc3RydWN0b3IsIGJhc2VQcm90b3R5cGUsCgkJLy8gcHJveGllZFByb3RvdHlwZSBhbGxvd3MgdGhlIHByb3ZpZGVkIHByb3RvdHlwZSB0byByZW1haW4gdW5tb2RpZmllZAoJCS8vIHNvIHRoYXQgaXQgY2FuIGJlIHVzZWQgYXMgYSBtaXhpbiBmb3IgbXVsdGlwbGUgd2lkZ2V0cyAoIzg4NzYpCgkJcHJveGllZFByb3RvdHlwZSA9IHt9LAoJCW5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF07CgoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZS50b0xvd2VyQ2FzZSgpIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCAibmV3IiBrZXl3b3JkCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgewoJCQlyZXR1cm4gbmV3IGNvbnN0cnVjdG9yKCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQkvLyBtdXN0IHVzZSAibmV3IiBrZXl3b3JkICh0aGUgY29kZSBhYm92ZSBhbHdheXMgcGFzc2VzIGFyZ3MpCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoJLy8gZXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzCgkkLmV4dGVuZCggY29uc3RydWN0b3IsIGV4aXN0aW5nQ29uc3RydWN0b3IsIHsKCQl2ZXJzaW9uOiBwcm90b3R5cGUudmVyc2lvbiwKCQkvLyBjb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoJCS8vIHRyYWNrIHdpZGdldHMgdGhhdCBpbmhlcml0IGZyb20gdGhpcyB3aWRnZXQgaW4gY2FzZSB0aGlzIHdpZGdldCBpcwoJCS8vIHJlZGVmaW5lZCBhZnRlciBhIHdpZGdldCBpbmhlcml0cyBmcm9tIGl0CgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQoJfSk7CgoJYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggISQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gdmFsdWU7CgkJCXJldHVybjsKCQl9CgkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gKGZ1bmN0aW9uKCkgewoJCQl2YXIgX3N1cGVyID0gZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJfSwKCQkJCV9zdXBlckFwcGx5ID0gZnVuY3Rpb24oIGFyZ3MgKSB7CgkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCQkJCX07CgkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXIsCgkJCQkJX19zdXBlckFwcGx5ID0gdGhpcy5fc3VwZXJBcHBseSwKCQkJCQlyZXR1cm5WYWx1ZTsKCgkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfc3VwZXJBcHBseTsKCgkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX19zdXBlckFwcGx5OwoKCQkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQkJfTsKCQl9KSgpOwoJfSk7Cgljb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAkLndpZGdldC5leHRlbmQoIGJhc2VQcm90b3R5cGUsIHsKCQkvLyBUT0RPOiByZW1vdmUgc3VwcG9ydCBmb3Igd2lkZ2V0RXZlbnRQcmVmaXgKCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQKCQkvLyBkb24ndCBwcmVmaXggZm9yIHdpZGdldHMgdGhhdCBhcmVuJ3QgRE9NLWJhc2VkCgkJd2lkZ2V0RXZlbnRQcmVmaXg6IGV4aXN0aW5nQ29uc3RydWN0b3IgPyAoYmFzZVByb3RvdHlwZS53aWRnZXRFdmVudFByZWZpeCB8fCBuYW1lKSA6IG5hbWUKCX0sIHByb3hpZWRQcm90b3R5cGUsIHsKCQljb25zdHJ1Y3RvcjogY29uc3RydWN0b3IsCgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7CgoJcmV0dXJuIGNvbnN0cnVjdG9yOwp9OwoKJC53aWRnZXQuZXh0ZW5kID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCXZhciBpbnB1dCA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCWlucHV0SW5kZXggPSAwLAoJCWlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAoJCWtleSwKCQl2YWx1ZTsKCWZvciAoIDsgaW5wdXRJbmRleCA8IGlucHV0TGVuZ3RoOyBpbnB1dEluZGV4KysgKSB7CgkJZm9yICgga2V5IGluIGlucHV0WyBpbnB1dEluZGV4IF0gKSB7CgkJCXZhbHVlID0gaW5wdXRbIGlucHV0SW5kZXggXVsga2V5IF07CgkJCWlmICggaW5wdXRbIGlucHV0SW5kZXggXS5oYXNPd25Qcm9wZXJ0eSgga2V5ICkgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCS8vIENsb25lIG9iamVjdHMKCQkJCWlmICggJC5pc1BsYWluT2JqZWN0KCB2YWx1ZSApICkgewoJCQkJCXRhcmdldFsga2V5IF0gPSAkLmlzUGxhaW5PYmplY3QoIHRhcmdldFsga2V5IF0gKSA/CgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHRhcmdldFsga2V5IF0sIHZhbHVlICkgOgoJCQkJCQkvLyBEb24ndCBleHRlbmQgc3RyaW5ncywgYXJyYXlzLCBldGMuIHdpdGggb2JqZWN0cwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB2YWx1ZSApOwoJCQkJLy8gQ29weSBldmVyeXRoaW5nIGVsc2UgYnkgcmVmZXJlbmNlCgkJCQl9IGVsc2UgewoJCQkJCXRhcmdldFsga2V5IF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCX0KCXJldHVybiB0YXJnZXQ7Cn07CgokLndpZGdldC5icmlkZ2UgPSBmdW5jdGlvbiggbmFtZSwgb2JqZWN0ICkgewoJdmFyIGZ1bGxOYW1lID0gb2JqZWN0LnByb3RvdHlwZS53aWRnZXRGdWxsTmFtZSB8fCBuYW1lOwoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlzTWV0aG9kQ2FsbCA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiwKCQkJYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC53aWRnZXQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIG9wdGlvbnMgXS5jb25jYXQoYXJncykgKSA6CgkJCW9wdGlvbnM7CgoJCWlmICggaXNNZXRob2RDYWxsICkgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgbWV0aG9kVmFsdWUsCgkJCQkJaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoIG9wdGlvbnMgPT09ICJpbnN0YW5jZSIgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBpbnN0YW5jZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKyAiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyAiICsKCQkJCQkJImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyIgKTsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSB8fCBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJubyBzdWNoIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyBmb3IgIiArIG5hbWUgKyAiIHdpZGdldCBpbnN0YW5jZSIgKTsKCQkJCX0KCQkJCW1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZSAmJiBtZXRob2RWYWx1ZS5qcXVlcnkgPwoJCQkJCQlyZXR1cm5WYWx1ZS5wdXNoU3RhY2soIG1ldGhvZFZhbHVlLmdldCgpICkgOgoJCQkJCQltZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICkuX2luaXQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSwgbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfTsKfTsKCiQuV2lkZ2V0ID0gZnVuY3Rpb24oIC8qIG9wdGlvbnMsIGVsZW1lbnQgKi8gKSB7fTsKJC5XaWRnZXQuX2NoaWxkQ29uc3RydWN0b3JzID0gW107CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCWRlZmF1bHRFbGVtZW50OiAiPGRpdj4iLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBmYWxzZSwKCgkJLy8gY2FsbGJhY2tzCgkJY3JlYXRlOiBudWxsCgl9LAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJZWxlbWVudCA9ICQoIGVsZW1lbnQgfHwgdGhpcy5kZWZhdWx0RWxlbWVudCB8fCB0aGlzIClbIDAgXTsKCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJdGhpcy51dWlkID0gdXVpZCsrOwoJCXRoaXMuZXZlbnROYW1lc3BhY2UgPSAiLiIgKyB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQ7CgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdGhpcy5iaW5kaW5ncyA9ICQoKTsKCQl0aGlzLmhvdmVyYWJsZSA9ICQoKTsKCQl0aGlzLmZvY3VzYWJsZSA9ICQoKTsKCgkJaWYgKCBlbGVtZW50ICE9PSB0aGlzICkgewoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsKCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZWxlbWVudCwgewoJCQkJcmVtb3ZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50YXJnZXQgPT09IGVsZW1lbnQgKSB7CgkJCQkJCXRoaXMuZGVzdHJveSgpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJCXRoaXMuZG9jdW1lbnQgPSAkKCBlbGVtZW50LnN0eWxlID8KCQkJCS8vIGVsZW1lbnQgd2l0aGluIHRoZSBkb2N1bWVudAoJCQkJZWxlbWVudC5vd25lckRvY3VtZW50IDoKCQkJCS8vIGVsZW1lbnQgaXMgd2luZG93IG9yIGRvY3VtZW50CgkJCQllbGVtZW50LmRvY3VtZW50IHx8IGVsZW1lbnQgKTsKCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmRlZmF1bHRWaWV3IHx8IHRoaXMuZG9jdW1lbnRbMF0ucGFyZW50V2luZG93ICk7CgkJfQoKCQl0aGlzLl9jcmVhdGUoKTsKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiwgbnVsbCwgdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoJX2dldENyZWF0ZU9wdGlvbnM6ICQubm9vcCwKCV9nZXRDcmVhdGVFdmVudERhdGE6ICQubm9vcCwKCV9jcmVhdGU6ICQubm9vcCwKCV9pbml0OiAkLm5vb3AsCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZGVzdHJveSgpOwoJCS8vIHdlIGNhbiBwcm9iYWJseSByZW1vdmUgdGhlIHVuYmluZCBjYWxscyBpbiAyLjAKCQkvLyBhbGwgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGdvIHRocm91Z2ggdGhpcy5fb24oKQoJCXRoaXMuZWxlbWVudAoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCIsICEhdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb25zKHsgZGlzYWJsZWQ6IGZhbHNlIH0pOwoJfSwKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb25zKHsgZGlzYWJsZWQ6IHRydWUgfSk7Cgl9LAoKCV9vbjogZnVuY3Rpb24oIHN1cHByZXNzRGlzYWJsZWRDaGVjaywgZWxlbWVudCwgaGFuZGxlcnMgKSB7CgkJdmFyIGRlbGVnYXRlRWxlbWVudCwKCQkJaW5zdGFuY2UgPSB0aGlzOwoKCQkvLyBubyBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgZmxhZywgc2h1ZmZsZSBhcmd1bWVudHMKCQlpZiAoIHR5cGVvZiBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgIT09ICJib29sZWFuIiApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gc3VwcHJlc3NEaXNhYmxlZENoZWNrOwoJCQlzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgPSBmYWxzZTsKCQl9CgoJCS8vIG5vIGVsZW1lbnQgYXJndW1lbnQsIHNodWZmbGUgYW5kIHVzZSB0aGlzLmVsZW1lbnQKCQlpZiAoICFoYW5kbGVycyApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50OwoJCQlkZWxlZ2F0ZUVsZW1lbnQgPSB0aGlzLndpZGdldCgpOwoJCX0gZWxzZSB7CgkJCS8vIGFjY2VwdCBzZWxlY3RvcnMsIERPTSBlbGVtZW50cwoJCQllbGVtZW50ID0gZGVsZWdhdGVFbGVtZW50ID0gJCggZWxlbWVudCApOwoJCQl0aGlzLmJpbmRpbmdzID0gdGhpcy5iaW5kaW5ncy5hZGQoIGVsZW1lbnQgKTsKCQl9CgoJCSQuZWFjaCggaGFuZGxlcnMsIGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlciApIHsKCQkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQkJLy8gYWxsb3cgd2lkZ2V0cyB0byBjdXN0b21pemUgdGhlIGRpc2FibGVkIGhhbmRsaW5nCgkJCQkvLyAtIGRpc2FibGVkIGFzIGFuIGFycmF5IGluc3RlYWQgb2YgYm9vbGVhbgoJCQkJLy8gLSBkaXNhYmxlZCBjbGFzcyBhcyBtZXRob2QgZm9yIGRpc2FibGluZyBpbmRpdmlkdWFsIHBhcnRzCgkJCQlpZiAoICFzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgJiYKCQkJCQkJKCBpbnN0YW5jZS5vcHRpb25zLmRpc2FibGVkID09PSB0cnVlIHx8CgkJCQkJCQkkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQkJfQoKCQkJLy8gY29weSB0aGUgZ3VpZCBzbyBkaXJlY3QgdW5iaW5kaW5nIHdvcmtzCgkJCWlmICggdHlwZW9mIGhhbmRsZXIgIT09ICJzdHJpbmciICkgewoJCQkJaGFuZGxlclByb3h5Lmd1aWQgPSBoYW5kbGVyLmd1aWQgPQoJCQkJCWhhbmRsZXIuZ3VpZCB8fCBoYW5kbGVyUHJveHkuZ3VpZCB8fCAkLmd1aWQrKzsKCQkJfQoKCQkJdmFyIG1hdGNoID0gZXZlbnQubWF0Y2goIC9eKFx3KylccyooLiopJC8gKSwKCQkJCWV2ZW50TmFtZSA9IG1hdGNoWzFdICsgaW5zdGFuY2UuZXZlbnROYW1lc3BhY2UsCgkJCQlzZWxlY3RvciA9IG1hdGNoWzJdOwoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJZGVsZWdhdGVFbGVtZW50LmRlbGVnYXRlKCBzZWxlY3RvciwgZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfSBlbHNlIHsKCQkJCWVsZW1lbnQuYmluZCggZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfQoJCX0pOwoJfSwKCglfb2ZmOiBmdW5jdGlvbiggZWxlbWVudCwgZXZlbnROYW1lICkgewoJCWV2ZW50TmFtZSA9IChldmVudE5hbWUgfHwgIiIpLnNwbGl0KCAiICIgKS5qb2luKCB0aGlzLmV2ZW50TmFtZXNwYWNlICsgIiAiICkgKyB0aGlzLmV2ZW50TmFtZXNwYWNlOwoJCWVsZW1lbnQudW5iaW5kKCBldmVudE5hbWUgKS51bmRlbGVnYXRlKCBldmVudE5hbWUgKTsKCX0sCgoJX2RlbGF5OiBmdW5jdGlvbiggaGFuZGxlciwgZGVsYXkgKSB7CgkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQl9CgkJdmFyIGluc3RhbmNlID0gdGhpczsKCQlyZXR1cm4gc2V0VGltZW91dCggaGFuZGxlclByb3h5LCBkZWxheSB8fCAwICk7Cgl9LAoKCV9ob3ZlcmFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuaG92ZXJhYmxlID0gdGhpcy5ob3ZlcmFibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJbW91c2VlbnRlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0sCgkJCW1vdXNlbGVhdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV9mb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuZm9jdXNhYmxlID0gdGhpcy5mb2N1c2FibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJZm9jdXNpbjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0sCgkJCWZvY3Vzb3V0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfQoJCX0pOwoJfSwKCglfdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGV2ZW50LCBkYXRhICkgewoJCXZhciBwcm9wLCBvcmlnLAoJCQljYWxsYmFjayA9IHRoaXMub3B0aW9uc1sgdHlwZSBdOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCQlldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CgkJZXZlbnQudHlwZSA9ICggdHlwZSA9PT0gdGhpcy53aWRnZXRFdmVudFByZWZpeCA/CgkJCXR5cGUgOgoJCQl0aGlzLndpZGdldEV2ZW50UHJlZml4ICsgdHlwZSApLnRvTG93ZXJDYXNlKCk7CgkJLy8gdGhlIG9yaWdpbmFsIGV2ZW50IG1heSBjb21lIGZyb20gYW55IGVsZW1lbnQKCQkvLyBzbyB3ZSBuZWVkIHRvIHJlc2V0IHRoZSB0YXJnZXQgb24gdGhlIG5ldyBldmVudAoJCWV2ZW50LnRhcmdldCA9IHRoaXMuZWxlbWVudFsgMCBdOwoKCQkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkJb3JpZyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7CgkJaWYgKCBvcmlnICkgewoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQlpZiAoICEoIHByb3AgaW4gZXZlbnQgKSApIHsKCQkJCQlldmVudFsgcHJvcCBdID0gb3JpZ1sgcHJvcCBdOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggZXZlbnQsIGRhdGEgKTsKCQlyZXR1cm4gISggJC5pc0Z1bmN0aW9uKCBjYWxsYmFjayApICYmCgkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLmVsZW1lbnRbMF0sIFsgZXZlbnQgXS5jb25jYXQoIGRhdGEgKSApID09PSBmYWxzZSB8fAoJCQlldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApOwoJfQp9OwoKJC5lYWNoKCB7IHNob3c6ICJmYWRlSW4iLCBoaWRlOiAiZmFkZU91dCIgfSwgZnVuY3Rpb24oIG1ldGhvZCwgZGVmYXVsdEVmZmVjdCApIHsKCSQuV2lkZ2V0LnByb3RvdHlwZVsgIl8iICsgbWV0aG9kIF0gPSBmdW5jdGlvbiggZWxlbWVudCwgb3B0aW9ucywgY2FsbGJhY2sgKSB7CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgKSB7CgkJCW9wdGlvbnMgPSB7IGVmZmVjdDogb3B0aW9ucyB9OwoJCX0KCQl2YXIgaGFzT3B0aW9ucywKCQkJZWZmZWN0TmFtZSA9ICFvcHRpb25zID8KCQkJCW1ldGhvZCA6CgkJCQlvcHRpb25zID09PSB0cnVlIHx8IHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiA/CgkJCQkJZGVmYXVsdEVmZmVjdCA6CgkJCQkJb3B0aW9ucy5lZmZlY3QgfHwgZGVmYXVsdEVmZmVjdDsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiApIHsKCQkJb3B0aW9ucyA9IHsgZHVyYXRpb246IG9wdGlvbnMgfTsKCQl9CgkJaGFzT3B0aW9ucyA9ICEkLmlzRW1wdHlPYmplY3QoIG9wdGlvbnMgKTsKCQlvcHRpb25zLmNvbXBsZXRlID0gY2FsbGJhY2s7CgkJaWYgKCBvcHRpb25zLmRlbGF5ICkgewoJCQllbGVtZW50LmRlbGF5KCBvcHRpb25zLmRlbGF5ICk7CgkJfQoJCWlmICggaGFzT3B0aW9ucyAmJiAkLmVmZmVjdHMgJiYgJC5lZmZlY3RzLmVmZmVjdFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBtZXRob2QgXSggb3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIGVmZmVjdE5hbWUgIT09IG1ldGhvZCAmJiBlbGVtZW50WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIGVmZmVjdE5hbWUgXSggb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudC5xdWV1ZShmdW5jdGlvbiggbmV4dCApIHsKCQkJCSQoIHRoaXMgKVsgbWV0aG9kIF0oKTsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7CgkJCQl9CgkJCQluZXh0KCk7CgkJCX0pOwoJCX0KCX07Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcmNhcGl0YWxzID0gL1tBLVpdL2csCglyZXBsYWNlRnVuY3Rpb24gPSBmdW5jdGlvbiggYyApIHsKCQlyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwoJfTsKCiQuZXh0ZW5kKCAkLldpZGdldC5wcm90b3R5cGUsIHsKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9uLCB2YWx1ZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudFsgMCBdLAoJCQlvcHRpb25zID0ge307CgoJCS8vCgkJaWYgKCAhJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBlbGVtLCAiZGVmYXVsdHMiICkgKSB7CgkJCWZvciAoIG9wdGlvbiBpbiB0aGlzLm9wdGlvbnMgKSB7CgkJCQl2YWx1ZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggZWxlbSwgb3B0aW9uLnJlcGxhY2UoIHJjYXBpdGFscywgcmVwbGFjZUZ1bmN0aW9uICkgKTsKCgkJCQlpZiAoIHZhbHVlICE9IG51bGwgKSB7CgkJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIG9wdGlvbnM7Cgl9Cn0pOwoKLy9UT0RPOiBSZW1vdmUgaW4gMS41IGZvciBiYWNrY29tcGF0IG9ubHkKJC5tb2JpbGUud2lkZ2V0ID0gJC5XaWRnZXQ7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoJLy8gVE9ETyBtb3ZlIGxvYWRlciBjbGFzcyBkb3duIGludG8gdGhlIHdpZGdldCBzZXR0aW5ncwoJdmFyIGxvYWRlckNsYXNzID0gInVpLWxvYWRlciIsICRodG1sID0gJCggImh0bWwiICk7CgoJJC53aWRnZXQoICJtb2JpbGUubG9hZGVyIiwgewoJCS8vIE5PVEUgaWYgdGhlIGdsb2JhbCBjb25maWcgc2V0dGluZ3MgYXJlIGRlZmluZWQgdGhleSB3aWxsIG92ZXJyaWRlIHRoZXNlCgkJLy8gICAgICBvcHRpb25zCgkJb3B0aW9uczogewoJCQkvLyB0aGUgdGhlbWUgZm9yIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhlbWU6ICJhIiwKCgkJCS8vIHdoZXRoZXIgdGhlIHRleHQgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZSBpcyBzaG93bgoJCQl0ZXh0VmlzaWJsZTogZmFsc2UsCgoJCQkvLyBjdXN0b20gaHRtbCBmb3IgdGhlIGlubmVyIGNvbnRlbnQgb2YgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQlodG1sOiAiIiwKCgkJCS8vIHRoZSB0ZXh0IHRvIGJlIGRpc3BsYXllZCB3aGVuIHRoZSBwb3B1cCBpcyBzaG93bgoJCQl0ZXh0OiAibG9hZGluZyIKCQl9LAoKCQlkZWZhdWx0SHRtbDogIjxkaXYgY2xhc3M9JyIgKyBsb2FkZXJDbGFzcyArICInPiIgKwoJCQkiPHNwYW4gY2xhc3M9J3VpLWljb24tbG9hZGluZyc+PC9zcGFuPiIgKwoJCQkiPGgxPjwvaDE+IiArCgkJCSI8L2Rpdj4iLAoKCQkvLyBGb3Igbm9uLWZpeGVkIHN1cHBvcnRpbiBicm93c2Vycy4gUG9zaXRpb24gYXQgeSBjZW50ZXIgKGlmIHNjcm9sbFRvcCBzdXBwb3J0ZWQpLCBhYm92ZSB0aGUgYWN0aXZlQnRuIChpZiBkZWZpbmVkKSwgb3IganVzdCAxMDBweCBmcm9tIHRvcAoJCWZha2VGaXhMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkJdGhpcy5lbGVtZW50CgkJCQkuY3NzKHsKCQkJCQl0b3A6ICQuc3VwcG9ydC5zY3JvbGxUb3AgJiYgdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCkgKyB0aGlzLndpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQkJfSk7CgkJfSwKCgkJLy8gY2hlY2sgcG9zaXRpb24gb2YgbG9hZGVyIHRvIHNlZSBpZiBpdCBhcHBlYXJzIHRvIGJlICJmaXhlZCIgdG8gY2VudGVyCgkJLy8gaWYgbm90LCB1c2UgYWJzIHBvc2l0aW9uaW5nCgkJY2hlY2tMb2FkZXJQb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCksCgkJCQlzY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJaWYgKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8ICggb2Zmc2V0LnRvcCAtIHNjcm9sbFRvcCApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCQl0aGlzLmZha2VGaXhMb2FkZXIoKTsKCQkJCXRoaXMud2luZG93CgkJCQkJLnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApCgkJCQkJLmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmZha2VGaXhMb2FkZXIsIHRoaXMgKSApOwoJCQl9CgkJfSwKCgkJcmVzZXRIdG1sOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmh0bWwoICQoIHRoaXMuZGVmYXVsdEh0bWwgKS5odG1sKCkgKTsKCQl9LAoKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJLy8gVE9ETyBzd2VldCBqZXN1cyB3ZSBuZWVkIHRvIGJyZWFrIHNvbWUgb2YgdGhpcyBvdXQKCQlzaG93OiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQl2YXIgdGV4dFZpc2libGUsIG1lc3NhZ2UsIGxvYWRTZXR0aW5nczsKCgkJCXRoaXMucmVzZXRIdG1sKCk7CgoJCQkvLyB1c2UgdGhlIHByb3RvdHlwZSBvcHRpb25zIHNvIHRoYXQgcGVvcGxlIGNhbiBzZXQgdGhlbSBnbG9iYWxseSBhdAoJCQkvLyBtb2JpbGUgaW5pdC4gQ29uc2lzdGVuY3ksIGl0J3Mgd2hhdCdzIGZvciBkaW5uZXIKCQkJaWYgKCAkLnR5cGUoIHRoZW1lICkgPT09ICJvYmplY3QiICkgewoJCQkJbG9hZFNldHRpbmdzID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIHRoZW1lICk7CgoJCQkJdGhlbWUgPSBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0gZWxzZSB7CgkJCQlsb2FkU2V0dGluZ3MgPSB0aGlzLm9wdGlvbnM7CgoJCQkJLy8gaGVyZSB3ZSBwcmVmZXIgdGhlIHRoZW1lIHZhbHVlIHBhc3NlZCBhcyBhIHN0cmluZyBhcmd1bWVudCwgdGhlbgoJCQkJLy8gd2UgcHJlZmVyIHRoZSBnbG9iYWwgb3B0aW9uIGJlY2F1c2Ugd2UgY2FuJ3QgdXNlIHVuZGVmaW5lZCBkZWZhdWx0CgkJCQkvLyBwcm90b3R5cGUgb3B0aW9ucywgdGhlbiB0aGUgcHJvdG90eXBlIG9wdGlvbgoJCQkJdGhlbWUgPSB0aGVtZSB8fCBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0KCgkJCS8vIHNldCB0aGUgbWVzc2FnZSB0ZXh0LCBwcmVmZXIgdGhlIHBhcmFtLCB0aGVuIHRoZSBzZXR0aW5ncyBvYmplY3QKCQkJLy8gdGhlbiBsb2FkaW5nIG1lc3NhZ2UKCQkJbWVzc2FnZSA9IG1zZ1RleHQgfHwgKCBsb2FkU2V0dGluZ3MudGV4dCA9PT0gZmFsc2UgPyAiIiA6IGxvYWRTZXR0aW5ncy50ZXh0ICk7CgoJCQkvLyBwcmVwYXJlIHRoZSBkb20KCQkJJGh0bWwuYWRkQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJdGV4dFZpc2libGUgPSBsb2FkU2V0dGluZ3MudGV4dFZpc2libGU7CgoJCQkvLyBhZGQgdGhlIHByb3BlciBjc3MgZ2l2ZW4gdGhlIG9wdGlvbnMgKHRoZW1lLCB0ZXh0LCBldGMpCgkJCS8vIEZvcmNlIHRleHQgdmlzaWJpbGl0eSBpZiB0aGUgc2Vjb25kIGFyZ3VtZW50IHdhcyBzdXBwbGllZCwgb3IKCQkJLy8gaWYgdGhlIHRleHQgd2FzIGV4cGxpY2l0bHkgc2V0IGluIHRoZSBvYmplY3QgYXJncwoJCQl0aGlzLmVsZW1lbnQuYXR0cigiY2xhc3MiLCBsb2FkZXJDbGFzcyArCgkJCQkiIHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgdGhlbWUgKwoJCQkJIiB1aS1sb2FkZXItIiArICggdGV4dFZpc2libGUgfHwgbXNnVGV4dCB8fCB0aGVtZS50ZXh0ID8gInZlcmJvc2UiIDogImRlZmF1bHQiICkgKwoJCQkJKCBsb2FkU2V0dGluZ3MudGV4dG9ubHkgfHwgdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICk7CgoJCQkvLyBUT0RPIHZlcmlmeSB0aGF0IGpxdWVyeS5mbi5odG1sIGlzIG9rIHRvIHVzZSBpbiBib3RoIGNhc2VzIGhlcmUKCQkJLy8gICAgICB0aGlzIG1pZ2h0IGJlIG92ZXJseSBkZWZlbnNpdmUgaW4gcHJldmVudGluZyB1bmtub3dpbmcgeHNzCgkJCS8vIGlmIHRoZSBodG1sIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIHRoZSBsb2FkaW5nIHNldHRpbmdzLCB1c2UgdGhhdAoJCQkvLyBvdGhlcndpc2UgdXNlIHRoZSBmYWxsYmFja3MgZnJvbSBhYm92ZQoJCQlpZiAoIGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIGxvYWRTZXR0aW5ncy5odG1sICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggImgxIiApLnRleHQoIG1lc3NhZ2UgKTsKCQkJfQoKCQkJLy8gYXR0YWNoIHRoZSBsb2FkZXIgdG8gdGhlIERPTQoJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCS8vIGNoZWNrIHRoYXQgdGhlIGxvYWRlciBpcyB2aXNpYmxlCgkJCXRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbigpOwoKCQkJLy8gb24gc2Nyb2xsIGNoZWNrIHRoZSBsb2FkZXIgcG9zaXRpb24KCQkJdGhpcy53aW5kb3cuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiwgdGhpcyApICk7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oKSB7CgkJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLnRleHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJfQoKCQkJJC5tb2JpbGUud2luZG93LnVuYmluZCggInNjcm9sbCIsIHRoaXMuZmFrZUZpeExvYWRlciApOwoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICk7CgkJfQoJfSk7Cgp9KShqUXVlcnksIHRoaXMpOwoKCi8qIQogKiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCAtIHYxLjMgLSA3LzIxLzIwMTAKICogaHR0cDovL2JlbmFsbWFuLmNvbS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS1wbHVnaW4vCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgogKiBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCiAqLwoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLwovLyAqVmVyc2lvbjogMS4zLCBMYXN0IHVwZGF0ZWQ6IDcvMjEvMjAxMCoKLy8gCi8vIFByb2plY3QgSG9tZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UtcGx1Z2luLwovLyBHaXRIdWIgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvCi8vIFNvdXJjZSAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLmpzCi8vIChNaW5pZmllZCkgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLm1pbi5qcyAoMC44a2IgZ3ppcHBlZCkKLy8gCi8vIEFib3V0OiBMaWNlbnNlCi8vIAovLyBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuLAovLyBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlcy4KLy8gaHR0cDovL2JlbmFsbWFuLmNvbS9hYm91dC9saWNlbnNlLwovLyAKLy8gQWJvdXQ6IEV4YW1wbGVzCi8vIAovLyBUaGVzZSB3b3JraW5nIGV4YW1wbGVzLCBjb21wbGV0ZSB3aXRoIGZ1bGx5IGNvbW1lbnRlZCBjb2RlLCBpbGx1c3RyYXRlIGEgZmV3Ci8vIHdheXMgaW4gd2hpY2ggdGhpcyBwbHVnaW4gY2FuIGJlIHVzZWQuCi8vIAovLyBoYXNoY2hhbmdlIGV2ZW50IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2hhc2hjaGFuZ2UvCi8vIGRvY3VtZW50LmRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9kb2N1bWVudF9kb21haW4vCi8vIAovLyBBYm91dDogU3VwcG9ydCBhbmQgVGVzdGluZwovLyAKLy8gSW5mb3JtYXRpb24gYWJvdXQgd2hhdCB2ZXJzaW9uIG9yIHZlcnNpb25zIG9mIGpRdWVyeSB0aGlzIHBsdWdpbiBoYXMgYmVlbgovLyB0ZXN0ZWQgd2l0aCwgd2hhdCBicm93c2VycyBpdCBoYXMgYmVlbiB0ZXN0ZWQgaW4sIGFuZCB3aGVyZSB0aGUgdW5pdCB0ZXN0cwovLyByZXNpZGUgKHNvIHlvdSBjYW4gdGVzdCBpdCB5b3Vyc2VsZikuCi8vIAovLyBqUXVlcnkgVmVyc2lvbnMgLSAxLjIuNiwgMS4zLjIsIDEuNC4xLCAxLjQuMgovLyBCcm93c2VycyBUZXN0ZWQgLSBJbnRlcm5ldCBFeHBsb3JlciA2LTgsIEZpcmVmb3ggMi00LCBDaHJvbWUgNS02LCBTYWZhcmkgMy4yLTUsCi8vICAgICAgICAgICAgICAgICAgIE9wZXJhIDkuNi0xMC42MCwgaVBob25lIDMuMSwgQW5kcm9pZCAxLjYtMi4yLCBCbGFja0JlcnJ5IDQuNi01LgovLyBVbml0IFRlc3RzICAgICAgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvdW5pdC8KLy8gCi8vIEFib3V0OiBLbm93biBpc3N1ZXMKLy8gCi8vIFdoaWxlIHRoaXMgalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQgaW1wbGVtZW50YXRpb24gaXMgcXVpdGUgc3RhYmxlIGFuZAovLyByb2J1c3QsIHRoZXJlIGFyZSBhIGZldyB1bmZvcnR1bmF0ZSBicm93c2VyIGJ1Z3Mgc3Vycm91bmRpbmcgZXhwZWN0ZWQKLy8gaGFzaGNoYW5nZSBldmVudC1iYXNlZCBiZWhhdmlvcnMsIGluZGVwZW5kZW50IG9mIGFueSBKYXZhU2NyaXB0Ci8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgYWJzdHJhY3Rpb24uIFNlZSB0aGUgZm9sbG93aW5nIGV4YW1wbGVzIGZvciBtb3JlCi8vIGluZm9ybWF0aW9uOgovLyAKLy8gQ2hyb21lOiBCYWNrIEJ1dHRvbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctY2hyb21lLWJhY2stYnV0dG9uLwovLyBGaXJlZm94OiBSZW1vdGUgWE1MSHR0cFJlcXVlc3QgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWZpcmVmb3gtcmVtb3RlLXhoci8KLy8gV2ViS2l0OiBCYWNrIEJ1dHRvbiBpbiBhbiBJZnJhbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXdlYmtpdC1oYXNoLWlmcmFtZS8KLy8gU2FmYXJpOiBCYWNrIEJ1dHRvbiBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctc2FmYXJpLWJhY2stZnJvbS1kaWZmLWRvbWFpbi8KLy8gCi8vIEFsc28gbm90ZSB0aGF0IHNob3VsZCBhIGJyb3dzZXIgbmF0aXZlbHkgc3VwcG9ydCB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSAKLy8gZXZlbnQsIGJ1dCBub3QgcmVwb3J0IHRoYXQgaXQgZG9lcywgdGhlIGZhbGxiYWNrIHBvbGxpbmcgbG9vcCB3aWxsIGJlIHVzZWQuCi8vIAovLyBBYm91dDogUmVsZWFzZSBIaXN0b3J5Ci8vIAovLyAxLjMgICAtICg3LzIxLzIwMTApIFJlb3JnYW5pemVkIElFNi83IElmcmFtZSBjb2RlIHRvIG1ha2UgaXQgbW9yZQovLyAgICAgICAgICJyZW1vdmFibGUiIGZvciBtb2JpbGUtb25seSBkZXZlbG9wbWVudC4gQWRkZWQgSUU2LzcgZG9jdW1lbnQudGl0bGUKLy8gICAgICAgICBzdXBwb3J0LiBBdHRlbXB0ZWQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlIGJ5IHVzaW5nCi8vICAgICAgICAgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuIEFkZGVkIAovLyAgICAgICAgIHN1cHBvcnQgZm9yIHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKHdpbmRvdykuaGFzaGNoYW5nZSggZm4gKSBhbmQKLy8gICAgICAgICAkKHdpbmRvdykuaGFzaGNoYW5nZSgpIGxpa2UgalF1ZXJ5IHByb3ZpZGVzIGZvciBidWlsdC1pbiBldmVudHMuCi8vICAgICAgICAgUmVuYW1lZCBqUXVlcnkuaGFzaGNoYW5nZURlbGF5IHRvIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gYW5kCi8vICAgICAgICAgbG93ZXJlZCBpdHMgZGVmYXVsdCB2YWx1ZSB0byA1MC4gQWRkZWQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4KLy8gICAgICAgICBhbmQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydGllcyBwbHVzIGRvY3VtZW50LWRvbWFpbi5odG1sCi8vICAgICAgICAgZmlsZSB0byBhZGRyZXNzIGFjY2VzcyBkZW5pZWQgaXNzdWVzIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4KLy8gICAgICAgICBJRTYvNy4KLy8gMS4yICAgLSAoMi8xMS8yMDEwKSBGaXhlZCBhIGJ1ZyB3aGVyZSBjb21pbmcgYmFjayB0byBhIHBhZ2UgdXNpbmcgdGhpcyBwbHVnaW4KLy8gICAgICAgICBmcm9tIGEgcGFnZSBvbiBhbm90aGVyIGRvbWFpbiB3b3VsZCBjYXVzZSBhbiBlcnJvciBpbiBTYWZhcmkgNC4gQWxzbywKLy8gICAgICAgICBJRTYvNyBJZnJhbWUgaXMgbm93IGluc2VydGVkIGFmdGVyIHRoZSBib2R5ICh0aGlzIGFjdHVhbGx5IHdvcmtzKSwKLy8gICAgICAgICB3aGljaCBwcmV2ZW50cyB0aGUgcGFnZSBmcm9tIHNjcm9sbGluZyB3aGVuIHRoZSBldmVudCBpcyBmaXJzdCBib3VuZC4KLy8gICAgICAgICBFdmVudCBjYW4gYWxzbyBub3cgYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IGl0IHdvbid0IGJlIHVzYWJsZQovLyAgICAgICAgIGJlZm9yZSB0aGVuIGluIElFNi83LgovLyAxLjEgICAtICgxLzIxLzIwMTApIEluY29ycG9yYXRlZCBkb2N1bWVudC5kb2N1bWVudE1vZGUgdGVzdCB0byBmaXggSUU4IGJ1ZwovLyAgICAgICAgIHdoZXJlIGJyb3dzZXIgdmVyc2lvbiBpcyBpbmNvcnJlY3RseSByZXBvcnRlZCBhcyA4LjAsIGRlc3BpdGUKLy8gICAgICAgICBpbmNsdXNpb24gb2YgdGhlIFgtVUEtQ29tcGF0aWJsZSBJRT1FbXVsYXRlSUU3IG1ldGEgdGFnLgovLyAxLjAgICAtICgxLzkvMjAxMCkgSW5pdGlhbCBSZWxlYXNlLiBCcm9rZSBvdXQgdGhlIGpRdWVyeSBCQlEgZXZlbnQuc3BlY2lhbAovLyAgICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZnVuY3Rpb25hbGl0eSBpbnRvIGEgc2VwYXJhdGUgcGx1Z2luIGZvciB1c2VycwovLyAgICAgICAgIHdobyB3YW50IGp1c3QgdGhlIGJhc2ljIGV2ZW50ICYgYmFjayBidXR0b24gc3VwcG9ydCwgd2l0aG91dCBhbGwgdGhlCi8vICAgICAgICAgZXh0cmEgYXdlc29tZW5lc3MgdGhhdCBCQlEgcHJvdmlkZXMuIFRoaXMgcGx1Z2luIHdpbGwgYmUgaW5jbHVkZWQgYXMKLy8gICAgICAgICBwYXJ0IG9mIGpRdWVyeSBCQlEsIGJ1dCBhbHNvIGJlIGF2YWlsYWJsZSBzZXBhcmF0ZWx5LgoKKGZ1bmN0aW9uKCQsd2luZG93LHVuZGVmaW5lZCl7CiAgJyQ6bm9tdW5nZSc7IC8vIFVzZWQgYnkgWVVJIGNvbXByZXNzb3IuCiAgCiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCl7CiAgICB2YXIgc2VsZiA9IHt9LAogICAgICB0aW1lb3V0X2lkLAogICAgICAKICAgICAgLy8gUmVtZW1iZXIgdGhlIGluaXRpYWwgaGFzaCBzbyBpdCBkb2Vzbid0IGdldCB0cmlnZ2VyZWQgaW1tZWRpYXRlbHkuCiAgICAgIGxhc3RfaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAKICAgICAgZm5fcmV0dmFsID0gZnVuY3Rpb24odmFsKXsgcmV0dXJuIHZhbDsgfSwKICAgICAgaGlzdG9yeV9zZXQgPSBmbl9yZXR2YWwsCiAgICAgIGhpc3RvcnlfZ2V0ID0gZm5fcmV0dmFsOwogICAgCiAgICAvLyBTdGFydCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkIHx8IHBvbGwoKTsKICAgIH07CiAgICAKICAgIC8vIFN0b3AgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkICYmIGNsZWFyVGltZW91dCggdGltZW91dF9pZCApOwogICAgICB0aW1lb3V0X2lkID0gdW5kZWZpbmVkOwogICAgfTsKICAgIAogICAgLy8gVGhpcyBwb2xsaW5nIGxvb3AgY2hlY2tzIGV2ZXJ5ICQuZm4uaGFzaGNoYW5nZS5kZWxheSBtaWxsaXNlY29uZHMgdG8gc2VlCiAgICAvLyBpZiBsb2NhdGlvbi5oYXNoIGhhcyBjaGFuZ2VkLCBhbmQgdHJpZ2dlcnMgdGhlICdoYXNoY2hhbmdlJyBldmVudCBvbgogICAgLy8gd2luZG93IHdoZW4gbmVjZXNzYXJ5LgogICAgZnVuY3Rpb24gcG9sbCgpIHsKICAgICAgdmFyIGhhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgICBoaXN0b3J5X2hhc2ggPSBoaXN0b3J5X2dldCggbGFzdF9oYXNoICk7CiAgICAgIAogICAgICBpZiAoIGhhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBoaXN0b3J5X3NldCggbGFzdF9oYXNoID0gaGFzaCwgaGlzdG9yeV9oYXNoICk7CiAgICAgICAgCiAgICAgICAgJCh3aW5kb3cpLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgICAgICAgCiAgICAgIH0gZWxzZSBpZiAoIGhpc3RvcnlfaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGxvY2F0aW9uLmhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIC8jLiovLCAnJyApICsgaGlzdG9yeV9oYXNoOwogICAgICB9CiAgICAgIAogICAgICB0aW1lb3V0X2lkID0gc2V0VGltZW91dCggcG9sbCwgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSApOwogICAgfTsKICAgIAogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2IFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgd2luZG93LmF0dGFjaEV2ZW50ICYmICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciAmJiAhc3VwcG9ydHNfb25oYXNoY2hhbmdlICYmIChmdW5jdGlvbigpewogICAgICAvLyBOb3Qgb25seSBkbyBJRTYvNyBuZWVkIHRoZSAibWFnaWNhbCIgSWZyYW1lIHRyZWF0bWVudCwgYnV0IHNvIGRvZXMgSUU4CiAgICAgIC8vIHdoZW4gcnVubmluZyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUuCiAgICAgIAogICAgICB2YXIgaWZyYW1lLAogICAgICAgIGlmcmFtZV9zcmM7CiAgICAgIAogICAgICAvLyBXaGVuIHRoZSBldmVudCBpcyBib3VuZCBhbmQgcG9sbGluZyBzdGFydHMgaW4gSUUgNi83LCBjcmVhdGUgYSBoaWRkZW4KICAgICAgLy8gSWZyYW1lIGZvciBoaXN0b3J5IGhhbmRsaW5nLgogICAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKXsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgCiAgICAgICAgICAvLyBXaGVuZXZlciBgZG9jdW1lbnQudGl0bGVgIGNoYW5nZXMsIHVwZGF0ZSB0aGUgSWZyYW1lJ3MgdGl0bGUgdG8KICAgICAgICAgIC8vIHByZXR0aWZ5IHRoZSBiYWNrL25leHQgaGlzdG9yeSBtZW51IGVudHJpZXMuIFNpbmNlIElFIHNvbWV0aW1lcwogICAgICAgICAgLy8gZXJyb3JzIHdpdGggIlVuc3BlY2lmaWVkIGVycm9yIiB0aGUgdmVyeSBmaXJzdCB0aW1lIHRoaXMgaXMgc2V0CiAgICAgICAgICAvLyAoeWVzLCB2ZXJ5IHVzZWZ1bCkgd3JhcCB0aGlzIHdpdGggYSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgICBkb2Mub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwogICAgICAgICAgCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgLy8gT3ZlcnJpZGUgdGhlICJzdG9wIiBtZXRob2Qgc2luY2UgYW4gSUU2LzcgSWZyYW1lIHdhcyBjcmVhdGVkLiBFdmVuCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IGJvdW5kIGV2ZW50IGhhbmRsZXJzLCB0aGUgcG9sbGluZyBsb29wCiAgICAgIC8vIGlzIHN0aWxsIG5lY2Vzc2FyeSBmb3IgYmFjay9uZXh0IHRvIHdvcmsgYXQgYWxsIQogICAgICBzZWxmLnN0b3AgPSBmbl9yZXR2YWw7CiAgICAgIAogICAgICAvLyBHZXQgaGlzdG9yeSBieSBsb29raW5nIGF0IHRoZSBoaWRkZW4gSWZyYW1lJ3MgbG9jYXRpb24uaGFzaC4KICAgICAgaGlzdG9yeV9nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0X2ZyYWdtZW50KCBpZnJhbWUubG9jYXRpb24uaHJlZiApOwogICAgICB9OwogICAgICAKICAgICAgLy8gU2V0IGEgbmV3IGhpc3RvcnkgaXRlbSBieSBvcGVuaW5nIGFuZCB0aGVuIGNsb3NpbmcgdGhlIElmcmFtZQogICAgICAvLyBkb2N1bWVudCwgKnRoZW4qIHNldHRpbmcgaXRzIGxvY2F0aW9uLmhhc2guIElmIGRvY3VtZW50LmRvbWFpbiBoYXMKICAgICAgLy8gYmVlbiBzZXQsIHVwZGF0ZSB0aGF0IGFzIHdlbGwuCiAgICAgIGhpc3Rvcnlfc2V0ID0gZnVuY3Rpb24oIGhhc2gsIGhpc3RvcnlfaGFzaCApIHsKICAgICAgICB2YXIgaWZyYW1lX2RvYyA9IGlmcmFtZS5kb2N1bWVudCwKICAgICAgICAgIGRvbWFpbiA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluOwogICAgICAgIAogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgCiAgICAgICAgICAvLyBPcGVuaW5nIHRoZSBJZnJhbWUncyBkb2N1bWVudCBhZnRlciBpdCBoYXMgYmVlbiBjbG9zZWQgaXMgd2hhdAogICAgICAgICAgLy8gYWN0dWFsbHkgYWRkcyBhIGhpc3RvcnkgZW50cnkuCiAgICAgICAgICBpZnJhbWVfZG9jLm9wZW4oKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0IGRvY3VtZW50LmRvbWFpbiBmb3IgdGhlIElmcmFtZSBkb2N1bWVudCBhcyB3ZWxsLCBpZiBuZWNlc3NhcnkuCiAgICAgICAgICBkb21haW4gJiYgaWZyYW1lX2RvYy53cml0ZSggJzxzY3JpcHQ+ZG9jdW1lbnQuZG9tYWluPSInICsgZG9tYWluICsgJyI8L3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLyohIG1hdGNoTWVkaWEoKSBwb2x5ZmlsbCAtIFRlc3QgYSBDU1MgbWVkaWEgdHlwZS9xdWVyeSBpbiBKUy4gQXV0aG9ycyAmIGNvcHlyaWdodCAoYykgMjAxMjogU2NvdHQgSmVobCwgUGF1bCBJcmlzaCwgTmljaG9sYXMgWmFrYXMuIER1YWwgTUlUL0JTRCBsaWNlbnNlICovCgl3aW5kb3cubWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhIHx8IChmdW5jdGlvbiggZG9jLCB1bmRlZmluZWQgKSB7CgoJCXZhciBib29sLAoJCQlkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudCwKCQkJcmVmTm9kZSA9IGRvY0VsZW0uZmlyc3RFbGVtZW50Q2hpbGQgfHwgZG9jRWxlbS5maXJzdENoaWxkLAoJCQkvLyBmYWtlQm9keSByZXF1aXJlZCBmb3IgPEZGNCB3aGVuIGV4ZWN1dGVkIGluIDxoZWFkPgoJCQlmYWtlQm9keSA9IGRvYy5jcmVhdGVFbGVtZW50KCAiYm9keSIgKSwKCQkJZGl2ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgoJCWRpdi5pZCA9ICJtcS10ZXN0LTEiOwoJCWRpdi5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOmFic29sdXRlO3RvcDotMTAwZW0iOwoJCWZha2VCb2R5LnN0eWxlLmJhY2tncm91bmQgPSAibm9uZSI7CgkJZmFrZUJvZHkuYXBwZW5kQ2hpbGQoZGl2KTsKCgkJcmV0dXJuIGZ1bmN0aW9uKHEpewoKCQkJZGl2LmlubmVySFRNTCA9ICImc2h5OzxzdHlsZSBtZWRpYT1cIiIgKyBxICsgIlwiPiAjbXEtdGVzdC0xIHsgd2lkdGg6IDQycHg7IH08L3N0eWxlPiI7CgoJCQlkb2NFbGVtLmluc2VydEJlZm9yZSggZmFrZUJvZHksIHJlZk5vZGUgKTsKCQkJYm9vbCA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gNDI7CgkJCWRvY0VsZW0ucmVtb3ZlQ2hpbGQoIGZha2VCb2R5ICk7CgoJCQlyZXR1cm4gewoJCQkJbWF0Y2hlczogYm9vbCwKCQkJCW1lZGlhOiBxCgkJCX07CgoJCX07CgoJfSggZG9jdW1lbnQgKSk7CgoJLy8gJC5tb2JpbGUubWVkaWEgdXNlcyBtYXRjaE1lZGlhIHRvIHJldHVybiBhIGJvb2xlYW4uCgkkLm1vYmlsZS5tZWRpYSA9IGZ1bmN0aW9uKCBxICkgewoJCXJldHVybiB3aW5kb3cubWF0Y2hNZWRpYSggcSApLm1hdGNoZXM7Cgl9OwoKfSkoalF1ZXJ5KTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgc3VwcG9ydCA9IHsKCQkJdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudAoJCX07CgoJCSQubW9iaWxlLnN1cHBvcnQgPSAkLm1vYmlsZS5zdXBwb3J0IHx8IHt9OwoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHN1cHBvcnQgKTsKCQkkLmV4dGVuZCggJC5tb2JpbGUuc3VwcG9ydCwgc3VwcG9ydCApOwoJfSggalF1ZXJ5ICkpOwoKCShmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCQkJb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIgaW4gd2luZG93ICYmICJvbm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cKCQl9KTsKCX0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gdGh4IE1vZGVybml6cgpmdW5jdGlvbiBwcm9wRXhpc3RzKCBwcm9wICkgewoJdmFyIHVjX3Byb3AgPSBwcm9wLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnN1YnN0ciggMSApLAoJCXByb3BzID0gKCBwcm9wICsgIiAiICsgdmVuZG9ycy5qb2luKCB1Y19wcm9wICsgIiAiICkgKyB1Y19wcm9wICkuc3BsaXQoICIgIiApLAoJCXY7CgoJZm9yICggdiBpbiBwcm9wcyApIHsKCQlpZiAoIGZiQ1NTWyBwcm9wc1sgdiBdIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQp9Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5ICYmICFwcm9wRXhpc3RzKCAiLXdlYmtpdC10cmFuc2Zvcm0iICksIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQiA1IGFuZCBsb3dlcgoJbm9raWFMVEU3XzM7CgovLyBpbmxpbmUgU1ZHIHN1cHBvcnQgdGVzdApmdW5jdGlvbiBpbmxpbmVTVkcoKSB7CgkvLyBUaGFua3MgTW9kZXJuaXpyICYgRXJpayBEYWhsc3Ryb20KCXZhciB3ID0gd2luZG93LAoJCXN2ZyA9ICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMgJiYgISF3LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyggImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwgInN2ZyIgKS5jcmVhdGVTVkdSZWN0ICYmICEoIHcub3BlcmEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQ2hyb21lIiApID09PSAtMSApLAoJCXN1cHBvcnQgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJaWYgKCAhKCBkYXRhICYmIHN2ZyApICkgewoJCQkJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub3N2ZyIgKTsKCQkJfQoJCX0sCgkJaW1nID0gbmV3IHcuSW1hZ2UoKTsKCglpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGZhbHNlICk7Cgl9OwoJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGltZy53aWR0aCA9PT0gMSAmJiBpbWcuaGVpZ2h0ID09PSAxICk7Cgl9OwoJaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFBQUFBUC8vL3l3QUFBQUFBUUFCQUFBQ0FVd0FPdz09IjsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKSwKCQllbCwgdHJhbnNmb3JtcywgdDsKCglpZiAoIHJldCApIHsKCQlyZXR1cm4gISFyZXQ7Cgl9CgoJZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJdHJhbnNmb3JtcyA9IHsKCQkvLyBXZeKAmXJlIG9taXR0aW5nIE9wZXJhIGZvciB0aGUgdGltZSBiZWluZzsgTVMgdXNlcyB1bnByZWZpeGVkLgoJCSJNb3pUcmFuc2Zvcm0iOiAiLW1vei10cmFuc2Zvcm0iLAoJCSJ0cmFuc2Zvcm0iOiAidHJhbnNmb3JtIgoJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdCBpbiB0cmFuc2Zvcm1zICkgewoJCWlmICggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICkgewoJCQllbC5zdHlsZVsgdCBdID0gInRyYW5zbGF0ZTNkKCAxMDBweCwgMXB4LCAxcHggKSI7CgkJCXJldCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbCApLmdldFByb3BlcnR5VmFsdWUoIHRyYW5zZm9ybXNbIHQgXSApOwoJCX0KCX0KCXJldHVybiAoICEhcmV0ICYmIHJldCAhPT0gIm5vbmUiICk7Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKLy8gVGhhbmtzIE1vZGVybml6cgpmdW5jdGlvbiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpIHsKCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIngiICksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiAoICEoICJwb2ludGVyRXZlbnRzIiBpbiBlbGVtZW50LnN0eWxlICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJ4IjsKCWRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCggZWxlbWVudCApOwoJc3VwcG9ydHMgPSBnZXRDb21wdXRlZFN0eWxlICYmCglnZXRDb21wdXRlZFN0eWxlKCBlbGVtZW50LCAiIiApLnBvaW50ZXJFdmVudHMgPT09ICJhdXRvIjsKCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggZWxlbWVudCApOwoJcmV0dXJuICEhc3VwcG9ydHM7Cn0KCmZ1bmN0aW9uIGJvdW5kaW5nUmVjdCgpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJcmV0dXJuIHR5cGVvZiBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIjsKfQoKLy8gbm9uLVVBLWJhc2VkIElFIHZlcnNpb24gY2hlY2sgYnkgSmFtZXMgUGFkb2xzZXksIG1vZGlmaWVkIGJ5IGpkYWx0b24gLSBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTI3NjgzCi8vIGFsbG93cyBmb3IgaW5jbHVzaW9uIG9mIElFIDYrLCBpbmNsdWRpbmcgV2luZG93cyBNb2JpbGUgNwokLmV4dGVuZCggJC5tb2JpbGUsIHsgYnJvd3Nlcjoge30gfSApOwokLm1vYmlsZS5icm93c2VyLm9sZElFID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJYSA9IGRpdi5hbGwgfHwgW107CgoJZG8gewoJCWRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iOwoJfSB3aGlsZSggYVswXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCmZ1bmN0aW9uIGZpeGVkUG9zaXRpb24oKSB7Cgl2YXIgdyA9IHdpbmRvdywKCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCglpZiAoCgkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCS8vIE9wZXJhIE1pbmkKCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCS8vIE1lZUdvCgkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJcmV0dXJuIHRydWU7Cn0KCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCS8vIE5vdGUsIENocm9tZSBmb3IgaU9TIGhhcyBhbiBleHRyZW1lbHkgcXVpcmt5IGltcGxlbWVudGF0aW9uIG9mIHBvcHN0YXRlLgoJLy8gV2UndmUgY2hvc2VuIHRvIHRha2UgdGhlIHNob3J0ZXN0IHBhdGggdG8gYSBidWcgZml4IGhlcmUgZm9yIGlzc3VlICM1NDI2CgkvLyBTZWUgdGhlIGZvbGxvd2luZyBsaW5rIGZvciBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcmVnZXggY2hvc2VuCgkvLyBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9jaHJvbWUvbW9iaWxlL2RvY3MvdXNlci1hZ2VudCNjaHJvbWVfZm9yX2lvc191c2VyLWFnZW50CglwdXNoU3RhdGU6ICJwdXNoU3RhdGUiIGluIGhpc3RvcnkgJiYKCQkicmVwbGFjZVN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJLy8gV2hlbiBydW5uaW5nIGluc2lkZSBhIEZGIGlmcmFtZSwgY2FsbGluZyByZXBsYWNlU3RhdGUgY2F1c2VzIGFuIGVycm9yCgkJISggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkZpcmVmb3giICkgPj0gMCAmJiB3aW5kb3cudG9wICE9PSB3aW5kb3cgKSAmJgoJCSggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuc2VhcmNoKC9DcmlPUy8pID09PSAtMSApLAoKCW1lZGlhcXVlcnk6ICQubW9iaWxlLm1lZGlhKCAib25seSBhbGwiICksCgljc3NQc2V1ZG9FbGVtZW50OiAhIXByb3BFeGlzdHMoICJjb250ZW50IiApLAoJdG91Y2hPdmVyZmxvdzogISFwcm9wRXhpc3RzKCAib3ZlcmZsb3dTY3JvbGxpbmciICksCgljc3NUcmFuc2Zvcm0zZDogdHJhbnNmb3JtM2RUZXN0KCksCglib3hTaGFkb3c6ICEhcHJvcEV4aXN0cyggImJveFNoYWRvdyIgKSAmJiAhYmIsCglmaXhlZFBvc2l0aW9uOiBmaXhlZFBvc2l0aW9uKCksCglzY3JvbGxUb3A6ICgicGFnZVhPZmZzZXQiIGluIHdpbmRvdyB8fAoJCSJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fAoJCSJzY3JvbGxUb3AiIGluIGZha2VCb2R5WyAwIF0pICYmICF3ZWJvcyAmJiAhb3BlcmFtaW5pLAoKCWR5bmFtaWNCYXNlVGFnOiBiYXNlVGFnVGVzdCgpLAoJY3NzUG9pbnRlckV2ZW50czogY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSwKCWJvdW5kaW5nUmVjdDogYm91bmRpbmdSZWN0KCksCglpbmxpbmVTVkc6IGlubGluZVNWRwp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKLy8gJC5tb2JpbGUuYWpheEJsYWNrbGlzdCBpcyB1c2VkIHRvIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMgKEJCNSwgU3ltYmlhbikKLy8gb3IgdGhhdCBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChPcGVyYSBNaW5pKQovLyBOb3RlOiBUaGlzIGRldGVjdGlvbiBiZWxvdyBpcyB1c2VkIGFzIGEgbGFzdCByZXNvcnQuCi8vIFdlIHJlY29tbWVuZCBvbmx5IHVzaW5nIHRoZXNlIGRldGVjdGlvbiBtZXRob2RzIHdoZW4gYWxsIG90aGVyIG1vcmUgcmVsaWFibGUvZm9yd2FyZC1sb29raW5nIGFwcHJvYWNoZXMgYXJlIG5vdCBwb3NzaWJsZQpub2tpYUxURTdfMyA9IChmdW5jdGlvbigpIHsKCgl2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCgkvL1RoZSBmb2xsb3dpbmcgaXMgYW4gYXR0ZW1wdCB0byBtYXRjaCBOb2tpYSBicm93c2VycyB0aGF0IGFyZSBydW5uaW5nIFN5bWJpYW4vczYwLCB3aXRoIHdlYmtpdCwgdmVyc2lvbiA3LjMgb3Igb2xkZXIKCXJldHVybiB1YS5pbmRleE9mKCAiTm9raWEiICkgPiAtMSAmJgoJCQkoIHVhLmluZGV4T2YoICJTeW1iaWFuLzMiICkgPiAtMSB8fCB1YS5pbmRleE9mKCAiU2VyaWVzNjAvNSIgKSA+IC0xICkgJiYKCQkJdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgJiYKCQkJdWEubWF0Y2goIC8oQnJvd3Nlck5HfE5va2lhQnJvd3NlcilcLzdcLlswLTNdLyApOwp9KSgpOwoKLy8gU3VwcG9ydCBjb25kaXRpb25zIHRoYXQgbXVzdCBiZSBtZXQgaW4gb3JkZXIgdG8gcHJvY2VlZAovLyBkZWZhdWx0IGVuaGFuY2VkIHF1YWxpZmljYXRpb25zIGFyZSBtZWRpYSBxdWVyeSBzdXBwb3J0IE9SIElFIDcrCgokLm1vYmlsZS5ncmFkZUEgPSBmdW5jdGlvbigpIHsKCXJldHVybiAoICggJC5zdXBwb3J0Lm1lZGlhcXVlcnkgJiYgJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQgKSB8fCAkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICQubW9iaWxlLmJyb3dzZXIub2xkSUUgPj0gOCApICYmICggJC5zdXBwb3J0LmJvdW5kaW5nUmVjdCB8fCAkLmZuLmpxdWVyeS5tYXRjaCgvMVwuWzAtNytdXC5bMC05K10/LykgIT09IG51bGwgKTsKfTsKCiQubW9iaWxlLmFqYXhCbGFja2xpc3QgPQoJCQkvLyBCbGFja0JlcnJ5IGJyb3dzZXJzLCBwcmUtd2Via2l0CgkJCXdpbmRvdy5ibGFja2JlcnJ5ICYmICF3aW5kb3cuV2ViS2l0UG9pbnQgfHwKCQkJLy8gT3BlcmEgTWluaQoJCQlvcGVyYW1pbmkgfHwKCQkJLy8gU3ltYmlhbiB3ZWJraXRzIHByZSA3LjMKCQkJbm9raWFMVEU3XzM7CgovLyBMYXN0bHksIHRoaXMgd29ya2Fyb3VuZCBpcyB0aGUgb25seSB3YXkgd2UndmUgZm91bmQgc28gZmFyIHRvIGdldCBwcmUgNy4zIFN5bWJpYW4gd2Via2l0IGRldmljZXMKLy8gdG8gcmVuZGVyIHRoZSBzdHlsZXNoZWV0cyB3aGVuIHRoZXkncmUgcmVmZXJlbmNlZCBiZWZvcmUgdGhpcyBzY3JpcHQsIGFzIHdlJ2QgcmVjb21tZW5kIGRvaW5nLgovLyBUaGlzIHNpbXBseSByZWFwcGVuZHMgdGhlIENTUyBpbiBwbGFjZSwgd2hpY2ggZm9yIHNvbWUgcmVhc29uIG1ha2VzIGl0IGFwcGx5CmlmICggbm9raWFMVEU3XzMgKSB7CgkkKGZ1bmN0aW9uKCkgewoJCSQoICJoZWFkIGxpbmtbcmVsPSdzdHlsZXNoZWV0J10iICkuYXR0ciggInJlbCIsICJhbHRlcm5hdGUgc3R5bGVzaGVldCIgKS5hdHRyKCAicmVsIiwgInN0eWxlc2hlZXQiICk7Cgl9KTsKfQoKLy8gRm9yIHJ1bGluZyBvdXQgc2hhZG93cyB2aWEgY3NzCmlmICggISQuc3VwcG9ydC5ib3hTaGFkb3cgKSB7CgkkKCAiaHRtbCIgKS5hZGRDbGFzcyggInVpLW5vYm94c2hhZG93IiApOwp9Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdywgc2VsZiwKCQlkdW1teUZuVG9Jbml0TmF2aWdhdGUgPSBmdW5jdGlvbigpIHsKCQl9OwoKCSQuZXZlbnQuc3BlY2lhbC5iZWZvcmVuYXZpZ2F0ZSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSR3aW4ub24oICJuYXZpZ2F0ZSIsIGR1bW15Rm5Ub0luaXROYXZpZ2F0ZSApOwoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJHdpbi5vZmYoICJuYXZpZ2F0ZSIsIGR1bW15Rm5Ub0luaXROYXZpZ2F0ZSApOwoJCX0KCX07CgoJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlID0gc2VsZiA9IHsKCQlib3VuZDogZmFsc2UsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCW9yaWdpbmFsRXZlbnROYW1lOiB1bmRlZmluZWQsCgoJCS8vIElmIHB1c2hzdGF0ZSBzdXBwb3J0IGlzIHByZXNlbnQgYW5kIHB1c2ggc3RhdGUgc3VwcG9ydCBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgdHJ1ZSBvbiB0aGUgbW9iaWxlIG5hbWVzcGFjZS4KCQlpc1B1c2hTdGF0ZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5zdXBwb3J0LnB1c2hTdGF0ZSAmJgoJCQkJJC5tb2JpbGUucHVzaFN0YXRlRW5hYmxlZCA9PT0gdHJ1ZSAmJgoJCQkJdGhpcy5pc0hhc2hDaGFuZ2VFbmFibGVkKCk7CgkJfSwKCgkJLy8gISEgYXNzdW1lcyBtb2JpbGUgbmFtZXNwYWNlIGlzIHByZXNlbnQKCQlpc0hhc2hDaGFuZ2VFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkID09PSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gYSBsb3Qgb2YgZHVwbGljYXRpb24gYmV0d2VlbiBwb3BzdGF0ZSBhbmQgaGFzaGNoYW5nZQoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICksCgkJCQlzdGF0ZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge307CgoJCQliZWZvcmVOYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmICggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggZXZlbnQuaGlzdG9yeVN0YXRlICkgewoJCQkJJC5leHRlbmQoc3RhdGUsIGV2ZW50Lmhpc3RvcnlTdGF0ZSk7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBOT1RFIHdlIGxldCB0aGUgY3VycmVudCBzdGFjayB1bndpbmQgYmVjYXVzZSBhbnkgYXNzaWdubWVudCB0bwoJCQkvLyAgICAgIGxvY2F0aW9uLmhhc2ggd2lsbCBzdG9wIHRoZSB3b3JsZCBhbmQgcnVuIHRoaXMgZXZlbnQgaGFuZGxlci4gQnkKCQkJLy8gICAgICBkb2luZyB0aGlzIHdlIGNyZWF0ZSBhIHNpbWlsYXIgYmVoYXZpb3IgdG8gaGFzaGNoYW5nZSBvbiBoYXNoCgkJCS8vICAgICAgYXNzaWdubWVudAoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJJHdpbi50cmlnZ2VyKCBuZXdFdmVudCwgewoJCQkJCXN0YXRlOiBzdGF0ZQoJCQkJfSk7CgkJCX0sIDApOwoJCX0sCgoJCWhhc2hjaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCAvKiwgZGF0YSAqLyApIHsKCQkJdmFyIG5ld0V2ZW50ID0gbmV3ICQuRXZlbnQoICJuYXZpZ2F0ZSIgKSwKCQkJCWJlZm9yZU5hdmlnYXRlID0gbmV3ICQuRXZlbnQoICJiZWZvcmVuYXZpZ2F0ZSIgKTsKCgkJCWJlZm9yZU5hdmlnYXRlLm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYgKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIFRyaWdnZXIgdGhlIGhhc2hjaGFuZ2Ugd2l0aCBzdGF0ZSBwcm92aWRlZCBieSB0aGUgdXNlcgoJCQkvLyB0aGF0IGFsdGVyZWQgdGhlIGhhc2gKCQkJJHdpbi50cmlnZ2VyKCBuZXdFdmVudCwgewoJCQkJLy8gVXNlcnMgdGhhdCB3YW50IHRvIGZ1bGx5IG5vcm1hbGl6ZSB0aGUgdHdvIGV2ZW50cwoJCQkJLy8gd2lsbCBuZWVkIHRvIGRvIGhpc3RvcnkgbWFuYWdlbWVudCBkb3duIHRoZSBzdGFjayBhbmQKCQkJCS8vIGFkZCB0aGUgc3RhdGUgdG8gdGhlIGV2ZW50IGJlZm9yZSB0aGlzIGJpbmRpbmcgaXMgZmlyZWQKCQkJCS8vIFRPRE8gY29uc2lkZXIgYWxsb3dpbmcgZm9yIHRoZSBleHBsaWNpdCBhZGRpdGlvbiBvZiBjYWxsYmFja3MKCQkJCS8vICAgICAgdG8gYmUgZmlyZWQgYmVmb3JlIHRoaXMgdmFsdWUgaXMgc2V0IHRvIGF2b2lkIGV2ZW50IHRpbWluZyBpc3N1ZXMKCQkJCXN0YXRlOiBldmVudC5oYXNoY2hhbmdlU3RhdGUgfHwge30KCQkJfSk7CgkJfSwKCgkJLy8gVE9ETyBXZSByZWFsbHkgb25seSB3YW50IHRvIHNldCB0aGlzIHVwIG9uY2UKCQkvLyAgICAgIGJ1dCBJJ20gbm90IGNsZWFyIGlmIHRoZXJlJ3MgYSBiZXRlciB3YXkgdG8gYWNoaWV2ZQoJCS8vICAgICAgdGhpcyB3aXRoIHRoZSBqUXVlcnkgc3BlY2lhbCBldmVudCBzdHJ1Y3R1cmUKCQlzZXR1cDogZnVuY3Rpb24oIC8qIGRhdGEsIG5hbWVzcGFjZXMgKi8gKSB7CgkJCWlmICggc2VsZi5ib3VuZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJc2VsZi5ib3VuZCA9IHRydWU7CgoJCQlpZiAoIHNlbGYuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gInBvcHN0YXRlIjsKCQkJCSR3aW4uYmluZCggInBvcHN0YXRlLm5hdmlnYXRlIiwgc2VsZi5wb3BzdGF0ZSApOwoJCQl9IGVsc2UgaWYgKCBzZWxmLmlzSGFzaENoYW5nZUVuYWJsZWQoKSApIHsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAiaGFzaGNoYW5nZSI7CgkJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlLm5hdmlnYXRlIiwgc2VsZi5oYXNoY2hhbmdlICk7CgkJCX0KCQl9Cgl9Owp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCXZhciBwYXRoLCAkYmFzZSwgZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIjsKCgkJJC5tb2JpbGUucGF0aCA9IHBhdGggPSB7CgkJCXVpU3RhdGVLZXk6ICImdWktc3RhdGUiLAoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXlxzKigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy8gQWJzdHJhY3Rpb24gdG8gYWRkcmVzcyB4c3MgKElzc3VlICM0Nzg3KSBieSByZW1vdmluZyB0aGUgYXV0aG9yaXR5IGluCgkJCS8vIGJyb3dzZXJzIHRoYXQgYXV0bwlkZWNvZGUgaXQuIEFsbCByZWZlcmVuY2VzIHRvIGxvY2F0aW9uLmhyZWYgc2hvdWxkIGJlCgkJCS8vIHJlcGxhY2VkIHdpdGggYSBjYWxsIHRvIHRoaXMgbWV0aG9kIHNvIHRoYXQgaXQgY2FuIGJlIGRlYWx0IHdpdGggcHJvcGVybHkgaGVyZQoJCQlnZXRMb2NhdGlvbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1cmkgPSB1cmwgPyB0aGlzLnBhcnNlVXJsKCB1cmwgKSA6IGxvY2F0aW9uLAoJCQkJCWhhc2ggPSB0aGlzLnBhcnNlVXJsKCB1cmwgfHwgbG9jYXRpb24uaHJlZiApLmhhc2g7CgoJCQkJLy8gbWltaWMgdGhlIGJyb3dzZXIgd2l0aCBhbiBlbXB0eSBzdHJpbmcgd2hlbiB0aGUgaGFzaCBpcyBlbXB0eQoJCQkJaGFzaCA9IGhhc2ggPT09ICIjIiA/ICIiIDogaGFzaDsKCgkJCQkvLyBNYWtlIHN1cmUgdG8gcGFyc2UgdGhlIHVybCBvciB0aGUgbG9jYXRpb24gb2JqZWN0IGZvciB0aGUgaGFzaCBiZWNhdXNlIHVzaW5nIGxvY2F0aW9uLmhhc2gKCQkJCS8vIGlzIGF1dG9kZWNvZGVkIGluIGZpcmVmb3gsIHRoZSByZXN0IG9mIHRoZSB1cmwgc2hvdWxkIGJlIGZyb20gdGhlIG9iamVjdCAobG9jYXRpb24gdW5sZXNzCgkJCQkvLyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZSBhdXRob3JpdHkKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKyAiLy8iICsgdXJpLmhvc3QgKyB1cmkucGF0aG5hbWUgKyB1cmkuc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQkJZ2V0RG9jdW1lbnRVcmw6IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudFVybCApIDogcGF0aC5kb2N1bWVudFVybC5ocmVmOwoJCQl9LAoKCQkJcGFyc2VMb2NhdGlvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5wYXJzZVVybCggdGhpcy5nZXRMb2NhdGlvbigpICk7CgkJCX0sCgoJCQkvL1BhcnNlIGEgVVJMIGludG8gYSBzdHJ1Y3R1cmUgdGhhdCBhbGxvd3MgZWFzeSBhY2Nlc3MgdG8KCQkJLy9hbGwgb2YgdGhlIFVSTCBjb21wb25lbnRzIGJ5IG5hbWUuCgkJCXBhcnNlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gSWYgd2UncmUgcGFzc2VkIGFuIG9iamVjdCwgd2UnbGwgYXNzdW1lIHRoYXQgaXQgaXMKCQkJCS8vIGEgcGFyc2VkIHVybCBvYmplY3QgYW5kIGp1c3QgcmV0dXJuIGl0IGJhY2sgdG8gdGhlIGNhbGxlci4KCQkJCWlmICggJC50eXBlKCB1cmwgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQkJcmV0dXJuIHVybDsKCQkJCX0KCgkJCQl2YXIgbWF0Y2hlcyA9IHBhdGgudXJsUGFyc2VSRS5leGVjKCB1cmwgfHwgIiIgKSB8fCBbXTsKCgkJCQkJLy8gQ3JlYXRlIGFuIG9iamVjdCB0aGF0IGFsbG93cyB0aGUgY2FsbGVyIHRvIGFjY2VzcyB0aGUgc3ViLW1hdGNoZXMKCQkJCQkvLyBieSBuYW1lLiBOb3RlIHRoYXQgSUUgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiB1bmRlZmluZWQsCgkJCQkJLy8gbGlrZSBhbGwgb3RoZXIgYnJvd3NlcnMgZG8sIHNvIHdlIG5vcm1hbGl6ZSBldmVyeXRoaW5nIHNvIGl0cyBjb25zaXN0ZW50CgkJCQkJLy8gbm8gbWF0dGVyIHdoYXQgYnJvd3NlciB3ZSdyZSBydW5uaW5nIG9uLgoJCQkJCXJldHVybiB7CgkJCQkJCWhyZWY6ICAgICAgICAgbWF0Y2hlc1sgIDAgXSB8fCAiIiwKCQkJCQkJaHJlZk5vSGFzaDogICBtYXRjaGVzWyAgMSBdIHx8ICIiLAoJCQkJCQlocmVmTm9TZWFyY2g6IG1hdGNoZXNbICAyIF0gfHwgIiIsCgkJCQkJCWRvbWFpbjogICAgICAgbWF0Y2hlc1sgIDMgXSB8fCAiIiwKCQkJCQkJcHJvdG9jb2w6ICAgICBtYXRjaGVzWyAgNCBdIHx8ICIiLAoJCQkJCQlkb3VibGVTbGFzaDogIG1hdGNoZXNbICA1IF0gfHwgIiIsCgkJCQkJCWF1dGhvcml0eTogICAgbWF0Y2hlc1sgIDYgXSB8fCAiIiwKCQkJCQkJdXNlcm5hbWU6ICAgICBtYXRjaGVzWyAgOCBdIHx8ICIiLAoJCQkJCQlwYXNzd29yZDogICAgIG1hdGNoZXNbICA5IF0gfHwgIiIsCgkJCQkJCWhvc3Q6ICAgICAgICAgbWF0Y2hlc1sgMTAgXSB8fCAiIiwKCQkJCQkJaG9zdG5hbWU6ICAgICBtYXRjaGVzWyAxMSBdIHx8ICIiLAoJCQkJCQlwb3J0OiAgICAgICAgIG1hdGNoZXNbIDEyIF0gfHwgIiIsCgkJCQkJCXBhdGhuYW1lOiAgICAgbWF0Y2hlc1sgMTMgXSB8fCAiIiwKCQkJCQkJZGlyZWN0b3J5OiAgICBtYXRjaGVzWyAxNCBdIHx8ICIiLAoJCQkJCQlmaWxlbmFtZTogICAgIG1hdGNoZXNbIDE1IF0gfHwgIiIsCgkJCQkJCXNlYXJjaDogICAgICAgbWF0Y2hlc1sgMTYgXSB8fCAiIiwKCQkJCQkJaGFzaDogICAgICAgICBtYXRjaGVzWyAxNyBdIHx8ICIiCgkJCQkJfTsKCQkJfSwKCgkJCS8vVHVybiByZWxQYXRoIGludG8gYW4gYXNib2x1dGUgcGF0aC4gYWJzUGF0aCBpcwoJCQkvL2FuIG9wdGlvbmFsIGFic29sdXRlIHBhdGggd2hpY2ggZGVzY3JpYmVzIHdoYXQKCQkJLy9yZWxQYXRoIGlzIHJlbGF0aXZlIHRvLgoJCQltYWtlUGF0aEFic29sdXRlOiBmdW5jdGlvbiggcmVsUGF0aCwgYWJzUGF0aCApIHsKCQkJCXZhciBhYnNTdGFjaywKCQkJCQlyZWxTdGFjaywKCQkJCQlpLCBkOwoKCQkJCWlmICggcmVsUGF0aCAmJiByZWxQYXRoLmNoYXJBdCggMCApID09PSAiLyIgKSB7CgkJCQkJcmV0dXJuIHJlbFBhdGg7CgkJCQl9CgoJCQkJcmVsUGF0aCA9IHJlbFBhdGggfHwgIiI7CgkJCQlhYnNQYXRoID0gYWJzUGF0aCA/IGFic1BhdGgucmVwbGFjZSggL15cL3woXC9bXlwvXSp8W15cL10rKSQvZywgIiIgKSA6ICIiOwoKCQkJCWFic1N0YWNrID0gYWJzUGF0aCA/IGFic1BhdGguc3BsaXQoICIvIiApIDogW107CgkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoKCQkJCWZvciAoIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJZCA9IHJlbFN0YWNrWyBpIF07CgkJCQkJc3dpdGNoICggZCApIHsKCQkJCQkJY2FzZSAiLiI6CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiLi4iOgoJCQkJCQkJaWYgKCBhYnNTdGFjay5sZW5ndGggKSB7CgkJCQkJCQkJYWJzU3RhY2sucG9wKCk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCWFic1N0YWNrLnB1c2goIGQgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAiLyIgKyBhYnNTdGFjay5qb2luKCAiLyIgKTsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGlmIGJvdGggdXJscyBoYXZlIHRoZSBzYW1lIGRvbWFpbi4KCQkJaXNTYW1lRG9tYWluOiBmdW5jdGlvbiggYWJzVXJsMSwgYWJzVXJsMiApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCBhYnNVcmwxICkuZG9tYWluID09PSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwyICkuZG9tYWluOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFueSByZWxhdGl2ZSB2YXJpYW50LgoJCQlpc1JlbGF0aXZlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gQWxsIHJlbGF0aXZlIFVybCB2YXJpYW50cyBoYXZlIG9uZSB0aGluZyBpbiBjb21tb24sIG5vIHByb3RvY29sLgoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sID09PSAiIjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbiBhYnNvbHV0ZSB1cmwuCgkJCWlzQWJzb2x1dGVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgIT09ICIiOwoJCQl9LAoKCQkJLy9UdXJuIHRoZSBzcGVjaWZpZWQgcmVhbHRpdmUgVVJMIGludG8gYW4gYWJzb2x1dGUgb25lLiBUaGlzIGZ1bmN0aW9uCgkJCS8vY2FuIGhhbmRsZSBhbGwgcmVsYXRpdmUgdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGZyYWdtZW50KS4KCQkJbWFrZVVybEFic29sdXRlOiBmdW5jdGlvbiggcmVsVXJsLCBhYnNVcmwgKSB7CgkJCQlpZiAoICFwYXRoLmlzUmVsYXRpdmVVcmwoIHJlbFVybCApICkgewoJCQkJCXJldHVybiByZWxVcmw7CgkJCQl9CgoJCQkJaWYgKCBhYnNVcmwgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlhYnNVcmwgPSB0aGlzLmRvY3VtZW50QmFzZTsKCQkJCX0KCgkJCQl2YXIgcmVsT2JqID0gcGF0aC5wYXJzZVVybCggcmVsVXJsICksCgkJCQkJYWJzT2JqID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICksCgkJCQkJcHJvdG9jb2wgPSByZWxPYmoucHJvdG9jb2wgfHwgYWJzT2JqLnByb3RvY29sLAoJCQkJCWRvdWJsZVNsYXNoID0gcmVsT2JqLnByb3RvY29sID8gcmVsT2JqLmRvdWJsZVNsYXNoIDogKCByZWxPYmouZG91YmxlU2xhc2ggfHwgYWJzT2JqLmRvdWJsZVNsYXNoICksCgkJCQkJYXV0aG9yaXR5ID0gcmVsT2JqLmF1dGhvcml0eSB8fCBhYnNPYmouYXV0aG9yaXR5LAoJCQkJCWhhc1BhdGggPSByZWxPYmoucGF0aG5hbWUgIT09ICIiLAoJCQkJCXBhdGhuYW1lID0gcGF0aC5tYWtlUGF0aEFic29sdXRlKCByZWxPYmoucGF0aG5hbWUgfHwgYWJzT2JqLmZpbGVuYW1lLCBhYnNPYmoucGF0aG5hbWUgKSwKCQkJCQlzZWFyY2ggPSByZWxPYmouc2VhcmNoIHx8ICggIWhhc1BhdGggJiYgYWJzT2JqLnNlYXJjaCApIHx8ICIiLAoJCQkJCWhhc2ggPSByZWxPYmouaGFzaDsKCgkJCQlyZXR1cm4gcHJvdG9jb2wgKyBkb3VibGVTbGFzaCArIGF1dGhvcml0eSArIHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCS8vQWRkIHNlYXJjaCAoYWthIHF1ZXJ5KSBwYXJhbXMgdG8gdGhlIHNwZWNpZmllZCB1cmwuCgkJCWFkZFNlYXJjaFBhcmFtczogZnVuY3Rpb24oIHVybCwgcGFyYW1zICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwID0gKCB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApID8gJC5wYXJhbSggcGFyYW1zICkgOiBwYXJhbXMsCgkJCQkJcyA9IHUuc2VhcmNoIHx8ICI/IjsKCQkJCXJldHVybiB1LmhyZWZOb1NlYXJjaCArIHMgKyAoIHMuY2hhckF0KCBzLmxlbmd0aCAtIDEgKSAhPT0gIj8iID8gIiYiIDogIiIgKSArIHAgKyAoIHUuaGFzaCB8fCAiIiApOwoJCQl9LAoKCQkJY29udmVydFVybFRvRGF0YVVybDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICk7CgkJCQlpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIHUgKSApIHsKCQkJCQkvLyBGb3IgZW1iZWRkZWQgcGFnZXMsIHJlbW92ZSB0aGUgZGlhbG9nIGhhc2gga2V5IGFzIGluIGdldEZpbGVQYXRoKCksCgkJCQkJLy8gYW5kIHJlbW92ZSBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoCgkJCQkJCS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdCgkJCQkJCS5yZXBsYWNlKCAvXiMvLCAiIiApCgkJCQkJCS5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1NhbWVEb21haW4oIHUsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSB7CgkJCQkJcmV0dXJuIHUuaHJlZk5vSGFzaC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJCX0KCgkJCQlyZXR1cm4gd2luZG93LmRlY29kZVVSSUNvbXBvbmVudChhYnNVcmwpOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYgKCBuZXdQYXRoID09PSB1bmRlZmluZWQgKSB7CgkJCQkJbmV3UGF0aCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCQl9CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIG5ld1BhdGggKS5yZXBsYWNlKCAvW15cL10qXC5bXlwvKl0rJC8sICIiICk7CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKTsKCQkJfSwKCgkJCS8vanVzdCByZXR1cm4gdGhlIHVybCB3aXRob3V0IGFuIGluaXRpYWwgIwoJCQlzdHJpcEhhc2g6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCX0sCgoJCQlzdHJpcFF1ZXJ5UGFyYW1zOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJaXNIYXNoVmFsaWQ6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuICggL14jW14jXSskLyApLnRlc3QoIGhhc2ggKTsKCQkJfSwKCgkJCS8vY2hlY2sgd2hldGhlciBhIHVybCBpcyByZWZlcmVuY2luZyB0aGUgc2FtZSBkb21haW4sIG9yIGFuIGV4dGVybmFsIGRvbWFpbiBvciBkaWZmZXJlbnQgcHJvdG9jb2wKCQkJLy9jb3VsZCBiZSBtYWlsdG8sIGV0YwoJCQlpc0V4dGVybmFsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCQkJCXJldHVybiB1LnByb3RvY29sICYmIHUuZG9tYWluICE9PSB0aGlzLmRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgdGhpcy5kb2N1bWVudFVybCBhbmQgdGhlIGRvY3VtZW50QmFzZS4gVGhlIG1haW4gcmVhc29uIGZvciB0aGlzCgkJCQkvL2lzIHRoYXQgbGlua3MgZW1iZWRkZWQgd2l0aGluIGV4dGVybmFsIGRvY3VtZW50cyB3aWxsIHJlZmVyIHRvIHRoZQoJCQkJLy9hcHBsaWNhdGlvbiBkb2N1bWVudCwgd2hlcmVhcyBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gdGhlIGFwcGxpY2F0aW9uCgkJCQkvL2RvY3VtZW50IHdpbGwgYmUgcmVzb2x2ZWQgYWdhaW5zdCB0aGUgZG9jdW1lbnQgYmFzZS4KCQkJCWlmICggdS5wcm90b2NvbCAhPT0gIiIgKSB7CgkJCQkJcmV0dXJuICggIXRoaXMuaXNQYXRoKHUuaGFzaCkgJiYgdS5oYXNoICYmICggdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwgKCB0aGlzLmRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgKSApOwoJCQkJfQoJCQkJcmV0dXJuICggL14jLyApLnRlc3QoIHUuaHJlZiApOwoJCQl9LAoKCQkJc3F1YXNoOiBmdW5jdGlvbiggdXJsLCByZXNvbHV0aW9uVXJsICkgewoJCQkJdmFyIGhyZWYsIGNsZWFuZWRVcmwsIHNlYXJjaCwgc3RhdGVJbmRleCwKCQkJCQlpc1BhdGggPSB0aGlzLmlzUGF0aCggdXJsICksCgkJCQkJdXJpID0gdGhpcy5wYXJzZVVybCggdXJsICksCgkJCQkJcHJlc2VydmVkSGFzaCA9IHVyaS5oYXNoLAoJCQkJCXVpU3RhdGUgPSAiIjsKCgkJCQkvLyBwcm9kdWNlIGEgdXJsIGFnYWluc3Qgd2hpY2ggd2UgY2FuIHJlc29sZSB0aGUgcHJvdmlkZWQgcGF0aAoJCQkJcmVzb2x1dGlvblVybCA9IHJlc29sdXRpb25VcmwgfHwgKHBhdGguaXNQYXRoKHVybCkgPyBwYXRoLmdldExvY2F0aW9uKCkgOiBwYXRoLmdldERvY3VtZW50VXJsKCkpOwoKCQkJCS8vIElmIHRoZSB1cmwgaXMgYW55dGhpbmcgYnV0IGEgc2ltcGxlIHN0cmluZywgcmVtb3ZlIGFueSBwcmVjZWRpbmcgaGFzaAoJCQkJLy8gZWcgI2Zvby9iYXIgLT4gZm9vL2JhcgoJCQkJLy8gICAgI2ZvbyAtPiAjZm9vCgkJCQljbGVhbmVkVXJsID0gaXNQYXRoID8gcGF0aC5zdHJpcEhhc2goIHVybCApIDogdXJsOwoKCQkJCS8vIElmIHRoZSB1cmwgaXMgYSBmdWxsIHVybCB3aXRoIGEgaGFzaCBjaGVjayBpZiB0aGUgcGFyc2VkIGhhc2ggaXMgYSBwYXRoCgkJCQkvLyBpZiBpdCBpcywgc3RyaXAgdGhlICMsIGFuZCB1c2UgaXQgb3RoZXJ3aXNlIGNvbnRpbnVlIHdpdGhvdXQgY2hhbmdlCgkJCQljbGVhbmVkVXJsID0gcGF0aC5pc1BhdGgoIHVyaS5oYXNoICkgPyBwYXRoLnN0cmlwSGFzaCggdXJpLmhhc2ggKSA6IGNsZWFuZWRVcmw7CgoJCQkJLy8gU3BsaXQgdGhlIFVJIFN0YXRlIGtleXMgb2ZmIHRoZSBocmVmCgkJCQlzdGF0ZUluZGV4ID0gY2xlYW5lZFVybC5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKTsKCgkJCQkvLyBzdG9yZSB0aGUgdWkgc3RhdGUga2V5cyBmb3IgdXNlCgkJCQlpZiAoIHN0YXRlSW5kZXggPiAtMSApIHsKCQkJCQl1aVN0YXRlID0gY2xlYW5lZFVybC5zbGljZSggc3RhdGVJbmRleCApOwoJCQkJCWNsZWFuZWRVcmwgPSBjbGVhbmVkVXJsLnNsaWNlKCAwLCBzdGF0ZUluZGV4ICk7CgkJCQl9CgoJCQkJLy8gbWFrZSB0aGUgY2xlYW5lZFVybCBhYnNvbHV0ZSByZWxhdGl2ZSB0byB0aGUgcmVzb2x1dGlvbiB1cmwKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggY2xlYW5lZFVybCwgcmVzb2x1dGlvblVybCApOwoKCQkJCS8vIGdyYWIgdGhlIHNlYXJjaCBmcm9tIHRoZSByZXNvbHZlZCB1cmwgc2luY2UgcGFyc2luZyBmcm9tCgkJCQkvLyB0aGUgcGFzc2VkIHVybCBtYXkgbm90IHlpZWxkIHRoZSBjb3JyZWN0IHJlc3VsdAoJCQkJc2VhcmNoID0gdGhpcy5wYXJzZVVybCggaHJlZiApLnNlYXJjaDsKCgkJCQkvLyBUT0RPIGFsbCB0aGlzIGNyYXAgaXMgdGVycmlibGUsIGNsZWFuIGl0IHVwCgkJCQlpZiAoIGlzUGF0aCApIHsKCQkJCQkvLyByZWplY3QgdGhlIGhhc2ggaWYgaXQncyBhIHBhdGggb3IgaXQncyBqdXN0IGEgZGlhbG9nIGtleQoJCQkJCWlmICggcGF0aC5pc1BhdGgoIHByZXNlcnZlZEhhc2ggKSB8fCBwcmVzZXJ2ZWRIYXNoLnJlcGxhY2UoIiMiLCAiIikuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDApIHsKCQkJCQkJcHJlc2VydmVkSGFzaCA9ICIiOwoJCQkJCX0KCgkJCQkJLy8gQXBwZW5kIHRoZSBVSSBTdGF0ZSBrZXlzIHdoZXJlIGl0IGV4aXN0cyBhbmQgaXQncyBiZWVuIHJlbW92ZWQKCQkJCQkvLyBmcm9tIHRoZSB1cmwKCQkJCQlpZiAoIHVpU3RhdGUgJiYgcHJlc2VydmVkSGFzaC5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gLTEpIHsKCQkJCQkJcHJlc2VydmVkSGFzaCArPSB1aVN0YXRlOwoJCQkJCX0KCgkJCQkJLy8gbWFrZSBzdXJlIHRoYXQgcG91bmQgaXMgb24gdGhlIGZyb250IG9mIHRoZSBoYXNoCgkJCQkJaWYgKCBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoICIjIiApID09PSAtMSAmJiBwcmVzZXJ2ZWRIYXNoICE9PSAiIiApIHsKCQkJCQkJcHJlc2VydmVkSGFzaCA9ICIjIiArIHByZXNlcnZlZEhhc2g7CgkJCQkJfQoKCQkJCQkvLyByZWNvbnN0cnVjdCBlYWNoIG9mIHRoZSBwaWVjZXMgd2l0aCB0aGUgbmV3IHNlYXJjaCBzdHJpbmcgYW5kIGhhc2gKCQkJCQlocmVmID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJCWhyZWYgPSBocmVmLnByb3RvY29sICsgIi8vIiArIGhyZWYuaG9zdCArIGhyZWYucGF0aG5hbWUgKyBzZWFyY2ggKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJfSBlbHNlIHsKCQkJCQlocmVmICs9IGhyZWYuaW5kZXhPZiggIiMiICkgPiAtMSA/IHVpU3RhdGUgOiAiIyIgKyB1aVN0YXRlOwoJCQkJfQoKCQkJCXJldHVybiBocmVmOwoJCQl9LAoKCQkJaXNQcmVzZXJ2YWJsZUhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIGhhc2gucmVwbGFjZSggIiMiLCAiIiApLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAwOwoJCQl9LAoKCQkJLy8gRXNjYXBlIHdlaXJkIGNoYXJhY3RlcnMgaW4gdGhlIGhhc2ggaWYgaXQgaXMgdG8gYmUgdXNlZCBhcyBhIHNlbGVjdG9yCgkJCWhhc2hUb1NlbGVjdG9yOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXZhciBoYXNIYXNoID0gKCBoYXNoLnN1YnN0cmluZyggMCwgMSApID09PSAiIyIgKTsKCQkJCWlmICggaGFzSGFzaCApIHsKCQkJCQloYXNoID0gaGFzaC5zdWJzdHJpbmcoIDEgKTsKCQkJCX0KCQkJCXJldHVybiAoIGhhc0hhc2ggPyAiIyIgOiAiIiApICsgaGFzaC5yZXBsYWNlKCAvKFshIiMkJSYnKCkqKywuLzo7PD0+P0BbXF1eYHt8fX5dKS9nLCAiXFwkMSIgKTsKCQkJfSwKCgkJCS8vIHJldHVybiB0aGUgc3Vic3RyaW5nIG9mIGEgZmlsZXBhdGggYmVmb3JlIHRoZSBzdWItcGFnZSBrZXksIGZvciBtYWtpbmcKCQkJLy8gYSBzZXJ2ZXIgcmVxdWVzdAoJCQlnZXRGaWxlUGF0aDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQl2YXIgc3BsaXRrZXkgPSAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5OwoJCQkJcmV0dXJuIHBhdGggJiYgcGF0aC5zcGxpdCggc3BsaXRrZXkgKVswXS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQl9LAoKCQkJLy8gY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluCgkJCS8vIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCB0aGlzLmRvY3VtZW50QmFzZSApICksCgoJCQkJCS8vIERvZXMgdGhlIHVybCBoYXZlIHRoZSBzYW1lIHBhdGggYXMgdGhlIGRvY3VtZW50PwoJCQkJCXNhbWVQYXRoID0gdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwKCQkJCQkJKCB0aGlzLmRvY3VtZW50QmFzZURpZmZlcnMgJiYKCQkJCQkJCXUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJLy8gVGhlIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaWYgdGhlIHBhdGggbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYW5kCgkJCQkvLyBpdCBlaXRoZXIgaGFzIG5vIGhhc2ggdmFsdWUsIG9yIHRoZSBoYXNoIGlzIGV4YWN0bHkgZXF1YWwgdG8gdGhlIGlkCgkJCQkvLyBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJcmV0dXJuIHNhbWVQYXRoICYmCgkJCQkJKCAhdS5oYXNoIHx8CgkJCQkJCXUuaGFzaCA9PT0gIiMiIHx8CgkJCQkJCSggZnBJZCAmJiB1Lmhhc2gucmVwbGFjZSggL14jLywgIiIgKSA9PT0gZnBJZCApICk7CgkJCX0sCgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93CgkJCS8vIGNyb3NzLWRvbWFpbiBYSFIgcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQKCQkJLy8gdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLiBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvCgkJCS8vICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlcgoJCQkvLyBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUgYWxsb3dDcm9zc0RvbWFpblBhZ2VzCgkJCS8vIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzIHJlcXVlc3RzIHRvIGdvCgkJCS8vIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCQkJaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3Q6IGZ1bmN0aW9uKCBkb2NVcmwsIHJlcVVybCApIHsKCQkJCXJldHVybiAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgJiYKCQkJCQkoZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiIHx8IGRvY1VybC5wcm90b2NvbCA9PT0gImNvbnRlbnQ6IikgJiYKCQkJCQlyZXFVcmwuc2VhcmNoKCAvXmh0dHBzPzovICkgIT09IC0xOwoJCQl9CgkJfTsKCgkJcGF0aC5kb2N1bWVudFVybCA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkkYmFzZSA9ICQoICJoZWFkIiApLmZpbmQoICJiYXNlIiApOwoKCQlwYXRoLmRvY3VtZW50QmFzZSA9ICRiYXNlLmxlbmd0aCA/CgkJCXBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCAkYmFzZS5hdHRyKCAiaHJlZiIgKSwgcGF0aC5kb2N1bWVudFVybC5ocmVmICkgKSA6CgkJCXBhdGguZG9jdW1lbnRVcmw7CgoJCXBhdGguZG9jdW1lbnRCYXNlRGlmZmVycyA9IChwYXRoLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggIT09IHBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2gpOwoKCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQlwYXRoLmdldERvY3VtZW50QmFzZSA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50QmFzZSApIDogcGF0aC5kb2N1bWVudEJhc2UuaHJlZjsKCQl9OwoKCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIGluIDEuNS4wCgkJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkJCWdldERvY3VtZW50VXJsOiBwYXRoLmdldERvY3VtZW50VXJsLAoKCQkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkJCWdldERvY3VtZW50QmFzZTogcGF0aC5nZXREb2N1bWVudEJhc2UKCQl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQubW9iaWxlLkhpc3RvcnkgPSBmdW5jdGlvbiggc3RhY2ssIGluZGV4ICkgewoJCXRoaXMuc3RhY2sgPSBzdGFjayB8fCBbXTsKCQl0aGlzLmFjdGl2ZUluZGV4ID0gaW5kZXggfHwgMDsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuSGlzdG9yeS5wcm90b3R5cGUsIHsKCQlnZXRBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCBdOwoJCX0sCgoJCWdldExhc3Q6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5wcmV2aW91c0luZGV4IF07CgkJfSwKCgkJZ2V0TmV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4ICsgMSBdOwoJCX0sCgoJCWdldFByZXY6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCAtIDEgXTsKCQl9LAoKCQkvLyBhZGROZXcgaXMgdXNlZCB3aGVuZXZlciBhIG5ldyBwYWdlIGlzIGFkZGVkCgkJYWRkOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJCS8vaWYgdGhlcmUncyBmb3J3YXJkIGhpc3RvcnksIHdpcGUgaXQKCQkJaWYgKCB0aGlzLmdldE5leHQoKSApIHsKCQkJCXRoaXMuY2xlYXJGb3J3YXJkKCk7CgkJCX0KCgkJCS8vIGlmIHRoZSBoYXNoIGlzIGluY2x1ZGVkIGluIHRoZSBkYXRhIG1ha2Ugc3VyZSB0aGUgc2hhcGUKCQkJLy8gaXMgY29uc2lzdGVudCBmb3IgY29tcGFyaXNvbgoJCQlpZiAoIGRhdGEuaGFzaCAmJiBkYXRhLmhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xKSB7CgkJCQlkYXRhLmhhc2ggPSAiIyIgKyBkYXRhLmhhc2g7CgkJCX0KCgkJCWRhdGEudXJsID0gdXJsOwoJCQl0aGlzLnN0YWNrLnB1c2goIGRhdGEgKTsKCQkJdGhpcy5hY3RpdmVJbmRleCA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsKCQl9LAoKCQkvL3dpcGUgdXJscyBhaGVhZCBvZiBhY3RpdmUgaW5kZXgKCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnN0YWNrID0gdGhpcy5zdGFjay5zbGljZSggMCwgdGhpcy5hY3RpdmVJbmRleCArIDEgKTsKCQl9LAoKCQlmaW5kOiBmdW5jdGlvbiggdXJsLCBzdGFjaywgZWFybHlSZXR1cm4gKSB7CgkJCXN0YWNrID0gc3RhY2sgfHwgdGhpcy5zdGFjazsKCgkJCXZhciBlbnRyeSwgaSwgbGVuZ3RoID0gc3RhY2subGVuZ3RoLCBpbmRleDsKCgkJCWZvciAoIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQllbnRyeSA9IHN0YWNrW2ldOwoKCQkJCWlmICggZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS51cmwpIHx8CgkJCQkJZGVjb2RlVVJJQ29tcG9uZW50KHVybCkgPT09IGRlY29kZVVSSUNvbXBvbmVudChlbnRyeS5oYXNoKSApIHsKCQkJCQlpbmRleCA9IGk7CgoJCQkJCWlmICggZWFybHlSZXR1cm4gKSB7CgkJCQkJCXJldHVybiBpbmRleDsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXJldHVybiBpbmRleDsKCQl9LAoKCQljbG9zZXN0OiBmdW5jdGlvbiggdXJsICkgewoJCQl2YXIgY2xvc2VzdCwgYSA9IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkvLyBGaXJzdCwgdGFrZSB0aGUgc2xpY2Ugb2YgdGhlIGhpc3Rvcnkgc3RhY2sgYmVmb3JlIHRoZSBjdXJyZW50IGluZGV4IGFuZCBzZWFyY2gKCQkJLy8gZm9yIGEgdXJsIG1hdGNoLiBJZiBvbmUgaXMgZm91bmQsIHdlJ2xsIGF2b2lkIGF2b2lkIGxvb2tpbmcgdGhyb3VnaCBmb3J3YXJkIGhpc3RvcnkKCQkJLy8gTk9URSB0aGUgcHJlZmVyZW5jZSBmb3IgYmFja3dhcmQgaGlzdG9yeSBtb3ZlbWVudCBpcyBkcml2ZW4gYnkgdGhlIGZhY3QgdGhhdAoJCQkvLyAgICAgIG1vc3QgbW9iaWxlIGJyb3dzZXJzIG9ubHkgaGF2ZSBhIGRlZGljYXRlZCBiYWNrIGJ1dHRvbiwgYW5kIHVzZXJzIHJhcmVseSB1c2UKCQkJLy8gICAgICB0aGUgZm9yd2FyZCBidXR0b24gaW4gZGVza3RvcCBicm93c2VyIGFueWhvdwoJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoMCwgYSkgKTsKCgkJCS8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGluIGJhY2t3YXJkIGhpc3RvcnkgY2hlY2sgZm9yd2FyZC4gVGhlIGB0cnVlYAoJCQkvLyB2YWx1ZSBwYXNzZWQgYXMgdGhlIHRoaXJkIHBhcmFtZXRlciBjYXVzZXMgdGhlIGZpbmQgbWV0aG9kIHRvIGJyZWFrCgkJCS8vIG9uIHRoZSBmaXJzdCBtYXRjaCBpbiB0aGUgZm9yd2FyZCBoaXN0b3J5IHNsaWNlLiBUaGUgc3RhcnRpbmcgaW5kZXgKCQkJLy8gb2YgdGhlIHNsaWNlIG11c3QgdGhlbiBiZSBhZGRlZCB0byB0aGUgcmVzdWx0IHRvIGdldCB0aGUgZWxlbWVudCBpbmRleAoJCQkvLyBpbiB0aGUgb3JpZ2luYWwgaGlzdG9yeSBzdGFjayA6KCA6KAoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgaHlwZXIgY29uZnVzaW5nIGFuZCBzaG91bGQgYmUgY2xlYW5lZCB1cCAodWdoIHNvIGJhZCkKCQkJaWYgKCBjbG9zZXN0ID09PSB1bmRlZmluZWQgKSB7CgkJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoYSksIHRydWUgKTsKCQkJCWNsb3Nlc3QgPSBjbG9zZXN0ID09PSB1bmRlZmluZWQgPyBjbG9zZXN0IDogY2xvc2VzdCArIGE7CgkJCX0KCgkJCXJldHVybiBjbG9zZXN0OwoJCX0sCgoJCWRpcmVjdDogZnVuY3Rpb24oIG9wdHMgKSB7CgkJCXZhciBuZXdBY3RpdmVJbmRleCA9IHRoaXMuY2xvc2VzdCggb3B0cy51cmwgKSwgYSA9IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCS8vIHJlY29yZCB0aGUgcHJldmlvdXMgaW5kZXggZm9yIHJlZmVyZW5jZQoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXg7CgkJCQl0aGlzLnByZXZpb3VzSW5kZXggPSBhOwoJCQl9CgoJCQkvLyBpbnZva2UgY2FsbGJhY2tzIHdoZXJlIGFwcHJvcHJpYXRlCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBhbHNvIGNvbnZvbHV0ZWQgYW5kIGNvbmZ1c2luZwoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4IDwgYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuYmFjayB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgImJhY2siICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID4gYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuZm9yd2FyZCB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgImZvcndhcmQiICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID09PSB1bmRlZmluZWQgJiYgb3B0cy5taXNzaW5nICkgewoJCQkJb3B0cy5taXNzaW5nKCB0aGlzLmdldEFjdGl2ZSgpICk7CgkJCX0KCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aCwKCQlpbml0aWFsSHJlZiA9IGxvY2F0aW9uLmhyZWY7CgoJJC5tb2JpbGUuTmF2aWdhdG9yID0gZnVuY3Rpb24oIGhpc3RvcnkgKSB7CgkJdGhpcy5oaXN0b3J5ID0gaGlzdG9yeTsKCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gdHJ1ZTsKCgkJJC5tb2JpbGUud2luZG93LmJpbmQoewoJCQkicG9wc3RhdGUuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMucG9wc3RhdGUsIHRoaXMgKSwKCQkJImhhc2hjaGFuZ2UuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMuaGFzaGNoYW5nZSwgdGhpcyApCgkJfSk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLk5hdmlnYXRvci5wcm90b3R5cGUsIHsKCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCXZhciBzdGF0ZSwgaHJlZiwgaGFzaCA9IHBhdGguaXNQYXRoKHVybCkgPyBwYXRoLnN0cmlwSGFzaCh1cmwpIDogdXJsOwoKCQkJaHJlZiA9IHBhdGguc3F1YXNoKCB1cmwgKTsKCgkJCS8vIG1ha2Ugc3VyZSB0byBwcm92aWRlIHRoaXMgaW5mb3JtYXRpb24gd2hlbiBpdCBpc24ndCBleHBsaWNpdGx5IHNldCBpbiB0aGUKCQkJLy8gZGF0YSBvYmplY3QgdGhhdCB3YXMgcGFzc2VkIHRvIHRoZSBzcXVhc2ggbWV0aG9kCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJaGFzaDogaGFzaCwKCQkJCXVybDogaHJlZgoJCQl9LCBkYXRhKTsKCgkJCS8vIHJlcGxhY2UgdGhlIGN1cnJlbnQgdXJsIHdpdGggdGhlIG5ldyBocmVmIGFuZCBzdG9yZSB0aGUgc3RhdGUKCQkJLy8gTm90ZSB0aGF0IGluIHNvbWUgY2FzZXMgd2UgbWlnaHQgYmUgcmVwbGFjaW5nIGFuIHVybCB3aXRoIHRoZQoJCQkvLyBzYW1lIHVybC4gV2UgZG8gdGhpcyBhbnl3YXlzIGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdAoJCQkvLyBhbGwgb2Ygb3VyIGhpc3RvcnkgZW50cmllcyBoYXZlIGEgc3RhdGUgb2JqZWN0IGFzc29jaWF0ZWQgd2l0aAoJCQkvLyB0aGVtLiBUaGlzIGFsbG93cyB1cyB0byB3b3JrIGFyb3VuZCB0aGUgY2FzZSB3aGVyZSAkLm1vYmlsZS5iYWNrKCkKCQkJLy8gaXMgY2FsbGVkIHRvIHRyYW5zaXRpb24gZnJvbSBhbiBleHRlcm5hbCBwYWdlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuCgkJCS8vIEluIHRoYXQgcGFydGljdWxhciBjYXNlLCBhIGhhc2hjaGFuZ2UgZXZlbnQgaXMgKk5PVCogZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLgoJCQkvLyBFbnN1cmluZyBlYWNoIGhpc3RvcnkgZW50cnkgaGFzIGEgc3RhdGUgb2JqZWN0IG1lYW5zIHRoYXQgb25Qb3BTdGF0ZSgpCgkJCS8vIHdpbGwgYWx3YXlzIHRyaWdnZXIgb3VyIGhhc2hjaGFuZ2UgY2FsbGJhY2sgZXZlbiB3aGVuIGEgaGFzaGNoYW5nZSBldmVudAoJCQkvLyBpcyBub3QgZmlyZWQuCgkJCXdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSggc3RhdGUsIHN0YXRlLnRpdGxlIHx8IGRvY3VtZW50LnRpdGxlLCBocmVmICk7CgoJCQlyZXR1cm4gc3RhdGU7CgkJfSwKCgkJaGFzaDogZnVuY3Rpb24oIHVybCwgaHJlZiApIHsKCQkJdmFyIHBhcnNlZCwgbG9jLCBoYXNoLCByZXNvbHZlZDsKCgkJCS8vIEdyYWIgdGhlIGhhc2ggZm9yIHJlY29yZGluZy4gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoCgkJCS8vIHdlIHVzZWQgdGhlIHBhcnNlZCB2ZXJzaW9uIG9mIHRoZSBzcXVhc2hlZCB1cmwgdG8gcmVjb25zdHJ1Y3QsCgkJCS8vIG90aGVyd2lzZSB3ZSBhc3N1bWUgaXQncyBhIGhhc2ggYW5kIHN0b3JlIGl0IGRpcmVjdGx5CgkJCXBhcnNlZCA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQlsb2MgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJCWlmICggbG9jLnBhdGhuYW1lICsgbG9jLnNlYXJjaCA9PT0gcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaCApIHsKCQkJCS8vIElmIHRoZSBwYXRobmFtZSBhbmQgc2VhcmNoIG9mIHRoZSBwYXNzZWQgdXJsIGlzIGlkZW50aWNhbCB0byB0aGUgY3VycmVudCBsb2MKCQkJCS8vIHRoZW4gd2UgbXVzdCB1c2UgdGhlIGhhc2guIE90aGVyd2lzZSB0aGVyZSB3aWxsIGJlIG5vIGV2ZW50CgkJCQkvLyBlZywgdXJsID0gIi9mb28vYmFyP2JheiNiYW5nIiwgbG9jYXRpb24uaHJlZiA9ICJodHRwOi8vZXhhbXBsZS5jb20vZm9vL2Jhcj9iYXoiCgkJCQloYXNoID0gcGFyc2VkLmhhc2ggPyBwYXJzZWQuaGFzaCA6IHBhcnNlZC5wYXRobmFtZSArIHBhcnNlZC5zZWFyY2g7CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKHVybCkgKSB7CgkJCQlyZXNvbHZlZCA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCS8vIElmIHRoZSBwYXNzZWQgdXJsIGlzIGEgcGF0aCwgbWFrZSBpdCBkb21haW4gcmVsYXRpdmUgYW5kIHJlbW92ZSBhbnkgdHJhaWxpbmcgaGFzaAoJCQkJaGFzaCA9IHJlc29sdmVkLnBhdGhuYW1lICsgcmVzb2x2ZWQuc2VhcmNoICsgKHBhdGguaXNQcmVzZXJ2YWJsZUhhc2goIHJlc29sdmVkLmhhc2ggKT8gcmVzb2x2ZWQuaGFzaC5yZXBsYWNlKCAiIyIsICIiICkgOiAiIik7CgkJCX0gZWxzZSB7CgkJCQloYXNoID0gdXJsOwoJCQl9CgoJCQlyZXR1cm4gaGFzaDsKCQl9LAoKCQkvLyBUT0RPIHJlY29uc2lkZXIgbmFtZQoJCWdvOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoLCBwb3BzdGF0ZUV2ZW50LAoJCQkJaXNQb3BTdGF0ZUV2ZW50ID0gJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpOwoKCQkJLy8gR2V0IHRoZSB1cmwgYXMgaXQgd291bGQgbG9vayBzcXVhc2hlZCBvbiB0byB0aGUgY3VycmVudCByZXNvbHV0aW9uIHVybAoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gc29ydCBvdXQgd2hhdCB0aGUgaGFzaCBzb3VsZCBiZSBmcm9tIHRoZSB1cmwKCQkJaGFzaCA9IHRoaXMuaGFzaCggdXJsLCBocmVmICk7CgoJCQkvLyBIZXJlIHdlIHByZXZlbnQgdGhlIG5leHQgaGFzaCBjaGFuZ2Ugb3IgcG9wc3RhdGUgZXZlbnQgZnJvbSBkb2luZyBhbnkKCQkJLy8gaGlzdG9yeSBtYW5hZ2VtZW50LiBJbiB0aGUgY2FzZSBvZiBoYXNoY2hhbmdlIHdlIGRvbid0IHN3YWxsb3cgaXQKCQkJLy8gaWYgdGhlcmUgd2lsbCBiZSBubyBoYXNoY2hhbmdlIGZpcmVkIChzaW5jZSB0aGF0IHdvbid0IHJlc2V0IHRoZSB2YWx1ZSkKCQkJLy8gYW5kIHdpbGwgc3dhbGxvdyB0aGUgZm9sbG93aW5nIGhhc2hjaGFuZ2UKCQkJaWYgKCBub0V2ZW50cyAmJiBoYXNoICE9PSBwYXRoLnN0cmlwSGFzaChwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApIHsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gbm9FdmVudHM7CgkJCX0KCgkJCS8vIElNUE9SVEFOVCBpbiB0aGUgY2FzZSB3aGVyZSBwb3BzdGF0ZSBpcyBzdXBwb3J0ZWQgdGhlIGV2ZW50IHdpbGwgYmUgdHJpZ2dlcmVkCgkJCS8vICAgICAgZGlyZWN0bHksIHN0b3BwaW5nIGZ1cnRoZXIgZXhlY3V0aW9uIC0gaWUsIGludGVydXB0aW5nIHRoZSBmbG93IG9mIHRoaXMKCQkJLy8gICAgICBtZXRob2QgY2FsbCB0byBmaXJlIGJpbmRpbmdzIGF0IHRoaXMgZXhwcmVzc2lvbi4gQmVsb3cgdGhlIG5hdmlnYXRlIG1ldGhvZAoJCQkvLyAgICAgIHRoZXJlIGlzIGEgYmluZGluZyB0byBjYXRjaCB0aGlzIGV2ZW50IGFuZCBzdG9wIGl0cyBwcm9wYWdhdGlvbi4KCQkJLy8KCQkJLy8gICAgICBXZSB0aGVuIHRyaWdnZXIgYSBuZXcgcG9wc3RhdGUgZXZlbnQgb24gdGhlIHdpbmRvdyB3aXRoIGEgbnVsbCBzdGF0ZQoJCQkvLyAgICAgIHNvIHRoYXQgdGhlIG5hdmlnYXRlIGV2ZW50cyBjYW4gY29uY2x1ZGUgdGhlaXIgd29yayBwcm9wZXJseQoJCQkvLwoJCQkvLyBpZiB0aGUgdXJsIGlzIGEgcGF0aCB3ZSB3YW50IHRvIHByZXNlcnZlIHRoZSBxdWVyeSBwYXJhbXMgdGhhdCBhcmUgYXZhaWxhYmxlIG9uCgkJCS8vIHRoZSBjdXJyZW50IHVybC4KCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gdHJ1ZTsKCQkJd2luZG93LmxvY2F0aW9uLmhhc2ggPSBoYXNoOwoKCQkJLy8gSWYgcG9wc3RhdGUgaXMgZW5hYmxlZCBhbmQgdGhlIGJyb3dzZXIgdHJpZ2dlcnMgYHBvcHN0YXRlYCBldmVudHMgd2hlbiB0aGUgaGFzaAoJCQkvLyBpcyBzZXQgKHRoaXMgb2Z0ZW4gaGFwcGVucyBpbW1lZGlhdGVseSBpbiBicm93c2VycyBsaWtlIENocm9tZSksIHRoZW4gdGhlCgkJCS8vIHRoaXMgZmxhZyB3aWxsIGJlIHNldCB0byBmYWxzZSBhbHJlYWR5LiBJZiBpdCdzIGEgYnJvd3NlciB0aGF0IGRvZXMgbm90IHRyaWdnZXIKCQkJLy8gYSBgcG9wc3RhdGVgIG9uIGhhc2ggYXNzaWduZW1lbnQgb3IgYHJlcGxhY2VTdGF0ZWAgdGhlbiB3ZSBuZWVkIGF2b2lkIHRoZSBicmFuY2gKCQkJLy8gdGhhdCBzd2FsbG93cyB0aGUgZXZlbnQgY3JlYXRlZCBieSB0aGUgcG9wc3RhdGUgZ2VuZXJhdGVkIGJ5IHRoZSBoYXNoIGFzc2lnbm1lbnQKCQkJLy8gQXQgdGhlIHRpbWUgb2YgdGhpcyB3cml0aW5nIHRoaXMgaGFwcGVucyB3aXRoIE9wZXJhIDEyIGFuZCBzb21lIHZlcnNpb24gb2YgSUUKCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gZmFsc2U7CgoJCQlzdGF0ZSA9ICQuZXh0ZW5kKHsKCQkJCXVybDogaHJlZiwKCQkJCWhhc2g6IGhhc2gsCgkJCQl0aXRsZTogZG9jdW1lbnQudGl0bGUKCQkJfSwgZGF0YSk7CgoJCQlpZiAoIGlzUG9wU3RhdGVFdmVudCApIHsKCQkJCXBvcHN0YXRlRXZlbnQgPSBuZXcgJC5FdmVudCggInBvcHN0YXRlIiApOwoJCQkJcG9wc3RhdGVFdmVudC5vcmlnaW5hbEV2ZW50ID0gewoJCQkJCXR5cGU6ICJwb3BzdGF0ZSIsCgkJCQkJc3RhdGU6IG51bGwKCQkJCX07CgoJCQkJdGhpcy5zcXVhc2goIHVybCwgc3RhdGUgKTsKCgkJCQkvLyBUcmlnZ2VyIGEgbmV3IGZhdXggcG9wc3RhdGUgZXZlbnQgdG8gcmVwbGFjZSB0aGUgb25lIHRoYXQgd2UKCQkJCS8vIGNhdWdodCB0aGF0IHdhcyB0cmlnZ2VyZWQgYnkgdGhlIGhhc2ggc2V0dGluZyBhYm92ZS4KCQkJCWlmICggIW5vRXZlbnRzICkgewoJCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSB0cnVlOwoJCQkJCSQubW9iaWxlLndpbmRvdy50cmlnZ2VyKCBwb3BzdGF0ZUV2ZW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIHJlY29yZCB0aGUgaGlzdG9yeSBlbnRyeSBzbyB0aGF0IHRoZSBpbmZvcm1hdGlvbiBjYW4gYmUgaW5jbHVkZWQKCQkJLy8gaW4gaGFzaGNoYW5nZSBldmVudCBkcml2ZW4gbmF2aWdhdGUgZXZlbnRzIGluIGEgc2ltaWxhciBmYXNoaW9uIHRvCgkJCS8vIHRoZSBzdGF0ZSB0aGF0J3MgcHJvdmlkZWQgYnkgcG9wc3RhdGUKCQkJdGhpcy5oaXN0b3J5LmFkZCggc3RhdGUudXJsLCBzdGF0ZSApOwoJCX0sCgoJCS8vIFRoaXMgYmluZGluZyBpcyBpbnRlbmRlZCB0byBjYXRjaCB0aGUgcG9wc3RhdGUgZXZlbnRzIHRoYXQgYXJlIGZpcmVkCgkJLy8gd2hlbiBleGVjdXRpb24gb2YgdGhlIGAkLm5hdmlnYXRlYCBtZXRob2Qgc3RvcHMgYXQgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7CgkJLy8gYW5kIGNvbXBsZXRlbHkgcHJldmVudCB0aGVtIGZyb20gcHJvcGFnYXRpbmcuIFRoZSBwb3BzdGF0ZSBldmVudCB3aWxsIHRoZW4gYmUKCQkvLyByZXRyaWdnZXJlZCBhZnRlciBleGVjdXRpb24gcmVzdW1lcwoJCS8vCgkJLy8gVE9ETyBncmFiIHRoZSBvcmlnaW5hbCBldmVudCBoZXJlIGFuZCB1c2UgaXQgZm9yIHRoZSBzeW50aGV0aWMgZXZlbnQgaW4gdGhlCgkJLy8gICAgICBzZWNvbmQgaGFsZiBvZiB0aGUgbmF2aWdhdGUgZXhlY3V0aW9uIHRoYXQgd2lsbCBmb2xsb3cgdGhpcyBiaW5kaW5nCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGhhc2gsIHN0YXRlOwoKCQkJLy8gUGFydGx5IHRvIHN1cHBvcnQgb3VyIHRlc3Qgc3VpdGUgd2hpY2ggbWFudWFsbHkgYWx0ZXJzIHRoZSBzdXBwb3J0CgkJCS8vIHZhbHVlIHRvIHRlc3QgaGFzaGNoYW5nZS4gUGFydGx5IHRvIHByZXZlbnQgYWxsIGFyb3VuZCB3ZWlyZG5lc3MKCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYnkgdGhlIGFjdHVhbCBhbHRlcmF0aW9uIG9mIHRoZSBoYXNoCgkJCS8vIHByZXZlbnQgaXQgY29tcGxldGVseS4gSGlzdG9yeSBpcyB0cmFja2VkIG1hbnVhbGx5CgkJCWlmICggdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlICkgewoJCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gaWYgdGhpcyBpcyB0aGUgcG9wc3RhdGUgdHJpZ2dlcmVkIGFmdGVyIHRoZSBgcmVwbGFjZVN0YXRlYCBjYWxsIGluIHRoZSBnbwoJCQkvLyBtZXRob2QsIHRoZW4gc2ltcGx5IGlnbm9yZSBpdC4gVGhlIGhpc3RvcnkgZW50cnkgaGFzIGFscmVhZHkgYmVlbiBjYXB0dXJlZAoJCQlpZiAoIHRoaXMuaWdub3JlUG9wU3RhdGUgKSB7CgkJCQl0aGlzLmlnbm9yZVBvcFN0YXRlID0gZmFsc2U7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoZXJlIGlzIG5vIHN0YXRlLCBhbmQgdGhlIGhpc3Rvcnkgc3RhY2sgbGVuZ3RoIGlzIG9uZSB3ZXJlCgkJCS8vIHByb2JhYmx5IGdldHRpbmcgdGhlIHBhZ2UgbG9hZCBwb3BzdGF0ZSBmaXJlZCBieSBicm93c2VycyBsaWtlIGNocm9tZQoJCQkvLyBhdm9pZCBpdCBhbmQgc2V0IHRoZSBvbmUgdGltZSBmbGFnIHRvIGZhbHNlLgoJCQkvLyBUT0RPOiBEbyB3ZSByZWFsbHkgbmVlZCBhbGwgdGhlc2UgY29uZGl0aW9ucz8gQ29tcGFyaW5nIGxvY2F0aW9uIGhyZWZzCgkJCS8vIHNob3VsZCBiZSBzdWZmaWNpZW50LgoJCQlpZiAoICFldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlICYmCgkJCQl0aGlzLmhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAxICYmCgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlICkgewoJCQkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSA9IGZhbHNlOwoKCQkJCWlmICggbG9jYXRpb24uaHJlZiA9PT0gaW5pdGlhbEhyZWYgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIGFjY291bnQgZm9yIGRpcmVjdCBtYW5pcHVsYXRpb24gb2YgdGhlIGhhc2guIFRoYXQgaXMsIHdlIHdpbGwgcmVjZWl2ZSBhIHBvcHN0YXRlCgkJCS8vIHdoZW4gdGhlIGhhc2ggaXMgY2hhbmdlZCBieSBhc3NpZ25tZW50LCBhbmQgaXQgd29uJ3QgaGF2ZSBhIHN0YXRlIGFzc29jaWF0ZWQuIFdlCgkJCS8vIHRoZW4gbmVlZCB0byBzcXVhc2ggdGhlIGhhc2guIFNlZSBiZWxvdyBmb3IgaGFuZGxpbmcgb2YgaGFzaCBhc3NpZ25tZW50IHRoYXQKCQkJLy8gbWF0Y2hlcyBhbiBleGlzdGluZyBoaXN0b3J5IGVudHJ5CgkJCS8vIFRPRE8gaXQgbWlnaHQgYmUgYmV0dGVyIHRvIG9ubHkgYWRkIHRvIHRoZSBoaXN0b3J5IHN0YWNrCgkJCS8vICAgICAgd2hlbiB0aGUgaGFzaCBpcyBhZGphY2VudCB0byB0aGUgYWN0aXZlIGhpc3RvcnkgZW50cnkKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCWlmICggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYgaGFzaCApIHsKCQkJCS8vIHNxdWFzaCB0aGUgaGFzaCB0aGF0J3MgYmVlbiBhc3NpZ25lZCBvbiB0aGUgVVJMIHdpdGggcmVwbGFjZVN0YXRlCgkJCQkvLyBhbHNvIGdyYWIgdGhlIHJlc3VsdGluZyBzdGF0ZSBvYmplY3QgZm9yIHN0b3JhZ2UKCQkJCXN0YXRlID0gdGhpcy5zcXVhc2goIGhhc2ggKTsKCgkJCQkvLyByZWNvcmQgdGhlIG5ldyBoYXNoIGFzIGFuIGFkZGl0aW9uYWwgaGlzdG9yeSBlbnRyeQoJCQkJLy8gdG8gbWF0Y2ggdGhlIGJyb3dzZXIncyB0cmVhdG1lbnQgb2YgaGFzaCBhc3NpZ25tZW50CgkJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgoJCQkJLy8gcGFzcyB0aGUgbmV3bHkgY3JlYXRlZCBzdGF0ZSBpbmZvcm1hdGlvbgoJCQkJLy8gYWxvbmcgd2l0aCB0aGUgZXZlbnQKCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZSA9IHN0YXRlOwoKCQkJCS8vIGRvIG5vdCBhbHRlciBoaXN0b3J5LCB3ZSd2ZSBhZGRlZCBhIG5ldyBoaXN0b3J5IGVudHJ5CgkJCQkvLyBzbyB3ZSBrbm93IHdoZXJlIHdlIGFyZQoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiBhbGwgZWxzZSBmYWlscyB0aGlzIGlzIGEgcG9wc3RhdGUgdGhhdCBjb21lcyBmcm9tIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9ucwoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseSwgYW5kIHJlY29yZCB0aGUgZGlyZWN0aW9uYWxpdHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IChldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlIHx8IHt9KS51cmwgfHwgaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGlzdG9yeVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0KCQkJfSk7CgkJfSwKCgkJLy8gTk9URSBtdXN0IGJpbmQgYmVmb3JlIGBuYXZpZ2F0ZWAgc3BlY2lhbCBldmVudCBoYXNoY2hhbmdlIGJpbmRpbmcgb3RoZXJ3aXNlIHRoZQoJCS8vICAgICAgbmF2aWdhdGlvbiBkYXRhIHdvbid0IGJlIGF0dGFjaGVkIHRvIHRoZSBoYXNoY2hhbmdlIGV2ZW50IGluIHRpbWUgZm9yIHRob3NlCgkJLy8gICAgICBiaW5kaW5ncyB0byBhdHRhY2ggaXQgdG8gdGhlIGBuYXZpZ2F0ZWAgc3BlY2lhbCBldmVudAoJCS8vIFRPRE8gYWRkIGEgY2hlY2sgaGVyZSB0aGF0IGBoYXNoY2hhbmdlLm5hdmlnYXRlYCBpcyBib3VuZCBhbHJlYWR5IG90aGVyd2lzZSBpdCdzCgkJLy8gICAgICBicm9rZW4gKGV4Y2VwdGlvbj8pCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgaGlzdG9yeSwgaGFzaDsKCgkJCS8vIElmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGV4cGxpY2l0bHkgZGlzYWJsZWQgb3IgcHVzaHN0YXRlIGlzIHN1cHBvcnRlZAoJCQkvLyBhdm9pZCBtYWtpbmcgdXNlIG9mIHRoZSBoYXNoY2hhbmdlIGhhbmRsZXIuCgkJCWlmICghJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzSGFzaENoYW5nZUVuYWJsZWQoKSB8fAoJCQkJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBPbiBvY2Nhc2lvbiBleHBsaWNpdGx5IHdhbnQgdG8gcHJldmVudCB0aGUgbmV4dCBoYXNoIGZyb20gcHJvcG9nYXRpbmcgYmVjYXVzZSB3ZSBvbmx5CgkJCS8vIHdpdGggdG8gYWx0ZXIgdGhlIHVybCB0byByZXByZXNlbnQgdGhlIG5ldyBzdGF0ZSBkbyBzbyBoZXJlCgkJCWlmICggdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSA9IGZhbHNlOwoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWhpc3RvcnkgPSB0aGlzLmhpc3Rvcnk7CgkJCWhhc2ggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoKCQkJLy8gSWYgdGhpcyBpcyBhIGhhc2hjaGFuZ2UgY2F1c2VkIGJ5IHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5CgkJCXRoaXMuaGlzdG9yeS5kaXJlY3QoewoJCQkJdXJsOiBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oYXNoY2hhbmdlU3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oYXNoY2hhbmdlU3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfSwKCgkJCQkvLyBXaGVuIHdlIGRvbid0IGZpbmQgYSBoYXNoIGluIG91ciBoaXN0b3J5IGNsZWFybHkgd2UncmUgYWltaW5nIHRvIGdvIHRoZXJlCgkJCQkvLyByZWNvcmQgdGhlIGVudHJ5IGFzIG5ldyBmb3IgZnV0dXJlIHRyYXZlcnNhbAoJCQkJLy8KCQkJCS8vIE5PVEUgaXQncyBub3QgZW50aXJlbHkgY2xlYXIgdGhhdCB0aGlzIGlzIHRoZSByaWdodCB0aGluZyB0byBkbyBnaXZlbiB0aGF0IHdlCgkJCQkvLyAgICAgIGNhbid0IGtub3cgdGhlIHVzZXJzIGludGVudGlvbi4gSXQgbWlnaHQgYmUgYmV0dGVyIHRvIGV4cGxpY2l0bHkgX25vdF8KCQkJCS8vICAgICAgc3VwcG9ydCBsb2NhdGlvbi5oYXNoIGFzc2lnbm1lbnQgaW4gcHJlZmVyZW5jZSB0byAkLm5hdmlnYXRlIGNhbGxzCgkJCQkvLyBUT0RPIGZpcnN0IGFyZyB0byBhZGQgc2hvdWxkIGJlIHRoZSBocmVmLCBidXQgaXQgY2F1c2VzIGlzc3VlcyBpbiBpZGVudGlmeWluZwoJCQkJLy8gICAgICBlbWJlZGVkIHBhZ2VzCgkJCQltaXNzaW5nOiBmdW5jdGlvbigpIHsKCQkJCQloaXN0b3J5LmFkZCggaGFzaCwgewoJCQkJCQloYXNoOiBoYXNoLAoJCQkJCQl0aXRsZTogZG9jdW1lbnQudGl0bGUKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkvLyBUT0RPIGNvbnNpZGVyIHF1ZXVlaW5nIG5hdmlnYXRpb24gYWN0aXZpdHkgdW50aWwgcHJldmlvdXMgYWN0aXZpdGllcyBoYXZlIGNvbXBsZXRlZAoJLy8gICAgICBzbyB0aGF0IGVuZCB1c2VycyBkb24ndCBoYXZlIHRvIHRoaW5rIGFib3V0IGl0LiBQdW50aW5nIGZvciBub3cKCS8vIFRPRE8gISEgbW92ZSB0aGUgZXZlbnQgYmluZGluZ3MgaW50byBjYWxsYmFja3Mgb24gdGhlIG5hdmlnYXRlIGV2ZW50CgkkLm1vYmlsZS5uYXZpZ2F0ZSA9IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvci5nbyggdXJsLCBkYXRhLCBub0V2ZW50cyApOwoJfTsKCgkvLyBleHBvc2UgdGhlIGhpc3Rvcnkgb24gdGhlIG5hdmlnYXRlIG1ldGhvZCBpbiBhbnRpY2lwYXRpb24gb2YgZnVsbCBpbnRlZ3JhdGlvbiB3aXRoCgkvLyBleGlzdGluZyBuYXZpZ2F0aW9uIGZ1bmN0aW9uYWx0eSB0aGF0IGlzIHRpZ2h0bHkgY291cGxlZCB0byB0aGUgaGlzdG9yeSBpbmZvcm1hdGlvbgoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSA9IG5ldyAkLm1vYmlsZS5IaXN0b3J5KCk7CgoJLy8gaW5zdGFudGlhdGUgYW4gaW5zdGFuY2Ugb2YgdGhlIG5hdmlnYXRvciBmb3IgdXNlIHdpdGhpbiB0aGUgJC5uYXZpZ2F0ZSBtZXRob2QKCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvciA9IG5ldyAkLm1vYmlsZS5OYXZpZ2F0b3IoICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgKTsKCgl2YXIgbG9jID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCk7CgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFkZCggbG9jLmhyZWYsIHtoYXNoOiBsb2MuaGFzaH0gKTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHByb3BzID0gewoJCQkiYW5pbWF0aW9uIjoge30sCgkJCSJ0cmFuc2l0aW9uIjoge30KCQl9LAoJCXRlc3RFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJdmVuZG9yUHJlZml4ZXMgPSBbICIiLCAid2Via2l0LSIsICJtb3otIiwgIm8tIiBdOwoKCSQuZWFjaCggWyAiYW5pbWF0aW9uIiwgInRyYW5zaXRpb24iIF0sIGZ1bmN0aW9uKCBpLCB0ZXN0ICkgewoKCQkvLyBHZXQgY29ycmVjdCBuYW1lIGZvciB0ZXN0CgkJdmFyIHRlc3ROYW1lID0gKCBpID09PSAwICkgPyB0ZXN0ICsgIi0iICsgIm5hbWUiIDogdGVzdDsKCgkJJC5lYWNoKCB2ZW5kb3JQcmVmaXhlcywgZnVuY3Rpb24oIGosIHByZWZpeCApIHsKCQkJaWYgKCB0ZXN0RWxlbWVudC5zdHlsZVsgJC5jYW1lbENhc2UoIHByZWZpeCArIHRlc3ROYW1lICkgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJIHByb3BzWyB0ZXN0IF1bICJwcmVmaXgiIF0gPSBwcmVmaXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9KTsKCgkJLy8gU2V0IGV2ZW50IGFuZCBkdXJhdGlvbiBuYW1lcyBmb3IgbGF0ZXIgdXNlCgkJcHJvcHNbIHRlc3QgXVsgImR1cmF0aW9uIiBdID0KCQkJJC5jYW1lbENhc2UoIHByb3BzWyB0ZXN0IF1bICJwcmVmaXgiIF0gKyB0ZXN0ICsgIi0iICsgImR1cmF0aW9uIiApOwoJCXByb3BzWyB0ZXN0IF1bICJldmVudCIgXSA9CgkJCSQuY2FtZWxDYXNlKCBwcm9wc1sgdGVzdCBdWyAicHJlZml4IiBdICsgdGVzdCArICItIiArICJlbmQiICk7CgoJCS8vIEFsbCBsb3dlciBjYXNlIGlmIG5vdCBhIHZlbmRvciBwcm9wCgkJaWYgKCBwcm9wc1sgdGVzdCBdWyAicHJlZml4IiBdID09PSAiIiApIHsKCQkJcHJvcHNbIHRlc3QgXVsgImV2ZW50IiBdID0gcHJvcHNbIHRlc3QgXVsgImV2ZW50IiBdLnRvTG93ZXJDYXNlKCk7CgkJfQoJfSk7CgoJLy8gSWYgYSB2YWxpZCBwcmVmaXggd2FzIGZvdW5kIHRoZW4gdGhlIGl0IGlzIHN1cHBvcnRlZCBieSB0aGUgYnJvd3NlcgoJJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zID0gKCBwcm9wc1sgInRyYW5zaXRpb24iIF1bICJwcmVmaXgiIF0gIT09IHVuZGVmaW5lZCApOwoJJC5zdXBwb3J0LmNzc0FuaW1hdGlvbnMgPSAoIHByb3BzWyAiYW5pbWF0aW9uIiBdWyAicHJlZml4IiBdICE9PSB1bmRlZmluZWQgKTsKCgkvLyBSZW1vdmUgdGhlIHRlc3RFbGVtZW50CgkkKCB0ZXN0RWxlbWVudCApLnJlbW92ZSgpOwoKCS8vIEFuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjaywgdHlwZSwgZmFsbGJhY2tUaW1lICkgewoJCXZhciB0aW1lciwgZHVyYXRpb24sCgkJCXRoYXQgPSB0aGlzLAoJCQlhbmltYXRpb25UeXBlID0gKCAhdHlwZSB8fCB0eXBlID09PSAiYW5pbWF0aW9uIiApID8gImFuaW1hdGlvbiIgOiAidHJhbnNpdGlvbiI7CgoJCS8vIE1ha2Ugc3VyZSBzZWxlY3RlZCB0eXBlIGlzIHN1cHBvcnRlZCBieSBicm93c2VyCgkJaWYgKCAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyAmJiBhbmltYXRpb25UeXBlID09PSAidHJhbnNpdGlvbiIgKSB8fAoJCQkoICQuc3VwcG9ydC5jc3NBbmltYXRpb25zICYmIGFuaW1hdGlvblR5cGUgPT09ICJhbmltYXRpb24iICkgKSB7CgoJCQkvLyBJZiBhIGZhbGxiYWNrIHRpbWUgd2FzIG5vdCBwYXNzZWQgc2V0IG9uZQoJCQlpZiAoIGZhbGxiYWNrVGltZSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCS8vIE1ha2Ugc3VyZSB0aGUgd2FzIG5vdCBib3VuZCB0byBkb2N1bWVudCBiZWZvcmUgY2hlY2tpbmcgLmNzcwoJCQkJaWYgKCAkKCB0aGlzICkuY29udGV4dCAhPT0gZG9jdW1lbnQgKSB7CgoJCQkJCS8vIFBhcnNlIHRoZSBkdXJyYXRpb24gc2luY2UgaXRzIGluIHNlY29uZCBtdWx0aXBsZSBieSAxMDAwIGZvciBtaWxsaXNlY29uZHMKCQkJCQkvLyBNdWx0aXBseSBieSAzIHRvIG1ha2Ugc3VyZSB3ZSBnaXZlIHRoZSBhbmltYXRpb24gcGxlbnR5IG9mIHRpbWUuCgkJCQkJZHVyYXRpb24gPSBwYXJzZUZsb2F0KAoJCQkJCQkkKCB0aGlzICkuY3NzKCBwcm9wc1sgYW5pbWF0aW9uVHlwZSBdLmR1cmF0aW9uICkKCQkJCQkpICogMzAwMDsKCQkJCX0KCgkJCQkvLyBJZiB3ZSBjb3VsZCBub3QgcmVhZCBhIGR1cmF0aW9uIHVzZSB0aGUgZGVmYXVsdAoJCQkJaWYgKCBkdXJhdGlvbiA9PT0gMCB8fCBkdXJhdGlvbiA9PT0gdW5kZWZpbmVkIHx8IGlzTmFOKCBkdXJhdGlvbiApICkgewoJCQkJCWR1cmF0aW9uID0gJC5mbi5hbmltYXRpb25Db21wbGV0ZS5kZWZhdWx0RHVyYXRpb247CgkJCQl9CgkJCX0KCgkJCS8vIFNldHMgdXAgdGhlIGZhbGxiYWNrIGlmIGV2ZW50IG5ldmVyIGNvbWVzCgkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGF0ICkub2ZmKCBwcm9wc1sgYW5pbWF0aW9uVHlwZSBdLmV2ZW50ICk7CgkJCQljYWxsYmFjay5hcHBseSggdGhhdCApOwoJCQl9LCBkdXJhdGlvbiApOwoKCQkJLy8gQmluZCB0aGUgZXZlbnQKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoIHByb3BzWyBhbmltYXRpb25UeXBlIF0uZXZlbnQsIGZ1bmN0aW9uKCkgewoKCQkJCS8vIENsZWFyIHRoZSB0aW1lciBzbyB3ZSBkb250IGNhbGwgY2FsbGJhY2sgdHdpY2UKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCWNhbGxiYWNrLmNhbGwoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9KTsKCQl9IGVsc2UgewoKCQkJLy8gQ1NTIGFuaW1hdGlvbiAvIHRyYW5zaXRpb25zIG5vdCBzdXBwb3J0ZWQKCQkJLy8gRGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoICQucHJveHkoIGNhbGxiYWNrLCB0aGlzICksIDAgKTsKCQkJcmV0dXJuICQoIHRoaXMgKTsKCQl9Cgl9OwoKCS8vIEFsbG93IGRlZmF1bHQgY2FsbGJhY2sgdG8gYmUgY29uZmlndXJlZCBvbiBtb2JpbGVJbml0CgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlLmRlZmF1bHREdXJhdGlvbiA9IDEwMDA7Cn0pKCBqUXVlcnkgKTsKCi8vIFRoaXMgcGx1Z2luIGlzIGFuIGV4cGVyaW1lbnQgZm9yIGFic3RyYWN0aW5nIGF3YXkgdGhlIHRvdWNoIGFuZCBtb3VzZQovLyBldmVudHMgc28gdGhhdCBkZXZlbG9wZXJzIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgd2hpY2ggbWV0aG9kIG9mIGlucHV0Ci8vIHRoZSBkZXZpY2UgdGhlaXIgZG9jdW1lbnQgaXMgbG9hZGVkIG9uIHN1cHBvcnRzLgovLwovLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGFsbG93IHRoZSBkZXZlbG9wZXIgdG8gcmVnaXN0ZXIgbGlzdGVuZXJzIGZvciB0aGUKLy8gYmFzaWMgbW91c2UgZXZlbnRzLCBzdWNoIGFzIG1vdXNlZG93biwgbW91c2Vtb3ZlLCBtb3VzZXVwLCBhbmQgY2xpY2ssCi8vIGFuZCB0aGUgcGx1Z2luIHdpbGwgdGFrZSBjYXJlIG9mIHJlZ2lzdGVyaW5nIHRoZSBjb3JyZWN0IGxpc3RlbmVycwovLyBiZWhpbmQgdGhlIHNjZW5lcyB0byBpbnZva2UgdGhlIGxpc3RlbmVyIGF0IHRoZSBmYXN0ZXN0IHBvc3NpYmxlIHRpbWUKLy8gZm9yIHRoYXQgZGV2aWNlLCB3aGlsZSBzdGlsbCByZXRhaW5pbmcgdGhlIG9yZGVyIG9mIGV2ZW50IGZpcmluZyBpbgovLyB0aGUgdHJhZGl0aW9uYWwgbW91c2UgZW52aXJvbm1lbnQsIHNob3VsZCBtdWx0aXBsZSBoYW5kbGVycyBiZSByZWdpc3RlcmVkCi8vIG9uIHRoZSBzYW1lIGVsZW1lbnQgZm9yIGRpZmZlcmVudCBldmVudHMuCi8vCi8vIFRoZSBjdXJyZW50IHZlcnNpb24gZXhwb3NlcyB0aGUgZm9sbG93aW5nIHZpcnR1YWwgZXZlbnRzIHRvIGpRdWVyeSBiaW5kIG1ldGhvZHM6Ci8vICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIKCihmdW5jdGlvbiggJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewoKdmFyIGRhdGFQcm9wZXJ0eU5hbWUgPSAidmlydHVhbE1vdXNlQmluZGluZ3MiLAoJdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgPSAidmlydHVhbFRvdWNoSUQiLAoJdmlydHVhbEV2ZW50TmFtZXMgPSAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiLnNwbGl0KCAiICIgKSwKCXRvdWNoRXZlbnRQcm9wcyA9ICJjbGllbnRYIGNsaWVudFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIi5zcGxpdCggIiAiICksCgltb3VzZUhvb2tQcm9wcyA9ICQuZXZlbnQubW91c2VIb29rcyA/ICQuZXZlbnQubW91c2VIb29rcy5wcm9wcyA6IFtdLAoJbW91c2VFdmVudFByb3BzID0gJC5ldmVudC5wcm9wcy5jb25jYXQoIG1vdXNlSG9va1Byb3BzICksCglhY3RpdmVEb2NIYW5kbGVycyA9IHt9LAoJcmVzZXRUaW1lcklEID0gMCwKCXN0YXJ0WCA9IDAsCglzdGFydFkgPSAwLAoJZGlkU2Nyb2xsID0gZmFsc2UsCgljbGlja0Jsb2NrTGlzdCA9IFtdLAoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2UsCglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZSwKCWV2ZW50Q2FwdHVyZVN1cHBvcnRlZCA9ICJhZGRFdmVudExpc3RlbmVyIiBpbiBkb2N1bWVudCwKCSRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgluZXh0VG91Y2hJRCA9IDEsCglsYXN0VG91Y2hJRCA9IDAsIHRocmVzaG9sZCwKCWk7CgokLnZtb3VzZSA9IHsKCW1vdmVEaXN0YW5jZVRocmVzaG9sZDogMTAsCgljbGlja0Rpc3RhbmNlVGhyZXNob2xkOiAxMCwKCXJlc2V0VGltZXJEdXJhdGlvbjogMTUwMAp9OwoKZnVuY3Rpb24gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkgewoKCXdoaWxlICggZXZlbnQgJiYgdHlwZW9mIGV2ZW50Lm9yaWdpbmFsRXZlbnQgIT09ICJ1bmRlZmluZWQiICkgewoJCWV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCX0KCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICkgewoKCXZhciB0ID0gZXZlbnQudHlwZSwKCQlvZSwgcHJvcHMsIG5lLCBwcm9wLCBjdCwgdG91Y2gsIGksIGosIGxlbjsKCglldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CglldmVudC50eXBlID0gZXZlbnRUeXBlOwoKCW9lID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCXByb3BzID0gJC5ldmVudC5wcm9wczsKCgkvLyBhZGRyZXNzZXMgc2VwYXJhdGlvbiBvZiAkLmV2ZW50LnByb3BzIGluIHRvICQuZXZlbnQubW91c2VIb29rLnByb3BzIGFuZCBJc3N1ZSAzMjgwCgkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzMyODAKCWlmICggdC5zZWFyY2goIC9eKG1vdXNlfGNsaWNrKS8gKSA+IC0xICkgewoJCXByb3BzID0gbW91c2VFdmVudFByb3BzOwoJfQoKCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJaWYgKCBvZSApIHsKCQlmb3IgKCBpID0gcHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJcHJvcCA9IHByb3BzWyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9lWyBwcm9wIF07CgkJfQoJfQoKCS8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBtb3VzZSBhbmQgY2xpY2sgdmlydHVhbCBldmVudHMgYXJlIGdlbmVyYXRlZAoJLy8gd2l0aG91dCBhIC53aGljaCBvbmUgaXMgZGVmaW5lZAoJaWYgKCB0LnNlYXJjaCgvbW91c2UoZG93bnx1cCl8Y2xpY2svKSA+IC0xICYmICFldmVudC53aGljaCApIHsKCQlldmVudC53aGljaCA9IDE7Cgl9CgoJaWYgKCB0LnNlYXJjaCgvXnRvdWNoLykgIT09IC0xICkgewoJCW5lID0gZ2V0TmF0aXZlRXZlbnQoIG9lICk7CgkJdCA9IG5lLnRvdWNoZXM7CgkJY3QgPSBuZS5jaGFuZ2VkVG91Y2hlczsKCQl0b3VjaCA9ICggdCAmJiB0Lmxlbmd0aCApID8gdFswXSA6ICggKCBjdCAmJiBjdC5sZW5ndGggKSA/IGN0WyAwIF0gOiB1bmRlZmluZWQgKTsKCgkJaWYgKCB0b3VjaCApIHsKCQkJZm9yICggaiA9IDAsIGxlbiA9IHRvdWNoRXZlbnRQcm9wcy5sZW5ndGg7IGogPCBsZW47IGorKykgewoJCQkJcHJvcCA9IHRvdWNoRXZlbnRQcm9wc1sgaiBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IHRvdWNoWyBwcm9wIF07CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBlbGVtZW50ICkgewoKCXZhciBmbGFncyA9IHt9LAoJCWIsIGs7CgoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWZvciAoICBrIGluIGIgKSB7CgkJCWlmICggYlsgayBdICkgewoJCQkJZmxhZ3NbIGsgXSA9IGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nID0gdHJ1ZTsKCQkJfQoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIGZsYWdzOwp9CgpmdW5jdGlvbiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZWxlbWVudCwgZXZlbnRUeXBlICkgewoJdmFyIGI7Cgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJaWYgKCBiICYmICggIWV2ZW50VHlwZSB8fCBiWyBldmVudFR5cGUgXSApICkgewoJCQlyZXR1cm4gZWxlbWVudDsKCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBudWxsOwp9CgpmdW5jdGlvbiBlbmFibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGRpc2FibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gdHJ1ZTsKfQoKZnVuY3Rpb24gZW5hYmxlTW91c2VCaW5kaW5ncygpIHsKCWxhc3RUb3VjaElEID0gMDsKCWNsaWNrQmxvY2tMaXN0Lmxlbmd0aCA9IDA7CglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZTsKCgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBlbmFibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBkaXNhYmxlZC4KCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIGRpc2FibGVNb3VzZUJpbmRpbmdzKCkgewoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZGlzYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGVuYWJsZWQuCgllbmFibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIHN0YXJ0UmVzZXRUaW1lcigpIHsKCWNsZWFyUmVzZXRUaW1lcigpOwoJcmVzZXRUaW1lcklEID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJcmVzZXRUaW1lcklEID0gMDsKCQllbmFibGVNb3VzZUJpbmRpbmdzKCk7Cgl9LCAkLnZtb3VzZS5yZXNldFRpbWVyRHVyYXRpb24gKTsKfQoKZnVuY3Rpb24gY2xlYXJSZXNldFRpbWVyKCkgewoJaWYgKCByZXNldFRpbWVySUQgKSB7CgkJY2xlYXJUaW1lb3V0KCByZXNldFRpbWVySUQgKTsKCQlyZXNldFRpbWVySUQgPSAwOwoJfQp9CgpmdW5jdGlvbiB0cmlnZ2VyVmlydHVhbEV2ZW50KCBldmVudFR5cGUsIGV2ZW50LCBmbGFncyApIHsKCXZhciB2ZTsKCglpZiAoICggZmxhZ3MgJiYgZmxhZ3NbIGV2ZW50VHlwZSBdICkgfHwKCQkJCSggIWZsYWdzICYmIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBldmVudC50YXJnZXQsIGV2ZW50VHlwZSApICkgKSB7CgoJCXZlID0gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICk7CgoJCSQoIGV2ZW50LnRhcmdldCkudHJpZ2dlciggdmUgKTsKCX0KCglyZXR1cm4gdmU7Cn0KCmZ1bmN0aW9uIG1vdXNlRXZlbnRDYWxsYmFjayggZXZlbnQgKSB7Cgl2YXIgdG91Y2hJRCA9ICQuZGF0YSggZXZlbnQudGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApLAoJCXZlOwoKCWlmICggIWJsb2NrTW91c2VUcmlnZ2VycyAmJiAoICFsYXN0VG91Y2hJRCB8fCBsYXN0VG91Y2hJRCAhPT0gdG91Y2hJRCApICkgewoJCXZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInYiICsgZXZlbnQudHlwZSwgZXZlbnQgKTsKCQlpZiAoIHZlICkgewoJCQlpZiAoIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCQlpZiAoIHZlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCQlpZiAoIHZlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJdmFyIHRvdWNoZXMgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzLAoJCXRhcmdldCwgZmxhZ3MsIHQ7CgoJaWYgKCB0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoID09PSAxICkgewoKCQl0YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCB0YXJnZXQgKTsKCgkJaWYgKCBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyApIHsKCgkJCWxhc3RUb3VjaElEID0gbmV4dFRvdWNoSUQrKzsKCQkJJC5kYXRhKCB0YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lLCBsYXN0VG91Y2hJRCApOwoKCQkJY2xlYXJSZXNldFRpbWVyKCk7CgoJCQlkaXNhYmxlTW91c2VCaW5kaW5ncygpOwoJCQlkaWRTY3JvbGwgPSBmYWxzZTsKCgkJCXQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF07CgkJCXN0YXJ0WCA9IHQucGFnZVg7CgkJCXN0YXJ0WSA9IHQucGFnZVk7CgoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3ZlciIsIGV2ZW50LCBmbGFncyApOwoJCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlZG93biIsIGV2ZW50LCBmbGFncyApOwoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlU2Nyb2xsKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKSApOwoJfQoKCWRpZFNjcm9sbCA9IHRydWU7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCgl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXSwKCQlkaWRDYW5jZWwgPSBkaWRTY3JvbGwsCgkJbW92ZVRocmVzaG9sZCA9ICQudm1vdXNlLm1vdmVEaXN0YW5jZVRocmVzaG9sZCwKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApOwoKCQlkaWRTY3JvbGwgPSBkaWRTY3JvbGwgfHwKCQkJKCBNYXRoLmFicyggdC5wYWdlWCAtIHN0YXJ0WCApID4gbW92ZVRocmVzaG9sZCB8fAoJCQkJTWF0aC5hYnMoIHQucGFnZVkgLSBzdGFydFkgKSA+IG1vdmVUaHJlc2hvbGQgKTsKCglpZiAoIGRpZFNjcm9sbCAmJiAhZGlkQ2FuY2VsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZmxhZ3MgKTsKCX0KCgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlbW92ZSIsIGV2ZW50LCBmbGFncyApOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwoKCXZhciBmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApLAoJCXZlLCB0OwoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZXVwIiwgZXZlbnQsIGZsYWdzICk7CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInZjbGljayIsIGV2ZW50LCBmbGFncyApOwoJCWlmICggdmUgJiYgdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCS8vIFRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyB0aGUgdG91Y2hlbmQKCQkJLy8gZXZlbnQgZG9uJ3QgbmVjZXNzYXJpbHkgbWF0Y2ggdGhlIHRhcmdldCB1c2VkIGR1cmluZyB0aGUKCQkJLy8gdG91Y2guIFRoaXMgbWVhbnMgd2UgbmVlZCB0byByZWx5IG9uIGNvb3JkaW5hdGVzIGZvciBibG9ja2luZwoJCQkvLyBhbnkgY2xpY2sgdGhhdCBpcyBnZW5lcmF0ZWQuCgkJCXQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS5jaGFuZ2VkVG91Y2hlc1sgMCBdOwoJCQljbGlja0Jsb2NrTGlzdC5wdXNoKHsKCQkJCXRvdWNoSUQ6IGxhc3RUb3VjaElELAoJCQkJeDogdC5jbGllbnRYLAoJCQkJeTogdC5jbGllbnRZCgkJCX0pOwoKCQkJLy8gUHJldmVudCBhbnkgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IGZyb20gdHJpZ2dlcmluZwoJCQkvLyB2aXJ0dWFsIGV2ZW50IG5vdGlmaWNhdGlvbnMuCgkJCWJsb2NrTW91c2VUcmlnZ2VycyA9IHRydWU7CgkJfQoJfQoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW91dCIsIGV2ZW50LCBmbGFncyk7CglkaWRTY3JvbGwgPSBmYWxzZTsKCglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFzVmlydHVhbEJpbmRpbmdzKCBlbGUgKSB7Cgl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIGVsZSwgZGF0YVByb3BlcnR5TmFtZSApLAoJCWs7CgoJaWYgKCBiaW5kaW5ncyApIHsKCQlmb3IgKCBrIGluIGJpbmRpbmdzICkgewoJCQlpZiAoIGJpbmRpbmdzWyBrIF0gKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCX0KCXJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gZHVtbXlNb3VzZUhhbmRsZXIoKSB7fQoKZnVuY3Rpb24gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCBldmVudFR5cGUgKSB7Cgl2YXIgcmVhbFR5cGUgPSBldmVudFR5cGUuc3Vic3RyKCAxICk7CgoJcmV0dXJuIHsKCQlzZXR1cDogZnVuY3Rpb24oLyogZGF0YSwgbmFtZXNwYWNlICovKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhpcyBlbGVtZW50LAoJCQkvLyBhZGQgYSBiaW5kaW5ncyBvYmplY3QgdG8gaXRzIGRhdGEuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSwge30gKTsKCQkJfQoKCQkJLy8gSWYgc2V0dXAgaXMgY2FsbGVkLCB3ZSBrbm93IGl0IGlzIHRoZSBmaXJzdCBiaW5kaW5nIGZvciB0aGlzCgkJCS8vIGV2ZW50VHlwZSwgc28gaW5pdGlhbGl6ZSB0aGUgY291bnQgZm9yIHRoZSBldmVudFR5cGUgdG8gemVyby4KCQkJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IHRydWU7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGV2ZW50IGZvciB0aGlzIHR5cGUsCgkJCS8vIHJlZ2lzdGVyIGEgZ2xvYmFsIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gfHwgMCApICsgMTsKCgkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID09PSAxICkgewoJCQkJJGRvY3VtZW50LmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJLy8gU29tZSBicm93c2VycywgbGlrZSBPcGVyYSBNaW5pLCB3b24ndCBkaXNwYXRjaCBtb3VzZS9jbGljayBldmVudHMKCQkJLy8gZm9yIGVsZW1lbnRzIHVubGVzcyB0aGV5IGFjdHVhbGx5IGhhdmUgaGFuZGxlcnMgcmVnaXN0ZXJlZCBvbiB0aGVtLgoJCQkvLyBUbyBnZXQgYXJvdW5kIHRoaXMsIHdlIHJlZ2lzdGVyIGR1bW15IGhhbmRsZXJzIG9uIHRoZSBlbGVtZW50cy4KCgkJCSQoIHRoaXMgKS5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIEZvciBub3csIGlmIGV2ZW50IGNhcHR1cmUgaXMgbm90IHN1cHBvcnRlZCwgd2UgcmVseSBvbiBtb3VzZSBoYW5kbGVycy4KCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoZSBkb2N1bWVudCwKCQkJCS8vIHJlZ2lzdGVyIG91ciB0b3VjaHN0YXJ0IGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJCWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdIHx8IDApICsgMTsKCgkJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9PT0gMSApIHsKCQkJCQkkZG9jdW1lbnQuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCgkJCQkJCS8vIE9uIHRvdWNoIHBsYXRmb3JtcywgdG91Y2hpbmcgdGhlIHNjcmVlbiBhbmQgdGhlbiBkcmFnZ2luZyB5b3VyIGZpbmdlcgoJCQkJCQkvLyBjYXVzZXMgdGhlIHdpbmRvdyBjb250ZW50IHRvIHNjcm9sbCBhZnRlciBzb21lIGRpc3RhbmNlIHRocmVzaG9sZCBpcwoJCQkJCQkvLyBleGNlZWRlZC4gT24gdGhlc2UgcGxhdGZvcm1zLCBhIHNjcm9sbCBwcmV2ZW50cyBhIGNsaWNrIGV2ZW50IGZyb20gYmVpbmcKCQkJCQkJLy8gZGlzcGF0Y2hlZCwgYW5kIG9uIHNvbWUgcGxhdGZvcm1zLCBldmVuIHRoZSB0b3VjaGVuZCBpcyBzdXBwcmVzc2VkLiBUbwoJCQkJCQkvLyBtaW1pYyB0aGUgc3VwcHJlc3Npb24gb2YgdGhlIGNsaWNrIGV2ZW50LCB3ZSBuZWVkIHRvIHdhdGNoIGZvciBhIHNjcm9sbAoJCQkJCQkvLyBldmVudC4gVW5mb3J0dW5hdGVseSwgc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MgZG9uJ3QgZGlzcGF0Y2ggc2Nyb2xsCgkJCQkJCS8vIGV2ZW50cyB1bnRpbCAqQUZURVIqIHRoZSB1c2VyIGxpZnRzIHRoZWlyIGZpbmdlciAodG91Y2hlbmQpLiBUaGlzIG1lYW5zCgkJCQkJCS8vIHdlIG5lZWQgdG8gd2F0Y2ggYm90aCBzY3JvbGwgYW5kIHRvdWNobW92ZSBldmVudHMgdG8gZmlndXJlIG91dCB3aGV0aGVyCgkJCQkJCS8vIG9yIG5vdCBhIHNjcm9sbCBoYXBwZW5lbnMgYmVmb3JlIHRoZSB0b3VjaGVuZCBldmVudCBpcyBmaXJlZC4KCgkJCQkJCS5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIGJpbmRpbmcgZm9yIHRoaXMgZXZlbnRUeXBlLAoJCQkvLyByZW1vdmUgaXRzIGdsb2JhbCBoYW5kbGVyIGZyb20gdGhlIGRvY3VtZW50LgoKCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF07CgoJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gKSB7CgkJCQkkZG9jdW1lbnQudW5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgaW4gZXhpc3RlbmNlLAoJCQkJLy8gcmVtb3ZlIG91ciBkb2N1bWVudCB0b3VjaHN0YXJ0IGxpc3RlbmVyLgoKCQkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdOwoKCQkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSApIHsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkudW5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLnVuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoJCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCWJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCQkvLyB0ZWFyZG93biBtYXkgYmUgY2FsbGVkIHdoZW4gYW4gZWxlbWVudCB3YXMKCQkJLy8gcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIHRoaXMgaXMgdGhlIGNhc2UsCgkJCS8vIGpRdWVyeSBjb3JlIG1heSBoYXZlIGFscmVhZHkgc3RyaXBwZWQgdGhlIGVsZW1lbnQKCQkJLy8gb2YgYW55IGRhdGEgYmluZGluZ3Mgc28gd2UgbmVlZCB0byBjaGVjayBpdCBiZWZvcmUKCQkJLy8gdXNpbmcgaXQuCgkJCWlmICggYmluZGluZ3MgKSB7CgkJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSBmYWxzZTsKCQkJfQoKCQkJLy8gVW5yZWdpc3RlciB0aGUgZHVtbXkgZXZlbnQgaGFuZGxlci4KCgkJCSR0aGlzLnVuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBvbiB0aGUKCQkJLy8gZWxlbWVudCwgcmVtb3ZlIHRoZSBiaW5kaW5nIGRhdGEgZnJvbSB0aGUgZWxlbWVudC4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJHRoaXMucmVtb3ZlRGF0YSggZGF0YVByb3BlcnR5TmFtZSApOwoJCQl9CgkJfQoJfTsKfQoKLy8gRXhwb3NlIG91ciBjdXN0b20gZXZlbnRzIHRvIHRoZSBqUXVlcnkgYmluZC91bmJpbmQgbWVjaGFuaXNtLgoKZm9yICggaSA9IDA7IGkgPCB2aXJ0dWFsRXZlbnROYW1lcy5sZW5ndGg7IGkrKyApIHsKCSQuZXZlbnQuc3BlY2lhbFsgdmlydHVhbEV2ZW50TmFtZXNbIGkgXSBdID0gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdICk7Cn0KCi8vIEFkZCBhIGNhcHR1cmUgY2xpY2sgaGFuZGxlciB0byBibG9jayBjbGlja3MuCi8vIE5vdGUgdGhhdCB3ZSByZXF1aXJlIGV2ZW50IGNhcHR1cmUgc3VwcG9ydCBmb3IgdGhpcyBzbyBpZiB0aGUgZGV2aWNlCi8vIGRvZXNuJ3Qgc3VwcG9ydCBpdCwgd2UgcHVudCBmb3Igbm93IGFuZCByZWx5IHNvbGVseSBvbiBtb3VzZSBldmVudHMuCmlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJdmFyIGNudCA9IGNsaWNrQmxvY2tMaXN0Lmxlbmd0aCwKCQkJdGFyZ2V0ID0gZS50YXJnZXQsCgkJCXgsIHksIGVsZSwgaSwgbywgdG91Y2hJRDsKCgkJaWYgKCBjbnQgKSB7CgkJCXggPSBlLmNsaWVudFg7CgkJCXkgPSBlLmNsaWVudFk7CgkJCXRocmVzaG9sZCA9ICQudm1vdXNlLmNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ7CgoJCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIHJ1biB0aHJvdWdoIHRoZSBjbGlja0Jsb2NrTGlzdCB0byBzZWUgaWYKCQkJLy8gdGhlIGN1cnJlbnQgY2xpY2sgZXZlbnQgaXMgaW4gdGhlIHByb3hpbWl0eSBvZiBvbmUgb2Ygb3VyCgkJCS8vIHZjbGljayBldmVudHMgdGhhdCBoYWQgcHJldmVudERlZmF1bHQoKSBjYWxsZWQgb24gaXQuIElmIHdlIGZpbmQKCQkJLy8gb25lLCB0aGVuIHdlIGJsb2NrIHRoZSBjbGljay4KCQkJLy8KCQkJLy8gV2h5IGRvIHdlIGhhdmUgdG8gcmVseSBvbiBwcm94aW1pdHk/CgkJCS8vCgkJCS8vIEJlY2F1c2UgdGhlIHRhcmdldCBvZiB0aGUgdG91Y2ggZXZlbnQgdGhhdCB0cmlnZ2VyZWQgdGhlIHZjbGljawoJCQkvLyBjYW4gYmUgZGlmZmVyZW50IGZyb20gdGhlIHRhcmdldCBvZiB0aGUgY2xpY2sgZXZlbnQgc3ludGhlc2l6ZWQKCQkJLy8gYnkgdGhlIGJyb3dzZXIuIFRoZSB0YXJnZXQgb2YgYSBtb3VzZS9jbGljayBldmVudCB0aGF0IGlzIHN5bnRoZXNpemVkCgkJCS8vIGZyb20gYSB0b3VjaCBldmVudCBzZWVtcyB0byBiZSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYy4gRm9yIGV4YW1wbGUsCgkJCS8vIHNvbWUgYnJvd3NlcnMgd2lsbCBmaXJlIG1vdXNlL2NsaWNrIGV2ZW50cyBmb3IgYSBsaW5rIHRoYXQgaXMgbmVhcgoJCQkvLyBhIHRvdWNoIGV2ZW50LCBldmVuIHRob3VnaCB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaHN0YXJ0L3RvdWNoZW5kIGV2ZW50CgkJCS8vIHNheXMgdGhlIHVzZXIgdG91Y2hlZCBvdXRzaWRlIHRoZSBsaW5rLiBBbHNvLCBpdCBzZWVtcyB0aGF0IHdpdGggbW9zdAoJCQkvLyBicm93c2VycywgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgZXZlbnQgaXMgbm90IGNhbGN1bGF0ZWQgdW50aWwgdGhlCgkJCS8vIHRpbWUgaXQgaXMgZGlzcGF0Y2hlZCwgc28gaWYgeW91IHJlcGxhY2UgYW4gZWxlbWVudCB0aGF0IHlvdSB0b3VjaGVkCgkJCS8vIHdpdGggYW5vdGhlciBlbGVtZW50LCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayB3aWxsIGJlIHRoZSBuZXcKCQkJLy8gZWxlbWVudCB1bmRlcm5lYXRoIHRoYXQgcG9pbnQuCgkJCS8vCgkJCS8vIEFzaWRlIGZyb20gcHJveGltaXR5LCB3ZSBhbHNvIGNoZWNrIHRvIHNlZSBpZiB0aGUgdGFyZ2V0IGFuZCBhbnkKCQkJLy8gb2YgaXRzIGFuY2VzdG9ycyB3ZXJlIHRoZSBvbmVzIHRoYXQgYmxvY2tlZCBhIGNsaWNrLiBUaGlzIGlzIG5lY2Vzc2FyeQoJCQkvLyBiZWNhdXNlIG9mIHRoZSBzdHJhbmdlIG1vdXNlL2NsaWNrIHRhcmdldCBjYWxjdWxhdGlvbiBkb25lIGluIHRoZQoJCQkvLyBBbmRyb2lkIDIuMSBicm93c2VyLCB3aGVyZSBpZiB5b3UgY2xpY2sgb24gYW4gZWxlbWVudCwgYW5kIHRoZXJlIGlzIGEKCQkJLy8gbW91c2UvY2xpY2sgaGFuZGxlciBvbiBvbmUgb2YgaXRzIGFuY2VzdG9ycywgdGhlIHRhcmdldCB3aWxsIGJlIHRoZQoJCQkvLyBpbm5lcm1vc3QgY2hpbGQgb2YgdGhlIHRvdWNoZWQgZWxlbWVudCwgZXZlbiBpZiB0aGF0IGNoaWxkIGlzIG5vIHdoZXJlCgkJCS8vIG5lYXIgdGhlIHBvaW50IG9mIHRvdWNoLgoKCQkJZWxlID0gdGFyZ2V0OwoKCQkJd2hpbGUgKCBlbGUgKSB7CgkJCQlmb3IgKCBpID0gMDsgaSA8IGNudDsgaSsrICkgewoJCQkJCW8gPSBjbGlja0Jsb2NrTGlzdFsgaSBdOwoJCQkJCXRvdWNoSUQgPSAwOwoKCQkJCQlpZiAoICggZWxlID09PSB0YXJnZXQgJiYgTWF0aC5hYnMoIG8ueCAtIHggKSA8IHRocmVzaG9sZCAmJiBNYXRoLmFicyggby55IC0geSApIDwgdGhyZXNob2xkICkgfHwKCQkJCQkJCQkkLmRhdGEoIGVsZSwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSA9PT0gby50b3VjaElEICkgewoJCQkJCQkvLyBYWFg6IFdlIG1heSB3YW50IHRvIGNvbnNpZGVyIHJlbW92aW5nIG1hdGNoZXMgZnJvbSB0aGUgYmxvY2sgbGlzdAoJCQkJCQkvLyAgICAgIGluc3RlYWQgb2Ygd2FpdGluZyBmb3IgdGhlIHJlc2V0IHRpbWVyIHRvIGZpcmUuCgkJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCQkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCQl9CgkJfQoJfSwgdHJ1ZSk7Cn0KfSkoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCQlzdXBwb3J0VG91Y2ggPSAkLm1vYmlsZS5zdXBwb3J0LnRvdWNoLAoJCXNjcm9sbEV2ZW50ID0gInRvdWNobW92ZSBzY3JvbGwiLAoJCXRvdWNoU3RhcnRFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaHN0YXJ0IiA6ICJtb3VzZWRvd24iLAoJCXRvdWNoU3RvcEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoZW5kIiA6ICJtb3VzZXVwIiwKCQl0b3VjaE1vdmVFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaG1vdmUiIDogIm1vdXNlbW92ZSI7CgoJLy8gc2V0dXAgbmV3IGV2ZW50IHNob3J0Y3V0cwoJJC5lYWNoKCAoICJ0b3VjaHN0YXJ0IHRvdWNobW92ZSB0b3VjaGVuZCAiICsKCQkidGFwIHRhcGhvbGQgIiArCgkJInN3aXBlIHN3aXBlbGVmdCBzd2lwZXJpZ2h0ICIgKwoJCSJzY3JvbGxzdGFydCBzY3JvbGxzdG9wIiApLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7CgkJfTsKCgkJLy8galF1ZXJ5IDwgMS44CgkJaWYgKCAkLmF0dHJGbiApIHsKCQkJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7CgkJfQoJfSk7CgoJZnVuY3Rpb24gdHJpZ2dlckN1c3RvbUV2ZW50KCBvYmosIGV2ZW50VHlwZSwgZXZlbnQsIGJ1YmJsZSApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCWlmICggYnViYmxlICkgewoJCQkkLmV2ZW50LnRyaWdnZXIoIGV2ZW50LCB1bmRlZmluZWQsIG9iaiApOwoJCX0gZWxzZSB7CgkJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCX0KCQlldmVudC50eXBlID0gb3JpZ2luYWxUeXBlOwoJfQoKCS8vIGFsc28gaGFuZGxlcyBzY3JvbGxzdG9wCgkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQgPSB7CgoJCWVuYWJsZWQ6IHRydWUsCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlzY3JvbGxpbmcsCgkJCQl0aW1lcjsKCgkJCWZ1bmN0aW9uIHRyaWdnZXIoIGV2ZW50LCBzdGF0ZSApIHsKCQkJCXNjcm9sbGluZyA9IHN0YXRlOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCQl9CgoJCQkvLyBpUGhvbmUgdHJpZ2dlcnMgc2Nyb2xsIGFmdGVyIGEgc21hbGwgZGVsYXk7IHVzZSB0b3VjaG1vdmUgaW5zdGVhZAoJCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoICFzY3JvbGxpbmcgKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIHRydWUgKTsKCQkJCX0KCgkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCBmYWxzZSApOwoJCQkJfSwgNTAgKTsKCQkJfSk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS51bmJpbmQoIHNjcm9sbEV2ZW50ICk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAoJJC5ldmVudC5zcGVjaWFsLnRhcCA9IHsKCQl0YXBob2xkVGhyZXNob2xkOiA3NTAsCgkJZW1pdFRhcE9uVGFwaG9sZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApLAoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgoJCQkkdGhpcy5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlzVGFwaG9sZCA9IGZhbHNlOwoJCQkJaWYgKCBldmVudC53aGljaCAmJiBldmVudC53aGljaCAhPT0gMSApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJdmFyIG9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQkJdGltZXI7CgoJCQkJZnVuY3Rpb24gY2xlYXJUYXBUaW1lcigpIHsKCQkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xlYXJUYXBIYW5kbGVycygpIHsKCQkJCQljbGVhclRhcFRpbWVyKCk7CgoJCQkJCSR0aGlzLnVuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApCgkJCQkJCS51bmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKTsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsaWNrSGFuZGxlciggZXZlbnQgKSB7CgkJCQkJY2xlYXJUYXBIYW5kbGVycygpOwoKCQkJCQkvLyBPTkxZIHRyaWdnZXIgYSAndGFwJyBldmVudCBpZiB0aGUgc3RhcnQgdGFyZ2V0IGlzCgkJCQkJLy8gdGhlIHNhbWUgYXMgdGhlIHN0b3AgdGFyZ2V0LgoJCQkJCWlmICggIWlzVGFwaG9sZCAmJiBvcmlnVGFyZ2V0ID09PSBldmVudC50YXJnZXQgKSB7CgkJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcCIsIGV2ZW50ICk7CgkJCQkJfSBlbHNlIGlmICggaXNUYXBob2xkICkgewoJCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRoaXMuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkJLmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKTsKCQkJCSRkb2N1bWVudC5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnRhcC5lbWl0VGFwT25UYXBob2xkICkgewoJCQkJCQlpc1RhcGhvbGQgPSB0cnVlOwoJCQkJCX0KCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXBob2xkIiwgJC5FdmVudCggInRhcGhvbGQiLCB7IHRhcmdldDogb3JpZ1RhcmdldCB9ICkgKTsKCQkJCX0sICQuZXZlbnQuc3BlY2lhbC50YXAudGFwaG9sZFRocmVzaG9sZCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggInZtb3VzZWRvd24iICkudW5iaW5kKCAidmNsaWNrIiApLnVuYmluZCggInZtb3VzZXVwIiApOwoJCQkkZG9jdW1lbnQudW5iaW5kKCAidm1vdXNlY2FuY2VsIiApOwoJCX0KCX07CgoJLy8gQWxzbyBoYW5kbGVzIHN3aXBlbGVmdCwgc3dpcGVyaWdodAoJJC5ldmVudC5zcGVjaWFsLnN3aXBlID0gewoKCQkvLyBNb3JlIHRoYW4gdGhpcyBob3Jpem9udGFsIGRpc3BsYWNlbWVudCwgYW5kIHdlIHdpbGwgc3VwcHJlc3Mgc2Nyb2xsaW5nLgoJCXNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQ6IDMwLAoKCQkvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCQlkdXJhdGlvblRocmVzaG9sZDogMTAwMCwKCgkJLy8gU3dpcGUgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBtb3JlIHRoYW4gdGhpcy4KCQlob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQ6IDMwLAoKCQkvLyBTd2lwZSB2ZXJ0aWNhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBsZXNzIHRoYW4gdGhpcy4KCQl2ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwKCgkJZ2V0TG9jYXRpb246IGZ1bmN0aW9uICggZXZlbnQgKSB7CgkJCXZhciB3aW5QYWdlWCA9IHdpbmRvdy5wYWdlWE9mZnNldCwKCQkJCXdpblBhZ2VZID0gd2luZG93LnBhZ2VZT2Zmc2V0LAoJCQkJeCA9IGV2ZW50LmNsaWVudFgsCgkJCQl5ID0gZXZlbnQuY2xpZW50WTsKCgkJCWlmICggZXZlbnQucGFnZVkgPT09IDAgJiYgTWF0aC5mbG9vciggeSApID4gTWF0aC5mbG9vciggZXZlbnQucGFnZVkgKSB8fAoJCQkJZXZlbnQucGFnZVggPT09IDAgJiYgTWF0aC5mbG9vciggeCApID4gTWF0aC5mbG9vciggZXZlbnQucGFnZVggKSApIHsKCgkJCQkvLyBpT1M0IGNsaWVudFgvY2xpZW50WSBoYXZlIHRoZSB2YWx1ZSB0aGF0IHNob3VsZCBoYXZlIGJlZW4KCQkJCS8vIGluIHBhZ2VYL3BhZ2VZLiBXaGlsZSBwYWdlWC9wYWdlLyBoYXZlIHRoZSB2YWx1ZSAwCgkJCQl4ID0geCAtIHdpblBhZ2VYOwoJCQkJeSA9IHkgLSB3aW5QYWdlWTsKCQkJfSBlbHNlIGlmICggeSA8ICggZXZlbnQucGFnZVkgLSB3aW5QYWdlWSkgfHwgeCA8ICggZXZlbnQucGFnZVggLSB3aW5QYWdlWCApICkgewoKCQkJCS8vIFNvbWUgQW5kcm9pZCBicm93c2VycyBoYXZlIHRvdGFsbHkgYm9ndXMgdmFsdWVzIGZvciBjbGllbnRYL1kKCQkJCS8vIHdoZW4gc2Nyb2xsaW5nL3pvb21pbmcgYSBwYWdlLiBEZXRlY3RhYmxlIHNpbmNlIGNsaWVudFgvY2xpZW50WQoJCQkJLy8gc2hvdWxkIG5ldmVyIGJlIHNtYWxsZXIgdGhhbiBwYWdlWC9wYWdlWSBtaW51cyBwYWdlIHNjcm9sbAoJCQkJeCA9IGV2ZW50LnBhZ2VYIC0gd2luUGFnZVg7CgkJCQl5ID0gZXZlbnQucGFnZVkgLSB3aW5QYWdlWTsKCQkJfQoKCQkJcmV0dXJuIHsKCQkJCXg6IHgsCgkJCQl5OiB5CgkJCX07CgkJfSwKCgkJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQsCgkJCQlsb2NhdGlvbiA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5nZXRMb2NhdGlvbiggZGF0YSApOwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBsb2NhdGlvbi54LCBsb2NhdGlvbi55IF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQsCgkJCQlsb2NhdGlvbiA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5nZXRMb2NhdGlvbiggZGF0YSApOwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBsb2NhdGlvbi54LCBsb2NhdGlvbi55IF0KCQkJCQl9OwoJCX0sCgoJCWhhbmRsZVN3aXBlOiBmdW5jdGlvbiggc3RhcnQsIHN0b3AsIHRoaXNPYmplY3QsIG9yaWdUYXJnZXQgKSB7CgkJCWlmICggc3RvcC50aW1lIC0gc3RhcnQudGltZSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5kdXJhdGlvblRocmVzaG9sZCAmJgoJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZCAmJgoJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMSBdIC0gc3RvcC5jb29yZHNbIDEgXSApIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLnZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQgKSB7CgkJCQl2YXIgZGlyZWN0aW9uID0gc3RhcnQuY29vcmRzWzBdID4gc3RvcC5jb29yZHNbIDAgXSA/ICJzd2lwZWxlZnQiIDogInN3aXBlcmlnaHQiOwoKCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInN3aXBlIiwgJC5FdmVudCggInN3aXBlIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQsIHN3aXBlc3RhcnQ6IHN0YXJ0LCBzd2lwZXN0b3A6IHN0b3AgfSksIHRydWUgKTsKCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgZGlyZWN0aW9uLCQuRXZlbnQoIGRpcmVjdGlvbiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQsIHN3aXBlc3RhcnQ6IHN0YXJ0LCBzd2lwZXN0b3A6IHN0b3AgfSApLCB0cnVlICk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgoJCX0sCgoJCS8vIFRoaXMgc2VydmVzIGFzIGEgZmxhZyB0byBlbnN1cmUgdGhhdCBhdCBtb3N0IG9uZSBzd2lwZSBldmVudCBldmVudCBpcwoJCS8vIGluIHdvcmsgYXQgYW55IGdpdmVuIHRpbWUKCQlldmVudEluUHJvZ3Jlc3M6IGZhbHNlLAoKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCXZhciBldmVudHMsCgkJCQl0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApLAoJCQkJY29udGV4dCA9IHt9OwoKCQkJLy8gUmV0cmlldmUgdGhlIGV2ZW50cyBkYXRhIGZvciB0aGlzIGVsZW1lbnQgYW5kIGFkZCB0aGUgc3dpcGUgY29udGV4dAoJCQlldmVudHMgPSAkLmRhdGEoIHRoaXMsICJtb2JpbGUtZXZlbnRzIiApOwoJCQlpZiAoICFldmVudHMgKSB7CgkJCQlldmVudHMgPSB7IGxlbmd0aDogMCB9OwoJCQkJJC5kYXRhKCB0aGlzLCAibW9iaWxlLWV2ZW50cyIsIGV2ZW50cyApOwoJCQl9CgkJCWV2ZW50cy5sZW5ndGgrKzsKCQkJZXZlbnRzLnN3aXBlID0gY29udGV4dDsKCgkJCWNvbnRleHQuc3RhcnQgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gQmFpbCBpZiB3ZSdyZSBhbHJlYWR5IHdvcmtpbmcgb24gYSBzd2lwZSBldmVudAoJCQkJaWYgKCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZXZlbnRJblByb2dyZXNzICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCSQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ldmVudEluUHJvZ3Jlc3MgPSB0cnVlOwoKCQkJCXZhciBzdG9wLAoJCQkJCXN0YXJ0ID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0YXJ0KCBldmVudCApLAoJCQkJCW9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQkJZW1pdHRlZCA9IGZhbHNlOwoKCQkJCWNvbnRleHQubW92ZSA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoICFzdGFydCApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJc3RvcCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zdG9wKCBldmVudCApOwoJCQkJCWlmICggIWVtaXR0ZWQgKSB7CgkJCQkJCWVtaXR0ZWQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaGFuZGxlU3dpcGUoIHN0YXJ0LCBzdG9wLCB0aGlzT2JqZWN0LCBvcmlnVGFyZ2V0ICk7CgkJCQkJCWlmICggZW1pdHRlZCApIHsKCgkJCQkJCQkvLyBSZXNldCB0aGUgY29udGV4dCB0byBtYWtlIHdheSBmb3IgdGhlIG5leHQgc3dpcGUgZXZlbnQKCQkJCQkJCSQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ldmVudEluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJCQkJfQoJCQkJCX0KCQkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJCWlmICggTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfTsKCgkJCQljb250ZXh0LnN0b3AgPSBmdW5jdGlvbigpIHsKCQkJCQkJZW1pdHRlZCA9IHRydWU7CgoJCQkJCQkvLyBSZXNldCB0aGUgY29udGV4dCB0byBtYWtlIHdheSBmb3IgdGhlIG5leHQgc3dpcGUgZXZlbnQKCQkJCQkJJC5ldmVudC5zcGVjaWFsLnN3aXBlLmV2ZW50SW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQkJCQkkZG9jdW1lbnQub2ZmKCB0b3VjaE1vdmVFdmVudCwgY29udGV4dC5tb3ZlICk7CgkJCQkJCWNvbnRleHQubW92ZSA9IG51bGw7CgkJCQl9OwoKCQkJCSRkb2N1bWVudC5vbiggdG91Y2hNb3ZlRXZlbnQsIGNvbnRleHQubW92ZSApCgkJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGNvbnRleHQuc3RvcCApOwoJCQl9OwoJCQkkdGhpcy5vbiggdG91Y2hTdGFydEV2ZW50LCBjb250ZXh0LnN0YXJ0ICk7CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQl2YXIgZXZlbnRzLCBjb250ZXh0OwoKCQkJZXZlbnRzID0gJC5kYXRhKCB0aGlzLCAibW9iaWxlLWV2ZW50cyIgKTsKCQkJaWYgKCBldmVudHMgKSB7CgkJCQljb250ZXh0ID0gZXZlbnRzLnN3aXBlOwoJCQkJZGVsZXRlIGV2ZW50cy5zd2lwZTsKCQkJCWV2ZW50cy5sZW5ndGgtLTsKCQkJCWlmICggZXZlbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkkLnJlbW92ZURhdGEoIHRoaXMsICJtb2JpbGUtZXZlbnRzIiApOwoJCQkJfQoJCQl9CgoJCQlpZiAoIGNvbnRleHQgKSB7CgkJCQlpZiAoIGNvbnRleHQuc3RhcnQgKSB7CgkJCQkJJCggdGhpcyApLm9mZiggdG91Y2hTdGFydEV2ZW50LCBjb250ZXh0LnN0YXJ0ICk7CgkJCQl9CgkJCQlpZiAoIGNvbnRleHQubW92ZSApIHsKCQkJCQkkZG9jdW1lbnQub2ZmKCB0b3VjaE1vdmVFdmVudCwgY29udGV4dC5tb3ZlICk7CgkJCQl9CgkJCQlpZiAoIGNvbnRleHQuc3RvcCApIHsKCQkJCQkkZG9jdW1lbnQub2ZmKCB0b3VjaFN0b3BFdmVudCwgY29udGV4dC5zdG9wICk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoJJC5lYWNoKHsKCQlzY3JvbGxzdG9wOiAic2Nyb2xsc3RhcnQiLAoJCXRhcGhvbGQ6ICJ0YXAiLAoJCXN3aXBlbGVmdDogInN3aXBlIiwKCQlzd2lwZXJpZ2h0OiAic3dpcGUiCgl9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCQkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoIHNvdXJjZUV2ZW50ICk7CgkJCX0KCQl9OwoJfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKCS8vIHRocm90dGxlZCByZXNpemUgZXZlbnQKCShmdW5jdGlvbiggJCApIHsKCQkkLmV2ZW50LnNwZWNpYWwudGhyb3R0bGVkcmVzaXplID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfQoJCX07CgoJCXZhciB0aHJvdHRsZSA9IDI1MCwKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQkJY3VyciA9ICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCQkJCWRpZmYgPSBjdXJyIC0gbGFzdENhbGw7CgoJCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCQlsYXN0Q2FsbCA9IGN1cnI7CgkJCQkJJCggdGhpcyApLnRyaWdnZXIoICJ0aHJvdHRsZWRyZXNpemUiICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaWYgKCBoZWxkQ2FsbCApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBoZWxkQ2FsbCApOwoJCQkJCX0KCgkJCQkJLy8gUHJvbWlzZSBhIGhlbGQgY2FsbCB3aWxsIHN0aWxsIGV4ZWN1dGUKCQkJCQloZWxkQ2FsbCA9IHNldFRpbWVvdXQoIGhhbmRsZXIsIHRocm90dGxlIC0gZGlmZiApOwoJCQkJfQoJCQl9LAoJCQlsYXN0Q2FsbCA9IDAsCgkJCWhlbGRDYWxsLAoJCQljdXJyLAoJCQlkaWZmOwoJfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfSwKCQl3dywgd2gsIGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgd2luLndpZHRoKCk7CgkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgd2luLmhlaWdodCgpOwoJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgkJLy8gTm93IGNoZWNrIHRvIHNlZSBpZiB0aGUgY3VycmVudCB3aW5kb3cub3JpZW50YXRpb24gaXMgMCBvciAxODAuCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCgkJLy8gSWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgbGFuZHNjYXBlLCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgMCBvciAxODAsICpPUioKCQkvLyBpZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBwb3J0cmFpdCwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDkwIG9yIC05MCwgd2UKCQkvLyBuZWVkIHRvIGZsaXAgb3VyIHBvcnRyYWl0X21hcCB2YWx1ZXMgYmVjYXVzZSBsYW5kc2NhcGUgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gZm9yCgkJLy8gdGhpcyBkZXZpY2UvYnJvd3Nlci4KCQlpZiAoICggaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgfHwgKCAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgIWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApICkgewoJCQlwb3J0cmFpdF9tYXAgPSB7ICItOTAiOiB0cnVlLCAiOTAiOiB0cnVlIH07CgkJfQoJfQoKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSA9ICQuZXh0ZW5kKCB7fSwgJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLCB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdCBqUXVlcnkKCQkJLy8gd2lsbCBiaW5kIHRvIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdAoJCQkvLyBqUXVlcnkgd2lsbCB1bmJpbmQgdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCB1bmJpbmQgdGhlCgkJCS8vIHJlc2l6ZSBldmVudCBoYW5kbGVyLgoJCQl3aW4udW5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJYWRkOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBib3VuZCBldmVudCBoYW5kbGVyLgoJCQl2YXIgb2xkX2hhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlcjsKCgkJCWhhbmRsZU9iai5oYW5kbGVyID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJLy8gTW9kaWZ5IGV2ZW50IG9iamVjdCwgYWRkaW5nIHRoZSAub3JpZW50YXRpb24gcHJvcGVydHkuCgkJCQlldmVudC5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJCS8vIENhbGwgdGhlIG9yaWdpbmFsbHktYm91bmQgZXZlbnQgaGFuZGxlciBhbmQgcmV0dXJuIGl0cyByZXN1bHQuCgkJCQlyZXR1cm4gb2xkX2hhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9OwoJCX0KCX0pOwoKCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGlzIGhhbmRsZXIgd2lsbCBiZSBib3VuZCB0bwoJLy8gdGhlIHdpbmRvdyByZXNpemUgZXZlbnQgdG8gc2ltdWxhdGUgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJZnVuY3Rpb24gaGFuZGxlcigpIHsKCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24uCgkJdmFyIG9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCWlmICggb3JpZW50YXRpb24gIT09IGxhc3Rfb3JpZW50YXRpb24gKSB7CgkJCS8vIFRoZSBvcmllbnRhdGlvbiBoYXMgY2hhbmdlZCwgc28gdHJpZ2dlciB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBvcmllbnRhdGlvbjsKCQkJd2luLnRyaWdnZXIoIGV2ZW50X25hbWUgKTsKCQl9Cgl9CgoJLy8gR2V0IHRoZSBjdXJyZW50IHBhZ2Ugb3JpZW50YXRpb24uIFRoaXMgbWV0aG9kIGlzIGV4cG9zZWQgcHVibGljbHksIHNob3VsZCBpdAoJLy8gYmUgbmVlZGVkLCBhcyBqUXVlcnkuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbigpCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24gPSBmdW5jdGlvbigpIHsKCQl2YXIgaXNQb3J0cmFpdCA9IHRydWUsIGVsZW0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgoJCS8vIHByZWZlciB3aW5kb3cgb3JpZW50YXRpb24gdG8gdGhlIGNhbGN1bGF0aW9uIGJhc2VkIG9uIHNjcmVlbnNpemUgYXMKCQkvLyB0aGUgYWN0dWFsIHNjcmVlbiByZXNpemUgdGFrZXMgcGxhY2UgYmVmb3JlIG9yIGFmdGVyIHRoZSBvcmllbnRhdGlvbiBjaGFuZ2UgZXZlbnQKCQkvLyBoYXMgYmVlbiBmaXJlZCBkZXBlbmRpbmcgb24gaW1wbGVtZW50YXRpb24gKGVnIGFuZHJvaWQgMi4zIGlzIGJlZm9yZSwgaXBob25lIGFmdGVyKS4KCQkvLyBNb3JlIHRlc3RpbmcgaXMgcmVxdWlyZWQgdG8gZGV0ZXJtaW5lIGlmIGEgbW9yZSByZWxpYWJsZSBtZXRob2Qgb2YgZGV0ZXJtaW5pbmcgdGhlIG5ldyBzY3JlZW5zaXplCgkJLy8gaXMgcG9zc2libGUgd2hlbiBvcmllbnRhdGlvbmNoYW5nZSBpcyBmaXJlZC4gKGVnLCB1c2UgbWVkaWEgcXVlcmllcyArIGVsZW1lbnQgKyBvcGFjaXR5KQoJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoJCQkvLyBpZiB0aGUgd2luZG93IG9yaWVudGF0aW9uIHJlZ2lzdGVycyBhcyAwIG9yIDE4MCBkZWdyZWVzIHJlcG9ydAoJCQkvLyBwb3J0cmFpdCwgb3RoZXJ3aXNlIGxhbmRzY2FwZQoJCQlpc1BvcnRyYWl0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCQl9IGVsc2UgewoJCQlpc1BvcnRyYWl0ID0gZWxlbSAmJiBlbGVtLmNsaWVudFdpZHRoIC8gZWxlbS5jbGllbnRIZWlnaHQgPCAxLjE7CgkJfQoKCQlyZXR1cm4gaXNQb3J0cmFpdCA/ICJwb3J0cmFpdCIgOiAibGFuZHNjYXBlIjsKCX07CgoJJC5mblsgZXZlbnRfbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiBmbiA/IHRoaXMuYmluZCggZXZlbnRfbmFtZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggZXZlbnRfbmFtZSApOwoJfTsKCgkvLyBqUXVlcnkgPCAxLjgKCWlmICggJC5hdHRyRm4gKSB7CgkJJC5hdHRyRm5bIGV2ZW50X25hbWUgXSA9IHRydWU7Cgl9Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvLyBleGlzdGluZyBiYXNlIHRhZz8KCXZhciBiYXNlRWxlbWVudCA9ICQoICJoZWFkIiApLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkvLyBiYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkvLyBUT0RPIG1vdmUgdG8gZXh0ZXJuYWwgd2lkZ2V0CgliYXNlID0gewoKCQkvLyBkZWZpbmUgYmFzZSBlbGVtZW50LCBmb3IgdXNlIGluIHJvdXRpbmcgYXNzZXQgdXJscyB0aGF0IGFyZSByZWZlcmVuY2VkCgkJLy8gaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJZWxlbWVudDogKCBiYXNlRWxlbWVudC5sZW5ndGggPyBiYXNlRWxlbWVudCA6CgkJCSQoICI8YmFzZT4iLCB7IGhyZWY6ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggfSApLnByZXBlbmRUbyggJCggImhlYWQiICkgKSApLAoKCQlsaW5rU2VsZWN0b3I6ICJbc3JjXSwgbGlua1tocmVmXSwgYVtyZWw9J2V4dGVybmFsJ10sIDpqcW1EYXRhKGFqYXg9J2ZhbHNlJyksIGFbdGFyZ2V0XSIsCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXNldDogZnVuY3Rpb24oIGhyZWYgKSB7CgoJCQkvLyB3ZSBzaG91bGQgZG8gbm90aGluZyBpZiB0aGUgdXNlciB3YW50cyB0byBtYW5hZ2UgdGhlaXIgdXJsIGJhc2UKCQkJLy8gbWFudWFsbHkKCQkJaWYgKCAhJC5tb2JpbGUuZHluYW1pY0Jhc2VFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyB3ZSBzaG91bGQgdXNlIHRoZSBiYXNlIHRhZyBpZiB3ZSBjYW4gbWFuaXB1bGF0ZSBpdCBkeW5hbWljYWxseQoJCQlpZiAoICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyApIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsCgkJCQkJJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlICkgKTsKCQkJfQoJCX0sCgoJCXJld3JpdGU6IGZ1bmN0aW9uKCBocmVmLCBwYWdlICkgewoJCQl2YXIgbmV3UGF0aCA9ICQubW9iaWxlLnBhdGguZ2V0KCBocmVmICk7CgoJCQlwYWdlLmZpbmQoIGJhc2UubGlua1NlbGVjdG9yICkuZWFjaChmdW5jdGlvbiggaSwgbGluayApIHsKCQkJCXZhciB0aGlzQXR0ciA9ICQoIGxpbmsgKS5pcyggIltocmVmXSIgKSA/ICJocmVmIiA6CgkJCQkJJCggbGluayApLmlzKCAiW3NyY10iICkgPyAic3JjIiA6ICJhY3Rpb24iLAoJCQkJdGhpc1VybCA9ICQoIGxpbmsgKS5hdHRyKCB0aGlzQXR0ciApOwoKCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkvLyAgICAgICAgICAgIGJhc2UgVVJMLCBhbmQgdGhlbiBwcmVwZW5kcyB3aXRoIHRoZSBuZXcgcGFnZSBVUkwuCgkJCQkvLyBpZiBmdWxsIHBhdGggZXhpc3RzIGFuZCBpcyBzYW1lLCBjaG9wIGl0IC0gaGVscHMgSUUgb3V0CgkJCQl0aGlzVXJsID0gdGhpc1VybC5yZXBsYWNlKCBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKwoJCQkJCWxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgIiIgKTsKCgkJCQlpZiAoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJJCggbGluayApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBzZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQlyZXNldDogZnVuY3Rpb24oLyogaHJlZiAqLykgewoJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9TZWFyY2ggKTsKCQl9Cgl9OwoKCSQubW9iaWxlLmJhc2UgPSBiYXNlOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewokLm1vYmlsZS53aWRnZXRzID0ge307Cgp2YXIgb3JpZ2luYWxXaWRnZXQgPSAkLndpZGdldCwKCgkvLyBSZWNvcmQgdGhlIG9yaWdpbmFsLCBub24tbW9iaWxlaW5pdC1tb2RpZmllZCB2ZXJzaW9uIG9mICQubW9iaWxlLmtlZXBOYXRpdmUKCS8vIHNvIHdlIGNhbiBsYXRlciBkZXRlcm1pbmUgd2hldGhlciBzb21lb25lIGhhcyBtb2RpZmllZCAkLm1vYmlsZS5rZWVwTmF0aXZlCglrZWVwTmF0aXZlRmFjdG9yeURlZmF1bHQgPSAkLm1vYmlsZS5rZWVwTmF0aXZlOwoKJC53aWRnZXQgPSAoZnVuY3Rpb24oIG9yaWcgKSB7CglyZXR1cm4gZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnN0cnVjdG9yID0gb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICksCgkJCW5hbWUgPSBjb25zdHJ1Y3Rvci5wcm90b3R5cGUud2lkZ2V0TmFtZTsKCgkJY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yID0gKCAoIGNvbnN0cnVjdG9yLnByb3RvdHlwZS5pbml0U2VsZWN0b3IgIT09IHVuZGVmaW5lZCApID8KCQkJY29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciA6ICI6anFtRGF0YShyb2xlPSciICsgbmFtZSArICInKSIgKTsKCgkJJC5tb2JpbGUud2lkZ2V0c1sgbmFtZSBdID0gY29uc3RydWN0b3I7CgoJCXJldHVybiBjb25zdHJ1Y3RvcjsKCX07Cn0pKCAkLndpZGdldCApOwoKLy8gTWFrZSBzdXJlICQud2lkZ2V0IHN0aWxsIGhhcyBicmlkZ2UgYW5kIGV4dGVuZCBtZXRob2RzCiQuZXh0ZW5kKCAkLndpZGdldCwgb3JpZ2luYWxXaWRnZXQgKTsKCi8vIEZvciBiYWNrY29tcGF0IHJlbW92ZSBpbiAxLjUKJC5tb2JpbGUuZG9jdW1lbnQub24oICJjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkkKCBldmVudC50YXJnZXQgKS5lbmhhbmNlV2l0aGluKCk7Cn0pOwoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImEiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCWtlZXBOYXRpdmVEZWZhdWx0OiAkLm1vYmlsZS5rZWVwTmF0aXZlLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJY29udGVudFRoZW1lOiBudWxsLAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCgkvLyBERVBSRUNBVEVEIGZvciA+IDEuNAoJLy8gVE9ETyByZW1vdmUgYXQgMS41CglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQkkLldpZGdldC5wcm90b3R5cGUuX2NyZWF0ZVdpZGdldC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fdHJpZ2dlciggImluaXQiICk7Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCS8vIElmIGZhbHNlIGlzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFja3MgZG8gbm90IGNyZWF0ZSB0aGUgcGFnZQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWNyZWF0ZSIgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudCwgewoJCQlwYWdlYmVmb3JlaGlkZTogInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiLAoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIKCQl9KTsKCgkJdGhpcy5lbGVtZW50LmVuaGFuY2VXaXRoaW4oKTsKCQkvLyBEaWFsb2cgd2lkZ2V0IGlzIGRlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSB0aGlzIGluIDEuNQoJCWlmICggJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLmVsZW1lbnRbMF0sICJyb2xlIiApID09PSAiZGlhbG9nIiAmJiAkLm1vYmlsZS5kaWFsb2cgKSB7CgkJCXRoaXMuZWxlbWVudC5kaWFsb2coKTsKCQl9Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbiAoKSB7CgkJdmFyIGF0dHJQcmVmaXggPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5yb2xlICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCB0aGlzLm9wdGlvbnMucm9sZSApOwoJCX0KCgkJdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wYWdlIHVpLXBhZ2UtdGhlbWUtIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoKCQkvLyBNYW5pcHVsYXRpb24gb2YgY29udGVudCBvcyBEZXByZWNhdGVkIGFzIG9mIDEuNCByZW1vdmUgaW4gMS41CgkJdGhpcy5lbGVtZW50LmZpbmQoICJbIiArIGF0dHJQcmVmaXggKyAicm9sZT0nY29udGVudCddIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQl0aGVtZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCBhdHRyUHJlZml4ICsgInRoZW1lIiApIHx8IHVuZGVmaW5lZDsKCQkJCXNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgPSB0aGVtZSB8fCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lIHx8ICggc2VsZi5vcHRpb25zLmRpYWxvZyAmJiBzZWxmLm9wdGlvbnMudGhlbWUgKSB8fCAoIHNlbGYuZWxlbWVudC5qcW1EYXRhKCJyb2xlIikgPT09ICJkaWFsb2ciICYmICBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJCSR0aGlzLmFkZENsYXNzKCAidWktY29udGVudCIgKTsKCQkJCWlmICggc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSApIHsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSApICk7CgkJCQl9CgkJCQkvLyBBZGQgQVJJQSByb2xlCgkJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApLmFkZENsYXNzKCAidWktY29udGVudCIgKTsKCQl9KTsKCX0sCgoJYmluZFJlbW92ZTogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXZhciBwYWdlID0gdGhpcy5lbGVtZW50OwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiAoICFwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlICYmCgkJCXBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgKSB7CgoJCQkvLyBUT0RPIHVzZSBfb24gLSB0aGF0IGlzLCBzb3J0IG91dCB3aHkgaXQgZG9lc24ndCB3b3JrIGluIHRoaXMgY2FzZQoJCQlwYWdlLmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiLCBjYWxsYmFjayB8fCBmdW5jdGlvbiggZSwgZGF0YSApIHsKCgkJCQkvL2NoZWNrIGlmIHRoaXMgaXMgYSBzYW1lIHBhZ2UgdHJhbnNpdGlvbiBhbmQgaWYgc28gZG9uJ3QgcmVtb3ZlIHRoZSBwYWdlCgkJCQlpZiggIWRhdGEuc2FtZVBhZ2UgKXsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJCSR0aGlzLnRyaWdnZXIoIHByRXZlbnQgKTsKCgkJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJJHRoaXMucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCWlmICggby50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLXRoZW1lLSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKS5hZGRDbGFzcyggInVpLXBhZ2UtdGhlbWUtIiArIG8udGhlbWUgKTsKCQl9CgoJCWlmICggby5jb250ZW50VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiPSdjb250ZW50J10iICkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyB0aGlzLm9wdGlvbnMuY29udGVudFRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIG8uY29udGVudFRoZW1lICk7CgkJfQoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQl0aGlzLnNldENvbnRhaW5lckJhY2tncm91bmQoKTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CglyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIjptb2JpbGUtcGFnZWNvbnRhaW5lciIgKS5wYWdlY29udGFpbmVyKHsgInRoZW1lIjogIm5vbmUiIH0pOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCS8vIHNldCB0aGUgcGFnZSBjb250YWluZXIgYmFja2dyb3VuZCB0byB0aGUgcGFnZSB0aGVtZQoJc2V0Q29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oIHRoZW1lICkgewoJCXRoaXMuZWxlbWVudC5wYXJlbnQoKS5wYWdlY29udGFpbmVyKCB7ICJ0aGVtZSI6IHRoZW1lIHx8IHRoaXMub3B0aW9ucy50aGVtZSB9ICk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJa2VlcE5hdGl2ZVNlbGVjdG9yOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJa2VlcE5hdGl2ZSA9ICQudHJpbSggb3B0aW9ucy5rZWVwTmF0aXZlIHx8ICIiICksCgkJCWdsb2JhbFZhbHVlID0gJC50cmltKCAkLm1vYmlsZS5rZWVwTmF0aXZlICksCgkJCW9wdGlvblZhbHVlID0gJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0ICksCgoJCQkvLyBDaGVjayBpZiAkLm1vYmlsZS5rZWVwTmF0aXZlIGhhcyBjaGFuZ2VkIGZyb20gdGhlIGZhY3RvcnkgZGVmYXVsdAoJCQluZXdEZWZhdWx0ID0gKCBrZWVwTmF0aXZlRmFjdG9yeURlZmF1bHQgPT09IGdsb2JhbFZhbHVlID8KCQkJCSIiIDogZ2xvYmFsVmFsdWUgKSwKCgkJCS8vIElmICQubW9iaWxlLmtlZXBOYXRpdmUgaGFzIG5vdCBjaGFuZ2VkLCB1c2Ugb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdAoJCQlvbGREZWZhdWx0ID0gKCBuZXdEZWZhdWx0ID09PSAiIiA/IG9wdGlvblZhbHVlIDogIiIgKTsKCgkJLy8gQ29uY2F0ZW5hdGUga2VlcE5hdGl2ZSBzZWxlY3RvcnMgZnJvbSBhbGwgc291cmNlcyB3aGVyZSB0aGUgdmFsdWUgaGFzCgkJLy8gY2hhbmdlZCBvciwgaWYgbm90aGluZyBoYXMgY2hhbmdlZCwgcmV0dXJuIHRoZSBkZWZhdWx0CgkJcmV0dXJuICggKCBrZWVwTmF0aXZlID8gWyBrZWVwTmF0aXZlIF0gOiBbXSApCgkJCS5jb25jYXQoIG5ld0RlZmF1bHQgPyBbIG5ld0RlZmF1bHQgXSA6IFtdICkKCQkJLmNvbmNhdCggb2xkRGVmYXVsdCA/IFsgb2xkRGVmYXVsdCBdIDogW10gKQoJCQkuam9pbiggIiwgIiApICk7Cgl9Cn0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS5wYWdlY29udGFpbmVyIiwgewoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6ICJhIgoJCX0sCgoJCWluaXRTZWxlY3RvcjogZmFsc2UsCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgewoJCQkJLy8gZGlzYWJsZSBhbiBzY3JvbGwgc2V0dGluZyB3aGVuIGEgaGFzaGNoYW5nZSBoYXMgYmVlbiBmaXJlZCwKCQkJCS8vIHRoaXMgb25seSB3b3JrcyBiZWNhdXNlIHRoZSByZWNvcmRpbmcgb2YgdGhlIHNjcm9sbCBwb3NpdGlvbgoJCQkJLy8gaXMgZGVsYXllZCBmb3IgMTAwbXMgYWZ0ZXIgdGhlIGJyb3dzZXIgbWlnaHQgaGF2ZSBjaGFuZ2VkIHRoZQoJCQkJLy8gcG9zaXRpb24gYmVjYXVzZSBvZiB0aGUgaGFzaGNoYW5nZQoJCQkJbmF2aWdhdGU6ICJfZGlzYWJsZVJlY29yZFNjcm9sbCIsCgoJCQkJLy8gYmluZCB0byBzY3JvbGxzdG9wIGZvciB0aGUgZmlyc3QgcGFnZSwgInBhZ2VjaGFuZ2UiIHdvbid0IGJlCgkJCQkvLyBmaXJlZCBpbiB0aGF0IGNhc2UKCQkJCXNjcm9sbHN0b3A6ICJfZGVsYXllZFJlY29yZFNjcm9sbCIKCQkJfSk7CgoJCQkvLyBUT0RPIGNvbnNpZGVyIG1vdmluZyB0aGUgbmF2aWdhdGlvbiBoYW5kbGVyIE9VVCBvZiB3aWRnZXQgaW50bwoJCQkvLyAgICAgIHNvbWUgb3RoZXIgb2JqZWN0IGFzIGdsdWUgYmV0d2VlbiB0aGUgbmF2aWdhdGUgZXZlbnQgYW5kIHRoZQoJCQkvLyAgICAgIGNvbnRlbnQgd2lkZ2V0IGxvYWQgYW5kIGNoYW5nZSBtZXRob2RzCgkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgeyBuYXZpZ2F0ZTogIl9maWx0ZXJOYXZpZ2F0ZUV2ZW50cyIgfSk7CgoJCQkvLyBUT0RPIG1vdmUgZnJvbSBwYWdlKiBldmVudHMgdG8gY29udGVudCogZXZlbnRzCgkJCXRoaXMuX29uKHsgcGFnZWNoYW5nZTogIl9hZnRlckNvbnRlbnRDaGFuZ2UiIH0pOwoKCQkJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJCQl0aGlzLndpbmRvdy5vbmUoICJuYXZpZ2F0ZSIsICQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgJiYgb3B0aW9ucy50aGVtZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyBvcHRpb25zLnRoZW1lICk7CgkJCX0gZWxzZSBpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJCX0sCgoJCV9kaXNhYmxlUmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJCX0sCgoJCV9lbmFibGVSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCQl9LAoKCQkvLyBUT0RPIGNvbnNpZGVyIHRoZSBuYW1lIGhlcmUsIHNpbmNlIGl0J3MgcHVycG9zZSBzcGVjaWZpYwoJCV9hZnRlckNvbnRlbnRDaGFuZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBvbmNlIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLCByZS1lbmFibGUgdGhlIHNjcm9sbCByZWNvcmRpbmcKCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgoJCQkvLyByZW1vdmUgYW55IGJpbmRpbmcgdGhhdCBwcmV2aW91c2x5IGV4aXN0ZWQgb24gdGhlIGdldCBzY3JvbGwKCQkJLy8gd2hpY2ggbWF5IG9yIG1heSBub3QgYmUgZGlmZmVyZW50IHRoYW4gdGhlIHNjcm9sbCBlbGVtZW50CgkJCS8vIGRldGVybWluZWQgZm9yIHRoaXMgcGFnZSBwcmV2aW91c2x5CgkJCXRoaXMuX29mZiggdGhpcy53aW5kb3csICJzY3JvbGxzdG9wIiApOwoKCQkJLy8gZGV0ZXJtaW5lIGFuZCBiaW5kIHRvIHRoZSBjdXJyZW50IHNjb2xsIGVsZW1lbnQgd2hpY2ggbWF5IGJlIHRoZQoJCQkvLyB3aW5kb3cgb3IgaW4gdGhlIGNhc2Ugb2YgdG91Y2ggb3ZlcmZsb3cgdGhlIGVsZW1lbnQgdG91Y2ggb3ZlcmZsb3cKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7IHNjcm9sbHN0b3A6ICJfZGVsYXllZFJlY29yZFNjcm9sbCIgfSk7CgkJfSwKCgkJX3JlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCS8vIHRoaXMgYmFycmllciBwcmV2ZW50cyBzZXR0aW5nIHRoZSBzY3JvbGwgdmFsdWUgYmFzZWQgb24KCQkJLy8gdGhlIGJyb3dzZXIgc2Nyb2xsaW5nIHRoZSB3aW5kb3cgYmFzZWQgb24gYSBoYXNoY2hhbmdlCgkJCWlmICggIXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBhY3RpdmUgPSB0aGlzLl9nZXRBY3RpdmVIaXN0b3J5KCksCgkJCQljdXJyZW50U2Nyb2xsLCBtaW5TY3JvbGwsIGRlZmF1bHRTY3JvbGw7CgoJCQlpZiAoIGFjdGl2ZSApIHsKCQkJCWN1cnJlbnRTY3JvbGwgPSB0aGlzLl9nZXRTY3JvbGwoKTsKCQkJCW1pblNjcm9sbCA9IHRoaXMuX2dldE1pblNjcm9sbCgpOwoJCQkJZGVmYXVsdFNjcm9sbCA9IHRoaXMuX2dldERlZmF1bHRTY3JvbGwoKTsKCgkJCQkvLyBTZXQgYWN0aXZlIHBhZ2UncyBsYXN0U2Nyb2xsIHByb3AuIElmIHRoZSBsb2NhdGlvbiB3ZSdyZQoJCQkJLy8gc2Nyb2xsaW5nIHRvIGlzIGxlc3MgdGhhbiBtaW5TY3JvbGxCYWNrLCBsZXQgaXQgZ28uCgkJCQlhY3RpdmUubGFzdFNjcm9sbCA9IGN1cnJlbnRTY3JvbGwgPCBtaW5TY3JvbGwgPyBkZWZhdWx0U2Nyb2xsIDogY3VycmVudFNjcm9sbDsKCQkJfQoJCX0sCgoJCV9kZWxheWVkUmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJc2V0VGltZW91dCggJC5wcm94eSh0aGlzLCAiX3JlY29yZFNjcm9sbCIpLCAxMDAgKTsKCQl9LAoKCQlfZ2V0U2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMud2luZG93LnNjcm9sbFRvcCgpOwoJCX0sCgoJCV9nZXRNaW5TY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubWluU2Nyb2xsQmFjazsKCQl9LAoKCQlfZ2V0RGVmYXVsdFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQl9LAoKCQlfZmlsdGVyTmF2aWdhdGVFdmVudHM6IGZ1bmN0aW9uKCBlLCBkYXRhICkgewoJCQl2YXIgdXJsOwoKCQkJaWYgKCBlLm9yaWdpbmFsRXZlbnQgJiYgZS5vcmlnaW5hbEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl1cmwgPSBlLm9yaWdpbmFsRXZlbnQudHlwZS5pbmRleE9mKCAiaGFzaGNoYW5nZSIgKSA+IC0xID8gZGF0YS5zdGF0ZS5oYXNoIDogZGF0YS5zdGF0ZS51cmw7CgoJCQlpZiAoICF1cmwgKSB7CgkJCQl1cmwgPSB0aGlzLl9nZXRIYXNoKCk7CgkJCX0KCgkJCWlmICggIXVybCB8fCB1cmwgPT09ICIjIiB8fCB1cmwuaW5kZXhPZiggIiMiICsgJC5tb2JpbGUucGF0aC51aVN0YXRlS2V5ICkgPT09IDAgKSB7CgkJCQl1cmwgPSBsb2NhdGlvbi5ocmVmOwoJCQl9CgoJCQl0aGlzLl9oYW5kbGVOYXZpZ2F0ZSggdXJsLCBkYXRhLnN0YXRlICk7CgkJfSwKCgkJX2dldEhhc2g6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQl9LAoKCQkvLyBUT0RPIGFjdGl2ZSBwYWdlIHNob3VsZCBiZSBtYW5hZ2VkIGJ5IHRoZSBjb250YWluZXIgKGllLCBpdCBzaG91bGQgYmUgYSBwcm9wZXJ0eSkKCQlnZXRBY3RpdmVQYWdlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuYWN0aXZlUGFnZTsKCQl9LAoKCQkvLyBUT0RPIHRoZSBmaXJzdCBwYWdlIHNob3VsZCBiZSBhIHByb3BlcnR5IHNldCBkdXJpbmcgX2NyZWF0ZSB1c2luZyB0aGUgbG9naWMKCQkvLyAgICAgIHRoYXQgY3VycmVudGx5IHJlc2lkZXMgaW4gaW5pdAoJCV9nZXRJbml0aWFsQ29udGVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJfSwKCgkJLy8gVE9ETyBlYWNoIGNvbnRlbnQgY29udGFpbmVyIHNob3VsZCBoYXZlIGEgaGlzdG9yeSBvYmplY3QKCQlfZ2V0SGlzdG9yeTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoJCX0sCgoJCS8vIFRPRE8gdXNlIF9nZXRIaXN0b3J5CgkJX2dldEFjdGl2ZUhpc3Rvcnk6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKTsKCQl9LAoKCQkvLyBUT0RPIHRoZSBkb2N1bWVudCBiYXNlIHNob3VsZCBiZSBkZXRlcm1pbmVkIGF0IGNyZWF0aW9uCgkJX2dldERvY3VtZW50QmFzZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZTsKCQl9LAoKCQliYWNrOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5nbyggLTEgKTsKCQl9LAoKCQlmb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5nbyggMSApOwoJCX0sCgoJCWdvOiBmdW5jdGlvbiggc3RlcHMgKSB7CgoJCQkvL2lmIGhhc2hsaXN0ZW5pbmcgaXMgZW5hYmxlZCB1c2UgbmF0aXZlIGhpc3RvcnkgbWV0aG9kCgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQl3aW5kb3cuaGlzdG9yeS5nbyggc3RlcHMgKTsKCQkJfSBlbHNlIHsKCgkJCQkvL3dlIGFyZSBub3QgbGlzdGVuaW5nIHRvIHRoZSBoYXNoIHNvIGhhbmRsZSBoaXN0b3J5IGludGVybmFsbHkKCQkJCXZhciBhY3RpdmVJbmRleCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWN0aXZlSW5kZXgsCgkJCQkJaW5kZXggPSBhY3RpdmVJbmRleCArIHBhcnNlSW50KCBzdGVwcywgMTAgKSwKCQkJCQl1cmwgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnN0YWNrWyBpbmRleCBdLnVybCwKCQkJCQlkaXJlY3Rpb24gPSAoIHN0ZXBzID49IDEgKT8gImZvcndhcmQiIDogImJhY2siOwoKCQkJCS8vdXBkYXRlIHRoZSBoaXN0b3J5IG9iamVjdAoJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9IGluZGV4OwoJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5wcmV2aW91c0luZGV4ID0gYWN0aXZlSW5kZXg7CgoJCQkJLy9jaGFuZ2UgdG8gdGhlIG5ldyBwYWdlCgkJCQl0aGlzLmNoYW5nZSggdXJsLCB7IGRpcmVjdGlvbjogZGlyZWN0aW9uLCBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJfSwKCgkJLy8gVE9ETyByZW5hbWUgX2hhbmRsZURlc3RpbmF0aW9uCgkJX2hhbmRsZURlc3RpbmF0aW9uOiBmdW5jdGlvbiggdG8gKSB7CgkJCXZhciBoaXN0b3J5OwoKCQkJLy8gY2xlYW4gdGhlIGhhc2ggZm9yIGNvbXBhcmlzb24gaWYgaXQncyBhIHVybAoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJdG8gPSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggdG8gKTsKCQkJfQoKCQkJaWYgKCB0byApIHsKCQkJCWhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCk7CgoJCQkJLy8gQXQgdGhpcyBwb2ludCwgJ3RvJyBjYW4gYmUgb25lIG9mIDMgdGhpbmdzLCBhIGNhY2hlZCBwYWdlCgkJCQkvLyBlbGVtZW50IGZyb20gYSBoaXN0b3J5IHN0YWNrIGVudHJ5LCBhbiBpZCwgb3Igc2l0ZS1yZWxhdGl2ZSAvCgkJCQkvLyBhYnNvbHV0ZSBVUkwuIElmICd0bycgaXMgYW4gaWQsIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBhZ2FpbnN0CgkJCQkvLyB0aGUgZG9jdW1lbnRCYXNlLCBub3QgdGhlIGxvY2F0aW9uLmhyZWYsIHNpbmNlIHRoZSBoYXNoY2hhbmdlCgkJCQkvLyBjb3VsZCd2ZSBiZWVuIHRoZSByZXN1bHQgb2YgYSBmb3J3YXJkL2JhY2t3YXJkIG5hdmlnYXRpb24KCQkJCS8vIHRoYXQgY3Jvc3NlcyBmcm9tIGFuIGV4dGVybmFsIHBhZ2UvZGlhbG9nIHRvIGFuIGludGVybmFsCgkJCQkvLyBwYWdlL2RpYWxvZy4KCQkJCS8vCgkJCQkvLyBUT0RPIG1vdmUgY2hlY2sgdG8gaGlzdG9yeSBvYmplY3Qgb3IgcGF0aCBvYmplY3Q/CgkJCQl0byA9ICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggdG8gKSA/ICggJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIHRvLCB0aGlzLl9nZXREb2N1bWVudEJhc2UoKSApICkgOiB0bzsKCgkJCQkvLyBJZiB3ZSdyZSBhYm91dCB0byBnbyB0byBhbiBpbml0aWFsIFVSTCB0aGF0IGNvbnRhaW5zIGEKCQkJCS8vIHJlZmVyZW5jZSB0byBhIG5vbi1leGlzdGVudCBpbnRlcm5hbCBwYWdlLCBnbyB0byB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgaW5zdGVhZC4gV2Uga25vdyB0aGF0IHRoZSBpbml0aWFsIGhhc2ggcmVmZXJzIHRvIGEKCQkJCS8vIG5vbi1leGlzdGVudCBwYWdlLCBiZWNhdXNlIHRoZSBpbml0aWFsIGhhc2ggZGlkIG5vdCBlbmQKCQkJCS8vIHVwIGluIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdD8KCQkJCWlmICggdG8gPT09ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBoaXN0b3J5LmluaXRpYWxEc3QsIHRoaXMuX2dldERvY3VtZW50QmFzZSgpICkgJiYKCQkJCQloaXN0b3J5LnN0YWNrLmxlbmd0aCAmJgoJCQkJCWhpc3Rvcnkuc3RhY2tbMF0udXJsICE9PSBoaXN0b3J5LmluaXRpYWxEc3QucmVwbGFjZSggJC5tb2JpbGUuZGlhbG9nSGFzaEtleSwgIiIgKSApIHsKCQkJCQl0byA9IHRoaXMuX2dldEluaXRpYWxDb250ZW50KCk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRvIHx8IHRoaXMuX2dldEluaXRpYWxDb250ZW50KCk7CgkJfSwKCgkJX2hhbmRsZURpYWxvZzogZnVuY3Rpb24oIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhICkgewoJCQl2YXIgdG8sIGFjdGl2ZSwgYWN0aXZlQ29udGVudCA9IHRoaXMuZ2V0QWN0aXZlUGFnZSgpOwoKCQkJLy8gSWYgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBub3QgYSBkaWFsb2cgc2tpcCB0aGUgZGlhbG9nIGFuZCBjb250aW51ZQoJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJaWYgKCBhY3RpdmVDb250ZW50ICYmICFhY3RpdmVDb250ZW50Lmhhc0NsYXNzKCAidWktZGlhbG9nIiApICkgewoJCQkJLy8gZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUKCQkJCS8vIGFjY29yZGluZ2x5IHBhc3QgdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQlpZiAoIGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIgKSB7CgkJCQkJdGhpcy5iYWNrKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZm9yd2FyZCgpOwoJCQkJfQoKCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJLy8gdG8gYSBkaWFsb2cgdXNlIHRoZSBkaWFsb2cgb2JqZWN0ZWQgc2F2ZWQgaW4gdGhlIHN0YWNrCgkJCQl0byA9IGRhdGEucGFnZVVybDsKCQkJCWFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKTsKCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJLy8gYXMgbW9zdCBvZiB0aGlzIGlzIGxvc3QgYnkgdGhlIGRvbUNhY2hlIGNsZWFuaW5nCgkJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIHsKCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQl0cmFuc2l0aW9uOiBhY3RpdmUudHJhbnNpdGlvbiwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9KTsKCQkJfQoKCQkJcmV0dXJuIHRvOwoJCX0sCgoJCV9oYW5kbGVOYXZpZ2F0ZTogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJLy9maW5kIGZpcnN0IHBhZ2UgdmlhIGhhc2gKCQkJLy8gVE9ETyBzdHJpcHBpbmcgdGhlIGhhc2ggdHdpY2Ugd2l0aCBoYW5kbGVVcmwKCQkJdmFyIHRvID0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIHVybCApLCBoaXN0b3J5ID0gdGhpcy5fZ2V0SGlzdG9yeSgpLAoKCQkJCS8vIHRyYW5zaXRpb24gaXMgZmFsc2UgaWYgaXQncyB0aGUgZmlyc3QgcGFnZSwgdW5kZWZpbmVkCgkJCQkvLyBvdGhlcndpc2UgKGFuZCBtYXkgYmUgb3ZlcnJpZGRlbiBieSBkZWZhdWx0KQoJCQkJdHJhbnNpdGlvbiA9IGhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAwID8gIm5vbmUiIDogdW5kZWZpbmVkLAoKCQkJCS8vIGRlZmF1bHQgb3B0aW9ucyBmb3IgdGhlIGNoYW5nUGFnZSBjYWxscyBtYWRlIGFmdGVyIGV4YW1pbmluZwoJCQkJLy8gdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIHBhZ2UgYW5kIHRoZSBoYXNoLCBOT1RFIHRoYXQgdGhlCgkJCQkvLyB0cmFuc2l0aW9uIGlzIGRlcml2ZWQgZnJvbSB0aGUgcHJldmlvdXMgaGlzdG9yeSBlbnRyeQoJCQkJY2hhbmdlUGFnZU9wdGlvbnMgPSB7CgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUsCgkJCQkJcmV2ZXJzZTogZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIgoJCQkJfTsKCgkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgZGF0YSwgewoJCQkJdHJhbnNpdGlvbjogKCBoaXN0b3J5LmdldExhc3QoKSB8fCB7fSApLnRyYW5zaXRpb24gfHwgdHJhbnNpdGlvbgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSB0byBfaGFuZGxlRGVzdGluYXRpb24gPwoJCQkvLyBJZiB0aGlzIGlzbid0IHRoZSBmaXJzdCBwYWdlLCBpZiB0aGUgY3VycmVudCB1cmwgaXMgYSBkaWFsb2cgaGFzaAoJCQkvLyBrZXksIGFuZCB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbiBpc24ndCBlcXVhbCB0byB0aGUgY3VycmVudCB0YXJnZXQKCQkJLy8gcGFnZSwgdXNlIHRoZSBzcGVjaWFsIGRpYWxvZyBoYW5kbGluZwoJCQlpZiAoIGhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICYmCgkJCQl0by5pbmRleE9mKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJaGlzdG9yeS5pbml0aWFsRHN0ICE9PSB0byApIHsKCgkJCQl0byA9IHRoaXMuX2hhbmRsZURpYWxvZyggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKTsKCgkJCQlpZiAoIHRvID09PSBmYWxzZSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCXRoaXMuX2NoYW5nZUNvbnRlbnQoIHRoaXMuX2hhbmRsZURlc3RpbmF0aW9uKCB0byApLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCX0sCgoJCV9jaGFuZ2VDb250ZW50OiBmdW5jdGlvbiggdG8sIG9wdHMgKSB7CgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHRvLCBvcHRzICk7CgkJfSwKCgkJX2dldEJhc2U6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuYmFzZTsKCQl9LAoKCQlfZ2V0TnM6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubnM7CgkJfSwKCgkJX2VuaGFuY2U6IGZ1bmN0aW9uKCBjb250ZW50LCByb2xlICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIHN1cHBvcnRpbmcgYSBjdXN0b20gY2FsbGJhY2ssIGFuZCBwYXNzaW5nIGluCgkJCS8vIHRoZSBzZXR0aW5ncyB3aGljaCBpbmNsdWRlcyB0aGUgcm9sZQoJCQlyZXR1cm4gY29udGVudC5wYWdlKHsgcm9sZTogcm9sZSB9KTsKCQl9LAoKCQlfaW5jbHVkZTogZnVuY3Rpb24oIHBhZ2UsIHNldHRpbmdzICkgewoJCQkvLyBhcHBlbmQgdG8gcGFnZSBhbmQgZW5oYW5jZQoJCQlwYWdlLmFwcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCgkJCS8vIHVzZSB0aGUgcGFnZSB3aWRnZXQgdG8gZW5oYW5jZQoJCQl0aGlzLl9lbmhhbmNlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCQkvLyByZW1vdmUgcGFnZSBvbiBoaWRlCgkJCXBhZ2UucGFnZSggImJpbmRSZW1vdmUiICk7CgkJfSwKCgkJX2ZpbmQ6IGZ1bmN0aW9uKCBhYnNVcmwgKSB7CgkJCS8vIFRPRE8gY29uc2lkZXIgc3VwcG9ydGluZyBhIGN1c3RvbSBjYWxsYmFjawoJCQl2YXIgZmlsZVVybCA9IHRoaXMuX2NyZWF0ZUZpbGVVcmwoIGFic1VybCApLAoJCQkJZGF0YVVybCA9IHRoaXMuX2NyZWF0ZURhdGFVcmwoIGFic1VybCApLAoJCQkJcGFnZSwgaW5pdGlhbENvbnRlbnQgPSB0aGlzLl9nZXRJbml0aWFsQ29udGVudCgpOwoKCQkJLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBwYWdlIGFscmVhZHkgZXhpc3RzIGluIHRoZSBET00uCgkJCS8vIE5PVEUgZG8gX25vdF8gdXNlIHRoZSA6anFtRGF0YSBwc2V1ZG8gc2VsZWN0b3IgYmVjYXVzZSBwYXJlbnRoZXNpcwoJCQkvLyAgICAgIGFyZSBhIHZhbGlkIHVybCBjaGFyIGFuZCBpdCBicmVha3Mgb24gdGhlIGZpcnN0IG9jY3VyZW5jZQoJCQlwYWdlID0gdGhpcy5lbGVtZW50CgkJCQkuY2hpbGRyZW4oICJbZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgoJCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCB0aGUgcGFnZSwgY2hlY2sgdG8gc2VlIGlmIHRoZSB1cmwgaXMgYQoJCQkvLyByZWZlcmVuY2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4gSWYgc28sIGl0IG1heSBoYXZlIGJlZW4gZHluYW1pY2FsbHkKCQkJLy8gaW5qZWN0ZWQgYnkgYSBkZXZlbG9wZXIsIGluIHdoaWNoIGNhc2UgaXQgd291bGQgYmUgbGFja2luZyBhCgkJCS8vIGRhdGEtdXJsIGF0dHJpYnV0ZSBhbmQgaW4gbmVlZCBvZiBlbmhhbmNlbWVudC4KCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJiBkYXRhVXJsICYmICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZGF0YVVybCApICkgewoJCQkJcGFnZSA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggJC5tb2JpbGUucGF0aC5oYXNoVG9TZWxlY3RvcigiIyIgKyBkYXRhVXJsKSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybCIsIGRhdGFVcmwgKQoJCQkJCS5qcW1EYXRhKCAidXJsIiwgZGF0YVVybCApOwoJCQl9CgoJCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCBhIHBhZ2UgaW4gdGhlIERPTSwgY2hlY2sgdGhlIFVSTCB0byBzZWUgaWYgaXQKCQkJLy8gcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBhcHBsaWNhdGlvbi4gQWxzbyBjaGVjayB0byBtYWtlIHN1cmUKCQkJLy8gb3VyIGNhY2hlZC1maXJzdC1wYWdlIGlzIGFjdHVhbGx5IGluIHRoZSBET00uIFNvbWUgdXNlciBkZXBsb3llZAoJCQkvLyBhcHBzIGFyZSBwcnVuaW5nIHRoZSBmaXJzdCBwYWdlIGZyb20gdGhlIERPTSBmb3IgdmFyaW91cyByZWFzb25zLgoJCQkvLyBXZSBjaGVjayBmb3IgdGhpcyBjYXNlIGhlcmUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGEgZmlyc3QtcGFnZSB3aXRoCgkJCS8vIGFuIGlkIGZhbGxpbmcgdGhyb3VnaCB0byB0aGUgbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UgZXJyb3IgY2FzZS4KCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0ZpcnN0UGFnZVVybCggZmlsZVVybCApICYmCgkJCQlpbml0aWFsQ29udGVudCAmJgoJCQkJaW5pdGlhbENvbnRlbnQucGFyZW50KCkubGVuZ3RoICkgewoJCQkJcGFnZSA9ICQoIGluaXRpYWxDb250ZW50ICk7CgkJCX0KCgkJCXJldHVybiBwYWdlOwoJCX0sCgoJCV9nZXRMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubG9hZGluZygpOwoJCX0sCgoJCV9zaG93TG9hZGluZzogZnVuY3Rpb24oIGRlbGF5LCB0aGVtZSwgbXNnLCB0ZXh0b25seSApIHsKCQkJLy8gVGhpcyBjb25maWd1cmFibGUgdGltZW91dCBhbGxvd3MgY2FjaGVkIHBhZ2VzIGEgYnJpZWYKCQkJLy8gZGVsYXkgdG8gbG9hZCB3aXRob3V0IHNob3dpbmcgYSBtZXNzYWdlCgkJCWlmICggdGhpcy5fbG9hZE1zZyApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdGhpcy5fbG9hZE1zZyA9IHNldFRpbWVvdXQoJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2dldExvYWRlcigpLmxvYWRlciggInNob3ciLCB0aGVtZSwgbXNnLCB0ZXh0b25seSApOwoJCQkJdGhpcy5fbG9hZE1zZyA9IDA7CgkJCX0sIHRoaXMpLCBkZWxheSApOwoJCX0sCgoJCV9oaWRlTG9hZGluZzogZnVuY3Rpb24oKSB7CgkJCS8vIFN0b3AgbWVzc2FnZSBzaG93IHRpbWVyCgkJCWNsZWFyVGltZW91dCggdGhpcy5fbG9hZE1zZyApOwoJCQl0aGlzLl9sb2FkTXNnID0gMDsKCgkJCS8vIEhpZGUgbG9hZGluZyBtZXNzYWdlCgkJCXRoaXMuX2dldExvYWRlcigpLmxvYWRlciggImhpZGUiICk7CgkJfSwKCgkJX3Nob3dFcnJvcjogZnVuY3Rpb24oKSB7CgkJCS8vIG1ha2Ugc3VyZSB0byByZW1vdmUgdGhlIGN1cnJlbnQgbG9hZGluZyBtZXNzYWdlCgkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgoJCQkvLyBzaG93IHRoZSBlcnJvciBtZXNzYWdlCgkJCXRoaXMuX3Nob3dMb2FkaW5nKCAwLCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lLCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZSwgdHJ1ZSApOwoKCQkJLy8gaGlkZSB0aGUgZXJyb3IgbWVzc2FnZSBhZnRlciBhIGRlbGF5CgkJCS8vIFRPRE8gY29uZmlndXJhdGlvbgoJCQlzZXRUaW1lb3V0KCAkLnByb3h5KHRoaXMsICJfaGlkZUxvYWRpbmciKSwgMTUwMCApOwoJCX0sCgoJCV9wYXJzZTogZnVuY3Rpb24oIGh0bWwsIGZpbGVVcmwgKSB7CgkJCS8vIFRPRE8gY29uc2lkZXIgYWxsb3dpbmcgY3VzdG9taXphdGlvbiBvZiB0aGlzIG1ldGhvZC4gSXQncyB2ZXJ5IEpRTSBzcGVjaWZpYwoJCQl2YXIgcGFnZSwgYWxsID0gJCggIjxkaXY+PC9kaXY+IiApOwoKCQkJLy93b3JrYXJvdW5kIHRvIGFsbG93IHNjcmlwdHMgdG8gZXhlY3V0ZSB3aGVuIGluY2x1ZGVkIGluIHBhZ2UgZGl2cwoJCQlhbGwuZ2V0KCAwICkuaW5uZXJIVE1MID0gaHRtbDsKCgkJCXBhZ2UgPSBhbGwuZmluZCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmlyc3QoKTsKCgkJCS8vaWYgcGFnZSBlbGVtIGNvdWxkbid0IGJlIGZvdW5kLCBjcmVhdGUgb25lIGFuZCBpbnNlcnQgdGhlIGJvZHkgZWxlbWVudCdzIGNvbnRlbnRzCgkJCWlmICggIXBhZ2UubGVuZ3RoICkgewoJCQkJcGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAicm9sZT0ncGFnZSc+IiArCgkJCQkJKCBodG1sLnNwbGl0KCAvPFwvP2JvZHlbXj5dKj4vZ21pIClbMV0gfHwgIiIgKSArCgkJCQkJIjwvZGl2PiIgKTsKCQkJfQoKCQkJLy8gVE9ETyB0YWdnaW5nIGEgcGFnZSB3aXRoIGV4dGVybmFsIHRvIG1ha2Ugc3VyZSB0aGF0IGVtYmVkZGVkIHBhZ2VzIGFyZW4ndAoJCQkvLyByZW1vdmVkIGJ5IHRoZSB2YXJpb3VzIHBhZ2UgaGFuZGxpbmcgY29kZSBpcyBiYWQuIEhhdmluZyBwYWdlIGhhbmRsaW5nIGNvZGUKCQkJLy8gaW4gbWFueSBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJcGFnZS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmwiLCAkLm1vYmlsZS5wYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoZmlsZVVybCkgKQoJCQkJLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICk7CgoJCQlyZXR1cm4gcGFnZTsKCQl9LAoKCQlfc2V0TG9hZGVkVGl0bGU6IGZ1bmN0aW9uKCBwYWdlLCBodG1sICkgewoJCQkvL3BhZ2UgdGl0bGUgcmVnZXhwCgkJCXZhciBuZXdQYWdlVGl0bGUgPSBodG1sLm1hdGNoKCAvPHRpdGxlW14+XSo+KFtePF0qKS8gKSAmJiBSZWdFeHAuJDE7CgoJCQlpZiAoIG5ld1BhZ2VUaXRsZSAmJiAhcGFnZS5qcW1EYXRhKCJ0aXRsZSIpICkgewoJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJcGFnZS5qcW1EYXRhKCAidGl0bGUiLCBuZXdQYWdlVGl0bGUgKTsKCQkJfQoJCX0sCgoJCV9pc1Jld3JpdGFibGVCYXNlVGFnOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmR5bmFtaWNCYXNlRW5hYmxlZCAmJiAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnOwoJCX0sCgoJCV9jcmVhdGVEYXRhVXJsOiBmdW5jdGlvbiggYWJzb2x1dGVVcmwgKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic29sdXRlVXJsICk7CgkJfSwKCgkJX2NyZWF0ZUZpbGVVcmw6IGZ1bmN0aW9uKCBhYnNvbHV0ZVVybCApIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoIGFic29sdXRlVXJsICk7CgkJfSwKCgkJX3RyaWdnZXJXaXRoRGVwcmVjYXRlZDogZnVuY3Rpb24oIG5hbWUsIGRhdGEsIHBhZ2UgKSB7CgkJCXZhciBkZXByZWNhdGVkRXZlbnQgPSAkLkV2ZW50KCAicGFnZSIgKyBuYW1lICksCgkJCQluZXdFdmVudCA9ICQuRXZlbnQoIHRoaXMud2lkZ2V0TmFtZSArIG5hbWUgKTsKCgkJCS8vIERFUFJFQ0FURUQKCQkJLy8gdHJpZ2dlciB0aGUgb2xkIGRlcHJlY2F0ZWQgZXZlbnQgb24gdGhlIHBhZ2UgaWYgaXQncyBwcm92aWRlZAoJCQkoIHBhZ2UgfHwgdGhpcy5lbGVtZW50ICkudHJpZ2dlciggZGVwcmVjYXRlZEV2ZW50LCBkYXRhICk7CgoJCQkvLyB1c2UgdGhlIHdpZGdldCB0cmlnZ2VyIG1ldGhvZCBmb3IgdGhlIG5ldyBjb250ZW50KiBldmVudAoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggbmV3RXZlbnQsIGRhdGEgKTsKCgkJCXJldHVybiB7CgkJCQlkZXByZWNhdGVkRXZlbnQ6IGRlcHJlY2F0ZWRFdmVudCwKCQkJCWV2ZW50OiBuZXdFdmVudAoJCQl9OwoJCX0sCgoJCS8vIFRPRE8gaXQgd291bGQgYmUgbmljZSB0byBzcGxpdCB0aGlzIHVwIG1vcmUgYnV0IGV2ZXJ5dGhpbmcgYXBwZWFycyB0byBiZSAib25lIG9mZiIKCQkvLyAgICAgIG9yIHJlcXVpcmUgb3JkZXJpbmcgc3VjaCB0aGF0IG90aGVyIGJpdHMgYXJlIHNwcmlua2xlZCBpbiBiZXR3ZWVuIHBhcnRzIHRoYXQKCQkvLyAgICAgIGNvdWxkIGJlIGFic3RyYWN0ZWQgb3V0IGFzIGEgZ3JvdXAKCQlfbG9hZFN1Y2Nlc3M6IGZ1bmN0aW9uKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSB7CgkJCXZhciBmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICksCgkJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICk7CgoJCQlyZXR1cm4gJC5wcm94eShmdW5jdGlvbiggaHRtbCwgdGV4dFN0YXR1cywgeGhyICkgewoJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCS8vdXNlIGl0IGFzIHRoZSBuZXcgZmlsZVVybCwgYmFzZSBwYXRoLCBldGMKCQkJCXZhciBjb250ZW50LAoKCQkJCQkvLyBUT0RPIGhhbmRsZSBkaWFsb2dzIGFnYWluCgkJCQkJcGFnZUVsZW1SZWdleCA9IG5ldyBSZWdFeHAoICIoPFtePl0rXFxiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoKCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmw9W1wiJ10/KFteXCInPl0qKVtcIiddPyIgKTsKCgkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMKCQkJCS8vIGNhbiBiZSBkaXJlY3RlZCB0byB0aGUgY29ycmVjdCB1cmwuIGxvYWRpbmcgaW50byBhIHRlbXByb3JhcnkKCQkJCS8vIGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCWlmICggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkgJiYKCQkJCQlSZWdFeHAuJDEgJiYKCQkJCQlkYXRhVXJsUmVnZXgudGVzdCggUmVnRXhwLiQxICkgJiYKCQkJCQlSZWdFeHAuJDEgKSB7CgkJCQkJZmlsZVVybCA9ICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoICQoIjxkaXY+IiArIFJlZ0V4cC4kMSArICI8L2Rpdj4iKS50ZXh0KCkgKTsKCQkJCX0KCgkJCQkvL2RvbnQgdXBkYXRlIHRoZSBiYXNlIHRhZyBpZiB3ZSBhcmUgcHJlZmV0Y2hpbmcKCQkJCWlmICggc2V0dGluZ3MucHJlZmV0Y2ggPT09IHVuZGVmaW5lZCApIHsKCQkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCBmaWxlVXJsICk7CgkJCQl9CgoJCQkJY29udGVudCA9IHRoaXMuX3BhcnNlKCBodG1sLCBmaWxlVXJsICk7CgoJCQkJdGhpcy5fc2V0TG9hZGVkVGl0bGUoIGNvbnRlbnQsIGh0bWwgKTsKCgkJCQkvLyBBZGQgdGhlIGNvbnRlbnQgcmVmZXJlbmNlIGFuZCB4aHIgdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgoJCQkJLy8gREVQUkVDQVRFRAoJCQkJdHJpZ2dlckRhdGEucGFnZSA9IGNvbnRlbnQ7CgoJCQkJdHJpZ2dlckRhdGEuY29udGVudCA9IGNvbnRlbnQ7CgoJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkvLyBOb3RlIHRoYXQgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBsaXN0ZW5lci9oYW5kbGVyCgkJCQkvLyB0aGF0IGNhbGxlZCBwcmV2ZW50RGVmYXVsdCgpLCB0byByZXNvbHZlL3JlamVjdCB0aGUKCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJaWYgKCAhdGhpcy5fdHJpZ2dlciggImxvYWQiLCB1bmRlZmluZWQsIHRyaWdnZXJEYXRhICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIHJld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsIGlmIHRoZSBiYXNlIHRhZyB3b24ndCB3b3JrCgkJCQlpZiAoIHRoaXMuX2lzUmV3cml0YWJsZUJhc2VUYWcoKSAmJiBjb250ZW50ICkgewoJCQkJCXRoaXMuX2dldEJhc2UoKS5yZXdyaXRlKCBmaWxlVXJsLCBjb250ZW50ICk7CgkJCQl9CgoJCQkJdGhpcy5faW5jbHVkZSggY29udGVudCwgc2V0dGluZ3MgKTsKCgkJCQkvLyBFbmhhbmNpbmcgdGhlIGNvbnRlbnQgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgY29udGVudCBiZWluZyBpbnNlcnRlZAoJCQkJLy8gaW50byB0aGUgRE9NLiBJZiB0aGUgb3JpZ2luYWwgYWJzVXJsIHJlZmVycyB0byBhIHN1Yi1jb250ZW50LCB0aGF0IGlzIHRoZQoJCQkJLy8gcmVhbCBjb250ZW50IHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJaWYgKCBhYnNVcmwuaW5kZXhPZiggIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSApID4gLTEgKSB7CgkJCQkJY29udGVudCA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggIltkYXRhLSIgKyB0aGlzLl9nZXROcygpICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCQkJCX0KCgkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoJCQkJfQoKCQkJCS8vIEJFR0lOIERFUFJFQ0FURUQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIGNvbnRlbnQgbG9hZGVkIHN1Y2Nlc3NmdWxseS4KCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAicGFnZWxvYWQiICk7CgkJCQkvLyBFTkQgREVQUkVDQVRFRCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgc2V0dGluZ3MsIGNvbnRlbnQgKTsKCQkJfSwgdGhpcyk7CgkJfSwKCgkJX2xvYWREZWZhdWx0czogewoJCQl0eXBlOiAiZ2V0IiwKCQkJZGF0YTogdW5kZWZpbmVkLAoKCQkJLy8gREVQUkVDQVRFRAoJCQlyZWxvYWRQYWdlOiBmYWxzZSwKCgkJCXJlbG9hZDogZmFsc2UsCgoJCQkvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJCXJvbGU6IHVuZGVmaW5lZCwKCgkJCXNob3dMb2FkTXNnOiBmYWxzZSwKCgkJCS8vIFRoaXMgZGVsYXkgYWxsb3dzIGxvYWRzIHRoYXQgcHVsbCBmcm9tIGJyb3dzZXIgY2FjaGUgdG8KCQkJLy8gb2NjdXIgd2l0aG91dCBzaG93aW5nIHRoZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCWxvYWRNc2dEZWxheTogNTAKCQl9LAoKCQlsb2FkOiBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCQkvLyBUaGlzIGZ1bmN0aW9uIHVzZXMgZGVmZXJyZWQgbm90aWZpY2F0aW9ucyB0byBsZXQgY2FsbGVycwoJCQkvLyBrbm93IHdoZW4gdGhlIGNvbnRlbnQgaXMgZG9uZSBsb2FkaW5nLCBvciBpZiBhbiBlcnJvciBoYXMgb2NjdXJyZWQuCgkJCXZhciBkZWZlcnJlZCA9ICggb3B0aW9ucyAmJiBvcHRpb25zLmRlZmVycmVkICkgfHwgJC5EZWZlcnJlZCgpLAoKCQkJCS8vIFRoZSBkZWZhdWx0IGxvYWQgb3B0aW9ucyB3aXRoIG92ZXJyaWRlcyBzcGVjaWZpZWQgYnkgdGhlIGNhbGxlci4KCQkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCB0aGlzLl9sb2FkRGVmYXVsdHMsIG9wdGlvbnMgKSwKCgkJCQkvLyBUaGUgRE9NIGVsZW1lbnQgZm9yIHRoZSBjb250ZW50IGFmdGVyIGl0IGhhcyBiZWVuIGxvYWRlZC4KCQkJCWNvbnRlbnQgPSBudWxsLAoKCQkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgcGFzc2VkIGludG8gdGhlIGZ1bmN0aW9uLiBUaGlzCgkJCQkvLyB2ZXJzaW9uIG9mIHRoZSBVUkwgbWF5IGNvbnRhaW4gZGlhbG9nL3N1YmNvbnRlbnQgcGFyYW1zIGluIGl0LgoJCQkJYWJzVXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgdGhpcy5fZmluZEJhc2VXaXRoRGVmYXVsdCgpICksCgkJCQlmaWxlVXJsLCBkYXRhVXJsLCBwYmxFdmVudCwgdHJpZ2dlckRhdGE7CgoJCQkvLyBERVBSRUNBVEVEIHJlbG9hZFBhZ2UKCQkJc2V0dGluZ3MucmVsb2FkID0gc2V0dGluZ3MucmVsb2FkUGFnZTsKCgkJCS8vIElmIHRoZSBjYWxsZXIgcHJvdmlkZWQgZGF0YSwgYW5kIHdlJ3JlIHVzaW5nICJnZXQiIHJlcXVlc3QsCgkJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gImdldCIgKSB7CgkJCQlhYnNVcmwgPSAkLm1vYmlsZS5wYXRoLmFkZFNlYXJjaFBhcmFtcyggYWJzVXJsLCBzZXR0aW5ncy5kYXRhICk7CgkJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCQl9CgoJCQkvLyBJZiB0aGUgY2FsbGVyIGlzIHVzaW5nIGEgInBvc3QiIHJlcXVlc3QsIHJlbG9hZCBtdXN0IGJlIHRydWUKCQkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJwb3N0IiApIHsKCQkJCXNldHRpbmdzLnJlbG9hZCA9IHRydWU7CgkJCX0KCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJjb250ZW50IHBhcmFtcy4KCQkJLy8gSW4gb3RoZXJ3b3JkcyB0aGUgcmVhbCBVUkwgb2YgdGhlIGNvbnRlbnQgdG8gYmUgbG9hZGVkLgoJCQlmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICk7CgoJCQkvLyBUaGUgdmVyc2lvbiBvZiB0aGUgVXJsIGFjdHVhbGx5IHN0b3JlZCBpbiB0aGUgZGF0YS11cmwgYXR0cmlidXRlIG9mCgkJCS8vIHRoZSBjb250ZW50LiBGb3IgZW1iZWRkZWQgY29udGVudCwgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvcgoJCQkvLyBjb250ZW50IHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlCgkJCS8vIHJlbGF0aXZlIHBhdGguIEZvciBjcm9zcy1kb21haW4gY29udGVudCAoUGhvbmUgR2FwIG9ubHkpIHRoZSBlbnRpcmUKCQkJLy8gYWJzb2x1dGUgVXJsIGlzIHVzZWQgdG8gbG9hZCB0aGUgY29udGVudC4KCQkJZGF0YVVybCA9IHRoaXMuX2NyZWF0ZURhdGFVcmwoIGFic1VybCApOwoKCQkJY29udGVudCA9IHRoaXMuX2ZpbmQoIGFic1VybCApOwoKCQkJLy8gSWYgaXQgaXNuJ3QgYSByZWZlcmVuY2UgdG8gdGhlIGZpcnN0IGNvbnRlbnQgYW5kIHJlZmVycyB0byBtaXNzaW5nCgkJCS8vIGVtYmVkZGVkIGNvbnRlbnQgcmVqZWN0IHRoZSBkZWZlcnJlZCBhbmQgcmV0dXJuCgkJCWlmICggY29udGVudC5sZW5ndGggPT09IDAgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNFbWJlZGRlZFBhZ2UoZmlsZVVybCkgJiYKCQkJCSEkLm1vYmlsZS5wYXRoLmlzRmlyc3RQYWdlVXJsKGZpbGVVcmwpICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIHNldHRpbmdzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZQoJCQkvLyBUT0RPIGZpZ3VyZSBvdXQgd2h5IHdlIGRvZSB0aGlzCgkJCXRoaXMuX2dldEJhc2UoKS5yZXNldCgpOwoKCQkJLy8gSWYgdGhlIGNvbnRlbnQgd2UgYXJlIGludGVyZXN0ZWQgaW4gaXMgYWxyZWFkeSBpbiB0aGUgRE9NLAoJCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkJLy8gcmVsb2FkIG9mIHRoZSBmaWxlLCB3ZSBhcmUgZG9uZS4gUmVzb2x2ZSB0aGUgZGVmZXJycmVkIHNvIHRoYXQKCQkJLy8gdXNlcnMgY2FuIGJpbmQgdG8gLmRvbmUgb24gdGhlIHByb21pc2UKCQkJaWYgKCBjb250ZW50Lmxlbmd0aCAmJiAhc2V0dGluZ3MucmVsb2FkICkgewoJCQkJdGhpcy5fZW5oYW5jZSggY29udGVudCwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBzZXR0aW5ncywgY29udGVudCApOwoKCQkJCS8vaWYgd2UgYXJlIHJlbG9hZGluZyB0aGUgY29udGVudCBtYWtlIHN1cmUgd2UgdXBkYXRlCgkJCQkvLyB0aGUgYmFzZSBpZiBpdHMgbm90IGEgcHJlZmV0Y2gKCQkJCWlmICggIXNldHRpbmdzLnByZWZldGNoICkgewoJCQkJCXRoaXMuX2dldEJhc2UoKS5zZXQodXJsKTsKCQkJCX0KCgkJCQlyZXR1cm47CgkJCX0KCgkJCXRyaWdnZXJEYXRhID0gewoJCQkJdXJsOiB1cmwsCgkJCQlhYnNVcmw6IGFic1VybCwKCQkJCWRhdGFVcmw6IGRhdGFVcmwsCgkJCQlkZWZlcnJlZDogZGVmZXJyZWQsCgkJCQlvcHRpb25zOiBzZXR0aW5ncwoJCQl9OwoKCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGxvYWQgY29udGVudC4KCQkJcGJsRXZlbnQgPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJiZWZvcmVsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQlpZiAoIHBibEV2ZW50LmRlcHJlY2F0ZWRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAoJCQkJcGJsRXZlbnQuZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQl0aGlzLl9zaG93TG9hZGluZyggc2V0dGluZ3MubG9hZE1zZ0RlbGF5ICk7CgkJCX0KCgkJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQkJLy8gb25seSByZXNldCBpZiB3ZSBhcmUgbm90IHByZWZldGNoaW5nCgkJCWlmICggc2V0dGluZ3MucHJlZmV0Y2ggPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX2dldEJhc2UoKS5yZXNldCgpOwoJCQl9CgoJCQlpZiAoICEoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyB8fAoJCQkJJC5tb2JpbGUucGF0aC5pc1NhbWVEb21haW4oJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBMb2FkIHRoZSBuZXcgY29udGVudC4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJY29udGVudFR5cGU6IHNldHRpbmdzLmNvbnRlbnRUeXBlLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IHRoaXMuX2xvYWRTdWNjZXNzKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSwKCQkJCWVycm9yOiB0aGlzLl9sb2FkRXJyb3IoIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApCgkJCX0pOwoJCX0sCgoJCV9sb2FkRXJyb3I6IGZ1bmN0aW9uKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSB7CgkJCXJldHVybiAkLnByb3h5KGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJLy9zZXQgYmFzZSBiYWNrIHRvIGN1cnJlbnQgcGF0aAoJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCggJC5tb2JpbGUucGF0aC5nZXQoKSApOwoKCQkJCS8vIEFkZCBlcnJvciBpbmZvIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJdHJpZ2dlckRhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKCgkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQl2YXIgcGxmRXZlbnQgPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJsb2FkZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQlpZiAoIHBsZkV2ZW50LmRlcHJlY2F0ZWRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAoJCQkJCXBsZkV2ZW50LmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQl0aGlzLl9zaG93RXJyb3IoKTsKCQkJCX0KCgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJfSwgdGhpcyk7CgkJfSwKCgkJX2dldFRyYW5zaXRpb25IYW5kbGVyOiBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB0cmFuc2l0aW9uICk7CgoJCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCQkvL2lzbid0IG9uZSBpbiBvdXIgdHJhbnNpdGlvbkhhbmRsZXJzIGRpY3Rpb25hcnksIHVzZSB0aGUgZGVmYXVsdCBvbmUuCgkJCS8vY2FsbCB0aGUgaGFuZGxlciBpbW1lZGlhdGVseSB0byBraWNrLW9mZiB0aGUgdHJhbnNpdGlvbi4KCQkJcmV0dXJuICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVyc1sgdHJhbnNpdGlvbiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlcjsKCQl9LAoKCQkvLyBUT0RPIG1vdmUgaW50byB0cmFuc2l0aW9uIGhhbmRsZXJzPwoJCV90cmlnZ2VyQ3NzVHJhbnNpdGlvbkV2ZW50czogZnVuY3Rpb24oIHRvLCBmcm9tLCBwcmVmaXggKSB7CgkJCXZhciBzYW1lUGFnZSA9IGZhbHNlOwoKCQkJcHJlZml4ID0gcHJlZml4IHx8ICIiOwoKCQkJLy8gVE9ETyBkZWNpZGUgaWYgdGhlc2UgZXZlbnRzIHNob3VsZCBpbiBmYWN0IGJlIHRyaWdnZXJlZCBvbiB0aGUgY29udGFpbmVyCgkJCWlmICggZnJvbSApIHsKCgkJCQkvL0NoZWNrIGlmIHRoaXMgaXMgYSBzYW1lIHBhZ2UgdHJhbnNpdGlvbiBhbmQgdGVsbCB0aGUgaGFuZGxlciBpbiBwYWdlCgkJCQlpZiggdG9bMF0gPT09IGZyb21bMF0gKXsKCQkJCQlzYW1lUGFnZSA9IHRydWU7CgkJCQl9CgoJCQkJLy90cmlnZ2VyIGJlZm9yZSBzaG93L2hpZGUgZXZlbnRzCgkJCQkvLyBUT0RPIGRlcHJlY2F0ZSBuZXh0UGFnZSBpbiBmYXZvciBvZiBuZXh0CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoIHByZWZpeCArICJoaWRlIiwgeyBuZXh0UGFnZTogdG8sIHNhbWVQYWdlOiBzYW1lUGFnZSB9LCBmcm9tICk7CgkJCX0KCgkJCS8vIFRPRE8gZGVwcmVjYXRlIHByZXZQYWdlIGluIGZhdm9yIG9mIHByZXZpb3VzCgkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggcHJlZml4ICsgInNob3ciLCB7IHByZXZQYWdlOiBmcm9tIHx8ICQoICIiICkgfSwgdG8gKTsKCQl9LAoKCQkvLyBUT0RPIG1ha2UgcHJpdmF0ZSBvbmNlIGNoYW5nZSBoYXMgYmVlbiBkZWZpbmVkIGluIHRoZSB3aWRnZXQKCQlfY3NzVHJhbnNpdGlvbjogZnVuY3Rpb24oIHRvLCBmcm9tLCBvcHRpb25zICkgewoJCQl2YXIgdHJhbnNpdGlvbiA9IG9wdGlvbnMudHJhbnNpdGlvbiwKCQkJCXJldmVyc2UgPSBvcHRpb25zLnJldmVyc2UsCgkJCQlkZWZlcnJlZCA9IG9wdGlvbnMuZGVmZXJyZWQsCgkJCQlUcmFuc2l0aW9uSGFuZGxlciwKCQkJCXByb21pc2U7CgoJCQl0aGlzLl90cmlnZ2VyQ3NzVHJhbnNpdGlvbkV2ZW50cyggdG8sIGZyb20sICJiZWZvcmUiICk7CgoJCQkvLyBUT0RPIHB1dCB0aGlzIGluIGEgYmluZGluZyB0byBldmVudHMgKm91dHNpZGUqIHRoZSB3aWRnZXQKCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCgkJCVRyYW5zaXRpb25IYW5kbGVyID0gdGhpcy5fZ2V0VHJhbnNpdGlvbkhhbmRsZXIoIHRyYW5zaXRpb24gKTsKCgkJCXByb21pc2UgPSAoIG5ldyBUcmFuc2l0aW9uSGFuZGxlciggdHJhbnNpdGlvbiwgcmV2ZXJzZSwgdG8sIGZyb20gKSApLnRyYW5zaXRpb24oKTsKCgkJCS8vIFRPRE8gdGVtcG9yYXJ5IGFjY29tb2RhdGlvbiBvZiBhcmd1bWVudCBkZWZlcnJlZAoJCQlwcm9taXNlLmRvbmUoZnVuY3Rpb24oKSB7CgkJCQlkZWZlcnJlZC5yZXNvbHZlLmFwcGx5KCBkZWZlcnJlZCwgYXJndW1lbnRzICk7CgkJCX0pOwoKCQkJcHJvbWlzZS5kb25lKCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl90cmlnZ2VyQ3NzVHJhbnNpdGlvbkV2ZW50cyggdG8sIGZyb20gKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCV9yZWxlYXNlVHJhbnNpdGlvbkxvY2s6IGZ1bmN0aW9uKCkgewoJCQkvL3JlbGVhc2UgdHJhbnNpdGlvbiBsb2NrIHNvIG5hdmlnYXRpb24gaXMgZnJlZSBhZ2FpbgoJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCWlmICggcGFnZVRyYW5zaXRpb25RdWV1ZS5sZW5ndGggPiAwICkgewoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZS5hcHBseSggbnVsbCwgcGFnZVRyYW5zaXRpb25RdWV1ZS5wb3AoKSApOwoJCQl9CgkJfSwKCgkJX3JlbW92ZUFjdGl2ZUxpbmtDbGFzczogZnVuY3Rpb24oIGZvcmNlICkgewoJCQkvL2NsZWFyIG91dCB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZQoJCQkkLm1vYmlsZS5yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIGZvcmNlICk7CgkJfSwKCgkJX2xvYWRVcmw6IGZ1bmN0aW9uKCB0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQkvLyBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUKCQkJLy8gc2ltcGxpZmllZCBlZywgcmVtb3ZpbmcgdWktc3RhdGUsIGFuZCByZW1vdmluZyBxdWVyeSBwYXJhbXMKCQkJLy8gZnJvbSB0aGUgaGFzaCB0aGlzIGlzIHNvIHRoYXQgdXNlcnMgd2hvIHdhbnQgdG8gdXNlIHF1ZXJ5CgkJCS8vIHBhcmFtcyBoYXZlIGFjY2VzcyB0byB0aGVtIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UKCQkJLy8gbGlmZSBjeWNsZSBTZWUgaXNzdWUgIzUwODUKCQkJc2V0dGluZ3MudGFyZ2V0ID0gdG87CgkJCXNldHRpbmdzLmRlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCQkJdGhpcy5sb2FkKCB0bywgc2V0dGluZ3MgKTsKCgkJCXNldHRpbmdzLmRlZmVycmVkLmRvbmUoJC5wcm94eShmdW5jdGlvbiggdXJsLCBvcHRpb25zLCBjb250ZW50ICkgewoJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoKCQkJCS8vIHN0b3JlIHRoZSBvcmlnaW5hbCBhYnNvbHV0ZSB1cmwgc28gdGhhdCBpdCBjYW4gYmUgcHJvdmlkZWQKCQkJCS8vIHRvIGV2ZW50cyBpbiB0aGUgdHJpZ2dlckRhdGEgb2YgdGhlIHN1YnNlcXVlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQlvcHRpb25zLmFic1VybCA9IHRyaWdnZXJEYXRhLmFic1VybDsKCgkJCQl0aGlzLnRyYW5zaXRpb24oIGNvbnRlbnQsIHRyaWdnZXJEYXRhLCBvcHRpb25zICk7CgkJCX0sIHRoaXMpKTsKCgkJCXNldHRpbmdzLmRlZmVycmVkLmZhaWwoJC5wcm94eShmdW5jdGlvbigvKiB1cmwsIG9wdGlvbnMgKi8pIHsKCQkJCXRoaXMuX3JlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJdGhpcy5fcmVsZWFzZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3RyaWdnZXJQYWdlQmVmb3JlQ2hhbmdlOiBmdW5jdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApIHsKCQkJdmFyIHBiY0V2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlY2hhbmdlIiApOwoKCQkJJC5leHRlbmQodHJpZ2dlckRhdGEsIHsgdG9QYWdlOiB0bywgb3B0aW9uczogc2V0dGluZ3MgfSk7CgoJCQkvLyBOT1RFOiBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUKCQkJLy8gc2ltcGxpZmllZCBlZywgcmVtb3ZpbmcgdWktc3RhdGUsIGFuZCByZW1vdmluZyBxdWVyeSBwYXJhbXMgZnJvbQoJCQkvLyB0aGUgaGFzaCB0aGlzIGlzIHNvIHRoYXQgdXNlcnMgd2hvIHdhbnQgdG8gdXNlIHF1ZXJ5IHBhcmFtcyBoYXZlCgkJCS8vIGFjY2VzcyB0byB0aGVtIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UgbGlmZSBjeWNsZQoJCQkvLyBTZWUgaXNzdWUgIzUwODUKCQkJaWYgKCAkLnR5cGUodG8pID09PSAic3RyaW5nIiApIHsKCQkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBzdHJpbmcgc2ltcGx5IGNvbnZlcnQgaXQKCQkJCXRyaWdnZXJEYXRhLmFic1VybCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB0bywgdGhpcy5fZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgkJCX0gZWxzZSB7CgkJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgalF1ZXJ5IG9iamVjdCBncmFiIHRoZSBhYnNvbHV0ZSB1cmwgc3RvcmVkCgkJCQkvLyBpbiB0aGUgbG9hZFBhZ2UgY2FsbGJhY2sgd2hlcmUgaXQgZXhpc3RzCgkJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSBzZXR0aW5ncy5hYnNVcmw7CgkJCX0KCgkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZS4KCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIHBiY0V2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCWlmICggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXJldHVybiB0cnVlOwoJCX0sCgoJCWNoYW5nZTogZnVuY3Rpb24oIHRvLCBvcHRpb25zICkgewoJCQkvLyBJZiB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGEgdHJhbnNpdGlvbiwgcXVldWUgdGhlIGN1cnJlbnQgcmVxdWVzdC4KCQkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbgoJCQkvLyB0byBzZXJ2aWNlIHRoZSByZXF1ZXN0LgoJCQlpZiAoIGlzUGFnZVRyYW5zaXRpb25pbmcgKSB7CgkJCQlwYWdlVHJhbnNpdGlvblF1ZXVlLnVuc2hpZnQoIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sICQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKSwKCQkJCXRyaWdnZXJEYXRhID0ge307CgoJCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIGZyb21QYWdlLgoJCQlzZXR0aW5ncy5mcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlIHx8IHRoaXMuYWN0aXZlUGFnZTsKCgkJCS8vIGlmIHRoZSBwYWdlIGJlZm9yZWNoYW5nZSBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJaWYgKCAhdGhpcy5fdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2UodG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncykgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0byBpbgoJCQkvLyB0aGUgdHJpZ2dlciBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG8gaXMKCQkJLy8gdXBkYXRlZC4gV2UgYWxzbyBuZWVkIHRvIHJlLWV2YWx1YXRlIHdoZXRoZXIgaXQgaXMgYSBzdHJpbmcsCgkJCS8vIGJlY2F1c2UgYW4gb2JqZWN0IGNhbiBhbHNvIGJlIHJlcGxhY2VkIGJ5IGEgc3RyaW5nCgkJCXRvID0gdHJpZ2dlckRhdGEudG9QYWdlOwoKCQkJLy8gSWYgdGhlIGNhbGxlciBwYXNzZWQgdXMgYSB1cmwsIGNhbGwgbG9hZFBhZ2UoKQoJCQkvLyB0byBtYWtlIHN1cmUgaXQgaXMgbG9hZGVkIGludG8gdGhlIERPTS4gV2UnbGwgbGlzdGVuCgkJCS8vIHRvIHRoZSBwcm9taXNlIG9iamVjdCBpdCByZXR1cm5zIHNvIHdlIGtub3cgd2hlbgoJCQkvLyBpdCBpcyBkb25lIGxvYWRpbmcgb3IgaWYgYW4gZXJyb3Igb2N1cnJlZC4KCQkJaWYgKCAkLnR5cGUodG8pID09PSAic3RyaW5nIiApIHsKCQkJCS8vIFNldCB0aGUgaXNQYWdlVHJhbnNpdGlvbmluZyBmbGFnIHRvIHByZXZlbnQgYW55IHJlcXVlc3RzIGZyb20KCQkJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJCQl0aGlzLl9sb2FkVXJsKCB0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLnRyYW5zaXRpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKTsKCQkJfQoJCX0sCgoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKCB0b1BhZ2UsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApIHsKCQkJdmFyIGZyb21QYWdlLCB1cmwsIHBhZ2VVcmwsIGZpbGVVcmwsCgkJCQlhY3RpdmUsIGFjdGl2ZUlzSW5pdGlhbFBhZ2UsCgkJCQloaXN0b3J5RGlyLCBwYWdlVGl0bGUsIGlzRGlhbG9nLAoJCQkJYWxyZWFkeVRoZXJlLCBuZXdQYWdlVGl0bGUsCgkJCQlwYXJhbXMsCWNzc1RyYW5zaXRpb25EZWZlcnJlZCwKCQkJCWJlZm9yZVRyYW5zaXRpb247CgoJCQkvLyBJZiB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGEgdHJhbnNpdGlvbiwgcXVldWUgdGhlIGN1cnJlbnQgcmVxdWVzdC4KCQkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbgoJCQkvLyB0byBzZXJ2aWNlIHRoZSByZXF1ZXN0LgoJCQlpZiAoIGlzUGFnZVRyYW5zaXRpb25pbmcgKSB7CgkJCQkvLyBtYWtlIHN1cmUgdG8gb25seSBxdWV1ZSB0aGUgdG8gYW5kIHNldHRpbmdzIHZhbHVlcyBzbyB0aGUgYXJndW1lbnRzCgkJCQkvLyB3b3JrIHdpdGggYSBjYWxsIHRvIHRoZSBjaGFuZ2UgbWV0aG9kCgkJCQlwYWdlVHJhbnNpdGlvblF1ZXVlLnVuc2hpZnQoIFt0b1BhZ2UsIHNldHRpbmdzXSApOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBERVBSRUNBVEVEIC0gdGhpcyBjYWxsIG9ubHksIGluIGZhdm9yIG9mIHRoZSBiZWZvcmUgdHJhbnNpdGlvbgoJCQkvLyBpZiB0aGUgcGFnZSBiZWZvcmVjaGFuZ2UgZGVmYXVsdCBpcyBwcmV2ZW50ZWQgcmV0dXJuIGVhcmx5CgkJCWlmICggIXRoaXMuX3RyaWdnZXJQYWdlQmVmb3JlQ2hhbmdlKHRvUGFnZSwgdHJpZ2dlckRhdGEsIHNldHRpbmdzKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gaWYgdGhlIChjb250ZW50fHBhZ2UpYmVmb3JldHJhbnNpdGlvbiBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJLy8gTm90ZSwgd2UgaGF2ZSB0byBjaGVjayBmb3IgYm90aCB0aGUgZGVwcmVjYXRlZCBhbmQgbmV3IGV2ZW50cwoJCQliZWZvcmVUcmFuc2l0aW9uID0gdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiYmVmb3JldHJhbnNpdGlvbiIsIHRyaWdnZXJEYXRhICk7CgkJCWlmIChiZWZvcmVUcmFuc2l0aW9uLmRlcHJlY2F0ZWRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAoJCQkJYmVmb3JlVHJhbnNpdGlvbi5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCQkvLyBlbnRlcmluZyB0aGlzIG1ldGhvZCB3aGlsZSB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGxvYWRpbmcgYSBwYWdlCgkJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkJLy8gSWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBmaXJzdC1wYWdlIG9mIHRoZSBhcHBsaWNhdGlvbiwgd2UgbmVlZCB0byBtYWtlCgkJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkJLy8gdXMgdG8gYXZvaWQgZ2VuZXJhdGluZyBhIGRvY3VtZW50IHVybCB3aXRoIGFuIGlkIGhhc2ggaW4gdGhlIGNhc2Ugd2hlcmUgdGhlCgkJCS8vIGZpcnN0LXBhZ2Ugb2YgdGhlIGRvY3VtZW50IGhhcyBhbiBpZCBhdHRyaWJ1dGUgc3BlY2lmaWVkLgoJCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJCXNldHRpbmdzLmRhdGFVcmwgPSAkLm1vYmlsZS5wYXRoLmRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJCX0KCgkJCS8vIFRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgcmVhbCBwYWdlIERPTSBlbGVtZW50LiBVcGRhdGUgb3VyCgkJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCQlmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlOwoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgJC5tb2JpbGUucGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKHNldHRpbmdzLmRhdGFVcmwpICkgfHwKCQkJCXRvUGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQKCQkJLy8gYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmw7CgkJCWZpbGVVcmwgPSAkLm1vYmlsZS5wYXRoLmdldEZpbGVQYXRoKCB1cmwgKTsKCQkJYWN0aXZlID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKTsKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDA7CgkJCWhpc3RvcnlEaXIgPSAwOwoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZTsKCQkJaXNEaWFsb2cgPSAoIHNldHRpbmdzLnJvbGUgPT09ICJkaWFsb2ciIHx8CgkJCQl0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciICkgJiYKCQkJCXRvUGFnZS5qcW1EYXRhKCAiZGlhbG9nIiApICE9PSB0cnVlOwoKCQkJLy8gQnkgZGVmYXVsdCwgd2UgcHJldmVudCBjaGFuZ2VQYWdlIHJlcXVlc3RzIHdoZW4gdGhlIGZyb21QYWdlIGFuZCB0b1BhZ2UKCQkJLy8gYXJlIHRoZSBzYW1lIGVsZW1lbnQsIGJ1dCBmb2xrcyB0aGF0IGdlbmVyYXRlIGNvbnRlbnQKCQkJLy8gbWFudWFsbHkvZHluYW1pY2FsbHkgYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvCgkJCS8vIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93IHRoaXMsIHRoZXkgd2lsbCBuZWVkIHRvIGNoYW5nZSB0aGUgZGVmYXVsdAoJCQkvLyB2YWx1ZSBvZiBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiB0byB0cnVlLCAqT1IqLCBwYXNzIGl0IGluIGFzIGFuCgkJCS8vIG9wdGlvbiB3aGVuIHRoZXkgbWFudWFsbHkgY2FsbCBjaGFuZ2VQYWdlKCkuIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0CgkJCS8vIG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUgZm9ybVBhZ2UgYW5kIHRvUGFnZQoJCQkvLyBhcmUgZGlmZmVyZW50IGVsZW1lbnRzLCBzbyB0aGV5IG1heSBiZWhhdmUgdW5leHBlY3RlZGx5LiBJdCBpcyB1cCB0bwoJCQkvLyB0aGUgZGV2ZWxvcGVyIHRoYXQgdHVybnMgb24gdGhlIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uYSBvcHRpb24gdG8KCQkJLy8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkJLy8gYW5pbWF0aW9uIHRyYW5zaXRpb24gaXMgdXNlZC4KCQkJaWYgKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmCgkJCQkhc2V0dGluZ3MuYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gKSB7CgoJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAidHJhbnNpdGlvbiIsIHRyaWdnZXJEYXRhICk7CgkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCS8vIEV2ZW4gaWYgdGhlcmUgaXMgbm8gcGFnZSBjaGFuZ2UgdG8gYmUgZG9uZSwgd2Ugc2hvdWxkIGtlZXAgdGhlCgkJCQkvLyB1cmxIaXN0b3J5IGluIHN5bmMgd2l0aCB0aGUgaGFzaCBjaGFuZ2VzCgkJCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZGlyZWN0KHsgdXJsOiB1cmwgfSk7CgkJCQl9CgoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFnZSB3ZSBhcmUgZ2l2ZW4gaGFzIGFscmVhZHkgYmVlbiBlbmhhbmNlZC4KCQkJdG9QYWdlLnBhZ2UoeyByb2xlOiBzZXR0aW5ncy5yb2xlIH0pOwoKCQkJLy8gSWYgdGhlIGNoYW5nZVBhZ2UgcmVxdWVzdCB3YXMgc2VudCBmcm9tIGEgaGFzaENoYW5nZSBldmVudCwgY2hlY2sgdG8KCQkJLy8gc2VlIGlmIHRoZSBwYWdlIGlzIGFscmVhZHkgd2l0aGluIHRoZSB1cmxIaXN0b3J5IHN0YWNrLiBJZiBzbywgd2UnbGwKCQkJLy8gYXNzdW1lIHRoZSB1c2VyIGhpdCB0aGUgZm9yd2FyZC9iYWNrIGJ1dHRvbiBhbmQgd2lsbCB0cnkgdG8gbWF0Y2ggdGhlCgkJCS8vIHRyYW5zaXRpb24gYWNjb3JkaW5nbHkuCgkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQloaXN0b3J5RGlyID0gc2V0dGluZ3MuZGlyZWN0aW9uID09PSAiYmFjayIgPyAtMSA6IDE7CgkJCX0KCgkJCS8vIEtpbGwgdGhlIGtleWJvYXJkLgoJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gc3RvcCBjcmF3bGluZyB0aGUgZW50aXJlIGRvY3VtZW50IHRvIGtpbGwgZm9jdXMuCgkJCS8vICAgICAgICAgICAgSW5zdGVhZCwgd2Ugc2hvdWxkIGJlIHRyYWNraW5nIGZvY3VzIHdpdGggYSBkZWxlZ2F0ZSgpCgkJCS8vICAgICAgICAgICAgaGFuZGxlciBzbyB3ZSBhbHJlYWR5IGhhdmUgdGhlIGVsZW1lbnQgaW4gaGFuZCBhdCB0aGlzCgkJCS8vICAgICAgICAgICAgcG9pbnQuCgkJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZgoJCQkvLyBkb2N1bWVudC5hY3RpdmVFbGVtZW50IGlzIHVuZGVmaW5lZCB3aGVuIHdlIGFyZSBpbiBhbiBJRnJhbWUuCgkJCXRyeSB7CgkJCQlpZiAoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYKCQkJCQlkb2N1bWVudC5hY3RpdmVFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJib2R5IiApIHsKCgkJCQkJJCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCApLmJsdXIoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJCX0KCQkJfSBjYXRjaCggZSApIHt9CgoJCQkvLyBSZWNvcmQgd2hldGhlciB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHdoZXJlIGEgZGlhbG9nIHVzZWQgdG8gYmUgLQoJCQkvLyBpZiBzbywgZG8gbm90IGFkZCBhIG5ldyBoaXN0b3J5IGVudHJ5IGFuZCBkbyBub3QgY2hhbmdlIHRoZSBoYXNoIGVpdGhlcgoJCQlhbHJlYWR5VGhlcmUgPSBmYWxzZTsKCgkJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCQkvLyBmb3IgdGhlIGRpYWxvZyBjb250ZW50IHRvIGJlIHVzZWQgaW4gdGhlIGhhc2guIEluc3RlYWQsIHdlIHdhbnQKCQkJLy8gdG8gYXBwZW5kIHRoZSBkaWFsb2dIYXNoS2V5IHRvIHRoZSB1cmwgb2YgdGhlIGN1cnJlbnQgcGFnZS4KCQkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCQkvLyBvbiB0aGUgaW5pdGlhbCBwYWdlIGxvYWQgYWN0aXZlLnVybCBpcyB1bmRlZmluZWQgYW5kIGluIHRoYXQgY2FzZQoJCQkJLy8gc2hvdWxkIGJlIGFuIGVtcHR5IHN0cmluZy4gTW92aW5nIHRoZSB1bmRlZmluZWQgLT4gZW1wdHkgc3RyaW5nIGJhY2sKCQkJCS8vIGludG8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyCgkJCQkvLyByZXByZXNlbnRzIHRoZSB1cmwgc3RhdGUKCgkJCQkvLyBJZiB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHRoYXQgb25jZSBiZWxvbmdlZCB0byBhIGRpYWxvZywgcmV1c2UKCQkJCS8vIHRoaXMgc3RhdGUgd2l0aG91dCBhZGRpbmcgdG8gdXJsSGlzdG9yeSBhbmQgd2l0aG91dCBtb2RpZnlpbmcgdGhlCgkJCQkvLyBoYXNoLiBIb3dldmVyLCBpZiBhIGRpYWxvZyBpcyBhbHJlYWR5IGRpc3BsYXllZCBhdCB0aGlzIHBvaW50LCBhbmQKCQkJCS8vIHdlJ3JlIGFib3V0IHRvIGRpc3BsYXkgYW5vdGhlciBkaWFsb2csIHRoZW4gd2UgbXVzdCBhZGQgYW5vdGhlciBoYXNoCgkJCQkvLyBhbmQgaGlzdG9yeSBlbnRyeSBvbiB0b3Agc28gdGhhdCBvbmUgbWF5IG5hdmlnYXRlIGJhY2sgdG8gdGhlCgkJCQkvLyBvcmlnaW5hbCBkaWFsb2cKCQkJCWlmICggYWN0aXZlLnVybCAmJgoJCQkJCWFjdGl2ZS51cmwuaW5kZXhPZiggJC5tb2JpbGUuZGlhbG9nSGFzaEtleSApID4gLTEgJiYKCQkJCQl0aGlzLmFjdGl2ZVBhZ2UgJiYKCQkJCQkhdGhpcy5hY3RpdmVQYWdlLmhhc0NsYXNzKCAidWktZGlhbG9nIiApICYmCgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKSB7CgoJCQkJCXNldHRpbmdzLmNoYW5nZUhhc2ggPSBmYWxzZTsKCQkJCQlhbHJlYWR5VGhlcmUgPSB0cnVlOwoJCQkJfQoKCQkJCS8vIE5vcm1hbGx5LCB3ZSB0YWNrIG9uIGEgZGlhbG9nIGhhc2gga2V5LCBidXQgaWYgdGhpcyBpcyB0aGUgbG9jYXRpb24KCQkJCS8vIG9mIGEgc3RhbGUgZGlhbG9nLCB3ZSByZXVzZSB0aGUgVVJMIGZyb20gdGhlIGVudHJ5CgkJCQl1cmwgPSAoIGFjdGl2ZS51cmwgfHwgIiIgKTsKCgkJCQkvLyBhY2NvdW50IGZvciBhYnNvbHV0ZSB1cmxzIGluc3RlYWQgb2YganVzdCByZWxhdGl2ZSB1cmxzIHVzZSBhcyBoYXNoZXMKCQkJCWlmICggIWFscmVhZHlUaGVyZSAmJiB1cmwuaW5kZXhPZigiIyIpID4gLTEgKSB7CgkJCQkJdXJsICs9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCQl9IGVsc2UgewoJCQkJCXVybCArPSAiIyIgKyAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCQkJfQoKCQkJCS8vIHRhY2sgb24gYW5vdGhlciBkaWFsb2dIYXNoS2V5IGlmIHRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIGluaXRpYWwgaGFzaAoJCQkJLy8gdGhpcyBtYWtlcyBzdXJlIHRoYXQgYSBoaXN0b3J5IGVudHJ5IGlzIGNyZWF0ZWQgZm9yIHRoaXMgZGlhbG9nCgkJCQlpZiAoICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCQkJdXJsICs9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCQl9CgkJCX0KCgkJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkJLy8gSWYgdGhpcyBpcyBhIGRlZXAtbGluayBvciBhIHJlbG9hZCAoIGFjdGl2ZSA9PT0gdW5kZWZpbmVkICkgdGhlbiBqdXN0CgkJCS8vIHVzZSBwYWdlVGl0bGUKCQkJbmV3UGFnZVRpdGxlID0gKCAhYWN0aXZlICkgPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8CgkJCQl0b1BhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maW5kKCAiLnVpLXRpdGxlIiApLnRleHQoKTsKCQkJaWYgKCAhIW5ld1BhZ2VUaXRsZSAmJiBwYWdlVGl0bGUgPT09IGRvY3VtZW50LnRpdGxlICkgewoJCQkJcGFnZVRpdGxlID0gbmV3UGFnZVRpdGxlOwoJCQl9CgkJCWlmICggIXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCQl0b1BhZ2UuanFtRGF0YSggInRpdGxlIiwgcGFnZVRpdGxlICk7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJhbnNpdGlvbiBkZWZpbmVkLgoJCQlzZXR0aW5ncy50cmFuc2l0aW9uID0gc2V0dGluZ3MudHJhbnNpdGlvbiB8fAoJCQkJKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkgfHwKCQkJCSggaXNEaWFsb2cgPyAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiA6ICQubW9iaWxlLmRlZmF1bHRQYWdlVHJhbnNpdGlvbiApOwoKCQkJLy9hZGQgcGFnZSB0byBoaXN0b3J5IHN0YWNrIGlmIGl0J3Mgbm90IGJhY2sgb3IgZm9yd2FyZAoJCQlpZiAoICFoaXN0b3J5RGlyICYmIGFscmVhZHlUaGVyZSApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkucGFnZVVybCA9IHBhZ2VVcmw7CgkJCX0KCgkJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQkJaWYgKCB1cmwgJiYgIXNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoKCQkJCS8vIHJlYnVpbGRpbmcgdGhlIGhhc2ggaGVyZSBzaW5jZSB3ZSBsb29zZSBpdCBlYXJsaWVyIG9uCgkJCQkvLyBUT0RPIHByZXNlcnZlIHRoZSBvcmlnaW5hbGx5IHBhc3NlZCBpbiBwYXRoCgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggdXJsICkgJiYgdXJsLmluZGV4T2YoICIjIiApIDwgMCApIHsKCQkJCQl1cmwgPSAiIyIgKyB1cmw7CgkJCQl9CgoJCQkJLy8gVE9ETyB0aGUgcHJvcGVydHkgbmFtZXMgaGVyZSBhcmUganVzdCBzaWxseQoJCQkJcGFyYW1zID0gewoJCQkJCXRyYW5zaXRpb246IHNldHRpbmdzLnRyYW5zaXRpb24sCgkJCQkJdGl0bGU6IHBhZ2VUaXRsZSwKCQkJCQlwYWdlVXJsOiBwYWdlVXJsLAoJCQkJCXJvbGU6IHNldHRpbmdzLnJvbGUKCQkJCX07CgoJCQkJaWYgKCBzZXR0aW5ncy5jaGFuZ2VIYXNoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZSggdXJsLCBwYXJhbXMsIHRydWUpOwoJCQkJfSBlbHNlIGlmICggdG9QYWdlWyAwIF0gIT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCB1cmwsIHBhcmFtcyApOwoJCQkJfQoJCQl9CgoJCQkvL3NldCBwYWdlIHRpdGxlCgkJCWRvY3VtZW50LnRpdGxlID0gcGFnZVRpdGxlOwoKCQkJLy9zZXQgInRvUGFnZSIgYXMgYWN0aXZlUGFnZSBkZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCQkvL25ldyB3YXkgdG8gaGFuZGxlIGFjdGl2ZVBhZ2UKCQkJdGhpcy5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkJLy8gSWYgd2UncmUgbmF2aWdhdGluZyBiYWNrIGluIHRoZSBVUkwgaGlzdG9yeSwgc2V0IHJldmVyc2UgYWNjb3JkaW5nbHkuCgkJCXNldHRpbmdzLnJldmVyc2UgPSBzZXR0aW5ncy5yZXZlcnNlIHx8IGhpc3RvcnlEaXIgPCAwOwoKCQkJY3NzVHJhbnNpdGlvbkRlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCQkJdGhpcy5fY3NzVHJhbnNpdGlvbih0b1BhZ2UsIGZyb21QYWdlLCB7CgkJCQl0cmFuc2l0aW9uOiBzZXR0aW5ncy50cmFuc2l0aW9uLAoJCQkJcmV2ZXJzZTogc2V0dGluZ3MucmV2ZXJzZSwKCQkJCWRlZmVycmVkOiBjc3NUcmFuc2l0aW9uRGVmZXJyZWQKCQkJfSk7CgoJCQljc3NUcmFuc2l0aW9uRGVmZXJyZWQuZG9uZSgkLnByb3h5KGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tLCBhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCSQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcygpOwoKCQkJCS8vaWYgdGhlcmUncyBhIGR1cGxpY2F0ZUNhY2hlZFBhZ2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gbm93IHRoYXQgaXQncyBoaWRkZW4KCQkJCWlmICggc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZSApIHsKCQkJCQlzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlLnJlbW92ZSgpOwoJCQkJfQoKCQkJCS8vIGRlc3BpdGUgdmlzaWJpbGl0eTogaGlkZGVuIGFkZHJlc3NlcyBpc3N1ZSAjMjk2NQoJCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8yOTY1CgkJCQlpZiAoICFhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRvUGFnZSApOwoJCQkJfQoKCQkJCXRoaXMuX3JlbGVhc2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggInRyYW5zaXRpb24iLCB0cmlnZ2VyRGF0YSApOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJLy8gZGV0ZXJtaW5lIHRoZSBjdXJyZW50IGJhc2UgdXJsCgkJX2ZpbmRCYXNlV2l0aERlZmF1bHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgY2xvc2VzdEJhc2UgPSAoIHRoaXMuYWN0aXZlUGFnZSAmJgoJCQkkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggdGhpcy5hY3RpdmVQYWdlICkgKTsKCQlyZXR1cm4gY2xvc2VzdEJhc2UgfHwgJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCQl9Cgl9KTsKCgkvLyBUaGUgZm9sbG93aW5nIGhhbmRsZXJzIHNob3VsZCBiZSBib3VuZCBhZnRlciBtb2JpbGVpbml0IGhhcyBiZWVuIHRyaWdnZXJlZAoJLy8gdGhlIGZvbGxvd2luZyBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCS8vdGhlc2UgdmFyaWFibGVzIG1ha2UgYWxsIHBhZ2UgY29udGFpbmVycyB1c2UgdGhlIHNhbWUgcXVldWUgYW5kIG9ubHkgbmF2aWdhdGUgb25lIGF0IGEgdGltZQoJLy8gcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJdmFyIHBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy8gaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHBhZ2UgaXMgaW4gcHJvY2VzcyBvZiB0cmFuc2l0aW9uaW5nCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJCS8vIHJlc29sdmVkIG9uIGRvbXJlYWR5Cgl2YXIgZG9tcmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJLy8gcmVzb2x2ZWQgYW5kIG51bGxlZCBvbiB3aW5kb3cubG9hZCgpCgkJbG9hZERlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoJCWRvY3VtZW50VXJsID0gJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybCwKCgkJLy8gdXNlZCB0byB0cmFjayBsYXN0IHZjbGlja2VkIGVsZW1lbnQgdG8gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyBhZGRlZCB0byBmb3JtIGRhdGEKCQkkbGFzdFZDbGlja2VkID0gbnVsbDsKCgkvKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0cyApIHsKCQl2YXIgY29udGFpbmVyOwoKCQlvcHRzID0gb3B0cyB8fCB7fTsKCQljb250YWluZXIgPSAoIG9wdHMucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCS8vIGNyZWF0ZSB0aGUgZGVmZXJyZWQgdGhhdCB3aWxsIGJlIHN1cHBsaWVkIHRvIGxvYWRQYWdlIGNhbGxlcnMKCQkvLyBhbmQgcmVzb2x2ZWQgYnkgdGhlIGNvbnRlbnQgd2lkZ2V0J3MgbG9hZCBtZXRob2QKCQlvcHRzLmRlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCQkvLyBQcmVmZXJyaW5nIHRvIGFsbG93IGV4Y2VwdGlvbnMgZm9yIHVuaW5pdGlhbGl6ZWQgb3B0cy5wYWdlQ29udGFpbmVyCgkJLy8gd2lkZ2V0cyBzbyB3ZSBrbm93IGlmIHdlIG5lZWQgdG8gZm9yY2UgaW5pdCBoZXJlIGZvciB1c2VycwoJCWNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAibG9hZCIsIHVybCwgb3B0cyApOwoKCQkvLyBwcm92aWRlIHRoZSBkZWZlcnJlZAoJCXJldHVybiBvcHRzLmRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYgKCB0aGlzLnBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQgJiYKCQkJbmF2ICYmCgkJCW5hdi5hcHAgJiYKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSApIHsKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSgpOwoJCX0gZWxzZSB7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImJhY2siICk7CgkJfQoJfTsKCgkvLyBEaXJlY3QgZm9jdXMgdG8gdGhlIHBhZ2UgdGl0bGUsIG9yIG90aGVyd2lzZSBmaXJzdCBmb2N1c2FibGUgZWxlbWVudAoJJC5tb2JpbGUuZm9jdXNQYWdlID0gZnVuY3Rpb24gKCBwYWdlICkgewoJCXZhciBhdXRvZm9jdXMgPSBwYWdlLmZpbmQoICJbYXV0b2ZvY3VzXSIgKSwKCQkJcGFnZVRpdGxlID0gcGFnZS5maW5kKCAiLnVpLXRpdGxlOmVxKDApIiApOwoKCQlpZiAoIGF1dG9mb2N1cy5sZW5ndGggKSB7CgkJCWF1dG9mb2N1cy5mb2N1cygpOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBhZ2VUaXRsZS5sZW5ndGggKSB7CgkJCXBhZ2VUaXRsZS5mb2N1cygpOwoJCX0gZWxzZXsKCQkJcGFnZS5mb2N1cygpOwoJCX0KCX07CgoJLy8gTm8tb3AgaW1wbGVtZW50YXRpb24gb2YgdHJhbnNpdGlvbiBkZWdyYWRhdGlvbgoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiB8fCBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy8gRXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzCgoJJC5tb2JpbGUuY2hhbmdlUGFnZSA9IGZ1bmN0aW9uKCB0bywgb3B0aW9ucyApIHsKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnBhZ2Vjb250YWluZXIoICJjaGFuZ2UiLCB0bywgb3B0aW9ucyApOwoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzID0gewoJCXRyYW5zaXRpb246IHVuZGVmaW5lZCwKCQlyZXZlcnNlOiBmYWxzZSwKCQljaGFuZ2VIYXNoOiB0cnVlLAoJCWZyb21IYXNoQ2hhbmdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlkdXBsaWNhdGVDYWNoZWRQYWdlOiB1bmRlZmluZWQsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCXNob3dMb2FkTXNnOiB0cnVlLCAvL2xvYWRpbmcgbWVzc2FnZSBzaG93cyBieSBkZWZhdWx0IHdoZW4gcGFnZXMgYXJlIGJlaW5nIGZldGNoZWQgZHVyaW5nIGNoYW5nZVBhZ2UKCQlkYXRhVXJsOiB1bmRlZmluZWQsCgkJZnJvbVBhZ2U6IHVuZGVmaW5lZCwKCQlhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbjogZmFsc2UKCX07CgoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgPSBmdW5jdGlvbigpIHsKCQl2YXIgZ2V0QWpheEZvcm1EYXRhID0gZnVuY3Rpb24oICRmb3JtLCBjYWxjdWxhdGVPbmx5ICkgewoJCQl2YXIgdXJsLCByZXQgPSB0cnVlLCBmb3JtRGF0YSwgdmNsaWNrZWROYW1lLCBtZXRob2Q7CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkIHx8CgkJCQkJLy8gdGVzdCB0aGF0IHRoZSBmb3JtIGlzLCBpdHNlbGYsIGFqYXggZmFsc2UKCQkJCQkkZm9ybS5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IGFuZAoJCQkJCS8vIHRoZSBmb3JtIG9yIG9uZSBvZiBpdCdzIHBhcmVudHMgaXMgYWpheD1mYWxzZQoJCQkJCSEkZm9ybS5qcW1IaWphY2thYmxlKCkubGVuZ3RoIHx8CgkJCQkJJGZvcm0uYXR0ciggInRhcmdldCIgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdXJsID0gKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWQuYXR0ciggImZvcm1hY3Rpb24iICkgKSB8fAoJCQkJJGZvcm0uYXR0ciggImFjdGlvbiIgKTsKCQkJbWV0aG9kID0gKCAkZm9ybS5hdHRyKCAibWV0aG9kIiApIHx8ICJnZXQiICkudG9Mb3dlckNhc2UoKTsKCgkJCS8vIElmIG5vIGFjdGlvbiBpcyBzcGVjaWZpZWQsIGJyb3dzZXJzIGRlZmF1bHQgdG8gdXNpbmcgdGhlCgkJCS8vIFVSTCBvZiB0aGUgZG9jdW1lbnQgY29udGFpbmluZyB0aGUgZm9ybS4gU2luY2Ugd2UgZHluYW1pY2FsbHkKCQkJLy8gcHVsbCBpbiBwYWdlcyBmcm9tIGV4dGVybmFsIGRvY3VtZW50cywgdGhlIGZvcm0gc2hvdWxkIHN1Ym1pdAoJCQkvLyB0byB0aGUgVVJMIGZvciB0aGUgc291cmNlIGRvY3VtZW50IG9mIHRoZSBwYWdlIGNvbnRhaW5pbmcKCQkJLy8gdGhlIGZvcm0uCgkJCWlmICggIXVybCApIHsKCQkJCS8vIEdldCB0aGUgQGRhdGEtdXJsIGZvciB0aGUgcGFnZSBjb250YWluaW5nIHRoZSBmb3JtLgoJCQkJdXJsID0gJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICk7CgoJCQkJLy8gTk9URTogSWYgdGhlIG1ldGhvZCBpcyAiZ2V0Iiwgd2UgbmVlZCB0byBzdHJpcCBvZmYgdGhlIHF1ZXJ5IHN0cmluZwoJCQkJLy8gYmVjYXVzZSBpdCB3aWxsIGdldCByZXBsYWNlZCB3aXRoIHRoZSBuZXcgZm9ybSBkYXRhLiBTZWUgaXNzdWUgIzU3MTAuCgkJCQlpZiAoIG1ldGhvZCA9PT0gImdldCIgKSB7CgkJCQkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggdXJsICkuaHJlZk5vU2VhcmNoOwoJCQkJfQoKCQkJCWlmICggdXJsID09PSAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgewoJCQkJCS8vIFRoZSB1cmwgd2UgZ290IGJhY2sgbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYmFzZSwKCQkJCQkvLyB3aGljaCBtZWFucyB0aGUgcGFnZSBtdXN0IGJlIGFuIGludGVybmFsL2VtYmVkZGVkIHBhZ2UsCgkJCQkJLy8gc28gZGVmYXVsdCB0byB1c2luZyB0aGUgYWN0dWFsIGRvY3VtZW50IHVybCBhcyBhIGJyb3dzZXIKCQkJCQkvLyB3b3VsZC4KCQkJCQl1cmwgPSBkb2N1bWVudFVybC5ocmVmTm9TZWFyY2g7CgkJCQl9CgkJCX0KCgkJCXVybCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAgdXJsLCAkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKSApOwoKCQkJaWYgKCAoICQubW9iaWxlLnBhdGguaXNFeHRlcm5hbCggdXJsICkgJiYgISQubW9iaWxlLnBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCB1cmwgKSApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQlpZiAoICFjYWxjdWxhdGVPbmx5ICkgewoJCQkJZm9ybURhdGEgPSAkZm9ybS5zZXJpYWxpemVBcnJheSgpOwoKCQkJCWlmICggJGxhc3RWQ2xpY2tlZCAmJiAkbGFzdFZDbGlja2VkWyAwIF0uZm9ybSA9PT0gJGZvcm1bIDAgXSApIHsKCQkJCQl2Y2xpY2tlZE5hbWUgPSAkbGFzdFZDbGlja2VkLmF0dHIoICJuYW1lIiApOwoJCQkJCWlmICggdmNsaWNrZWROYW1lICkgewoJCQkJCQkvLyBNYWtlIHN1cmUgdGhlIGxhc3QgY2xpY2tlZCBlbGVtZW50IGlzIGluY2x1ZGVkIGluIHRoZSBmb3JtCgkJCQkJCSQuZWFjaCggZm9ybURhdGEsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJCQkJaWYgKCB2YWx1ZS5uYW1lID09PSB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCQkJLy8gVW5zZXQgdmNsaWNrZWROYW1lIC0gd2UndmUgZm91bmQgaXQgaW4gdGhlIHNlcmlhbGl6ZWQgZGF0YSBhbHJlYWR5CgkJCQkJCQkJdmNsaWNrZWROYW1lID0gIiI7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCQlmb3JtRGF0YS5wdXNoKCB7IG5hbWU6IHZjbGlja2VkTmFtZSwgdmFsdWU6ICRsYXN0VkNsaWNrZWQuYXR0ciggInZhbHVlIiApIH0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQlyZXQgPSB7CgkJCQkJdXJsOiB1cmwsCgkJCQkJb3B0aW9uczogewoJCQkJCQl0eXBlOgkJbWV0aG9kLAoJCQkJCQlkYXRhOgkJJC5wYXJhbSggZm9ybURhdGEgKSwKCQkJCQkJdHJhbnNpdGlvbjoJJGZvcm0uanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQkJCXJldmVyc2U6CSRmb3JtLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiwKCQkJCQkJcmVsb2FkUGFnZToJdHJ1ZQoJCQkJCX0KCQkJCX07CgkJCX0KCgkJCXJldHVybiByZXQ7CgkJfTsKCgkJLy9iaW5kIHRvIGZvcm0gc3VibWl0IGV2ZW50cywgaGFuZGxlIHdpdGggQWpheAoJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiZm9ybSIsICJzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmb3JtRGF0YTsKCgkJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZm9ybURhdGEgPSBnZXRBamF4Rm9ybURhdGEoICQoIHRoaXMgKSApOwoJCQkJaWYgKCBmb3JtRGF0YSApIHsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBmb3JtRGF0YS51cmwsIGZvcm1EYXRhLm9wdGlvbnMgKTsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vYWRkIGFjdGl2ZSBzdGF0ZSBvbiB2Y2xpY2sKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJGJ0biwgYnRuRWxzLCB0YXJnZXQgPSBldmVudC50YXJnZXQsIG5lZWRDbG9zZXN0ID0gZmFsc2U7CgkJCS8vIGlmIHRoaXMgaXNuJ3QgYSBsZWZ0IGNsaWNrIHdlIGRvbid0IGNhcmUuIEl0cyBpbXBvcnRhbnQgdG8gbm90ZQoJCQkvLyB0aGF0IHdoZW4gdGhlIHZpcnR1YWwgZXZlbnQgaXMgZ2VuZXJhdGVkIGl0IHdpbGwgY3JlYXRlIHRoZSB3aGljaCBhdHRyCgkJCWlmICggZXZlbnQud2hpY2ggPiAxIHx8ICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFJlY29yZCB0aGF0IHRoaXMgZWxlbWVudCB3YXMgY2xpY2tlZCwgaW4gY2FzZSB3ZSBuZWVkIGl0IGZvciBjb3JyZWN0CgkJCS8vIGZvcm0gc3VibWlzc2lvbiBkdXJpbmcgdGhlICJzdWJtaXQiIGhhbmRsZXIgYWJvdmUKCQkJJGxhc3RWQ2xpY2tlZCA9ICQoIHRhcmdldCApOwoKCQkJLy8gVHJ5IHRvIGZpbmQgYSB0YXJnZXQgZWxlbWVudCB0byB3aGljaCB0aGUgYWN0aXZlIGNsYXNzIHdpbGwgYmUgYXBwbGllZAoJCQlpZiAoICQuZGF0YSggdGFyZ2V0LCAibW9iaWxlLWJ1dHRvbiIgKSApIHsKCQkJCS8vIElmIHRoZSBmb3JtIHdpbGwgbm90IGJlIHN1Ym1pdHRlZCB2aWEgQUpBWCwgZG8gbm90IGFkZCBhY3RpdmUgY2xhc3MKCQkJCWlmICggIWdldEFqYXhGb3JtRGF0YSggJCggdGFyZ2V0ICkuY2xvc2VzdCggImZvcm0iICksIHRydWUgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkvLyBXZSB3aWxsIGFwcGx5IHRoZSBhY3RpdmUgc3RhdGUgdG8gdGhpcyBidXR0b24gd2lkZ2V0IC0gdGhlIHBhcmVudAoJCQkJLy8gb2YgdGhlIGlucHV0IHRoYXQgd2FzIGNsaWNrZWQgd2lsbCBoYXZlIHRoZSBhc3NvY2lhdGVkIGRhdGEKCQkJCWlmICggdGFyZ2V0LnBhcmVudE5vZGUgKSB7CgkJCQkJdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl0YXJnZXQgPSBmaW5kQ2xvc2VzdExpbmsoIHRhcmdldCApOwoJCQkJaWYgKCAhKCB0YXJnZXQgJiYgJC5tb2JpbGUucGF0aC5wYXJzZVVybCggdGFyZ2V0LmdldEF0dHJpYnV0ZSggImhyZWYiICkgfHwgIiMiICkuaGFzaCAhPT0gIiMiICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFRPRE8gdGVhY2ggJC5tb2JpbGUuaGlqYWNrYWJsZSB0byBvcGVyYXRlIG9uIHJhdyBkb20gZWxlbWVudHMgc28gdGhlCgkJCQkvLyBsaW5rIHdyYXBwaW5nIGNhbiBiZSBhdm9pZGVkCgkJCQlpZiAoICEkKCB0YXJnZXQgKS5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gQXZvaWQgY2FsbGluZyAuY2xvc2VzdCBieSB1c2luZyB0aGUgZGF0YSBzZXQgZHVyaW5nIC5idXR0b25NYXJrdXAoKQoJCQkvLyBMaXN0IGl0ZW1zIGhhdmUgdGhlIGJ1dHRvbiBkYXRhIGluIHRoZSBwYXJlbnQgb2YgdGhlIGVsZW1lbnQgY2xpY2tlZAoJCQlpZiAoICEhfnRhcmdldC5jbGFzc05hbWUuaW5kZXhPZiggInVpLWxpbmstaW5oZXJpdCIgKSApIHsKCQkJCWlmICggdGFyZ2V0LnBhcmVudE5vZGUgKSB7CgkJCQkJYnRuRWxzID0gJC5kYXRhKCB0YXJnZXQucGFyZW50Tm9kZSwgImJ1dHRvbkVsZW1lbnRzIiApOwoJCQkJfQoJCQkvLyBPdGhlcndpc2UsIGxvb2sgZm9yIHRoZSBkYXRhIG9uIHRoZSB0YXJnZXQgaXRzZWxmCgkJCX0gZWxzZSB7CgkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldCwgImJ1dHRvbkVsZW1lbnRzIiApOwoJCQl9CgkJCS8vIElmIGZvdW5kLCBncmFiIHRoZSBidXR0b24ncyBvdXRlciBlbGVtZW50CgkJCWlmICggYnRuRWxzICkgewoJCQkJdGFyZ2V0ID0gYnRuRWxzLm91dGVyOwoJCQl9IGVsc2UgewoJCQkJbmVlZENsb3Nlc3QgPSB0cnVlOwoJCQl9CgoJCQkkYnRuID0gJCggdGFyZ2V0ICk7CgkJCS8vIElmIHRoZSBvdXRlciBlbGVtZW50IHdhc24ndCBmb3VuZCBieSB0aGUgb3VyIGhldXJpc3RpY3MsIHVzZSAuY2xvc2VzdCgpCgkJCWlmICggbmVlZENsb3Nlc3QgKSB7CgkJCQkkYnRuID0gJGJ0bi5jbG9zZXN0KCAiLnVpLWJ0biIgKTsKCQkJfQoKCQkJaWYgKCAkYnRuLmxlbmd0aCA+IDAgJiYKCQkJCSEoICRidG4uaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgfHwKCgkJCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSBhZnRlciAxLjQuMCByZWxlYXNlCgkJCQkJLy8gb25seSB1aS1zdGF0ZS1kaXNhYmxlZCBzaG91bGQgYmUgcHJlc2VudCB0aGVyZWFmdGVyCgkJCQkJJGJ0bi5oYXNDbGFzcyggInVpLWRpc2FibGVkIiApICkgKSApIHsKCQkJCSQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJJC5tb2JpbGUuYWN0aXZlQ2xpY2tlZExpbmsgPSAkYnRuOwoJCQkJJC5tb2JpbGUuYWN0aXZlQ2xpY2tlZExpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0KCQl9KTsKCgkJLy8gY2xpY2sgcm91dGluZyAtIGRpcmVjdCB0byBIVFRQIG9yIEFqYXgsIGFjY29yZGluZ2x5CgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgfHwgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKSwKCQkJCSRsaW5rID0gJCggbGluayApLAoKCQkJCS8vcmVtb3ZlIGFjdGl2ZSBsaW5rIGNsYXNzIGlmIGV4dGVybmFsICh0aGVuIGl0IHdvbid0IGJlIHRoZXJlIGlmIHlvdSBjb21lIGJhY2spCgkJCQlodHRwQ2xlYW51cCA9IGZ1bmN0aW9uKCkgewoJCQkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCQl9LAoJCQkJYmFzZVVybCwgaHJlZiwKCQkJCXVzZURlZmF1bHRVcmxIYW5kbGluZywgaXNFeHRlcm5hbCwKCQkJCXRyYW5zaXRpb24sIHJldmVyc2UsIHJvbGU7CgoJCQkvLyBJZiBhIGJ1dHRvbiB3YXMgY2xpY2tlZCwgY2xlYW4gdXAgdGhlIGFjdGl2ZSBjbGFzcyBhZGRlZCBieSB2Y2xpY2sgYWJvdmUKCQkJaWYgKCAkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayAmJgoJCQkJJC5tb2JpbGUuYWN0aXZlQ2xpY2tlZExpbmtbIDAgXSA9PT0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGUgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQl9CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBsaW5rIGFzc29jaWF0ZWQgd2l0aCB0aGUgY2xpY2sgb3IgaXRzIG5vdCBhIGxlZnQKCQkJLy8gY2xpY2sgd2Ugd2FudCB0byBpZ25vcmUgdGhlIGNsaWNrCgkJCS8vIFRPRE8gdGVhY2ggJC5tb2JpbGUuaGlqYWNrYWJsZSB0byBvcGVyYXRlIG9uIHJhdyBkb20gZWxlbWVudHMgc28gdGhlIGxpbmsgd3JhcHBpbmcKCQkJLy8gY2FuIGJlIGF2b2lkZWQKCQkJaWYgKCAhbGluayB8fCBldmVudC53aGljaCA+IDEgfHwgISRsaW5rLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmICggJGxpbmsuaXMoICI6anFtRGF0YShyZWw9J2JhY2snKSIgKSApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJYmFzZVVybCA9ICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApOwoKCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICRsaW5rLmF0dHIoICJocmVmIiApIHx8ICIjIiwgYmFzZVVybCApOwoKCQkJLy9pZiBhamF4IGlzIGRpc2FibGVkLCBleGl0IGVhcmx5CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkICYmICEkLm1vYmlsZS5wYXRoLmlzRW1iZWRkZWRQYWdlKCBocmVmICkgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPT0gLTEgKSB7CgkJCQlocmVmID0gaHJlZi5yZXBsYWNlKCAvW14jXSojLywgIiIgKTsKCQkJCWlmICggIWhyZWYgKSB7CgkJCQkJLy9saW5rIHdhcyBhbiBlbXB0eSBoYXNoIG1lYW50IHB1cmVseQoJCQkJCS8vZm9yIGludGVyYWN0aW9uLCBzbyB3ZSBpZ25vcmUgaXQuCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgaWYgKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggaHJlZiApICkgewoJCQkJCS8vd2UgaGF2ZSBhcGF0aCBzbyBtYWtlIGl0IHRoZSBocmVmIHdlIHdhbnQgdG8gbG9hZC4KCQkJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGJhc2VVcmwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy93ZSBoYXZlIGEgc2ltcGxlIGlkIHNvIHVzZSB0aGUgZG9jdW1lbnRVcmwgYXMgaXRzIGJhc2UuCgkJCQkJaHJlZiA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBocmVmLCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICk7CgkJCQl9CgkJCX0KCgkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICk7CgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCS8vY2hlY2sgZm9yIHByb3RvY29sIG9yIHJlbCBhbmQgaXRzIG5vdCBhbiBlbWJlZGRlZCBwYWdlCgkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJaXNFeHRlcm5hbCA9IHVzZURlZmF1bHRVcmxIYW5kbGluZyB8fCAoICQubW9iaWxlLnBhdGguaXNFeHRlcm5hbCggaHJlZiApICYmICEkLm1vYmlsZS5wYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgaHJlZiApICk7CgoJCQlpZiAoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXRyYW5zaXRpb24gPSAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKTsKCQkJcmV2ZXJzZSA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiB8fAoJCQkJCQkvLyBkZXByZWNhdGVkIC0gcmVtb3ZlIGJ5IDEuMAoJCQkJCQkkbGluay5qcW1EYXRhKCAiYmFjayIgKTsKCgkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCXJvbGUgPSAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApIHx8IHVuZGVmaW5lZDsKCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGhyZWYsIHsgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgcmV2ZXJzZTogcmV2ZXJzZSwgcm9sZTogcm9sZSwgbGluazogJGxpbmsgfSApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL3ByZWZldGNoIHBhZ2VzIHdoZW4gYW5jaG9ycyB3aXRoIGRhdGEtcHJlZmV0Y2ggYXJlIGVuY291bnRlcmVkCgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlc2hvdy5wcmVmZXRjaCIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgdXJscyA9IFtdOwoJCQkkKCB0aGlzICkuZmluZCggImE6anFtRGF0YShwcmVmZXRjaCkiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKSwKCQkJCQl1cmwgPSAkbGluay5hdHRyKCAiaHJlZiIgKTsKCgkJCQlpZiAoIHVybCAmJiAkLmluQXJyYXkoIHVybCwgdXJscyApID09PSAtMSApIHsKCQkJCQl1cmxzLnB1c2goIHVybCApOwoKCQkJCQkkLm1vYmlsZS5sb2FkUGFnZSggdXJsLCB7IHJvbGU6ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkscHJlZmV0Y2g6IHRydWUgfSApOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJLy8gVE9ETyBlbnN1cmUgdGhhdCB0aGUgbmF2aWdhdGUgYmluZGluZyBpbiB0aGUgY29udGVudCB3aWRnZXQgaGFwcGVucyBhdCB0aGUgcmlnaHQgdGltZQoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lcigpOwoKCQkvL3NldCBwYWdlIG1pbi1oZWlnaHRzIHRvIGJlIGRldmljZSBzcGVjaWZpYwoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoKCQkJLy8gV2UgbmVlZCB0byB3YWl0IGZvciB3aW5kb3cubG9hZCB0byBtYWtlIHN1cmUgdGhhdCBzdHlsZXMgaGF2ZSBhbHJlYWR5IGJlZW4gcmVuZGVyZWQsCgkJCS8vIG90aGVyd2lzZSBoZWlnaHRzIG9mIGV4dGVybmFsIHRvb2xiYXJzIHdpbGwgaGF2ZSB0aGUgd3JvbmcgdmFsdWUKCQkJaWYgKCBsb2FkRGVmZXJyZWQgKSB7CgkJCQlsb2FkRGVmZXJyZWQuZG9uZSggJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgkJCX0gZWxzZSB7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCQkJfQoJCX0pOwoJCSQubW9iaWxlLndpbmRvdy5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfTsvL25hdnJlYWR5RGVmZXJyZWQgZG9uZSBjYWxsYmFjawoKCSQoIGZ1bmN0aW9uKCkgeyBkb21yZWFkeURlZmVycmVkLnJlc29sdmUoKTsgfSApOwoKCSQubW9iaWxlLndpbmRvdy5sb2FkKCBmdW5jdGlvbigpIHsKCgkJLy8gUmVzb2x2ZSBhbmQgbnVsbCB0aGUgZGVmZXJyZWQKCQlsb2FkRGVmZXJyZWQucmVzb2x2ZSgpOwoJCWxvYWREZWZlcnJlZCA9IG51bGw7Cgl9KTsKCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsICQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgKS5kb25lKCBmdW5jdGlvbigpIHsgJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMoKTsgfSApOwp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgkvLyBUT0RPIHJlbW92ZSBkaXJlY3QgcmVmZXJlbmNlcyB0byAkLm1vYmlsZSBhbmQgcHJvcGVydGllcywgd2Ugc2hvdWxkCgkvLyAgICAgIGZhdm9yIGluamVjdGlvbiB3aXRoIHBhcmFtcyB0byB0aGUgY29uc3RydWN0b3IKCSQubW9iaWxlLlRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXRvUHJlQ2xhc3M6ICIgdWktcGFnZS1wcmUtaW4iLAoKCQlpbml0OiBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApIHsKCQkJJC5leHRlbmQodGhpcywgewoJCQkJbmFtZTogbmFtZSwKCQkJCXJldmVyc2U6IHJldmVyc2UsCgkJCQkkdG86ICR0bywKCQkJCSRmcm9tOiAkZnJvbSwKCQkJCWRlZmVycmVkOiBuZXcgJC5EZWZlcnJlZCgpCgkJCX0pOwoJCX0sCgoJCWNsZWFuRnJvbTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuJGZyb20KCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiBvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkKCQkJCS5oZWlnaHQoICIiICk7CgkJfSwKCgkJLy8gTk9URSBvdmVycmlkZGVuIGJ5IGNoaWxkIG9iamVjdCBwcm90b3R5cGVzLCBub29wJ2QgaGVyZSBhcyBkZWZhdWx0cwoJCWJlZm9yZURvbmVJbjogZnVuY3Rpb24oKSB7fSwKCQliZWZvcmVEb25lT3V0OiBmdW5jdGlvbigpIHt9LAoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbigpIHt9LAoKCQlkb25lSW46IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmJlZm9yZURvbmVJbigpOwoKCQkJdGhpcy4kdG8ucmVtb3ZlQ2xhc3MoICJvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkuaGVpZ2h0KCAiIiApOwoKCQkJdGhpcy50b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQkvLyBJbiBzb21lIGJyb3dzZXJzIChpT1M1KSwgM0QgdHJhbnNpdGlvbnMgYmxvY2sgdGhlIGFiaWxpdHkgdG8gc2Nyb2xsIHRvIHRoZSBkZXNpcmVkIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0aW9uCgkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCWlmICggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpICE9PSB0aGlzLnRvU2Nyb2xsICkgewoJCQkJdGhpcy5zY3JvbGxQYWdlKCk7CgkJCX0KCQkJaWYgKCAhdGhpcy5zZXF1ZW50aWFsICkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoJCQl9CgkJCXRoaXMuZGVmZXJyZWQucmVzb2x2ZSggdGhpcy5uYW1lLCB0aGlzLnJldmVyc2UsIHRoaXMuJHRvLCB0aGlzLiRmcm9tLCB0cnVlICk7CgkJfSwKCgkJZG9uZU91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuYmVmb3JlRG9uZU91dCgpOwoJCQl0aGlzLnN0YXJ0SW4oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKTsKCQl9LAoKCQloaWRlSW46IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJdGhpcy4kdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoJCQljYWxsYmFjay5jYWxsKCB0aGlzICk7CgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAiIiApOwoJCX0sCgoJCXNjcm9sbFBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCS8vaWYgd2UgYXJlIGhpZGluZyB0aGUgdXJsIGJhciBvciB0aGUgcGFnZSB3YXMgcHJldmlvdXNseSBzY3JvbGxlZCBzY3JvbGwgdG8gaGlkZSBvciByZXR1cm4gdG8gcG9zaXRpb24KCQkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyIHx8IHRoaXMudG9TY3JvbGwgIT09ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLnRvU2Nyb2xsICk7CgkJCX0KCgkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJc3RhcnRJbjogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuaGlkZUluKGZ1bmN0aW9uKCkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRoaXMudG9QcmVDbGFzcyApOwoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCWlmICggIXByZXZlbnRGb2N1cyApIHsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRoaXMuJHRvICk7CgkJCQl9CgoJCQkJLy8gU2V0IHRvIHBhZ2UgaGVpZ2h0CgkJCQl0aGlzLiR0by5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRoaXMudG9TY3JvbGwgKTsKCiAgICAgICAgICAgICAgICBpZiAoICFub25lICkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsUGFnZSgpOwogICAgICAgICAgICAgICAgfQoJCQl9KTsKCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCAhbm9uZSApIHsKCQkJCXRoaXMuJHRvLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJCXRoaXMuZG9uZUluKCk7CgkJCQl9LCB0aGlzICkpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoJCXRvZ2dsZVZpZXdwb3J0Q2xhc3M6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIHRoaXMubmFtZSApOwoJCX0sCgoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewoJCQkvLyBOT1RFIG1hbnkgb2YgdGhlc2UgY291bGQgYmUgY2FsY3VsYXRlZC9yZWNvcmRlZCBpbiB0aGUgY29uc3RydWN0b3IsIGl0J3MgbXkKCQkJLy8gICAgICBvcGluaW9uIHRoYXQgYmluZGluZyB0aGVtIGFzIGxhdGUgYXMgcG9zc2libGUgaGFzIHZhbHVlIHdpdGggcmVnYXJkcyB0bwoJCQkvLyAgICAgIGJldHRlciB0cmFuc2l0aW9ucyB3aXRoIGZld2VyIGJ1Z3MuIEllLCBpdCdzIG5vdCBndWFyYW50ZWVkIHRoYXQgdGhlCgkJCS8vICAgICAgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgdHJhbnNpdGlvbiB3aWxsIGJlIHJ1biBpbW1lZGlhdGVseSBhZnRlciBhcwoJCQkvLyAgICAgIGl0IGlzIHRvZGF5LiBTbyB3ZSB3YWl0IHVudGlsIHRyYW5zaXRpb24gaXMgaW52b2tlZCB0byBnYXRoZXIgdGhlIGZvbGxvd2luZwoJCQl2YXIgbm9uZSwKCQkJCXJldmVyc2VDbGFzcyA9IHRoaXMucmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJgoJCQkJCSQubW9iaWxlLndpbmRvdy53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoOwoKCQkJdGhpcy50b1Njcm9sbCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkubGFzdFNjcm9sbCB8fCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCgkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8ICEkLnN1cHBvcnQuY3NzQW5pbWF0aW9ucyB8fAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlIHx8ICF0aGlzLm5hbWUgfHwgdGhpcy5uYW1lID09PSAibm9uZSIgfHwKCQkJCU1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRoaXMudG9TY3JvbGwgKSA+CgkJCQkJJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbigpOwoKCQkJdGhpcy50b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQlpZiAoIHRoaXMuJGZyb20gJiYgIW5vbmUgKSB7CgkJCQl0aGlzLnN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5kb25lT3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgdHJ1ZSApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5kZWZlcnJlZC5wcm9taXNlKCk7CgkJfQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5TZXJpYWxUcmFuc2l0aW9uLnByb3RvdHlwZSwgJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQlzZXF1ZW50aWFsOiB0cnVlLAoKCQliZWZvcmVEb25lT3V0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLiRmcm9tICkgewoJCQkJdGhpcy5jbGVhbkZyb20oKTsKCQkJfQoJCX0sCgoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbiggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKSB7CgkJCXRoaXMuJGZyb20uYW5pbWF0aW9uQ29tcGxldGUoJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQkJfSwgdGhpcyApKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24ucHJvdG90eXBlLCAkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXNlcXVlbnRpYWw6IGZhbHNlLAoKCQliZWZvcmVEb25lSW46IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMuJGZyb20gKSB7CgkJCQl0aGlzLmNsZWFuRnJvbSgpOwoJCQl9CgkJfSwKCgkJYmVmb3JlU3RhcnRPdXQ6IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApIHsKCQkJdGhpcy5kb25lT3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCApIHsKCgkvLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKCXZhciBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKCS8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwoJJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJCSJzZXF1ZW50aWFsIjogJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbiwKCQkic2ltdWx0YW5lb3VzIjogJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24KCX07CgoJLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KCSQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zZXF1ZW50aWFsOwoKCSQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCgkvLyBJZiB0cmFuc2l0aW9uIGlzIGRlZmluZWQsIGNoZWNrIGlmIGNzcyAzRCB0cmFuc2Zvcm1zIGFyZSBzdXBwb3J0ZWQsIGFuZCBpZiBub3QsIGlmIGEgZmFsbGJhY2sgaXMgc3BlY2lmaWVkCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCWlmICggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXTsKCQl9CgoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvLyBTZXQgdGhlIGdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gdG8gZGVmYXVsdCBpZiBubyBpbXBsZW1lbnRhdGlvbiB3YXMgc2V0IGJ5IHVzZXIKCSQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHx8IGRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBwb3AgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnBvcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBVc2UgdGhlIHNpbXVsdGFuZW91cyB0cmFuc2l0aW9ucyBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWRvd24gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZG93biA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVmYWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZmFkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGV1cCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGV1cCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgdHVybiBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MudHVybiA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07Ci8vIEJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzOwoKLy8gQXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgl0YXJnZXQgPSAkKCB0YXJnZXQgKTsKCgkvLyBEZWdyYWRlIGlucHV0cyB0byBhdm9pZCBwb29ybHkgaW1wbGVtZW50ZWQgbmF0aXZlIGZ1bmN0aW9uYWxpdHkKCXRhcmdldC5maW5kKCAiaW5wdXQiICkubm90KCAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSApLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gfHwgInRleHQiLAoJCQlodG1sLCBoYXNUeXBlLCBmaW5kc3RyLCByZXBzdHI7CgoJCWlmICggJC5tb2JpbGUuZGVncmFkZUlucHV0c1sgdHlwZSBdICkgewoJCQlodG1sID0gJCggIjxkaXY+IiApLmh0bWwoIGVsZW1lbnQuY2xvbmUoKSApLmh0bWwoKTsKCQkJLy8gSW4gSUUgYnJvd3NlcnMsIHRoZSB0eXBlIHNvbWV0aW1lcyBkb2Vzbid0IGV4aXN0IGluIHRoZSBjbG9uZWQgbWFya3VwLCBzbyB3ZSByZXBsYWNlIHRoZSBjbG9zaW5nIHRhZyBpbnN0ZWFkCgkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMTsKCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LzsKCQkJcmVwc3RyID0gIiB0eXBlPVwiIiArIG9wdFR5cGUgKyAiXCIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT1cIiIgKyB0eXBlICsgIlwiIiArICggaGFzVHlwZSA/ICIiIDogIj4iICk7CgoJCQllbGVtZW50LnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS5wYWdlLCB7CglvcHRpb25zOiB7CgoJCS8vIEFjY2VwdHMgbGVmdCwgcmlnaHQgYW5kIG5vbmUKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlLAoJCWRpYWxvZzogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaWFsb2cgKSB7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lubmVyOiB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKSwKCQkJCV9oZWFkZXJDbG9zZUJ1dHRvbjogbnVsbAoJCQl9KTsKCgkJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJCXRoaXMuX3NldENsb3NlQnRuKCB0aGlzLm9wdGlvbnMuY2xvc2VCdG4gKTsKCQkJfQoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nIGFuZCB3cmFwIGludGVyaW9yCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlhbG9nICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1kaWFsb2ciICkKCQkJCS53cmFwSW5uZXIoICQoICI8ZGl2Lz4iLCB7CgoJCQkJCS8vIEFSSUEgcm9sZQoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsKCQkJCQkJKCB0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApCgkJCQl9KSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2lubmVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsICEhb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJCWN1cnJlbnRPcHRzLm92ZXJsYXlUaGVtZSA9IG9wdGlvbnMub3ZlcmxheVRoZW1lOwoJCQkJdGhpcy5faGFuZGxlUGFnZUJlZm9yZVNob3coKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gY3VycmVudE9wdHMuY2xvc2VCdG47CgkJCWNsb3NlQnV0dG9uVGV4dCA9IG9wdGlvbnMuY2xvc2VCdG5UZXh0OwoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBvcHRpb25zLmNsb3NlQnRuOwoJCX0KCgkJaWYgKCBjbG9zZUJ1dHRvbkxvY2F0aW9uICkgewoJCQl0aGlzLl9zZXRDbG9zZUJ0biggY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0ICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uICgpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgJiYgdGhpcy5vcHRpb25zLmRpYWxvZyApIHsKCQkJdGhpcy5yZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kKCk7CgkJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJfQoJfSwKCglfc2V0Q2xvc2VCdG46IGZ1bmN0aW9uKCBsb2NhdGlvbiwgdGV4dCApIHsKCQl2YXIgZHN0LAoJCQlidG4gPSB0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbjsKCgkJLy8gU2FuaXRpemUgdmFsdWUKCQlsb2NhdGlvbiA9ICJsZWZ0IiA9PT0gbG9jYXRpb24gPyAibGVmdCIgOiAicmlnaHQiID09PSBsb2NhdGlvbiA/ICJyaWdodCIgOiAibm9uZSI7CgoJCWlmICggIm5vbmUiID09PSBsb2NhdGlvbiApIHsKCQkJaWYgKCBidG4gKSB7CgkJCQlidG4ucmVtb3ZlKCk7CgkJCQlidG4gPSBudWxsOwoJCQl9CgkJfSBlbHNlIGlmICggYnRuICkgewoJCQlidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIGxvY2F0aW9uICk7CgkJCWlmICggdGV4dCApIHsKCQkJCWJ0bi50ZXh0KCB0ZXh0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlkc3QgPSB0aGlzLl9pbm5lci5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKTsKCQkJYnRuID0gJCggIjxhPjwvYT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJImNsYXNzIjogInVpLWJ0biB1aS1jb3JuZXItYWxsIHVpLWljb24tZGVsZXRlIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1idG4tIiArIGxvY2F0aW9uCgkJCQl9KQoJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiLCAiYmFjayIgKQoJCQkJLnRleHQoIHRleHQgfHwgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCB8fCAiIiApCgkJCQkucHJlcGVuZFRvKCBkc3QgKTsKCQl9CgoJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gYnRuOwoJfQp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCB7CglvcHRpb25zOiB7CgoJCS8vIEFjY2VwdHMgbGVmdCwgcmlnaHQgYW5kIG5vbmUKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlCgl9LAoKCS8vIE92ZXJyaWRlIHRoZSB0aGVtZSBzZXQgYnkgdGhlIHBhZ2UgcGx1Z2luIG9uIHBhZ2VzaG93CglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gdHJ1ZTsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkucGFnZSggInNldENvbnRhaW5lckJhY2tncm91bmQiLCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfQoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7Cgl9LAoKCS8vIGNsaWNrIGFuZCBzdWJtaXQgZXZlbnRzOgoJLy8gLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZwoJLy8gICBvcGVuZWQgd2l0aCB1bmxlc3MgYSBkYXRhLXRyYW5zaXRpb24gaXMgc3BlY2lmaWVkIG9uIHRoZSBsaW5rL2Zvcm0KCS8vIC0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIKCS8vICAgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJX2hhbmRsZVZDbGlja1N1Ym1pdDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBhdHRycywKCQkJJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICk7CgoJCWlmICggJHRhcmdldC5sZW5ndGggJiYgISR0YXJnZXQuanFtRGF0YSggInRyYW5zaXRpb24iICkgKSB7CgkJCWF0dHJzID0ge307CgkJCWF0dHJzWyAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIgXSA9CgkJCQkoICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge30gKVsgInRyYW5zaXRpb24iIF0gfHwKCQkJCSQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOwoJCQlhdHRyc1sgImRhdGEtIiArICQubW9iaWxlLm5zICsgImRpcmVjdGlvbiIgXSA9ICJyZXZlcnNlIjsKCQkJJHRhcmdldC5hdHRyKCBhdHRycyApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nIGFuZCB3cmFwIGludGVyaW9yCgkJZWxlbS5hZGRDbGFzcyggInVpLWRpYWxvZyIgKQoJCQkud3JhcElubmVyKCAkKCAiPGRpdi8+IiwgewoKCQkJCS8vIEFSSUEgcm9sZQoJCQkJInJvbGUiIDogImRpYWxvZyIsCgkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArCgkJCQkJKCAhIW9wdHMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApCgkJCX0pKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2lzQ2xvc2VhYmxlOiBmYWxzZSwKCQkJX2lubmVyOiBlbGVtLmNoaWxkcmVuKCksCgkJCV9oZWFkZXJDbG9zZUJ1dHRvbjogbnVsbAoJCX0pOwoKCQl0aGlzLl9vbiggZWxlbSwgewoJCQl2Y2xpY2s6ICJfaGFuZGxlVkNsaWNrU3VibWl0IiwKCQkJc3VibWl0OiAiX2hhbmRsZVZDbGlja1N1Ym1pdCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJcGFnZWJlZm9yZWhpZGU6ICJfaGFuZGxlUGFnZUJlZm9yZUhpZGUiCgkJfSk7CgoJCXRoaXMuX3NldENsb3NlQnRuKCBvcHRzLmNsb3NlQnRuICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0LAoJCQljdXJyZW50T3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faW5uZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgISFvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5vdmVybGF5VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAkLm1vYmlsZS5hY3RpdmVQYWdlWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQkJY3VycmVudE9wdHMub3ZlcmxheVRoZW1lID0gb3B0aW9ucy5vdmVybGF5VGhlbWU7CgkJCQl0aGlzLl9oYW5kbGVQYWdlQmVmb3JlU2hvdygpOwoJCQl9CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG5UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBjdXJyZW50T3B0cy5jbG9zZUJ0bjsKCQkJY2xvc2VCdXR0b25UZXh0ID0gb3B0aW9ucy5jbG9zZUJ0blRleHQ7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IG9wdGlvbnMuY2xvc2VCdG47CgkJfQoKCQlpZiAoIGNsb3NlQnV0dG9uTG9jYXRpb24gKSB7CgkJCXRoaXMuX3NldENsb3NlQnRuKCBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRDbG9zZUJ0bjogZnVuY3Rpb24oIGxvY2F0aW9uLCB0ZXh0ICkgewoJCXZhciBkc3QsCgkJCWJ0biA9IHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uOwoKCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCWxvY2F0aW9uID0gImxlZnQiID09PSBsb2NhdGlvbiA/ICJsZWZ0IiA6ICJyaWdodCIgPT09IGxvY2F0aW9uID8gInJpZ2h0IiA6ICJub25lIjsKCgkJaWYgKCAibm9uZSIgPT09IGxvY2F0aW9uICkgewoJCQlpZiAoIGJ0biApIHsKCQkJCWJ0bi5yZW1vdmUoKTsKCQkJCWJ0biA9IG51bGw7CgkJCX0KCQl9IGVsc2UgaWYgKCBidG4gKSB7CgkJCWJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi0iICsgbG9jYXRpb24gKTsKCQkJaWYgKCB0ZXh0ICkgewoJCQkJYnRuLnRleHQoIHRleHQgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWRzdCA9IHRoaXMuX2lubmVyLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maXJzdCgpOwoJCQlidG4gPSAkKCAiPGE+PC9hPiIsIHsKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBoaXN0ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeTsKCgkJaWYgKCB0aGlzLl9pc0Nsb3NlYWJsZSApIHsKCQkJdGhpcy5faXNDbG9zZWFibGUgPSBmYWxzZTsKCQkJLy8gSWYgdGhlIGhhc2ggbGlzdGVuaW5nIGlzIGVuYWJsZWQgYW5kIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBwcmVjZWRpbmcgaGlzdG9yeQoJCQkvLyBlbnRyeSBpdCdzIG9rIHRvIGdvIGJhY2suIEluaXRpYWwgcGFnZXMgd2l0aCB0aGUgZGlhbG9nIGhhc2ggc3RhdGUgYXJlIGFuIGV4YW1wbGUKCQkJLy8gd2hlcmUgdGhlIHN0YWNrIGNoZWNrIGlzIG5lY2Vzc2FyeQoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmIGhpc3QuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAiYmFjayIgKTsKCQkJfQoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBySW5pdGlhbExldHRlciA9IC8oW0EtWl0pL2csCgoJLy8gQ29uc3RydWN0IGljb25wb3MgY2xhc3MgZnJvbSBpY29ucG9zIHZhbHVlCglpY29ucG9zQ2xhc3MgPSBmdW5jdGlvbiggaWNvbnBvcyApIHsKCQlyZXR1cm4gKCAidWktYnRuLWljb24tIiArICggaWNvbnBvcyA9PT0gbnVsbCA/ICJsZWZ0IiA6IGljb25wb3MgKSApOwoJfTsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JyksIiArCgkJCQkJCSI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZXNldCcpIiArCgkJCQkJCSggJC5tb2JpbGUuY29sbGFwc2libGVzZXQgPyAiLCA6bW9iaWxlLWNvbGxhcHNpYmxlc2V0IiA6CgkJCQkJCQkiIiApICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICkKCQkJfTsKCgkJdGhpcy5fdWkgPSB1aTsKCQl0aGlzLl9yZW5kZXJlZE9wdGlvbnMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoJCQl1aS5jb250ZW50ID0gdWkuaGVhZGluZy5uZXh0KCk7CgkJCXVpLmFuY2hvciA9ICQoICJhIiwgdWkuaGVhZGluZ1sgMCBdICkuZmlyc3QoKTsKCQkJdWkuc3RhdHVzID0gdWkuYW5jaG9yLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2VuaGFuY2UoIGVsZW0sIHVpICk7CgkJfQoKCQl0aGlzLl9vbiggdWkuaGVhZGluZywgewoJCQkidGFwIjogZnVuY3Rpb24oKSB7CgkJCQl1aS5oZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0sCgoJCQkiY2xpY2siOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggIXVpLmhlYWRpbmcuaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIEFkanVzdCB0aGUga2V5cyBpbnNpZGUgb3B0aW9ucyBmb3IgaW5oZXJpdGVkIHZhbHVlcwoJX2dldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXksCgkJCWFjY29yZGlvbiA9IHRoaXMuX3VpLmFjY29yZGlvbiwKCQkJYWNjb3JkaW9uV2lkZ2V0ID0gdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0OwoKCQkvLyBDb3B5IG9wdGlvbnMKCQlvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJCWlmICggYWNjb3JkaW9uLmxlbmd0aCAmJiAhYWNjb3JkaW9uV2lkZ2V0ICkgewoJCQl0aGlzLl91aS5hY2NvcmRpb25XaWRnZXQgPQoJCQlhY2NvcmRpb25XaWRnZXQgPSBhY2NvcmRpb24uZGF0YSggIm1vYmlsZS1jb2xsYXBzaWJsZXNldCIgKTsKCQl9CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoKCQkJLy8gUmV0cmlldmUgdGhlIG9wdGlvbiB2YWx1ZSBmaXJzdCBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW4gYW5kLCBpZgoJCQkvLyBudWxsLCBmcm9tIHRoZSBwYXJlbnQgYWNjb3JkaW9uIG9yLCBpZiB0aGF0J3MgbnVsbCB0b28sIG9yIGlmIHRoZXJlJ3Mgbm8KCQkJLy8gcGFyZW50IGFjY29yZGlvbiwgdGhlbiBmcm9tIHRoZSBkZWZhdWx0cy4KCQkJb3B0aW9uc1sga2V5IF0gPQoJCQkJKCBvcHRpb25zWyBrZXkgXSAhPSBudWxsICkgPyBvcHRpb25zWyBrZXkgXSA6CgkJCQkoIGFjY29yZGlvbldpZGdldCApID8gYWNjb3JkaW9uV2lkZ2V0Lm9wdGlvbnNbIGtleSBdIDoKCQkJCWFjY29yZGlvbi5sZW5ndGggPyAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGFjY29yZGlvblsgMCBdLAoJCQkJCWtleS5yZXBsYWNlKCBySW5pdGlhbExldHRlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICk6CgkJCQludWxsOwoKCQkJaWYgKCBudWxsID09IG9wdGlvbnNbIGtleSBdICkgewoJCQkJb3B0aW9uc1sga2V5IF0gPSAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0c1sga2V5IF07CgkJCX0KCQl9CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCBlbGVtLCB1aSApIHsKCQl2YXIgaWNvbmNsYXNzLAoJCQlvcHRzID0gdGhpcy5fcmVuZGVyZWRPcHRpb25zLAoJCQljb250ZW50VGhlbWVDbGFzcyA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvcHRzLmNvbnRlbnRUaGVtZSApOwoKCQllbGVtLmFkZENsYXNzKCAidWktY29sbGFwc2libGUgIiArCgkJCSggb3B0cy5pbnNldCA/ICJ1aS1jb2xsYXBzaWJsZS1pbnNldCAiIDogIiIgKSArCgkJCSggb3B0cy5pbnNldCAmJiBvcHRzLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSArCgkJCSggY29udGVudFRoZW1lQ2xhc3MgPyAidWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQgIiA6ICIiICkgKTsKCQl1aS5vcmlnaW5hbEhlYWRpbmcgPSBlbGVtLmNoaWxkcmVuKCB0aGlzLm9wdGlvbnMuaGVhZGluZyApLmZpcnN0KCksCgkJdWkuY29udGVudCA9IGVsZW0KCQkJLndyYXBJbm5lciggIjxkaXYgIiArCgkJCQkiY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWNvbnRlbnQgIiArCgkJCQljb250ZW50VGhlbWVDbGFzcyArICInPjwvZGl2PiIgKQoJCQkuY2hpbGRyZW4oICIudWktY29sbGFwc2libGUtY29udGVudCIgKSwKCQl1aS5oZWFkaW5nID0gdWkub3JpZ2luYWxIZWFkaW5nOwoKCQkvLyBSZXBsYWNlIGNvbGxhcHNpYmxlSGVhZGluZyBpZiBpdCdzIGEgbGVnZW5kCgkJaWYgKCB1aS5oZWFkaW5nLmlzKCAibGVnZW5kIiApICkgewoJCQl1aS5oZWFkaW5nID0gJCggIjxkaXYgcm9sZT0naGVhZGluZyc+IisgdWkuaGVhZGluZy5odG1sKCkgKyI8L2Rpdj4iICk7CgkJCXVpLnBsYWNlaG9sZGVyID0gJCggIjxkaXY+PCEtLSBwbGFjZWhvbGRlciBmb3IgbGVnZW5kIC0tPjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoIHVpLm9yaWdpbmFsSGVhZGluZyApOwoJCQl1aS5vcmlnaW5hbEhlYWRpbmcucmVtb3ZlKCk7CgkJfQoKCQlpY29uY2xhc3MgPSAoIG9wdHMuY29sbGFwc2VkID8gKCBvcHRzLmNvbGxhcHNlZEljb24gPyAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uIDogIiIgKToKCQkJKCBvcHRzLmV4cGFuZGVkSWNvbiA/ICJ1aS1pY29uLSIgKyBvcHRzLmV4cGFuZGVkSWNvbiA6ICIiICkgKTsKCgkJdWkuc3RhdHVzID0gJCggIjxzcGFuIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyc+PC9zcGFuPiIgKTsKCQl1aS5hbmNob3IgPSB1aS5oZWFkaW5nCgkJCS5kZXRhY2goKQoJCQkvL21vZGlmeSBtYXJrdXAgJiBhdHRyaWJ1dGVzCgkJCS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkKCQkJLmFwcGVuZCggdWkuc3RhdHVzICkKCQkJLndyYXBJbm5lciggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXRvZ2dsZSc+PC9hPiIgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4gIiArCgkJCQkJKCBpY29uY2xhc3MgPyBpY29uY2xhc3MgKyAiICIgOiAiIiApICsKCQkJCQkoIGljb25jbGFzcyA/IGljb25wb3NDbGFzcyggb3B0cy5pY29ucG9zICkgKwoJCQkJCQkiICIgOiAiIiApICsKCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKTsKCgkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQl1aS5oZWFkaW5nLmluc2VydEJlZm9yZSggdWkuY29udGVudCApOwoKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggdGhpcy5vcHRpb25zLmNvbGxhcHNlZCApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2FwcGx5T3B0aW9ucyggdGhpcy5vcHRpb25zICk7CgkJdGhpcy5fcmVuZGVyZWRPcHRpb25zID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICk7Cgl9LAoKCV9hcHBseU9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpc0NvbGxhcHNlZCwgbmV3VGhlbWUsIG9sZFRoZW1lLCBoYXNDb3JuZXJzLCBoYXNJY29uLAoJCQllbGVtID0gdGhpcy5lbGVtZW50LAoJCQljdXJyZW50T3B0cyA9IHRoaXMuX3JlbmRlcmVkT3B0aW9ucywKCQkJdWkgPSB0aGlzLl91aSwKCQkJYW5jaG9yID0gdWkuYW5jaG9yLAoJCQlzdGF0dXMgPSB1aS5zdGF0dXMsCgkJCW9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCS8vIEZpcnN0IGFuZCBmb3JlbW9zdCB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgY29sbGFwc2libGUgaXMgaW4gdGhlIHByb3BlcgoJCS8vIHN0YXRlLCBpbiBjYXNlIHNvbWVib2R5IGRlY2lkZWQgdG8gY2hhbmdlIHRoZSBjb2xsYXBzZWQgb3B0aW9uIGF0IHRoZQoJCS8vIHNhbWUgdGltZSBhcyBhbm90aGVyIG9wdGlvbgoJCWlmICggb3B0aW9ucy5jb2xsYXBzZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIG9wdGlvbnMuY29sbGFwc2VkICk7CgkJfQoKCQlpc0NvbGxhcHNlZCA9IGVsZW0uaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiICk7CgoJCS8vIFdlIG9ubHkgbmVlZCB0byBhcHBseSB0aGUgY3VlIHRleHQgZm9yIHRoZSBjdXJyZW50IHN0YXRlIHJpZ2h0IGF3YXkuCgkJLy8gVGhlIGN1ZSB0ZXh0IGZvciB0aGUgYWx0ZXJuYXRlIHN0YXRlIHdpbGwgYmUgc3RvcmVkIGluIHRoZSBvcHRpb25zCgkJLy8gYW5kIGFwcGxpZWQgdGhlIG5leHQgdGltZSB0aGUgY29sbGFwc2libGUncyBzdGF0ZSBpcyB0b2dnbGVkCgkJaWYgKCBpc0NvbGxhcHNlZCApIHsKCQkJaWYgKCBvcHRzLmV4cGFuZEN1ZVRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXN0YXR1cy50ZXh0KCBvcHRzLmV4cGFuZEN1ZVRleHQgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWlmICggb3B0cy5jb2xsYXBzZUN1ZVRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXN0YXR1cy50ZXh0KCBvcHRzLmNvbGxhcHNlQ3VlVGV4dCApOwoJCQl9CgkJfQoKCQkvLyBVcGRhdGUgaWNvbgoKCQkvLyBJcyBpdCBzdXBwb3NlZCB0byBoYXZlIGFuIGljb24/CgkJaGFzSWNvbiA9CgoJCQkvLyBJZiB0aGUgY29sbGFwc2VkSWNvbiBpcyBiZWluZyBzZXQsIGNvbnN1bHQgdGhhdAoJCQkoIG9wdHMuY29sbGFwc2VkSWNvbiAhPT0gdW5kZWZpbmVkID8gb3B0cy5jb2xsYXBzZWRJY29uICE9PSBmYWxzZSA6CgoJCQkJLy8gT3RoZXJ3aXNlIGNvbnN1bHQgdGhlIGV4aXN0aW5nIG9wdGlvbiB2YWx1ZQoJCQkJY3VycmVudE9wdHMuY29sbGFwc2VkSWNvbiAhPT0gZmFsc2UgKTsKCgoJCS8vIElmIGFueSBpY29uLXJlbGF0ZWQgb3B0aW9ucyBoYXZlIGNoYW5nZWQsIG1ha2Ugc3VyZSB0aGUgbmV3IGljb24KCQkvLyBzdGF0ZSBpcyByZWZsZWN0ZWQgYnkgZmlyc3QgcmVtb3ZpbmcgYWxsIGljb24tcmVsYXRlZCBjbGFzc2VzCgkJLy8gcmVmbGVjdGluZyB0aGUgY3VycmVudCBzdGF0ZSBhbmQgdGhlbiBhZGRpbmcgYWxsIGljb24tcmVsYXRlZAoJCS8vIGNsYXNzZXMgZm9yIHRoZSBuZXcgc3RhdGUKCQlpZiAoICEoIG9wdHMuaWNvbnBvcyA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdHMuY29sbGFwc2VkSWNvbiA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdHMuZXhwYW5kZWRJY29uID09PSB1bmRlZmluZWQgKSApIHsKCgkJCS8vIFJlbW92ZSBhbGwgY3VycmVudCBpY29uLXJlbGF0ZWQgY2xhc3NlcwoJCQlhbmNob3IucmVtb3ZlQ2xhc3MoIFsgaWNvbnBvc0NsYXNzKCBjdXJyZW50T3B0cy5pY29ucG9zICkgXQoJCQkJLmNvbmNhdCggKCBjdXJyZW50T3B0cy5leHBhbmRlZEljb24gPwoJCQkJCVsgInVpLWljb24tIiArIGN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiBdIDogW10gKSApCgkJCQkuY29uY2F0KCAoIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gPwoJCQkJCVsgInVpLWljb24tIiArIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gXSA6IFtdICkgKQoJCQkJLmpvaW4oICIgIiApICk7CgoJCQkvLyBBZGQgbmV3IGNsYXNzZXMgaWYgYW4gaWNvbiBpcyBzdXBwb3NlZCB0byBiZSBwcmVzZW50CgkJCWlmICggaGFzSWNvbiApIHsKCQkJCWFuY2hvci5hZGRDbGFzcygKCQkJCQlbIGljb25wb3NDbGFzcyggb3B0cy5pY29ucG9zICE9PSB1bmRlZmluZWQgPwoJCQkJCQlvcHRzLmljb25wb3MgOiBjdXJyZW50T3B0cy5pY29ucG9zICkgXQoJCQkJCQkuY29uY2F0KCBpc0NvbGxhcHNlZCA/CgkJCQkJCQlbICJ1aS1pY29uLSIgKyAoIG9wdHMuY29sbGFwc2VkSWNvbiAhPT0gdW5kZWZpbmVkID8KCQkJCQkJCQlvcHRzLmNvbGxhcHNlZEljb24gOgoJCQkJCQkJCWN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gKSBdIDoKCQkJCQkJCVsgInVpLWljb24tIiArICggb3B0cy5leHBhbmRlZEljb24gIT09IHVuZGVmaW5lZCA/CgkJCQkJCQkJb3B0cy5leHBhbmRlZEljb24gOgoJCQkJCQkJCWN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiApIF0gKQoJCQkJCQkuam9pbiggIiAiICkgKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRzLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW9sZFRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgY3VycmVudE9wdHMudGhlbWUgKTsKCQkJbmV3VGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICk7CgkJCWFuY2hvci5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQl9CgoJCWlmICggb3B0cy5jb250ZW50VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJb2xkVGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwKCQkJCWN1cnJlbnRPcHRzLmNvbnRlbnRUaGVtZSApOwoJCQluZXdUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLAoJCQkJb3B0cy5jb250ZW50VGhlbWUgKTsKCQkJdWkuY29udGVudC5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQl9CgoJCWlmICggb3B0cy5pbnNldCAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaW5zZXQiLCBvcHRzLmluc2V0ICk7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5pbnNldCAmJiAoIG9wdHMuY29ybmVycyB8fCBjdXJyZW50T3B0cy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0cy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5jb3JuZXJzICYmICggb3B0cy5pbnNldCB8fCBjdXJyZW50T3B0cy5pbnNldCApICk7CgkJfQoKCQlpZiAoIGhhc0Nvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBoYXNDb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdHMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlhbmNob3IudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0cy5taW5pICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdGhpcy5fYXBwbHlPcHRpb25zKCBvcHRpb25zICk7CgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQl0aGlzLl9yZW5kZXJlZE9wdGlvbnMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKTsKCX0sCgoJX2hhbmRsZUV4cGFuZENvbGxhcHNlOiBmdW5jdGlvbiggaXNDb2xsYXBzZSApIHsKCQl2YXIgb3B0cyA9IHRoaXMuX3JlbmRlcmVkT3B0aW9ucywKCQkJdWkgPSB0aGlzLl91aTsKCgkJdWkuc3RhdHVzLnRleHQoIGlzQ29sbGFwc2UgPyBvcHRzLmV4cGFuZEN1ZVRleHQgOiBvcHRzLmNvbGxhcHNlQ3VlVGV4dCApOwoJCXVpLmhlYWRpbmcKCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkKCQkJLmZpbmQoICJhIiApLmZpcnN0KCkKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24sICFpc0NvbGxhcHNlICkKCgkJCS8vIGxvZ2ljIG9yIGNhdXNlIHNhbWUgaWNvbiBmb3IgZXhwYW5kZWQvY29sbGFwc2VkIHN0YXRlIHdvdWxkIHJlbW92ZSB0aGUgdWktaWNvbi1jbGFzcwoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24sICggaXNDb2xsYXBzZSB8fCBvcHRzLmV4cGFuZGVkSWNvbiA9PT0gb3B0cy5jb2xsYXBzZWRJY29uICkgKQoJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQl1aS5jb250ZW50CgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICkKCQkJLnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJdGhpcy5vcHRpb25zLmNvbGxhcHNlZCA9IGlzQ29sbGFwc2U7CgkJdGhpcy5fdHJpZ2dlciggaXNDb2xsYXBzZSA/ICJjb2xsYXBzZSIgOiAiZXhwYW5kIiApOwoJfSwKCglleHBhbmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCBmYWxzZSApOwoJfSwKCgljb2xsYXBzZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIHRydWUgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB1aSA9IHRoaXMuX3VpLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdWkucGxhY2Vob2xkZXIgKSB7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5pbnNlcnRCZWZvcmUoIHVpLnBsYWNlaG9sZGVyICk7CgkJCXVpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJCQl1aS5oZWFkaW5nLnJlbW92ZSgpOwoJCX0gZWxzZSB7CgkJCXVpLnN0YXR1cy5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZwoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyB1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKQoJCQkJLmNoaWxkcmVuKCkKCQkJCQkuY29udGVudHMoKQoJCQkJCQkudW53cmFwKCk7CgkJfQoKCQl1aS5hbmNob3IuY29udGVudHMoKS51bndyYXAoKTsKCQl1aS5jb250ZW50LmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlIHVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCAiICsKCQkJCSJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCB1aS1jb2xsYXBzaWJsZS1pbnNldCB1aS1jb3JuZXItYWxsIiApOwoJfQp9KTsKCi8vIERlZmF1bHRzIHRvIGJlIHVzZWQgYnkgYWxsIGluc3RhbmNlcyBvZiBjb2xsYXBzaWJsZSBpZiBwZXItaW5zdGFuY2UgdmFsdWVzCi8vIGFyZSB1bnNldCBvciBpZiBub3RoaW5nIGlzIHNwZWNpZmllZCBieSB3YXkgb2YgaW5oZXJpdGFuY2UgZnJvbSBhbiBhY2NvcmRpb24uCi8vIE5vdGUgdGhhdCB0aGlzIGhhc2ggZG9lcyBub3QgY29udGFpbiBvcHRpb25zICJjb2xsYXBzZWQiIG9yICJoZWFkaW5nIiwKLy8gYmVjYXVzZSB0aG9zZSBhcmUgbm90IGluaGVyaXRhYmxlLgokLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0cyA9IHsKCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCWNvbGxhcHNlQ3VlVGV4dDogIiBjbGljayB0byBjb2xsYXBzZSBjb250ZW50cyIsCgljb2xsYXBzZWRJY29uOiAicGx1cyIsCgljb250ZW50VGhlbWU6ICJpbmhlcml0IiwKCWV4cGFuZGVkSWNvbjogIm1pbnVzIiwKCWljb25wb3M6ICJsZWZ0IiwKCWluc2V0OiB0cnVlLAoJY29ybmVyczogdHJ1ZSwKCXRoZW1lOiAiaW5oZXJpdCIsCgltaW5pOiBmYWxzZQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyA9IHsKCV9nZXRWaXNpYmxlczogZnVuY3Rpb24oICRlbHMsIGNyZWF0ZSApIHsKCQl2YXIgdmlzaWJsZXM7CgoJCWlmICggY3JlYXRlICkgewoJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdmlzaWJsZXMgPSAkZWxzLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQlpZiAoIHZpc2libGVzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHZpc2libGVzOwoJfSwKCglfYWRkRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMsICR2aXNpYmxlcywgY3JlYXRlICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJCSR2aXNpYmxlcy5lcSggMCApLmFkZENsYXNzKCAidWktZmlyc3QtY2hpbGQiICkuZW5kKCkubGFzdCgpLmFkZENsYXNzKCAidWktbGFzdC1jaGlsZCIgKTsKCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJX3JlbW92ZUZpcnN0TGFzdENsYXNzZXM6IGZ1bmN0aW9uKCAkZWxzICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciA9ICI6bW9iaWxlLWNvbGxhcHNpYmxlLCAiICsgJC5tb2JpbGUuY29sbGFwc2libGUuaW5pdFNlbGVjdG9yOwoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLmV4dGVuZCggewoKCS8vIFRoZSBpbml0U2VsZWN0b3IgaXMgZGVwcmVjYXRlZCBhcyBvZiAxLjQuMC4gSW4gMS41LjAgd2Ugd2lsbCB1c2UKCS8vIDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlc2V0Jykgd2hpY2ggd2lsbCBhbGxvdyB1cyB0byBnZXQgcmlkIG9mIHRoZSBsaW5lCgkvLyBiZWxvdyBhbHRvZ2V0aGVyLCBiZWNhdXNlIHRoZSBhdXRvaW5pdCB3aWxsIGdlbmVyYXRlIHN1Y2ggYW4gaW5pdFNlbGVjdG9yCglpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSw6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZXNldCcpIiwKCglvcHRpb25zOiAkLmV4dGVuZCggewoJCWVuaGFuY2VkOiBmYWxzZQoJfSwgJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHMgKSwKCglfaGFuZGxlQ29sbGFwc2libGVFeHBhbmQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgY2xvc2VzdENvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1jb2xsYXBzaWJsZSIgKTsKCgkJaWYgKCBjbG9zZXN0Q29sbGFwc2libGUucGFyZW50KCkuaXMoICI6bW9iaWxlLWNvbGxhcHNpYmxlc2V0LCA6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKSApIHsKCQkJY2xvc2VzdENvbGxhcHNpYmxlCgkJCQkuc2libGluZ3MoICIudWktY29sbGFwc2libGU6bm90KC51aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQpIiApCgkJCQkuY29sbGFwc2libGUoICJjb2xsYXBzZSIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY2xhc3NlczogIiIKCQl9KTsKCgkJaWYgKCAhb3B0cy5lbmhhbmNlZCApIHsKCQkJZWxlbS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktZ3JvdXAtdGhlbWUtIiwgb3B0cy50aGVtZSApICsgIiAiICsKCQkJCSggb3B0cy5jb3JuZXJzICYmIG9wdHMuaW5zZXQgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSApOwoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGUuY29sbGFwc2libGUuaW5pdFNlbGVjdG9yICkuY29sbGFwc2libGUoKTsKCQl9CgoJCXRoaXMuX29uKCBlbGVtLCB7IGNvbGxhcHNpYmxlZXhwYW5kOiAiX2hhbmRsZUNvbGxhcHNpYmxlRXhwYW5kIiB9ICk7Cgl9LAoKCV90aGVtZUNsYXNzRnJvbU9wdGlvbjogZnVuY3Rpb24oIHByZWZpeCwgdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6IHByZWZpeCArIHZhbHVlICkgOiAiIiApOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCggdHJ1ZSApOwoKCQkvLyBCZWNhdXNlIHRoZSBjb3JuZXJzIGFyZSBoYW5kbGVkIGJ5IHRoZSBjb2xsYXBzaWJsZSBpdHNlbGYgYW5kIHRoZSBkZWZhdWx0IHN0YXRlIGlzIGNvbGxhcHNlZAoJCS8vIFRoYXQgd2FzIGNhdXNpbmcgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80MTE2CgkJdGhpcy5lbGVtZW50CgkJCS5jaGlsZHJlbiggY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciApCgkJCS5maWx0ZXIoICI6anFtRGF0YShjb2xsYXBzZWQ9J2ZhbHNlJykiICkKCQkJLmNvbGxhcHNpYmxlKCAiZXhwYW5kIiApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJldCwgaGFzQ29ybmVycywKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJdGhlbWVDbGFzcyA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktZ3JvdXAtdGhlbWUtIiwgb3B0aW9ucy50aGVtZSApOwoKCQlpZiAoIHRoZW1lQ2xhc3MgKSB7CgkJCWVsZW0KCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCB0aGlzLm9wdGlvbnMudGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoZW1lQ2xhc3MgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5pbnNldCAhPT0gdW5kZWZpbmVkICkgewoJCQloYXNDb3JuZXJzID0gISEoIG9wdGlvbnMuaW5zZXQgJiYgKCBvcHRpb25zLmNvcm5lcnMgfHwgdGhpcy5vcHRpb25zLmNvcm5lcnMgKSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJaGFzQ29ybmVycyA9ICEhKCBvcHRpb25zLmNvcm5lcnMgJiYgKCBvcHRpb25zLmluc2V0IHx8IHRoaXMub3B0aW9ucy5pbnNldCApICk7CgkJfQoKCQlpZiAoIGhhc0Nvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBoYXNDb3JuZXJzICk7CgkJfQoKCQlyZXQgPSB0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJCXRoaXMuZWxlbWVudC5jaGlsZHJlbiggIjptb2JpbGUtY29sbGFwc2libGUiICkuY29sbGFwc2libGUoICJyZWZyZXNoIiApOwoJCXJldHVybiByZXQ7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCXRoaXMuX3JlbW92ZUZpcnN0TGFzdENsYXNzZXMoIGVsLmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICkgKTsKCQllbAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQgdWktY29ybmVyLWFsbCAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktZ3JvdXAtdGhlbWUtIiwgdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkuY2hpbGRyZW4oICI6bW9iaWxlLWNvbGxhcHNpYmxlIiApCgkJCS5jb2xsYXBzaWJsZSggImRlc3Ryb3kiICk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBjb2xsYXBzaWJsZXNJblNldCA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciApOwoKCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGUuY29sbGFwc2libGUuaW5pdFNlbGVjdG9yICkubm90KCAiLnVpLWNvbGxhcHNpYmxlIiApLmNvbGxhcHNpYmxlKCk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGNvbGxhcHNpYmxlc0luU2V0LCB0aGlzLl9nZXRWaXNpYmxlcyggY29sbGFwc2libGVzSW5TZXQsIGNyZWF0ZSApLCBjcmVhdGUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBEZXByZWNhdGVkIGluIDEuNAokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKC8qIG9wdGlvbnMgKi8pIHsKCXJldHVybiB0aGlzLmFkZENsYXNzKCAidWktZmllbGQtY29udGFpbiIgKTsKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5ncmlkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQlncmlkOiBudWxsCgkJCX0sIG9wdGlvbnMgKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHsgc29sbzoxLCBhOjIsIGI6MywgYzo0LCBkOjUgfSwKCQkJZ3JpZCA9IG8uZ3JpZCwKCQkJaXRlcmF0b3IsCgkJCWxldHRlcjsKCgkJCWlmICggIWdyaWQgKSB7CgkJCQlpZiAoICRraWRzLmxlbmd0aCA8PSA1ICkgewoJCQkJCWZvciAoIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLWR1byIgKTsKCQkJCX0KCQkJfQoJCQlpdGVyYXRvciA9IGdyaWRDb2xzW2dyaWRdOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtIiArIGdyaWQgKTsKCgkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisxKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWEiICk7CgoJCWlmICggaXRlcmF0b3IgPiAxICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzIpIiApLmFkZENsYXNzKCAidWktYmxvY2stYiIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDIgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMykiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1jIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMyApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis0KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWQiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiA0ICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzUpIiApLmFkZENsYXNzKCAidWktYmxvY2stZSIgKTsKCQl9Cgl9KTsKfTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCB7CglvcHRpb25zOiB7CgkJaWNvbnBvczogInRvcCIsCgkJZ3JpZDogbnVsbAoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/IHRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIiApCgkJCS5hdHRyKCAicm9sZSIsICJuYXZpZ2F0aW9uIiApCgkJCS5maW5kKCAidWwiICkKCQkJLmpxbUVuaGFuY2VhYmxlKCkKCQkJLmdyaWQoeyBncmlkOiB0aGlzLm9wdGlvbnMuZ3JpZCB9KTsKCgkJJG5hdmJ0bnMKCQkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIGljb24gPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJpY29uIiApLAoJCQkJCXRoZW1lID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAidGhlbWUiICksCgkJCQkJY2xhc3NlcyA9ICJ1aS1idG4iOwoKCQkJCWlmICggdGhlbWUgKSB7CgkJCQkJY2xhc3NlcyArPSAiIHVpLWJ0bi0iICsgdGhlbWU7CgkJCQl9CgkJCQlpZiAoIGljb24gKSB7CgkJCQkJY2xhc3NlcyArPSAiIHVpLWljb24tIiArIGljb24gKyAiIHVpLWJ0bi1pY29uLSIgKyBpY29ucG9zOwoJCQkJfQoJCQkJJCggdGhpcyApLmFkZENsYXNzKCBjbGFzc2VzICk7CgkJCX0pOwoKCQkkbmF2YmFyLmRlbGVnYXRlKCAiYSIsICJ2Y2xpY2siLCBmdW5jdGlvbiggLyogZXZlbnQgKi8gKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCB0aGlzICk7CgoJCQlpZiAoICEoIGFjdGl2ZUJ0bi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApIHx8CgoJCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSBhZnRlciAxLjQuMCByZWxlYXNlCgkJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJCWFjdGl2ZUJ0bi5oYXNDbGFzcyggInVpLWRpc2FibGVkIiApIHx8CgkJCQlhY3RpdmVCdG4uaGFzQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkgKSApIHsKCgkJCQkkbmF2YnRucy5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCWFjdGl2ZUJ0bi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvLyBUaGUgY29kZSBiZWxvdyBpcyBhIHdvcmthcm91bmQgdG8gZml4ICMxMTgxCgkJCQkkKCBkb2N1bWVudCApLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJYWN0aXZlQnRuLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfSk7CgkJCX0KCQl9KTsKCgkJLy8gQnV0dG9ucyBpbiB0aGUgbmF2YmFyIHdpdGggdWktc3RhdGUtcGVyc2lzdCBjbGFzcyBzaG91bGQgcmVnYWluIHRoZWlyIGFjdGl2ZSBzdGF0ZSBiZWZvcmUgcGFnZSBzaG93CgkJJG5hdmJhci5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCSRuYXZidG5zLmZpbHRlciggIi51aS1zdGF0ZS1wZXJzaXN0IiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGdldEF0dHIgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGU7CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQuZXh0ZW5kKCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6IG51bGwsIC8qIERlcHJlY2F0ZWQgaW4gMS40ICovCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWljb246ICJjYXJhdC1yIiwKCQlzcGxpdEljb246ICJjYXJhdC1yIiwKCQlzcGxpdFRoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWluc2V0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCIgOiAiIjsKCgkJaWYgKCAhIXQub3B0aW9ucy5pbnNldCApIHsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiOwoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCX0KCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyggIiB1aS1saXN0dmlldyIgKyBsaXN0dmlld0NsYXNzZXMgKTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUKCV9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBuZXh0UHJvcCwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS41CglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApIHsKCQl2YXIgaSwgaW1nLCBsZW4gPSBjb250YWluZXJzLmxlbmd0aDsKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlpbWcgPSAkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBjb250YWluZXJzWyBpIF0uZmlyc3RDaGlsZCwgIm5leHRTaWJsaW5nIiwgImltZyIsICJJTUciICkgKTsKCQkJaWYgKCBpbWcubGVuZ3RoICkgewoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmhhc0NsYXNzKCAidWktbGktaWNvbiIgKSA/ICJ1aS1saS1oYXMtaWNvbiIgOiAidWktbGktaGFzLXRodW1iIiApOwoJCQl9CgkJfQoJfSwKCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglfYmVmb3JlTGlzdHZpZXdSZWZyZXNoOiAkLm5vb3AsCglfYWZ0ZXJMaXN0dmlld1JlZnJlc2g6ICQubm9vcCwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBidXR0b25DbGFzcywgcG9zLCBudW1saSwgaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsIGl0ZW1JY29uLCBpY29uLCBhLAoJCQlpc0RpdmlkZXIsIHN0YXJ0Q291bnQsIG5ld1N0YXJ0Q291bnQsIHZhbHVlLCBsYXN0LCBzcGxpdHRoZW1lLCBzcGxpdFRoZW1lQ2xhc3MsIHNwbGl0aWNvbiwKCQkJYWx0QnV0dG9uQ2xhc3MsIGRpdmlkZXJUaGVtZSwgbGksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCSRsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlvbCA9ICEhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApLAoJCQlzdGFydCA9ICRsaXN0LmF0dHIoICJzdGFydCIgKSwKCQkJaXRlbUNsYXNzRGljdCA9IHt9LAoJCQljb3VudEJ1YmJsZXMgPSAkbGlzdC5maW5kKCAiLnVpLWxpLWNvdW50IiApLAoJCQljb3VudFRoZW1lID0gZ2V0QXR0ciggJGxpc3RbIDAgXSwgImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUsCgkJCWNvdW50VGhlbWVDbGFzcyA9IGNvdW50VGhlbWUgPyAidWktYm9keS0iICsgY291bnRUaGVtZSA6ICJ1aS1ib2R5LWluaGVyaXQiOwoKCQlpZiAoIG8udGhlbWUgKSB7CgkJCSRsaXN0LmFkZENsYXNzKCAidWktZ3JvdXAtdGhlbWUtIiArIG8udGhlbWUgKTsKCQl9CgoJCS8vIENoZWNrIGlmIGEgc3RhcnQgYXR0cmlidXRlIGhhcyBiZWVuIHNldCB3aGlsZSB0YWtpbmcgYSB2YWx1ZSBvZiAwIGludG8gYWNjb3VudAoJCWlmICggb2wgJiYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApICkgewoJCQlzdGFydENvdW50ID0gcGFyc2VJbnQoIHN0YXJ0LCAxMCApIC0gMTsKCQkJJGxpc3QuY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBzdGFydENvdW50ICk7CgkJfQoKCQl0aGlzLl9iZWZvcmVMaXN0dmlld1JlZnJlc2goKTsKCgkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApOwoKCQlmb3IgKCBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAiIjsKCgkJCWlmICggY3JlYXRlIHx8IGl0ZW1bIDAgXS5jbGFzc05hbWUuc2VhcmNoKCAvXGJ1aS1saS1zdGF0aWNcYnxcYnVpLWxpLWRpdmlkZXJcYi8gKSA8IDAgKSB7CgkJCQlhID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIGl0ZW1bIDAgXSwgImEiLCAiQSIgKTsKCQkJCWlzRGl2aWRlciA9ICggZ2V0QXR0ciggaXRlbVsgMCBdLCAicm9sZSIgKSA9PT0gImxpc3QtZGl2aWRlciIgKTsKCQkJCXZhbHVlID0gaXRlbS5hdHRyKCAidmFsdWUiICk7CgkJCQlpdGVtVGhlbWUgPSBnZXRBdHRyKCBpdGVtWyAwIF0sICJ0aGVtZSIgKTsKCgkJCQlpZiAoIGEubGVuZ3RoICYmIGFbIDAgXS5jbGFzc05hbWUuc2VhcmNoKCAvXGJ1aS1idG5cYi8gKSA8IDAgJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpdGVtSWNvbiA9IGdldEF0dHIoIGl0ZW1bIDAgXSwgImljb24iICk7CgkJCQkJaWNvbiA9ICggaXRlbUljb24gPT09IGZhbHNlICkgPyBmYWxzZSA6ICggaXRlbUljb24gfHwgby5pY29uICk7CgoJCQkJCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUgdG9nZXRoZXIgd2l0aCBsaW5rcy5qcyAobGlua3MuanMgLyAudWktbGluayBkZXByZWNhdGVkIGluIDEuNCkKCQkJCQlhLnJlbW92ZUNsYXNzKCAidWktbGluayIgKTsKCgkJCQkJYnV0dG9uQ2xhc3MgPSAidWktYnRuIjsKCgkJCQkJaWYgKCBpdGVtVGhlbWUgKSB7CgkJCQkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLSIgKyBpdGVtVGhlbWU7CgkJCQkJfQoKCQkJCQlpZiAoIGEubGVuZ3RoID4gMSApIHsKCQkJCQkJaXRlbUNsYXNzID0gInVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gZ2V0QXR0ciggbGFzdFsgMCBdLCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lIHx8IGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiwgdHJ1ZSApOwoJCQkJCQlzcGxpdFRoZW1lQ2xhc3MgPSBzcGxpdHRoZW1lID8gIiB1aS1idG4tIiArIHNwbGl0dGhlbWUgOiAiIjsKCQkJCQkJc3BsaXRpY29uID0gZ2V0QXR0ciggbGFzdFsgMCBdLCAiaWNvbiIgKSB8fCBnZXRBdHRyKCBpdGVtWyAwIF0sICJpY29uIiApIHx8IG8uc3BsaXRJY29uOwoJCQkJCQlhbHRCdXR0b25DbGFzcyA9ICJ1aS1idG4gdWktYnRuLWljb24tbm90ZXh0IHVpLWljb24tIiArIHNwbGl0aWNvbiArIHNwbGl0VGhlbWVDbGFzczsKCgkJCQkJCWxhc3QKCQkJCQkJCS5hdHRyKCAidGl0bGUiLCAkLnRyaW0oIGxhc3QuZ2V0RW5jb2RlZFRleHQoKSApICkKCQkJCQkJCS5hZGRDbGFzcyggYWx0QnV0dG9uQ2xhc3MgKQoJCQkJCQkJLmVtcHR5KCk7CgkJCQkJfSBlbHNlIGlmICggaWNvbiApIHsKCQkJCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taWNvbi1yaWdodCB1aS1pY29uLSIgKyBpY29uOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLmFkZENsYXNzKCBidXR0b25DbGFzcyApOwoJCQkJfSBlbHNlIGlmICggaXNEaXZpZGVyICkgewoJCQkJCWRpdmlkZXJUaGVtZSA9ICggZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUgfHwgby50aGVtZSApOwoKCQkJCQlpdGVtQ2xhc3MgPSAidWktbGktZGl2aWRlciB1aS1iYXItIiArICggZGl2aWRlclRoZW1lID8gZGl2aWRlclRoZW1lIDogImluaGVyaXQiICk7CgoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCQkJCX0gZWxzZSBpZiAoIGEubGVuZ3RoIDw9IDAgKSB7CgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLXN0YXRpYyB1aS1ib2R5LSIgKyAoIGl0ZW1UaGVtZSA/IGl0ZW1UaGVtZSA6ICJpbmhlcml0IiApOwoJCQkJfQoJCQkJaWYgKCBvbCAmJiB2YWx1ZSApIHsKCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VJbnQoIHZhbHVlICwgMTAgKSAtIDE7CgoJCQkJCWl0ZW0uY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBuZXdTdGFydENvdW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIEluc3RlYWQgb2Ygc2V0dGluZyBpdGVtIGNsYXNzIGRpcmVjdGx5IG9uIHRoZSBsaXN0IGl0ZW0KCQkJLy8gYXQgdGhpcyBwb2ludCBpbiB0aW1lLCBwdXNoIHRoZSBpdGVtIGludG8gYSBkaWN0aW9uYXJ5CgkJCS8vIHRoYXQgdGVsbHMgdXMgd2hhdCBjbGFzcyB0byBzZXQgb24gaXQgc28gd2UgY2FuIGRvIHRoaXMgYWZ0ZXIgdGhpcwoJCQkvLyBwcm9jZXNzaW5nIGxvb3AgaXMgZmluaXNoZWQuCgoJCQlpZiAoICFpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSApIHsKCQkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdID0gW107CgkJCX0KCgkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdLnB1c2goIGl0ZW1bIDAgXSApOwoJCX0KCgkJLy8gU2V0IHRoZSBhcHByb3ByaWF0ZSBsaXN0dmlldyBpdGVtIGNsYXNzZXMgb24gZWFjaCBsaXN0IGl0ZW0uCgkJLy8gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQljb3VudEJ1YmJsZXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJfSk7CgkJaWYgKCBjb3VudFRoZW1lQ2xhc3MgKSB7CgkJCWNvdW50QnViYmxlcy5hZGRDbGFzcyggY291bnRUaGVtZUNsYXNzICk7CgkJfQoKCQkvLyBEZXByZWNhdGVkIGluIDEuNC4gRnJvbSAxLjUgeW91IGhhdmUgdG8gYWRkIGNsYXNzIHVpLWxpLWhhcy10aHVtYiBvciB1aS1saS1oYXMtaWNvbiB0byB0aGUgTEkuCgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaSApOwoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkuZmluZCggIi51aS1idG4iICkgKTsKCgkJdGhpcy5fYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggbGksIHRoaXMuX2dldFZpc2libGVzKCBsaSwgY3JlYXRlICksIGNyZWF0ZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCmZ1bmN0aW9uIGRlZmF1bHRBdXRvZGl2aWRlcnNTZWxlY3RvciggZWx0ICkgewoJLy8gbG9vayBmb3IgdGhlIHRleHQgaW4gdGhlIGdpdmVuIGVsZW1lbnQKCXZhciB0ZXh0ID0gJC50cmltKCBlbHQudGV4dCgpICkgfHwgbnVsbDsKCglpZiAoICF0ZXh0ICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIGNyZWF0ZSB0aGUgdGV4dCBmb3IgdGhlIGRpdmlkZXIgKGZpcnN0IHVwcGVyY2FzZWQgbGV0dGVyKQoJdGV4dCA9IHRleHQuc2xpY2UoIDAsIDEgKS50b1VwcGVyQ2FzZSgpOwoKCXJldHVybiB0ZXh0Owp9CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLmxpc3R2aWV3LCB7CglvcHRpb25zOiB7CgkJYXV0b2RpdmlkZXJzOiBmYWxzZSwKCQlhdXRvZGl2aWRlcnNTZWxlY3RvcjogZGVmYXVsdEF1dG9kaXZpZGVyc1NlbGVjdG9yCgl9LAoKCV9iZWZvcmVMaXN0dmlld1JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmF1dG9kaXZpZGVycyApIHsKCQkJdGhpcy5fcmVwbGFjZURpdmlkZXJzKCk7CgkJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoJCX0KCX0sCgoJX3JlcGxhY2VEaXZpZGVyczogZnVuY3Rpb24oKSB7CgkJdmFyIGksIGxpcywgbGksIGRpdmlkZXJUZXh0LAoJCQlsYXN0RGl2aWRlclRleHQgPSBudWxsLAoJCQlsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlkaXZpZGVyOwoKCQlsaXN0LmNoaWxkcmVuKCAibGk6anFtRGF0YShyb2xlPSdsaXN0LWRpdmlkZXInKSIgKS5yZW1vdmUoKTsKCgkJbGlzID0gbGlzdC5jaGlsZHJlbiggImxpIiApOwoKCQlmb3IgKCBpID0gMDsgaSA8IGxpcy5sZW5ndGggOyBpKysgKSB7CgkJCWxpID0gbGlzWyBpIF07CgkJCWRpdmlkZXJUZXh0ID0gdGhpcy5vcHRpb25zLmF1dG9kaXZpZGVyc1NlbGVjdG9yKCAkKCBsaSApICk7CgoJCQlpZiAoIGRpdmlkZXJUZXh0ICYmIGxhc3REaXZpZGVyVGV4dCAhPT0gZGl2aWRlclRleHQgKSB7CgkJCQlkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxpIiApOwoJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGRpdmlkZXJUZXh0ICkgKTsKCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsICJsaXN0LWRpdmlkZXIiICk7CgkJCQlsaS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZGl2aWRlciwgbGkgKTsKCQkJfQoKCQkJbGFzdERpdmlkZXJUZXh0ID0gZGl2aWRlclRleHQ7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJkaXZpZGVyID0gLyhefFxzKXVpLWxpLWRpdmlkZXIoJHxccykvLAoJcmhpZGRlbiA9IC8oXnxccyl1aS1zY3JlZW4taGlkZGVuKCR8XHMpLzsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUubGlzdHZpZXcsIHsKCW9wdGlvbnM6IHsKCQloaWRlRGl2aWRlcnM6IGZhbHNlCgl9LAoKCV9hZnRlckxpc3R2aWV3UmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGl0ZW1zLCBpZHgsIGl0ZW0sIGhpZGVEaXZpZGVyID0gdHJ1ZTsKCgkJdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhpZGVEaXZpZGVycyApIHsKCQkJaXRlbXMgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggdGhpcy5lbGVtZW50WyAwIF0sICJsaSIsICJMSSIgKTsKCQkJZm9yICggaWR4ID0gaXRlbXMubGVuZ3RoIC0gMSA7IGlkeCA+IC0xIDsgaWR4LS0gKSB7CgkJCQlpdGVtID0gaXRlbXNbIGlkeCBdOwoJCQkJaWYgKCBpdGVtLmNsYXNzTmFtZS5tYXRjaCggcmRpdmlkZXIgKSApIHsKCQkJCQlpZiAoIGhpZGVEaXZpZGVyICkgewoJCQkJCQlpdGVtLmNsYXNzTmFtZSA9IGl0ZW0uY2xhc3NOYW1lICsgIiB1aS1zY3JlZW4taGlkZGVuIjsKCQkJCQl9CgkJCQkJaGlkZURpdmlkZXIgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQlpZiAoICFpdGVtLmNsYXNzTmFtZS5tYXRjaCggcmhpZGRlbiApICkgewoJCQkJCQloaWRlRGl2aWRlciA9IGZhbHNlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLm5vanMgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJJCggIjpqcW1EYXRhKHJvbGU9J25vanMnKSIsIHRhcmdldCApLmFkZENsYXNzKCAidWktbm9qcyIgKTsKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCA9IHsKCV9oYW5kbGVGb3JtUmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZGVsYXkoICJfcmVzZXQiICk7CgkJCX0KCQl9KTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgZXNjYXBlSWQgPSAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yOwoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQuZXh0ZW5kKCB7CgoJaW5pdFNlbGVjdG9yOiAiaW5wdXQ6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJyApIClbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcgKSkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogImluaGVyaXQiLAoJCW1pbmk6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJaWNvbnBvczogImxlZnQiCgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJaW5oZXJpdEF0dHIgPSBmdW5jdGlvbiggaW5wdXQsIGRhdGFBdHRyICkgewoJCQkJcmV0dXJuIGlucHV0LmpxbURhdGEoIGRhdGFBdHRyICkgfHwKCQkJCQlpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gaW5wdXQuY2xvc2VzdCggImxhYmVsIiApLAoJCQlsYWJlbCA9IHBhcmVudExhYmVsLmxlbmd0aCA/IHBhcmVudExhYmVsIDoKCQkJCWlucHV0CgkJCQkJLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkJCS5maW5kKCAibGFiZWwiICkKCQkJCQkuZmlsdGVyKCAiW2Zvcj0nIiArIGVzY2FwZUlkKCBpbnB1dFswXS5pZCApICsgIiddIiApCgkJCQkJLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyBpbnB1dHR5cGUgKyAiLW9mZiI7CgoJCWlmICggaW5wdXR0eXBlICE9PSAiY2hlY2tib3giICYmIGlucHV0dHlwZSAhPT0gInJhZGlvIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0aGlzLmVsZW1lbnRbMF0uZGlzYWJsZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlvLmljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApIHx8IGxhYmVsLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiApIHx8IG8uaWNvbnBvcywKCgkJLy8gRXN0YWJsaXNoIG9wdGlvbnMKCQlvLm1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaTsKCgkJLy8gRXhwb3NlIGZvciBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJaW5wdXQ6IGlucHV0LAoJCQlsYWJlbDogbGFiZWwsCgkJCXBhcmVudExhYmVsOiBwYXJlbnRMYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MKCQl9KTsKCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggbGFiZWwsIHsKCQkJdm1vdXNlb3ZlcjogIl9oYW5kbGVMYWJlbFZNb3VzZU92ZXIiLAoJCQl2Y2xpY2s6ICJfaGFuZGxlTGFiZWxWQ2xpY2siCgkJfSk7CgoJCXRoaXMuX29uKCBpbnB1dCwgewoJCQl2bW91c2Vkb3duOiAiX2NhY2hlVmFscyIsCgkJCXZjbGljazogIl9oYW5kbGVJbnB1dFZDbGljayIsCgkJCWZvY3VzOiAiX2hhbmRsZUlucHV0Rm9jdXMiLAoJCQlibHVyOiAiX2hhbmRsZUlucHV0Qmx1ciIKCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAidWktYnRuIHVpLWNvcm5lci1hbGwiKTsKCgkJaWYgKCB0aGlzLnBhcmVudExhYmVsLmxlbmd0aCA+IDAgKSB7CgkJCXRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICk7CgkJfSBlbHNlIHsKCQkJLy90aGlzLmVsZW1lbnQucmVwbGFjZVdpdGgoIHRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICkgKTsKCQkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX3dyYXBwZXIoKSApOwoJCQl0aGlzLmVsZW1lbnQucGFyZW50KCkucHJlcGVuZCggdGhpcy5sYWJlbCApOwoJCX0KCgkJLy8gV3JhcCB0aGUgaW5wdXQgKyBsYWJlbCBpbiBhIGRpdgoKCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJInRoZW1lIjogdGhpcy5vcHRpb25zLnRoZW1lLAoJCQkiaWNvbnBvcyI6IHRoaXMub3B0aW9ucy5pY29ucG9zLAoJCQkibWluaSI6IHRoaXMub3B0aW9ucy5taW5pCgkJfSk7CgoJfSwKCglfd3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSciICArCgkJCSggdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA/IHRoaXMub3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsKCQkJIiB1aS0iICsgdGhpcy5pbnB1dHR5cGUgKwoJCQkoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArICInID48L2Rpdj4iICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX2hhbmRsZUlucHV0VkNsaWNrOiBmdW5jdGlvbigpIHsKCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgdGhpcy5lbGVtZW50LmlzKCAiOmNoZWNrZWQiICkgKTsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLm5vdCggdGhpcy5lbGVtZW50ICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCXRoaXMuX3VwZGF0ZUFsbCgpOwoJfSwKCglfaGFuZGxlTGFiZWxWTW91c2VPdmVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLmxhYmVsLnBhcmVudCgpLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCX0sCgoJX2hhbmRsZUxhYmVsVkNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50OwoKCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9jYWNoZVZhbHMoKTsKCgkJaW5wdXQucHJvcCggImNoZWNrZWQiLCB0aGlzLmlucHV0dHlwZSA9PT0gInJhZGlvIiAmJiB0cnVlIHx8ICFpbnB1dC5wcm9wKCAiY2hlY2tlZCIgKSApOwoKCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCS8vIFRPRE86IGl0IHdvdWxkIGJlIG5pY2UgdG8gbGV0IHRoZSBicm93c2VyJ3MgaGFuZGxlIHRoZSBjbGlja3MgYW5kIHBhc3MgdGhlbQoJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJaW5wdXQudHJpZ2dlckhhbmRsZXIoICJjbGljayIgKTsKCgkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJLy8gb2Ygb3RoZXIgcmFkaW9zIGVuc3VyZXMgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUgaXMgYXBwbGllZCBwcm9wZXJseQoJCXRoaXMuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJdGhpcy5fdXBkYXRlQWxsKCk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfY2FjaGVWYWxzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuYXR0cigiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy8gUmV0dXJucyB0aG9zZSByYWRpbyBidXR0b25zIHRoYXQgYXJlIHN1cHBvc2VkIHRvIGJlIGluIHRoZSBzYW1lIGdyb3VwIGFzCgkvLyB0aGlzIHJhZGlvIGJ1dHRvbi4gSW4gdGhlIGNhc2Ugb2YgYSBjaGVja2JveCBvciBhIHJhZGlvIGxhY2tpbmcgYSBuYW1lCgkvLyBhdHRyaWJ1dGUsIGl0IHJldHVybnMgdGhpcy5lbGVtZW50LgoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0b3IsIGZvcm1JZCwKCQkJcmFkaW8gPSB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJbmFtZSA9IHJhZGlvLm5hbWUsCgkJCWZvcm0gPSByYWRpby5mb3JtLAoJCQlkb2MgPSB0aGlzLmVsZW1lbnQucGFyZW50cygpLmxhc3QoKS5nZXQoIDAgKSwKCgkJCS8vIEEgcmFkaW8gaXMgYWx3YXlzIGEgbWVtYmVyIG9mIGl0cyBvd24gZ3JvdXAKCQkJcmFkaW9zID0gdGhpcy5lbGVtZW50OwoKCQkvLyBPbmx5IHN0YXJ0IHJ1bm5pbmcgc2VsZWN0b3JzIGlmIHRoaXMgaXMgYW4gYXR0YWNoZWQgcmFkaW8gYnV0dG9uIHdpdGggYSBuYW1lCgkJaWYgKCBuYW1lICYmIHRoaXMuaW5wdXR0eXBlID09PSAicmFkaW8iICYmIGRvYyApIHsKCQkJc2VsZWN0b3IgPSAiaW5wdXRbdHlwZT0ncmFkaW8nXVtuYW1lPSciICsgZXNjYXBlSWQoIG5hbWUgKSArICInXSI7CgoJCQkvLyBJZiB3ZSdyZSBpbnNpZGUgYSBmb3JtCgkJCWlmICggZm9ybSApIHsKCQkJCWZvcm1JZCA9IGZvcm0uaWQ7CgoJCQkJLy8gSWYgdGhlIGZvcm0gaGFzIGFuIElELCBjb2xsZWN0IHJhZGlvcyBzY2F0dGVyZWQgdGhyb3VnaHQgdGhlIGRvY3VtZW50IHdoaWNoCgkJCQkvLyBuZXZlcnRoZWxlc3MgYXJlIHBhcnQgb2YgdGhlIGZvcm0gYnkgd2F5IG9mIHRoZSB2YWx1ZSBvZiB0aGVpciBmb3JtIGF0dHJpYnV0ZQoJCQkJaWYgKCBmb3JtSWQgKSB7CgkJCQkJcmFkaW9zID0gJCggc2VsZWN0b3IgKyAiW2Zvcm09JyIgKyBlc2NhcGVJZCggZm9ybUlkICkgKyAiJ10iLCBkb2MgKTsKCQkJCX0KCgkJCQkvLyBBbHNvIGFkZCB0byB0aG9zZSB0aGUgcmFkaW9zIGluIHRoZSBmb3JtIGl0c2VsZgoJCQkJcmFkaW9zID0gJCggZm9ybSApLmZpbmQoIHNlbGVjdG9yICkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCgkJCQkJLy8gU29tZSByYWRpb3MgaW5zaWRlIHRoZSBmb3JtIG1heSBiZWxvbmcgdG8gc29tZSBvdGhlciBmb3JtIGJ5IHZpcnR1ZSBvZgoJCQkJCS8vIGhhdmluZyBhIGZvcm0gYXR0cmlidXRlIGRlZmluZWQgb24gdGhlbSwgc28gd2UgbXVzdCBmaWx0ZXIgdGhlbSBvdXQgaGVyZQoJCQkJCXJldHVybiAoIHRoaXMuZm9ybSA9PT0gZm9ybSApOwoJCQkJfSkuYWRkKCByYWRpb3MgKTsKCgkJCS8vIElmIHdlJ3JlIG91dHNpZGUgYSBmb3JtCgkJCX0gZWxzZSB7CgoJCQkJLy8gQ29sbGVjdCBhbGwgdGhvc2UgcmFkaW9zIHdoaWNoIGFyZSBhbHNvIG91dHNpZGUgb2YgYSBmb3JtIGFuZCBtYXRjaCBvdXIgbmFtZQoJCQkJcmFkaW9zID0gJCggc2VsZWN0b3IsIGRvYyApLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICF0aGlzLmZvcm07CgkJCQl9KTsKCQkJfQoJCX0KCQlyZXR1cm4gcmFkaW9zOwoJfSwKCglfdXBkYXRlQWxsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggdGhpcy5jaGVja2VkIHx8IHNlbGYuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJJHRoaXMudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0pCgkJLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCgkvLyBJcyB0aGUgd2lkZ2V0IHN1cHBvc2VkIHRvIGRpc3BsYXkgYW4gaWNvbj8KCV9oYXNJY29uOiBmdW5jdGlvbigpIHsKCQl2YXIgY29udHJvbGdyb3VwLCBjb250cm9sZ3JvdXBXaWRnZXQsCgkJCWNvbnRyb2xncm91cENvbnN0cnVjdG9yID0gJC5tb2JpbGUuY29udHJvbGdyb3VwOwoKCQkvLyBJZiB0aGUgY29udHJvbGdyb3VwIHdpZGdldCBpcyBkZWZpbmVkIC4uLgoJCWlmICggY29udHJvbGdyb3VwQ29uc3RydWN0b3IgKSB7CgkJCWNvbnRyb2xncm91cCA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KAoJCQkJIjptb2JpbGUtY29udHJvbGdyb3VwLCIgKwoJCQkJY29udHJvbGdyb3VwQ29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciApOwoKCQkJLy8gLi4uIGFuZCB0aGUgY2hlY2tib3ggaXMgaW4gYSBjb250cm9sZ3JvdXAgLi4uCgkJCWlmICggY29udHJvbGdyb3VwLmxlbmd0aCA+IDAgKSB7CgoJCQkJLy8gLi4uIGxvb2sgZm9yIGEgY29udHJvbGdyb3VwIHdpZGdldCBpbnN0YW5jZSwgYW5kIC4uLgoJCQkJY29udHJvbGdyb3VwV2lkZ2V0ID0gJC5kYXRhKCBjb250cm9sZ3JvdXBbIDAgXSwgIm1vYmlsZS1jb250cm9sZ3JvdXAiICk7CgoJCQkJLy8gLi4uIGlmIGZvdW5kLCBkZWNpZGUgYmFzZWQgb24gdGhlIG9wdGlvbiB2YWx1ZSwgLi4uCgkJCQlyZXR1cm4gKCAoIGNvbnRyb2xncm91cFdpZGdldCA/IGNvbnRyb2xncm91cFdpZGdldC5vcHRpb25zLnR5cGUgOgoKCQkJCQkvLyAuLi4gb3RoZXJ3aXNlIGRlY2lkZSBiYXNlZCBvbiB0aGUgInR5cGUiIGRhdGEgYXR0cmlidXRlLgoJCQkJCWNvbnRyb2xncm91cC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIgKSApICE9PSAiaG9yaXpvbnRhbCIgKTsKCQkJfQoJCX0KCgkJLy8gTm9ybWFsbHksIHRoZSB3aWRnZXQgZGlzcGxheXMgYW4gaWNvbi4KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGhhc0ljb24gPSB0aGlzLl9oYXNJY29uKCksCgkJCWlzQ2hlY2tlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQsCgkJCWFjdGl2ZSA9ICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzLAoJCQlpY29ucG9zQ2xhc3MgPSAidWktYnRuLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29ucG9zLAoJCQlhZGRDbGFzc2VzID0gW10sCgkJCXJlbW92ZUNsYXNzZXMgPSBbXTsKCgkJaWYgKCBoYXNJY29uICkgewoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIGFjdGl2ZSApOwoJCQlhZGRDbGFzc2VzLnB1c2goIGljb25wb3NDbGFzcyApOwoJCX0gZWxzZSB7CgkJCXJlbW92ZUNsYXNzZXMucHVzaCggaWNvbnBvc0NsYXNzICk7CgkJCSggaXNDaGVja2VkID8gYWRkQ2xhc3NlcyA6IHJlbW92ZUNsYXNzZXMgKS5wdXNoKCBhY3RpdmUgKTsKCQl9CgoJCWlmICggaXNDaGVja2VkICkgewoJCQlhZGRDbGFzc2VzLnB1c2goIHRoaXMuY2hlY2tlZENsYXNzICk7CgkJCXJlbW92ZUNsYXNzZXMucHVzaCggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCX0gZWxzZSB7CgkJCWFkZENsYXNzZXMucHVzaCggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIHRoaXMuY2hlY2tlZENsYXNzICk7CgkJfQoKCQl0aGlzLmxhYmVsCgkJCS5hZGRDbGFzcyggYWRkQ2xhc3Nlcy5qb2luKCAiICIgKSApCgkJCS5yZW1vdmVDbGFzcyggcmVtb3ZlQ2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmxhYmVsLnBhcmVudCgpOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGxhYmVsID0gdGhpcy5sYWJlbCwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCW91dGVyID0gdGhpcy53aWRnZXQoKSwKCQkJaGFzSWNvbiA9IHRoaXMuX2hhc0ljb24oKTsKCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuaW5wdXQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISFvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWxhYmVsCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIGN1cnJlbnRPcHRpb25zLnRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMud3JhcHBlckNsYXNzICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyCgkJCQkucmVtb3ZlQ2xhc3MoIGN1cnJlbnRPcHRpb25zLndyYXBwZXJDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIG9wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoJCWlmICggb3B0aW9ucy5pY29ucG9zICE9PSB1bmRlZmluZWQgJiYgaGFzSWNvbiApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgY3VycmVudE9wdGlvbnMuaWNvbnBvcyApLmFkZENsYXNzKCAidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApOwoJCX0gZWxzZSBpZiAoICFoYXNJY29uICkgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggInVpLWJ0bi1pY29uLSIgKyBjdXJyZW50T3B0aW9ucy5pY29ucG9zICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9Cgp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuYnV0dG9uIiwgewoKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2J1dHRvbiddLCBpbnB1dFt0eXBlPSdzdWJtaXQnXSwgaW5wdXRbdHlwZT0ncmVzZXQnXSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogImxlZnQiLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbmxpbmU6IG51bGwsCgkJbWluaTogbnVsbCwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQlpZiAoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJd3JhcHBlcjogdGhpcy5lbGVtZW50LnBhcmVudCgpCgkJfSk7CgoJCXRoaXMuX29uKCB7CgkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSwKCgkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9CgkJfSk7CgoJCXRoaXMucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX2J1dHRvbigpICk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpY29uQ2xhc3NlcyA9IHRoaXMuX2dldEljb25DbGFzc2VzKCB0aGlzLm9wdGlvbnMgKTsKCgkJcmV0dXJuICQoIjxkaXYgY2xhc3M9J3VpLWJ0biB1aS1pbnB1dC1idG4iICsKCQkJKCBvcHRpb25zLndyYXBwZXJDbGFzcyA/ICIgIiArIG9wdGlvbnMud3JhcHBlckNsYXNzIDogIiIgKSArCgkJCSggb3B0aW9ucy50aGVtZSA/ICIgdWktYnRuLSIgKyBvcHRpb25zLnRoZW1lIDogIiIgKSArCgkJCSggb3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkgKwoJCQkoIG9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSArCgkJCSggb3B0aW9ucy5pbmxpbmUgPyAiIHVpLWJ0bi1pbmxpbmUiIDogIiIgKSArCgkJCSggb3B0aW9ucy5taW5pID8gIiB1aS1taW5pIiA6ICIiICkgKwoJCQkoIG9wdGlvbnMuZGlzYWJsZWQgPyAiIHVpLXN0YXRlLWRpc2FibGVkIiA6ICIiICkgKwoJCQkoIGljb25DbGFzc2VzID8gKCAiICIgKyBpY29uQ2xhc3NlcyApIDogIiIgKSArCgkJCSInID4iICsgdGhpcy5lbGVtZW50LnZhbCgpICsgIjwvZGl2PiIgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy53cmFwcGVyOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5pbnNlcnRCZWZvcmUoIHRoaXMuYnV0dG9uICk7CgkJCXRoaXMuYnV0dG9uLnJlbW92ZSgpOwoJfSwKCglfZ2V0SWNvbkNsYXNzZXM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXJldHVybiAoIG9wdGlvbnMuaWNvbiA/ICggInVpLWljb24tIiArIG9wdGlvbnMuaWNvbiArCgkJCSggb3B0aW9ucy5pY29uc2hhZG93ID8gIiB1aS1zaGFkb3ctaWNvbiIgOiAiIiApICsgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJCSIgdWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApIDogIiIgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvdXRlciA9IHRoaXMud2lkZ2V0KCk7CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmlubGluZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLWJ0bi1pbmxpbmUiLCBvcHRpb25zLmlubGluZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaWNvbiAhPT0gdW5kZWZpbmVkIHx8CgkJCQlvcHRpb25zLmljb25zaGFkb3cgIT09IHVuZGVmaW5lZCB8fCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQkJCW9wdGlvbnMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl9nZXRJY29uQ2xhc3NlcyggdGhpcy5vcHRpb25zICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl9nZXRJY29uQ2xhc3NlcygKCQkJCQkkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyApICkgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyIG9yaWdpbmFsRWxlbWVudCwKCQkJaXNEaXNhYmxlZCA9IHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICk7CgoJCWlmICggdGhpcy5vcHRpb25zLmljb24gJiYgdGhpcy5vcHRpb25zLmljb25wb3MgPT09ICJub3RleHQiICYmIHRoaXMuZWxlbWVudC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAidGl0bGUiLCB0aGlzLmVsZW1lbnQudmFsKCkgKTsKCQl9CgkJaWYgKCAhY3JlYXRlICkgewoJCQlvcmlnaW5hbEVsZW1lbnQgPSB0aGlzLmVsZW1lbnQuZGV0YWNoKCk7CgkJCSQoIHRoaXMud3JhcHBlciApLnRleHQoIHRoaXMuZWxlbWVudC52YWwoKSApLmFwcGVuZCggb3JpZ2luYWxFbGVtZW50ICk7CgkJfQoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICE9PSBpc0Rpc2FibGVkICkgewoJCQl0aGlzLl9zZXRPcHRpb25zKHsgZGlzYWJsZWQ6IGlzRGlzYWJsZWQgfSk7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCgkJaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAoJCWRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAoJCWVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCgkkLm1vYmlsZS56b29tID0gJC5leHRlbmQoIHt9LCB7CgkJZW5hYmxlZDogIWRpc2FibGVkSW5pdGlhbGx5LAoJCWxvY2tlZDogZmFsc2UsCgkJZGlzYWJsZTogZnVuY3Rpb24oIGxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICggISQubW9iaWxlLnpvb20ubG9ja2VkIHx8IHVubG9jayA9PT0gdHJ1ZSApICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGluaXRpYWxDb250ZW50ICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoJfSk7Cgp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsIHsKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwiICsKCQkiaW5wdXRbdHlwZT0nc2VhcmNoJ10sIiArCgkJIjpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCIgKwoJCSJpbnB1dFt0eXBlPSdudW1iZXInXSwiICsKCQkiOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIiArCgkJImlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIiArCgkJImlucHV0W3R5cGU9J2VtYWlsJ10sIiArCgkJImlucHV0W3R5cGU9J3VybCddLCIgKwoJCSJpbnB1dFt0eXBlPSd0ZWwnXSwiICsKCQkidGV4dGFyZWEsIiArCgkJImlucHV0W3R5cGU9J3RpbWUnXSwiICsKCQkiaW5wdXRbdHlwZT0nZGF0ZSddLCIgKwoJCSJpbnB1dFt0eXBlPSdtb250aCddLCIgKwoJCSJpbnB1dFt0eXBlPSd3ZWVrJ10sIiArCgkJImlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIiArCgkJImlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIiArCgkJImlucHV0W3R5cGU9J2NvbG9yJ10sIiArCgkJImlucHV0Om5vdChbdHlwZV0pLCIgKwoJCSJpbnB1dFt0eXBlPSdmaWxlJ10iLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJd3JhcHBlckNsYXNzOiAiIiwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpc1NlYXJjaCA9IHRoaXMuZWxlbWVudC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWlzVGV4dGFyZWEgPSB0aGlzLmVsZW1lbnRbIDAgXS50YWdOYW1lID09PSAiVEVYVEFSRUEiLAoJCQlpc1JhbmdlID0gdGhpcy5lbGVtZW50LmlzKCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ0eXBlPSdyYW5nZSddIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9ICggKHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApIHx8CgkJCQl0aGlzLmVsZW1lbnQuaXMoICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInR5cGU9J3NlYXJjaCddIiApICkgJiYKCQkJCQkhaXNSYW5nZSApOwoKCQlpZiAoIHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICkgKSB7CgkJCW9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJY2xhc3NlczogdGhpcy5fY2xhc3Nlc0Zyb21PcHRpb25zKCksCgkJCWlzU2VhcmNoOiBpc1NlYXJjaCwKCQkJaXNUZXh0YXJlYTogaXNUZXh0YXJlYSwKCQkJaXNSYW5nZTogaXNSYW5nZSwKCQkJaW5wdXROZWVkc1dyYXA6IGlucHV0TmVlZHNXcmFwCgkJfSk7CgoJCXRoaXMuX2F1dG9Db3JyZWN0KCk7CgoJCWlmICggIW9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCXRoaXMuX29uKCB7CgkJCSJmb2N1cyI6ICJfaGFuZGxlRm9jdXMiLAoJCQkiYmx1ciI6ICJfaGFuZGxlQmx1ciIKCQl9KTsKCgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0T3B0aW9ucyh7CgkJCSJkaXNhYmxlZCIgOiB0aGlzLmVsZW1lbnQuaXMoICI6ZGlzYWJsZWQiICkKCQl9KTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50Q2xhc3NlcyA9IFtdOwoKCQlpZiAoIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJZWxlbWVudENsYXNzZXMucHVzaCggInVpLWlucHV0LXRleHQiICk7CgkJfQoKCQlpZiAoIHRoaXMuaXNUZXh0YXJlYSB8fCB0aGlzLmlzUmFuZ2UgKSB7CgkJCWVsZW1lbnRDbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ctaW5zZXQiICk7CgkJfQoKCQkvLyJzZWFyY2giIGFuZCAidGV4dCIgaW5wdXQgd2lkZ2V0cwoJCWlmICggdGhpcy5pbnB1dE5lZWRzV3JhcCApIHsKCQkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX3dyYXAoKSApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnRDbGFzc2VzID0gZWxlbWVudENsYXNzZXMuY29uY2F0KCB0aGlzLmNsYXNzZXMgKTsKCQl9CgoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggZWxlbWVudENsYXNzZXMuam9pbiggIiAiICkgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLmlucHV0TmVlZHNXcmFwICkgPyB0aGlzLmVsZW1lbnQucGFyZW50KCkgOiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCV9jbGFzc2VzRnJvbU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQljbGFzc2VzID0gW107CgoJCWNsYXNzZXMucHVzaCggInVpLWJvZHktIiArICggKCBvcHRpb25zLnRoZW1lID09PSBudWxsICkgPyAiaW5oZXJpdCIgOiBvcHRpb25zLnRoZW1lICkgKTsKCQlpZiAoIG9wdGlvbnMuY29ybmVycyApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktY29ybmVyLWFsbCIgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLW1pbmkiICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktc3RhdGUtZGlzYWJsZWQiICk7CgkJfQoJCWlmICggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKSB7CgkJCWNsYXNzZXMucHVzaCggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgoJCXJldHVybiBjbGFzc2VzOwoJfSwKCglfd3JhcDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSciICsKCQkJKCB0aGlzLmlzU2VhcmNoID8gInVpLWlucHV0LXNlYXJjaCAiIDogInVpLWlucHV0LXRleHQgIiApICsKCQkJdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICsgIiAiICsKCQkJInVpLXNoYWRvdy1pbnNldCc+PC9kaXY+IiApOwoJfSwKCglfYXV0b0NvcnJlY3Q6IGZ1bmN0aW9uKCkgewoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LgoJCS8vICAgICAgLSBqYmxhcwoJCWlmICggdHlwZW9mIHRoaXMuZWxlbWVudFswXS5hdXRvY29ycmVjdCAhPT0gInVuZGVmaW5lZCIgJiYKCQkJISQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICkgewoKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCX0sCgoJX2hhbmRsZUJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMud2lkZ2V0KCkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCX0KCX0sCgoJX2hhbmRsZUZvY3VzOiBmdW5jdGlvbigpIHsKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgaW5wdXQgdXBvbiB0YXAsIHRoaXMKCQkvLyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJaWYgKCB0aGlzLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJfQoJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uICggb3B0aW9ucyApIHsKCQl2YXIgb3V0ZXIgPSB0aGlzLndpZGdldCgpOwoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQlpZiAoICEoIG9wdGlvbnMuZGlzYWJsZWQgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLm1pbmkgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLmNvcm5lcnMgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLnRoZW1lID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy53cmFwcGVyQ2xhc3MgPT09IHVuZGVmaW5lZCApICkgewoKCQkJb3V0ZXIucmVtb3ZlQ2xhc3MoIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJCQl0aGlzLmNsYXNzZXMgPSB0aGlzLl9jbGFzc2VzRnJvbU9wdGlvbnMoKTsKCQkJb3V0ZXIuYWRkQ2xhc3MoIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC51bndyYXAoKTsKCQl9CgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaW5wdXQtdGV4dCAiICsgdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zbGlkZXIiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiLAoKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQl0cmFja1RoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaGlnaGxpZ2h0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGNvbnRyb2xbIDAgXSwgInRoZW1lIiApLAoJCQl0cmFja1RoZW1lQ2xhc3MgPSB0cmFja1RoZW1lID8gIiB1aS1iYXItIiArIHRyYWNrVGhlbWUgOiAiIHVpLWJhci1pbmhlcml0IiwKCQkJY29ybmVyQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5jb3JuZXJzIHx8IGNvbnRyb2wuanFtRGF0YSggImNvcm5lcnMiICkgKSA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJbWluaUNsYXNzID0gKCB0aGlzLm9wdGlvbnMubWluaSB8fCBjb250cm9sLmpxbURhdGEoICJtaW5pIiApICkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzVG9nZ2xlU3dpdGNoID0gKCBjVHlwZSA9PT0gInNlbGVjdCIgKSwKCQkJaXNSYW5nZXNsaWRlciA9IGNvbnRyb2wucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiApLAoJCQlzZWxlY3RDbGFzcyA9ICggaXNUb2dnbGVTd2l0Y2ggKSA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICIiLAoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCQkJJGxhYmVsID0gJCggIltmb3I9JyIgKyBjb250cm9sSUQgKyAiJ10iICksCgkJCWxhYmVsSUQgPSAkbGFiZWwuYXR0ciggImlkIiApIHx8IGNvbnRyb2xJRCArICItbGFiZWwiLAoJCQltaW4gPSAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9ICAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCQkJc3RlcCA9IHdpbmRvdy5wYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApIHx8IDEgKSwKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCQkJdmFsdWViZyA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIWlzVG9nZ2xlU3dpdGNoID8gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfSkoKSA6IGZhbHNlLAoJCQlvcHRpb25zLAoJCQl3cmFwcGVyLAoJCQlqLCBsZW5ndGgsCgkJCWksIG9wdGlvbnNDb3VudCwgb3JpZ1RhYkluZGV4LAoJCQlzaWRlLCBhY3RpdmVDbGFzcywgc2xpZGVySW1nOwoKCQkkbGFiZWwuYXR0ciggImlkIiwgbGFiZWxJRCApOwoJCXRoaXMuaXNUb2dnbGVTd2l0Y2ggPSBpc1RvZ2dsZVN3aXRjaDsKCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJhcHBsaWNhdGlvbiIgKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0ICIgOiAidWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCAiLCBzZWxlY3RDbGFzcywgdHJhY2tUaGVtZUNsYXNzLCBjb3JuZXJDbGFzcywgbWluaUNsYXNzIF0uam9pbiggIiIgKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gInVpLXNsaWRlci1oYW5kbGUiOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggZG9tSGFuZGxlICk7CgoJCWhhbmRsZS5hdHRyKHsKCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJImFyaWEtdmFsdWVtaW4iOiBtaW4sCgkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkiYXJpYS12YWx1ZW5vdyI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLXZhbHVldGV4dCI6IHRoaXMuX3ZhbHVlKCksCgkJCSJ0aXRsZSI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNsaWRlcjogc2xpZGVyLAoJCQloYW5kbGU6IGhhbmRsZSwKCQkJY29udHJvbDogY29udHJvbCwKCQkJdHlwZTogY1R5cGUsCgkJCXN0ZXA6IHN0ZXAsCgkJCW1heDogbWF4LAoJCQltaW46IG1pbiwKCQkJdmFsdWViZzogdmFsdWViZywKCQkJaXNSYW5nZXNsaWRlcjogaXNSYW5nZXNsaWRlciwKCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQliZWZvcmVTdGFydDogbnVsbCwKCQkJdXNlck1vZGlmaWVkOiBmYWxzZSwKCQkJbW91c2VNb3ZlZDogZmFsc2UKCQl9KTsKCgkJaWYgKCBpc1RvZ2dsZVN3aXRjaCApIHsKCQkJLy8gVE9ETzogcmVzdG9yZSBvcmlnaW5hbCB0YWJpbmRleCAoaWYgYW55KSBpbiBhIGRlc3Ryb3kgbWV0aG9kCgkJCW9yaWdUYWJJbmRleCA9IGNvbnRyb2wuYXR0ciggInRhYmluZGV4IiApOwoJCQlpZiAoIG9yaWdUYWJJbmRleCApIHsKCQkJCWhhbmRsZS5hdHRyKCAidGFiaW5kZXgiLCBvcmlnVGFiSW5kZXggKTsKCQkJfQoJCQljb250cm9sLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQloYW5kbGUuZm9jdXMoKTsKCQkJfSk7CgoJCQl3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAidWktc2xpZGVyLWlubmVyb2Zmc2V0IjsKCgkJCWZvciAoIGogPSAwLCBsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7IGogPCBsZW5ndGg7IGorKyApIHsKCQkJCXdyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdICk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggd3JhcHBlciApOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yICggaSA9IDAsIG9wdGlvbnNDb3VudCA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgb3B0aW9uc0NvdW50OyBpKysgKSB7CgkJCQlzaWRlID0gIWkgPyAiYiIgOiAiYSI7CgkJCQlhY3RpdmVDbGFzcyA9ICFpID8gIiIgOiAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbICJ1aS1zbGlkZXItbGFiZWwgdWktc2xpZGVyLWxhYmVsLSIsIHNpZGUsIGFjdGl2ZUNsYXNzIF0uam9pbiggIiIgKTsKCQkJCXNsaWRlckltZy5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImltZyIgKTsKCQkJCXNsaWRlckltZy5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdGlvbnNbaV0uaW5uZXJIVE1MICkgKTsKCQkJCSQoIHNsaWRlckltZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyLXN3aXRjaCIgOiAidWktc2xpZGVyLWlucHV0IiApOwoKCQl0aGlzLl9vbiggY29udHJvbCwgewoJCQkiY2hhbmdlIjogIl9jb250cm9sQ2hhbmdlIiwKCQkJImtleXVwIjogIl9jb250cm9sS2V5dXAiLAoJCQkiYmx1ciI6ICJfY29udHJvbEJsdXIiLAoJCQkidm1vdXNldXAiOiAiX2NvbnRyb2xWTW91c2VVcCIKCQl9KTsKCgkJc2xpZGVyLmJpbmQoICJ2bW91c2Vkb3duIiwgJC5wcm94eSggdGhpcy5fc2xpZGVyVk1vdXNlRG93biwgdGhpcyApICkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQkvLyBXZSBoYXZlIHRvIGluc3RhbnRpYXRlIGEgbmV3IGZ1bmN0aW9uIG9iamVjdCBmb3IgdGhlIHVuYmluZCB0byB3b3JrIHByb3Blcmx5CgkJLy8gc2luY2UgdGhlIG1ldGhvZCBpdHNlbGYgaXMgZGVmaW5lZCBpbiB0aGUgcHJvdG90eXBlIChjYXVzaW5nIGl0IHRvIHVuYmluZCBldmVyeXRoaW5nKQoJCXRoaXMuX29uKCBkb2N1bWVudCwgeyAidm1vdXNlbW92ZSI6ICJfcHJldmVudERvY3VtZW50RHJhZyIgfSk7CgkJdGhpcy5fb24oIHNsaWRlci5hZGQoIGRvY3VtZW50ICksIHsgInZtb3VzZXVwIjogIl9zbGlkZXJWTW91c2VVcCIgfSk7CgoJCXNsaWRlci5pbnNlcnRBZnRlciggY29udHJvbCApOwoKCQkvLyB3cmFwIGluIGEgZGl2IGZvciBzdHlsaW5nIHB1cnBvc2VzCgkJaWYgKCAhaXNUb2dnbGVTd2l0Y2ggJiYgIWlzUmFuZ2VzbGlkZXIgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLm9wdGlvbnMubWluaSA/ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXIgdWktbWluaSc+IiA6ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXInPiI7CgoJCQljb250cm9sLmFkZCggc2xpZGVyICkud3JhcEFsbCggd3JhcHBlciApOwoJCX0KCgkJLy8gYmluZCB0aGUgaGFuZGxlIGV2ZW50IGNhbGxiYWNrcyBhbmQgc2V0IHRoZSBjb250ZXh0IHRvIHRoZSB3aWRnZXQgaW5zdGFuY2UKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGUsIHsKCQkJInZtb3VzZWRvd24iOiAiX2hhbmRsZVZNb3VzZURvd24iLAoJCQkia2V5ZG93biI6ICJfaGFuZGxlS2V5ZG93biIsCgkJCSJrZXl1cCI6ICJfaGFuZGxlS2V5dXAiCgkJfSk7CgoJCXRoaXMuaGFuZGxlLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRoZW1lKCBvcHRpb25zLnRoZW1lICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMudHJhY2tUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUcmFja1RoZW1lKCBvcHRpb25zLnRyYWNrVGhlbWUgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldENvcm5lcnMoIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0TWluaSggb3B0aW9ucy5taW5pICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaGlnaGxpZ2h0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldEhpZ2hsaWdodCggb3B0aW9ucy5oaWdobGlnaHQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXREaXNhYmxlZCggb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfY29udHJvbENoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIGlmIHRoZSB1c2VyIGRyYWdnZWQgdGhlIGhhbmRsZSwgdGhlICJjaGFuZ2UiIGV2ZW50IHdhcyB0cmlnZ2VyZWQgZnJvbSBpbnNpZGUgcmVmcmVzaCgpOyBkb24ndCBjYWxsIHJlZnJlc2goKSBhZ2FpbgoJCWlmICggdGhpcy5fdHJpZ2dlciggImNvbnRyb2xjaGFuZ2UiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoICF0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJCX0KCX0sCgoJX2NvbnRyb2xLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsgLy8gbmVjZXNzYXJ5PwoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSwgdHJ1ZSApOwoJfSwKCglfY29udHJvbEJsdXI6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7Cgl9LAoKCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkvLyBibHVycmVkLiBIZXJlIHdlIGNoZWNrIHRoaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkIGFuZCByZWZyZXNoCglfY29udHJvbFZNb3VzZVVwOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMuX2NoZWNrZWRSZWZyZXNoKCk7Cgl9LAoKCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCglfaGFuZGxlVk1vdXNlRG93bjogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLmhhbmRsZS5mb2N1cygpOwoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpbmRleCA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQlpZiAoICF0aGlzLl9rZXlTbGlkaW5nICkgewoJCQkJCXRoaXMuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOyAvKiBUT0RPOiBXZSBkb24ndCB1c2UgdGhpcyBjbGFzcyBmb3Igc3R5bGluZy4gRG8gd2UgbmVlZCB0byBhZGQgaXQ/ICovCgkJCQl9CgoJCQkJYnJlYWs7CgkJfQoKCQkvLyBtb3ZlIHRoZSBzbGlkZXIgYWNjb3JkaW5nIHRvIHRoZSBrZXlwcmVzcwoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1pbiApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWF4ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCArIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggLSB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCX0KCX0sIC8vIHJlbW92ZSBhY3RpdmUgbWFyawoKCV9oYW5kbGVLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQlpZiAoIHRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7IC8qIFNlZSBjb21tZW50IGFib3ZlLiAqLwoJCX0KCX0sCgoJX3NsaWRlclZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhKCBldmVudC53aGljaCA9PT0gMSB8fCBldmVudC53aGljaCA9PT0gMCB8fCBldmVudC53aGljaCA9PT0gdW5kZWZpbmVkICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3Jlc3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCQl0aGlzLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuYmVmb3JlU3RhcnQgPSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQl9CgoJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiICk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfc2xpZGVyVk1vdXNlVXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5kcmFnZ2luZyApIHsKCQkJdGhpcy5kcmFnZ2luZyA9IGZhbHNlOwoKCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQkJaWYgKCB0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJaWYgKCB0aGlzLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfcHJldmVudERvY3VtZW50RHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggdGhpcy5fdHJpZ2dlciggImRyYWciLCBldmVudCApID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggdGhpcy5kcmFnZ2luZyAmJiAhdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoKCQkJCS8vIHRoaXMubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJdGhpcy5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgdGhpcy51c2VyTW9kaWZpZWQKCQkJCXRoaXMudXNlck1vZGlmaWVkID0gdGhpcy5iZWZvcmVTdGFydCAhPT0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCV9jaGVja2VkUmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnZhbHVlICE9PSB0aGlzLl92YWx1ZSgpICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCkgKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXggOiBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQudmFsKCkgKSA7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIGZhbHNlLCB0cnVlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCB2YWwsIGlzZnJvbUNvbnRyb2wsIHByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCByZXR1cm4gaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gc3VwcG9ydCBwcm9ncmFtbWF0aWMKCQkvLyAgICAgICBhbHRlcmF0aW9uIG9mIHRoZSBpbnB1dCB2YWx1ZSwgd2hpY2ggc2hvdWxkIHN0aWxsIHVwZGF0ZSB0aGUgc2xpZGVyCgoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFsgMCBdLCAidGhlbWUiICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0aGVtZUNsYXNzID0gIHRoZW1lID8gIiB1aS1idG4tIiArIHRoZW1lIDogIiIsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdHJhY2tUaGVtZUNsYXNzID0gdHJhY2tUaGVtZSA/ICIgdWktYmFyLSIgKyB0cmFja1RoZW1lIDogIiB1aS1iYXItaW5oZXJpdCIsCgkJCWNvcm5lckNsYXNzID0gdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCW1pbmlDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gIiB1aS1taW5pIiA6ICIiLAoJCQlsZWZ0LCB3aWR0aCwgZGF0YSwgdG9sLAoJCQlweFN0ZXAsIHBlcmNlbnQsCgkJCWNvbnRyb2wsIGlzSW5wdXQsIG9wdGlvbkVsZW1lbnRzLCBtaW4sIG1heCwgc3RlcCwKCQkJbmV3dmFsLCB2YWxNb2RTdGVwLCBhbGlnblZhbHVlLCBwZXJjZW50UGVyU3RlcCwKCQkJaGFuZGxlUGVyY2VudCwgYVBlcmNlbnQsIGJQZXJjZW50LAoJCQl2YWx1ZUNoYW5nZWQ7CgoJCXNlbGYuc2xpZGVyWzBdLmNsYXNzTmFtZSA9IFsgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgdWktc2xpZGVyLXN3aXRjaCB1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0IiA6ICJ1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0IiwgdHJhY2tUaGVtZUNsYXNzLCBjb3JuZXJDbGFzcywgbWluaUNsYXNzIF0uam9pbiggIiIgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIHNldCB0aGUgc3RvcmVkIHZhbHVlIGZvciBjb21wYXJpc29uIGxhdGVyCgkJdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmIHRoaXMuc2xpZGVyLmZpbmQoICIudWktc2xpZGVyLWJnIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy52YWx1ZWJnID0gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzZWxmLnNsaWRlciApOwoJCQl9KSgpOwoJCX0KCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLWJ0biIgKyB0aGVtZUNsYXNzICsgIiB1aS1zaGFkb3ciICk7CgoJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQ7CgkJaXNJbnB1dCA9ICF0aGlzLmlzVG9nZ2xlU3dpdGNoOwoJCW9wdGlvbkVsZW1lbnRzID0gaXNJbnB1dCA/IFtdIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoJCW1pbiA9ICBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwOwoJCW1heCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IG9wdGlvbkVsZW1lbnRzLmxlbmd0aCAtIDE7CgkJc3RlcCA9ICggaXNJbnB1dCAmJiBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgPiAwICkgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgOiAxOwoKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICkgewoJCQlkYXRhID0gdmFsOwoJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCXRvbCA9IDg7CgoJCQlsZWZ0ID0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdDsKCQkJd2lkdGggPSB0aGlzLnNsaWRlci53aWR0aCgpOwoJCQlweFN0ZXAgPSB3aWR0aC8oKG1heC1taW4pL3N0ZXApOwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IGxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gbGVmdCArIHdpZHRoICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggcHhTdGVwID4gMSApIHsKCQkJCXBlcmNlbnQgPSAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDA7CgkJCX0gZWxzZSB7CgkJCQlwZXJjZW50ID0gTWF0aC5yb3VuZCggKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQluZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YWxNb2RTdGVwID0gKCBuZXd2YWwgLSBtaW4gKSAlIHN0ZXA7CgkJYWxpZ25WYWx1ZSA9IG5ld3ZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCgkJcGVyY2VudFBlclN0ZXAgPSAxMDAvKChtYXgtbWluKS9zdGVwKTsKCQkvLyBTaW5jZSBKYXZhU2NyaXB0IGhhcyBwcm9ibGVtcyB3aXRoIGxhcmdlIGZsb2F0cywgcm91bmQKCQkvLyB0aGUgZmluYWwgdmFsdWUgdG8gNSBkaWdpdHMgYWZ0ZXIgdGhlIGRlY2ltYWwgcG9pbnQgKHNlZSBqUXVlcnlVSTogIzQxMjQpCgkJbmV3dmFsID0gcGFyc2VGbG9hdCggYWxpZ25WYWx1ZS50b0ZpeGVkKDUpICk7CgoJCWlmICggdHlwZW9mIHB4U3RlcCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCXB4U3RlcCA9IHdpZHRoIC8gKCAobWF4LW1pbikgLyBzdGVwICk7CgkJfQoJCWlmICggcHhTdGVwID4gMSAmJiBpc0lucHV0ICkgewoJCQlwZXJjZW50ID0gKCBuZXd2YWwgLSBtaW4gKSAqIHBlcmNlbnRQZXJTdGVwICogKCAxIC8gc3RlcCApOwoJCX0KCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCWlmICggbmV3dmFsIDwgbWluICkgewoJCQluZXd2YWwgPSBtaW47CgkJfQoKCQlpZiAoIG5ld3ZhbCA+IG1heCApIHsKCQkJbmV3dmFsID0gbWF4OwoJCX0KCgkJdGhpcy5oYW5kbGUuY3NzKCAibGVmdCIsIHBlcmNlbnQgKyAiJSIgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZW5vdyIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWV0ZXh0IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggInRpdGxlIiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCWlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgkJfQoKCQkvLyBkcmFnIHRoZSBsYWJlbCB3aWR0aHMKCQlpZiAoIHRoaXMuX2xhYmVscyApIHsKCQkJaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwOwoJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMDsKCQkJYlBlcmNlbnQgPSBwZXJjZW50ID09PSAxMDAgPyAwIDogTWF0aC5taW4oIGhhbmRsZVBlcmNlbnQgKyAxMDAgLSBhUGVyY2VudCwgMTAwICk7CgoJCQl0aGlzLl9sYWJlbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBhYiA9ICQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggaXNJbnB1dCApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjaGFuZ2UiLCB2YWwgKSA9PT0gZmFsc2UpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCV9zZXRIaWdobGlnaHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCB2YWx1ZSApIHsKCQkJdGhpcy5vcHRpb25zLmhpZ2hsaWdodCA9ICEhdmFsdWU7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0gZWxzZSBpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLnJlbW92ZSgpOwoJCQl0aGlzLnZhbHVlYmcgPSBmYWxzZTsKCQl9Cgl9LAoKCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuaGFuZGxlCgkJCS5yZW1vdmVDbGFzcyggInVpLWJ0bi0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyB2YWx1ZSApOwoKCQl2YXIgY3VycmVudFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQluZXdUaGVtZSA9IHZhbHVlID8gdmFsdWUgOiAiaW5oZXJpdCI7CgoJCXRoaXMuY29udHJvbAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBuZXdUaGVtZSApOwoJfSwKCglfc2V0VHJhY2tUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBjdXJyZW50VHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lID8gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgOiAiaW5oZXJpdCIsCgkJCW5ld1RyYWNrVGhlbWUgPSB2YWx1ZSA/IHZhbHVlIDogImluaGVyaXQiOwoKCQl0aGlzLnNsaWRlcgoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VHJhY2tUaGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIG5ld1RyYWNrVGhlbWUgKTsKCX0sCgoJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiAhdGhpcy5pc1Jhbmdlc2xpZGVyICkgewoJCQl0aGlzLnNsaWRlci5wYXJlbnQoKS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQl9CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCX0sCgoJX3NldENvcm5lcnM6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmNvbnRyb2wudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9Cgl9LAoKCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhbHVlID0gISF2YWx1ZTsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLnNsaWRlcgoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIHZhbHVlICkKCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcG9wdXA7CgpmdW5jdGlvbiBnZXRQb3B1cCgpIHsKCWlmICggIXBvcHVwICkgewoJCXBvcHVwID0gJCggIjxkaXY+PC9kaXY+IiwgewoJCQkiY2xhc3MiOiAidWktc2xpZGVyLXBvcHVwIHVpLXNoYWRvdyB1aS1jb3JuZXItYWxsIgoJCX0pOwoJfQoJcmV0dXJuIHBvcHVwLmNsb25lKCk7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLnNsaWRlciwgewoJb3B0aW9uczogewoJCXBvcHVwRW5hYmxlZDogZmFsc2UsCgkJc2hvd1ZhbHVlOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3VycmVudFZhbHVlOiBudWxsLAoJCQlfcG9wdXA6IG51bGwsCgkJCV9wb3B1cFZpc2libGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldE9wdGlvbiggInBvcHVwRW5hYmxlZCIsIHRoaXMub3B0aW9ucy5wb3B1cEVuYWJsZWQgKTsKCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7ICJ2bW91c2Vkb3duIiA6ICJfc2hvd1BvcHVwIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMuc2xpZGVyLmFkZCggdGhpcy5kb2N1bWVudCApLCB7ICJ2bW91c2V1cCIgOiAiX2hpZGVQb3B1cCIgfSApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJLy8gcG9zaXRpb24gdGhlIHBvcHVwIGNlbnRlcmVkIDVweCBhYm92ZSB0aGUgaGFuZGxlCglfcG9zaXRpb25Qb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIGRzdE9mZnNldCA9IHRoaXMuaGFuZGxlLm9mZnNldCgpOwoKCQl0aGlzLl9wb3B1cC5vZmZzZXQoIHsKCQkJbGVmdDogZHN0T2Zmc2V0LmxlZnQgKyAoIHRoaXMuaGFuZGxlLndpZHRoKCkgLSB0aGlzLl9wb3B1cC53aWR0aCgpICkgLyAyLAoJCQl0b3A6IGRzdE9mZnNldC50b3AgLSB0aGlzLl9wb3B1cC5vdXRlckhlaWdodCgpIC0gNQoJCX0pOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gInNob3dWYWx1ZSIgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoIHZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSA/IHRoaXMuX3ZhbHVlKCkgOiAiIiApOwoJCX0gZWxzZSBpZiAoIGtleSA9PT0gInBvcHVwRW5hYmxlZCIgKSB7CgkJCWlmICggdmFsdWUgJiYgIXRoaXMuX3BvcHVwICkgewoJCQkJdGhpcy5fcG9wdXAgPSBnZXRQb3B1cCgpCgkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgfHwgImEiICkgKQoJCQkJCS5oaWRlKCkKCQkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsKCQkJfQoJCX0KCX0sCgoJLy8gc2hvdyB2YWx1ZSBvbiB0aGUgaGFuZGxlIGFuZCBpbiBwb3B1cAoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zLCBuZXdWYWx1ZTsKCgkJaWYgKCBvLnBvcHVwRW5hYmxlZCApIHsKCQkJLy8gcmVtb3ZlIHRoZSB0aXRsZSBhdHRyaWJ1dGUgZnJvbSB0aGUgaGFuZGxlICh3aGljaCBpcwoJCQkvLyByZXNwb25zaWJsZSBmb3IgdGhlIGFubm95aW5nIHRvb2x0aXApOyBOQiB3ZSBoYXZlCgkJCS8vIHRvIGRvIGl0IGhlcmUgYXMgdGhlIGpxbSBzbGlkZXIgc2V0cyBpdCBldmVyeSB0aW1lCgkJCS8vIHRoZSBzbGlkZXIncyB2YWx1ZSBjaGFuZ2VzIDooCgkJCXRoaXMuaGFuZGxlLnJlbW92ZUF0dHIoICJ0aXRsZSIgKTsKCQl9CgoJCW5ld1ZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIG5ld1ZhbHVlID09PSB0aGlzLl9jdXJyZW50VmFsdWUgKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fY3VycmVudFZhbHVlID0gbmV3VmFsdWU7CgoJCWlmICggby5wb3B1cEVuYWJsZWQgJiYgdGhpcy5fcG9wdXAgKSB7CgkJCXRoaXMuX3Bvc2l0aW9uUG9wdXAoKTsKCQkJdGhpcy5fcG9wdXAuaHRtbCggbmV3VmFsdWUgKTsKCQl9IGVsc2UgaWYgKCBvLnNob3dWYWx1ZSAmJiAhdGhpcy5vcHRpb25zLm1pbmkgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoIG5ld1ZhbHVlICk7CgkJfQoJfSwKCglfc2hvd1BvcHVwOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5wb3B1cEVuYWJsZWQgJiYgIXRoaXMuX3BvcHVwVmlzaWJsZSApIHsKCQkJdGhpcy5oYW5kbGUuaHRtbCggIiIgKTsKCQkJdGhpcy5fcG9wdXAuc2hvdygpOwoJCQl0aGlzLl9wb3NpdGlvblBvcHVwKCk7CgkJCXRoaXMuX3BvcHVwVmlzaWJsZSA9IHRydWU7CgkJfQoJfSwKCglfaGlkZVBvcHVwOiBmdW5jdGlvbigpIHsKCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvLnBvcHVwRW5hYmxlZCAmJiB0aGlzLl9wb3B1cFZpc2libGUgKSB7CgkJCWlmICggby5zaG93VmFsdWUgJiYgIW8ubWluaSApIHsKCQkJCXRoaXMuaGFuZGxlLmh0bWwoIHRoaXMuX3ZhbHVlKCkgKTsKCQkJfQoJCQl0aGlzLl9wb3B1cC5oaWRlKCk7CgkJCXRoaXMuX3BvcHVwVmlzaWJsZSA9IGZhbHNlOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmZsaXBzd2l0Y2giLCAkLmV4dGVuZCh7CgoJb3B0aW9uczogewoJCW9uVGV4dDogIk9uIiwKCQlvZmZUZXh0OiAiT2ZmIiwKCQl0aGVtZTogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJd3JhcHBlckNsYXNzOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJCXRoaXMuX2VuaGFuY2UoKTsKCQkJfSBlbHNlIHsKCQkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQkJZmxpcHN3aXRjaDogdGhpcy5lbGVtZW50LnBhcmVudCgpLAoJCQkJCW9uOiB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1mbGlwc3dpdGNoLW9uIiApLmVxKCAwICksCgkJCQkJb2ZmOiB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1mbGlwc3dpdGNoLW9mZiIgKS5lcSgwKSwKCQkJCQl0eXBlOiB0aGlzLmVsZW1lbnQuZ2V0KCAwICkudGFnTmFtZQoJCQkJfSk7CgkJCX0KCgkJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQkJLy8gVHJhbnNmZXIgdGFiaW5kZXggdG8gIm9uIiBlbGVtZW50IGFuZCBtYWtlIGlucHV0IHVuZm9jdXNhYmxlCgkJCXRoaXMuX29yaWdpbmFsVGFiSW5kZXggPSB0aGlzLmVsZW1lbnQuYXR0ciggInRhYmluZGV4IiApOwoJCQlpZiAoIHRoaXMuX29yaWdpbmFsVGFiSW5kZXggIT0gbnVsbCApIHsKCQkJCXRoaXMub24uYXR0ciggInRhYmluZGV4IiwgdGhpcy5fb3JpZ2luYWxUYWJJbmRleCApOwoJCQl9CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCXRoaXMuX29uKHsKCQkJCSJmb2N1cyIgOiAiX2hhbmRsZUlucHV0Rm9jdXMiCgkJCX0pOwoKCQkJaWYgKCB0aGlzLmVsZW1lbnQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJCQkiZGlzYWJsZWQiOiB0cnVlCgkJCQl9KTsKCQkJfQoKCQkJdGhpcy5fb24oIHRoaXMuZmxpcHN3aXRjaCwgewoJCQkJImNsaWNrIjogIl90b2dnbGUiLAoJCQkJInN3aXBlbGVmdCI6ICJfbGVmdCIsCgkJCQkic3dpcGVyaWdodCI6ICJfcmlnaHQiCgkJCX0pOwoKCQkJdGhpcy5fb24oIHRoaXMub24sIHsKCQkJCSJrZXlkb3duIjogIl9rZXlkb3duIgoJCQl9KTsKCgkJCXRoaXMuX29uKCB7CgkJCQkiY2hhbmdlIjogInJlZnJlc2giCgkJCX0pOwoJfSwKCglfaGFuZGxlSW5wdXRGb2N1czogZnVuY3Rpb24oKSB7CgkJdGhpcy5vbi5mb2N1cygpOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmZsaXBzd2l0Y2g7Cgl9LAoKCV9sZWZ0OiBmdW5jdGlvbigpIHsKCQl0aGlzLmZsaXBzd2l0Y2gucmVtb3ZlQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKTsKCQlpZiAoIHRoaXMudHlwZSA9PT0gIlNFTEVDVCIgKSB7CgkJCXRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID0gMDsKCQl9IGVsc2UgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCX0KCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNoYW5nZSIgKTsKCX0sCgoJX3JpZ2h0OiBmdW5jdGlvbigpIHsKCQl0aGlzLmZsaXBzd2l0Y2guYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKTsKCQlpZiAoIHRoaXMudHlwZSA9PT0gIlNFTEVDVCIgKSB7CgkJCXRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID0gMTsKCQl9IGVsc2UgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImNoZWNrZWQiLCB0cnVlICk7CgkJfQoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGZsaXBzd2l0Y2ggPSAkKCAiPGRpdj4iICksCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCXRoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgoJCQkvLyBUaGUgIm9uIiBidXR0b24gaXMgYW4gYW5jaG9yIHNvIGl0J3MgZm9jdXNhYmxlCgkJCW9uID0gJCggIjxhPjwvYT4iLCB7CgkJCQkiaHJlZiI6ICIjIgoJCQl9KSwKCQkJb2ZmID0gJCggIjxzcGFuPjwvc3Bhbj4iICksCgkJCXR5cGUgPSBlbGVtZW50LmdldCggMCApLnRhZ05hbWUsCgkJCW9uVGV4dCA9ICggdHlwZSA9PT0gIklOUFVUIiApID8KCQkJCW9wdGlvbnMub25UZXh0IDogZWxlbWVudC5maW5kKCAib3B0aW9uIiApLmVxKCAxICkudGV4dCgpLAoJCQlvZmZUZXh0ID0gKCB0eXBlID09PSAiSU5QVVQiICkgPwoJCQkJb3B0aW9ucy5vZmZUZXh0IDogZWxlbWVudC5maW5kKCAib3B0aW9uIiApLmVxKCAwICkudGV4dCgpOwoKCQkJb24KCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtb24gdWktYnRuIHVpLXNoYWRvdyB1aS1idG4taW5oZXJpdCIgKQoJCQkJLnRleHQoIG9uVGV4dCApOwoJCQlvZmYKCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtb2ZmIiApCgkJCQkudGV4dCggb2ZmVGV4dCApOwoKCQkJZmxpcHN3aXRjaAoJCQkJLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaCB1aS1zaGFkb3ctaW5zZXQgIiArCgkJCQkJInVpLWJhci0iICsgdGhlbWUgKyAiICIgKwoJCQkJCSggb3B0aW9ucy53cmFwcGVyQ2xhc3MgPyBvcHRpb25zLndyYXBwZXJDbGFzcyA6ICIiICkgKyAiICIgKwoJCQkJCSggKCBlbGVtZW50LmlzKCAiOmNoZWNrZWQiICkgfHwKCQkJCQkJZWxlbWVudAoJCQkJCQkJLmZpbmQoICJvcHRpb24iICkKCQkJCQkJCS5lcSggMSApCgkJCQkJCQkuaXMoICI6c2VsZWN0ZWQiICkgKSA/ICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgOiAiIiApICsKCQkJCQkoIGVsZW1lbnQuaXMoIjpkaXNhYmxlZCIpID8gIiB1aS1zdGF0ZS1kaXNhYmxlZCI6ICIiKSArCgkJCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiOiAiIiApICsKCQkJCQkoIG9wdGlvbnMubWluaSA/ICIgdWktbWluaSI6ICIiICkgKQoJCQkJLmFwcGVuZCggb24sIG9mZiApOwoKCQkJZWxlbWVudAoJCQkJLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1pbnB1dCIgKQoJCQkJLmFmdGVyKCBmbGlwc3dpdGNoICkKCQkJCS5hcHBlbmRUbyggZmxpcHN3aXRjaCApOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlmbGlwc3dpdGNoOiBmbGlwc3dpdGNoLAoJCQlvbjogb24sCgkJCW9mZjogb2ZmLAoJCQl0eXBlOiB0eXBlCgkJfSk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBkaXJlY3Rpb24sCgkJCWV4aXN0aW5nRGlyZWN0aW9uID0gdGhpcy5mbGlwc3dpdGNoLmhhc0NsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICkgPyAiX3JpZ2h0IiA6ICJfbGVmdCI7CgoJCWlmICggdGhpcy50eXBlID09PSAiU0VMRUNUIiApIHsKCQkJZGlyZWN0aW9uID0gKCB0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA+IDAgKSA/ICJfcmlnaHQiOiAiX2xlZnQiOwoJCX0gZWxzZSB7CgkJCWRpcmVjdGlvbiA9IHRoaXMuZWxlbWVudC5wcm9wKCAiY2hlY2tlZCIgKSA/ICJfcmlnaHQiOiAiX2xlZnQiOwoJCX0KCgkJaWYgKCBkaXJlY3Rpb24gIT09IGV4aXN0aW5nRGlyZWN0aW9uICkgewoJCQl0aGlzWyBkaXJlY3Rpb24gXSgpOwoJCX0KCX0sCgoJX3RvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdmFyIGRpcmVjdGlvbiA9IHRoaXMuZmxpcHN3aXRjaC5oYXNDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApID8gIl9sZWZ0IiA6ICJfcmlnaHQiOwoKCQl0aGlzWyBkaXJlY3Rpb24gXSgpOwoJfSwKCglfa2V5ZG93bjogZnVuY3Rpb24oIGUgKSB7CgkJaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQgKSB7CgkJCXRoaXMuX2xlZnQoKTsKCQl9IGVsc2UgaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUICkgewoJCQl0aGlzLl9yaWdodCgpOwoJCX0gZWxzZSBpZiAoIGUud2hpY2ggPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UgKSB7CgkJCXRoaXMuX3RvZ2dsZSgpOwoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXZhciBjdXJyZW50VGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJCW5ld1RoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCI7CgoJCQl0aGlzLndpZGdldCgpCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1iYXItIiArIG5ld1RoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5vblRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vbi50ZXh0KCBvcHRpb25zLm9uVGV4dCApOwoJCX0KCQlpZiAoIG9wdGlvbnMub2ZmVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLm9mZi50ZXh0KCBvcHRpb25zLm9mZlRleHQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuX29yaWdpbmFsVGFiSW5kZXggIT0gbnVsbCApIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJ0YWJpbmRleCIsIHRoaXMuX29yaWdpbmFsVGFiSW5kZXggKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoJCX0KCQl0aGlzLm9uLnJlbW92ZSgpOwoJCXRoaXMub2ZmLnJlbW92ZSgpOwoJCXRoaXMuZWxlbWVudC51bndyYXAoKTsKCQl0aGlzLmZsaXBzd2l0Y2gucmVtb3ZlKCk7CgkJdGhpcy5yZW1vdmVDbGFzcyggInVpLWZsaXBzd2l0Y2gtaW5wdXQiICk7Cgl9Cgp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC53aWRnZXQoICJtb2JpbGUucmFuZ2VzbGlkZXIiLCAkLmV4dGVuZCggewoKCQlvcHRpb25zOiB7CgkJCXRoZW1lOiBudWxsLAoJCQl0cmFja1RoZW1lOiBudWxsLAoJCQljb3JuZXJzOiB0cnVlLAoJCQltaW5pOiBmYWxzZSwKCQkJaGlnaGxpZ2h0OiB0cnVlCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWVsQ2xhc3MgPSB0aGlzLm9wdGlvbnMubWluaSA/ICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiA6ICJ1aS1yYW5nZXNsaWRlciIsCgkJCV9pbnB1dEZpcnN0ID0gJGVsLmZpbmQoICJpbnB1dCIgKS5maXJzdCgpLAoJCQlfaW5wdXRMYXN0ID0gJGVsLmZpbmQoICJpbnB1dCIgKS5sYXN0KCksCgkJCV9sYWJlbCA9ICRlbC5maW5kKCAibGFiZWwiICkuZmlyc3QoKSwKCQkJX3NsaWRlcldpZGdldEZpcnN0ID0gJC5kYXRhKCBfaW5wdXRGaXJzdC5nZXQoIDAgKSwgIm1vYmlsZS1zbGlkZXIiICkgfHwKCQkJCSQuZGF0YSggX2lucHV0Rmlyc3Quc2xpZGVyKCkuZ2V0KCAwICksICJtb2JpbGUtc2xpZGVyIiApLAoJCQlfc2xpZGVyV2lkZ2V0TGFzdCA9ICQuZGF0YSggX2lucHV0TGFzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApIHx8CgkJCQkkLmRhdGEoIF9pbnB1dExhc3Quc2xpZGVyKCkuZ2V0KCAwICksICJtb2JpbGUtc2xpZGVyIiApLAoJCQlfc2xpZGVyRmlyc3QgPSBfc2xpZGVyV2lkZ2V0Rmlyc3Quc2xpZGVyLAoJCQlfc2xpZGVyTGFzdCA9IF9zbGlkZXJXaWRnZXRMYXN0LnNsaWRlciwKCQkJZmlyc3RIYW5kbGUgPSBfc2xpZGVyV2lkZ2V0Rmlyc3QuaGFuZGxlLAoJCQlfc2xpZGVycyA9ICQoICI8ZGl2IGNsYXNzPSd1aS1yYW5nZXNsaWRlci1zbGlkZXJzJyAvPiIgKS5hcHBlbmRUbyggJGVsICk7CgoJCQlfaW5wdXRGaXJzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IiApOwoJCQlfaW5wdXRMYXN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItbGFzdCIgKTsKCQkJJGVsLmFkZENsYXNzKCBlbENsYXNzICk7CgoJCQlfc2xpZGVyRmlyc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCV9zbGlkZXJMYXN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfbGFiZWwuaW5zZXJ0QmVmb3JlKCAkZWwgKTsKCQkJZmlyc3RIYW5kbGUucHJlcGVuZFRvKCBfc2xpZGVyTGFzdCApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbnB1dEZpcnN0OiBfaW5wdXRGaXJzdCwKCQkJCV9pbnB1dExhc3Q6IF9pbnB1dExhc3QsCgkJCQlfc2xpZGVyRmlyc3Q6IF9zbGlkZXJGaXJzdCwKCQkJCV9zbGlkZXJMYXN0OiBfc2xpZGVyTGFzdCwKCQkJCV9sYWJlbDogX2xhYmVsLAoJCQkJX3RhcmdldFZhbDogbnVsbCwKCQkJCV9zbGlkZXJUYXJnZXQ6IGZhbHNlLAoJCQkJX3NsaWRlcnM6IF9zbGlkZXJzLAoJCQkJX3Byb3h5OiBmYWxzZQoJCQl9KTsKCgkJCXRoaXMucmVmcmVzaCgpOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dC51aS1zbGlkZXItaW5wdXQiICksIHsKCQkJCSJzbGlkZWJlZm9yZXN0YXJ0IjogIl9zbGlkZWJlZm9yZXN0YXJ0IiwKCQkJCSJzbGlkZXN0b3AiOiAiX3NsaWRlc3RvcCIsCgkJCQkic2xpZGVkcmFnIjogIl9zbGlkZWRyYWciLAoJCQkJInNsaWRlYmVmb3JlY2hhbmdlIjogIl9jaGFuZ2UiLAoJCQkJImJsdXIiOiAiX2NoYW5nZSIsCgkJCQkia2V5dXAiOiAiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKHsKCQkJCSJtb3VzZWRvd24iOiJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQkJInJlc2V0IjoiX2hhbmRsZVJlc2V0IgoJCQl9KTsKCQkJdGhpcy5fb24oIGZpcnN0SGFuZGxlLCB7CgkJCQkidm1vdXNlZG93biI6ICJfZHJhZ0ZpcnN0SGFuZGxlIgoJCQl9KTsKCQl9LAoJCV9oYW5kbGVSZXNldDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy93ZSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYmVmb3JlIHVwZGF0ZWluZyBvdGhlciB3aXNlIHNsaWRlcnMgd2lsbCBub3QgaGF2ZSB1cGRhdGVkIHlldAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQl9LDApOwoJCX0sCgoJCV9kcmFnRmlyc3RIYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy9pZiB0aGUgZmlyc3QgaGFuZGxlIGlzIGRyYWdnZWQgc2VuZCB0aGUgZXZlbnQgdG8gdGhlIGZpcnN0IHNsaWRlcgoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9LAoKCQlfc2xpZGVkcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICksCgkJCQlvdGhlclNsaWRlciA9ICggZmlyc3QgKSA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgZHJhZyB3YXMgaW5pdGlhdGVkIG9uIGFuIGV4dHJlbWUgYW5kIHRoZSBvdGhlciBoYW5kbGUgaXMgZm9jdXNlZCBzZW5kIHRoZSBldmVudHMgdG8KCQkJLy90aGUgY2xvc2VzdCBoYW5kbGUKCQkJaWYgKCAoIHRoaXMuX3Byb3h5ID09PSAiZmlyc3QiICYmIGZpcnN0ICkgfHwgKCB0aGlzLl9wcm94eSA9PT0gImxhc3QiICYmICFmaXJzdCApICkgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3NsaWRlc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApOwoKCQkJdGhpcy5fcHJveHkgPSBmYWxzZTsKCQkJLy90aGlzIHN0b3BzIGRyYWdnaW5nIG9mIHRoZSBoYW5kbGUgYW5kIGJyaW5ncyB0aGUgYWN0aXZlIHRyYWNrIHRvIHRoZSBmcm9udAoJCQkvL3RoaXMgbWFrZXMgY2xpY2tzIG9uIHRoZSB0cmFjayBnbyB0aGUgdGhlIGxhc3QgaGFuZGxlIHVzZWQKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS50cmlnZ2VyKCAidm1vdXNldXAiICk7CgkJCXRoaXMuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/IDEgOiAiIiApOwoJCX0sCgoJCV9zbGlkZWJlZm9yZXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSB0cmFjayBpcyB0aGUgdGFyZ2V0IHJlbWVtYmVyIHRoaXMgYW5kIHRoZSBvcmlnaW5hbCB2YWx1ZQoJCQlpZiAoICQoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1zbGlkZXItdHJhY2siICkgKSB7CgkJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSB0cnVlOwoJCQkJdGhpcy5fdGFyZ2V0VmFsID0gJCggZXZlbnQudGFyZ2V0ICkudmFsKCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0VGhlbWUoIG9wdGlvbnMudGhlbWUgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLnRyYWNrVGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldFRyYWNrVGhlbWUoIG9wdGlvbnMudHJhY2tUaGVtZSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0TWluaSggb3B0aW9ucy5taW5pICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy5oaWdobGlnaHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldEhpZ2hsaWdodCggb3B0aW9ucy5oaWdobGlnaHQgKTsKCQkJfQoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCQlpZiAoIHRoaXMuX2lucHV0Rmlyc3QuaXMoICI6ZGlzYWJsZWQiICkgfHwgdGhpcy5faW5wdXRMYXN0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQkJfQoKCQkJJGVsLmZpbmQoICJpbnB1dCIgKS5zbGlkZXIoewoJCQkJdGhlbWU6IG8udGhlbWUsCgkJCQl0cmFja1RoZW1lOiBvLnRyYWNrVGhlbWUsCgkJCQlkaXNhYmxlZDogby5kaXNhYmxlZCwKCQkJCWNvcm5lcnM6IG8uY29ybmVycywKCQkJCW1pbmk6IG8ubWluaSwKCQkJCWhpZ2hsaWdodDogby5oaWdobGlnaHQKCQkJfSkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJfSwKCgkJX2NoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoIGV2ZW50LnR5cGUgPT09ICJrZXl1cCIgKSB7CgkJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbWluID0gcGFyc2VGbG9hdCggdGhpcy5faW5wdXRGaXJzdC52YWwoKSwgMTAgKSwKCQkJCW1heCA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0TGFzdC52YWwoKSwgMTAgKSwKCQkJCWZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKSwKCQkJCXRoaXNTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0Rmlyc3QgOiB0aGlzLl9pbnB1dExhc3QsCgkJCQlvdGhlclNsaWRlciA9IGZpcnN0ID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCgkJCWlmICggKCB0aGlzLl9pbnB1dEZpcnN0LnZhbCgpID4gdGhpcy5faW5wdXRMYXN0LnZhbCgpICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICYmICEkKGV2ZW50LnRhcmdldCkuaGFzQ2xhc3MoInVpLXNsaWRlci1oYW5kbGUiKSkgKSB7CgkJCQl0aGlzU2xpZGVyLmJsdXIoKTsKCQkJfSBlbHNlIGlmICggZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBtaW4gPiBtYXggJiYgIXRoaXMuX3NsaWRlclRhcmdldCApIHsKCQkJCS8vdGhpcyBwcmV2ZW50cyBtaW4gZnJvbSBiZWluZyBncmVhdGVyIHRoZW4gbWF4CgkJCQl0aGlzU2xpZGVyLnZhbCggZmlyc3QgPyBtYXg6IG1pbiApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQl0aGlzLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQl9IGVsc2UgaWYgKCBtaW4gPiBtYXggKSB7CgkJCQkvL3RoaXMgbWFrZXMgaXQgc28gY2xpY2tzIG9uIHRoZSB0YXJnZXQgb24gZWl0aGVyIGV4dHJlbWUgZ28gdG8gdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCQl0aGlzU2xpZGVyLnZhbCggdGhpcy5fdGFyZ2V0VmFsICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCgkJCQkvL1lvdSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgc28gZmlyc3Qgc2xpZGVyIGlzIHVwZGF0ZWQgYmVmb3JlIHVwZGF0aW5nIHNlY29uZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJb3RoZXJTbGlkZXIudmFsKCBmaXJzdCA/IG1pbjogbWF4ICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmZvY3VzKCk7CgkJCQkJc2VsZi5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gIiIgOiAxICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJCX0sIDAgKTsKCQkJCXRoaXMuX3Byb3h5ID0gKCBmaXJzdCApID8gImZpcnN0IiA6ICJsYXN0IjsKCQkJfQoJCQkvL2ZpeGVzIGlzc3VlIHdoZXJlIHdoZW4gYm90aCBfc2xpZGVycyBhcmUgYXQgbWluIHRoZXkgY2Fubm90IGJlIGFkanVzdGVkCgkJCWlmICggbWluID09PSBtYXggKSB7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDEgKTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDAgKTsKCQkJfSBlbHNlIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCX0KCgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoKCQkJaWYgKCBtaW4gPj0gbWF4ICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3VwZGF0ZUhpZ2hsaWdodDogZnVuY3Rpb24oKSB7CgkJCXZhciBtaW4gPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJbWF4ID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJd2lkdGggPSAobWF4IC0gbWluKTsKCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5jc3MoewoJCQkJIm1hcmdpbi1sZWZ0IjogbWluICsgIiUiLAoJCQkJIndpZHRoIjogd2lkdGggKyAiJSIKCQkJfSk7CgkJfSwKCgkJX3NldFRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgInRoZW1lIiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJ0aGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldFRyYWNrVGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW1pbmkiLCAhIXZhbHVlICk7CgkJfSwKCgkJX3NldEhpZ2hsaWdodDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJoaWdobGlnaHQiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgImhpZ2hsaWdodCIsIHZhbHVlICk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9sYWJlbC5wcmVwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiApOwoJCQl0aGlzLl9pbnB1dEZpcnN0LmFmdGVyKCB0aGlzLl9zbGlkZXJGaXJzdCApOwoJCQl0aGlzLl9pbnB1dExhc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckxhc3QgKTsKCQkJdGhpcy5fc2xpZGVycy5yZW1vdmUoKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IHVpLXJhbmdlc2xpZGVyLWxhc3QiICkuc2xpZGVyKCAiZGVzdHJveSIgKTsKCQl9CgoJfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS50ZXh0aW5wdXQsIHsKCQlvcHRpb25zOiB7CgkJCWNsZWFyQnRuOiBmYWxzZSwKCQkJY2xlYXJCdG5UZXh0OiAiQ2xlYXIgdGV4dCIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCgkJCWlmICggISF0aGlzLm9wdGlvbnMuY2xlYXJCdG4gfHwgdGhpcy5pc1NlYXJjaCApIHsKCQkJCXRoaXMuX2FkZENsZWFyQnRuKCk7CgkJCX0KCQl9LAoKCQljbGVhckJ1dHRvbjogZnVuY3Rpb24oKSB7CgoJCQlyZXR1cm4gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1pbnB1dC1jbGVhciB1aS1idG4gdWktaWNvbi1kZWxldGUgdWktYnRuLWljb24tbm90ZXh0IHVpLWNvcm5lci1hbGwiICsKICAgICInIHRpdGxlPSciICsgdGhpcy5vcHRpb25zLmNsZWFyQnRuVGV4dCArICInPiIgKyB0aGlzLm9wdGlvbnMuY2xlYXJCdG5UZXh0ICsgIjwvYT4iICk7CgoJCX0sCgoJCV9jbGVhckJ0bkNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXRoaXMuZWxlbWVudC52YWwoICIiICkKCQkJCQkuZm9jdXMoKQoJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoKCQkJdGhpcy5fY2xlYXJCdG4uYWRkQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSwKCgkJX2FkZENsZWFyQnRuOiBmdW5jdGlvbigpIHsKCgkJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJCXRoaXMuX2VuaGFuY2VDbGVhcigpOwoJCQl9CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2NsZWFyQnRuOiB0aGlzLndpZGdldCgpLmZpbmQoImEudWktaW5wdXQtY2xlYXIiKQoJCQl9KTsKCgkJCXRoaXMuX2JpbmRDbGVhckV2ZW50cygpOwoKCQkJdGhpcy5fdG9nZ2xlQ2xlYXIoKTsKCgkJfSwKCgkJX2VuaGFuY2VDbGVhcjogZnVuY3Rpb24oKSB7CgoJCQl0aGlzLmNsZWFyQnV0dG9uKCkuYXBwZW5kVG8oIHRoaXMud2lkZ2V0KCkgKTsKCQkJdGhpcy53aWRnZXQoKS5hZGRDbGFzcyggInVpLWlucHV0LWhhcy1jbGVhciIgKTsKCgkJfSwKCgkJX2JpbmRDbGVhckV2ZW50czogZnVuY3Rpb24oKSB7CgoJCQl0aGlzLl9vbiggdGhpcy5fY2xlYXJCdG4sIHsKCQkJCSJjbGljayI6ICJfY2xlYXJCdG5DbGljayIKCQkJfSk7CgoJCQl0aGlzLl9vbih7CgkJCQkia2V5dXAiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJjaGFuZ2UiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJpbnB1dCI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImZvY3VzIjogIl90b2dnbGVDbGVhciIsCgkJCQkiYmx1ciI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImN1dCI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJInBhc3RlIjogIl90b2dnbGVDbGVhciIKCgkJCX0pOwoKCQl9LAoKCQlfdW5iaW5kQ2xlYXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9vZmYoIHRoaXMuX2NsZWFyQnRuLCAiY2xpY2siKTsKCQkJdGhpcy5fb2ZmKCB0aGlzLmVsZW1lbnQsICJrZXl1cCBjaGFuZ2UgaW5wdXQgZm9jdXMgYmx1ciBjdXQgcGFzdGUiICk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkJaWYgKCBvcHRpb25zLmNsZWFyQnRuICE9PSB1bmRlZmluZWQgJiYKCQkJCSF0aGlzLmVsZW1lbnQuaXMoICJ0ZXh0YXJlYSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSApIHsKCQkJCWlmICggb3B0aW9ucy5jbGVhckJ0biApIHsKCQkJCQl0aGlzLl9hZGRDbGVhckJ0bigpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl9kZXN0cm95Q2xlYXIoKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvcHRpb25zLmNsZWFyQnRuVGV4dCAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX2NsZWFyQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9jbGVhckJ0bi50ZXh0KCBvcHRpb25zLmNsZWFyQnRuVGV4dCApCgkJCQkJLmF0dHIoInRpdGxlIiwgb3B0aW9ucy5jbGVhckJ0blRleHQpOwoJCQl9CgkJfSwKCgkJX3RvZ2dsZUNsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fZGVsYXkoICJfdG9nZ2xlQ2xlYXJDbGFzcyIsIDAgKTsKCQl9LAoKCQlfdG9nZ2xlQ2xlYXJDbGFzczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2NsZWFyQnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIXRoaXMuZWxlbWVudC52YWwoKSApOwoJCX0sCgoJCV9kZXN0cm95Q2xlYXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoJCQl0aGlzLl91bmJpbmRDbGVhcigpOwoJCQl0aGlzLl9jbGVhckJ0bi5yZW1vdmUoKTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCXRoaXMuX2Rlc3Ryb3lDbGVhcigpOwoJCX0KCgl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsICQubW9iaWxlLnRleHRpbnB1dCwgewoJCW9wdGlvbnM6IHsKCQkJYXV0b2dyb3c6dHJ1ZSwKCQkJa2V5dXBUaW1lb3V0QnVmZmVyOiAxMDAKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLmF1dG9ncm93ICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCXRoaXMuX2F1dG9ncm93KCk7CgkJCX0KCQl9LAoKCQlfYXV0b2dyb3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ciICk7CgoJCQl0aGlzLl9vbih7CgkJCQkia2V5dXAiOiAiX3RpbWVvdXQiLAoJCQkJImNoYW5nZSI6ICJfdGltZW91dCIsCgkJCQkiaW5wdXQiOiAiX3RpbWVvdXQiLAoJCQkJInBhc3RlIjogIl90aW1lb3V0IgoJCQl9KTsKCgkJCS8vIEF0dGFjaCB0byB0aGUgdmFyaW91cyB5b3UtaGF2ZS1iZWNvbWUtdmlzaWJsZSBub3RpZmljYXRpb25zIHRoYXQgdGhlCgkJCS8vIHZhcmlvdXMgZnJhbWV3b3JrIGVsZW1lbnRzIGVtaXQuCgkJCS8vIFRPRE86IFJlbW92ZSBhbGwgYnV0IHRoZSB1cGRhdGVsYXlvdXQgaGFuZGxlciBvbmNlICM2NDI2IGlzIGZpeGVkLgoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5kb2N1bWVudCwgewoKCQkJCS8vIFRPRE86IE1vdmUgdG8gbm9uLWRlcHJlY2F0ZWQgZXZlbnQKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlU2hvdyIsCgkJCQkicG9wdXBiZWZvcmVwb3NpdGlvbiI6ICJfaGFuZGxlU2hvdyIsCgkJCQkidXBkYXRlbGF5b3V0IjogIl9oYW5kbGVTaG93IiwKCQkJCSJwYW5lbG9wZW4iOiAiX2hhbmRsZVNob3ciCgkJCX0pOwoJCX0sCgoJCS8vIFN5bmNocm9ub3VzbHkgZml4IHRoZSB3aWRnZXQgaGVpZ2h0IGlmIHRoaXMgd2lkZ2V0J3MgcGFyZW50cyBhcmUgc3VjaAoJCS8vIHRoYXQgdGhleSBzaG93L2hpZGUgY29udGVudCBhdCBydW50aW1lLiBXZSBzdGlsbCBuZWVkIHRvIGNoZWNrIHdoZXRoZXIKCQkvLyB0aGUgd2lkZ2V0IGlzIGFjdHVhbGx5IHZpc2libGUgaW4gY2FzZSBpdCBpcyBjb250YWluZWQgaW5zaWRlIG11bHRpcGxlCgkJLy8gc3VjaCBjb250YWluZXJzLiBGb3IgZXhhbXBsZTogcGFuZWwgY29udGFpbnMgY29sbGFwc2libGUgY29udGFpbnMKCQkvLyBhdXRvZ3JvdyB0ZXh0aW5wdXQuIFRoZSBwYW5lbCBtYXkgZW1pdCAicGFuZWxvcGVuIiBpbmRpY2F0aW5nIHRoYXQgaXRzCgkJLy8gY29udGVudCBoYXMgYmVjb21lIHZpc2libGUsIGJ1dCB0aGUgY29sbGFwc2libGUgaXMgc3RpbGwgY29sbGFwc2VkLCBzbwoJCS8vIHRoZSBhdXRvZ3JvdyB0ZXh0YXJlYSBpcyBzdGlsbCBub3QgdmlzaWJsZS4KCQlfaGFuZGxlU2hvdzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICQuY29udGFpbnMoIGV2ZW50LnRhcmdldCwgdGhpcy5lbGVtZW50WyAwIF0gKSAmJgoJCQkJdGhpcy5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgoJCQkJaWYgKCBldmVudC50eXBlICE9PSAicG9wdXBiZWZvcmVwb3NpdGlvbiIgKSB7CgkJCQkJdGhpcy5lbGVtZW50CgkJCQkJCS5hZGRDbGFzcyggInVpLXRleHRpbnB1dC1hdXRvZ3Jvdy1yZXNpemUiICkKCQkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKAoJCQkJCQkJJC5wcm94eSggZnVuY3Rpb24oKSB7CgkJCQkJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGV4dGlucHV0LWF1dG9ncm93LXJlc2l6ZSIgKTsKCQkJCQkJCX0sIHRoaXMgKSwKCQkJCQkJInRyYW5zaXRpb24iICk7CgkJCQl9CgkJCQl0aGlzLl90aW1lb3V0KCk7CgkJCX0KCQl9LAoKCQlfdW5iaW5kQXV0b2dyb3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ciICk7CgkJCXRoaXMuX29mZiggdGhpcy5lbGVtZW50LCAia2V5dXAgY2hhbmdlIGlucHV0IHBhc3RlIiApOwoJCQl0aGlzLl9vZmYoIHRoaXMuZG9jdW1lbnQsCgkJCQkicGFnZXNob3cgcG9wdXBiZWZvcmVwb3NpdGlvbiB1cGRhdGVsYXlvdXQgcGFuZWxvcGVuIiApOwoJCX0sCgoJCWtleXVwVGltZW91dDogbnVsbCwKCgkJX3ByZXBhcmVIZWlnaHRVcGRhdGU6IGZ1bmN0aW9uKCBkZWxheSApIHsKCQkJaWYgKCB0aGlzLmtleXVwVGltZW91dCApIHsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5rZXl1cFRpbWVvdXQgKTsKCQkJfQoJCQlpZiAoIGRlbGF5ID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl91cGRhdGVIZWlnaHQoKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMua2V5dXBUaW1lb3V0ID0gdGhpcy5fZGVsYXkoICJfdXBkYXRlSGVpZ2h0IiwgZGVsYXkgKTsKCQkJfQoJCX0sCgoJCV90aW1lb3V0OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fcHJlcGFyZUhlaWdodFVwZGF0ZSggdGhpcy5vcHRpb25zLmtleXVwVGltZW91dEJ1ZmZlciApOwoJCX0sCgoJCV91cGRhdGVIZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFkZGluZ1RvcCwgcGFkZGluZ0JvdHRvbSwgcGFkZGluZ0hlaWdodCwgc2Nyb2xsSGVpZ2h0LCBjbGllbnRIZWlnaHQsCgkJCQlib3JkZXJUb3AsIGJvcmRlckJvdHRvbSwgYm9yZGVySGVpZ2h0LCBoZWlnaHQsCgkJCQlzY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKTsKCQkJdGhpcy5rZXl1cFRpbWVvdXQgPSAwOwoKCQkJLy8gSUU4IHRleHRhcmVhcyBoYXZlIHRoZSBvbnBhZ2UgcHJvcGVydHkgLSBvdGhlcnMgZG8gbm90CgkJCWlmICggISggIm9ucGFnZSIgaW4gdGhpcy5lbGVtZW50WyAwIF0gKSApIHsKCQkJCXRoaXMuZWxlbWVudC5jc3MoewoJCQkJCSJoZWlnaHQiOiAwLAoJCQkJCSJtaW4taGVpZ2h0IjogMCwKCQkJCQkibWF4LWhlaWdodCI6IDAKCQkJCX0pOwoJCQl9CgoJCQlzY3JvbGxIZWlnaHQgPSB0aGlzLmVsZW1lbnRbIDAgXS5zY3JvbGxIZWlnaHQ7CgkJCWNsaWVudEhlaWdodCA9IHRoaXMuZWxlbWVudFsgMCBdLmNsaWVudEhlaWdodDsKCQkJYm9yZGVyVG9wID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggImJvcmRlci10b3Atd2lkdGgiICkgKTsKCQkJYm9yZGVyQm90dG9tID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggImJvcmRlci1ib3R0b20td2lkdGgiICkgKTsKCQkJYm9yZGVySGVpZ2h0ID0gYm9yZGVyVG9wICsgYm9yZGVyQm90dG9tOwoJCQloZWlnaHQgPSBzY3JvbGxIZWlnaHQgKyBib3JkZXJIZWlnaHQgKyAxNTsKCgkJCS8vIElzc3VlIDYxNzk6IFBhZGRpbmcgaXMgbm90IGluY2x1ZGVkIGluIHNjcm9sbEhlaWdodCBhbmQKCQkJLy8gY2xpZW50SGVpZ2h0IGJ5IEZpcmVmb3ggaWYgbm8gc2Nyb2xsYmFyIGlzIHZpc2libGUuIEJlY2F1c2UKCQkJLy8gdGV4dGFyZWFzIHVzZSB0aGUgYm9yZGVyLWJveCBib3gtc2l6aW5nIG1vZGVsLCBwYWRkaW5nIHNob3VsZCBiZQoJCQkvLyBpbmNsdWRlZCBpbiB0aGUgbmV3IChhc3NpZ25lZCkgaGVpZ2h0LiBCZWNhdXNlIHRoZSBoZWlnaHQgaXMgc2V0CgkJCS8vIHRvIDAsIGNsaWVudEhlaWdodCA9PSAwIGluIEZpcmVmb3guIFRoZXJlZm9yZSwgd2UgY2FuIHVzZSB0aGlzIHRvCgkJCS8vIGNoZWNrIGlmIHBhZGRpbmcgbXVzdCBiZSBhZGRlZC4KCQkJaWYgKCBjbGllbnRIZWlnaHQgPT09IDAgKSB7CgkJCQlwYWRkaW5nVG9wID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggInBhZGRpbmctdG9wIiApICk7CgkJCQlwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCQlwYWRkaW5nSGVpZ2h0ID0gcGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b207CgoJCQkJaGVpZ2h0ICs9IHBhZGRpbmdIZWlnaHQ7CgkJCX0KCgkJCXRoaXMuZWxlbWVudC5jc3MoewoJCQkJImhlaWdodCI6IGhlaWdodCwKCQkJCSJtaW4taGVpZ2h0IjogIiIsCgkJCQkibWF4LWhlaWdodCI6ICIiCgkJCX0pOwoKCQkJdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCBzY3JvbGxUb3AgKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2dyb3cgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICkgewoJCQkJCXRoaXMuX2F1dG9ncm93KCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX3VuYmluZEF1dG9ncm93KCk7CgkJCQl9CgkJCX0KCQl9CgoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQuZXh0ZW5kKCB7Cglpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSk6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJykgKSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246ICJjYXJhdC1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogZmFsc2UsIC8qIFRPRE86IERlcHJlY2F0ZWQgaW4gMS40LCByZW1vdmUgaW4gMS41LiAqLwoJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQlkaXZpZGVyVGhlbWU6IG51bGwsCgkJaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zOiB0cnVlLAoJCWNsb3NlVGV4dDogIkNsb3NlIiwKCQluYXRpdmVNZW51OiB0cnVlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJbWluaTogZmFsc2UKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICk7Cgl9LAoKCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXRoaXMuYnV0dG9uLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJfSwKCglfZm9jdXNCdXR0b24gOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQlzZWxmLmJ1dHRvbi5mb2N1cygpOwoJCX0sIDQwKTsKCX0sCgoJX3NlbGVjdE9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnNlbGVjdC5maW5kKCAib3B0aW9uIiApOwoJfSwKCgkvLyBzZXR1cCBpdGVtcyB0aGF0IGFyZSBnZW5lcmFsbHkgbmVjZXNzYXJ5IGZvciBzZWxlY3QgbWVudSBleHRlbnNpb24KCV9wcmVFeHRlbnNpb246IGZ1bmN0aW9uKCkgewoJCXZhciBpbmxpbmUgPSB0aGlzLm9wdGlvbnMuaW5saW5lIHx8IHRoaXMuZWxlbWVudC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQltaW5pID0gdGhpcy5vcHRpb25zLm1pbmkgfHwgdGhpcy5lbGVtZW50LmpxbURhdGEoICJtaW5pIiApLAoJCQljbGFzc2VzID0gIiI7CgkJLy8gVE9ETzogUG9zdCAxLjEtLW9uY2Ugd2UgaGF2ZSB0aW1lIHRvIHRlc3QgdGhvcm91Z2hseS0tYW55IGNsYXNzZXMgbWFudWFsbHkgYXBwbGllZCB0byB0aGUgb3JpZ2luYWwgZWxlbWVudCBzaG91bGQgYmUgY2FycmllZCBvdmVyIHRvIHRoZSBlbmhhbmNlZCBlbGVtZW50LCB3aXRoIGFuIGAtZW5oYW5jZWRgIHN1ZmZpeC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU3NwoJCS8qIGlmICggJGVsWzBdLmNsYXNzTmFtZS5sZW5ndGggKSB7CgkJCWNsYXNzZXMgPSAkZWxbMF0uY2xhc3NOYW1lOwoJCX0gKi8KCQlpZiAoICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tbGVmdCI7CgkJfQoKCQlpZiAoICAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1yaWdodCI7CgkJfQoKCQlpZiAoIGlubGluZSApIHsKCQkJY2xhc3NlcyArPSAiIHVpLWJ0bi1pbmxpbmUiOwoJCX0KCQlpZiAoIG1pbmkgKSB7CgkJCWNsYXNzZXMgKz0gIiB1aS1taW5pIjsKCQl9CgoJCXRoaXMuc2VsZWN0ID0gdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLndyYXAoICI8ZGl2IGNsYXNzPSd1aS1zZWxlY3QiICsgY2xhc3NlcyArICInPiIgKTsKCQl0aGlzLnNlbGVjdElkICA9IHRoaXMuc2VsZWN0LmF0dHIoICJpZCIgKSB8fCAoICJzZWxlY3QtIiArIHRoaXMudXVpZCApOwoJCXRoaXMuYnV0dG9uSWQgPSB0aGlzLnNlbGVjdElkICsgIi1idXR0b24iOwoJCXRoaXMubGFiZWwgPSAkKCAibGFiZWxbZm9yPSciKyB0aGlzLnNlbGVjdElkICsiJ10iICk7CgkJdGhpcy5pc011bHRpcGxlID0gdGhpcy5zZWxlY3RbIDAgXS5tdWx0aXBsZTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB3cmFwcGVyID0gdGhpcy5lbGVtZW50LnBhcmVudHMoICIudWktc2VsZWN0IiApOwoJCWlmICggd3JhcHBlci5sZW5ndGggPiAwICkgewoJCQlpZiAoIHdyYXBwZXIuaXMoICIudWktYnRuLWxlZnQsIC51aS1idG4tcmlnaHQiICkgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHdyYXBwZXIuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKSA/ICJ1aS1idG4tbGVmdCIgOiAidWktYnRuLXJpZ2h0IiApOwoJCQl9CgkJCXRoaXMuZWxlbWVudC5pbnNlcnRBZnRlciggd3JhcHBlciApOwoJCQl3cmFwcGVyLnJlbW92ZSgpOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcHJlRXh0ZW5zaW9uKCk7CgoJCXRoaXMuYnV0dG9uID0gdGhpcy5fYnV0dG9uKCk7CgoJCXZhciBzZWxmID0gdGhpcywKCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgoJCQlpY29ucG9zID0gb3B0aW9ucy5pY29uID8gKCBvcHRpb25zLmljb25wb3MgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImljb25wb3MiICkgKSA6IGZhbHNlLAoKCQkJYnV0dG9uID0gdGhpcy5idXR0b24KCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXMuc2VsZWN0ICkKCQkJCS5hdHRyKCAiaWQiLCB0aGlzLmJ1dHRvbklkICkKCQkJCS5hZGRDbGFzcyggInVpLWJ0biIgKwoJCQkJCSggb3B0aW9ucy5pY29uID8gKCAiIHVpLWljb24tIiArIG9wdGlvbnMuaWNvbiArICIgdWktYnRuLWljb24tIiArIGljb25wb3MgKwoJCQkJCSggb3B0aW9ucy5pY29uc2hhZG93ID8gIiB1aS1zaGFkb3ctaWNvbiIgOiAiIiApICkgOgkiIiApICsgLyogVE9ETzogUmVtb3ZlIGluIDEuNS4gKi8KCQkJCQkoIG9wdGlvbnMudGhlbWUgPyAiIHVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSA6ICIiICkgKwoJCQkJCSggb3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkgKwoJCQkJCSggb3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIiApICk7CgoJCXRoaXMuc2V0QnV0dG9uVGV4dCgpOwoKCQkvLyBPcGVyYSBkb2VzIG5vdCBwcm9wZXJseSBzdXBwb3J0IG9wYWNpdHkgb24gc2VsZWN0IGVsZW1lbnRzCgkJLy8gSW4gTWluaSwgaXQgaGlkZXMgdGhlIGVsZW1lbnQsIGJ1dCBub3QgaXRzIHRleHQKCQkvLyBPbiB0aGUgZGVza3RvcCxpdCBzZWVtcyB0byBkbyB0aGUgb3Bwb3NpdGUKCQkvLyBmb3IgdGhlc2UgcmVhc29ucywgdXNpbmcgdGhlIG5hdGl2ZU1lbnUgb3B0aW9uIHJlc3VsdHMgaW4gYSBmdWxsIG5hdGl2ZSBzZWxlY3QgaW4gT3BlcmEKCQlpZiAoIG9wdGlvbnMubmF0aXZlTWVudSAmJiB3aW5kb3cub3BlcmEgJiYgd2luZG93Lm9wZXJhLnZlcnNpb24gKSB7CgkJCWJ1dHRvbi5hZGRDbGFzcyggInVpLXNlbGVjdC1uYXRpdmVvbmx5IiApOwoJCX0KCgkJLy8gQWRkIGNvdW50ZXIgZm9yIG11bHRpIHNlbGVjdHMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudCA9ICQoICI8c3Bhbj4iICkKCQkJCS5hZGRDbGFzcyggInVpLWxpLWNvdW50IHVpLWJvZHktaW5oZXJpdCIgKQoJCQkJLmhpZGUoKQoJCQkJLmFwcGVuZFRvKCBidXR0b24uYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICkgKTsKCQl9CgoJCS8vIERpc2FibGUgaWYgc3BlY2lmaWVkCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiICkpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBFdmVudHMgb24gbmF0aXZlIHNlbGVjdAoJCXRoaXMuc2VsZWN0LmNoYW5nZShmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQlpZiAoICEhb3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQkJdGhpcy5ibHVyKCk7CgkJCX0KCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMuX29uKCB0aGlzLmJ1dHRvbiwgewoJCQlrZXlkb3duOiAiX2hhbmRsZUtleWRvd24iCgkJfSk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMgdm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgkJCX0pCgkJCS5iaW5kKCAidm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gUmVtb3ZlIGFjdGl2ZSBjbGFzcyBvbiBzY3JvbGwvdG91Y2htb3ZlCgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciB2bW91c2VvdXQiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdXQiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pOwoKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlzZWxmLmJ1dHRvbi5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5sYWJlbC5iaW5kKCAiY2xpY2sgZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuc2VsZWN0LmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5idXR0b24uYmluZCggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCX0sIDAgKTsKCQkJfQoJCX0pOwoJCXNlbGYuc2VsZWN0LmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQiICk7Cgl9LAoKCXNlbGVjdGVkSW5kaWNlczogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlyZXR1cm4gdGhpcy5zZWxlY3RlZCgpLm1hcChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpLAoJCQl0ZXh0ID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJc3BhbiA9ICQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICk7CgoJCXRoaXMuYnV0dG9uLmNoaWxkcmVuKCAic3BhbiIgKS5ub3QoICIudWktbGktY291bnQiICkucmVtb3ZlKCkuZW5kKCkuZW5kKCkucHJlcGVuZCggKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGVjdGVkLmxlbmd0aCApIHsKCQkJCXRleHQgPSBzZWxlY3RlZC5tYXAoZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICQoIHRoaXMgKS50ZXh0KCk7CgkJCQl9KS5nZXQoKS5qb2luKCAiLCAiICk7CgkJCX0gZWxzZSB7CgkJCQl0ZXh0ID0gc2VsZi5wbGFjZWhvbGRlcjsKCQkJfQoKCQkJaWYgKCB0ZXh0ICkgewoJCQkJc3Bhbi50ZXh0KCB0ZXh0ICk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gU2V0IHRoZSBjb250ZW50cyB0byAmbmJzcDsgd2hpY2ggd2Ugd3JpdGUgYXMgJiMxNjA7IHRvIGJlIFhIVE1MIGNvbXBsaWFudCAtIHNlZSBnaC02Njk5CgkJCQlzcGFuLmh0bWwoICImIzE2MDsiICk7CgkJCX0KCgkJCS8vIFRPRE8gcG9zc2libHkgYWdncmVnYXRlIG11bHRpcGxlIHNlbGVjdCBvcHRpb24gY2xhc3NlcwoJCQlyZXR1cm4gc3BhbgoJCQkJLmFkZENsYXNzKCBzZWxmLnNlbGVjdC5hdHRyKCAiY2xhc3MiICkgKQoJCQkJLmFkZENsYXNzKCBzZWxlY3RlZC5hdHRyKCAiY2xhc3MiICkgKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9KSgpKTsKCX0sCgoJc2V0QnV0dG9uQ291bnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKTsKCgkJLy8gbXVsdGlwbGUgY291bnQgaW5zaWRlIGJ1dHRvbgoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50WyBzZWxlY3RlZC5sZW5ndGggPiAxID8gInNob3ciIDogImhpZGUiIF0oKS50ZXh0KCBzZWxlY3RlZC5sZW5ndGggKTsKCQl9Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggLyogZXZlbnQgKi8gKSB7CgkJdGhpcy5fZGVsYXkoICJfcmVmcmVzaEJ1dHRvbiIgKTsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3JlZnJlc2hCdXR0b246IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0QnV0dG9uVGV4dCgpOwoJCXRoaXMuc2V0QnV0dG9uQ291bnQoKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaEJ1dHRvbigpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpbmtzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgkvL2xpbmtzIHdpdGhpbiBjb250ZW50IGFyZWFzLCB0ZXN0cyBpbmNsdWRlZCB3aXRoIHBhZ2UKCSQoIHRhcmdldCApCgkJLmZpbmQoICJhIiApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZmlsdGVyKCAiOmpxbURhdGEocmVsPSdwb3B1cCcpW2hyZWZdW2hyZWYhPScnXSIgKQoJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJLy8gQWNjZXNzaWJpbGl0eSBpbmZvIGZvciBwb3B1cHMKCQkJdmFyIGVsZW1lbnQgPSB0aGlzLAoJCQkJaWRyZWYgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSggImhyZWYiICkuc3Vic3RyaW5nKCAxICk7CgoJCQlpZiAoIGlkcmVmICkgewoJCQkJZWxlbWVudC5zZXRBdHRyaWJ1dGUoICJhcmlhLWhhc3BvcHVwIiwgdHJ1ZSApOwoJCQkJZWxlbWVudC5zZXRBdHRyaWJ1dGUoICJhcmlhLW93bnMiLCBpZHJlZiApOwoJCQkJZWxlbWVudC5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQkJfQoJCX0pCgkJLmVuZCgpCgkJLm5vdCggIi51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn07Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggd2luZG93U2l6ZSwgc2VnbWVudFNpemUsIG9mZnNldCwgZGVzaXJlZCApIHsKCXZhciByZXR1cm5WYWx1ZSA9IGRlc2lyZWQ7CgoJaWYgKCB3aW5kb3dTaXplIDwgc2VnbWVudFNpemUgKSB7CgkJLy8gQ2VudGVyIHNlZ21lbnQgaWYgaXQncyBiaWdnZXIgdGhhbiB0aGUgd2luZG93CgkJcmV0dXJuVmFsdWUgPSBvZmZzZXQgKyAoIHdpbmRvd1NpemUgLSBzZWdtZW50U2l6ZSApIC8gMjsKCX0gZWxzZSB7CgkJLy8gT3RoZXJ3aXNlIGNlbnRlciBpdCBhdCB0aGUgZGVzaXJlZCBjb29yZGluYXRlIHdoaWxlIGtlZXBpbmcgaXQgY29tcGxldGVseSBpbnNpZGUgdGhlIHdpbmRvdwoJCXJldHVyblZhbHVlID0gTWF0aC5taW4oIE1hdGgubWF4KCBvZmZzZXQsIGRlc2lyZWQgLSBzZWdtZW50U2l6ZSAvIDIgKSwgb2Zmc2V0ICsgd2luZG93U2l6ZSAtIHNlZ21lbnRTaXplICk7Cgl9CgoJcmV0dXJuIHJldHVyblZhbHVlOwp9CgpmdW5jdGlvbiBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhlV2luZG93ICkgewoJcmV0dXJuIHsKCQl4OiB0aGVXaW5kb3cuc2Nyb2xsTGVmdCgpLAoJCXk6IHRoZVdpbmRvdy5zY3JvbGxUb3AoKSwKCQljeDogKCB0aGVXaW5kb3dbIDAgXS5pbm5lcldpZHRoIHx8IHRoZVdpbmRvdy53aWR0aCgpICksCgkJY3k6ICggdGhlV2luZG93WyAwIF0uaW5uZXJIZWlnaHQgfHwgdGhlV2luZG93LmhlaWdodCgpICkKCX07Cn0KCiQud2lkZ2V0KCAibW9iaWxlLnBvcHVwIiwgewoJb3B0aW9uczogewoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQlvdmVybGF5VGhlbWU6IG51bGwsCgkJc2hhZG93OiB0cnVlLAoJCWNvcm5lcnM6IHRydWUsCgkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCXBvc2l0aW9uVG86ICJvcmlnaW4iLAoJCXRvbGVyYW5jZTogbnVsbCwKCQljbG9zZUxpbmtTZWxlY3RvcjogImE6anFtRGF0YShyZWw9J2JhY2snKSIsCgkJY2xvc2VMaW5rRXZlbnRzOiAiY2xpY2sucG9wdXAiLAoJCW5hdmlnYXRlRXZlbnRzOiAibmF2aWdhdGUucG9wdXAiLAoJCWNsb3NlRXZlbnRzOiAibmF2aWdhdGUucG9wdXAgcGFnZWJlZm9yZWNoYW5nZS5wb3B1cCIsCgkJZGlzbWlzc2libGU6IHRydWUsCgkJZW5oYW5jZWQ6IGZhbHNlLAoKCQkvLyBOT1RFIFdpbmRvd3MgUGhvbmUgNyBoYXMgYSBzY3JvbGwgcG9zaXRpb24gY2FjaGluZyBpc3N1ZSB0aGF0CgkJLy8gICAgICByZXF1aXJlcyB1cyB0byBkaXNhYmxlIHBvcHVwIGhpc3RvcnkgbWFuYWdlbWVudCBieSBkZWZhdWx0CgkJLy8gICAgICBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ3ODQKCQkvLwoJCS8vIE5PVEUgdGhpcyBvcHRpb24gaXMgbW9kaWZpZWQgaW4gX2NyZWF0ZSEKCQloaXN0b3J5OiAhJC5tb2JpbGUuYnJvd3Nlci5vbGRJRQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhlRWxlbWVudCA9IHRoaXMuZWxlbWVudCwKCQkJbXlJZCA9IHRoZUVsZW1lbnQuYXR0ciggImlkIiApLAoJCQljdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJLy8gV2UgbmVlZCB0byBhZGp1c3QgdGhlIGhpc3Rvcnkgb3B0aW9uIHRvIGJlIGZhbHNlIGlmIHRoZXJlJ3Mgbm8gQUpBWCBuYXYuCgkJLy8gV2UgY2FuJ3QgZG8gaXQgaW4gdGhlIG9wdGlvbiBkZWNsYXJhdGlvbnMgYmVjYXVzZSB0aG9zZSBhcmUgcnVuIGJlZm9yZQoJCS8vIGl0IGlzIGRldGVybWluZWQgd2hldGhlciB0aGVyZSBzaGFsbCBiZSBBSkFYIG5hdi4KCQljdXJyZW50T3B0aW9ucy5oaXN0b3J5ID0gY3VycmVudE9wdGlvbnMuaGlzdG9yeSAmJiAkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZDsKCgkJLy8gRGVmaW5lIGluc3RhbmNlIHZhcmlhYmxlcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9zY3JvbGxUb3A6IDAsCgkJCV9wYWdlOiB0aGVFbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJX3VpOiBudWxsLAoJCQlfZmFsbGJhY2tUcmFuc2l0aW9uOiAiIiwKCQkJX2N1cnJlbnRUcmFuc2l0aW9uOiBmYWxzZSwKCQkJX3ByZXJlcXVpc2l0ZXM6IG51bGwsCgkJCV9pc09wZW46IGZhbHNlLAoJCQlfdG9sZXJhbmNlOiBudWxsLAoJCQlfcmVzaXplRGF0YTogbnVsbCwKCQkJX2lnbm9yZVJlc2l6ZVRvOiAwLAoJCQlfb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzOiBmYWxzZQoJCX0pOwoKCQlpZiAoIHRoaXMuX3BhZ2UubGVuZ3RoID09PSAwICkgewoJCQl0aGlzLl9wYWdlID0gJCggImJvZHkiICk7CgkJfQoKCQlpZiAoIGN1cnJlbnRPcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl91aSA9IHsKCQkJCWNvbnRhaW5lcjogdGhlRWxlbWVudC5wYXJlbnQoKSwKCQkJCXNjcmVlbjogdGhlRWxlbWVudC5wYXJlbnQoKS5wcmV2KCksCgkJCQlwbGFjZWhvbGRlcjogJCggdGhpcy5kb2N1bWVudFsgMCBdLmdldEVsZW1lbnRCeUlkKCBteUlkICsgIi1wbGFjZWhvbGRlciIgKSApCgkJCX07CgkJfSBlbHNlIHsKCQkJdGhpcy5fdWkgPSB0aGlzLl9lbmhhbmNlKCB0aGVFbGVtZW50LCBteUlkICk7CgkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggY3VycmVudE9wdGlvbnMudHJhbnNpdGlvbiApOwoJCX0KCQl0aGlzCgkJCS5fc2V0VG9sZXJhbmNlKCBjdXJyZW50T3B0aW9ucy50b2xlcmFuY2UgKQoJCQkuX3VpLmZvY3VzRWxlbWVudCA9IHRoaXMuX3VpLmNvbnRhaW5lcjsKCgkJLy8gRXZlbnQgaGFuZGxlcnMKCQl0aGlzLl9vbiggdGhpcy5fdWkuc2NyZWVuLCB7ICJ2Y2xpY2siOiAiX2VhdEV2ZW50QW5kQ2xvc2UiIH0gKTsKCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsKCQkJb3JpZW50YXRpb25jaGFuZ2U6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2UiICksCgkJCXJlc2l6ZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dSZXNpemUiICksCgkJCWtleXVwOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd0tleVVwIiApCgkJfSk7CgkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsgImZvY3VzaW4iOiAiX2hhbmRsZURvY3VtZW50Rm9jdXNJbiIgfSApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oIHRoZUVsZW1lbnQsIG15SWQgKSB7CgkJdmFyIGN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQl3cmFwcGVyQ2xhc3MgPSBjdXJyZW50T3B0aW9ucy53cmFwcGVyQ2xhc3MsCgkJCXVpID0gewoJCQkJc2NyZWVuOiAkKCAiPGRpdiBjbGFzcz0ndWktc2NyZWVuLWhpZGRlbiB1aS1wb3B1cC1zY3JlZW4gIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgY3VycmVudE9wdGlvbnMub3ZlcmxheVRoZW1lICkgKyAiJz48L2Rpdj4iICksCgkJCQlwbGFjZWhvbGRlcjogJCggIjxkaXYgc3R5bGU9J2Rpc3BsYXk6IG5vbmU7Jz48IS0tIHBsYWNlaG9sZGVyIC0tPjwvZGl2PiIgKSwKCQkJCWNvbnRhaW5lcjogJCggIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWNvbnRhaW5lciB1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICsKCQkJCQkoIHdyYXBwZXJDbGFzcyA/ICggIiAiICsgd3JhcHBlckNsYXNzICkgOiAiIiApICsgIic+PC9kaXY+IiApCgkJCX0sCgkJCWZyYWdtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHVpLnNjcmVlblsgMCBdICk7CgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHVpLmNvbnRhaW5lclsgMCBdICk7CgoJCWlmICggbXlJZCApIHsKCQkJdWkuc2NyZWVuLmF0dHIoICJpZCIsIG15SWQgKyAiLXNjcmVlbiIgKTsKCQkJdWkuY29udGFpbmVyLmF0dHIoICJpZCIsIG15SWQgKyAiLXBvcHVwIiApOwoJCQl1aS5wbGFjZWhvbGRlcgoJCQkJLmF0dHIoICJpZCIsIG15SWQgKyAiLXBsYWNlaG9sZGVyIiApCgkJCQkuaHRtbCggIjwhLS0gcGxhY2Vob2xkZXIgZm9yICIgKyBteUlkICsgIiAtLT4iICk7CgkJfQoKCQkvLyBBcHBseSB0aGUgcHJvdG8KCQl0aGlzLl9wYWdlWyAwIF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgkJLy8gTGVhdmUgYSBwbGFjZWhvbGRlciB3aGVyZSB0aGUgZWxlbWVudCB1c2VkIHRvIGJlCgkJdWkucGxhY2Vob2xkZXIuaW5zZXJ0QWZ0ZXIoIHRoZUVsZW1lbnQgKTsKCQl0aGVFbGVtZW50CgkJCS5kZXRhY2goKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cCAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBjdXJyZW50T3B0aW9ucy50aGVtZSApICsgIiAiICsKCQkJCSggY3VycmVudE9wdGlvbnMuc2hhZG93ID8gInVpLW92ZXJsYXktc2hhZG93ICIgOiAiIiApICsKCQkJCSggY3VycmVudE9wdGlvbnMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICkKCQkJLmFwcGVuZFRvKCB1aS5jb250YWluZXIgKTsKCgkJcmV0dXJuIHVpOwoJfSwKCglfZWF0RXZlbnRBbmRDbG9zZTogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJdGhlRXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCgkvLyBNYWtlIHN1cmUgdGhlIHNjcmVlbiBjb3ZlcnMgdGhlIGVudGlyZSBkb2N1bWVudCAtIENTUyBpcyBzb21ldGltZXMgbm90CgkvLyBlbm91Z2ggdG8gYWNjb21wbGlzaCB0aGlzLgoJX3Jlc2l6ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdmFyIHNjcmVlbiA9IHRoaXMuX3VpLnNjcmVlbiwKCQkJcG9wdXBIZWlnaHQgPSB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKSwKCQkJc2NyZWVuSGVpZ2h0ID0gc2NyZWVuLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5oZWlnaHQoKSwKCgkJCS8vIFN1YnRyYWN0aW5nIDEgaGVyZSBpcyBuZWNlc3NhcnkgZm9yIGFuIG9ic2N1cmUgQW5kcmRvaWQgNC4wIGJ1ZyB3aGVyZQoJCQkvLyB0aGUgYnJvd3NlciBoYW5ncyBpZiB0aGUgc2NyZWVuIGNvdmVycyB0aGUgZW50aXJlIGRvY3VtZW50IDovCgkJCWRvY3VtZW50SGVpZ2h0ID0gdGhpcy5kb2N1bWVudC5oZWlnaHQoKSAtIDE7CgoJCWlmICggc2NyZWVuSGVpZ2h0IDwgZG9jdW1lbnRIZWlnaHQgKSB7CgkJCXNjcmVlbi5oZWlnaHQoIGRvY3VtZW50SGVpZ2h0ICk7CgkJfSBlbHNlIGlmICggcG9wdXBIZWlnaHQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCXNjcmVlbi5oZWlnaHQoIHBvcHVwSGVpZ2h0ICk7CgkJfQoJfSwKCglfaGFuZGxlV2luZG93S2V5VXA6IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiB0aGVFdmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVTQ0FQRSApIHsKCQkJcmV0dXJuIHRoaXMuX2VhdEV2ZW50QW5kQ2xvc2UoIHRoZUV2ZW50ICk7CgkJfQoJfSwKCglfZXhwZWN0UmVzaXplRXZlbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciB3aW5kb3dDb29yZGluYXRlcyA9IGdldFdpbmRvd0Nvb3JkaW5hdGVzKCB0aGlzLndpbmRvdyApOwoKCQlpZiAoIHRoaXMuX3Jlc2l6ZURhdGEgKSB7CgkJCWlmICggd2luZG93Q29vcmRpbmF0ZXMueCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy54ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy55ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLnkgJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLmN4ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLmN4ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy5jeSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy5jeSApIHsKCQkJCS8vIHRpbWVvdXQgbm90IHJlZnJlc2hlZAoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgewoJCQkJLy8gY2xlYXIgZXhpc3RpbmcgdGltZW91dCAtIGl0IHdpbGwgYmUgcmVmcmVzaGVkIGJlbG93CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuX3Jlc2l6ZURhdGEudGltZW91dElkICk7CgkJCX0KCQl9CgoJCXRoaXMuX3Jlc2l6ZURhdGEgPSB7CgkJCXRpbWVvdXRJZDogdGhpcy5fZGVsYXkoICJfcmVzaXplVGltZW91dCIsIDIwMCApLAoJCQl3aW5kb3dDb29yZGluYXRlczogd2luZG93Q29vcmRpbmF0ZXMKCQl9OwoKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJX3Jlc2l6ZVRpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQlpZiAoICF0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpICkgewoJCQkJaWYgKCB0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtb3BlbiB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKTsKCQkJCQl0aGlzLnJlcG9zaXRpb24oIHsgcG9zaXRpb25UbzogIndpbmRvdyIgfSApOwoJCQkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCQkJfQoKCQkJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJfQoJCX0gZWxzZSB7CgkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQl9Cgl9LAoKCV9zdG9wSWdub3JpbmdSZXNpemVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gMDsKCX0sCgoJX2lnbm9yZVJlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pZ25vcmVSZXNpemVUbyApIHsKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9pZ25vcmVSZXNpemVUbyApOwoJCX0KCQl0aGlzLl9pZ25vcmVSZXNpemVUbyA9IHRoaXMuX2RlbGF5KCAiX3N0b3BJZ25vcmluZ1Jlc2l6ZUV2ZW50cyIsIDEwMDAgKTsKCX0sCgoJX2hhbmRsZVdpbmRvd1Jlc2l6ZTogZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJaWYgKCAoIHRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgfHwgdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICkgJiYKCQkJCSF0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1jbG9zZSB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiApCgkJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQkJfQoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlOiBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCWlmICggIXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyAmJiB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCk7CgkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IHRydWU7CgkJfQoJfSwKCgkvLyBXaGVuIHRoZSBwb3B1cCBpcyBvcGVuLCBhdHRlbXB0aW5nIHRvIGZvY3VzIG9uIGFuIGVsZW1lbnQgdGhhdCBpcyBub3QgYQoJLy8gY2hpbGQgb2YgdGhlIHBvcHVwIHdpbGwgcmVkaXJlY3QgZm9jdXMgdG8gdGhlIHBvcHVwCglfaGFuZGxlRG9jdW1lbnRGb2N1c0luOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJdmFyIHRhcmdldCwKCQkJdGFyZ2V0RWxlbWVudCA9IHRoZUV2ZW50LnRhcmdldCwKCQkJdWkgPSB0aGlzLl91aTsKCgkJaWYgKCAhdGhpcy5faXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRhcmdldEVsZW1lbnQgIT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQl0YXJnZXQgPSAkKCB0YXJnZXRFbGVtZW50ICk7CgkJCWlmICggMCA9PT0gdGFyZ2V0LnBhcmVudHMoKS5maWx0ZXIoIHVpLmNvbnRhaW5lclsgMCBdICkubGVuZ3RoICkgewoJCQkJJCggdGhpcy5kb2N1bWVudFsgMCBdLmFjdGl2ZUVsZW1lbnQgKS5vbmUoICJmb2N1cyIsIGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJCQkJdGFyZ2V0LmJsdXIoKTsKCQkJCX0pOwoJCQkJdWkuZm9jdXNFbGVtZW50LmZvY3VzKCk7CgkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJdGhlRXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHVpLmZvY3VzRWxlbWVudFsgMCBdID09PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJCXVpLmZvY3VzRWxlbWVudCA9IHRhcmdldDsKCQkJfQoJCX0KCgkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7Cgl9LAoKCV90aGVtZUNsYXNzRnJvbU9wdGlvbjogZnVuY3Rpb24oIHByZWZpeCwgdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICggcHJlZml4ICsgdmFsdWUgKSApIDogKCBwcmVmaXggKyAiaW5oZXJpdCIgKSApOwoJfSwKCglfYXBwbHlUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJaWYgKCB2YWx1ZSApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJaWYgKCB2YWx1ZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCQlpZiAoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9PT0gIm5vbmUiICkgewoJCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICIiOwoJCQkJfQoJCQkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbmV3T3B0aW9ucyApIHsKCQl2YXIgY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCXRoZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCXNjcmVlbiA9IHRoaXMuX3VpLnNjcmVlbjsKCgkJaWYgKCBuZXdPcHRpb25zLndyYXBwZXJDbGFzcyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCS5yZW1vdmVDbGFzcyggY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzICkKCQkJCS5hZGRDbGFzcyggbmV3T3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50CgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBjdXJyZW50T3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG5ld09wdGlvbnMudGhlbWUgKSApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlzY3JlZW4KCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIGN1cnJlbnRPcHRpb25zLm92ZXJsYXlUaGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIG5ld09wdGlvbnMub3ZlcmxheVRoZW1lICkgKTsKCgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJc2NyZWVuLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQl9CgoJCWlmICggbmV3T3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudC50b2dnbGVDbGFzcyggInVpLW92ZXJsYXktc2hhZG93IiwgbmV3T3B0aW9ucy5zaGFkb3cgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgbmV3T3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudHJhbnNpdGlvbiAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICF0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggbmV3T3B0aW9ucy50cmFuc2l0aW9uICk7CgkJCX0KCQl9CgoJCWlmICggbmV3T3B0aW9ucy50b2xlcmFuY2UgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0VG9sZXJhbmNlKCBuZXdPcHRpb25zLnRvbGVyYW5jZSApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggbmV3T3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCXRoaXMuY2xvc2UoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCBuZXdPcHRpb25zICk7Cgl9LAoKCV9zZXRUb2xlcmFuY2U6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgdG9sID0geyB0OiAzMCwgcjogMTUsIGI6IDMwLCBsOiAxNSB9LAoJCQlhcjsKCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQlhciA9IFN0cmluZyggdmFsdWUgKS5zcGxpdCggIiwiICk7CgoJCQkkLmVhY2goIGFyLCBmdW5jdGlvbiggaWR4LCB2YWwgKSB7IGFyWyBpZHggXSA9IHBhcnNlSW50KCB2YWwsIDEwICk7IH0gKTsKCgkJCXN3aXRjaCggYXIubGVuZ3RoICkgewoJCQkJLy8gQWxsIHZhbHVlcyBhcmUgdG8gYmUgdGhlIHNhbWUKCQkJCWNhc2UgMToKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IHRvbC5yID0gdG9sLmIgPSB0b2wubCA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCS8vIFRoZSBmaXJzdCB2YWx1ZSBkZW5vdGVzIHRvcC9ib3R0b20gdG9sZXJhbmNlLCBhbmQgdGhlIHNlY29uZCB2YWx1ZSBkZW5vdGVzIGxlZnQvcmlnaHQgdG9sZXJhbmNlCgkJCQljYXNlIDI6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSB0b2wuYiA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCXRvbC5sID0gdG9sLnIgPSBhclsgMSBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQkvLyBUaGUgYXJyYXkgY29udGFpbnMgdmFsdWVzIGluIHRoZSBvcmRlciB0b3AsIHJpZ2h0LCBib3R0b20sIGxlZnQKCQkJCWNhc2UgNDoKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCXRvbC5yID0gYXJbIDEgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAyIF0gKSApIHsKCQkJCQkJdG9sLmIgPSBhclsgMiBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDMgXSApICkgewoJCQkJCQl0b2wubCA9IGFyWyAzIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCWRlZmF1bHQ6CgkJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXRoaXMuX3RvbGVyYW5jZSA9IHRvbDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2NsYW1wUG9wdXBXaWR0aDogZnVuY3Rpb24oIGluZm9Pbmx5ICkgewoJCXZhciBtZW51U2l6ZSwKCQkJd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhpcy53aW5kb3cgKSwKCQkJLy8gcmVjdGFuZ2xlIHdpdGhpbiB3aGljaCB0aGUgcG9wdXAgbXVzdCBmaXQKCQkJcmVjdGFuZ2xlID0gewoJCQkJeDogdGhpcy5fdG9sZXJhbmNlLmwsCgkJCQl5OiB3aW5kb3dDb29yZGluYXRlcy55ICsgdGhpcy5fdG9sZXJhbmNlLnQsCgkJCQljeDogd2luZG93Q29vcmRpbmF0ZXMuY3ggLSB0aGlzLl90b2xlcmFuY2UubCAtIHRoaXMuX3RvbGVyYW5jZS5yLAoJCQkJY3k6IHdpbmRvd0Nvb3JkaW5hdGVzLmN5IC0gdGhpcy5fdG9sZXJhbmNlLnQgLSB0aGlzLl90b2xlcmFuY2UuYgoJCQl9OwoKCQlpZiAoICFpbmZvT25seSApIHsKCQkJLy8gQ2xhbXAgdGhlIHdpZHRoIG9mIHRoZSBtZW51IGJlZm9yZSBncmFiYmluZyBpdHMgc2l6ZQoJCQl0aGlzLl91aS5jb250YWluZXIuY3NzKCAibWF4LXdpZHRoIiwgcmVjdGFuZ2xlLmN4ICk7CgkJfQoKCQltZW51U2l6ZSA9IHsKCQkJY3g6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlcldpZHRoKCB0cnVlICksCgkJCWN5OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKQoJCX07CgoJCXJldHVybiB7IHJjOiByZWN0YW5nbGUsIG1lbnVTaXplOiBtZW51U2l6ZSB9OwoJfSwKCglfY2FsY3VsYXRlRmluYWxMb2NhdGlvbjogZnVuY3Rpb24oIGRlc2lyZWQsIGNsYW1wSW5mbyApIHsKCQl2YXIgcmV0dXJuVmFsdWUsCgkJCXJlY3RhbmdsZSA9IGNsYW1wSW5mby5yYywKCQkJbWVudVNpemUgPSBjbGFtcEluZm8ubWVudVNpemU7CgoJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzCgkJLy8gdG9vIGxhcmdlLgoJCXJldHVyblZhbHVlID0gewoJCQlsZWZ0OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmVjdGFuZ2xlLmN4LCBtZW51U2l6ZS5jeCwgcmVjdGFuZ2xlLngsIGRlc2lyZWQueCApLAoJCQl0b3A6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByZWN0YW5nbGUuY3ksIG1lbnVTaXplLmN5LCByZWN0YW5nbGUueSwgZGVzaXJlZC55ICkKCQl9OwoKCQkvLyBNYWtlIHN1cmUgdGhlIHRvcCBvZiB0aGUgbWVudSBpcyB2aXNpYmxlCgkJcmV0dXJuVmFsdWUudG9wID0gTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCApOwoKCQkvLyBJZiB0aGUgaGVpZ2h0IG9mIHRoZSBtZW51IGlzIHNtYWxsZXIgdGhhbiB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudAoJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQlyZXR1cm5WYWx1ZS50b3AgLT0gTWF0aC5taW4oIHJldHVyblZhbHVlLnRvcCwKCQkJTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCArIG1lbnVTaXplLmN5IC0gdGhpcy5kb2N1bWVudC5oZWlnaHQoKSApICk7CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX0sCgoJLy8gVHJ5IGFuZCBjZW50ZXIgdGhlIG92ZXJsYXkgb3ZlciB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMKCV9wbGFjZW1lbnRDb29yZHM6IGZ1bmN0aW9uKCBkZXNpcmVkICkgewoJCXJldHVybiB0aGlzLl9jYWxjdWxhdGVGaW5hbExvY2F0aW9uKCBkZXNpcmVkLCB0aGlzLl9jbGFtcFBvcHVwV2lkdGgoKSApOwoJfSwKCglfY3JlYXRlUHJlcmVxdWlzaXRlczogZnVuY3Rpb24oIHNjcmVlblByZXJlcXVpc2l0ZSwgY29udGFpbmVyUHJlcmVxdWlzaXRlLCB3aGVuRG9uZSApIHsKCQl2YXIgcHJlcmVxdWlzaXRlcywKCQkJc2VsZiA9IHRoaXM7CgoJCS8vIEl0IGlzIGltcG9ydGFudCB0byBtYWludGFpbiBib3RoIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXF1aXNpdGVzIGFuZAoJCS8vIHNlbGYuX3ByZXJlcXVpc2l0ZXMuIFRoZSBsb2NhbCB2YXJpYWJsZSByZW1haW5zIGluIHRoZSBjbG9zdXJlIG9mIHRoZQoJCS8vIGZ1bmN0aW9ucyB3aGljaCBjYWxsIHRoZSBjYWxsYmFja3MgcGFzc2VkIGluLiBUaGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZQoJCS8vIGxvY2FsIHZhcmlhYmxlIGFuZCBzZWxmLl9wcmVyZXF1aXNpdGVzIGlzIG5lY2Vzc2FyeSwgYmVjYXVzZSBvbmNlIGEKCQkvLyBmdW5jdGlvbiBoYXMgYmVlbiBwYXNzZWQgdG8gLmFuaW1hdGlvbkNvbXBsZXRlKCkgaXQgd2lsbCBiZSBjYWxsZWQgbmV4dAoJCS8vIHRpbWUgYW4gYW5pbWF0aW9uIGNvbXBsZXRlcywgZXZlbiBpZiB0aGF0J3Mgbm90IHRoZSBhbmltYXRpb24gd2hvc2UgZW5kCgkJLy8gdGhlIGZ1bmN0aW9uIHdhcyBzdXBwb3NlZCB0byBjYXRjaCAoZm9yIGV4YW1wbGUsIGlmIGFuIGFib3J0IGhhcHBlbnMKCQkvLyBkdXJpbmcgdGhlIG9wZW5pbmcgYW5pbWF0aW9uLCB0aGUgLmFuaW1hdGlvbkNvbXBsZXRlIGhhbmRsZXIgaXMgbm90CgkJLy8gY2FsbGVkIGZvciB0aGF0IGFuaW1hdGlvbiBhbnltb3JlLCBidXQgdGhlIGhhbmRsZXIgcmVtYWlucyBhdHRhY2hlZCwgc28KCQkvLyBpdCBpcyBjYWxsZWQgdGhlIG5leHQgdGltZSB0aGUgcG9wdXAgaXMgb3BlbmVkIC0gbWFraW5nIGl0IHN0YWxlLgoJCS8vIENvbXBhcmluZyB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxdWlzaXRlcyB0byB0aGUgd2lkZ2V0LWxldmVsIHZhcmlhYmxlCgkJLy8gc2VsZi5fcHJlcmVxdWlzaXRlcyBlbnN1cmVzIHRoYXQgY2FsbGJhY2tzIHRyaWdnZXJlZCBieSBhIHN0YWxlCgkJLy8gLmFuaW1hdGlvbkNvbXBsZXRlIHdpbGwgYmUgaWdub3JlZC4KCgkJcHJlcmVxdWlzaXRlcyA9IHsKCQkJc2NyZWVuOiAkLkRlZmVycmVkKCksCgkJCWNvbnRhaW5lcjogJC5EZWZlcnJlZCgpCgkJfTsKCgkJcHJlcmVxdWlzaXRlcy5zY3JlZW4udGhlbiggZnVuY3Rpb24oKSB7CgkJCWlmICggcHJlcmVxdWlzaXRlcyA9PT0gc2VsZi5fcHJlcmVxdWlzaXRlcyApIHsKCQkJCXNjcmVlblByZXJlcXVpc2l0ZSgpOwoJCQl9CgkJfSk7CgoJCXByZXJlcXVpc2l0ZXMuY29udGFpbmVyLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQljb250YWluZXJQcmVyZXF1aXNpdGUoKTsKCQkJfQoJCX0pOwoKCQkkLndoZW4oIHByZXJlcXVpc2l0ZXMuc2NyZWVuLCBwcmVyZXF1aXNpdGVzLmNvbnRhaW5lciApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQlzZWxmLl9wcmVyZXF1aXNpdGVzID0gbnVsbDsKCQkJCXdoZW5Eb25lKCk7CgkJCX0KCQl9KTsKCgkJc2VsZi5fcHJlcmVxdWlzaXRlcyA9IHByZXJlcXVpc2l0ZXM7Cgl9LAoKCV9hbmltYXRlOiBmdW5jdGlvbiggYXJncyApIHsKCQkvLyBOT1RFIGJlZm9yZSByZW1vdmluZyB0aGUgZGVmYXVsdCBhbmltYXRpb24gb2YgdGhlIHNjcmVlbgoJCS8vICAgICAgdGhpcyBoYWQgYW4gYW5pbWF0ZSBjYWxsYmFjayB0aGF0IHdvdWxkIHJlc29sdmUgdGhlIGRlZmVycmVkCgkJLy8gICAgICBub3cgdGhlIGRlZmVycmVkIGlzIHJlc29sdmVkIGltbWVkaWF0ZWx5CgkJLy8gVE9ETyByZW1vdmUgdGhlIGRlcGVuZGVuY3kgb24gdGhlIHNjcmVlbiBkZWZlcnJlZAoJCXRoaXMuX3VpLnNjcmVlbgoJCQkucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApCgkJCS5hZGRDbGFzcyggYXJncy5zY3JlZW5DbGFzc1RvQWRkICk7CgoJCWFyZ3MucHJlcmVxdWlzaXRlcy5zY3JlZW4ucmVzb2x2ZSgpOwoKCQlpZiAoIGFyZ3MudHJhbnNpdGlvbiAmJiBhcmdzLnRyYW5zaXRpb24gIT09ICJub25lIiApIHsKCQkJaWYgKCBhcmdzLmFwcGx5VHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggYXJncy50cmFuc2l0aW9uICk7CgkJCX0KCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYWRkQ2xhc3MoIGFyZ3MuY29udGFpbmVyQ2xhc3NUb0FkZCApCgkJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZSggJC5wcm94eSggYXJncy5wcmVyZXF1aXNpdGVzLmNvbnRhaW5lciwgInJlc29sdmUiICkgKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApOwoJCWFyZ3MucHJlcmVxdWlzaXRlcy5jb250YWluZXIucmVzb2x2ZSgpOwoJfSwKCgkvLyBUaGUgZGVzaXJlZCBjb29yZGluYXRlcyBwYXNzZWQgaW4gd2lsbCBiZSByZXR1cm5lZCB1bnRvdWNoZWQgaWYgbm8gcmVmZXJlbmNlIGVsZW1lbnQgY2FuIGJlIGlkZW50aWZpZWQgdmlhCgkvLyBkZXNpcmVkUG9zaXRpb24ucG9zaXRpb25Uby4gTmV2ZXJ0aGVsZXNzLCB0aGlzIGZ1bmN0aW9uIGVuc3VyZXMgdGhhdCBpdHMgcmV0dXJuIHZhbHVlIGFsd2F5cyBjb250YWlucyB2YWxpZAoJLy8geCBhbmQgeSBjb29yZGluYXRlcyBieSBzcGVjaWZ5aW5nIHRoZSBjZW50ZXIgbWlkZGxlIG9mIHRoZSB3aW5kb3cgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSBhYnNlbnQuCgkvLyBvcHRpb25zOiB7IHg6IGNvb3JkaW5hdGUsIHk6IGNvb3JkaW5hdGUsIHBvc2l0aW9uVG86IHN0cmluZzogIm9yaWdpbiIsICJ3aW5kb3ciLCBvciBqUXVlcnkgc2VsZWN0b3IKCV9kZXNpcmVkQ29vcmRzOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJdmFyIG9mZnNldCwKCQkJZHN0ID0gbnVsbCwKCQkJd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhpcy53aW5kb3cgKSwKCQkJeCA9IG9wZW5PcHRpb25zLngsCgkJCXkgPSBvcGVuT3B0aW9ucy55LAoJCQlwVG8gPSBvcGVuT3B0aW9ucy5wb3NpdGlvblRvOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggZWxlbWVudCB3aWxsIHNlcnZlIGFzIHRoZSByZWZlcmVuY2UKCQlpZiAoIHBUbyAmJiBwVG8gIT09ICJvcmlnaW4iICkgewoJCQlpZiAoIHBUbyA9PT0gIndpbmRvdyIgKSB7CgkJCQl4ID0gd2luZG93Q29vcmRpbmF0ZXMuY3ggLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueDsKCQkJCXkgPSB3aW5kb3dDb29yZGluYXRlcy5jeSAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy55OwoJCQl9IGVsc2UgewoJCQkJdHJ5IHsKCQkJCQlkc3QgPSAkKCBwVG8gKTsKCQkJCX0gY2F0Y2goIGVyciApIHsKCQkJCQlkc3QgPSBudWxsOwoJCQkJfQoJCQkJaWYgKCBkc3QgKSB7CgkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCWlmICggZHN0ICkgewoJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQl5ID0gb2Zmc2V0LnRvcCArIGRzdC5vdXRlckhlaWdodCgpIC8gMjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCWlmICggJC50eXBlKCB4ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB4ICkgKSB7CgkJCXggPSB3aW5kb3dDb29yZGluYXRlcy5jeCAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy54OwoJCX0KCQlpZiAoICQudHlwZSggeSApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeSApICkgewoJCQl5ID0gd2luZG93Q29vcmRpbmF0ZXMuY3kgLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueTsKCQl9CgoJCXJldHVybiB7IHg6IHgsIHk6IHkgfTsKCX0sCgoJX3JlcG9zaXRpb246IGZ1bmN0aW9uKCBvcGVuT3B0aW9ucyApIHsKCQkvLyBXZSBvbmx5IGNhcmUgYWJvdXQgcG9zaXRpb24tcmVsYXRlZCBwYXJhbWV0ZXJzIGZvciByZXBvc2l0aW9uaW5nCgkJb3Blbk9wdGlvbnMgPSB7CgkJCXg6IG9wZW5PcHRpb25zLngsCgkJCXk6IG9wZW5PcHRpb25zLnksCgkJCXBvc2l0aW9uVG86IG9wZW5PcHRpb25zLnBvc2l0aW9uVG8KCQl9OwoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIsIHVuZGVmaW5lZCwgb3Blbk9wdGlvbnMgKTsKCQl0aGlzLl91aS5jb250YWluZXIub2Zmc2V0KCB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIG9wZW5PcHRpb25zICkgKSApOwoJfSwKCglyZXBvc2l0aW9uOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCXRoaXMuX3JlcG9zaXRpb24oIG9wZW5PcHRpb25zICk7CgkJfQoJfSwKCglfb3BlblByZXJlcXVpc2l0ZXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkID0gdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKTsKCgkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX2lzT3BlbiA9IHRydWU7CgkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJdGhpcy5fdWkuY29udGFpbmVyLmF0dHIoICJ0YWJpbmRleCIsICIwIiApLmZvY3VzKCk7CgkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJaWYgKCBpZCApIHsKCQkJdGhpcy5kb2N1bWVudC5maW5kKCAiW2FyaWEtaGFzcG9wdXA9J3RydWUnXVthcmlhLW93bnM9JyIgKyAgaWQgKyAiJ10iICkuYXR0ciggImFyaWEtZXhwYW5kZWQiLCB0cnVlICk7CgkJfQoJCXRoaXMuX3RyaWdnZXIoICJhZnRlcm9wZW4iICk7Cgl9LAoKCV9vcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgb3Blbk9wdGlvbnMgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyApLAoJCQkvLyBUT0RPIG1vdmUgYmxhY2tsaXN0IHRvIHByaXZhdGUgbWV0aG9kCgkJCWFuZHJvaWRCbGFja2xpc3QgPSAoIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOVwuXSspLyApLAoJCQkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCQkJYW5kcm9pZG1hdGNoID0gdWEubWF0Y2goIC9BbmRyb2lkIChcZCsoPzpcLlxkKykpLyApLAoJCQkJCWFuZHZlcnNpb24gPSAhIWFuZHJvaWRtYXRjaCAmJiBhbmRyb2lkbWF0Y2hbIDEgXSwKCQkJCQljaHJvbWVtYXRjaCA9IHVhLmluZGV4T2YoICJDaHJvbWUiICkgPiAtMTsKCgkJCQkvLyBQbGF0Zm9ybSBpcyBBbmRyb2lkLCBXZWJLaXQgdmVyc2lvbiBpcyBncmVhdGVyIHRoYW4gNTM0LjEzICggQW5kcm9pZCAzLjIuMSApIGFuZCBub3QgQ2hyb21lLgoJCQkJaWYgKCBhbmRyb2lkbWF0Y2ggIT09IG51bGwgJiYgYW5kdmVyc2lvbiA9PT0gIjQuMCIgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA+IDUzNC4xMyAmJiAhY2hyb21lbWF0Y2ggKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0oKSk7CgoJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcm9wZW4iIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IGFuaW1hdGlvbiBjb21wbGV0ZXMgKGNvbnRhaW5lcigpKQoJCS8vIDIuIFRoZSBzY3JlZW4gb3BhY2l0eSBhbmltYXRpb24gY29tcGxldGVzIChzY3JlZW4oKSkKCQl0aGlzLl9jcmVhdGVQcmVyZXF1aXNpdGVzKAoJCQkkLm5vb3AsCgkJCSQubm9vcCwKCQkJJC5wcm94eSggdGhpcywgIl9vcGVuUHJlcmVxdWlzaXRlc0NvbXBsZXRlIiApICk7CgoJCXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uID0gb3Blbk9wdGlvbnMudHJhbnNpdGlvbjsKCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIG9wZW5PcHRpb25zLnRyYW5zaXRpb24gKTsKCgkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC10cnVuY2F0ZSIgKTsKCgkJLy8gR2l2ZSBhcHBsaWNhdGlvbnMgYSBjaGFuY2UgdG8gbW9kaWZ5IHRoZSBjb250ZW50cyBvZiB0aGUgY29udGFpbmVyIGJlZm9yZSBpdCBhcHBlYXJzCgkJdGhpcy5fcmVwb3NpdGlvbiggb3Blbk9wdGlvbnMgKTsKCgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgJiYgYW5kcm9pZEJsYWNrbGlzdCApIHsKCQkJLyogVE9ETzogVGhlIG5hdGl2ZSBicm93c2VyIG9uIEFuZHJvaWQgNC4wLlggKCJJY2UgQ3JlYW0gU2FuZHdpY2giKSBzdWZmZXJzIGZyb20gYW4gaXNzdWUgd2hlcmUgdGhlIHBvcHVwIG92ZXJsYXkgYXBwZWFycyB0byBiZSB6LWluZGV4ZWQgYWJvdmUgdGhlIHBvcHVwIGl0c2VsZiB3aGVuIGNlcnRhaW4gb3RoZXIgc3R5bGVzIGV4aXN0IG9uIHRoZSBzYW1lIHBhZ2UgLS0gbmFtZWx5LCBhbnkgZWxlbWVudCBzZXQgdG8gYHBvc2l0aW9uOiBmaXhlZGAgYW5kIGNlcnRhaW4gdHlwZXMgb2YgaW5wdXQuIFRoZXNlIGlzc3VlcyBhcmUgcmVtaW5pc2NlbnQgb2YgcHJldmlvdXNseSB1bmNvdmVyZWQgYnVncyBpbiBvbGRlciB2ZXJzaW9ucyBvZiBBbmRyb2lkJ3MgbmF0aXZlIGJyb3dzZXI6IGh0dHBzOi8vZ2l0aHViLmNvbS9zY290dGplaGwvRGV2aWNlLUJ1Z3MvaXNzdWVzLzMKCQkJVGhpcyBmaXggY2xvc2VzIHRoZSBmb2xsb3dpbmcgYnVncyAoIEkgdXNlICJjbG9zZXMiIHdpdGggcmVsdWN0YW5jZSwgYW5kIHN0cmVzcyB0aGF0IHRoaXMgaXNzdWUgc2hvdWxkIGJlIHJldmlzaXRlZCBhcyBzb29uIGFzIHBvc3NpYmxlICk6CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDgxNgoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NDQKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODc0CgkJCSovCgoJCQkvLyBUT0RPIHNvcnQgb3V0IHdoeSB0aGlzLl9wYWdlIGlzbid0IHdvcmtpbmcKCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKS5hZGRDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgkJfQoJCXRoaXMuX2FuaW1hdGUoewoJCQlhZGRpdGlvbmFsQ29uZGl0aW9uOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiBvcGVuT3B0aW9ucy50cmFuc2l0aW9uLAoJCQljbGFzc1RvUmVtb3ZlOiAiIiwKCQkJc2NyZWVuQ2xhc3NUb0FkZDogImluIiwKCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogImluIiwKCQkJYXBwbHlUcmFuc2l0aW9uOiBmYWxzZSwKCQkJcHJlcmVxdWlzaXRlczogdGhpcy5fcHJlcmVxdWlzaXRlcwoJCX0pOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVTY3JlZW46IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VpLnNjcmVlbgoJCQkucmVtb3ZlQ2xhc3MoICJvdXQiICkKCQkJLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlQ29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl91aS5jb250YWluZXIKCQkJLnJlbW92ZUNsYXNzKCAicmV2ZXJzZSBvdXQiICkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiApCgkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZXNEb25lOiBmdW5jdGlvbigpIHsKCQl2YXIgY29udGFpbmVyID0gdGhpcy5fdWkuY29udGFpbmVyLAoJCQlpZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICk7CgoJCWNvbnRhaW5lci5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgoJCS8vIHJlbW92ZSB0aGUgZ2xvYmFsIG11dGV4IGZvciBwb3B1cHMKCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB1bmRlZmluZWQ7CgoJCS8vIEJsdXIgZWxlbWVudHMgaW5zaWRlIHRoZSBjb250YWluZXIsIGluY2x1ZGluZyB0aGUgY29udGFpbmVyCgkJJCggIjpmb2N1cyIsIGNvbnRhaW5lclsgMCBdICkuYWRkKCBjb250YWluZXJbIDAgXSApLmJsdXIoKTsKCgkJaWYgKCBpZCApIHsKCQkJdGhpcy5kb2N1bWVudC5maW5kKCAiW2FyaWEtaGFzcG9wdXA9J3RydWUnXVthcmlhLW93bnM9JyIgKyAgaWQgKyAiJ10iICkuYXR0ciggImFyaWEtZXhwYW5kZWQiLCBmYWxzZSApOwoJCX0KCgkJLy8gYWxlcnQgdXNlcnMgdGhhdCB0aGUgcG9wdXAgaXMgY2xvc2VkCgkJdGhpcy5fdHJpZ2dlciggImFmdGVyY2xvc2UiICk7Cgl9LAoKCV9jbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgoJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJjbG9zZSIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgcmV2ZXJzZSBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxdWlzaXRlcygKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbiIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZUNvbnRhaW5lciIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZXNEb25lIiApICk7CgoJCXRoaXMuX2FuaW1hdGUoIHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdGhpcy5fdWkuc2NyZWVuLmhhc0NsYXNzKCAiaW4iICksCgkJCXRyYW5zaXRpb246ICggaW1tZWRpYXRlID8gIm5vbmUiIDogKCB0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApICksCgkJCWNsYXNzVG9SZW1vdmU6ICJpbiIsCgkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJvdXQiLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAicmV2ZXJzZSBvdXQiLAoJCQlhcHBseVRyYW5zaXRpb246IHRydWUsCgkJCXByZXJlcXVpc2l0ZXM6IHRoaXMuX3ByZXJlcXVpc2l0ZXMKCQl9KTsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCXRoaXMuX3NldE9wdGlvbnMoIHsgdGhlbWU6ICQubW9iaWxlLnBvcHVwLnByb3RvdHlwZS5vcHRpb25zLnRoZW1lIH0gKTsKCQl0aGlzLmVsZW1lbnQKCQkJLy8gQ2Fubm90IGRpcmVjdGx5IGluc2VydEFmdGVyKCkgLSB3ZSBuZWVkIHRvIGRldGFjaCgpIGZpcnN0LCBiZWNhdXNlCgkJCS8vIGluc2VydEFmdGVyKCkgd2lsbCBkbyBub3RoaW5nIGlmIHRoZSBwYXlsb2FkIGRpdiB3YXMgbm90IGF0dGFjaGVkCgkJCS8vIHRvIHRoZSBET00gYXQgdGhlIHRpbWUgdGhlIHdpZGdldCB3YXMgY3JlYXRlZCwgYW5kIHNvIHRoZSBwYXlsb2FkCgkJCS8vIHdpbGwgcmVtYWluIGluc2lkZSB0aGUgY29udGFpbmVyIGV2ZW4gYWZ0ZXIgd2UgY2FsbCBpbnNlcnRBZnRlcigpLgoJCQkvLyBJZiB0aGF0IGhhcHBlbnMgYW5kIHdlIHJlbW92ZSB0aGUgY29udGFpbmVyIGEgZmV3IGxpbmVzIGJlbG93LCB3ZQoJCQkvLyB3aWxsIGNhdXNlIGFuIGluZmluaXRlIHJlY3Vyc2lvbiAtICM1MjQ0CgkJCS5kZXRhY2goKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuX3VpLnBsYWNlaG9sZGVyICkKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCB1aS1ib2R5LWluaGVyaXQiICk7CgkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZSgpOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmUoKTsKCQl0aGlzLl91aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlID09PSB0aGlzICkgewoJCQl0aGlzLmVsZW1lbnQub25lKCAicG9wdXBhZnRlcmNsb3NlIiwgJC5wcm94eSggdGhpcywgIl91bmVuaGFuY2UiICkgKTsKCQkJdGhpcy5jbG9zZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VuZW5oYW5jZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jbG9zZVBvcHVwOiBmdW5jdGlvbiggdGhlRXZlbnQsIGRhdGEgKSB7CgkJdmFyIHBhcnNlZERzdCwgdG9VcmwsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpbW1lZGlhdGUgPSBmYWxzZTsKCgkJaWYgKCAoIHRoZUV2ZW50ICYmIHRoZUV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgfHwgJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyByZXN0b3JlIGxvY2F0aW9uIG9uIHNjcmVlbgoJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy5fc2Nyb2xsVG9wICk7CgoJCWlmICggdGhlRXZlbnQgJiYgdGhlRXZlbnQudHlwZSA9PT0gInBhZ2ViZWZvcmVjaGFuZ2UiICYmIGRhdGEgKSB7CgkJCS8vIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgdG8gcmFwaWQtY2xvc2UgdGhlIHBvcHVwLCBvciB3aGV0aGVyIHdlIGNhbgoJCQkvLyB0YWtlIHRoZSB0aW1lIHRvIHJ1biB0aGUgY2xvc2luZyB0cmFuc2l0aW9uCgkJCWlmICggdHlwZW9mIGRhdGEudG9QYWdlID09PSAic3RyaW5nIiApIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlOwoJCQl9IGVsc2UgewoJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJfQoJCQlwYXJzZWREc3QgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCBwYXJzZWREc3QgKTsKCQkJdG9VcmwgPSBwYXJzZWREc3QucGF0aG5hbWUgKyBwYXJzZWREc3Quc2VhcmNoICsgcGFyc2VkRHN0Lmhhc2g7CgoJCQlpZiAoIHRoaXMuX215VXJsICE9PSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG9VcmwgKSApIHsKCQkJCS8vIEdvaW5nIHRvIGEgZGlmZmVyZW50IHBhZ2UgLSBjbG9zZSBpbW1lZGlhdGVseQoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgoJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MKCQl0aGlzLndpbmRvdy5vZmYoIGN1cnJlbnRPcHRpb25zLmNsb3NlRXZlbnRzICk7CgkJLy8gdW5iaW5kIGNsaWNrIGhhbmRsZXJzIGFkZGVkIHdoZW4gaGlzdG9yeSBpcyBkaXNhYmxlZAoJCXRoaXMuZWxlbWVudC51bmRlbGVnYXRlKCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtTZWxlY3RvciwgY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rRXZlbnRzICk7CgoJCXRoaXMuX2Nsb3NlKCBpbW1lZGlhdGUgKTsKCX0sCgoJLy8gYW55IG5hdmlnYXRpb24gZXZlbnQgYWZ0ZXIgYSBwb3B1cCBpcyBvcGVuZWQgc2hvdWxkIGNsb3NlIHRoZSBwb3B1cAoJLy8gTk9URSB0aGUgcGFnZWJlZm9yZWNoYW5nZSBpcyBib3VuZCB0byBjYXRjaCBuYXZpZ2F0aW9uIGV2ZW50cyB0aGF0IGRvbid0CgkvLyAgICAgIGFsdGVyIHRoZSB1cmwgKGVnLCBkaWFsb2dzIGZyb20gcG9wdXBzKQoJX2JpbmRDb250YWluZXJDbG9zZTogZnVuY3Rpb24oKSB7CgkJdGhpcy53aW5kb3cKCQkJLm9uKCB0aGlzLm9wdGlvbnMuY2xvc2VFdmVudHMsICQucHJveHkoIHRoaXMsICJfY2xvc2VQb3B1cCIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl91aS5jb250YWluZXI7Cgl9LAoKCS8vIFRPRE8gbm8gY2xlYXIgZGVsaW5pYXRpb24gb2Ygd2hhdCBzaG91bGQgYmUgaGVyZSBhbmQKCS8vIHdoYXQgc2hvdWxkIGJlIGluIF9vcGVuLiBTZWVtcyB0byBiZSAidmlzdWFsIiB2cyAiaGlzdG9yeSIgZm9yIG5vdwoJb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHVybCwgaGFzaGtleSwgYWN0aXZlUGFnZSwgY3VycmVudElzRGlhbG9nLCBoYXNIYXNoLCB1cmxIaXN0b3J5LAoJCQlzZWxmID0gdGhpcywKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIG1ha2Ugc3VyZSBvcGVuIGlzIGlkZW1wb3RlbnQKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSB8fCBjdXJyZW50T3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBzZXQgdGhlIGdsb2JhbCBwb3B1cCBtdXRleAoJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHRoaXM7CgkJdGhpcy5fc2Nyb2xsVG9wID0gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCS8vIGlmIGhpc3RvcnkgYWx0ZXJhdGlvbiBpcyBkaXNhYmxlZCBjbG9zZSBvbiBuYXZpZ2F0ZSBldmVudHMKCQkvLyBhbmQgbGVhdmUgdGhlIHVybCBhcyBpcwoJCWlmICggISggY3VycmVudE9wdGlvbnMuaGlzdG9yeSApICkgewoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoKCQkJLy8gV2hlbiBoaXN0b3kgaXMgZGlzYWJsZWQgd2UgaGF2ZSB0byBncmFiIHRoZSBkYXRhLXJlbAoJCQkvLyBiYWNrIGxpbmsgY2xpY2tzIHNvIHdlIGNhbiBjbG9zZSB0aGUgcG9wdXAgaW5zdGVhZCBvZgoJCQkvLyByZWx5aW5nIG9uIGhpc3RvcnkgdG8gZG8gaXQgZm9yIHVzCgkJCXNlbGYuZWxlbWVudAoJCQkJLmRlbGVnYXRlKCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtTZWxlY3RvciwgY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gY2FjaGUgc29tZSB2YWx1ZXMgZm9yIG1pbi9yZWFkYWJpbGl0eQoJCXVybEhpc3RvcnkgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoJCWhhc2hrZXkgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCWFjdGl2ZVBhZ2UgPSAkLm1vYmlsZS5hY3RpdmVQYWdlOwoJCWN1cnJlbnRJc0RpYWxvZyA9ICggYWN0aXZlUGFnZSA/IGFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgOiBmYWxzZSApOwoJCXRoaXMuX215VXJsID0gdXJsID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS51cmw7CgkJaGFzSGFzaCA9ICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA+IC0xICkgJiYgIWN1cnJlbnRJc0RpYWxvZyAmJiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICk7CgoJCWlmICggaGFzSGFzaCApIHsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCS8vIG90aGVyd2lzZSwgaWYgdGhlIHBhZ2UgaXMgYSBkaWFsb2cgc2ltcGx5IHRhY2sgb24gdGhlIGhhc2gga2V5CgkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICkgewoJCQl1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoICIjIiApID4gLTEgPyBoYXNoa2V5IDogIiMiICsgaGFzaGtleSk7CgkJfSBlbHNlIHsKCQkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCArIGhhc2hrZXk7CgkJfQoKCQkvLyBUYWNrIG9uIGFuIGV4dHJhIGhhc2hrZXkgaWYgdGhpcyBpcyB0aGUgZmlyc3QgcGFnZSBhbmQgd2UndmUganVzdCByZWNvbnN0cnVjdGVkIHRoZSBpbml0aWFsIGhhc2gKCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCXVybCArPSBoYXNoa2V5OwoJCX0KCgkJLy8gc3dhbGxvdyB0aGUgdGhlIGluaXRpYWwgbmF2aWdhdGlvbiBldmVudCwgYW5kIGJpbmQgZm9yIHRoZSBuZXh0CgkJdGhpcy53aW5kb3cub25lKCAiYmVmb3JlbmF2aWdhdGUiLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJfSk7CgoJCXRoaXMudXJsQWx0ZXJlZCA9IHRydWU7CgkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgeyByb2xlOiAiZGlhbG9nIiB9ICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJLy8gbWFrZSBzdXJlIGNsb3NlIGlzIGlkZW1wb3RlbnQKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl0aGlzLl9zY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlzdG9yeSAmJiB0aGlzLnVybEFsdGVyZWQgKSB7CgkJCSQubW9iaWxlLmJhY2soKTsKCQkJdGhpcy51cmxBbHRlcmVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJLy8gc2ltdWxhdGUgdGhlIG5hdiBiaW5kaW5ncyBoYXZpbmcgZmlyZWQKCQkJdGhpcy5fY2xvc2VQb3B1cCgpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9Cn0pOwoKLy8gVE9ETyB0aGlzIGNhbiBiZSBtb3ZlZCBpbnNpZGUgdGhlIHdpZGdldAokLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rID0gZnVuY3Rpb24oICRsaW5rICkgewoJdmFyIG9mZnNldCwKCQlwYXRoID0gJC5tb2JpbGUucGF0aCwKCgkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2ggZnJvbSB0aGUgaHJlZiBiZWNhdXNlIGllNyAod3A3KQoJCS8vICAgICAgcmV0dXJucyB0aGUgYWJzb2x1dGUgaHJlZiBpbiB0aGlzIGNhc2UgcnVpbmluZyB0aGUgZWxlbWVudCBzZWxlY3Rpb24KCQlwb3B1cCA9ICQoIHBhdGguaGFzaFRvU2VsZWN0b3IoIHBhdGgucGFyc2VVcmwoICRsaW5rLmF0dHIoICJocmVmIiApICkuaGFzaCApICkuZmlyc3QoKTsKCglpZiAoIHBvcHVwLmxlbmd0aCA+IDAgJiYgcG9wdXAuZGF0YSggIm1vYmlsZS1wb3B1cCIgKSApIHsKCQlvZmZzZXQgPSAkbGluay5vZmZzZXQoKTsKCQlwb3B1cC5wb3B1cCggIm9wZW4iLCB7CgkJCXg6IG9mZnNldC5sZWZ0ICsgJGxpbmsub3V0ZXJXaWR0aCgpIC8gMiwKCQkJeTogb2Zmc2V0LnRvcCArICRsaW5rLm91dGVySGVpZ2h0KCkgLyAyLAoJCQl0cmFuc2l0aW9uOiAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJcG9zaXRpb25UbzogJGxpbmsuanFtRGF0YSggInBvc2l0aW9uLXRvIiApCgkJfSk7Cgl9CgoJLy9yZW1vdmUgYWZ0ZXIgZGVsYXkKCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJfSwgMzAwICk7Cn07CgovLyBUT0RPIG1vdmUgaW5zaWRlIF9jcmVhdGUKJC5tb2JpbGUuZG9jdW1lbnQub24oICJwYWdlYmVmb3JlY2hhbmdlIiwgZnVuY3Rpb24oIHRoZUV2ZW50LCBkYXRhICkgewoJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgPSAiLnVpLWRpc2FibGVkLC51aS1zdGF0ZS1kaXNhYmxlZCwudWktbGktZGl2aWRlciwudWktc2NyZWVuLWhpZGRlbiw6anFtRGF0YShyb2xlPSdwbGFjZWhvbGRlcicpIiwKCWdvVG9BZGphY2VudEl0ZW0gPSBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0LCBkaXJlY3Rpb24gKSB7CgkJdmFyIGFkamFjZW50ID0gaXRlbVsgZGlyZWN0aW9uICsgIkFsbCIgXSgpCgkJCS5ub3QoIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICkKCQkJLmZpcnN0KCk7CgoJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJaWYgKCBhZGphY2VudC5sZW5ndGggKSB7CgkJCXRhcmdldAoJCQkJLmJsdXIoKQoJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCWFkamFjZW50LmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQl9Cgl9OwoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLnNlbGVjdG1lbnUsIHsKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDdXN0b20gc2VsZWN0cyBjYW5ub3QgZXhpc3QgaW5zaWRlIHBvcHVwcywgc28gcmV2ZXJ0IHRoZSAibmF0aXZlTWVudSIKCQkvLyBvcHRpb24gdG8gdHJ1ZSBpZiBhIHBhcmVudCBpcyBhIHBvcHVwCgkJby5uYXRpdmVNZW51ID0gby5uYXRpdmVNZW51IHx8ICggdGhpcy5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpLDptb2JpbGUtcG9wdXAiICkubGVuZ3RoID4gMCApOwoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJX2hhbmRsZVNlbGVjdEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYmx1cigpOwoJCXRoaXMuYnV0dG9uLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fc3VwZXIoIGV2ZW50ICk7CgkJdGhpcy5faGFuZGxlQnV0dG9uVmNsaWNrS2V5ZG93biggZXZlbnQgKTsKCX0sCgoJX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmlzT3BlbiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8IGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UpKSB7CgoJCQl0aGlzLl9kZWNpZGVGb3JtYXQoKTsKCQkJaWYgKCB0aGlzLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCQl0aGlzLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHRoaXMucG9wdXBJZCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgInBvcHVwIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyB0aGlzLmRpYWxvZ0lkICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAiZGlhbG9nIiApOwoJCQl9CgkJCXRoaXMuaXNPcGVuID0gdHJ1ZTsKCQkJLy8gRG8gbm90IHByZXZlbnQgZGVmYXVsdCwgc28gdGhlIG5hdmlnYXRpb24gbWF5IGhhdmUgYSBjaGFuY2UgdG8gYWN0dWFsbHkgb3BlbiB0aGUgY2hvc2VuIGZvcm1hdAoJCX0KCX0sCgoJX2hhbmRsZUxpc3RGb2N1czogZnVuY3Rpb24oIGUgKSB7CgkJdmFyIHBhcmFtcyA9ICggZS50eXBlID09PSAiZm9jdXNpbiIgKSA/CgkJCXsgdGFiaW5kZXg6ICIwIiwgZXZlbnQ6ICJ2bW91c2VvdmVyIiB9OgoJCQl7IHRhYmluZGV4OiAiLTEiLCBldmVudDogInZtb3VzZW91dCIgfTsKCgkJJCggZS50YXJnZXQgKQoJCQkuYXR0ciggInRhYmluZGV4IiwgcGFyYW1zLnRhYmluZGV4ICkKCQkJLnRyaWdnZXIoIHBhcmFtcy5ldmVudCApOwoJfSwKCglfaGFuZGxlTGlzdEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKTsKCgkJLy8gc3dpdGNoIGxvZ2ljIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCWNhc2UgMzg6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJwcmV2IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCWNhc2UgNDA6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJuZXh0IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQljYXNlIDEzOgoJCWNhc2UgMzI6CgkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9oYW5kbGVNZW51UGFnZUhpZGU6IGZ1bmN0aW9uKCkgewoJCS8vIFRPRE8gY2VudHJhbGl6ZSBwYWdlIHJlbW92YWwgYmluZGluZyAvIGhhbmRsaW5nIGluIHRoZSBwYWdlIHBsdWdpbi4KCQkvLyBTdWdnZXN0aW9uIGZyb20gQGpibGFzIHRvIGRvIHJlZmNvdW50aW5nCgkJLy8KCQkvLyBUT0RPIGV4dHJlbWVseSBjb25mdXNpbmcgZGVwZW5kZW5jeSBvbiB0aGUgb3BlbiBtZXRob2Qgd2hlcmUgdGhlIHBhZ2VoaWRlLnJlbW92ZQoJCS8vIGJpbmRpbmdzIGFyZSBzdHJpcHBlZCB0byBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGRpc2FwcGVhcmluZy4gVGhlIHdheQoJCS8vIHdlJ3JlIGtlZXBpbmcgcGFnZXMgaW4gdGhlIERPTSByaWdodCBub3cgc3Vja3MKCQkvLwoJCS8vIHJlYmluZCB0aGUgcGFnZSByZW1vdmUgdGhhdCB3YXMgdW5ib3VuZCBpbiB0aGUgb3BlbiBmdW5jdGlvbgoJCS8vIHRvIGFsbG93IGZvciB0aGUgcGFyZW50IHBhZ2UgcmVtb3ZhbCBmcm9tIGFjdGlvbnMgb3RoZXIgdGhhbiB0aGUgdXNlCgkJLy8gb2YgYSBkaWFsb2cgc2l6ZWQgY3VzdG9tIHNlbGVjdAoJCS8vCgkJLy8gZG9pbmcgdGhpcyBoZXJlIHByb3ZpZGVzIGZvciB0aGUgYmFjayBidXR0b24gb24gdGhlIGN1c3RvbSBzZWxlY3QgZGlhbG9nCgkJdGhpcy50aGlzUGFnZS5wYWdlKCAiYmluZFJlbW92ZSIgKTsKCX0sCgoJX2hhbmRsZUhlYWRlckNsb3NlQ2xpY2s6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0SWQsIHBvcHVwSWQsIGRpYWxvZ0lkLCBsYWJlbCwgdGhpc1BhZ2UsIGlzTXVsdGlwbGUsIG1lbnVJZCwKCQkJdGhlbWVBdHRyLCBvdmVybGF5VGhlbWUsIG92ZXJsYXlUaGVtZUF0dHIsIGRpdmlkZXJUaGVtZUF0dHIsCgkJCW1lbnVQYWdlLCBsaXN0Ym94LCBsaXN0LCBoZWFkZXIsIGhlYWRlclRpdGxlLCBtZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2UsIGhlYWRlckNsb3NlLCBzZWxmLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG8ubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7CgkJfQoKCQlzZWxmID0gdGhpczsKCQlzZWxlY3RJZCA9IHRoaXMuc2VsZWN0SWQ7CgkJcG9wdXBJZCA9IHNlbGVjdElkICsgIi1saXN0Ym94IjsKCQlkaWFsb2dJZCA9IHNlbGVjdElkICsgIi1kaWFsb2ciOwoJCWxhYmVsID0gdGhpcy5sYWJlbDsKCQl0aGlzUGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJaXNNdWx0aXBsZSA9IHRoaXMuZWxlbWVudFsgMCBdLm11bHRpcGxlOwoJCW1lbnVJZCA9IHNlbGVjdElkICsgIi1tZW51IjsKCQl0aGVtZUF0dHIgPSBvLnRoZW1lID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lPSciICsgby50aGVtZSArICInIiApIDogIiI7CgkJb3ZlcmxheVRoZW1lID0gby5vdmVybGF5VGhlbWUgfHwgby50aGVtZSB8fCBudWxsOwoJCW92ZXJsYXlUaGVtZUF0dHIgPSBvdmVybGF5VGhlbWUgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKwoJCQkib3ZlcmxheS10aGVtZT0nIiArIG92ZXJsYXlUaGVtZSArICInIiApIDogIiI7CgkJZGl2aWRlclRoZW1lQXR0ciA9ICggby5kaXZpZGVyVGhlbWUgJiYgaXNNdWx0aXBsZSApID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgImRpdmlkZXItdGhlbWU9JyIgKyBvLmRpdmlkZXJUaGVtZSArICInIiApIDogIiI7CgkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGNsYXNzPSd1aS1zZWxlY3RtZW51JyBpZD0nIiArIGRpYWxvZ0lkICsgIiciICsgdGhlbWVBdHRyICsgb3ZlcmxheVRoZW1lQXR0ciArICI+IiArCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2hlYWRlcic+IiArCgkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJIjwvZGl2PiIrCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PiIrCgkJCSI8L2Rpdj4iICk7CgkJbGlzdGJveCA9ICQoICI8ZGl2IGlkPSciICsgcG9wdXBJZCArICInIGNsYXNzPSd1aS1zZWxlY3RtZW51Jz48L2Rpdj4iICkuaW5zZXJ0QWZ0ZXIoIHRoaXMuc2VsZWN0ICkucG9wdXAoeyB0aGVtZTogby5vdmVybGF5VGhlbWUgfSk7CgkJbGlzdCA9ICQoICI8dWwgY2xhc3M9J3VpLXNlbGVjdG1lbnUtbGlzdCcgaWQ9JyIgKyBtZW51SWQgKyAiJyByb2xlPSdsaXN0Ym94JyBhcmlhLWxhYmVsbGVkYnk9JyIgKyB0aGlzLmJ1dHRvbklkICsgIiciICsgdGhlbWVBdHRyICsgZGl2aWRlclRoZW1lQXR0ciArICI+PC91bD4iICkuYXBwZW5kVG8oIGxpc3Rib3ggKTsKCQloZWFkZXIgPSAkKCAiPGRpdiBjbGFzcz0ndWktaGVhZGVyIHVpLWJhci0iICsgKCBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IiApICsgIic+PC9kaXY+IiApLnByZXBlbmRUbyggbGlzdGJveCApOwoJCWhlYWRlclRpdGxlID0gJCggIjxoMSBjbGFzcz0ndWktdGl0bGUnPjwvaDE+IiApLmFwcGVuZFRvKCBoZWFkZXIgKTsKCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkidGV4dCI6IG8uY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuIHVpLWNvcm5lci1hbGwgdWktYnRuLWxlZnQgdWktYnRuLWljb24tbm90ZXh0IHVpLWljb24tZGVsZXRlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICk7CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzZWxlY3RJZDogc2VsZWN0SWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQlwb3B1cElkOiBwb3B1cElkLAoJCQlkaWFsb2dJZDogZGlhbG9nSWQsCgkJCXRoaXNQYWdlOiB0aGlzUGFnZSwKCQkJbWVudVBhZ2U6IG1lbnVQYWdlLAoJCQlsYWJlbDogbGFiZWwsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiBvLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIKCQl9KTsKCgkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCXRoaXMucmVmcmVzaCgpOwoKCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQkvLyBNYXAgdW5kZWZpbmVkIHRvIGZhbHNlLCBiZWNhdXNlIHRoaXMuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkCgkJCS8vIGluZGljYXRlcyB0aGF0IHdlIGhhdmUgbm90IHlldCBjaGVja2VkIHdoZXRoZXIgdGhlIHNlbGVjdCBoYXMKCQkJLy8gb3JpZ2luYWxseSBoYWQgYSB0YWJpbmRleCBhdHRyaWJ1dGUsIHdoZXJlYXMgZmFsc2UgaW5kaWNhdGVzIHRoYXQKCQkJLy8gd2UgaGF2ZSBjaGVja2VkIHRoZSBzZWxlY3QgZm9yIHN1Y2ggYW4gYXR0cmlidXRlLCBhbmQgaGF2ZSBmb3VuZAoJCQkvLyBub25lIHByZXNlbnQuCgkJCXRoaXMuX29yaWdUYWJJbmRleCA9ICggdGhpcy5zZWxlY3RbIDAgXS5nZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIgKSA9PT0gbnVsbCApID8gZmFsc2UgOiB0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiICk7CgkJfQoJCXRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCQl0aGlzLl9vbiggdGhpcy5zZWxlY3QsIHsgZm9jdXMgOiAiX2hhbmRsZVNlbGVjdEZvY3VzIiB9ICk7CgoJCS8vIEJ1dHRvbiBldmVudHMKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHsKCQkJdmNsaWNrOiAiX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd24iCgkJfSk7CgoJCS8vIEV2ZW50cyBmb3IgbGlzdCBpdGVtcwoJCXRoaXMubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApOwoJCXRoaXMuX29uKCB0aGlzLmxpc3QsIHsKCQkJZm9jdXNpbiA6ICJfaGFuZGxlTGlzdEZvY3VzIiwKCQkJZm9jdXNvdXQgOiAiX2hhbmRsZUxpc3RGb2N1cyIsCgkJCWtleWRvd246ICJfaGFuZGxlTGlzdEtleWRvd24iCgkJfSk7CgkJdGhpcy5saXN0CgkJCS5kZWxlZ2F0ZSggImxpOm5vdCgudWktZGlzYWJsZWQsLnVpLXN0YXRlLWRpc2FibGVkLC51aS1saS1kaXZpZGVyKSIsICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkvLyBpbmRleCBvZiBvcHRpb24gdGFnIHRvIGJlIHNlbGVjdGVkCgkJCQl2YXIgb2xkSW5kZXggPSBzZWxmLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgkJCQkJbmV3SW5kZXggPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJvcHRpb24taW5kZXgiICksCgkJCQkJb3B0aW9uID0gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmVxKCBuZXdJbmRleCApWyAwIF07CgoJCQkJLy8gdG9nZ2xlIHNlbGVjdGVkIHN0YXR1cyBvbiB0aGUgdGFnIGZvciBtdWx0aSBzZWxlY3RzCgkJCQlvcHRpb24uc2VsZWN0ZWQgPSBzZWxmLmlzTXVsdGlwbGUgPyAhb3B0aW9uLnNlbGVjdGVkIDogdHJ1ZTsKCgkJCQkvLyB0b2dnbGUgY2hlY2tib3ggY2xhc3MgZm9yIG11bHRpcGxlIHNlbGVjdHMKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCSQoIHRoaXMgKS5maW5kKCAiYSIgKQoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNoZWNrYm94LW9mZiIsICFvcHRpb24uc2VsZWN0ZWQgKTsKCQkJCX0KCgkJCQkvLyB0cmlnZ2VyIGNoYW5nZSBpZiB2YWx1ZSBjaGFuZ2VkCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSB8fCBvbGRJbmRleCAhPT0gbmV3SW5kZXggKSB7CgkJCQkJc2VsZi5zZWxlY3QudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCX0KCgkJCQkvLyBoaWRlIGN1c3RvbSBzZWxlY3QgZm9yIHNpbmdsZSBzZWxlY3RzIG9ubHkgLSBvdGhlcndpc2UgZm9jdXMgY2xpY2tlZCBpdGVtCgkJCQkvLyBXZSBuZWVkIHRvIGdyYWIgdGhlIGNsaWNrZWQgaXRlbSB0aGUgaGFyZCB3YXksIGJlY2F1c2UgdGhlIGxpc3QgbWF5IGhhdmUgYmVlbiByZWJ1aWx0CgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuZXEoIG5ld0luZGV4ICkKCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCgkJLy8gYnV0dG9uIHJlZm9jdXMgZW5zdXJlcyBwcm9wZXIgaGVpZ2h0IGNhbGN1bGF0aW9uCgkJLy8gYnkgcmVtb3ZpbmcgdGhlIGlubGluZSBzdHlsZSBhbmQgZW5zdXJpbmcgcGFnZSBpbmNsdXNpb24KCQl0aGlzLl9vbiggdGhpcy5tZW51UGFnZSwgeyBwYWdlaGlkZTogIl9oYW5kbGVNZW51UGFnZUhpZGUiIH0gKTsKCgkJLy8gRXZlbnRzIG9uIHRoZSBwb3B1cAoJCXRoaXMuX29uKCB0aGlzLmxpc3Rib3gsIHsgcG9wdXBhZnRlcmNsb3NlOiAiY2xvc2UiIH0gKTsKCgkJLy8gQ2xvc2UgYnV0dG9uIG9uIHNtYWxsIG92ZXJsYXlzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuX29uKCB0aGlzLmhlYWRlckNsb3NlLCB7IGNsaWNrOiAiX2hhbmRsZUhlYWRlckNsb3NlQ2xpY2siIH0gKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfaXNSZWJ1aWxkUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewoJCXZhciBsaXN0ID0gdGhpcy5saXN0LmZpbmQoICJsaSIgKSwKCQkJb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCgkJLy8gVE9ETyBleGNlZWRpbmdseSBuYWl2ZSBtZXRob2QgdG8gZGV0ZXJtaW5lIGRpZmZlcmVuY2UKCQkvLyBpZ25vcmVzIHZhbHVlIGNoYW5nZXMgZXRjIGluIGZhdm9yIG9mIGEgZm9yY2VkUmVidWlsZAoJCS8vIGZyb20gdGhlIHVzZXIgaW4gdGhlIHJlZnJlc2ggbWV0aG9kCgkJcmV0dXJuIG9wdGlvbnMudGV4dCgpICE9PSBsaXN0LnRleHQoKTsKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkOm5vdCggOmpxbURhdGEocGxhY2Vob2xkZXI9J3RydWUnKSApIiApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggZm9yY2UgKSB7CgkJdmFyIHNlbGYsIGluZGljZXM7CgoJCWlmICggdGhpcy5vcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCXJldHVybiB0aGlzLl9zdXBlciggZm9yY2UgKTsKCQl9CgoJCXNlbGYgPSB0aGlzOwoJCWlmICggZm9yY2UgfHwgdGhpcy5faXNSZWJ1aWxkUmVxdWlyZWQoKSApIHsKCQkJc2VsZi5fYnVpbGRMaXN0KCk7CgkJfQoKCQlpbmRpY2VzID0gdGhpcy5zZWxlY3RlZEluZGljZXMoKTsKCgkJc2VsZi5zZXRCdXR0b25UZXh0KCk7CgkJc2VsZi5zZXRCdXR0b25Db3VudCgpOwoKCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkKCQkJLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmVuZCgpCgkJCS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIGZhbHNlICkKCQkJLmVhY2goZnVuY3Rpb24oIGkgKSB7CgoJCQkJaWYgKCAkLmluQXJyYXkoIGksIGluZGljZXMgKSA+IC0xICkgewoJCQkJCXZhciBpdGVtID0gJCggdGhpcyApOwoKCQkJCQkvLyBBcmlhIHNlbGVjdGVkIGF0dHIKCQkJCQlpdGVtLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgdHJ1ZSApOwoKCQkJCQkvLyBNdWx0aXBsZSBzZWxlY3RzOiBhZGQgdGhlICJvbiIgY2hlY2tib3ggc3RhdGUgdG8gdGhlIGljb24KCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJaXRlbS5maW5kKCAiYSIgKS5yZW1vdmVDbGFzcyggInVpLWNoZWNrYm94LW9mZiIgKS5hZGRDbGFzcyggInVpLWNoZWNrYm94LW9uIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmICggaXRlbS5oYXNDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICkgKSB7CgkJCQkJCQlpdGVtLm5leHQoKS5maW5kKCAiYSIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWl0ZW0uZmluZCggImEiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0pOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gInBhZ2UiICkgewoJCQlzZWxmLm1lbnVQYWdlLmRpYWxvZyggImNsb3NlIiApOwoJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCX0gZWxzZSB7CgkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCX0KCgkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCXNlbGYuaXNPcGVuID0gZmFsc2U7Cgl9LAoKCW9wZW46IGZ1bmN0aW9uKCkgewoJCXRoaXMuYnV0dG9uLmNsaWNrKCk7Cgl9LAoKCV9mb2N1c01lbnVJdGVtOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0b3IgPSB0aGlzLmxpc3QuZmluZCggImEuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJaWYgKCBzZWxlY3Rvci5sZW5ndGggPT09IDAgKSB7CgkJCXNlbGVjdG9yID0gdGhpcy5saXN0LmZpbmQoICJsaTpub3QoIiArIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICsgIikgYS51aS1idG4iICk7CgkJfQoJCXNlbGVjdG9yLmZpcnN0KCkuZm9jdXMoKTsKCX0sCgoJX2RlY2lkZUZvcm1hdDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkd2luZG93ID0gdGhpcy53aW5kb3csCgkJCXNlbGZMaXN0UGFyZW50ID0gc2VsZi5saXN0LnBhcmVudCgpLAoJCQltZW51SGVpZ2h0ID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJIZWlnaHQoKSwKCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJYnRuT2Zmc2V0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkudG9wLAoJCQlzY3JlZW5IZWlnaHQgPSAkd2luZG93LmhlaWdodCgpOwoKCQlpZiAoIG1lbnVIZWlnaHQgPiBzY3JlZW5IZWlnaHQgLSA4MCB8fCAhJC5zdXBwb3J0LnNjcm9sbFRvcCApIHsKCgkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCXNlbGYubWVudVBhZ2VDb250ZW50ID0gc2VsZi5tZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCXNlbGYubWVudVBhZ2VDbG9zZSA9IHNlbGYubWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCS8vIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sCgkJCS8vIG90aGVyd2lzZSB0aGUgcmVzdWx0cyBvZiBzZWxlY3RpbmcgYSBsaXN0IGl0ZW0gaW4gdGhlIGRpYWxvZwoJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCXNlbGYudGhpc1BhZ2UudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApOwoKCQkJLy9mb3IgV2ViT1MvT3BlcmEgTWluaSAoc2V0IGxhc3RzY3JvbGwgdXNpbmcgYnV0dG9uIG9mZnNldCkKCQkJaWYgKCBzY3JvbGxUb3AgPT09IDAgJiYgYnRuT2Zmc2V0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJc2VsZi50aGlzUGFnZS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJfSk7CgkJCX0KCgkJCXNlbGYubWVudVBhZ2Uub25lKCB7CgkJCQlwYWdlc2hvdzogJC5wcm94eSggdGhpcywgIl9mb2N1c01lbnVJdGVtIiApLAoJCQkJcGFnZWhpZGU6ICQucHJveHkoIHRoaXMsICJjbG9zZSIgKQoJCQl9KTsKCgkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCXNlbGYubWVudVBhZ2VDb250ZW50LmFwcGVuZCggc2VsZi5saXN0ICk7CgkJCXNlbGYubWVudVBhZ2UuZmluZCggImRpdiAudWktdGl0bGUiICkudGV4dCggc2VsZi5sYWJlbC50ZXh0KCkgKTsKCQl9IGVsc2UgewoJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJc2VsZi5saXN0Ym94Lm9uZSggeyBwb3B1cGFmdGVyb3BlbjogJC5wcm94eSggdGhpcywgIl9mb2N1c01lbnVJdGVtIiApIH0gKTsKCQl9Cgl9LAoKCV9idWlsZExpc3Q6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJcGxhY2Vob2xkZXIgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQlkYXRhSWNvbiA9ICJmYWxzZSIsCgkJCSRvcHRpb25zLCBudW1PcHRpb25zLCBzZWxlY3QsCgkJCWRhdGFQcmVmaXggPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCWRhdGFJbmRleEF0dHIgPSBkYXRhUHJlZml4ICsgIm9wdGlvbi1pbmRleCIsCgkJCWRhdGFJY29uQXR0ciA9IGRhdGFQcmVmaXggKyAiaWNvbiIsCgkJCWRhdGFSb2xlQXR0ciA9IGRhdGFQcmVmaXggKyAicm9sZSIsCgkJCWRhdGFQbGFjZWhvbGRlckF0dHIgPSBkYXRhUHJlZml4ICsgInBsYWNlaG9sZGVyIiwKCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCWlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UsCgkJCW9wdEdyb3VwLAoJCQlpLAoJCQlvcHRpb24sICRvcHRpb24sIHBhcmVudCwgdGV4dCwgYW5jaG9yLCBjbGFzc2VzLAoJCQlvcHRMYWJlbCwgZGl2aWRlciwgaXRlbTsKCgkJc2VsZi5saXN0LmVtcHR5KCkuZmlsdGVyKCAiLnVpLWxpc3R2aWV3IiApLmxpc3R2aWV3KCAiZGVzdHJveSIgKTsKCQkkb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKTsKCQludW1PcHRpb25zID0gJG9wdGlvbnMubGVuZ3RoOwoJCXNlbGVjdCA9IHRoaXMuc2VsZWN0WyAwIF07CgoJCWZvciAoIGkgPSAwOyBpIDwgbnVtT3B0aW9ucztpKyssIGlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UpIHsKCQkJb3B0aW9uID0gJG9wdGlvbnNbaV07CgkJCSRvcHRpb24gPSAkKCBvcHRpb24gKTsKCgkJCS8vIERvIG5vdCBjcmVhdGUgb3B0aW9ucyBiYXNlZCBvbiB1aS1zY3JlZW4taGlkZGVuIHNlbGVjdCBvcHRpb25zCgkJCWlmICggJG9wdGlvbi5oYXNDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICkgKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJcGFyZW50ID0gb3B0aW9uLnBhcmVudE5vZGU7CgkJCXRleHQgPSAkb3B0aW9uLnRleHQoKTsKCQkJYW5jaG9yICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJCQljbGFzc2VzID0gW107CgoJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAiaHJlZiIsICIjIiApOwoJCQlhbmNob3IuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCgkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQlvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICJsYWJlbCIgKTsKCQkJCWlmICggb3B0TGFiZWwgIT09IG9wdEdyb3VwICkgewoJCQkJCWRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoIGRhdGFSb2xlQXR0ciwgImxpc3QtZGl2aWRlciIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAib3B0aW9uIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdExhYmVsICkgKTsKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQl9CgkJCX0KCgkJCWlmICggbmVlZFBsYWNlaG9sZGVyICYmICggIW9wdGlvbi5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSB8fCB0ZXh0Lmxlbmd0aCA9PT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSApICkgewoJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJLy8gSWYgd2UgaGF2ZSBpZGVudGlmaWVkIGEgcGxhY2Vob2xkZXIsIHJlY29yZCB0aGUgZmFjdCB0aGF0IGl0IHdhcwoJCQkJLy8gdXMgd2hvIGhhdmUgYWRkZWQgdGhlIHBsYWNlaG9sZGVyIHRvIHRoZSBvcHRpb24gYW5kIG1hcmsgaXQKCQkJCS8vIHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQlpZiAoIG51bGwgPT09IG9wdGlvbi5nZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIgKSApIHsKCQkJCQl0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgPSB0cnVlOwoJCQkJfQoJCQkJb3B0aW9uLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJfQoJCQkJaWYgKCBwbGFjZWhvbGRlciAhPT0gdGV4dCApIHsKCQkJCQlwbGFjZWhvbGRlciA9IHNlbGYucGxhY2Vob2xkZXIgPSB0ZXh0OwoJCQkJfQoJCQl9CgoJCQlpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxpIiApOwoJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCWNsYXNzZXMucHVzaCggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSW5kZXhBdHRyLCBpICk7CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSWNvbkF0dHIsIGRhdGFJY29uICk7CgkJCWlmICggaXNQbGFjZWhvbGRlckl0ZW0gKSB7CgkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCAiICIgKTsKCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgIm9wdGlvbiIgKTsKCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggInRhYmluZGV4IiwgIi0xIiApOwoJCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJCSQoIGFuY2hvciApLmFkZENsYXNzKCAidWktYnRuIHVpLWNoZWNrYm94LW9mZiB1aS1idG4taWNvbi1yaWdodCIgKTsKCQkJfQoKCQkJaXRlbS5hcHBlbmRDaGlsZCggYW5jaG9yICk7CgkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpdGVtICk7CgkJfQoKCQlzZWxmLmxpc3RbMF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgoJCS8vIEhpZGUgaGVhZGVyIGlmIGl0J3Mgbm90IGEgbXVsdGlzZWxlY3QgYW5kIHRoZXJlJ3Mgbm8gcGxhY2Vob2xkZXIKCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJdGhpcy5oZWFkZXIuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCX0KCgkJLy8gTm93IHBvcHVsYXRlZCwgY3JlYXRlIGxpc3R2aWV3CgkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSA/CgkJCXRoaXMuX3N1cGVyKCkgOgoJCQkkKCAiPGE+IiwgewoJCQkJImhyZWYiOiAiIyIsCgkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwKCgkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCX0pOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgoJCWlmICggIXRoaXMub3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQl0aGlzLmNsb3NlKCk7CgoJCQkvLyBSZXN0b3JlIHRoZSB0YWJpbmRleCBhdHRyaWJ1dGUgdG8gaXRzIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gZmFsc2UgKSB7CgkJCQkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgdGhpcy5fb3JpZ1RhYkluZGV4ICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuc2VsZWN0LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIHRoZSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgaWYgd2Ugd2VyZSB0aGUgb25lcyB0byBhZGQgaXQKCQkJaWYgKCB0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgKSB7CgkJCQl0aGlzLl9zZWxlY3RPcHRpb25zKCkucmVtb3ZlQXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInBsYWNlaG9sZGVyIiApOwoJCQl9CgoJCQkvLyBSZW1vdmUgdGhlIHBvcHVwCgkJCXRoaXMubGlzdGJveC5yZW1vdmUoKTsKCgkJCS8vIFJlbW92ZSB0aGUgZGlhbG9nCgkJCXRoaXMubWVudVBhZ2UucmVtb3ZlKCk7CgkJfQoKCQkvLyBDaGFpbiB1cAoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCi8vIGJ1dHRvbk1hcmt1cCBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gMS41LjAuCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIEdlbmVyYWwgcG9saWN5OiBEbyBub3QgYWNjZXNzIGRhdGEtKiBhdHRyaWJ1dGVzIGV4Y2VwdCBkdXJpbmcgZW5oYW5jZW1lbnQuCi8vIEluIGFsbCBvdGhlciBjYXNlcyB3ZSBkZXRlcm1pbmUgdGhlIHN0YXRlIG9mIHRoZSBidXR0b24gZXhjbHVzaXZlbHkgZnJvbSBpdHMKLy8gY2xhc3NOYW1lLiBUaGF0J3Mgd2h5IG9wdGlvbnNUb0NsYXNzZXMgZXhwZWN0cyBhIGZ1bGwgY29tcGxlbWVudCBvZiBvcHRpb25zLAovLyBhbmQgdGhlIGpRdWVyeSBwbHVnaW4gY29tcGxldGVzIHRoZSBzZXQgb2Ygb3B0aW9ucyBmcm9tIHRoZSBkZWZhdWx0IHZhbHVlcy4KCi8vIE1hcCBjbGFzc2VzIHRvIGJ1dHRvbk1hcmt1cCBib29sZWFuIG9wdGlvbnMgLSB1c2VkIGluIGNsYXNzTmFtZVRvT3B0aW9ucygpCnZhciByZXZlcnNlQm9vbE9wdGlvbk1hcCA9IHsKCQkidWktc2hhZG93IiA6ICJzaGFkb3ciLAoJCSJ1aS1jb3JuZXItYWxsIiA6ICJjb3JuZXJzIiwKCQkidWktYnRuLWlubGluZSIgOiAiaW5saW5lIiwKCQkidWktc2hhZG93LWljb24iIDogImljb25zaGFkb3ciLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41ICovCgkJInVpLW1pbmkiIDogIm1pbmkiCgl9LAoJZ2V0QXR0ckZpeGVkID0gZnVuY3Rpb24oKSB7CgkJdmFyIHJldCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCXJldHVybiAoIHJldCA9PSBudWxsID8gdW5kZWZpbmVkIDogcmV0ICk7Cgl9LAoJY2FwaXRhbExldHRlcnNSRSA9IC9bQS1aXS9nOwoKLy8gb3B0aW9uc1RvQ2xhc3NlczoKLy8gQG9wdGlvbnM6IEEgY29tcGxldGUgc2V0IG9mIG9wdGlvbnMgdG8gY29udmVydCB0byBjbGFzcyBuYW1lcy4KLy8gQGV4aXN0aW5nQ2xhc3NlczogZXh0cmEgY2xhc3NlcyB0byBhZGQgdG8gdGhlIHJlc3VsdAovLwovLyBDb252ZXJ0cyBAb3B0aW9ucyB0byBidXR0b25NYXJrdXAgY2xhc3NlcyBhbmQgcmV0dXJucyB0aGUgcmVzdWx0IGFzIGFuIGFycmF5Ci8vIHRoYXQgY2FuIGJlIGNvbnZlcnRlZCB0byBhbiBlbGVtZW50J3MgY2xhc3NOYW1lIHdpdGggLmpvaW4oICIgIiApLiBBbGwKLy8gcG9zc2libGUgb3B0aW9ucyBtdXN0IGJlIHNldCBpbnNpZGUgQG9wdGlvbnMuIFVzZSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cwovLyB0byBnZXQgYSBjb21wbGV0ZSBzZXQgYW5kIHVzZSAkLmV4dGVuZCB0byBvdmVycmlkZSB5b3VyIGNob2ljZSBvZiBvcHRpb25zCi8vIGZyb20gdGhhdCBzZXQuCmZ1bmN0aW9uIG9wdGlvbnNUb0NsYXNzZXMoIG9wdGlvbnMsIGV4aXN0aW5nQ2xhc3NlcyApIHsKCXZhciBjbGFzc2VzID0gZXhpc3RpbmdDbGFzc2VzID8gZXhpc3RpbmdDbGFzc2VzIDogW107CgoJLy8gQWRkIGNsYXNzZXMgdG8gdGhlIGFycmF5IC0gZmlyc3QgdWktYnRuCgljbGFzc2VzLnB1c2goICJ1aS1idG4iICk7CgoJLy8gSWYgdGhlcmUgaXMgYSB0aGVtZQoJaWYgKCBvcHRpb25zLnRoZW1lICkgewoJCWNsYXNzZXMucHVzaCggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJfQoKCS8vIElmIHRoZXJlJ3MgYW4gaWNvbiwgYWRkIHRoZSBpY29uLXJlbGF0ZWQgY2xhc3NlcwoJaWYgKCBvcHRpb25zLmljb24gKSB7CgkJY2xhc3NlcyA9IGNsYXNzZXMuY29uY2F0KFsKCQkJInVpLWljb24tIiArIG9wdGlvbnMuaWNvbiwKCQkJInVpLWJ0bi1pY29uLSIgKyBvcHRpb25zLmljb25wb3MKCQldKTsKCQlpZiAoIG9wdGlvbnMuaWNvbnNoYWRvdyApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktc2hhZG93LWljb24iICk7IC8qIFRPRE86IFJlbW92ZSBpbiAxLjUgKi8KCQl9Cgl9CgoJLy8gQWRkIHRoZSBhcHByb3ByaWF0ZSBjbGFzcyBmb3IgZWFjaCBib29sZWFuIG9wdGlvbgoJaWYgKCBvcHRpb25zLmlubGluZSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1idG4taW5saW5lIiApOwoJfQoJaWYgKCBvcHRpb25zLnNoYWRvdyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ciICk7Cgl9CglpZiAoIG9wdGlvbnMuY29ybmVycyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1jb3JuZXItYWxsIiApOwoJfQoJaWYgKCBvcHRpb25zLm1pbmkgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktbWluaSIgKTsKCX0KCgkvLyBDcmVhdGUgYSBzdHJpbmcgZnJvbSB0aGUgYXJyYXkgYW5kIHJldHVybiBpdAoJcmV0dXJuIGNsYXNzZXM7Cn0KCi8vIGNsYXNzTmFtZVRvT3B0aW9uczoKLy8gQGNsYXNzZXM6IEEgc3RyaW5nIGNvbnRhaW5pbmcgYSAuY2xhc3NOYW1lLXN0eWxlIHNwYWNlLXNlcGFyYXRlZCBjbGFzcyBsaXN0Ci8vCi8vIExvb3BzIG92ZXIgQGNsYXNzZXMgYW5kIGNhbGN1bGF0ZXMgYW4gb3B0aW9ucyBvYmplY3QgYmFzZWQgb24gdGhlCi8vIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgaXQgZmluZHMuIEl0IHJlY29yZHMgdW5yZWNvZ25pemVkIGNsYXNzZXMgaW4gYW4KLy8gYXJyYXkuCi8vCi8vIFJldHVybnM6IEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBmb2xsb3dpbmcgaXRlbXM6Ci8vCi8vICJvcHRpb25zIjogYnV0dG9uTWFya3VwIG9wdGlvbnMgZm91bmQgdG8gYmUgcHJlc2VudCBiZWNhdXNlIG9mIHRoZQovLyBwcmVzZW5jZS9hYnNlbmNlIG9mIGNvcnJlc3BvbmRpbmcgY2xhc3NlcwovLwovLyAidW5rbm93bkNsYXNzZXMiOiBhIHN0cmluZyBjb250YWluaW5nIGFsbCB0aGUgbm9uLWJ1dHRvbk1hcmt1cC1yZWxhdGVkCi8vIGNsYXNzZXMgZm91bmQgaW4gQGNsYXNzZXMKLy8KLy8gImFscmVhZHlFbmhhbmNlZCI6IEEgYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHVpLWJ0biBjbGFzcyB3YXMgYW1vbmcKLy8gdGhvc2UgZm91bmQgdG8gYmUgcHJlc2VudApmdW5jdGlvbiBjbGFzc05hbWVUb09wdGlvbnMoIGNsYXNzZXMgKSB7Cgl2YXIgaWR4LCBtYXAsIHVua25vd25DbGFzcywKCQlhbHJlYWR5RW5oYW5jZWQgPSBmYWxzZSwKCQlub0ljb24gPSB0cnVlLAoJCW8gPSB7CgkJCWljb246ICIiLAoJCQlpbmxpbmU6IGZhbHNlLAoJCQlzaGFkb3c6IGZhbHNlLAoJCQljb3JuZXJzOiBmYWxzZSwKCQkJaWNvbnNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IGZhbHNlCgkJfSwKCQl1bmtub3duQ2xhc3NlcyA9IFtdOwoKCWNsYXNzZXMgPSBjbGFzc2VzLnNwbGl0KCAiICIgKTsKCgkvLyBMb29wIG92ZXIgdGhlIGNsYXNzZXMKCWZvciAoIGlkeCA9IDAgOyBpZHggPCBjbGFzc2VzLmxlbmd0aCA7IGlkeCsrICkgewoKCQkvLyBBc3N1bWUgaXQncyBhbiB1bnJlY29nbml6ZWQgY2xhc3MKCQl1bmtub3duQ2xhc3MgPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgYm9vbGVhbiBvcHRpb25zIGZyb20gdGhlIHByZXNlbmNlIG9mIGNsYXNzZXMKCQltYXAgPSByZXZlcnNlQm9vbE9wdGlvbk1hcFsgY2xhc3Nlc1sgaWR4IF0gXTsKCQlpZiAoIG1hcCAhPT0gdW5kZWZpbmVkICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJb1sgbWFwIF0gPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgdGhlIHByZXNlbmNlIG9mIGFuIGljb24gYW5kIGVzdGFibGlzaCB0aGUgaWNvbiBwb3NpdGlvbgoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1idG4taWNvbi0iICkgPT09IDAgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlub0ljb24gPSBmYWxzZTsKCQkJby5pY29ucG9zID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCAxMiApOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggaWNvbiBpcyBwcmVzZW50CgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWljb24tIiApID09PSAwICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJby5pY29uID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA4ICk7CgoJCS8vIEVzdGFibGlzaCB0aGUgdGhlbWUgLSB0aGlzIHJlY29nbml6ZXMgb25lLWxldHRlciB0aGVtZSBzd2F0Y2ggbmFtZXMKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktYnRuLSIgKSA9PT0gMCAmJiBjbGFzc2VzWyBpZHggXS5sZW5ndGggPT09IDggKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvLnRoZW1lID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA3ICk7CgoJCS8vIFJlY29nbml6ZSB0aGF0IHRoaXMgZWxlbWVudCBoYXMgYWxyZWFkeSBiZWVuIGJ1dHRvbk1hcmt1cC1lbmhhbmNlZAoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdID09PSAidWktYnRuIiApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCWFscmVhZHlFbmhhbmNlZCA9IHRydWU7CgkJfQoKCQkvLyBJZiB0aGlzIGNsYXNzIGhhcyBub3QgYmVlbiByZWNvZ25pemVkLCBhZGQgaXQgdG8gdGhlIGxpc3QKCQlpZiAoIHVua25vd25DbGFzcyApIHsKCQkJdW5rbm93bkNsYXNzZXMucHVzaCggY2xhc3Nlc1sgaWR4IF0gKTsKCQl9Cgl9CgoJLy8gSWYgYSAidWktYnRuLWljb24tKiIgaWNvbiBwb3NpdGlvbiBjbGFzcyBpcyBhYnNlbnQgdGhlcmUgY2Fubm90IGJlIGFuIGljb24KCWlmICggbm9JY29uICkgewoJCW8uaWNvbiA9ICIiOwoJfQoKCXJldHVybiB7CgkJb3B0aW9uczogbywKCQl1bmtub3duQ2xhc3NlczogdW5rbm93bkNsYXNzZXMsCgkJYWxyZWFkeUVuaGFuY2VkOiBhbHJlYWR5RW5oYW5jZWQKCX07Cn0KCmZ1bmN0aW9uIGNhbWVsQ2FzZTJIeXBoZW5hdGVkKCBjICkgewoJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKfQoKLy8gJC5mbi5idXR0b25NYXJrdXA6Ci8vIERPTTogZ2V0cy9zZXRzIC5jbGFzc05hbWUKLy8KLy8gQG9wdGlvbnM6IG9wdGlvbnMgdG8gYXBwbHkgdG8gdGhlIGVsZW1lbnRzIGluIHRoZSBqUXVlcnkgb2JqZWN0Ci8vIEBvdmVyd3JpdGVDbGFzc2VzOiBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0byBob25vdXIgZXhpc3RpbmcgY2xhc3NlcwovLwovLyBDYWxjdWxhdGVzIHRoZSBjbGFzc2VzIHRvIGFwcGx5IHRvIHRoZSBlbGVtZW50cyBpbiB0aGUgalF1ZXJ5IG9iamVjdCBiYXNlZCBvbgovLyB0aGUgb3B0aW9ucyBwYXNzZWQgaW4uIElmIEBvdmVyd3JpdGVDbGFzc2VzIGlzIHRydWUsIGl0IHNldHMgdGhlIGNsYXNzTmFtZQovLyBwcm9wZXJ0eSBvZiBlYWNoIGVsZW1lbnQgaW4gdGhlIGpRdWVyeSBvYmplY3QgdG8gdGhlIGJ1dHRvbk1hcmt1cCBjbGFzc2VzCi8vIGl0IGNhbGN1bGF0ZXMgYmFzZWQgb24gdGhlIG9wdGlvbnMgcGFzc2VkIGluLgovLwovLyBJZiB5b3Ugd2lzaCB0byBwcmVzZXJ2ZSBhbnkgY2xhc3NlcyB0aGF0IGFyZSBhbHJlYWR5IHByZXNlbnQgb24gdGhlIGVsZW1lbnRzCi8vIGluc2lkZSB0aGUgalF1ZXJ5IG9iamVjdCwgaW5jbHVkaW5nIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgdGhhdCB3ZXJlCi8vIGFkZGVkIGJ5IGEgcHJldmlvdXMgY2FsbCB0byAkLmZuLmJ1dHRvbk1hcmt1cCgpIG9yIGR1cmluZyBwYWdlIGVuaGFuY2VtZW50Ci8vIHRoZW4geW91IHNob3VsZCBvbWl0IEBvdmVyd3JpdGVDbGFzc2VzIG9yIHNldCBpdCB0byBmYWxzZS4KJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucywgb3ZlcndyaXRlQ2xhc3NlcyApIHsKCXZhciBpZHgsIGRhdGEsIGVsLCByZXRyaWV2ZWRPcHRpb25zLCBvcHRpb25LZXksCgkJZGVmYXVsdHMgPSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0czsKCglmb3IgKCBpZHggPSAwIDsgaWR4IDwgdGhpcy5sZW5ndGggOyBpZHgrKyApIHsKCQllbCA9IHRoaXNbIGlkeCBdOwoJCWRhdGEgPSBvdmVyd3JpdGVDbGFzc2VzID8KCgkJCS8vIEFzc3VtZSB0aGlzIGVsZW1lbnQgaXMgbm90IGVuaGFuY2VkIGFuZCBpZ25vcmUgaXRzIGNsYXNzZXMKCQkJeyBhbHJlYWR5RW5oYW5jZWQ6IGZhbHNlLCB1bmtub3duQ2xhc3NlczogW10gfSA6CgoJCQkvLyBPdGhlcndpc2UgYW5hbHl6ZSBleGlzdGluZyBjbGFzc2VzIHRvIGVzdGFibGlzaCBleGlzdGluZyBvcHRpb25zIGFuZAoJCQkvLyBjbGFzc2VzCgkJCWNsYXNzTmFtZVRvT3B0aW9ucyggZWwuY2xhc3NOYW1lICk7CgoJCXJldHJpZXZlZE9wdGlvbnMgPSAkLmV4dGVuZCgge30sCgoJCQkvLyBJZiB0aGUgZWxlbWVudCBhbHJlYWR5IGhhcyB0aGUgY2xhc3MgdWktYnRuLCB0aGVuIHdlIGFzc3VtZSB0aGF0CgkJCS8vIGl0IGhhcyBwYXNzZWQgdGhyb3VnaCBidXR0b25NYXJrdXAgYmVmb3JlIC0gb3RoZXJ3aXNlLCB0aGUgb3B0aW9ucwoJCQkvLyByZXR1cm5lZCBieSBjbGFzc05hbWVUb09wdGlvbnMgZG8gbm90IGNvcnJlY3RseSByZWZsZWN0IHRoZSBzdGF0ZSBvZgoJCQkvLyB0aGUgZWxlbWVudAoJCQkoIGRhdGEuYWxyZWFkeUVuaGFuY2VkID8gZGF0YS5vcHRpb25zIDoge30gKSwKCgkJCS8vIEZpbmFsbHksIGFwcGx5IHRoZSBvcHRpb25zIHBhc3NlZCBpbgoJCQlvcHRpb25zICk7CgoJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IGNhbGwgb24gdGhpcyBlbGVtZW50LCByZXRyaWV2ZSByZW1haW5pbmcgb3B0aW9ucwoJCS8vIGZyb20gdGhlIGRhdGEtYXR0cmlidXRlcwoJCWlmICggIWRhdGEuYWxyZWFkeUVuaGFuY2VkICkgewoJCQlmb3IgKCBvcHRpb25LZXkgaW4gZGVmYXVsdHMgKSB7CgkJCQlpZiAoIHJldHJpZXZlZE9wdGlvbnNbIG9wdGlvbktleSBdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0cmlldmVkT3B0aW9uc1sgb3B0aW9uS2V5IF0gPSBnZXRBdHRyRml4ZWQoIGVsLAoJCQkJCQlvcHRpb25LZXkucmVwbGFjZSggY2FwaXRhbExldHRlcnNSRSwgY2FtZWxDYXNlMkh5cGhlbmF0ZWQgKQoJCQkJCSk7CgkJCQl9CgkJCX0KCQl9CgoJCWVsLmNsYXNzTmFtZSA9IG9wdGlvbnNUb0NsYXNzZXMoCgoJCQkvLyBNZXJnZSBhbGwgdGhlIG9wdGlvbnMgYW5kIGFwcGx5IHRoZW0gYXMgY2xhc3NlcwoJCQkkLmV4dGVuZCgge30sCgoJCQkJLy8gVGhlIGRlZmF1bHRzIGZvcm0gdGhlIGJhc2lzCgkJCQlkZWZhdWx0cywKCgkJCQkvLyBBZGQgdGhlIGNvbXB1dGVkIG9wdGlvbnMKCQkJCXJldHJpZXZlZE9wdGlvbnMKCQkJKSwKCgkJCS8vIC4uLiBhbmQgcmUtYXBwbHkgYW55IHVucmVjb2duaXplZCBjbGFzc2VzIHRoYXQgd2VyZSBmb3VuZAoJCQlkYXRhLnVua25vd25DbGFzc2VzICkuam9pbiggIiAiICk7CgkJaWYgKCBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJidXR0b24iICkgewoJCQllbC5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImJ1dHRvbiIgKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovLyBidXR0b25NYXJrdXAgZGVmYXVsdHMuIFRoaXMgbXVzdCBiZSBhIGNvbXBsZXRlIHNldCwgaS5lLiwgYSB2YWx1ZSBtdXN0IGJlCi8vIGdpdmVuIGhlcmUgZm9yIGFsbCByZWNvZ25pemVkIG9wdGlvbnMKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7CglpY29uOiAiIiwKCWljb25wb3M6ICJsZWZ0IiwKCXRoZW1lOiBudWxsLAoJaW5saW5lOiBmYWxzZSwKCXNoYWRvdzogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCglpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogUmVtb3ZlIGluIDEuNS4gT3B0aW9uIGRlcHJlY2F0ZWQgaW4gMS40LiAqLwoJbWluaTogZmFsc2UKfTsKCiQuZXh0ZW5kKCAkLmZuLmJ1dHRvbk1hcmt1cCwgewoJaW5pdFNlbGVjdG9yOiAiYTpqcW1EYXRhKHJvbGU9J2J1dHRvbicpLCAudWktYmFyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSwgYnV0dG9uIgp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbnRyb2xncm91cCIsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJZW5oYW5jZWQ6IGZhbHNlLAoJCXRoZW1lOiBudWxsLAoJCXNoYWRvdzogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCXR5cGU6ICJ2ZXJ0aWNhbCIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFJ1biBidXR0b25tYXJrdXAKCQlpZiAoICQuZm4uYnV0dG9uTWFya3VwICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkuYnV0dG9uTWFya3VwKCk7CgkJfQoJCS8vIEVuaGFuY2UgY2hpbGQgd2lkZ2V0cwoJCSQuZWFjaCggdGhpcy5fY2hpbGRXaWRnZXRzLCAkLnByb3h5KCBmdW5jdGlvbiggbnVtYmVyLCB3aWRnZXROYW1lICkgewoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXROYW1lIF0gKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGVbIHdpZGdldE5hbWUgXS5pbml0U2VsZWN0b3IgKS5ub3QoICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvcigpIClbIHdpZGdldE5hbWUgXSgpOwoJCQl9CgkJfSwgdGhpcyApKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3VpOiBudWxsLAoJCQlfaW5pdGlhbFJlZnJlc2g6IHRydWUKCQl9KTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl91aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKS5jaGlsZHJlbigpLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgl9LAoKCV9jaGlsZFdpZGdldHM6IFsgImNoZWNrYm94cmFkaW8iLCAic2VsZWN0bWVudSIsICJidXR0b24iIF0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICJ1aS1ncm91cC10aGVtZS0iICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdWkgPSB7CgkJCQlncm91cExlZ2VuZDogZWxlbS5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJCWNoaWxkV3JhcHBlcjogZWxlbQoJCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCQkJInVpLWNvbnRyb2xncm91cC0iICsKCQkJCQkJCSggb3B0cy50eXBlID09PSAiaG9yaXpvbnRhbCIgPyAiaG9yaXpvbnRhbCIgOiAidmVydGljYWwiICkgKyAiICIgKwoJCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICsgIiAiICsKCQkJCQkJKCBvcHRzLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSArCgkJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKQoJCQkJCS53cmFwSW5uZXIoICI8ZGl2ICIgKwoJCQkJCQkiY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyAiICsKCQkJCQkJCSggb3B0cy5zaGFkb3cgPT09IHRydWUgPyAidWktc2hhZG93IiA6ICIiICkgKyAiJz48L2Rpdj4iICkKCQkJCQkuY2hpbGRyZW4oKQoJCQl9OwoKCQlpZiAoIHVpLmdyb3VwTGVnZW5kLmxlbmd0aCA+IDAgKSB7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPjwvZGl2PiIgKQoJCQkJLmFwcGVuZCggdWkuZ3JvdXBMZWdlbmQgKQoJCQkJLnByZXBlbmRUbyggZWxlbSApOwoJCX0KCgkJcmV0dXJuIHVpOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2FsbFJlZnJlc2gsIHJldHVyblZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50OwoKCQkvLyBNdXN0IGhhdmUgb25lIG9mIGhvcml6b250YWwgb3IgdmVydGljYWwKCQlpZiAoIG9wdGlvbnMudHlwZSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwiICkKCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC0iICsgKCBvcHRpb25zLnR5cGUgPT09ICJob3Jpem9udGFsIiA/ICJob3Jpem9udGFsIiA6ICJ2ZXJ0aWNhbCIgKSApOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0aW9ucy50aGVtZSApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fdWkuY2hpbGRXcmFwcGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID0gb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlyZXR1cm5WYWx1ZSA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggY2FsbFJlZnJlc2ggKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfSwKCgljb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl91aS5jaGlsZFdyYXBwZXI7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmNvbnRhaW5lcigpLAoJCQllbHMgPSAkZWwuZmluZCggIi51aS1idG4iICkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICksCgkJCWNyZWF0ZSA9IHRoaXMuX2luaXRpYWxSZWZyZXNoOwoJCWlmICggJC5tb2JpbGUuY2hlY2tib3hyYWRpbyApIHsKCQkJJGVsLmZpbmQoICI6bW9iaWxlLWNoZWNrYm94cmFkaW8iICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfQoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGVscywKCQkJdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPyB0aGlzLl9nZXRWaXNpYmxlcyggZWxzLCBjcmVhdGUgKSA6IGVscywKCQkJY3JlYXRlICk7CgkJdGhpcy5faW5pdGlhbFJlZnJlc2ggPSBmYWxzZTsKCX0sCgoJLy8gQ2F2ZWF0OiBJZiB0aGUgbGVnZW5kIGlzIG5vdCB0aGUgZmlyc3QgY2hpbGQgb2YgdGhlIGNvbnRyb2xncm91cCBhdCBlbmhhbmNlCgkvLyB0aW1lLCBpdCB3aWxsIGJlIGFmdGVyIF9kZXN0cm95KCkuCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHVpLCBidXR0b25zLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdWkgPSB0aGlzLl91aTsKCQlidXR0b25zID0gdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCSJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwgdWktY29ybmVyLWFsbCB1aS1taW5pICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oIG9wdHMudGhlbWUgKSApCgkJCS5maW5kKCAiLnVpLWJ0biIgKQoJCQkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICk7CgoJCXRoaXMuX3JlbW92ZUZpcnN0TGFzdENsYXNzZXMoIGJ1dHRvbnMgKTsKCgkJdWkuZ3JvdXBMZWdlbmQudW53cmFwKCk7CgkJdWkuY2hpbGRXcmFwcGVyLmNoaWxkcmVuKCkudW53cmFwKCk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdoZWFkZXInKSIsCgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCWFkZEJhY2tCdG46IGZhbHNlLAoJCQliYWNrQnRuVGhlbWU6IG51bGwsCgkJCWJhY2tCdG5UZXh0OiAiQmFjayIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIGxlZnRidG4sIHJpZ2h0YnRuLAoJCQkJcm9sZSA9ICB0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJCXBhZ2UgPSBmYWxzZTsKCQkJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCQkJInBhZ2VzaG93IjogInJlZnJlc2giCgkJCQl9KTsKCQkJfQoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJcm9sZTogcm9sZSwKCQkJCXBhZ2U6IHBhZ2UsCgkJCQlsZWZ0YnRuOiBsZWZ0YnRuLAoJCQkJcmlnaHRidG46IHJpZ2h0YnRuCgkJCX0pOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIG8uYWRkQmFja0J0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWRkQmFja0J0biAmJgoJCQkJCXRoaXMucm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJCXRoaXMucGFnZVsgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJCSF0aGlzLmxlZnRidG4gKSB7CgkJCQkJCXRoaXMuX2FkZEJhY2tCdXR0b24oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biIgKS5yZW1vdmUoKTsKCQkJCX0KCQkJfQoJCQlpZiAoIG8uYmFja0J0blRoZW1lICE9IG51bGwgKSB7CgkJCQl0aGlzLmVsZW1lbnQKCQkJCQkuZmluZCggIi51aS10b29sYmFyLWJhY2stYnRuIiApCgkJCQkJLmFkZENsYXNzKCAidWktYnRuIHVpLWJ0bi0iICsgby5iYWNrQnRuVGhlbWUgKTsKCQkJfQoJCQlpZiAoIG8uYmFja0J0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4gLnVpLWJ0bi10ZXh0IiApLnRleHQoIG8uYmFja0J0blRleHQgKTsKCQkJfQoJCQlpZiAoIG8udGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXZhciBjdXJyZW50VGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQkJbmV3VGhlbWUgPSBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IjsKCgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggbyApOwoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5yb2xlID09PSAiaGVhZGVyIiApIHsKCQkJCXRoaXMuX2FkZEhlYWRlckJ1dHRvbkNsYXNzZXMoKTsKCQkJfQoJCQlpZiAoICF0aGlzLnBhZ2UgKSB7CgkJCQl0aGlzLl9zZXRSZWxhdGl2ZSgpOwoJCQkJaWYgKCB0aGlzLnJvbGUgPT09ICJmb290ZXIiICkgewoJCQkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggImJvZHkiICk7CgkJCQl9CgkJCX0KCQkJdGhpcy5fYWRkSGVhZGluZ0NsYXNzZXMoKTsKCQkJdGhpcy5fYnRuTWFya3VwKCk7CgkJfSwKCgkJLy93ZSBvbmx5IHdhbnQgdGhpcyB0byBydW4gb24gbm9uIGZpeGVkIHRvb2xiYXJzIHNvIG1ha2UgaXQgZWFzeSB0byBvdmVycmlkZQoJCV9zZXRSZWxhdGl2ZTogZnVuY3Rpb24oKSB7CgkJCSQoICJbZGF0YS0iKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJ10iICkuY3NzKHsgInBvc2l0aW9uIjogInJlbGF0aXZlIiB9KTsKCQl9LAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNC4gQXMgZnJvbSAxLjUgYnV0dG9uIGNsYXNzZXMgaGF2ZSB0byBiZSBwcmVzZW50IGluIHRoZSBtYXJrdXAuCgkJX2J0bk1hcmt1cDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLmNoaWxkcmVuKCAiYSIgKQoJCQkJLmZpbHRlciggIjpub3QoW2RhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J25vbmUnXSkiICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsICJidXR0b24iICk7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiY3JlYXRlIiApOwoJCX0sCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEFzIGZyb20gMS41IHVpLWJ0bi1sZWZ0L3JpZ2h0IGNsYXNzZXMgaGF2ZSB0byBiZSBwcmVzZW50IGluIHRoZSBtYXJrdXAuCgkJX2FkZEhlYWRlckJ1dHRvbkNsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGhlYWRlcmFuY2hvcnMgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJhLCBidXR0b24iICk7CgkJCXRoaXMubGVmdGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICk7CgkJCXRoaXMucmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCXRoaXMubGVmdGJ0biA9IHRoaXMubGVmdGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKS5sZW5ndGg7CgoJCQl0aGlzLnJpZ2h0YnRuID0gdGhpcy5yaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCgkJfSwKCQlfYWRkQmFja0J1dHRvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQkJdGhlbWUgPSBvcHRpb25zLmJhY2tCdG5UaGVtZSB8fCBvcHRpb25zLnRoZW1lOwoKCQkJJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgIiArCgkJCQkiY2xhc3M9J3VpLWJ0biB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyB1aS1idG4tbGVmdCAiICsKCQkJCQkoIHRoZW1lID8gInVpLWJ0bi0iICsgdGhlbWUgKyAiICIgOiAiIiApICsKCQkJCQkidWktdG9vbGJhci1iYWNrLWJ0biB1aS1pY29uLWNhcmF0LWwgdWktYnRuLWljb24tbGVmdCcgIiArCgkJCQkiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsPSdiYWNrJz4iICsgb3B0aW9ucy5iYWNrQnRuVGV4dCArICI8L2E+IiApCgkJCQkJLnByZXBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgkJfSwKCQlfYWRkSGVhZGluZ0NsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJoZWFkaW5nIiwKCQkJCQkiYXJpYS1sZXZlbCI6ICIxIgoJCQkJfSk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgJC5tb2JpbGUudG9vbGJhciwgewoJCW9wdGlvbnM6IHsKCQkJcG9zaXRpb246bnVsbCwKCQkJdmlzaWJsZU9uUGFnZVNob3c6IHRydWUsCgkJCWRpc2FibGVQYWdlWm9vbTogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogInNsaWRlIiwgLy9jYW4gYmUgbm9uZSwgZmFkZSwgc2xpZGUgKHNsaWRlIG1hcHMgdG8gc2xpZGV1cCBvciBzbGlkZWRvd24pCgkJCWZ1bGxzY3JlZW46IGZhbHNlLAoJCQl0YXBUb2dnbGU6IHRydWUsCgkJCXRhcFRvZ2dsZUJsYWNrbGlzdDogImEsIGJ1dHRvbiwgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIC51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQsIC51aS1mbGlwc3dpdGNoLCAudWktcG9wdXAsIC51aS1wYW5lbCwgLnVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCWhpZGVEdXJpbmdGb2N1czogImlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0IiwKCQkJdXBkYXRlUGFnZVBhZGRpbmc6IHRydWUsCgkJCXRyYWNrUGVyc2lzdGVudFRvb2xiYXJzOiB0cnVlLAoKCQkJLy8gQnJvd3NlciBkZXRlY3Rpb24hIFdlZWVlLCBoZXJlIHdlIGdvLi4uCgkJCS8vIFVuZm9ydHVuYXRlbHksIHBvc2l0aW9uOmZpeGVkIGlzIGNvc3RseSwgbm90IHRvIG1lbnRpb24gcHJvYmFibHkgaW1wb3NzaWJsZSwgdG8gZmVhdHVyZS1kZXRlY3QgYWNjdXJhdGVseS4KCQkJLy8gU29tZSB0ZXN0cyBleGlzdCwgYnV0IHRoZXkgY3VycmVudGx5IHJldHVybiBmYWxzZSByZXN1bHRzIGluIGNyaXRpY2FsIGRldmljZXMgYW5kIGJyb3dzZXJzLCB3aGljaCBjb3VsZCBsZWFkIHRvIGEgYnJva2VuIGV4cGVyaWVuY2UuCgkJCS8vIFRlc3RpbmcgZml4ZWQgcG9zaXRpb25pbmcgaXMgYWxzbyBwcmV0dHkgb2J0cnVzaXZlIHRvIHBhZ2UgbG9hZCwgcmVxdWlyaW5nIGluamVjdGVkIGVsZW1lbnRzIGFuZCBzY3JvbGxpbmcgdGhlIHdpbmRvdwoJCQkvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIHNlcnZlcyB0byBydWxlIG91dCBzb21lIHBvcHVsYXIgYnJvd3NlcnMgd2l0aCBrbm93biBmaXhlZC1wb3NpdGlvbmluZyBpc3N1ZXMKCQkJLy8gVGhpcyBpcyBhIHBsdWdpbiBvcHRpb24gbGlrZSBhbnkgb3RoZXIsIHNvIGZlZWwgZnJlZSB0byBpbXByb3ZlIG9yIG92ZXJ3cml0ZSBpdAoJCQlzdXBwb3J0QmxhY2tsaXN0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhJC5zdXBwb3J0LmZpeGVkUG9zaXRpb247CgkJCX0KCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMucG9zaXRpb24gPT09ICJmaXhlZCIgJiYgIXRoaXMub3B0aW9ucy5zdXBwb3J0QmxhY2tsaXN0KCkgKSB7CgkJCQl0aGlzLl9tYWtlRml4ZWQoKTsKCQkJfQoJCX0sCgoJCV9tYWtlRml4ZWQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS0iKyB0aGlzLnJvbGUgKyItZml4ZWQiICk7CgkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoKTsKCQkJdGhpcy5fYWRkVHJhbnNpdGlvbkNsYXNzKCk7CgkJCXRoaXMuX2JpbmRQYWdlRXZlbnRzKCk7CgkJCXRoaXMuX2JpbmRUb2dnbGVIYW5kbGVycygpOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApIHsKCQkJaWYgKCBvLnBvc2l0aW9uID09PSAiZml4ZWQiICYmIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJCWlmICggdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAiZml4ZWQiICYmICF0aGlzLm9wdGlvbnMuc3VwcG9ydEJsYWNrbGlzdCgpICkgewoJCQkJdmFyICRwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICggJCgiLnVpLXBhZ2UtYWN0aXZlIikubGVuZ3RoID4gMCApPyAkKCIudWktcGFnZS1hY3RpdmUiKTogJCgiLnVpLXBhZ2UiKS5lcSgwKTsKCgkJCQlpZiAoIG8uZnVsbHNjcmVlbiAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSArICItZnVsbHNjcmVlbiIgKTsKCQkJCQl9CgkJCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJCQllbHNlIHsKCQkJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkJCSRwYWdlLnJlbW92ZUNsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlICsgIi1mdWxsc2NyZWVuIiApLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlKyAiLWZpeGVkIiApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zdXBlcihvKTsKCQl9LAoKCQlfYWRkVHJhbnNpdGlvbkNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYgKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKSB7CgkJCQkvLyB1c2UgYXBwcm9wcmlhdGUgc2xpZGUgZm9yIGhlYWRlciBvciBmb290ZXIKCQkJCWlmICggdGNsYXNzID09PSAic2xpZGUiICkgewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5oYXNDbGFzcyggInVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTogdGhpcy5kb2N1bWVudDsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHBhZ2UgLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJdGhpcy5oaWRlKCB0cnVlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlQW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VTaG93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICIudWktcGFnZS1hY3RpdmUiICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAidXBkYXRlUGFnZVBhZGRpbmciIH0gKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oIGUsIHVpICkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJCXRoaXNGb290ZXIsIHRoaXNIZWFkZXIsIG5leHRGb290ZXIsIG5leHRIZWFkZXI7CgoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vZmYoIHRoaXMud2luZG93LCAidGhyb3R0bGVkcmVzaXplIiApOwoJCQl9CgoJCQlpZiAoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKSB7CgkJCQl0aGlzRm9vdGVyID0gJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLnBhZ2UgKTsKCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMucGFnZSApOwoJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gKCB0aGlzLnJvbGUgPT09ImhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCQkJLy8gdGJQYWdlIGFyZ3VtZW50IGNhbiBiZSBhIFBhZ2Ugb2JqZWN0IG9yIGFuIGV2ZW50LCBpZiBjb21pbmcgZnJvbSB0aHJvdHRsZWQgcmVzaXplLgoJCQl0YlBhZ2UgPSAoIHRiUGFnZSAmJiB0YlBhZ2UudHlwZSA9PT0gdW5kZWZpbmVkICYmIHRiUGFnZSApIHx8IHRoaXMucGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQl0YlBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSI7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSArIHBvcyApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9IHRoaXMud2luZG93LAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICggISF0aGlzLnBhZ2UgKT8gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5oZWlnaHQoKTokKCIudWktcGFnZS1hY3RpdmUiKS5oZWlnaHQoKSwKCQkJCXZpZXdwb3J0SGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlyZXR1cm4gIW5vdHJhbnNpdGlvbiAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAmJiB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAhPT0gIm5vbmUiICYmCgkJCQkoCgkJCQkJKCB0aGlzLnJvbGUgPT09ICJoZWFkZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgPiBlbEhlaWdodCApIHx8CgkJCQkJKCB0aGlzLnJvbGUgPT09ICJmb290ZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgKyB2aWV3cG9ydEhlaWdodCA8IHBIZWlnaHQgLSBlbEhlaWdodCApCgkJCQkpIHx8IHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuCgkJCQkpOwoJCX0sCgoJCXNob3c6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24gKCkgewoJCQkJCQkkZWwucmVtb3ZlQ2xhc3MoICJpbiIgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5yZW1vdmVDbGFzcyggaGlkZUNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IHRydWU7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLmFkZENsYXNzKCBvdXRjbGFzcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSBmYWxzZTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCWRlbGF5U2hvdywgZGVsYXlIaWRlLAoJCQkJaXNWaXNpYmxlID0gdHJ1ZSwKCQkJCXBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogJCgiLnVpLXBhZ2UiKTsKCgkJCS8vIHRhcCB0b2dnbGUKCQkJcGFnZQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJCQlpZiAoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICkgewoJCQkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImZvY3VzaW4gZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkvL3RoaXMgaGlkZXMgdGhlIHRvb2xiYXJzIG9uIGEga2V5Ym9hcmQgcG9wIHRvIGdpdmUgbW9yZSBzY3JlZW4gcm9vbSBhbmQgcHJldmVudCBpb3MgYnVnIHdoaWNoCgkJCQkJLy9wb3NpdGlvbnMgZml4ZWQgdG9vbGJhcnMgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuIG9uIHBvcCBpZiB0aGUgaW5wdXQgaXMgbmVhciB0aGUgdG9wIG9yCgkJCQkJLy9ib3R0b20gb2YgdGhlIHNjcmVlbiBhZGRyZXNzZXMgaXNzdWVzICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCS8vYW5kIGlzc3VlICM0MTEzIEhlYWRlciBhbmQgZm9vdGVyIGNoYW5nZSB0aGVpciBwb3NpdGlvbiBhZnRlciBrZXlib2FyZCBwb3B1cCAtIGlPUwoJCQkJCS8vYW5kIGlzc3VlICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgMTAyNSAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApIHsKCQkJCQkJLy9GaXggZm9yIGlzc3VlICM0NzI0IE1vdmluZyB0aHJvdWdoIGZvcm0gaW4gTW9iaWxlIFNhZmFyaSB3aXRoICJOZXh0IiBhbmQgIlByZXZpb3VzIiBzeXN0ZW0KCQkJCQkJLy9jb250cm9scyBjYXVzZXMgZml4ZWQgcG9zaXRpb24sIHRhcC10b2dnbGUgZmFsc2UgSGVhZGVyIHRvIHJldmVhbCBpdHNlbGYKCQkJCQkJLy8gaXNWaXNpYmxlIGluc3RlYWQgb2Ygc2VsZi5fdmlzaWJsZSBiZWNhdXNlIHRoZSBmb2N1c2luIGFuZCBmb2N1c291dCBldmVudHMgZmlyZSB0d2ljZSBhdCB0aGUgc2FtZSB0aW1lCgkJCQkJCS8vIEFsc28gdXNlIGEgZGVsYXkgZm9yIGhpZGluZyB0aGUgdG9vbGJhcnMgYmVjYXVzZSBvbiBBbmRyb2lkIG5hdGl2ZSBicm93c2VyIGZvY3VzaW4gaXMgZGlyZWNsdHkgZm9sbG93ZWQKCQkJCQkJLy8gYnkgYSBmb2N1c291dCB3aGVuIGEgbmF0aXZlIHNlbGVjdHMgb3BlbnMgYW5kIHRoZSBvdGhlciB3YXkgYXJvdW5kIHdoZW4gaXQgY2xvc2VzLgoJCQkJCQlpZiAoIGUudHlwZSA9PT0gImZvY3Vzb3V0IiAmJiAhaXNWaXNpYmxlICkgewoJCQkJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCQkJCQkJCS8vd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBhbmQgc2VlIGlmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQKCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlIaWRlICk7CgkJCQkJCQlkZWxheVNob3cgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLnNob3coKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfSBlbHNlIGlmICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgISFpc1Zpc2libGUgKSB7CgkJCQkJCQkvL2lmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQgY2xlYXIgdGhlIHRpbWUgb3V0IHRvIGNhbmNlbCB0aGUgc2hvdy4KCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlTaG93ICk7CgkJCQkJCQlpc1Zpc2libGUgPSBmYWxzZTsKCQkJCQkJCWRlbGF5SGlkZSA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuaGlkZSgpOwoJCQkJCQkJfSwgMCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX3NldFJlbGF0aXZlOiBmdW5jdGlvbigpIHsKCQkJaWYoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApewoJCQkJJCggIltkYXRhLSIrICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnXSIgKS5jc3MoeyAicG9zaXRpb24iOiAicmVsYXRpdmUiIH0pOwoJCQl9CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmhhc0NsYXNzKCAidWktaGVhZGVyIiApOwoKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgIiIgKTsKCQkJJGVsLnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCAkLm1vYmlsZS50b29sYmFyLCB7CgoJCV9tYWtlRml4ZWQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl93b3JrYXJvdW5kcygpOwoJCX0sCgoJCS8vY2hlY2sgdGhlIGJyb3dzZXIgYW5kIHZlcnNpb24gYW5kIHJ1biBuZWVkZWQgd29ya2Fyb3VuZHMKCQlfd29ya2Fyb3VuZHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQlvcyA9IG51bGwsCgkJCXNlbGYgPSB0aGlzOwoJCQkvL3NldCB0aGUgb3Mgd2UgYXJlIHdvcmtpbmcgaW4gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQlpZiAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgewoJCQkJb3MgPSAiaW9zIjsKCQkJfSBlbHNlIGlmICggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSApIHsKCQkJCW9zID0gImFuZHJvaWQiOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vY2hlY2sgb3MgdmVyc2lvbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCWlmICggb3MgPT09ICJpb3MiICkgewoJCQkJLy9pT1MgIHdvcmthcm91bmRzCgkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQl9IGVsc2UgaWYgKCBvcyA9PT0gImFuZHJvaWQiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB7CgkJCQkvL0FuZHJvaWQgMi4zIHJ1biBhbGwgQW5kcm9pZCAyLjMgd29ya2Fyb3VuZAoJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJCXNlbGYuX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kKCk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9LAoKCQkvL1V0aWxpdHkgY2xhc3MgZm9yIGNoZWNraW5nIGhlYWRlciBhbmQgZm9vdGVyIHBvc2l0aW9ucyByZWxhdGl2ZSB0byB2aWV3cG9ydAoJCV92aWV3cG9ydE9mZnNldDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICksCgkJCQlvZmZzZXQgPSBNYXRoLmFicyggJGVsLm9mZnNldCgpLnRvcCAtIHRoaXMud2luZG93LnNjcm9sbFRvcCgpICk7CgkJCWlmICggIWhlYWRlciApIHsKCQkJCW9mZnNldCA9IE1hdGgucm91bmQoIG9mZnNldCAtIHRoaXMud2luZG93LmhlaWdodCgpICsgJGVsLm91dGVySGVpZ2h0KCkgKSAtIDYwOwoJCQl9CgkJCXJldHVybiBvZmZzZXQ7CgkJfSwKCgkJLy9iaW5kIGV2ZW50cyBmb3IgX3RyaWdnZXJSZWRyYXcoKSBmdW5jdGlvbgoJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy9iaW5kIHRvIHNjcm9sbHN0b3AgYW5kIGNoZWNrIGlmIHRoZSB0b29sYmFycyBhcmUgY29ycmVjdGx5IHBvc2l0aW9uZWQKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7IHNjcm9sbHN0b3A6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHZpZXdwb3J0T2Zmc2V0ID0gc2VsZi5fdmlld3BvcnRPZmZzZXQoKTsKCQkJCS8vY2hlY2sgaWYgdGhlIGhlYWRlciBpcyB2aXNpYmxlIGFuZCBpZiBpdHMgaW4gdGhlIHJpZ2h0IHBsYWNlCgkJCQlpZiAoIHZpZXdwb3J0T2Zmc2V0ID4gMiAmJiBzZWxmLl92aXNpYmxlICkgewoJCQkJCXNlbGYuX3RyaWdnZXJSZWRyYXcoKTsKCQkJCX0KCQkJfX0pOwoJCX0sCgoJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWUgIzQyNTAgUGVyc2lzdGVudCBmb290ZXIgaW5zdGFiaWxpdHkgaW4gdjEuMSB3aXRoIGxvbmcgc2VsZWN0IGxpc3RzIGluIEFuZHJvaWQgMi4zLjMKCQkvL2FuZCBpc3N1ZSAjMzc0OCBBbmRyb2lkIDIueDogUGFnZSB0cmFuc2l0aW9ucyBicm9rZW4gd2hlbiBmaXhlZCB0b29sYmFycyB1c2VkCgkJLy90aGUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHRodW1ibmFpbCBpbiBhIGxpc3QgdmlldyBjYXVzZXMgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbiBidXR0b25zIGFib3ZlIGluIGEgbmF2IGJhcgoJCS8vc2V0dGluZyB0aGUgbGkncyB0byAtd2Via2l0LXRyYW5zZm9ybTp0cmFuc2xhdGUzZCgwLDAsMCk7IHNvbHZlcyB0aGlzIHByb2JsZW0gdG8gYXZvaWRlIHBvdGVudGlhbCBpc3N1ZXMgaW4gb3RoZXIKCQkvL3BsYXRmb3JtcyB3ZSBzY29wZSB0aGlzIHdpdGggdGhlIGNsYXNzIHVpLWFuZHJvaWQtMngtZml4CgkJX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKS5hZGRDbGFzcyggInVpLWFuZHJvaWQtMngtZml4ZWQiICk7CgkJfSwKCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlcyAjNDMzNyBGaXhlZCBoZWFkZXIgcHJvYmxlbSBhZnRlciBzY3JvbGxpbmcgY29udGVudCBvbiBpT1MgYW5kIEFuZHJvaWQKCQkvL2FuZCBkZXZpY2UgYnVncyBwcm9qZWN0IGlzc3VlICMxIEZvcm0gZWxlbWVudHMgY2FuIGxvc2UgY2xpY2sgaGl0IGFyZWEgaW4gcG9zaXRpb246IGZpeGVkIGNvbnRhaW5lcnMuCgkJLy90aGlzIGFsc28gYWRkcmVzc2VzIG5vdCBvbiBmaXhlZCB0b29sYmFycyBwYWdlIGluIGRvY3MKCQkvL2FkZGluZyAxcHggb2YgcGFkZGluZyB0byB0aGUgYm90dG9tIHRoZW4gcmVtb3ZpbmcgaXQgY2F1c2VzIGEgInJlZHJhdyIKCQkvL3doaWNoIHBvc2l0aW9ucyB0aGUgdG9vbGJhcnMgY29ycmVjdGx5ICh0aGV5IHdpbGwgYWx3YXlzIGJlIHZpc3VhbGx5IGNvcnJlY3QpCgkJX3RyaWdnZXJSZWRyYXc6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoICQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKTsKCQkJLy90cmlnZ2VyIHBhZ2UgcmVkcmF3IHRvIGZpeCBpbmNvcnJlY3RseSBwb3NpdGlvbmVkIGZpeGVkIGVsZW1lbnRzCgkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCAoIHBhZGRpbmdCb3R0b20gKyAxICkgKyAicHgiICk7CgkJCS8vaWYgdGhlIHBhZGRpbmcgaXMgcmVzZXQgd2l0aCBvdXQgYSB0aW1lb3V0IHRoZSByZXBvc2l0aW9uIHdpbGwgbm90IG9jY3VyZS4KCQkJLy90aGlzIGlzIGluZGVwZW5kYW50IG9mIEpRTSB0aGUgYnJvd3NlciBzZWVtcyB0byBuZWVkIHRoZSB0aW1lIHRvIHJlYWN0LgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCBwYWRkaW5nQm90dG9tICsgInB4IiApOwoJCQl9LCAwICk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCS8vUmVtb3ZlIHRoZSBjbGFzcyB3ZSBhZGRlZCB0byB0aGUgcGFnZSBwcmV2aW91c2x5IGluIGFuZHJvaWQgMi54CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UtYWN0aXZlIiApLnJlbW92ZUNsYXNzKCAidWktYW5kcm9pZC0yeC1maXgiICk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGllSGFjayA9ICggJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFIDw9IDggKSwKCXVpVGVtcGxhdGUgPSAkKAoJCSI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1hcnJvdy1ndWlkZSc+PC9kaXY+IiArCgkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWNvbnRhaW5lciIgKyAoIGllSGFjayA/ICIgaWUiIDogIiIgKSArICInPiIgKwoJCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3cnPjwvZGl2PiIgKwoJCSI8L2Rpdj4iCgkpOwoKZnVuY3Rpb24gZ2V0QXJyb3coKSB7Cgl2YXIgY2xvbmUgPSB1aVRlbXBsYXRlLmNsb25lKCksCgkJZ2QgPSBjbG9uZS5lcSggMCApLAoJCWN0ID0gY2xvbmUuZXEoIDEgKSwKCQlhciA9IGN0LmNoaWxkcmVuKCk7CgoJcmV0dXJuIHsgYXJFbHM6IGN0LmFkZCggZ2QgKSwgZ2Q6IGdkLCBjdDogY3QsIGFyOiBhciB9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsICQubW9iaWxlLnBvcHVwLCB7CglvcHRpb25zOiB7CgoJCWFycm93OiAiIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgYXIsCgkJCXJldCA9IHRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmFycm93ICkgewoJCQl0aGlzLl91aS5hcnJvdyA9IGFyID0gdGhpcy5fYWRkQXJyb3coKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCV9hZGRBcnJvdzogZnVuY3Rpb24oKSB7CgkJdmFyIHRoZW1lLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlhciA9IGdldEFycm93KCk7CgoJCXRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQlhci5hci5hZGRDbGFzcyggdGhlbWUgKyAoIG9wdHMuc2hhZG93ID8gIiB1aS1vdmVybGF5LXNoYWRvdyIgOiAiIiApICk7CgkJYXIuYXJFbHMuaGlkZSgpLmFwcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCgkJcmV0dXJuIGFyOwoJfSwKCglfdW5lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCBhciApIHsKCQkJYXIuYXJFbHMucmVtb3ZlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJLy8gUHJldGVuZCB0byBzaG93IGFuIGFycm93IGRlc2NyaWJlZCBieSBAcCBhbmQgQGRpciBhbmQgY2FsY3VsYXRlIHRoZQoJLy8gZGlzdGFuY2UgZnJvbSB0aGUgZGVzaXJlZCBwb2ludC4gSWYgYSBiZXN0LWRpc3RhbmNlIGlzIHBhc3NlZCBpbiwgcmV0dXJuCgkvLyB0aGUgbWluaW11bSBvZiB0aGUgb25lIHBhc3NlZCBpbiBhbmQgdGhlIG9uZSBjYWxjdWxhdGVkLgoJX3RyeUFuQXJyb3c6IGZ1bmN0aW9uKCBwLCBkaXIsIGRlc2lyZWQsIHMsIGJlc3QgKSB7CgkJdmFyIHJlc3VsdCwgciwgZGlmZiwgZGVzaXJlZEZvckFycm93ID0ge30sIHRpcCA9IHt9OwoKCQkvLyBJZiB0aGUgYXJyb3cgaGFzIG5vIHdpZ2dsZSByb29tIGFsb25nIHRoZSBlZGdlIG9mIHRoZSBwb3B1cCwgaXQgY2Fubm90CgkJLy8gYmUgZGlzcGxheWVkIGFsb25nIHRoZSByZXF1ZXN0ZWQgZWRnZSB3aXRob3V0IGl0IHN0aWNraW5nIG91dC4KCQlpZiAoIHMuYXJGdWxsWyBwLmRpbUtleSBdID4gcy5ndWlkZURpbXNbIHAuZGltS2V5IF0gKSB7CgkJCXJldHVybiBiZXN0OwoJCX0KCgkJZGVzaXJlZEZvckFycm93WyBwLmZzdCBdID0gZGVzaXJlZFsgcC5mc3QgXSArCgkJCSggcy5hckhhbGZbIHAub0RpbUtleSBdICsgcy5tZW51SGFsZlsgcC5vRGltS2V5IF0gKSAqIHAub2Zmc2V0RmFjdG9yIC0KCQkJcy5jb250ZW50Qm94WyBwLmZzdCBdICsgKCBzLmNsYW1wSW5mby5tZW51U2l6ZVsgcC5vRGltS2V5IF0gLSBzLmNvbnRlbnRCb3hbIHAub0RpbUtleSBdICkgKiBwLmFycm93T2Zmc2V0RmFjdG9yOwoJCWRlc2lyZWRGb3JBcnJvd1sgcC5zbmQgXSA9IGRlc2lyZWRbIHAuc25kIF07CgoJCXJlc3VsdCA9IHMucmVzdWx0IHx8IHRoaXMuX2NhbGN1bGF0ZUZpbmFsTG9jYXRpb24oIGRlc2lyZWRGb3JBcnJvdywgcy5jbGFtcEluZm8gKTsKCQlyID0geyB4OiByZXN1bHQubGVmdCwgeTogcmVzdWx0LnRvcCB9OwoKCQl0aXBbIHAuZnN0IF0gPSByWyBwLmZzdCBdICsgcy5jb250ZW50Qm94WyBwLmZzdCBdICsgcC50aXBPZmZzZXQ7CgkJdGlwWyBwLnNuZCBdID0gTWF0aC5tYXgoIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmd1aWRlT2Zmc2V0WyBwLnByb3AgXSArIHMuYXJIYWxmWyBwLmRpbUtleSBdLAoJCQlNYXRoLm1pbiggcmVzdWx0WyBwLnByb3AgXSArIHMuZ3VpZGVPZmZzZXRbIHAucHJvcCBdICsgcy5ndWlkZURpbXNbIHAuZGltS2V5IF0gLSBzLmFySGFsZlsgcC5kaW1LZXkgXSwKCQkJCWRlc2lyZWRbIHAuc25kIF0gKSApOwoKCQlkaWZmID0gTWF0aC5hYnMoIGRlc2lyZWQueCAtIHRpcC54ICkgKyBNYXRoLmFicyggZGVzaXJlZC55IC0gdGlwLnkgKTsKCQlpZiAoICFiZXN0IHx8IGRpZmYgPCBiZXN0LmRpZmYgKSB7CgkJCS8vIENvbnZlcnQgdGlwIG9mZnNldCB0byBjb29yZGluYXRlcyBpbnNpZGUgdGhlIHBvcHVwCgkJCXRpcFsgcC5zbmQgXSAtPSBzLmFySGFsZlsgcC5kaW1LZXkgXSArIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmNvbnRlbnRCb3hbIHAuc25kIF07CgkJCWJlc3QgPSB7IGRpcjogZGlyLCBkaWZmOiBkaWZmLCByZXN1bHQ6IHJlc3VsdCwgcG9zUHJvcDogcC5wcm9wLCBwb3NWYWw6IHRpcFsgcC5zbmQgXSB9OwoJCX0KCgkJcmV0dXJuIGJlc3Q7Cgl9LAoKCV9nZXRQbGFjZW1lbnRTdGF0ZTogZnVuY3Rpb24oIGNsYW1wICkgewoJCXZhciBvZmZzZXQsIGdkT2Zmc2V0LAoJCQlhciA9IHRoaXMuX3VpLmFycm93LAoJCQlzdGF0ZSA9IHsKCQkJCWNsYW1wSW5mbzogdGhpcy5fY2xhbXBQb3B1cFdpZHRoKCAhY2xhbXAgKSwKCQkJCWFyRnVsbDogeyBjeDogYXIuY3Qud2lkdGgoKSwgY3k6IGFyLmN0LmhlaWdodCgpIH0sCgkJCQlndWlkZURpbXM6IHsgY3g6IGFyLmdkLndpZHRoKCksIGN5OiBhci5nZC5oZWlnaHQoKSB9LAoJCQkJZ3VpZGVPZmZzZXQ6IGFyLmdkLm9mZnNldCgpCgkJCX07CgoJCW9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCgkJYXIuZ2QuY3NzKCB7IGxlZnQ6IDAsIHRvcDogMCwgcmlnaHQ6IDAsIGJvdHRvbTogMCB9ICk7CgkJZ2RPZmZzZXQgPSBhci5nZC5vZmZzZXQoKTsKCQlzdGF0ZS5jb250ZW50Qm94ID0gewoJCQl4OiBnZE9mZnNldC5sZWZ0IC0gb2Zmc2V0LmxlZnQsCgkJCXk6IGdkT2Zmc2V0LnRvcCAtIG9mZnNldC50b3AsCgkJCWN4OiBhci5nZC53aWR0aCgpLAoJCQljeTogYXIuZ2QuaGVpZ2h0KCkKCQl9OwoJCWFyLmdkLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCgkJLy8gVGhlIGFycm93IGJveCBtb3ZlcyBiZXR3ZWVuIGd1aWRlT2Zmc2V0IGFuZCBndWlkZU9mZnNldCArIGd1aWRlRGltcyAtIGFyRnVsbAoJCXN0YXRlLmd1aWRlT2Zmc2V0ID0geyBsZWZ0OiBzdGF0ZS5ndWlkZU9mZnNldC5sZWZ0IC0gb2Zmc2V0LmxlZnQsIHRvcDogc3RhdGUuZ3VpZGVPZmZzZXQudG9wIC0gb2Zmc2V0LnRvcCB9OwoJCXN0YXRlLmFySGFsZiA9IHsgY3g6IHN0YXRlLmFyRnVsbC5jeCAvIDIsIGN5OiBzdGF0ZS5hckZ1bGwuY3kgLyAyIH07CgkJc3RhdGUubWVudUhhbGYgPSB7IGN4OiBzdGF0ZS5jbGFtcEluZm8ubWVudVNpemUuY3ggLyAyLCBjeTogc3RhdGUuY2xhbXBJbmZvLm1lbnVTaXplLmN5IC8gMiB9OwoKCQlyZXR1cm4gc3RhdGU7Cgl9LAoKCV9wbGFjZW1lbnRDb29yZHM6IGZ1bmN0aW9uKCBkZXNpcmVkICkgewoJCXZhciBzdGF0ZSwgYmVzdCwgcGFyYW1zLCBlbE9mZnNldCwgYmdSZWYsCgkJCW9wdGlvblZhbHVlID0gdGhpcy5vcHRpb25zLmFycm93LAoJCQlhciA9IHRoaXMuX3VpLmFycm93OwoKCQlpZiAoICFhciApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBkZXNpcmVkICk7CgkJfQoKCQlhci5hckVscy5zaG93KCk7CgoJCWJnUmVmID0ge307CgkJc3RhdGUgPSB0aGlzLl9nZXRQbGFjZW1lbnRTdGF0ZSggdHJ1ZSApOwoJCXBhcmFtcyA9IHsKCQkJImwiOiB7IGZzdDogIngiLCBzbmQ6ICJ5IiwgcHJvcDogInRvcCIsIGRpbUtleTogImN5Iiwgb0RpbUtleTogImN4Iiwgb2Zmc2V0RmFjdG9yOiAxLCB0aXBPZmZzZXQ6ICAtc3RhdGUuYXJIYWxmLmN4LCBhcnJvd09mZnNldEZhY3RvcjogMCB9LAoJCQkiciI6IHsgZnN0OiAieCIsIHNuZDogInkiLCBwcm9wOiAidG9wIiwgZGltS2V5OiAiY3kiLCBvRGltS2V5OiAiY3giLCBvZmZzZXRGYWN0b3I6IC0xLCB0aXBPZmZzZXQ6IHN0YXRlLmFySGFsZi5jeCArIHN0YXRlLmNvbnRlbnRCb3guY3gsIGFycm93T2Zmc2V0RmFjdG9yOiAxIH0sCgkJCSJiIjogeyBmc3Q6ICJ5Iiwgc25kOiAieCIsIHByb3A6ICJsZWZ0IiwgZGltS2V5OiAiY3giLCBvRGltS2V5OiAiY3kiLCBvZmZzZXRGYWN0b3I6IC0xLCB0aXBPZmZzZXQ6IHN0YXRlLmFySGFsZi5jeSArIHN0YXRlLmNvbnRlbnRCb3guY3ksIGFycm93T2Zmc2V0RmFjdG9yOiAxIH0sCgkJCSJ0IjogeyBmc3Q6ICJ5Iiwgc25kOiAieCIsIHByb3A6ICJsZWZ0IiwgZGltS2V5OiAiY3giLCBvRGltS2V5OiAiY3kiLCBvZmZzZXRGYWN0b3I6IDEsIHRpcE9mZnNldDogLXN0YXRlLmFySGFsZi5jeSwgYXJyb3dPZmZzZXRGYWN0b3I6IDAgfQoJCX07CgoJCS8vIFRyeSBlYWNoIHNpZGUgc3BlY2lmaWVkIGluIHRoZSBvcHRpb25zIHRvIHNlZSBvbiB3aGljaCBvbmUgdGhlIGFycm93CgkJLy8gc2hvdWxkIGJlIHBsYWNlZCBzdWNoIHRoYXQgdGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIHRpcCBvZiB0aGUgYXJyb3cgYW5kCgkJLy8gdGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgaXMgdGhlIHNob3J0ZXN0LgoJCSQuZWFjaCggKCBvcHRpb25WYWx1ZSA9PT0gdHJ1ZSA/ICJsLHQscixiIiA6IG9wdGlvblZhbHVlICkuc3BsaXQoICIsIiApLAoJCQkkLnByb3h5KCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCWJlc3QgPSB0aGlzLl90cnlBbkFycm93KCBwYXJhbXNbIHZhbHVlIF0sIHZhbHVlLCBkZXNpcmVkLCBzdGF0ZSwgYmVzdCApOwoJCQl9LCB0aGlzICkgKTsKCgkJLy8gQ291bGQgbm90IHBsYWNlIHRoZSBhcnJvdyBhbG9uZyBhbnkgb2YgdGhlIGVkZ2VzIC0gYmVoYXZlIGFzIGlmIHNob3dpbmcKCQkvLyB0aGUgYXJyb3cgd2FzIHR1cm5lZCBvZmYuCgkJaWYgKCAhYmVzdCApIHsKCQkJYXIuYXJFbHMuaGlkZSgpOwoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoIGRlc2lyZWQgKTsKCQl9CgoJCS8vIE1vdmUgdGhlIGFycm93IGludG8gcGxhY2UKCQlhci5jdAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hcnJvdy1sIHVpLXBvcHVwLWFycm93LXQgdWktcG9wdXAtYXJyb3ctciB1aS1wb3B1cC1hcnJvdy1iIiApCgkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWFycm93LSIgKyBiZXN0LmRpciApCgkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICkuY3NzKCBiZXN0LnBvc1Byb3AsIGJlc3QucG9zVmFsICkKCQkJLnNob3coKTsKCgkJLy8gRG8gbm90IG1vdmUvc2l6ZSB0aGUgYmFja2dyb3VuZCBkaXYgb24gSUUsIGJlY2F1c2Ugd2UgdXNlIHRoZSBhcnJvdyBkaXYgZm9yIGJhY2tncm91bmQgYXMgd2VsbC4KCQlpZiAoICFpZUhhY2sgKSB7CgkJCWVsT2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpOwoJCQliZ1JlZlsgcGFyYW1zWyBiZXN0LmRpciBdLmZzdCBdID0gYXIuY3Qub2Zmc2V0KCk7CgkJCWJnUmVmWyBwYXJhbXNbIGJlc3QuZGlyIF0uc25kIF0gPSB7CgkJCQlsZWZ0OiBlbE9mZnNldC5sZWZ0ICsgc3RhdGUuY29udGVudEJveC54LAoJCQkJdG9wOiBlbE9mZnNldC50b3AgKyBzdGF0ZS5jb250ZW50Qm94LnkKCQkJfTsKCQl9CgoJCXJldHVybiBiZXN0LnJlc3VsdDsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRzICkgewoJCXZhciBuZXdUaGVtZSwKCQkJb2xkVGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCWFyID0gdGhpcy5fdWkuYXJyb3csCgkJCXJldCA9IHRoaXMuX3N1cGVyKCBvcHRzICk7CgoJCWlmICggb3B0cy5hcnJvdyAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICFhciAmJiBvcHRzLmFycm93ICkgewoJCQkJdGhpcy5fdWkuYXJyb3cgPSB0aGlzLl9hZGRBcnJvdygpOwoKCQkJCS8vIEltcG9ydGFudCB0byByZXR1cm4gaGVyZSBzbyB3ZSBkb24ndCBzZXQgdGhlIHNhbWUgb3B0aW9ucyBhbGwgb3ZlcgoJCQkJLy8gYWdhaW4gYmVsb3cuCgkJCQlyZXR1cm47CgkJCX0gZWxzZSBpZiAoIGFyICYmICFvcHRzLmFycm93ICkgewoJCQkJYXIuYXJFbHMucmVtb3ZlKCk7CgkJCQl0aGlzLl91aS5hcnJvdyA9IG51bGw7CgkJCX0KCQl9CgoJCS8vIFJlYXNzaWduIHdpdGggcG90ZW50aWFsbHkgbmV3IGFycm93CgkJYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCBhciApIHsKCQkJaWYgKCBvcHRzLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvbGRUaGVtZSApOwoJCQkJbmV3VGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb3B0cy50aGVtZSApOwoJCQkJYXIuYXIucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0cy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJCWFyLmFyLnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBvcHRzLnNoYWRvdyApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFuZWwiLCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQlwYW5lbDogInVpLXBhbmVsIiwKCQkJcGFuZWxPcGVuOiAidWktcGFuZWwtb3BlbiIsCgkJCXBhbmVsQ2xvc2VkOiAidWktcGFuZWwtY2xvc2VkIiwKCQkJcGFuZWxGaXhlZDogInVpLXBhbmVsLWZpeGVkIiwKCQkJcGFuZWxJbm5lcjogInVpLXBhbmVsLWlubmVyIiwKCQkJbW9kYWw6ICJ1aS1wYW5lbC1kaXNtaXNzIiwKCQkJbW9kYWxPcGVuOiAidWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJcGFnZUNvbnRhaW5lcjogInVpLXBhbmVsLXBhZ2UtY29udGFpbmVyIiwKCQkJcGFnZVdyYXBwZXI6ICJ1aS1wYW5lbC13cmFwcGVyIiwKCQkJcGFnZUZpeGVkVG9vbGJhcjogInVpLXBhbmVsLWZpeGVkLXRvb2xiYXIiLAoJCQlwYWdlQ29udGVudFByZWZpeDogInVpLXBhbmVsLXBhZ2UtY29udGVudCIsIC8qIFVzZWQgZm9yIHdyYXBwZXIgYW5kIGZpeGVkIHRvb2xiYXJzIHBvc2l0aW9uLCBkaXNwbGF5IGFuZCBvcGVuIGNsYXNzZXMuICovCgkJCWFuaW1hdGU6ICJ1aS1wYW5lbC1hbmltYXRlIgoJCX0sCgkJYW5pbWF0ZTogdHJ1ZSwKCQl0aGVtZTogbnVsbCwKCQlwb3NpdGlvbjogImxlZnQiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWRpc3BsYXk6ICJyZXZlYWwiLCAvL2FjY2VwdHMgcmV2ZWFsLCBwdXNoLCBvdmVybGF5CgkJc3dpcGVDbG9zZTogdHJ1ZSwKCQlwb3NpdGlvbkZpeGVkOiBmYWxzZQoJfSwKCglfY2xvc2VMaW5rOiBudWxsLAoJX3BhcmVudFBhZ2U6IG51bGwsCglfcGFnZTogbnVsbCwKCV9tb2RhbDogbnVsbCwKCV9wYW5lbElubmVyOiBudWxsLAoJX3dyYXBwZXI6IG51bGwsCglfZml4ZWRUb29sYmFyczogbnVsbCwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWwgPSB0aGlzLmVsZW1lbnQsCgkJCXBhcmVudFBhZ2UgPSBlbC5jbG9zZXN0KCAiLnVpLXBhZ2UsIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKTsKCgkJLy8gZXhwb3NlIHNvbWUgcHJpdmF0ZSBwcm9wcyB0byBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2Nsb3NlTGluazogZWwuZmluZCggIjpqcW1EYXRhKHJlbD0nY2xvc2UnKSIgKSwKCQkJX3BhcmVudFBhZ2U6ICggcGFyZW50UGFnZS5sZW5ndGggPiAwICkgPyBwYXJlbnRQYWdlIDogZmFsc2UsCgkJCV9vcGVuZWRQYWdlOiBudWxsLAoJCQlfcGFnZTogdGhpcy5fZ2V0UGFnZSwKCQkJX3BhbmVsSW5uZXI6IHRoaXMuX2dldFBhbmVsSW5uZXIoKSwKCQkJX2ZpeGVkVG9vbGJhcnM6IHRoaXMuX2dldEZpeGVkVG9vbGJhcnMKCQl9KTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKXsKCQkJdGhpcy5fZ2V0V3JhcHBlcigpOwoJCX0KCQl0aGlzLl9hZGRQYW5lbENsYXNzZXMoKTsKCgkJLy8gaWYgYW5pbWF0aW5nLCBhZGQgdGhlIGNsYXNzIHRvIGRvIHNvCgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISF0aGlzLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5hbmltYXRlICk7CgkJfQoKCQl0aGlzLl9iaW5kVXBkYXRlTGF5b3V0KCk7CgkJdGhpcy5fYmluZENsb3NlRXZlbnRzKCk7CgkJdGhpcy5fYmluZExpbmtMaXN0ZW5lcnMoKTsKCQl0aGlzLl9iaW5kUGFnZUV2ZW50cygpOwoKCQlpZiAoICEhdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLl9jcmVhdGVNb2RhbCgpOwoJCX0KCgkJdGhpcy5fYmluZFN3aXBlRXZlbnRzKCk7Cgl9LAoKCV9nZXRQYW5lbElubmVyOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFuZWxJbm5lciA9IHRoaXMuZWxlbWVudC5maW5kKCAiLiIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICk7CgoJCWlmICggcGFuZWxJbm5lci5sZW5ndGggPT09IDAgKSB7CgkJCXBhbmVsSW5uZXIgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS53cmFwQWxsKCAiPGRpdiBjbGFzcz0nIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKyAiJyAvPiIgKS5wYXJlbnQoKTsKCQl9CgoJCXJldHVybiBwYW5lbElubmVyOwoJfSwKCglfY3JlYXRlTW9kYWw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJdGFyZ2V0ID0gc2VsZi5fcGFyZW50UGFnZSA/IHNlbGYuX3BhcmVudFBhZ2UucGFyZW50KCkgOiBzZWxmLmVsZW1lbnQucGFyZW50KCk7CgoJCXNlbGYuX21vZGFsID0gJCggIjxkaXYgY2xhc3M9JyIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5tb2RhbCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0YXJnZXQgKTsKCX0sCgoJX2dldFBhZ2U6IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gdGhpcy5fb3BlbmVkUGFnZSB8fCB0aGlzLl9wYXJlbnRQYWdlIHx8ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoKCQlyZXR1cm4gcGFnZTsKCX0sCgoJX2dldFdyYXBwZXI6IGZ1bmN0aW9uKCkgewoJCXZhciB3cmFwcGVyID0gdGhpcy5fcGFnZSgpLmZpbmQoICIuIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VXcmFwcGVyICk7CgkJaWYgKCB3cmFwcGVyLmxlbmd0aCA9PT0gMCApIHsKCQkJd3JhcHBlciA9IHRoaXMuX3BhZ2UoKS5jaGlsZHJlbiggIi51aS1oZWFkZXI6bm90KC51aS1oZWFkZXItZml4ZWQpLCAudWktY29udGVudDpub3QoLnVpLXBvcHVwKSwgLnVpLWZvb3Rlcjpub3QoLnVpLWZvb3Rlci1maXhlZCkiICkKCQkJCS53cmFwQWxsKCAiPGRpdiBjbGFzcz0nIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VXcmFwcGVyICsgIic+PC9kaXY+IiApCgkJCQkucGFyZW50KCk7CgkJfQoKCQl0aGlzLl93cmFwcGVyID0gd3JhcHBlcjsKCX0sCgoJX2dldEZpeGVkVG9vbGJhcnM6IGZ1bmN0aW9uKCkgewoJCXZhciBleHRGaXhlZFRvb2xiYXJzID0gJCggImJvZHkiICkuY2hpbGRyZW4oICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLAoJCQlpbnRGaXhlZFRvb2xiYXJzID0gdGhpcy5fcGFnZSgpLmZpbmQoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLAoJCQlmaXhlZFRvb2xiYXJzID0gZXh0Rml4ZWRUb29sYmFycy5hZGQoIGludEZpeGVkVG9vbGJhcnMgKS5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFnZUZpeGVkVG9vbGJhciApOwoKCQlyZXR1cm4gZml4ZWRUb29sYmFyczsKCX0sCgoJX2dldFBvc0Rpc3BsYXlDbGFzc2VzOiBmdW5jdGlvbiggcHJlZml4ICkgewoJCXJldHVybiBwcmVmaXggKyAiLXBvc2l0aW9uLSIgKyB0aGlzLm9wdGlvbnMucG9zaXRpb24gKyAiICIgKyBwcmVmaXggKyAiLWRpc3BsYXktIiArIHRoaXMub3B0aW9ucy5kaXNwbGF5OwoJfSwKCglfZ2V0UGFuZWxDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFuZWxDbGFzc2VzID0gdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWwgKwoJCQkiICIgKyB0aGlzLl9nZXRQb3NEaXNwbGF5Q2xhc3NlcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWwgKSArCgkJCSIgIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsQ2xvc2VkICsKCQkJIiAiICsgInVpLWJvZHktIiArICggdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiICk7CgoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJcGFuZWxDbGFzc2VzICs9ICIgIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQ7CgkJfQoKCQlyZXR1cm4gcGFuZWxDbGFzc2VzOwoJfSwKCglfYWRkUGFuZWxDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMuX2dldFBhbmVsQ2xhc3NlcygpICk7Cgl9LAoKCV9oYW5kbGVDbG9zZUNsaWNrQW5kRWF0RXZlbnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5jbG9zZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfaGFuZGxlQ2xvc2VDbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5fY2xvc2VMaW5rLCB7CgkJCSJjbGljayI6ICJfaGFuZGxlQ2xvc2VDbGljayIKCQl9KTsKCgkJdGhpcy5fb24oewoJCQkiY2xpY2sgYTpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiOiAiX2hhbmRsZUNsb3NlQ2xpY2siCgkJfSk7Cgl9LAoKCV9wb3NpdGlvblBhbmVsOiBmdW5jdGlvbiggc2Nyb2xsVG9Ub3AgKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYW5lbElubmVySGVpZ2h0ID0gc2VsZi5fcGFuZWxJbm5lci5vdXRlckhlaWdodCgpLAoJCQlleHBhbmQgPSBwYW5lbElubmVySGVpZ2h0ID4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmICggZXhwYW5kIHx8ICFzZWxmLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJaWYgKCBleHBhbmQgKSB7CgkJCQlzZWxmLl91bmZpeFBhbmVsKCk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQkJfQoJCQlpZiAoIHNjcm9sbFRvVG9wICkgewoJCQkJdGhpcy53aW5kb3dbIDAgXS5zY3JvbGxUbyggMCwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJfQoJfSwKCglfYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggJCggd2luZG93ICksIHsgInRocm90dGxlZHJlc2l6ZSI6ICJfcG9zaXRpb25QYW5lbCIgfSk7Cgl9LAoKCV91bmJpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCAkKCB3aW5kb3cgKSwgInRocm90dGxlZHJlc2l6ZSIgKTsKCX0sCgoJX3VuZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfYmluZFVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLmVsZW1lbnQub24oICJ1cGRhdGVsYXlvdXQiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAiYm9keSIsIHsKCQkJImNsaWNrIGEiOiAiX2hhbmRsZUNsaWNrIgoJCX0pOwoKCX0sCgoJX2hhbmRsZUNsaWNrOiBmdW5jdGlvbiggZSApIHsKCQl2YXIgbGluaywKCQkJcGFuZWxJZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICk7CgoJCWlmICggZS5jdXJyZW50VGFyZ2V0LmhyZWYuc3BsaXQoICIjIiApWyAxIF0gPT09IHBhbmVsSWQgJiYgcGFuZWxJZCAhPT0gdW5kZWZpbmVkICkgewoKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlsaW5rID0gJCggZS50YXJnZXQgKTsKCQkJaWYgKCBsaW5rLmhhc0NsYXNzKCAidWktYnRuIiApICkgewoJCQkJbGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCXRoaXMuZWxlbWVudC5vbmUoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCQl0aGlzLnRvZ2dsZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfYmluZFN3aXBlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWFyZWEgPSBzZWxmLl9tb2RhbCA/IHNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX21vZGFsICkgOiBzZWxmLmVsZW1lbnQ7CgoJCS8vIG9uIHN3aXBlLCBjbG9zZSB0aGUgcGFuZWwKCQlpZiAoICEhc2VsZi5vcHRpb25zLnN3aXBlQ2xvc2UgKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnBvc2l0aW9uID09PSAibGVmdCIgKSB7CgkJCQlhcmVhLm9uKCAic3dpcGVsZWZ0LnBhbmVsIiwgZnVuY3Rpb24oLyogZSAqLykgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJYXJlYS5vbiggInN3aXBlcmlnaHQucGFuZWwiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0KCQl9Cgl9LAoKCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLmRvY3VtZW50CgkJCS8vIENsb3NlIHRoZSBwYW5lbCBpZiBhbm90aGVyIHBhbmVsIG9uIHRoZSBwYWdlIG9wZW5zCgkJCS5vbiggInBhbmVsYmVmb3Jlb3BlbiIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBzZWxmLl9vcGVuICYmIGUudGFyZ2V0ICE9PSBzZWxmLmVsZW1lbnRbIDAgXSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pCgkJCS8vIE9uIGVzY2FwZSwgY2xvc2U/IG1pZ2h0IG5lZWQgdG8gaGF2ZSBhIHRhcmdldCBjaGVjayB0b28uLi4KCQkJLm9uKCAia2V5dXAucGFuZWwiLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggZS5rZXlDb2RlID09PSAyNyAmJiBzZWxmLl9vcGVuICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSk7CgkJaWYgKCAhdGhpcy5fcGFyZW50UGFnZSAmJiB0aGlzLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQl0aGlzLl9vbiggdGhpcy5kb2N1bWVudCwgewoJCQkJInBhZ2VzaG93IjogIl9nZXRXcmFwcGVyIgoJCQl9KTsKCQl9CgkJLy8gQ2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJaWYgKCBzZWxmLl9wYXJlbnRQYWdlICkgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWhpZGUiLCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCX0KCX0sCgoJLy8gc3RhdGUgc3RvcmFnZSBvZiBvcGVuIG9yIGNsb3NlZAoJX29wZW46IGZhbHNlLAoJX3BhZ2VDb250ZW50T3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgoJCQkJX29wZW5QYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuZG9jdW1lbnQub2ZmKCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLmFkZENsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQlzZWxmLmVsZW1lbnQuYW5pbWF0aW9uQ29tcGxldGUoIGNvbXBsZXRlLCAidHJhbnNpdGlvbiIgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCgkJCQkJaWYgKCBvLnRoZW1lICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkKCQkJCQkJCS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLXRoZW1lZCAiICsgby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLSIgKyBvLnRoZW1lICk7CgkJCQkJfQoKCQkJCQlzZWxmLmVsZW1lbnQKCQkJCQkJLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKQoJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCgkJCQkJc2VsZi5fcG9zaXRpb25QYW5lbCggdHJ1ZSApOwoKCQkJCQlzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCApOwoKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICk7CgkJCQkJCXNlbGYuX3dyYXBwZXIuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9tb2RhbE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5tb2RhbCApICsgIiAiICsgby5jbGFzc2VzLm1vZGFsT3BlbjsKCQkJCQlpZiAoIHNlbGYuX21vZGFsICkgewoJCQkJCQlzZWxmLl9tb2RhbAoJCQkJCQkJLmFkZENsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICkKCQkJCQkJCS5oZWlnaHQoIE1hdGgubWF4KCBzZWxmLl9tb2RhbC5oZWlnaHQoKSwgc2VsZi5kb2N1bWVudC5oZWlnaHQoKSApICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9iaW5kRml4TGlzdGVuZXIoKTsKCgkJCQkJc2VsZi5fdHJpZ2dlciggIm9wZW4iICk7CgoJCQkJCXNlbGYuX29wZW5lZFBhZ2UgPSBzZWxmLl9wYWdlKCk7CgkJCQl9OwoKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZW9wZW4iICk7CgoJCQlpZiAoIHNlbGYuX3BhZ2UoKS5qcW1EYXRhKCAicGFuZWwiICkgPT09ICJvcGVuIiApIHsKCQkJCXNlbGYuZG9jdW1lbnQub24oICJwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJX29wZW5QYW5lbCgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlfb3BlblBhbmVsKCk7CgkJCX0KCgkJCXNlbGYuX29wZW4gPSB0cnVlOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gdGhpcy5vcHRpb25zLAoKCQkJCV9jbG9zZVBhbmVsID0gZnVuY3Rpb24oKSB7CgoJCQkJCXNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCgkJCQkJaWYgKCAhaW1tZWRpYXRlICYmICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQkJc2VsZi5lbGVtZW50LmFuaW1hdGlvbkNvbXBsZXRlKCBjb21wbGV0ZSwgInRyYW5zaXRpb24iICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsLnJlbW92ZUNsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCBvLnRoZW1lICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCX0KCgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgJiYgby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJCQkJc2VsZi5fdW5iaW5kRml4TGlzdGVuZXIoKTsKCQkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCgkJCQkJc2VsZi5fcGFnZSgpLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCgkJCQkJc2VsZi5fdHJpZ2dlciggImNsb3NlIiApOwoKCQkJCQlzZWxmLl9vcGVuZWRQYWdlID0gbnVsbDsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3JlY2xvc2UiICk7CgoJCQlfY2xvc2VQYW5lbCgpOwoKCQkJc2VsZi5fb3BlbiA9IGZhbHNlOwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl0aGlzWyB0aGlzLl9vcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgb3RoZXJQYW5lbHMsCgkJbyA9IHRoaXMub3B0aW9ucywKCQltdWx0aXBsZVBhbmVscyA9ICggJCggImJvZHkgPiA6bW9iaWxlLXBhbmVsIiApLmxlbmd0aCArICQubW9iaWxlLmFjdGl2ZVBhZ2UuZmluZCggIjptb2JpbGUtcGFuZWwiICkubGVuZ3RoICkgPiAxOwoKCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoKCQkJLy8gIHJlbW92ZSB0aGUgd3JhcHBlciBpZiBub3QgaW4gdXNlIGJ5IGFub3RoZXIgcGFuZWwKCQkJb3RoZXJQYW5lbHMgPSAkKCAiYm9keSA+IDptb2JpbGUtcGFuZWwiICkuYWRkKCAkLm1vYmlsZS5hY3RpdmVQYWdlLmZpbmQoICI6bW9iaWxlLXBhbmVsIiApICk7CgkJCWlmICggb3RoZXJQYW5lbHMubm90KCAiLnVpLXBhbmVsLWRpc3BsYXktb3ZlcmxheSIgKS5ub3QoIHRoaXMuZWxlbWVudCApLmxlbmd0aCA9PT0gMCApIHsKCQkJCXRoaXMuX3dyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCQkJfQoKCQkJaWYgKCB0aGlzLl9vcGVuICkgewoKCQkJCXRoaXMuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoKCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCXRoaXMuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCX0KCgkJCQl0aGlzLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICk7CgoJCQkJaWYgKCBvLnRoZW1lICkgewoJCQkJCXRoaXMuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLXRoZW1lZCAiICsgby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLSIgKyBvLnRoZW1lICk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggIW11bHRpcGxlUGFuZWxzICkgewoKCQkJdGhpcy5kb2N1bWVudC5vZmYoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIgKTsKCgkJfQoKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXRoaXMuX3BhZ2UoKS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJfQoKCQl0aGlzLl9wYW5lbElubmVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoIFsgdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCksIG8uY2xhc3Nlcy5wYW5lbE9wZW4sIG8uY2xhc3Nlcy5hbmltYXRlIF0uam9pbiggIiAiICkgKQoJCQkub2ZmKCAic3dpcGVsZWZ0LnBhbmVsIHN3aXBlcmlnaHQucGFuZWwiICkKCQkJLm9mZiggInBhbmVsYmVmb3Jlb3BlbiIgKQoJCQkub2ZmKCAicGFuZWxoaWRlIiApCgkJCS5vZmYoICJrZXl1cC5wYW5lbCIgKQoJCQkub2ZmKCAidXBkYXRlbGF5b3V0IiApOwoKCQlpZiAoIHRoaXMuX21vZGFsICkgewoJCQl0aGlzLl9tb2RhbC5yZW1vdmUoKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsIHsKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCXRhYmxlOiAidWktdGFibGUiCgkJfSwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnRhYmxlICk7CgkJfQoKCQkvLyBleHRlbmQgaGVyZSwgYXNzaWduIG9uIHJlZnJlc2ggPiBfc2V0SGVhZGVycwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgoJCQkvLyBFeHBvc2UgaGVhZGVycyBhbmQgYWxsSGVhZGVycyBwcm9wZXJ0aWVzIG9uIHRoZSB3aWRnZXQKCQkJLy8gaGVhZGVycyByZWZlcmVuY2VzIHRoZSBUSHMgd2l0aGluIHRoZSBmaXJzdCBUUiBpbiB0aGUgdGFibGUKCQkJaGVhZGVyczogdW5kZWZpbmVkLAoKCQkJLy8gYWxsSGVhZGVycyByZWZlcmVuY2VzIGhlYWRlcnMsIHBsdXMgYWxsIFRIcyBpbiB0aGUgdGhlYWQsIHdoaWNoIG1heQoJCQkvLyBpbmNsdWRlIHNldmVyYWwgcm93cywgb3Igbm90CgkJCWFsbEhlYWRlcnM6IHVuZGVmaW5lZAoJCX0pOwoKCQl0aGlzLl9yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9zZXRIZWFkZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgdHJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0aGVhZCB0ciIgKTsKCgkJdGhpcy5oZWFkZXJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0cjplcSgwKSIgKS5jaGlsZHJlbigpOwoJCXRoaXMuYWxsSGVhZGVycyA9IHRoaXMuaGVhZGVycy5hZGQoIHRycy5jaGlsZHJlbigpICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJcmVidWlsZDogJC5ub29wLAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggLyogY3JlYXRlICovICkgewoJCXZhciB0YWJsZSA9IHRoaXMuZWxlbWVudCwKCQkJdHJzID0gdGFibGUuZmluZCggInRoZWFkIHRyIiApOwoKCQkvLyB1cGRhdGluZyBoZWFkZXJzIG9uIHJlZnJlc2ggKGZpeGVzICM1ODgwKQoJCXRoaXMuX3NldEhlYWRlcnMoKTsKCgkJLy8gSXRlcmF0ZSBvdmVyIHRoZSB0cnMKCQl0cnMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBjb2x1bW5Db3VudCA9IDA7CgoJCQkvLyBJdGVyYXRlIG92ZXIgdGhlIGNoaWxkcmVuIG9mIHRoZSB0cgoJCQkkKCB0aGlzICkuY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBzcGFuID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKSwKCQkJCQlzZWxlY3RvciA9ICI6bnRoLWNoaWxkKCIgKyAoIGNvbHVtbkNvdW50ICsgMSApICsgIikiLAoJCQkJCWo7CgoJCQkJdGhpcy5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJjb2xzdGFydCIsIGNvbHVtbkNvdW50ICsgMSApOwoKCQkJCWlmICggc3BhbiApIHsKCQkJCQlmb3IoIGogPSAwOyBqIDwgc3BhbiAtIDE7IGorKyApIHsKCQkJCQkJY29sdW1uQ291bnQrKzsKCQkJCQkJc2VsZWN0b3IgKz0gIiwgOm50aC1jaGlsZCgiICsgKCBjb2x1bW5Db3VudCArIDEgKSArICIpIjsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU3RvcmUgImNlbGxzIiBkYXRhIG9uIGhlYWRlciBhcyBhIHJlZmVyZW5jZSB0byBhbGwgY2VsbHMgaW4gdGhlCgkJCQkvLyBzYW1lIGNvbHVtbiBhcyB0aGlzIFRICgkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiwgdGFibGUuZmluZCggInRyIiApLm5vdCggdHJzLmVxKCAwICkgKS5ub3QoIHRoaXMgKS5jaGlsZHJlbiggc2VsZWN0b3IgKSApOwoKCQkJCWNvbHVtbkNvdW50Kys7CgkJCX0pOwoJCX0pOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgJC5tb2JpbGUudGFibGUsIHsKCW9wdGlvbnM6IHsKCQltb2RlOiAiY29sdW1udG9nZ2xlIiwKCQljb2x1bW5CdG5UaGVtZTogbnVsbCwKCQljb2x1bW5Qb3B1cFRoZW1lOiBudWxsLAoJCWNvbHVtbkJ0blRleHQ6ICJDb2x1bW5zLi4uIiwKCQljbGFzc2VzOiAkLmV4dGVuZCggJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcywgewoJCQlwb3B1cDogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1wb3B1cCIsCgkJCWNvbHVtbkJ0bjogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1idG4iLAoJCQlwcmlvcml0eVByZWZpeDogInVpLXRhYmxlLXByaW9yaXR5LSIsCgkJCWNvbHVtblRvZ2dsZVRhYmxlOiAidWktdGFibGUtY29sdW1udG9nZ2xlIgoJCX0pCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgIT09ICJjb2x1bW50b2dnbGUiICkgewoJCQlyZXR1cm47CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfbWVudTogbnVsbAoJCX0pOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fbWVudSA9ICQoIHRoaXMuZG9jdW1lbnRbIDAgXS5nZXRFbGVtZW50QnlJZCggdGhpcy5faWQoKSArICItcG9wdXAiICkgKS5jaGlsZHJlbigpLmZpcnN0KCk7CgkJCXRoaXMuX2FkZFRvZ2dsZXMoIHRoaXMuX21lbnUsIHRydWUgKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9tZW51ID0gdGhpcy5fZW5oYW5jZUNvbFRvZ2dsZSgpOwoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmNvbHVtblRvZ2dsZVRhYmxlICk7CgkJfQoKCQl0aGlzLl9zZXR1cEV2ZW50cygpOwoKCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJfSwKCglfaWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICkgfHwgKCB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQgKSApOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCkgewoJCS8vTk9URTogaW5wdXRzIGFyZSBib3VuZCBpbiBiaW5kVG9nZ2xlcywKCQkvLyBzbyBpdCBjYW4gYmUgY2FsbGVkIG9uIHJlZnJlc2gsIHRvbwoKCQkvLyB1cGRhdGUgY29sdW1uIHRvZ2dsZXMgb24gcmVzaXplCgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCXRocm90dGxlZHJlc2l6ZTogIl9zZXRUb2dnbGVTdGF0ZSIKCQl9KTsKCQl0aGlzLl9vbiggdGhpcy5fbWVudSwgewoJCQkiY2hhbmdlIGlucHV0IjogIl9tZW51SW5wdXRDaGFuZ2UiCgkJfSk7Cgl9LAoKCV9hZGRUb2dnbGVzOiBmdW5jdGlvbiggbWVudSwga2VlcCApIHsKCQl2YXIgaW5wdXRzLAoJCQljaGVja2JveEluZGV4ID0gMCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJY29udGFpbmVyID0gbWVudS5jb250cm9sZ3JvdXAoICJjb250YWluZXIiICk7CgoJCS8vIGFsbG93IHVwZGF0ZSBvZiBtZW51IG9uIHJlZnJlc2ggKGZpeGVzICM1ODgwKQoJCWlmICgga2VlcCApIHsKCQkJaW5wdXRzID0gbWVudS5maW5kKCAiaW5wdXQiICk7CgkJfSBlbHNlIHsKCQkJY29udGFpbmVyLmVtcHR5KCk7CgkJfQoKCQkvLyBjcmVhdGUgdGhlIGhpZGUvc2hvdyB0b2dnbGVzCgkJdGhpcy5oZWFkZXJzLm5vdCggInRkIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgaGVhZGVyID0gJCggdGhpcyApLAoJCQkJcHJpb3JpdHkgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJwcmlvcml0eSIgKSwKCQkJCWNlbGxzID0gaGVhZGVyLmFkZCggaGVhZGVyLmpxbURhdGEoICJjZWxscyIgKSApOwoKCQkJaWYgKCBwcmlvcml0eSApIHsKCQkJCWNlbGxzLmFkZENsYXNzKCBvcHRzLmNsYXNzZXMucHJpb3JpdHlQcmVmaXggKyBwcmlvcml0eSApOwoKCQkJCSgga2VlcCA/IGlucHV0cy5lcSggY2hlY2tib3hJbmRleCsrICkgOgoJCQkJCSQoIjxsYWJlbD48aW5wdXQgdHlwZT0nY2hlY2tib3gnIGNoZWNrZWQgLz4iICsKCQkJCQkJKCBoZWFkZXIuY2hpbGRyZW4oICJhYmJyIiApLmZpcnN0KCkuYXR0ciggInRpdGxlIiApIHx8CgkJCQkJCQloZWFkZXIudGV4dCgpICkgKwoJCQkJCQkiPC9sYWJlbD4iICkKCQkJCQkJLmFwcGVuZFRvKCBjb250YWluZXIgKQoJCQkJCQkuY2hpbGRyZW4oIDAgKQoJCQkJCQkuY2hlY2tib3hyYWRpbyggewoJCQkJCQkJdGhlbWU6IG9wdHMuY29sdW1uUG9wdXBUaGVtZQoJCQkJCQl9KSApCgkJCQkJLmpxbURhdGEoICJjZWxscyIsIGNlbGxzICk7CgkJCX0KCQl9KTsKCgkJLy8gc2V0IGJpbmRpbmdzIGhlcmUKCQlpZiAoICFrZWVwICkgewoJCQltZW51LmNvbnRyb2xncm91cCggInJlZnJlc2giICk7CgkJfQoJfSwKCglfbWVudUlucHV0Q2hhbmdlOiBmdW5jdGlvbiggZXZ0ICkgewoJCXZhciBpbnB1dCA9ICQoIGV2dC50YXJnZXQgKSwKCQkJY2hlY2tlZCA9IGlucHV0WyAwIF0uY2hlY2tlZDsKCgkJaW5wdXQuanFtRGF0YSggImNlbGxzIiApCgkJCS50b2dnbGVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIiwgIWNoZWNrZWQgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLXZpc2libGUiLCBjaGVja2VkICk7CgoJCWlmICggaW5wdXRbIDAgXS5nZXRBdHRyaWJ1dGUoICJsb2NrZWQiICkgKSB7CgkJCWlucHV0LnJlbW92ZUF0dHIoICJsb2NrZWQiICk7CgoJCQl0aGlzLl91bmxvY2tDZWxscyggaW5wdXQuanFtRGF0YSggImNlbGxzIiApICk7CgkJfSBlbHNlIHsKCQkJaW5wdXQuYXR0ciggImxvY2tlZCIsIHRydWUgKTsKCQl9Cgl9LAoKCV91bmxvY2tDZWxsczogZnVuY3Rpb24oIGNlbGxzICkgewoJCS8vIGFsbG93IGhpZGUvc2hvdyB2aWEgQ1NTIG9ubHkgPSByZW1vdmUgYWxsIHRvZ2dsZS1sb2NrcwoJCWNlbGxzLnJlbW92ZUNsYXNzKCAidWktdGFibGUtY2VsbC1oaWRkZW4gdWktdGFibGUtY2VsbC12aXNpYmxlIik7Cgl9LAoKCV9lbmhhbmNlQ29sVG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWQgLCBtZW51QnV0dG9uLCBwb3B1cCwgbWVudSwKCQkJdGFibGUgPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCW5zID0gJC5tb2JpbGUubnMsCgkJCWZyYWdtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCgkJaWQgPSB0aGlzLl9pZCgpICsgIi1wb3B1cCI7CgkJbWVudUJ1dHRvbiA9ICQoICI8YSBocmVmPScjIiArIGlkICsgIicgIiArCgkJCSJjbGFzcz0nIiArIG9wdHMuY2xhc3Nlcy5jb2x1bW5CdG4gKyAiIHVpLWJ0biAiICsKCQkJInVpLWJ0bi0iICsgKCBvcHRzLmNvbHVtbkJ0blRoZW1lIHx8ICJhIiApICsKCQkJIiB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyB1aS1taW5pJyAiICsKCQkJImRhdGEtIiArIG5zICsgInJlbD0ncG9wdXAnPiIgKyBvcHRzLmNvbHVtbkJ0blRleHQgKyAiPC9hPiIgKTsKCQlwb3B1cCA9ICQoICI8ZGl2IGNsYXNzPSciICsgb3B0cy5jbGFzc2VzLnBvcHVwICsgIicgaWQ9JyIgKyBpZCArICInPjwvZGl2PiIgKTsKCQltZW51ID0gJCggIjxmaWVsZHNldD48L2ZpZWxkc2V0PiIgKS5jb250cm9sZ3JvdXAoKTsKCgkJLy8gc2V0IGV4dGVuc2lvbiBoZXJlLCBzZW5kICJmYWxzZSIgdG8gdHJpZ2dlciBidWlsZC9yZWJ1aWxkCgkJdGhpcy5fYWRkVG9nZ2xlcyggbWVudSwgZmFsc2UgKTsKCgkJbWVudS5hcHBlbmRUbyggcG9wdXAgKTsKCgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHBvcHVwWyAwIF0gKTsKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggbWVudUJ1dHRvblsgMCBdICk7CgkJdGFibGUuYmVmb3JlKCBmcmFnbWVudCApOwoKCQlwb3B1cC5wb3B1cCgpOwoKCQlyZXR1cm4gbWVudTsKCX0sCgoJcmVidWlsZDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSA9PT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJCS8vIE5PVEU6IHJlYnVpbGQgcGFzc2VzICJmYWxzZSIsIHdoaWxlIHJlZnJlc2ggcGFzc2VzICJ1bmRlZmluZWQiCgkJCS8vIGJvdGggcmVmcmVzaCB0aGUgdGFibGUsIGJ1dCBpbnNpZGUgYWRkVG9nZ2xlcywgIWZhbHNlIHdpbGwgYmUgdHJ1ZSwKCQkJLy8gc28gYSByZWJ1aWxkIGNhbGwgY2FuIGJlIGluZGVudGlmaWVkCgkJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7CgkJfQoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLl9zdXBlciggY3JlYXRlICk7CgoJCWlmICggIWNyZWF0ZSAmJiB0aGlzLm9wdGlvbnMubW9kZSA9PT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJCS8vIGNvbHVtbnMgbm90IGJlaW5nIHJlcGxhY2VkIG11c3QgYmUgY2xlYXJlZCBmcm9tIGlucHV0IHRvZ2dsZS1sb2NrcwoJCQl0aGlzLl91bmxvY2tDZWxscyggdGhpcy5lbGVtZW50LmZpbmQoICIudWktdGFibGUtY2VsbC1oaWRkZW4sICIgKwoJCQkJIi51aS10YWJsZS1jZWxsLXZpc2libGUiICkgKTsKCgkJCS8vIHVwZGF0ZSBjb2x1bW50b2dnbGVzIGFuZCBjZWxscwoJCQl0aGlzLl9hZGRUb2dnbGVzKCB0aGlzLl9tZW51LCBjcmVhdGUgKTsKCgkJCS8vIGNoZWNrL3VuY2hlY2sKCQkJdGhpcy5fc2V0VG9nZ2xlU3RhdGUoKTsKCQl9Cgl9LAoKCV9zZXRUb2dnbGVTdGF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fbWVudS5maW5kKCAiaW5wdXQiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBjaGVja2JveCA9ICQoIHRoaXMgKTsKCgkJCXRoaXMuY2hlY2tlZCA9IGNoZWNrYm94LmpxbURhdGEoICJjZWxscyIgKS5lcSggMCApLmNzcyggImRpc3BsYXkiICkgPT09ICJ0YWJsZS1jZWxsIjsKCQkJY2hlY2tib3guY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfSk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCAkLm1vYmlsZS50YWJsZSwgewoJb3B0aW9uczogewoJCW1vZGU6ICJyZWZsb3ciLAoJCWNsYXNzZXM6ICQuZXh0ZW5kKCAkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLCB7CgkJCXJlZmxvd1RhYmxlOiAidWktdGFibGUtcmVmbG93IiwKCQkJY2VsbExhYmVsczogInVpLXRhYmxlLWNlbGwtbGFiZWwiCgkJfSkKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJLy8gSWYgaXQncyBub3QgcmVmbG93IG1vZGUsIHJldHVybiBoZXJlLgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgIT09ICJyZWZsb3ciICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucmVmbG93VGFibGUgKTsKCgkJCXRoaXMuX3VwZGF0ZVJlZmxvdygpOwoJCX0KCX0sCgoJcmVidWlsZDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSA9PT0gInJlZmxvdyIgKSB7CgkJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7CgkJfQoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLl9zdXBlciggY3JlYXRlICk7CgkJaWYgKCAhY3JlYXRlICYmIHRoaXMub3B0aW9ucy5tb2RlID09PSAicmVmbG93IiApIHsKCQkJdGhpcy5fdXBkYXRlUmVmbG93KCApOwoJCX0KCX0sCgoJX3VwZGF0ZVJlZmxvdzogZnVuY3Rpb24oKSB7CgkJdmFyIHRhYmxlID0gdGhpcywKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gZ2V0IGhlYWRlcnMgaW4gcmV2ZXJzZSBvcmRlciBzbyB0aGF0IHRvcC1sZXZlbCBoZWFkZXJzIGFyZSBhcHBlbmRlZCBsYXN0CgkJJCggdGFibGUuYWxsSGVhZGVycy5nZXQoKS5yZXZlcnNlKCkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNlbGxzID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSwKCQkJCWNvbHN0YXJ0ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiY29sc3RhcnQiICksCgkJCQloaWVyYXJjaHlDbGFzcyA9IGNlbGxzLm5vdCggdGhpcyApLmZpbHRlciggInRoZWFkIHRoIiApLmxlbmd0aCAmJiAiIHVpLXRhYmxlLWNlbGwtbGFiZWwtdG9wIiwKCQkJCXRleHQgPSAkKCB0aGlzICkudGV4dCgpLAoJCQkJaXRlcmF0aW9uLCBmaWx0ZXI7CgoJCQkJaWYgKCB0ZXh0ICE9PSAiIiAgKSB7CgoJCQkJCWlmICggaGllcmFyY2h5Q2xhc3MgKSB7CgkJCQkJCWl0ZXJhdGlvbiA9IHBhcnNlSW50KCB0aGlzLmdldEF0dHJpYnV0ZSggImNvbHNwYW4iICksIDEwICk7CgkJCQkJCWZpbHRlciA9ICIiOwoKCQkJCQkJaWYgKCBpdGVyYXRpb24gKSB7CgkJCQkJCQlmaWx0ZXIgPSAidGQ6bnRoLWNoaWxkKCIrIGl0ZXJhdGlvbiArIm4gKyAiICsgKCBjb2xzdGFydCApICsiKSI7CgkJCQkJCX0KCgkJCQkJCXRhYmxlLl9hZGRMYWJlbHMoIGNlbGxzLmZpbHRlciggZmlsdGVyICksIG9wdHMuY2xhc3Nlcy5jZWxsTGFiZWxzICsgaGllcmFyY2h5Q2xhc3MsIHRleHQgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0YWJsZS5fYWRkTGFiZWxzKCBjZWxscywgb3B0cy5jbGFzc2VzLmNlbGxMYWJlbHMsIHRleHQgKTsKCQkJCQl9CgoJCQkJfQoJCX0pOwoJfSwKCglfYWRkTGFiZWxzOiBmdW5jdGlvbiggY2VsbHMsIGxhYmVsLCB0ZXh0ICkgewoJCS8vIC5ub3QgZml4ZXMgIzYwMDYKCQljZWxscy5ub3QoICI6aGFzKGIuIiArIGxhYmVsICsgIikiICkucHJlcGVuZCggIjxiIGNsYXNzPSciICsgbGFiZWwgKyAiJz4iICsgdGV4dCArICI8L2I+IiAgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIFRPRE8gcmVuYW1lIGZpbHRlckNhbGxiYWNrL2RlcHJlY2F0ZSBhbmQgZGVmYXVsdCB0byB0aGUgaXRlbSBpdHNlbGYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CnZhciBkZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICggKCAiIiArICggJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiZmlsdGVydGV4dCIgKSB8fCAkKCB0aGlzICkudGV4dCgpICkgKQoJCS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xICk7Cn07CgokLndpZGdldCggIm1vYmlsZS5maWx0ZXJhYmxlIiwgewoKCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKGZpbHRlcj0ndHJ1ZScpIiwKCglvcHRpb25zOiB7CgkJZmlsdGVyUmV2ZWFsOiBmYWxzZSwKCQlmaWx0ZXJDYWxsYmFjazogZGVmYXVsdEZpbHRlckNhbGxiYWNrLAoJCWVuaGFuY2VkOiBmYWxzZSwKCQlpbnB1dDogbnVsbCwKCQljaGlsZHJlbjogIj4gbGksID4gb3B0aW9uLCA+IG9wdGdyb3VwIG9wdGlvbiwgPiB0Ym9keSB0ciwgPiAudWktY29udHJvbGdyb3VwLWNvbnRyb2xzID4gLnVpLWJ0biwgPiAudWktY29udHJvbGdyb3VwLWNvbnRyb2xzID4gLnVpLWNoZWNrYm94LCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktcmFkaW8iCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2VhcmNoOiBudWxsLAoJCQlfdGltZXI6IDAKCQl9KTsKCgkJdGhpcy5fc2V0SW5wdXQoIG9wdHMuaW5wdXQgKTsKCQlpZiAoICFvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl9maWx0ZXJJdGVtcyggKCAoIHRoaXMuX3NlYXJjaCAmJiB0aGlzLl9zZWFyY2gudmFsKCkgKSB8fCAiIiApLnRvTG93ZXJDYXNlKCkgKTsKCQl9Cgl9LAoKCV9vbktleVVwOiBmdW5jdGlvbigpIHsKCQl2YXIgdmFsLCBsYXN0dmFsLAoJCQlzZWFyY2ggPSB0aGlzLl9zZWFyY2g7CgoJCWlmICggc2VhcmNoICkgewoJCQl2YWwgPSBzZWFyY2gudmFsKCkudG9Mb3dlckNhc2UoKSwKCQkJbGFzdHZhbCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggc2VhcmNoWyAwIF0sICJsYXN0dmFsIiApICsgIiI7CgoJCQlpZiAoIGxhc3R2YWwgJiYgbGFzdHZhbCA9PT0gdmFsICkgewoJCQkJLy8gRXhlY3V0ZSB0aGUgaGFuZGxlciBvbmx5IG9uY2UgcGVyIHZhbHVlIGNoYW5nZQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHRoaXMuX3RpbWVyICkgewoJCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJCXRoaXMuX3RpbWVyID0gMDsKCQkJfQoKCQkJdGhpcy5fdGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlZmlsdGVyIiwgbnVsbCwgeyBpbnB1dDogc2VhcmNoIH0gKTsKCgkJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCQlzZWFyY2hbIDAgXS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJsYXN0dmFsIiwgdmFsICk7CgoJCQkJdGhpcy5fZmlsdGVySXRlbXMoIHZhbCApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9LCAyNTAgKTsKCQl9Cgl9LAoKCV9nZXRGaWx0ZXJhYmxlSXRlbXM6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQljaGlsZHJlbiA9IHRoaXMub3B0aW9ucy5jaGlsZHJlbiwKCQkJaXRlbXMgPSAhY2hpbGRyZW4gPyB7IGxlbmd0aDogMCB9OgoJCQkJJC5pc0Z1bmN0aW9uKCBjaGlsZHJlbiApID8gY2hpbGRyZW4oKToKCQkJCWNoaWxkcmVuLm5vZGVOYW1lID8gJCggY2hpbGRyZW4gKToKCQkJCWNoaWxkcmVuLmpxdWVyeSA/IGNoaWxkcmVuOgoJCQkJdGhpcy5lbGVtZW50LmZpbmQoIGNoaWxkcmVuICk7CgoJCWlmICggaXRlbXMubGVuZ3RoID09PSAwICkgewoJCQlpdGVtcyA9IGVsZW0uY2hpbGRyZW4oKTsKCQl9CgoJCXJldHVybiBpdGVtczsKCX0sCgoJX2ZpbHRlckl0ZW1zOiBmdW5jdGlvbiggdmFsICkgewoJCXZhciBpZHgsIGNhbGxiYWNrLCBsZW5ndGgsIGRzdCwKCQkJc2hvdyA9IFtdLAoJCQloaWRlID0gW10sCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWZpbHRlckl0ZW1zID0gdGhpcy5fZ2V0RmlsdGVyYWJsZUl0ZW1zKCk7CgoJCWlmICggdmFsICE9IG51bGwgKSB7CgkJCWNhbGxiYWNrID0gb3B0cy5maWx0ZXJDYWxsYmFjayB8fCBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgkJCWxlbmd0aCA9IGZpbHRlckl0ZW1zLmxlbmd0aDsKCgkJCS8vIFBhcnRpdGlvbiB0aGUgaXRlbXMgaW50byB0aG9zZSB0byBiZSBoaWRkZW4gYW5kIHRob3NlIHRvIGJlIHNob3duCgkJCWZvciAoIGlkeCA9IDAgOyBpZHggPCBsZW5ndGggOyBpZHgrKyApIHsKCQkJCWRzdCA9ICggY2FsbGJhY2suY2FsbCggZmlsdGVySXRlbXNbIGlkeCBdLCBpZHgsIHZhbCApICkgPyBoaWRlIDogc2hvdzsKCQkJCWRzdC5wdXNoKCBmaWx0ZXJJdGVtc1sgaWR4IF0gKTsKCQkJfQoJCX0KCgkJLy8gSWYgbm90aGluZyBpcyBoaWRkZW4sIHRoZW4gdGhlIGRlY2lzaW9uIHdoZXRoZXIgdG8gaGlkZSBvciBzaG93IHRoZSBpdGVtcwoJCS8vIGlzIGJhc2VkIG9uIHRoZSAiZmlsdGVyUmV2ZWFsIiBvcHRpb24uCgkJaWYgKCBoaWRlLmxlbmd0aCA9PT0gMCApIHsKCQkJZmlsdGVySXRlbXNbIG9wdHMuZmlsdGVyUmV2ZWFsID8gImFkZENsYXNzIiA6ICJyZW1vdmVDbGFzcyIgXSggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJJCggaGlkZSApLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJJCggc2hvdyApLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9CgoJCXRoaXMuX3JlZnJlc2hDaGlsZFdpZGdldCgpOwoKCQl0aGlzLl90cmlnZ2VyKCAiZmlsdGVyIiwgbnVsbCwgewoJCQlpdGVtczogZmlsdGVySXRlbXMKCQl9KTsKCX0sCgoJLy8gVGhlIERlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgX3JlZnJlc2hDaGlsZFdpZGdldCBhdHRlbXB0cyB0byBjYWxsCgkvLyByZWZyZXNoIG9uIGNvbGxhcHNpYmxlc2V0LCBjb250cm9sZ3JvdXAsIHNlbGVjdG1lbnUsIG9yIGxpc3R2aWV3CglfcmVmcmVzaENoaWxkV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQl2YXIgd2lkZ2V0LCBpZHgsCgkJCXJlY29nbml6ZWRXaWRnZXRzID0gWyAiY29sbGFwc2libGVzZXQiLCAic2VsZWN0bWVudSIsICJjb250cm9sZ3JvdXAiLCAibGlzdHZpZXciIF07CgoJCWZvciAoIGlkeCA9IHJlY29nbml6ZWRXaWRnZXRzLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQl3aWRnZXQgPSByZWNvZ25pemVkV2lkZ2V0c1sgaWR4IF07CgkJCWlmICggJC5tb2JpbGVbIHdpZGdldCBdICkgewoJCQkJd2lkZ2V0ID0gdGhpcy5lbGVtZW50LmRhdGEoICJtb2JpbGUtIiArIHdpZGdldCApOwoJCQkJaWYgKCB3aWRnZXQgJiYgJC5pc0Z1bmN0aW9uKCB3aWRnZXQucmVmcmVzaCApICkgewoJCQkJCXdpZGdldC5yZWZyZXNoKCk7CgkJCQl9CgkJCX0KCQl9Cgl9LAoKCS8vIFRPRE86IFdoZW4gdGhlIGlucHV0IGlzIG5vdCBpbnRlcm5hbCwgZG8gbm90IGV2ZW4gc3RvcmUgaXQgaW4gdGhpcy5fc2VhcmNoCglfc2V0SW5wdXQ6IGZ1bmN0aW9uICggc2VsZWN0b3IgKSB7CgkJdmFyIHNlYXJjaCA9IHRoaXMuX3NlYXJjaDsKCgkJLy8gU3RvcCBhIHBlbmRpbmcgZmlsdGVyIG9wZXJhdGlvbgoJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCXRoaXMuX3RpbWVyID0gMDsKCQl9CgoJCWlmICggc2VhcmNoICkgewoJCQl0aGlzLl9vZmYoIHNlYXJjaCwgImtleXVwIGNoYW5nZSBpbnB1dCIgKTsKCQkJc2VhcmNoID0gbnVsbDsKCQl9CgoJCWlmICggc2VsZWN0b3IgKSB7CgkJCXNlYXJjaCA9IHNlbGVjdG9yLmpxdWVyeSA/IHNlbGVjdG9yOgoJCQkJc2VsZWN0b3Iubm9kZU5hbWUgPyAkKCBzZWxlY3RvciApOgoJCQkJdGhpcy5kb2N1bWVudC5maW5kKCBzZWxlY3RvciApOwoKCQkJdGhpcy5fb24oIHNlYXJjaCwgewoJCQkJa2V5dXA6ICJfb25LZXlVcCIsCgkJCQljaGFuZ2U6ICJfb25LZXlVcCIsCgkJCQlpbnB1dDogIl9vbktleVVwIgoJCQl9KTsKCQl9CgoJCXRoaXMuX3NlYXJjaCA9IHNlYXJjaDsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZWZpbHRlciA9ICEoICggb3B0aW9ucy5maWx0ZXJSZXZlYWwgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuY2hpbGRyZW4gPT09IHVuZGVmaW5lZCApICk7CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggb3B0aW9ucy5pbnB1dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRJbnB1dCggb3B0aW9ucy5pbnB1dCApOwoJCQlyZWZpbHRlciA9IHRydWU7CgkJfQoKCQlpZiAoIHJlZmlsdGVyICkgewoJCQl0aGlzLnJlZnJlc2goKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJaXRlbXMgPSB0aGlzLl9nZXRGaWx0ZXJhYmxlSXRlbXMoKTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlpdGVtcy50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBvcHRzLmZpbHRlclJldmVhbCApOwoJCX0gZWxzZSB7CgkJCWl0ZW1zLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCXRoaXMuX3RpbWVyID0gMDsKCQl9CgkJdGhpcy5fZmlsdGVySXRlbXMoICggKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLnZhbCgpICkgfHwgIiIgKS50b0xvd2VyQ2FzZSgpICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBDcmVhdGUgYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmVwbGFjZSB0aGUgX3NldE9wdGlvbnMgZnVuY3Rpb24gb2YgYSB3aWRnZXQsCi8vIGFuZCB3aWxsIHBhc3MgdGhlIG9wdGlvbnMgb24gdG8gdGhlIGlucHV0IG9mIHRoZSBmaWx0ZXJhYmxlLgp2YXIgcmVwbGFjZVNldE9wdGlvbnMgPSBmdW5jdGlvbiggc2VsZiwgb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCW9yaWcuY2FsbCggdGhpcywgb3B0aW9ucyApOwoJCQlzZWxmLl9zeW5jVGV4dElucHV0T3B0aW9ucyggb3B0aW9ucyApOwoJCX07Cgl9LAoJckRpdmlkZXJMaXN0SXRlbSA9IC8oXnxccyl1aS1saS1kaXZpZGVyKFxzfCQpLywKCW9yaWdEZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSAkLm1vYmlsZS5maWx0ZXJhYmxlLnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrOwoKLy8gT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZmlsdGVyIGNhbGxiYWNrIHdpdGggb25lIHRoYXQgZG9lcyBub3QgaGlkZSBsaXN0IGRpdmlkZXJzCiQubW9iaWxlLmZpbHRlcmFibGUucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICF0aGlzLmNsYXNzTmFtZS5tYXRjaCggckRpdmlkZXJMaXN0SXRlbSApICYmCgkJb3JpZ0RlZmF1bHRGaWx0ZXJDYWxsYmFjay5jYWxsKCB0aGlzLCBpbmRleCwgc2VhcmNoVmFsdWUgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCAkLm1vYmlsZS5maWx0ZXJhYmxlLCB7CglvcHRpb25zOiB7CgkJZmlsdGVyUGxhY2Vob2xkZXI6ICJGaWx0ZXIgaXRlbXMuLi4iLAoJCWZpbHRlclRoZW1lOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIHdpZGdldE5hbWUsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCXJlY29nbml6ZWRXaWRnZXRzID0gWyAiY29sbGFwc2libGVzZXQiLCAic2VsZWN0bWVudSIsICJjb250cm9sZ3JvdXAiLCAibGlzdHZpZXciIF0sCgkJCWNyZWF0ZUhhbmRsZXJzID0ge307CgoJCXRoaXMuX3N1cGVyKCk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV93aWRnZXQ6IG51bGwKCQl9KTsKCgkJZm9yICggaWR4ID0gcmVjb2duaXplZFdpZGdldHMubGVuZ3RoIC0gMSA7IGlkeCA+IC0xIDsgaWR4LS0gKSB7CgkJCXdpZGdldE5hbWUgPSByZWNvZ25pemVkV2lkZ2V0c1sgaWR4IF07CgkJCWlmICggJC5tb2JpbGVbIHdpZGdldE5hbWUgXSApIHsKCQkJCWlmICggdGhpcy5fc2V0V2lkZ2V0KCBlbGVtLmRhdGEoICJtb2JpbGUtIiArIHdpZGdldE5hbWUgKSApICkgewoJCQkJCWJyZWFrOwoJCQkJfSBlbHNlIHsKCQkJCQljcmVhdGVIYW5kbGVyc1sgd2lkZ2V0TmFtZSArICJjcmVhdGUiIF0gPSAiX2hhbmRsZUNyZWF0ZSI7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggIXRoaXMuX3dpZGdldCApIHsKCQkJdGhpcy5fb24oIGVsZW0sIGNyZWF0ZUhhbmRsZXJzICk7CgkJfQoJfSwKCglfaGFuZGxlQ3JlYXRlOiBmdW5jdGlvbiggZXZ0ICkgewoJCXRoaXMuX3NldFdpZGdldCggdGhpcy5lbGVtZW50LmRhdGEoICJtb2JpbGUtIiArIGV2dC50eXBlLnN1YnN0cmluZyggMCwgZXZ0LnR5cGUubGVuZ3RoIC0gNiApICkgKTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQlpZiAoIHRoaXMuX3dpZGdldCAmJiB0aGlzLl93aWRnZXQud2lkZ2V0RnVsbE5hbWUgPT09ICJtb2JpbGUtbGlzdHZpZXciICYmCgkJCXR5cGUgPT09ICJiZWZvcmVmaWx0ZXIiICkgewoKCQkJLy8gQWxzbyB0cmlnZ2VyIGxpc3R2aWV3YmVmb3JlZmlsdGVyIGlmIHRoaXMgd2lkZ2V0IGlzIGFsc28gYSBsaXN0dmlldwoJCQl0aGlzLl93aWRnZXQuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCBldmVudCwgZGF0YSApOwoJCX0KCQl0aGlzLl9zdXBlciggdHlwZSwgZXZlbnQsIGRhdGEgKTsKCX0sCgoJX3NldFdpZGdldDogZnVuY3Rpb24oIHdpZGdldCApIHsKCQlpZiAoICF0aGlzLl93aWRnZXQgJiYgd2lkZ2V0ICkgewoJCQl0aGlzLl93aWRnZXQgPSB3aWRnZXQ7CgkJCXRoaXMuX3dpZGdldC5fc2V0T3B0aW9ucyA9IHJlcGxhY2VTZXRPcHRpb25zKCB0aGlzLCB0aGlzLl93aWRnZXQuX3NldE9wdGlvbnMgKTsKCQl9CgoJCWlmICggISF0aGlzLl93aWRnZXQgKSB7CgkJCXRoaXMuX3N5bmNUZXh0SW5wdXRPcHRpb25zKCB0aGlzLl93aWRnZXQub3B0aW9ucyApOwoJCQlpZiAoIHRoaXMuX3dpZGdldC53aWRnZXROYW1lID09PSAibGlzdHZpZXciICkgewoJCQkJdGhpcy5fd2lkZ2V0Lm9wdGlvbnMuaGlkZURpdmlkZXJzID0gdHJ1ZTsKCQkJCXRoaXMuX3dpZGdldC5lbGVtZW50Lmxpc3R2aWV3KCAicmVmcmVzaCIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuICEhdGhpcy5fd2lkZ2V0OwoJfSwKCglfaXNTZWFyY2hJbnRlcm5hbDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC5qcW1EYXRhKCAidWktZmlsdGVyYWJsZS0iICsgdGhpcy51dWlkICsgIi1pbnRlcm5hbCIgKSApOwoJfSwKCglfc2V0SW5wdXQ6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdXBkYXRlUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQl0ZXh0aW5wdXRPcHRzID0ge307CgoJCWlmICggIXNlbGVjdG9yICkgewoJCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSApIHsKCgkJCQkvLyBJZ25vcmUgdGhlIGNhbGwgdG8gc2V0IGEgbmV3IGlucHV0IGlmIHRoZSBzZWxlY3RvciBnb2VzIHRvIGZhbHN5IGFuZAoJCQkJLy8gdGhlIGN1cnJlbnQgdGV4dGlucHV0IGlzIGFscmVhZHkgb2YgdGhlIGludGVybmFsbHkgZ2VuZXJhdGVkIHZhcmlldHkuCgkJCQlyZXR1cm47CgkJCX0gZWxzZSB7CgoJCQkJLy8gR2VuZXJhdGluZyBhIG5ldyB0ZXh0aW5wdXQgd2lkZ2V0LiBObyBuZWVkIHRvIHNldCB0aGUgcGxhY2Vob2xkZXIKCQkJCS8vIGZ1cnRoZXIgZG93biB0aGUgZnVuY3Rpb24uCgkJCQl1cGRhdGVQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJc2VsZWN0b3IgPSAkKCAiPGlucHV0ICIgKwoJCQkJCSJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPSdzZWFyY2gnICIgKwoJCQkJCSJwbGFjZWhvbGRlcj0nIiArIG9wdHMuZmlsdGVyUGxhY2Vob2xkZXIgKyAiJz48L2lucHV0PiIgKQoJCQkJCS5qcW1EYXRhKCAidWktZmlsdGVyYWJsZS0iICsgdGhpcy51dWlkICsgIi1pbnRlcm5hbCIsIHRydWUgKTsKCQkJCSQoICI8Zm9ybSBjbGFzcz0ndWktZmlsdGVyYWJsZSc+PC9mb3JtPiIgKQoJCQkJCS5hcHBlbmQoIHNlbGVjdG9yICkKCQkJCQkuc3VibWl0KCBmdW5jdGlvbiggZXZ0ICkgewoJCQkJCQlldnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJc2VsZWN0b3IuYmx1cigpOwoJCQkJCX0pCgkJCQkJLmluc2VydEJlZm9yZSggdGhpcy5lbGVtZW50ICk7CgkJCQlpZiAoICQubW9iaWxlLnRleHRpbnB1dCApIHsKCQkJCQlpZiAoIHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZSAhPSBudWxsICkgewoJCQkJCQl0ZXh0aW5wdXRPcHRzWyAidGhlbWUiIF0gPSBvcHRzLmZpbHRlclRoZW1lOwoJCQkJCX0KCgkJCQkJc2VsZWN0b3IudGV4dGlucHV0KCB0ZXh0aW5wdXRPcHRzICk7CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuX3N1cGVyKCBzZWxlY3RvciApOwoKCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSAmJiB1cGRhdGVQbGFjZWhvbGRlciApIHsKCQkJdGhpcy5fc2VhcmNoLmF0dHIoICJwbGFjZWhvbGRlciIsIHRoaXMub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciApOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZXQgPSB0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkvLyBOZWVkIHRvIHNldCB0aGUgZmlsdGVyUGxhY2Vob2xkZXIgYWZ0ZXIgaGF2aW5nIGVzdGFibGlzaGVkIHRoZSBzZWFyY2ggaW5wdXQKCQlpZiAoIG9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgkJCQl0aGlzLl9zZWFyY2guYXR0ciggInBsYWNlaG9sZGVyIiwgb3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciApOwoJCQl9CgkJfQoKCQlpZiAoIG9wdGlvbnMuZmlsdGVyVGhlbWUgIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9zZWFyY2ggJiYgJC5tb2JpbGUudGV4dGlucHV0ICkgewoJCQl0aGlzLl9zZWFyY2gudGV4dGlucHV0KCAib3B0aW9uIiwgInRoZW1lIiwgb3B0aW9ucy5maWx0ZXJUaGVtZSApOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoJCQl0aGlzLl9zZWFyY2gucmVtb3ZlKCk7CgkJfQoJCXRoaXMuX3N1cGVyKCk7Cgl9LAoKCV9zeW5jVGV4dElucHV0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlkeCwKCQkJdGV4dGlucHV0T3B0aW9ucyA9IHt9OwoKCQkvLyBXZSBvbmx5IHN5bmMgb3B0aW9ucyBpZiB0aGUgZmlsdGVyYWJsZSdzIHRleHRpbnB1dCBpcyBvZiB0aGUgaW50ZXJuYWxseQoJCS8vIGdlbmVyYXRlZCB2YXJpZXR5LCByYXRoZXIgdGhhbiBvbmUgc3BlY2lmaWVkIGJ5IHRoZSB1c2VyLgoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICYmICQubW9iaWxlLnRleHRpbnB1dCApIHsKCgkJCS8vIEFwcGx5IG9ubHkgdGhlIG9wdGlvbnMgdW5kZXJzdG9vZCBieSB0ZXh0aW5wdXQKCQkJZm9yICggaWR4IGluICQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUub3B0aW9ucyApIHsKCQkJCWlmICggb3B0aW9uc1sgaWR4IF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCQlpZiAoIGlkeCA9PT0gInRoZW1lIiAmJiB0aGlzLm9wdGlvbnMuZmlsdGVyVGhlbWUgIT0gbnVsbCApIHsKCQkJCQkJdGV4dGlucHV0T3B0aW9uc1sgaWR4IF0gPSB0aGlzLm9wdGlvbnMuZmlsdGVyVGhlbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGV4dGlucHV0T3B0aW9uc1sgaWR4IF0gPSBvcHRpb25zWyBpZHggXTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJdGhpcy5fc2VhcmNoLnRleHRpbnB1dCggIm9wdGlvbiIsIHRleHRpbnB1dE9wdGlvbnMgKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyohCiAqIGpRdWVyeSBVSSBUYWJzIGZhZGYyYjMxMmEwNTA0MDQzNjQ1MWM2NGJiZmFmNDgxNGJjNjJjNTYKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS90YWJzLwogKgogKiBEZXBlbmRzOgogKglqcXVlcnkudWkuY29yZS5qcwogKglqcXVlcnkudWkud2lkZ2V0LmpzCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB0YWJJZCA9IDAsCglyaGFzaCA9IC8jLiokLzsKCmZ1bmN0aW9uIGdldE5leHRUYWJJZCgpIHsKCXJldHVybiArK3RhYklkOwp9CgpmdW5jdGlvbiBpc0xvY2FsKCBhbmNob3IgKSB7CglyZXR1cm4gYW5jaG9yLmhhc2gubGVuZ3RoID4gMSAmJgoJCWRlY29kZVVSSUNvbXBvbmVudCggYW5jaG9yLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICkgKSA9PT0KCQkJZGVjb2RlVVJJQ29tcG9uZW50KCBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApICk7Cn0KCiQud2lkZ2V0KCAidWkudGFicyIsIHsKCXZlcnNpb246ICJmYWRmMmIzMTJhMDUwNDA0MzY0NTFjNjRiYmZhZjQ4MTRiYzYyYzU2IiwKCWRlbGF5OiAzMDAsCglvcHRpb25zOiB7CgkJYWN0aXZlOiBudWxsLAoJCWNvbGxhcHNpYmxlOiBmYWxzZSwKCQlldmVudDogImNsaWNrIiwKCQloZWlnaHRTdHlsZTogImNvbnRlbnQiLAoJCWhpZGU6IG51bGwsCgkJc2hvdzogbnVsbCwKCgkJLy8gY2FsbGJhY2tzCgkJYWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlQWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlTG9hZDogbnVsbCwKCQlsb2FkOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgoJCXRoaXMuZWxlbWVudAoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIiApCgkJCS50b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCBvcHRpb25zLmNvbGxhcHNpYmxlICkKCQkJLy8gUHJldmVudCB1c2VycyBmcm9tIGZvY3VzaW5nIGRpc2FibGVkIHRhYnMgdmlhIGNsaWNrCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLW5hdiA+IGxpIiwgIm1vdXNlZG93biIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9KQoJCQkvLyBzdXBwb3J0OiBJRSA8OQoJCQkvLyBQcmV2ZW50aW5nIHRoZSBkZWZhdWx0IGFjdGlvbiBpbiBtb3VzZWRvd24gZG9lc24ndCBwcmV2ZW50IElFCgkJCS8vIGZyb20gZm9jdXNpbmcgdGhlIGVsZW1lbnQsIHNvIGlmIHRoZSBhbmNob3IgZ2V0cyBmb2N1c2VkLCBibHVyLgoJCQkvLyBXZSBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IGZvY3VzaW5nIHRoZSBwcmV2aW91c2x5IGZvY3VzZWQKCQkJLy8gZWxlbWVudCBzaW5jZSBjbGlja2luZyBvbiBhIG5vbi1mb2N1c2FibGUgZWxlbWVudCBzaG91bGQgZm9jdXMKCQkJLy8gdGhlIGJvZHkgYW55d2F5LgoJCQkuZGVsZWdhdGUoICIudWktdGFicy1hbmNob3IiLCAiZm9jdXMiICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCQkJdGhpcy5ibHVyKCk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLl9wcm9jZXNzVGFicygpOwoJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy5faW5pdGlhbEFjdGl2ZSgpOwoKCQkvLyBUYWtlIGRpc2FibGluZyB0YWJzIHZpYSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gaW50byBhY2NvdW50IGFuZCB1cGRhdGUgb3B0aW9uIHByb3Blcmx5LgoJCWlmICggJC5pc0FycmF5KCBvcHRpb25zLmRpc2FibGVkICkgKSB7CgkJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLnVuaXF1ZSggb3B0aW9ucy5kaXNhYmxlZC5jb25jYXQoCgkJCQkkLm1hcCggdGhpcy50YWJzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIGxpICkgewoJCQkJCXJldHVybiB0aGF0LnRhYnMuaW5kZXgoIGxpICk7CgkJCQl9KQoJCQkpICkuc29ydCgpOwoJCX0KCgkJLy8gY2hlY2sgZm9yIGxlbmd0aCBhdm9pZHMgZXJyb3Igd2hlbiBpbml0aWFsaXppbmcgZW1wdHkgbGlzdAoJCWlmICggdGhpcy5vcHRpb25zLmFjdGl2ZSAhPT0gZmFsc2UgJiYgdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJdGhpcy5hY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBvcHRpb25zLmFjdGl2ZSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoKCQlpZiAoIHRoaXMuYWN0aXZlLmxlbmd0aCApIHsKCQkJdGhpcy5sb2FkKCBvcHRpb25zLmFjdGl2ZSApOwoJCX0KCX0sCgoJX2luaXRpYWxBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCXZhciBhY3RpdmUgPSB0aGlzLm9wdGlvbnMuYWN0aXZlLAoJCQljb2xsYXBzaWJsZSA9IHRoaXMub3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJbG9jYXRpb25IYXNoID0gbG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoIDEgKTsKCgkJaWYgKCBhY3RpdmUgPT09IG51bGwgKSB7CgkJCS8vIGNoZWNrIHRoZSBmcmFnbWVudCBpZGVudGlmaWVyIGluIHRoZSBVUkwKCQkJaWYgKCBsb2NhdGlvbkhhc2ggKSB7CgkJCQl0aGlzLnRhYnMuZWFjaChmdW5jdGlvbiggaSwgdGFiICkgewoJCQkJCWlmICggJCggdGFiICkuYXR0ciggImFyaWEtY29udHJvbHMiICkgPT09IGxvY2F0aW9uSGFzaCApIHsKCQkJCQkJYWN0aXZlID0gaTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQkvLyBjaGVjayBmb3IgYSB0YWIgbWFya2VkIGFjdGl2ZSB2aWEgYSBjbGFzcwoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmZpbHRlciggIi51aS10YWJzLWFjdGl2ZSIgKSApOwoJCQl9CgoJCQkvLyBubyBhY3RpdmUgdGFiLCBzZXQgdG8gZmFsc2UKCQkJaWYgKCBhY3RpdmUgPT09IG51bGwgfHwgYWN0aXZlID09PSAtMSApIHsKCQkJCWFjdGl2ZSA9IHRoaXMudGFicy5sZW5ndGggPyAwIDogZmFsc2U7CgkJCX0KCQl9CgoJCS8vIGhhbmRsZSBudW1iZXJzOiBuZWdhdGl2ZSwgb3V0IG9mIHJhbmdlCgkJaWYgKCBhY3RpdmUgIT09IGZhbHNlICkgewoJCQlhY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMudGFicy5lcSggYWN0aXZlICkgKTsKCQkJaWYgKCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gY29sbGFwc2libGUgPyBmYWxzZSA6IDA7CgkJCX0KCQl9CgoJCS8vIGRvbid0IGFsbG93IGNvbGxhcHNpYmxlOiBmYWxzZSBhbmQgYWN0aXZlOiBmYWxzZQoJCWlmICggIWNvbGxhcHNpYmxlICYmIGFjdGl2ZSA9PT0gZmFsc2UgJiYgdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJYWN0aXZlID0gMDsKCQl9CgoJCXJldHVybiBhY3RpdmU7Cgl9LAoKCV9nZXRDcmVhdGVFdmVudERhdGE6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB7CgkJCXRhYjogdGhpcy5hY3RpdmUsCgkJCXBhbmVsOiAhdGhpcy5hY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkKCQl9OwoJfSwKCglfdGFiS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBmb2N1c2VkVGFiID0gJCggdGhpcy5kb2N1bWVudFswXS5hY3RpdmVFbGVtZW50ICkuY2xvc2VzdCggImxpIiApLAoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy50YWJzLmluZGV4KCBmb2N1c2VkVGFiICksCgkJCWdvaW5nRm9yd2FyZCA9IHRydWU7CgoJCWlmICggdGhpcy5faGFuZGxlUGFnZU5hdiggZXZlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLnVpLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC51aS5rZXlDb2RlLkRPV046CgkJCQlzZWxlY3RlZEluZGV4Kys7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuVVA6CgkJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6CgkJCQlnb2luZ0ZvcndhcmQgPSBmYWxzZTsKCQkJCXNlbGVjdGVkSW5kZXgtLTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5FTkQ6CgkJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5hbmNob3JzLmxlbmd0aCAtIDE7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJCXNlbGVjdGVkSW5kZXggPSAwOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOgoJCQkJLy8gQWN0aXZhdGUgb25seSwgbm8gY29sbGFwc2luZwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoKCQkJCS8vIFRvZ2dsZSAoY2FuY2VsIGRlbGF5ZWQgYWN0aXZhdGlvbiwgYWxsb3cgY29sbGFwc2luZykKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCQkJLy8gRGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBjb2xsYXBzZSBvciBhY3RpdmF0ZQoJCQkJdGhpcy5fYWN0aXZhdGUoIHNlbGVjdGVkSW5kZXggPT09IHRoaXMub3B0aW9ucy5hY3RpdmUgPyBmYWxzZSA6IHNlbGVjdGVkSW5kZXggKTsKCQkJCXJldHVybjsKCQkJZGVmYXVsdDoKCQkJCXJldHVybjsKCQl9CgoJCS8vIEZvY3VzIHRoZSBhcHByb3ByaWF0ZSB0YWIsIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5fZm9jdXNOZXh0VGFiKCBzZWxlY3RlZEluZGV4LCBnb2luZ0ZvcndhcmQgKTsKCgkJLy8gTmF2aWdhdGluZyB3aXRoIGNvbnRyb2wga2V5IHdpbGwgcHJldmVudCBhdXRvbWF0aWMgYWN0aXZhdGlvbgoJCWlmICggIWV2ZW50LmN0cmxLZXkgKSB7CgkJCS8vIFVwZGF0ZSBhcmlhLXNlbGVjdGVkIGltbWVkaWF0ZWx5IHNvIHRoYXQgQVQgdGhpbmsgdGhlIHRhYiBpcyBhbHJlYWR5IHNlbGVjdGVkLgoJCQkvLyBPdGhlcndpc2UgQVQgbWF5IGNvbmZ1c2UgdGhlIHVzZXIgYnkgc3RhdGluZyB0aGF0IHRoZXkgbmVlZCB0byBhY3RpdmF0ZSB0aGUgdGFiLAoJCQkvLyBidXQgdGhlIHRhYiB3aWxsIGFscmVhZHkgYmUgYWN0aXZhdGVkIGJ5IHRoZSB0aW1lIHRoZSBhbm5vdW5jZW1lbnQgZmluaXNoZXMuCgkJCWZvY3VzZWRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJCXRoaXMudGFicy5lcSggc2VsZWN0ZWRJbmRleCApLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgInRydWUiICk7CgoJCQl0aGlzLmFjdGl2YXRpbmcgPSB0aGlzLl9kZWxheShmdW5jdGlvbigpIHsKCQkJCXRoaXMub3B0aW9uKCAiYWN0aXZlIiwgc2VsZWN0ZWRJbmRleCApOwoJCQl9LCB0aGlzLmRlbGF5ICk7CgkJfQoJfSwKCglfcGFuZWxLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDdHJsK3VwIG1vdmVzIGZvY3VzIHRvIHRoZSBjdXJyZW50IHRhYgoJCWlmICggZXZlbnQuY3RybEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuVVAgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXRoaXMuYWN0aXZlLmZvY3VzKCk7CgkJfQoJfSwKCgkvLyBBbHQrcGFnZSB1cC9kb3duIG1vdmVzIGZvY3VzIHRvIHRoZSBwcmV2aW91cy9uZXh0IHRhYiAoYW5kIGFjdGl2YXRlcykKCV9oYW5kbGVQYWdlTmF2OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudC5hbHRLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlBBR0VfVVAgKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgLSAxLCBmYWxzZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZm9jdXNOZXh0VGFiKCB0aGlzLm9wdGlvbnMuYWN0aXZlICsgMSwgdHJ1ZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0sCgoJX2ZpbmROZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQl2YXIgbGFzdFRhYkluZGV4ID0gdGhpcy50YWJzLmxlbmd0aCAtIDE7CgoJCWZ1bmN0aW9uIGNvbnN0cmFpbigpIHsKCQkJaWYgKCBpbmRleCA+IGxhc3RUYWJJbmRleCApIHsKCQkJCWluZGV4ID0gMDsKCQkJfQoJCQlpZiAoIGluZGV4IDwgMCApIHsKCQkJCWluZGV4ID0gbGFzdFRhYkluZGV4OwoJCQl9CgkJCXJldHVybiBpbmRleDsKCQl9CgoJCXdoaWxlICggJC5pbkFycmF5KCBjb25zdHJhaW4oKSwgdGhpcy5vcHRpb25zLmRpc2FibGVkICkgIT09IC0xICkgewoJCQlpbmRleCA9IGdvaW5nRm9yd2FyZCA/IGluZGV4ICsgMSA6IGluZGV4IC0gMTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2ZvY3VzTmV4dFRhYjogZnVuY3Rpb24oIGluZGV4LCBnb2luZ0ZvcndhcmQgKSB7CgkJaW5kZXggPSB0aGlzLl9maW5kTmV4dFRhYiggaW5kZXgsIGdvaW5nRm9yd2FyZCApOwoJCXRoaXMudGFicy5lcSggaW5kZXggKS5mb2N1cygpOwoJCXJldHVybiBpbmRleDsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJhY3RpdmUiICkgewoJCQkvLyBfYWN0aXZhdGUoKSB3aWxsIGhhbmRsZSBpbnZhbGlkIHZhbHVlcyBhbmQgdXBkYXRlIHRoaXMub3B0aW9ucwoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCS8vIGRvbid0IHVzZSB0aGUgd2lkZ2V0IGZhY3RvcnkncyBkaXNhYmxlZCBoYW5kbGluZwoJCQl0aGlzLl9zZXR1cERpc2FibGVkKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSk7CgoJCWlmICgga2V5ID09PSAiY29sbGFwc2libGUiICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS10YWJzLWNvbGxhcHNpYmxlIiwgdmFsdWUgKTsKCQkJLy8gU2V0dGluZyBjb2xsYXBzaWJsZTogZmFsc2Ugd2hpbGUgY29sbGFwc2VkOyBvcGVuIGZpcnN0IHBhbmVsCgkJCWlmICggIXZhbHVlICYmIHRoaXMub3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgewoJCQkJdGhpcy5fYWN0aXZhdGUoIDAgKTsKCQkJfQoJCX0KCgkJaWYgKCBrZXkgPT09ICJldmVudCIgKSB7CgkJCXRoaXMuX3NldHVwRXZlbnRzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJoZWlnaHRTdHlsZSIgKSB7CgkJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHZhbHVlICk7CgkJfQoJfSwKCglfdGFiSWQ6IGZ1bmN0aW9uKCB0YWIgKSB7CgkJcmV0dXJuIHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKSB8fCAidWktdGFicy0iICsgZ2V0TmV4dFRhYklkKCk7Cgl9LAoKCV9zYW5pdGl6ZVNlbGVjdG9yOiBmdW5jdGlvbiggaGFzaCApIHsKCQlyZXR1cm4gaGFzaCA/IGhhc2gucmVwbGFjZSggL1shIiQlJicoKSorLC5cLzo7PD0+P0BcW1xdXF5ge3x9fl0vZywgIlxcJCYiICkgOiAiIjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWxpcyA9IHRoaXMudGFibGlzdC5jaGlsZHJlbiggIjpoYXMoYVtocmVmXSkiICk7CgoJCS8vIGdldCBkaXNhYmxlZCB0YWJzIGZyb20gY2xhc3MgYXR0cmlidXRlIGZyb20gSFRNTAoJCS8vIHRoaXMgd2lsbCBnZXQgY29udmVydGVkIHRvIGEgYm9vbGVhbiBpZiBuZWVkZWQgaW4gX3JlZnJlc2goKQoJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLm1hcCggbGlzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIHRhYiApIHsKCQkJcmV0dXJuIGxpcy5pbmRleCggdGFiICk7CgkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgoJCS8vIHdhcyBjb2xsYXBzZWQgb3Igbm8gdGFicwoJCWlmICggb3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlIHx8ICF0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkvLyB3YXMgYWN0aXZlLCBidXQgYWN0aXZlIHRhYiBpcyBnb25lCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLnRhYmxpc3RbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoJCQkvLyBhbGwgcmVtYWluaW5nIHRhYnMgYXJlIGRpc2FibGVkCgkJCWlmICggdGhpcy50YWJzLmxlbmd0aCA9PT0gb3B0aW9ucy5kaXNhYmxlZC5sZW5ndGggKSB7CgkJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJCS8vIGFjdGl2YXRlIHByZXZpb3VzIHRhYgoJCQl9IGVsc2UgewoJCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZpbmROZXh0VGFiKCBNYXRoLm1heCggMCwgb3B0aW9ucy5hY3RpdmUgLSAxICksIGZhbHNlICkgKTsKCQkJfQoJCS8vIHdhcyBhY3RpdmUsIGFjdGl2ZSB0YWIgc3RpbGwgZXhpc3RzCgkJfSBlbHNlIHsKCQkJLy8gbWFrZSBzdXJlIGFjdGl2ZSBpbmRleCBpcyBjb3JyZWN0CgkJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLmFjdGl2ZSApOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggdGhpcy5vcHRpb25zLmRpc2FibGVkICk7CgkJdGhpcy5fc2V0dXBFdmVudHMoIHRoaXMub3B0aW9ucy5ldmVudCApOwoJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSApOwoKCQl0aGlzLnRhYnMubm90KCB0aGlzLmFjdGl2ZSApLmF0dHIoewoJCQkiYXJpYS1zZWxlY3RlZCI6ICJmYWxzZSIsCgkJCXRhYkluZGV4OiAtMQoJCX0pOwoJCXRoaXMucGFuZWxzLm5vdCggdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKHsKCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCQl9KTsKCgkJLy8gTWFrZSBzdXJlIG9uZSB0YWIgaXMgaW4gdGhlIHRhYiBvcmRlcgoJCWlmICggIXRoaXMuYWN0aXZlLmxlbmd0aCApIHsKCQkJdGhpcy50YWJzLmVxKCAwICkuYXR0ciggInRhYkluZGV4IiwgMCApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYWN0aXZlCgkJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJCQl0YWJJbmRleDogMAoJCQkJfSk7CgkJCXRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApCgkJCQkuc2hvdygpCgkJCQkuYXR0cih7CgkJCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsCgkJCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCQkJfSk7CgkJfQoJfSwKCglfcHJvY2Vzc1RhYnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJdGhpcy50YWJsaXN0ID0gdGhpcy5fZ2V0TGlzdCgpCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtbmF2IHVpLWhlbHBlci1yZXNldCB1aS1oZWxwZXItY2xlYXJmaXggdWktd2lkZ2V0LWhlYWRlciB1aS1jb3JuZXItYWxsIiApCgkJCS5hdHRyKCAicm9sZSIsICJ0YWJsaXN0IiApOwoKCQl0aGlzLnRhYnMgPSB0aGlzLnRhYmxpc3QuZmluZCggIj4gbGk6aGFzKGFbaHJlZl0pIiApCgkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktY29ybmVyLXRvcCIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAidGFiIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5hbmNob3JzID0gdGhpcy50YWJzLm1hcChmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCAiYSIsIHRoaXMgKVsgMCBdOwoJCQl9KQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAicHJlc2VudGF0aW9uIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5wYW5lbHMgPSAkKCk7CgoJCXRoaXMuYW5jaG9ycy5lYWNoKGZ1bmN0aW9uKCBpLCBhbmNob3IgKSB7CgkJCXZhciBzZWxlY3RvciwgcGFuZWwsIHBhbmVsSWQsCgkJCQlhbmNob3JJZCA9ICQoIGFuY2hvciApLnVuaXF1ZUlkKCkuYXR0ciggImlkIiApLAoJCQkJdGFiID0gJCggYW5jaG9yICkuY2xvc2VzdCggImxpIiApLAoJCQkJb3JpZ2luYWxBcmlhQ29udHJvbHMgPSB0YWIuYXR0ciggImFyaWEtY29udHJvbHMiICk7CgoJCQkvLyBpbmxpbmUgdGFiCgkJCWlmICggaXNMb2NhbCggYW5jaG9yICkgKSB7CgkJCQlzZWxlY3RvciA9IGFuY2hvci5oYXNoOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggdGhhdC5fc2FuaXRpemVTZWxlY3Rvciggc2VsZWN0b3IgKSApOwoJCQkvLyByZW1vdGUgdGFiCgkJCX0gZWxzZSB7CgkJCQlwYW5lbElkID0gdGhhdC5fdGFiSWQoIHRhYiApOwoJCQkJc2VsZWN0b3IgPSAiIyIgKyBwYW5lbElkOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggc2VsZWN0b3IgKTsKCQkJCWlmICggIXBhbmVsLmxlbmd0aCApIHsKCQkJCQlwYW5lbCA9IHRoYXQuX2NyZWF0ZVBhbmVsKCBwYW5lbElkICk7CgkJCQkJcGFuZWwuaW5zZXJ0QWZ0ZXIoIHRoYXQucGFuZWxzWyBpIC0gMSBdIHx8IHRoYXQudGFibGlzdCApOwoJCQkJfQoJCQkJcGFuZWwuYXR0ciggImFyaWEtbGl2ZSIsICJwb2xpdGUiICk7CgkJCX0KCgkJCWlmICggcGFuZWwubGVuZ3RoKSB7CgkJCQl0aGF0LnBhbmVscyA9IHRoYXQucGFuZWxzLmFkZCggcGFuZWwgKTsKCQkJfQoJCQlpZiAoIG9yaWdpbmFsQXJpYUNvbnRyb2xzICkgewoJCQkJdGFiLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiLCBvcmlnaW5hbEFyaWFDb250cm9scyApOwoJCQl9CgkJCXRhYi5hdHRyKHsKCQkJCSJhcmlhLWNvbnRyb2xzIjogc2VsZWN0b3Iuc3Vic3RyaW5nKCAxICksCgkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogYW5jaG9ySWQKCQkJfSk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWxhYmVsbGVkYnkiLCBhbmNob3JJZCApOwoJCX0pOwoKCQl0aGlzLnBhbmVscwoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYnBhbmVsIiApOwoJfSwKCgkvLyBhbGxvdyBvdmVycmlkaW5nIGhvdyB0byBmaW5kIHRoZSBsaXN0IGZvciByYXJlIHVzYWdlIHNjZW5hcmlvcyAoIzc3MTUpCglfZ2V0TGlzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudC5maW5kKCAib2wsdWwiICkuZXEoIDAgKTsKCX0sCgoJX2NyZWF0ZVBhbmVsOiBmdW5jdGlvbiggaWQgKSB7CgkJcmV0dXJuICQoICI8ZGl2PiIgKQoJCQkuYXR0ciggImlkIiwgaWQgKQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmRhdGEoICJ1aS10YWJzLWRlc3Ryb3kiLCB0cnVlICk7Cgl9LAoKCV9zZXR1cERpc2FibGVkOiBmdW5jdGlvbiggZGlzYWJsZWQgKSB7CgkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCWlmICggIWRpc2FibGVkLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIGRpc2FibGVkLmxlbmd0aCA9PT0gdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gZGlzYWJsZSB0YWJzCgkJZm9yICggdmFyIGkgPSAwLCBsaTsgKCBsaSA9IHRoaXMudGFic1sgaSBdICk7IGkrKyApIHsKCQkJaWYgKCBkaXNhYmxlZCA9PT0gdHJ1ZSB8fCAkLmluQXJyYXkoIGksIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJJCggbGkgKQoJCQkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgInRydWUiICk7CgkJCX0gZWxzZSB7CgkJCQkkKCBsaSApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICk7CgkJCX0KCQl9CgoJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGRpc2FibGVkOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZXZlbnRzID0gewoJCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX07CgkJaWYgKCBldmVudCApIHsKCQkJJC5lYWNoKCBldmVudC5zcGxpdCgiICIpLCBmdW5jdGlvbiggaW5kZXgsIGV2ZW50TmFtZSApIHsKCQkJCWV2ZW50c1sgZXZlbnROYW1lIF0gPSAiX2V2ZW50SGFuZGxlciI7CgkJCX0pOwoJCX0KCgkJdGhpcy5fb2ZmKCB0aGlzLmFuY2hvcnMuYWRkKCB0aGlzLnRhYnMgKS5hZGQoIHRoaXMucGFuZWxzICkgKTsKCQl0aGlzLl9vbiggdGhpcy5hbmNob3JzLCBldmVudHMgKTsKCQl0aGlzLl9vbiggdGhpcy50YWJzLCB7IGtleWRvd246ICJfdGFiS2V5ZG93biIgfSApOwoJCXRoaXMuX29uKCB0aGlzLnBhbmVscywgeyBrZXlkb3duOiAiX3BhbmVsS2V5ZG93biIgfSApOwoKCQl0aGlzLl9mb2N1c2FibGUoIHRoaXMudGFicyApOwoJCXRoaXMuX2hvdmVyYWJsZSggdGhpcy50YWJzICk7Cgl9LAoKCV9zZXR1cEhlaWdodFN0eWxlOiBmdW5jdGlvbiggaGVpZ2h0U3R5bGUgKSB7CgkJdmFyIG1heEhlaWdodCwKCQkJcGFyZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoKCQlpZiAoIGhlaWdodFN0eWxlID09PSAiZmlsbCIgKSB7CgkJCW1heEhlaWdodCA9IHBhcmVudC5oZWlnaHQoKTsKCQkJbWF4SGVpZ2h0IC09IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpIC0gdGhpcy5lbGVtZW50LmhlaWdodCgpOwoKCQkJdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiOnZpc2libGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gJCggdGhpcyApLAoJCQkJCXBvc2l0aW9uID0gZWxlbS5jc3MoICJwb3NpdGlvbiIgKTsKCgkJCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCW1heEhlaWdodCAtPSBlbGVtLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkubm90KCB0aGlzLnBhbmVscyApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQltYXhIZWlnaHQgLT0gJCggdGhpcyApLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5oZWlnaHQoIE1hdGgubWF4KCAwLCBtYXhIZWlnaHQgLQoJCQkJCSQoIHRoaXMgKS5pbm5lckhlaWdodCgpICsgJCggdGhpcyApLmhlaWdodCgpICkgKTsKCQkJfSkKCQkJLmNzcyggIm92ZXJmbG93IiwgImF1dG8iICk7CgkJfSBlbHNlIGlmICggaGVpZ2h0U3R5bGUgPT09ICJhdXRvIiApIHsKCQkJbWF4SGVpZ2h0ID0gMDsKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCA9IE1hdGgubWF4KCBtYXhIZWlnaHQsICQoIHRoaXMgKS5oZWlnaHQoICIiICkuaGVpZ2h0KCkgKTsKCQkJfSkuaGVpZ2h0KCBtYXhIZWlnaHQgKTsKCQl9Cgl9LAoKCV9ldmVudEhhbmRsZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJYWN0aXZlID0gdGhpcy5hY3RpdmUsCgkJCWFuY2hvciA9ICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwKCQkJdGFiID0gYW5jaG9yLmNsb3Nlc3QoICJsaSIgKSwKCQkJY2xpY2tlZElzQWN0aXZlID0gdGFiWyAwIF0gPT09IGFjdGl2ZVsgMCBdLAoJCQljb2xsYXBzaW5nID0gY2xpY2tlZElzQWN0aXZlICYmIG9wdGlvbnMuY29sbGFwc2libGUsCgkJCXRvU2hvdyA9IGNvbGxhcHNpbmcgPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCXRvSGlkZSA9ICFhY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIGFjdGl2ZSApLAoJCQlldmVudERhdGEgPSB7CgkJCQlvbGRUYWI6IGFjdGl2ZSwKCQkJCW9sZFBhbmVsOiB0b0hpZGUsCgkJCQluZXdUYWI6IGNvbGxhcHNpbmcgPyAkKCkgOiB0YWIsCgkJCQluZXdQYW5lbDogdG9TaG93CgkJCX07CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCWlmICggdGFiLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgfHwKCQkJCS8vIHRhYiBpcyBhbHJlYWR5IGxvYWRpbmcKCQkJCXRhYi5oYXNDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKSB8fAoJCQkJLy8gY2FuJ3Qgc3dpdGNoIGR1cm5pbmcgYW4gYW5pbWF0aW9uCgkJCQl0aGlzLnJ1bm5pbmcgfHwKCQkJCS8vIGNsaWNrIG9uIGFjdGl2ZSBoZWFkZXIsIGJ1dCBub3QgY29sbGFwc2libGUKCQkJCSggY2xpY2tlZElzQWN0aXZlICYmICFvcHRpb25zLmNvbGxhcHNpYmxlICkgfHwKCQkJCS8vIGFsbG93IGNhbmNlbGluZyBhY3RpdmF0aW9uCgkJCQkoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVBY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKSA9PT0gZmFsc2UgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJb3B0aW9ucy5hY3RpdmUgPSBjb2xsYXBzaW5nID8gZmFsc2UgOiB0aGlzLnRhYnMuaW5kZXgoIHRhYiApOwoKCQl0aGlzLmFjdGl2ZSA9IGNsaWNrZWRJc0FjdGl2ZSA/ICQoKSA6IHRhYjsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJaWYgKCAhdG9IaWRlLmxlbmd0aCAmJiAhdG9TaG93Lmxlbmd0aCApIHsKCQkJJC5lcnJvciggImpRdWVyeSBVSSBUYWJzOiBNaXNtYXRjaGluZyBmcmFnbWVudCBpZGVudGlmaWVyLiIgKTsKCQl9CgoJCWlmICggdG9TaG93Lmxlbmd0aCApIHsKCQkJdGhpcy5sb2FkKCB0aGlzLnRhYnMuaW5kZXgoIHRhYiApLCBldmVudCApOwoJCX0KCQl0aGlzLl90b2dnbGUoIGV2ZW50LCBldmVudERhdGEgKTsKCX0sCgoJLy8gaGFuZGxlcyBzaG93L2hpZGUgZm9yIHNlbGVjdGluZyB0YWJzCglfdG9nZ2xlOiBmdW5jdGlvbiggZXZlbnQsIGV2ZW50RGF0YSApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRvU2hvdyA9IGV2ZW50RGF0YS5uZXdQYW5lbCwKCQkJdG9IaWRlID0gZXZlbnREYXRhLm9sZFBhbmVsOwoKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKCQlmdW5jdGlvbiBjb21wbGV0ZSgpIHsKCQkJdGhhdC5ydW5uaW5nID0gZmFsc2U7CgkJCXRoYXQuX3RyaWdnZXIoICJhY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKTsKCQl9CgoJCWZ1bmN0aW9uIHNob3coKSB7CgkJCWV2ZW50RGF0YS5uZXdUYWIuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoKCQkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRoYXQub3B0aW9ucy5zaG93ICkgewoJCQkJdGhhdC5fc2hvdyggdG9TaG93LCB0aGF0Lm9wdGlvbnMuc2hvdywgY29tcGxldGUgKTsKCQkJfSBlbHNlIHsKCQkJCXRvU2hvdy5zaG93KCk7CgkJCQljb21wbGV0ZSgpOwoJCQl9CgkJfQoKCQkvLyBzdGFydCBvdXQgYnkgaGlkaW5nLCB0aGVuIHNob3dpbmcsIHRoZW4gY29tcGxldGluZwoJCWlmICggdG9IaWRlLmxlbmd0aCAmJiB0aGlzLm9wdGlvbnMuaGlkZSApIHsKCQkJdGhpcy5faGlkZSggdG9IaWRlLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7CgkJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCXNob3coKTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5jbG9zZXN0KCAibGkiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCXRvSGlkZS5oaWRlKCk7CgkJCXNob3coKTsKCQl9CgoJCXRvSGlkZS5hdHRyKHsKCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQl9KTsKCQlldmVudERhdGEub2xkVGFiLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgImZhbHNlIiApOwoJCS8vIElmIHdlJ3JlIHN3aXRjaGluZyB0YWJzLCByZW1vdmUgdGhlIG9sZCB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIG9wZW5pbmcgZnJvbSBjb2xsYXBzZWQgc3RhdGUsIHJlbW92ZSB0aGUgcHJldmlvdXMgdGFiIGZyb20gdGhlIHRhYiBvcmRlci4KCQkvLyBJZiB3ZSdyZSBjb2xsYXBzaW5nLCB0aGVuIGtlZXAgdGhlIGNvbGxhcHNpbmcgdGFiIGluIHRoZSB0YWIgb3JkZXIuCgkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRvSGlkZS5sZW5ndGggKSB7CgkJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggInRhYkluZGV4IiwgLTEgKTsKCQl9IGVsc2UgaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5hdHRyKCAidGFiSW5kZXgiICkgPT09IDA7CgkJCX0pCgkJCS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0KCgkJdG9TaG93LmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCX0pOwoJCWV2ZW50RGF0YS5uZXdUYWIuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQl0YWJJbmRleDogMAoJCX0pOwoJfSwKCglfYWN0aXZhdGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgYW5jaG9yLAoJCQlhY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBpbmRleCApOwoKCQkvLyB0cnlpbmcgdG8gYWN0aXZhdGUgdGhlIGFscmVhZHkgYWN0aXZlIHBhbmVsCgkJaWYgKCBhY3RpdmVbIDAgXSA9PT0gdGhpcy5hY3RpdmVbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gdHJ5aW5nIHRvIGNvbGxhcHNlLCBzaW11bGF0ZSBhIGNsaWNrIG9uIHRoZSBjdXJyZW50IGFjdGl2ZSBoZWFkZXIKCQlpZiAoICFhY3RpdmUubGVuZ3RoICkgewoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZTsKCQl9CgoJCWFuY2hvciA9IGFjdGl2ZS5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApWyAwIF07CgkJdGhpcy5fZXZlbnRIYW5kbGVyKHsKCQkJdGFyZ2V0OiBhbmNob3IsCgkJCWN1cnJlbnRUYXJnZXQ6IGFuY2hvciwKCQkJcHJldmVudERlZmF1bHQ6ICQubm9vcAoJCX0pOwoJfSwKCglfZmluZEFjdGl2ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXJldHVybiBpbmRleCA9PT0gZmFsc2UgPyAkKCkgOiB0aGlzLnRhYnMuZXEoIGluZGV4ICk7Cgl9LAoKCV9nZXRJbmRleDogZnVuY3Rpb24oIGluZGV4ICkgewoJCS8vIG1ldGEtZnVuY3Rpb24gdG8gZ2l2ZSB1c2VycyBvcHRpb24gdG8gcHJvdmlkZSBhIGhyZWYgc3RyaW5nIGluc3RlYWQgb2YgYSBudW1lcmljYWwgaW5kZXguCgkJaWYgKCB0eXBlb2YgaW5kZXggPT09ICJzdHJpbmciICkgewoJCQlpbmRleCA9IHRoaXMuYW5jaG9ycy5pbmRleCggdGhpcy5hbmNob3JzLmZpbHRlciggIltocmVmJD0nIiArIGluZGV4ICsgIiddIiApICk7CgkJfQoKCQlyZXR1cm4gaW5kZXg7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGFicyB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWFsbCB1aS10YWJzLWNvbGxhcHNpYmxlIiApOwoKCQl0aGlzLnRhYmxpc3QKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApOwoKCQl0aGlzLmFuY2hvcnMKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1hbmNob3IiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApCgkJCS5yZW1vdmVBdHRyKCAidGFiSW5kZXgiICkKCQkJLnJlbW92ZVVuaXF1ZUlkKCk7CgoJCXRoaXMudGFicy5hZGQoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAkLmRhdGEoIHRoaXMsICJ1aS10YWJzLWRlc3Ryb3kiICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kZWZhdWx0IHVpLXN0YXRlLWFjdGl2ZSB1aS1zdGF0ZS1kaXNhYmxlZCAiICsKCQkJCQkJInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSB1aS13aWRnZXQtY29udGVudCB1aS10YWJzLWFjdGl2ZSB1aS10YWJzLXBhbmVsIiApCgkJCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1saXZlIiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWJ1c3kiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtc2VsZWN0ZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtbGFiZWxsZWRieSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1oaWRkZW4iICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZXhwYW5kZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy50YWJzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBsaSA9ICQoIHRoaXMgKSwKCQkJCXByZXYgPSBsaS5kYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQlpZiAoIHByZXYgKSB7CgkJCQlsaQoJCQkJCS5hdHRyKCAiYXJpYS1jb250cm9scyIsIHByZXYgKQoJCQkJCS5yZW1vdmVEYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQl9IGVsc2UgewoJCQkJbGkucmVtb3ZlQXR0ciggImFyaWEtY29udHJvbHMiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5wYW5lbHMuc2hvdygpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgewoJCQl0aGlzLnBhbmVscy5jc3MoICJoZWlnaHQiLCAiIiApOwoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWFwKCBkaXNhYmxlZCwgZnVuY3Rpb24oIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIHRoaXMudGFicywgZnVuY3Rpb24oIGxpLCBudW0gKSB7CgkJCQkJcmV0dXJuIG51bSAhPT0gaW5kZXggPyBudW0gOiBudWxsOwoJCQkJfSk7CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBkaXNhYmxlZCA9IHRoaXMub3B0aW9ucy5kaXNhYmxlZDsKCQlpZiAoIGRpc2FibGVkID09PSB0cnVlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gdHJ1ZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaW5BcnJheSggaW5kZXgsIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggJC5pc0FycmF5KCBkaXNhYmxlZCApICkgewoJCQkJZGlzYWJsZWQgPSAkLm1lcmdlKCBbIGluZGV4IF0sIGRpc2FibGVkICkuc29ydCgpOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSBbIGluZGV4IF07CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJbG9hZDogZnVuY3Rpb24oIGluZGV4LCBldmVudCApIHsKCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCXZhciB0aGF0ID0gdGhpcywKCQkJdGFiID0gdGhpcy50YWJzLmVxKCBpbmRleCApLAoJCQlhbmNob3IgPSB0YWIuZmluZCggIi51aS10YWJzLWFuY2hvciIgKSwKCQkJcGFuZWwgPSB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCXRhYjogdGFiLAoJCQkJcGFuZWw6IHBhbmVsCgkJCX07CgoJCS8vIG5vdCByZW1vdGUKCQlpZiAoIGlzTG9jYWwoIGFuY2hvclsgMCBdICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMueGhyID0gJC5hamF4KCB0aGlzLl9hamF4U2V0dGluZ3MoIGFuY2hvciwgZXZlbnQsIGV2ZW50RGF0YSApICk7CgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJLy8galF1ZXJ5IDwxLjggcmV0dXJucyBmYWxzZSBpZiB0aGUgcmVxdWVzdCBpcyBjYW5jZWxlZCBpbiBiZWZvcmVTZW5kLAoJCS8vIGJ1dCBhcyBvZiAxLjgsICQuYWpheCgpIGFsd2F5cyByZXR1cm5zIGEganFYSFIgb2JqZWN0LgoJCWlmICggdGhpcy54aHIgJiYgdGhpcy54aHIuc3RhdHVzVGV4dCAhPT0gImNhbmNlbGVkIiApIHsKCQkJdGFiLmFkZENsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQlwYW5lbC5hdHRyKCAiYXJpYS1idXN5IiwgInRydWUiICk7CgoJCQl0aGlzLnhocgoJCQkJLnN1Y2Nlc3MoZnVuY3Rpb24oIHJlc3BvbnNlICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlwYW5lbC5odG1sKCByZXNwb25zZSApOwoJCQkJCQl0aGF0Ll90cmlnZ2VyKCAibG9hZCIsIGV2ZW50LCBldmVudERhdGEgKTsKCQkJCQl9LCAxICk7CgkJCQl9KQoJCQkJLmNvbXBsZXRlKGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHN0YXR1cyA9PT0gImFib3J0IiApIHsKCQkJCQkJCXRoYXQucGFuZWxzLnN0b3AoIGZhbHNlLCB0cnVlICk7CgkJCQkJCX0KCgkJCQkJCXRhYi5yZW1vdmVDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKTsKCQkJCQkJcGFuZWwucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKTsKCgkJCQkJCWlmICgganFYSFIgPT09IHRoYXQueGhyICkgewoJCQkJCQkJZGVsZXRlIHRoYXQueGhyOwoJCQkJCQl9CgkJCQkJfSwgMSApOwoJCQkJfSk7CgkJfQoJfSwKCglfYWpheFNldHRpbmdzOiBmdW5jdGlvbiggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpczsKCQlyZXR1cm4gewoJCQl1cmw6IGFuY2hvci5hdHRyKCAiaHJlZiIgKSwKCQkJYmVmb3JlU2VuZDogZnVuY3Rpb24oIGpxWEhSLCBzZXR0aW5ncyApIHsKCQkJCXJldHVybiB0aGF0Ll90cmlnZ2VyKCAiYmVmb3JlTG9hZCIsIGV2ZW50LAoJCQkJCSQuZXh0ZW5kKCB7IGpxWEhSIDoganFYSFIsIGFqYXhTZXR0aW5nczogc2V0dGluZ3MgfSwgZXZlbnREYXRhICkgKTsKCQkJfQoJCX07Cgl9LAoKCV9nZXRQYW5lbEZvclRhYjogZnVuY3Rpb24oIHRhYiApIHsKCQl2YXIgaWQgPSAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMuX3Nhbml0aXplU2VsZWN0b3IoICIjIiArIGlkICkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IHRydWU7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCgl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCXpvb20sCgkJZXZ0LCB4LCB5LCB6LCBhaWc7CglpZiAoICEoIC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiAvT1MgWzEtNV1fWzAtOV9dKiBsaWtlIE1hYyBPUyBYL2kudGVzdCggdWEgKSAmJiB1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSApICkgewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl6b29tID0gJC5tb2JpbGUuem9vbTsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICkgewoJCQkkLm1vYmlsZS53aW5kb3cKCQkJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoJCX0KCX0pOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJZnVuY3Rpb24gaGlkZVJlbmRlcmluZ0NsYXNzKCkgewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCQkJJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICksCgkJCQloYXNoID0gcGF0aC5zdHJpcEhhc2goIHBhdGguc3RyaXBRdWVyeVBhcmFtcyhwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApLAoJCQkJaGFzaFBhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaGFzaCApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRwYWdlcyA9ICQoICJib2R5IiApLndyYXBJbm5lciggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+PC9kaXY+IiApLmNoaWxkcmVuKCAwICk7CgkJCX0KCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJLy8gdW5sZXNzIHRoZSBkYXRhIHVybCBpcyBhbHJlYWR5IHNldCBzZXQgaXQgdG8gdGhlIHBhdGhuYW1lCgkJCQlpZiAoICEkdGhpc1sgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkLm1vYmlsZS5maXJzdFBhZ2UKCQkJCS5wYXJlbnQoKQoJCQkJLmFkZENsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0IiApCgkJCQkucGFnZWNvbnRhaW5lcigpOwoKCQkJLy8gaW5pdGlhbGl6ZSBuYXZpZ2F0aW9uIGV2ZW50cyBub3csIGFmdGVyIG1vYmlsZWluaXQgaGFzIG9jY3VycmVkIGFuZCB0aGUgcGFnZSBjb250YWluZXIKCQkJLy8gaGFzIGJlZW4gY3JlYXRlZCBidXQgYmVmb3JlIHRoZSByZXN0IG9mIHRoZSBsaWJyYXJ5IGlzIGFsZXJ0ZWQgdG8gdGhhdCBmYWN0CgkJCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOwoKCQkJLy8gYWxlcnQgbGlzdGVuZXJzIHRoYXQgdGhlIHBhZ2Vjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCBmb3IgYmluZGluZwoJCQkvLyB0byBldmVudHMgdHJpZ2dlcmVkIG9uIGl0CgkJCSR3aW5kb3cudHJpZ2dlciggInBhZ2Vjb250YWluZXJjcmVhdGUiICk7CgoJCQkvLyBjdWUgcGFnZSBsb2FkaW5nIG1lc3NhZ2UKCQkJJC5tb2JpbGUubG9hZGluZyggInNob3ciICk7CgoJCQkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCgkJCWhpZGVSZW5kZXJpbmdDbGFzcygpOwoKCQkJLy8gaWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQsIHRoZXJlJ3Mgbm8gaGFzaCBkZWVwbGluaywKCQkJLy8gdGhlIGhhc2ggaXMgbm90IHZhbGlkIChjb250YWlucyBtb3JlIHRoYW4gb25lICMgb3IgZG9lcyBub3Qgc3RhcnQgd2l0aCAjKQoJCQkvLyBvciB0aGVyZSBpcyBubyBwYWdlIHdpdGggdGhhdCBoYXNoLCBjaGFuZ2UgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIERPTQoJCQkvLyBSZW1lbWJlciwgaG93ZXZlciwgdGhhdCB0aGUgaGFzaCBjYW4gYWxzbyBiZSBhIHBhdGghCgkJCWlmICggISAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSggJCggaGFzaFBhZ2UgKS5pcyggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSB8fAoJCQkJCSQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICkgfHwKCQkJCQloYXNoID09PSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgKSApIHsKCgkJCQkvLyBTdG9yZSB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbgoJCQkJaWYgKCAkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5pbml0aWFsRHN0ID0gaGFzaC5yZXBsYWNlKCAiIyIsICIiICk7CgkJCQl9CgoJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCBpbml0aWFsIHBvcHN0YXRlIHN0YXRlIGlmIGl0IGV4aXN0cwoJCQkJLy8gc28gdGhhdCBuYXZpZ2F0aW9uIGJhY2sgdG8gdGhlIGluaXRpYWwgcGFnZSB3b3JrcyBwcm9wZXJseQoJCQkJaWYgKCAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLnNxdWFzaCggcGF0aC5wYXJzZUxvY2F0aW9uKCkuaHJlZiApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgewoJCQkJCXRyYW5zaXRpb246ICJub25lIiwKCQkJCQlyZXZlcnNlOiB0cnVlLAoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCS8vIHRyaWdnZXIgaGFzaGNoYW5nZSBvciBuYXZpZ2F0ZSB0byBzcXVhc2ggYW5kIHJlY29yZCB0aGUgY29ycmVjdAoJCQkJLy8gaGlzdG9yeSBlbnRyeSBmb3IgYW4gaW5pdGlhbCBoYXNoIHBhdGgKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkd2luZG93LnRyaWdnZXIoICJoYXNoY2hhbmdlIiwgW3RydWVdICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIFRPRE8gZmlndXJlIG91dCBob3cgdG8gc2ltcGxpZnkgdGhpcyBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCQkvLyBhdCB0aGUgYm90dG9tIGpzL25hdmlnYXRlL25hdmlnYXRlLmpzCgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5zdGFjayA9IFtdOwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggbG9jYXRpb24uaGFzaCApID8gbG9jYXRpb24uaGFzaCA6IGxvY2F0aW9uLmhyZWYgKTsKCQkJCX0KCQkJfQoJCX0KCX0pOwoKCSQoZnVuY3Rpb24oKSB7CgkJLy9SdW4gaW5saW5lU1ZHIHN1cHBvcnQgdGVzdAoJCSQuc3VwcG9ydC5pbmxpbmVTVkcoKTsKCgkJLy8gY2hlY2sgd2hpY2ggc2Nyb2xsVG9wIHZhbHVlIHNob3VsZCBiZSB1c2VkIGJ5IHNjcm9sbGluZyB0byAxIGltbWVkaWF0ZWx5IGF0IGRvbXJlYWR5CgkJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCQkvLyBub3RlIHRoYXQgdGhpcyBpbml0aWFsIHNjcm9sbCB3b24ndCBoaWRlIHRoZSBhZGRyZXNzIGJhci4gSXQncyBqdXN0IGZvciB0aGUgY2hlY2suCgoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQgaWYgaGlkZVVybEJhciBpcyB0cnVlIHRoaXMgaXMgdG8gdHJ5IGFuZCBkbyBpdCBhcyBzb29uIGFzIHBvc3NpYmxlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCQl9CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkIGlmIGhpZGVVcmxCYXIgaXMgdHJ1ZSB0aGlzIGlzIGFzIGZhbGwgYmFjayBpbmNhc2Ugd2Ugd2VyZSB0b28gZWFybHkgYmVmb3JlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoJCX0KCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSB1aS1kaXNhYmxlZCBhZnRlciAxLjQuMCByZWxlYXNlCgkJCS8vIG9ubHkgdWktc3RhdGUtZGlzYWJsZWQgc2hvdWxkIGJlIHByZXNlbnQgdGhlcmVhZnRlcgoJCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1zdGF0ZS1kaXNhYmxlZCwudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 23:24:53 GMT",
                    "Content-Length": "452804",
                    "Date": "Thu, 06 Nov 2014 23:24:54 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}