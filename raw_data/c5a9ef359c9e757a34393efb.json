{
    "url": "http://localhost:9999/jaridmargolin/marionette.dynamiclayout/dist/marionette.dynamiclayout.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/jaridmargolin/marionette.dynamiclayout/dist/marionette.dynamiclayout.js",
                "path": "/jaridmargolin/marionette.dynamiclayout/dist/marionette.dynamiclayout.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9qYXJpZG1hcmdvbGluL21hcmlvbmV0dGUuZHluYW1pY2xheW91dC9kaXN0L21hcmlvbmV0dGUuZHluYW1pY2xheW91dC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTA5OTYzDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA5OjE2OjQ1IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwOToxNjo0NSBHTVQNCg0KKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgogICAgZGVmaW5lKFtdLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAocm9vdC5yZXR1cm5FeHBvcnRzR2xvYmFsID0gZmFjdG9yeSgpKTsKICAgIH0pOwogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CiAgICAvLyBOb2RlLiBEb2VzIG5vdCB3b3JrIHdpdGggc3RyaWN0IENvbW1vbkpTLCBidXQKICAgIC8vIG9ubHkgQ29tbW9uSlMtbGlrZSBlbnZpcm9tZW50cyB0aGF0IHN1cHBvcnQgbW9kdWxlLmV4cG9ydHMsCiAgICAvLyBsaWtlIE5vZGUuCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKICB9IGVsc2UgewogICAgcm9vdFsnRHluYW1pY0xheW91dCddID0gZmFjdG9yeSgpOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAoKSB7CgovLyAgICAgVW5kZXJzY29yZS5qcyAxLjYuMAovLyAgICAgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcKLy8gICAgIChjKSAyMDA5LTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKLy8gICAgIFVuZGVyc2NvcmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCnZhciB1bmRlcnNjb3JlLCBqcXVlcnksIGJhY2tib25lLCBiYWNrYm9uZXdyZXFyLCBjb21tYW5kZXIsIGJhY2tib25lYmFieXNpdHRlciwgYmFja2JvbmVtYXJpb25ldHRlLCBpdGVtVmlldywgaXRlbUNvbnRyb2xsZXIsIGxheW91dFZpZXcsIGxheW91dENvbnRyb2xsZXIsIG1hcmlvbmV0dGVkeW5hbWljbGF5b3V0OwooZnVuY3Rpb24gKCkgewogIC8vIEJhc2VsaW5lIHNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGV4cG9ydHNgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCiAgdmFyIHByZXZpb3VzVW5kZXJzY29yZSA9IHJvb3QuXzsKICAvLyBFc3RhYmxpc2ggdGhlIG9iamVjdCB0aGF0IGdldHMgcmV0dXJuZWQgdG8gYnJlYWsgb3V0IG9mIGEgbG9vcCBpdGVyYXRpb24uCiAgdmFyIGJyZWFrZXIgPSB7fTsKICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLCBPYmpQcm90byA9IE9iamVjdC5wcm90b3R5cGUsIEZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIgcHVzaCA9IEFycmF5UHJvdG8ucHVzaCwgc2xpY2UgPSBBcnJheVByb3RvLnNsaWNlLCBjb25jYXQgPSBBcnJheVByb3RvLmNvbmNhdCwgdG9TdHJpbmcgPSBPYmpQcm90by50b1N0cmluZywgaGFzT3duUHJvcGVydHkgPSBPYmpQcm90by5oYXNPd25Qcm9wZXJ0eTsKICAvLyBBbGwgKipFQ01BU2NyaXB0IDUqKiBuYXRpdmUgZnVuY3Rpb24gaW1wbGVtZW50YXRpb25zIHRoYXQgd2UgaG9wZSB0byB1c2UKICAvLyBhcmUgZGVjbGFyZWQgaGVyZS4KICB2YXIgbmF0aXZlRm9yRWFjaCA9IEFycmF5UHJvdG8uZm9yRWFjaCwgbmF0aXZlTWFwID0gQXJyYXlQcm90by5tYXAsIG5hdGl2ZVJlZHVjZSA9IEFycmF5UHJvdG8ucmVkdWNlLCBuYXRpdmVSZWR1Y2VSaWdodCA9IEFycmF5UHJvdG8ucmVkdWNlUmlnaHQsIG5hdGl2ZUZpbHRlciA9IEFycmF5UHJvdG8uZmlsdGVyLCBuYXRpdmVFdmVyeSA9IEFycmF5UHJvdG8uZXZlcnksIG5hdGl2ZVNvbWUgPSBBcnJheVByb3RvLnNvbWUsIG5hdGl2ZUluZGV4T2YgPSBBcnJheVByb3RvLmluZGV4T2YsIG5hdGl2ZUxhc3RJbmRleE9mID0gQXJyYXlQcm90by5sYXN0SW5kZXhPZiwgbmF0aXZlSXNBcnJheSA9IEFycmF5LmlzQXJyYXksIG5hdGl2ZUtleXMgPSBPYmplY3Qua2V5cywgbmF0aXZlQmluZCA9IEZ1bmNQcm90by5iaW5kOwogIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgogIHZhciBfID0gZnVuY3Rpb24gKG9iaikgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIF8pCiAgICAgIHJldHVybiBvYmo7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpCiAgICAgIHJldHVybiBuZXcgXyhvYmopOwogICAgdGhpcy5fd3JhcHBlZCA9IG9iajsKICB9OwogIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCiAgLy8gYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgZm9yIHRoZSBvbGQgYHJlcXVpcmUoKWAgQVBJLiBJZiB3ZSdyZSBpbgogIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdCB2aWEgYSBzdHJpbmcgaWRlbnRpZmllciwKICAvLyBmb3IgQ2xvc3VyZSBDb21waWxlciAiYWR2YW5jZWQiIG1vZGUuCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CiAgICB9CiAgICBleHBvcnRzLl8gPSBfOwogIH0gZWxzZSB7CiAgICByb290Ll8gPSBfOwogIH0KICAvLyBDdXJyZW50IHZlcnNpb24uCiAgXy5WRVJTSU9OID0gJzEuNi4wJzsKICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCiAgLy8gSGFuZGxlcyBvYmplY3RzIHdpdGggdGhlIGJ1aWx0LWluIGBmb3JFYWNoYCwgYXJyYXlzLCBhbmQgcmF3IG9iamVjdHMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZvckVhY2hgIGlmIGF2YWlsYWJsZS4KICB2YXIgZWFjaCA9IF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uIChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIHJldHVybiBvYmo7CiAgICBpZiAobmF0aXZlRm9yRWFjaCAmJiBvYmouZm9yRWFjaCA9PT0gbmF0aXZlRm9yRWFjaCkgewogICAgICBvYmouZm9yRWFjaChpdGVyYXRvciwgY29udGV4dCk7CiAgICB9IGVsc2UgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBvYmoubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpbaV0sIGksIG9iaikgPT09IGJyZWFrZXIpCiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleXNbaV1dLCBrZXlzW2ldLCBvYmopID09PSBicmVha2VyKQogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH07CiAgLy8gUmV0dXJuIHRoZSByZXN1bHRzIG9mIGFwcGx5aW5nIHRoZSBpdGVyYXRvciB0byBlYWNoIGVsZW1lbnQuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYG1hcGAgaWYgYXZhaWxhYmxlLgogIF8ubWFwID0gXy5jb2xsZWN0ID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZU1hcCAmJiBvYmoubWFwID09PSBuYXRpdmVNYXApCiAgICAgIHJldHVybiBvYmoubWFwKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJlc3VsdHMucHVzaChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwogIHZhciByZWR1Y2VFcnJvciA9ICdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJzsKICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCiAgLy8gb3IgYGZvbGRsYC4gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZWAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZSAmJiBvYmoucmVkdWNlID09PSBuYXRpdmVSZWR1Y2UpIHsKICAgICAgaWYgKGNvbnRleHQpCiAgICAgICAgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZShpdGVyYXRvcik7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gdmFsdWU7CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IocmVkdWNlRXJyb3IpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKICAvLyBUaGUgcmlnaHQtYXNzb2NpYXRpdmUgdmVyc2lvbiBvZiByZWR1Y2UsIGFsc28ga25vd24gYXMgYGZvbGRyYC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgcmVkdWNlUmlnaHRgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZVJpZ2h0ID0gXy5mb2xkciA9IGZ1bmN0aW9uIChvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKQogICAgICBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2VSaWdodCAmJiBvYmoucmVkdWNlUmlnaHQgPT09IG5hdGl2ZVJlZHVjZVJpZ2h0KSB7CiAgICAgIGlmIChjb250ZXh0KQogICAgICAgIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yKTsKICAgIH0KICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgaWYgKGxlbmd0aCAhPT0gK2xlbmd0aCkgewogICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgICBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGluZGV4ID0ga2V5cyA/IGtleXNbLS1sZW5ndGhdIDogLS1sZW5ndGg7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSBvYmpbaW5kZXhdOwogICAgICAgIGluaXRpYWwgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIG1lbW8gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG1lbW8sIG9ialtpbmRleF0sIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IocmVkdWNlRXJyb3IpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCiAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbiAob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQ7CiAgICBhbnkob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChwcmVkaWNhdGUuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZpbHRlcmAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uIChvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlRmlsdGVyICYmIG9iai5maWx0ZXIgPT09IG5hdGl2ZUZpbHRlcikKICAgICAgcmV0dXJuIG9iai5maWx0ZXIocHJlZGljYXRlLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChwcmVkaWNhdGUuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKQogICAgICAgIHJlc3VsdHMucHVzaCh2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgZm9yIHdoaWNoIGEgdHJ1dGggdGVzdCBmYWlscy4KICBfLnJlamVjdCA9IGZ1bmN0aW9uIChvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgcmV0dXJuIF8uZmlsdGVyKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gIXByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCk7CiAgICB9LCBjb250ZXh0KTsKICB9OwogIC8vIERldGVybWluZSB3aGV0aGVyIGFsbCBvZiB0aGUgZWxlbWVudHMgbWF0Y2ggYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBldmVyeWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFsbGAuCiAgXy5ldmVyeSA9IF8uYWxsID0gZnVuY3Rpb24gKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICBwcmVkaWNhdGUgfHwgKHByZWRpY2F0ZSA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlRXZlcnkgJiYgb2JqLmV2ZXJ5ID09PSBuYXRpdmVFdmVyeSkKICAgICAgcmV0dXJuIG9iai5ldmVyeShwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCEocmVzdWx0ID0gcmVzdWx0ICYmIHByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpKQogICAgICAgIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgc29tZWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgdmFyIGFueSA9IF8uc29tZSA9IF8uYW55ID0gZnVuY3Rpb24gKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICBwcmVkaWNhdGUgfHwgKHByZWRpY2F0ZSA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKG9iaiA9PSBudWxsKQogICAgICByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZVNvbWUgJiYgb2JqLnNvbWUgPT09IG5hdGl2ZVNvbWUpCiAgICAgIHJldHVybiBvYmouc29tZShwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHJlc3VsdCB8fCAocmVzdWx0ID0gcHJlZGljYXRlLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpCiAgICAgICAgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwogIC8vIERldGVybWluZSBpZiB0aGUgYXJyYXkgb3Igb2JqZWN0IGNvbnRhaW5zIGEgZ2l2ZW4gdmFsdWUgKHVzaW5nIGA9PT1gKS4KICAvLyBBbGlhc2VkIGFzIGBpbmNsdWRlYC4KICBfLmNvbnRhaW5zID0gXy5pbmNsdWRlID0gZnVuY3Rpb24gKG9iaiwgdGFyZ2V0KSB7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIGlmIChuYXRpdmVJbmRleE9mICYmIG9iai5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKQogICAgICByZXR1cm4gb2JqLmluZGV4T2YodGFyZ2V0KSAhPSAtMTsKICAgIHJldHVybiBhbnkob2JqLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0YXJnZXQ7CiAgICB9KTsKICB9OwogIC8vIEludm9rZSBhIG1ldGhvZCAod2l0aCBhcmd1bWVudHMpIG9uIGV2ZXJ5IGl0ZW0gaW4gYSBjb2xsZWN0aW9uLgogIF8uaW52b2tlID0gZnVuY3Rpb24gKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBpc0Z1bmMgPSBfLmlzRnVuY3Rpb24obWV0aG9kKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICByZXR1cm4gKGlzRnVuYyA/IG1ldGhvZCA6IHZhbHVlW21ldGhvZF0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgIH0pOwogIH07CiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgbWFwYDogZmV0Y2hpbmcgYSBwcm9wZXJ0eS4KICBfLnBsdWNrID0gZnVuY3Rpb24gKG9iaiwga2V5KSB7CiAgICByZXR1cm4gXy5tYXAob2JqLCBfLnByb3BlcnR5KGtleSkpOwogIH07CiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uIChvYmosIGF0dHJzKSB7CiAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBfLm1hdGNoZXMoYXR0cnMpKTsKICB9OwogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbmRgOiBnZXR0aW5nIHRoZSBmaXJzdCBvYmplY3QKICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8uZmluZFdoZXJlID0gZnVuY3Rpb24gKG9iaiwgYXR0cnMpIHsKICAgIHJldHVybiBfLmZpbmQob2JqLCBfLm1hdGNoZXMoYXR0cnMpKTsKICB9OwogIC8vIFJldHVybiB0aGUgbWF4aW11bSBlbGVtZW50IG9yIChlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICAvLyBDYW4ndCBvcHRpbWl6ZSBhcnJheXMgb2YgaW50ZWdlcnMgbG9uZ2VyIHRoYW4gNjUsNTM1IGVsZW1lbnRzLgogIC8vIFNlZSBbV2ViS2l0IEJ1ZyA4MDc5N10oaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTgwNzk3KQogIF8ubWF4ID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIHZhciByZXN1bHQgPSAtSW5maW5pdHksIGxhc3RDb21wdXRlZCA9IC1JbmZpbml0eTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGlmIChjb21wdXRlZCA+IGxhc3RDb21wdXRlZCkgewogICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIGxhc3RDb21wdXRlZCA9IGNvbXB1dGVkOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyBSZXR1cm4gdGhlIG1pbmltdW0gZWxlbWVudCAob3IgZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCiAgXy5taW4gPSBmdW5jdGlvbiAob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgdmFyIHJlc3VsdCA9IEluZmluaXR5LCBsYXN0Q29tcHV0ZWQgPSBJbmZpbml0eTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGlmIChjb21wdXRlZCA8IGxhc3RDb21wdXRlZCkgewogICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIGxhc3RDb21wdXRlZCA9IGNvbXB1dGVkOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyBTaHVmZmxlIGFuIGFycmF5LCB1c2luZyB0aGUgbW9kZXJuIHZlcnNpb24gb2YgdGhlCiAgLy8gW0Zpc2hlci1ZYXRlcyBzaHVmZmxlXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Zpc2hlcuKAk1lhdGVzX3NodWZmbGUpLgogIF8uc2h1ZmZsZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciByYW5kOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzaHVmZmxlZCA9IFtdOwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICByYW5kID0gXy5yYW5kb20oaW5kZXgrKyk7CiAgICAgIHNodWZmbGVkW2luZGV4IC0gMV0gPSBzaHVmZmxlZFtyYW5kXTsKICAgICAgc2h1ZmZsZWRbcmFuZF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHNodWZmbGVkOwogIH07CiAgLy8gU2FtcGxlICoqbioqIHJhbmRvbSB2YWx1ZXMgZnJvbSBhIGNvbGxlY3Rpb24uCiAgLy8gSWYgKipuKiogaXMgbm90IHNwZWNpZmllZCwgcmV0dXJucyBhIHNpbmdsZSByYW5kb20gZWxlbWVudC4KICAvLyBUaGUgaW50ZXJuYWwgYGd1YXJkYCBhcmd1bWVudCBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBtYXBgLgogIF8uc2FtcGxlID0gZnVuY3Rpb24gKG9iaiwgbiwgZ3VhcmQpIHsKICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpIHsKICAgICAgaWYgKG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoKQogICAgICAgIG9iaiA9IF8udmFsdWVzKG9iaik7CiAgICAgIHJldHVybiBvYmpbXy5yYW5kb20ob2JqLmxlbmd0aCAtIDEpXTsKICAgIH0KICAgIHJldHVybiBfLnNodWZmbGUob2JqKS5zbGljZSgwLCBNYXRoLm1heCgwLCBuKSk7CiAgfTsKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB0byBnZW5lcmF0ZSBsb29rdXAgaXRlcmF0b3JzLgogIHZhciBsb29rdXBJdGVyYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgaWYgKHZhbHVlID09IG51bGwpCiAgICAgIHJldHVybiBfLmlkZW50aXR5OwogICAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpCiAgICAgIHJldHVybiB2YWx1ZTsKICAgIHJldHVybiBfLnByb3BlcnR5KHZhbHVlKTsKICB9OwogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRvci4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uIChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgIHJldHVybiBfLnBsdWNrKF8ubWFwKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgY3JpdGVyaWE6IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KQogICAgICB9OwogICAgfSkuc29ydChmdW5jdGlvbiAobGVmdCwgcmlnaHQpIHsKICAgICAgdmFyIGEgPSBsZWZ0LmNyaXRlcmlhOwogICAgICB2YXIgYiA9IHJpZ2h0LmNyaXRlcmlhOwogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGlmIChhID4gYiB8fCBhID09PSB2b2lkIDApCiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICBpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKQogICAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHJldHVybiBsZWZ0LmluZGV4IC0gcmlnaHQuaW5kZXg7CiAgICB9KSwgJ3ZhbHVlJyk7CiAgfTsKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgogIHZhciBncm91cCA9IGZ1bmN0aW9uIChiZWhhdmlvcikgewogICAgcmV0dXJuIGZ1bmN0aW9uIChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcihpdGVyYXRvcik7CiAgICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgdmFyIGtleSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBvYmopOwogICAgICAgIGJlaGF2aW9yKHJlc3VsdCwga2V5LCB2YWx1ZSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwogIC8vIEdyb3VwcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLiBQYXNzIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUKICAvLyB0byBncm91cCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGNyaXRlcmlvbi4KICBfLmdyb3VwQnkgPSBncm91cChmdW5jdGlvbiAocmVzdWx0LCBrZXksIHZhbHVlKSB7CiAgICBfLmhhcyhyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XS5wdXNoKHZhbHVlKSA6IHJlc3VsdFtrZXldID0gW3ZhbHVlXTsKICB9KTsKICAvLyBJbmRleGVzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24sIHNpbWlsYXIgdG8gYGdyb3VwQnlgLCBidXQgZm9yCiAgLy8gd2hlbiB5b3Uga25vdyB0aGF0IHlvdXIgaW5kZXggdmFsdWVzIHdpbGwgYmUgdW5pcXVlLgogIF8uaW5kZXhCeSA9IGdyb3VwKGZ1bmN0aW9uIChyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgfSk7CiAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCiAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgLy8gY3JpdGVyaW9uLgogIF8uY291bnRCeSA9IGdyb3VwKGZ1bmN0aW9uIChyZXN1bHQsIGtleSkgewogICAgXy5oYXMocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0rKyA6IHJlc3VsdFtrZXldID0gMTsKICB9KTsKICAvLyBVc2UgYSBjb21wYXJhdG9yIGZ1bmN0aW9uIHRvIGZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoCiAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgogIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbiAoYXJyYXksIG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmopOwogICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CiAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICB2YXIgbWlkID0gbG93ICsgaGlnaCA+Pj4gMTsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBhcnJheVttaWRdKSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CiAgLy8gU2FmZWx5IGNyZWF0ZSBhIHJlYWwsIGxpdmUgYXJyYXkgZnJvbSBhbnl0aGluZyBpdGVyYWJsZS4KICBfLnRvQXJyYXkgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBpZiAoIW9iaikKICAgICAgcmV0dXJuIFtdOwogICAgaWYgKF8uaXNBcnJheShvYmopKQogICAgICByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKQogICAgICByZXR1cm4gXy5tYXAob2JqLCBfLmlkZW50aXR5KTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CiAgLy8gUmV0dXJuIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gb2JqZWN0LgogIF8uc2l6ZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIDA7CiAgICByZXR1cm4gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CiAgLy8gQXJyYXkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawogIC8vIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24gKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpCiAgICAgIHJldHVybiB2b2lkIDA7CiAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKQogICAgICByZXR1cm4gYXJyYXlbMF07CiAgICBpZiAobiA8IDApCiAgICAgIHJldHVybiBbXTsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBuKTsKICB9OwogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgogIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCiAgLy8gdGhlIGFycmF5LCBleGNsdWRpbmcgdGhlIGxhc3QgTi4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoCiAgLy8gYF8ubWFwYC4KICBfLmluaXRpYWwgPSBmdW5jdGlvbiAoYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgYXJyYXkubGVuZ3RoIC0gKG4gPT0gbnVsbCB8fCBndWFyZCA/IDEgOiBuKSk7CiAgfTsKICAvLyBHZXQgdGhlIGxhc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgbGFzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5sYXN0ID0gZnVuY3Rpb24gKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpCiAgICAgIHJldHVybiB2b2lkIDA7CiAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKQogICAgICByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgTWF0aC5tYXgoYXJyYXkubGVuZ3RoIC0gbiwgMCkpOwogIH07CiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgogIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCiAgLy8gdGhlIHJlc3QgTiB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqCiAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uIChhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBuID09IG51bGwgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKICAvLyBUcmltIG91dCBhbGwgZmFsc3kgdmFsdWVzIGZyb20gYW4gYXJyYXkuCiAgXy5jb21wYWN0ID0gZnVuY3Rpb24gKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIF8uaWRlbnRpdHkpOwogIH07CiAgLy8gSW50ZXJuYWwgaW1wbGVtZW50YXRpb24gb2YgYSByZWN1cnNpdmUgYGZsYXR0ZW5gIGZ1bmN0aW9uLgogIHZhciBmbGF0dGVuID0gZnVuY3Rpb24gKGlucHV0LCBzaGFsbG93LCBvdXRwdXQpIHsKICAgIGlmIChzaGFsbG93ICYmIF8uZXZlcnkoaW5wdXQsIF8uaXNBcnJheSkpIHsKICAgICAgcmV0dXJuIGNvbmNhdC5hcHBseShvdXRwdXQsIGlucHV0KTsKICAgIH0KICAgIGVhY2goaW5wdXQsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSB8fCBfLmlzQXJndW1lbnRzKHZhbHVlKSkgewogICAgICAgIHNoYWxsb3cgPyBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpIDogZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgb3V0cHV0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwogIC8vIEZsYXR0ZW4gb3V0IGFuIGFycmF5LCBlaXRoZXIgcmVjdXJzaXZlbHkgKGJ5IGRlZmF1bHQpLCBvciBqdXN0IG9uZSBsZXZlbC4KICBfLmZsYXR0ZW4gPSBmdW5jdGlvbiAoYXJyYXksIHNoYWxsb3cpIHsKICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBbXSk7CiAgfTsKICAvLyBSZXR1cm4gYSB2ZXJzaW9uIG9mIHRoZSBhcnJheSB0aGF0IGRvZXMgbm90IGNvbnRhaW4gdGhlIHNwZWNpZmllZCB2YWx1ZShzKS4KICBfLndpdGhvdXQgPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgIHJldHVybiBfLmRpZmZlcmVuY2UoYXJyYXksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfTsKICAvLyBTcGxpdCBhbiBhcnJheSBpbnRvIHR3byBhcnJheXM6IG9uZSB3aG9zZSBlbGVtZW50cyBhbGwgc2F0aXNmeSB0aGUgZ2l2ZW4KICAvLyBwcmVkaWNhdGUsIGFuZCBvbmUgd2hvc2UgZWxlbWVudHMgYWxsIGRvIG5vdCBzYXRpc2Z5IHRoZSBwcmVkaWNhdGUuCiAgXy5wYXJ0aXRpb24gPSBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSkgewogICAgdmFyIHBhc3MgPSBbXSwgZmFpbCA9IFtdOwogICAgZWFjaChhcnJheSwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgKHByZWRpY2F0ZShlbGVtKSA/IHBhc3MgOiBmYWlsKS5wdXNoKGVsZW0pOwogICAgfSk7CiAgICByZXR1cm4gWwogICAgICBwYXNzLAogICAgICBmYWlsCiAgICBdOwogIH07CiAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKICAvLyBiZWVuIHNvcnRlZCwgeW91IGhhdmUgdGhlIG9wdGlvbiBvZiB1c2luZyBhIGZhc3RlciBhbGdvcml0aG0uCiAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uIChhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGlzU29ydGVkKSkgewogICAgICBjb250ZXh0ID0gaXRlcmF0b3I7CiAgICAgIGl0ZXJhdG9yID0gaXNTb3J0ZWQ7CiAgICAgIGlzU29ydGVkID0gZmFsc2U7CiAgICB9CiAgICB2YXIgaW5pdGlhbCA9IGl0ZXJhdG9yID8gXy5tYXAoYXJyYXksIGl0ZXJhdG9yLCBjb250ZXh0KSA6IGFycmF5OwogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBzZWVuID0gW107CiAgICBlYWNoKGluaXRpYWwsIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgaWYgKGlzU29ydGVkID8gIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gdmFsdWUgOiAhXy5jb250YWlucyhzZWVuLCB2YWx1ZSkpIHsKICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIHJlc3VsdHMucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CiAgLy8gUHJvZHVjZSBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIHRoZSB1bmlvbjogZWFjaCBkaXN0aW5jdCBlbGVtZW50IGZyb20gYWxsIG9mCiAgLy8gdGhlIHBhc3NlZC1pbiBhcnJheXMuCiAgXy51bmlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBfLnVuaXEoXy5mbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSkpOwogIH07CiAgLy8gUHJvZHVjZSBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIGV2ZXJ5IGl0ZW0gc2hhcmVkIGJldHdlZW4gYWxsIHRoZQogIC8vIHBhc3NlZC1pbiBhcnJheXMuCiAgXy5pbnRlcnNlY3Rpb24gPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgIHZhciByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIF8uZmlsdGVyKF8udW5pcShhcnJheSksIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiBfLmV2ZXJ5KHJlc3QsIGZ1bmN0aW9uIChvdGhlcikgewogICAgICAgIHJldHVybiBfLmNvbnRhaW5zKG90aGVyLCBpdGVtKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uIChhcnJheSkgewogICAgdmFyIHJlc3QgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7CiAgICB9KTsKICB9OwogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsZW5ndGggPSBfLm1heChfLnBsdWNrKGFyZ3VtZW50cywgJ2xlbmd0aCcpLmNvbmNhdCgwKSk7CiAgICB2YXIgcmVzdWx0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICByZXN1bHRzW2ldID0gXy5wbHVjayhhcmd1bWVudHMsICcnICsgaSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbiAobGlzdCwgdmFsdWVzKSB7CiAgICBpZiAobGlzdCA9PSBudWxsKQogICAgICByZXR1cm4ge307CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gbGlzdC5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBpZiAodmFsdWVzKSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1dID0gdmFsdWVzW2ldOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdFtsaXN0W2ldWzBdXSA9IGxpc3RbaV1bMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyBJZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBseSB1cyB3aXRoIGluZGV4T2YgKEknbSBsb29raW5nIGF0IHlvdSwgKipNU0lFKiopLAogIC8vIHdlIG5lZWQgdGhpcyBmdW5jdGlvbi4gUmV0dXJuIHRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhbgogIC8vIGl0ZW0gaW4gYW4gYXJyYXksIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uIChhcnJheSwgaXRlbSwgaXNTb3J0ZWQpIHsKICAgIGlmIChhcnJheSA9PSBudWxsKQogICAgICByZXR1cm4gLTE7CiAgICB2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChpc1NvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CiAgICAgICAgaSA9IGlzU29ydGVkIDwgMCA/IE1hdGgubWF4KDAsIGxlbmd0aCArIGlzU29ydGVkKSA6IGlzU29ydGVkOwogICAgICB9IGVsc2UgewogICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKICAgICAgICByZXR1cm4gYXJyYXlbaV0gPT09IGl0ZW0gPyBpIDogLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChuYXRpdmVJbmRleE9mICYmIGFycmF5LmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpCiAgICAgIHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0sIGlzU29ydGVkKTsKICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspCiAgICAgIGlmIChhcnJheVtpXSA9PT0gaXRlbSkKICAgICAgICByZXR1cm4gaTsKICAgIHJldHVybiAtMTsKICB9OwogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBsYXN0SW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbiAoYXJyYXksIGl0ZW0sIGZyb20pIHsKICAgIGlmIChhcnJheSA9PSBudWxsKQogICAgICByZXR1cm4gLTE7CiAgICB2YXIgaGFzSW5kZXggPSBmcm9tICE9IG51bGw7CiAgICBpZiAobmF0aXZlTGFzdEluZGV4T2YgJiYgYXJyYXkubGFzdEluZGV4T2YgPT09IG5hdGl2ZUxhc3RJbmRleE9mKSB7CiAgICAgIHJldHVybiBoYXNJbmRleCA/IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0sIGZyb20pIDogYXJyYXkubGFzdEluZGV4T2YoaXRlbSk7CiAgICB9CiAgICB2YXIgaSA9IGhhc0luZGV4ID8gZnJvbSA6IGFycmF5Lmxlbmd0aDsKICAgIHdoaWxlIChpLS0pCiAgICAgIGlmIChhcnJheVtpXSA9PT0gaXRlbSkKICAgICAgICByZXR1cm4gaTsKICAgIHJldHVybiAtMTsKICB9OwogIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKICAvLyB0aGUgbmF0aXZlIFB5dGhvbiBgcmFuZ2UoKWAgZnVuY3Rpb24uIFNlZQogIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCiAgXy5yYW5nZSA9IGZ1bmN0aW9uIChzdGFydCwgc3RvcCwgc3RlcCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMSkgewogICAgICBzdG9wID0gc3RhcnQgfHwgMDsKICAgICAgc3RhcnQgPSAwOwogICAgfQogICAgc3RlcCA9IGFyZ3VtZW50c1syXSB8fCAxOwogICAgdmFyIGxlbmd0aCA9IE1hdGgubWF4KE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApLCAwKTsKICAgIHZhciBpZHggPSAwOwogICAgdmFyIHJhbmdlID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICB3aGlsZSAoaWR4IDwgbGVuZ3RoKSB7CiAgICAgIHJhbmdlW2lkeCsrXSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQogICAgcmV0dXJuIHJhbmdlOwogIH07CiAgLy8gRnVuY3Rpb24gKGFoZW0pIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIFJldXNhYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciBwcm90b3R5cGUgc2V0dGluZy4KICB2YXIgY3RvciA9IGZ1bmN0aW9uICgpIHsKICB9OwogIC8vIENyZWF0ZSBhIGZ1bmN0aW9uIGJvdW5kIHRvIGEgZ2l2ZW4gb2JqZWN0IChhc3NpZ25pbmcgYHRoaXNgLCBhbmQgYXJndW1lbnRzLAogIC8vIG9wdGlvbmFsbHkpLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgRnVuY3Rpb24uYmluZGAgaWYKICAvLyBhdmFpbGFibGUuCiAgXy5iaW5kID0gZnVuY3Rpb24gKGZ1bmMsIGNvbnRleHQpIHsKICAgIHZhciBhcmdzLCBib3VuZDsKICAgIGlmIChuYXRpdmVCaW5kICYmIGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCkKICAgICAgcmV0dXJuIG5hdGl2ZUJpbmQuYXBwbHkoZnVuYywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGlmICghXy5pc0Z1bmN0aW9uKGZ1bmMpKQogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgYm91bmQpKQogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBjdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICB2YXIgc2VsZiA9IG5ldyBjdG9yKCk7CiAgICAgIGN0b3IucHJvdG90eXBlID0gbnVsbDsKICAgICAgdmFyIHJlc3VsdCA9IGZ1bmMuYXBwbHkoc2VsZiwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIGlmIChPYmplY3QocmVzdWx0KSA9PT0gcmVzdWx0KQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIHJldHVybiBzZWxmOwogICAgfTsKICB9OwogIC8vIFBhcnRpYWxseSBhcHBseSBhIGZ1bmN0aW9uIGJ5IGNyZWF0aW5nIGEgdmVyc2lvbiB0aGF0IGhhcyBoYWQgc29tZSBvZiBpdHMKICAvLyBhcmd1bWVudHMgcHJlLWZpbGxlZCwgd2l0aG91dCBjaGFuZ2luZyBpdHMgZHluYW1pYyBgdGhpc2AgY29udGV4dC4gXyBhY3RzCiAgLy8gYXMgYSBwbGFjZWhvbGRlciwgYWxsb3dpbmcgYW55IGNvbWJpbmF0aW9uIG9mIGFyZ3VtZW50cyB0byBiZSBwcmUtZmlsbGVkLgogIF8ucGFydGlhbCA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICB2YXIgYm91bmRBcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHBvc2l0aW9uID0gMDsKICAgICAgdmFyIGFyZ3MgPSBib3VuZEFyZ3Muc2xpY2UoKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoYXJnc1tpXSA9PT0gXykKICAgICAgICAgIGFyZ3NbaV0gPSBhcmd1bWVudHNbcG9zaXRpb24rK107CiAgICAgIH0KICAgICAgd2hpbGUgKHBvc2l0aW9uIDwgYXJndW1lbnRzLmxlbmd0aCkKICAgICAgICBhcmdzLnB1c2goYXJndW1lbnRzW3Bvc2l0aW9uKytdKTsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CiAgLy8gQmluZCBhIG51bWJlciBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBSZW1haW5pbmcgYXJndW1lbnRzCiAgLy8gYXJlIHRoZSBtZXRob2QgbmFtZXMgdG8gYmUgYm91bmQuIFVzZWZ1bCBmb3IgZW5zdXJpbmcgdGhhdCBhbGwgY2FsbGJhY2tzCiAgLy8gZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgogIF8uYmluZEFsbCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBmdW5jcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIGlmIChmdW5jcy5sZW5ndGggPT09IDApCiAgICAgIHRocm93IG5ldyBFcnJvcignYmluZEFsbCBtdXN0IGJlIHBhc3NlZCBmdW5jdGlvbiBuYW1lcycpOwogICAgZWFjaChmdW5jcywgZnVuY3Rpb24gKGYpIHsKICAgICAgb2JqW2ZdID0gXy5iaW5kKG9ialtmXSwgb2JqKTsKICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwogIC8vIE1lbW9pemUgYW4gZXhwZW5zaXZlIGZ1bmN0aW9uIGJ5IHN0b3JpbmcgaXRzIHJlc3VsdHMuCiAgXy5tZW1vaXplID0gZnVuY3Rpb24gKGZ1bmMsIGhhc2hlcikgewogICAgdmFyIG1lbW8gPSB7fTsKICAgIGhhc2hlciB8fCAoaGFzaGVyID0gXy5pZGVudGl0eSk7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICB2YXIga2V5ID0gaGFzaGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBfLmhhcyhtZW1vLCBrZXkpID8gbWVtb1trZXldIDogbWVtb1trZXldID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9OwogIC8vIERlbGF5cyBhIGZ1bmN0aW9uIGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kIHRoZW4gY2FsbHMKICAvLyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgc3VwcGxpZWQuCiAgXy5kZWxheSA9IGZ1bmN0aW9uIChmdW5jLCB3YWl0KSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkobnVsbCwgYXJncyk7CiAgICB9LCB3YWl0KTsKICB9OwogIC8vIERlZmVycyBhIGZ1bmN0aW9uLCBzY2hlZHVsaW5nIGl0IHRvIHJ1biBhZnRlciB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcwogIC8vIGNsZWFyZWQuCiAgXy5kZWZlciA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICByZXR1cm4gXy5kZWxheS5hcHBseShfLCBbCiAgICAgIGZ1bmMsCiAgICAgIDEKICAgIF0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpOwogIH07CiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCB3aGVuIGludm9rZWQsIHdpbGwgb25seSBiZSB0cmlnZ2VyZWQgYXQgbW9zdCBvbmNlCiAgLy8gZHVyaW5nIGEgZ2l2ZW4gd2luZG93IG9mIHRpbWUuIE5vcm1hbGx5LCB0aGUgdGhyb3R0bGVkIGZ1bmN0aW9uIHdpbGwgcnVuCiAgLy8gYXMgbXVjaCBhcyBpdCBjYW4sIHdpdGhvdXQgZXZlciBnb2luZyBtb3JlIHRoYW4gb25jZSBwZXIgYHdhaXRgIGR1cmF0aW9uOwogIC8vIGJ1dCBpZiB5b3UnZCBsaWtlIHRvIGRpc2FibGUgdGhlIGV4ZWN1dGlvbiBvbiB0aGUgbGVhZGluZyBlZGdlLCBwYXNzCiAgLy8gYHtsZWFkaW5nOiBmYWxzZX1gLiBUbyBkaXNhYmxlIGV4ZWN1dGlvbiBvbiB0aGUgdHJhaWxpbmcgZWRnZSwgZGl0dG8uCiAgXy50aHJvdHRsZSA9IGZ1bmN0aW9uIChmdW5jLCB3YWl0LCBvcHRpb25zKSB7CiAgICB2YXIgY29udGV4dCwgYXJncywgcmVzdWx0OwogICAgdmFyIHRpbWVvdXQgPSBudWxsOwogICAgdmFyIHByZXZpb3VzID0gMDsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHByZXZpb3VzID0gb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSA/IDAgOiBfLm5vdygpOwogICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBub3cgPSBfLm5vdygpOwogICAgICBpZiAoIXByZXZpb3VzICYmIG9wdGlvbnMubGVhZGluZyA9PT0gZmFsc2UpCiAgICAgICAgcHJldmlvdXMgPSBub3c7CiAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGlmIChyZW1haW5pbmcgPD0gMCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBwcmV2aW91cyA9IG5vdzsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKICAgICAgfSBlbHNlIGlmICghdGltZW91dCAmJiBvcHRpb25zLnRyYWlsaW5nICE9PSBmYWxzZSkgewogICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAogIC8vIGJlIHRyaWdnZXJlZC4gVGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGl0IHN0b3BzIGJlaW5nIGNhbGxlZCBmb3IKICAvLyBOIG1pbGxpc2Vjb25kcy4gSWYgYGltbWVkaWF0ZWAgaXMgcGFzc2VkLCB0cmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUKICAvLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLgogIF8uZGVib3VuY2UgPSBmdW5jdGlvbiAoZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICB2YXIgdGltZW91dCwgYXJncywgY29udGV4dCwgdGltZXN0YW1wLCByZXN1bHQ7CiAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBsYXN0ID0gXy5ub3coKSAtIHRpbWVzdGFtcDsKICAgICAgaWYgKGxhc3QgPCB3YWl0KSB7CiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQgLSBsYXN0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAoIWltbWVkaWF0ZSkgewogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdGltZXN0YW1wID0gXy5ub3coKTsKICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGlmICghdGltZW91dCkgewogICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgfQogICAgICBpZiAoY2FsbE5vdykgewogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CiAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KICBfLm9uY2UgPSBmdW5jdGlvbiAoZnVuYykgewogICAgdmFyIHJhbiA9IGZhbHNlLCBtZW1vOwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHJhbikKICAgICAgICByZXR1cm4gbWVtbzsKICAgICAgcmFuID0gdHJ1ZTsKICAgICAgbWVtbyA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgZnVuYyA9IG51bGw7CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICB9OwogIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAogIC8vIGFsbG93aW5nIHlvdSB0byBhZGp1c3QgYXJndW1lbnRzLCBydW4gY29kZSBiZWZvcmUgYW5kIGFmdGVyLCBhbmQKICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogIF8ud3JhcCA9IGZ1bmN0aW9uIChmdW5jLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gXy5wYXJ0aWFsKHdyYXBwZXIsIGZ1bmMpOwogIH07CiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgaXMgdGhlIGNvbXBvc2l0aW9uIG9mIGEgbGlzdCBvZiBmdW5jdGlvbnMsIGVhY2gKICAvLyBjb25zdW1pbmcgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCBmb2xsb3dzLgogIF8uY29tcG9zZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICBmb3IgKHZhciBpID0gZnVuY3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgfQogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH07CiAgfTsKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCiAgXy5hZnRlciA9IGZ1bmN0aW9uICh0aW1lcywgZnVuYykgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKC0tdGltZXMgPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9OwogIC8vIE9iamVjdCBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgLy8gUmV0cmlldmUgdGhlIG5hbWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYE9iamVjdC5rZXlzYAogIF8ua2V5cyA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmICghXy5pc09iamVjdChvYmopKQogICAgICByZXR1cm4gW107CiAgICBpZiAobmF0aXZlS2V5cykKICAgICAgcmV0dXJuIG5hdGl2ZUtleXMob2JqKTsKICAgIHZhciBrZXlzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKQogICAgICBpZiAoXy5oYXMob2JqLCBrZXkpKQogICAgICAgIGtleXMucHVzaChrZXkpOwogICAgcmV0dXJuIGtleXM7CiAgfTsKICAvLyBSZXRyaWV2ZSB0aGUgdmFsdWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgXy52YWx1ZXMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgdmFyIHZhbHVlcyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YWx1ZXNbaV0gPSBvYmpba2V5c1tpXV07CiAgICB9CiAgICByZXR1cm4gdmFsdWVzOwogIH07CiAgLy8gQ29udmVydCBhbiBvYmplY3QgaW50byBhIGxpc3Qgb2YgYFtrZXksIHZhbHVlXWAgcGFpcnMuCiAgXy5wYWlycyA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICB2YXIgcGFpcnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcGFpcnNbaV0gPSBbCiAgICAgICAga2V5c1tpXSwKICAgICAgICBvYmpba2V5c1tpXV0KICAgICAgXTsKICAgIH0KICAgIHJldHVybiBwYWlyczsKICB9OwogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICByZXN1bHRbb2JqW2tleXNbaV1dXSA9IGtleXNbaV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgbmFtZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihvYmpba2V5XSkpCiAgICAgICAgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwogIC8vIEV4dGVuZCBhIGdpdmVuIG9iamVjdCB3aXRoIGFsbCB0aGUgcHJvcGVydGllcyBpbiBwYXNzZWQtaW4gb2JqZWN0KHMpLgogIF8uZXh0ZW5kID0gZnVuY3Rpb24gKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgb25seSBjb250YWluaW5nIHRoZSB3aGl0ZWxpc3RlZCBwcm9wZXJ0aWVzLgogIF8ucGljayA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZWFjaChrZXlzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKQogICAgICAgIGNvcHlba2V5XSA9IG9ialtrZXldOwogICAgfSk7CiAgICByZXR1cm4gY29weTsKICB9OwogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgogIF8ub21pdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoIV8uY29udGFpbnMoa2V5cywga2V5KSkKICAgICAgICBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CiAgLy8gRmlsbCBpbiBhIGdpdmVuIG9iamVjdCB3aXRoIGRlZmF1bHQgcHJvcGVydGllcy4KICBfLmRlZmF1bHRzID0gZnVuY3Rpb24gKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICBpZiAob2JqW3Byb3BdID09PSB2b2lkIDApCiAgICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwogIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KICBfLmNsb25lID0gZnVuY3Rpb24gKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpCiAgICAgIHJldHVybiBvYmo7CiAgICByZXR1cm4gXy5pc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IF8uZXh0ZW5kKHt9LCBvYmopOwogIH07CiAgLy8gSW52b2tlcyBpbnRlcmNlcHRvciB3aXRoIHRoZSBvYmosIGFuZCB0aGVuIHJldHVybnMgb2JqLgogIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICBfLnRhcCA9IGZ1bmN0aW9uIChvYmosIGludGVyY2VwdG9yKSB7CiAgICBpbnRlcmNlcHRvcihvYmopOwogICAgcmV0dXJuIG9iajsKICB9OwogIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCiAgdmFyIGVxID0gZnVuY3Rpb24gKGEsIGIsIGFTdGFjaywgYlN0YWNrKSB7CiAgICAvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCiAgICAvLyBTZWUgdGhlIFtIYXJtb255IGBlZ2FsYCBwcm9wb3NhbF0oaHR0cDovL3dpa2kuZWNtYXNjcmlwdC5vcmcvZG9rdS5waHA/aWQ9aGFybW9ueTplZ2FsKS4KICAgIGlmIChhID09PSBiKQogICAgICByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PSAxIC8gYjsKICAgIC8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKQogICAgICByZXR1cm4gYSA9PT0gYjsKICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgogICAgaWYgKGEgaW5zdGFuY2VvZiBfKQogICAgICBhID0gYS5fd3JhcHBlZDsKICAgIGlmIChiIGluc3RhbmNlb2YgXykKICAgICAgYiA9IGIuX3dyYXBwZWQ7CiAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CiAgICBpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAvLyBTdHJpbmdzLCBudW1iZXJzLCBkYXRlcywgYW5kIGJvb2xlYW5zIGFyZSBjb21wYXJlZCBieSB2YWx1ZS4KICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CiAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwogICAgICAvLyBlcXVpdmFsZW50IHRvIGBuZXcgU3RyaW5nKCI1IilgLgogICAgICByZXR1cm4gYSA9PSBTdHJpbmcoYik7CiAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgogICAgICAvLyBgTmFOYHMgYXJlIGVxdWl2YWxlbnQsIGJ1dCBub24tcmVmbGV4aXZlLiBBbiBgZWdhbGAgY29tcGFyaXNvbiBpcyBwZXJmb3JtZWQgZm9yCiAgICAgIC8vIG90aGVyIG51bWVyaWMgdmFsdWVzLgogICAgICByZXR1cm4gYSAhPSArYSA/IGIgIT0gK2IgOiBhID09IDAgPyAxIC8gYSA9PSAxIC8gYiA6IGEgPT0gK2I7CiAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoKICAgIGNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgogICAgICAvLyBDb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWVyaWMgcHJpbWl0aXZlIHZhbHVlcy4gRGF0ZXMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyCiAgICAgIC8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKICAgICAgLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgogICAgICByZXR1cm4gK2EgPT0gK2I7CiAgICAvLyBSZWdFeHBzIGFyZSBjb21wYXJlZCBieSB0aGVpciBzb3VyY2UgcGF0dGVybnMgYW5kIGZsYWdzLgogICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKICAgICAgcmV0dXJuIGEuc291cmNlID09IGIuc291cmNlICYmIGEuZ2xvYmFsID09IGIuZ2xvYmFsICYmIGEubXVsdGlsaW5lID09IGIubXVsdGlsaW5lICYmIGEuaWdub3JlQ2FzZSA9PSBiLmlnbm9yZUNhc2U7CiAgICB9CiAgICBpZiAodHlwZW9mIGEgIT0gJ29iamVjdCcgfHwgdHlwZW9mIGIgIT0gJ29iamVjdCcpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIC8vIEFzc3VtZSBlcXVhbGl0eSBmb3IgY3ljbGljIHN0cnVjdHVyZXMuIFRoZSBhbGdvcml0aG0gZm9yIGRldGVjdGluZyBjeWNsaWMKICAgIC8vIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMSBzZWN0aW9uIDE1LjEyLjMsIGFic3RyYWN0IG9wZXJhdGlvbiBgSk9gLgogICAgdmFyIGxlbmd0aCA9IGFTdGFjay5sZW5ndGg7CiAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgLy8gTGluZWFyIHNlYXJjaC4gUGVyZm9ybWFuY2UgaXMgaW52ZXJzZWx5IHByb3BvcnRpb25hbCB0byB0aGUgbnVtYmVyIG9mCiAgICAgIC8vIHVuaXF1ZSBuZXN0ZWQgc3RydWN0dXJlcy4KICAgICAgaWYgKGFTdGFja1tsZW5ndGhdID09IGEpCiAgICAgICAgcmV0dXJuIGJTdGFja1tsZW5ndGhdID09IGI7CiAgICB9CiAgICAvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKICAgIC8vIGZyb20gZGlmZmVyZW50IGZyYW1lcyBhcmUuCiAgICB2YXIgYUN0b3IgPSBhLmNvbnN0cnVjdG9yLCBiQ3RvciA9IGIuY29uc3RydWN0b3I7CiAgICBpZiAoYUN0b3IgIT09IGJDdG9yICYmICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiBhQ3RvciBpbnN0YW5jZW9mIGFDdG9yICYmIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgYkN0b3IgaW5zdGFuY2VvZiBiQ3RvcikgJiYgKCdjb25zdHJ1Y3RvcicgaW4gYSAmJiAnY29uc3RydWN0b3InIGluIGIpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8vIEFkZCB0aGUgZmlyc3Qgb2JqZWN0IHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wdXNoKGEpOwogICAgYlN0YWNrLnB1c2goYik7CiAgICB2YXIgc2l6ZSA9IDAsIHJlc3VsdCA9IHRydWU7CiAgICAvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KICAgIGlmIChjbGFzc05hbWUgPT0gJ1tvYmplY3QgQXJyYXldJykgewogICAgICAvLyBDb21wYXJlIGFycmF5IGxlbmd0aHMgdG8gZGV0ZXJtaW5lIGlmIGEgZGVlcCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeS4KICAgICAgc2l6ZSA9IGEubGVuZ3RoOwogICAgICByZXN1bHQgPSBzaXplID09IGIubGVuZ3RoOwogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgLy8gRGVlcCBjb21wYXJlIHRoZSBjb250ZW50cywgaWdub3Jpbmcgbm9uLW51bWVyaWMgcHJvcGVydGllcy4KICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBlcShhW3NpemVdLCBiW3NpemVdLCBhU3RhY2ssIGJTdGFjaykpKQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIERlZXAgY29tcGFyZSBvYmplY3RzLgogICAgICBmb3IgKHZhciBrZXkgaW4gYSkgewogICAgICAgIGlmIChfLmhhcyhhLCBrZXkpKSB7CiAgICAgICAgICAvLyBDb3VudCB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgICAgICBzaXplKys7CiAgICAgICAgICAvLyBEZWVwIGNvbXBhcmUgZWFjaCBtZW1iZXIuCiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBfLmhhcyhiLCBrZXkpICYmIGVxKGFba2V5XSwgYltrZXldLCBhU3RhY2ssIGJTdGFjaykpKQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICBmb3IgKGtleSBpbiBiKSB7CiAgICAgICAgICBpZiAoXy5oYXMoYiwga2V5KSAmJiAhc2l6ZS0tKQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgIH0KICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnBvcCgpOwogICAgYlN0YWNrLnBvcCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIC8vIFBlcmZvcm0gYSBkZWVwIGNvbXBhcmlzb24gdG8gY2hlY2sgaWYgdHdvIG9iamVjdHMgYXJlIGVxdWFsLgogIF8uaXNFcXVhbCA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKICB9OwogIC8vIElzIGEgZ2l2ZW4gYXJyYXksIHN0cmluZywgb3Igb2JqZWN0IGVtcHR5PwogIC8vIEFuICJlbXB0eSIgb2JqZWN0IGhhcyBubyBlbnVtZXJhYmxlIG93bi1wcm9wZXJ0aWVzLgogIF8uaXNFbXB0eSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIHRydWU7CiAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopKQogICAgICByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIGZvciAodmFyIGtleSBpbiBvYmopCiAgICAgIGlmIChfLmhhcyhvYmosIGtleSkpCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfTsKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGEgRE9NIGVsZW1lbnQ/CiAgXy5pc0VsZW1lbnQgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMSk7CiAgfTsKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGFuIGFycmF5PwogIC8vIERlbGVnYXRlcyB0byBFQ01BNSdzIG5hdGl2ZSBBcnJheS5pc0FycmF5CiAgXy5pc0FycmF5ID0gbmF0aXZlSXNBcnJheSB8fCBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIGFuIG9iamVjdD8KICBfLmlzT2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gT2JqZWN0KG9iaik7CiAgfTsKICAvLyBBZGQgc29tZSBpc1R5cGUgbWV0aG9kczogaXNBcmd1bWVudHMsIGlzRnVuY3Rpb24sIGlzU3RyaW5nLCBpc051bWJlciwgaXNEYXRlLCBpc1JlZ0V4cC4KICBlYWNoKFsKICAgICdBcmd1bWVudHMnLAogICAgJ0Z1bmN0aW9uJywKICAgICdTdHJpbmcnLAogICAgJ051bWJlcicsCiAgICAnRGF0ZScsCiAgICAnUmVnRXhwJwogIF0sIGZ1bmN0aW9uIChuYW1lKSB7CiAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCAnICsgbmFtZSArICddJzsKICAgIH07CiAgfSk7CiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiAhIShvYmogJiYgXy5oYXMob2JqLCAnY2FsbGVlJykpOwogICAgfTsKICB9CiAgLy8gT3B0aW1pemUgYGlzRnVuY3Rpb25gIGlmIGFwcHJvcHJpYXRlLgogIGlmICh0eXBlb2YgLy4vICE9PSAnZnVuY3Rpb24nKSB7CiAgICBfLmlzRnVuY3Rpb24gPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nOwogICAgfTsKICB9CiAgLy8gSXMgYSBnaXZlbiBvYmplY3QgYSBmaW5pdGUgbnVtYmVyPwogIF8uaXNGaW5pdGUgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gaXNGaW5pdGUob2JqKSAmJiAhaXNOYU4ocGFyc2VGbG9hdChvYmopKTsKICB9OwogIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KICBfLmlzTmFOID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIF8uaXNOdW1iZXIob2JqKSAmJiBvYmogIT0gK29iajsKICB9OwogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdHJ1ZSB8fCBvYmogPT09IGZhbHNlIHx8IHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBCb29sZWFuXSc7CiAgfTsKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGVxdWFsIHRvIG51bGw/CiAgXy5pc051bGwgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSBudWxsOwogIH07CiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CiAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBvYmogPT09IHZvaWQgMDsKICB9OwogIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKICAvLyBvbiBpdHNlbGYgKGluIG90aGVyIHdvcmRzLCBub3Qgb24gYSBwcm90b3R5cGUpLgogIF8uaGFzID0gZnVuY3Rpb24gKG9iaiwga2V5KSB7CiAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSk7CiAgfTsKICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tCiAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwogIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICByb290Ll8gPSBwcmV2aW91c1VuZGVyc2NvcmU7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRvcnMuCiAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH07CiAgXy5jb25zdGFudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICB9OwogIF8ucHJvcGVydHkgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKG9iaikgewogICAgICByZXR1cm4gb2JqW2tleV07CiAgICB9OwogIH07CiAgLy8gUmV0dXJucyBhIHByZWRpY2F0ZSBmb3IgY2hlY2tpbmcgd2hldGhlciBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gc2V0IG9mIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8ubWF0Y2hlcyA9IGZ1bmN0aW9uIChhdHRycykgewogICAgcmV0dXJuIGZ1bmN0aW9uIChvYmopIHsKICAgICAgaWYgKG9iaiA9PT0gYXR0cnMpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIC8vYXZvaWQgY29tcGFyaW5nIGFuIG9iamVjdCB0byBpdHNlbGYuCiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgIGlmIChhdHRyc1trZXldICE9PSBvYmpba2V5XSkKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CiAgfTsKICAvLyBSdW4gYSBmdW5jdGlvbiAqKm4qKiB0aW1lcy4KICBfLnRpbWVzID0gZnVuY3Rpb24gKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgYWNjdW0gPSBBcnJheShNYXRoLm1heCgwLCBuKSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykKICAgICAgYWNjdW1baV0gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGkpOwogICAgcmV0dXJuIGFjY3VtOwogIH07CiAgLy8gUmV0dXJuIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS4KICBfLnJhbmRvbSA9IGZ1bmN0aW9uIChtaW4sIG1heCkgewogICAgaWYgKG1heCA9PSBudWxsKSB7CiAgICAgIG1heCA9IG1pbjsKICAgICAgbWluID0gMDsKICAgIH0KICAgIHJldHVybiBtaW4gKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpOwogIH07CiAgLy8gQSAocG9zc2libHkgZmFzdGVyKSB3YXkgdG8gZ2V0IHRoZSBjdXJyZW50IHRpbWVzdGFtcCBhcyBhbiBpbnRlZ2VyLgogIF8ubm93ID0gRGF0ZS5ub3cgfHwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIH07CiAgLy8gTGlzdCBvZiBIVE1MIGVudGl0aWVzIGZvciBlc2NhcGluZy4KICB2YXIgZW50aXR5TWFwID0gewogICAgZXNjYXBlOiB7CiAgICAgICcmJzogJyZhbXA7JywKICAgICAgJzwnOiAnJmx0OycsCiAgICAgICc+JzogJyZndDsnLAogICAgICAnIic6ICcmcXVvdDsnLAogICAgICAnXCcnOiAnJiN4Mjc7JwogICAgfQogIH07CiAgZW50aXR5TWFwLnVuZXNjYXBlID0gXy5pbnZlcnQoZW50aXR5TWFwLmVzY2FwZSk7CiAgLy8gUmVnZXhlcyBjb250YWluaW5nIHRoZSBrZXlzIGFuZCB2YWx1ZXMgbGlzdGVkIGltbWVkaWF0ZWx5IGFib3ZlLgogIHZhciBlbnRpdHlSZWdleGVzID0gewogICAgZXNjYXBlOiBuZXcgUmVnRXhwKCdbJyArIF8ua2V5cyhlbnRpdHlNYXAuZXNjYXBlKS5qb2luKCcnKSArICddJywgJ2cnKSwKICAgIHVuZXNjYXBlOiBuZXcgUmVnRXhwKCcoJyArIF8ua2V5cyhlbnRpdHlNYXAudW5lc2NhcGUpLmpvaW4oJ3wnKSArICcpJywgJ2cnKQogIH07CiAgLy8gRnVuY3Rpb25zIGZvciBlc2NhcGluZyBhbmQgdW5lc2NhcGluZyBzdHJpbmdzIHRvL2Zyb20gSFRNTCBpbnRlcnBvbGF0aW9uLgogIF8uZWFjaChbCiAgICAnZXNjYXBlJywKICAgICd1bmVzY2FwZScKICBdLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICBfW21ldGhvZF0gPSBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgIGlmIChzdHJpbmcgPT0gbnVsbCkKICAgICAgICByZXR1cm4gJyc7CiAgICAgIHJldHVybiAoJycgKyBzdHJpbmcpLnJlcGxhY2UoZW50aXR5UmVnZXhlc1ttZXRob2RdLCBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICByZXR1cm4gZW50aXR5TWFwW21ldGhvZF1bbWF0Y2hdOwogICAgICB9KTsKICAgIH07CiAgfSk7CiAgLy8gSWYgdGhlIHZhbHVlIG9mIHRoZSBuYW1lZCBgcHJvcGVydHlgIGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQgd2l0aCB0aGUKICAvLyBgb2JqZWN0YCBhcyBjb250ZXh0OyBvdGhlcndpc2UsIHJldHVybiBpdC4KICBfLnJlc3VsdCA9IGZ1bmN0aW9uIChvYmplY3QsIHByb3BlcnR5KSB7CiAgICBpZiAob2JqZWN0ID09IG51bGwpCiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB2YXIgdmFsdWUgPSBvYmplY3RbcHJvcGVydHldOwogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZS5jYWxsKG9iamVjdCkgOiB2YWx1ZTsKICB9OwogIC8vIEFkZCB5b3VyIG93biBjdXN0b20gZnVuY3Rpb25zIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm1peGluID0gZnVuY3Rpb24gKG9iaikgewogICAgZWFjaChfLmZ1bmN0aW9ucyhvYmopLCBmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgZnVuYyA9IF9bbmFtZV0gPSBvYmpbbmFtZV07CiAgICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX3dyYXBwZWRdOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CiAgICAgIH07CiAgICB9KTsKICB9OwogIC8vIEdlbmVyYXRlIGEgdW5pcXVlIGludGVnZXIgaWQgKHVuaXF1ZSB3aXRoaW4gdGhlIGVudGlyZSBjbGllbnQgc2Vzc2lvbikuCiAgLy8gVXNlZnVsIGZvciB0ZW1wb3JhcnkgRE9NIGlkcy4KICB2YXIgaWRDb3VudGVyID0gMDsKICBfLnVuaXF1ZUlkID0gZnVuY3Rpb24gKHByZWZpeCkgewogICAgdmFyIGlkID0gKytpZENvdW50ZXIgKyAnJzsKICAgIHJldHVybiBwcmVmaXggPyBwcmVmaXggKyBpZCA6IGlkOwogIH07CiAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCiAgLy8gZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgIGV2YWx1YXRlOiAvPCUoW1xzXFNdKz8pJT4vZywKICAgIGludGVycG9sYXRlOiAvPCU9KFtcc1xTXSs/KSU+L2csCiAgICBlc2NhcGU6IC88JS0oW1xzXFNdKz8pJT4vZwogIH07CiAgLy8gV2hlbiBjdXN0b21pemluZyBgdGVtcGxhdGVTZXR0aW5nc2AsIGlmIHlvdSBkb24ndCB3YW50IHRvIGRlZmluZSBhbgogIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KICB2YXIgbm9NYXRjaCA9IC8oLileLzsKICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQogIC8vIHN0cmluZyBsaXRlcmFsLgogIHZhciBlc2NhcGVzID0gewogICAgJ1wnJzogJ1wnJywKICAgICdcXCc6ICdcXCcsCiAgICAnXHInOiAncicsCiAgICAnXG4nOiAnbicsCiAgICAnXHQnOiAndCcsCiAgICAnXHUyMDI4JzogJ3UyMDI4JywKICAgICdcdTIwMjknOiAndTIwMjknCiAgfTsKICB2YXIgZXNjYXBlciA9IC9cXHwnfFxyfFxufFx0fFx1MjAyOHxcdTIwMjkvZzsKICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgogIC8vIFVuZGVyc2NvcmUgdGVtcGxhdGluZyBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMgd2hpdGVzcGFjZSwKICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24gKHRleHQsIGRhdGEsIHNldHRpbmdzKSB7CiAgICB2YXIgcmVuZGVyOwogICAgc2V0dGluZ3MgPSBfLmRlZmF1bHRzKHt9LCBzZXR0aW5ncywgXy50ZW1wbGF0ZVNldHRpbmdzKTsKICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlIHNvdXJjZSwgZXNjYXBpbmcgc3RyaW5nIGxpdGVyYWxzIGFwcHJvcHJpYXRlbHkuCiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNvdXJjZSA9ICdfX3ArPVwnJzsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbiAobWF0Y2gsIGVzY2FwZSwgaW50ZXJwb2xhdGUsIGV2YWx1YXRlLCBvZmZzZXQpIHsKICAgICAgc291cmNlICs9IHRleHQuc2xpY2UoaW5kZXgsIG9mZnNldCkucmVwbGFjZShlc2NhcGVyLCBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICByZXR1cm4gJ1xcJyArIGVzY2FwZXNbbWF0Y2hdOwogICAgICB9KTsKICAgICAgaWYgKGVzY2FwZSkgewogICAgICAgIHNvdXJjZSArPSAnXCcrXG4oKF9fdD0oJyArIGVzY2FwZSArICcpKT09bnVsbD9cJ1wnOl8uZXNjYXBlKF9fdCkpK1xuXCcnOwogICAgICB9CiAgICAgIGlmIChpbnRlcnBvbGF0ZSkgewogICAgICAgIHNvdXJjZSArPSAnXCcrXG4oKF9fdD0oJyArIGludGVycG9sYXRlICsgJykpPT1udWxsP1wnXCc6X190KStcblwnJzsKICAgICAgfQogICAgICBpZiAoZXZhbHVhdGUpIHsKICAgICAgICBzb3VyY2UgKz0gJ1wnO1xuJyArIGV2YWx1YXRlICsgJ1xuX19wKz1cJyc7CiAgICAgIH0KICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwogICAgc291cmNlICs9ICdcJztcbic7CiAgICAvLyBJZiBhIHZhcmlhYmxlIGlzIG5vdCBzcGVjaWZpZWQsIHBsYWNlIGRhdGEgdmFsdWVzIGluIGxvY2FsIHNjb3BlLgogICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkKICAgICAgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CiAgICBzb3VyY2UgPSAndmFyIF9fdCxfX3A9XCdcJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sJyArICdwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLFwnXCcpO307XG4nICsgc291cmNlICsgJ3JldHVybiBfX3A7XG4nOwogICAgdHJ5IHsKICAgICAgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICB0aHJvdyBlOwogICAgfQogICAgaWYgKGRhdGEpCiAgICAgIHJldHVybiByZW5kZXIoZGF0YSwgXyk7CiAgICB2YXIgdGVtcGxhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwogICAgLy8gUHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24gc291cmNlIGFzIGEgY29udmVuaWVuY2UgZm9yIHByZWNvbXBpbGF0aW9uLgogICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyAoc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicpICsgJyl7XG4nICsgc291cmNlICsgJ30nOwogICAgcmV0dXJuIHRlbXBsYXRlOwogIH07CiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbiwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSB0byB0aGUgd3JhcHBlci4KICBfLmNoYWluID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIF8ob2JqKS5jaGFpbigpOwogIH07CiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnRpbnVlIGNoYWluaW5nIGludGVybWVkaWF0ZSByZXN1bHRzLgogIHZhciByZXN1bHQgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwogIC8vIEFkZCBhbGwgb2YgdGhlIFVuZGVyc2NvcmUgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyIG9iamVjdC4KICBfLm1peGluKF8pOwogIC8vIEFkZCBhbGwgbXV0YXRvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbCiAgICAncG9wJywKICAgICdwdXNoJywKICAgICdyZXZlcnNlJywKICAgICdzaGlmdCcsCiAgICAnc29ydCcsCiAgICAnc3BsaWNlJywKICAgICd1bnNoaWZ0JwogIF0sIGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fd3JhcHBlZDsKICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKICAgICAgaWYgKChuYW1lID09ICdzaGlmdCcgfHwgbmFtZSA9PSAnc3BsaWNlJykgJiYgb2JqLmxlbmd0aCA9PT0gMCkKICAgICAgICBkZWxldGUgb2JqWzBdOwogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgb2JqKTsKICAgIH07CiAgfSk7CiAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbCiAgICAnY29uY2F0JywKICAgICdqb2luJywKICAgICdzbGljZScKICBdLCBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CiAgXy5leHRlbmQoXy5wcm90b3R5cGUsIHsKICAgIC8vIFN0YXJ0IGNoYWluaW5nIGEgd3JhcHBlZCBVbmRlcnNjb3JlIG9iamVjdC4KICAgIGNoYWluOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX2NoYWluID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gRXh0cmFjdHMgdGhlIHJlc3VsdCBmcm9tIGEgd3JhcHBlZCBhbmQgY2hhaW5lZCBvYmplY3QuCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICAgIH0KICB9KTsKICAvLyBBTUQgcmVnaXN0cmF0aW9uIGhhcHBlbnMgYXQgdGhlIGVuZCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIEFNRCBsb2FkZXJzCiAgLy8gdGhhdCBtYXkgbm90IGVuZm9yY2UgbmV4dC10dXJuIHNlbWFudGljcyBvbiBtb2R1bGVzLiBFdmVuIHRob3VnaCBnZW5lcmFsCiAgLy8gcHJhY3RpY2UgZm9yIEFNRCByZWdpc3RyYXRpb24gaXMgdG8gYmUgYW5vbnltb3VzLCB1bmRlcnNjb3JlIHJlZ2lzdGVycwogIC8vIGFzIGEgbmFtZWQgbW9kdWxlIGJlY2F1c2UsIGxpa2UgalF1ZXJ5LCBpdCBpcyBhIGJhc2UgbGlicmFyeSB0aGF0IGlzCiAgLy8gcG9wdWxhciBlbm91Z2ggdG8gYmUgYnVuZGxlZCBpbiBhIHRoaXJkIHBhcnR5IGxpYiwgYnV0IG5vdCBiZSBwYXJ0IG9mCiAgLy8gYW4gQU1EIGxvYWQgcmVxdWVzdC4gVGhvc2UgY2FzZXMgY291bGQgZ2VuZXJhdGUgYW4gZXJyb3Igd2hlbiBhbgogIC8vIGFub255bW91cyBkZWZpbmUoKSBpcyBjYWxsZWQgb3V0c2lkZSBvZiBhIGxvYWRlciByZXF1ZXN0LgogIGlmICh0cnVlKSB7CiAgICB1bmRlcnNjb3JlID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gXzsKICAgIH0oKTsKICB9Cn0uY2FsbCh0aGlzKSk7Ci8qIQogKiBqUXVlcnkgSmF2YVNjcmlwdCBMaWJyYXJ5IHYyLjEuMQogKiBodHRwOi8vanF1ZXJ5LmNvbS8KICoKICogSW5jbHVkZXMgU2l6emxlLmpzCiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqCiAqIENvcHlyaWdodCAyMDA1LCAyMDE0IGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogRGF0ZTogMjAxNC0wNS0wMVQxNzoxMVoKICovCihmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CiAgaWYgKHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUuZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKICAgIC8vIEZvciBDb21tb25KUyBhbmQgQ29tbW9uSlMtbGlrZSBlbnZpcm9ubWVudHMgd2hlcmUgYSBwcm9wZXIgd2luZG93IGlzIHByZXNlbnQsCiAgICAvLyBleGVjdXRlIHRoZSBmYWN0b3J5IGFuZCBnZXQgalF1ZXJ5CiAgICAvLyBGb3IgZW52aXJvbm1lbnRzIHRoYXQgZG8gbm90IGluaGVyZW50bHkgcG9zc2VzIGEgd2luZG93IHdpdGggYSBkb2N1bWVudAogICAgLy8gKHN1Y2ggYXMgTm9kZS5qcyksIGV4cG9zZSBhIGpRdWVyeS1tYWtpbmcgZmFjdG9yeSBhcyBtb2R1bGUuZXhwb3J0cwogICAgLy8gVGhpcyBhY2NlbnR1YXRlcyB0aGUgbmVlZCBmb3IgdGhlIGNyZWF0aW9uIG9mIGEgcmVhbCB3aW5kb3cKICAgIC8vIGUuZy4gdmFyIGpRdWVyeSA9IHJlcXVpcmUoImpxdWVyeSIpKHdpbmRvdyk7CiAgICAvLyBTZWUgdGlja2V0ICMxNDU0OSBmb3IgbW9yZSBpbmZvCiAgICBtb2R1bGUuZXhwb3J0cyA9IGdsb2JhbC5kb2N1bWVudCA/IGZhY3RvcnkoZ2xvYmFsLCB0cnVlKSA6IGZ1bmN0aW9uICh3KSB7CiAgICAgIGlmICghdy5kb2N1bWVudCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignalF1ZXJ5IHJlcXVpcmVzIGEgd2luZG93IHdpdGggYSBkb2N1bWVudCcpOwogICAgICB9CiAgICAgIHJldHVybiBmYWN0b3J5KHcpOwogICAgfTsKICB9IGVsc2UgewogICAgZmFjdG9yeShnbG9iYWwpOwogIH0gIC8vIFBhc3MgdGhpcyBpZiB3aW5kb3cgaXMgbm90IGRlZmluZWQgeWV0Cn0odHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgPyB3aW5kb3cgOiB0aGlzLCBmdW5jdGlvbiAod2luZG93LCBub0dsb2JhbCkgewogIC8vIENhbid0IGRvIHRoaXMgYmVjYXVzZSBzZXZlcmFsIGFwcHMgaW5jbHVkaW5nIEFTUC5ORVQgdHJhY2UKICAvLyB0aGUgc3RhY2sgdmlhIGFyZ3VtZW50cy5jYWxsZXIuY2FsbGVlIGFuZCBGaXJlZm94IGRpZXMgaWYKICAvLyB5b3UgdHJ5IHRvIHRyYWNlIHRocm91Z2ggInVzZSBzdHJpY3QiIGNhbGwgY2hhaW5zLiAoIzEzMzM1KQogIC8vIFN1cHBvcnQ6IEZpcmVmb3ggMTgrCiAgLy8KICB2YXIgYXJyID0gW107CiAgdmFyIHNsaWNlID0gYXJyLnNsaWNlOwogIHZhciBjb25jYXQgPSBhcnIuY29uY2F0OwogIHZhciBwdXNoID0gYXJyLnB1c2g7CiAgdmFyIGluZGV4T2YgPSBhcnIuaW5kZXhPZjsKICB2YXIgY2xhc3MydHlwZSA9IHt9OwogIHZhciB0b1N0cmluZyA9IGNsYXNzMnR5cGUudG9TdHJpbmc7CiAgdmFyIGhhc093biA9IGNsYXNzMnR5cGUuaGFzT3duUHJvcGVydHk7CiAgdmFyIHN1cHBvcnQgPSB7fTsKICB2YXIKICAgIC8vIFVzZSB0aGUgY29ycmVjdCBkb2N1bWVudCBhY2NvcmRpbmdseSB3aXRoIHdpbmRvdyBhcmd1bWVudCAoc2FuZGJveCkKICAgIGRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50LCB2ZXJzaW9uID0gJzIuMS4xJywKICAgIC8vIERlZmluZSBhIGxvY2FsIGNvcHkgb2YgalF1ZXJ5CiAgICBqUXVlcnkgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgLy8gVGhlIGpRdWVyeSBvYmplY3QgaXMgYWN0dWFsbHkganVzdCB0aGUgaW5pdCBjb25zdHJ1Y3RvciAnZW5oYW5jZWQnCiAgICAgIC8vIE5lZWQgaW5pdCBpZiBqUXVlcnkgaXMgY2FsbGVkIChqdXN0IGFsbG93IGVycm9yIHRvIGJlIHRocm93biBpZiBub3QgaW5jbHVkZWQpCiAgICAgIHJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoc2VsZWN0b3IsIGNvbnRleHQpOwogICAgfSwKICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQ8NC4xCiAgICAvLyBNYWtlIHN1cmUgd2UgdHJpbSBCT00gYW5kIE5CU1AKICAgIHJ0cmltID0gL15bXHNcdUZFRkZceEEwXSt8W1xzXHVGRUZGXHhBMF0rJC9nLAogICAgLy8gTWF0Y2hlcyBkYXNoZWQgc3RyaW5nIGZvciBjYW1lbGl6aW5nCiAgICBybXNQcmVmaXggPSAvXi1tcy0vLCByZGFzaEFscGhhID0gLy0oW1xkYS16XSkvZ2ksCiAgICAvLyBVc2VkIGJ5IGpRdWVyeS5jYW1lbENhc2UgYXMgY2FsbGJhY2sgdG8gcmVwbGFjZSgpCiAgICBmY2FtZWxDYXNlID0gZnVuY3Rpb24gKGFsbCwgbGV0dGVyKSB7CiAgICAgIHJldHVybiBsZXR0ZXIudG9VcHBlckNhc2UoKTsKICAgIH07CiAgalF1ZXJ5LmZuID0galF1ZXJ5LnByb3RvdHlwZSA9IHsKICAgIC8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKICAgIGpxdWVyeTogdmVyc2lvbiwKICAgIGNvbnN0cnVjdG9yOiBqUXVlcnksCiAgICAvLyBTdGFydCB3aXRoIGFuIGVtcHR5IHNlbGVjdG9yCiAgICBzZWxlY3RvcjogJycsCiAgICAvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDAKICAgIGxlbmd0aDogMCwKICAgIHRvQXJyYXk6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHNsaWNlLmNhbGwodGhpcyk7CiAgICB9LAogICAgLy8gR2V0IHRoZSBOdGggZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldCBPUgogICAgLy8gR2V0IHRoZSB3aG9sZSBtYXRjaGVkIGVsZW1lbnQgc2V0IGFzIGEgY2xlYW4gYXJyYXkKICAgIGdldDogZnVuY3Rpb24gKG51bSkgewogICAgICByZXR1cm4gbnVtICE9IG51bGwgPyBudW0gPCAwID8gdGhpc1tudW0gKyB0aGlzLmxlbmd0aF0gOiB0aGlzW251bV0gOiAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBpbiBhIGNsZWFuIGFycmF5CiAgICAgIHNsaWNlLmNhbGwodGhpcyk7CiAgICB9LAogICAgLy8gVGFrZSBhbiBhcnJheSBvZiBlbGVtZW50cyBhbmQgcHVzaCBpdCBvbnRvIHRoZSBzdGFjawogICAgLy8gKHJldHVybmluZyB0aGUgbmV3IG1hdGNoZWQgZWxlbWVudCBzZXQpCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uIChlbGVtcykgewogICAgICAvLyBCdWlsZCBhIG5ldyBqUXVlcnkgbWF0Y2hlZCBlbGVtZW50IHNldAogICAgICB2YXIgcmV0ID0galF1ZXJ5Lm1lcmdlKHRoaXMuY29uc3RydWN0b3IoKSwgZWxlbXMpOwogICAgICAvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQogICAgICByZXQucHJldk9iamVjdCA9IHRoaXM7CiAgICAgIHJldC5jb250ZXh0ID0gdGhpcy5jb250ZXh0OwogICAgICAvLyBSZXR1cm4gdGhlIG5ld2x5LWZvcm1lZCBlbGVtZW50IHNldAogICAgICByZXR1cm4gcmV0OwogICAgfSwKICAgIC8vIEV4ZWN1dGUgYSBjYWxsYmFjayBmb3IgZXZlcnkgZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBzZXQuCiAgICAvLyAoWW91IGNhbiBzZWVkIHRoZSBhcmd1bWVudHMgd2l0aCBhbiBhcnJheSBvZiBhcmdzLCBidXQgdGhpcyBpcwogICAgLy8gb25seSB1c2VkIGludGVybmFsbHkuKQogICAgZWFjaDogZnVuY3Rpb24gKGNhbGxiYWNrLCBhcmdzKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZWFjaCh0aGlzLCBjYWxsYmFjaywgYXJncyk7CiAgICB9LAogICAgbWFwOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbChlbGVtLCBpLCBlbGVtKTsKICAgICAgfSkpOwogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0sCiAgICBmaXJzdDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5lcSgwKTsKICAgIH0sCiAgICBsYXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmVxKC0xKTsKICAgIH0sCiAgICBlcTogZnVuY3Rpb24gKGkpIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoLCBqID0gK2kgKyAoaSA8IDAgPyBsZW4gOiAwKTsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGogPj0gMCAmJiBqIDwgbGVuID8gW3RoaXNbal1dIDogW10pOwogICAgfSwKICAgIGVuZDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5wcmV2T2JqZWN0IHx8IHRoaXMuY29uc3RydWN0b3IobnVsbCk7CiAgICB9LAogICAgLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgogICAgLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCiAgICBwdXNoOiBwdXNoLAogICAgc29ydDogYXJyLnNvcnQsCiAgICBzcGxpY2U6IGFyci5zcGxpY2UKICB9OwogIGpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIG9wdGlvbnMsIG5hbWUsIHNyYywgY29weSwgY29weUlzQXJyYXksIGNsb25lLCB0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sIGkgPSAxLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLCBkZWVwID0gZmFsc2U7CiAgICAvLyBIYW5kbGUgYSBkZWVwIGNvcHkgc2l0dWF0aW9uCiAgICBpZiAodHlwZW9mIHRhcmdldCA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgIGRlZXAgPSB0YXJnZXQ7CiAgICAgIC8vIHNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKICAgICAgdGFyZ2V0ID0gYXJndW1lbnRzW2ldIHx8IHt9OwogICAgICBpKys7CiAgICB9CiAgICAvLyBIYW5kbGUgY2FzZSB3aGVuIHRhcmdldCBpcyBhIHN0cmluZyBvciBzb21ldGhpbmcgKHBvc3NpYmxlIGluIGRlZXAgY29weSkKICAgIGlmICh0eXBlb2YgdGFyZ2V0ICE9PSAnb2JqZWN0JyAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24odGFyZ2V0KSkgewogICAgICB0YXJnZXQgPSB7fTsKICAgIH0KICAgIC8vIGV4dGVuZCBqUXVlcnkgaXRzZWxmIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAogICAgaWYgKGkgPT09IGxlbmd0aCkgewogICAgICB0YXJnZXQgPSB0aGlzOwogICAgICBpLS07CiAgICB9CiAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIC8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKICAgICAgaWYgKChvcHRpb25zID0gYXJndW1lbnRzW2ldKSAhPSBudWxsKSB7CiAgICAgICAgLy8gRXh0ZW5kIHRoZSBiYXNlIG9iamVjdAogICAgICAgIGZvciAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgICAgICBzcmMgPSB0YXJnZXRbbmFtZV07CiAgICAgICAgICBjb3B5ID0gb3B0aW9uc1tuYW1lXTsKICAgICAgICAgIC8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3AKICAgICAgICAgIGlmICh0YXJnZXQgPT09IGNvcHkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgcGxhaW4gb2JqZWN0cyBvciBhcnJheXMKICAgICAgICAgIGlmIChkZWVwICYmIGNvcHkgJiYgKGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvcHkpIHx8IChjb3B5SXNBcnJheSA9IGpRdWVyeS5pc0FycmF5KGNvcHkpKSkpIHsKICAgICAgICAgICAgaWYgKGNvcHlJc0FycmF5KSB7CiAgICAgICAgICAgICAgY29weUlzQXJyYXkgPSBmYWxzZTsKICAgICAgICAgICAgICBjbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNBcnJheShzcmMpID8gc3JjIDogW107CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSA/IHNyYyA6IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQogICAgICAgICAgICB0YXJnZXRbbmFtZV0gPSBqUXVlcnkuZXh0ZW5kKGRlZXAsIGNsb25lLCBjb3B5KTsgIC8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMKICAgICAgICAgIH0gZWxzZSBpZiAoY29weSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IGNvcHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAogICAgcmV0dXJuIHRhcmdldDsKICB9OwogIGpRdWVyeS5leHRlbmQoewogICAgLy8gVW5pcXVlIGZvciBlYWNoIGNvcHkgb2YgalF1ZXJ5IG9uIHRoZSBwYWdlCiAgICBleHBhbmRvOiAnalF1ZXJ5JyArICh2ZXJzaW9uICsgTWF0aC5yYW5kb20oKSkucmVwbGFjZSgvXEQvZywgJycpLAogICAgLy8gQXNzdW1lIGpRdWVyeSBpcyByZWFkeSB3aXRob3V0IHRoZSByZWFkeSBtb2R1bGUKICAgIGlzUmVhZHk6IHRydWUsCiAgICBlcnJvcjogZnVuY3Rpb24gKG1zZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgIH0sCiAgICBub29wOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gU2VlIHRlc3QvdW5pdC9jb3JlLmpzIGZvciBkZXRhaWxzIGNvbmNlcm5pbmcgaXNGdW5jdGlvbi4KICAgIC8vIFNpbmNlIHZlcnNpb24gMS4zLCBET00gbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGxpa2UgYWxlcnQKICAgIC8vIGFyZW4ndCBzdXBwb3J0ZWQuIFRoZXkgcmV0dXJuIGZhbHNlIG9uIElFICgjMjk2OCkuCiAgICBpc0Z1bmN0aW9uOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAnZnVuY3Rpb24nOwogICAgfSwKICAgIGlzQXJyYXk6IEFycmF5LmlzQXJyYXksCiAgICBpc1dpbmRvdzogZnVuY3Rpb24gKG9iaikgewogICAgICByZXR1cm4gb2JqICE9IG51bGwgJiYgb2JqID09PSBvYmoud2luZG93OwogICAgfSwKICAgIGlzTnVtZXJpYzogZnVuY3Rpb24gKG9iaikgewogICAgICAvLyBwYXJzZUZsb2F0IE5hTnMgbnVtZXJpYy1jYXN0IGZhbHNlIHBvc2l0aXZlcyAobnVsbHx0cnVlfGZhbHNlfCIiKQogICAgICAvLyAuLi5idXQgbWlzaW50ZXJwcmV0cyBsZWFkaW5nLW51bWJlciBzdHJpbmdzLCBwYXJ0aWN1bGFybHkgaGV4IGxpdGVyYWxzICgiMHguLi4iKQogICAgICAvLyBzdWJ0cmFjdGlvbiBmb3JjZXMgaW5maW5pdGllcyB0byBOYU4KICAgICAgcmV0dXJuICFqUXVlcnkuaXNBcnJheShvYmopICYmIG9iaiAtIHBhcnNlRmxvYXQob2JqKSA+PSAwOwogICAgfSwKICAgIGlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgLy8gTm90IHBsYWluIG9iamVjdHM6CiAgICAgIC8vIC0gQW55IG9iamVjdCBvciB2YWx1ZSB3aG9zZSBpbnRlcm5hbCBbW0NsYXNzXV0gcHJvcGVydHkgaXMgbm90ICJbb2JqZWN0IE9iamVjdF0iCiAgICAgIC8vIC0gRE9NIG5vZGVzCiAgICAgIC8vIC0gd2luZG93CiAgICAgIGlmIChqUXVlcnkudHlwZShvYmopICE9PSAnb2JqZWN0JyB8fCBvYmoubm9kZVR5cGUgfHwgalF1ZXJ5LmlzV2luZG93KG9iaikpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciAmJiAhaGFzT3duLmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgJ2lzUHJvdG90eXBlT2YnKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBJZiB0aGUgZnVuY3Rpb24gaGFzbid0IHJldHVybmVkIGFscmVhZHksIHdlJ3JlIGNvbmZpZGVudCB0aGF0CiAgICAgIC8vIHxvYmp8IGlzIGEgcGxhaW4gb2JqZWN0LCBjcmVhdGVkIGJ5IHt9IG9yIGNvbnN0cnVjdGVkIHdpdGggbmV3IE9iamVjdAogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICBpc0VtcHR5T2JqZWN0OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHZhciBuYW1lOwogICAgICBmb3IgKG5hbWUgaW4gb2JqKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIHR5cGU6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIG9iaiArICcnOwogICAgICB9CiAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPCA0LjAsIGlPUyA8IDYgKGZ1bmN0aW9uaXNoIFJlZ0V4cCkKICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicgPyBjbGFzczJ0eXBlW3RvU3RyaW5nLmNhbGwob2JqKV0gfHwgJ29iamVjdCcgOiB0eXBlb2Ygb2JqOwogICAgfSwKICAgIC8vIEV2YWx1YXRlcyBhIHNjcmlwdCBpbiBhIGdsb2JhbCBjb250ZXh0CiAgICBnbG9iYWxFdmFsOiBmdW5jdGlvbiAoY29kZSkgewogICAgICB2YXIgc2NyaXB0LCBpbmRpcmVjdCA9IGV2YWw7CiAgICAgIGNvZGUgPSBqUXVlcnkudHJpbShjb2RlKTsKICAgICAgaWYgKGNvZGUpIHsKICAgICAgICAvLyBJZiB0aGUgY29kZSBpbmNsdWRlcyBhIHZhbGlkLCBwcm9sb2d1ZSBwb3NpdGlvbgogICAgICAgIC8vIHN0cmljdCBtb2RlIHByYWdtYSwgZXhlY3V0ZSBjb2RlIGJ5IGluamVjdGluZyBhCiAgICAgICAgLy8gc2NyaXB0IHRhZyBpbnRvIHRoZSBkb2N1bWVudC4KICAgICAgICBpZiAoY29kZS5pbmRleE9mKCd1c2Ugc3RyaWN0JykgPT09IDEpIHsKICAgICAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogICAgICAgICAgc2NyaXB0LnRleHQgPSBjb2RlOwogICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gT3RoZXJ3aXNlLCBhdm9pZCB0aGUgRE9NIG5vZGUgY3JlYXRpb24sIGluc2VydGlvbgogICAgICAgICAgLy8gYW5kIHJlbW92YWwgYnkgdXNpbmcgYW4gaW5kaXJlY3QgZ2xvYmFsIGV2YWwKICAgICAgICAgIGluZGlyZWN0KGNvZGUpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIC8vIENvbnZlcnQgZGFzaGVkIHRvIGNhbWVsQ2FzZTsgdXNlZCBieSB0aGUgY3NzIGFuZCBkYXRhIG1vZHVsZXMKICAgIC8vIE1pY3Jvc29mdCBmb3Jnb3QgdG8gaHVtcCB0aGVpciB2ZW5kb3IgcHJlZml4ICgjOTU3MikKICAgIGNhbWVsQ2FzZTogZnVuY3Rpb24gKHN0cmluZykgewogICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2Uocm1zUHJlZml4LCAnbXMtJykucmVwbGFjZShyZGFzaEFscGhhLCBmY2FtZWxDYXNlKTsKICAgIH0sCiAgICBub2RlTmFtZTogZnVuY3Rpb24gKGVsZW0sIG5hbWUpIHsKICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICB9LAogICAgLy8gYXJncyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQogICAgZWFjaDogZnVuY3Rpb24gKG9iaiwgY2FsbGJhY2ssIGFyZ3MpIHsKICAgICAgdmFyIHZhbHVlLCBpID0gMCwgbGVuZ3RoID0gb2JqLmxlbmd0aCwgaXNBcnJheSA9IGlzQXJyYXlsaWtlKG9iaik7CiAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgaWYgKGlzQXJyYXkpIHsKICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsdWUgPSBjYWxsYmFjay5hcHBseShvYmpbaV0sIGFyZ3MpOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpIGluIG9iaikgewogICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KG9ialtpXSwgYXJncyk7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gIC8vIEEgc3BlY2lhbCwgZmFzdCwgY2FzZSBmb3IgdGhlIG1vc3QgY29tbW9uIHVzZSBvZiBlYWNoCiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzQXJyYXkpIHsKICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsdWUgPSBjYWxsYmFjay5jYWxsKG9ialtpXSwgaSwgb2JqW2ldKTsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaSBpbiBvYmopIHsKICAgICAgICAgICAgdmFsdWUgPSBjYWxsYmFjay5jYWxsKG9ialtpXSwgaSwgb2JqW2ldKTsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvYmo7CiAgICB9LAogICAgLy8gU3VwcG9ydDogQW5kcm9pZDw0LjEKICAgIHRyaW06IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgIHJldHVybiB0ZXh0ID09IG51bGwgPyAnJyA6ICh0ZXh0ICsgJycpLnJlcGxhY2UocnRyaW0sICcnKTsKICAgIH0sCiAgICAvLyByZXN1bHRzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgICBtYWtlQXJyYXk6IGZ1bmN0aW9uIChhcnIsIHJlc3VsdHMpIHsKICAgICAgdmFyIHJldCA9IHJlc3VsdHMgfHwgW107CiAgICAgIGlmIChhcnIgIT0gbnVsbCkgewogICAgICAgIGlmIChpc0FycmF5bGlrZShPYmplY3QoYXJyKSkpIHsKICAgICAgICAgIGpRdWVyeS5tZXJnZShyZXQsIHR5cGVvZiBhcnIgPT09ICdzdHJpbmcnID8gW2Fycl0gOiBhcnIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwdXNoLmNhbGwocmV0LCBhcnIpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmV0OwogICAgfSwKICAgIGluQXJyYXk6IGZ1bmN0aW9uIChlbGVtLCBhcnIsIGkpIHsKICAgICAgcmV0dXJuIGFyciA9PSBudWxsID8gLTEgOiBpbmRleE9mLmNhbGwoYXJyLCBlbGVtLCBpKTsKICAgIH0sCiAgICBtZXJnZTogZnVuY3Rpb24gKGZpcnN0LCBzZWNvbmQpIHsKICAgICAgdmFyIGxlbiA9ICtzZWNvbmQubGVuZ3RoLCBqID0gMCwgaSA9IGZpcnN0Lmxlbmd0aDsKICAgICAgZm9yICg7IGogPCBsZW47IGorKykgewogICAgICAgIGZpcnN0W2krK10gPSBzZWNvbmRbal07CiAgICAgIH0KICAgICAgZmlyc3QubGVuZ3RoID0gaTsKICAgICAgcmV0dXJuIGZpcnN0OwogICAgfSwKICAgIGdyZXA6IGZ1bmN0aW9uIChlbGVtcywgY2FsbGJhY2ssIGludmVydCkgewogICAgICB2YXIgY2FsbGJhY2tJbnZlcnNlLCBtYXRjaGVzID0gW10sIGkgPSAwLCBsZW5ndGggPSBlbGVtcy5sZW5ndGgsIGNhbGxiYWNrRXhwZWN0ID0gIWludmVydDsKICAgICAgLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIG9ubHkgc2F2aW5nIHRoZSBpdGVtcwogICAgICAvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgogICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgY2FsbGJhY2tJbnZlcnNlID0gIWNhbGxiYWNrKGVsZW1zW2ldLCBpKTsKICAgICAgICBpZiAoY2FsbGJhY2tJbnZlcnNlICE9PSBjYWxsYmFja0V4cGVjdCkgewogICAgICAgICAgbWF0Y2hlcy5wdXNoKGVsZW1zW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoZXM7CiAgICB9LAogICAgLy8gYXJnIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgICBtYXA6IGZ1bmN0aW9uIChlbGVtcywgY2FsbGJhY2ssIGFyZykgewogICAgICB2YXIgdmFsdWUsIGkgPSAwLCBsZW5ndGggPSBlbGVtcy5sZW5ndGgsIGlzQXJyYXkgPSBpc0FycmF5bGlrZShlbGVtcyksIHJldCA9IFtdOwogICAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXIgbmV3IHZhbHVlcwogICAgICBpZiAoaXNBcnJheSkgewogICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbXNbaV0sIGksIGFyZyk7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICByZXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSAgLy8gR28gdGhyb3VnaCBldmVyeSBrZXkgb24gdGhlIG9iamVjdCwKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGkgaW4gZWxlbXMpIHsKICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbXNbaV0sIGksIGFyZyk7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICByZXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMKICAgICAgcmV0dXJuIGNvbmNhdC5hcHBseShbXSwgcmV0KTsKICAgIH0sCiAgICAvLyBBIGdsb2JhbCBHVUlEIGNvdW50ZXIgZm9yIG9iamVjdHMKICAgIGd1aWQ6IDEsCiAgICAvLyBCaW5kIGEgZnVuY3Rpb24gdG8gYSBjb250ZXh0LCBvcHRpb25hbGx5IHBhcnRpYWxseSBhcHBseWluZyBhbnkKICAgIC8vIGFyZ3VtZW50cy4KICAgIHByb3h5OiBmdW5jdGlvbiAoZm4sIGNvbnRleHQpIHsKICAgICAgdmFyIHRtcCwgYXJncywgcHJveHk7CiAgICAgIGlmICh0eXBlb2YgY29udGV4dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICB0bXAgPSBmbltjb250ZXh0XTsKICAgICAgICBjb250ZXh0ID0gZm47CiAgICAgICAgZm4gPSB0bXA7CiAgICAgIH0KICAgICAgLy8gUXVpY2sgY2hlY2sgdG8gZGV0ZXJtaW5lIGlmIHRhcmdldCBpcyBjYWxsYWJsZSwgaW4gdGhlIHNwZWMKICAgICAgLy8gdGhpcyB0aHJvd3MgYSBUeXBlRXJyb3IsIGJ1dCB3ZSB3aWxsIGp1c3QgcmV0dXJuIHVuZGVmaW5lZC4KICAgICAgaWYgKCFqUXVlcnkuaXNGdW5jdGlvbihmbikpIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIC8vIFNpbXVsYXRlZCBiaW5kCiAgICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgIHByb3h5ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBmbi5hcHBseShjb250ZXh0IHx8IHRoaXMsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICB9OwogICAgICAvLyBTZXQgdGhlIGd1aWQgb2YgdW5pcXVlIGhhbmRsZXIgdG8gdGhlIHNhbWUgb2Ygb3JpZ2luYWwgaGFuZGxlciwgc28gaXQgY2FuIGJlIHJlbW92ZWQKICAgICAgcHJveHkuZ3VpZCA9IGZuLmd1aWQgPSBmbi5ndWlkIHx8IGpRdWVyeS5ndWlkKys7CiAgICAgIHJldHVybiBwcm94eTsKICAgIH0sCiAgICBub3c6IERhdGUubm93LAogICAgLy8galF1ZXJ5LnN1cHBvcnQgaXMgbm90IHVzZWQgaW4gQ29yZSBidXQgb3RoZXIgcHJvamVjdHMgYXR0YWNoIHRoZWlyCiAgICAvLyBwcm9wZXJ0aWVzIHRvIGl0IHNvIGl0IG5lZWRzIHRvIGV4aXN0LgogICAgc3VwcG9ydDogc3VwcG9ydAogIH0pOwogIC8vIFBvcHVsYXRlIHRoZSBjbGFzczJ0eXBlIG1hcAogIGpRdWVyeS5lYWNoKCdCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0IEVycm9yJy5zcGxpdCgnICcpLCBmdW5jdGlvbiAoaSwgbmFtZSkgewogICAgY2xhc3MydHlwZVsnW29iamVjdCAnICsgbmFtZSArICddJ10gPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgfSk7CiAgZnVuY3Rpb24gaXNBcnJheWxpa2Uob2JqKSB7CiAgICB2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aCwgdHlwZSA9IGpRdWVyeS50eXBlKG9iaik7CiAgICBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJyB8fCBqUXVlcnkuaXNXaW5kb3cob2JqKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAob2JqLm5vZGVUeXBlID09PSAxICYmIGxlbmd0aCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiB0eXBlID09PSAnYXJyYXknIHx8IGxlbmd0aCA9PT0gMCB8fCB0eXBlb2YgbGVuZ3RoID09PSAnbnVtYmVyJyAmJiBsZW5ndGggPiAwICYmIGxlbmd0aCAtIDEgaW4gb2JqOwogIH0KICB2YXIgU2l6emxlID0gLyohCiAgICogU2l6emxlIENTUyBTZWxlY3RvciBFbmdpbmUgdjEuMTAuMTkKICAgKiBodHRwOi8vc2l6emxlanMuY29tLwogICAqCiAgICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogICAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQogICAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICAgKgogICAqIERhdGU6IDIwMTQtMDQtMTgKICAgKi8KICBmdW5jdGlvbiAod2luZG93KSB7CiAgICB2YXIgaSwgc3VwcG9ydCwgRXhwciwgZ2V0VGV4dCwgaXNYTUwsIHRva2VuaXplLCBjb21waWxlLCBzZWxlY3QsIG91dGVybW9zdENvbnRleHQsIHNvcnRJbnB1dCwgaGFzRHVwbGljYXRlLAogICAgICAvLyBMb2NhbCBkb2N1bWVudCB2YXJzCiAgICAgIHNldERvY3VtZW50LCBkb2N1bWVudCwgZG9jRWxlbSwgZG9jdW1lbnRJc0hUTUwsIHJidWdneVFTQSwgcmJ1Z2d5TWF0Y2hlcywgbWF0Y2hlcywgY29udGFpbnMsCiAgICAgIC8vIEluc3RhbmNlLXNwZWNpZmljIGRhdGEKICAgICAgZXhwYW5kbyA9ICdzaXp6bGUnICsgLW5ldyBEYXRlKCksIHByZWZlcnJlZERvYyA9IHdpbmRvdy5kb2N1bWVudCwgZGlycnVucyA9IDAsIGRvbmUgPSAwLCBjbGFzc0NhY2hlID0gY3JlYXRlQ2FjaGUoKSwgdG9rZW5DYWNoZSA9IGNyZWF0ZUNhY2hlKCksIGNvbXBpbGVyQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLCBzb3J0T3JkZXIgPSBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICBoYXNEdXBsaWNhdGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgICAgfSwKICAgICAgLy8gR2VuZXJhbC1wdXJwb3NlIGNvbnN0YW50cwogICAgICBzdHJ1bmRlZmluZWQgPSB0eXBlb2YgdW5kZWZpbmVkLCBNQVhfTkVHQVRJVkUgPSAxIDw8IDMxLAogICAgICAvLyBJbnN0YW5jZSBtZXRob2RzCiAgICAgIGhhc093biA9IHt9Lmhhc093blByb3BlcnR5LCBhcnIgPSBbXSwgcG9wID0gYXJyLnBvcCwgcHVzaF9uYXRpdmUgPSBhcnIucHVzaCwgcHVzaCA9IGFyci5wdXNoLCBzbGljZSA9IGFyci5zbGljZSwKICAgICAgLy8gVXNlIGEgc3RyaXBwZWQtZG93biBpbmRleE9mIGlmIHdlIGNhbid0IHVzZSBhIG5hdGl2ZSBvbmUKICAgICAgaW5kZXhPZiA9IGFyci5pbmRleE9mIHx8IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgdmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsKICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAodGhpc1tpXSA9PT0gZWxlbSkgewogICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIC0xOwogICAgICB9LCBib29sZWFucyA9ICdjaGVja2VkfHNlbGVjdGVkfGFzeW5jfGF1dG9mb2N1c3xhdXRvcGxheXxjb250cm9sc3xkZWZlcnxkaXNhYmxlZHxoaWRkZW58aXNtYXB8bG9vcHxtdWx0aXBsZXxvcGVufHJlYWRvbmx5fHJlcXVpcmVkfHNjb3BlZCcsCiAgICAgIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbnMKICAgICAgLy8gV2hpdGVzcGFjZSBjaGFyYWN0ZXJzIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc2VsZWN0b3JzLyN3aGl0ZXNwYWNlCiAgICAgIHdoaXRlc3BhY2UgPSAnW1xceDIwXFx0XFxyXFxuXFxmXScsCiAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc3ludGF4LyNjaGFyYWN0ZXJzCiAgICAgIGNoYXJhY3RlckVuY29kaW5nID0gJyg/OlxcXFwufFtcXHctXXxbXlxceDAwLVxceGEwXSkrJywKICAgICAgLy8gTG9vc2VseSBtb2RlbGVkIG9uIENTUyBpZGVudGlmaWVyIGNoYXJhY3RlcnMKICAgICAgLy8gQW4gdW5xdW90ZWQgdmFsdWUgc2hvdWxkIGJlIGEgQ1NTIGlkZW50aWZpZXIgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMKICAgICAgLy8gUHJvcGVyIHN5bnRheDogaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI3ZhbHVlLWRlZi1pZGVudGlmaWVyCiAgICAgIGlkZW50aWZpZXIgPSBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCd3JywgJ3cjJyksCiAgICAgIC8vIEF0dHJpYnV0ZSBzZWxlY3RvcnM6IGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwogICAgICBhdHRyaWJ1dGVzID0gJ1xcWycgKyB3aGl0ZXNwYWNlICsgJyooJyArIGNoYXJhY3RlckVuY29kaW5nICsgJykoPzonICsgd2hpdGVzcGFjZSArIC8vIE9wZXJhdG9yIChjYXB0dXJlIDIpCiAgICAgICcqKFsqXiR8IX5dPz0pJyArIHdoaXRlc3BhY2UgKyAvLyAiQXR0cmlidXRlIHZhbHVlcyBtdXN0IGJlIENTUyBpZGVudGlmaWVycyBbY2FwdHVyZSA1XSBvciBzdHJpbmdzIFtjYXB0dXJlIDMgb3IgY2FwdHVyZSA0XSIKICAgICAgJyooPzpcJygoPzpcXFxcLnxbXlxcXFxcJ10pKilcJ3wiKCg/OlxcXFwufFteXFxcXCJdKSopInwoJyArIGlkZW50aWZpZXIgKyAnKSl8KScgKyB3aGl0ZXNwYWNlICsgJypcXF0nLCBwc2V1ZG9zID0gJzooJyArIGNoYXJhY3RlckVuY29kaW5nICsgJykoPzpcXCgoJyArIC8vIFRvIHJlZHVjZSB0aGUgbnVtYmVyIG9mIHNlbGVjdG9ycyBuZWVkaW5nIHRva2VuaXplIGluIHRoZSBwcmVGaWx0ZXIsIHByZWZlciBhcmd1bWVudHM6CiAgICAgIC8vIDEuIHF1b3RlZCAoY2FwdHVyZSAzOyBjYXB0dXJlIDQgb3IgY2FwdHVyZSA1KQogICAgICAnKFwnKCg/OlxcXFwufFteXFxcXFwnXSkqKVwnfCIoKD86XFxcXC58W15cXFxcIl0pKikiKXwnICsgLy8gMi4gc2ltcGxlIChjYXB0dXJlIDYpCiAgICAgICcoKD86XFxcXC58W15cXFxcKClbXFxdXXwnICsgYXR0cmlidXRlcyArICcpKil8JyArIC8vIDMuIGFueXRoaW5nIGVsc2UgKGNhcHR1cmUgMikKICAgICAgJy4qJyArICcpXFwpfCknLAogICAgICAvLyBMZWFkaW5nIGFuZCBub24tZXNjYXBlZCB0cmFpbGluZyB3aGl0ZXNwYWNlLCBjYXB0dXJpbmcgc29tZSBub24td2hpdGVzcGFjZSBjaGFyYWN0ZXJzIHByZWNlZGluZyB0aGUgbGF0dGVyCiAgICAgIHJ0cmltID0gbmV3IFJlZ0V4cCgnXicgKyB3aGl0ZXNwYWNlICsgJyt8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKScgKyB3aGl0ZXNwYWNlICsgJyskJywgJ2cnKSwgcmNvbW1hID0gbmV3IFJlZ0V4cCgnXicgKyB3aGl0ZXNwYWNlICsgJyosJyArIHdoaXRlc3BhY2UgKyAnKicpLCByY29tYmluYXRvcnMgPSBuZXcgUmVnRXhwKCdeJyArIHdoaXRlc3BhY2UgKyAnKihbPit+XXwnICsgd2hpdGVzcGFjZSArICcpJyArIHdoaXRlc3BhY2UgKyAnKicpLCByYXR0cmlidXRlUXVvdGVzID0gbmV3IFJlZ0V4cCgnPScgKyB3aGl0ZXNwYWNlICsgJyooW15cXF1cJyJdKj8pJyArIHdoaXRlc3BhY2UgKyAnKlxcXScsICdnJyksIHJwc2V1ZG8gPSBuZXcgUmVnRXhwKHBzZXVkb3MpLCByaWRlbnRpZmllciA9IG5ldyBSZWdFeHAoJ14nICsgaWRlbnRpZmllciArICckJyksIG1hdGNoRXhwciA9IHsKICAgICAgICAnSUQnOiBuZXcgUmVnRXhwKCdeIygnICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAnKScpLAogICAgICAgICdDTEFTUyc6IG5ldyBSZWdFeHAoJ15cXC4oJyArIGNoYXJhY3RlckVuY29kaW5nICsgJyknKSwKICAgICAgICAnVEFHJzogbmV3IFJlZ0V4cCgnXignICsgY2hhcmFjdGVyRW5jb2RpbmcucmVwbGFjZSgndycsICd3KicpICsgJyknKSwKICAgICAgICAnQVRUUic6IG5ldyBSZWdFeHAoJ14nICsgYXR0cmlidXRlcyksCiAgICAgICAgJ1BTRVVETyc6IG5ldyBSZWdFeHAoJ14nICsgcHNldWRvcyksCiAgICAgICAgJ0NISUxEJzogbmV3IFJlZ0V4cCgnXjoob25seXxmaXJzdHxsYXN0fG50aHxudGgtbGFzdCktKGNoaWxkfG9mLXR5cGUpKD86XFwoJyArIHdoaXRlc3BhY2UgKyAnKihldmVufG9kZHwoKFsrLV18KShcXGQqKW58KScgKyB3aGl0ZXNwYWNlICsgJyooPzooWystXXwpJyArIHdoaXRlc3BhY2UgKyAnKihcXGQrKXwpKScgKyB3aGl0ZXNwYWNlICsgJypcXCl8KScsICdpJyksCiAgICAgICAgJ2Jvb2wnOiBuZXcgUmVnRXhwKCdeKD86JyArIGJvb2xlYW5zICsgJykkJywgJ2knKSwKICAgICAgICAvLyBGb3IgdXNlIGluIGxpYnJhcmllcyBpbXBsZW1lbnRpbmcgLmlzKCkKICAgICAgICAvLyBXZSB1c2UgdGhpcyBmb3IgUE9TIG1hdGNoaW5nIGluIGBzZWxlY3RgCiAgICAgICAgJ25lZWRzQ29udGV4dCc6IG5ldyBSZWdFeHAoJ14nICsgd2hpdGVzcGFjZSArICcqWz4rfl18OihldmVufG9kZHxlcXxndHxsdHxudGh8Zmlyc3R8bGFzdCkoPzpcXCgnICsgd2hpdGVzcGFjZSArICcqKCg/Oi1cXGQpP1xcZCopJyArIHdoaXRlc3BhY2UgKyAnKlxcKXwpKD89W14tXXwkKScsICdpJykKICAgICAgfSwgcmlucHV0cyA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbikkL2ksIHJoZWFkZXIgPSAvXmhcZCQvaSwgcm5hdGl2ZSA9IC9eW157XStce1xzKlxbbmF0aXZlIFx3LywKICAgICAgLy8gRWFzaWx5LXBhcnNlYWJsZS9yZXRyaWV2YWJsZSBJRCBvciBUQUcgb3IgQ0xBU1Mgc2VsZWN0b3JzCiAgICAgIHJxdWlja0V4cHIgPSAvXig/OiMoW1x3LV0rKXwoXHcrKXxcLihbXHctXSspKSQvLCByc2libGluZyA9IC9bK35dLywgcmVzY2FwZSA9IC8nfFxcL2csCiAgICAgIC8vIENTUyBlc2NhcGVzIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCNlc2NhcGVkLWNoYXJhY3RlcnMKICAgICAgcnVuZXNjYXBlID0gbmV3IFJlZ0V4cCgnXFxcXChbXFxkYS1mXXsxLDZ9JyArIHdoaXRlc3BhY2UgKyAnP3woJyArIHdoaXRlc3BhY2UgKyAnKXwuKScsICdpZycpLCBmdW5lc2NhcGUgPSBmdW5jdGlvbiAoXywgZXNjYXBlZCwgZXNjYXBlZFdoaXRlc3BhY2UpIHsKICAgICAgICB2YXIgaGlnaCA9ICcweCcgKyBlc2NhcGVkIC0gNjU1MzY7CiAgICAgICAgLy8gTmFOIG1lYW5zIG5vbi1jb2RlcG9pbnQKICAgICAgICAvLyBTdXBwb3J0OiBGaXJlZm94PDI0CiAgICAgICAgLy8gV29ya2Fyb3VuZCBlcnJvbmVvdXMgbnVtZXJpYyBpbnRlcnByZXRhdGlvbiBvZiArIjB4IgogICAgICAgIHJldHVybiBoaWdoICE9PSBoaWdoIHx8IGVzY2FwZWRXaGl0ZXNwYWNlID8gZXNjYXBlZCA6IGhpZ2ggPCAwID8gLy8gQk1QIGNvZGVwb2ludAogICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoaGlnaCArIDY1NTM2KSA6IC8vIFN1cHBsZW1lbnRhbCBQbGFuZSBjb2RlcG9pbnQgKHN1cnJvZ2F0ZSBwYWlyKQogICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoaGlnaCA+PiAxMCB8IDU1Mjk2LCBoaWdoICYgMTAyMyB8IDU2MzIwKTsKICAgICAgfTsKICAgIC8vIE9wdGltaXplIGZvciBwdXNoLmFwcGx5KCBfLCBOb2RlTGlzdCApCiAgICB0cnkgewogICAgICBwdXNoLmFwcGx5KGFyciA9IHNsaWNlLmNhbGwocHJlZmVycmVkRG9jLmNoaWxkTm9kZXMpLCBwcmVmZXJyZWREb2MuY2hpbGROb2Rlcyk7CiAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQ8NC4wCiAgICAgIC8vIERldGVjdCBzaWxlbnRseSBmYWlsaW5nIHB1c2guYXBwbHkKICAgICAgYXJyW3ByZWZlcnJlZERvYy5jaGlsZE5vZGVzLmxlbmd0aF0ubm9kZVR5cGU7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHB1c2ggPSB7CiAgICAgICAgYXBwbHk6IGFyci5sZW5ndGggPyAvLyBMZXZlcmFnZSBzbGljZSBpZiBwb3NzaWJsZQogICAgICAgIGZ1bmN0aW9uICh0YXJnZXQsIGVscykgewogICAgICAgICAgcHVzaF9uYXRpdmUuYXBwbHkodGFyZ2V0LCBzbGljZS5jYWxsKGVscykpOwogICAgICAgIH0gOiAvLyBTdXBwb3J0OiBJRTw5CiAgICAgICAgLy8gT3RoZXJ3aXNlIGFwcGVuZCBkaXJlY3RseQogICAgICAgIGZ1bmN0aW9uICh0YXJnZXQsIGVscykgewogICAgICAgICAgdmFyIGogPSB0YXJnZXQubGVuZ3RoLCBpID0gMDsKICAgICAgICAgIC8vIENhbid0IHRydXN0IE5vZGVMaXN0Lmxlbmd0aAogICAgICAgICAgd2hpbGUgKHRhcmdldFtqKytdID0gZWxzW2krK10pIHsKICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldC5sZW5ndGggPSBqIC0gMTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBTaXp6bGUoc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpIHsKICAgICAgdmFyIG1hdGNoLCBlbGVtLCBtLCBub2RlVHlwZSwKICAgICAgICAvLyBRU0EgdmFycwogICAgICAgIGksIGdyb3Vwcywgb2xkLCBuaWQsIG5ld0NvbnRleHQsIG5ld1NlbGVjdG9yOwogICAgICBpZiAoKGNvbnRleHQgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IHByZWZlcnJlZERvYykgIT09IGRvY3VtZW50KSB7CiAgICAgICAgc2V0RG9jdW1lbnQoY29udGV4dCk7CiAgICAgIH0KICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CiAgICAgIHJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwogICAgICBpZiAoIXNlbGVjdG9yIHx8IHR5cGVvZiBzZWxlY3RvciAhPT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgfQogICAgICBpZiAoKG5vZGVUeXBlID0gY29udGV4dC5ub2RlVHlwZSkgIT09IDEgJiYgbm9kZVR5cGUgIT09IDkpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgaWYgKGRvY3VtZW50SXNIVE1MICYmICFzZWVkKSB7CiAgICAgICAgLy8gU2hvcnRjdXRzCiAgICAgICAgaWYgKG1hdGNoID0gcnF1aWNrRXhwci5leGVjKHNlbGVjdG9yKSkgewogICAgICAgICAgLy8gU3BlZWQtdXA6IFNpenpsZSgiI0lEIikKICAgICAgICAgIGlmIChtID0gbWF0Y2hbMV0pIHsKICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICAgICAgZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQobSk7CiAgICAgICAgICAgICAgLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKICAgICAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50IChqUXVlcnkgIzY5NjMpCiAgICAgICAgICAgICAgaWYgKGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUsIE9wZXJhLCBhbmQgV2Via2l0IHJldHVybiBpdGVtcwogICAgICAgICAgICAgICAgLy8gYnkgbmFtZSBpbnN0ZWFkIG9mIElECiAgICAgICAgICAgICAgICBpZiAoZWxlbS5pZCA9PT0gbSkgewogICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goZWxlbSk7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gQ29udGV4dCBpcyBub3QgYSBkb2N1bWVudAogICAgICAgICAgICAgIGlmIChjb250ZXh0Lm93bmVyRG9jdW1lbnQgJiYgKGVsZW0gPSBjb250ZXh0Lm93bmVyRG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobSkpICYmIGNvbnRhaW5zKGNvbnRleHQsIGVsZW0pICYmIGVsZW0uaWQgPT09IG0pIHsKICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChlbGVtKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAgLy8gU3BlZWQtdXA6IFNpenpsZSgiVEFHIikKICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbMl0pIHsKICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOyAgLy8gU3BlZWQtdXA6IFNpenpsZSgiLkNMQVNTIikKICAgICAgICAgIH0gZWxzZSBpZiAoKG0gPSBtYXRjaFszXSkgJiYgc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSkgewogICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShtKSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBRU0EgcGF0aAogICAgICAgIGlmIChzdXBwb3J0LnFzYSAmJiAoIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3Qoc2VsZWN0b3IpKSkgewogICAgICAgICAgbmlkID0gb2xkID0gZXhwYW5kbzsKICAgICAgICAgIG5ld0NvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgbmV3U2VsZWN0b3IgPSBub2RlVHlwZSA9PT0gOSAmJiBzZWxlY3RvcjsKICAgICAgICAgIC8vIHFTQSB3b3JrcyBzdHJhbmdlbHkgb24gRWxlbWVudC1yb290ZWQgcXVlcmllcwogICAgICAgICAgLy8gV2UgY2FuIHdvcmsgYXJvdW5kIHRoaXMgYnkgc3BlY2lmeWluZyBhbiBleHRyYSBJRCBvbiB0aGUgcm9vdAogICAgICAgICAgLy8gYW5kIHdvcmtpbmcgdXAgZnJvbSB0aGVyZSAoVGhhbmtzIHRvIEFuZHJldyBEdXBvbnQgZm9yIHRoZSB0ZWNobmlxdWUpCiAgICAgICAgICAvLyBJRSA4IGRvZXNuJ3Qgd29yayBvbiBvYmplY3QgZWxlbWVudHMKICAgICAgICAgIGlmIChub2RlVHlwZSA9PT0gMSAmJiBjb250ZXh0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIGdyb3VwcyA9IHRva2VuaXplKHNlbGVjdG9yKTsKICAgICAgICAgICAgaWYgKG9sZCA9IGNvbnRleHQuZ2V0QXR0cmlidXRlKCdpZCcpKSB7CiAgICAgICAgICAgICAgbmlkID0gb2xkLnJlcGxhY2UocmVzY2FwZSwgJ1xcJCYnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250ZXh0LnNldEF0dHJpYnV0ZSgnaWQnLCBuaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5pZCA9ICdbaWQ9XCcnICsgbmlkICsgJ1wnXSAnOwogICAgICAgICAgICBpID0gZ3JvdXBzLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgIGdyb3Vwc1tpXSA9IG5pZCArIHRvU2VsZWN0b3IoZ3JvdXBzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDb250ZXh0ID0gcnNpYmxpbmcudGVzdChzZWxlY3RvcikgJiYgdGVzdENvbnRleHQoY29udGV4dC5wYXJlbnROb2RlKSB8fCBjb250ZXh0OwogICAgICAgICAgICBuZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCcsJyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmV3U2VsZWN0b3IpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIG5ld0NvbnRleHQucXVlcnlTZWxlY3RvckFsbChuZXdTZWxlY3RvcikpOwogICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICB9IGNhdGNoIChxc2FFcnJvcikgewogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGlmICghb2xkKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0LnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQWxsIG90aGVycwogICAgICByZXR1cm4gc2VsZWN0KHNlbGVjdG9yLnJlcGxhY2UocnRyaW0sICckMScpLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkKTsKICAgIH0KICAgIC8qKgogICAgICogQ3JlYXRlIGtleS12YWx1ZSBjYWNoZXMgb2YgbGltaXRlZCBzaXplCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb24oc3RyaW5nLCBPYmplY3QpfSBSZXR1cm5zIHRoZSBPYmplY3QgZGF0YSBhZnRlciBzdG9yaW5nIGl0IG9uIGl0c2VsZiB3aXRoCiAgICAgKglwcm9wZXJ0eSBuYW1lIHRoZSAoc3BhY2Utc3VmZml4ZWQpIHN0cmluZyBhbmQgKGlmIHRoZSBjYWNoZSBpcyBsYXJnZXIgdGhhbiBFeHByLmNhY2hlTGVuZ3RoKQogICAgICoJZGVsZXRpbmcgdGhlIG9sZGVzdCBlbnRyeQogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVDYWNoZSgpIHsKICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgZnVuY3Rpb24gY2FjaGUoa2V5LCB2YWx1ZSkgewogICAgICAgIC8vIFVzZSAoa2V5ICsgIiAiKSB0byBhdm9pZCBjb2xsaXNpb24gd2l0aCBuYXRpdmUgcHJvdG90eXBlIHByb3BlcnRpZXMgKHNlZSBJc3N1ZSAjMTU3KQogICAgICAgIGlmIChrZXlzLnB1c2goa2V5ICsgJyAnKSA+IEV4cHIuY2FjaGVMZW5ndGgpIHsKICAgICAgICAgIC8vIE9ubHkga2VlcCB0aGUgbW9zdCByZWNlbnQgZW50cmllcwogICAgICAgICAgZGVsZXRlIGNhY2hlW2tleXMuc2hpZnQoKV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYWNoZVtrZXkgKyAnICddID0gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGNhY2hlOwogICAgfQogICAgLyoqCiAgICAgKiBNYXJrIGEgZnVuY3Rpb24gZm9yIHNwZWNpYWwgdXNlIGJ5IFNpenpsZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIG1hcmsKICAgICAqLwogICAgZnVuY3Rpb24gbWFya0Z1bmN0aW9uKGZuKSB7CiAgICAgIGZuW2V4cGFuZG9dID0gdHJ1ZTsKICAgICAgcmV0dXJuIGZuOwogICAgfQogICAgLyoqCiAgICAgKiBTdXBwb3J0IHRlc3RpbmcgdXNpbmcgYW4gZWxlbWVudAogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gUGFzc2VkIHRoZSBjcmVhdGVkIGRpdiBhbmQgZXhwZWN0cyBhIGJvb2xlYW4gcmVzdWx0CiAgICAgKi8KICAgIGZ1bmN0aW9uIGFzc2VydChmbikgewogICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuICEhZm4oZGl2KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAvLyBSZW1vdmUgZnJvbSBpdHMgcGFyZW50IGJ5IGRlZmF1bHQKICAgICAgICBpZiAoZGl2LnBhcmVudE5vZGUpIHsKICAgICAgICAgIGRpdi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGRpdik7CiAgICAgICAgfQogICAgICAgIC8vIHJlbGVhc2UgbWVtb3J5IGluIElFCiAgICAgICAgZGl2ID0gbnVsbDsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBBZGRzIHRoZSBzYW1lIGhhbmRsZXIgZm9yIGFsbCBvZiB0aGUgc3BlY2lmaWVkIGF0dHJzCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gYXR0cnMgUGlwZS1zZXBhcmF0ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBtZXRob2QgdGhhdCB3aWxsIGJlIGFwcGxpZWQKICAgICAqLwogICAgZnVuY3Rpb24gYWRkSGFuZGxlKGF0dHJzLCBoYW5kbGVyKSB7CiAgICAgIHZhciBhcnIgPSBhdHRycy5zcGxpdCgnfCcpLCBpID0gYXR0cnMubGVuZ3RoOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgRXhwci5hdHRySGFuZGxlW2FycltpXV0gPSBoYW5kbGVyOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrcyBkb2N1bWVudCBvcmRlciBvZiB0d28gc2libGluZ3MKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gYQogICAgICogQHBhcmFtIHtFbGVtZW50fSBiCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIGxlc3MgdGhhbiAwIGlmIGEgcHJlY2VkZXMgYiwgZ3JlYXRlciB0aGFuIDAgaWYgYSBmb2xsb3dzIGIKICAgICAqLwogICAgZnVuY3Rpb24gc2libGluZ0NoZWNrKGEsIGIpIHsKICAgICAgdmFyIGN1ciA9IGIgJiYgYSwgZGlmZiA9IGN1ciAmJiBhLm5vZGVUeXBlID09PSAxICYmIGIubm9kZVR5cGUgPT09IDEgJiYgKH5iLnNvdXJjZUluZGV4IHx8IE1BWF9ORUdBVElWRSkgLSAofmEuc291cmNlSW5kZXggfHwgTUFYX05FR0FUSVZFKTsKICAgICAgLy8gVXNlIElFIHNvdXJjZUluZGV4IGlmIGF2YWlsYWJsZSBvbiBib3RoIG5vZGVzCiAgICAgIGlmIChkaWZmKSB7CiAgICAgICAgcmV0dXJuIGRpZmY7CiAgICAgIH0KICAgICAgLy8gQ2hlY2sgaWYgYiBmb2xsb3dzIGEKICAgICAgaWYgKGN1cikgewogICAgICAgIHdoaWxlIChjdXIgPSBjdXIubmV4dFNpYmxpbmcpIHsKICAgICAgICAgIGlmIChjdXIgPT09IGIpIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYSA/IDEgOiAtMTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBpbnB1dCB0eXBlcwogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlSW5wdXRQc2V1ZG8odHlwZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gbmFtZSA9PT0gJ2lucHV0JyAmJiBlbGVtLnR5cGUgPT09IHR5cGU7CiAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgYnV0dG9ucwogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQnV0dG9uUHNldWRvKHR5cGUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcmV0dXJuIChuYW1lID09PSAnaW5wdXQnIHx8IG5hbWUgPT09ICdidXR0b24nKSAmJiBlbGVtLnR5cGUgPT09IHR5cGU7CiAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgcG9zaXRpb25hbHMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZm4pIHsKICAgICAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoYXJndW1lbnQpIHsKICAgICAgICBhcmd1bWVudCA9ICthcmd1bWVudDsKICAgICAgICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzKSB7CiAgICAgICAgICB2YXIgaiwgbWF0Y2hJbmRleGVzID0gZm4oW10sIHNlZWQubGVuZ3RoLCBhcmd1bWVudCksIGkgPSBtYXRjaEluZGV4ZXMubGVuZ3RoOwogICAgICAgICAgLy8gTWF0Y2ggZWxlbWVudHMgZm91bmQgYXQgdGhlIHNwZWNpZmllZCBpbmRleGVzCiAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIGlmIChzZWVkW2ogPSBtYXRjaEluZGV4ZXNbaV1dKSB7CiAgICAgICAgICAgICAgc2VlZFtqXSA9ICEobWF0Y2hlc1tqXSA9IHNlZWRbal0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgYSBub2RlIGZvciB2YWxpZGl0eSBhcyBhIFNpenpsZSBjb250ZXh0CiAgICAgKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0PX0gY29udGV4dAogICAgICogQHJldHVybnMge0VsZW1lbnR8T2JqZWN0fEJvb2xlYW59IFRoZSBpbnB1dCBub2RlIGlmIGFjY2VwdGFibGUsIG90aGVyd2lzZSBhIGZhbHN5IHZhbHVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRlc3RDb250ZXh0KGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGNvbnRleHQgJiYgdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09IHN0cnVuZGVmaW5lZCAmJiBjb250ZXh0OwogICAgfQogICAgLy8gRXhwb3NlIHN1cHBvcnQgdmFycyBmb3IgY29udmVuaWVuY2UKICAgIHN1cHBvcnQgPSBTaXp6bGUuc3VwcG9ydCA9IHt9OwogICAgLyoqCiAgICAgKiBEZXRlY3RzIFhNTCBub2RlcwogICAgICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gZWxlbSBBbiBlbGVtZW50IG9yIGEgZG9jdW1lbnQKICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmZiBlbGVtIGlzIGEgbm9uLUhUTUwgWE1MIG5vZGUKICAgICAqLwogICAgaXNYTUwgPSBTaXp6bGUuaXNYTUwgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICAvLyBkb2N1bWVudEVsZW1lbnQgaXMgdmVyaWZpZWQgZm9yIGNhc2VzIHdoZXJlIGl0IGRvZXNuJ3QgeWV0IGV4aXN0CiAgICAgIC8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKQogICAgICB2YXIgZG9jdW1lbnRFbGVtZW50ID0gZWxlbSAmJiAoZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0pLmRvY3VtZW50RWxlbWVudDsKICAgICAgcmV0dXJuIGRvY3VtZW50RWxlbWVudCA/IGRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPT0gJ0hUTUwnIDogZmFsc2U7CiAgICB9OwogICAgLyoqCiAgICAgKiBTZXRzIGRvY3VtZW50LXJlbGF0ZWQgdmFyaWFibGVzIG9uY2UgYmFzZWQgb24gdGhlIGN1cnJlbnQgZG9jdW1lbnQKICAgICAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3R9IFtkb2NdIEFuIGVsZW1lbnQgb3IgZG9jdW1lbnQgb2JqZWN0IHRvIHVzZSB0byBzZXQgdGhlIGRvY3VtZW50CiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjdXJyZW50IGRvY3VtZW50CiAgICAgKi8KICAgIHNldERvY3VtZW50ID0gU2l6emxlLnNldERvY3VtZW50ID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgdmFyIGhhc0NvbXBhcmUsIGRvYyA9IG5vZGUgPyBub2RlLm93bmVyRG9jdW1lbnQgfHwgbm9kZSA6IHByZWZlcnJlZERvYywgcGFyZW50ID0gZG9jLmRlZmF1bHRWaWV3OwogICAgICAvLyBJZiBubyBkb2N1bWVudCBhbmQgZG9jdW1lbnRFbGVtZW50IGlzIGF2YWlsYWJsZSwgcmV0dXJuCiAgICAgIGlmIChkb2MgPT09IGRvY3VtZW50IHx8IGRvYy5ub2RlVHlwZSAhPT0gOSB8fCAhZG9jLmRvY3VtZW50RWxlbWVudCkgewogICAgICAgIHJldHVybiBkb2N1bWVudDsKICAgICAgfQogICAgICAvLyBTZXQgb3VyIGRvY3VtZW50CiAgICAgIGRvY3VtZW50ID0gZG9jOwogICAgICBkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKICAgICAgLy8gU3VwcG9ydCB0ZXN0cwogICAgICBkb2N1bWVudElzSFRNTCA9ICFpc1hNTChkb2MpOwogICAgICAvLyBTdXBwb3J0OiBJRT44CiAgICAgIC8vIElmIGlmcmFtZSBkb2N1bWVudCBpcyBhc3NpZ25lZCB0byAiZG9jdW1lbnQiIHZhcmlhYmxlIGFuZCBpZiBpZnJhbWUgaGFzIGJlZW4gcmVsb2FkZWQsCiAgICAgIC8vIElFIHdpbGwgdGhyb3cgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIGFjY2Vzc2luZyAiZG9jdW1lbnQiIHZhcmlhYmxlLCBzZWUgalF1ZXJ5ICMxMzkzNgogICAgICAvLyBJRTYtOCBkbyBub3Qgc3VwcG9ydCB0aGUgZGVmYXVsdFZpZXcgcHJvcGVydHkgc28gcGFyZW50IHdpbGwgYmUgdW5kZWZpbmVkCiAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50ICE9PSBwYXJlbnQudG9wKSB7CiAgICAgICAgLy8gSUUxMSBkb2VzIG5vdCBoYXZlIGF0dGFjaEV2ZW50LCBzbyBhbGwgbXVzdCBzdWZmZXIKICAgICAgICBpZiAocGFyZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgIHBhcmVudC5hZGRFdmVudExpc3RlbmVyKCd1bmxvYWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNldERvY3VtZW50KCk7CiAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgfSBlbHNlIGlmIChwYXJlbnQuYXR0YWNoRXZlbnQpIHsKICAgICAgICAgIHBhcmVudC5hdHRhY2hFdmVudCgnb251bmxvYWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNldERvY3VtZW50KCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLyogQXR0cmlidXRlcwogICAgICAJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogICAgICAvLyBTdXBwb3J0OiBJRTw4CiAgICAgIC8vIFZlcmlmeSB0aGF0IGdldEF0dHJpYnV0ZSByZWFsbHkgcmV0dXJucyBhdHRyaWJ1dGVzIGFuZCBub3QgcHJvcGVydGllcyAoZXhjZXB0aW5nIElFOCBib29sZWFucykKICAgICAgc3VwcG9ydC5hdHRyaWJ1dGVzID0gYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICBkaXYuY2xhc3NOYW1lID0gJ2knOwogICAgICAgIHJldHVybiAhZGl2LmdldEF0dHJpYnV0ZSgnY2xhc3NOYW1lJyk7CiAgICAgIH0pOwogICAgICAvKiBnZXRFbGVtZW50KHMpQnkqCiAgICAgIAktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAgICAgIC8vIENoZWNrIGlmIGdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgcmV0dXJucyBvbmx5IGVsZW1lbnRzCiAgICAgIHN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPSBhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgIGRpdi5hcHBlbmRDaGlsZChkb2MuY3JlYXRlQ29tbWVudCgnJykpOwogICAgICAgIHJldHVybiAhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoOwogICAgICB9KTsKICAgICAgLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYW4gYmUgdHJ1c3RlZAogICAgICBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgPSBybmF0aXZlLnRlc3QoZG9jLmdldEVsZW1lbnRzQnlDbGFzc05hbWUpICYmIGFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPVwnYVwnPjwvZGl2PjxkaXYgY2xhc3M9XCdhIGlcJz48L2Rpdj4nOwogICAgICAgIC8vIFN1cHBvcnQ6IFNhZmFyaTw0CiAgICAgICAgLy8gQ2F0Y2ggY2xhc3Mgb3Zlci1jYWNoaW5nCiAgICAgICAgZGl2LmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gJ2knOwogICAgICAgIC8vIFN1cHBvcnQ6IE9wZXJhPDEwCiAgICAgICAgLy8gQ2F0Y2ggZ0VCQ04gZmFpbHVyZSB0byBmaW5kIG5vbi1sZWFkaW5nIGNsYXNzZXMKICAgICAgICByZXR1cm4gZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2knKS5sZW5ndGggPT09IDI7CiAgICAgIH0pOwogICAgICAvLyBTdXBwb3J0OiBJRTwxMAogICAgICAvLyBDaGVjayBpZiBnZXRFbGVtZW50QnlJZCByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUKICAgICAgLy8gVGhlIGJyb2tlbiBnZXRFbGVtZW50QnlJZCBtZXRob2RzIGRvbid0IHBpY2sgdXAgcHJvZ3JhbWF0aWNhbGx5LXNldCBuYW1lcywKICAgICAgLy8gc28gdXNlIGEgcm91bmRhYm91dCBnZXRFbGVtZW50c0J5TmFtZSB0ZXN0CiAgICAgIHN1cHBvcnQuZ2V0QnlJZCA9IGFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgZG9jRWxlbS5hcHBlbmRDaGlsZChkaXYpLmlkID0gZXhwYW5kbzsKICAgICAgICByZXR1cm4gIWRvYy5nZXRFbGVtZW50c0J5TmFtZSB8fCAhZG9jLmdldEVsZW1lbnRzQnlOYW1lKGV4cGFuZG8pLmxlbmd0aDsKICAgICAgfSk7CiAgICAgIC8vIElEIGZpbmQgYW5kIGZpbHRlcgogICAgICBpZiAoc3VwcG9ydC5nZXRCeUlkKSB7CiAgICAgICAgRXhwci5maW5kWydJRCddID0gZnVuY3Rpb24gKGlkLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09IHN0cnVuZGVmaW5lZCAmJiBkb2N1bWVudElzSFRNTCkgewogICAgICAgICAgICB2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgICAgIHJldHVybiBtICYmIG0ucGFyZW50Tm9kZSA/IFttXSA6IFtdOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgRXhwci5maWx0ZXJbJ0lEJ10gPSBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgIHZhciBhdHRySWQgPSBpZC5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoJ2lkJykgPT09IGF0dHJJZDsKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTdXBwb3J0OiBJRTYvNwogICAgICAgIC8vIGdldEVsZW1lbnRCeUlkIGlzIG5vdCByZWxpYWJsZSBhcyBhIGZpbmQgc2hvcnRjdXQKICAgICAgICBkZWxldGUgRXhwci5maW5kWydJRCddOwogICAgICAgIEV4cHIuZmlsdGVyWydJRCddID0gZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICB2YXIgYXR0cklkID0gaWQucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpOwogICAgICAgICAgICByZXR1cm4gbm9kZSAmJiBub2RlLnZhbHVlID09PSBhdHRySWQ7CiAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgIH0KICAgICAgLy8gVGFnCiAgICAgIEV4cHIuZmluZFsnVEFHJ10gPSBzdXBwb3J0LmdldEVsZW1lbnRzQnlUYWdOYW1lID8gZnVuY3Rpb24gKHRhZywgY29udGV4dCkgewogICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gc3RydW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwogICAgICAgIH0KICAgICAgfSA6IGZ1bmN0aW9uICh0YWcsIGNvbnRleHQpIHsKICAgICAgICB2YXIgZWxlbSwgdG1wID0gW10sIGkgPSAwLCByZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwogICAgICAgIC8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMKICAgICAgICBpZiAodGFnID09PSAnKicpIHsKICAgICAgICAgIHdoaWxlIChlbGVtID0gcmVzdWx0c1tpKytdKSB7CiAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgdG1wLnB1c2goZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0bXA7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICB9OwogICAgICAvLyBDbGFzcwogICAgICBFeHByLmZpbmRbJ0NMQVNTJ10gPSBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgZnVuY3Rpb24gKGNsYXNzTmFtZSwgY29udGV4dCkgewogICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICE9PSBzdHJ1bmRlZmluZWQgJiYgZG9jdW1lbnRJc0hUTUwpIHsKICAgICAgICAgIHJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NOYW1lKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIC8qIFFTQS9tYXRjaGVzU2VsZWN0b3IKICAgICAgCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KICAgICAgLy8gUVNBIGFuZCBtYXRjaGVzU2VsZWN0b3Igc3VwcG9ydAogICAgICAvLyBtYXRjaGVzU2VsZWN0b3IoOmFjdGl2ZSkgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKElFOS9PcGVyYSAxMS41KQogICAgICByYnVnZ3lNYXRjaGVzID0gW107CiAgICAgIC8vIHFTYSg6Zm9jdXMpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChDaHJvbWUgMjEpCiAgICAgIC8vIFdlIGFsbG93IHRoaXMgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBJRTgvOSB0aGF0IHRocm93cyBhbiBlcnJvcgogICAgICAvLyB3aGVuZXZlciBgZG9jdW1lbnQuYWN0aXZlRWxlbWVudGAgaXMgYWNjZXNzZWQgb24gYW4gaWZyYW1lCiAgICAgIC8vIFNvLCB3ZSBhbGxvdyA6Zm9jdXMgdG8gcGFzcyB0aHJvdWdoIFFTQSBhbGwgdGhlIHRpbWUgdG8gYXZvaWQgdGhlIElFIGVycm9yCiAgICAgIC8vIFNlZSBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMzM3OAogICAgICByYnVnZ3lRU0EgPSBbXTsKICAgICAgaWYgKHN1cHBvcnQucXNhID0gcm5hdGl2ZS50ZXN0KGRvYy5xdWVyeVNlbGVjdG9yQWxsKSkgewogICAgICAgIC8vIEJ1aWxkIFFTQSByZWdleAogICAgICAgIC8vIFJlZ2V4IHN0cmF0ZWd5IGFkb3B0ZWQgZnJvbSBEaWVnbyBQZXJpbmkKICAgICAgICBhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgICAgLy8gU2VsZWN0IGlzIHNldCB0byBlbXB0eSBzdHJpbmcgb24gcHVycG9zZQogICAgICAgICAgLy8gVGhpcyBpcyB0byB0ZXN0IElFJ3MgdHJlYXRtZW50IG9mIG5vdCBleHBsaWNpdGx5CiAgICAgICAgICAvLyBzZXR0aW5nIGEgYm9vbGVhbiBjb250ZW50IGF0dHJpYnV0ZSwKICAgICAgICAgIC8vIHNpbmNlIGl0cyBwcmVzZW5jZSBzaG91bGQgYmUgZW5vdWdoCiAgICAgICAgICAvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMjM1OQogICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8c2VsZWN0IG1zYWxsb3djbGlwPVwnXCc+PG9wdGlvbiBzZWxlY3RlZD1cJ1wnPjwvb3B0aW9uPjwvc2VsZWN0Pic7CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRTgsIE9wZXJhIDExLTEyLjE2CiAgICAgICAgICAvLyBOb3RoaW5nIHNob3VsZCBiZSBzZWxlY3RlZCB3aGVuIGVtcHR5IHN0cmluZ3MgZm9sbG93IF49IG9yICQ9IG9yICo9CiAgICAgICAgICAvLyBUaGUgdGVzdCBhdHRyaWJ1dGUgbXVzdCBiZSB1bmtub3duIGluIE9wZXJhIGJ1dCAic2FmZSIgZm9yIFdpblJUCiAgICAgICAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvaGg0NjUzODguYXNweCNhdHRyaWJ1dGVfc2VjdGlvbgogICAgICAgICAgaWYgKGRpdi5xdWVyeVNlbGVjdG9yQWxsKCdbbXNhbGxvd2NsaXBePVwnXCddJykubGVuZ3RoKSB7CiAgICAgICAgICAgIHJidWdneVFTQS5wdXNoKCdbKl4kXT0nICsgd2hpdGVzcGFjZSArICcqKD86XCdcJ3wiIiknKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFN1cHBvcnQ6IElFOAogICAgICAgICAgLy8gQm9vbGVhbiBhdHRyaWJ1dGVzIGFuZCAidmFsdWUiIGFyZSBub3QgdHJlYXRlZCBjb3JyZWN0bHkKICAgICAgICAgIGlmICghZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tzZWxlY3RlZF0nKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goJ1xcWycgKyB3aGl0ZXNwYWNlICsgJyooPzp2YWx1ZXwnICsgYm9vbGVhbnMgKyAnKScpOwogICAgICAgICAgfQogICAgICAgICAgLy8gV2Via2l0L09wZXJhIC0gOmNoZWNrZWQgc2hvdWxkIHJldHVybiBzZWxlY3RlZCBvcHRpb24gZWxlbWVudHMKICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCiAgICAgICAgICAvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwogICAgICAgICAgaWYgKCFkaXYucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goJzpjaGVja2VkJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICAgIC8vIFN1cHBvcnQ6IFdpbmRvd3MgOCBOYXRpdmUgQXBwcwogICAgICAgICAgLy8gVGhlIHR5cGUgYW5kIG5hbWUgYXR0cmlidXRlcyBhcmUgcmVzdHJpY3RlZCBkdXJpbmcgLmlubmVySFRNTCBhc3NpZ25tZW50CiAgICAgICAgICB2YXIgaW5wdXQgPSBkb2MuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsKICAgICAgICAgIGlucHV0LnNldEF0dHJpYnV0ZSgndHlwZScsICdoaWRkZW4nKTsKICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChpbnB1dCkuc2V0QXR0cmlidXRlKCduYW1lJywgJ0QnKTsKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFOAogICAgICAgICAgLy8gRW5mb3JjZSBjYXNlLXNlbnNpdGl2aXR5IG9mIG5hbWUgYXR0cmlidXRlCiAgICAgICAgICBpZiAoZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tuYW1lPWRdJykubGVuZ3RoKSB7CiAgICAgICAgICAgIHJidWdneVFTQS5wdXNoKCduYW1lJyArIHdoaXRlc3BhY2UgKyAnKlsqXiR8IX5dPz0nKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEZGIDMuNSAtIDplbmFibGVkLzpkaXNhYmxlZCBhbmQgaGlkZGVuIGVsZW1lbnRzIChoaWRkZW4gZWxlbWVudHMgYXJlIHN0aWxsIGVuYWJsZWQpCiAgICAgICAgICAvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwogICAgICAgICAgaWYgKCFkaXYucXVlcnlTZWxlY3RvckFsbCgnOmVuYWJsZWQnKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goJzplbmFibGVkJywgJzpkaXNhYmxlZCcpOwogICAgICAgICAgfQogICAgICAgICAgLy8gT3BlcmEgMTAtMTEgZG9lcyBub3QgdGhyb3cgb24gcG9zdC1jb21tYSBpbnZhbGlkIHBzZXVkb3MKICAgICAgICAgIGRpdi5xdWVyeVNlbGVjdG9yQWxsKCcqLDp4Jyk7CiAgICAgICAgICByYnVnZ3lRU0EucHVzaCgnLC4qOicpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciA9IHJuYXRpdmUudGVzdChtYXRjaGVzID0gZG9jRWxlbS5tYXRjaGVzIHx8IGRvY0VsZW0ud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8IGRvY0VsZW0ubW96TWF0Y2hlc1NlbGVjdG9yIHx8IGRvY0VsZW0ub01hdGNoZXNTZWxlY3RvciB8fCBkb2NFbGVtLm1zTWF0Y2hlc1NlbGVjdG9yKSkgewogICAgICAgIGFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgICAvLyBDaGVjayB0byBzZWUgaWYgaXQncyBwb3NzaWJsZSB0byBkbyBtYXRjaGVzU2VsZWN0b3IKICAgICAgICAgIC8vIG9uIGEgZGlzY29ubmVjdGVkIG5vZGUgKElFIDkpCiAgICAgICAgICBzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoID0gbWF0Y2hlcy5jYWxsKGRpdiwgJ2RpdicpOwogICAgICAgICAgLy8gVGhpcyBzaG91bGQgZmFpbCB3aXRoIGFuIGV4Y2VwdGlvbgogICAgICAgICAgLy8gR2Vja28gZG9lcyBub3QgZXJyb3IsIHJldHVybnMgZmFsc2UgaW5zdGVhZAogICAgICAgICAgbWF0Y2hlcy5jYWxsKGRpdiwgJ1tzIT1cJ1wnXTp4Jyk7CiAgICAgICAgICByYnVnZ3lNYXRjaGVzLnB1c2goJyE9JywgcHNldWRvcyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmJ1Z2d5UVNBID0gcmJ1Z2d5UVNBLmxlbmd0aCAmJiBuZXcgUmVnRXhwKHJidWdneVFTQS5qb2luKCd8JykpOwogICAgICByYnVnZ3lNYXRjaGVzID0gcmJ1Z2d5TWF0Y2hlcy5sZW5ndGggJiYgbmV3IFJlZ0V4cChyYnVnZ3lNYXRjaGVzLmpvaW4oJ3wnKSk7CiAgICAgIC8qIENvbnRhaW5zCiAgICAgIAktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAgICAgIGhhc0NvbXBhcmUgPSBybmF0aXZlLnRlc3QoZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbik7CiAgICAgIC8vIEVsZW1lbnQgY29udGFpbnMgYW5vdGhlcgogICAgICAvLyBQdXJwb3NlZnVsbHkgZG9lcyBub3QgaW1wbGVtZW50IGluY2x1c2l2ZSBkZXNjZW5kZW50CiAgICAgIC8vIEFzIGluLCBhbiBlbGVtZW50IGRvZXMgbm90IGNvbnRhaW4gaXRzZWxmCiAgICAgIGNvbnRhaW5zID0gaGFzQ29tcGFyZSB8fCBybmF0aXZlLnRlc3QoZG9jRWxlbS5jb250YWlucykgPyBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHZhciBhZG93biA9IGEubm9kZVR5cGUgPT09IDkgPyBhLmRvY3VtZW50RWxlbWVudCA6IGEsIGJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwogICAgICAgIHJldHVybiBhID09PSBidXAgfHwgISEoYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoYWRvd24uY29udGFpbnMgPyBhZG93bi5jb250YWlucyhidXApIDogYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGJ1cCkgJiAxNikpOwogICAgICB9IDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICBpZiAoYikgewogICAgICAgICAgd2hpbGUgKGIgPSBiLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgaWYgKGIgPT09IGEpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH07CiAgICAgIC8qIFNvcnRpbmcKICAgICAgCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KICAgICAgLy8gRG9jdW1lbnQgb3JkZXIgc29ydGluZwogICAgICBzb3J0T3JkZXIgPSBoYXNDb21wYXJlID8gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAvLyBGbGFnIGZvciBkdXBsaWNhdGUgcmVtb3ZhbAogICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICBoYXNEdXBsaWNhdGUgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIC8vIFNvcnQgb24gbWV0aG9kIGV4aXN0ZW5jZSBpZiBvbmx5IG9uZSBpbnB1dCBoYXMgY29tcGFyZURvY3VtZW50UG9zaXRpb24KICAgICAgICB2YXIgY29tcGFyZSA9ICFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIC0gIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb247CiAgICAgICAgaWYgKGNvbXBhcmUpIHsKICAgICAgICAgIHJldHVybiBjb21wYXJlOwogICAgICAgIH0KICAgICAgICAvLyBDYWxjdWxhdGUgcG9zaXRpb24gaWYgYm90aCBpbnB1dHMgYmVsb25nIHRvIHRoZSBzYW1lIGRvY3VtZW50CiAgICAgICAgY29tcGFyZSA9IChhLm93bmVyRG9jdW1lbnQgfHwgYSkgPT09IChiLm93bmVyRG9jdW1lbnQgfHwgYikgPyBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGIpIDogLy8gT3RoZXJ3aXNlIHdlIGtub3cgdGhleSBhcmUgZGlzY29ubmVjdGVkCiAgICAgICAgMTsKICAgICAgICAvLyBEaXNjb25uZWN0ZWQgbm9kZXMKICAgICAgICBpZiAoY29tcGFyZSAmIDEgfHwgIXN1cHBvcnQuc29ydERldGFjaGVkICYmIGIuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYSkgPT09IGNvbXBhcmUpIHsKICAgICAgICAgIC8vIENob29zZSB0aGUgZmlyc3QgZWxlbWVudCB0aGF0IGlzIHJlbGF0ZWQgdG8gb3VyIHByZWZlcnJlZCBkb2N1bWVudAogICAgICAgICAgaWYgKGEgPT09IGRvYyB8fCBhLm93bmVyRG9jdW1lbnQgPT09IHByZWZlcnJlZERvYyAmJiBjb250YWlucyhwcmVmZXJyZWREb2MsIGEpKSB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiID09PSBkb2MgfHwgYi5vd25lckRvY3VtZW50ID09PSBwcmVmZXJyZWREb2MgJiYgY29udGFpbnMocHJlZmVycmVkRG9jLCBiKSkgewogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIE1haW50YWluIG9yaWdpbmFsIG9yZGVyCiAgICAgICAgICByZXR1cm4gc29ydElucHV0ID8gaW5kZXhPZi5jYWxsKHNvcnRJbnB1dCwgYSkgLSBpbmRleE9mLmNhbGwoc29ydElucHV0LCBiKSA6IDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb21wYXJlICYgNCA/IC0xIDogMTsKICAgICAgfSA6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgLy8gRXhpdCBlYXJseSBpZiB0aGUgbm9kZXMgYXJlIGlkZW50aWNhbAogICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICBoYXNEdXBsaWNhdGUgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIHZhciBjdXIsIGkgPSAwLCBhdXAgPSBhLnBhcmVudE5vZGUsIGJ1cCA9IGIucGFyZW50Tm9kZSwgYXAgPSBbYV0sIGJwID0gW2JdOwogICAgICAgIC8vIFBhcmVudGxlc3Mgbm9kZXMgYXJlIGVpdGhlciBkb2N1bWVudHMgb3IgZGlzY29ubmVjdGVkCiAgICAgICAgaWYgKCFhdXAgfHwgIWJ1cCkgewogICAgICAgICAgcmV0dXJuIGEgPT09IGRvYyA/IC0xIDogYiA9PT0gZG9jID8gMSA6IGF1cCA/IC0xIDogYnVwID8gMSA6IHNvcnRJbnB1dCA/IGluZGV4T2YuY2FsbChzb3J0SW5wdXQsIGEpIC0gaW5kZXhPZi5jYWxsKHNvcnRJbnB1dCwgYikgOiAwOyAgLy8gSWYgdGhlIG5vZGVzIGFyZSBzaWJsaW5ncywgd2UgY2FuIGRvIGEgcXVpY2sgY2hlY2sKICAgICAgICB9IGVsc2UgaWYgKGF1cCA9PT0gYnVwKSB7CiAgICAgICAgICByZXR1cm4gc2libGluZ0NoZWNrKGEsIGIpOwogICAgICAgIH0KICAgICAgICAvLyBPdGhlcndpc2Ugd2UgbmVlZCBmdWxsIGxpc3RzIG9mIHRoZWlyIGFuY2VzdG9ycyBmb3IgY29tcGFyaXNvbgogICAgICAgIGN1ciA9IGE7CiAgICAgICAgd2hpbGUgKGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgICBhcC51bnNoaWZ0KGN1cik7CiAgICAgICAgfQogICAgICAgIGN1ciA9IGI7CiAgICAgICAgd2hpbGUgKGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgICBicC51bnNoaWZ0KGN1cik7CiAgICAgICAgfQogICAgICAgIC8vIFdhbGsgZG93biB0aGUgdHJlZSBsb29raW5nIGZvciBhIGRpc2NyZXBhbmN5CiAgICAgICAgd2hpbGUgKGFwW2ldID09PSBicFtpXSkgewogICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaSA/IC8vIERvIGEgc2libGluZyBjaGVjayBpZiB0aGUgbm9kZXMgaGF2ZSBhIGNvbW1vbiBhbmNlc3RvcgogICAgICAgIHNpYmxpbmdDaGVjayhhcFtpXSwgYnBbaV0pIDogLy8gT3RoZXJ3aXNlIG5vZGVzIGluIG91ciBkb2N1bWVudCBzb3J0IGZpcnN0CiAgICAgICAgYXBbaV0gPT09IHByZWZlcnJlZERvYyA/IC0xIDogYnBbaV0gPT09IHByZWZlcnJlZERvYyA/IDEgOiAwOwogICAgICB9OwogICAgICByZXR1cm4gZG9jOwogICAgfTsKICAgIFNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24gKGV4cHIsIGVsZW1lbnRzKSB7CiAgICAgIHJldHVybiBTaXp6bGUoZXhwciwgbnVsbCwgbnVsbCwgZWxlbWVudHMpOwogICAgfTsKICAgIFNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiAoZWxlbSwgZXhwcikgewogICAgICAvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKICAgICAgaWYgKChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkgIT09IGRvY3VtZW50KSB7CiAgICAgICAgc2V0RG9jdW1lbnQoZWxlbSk7CiAgICAgIH0KICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgYXR0cmlidXRlIHNlbGVjdG9ycyBhcmUgcXVvdGVkCiAgICAgIGV4cHIgPSBleHByLnJlcGxhY2UocmF0dHJpYnV0ZVF1b3RlcywgJz1cJyQxXCddJyk7CiAgICAgIGlmIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciAmJiBkb2N1bWVudElzSFRNTCAmJiAoIXJidWdneU1hdGNoZXMgfHwgIXJidWdneU1hdGNoZXMudGVzdChleHByKSkgJiYgKCFyYnVnZ3lRU0EgfHwgIXJidWdneVFTQS50ZXN0KGV4cHIpKSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcmV0ID0gbWF0Y2hlcy5jYWxsKGVsZW0sIGV4cHIpOwogICAgICAgICAgLy8gSUUgOSdzIG1hdGNoZXNTZWxlY3RvciByZXR1cm5zIGZhbHNlIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwogICAgICAgICAgaWYgKHJldCB8fCBzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoIHx8IC8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50CiAgICAgICAgICAgIC8vIGZyYWdtZW50IGluIElFIDkKICAgICAgICAgICAgZWxlbS5kb2N1bWVudCAmJiBlbGVtLmRvY3VtZW50Lm5vZGVUeXBlICE9PSAxMSkgewogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIFNpenpsZShleHByLCBkb2N1bWVudCwgbnVsbCwgW2VsZW1dKS5sZW5ndGggPiAwOwogICAgfTsKICAgIFNpenpsZS5jb250YWlucyA9IGZ1bmN0aW9uIChjb250ZXh0LCBlbGVtKSB7CiAgICAgIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogICAgICBpZiAoKGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0KSAhPT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChjb250ZXh0KTsKICAgICAgfQogICAgICByZXR1cm4gY29udGFpbnMoY29udGV4dCwgZWxlbSk7CiAgICB9OwogICAgU2l6emxlLmF0dHIgPSBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICAvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKICAgICAgaWYgKChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkgIT09IGRvY3VtZW50KSB7CiAgICAgICAgc2V0RG9jdW1lbnQoZWxlbSk7CiAgICAgIH0KICAgICAgdmFyIGZuID0gRXhwci5hdHRySGFuZGxlW25hbWUudG9Mb3dlckNhc2UoKV0sCiAgICAgICAgLy8gRG9uJ3QgZ2V0IGZvb2xlZCBieSBPYmplY3QucHJvdG90eXBlIHByb3BlcnRpZXMgKGpRdWVyeSAjMTM4MDcpCiAgICAgICAgdmFsID0gZm4gJiYgaGFzT3duLmNhbGwoRXhwci5hdHRySGFuZGxlLCBuYW1lLnRvTG93ZXJDYXNlKCkpID8gZm4oZWxlbSwgbmFtZSwgIWRvY3VtZW50SXNIVE1MKSA6IHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIHZhbCAhPT0gdW5kZWZpbmVkID8gdmFsIDogc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFkb2N1bWVudElzSFRNTCA/IGVsZW0uZ2V0QXR0cmlidXRlKG5hbWUpIDogKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZShuYW1lKSkgJiYgdmFsLnNwZWNpZmllZCA/IHZhbC52YWx1ZSA6IG51bGw7CiAgICB9OwogICAgU2l6emxlLmVycm9yID0gZnVuY3Rpb24gKG1zZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICcgKyBtc2cpOwogICAgfTsKICAgIC8qKgogICAgICogRG9jdW1lbnQgc29ydGluZyBhbmQgcmVtb3ZpbmcgZHVwbGljYXRlcwogICAgICogQHBhcmFtIHtBcnJheUxpa2V9IHJlc3VsdHMKICAgICAqLwogICAgU2l6emxlLnVuaXF1ZVNvcnQgPSBmdW5jdGlvbiAocmVzdWx0cykgewogICAgICB2YXIgZWxlbSwgZHVwbGljYXRlcyA9IFtdLCBqID0gMCwgaSA9IDA7CiAgICAgIC8vIFVubGVzcyB3ZSAqa25vdyogd2UgY2FuIGRldGVjdCBkdXBsaWNhdGVzLCBhc3N1bWUgdGhlaXIgcHJlc2VuY2UKICAgICAgaGFzRHVwbGljYXRlID0gIXN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlczsKICAgICAgc29ydElucHV0ID0gIXN1cHBvcnQuc29ydFN0YWJsZSAmJiByZXN1bHRzLnNsaWNlKDApOwogICAgICByZXN1bHRzLnNvcnQoc29ydE9yZGVyKTsKICAgICAgaWYgKGhhc0R1cGxpY2F0ZSkgewogICAgICAgIHdoaWxlIChlbGVtID0gcmVzdWx0c1tpKytdKSB7CiAgICAgICAgICBpZiAoZWxlbSA9PT0gcmVzdWx0c1tpXSkgewogICAgICAgICAgICBqID0gZHVwbGljYXRlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICByZXN1bHRzLnNwbGljZShkdXBsaWNhdGVzW2pdLCAxKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQ2xlYXIgaW5wdXQgYWZ0ZXIgc29ydGluZyB0byByZWxlYXNlIG9iamVjdHMKICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvc2l6emxlL3B1bGwvMjI1CiAgICAgIHNvcnRJbnB1dCA9IG51bGw7CiAgICAgIHJldHVybiByZXN1bHRzOwogICAgfTsKICAgIC8qKgogICAgICogVXRpbGl0eSBmdW5jdGlvbiBmb3IgcmV0cmlldmluZyB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKICAgICAqIEBwYXJhbSB7QXJyYXl8RWxlbWVudH0gZWxlbQogICAgICovCiAgICBnZXRUZXh0ID0gU2l6emxlLmdldFRleHQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICB2YXIgbm9kZSwgcmV0ID0gJycsIGkgPSAwLCBub2RlVHlwZSA9IGVsZW0ubm9kZVR5cGU7CiAgICAgIGlmICghbm9kZVR5cGUpIHsKICAgICAgICAvLyBJZiBubyBub2RlVHlwZSwgdGhpcyBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheQogICAgICAgIHdoaWxlIChub2RlID0gZWxlbVtpKytdKSB7CiAgICAgICAgICAvLyBEbyBub3QgdHJhdmVyc2UgY29tbWVudCBub2RlcwogICAgICAgICAgcmV0ICs9IGdldFRleHQobm9kZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG5vZGVUeXBlID09PSAxIHx8IG5vZGVUeXBlID09PSA5IHx8IG5vZGVUeXBlID09PSAxMSkgewogICAgICAgIC8vIFVzZSB0ZXh0Q29udGVudCBmb3IgZWxlbWVudHMKICAgICAgICAvLyBpbm5lclRleHQgdXNhZ2UgcmVtb3ZlZCBmb3IgY29uc2lzdGVuY3kgb2YgbmV3IGxpbmVzIChqUXVlcnkgIzExMTUzKQogICAgICAgIGlmICh0eXBlb2YgZWxlbS50ZXh0Q29udGVudCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJldHVybiBlbGVtLnRleHRDb250ZW50OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBUcmF2ZXJzZSBpdHMgY2hpbGRyZW4KICAgICAgICAgIGZvciAoZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsgZWxlbTsgZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgcmV0ICs9IGdldFRleHQoZWxlbSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0KSB7CiAgICAgICAgcmV0dXJuIGVsZW0ubm9kZVZhbHVlOwogICAgICB9CiAgICAgIC8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwogICAgICByZXR1cm4gcmV0OwogICAgfTsKICAgIEV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzID0gewogICAgICAvLyBDYW4gYmUgYWRqdXN0ZWQgYnkgdGhlIHVzZXIKICAgICAgY2FjaGVMZW5ndGg6IDUwLAogICAgICBjcmVhdGVQc2V1ZG86IG1hcmtGdW5jdGlvbiwKICAgICAgbWF0Y2g6IG1hdGNoRXhwciwKICAgICAgYXR0ckhhbmRsZToge30sCiAgICAgIGZpbmQ6IHt9LAogICAgICByZWxhdGl2ZTogewogICAgICAgICc+JzogewogICAgICAgICAgZGlyOiAncGFyZW50Tm9kZScsCiAgICAgICAgICBmaXJzdDogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgJyAnOiB7IGRpcjogJ3BhcmVudE5vZGUnIH0sCiAgICAgICAgJysnOiB7CiAgICAgICAgICBkaXI6ICdwcmV2aW91c1NpYmxpbmcnLAogICAgICAgICAgZmlyc3Q6IHRydWUKICAgICAgICB9LAogICAgICAgICd+JzogeyBkaXI6ICdwcmV2aW91c1NpYmxpbmcnIH0KICAgICAgfSwKICAgICAgcHJlRmlsdGVyOiB7CiAgICAgICAgJ0FUVFInOiBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICAgIG1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSk7CiAgICAgICAgICAvLyBNb3ZlIHRoZSBnaXZlbiB2YWx1ZSB0byBtYXRjaFszXSB3aGV0aGVyIHF1b3RlZCBvciB1bnF1b3RlZAogICAgICAgICAgbWF0Y2hbM10gPSAobWF0Y2hbM10gfHwgbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgJycpLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpOwogICAgICAgICAgaWYgKG1hdGNoWzJdID09PSAnfj0nKSB7CiAgICAgICAgICAgIG1hdGNoWzNdID0gJyAnICsgbWF0Y2hbM10gKyAnICc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2guc2xpY2UoMCwgNCk7CiAgICAgICAgfSwKICAgICAgICAnQ0hJTEQnOiBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICAgIC8qIG1hdGNoZXMgZnJvbSBtYXRjaEV4cHJbIkNISUxEIl0KICAgICAgICAgIAkJMSB0eXBlIChvbmx5fG50aHwuLi4pCiAgICAgICAgICAJCTIgd2hhdCAoY2hpbGR8b2YtdHlwZSkKICAgICAgICAgIAkJMyBhcmd1bWVudCAoZXZlbnxvZGR8XGQqfFxkKm4oWystXVxkKyk/fC4uLikKICAgICAgICAgIAkJNCB4bi1jb21wb25lbnQgb2YgeG4reSBhcmd1bWVudCAoWystXT9cZCpufCkKICAgICAgICAgIAkJNSBzaWduIG9mIHhuLWNvbXBvbmVudAogICAgICAgICAgCQk2IHggb2YgeG4tY29tcG9uZW50CiAgICAgICAgICAJCTcgc2lnbiBvZiB5LWNvbXBvbmVudAogICAgICAgICAgCQk4IHkgb2YgeS1jb21wb25lbnQKICAgICAgICAgIAkqLwogICAgICAgICAgbWF0Y2hbMV0gPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYgKG1hdGNoWzFdLnNsaWNlKDAsIDMpID09PSAnbnRoJykgewogICAgICAgICAgICAvLyBudGgtKiByZXF1aXJlcyBhcmd1bWVudAogICAgICAgICAgICBpZiAoIW1hdGNoWzNdKSB7CiAgICAgICAgICAgICAgU2l6emxlLmVycm9yKG1hdGNoWzBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBudW1lcmljIHggYW5kIHkgcGFyYW1ldGVycyBmb3IgRXhwci5maWx0ZXIuQ0hJTEQKICAgICAgICAgICAgLy8gcmVtZW1iZXIgdGhhdCBmYWxzZS90cnVlIGNhc3QgcmVzcGVjdGl2ZWx5IHRvIDAvMQogICAgICAgICAgICBtYXRjaFs0XSA9ICsobWF0Y2hbNF0gPyBtYXRjaFs1XSArIChtYXRjaFs2XSB8fCAxKSA6IDIgKiAobWF0Y2hbM10gPT09ICdldmVuJyB8fCBtYXRjaFszXSA9PT0gJ29kZCcpKTsKICAgICAgICAgICAgbWF0Y2hbNV0gPSArKG1hdGNoWzddICsgbWF0Y2hbOF0gfHwgbWF0Y2hbM10gPT09ICdvZGQnKTsgIC8vIG90aGVyIHR5cGVzIHByb2hpYml0IGFyZ3VtZW50cwogICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFszXSkgewogICAgICAgICAgICBTaXp6bGUuZXJyb3IobWF0Y2hbMF0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgIH0sCiAgICAgICAgJ1BTRVVETyc6IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgdmFyIGV4Y2VzcywgdW5xdW90ZWQgPSAhbWF0Y2hbNl0gJiYgbWF0Y2hbMl07CiAgICAgICAgICBpZiAobWF0Y2hFeHByWydDSElMRCddLnRlc3QobWF0Y2hbMF0pKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgLy8gQWNjZXB0IHF1b3RlZCBhcmd1bWVudHMgYXMtaXMKICAgICAgICAgIGlmIChtYXRjaFszXSkgewogICAgICAgICAgICBtYXRjaFsyXSA9IG1hdGNoWzRdIHx8IG1hdGNoWzVdIHx8ICcnOyAgLy8gU3RyaXAgZXhjZXNzIGNoYXJhY3RlcnMgZnJvbSB1bnF1b3RlZCBhcmd1bWVudHMKICAgICAgICAgIH0gZWxzZSBpZiAodW5xdW90ZWQgJiYgcnBzZXVkby50ZXN0KHVucXVvdGVkKSAmJiAoZXhjZXNzID0gdG9rZW5pemUodW5xdW90ZWQsIHRydWUpKSAmJiAoZXhjZXNzID0gdW5xdW90ZWQuaW5kZXhPZignKScsIHVucXVvdGVkLmxlbmd0aCAtIGV4Y2VzcykgLSB1bnF1b3RlZC5sZW5ndGgpKSB7CiAgICAgICAgICAgIC8vIGV4Y2VzcyBpcyBhIG5lZ2F0aXZlIGluZGV4CiAgICAgICAgICAgIG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoMCwgZXhjZXNzKTsKICAgICAgICAgICAgbWF0Y2hbMl0gPSB1bnF1b3RlZC5zbGljZSgwLCBleGNlc3MpOwogICAgICAgICAgfQogICAgICAgICAgLy8gUmV0dXJuIG9ubHkgY2FwdHVyZXMgbmVlZGVkIGJ5IHRoZSBwc2V1ZG8gZmlsdGVyIG1ldGhvZCAodHlwZSBhbmQgYXJndW1lbnQpCiAgICAgICAgICByZXR1cm4gbWF0Y2guc2xpY2UoMCwgMyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBmaWx0ZXI6IHsKICAgICAgICAnVEFHJzogZnVuY3Rpb24gKG5vZGVOYW1lU2VsZWN0b3IpIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IG5vZGVOYW1lU2VsZWN0b3IucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZVNlbGVjdG9yID09PSAnKicgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSA6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZU5hbWU7CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgJ0NMQVNTJzogZnVuY3Rpb24gKGNsYXNzTmFtZSkgewogICAgICAgICAgdmFyIHBhdHRlcm4gPSBjbGFzc0NhY2hlW2NsYXNzTmFtZSArICcgJ107CiAgICAgICAgICByZXR1cm4gcGF0dGVybiB8fCAocGF0dGVybiA9IG5ldyBSZWdFeHAoJyhefCcgKyB3aGl0ZXNwYWNlICsgJyknICsgY2xhc3NOYW1lICsgJygnICsgd2hpdGVzcGFjZSArICd8JCknKSkgJiYgY2xhc3NDYWNoZShjbGFzc05hbWUsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBwYXR0ZXJuLnRlc3QodHlwZW9mIGVsZW0uY2xhc3NOYW1lID09PSAnc3RyaW5nJyAmJiBlbGVtLmNsYXNzTmFtZSB8fCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgIT09IHN0cnVuZGVmaW5lZCAmJiBlbGVtLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJyk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgICdBVFRSJzogZnVuY3Rpb24gKG5hbWUsIG9wZXJhdG9yLCBjaGVjaykgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBTaXp6bGUuYXR0cihlbGVtLCBuYW1lKTsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG9wZXJhdG9yID09PSAnIT0nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghb3BlcmF0b3IpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQgKz0gJyc7CiAgICAgICAgICAgIHJldHVybiBvcGVyYXRvciA9PT0gJz0nID8gcmVzdWx0ID09PSBjaGVjayA6IG9wZXJhdG9yID09PSAnIT0nID8gcmVzdWx0ICE9PSBjaGVjayA6IG9wZXJhdG9yID09PSAnXj0nID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoY2hlY2spID09PSAwIDogb3BlcmF0b3IgPT09ICcqPScgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZihjaGVjaykgPiAtMSA6IG9wZXJhdG9yID09PSAnJD0nID8gY2hlY2sgJiYgcmVzdWx0LnNsaWNlKC1jaGVjay5sZW5ndGgpID09PSBjaGVjayA6IG9wZXJhdG9yID09PSAnfj0nID8gKCcgJyArIHJlc3VsdCArICcgJykuaW5kZXhPZihjaGVjaykgPiAtMSA6IG9wZXJhdG9yID09PSAnfD0nID8gcmVzdWx0ID09PSBjaGVjayB8fCByZXN1bHQuc2xpY2UoMCwgY2hlY2subGVuZ3RoICsgMSkgPT09IGNoZWNrICsgJy0nIDogZmFsc2U7CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgJ0NISUxEJzogZnVuY3Rpb24gKHR5cGUsIHdoYXQsIGFyZ3VtZW50LCBmaXJzdCwgbGFzdCkgewogICAgICAgICAgdmFyIHNpbXBsZSA9IHR5cGUuc2xpY2UoMCwgMykgIT09ICdudGgnLCBmb3J3YXJkID0gdHlwZS5zbGljZSgtNCkgIT09ICdsYXN0Jywgb2ZUeXBlID0gd2hhdCA9PT0gJ29mLXR5cGUnOwogICAgICAgICAgcmV0dXJuIGZpcnN0ID09PSAxICYmIGxhc3QgPT09IDAgPyAvLyBTaG9ydGN1dCBmb3IgOm50aC0qKG4pCiAgICAgICAgICBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gISFlbGVtLnBhcmVudE5vZGU7CiAgICAgICAgICB9IDogZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgICAgICB2YXIgY2FjaGUsIG91dGVyQ2FjaGUsIG5vZGUsIGRpZmYsIG5vZGVJbmRleCwgc3RhcnQsIGRpciA9IHNpbXBsZSAhPT0gZm9yd2FyZCA/ICduZXh0U2libGluZycgOiAncHJldmlvdXNTaWJsaW5nJywgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlLCBuYW1lID0gb2ZUeXBlICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwgdXNlQ2FjaGUgPSAheG1sICYmICFvZlR5cGU7CiAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAvLyA6KGZpcnN0fGxhc3R8b25seSktKGNoaWxkfG9mLXR5cGUpCiAgICAgICAgICAgICAgaWYgKHNpbXBsZSkgewogICAgICAgICAgICAgICAgd2hpbGUgKGRpcikgewogICAgICAgICAgICAgICAgICBub2RlID0gZWxlbTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgPSBub2RlW2Rpcl0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAob2ZUeXBlID8gbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lIDogbm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBSZXZlcnNlIGRpcmVjdGlvbiBmb3IgOm9ubHktKiAoaWYgd2UgaGF2ZW4ndCB5ZXQgZG9uZSBzbykKICAgICAgICAgICAgICAgICAgc3RhcnQgPSBkaXIgPSB0eXBlID09PSAnb25seScgJiYgIXN0YXJ0ICYmICduZXh0U2libGluZyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhcnQgPSBbZm9yd2FyZCA/IHBhcmVudC5maXJzdENoaWxkIDogcGFyZW50Lmxhc3RDaGlsZF07CiAgICAgICAgICAgICAgLy8gbm9uLXhtbCA6bnRoLWNoaWxkKC4uLikgc3RvcmVzIGNhY2hlIGRhdGEgb24gYHBhcmVudGAKICAgICAgICAgICAgICBpZiAoZm9yd2FyZCAmJiB1c2VDYWNoZSkgewogICAgICAgICAgICAgICAgLy8gU2VlayBgZWxlbWAgZnJvbSBhIHByZXZpb3VzbHktY2FjaGVkIGluZGV4CiAgICAgICAgICAgICAgICBvdXRlckNhY2hlID0gcGFyZW50W2V4cGFuZG9dIHx8IChwYXJlbnRbZXhwYW5kb10gPSB7fSk7CiAgICAgICAgICAgICAgICBjYWNoZSA9IG91dGVyQ2FjaGVbdHlwZV0gfHwgW107CiAgICAgICAgICAgICAgICBub2RlSW5kZXggPSBjYWNoZVswXSA9PT0gZGlycnVucyAmJiBjYWNoZVsxXTsKICAgICAgICAgICAgICAgIGRpZmYgPSBjYWNoZVswXSA9PT0gZGlycnVucyAmJiBjYWNoZVsyXTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlSW5kZXggJiYgcGFyZW50LmNoaWxkTm9kZXNbbm9kZUluZGV4XTsKICAgICAgICAgICAgICAgIHdoaWxlIChub2RlID0gKytub2RlSW5kZXggJiYgbm9kZSAmJiBub2RlW2Rpcl0gfHwgKGRpZmYgPSBub2RlSW5kZXggPSAwKSB8fCBzdGFydC5wb3AoKSkgewogICAgICAgICAgICAgICAgICAvLyBXaGVuIGZvdW5kLCBjYWNoZSBpbmRleGVzIG9uIGBwYXJlbnRgIGFuZCBicmVhawogICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSAmJiArK2RpZmYgJiYgbm9kZSA9PT0gZWxlbSkgewogICAgICAgICAgICAgICAgICAgIG91dGVyQ2FjaGVbdHlwZV0gPSBbCiAgICAgICAgICAgICAgICAgICAgICBkaXJydW5zLAogICAgICAgICAgICAgICAgICAgICAgbm9kZUluZGV4LAogICAgICAgICAgICAgICAgICAgICAgZGlmZgogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gIC8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodXNlQ2FjaGUgJiYgKGNhY2hlID0gKGVsZW1bZXhwYW5kb10gfHwgKGVsZW1bZXhwYW5kb10gPSB7fSkpW3R5cGVdKSAmJiBjYWNoZVswXSA9PT0gZGlycnVucykgewogICAgICAgICAgICAgICAgZGlmZiA9IGNhY2hlWzFdOyAgLy8geG1sIDpudGgtY2hpbGQoLi4uKSBvciA6bnRoLWxhc3QtY2hpbGQoLi4uKSBvciA6bnRoKC1sYXN0KT8tb2YtdHlwZSguLi4pCiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgc2FtZSBsb29wIGFzIGFib3ZlIHRvIHNlZWsgYGVsZW1gIGZyb20gdGhlIHN0YXJ0CiAgICAgICAgICAgICAgICB3aGlsZSAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVtkaXJdIHx8IChkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpIHsKICAgICAgICAgICAgICAgICAgaWYgKChvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxKSAmJiArK2RpZmYpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWNoZSB0aGUgaW5kZXggb2YgZWFjaCBlbmNvdW50ZXJlZCBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHVzZUNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAobm9kZVtleHBhbmRvXSB8fCAobm9kZVtleHBhbmRvXSA9IHt9KSlbdHlwZV0gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgIGRpcnJ1bnMsCiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmYKICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gSW5jb3Jwb3JhdGUgdGhlIG9mZnNldCwgdGhlbiBjaGVjayBhZ2FpbnN0IGN5Y2xlIHNpemUKICAgICAgICAgICAgICBkaWZmIC09IGxhc3Q7CiAgICAgICAgICAgICAgcmV0dXJuIGRpZmYgPT09IGZpcnN0IHx8IGRpZmYgJSBmaXJzdCA9PT0gMCAmJiBkaWZmIC8gZmlyc3QgPj0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgICdQU0VVRE8nOiBmdW5jdGlvbiAocHNldWRvLCBhcmd1bWVudCkgewogICAgICAgICAgLy8gcHNldWRvLWNsYXNzIG5hbWVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlCiAgICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI3BzZXVkby1jbGFzc2VzCiAgICAgICAgICAvLyBQcmlvcml0aXplIGJ5IGNhc2Ugc2Vuc2l0aXZpdHkgaW4gY2FzZSBjdXN0b20gcHNldWRvcyBhcmUgYWRkZWQgd2l0aCB1cHBlcmNhc2UgbGV0dGVycwogICAgICAgICAgLy8gUmVtZW1iZXIgdGhhdCBzZXRGaWx0ZXJzIGluaGVyaXRzIGZyb20gcHNldWRvcwogICAgICAgICAgdmFyIGFyZ3MsIGZuID0gRXhwci5wc2V1ZG9zW3BzZXVkb10gfHwgRXhwci5zZXRGaWx0ZXJzW3BzZXVkby50b0xvd2VyQ2FzZSgpXSB8fCBTaXp6bGUuZXJyb3IoJ3Vuc3VwcG9ydGVkIHBzZXVkbzogJyArIHBzZXVkbyk7CiAgICAgICAgICAvLyBUaGUgdXNlciBtYXkgdXNlIGNyZWF0ZVBzZXVkbyB0byBpbmRpY2F0ZSB0aGF0CiAgICAgICAgICAvLyBhcmd1bWVudHMgYXJlIG5lZWRlZCB0byBjcmVhdGUgdGhlIGZpbHRlciBmdW5jdGlvbgogICAgICAgICAgLy8ganVzdCBhcyBTaXp6bGUgZG9lcwogICAgICAgICAgaWYgKGZuW2V4cGFuZG9dKSB7CiAgICAgICAgICAgIHJldHVybiBmbihhcmd1bWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBCdXQgbWFpbnRhaW4gc3VwcG9ydCBmb3Igb2xkIHNpZ25hdHVyZXMKICAgICAgICAgIGlmIChmbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIGFyZ3MgPSBbCiAgICAgICAgICAgICAgcHNldWRvLAogICAgICAgICAgICAgIHBzZXVkbywKICAgICAgICAgICAgICAnJywKICAgICAgICAgICAgICBhcmd1bWVudAogICAgICAgICAgICBdOwogICAgICAgICAgICByZXR1cm4gRXhwci5zZXRGaWx0ZXJzLmhhc093blByb3BlcnR5KHBzZXVkby50b0xvd2VyQ2FzZSgpKSA/IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoc2VlZCwgbWF0Y2hlcykgewogICAgICAgICAgICAgIHZhciBpZHgsIG1hdGNoZWQgPSBmbihzZWVkLCBhcmd1bWVudCksIGkgPSBtYXRjaGVkLmxlbmd0aDsKICAgICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgICBpZHggPSBpbmRleE9mLmNhbGwoc2VlZCwgbWF0Y2hlZFtpXSk7CiAgICAgICAgICAgICAgICBzZWVkW2lkeF0gPSAhKG1hdGNoZXNbaWR4XSA9IG1hdGNoZWRbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkgOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgIHJldHVybiBmbihlbGVtLCAwLCBhcmdzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHBzZXVkb3M6IHsKICAgICAgICAvLyBQb3RlbnRpYWxseSBjb21wbGV4IHBzZXVkb3MKICAgICAgICAnbm90JzogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgLy8gVHJpbSB0aGUgc2VsZWN0b3IgcGFzc2VkIHRvIGNvbXBpbGUKICAgICAgICAgIC8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCiAgICAgICAgICAvLyBzcGFjZXMgYXMgY29tYmluYXRvcnMKICAgICAgICAgIHZhciBpbnB1dCA9IFtdLCByZXN1bHRzID0gW10sIG1hdGNoZXIgPSBjb21waWxlKHNlbGVjdG9yLnJlcGxhY2UocnRyaW0sICckMScpKTsKICAgICAgICAgIHJldHVybiBtYXRjaGVyW2V4cGFuZG9dID8gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICAgICAgdmFyIGVsZW0sIHVubWF0Y2hlZCA9IG1hdGNoZXIoc2VlZCwgbnVsbCwgeG1sLCBbXSksIGkgPSBzZWVkLmxlbmd0aDsKICAgICAgICAgICAgLy8gTWF0Y2ggZWxlbWVudHMgdW5tYXRjaGVkIGJ5IGBtYXRjaGVyYAogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgaWYgKGVsZW0gPSB1bm1hdGNoZWRbaV0pIHsKICAgICAgICAgICAgICAgIHNlZWRbaV0gPSAhKG1hdGNoZXNbaV0gPSBlbGVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pIDogZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgICAgICBpbnB1dFswXSA9IGVsZW07CiAgICAgICAgICAgIG1hdGNoZXIoaW5wdXQsIG51bGwsIHhtbCwgcmVzdWx0cyk7CiAgICAgICAgICAgIHJldHVybiAhcmVzdWx0cy5wb3AoKTsKICAgICAgICAgIH07CiAgICAgICAgfSksCiAgICAgICAgJ2hhcyc6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gU2l6emxlKHNlbGVjdG9yLCBlbGVtKS5sZW5ndGggPiAwOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAnY29udGFpbnMnOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gKGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lclRleHQgfHwgZ2V0VGV4dChlbGVtKSkuaW5kZXhPZih0ZXh0KSA+IC0xOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAvLyAiV2hldGhlciBhbiBlbGVtZW50IGlzIHJlcHJlc2VudGVkIGJ5IGEgOmxhbmcoKSBzZWxlY3RvcgogICAgICAgIC8vIGlzIGJhc2VkIHNvbGVseSBvbiB0aGUgZWxlbWVudCdzIGxhbmd1YWdlIHZhbHVlCiAgICAgICAgLy8gYmVpbmcgZXF1YWwgdG8gdGhlIGlkZW50aWZpZXIgQywKICAgICAgICAvLyBvciBiZWdpbm5pbmcgd2l0aCB0aGUgaWRlbnRpZmllciBDIGltbWVkaWF0ZWx5IGZvbGxvd2VkIGJ5ICItIi4KICAgICAgICAvLyBUaGUgbWF0Y2hpbmcgb2YgQyBhZ2FpbnN0IHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUgaXMgcGVyZm9ybWVkIGNhc2UtaW5zZW5zaXRpdmVseS4KICAgICAgICAvLyBUaGUgaWRlbnRpZmllciBDIGRvZXMgbm90IGhhdmUgdG8gYmUgYSB2YWxpZCBsYW5ndWFnZSBuYW1lLiIKICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2xhbmctcHNldWRvCiAgICAgICAgJ2xhbmcnOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKGxhbmcpIHsKICAgICAgICAgIC8vIGxhbmcgdmFsdWUgbXVzdCBiZSBhIHZhbGlkIGlkZW50aWZpZXIKICAgICAgICAgIGlmICghcmlkZW50aWZpZXIudGVzdChsYW5nIHx8ICcnKSkgewogICAgICAgICAgICBTaXp6bGUuZXJyb3IoJ3Vuc3VwcG9ydGVkIGxhbmc6ICcgKyBsYW5nKTsKICAgICAgICAgIH0KICAgICAgICAgIGxhbmcgPSBsYW5nLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgdmFyIGVsZW1MYW5nOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKGVsZW1MYW5nID0gZG9jdW1lbnRJc0hUTUwgPyBlbGVtLmxhbmcgOiBlbGVtLmdldEF0dHJpYnV0ZSgneG1sOmxhbmcnKSB8fCBlbGVtLmdldEF0dHJpYnV0ZSgnbGFuZycpKSB7CiAgICAgICAgICAgICAgICBlbGVtTGFuZyA9IGVsZW1MYW5nLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbUxhbmcgPT09IGxhbmcgfHwgZWxlbUxhbmcuaW5kZXhPZihsYW5nICsgJy0nKSA9PT0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKChlbGVtID0gZWxlbS5wYXJlbnROb2RlKSAmJiBlbGVtLm5vZGVUeXBlID09PSAxKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAvLyBNaXNjZWxsYW5lb3VzCiAgICAgICAgJ3RhcmdldCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaDsKICAgICAgICAgIHJldHVybiBoYXNoICYmIGhhc2guc2xpY2UoMSkgPT09IGVsZW0uaWQ7CiAgICAgICAgfSwKICAgICAgICAncm9vdCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gZG9jRWxlbTsKICAgICAgICB9LAogICAgICAgICdmb2N1cyc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAoIWRvY3VtZW50Lmhhc0ZvY3VzIHx8IGRvY3VtZW50Lmhhc0ZvY3VzKCkpICYmICEhKGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXgpOwogICAgICAgIH0sCiAgICAgICAgLy8gQm9vbGVhbiBwcm9wZXJ0aWVzCiAgICAgICAgJ2VuYWJsZWQnOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgJ2Rpc2FibGVkJzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSB0cnVlOwogICAgICAgIH0sCiAgICAgICAgJ2NoZWNrZWQnOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgLy8gSW4gQ1NTMywgOmNoZWNrZWQgc2hvdWxkIHJldHVybiBib3RoIGNoZWNrZWQgYW5kIHNlbGVjdGVkIGVsZW1lbnRzCiAgICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDExL1JFQy1jc3MzLXNlbGVjdG9ycy0yMDExMDkyOS8jY2hlY2tlZAogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lID09PSAnaW5wdXQnICYmICEhZWxlbS5jaGVja2VkIHx8IG5vZGVOYW1lID09PSAnb3B0aW9uJyAmJiAhIWVsZW0uc2VsZWN0ZWQ7CiAgICAgICAgfSwKICAgICAgICAnc2VsZWN0ZWQnOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgLy8gQWNjZXNzaW5nIHRoaXMgcHJvcGVydHkgbWFrZXMgc2VsZWN0ZWQtYnktZGVmYXVsdAogICAgICAgICAgLy8gb3B0aW9ucyBpbiBTYWZhcmkgd29yayBwcm9wZXJseQogICAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOwogICAgICAgIH0sCiAgICAgICAgLy8gQ29udGVudHMKICAgICAgICAnZW1wdHknOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNlbXB0eS1wc2V1ZG8KICAgICAgICAgIC8vIDplbXB0eSBpcyBuZWdhdGVkIGJ5IGVsZW1lbnQgKDEpIG9yIGNvbnRlbnQgbm9kZXMgKHRleHQ6IDM7IGNkYXRhOiA0OyBlbnRpdHkgcmVmOiA1KSwKICAgICAgICAgIC8vICAgYnV0IG5vdCBieSBvdGhlcnMgKGNvbW1lbnQ6IDg7IHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb246IDc7IGV0Yy4pCiAgICAgICAgICAvLyBub2RlVHlwZSA8IDYgd29ya3MgYmVjYXVzZSBhdHRyaWJ1dGVzICgyKSBkbyBub3QgYXBwZWFyIGFzIGNoaWxkcmVuCiAgICAgICAgICBmb3IgKGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlIDwgNikgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICAncGFyZW50JzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiAhRXhwci5wc2V1ZG9zWydlbXB0eSddKGVsZW0pOwogICAgICAgIH0sCiAgICAgICAgLy8gRWxlbWVudC9pbnB1dCB0eXBlcwogICAgICAgICdoZWFkZXInOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIHJoZWFkZXIudGVzdChlbGVtLm5vZGVOYW1lKTsKICAgICAgICB9LAogICAgICAgICdpbnB1dCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gcmlucHV0cy50ZXN0KGVsZW0ubm9kZU5hbWUpOwogICAgICAgIH0sCiAgICAgICAgJ2J1dHRvbic6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBuYW1lID09PSAnaW5wdXQnICYmIGVsZW0udHlwZSA9PT0gJ2J1dHRvbicgfHwgbmFtZSA9PT0gJ2J1dHRvbic7CiAgICAgICAgfSwKICAgICAgICAndGV4dCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgYXR0cjsKICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdpbnB1dCcgJiYgZWxlbS50eXBlID09PSAndGV4dCcgJiYgKChhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGUoJ3R5cGUnKSkgPT0gbnVsbCB8fCBhdHRyLnRvTG93ZXJDYXNlKCkgPT09ICd0ZXh0Jyk7CiAgICAgICAgfSwKICAgICAgICAvLyBQb3NpdGlvbi1pbi1jb2xsZWN0aW9uCiAgICAgICAgJ2ZpcnN0JzogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gWzBdOwogICAgICAgIH0pLAogICAgICAgICdsYXN0JzogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBbbGVuZ3RoIC0gMV07CiAgICAgICAgfSksCiAgICAgICAgJ2VxJzogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50KSB7CiAgICAgICAgICByZXR1cm4gW2FyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnRdOwogICAgICAgIH0pLAogICAgICAgICdldmVuJzogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgpIHsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pLAogICAgICAgICdvZGQnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCkgewogICAgICAgICAgdmFyIGkgPSAxOwogICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICBtYXRjaEluZGV4ZXMucHVzaChpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICAgICAgfSksCiAgICAgICAgJ2x0JzogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50KSB7CiAgICAgICAgICB2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7CiAgICAgICAgICBmb3IgKDsgLS1pID49IDA7KSB7CiAgICAgICAgICAgIG1hdGNoSW5kZXhlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoSW5kZXhlczsKICAgICAgICB9KSwKICAgICAgICAnZ3QnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQpIHsKICAgICAgICAgIHZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudDsKICAgICAgICAgIGZvciAoOyArK2kgPCBsZW5ndGg7KSB7CiAgICAgICAgICAgIG1hdGNoSW5kZXhlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoSW5kZXhlczsKICAgICAgICB9KQogICAgICB9CiAgICB9OwogICAgRXhwci5wc2V1ZG9zWydudGgnXSA9IEV4cHIucHNldWRvc1snZXEnXTsKICAgIC8vIEFkZCBidXR0b24vaW5wdXQgdHlwZSBwc2V1ZG9zCiAgICBmb3IgKGkgaW4gewogICAgICAgIHJhZGlvOiB0cnVlLAogICAgICAgIGNoZWNrYm94OiB0cnVlLAogICAgICAgIGZpbGU6IHRydWUsCiAgICAgICAgcGFzc3dvcmQ6IHRydWUsCiAgICAgICAgaW1hZ2U6IHRydWUKICAgICAgfSkgewogICAgICBFeHByLnBzZXVkb3NbaV0gPSBjcmVhdGVJbnB1dFBzZXVkbyhpKTsKICAgIH0KICAgIGZvciAoaSBpbiB7CiAgICAgICAgc3VibWl0OiB0cnVlLAogICAgICAgIHJlc2V0OiB0cnVlCiAgICAgIH0pIHsKICAgICAgRXhwci5wc2V1ZG9zW2ldID0gY3JlYXRlQnV0dG9uUHNldWRvKGkpOwogICAgfQogICAgLy8gRWFzeSBBUEkgZm9yIGNyZWF0aW5nIG5ldyBzZXRGaWx0ZXJzCiAgICBmdW5jdGlvbiBzZXRGaWx0ZXJzKCkgewogICAgfQogICAgc2V0RmlsdGVycy5wcm90b3R5cGUgPSBFeHByLmZpbHRlcnMgPSBFeHByLnBzZXVkb3M7CiAgICBFeHByLnNldEZpbHRlcnMgPSBuZXcgc2V0RmlsdGVycygpOwogICAgdG9rZW5pemUgPSBTaXp6bGUudG9rZW5pemUgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIHBhcnNlT25seSkgewogICAgICB2YXIgbWF0Y2hlZCwgbWF0Y2gsIHRva2VucywgdHlwZSwgc29GYXIsIGdyb3VwcywgcHJlRmlsdGVycywgY2FjaGVkID0gdG9rZW5DYWNoZVtzZWxlY3RvciArICcgJ107CiAgICAgIGlmIChjYWNoZWQpIHsKICAgICAgICByZXR1cm4gcGFyc2VPbmx5ID8gMCA6IGNhY2hlZC5zbGljZSgwKTsKICAgICAgfQogICAgICBzb0ZhciA9IHNlbGVjdG9yOwogICAgICBncm91cHMgPSBbXTsKICAgICAgcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyOwogICAgICB3aGlsZSAoc29GYXIpIHsKICAgICAgICAvLyBDb21tYSBhbmQgZmlyc3QgcnVuCiAgICAgICAgaWYgKCFtYXRjaGVkIHx8IChtYXRjaCA9IHJjb21tYS5leGVjKHNvRmFyKSkpIHsKICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAvLyBEb24ndCBjb25zdW1lIHRyYWlsaW5nIGNvbW1hcyBhcyB2YWxpZAogICAgICAgICAgICBzb0ZhciA9IHNvRmFyLnNsaWNlKG1hdGNoWzBdLmxlbmd0aCkgfHwgc29GYXI7CiAgICAgICAgICB9CiAgICAgICAgICBncm91cHMucHVzaCh0b2tlbnMgPSBbXSk7CiAgICAgICAgfQogICAgICAgIG1hdGNoZWQgPSBmYWxzZTsKICAgICAgICAvLyBDb21iaW5hdG9ycwogICAgICAgIGlmIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKHNvRmFyKSkgewogICAgICAgICAgbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CiAgICAgICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgICAgIHZhbHVlOiBtYXRjaGVkLAogICAgICAgICAgICAvLyBDYXN0IGRlc2NlbmRhbnQgY29tYmluYXRvcnMgdG8gc3BhY2UKICAgICAgICAgICAgdHlwZTogbWF0Y2hbMF0ucmVwbGFjZShydHJpbSwgJyAnKQogICAgICAgICAgfSk7CiAgICAgICAgICBzb0ZhciA9IHNvRmFyLnNsaWNlKG1hdGNoZWQubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgLy8gRmlsdGVycwogICAgICAgIGZvciAodHlwZSBpbiBFeHByLmZpbHRlcikgewogICAgICAgICAgaWYgKChtYXRjaCA9IG1hdGNoRXhwclt0eXBlXS5leGVjKHNvRmFyKSkgJiYgKCFwcmVGaWx0ZXJzW3R5cGVdIHx8IChtYXRjaCA9IHByZUZpbHRlcnNbdHlwZV0obWF0Y2gpKSkpIHsKICAgICAgICAgICAgbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CiAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICB2YWx1ZTogbWF0Y2hlZCwKICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgIG1hdGNoZXM6IG1hdGNoCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzb0ZhciA9IHNvRmFyLnNsaWNlKG1hdGNoZWQubGVuZ3RoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFtYXRjaGVkKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gUmV0dXJuIHRoZSBsZW5ndGggb2YgdGhlIGludmFsaWQgZXhjZXNzCiAgICAgIC8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwogICAgICAvLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yIG9yIHJldHVybiB0b2tlbnMKICAgICAgcmV0dXJuIHBhcnNlT25seSA/IHNvRmFyLmxlbmd0aCA6IHNvRmFyID8gU2l6emxlLmVycm9yKHNlbGVjdG9yKSA6IC8vIENhY2hlIHRoZSB0b2tlbnMKICAgICAgdG9rZW5DYWNoZShzZWxlY3RvciwgZ3JvdXBzKS5zbGljZSgwKTsKICAgIH07CiAgICBmdW5jdGlvbiB0b1NlbGVjdG9yKHRva2VucykgewogICAgICB2YXIgaSA9IDAsIGxlbiA9IHRva2Vucy5sZW5ndGgsIHNlbGVjdG9yID0gJyc7CiAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBzZWxlY3RvciArPSB0b2tlbnNbaV0udmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHNlbGVjdG9yOwogICAgfQogICAgZnVuY3Rpb24gYWRkQ29tYmluYXRvcihtYXRjaGVyLCBjb21iaW5hdG9yLCBiYXNlKSB7CiAgICAgIHZhciBkaXIgPSBjb21iaW5hdG9yLmRpciwgY2hlY2tOb25FbGVtZW50cyA9IGJhc2UgJiYgZGlyID09PSAncGFyZW50Tm9kZScsIGRvbmVOYW1lID0gZG9uZSsrOwogICAgICByZXR1cm4gY29tYmluYXRvci5maXJzdCA/IC8vIENoZWNrIGFnYWluc3QgY2xvc2VzdCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudAogICAgICBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgd2hpbGUgKGVsZW0gPSBlbGVtW2Rpcl0pIHsKICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMpIHsKICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXIoZWxlbSwgY29udGV4dCwgeG1sKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gOiAvLyBDaGVjayBhZ2FpbnN0IGFsbCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudHMKICAgICAgZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgIHZhciBvbGRDYWNoZSwgb3V0ZXJDYWNoZSwgbmV3Q2FjaGUgPSBbCiAgICAgICAgICAgIGRpcnJ1bnMsCiAgICAgICAgICAgIGRvbmVOYW1lCiAgICAgICAgICBdOwogICAgICAgIC8vIFdlIGNhbid0IHNldCBhcmJpdHJhcnkgZGF0YSBvbiBYTUwgbm9kZXMsIHNvIHRoZXkgZG9uJ3QgYmVuZWZpdCBmcm9tIGRpciBjYWNoaW5nCiAgICAgICAgaWYgKHhtbCkgewogICAgICAgICAgd2hpbGUgKGVsZW0gPSBlbGVtW2Rpcl0pIHsKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cykgewogICAgICAgICAgICAgIGlmIChtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1bZGlyXSkgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzKSB7CiAgICAgICAgICAgICAgb3V0ZXJDYWNoZSA9IGVsZW1bZXhwYW5kb10gfHwgKGVsZW1bZXhwYW5kb10gPSB7fSk7CiAgICAgICAgICAgICAgaWYgKChvbGRDYWNoZSA9IG91dGVyQ2FjaGVbZGlyXSkgJiYgb2xkQ2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgb2xkQ2FjaGVbMV0gPT09IGRvbmVOYW1lKSB7CiAgICAgICAgICAgICAgICAvLyBBc3NpZ24gdG8gbmV3Q2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cwogICAgICAgICAgICAgICAgcmV0dXJuIG5ld0NhY2hlWzJdID0gb2xkQ2FjaGVbMl07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJldXNlIG5ld2NhY2hlIHNvIHJlc3VsdHMgYmFjay1wcm9wYWdhdGUgdG8gcHJldmlvdXMgZWxlbWVudHMKICAgICAgICAgICAgICAgIG91dGVyQ2FjaGVbZGlyXSA9IG5ld0NhY2hlOwogICAgICAgICAgICAgICAgLy8gQSBtYXRjaCBtZWFucyB3ZSdyZSBkb25lOyBhIGZhaWwgbWVhbnMgd2UgaGF2ZSB0byBrZWVwIGNoZWNraW5nCiAgICAgICAgICAgICAgICBpZiAobmV3Q2FjaGVbMl0gPSBtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gZWxlbWVudE1hdGNoZXIobWF0Y2hlcnMpIHsKICAgICAgcmV0dXJuIG1hdGNoZXJzLmxlbmd0aCA+IDEgPyBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgdmFyIGkgPSBtYXRjaGVycy5sZW5ndGg7CiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgaWYgKCFtYXRjaGVyc1tpXShlbGVtLCBjb250ZXh0LCB4bWwpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gOiBtYXRjaGVyc1swXTsKICAgIH0KICAgIGZ1bmN0aW9uIG11bHRpcGxlQ29udGV4dHMoc2VsZWN0b3IsIGNvbnRleHRzLCByZXN1bHRzKSB7CiAgICAgIHZhciBpID0gMCwgbGVuID0gY29udGV4dHMubGVuZ3RoOwogICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgU2l6emxlKHNlbGVjdG9yLCBjb250ZXh0c1tpXSwgcmVzdWx0cyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9CiAgICBmdW5jdGlvbiBjb25kZW5zZSh1bm1hdGNoZWQsIG1hcCwgZmlsdGVyLCBjb250ZXh0LCB4bWwpIHsKICAgICAgdmFyIGVsZW0sIG5ld1VubWF0Y2hlZCA9IFtdLCBpID0gMCwgbGVuID0gdW5tYXRjaGVkLmxlbmd0aCwgbWFwcGVkID0gbWFwICE9IG51bGw7CiAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgewogICAgICAgICAgaWYgKCFmaWx0ZXIgfHwgZmlsdGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgbmV3VW5tYXRjaGVkLnB1c2goZWxlbSk7CiAgICAgICAgICAgIGlmIChtYXBwZWQpIHsKICAgICAgICAgICAgICBtYXAucHVzaChpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbmV3VW5tYXRjaGVkOwogICAgfQogICAgZnVuY3Rpb24gc2V0TWF0Y2hlcihwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IpIHsKICAgICAgaWYgKHBvc3RGaWx0ZXIgJiYgIXBvc3RGaWx0ZXJbZXhwYW5kb10pIHsKICAgICAgICBwb3N0RmlsdGVyID0gc2V0TWF0Y2hlcihwb3N0RmlsdGVyKTsKICAgICAgfQogICAgICBpZiAocG9zdEZpbmRlciAmJiAhcG9zdEZpbmRlcltleHBhbmRvXSkgewogICAgICAgIHBvc3RGaW5kZXIgPSBzZXRNYXRjaGVyKHBvc3RGaW5kZXIsIHBvc3RTZWxlY3Rvcik7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoc2VlZCwgcmVzdWx0cywgY29udGV4dCwgeG1sKSB7CiAgICAgICAgdmFyIHRlbXAsIGksIGVsZW0sIHByZU1hcCA9IFtdLCBwb3N0TWFwID0gW10sIHByZWV4aXN0aW5nID0gcmVzdWx0cy5sZW5ndGgsCiAgICAgICAgICAvLyBHZXQgaW5pdGlhbCBlbGVtZW50cyBmcm9tIHNlZWQgb3IgY29udGV4dAogICAgICAgICAgZWxlbXMgPSBzZWVkIHx8IG11bHRpcGxlQ29udGV4dHMoc2VsZWN0b3IgfHwgJyonLCBjb250ZXh0Lm5vZGVUeXBlID8gW2NvbnRleHRdIDogY29udGV4dCwgW10pLAogICAgICAgICAgLy8gUHJlZmlsdGVyIHRvIGdldCBtYXRjaGVyIGlucHV0LCBwcmVzZXJ2aW5nIGEgbWFwIGZvciBzZWVkLXJlc3VsdHMgc3luY2hyb25pemF0aW9uCiAgICAgICAgICBtYXRjaGVySW4gPSBwcmVGaWx0ZXIgJiYgKHNlZWQgfHwgIXNlbGVjdG9yKSA/IGNvbmRlbnNlKGVsZW1zLCBwcmVNYXAsIHByZUZpbHRlciwgY29udGV4dCwgeG1sKSA6IGVsZW1zLCBtYXRjaGVyT3V0ID0gbWF0Y2hlciA/IC8vIElmIHdlIGhhdmUgYSBwb3N0RmluZGVyLCBvciBmaWx0ZXJlZCBzZWVkLCBvciBub24tc2VlZCBwb3N0RmlsdGVyIG9yIHByZWV4aXN0aW5nIHJlc3VsdHMsCiAgICAgICAgICBwb3N0RmluZGVyIHx8IChzZWVkID8gcHJlRmlsdGVyIDogcHJlZXhpc3RpbmcgfHwgcG9zdEZpbHRlcikgPyAvLyAuLi5pbnRlcm1lZGlhdGUgcHJvY2Vzc2luZyBpcyBuZWNlc3NhcnkKICAgICAgICAgIFtdIDogLy8gLi4ub3RoZXJ3aXNlIHVzZSByZXN1bHRzIGRpcmVjdGx5CiAgICAgICAgICByZXN1bHRzIDogbWF0Y2hlckluOwogICAgICAgIC8vIEZpbmQgcHJpbWFyeSBtYXRjaGVzCiAgICAgICAgaWYgKG1hdGNoZXIpIHsKICAgICAgICAgIG1hdGNoZXIobWF0Y2hlckluLCBtYXRjaGVyT3V0LCBjb250ZXh0LCB4bWwpOwogICAgICAgIH0KICAgICAgICAvLyBBcHBseSBwb3N0RmlsdGVyCiAgICAgICAgaWYgKHBvc3RGaWx0ZXIpIHsKICAgICAgICAgIHRlbXAgPSBjb25kZW5zZShtYXRjaGVyT3V0LCBwb3N0TWFwKTsKICAgICAgICAgIHBvc3RGaWx0ZXIodGVtcCwgW10sIGNvbnRleHQsIHhtbCk7CiAgICAgICAgICAvLyBVbi1tYXRjaCBmYWlsaW5nIGVsZW1lbnRzIGJ5IG1vdmluZyB0aGVtIGJhY2sgdG8gbWF0Y2hlckluCiAgICAgICAgICBpID0gdGVtcC5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIGlmIChlbGVtID0gdGVtcFtpXSkgewogICAgICAgICAgICAgIG1hdGNoZXJPdXRbcG9zdE1hcFtpXV0gPSAhKG1hdGNoZXJJbltwb3N0TWFwW2ldXSA9IGVsZW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChzZWVkKSB7CiAgICAgICAgICBpZiAocG9zdEZpbmRlciB8fCBwcmVGaWx0ZXIpIHsKICAgICAgICAgICAgaWYgKHBvc3RGaW5kZXIpIHsKICAgICAgICAgICAgICAvLyBHZXQgdGhlIGZpbmFsIG1hdGNoZXJPdXQgYnkgY29uZGVuc2luZyB0aGlzIGludGVybWVkaWF0ZSBpbnRvIHBvc3RGaW5kZXIgY29udGV4dHMKICAgICAgICAgICAgICB0ZW1wID0gW107CiAgICAgICAgICAgICAgaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwogICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtID0gbWF0Y2hlck91dFtpXSkgewogICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIG1hdGNoZXJJbiBzaW5jZSBlbGVtIGlzIG5vdCB5ZXQgYSBmaW5hbCBtYXRjaAogICAgICAgICAgICAgICAgICB0ZW1wLnB1c2gobWF0Y2hlckluW2ldID0gZWxlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBvc3RGaW5kZXIobnVsbCwgbWF0Y2hlck91dCA9IFtdLCB0ZW1wLCB4bWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vdmUgbWF0Y2hlZCBlbGVtZW50cyBmcm9tIHNlZWQgdG8gcmVzdWx0cyB0byBrZWVwIHRoZW0gc3luY2hyb25pemVkCiAgICAgICAgICAgIGkgPSBtYXRjaGVyT3V0Lmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgIGlmICgoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICYmICh0ZW1wID0gcG9zdEZpbmRlciA/IGluZGV4T2YuY2FsbChzZWVkLCBlbGVtKSA6IHByZU1hcFtpXSkgPiAtMSkgewogICAgICAgICAgICAgICAgc2VlZFt0ZW1wXSA9ICEocmVzdWx0c1t0ZW1wXSA9IGVsZW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSAgLy8gQWRkIGVsZW1lbnRzIHRvIHJlc3VsdHMsIHRocm91Z2ggcG9zdEZpbmRlciBpZiBkZWZpbmVkCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1hdGNoZXJPdXQgPSBjb25kZW5zZShtYXRjaGVyT3V0ID09PSByZXN1bHRzID8gbWF0Y2hlck91dC5zcGxpY2UocHJlZXhpc3RpbmcsIG1hdGNoZXJPdXQubGVuZ3RoKSA6IG1hdGNoZXJPdXQpOwogICAgICAgICAgaWYgKHBvc3RGaW5kZXIpIHsKICAgICAgICAgICAgcG9zdEZpbmRlcihudWxsLCByZXN1bHRzLCBtYXRjaGVyT3V0LCB4bWwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBtYXRjaGVyT3V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gbWF0Y2hlckZyb21Ub2tlbnModG9rZW5zKSB7CiAgICAgIHZhciBjaGVja0NvbnRleHQsIG1hdGNoZXIsIGosIGxlbiA9IHRva2Vucy5sZW5ndGgsIGxlYWRpbmdSZWxhdGl2ZSA9IEV4cHIucmVsYXRpdmVbdG9rZW5zWzBdLnR5cGVdLCBpbXBsaWNpdFJlbGF0aXZlID0gbGVhZGluZ1JlbGF0aXZlIHx8IEV4cHIucmVsYXRpdmVbJyAnXSwgaSA9IGxlYWRpbmdSZWxhdGl2ZSA/IDEgOiAwLAogICAgICAgIC8vIFRoZSBmb3VuZGF0aW9uYWwgbWF0Y2hlciBlbnN1cmVzIHRoYXQgZWxlbWVudHMgYXJlIHJlYWNoYWJsZSBmcm9tIHRvcC1sZXZlbCBjb250ZXh0KHMpCiAgICAgICAgbWF0Y2hDb250ZXh0ID0gYWRkQ29tYmluYXRvcihmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsKICAgICAgICB9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlKSwgbWF0Y2hBbnlDb250ZXh0ID0gYWRkQ29tYmluYXRvcihmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbChjaGVja0NvbnRleHQsIGVsZW0pID4gLTE7CiAgICAgICAgfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSksIG1hdGNoZXJzID0gW2Z1bmN0aW9uIChlbGVtLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICAgICAgcmV0dXJuICFsZWFkaW5nUmVsYXRpdmUgJiYgKHhtbCB8fCBjb250ZXh0ICE9PSBvdXRlcm1vc3RDb250ZXh0KSB8fCAoKGNoZWNrQ29udGV4dCA9IGNvbnRleHQpLm5vZGVUeXBlID8gbWF0Y2hDb250ZXh0KGVsZW0sIGNvbnRleHQsIHhtbCkgOiBtYXRjaEFueUNvbnRleHQoZWxlbSwgY29udGV4dCwgeG1sKSk7CiAgICAgICAgICB9XTsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmIChtYXRjaGVyID0gRXhwci5yZWxhdGl2ZVt0b2tlbnNbaV0udHlwZV0pIHsKICAgICAgICAgIG1hdGNoZXJzID0gW2FkZENvbWJpbmF0b3IoZWxlbWVudE1hdGNoZXIobWF0Y2hlcnMpLCBtYXRjaGVyKV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1hdGNoZXIgPSBFeHByLmZpbHRlclt0b2tlbnNbaV0udHlwZV0uYXBwbHkobnVsbCwgdG9rZW5zW2ldLm1hdGNoZXMpOwogICAgICAgICAgLy8gUmV0dXJuIHNwZWNpYWwgdXBvbiBzZWVpbmcgYSBwb3NpdGlvbmFsIG1hdGNoZXIKICAgICAgICAgIGlmIChtYXRjaGVyW2V4cGFuZG9dKSB7CiAgICAgICAgICAgIC8vIEZpbmQgdGhlIG5leHQgcmVsYXRpdmUgb3BlcmF0b3IgKGlmIGFueSkgZm9yIHByb3BlciBoYW5kbGluZwogICAgICAgICAgICBqID0gKytpOwogICAgICAgICAgICBmb3IgKDsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICAgICAgaWYgKEV4cHIucmVsYXRpdmVbdG9rZW5zW2pdLnR5cGVdKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNldE1hdGNoZXIoaSA+IDEgJiYgZWxlbWVudE1hdGNoZXIobWF0Y2hlcnMpLCBpID4gMSAmJiB0b1NlbGVjdG9yKC8vIElmIHRoZSBwcmVjZWRpbmcgdG9rZW4gd2FzIGEgZGVzY2VuZGFudCBjb21iaW5hdG9yLCBpbnNlcnQgYW4gaW1wbGljaXQgYW55LWVsZW1lbnQgYCpgCiAgICAgICAgICAgIHRva2Vucy5zbGljZSgwLCBpIC0gMSkuY29uY2F0KHsgdmFsdWU6IHRva2Vuc1tpIC0gMl0udHlwZSA9PT0gJyAnID8gJyonIDogJycgfSkpLnJlcGxhY2UocnRyaW0sICckMScpLCBtYXRjaGVyLCBpIDwgaiAmJiBtYXRjaGVyRnJvbVRva2Vucyh0b2tlbnMuc2xpY2UoaSwgaikpLCBqIDwgbGVuICYmIG1hdGNoZXJGcm9tVG9rZW5zKHRva2VucyA9IHRva2Vucy5zbGljZShqKSksIGogPCBsZW4gJiYgdG9TZWxlY3Rvcih0b2tlbnMpKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hdGNoZXJzLnB1c2gobWF0Y2hlcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBlbGVtZW50TWF0Y2hlcihtYXRjaGVycyk7CiAgICB9CiAgICBmdW5jdGlvbiBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycykgewogICAgICB2YXIgYnlTZXQgPSBzZXRNYXRjaGVycy5sZW5ndGggPiAwLCBieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwgc3VwZXJNYXRjaGVyID0gZnVuY3Rpb24gKHNlZWQsIGNvbnRleHQsIHhtbCwgcmVzdWx0cywgb3V0ZXJtb3N0KSB7CiAgICAgICAgICB2YXIgZWxlbSwgaiwgbWF0Y2hlciwgbWF0Y2hlZENvdW50ID0gMCwgaSA9ICcwJywgdW5tYXRjaGVkID0gc2VlZCAmJiBbXSwgc2V0TWF0Y2hlZCA9IFtdLCBjb250ZXh0QmFja3VwID0gb3V0ZXJtb3N0Q29udGV4dCwKICAgICAgICAgICAgLy8gV2UgbXVzdCBhbHdheXMgaGF2ZSBlaXRoZXIgc2VlZCBlbGVtZW50cyBvciBvdXRlcm1vc3QgY29udGV4dAogICAgICAgICAgICBlbGVtcyA9IHNlZWQgfHwgYnlFbGVtZW50ICYmIEV4cHIuZmluZFsnVEFHJ10oJyonLCBvdXRlcm1vc3QpLAogICAgICAgICAgICAvLyBVc2UgaW50ZWdlciBkaXJydW5zIGlmZiB0aGlzIGlzIHRoZSBvdXRlcm1vc3QgbWF0Y2hlcgogICAgICAgICAgICBkaXJydW5zVW5pcXVlID0gZGlycnVucyArPSBjb250ZXh0QmFja3VwID09IG51bGwgPyAxIDogTWF0aC5yYW5kb20oKSB8fCAwLjEsIGxlbiA9IGVsZW1zLmxlbmd0aDsKICAgICAgICAgIGlmIChvdXRlcm1vc3QpIHsKICAgICAgICAgICAgb3V0ZXJtb3N0Q29udGV4dCA9IGNvbnRleHQgIT09IGRvY3VtZW50ICYmIGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBBZGQgZWxlbWVudHMgcGFzc2luZyBlbGVtZW50TWF0Y2hlcnMgZGlyZWN0bHkgdG8gcmVzdWx0cwogICAgICAgICAgLy8gS2VlcCBgaWAgYSBzdHJpbmcgaWYgdGhlcmUgYXJlIG5vIGVsZW1lbnRzIHNvIGBtYXRjaGVkQ291bnRgIHdpbGwgYmUgIjAwIiBiZWxvdwogICAgICAgICAgLy8gU3VwcG9ydDogSUU8OSwgU2FmYXJpCiAgICAgICAgICAvLyBUb2xlcmF0ZSBOb2RlTGlzdCBwcm9wZXJ0aWVzIChJRTogImxlbmd0aCI7IFNhZmFyaTogPG51bWJlcj4pIG1hdGNoaW5nIGVsZW1lbnRzIGJ5IGlkCiAgICAgICAgICBmb3IgKDsgaSAhPT0gbGVuICYmIChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgICAgICBpZiAoYnlFbGVtZW50ICYmIGVsZW0pIHsKICAgICAgICAgICAgICBqID0gMDsKICAgICAgICAgICAgICB3aGlsZSAobWF0Y2hlciA9IGVsZW1lbnRNYXRjaGVyc1tqKytdKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcihlbGVtLCBjb250ZXh0LCB4bWwpKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChlbGVtKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChvdXRlcm1vc3QpIHsKICAgICAgICAgICAgICAgIGRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBUcmFjayB1bm1hdGNoZWQgZWxlbWVudHMgZm9yIHNldCBmaWx0ZXJzCiAgICAgICAgICAgIGlmIChieVNldCkgewogICAgICAgICAgICAgIC8vIFRoZXkgd2lsbCBoYXZlIGdvbmUgdGhyb3VnaCBhbGwgcG9zc2libGUgbWF0Y2hlcnMKICAgICAgICAgICAgICBpZiAoZWxlbSA9ICFtYXRjaGVyICYmIGVsZW0pIHsKICAgICAgICAgICAgICAgIG1hdGNoZWRDb3VudC0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBMZW5ndGhlbiB0aGUgYXJyYXkgZm9yIGV2ZXJ5IGVsZW1lbnQsIG1hdGNoZWQgb3Igbm90CiAgICAgICAgICAgICAgaWYgKHNlZWQpIHsKICAgICAgICAgICAgICAgIHVubWF0Y2hlZC5wdXNoKGVsZW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gQXBwbHkgc2V0IGZpbHRlcnMgdG8gdW5tYXRjaGVkIGVsZW1lbnRzCiAgICAgICAgICBtYXRjaGVkQ291bnQgKz0gaTsKICAgICAgICAgIGlmIChieVNldCAmJiBpICE9PSBtYXRjaGVkQ291bnQpIHsKICAgICAgICAgICAgaiA9IDA7CiAgICAgICAgICAgIHdoaWxlIChtYXRjaGVyID0gc2V0TWF0Y2hlcnNbaisrXSkgewogICAgICAgICAgICAgIG1hdGNoZXIodW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzZWVkKSB7CiAgICAgICAgICAgICAgLy8gUmVpbnRlZ3JhdGUgZWxlbWVudCBtYXRjaGVzIHRvIGVsaW1pbmF0ZSB0aGUgbmVlZCBmb3Igc29ydGluZwogICAgICAgICAgICAgIGlmIChtYXRjaGVkQ291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgICAgIGlmICghKHVubWF0Y2hlZFtpXSB8fCBzZXRNYXRjaGVkW2ldKSkgewogICAgICAgICAgICAgICAgICAgIHNldE1hdGNoZWRbaV0gPSBwb3AuY2FsbChyZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBEaXNjYXJkIGluZGV4IHBsYWNlaG9sZGVyIHZhbHVlcyB0byBnZXQgb25seSBhY3R1YWwgbWF0Y2hlcwogICAgICAgICAgICAgIHNldE1hdGNoZWQgPSBjb25kZW5zZShzZXRNYXRjaGVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBBZGQgbWF0Y2hlcyB0byByZXN1bHRzCiAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgc2V0TWF0Y2hlZCk7CiAgICAgICAgICAgIC8vIFNlZWRsZXNzIHNldCBtYXRjaGVzIHN1Y2NlZWRpbmcgbXVsdGlwbGUgc3VjY2Vzc2Z1bCBtYXRjaGVycyBzdGlwdWxhdGUgc29ydGluZwogICAgICAgICAgICBpZiAob3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJiBtYXRjaGVkQ291bnQgKyBzZXRNYXRjaGVycy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgU2l6emxlLnVuaXF1ZVNvcnQocmVzdWx0cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIE92ZXJyaWRlIG1hbmlwdWxhdGlvbiBvZiBnbG9iYWxzIGJ5IG5lc3RlZCBtYXRjaGVycwogICAgICAgICAgaWYgKG91dGVybW9zdCkgewogICAgICAgICAgICBkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsKICAgICAgICAgICAgb3V0ZXJtb3N0Q29udGV4dCA9IGNvbnRleHRCYWNrdXA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdW5tYXRjaGVkOwogICAgICAgIH07CiAgICAgIHJldHVybiBieVNldCA/IG1hcmtGdW5jdGlvbihzdXBlck1hdGNoZXIpIDogc3VwZXJNYXRjaGVyOwogICAgfQogICAgY29tcGlsZSA9IFNpenpsZS5jb21waWxlID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBtYXRjaCkgewogICAgICB2YXIgaSwgc2V0TWF0Y2hlcnMgPSBbXSwgZWxlbWVudE1hdGNoZXJzID0gW10sIGNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbc2VsZWN0b3IgKyAnICddOwogICAgICBpZiAoIWNhY2hlZCkgewogICAgICAgIC8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAogICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgIG1hdGNoID0gdG9rZW5pemUoc2VsZWN0b3IpOwogICAgICAgIH0KICAgICAgICBpID0gbWF0Y2gubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGNhY2hlZCA9IG1hdGNoZXJGcm9tVG9rZW5zKG1hdGNoW2ldKTsKICAgICAgICAgIGlmIChjYWNoZWRbZXhwYW5kb10pIHsKICAgICAgICAgICAgc2V0TWF0Y2hlcnMucHVzaChjYWNoZWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbWVudE1hdGNoZXJzLnB1c2goY2FjaGVkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gQ2FjaGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uCiAgICAgICAgY2FjaGVkID0gY29tcGlsZXJDYWNoZShzZWxlY3RvciwgbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMpKTsKICAgICAgICAvLyBTYXZlIHNlbGVjdG9yIGFuZCB0b2tlbml6YXRpb24KICAgICAgICBjYWNoZWQuc2VsZWN0b3IgPSBzZWxlY3RvcjsKICAgICAgfQogICAgICByZXR1cm4gY2FjaGVkOwogICAgfTsKICAgIC8qKgogICAgICogQSBsb3ctbGV2ZWwgc2VsZWN0aW9uIGZ1bmN0aW9uIHRoYXQgd29ya3Mgd2l0aCBTaXp6bGUncyBjb21waWxlZAogICAgICogIHNlbGVjdG9yIGZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IHNlbGVjdG9yIEEgc2VsZWN0b3Igb3IgYSBwcmUtY29tcGlsZWQKICAgICAqICBzZWxlY3RvciBmdW5jdGlvbiBidWlsdCB3aXRoIFNpenpsZS5jb21waWxlCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGNvbnRleHQKICAgICAqIEBwYXJhbSB7QXJyYXl9IFtyZXN1bHRzXQogICAgICogQHBhcmFtIHtBcnJheX0gW3NlZWRdIEEgc2V0IG9mIGVsZW1lbnRzIHRvIG1hdGNoIGFnYWluc3QKICAgICAqLwogICAgc2VsZWN0ID0gU2l6emxlLnNlbGVjdCA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCkgewogICAgICB2YXIgaSwgdG9rZW5zLCB0b2tlbiwgdHlwZSwgZmluZCwgY29tcGlsZWQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICdmdW5jdGlvbicgJiYgc2VsZWN0b3IsIG1hdGNoID0gIXNlZWQgJiYgdG9rZW5pemUoc2VsZWN0b3IgPSBjb21waWxlZC5zZWxlY3RvciB8fCBzZWxlY3Rvcik7CiAgICAgIHJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwogICAgICAvLyBUcnkgdG8gbWluaW1pemUgb3BlcmF0aW9ucyBpZiB0aGVyZSBpcyBubyBzZWVkIGFuZCBvbmx5IG9uZSBncm91cAogICAgICBpZiAobWF0Y2gubGVuZ3RoID09PSAxKSB7CiAgICAgICAgLy8gVGFrZSBhIHNob3J0Y3V0IGFuZCBzZXQgdGhlIGNvbnRleHQgaWYgdGhlIHJvb3Qgc2VsZWN0b3IgaXMgYW4gSUQKICAgICAgICB0b2tlbnMgPSBtYXRjaFswXSA9IG1hdGNoWzBdLnNsaWNlKDApOwogICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID4gMiAmJiAodG9rZW4gPSB0b2tlbnNbMF0pLnR5cGUgPT09ICdJRCcgJiYgc3VwcG9ydC5nZXRCeUlkICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDkgJiYgZG9jdW1lbnRJc0hUTUwgJiYgRXhwci5yZWxhdGl2ZVt0b2tlbnNbMV0udHlwZV0pIHsKICAgICAgICAgIGNvbnRleHQgPSAoRXhwci5maW5kWydJRCddKHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSksIGNvbnRleHQpIHx8IFtdKVswXTsKICAgICAgICAgIGlmICghY29udGV4dCkgewogICAgICAgICAgICByZXR1cm4gcmVzdWx0czsgIC8vIFByZWNvbXBpbGVkIG1hdGNoZXJzIHdpbGwgc3RpbGwgdmVyaWZ5IGFuY2VzdHJ5LCBzbyBzdGVwIHVwIGEgbGV2ZWwKICAgICAgICAgIH0gZWxzZSBpZiAoY29tcGlsZWQpIHsKICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3Iuc2xpY2UodG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgLy8gRmV0Y2ggYSBzZWVkIHNldCBmb3IgcmlnaHQtdG8tbGVmdCBtYXRjaGluZwogICAgICAgIGkgPSBtYXRjaEV4cHJbJ25lZWRzQ29udGV4dCddLnRlc3Qoc2VsZWN0b3IpID8gMCA6IHRva2Vucy5sZW5ndGg7CiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgdG9rZW4gPSB0b2tlbnNbaV07CiAgICAgICAgICAvLyBBYm9ydCBpZiB3ZSBoaXQgYSBjb21iaW5hdG9yCiAgICAgICAgICBpZiAoRXhwci5yZWxhdGl2ZVt0eXBlID0gdG9rZW4udHlwZV0pIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmluZCA9IEV4cHIuZmluZFt0eXBlXSkgewogICAgICAgICAgICAvLyBTZWFyY2gsIGV4cGFuZGluZyBjb250ZXh0IGZvciBsZWFkaW5nIHNpYmxpbmcgY29tYmluYXRvcnMKICAgICAgICAgICAgaWYgKHNlZWQgPSBmaW5kKHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSksIHJzaWJsaW5nLnRlc3QodG9rZW5zWzBdLnR5cGUpICYmIHRlc3RDb250ZXh0KGNvbnRleHQucGFyZW50Tm9kZSkgfHwgY29udGV4dCkpIHsKICAgICAgICAgICAgICAvLyBJZiBzZWVkIGlzIGVtcHR5IG9yIG5vIHRva2VucyByZW1haW4sIHdlIGNhbiByZXR1cm4gZWFybHkKICAgICAgICAgICAgICB0b2tlbnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIHNlbGVjdG9yID0gc2VlZC5sZW5ndGggJiYgdG9TZWxlY3Rvcih0b2tlbnMpOwogICAgICAgICAgICAgIGlmICghc2VsZWN0b3IpIHsKICAgICAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgc2VlZCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQ29tcGlsZSBhbmQgZXhlY3V0ZSBhIGZpbHRlcmluZyBmdW5jdGlvbiBpZiBvbmUgaXMgbm90IHByb3ZpZGVkCiAgICAgIC8vIFByb3ZpZGUgYG1hdGNoYCB0byBhdm9pZCByZXRva2VuaXphdGlvbiBpZiB3ZSBtb2RpZmllZCB0aGUgc2VsZWN0b3IgYWJvdmUKICAgICAgKGNvbXBpbGVkIHx8IGNvbXBpbGUoc2VsZWN0b3IsIG1hdGNoKSkoc2VlZCwgY29udGV4dCwgIWRvY3VtZW50SXNIVE1MLCByZXN1bHRzLCByc2libGluZy50ZXN0KHNlbGVjdG9yKSAmJiB0ZXN0Q29udGV4dChjb250ZXh0LnBhcmVudE5vZGUpIHx8IGNvbnRleHQpOwogICAgICByZXR1cm4gcmVzdWx0czsKICAgIH07CiAgICAvLyBPbmUtdGltZSBhc3NpZ25tZW50cwogICAgLy8gU29ydCBzdGFiaWxpdHkKICAgIHN1cHBvcnQuc29ydFN0YWJsZSA9IGV4cGFuZG8uc3BsaXQoJycpLnNvcnQoc29ydE9yZGVyKS5qb2luKCcnKSA9PT0gZXhwYW5kbzsKICAgIC8vIFN1cHBvcnQ6IENocm9tZTwxNAogICAgLy8gQWx3YXlzIGFzc3VtZSBkdXBsaWNhdGVzIGlmIHRoZXkgYXJlbid0IHBhc3NlZCB0byB0aGUgY29tcGFyaXNvbiBmdW5jdGlvbgogICAgc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzID0gISFoYXNEdXBsaWNhdGU7CiAgICAvLyBJbml0aWFsaXplIGFnYWluc3QgdGhlIGRlZmF1bHQgZG9jdW1lbnQKICAgIHNldERvY3VtZW50KCk7CiAgICAvLyBTdXBwb3J0OiBXZWJraXQ8NTM3LjMyIC0gU2FmYXJpIDYuMC4zL0Nocm9tZSAyNSAoZml4ZWQgaW4gQ2hyb21lIDI3KQogICAgLy8gRGV0YWNoZWQgbm9kZXMgY29uZm91bmRpbmdseSBmb2xsb3cgKmVhY2ggb3RoZXIqCiAgICBzdXBwb3J0LnNvcnREZXRhY2hlZCA9IGFzc2VydChmdW5jdGlvbiAoZGl2MSkgewogICAgICAvLyBTaG91bGQgcmV0dXJuIDEsIGJ1dCByZXR1cm5zIDQgKGZvbGxvd2luZykKICAgICAgcmV0dXJuIGRpdjEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykpICYgMTsKICAgIH0pOwogICAgLy8gU3VwcG9ydDogSUU8OAogICAgLy8gUHJldmVudCBhdHRyaWJ1dGUvcHJvcGVydHkgImludGVycG9sYXRpb24iCiAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4CiAgICBpZiAoIWFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8YSBocmVmPVwnI1wnPjwvYT4nOwogICAgICAgIHJldHVybiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSA9PT0gJyMnOwogICAgICB9KSkgewogICAgICBhZGRIYW5kbGUoJ3R5cGV8aHJlZnxoZWlnaHR8d2lkdGgnLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgaXNYTUwpIHsKICAgICAgICBpZiAoIWlzWE1MKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSwgbmFtZS50b0xvd2VyQ2FzZSgpID09PSAndHlwZScgPyAxIDogMik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIC8vIFN1cHBvcnQ6IElFPDkKICAgIC8vIFVzZSBkZWZhdWx0VmFsdWUgaW4gcGxhY2Ugb2YgZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpCiAgICBpZiAoIXN1cHBvcnQuYXR0cmlidXRlcyB8fCAhYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzxpbnB1dC8+JzsKICAgICAgICBkaXYuZmlyc3RDaGlsZC5zZXRBdHRyaWJ1dGUoJ3ZhbHVlJywgJycpOwogICAgICAgIHJldHVybiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykgPT09ICcnOwogICAgICB9KSkgewogICAgICBhZGRIYW5kbGUoJ3ZhbHVlJywgZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGlzWE1MKSB7CiAgICAgICAgaWYgKCFpc1hNTCAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdpbnB1dCcpIHsKICAgICAgICAgIHJldHVybiBlbGVtLmRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgLy8gU3VwcG9ydDogSUU8OQogICAgLy8gVXNlIGdldEF0dHJpYnV0ZU5vZGUgdG8gZmV0Y2ggYm9vbGVhbnMgd2hlbiBnZXRBdHRyaWJ1dGUgbGllcwogICAgaWYgKCFhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgIHJldHVybiBkaXYuZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpID09IG51bGw7CiAgICAgIH0pKSB7CiAgICAgIGFkZEhhbmRsZShib29sZWFucywgZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGlzWE1MKSB7CiAgICAgICAgdmFyIHZhbDsKICAgICAgICBpZiAoIWlzWE1MKSB7CiAgICAgICAgICByZXR1cm4gZWxlbVtuYW1lXSA9PT0gdHJ1ZSA/IG5hbWUudG9Mb3dlckNhc2UoKSA6ICh2YWwgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUobmFtZSkpICYmIHZhbC5zcGVjaWZpZWQgPyB2YWwudmFsdWUgOiBudWxsOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gU2l6emxlOwogIH0od2luZG93KTsKICBqUXVlcnkuZmluZCA9IFNpenpsZTsKICBqUXVlcnkuZXhwciA9IFNpenpsZS5zZWxlY3RvcnM7CiAgalF1ZXJ5LmV4cHJbJzonXSA9IGpRdWVyeS5leHByLnBzZXVkb3M7CiAgalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwogIGpRdWVyeS50ZXh0ID0gU2l6emxlLmdldFRleHQ7CiAgalF1ZXJ5LmlzWE1MRG9jID0gU2l6emxlLmlzWE1MOwogIGpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKICB2YXIgcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dDsKICB2YXIgcnNpbmdsZVRhZyA9IC9ePChcdyspXHMqXC8/Pig/OjxcL1wxPnwpJC87CiAgdmFyIHJpc1NpbXBsZSA9IC9eLlteOiNcW1wuLF0qJC87CiAgLy8gSW1wbGVtZW50IHRoZSBpZGVudGljYWwgZnVuY3Rpb25hbGl0eSBmb3IgZmlsdGVyIGFuZCBub3QKICBmdW5jdGlvbiB3aW5ub3coZWxlbWVudHMsIHF1YWxpZmllciwgbm90KSB7CiAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24ocXVhbGlmaWVyKSkgewogICAgICByZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uIChlbGVtLCBpKSB7CiAgICAgICAgLyoganNoaW50IC1XMDE4ICovCiAgICAgICAgcmV0dXJuICEhcXVhbGlmaWVyLmNhbGwoZWxlbSwgaSwgZWxlbSkgIT09IG5vdDsKICAgICAgfSk7CiAgICB9CiAgICBpZiAocXVhbGlmaWVyLm5vZGVUeXBlKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICByZXR1cm4gZWxlbSA9PT0gcXVhbGlmaWVyICE9PSBub3Q7CiAgICAgIH0pOwogICAgfQogICAgaWYgKHR5cGVvZiBxdWFsaWZpZXIgPT09ICdzdHJpbmcnKSB7CiAgICAgIGlmIChyaXNTaW1wbGUudGVzdChxdWFsaWZpZXIpKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5maWx0ZXIocXVhbGlmaWVyLCBlbGVtZW50cywgbm90KTsKICAgICAgfQogICAgICBxdWFsaWZpZXIgPSBqUXVlcnkuZmlsdGVyKHF1YWxpZmllciwgZWxlbWVudHMpOwogICAgfQogICAgcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKHF1YWxpZmllciwgZWxlbSkgPj0gMCAhPT0gbm90OwogICAgfSk7CiAgfQogIGpRdWVyeS5maWx0ZXIgPSBmdW5jdGlvbiAoZXhwciwgZWxlbXMsIG5vdCkgewogICAgdmFyIGVsZW0gPSBlbGVtc1swXTsKICAgIGlmIChub3QpIHsKICAgICAgZXhwciA9ICc6bm90KCcgKyBleHByICsgJyknOwogICAgfQogICAgcmV0dXJuIGVsZW1zLmxlbmd0aCA9PT0gMSAmJiBlbGVtLm5vZGVUeXBlID09PSAxID8galF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGVsZW0sIGV4cHIpID8gW2VsZW1dIDogW10gOiBqUXVlcnkuZmluZC5tYXRjaGVzKGV4cHIsIGpRdWVyeS5ncmVwKGVsZW1zLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMTsKICAgIH0pKTsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgZmluZDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHZhciBpLCBsZW4gPSB0aGlzLmxlbmd0aCwgcmV0ID0gW10sIHNlbGYgPSB0aGlzOwogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkoc2VsZWN0b3IpLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKGpRdWVyeS5jb250YWlucyhzZWxmW2ldLCB0aGlzKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIGpRdWVyeS5maW5kKHNlbGVjdG9yLCBzZWxmW2ldLCByZXQpOwogICAgICB9CiAgICAgIC8vIE5lZWRlZCBiZWNhdXNlICQoIHNlbGVjdG9yLCBjb250ZXh0ICkgYmVjb21lcyAkKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKQogICAgICByZXQgPSB0aGlzLnB1c2hTdGFjayhsZW4gPiAxID8galF1ZXJ5LnVuaXF1ZShyZXQpIDogcmV0KTsKICAgICAgcmV0LnNlbGVjdG9yID0gdGhpcy5zZWxlY3RvciA/IHRoaXMuc2VsZWN0b3IgKyAnICcgKyBzZWxlY3RvciA6IHNlbGVjdG9yOwogICAgICByZXR1cm4gcmV0OwogICAgfSwKICAgIGZpbHRlcjogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayh3aW5ub3codGhpcywgc2VsZWN0b3IgfHwgW10sIGZhbHNlKSk7CiAgICB9LAogICAgbm90OiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHdpbm5vdyh0aGlzLCBzZWxlY3RvciB8fCBbXSwgdHJ1ZSkpOwogICAgfSwKICAgIGlzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuICEhd2lubm93KHRoaXMsIC8vIElmIHRoaXMgaXMgYSBwb3NpdGlvbmFsL3JlbGF0aXZlIHNlbGVjdG9yLCBjaGVjayBtZW1iZXJzaGlwIGluIHRoZSByZXR1cm5lZCBzZXQKICAgICAgLy8gc28gJCgicDpmaXJzdCIpLmlzKCJwOmxhc3QiKSB3b24ndCByZXR1cm4gdHJ1ZSBmb3IgYSBkb2Mgd2l0aCB0d28gInAiLgogICAgICB0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnICYmIHJuZWVkc0NvbnRleHQudGVzdChzZWxlY3RvcikgPyBqUXVlcnkoc2VsZWN0b3IpIDogc2VsZWN0b3IgfHwgW10sIGZhbHNlKS5sZW5ndGg7CiAgICB9CiAgfSk7CiAgLy8gSW5pdGlhbGl6ZSBhIGpRdWVyeSBvYmplY3QKICAvLyBBIGNlbnRyYWwgcmVmZXJlbmNlIHRvIHRoZSByb290IGpRdWVyeShkb2N1bWVudCkKICB2YXIgcm9vdGpRdWVyeSwKICAgIC8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzCiAgICAvLyBQcmlvcml0aXplICNpZCBvdmVyIDx0YWc+IHRvIGF2b2lkIFhTUyB2aWEgbG9jYXRpb24uaGFzaCAoIzk1MjEpCiAgICAvLyBTdHJpY3QgSFRNTCByZWNvZ25pdGlvbiAoIzExMjkwOiBtdXN0IHN0YXJ0IHdpdGggPCkKICAgIHJxdWlja0V4cHIgPSAvXig/OlxzKig8W1x3XFddKz4pW14+XSp8IyhbXHctXSopKSQvLCBpbml0ID0galF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgdmFyIG1hdGNoLCBlbGVtOwogICAgICAvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCiAgICAgIGlmICghc2VsZWN0b3IpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICAvLyBIYW5kbGUgSFRNTCBzdHJpbmdzCiAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgaWYgKHNlbGVjdG9yWzBdID09PSAnPCcgJiYgc2VsZWN0b3Jbc2VsZWN0b3IubGVuZ3RoIC0gMV0gPT09ICc+JyAmJiBzZWxlY3Rvci5sZW5ndGggPj0gMykgewogICAgICAgICAgLy8gQXNzdW1lIHRoYXQgc3RyaW5ncyB0aGF0IHN0YXJ0IGFuZCBlbmQgd2l0aCA8PiBhcmUgSFRNTCBhbmQgc2tpcCB0aGUgcmVnZXggY2hlY2sKICAgICAgICAgIG1hdGNoID0gWwogICAgICAgICAgICBudWxsLAogICAgICAgICAgICBzZWxlY3RvciwKICAgICAgICAgICAgbnVsbAogICAgICAgICAgXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoc2VsZWN0b3IpOwogICAgICAgIH0KICAgICAgICAvLyBNYXRjaCBodG1sIG9yIG1ha2Ugc3VyZSBubyBjb250ZXh0IGlzIHNwZWNpZmllZCBmb3IgI2lkCiAgICAgICAgaWYgKG1hdGNoICYmIChtYXRjaFsxXSB8fCAhY29udGV4dCkpIHsKICAgICAgICAgIC8vIEhBTkRMRTogJChodG1sKSAtPiAkKGFycmF5KQogICAgICAgICAgaWYgKG1hdGNoWzFdKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFswXSA6IGNvbnRleHQ7CiAgICAgICAgICAgIC8vIHNjcmlwdHMgaXMgdHJ1ZSBmb3IgYmFjay1jb21wYXQKICAgICAgICAgICAgLy8gSW50ZW50aW9uYWxseSBsZXQgdGhlIGVycm9yIGJlIHRocm93biBpZiBwYXJzZUhUTUwgaXMgbm90IHByZXNlbnQKICAgICAgICAgICAgalF1ZXJ5Lm1lcmdlKHRoaXMsIGpRdWVyeS5wYXJzZUhUTUwobWF0Y2hbMV0sIGNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsIHRydWUpKTsKICAgICAgICAgICAgLy8gSEFORExFOiAkKGh0bWwsIHByb3BzKQogICAgICAgICAgICBpZiAocnNpbmdsZVRhZy50ZXN0KG1hdGNoWzFdKSAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdChjb250ZXh0KSkgewogICAgICAgICAgICAgIGZvciAobWF0Y2ggaW4gY29udGV4dCkgewogICAgICAgICAgICAgICAgLy8gUHJvcGVydGllcyBvZiBjb250ZXh0IGFyZSBjYWxsZWQgYXMgbWV0aG9kcyBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKHRoaXNbbWF0Y2hdKSkgewogICAgICAgICAgICAgICAgICB0aGlzW21hdGNoXShjb250ZXh0W21hdGNoXSk7ICAvLyAuLi5hbmQgb3RoZXJ3aXNlIHNldCBhcyBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLmF0dHIobWF0Y2gsIGNvbnRleHRbbWF0Y2hdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7ICAvLyBIQU5ETEU6ICQoI2lkKQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG1hdGNoWzJdKTsKICAgICAgICAgICAgLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKICAgICAgICAgICAgLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwogICAgICAgICAgICBpZiAoZWxlbSAmJiBlbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAvLyBJbmplY3QgdGhlIGVsZW1lbnQgZGlyZWN0bHkgaW50byB0aGUgalF1ZXJ5IG9iamVjdAogICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMTsKICAgICAgICAgICAgICB0aGlzWzBdID0gZWxlbTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBkb2N1bWVudDsKICAgICAgICAgICAgdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0gIC8vIEhBTkRMRTogJChleHByLCAkKC4uLikpCiAgICAgICAgfSBlbHNlIGlmICghY29udGV4dCB8fCBjb250ZXh0LmpxdWVyeSkgewogICAgICAgICAgcmV0dXJuIChjb250ZXh0IHx8IHJvb3RqUXVlcnkpLmZpbmQoc2VsZWN0b3IpOyAgLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IoY29udGV4dCkuZmluZChzZWxlY3Rvcik7CiAgICAgICAgfSAgLy8gSEFORExFOiAkKERPTUVsZW1lbnQpCiAgICAgIH0gZWxzZSBpZiAoc2VsZWN0b3Iubm9kZVR5cGUpIHsKICAgICAgICB0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gc2VsZWN0b3I7CiAgICAgICAgdGhpcy5sZW5ndGggPSAxOwogICAgICAgIHJldHVybiB0aGlzOyAgLy8gSEFORExFOiAkKGZ1bmN0aW9uKQogICAgICAgICAgICAgICAgICAgICAgLy8gU2hvcnRjdXQgZm9yIGRvY3VtZW50IHJlYWR5CiAgICAgIH0gZWxzZSBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oc2VsZWN0b3IpKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiByb290alF1ZXJ5LnJlYWR5ICE9PSAndW5kZWZpbmVkJyA/IHJvb3RqUXVlcnkucmVhZHkoc2VsZWN0b3IpIDogLy8gRXhlY3V0ZSBpbW1lZGlhdGVseSBpZiByZWFkeSBpcyBub3QgcHJlc2VudAogICAgICAgIHNlbGVjdG9yKGpRdWVyeSk7CiAgICAgIH0KICAgICAgaWYgKHNlbGVjdG9yLnNlbGVjdG9yICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3Iuc2VsZWN0b3I7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gc2VsZWN0b3IuY29udGV4dDsKICAgICAgfQogICAgICByZXR1cm4galF1ZXJ5Lm1ha2VBcnJheShzZWxlY3RvciwgdGhpcyk7CiAgICB9OwogIC8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KICBpbml0LnByb3RvdHlwZSA9IGpRdWVyeS5mbjsKICAvLyBJbml0aWFsaXplIGNlbnRyYWwgcmVmZXJlbmNlCiAgcm9vdGpRdWVyeSA9IGpRdWVyeShkb2N1bWVudCk7CiAgdmFyIHJwYXJlbnRzcHJldiA9IC9eKD86cGFyZW50c3xwcmV2KD86VW50aWx8QWxsKSkvLAogICAgLy8gbWV0aG9kcyBndWFyYW50ZWVkIHRvIHByb2R1Y2UgYSB1bmlxdWUgc2V0IHdoZW4gc3RhcnRpbmcgZnJvbSBhIHVuaXF1ZSBzZXQKICAgIGd1YXJhbnRlZWRVbmlxdWUgPSB7CiAgICAgIGNoaWxkcmVuOiB0cnVlLAogICAgICBjb250ZW50czogdHJ1ZSwKICAgICAgbmV4dDogdHJ1ZSwKICAgICAgcHJldjogdHJ1ZQogICAgfTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIGRpcjogZnVuY3Rpb24gKGVsZW0sIGRpciwgdW50aWwpIHsKICAgICAgdmFyIG1hdGNoZWQgPSBbXSwgdHJ1bmNhdGUgPSB1bnRpbCAhPT0gdW5kZWZpbmVkOwogICAgICB3aGlsZSAoKGVsZW0gPSBlbGVtW2Rpcl0pICYmIGVsZW0ubm9kZVR5cGUgIT09IDkpIHsKICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgaWYgKHRydW5jYXRlICYmIGpRdWVyeShlbGVtKS5pcyh1bnRpbCkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBtYXRjaGVkLnB1c2goZWxlbSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtYXRjaGVkOwogICAgfSwKICAgIHNpYmxpbmc6IGZ1bmN0aW9uIChuLCBlbGVtKSB7CiAgICAgIHZhciBtYXRjaGVkID0gW107CiAgICAgIGZvciAoOyBuOyBuID0gbi5uZXh0U2libGluZykgewogICAgICAgIGlmIChuLm5vZGVUeXBlID09PSAxICYmIG4gIT09IGVsZW0pIHsKICAgICAgICAgIG1hdGNoZWQucHVzaChuKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBoYXM6IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgICAgdmFyIHRhcmdldHMgPSBqUXVlcnkodGFyZ2V0LCB0aGlzKSwgbCA9IHRhcmdldHMubGVuZ3RoOwogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBpID0gMDsKICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgaWYgKGpRdWVyeS5jb250YWlucyh0aGlzLCB0YXJnZXRzW2ldKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGNsb3Nlc3Q6IGZ1bmN0aW9uIChzZWxlY3RvcnMsIGNvbnRleHQpIHsKICAgICAgdmFyIGN1ciwgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCwgbWF0Y2hlZCA9IFtdLCBwb3MgPSBybmVlZHNDb250ZXh0LnRlc3Qoc2VsZWN0b3JzKSB8fCB0eXBlb2Ygc2VsZWN0b3JzICE9PSAnc3RyaW5nJyA/IGpRdWVyeShzZWxlY3RvcnMsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0KSA6IDA7CiAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgZm9yIChjdXIgPSB0aGlzW2ldOyBjdXIgJiYgY3VyICE9PSBjb250ZXh0OyBjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgLy8gQWx3YXlzIHNraXAgZG9jdW1lbnQgZnJhZ21lbnRzCiAgICAgICAgICBpZiAoY3VyLm5vZGVUeXBlIDwgMTEgJiYgKHBvcyA/IHBvcy5pbmRleChjdXIpID4gLTEgOiAvLyBEb24ndCBwYXNzIG5vbi1lbGVtZW50cyB0byBTaXp6bGUKICAgICAgICAgICAgY3VyLm5vZGVUeXBlID09PSAxICYmIGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihjdXIsIHNlbGVjdG9ycykpKSB7CiAgICAgICAgICAgIG1hdGNoZWQucHVzaChjdXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKG1hdGNoZWQubGVuZ3RoID4gMSA/IGpRdWVyeS51bmlxdWUobWF0Y2hlZCkgOiBtYXRjaGVkKTsKICAgIH0sCiAgICAvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluCiAgICAvLyB0aGUgbWF0Y2hlZCBzZXQgb2YgZWxlbWVudHMKICAgIGluZGV4OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAogICAgICBpZiAoIWVsZW0pIHsKICAgICAgICByZXR1cm4gdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgPyB0aGlzLmZpcnN0KCkucHJldkFsbCgpLmxlbmd0aCA6IC0xOwogICAgICB9CiAgICAgIC8vIGluZGV4IGluIHNlbGVjdG9yCiAgICAgIGlmICh0eXBlb2YgZWxlbSA9PT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKGpRdWVyeShlbGVtKSwgdGhpc1swXSk7CiAgICAgIH0KICAgICAgLy8gTG9jYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgZGVzaXJlZCBlbGVtZW50CiAgICAgIHJldHVybiBpbmRleE9mLmNhbGwodGhpcywgLy8gSWYgaXQgcmVjZWl2ZXMgYSBqUXVlcnkgb2JqZWN0LCB0aGUgZmlyc3QgZWxlbWVudCBpcyB1c2VkCiAgICAgIGVsZW0uanF1ZXJ5ID8gZWxlbVswXSA6IGVsZW0pOwogICAgfSwKICAgIGFkZDogZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkudW5pcXVlKGpRdWVyeS5tZXJnZSh0aGlzLmdldCgpLCBqUXVlcnkoc2VsZWN0b3IsIGNvbnRleHQpKSkpOwogICAgfSwKICAgIGFkZEJhY2s6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy5hZGQoc2VsZWN0b3IgPT0gbnVsbCA/IHRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoc2VsZWN0b3IpKTsKICAgIH0KICB9KTsKICBmdW5jdGlvbiBzaWJsaW5nKGN1ciwgZGlyKSB7CiAgICB3aGlsZSAoKGN1ciA9IGN1cltkaXJdKSAmJiBjdXIubm9kZVR5cGUgIT09IDEpIHsKICAgIH0KICAgIHJldHVybiBjdXI7CiAgfQogIGpRdWVyeS5lYWNoKHsKICAgIHBhcmVudDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKICAgIH0sCiAgICBwYXJlbnRzOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LmRpcihlbGVtLCAncGFyZW50Tm9kZScpOwogICAgfSwKICAgIHBhcmVudHNVbnRpbDogZnVuY3Rpb24gKGVsZW0sIGksIHVudGlsKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICdwYXJlbnROb2RlJywgdW50aWwpOwogICAgfSwKICAgIG5leHQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5nKGVsZW0sICduZXh0U2libGluZycpOwogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5nKGVsZW0sICdwcmV2aW91c1NpYmxpbmcnKTsKICAgIH0sCiAgICBuZXh0QWxsOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LmRpcihlbGVtLCAnbmV4dFNpYmxpbmcnKTsKICAgIH0sCiAgICBwcmV2QWxsOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LmRpcihlbGVtLCAncHJldmlvdXNTaWJsaW5nJyk7CiAgICB9LAogICAgbmV4dFVudGlsOiBmdW5jdGlvbiAoZWxlbSwgaSwgdW50aWwpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgJ25leHRTaWJsaW5nJywgdW50aWwpOwogICAgfSwKICAgIHByZXZVbnRpbDogZnVuY3Rpb24gKGVsZW0sIGksIHVudGlsKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICdwcmV2aW91c1NpYmxpbmcnLCB1bnRpbCk7CiAgICB9LAogICAgc2libGluZ3M6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuc2libGluZygoZWxlbS5wYXJlbnROb2RlIHx8IHt9KS5maXJzdENoaWxkLCBlbGVtKTsKICAgIH0sCiAgICBjaGlsZHJlbjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGpRdWVyeS5zaWJsaW5nKGVsZW0uZmlyc3RDaGlsZCk7CiAgICB9LAogICAgY29udGVudHM6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBqUXVlcnkubWVyZ2UoW10sIGVsZW0uY2hpbGROb2Rlcyk7CiAgICB9CiAgfSwgZnVuY3Rpb24gKG5hbWUsIGZuKSB7CiAgICBqUXVlcnkuZm5bbmFtZV0gPSBmdW5jdGlvbiAodW50aWwsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBtYXRjaGVkID0galF1ZXJ5Lm1hcCh0aGlzLCBmbiwgdW50aWwpOwogICAgICBpZiAobmFtZS5zbGljZSgtNSkgIT09ICdVbnRpbCcpIHsKICAgICAgICBzZWxlY3RvciA9IHVudGlsOwogICAgICB9CiAgICAgIGlmIChzZWxlY3RvciAmJiB0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgbWF0Y2hlZCA9IGpRdWVyeS5maWx0ZXIoc2VsZWN0b3IsIG1hdGNoZWQpOwogICAgICB9CiAgICAgIGlmICh0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcwogICAgICAgIGlmICghZ3VhcmFudGVlZFVuaXF1ZVtuYW1lXSkgewogICAgICAgICAgalF1ZXJ5LnVuaXF1ZShtYXRjaGVkKTsKICAgICAgICB9CiAgICAgICAgLy8gUmV2ZXJzZSBvcmRlciBmb3IgcGFyZW50cyogYW5kIHByZXYtZGVyaXZhdGl2ZXMKICAgICAgICBpZiAocnBhcmVudHNwcmV2LnRlc3QobmFtZSkpIHsKICAgICAgICAgIG1hdGNoZWQucmV2ZXJzZSgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sobWF0Y2hlZCk7CiAgICB9OwogIH0pOwogIHZhciBybm90d2hpdGUgPSAvXFMrL2c7CiAgLy8gU3RyaW5nIHRvIE9iamVjdCBvcHRpb25zIGZvcm1hdCBjYWNoZQogIHZhciBvcHRpb25zQ2FjaGUgPSB7fTsKICAvLyBDb252ZXJ0IFN0cmluZy1mb3JtYXR0ZWQgb3B0aW9ucyBpbnRvIE9iamVjdC1mb3JtYXR0ZWQgb25lcyBhbmQgc3RvcmUgaW4gY2FjaGUKICBmdW5jdGlvbiBjcmVhdGVPcHRpb25zKG9wdGlvbnMpIHsKICAgIHZhciBvYmplY3QgPSBvcHRpb25zQ2FjaGVbb3B0aW9uc10gPSB7fTsKICAgIGpRdWVyeS5lYWNoKG9wdGlvbnMubWF0Y2gocm5vdHdoaXRlKSB8fCBbXSwgZnVuY3Rpb24gKF8sIGZsYWcpIHsKICAgICAgb2JqZWN0W2ZsYWddID0gdHJ1ZTsKICAgIH0pOwogICAgcmV0dXJuIG9iamVjdDsKICB9CiAgLyoKICAgKiBDcmVhdGUgYSBjYWxsYmFjayBsaXN0IHVzaW5nIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICAgKgogICAqCW9wdGlvbnM6IGFuIG9wdGlvbmFsIGxpc3Qgb2Ygc3BhY2Utc2VwYXJhdGVkIG9wdGlvbnMgdGhhdCB3aWxsIGNoYW5nZSBob3cKICAgKgkJCXRoZSBjYWxsYmFjayBsaXN0IGJlaGF2ZXMgb3IgYSBtb3JlIHRyYWRpdGlvbmFsIG9wdGlvbiBvYmplY3QKICAgKgogICAqIEJ5IGRlZmF1bHQgYSBjYWxsYmFjayBsaXN0IHdpbGwgYWN0IGxpa2UgYW4gZXZlbnQgY2FsbGJhY2sgbGlzdCBhbmQgY2FuIGJlCiAgICogImZpcmVkIiBtdWx0aXBsZSB0aW1lcy4KICAgKgogICAqIFBvc3NpYmxlIG9wdGlvbnM6CiAgICoKICAgKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkKICAgKgogICAqCW1lbW9yeToJCQl3aWxsIGtlZXAgdHJhY2sgb2YgcHJldmlvdXMgdmFsdWVzIGFuZCB3aWxsIGNhbGwgYW55IGNhbGxiYWNrIGFkZGVkCiAgICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAgICoJCQkJCXZhbHVlcyAobGlrZSBhIERlZmVycmVkKQogICAqCiAgICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQogICAqCiAgICoJc3RvcE9uRmFsc2U6CWludGVycnVwdCBjYWxsaW5ncyB3aGVuIGEgY2FsbGJhY2sgcmV0dXJucyBmYWxzZQogICAqCiAgICovCiAgalF1ZXJ5LkNhbGxiYWNrcyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAvLyBDb252ZXJ0IG9wdGlvbnMgZnJvbSBTdHJpbmctZm9ybWF0dGVkIHRvIE9iamVjdC1mb3JtYXR0ZWQgaWYgbmVlZGVkCiAgICAvLyAod2UgY2hlY2sgaW4gY2FjaGUgZmlyc3QpCiAgICBvcHRpb25zID0gdHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnID8gb3B0aW9uc0NhY2hlW29wdGlvbnNdIHx8IGNyZWF0ZU9wdGlvbnMob3B0aW9ucykgOiBqUXVlcnkuZXh0ZW5kKHt9LCBvcHRpb25zKTsKICAgIHZhcgogICAgICAvLyBMYXN0IGZpcmUgdmFsdWUgKGZvciBub24tZm9yZ2V0dGFibGUgbGlzdHMpCiAgICAgIG1lbW9yeSwKICAgICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3Qgd2FzIGFscmVhZHkgZmlyZWQKICAgICAgZmlyZWQsCiAgICAgIC8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcKICAgICAgZmlyaW5nLAogICAgICAvLyBGaXJzdCBjYWxsYmFjayB0byBmaXJlICh1c2VkIGludGVybmFsbHkgYnkgYWRkIGFuZCBmaXJlV2l0aCkKICAgICAgZmlyaW5nU3RhcnQsCiAgICAgIC8vIEVuZCBvZiB0aGUgbG9vcCB3aGVuIGZpcmluZwogICAgICBmaXJpbmdMZW5ndGgsCiAgICAgIC8vIEluZGV4IG9mIGN1cnJlbnRseSBmaXJpbmcgY2FsbGJhY2sgKG1vZGlmaWVkIGJ5IHJlbW92ZSBpZiBuZWVkZWQpCiAgICAgIGZpcmluZ0luZGV4LAogICAgICAvLyBBY3R1YWwgY2FsbGJhY2sgbGlzdAogICAgICBsaXN0ID0gW10sCiAgICAgIC8vIFN0YWNrIG9mIGZpcmUgY2FsbHMgZm9yIHJlcGVhdGFibGUgbGlzdHMKICAgICAgc3RhY2sgPSAhb3B0aW9ucy5vbmNlICYmIFtdLAogICAgICAvLyBGaXJlIGNhbGxiYWNrcwogICAgICBmaXJlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBtZW1vcnkgPSBvcHRpb25zLm1lbW9yeSAmJiBkYXRhOwogICAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgICBmaXJpbmdJbmRleCA9IGZpcmluZ1N0YXJ0IHx8IDA7CiAgICAgICAgZmlyaW5nU3RhcnQgPSAwOwogICAgICAgIGZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwogICAgICAgIGZpcmluZyA9IHRydWU7CiAgICAgICAgZm9yICg7IGxpc3QgJiYgZmlyaW5nSW5kZXggPCBmaXJpbmdMZW5ndGg7IGZpcmluZ0luZGV4KyspIHsKICAgICAgICAgIGlmIChsaXN0W2ZpcmluZ0luZGV4XS5hcHBseShkYXRhWzBdLCBkYXRhWzFdKSA9PT0gZmFsc2UgJiYgb3B0aW9ucy5zdG9wT25GYWxzZSkgewogICAgICAgICAgICBtZW1vcnkgPSBmYWxzZTsKICAgICAgICAgICAgLy8gVG8gcHJldmVudCBmdXJ0aGVyIGNhbGxzIHVzaW5nIGFkZAogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZmlyaW5nID0gZmFsc2U7CiAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgIGlmIChzdGFjaykgewogICAgICAgICAgICBpZiAoc3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgICAgZmlyZShzdGFjay5zaGlmdCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChtZW1vcnkpIHsKICAgICAgICAgICAgbGlzdCA9IFtdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5kaXNhYmxlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAvLyBBY3R1YWwgQ2FsbGJhY2tzIG9iamVjdAogICAgICBzZWxmID0gewogICAgICAgIC8vIEFkZCBhIGNhbGxiYWNrIG9yIGEgY29sbGVjdGlvbiBvZiBjYWxsYmFja3MgdG8gdGhlIGxpc3QKICAgICAgICBhZGQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICAgIC8vIEZpcnN0LCB3ZSBzYXZlIHRoZSBjdXJyZW50IGxlbmd0aAogICAgICAgICAgICB2YXIgc3RhcnQgPSBsaXN0Lmxlbmd0aDsKICAgICAgICAgICAgKGZ1bmN0aW9uIGFkZChhcmdzKSB7CiAgICAgICAgICAgICAgalF1ZXJ5LmVhY2goYXJncywgZnVuY3Rpb24gKF8sIGFyZykgewogICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBqUXVlcnkudHlwZShhcmcpOwogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLnVuaXF1ZSB8fCAhc2VsZi5oYXMoYXJnKSkgewogICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChhcmcpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFyZyAmJiBhcmcubGVuZ3RoICYmIHR5cGUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgIC8vIEluc3BlY3QgcmVjdXJzaXZlbHkKICAgICAgICAgICAgICAgICAgYWRkKGFyZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0oYXJndW1lbnRzKSk7CiAgICAgICAgICAgIC8vIERvIHdlIG5lZWQgdG8gYWRkIHRoZSBjYWxsYmFja3MgdG8gdGhlCiAgICAgICAgICAgIC8vIGN1cnJlbnQgZmlyaW5nIGJhdGNoPwogICAgICAgICAgICBpZiAoZmlyaW5nKSB7CiAgICAgICAgICAgICAgZmlyaW5nTGVuZ3RoID0gbGlzdC5sZW5ndGg7ICAvLyBXaXRoIG1lbW9yeSwgaWYgd2UncmUgbm90IGZpcmluZyB0aGVuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBzaG91bGQgY2FsbCByaWdodCBhd2F5CiAgICAgICAgICAgIH0gZWxzZSBpZiAobWVtb3J5KSB7CiAgICAgICAgICAgICAgZmlyaW5nU3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgICBmaXJlKG1lbW9yeSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgalF1ZXJ5LmVhY2goYXJndW1lbnRzLCBmdW5jdGlvbiAoXywgYXJnKSB7CiAgICAgICAgICAgICAgdmFyIGluZGV4OwogICAgICAgICAgICAgIHdoaWxlICgoaW5kZXggPSBqUXVlcnkuaW5BcnJheShhcmcsIGxpc3QsIGluZGV4KSkgPiAtMSkgewogICAgICAgICAgICAgICAgbGlzdC5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICAgICAgLy8gSGFuZGxlIGZpcmluZyBpbmRleGVzCiAgICAgICAgICAgICAgICBpZiAoZmlyaW5nKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA8PSBmaXJpbmdMZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaXJpbmdMZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPD0gZmlyaW5nSW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICBmaXJpbmdJbmRleC0tOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gQ2hlY2sgaWYgYSBnaXZlbiBjYWxsYmFjayBpcyBpbiB0aGUgbGlzdC4KICAgICAgICAvLyBJZiBubyBhcmd1bWVudCBpcyBnaXZlbiwgcmV0dXJuIHdoZXRoZXIgb3Igbm90IGxpc3QgaGFzIGNhbGxiYWNrcyBhdHRhY2hlZC4KICAgICAgICBoYXM6IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgcmV0dXJuIGZuID8galF1ZXJ5LmluQXJyYXkoZm4sIGxpc3QpID4gLTEgOiAhIShsaXN0ICYmIGxpc3QubGVuZ3RoKTsKICAgICAgICB9LAogICAgICAgIC8vIFJlbW92ZSBhbGwgY2FsbGJhY2tzIGZyb20gdGhlIGxpc3QKICAgICAgICBlbXB0eTogZnVuY3Rpb24gKCkgewogICAgICAgICAgbGlzdCA9IFtdOwogICAgICAgICAgZmlyaW5nTGVuZ3RoID0gMDsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gSGF2ZSB0aGUgbGlzdCBkbyBub3RoaW5nIGFueW1vcmUKICAgICAgICBkaXNhYmxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBsaXN0ID0gc3RhY2sgPSBtZW1vcnkgPSB1bmRlZmluZWQ7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIElzIGl0IGRpc2FibGVkPwogICAgICAgIGRpc2FibGVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gIWxpc3Q7CiAgICAgICAgfSwKICAgICAgICAvLyBMb2NrIHRoZSBsaXN0IGluIGl0cyBjdXJyZW50IHN0YXRlCiAgICAgICAgbG9jazogZnVuY3Rpb24gKCkgewogICAgICAgICAgc3RhY2sgPSB1bmRlZmluZWQ7CiAgICAgICAgICBpZiAoIW1lbW9yeSkgewogICAgICAgICAgICBzZWxmLmRpc2FibGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gSXMgaXQgbG9ja2VkPwogICAgICAgIGxvY2tlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuICFzdGFjazsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgYWxsIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBjb250ZXh0IGFuZCBhcmd1bWVudHMKICAgICAgICBmaXJlV2l0aDogZnVuY3Rpb24gKGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICAgIGlmIChsaXN0ICYmICghZmlyZWQgfHwgc3RhY2spKSB7CiAgICAgICAgICAgIGFyZ3MgPSBhcmdzIHx8IFtdOwogICAgICAgICAgICBhcmdzID0gWwogICAgICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICAgICAgYXJncy5zbGljZSA/IGFyZ3Muc2xpY2UoKSA6IGFyZ3MKICAgICAgICAgICAgXTsKICAgICAgICAgICAgaWYgKGZpcmluZykgewogICAgICAgICAgICAgIHN0YWNrLnB1c2goYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZmlyZShhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBDYWxsIGFsbCB0aGUgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cwogICAgICAgIGZpcmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHNlbGYuZmlyZVdpdGgodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gVG8ga25vdyBpZiB0aGUgY2FsbGJhY2tzIGhhdmUgYWxyZWFkeSBiZWVuIGNhbGxlZCBhdCBsZWFzdCBvbmNlCiAgICAgICAgZmlyZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiAhIWZpcmVkOwogICAgICAgIH0KICAgICAgfTsKICAgIHJldHVybiBzZWxmOwogIH07CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBEZWZlcnJlZDogZnVuY3Rpb24gKGZ1bmMpIHsKICAgICAgdmFyIHR1cGxlcyA9IFsKICAgICAgICAgIC8vIGFjdGlvbiwgYWRkIGxpc3RlbmVyLCBsaXN0ZW5lciBsaXN0LCBmaW5hbCBzdGF0ZQogICAgICAgICAgWwogICAgICAgICAgICAncmVzb2x2ZScsCiAgICAgICAgICAgICdkb25lJywKICAgICAgICAgICAgalF1ZXJ5LkNhbGxiYWNrcygnb25jZSBtZW1vcnknKSwKICAgICAgICAgICAgJ3Jlc29sdmVkJwogICAgICAgICAgXSwKICAgICAgICAgIFsKICAgICAgICAgICAgJ3JlamVjdCcsCiAgICAgICAgICAgICdmYWlsJywKICAgICAgICAgICAgalF1ZXJ5LkNhbGxiYWNrcygnb25jZSBtZW1vcnknKSwKICAgICAgICAgICAgJ3JlamVjdGVkJwogICAgICAgICAgXSwKICAgICAgICAgIFsKICAgICAgICAgICAgJ25vdGlmeScsCiAgICAgICAgICAgICdwcm9ncmVzcycsCiAgICAgICAgICAgIGpRdWVyeS5DYWxsYmFja3MoJ21lbW9yeScpCiAgICAgICAgICBdCiAgICAgICAgXSwgc3RhdGUgPSAncGVuZGluZycsIHByb21pc2UgPSB7CiAgICAgICAgICBzdGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICB9LAogICAgICAgICAgYWx3YXlzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGRlZmVycmVkLmRvbmUoYXJndW1lbnRzKS5mYWlsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIHRoZW46IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGZucyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5EZWZlcnJlZChmdW5jdGlvbiAobmV3RGVmZXIpIHsKICAgICAgICAgICAgICBqUXVlcnkuZWFjaCh0dXBsZXMsIGZ1bmN0aW9uIChpLCB0dXBsZSkgewogICAgICAgICAgICAgICAgdmFyIGZuID0galF1ZXJ5LmlzRnVuY3Rpb24oZm5zW2ldKSAmJiBmbnNbaV07CiAgICAgICAgICAgICAgICAvLyBkZWZlcnJlZFsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdIGZvciBmb3J3YXJkaW5nIGFjdGlvbnMgdG8gbmV3RGVmZXIKICAgICAgICAgICAgICAgIGRlZmVycmVkW3R1cGxlWzFdXShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXR1cm5lZCA9IGZuICYmIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5lZCAmJiBqUXVlcnkuaXNGdW5jdGlvbihyZXR1cm5lZC5wcm9taXNlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybmVkLnByb21pc2UoKS5kb25lKG5ld0RlZmVyLnJlc29sdmUpLmZhaWwobmV3RGVmZXIucmVqZWN0KS5wcm9ncmVzcyhuZXdEZWZlci5ub3RpZnkpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5ld0RlZmVyW3R1cGxlWzBdICsgJ1dpdGgnXSh0aGlzID09PSBwcm9taXNlID8gbmV3RGVmZXIucHJvbWlzZSgpIDogdGhpcywgZm4gPyBbcmV0dXJuZWRdIDogYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgZm5zID0gbnVsbDsKICAgICAgICAgICAgfSkucHJvbWlzZSgpOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIEdldCBhIHByb21pc2UgZm9yIHRoaXMgZGVmZXJyZWQKICAgICAgICAgIC8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QKICAgICAgICAgIHByb21pc2U6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAhPSBudWxsID8galF1ZXJ5LmV4dGVuZChvYmosIHByb21pc2UpIDogcHJvbWlzZTsKICAgICAgICAgIH0KICAgICAgICB9LCBkZWZlcnJlZCA9IHt9OwogICAgICAvLyBLZWVwIHBpcGUgZm9yIGJhY2stY29tcGF0CiAgICAgIHByb21pc2UucGlwZSA9IHByb21pc2UudGhlbjsKICAgICAgLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcwogICAgICBqUXVlcnkuZWFjaCh0dXBsZXMsIGZ1bmN0aW9uIChpLCB0dXBsZSkgewogICAgICAgIHZhciBsaXN0ID0gdHVwbGVbMl0sIHN0YXRlU3RyaW5nID0gdHVwbGVbM107CiAgICAgICAgLy8gcHJvbWlzZVsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdID0gbGlzdC5hZGQKICAgICAgICBwcm9taXNlW3R1cGxlWzFdXSA9IGxpc3QuYWRkOwogICAgICAgIC8vIEhhbmRsZSBzdGF0ZQogICAgICAgIGlmIChzdGF0ZVN0cmluZykgewogICAgICAgICAgbGlzdC5hZGQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBzdGF0ZSA9IFsgcmVzb2x2ZWQgfCByZWplY3RlZCBdCiAgICAgICAgICAgIHN0YXRlID0gc3RhdGVTdHJpbmc7ICAvLyBbIHJlamVjdF9saXN0IHwgcmVzb2x2ZV9saXN0IF0uZGlzYWJsZTsgcHJvZ3Jlc3NfbGlzdC5sb2NrCiAgICAgICAgICB9LCB0dXBsZXNbaSBeIDFdWzJdLmRpc2FibGUsIHR1cGxlc1syXVsyXS5sb2NrKTsKICAgICAgICB9CiAgICAgICAgLy8gZGVmZXJyZWRbIHJlc29sdmUgfCByZWplY3QgfCBub3RpZnkgXQogICAgICAgIGRlZmVycmVkW3R1cGxlWzBdXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRlZmVycmVkW3R1cGxlWzBdICsgJ1dpdGgnXSh0aGlzID09PSBkZWZlcnJlZCA/IHByb21pc2UgOiB0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBkZWZlcnJlZFt0dXBsZVswXSArICdXaXRoJ10gPSBsaXN0LmZpcmVXaXRoOwogICAgICB9KTsKICAgICAgLy8gTWFrZSB0aGUgZGVmZXJyZWQgYSBwcm9taXNlCiAgICAgIHByb21pc2UucHJvbWlzZShkZWZlcnJlZCk7CiAgICAgIC8vIENhbGwgZ2l2ZW4gZnVuYyBpZiBhbnkKICAgICAgaWYgKGZ1bmMpIHsKICAgICAgICBmdW5jLmNhbGwoZGVmZXJyZWQsIGRlZmVycmVkKTsKICAgICAgfQogICAgICAvLyBBbGwgZG9uZSEKICAgICAgcmV0dXJuIGRlZmVycmVkOwogICAgfSwKICAgIC8vIERlZmVycmVkIGhlbHBlcgogICAgd2hlbjogZnVuY3Rpb24gKHN1Ym9yZGluYXRlKSB7CiAgICAgIHZhciBpID0gMCwgcmVzb2x2ZVZhbHVlcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKSwgbGVuZ3RoID0gcmVzb2x2ZVZhbHVlcy5sZW5ndGgsCiAgICAgICAgLy8gdGhlIGNvdW50IG9mIHVuY29tcGxldGVkIHN1Ym9yZGluYXRlcwogICAgICAgIHJlbWFpbmluZyA9IGxlbmd0aCAhPT0gMSB8fCBzdWJvcmRpbmF0ZSAmJiBqUXVlcnkuaXNGdW5jdGlvbihzdWJvcmRpbmF0ZS5wcm9taXNlKSA/IGxlbmd0aCA6IDAsCiAgICAgICAgLy8gdGhlIG1hc3RlciBEZWZlcnJlZC4gSWYgcmVzb2x2ZVZhbHVlcyBjb25zaXN0IG9mIG9ubHkgYSBzaW5nbGUgRGVmZXJyZWQsIGp1c3QgdXNlIHRoYXQuCiAgICAgICAgZGVmZXJyZWQgPSByZW1haW5pbmcgPT09IDEgPyBzdWJvcmRpbmF0ZSA6IGpRdWVyeS5EZWZlcnJlZCgpLAogICAgICAgIC8vIFVwZGF0ZSBmdW5jdGlvbiBmb3IgYm90aCByZXNvbHZlIGFuZCBwcm9ncmVzcyB2YWx1ZXMKICAgICAgICB1cGRhdGVGdW5jID0gZnVuY3Rpb24gKGksIGNvbnRleHRzLCB2YWx1ZXMpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgY29udGV4dHNbaV0gPSB0aGlzOwogICAgICAgICAgICB2YWx1ZXNbaV0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSA/IHNsaWNlLmNhbGwoYXJndW1lbnRzKSA6IHZhbHVlOwogICAgICAgICAgICBpZiAodmFsdWVzID09PSBwcm9ncmVzc1ZhbHVlcykgewogICAgICAgICAgICAgIGRlZmVycmVkLm5vdGlmeVdpdGgoY29udGV4dHMsIHZhbHVlcyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIS0tcmVtYWluaW5nKSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoY29udGV4dHMsIHZhbHVlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfSwgcHJvZ3Jlc3NWYWx1ZXMsIHByb2dyZXNzQ29udGV4dHMsIHJlc29sdmVDb250ZXh0czsKICAgICAgLy8gYWRkIGxpc3RlbmVycyB0byBEZWZlcnJlZCBzdWJvcmRpbmF0ZXM7IHRyZWF0IG90aGVycyBhcyByZXNvbHZlZAogICAgICBpZiAobGVuZ3RoID4gMSkgewogICAgICAgIHByb2dyZXNzVmFsdWVzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgcHJvZ3Jlc3NDb250ZXh0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIHJlc29sdmVDb250ZXh0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChyZXNvbHZlVmFsdWVzW2ldICYmIGpRdWVyeS5pc0Z1bmN0aW9uKHJlc29sdmVWYWx1ZXNbaV0ucHJvbWlzZSkpIHsKICAgICAgICAgICAgcmVzb2x2ZVZhbHVlc1tpXS5wcm9taXNlKCkuZG9uZSh1cGRhdGVGdW5jKGksIHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcykpLmZhaWwoZGVmZXJyZWQucmVqZWN0KS5wcm9ncmVzcyh1cGRhdGVGdW5jKGksIHByb2dyZXNzQ29udGV4dHMsIHByb2dyZXNzVmFsdWVzKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAtLXJlbWFpbmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gaWYgd2UncmUgbm90IHdhaXRpbmcgb24gYW55dGhpbmcsIHJlc29sdmUgdGhlIG1hc3RlcgogICAgICBpZiAoIXJlbWFpbmluZykgewogICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKICAgIH0KICB9KTsKICAvLyBUaGUgZGVmZXJyZWQgdXNlZCBvbiBET00gcmVhZHkKICB2YXIgcmVhZHlMaXN0OwogIGpRdWVyeS5mbi5yZWFkeSA9IGZ1bmN0aW9uIChmbikgewogICAgLy8gQWRkIHRoZSBjYWxsYmFjawogICAgalF1ZXJ5LnJlYWR5LnByb21pc2UoKS5kb25lKGZuKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgogICAgaXNSZWFkeTogZmFsc2UsCiAgICAvLyBBIGNvdW50ZXIgdG8gdHJhY2sgaG93IG1hbnkgaXRlbXMgdG8gd2FpdCBmb3IgYmVmb3JlCiAgICAvLyB0aGUgcmVhZHkgZXZlbnQgZmlyZXMuIFNlZSAjNjc4MQogICAgcmVhZHlXYWl0OiAxLAogICAgLy8gSG9sZCAob3IgcmVsZWFzZSkgdGhlIHJlYWR5IGV2ZW50CiAgICBob2xkUmVhZHk6IGZ1bmN0aW9uIChob2xkKSB7CiAgICAgIGlmIChob2xkKSB7CiAgICAgICAgalF1ZXJ5LnJlYWR5V2FpdCsrOwogICAgICB9IGVsc2UgewogICAgICAgIGpRdWVyeS5yZWFkeSh0cnVlKTsKICAgICAgfQogICAgfSwKICAgIC8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIHJlYWR5OiBmdW5jdGlvbiAod2FpdCkgewogICAgICAvLyBBYm9ydCBpZiB0aGVyZSBhcmUgcGVuZGluZyBob2xkcyBvciB3ZSdyZSBhbHJlYWR5IHJlYWR5CiAgICAgIGlmICh3YWl0ID09PSB0cnVlID8gLS1qUXVlcnkucmVhZHlXYWl0IDogalF1ZXJ5LmlzUmVhZHkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CiAgICAgIGpRdWVyeS5pc1JlYWR5ID0gdHJ1ZTsKICAgICAgLy8gSWYgYSBub3JtYWwgRE9NIFJlYWR5IGV2ZW50IGZpcmVkLCBkZWNyZW1lbnQsIGFuZCB3YWl0IGlmIG5lZWQgYmUKICAgICAgaWYgKHdhaXQgIT09IHRydWUgJiYgLS1qUXVlcnkucmVhZHlXYWl0ID4gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCiAgICAgIHJlYWR5TGlzdC5yZXNvbHZlV2l0aChkb2N1bWVudCwgW2pRdWVyeV0pOwogICAgICAvLyBUcmlnZ2VyIGFueSBib3VuZCByZWFkeSBldmVudHMKICAgICAgaWYgKGpRdWVyeS5mbi50cmlnZ2VySGFuZGxlcikgewogICAgICAgIGpRdWVyeShkb2N1bWVudCkudHJpZ2dlckhhbmRsZXIoJ3JlYWR5Jyk7CiAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS5vZmYoJ3JlYWR5Jyk7CiAgICAgIH0KICAgIH0KICB9KTsKICAvKioKICAgKiBUaGUgcmVhZHkgZXZlbnQgaGFuZGxlciBhbmQgc2VsZiBjbGVhbnVwIG1ldGhvZAogICAqLwogIGZ1bmN0aW9uIGNvbXBsZXRlZCgpIHsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBjb21wbGV0ZWQsIGZhbHNlKTsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdsb2FkJywgY29tcGxldGVkLCBmYWxzZSk7CiAgICBqUXVlcnkucmVhZHkoKTsKICB9CiAgalF1ZXJ5LnJlYWR5LnByb21pc2UgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBpZiAoIXJlYWR5TGlzdCkgewogICAgICByZWFkeUxpc3QgPSBqUXVlcnkuRGVmZXJyZWQoKTsKICAgICAgLy8gQ2F0Y2ggY2FzZXMgd2hlcmUgJChkb2N1bWVudCkucmVhZHkoKSBpcyBjYWxsZWQgYWZ0ZXIgdGhlIGJyb3dzZXIgZXZlbnQgaGFzIGFscmVhZHkgb2NjdXJyZWQuCiAgICAgIC8vIHdlIG9uY2UgdHJpZWQgdG8gdXNlIHJlYWR5U3RhdGUgImludGVyYWN0aXZlIiBoZXJlLCBidXQgaXQgY2F1c2VkIGlzc3VlcyBsaWtlIHRoZSBvbmUKICAgICAgLy8gZGlzY292ZXJlZCBieSBDaHJpc1MgaGVyZTogaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIyODIjY29tbWVudDoxNQogICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykgewogICAgICAgIC8vIEhhbmRsZSBpdCBhc3luY2hyb25vdXNseSB0byBhbGxvdyBzY3JpcHRzIHRoZSBvcHBvcnR1bml0eSB0byBkZWxheSByZWFkeQogICAgICAgIHNldFRpbWVvdXQoalF1ZXJ5LnJlYWR5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBVc2UgdGhlIGhhbmR5IGV2ZW50IGNhbGxiYWNrCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGNvbXBsZXRlZCwgZmFsc2UpOwogICAgICAgIC8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBjb21wbGV0ZWQsIGZhbHNlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlYWR5TGlzdC5wcm9taXNlKG9iaik7CiAgfTsKICAvLyBLaWNrIG9mZiB0aGUgRE9NIHJlYWR5IGNoZWNrIGV2ZW4gaWYgdGhlIHVzZXIgZG9lcyBub3QKICBqUXVlcnkucmVhZHkucHJvbWlzZSgpOwogIC8vIE11bHRpZnVuY3Rpb25hbCBtZXRob2QgdG8gZ2V0IGFuZCBzZXQgdmFsdWVzIG9mIGEgY29sbGVjdGlvbgogIC8vIFRoZSB2YWx1ZS9zIGNhbiBvcHRpb25hbGx5IGJlIGV4ZWN1dGVkIGlmIGl0J3MgYSBmdW5jdGlvbgogIHZhciBhY2Nlc3MgPSBqUXVlcnkuYWNjZXNzID0gZnVuY3Rpb24gKGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcmF3KSB7CiAgICB2YXIgaSA9IDAsIGxlbiA9IGVsZW1zLmxlbmd0aCwgYnVsayA9IGtleSA9PSBudWxsOwogICAgLy8gU2V0cyBtYW55IHZhbHVlcwogICAgaWYgKGpRdWVyeS50eXBlKGtleSkgPT09ICdvYmplY3QnKSB7CiAgICAgIGNoYWluYWJsZSA9IHRydWU7CiAgICAgIGZvciAoaSBpbiBrZXkpIHsKICAgICAgICBqUXVlcnkuYWNjZXNzKGVsZW1zLCBmbiwgaSwga2V5W2ldLCB0cnVlLCBlbXB0eUdldCwgcmF3KTsKICAgICAgfSAgLy8gU2V0cyBvbmUgdmFsdWUKICAgIH0gZWxzZSBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICBjaGFpbmFibGUgPSB0cnVlOwogICAgICBpZiAoIWpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJhdyA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGJ1bGspIHsKICAgICAgICAvLyBCdWxrIG9wZXJhdGlvbnMgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKICAgICAgICBpZiAocmF3KSB7CiAgICAgICAgICBmbi5jYWxsKGVsZW1zLCB2YWx1ZSk7CiAgICAgICAgICBmbiA9IG51bGw7ICAvLyAuLi5leGNlcHQgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJ1bGsgPSBmbjsKICAgICAgICAgIGZuID0gZnVuY3Rpb24gKGVsZW0sIGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGJ1bGsuY2FsbChqUXVlcnkoZWxlbSksIHZhbHVlKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmbikgewogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGZuKGVsZW1zW2ldLCBrZXksIHJhdyA/IHZhbHVlIDogdmFsdWUuY2FsbChlbGVtc1tpXSwgaSwgZm4oZWxlbXNbaV0sIGtleSkpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjaGFpbmFibGUgPyBlbGVtcyA6IC8vIEdldHMKICAgIGJ1bGsgPyBmbi5jYWxsKGVsZW1zKSA6IGxlbiA/IGZuKGVsZW1zWzBdLCBrZXkpIDogZW1wdHlHZXQ7CiAgfTsKICAvKioKICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgYW4gb2JqZWN0IGNhbiBoYXZlIGRhdGEKICAgKi8KICBqUXVlcnkuYWNjZXB0RGF0YSA9IGZ1bmN0aW9uIChvd25lcikgewogICAgLy8gQWNjZXB0cyBvbmx5OgogICAgLy8gIC0gTm9kZQogICAgLy8gICAgLSBOb2RlLkVMRU1FTlRfTk9ERQogICAgLy8gICAgLSBOb2RlLkRPQ1VNRU5UX05PREUKICAgIC8vICAtIE9iamVjdAogICAgLy8gICAgLSBBbnkKICAgIC8qIGpzaGludCAtVzAxOCAqLwogICAgcmV0dXJuIG93bmVyLm5vZGVUeXBlID09PSAxIHx8IG93bmVyLm5vZGVUeXBlID09PSA5IHx8ICErb3duZXIubm9kZVR5cGU7CiAgfTsKICBmdW5jdGlvbiBEYXRhKCkgewogICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQsCiAgICAvLyBPbGQgV2ViS2l0IGRvZXMgbm90IGhhdmUgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zL2ZyZWV6ZSBtZXRob2QsCiAgICAvLyByZXR1cm4gbmV3IGVtcHR5IG9iamVjdCBpbnN0ZWFkIHdpdGggbm8gW1tzZXRdXSBhY2Nlc3NvcgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMuY2FjaGUgPSB7fSwgMCwgewogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4ge307CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5leHBhbmRvID0galF1ZXJ5LmV4cGFuZG8gKyBNYXRoLnJhbmRvbSgpOwogIH0KICBEYXRhLnVpZCA9IDE7CiAgRGF0YS5hY2NlcHRzID0galF1ZXJ5LmFjY2VwdERhdGE7CiAgRGF0YS5wcm90b3R5cGUgPSB7CiAgICBrZXk6IGZ1bmN0aW9uIChvd25lcikgewogICAgICAvLyBXZSBjYW4gYWNjZXB0IGRhdGEgZm9yIG5vbi1lbGVtZW50IG5vZGVzIGluIG1vZGVybiBicm93c2VycywKICAgICAgLy8gYnV0IHdlIHNob3VsZCBub3QsIHNlZSAjODMzNS4KICAgICAgLy8gQWx3YXlzIHJldHVybiB0aGUga2V5IGZvciBhIGZyb3plbiBvYmplY3QuCiAgICAgIGlmICghRGF0YS5hY2NlcHRzKG93bmVyKSkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIHZhciBkZXNjcmlwdG9yID0ge30sCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIG93bmVyIG9iamVjdCBhbHJlYWR5IGhhcyBhIGNhY2hlIGtleQogICAgICAgIHVubG9jayA9IG93bmVyW3RoaXMuZXhwYW5kb107CiAgICAgIC8vIElmIG5vdCwgY3JlYXRlIG9uZQogICAgICBpZiAoIXVubG9jaykgewogICAgICAgIHVubG9jayA9IERhdGEudWlkKys7CiAgICAgICAgLy8gU2VjdXJlIGl0IGluIGEgbm9uLWVudW1lcmFibGUsIG5vbi13cml0YWJsZSBwcm9wZXJ0eQogICAgICAgIHRyeSB7CiAgICAgICAgICBkZXNjcmlwdG9yW3RoaXMuZXhwYW5kb10gPSB7IHZhbHVlOiB1bmxvY2sgfTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKG93bmVyLCBkZXNjcmlwdG9yKTsgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPCA0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBhIGxlc3Mgc2VjdXJlIGRlZmluaXRpb24KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBkZXNjcmlwdG9yW3RoaXMuZXhwYW5kb10gPSB1bmxvY2s7CiAgICAgICAgICBqUXVlcnkuZXh0ZW5kKG93bmVyLCBkZXNjcmlwdG9yKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRW5zdXJlIHRoZSBjYWNoZSBvYmplY3QKICAgICAgaWYgKCF0aGlzLmNhY2hlW3VubG9ja10pIHsKICAgICAgICB0aGlzLmNhY2hlW3VubG9ja10gPSB7fTsKICAgICAgfQogICAgICByZXR1cm4gdW5sb2NrOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gKG93bmVyLCBkYXRhLCB2YWx1ZSkgewogICAgICB2YXIgcHJvcCwKICAgICAgICAvLyBUaGVyZSBtYXkgYmUgYW4gdW5sb2NrIGFzc2lnbmVkIHRvIHRoaXMgbm9kZSwKICAgICAgICAvLyBpZiB0aGVyZSBpcyBubyBlbnRyeSBmb3IgdGhpcyAib3duZXIiLCBjcmVhdGUgb25lIGlubGluZQogICAgICAgIC8vIGFuZCBzZXQgdGhlIHVubG9jayBhcyB0aG91Z2ggYW4gb3duZXIgZW50cnkgaGFkIGFsd2F5cyBleGlzdGVkCiAgICAgICAgdW5sb2NrID0gdGhpcy5rZXkob3duZXIpLCBjYWNoZSA9IHRoaXMuY2FjaGVbdW5sb2NrXTsKICAgICAgLy8gSGFuZGxlOiBbIG93bmVyLCBrZXksIHZhbHVlIF0gYXJncwogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgY2FjaGVbZGF0YV0gPSB2YWx1ZTsgIC8vIEhhbmRsZTogWyBvd25lciwgeyBwcm9wZXJ0aWVzIH0gXSBhcmdzCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRnJlc2ggYXNzaWdubWVudHMgYnkgb2JqZWN0IGFyZSBzaGFsbG93IGNvcGllZAogICAgICAgIGlmIChqUXVlcnkuaXNFbXB0eU9iamVjdChjYWNoZSkpIHsKICAgICAgICAgIGpRdWVyeS5leHRlbmQodGhpcy5jYWNoZVt1bmxvY2tdLCBkYXRhKTsgIC8vIE90aGVyd2lzZSwgY29weSB0aGUgcHJvcGVydGllcyBvbmUtYnktb25lIHRvIHRoZSBjYWNoZSBvYmplY3QKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChwcm9wIGluIGRhdGEpIHsKICAgICAgICAgICAgY2FjaGVbcHJvcF0gPSBkYXRhW3Byb3BdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gY2FjaGU7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiAob3duZXIsIGtleSkgewogICAgICAvLyBFaXRoZXIgYSB2YWxpZCBjYWNoZSBpcyBmb3VuZCwgb3Igd2lsbCBiZSBjcmVhdGVkLgogICAgICAvLyBOZXcgY2FjaGVzIHdpbGwgYmUgY3JlYXRlZCBhbmQgdGhlIHVubG9jayByZXR1cm5lZCwKICAgICAgLy8gYWxsb3dpbmcgZGlyZWN0IGFjY2VzcyB0byB0aGUgbmV3bHkgY3JlYXRlZAogICAgICAvLyBlbXB0eSBkYXRhIG9iamVjdC4gQSB2YWxpZCBvd25lciBvYmplY3QgbXVzdCBiZSBwcm92aWRlZC4KICAgICAgdmFyIGNhY2hlID0gdGhpcy5jYWNoZVt0aGlzLmtleShvd25lcildOwogICAgICByZXR1cm4ga2V5ID09PSB1bmRlZmluZWQgPyBjYWNoZSA6IGNhY2hlW2tleV07CiAgICB9LAogICAgYWNjZXNzOiBmdW5jdGlvbiAob3duZXIsIGtleSwgdmFsdWUpIHsKICAgICAgdmFyIHN0b3JlZDsKICAgICAgLy8gSW4gY2FzZXMgd2hlcmUgZWl0aGVyOgogICAgICAvLwogICAgICAvLyAgIDEuIE5vIGtleSB3YXMgc3BlY2lmaWVkCiAgICAgIC8vICAgMi4gQSBzdHJpbmcga2V5IHdhcyBzcGVjaWZpZWQsIGJ1dCBubyB2YWx1ZSBwcm92aWRlZAogICAgICAvLwogICAgICAvLyBUYWtlIHRoZSAicmVhZCIgcGF0aCBhbmQgYWxsb3cgdGhlIGdldCBtZXRob2QgdG8gZGV0ZXJtaW5lCiAgICAgIC8vIHdoaWNoIHZhbHVlIHRvIHJldHVybiwgcmVzcGVjdGl2ZWx5IGVpdGhlcjoKICAgICAgLy8KICAgICAgLy8gICAxLiBUaGUgZW50aXJlIGNhY2hlIG9iamVjdAogICAgICAvLyAgIDIuIFRoZSBkYXRhIHN0b3JlZCBhdCB0aGUga2V5CiAgICAgIC8vCiAgICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCB8fCBrZXkgJiYgdHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHN0b3JlZCA9IHRoaXMuZ2V0KG93bmVyLCBrZXkpOwogICAgICAgIHJldHVybiBzdG9yZWQgIT09IHVuZGVmaW5lZCA/IHN0b3JlZCA6IHRoaXMuZ2V0KG93bmVyLCBqUXVlcnkuY2FtZWxDYXNlKGtleSkpOwogICAgICB9CiAgICAgIC8vIFsqXVdoZW4gdGhlIGtleSBpcyBub3QgYSBzdHJpbmcsIG9yIGJvdGggYSBrZXkgYW5kIHZhbHVlCiAgICAgIC8vIGFyZSBzcGVjaWZpZWQsIHNldCBvciBleHRlbmQgKGV4aXN0aW5nIG9iamVjdHMpIHdpdGggZWl0aGVyOgogICAgICAvLwogICAgICAvLyAgIDEuIEFuIG9iamVjdCBvZiBwcm9wZXJ0aWVzCiAgICAgIC8vICAgMi4gQSBrZXkgYW5kIHZhbHVlCiAgICAgIC8vCiAgICAgIHRoaXMuc2V0KG93bmVyLCBrZXksIHZhbHVlKTsKICAgICAgLy8gU2luY2UgdGhlICJzZXQiIHBhdGggY2FuIGhhdmUgdHdvIHBvc3NpYmxlIGVudHJ5IHBvaW50cwogICAgICAvLyByZXR1cm4gdGhlIGV4cGVjdGVkIGRhdGEgYmFzZWQgb24gd2hpY2ggcGF0aCB3YXMgdGFrZW5bKl0KICAgICAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPyB2YWx1ZSA6IGtleTsKICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uIChvd25lciwga2V5KSB7CiAgICAgIHZhciBpLCBuYW1lLCBjYW1lbCwgdW5sb2NrID0gdGhpcy5rZXkob3duZXIpLCBjYWNoZSA9IHRoaXMuY2FjaGVbdW5sb2NrXTsKICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5jYWNoZVt1bmxvY2tdID0ge307CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU3VwcG9ydCBhcnJheSBvciBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIG9mIGtleXMKICAgICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkoa2V5KSkgewogICAgICAgICAgLy8gSWYgIm5hbWUiIGlzIGFuIGFycmF5IG9mIGtleXMuLi4KICAgICAgICAgIC8vIFdoZW4gZGF0YSBpcyBpbml0aWFsbHkgY3JlYXRlZCwgdmlhICgia2V5IiwgInZhbCIpIHNpZ25hdHVyZSwKICAgICAgICAgIC8vIGtleXMgd2lsbCBiZSBjb252ZXJ0ZWQgdG8gY2FtZWxDYXNlLgogICAgICAgICAgLy8gU2luY2UgdGhlcmUgaXMgbm8gd2F5IHRvIHRlbGwgX2hvd18gYSBrZXkgd2FzIGFkZGVkLCByZW1vdmUKICAgICAgICAgIC8vIGJvdGggcGxhaW4ga2V5IGFuZCBjYW1lbENhc2Uga2V5LiAjMTI3ODYKICAgICAgICAgIC8vIFRoaXMgd2lsbCBvbmx5IHBlbmFsaXplIHRoZSBhcnJheSBhcmd1bWVudCBwYXRoLgogICAgICAgICAgbmFtZSA9IGtleS5jb25jYXQoa2V5Lm1hcChqUXVlcnkuY2FtZWxDYXNlKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhbWVsID0galF1ZXJ5LmNhbWVsQ2FzZShrZXkpOwogICAgICAgICAgLy8gVHJ5IHRoZSBzdHJpbmcgYXMgYSBrZXkgYmVmb3JlIGFueSBtYW5pcHVsYXRpb24KICAgICAgICAgIGlmIChrZXkgaW4gY2FjaGUpIHsKICAgICAgICAgICAgbmFtZSA9IFsKICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgY2FtZWwKICAgICAgICAgICAgXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIElmIGEga2V5IHdpdGggdGhlIHNwYWNlcyBleGlzdHMsIHVzZSBpdC4KICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBjcmVhdGUgYW4gYXJyYXkgYnkgbWF0Y2hpbmcgbm9uLXdoaXRlc3BhY2UKICAgICAgICAgICAgbmFtZSA9IGNhbWVsOwogICAgICAgICAgICBuYW1lID0gbmFtZSBpbiBjYWNoZSA/IFtuYW1lXSA6IG5hbWUubWF0Y2gocm5vdHdoaXRlKSB8fCBbXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaSA9IG5hbWUubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGRlbGV0ZSBjYWNoZVtuYW1lW2ldXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBoYXNEYXRhOiBmdW5jdGlvbiAob3duZXIpIHsKICAgICAgcmV0dXJuICFqUXVlcnkuaXNFbXB0eU9iamVjdCh0aGlzLmNhY2hlW293bmVyW3RoaXMuZXhwYW5kb11dIHx8IHt9KTsKICAgIH0sCiAgICBkaXNjYXJkOiBmdW5jdGlvbiAob3duZXIpIHsKICAgICAgaWYgKG93bmVyW3RoaXMuZXhwYW5kb10pIHsKICAgICAgICBkZWxldGUgdGhpcy5jYWNoZVtvd25lclt0aGlzLmV4cGFuZG9dXTsKICAgICAgfQogICAgfQogIH07CiAgdmFyIGRhdGFfcHJpdiA9IG5ldyBEYXRhKCk7CiAgdmFyIGRhdGFfdXNlciA9IG5ldyBEYXRhKCk7CiAgLyoKICAJSW1wbGVtZW50YXRpb24gU3VtbWFyeQogIAogIAkxLiBFbmZvcmNlIEFQSSBzdXJmYWNlIGFuZCBzZW1hbnRpYyBjb21wYXRpYmlsaXR5IHdpdGggMS45LnggYnJhbmNoCiAgCTIuIEltcHJvdmUgdGhlIG1vZHVsZSdzIG1haW50YWluYWJpbGl0eSBieSByZWR1Y2luZyB0aGUgc3RvcmFnZQogIAkJcGF0aHMgdG8gYSBzaW5nbGUgbWVjaGFuaXNtLgogIAkzLiBVc2UgdGhlIHNhbWUgc2luZ2xlIG1lY2hhbmlzbSB0byBzdXBwb3J0ICJwcml2YXRlIiBhbmQgInVzZXIiIGRhdGEuCiAgCTQuIF9OZXZlcl8gZXhwb3NlICJwcml2YXRlIiBkYXRhIHRvIHVzZXIgY29kZSAoVE9ETzogRHJvcCBfZGF0YSwgX3JlbW92ZURhdGEpCiAgCTUuIEF2b2lkIGV4cG9zaW5nIGltcGxlbWVudGF0aW9uIGRldGFpbHMgb24gdXNlciBvYmplY3RzIChlZy4gZXhwYW5kbyBwcm9wZXJ0aWVzKQogIAk2LiBQcm92aWRlIGEgY2xlYXIgcGF0aCBmb3IgaW1wbGVtZW50YXRpb24gdXBncmFkZSB0byBXZWFrTWFwIGluIDIwMTQKICAqLwogIHZhciByYnJhY2UgPSAvXig/Olx7W1x3XFddKlx9fFxbW1x3XFddKlxdKSQvLCBybXVsdGlEYXNoID0gLyhbQS1aXSkvZzsKICBmdW5jdGlvbiBkYXRhQXR0cihlbGVtLCBrZXksIGRhdGEpIHsKICAgIHZhciBuYW1lOwogICAgLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW50ZXJuYWxseSwgdHJ5IHRvIGZldGNoIGFueQogICAgLy8gZGF0YSBmcm9tIHRoZSBIVE1MNSBkYXRhLSogYXR0cmlidXRlCiAgICBpZiAoZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgbmFtZSA9ICdkYXRhLScgKyBrZXkucmVwbGFjZShybXVsdGlEYXNoLCAnLSQxJykudG9Mb3dlckNhc2UoKTsKICAgICAgZGF0YSA9IGVsZW0uZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGRhdGEgPSBkYXRhID09PSAndHJ1ZScgPyB0cnVlIDogZGF0YSA9PT0gJ2ZhbHNlJyA/IGZhbHNlIDogZGF0YSA9PT0gJ251bGwnID8gbnVsbCA6IC8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCiAgICAgICAgICArZGF0YSArICcnID09PSBkYXRhID8gK2RhdGEgOiByYnJhY2UudGVzdChkYXRhKSA/IGpRdWVyeS5wYXJzZUpTT04oZGF0YSkgOiBkYXRhOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgLy8gTWFrZSBzdXJlIHdlIHNldCB0aGUgZGF0YSBzbyBpdCBpc24ndCBjaGFuZ2VkIGxhdGVyCiAgICAgICAgZGF0YV91c2VyLnNldChlbGVtLCBrZXksIGRhdGEpOwogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICBqUXVlcnkuZXh0ZW5kKHsKICAgIGhhc0RhdGE6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBkYXRhX3VzZXIuaGFzRGF0YShlbGVtKSB8fCBkYXRhX3ByaXYuaGFzRGF0YShlbGVtKTsKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZGF0YSkgewogICAgICByZXR1cm4gZGF0YV91c2VyLmFjY2VzcyhlbGVtLCBuYW1lLCBkYXRhKTsKICAgIH0sCiAgICByZW1vdmVEYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICBkYXRhX3VzZXIucmVtb3ZlKGVsZW0sIG5hbWUpOwogICAgfSwKICAgIC8vIFRPRE86IE5vdyB0aGF0IGFsbCBjYWxscyB0byBfZGF0YSBhbmQgX3JlbW92ZURhdGEgaGF2ZSBiZWVuIHJlcGxhY2VkCiAgICAvLyB3aXRoIGRpcmVjdCBjYWxscyB0byBkYXRhX3ByaXYgbWV0aG9kcywgdGhlc2UgY2FuIGJlIGRlcHJlY2F0ZWQuCiAgICBfZGF0YTogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGRhdGEpIHsKICAgICAgcmV0dXJuIGRhdGFfcHJpdi5hY2Nlc3MoZWxlbSwgbmFtZSwgZGF0YSk7CiAgICB9LAogICAgX3JlbW92ZURhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgIGRhdGFfcHJpdi5yZW1vdmUoZWxlbSwgbmFtZSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBkYXRhOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICB2YXIgaSwgbmFtZSwgZGF0YSwgZWxlbSA9IHRoaXNbMF0sIGF0dHJzID0gZWxlbSAmJiBlbGVtLmF0dHJpYnV0ZXM7CiAgICAgIC8vIEdldHMgYWxsIHZhbHVlcwogICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAodGhpcy5sZW5ndGgpIHsKICAgICAgICAgIGRhdGEgPSBkYXRhX3VzZXIuZ2V0KGVsZW0pOwogICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWRhdGFfcHJpdi5nZXQoZWxlbSwgJ2hhc0RhdGFBdHRycycpKSB7CiAgICAgICAgICAgIGkgPSBhdHRycy5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBJRTExKwogICAgICAgICAgICAgIC8vIFRoZSBhdHRycyBlbGVtZW50cyBjYW4gYmUgbnVsbCAoIzE0ODk0KQogICAgICAgICAgICAgIGlmIChhdHRyc1tpXSkgewogICAgICAgICAgICAgICAgbmFtZSA9IGF0dHJzW2ldLm5hbWU7CiAgICAgICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCdkYXRhLScpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIG5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKG5hbWUuc2xpY2UoNSkpOwogICAgICAgICAgICAgICAgICBkYXRhQXR0cihlbGVtLCBuYW1lLCBkYXRhW25hbWVdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YV9wcml2LnNldChlbGVtLCAnaGFzRGF0YUF0dHJzJywgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkYXRhOwogICAgICB9CiAgICAgIC8vIFNldHMgbXVsdGlwbGUgdmFsdWVzCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgZGF0YV91c2VyLnNldCh0aGlzLCBrZXkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdmFyIGRhdGEsIGNhbWVsS2V5ID0galF1ZXJ5LmNhbWVsQ2FzZShrZXkpOwogICAgICAgIC8vIFRoZSBjYWxsaW5nIGpRdWVyeSBvYmplY3QgKGVsZW1lbnQgbWF0Y2hlcykgaXMgbm90IGVtcHR5CiAgICAgICAgLy8gKGFuZCB0aGVyZWZvcmUgaGFzIGFuIGVsZW1lbnQgYXBwZWFycyBhdCB0aGlzWyAwIF0pIGFuZCB0aGUKICAgICAgICAvLyBgdmFsdWVgIHBhcmFtZXRlciB3YXMgbm90IHVuZGVmaW5lZC4gQW4gZW1wdHkgalF1ZXJ5IG9iamVjdAogICAgICAgIC8vIHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGZvciBlbGVtID0gdGhpc1sgMCBdIHdoaWNoIHdpbGwKICAgICAgICAvLyB0aHJvdyBhbiBleGNlcHRpb24gaWYgYW4gYXR0ZW1wdCB0byByZWFkIGEgZGF0YSBjYWNoZSBpcyBtYWRlLgogICAgICAgIGlmIChlbGVtICYmIHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIC8vIEF0dGVtcHQgdG8gZ2V0IGRhdGEgZnJvbSB0aGUgY2FjaGUKICAgICAgICAgIC8vIHdpdGggdGhlIGtleSBhcy1pcwogICAgICAgICAgZGF0YSA9IGRhdGFfdXNlci5nZXQoZWxlbSwga2V5KTsKICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBBdHRlbXB0IHRvIGdldCBkYXRhIGZyb20gdGhlIGNhY2hlCiAgICAgICAgICAvLyB3aXRoIHRoZSBrZXkgY2FtZWxpemVkCiAgICAgICAgICBkYXRhID0gZGF0YV91c2VyLmdldChlbGVtLCBjYW1lbEtleSk7CiAgICAgICAgICBpZiAoZGF0YSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgICAgfQogICAgICAgICAgLy8gQXR0ZW1wdCB0byAiZGlzY292ZXIiIHRoZSBkYXRhIGluCiAgICAgICAgICAvLyBIVE1MNSBjdXN0b20gZGF0YS0qIGF0dHJzCiAgICAgICAgICBkYXRhID0gZGF0YUF0dHIoZWxlbSwgY2FtZWxLZXksIHVuZGVmaW5lZCk7CiAgICAgICAgICBpZiAoZGF0YSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgICAgfQogICAgICAgICAgLy8gV2UgdHJpZWQgcmVhbGx5IGhhcmQsIGJ1dCB0aGUgZGF0YSBkb2Vzbid0IGV4aXN0LgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBTZXQgdGhlIGRhdGEuLi4KICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gRmlyc3QsIGF0dGVtcHQgdG8gc3RvcmUgYSBjb3B5IG9yIHJlZmVyZW5jZSBvZiBhbnkKICAgICAgICAgIC8vIGRhdGEgdGhhdCBtaWdodCd2ZSBiZWVuIHN0b3JlIHdpdGggYSBjYW1lbENhc2VkIGtleS4KICAgICAgICAgIHZhciBkYXRhID0gZGF0YV91c2VyLmdldCh0aGlzLCBjYW1lbEtleSk7CiAgICAgICAgICAvLyBGb3IgSFRNTDUgZGF0YS0qIGF0dHJpYnV0ZSBpbnRlcm9wLCB3ZSBoYXZlIHRvCiAgICAgICAgICAvLyBzdG9yZSBwcm9wZXJ0eSBuYW1lcyB3aXRoIGRhc2hlcyBpbiBhIGNhbWVsQ2FzZSBmb3JtLgogICAgICAgICAgLy8gVGhpcyBtaWdodCBub3QgYXBwbHkgdG8gYWxsIHByb3BlcnRpZXMuLi4qCiAgICAgICAgICBkYXRhX3VzZXIuc2V0KHRoaXMsIGNhbWVsS2V5LCB2YWx1ZSk7CiAgICAgICAgICAvLyAqLi4uIEluIHRoZSBjYXNlIG9mIHByb3BlcnRpZXMgdGhhdCBtaWdodCBfYWN0dWFsbHlfCiAgICAgICAgICAvLyBoYXZlIGRhc2hlcywgd2UgbmVlZCB0byBhbHNvIHN0b3JlIGEgY29weSBvZiB0aGF0CiAgICAgICAgICAvLyB1bmNoYW5nZWQgcHJvcGVydHkuCiAgICAgICAgICBpZiAoa2V5LmluZGV4T2YoJy0nKSAhPT0gLTEgJiYgZGF0YSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGRhdGFfdXNlci5zZXQodGhpcywga2V5LCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSwgbnVsbCwgdHJ1ZSk7CiAgICB9LAogICAgcmVtb3ZlRGF0YTogZnVuY3Rpb24gKGtleSkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBkYXRhX3VzZXIucmVtb3ZlKHRoaXMsIGtleSk7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgcXVldWU6IGZ1bmN0aW9uIChlbGVtLCB0eXBlLCBkYXRhKSB7CiAgICAgIHZhciBxdWV1ZTsKICAgICAgaWYgKGVsZW0pIHsKICAgICAgICB0eXBlID0gKHR5cGUgfHwgJ2Z4JykgKyAncXVldWUnOwogICAgICAgIHF1ZXVlID0gZGF0YV9wcml2LmdldChlbGVtLCB0eXBlKTsKICAgICAgICAvLyBTcGVlZCB1cCBkZXF1ZXVlIGJ5IGdldHRpbmcgb3V0IHF1aWNrbHkgaWYgdGhpcyBpcyBqdXN0IGEgbG9va3VwCiAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgIGlmICghcXVldWUgfHwgalF1ZXJ5LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgcXVldWUgPSBkYXRhX3ByaXYuYWNjZXNzKGVsZW0sIHR5cGUsIGpRdWVyeS5tYWtlQXJyYXkoZGF0YSkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcXVldWUucHVzaChkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHF1ZXVlIHx8IFtdOwogICAgICB9CiAgICB9LAogICAgZGVxdWV1ZTogZnVuY3Rpb24gKGVsZW0sIHR5cGUpIHsKICAgICAgdHlwZSA9IHR5cGUgfHwgJ2Z4JzsKICAgICAgdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKGVsZW0sIHR5cGUpLCBzdGFydExlbmd0aCA9IHF1ZXVlLmxlbmd0aCwgZm4gPSBxdWV1ZS5zaGlmdCgpLCBob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyhlbGVtLCB0eXBlKSwgbmV4dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGpRdWVyeS5kZXF1ZXVlKGVsZW0sIHR5cGUpOwogICAgICAgIH07CiAgICAgIC8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKICAgICAgaWYgKGZuID09PSAnaW5wcm9ncmVzcycpIHsKICAgICAgICBmbiA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgc3RhcnRMZW5ndGgtLTsKICAgICAgfQogICAgICBpZiAoZm4pIHsKICAgICAgICAvLyBBZGQgYSBwcm9ncmVzcyBzZW50aW5lbCB0byBwcmV2ZW50IHRoZSBmeCBxdWV1ZSBmcm9tIGJlaW5nCiAgICAgICAgLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAogICAgICAgIGlmICh0eXBlID09PSAnZngnKSB7CiAgICAgICAgICBxdWV1ZS51bnNoaWZ0KCdpbnByb2dyZXNzJyk7CiAgICAgICAgfQogICAgICAgIC8vIGNsZWFyIHVwIHRoZSBsYXN0IHF1ZXVlIHN0b3AgZnVuY3Rpb24KICAgICAgICBkZWxldGUgaG9va3Muc3RvcDsKICAgICAgICBmbi5jYWxsKGVsZW0sIG5leHQsIGhvb2tzKTsKICAgICAgfQogICAgICBpZiAoIXN0YXJ0TGVuZ3RoICYmIGhvb2tzKSB7CiAgICAgICAgaG9va3MuZW1wdHkuZmlyZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gbm90IGludGVuZGVkIGZvciBwdWJsaWMgY29uc3VtcHRpb24gLSBnZW5lcmF0ZXMgYSBxdWV1ZUhvb2tzIG9iamVjdCwgb3IgcmV0dXJucyB0aGUgY3VycmVudCBvbmUKICAgIF9xdWV1ZUhvb2tzOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSkgewogICAgICB2YXIga2V5ID0gdHlwZSArICdxdWV1ZUhvb2tzJzsKICAgICAgcmV0dXJuIGRhdGFfcHJpdi5nZXQoZWxlbSwga2V5KSB8fCBkYXRhX3ByaXYuYWNjZXNzKGVsZW0sIGtleSwgewogICAgICAgIGVtcHR5OiBqUXVlcnkuQ2FsbGJhY2tzKCdvbmNlIG1lbW9yeScpLmFkZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkYXRhX3ByaXYucmVtb3ZlKGVsZW0sIFsKICAgICAgICAgICAgdHlwZSArICdxdWV1ZScsCiAgICAgICAgICAgIGtleQogICAgICAgICAgXSk7CiAgICAgICAgfSkKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBxdWV1ZTogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgdmFyIHNldHRlciA9IDI7CiAgICAgIGlmICh0eXBlb2YgdHlwZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICBkYXRhID0gdHlwZTsKICAgICAgICB0eXBlID0gJ2Z4JzsKICAgICAgICBzZXR0ZXItLTsKICAgICAgfQogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlcikgewogICAgICAgIHJldHVybiBqUXVlcnkucXVldWUodGhpc1swXSwgdHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/IHRoaXMgOiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSh0aGlzLCB0eXBlLCBkYXRhKTsKICAgICAgICAvLyBlbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQogICAgICAgIGpRdWVyeS5fcXVldWVIb29rcyh0aGlzLCB0eXBlKTsKICAgICAgICBpZiAodHlwZSA9PT0gJ2Z4JyAmJiBxdWV1ZVswXSAhPT0gJ2lucHJvZ3Jlc3MnKSB7CiAgICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGRlcXVldWU6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeS5kZXF1ZXVlKHRoaXMsIHR5cGUpOwogICAgICB9KTsKICAgIH0sCiAgICBjbGVhclF1ZXVlOiBmdW5jdGlvbiAodHlwZSkgewogICAgICByZXR1cm4gdGhpcy5xdWV1ZSh0eXBlIHx8ICdmeCcsIFtdKTsKICAgIH0sCiAgICAvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlCiAgICAvLyBhcmUgZW1wdGllZCAoZnggaXMgdGhlIHR5cGUgYnkgZGVmYXVsdCkKICAgIHByb21pc2U6IGZ1bmN0aW9uICh0eXBlLCBvYmopIHsKICAgICAgdmFyIHRtcCwgY291bnQgPSAxLCBkZWZlciA9IGpRdWVyeS5EZWZlcnJlZCgpLCBlbGVtZW50cyA9IHRoaXMsIGkgPSB0aGlzLmxlbmd0aCwgcmVzb2x2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICghLS1jb3VudCkgewogICAgICAgICAgICBkZWZlci5yZXNvbHZlV2l0aChlbGVtZW50cywgW2VsZW1lbnRzXSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAnc3RyaW5nJykgewogICAgICAgIG9iaiA9IHR5cGU7CiAgICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICB0eXBlID0gdHlwZSB8fCAnZngnOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgdG1wID0gZGF0YV9wcml2LmdldChlbGVtZW50c1tpXSwgdHlwZSArICdxdWV1ZUhvb2tzJyk7CiAgICAgICAgaWYgKHRtcCAmJiB0bXAuZW1wdHkpIHsKICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICB0bXAuZW1wdHkuYWRkKHJlc29sdmUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXNvbHZlKCk7CiAgICAgIHJldHVybiBkZWZlci5wcm9taXNlKG9iaik7CiAgICB9CiAgfSk7CiAgdmFyIHBudW0gPSAvWystXT8oPzpcZCpcLnwpXGQrKD86W2VFXVsrLV0/XGQrfCkvLnNvdXJjZTsKICB2YXIgY3NzRXhwYW5kID0gWwogICAgJ1RvcCcsCiAgICAnUmlnaHQnLAogICAgJ0JvdHRvbScsCiAgICAnTGVmdCcKICBdOwogIHZhciBpc0hpZGRlbiA9IGZ1bmN0aW9uIChlbGVtLCBlbCkgewogICAgLy8gaXNIaWRkZW4gbWlnaHQgYmUgY2FsbGVkIGZyb20galF1ZXJ5I2ZpbHRlciBmdW5jdGlvbjsKICAgIC8vIGluIHRoYXQgY2FzZSwgZWxlbWVudCB3aWxsIGJlIHNlY29uZCBhcmd1bWVudAogICAgZWxlbSA9IGVsIHx8IGVsZW07CiAgICByZXR1cm4galF1ZXJ5LmNzcyhlbGVtLCAnZGlzcGxheScpID09PSAnbm9uZScgfHwgIWpRdWVyeS5jb250YWlucyhlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0pOwogIH07CiAgdmFyIHJjaGVja2FibGVUeXBlID0gL14oPzpjaGVja2JveHxyYWRpbykkL2k7CiAgKGZ1bmN0aW9uICgpIHsKICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwgZGl2ID0gZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykpLCBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7CiAgICAvLyAjMTEyMTcgLSBXZWJLaXQgbG9zZXMgY2hlY2sgd2hlbiB0aGUgbmFtZSBpcyBhZnRlciB0aGUgY2hlY2tlZCBhdHRyaWJ1dGUKICAgIC8vIFN1cHBvcnQ6IFdpbmRvd3MgV2ViIEFwcHMgKFdXQSkKICAgIC8vIGBuYW1lYCBhbmQgYHR5cGVgIG5lZWQgLnNldEF0dHJpYnV0ZSBmb3IgV1dBCiAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAncmFkaW8nKTsKICAgIGlucHV0LnNldEF0dHJpYnV0ZSgnY2hlY2tlZCcsICdjaGVja2VkJyk7CiAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoJ25hbWUnLCAndCcpOwogICAgZGl2LmFwcGVuZENoaWxkKGlucHV0KTsKICAgIC8vIFN1cHBvcnQ6IFNhZmFyaSA1LjEsIGlPUyA1LjEsIEFuZHJvaWQgNC54LCBBbmRyb2lkIDIuMwogICAgLy8gb2xkIFdlYktpdCBkb2Vzbid0IGNsb25lIGNoZWNrZWQgc3RhdGUgY29ycmVjdGx5IGluIGZyYWdtZW50cwogICAgc3VwcG9ydC5jaGVja0Nsb25lID0gZGl2LmNsb25lTm9kZSh0cnVlKS5jbG9uZU5vZGUodHJ1ZSkubGFzdENoaWxkLmNoZWNrZWQ7CiAgICAvLyBNYWtlIHN1cmUgdGV4dGFyZWEgKGFuZCBjaGVja2JveCkgZGVmYXVsdFZhbHVlIGlzIHByb3Blcmx5IGNsb25lZAogICAgLy8gU3VwcG9ydDogSUU5LUlFMTErCiAgICBkaXYuaW5uZXJIVE1MID0gJzx0ZXh0YXJlYT54PC90ZXh0YXJlYT4nOwogICAgc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCA9ICEhZGl2LmNsb25lTm9kZSh0cnVlKS5sYXN0Q2hpbGQuZGVmYXVsdFZhbHVlOwogIH0oKSk7CiAgdmFyIHN0cnVuZGVmaW5lZCA9IHR5cGVvZiB1bmRlZmluZWQ7CiAgc3VwcG9ydC5mb2N1c2luQnViYmxlcyA9ICdvbmZvY3VzaW4nIGluIHdpbmRvdzsKICB2YXIgcmtleUV2ZW50ID0gL15rZXkvLCBybW91c2VFdmVudCA9IC9eKD86bW91c2V8cG9pbnRlcnxjb250ZXh0bWVudSl8Y2xpY2svLCByZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywgcnR5cGVuYW1lc3BhY2UgPSAvXihbXi5dKikoPzpcLiguKyl8KSQvOwogIGZ1bmN0aW9uIHJldHVyblRydWUoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIHNhZmVBY3RpdmVFbGVtZW50KCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgIH0KICB9CiAgLyoKICAgKiBIZWxwZXIgZnVuY3Rpb25zIGZvciBtYW5hZ2luZyBldmVudHMgLS0gbm90IHBhcnQgb2YgdGhlIHB1YmxpYyBpbnRlcmZhY2UuCiAgICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICAgKi8KICBqUXVlcnkuZXZlbnQgPSB7CiAgICBnbG9iYWw6IHt9LAogICAgYWRkOiBmdW5jdGlvbiAoZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBoYW5kbGVPYmpJbiwgZXZlbnRIYW5kbGUsIHRtcCwgZXZlbnRzLCB0LCBoYW5kbGVPYmosIHNwZWNpYWwsIGhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwgZWxlbURhdGEgPSBkYXRhX3ByaXYuZ2V0KGVsZW0pOwogICAgICAvLyBEb24ndCBhdHRhY2ggZXZlbnRzIHRvIG5vRGF0YSBvciB0ZXh0L2NvbW1lbnQgbm9kZXMgKGJ1dCBhbGxvdyBwbGFpbiBvYmplY3RzKQogICAgICBpZiAoIWVsZW1EYXRhKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIENhbGxlciBjYW4gcGFzcyBpbiBhbiBvYmplY3Qgb2YgY3VzdG9tIGRhdGEgaW4gbGlldSBvZiB0aGUgaGFuZGxlcgogICAgICBpZiAoaGFuZGxlci5oYW5kbGVyKSB7CiAgICAgICAgaGFuZGxlT2JqSW4gPSBoYW5kbGVyOwogICAgICAgIGhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwogICAgICAgIHNlbGVjdG9yID0gaGFuZGxlT2JqSW4uc2VsZWN0b3I7CiAgICAgIH0KICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGhhbmRsZXIgaGFzIGEgdW5pcXVlIElELCB1c2VkIHRvIGZpbmQvcmVtb3ZlIGl0IGxhdGVyCiAgICAgIGlmICghaGFuZGxlci5ndWlkKSB7CiAgICAgICAgaGFuZGxlci5ndWlkID0galF1ZXJ5Lmd1aWQrKzsKICAgICAgfQogICAgICAvLyBJbml0IHRoZSBlbGVtZW50J3MgZXZlbnQgc3RydWN0dXJlIGFuZCBtYWluIGhhbmRsZXIsIGlmIHRoaXMgaXMgdGhlIGZpcnN0CiAgICAgIGlmICghKGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cykpIHsKICAgICAgICBldmVudHMgPSBlbGVtRGF0YS5ldmVudHMgPSB7fTsKICAgICAgfQogICAgICBpZiAoIShldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSkpIHsKICAgICAgICBldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAvLyBEaXNjYXJkIHRoZSBzZWNvbmQgZXZlbnQgb2YgYSBqUXVlcnkuZXZlbnQudHJpZ2dlcigpIGFuZAogICAgICAgICAgLy8gd2hlbiBhbiBldmVudCBpcyBjYWxsZWQgYWZ0ZXIgYSBwYWdlIGhhcyB1bmxvYWRlZAogICAgICAgICAgcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT09IHN0cnVuZGVmaW5lZCAmJiBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUgPyBqUXVlcnkuZXZlbnQuZGlzcGF0Y2guYXBwbHkoZWxlbSwgYXJndW1lbnRzKSA6IHVuZGVmaW5lZDsKICAgICAgICB9OwogICAgICB9CiAgICAgIC8vIEhhbmRsZSBtdWx0aXBsZSBldmVudHMgc2VwYXJhdGVkIGJ5IGEgc3BhY2UKICAgICAgdHlwZXMgPSAodHlwZXMgfHwgJycpLm1hdGNoKHJub3R3aGl0ZSkgfHwgWycnXTsKICAgICAgdCA9IHR5cGVzLmxlbmd0aDsKICAgICAgd2hpbGUgKHQtLSkgewogICAgICAgIHRtcCA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWModHlwZXNbdF0pIHx8IFtdOwogICAgICAgIHR5cGUgPSBvcmlnVHlwZSA9IHRtcFsxXTsKICAgICAgICBuYW1lc3BhY2VzID0gKHRtcFsyXSB8fCAnJykuc3BsaXQoJy4nKS5zb3J0KCk7CiAgICAgICAgLy8gVGhlcmUgKm11c3QqIGJlIGEgdHlwZSwgbm8gYXR0YWNoaW5nIG5hbWVzcGFjZS1vbmx5IGhhbmRsZXJzCiAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgLy8gSWYgZXZlbnQgY2hhbmdlcyBpdHMgdHlwZSwgdXNlIHRoZSBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgY2hhbmdlZCB0eXBlCiAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwogICAgICAgIC8vIElmIHNlbGVjdG9yIGRlZmluZWQsIGRldGVybWluZSBzcGVjaWFsIGV2ZW50IGFwaSB0eXBlLCBvdGhlcndpc2UgZ2l2ZW4gdHlwZQogICAgICAgIHR5cGUgPSAoc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUpIHx8IHR5cGU7CiAgICAgICAgLy8gVXBkYXRlIHNwZWNpYWwgYmFzZWQgb24gbmV3bHkgcmVzZXQgdHlwZQogICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKICAgICAgICAvLyBoYW5kbGVPYmogaXMgcGFzc2VkIHRvIGFsbCBldmVudCBoYW5kbGVycwogICAgICAgIGhhbmRsZU9iaiA9IGpRdWVyeS5leHRlbmQoewogICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgIG9yaWdUeXBlOiBvcmlnVHlwZSwKICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgICAgZ3VpZDogaGFuZGxlci5ndWlkLAogICAgICAgICAgc2VsZWN0b3I6IHNlbGVjdG9yLAogICAgICAgICAgbmVlZHNDb250ZXh0OiBzZWxlY3RvciAmJiBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQudGVzdChzZWxlY3RvciksCiAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZXMuam9pbignLicpCiAgICAgICAgfSwgaGFuZGxlT2JqSW4pOwogICAgICAgIC8vIEluaXQgdGhlIGV2ZW50IGhhbmRsZXIgcXVldWUgaWYgd2UncmUgdGhlIGZpcnN0CiAgICAgICAgaWYgKCEoaGFuZGxlcnMgPSBldmVudHNbdHlwZV0pKSB7CiAgICAgICAgICBoYW5kbGVycyA9IGV2ZW50c1t0eXBlXSA9IFtdOwogICAgICAgICAgaGFuZGxlcnMuZGVsZWdhdGVDb3VudCA9IDA7CiAgICAgICAgICAvLyBPbmx5IHVzZSBhZGRFdmVudExpc3RlbmVyIGlmIHRoZSBzcGVjaWFsIGV2ZW50cyBoYW5kbGVyIHJldHVybnMgZmFsc2UKICAgICAgICAgIGlmICghc3BlY2lhbC5zZXR1cCB8fCBzcGVjaWFsLnNldHVwLmNhbGwoZWxlbSwgZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUpID09PSBmYWxzZSkgewogICAgICAgICAgICBpZiAoZWxlbS5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHNwZWNpYWwuYWRkKSB7CiAgICAgICAgICBzcGVjaWFsLmFkZC5jYWxsKGVsZW0sIGhhbmRsZU9iaik7CiAgICAgICAgICBpZiAoIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQpIHsKICAgICAgICAgICAgaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCA9IGhhbmRsZXIuZ3VpZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gQWRkIHRvIHRoZSBlbGVtZW50J3MgaGFuZGxlciBsaXN0LCBkZWxlZ2F0ZXMgaW4gZnJvbnQKICAgICAgICBpZiAoc2VsZWN0b3IpIHsKICAgICAgICAgIGhhbmRsZXJzLnNwbGljZShoYW5kbGVycy5kZWxlZ2F0ZUNvdW50KyssIDAsIGhhbmRsZU9iaik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGhhbmRsZXJzLnB1c2goaGFuZGxlT2JqKTsKICAgICAgICB9CiAgICAgICAgLy8gS2VlcCB0cmFjayBvZiB3aGljaCBldmVudHMgaGF2ZSBldmVyIGJlZW4gdXNlZCwgZm9yIGV2ZW50IG9wdGltaXphdGlvbgogICAgICAgIGpRdWVyeS5ldmVudC5nbG9iYWxbdHlwZV0gPSB0cnVlOwogICAgICB9CiAgICB9LAogICAgLy8gRGV0YWNoIGFuIGV2ZW50IG9yIHNldCBvZiBldmVudHMgZnJvbSBhbiBlbGVtZW50CiAgICByZW1vdmU6IGZ1bmN0aW9uIChlbGVtLCB0eXBlcywgaGFuZGxlciwgc2VsZWN0b3IsIG1hcHBlZFR5cGVzKSB7CiAgICAgIHZhciBqLCBvcmlnQ291bnQsIHRtcCwgZXZlbnRzLCB0LCBoYW5kbGVPYmosIHNwZWNpYWwsIGhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwgZWxlbURhdGEgPSBkYXRhX3ByaXYuaGFzRGF0YShlbGVtKSAmJiBkYXRhX3ByaXYuZ2V0KGVsZW0pOwogICAgICBpZiAoIWVsZW1EYXRhIHx8ICEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBPbmNlIGZvciBlYWNoIHR5cGUubmFtZXNwYWNlIGluIHR5cGVzOyB0eXBlIG1heSBiZSBvbWl0dGVkCiAgICAgIHR5cGVzID0gKHR5cGVzIHx8ICcnKS5tYXRjaChybm90d2hpdGUpIHx8IFsnJ107CiAgICAgIHQgPSB0eXBlcy5sZW5ndGg7CiAgICAgIHdoaWxlICh0LS0pIHsKICAgICAgICB0bXAgPSBydHlwZW5hbWVzcGFjZS5leGVjKHR5cGVzW3RdKSB8fCBbXTsKICAgICAgICB0eXBlID0gb3JpZ1R5cGUgPSB0bXBbMV07CiAgICAgICAgbmFtZXNwYWNlcyA9ICh0bXBbMl0gfHwgJycpLnNwbGl0KCcuJykuc29ydCgpOwogICAgICAgIC8vIFVuYmluZCBhbGwgZXZlbnRzIChvbiB0aGlzIG5hbWVzcGFjZSwgaWYgcHJvdmlkZWQpIGZvciB0aGUgZWxlbWVudAogICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgZm9yICh0eXBlIGluIGV2ZW50cykgewogICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKGVsZW0sIHR5cGUgKyB0eXBlc1t0XSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKICAgICAgICB0eXBlID0gKHNlbGVjdG9yID8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlKSB8fCB0eXBlOwogICAgICAgIGhhbmRsZXJzID0gZXZlbnRzW3R5cGVdIHx8IFtdOwogICAgICAgIHRtcCA9IHRtcFsyXSAmJiBuZXcgUmVnRXhwKCcoXnxcXC4pJyArIG5hbWVzcGFjZXMuam9pbignXFwuKD86LipcXC58KScpICsgJyhcXC58JCknKTsKICAgICAgICAvLyBSZW1vdmUgbWF0Y2hpbmcgZXZlbnRzCiAgICAgICAgb3JpZ0NvdW50ID0gaiA9IGhhbmRsZXJzLmxlbmd0aDsKICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICBoYW5kbGVPYmogPSBoYW5kbGVyc1tqXTsKICAgICAgICAgIGlmICgobWFwcGVkVHlwZXMgfHwgb3JpZ1R5cGUgPT09IGhhbmRsZU9iai5vcmlnVHlwZSkgJiYgKCFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQpICYmICghdG1wIHx8IHRtcC50ZXN0KGhhbmRsZU9iai5uYW1lc3BhY2UpKSAmJiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09ICcqKicgJiYgaGFuZGxlT2JqLnNlbGVjdG9yKSkgewogICAgICAgICAgICBoYW5kbGVycy5zcGxpY2UoaiwgMSk7CiAgICAgICAgICAgIGlmIChoYW5kbGVPYmouc2VsZWN0b3IpIHsKICAgICAgICAgICAgICBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNwZWNpYWwucmVtb3ZlKSB7CiAgICAgICAgICAgICAgc3BlY2lhbC5yZW1vdmUuY2FsbChlbGVtLCBoYW5kbGVPYmopOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgd2UgcmVtb3ZlZCBzb21ldGhpbmcgYW5kIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKICAgICAgICAvLyAoYXZvaWRzIHBvdGVudGlhbCBmb3IgZW5kbGVzcyByZWN1cnNpb24gZHVyaW5nIHJlbW92YWwgb2Ygc3BlY2lhbCBldmVudCBoYW5kbGVycykKICAgICAgICBpZiAob3JpZ0NvdW50ICYmICFoYW5kbGVycy5sZW5ndGgpIHsKICAgICAgICAgIGlmICghc3BlY2lhbC50ZWFyZG93biB8fCBzcGVjaWFsLnRlYXJkb3duLmNhbGwoZWxlbSwgbmFtZXNwYWNlcywgZWxlbURhdGEuaGFuZGxlKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZUV2ZW50KGVsZW0sIHR5cGUsIGVsZW1EYXRhLmhhbmRsZSk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAogICAgICBpZiAoalF1ZXJ5LmlzRW1wdHlPYmplY3QoZXZlbnRzKSkgewogICAgICAgIGRlbGV0ZSBlbGVtRGF0YS5oYW5kbGU7CiAgICAgICAgZGF0YV9wcml2LnJlbW92ZShlbGVtLCAnZXZlbnRzJyk7CiAgICAgIH0KICAgIH0sCiAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoZXZlbnQsIGRhdGEsIGVsZW0sIG9ubHlIYW5kbGVycykgewogICAgICB2YXIgaSwgY3VyLCB0bXAsIGJ1YmJsZVR5cGUsIG9udHlwZSwgaGFuZGxlLCBzcGVjaWFsLCBldmVudFBhdGggPSBbZWxlbSB8fCBkb2N1bWVudF0sIHR5cGUgPSBoYXNPd24uY2FsbChldmVudCwgJ3R5cGUnKSA/IGV2ZW50LnR5cGUgOiBldmVudCwgbmFtZXNwYWNlcyA9IGhhc093bi5jYWxsKGV2ZW50LCAnbmFtZXNwYWNlJykgPyBldmVudC5uYW1lc3BhY2Uuc3BsaXQoJy4nKSA6IFtdOwogICAgICBjdXIgPSB0bXAgPSBlbGVtID0gZWxlbSB8fCBkb2N1bWVudDsKICAgICAgLy8gRG9uJ3QgZG8gZXZlbnRzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBmb2N1cy9ibHVyIG1vcnBocyB0byBmb2N1c2luL291dDsgZW5zdXJlIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbSByaWdodCBub3cKICAgICAgaWYgKHJmb2N1c01vcnBoLnRlc3QodHlwZSArIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0eXBlLmluZGV4T2YoJy4nKSA+PSAwKSB7CiAgICAgICAgLy8gTmFtZXNwYWNlZCB0cmlnZ2VyOyBjcmVhdGUgYSByZWdleHAgdG8gbWF0Y2ggZXZlbnQgdHlwZSBpbiBoYW5kbGUoKQogICAgICAgIG5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCcuJyk7CiAgICAgICAgdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsKICAgICAgICBuYW1lc3BhY2VzLnNvcnQoKTsKICAgICAgfQogICAgICBvbnR5cGUgPSB0eXBlLmluZGV4T2YoJzonKSA8IDAgJiYgJ29uJyArIHR5cGU7CiAgICAgIC8vIENhbGxlciBjYW4gcGFzcyBpbiBhIGpRdWVyeS5FdmVudCBvYmplY3QsIE9iamVjdCwgb3IganVzdCBhbiBldmVudCB0eXBlIHN0cmluZwogICAgICBldmVudCA9IGV2ZW50W2pRdWVyeS5leHBhbmRvXSA/IGV2ZW50IDogbmV3IGpRdWVyeS5FdmVudCh0eXBlLCB0eXBlb2YgZXZlbnQgPT09ICdvYmplY3QnICYmIGV2ZW50KTsKICAgICAgLy8gVHJpZ2dlciBiaXRtYXNrOiAmIDEgZm9yIG5hdGl2ZSBoYW5kbGVyczsgJiAyIGZvciBqUXVlcnkgKGFsd2F5cyB0cnVlKQogICAgICBldmVudC5pc1RyaWdnZXIgPSBvbmx5SGFuZGxlcnMgPyAyIDogMzsKICAgICAgZXZlbnQubmFtZXNwYWNlID0gbmFtZXNwYWNlcy5qb2luKCcuJyk7CiAgICAgIGV2ZW50Lm5hbWVzcGFjZV9yZSA9IGV2ZW50Lm5hbWVzcGFjZSA/IG5ldyBSZWdFeHAoJyhefFxcLiknICsgbmFtZXNwYWNlcy5qb2luKCdcXC4oPzouKlxcLnwpJykgKyAnKFxcLnwkKScpIDogbnVsbDsKICAgICAgLy8gQ2xlYW4gdXAgdGhlIGV2ZW50IGluIGNhc2UgaXQgaXMgYmVpbmcgcmV1c2VkCiAgICAgIGV2ZW50LnJlc3VsdCA9IHVuZGVmaW5lZDsKICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICBldmVudC50YXJnZXQgPSBlbGVtOwogICAgICB9CiAgICAgIC8vIENsb25lIGFueSBpbmNvbWluZyBkYXRhIGFuZCBwcmVwZW5kIHRoZSBldmVudCwgY3JlYXRpbmcgdGhlIGhhbmRsZXIgYXJnIGxpc3QKICAgICAgZGF0YSA9IGRhdGEgPT0gbnVsbCA/IFtldmVudF0gOiBqUXVlcnkubWFrZUFycmF5KGRhdGEsIFtldmVudF0pOwogICAgICAvLyBBbGxvdyBzcGVjaWFsIGV2ZW50cyB0byBkcmF3IG91dHNpZGUgdGhlIGxpbmVzCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKICAgICAgaWYgKCFvbmx5SGFuZGxlcnMgJiYgc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseShlbGVtLCBkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gRGV0ZXJtaW5lIGV2ZW50IHByb3BhZ2F0aW9uIHBhdGggaW4gYWR2YW5jZSwgcGVyIFczQyBldmVudHMgc3BlYyAoIzk5NTEpCiAgICAgIC8vIEJ1YmJsZSB1cCB0byBkb2N1bWVudCwgdGhlbiB0byB3aW5kb3c7IHdhdGNoIGZvciBhIGdsb2JhbCBvd25lckRvY3VtZW50IHZhciAoIzk3MjQpCiAgICAgIGlmICghb25seUhhbmRsZXJzICYmICFzcGVjaWFsLm5vQnViYmxlICYmICFqUXVlcnkuaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICBidWJibGVUeXBlID0gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgfHwgdHlwZTsKICAgICAgICBpZiAoIXJmb2N1c01vcnBoLnRlc3QoYnViYmxlVHlwZSArIHR5cGUpKSB7CiAgICAgICAgICBjdXIgPSBjdXIucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgZm9yICg7IGN1cjsgY3VyID0gY3VyLnBhcmVudE5vZGUpIHsKICAgICAgICAgIGV2ZW50UGF0aC5wdXNoKGN1cik7CiAgICAgICAgICB0bXAgPSBjdXI7CiAgICAgICAgfQogICAgICAgIC8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQogICAgICAgIGlmICh0bXAgPT09IChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpKSB7CiAgICAgICAgICBldmVudFBhdGgucHVzaCh0bXAuZGVmYXVsdFZpZXcgfHwgdG1wLnBhcmVudFdpbmRvdyB8fCB3aW5kb3cpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBGaXJlIGhhbmRsZXJzIG9uIHRoZSBldmVudCBwYXRoCiAgICAgIGkgPSAwOwogICAgICB3aGlsZSAoKGN1ciA9IGV2ZW50UGF0aFtpKytdKSAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgIGV2ZW50LnR5cGUgPSBpID4gMSA/IGJ1YmJsZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlIHx8IHR5cGU7CiAgICAgICAgLy8galF1ZXJ5IGhhbmRsZXIKICAgICAgICBoYW5kbGUgPSAoZGF0YV9wcml2LmdldChjdXIsICdldmVudHMnKSB8fCB7fSlbZXZlbnQudHlwZV0gJiYgZGF0YV9wcml2LmdldChjdXIsICdoYW5kbGUnKTsKICAgICAgICBpZiAoaGFuZGxlKSB7CiAgICAgICAgICBoYW5kbGUuYXBwbHkoY3VyLCBkYXRhKTsKICAgICAgICB9CiAgICAgICAgLy8gTmF0aXZlIGhhbmRsZXIKICAgICAgICBoYW5kbGUgPSBvbnR5cGUgJiYgY3VyW29udHlwZV07CiAgICAgICAgaWYgKGhhbmRsZSAmJiBoYW5kbGUuYXBwbHkgJiYgalF1ZXJ5LmFjY2VwdERhdGEoY3VyKSkgewogICAgICAgICAgZXZlbnQucmVzdWx0ID0gaGFuZGxlLmFwcGx5KGN1ciwgZGF0YSk7CiAgICAgICAgICBpZiAoZXZlbnQucmVzdWx0ID09PSBmYWxzZSkgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBldmVudC50eXBlID0gdHlwZTsKICAgICAgLy8gSWYgbm9ib2R5IHByZXZlbnRlZCB0aGUgZGVmYXVsdCBhY3Rpb24sIGRvIGl0IG5vdwogICAgICBpZiAoIW9ubHlIYW5kbGVycyAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICBpZiAoKCFzcGVjaWFsLl9kZWZhdWx0IHx8IHNwZWNpYWwuX2RlZmF1bHQuYXBwbHkoZXZlbnRQYXRoLnBvcCgpLCBkYXRhKSA9PT0gZmFsc2UpICYmIGpRdWVyeS5hY2NlcHREYXRhKGVsZW0pKSB7CiAgICAgICAgICAvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgbmFtZSBhcyB0aGUgZXZlbnQuCiAgICAgICAgICAvLyBEb24ndCBkbyBkZWZhdWx0IGFjdGlvbnMgb24gd2luZG93LCB0aGF0J3Mgd2hlcmUgZ2xvYmFsIHZhcmlhYmxlcyBiZSAoIzYxNzApCiAgICAgICAgICBpZiAob250eXBlICYmIGpRdWVyeS5pc0Z1bmN0aW9uKGVsZW1bdHlwZV0pICYmICFqUXVlcnkuaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICAgICAgLy8gRG9uJ3QgcmUtdHJpZ2dlciBhbiBvbkZPTyBldmVudCB3aGVuIHdlIGNhbGwgaXRzIEZPTygpIG1ldGhvZAogICAgICAgICAgICB0bXAgPSBlbGVtW29udHlwZV07CiAgICAgICAgICAgIGlmICh0bXApIHsKICAgICAgICAgICAgICBlbGVtW29udHlwZV0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlCiAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwogICAgICAgICAgICBlbGVtW3R5cGVdKCk7CiAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGlmICh0bXApIHsKICAgICAgICAgICAgICBlbGVtW29udHlwZV0gPSB0bXA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50LnJlc3VsdDsKICAgIH0sCiAgICBkaXNwYXRjaDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIC8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdAogICAgICBldmVudCA9IGpRdWVyeS5ldmVudC5maXgoZXZlbnQpOwogICAgICB2YXIgaSwgaiwgcmV0LCBtYXRjaGVkLCBoYW5kbGVPYmosIGhhbmRsZXJRdWV1ZSA9IFtdLCBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpLCBoYW5kbGVycyA9IChkYXRhX3ByaXYuZ2V0KHRoaXMsICdldmVudHMnKSB8fCB7fSlbZXZlbnQudHlwZV0gfHwgW10sIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFtldmVudC50eXBlXSB8fCB7fTsKICAgICAgLy8gVXNlIHRoZSBmaXgtZWQgalF1ZXJ5LkV2ZW50IHJhdGhlciB0aGFuIHRoZSAocmVhZC1vbmx5KSBuYXRpdmUgZXZlbnQKICAgICAgYXJnc1swXSA9IGV2ZW50OwogICAgICBldmVudC5kZWxlZ2F0ZVRhcmdldCA9IHRoaXM7CiAgICAgIC8vIENhbGwgdGhlIHByZURpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZSwgYW5kIGxldCBpdCBiYWlsIGlmIGRlc2lyZWQKICAgICAgaWYgKHNwZWNpYWwucHJlRGlzcGF0Y2ggJiYgc3BlY2lhbC5wcmVEaXNwYXRjaC5jYWxsKHRoaXMsIGV2ZW50KSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gRGV0ZXJtaW5lIGhhbmRsZXJzCiAgICAgIGhhbmRsZXJRdWV1ZSA9IGpRdWVyeS5ldmVudC5oYW5kbGVycy5jYWxsKHRoaXMsIGV2ZW50LCBoYW5kbGVycyk7CiAgICAgIC8vIFJ1biBkZWxlZ2F0ZXMgZmlyc3Q7IHRoZXkgbWF5IHdhbnQgdG8gc3RvcCBwcm9wYWdhdGlvbiBiZW5lYXRoIHVzCiAgICAgIGkgPSAwOwogICAgICB3aGlsZSAoKG1hdGNoZWQgPSBoYW5kbGVyUXVldWVbaSsrXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gbWF0Y2hlZC5lbGVtOwogICAgICAgIGogPSAwOwogICAgICAgIHdoaWxlICgoaGFuZGxlT2JqID0gbWF0Y2hlZC5oYW5kbGVyc1tqKytdKSAmJiAhZXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgLy8gVHJpZ2dlcmVkIGV2ZW50IG11c3QgZWl0aGVyIDEpIGhhdmUgbm8gbmFtZXNwYWNlLCBvcgogICAgICAgICAgLy8gMikgaGF2ZSBuYW1lc3BhY2UocykgYSBzdWJzZXQgb3IgZXF1YWwgdG8gdGhvc2UgaW4gdGhlIGJvdW5kIGV2ZW50IChib3RoIGNhbiBoYXZlIG5vIG5hbWVzcGFjZSkuCiAgICAgICAgICBpZiAoIWV2ZW50Lm5hbWVzcGFjZV9yZSB8fCBldmVudC5uYW1lc3BhY2VfcmUudGVzdChoYW5kbGVPYmoubmFtZXNwYWNlKSkgewogICAgICAgICAgICBldmVudC5oYW5kbGVPYmogPSBoYW5kbGVPYmo7CiAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBoYW5kbGVPYmouZGF0YTsKICAgICAgICAgICAgcmV0ID0gKChqUXVlcnkuZXZlbnQuc3BlY2lhbFtoYW5kbGVPYmoub3JpZ1R5cGVdIHx8IHt9KS5oYW5kbGUgfHwgaGFuZGxlT2JqLmhhbmRsZXIpLmFwcGx5KG1hdGNoZWQuZWxlbSwgYXJncyk7CiAgICAgICAgICAgIGlmIChyZXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGlmICgoZXZlbnQucmVzdWx0ID0gcmV0KSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQogICAgICBpZiAoc3BlY2lhbC5wb3N0RGlzcGF0Y2gpIHsKICAgICAgICBzcGVjaWFsLnBvc3REaXNwYXRjaC5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgfQogICAgICByZXR1cm4gZXZlbnQucmVzdWx0OwogICAgfSwKICAgIGhhbmRsZXJzOiBmdW5jdGlvbiAoZXZlbnQsIGhhbmRsZXJzKSB7CiAgICAgIHZhciBpLCBtYXRjaGVzLCBzZWwsIGhhbmRsZU9iaiwgaGFuZGxlclF1ZXVlID0gW10sIGRlbGVnYXRlQ291bnQgPSBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LCBjdXIgPSBldmVudC50YXJnZXQ7CiAgICAgIC8vIEZpbmQgZGVsZWdhdGUgaGFuZGxlcnMKICAgICAgLy8gQmxhY2staG9sZSBTVkcgPHVzZT4gaW5zdGFuY2UgdHJlZXMgKCMxMzE4MCkKICAgICAgLy8gQXZvaWQgbm9uLWxlZnQtY2xpY2sgYnViYmxpbmcgaW4gRmlyZWZveCAoIzM4NjEpCiAgICAgIGlmIChkZWxlZ2F0ZUNvdW50ICYmIGN1ci5ub2RlVHlwZSAmJiAoIWV2ZW50LmJ1dHRvbiB8fCBldmVudC50eXBlICE9PSAnY2xpY2snKSkgewogICAgICAgIGZvciAoOyBjdXIgIT09IHRoaXM7IGN1ciA9IGN1ci5wYXJlbnROb2RlIHx8IHRoaXMpIHsKICAgICAgICAgIC8vIERvbid0IHByb2Nlc3MgY2xpY2tzIG9uIGRpc2FibGVkIGVsZW1lbnRzICgjNjkxMSwgIzgxNjUsICMxMTM4MiwgIzExNzY0KQogICAgICAgICAgaWYgKGN1ci5kaXNhYmxlZCAhPT0gdHJ1ZSB8fCBldmVudC50eXBlICE9PSAnY2xpY2snKSB7CiAgICAgICAgICAgIG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGRlbGVnYXRlQ291bnQ7IGkrKykgewogICAgICAgICAgICAgIGhhbmRsZU9iaiA9IGhhbmRsZXJzW2ldOwogICAgICAgICAgICAgIC8vIERvbid0IGNvbmZsaWN0IHdpdGggT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzICgjMTMyMDMpCiAgICAgICAgICAgICAgc2VsID0gaGFuZGxlT2JqLnNlbGVjdG9yICsgJyAnOwogICAgICAgICAgICAgIGlmIChtYXRjaGVzW3NlbF0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgbWF0Y2hlc1tzZWxdID0gaGFuZGxlT2JqLm5lZWRzQ29udGV4dCA/IGpRdWVyeShzZWwsIHRoaXMpLmluZGV4KGN1cikgPj0gMCA6IGpRdWVyeS5maW5kKHNlbCwgdGhpcywgbnVsbCwgW2N1cl0pLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG1hdGNoZXNbc2VsXSkgewogICAgICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKGhhbmRsZU9iaik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtYXRjaGVzLmxlbmd0aCkgewogICAgICAgICAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGVsZW06IGN1ciwKICAgICAgICAgICAgICAgIGhhbmRsZXJzOiBtYXRjaGVzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQWRkIHRoZSByZW1haW5pbmcgKGRpcmVjdGx5LWJvdW5kKSBoYW5kbGVycwogICAgICBpZiAoZGVsZWdhdGVDb3VudCA8IGhhbmRsZXJzLmxlbmd0aCkgewogICAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsKICAgICAgICAgIGVsZW06IHRoaXMsCiAgICAgICAgICBoYW5kbGVyczogaGFuZGxlcnMuc2xpY2UoZGVsZWdhdGVDb3VudCkKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gaGFuZGxlclF1ZXVlOwogICAgfSwKICAgIC8vIEluY2x1ZGVzIHNvbWUgZXZlbnQgcHJvcHMgc2hhcmVkIGJ5IEtleUV2ZW50IGFuZCBNb3VzZUV2ZW50CiAgICBwcm9wczogJ2FsdEtleSBidWJibGVzIGNhbmNlbGFibGUgY3RybEtleSBjdXJyZW50VGFyZ2V0IGV2ZW50UGhhc2UgbWV0YUtleSByZWxhdGVkVGFyZ2V0IHNoaWZ0S2V5IHRhcmdldCB0aW1lU3RhbXAgdmlldyB3aGljaCcuc3BsaXQoJyAnKSwKICAgIGZpeEhvb2tzOiB7fSwKICAgIGtleUhvb2tzOiB7CiAgICAgIHByb3BzOiAnY2hhciBjaGFyQ29kZSBrZXkga2V5Q29kZScuc3BsaXQoJyAnKSwKICAgICAgZmlsdGVyOiBmdW5jdGlvbiAoZXZlbnQsIG9yaWdpbmFsKSB7CiAgICAgICAgLy8gQWRkIHdoaWNoIGZvciBrZXkgZXZlbnRzCiAgICAgICAgaWYgKGV2ZW50LndoaWNoID09IG51bGwpIHsKICAgICAgICAgIGV2ZW50LndoaWNoID0gb3JpZ2luYWwuY2hhckNvZGUgIT0gbnVsbCA/IG9yaWdpbmFsLmNoYXJDb2RlIDogb3JpZ2luYWwua2V5Q29kZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICB9CiAgICB9LAogICAgbW91c2VIb29rczogewogICAgICBwcm9wczogJ2J1dHRvbiBidXR0b25zIGNsaWVudFggY2xpZW50WSBvZmZzZXRYIG9mZnNldFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIHRvRWxlbWVudCcuc3BsaXQoJyAnKSwKICAgICAgZmlsdGVyOiBmdW5jdGlvbiAoZXZlbnQsIG9yaWdpbmFsKSB7CiAgICAgICAgdmFyIGV2ZW50RG9jLCBkb2MsIGJvZHksIGJ1dHRvbiA9IG9yaWdpbmFsLmJ1dHRvbjsKICAgICAgICAvLyBDYWxjdWxhdGUgcGFnZVgvWSBpZiBtaXNzaW5nIGFuZCBjbGllbnRYL1kgYXZhaWxhYmxlCiAgICAgICAgaWYgKGV2ZW50LnBhZ2VYID09IG51bGwgJiYgb3JpZ2luYWwuY2xpZW50WCAhPSBudWxsKSB7CiAgICAgICAgICBldmVudERvYyA9IGV2ZW50LnRhcmdldC5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50OwogICAgICAgICAgZG9jID0gZXZlbnREb2MuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgYm9keSA9IGV2ZW50RG9jLmJvZHk7CiAgICAgICAgICBldmVudC5wYWdlWCA9IG9yaWdpbmFsLmNsaWVudFggKyAoZG9jICYmIGRvYy5zY3JvbGxMZWZ0IHx8IGJvZHkgJiYgYm9keS5zY3JvbGxMZWZ0IHx8IDApIC0gKGRvYyAmJiBkb2MuY2xpZW50TGVmdCB8fCBib2R5ICYmIGJvZHkuY2xpZW50TGVmdCB8fCAwKTsKICAgICAgICAgIGV2ZW50LnBhZ2VZID0gb3JpZ2luYWwuY2xpZW50WSArIChkb2MgJiYgZG9jLnNjcm9sbFRvcCB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsVG9wIHx8IDApIC0gKGRvYyAmJiBkb2MuY2xpZW50VG9wIHx8IGJvZHkgJiYgYm9keS5jbGllbnRUb3AgfHwgMCk7CiAgICAgICAgfQogICAgICAgIC8vIEFkZCB3aGljaCBmb3IgY2xpY2s6IDEgPT09IGxlZnQ7IDIgPT09IG1pZGRsZTsgMyA9PT0gcmlnaHQKICAgICAgICAvLyBOb3RlOiBidXR0b24gaXMgbm90IG5vcm1hbGl6ZWQsIHNvIGRvbid0IHVzZSBpdAogICAgICAgIGlmICghZXZlbnQud2hpY2ggJiYgYnV0dG9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGV2ZW50LndoaWNoID0gYnV0dG9uICYgMSA/IDEgOiBidXR0b24gJiAyID8gMyA6IGJ1dHRvbiAmIDQgPyAyIDogMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICB9CiAgICB9LAogICAgZml4OiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgaWYgKGV2ZW50W2pRdWVyeS5leHBhbmRvXSkgewogICAgICAgIHJldHVybiBldmVudDsKICAgICAgfQogICAgICAvLyBDcmVhdGUgYSB3cml0YWJsZSBjb3B5IG9mIHRoZSBldmVudCBvYmplY3QgYW5kIG5vcm1hbGl6ZSBzb21lIHByb3BlcnRpZXMKICAgICAgdmFyIGksIHByb3AsIGNvcHksIHR5cGUgPSBldmVudC50eXBlLCBvcmlnaW5hbEV2ZW50ID0gZXZlbnQsIGZpeEhvb2sgPSB0aGlzLmZpeEhvb2tzW3R5cGVdOwogICAgICBpZiAoIWZpeEhvb2spIHsKICAgICAgICB0aGlzLmZpeEhvb2tzW3R5cGVdID0gZml4SG9vayA9IHJtb3VzZUV2ZW50LnRlc3QodHlwZSkgPyB0aGlzLm1vdXNlSG9va3MgOiBya2V5RXZlbnQudGVzdCh0eXBlKSA/IHRoaXMua2V5SG9va3MgOiB7fTsKICAgICAgfQogICAgICBjb3B5ID0gZml4SG9vay5wcm9wcyA/IHRoaXMucHJvcHMuY29uY2F0KGZpeEhvb2sucHJvcHMpIDogdGhpcy5wcm9wczsKICAgICAgZXZlbnQgPSBuZXcgalF1ZXJ5LkV2ZW50KG9yaWdpbmFsRXZlbnQpOwogICAgICBpID0gY29weS5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICBwcm9wID0gY29weVtpXTsKICAgICAgICBldmVudFtwcm9wXSA9IG9yaWdpbmFsRXZlbnRbcHJvcF07CiAgICAgIH0KICAgICAgLy8gU3VwcG9ydDogQ29yZG92YSAyLjUgKFdlYktpdCkgKCMxMzI1NSkKICAgICAgLy8gQWxsIGV2ZW50cyBzaG91bGQgaGF2ZSBhIHRhcmdldDsgQ29yZG92YSBkZXZpY2VyZWFkeSBkb2Vzbid0CiAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgZXZlbnQudGFyZ2V0ID0gZG9jdW1lbnQ7CiAgICAgIH0KICAgICAgLy8gU3VwcG9ydDogU2FmYXJpIDYuMCssIENocm9tZSA8IDI4CiAgICAgIC8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCAjMTMxNDMpCiAgICAgIGlmIChldmVudC50YXJnZXQubm9kZVR5cGUgPT09IDMpIHsKICAgICAgICBldmVudC50YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTsKICAgICAgfQogICAgICByZXR1cm4gZml4SG9vay5maWx0ZXIgPyBmaXhIb29rLmZpbHRlcihldmVudCwgb3JpZ2luYWxFdmVudCkgOiBldmVudDsKICAgIH0sCiAgICBzcGVjaWFsOiB7CiAgICAgIGxvYWQ6IHsKICAgICAgICAvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkCiAgICAgICAgbm9CdWJibGU6IHRydWUKICAgICAgfSwKICAgICAgZm9jdXM6IHsKICAgICAgICAvLyBGaXJlIG5hdGl2ZSBldmVudCBpZiBwb3NzaWJsZSBzbyBibHVyL2ZvY3VzIHNlcXVlbmNlIGlzIGNvcnJlY3QKICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcyAhPT0gc2FmZUFjdGl2ZUVsZW1lbnQoKSAmJiB0aGlzLmZvY3VzKSB7CiAgICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZGVsZWdhdGVUeXBlOiAnZm9jdXNpbicKICAgICAgfSwKICAgICAgYmx1cjogewogICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzID09PSBzYWZlQWN0aXZlRWxlbWVudCgpICYmIHRoaXMuYmx1cikgewogICAgICAgICAgICB0aGlzLmJsdXIoKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZGVsZWdhdGVUeXBlOiAnZm9jdXNvdXQnCiAgICAgIH0sCiAgICAgIGNsaWNrOiB7CiAgICAgICAgLy8gRm9yIGNoZWNrYm94LCBmaXJlIG5hdGl2ZSBldmVudCBzbyBjaGVja2VkIHN0YXRlIHdpbGwgYmUgcmlnaHQKICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy50eXBlID09PSAnY2hlY2tib3gnICYmIHRoaXMuY2xpY2sgJiYgalF1ZXJ5Lm5vZGVOYW1lKHRoaXMsICdpbnB1dCcpKSB7CiAgICAgICAgICAgIHRoaXMuY2xpY2soKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLy8gRm9yIGNyb3NzLWJyb3dzZXIgY29uc2lzdGVuY3ksIGRvbid0IGZpcmUgbmF0aXZlIC5jbGljaygpIG9uIGxpbmtzCiAgICAgICAgX2RlZmF1bHQ6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgcmV0dXJuIGpRdWVyeS5ub2RlTmFtZShldmVudC50YXJnZXQsICdhJyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBiZWZvcmV1bmxvYWQ6IHsKICAgICAgICBwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgLy8gU3VwcG9ydDogRmlyZWZveCAyMCsKICAgICAgICAgIC8vIEZpcmVmb3ggZG9lc24ndCBhbGVydCBpZiB0aGUgcmV0dXJuVmFsdWUgZmllbGQgaXMgbm90IHNldC4KICAgICAgICAgIGlmIChldmVudC5yZXN1bHQgIT09IHVuZGVmaW5lZCAmJiBldmVudC5vcmlnaW5hbEV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50Lm9yaWdpbmFsRXZlbnQucmV0dXJuVmFsdWUgPSBldmVudC5yZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgc2ltdWxhdGU6IGZ1bmN0aW9uICh0eXBlLCBlbGVtLCBldmVudCwgYnViYmxlKSB7CiAgICAgIC8vIFBpZ2d5YmFjayBvbiBhIGRvbm9yIGV2ZW50IHRvIHNpbXVsYXRlIGEgZGlmZmVyZW50IG9uZS4KICAgICAgLy8gRmFrZSBvcmlnaW5hbEV2ZW50IHRvIGF2b2lkIGRvbm9yJ3Mgc3RvcFByb3BhZ2F0aW9uLCBidXQgaWYgdGhlCiAgICAgIC8vIHNpbXVsYXRlZCBldmVudCBwcmV2ZW50cyBkZWZhdWx0IHRoZW4gd2UgZG8gdGhlIHNhbWUgb24gdGhlIGRvbm9yLgogICAgICB2YXIgZSA9IGpRdWVyeS5leHRlbmQobmV3IGpRdWVyeS5FdmVudCgpLCBldmVudCwgewogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgaXNTaW11bGF0ZWQ6IHRydWUsCiAgICAgICAgb3JpZ2luYWxFdmVudDoge30KICAgICAgfSk7CiAgICAgIGlmIChidWJibGUpIHsKICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcihlLCBudWxsLCBlbGVtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBqUXVlcnkuZXZlbnQuZGlzcGF0Y2guY2FsbChlbGVtLCBlKTsKICAgICAgfQogICAgICBpZiAoZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgewogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0KICB9OwogIGpRdWVyeS5yZW1vdmVFdmVudCA9IGZ1bmN0aW9uIChlbGVtLCB0eXBlLCBoYW5kbGUpIHsKICAgIGlmIChlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHsKICAgICAgZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZSwgZmFsc2UpOwogICAgfQogIH07CiAgalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24gKHNyYywgcHJvcHMpIHsKICAgIC8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGpRdWVyeS5FdmVudCkpIHsKICAgICAgcmV0dXJuIG5ldyBqUXVlcnkuRXZlbnQoc3JjLCBwcm9wcyk7CiAgICB9CiAgICAvLyBFdmVudCBvYmplY3QKICAgIGlmIChzcmMgJiYgc3JjLnR5cGUpIHsKICAgICAgdGhpcy5vcmlnaW5hbEV2ZW50ID0gc3JjOwogICAgICB0aGlzLnR5cGUgPSBzcmMudHlwZTsKICAgICAgLy8gRXZlbnRzIGJ1YmJsaW5nIHVwIHRoZSBkb2N1bWVudCBtYXkgaGF2ZSBiZWVuIG1hcmtlZCBhcyBwcmV2ZW50ZWQKICAgICAgLy8gYnkgYSBoYW5kbGVyIGxvd2VyIGRvd24gdGhlIHRyZWU7IHJlZmxlY3QgdGhlIGNvcnJlY3QgdmFsdWUuCiAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gc3JjLmRlZmF1bHRQcmV2ZW50ZWQgfHwgc3JjLmRlZmF1bHRQcmV2ZW50ZWQgPT09IHVuZGVmaW5lZCAmJiAvLyBTdXBwb3J0OiBBbmRyb2lkIDwgNC4wCiAgICAgIHNyYy5yZXR1cm5WYWx1ZSA9PT0gZmFsc2UgPyByZXR1cm5UcnVlIDogcmV0dXJuRmFsc2U7ICAvLyBFdmVudCB0eXBlCiAgICB9IGVsc2UgewogICAgICB0aGlzLnR5cGUgPSBzcmM7CiAgICB9CiAgICAvLyBQdXQgZXhwbGljaXRseSBwcm92aWRlZCBwcm9wZXJ0aWVzIG9udG8gdGhlIGV2ZW50IG9iamVjdAogICAgaWYgKHByb3BzKSB7CiAgICAgIGpRdWVyeS5leHRlbmQodGhpcywgcHJvcHMpOwogICAgfQogICAgLy8gQ3JlYXRlIGEgdGltZXN0YW1wIGlmIGluY29taW5nIGV2ZW50IGRvZXNuJ3QgaGF2ZSBvbmUKICAgIHRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgalF1ZXJ5Lm5vdygpOwogICAgLy8gTWFyayBpdCBhcyBmaXhlZAogICAgdGhpc1tqUXVlcnkuZXhwYW5kb10gPSB0cnVlOwogIH07CiAgLy8galF1ZXJ5LkV2ZW50IGlzIGJhc2VkIG9uIERPTTMgRXZlbnRzIGFzIHNwZWNpZmllZCBieSB0aGUgRUNNQVNjcmlwdCBMYW5ndWFnZSBCaW5kaW5nCiAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAwMy9XRC1ET00tTGV2ZWwtMy1FdmVudHMtMjAwMzAzMzEvZWNtYS1zY3JpcHQtYmluZGluZy5odG1sCiAgalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSA9IHsKICAgIGlzRGVmYXVsdFByZXZlbnRlZDogcmV0dXJuRmFsc2UsCiAgICBpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICBpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSByZXR1cm5UcnVlOwogICAgICBpZiAoZSAmJiBlLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9LAogICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwogICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKICAgICAgaWYgKGUgJiYgZS5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICB9CiAgICB9LAogICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwogICAgICB0aGlzLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKICAgICAgaWYgKGUgJiYgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24pIHsKICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICB9CiAgICAgIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB9CiAgfTsKICAvLyBDcmVhdGUgbW91c2VlbnRlci9sZWF2ZSBldmVudHMgdXNpbmcgbW91c2VvdmVyL291dCBhbmQgZXZlbnQtdGltZSBjaGVja3MKICAvLyBTdXBwb3J0OiBDaHJvbWUgMTUrCiAgalF1ZXJ5LmVhY2goewogICAgbW91c2VlbnRlcjogJ21vdXNlb3ZlcicsCiAgICBtb3VzZWxlYXZlOiAnbW91c2VvdXQnLAogICAgcG9pbnRlcmVudGVyOiAncG9pbnRlcm92ZXInLAogICAgcG9pbnRlcmxlYXZlOiAncG9pbnRlcm91dCcKICB9LCBmdW5jdGlvbiAob3JpZywgZml4KSB7CiAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbFtvcmlnXSA9IHsKICAgICAgZGVsZWdhdGVUeXBlOiBmaXgsCiAgICAgIGJpbmRUeXBlOiBmaXgsCiAgICAgIGhhbmRsZTogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIHJldCwgdGFyZ2V0ID0gdGhpcywgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQsIGhhbmRsZU9iaiA9IGV2ZW50LmhhbmRsZU9iajsKICAgICAgICAvLyBGb3IgbW91c2VudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCiAgICAgICAgLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKICAgICAgICBpZiAoIXJlbGF0ZWQgfHwgcmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFqUXVlcnkuY29udGFpbnModGFyZ2V0LCByZWxhdGVkKSkgewogICAgICAgICAgZXZlbnQudHlwZSA9IGhhbmRsZU9iai5vcmlnVHlwZTsKICAgICAgICAgIHJldCA9IGhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBldmVudC50eXBlID0gZml4OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9CiAgICB9OwogIH0pOwogIC8vIENyZWF0ZSAiYnViYmxpbmciIGZvY3VzIGFuZCBibHVyIGV2ZW50cwogIC8vIFN1cHBvcnQ6IEZpcmVmb3gsIENocm9tZSwgU2FmYXJpCiAgaWYgKCFzdXBwb3J0LmZvY3VzaW5CdWJibGVzKSB7CiAgICBqUXVlcnkuZWFjaCh7CiAgICAgIGZvY3VzOiAnZm9jdXNpbicsCiAgICAgIGJsdXI6ICdmb2N1c291dCcKICAgIH0sIGZ1bmN0aW9uIChvcmlnLCBmaXgpIHsKICAgICAgLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudCB3aGlsZSBzb21lb25lIHdhbnRzIGZvY3VzaW4vZm9jdXNvdXQKICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBqUXVlcnkuZXZlbnQuc2ltdWxhdGUoZml4LCBldmVudC50YXJnZXQsIGpRdWVyeS5ldmVudC5maXgoZXZlbnQpLCB0cnVlKTsKICAgICAgfTsKICAgICAgalF1ZXJ5LmV2ZW50LnNwZWNpYWxbZml4XSA9IHsKICAgICAgICBzZXR1cDogZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGRvYyA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLCBhdHRhY2hlcyA9IGRhdGFfcHJpdi5hY2Nlc3MoZG9jLCBmaXgpOwogICAgICAgICAgaWYgKCFhdHRhY2hlcykgewogICAgICAgICAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcihvcmlnLCBoYW5kbGVyLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGRhdGFfcHJpdi5hY2Nlc3MoZG9jLCBmaXgsIChhdHRhY2hlcyB8fCAwKSArIDEpOwogICAgICAgIH0sCiAgICAgICAgdGVhcmRvd246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcywgYXR0YWNoZXMgPSBkYXRhX3ByaXYuYWNjZXNzKGRvYywgZml4KSAtIDE7CiAgICAgICAgICBpZiAoIWF0dGFjaGVzKSB7CiAgICAgICAgICAgIGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKG9yaWcsIGhhbmRsZXIsIHRydWUpOwogICAgICAgICAgICBkYXRhX3ByaXYucmVtb3ZlKGRvYywgZml4KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRhdGFfcHJpdi5hY2Nlc3MoZG9jLCBmaXgsIGF0dGFjaGVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKICB9CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBvbjogZnVuY3Rpb24gKHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIG9uZSkgewogICAgICB2YXIgb3JpZ0ZuLCB0eXBlOwogICAgICAvLyBUeXBlcyBjYW4gYmUgYSBtYXAgb2YgdHlwZXMvaGFuZGxlcnMKICAgICAgaWYgKHR5cGVvZiB0eXBlcyA9PT0gJ29iamVjdCcpIHsKICAgICAgICAvLyAoIHR5cGVzLU9iamVjdCwgc2VsZWN0b3IsIGRhdGEgKQogICAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAvLyAoIHR5cGVzLU9iamVjdCwgZGF0YSApCiAgICAgICAgICBkYXRhID0gZGF0YSB8fCBzZWxlY3RvcjsKICAgICAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICBmb3IgKHR5cGUgaW4gdHlwZXMpIHsKICAgICAgICAgIHRoaXMub24odHlwZSwgc2VsZWN0b3IsIGRhdGEsIHR5cGVzW3R5cGVdLCBvbmUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBpZiAoZGF0YSA9PSBudWxsICYmIGZuID09IG51bGwpIHsKICAgICAgICAvLyAoIHR5cGVzLCBmbiApCiAgICAgICAgZm4gPSBzZWxlY3RvcjsKICAgICAgICBkYXRhID0gc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSBpZiAoZm4gPT0gbnVsbCkgewogICAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAvLyAoIHR5cGVzLCBzZWxlY3RvciwgZm4gKQogICAgICAgICAgZm4gPSBkYXRhOwogICAgICAgICAgZGF0YSA9IHVuZGVmaW5lZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gKCB0eXBlcywgZGF0YSwgZm4gKQogICAgICAgICAgZm4gPSBkYXRhOwogICAgICAgICAgZGF0YSA9IHNlbGVjdG9yOwogICAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmbiA9PT0gZmFsc2UpIHsKICAgICAgICBmbiA9IHJldHVybkZhbHNlOwogICAgICB9IGVsc2UgaWYgKCFmbikgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmIChvbmUgPT09IDEpIHsKICAgICAgICBvcmlnRm4gPSBmbjsKICAgICAgICBmbiA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvCiAgICAgICAgICBqUXVlcnkoKS5vZmYoZXZlbnQpOwogICAgICAgICAgcmV0dXJuIG9yaWdGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH07CiAgICAgICAgLy8gVXNlIHNhbWUgZ3VpZCBzbyBjYWxsZXIgY2FuIHJlbW92ZSB1c2luZyBvcmlnRm4KICAgICAgICBmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKG9yaWdGbi5ndWlkID0galF1ZXJ5Lmd1aWQrKyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZCh0aGlzLCB0eXBlcywgZm4sIGRhdGEsIHNlbGVjdG9yKTsKICAgICAgfSk7CiAgICB9LAogICAgb25lOiBmdW5jdGlvbiAodHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbikgewogICAgICByZXR1cm4gdGhpcy5vbih0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAxKTsKICAgIH0sCiAgICBvZmY6IGZ1bmN0aW9uICh0eXBlcywgc2VsZWN0b3IsIGZuKSB7CiAgICAgIHZhciBoYW5kbGVPYmosIHR5cGU7CiAgICAgIGlmICh0eXBlcyAmJiB0eXBlcy5wcmV2ZW50RGVmYXVsdCAmJiB0eXBlcy5oYW5kbGVPYmopIHsKICAgICAgICAvLyAoIGV2ZW50ICkgIGRpc3BhdGNoZWQgalF1ZXJ5LkV2ZW50CiAgICAgICAgaGFuZGxlT2JqID0gdHlwZXMuaGFuZGxlT2JqOwogICAgICAgIGpRdWVyeSh0eXBlcy5kZWxlZ2F0ZVRhcmdldCkub2ZmKGhhbmRsZU9iai5uYW1lc3BhY2UgPyBoYW5kbGVPYmoub3JpZ1R5cGUgKyAnLicgKyBoYW5kbGVPYmoubmFtZXNwYWNlIDogaGFuZGxlT2JqLm9yaWdUeXBlLCBoYW5kbGVPYmouc2VsZWN0b3IsIGhhbmRsZU9iai5oYW5kbGVyKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHR5cGVzID09PSAnb2JqZWN0JykgewogICAgICAgIC8vICggdHlwZXMtb2JqZWN0IFssIHNlbGVjdG9yXSApCiAgICAgICAgZm9yICh0eXBlIGluIHR5cGVzKSB7CiAgICAgICAgICB0aGlzLm9mZih0eXBlLCBzZWxlY3RvciwgdHlwZXNbdHlwZV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBpZiAoc2VsZWN0b3IgPT09IGZhbHNlIHx8IHR5cGVvZiBzZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIC8vICggdHlwZXMgWywgZm5dICkKICAgICAgICBmbiA9IHNlbGVjdG9yOwogICAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGlmIChmbiA9PT0gZmFsc2UpIHsKICAgICAgICBmbiA9IHJldHVybkZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUodGhpcywgdHlwZXMsIGZuLCBzZWxlY3Rvcik7CiAgICAgIH0pOwogICAgfSwKICAgIHRyaWdnZXI6IGZ1bmN0aW9uICh0eXBlLCBkYXRhKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKHR5cGUsIGRhdGEsIHRoaXMpOwogICAgICB9KTsKICAgIH0sCiAgICB0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgdmFyIGVsZW0gPSB0aGlzWzBdOwogICAgICBpZiAoZWxlbSkgewogICAgICAgIHJldHVybiBqUXVlcnkuZXZlbnQudHJpZ2dlcih0eXBlLCBkYXRhLCBlbGVtLCB0cnVlKTsKICAgICAgfQogICAgfQogIH0pOwogIHZhciByeGh0bWxUYWcgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbXHc6XSspW14+XSopXC8+L2dpLCBydGFnTmFtZSA9IC88KFtcdzpdKykvLCByaHRtbCA9IC88fCYjP1x3KzsvLCBybm9Jbm5lcmh0bWwgPSAvPCg/OnNjcmlwdHxzdHlsZXxsaW5rKS9pLAogICAgLy8gY2hlY2tlZD0iY2hlY2tlZCIgb3IgY2hlY2tlZAogICAgcmNoZWNrZWQgPSAvY2hlY2tlZFxzKig/OltePV18PVxzKi5jaGVja2VkLikvaSwgcnNjcmlwdFR5cGUgPSAvXiR8XC8oPzpqYXZhfGVjbWEpc2NyaXB0L2ksIHJzY3JpcHRUeXBlTWFza2VkID0gL150cnVlXC8oLiopLywgcmNsZWFuU2NyaXB0ID0gL15ccyo8ISg/OlxbQ0RBVEFcW3wtLSl8KD86XF1cXXwtLSk+XHMqJC9nLAogICAgLy8gV2UgaGF2ZSB0byBjbG9zZSB0aGVzZSB0YWdzIHRvIHN1cHBvcnQgWEhUTUwgKCMxMzIwMCkKICAgIHdyYXBNYXAgPSB7CiAgICAgIC8vIFN1cHBvcnQ6IElFIDkKICAgICAgb3B0aW9uOiBbCiAgICAgICAgMSwKICAgICAgICAnPHNlbGVjdCBtdWx0aXBsZT1cJ211bHRpcGxlXCc+JywKICAgICAgICAnPC9zZWxlY3Q+JwogICAgICBdLAogICAgICB0aGVhZDogWwogICAgICAgIDEsCiAgICAgICAgJzx0YWJsZT4nLAogICAgICAgICc8L3RhYmxlPicKICAgICAgXSwKICAgICAgY29sOiBbCiAgICAgICAgMiwKICAgICAgICAnPHRhYmxlPjxjb2xncm91cD4nLAogICAgICAgICc8L2NvbGdyb3VwPjwvdGFibGU+JwogICAgICBdLAogICAgICB0cjogWwogICAgICAgIDIsCiAgICAgICAgJzx0YWJsZT48dGJvZHk+JywKICAgICAgICAnPC90Ym9keT48L3RhYmxlPicKICAgICAgXSwKICAgICAgdGQ6IFsKICAgICAgICAzLAogICAgICAgICc8dGFibGU+PHRib2R5Pjx0cj4nLAogICAgICAgICc8L3RyPjwvdGJvZHk+PC90YWJsZT4nCiAgICAgIF0sCiAgICAgIF9kZWZhdWx0OiBbCiAgICAgICAgMCwKICAgICAgICAnJywKICAgICAgICAnJwogICAgICBdCiAgICB9OwogIC8vIFN1cHBvcnQ6IElFIDkKICB3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247CiAgd3JhcE1hcC50Ym9keSA9IHdyYXBNYXAudGZvb3QgPSB3cmFwTWFwLmNvbGdyb3VwID0gd3JhcE1hcC5jYXB0aW9uID0gd3JhcE1hcC50aGVhZDsKICB3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKICAvLyBTdXBwb3J0OiAxLnggY29tcGF0aWJpbGl0eQogIC8vIE1hbmlwdWxhdGluZyB0YWJsZXMgcmVxdWlyZXMgYSB0Ym9keQogIGZ1bmN0aW9uIG1hbmlwdWxhdGlvblRhcmdldChlbGVtLCBjb250ZW50KSB7CiAgICByZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICd0YWJsZScpICYmIGpRdWVyeS5ub2RlTmFtZShjb250ZW50Lm5vZGVUeXBlICE9PSAxMSA/IGNvbnRlbnQgOiBjb250ZW50LmZpcnN0Q2hpbGQsICd0cicpID8gZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGJvZHknKVswXSB8fCBlbGVtLmFwcGVuZENoaWxkKGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0Ym9keScpKSA6IGVsZW07CiAgfQogIC8vIFJlcGxhY2UvcmVzdG9yZSB0aGUgdHlwZSBhdHRyaWJ1dGUgb2Ygc2NyaXB0IGVsZW1lbnRzIGZvciBzYWZlIERPTSBtYW5pcHVsYXRpb24KICBmdW5jdGlvbiBkaXNhYmxlU2NyaXB0KGVsZW0pIHsKICAgIGVsZW0udHlwZSA9IChlbGVtLmdldEF0dHJpYnV0ZSgndHlwZScpICE9PSBudWxsKSArICcvJyArIGVsZW0udHlwZTsKICAgIHJldHVybiBlbGVtOwogIH0KICBmdW5jdGlvbiByZXN0b3JlU2NyaXB0KGVsZW0pIHsKICAgIHZhciBtYXRjaCA9IHJzY3JpcHRUeXBlTWFza2VkLmV4ZWMoZWxlbS50eXBlKTsKICAgIGlmIChtYXRjaCkgewogICAgICBlbGVtLnR5cGUgPSBtYXRjaFsxXTsKICAgIH0gZWxzZSB7CiAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKCd0eXBlJyk7CiAgICB9CiAgICByZXR1cm4gZWxlbTsKICB9CiAgLy8gTWFyayBzY3JpcHRzIGFzIGhhdmluZyBhbHJlYWR5IGJlZW4gZXZhbHVhdGVkCiAgZnVuY3Rpb24gc2V0R2xvYmFsRXZhbChlbGVtcywgcmVmRWxlbWVudHMpIHsKICAgIHZhciBpID0gMCwgbCA9IGVsZW1zLmxlbmd0aDsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGRhdGFfcHJpdi5zZXQoZWxlbXNbaV0sICdnbG9iYWxFdmFsJywgIXJlZkVsZW1lbnRzIHx8IGRhdGFfcHJpdi5nZXQocmVmRWxlbWVudHNbaV0sICdnbG9iYWxFdmFsJykpOwogICAgfQogIH0KICBmdW5jdGlvbiBjbG9uZUNvcHlFdmVudChzcmMsIGRlc3QpIHsKICAgIHZhciBpLCBsLCB0eXBlLCBwZGF0YU9sZCwgcGRhdGFDdXIsIHVkYXRhT2xkLCB1ZGF0YUN1ciwgZXZlbnRzOwogICAgaWYgKGRlc3Qubm9kZVR5cGUgIT09IDEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gMS4gQ29weSBwcml2YXRlIGRhdGE6IGV2ZW50cywgaGFuZGxlcnMsIGV0Yy4KICAgIGlmIChkYXRhX3ByaXYuaGFzRGF0YShzcmMpKSB7CiAgICAgIHBkYXRhT2xkID0gZGF0YV9wcml2LmFjY2VzcyhzcmMpOwogICAgICBwZGF0YUN1ciA9IGRhdGFfcHJpdi5zZXQoZGVzdCwgcGRhdGFPbGQpOwogICAgICBldmVudHMgPSBwZGF0YU9sZC5ldmVudHM7CiAgICAgIGlmIChldmVudHMpIHsKICAgICAgICBkZWxldGUgcGRhdGFDdXIuaGFuZGxlOwogICAgICAgIHBkYXRhQ3VyLmV2ZW50cyA9IHt9OwogICAgICAgIGZvciAodHlwZSBpbiBldmVudHMpIHsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBldmVudHNbdHlwZV0ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQoZGVzdCwgdHlwZSwgZXZlbnRzW3R5cGVdW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIDIuIENvcHkgdXNlciBkYXRhCiAgICBpZiAoZGF0YV91c2VyLmhhc0RhdGEoc3JjKSkgewogICAgICB1ZGF0YU9sZCA9IGRhdGFfdXNlci5hY2Nlc3Moc3JjKTsKICAgICAgdWRhdGFDdXIgPSBqUXVlcnkuZXh0ZW5kKHt9LCB1ZGF0YU9sZCk7CiAgICAgIGRhdGFfdXNlci5zZXQoZGVzdCwgdWRhdGFDdXIpOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRBbGwoY29udGV4dCwgdGFnKSB7CiAgICB2YXIgcmV0ID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSA/IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnIHx8ICcqJykgOiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwgPyBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwodGFnIHx8ICcqJykgOiBbXTsKICAgIHJldHVybiB0YWcgPT09IHVuZGVmaW5lZCB8fCB0YWcgJiYgalF1ZXJ5Lm5vZGVOYW1lKGNvbnRleHQsIHRhZykgPyBqUXVlcnkubWVyZ2UoW2NvbnRleHRdLCByZXQpIDogcmV0OwogIH0KICAvLyBTdXBwb3J0OiBJRSA+PSA5CiAgZnVuY3Rpb24gZml4SW5wdXQoc3JjLCBkZXN0KSB7CiAgICB2YXIgbm9kZU5hbWUgPSBkZXN0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAvLyBGYWlscyB0byBwZXJzaXN0IHRoZSBjaGVja2VkIHN0YXRlIG9mIGEgY2xvbmVkIGNoZWNrYm94IG9yIHJhZGlvIGJ1dHRvbi4KICAgIGlmIChub2RlTmFtZSA9PT0gJ2lucHV0JyAmJiByY2hlY2thYmxlVHlwZS50ZXN0KHNyYy50eXBlKSkgewogICAgICBkZXN0LmNoZWNrZWQgPSBzcmMuY2hlY2tlZDsgIC8vIEZhaWxzIHRvIHJldHVybiB0aGUgc2VsZWN0ZWQgb3B0aW9uIHRvIHRoZSBkZWZhdWx0IHNlbGVjdGVkIHN0YXRlIHdoZW4gY2xvbmluZyBvcHRpb25zCiAgICB9IGVsc2UgaWYgKG5vZGVOYW1lID09PSAnaW5wdXQnIHx8IG5vZGVOYW1lID09PSAndGV4dGFyZWEnKSB7CiAgICAgIGRlc3QuZGVmYXVsdFZhbHVlID0gc3JjLmRlZmF1bHRWYWx1ZTsKICAgIH0KICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBjbG9uZTogZnVuY3Rpb24gKGVsZW0sIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgIHZhciBpLCBsLCBzcmNFbGVtZW50cywgZGVzdEVsZW1lbnRzLCBjbG9uZSA9IGVsZW0uY2xvbmVOb2RlKHRydWUpLCBpblBhZ2UgPSBqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LCBlbGVtKTsKICAgICAgLy8gU3VwcG9ydDogSUUgPj0gOQogICAgICAvLyBGaXggQ2xvbmluZyBpc3N1ZXMKICAgICAgaWYgKCFzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkICYmIChlbGVtLm5vZGVUeXBlID09PSAxIHx8IGVsZW0ubm9kZVR5cGUgPT09IDExKSAmJiAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pKSB7CiAgICAgICAgLy8gV2UgZXNjaGV3IFNpenpsZSBoZXJlIGZvciBwZXJmb3JtYW5jZSByZWFzb25zOiBodHRwOi8vanNwZXJmLmNvbS9nZXRhbGwtdnMtc2l6emxlLzIKICAgICAgICBkZXN0RWxlbWVudHMgPSBnZXRBbGwoY2xvbmUpOwogICAgICAgIHNyY0VsZW1lbnRzID0gZ2V0QWxsKGVsZW0pOwogICAgICAgIGZvciAoaSA9IDAsIGwgPSBzcmNFbGVtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGZpeElucHV0KHNyY0VsZW1lbnRzW2ldLCBkZXN0RWxlbWVudHNbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBDb3B5IHRoZSBldmVudHMgZnJvbSB0aGUgb3JpZ2luYWwgdG8gdGhlIGNsb25lCiAgICAgIGlmIChkYXRhQW5kRXZlbnRzKSB7CiAgICAgICAgaWYgKGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgICAgICBzcmNFbGVtZW50cyA9IHNyY0VsZW1lbnRzIHx8IGdldEFsbChlbGVtKTsKICAgICAgICAgIGRlc3RFbGVtZW50cyA9IGRlc3RFbGVtZW50cyB8fCBnZXRBbGwoY2xvbmUpOwogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHNyY0VsZW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBjbG9uZUNvcHlFdmVudChzcmNFbGVtZW50c1tpXSwgZGVzdEVsZW1lbnRzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2xvbmVDb3B5RXZlbnQoZWxlbSwgY2xvbmUpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CiAgICAgIGRlc3RFbGVtZW50cyA9IGdldEFsbChjbG9uZSwgJ3NjcmlwdCcpOwogICAgICBpZiAoZGVzdEVsZW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICBzZXRHbG9iYWxFdmFsKGRlc3RFbGVtZW50cywgIWluUGFnZSAmJiBnZXRBbGwoZWxlbSwgJ3NjcmlwdCcpKTsKICAgICAgfQogICAgICAvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKICAgICAgcmV0dXJuIGNsb25lOwogICAgfSwKICAgIGJ1aWxkRnJhZ21lbnQ6IGZ1bmN0aW9uIChlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uKSB7CiAgICAgIHZhciBlbGVtLCB0bXAsIHRhZywgd3JhcCwgY29udGFpbnMsIGosIGZyYWdtZW50ID0gY29udGV4dC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksIG5vZGVzID0gW10sIGkgPSAwLCBsID0gZWxlbXMubGVuZ3RoOwogICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgIGVsZW0gPSBlbGVtc1tpXTsKICAgICAgICBpZiAoZWxlbSB8fCBlbGVtID09PSAwKSB7CiAgICAgICAgICAvLyBBZGQgbm9kZXMgZGlyZWN0bHkKICAgICAgICAgIGlmIChqUXVlcnkudHlwZShlbGVtKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgLy8gU3VwcG9ydDogUXRXZWJLaXQKICAgICAgICAgICAgLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwogICAgICAgICAgICBqUXVlcnkubWVyZ2Uobm9kZXMsIGVsZW0ubm9kZVR5cGUgPyBbZWxlbV0gOiBlbGVtKTsgIC8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQogICAgICAgICAgfSBlbHNlIGlmICghcmh0bWwudGVzdChlbGVtKSkgewogICAgICAgICAgICBub2Rlcy5wdXNoKGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoZWxlbSkpOyAgLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0bXAgPSB0bXAgfHwgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoY29udGV4dC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7CiAgICAgICAgICAgIC8vIERlc2VyaWFsaXplIGEgc3RhbmRhcmQgcmVwcmVzZW50YXRpb24KICAgICAgICAgICAgdGFnID0gKHJ0YWdOYW1lLmV4ZWMoZWxlbSkgfHwgWwogICAgICAgICAgICAgICcnLAogICAgICAgICAgICAgICcnCiAgICAgICAgICAgIF0pWzFdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHdyYXAgPSB3cmFwTWFwW3RhZ10gfHwgd3JhcE1hcC5fZGVmYXVsdDsKICAgICAgICAgICAgdG1wLmlubmVySFRNTCA9IHdyYXBbMV0gKyBlbGVtLnJlcGxhY2UocnhodG1sVGFnLCAnPCQxPjwvJDI+JykgKyB3cmFwWzJdOwogICAgICAgICAgICAvLyBEZXNjZW5kIHRocm91Z2ggd3JhcHBlcnMgdG8gdGhlIHJpZ2h0IGNvbnRlbnQKICAgICAgICAgICAgaiA9IHdyYXBbMF07CiAgICAgICAgICAgIHdoaWxlIChqLS0pIHsKICAgICAgICAgICAgICB0bXAgPSB0bXAubGFzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFF0V2ViS2l0CiAgICAgICAgICAgIC8vIGpRdWVyeS5tZXJnZSBiZWNhdXNlIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3MKICAgICAgICAgICAgalF1ZXJ5Lm1lcmdlKG5vZGVzLCB0bXAuY2hpbGROb2Rlcyk7CiAgICAgICAgICAgIC8vIFJlbWVtYmVyIHRoZSB0b3AtbGV2ZWwgY29udGFpbmVyCiAgICAgICAgICAgIHRtcCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIC8vIEZpeGVzICMxMjM0NgogICAgICAgICAgICAvLyBTdXBwb3J0OiBXZWJraXQsIElFCiAgICAgICAgICAgIHRtcC50ZXh0Q29udGVudCA9ICcnOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBSZW1vdmUgd3JhcHBlciBmcm9tIGZyYWdtZW50CiAgICAgIGZyYWdtZW50LnRleHRDb250ZW50ID0gJyc7CiAgICAgIGkgPSAwOwogICAgICB3aGlsZSAoZWxlbSA9IG5vZGVzW2krK10pIHsKICAgICAgICAvLyAjNDA4NyAtIElmIG9yaWdpbiBhbmQgZGVzdGluYXRpb24gZWxlbWVudHMgYXJlIHRoZSBzYW1lLCBhbmQgdGhpcyBpcwogICAgICAgIC8vIHRoYXQgZWxlbWVudCwgZG8gbm90IGRvIGFueXRoaW5nCiAgICAgICAgaWYgKHNlbGVjdGlvbiAmJiBqUXVlcnkuaW5BcnJheShlbGVtLCBzZWxlY3Rpb24pICE9PSAtMSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvbnRhaW5zID0galF1ZXJ5LmNvbnRhaW5zKGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSk7CiAgICAgICAgLy8gQXBwZW5kIHRvIGZyYWdtZW50CiAgICAgICAgdG1wID0gZ2V0QWxsKGZyYWdtZW50LmFwcGVuZENoaWxkKGVsZW0pLCAnc2NyaXB0Jyk7CiAgICAgICAgLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQogICAgICAgIGlmIChjb250YWlucykgewogICAgICAgICAgc2V0R2xvYmFsRXZhbCh0bXApOwogICAgICAgIH0KICAgICAgICAvLyBDYXB0dXJlIGV4ZWN1dGFibGVzCiAgICAgICAgaWYgKHNjcmlwdHMpIHsKICAgICAgICAgIGogPSAwOwogICAgICAgICAgd2hpbGUgKGVsZW0gPSB0bXBbaisrXSkgewogICAgICAgICAgICBpZiAocnNjcmlwdFR5cGUudGVzdChlbGVtLnR5cGUgfHwgJycpKSB7CiAgICAgICAgICAgICAgc2NyaXB0cy5wdXNoKGVsZW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmcmFnbWVudDsKICAgIH0sCiAgICBjbGVhbkRhdGE6IGZ1bmN0aW9uIChlbGVtcykgewogICAgICB2YXIgZGF0YSwgZWxlbSwgdHlwZSwga2V5LCBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWwsIGkgPSAwOwogICAgICBmb3IgKDsgKGVsZW0gPSBlbGVtc1tpXSkgIT09IHVuZGVmaW5lZDsgaSsrKSB7CiAgICAgICAgaWYgKGpRdWVyeS5hY2NlcHREYXRhKGVsZW0pKSB7CiAgICAgICAgICBrZXkgPSBlbGVtW2RhdGFfcHJpdi5leHBhbmRvXTsKICAgICAgICAgIGlmIChrZXkgJiYgKGRhdGEgPSBkYXRhX3ByaXYuY2FjaGVba2V5XSkpIHsKICAgICAgICAgICAgaWYgKGRhdGEuZXZlbnRzKSB7CiAgICAgICAgICAgICAgZm9yICh0eXBlIGluIGRhdGEuZXZlbnRzKSB7CiAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbFt0eXBlXSkgewogICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKGVsZW0sIHR5cGUpOyAgLy8gVGhpcyBpcyBhIHNob3J0Y3V0IHRvIGF2b2lkIGpRdWVyeS5ldmVudC5yZW1vdmUncyBvdmVyaGVhZAogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZUV2ZW50KGVsZW0sIHR5cGUsIGRhdGEuaGFuZGxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRhdGFfcHJpdi5jYWNoZVtrZXldKSB7CiAgICAgICAgICAgICAgLy8gRGlzY2FyZCBhbnkgcmVtYWluaW5nIGBwcml2YXRlYCBkYXRhCiAgICAgICAgICAgICAgZGVsZXRlIGRhdGFfcHJpdi5jYWNoZVtrZXldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIERpc2NhcmQgYW55IHJlbWFpbmluZyBgdXNlcmAgZGF0YQogICAgICAgIGRlbGV0ZSBkYXRhX3VzZXIuY2FjaGVbZWxlbVtkYXRhX3VzZXIuZXhwYW5kb11dOwogICAgICB9CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB0ZXh0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/IGpRdWVyeS50ZXh0KHRoaXMpIDogdGhpcy5lbXB0eSgpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgICB0aGlzLnRleHRDb250ZW50ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0sCiAgICBhcHBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGlmICh0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQodGhpcywgZWxlbSk7CiAgICAgICAgICB0YXJnZXQuYXBwZW5kQ2hpbGQoZWxlbSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBwcmVwZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSA9PT0gMSB8fCB0aGlzLm5vZGVUeXBlID09PSAxMSB8fCB0aGlzLm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KHRoaXMsIGVsZW0pOwogICAgICAgICAgdGFyZ2V0Lmluc2VydEJlZm9yZShlbGVtLCB0YXJnZXQuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBiZWZvcmU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGlmICh0aGlzLnBhcmVudE5vZGUpIHsKICAgICAgICAgIHRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZWxlbSwgdGhpcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBhZnRlcjogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgewogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZShlbGVtLCB0aGlzLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24gKHNlbGVjdG9yLCBrZWVwRGF0YSkgewogICAgICB2YXIgZWxlbSwgZWxlbXMgPSBzZWxlY3RvciA/IGpRdWVyeS5maWx0ZXIoc2VsZWN0b3IsIHRoaXMpIDogdGhpcywgaSA9IDA7CiAgICAgIGZvciAoOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICBpZiAoIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZ2V0QWxsKGVsZW0pKTsKICAgICAgICB9CiAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgaWYgKGtlZXBEYXRhICYmIGpRdWVyeS5jb250YWlucyhlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0pKSB7CiAgICAgICAgICAgIHNldEdsb2JhbEV2YWwoZ2V0QWxsKGVsZW0sICdzY3JpcHQnKSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGVtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlbGVtLCBpID0gMDsKICAgICAgZm9yICg7IChlbGVtID0gdGhpc1tpXSkgIT0gbnVsbDsgaSsrKSB7CiAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIC8vIFByZXZlbnQgbWVtb3J5IGxlYWtzCiAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbChlbGVtLCBmYWxzZSkpOwogICAgICAgICAgLy8gUmVtb3ZlIGFueSByZW1haW5pbmcgbm9kZXMKICAgICAgICAgIGVsZW0udGV4dENvbnRlbnQgPSAnJzsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uIChkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cykgewogICAgICBkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOwogICAgICBkZWVwRGF0YUFuZEV2ZW50cyA9IGRlZXBEYXRhQW5kRXZlbnRzID09IG51bGwgPyBkYXRhQW5kRXZlbnRzIDogZGVlcERhdGFBbmRFdmVudHM7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5jbG9uZSh0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyk7CiAgICAgIH0pOwogICAgfSwKICAgIGh0bWw6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHZhciBlbGVtID0gdGhpc1swXSB8fCB7fSwgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsKICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5pbm5lckhUTUw7CiAgICAgICAgfQogICAgICAgIC8vIFNlZSBpZiB3ZSBjYW4gdGFrZSBhIHNob3J0Y3V0IGFuZCBqdXN0IHVzZSBpbm5lckhUTUwKICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiAhcm5vSW5uZXJodG1sLnRlc3QodmFsdWUpICYmICF3cmFwTWFwWyhydGFnTmFtZS5leGVjKHZhbHVlKSB8fCBbCiAgICAgICAgICAgICcnLAogICAgICAgICAgICAnJwogICAgICAgICAgXSlbMV0udG9Mb3dlckNhc2UoKV0pIHsKICAgICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZShyeGh0bWxUYWcsICc8JDE+PC8kMj4nKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbaV0gfHwge307CiAgICAgICAgICAgICAgLy8gUmVtb3ZlIGVsZW1lbnQgbm9kZXMgYW5kIHByZXZlbnQgbWVtb3J5IGxlYWtzCiAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZ2V0QWxsKGVsZW0sIGZhbHNlKSk7CiAgICAgICAgICAgICAgICBlbGVtLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtID0gMDsgIC8vIElmIHVzaW5nIGlubmVySFRNTCB0aHJvd3MgYW4gZXhjZXB0aW9uLCB1c2UgdGhlIGZhbGxiYWNrIG1ldGhvZAogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZWxlbSkgewogICAgICAgICAgdGhpcy5lbXB0eSgpLmFwcGVuZCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCk7CiAgICB9LAogICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZyA9IGFyZ3VtZW50c1swXTsKICAgICAgLy8gTWFrZSB0aGUgY2hhbmdlcywgcmVwbGFjaW5nIGVhY2ggY29udGV4dCBlbGVtZW50IHdpdGggdGhlIG5ldyBjb250ZW50CiAgICAgIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGFyZyA9IHRoaXMucGFyZW50Tm9kZTsKICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbCh0aGlzKSk7CiAgICAgICAgaWYgKGFyZykgewogICAgICAgICAgYXJnLnJlcGxhY2VDaGlsZChlbGVtLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBGb3JjZSByZW1vdmFsIGlmIHRoZXJlIHdhcyBubyBuZXcgY29udGVudCAoZS5nLiwgZnJvbSBlbXB0eSBhcmd1bWVudHMpCiAgICAgIHJldHVybiBhcmcgJiYgKGFyZy5sZW5ndGggfHwgYXJnLm5vZGVUeXBlKSA/IHRoaXMgOiB0aGlzLnJlbW92ZSgpOwogICAgfSwKICAgIGRldGFjaDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLnJlbW92ZShzZWxlY3RvciwgdHJ1ZSk7CiAgICB9LAogICAgZG9tTWFuaXA6IGZ1bmN0aW9uIChhcmdzLCBjYWxsYmFjaykgewogICAgICAvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCiAgICAgIGFyZ3MgPSBjb25jYXQuYXBwbHkoW10sIGFyZ3MpOwogICAgICB2YXIgZnJhZ21lbnQsIGZpcnN0LCBzY3JpcHRzLCBoYXNTY3JpcHRzLCBub2RlLCBkb2MsIGkgPSAwLCBsID0gdGhpcy5sZW5ndGgsIHNldCA9IHRoaXMsIGlOb0Nsb25lID0gbCAtIDEsIHZhbHVlID0gYXJnc1swXSwgaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKTsKICAgICAgLy8gV2UgY2FuJ3QgY2xvbmVOb2RlIGZyYWdtZW50cyB0aGF0IGNvbnRhaW4gY2hlY2tlZCwgaW4gV2ViS2l0CiAgICAgIGlmIChpc0Z1bmN0aW9uIHx8IGwgPiAxICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgJiYgIXN1cHBvcnQuY2hlY2tDbG9uZSAmJiByY2hlY2tlZC50ZXN0KHZhbHVlKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgICB2YXIgc2VsZiA9IHNldC5lcShpbmRleCk7CiAgICAgICAgICBpZiAoaXNGdW5jdGlvbikgewogICAgICAgICAgICBhcmdzWzBdID0gdmFsdWUuY2FsbCh0aGlzLCBpbmRleCwgc2VsZi5odG1sKCkpOwogICAgICAgICAgfQogICAgICAgICAgc2VsZi5kb21NYW5pcChhcmdzLCBjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGwpIHsKICAgICAgICBmcmFnbWVudCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KGFyZ3MsIHRoaXNbMF0ub3duZXJEb2N1bWVudCwgZmFsc2UsIHRoaXMpOwogICAgICAgIGZpcnN0ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKICAgICAgICBpZiAoZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIGZyYWdtZW50ID0gZmlyc3Q7CiAgICAgICAgfQogICAgICAgIGlmIChmaXJzdCkgewogICAgICAgICAgc2NyaXB0cyA9IGpRdWVyeS5tYXAoZ2V0QWxsKGZyYWdtZW50LCAnc2NyaXB0JyksIGRpc2FibGVTY3JpcHQpOwogICAgICAgICAgaGFzU2NyaXB0cyA9IHNjcmlwdHMubGVuZ3RoOwogICAgICAgICAgLy8gVXNlIHRoZSBvcmlnaW5hbCBmcmFnbWVudCBmb3IgdGhlIGxhc3QgaXRlbSBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBiZWNhdXNlIGl0IGNhbiBlbmQgdXAKICAgICAgICAgIC8vIGJlaW5nIGVtcHRpZWQgaW5jb3JyZWN0bHkgaW4gY2VydGFpbiBzaXR1YXRpb25zICgjODA3MCkuCiAgICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBub2RlID0gZnJhZ21lbnQ7CiAgICAgICAgICAgIGlmIChpICE9PSBpTm9DbG9uZSkgewogICAgICAgICAgICAgIG5vZGUgPSBqUXVlcnkuY2xvbmUobm9kZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgLy8gS2VlcCByZWZlcmVuY2VzIHRvIGNsb25lZCBzY3JpcHRzIGZvciBsYXRlciByZXN0b3JhdGlvbgogICAgICAgICAgICAgIGlmIChoYXNTY3JpcHRzKSB7CiAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBRdFdlYktpdAogICAgICAgICAgICAgICAgLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwogICAgICAgICAgICAgICAgalF1ZXJ5Lm1lcmdlKHNjcmlwdHMsIGdldEFsbChub2RlLCAnc2NyaXB0JykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXNbaV0sIG5vZGUsIGkpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc1NjcmlwdHMpIHsKICAgICAgICAgICAgZG9jID0gc2NyaXB0c1tzY3JpcHRzLmxlbmd0aCAtIDFdLm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICAgIC8vIFJlZW5hYmxlIHNjcmlwdHMKICAgICAgICAgICAgalF1ZXJ5Lm1hcChzY3JpcHRzLCByZXN0b3JlU2NyaXB0KTsKICAgICAgICAgICAgLy8gRXZhbHVhdGUgZXhlY3V0YWJsZSBzY3JpcHRzIG9uIGZpcnN0IGRvY3VtZW50IGluc2VydGlvbgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaGFzU2NyaXB0czsgaSsrKSB7CiAgICAgICAgICAgICAgbm9kZSA9IHNjcmlwdHNbaV07CiAgICAgICAgICAgICAgaWYgKHJzY3JpcHRUeXBlLnRlc3Qobm9kZS50eXBlIHx8ICcnKSAmJiAhZGF0YV9wcml2LmFjY2Vzcyhub2RlLCAnZ2xvYmFsRXZhbCcpICYmIGpRdWVyeS5jb250YWlucyhkb2MsIG5vZGUpKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5zcmMpIHsKICAgICAgICAgICAgICAgICAgLy8gT3B0aW9uYWwgQUpBWCBkZXBlbmRlbmN5LCBidXQgd29uJ3QgcnVuIHNjcmlwdHMgaWYgbm90IHByZXNlbnQKICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5fZXZhbFVybCkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5fZXZhbFVybChub2RlLnNyYyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGpRdWVyeS5nbG9iYWxFdmFsKG5vZGUudGV4dENvbnRlbnQucmVwbGFjZShyY2xlYW5TY3JpcHQsICcnKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKHsKICAgIGFwcGVuZFRvOiAnYXBwZW5kJywKICAgIHByZXBlbmRUbzogJ3ByZXBlbmQnLAogICAgaW5zZXJ0QmVmb3JlOiAnYmVmb3JlJywKICAgIGluc2VydEFmdGVyOiAnYWZ0ZXInLAogICAgcmVwbGFjZUFsbDogJ3JlcGxhY2VXaXRoJwogIH0sIGZ1bmN0aW9uIChuYW1lLCBvcmlnaW5hbCkgewogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHZhciBlbGVtcywgcmV0ID0gW10sIGluc2VydCA9IGpRdWVyeShzZWxlY3RvciksIGxhc3QgPSBpbnNlcnQubGVuZ3RoIC0gMSwgaSA9IDA7CiAgICAgIGZvciAoOyBpIDw9IGxhc3Q7IGkrKykgewogICAgICAgIGVsZW1zID0gaSA9PT0gbGFzdCA/IHRoaXMgOiB0aGlzLmNsb25lKHRydWUpOwogICAgICAgIGpRdWVyeShpbnNlcnRbaV0pW29yaWdpbmFsXShlbGVtcyk7CiAgICAgICAgLy8gU3VwcG9ydDogUXRXZWJLaXQKICAgICAgICAvLyAuZ2V0KCkgYmVjYXVzZSBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzCiAgICAgICAgcHVzaC5hcHBseShyZXQsIGVsZW1zLmdldCgpKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2socmV0KTsKICAgIH07CiAgfSk7CiAgdmFyIGlmcmFtZSwgZWxlbWRpc3BsYXkgPSB7fTsKICAvKioKICAgKiBSZXRyaWV2ZSB0aGUgYWN0dWFsIGRpc3BsYXkgb2YgYSBlbGVtZW50CiAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgbm9kZU5hbWUgb2YgdGhlIGVsZW1lbnQKICAgKiBAcGFyYW0ge09iamVjdH0gZG9jIERvY3VtZW50IG9iamVjdAogICAqLwogIC8vIENhbGxlZCBvbmx5IGZyb20gd2l0aGluIGRlZmF1bHREaXNwbGF5CiAgZnVuY3Rpb24gYWN0dWFsRGlzcGxheShuYW1lLCBkb2MpIHsKICAgIHZhciBzdHlsZSwgZWxlbSA9IGpRdWVyeShkb2MuY3JlYXRlRWxlbWVudChuYW1lKSkuYXBwZW5kVG8oZG9jLmJvZHkpLAogICAgICAvLyBnZXREZWZhdWx0Q29tcHV0ZWRTdHlsZSBtaWdodCBiZSByZWxpYWJseSB1c2VkIG9ubHkgb24gYXR0YWNoZWQgZWxlbWVudAogICAgICBkaXNwbGF5ID0gd2luZG93LmdldERlZmF1bHRDb21wdXRlZFN0eWxlICYmIChzdHlsZSA9IHdpbmRvdy5nZXREZWZhdWx0Q29tcHV0ZWRTdHlsZShlbGVtWzBdKSkgPyAvLyBVc2Ugb2YgdGhpcyBtZXRob2QgaXMgYSB0ZW1wb3JhcnkgZml4IChtb3JlIGxpa2Ugb3B0bWl6YXRpb24pIHVudGlsIHNvbWV0aGluZyBiZXR0ZXIgY29tZXMgYWxvbmcsCiAgICAgIC8vIHNpbmNlIGl0IHdhcyByZW1vdmVkIGZyb20gc3BlY2lmaWNhdGlvbiBhbmQgc3VwcG9ydGVkIG9ubHkgaW4gRkYKICAgICAgc3R5bGUuZGlzcGxheSA6IGpRdWVyeS5jc3MoZWxlbVswXSwgJ2Rpc3BsYXknKTsKICAgIC8vIFdlIGRvbid0IGhhdmUgYW55IGRhdGEgc3RvcmVkIG9uIHRoZSBlbGVtZW50LAogICAgLy8gc28gdXNlICJkZXRhY2giIG1ldGhvZCBhcyBmYXN0IHdheSB0byBnZXQgcmlkIG9mIHRoZSBlbGVtZW50CiAgICBlbGVtLmRldGFjaCgpOwogICAgcmV0dXJuIGRpc3BsYXk7CiAgfQogIC8qKgogICAqIFRyeSB0byBkZXRlcm1pbmUgdGhlIGRlZmF1bHQgZGlzcGxheSB2YWx1ZSBvZiBhbiBlbGVtZW50CiAgICogQHBhcmFtIHtTdHJpbmd9IG5vZGVOYW1lCiAgICovCiAgZnVuY3Rpb24gZGVmYXVsdERpc3BsYXkobm9kZU5hbWUpIHsKICAgIHZhciBkb2MgPSBkb2N1bWVudCwgZGlzcGxheSA9IGVsZW1kaXNwbGF5W25vZGVOYW1lXTsKICAgIGlmICghZGlzcGxheSkgewogICAgICBkaXNwbGF5ID0gYWN0dWFsRGlzcGxheShub2RlTmFtZSwgZG9jKTsKICAgICAgLy8gSWYgdGhlIHNpbXBsZSB3YXkgZmFpbHMsIHJlYWQgZnJvbSBpbnNpZGUgYW4gaWZyYW1lCiAgICAgIGlmIChkaXNwbGF5ID09PSAnbm9uZScgfHwgIWRpc3BsYXkpIHsKICAgICAgICAvLyBVc2UgdGhlIGFscmVhZHktY3JlYXRlZCBpZnJhbWUgaWYgcG9zc2libGUKICAgICAgICBpZnJhbWUgPSAoaWZyYW1lIHx8IGpRdWVyeSgnPGlmcmFtZSBmcmFtZWJvcmRlcj1cJzBcJyB3aWR0aD1cJzBcJyBoZWlnaHQ9XCcwXCcvPicpKS5hcHBlbmRUbyhkb2MuZG9jdW1lbnRFbGVtZW50KTsKICAgICAgICAvLyBBbHdheXMgd3JpdGUgYSBuZXcgSFRNTCBza2VsZXRvbiBzbyBXZWJraXQgYW5kIEZpcmVmb3ggZG9uJ3QgY2hva2Ugb24gcmV1c2UKICAgICAgICBkb2MgPSBpZnJhbWVbMF0uY29udGVudERvY3VtZW50OwogICAgICAgIC8vIFN1cHBvcnQ6IElFCiAgICAgICAgZG9jLndyaXRlKCk7CiAgICAgICAgZG9jLmNsb3NlKCk7CiAgICAgICAgZGlzcGxheSA9IGFjdHVhbERpc3BsYXkobm9kZU5hbWUsIGRvYyk7CiAgICAgICAgaWZyYW1lLmRldGFjaCgpOwogICAgICB9CiAgICAgIC8vIFN0b3JlIHRoZSBjb3JyZWN0IGRlZmF1bHQgZGlzcGxheQogICAgICBlbGVtZGlzcGxheVtub2RlTmFtZV0gPSBkaXNwbGF5OwogICAgfQogICAgcmV0dXJuIGRpc3BsYXk7CiAgfQogIHZhciBybWFyZ2luID0gL15tYXJnaW4vOwogIHZhciBybnVtbm9ucHggPSBuZXcgUmVnRXhwKCdeKCcgKyBwbnVtICsgJykoPyFweClbYS16JV0rJCcsICdpJyk7CiAgdmFyIGdldFN0eWxlcyA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICByZXR1cm4gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbSwgbnVsbCk7CiAgfTsKICBmdW5jdGlvbiBjdXJDU1MoZWxlbSwgbmFtZSwgY29tcHV0ZWQpIHsKICAgIHZhciB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLCByZXQsIHN0eWxlID0gZWxlbS5zdHlsZTsKICAgIGNvbXB1dGVkID0gY29tcHV0ZWQgfHwgZ2V0U3R5bGVzKGVsZW0pOwogICAgLy8gU3VwcG9ydDogSUU5CiAgICAvLyBnZXRQcm9wZXJ0eVZhbHVlIGlzIG9ubHkgbmVlZGVkIGZvciAuY3NzKCdmaWx0ZXInKSBpbiBJRTksIHNlZSAjMTI1MzcKICAgIGlmIChjb21wdXRlZCkgewogICAgICByZXQgPSBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKG5hbWUpIHx8IGNvbXB1dGVkW25hbWVdOwogICAgfQogICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgIGlmIChyZXQgPT09ICcnICYmICFqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LCBlbGVtKSkgewogICAgICAgIHJldCA9IGpRdWVyeS5zdHlsZShlbGVtLCBuYW1lKTsKICAgICAgfQogICAgICAvLyBTdXBwb3J0OiBpT1MgPCA2CiAgICAgIC8vIEEgdHJpYnV0ZSB0byB0aGUgImF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMiCiAgICAgIC8vIGlPUyA8IDYgKGF0IGxlYXN0KSByZXR1cm5zIHBlcmNlbnRhZ2UgZm9yIGEgbGFyZ2VyIHNldCBvZiB2YWx1ZXMsIGJ1dCB3aWR0aCBzZWVtcyB0byBiZSByZWxpYWJseSBwaXhlbHMKICAgICAgLy8gdGhpcyBpcyBhZ2FpbnN0IHRoZSBDU1NPTSBkcmFmdCBzcGVjOiBodHRwOi8vZGV2LnczLm9yZy9jc3N3Zy9jc3NvbS8jcmVzb2x2ZWQtdmFsdWVzCiAgICAgIGlmIChybnVtbm9ucHgudGVzdChyZXQpICYmIHJtYXJnaW4udGVzdChuYW1lKSkgewogICAgICAgIC8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKICAgICAgICB3aWR0aCA9IHN0eWxlLndpZHRoOwogICAgICAgIG1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CiAgICAgICAgbWF4V2lkdGggPSBzdHlsZS5tYXhXaWR0aDsKICAgICAgICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgICAgICAgc3R5bGUubWluV2lkdGggPSBzdHlsZS5tYXhXaWR0aCA9IHN0eWxlLndpZHRoID0gcmV0OwogICAgICAgIHJldCA9IGNvbXB1dGVkLndpZHRoOwogICAgICAgIC8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMKICAgICAgICBzdHlsZS53aWR0aCA9IHdpZHRoOwogICAgICAgIHN0eWxlLm1pbldpZHRoID0gbWluV2lkdGg7CiAgICAgICAgc3R5bGUubWF4V2lkdGggPSBtYXhXaWR0aDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJldCAhPT0gdW5kZWZpbmVkID8gLy8gU3VwcG9ydDogSUUKICAgIC8vIElFIHJldHVybnMgekluZGV4IHZhbHVlIGFzIGFuIGludGVnZXIuCiAgICByZXQgKyAnJyA6IHJldDsKICB9CiAgZnVuY3Rpb24gYWRkR2V0SG9va0lmKGNvbmRpdGlvbkZuLCBob29rRm4pIHsKICAgIC8vIERlZmluZSB0aGUgaG9vaywgd2UnbGwgY2hlY2sgb24gdGhlIGZpcnN0IHJ1biBpZiBpdCdzIHJlYWxseSBuZWVkZWQuCiAgICByZXR1cm4gewogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoY29uZGl0aW9uRm4oKSkgewogICAgICAgICAgLy8gSG9vayBub3QgbmVlZGVkIChvciBpdCdzIG5vdCBwb3NzaWJsZSB0byB1c2UgaXQgZHVlIHRvIG1pc3NpbmcgZGVwZW5kZW5jeSksCiAgICAgICAgICAvLyByZW1vdmUgaXQuCiAgICAgICAgICAvLyBTaW5jZSB0aGVyZSBhcmUgbm8gb3RoZXIgaG9va3MgZm9yIG1hcmdpblJpZ2h0LCByZW1vdmUgdGhlIHdob2xlIG9iamVjdC4KICAgICAgICAgIGRlbGV0ZSB0aGlzLmdldDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gSG9vayBuZWVkZWQ7IHJlZGVmaW5lIGl0IHNvIHRoYXQgdGhlIHN1cHBvcnQgdGVzdCBpcyBub3QgZXhlY3V0ZWQgYWdhaW4uCiAgICAgICAgcmV0dXJuICh0aGlzLmdldCA9IGhvb2tGbikuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9CiAgKGZ1bmN0aW9uICgpIHsKICAgIHZhciBwaXhlbFBvc2l0aW9uVmFsLCBib3hTaXppbmdSZWxpYWJsZVZhbCwgZG9jRWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgaWYgKCFkaXYuc3R5bGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID0gJ2NvbnRlbnQtYm94JzsKICAgIGRpdi5jbG9uZU5vZGUodHJ1ZSkuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAnJzsKICAgIHN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlID0gZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID09PSAnY29udGVudC1ib3gnOwogICAgY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAnYm9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDt0b3A6MDtsZWZ0Oi05OTk5cHg7bWFyZ2luLXRvcDoxcHg7JyArICdwb3NpdGlvbjphYnNvbHV0ZSc7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZGl2KTsKICAgIC8vIEV4ZWN1dGluZyBib3RoIHBpeGVsUG9zaXRpb24gJiBib3hTaXppbmdSZWxpYWJsZSB0ZXN0cyByZXF1aXJlIG9ubHkgb25lIGxheW91dAogICAgLy8gc28gdGhleSdyZSBleGVjdXRlZCBhdCB0aGUgc2FtZSB0aW1lIHRvIHNhdmUgdGhlIHNlY29uZCBjb21wdXRhdGlvbi4KICAgIGZ1bmN0aW9uIGNvbXB1dGVQaXhlbFBvc2l0aW9uQW5kQm94U2l6aW5nUmVsaWFibGUoKSB7CiAgICAgIGRpdi5zdHlsZS5jc3NUZXh0ID0gLy8gU3VwcG9ydDogRmlyZWZveDwyOSwgQW5kcm9pZCAyLjMKICAgICAgLy8gVmVuZG9yLXByZWZpeCBib3gtc2l6aW5nCiAgICAgICctd2Via2l0LWJveC1zaXppbmc6Ym9yZGVyLWJveDstbW96LWJveC1zaXppbmc6Ym9yZGVyLWJveDsnICsgJ2JveC1zaXppbmc6Ym9yZGVyLWJveDtkaXNwbGF5OmJsb2NrO21hcmdpbi10b3A6MSU7dG9wOjElOycgKyAnYm9yZGVyOjFweDtwYWRkaW5nOjFweDt3aWR0aDo0cHg7cG9zaXRpb246YWJzb2x1dGUnOwogICAgICBkaXYuaW5uZXJIVE1MID0gJyc7CiAgICAgIGRvY0VsZW0uYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKICAgICAgdmFyIGRpdlN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZGl2LCBudWxsKTsKICAgICAgcGl4ZWxQb3NpdGlvblZhbCA9IGRpdlN0eWxlLnRvcCAhPT0gJzElJzsKICAgICAgYm94U2l6aW5nUmVsaWFibGVWYWwgPSBkaXZTdHlsZS53aWR0aCA9PT0gJzRweCc7CiAgICAgIGRvY0VsZW0ucmVtb3ZlQ2hpbGQoY29udGFpbmVyKTsKICAgIH0KICAgIC8vIFN1cHBvcnQ6IG5vZGUuanMganNkb20KICAgIC8vIERvbid0IGFzc3VtZSB0aGF0IGdldENvbXB1dGVkU3R5bGUgaXMgYSBwcm9wZXJ0eSBvZiB0aGUgZ2xvYmFsIG9iamVjdAogICAgaWYgKHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgIGpRdWVyeS5leHRlbmQoc3VwcG9ydCwgewogICAgICAgIHBpeGVsUG9zaXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIFRoaXMgdGVzdCBpcyBleGVjdXRlZCBvbmx5IG9uY2UgYnV0IHdlIHN0aWxsIGRvIG1lbW9pemluZwogICAgICAgICAgLy8gc2luY2Ugd2UgY2FuIHVzZSB0aGUgYm94U2l6aW5nUmVsaWFibGUgcHJlLWNvbXB1dGluZy4KICAgICAgICAgIC8vIE5vIG5lZWQgdG8gY2hlY2sgaWYgdGhlIHRlc3Qgd2FzIGFscmVhZHkgcGVyZm9ybWVkLCB0aG91Z2guCiAgICAgICAgICBjb21wdXRlUGl4ZWxQb3NpdGlvbkFuZEJveFNpemluZ1JlbGlhYmxlKCk7CiAgICAgICAgICByZXR1cm4gcGl4ZWxQb3NpdGlvblZhbDsKICAgICAgICB9LAogICAgICAgIGJveFNpemluZ1JlbGlhYmxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoYm94U2l6aW5nUmVsaWFibGVWYWwgPT0gbnVsbCkgewogICAgICAgICAgICBjb21wdXRlUGl4ZWxQb3NpdGlvbkFuZEJveFNpemluZ1JlbGlhYmxlKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYm94U2l6aW5nUmVsaWFibGVWYWw7CiAgICAgICAgfSwKICAgICAgICByZWxpYWJsZU1hcmdpblJpZ2h0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDIuMwogICAgICAgICAgLy8gQ2hlY2sgaWYgZGl2IHdpdGggZXhwbGljaXQgd2lkdGggYW5kIG5vIG1hcmdpbi1yaWdodCBpbmNvcnJlY3RseQogICAgICAgICAgLy8gZ2V0cyBjb21wdXRlZCBtYXJnaW4tcmlnaHQgYmFzZWQgb24gd2lkdGggb2YgY29udGFpbmVyLiAoIzMzMzMpCiAgICAgICAgICAvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKICAgICAgICAgIC8vIFRoaXMgc3VwcG9ydCBmdW5jdGlvbiBpcyBvbmx5IGV4ZWN1dGVkIG9uY2Ugc28gbm8gbWVtb2l6aW5nIGlzIG5lZWRlZC4KICAgICAgICAgIHZhciByZXQsIG1hcmdpbkRpdiA9IGRpdi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7CiAgICAgICAgICAvLyBSZXNldCBDU1M6IGJveC1zaXppbmc7IGRpc3BsYXk7IG1hcmdpbjsgYm9yZGVyOyBwYWRkaW5nCiAgICAgICAgICBtYXJnaW5EaXYuc3R5bGUuY3NzVGV4dCA9IGRpdi5zdHlsZS5jc3NUZXh0ID0gLy8gU3VwcG9ydDogRmlyZWZveDwyOSwgQW5kcm9pZCAyLjMKICAgICAgICAgIC8vIFZlbmRvci1wcmVmaXggYm94LXNpemluZwogICAgICAgICAgJy13ZWJraXQtYm94LXNpemluZzpjb250ZW50LWJveDstbW96LWJveC1zaXppbmc6Y29udGVudC1ib3g7JyArICdib3gtc2l6aW5nOmNvbnRlbnQtYm94O2Rpc3BsYXk6YmxvY2s7bWFyZ2luOjA7Ym9yZGVyOjA7cGFkZGluZzowJzsKICAgICAgICAgIG1hcmdpbkRpdi5zdHlsZS5tYXJnaW5SaWdodCA9IG1hcmdpbkRpdi5zdHlsZS53aWR0aCA9ICcwJzsKICAgICAgICAgIGRpdi5zdHlsZS53aWR0aCA9ICcxcHgnOwogICAgICAgICAgZG9jRWxlbS5hcHBlbmRDaGlsZChjb250YWluZXIpOwogICAgICAgICAgcmV0ID0gIXBhcnNlRmxvYXQod2luZG93LmdldENvbXB1dGVkU3R5bGUobWFyZ2luRGl2LCBudWxsKS5tYXJnaW5SaWdodCk7CiAgICAgICAgICBkb2NFbGVtLnJlbW92ZUNoaWxkKGNvbnRhaW5lcik7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSgpKTsKICAvLyBBIG1ldGhvZCBmb3IgcXVpY2tseSBzd2FwcGluZyBpbi9vdXQgQ1NTIHByb3BlcnRpZXMgdG8gZ2V0IGNvcnJlY3QgY2FsY3VsYXRpb25zLgogIGpRdWVyeS5zd2FwID0gZnVuY3Rpb24gKGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrLCBhcmdzKSB7CiAgICB2YXIgcmV0LCBuYW1lLCBvbGQgPSB7fTsKICAgIC8vIFJlbWVtYmVyIHRoZSBvbGQgdmFsdWVzLCBhbmQgaW5zZXJ0IHRoZSBuZXcgb25lcwogICAgZm9yIChuYW1lIGluIG9wdGlvbnMpIHsKICAgICAgb2xkW25hbWVdID0gZWxlbS5zdHlsZVtuYW1lXTsKICAgICAgZWxlbS5zdHlsZVtuYW1lXSA9IG9wdGlvbnNbbmFtZV07CiAgICB9CiAgICByZXQgPSBjYWxsYmFjay5hcHBseShlbGVtLCBhcmdzIHx8IFtdKTsKICAgIC8vIFJldmVydCB0aGUgb2xkIHZhbHVlcwogICAgZm9yIChuYW1lIGluIG9wdGlvbnMpIHsKICAgICAgZWxlbS5zdHlsZVtuYW1lXSA9IG9sZFtuYW1lXTsKICAgIH0KICAgIHJldHVybiByZXQ7CiAgfTsKICB2YXIKICAgIC8vIHN3YXBwYWJsZSBpZiBkaXNwbGF5IGlzIG5vbmUgb3Igc3RhcnRzIHdpdGggdGFibGUgZXhjZXB0ICJ0YWJsZSIsICJ0YWJsZS1jZWxsIiwgb3IgInRhYmxlLWNhcHRpb24iCiAgICAvLyBzZWUgaGVyZSBmb3IgZGlzcGxheSB2YWx1ZXM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvQ1NTL2Rpc3BsYXkKICAgIHJkaXNwbGF5c3dhcCA9IC9eKG5vbmV8dGFibGUoPyEtY1tlYV0pLispLywgcm51bXNwbGl0ID0gbmV3IFJlZ0V4cCgnXignICsgcG51bSArICcpKC4qKSQnLCAnaScpLCBycmVsTnVtID0gbmV3IFJlZ0V4cCgnXihbKy1dKT0oJyArIHBudW0gKyAnKScsICdpJyksIGNzc1Nob3cgPSB7CiAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICB2aXNpYmlsaXR5OiAnaGlkZGVuJywKICAgICAgZGlzcGxheTogJ2Jsb2NrJwogICAgfSwgY3NzTm9ybWFsVHJhbnNmb3JtID0gewogICAgICBsZXR0ZXJTcGFjaW5nOiAnMCcsCiAgICAgIGZvbnRXZWlnaHQ6ICc0MDAnCiAgICB9LCBjc3NQcmVmaXhlcyA9IFsKICAgICAgJ1dlYmtpdCcsCiAgICAgICdPJywKICAgICAgJ01veicsCiAgICAgICdtcycKICAgIF07CiAgLy8gcmV0dXJuIGEgY3NzIHByb3BlcnR5IG1hcHBlZCB0byBhIHBvdGVudGlhbGx5IHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQogIGZ1bmN0aW9uIHZlbmRvclByb3BOYW1lKHN0eWxlLCBuYW1lKSB7CiAgICAvLyBzaG9ydGN1dCBmb3IgbmFtZXMgdGhhdCBhcmUgbm90IHZlbmRvciBwcmVmaXhlZAogICAgaWYgKG5hbWUgaW4gc3R5bGUpIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgICAvLyBjaGVjayBmb3IgdmVuZG9yIHByZWZpeGVkIG5hbWVzCiAgICB2YXIgY2FwTmFtZSA9IG5hbWVbMF0udG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSksIG9yaWdOYW1lID0gbmFtZSwgaSA9IGNzc1ByZWZpeGVzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgbmFtZSA9IGNzc1ByZWZpeGVzW2ldICsgY2FwTmFtZTsKICAgICAgaWYgKG5hbWUgaW4gc3R5bGUpIHsKICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9yaWdOYW1lOwogIH0KICBmdW5jdGlvbiBzZXRQb3NpdGl2ZU51bWJlcihlbGVtLCB2YWx1ZSwgc3VidHJhY3QpIHsKICAgIHZhciBtYXRjaGVzID0gcm51bXNwbGl0LmV4ZWModmFsdWUpOwogICAgcmV0dXJuIG1hdGNoZXMgPyAvLyBHdWFyZCBhZ2FpbnN0IHVuZGVmaW5lZCAic3VidHJhY3QiLCBlLmcuLCB3aGVuIHVzZWQgYXMgaW4gY3NzSG9va3MKICAgIE1hdGgubWF4KDAsIG1hdGNoZXNbMV0gLSAoc3VidHJhY3QgfHwgMCkpICsgKG1hdGNoZXNbMl0gfHwgJ3B4JykgOiB2YWx1ZTsKICB9CiAgZnVuY3Rpb24gYXVnbWVudFdpZHRoT3JIZWlnaHQoZWxlbSwgbmFtZSwgZXh0cmEsIGlzQm9yZGVyQm94LCBzdHlsZXMpIHsKICAgIHZhciBpID0gZXh0cmEgPT09IChpc0JvcmRlckJveCA/ICdib3JkZXInIDogJ2NvbnRlbnQnKSA/IC8vIElmIHdlIGFscmVhZHkgaGF2ZSB0aGUgcmlnaHQgbWVhc3VyZW1lbnQsIGF2b2lkIGF1Z21lbnRhdGlvbgogICAgICA0IDogLy8gT3RoZXJ3aXNlIGluaXRpYWxpemUgZm9yIGhvcml6b250YWwgb3IgdmVydGljYWwgcHJvcGVydGllcwogICAgICBuYW1lID09PSAnd2lkdGgnID8gMSA6IDAsIHZhbCA9IDA7CiAgICBmb3IgKDsgaSA8IDQ7IGkgKz0gMikgewogICAgICAvLyBib3RoIGJveCBtb2RlbHMgZXhjbHVkZSBtYXJnaW4sIHNvIGFkZCBpdCBpZiB3ZSB3YW50IGl0CiAgICAgIGlmIChleHRyYSA9PT0gJ21hcmdpbicpIHsKICAgICAgICB2YWwgKz0galF1ZXJ5LmNzcyhlbGVtLCBleHRyYSArIGNzc0V4cGFuZFtpXSwgdHJ1ZSwgc3R5bGVzKTsKICAgICAgfQogICAgICBpZiAoaXNCb3JkZXJCb3gpIHsKICAgICAgICAvLyBib3JkZXItYm94IGluY2x1ZGVzIHBhZGRpbmcsIHNvIHJlbW92ZSBpdCBpZiB3ZSB3YW50IGNvbnRlbnQKICAgICAgICBpZiAoZXh0cmEgPT09ICdjb250ZW50JykgewogICAgICAgICAgdmFsIC09IGpRdWVyeS5jc3MoZWxlbSwgJ3BhZGRpbmcnICsgY3NzRXhwYW5kW2ldLCB0cnVlLCBzdHlsZXMpOwogICAgICAgIH0KICAgICAgICAvLyBhdCB0aGlzIHBvaW50LCBleHRyYSBpc24ndCBib3JkZXIgbm9yIG1hcmdpbiwgc28gcmVtb3ZlIGJvcmRlcgogICAgICAgIGlmIChleHRyYSAhPT0gJ21hcmdpbicpIHsKICAgICAgICAgIHZhbCAtPSBqUXVlcnkuY3NzKGVsZW0sICdib3JkZXInICsgY3NzRXhwYW5kW2ldICsgJ1dpZHRoJywgdHJ1ZSwgc3R5bGVzKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCwgc28gYWRkIHBhZGRpbmcKICAgICAgICB2YWwgKz0galF1ZXJ5LmNzcyhlbGVtLCAncGFkZGluZycgKyBjc3NFeHBhbmRbaV0sIHRydWUsIHN0eWxlcyk7CiAgICAgICAgLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCBub3IgcGFkZGluZywgc28gYWRkIGJvcmRlcgogICAgICAgIGlmIChleHRyYSAhPT0gJ3BhZGRpbmcnKSB7CiAgICAgICAgICB2YWwgKz0galF1ZXJ5LmNzcyhlbGVtLCAnYm9yZGVyJyArIGNzc0V4cGFuZFtpXSArICdXaWR0aCcsIHRydWUsIHN0eWxlcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdmFsOwogIH0KICBmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KGVsZW0sIG5hbWUsIGV4dHJhKSB7CiAgICAvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQogICAgdmFyIHZhbHVlSXNCb3JkZXJCb3ggPSB0cnVlLCB2YWwgPSBuYW1lID09PSAnd2lkdGgnID8gZWxlbS5vZmZzZXRXaWR0aCA6IGVsZW0ub2Zmc2V0SGVpZ2h0LCBzdHlsZXMgPSBnZXRTdHlsZXMoZWxlbSksIGlzQm9yZGVyQm94ID0galF1ZXJ5LmNzcyhlbGVtLCAnYm94U2l6aW5nJywgZmFsc2UsIHN0eWxlcykgPT09ICdib3JkZXItYm94JzsKICAgIC8vIHNvbWUgbm9uLWh0bWwgZWxlbWVudHMgcmV0dXJuIHVuZGVmaW5lZCBmb3Igb2Zmc2V0V2lkdGgsIHNvIGNoZWNrIGZvciBudWxsL3VuZGVmaW5lZAogICAgLy8gc3ZnIC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjQ5Mjg1CiAgICAvLyBNYXRoTUwgLSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD00OTE2NjgKICAgIGlmICh2YWwgPD0gMCB8fCB2YWwgPT0gbnVsbCkgewogICAgICAvLyBGYWxsIGJhY2sgdG8gY29tcHV0ZWQgdGhlbiB1bmNvbXB1dGVkIGNzcyBpZiBuZWNlc3NhcnkKICAgICAgdmFsID0gY3VyQ1NTKGVsZW0sIG5hbWUsIHN0eWxlcyk7CiAgICAgIGlmICh2YWwgPCAwIHx8IHZhbCA9PSBudWxsKSB7CiAgICAgICAgdmFsID0gZWxlbS5zdHlsZVtuYW1lXTsKICAgICAgfQogICAgICAvLyBDb21wdXRlZCB1bml0IGlzIG5vdCBwaXhlbHMuIFN0b3AgaGVyZSBhbmQgcmV0dXJuLgogICAgICBpZiAocm51bW5vbnB4LnRlc3QodmFsKSkgewogICAgICAgIHJldHVybiB2YWw7CiAgICAgIH0KICAgICAgLy8gd2UgbmVlZCB0aGUgY2hlY2sgZm9yIHN0eWxlIGluIGNhc2UgYSBicm93c2VyIHdoaWNoIHJldHVybnMgdW5yZWxpYWJsZSB2YWx1ZXMKICAgICAgLy8gZm9yIGdldENvbXB1dGVkU3R5bGUgc2lsZW50bHkgZmFsbHMgYmFjayB0byB0aGUgcmVsaWFibGUgZWxlbS5zdHlsZQogICAgICB2YWx1ZUlzQm9yZGVyQm94ID0gaXNCb3JkZXJCb3ggJiYgKHN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUoKSB8fCB2YWwgPT09IGVsZW0uc3R5bGVbbmFtZV0pOwogICAgICAvLyBOb3JtYWxpemUgIiIsIGF1dG8sIGFuZCBwcmVwYXJlIGZvciBleHRyYQogICAgICB2YWwgPSBwYXJzZUZsb2F0KHZhbCkgfHwgMDsKICAgIH0KICAgIC8vIHVzZSB0aGUgYWN0aXZlIGJveC1zaXppbmcgbW9kZWwgdG8gYWRkL3N1YnRyYWN0IGlycmVsZXZhbnQgc3R5bGVzCiAgICByZXR1cm4gdmFsICsgYXVnbWVudFdpZHRoT3JIZWlnaHQoZWxlbSwgbmFtZSwgZXh0cmEgfHwgKGlzQm9yZGVyQm94ID8gJ2JvcmRlcicgOiAnY29udGVudCcpLCB2YWx1ZUlzQm9yZGVyQm94LCBzdHlsZXMpICsgJ3B4JzsKICB9CiAgZnVuY3Rpb24gc2hvd0hpZGUoZWxlbWVudHMsIHNob3cpIHsKICAgIHZhciBkaXNwbGF5LCBlbGVtLCBoaWRkZW4sIHZhbHVlcyA9IFtdLCBpbmRleCA9IDAsIGxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBlbGVtID0gZWxlbWVudHNbaW5kZXhdOwogICAgICBpZiAoIWVsZW0uc3R5bGUpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICB2YWx1ZXNbaW5kZXhdID0gZGF0YV9wcml2LmdldChlbGVtLCAnb2xkZGlzcGxheScpOwogICAgICBkaXNwbGF5ID0gZWxlbS5zdHlsZS5kaXNwbGF5OwogICAgICBpZiAoc2hvdykgewogICAgICAgIC8vIFJlc2V0IHRoZSBpbmxpbmUgZGlzcGxheSBvZiB0aGlzIGVsZW1lbnQgdG8gbGVhcm4gaWYgaXQgaXMKICAgICAgICAvLyBiZWluZyBoaWRkZW4gYnkgY2FzY2FkZWQgcnVsZXMgb3Igbm90CiAgICAgICAgaWYgKCF2YWx1ZXNbaW5kZXhdICYmIGRpc3BsYXkgPT09ICdub25lJykgewogICAgICAgICAgZWxlbS5zdHlsZS5kaXNwbGF5ID0gJyc7CiAgICAgICAgfQogICAgICAgIC8vIFNldCBlbGVtZW50cyB3aGljaCBoYXZlIGJlZW4gb3ZlcnJpZGRlbiB3aXRoIGRpc3BsYXk6IG5vbmUKICAgICAgICAvLyBpbiBhIHN0eWxlc2hlZXQgdG8gd2hhdGV2ZXIgdGhlIGRlZmF1bHQgYnJvd3NlciBzdHlsZSBpcwogICAgICAgIC8vIGZvciBzdWNoIGFuIGVsZW1lbnQKICAgICAgICBpZiAoZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAnJyAmJiBpc0hpZGRlbihlbGVtKSkgewogICAgICAgICAgdmFsdWVzW2luZGV4XSA9IGRhdGFfcHJpdi5hY2Nlc3MoZWxlbSwgJ29sZGRpc3BsYXknLCBkZWZhdWx0RGlzcGxheShlbGVtLm5vZGVOYW1lKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGhpZGRlbiA9IGlzSGlkZGVuKGVsZW0pOwogICAgICAgIGlmIChkaXNwbGF5ICE9PSAnbm9uZScgfHwgIWhpZGRlbikgewogICAgICAgICAgZGF0YV9wcml2LnNldChlbGVtLCAnb2xkZGlzcGxheScsIGhpZGRlbiA/IGRpc3BsYXkgOiBqUXVlcnkuY3NzKGVsZW0sICdkaXNwbGF5JykpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gU2V0IHRoZSBkaXNwbGF5IG9mIG1vc3Qgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AKICAgIC8vIHRvIGF2b2lkIHRoZSBjb25zdGFudCByZWZsb3cKICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBlbGVtID0gZWxlbWVudHNbaW5kZXhdOwogICAgICBpZiAoIWVsZW0uc3R5bGUpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoIXNob3cgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZScgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAnJykgewogICAgICAgIGVsZW0uc3R5bGUuZGlzcGxheSA9IHNob3cgPyB2YWx1ZXNbaW5kZXhdIHx8ICcnIDogJ25vbmUnOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZWxlbWVudHM7CiAgfQogIGpRdWVyeS5leHRlbmQoewogICAgLy8gQWRkIGluIHN0eWxlIHByb3BlcnR5IGhvb2tzIGZvciBvdmVycmlkaW5nIHRoZSBkZWZhdWx0CiAgICAvLyBiZWhhdmlvciBvZiBnZXR0aW5nIGFuZCBzZXR0aW5nIGEgc3R5bGUgcHJvcGVydHkKICAgIGNzc0hvb2tzOiB7CiAgICAgIG9wYWNpdHk6IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCkgewogICAgICAgICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgICAgICAgIC8vIFdlIHNob3VsZCBhbHdheXMgZ2V0IGEgbnVtYmVyIGJhY2sgZnJvbSBvcGFjaXR5CiAgICAgICAgICAgIHZhciByZXQgPSBjdXJDU1MoZWxlbSwgJ29wYWNpdHknKTsKICAgICAgICAgICAgcmV0dXJuIHJldCA9PT0gJycgPyAnMScgOiByZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gRG9uJ3QgYXV0b21hdGljYWxseSBhZGQgInB4IiB0byB0aGVzZSBwb3NzaWJseS11bml0bGVzcyBwcm9wZXJ0aWVzCiAgICBjc3NOdW1iZXI6IHsKICAgICAgJ2NvbHVtbkNvdW50JzogdHJ1ZSwKICAgICAgJ2ZpbGxPcGFjaXR5JzogdHJ1ZSwKICAgICAgJ2ZsZXhHcm93JzogdHJ1ZSwKICAgICAgJ2ZsZXhTaHJpbmsnOiB0cnVlLAogICAgICAnZm9udFdlaWdodCc6IHRydWUsCiAgICAgICdsaW5lSGVpZ2h0JzogdHJ1ZSwKICAgICAgJ29wYWNpdHknOiB0cnVlLAogICAgICAnb3JkZXInOiB0cnVlLAogICAgICAnb3JwaGFucyc6IHRydWUsCiAgICAgICd3aWRvd3MnOiB0cnVlLAogICAgICAnekluZGV4JzogdHJ1ZSwKICAgICAgJ3pvb20nOiB0cnVlCiAgICB9LAogICAgLy8gQWRkIGluIHByb3BlcnRpZXMgd2hvc2UgbmFtZXMgeW91IHdpc2ggdG8gZml4IGJlZm9yZQogICAgLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQogICAgY3NzUHJvcHM6IHsKICAgICAgLy8gbm9ybWFsaXplIGZsb2F0IGNzcyBwcm9wZXJ0eQogICAgICAnZmxvYXQnOiAnY3NzRmxvYXQnCiAgICB9LAogICAgLy8gR2V0IGFuZCBzZXQgdGhlIHN0eWxlIHByb3BlcnR5IG9uIGEgRE9NIE5vZGUKICAgIHN0eWxlOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgdmFsdWUsIGV4dHJhKSB7CiAgICAgIC8vIERvbid0IHNldCBzdHlsZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwogICAgICBpZiAoIWVsZW0gfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4IHx8ICFlbGVtLnN0eWxlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQogICAgICB2YXIgcmV0LCB0eXBlLCBob29rcywgb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKG5hbWUpLCBzdHlsZSA9IGVsZW0uc3R5bGU7CiAgICAgIG5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbb3JpZ05hbWVdIHx8IChqUXVlcnkuY3NzUHJvcHNbb3JpZ05hbWVdID0gdmVuZG9yUHJvcE5hbWUoc3R5bGUsIG9yaWdOYW1lKSk7CiAgICAgIC8vIGdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24KICAgICAgLy8gZm9sbG93ZWQgYnkgdGhlIHVucHJlZml4ZWQgdmVyc2lvbgogICAgICBob29rcyA9IGpRdWVyeS5jc3NIb29rc1tuYW1lXSB8fCBqUXVlcnkuY3NzSG9va3Nbb3JpZ05hbWVdOwogICAgICAvLyBDaGVjayBpZiB3ZSdyZSBzZXR0aW5nIGEgdmFsdWUKICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0eXBlID0gdHlwZW9mIHZhbHVlOwogICAgICAgIC8vIGNvbnZlcnQgcmVsYXRpdmUgbnVtYmVyIHN0cmluZ3MgKCs9IG9yIC09KSB0byByZWxhdGl2ZSBudW1iZXJzLiAjNzM0NQogICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJyAmJiAocmV0ID0gcnJlbE51bS5leGVjKHZhbHVlKSkpIHsKICAgICAgICAgIHZhbHVlID0gKHJldFsxXSArIDEpICogcmV0WzJdICsgcGFyc2VGbG9hdChqUXVlcnkuY3NzKGVsZW0sIG5hbWUpKTsKICAgICAgICAgIC8vIEZpeGVzIGJ1ZyAjOTIzNwogICAgICAgICAgdHlwZSA9ICdudW1iZXInOwogICAgICAgIH0KICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBudWxsIGFuZCBOYU4gdmFsdWVzIGFyZW4ndCBzZXQuIFNlZTogIzcxMTYKICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gSWYgYSBudW1iZXIgd2FzIHBhc3NlZCBpbiwgYWRkICdweCcgdG8gdGhlIChleGNlcHQgZm9yIGNlcnRhaW4gQ1NTIHByb3BlcnRpZXMpCiAgICAgICAgaWYgKHR5cGUgPT09ICdudW1iZXInICYmICFqUXVlcnkuY3NzTnVtYmVyW29yaWdOYW1lXSkgewogICAgICAgICAgdmFsdWUgKz0gJ3B4JzsKICAgICAgICB9CiAgICAgICAgLy8gRml4ZXMgIzg5MDgsIGl0IGNhbiBiZSBkb25lIG1vcmUgY29ycmVjdGx5IGJ5IHNwZWNpZnlpbmcgc2V0dGVycyBpbiBjc3NIb29rcywKICAgICAgICAvLyBidXQgaXQgd291bGQgbWVhbiB0byBkZWZpbmUgZWlnaHQgKGZvciBldmVyeSBwcm9ibGVtYXRpYyBwcm9wZXJ0eSkgaWRlbnRpY2FsIGZ1bmN0aW9ucwogICAgICAgIGlmICghc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgJiYgdmFsdWUgPT09ICcnICYmIG5hbWUuaW5kZXhPZignYmFja2dyb3VuZCcpID09PSAwKSB7CiAgICAgICAgICBzdHlsZVtuYW1lXSA9ICdpbmhlcml0JzsKICAgICAgICB9CiAgICAgICAgLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCwgdXNlIHRoYXQgdmFsdWUsIG90aGVyd2lzZSBqdXN0IHNldCB0aGUgc3BlY2lmaWVkIHZhbHVlCiAgICAgICAgaWYgKCFob29rcyB8fCAhKCdzZXQnIGluIGhvb2tzKSB8fCAodmFsdWUgPSBob29rcy5zZXQoZWxlbSwgdmFsdWUsIGV4dHJhKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIG5vbi1jb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICAgICAgaWYgKGhvb2tzICYmICdnZXQnIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgZmFsc2UsIGV4dHJhKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgLy8gT3RoZXJ3aXNlIGp1c3QgZ2V0IHRoZSB2YWx1ZSBmcm9tIHRoZSBzdHlsZSBvYmplY3QKICAgICAgICByZXR1cm4gc3R5bGVbbmFtZV07CiAgICAgIH0KICAgIH0sCiAgICBjc3M6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBleHRyYSwgc3R5bGVzKSB7CiAgICAgIHZhciB2YWwsIG51bSwgaG9va3MsIG9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZShuYW1lKTsKICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lCiAgICAgIG5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbb3JpZ05hbWVdIHx8IChqUXVlcnkuY3NzUHJvcHNbb3JpZ05hbWVdID0gdmVuZG9yUHJvcE5hbWUoZWxlbS5zdHlsZSwgb3JpZ05hbWUpKTsKICAgICAgLy8gZ2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbgogICAgICAvLyBmb2xsb3dlZCBieSB0aGUgdW5wcmVmaXhlZCB2ZXJzaW9uCiAgICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzW25hbWVdIHx8IGpRdWVyeS5jc3NIb29rc1tvcmlnTmFtZV07CiAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICAgIGlmIChob29rcyAmJiAnZ2V0JyBpbiBob29rcykgewogICAgICAgIHZhbCA9IGhvb2tzLmdldChlbGVtLCB0cnVlLCBleHRyYSk7CiAgICAgIH0KICAgICAgLy8gT3RoZXJ3aXNlLCBpZiBhIHdheSB0byBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGV4aXN0cywgdXNlIHRoYXQKICAgICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFsID0gY3VyQ1NTKGVsZW0sIG5hbWUsIHN0eWxlcyk7CiAgICAgIH0KICAgICAgLy9jb252ZXJ0ICJub3JtYWwiIHRvIGNvbXB1dGVkIHZhbHVlCiAgICAgIGlmICh2YWwgPT09ICdub3JtYWwnICYmIG5hbWUgaW4gY3NzTm9ybWFsVHJhbnNmb3JtKSB7CiAgICAgICAgdmFsID0gY3NzTm9ybWFsVHJhbnNmb3JtW25hbWVdOwogICAgICB9CiAgICAgIC8vIFJldHVybiwgY29udmVydGluZyB0byBudW1iZXIgaWYgZm9yY2VkIG9yIGEgcXVhbGlmaWVyIHdhcyBwcm92aWRlZCBhbmQgdmFsIGxvb2tzIG51bWVyaWMKICAgICAgaWYgKGV4dHJhID09PSAnJyB8fCBleHRyYSkgewogICAgICAgIG51bSA9IHBhcnNlRmxvYXQodmFsKTsKICAgICAgICByZXR1cm4gZXh0cmEgPT09IHRydWUgfHwgalF1ZXJ5LmlzTnVtZXJpYyhudW0pID8gbnVtIHx8IDAgOiB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbDsKICAgIH0KICB9KTsKICBqUXVlcnkuZWFjaChbCiAgICAnaGVpZ2h0JywKICAgICd3aWR0aCcKICBdLCBmdW5jdGlvbiAoaSwgbmFtZSkgewogICAgalF1ZXJ5LmNzc0hvb2tzW25hbWVdID0gewogICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCwgZXh0cmEpIHsKICAgICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICAgIC8vIGNlcnRhaW4gZWxlbWVudHMgY2FuIGhhdmUgZGltZW5zaW9uIGluZm8gaWYgd2UgaW52aXNpYmx5IHNob3cgdGhlbQogICAgICAgICAgLy8gaG93ZXZlciwgaXQgbXVzdCBoYXZlIGEgY3VycmVudCBkaXNwbGF5IHN0eWxlIHRoYXQgd291bGQgYmVuZWZpdCBmcm9tIHRoaXMKICAgICAgICAgIHJldHVybiByZGlzcGxheXN3YXAudGVzdChqUXVlcnkuY3NzKGVsZW0sICdkaXNwbGF5JykpICYmIGVsZW0ub2Zmc2V0V2lkdGggPT09IDAgPyBqUXVlcnkuc3dhcChlbGVtLCBjc3NTaG93LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRXaWR0aE9ySGVpZ2h0KGVsZW0sIG5hbWUsIGV4dHJhKTsKICAgICAgICAgIH0pIDogZ2V0V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSwgZXh0cmEpIHsKICAgICAgICB2YXIgc3R5bGVzID0gZXh0cmEgJiYgZ2V0U3R5bGVzKGVsZW0pOwogICAgICAgIHJldHVybiBzZXRQb3NpdGl2ZU51bWJlcihlbGVtLCB2YWx1ZSwgZXh0cmEgPyBhdWdtZW50V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSwgalF1ZXJ5LmNzcyhlbGVtLCAnYm94U2l6aW5nJywgZmFsc2UsIHN0eWxlcykgPT09ICdib3JkZXItYm94Jywgc3R5bGVzKSA6IDApOwogICAgICB9CiAgICB9OwogIH0pOwogIC8vIFN1cHBvcnQ6IEFuZHJvaWQgMi4zCiAgalF1ZXJ5LmNzc0hvb2tzLm1hcmdpblJpZ2h0ID0gYWRkR2V0SG9va0lmKHN1cHBvcnQucmVsaWFibGVNYXJnaW5SaWdodCwgZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkKSB7CiAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CiAgICAgIC8vIFdvcmsgYXJvdW5kIGJ5IHRlbXBvcmFyaWx5IHNldHRpbmcgZWxlbWVudCBkaXNwbGF5IHRvIGlubGluZS1ibG9jawogICAgICByZXR1cm4galF1ZXJ5LnN3YXAoZWxlbSwgeyAnZGlzcGxheSc6ICdpbmxpbmUtYmxvY2snIH0sIGN1ckNTUywgWwogICAgICAgIGVsZW0sCiAgICAgICAgJ21hcmdpblJpZ2h0JwogICAgICBdKTsKICAgIH0KICB9KTsKICAvLyBUaGVzZSBob29rcyBhcmUgdXNlZCBieSBhbmltYXRlIHRvIGV4cGFuZCBwcm9wZXJ0aWVzCiAgalF1ZXJ5LmVhY2goewogICAgbWFyZ2luOiAnJywKICAgIHBhZGRpbmc6ICcnLAogICAgYm9yZGVyOiAnV2lkdGgnCiAgfSwgZnVuY3Rpb24gKHByZWZpeCwgc3VmZml4KSB7CiAgICBqUXVlcnkuY3NzSG9va3NbcHJlZml4ICsgc3VmZml4XSA9IHsKICAgICAgZXhwYW5kOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgaSA9IDAsIGV4cGFuZGVkID0ge30sCiAgICAgICAgICAvLyBhc3N1bWVzIGEgc2luZ2xlIG51bWJlciBpZiBub3QgYSBzdHJpbmcKICAgICAgICAgIHBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHZhbHVlLnNwbGl0KCcgJykgOiBbdmFsdWVdOwogICAgICAgIGZvciAoOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgICBleHBhbmRlZFtwcmVmaXggKyBjc3NFeHBhbmRbaV0gKyBzdWZmaXhdID0gcGFydHNbaV0gfHwgcGFydHNbaSAtIDJdIHx8IHBhcnRzWzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwYW5kZWQ7CiAgICAgIH0KICAgIH07CiAgICBpZiAoIXJtYXJnaW4udGVzdChwcmVmaXgpKSB7CiAgICAgIGpRdWVyeS5jc3NIb29rc1twcmVmaXggKyBzdWZmaXhdLnNldCA9IHNldFBvc2l0aXZlTnVtYmVyOwogICAgfQogIH0pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgY3NzOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgdmFsdWUpIHsKICAgICAgICB2YXIgc3R5bGVzLCBsZW4sIG1hcCA9IHt9LCBpID0gMDsKICAgICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgIHN0eWxlcyA9IGdldFN0eWxlcyhlbGVtKTsKICAgICAgICAgIGxlbiA9IG5hbWUubGVuZ3RoOwogICAgICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBtYXBbbmFtZVtpXV0gPSBqUXVlcnkuY3NzKGVsZW0sIG5hbWVbaV0sIGZhbHNlLCBzdHlsZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPyBqUXVlcnkuc3R5bGUoZWxlbSwgbmFtZSwgdmFsdWUpIDogalF1ZXJ5LmNzcyhlbGVtLCBuYW1lKTsKICAgICAgfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxKTsKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzaG93SGlkZSh0aGlzLCB0cnVlKTsKICAgIH0sCiAgICBoaWRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzaG93SGlkZSh0aGlzKTsKICAgIH0sCiAgICB0b2dnbGU6IGZ1bmN0aW9uIChzdGF0ZSkgewogICAgICBpZiAodHlwZW9mIHN0YXRlID09PSAnYm9vbGVhbicpIHsKICAgICAgICByZXR1cm4gc3RhdGUgPyB0aGlzLnNob3coKSA6IHRoaXMuaGlkZSgpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChpc0hpZGRlbih0aGlzKSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLnNob3coKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLmhpZGUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIFR3ZWVuKGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nKSB7CiAgICByZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nKTsKICB9CiAgalF1ZXJ5LlR3ZWVuID0gVHdlZW47CiAgVHdlZW4ucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IFR3ZWVuLAogICAgaW5pdDogZnVuY3Rpb24gKGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0KSB7CiAgICAgIHRoaXMuZWxlbSA9IGVsZW07CiAgICAgIHRoaXMucHJvcCA9IHByb3A7CiAgICAgIHRoaXMuZWFzaW5nID0gZWFzaW5nIHx8ICdzd2luZyc7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCk7CiAgICAgIHRoaXMuZW5kID0gZW5kOwogICAgICB0aGlzLnVuaXQgPSB1bml0IHx8IChqUXVlcnkuY3NzTnVtYmVyW3Byb3BdID8gJycgOiAncHgnKTsKICAgIH0sCiAgICBjdXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgIHJldHVybiBob29rcyAmJiBob29rcy5nZXQgPyBob29rcy5nZXQodGhpcykgOiBUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KHRoaXMpOwogICAgfSwKICAgIHJ1bjogZnVuY3Rpb24gKHBlcmNlbnQpIHsKICAgICAgdmFyIGVhc2VkLCBob29rcyA9IFR3ZWVuLnByb3BIb29rc1t0aGlzLnByb3BdOwogICAgICBpZiAodGhpcy5vcHRpb25zLmR1cmF0aW9uKSB7CiAgICAgICAgdGhpcy5wb3MgPSBlYXNlZCA9IGpRdWVyeS5lYXNpbmdbdGhpcy5lYXNpbmddKHBlcmNlbnQsIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIHBlcmNlbnQsIDAsIDEsIHRoaXMub3B0aW9ucy5kdXJhdGlvbik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wb3MgPSBlYXNlZCA9IHBlcmNlbnQ7CiAgICAgIH0KICAgICAgdGhpcy5ub3cgPSAodGhpcy5lbmQgLSB0aGlzLnN0YXJ0KSAqIGVhc2VkICsgdGhpcy5zdGFydDsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5zdGVwKSB7CiAgICAgICAgdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCh0aGlzLmVsZW0sIHRoaXMubm93LCB0aGlzKTsKICAgICAgfQogICAgICBpZiAoaG9va3MgJiYgaG9va3Muc2V0KSB7CiAgICAgICAgaG9va3Muc2V0KHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIFR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5zZXQodGhpcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfTsKICBUd2Vlbi5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBUd2Vlbi5wcm90b3R5cGU7CiAgVHdlZW4ucHJvcEhvb2tzID0gewogICAgX2RlZmF1bHQ6IHsKICAgICAgZ2V0OiBmdW5jdGlvbiAodHdlZW4pIHsKICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgIGlmICh0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdICE9IG51bGwgJiYgKCF0d2Vlbi5lbGVtLnN0eWxlIHx8IHR3ZWVuLmVsZW0uc3R5bGVbdHdlZW4ucHJvcF0gPT0gbnVsbCkpIHsKICAgICAgICAgIHJldHVybiB0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdOwogICAgICAgIH0KICAgICAgICAvLyBwYXNzaW5nIGFuIGVtcHR5IHN0cmluZyBhcyBhIDNyZCBwYXJhbWV0ZXIgdG8gLmNzcyB3aWxsIGF1dG9tYXRpY2FsbHkKICAgICAgICAvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzCiAgICAgICAgLy8gc28sIHNpbXBsZSB2YWx1ZXMgc3VjaCBhcyAiMTBweCIgYXJlIHBhcnNlZCB0byBGbG9hdC4KICAgICAgICAvLyBjb21wbGV4IHZhbHVlcyBzdWNoIGFzICJyb3RhdGUoMXJhZCkiIGFyZSByZXR1cm5lZCBhcyBpcy4KICAgICAgICByZXN1bHQgPSBqUXVlcnkuY3NzKHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsICcnKTsKICAgICAgICAvLyBFbXB0eSBzdHJpbmdzLCBudWxsLCB1bmRlZmluZWQgYW5kICJhdXRvIiBhcmUgY29udmVydGVkIHRvIDAuCiAgICAgICAgcmV0dXJuICFyZXN1bHQgfHwgcmVzdWx0ID09PSAnYXV0bycgPyAwIDogcmVzdWx0OwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uICh0d2VlbikgewogICAgICAgIC8vIHVzZSBzdGVwIGhvb2sgZm9yIGJhY2sgY29tcGF0IC0gdXNlIGNzc0hvb2sgaWYgaXRzIHRoZXJlIC0gdXNlIC5zdHlsZSBpZiBpdHMKICAgICAgICAvLyBhdmFpbGFibGUgYW5kIHVzZSBwbGFpbiBwcm9wZXJ0aWVzIHdoZXJlIGF2YWlsYWJsZQogICAgICAgIGlmIChqUXVlcnkuZnguc3RlcFt0d2Vlbi5wcm9wXSkgewogICAgICAgICAgalF1ZXJ5LmZ4LnN0ZXBbdHdlZW4ucHJvcF0odHdlZW4pOwogICAgICAgIH0gZWxzZSBpZiAodHdlZW4uZWxlbS5zdHlsZSAmJiAodHdlZW4uZWxlbS5zdHlsZVtqUXVlcnkuY3NzUHJvcHNbdHdlZW4ucHJvcF1dICE9IG51bGwgfHwgalF1ZXJ5LmNzc0hvb2tzW3R3ZWVuLnByb3BdKSkgewogICAgICAgICAgalF1ZXJ5LnN0eWxlKHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsIHR3ZWVuLm5vdyArIHR3ZWVuLnVuaXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdID0gdHdlZW4ubm93OwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CiAgLy8gU3VwcG9ydDogSUU5CiAgLy8gUGFuaWMgYmFzZWQgYXBwcm9hY2ggdG8gc2V0dGluZyB0aGluZ3Mgb24gZGlzY29ubmVjdGVkIG5vZGVzCiAgVHdlZW4ucHJvcEhvb2tzLnNjcm9sbFRvcCA9IFR3ZWVuLnByb3BIb29rcy5zY3JvbGxMZWZ0ID0gewogICAgc2V0OiBmdW5jdGlvbiAodHdlZW4pIHsKICAgICAgaWYgKHR3ZWVuLmVsZW0ubm9kZVR5cGUgJiYgdHdlZW4uZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgdHdlZW4uZWxlbVt0d2Vlbi5wcm9wXSA9IHR3ZWVuLm5vdzsKICAgICAgfQogICAgfQogIH07CiAgalF1ZXJ5LmVhc2luZyA9IHsKICAgIGxpbmVhcjogZnVuY3Rpb24gKHApIHsKICAgICAgcmV0dXJuIHA7CiAgICB9LAogICAgc3dpbmc6IGZ1bmN0aW9uIChwKSB7CiAgICAgIHJldHVybiAwLjUgLSBNYXRoLmNvcyhwICogTWF0aC5QSSkgLyAyOwogICAgfQogIH07CiAgalF1ZXJ5LmZ4ID0gVHdlZW4ucHJvdG90eXBlLmluaXQ7CiAgLy8gQmFjayBDb21wYXQgPDEuOCBleHRlbnNpb24gcG9pbnQKICBqUXVlcnkuZnguc3RlcCA9IHt9OwogIHZhciBmeE5vdywgdGltZXJJZCwgcmZ4dHlwZXMgPSAvXig/OnRvZ2dsZXxzaG93fGhpZGUpJC8sIHJmeG51bSA9IG5ldyBSZWdFeHAoJ14oPzooWystXSk9fCkoJyArIHBudW0gKyAnKShbYS16JV0qKSQnLCAnaScpLCBycnVuID0gL3F1ZXVlSG9va3MkLywgYW5pbWF0aW9uUHJlZmlsdGVycyA9IFtkZWZhdWx0UHJlZmlsdGVyXSwgdHdlZW5lcnMgPSB7CiAgICAgICcqJzogW2Z1bmN0aW9uIChwcm9wLCB2YWx1ZSkgewogICAgICAgICAgdmFyIHR3ZWVuID0gdGhpcy5jcmVhdGVUd2Vlbihwcm9wLCB2YWx1ZSksIHRhcmdldCA9IHR3ZWVuLmN1cigpLCBwYXJ0cyA9IHJmeG51bS5leGVjKHZhbHVlKSwgdW5pdCA9IHBhcnRzICYmIHBhcnRzWzNdIHx8IChqUXVlcnkuY3NzTnVtYmVyW3Byb3BdID8gJycgOiAncHgnKSwKICAgICAgICAgICAgLy8gU3RhcnRpbmcgdmFsdWUgY29tcHV0YXRpb24gaXMgcmVxdWlyZWQgZm9yIHBvdGVudGlhbCB1bml0IG1pc21hdGNoZXMKICAgICAgICAgICAgc3RhcnQgPSAoalF1ZXJ5LmNzc051bWJlcltwcm9wXSB8fCB1bml0ICE9PSAncHgnICYmICt0YXJnZXQpICYmIHJmeG51bS5leGVjKGpRdWVyeS5jc3ModHdlZW4uZWxlbSwgcHJvcCkpLCBzY2FsZSA9IDEsIG1heEl0ZXJhdGlvbnMgPSAyMDsKICAgICAgICAgIGlmIChzdGFydCAmJiBzdGFydFszXSAhPT0gdW5pdCkgewogICAgICAgICAgICAvLyBUcnVzdCB1bml0cyByZXBvcnRlZCBieSBqUXVlcnkuY3NzCiAgICAgICAgICAgIHVuaXQgPSB1bml0IHx8IHN0YXJ0WzNdOwogICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSB0d2VlbiBwcm9wZXJ0aWVzIGxhdGVyIG9uCiAgICAgICAgICAgIHBhcnRzID0gcGFydHMgfHwgW107CiAgICAgICAgICAgIC8vIEl0ZXJhdGl2ZWx5IGFwcHJveGltYXRlIGZyb20gYSBub256ZXJvIHN0YXJ0aW5nIHBvaW50CiAgICAgICAgICAgIHN0YXJ0ID0gK3RhcmdldCB8fCAxOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgLy8gSWYgcHJldmlvdXMgaXRlcmF0aW9uIHplcm9lZCBvdXQsIGRvdWJsZSB1bnRpbCB3ZSBnZXQgKnNvbWV0aGluZyoKICAgICAgICAgICAgICAvLyBVc2UgYSBzdHJpbmcgZm9yIGRvdWJsaW5nIGZhY3RvciBzbyB3ZSBkb24ndCBhY2NpZGVudGFsbHkgc2VlIHNjYWxlIGFzIHVuY2hhbmdlZCBiZWxvdwogICAgICAgICAgICAgIHNjYWxlID0gc2NhbGUgfHwgJy41JzsKICAgICAgICAgICAgICAvLyBBZGp1c3QgYW5kIGFwcGx5CiAgICAgICAgICAgICAgc3RhcnQgPSBzdGFydCAvIHNjYWxlOwogICAgICAgICAgICAgIGpRdWVyeS5zdHlsZSh0d2Vlbi5lbGVtLCBwcm9wLCBzdGFydCArIHVuaXQpOyAgLy8gVXBkYXRlIHNjYWxlLCB0b2xlcmF0aW5nIHplcm8gb3IgTmFOIGZyb20gdHdlZW4uY3VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFuZCBicmVha2luZyB0aGUgbG9vcCBpZiBzY2FsZSBpcyB1bmNoYW5nZWQgb3IgcGVyZmVjdCwgb3IgaWYgd2UndmUganVzdCBoYWQgZW5vdWdoCiAgICAgICAgICAgIH0gd2hpbGUgKHNjYWxlICE9PSAoc2NhbGUgPSB0d2Vlbi5jdXIoKSAvIHRhcmdldCkgJiYgc2NhbGUgIT09IDEgJiYgLS1tYXhJdGVyYXRpb25zKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFVwZGF0ZSB0d2VlbiBwcm9wZXJ0aWVzCiAgICAgICAgICBpZiAocGFydHMpIHsKICAgICAgICAgICAgc3RhcnQgPSB0d2Vlbi5zdGFydCA9ICtzdGFydCB8fCArdGFyZ2V0IHx8IDA7CiAgICAgICAgICAgIHR3ZWVuLnVuaXQgPSB1bml0OwogICAgICAgICAgICAvLyBJZiBhICs9Ly09IHRva2VuIHdhcyBwcm92aWRlZCwgd2UncmUgZG9pbmcgYSByZWxhdGl2ZSBhbmltYXRpb24KICAgICAgICAgICAgdHdlZW4uZW5kID0gcGFydHNbMV0gPyBzdGFydCArIChwYXJ0c1sxXSArIDEpICogcGFydHNbMl0gOiArcGFydHNbMl07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHdlZW47CiAgICAgICAgfV0KICAgIH07CiAgLy8gQW5pbWF0aW9ucyBjcmVhdGVkIHN5bmNocm9ub3VzbHkgd2lsbCBydW4gc3luY2hyb25vdXNseQogIGZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgewogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGZ4Tm93ID0gdW5kZWZpbmVkOwogICAgfSk7CiAgICByZXR1cm4gZnhOb3cgPSBqUXVlcnkubm93KCk7CiAgfQogIC8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCiAgZnVuY3Rpb24gZ2VuRngodHlwZSwgaW5jbHVkZVdpZHRoKSB7CiAgICB2YXIgd2hpY2gsIGkgPSAwLCBhdHRycyA9IHsgaGVpZ2h0OiB0eXBlIH07CiAgICAvLyBpZiB3ZSBpbmNsdWRlIHdpZHRoLCBzdGVwIHZhbHVlIGlzIDEgdG8gZG8gYWxsIGNzc0V4cGFuZCB2YWx1ZXMsCiAgICAvLyBpZiB3ZSBkb24ndCBpbmNsdWRlIHdpZHRoLCBzdGVwIHZhbHVlIGlzIDIgdG8gc2tpcCBvdmVyIExlZnQgYW5kIFJpZ2h0CiAgICBpbmNsdWRlV2lkdGggPSBpbmNsdWRlV2lkdGggPyAxIDogMDsKICAgIGZvciAoOyBpIDwgNDsgaSArPSAyIC0gaW5jbHVkZVdpZHRoKSB7CiAgICAgIHdoaWNoID0gY3NzRXhwYW5kW2ldOwogICAgICBhdHRyc1snbWFyZ2luJyArIHdoaWNoXSA9IGF0dHJzWydwYWRkaW5nJyArIHdoaWNoXSA9IHR5cGU7CiAgICB9CiAgICBpZiAoaW5jbHVkZVdpZHRoKSB7CiAgICAgIGF0dHJzLm9wYWNpdHkgPSBhdHRycy53aWR0aCA9IHR5cGU7CiAgICB9CiAgICByZXR1cm4gYXR0cnM7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVR3ZWVuKHZhbHVlLCBwcm9wLCBhbmltYXRpb24pIHsKICAgIHZhciB0d2VlbiwgY29sbGVjdGlvbiA9ICh0d2VlbmVyc1twcm9wXSB8fCBbXSkuY29uY2F0KHR3ZWVuZXJzWycqJ10pLCBpbmRleCA9IDAsIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGlmICh0d2VlbiA9IGNvbGxlY3Rpb25baW5kZXhdLmNhbGwoYW5pbWF0aW9uLCBwcm9wLCB2YWx1ZSkpIHsKICAgICAgICAvLyB3ZSdyZSBkb25lIHdpdGggdGhpcyBwcm9wZXJ0eQogICAgICAgIHJldHVybiB0d2VlbjsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKGVsZW0sIHByb3BzLCBvcHRzKSB7CiAgICAvKiBqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICB2YXIgcHJvcCwgdmFsdWUsIHRvZ2dsZSwgdHdlZW4sIGhvb2tzLCBvbGRmaXJlLCBkaXNwbGF5LCBjaGVja0Rpc3BsYXksIGFuaW0gPSB0aGlzLCBvcmlnID0ge30sIHN0eWxlID0gZWxlbS5zdHlsZSwgaGlkZGVuID0gZWxlbS5ub2RlVHlwZSAmJiBpc0hpZGRlbihlbGVtKSwgZGF0YVNob3cgPSBkYXRhX3ByaXYuZ2V0KGVsZW0sICdmeHNob3cnKTsKICAgIC8vIGhhbmRsZSBxdWV1ZTogZmFsc2UgcHJvbWlzZXMKICAgIGlmICghb3B0cy5xdWV1ZSkgewogICAgICBob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyhlbGVtLCAnZngnKTsKICAgICAgaWYgKGhvb2tzLnVucXVldWVkID09IG51bGwpIHsKICAgICAgICBob29rcy51bnF1ZXVlZCA9IDA7CiAgICAgICAgb2xkZmlyZSA9IGhvb2tzLmVtcHR5LmZpcmU7CiAgICAgICAgaG9va3MuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICghaG9va3MudW5xdWV1ZWQpIHsKICAgICAgICAgICAgb2xkZmlyZSgpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgaG9va3MudW5xdWV1ZWQrKzsKICAgICAgYW5pbS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIGRvaW5nIHRoaXMgbWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wbGV0ZSBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkCiAgICAgICAgLy8gYmVmb3JlIHRoaXMgY29tcGxldGVzCiAgICAgICAgYW5pbS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgICAgaG9va3MudW5xdWV1ZWQtLTsKICAgICAgICAgIGlmICghalF1ZXJ5LnF1ZXVlKGVsZW0sICdmeCcpLmxlbmd0aCkgewogICAgICAgICAgICBob29rcy5lbXB0eS5maXJlKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogICAgLy8gaGVpZ2h0L3dpZHRoIG92ZXJmbG93IHBhc3MKICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxICYmICgnaGVpZ2h0JyBpbiBwcm9wcyB8fCAnd2lkdGgnIGluIHByb3BzKSkgewogICAgICAvLyBNYWtlIHN1cmUgdGhhdCBub3RoaW5nIHNuZWFrcyBvdXQKICAgICAgLy8gUmVjb3JkIGFsbCAzIG92ZXJmbG93IGF0dHJpYnV0ZXMgYmVjYXVzZSBJRTktMTAgZG8gbm90CiAgICAgIC8vIGNoYW5nZSB0aGUgb3ZlcmZsb3cgYXR0cmlidXRlIHdoZW4gb3ZlcmZsb3dYIGFuZAogICAgICAvLyBvdmVyZmxvd1kgYXJlIHNldCB0byB0aGUgc2FtZSB2YWx1ZQogICAgICBvcHRzLm92ZXJmbG93ID0gWwogICAgICAgIHN0eWxlLm92ZXJmbG93LAogICAgICAgIHN0eWxlLm92ZXJmbG93WCwKICAgICAgICBzdHlsZS5vdmVyZmxvd1kKICAgICAgXTsKICAgICAgLy8gU2V0IGRpc3BsYXkgcHJvcGVydHkgdG8gaW5saW5lLWJsb2NrIGZvciBoZWlnaHQvd2lkdGgKICAgICAgLy8gYW5pbWF0aW9ucyBvbiBpbmxpbmUgZWxlbWVudHMgdGhhdCBhcmUgaGF2aW5nIHdpZHRoL2hlaWdodCBhbmltYXRlZAogICAgICBkaXNwbGF5ID0galF1ZXJ5LmNzcyhlbGVtLCAnZGlzcGxheScpOwogICAgICAvLyBUZXN0IGRlZmF1bHQgZGlzcGxheSBpZiBkaXNwbGF5IGlzIGN1cnJlbnRseSAibm9uZSIKICAgICAgY2hlY2tEaXNwbGF5ID0gZGlzcGxheSA9PT0gJ25vbmUnID8gZGF0YV9wcml2LmdldChlbGVtLCAnb2xkZGlzcGxheScpIHx8IGRlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpIDogZGlzcGxheTsKICAgICAgaWYgKGNoZWNrRGlzcGxheSA9PT0gJ2lubGluZScgJiYgalF1ZXJ5LmNzcyhlbGVtLCAnZmxvYXQnKSA9PT0gJ25vbmUnKSB7CiAgICAgICAgc3R5bGUuZGlzcGxheSA9ICdpbmxpbmUtYmxvY2snOwogICAgICB9CiAgICB9CiAgICBpZiAob3B0cy5vdmVyZmxvdykgewogICAgICBzdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nOwogICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgc3R5bGUub3ZlcmZsb3cgPSBvcHRzLm92ZXJmbG93WzBdOwogICAgICAgIHN0eWxlLm92ZXJmbG93WCA9IG9wdHMub3ZlcmZsb3dbMV07CiAgICAgICAgc3R5bGUub3ZlcmZsb3dZID0gb3B0cy5vdmVyZmxvd1syXTsKICAgICAgfSk7CiAgICB9CiAgICAvLyBzaG93L2hpZGUgcGFzcwogICAgZm9yIChwcm9wIGluIHByb3BzKSB7CiAgICAgIHZhbHVlID0gcHJvcHNbcHJvcF07CiAgICAgIGlmIChyZnh0eXBlcy5leGVjKHZhbHVlKSkgewogICAgICAgIGRlbGV0ZSBwcm9wc1twcm9wXTsKICAgICAgICB0b2dnbGUgPSB0b2dnbGUgfHwgdmFsdWUgPT09ICd0b2dnbGUnOwogICAgICAgIGlmICh2YWx1ZSA9PT0gKGhpZGRlbiA/ICdoaWRlJyA6ICdzaG93JykpIHsKICAgICAgICAgIC8vIElmIHRoZXJlIGlzIGRhdGFTaG93IGxlZnQgb3ZlciBmcm9tIGEgc3RvcHBlZCBoaWRlIG9yIHNob3cgYW5kIHdlIGFyZSBnb2luZyB0byBwcm9jZWVkIHdpdGggc2hvdywgd2Ugc2hvdWxkIHByZXRlbmQgdG8gYmUgaGlkZGVuCiAgICAgICAgICBpZiAodmFsdWUgPT09ICdzaG93JyAmJiBkYXRhU2hvdyAmJiBkYXRhU2hvd1twcm9wXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGhpZGRlbiA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgb3JpZ1twcm9wXSA9IGRhdGFTaG93ICYmIGRhdGFTaG93W3Byb3BdIHx8IGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wKTsgIC8vIEFueSBub24tZnggdmFsdWUgc3RvcHMgdXMgZnJvbSByZXN0b3JpbmcgdGhlIG9yaWdpbmFsIGRpc3BsYXkgdmFsdWUKICAgICAgfSBlbHNlIHsKICAgICAgICBkaXNwbGF5ID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9CiAgICBpZiAoIWpRdWVyeS5pc0VtcHR5T2JqZWN0KG9yaWcpKSB7CiAgICAgIGlmIChkYXRhU2hvdykgewogICAgICAgIGlmICgnaGlkZGVuJyBpbiBkYXRhU2hvdykgewogICAgICAgICAgaGlkZGVuID0gZGF0YVNob3cuaGlkZGVuOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRhU2hvdyA9IGRhdGFfcHJpdi5hY2Nlc3MoZWxlbSwgJ2Z4c2hvdycsIHt9KTsKICAgICAgfQogICAgICAvLyBzdG9yZSBzdGF0ZSBpZiBpdHMgdG9nZ2xlIC0gZW5hYmxlcyAuc3RvcCgpLnRvZ2dsZSgpIHRvICJyZXZlcnNlIgogICAgICBpZiAodG9nZ2xlKSB7CiAgICAgICAgZGF0YVNob3cuaGlkZGVuID0gIWhpZGRlbjsKICAgICAgfQogICAgICBpZiAoaGlkZGVuKSB7CiAgICAgICAgalF1ZXJ5KGVsZW0pLnNob3coKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhbmltLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgalF1ZXJ5KGVsZW0pLmhpZGUoKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBhbmltLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwcm9wOwogICAgICAgIGRhdGFfcHJpdi5yZW1vdmUoZWxlbSwgJ2Z4c2hvdycpOwogICAgICAgIGZvciAocHJvcCBpbiBvcmlnKSB7CiAgICAgICAgICBqUXVlcnkuc3R5bGUoZWxlbSwgcHJvcCwgb3JpZ1twcm9wXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgZm9yIChwcm9wIGluIG9yaWcpIHsKICAgICAgICB0d2VlbiA9IGNyZWF0ZVR3ZWVuKGhpZGRlbiA/IGRhdGFTaG93W3Byb3BdIDogMCwgcHJvcCwgYW5pbSk7CiAgICAgICAgaWYgKCEocHJvcCBpbiBkYXRhU2hvdykpIHsKICAgICAgICAgIGRhdGFTaG93W3Byb3BdID0gdHdlZW4uc3RhcnQ7CiAgICAgICAgICBpZiAoaGlkZGVuKSB7CiAgICAgICAgICAgIHR3ZWVuLmVuZCA9IHR3ZWVuLnN0YXJ0OwogICAgICAgICAgICB0d2Vlbi5zdGFydCA9IHByb3AgPT09ICd3aWR0aCcgfHwgcHJvcCA9PT0gJ2hlaWdodCcgPyAxIDogMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gIC8vIElmIHRoaXMgaXMgYSBub29wIGxpa2UgLmhpZGUoKS5oaWRlKCksIHJlc3RvcmUgYW4gb3ZlcndyaXR0ZW4gZGlzcGxheSB2YWx1ZQogICAgfSBlbHNlIGlmICgoZGlzcGxheSA9PT0gJ25vbmUnID8gZGVmYXVsdERpc3BsYXkoZWxlbS5ub2RlTmFtZSkgOiBkaXNwbGF5KSA9PT0gJ2lubGluZScpIHsKICAgICAgc3R5bGUuZGlzcGxheSA9IGRpc3BsYXk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHByb3BGaWx0ZXIocHJvcHMsIHNwZWNpYWxFYXNpbmcpIHsKICAgIHZhciBpbmRleCwgbmFtZSwgZWFzaW5nLCB2YWx1ZSwgaG9va3M7CiAgICAvLyBjYW1lbENhc2UsIHNwZWNpYWxFYXNpbmcgYW5kIGV4cGFuZCBjc3NIb29rIHBhc3MKICAgIGZvciAoaW5kZXggaW4gcHJvcHMpIHsKICAgICAgbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoaW5kZXgpOwogICAgICBlYXNpbmcgPSBzcGVjaWFsRWFzaW5nW25hbWVdOwogICAgICB2YWx1ZSA9IHByb3BzW2luZGV4XTsKICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIGVhc2luZyA9IHZhbHVlWzFdOwogICAgICAgIHZhbHVlID0gcHJvcHNbaW5kZXhdID0gdmFsdWVbMF07CiAgICAgIH0KICAgICAgaWYgKGluZGV4ICE9PSBuYW1lKSB7CiAgICAgICAgcHJvcHNbbmFtZV0gPSB2YWx1ZTsKICAgICAgICBkZWxldGUgcHJvcHNbaW5kZXhdOwogICAgICB9CiAgICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzW25hbWVdOwogICAgICBpZiAoaG9va3MgJiYgJ2V4cGFuZCcgaW4gaG9va3MpIHsKICAgICAgICB2YWx1ZSA9IGhvb2tzLmV4cGFuZCh2YWx1ZSk7CiAgICAgICAgZGVsZXRlIHByb3BzW25hbWVdOwogICAgICAgIC8vIG5vdCBxdWl0ZSAkLmV4dGVuZCwgdGhpcyB3b250IG92ZXJ3cml0ZSBrZXlzIGFscmVhZHkgcHJlc2VudC4KICAgICAgICAvLyBhbHNvIC0gcmV1c2luZyAnaW5kZXgnIGZyb20gYWJvdmUgYmVjYXVzZSB3ZSBoYXZlIHRoZSBjb3JyZWN0ICJuYW1lIgogICAgICAgIGZvciAoaW5kZXggaW4gdmFsdWUpIHsKICAgICAgICAgIGlmICghKGluZGV4IGluIHByb3BzKSkgewogICAgICAgICAgICBwcm9wc1tpbmRleF0gPSB2YWx1ZVtpbmRleF07CiAgICAgICAgICAgIHNwZWNpYWxFYXNpbmdbaW5kZXhdID0gZWFzaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzcGVjaWFsRWFzaW5nW25hbWVdID0gZWFzaW5nOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIEFuaW1hdGlvbihlbGVtLCBwcm9wZXJ0aWVzLCBvcHRpb25zKSB7CiAgICB2YXIgcmVzdWx0LCBzdG9wcGVkLCBpbmRleCA9IDAsIGxlbmd0aCA9IGFuaW1hdGlvblByZWZpbHRlcnMubGVuZ3RoLCBkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gZG9uJ3QgbWF0Y2ggZWxlbSBpbiB0aGUgOmFuaW1hdGVkIHNlbGVjdG9yCiAgICAgICAgZGVsZXRlIHRpY2suZWxlbTsKICAgICAgfSksIHRpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwgcmVtYWluaW5nID0gTWF0aC5tYXgoMCwgYW5pbWF0aW9uLnN0YXJ0VGltZSArIGFuaW1hdGlvbi5kdXJhdGlvbiAtIGN1cnJlbnRUaW1lKSwKICAgICAgICAgIC8vIGFyY2hhaWMgY3Jhc2ggYnVnIHdvbid0IGFsbG93IHVzIHRvIHVzZSAxIC0gKCAwLjUgfHwgMCApICgjMTI0OTcpCiAgICAgICAgICB0ZW1wID0gcmVtYWluaW5nIC8gYW5pbWF0aW9uLmR1cmF0aW9uIHx8IDAsIHBlcmNlbnQgPSAxIC0gdGVtcCwgaW5kZXggPSAwLCBsZW5ndGggPSBhbmltYXRpb24udHdlZW5zLmxlbmd0aDsKICAgICAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgIGFuaW1hdGlvbi50d2VlbnNbaW5kZXhdLnJ1bihwZXJjZW50KTsKICAgICAgICB9CiAgICAgICAgZGVmZXJyZWQubm90aWZ5V2l0aChlbGVtLCBbCiAgICAgICAgICBhbmltYXRpb24sCiAgICAgICAgICBwZXJjZW50LAogICAgICAgICAgcmVtYWluaW5nCiAgICAgICAgXSk7CiAgICAgICAgaWYgKHBlcmNlbnQgPCAxICYmIGxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIHJlbWFpbmluZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoZWxlbSwgW2FuaW1hdGlvbl0pOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSwgYW5pbWF0aW9uID0gZGVmZXJyZWQucHJvbWlzZSh7CiAgICAgICAgZWxlbTogZWxlbSwKICAgICAgICBwcm9wczogalF1ZXJ5LmV4dGVuZCh7fSwgcHJvcGVydGllcyksCiAgICAgICAgb3B0czogalF1ZXJ5LmV4dGVuZCh0cnVlLCB7IHNwZWNpYWxFYXNpbmc6IHt9IH0sIG9wdGlvbnMpLAogICAgICAgIG9yaWdpbmFsUHJvcGVydGllczogcHJvcGVydGllcywKICAgICAgICBvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgc3RhcnRUaW1lOiBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAogICAgICAgIGR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAogICAgICAgIHR3ZWVuczogW10sCiAgICAgICAgY3JlYXRlVHdlZW46IGZ1bmN0aW9uIChwcm9wLCBlbmQpIHsKICAgICAgICAgIHZhciB0d2VlbiA9IGpRdWVyeS5Ud2VlbihlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nW3Byb3BdIHx8IGFuaW1hdGlvbi5vcHRzLmVhc2luZyk7CiAgICAgICAgICBhbmltYXRpb24udHdlZW5zLnB1c2godHdlZW4pOwogICAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKGdvdG9FbmQpIHsKICAgICAgICAgIHZhciBpbmRleCA9IDAsCiAgICAgICAgICAgIC8vIGlmIHdlIGFyZSBnb2luZyB0byB0aGUgZW5kLCB3ZSB3YW50IHRvIHJ1biBhbGwgdGhlIHR3ZWVucwogICAgICAgICAgICAvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKICAgICAgICAgICAgbGVuZ3RoID0gZ290b0VuZCA/IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoIDogMDsKICAgICAgICAgIGlmIChzdG9wcGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgc3RvcHBlZCA9IHRydWU7CiAgICAgICAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgYW5pbWF0aW9uLnR3ZWVuc1tpbmRleF0ucnVuKDEpOwogICAgICAgICAgfQogICAgICAgICAgLy8gcmVzb2x2ZSB3aGVuIHdlIHBsYXllZCB0aGUgbGFzdCBmcmFtZQogICAgICAgICAgLy8gb3RoZXJ3aXNlLCByZWplY3QKICAgICAgICAgIGlmIChnb3RvRW5kKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKGVsZW0sIFsKICAgICAgICAgICAgICBhbmltYXRpb24sCiAgICAgICAgICAgICAgZ290b0VuZAogICAgICAgICAgICBdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdFdpdGgoZWxlbSwgWwogICAgICAgICAgICAgIGFuaW1hdGlvbiwKICAgICAgICAgICAgICBnb3RvRW5kCiAgICAgICAgICAgIF0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICB9KSwgcHJvcHMgPSBhbmltYXRpb24ucHJvcHM7CiAgICBwcm9wRmlsdGVyKHByb3BzLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nKTsKICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICByZXN1bHQgPSBhbmltYXRpb25QcmVmaWx0ZXJzW2luZGV4XS5jYWxsKGFuaW1hdGlvbiwgZWxlbSwgcHJvcHMsIGFuaW1hdGlvbi5vcHRzKTsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH0KICAgIGpRdWVyeS5tYXAocHJvcHMsIGNyZWF0ZVR3ZWVuLCBhbmltYXRpb24pOwogICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGFuaW1hdGlvbi5vcHRzLnN0YXJ0KSkgewogICAgICBhbmltYXRpb24ub3B0cy5zdGFydC5jYWxsKGVsZW0sIGFuaW1hdGlvbik7CiAgICB9CiAgICBqUXVlcnkuZngudGltZXIoalF1ZXJ5LmV4dGVuZCh0aWNrLCB7CiAgICAgIGVsZW06IGVsZW0sCiAgICAgIGFuaW06IGFuaW1hdGlvbiwKICAgICAgcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlCiAgICB9KSk7CiAgICAvLyBhdHRhY2ggY2FsbGJhY2tzIGZyb20gb3B0aW9ucwogICAgcmV0dXJuIGFuaW1hdGlvbi5wcm9ncmVzcyhhbmltYXRpb24ub3B0cy5wcm9ncmVzcykuZG9uZShhbmltYXRpb24ub3B0cy5kb25lLCBhbmltYXRpb24ub3B0cy5jb21wbGV0ZSkuZmFpbChhbmltYXRpb24ub3B0cy5mYWlsKS5hbHdheXMoYW5pbWF0aW9uLm9wdHMuYWx3YXlzKTsKICB9CiAgalF1ZXJ5LkFuaW1hdGlvbiA9IGpRdWVyeS5leHRlbmQoQW5pbWF0aW9uLCB7CiAgICB0d2VlbmVyOiBmdW5jdGlvbiAocHJvcHMsIGNhbGxiYWNrKSB7CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihwcm9wcykpIHsKICAgICAgICBjYWxsYmFjayA9IHByb3BzOwogICAgICAgIHByb3BzID0gWycqJ107CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvcHMgPSBwcm9wcy5zcGxpdCgnICcpOwogICAgICB9CiAgICAgIHZhciBwcm9wLCBpbmRleCA9IDAsIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKICAgICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgcHJvcCA9IHByb3BzW2luZGV4XTsKICAgICAgICB0d2VlbmVyc1twcm9wXSA9IHR3ZWVuZXJzW3Byb3BdIHx8IFtdOwogICAgICAgIHR3ZWVuZXJzW3Byb3BdLnVuc2hpZnQoY2FsbGJhY2spOwogICAgICB9CiAgICB9LAogICAgcHJlZmlsdGVyOiBmdW5jdGlvbiAoY2FsbGJhY2ssIHByZXBlbmQpIHsKICAgICAgaWYgKHByZXBlbmQpIHsKICAgICAgICBhbmltYXRpb25QcmVmaWx0ZXJzLnVuc2hpZnQoY2FsbGJhY2spOwogICAgICB9IGVsc2UgewogICAgICAgIGFuaW1hdGlvblByZWZpbHRlcnMucHVzaChjYWxsYmFjayk7CiAgICAgIH0KICAgIH0KICB9KTsKICBqUXVlcnkuc3BlZWQgPSBmdW5jdGlvbiAoc3BlZWQsIGVhc2luZywgZm4pIHsKICAgIHZhciBvcHQgPSBzcGVlZCAmJiB0eXBlb2Ygc3BlZWQgPT09ICdvYmplY3QnID8galF1ZXJ5LmV4dGVuZCh7fSwgc3BlZWQpIDogewogICAgICBjb21wbGV0ZTogZm4gfHwgIWZuICYmIGVhc2luZyB8fCBqUXVlcnkuaXNGdW5jdGlvbihzcGVlZCkgJiYgc3BlZWQsCiAgICAgIGR1cmF0aW9uOiBzcGVlZCwKICAgICAgZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmICFqUXVlcnkuaXNGdW5jdGlvbihlYXNpbmcpICYmIGVhc2luZwogICAgfTsKICAgIG9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5vZmYgPyAwIDogdHlwZW9mIG9wdC5kdXJhdGlvbiA9PT0gJ251bWJlcicgPyBvcHQuZHVyYXRpb24gOiBvcHQuZHVyYXRpb24gaW4galF1ZXJ5LmZ4LnNwZWVkcyA/IGpRdWVyeS5meC5zcGVlZHNbb3B0LmR1cmF0aW9uXSA6IGpRdWVyeS5meC5zcGVlZHMuX2RlZmF1bHQ7CiAgICAvLyBub3JtYWxpemUgb3B0LnF1ZXVlIC0gdHJ1ZS91bmRlZmluZWQvbnVsbCAtPiAiZngiCiAgICBpZiAob3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlKSB7CiAgICAgIG9wdC5xdWV1ZSA9ICdmeCc7CiAgICB9CiAgICAvLyBRdWV1ZWluZwogICAgb3B0Lm9sZCA9IG9wdC5jb21wbGV0ZTsKICAgIG9wdC5jb21wbGV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKG9wdC5vbGQpKSB7CiAgICAgICAgb3B0Lm9sZC5jYWxsKHRoaXMpOwogICAgICB9CiAgICAgIGlmIChvcHQucXVldWUpIHsKICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCBvcHQucXVldWUpOwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIG9wdDsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgZmFkZVRvOiBmdW5jdGlvbiAoc3BlZWQsIHRvLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIC8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoaXNIaWRkZW4pLmNzcygnb3BhY2l0eScsIDApLnNob3coKSAgLy8gYW5pbWF0ZSB0byB0aGUgdmFsdWUgc3BlY2lmaWVkCi5lbmQoKS5hbmltYXRlKHsgb3BhY2l0eTogdG8gfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwogICAgfSwKICAgIGFuaW1hdGU6IGZ1bmN0aW9uIChwcm9wLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICB2YXIgZW1wdHkgPSBqUXVlcnkuaXNFbXB0eU9iamVjdChwcm9wKSwgb3B0YWxsID0galF1ZXJ5LnNwZWVkKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSwgZG9BbmltYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBPcGVyYXRlIG9uIGEgY29weSBvZiBwcm9wIHNvIHBlci1wcm9wZXJ0eSBlYXNpbmcgd29uJ3QgYmUgbG9zdAogICAgICAgICAgdmFyIGFuaW0gPSBBbmltYXRpb24odGhpcywgalF1ZXJ5LmV4dGVuZCh7fSwgcHJvcCksIG9wdGFsbCk7CiAgICAgICAgICAvLyBFbXB0eSBhbmltYXRpb25zLCBvciBmaW5pc2hpbmcgcmVzb2x2ZXMgaW1tZWRpYXRlbHkKICAgICAgICAgIGlmIChlbXB0eSB8fCBkYXRhX3ByaXYuZ2V0KHRoaXMsICdmaW5pc2gnKSkgewogICAgICAgICAgICBhbmltLnN0b3AodHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgZG9BbmltYXRpb24uZmluaXNoID0gZG9BbmltYXRpb247CiAgICAgIHJldHVybiBlbXB0eSB8fCBvcHRhbGwucXVldWUgPT09IGZhbHNlID8gdGhpcy5lYWNoKGRvQW5pbWF0aW9uKSA6IHRoaXMucXVldWUob3B0YWxsLnF1ZXVlLCBkb0FuaW1hdGlvbik7CiAgICB9LAogICAgc3RvcDogZnVuY3Rpb24gKHR5cGUsIGNsZWFyUXVldWUsIGdvdG9FbmQpIHsKICAgICAgdmFyIHN0b3BRdWV1ZSA9IGZ1bmN0aW9uIChob29rcykgewogICAgICAgIHZhciBzdG9wID0gaG9va3Muc3RvcDsKICAgICAgICBkZWxldGUgaG9va3Muc3RvcDsKICAgICAgICBzdG9wKGdvdG9FbmQpOwogICAgICB9OwogICAgICBpZiAodHlwZW9mIHR5cGUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgZ290b0VuZCA9IGNsZWFyUXVldWU7CiAgICAgICAgY2xlYXJRdWV1ZSA9IHR5cGU7CiAgICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBpZiAoY2xlYXJRdWV1ZSAmJiB0eXBlICE9PSBmYWxzZSkgewogICAgICAgIHRoaXMucXVldWUodHlwZSB8fCAnZngnLCBbXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRlcXVldWUgPSB0cnVlLCBpbmRleCA9IHR5cGUgIT0gbnVsbCAmJiB0eXBlICsgJ3F1ZXVlSG9va3MnLCB0aW1lcnMgPSBqUXVlcnkudGltZXJzLCBkYXRhID0gZGF0YV9wcml2LmdldCh0aGlzKTsKICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgIGlmIChkYXRhW2luZGV4XSAmJiBkYXRhW2luZGV4XS5zdG9wKSB7CiAgICAgICAgICAgIHN0b3BRdWV1ZShkYXRhW2luZGV4XSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaW5kZXggaW4gZGF0YSkgewogICAgICAgICAgICBpZiAoZGF0YVtpbmRleF0gJiYgZGF0YVtpbmRleF0uc3RvcCAmJiBycnVuLnRlc3QoaW5kZXgpKSB7CiAgICAgICAgICAgICAgc3RvcFF1ZXVlKGRhdGFbaW5kZXhdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTspIHsKICAgICAgICAgIGlmICh0aW1lcnNbaW5kZXhdLmVsZW0gPT09IHRoaXMgJiYgKHR5cGUgPT0gbnVsbCB8fCB0aW1lcnNbaW5kZXhdLnF1ZXVlID09PSB0eXBlKSkgewogICAgICAgICAgICB0aW1lcnNbaW5kZXhdLmFuaW0uc3RvcChnb3RvRW5kKTsKICAgICAgICAgICAgZGVxdWV1ZSA9IGZhbHNlOwogICAgICAgICAgICB0aW1lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gc3RhcnQgdGhlIG5leHQgaW4gdGhlIHF1ZXVlIGlmIHRoZSBsYXN0IHN0ZXAgd2Fzbid0IGZvcmNlZAogICAgICAgIC8vIHRpbWVycyBjdXJyZW50bHkgd2lsbCBjYWxsIHRoZWlyIGNvbXBsZXRlIGNhbGxiYWNrcywgd2hpY2ggd2lsbCBkZXF1ZXVlCiAgICAgICAgLy8gYnV0IG9ubHkgaWYgdGhleSB3ZXJlIGdvdG9FbmQKICAgICAgICBpZiAoZGVxdWV1ZSB8fCAhZ290b0VuZCkgewogICAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgdHlwZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBmaW5pc2g6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIGlmICh0eXBlICE9PSBmYWxzZSkgewogICAgICAgIHR5cGUgPSB0eXBlIHx8ICdmeCc7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGluZGV4LCBkYXRhID0gZGF0YV9wcml2LmdldCh0aGlzKSwgcXVldWUgPSBkYXRhW3R5cGUgKyAncXVldWUnXSwgaG9va3MgPSBkYXRhW3R5cGUgKyAncXVldWVIb29rcyddLCB0aW1lcnMgPSBqUXVlcnkudGltZXJzLCBsZW5ndGggPSBxdWV1ZSA/IHF1ZXVlLmxlbmd0aCA6IDA7CiAgICAgICAgLy8gZW5hYmxlIGZpbmlzaGluZyBmbGFnIG9uIHByaXZhdGUgZGF0YQogICAgICAgIGRhdGEuZmluaXNoID0gdHJ1ZTsKICAgICAgICAvLyBlbXB0eSB0aGUgcXVldWUgZmlyc3QKICAgICAgICBqUXVlcnkucXVldWUodGhpcywgdHlwZSwgW10pOwogICAgICAgIGlmIChob29rcyAmJiBob29rcy5zdG9wKSB7CiAgICAgICAgICBob29rcy5zdG9wLmNhbGwodGhpcywgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIC8vIGxvb2sgZm9yIGFueSBhY3RpdmUgYW5pbWF0aW9ucywgYW5kIGZpbmlzaCB0aGVtCiAgICAgICAgZm9yIChpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07KSB7CiAgICAgICAgICBpZiAodGltZXJzW2luZGV4XS5lbGVtID09PSB0aGlzICYmIHRpbWVyc1tpbmRleF0ucXVldWUgPT09IHR5cGUpIHsKICAgICAgICAgICAgdGltZXJzW2luZGV4XS5hbmltLnN0b3AodHJ1ZSk7CiAgICAgICAgICAgIHRpbWVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBsb29rIGZvciBhbnkgYW5pbWF0aW9ucyBpbiB0aGUgb2xkIHF1ZXVlIGFuZCBmaW5pc2ggdGhlbQogICAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgaWYgKHF1ZXVlW2luZGV4XSAmJiBxdWV1ZVtpbmRleF0uZmluaXNoKSB7CiAgICAgICAgICAgIHF1ZXVlW2luZGV4XS5maW5pc2guY2FsbCh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gdHVybiBvZmYgZmluaXNoaW5nIGZsYWcKICAgICAgICBkZWxldGUgZGF0YS5maW5pc2g7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKFsKICAgICd0b2dnbGUnLAogICAgJ3Nob3cnLAogICAgJ2hpZGUnCiAgXSwgZnVuY3Rpb24gKGksIG5hbWUpIHsKICAgIHZhciBjc3NGbiA9IGpRdWVyeS5mbltuYW1lXTsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICdib29sZWFuJyA/IGNzc0ZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiB0aGlzLmFuaW1hdGUoZ2VuRngobmFtZSwgdHJ1ZSksIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKICAgIH07CiAgfSk7CiAgLy8gR2VuZXJhdGUgc2hvcnRjdXRzIGZvciBjdXN0b20gYW5pbWF0aW9ucwogIGpRdWVyeS5lYWNoKHsKICAgIHNsaWRlRG93bjogZ2VuRngoJ3Nob3cnKSwKICAgIHNsaWRlVXA6IGdlbkZ4KCdoaWRlJyksCiAgICBzbGlkZVRvZ2dsZTogZ2VuRngoJ3RvZ2dsZScpLAogICAgZmFkZUluOiB7IG9wYWNpdHk6ICdzaG93JyB9LAogICAgZmFkZU91dDogeyBvcGFjaXR5OiAnaGlkZScgfSwKICAgIGZhZGVUb2dnbGU6IHsgb3BhY2l0eTogJ3RvZ2dsZScgfQogIH0sIGZ1bmN0aW9uIChuYW1lLCBwcm9wcykgewogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLmFuaW1hdGUocHJvcHMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKICAgIH07CiAgfSk7CiAgalF1ZXJ5LnRpbWVycyA9IFtdOwogIGpRdWVyeS5meC50aWNrID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHRpbWVyLCBpID0gMCwgdGltZXJzID0galF1ZXJ5LnRpbWVyczsKICAgIGZ4Tm93ID0galF1ZXJ5Lm5vdygpOwogICAgZm9yICg7IGkgPCB0aW1lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgdGltZXIgPSB0aW1lcnNbaV07CiAgICAgIC8vIENoZWNrcyB0aGUgdGltZXIgaGFzIG5vdCBhbHJlYWR5IGJlZW4gcmVtb3ZlZAogICAgICBpZiAoIXRpbWVyKCkgJiYgdGltZXJzW2ldID09PSB0aW1lcikgewogICAgICAgIHRpbWVycy5zcGxpY2UoaS0tLCAxKTsKICAgICAgfQogICAgfQogICAgaWYgKCF0aW1lcnMubGVuZ3RoKSB7CiAgICAgIGpRdWVyeS5meC5zdG9wKCk7CiAgICB9CiAgICBmeE5vdyA9IHVuZGVmaW5lZDsKICB9OwogIGpRdWVyeS5meC50aW1lciA9IGZ1bmN0aW9uICh0aW1lcikgewogICAgalF1ZXJ5LnRpbWVycy5wdXNoKHRpbWVyKTsKICAgIGlmICh0aW1lcigpKSB7CiAgICAgIGpRdWVyeS5meC5zdGFydCgpOwogICAgfSBlbHNlIHsKICAgICAgalF1ZXJ5LnRpbWVycy5wb3AoKTsKICAgIH0KICB9OwogIGpRdWVyeS5meC5pbnRlcnZhbCA9IDEzOwogIGpRdWVyeS5meC5zdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghdGltZXJJZCkgewogICAgICB0aW1lcklkID0gc2V0SW50ZXJ2YWwoalF1ZXJ5LmZ4LnRpY2ssIGpRdWVyeS5meC5pbnRlcnZhbCk7CiAgICB9CiAgfTsKICBqUXVlcnkuZnguc3RvcCA9IGZ1bmN0aW9uICgpIHsKICAgIGNsZWFySW50ZXJ2YWwodGltZXJJZCk7CiAgICB0aW1lcklkID0gbnVsbDsKICB9OwogIGpRdWVyeS5meC5zcGVlZHMgPSB7CiAgICBzbG93OiA2MDAsCiAgICBmYXN0OiAyMDAsCiAgICAvLyBEZWZhdWx0IHNwZWVkCiAgICBfZGVmYXVsdDogNDAwCiAgfTsKICAvLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uCiAgLy8gaHR0cDovL2JsaW5kc2lnbmFscy5jb20vaW5kZXgucGhwLzIwMDkvMDcvanF1ZXJ5LWRlbGF5LwogIGpRdWVyeS5mbi5kZWxheSA9IGZ1bmN0aW9uICh0aW1lLCB0eXBlKSB7CiAgICB0aW1lID0galF1ZXJ5LmZ4ID8galF1ZXJ5LmZ4LnNwZWVkc1t0aW1lXSB8fCB0aW1lIDogdGltZTsKICAgIHR5cGUgPSB0eXBlIHx8ICdmeCc7CiAgICByZXR1cm4gdGhpcy5xdWV1ZSh0eXBlLCBmdW5jdGlvbiAobmV4dCwgaG9va3MpIHsKICAgICAgdmFyIHRpbWVvdXQgPSBzZXRUaW1lb3V0KG5leHQsIHRpbWUpOwogICAgICBob29rcy5zdG9wID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgKGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0JyksIHNlbGVjdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NlbGVjdCcpLCBvcHQgPSBzZWxlY3QuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJykpOwogICAgaW5wdXQudHlwZSA9ICdjaGVja2JveCc7CiAgICAvLyBTdXBwb3J0OiBpT1MgNS4xLCBBbmRyb2lkIDQueCwgQW5kcm9pZCAyLjMKICAgIC8vIENoZWNrIHRoZSBkZWZhdWx0IGNoZWNrYm94L3JhZGlvIHZhbHVlICgiIiBvbiBvbGQgV2ViS2l0OyAib24iIGVsc2V3aGVyZSkKICAgIHN1cHBvcnQuY2hlY2tPbiA9IGlucHV0LnZhbHVlICE9PSAnJzsKICAgIC8vIE11c3QgYWNjZXNzIHRoZSBwYXJlbnQgdG8gbWFrZSBhbiBvcHRpb24gc2VsZWN0IHByb3Blcmx5CiAgICAvLyBTdXBwb3J0OiBJRTksIElFMTAKICAgIHN1cHBvcnQub3B0U2VsZWN0ZWQgPSBvcHQuc2VsZWN0ZWQ7CiAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgb3B0aW9ucyBpbnNpZGUgZGlzYWJsZWQgc2VsZWN0cyBhcmVuJ3QgbWFya2VkIGFzIGRpc2FibGVkCiAgICAvLyAoV2ViS2l0IG1hcmtzIHRoZW0gYXMgZGlzYWJsZWQpCiAgICBzZWxlY3QuZGlzYWJsZWQgPSB0cnVlOwogICAgc3VwcG9ydC5vcHREaXNhYmxlZCA9ICFvcHQuZGlzYWJsZWQ7CiAgICAvLyBDaGVjayBpZiBhbiBpbnB1dCBtYWludGFpbnMgaXRzIHZhbHVlIGFmdGVyIGJlY29taW5nIGEgcmFkaW8KICAgIC8vIFN1cHBvcnQ6IElFOSwgSUUxMAogICAgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOwogICAgaW5wdXQudmFsdWUgPSAndCc7CiAgICBpbnB1dC50eXBlID0gJ3JhZGlvJzsKICAgIHN1cHBvcnQucmFkaW9WYWx1ZSA9IGlucHV0LnZhbHVlID09PSAndCc7CiAgfSgpKTsKICB2YXIgbm9kZUhvb2ssIGJvb2xIb29rLCBhdHRySGFuZGxlID0galF1ZXJ5LmV4cHIuYXR0ckhhbmRsZTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGF0dHI6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGpRdWVyeS5hdHRyLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfSwKICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeS5yZW1vdmVBdHRyKHRoaXMsIG5hbWUpOwogICAgICB9KTsKICAgIH0KICB9KTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIGF0dHI6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSkgewogICAgICB2YXIgaG9va3MsIHJldCwgblR5cGUgPSBlbGVtLm5vZGVUeXBlOwogICAgICAvLyBkb24ndCBnZXQvc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCiAgICAgIGlmICghZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBGYWxsYmFjayB0byBwcm9wIHdoZW4gYXR0cmlidXRlcyBhcmUgbm90IHN1cHBvcnRlZAogICAgICBpZiAodHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlID09PSBzdHJ1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4galF1ZXJ5LnByb3AoZWxlbSwgbmFtZSwgdmFsdWUpOwogICAgICB9CiAgICAgIC8vIEFsbCBhdHRyaWJ1dGVzIGFyZSBsb3dlcmNhc2UKICAgICAgLy8gR3JhYiBuZWNlc3NhcnkgaG9vayBpZiBvbmUgaXMgZGVmaW5lZAogICAgICBpZiAoblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyhlbGVtKSkgewogICAgICAgIG5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzW25hbWVdIHx8IChqUXVlcnkuZXhwci5tYXRjaC5ib29sLnRlc3QobmFtZSkgPyBib29sSG9vayA6IG5vZGVIb29rKTsKICAgICAgfQogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIoZWxlbSwgbmFtZSk7CiAgICAgICAgfSBlbHNlIGlmIChob29rcyAmJiAnc2V0JyBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KGVsZW0sIHZhbHVlLCBuYW1lKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUgKyAnJyk7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGhvb2tzICYmICdnZXQnIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgbmFtZSkpICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXQgPSBqUXVlcnkuZmluZC5hdHRyKGVsZW0sIG5hbWUpOwogICAgICAgIC8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCiAgICAgICAgcmV0dXJuIHJldCA9PSBudWxsID8gdW5kZWZpbmVkIDogcmV0OwogICAgICB9CiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgIHZhciBuYW1lLCBwcm9wTmFtZSwgaSA9IDAsIGF0dHJOYW1lcyA9IHZhbHVlICYmIHZhbHVlLm1hdGNoKHJub3R3aGl0ZSk7CiAgICAgIGlmIChhdHRyTmFtZXMgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgIHdoaWxlIChuYW1lID0gYXR0ck5hbWVzW2krK10pIHsKICAgICAgICAgIHByb3BOYW1lID0galF1ZXJ5LnByb3BGaXhbbmFtZV0gfHwgbmFtZTsKICAgICAgICAgIC8vIEJvb2xlYW4gYXR0cmlidXRlcyBnZXQgc3BlY2lhbCB0cmVhdG1lbnQgKCMxMDg3MCkKICAgICAgICAgIGlmIChqUXVlcnkuZXhwci5tYXRjaC5ib29sLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgLy8gU2V0IGNvcnJlc3BvbmRpbmcgcHJvcGVydHkgdG8gZmFsc2UKICAgICAgICAgICAgZWxlbVtwcm9wTmFtZV0gPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGF0dHJIb29rczogewogICAgICB0eXBlOiB7CiAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgICAgIGlmICghc3VwcG9ydC5yYWRpb1ZhbHVlICYmIHZhbHVlID09PSAncmFkaW8nICYmIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAnaW5wdXQnKSkgewogICAgICAgICAgICAvLyBTZXR0aW5nIHRoZSB0eXBlIG9uIGEgcmFkaW8gYnV0dG9uIGFmdGVyIHRoZSB2YWx1ZSByZXNldHMgdGhlIHZhbHVlIGluIElFNi05CiAgICAgICAgICAgIC8vIFJlc2V0IHZhbHVlIHRvIGRlZmF1bHQgaW4gY2FzZSB0eXBlIGlzIHNldCBhZnRlciB2YWx1ZSBkdXJpbmcgY3JlYXRpb24KICAgICAgICAgICAgdmFyIHZhbCA9IGVsZW0udmFsdWU7CiAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCd0eXBlJywgdmFsdWUpOwogICAgICAgICAgICBpZiAodmFsKSB7CiAgICAgICAgICAgICAgZWxlbS52YWx1ZSA9IHZhbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgLy8gSG9va3MgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwogIGJvb2xIb29rID0gewogICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUsIG5hbWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIC8vIFJlbW92ZSBib29sZWFuIGF0dHJpYnV0ZXMgd2hlbiBzZXQgdG8gZmFsc2UKICAgICAgICBqUXVlcnkucmVtb3ZlQXR0cihlbGVtLCBuYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZShuYW1lLCBuYW1lKTsKICAgICAgfQogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9OwogIGpRdWVyeS5lYWNoKGpRdWVyeS5leHByLm1hdGNoLmJvb2wuc291cmNlLm1hdGNoKC9cdysvZyksIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICB2YXIgZ2V0dGVyID0gYXR0ckhhbmRsZVtuYW1lXSB8fCBqUXVlcnkuZmluZC5hdHRyOwogICAgYXR0ckhhbmRsZVtuYW1lXSA9IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBpc1hNTCkgewogICAgICB2YXIgcmV0LCBoYW5kbGU7CiAgICAgIGlmICghaXNYTUwpIHsKICAgICAgICAvLyBBdm9pZCBhbiBpbmZpbml0ZSBsb29wIGJ5IHRlbXBvcmFyaWx5IHJlbW92aW5nIHRoaXMgZnVuY3Rpb24gZnJvbSB0aGUgZ2V0dGVyCiAgICAgICAgaGFuZGxlID0gYXR0ckhhbmRsZVtuYW1lXTsKICAgICAgICBhdHRySGFuZGxlW25hbWVdID0gcmV0OwogICAgICAgIHJldCA9IGdldHRlcihlbGVtLCBuYW1lLCBpc1hNTCkgIT0gbnVsbCA/IG5hbWUudG9Mb3dlckNhc2UoKSA6IG51bGw7CiAgICAgICAgYXR0ckhhbmRsZVtuYW1lXSA9IGhhbmRsZTsKICAgICAgfQogICAgICByZXR1cm4gcmV0OwogICAgfTsKICB9KTsKICB2YXIgcmZvY3VzYWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbikkL2k7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBwcm9wOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBqUXVlcnkucHJvcCwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxKTsKICAgIH0sCiAgICByZW1vdmVQcm9wOiBmdW5jdGlvbiAobmFtZSkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBkZWxldGUgdGhpc1tqUXVlcnkucHJvcEZpeFtuYW1lXSB8fCBuYW1lXTsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBwcm9wRml4OiB7CiAgICAgICdmb3InOiAnaHRtbEZvcicsCiAgICAgICdjbGFzcyc6ICdjbGFzc05hbWUnCiAgICB9LAogICAgcHJvcDogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciByZXQsIGhvb2tzLCBub3R4bWwsIG5UeXBlID0gZWxlbS5ub2RlVHlwZTsKICAgICAgLy8gZG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwogICAgICBpZiAoIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbm90eG1sID0gblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyhlbGVtKTsKICAgICAgaWYgKG5vdHhtbCkgewogICAgICAgIC8vIEZpeCBuYW1lIGFuZCBhdHRhY2ggaG9va3MKICAgICAgICBuYW1lID0galF1ZXJ5LnByb3BGaXhbbmFtZV0gfHwgbmFtZTsKICAgICAgICBob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbbmFtZV07CiAgICAgIH0KICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gaG9va3MgJiYgJ3NldCcgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldChlbGVtLCB2YWx1ZSwgbmFtZSkpICE9PSB1bmRlZmluZWQgPyByZXQgOiBlbGVtW25hbWVdID0gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGhvb2tzICYmICdnZXQnIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgbmFtZSkpICE9PSBudWxsID8gcmV0IDogZWxlbVtuYW1lXTsKICAgICAgfQogICAgfSwKICAgIHByb3BIb29rczogewogICAgICB0YWJJbmRleDogewogICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBlbGVtLmhhc0F0dHJpYnV0ZSgndGFiaW5kZXgnKSB8fCByZm9jdXNhYmxlLnRlc3QoZWxlbS5ub2RlTmFtZSkgfHwgZWxlbS5ocmVmID8gZWxlbS50YWJJbmRleCA6IC0xOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwogIC8vIFN1cHBvcnQ6IElFOSsKICAvLyBTZWxlY3RlZG5lc3MgZm9yIGFuIG9wdGlvbiBpbiBhbiBvcHRncm91cCBjYW4gYmUgaW5hY2N1cmF0ZQogIGlmICghc3VwcG9ydC5vcHRTZWxlY3RlZCkgewogICAgalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCA9IHsKICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CiAgICAgICAgaWYgKHBhcmVudCAmJiBwYXJlbnQucGFyZW50Tm9kZSkgewogICAgICAgICAgcGFyZW50LnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH07CiAgfQogIGpRdWVyeS5lYWNoKFsKICAgICd0YWJJbmRleCcsCiAgICAncmVhZE9ubHknLAogICAgJ21heExlbmd0aCcsCiAgICAnY2VsbFNwYWNpbmcnLAogICAgJ2NlbGxQYWRkaW5nJywKICAgICdyb3dTcGFuJywKICAgICdjb2xTcGFuJywKICAgICd1c2VNYXAnLAogICAgJ2ZyYW1lQm9yZGVyJywKICAgICdjb250ZW50RWRpdGFibGUnCiAgXSwgZnVuY3Rpb24gKCkgewogICAgalF1ZXJ5LnByb3BGaXhbdGhpcy50b0xvd2VyQ2FzZSgpXSA9IHRoaXM7CiAgfSk7CiAgdmFyIHJjbGFzcyA9IC9bXHRcclxuXGZdL2c7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBhZGRDbGFzczogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhciBjbGFzc2VzLCBlbGVtLCBjdXIsIGNsYXp6LCBqLCBmaW5hbFZhbHVlLCBwcm9jZWVkID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiB2YWx1ZSwgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaikgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLmFkZENsYXNzKHZhbHVlLmNhbGwodGhpcywgaiwgdGhpcy5jbGFzc05hbWUpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAocHJvY2VlZCkgewogICAgICAgIC8vIFRoZSBkaXNqdW5jdGlvbiBoZXJlIGlzIGZvciBiZXR0ZXIgY29tcHJlc3NpYmlsaXR5IChzZWUgcmVtb3ZlQ2xhc3MpCiAgICAgICAgY2xhc3NlcyA9ICh2YWx1ZSB8fCAnJykubWF0Y2gocm5vdHdoaXRlKSB8fCBbXTsKICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBlbGVtID0gdGhpc1tpXTsKICAgICAgICAgIGN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKGVsZW0uY2xhc3NOYW1lID8gKCcgJyArIGVsZW0uY2xhc3NOYW1lICsgJyAnKS5yZXBsYWNlKHJjbGFzcywgJyAnKSA6ICcgJyk7CiAgICAgICAgICBpZiAoY3VyKSB7CiAgICAgICAgICAgIGogPSAwOwogICAgICAgICAgICB3aGlsZSAoY2xhenogPSBjbGFzc2VzW2orK10pIHsKICAgICAgICAgICAgICBpZiAoY3VyLmluZGV4T2YoJyAnICsgY2xhenogKyAnICcpIDwgMCkgewogICAgICAgICAgICAgICAgY3VyICs9IGNsYXp6ICsgJyAnOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBvbmx5IGFzc2lnbiBpZiBkaWZmZXJlbnQgdG8gYXZvaWQgdW5uZWVkZWQgcmVuZGVyaW5nLgogICAgICAgICAgICBmaW5hbFZhbHVlID0galF1ZXJ5LnRyaW0oY3VyKTsKICAgICAgICAgICAgaWYgKGVsZW0uY2xhc3NOYW1lICE9PSBmaW5hbFZhbHVlKSB7CiAgICAgICAgICAgICAgZWxlbS5jbGFzc05hbWUgPSBmaW5hbFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY2xhenosIGosIGZpbmFsVmFsdWUsIHByb2NlZWQgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgJiYgdmFsdWUsIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGopIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS5yZW1vdmVDbGFzcyh2YWx1ZS5jYWxsKHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHByb2NlZWQpIHsKICAgICAgICBjbGFzc2VzID0gKHZhbHVlIHx8ICcnKS5tYXRjaChybm90d2hpdGUpIHx8IFtdOwogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGVsZW0gPSB0aGlzW2ldOwogICAgICAgICAgLy8gVGhpcyBleHByZXNzaW9uIGlzIGhlcmUgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSBhZGRDbGFzcykKICAgICAgICAgIGN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKGVsZW0uY2xhc3NOYW1lID8gKCcgJyArIGVsZW0uY2xhc3NOYW1lICsgJyAnKS5yZXBsYWNlKHJjbGFzcywgJyAnKSA6ICcnKTsKICAgICAgICAgIGlmIChjdXIpIHsKICAgICAgICAgICAgaiA9IDA7CiAgICAgICAgICAgIHdoaWxlIChjbGF6eiA9IGNsYXNzZXNbaisrXSkgewogICAgICAgICAgICAgIC8vIFJlbW92ZSAqYWxsKiBpbnN0YW5jZXMKICAgICAgICAgICAgICB3aGlsZSAoY3VyLmluZGV4T2YoJyAnICsgY2xhenogKyAnICcpID49IDApIHsKICAgICAgICAgICAgICAgIGN1ciA9IGN1ci5yZXBsYWNlKCcgJyArIGNsYXp6ICsgJyAnLCAnICcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBvbmx5IGFzc2lnbiBpZiBkaWZmZXJlbnQgdG8gYXZvaWQgdW5uZWVkZWQgcmVuZGVyaW5nLgogICAgICAgICAgICBmaW5hbFZhbHVlID0gdmFsdWUgPyBqUXVlcnkudHJpbShjdXIpIDogJyc7CiAgICAgICAgICAgIGlmIChlbGVtLmNsYXNzTmFtZSAhPT0gZmluYWxWYWx1ZSkgewogICAgICAgICAgICAgIGVsZW0uY2xhc3NOYW1lID0gZmluYWxWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKHZhbHVlLCBzdGF0ZVZhbCkgewogICAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKICAgICAgaWYgKHR5cGVvZiBzdGF0ZVZhbCA9PT0gJ2Jvb2xlYW4nICYmIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIHN0YXRlVmFsID8gdGhpcy5hZGRDbGFzcyh2YWx1ZSkgOiB0aGlzLnJlbW92ZUNsYXNzKHZhbHVlKTsKICAgICAgfQogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLnRvZ2dsZUNsYXNzKHZhbHVlLmNhbGwodGhpcywgaSwgdGhpcy5jbGFzc05hbWUsIHN0YXRlVmFsKSwgc3RhdGVWYWwpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykgewogICAgICAgICAgLy8gdG9nZ2xlIGluZGl2aWR1YWwgY2xhc3MgbmFtZXMKICAgICAgICAgIHZhciBjbGFzc05hbWUsIGkgPSAwLCBzZWxmID0galF1ZXJ5KHRoaXMpLCBjbGFzc05hbWVzID0gdmFsdWUubWF0Y2gocm5vdHdoaXRlKSB8fCBbXTsKICAgICAgICAgIHdoaWxlIChjbGFzc05hbWUgPSBjbGFzc05hbWVzW2krK10pIHsKICAgICAgICAgICAgLy8gY2hlY2sgZWFjaCBjbGFzc05hbWUgZ2l2ZW4sIHNwYWNlIHNlcGFyYXRlZCBsaXN0CiAgICAgICAgICAgIGlmIChzZWxmLmhhc0NsYXNzKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICBzZWxmLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZi5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9ICAvLyBUb2dnbGUgd2hvbGUgY2xhc3MgbmFtZQogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gc3RydW5kZWZpbmVkIHx8IHR5cGUgPT09ICdib29sZWFuJykgewogICAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIC8vIHN0b3JlIGNsYXNzTmFtZSBpZiBzZXQKICAgICAgICAgICAgZGF0YV9wcml2LnNldCh0aGlzLCAnX19jbGFzc05hbWVfXycsIHRoaXMuY2xhc3NOYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIElmIHRoZSBlbGVtZW50IGhhcyBhIGNsYXNzIG5hbWUgb3IgaWYgd2UncmUgcGFzc2VkICJmYWxzZSIsCiAgICAgICAgICAvLyB0aGVuIHJlbW92ZSB0aGUgd2hvbGUgY2xhc3NuYW1lIChpZiB0aGVyZSB3YXMgb25lLCB0aGUgYWJvdmUgc2F2ZWQgaXQpLgogICAgICAgICAgLy8gT3RoZXJ3aXNlIGJyaW5nIGJhY2sgd2hhdGV2ZXIgd2FzIHByZXZpb3VzbHkgc2F2ZWQgKGlmIGFueXRoaW5nKSwKICAgICAgICAgIC8vIGZhbGxpbmcgYmFjayB0byB0aGUgZW1wdHkgc3RyaW5nIGlmIG5vdGhpbmcgd2FzIHN0b3JlZC4KICAgICAgICAgIHRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUgfHwgdmFsdWUgPT09IGZhbHNlID8gJycgOiBkYXRhX3ByaXYuZ2V0KHRoaXMsICdfX2NsYXNzTmFtZV9fJykgfHwgJyc7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHZhciBjbGFzc05hbWUgPSAnICcgKyBzZWxlY3RvciArICcgJywgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsKICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAodGhpc1tpXS5ub2RlVHlwZSA9PT0gMSAmJiAoJyAnICsgdGhpc1tpXS5jbGFzc05hbWUgKyAnICcpLnJlcGxhY2UocmNsYXNzLCAnICcpLmluZGV4T2YoY2xhc3NOYW1lKSA+PSAwKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0pOwogIHZhciBycmV0dXJuID0gL1xyL2c7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB2YWw6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIgaG9va3MsIHJldCwgaXNGdW5jdGlvbiwgZWxlbSA9IHRoaXNbMF07CiAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICBob29rcyA9IGpRdWVyeS52YWxIb29rc1tlbGVtLnR5cGVdIHx8IGpRdWVyeS52YWxIb29rc1tlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgICAgaWYgKGhvb2tzICYmICdnZXQnIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgJ3ZhbHVlJykpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgIH0KICAgICAgICAgIHJldCA9IGVsZW0udmFsdWU7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIHJldCA9PT0gJ3N0cmluZycgPyAvLyBoYW5kbGUgbW9zdCBjb21tb24gc3RyaW5nIGNhc2VzCiAgICAgICAgICByZXQucmVwbGFjZShycmV0dXJuLCAnJykgOiAvLyBoYW5kbGUgY2FzZXMgd2hlcmUgdmFsdWUgaXMgbnVsbC91bmRlZiBvciBudW1iZXIKICAgICAgICAgIHJldCA9PSBudWxsID8gJycgOiByZXQ7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpOwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgdmFyIHZhbDsKICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNGdW5jdGlvbikgewogICAgICAgICAgdmFsID0gdmFsdWUuY2FsbCh0aGlzLCBpLCBqUXVlcnkodGhpcykudmFsKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YWwgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgLy8gVHJlYXQgbnVsbC91bmRlZmluZWQgYXMgIiI7IGNvbnZlcnQgbnVtYmVycyB0byBzdHJpbmcKICAgICAgICBpZiAodmFsID09IG51bGwpIHsKICAgICAgICAgIHZhbCA9ICcnOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHZhbCArPSAnJzsKICAgICAgICB9IGVsc2UgaWYgKGpRdWVyeS5pc0FycmF5KHZhbCkpIHsKICAgICAgICAgIHZhbCA9IGpRdWVyeS5tYXAodmFsLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgPyAnJyA6IHZhbHVlICsgJyc7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaG9va3MgPSBqUXVlcnkudmFsSG9va3NbdGhpcy50eXBlXSB8fCBqUXVlcnkudmFsSG9va3NbdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICAvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwogICAgICAgIGlmICghaG9va3MgfHwgISgnc2V0JyBpbiBob29rcykgfHwgaG9va3Muc2V0KHRoaXMsIHZhbCwgJ3ZhbHVlJykgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgdmFsSG9va3M6IHsKICAgICAgb3B0aW9uOiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgdmFyIHZhbCA9IGpRdWVyeS5maW5kLmF0dHIoZWxlbSwgJ3ZhbHVlJyk7CiAgICAgICAgICByZXR1cm4gdmFsICE9IG51bGwgPyB2YWwgOiAvLyBTdXBwb3J0OiBJRTEwLTExKwogICAgICAgICAgLy8gb3B0aW9uLnRleHQgdGhyb3dzIGV4Y2VwdGlvbnMgKCMxNDY4NiwgIzE0ODU4KQogICAgICAgICAgalF1ZXJ5LnRyaW0oalF1ZXJ5LnRleHQoZWxlbSkpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2VsZWN0OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgdmFyIHZhbHVlLCBvcHRpb24sIG9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsIGluZGV4ID0gZWxlbS5zZWxlY3RlZEluZGV4LCBvbmUgPSBlbGVtLnR5cGUgPT09ICdzZWxlY3Qtb25lJyB8fCBpbmRleCA8IDAsIHZhbHVlcyA9IG9uZSA/IG51bGwgOiBbXSwgbWF4ID0gb25lID8gaW5kZXggKyAxIDogb3B0aW9ucy5sZW5ndGgsIGkgPSBpbmRleCA8IDAgPyBtYXggOiBvbmUgPyBpbmRleCA6IDA7CiAgICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBzZWxlY3RlZCBvcHRpb25zCiAgICAgICAgICBmb3IgKDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbnNbaV07CiAgICAgICAgICAgIC8vIElFNi05IGRvZXNuJ3QgdXBkYXRlIHNlbGVjdGVkIGFmdGVyIGZvcm0gcmVzZXQgKCMyNTUxKQogICAgICAgICAgICBpZiAoKG9wdGlvbi5zZWxlY3RlZCB8fCBpID09PSBpbmRleCkgJiYgKHN1cHBvcnQub3B0RGlzYWJsZWQgPyAhb3B0aW9uLmRpc2FibGVkIDogb3B0aW9uLmdldEF0dHJpYnV0ZSgnZGlzYWJsZWQnKSA9PT0gbnVsbCkgJiYgKCFvcHRpb24ucGFyZW50Tm9kZS5kaXNhYmxlZCB8fCAhalF1ZXJ5Lm5vZGVOYW1lKG9wdGlvbi5wYXJlbnROb2RlLCAnb3B0Z3JvdXAnKSkpIHsKICAgICAgICAgICAgICAvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uCiAgICAgICAgICAgICAgdmFsdWUgPSBqUXVlcnkob3B0aW9uKS52YWwoKTsKICAgICAgICAgICAgICAvLyBXZSBkb24ndCBuZWVkIGFuIGFycmF5IGZvciBvbmUgc2VsZWN0cwogICAgICAgICAgICAgIGlmIChvbmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgdmFyIG9wdGlvblNldCwgb3B0aW9uLCBvcHRpb25zID0gZWxlbS5vcHRpb25zLCB2YWx1ZXMgPSBqUXVlcnkubWFrZUFycmF5KHZhbHVlKSwgaSA9IG9wdGlvbnMubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICBvcHRpb24gPSBvcHRpb25zW2ldOwogICAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkID0galF1ZXJ5LmluQXJyYXkob3B0aW9uLnZhbHVlLCB2YWx1ZXMpID49IDApIHsKICAgICAgICAgICAgICBvcHRpb25TZXQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBmb3JjZSBicm93c2VycyB0byBiZWhhdmUgY29uc2lzdGVudGx5IHdoZW4gbm9uLW1hdGNoaW5nIHZhbHVlIGlzIHNldAogICAgICAgICAgaWYgKCFvcHRpb25TZXQpIHsKICAgICAgICAgICAgZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwogIC8vIFJhZGlvcyBhbmQgY2hlY2tib3hlcyBnZXR0ZXIvc2V0dGVyCiAgalF1ZXJ5LmVhY2goWwogICAgJ3JhZGlvJywKICAgICdjaGVja2JveCcKICBdLCBmdW5jdGlvbiAoKSB7CiAgICBqUXVlcnkudmFsSG9va3NbdGhpc10gPSB7CiAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uY2hlY2tlZCA9IGpRdWVyeS5pbkFycmF5KGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUpID49IDA7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgaWYgKCFzdXBwb3J0LmNoZWNrT24pIHsKICAgICAgalF1ZXJ5LnZhbEhvb2tzW3RoaXNdLmdldCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgLy8gU3VwcG9ydDogV2Via2l0CiAgICAgICAgLy8gIiIgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiAib24iIGlmIGEgdmFsdWUgaXNuJ3Qgc3BlY2lmaWVkCiAgICAgICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCd2YWx1ZScpID09PSBudWxsID8gJ29uJyA6IGVsZW0udmFsdWU7CiAgICAgIH07CiAgICB9CiAgfSk7CiAgLy8gUmV0dXJuIGpRdWVyeSBmb3IgYXR0cmlidXRlcy1vbmx5IGluY2x1c2lvbgogIGpRdWVyeS5lYWNoKCgnYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgJyArICdtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAnICsgJ2NoYW5nZSBzZWxlY3Qgc3VibWl0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3IgY29udGV4dG1lbnUnKS5zcGxpdCgnICcpLCBmdW5jdGlvbiAoaSwgbmFtZSkgewogICAgLy8gSGFuZGxlIGV2ZW50IGJpbmRpbmcKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uIChkYXRhLCBmbikgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDAgPyB0aGlzLm9uKG5hbWUsIG51bGwsIGRhdGEsIGZuKSA6IHRoaXMudHJpZ2dlcihuYW1lKTsKICAgIH07CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBob3ZlcjogZnVuY3Rpb24gKGZuT3ZlciwgZm5PdXQpIHsKICAgICAgcmV0dXJuIHRoaXMubW91c2VlbnRlcihmbk92ZXIpLm1vdXNlbGVhdmUoZm5PdXQgfHwgZm5PdmVyKTsKICAgIH0sCiAgICBiaW5kOiBmdW5jdGlvbiAodHlwZXMsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGVzLCBudWxsLCBkYXRhLCBmbik7CiAgICB9LAogICAgdW5iaW5kOiBmdW5jdGlvbiAodHlwZXMsIGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9mZih0eXBlcywgbnVsbCwgZm4pOwogICAgfSwKICAgIGRlbGVnYXRlOiBmdW5jdGlvbiAoc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbikgewogICAgICByZXR1cm4gdGhpcy5vbih0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuKTsKICAgIH0sCiAgICB1bmRlbGVnYXRlOiBmdW5jdGlvbiAoc2VsZWN0b3IsIHR5cGVzLCBmbikgewogICAgICAvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gdGhpcy5vZmYoc2VsZWN0b3IsICcqKicpIDogdGhpcy5vZmYodHlwZXMsIHNlbGVjdG9yIHx8ICcqKicsIGZuKTsKICAgIH0KICB9KTsKICB2YXIgbm9uY2UgPSBqUXVlcnkubm93KCk7CiAgdmFyIHJxdWVyeSA9IC9cPy87CiAgLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKICAvLyBXb3JrYXJvdW5kIGZhaWx1cmUgdG8gc3RyaW5nLWNhc3QgbnVsbCBpbnB1dAogIGpRdWVyeS5wYXJzZUpTT04gPSBmdW5jdGlvbiAoZGF0YSkgewogICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSArICcnKTsKICB9OwogIC8vIENyb3NzLWJyb3dzZXIgeG1sIHBhcnNpbmcKICBqUXVlcnkucGFyc2VYTUwgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHhtbCwgdG1wOwogICAgaWYgKCFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIC8vIFN1cHBvcnQ6IElFOQogICAgdHJ5IHsKICAgICAgdG1wID0gbmV3IERPTVBhcnNlcigpOwogICAgICB4bWwgPSB0bXAucGFyc2VGcm9tU3RyaW5nKGRhdGEsICd0ZXh0L3htbCcpOwogICAgfSBjYXRjaCAoZSkgewogICAgICB4bWwgPSB1bmRlZmluZWQ7CiAgICB9CiAgICBpZiAoIXhtbCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3BhcnNlcmVycm9yJykubGVuZ3RoKSB7CiAgICAgIGpRdWVyeS5lcnJvcignSW52YWxpZCBYTUw6ICcgKyBkYXRhKTsKICAgIH0KICAgIHJldHVybiB4bWw7CiAgfTsKICB2YXIKICAgIC8vIERvY3VtZW50IGxvY2F0aW9uCiAgICBhamF4TG9jUGFydHMsIGFqYXhMb2NhdGlvbiwgcmhhc2ggPSAvIy4qJC8sIHJ0cyA9IC8oWz8mXSlfPVteJl0qLywgcmhlYWRlcnMgPSAvXiguKj8pOlsgXHRdKihbXlxyXG5dKikkL2dtLAogICAgLy8gIzc2NTMsICM4MTI1LCAjODE1MjogbG9jYWwgcHJvdG9jb2wgZGV0ZWN0aW9uCiAgICBybG9jYWxQcm90b2NvbCA9IC9eKD86YWJvdXR8YXBwfGFwcC1zdG9yYWdlfC4rLWV4dGVuc2lvbnxmaWxlfHJlc3x3aWRnZXQpOiQvLCBybm9Db250ZW50ID0gL14oPzpHRVR8SEVBRCkkLywgcnByb3RvY29sID0gL15cL1wvLywgcnVybCA9IC9eKFtcdy4rLV0rOikoPzpcL1wvKD86W15cLz8jXSpAfCkoW15cLz8jOl0qKSg/OjooXGQrKXwpfCkvLAogICAgLyogUHJlZmlsdGVycwogICAgKiAxKSBUaGV5IGFyZSB1c2VmdWwgdG8gaW50cm9kdWNlIGN1c3RvbSBkYXRhVHlwZXMgKHNlZSBhamF4L2pzb25wLmpzIGZvciBhbiBleGFtcGxlKQogICAgKiAyKSBUaGVzZSBhcmUgY2FsbGVkOgogICAgKiAgICAtIEJFRk9SRSBhc2tpbmcgZm9yIGEgdHJhbnNwb3J0CiAgICAqICAgIC0gQUZURVIgcGFyYW0gc2VyaWFsaXphdGlvbiAocy5kYXRhIGlzIGEgc3RyaW5nIGlmIHMucHJvY2Vzc0RhdGEgaXMgdHJ1ZSkKICAgICogMykga2V5IGlzIHRoZSBkYXRhVHlwZQogICAgKiA0KSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAogICAgKiA1KSBleGVjdXRpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBjb250aW51ZSBkb3duIHRvICIqIiBpZiBuZWVkZWQKICAgICovCiAgICBwcmVmaWx0ZXJzID0ge30sCiAgICAvKiBUcmFuc3BvcnRzIGJpbmRpbmdzCiAgICAqIDEpIGtleSBpcyB0aGUgZGF0YVR5cGUKICAgICogMikgdGhlIGNhdGNoYWxsIHN5bWJvbCAiKiIgY2FuIGJlIHVzZWQKICAgICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZAogICAgKi8KICAgIHRyYW5zcG9ydHMgPSB7fSwKICAgIC8vIEF2b2lkIGNvbW1lbnQtcHJvbG9nIGNoYXIgc2VxdWVuY2UgKCMxMDA5OCk7IG11c3QgYXBwZWFzZSBsaW50IGFuZCBldmFkZSBjb21wcmVzc2lvbgogICAgYWxsVHlwZXMgPSAnKi8nLmNvbmNhdCgnKicpOwogIC8vICM4MTM4LCBJRSBtYXkgdGhyb3cgYW4gZXhjZXB0aW9uIHdoZW4gYWNjZXNzaW5nCiAgLy8gYSBmaWVsZCBmcm9tIHdpbmRvdy5sb2NhdGlvbiBpZiBkb2N1bWVudC5kb21haW4gaGFzIGJlZW4gc2V0CiAgdHJ5IHsKICAgIGFqYXhMb2NhdGlvbiA9IGxvY2F0aW9uLmhyZWY7CiAgfSBjYXRjaCAoZSkgewogICAgLy8gVXNlIHRoZSBocmVmIGF0dHJpYnV0ZSBvZiBhbiBBIGVsZW1lbnQKICAgIC8vIHNpbmNlIElFIHdpbGwgbW9kaWZ5IGl0IGdpdmVuIGRvY3VtZW50LmxvY2F0aW9uCiAgICBhamF4TG9jYXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICBhamF4TG9jYXRpb24uaHJlZiA9ICcnOwogICAgYWpheExvY2F0aW9uID0gYWpheExvY2F0aW9uLmhyZWY7CiAgfQogIC8vIFNlZ21lbnQgbG9jYXRpb24gaW50byBwYXJ0cwogIGFqYXhMb2NQYXJ0cyA9IHJ1cmwuZXhlYyhhamF4TG9jYXRpb24udG9Mb3dlckNhc2UoKSkgfHwgW107CiAgLy8gQmFzZSAiY29uc3RydWN0b3IiIGZvciBqUXVlcnkuYWpheFByZWZpbHRlciBhbmQgalF1ZXJ5LmFqYXhUcmFuc3BvcnQKICBmdW5jdGlvbiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoc3RydWN0dXJlKSB7CiAgICAvLyBkYXRhVHlwZUV4cHJlc3Npb24gaXMgb3B0aW9uYWwgYW5kIGRlZmF1bHRzIHRvICIqIgogICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhVHlwZUV4cHJlc3Npb24sIGZ1bmMpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhVHlwZUV4cHJlc3Npb24gIT09ICdzdHJpbmcnKSB7CiAgICAgICAgZnVuYyA9IGRhdGFUeXBlRXhwcmVzc2lvbjsKICAgICAgICBkYXRhVHlwZUV4cHJlc3Npb24gPSAnKic7CiAgICAgIH0KICAgICAgdmFyIGRhdGFUeXBlLCBpID0gMCwgZGF0YVR5cGVzID0gZGF0YVR5cGVFeHByZXNzaW9uLnRvTG93ZXJDYXNlKCkubWF0Y2gocm5vdHdoaXRlKSB8fCBbXTsKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgLy8gRm9yIGVhY2ggZGF0YVR5cGUgaW4gdGhlIGRhdGFUeXBlRXhwcmVzc2lvbgogICAgICAgIHdoaWxlIChkYXRhVHlwZSA9IGRhdGFUeXBlc1tpKytdKSB7CiAgICAgICAgICAvLyBQcmVwZW5kIGlmIHJlcXVlc3RlZAogICAgICAgICAgaWYgKGRhdGFUeXBlWzBdID09PSAnKycpIHsKICAgICAgICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZS5zbGljZSgxKSB8fCAnKic7CiAgICAgICAgICAgIChzdHJ1Y3R1cmVbZGF0YVR5cGVdID0gc3RydWN0dXJlW2RhdGFUeXBlXSB8fCBbXSkudW5zaGlmdChmdW5jKTsgIC8vIE90aGVyd2lzZSBhcHBlbmQKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIChzdHJ1Y3R1cmVbZGF0YVR5cGVdID0gc3RydWN0dXJlW2RhdGFUeXBlXSB8fCBbXSkucHVzaChmdW5jKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQogIC8vIEJhc2UgaW5zcGVjdGlvbiBmdW5jdGlvbiBmb3IgcHJlZmlsdGVycyBhbmQgdHJhbnNwb3J0cwogIGZ1bmN0aW9uIGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUikgewogICAgdmFyIGluc3BlY3RlZCA9IHt9LCBzZWVraW5nVHJhbnNwb3J0ID0gc3RydWN0dXJlID09PSB0cmFuc3BvcnRzOwogICAgZnVuY3Rpb24gaW5zcGVjdChkYXRhVHlwZSkgewogICAgICB2YXIgc2VsZWN0ZWQ7CiAgICAgIGluc3BlY3RlZFtkYXRhVHlwZV0gPSB0cnVlOwogICAgICBqUXVlcnkuZWFjaChzdHJ1Y3R1cmVbZGF0YVR5cGVdIHx8IFtdLCBmdW5jdGlvbiAoXywgcHJlZmlsdGVyT3JGYWN0b3J5KSB7CiAgICAgICAgdmFyIGRhdGFUeXBlT3JUcmFuc3BvcnQgPSBwcmVmaWx0ZXJPckZhY3Rvcnkob3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUik7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhVHlwZU9yVHJhbnNwb3J0ID09PSAnc3RyaW5nJyAmJiAhc2Vla2luZ1RyYW5zcG9ydCAmJiAhaW5zcGVjdGVkW2RhdGFUeXBlT3JUcmFuc3BvcnRdKSB7CiAgICAgICAgICBvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KGRhdGFUeXBlT3JUcmFuc3BvcnQpOwogICAgICAgICAgaW5zcGVjdChkYXRhVHlwZU9yVHJhbnNwb3J0KTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgaWYgKHNlZWtpbmdUcmFuc3BvcnQpIHsKICAgICAgICAgIHJldHVybiAhKHNlbGVjdGVkID0gZGF0YVR5cGVPclRyYW5zcG9ydCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHNlbGVjdGVkOwogICAgfQogICAgcmV0dXJuIGluc3BlY3Qob3B0aW9ucy5kYXRhVHlwZXNbMF0pIHx8ICFpbnNwZWN0ZWRbJyonXSAmJiBpbnNwZWN0KCcqJyk7CiAgfQogIC8vIEEgc3BlY2lhbCBleHRlbmQgZm9yIGFqYXggb3B0aW9ucwogIC8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQogIC8vIEZpeGVzICM5ODg3CiAgZnVuY3Rpb24gYWpheEV4dGVuZCh0YXJnZXQsIHNyYykgewogICAgdmFyIGtleSwgZGVlcCwgZmxhdE9wdGlvbnMgPSBqUXVlcnkuYWpheFNldHRpbmdzLmZsYXRPcHRpb25zIHx8IHt9OwogICAgZm9yIChrZXkgaW4gc3JjKSB7CiAgICAgIGlmIChzcmNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgKGZsYXRPcHRpb25zW2tleV0gPyB0YXJnZXQgOiBkZWVwIHx8IChkZWVwID0ge30pKVtrZXldID0gc3JjW2tleV07CiAgICAgIH0KICAgIH0KICAgIGlmIChkZWVwKSB7CiAgICAgIGpRdWVyeS5leHRlbmQodHJ1ZSwgdGFyZ2V0LCBkZWVwKTsKICAgIH0KICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIC8qIEhhbmRsZXMgcmVzcG9uc2VzIHRvIGFuIGFqYXggcmVxdWVzdDoKICAgKiAtIGZpbmRzIHRoZSByaWdodCBkYXRhVHlwZSAobWVkaWF0ZXMgYmV0d2VlbiBjb250ZW50LXR5cGUgYW5kIGV4cGVjdGVkIGRhdGFUeXBlKQogICAqIC0gcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogICAqLwogIGZ1bmN0aW9uIGFqYXhIYW5kbGVSZXNwb25zZXMocywganFYSFIsIHJlc3BvbnNlcykgewogICAgdmFyIGN0LCB0eXBlLCBmaW5hbERhdGFUeXBlLCBmaXJzdERhdGFUeXBlLCBjb250ZW50cyA9IHMuY29udGVudHMsIGRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzOwogICAgLy8gUmVtb3ZlIGF1dG8gZGF0YVR5cGUgYW5kIGdldCBjb250ZW50LXR5cGUgaW4gdGhlIHByb2Nlc3MKICAgIHdoaWxlIChkYXRhVHlwZXNbMF0gPT09ICcqJykgewogICAgICBkYXRhVHlwZXMuc2hpZnQoKTsKICAgICAgaWYgKGN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoJ0NvbnRlbnQtVHlwZScpOwogICAgICB9CiAgICB9CiAgICAvLyBDaGVjayBpZiB3ZSdyZSBkZWFsaW5nIHdpdGggYSBrbm93biBjb250ZW50LXR5cGUKICAgIGlmIChjdCkgewogICAgICBmb3IgKHR5cGUgaW4gY29udGVudHMpIHsKICAgICAgICBpZiAoY29udGVudHNbdHlwZV0gJiYgY29udGVudHNbdHlwZV0udGVzdChjdCkpIHsKICAgICAgICAgIGRhdGFUeXBlcy51bnNoaWZ0KHR5cGUpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhIHJlc3BvbnNlIGZvciB0aGUgZXhwZWN0ZWQgZGF0YVR5cGUKICAgIGlmIChkYXRhVHlwZXNbMF0gaW4gcmVzcG9uc2VzKSB7CiAgICAgIGZpbmFsRGF0YVR5cGUgPSBkYXRhVHlwZXNbMF07CiAgICB9IGVsc2UgewogICAgICAvLyBUcnkgY29udmVydGlibGUgZGF0YVR5cGVzCiAgICAgIGZvciAodHlwZSBpbiByZXNwb25zZXMpIHsKICAgICAgICBpZiAoIWRhdGFUeXBlc1swXSB8fCBzLmNvbnZlcnRlcnNbdHlwZSArICcgJyArIGRhdGFUeXBlc1swXV0pIHsKICAgICAgICAgIGZpbmFsRGF0YVR5cGUgPSB0eXBlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmICghZmlyc3REYXRhVHlwZSkgewogICAgICAgICAgZmlyc3REYXRhVHlwZSA9IHR5cGU7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQogICAgICBmaW5hbERhdGFUeXBlID0gZmluYWxEYXRhVHlwZSB8fCBmaXJzdERhdGFUeXBlOwogICAgfQogICAgLy8gSWYgd2UgZm91bmQgYSBkYXRhVHlwZQogICAgLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKICAgIC8vIGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKICAgIGlmIChmaW5hbERhdGFUeXBlKSB7CiAgICAgIGlmIChmaW5hbERhdGFUeXBlICE9PSBkYXRhVHlwZXNbMF0pIHsKICAgICAgICBkYXRhVHlwZXMudW5zaGlmdChmaW5hbERhdGFUeXBlKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzcG9uc2VzW2ZpbmFsRGF0YVR5cGVdOwogICAgfQogIH0KICAvKiBDaGFpbiBjb252ZXJzaW9ucyBnaXZlbiB0aGUgcmVxdWVzdCBhbmQgdGhlIG9yaWdpbmFsIHJlc3BvbnNlCiAgICogQWxzbyBzZXRzIHRoZSByZXNwb25zZVhYWCBmaWVsZHMgb24gdGhlIGpxWEhSIGluc3RhbmNlCiAgICovCiAgZnVuY3Rpb24gYWpheENvbnZlcnQocywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MpIHsKICAgIHZhciBjb252MiwgY3VycmVudCwgY29udiwgdG1wLCBwcmV2LCBjb252ZXJ0ZXJzID0ge30sCiAgICAgIC8vIFdvcmsgd2l0aCBhIGNvcHkgb2YgZGF0YVR5cGVzIGluIGNhc2Ugd2UgbmVlZCB0byBtb2RpZnkgaXQgZm9yIGNvbnZlcnNpb24KICAgICAgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXMuc2xpY2UoKTsKICAgIC8vIENyZWF0ZSBjb252ZXJ0ZXJzIG1hcCB3aXRoIGxvd2VyY2FzZWQga2V5cwogICAgaWYgKGRhdGFUeXBlc1sxXSkgewogICAgICBmb3IgKGNvbnYgaW4gcy5jb252ZXJ0ZXJzKSB7CiAgICAgICAgY29udmVydGVyc1tjb252LnRvTG93ZXJDYXNlKCldID0gcy5jb252ZXJ0ZXJzW2NvbnZdOwogICAgICB9CiAgICB9CiAgICBjdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CiAgICAvLyBDb252ZXJ0IHRvIGVhY2ggc2VxdWVudGlhbCBkYXRhVHlwZQogICAgd2hpbGUgKGN1cnJlbnQpIHsKICAgICAgaWYgKHMucmVzcG9uc2VGaWVsZHNbY3VycmVudF0pIHsKICAgICAgICBqcVhIUltzLnJlc3BvbnNlRmllbGRzW2N1cnJlbnRdXSA9IHJlc3BvbnNlOwogICAgICB9CiAgICAgIC8vIEFwcGx5IHRoZSBkYXRhRmlsdGVyIGlmIHByb3ZpZGVkCiAgICAgIGlmICghcHJldiAmJiBpc1N1Y2Nlc3MgJiYgcy5kYXRhRmlsdGVyKSB7CiAgICAgICAgcmVzcG9uc2UgPSBzLmRhdGFGaWx0ZXIocmVzcG9uc2UsIHMuZGF0YVR5cGUpOwogICAgICB9CiAgICAgIHByZXYgPSBjdXJyZW50OwogICAgICBjdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CiAgICAgIGlmIChjdXJyZW50KSB7CiAgICAgICAgLy8gVGhlcmUncyBvbmx5IHdvcmsgdG8gZG8gaWYgY3VycmVudCBkYXRhVHlwZSBpcyBub24tYXV0bwogICAgICAgIGlmIChjdXJyZW50ID09PSAnKicpIHsKICAgICAgICAgIGN1cnJlbnQgPSBwcmV2OyAgLy8gQ29udmVydCByZXNwb25zZSBpZiBwcmV2IGRhdGFUeXBlIGlzIG5vbi1hdXRvIGFuZCBkaWZmZXJzIGZyb20gY3VycmVudAogICAgICAgIH0gZWxzZSBpZiAocHJldiAhPT0gJyonICYmIHByZXYgIT09IGN1cnJlbnQpIHsKICAgICAgICAgIC8vIFNlZWsgYSBkaXJlY3QgY29udmVydGVyCiAgICAgICAgICBjb252ID0gY29udmVydGVyc1twcmV2ICsgJyAnICsgY3VycmVudF0gfHwgY29udmVydGVyc1snKiAnICsgY3VycmVudF07CiAgICAgICAgICAvLyBJZiBub25lIGZvdW5kLCBzZWVrIGEgcGFpcgogICAgICAgICAgaWYgKCFjb252KSB7CiAgICAgICAgICAgIGZvciAoY29udjIgaW4gY29udmVydGVycykgewogICAgICAgICAgICAgIC8vIElmIGNvbnYyIG91dHB1dHMgY3VycmVudAogICAgICAgICAgICAgIHRtcCA9IGNvbnYyLnNwbGl0KCcgJyk7CiAgICAgICAgICAgICAgaWYgKHRtcFsxXSA9PT0gY3VycmVudCkgewogICAgICAgICAgICAgICAgLy8gSWYgcHJldiBjYW4gYmUgY29udmVydGVkIHRvIGFjY2VwdGVkIGlucHV0CiAgICAgICAgICAgICAgICBjb252ID0gY29udmVydGVyc1twcmV2ICsgJyAnICsgdG1wWzBdXSB8fCBjb252ZXJ0ZXJzWycqICcgKyB0bXBbMF1dOwogICAgICAgICAgICAgICAgaWYgKGNvbnYpIHsKICAgICAgICAgICAgICAgICAgLy8gQ29uZGVuc2UgZXF1aXZhbGVuY2UgY29udmVydGVycwogICAgICAgICAgICAgICAgICBpZiAoY29udiA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnYgPSBjb252ZXJ0ZXJzW2NvbnYyXTsgIC8vIE90aGVyd2lzZSwgaW5zZXJ0IHRoZSBpbnRlcm1lZGlhdGUgZGF0YVR5cGUKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb252ZXJ0ZXJzW2NvbnYyXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0bXBbMF07CiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQodG1wWzFdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIEFwcGx5IGNvbnZlcnRlciAoaWYgbm90IGFuIGVxdWl2YWxlbmNlKQogICAgICAgICAgaWYgKGNvbnYgIT09IHRydWUpIHsKICAgICAgICAgICAgLy8gVW5sZXNzIGVycm9ycyBhcmUgYWxsb3dlZCB0byBidWJibGUsIGNhdGNoIGFuZCByZXR1cm4gdGhlbQogICAgICAgICAgICBpZiAoY29udiAmJiBzWyd0aHJvd3MnXSkgewogICAgICAgICAgICAgIHJlc3BvbnNlID0gY29udihyZXNwb25zZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gY29udihyZXNwb25zZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgc3RhdGU6ICdwYXJzZXJlcnJvcicsCiAgICAgICAgICAgICAgICAgIGVycm9yOiBjb252ID8gZSA6ICdObyBjb252ZXJzaW9uIGZyb20gJyArIHByZXYgKyAnIHRvICcgKyBjdXJyZW50CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgc3RhdGU6ICdzdWNjZXNzJywKICAgICAgZGF0YTogcmVzcG9uc2UKICAgIH07CiAgfQogIGpRdWVyeS5leHRlbmQoewogICAgLy8gQ291bnRlciBmb3IgaG9sZGluZyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSBxdWVyaWVzCiAgICBhY3RpdmU6IDAsCiAgICAvLyBMYXN0LU1vZGlmaWVkIGhlYWRlciBjYWNoZSBmb3IgbmV4dCByZXF1ZXN0CiAgICBsYXN0TW9kaWZpZWQ6IHt9LAogICAgZXRhZzoge30sCiAgICBhamF4U2V0dGluZ3M6IHsKICAgICAgdXJsOiBhamF4TG9jYXRpb24sCiAgICAgIHR5cGU6ICdHRVQnLAogICAgICBpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KGFqYXhMb2NQYXJ0c1sxXSksCiAgICAgIGdsb2JhbDogdHJ1ZSwKICAgICAgcHJvY2Vzc0RhdGE6IHRydWUsCiAgICAgIGFzeW5jOiB0cnVlLAogICAgICBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD1VVEYtOCcsCiAgICAgIC8qCiAgICAgIHRpbWVvdXQ6IDAsCiAgICAgIGRhdGE6IG51bGwsCiAgICAgIGRhdGFUeXBlOiBudWxsLAogICAgICB1c2VybmFtZTogbnVsbCwKICAgICAgcGFzc3dvcmQ6IG51bGwsCiAgICAgIGNhY2hlOiBudWxsLAogICAgICB0aHJvd3M6IGZhbHNlLAogICAgICB0cmFkaXRpb25hbDogZmFsc2UsCiAgICAgIGhlYWRlcnM6IHt9LAogICAgICAqLwogICAgICBhY2NlcHRzOiB7CiAgICAgICAgJyonOiBhbGxUeXBlcywKICAgICAgICB0ZXh0OiAndGV4dC9wbGFpbicsCiAgICAgICAgaHRtbDogJ3RleHQvaHRtbCcsCiAgICAgICAgeG1sOiAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgICAganNvbjogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvamF2YXNjcmlwdCcKICAgICAgfSwKICAgICAgY29udGVudHM6IHsKICAgICAgICB4bWw6IC94bWwvLAogICAgICAgIGh0bWw6IC9odG1sLywKICAgICAgICBqc29uOiAvanNvbi8KICAgICAgfSwKICAgICAgcmVzcG9uc2VGaWVsZHM6IHsKICAgICAgICB4bWw6ICdyZXNwb25zZVhNTCcsCiAgICAgICAgdGV4dDogJ3Jlc3BvbnNlVGV4dCcsCiAgICAgICAganNvbjogJ3Jlc3BvbnNlSlNPTicKICAgICAgfSwKICAgICAgLy8gRGF0YSBjb252ZXJ0ZXJzCiAgICAgIC8vIEtleXMgc2VwYXJhdGUgc291cmNlIChvciBjYXRjaGFsbCAiKiIpIGFuZCBkZXN0aW5hdGlvbiB0eXBlcyB3aXRoIGEgc2luZ2xlIHNwYWNlCiAgICAgIGNvbnZlcnRlcnM6IHsKICAgICAgICAvLyBDb252ZXJ0IGFueXRoaW5nIHRvIHRleHQKICAgICAgICAnKiB0ZXh0JzogU3RyaW5nLAogICAgICAgIC8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQogICAgICAgICd0ZXh0IGh0bWwnOiB0cnVlLAogICAgICAgIC8vIEV2YWx1YXRlIHRleHQgYXMgYSBqc29uIGV4cHJlc3Npb24KICAgICAgICAndGV4dCBqc29uJzogalF1ZXJ5LnBhcnNlSlNPTiwKICAgICAgICAvLyBQYXJzZSB0ZXh0IGFzIHhtbAogICAgICAgICd0ZXh0IHhtbCc6IGpRdWVyeS5wYXJzZVhNTAogICAgICB9LAogICAgICAvLyBGb3Igb3B0aW9ucyB0aGF0IHNob3VsZG4ndCBiZSBkZWVwIGV4dGVuZGVkOgogICAgICAvLyB5b3UgY2FuIGFkZCB5b3VyIG93biBjdXN0b20gb3B0aW9ucyBoZXJlIGlmCiAgICAgIC8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCiAgICAgIC8vIGRlZXAgZXh0ZW5kZWQgKHNlZSBhamF4RXh0ZW5kKQogICAgICBmbGF0T3B0aW9uczogewogICAgICAgIHVybDogdHJ1ZSwKICAgICAgICBjb250ZXh0OiB0cnVlCiAgICAgIH0KICAgIH0sCiAgICAvLyBDcmVhdGVzIGEgZnVsbCBmbGVkZ2VkIHNldHRpbmdzIG9iamVjdCBpbnRvIHRhcmdldAogICAgLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgogICAgLy8gSWYgdGFyZ2V0IGlzIG9taXR0ZWQsIHdyaXRlcyBpbnRvIGFqYXhTZXR0aW5ncy4KICAgIGFqYXhTZXR1cDogZnVuY3Rpb24gKHRhcmdldCwgc2V0dGluZ3MpIHsKICAgICAgcmV0dXJuIHNldHRpbmdzID8gLy8gQnVpbGRpbmcgYSBzZXR0aW5ncyBvYmplY3QKICAgICAgYWpheEV4dGVuZChhamF4RXh0ZW5kKHRhcmdldCwgalF1ZXJ5LmFqYXhTZXR0aW5ncyksIHNldHRpbmdzKSA6IC8vIEV4dGVuZGluZyBhamF4U2V0dGluZ3MKICAgICAgYWpheEV4dGVuZChqUXVlcnkuYWpheFNldHRpbmdzLCB0YXJnZXQpOwogICAgfSwKICAgIGFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyhwcmVmaWx0ZXJzKSwKICAgIGFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyh0cmFuc3BvcnRzKSwKICAgIC8vIE1haW4gbWV0aG9kCiAgICBhamF4OiBmdW5jdGlvbiAodXJsLCBvcHRpb25zKSB7CiAgICAgIC8vIElmIHVybCBpcyBhbiBvYmplY3QsIHNpbXVsYXRlIHByZS0xLjUgc2lnbmF0dXJlCiAgICAgIGlmICh0eXBlb2YgdXJsID09PSAnb2JqZWN0JykgewogICAgICAgIG9wdGlvbnMgPSB1cmw7CiAgICAgICAgdXJsID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIC8vIEZvcmNlIG9wdGlvbnMgdG8gYmUgYW4gb2JqZWN0CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB2YXIgdHJhbnNwb3J0LAogICAgICAgIC8vIFVSTCB3aXRob3V0IGFudGktY2FjaGUgcGFyYW0KICAgICAgICBjYWNoZVVSTCwKICAgICAgICAvLyBSZXNwb25zZSBoZWFkZXJzCiAgICAgICAgcmVzcG9uc2VIZWFkZXJzU3RyaW5nLCByZXNwb25zZUhlYWRlcnMsCiAgICAgICAgLy8gdGltZW91dCBoYW5kbGUKICAgICAgICB0aW1lb3V0VGltZXIsCiAgICAgICAgLy8gQ3Jvc3MtZG9tYWluIGRldGVjdGlvbiB2YXJzCiAgICAgICAgcGFydHMsCiAgICAgICAgLy8gVG8ga25vdyBpZiBnbG9iYWwgZXZlbnRzIGFyZSB0byBiZSBkaXNwYXRjaGVkCiAgICAgICAgZmlyZUdsb2JhbHMsCiAgICAgICAgLy8gTG9vcCB2YXJpYWJsZQogICAgICAgIGksCiAgICAgICAgLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdAogICAgICAgIHMgPSBqUXVlcnkuYWpheFNldHVwKHt9LCBvcHRpb25zKSwKICAgICAgICAvLyBDYWxsYmFja3MgY29udGV4dAogICAgICAgIGNhbGxiYWNrQ29udGV4dCA9IHMuY29udGV4dCB8fCBzLAogICAgICAgIC8vIENvbnRleHQgZm9yIGdsb2JhbCBldmVudHMgaXMgY2FsbGJhY2tDb250ZXh0IGlmIGl0IGlzIGEgRE9NIG5vZGUgb3IgalF1ZXJ5IGNvbGxlY3Rpb24KICAgICAgICBnbG9iYWxFdmVudENvbnRleHQgPSBzLmNvbnRleHQgJiYgKGNhbGxiYWNrQ29udGV4dC5ub2RlVHlwZSB8fCBjYWxsYmFja0NvbnRleHQuanF1ZXJ5KSA/IGpRdWVyeShjYWxsYmFja0NvbnRleHQpIDogalF1ZXJ5LmV2ZW50LAogICAgICAgIC8vIERlZmVycmVkcwogICAgICAgIGRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksIGNvbXBsZXRlRGVmZXJyZWQgPSBqUXVlcnkuQ2FsbGJhY2tzKCdvbmNlIG1lbW9yeScpLAogICAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgICAgc3RhdHVzQ29kZSA9IHMuc3RhdHVzQ29kZSB8fCB7fSwKICAgICAgICAvLyBIZWFkZXJzICh0aGV5IGFyZSBzZW50IGFsbCBhdCBvbmNlKQogICAgICAgIHJlcXVlc3RIZWFkZXJzID0ge30sIHJlcXVlc3RIZWFkZXJzTmFtZXMgPSB7fSwKICAgICAgICAvLyBUaGUganFYSFIgc3RhdGUKICAgICAgICBzdGF0ZSA9IDAsCiAgICAgICAgLy8gRGVmYXVsdCBhYm9ydCBtZXNzYWdlCiAgICAgICAgc3RyQWJvcnQgPSAnY2FuY2VsZWQnLAogICAgICAgIC8vIEZha2UgeGhyCiAgICAgICAganFYSFIgPSB7CiAgICAgICAgICByZWFkeVN0YXRlOiAwLAogICAgICAgICAgLy8gQnVpbGRzIGhlYWRlcnMgaGFzaHRhYmxlIGlmIG5lZWRlZAogICAgICAgICAgZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgdmFyIG1hdGNoOwogICAgICAgICAgICBpZiAoc3RhdGUgPT09IDIpIHsKICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzID0ge307CiAgICAgICAgICAgICAgICB3aGlsZSAobWF0Y2ggPSByaGVhZGVycy5leGVjKHJlc3BvbnNlSGVhZGVyc1N0cmluZykpIHsKICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzW21hdGNoWzFdLnRvTG93ZXJDYXNlKCldID0gbWF0Y2hbMl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG1hdGNoID0gcmVzcG9uc2VIZWFkZXJzW2tleS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWF0Y2ggPT0gbnVsbCA/IG51bGwgOiBtYXRjaDsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBSYXcgc3RyaW5nCiAgICAgICAgICBnZXRBbGxSZXNwb25zZUhlYWRlcnM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHN0YXRlID09PSAyID8gcmVzcG9uc2VIZWFkZXJzU3RyaW5nIDogbnVsbDsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBDYWNoZXMgdGhlIGhlYWRlcgogICAgICAgICAgc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBsbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgaWYgKCFzdGF0ZSkgewogICAgICAgICAgICAgIG5hbWUgPSByZXF1ZXN0SGVhZGVyc05hbWVzW2xuYW1lXSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbbG5hbWVdIHx8IG5hbWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBPdmVycmlkZXMgcmVzcG9uc2UgY29udGVudC10eXBlIGhlYWRlcgogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgaWYgKCFzdGF0ZSkgewogICAgICAgICAgICAgIHMubWltZVR5cGUgPSB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgICAgICBzdGF0dXNDb2RlOiBmdW5jdGlvbiAobWFwKSB7CiAgICAgICAgICAgIHZhciBjb2RlOwogICAgICAgICAgICBpZiAobWFwKSB7CiAgICAgICAgICAgICAgaWYgKHN0YXRlIDwgMikgewogICAgICAgICAgICAgICAgZm9yIChjb2RlIGluIG1hcCkgewogICAgICAgICAgICAgICAgICAvLyBMYXp5LWFkZCB0aGUgbmV3IGNhbGxiYWNrIGluIGEgd2F5IHRoYXQgcHJlc2VydmVzIG9sZCBvbmVzCiAgICAgICAgICAgICAgICAgIHN0YXR1c0NvZGVbY29kZV0gPSBbCiAgICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZVtjb2RlXSwKICAgICAgICAgICAgICAgICAgICBtYXBbY29kZV0KICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRXhlY3V0ZSB0aGUgYXBwcm9wcmlhdGUgY2FsbGJhY2tzCiAgICAgICAgICAgICAgICBqcVhIUi5hbHdheXMobWFwW2pxWEhSLnN0YXR1c10pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBDYW5jZWwgdGhlIHJlcXVlc3QKICAgICAgICAgIGFib3J0OiBmdW5jdGlvbiAoc3RhdHVzVGV4dCkgewogICAgICAgICAgICB2YXIgZmluYWxUZXh0ID0gc3RhdHVzVGV4dCB8fCBzdHJBYm9ydDsKICAgICAgICAgICAgaWYgKHRyYW5zcG9ydCkgewogICAgICAgICAgICAgIHRyYW5zcG9ydC5hYm9ydChmaW5hbFRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvbmUoMCwgZmluYWxUZXh0KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgLy8gQXR0YWNoIGRlZmVycmVkcwogICAgICBkZWZlcnJlZC5wcm9taXNlKGpxWEhSKS5jb21wbGV0ZSA9IGNvbXBsZXRlRGVmZXJyZWQuYWRkOwogICAgICBqcVhIUi5zdWNjZXNzID0ganFYSFIuZG9uZTsKICAgICAganFYSFIuZXJyb3IgPSBqcVhIUi5mYWlsOwogICAgICAvLyBSZW1vdmUgaGFzaCBjaGFyYWN0ZXIgKCM3NTMxOiBhbmQgc3RyaW5nIHByb21vdGlvbikKICAgICAgLy8gQWRkIHByb3RvY29sIGlmIG5vdCBwcm92aWRlZCAocHJlZmlsdGVycyBtaWdodCBleHBlY3QgaXQpCiAgICAgIC8vIEhhbmRsZSBmYWxzeSB1cmwgaW4gdGhlIHNldHRpbmdzIG9iamVjdCAoIzEwMDkzOiBjb25zaXN0ZW5jeSB3aXRoIG9sZCBzaWduYXR1cmUpCiAgICAgIC8vIFdlIGFsc28gdXNlIHRoZSB1cmwgcGFyYW1ldGVyIGlmIGF2YWlsYWJsZQogICAgICBzLnVybCA9ICgodXJsIHx8IHMudXJsIHx8IGFqYXhMb2NhdGlvbikgKyAnJykucmVwbGFjZShyaGFzaCwgJycpLnJlcGxhY2UocnByb3RvY29sLCBhamF4TG9jUGFydHNbMV0gKyAnLy8nKTsKICAgICAgLy8gQWxpYXMgbWV0aG9kIG9wdGlvbiB0byB0eXBlIGFzIHBlciB0aWNrZXQgIzEyMDA0CiAgICAgIHMudHlwZSA9IG9wdGlvbnMubWV0aG9kIHx8IG9wdGlvbnMudHlwZSB8fCBzLm1ldGhvZCB8fCBzLnR5cGU7CiAgICAgIC8vIEV4dHJhY3QgZGF0YVR5cGVzIGxpc3QKICAgICAgcy5kYXRhVHlwZXMgPSBqUXVlcnkudHJpbShzLmRhdGFUeXBlIHx8ICcqJykudG9Mb3dlckNhc2UoKS5tYXRjaChybm90d2hpdGUpIHx8IFsnJ107CiAgICAgIC8vIEEgY3Jvc3MtZG9tYWluIHJlcXVlc3QgaXMgaW4gb3JkZXIgd2hlbiB3ZSBoYXZlIGEgcHJvdG9jb2w6aG9zdDpwb3J0IG1pc21hdGNoCiAgICAgIGlmIChzLmNyb3NzRG9tYWluID09IG51bGwpIHsKICAgICAgICBwYXJ0cyA9IHJ1cmwuZXhlYyhzLnVybC50b0xvd2VyQ2FzZSgpKTsKICAgICAgICBzLmNyb3NzRG9tYWluID0gISEocGFydHMgJiYgKHBhcnRzWzFdICE9PSBhamF4TG9jUGFydHNbMV0gfHwgcGFydHNbMl0gIT09IGFqYXhMb2NQYXJ0c1syXSB8fCAocGFydHNbM10gfHwgKHBhcnRzWzFdID09PSAnaHR0cDonID8gJzgwJyA6ICc0NDMnKSkgIT09IChhamF4TG9jUGFydHNbM10gfHwgKGFqYXhMb2NQYXJ0c1sxXSA9PT0gJ2h0dHA6JyA/ICc4MCcgOiAnNDQzJykpKSk7CiAgICAgIH0KICAgICAgLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCiAgICAgIGlmIChzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAnc3RyaW5nJykgewogICAgICAgIHMuZGF0YSA9IGpRdWVyeS5wYXJhbShzLmRhdGEsIHMudHJhZGl0aW9uYWwpOwogICAgICB9CiAgICAgIC8vIEFwcGx5IHByZWZpbHRlcnMKICAgICAgaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMocHJlZmlsdGVycywgcywgb3B0aW9ucywganFYSFIpOwogICAgICAvLyBJZiByZXF1ZXN0IHdhcyBhYm9ydGVkIGluc2lkZSBhIHByZWZpbHRlciwgc3RvcCB0aGVyZQogICAgICBpZiAoc3RhdGUgPT09IDIpIHsKICAgICAgICByZXR1cm4ganFYSFI7CiAgICAgIH0KICAgICAgLy8gV2UgY2FuIGZpcmUgZ2xvYmFsIGV2ZW50cyBhcyBvZiBub3cgaWYgYXNrZWQgdG8KICAgICAgZmlyZUdsb2JhbHMgPSBzLmdsb2JhbDsKICAgICAgLy8gV2F0Y2ggZm9yIGEgbmV3IHNldCBvZiByZXF1ZXN0cwogICAgICBpZiAoZmlyZUdsb2JhbHMgJiYgalF1ZXJ5LmFjdGl2ZSsrID09PSAwKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoJ2FqYXhTdGFydCcpOwogICAgICB9CiAgICAgIC8vIFVwcGVyY2FzZSB0aGUgdHlwZQogICAgICBzLnR5cGUgPSBzLnR5cGUudG9VcHBlckNhc2UoKTsKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHJlcXVlc3QgaGFzIGNvbnRlbnQKICAgICAgcy5oYXNDb250ZW50ID0gIXJub0NvbnRlbnQudGVzdChzLnR5cGUpOwogICAgICAvLyBTYXZlIHRoZSBVUkwgaW4gY2FzZSB3ZSdyZSB0b3lpbmcgd2l0aCB0aGUgSWYtTW9kaWZpZWQtU2luY2UKICAgICAgLy8gYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyIGxhdGVyIG9uCiAgICAgIGNhY2hlVVJMID0gcy51cmw7CiAgICAgIC8vIE1vcmUgb3B0aW9ucyBoYW5kbGluZyBmb3IgcmVxdWVzdHMgd2l0aCBubyBjb250ZW50CiAgICAgIGlmICghcy5oYXNDb250ZW50KSB7CiAgICAgICAgLy8gSWYgZGF0YSBpcyBhdmFpbGFibGUsIGFwcGVuZCBkYXRhIHRvIHVybAogICAgICAgIGlmIChzLmRhdGEpIHsKICAgICAgICAgIGNhY2hlVVJMID0gcy51cmwgKz0gKHJxdWVyeS50ZXN0KGNhY2hlVVJMKSA/ICcmJyA6ICc/JykgKyBzLmRhdGE7CiAgICAgICAgICAvLyAjOTY4MjogcmVtb3ZlIGRhdGEgc28gdGhhdCBpdCdzIG5vdCB1c2VkIGluIGFuIGV2ZW50dWFsIHJldHJ5CiAgICAgICAgICBkZWxldGUgcy5kYXRhOwogICAgICAgIH0KICAgICAgICAvLyBBZGQgYW50aS1jYWNoZSBpbiB1cmwgaWYgbmVlZGVkCiAgICAgICAgaWYgKHMuY2FjaGUgPT09IGZhbHNlKSB7CiAgICAgICAgICBzLnVybCA9IHJ0cy50ZXN0KGNhY2hlVVJMKSA/IC8vIElmIHRoZXJlIGlzIGFscmVhZHkgYSAnXycgcGFyYW1ldGVyLCBzZXQgaXRzIHZhbHVlCiAgICAgICAgICBjYWNoZVVSTC5yZXBsYWNlKHJ0cywgJyQxXz0nICsgbm9uY2UrKykgOiAvLyBPdGhlcndpc2UgYWRkIG9uZSB0byB0aGUgZW5kCiAgICAgICAgICBjYWNoZVVSTCArIChycXVlcnkudGVzdChjYWNoZVVSTCkgPyAnJicgOiAnPycpICsgJ189JyArIG5vbmNlKys7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCiAgICAgIGlmIChzLmlmTW9kaWZpZWQpIHsKICAgICAgICBpZiAoalF1ZXJ5Lmxhc3RNb2RpZmllZFtjYWNoZVVSTF0pIHsKICAgICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoJ0lmLU1vZGlmaWVkLVNpbmNlJywgalF1ZXJ5Lmxhc3RNb2RpZmllZFtjYWNoZVVSTF0pOwogICAgICAgIH0KICAgICAgICBpZiAoalF1ZXJ5LmV0YWdbY2FjaGVVUkxdKSB7CiAgICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCdJZi1Ob25lLU1hdGNoJywgalF1ZXJ5LmV0YWdbY2FjaGVVUkxdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CiAgICAgIGlmIChzLmRhdGEgJiYgcy5oYXNDb250ZW50ICYmIHMuY29udGVudFR5cGUgIT09IGZhbHNlIHx8IG9wdGlvbnMuY29udGVudFR5cGUpIHsKICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCBzLmNvbnRlbnRUeXBlKTsKICAgICAgfQogICAgICAvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlCiAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoJ0FjY2VwdCcsIHMuZGF0YVR5cGVzWzBdICYmIHMuYWNjZXB0c1tzLmRhdGFUeXBlc1swXV0gPyBzLmFjY2VwdHNbcy5kYXRhVHlwZXNbMF1dICsgKHMuZGF0YVR5cGVzWzBdICE9PSAnKicgPyAnLCAnICsgYWxsVHlwZXMgKyAnOyBxPTAuMDEnIDogJycpIDogcy5hY2NlcHRzWycqJ10pOwogICAgICAvLyBDaGVjayBmb3IgaGVhZGVycyBvcHRpb24KICAgICAgZm9yIChpIGluIHMuaGVhZGVycykgewogICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoaSwgcy5oZWFkZXJzW2ldKTsKICAgICAgfQogICAgICAvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0CiAgICAgIGlmIChzLmJlZm9yZVNlbmQgJiYgKHMuYmVmb3JlU2VuZC5jYWxsKGNhbGxiYWNrQ29udGV4dCwganFYSFIsIHMpID09PSBmYWxzZSB8fCBzdGF0ZSA9PT0gMikpIHsKICAgICAgICAvLyBBYm9ydCBpZiBub3QgZG9uZSBhbHJlYWR5IGFuZCByZXR1cm4KICAgICAgICByZXR1cm4ganFYSFIuYWJvcnQoKTsKICAgICAgfQogICAgICAvLyBhYm9ydGluZyBpcyBubyBsb25nZXIgYSBjYW5jZWxsYXRpb24KICAgICAgc3RyQWJvcnQgPSAnYWJvcnQnOwogICAgICAvLyBJbnN0YWxsIGNhbGxiYWNrcyBvbiBkZWZlcnJlZHMKICAgICAgZm9yIChpIGluIHsKICAgICAgICAgIHN1Y2Nlc3M6IDEsCiAgICAgICAgICBlcnJvcjogMSwKICAgICAgICAgIGNvbXBsZXRlOiAxCiAgICAgICAgfSkgewogICAgICAgIGpxWEhSW2ldKHNbaV0pOwogICAgICB9CiAgICAgIC8vIEdldCB0cmFuc3BvcnQKICAgICAgdHJhbnNwb3J0ID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHModHJhbnNwb3J0cywgcywgb3B0aW9ucywganFYSFIpOwogICAgICAvLyBJZiBubyB0cmFuc3BvcnQsIHdlIGF1dG8tYWJvcnQKICAgICAgaWYgKCF0cmFuc3BvcnQpIHsKICAgICAgICBkb25lKC0xLCAnTm8gVHJhbnNwb3J0Jyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAganFYSFIucmVhZHlTdGF0ZSA9IDE7CiAgICAgICAgLy8gU2VuZCBnbG9iYWwgZXZlbnQKICAgICAgICBpZiAoZmlyZUdsb2JhbHMpIHsKICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCdhamF4U2VuZCcsIFsKICAgICAgICAgICAganFYSFIsCiAgICAgICAgICAgIHMKICAgICAgICAgIF0pOwogICAgICAgIH0KICAgICAgICAvLyBUaW1lb3V0CiAgICAgICAgaWYgKHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCkgewogICAgICAgICAgdGltZW91dFRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGpxWEhSLmFib3J0KCd0aW1lb3V0Jyk7CiAgICAgICAgICB9LCBzLnRpbWVvdXQpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgc3RhdGUgPSAxOwogICAgICAgICAgdHJhbnNwb3J0LnNlbmQocmVxdWVzdEhlYWRlcnMsIGRvbmUpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIC8vIFByb3BhZ2F0ZSBleGNlcHRpb24gYXMgZXJyb3IgaWYgbm90IGRvbmUKICAgICAgICAgIGlmIChzdGF0ZSA8IDIpIHsKICAgICAgICAgICAgZG9uZSgtMSwgZSk7ICAvLyBTaW1wbHkgcmV0aHJvdyBvdGhlcndpc2UKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIENhbGxiYWNrIGZvciB3aGVuIGV2ZXJ5dGhpbmcgaXMgZG9uZQogICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzKSB7CiAgICAgICAgdmFyIGlzU3VjY2Vzcywgc3VjY2VzcywgZXJyb3IsIHJlc3BvbnNlLCBtb2RpZmllZCwgc3RhdHVzVGV4dCA9IG5hdGl2ZVN0YXR1c1RleHQ7CiAgICAgICAgLy8gQ2FsbGVkIG9uY2UKICAgICAgICBpZiAoc3RhdGUgPT09IDIpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gU3RhdGUgaXMgImRvbmUiIG5vdwogICAgICAgIHN0YXRlID0gMjsKICAgICAgICAvLyBDbGVhciB0aW1lb3V0IGlmIGl0IGV4aXN0cwogICAgICAgIGlmICh0aW1lb3V0VGltZXIpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0VGltZXIpOwogICAgICAgIH0KICAgICAgICAvLyBEZXJlZmVyZW5jZSB0cmFuc3BvcnQgZm9yIGVhcmx5IGdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgIC8vIChubyBtYXR0ZXIgaG93IGxvbmcgdGhlIGpxWEhSIG9iamVjdCB3aWxsIGJlIHVzZWQpCiAgICAgICAgdHJhbnNwb3J0ID0gdW5kZWZpbmVkOwogICAgICAgIC8vIENhY2hlIHJlc3BvbnNlIGhlYWRlcnMKICAgICAgICByZXNwb25zZUhlYWRlcnNTdHJpbmcgPSBoZWFkZXJzIHx8ICcnOwogICAgICAgIC8vIFNldCByZWFkeVN0YXRlCiAgICAgICAganFYSFIucmVhZHlTdGF0ZSA9IHN0YXR1cyA+IDAgPyA0IDogMDsKICAgICAgICAvLyBEZXRlcm1pbmUgaWYgc3VjY2Vzc2Z1bAogICAgICAgIGlzU3VjY2VzcyA9IHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0OwogICAgICAgIC8vIEdldCByZXNwb25zZSBkYXRhCiAgICAgICAgaWYgKHJlc3BvbnNlcykgewogICAgICAgICAgcmVzcG9uc2UgPSBhamF4SGFuZGxlUmVzcG9uc2VzKHMsIGpxWEhSLCByZXNwb25zZXMpOwogICAgICAgIH0KICAgICAgICAvLyBDb252ZXJ0IG5vIG1hdHRlciB3aGF0ICh0aGF0IHdheSByZXNwb25zZVhYWCBmaWVsZHMgYXJlIGFsd2F5cyBzZXQpCiAgICAgICAgcmVzcG9uc2UgPSBhamF4Q29udmVydChzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2Vzcyk7CiAgICAgICAgLy8gSWYgc3VjY2Vzc2Z1bCwgaGFuZGxlIHR5cGUgY2hhaW5pbmcKICAgICAgICBpZiAoaXNTdWNjZXNzKSB7CiAgICAgICAgICAvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgogICAgICAgICAgaWYgKHMuaWZNb2RpZmllZCkgewogICAgICAgICAgICBtb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCdMYXN0LU1vZGlmaWVkJyk7CiAgICAgICAgICAgIGlmIChtb2RpZmllZCkgewogICAgICAgICAgICAgIGpRdWVyeS5sYXN0TW9kaWZpZWRbY2FjaGVVUkxdID0gbW9kaWZpZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcignZXRhZycpOwogICAgICAgICAgICBpZiAobW9kaWZpZWQpIHsKICAgICAgICAgICAgICBqUXVlcnkuZXRhZ1tjYWNoZVVSTF0gPSBtb2RpZmllZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gaWYgbm8gY29udGVudAogICAgICAgICAgaWYgKHN0YXR1cyA9PT0gMjA0IHx8IHMudHlwZSA9PT0gJ0hFQUQnKSB7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAnbm9jb250ZW50JzsgIC8vIGlmIG5vdCBtb2RpZmllZAogICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IDMwNCkgewogICAgICAgICAgICBzdGF0dXNUZXh0ID0gJ25vdG1vZGlmaWVkJzsgIC8vIElmIHdlIGhhdmUgZGF0YSwgbGV0J3MgY29udmVydCBpdAogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9IHJlc3BvbnNlLnN0YXRlOwogICAgICAgICAgICBzdWNjZXNzID0gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgICAgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgICAgICAgICAgaXNTdWNjZXNzID0gIWVycm9yOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBXZSBleHRyYWN0IGVycm9yIGZyb20gc3RhdHVzVGV4dAogICAgICAgICAgLy8gdGhlbiBub3JtYWxpemUgc3RhdHVzVGV4dCBhbmQgc3RhdHVzIGZvciBub24tYWJvcnRzCiAgICAgICAgICBlcnJvciA9IHN0YXR1c1RleHQ7CiAgICAgICAgICBpZiAoc3RhdHVzIHx8ICFzdGF0dXNUZXh0KSB7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAnZXJyb3InOwogICAgICAgICAgICBpZiAoc3RhdHVzIDwgMCkgewogICAgICAgICAgICAgIHN0YXR1cyA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gU2V0IGRhdGEgZm9yIHRoZSBmYWtlIHhociBvYmplY3QKICAgICAgICBqcVhIUi5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAganFYSFIuc3RhdHVzVGV4dCA9IChuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQpICsgJyc7CiAgICAgICAgLy8gU3VjY2Vzcy9FcnJvcgogICAgICAgIGlmIChpc1N1Y2Nlc3MpIHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKGNhbGxiYWNrQ29udGV4dCwgWwogICAgICAgICAgICBzdWNjZXNzLAogICAgICAgICAgICBzdGF0dXNUZXh0LAogICAgICAgICAgICBqcVhIUgogICAgICAgICAgXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdFdpdGgoY2FsbGJhY2tDb250ZXh0LCBbCiAgICAgICAgICAgIGpxWEhSLAogICAgICAgICAgICBzdGF0dXNUZXh0LAogICAgICAgICAgICBlcnJvcgogICAgICAgICAgXSk7CiAgICAgICAgfQogICAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgICAganFYSFIuc3RhdHVzQ29kZShzdGF0dXNDb2RlKTsKICAgICAgICBzdGF0dXNDb2RlID0gdW5kZWZpbmVkOwogICAgICAgIGlmIChmaXJlR2xvYmFscykgewogICAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoaXNTdWNjZXNzID8gJ2FqYXhTdWNjZXNzJyA6ICdhamF4RXJyb3InLCBbCiAgICAgICAgICAgIGpxWEhSLAogICAgICAgICAgICBzLAogICAgICAgICAgICBpc1N1Y2Nlc3MgPyBzdWNjZXNzIDogZXJyb3IKICAgICAgICAgIF0pOwogICAgICAgIH0KICAgICAgICAvLyBDb21wbGV0ZQogICAgICAgIGNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoY2FsbGJhY2tDb250ZXh0LCBbCiAgICAgICAgICBqcVhIUiwKICAgICAgICAgIHN0YXR1c1RleHQKICAgICAgICBdKTsKICAgICAgICBpZiAoZmlyZUdsb2JhbHMpIHsKICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCdhamF4Q29tcGxldGUnLCBbCiAgICAgICAgICAgIGpxWEhSLAogICAgICAgICAgICBzCiAgICAgICAgICBdKTsKICAgICAgICAgIC8vIEhhbmRsZSB0aGUgZ2xvYmFsIEFKQVggY291bnRlcgogICAgICAgICAgaWYgKCEtLWpRdWVyeS5hY3RpdmUpIHsKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoJ2FqYXhTdG9wJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBqcVhIUjsKICAgIH0sCiAgICBnZXRKU09OOiBmdW5jdGlvbiAodXJsLCBkYXRhLCBjYWxsYmFjaykgewogICAgICByZXR1cm4galF1ZXJ5LmdldCh1cmwsIGRhdGEsIGNhbGxiYWNrLCAnanNvbicpOwogICAgfSwKICAgIGdldFNjcmlwdDogZnVuY3Rpb24gKHVybCwgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIGpRdWVyeS5nZXQodXJsLCB1bmRlZmluZWQsIGNhbGxiYWNrLCAnc2NyaXB0Jyk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goWwogICAgJ2dldCcsCiAgICAncG9zdCcKICBdLCBmdW5jdGlvbiAoaSwgbWV0aG9kKSB7CiAgICBqUXVlcnlbbWV0aG9kXSA9IGZ1bmN0aW9uICh1cmwsIGRhdGEsIGNhbGxiYWNrLCB0eXBlKSB7CiAgICAgIC8vIHNoaWZ0IGFyZ3VtZW50cyBpZiBkYXRhIGFyZ3VtZW50IHdhcyBvbWl0dGVkCiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihkYXRhKSkgewogICAgICAgIHR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwogICAgICAgIGNhbGxiYWNrID0gZGF0YTsKICAgICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIHJldHVybiBqUXVlcnkuYWpheCh7CiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgdHlwZTogbWV0aG9kLAogICAgICAgIGRhdGFUeXBlOiB0eXBlLAogICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgc3VjY2VzczogY2FsbGJhY2sKICAgICAgfSk7CiAgICB9OwogIH0pOwogIC8vIEF0dGFjaCBhIGJ1bmNoIG9mIGZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgY29tbW9uIEFKQVggZXZlbnRzCiAgalF1ZXJ5LmVhY2goWwogICAgJ2FqYXhTdGFydCcsCiAgICAnYWpheFN0b3AnLAogICAgJ2FqYXhDb21wbGV0ZScsCiAgICAnYWpheEVycm9yJywKICAgICdhamF4U3VjY2VzcycsCiAgICAnYWpheFNlbmQnCiAgXSwgZnVuY3Rpb24gKGksIHR5cGUpIHsKICAgIGpRdWVyeS5mblt0eXBlXSA9IGZ1bmN0aW9uIChmbikgewogICAgICByZXR1cm4gdGhpcy5vbih0eXBlLCBmbik7CiAgICB9OwogIH0pOwogIGpRdWVyeS5fZXZhbFVybCA9IGZ1bmN0aW9uICh1cmwpIHsKICAgIHJldHVybiBqUXVlcnkuYWpheCh7CiAgICAgIHVybDogdXJsLAogICAgICB0eXBlOiAnR0VUJywKICAgICAgZGF0YVR5cGU6ICdzY3JpcHQnLAogICAgICBhc3luYzogZmFsc2UsCiAgICAgIGdsb2JhbDogZmFsc2UsCiAgICAgICd0aHJvd3MnOiB0cnVlCiAgICB9KTsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgd3JhcEFsbDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdmFyIHdyYXA7CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihodG1sKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS53cmFwQWxsKGh0bWwuY2FsbCh0aGlzLCBpKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHRoaXNbMF0pIHsKICAgICAgICAvLyBUaGUgZWxlbWVudHMgdG8gd3JhcCB0aGUgdGFyZ2V0IGFyb3VuZAogICAgICAgIHdyYXAgPSBqUXVlcnkoaHRtbCwgdGhpc1swXS5vd25lckRvY3VtZW50KS5lcSgwKS5jbG9uZSh0cnVlKTsKICAgICAgICBpZiAodGhpc1swXS5wYXJlbnROb2RlKSB7CiAgICAgICAgICB3cmFwLmluc2VydEJlZm9yZSh0aGlzWzBdKTsKICAgICAgICB9CiAgICAgICAgd3JhcC5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGVsZW0gPSB0aGlzOwogICAgICAgICAgd2hpbGUgKGVsZW0uZmlyc3RFbGVtZW50Q2hpbGQpIHsKICAgICAgICAgICAgZWxlbSA9IGVsZW0uZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbTsKICAgICAgICB9KS5hcHBlbmQodGhpcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgd3JhcElubmVyOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oaHRtbCkpIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykud3JhcElubmVyKGh0bWwuY2FsbCh0aGlzLCBpKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHNlbGYgPSBqUXVlcnkodGhpcyksIGNvbnRlbnRzID0gc2VsZi5jb250ZW50cygpOwogICAgICAgIGlmIChjb250ZW50cy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnRlbnRzLndyYXBBbGwoaHRtbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuYXBwZW5kKGh0bWwpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgd3JhcDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdmFyIGlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbihodG1sKTsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgIGpRdWVyeSh0aGlzKS53cmFwQWxsKGlzRnVuY3Rpb24gPyBodG1sLmNhbGwodGhpcywgaSkgOiBodG1sKTsKICAgICAgfSk7CiAgICB9LAogICAgdW53cmFwOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnBhcmVudCgpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghalF1ZXJ5Lm5vZGVOYW1lKHRoaXMsICdib2R5JykpIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS5yZXBsYWNlV2l0aCh0aGlzLmNoaWxkTm9kZXMpOwogICAgICAgIH0KICAgICAgfSkuZW5kKCk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4gPSBmdW5jdGlvbiAoZWxlbSkgewogICAgLy8gU3VwcG9ydDogT3BlcmEgPD0gMTIuMTIKICAgIC8vIE9wZXJhIHJlcG9ydHMgb2Zmc2V0V2lkdGhzIGFuZCBvZmZzZXRIZWlnaHRzIGxlc3MgdGhhbiB6ZXJvIG9uIHNvbWUgZWxlbWVudHMKICAgIHJldHVybiBlbGVtLm9mZnNldFdpZHRoIDw9IDAgJiYgZWxlbS5vZmZzZXRIZWlnaHQgPD0gMDsKICB9OwogIGpRdWVyeS5leHByLmZpbHRlcnMudmlzaWJsZSA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICByZXR1cm4gIWpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuKGVsZW0pOwogIH07CiAgdmFyIHIyMCA9IC8lMjAvZywgcmJyYWNrZXQgPSAvXFtcXSQvLCByQ1JMRiA9IC9ccj9cbi9nLCByc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXR8ZmlsZSkkL2ksIHJzdWJtaXR0YWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGtleWdlbikvaTsKICBmdW5jdGlvbiBidWlsZFBhcmFtcyhwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCkgewogICAgdmFyIG5hbWU7CiAgICBpZiAoalF1ZXJ5LmlzQXJyYXkob2JqKSkgewogICAgICAvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KICAgICAgalF1ZXJ5LmVhY2gob2JqLCBmdW5jdGlvbiAoaSwgdikgewogICAgICAgIGlmICh0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KHByZWZpeCkpIHsKICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgIGFkZChwcmVmaXgsIHYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBJdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMgbnVtZXJpYyBpbmRleC4KICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICdbJyArICh0eXBlb2YgdiA9PT0gJ29iamVjdCcgPyBpIDogJycpICsgJ10nLCB2LCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIGlmICghdHJhZGl0aW9uYWwgJiYgalF1ZXJ5LnR5cGUob2JqKSA9PT0gJ29iamVjdCcpIHsKICAgICAgLy8gU2VyaWFsaXplIG9iamVjdCBpdGVtLgogICAgICBmb3IgKG5hbWUgaW4gb2JqKSB7CiAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgJ1snICsgbmFtZSArICddJywgb2JqW25hbWVdLCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgogICAgICBhZGQocHJlZml4LCBvYmopOwogICAgfQogIH0KICAvLyBTZXJpYWxpemUgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cyBvciBhIHNldCBvZgogIC8vIGtleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwogIGpRdWVyeS5wYXJhbSA9IGZ1bmN0aW9uIChhLCB0cmFkaXRpb25hbCkgewogICAgdmFyIHByZWZpeCwgcyA9IFtdLCBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIC8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgcmV0dXJuIGl0cyB2YWx1ZQogICAgICAgIHZhbHVlID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlID09IG51bGwgPyAnJyA6IHZhbHVlOwogICAgICAgIHNbcy5sZW5ndGhdID0gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICB9OwogICAgLy8gU2V0IHRyYWRpdGlvbmFsIHRvIHRydWUgZm9yIGpRdWVyeSA8PSAxLjMuMiBiZWhhdmlvci4KICAgIGlmICh0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRyYWRpdGlvbmFsID0galF1ZXJ5LmFqYXhTZXR0aW5ncyAmJiBqUXVlcnkuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsOwogICAgfQogICAgLy8gSWYgYW4gYXJyYXkgd2FzIHBhc3NlZCBpbiwgYXNzdW1lIHRoYXQgaXQgaXMgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cy4KICAgIGlmIChqUXVlcnkuaXNBcnJheShhKSB8fCBhLmpxdWVyeSAmJiAhalF1ZXJ5LmlzUGxhaW5PYmplY3QoYSkpIHsKICAgICAgLy8gU2VyaWFsaXplIHRoZSBmb3JtIGVsZW1lbnRzCiAgICAgIGpRdWVyeS5lYWNoKGEsIGZ1bmN0aW9uICgpIHsKICAgICAgICBhZGQodGhpcy5uYW1lLCB0aGlzLnZhbHVlKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICAvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKICAgICAgLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCiAgICAgIGZvciAocHJlZml4IGluIGEpIHsKICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXgsIGFbcHJlZml4XSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgIH0KICAgIH0KICAgIC8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KICAgIHJldHVybiBzLmpvaW4oJyYnKS5yZXBsYWNlKHIyMCwgJysnKTsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgc2VyaWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBqUXVlcnkucGFyYW0odGhpcy5zZXJpYWxpemVBcnJheSgpKTsKICAgIH0sCiAgICBzZXJpYWxpemVBcnJheTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIENhbiBhZGQgcHJvcEhvb2sgZm9yICJlbGVtZW50cyIgdG8gZmlsdGVyIG9yIGFkZCBmb3JtIGVsZW1lbnRzCiAgICAgICAgdmFyIGVsZW1lbnRzID0galF1ZXJ5LnByb3AodGhpcywgJ2VsZW1lbnRzJyk7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRzID8galF1ZXJ5Lm1ha2VBcnJheShlbGVtZW50cykgOiB0aGlzOwogICAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0eXBlID0gdGhpcy50eXBlOwogICAgICAgIC8vIFVzZSAuaXMoICI6ZGlzYWJsZWQiICkgc28gdGhhdCBmaWVsZHNldFtkaXNhYmxlZF0gd29ya3MKICAgICAgICByZXR1cm4gdGhpcy5uYW1lICYmICFqUXVlcnkodGhpcykuaXMoJzpkaXNhYmxlZCcpICYmIHJzdWJtaXR0YWJsZS50ZXN0KHRoaXMubm9kZU5hbWUpICYmICFyc3VibWl0dGVyVHlwZXMudGVzdCh0eXBlKSAmJiAodGhpcy5jaGVja2VkIHx8ICFyY2hlY2thYmxlVHlwZS50ZXN0KHR5cGUpKTsKICAgICAgfSkubWFwKGZ1bmN0aW9uIChpLCBlbGVtKSB7CiAgICAgICAgdmFyIHZhbCA9IGpRdWVyeSh0aGlzKS52YWwoKTsKICAgICAgICByZXR1cm4gdmFsID09IG51bGwgPyBudWxsIDogalF1ZXJ5LmlzQXJyYXkodmFsKSA/IGpRdWVyeS5tYXAodmFsLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBuYW1lOiBlbGVtLm5hbWUsCiAgICAgICAgICAgIHZhbHVlOiB2YWwucmVwbGFjZShyQ1JMRiwgJ1xyXG4nKQogICAgICAgICAgfTsKICAgICAgICB9KSA6IHsKICAgICAgICAgIG5hbWU6IGVsZW0ubmFtZSwKICAgICAgICAgIHZhbHVlOiB2YWwucmVwbGFjZShyQ1JMRiwgJ1xyXG4nKQogICAgICAgIH07CiAgICAgIH0pLmdldCgpOwogICAgfQogIH0pOwogIGpRdWVyeS5hamF4U2V0dGluZ3MueGhyID0gZnVuY3Rpb24gKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgfSBjYXRjaCAoZSkgewogICAgfQogIH07CiAgdmFyIHhocklkID0gMCwgeGhyQ2FsbGJhY2tzID0ge30sIHhoclN1Y2Nlc3NTdGF0dXMgPSB7CiAgICAgIC8vIGZpbGUgcHJvdG9jb2wgYWx3YXlzIHlpZWxkcyBzdGF0dXMgY29kZSAwLCBhc3N1bWUgMjAwCiAgICAgIDA6IDIwMCwKICAgICAgLy8gU3VwcG9ydDogSUU5CiAgICAgIC8vICMxNDUwOiBzb21ldGltZXMgSUUgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAogICAgICAxMjIzOiAyMDQKICAgIH0sIHhoclN1cHBvcnRlZCA9IGpRdWVyeS5hamF4U2V0dGluZ3MueGhyKCk7CiAgLy8gU3VwcG9ydDogSUU5CiAgLy8gT3BlbiByZXF1ZXN0cyBtdXN0IGJlIG1hbnVhbGx5IGFib3J0ZWQgb24gdW5sb2FkICgjNTI4MCkKICBpZiAod2luZG93LkFjdGl2ZVhPYmplY3QpIHsKICAgIGpRdWVyeSh3aW5kb3cpLm9uKCd1bmxvYWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiB4aHJDYWxsYmFja3MpIHsKICAgICAgICB4aHJDYWxsYmFja3Nba2V5XSgpOwogICAgICB9CiAgICB9KTsKICB9CiAgc3VwcG9ydC5jb3JzID0gISF4aHJTdXBwb3J0ZWQgJiYgJ3dpdGhDcmVkZW50aWFscycgaW4geGhyU3VwcG9ydGVkOwogIHN1cHBvcnQuYWpheCA9IHhoclN1cHBvcnRlZCA9ICEheGhyU3VwcG9ydGVkOwogIGpRdWVyeS5hamF4VHJhbnNwb3J0KGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB2YXIgY2FsbGJhY2s7CiAgICAvLyBDcm9zcyBkb21haW4gb25seSBhbGxvd2VkIGlmIHN1cHBvcnRlZCB0aHJvdWdoIFhNTEh0dHBSZXF1ZXN0CiAgICBpZiAoc3VwcG9ydC5jb3JzIHx8IHhoclN1cHBvcnRlZCAmJiAhb3B0aW9ucy5jcm9zc0RvbWFpbikgewogICAgICByZXR1cm4gewogICAgICAgIHNlbmQ6IGZ1bmN0aW9uIChoZWFkZXJzLCBjb21wbGV0ZSkgewogICAgICAgICAgdmFyIGksIHhociA9IG9wdGlvbnMueGhyKCksIGlkID0gKyt4aHJJZDsKICAgICAgICAgIHhoci5vcGVuKG9wdGlvbnMudHlwZSwgb3B0aW9ucy51cmwsIG9wdGlvbnMuYXN5bmMsIG9wdGlvbnMudXNlcm5hbWUsIG9wdGlvbnMucGFzc3dvcmQpOwogICAgICAgICAgLy8gQXBwbHkgY3VzdG9tIGZpZWxkcyBpZiBwcm92aWRlZAogICAgICAgICAgaWYgKG9wdGlvbnMueGhyRmllbGRzKSB7CiAgICAgICAgICAgIGZvciAoaSBpbiBvcHRpb25zLnhockZpZWxkcykgewogICAgICAgICAgICAgIHhocltpXSA9IG9wdGlvbnMueGhyRmllbGRzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkCiAgICAgICAgICBpZiAob3B0aW9ucy5taW1lVHlwZSAmJiB4aHIub3ZlcnJpZGVNaW1lVHlwZSkgewogICAgICAgICAgICB4aHIub3ZlcnJpZGVNaW1lVHlwZShvcHRpb25zLm1pbWVUeXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFgtUmVxdWVzdGVkLVdpdGggaGVhZGVyCiAgICAgICAgICAvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCiAgICAgICAgICAvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgogICAgICAgICAgLy8gKGl0IGNhbiBhbHdheXMgYmUgc2V0IG9uIGEgcGVyLXJlcXVlc3QgYmFzaXMgb3IgZXZlbiB1c2luZyBhamF4U2V0dXApCiAgICAgICAgICAvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KICAgICAgICAgIGlmICghb3B0aW9ucy5jcm9zc0RvbWFpbiAmJiAhaGVhZGVyc1snWC1SZXF1ZXN0ZWQtV2l0aCddKSB7CiAgICAgICAgICAgIGhlYWRlcnNbJ1gtUmVxdWVzdGVkLVdpdGgnXSA9ICdYTUxIdHRwUmVxdWVzdCc7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBTZXQgaGVhZGVycwogICAgICAgICAgZm9yIChpIGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoaSwgaGVhZGVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBDYWxsYmFjawogICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgZGVsZXRlIHhockNhbGxiYWNrc1tpZF07CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IHhoci5vbmxvYWQgPSB4aHIub25lcnJvciA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2Fib3J0JykgewogICAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Vycm9yJykgewogICAgICAgICAgICAgICAgICBjb21wbGV0ZSgvLyBmaWxlOiBwcm90b2NvbCBhbHdheXMgeWllbGRzIHN0YXR1cyAwOyBzZWUgIzg2MDUsICMxNDIwNwogICAgICAgICAgICAgICAgICB4aHIuc3RhdHVzLCB4aHIuc3RhdHVzVGV4dCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21wbGV0ZSh4aHJTdWNjZXNzU3RhdHVzW3hoci5zdGF0dXNdIHx8IHhoci5zdGF0dXMsIHhoci5zdGF0dXNUZXh0LCAvLyBTdXBwb3J0OiBJRTkKICAgICAgICAgICAgICAgICAgLy8gQWNjZXNzaW5nIGJpbmFyeS1kYXRhIHJlc3BvbnNlVGV4dCB0aHJvd3MgYW4gZXhjZXB0aW9uCiAgICAgICAgICAgICAgICAgIC8vICgjMTE0MjYpCiAgICAgICAgICAgICAgICAgIHR5cGVvZiB4aHIucmVzcG9uc2VUZXh0ID09PSAnc3RyaW5nJyA/IHsgdGV4dDogeGhyLnJlc3BvbnNlVGV4dCB9IDogdW5kZWZpbmVkLCB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH07CiAgICAgICAgICAvLyBMaXN0ZW4gdG8gZXZlbnRzCiAgICAgICAgICB4aHIub25sb2FkID0gY2FsbGJhY2soKTsKICAgICAgICAgIHhoci5vbmVycm9yID0gY2FsbGJhY2soJ2Vycm9yJyk7CiAgICAgICAgICAvLyBDcmVhdGUgdGhlIGFib3J0IGNhbGxiYWNrCiAgICAgICAgICBjYWxsYmFjayA9IHhockNhbGxiYWNrc1tpZF0gPSBjYWxsYmFjaygnYWJvcnQnKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIERvIHNlbmQgdGhlIHJlcXVlc3QgKHRoaXMgbWF5IHJhaXNlIGFuIGV4Y2VwdGlvbikKICAgICAgICAgICAgeGhyLnNlbmQob3B0aW9ucy5oYXNDb250ZW50ICYmIG9wdGlvbnMuZGF0YSB8fCBudWxsKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gIzE0NjgzOiBPbmx5IHJldGhyb3cgaWYgdGhpcyBoYXNuJ3QgYmVlbiBub3RpZmllZCBhcyBhbiBlcnJvciB5ZXQKICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9KTsKICAvLyBJbnN0YWxsIHNjcmlwdCBkYXRhVHlwZQogIGpRdWVyeS5hamF4U2V0dXAoewogICAgYWNjZXB0czogeyBzY3JpcHQ6ICd0ZXh0L2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2VjbWFzY3JpcHQsIGFwcGxpY2F0aW9uL3gtZWNtYXNjcmlwdCcgfSwKICAgIGNvbnRlbnRzOiB7IHNjcmlwdDogLyg/OmphdmF8ZWNtYSlzY3JpcHQvIH0sCiAgICBjb252ZXJ0ZXJzOiB7CiAgICAgICd0ZXh0IHNjcmlwdCc6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwodGV4dCk7CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgIH0KICAgIH0KICB9KTsKICAvLyBIYW5kbGUgY2FjaGUncyBzcGVjaWFsIGNhc2UgYW5kIGNyb3NzRG9tYWluCiAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoJ3NjcmlwdCcsIGZ1bmN0aW9uIChzKSB7CiAgICBpZiAocy5jYWNoZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHMuY2FjaGUgPSBmYWxzZTsKICAgIH0KICAgIGlmIChzLmNyb3NzRG9tYWluKSB7CiAgICAgIHMudHlwZSA9ICdHRVQnOwogICAgfQogIH0pOwogIC8vIEJpbmQgc2NyaXB0IHRhZyBoYWNrIHRyYW5zcG9ydAogIGpRdWVyeS5hamF4VHJhbnNwb3J0KCdzY3JpcHQnLCBmdW5jdGlvbiAocykgewogICAgLy8gVGhpcyB0cmFuc3BvcnQgb25seSBkZWFscyB3aXRoIGNyb3NzIGRvbWFpbiByZXF1ZXN0cwogICAgaWYgKHMuY3Jvc3NEb21haW4pIHsKICAgICAgdmFyIHNjcmlwdCwgY2FsbGJhY2s7CiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24gKF8sIGNvbXBsZXRlKSB7CiAgICAgICAgICBzY3JpcHQgPSBqUXVlcnkoJzxzY3JpcHQ+JykucHJvcCh7CiAgICAgICAgICAgIGFzeW5jOiB0cnVlLAogICAgICAgICAgICBjaGFyc2V0OiBzLnNjcmlwdENoYXJzZXQsCiAgICAgICAgICAgIHNyYzogcy51cmwKICAgICAgICAgIH0pLm9uKCdsb2FkIGVycm9yJywgY2FsbGJhY2sgPSBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgICAgIHNjcmlwdC5yZW1vdmUoKTsKICAgICAgICAgICAgY2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICBpZiAoZXZ0KSB7CiAgICAgICAgICAgICAgY29tcGxldGUoZXZ0LnR5cGUgPT09ICdlcnJvcicgPyA0MDQgOiAyMDAsIGV2dC50eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdFswXSk7CiAgICAgICAgfSwKICAgICAgICBhYm9ydDogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH0pOwogIHZhciBvbGRDYWxsYmFja3MgPSBbXSwgcmpzb25wID0gLyg9KVw/KD89JnwkKXxcP1w/LzsKICAvLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCiAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICBqc29ucDogJ2NhbGxiYWNrJywKICAgIGpzb25wQ2FsbGJhY2s6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8IGpRdWVyeS5leHBhbmRvICsgJ18nICsgbm9uY2UrKzsKICAgICAgdGhpc1tjYWxsYmFja10gPSB0cnVlOwogICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICB9CiAgfSk7CiAgLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzCiAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoJ2pzb24ganNvbnAnLCBmdW5jdGlvbiAocywgb3JpZ2luYWxTZXR0aW5ncywganFYSFIpIHsKICAgIHZhciBjYWxsYmFja05hbWUsIG92ZXJ3cml0dGVuLCByZXNwb25zZUNvbnRhaW5lciwganNvblByb3AgPSBzLmpzb25wICE9PSBmYWxzZSAmJiAocmpzb25wLnRlc3Qocy51cmwpID8gJ3VybCcgOiB0eXBlb2Ygcy5kYXRhID09PSAnc3RyaW5nJyAmJiAhKHMuY29udGVudFR5cGUgfHwgJycpLmluZGV4T2YoJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpICYmIHJqc29ucC50ZXN0KHMuZGF0YSkgJiYgJ2RhdGEnKTsKICAgIC8vIEhhbmRsZSBpZmYgdGhlIGV4cGVjdGVkIGRhdGEgdHlwZSBpcyAianNvbnAiIG9yIHdlIGhhdmUgYSBwYXJhbWV0ZXIgdG8gc2V0CiAgICBpZiAoanNvblByb3AgfHwgcy5kYXRhVHlwZXNbMF0gPT09ICdqc29ucCcpIHsKICAgICAgLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdAogICAgICBjYWxsYmFja05hbWUgPSBzLmpzb25wQ2FsbGJhY2sgPSBqUXVlcnkuaXNGdW5jdGlvbihzLmpzb25wQ2FsbGJhY2spID8gcy5qc29ucENhbGxiYWNrKCkgOiBzLmpzb25wQ2FsbGJhY2s7CiAgICAgIC8vIEluc2VydCBjYWxsYmFjayBpbnRvIHVybCBvciBmb3JtIGRhdGEKICAgICAgaWYgKGpzb25Qcm9wKSB7CiAgICAgICAgc1tqc29uUHJvcF0gPSBzW2pzb25Qcm9wXS5yZXBsYWNlKHJqc29ucCwgJyQxJyArIGNhbGxiYWNrTmFtZSk7CiAgICAgIH0gZWxzZSBpZiAocy5qc29ucCAhPT0gZmFsc2UpIHsKICAgICAgICBzLnVybCArPSAocnF1ZXJ5LnRlc3Qocy51cmwpID8gJyYnIDogJz8nKSArIHMuanNvbnAgKyAnPScgKyBjYWxsYmFja05hbWU7CiAgICAgIH0KICAgICAgLy8gVXNlIGRhdGEgY29udmVydGVyIHRvIHJldHJpZXZlIGpzb24gYWZ0ZXIgc2NyaXB0IGV4ZWN1dGlvbgogICAgICBzLmNvbnZlcnRlcnNbJ3NjcmlwdCBqc29uJ10gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFyZXNwb25zZUNvbnRhaW5lcikgewogICAgICAgICAgalF1ZXJ5LmVycm9yKGNhbGxiYWNrTmFtZSArICcgd2FzIG5vdCBjYWxsZWQnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlQ29udGFpbmVyWzBdOwogICAgICB9OwogICAgICAvLyBmb3JjZSBqc29uIGRhdGFUeXBlCiAgICAgIHMuZGF0YVR5cGVzWzBdID0gJ2pzb24nOwogICAgICAvLyBJbnN0YWxsIGNhbGxiYWNrCiAgICAgIG92ZXJ3cml0dGVuID0gd2luZG93W2NhbGxiYWNrTmFtZV07CiAgICAgIHdpbmRvd1tjYWxsYmFja05hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJlc3BvbnNlQ29udGFpbmVyID0gYXJndW1lbnRzOwogICAgICB9OwogICAgICAvLyBDbGVhbi11cCBmdW5jdGlvbiAoZmlyZXMgYWZ0ZXIgY29udmVydGVycykKICAgICAganFYSFIuYWx3YXlzKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBSZXN0b3JlIHByZWV4aXN0aW5nIHZhbHVlCiAgICAgICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBvdmVyd3JpdHRlbjsKICAgICAgICAvLyBTYXZlIGJhY2sgYXMgZnJlZQogICAgICAgIGlmIChzW2NhbGxiYWNrTmFtZV0pIHsKICAgICAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHJlLXVzaW5nIHRoZSBvcHRpb25zIGRvZXNuJ3Qgc2NyZXcgdGhpbmdzIGFyb3VuZAogICAgICAgICAgcy5qc29ucENhbGxiYWNrID0gb3JpZ2luYWxTZXR0aW5ncy5qc29ucENhbGxiYWNrOwogICAgICAgICAgLy8gc2F2ZSB0aGUgY2FsbGJhY2sgbmFtZSBmb3IgZnV0dXJlIHVzZQogICAgICAgICAgb2xkQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2tOYW1lKTsKICAgICAgICB9CiAgICAgICAgLy8gQ2FsbCBpZiBpdCB3YXMgYSBmdW5jdGlvbiBhbmQgd2UgaGF2ZSBhIHJlc3BvbnNlCiAgICAgICAgaWYgKHJlc3BvbnNlQ29udGFpbmVyICYmIGpRdWVyeS5pc0Z1bmN0aW9uKG92ZXJ3cml0dGVuKSkgewogICAgICAgICAgb3ZlcndyaXR0ZW4ocmVzcG9uc2VDb250YWluZXJbMF0pOwogICAgICAgIH0KICAgICAgICByZXNwb25zZUNvbnRhaW5lciA9IG92ZXJ3cml0dGVuID0gdW5kZWZpbmVkOwogICAgICB9KTsKICAgICAgLy8gRGVsZWdhdGUgdG8gc2NyaXB0CiAgICAgIHJldHVybiAnc2NyaXB0JzsKICAgIH0KICB9KTsKICAvLyBkYXRhOiBzdHJpbmcgb2YgaHRtbAogIC8vIGNvbnRleHQgKG9wdGlvbmFsKTogSWYgc3BlY2lmaWVkLCB0aGUgZnJhZ21lbnQgd2lsbCBiZSBjcmVhdGVkIGluIHRoaXMgY29udGV4dCwgZGVmYXVsdHMgdG8gZG9jdW1lbnQKICAvLyBrZWVwU2NyaXB0cyAob3B0aW9uYWwpOiBJZiB0cnVlLCB3aWxsIGluY2x1ZGUgc2NyaXB0cyBwYXNzZWQgaW4gdGhlIGh0bWwgc3RyaW5nCiAgalF1ZXJ5LnBhcnNlSFRNTCA9IGZ1bmN0aW9uIChkYXRhLCBjb250ZXh0LCBrZWVwU2NyaXB0cykgewogICAgaWYgKCFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmICh0eXBlb2YgY29udGV4dCA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgIGtlZXBTY3JpcHRzID0gY29udGV4dDsKICAgICAgY29udGV4dCA9IGZhbHNlOwogICAgfQogICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CiAgICB2YXIgcGFyc2VkID0gcnNpbmdsZVRhZy5leGVjKGRhdGEpLCBzY3JpcHRzID0gIWtlZXBTY3JpcHRzICYmIFtdOwogICAgLy8gU2luZ2xlIHRhZwogICAgaWYgKHBhcnNlZCkgewogICAgICByZXR1cm4gW2NvbnRleHQuY3JlYXRlRWxlbWVudChwYXJzZWRbMV0pXTsKICAgIH0KICAgIHBhcnNlZCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KFtkYXRhXSwgY29udGV4dCwgc2NyaXB0cyk7CiAgICBpZiAoc2NyaXB0cyAmJiBzY3JpcHRzLmxlbmd0aCkgewogICAgICBqUXVlcnkoc2NyaXB0cykucmVtb3ZlKCk7CiAgICB9CiAgICByZXR1cm4galF1ZXJ5Lm1lcmdlKFtdLCBwYXJzZWQuY2hpbGROb2Rlcyk7CiAgfTsKICAvLyBLZWVwIGEgY29weSBvZiB0aGUgb2xkIGxvYWQgbWV0aG9kCiAgdmFyIF9sb2FkID0galF1ZXJ5LmZuLmxvYWQ7CiAgLyoqCiAgICogTG9hZCBhIHVybCBpbnRvIGEgcGFnZQogICAqLwogIGpRdWVyeS5mbi5sb2FkID0gZnVuY3Rpb24gKHVybCwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnICYmIF9sb2FkKSB7CiAgICAgIHJldHVybiBfbG9hZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgdmFyIHNlbGVjdG9yLCB0eXBlLCByZXNwb25zZSwgc2VsZiA9IHRoaXMsIG9mZiA9IHVybC5pbmRleE9mKCcgJyk7CiAgICBpZiAob2ZmID49IDApIHsKICAgICAgc2VsZWN0b3IgPSBqUXVlcnkudHJpbSh1cmwuc2xpY2Uob2ZmKSk7CiAgICAgIHVybCA9IHVybC5zbGljZSgwLCBvZmYpOwogICAgfQogICAgLy8gSWYgaXQncyBhIGZ1bmN0aW9uCiAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24ocGFyYW1zKSkgewogICAgICAvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawogICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgcGFyYW1zID0gdW5kZWZpbmVkOyAgLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZwogICAgfSBlbHNlIGlmIChwYXJhbXMgJiYgdHlwZW9mIHBhcmFtcyA9PT0gJ29iamVjdCcpIHsKICAgICAgdHlwZSA9ICdQT1NUJzsKICAgIH0KICAgIC8vIElmIHdlIGhhdmUgZWxlbWVudHMgdG8gbW9kaWZ5LCBtYWtlIHRoZSByZXF1ZXN0CiAgICBpZiAoc2VsZi5sZW5ndGggPiAwKSB7CiAgICAgIGpRdWVyeS5hamF4KHsKICAgICAgICB1cmw6IHVybCwKICAgICAgICAvLyBpZiAidHlwZSIgdmFyaWFibGUgaXMgdW5kZWZpbmVkLCB0aGVuICJHRVQiIG1ldGhvZCB3aWxsIGJlIHVzZWQKICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgIGRhdGFUeXBlOiAnaHRtbCcsCiAgICAgICAgZGF0YTogcGFyYW1zCiAgICAgIH0pLmRvbmUoZnVuY3Rpb24gKHJlc3BvbnNlVGV4dCkgewogICAgICAgIC8vIFNhdmUgcmVzcG9uc2UgZm9yIHVzZSBpbiBjb21wbGV0ZSBjYWxsYmFjawogICAgICAgIHJlc3BvbnNlID0gYXJndW1lbnRzOwogICAgICAgIHNlbGYuaHRtbChzZWxlY3RvciA/IC8vIElmIGEgc2VsZWN0b3Igd2FzIHNwZWNpZmllZCwgbG9jYXRlIHRoZSByaWdodCBlbGVtZW50cyBpbiBhIGR1bW15IGRpdgogICAgICAgIC8vIEV4Y2x1ZGUgc2NyaXB0cyB0byBhdm9pZCBJRSAnUGVybWlzc2lvbiBEZW5pZWQnIGVycm9ycwogICAgICAgIGpRdWVyeSgnPGRpdj4nKS5hcHBlbmQoalF1ZXJ5LnBhcnNlSFRNTChyZXNwb25zZVRleHQpKS5maW5kKHNlbGVjdG9yKSA6IC8vIE90aGVyd2lzZSB1c2UgdGhlIGZ1bGwgcmVzdWx0CiAgICAgICAgcmVzcG9uc2VUZXh0KTsKICAgICAgfSkuY29tcGxldGUoY2FsbGJhY2sgJiYgZnVuY3Rpb24gKGpxWEhSLCBzdGF0dXMpIHsKICAgICAgICBzZWxmLmVhY2goY2FsbGJhY2ssIHJlc3BvbnNlIHx8IFsKICAgICAgICAgIGpxWEhSLnJlc3BvbnNlVGV4dCwKICAgICAgICAgIHN0YXR1cywKICAgICAgICAgIGpxWEhSCiAgICAgICAgXSk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKICBqUXVlcnkuZXhwci5maWx0ZXJzLmFuaW1hdGVkID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgIHJldHVybiBqUXVlcnkuZ3JlcChqUXVlcnkudGltZXJzLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgcmV0dXJuIGVsZW0gPT09IGZuLmVsZW07CiAgICB9KS5sZW5ndGg7CiAgfTsKICB2YXIgZG9jRWxlbSA9IHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgLyoqCiAgICogR2V0cyBhIHdpbmRvdyBmcm9tIGFuIGVsZW1lbnQKICAgKi8KICBmdW5jdGlvbiBnZXRXaW5kb3coZWxlbSkgewogICAgcmV0dXJuIGpRdWVyeS5pc1dpbmRvdyhlbGVtKSA/IGVsZW0gOiBlbGVtLm5vZGVUeXBlID09PSA5ICYmIGVsZW0uZGVmYXVsdFZpZXc7CiAgfQogIGpRdWVyeS5vZmZzZXQgPSB7CiAgICBzZXRPZmZzZXQ6IGZ1bmN0aW9uIChlbGVtLCBvcHRpb25zLCBpKSB7CiAgICAgIHZhciBjdXJQb3NpdGlvbiwgY3VyTGVmdCwgY3VyQ1NTVG9wLCBjdXJUb3AsIGN1ck9mZnNldCwgY3VyQ1NTTGVmdCwgY2FsY3VsYXRlUG9zaXRpb24sIHBvc2l0aW9uID0galF1ZXJ5LmNzcyhlbGVtLCAncG9zaXRpb24nKSwgY3VyRWxlbSA9IGpRdWVyeShlbGVtKSwgcHJvcHMgPSB7fTsKICAgICAgLy8gU2V0IHBvc2l0aW9uIGZpcnN0LCBpbi1jYXNlIHRvcC9sZWZ0IGFyZSBzZXQgZXZlbiBvbiBzdGF0aWMgZWxlbQogICAgICBpZiAocG9zaXRpb24gPT09ICdzdGF0aWMnKSB7CiAgICAgICAgZWxlbS5zdHlsZS5wb3NpdGlvbiA9ICdyZWxhdGl2ZSc7CiAgICAgIH0KICAgICAgY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKTsKICAgICAgY3VyQ1NTVG9wID0galF1ZXJ5LmNzcyhlbGVtLCAndG9wJyk7CiAgICAgIGN1ckNTU0xlZnQgPSBqUXVlcnkuY3NzKGVsZW0sICdsZWZ0Jyk7CiAgICAgIGNhbGN1bGF0ZVBvc2l0aW9uID0gKHBvc2l0aW9uID09PSAnYWJzb2x1dGUnIHx8IHBvc2l0aW9uID09PSAnZml4ZWQnKSAmJiAoY3VyQ1NTVG9wICsgY3VyQ1NTTGVmdCkuaW5kZXhPZignYXV0bycpID4gLTE7CiAgICAgIC8vIE5lZWQgdG8gYmUgYWJsZSB0byBjYWxjdWxhdGUgcG9zaXRpb24gaWYgZWl0aGVyIHRvcCBvciBsZWZ0IGlzIGF1dG8gYW5kIHBvc2l0aW9uIGlzIGVpdGhlciBhYnNvbHV0ZSBvciBmaXhlZAogICAgICBpZiAoY2FsY3VsYXRlUG9zaXRpb24pIHsKICAgICAgICBjdXJQb3NpdGlvbiA9IGN1ckVsZW0ucG9zaXRpb24oKTsKICAgICAgICBjdXJUb3AgPSBjdXJQb3NpdGlvbi50b3A7CiAgICAgICAgY3VyTGVmdCA9IGN1clBvc2l0aW9uLmxlZnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3VyVG9wID0gcGFyc2VGbG9hdChjdXJDU1NUb3ApIHx8IDA7CiAgICAgICAgY3VyTGVmdCA9IHBhcnNlRmxvYXQoY3VyQ1NTTGVmdCkgfHwgMDsKICAgICAgfQogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24ob3B0aW9ucykpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucy5jYWxsKGVsZW0sIGksIGN1ck9mZnNldCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudG9wICE9IG51bGwpIHsKICAgICAgICBwcm9wcy50b3AgPSBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKyBjdXJUb3A7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMubGVmdCAhPSBudWxsKSB7CiAgICAgICAgcHJvcHMubGVmdCA9IG9wdGlvbnMubGVmdCAtIGN1ck9mZnNldC5sZWZ0ICsgY3VyTGVmdDsKICAgICAgfQogICAgICBpZiAoJ3VzaW5nJyBpbiBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucy51c2luZy5jYWxsKGVsZW0sIHByb3BzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJFbGVtLmNzcyhwcm9wcyk7CiAgICAgIH0KICAgIH0KICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgb2Zmc2V0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHJldHVybiBvcHRpb25zID09PSB1bmRlZmluZWQgPyB0aGlzIDogdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICBqUXVlcnkub2Zmc2V0LnNldE9mZnNldCh0aGlzLCBvcHRpb25zLCBpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgZG9jRWxlbSwgd2luLCBlbGVtID0gdGhpc1swXSwgYm94ID0gewogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMAogICAgICAgIH0sIGRvYyA9IGVsZW0gJiYgZWxlbS5vd25lckRvY3VtZW50OwogICAgICBpZiAoIWRvYykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKICAgICAgLy8gTWFrZSBzdXJlIGl0J3Mgbm90IGEgZGlzY29ubmVjdGVkIERPTSBub2RlCiAgICAgIGlmICghalF1ZXJ5LmNvbnRhaW5zKGRvY0VsZW0sIGVsZW0pKSB7CiAgICAgICAgcmV0dXJuIGJveDsKICAgICAgfQogICAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIGdCQ1IsIGp1c3QgdXNlIDAsMCByYXRoZXIgdGhhbiBlcnJvcgogICAgICAvLyBCbGFja0JlcnJ5IDUsIGlPUyAzIChvcmlnaW5hbCBpUGhvbmUpCiAgICAgIGlmICh0eXBlb2YgZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09IHN0cnVuZGVmaW5lZCkgewogICAgICAgIGJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIH0KICAgICAgd2luID0gZ2V0V2luZG93KGRvYyk7CiAgICAgIHJldHVybiB7CiAgICAgICAgdG9wOiBib3gudG9wICsgd2luLnBhZ2VZT2Zmc2V0IC0gZG9jRWxlbS5jbGllbnRUb3AsCiAgICAgICAgbGVmdDogYm94LmxlZnQgKyB3aW4ucGFnZVhPZmZzZXQgLSBkb2NFbGVtLmNsaWVudExlZnQKICAgICAgfTsKICAgIH0sCiAgICBwb3NpdGlvbjogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXNbMF0pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIG9mZnNldFBhcmVudCwgb2Zmc2V0LCBlbGVtID0gdGhpc1swXSwgcGFyZW50T2Zmc2V0ID0gewogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMAogICAgICAgIH07CiAgICAgIC8vIEZpeGVkIGVsZW1lbnRzIGFyZSBvZmZzZXQgZnJvbSB3aW5kb3cgKHBhcmVudE9mZnNldCA9IHt0b3A6MCwgbGVmdDogMH0sIGJlY2F1c2UgaXQgaXMgaXRzIG9ubHkgb2Zmc2V0IHBhcmVudAogICAgICBpZiAoalF1ZXJ5LmNzcyhlbGVtLCAncG9zaXRpb24nKSA9PT0gJ2ZpeGVkJykgewogICAgICAgIC8vIFdlIGFzc3VtZSB0aGF0IGdldEJvdW5kaW5nQ2xpZW50UmVjdCBpcyBhdmFpbGFibGUgd2hlbiBjb21wdXRlZCBwb3NpdGlvbiBpcyBmaXhlZAogICAgICAgIG9mZnNldCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gR2V0ICpyZWFsKiBvZmZzZXRQYXJlbnQKICAgICAgICBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpOwogICAgICAgIC8vIEdldCBjb3JyZWN0IG9mZnNldHMKICAgICAgICBvZmZzZXQgPSB0aGlzLm9mZnNldCgpOwogICAgICAgIGlmICghalF1ZXJ5Lm5vZGVOYW1lKG9mZnNldFBhcmVudFswXSwgJ2h0bWwnKSkgewogICAgICAgICAgcGFyZW50T2Zmc2V0ID0gb2Zmc2V0UGFyZW50Lm9mZnNldCgpOwogICAgICAgIH0KICAgICAgICAvLyBBZGQgb2Zmc2V0UGFyZW50IGJvcmRlcnMKICAgICAgICBwYXJlbnRPZmZzZXQudG9wICs9IGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50WzBdLCAnYm9yZGVyVG9wV2lkdGgnLCB0cnVlKTsKICAgICAgICBwYXJlbnRPZmZzZXQubGVmdCArPSBqUXVlcnkuY3NzKG9mZnNldFBhcmVudFswXSwgJ2JvcmRlckxlZnRXaWR0aCcsIHRydWUpOwogICAgICB9CiAgICAgIC8vIFN1YnRyYWN0IHBhcmVudCBvZmZzZXRzIGFuZCBlbGVtZW50IG1hcmdpbnMKICAgICAgcmV0dXJuIHsKICAgICAgICB0b3A6IG9mZnNldC50b3AgLSBwYXJlbnRPZmZzZXQudG9wIC0galF1ZXJ5LmNzcyhlbGVtLCAnbWFyZ2luVG9wJywgdHJ1ZSksCiAgICAgICAgbGVmdDogb2Zmc2V0LmxlZnQgLSBwYXJlbnRPZmZzZXQubGVmdCAtIGpRdWVyeS5jc3MoZWxlbSwgJ21hcmdpbkxlZnQnLCB0cnVlKQogICAgICB9OwogICAgfSwKICAgIG9mZnNldFBhcmVudDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCB8fCBkb2NFbGVtOwogICAgICAgIHdoaWxlIChvZmZzZXRQYXJlbnQgJiYgKCFqUXVlcnkubm9kZU5hbWUob2Zmc2V0UGFyZW50LCAnaHRtbCcpICYmIGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50LCAncG9zaXRpb24nKSA9PT0gJ3N0YXRpYycpKSB7CiAgICAgICAgICBvZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgIH0KICAgICAgICByZXR1cm4gb2Zmc2V0UGFyZW50IHx8IGRvY0VsZW07CiAgICAgIH0pOwogICAgfQogIH0pOwogIC8vIENyZWF0ZSBzY3JvbGxMZWZ0IGFuZCBzY3JvbGxUb3AgbWV0aG9kcwogIGpRdWVyeS5lYWNoKHsKICAgIHNjcm9sbExlZnQ6ICdwYWdlWE9mZnNldCcsCiAgICBzY3JvbGxUb3A6ICdwYWdlWU9mZnNldCcKICB9LCBmdW5jdGlvbiAobWV0aG9kLCBwcm9wKSB7CiAgICB2YXIgdG9wID0gJ3BhZ2VZT2Zmc2V0JyA9PT0gcHJvcDsKICAgIGpRdWVyeS5mblttZXRob2RdID0gZnVuY3Rpb24gKHZhbCkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uIChlbGVtLCBtZXRob2QsIHZhbCkgewogICAgICAgIHZhciB3aW4gPSBnZXRXaW5kb3coZWxlbSk7CiAgICAgICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gd2luID8gd2luW3Byb3BdIDogZWxlbVttZXRob2RdOwogICAgICAgIH0KICAgICAgICBpZiAod2luKSB7CiAgICAgICAgICB3aW4uc2Nyb2xsVG8oIXRvcCA/IHZhbCA6IHdpbmRvdy5wYWdlWE9mZnNldCwgdG9wID8gdmFsIDogd2luZG93LnBhZ2VZT2Zmc2V0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbVttZXRob2RdID0gdmFsOwogICAgICAgIH0KICAgICAgfSwgbWV0aG9kLCB2YWwsIGFyZ3VtZW50cy5sZW5ndGgsIG51bGwpOwogICAgfTsKICB9KTsKICAvLyBBZGQgdGhlIHRvcC9sZWZ0IGNzc0hvb2tzIHVzaW5nIGpRdWVyeS5mbi5wb3NpdGlvbgogIC8vIFdlYmtpdCBidWc6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0yOTA4NAogIC8vIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyBwZXJjZW50IHdoZW4gc3BlY2lmaWVkIGZvciB0b3AvbGVmdC9ib3R0b20vcmlnaHQKICAvLyByYXRoZXIgdGhhbiBtYWtlIHRoZSBjc3MgbW9kdWxlIGRlcGVuZCBvbiB0aGUgb2Zmc2V0IG1vZHVsZSwgd2UganVzdCBjaGVjayBmb3IgaXQgaGVyZQogIGpRdWVyeS5lYWNoKFsKICAgICd0b3AnLAogICAgJ2xlZnQnCiAgXSwgZnVuY3Rpb24gKGksIHByb3ApIHsKICAgIGpRdWVyeS5jc3NIb29rc1twcm9wXSA9IGFkZEdldEhvb2tJZihzdXBwb3J0LnBpeGVsUG9zaXRpb24sIGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCkgewogICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICBjb21wdXRlZCA9IGN1ckNTUyhlbGVtLCBwcm9wKTsKICAgICAgICAvLyBpZiBjdXJDU1MgcmV0dXJucyBwZXJjZW50YWdlLCBmYWxsYmFjayB0byBvZmZzZXQKICAgICAgICByZXR1cm4gcm51bW5vbnB4LnRlc3QoY29tcHV0ZWQpID8galF1ZXJ5KGVsZW0pLnBvc2l0aW9uKClbcHJvcF0gKyAncHgnIDogY29tcHV0ZWQ7CiAgICAgIH0KICAgIH0pOwogIH0pOwogIC8vIENyZWF0ZSBpbm5lckhlaWdodCwgaW5uZXJXaWR0aCwgaGVpZ2h0LCB3aWR0aCwgb3V0ZXJIZWlnaHQgYW5kIG91dGVyV2lkdGggbWV0aG9kcwogIGpRdWVyeS5lYWNoKHsKICAgIEhlaWdodDogJ2hlaWdodCcsCiAgICBXaWR0aDogJ3dpZHRoJwogIH0sIGZ1bmN0aW9uIChuYW1lLCB0eXBlKSB7CiAgICBqUXVlcnkuZWFjaCh7CiAgICAgIHBhZGRpbmc6ICdpbm5lcicgKyBuYW1lLAogICAgICBjb250ZW50OiB0eXBlLAogICAgICAnJzogJ291dGVyJyArIG5hbWUKICAgIH0sIGZ1bmN0aW9uIChkZWZhdWx0RXh0cmEsIGZ1bmNOYW1lKSB7CiAgICAgIC8vIG1hcmdpbiBpcyBvbmx5IGZvciBvdXRlckhlaWdodCwgb3V0ZXJXaWR0aAogICAgICBqUXVlcnkuZm5bZnVuY05hbWVdID0gZnVuY3Rpb24gKG1hcmdpbiwgdmFsdWUpIHsKICAgICAgICB2YXIgY2hhaW5hYmxlID0gYXJndW1lbnRzLmxlbmd0aCAmJiAoZGVmYXVsdEV4dHJhIHx8IHR5cGVvZiBtYXJnaW4gIT09ICdib29sZWFuJyksIGV4dHJhID0gZGVmYXVsdEV4dHJhIHx8IChtYXJnaW4gPT09IHRydWUgfHwgdmFsdWUgPT09IHRydWUgPyAnbWFyZ2luJyA6ICdib3JkZXInKTsKICAgICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uIChlbGVtLCB0eXBlLCB2YWx1ZSkgewogICAgICAgICAgdmFyIGRvYzsKICAgICAgICAgIGlmIChqUXVlcnkuaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICAgICAgLy8gQXMgb2YgNS84LzIwMTIgdGhpcyB3aWxsIHlpZWxkIGluY29ycmVjdCByZXN1bHRzIGZvciBNb2JpbGUgU2FmYXJpLCBidXQgdGhlcmUKICAgICAgICAgICAgLy8gaXNuJ3QgYSB3aG9sZSBsb3Qgd2UgY2FuIGRvLiBTZWUgcHVsbCByZXF1ZXN0IGF0IHRoaXMgVVJMIGZvciBkaXNjdXNzaW9uOgogICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzc2NAogICAgICAgICAgICByZXR1cm4gZWxlbS5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbJ2NsaWVudCcgKyBuYW1lXTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEdldCBkb2N1bWVudCB3aWR0aCBvciBoZWlnaHQKICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICAgIGRvYyA9IGVsZW0uZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgICAvLyBFaXRoZXIgc2Nyb2xsW1dpZHRoL0hlaWdodF0gb3Igb2Zmc2V0W1dpZHRoL0hlaWdodF0gb3IgY2xpZW50W1dpZHRoL0hlaWdodF0sCiAgICAgICAgICAgIC8vIHdoaWNoZXZlciBpcyBncmVhdGVzdAogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoZWxlbS5ib2R5WydzY3JvbGwnICsgbmFtZV0sIGRvY1snc2Nyb2xsJyArIG5hbWVdLCBlbGVtLmJvZHlbJ29mZnNldCcgKyBuYW1lXSwgZG9jWydvZmZzZXQnICsgbmFtZV0sIGRvY1snY2xpZW50JyArIG5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8gLy8gR2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCwgcmVxdWVzdGluZyBidXQgbm90IGZvcmNpbmcgcGFyc2VGbG9hdAogICAgICAgICAgalF1ZXJ5LmNzcyhlbGVtLCB0eXBlLCBleHRyYSkgOiAvLyBTZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CiAgICAgICAgICBqUXVlcnkuc3R5bGUoZWxlbSwgdHlwZSwgdmFsdWUsIGV4dHJhKTsKICAgICAgICB9LCB0eXBlLCBjaGFpbmFibGUgPyBtYXJnaW4gOiB1bmRlZmluZWQsIGNoYWluYWJsZSwgbnVsbCk7CiAgICAgIH07CiAgICB9KTsKICB9KTsKICAvLyBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGNvbnRhaW5lZCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldAogIGpRdWVyeS5mbi5zaXplID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoOwogIH07CiAgalF1ZXJ5LmZuLmFuZFNlbGYgPSBqUXVlcnkuZm4uYWRkQmFjazsKICAvLyBSZWdpc3RlciBhcyBhIG5hbWVkIEFNRCBtb2R1bGUsIHNpbmNlIGpRdWVyeSBjYW4gYmUgY29uY2F0ZW5hdGVkIHdpdGggb3RoZXIKICAvLyBmaWxlcyB0aGF0IG1heSB1c2UgZGVmaW5lLCBidXQgbm90IHZpYSBhIHByb3BlciBjb25jYXRlbmF0aW9uIHNjcmlwdCB0aGF0CiAgLy8gdW5kZXJzdGFuZHMgYW5vbnltb3VzIEFNRCBtb2R1bGVzLiBBIG5hbWVkIEFNRCBpcyBzYWZlc3QgYW5kIG1vc3Qgcm9idXN0CiAgLy8gd2F5IHRvIHJlZ2lzdGVyLiBMb3dlcmNhc2UganF1ZXJ5IGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZQogIC8vIGRlcml2ZWQgZnJvbSBmaWxlIG5hbWVzLCBhbmQgalF1ZXJ5IGlzIG5vcm1hbGx5IGRlbGl2ZXJlZCBpbiBhIGxvd2VyY2FzZQogIC8vIGZpbGUgbmFtZS4gRG8gdGhpcyBhZnRlciBjcmVhdGluZyB0aGUgZ2xvYmFsIHNvIHRoYXQgaWYgYW4gQU1EIG1vZHVsZSB3YW50cwogIC8vIHRvIGNhbGwgbm9Db25mbGljdCB0byBoaWRlIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnksIGl0IHdpbGwgd29yay4KICAvLyBOb3RlIHRoYXQgZm9yIG1heGltdW0gcG9ydGFiaWxpdHksIGxpYnJhcmllcyB0aGF0IGFyZSBub3QgalF1ZXJ5IHNob3VsZAogIC8vIGRlY2xhcmUgdGhlbXNlbHZlcyBhcyBhbm9ueW1vdXMgbW9kdWxlcywgYW5kIGF2b2lkIHNldHRpbmcgYSBnbG9iYWwgaWYgYW4KICAvLyBBTUQgbG9hZGVyIGlzIHByZXNlbnQuIGpRdWVyeSBpcyBhIHNwZWNpYWwgY2FzZS4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZQogIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcmJ1cmtlL3JlcXVpcmVqcy93aWtpL1VwZGF0aW5nLWV4aXN0aW5nLWxpYnJhcmllcyN3aWtpLWFub24KICBpZiAodHJ1ZSkgewogICAganF1ZXJ5ID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4galF1ZXJ5OwogICAgfSgpOwogIH0KICB2YXIKICAgIC8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQogICAgX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksCiAgICAvLyBNYXAgb3ZlciB0aGUgJCBpbiBjYXNlIG9mIG92ZXJ3cml0ZQogICAgXyQgPSB3aW5kb3cuJDsKICBqUXVlcnkubm9Db25mbGljdCA9IGZ1bmN0aW9uIChkZWVwKSB7CiAgICBpZiAod2luZG93LiQgPT09IGpRdWVyeSkgewogICAgICB3aW5kb3cuJCA9IF8kOwogICAgfQogICAgaWYgKGRlZXAgJiYgd2luZG93LmpRdWVyeSA9PT0galF1ZXJ5KSB7CiAgICAgIHdpbmRvdy5qUXVlcnkgPSBfalF1ZXJ5OwogICAgfQogICAgcmV0dXJuIGpRdWVyeTsKICB9OwogIC8vIEV4cG9zZSBqUXVlcnkgYW5kICQgaWRlbnRpZmllcnMsIGV2ZW4gaW4KICAvLyBBTUQgKCM3MTAyI2NvbW1lbnQ6MTAsIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNTU3KQogIC8vIGFuZCBDb21tb25KUyBmb3IgYnJvd3NlciBlbXVsYXRvcnMgKCMxMzU2NikKICBpZiAodHlwZW9mIG5vR2xvYmFsID09PSBzdHJ1bmRlZmluZWQpIHsKICAgIHdpbmRvdy5qUXVlcnkgPSB3aW5kb3cuJCA9IGpRdWVyeTsKICB9CiAgcmV0dXJuIGpRdWVyeTsKfSkpOwovLyAgICAgQmFja2JvbmUuanMgMS4xLjIKLy8gICAgIChjKSAyMDEwLTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIC8vIFNldCB1cCBCYWNrYm9uZSBhcHByb3ByaWF0ZWx5IGZvciB0aGUgZW52aXJvbm1lbnQuIFN0YXJ0IHdpdGggQU1ELgogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZSA9IGZ1bmN0aW9uIChfLCAkLCBleHBvcnRzKSB7CiAgICAgIC8vIEV4cG9ydCBnbG9iYWwgZXZlbiBpbiBBTUQgY2FzZSBpbiBjYXNlIHRoaXMgc2NyaXB0IGlzIGxvYWRlZCB3aXRoCiAgICAgIC8vIG90aGVycyB0aGF0IG1heSBzdGlsbCBleHBlY3QgYSBnbG9iYWwgQmFja2JvbmUuCiAgICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8sICQpOwogICAgICByZXR1cm4gZXhwb3J0czsKICAgIH0odW5kZXJzY29yZSwganF1ZXJ5LCB7fSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBfID0gdW5kZXJzY29yZTsKICAgIGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXyk7CiAgfSBlbHNlIHsKICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIHt9LCByb290Ll8sIHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQpOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAocm9vdCwgQmFja2JvbmUsIF8sICQpIHsKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlLCBzbyB0aGF0IGl0IGNhbiBiZQogIC8vIHJlc3RvcmVkIGxhdGVyIG9uLCBpZiBgbm9Db25mbGljdGAgaXMgdXNlZC4KICB2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7CiAgLy8gQ3JlYXRlIGxvY2FsIHJlZmVyZW5jZXMgdG8gYXJyYXkgbWV0aG9kcyB3ZSdsbCB3YW50IHRvIHVzZSBsYXRlci4KICB2YXIgYXJyYXkgPSBbXTsKICB2YXIgcHVzaCA9IGFycmF5LnB1c2g7CiAgdmFyIHNsaWNlID0gYXJyYXkuc2xpY2U7CiAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgogIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjInOwogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwogIC8vIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9ICQ7CiAgLy8gUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCiAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgogIEJhY2tib25lLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgogIC8vIHdpbGwgZmFrZSBgIlBBVENIImAsIGAiUFVUImAgYW5kIGAiREVMRVRFImAgcmVxdWVzdHMgdmlhIHRoZSBgX21ldGhvZGAgcGFyYW1ldGVyIGFuZAogIC8vIHNldCBhIGBYLUh0dHAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgQmFja2JvbmUuZW11bGF0ZUhUVFAgPSBmYWxzZTsKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAogIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKICAvLyBmdW5jdGlvbnMgdG8gYW4gZXZlbnQ7IGB0cmlnZ2VyYC1pbmcgYW4gZXZlbnQgZmlyZXMgYWxsIGNhbGxiYWNrcyBpbgogIC8vIHN1Y2Nlc3Npb24uCiAgLy8KICAvLyAgICAgdmFyIG9iamVjdCA9IHt9OwogIC8vICAgICBfLmV4dGVuZChvYmplY3QsIEJhY2tib25lLkV2ZW50cyk7CiAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwogIC8vICAgICBvYmplY3QudHJpZ2dlcignZXhwYW5kJyk7CiAgLy8KICB2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbCiAgICAgICAgICBjYWxsYmFjaywKICAgICAgICAgIGNvbnRleHQKICAgICAgICBdKSB8fCAhY2FsbGJhY2spCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHsKICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICBjdHg6IGNvbnRleHQgfHwgdGhpcwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gQmluZCBhbiBldmVudCB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQogICAgLy8gdGhlIGNhbGxiYWNrIGlzIGludm9rZWQsIGl0IHdpbGwgYmUgcmVtb3ZlZC4KICAgIG9uY2U6IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFsKICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgY29udGV4dAogICAgICAgIF0pIHx8ICFjYWxsYmFjaykKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgb25jZSA9IF8ub25jZShmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwogICAgfSwKICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBuYW1lYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAogICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgogICAgb2ZmOiBmdW5jdGlvbiAobmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgdmFyIHJldGFpbiwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFsKICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgY29udGV4dAogICAgICAgIF0pKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICBpZiAoIW5hbWUgJiYgIWNhbGxiYWNrICYmICFjb250ZXh0KSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0gdm9pZCAwOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIG5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IF8ua2V5cyh0aGlzLl9ldmVudHMpOwogICAgICBmb3IgKGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbmFtZSA9IG5hbWVzW2ldOwogICAgICAgIGlmIChldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0pIHsKICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IHJldGFpbiA9IFtdOwogICAgICAgICAgaWYgKGNhbGxiYWNrIHx8IGNvbnRleHQpIHsKICAgICAgICAgICAgZm9yIChqID0gMCwgayA9IGV2ZW50cy5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBldiA9IGV2ZW50c1tqXTsKICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2sgfHwgY29udGV4dCAmJiBjb250ZXh0ICE9PSBldi5jb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXRhaW4ucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJldGFpbi5sZW5ndGgpCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbbmFtZV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgLy8gcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgIC8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgIC8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KICAgIHRyaWdnZXI6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ3RyaWdnZXInLCBuYW1lLCBhcmdzKSkKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpCiAgICAgICAgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKQogICAgICAgIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCiAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgogICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24gKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG87CiAgICAgIGlmICghbGlzdGVuaW5nVG8pCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIHZhciByZW1vdmUgPSAhbmFtZSAmJiAhY2FsbGJhY2s7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKQogICAgICAgIGNhbGxiYWNrID0gdGhpczsKICAgICAgaWYgKG9iaikKICAgICAgICAobGlzdGVuaW5nVG8gPSB7fSlbb2JqLl9saXN0ZW5JZF0gPSBvYmo7CiAgICAgIGZvciAodmFyIGlkIGluIGxpc3RlbmluZ1RvKSB7CiAgICAgICAgb2JqID0gbGlzdGVuaW5nVG9baWRdOwogICAgICAgIG9iai5vZmYobmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICAgIGlmIChyZW1vdmUgfHwgXy5pc0VtcHR5KG9iai5fZXZlbnRzKSkKICAgICAgICAgIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfTsKICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgogIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uIChvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewogICAgaWYgKCFuYW1lKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgWwogICAgICAgICAga2V5LAogICAgICAgICAgbmFtZVtrZXldCiAgICAgICAgXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8vIEhhbmRsZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMuCiAgICBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CiAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfTsKICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgogIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKICAvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbiAoZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICBjYXNlIDA6CiAgICAgIHdoaWxlICgrK2kgPCBsKQogICAgICAgIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgpOwogICAgICByZXR1cm47CiAgICBjYXNlIDE6CiAgICAgIHdoaWxlICgrK2kgPCBsKQogICAgICAgIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsKICAgICAgcmV0dXJuOwogICAgY2FzZSAyOgogICAgICB3aGlsZSAoKytpIDwgbCkKICAgICAgICAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOwogICAgICByZXR1cm47CiAgICBjYXNlIDM6CiAgICAgIHdoaWxlICgrK2kgPCBsKQogICAgICAgIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMiwgYTMpOwogICAgICByZXR1cm47CiAgICBkZWZhdWx0OgogICAgICB3aGlsZSAoKytpIDwgbCkKICAgICAgICAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CiAgICAgIHJldHVybjsKICAgIH0KICB9OwogIHZhciBsaXN0ZW5NZXRob2RzID0gewogICAgbGlzdGVuVG86ICdvbicsCiAgICBsaXN0ZW5Ub09uY2U6ICdvbmNlJwogIH07CiAgLy8gSW52ZXJzaW9uLW9mLWNvbnRyb2wgdmVyc2lvbnMgb2YgYG9uYCBhbmQgYG9uY2VgLiBUZWxsICp0aGlzKiBvYmplY3QgdG8KICAvLyBsaXN0ZW4gdG8gYW4gZXZlbnQgaW4gYW5vdGhlciBvYmplY3QgLi4uIGtlZXBpbmcgdHJhY2sgb2Ygd2hhdCBpdCdzCiAgLy8gbGlzdGVuaW5nIHRvLgogIF8uZWFjaChsaXN0ZW5NZXRob2RzLCBmdW5jdGlvbiAoaW1wbGVtZW50YXRpb24sIG1ldGhvZCkgewogICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbiAob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKQogICAgICAgIGNhbGxiYWNrID0gdGhpczsKICAgICAgb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKICAvLyBBbGlhc2VzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KICBFdmVudHMuYmluZCA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKICAvLyBBbGxvdyB0aGUgYEJhY2tib25lYCBvYmplY3QgdG8gc2VydmUgYXMgYSBnbG9iYWwgZXZlbnQgYnVzLCBmb3IgZm9sa3Mgd2hvCiAgLy8gd2FudCBnbG9iYWwgInB1YnN1YiIgaW4gYSBjb252ZW5pZW50IHBsYWNlLgogIF8uZXh0ZW5kKEJhY2tib25lLCBFdmVudHMpOwogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLyBCYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQogIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCiAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCiAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggdGhlIHNwZWNpZmllZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApCiAgLy8gaXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIGFzc2lnbmVkIGZvciB5b3UuCiAgdmFyIE1vZGVsID0gQmFja2JvbmUuTW9kZWwgPSBmdW5jdGlvbiAoYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikKICAgICAgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwogICAgaWYgKG9wdGlvbnMucGFyc2UpCiAgICAgIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSk7CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuCiAgXy5leHRlbmQoTW9kZWwucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCiAgICAvLyBUaGUgdmFsdWUgcmV0dXJuZWQgZHVyaW5nIHRoZSBsYXN0IGZhaWxlZCB2YWxpZGF0aW9uLgogICAgdmFsaWRhdGlvbkVycm9yOiBudWxsLAogICAgLy8gVGhlIGRlZmF1bHQgbmFtZSBmb3IgdGhlIEpTT04gYGlkYCBhdHRyaWJ1dGUgaXMgYCJpZCJgLiBNb25nb0RCIGFuZAogICAgLy8gQ291Y2hEQiB1c2VycyBtYXkgd2FudCB0byBzZXQgdGhpcyB0byBgIl9pZCJgLgogICAgaWRBdHRyaWJ1dGU6ICdpZCcsCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgfSwKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1thdHRyXTsKICAgIH0sCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgIHJldHVybiBfLmVzY2FwZSh0aGlzLmdldChhdHRyKSk7CiAgICB9LAogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0KGF0dHIpICE9IG51bGw7CiAgICB9LAogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbiAoa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHIsIGF0dHJzLCB1bnNldCwgY2hhbmdlcywgc2lsZW50LCBjaGFuZ2luZywgcHJldiwgY3VycmVudDsKICAgICAgaWYgKGtleSA9PSBudWxsKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAvLyBFeHRyYWN0IGF0dHJpYnV0ZXMgYW5kIG9wdGlvbnMuCiAgICAgIHVuc2V0ID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgPSBbXTsKICAgICAgY2hhbmdpbmcgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgPSB0cnVlOwogICAgICBpZiAoIWNoYW5naW5nKSB7CiAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgICB9CiAgICAgIGN1cnJlbnQgPSB0aGlzLmF0dHJpYnV0ZXMsIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKQogICAgICAgIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKICAgICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLCB1cGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgogICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKICAgICAgICB2YWwgPSBhdHRyc1thdHRyXTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChjdXJyZW50W2F0dHJdLCB2YWwpKQogICAgICAgICAgY2hhbmdlcy5wdXNoKGF0dHIpOwogICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkpIHsKICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlZFthdHRyXTsKICAgICAgICB9CiAgICAgICAgdW5zZXQgPyBkZWxldGUgY3VycmVudFthdHRyXSA6IGN1cnJlbnRbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgLy8gVHJpZ2dlciBhbGwgcmVsZXZhbnQgYXR0cmlidXRlIGNoYW5nZXMuCiAgICAgIGlmICghc2lsZW50KSB7CiAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoKQogICAgICAgICAgdGhpcy5fcGVuZGluZyA9IG9wdGlvbnM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6JyArIGNoYW5nZXNbaV0sIHRoaXMsIGN1cnJlbnRbY2hhbmdlc1tpXV0sIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBZb3UgbWlnaHQgYmUgd29uZGVyaW5nIHdoeSB0aGVyZSdzIGEgYHdoaWxlYCBsb29wIGhlcmUuIENoYW5nZXMgY2FuCiAgICAgIC8vIGJlIHJlY3Vyc2l2ZWx5IG5lc3RlZCB3aXRoaW4gYCJjaGFuZ2UiYCBldmVudHMuCiAgICAgIGlmIChjaGFuZ2luZykKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgb3B0aW9ucyA9IHRoaXMuX3BlbmRpbmc7CiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFJlbW92ZSBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLiBgdW5zZXRgIGlzIGEgbm9vcAogICAgLy8gaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgdW5zZXQ6IGZ1bmN0aW9uIChhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7IHVuc2V0OiB0cnVlIH0pKTsKICAgIH0sCiAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLgogICAgY2xlYXI6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKQogICAgICAgIGF0dHJzW2tleV0gPSB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHsgdW5zZXQ6IHRydWUgfSkpOwogICAgfSwKICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbiAoYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsKQogICAgICAgIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwogICAgfSwKICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCiAgICAvLyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gY2hhbmdlZCBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIGRldGVybWluaW5nIHdoYXQKICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICAvLyBZb3UgY2FuIGFsc28gcGFzcyBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBkaWZmIGFnYWluc3QgdGhlIG1vZGVsLAogICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbiAoZGlmZikgewogICAgICBpZiAoIWRpZmYpCiAgICAgICAgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gXy5jbG9uZSh0aGlzLmNoYW5nZWQpIDogZmFsc2U7CiAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKHZhciBhdHRyIGluIGRpZmYpIHsKICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgdmFsID0gZGlmZlthdHRyXSkpCiAgICAgICAgICBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAogICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CiAgICAvLyBgImNoYW5nZSJgIGV2ZW50IHdhcyBmaXJlZC4KICAgIHByZXZpb3VzOiBmdW5jdGlvbiAoYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAogICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CiAgICB9LAogICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQogICAgLy8gbW9kZWwgZGlmZmVycyBmcm9tIGl0cyBjdXJyZW50IGF0dHJpYnV0ZXMsIHRoZXkgd2lsbCBiZSBvdmVycmlkZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApCiAgICAgICAgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpLCBvcHRpb25zKSkKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCiAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKICAgIC8vIHN0YXRlIHdpbGwgYmUgYHNldGAgYWdhaW4uCiAgICBzYXZlOiBmdW5jdGlvbiAoa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsgdmFsaWRhdGU6IHRydWUgfSwgb3B0aW9ucyk7CiAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKICAgICAgLy8gYHNldChhdHRyKS5zYXZlKG51bGwsIG9wdHMpYCB3aXRoIHZhbGlkYXRpb24uIE90aGVyd2lzZSwgY2hlY2sgaWYKICAgICAgLy8gdGhlIG1vZGVsIHdpbGwgYmUgdmFsaWQgd2hlbiB0aGUgYXR0cmlidXRlcywgaWYgYW55LCBhcmUgc2V0LgogICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewogICAgICAgIGlmICghdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIFNldCB0ZW1wb3JhcnkgYXR0cmlidXRlcyBpZiBge3dhaXQ6IHRydWV9YC4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgewogICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IF8uZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgIH0KICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApCiAgICAgICAgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgIC8vIEVuc3VyZSBhdHRyaWJ1dGVzIGFyZSByZXN0b3JlZCBkdXJpbmcgc3luY2hyb25vdXMgc2F2ZXMuCiAgICAgICAgbW9kZWwuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkKICAgICAgICAgIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKICAgICAgICBpZiAoXy5pc09iamVjdChzZXJ2ZXJBdHRycykgJiYgIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogb3B0aW9ucy5wYXRjaCA/ICdwYXRjaCcgOiAndXBkYXRlJzsKICAgICAgaWYgKG1ldGhvZCA9PT0gJ3BhdGNoJykKICAgICAgICBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwogICAgICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpCiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpCiAgICAgICAgICBkZXN0cm95KCk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoIW1vZGVsLmlzTmV3KCkpCiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgdmFyIHhociA9IHRoaXMuc3luYygnZGVsZXRlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KQogICAgICAgIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCiAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICB1cmw6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpCiAgICAgICAgcmV0dXJuIGJhc2U7CiAgICAgIHJldHVybiBiYXNlLnJlcGxhY2UoLyhbXlwvXSkkLywgJyQxLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwogICAgfSwKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uIChyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICF0aGlzLmhhcyh0aGlzLmlkQXR0cmlidXRlKTsKICAgIH0sCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGUoe30sIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsgdmFsaWRhdGU6IHRydWUgfSkpOwogICAgfSwKICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCiAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uIChhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRpb25FcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHx8IG51bGw7CiAgICAgIGlmICghZXJyb3IpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIGVycm9yLCBfLmV4dGVuZChvcHRpb25zLCB7IHZhbGlkYXRpb25FcnJvcjogZXJyb3IgfSkpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSk7CiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIE1vZGVsLgogIHZhciBtb2RlbE1ldGhvZHMgPSBbCiAgICAna2V5cycsCiAgICAndmFsdWVzJywKICAgICdwYWlycycsCiAgICAnaW52ZXJ0JywKICAgICdwaWNrJywKICAgICdvbWl0JwogIF07CiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgTW9kZWwjYXR0cmlidXRlc2AuCiAgXy5lYWNoKG1vZGVsTWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLyBJZiBtb2RlbHMgdGVuZCB0byByZXByZXNlbnQgYSBzaW5nbGUgcm93IG9mIGRhdGEsIGEgQmFja2JvbmUgQ29sbGVjdGlvbiBpcwogIC8vIG1vcmUgYW5hbGFnb3VzIHRvIGEgdGFibGUgZnVsbCBvZiBkYXRhIC4uLiBvciBhIHNtYWxsIHNsaWNlIG9yIHBhZ2Ugb2YgdGhhdAogIC8vIHRhYmxlLCBvciBhIGNvbGxlY3Rpb24gb2Ygcm93cyB0aGF0IGJlbG9uZyB0b2dldGhlciBmb3IgYSBwYXJ0aWN1bGFyIHJlYXNvbgogIC8vIC0tIGFsbCBvZiB0aGUgbWVzc2FnZXMgaW4gdGhpcyBwYXJ0aWN1bGFyIGZvbGRlciwgYWxsIG9mIHRoZSBkb2N1bWVudHMKICAvLyBiZWxvbmdpbmcgdG8gdGhpcyBwYXJ0aWN1bGFyIGF1dGhvciwgYW5kIHNvIG9uLiBDb2xsZWN0aW9ucyBtYWludGFpbgogIC8vIGluZGV4ZXMgb2YgdGhlaXIgbW9kZWxzLCBib3RoIGluIG9yZGVyLCBhbmQgZm9yIGxvb2t1cCBieSBgaWRgLgogIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgogIC8vIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbgogIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMubW9kZWwpCiAgICAgIHRoaXMubW9kZWwgPSBvcHRpb25zLm1vZGVsOwogICAgaWYgKG9wdGlvbnMuY29tcGFyYXRvciAhPT0gdm9pZCAwKQogICAgICB0aGlzLmNvbXBhcmF0b3IgPSBvcHRpb25zLmNvbXBhcmF0b3I7CiAgICB0aGlzLl9yZXNldCgpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAobW9kZWxzKQogICAgICB0aGlzLnJlc2V0KG1vZGVscywgXy5leHRlbmQoeyBzaWxlbnQ6IHRydWUgfSwgb3B0aW9ucykpOwogIH07CiAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgogIHZhciBzZXRPcHRpb25zID0gewogICAgYWRkOiB0cnVlLAogICAgcmVtb3ZlOiB0cnVlLAogICAgbWVyZ2U6IHRydWUKICB9OwogIHZhciBhZGRPcHRpb25zID0gewogICAgYWRkOiB0cnVlLAogICAgcmVtb3ZlOiBmYWxzZQogIH07CiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CiAgICAvLyBUaGUgZGVmYXVsdCBtb2RlbCBmb3IgYSBjb2xsZWN0aW9uIGlzIGp1c3QgYSAqKkJhY2tib25lLk1vZGVsKiouCiAgICAvLyBUaGlzIHNob3VsZCBiZSBvdmVycmlkZGVuIGluIG1vc3QgY2FzZXMuCiAgICBtb2RlbDogTW9kZWwsCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgfSwKICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUKICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KICAgIHRvSlNPTjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7CiAgICAgIH0pOwogICAgfSwKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgogICAgc3luYzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEFkZCBhIG1vZGVsLCBvciBsaXN0IG9mIG1vZGVscyB0byB0aGUgc2V0LgogICAgYWRkOiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHsgbWVyZ2U6IGZhbHNlIH0sIG9wdGlvbnMsIGFkZE9wdGlvbnMpKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCiAgICByZW1vdmU6IGZ1bmN0aW9uIChtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IFttb2RlbHNdIDogXy5jbG9uZShtb2RlbHMpOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5nZXQobW9kZWxzW2ldKTsKICAgICAgICBpZiAoIW1vZGVsKQogICAgICAgICAgY29udGludWU7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKICAgIC8vIFVwZGF0ZSBhIGNvbGxlY3Rpb24gYnkgYHNldGAtaW5nIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCBhZGRpbmcgbmV3IG9uZXMsCiAgICAvLyByZW1vdmluZyBtb2RlbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHByZXNlbnQsIGFuZCBtZXJnaW5nIG1vZGVscyB0aGF0CiAgICAvLyBhbHJlYWR5IGV4aXN0IGluIHRoZSBjb2xsZWN0aW9uLCBhcyBuZWNlc3NhcnkuIFNpbWlsYXIgdG8gKipNb2RlbCNzZXQqKiwKICAgIC8vIHRoZSBjb3JlIG9wZXJhdGlvbiBmb3IgdXBkYXRpbmcgdGhlIGRhdGEgY29udGFpbmVkIGJ5IHRoZSBjb2xsZWN0aW9uLgogICAgc2V0OiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpCiAgICAgICAgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMsIG9wdGlvbnMpOwogICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CiAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gbW9kZWxzID8gW21vZGVsc10gOiBbXSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgdmFyIGksIGwsIGlkLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwogICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwogICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgYXQgPT0gbnVsbCAmJiBvcHRpb25zLnNvcnQgIT09IGZhbHNlOwogICAgICB2YXIgc29ydEF0dHIgPSBfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgPyB0aGlzLmNvbXBhcmF0b3IgOiBudWxsOwogICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKICAgICAgdmFyIGFkZCA9IG9wdGlvbnMuYWRkLCBtZXJnZSA9IG9wdGlvbnMubWVyZ2UsIHJlbW92ZSA9IG9wdGlvbnMucmVtb3ZlOwogICAgICB2YXIgb3JkZXIgPSAhc29ydGFibGUgJiYgYWRkICYmIHJlbW92ZSA/IFtdIDogZmFsc2U7CiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBhdHRycyA9IG1vZGVsc1tpXSB8fCB7fTsKICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZSB8fCAnaWQnXTsKICAgICAgICB9CiAgICAgICAgLy8gSWYgYSBkdXBsaWNhdGUgaXMgZm91bmQsIHByZXZlbnQgaXQgZnJvbSBiZWluZyBhZGRlZCBhbmQKICAgICAgICAvLyBvcHRpb25hbGx5IG1lcmdlIGl0IGludG8gdGhlIGV4aXN0aW5nIG1vZGVsLgogICAgICAgIGlmIChleGlzdGluZyA9IHRoaXMuZ2V0KGlkKSkgewogICAgICAgICAgaWYgKHJlbW92ZSkKICAgICAgICAgICAgbW9kZWxNYXBbZXhpc3RpbmcuY2lkXSA9IHRydWU7CiAgICAgICAgICBpZiAobWVyZ2UpIHsKICAgICAgICAgICAgYXR0cnMgPSBhdHRycyA9PT0gbW9kZWwgPyBtb2RlbC5hdHRyaWJ1dGVzIDogYXR0cnM7CiAgICAgICAgICAgIGlmIChvcHRpb25zLnBhcnNlKQogICAgICAgICAgICAgIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydGFibGUgJiYgIXNvcnQgJiYgZXhpc3RpbmcuaGFzQ2hhbmdlZChzb3J0QXR0cikpCiAgICAgICAgICAgICAgc29ydCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBtb2RlbHNbaV0gPSBleGlzdGluZzsgIC8vIElmIHRoaXMgaXMgYSBuZXcsIHZhbGlkIG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgdG9BZGRgIGxpc3QuCiAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgIGlmICghbW9kZWwpCiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CiAgICAgICAgICB0aGlzLl9hZGRSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICAvLyBEbyBub3QgYWRkIG11bHRpcGxlIG1vZGVscyB3aXRoIHRoZSBzYW1lIGBpZGAuCiAgICAgICAgbW9kZWwgPSBleGlzdGluZyB8fCBtb2RlbDsKICAgICAgICBpZiAob3JkZXIgJiYgKG1vZGVsLmlzTmV3KCkgfHwgIW1vZGVsTWFwW21vZGVsLmlkXSkpCiAgICAgICAgICBvcmRlci5wdXNoKG1vZGVsKTsKICAgICAgICBtb2RlbE1hcFttb2RlbC5pZF0gPSB0cnVlOwogICAgICB9CiAgICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pCiAgICAgICAgICAgIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgICBpZiAodG9SZW1vdmUubGVuZ3RoKQogICAgICAgICAgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKHRvQWRkLmxlbmd0aCB8fCBvcmRlciAmJiBvcmRlci5sZW5ndGgpIHsKICAgICAgICBpZiAoc29ydGFibGUpCiAgICAgICAgICBzb3J0ID0gdHJ1ZTsKICAgICAgICB0aGlzLmxlbmd0aCArPSB0b0FkZC5sZW5ndGg7CiAgICAgICAgaWYgKGF0ICE9IG51bGwpIHsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0b0FkZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGF0ICsgaSwgMCwgdG9BZGRbaV0pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAob3JkZXIpCiAgICAgICAgICAgIHRoaXMubW9kZWxzLmxlbmd0aCA9IDA7CiAgICAgICAgICB2YXIgb3JkZXJlZE1vZGVscyA9IG9yZGVyIHx8IHRvQWRkOwogICAgICAgICAgZm9yIChpID0gMCwgbCA9IG9yZGVyZWRNb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMubW9kZWxzLnB1c2gob3JkZXJlZE1vZGVsc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KQogICAgICAgIHRoaXMuc29ydCh7IHNpbGVudDogdHJ1ZSB9KTsKICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnQgfHwgb3JkZXIgJiYgb3JkZXIubGVuZ3RoKQogICAgICAgICAgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgLy8gUmV0dXJuIHRoZSBhZGRlZCAob3IgbWVyZ2VkKSBtb2RlbCAob3IgbW9kZWxzKS4KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCiAgICByZXNldDogZnVuY3Rpb24gKG1vZGVscywgb3B0aW9ucykgewogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOwogICAgICB0aGlzLl9yZXNldCgpOwogICAgICBtb2RlbHMgPSB0aGlzLmFkZChtb2RlbHMsIF8uZXh0ZW5kKHsgc2lsZW50OiB0cnVlIH0sIG9wdGlvbnMpKTsKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkKICAgICAgICB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbHM7CiAgICB9LAogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHB1c2g6IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHsgYXQ6IHRoaXMubGVuZ3RoIH0sIG9wdGlvbnMpKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQodGhpcy5sZW5ndGggLSAxKTsKICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHsgYXQ6IDAgfSwgb3B0aW9ucykpOwogICAgfSwKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHNoaWZ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICBzbGljZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc2xpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmpdIHx8IHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdOwogICAgfSwKICAgIC8vIEdldCB0aGUgbW9kZWwgYXQgdGhlIGdpdmVuIGluZGV4LgogICAgYXQ6IGZ1bmN0aW9uIChpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKICAgIC8vIFJldHVybiBtb2RlbHMgd2l0aCBtYXRjaGluZyBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIHNpbXBsZSBjYXNlcyBvZgogICAgLy8gYGZpbHRlcmAuCiAgICB3aGVyZTogZnVuY3Rpb24gKGF0dHJzLCBmaXJzdCkgewogICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkKICAgICAgICByZXR1cm4gZmlyc3QgPyB2b2lkIDAgOiBbXTsKICAgICAgcmV0dXJuIHRoaXNbZmlyc3QgPyAnZmluZCcgOiAnZmlsdGVyJ10oZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKICAgIC8vIFJldHVybiB0aGUgZmlyc3QgbW9kZWwgd2l0aCBtYXRjaGluZyBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIHNpbXBsZSBjYXNlcwogICAgLy8gb2YgYGZpbmRgLgogICAgZmluZFdoZXJlOiBmdW5jdGlvbiAoYXR0cnMpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwogICAgfSwKICAgIC8vIEZvcmNlIHRoZSBjb2xsZWN0aW9uIHRvIHJlLXNvcnQgaXRzZWxmLiBZb3UgZG9uJ3QgbmVlZCB0byBjYWxsIHRoaXMgdW5kZXIKICAgIC8vIG5vcm1hbCBjaXJjdW1zdGFuY2VzLCBhcyB0aGUgc2V0IHdpbGwgbWFpbnRhaW4gc29ydCBvcmRlciBhcyBlYWNoIGl0ZW0KICAgIC8vIGlzIGFkZGVkLgogICAgc29ydDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc29ydCBhIHNldCB3aXRob3V0IGEgY29tcGFyYXRvcicpOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAvLyBSdW4gc29ydCBiYXNlZCBvbiB0eXBlIG9mIGBjb21wYXJhdG9yYC4KICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwogICAgICB9CiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpCiAgICAgICAgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBwbHVjazogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7CiAgICB9LAogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHJlc2V0YCBtZXRob2QgaW5zdGVhZCBvZiBgc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkKICAgICAgICBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICB2YXIgbWV0aG9kID0gb3B0aW9ucy5yZXNldCA/ICdyZXNldCcgOiAnc2V0JzsKICAgICAgICBjb2xsZWN0aW9uW21ldGhvZF0ocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCiAgICAvLyBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgYSBtb2RlbCBpbiB0aGlzIGNvbGxlY3Rpb24uIEFkZCB0aGUgbW9kZWwgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uIGltbWVkaWF0ZWx5LCB1bmxlc3MgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgaW4gd2hpY2ggY2FzZSB3ZQogICAgLy8gd2FpdCBmb3IgdGhlIHNlcnZlciB0byBhZ3JlZS4KICAgIGNyZWF0ZTogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucykpKQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpCiAgICAgICAgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAobW9kZWwsIHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KQogICAgICAgICAgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKQogICAgICAgICAgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgaXQgdGhyb3VnaC4KICAgIHBhcnNlOiBmdW5jdGlvbiAocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCiAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAogICAgLy8gUHJpdmF0ZSBtZXRob2QgdG8gcmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaXMgZmlyc3QgaW5pdGlhbGl6ZWQgb3IgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICB0aGlzLl9ieUlkID0ge307CiAgICB9LAogICAgLy8gUHJlcGFyZSBhIGhhc2ggb2YgYXR0cmlidXRlcyAob3Igb3RoZXIgbW9kZWwpIHRvIGJlIGFkZGVkIHRvIHRoaXMKICAgIC8vIGNvbGxlY3Rpb24uCiAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbiAoYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpCiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgb3B0aW9ucy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIG1vZGVsID0gbmV3IHRoaXMubW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICBpZiAoIW1vZGVsLnZhbGlkYXRpb25FcnJvcikKICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIG1vZGVsLnZhbGlkYXRpb25FcnJvciwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KICAgIF9hZGRSZWZlcmVuY2U6IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykgewogICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpCiAgICAgICAgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgaWYgKCFtb2RlbC5jb2xsZWN0aW9uKQogICAgICAgIG1vZGVsLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzID09PSBtb2RlbC5jb2xsZWN0aW9uKQogICAgICAgIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbiAoZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykKICAgICAgICByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKQogICAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgaWYgKG1vZGVsICYmIGV2ZW50ID09PSAnY2hhbmdlOicgKyBtb2RlbC5pZEF0dHJpYnV0ZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLnByZXZpb3VzKG1vZGVsLmlkQXR0cmlidXRlKV07CiAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpCiAgICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0pOwogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCiAgLy8gcmlnaHQgaGVyZToKICB2YXIgbWV0aG9kcyA9IFsKICAgICdmb3JFYWNoJywKICAgICdlYWNoJywKICAgICdtYXAnLAogICAgJ2NvbGxlY3QnLAogICAgJ3JlZHVjZScsCiAgICAnZm9sZGwnLAogICAgJ2luamVjdCcsCiAgICAncmVkdWNlUmlnaHQnLAogICAgJ2ZvbGRyJywKICAgICdmaW5kJywKICAgICdkZXRlY3QnLAogICAgJ2ZpbHRlcicsCiAgICAnc2VsZWN0JywKICAgICdyZWplY3QnLAogICAgJ2V2ZXJ5JywKICAgICdhbGwnLAogICAgJ3NvbWUnLAogICAgJ2FueScsCiAgICAnaW5jbHVkZScsCiAgICAnY29udGFpbnMnLAogICAgJ2ludm9rZScsCiAgICAnbWF4JywKICAgICdtaW4nLAogICAgJ3RvQXJyYXknLAogICAgJ3NpemUnLAogICAgJ2ZpcnN0JywKICAgICdoZWFkJywKICAgICd0YWtlJywKICAgICdpbml0aWFsJywKICAgICdyZXN0JywKICAgICd0YWlsJywKICAgICdkcm9wJywKICAgICdsYXN0JywKICAgICd3aXRob3V0JywKICAgICdkaWZmZXJlbmNlJywKICAgICdpbmRleE9mJywKICAgICdzaHVmZmxlJywKICAgICdsYXN0SW5kZXhPZicsCiAgICAnaXNFbXB0eScsCiAgICAnY2hhaW4nLAogICAgJ3NhbXBsZScKICBdOwogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHRha2UgYSBwcm9wZXJ0eSBuYW1lIGFzIGFuIGFyZ3VtZW50LgogIHZhciBhdHRyaWJ1dGVNZXRob2RzID0gWwogICAgJ2dyb3VwQnknLAogICAgJ2NvdW50QnknLAogICAgJ3NvcnRCeScsCiAgICAnaW5kZXhCeScKICBdOwogIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KICBfLmVhY2goYXR0cmlidXRlTWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICh2YWx1ZSwgY29udGV4dCkgewogICAgICB2YXIgaXRlcmF0b3IgPSBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbiAobW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKICAgICAgfTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfTsKICB9KTsKICAvLyBCYWNrYm9uZS5WaWV3CiAgLy8gLS0tLS0tLS0tLS0tLQogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLgogIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwogIC8vIExpc3Qgb2YgdmlldyBvcHRpb25zIHRvIGJlIG1lcmdlZCBhcyBwcm9wZXJ0aWVzLgogIHZhciB2aWV3T3B0aW9ucyA9IFsKICAgICdtb2RlbCcsCiAgICAnY29sbGVjdGlvbicsCiAgICAnZWwnLAogICAgJ2lkJywKICAgICdhdHRyaWJ1dGVzJywKICAgICdjbGFzc05hbWUnLAogICAgJ3RhZ05hbWUnLAogICAgJ2V2ZW50cycKICBdOwogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CiAgICAvLyBUaGUgZGVmYXVsdCBgdGFnTmFtZWAgb2YgYSBWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLgogICAgdGFnTmFtZTogJ2RpdicsCiAgICAvLyBqUXVlcnkgZGVsZWdhdGUgZm9yIGVsZW1lbnQgbG9va3VwLCBzY29wZWQgdG8gRE9NIGVsZW1lbnRzIHdpdGhpbiB0aGUKICAgIC8vIGN1cnJlbnQgdmlldy4gVGhpcyBzaG91bGQgYmUgcHJlZmVycmVkIHRvIGdsb2JhbCBsb29rdXBzIHdoZXJlIHBvc3NpYmxlLgogICAgJDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgfSwKICAgIC8vICoqcmVuZGVyKiogaXMgdGhlIGNvcmUgZnVuY3Rpb24gdGhhdCB5b3VyIHZpZXcgc2hvdWxkIG92ZXJyaWRlLCBpbiBvcmRlcgogICAgLy8gdG8gcG9wdWxhdGUgaXRzIGVsZW1lbnQgKGB0aGlzLmVsYCksIHdpdGggdGhlIGFwcHJvcHJpYXRlIEhUTUwuIFRoZQogICAgLy8gY29udmVudGlvbiBpcyBmb3IgKipyZW5kZXIqKiB0byBhbHdheXMgcmV0dXJuIGB0aGlzYC4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBSZW1vdmUgdGhpcyB2aWV3IGJ5IHRha2luZyB0aGUgZWxlbWVudCBvdXQgb2YgdGhlIERPTSwgYW5kIHJlbW92aW5nIGFueQogICAgLy8gYXBwbGljYWJsZSBCYWNrYm9uZS5FdmVudHMgbGlzdGVuZXJzLgogICAgcmVtb3ZlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gQ2hhbmdlIHRoZSB2aWV3J3MgZWxlbWVudCAoYHRoaXMuZWxgIHByb3BlcnR5KSwgaW5jbHVkaW5nIGV2ZW50CiAgICAvLyByZS1kZWxlZ2F0aW9uLgogICAgc2V0RWxlbWVudDogZnVuY3Rpb24gKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkKICAgICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgdGhpcy4kZWwgPSBlbGVtZW50IGluc3RhbmNlb2YgQmFja2JvbmUuJCA/IGVsZW1lbnQgOiBCYWNrYm9uZS4kKGVsZW1lbnQpOwogICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07CiAgICAgIGlmIChkZWxlZ2F0ZSAhPT0gZmFsc2UpCiAgICAgICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJywKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24gKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKQogICAgICAgICAgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpCiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIHNlbGVjdG9yLCBtZXRob2QpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4KICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQogICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCiAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKICAgIC8vIG1hdGNoaW5nIGVsZW1lbnQsIGFuZCByZS1hc3NpZ24gaXQgdG8gYGVsYC4gT3RoZXJ3aXNlLCBjcmVhdGUKICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKQogICAgICAgICAgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsKICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpCiAgICAgICAgICBhdHRyc1snY2xhc3MnXSA9IF8ucmVzdWx0KHRoaXMsICdjbGFzc05hbWUnKTsKICAgICAgICB2YXIgJGVsID0gQmFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KICB9KTsKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQogIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKICAvLyBtb2RlbCBpbiBxdWVzdGlvbi4gQnkgZGVmYXVsdCwgbWFrZXMgYSBSRVNUZnVsIEFqYXggcmVxdWVzdAogIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CiAgLy8KICAvLyAqIFVzZSBgc2V0VGltZW91dGAgdG8gYmF0Y2ggcmFwaWQtZmlyZSB1cGRhdGVzIGludG8gYSBzaW5nbGUgcmVxdWVzdC4KICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgogIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgogIC8vCiAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCiAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAogIC8vIGFzIHdlbGwgYXMgYWxsIHJlcXVlc3RzIHdpdGggdGhlIGJvZHkgYXMgYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAKICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQogIC8vIGl0IGRpZmZpY3VsdCB0byByZWFkIHRoZSBib2R5IG9mIGBQVVRgIHJlcXVlc3RzLgogIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbiAobWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewogICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCiAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTgogICAgfSk7CiAgICAvLyBEZWZhdWx0IEpTT04tcmVxdWVzdCBvcHRpb25zLgogICAgdmFyIHBhcmFtcyA9IHsKICAgICAgdHlwZTogdHlwZSwKICAgICAgZGF0YVR5cGU6ICdqc29uJwogICAgfTsKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCiAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CiAgICB9CiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBKU09OIGJ5IGVuY29kaW5nIHRoZSByZXF1ZXN0IGludG8gYW4gSFRNTC1mb3JtLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCc7CiAgICAgIHBhcmFtcy5kYXRhID0gcGFyYW1zLmRhdGEgPyB7IG1vZGVsOiBwYXJhbXMuZGF0YSB9IDoge307CiAgICB9CiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CiAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikKICAgICAgICBwYXJhbXMuZGF0YS5fbWV0aG9kID0gdHlwZTsKICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9IGZ1bmN0aW9uICh4aHIpIHsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgIGlmIChiZWZvcmVTZW5kKQogICAgICAgICAgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CiAgICB9CiAgICAvLyBJZiB3ZSdyZSBzZW5kaW5nIGEgYFBBVENIYCByZXF1ZXN0LCBhbmQgd2UncmUgaW4gYW4gb2xkIEludGVybmV0IEV4cGxvcmVyCiAgICAvLyB0aGF0IHN0aWxsIGhhcyBBY3RpdmVYIGVuYWJsZWQgYnkgZGVmYXVsdCwgb3ZlcnJpZGUgalF1ZXJ5IHRvIHVzZSB0aGF0CiAgICAvLyBmb3IgWEhSIGluc3RlYWQuIFJlbW92ZSB0aGlzIGxpbmUgd2hlbiBqUXVlcnkgc3VwcG9ydHMgYFBBVENIYCBvbiBJRTguCiAgICBpZiAocGFyYW1zLnR5cGUgPT09ICdQQVRDSCcgJiYgbm9YaHJQYXRjaCkgewogICAgICBwYXJhbXMueGhyID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKTsKICAgICAgfTsKICAgIH0KICAgIC8vIE1ha2UgdGhlIHJlcXVlc3QsIGFsbG93aW5nIHRoZSB1c2VyIHRvIG92ZXJyaWRlIGFueSBBamF4IG9wdGlvbnMuCiAgICB2YXIgeGhyID0gb3B0aW9ucy54aHIgPSBCYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOwogICAgbW9kZWwudHJpZ2dlcigncmVxdWVzdCcsIG1vZGVsLCB4aHIsIG9wdGlvbnMpOwogICAgcmV0dXJuIHhocjsKICB9OwogIHZhciBub1hoclBhdGNoID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJiAhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiBuZXcgWE1MSHR0cFJlcXVlc3QoKS5kaXNwYXRjaEV2ZW50KTsKICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBCYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4KICB2YXIgbWV0aG9kTWFwID0gewogICAgJ2NyZWF0ZSc6ICdQT1NUJywKICAgICd1cGRhdGUnOiAnUFVUJywKICAgICdwYXRjaCc6ICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICdHRVQnCiAgfTsKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIC8vIE92ZXJyaWRlIHRoaXMgaWYgeW91J2QgbGlrZSB0byB1c2UgYSBkaWZmZXJlbnQgbGlicmFyeS4KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIEJhY2tib25lLiQuYWpheC5hcHBseShCYWNrYm9uZS4kLCBhcmd1bWVudHMpOwogIH07CiAgLy8gQmFja2JvbmUuUm91dGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLnJvdXRlcykKICAgICAgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgPSAvW1wte31cW1xdKz8uLFxcXF4kfCNcc10vZzsKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24gKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKQogICAgICAgIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgICBjYWxsYmFjayA9IG5hbWU7CiAgICAgICAgbmFtZSA9ICcnOwogICAgICB9CiAgICAgIGlmICghY2FsbGJhY2spCiAgICAgICAgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwogICAgICB2YXIgcm91dGVyID0gdGhpczsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgZnVuY3Rpb24gKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgcm91dGVyLmV4ZWN1dGUoY2FsbGJhY2ssIGFyZ3MpOwogICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICByb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgcm91dGVyLCBuYW1lLCBhcmdzKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIEV4ZWN1dGUgYSByb3V0ZSBoYW5kbGVyIHdpdGggdGhlIHByb3ZpZGVkIHBhcmFtZXRlcnMuICBUaGlzIGlzIGFuCiAgICAvLyBleGNlbGxlbnQgcGxhY2UgdG8gZG8gcHJlLXJvdXRlIHNldHVwIG9yIHBvc3Qtcm91dGUgY2xlYW51cC4KICAgIGV4ZWN1dGU6IGZ1bmN0aW9uIChjYWxsYmFjaywgYXJncykgewogICAgICBpZiAoY2FsbGJhY2spCiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICB9LAogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbiAoZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQogICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAogICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpCiAgICAgICAgcmV0dXJuOwogICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCiAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCiAgICBfcm91dGVUb1JlZ0V4cDogZnVuY3Rpb24gKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykucmVwbGFjZShvcHRpb25hbFBhcmFtLCAnKD86JDEpPycpLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24gKG1hdGNoLCBvcHRpb25hbCkgewogICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXi8/XSspJzsKICAgICAgfSkucmVwbGFjZShzcGxhdFBhcmFtLCAnKFteP10qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnKD86XFw/KFtcXHNcXFNdKikpPyQnKTsKICAgIH0sCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgZGVjb2RlZCBwYXJhbWV0ZXJzLiBFbXB0eSBvciB1bm1hdGNoZWQgcGFyYW1ldGVycyB3aWxsIGJlCiAgICAvLyB0cmVhdGVkIGFzIGBudWxsYCB0byBub3JtYWxpemUgY3Jvc3MtYnJvd3NlciBiZWhhdmlvci4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24gKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uIChwYXJhbSwgaSkgewogICAgICAgIC8vIERvbid0IGRlY29kZSB0aGUgc2VhcmNoIHBhcmFtcy4KICAgICAgICBpZiAoaSA9PT0gcGFyYW1zLmxlbmd0aCAtIDEpCiAgICAgICAgICByZXR1cm4gcGFyYW0gfHwgbnVsbDsKICAgICAgICByZXR1cm4gcGFyYW0gPyBkZWNvZGVVUklDb21wb25lbnQocGFyYW0pIDogbnVsbDsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KICAvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBlaXRoZXIKICAvLyBbcHVzaFN0YXRlXShodHRwOi8vZGl2ZWludG9odG1sNS5pbmZvL2hpc3RvcnkuaHRtbCkgYW5kIHJlYWwgVVJMcywgb3IKICAvLyBbb25oYXNoY2hhbmdlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS93aW5kb3cub25oYXNoY2hhbmdlKQogIC8vIGFuZCBVUkwgZnJhZ21lbnRzLiBJZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBuZWl0aGVyIChvbGQgSUUsIG5hdGNoKSwKICAvLyBmYWxscyBiYWNrIHRvIHBvbGxpbmcuCiAgdmFyIEhpc3RvcnkgPSBCYWNrYm9uZS5IaXN0b3J5ID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwogICAgLy8gRW5zdXJlIHRoYXQgYEhpc3RvcnlgIGNhbiBiZSB1c2VkIG91dHNpZGUgb2YgdGhlIGJyb3dzZXIuCiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgdGhpcy5sb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKICAgICAgdGhpcy5oaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CiAgICB9CiAgfTsKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBhIGxlYWRpbmcgaGFzaC9zbGFzaCBhbmQgdHJhaWxpbmcgc3BhY2UuCiAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBkZXRlY3RpbmcgTVNJRS4KICB2YXIgaXNFeHBsb3JlciA9IC9tc2llIFtcdy5dKy87CiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgogIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoLgogIHZhciBwYXRoU3RyaXBwZXIgPSAvIy4qJC87CiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CiAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgIGludGVydmFsOiA1MCwKICAgIC8vIEFyZSB3ZSBhdCB0aGUgYXBwIHJvb3Q/CiAgICBhdFJvb3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CiAgICB9LAogICAgLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwogICAgLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCiAgICBnZXRIYXNoOiBmdW5jdGlvbiAod2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAogICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAogICAgLy8gdGhlIGhhc2gsIG9yIHRoZSBvdmVycmlkZS4KICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbiAoZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IGRlY29kZVVSSSh0aGlzLmxvY2F0aW9uLnBhdGhuYW1lICsgdGhpcy5sb2NhdGlvbi5zZWFyY2gpOwogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpCiAgICAgICAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAogICAgLy8gU3RhcnQgdGhlIGhhc2ggY2hhbmdlIGhhbmRsaW5nLCByZXR1cm5pbmcgYHRydWVgIGlmIHRoZSBjdXJyZW50IFVSTCBtYXRjaGVzCiAgICAvLyBhbiBleGlzdGluZyByb3V0ZSwgYW5kIGBmYWxzZWAgb3RoZXJ3aXNlLgogICAgc3RhcnQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWNrYm9uZS5oaXN0b3J5IGhhcyBhbHJlYWR5IGJlZW4gc3RhcnRlZCcpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSB0cnVlOwogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7IHJvb3Q6ICcvJyB9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgICB0aGlzLnJvb3QgPSB0aGlzLm9wdGlvbnMucm9vdDsKICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwogICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKICAgICAgdGhpcy5faGFzUHVzaFN0YXRlID0gISEodGhpcy5vcHRpb25zLnB1c2hTdGF0ZSAmJiB0aGlzLmhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5LnB1c2hTdGF0ZSk7CiAgICAgIHZhciBmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgdmFyIGRvY01vZGUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSA9IGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpOwogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHZhciBmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSI+Jyk7CiAgICAgICAgdGhpcy5pZnJhbWUgPSBmcmFtZS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CiAgICAgIC8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSBvciBoYXNoZXMsIGFuZCB3aGV0aGVyCiAgICAgIC8vICdvbmhhc2hjaGFuZ2UnIGlzIHN1cHBvcnRlZCwgZGV0ZXJtaW5lIGhvdyB3ZSBjaGVjayB0aGUgVVJMIHN0YXRlLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CiAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCiAgICAgIC8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4KICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKICAgICAgLy8gVHJhbnNpdGlvbiBmcm9tIGhhc2hDaGFuZ2UgdG8gcHVzaFN0YXRlIG9yIHZpY2UgdmVyc2EgaWYgYm90aCBhcmUKICAgICAgLy8gcmVxdWVzdGVkLgogICAgICBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmIHRoaXMuX3dhbnRzUHVzaFN0YXRlKSB7CiAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCiAgICAgICAgLy8gYnJvd3NlciwgYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhdGhpcy5hdFJvb3QoKSkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CiAgICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICAgIHJldHVybiB0cnVlOyAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW4gYSBicm93c2VyIHdoZXJlIGl0IGNvdWxkIGJlIGBwdXNoU3RhdGVgLWJhc2VkIGluc3RlYWQuLi4KICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSAmJiB0aGlzLmF0Um9vdCgpICYmIGxvYy5oYXNoKSB7CiAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkKICAgICAgICByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CiAgICB9LAogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9mZigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS5vZmYoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgaWYgKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpCiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICB9LAogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbiAocm91dGUsIGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7CiAgICAgICAgcm91dGU6IHJvdXRlLAogICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjawogICAgICB9KTsKICAgIH0sCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgewogICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKQogICAgICAgIHRoaXMubmF2aWdhdGUoY3VycmVudCk7CiAgICAgIHRoaXMubG9hZFVybCgpOwogICAgfSwKICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCiAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAogICAgLy8gcmV0dXJucyBgZmFsc2VgLgogICAgbG9hZFVybDogZnVuY3Rpb24gKGZyYWdtZW50KSB7CiAgICAgIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQpOwogICAgICByZXR1cm4gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24gKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIC8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUKICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKICAgIC8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgogICAgLy8KICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKICAgIC8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCiAgICAvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uIChmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zID09PSB0cnVlKQogICAgICAgIG9wdGlvbnMgPSB7IHRyaWdnZXI6ICEhb3B0aW9ucyB9OwogICAgICB2YXIgdXJsID0gdGhpcy5yb290ICsgKGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJykpOwogICAgICAvLyBTdHJpcCB0aGUgaGFzaCBmb3IgbWF0Y2hpbmcuCiAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKICAgICAgaWYgKHRoaXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KQogICAgICAgIHJldHVybjsKICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCiAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpCiAgICAgICAgdXJsID0gdXJsLnNsaWNlKDAsIC0xKTsKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7ICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSB7CiAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAvLyB3YW50IHRoaXMuCiAgICAgICAgICBpZiAoIW9wdGlvbnMucmVwbGFjZSkKICAgICAgICAgICAgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9ICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KICAgICAgICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKQogICAgICAgIHJldHVybiB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgfSwKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbiAobG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgfQogICAgfQogIH0pOwogIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5LgogIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeSgpOwogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCiAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogIHZhciBleHRlbmQgPSBmdW5jdGlvbiAocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwogICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQogICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAogICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogICAgaWYgKHByb3RvUHJvcHMgJiYgXy5oYXMocHJvdG9Qcm9wcywgJ2NvbnN0cnVjdG9yJykpIHsKICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwogICAgfSBlbHNlIHsKICAgICAgY2hpbGQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogICAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCiAgICBfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CiAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsKICAgIH07CiAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGUoKTsKICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAogICAgLy8gaWYgc3VwcGxpZWQuCiAgICBpZiAocHJvdG9Qcm9wcykKICAgICAgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKICAgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQKICAgIC8vIGxhdGVyLgogICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKICAgIHJldHVybiBjaGlsZDsKICB9OwogIC8vIFNldCB1cCBpbmhlcml0YW5jZSBmb3IgdGhlIG1vZGVsLCBjb2xsZWN0aW9uLCByb3V0ZXIsIHZpZXcgYW5kIGhpc3RvcnkuCiAgTW9kZWwuZXh0ZW5kID0gQ29sbGVjdGlvbi5leHRlbmQgPSBSb3V0ZXIuZXh0ZW5kID0gVmlldy5leHRlbmQgPSBIaXN0b3J5LmV4dGVuZCA9IGV4dGVuZDsKICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCiAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdBICJ1cmwiIHByb3BlcnR5IG9yIGZ1bmN0aW9uIG11c3QgYmUgc3BlY2lmaWVkJyk7CiAgfTsKICAvLyBXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KICB2YXIgd3JhcEVycm9yID0gZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwogICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgIGlmIChlcnJvcikKICAgICAgICBlcnJvcihtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIG1vZGVsLnRyaWdnZXIoJ2Vycm9yJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgfTsKICB9OwogIHJldHVybiBCYWNrYm9uZTsKfSkpOwovLyBCYWNrYm9uZS5XcmVxciAoQmFja2JvbmUuTWFyaW9uZXR0ZSkKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyB2MS4zLjEKLy8KLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCi8vIERpc3RyaWJ1dGVkIHVuZGVyIE1JVCBsaWNlbnNlCi8vCi8vIGh0dHA6Ly9naXRodWIuY29tL21hcmlvbmV0dGVqcy9iYWNrYm9uZS53cmVxcgooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKICBpZiAodHJ1ZSkgewogICAgYmFja2JvbmV3cmVxciA9IGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogICAgICByZXR1cm4gZmFjdG9yeShCYWNrYm9uZSwgXyk7CiAgICB9KGJhY2tib25lLCB1bmRlcnNjb3JlKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgdmFyIEJhY2tib25lID0gYmFja2JvbmU7CiAgICB2YXIgXyA9IHVuZGVyc2NvcmU7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoQmFja2JvbmUsIF8pOwogIH0gZWxzZSB7CiAgICBmYWN0b3J5KHJvb3QuQmFja2JvbmUsIHJvb3QuXyk7CiAgfQp9KHRoaXMsIGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogIAogIHZhciBwcmV2aW91c1dyZXFyID0gQmFja2JvbmUuV3JlcXI7CiAgdmFyIFdyZXFyID0gQmFja2JvbmUuV3JlcXIgPSB7fTsKICBCYWNrYm9uZS5XcmVxci5WRVJTSU9OID0gJzEuMy4xJzsKICBCYWNrYm9uZS5XcmVxci5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgQmFja2JvbmUuV3JlcXIgPSBwcmV2aW91c1dyZXFyOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvLyBIYW5kbGVycwogIC8vIC0tLS0tLS0tCiAgLy8gQSByZWdpc3RyeSBvZiBmdW5jdGlvbnMgdG8gY2FsbCwgZ2l2ZW4gYSBuYW1lCiAgV3JlcXIuSGFuZGxlcnMgPSBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAgIAogICAgLy8gQ29uc3RydWN0b3IKICAgIC8vIC0tLS0tLS0tLS0tCiAgICB2YXIgSGFuZGxlcnMgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICB0aGlzLl93cmVxckhhbmRsZXJzID0ge307CiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5pbml0aWFsaXplKSkgewogICAgICAgIHRoaXMuaW5pdGlhbGl6ZShvcHRpb25zKTsKICAgICAgfQogICAgfTsKICAgIEhhbmRsZXJzLmV4dGVuZCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZDsKICAgIC8vIEluc3RhbmNlIE1lbWJlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0KICAgIF8uZXh0ZW5kKEhhbmRsZXJzLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzLCB7CiAgICAgIC8vIEFkZCBtdWx0aXBsZSBoYW5kbGVycyB1c2luZyBhbiBvYmplY3QgbGl0ZXJhbCBjb25maWd1cmF0aW9uCiAgICAgIHNldEhhbmRsZXJzOiBmdW5jdGlvbiAoaGFuZGxlcnMpIHsKICAgICAgICBfLmVhY2goaGFuZGxlcnMsIGZ1bmN0aW9uIChoYW5kbGVyLCBuYW1lKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IG51bGw7CiAgICAgICAgICBpZiAoXy5pc09iamVjdChoYW5kbGVyKSAmJiAhXy5pc0Z1bmN0aW9uKGhhbmRsZXIpKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSBoYW5kbGVyLmNvbnRleHQ7CiAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVyLmNhbGxiYWNrOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5zZXRIYW5kbGVyKG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9LAogICAgICAvLyBBZGQgYSBoYW5kbGVyIGZvciB0aGUgZ2l2ZW4gbmFtZSwgd2l0aCBhbgogICAgICAvLyBvcHRpb25hbCBjb250ZXh0IHRvIHJ1biB0aGUgaGFuZGxlciB3aXRoaW4KICAgICAgc2V0SGFuZGxlcjogZnVuY3Rpb24gKG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICB2YXIgY29uZmlnID0gewogICAgICAgICAgY2FsbGJhY2s6IGhhbmRsZXIsCiAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgfTsKICAgICAgICB0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdID0gY29uZmlnOwogICAgICAgIHRoaXMudHJpZ2dlcignaGFuZGxlcjphZGQnLCBuYW1lLCBoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgfSwKICAgICAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgb3Igbm90IGEgaGFuZGxlciBpcyByZWdpc3RlcmVkCiAgICAgIGhhc0hhbmRsZXI6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuICEhdGhpcy5fd3JlcXJIYW5kbGVyc1tuYW1lXTsKICAgICAgfSwKICAgICAgLy8gR2V0IHRoZSBjdXJyZW50bHkgcmVnaXN0ZXJlZCBoYW5kbGVyIGZvcgogICAgICAvLyB0aGUgc3BlY2lmaWVkIG5hbWUuIFRocm93cyBhbiBleGNlcHRpb24gaWYKICAgICAgLy8gbm8gaGFuZGxlciBpcyBmb3VuZC4KICAgICAgZ2V0SGFuZGxlcjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgY29uZmlnID0gdGhpcy5fd3JlcXJIYW5kbGVyc1tuYW1lXTsKICAgICAgICBpZiAoIWNvbmZpZykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzKTsKICAgICAgICAgIHJldHVybiBjb25maWcuY2FsbGJhY2suYXBwbHkoY29uZmlnLmNvbnRleHQsIGFyZ3MpOwogICAgICAgIH07CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgbmFtZQogICAgICByZW1vdmVIYW5kbGVyOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdOwogICAgICB9LAogICAgICAvLyBSZW1vdmUgYWxsIGhhbmRsZXJzIGZyb20gdGhpcyByZWdpc3RyeQogICAgICByZW1vdmVBbGxIYW5kbGVyczogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuX3dyZXFySGFuZGxlcnMgPSB7fTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gSGFuZGxlcnM7CiAgfShCYWNrYm9uZSwgXyk7CiAgLy8gV3JlcXIuQ29tbWFuZFN0b3JhZ2UKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gU3RvcmUgYW5kIHJldHJpZXZlIGNvbW1hbmRzIGZvciBleGVjdXRpb24uCiAgV3JlcXIuQ29tbWFuZFN0b3JhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAKICAgIC8vIENvbnN0cnVjdG9yIGZ1bmN0aW9uCiAgICB2YXIgQ29tbWFuZFN0b3JhZ2UgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICB0aGlzLl9jb21tYW5kcyA9IHt9OwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgICB0aGlzLmluaXRpYWxpemUob3B0aW9ucyk7CiAgICAgIH0KICAgIH07CiAgICAvLyBJbnN0YW5jZSBtZXRob2RzCiAgICBfLmV4dGVuZChDb21tYW5kU3RvcmFnZS5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgICAvLyBHZXQgYW4gb2JqZWN0IGxpdGVyYWwgYnkgY29tbWFuZCBuYW1lLCB0aGF0IGNvbnRhaW5zCiAgICAgIC8vIHRoZSBgY29tbWFuZE5hbWVgIGFuZCB0aGUgYGluc3RhbmNlc2Agb2YgYWxsIGNvbW1hbmRzCiAgICAgIC8vIHJlcHJlc2VudGVkIGFzIGFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byBwcm9jZXNzCiAgICAgIGdldENvbW1hbmRzOiBmdW5jdGlvbiAoY29tbWFuZE5hbWUpIHsKICAgICAgICB2YXIgY29tbWFuZHMgPSB0aGlzLl9jb21tYW5kc1tjb21tYW5kTmFtZV07CiAgICAgICAgLy8gd2UgZG9uJ3QgaGF2ZSBpdCwgc28gYWRkIGl0CiAgICAgICAgaWYgKCFjb21tYW5kcykgewogICAgICAgICAgLy8gYnVpbGQgdGhlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgIGNvbW1hbmRzID0gewogICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kTmFtZSwKICAgICAgICAgICAgaW5zdGFuY2VzOiBbXQogICAgICAgICAgfTsKICAgICAgICAgIC8vIHN0b3JlIGl0CiAgICAgICAgICB0aGlzLl9jb21tYW5kc1tjb21tYW5kTmFtZV0gPSBjb21tYW5kczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbW1hbmRzOwogICAgICB9LAogICAgICAvLyBBZGQgYSBjb21tYW5kIGJ5IG5hbWUsIHRvIHRoZSBzdG9yYWdlIGFuZCBzdG9yZSB0aGUKICAgICAgLy8gYXJncyBmb3IgdGhlIGNvbW1hbmQKICAgICAgYWRkQ29tbWFuZDogZnVuY3Rpb24gKGNvbW1hbmROYW1lLCBhcmdzKSB7CiAgICAgICAgdmFyIGNvbW1hbmQgPSB0aGlzLmdldENvbW1hbmRzKGNvbW1hbmROYW1lKTsKICAgICAgICBjb21tYW5kLmluc3RhbmNlcy5wdXNoKGFyZ3MpOwogICAgICB9LAogICAgICAvLyBDbGVhciBhbGwgY29tbWFuZHMgZm9yIHRoZSBnaXZlbiBgY29tbWFuZE5hbWVgCiAgICAgIGNsZWFyQ29tbWFuZHM6IGZ1bmN0aW9uIChjb21tYW5kTmFtZSkgewogICAgICAgIHZhciBjb21tYW5kID0gdGhpcy5nZXRDb21tYW5kcyhjb21tYW5kTmFtZSk7CiAgICAgICAgY29tbWFuZC5pbnN0YW5jZXMgPSBbXTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gQ29tbWFuZFN0b3JhZ2U7CiAgfSgpOwogIC8vIFdyZXFyLkNvbW1hbmRzCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLwogIC8vIEEgc2ltcGxlIGNvbW1hbmQgcGF0dGVybiBpbXBsZW1lbnRhdGlvbi4gUmVnaXN0ZXIgYSBjb21tYW5kCiAgLy8gaGFuZGxlciBhbmQgZXhlY3V0ZSBpdC4KICBXcmVxci5Db21tYW5kcyA9IGZ1bmN0aW9uIChXcmVxcikgewogICAgCiAgICByZXR1cm4gV3JlcXIuSGFuZGxlcnMuZXh0ZW5kKHsKICAgICAgLy8gZGVmYXVsdCBzdG9yYWdlIHR5cGUKICAgICAgc3RvcmFnZVR5cGU6IFdyZXFyLkNvbW1hbmRTdG9yYWdlLAogICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgIHRoaXMuX2luaXRpYWxpemVTdG9yYWdlKHRoaXMub3B0aW9ucyk7CiAgICAgICAgdGhpcy5vbignaGFuZGxlcjphZGQnLCB0aGlzLl9leGVjdXRlQ29tbWFuZHMsIHRoaXMpOwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICBXcmVxci5IYW5kbGVycy5wcm90b3R5cGUuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0sCiAgICAgIC8vIEV4ZWN1dGUgYSBuYW1lZCBjb21tYW5kIHdpdGggdGhlIHN1cHBsaWVkIGFyZ3MKICAgICAgZXhlY3V0ZTogZnVuY3Rpb24gKG5hbWUsIGFyZ3MpIHsKICAgICAgICBuYW1lID0gYXJndW1lbnRzWzBdOwogICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgIGlmICh0aGlzLmhhc0hhbmRsZXIobmFtZSkpIHsKICAgICAgICAgIHRoaXMuZ2V0SGFuZGxlcihuYW1lKS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5zdG9yYWdlLmFkZENvbW1hbmQobmFtZSwgYXJncyk7CiAgICAgICAgfQogICAgICB9LAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaGFuZGxlIGJ1bGsgZXhlY3V0aW9uIG9mIHN0b3JlZCBjb21tYW5kcwogICAgICBfZXhlY3V0ZUNvbW1hbmRzOiBmdW5jdGlvbiAobmFtZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgICAgIHZhciBjb21tYW5kID0gdGhpcy5zdG9yYWdlLmdldENvbW1hbmRzKG5hbWUpOwogICAgICAgIC8vIGxvb3AgdGhyb3VnaCBhbmQgZXhlY3V0ZSBhbGwgdGhlIHN0b3JlZCBjb21tYW5kIGluc3RhbmNlcwogICAgICAgIF8uZWFjaChjb21tYW5kLmluc3RhbmNlcywgZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICAgIGhhbmRsZXIuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5zdG9yYWdlLmNsZWFyQ29tbWFuZHMobmFtZSk7CiAgICAgIH0sCiAgICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBpbml0aWFsaXplIHN0b3JhZ2UgZWl0aGVyIGZyb20gdGhlIHR5cGUncwogICAgICAvLyBgc3RvcmFnZVR5cGVgIG9yIHRoZSBpbnN0YW5jZSBgb3B0aW9ucy5zdG9yYWdlVHlwZWAuCiAgICAgIF9pbml0aWFsaXplU3RvcmFnZTogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICB2YXIgc3RvcmFnZTsKICAgICAgICB2YXIgU3RvcmFnZVR5cGUgPSBvcHRpb25zLnN0b3JhZ2VUeXBlIHx8IHRoaXMuc3RvcmFnZVR5cGU7CiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihTdG9yYWdlVHlwZSkpIHsKICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgU3RvcmFnZVR5cGUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RvcmFnZSA9IFN0b3JhZ2VUeXBlOwogICAgICAgIH0KICAgICAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlOwogICAgICB9CiAgICB9KTsKICB9KFdyZXFyKTsKICAvLyBXcmVxci5SZXF1ZXN0UmVzcG9uc2UKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLwogIC8vIEEgc2ltcGxlIHJlcXVlc3QvcmVzcG9uc2UgaW1wbGVtZW50YXRpb24uIFJlZ2lzdGVyIGEKICAvLyByZXF1ZXN0IGhhbmRsZXIsIGFuZCByZXR1cm4gYSByZXNwb25zZSBmcm9tIGl0CiAgV3JlcXIuUmVxdWVzdFJlc3BvbnNlID0gZnVuY3Rpb24gKFdyZXFyKSB7CiAgICAKICAgIHJldHVybiBXcmVxci5IYW5kbGVycy5leHRlbmQoewogICAgICByZXF1ZXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG5hbWUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgIGlmICh0aGlzLmhhc0hhbmRsZXIobmFtZSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmdldEhhbmRsZXIobmFtZSkuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9KFdyZXFyKTsKICAvLyBFdmVudCBBZ2dyZWdhdG9yCiAgLy8gLS0tLS0tLS0tLS0tLS0tLQogIC8vIEEgcHViLXN1YiBvYmplY3QgdGhhdCBjYW4gYmUgdXNlZCB0byBkZWNvdXBsZSB2YXJpb3VzIHBhcnRzCiAgLy8gb2YgYW4gYXBwbGljYXRpb24gdGhyb3VnaCBldmVudC1kcml2ZW4gYXJjaGl0ZWN0dXJlLgogIFdyZXFyLkV2ZW50QWdncmVnYXRvciA9IGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogICAgCiAgICB2YXIgRUEgPSBmdW5jdGlvbiAoKSB7CiAgICB9OwogICAgLy8gQ29weSB0aGUgYGV4dGVuZGAgZnVuY3Rpb24gdXNlZCBieSBCYWNrYm9uZSdzIGNsYXNzZXMKICAgIEVBLmV4dGVuZCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZDsKICAgIC8vIENvcHkgdGhlIGJhc2ljIEJhY2tib25lLkV2ZW50cyBvbiB0byB0aGUgZXZlbnQgYWdncmVnYXRvcgogICAgXy5leHRlbmQoRUEucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMpOwogICAgcmV0dXJuIEVBOwogIH0oQmFja2JvbmUsIF8pOwogIC8vIFdyZXFyLkNoYW5uZWwKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gQW4gb2JqZWN0IHRoYXQgd3JhcHMgdGhlIHRocmVlIG1lc3NhZ2luZyBzeXN0ZW1zOgogIC8vIEV2ZW50QWdncmVnYXRvciwgUmVxdWVzdFJlc3BvbnNlLCBDb21tYW5kcwogIFdyZXFyLkNoYW5uZWwgPSBmdW5jdGlvbiAoV3JlcXIpIHsKICAgIAogICAgdmFyIENoYW5uZWwgPSBmdW5jdGlvbiAoY2hhbm5lbE5hbWUpIHsKICAgICAgdGhpcy52ZW50ID0gbmV3IEJhY2tib25lLldyZXFyLkV2ZW50QWdncmVnYXRvcigpOwogICAgICB0aGlzLnJlcXJlcyA9IG5ldyBCYWNrYm9uZS5XcmVxci5SZXF1ZXN0UmVzcG9uc2UoKTsKICAgICAgdGhpcy5jb21tYW5kcyA9IG5ldyBCYWNrYm9uZS5XcmVxci5Db21tYW5kcygpOwogICAgICB0aGlzLmNoYW5uZWxOYW1lID0gY2hhbm5lbE5hbWU7CiAgICB9OwogICAgXy5leHRlbmQoQ2hhbm5lbC5wcm90b3R5cGUsIHsKICAgICAgLy8gUmVtb3ZlIGFsbCBoYW5kbGVycyBmcm9tIHRoZSBtZXNzYWdpbmcgc3lzdGVtcyBvZiB0aGlzIGNoYW5uZWwKICAgICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLnZlbnQub2ZmKCk7CiAgICAgICAgdGhpcy52ZW50LnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICB0aGlzLnJlcXJlcy5yZW1vdmVBbGxIYW5kbGVycygpOwogICAgICAgIHRoaXMuY29tbWFuZHMucmVtb3ZlQWxsSGFuZGxlcnMoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gQ29ubmVjdCBhIGhhc2ggb2YgZXZlbnRzOyBvbmUgZm9yIGVhY2ggbWVzc2FnaW5nIHN5c3RlbQogICAgICBjb25uZWN0RXZlbnRzOiBmdW5jdGlvbiAoaGFzaCwgY29udGV4dCkgewogICAgICAgIHRoaXMuX2Nvbm5lY3QoJ3ZlbnQnLCBoYXNoLCBjb250ZXh0KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgY29ubmVjdENvbW1hbmRzOiBmdW5jdGlvbiAoaGFzaCwgY29udGV4dCkgewogICAgICAgIHRoaXMuX2Nvbm5lY3QoJ2NvbW1hbmRzJywgaGFzaCwgY29udGV4dCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0sCiAgICAgIGNvbm5lY3RSZXF1ZXN0czogZnVuY3Rpb24gKGhhc2gsIGNvbnRleHQpIHsKICAgICAgICB0aGlzLl9jb25uZWN0KCdyZXFyZXMnLCBoYXNoLCBjb250ZXh0KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gQXR0YWNoIHRoZSBoYW5kbGVycyB0byBhIGdpdmVuIG1lc3NhZ2Ugc3lzdGVtIGB0eXBlYAogICAgICBfY29ubmVjdDogZnVuY3Rpb24gKHR5cGUsIGhhc2gsIGNvbnRleHQpIHsKICAgICAgICBpZiAoIWhhc2gpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgdGhpczsKICAgICAgICB2YXIgbWV0aG9kID0gdHlwZSA9PT0gJ3ZlbnQnID8gJ29uJyA6ICdzZXRIYW5kbGVyJzsKICAgICAgICBfLmVhY2goaGFzaCwgZnVuY3Rpb24gKGZuLCBldmVudE5hbWUpIHsKICAgICAgICAgIHRoaXNbdHlwZV1bbWV0aG9kXShldmVudE5hbWUsIF8uYmluZChmbiwgY29udGV4dCkpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBDaGFubmVsOwogIH0oV3JlcXIpOwogIC8vIFdyZXFyLlJhZGlvCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLwogIC8vIEFuIG9iamVjdCB0aGF0IGxldHMgeW91IGNvbW11bmljYXRlIHdpdGggbWFueSBjaGFubmVscy4KICBXcmVxci5yYWRpbyA9IGZ1bmN0aW9uIChXcmVxcikgewogICAgCiAgICB2YXIgUmFkaW8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX2NoYW5uZWxzID0ge307CiAgICAgIHRoaXMudmVudCA9IHt9OwogICAgICB0aGlzLmNvbW1hbmRzID0ge307CiAgICAgIHRoaXMucmVxcmVzID0ge307CiAgICAgIHRoaXMuX3Byb3h5TWV0aG9kcygpOwogICAgfTsKICAgIF8uZXh0ZW5kKFJhZGlvLnByb3RvdHlwZSwgewogICAgICBjaGFubmVsOiBmdW5jdGlvbiAoY2hhbm5lbE5hbWUpIHsKICAgICAgICBpZiAoIWNoYW5uZWxOYW1lKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NoYW5uZWwgbXVzdCByZWNlaXZlIGEgbmFtZScpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q2hhbm5lbChjaGFubmVsTmFtZSk7CiAgICAgIH0sCiAgICAgIF9nZXRDaGFubmVsOiBmdW5jdGlvbiAoY2hhbm5lbE5hbWUpIHsKICAgICAgICB2YXIgY2hhbm5lbCA9IHRoaXMuX2NoYW5uZWxzW2NoYW5uZWxOYW1lXTsKICAgICAgICBpZiAoIWNoYW5uZWwpIHsKICAgICAgICAgIGNoYW5uZWwgPSBuZXcgV3JlcXIuQ2hhbm5lbChjaGFubmVsTmFtZSk7CiAgICAgICAgICB0aGlzLl9jaGFubmVsc1tjaGFubmVsTmFtZV0gPSBjaGFubmVsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2hhbm5lbDsKICAgICAgfSwKICAgICAgX3Byb3h5TWV0aG9kczogZnVuY3Rpb24gKCkgewogICAgICAgIF8uZWFjaChbCiAgICAgICAgICAndmVudCcsCiAgICAgICAgICAnY29tbWFuZHMnLAogICAgICAgICAgJ3JlcXJlcycKICAgICAgICBdLCBmdW5jdGlvbiAoc3lzdGVtKSB7CiAgICAgICAgICBfLmVhY2gobWVzc2FnZVN5c3RlbXNbc3lzdGVtXSwgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgICAgICB0aGlzW3N5c3RlbV1bbWV0aG9kXSA9IHByb3h5TWV0aG9kKHRoaXMsIHN5c3RlbSwgbWV0aG9kKTsKICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBtZXNzYWdlU3lzdGVtcyA9IHsKICAgICAgdmVudDogWwogICAgICAgICdvbicsCiAgICAgICAgJ29mZicsCiAgICAgICAgJ3RyaWdnZXInLAogICAgICAgICdvbmNlJywKICAgICAgICAnc3RvcExpc3RlbmluZycsCiAgICAgICAgJ2xpc3RlblRvJywKICAgICAgICAnbGlzdGVuVG9PbmNlJwogICAgICBdLAogICAgICBjb21tYW5kczogWwogICAgICAgICdleGVjdXRlJywKICAgICAgICAnc2V0SGFuZGxlcicsCiAgICAgICAgJ3NldEhhbmRsZXJzJywKICAgICAgICAncmVtb3ZlSGFuZGxlcicsCiAgICAgICAgJ3JlbW92ZUFsbEhhbmRsZXJzJwogICAgICBdLAogICAgICByZXFyZXM6IFsKICAgICAgICAncmVxdWVzdCcsCiAgICAgICAgJ3NldEhhbmRsZXInLAogICAgICAgICdzZXRIYW5kbGVycycsCiAgICAgICAgJ3JlbW92ZUhhbmRsZXInLAogICAgICAgICdyZW1vdmVBbGxIYW5kbGVycycKICAgICAgXQogICAgfTsKICAgIHZhciBwcm94eU1ldGhvZCA9IGZ1bmN0aW9uIChyYWRpbywgc3lzdGVtLCBtZXRob2QpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChjaGFubmVsTmFtZSkgewogICAgICAgIHZhciBtZXNzYWdlU3lzdGVtID0gcmFkaW8uX2dldENoYW5uZWwoY2hhbm5lbE5hbWUpW3N5c3RlbV07CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgIHJldHVybiBtZXNzYWdlU3lzdGVtW21ldGhvZF0uYXBwbHkobWVzc2FnZVN5c3RlbSwgYXJncyk7CiAgICAgIH07CiAgICB9OwogICAgcmV0dXJuIG5ldyBSYWRpbygpOwogIH0oV3JlcXIpOwogIHJldHVybiBCYWNrYm9uZS5XcmVxcjsKfSkpOwovKiEKICogY29tbWFuZGVyLmpzCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQKICovCmNvbW1hbmRlciA9IGZ1bmN0aW9uIChXcmVxcikgewogIC8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY29tbWFuZGVyCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICByZXR1cm4gbmV3IFdyZXFyLkNvbW1hbmRzKCk7Cn0oYmFja2JvbmV3cmVxcik7Ci8vIEJhY2tib25lLkJhYnlTaXR0ZXIKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQovLyB2MC4xLjQKLy8KLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCi8vIERpc3RyaWJ1dGVkIHVuZGVyIE1JVCBsaWNlbnNlCi8vCi8vIGh0dHA6Ly9naXRodWIuY29tL21hcmlvbmV0dGVqcy9iYWNrYm9uZS5iYWJ5c2l0dGVyCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZWJhYnlzaXR0ZXIgPSBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAgICAgcmV0dXJuIGZhY3RvcnkoQmFja2JvbmUsIF8pOwogICAgfShiYWNrYm9uZSwgdW5kZXJzY29yZSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBCYWNrYm9uZSA9IGJhY2tib25lOwogICAgdmFyIF8gPSB1bmRlcnNjb3JlOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KEJhY2tib25lLCBfKTsKICB9IGVsc2UgewogICAgZmFjdG9yeShyb290LkJhY2tib25lLCByb290Ll8pOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAKICB2YXIgcHJldmlvdXNDaGlsZFZpZXdDb250YWluZXIgPSBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXI7CiAgLy8gQmFieVNpdHRlci5DaGlsZFZpZXdDb250YWluZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gUHJvdmlkZSBhIGNvbnRhaW5lciB0byBzdG9yZSwgcmV0cmlldmUgYW5kCiAgLy8gc2h1dCBkb3duIGNoaWxkIHZpZXdzLgogIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lciA9IGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogICAgLy8gQ29udGFpbmVyIENvbnN0cnVjdG9yCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIHZhciBDb250YWluZXIgPSBmdW5jdGlvbiAodmlld3MpIHsKICAgICAgdGhpcy5fdmlld3MgPSB7fTsKICAgICAgdGhpcy5faW5kZXhCeU1vZGVsID0ge307CiAgICAgIHRoaXMuX2luZGV4QnlDdXN0b20gPSB7fTsKICAgICAgdGhpcy5fdXBkYXRlTGVuZ3RoKCk7CiAgICAgIF8uZWFjaCh2aWV3cywgdGhpcy5hZGQsIHRoaXMpOwogICAgfTsKICAgIC8vIENvbnRhaW5lciBNZXRob2RzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLQogICAgXy5leHRlbmQoQ29udGFpbmVyLnByb3RvdHlwZSwgewogICAgICAvLyBBZGQgYSB2aWV3IHRvIHRoaXMgY29udGFpbmVyLiBTdG9yZXMgdGhlIHZpZXcKICAgICAgLy8gYnkgYGNpZGAgYW5kIG1ha2VzIGl0IHNlYXJjaGFibGUgYnkgdGhlIG1vZGVsCiAgICAgIC8vIGNpZCAoYW5kIG1vZGVsIGl0c2VsZikuIE9wdGlvbmFsbHkgc3BlY2lmeQogICAgICAvLyBhIGN1c3RvbSBrZXkgdG8gc3RvcmUgYW4gcmV0cmlldmUgdGhlIHZpZXcuCiAgICAgIGFkZDogZnVuY3Rpb24gKHZpZXcsIGN1c3RvbUluZGV4KSB7CiAgICAgICAgdmFyIHZpZXdDaWQgPSB2aWV3LmNpZDsKICAgICAgICAvLyBzdG9yZSB0aGUgdmlldwogICAgICAgIHRoaXMuX3ZpZXdzW3ZpZXdDaWRdID0gdmlldzsKICAgICAgICAvLyBpbmRleCBpdCBieSBtb2RlbAogICAgICAgIGlmICh2aWV3Lm1vZGVsKSB7CiAgICAgICAgICB0aGlzLl9pbmRleEJ5TW9kZWxbdmlldy5tb2RlbC5jaWRdID0gdmlld0NpZDsKICAgICAgICB9CiAgICAgICAgLy8gaW5kZXggYnkgY3VzdG9tCiAgICAgICAgaWYgKGN1c3RvbUluZGV4KSB7CiAgICAgICAgICB0aGlzLl9pbmRleEJ5Q3VzdG9tW2N1c3RvbUluZGV4XSA9IHZpZXdDaWQ7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3VwZGF0ZUxlbmd0aCgpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBGaW5kIGEgdmlldyBieSB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgLy8gaXQuIFVzZXMgdGhlIG1vZGVsJ3MgYGNpZGAgdG8gZmluZCBpdC4KICAgICAgZmluZEJ5TW9kZWw6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgIHJldHVybiB0aGlzLmZpbmRCeU1vZGVsQ2lkKG1vZGVsLmNpZCk7CiAgICAgIH0sCiAgICAgIC8vIEZpbmQgYSB2aWV3IGJ5IHRoZSBgY2lkYCBvZiB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgLy8gaXQuIFVzZXMgdGhlIG1vZGVsJ3MgYGNpZGAgdG8gZmluZCB0aGUgdmlldyBgY2lkYCBhbmQKICAgICAgLy8gcmV0cmlldmUgdGhlIHZpZXcgdXNpbmcgaXQuCiAgICAgIGZpbmRCeU1vZGVsQ2lkOiBmdW5jdGlvbiAobW9kZWxDaWQpIHsKICAgICAgICB2YXIgdmlld0NpZCA9IHRoaXMuX2luZGV4QnlNb2RlbFttb2RlbENpZF07CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICB9LAogICAgICAvLyBGaW5kIGEgdmlldyBieSBhIGN1c3RvbSBpbmRleGVyLgogICAgICBmaW5kQnlDdXN0b206IGZ1bmN0aW9uIChpbmRleCkgewogICAgICAgIHZhciB2aWV3Q2lkID0gdGhpcy5faW5kZXhCeUN1c3RvbVtpbmRleF07CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICB9LAogICAgICAvLyBGaW5kIGJ5IGluZGV4LiBUaGlzIGlzIG5vdCBndWFyYW50ZWVkIHRvIGJlIGEKICAgICAgLy8gc3RhYmxlIGluZGV4LgogICAgICBmaW5kQnlJbmRleDogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgcmV0dXJuIF8udmFsdWVzKHRoaXMuX3ZpZXdzKVtpbmRleF07CiAgICAgIH0sCiAgICAgIC8vIHJldHJpZXZlIGEgdmlldyBieSBpdHMgYGNpZGAgZGlyZWN0bHkKICAgICAgZmluZEJ5Q2lkOiBmdW5jdGlvbiAoY2lkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3ZpZXdzW2NpZF07CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhIHZpZXcKICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAodmlldykgewogICAgICAgIHZhciB2aWV3Q2lkID0gdmlldy5jaWQ7CiAgICAgICAgLy8gZGVsZXRlIG1vZGVsIGluZGV4CiAgICAgICAgaWYgKHZpZXcubW9kZWwpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbmRleEJ5TW9kZWxbdmlldy5tb2RlbC5jaWRdOwogICAgICAgIH0KICAgICAgICAvLyBkZWxldGUgY3VzdG9tIGluZGV4CiAgICAgICAgXy5hbnkodGhpcy5faW5kZXhCeUN1c3RvbSwgZnVuY3Rpb24gKGNpZCwga2V5KSB7CiAgICAgICAgICBpZiAoY2lkID09PSB2aWV3Q2lkKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbmRleEJ5Q3VzdG9tW2tleV07CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0sIHRoaXMpOwogICAgICAgIC8vIHJlbW92ZSB0aGUgdmlldyBmcm9tIHRoZSBjb250YWluZXIKICAgICAgICBkZWxldGUgdGhpcy5fdmlld3Nbdmlld0NpZF07CiAgICAgICAgLy8gdXBkYXRlIHRoZSBsZW5ndGgKICAgICAgICB0aGlzLl91cGRhdGVMZW5ndGgoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gQ2FsbCBhIG1ldGhvZCBvbiBldmVyeSB2aWV3IGluIHRoZSBjb250YWluZXIsCiAgICAgIC8vIHBhc3NpbmcgcGFyYW1ldGVycyB0byB0aGUgY2FsbCBtZXRob2Qgb25lIGF0IGEKICAgICAgLy8gdGltZSwgbGlrZSBgZnVuY3Rpb24uY2FsbGAuCiAgICAgIGNhbGw6IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICB0aGlzLmFwcGx5KG1ldGhvZCwgXy50YWlsKGFyZ3VtZW50cykpOwogICAgICB9LAogICAgICAvLyBBcHBseSBhIG1ldGhvZCBvbiBldmVyeSB2aWV3IGluIHRoZSBjb250YWluZXIsCiAgICAgIC8vIHBhc3NpbmcgcGFyYW1ldGVycyB0byB0aGUgY2FsbCBtZXRob2Qgb25lIGF0IGEKICAgICAgLy8gdGltZSwgbGlrZSBgZnVuY3Rpb24uYXBwbHlgLgogICAgICBhcHBseTogZnVuY3Rpb24gKG1ldGhvZCwgYXJncykgewogICAgICAgIF8uZWFjaCh0aGlzLl92aWV3cywgZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24odmlld1ttZXRob2RdKSkgewogICAgICAgICAgICB2aWV3W21ldGhvZF0uYXBwbHkodmlldywgYXJncyB8fCBbXSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIC8vIFVwZGF0ZSB0aGUgYC5sZW5ndGhgIGF0dHJpYnV0ZSBvbiB0aGlzIGNvbnRhaW5lcgogICAgICBfdXBkYXRlTGVuZ3RoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5sZW5ndGggPSBfLnNpemUodGhpcy5fdmlld3MpOwogICAgICB9CiAgICB9KTsKICAgIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogICAgLy8gaHR0cDovL2JhY2tib25lanMub3JnL2RvY3MvYmFja2JvbmUuaHRtbCNzZWN0aW9uLTEwNgogICAgLy8KICAgIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgICAvLyBjb2xsZWN0aW9uIHJlbGF0ZWQgZmVhdHVyZXMuCiAgICB2YXIgbWV0aG9kcyA9IFsKICAgICAgJ2ZvckVhY2gnLAogICAgICAnZWFjaCcsCiAgICAgICdtYXAnLAogICAgICAnZmluZCcsCiAgICAgICdkZXRlY3QnLAogICAgICAnZmlsdGVyJywKICAgICAgJ3NlbGVjdCcsCiAgICAgICdyZWplY3QnLAogICAgICAnZXZlcnknLAogICAgICAnYWxsJywKICAgICAgJ3NvbWUnLAogICAgICAnYW55JywKICAgICAgJ2luY2x1ZGUnLAogICAgICAnY29udGFpbnMnLAogICAgICAnaW52b2tlJywKICAgICAgJ3RvQXJyYXknLAogICAgICAnZmlyc3QnLAogICAgICAnaW5pdGlhbCcsCiAgICAgICdyZXN0JywKICAgICAgJ2xhc3QnLAogICAgICAnd2l0aG91dCcsCiAgICAgICdpc0VtcHR5JywKICAgICAgJ3BsdWNrJwogICAgXTsKICAgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgIENvbnRhaW5lci5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdmlld3MgPSBfLnZhbHVlcyh0aGlzLl92aWV3cyk7CiAgICAgICAgdmFyIGFyZ3MgPSBbdmlld3NdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogICAgLy8gcmV0dXJuIHRoZSBwdWJsaWMgQVBJCiAgICByZXR1cm4gQ29udGFpbmVyOwogIH0oQmFja2JvbmUsIF8pOwogIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lci5WRVJTSU9OID0gJzAuMS40JzsKICBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXIubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lciA9IHByZXZpb3VzQ2hpbGRWaWV3Q29udGFpbmVyOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICByZXR1cm4gQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyOwp9KSk7Ci8vIE1hcmlvbmV0dGVKUyAoQmFja2JvbmUuTWFyaW9uZXR0ZSkKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyB2Mi4yLjAKLy8KLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCi8vIERpc3RyaWJ1dGVkIHVuZGVyIE1JVCBsaWNlbnNlCi8vCi8vIGh0dHA6Ly9tYXJpb25ldHRlanMuY29tCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZW1hcmlvbmV0dGUgPSBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAgICAgcmV0dXJuIHJvb3QuTWFyaW9uZXR0ZSA9IGZhY3Rvcnkocm9vdCwgQmFja2JvbmUsIF8pOwogICAgfShiYWNrYm9uZSwgdW5kZXJzY29yZSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBCYWNrYm9uZSA9IGJhY2tib25lOwogICAgdmFyIF8gPSB1bmRlcnNjb3JlOwogICAgdmFyIFdyZXFyID0gYmFja2JvbmV3cmVxcjsKICAgIHZhciBCYWJ5U2l0dGVyID0gYmFja2JvbmViYWJ5c2l0dGVyOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJvb3QsIEJhY2tib25lLCBfKTsKICB9IGVsc2UgewogICAgcm9vdC5NYXJpb25ldHRlID0gZmFjdG9yeShyb290LCByb290LkJhY2tib25lLCByb290Ll8pOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAocm9vdCwgQmFja2JvbmUsIF8pIHsKICAKICB2YXIgcHJldmlvdXNNYXJpb25ldHRlID0gcm9vdC5NYXJpb25ldHRlOwogIHZhciBNYXJpb25ldHRlID0gQmFja2JvbmUuTWFyaW9uZXR0ZSA9IHt9OwogIE1hcmlvbmV0dGUuVkVSU0lPTiA9ICcyLjIuMCc7CiAgTWFyaW9uZXR0ZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgcm9vdC5NYXJpb25ldHRlID0gcHJldmlvdXNNYXJpb25ldHRlOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvLyBHZXQgdGhlIERlZmVycmVkIGNyZWF0b3IgZm9yIGxhdGVyIHVzZQogIE1hcmlvbmV0dGUuRGVmZXJyZWQgPSBCYWNrYm9uZS4kLkRlZmVycmVkOwogIC8qIGpzaGludCB1bnVzZWQ6IGZhbHNlICovCiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KICAvLyBGb3Igc2xpY2luZyBgYXJndW1lbnRzYCBpbiBmdW5jdGlvbnMKICB2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgLy8gTWFyaW9uZXR0ZS5leHRlbmQKICAvLyAtLS0tLS0tLS0tLS0tLS0tLQogIC8vIEJvcnJvdyB0aGUgQmFja2JvbmUgYGV4dGVuZGAgbWV0aG9kIHNvIHdlIGNhbiB1c2UgaXQgYXMgbmVlZGVkCiAgTWFyaW9uZXR0ZS5leHRlbmQgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQ7CiAgLy8gTWFyaW9uZXR0ZS5nZXRPcHRpb24KICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIFJldHJpZXZlIGFuIG9iamVjdCwgZnVuY3Rpb24gb3Igb3RoZXIgdmFsdWUgZnJvbSBhIHRhcmdldAogIC8vIG9iamVjdCBvciBpdHMgYG9wdGlvbnNgLCB3aXRoIGBvcHRpb25zYCB0YWtpbmcgcHJlY2VkZW5jZS4KICBNYXJpb25ldHRlLmdldE9wdGlvbiA9IGZ1bmN0aW9uICh0YXJnZXQsIG9wdGlvbk5hbWUpIHsKICAgIGlmICghdGFyZ2V0IHx8ICFvcHRpb25OYW1lKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB2YWx1ZTsKICAgIGlmICh0YXJnZXQub3B0aW9ucyAmJiB0YXJnZXQub3B0aW9uc1tvcHRpb25OYW1lXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhbHVlID0gdGFyZ2V0Lm9wdGlvbnNbb3B0aW9uTmFtZV07CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IHRhcmdldFtvcHRpb25OYW1lXTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9OwogIC8vIFByb3h5IGBNYXJpb25ldHRlLmdldE9wdGlvbmAKICBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uID0gZnVuY3Rpb24gKG9wdGlvbk5hbWUpIHsKICAgIHJldHVybiBNYXJpb25ldHRlLmdldE9wdGlvbih0aGlzLCBvcHRpb25OYW1lKTsKICB9OwogIC8vIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLyBQYXNzIGluIGEgbWFwcGluZyBvZiBldmVudHMgPT4gZnVuY3Rpb25zIG9yIGZ1bmN0aW9uIG5hbWVzCiAgLy8gYW5kIHJldHVybiBhIG1hcHBpbmcgb2YgZXZlbnRzID0+IGZ1bmN0aW9ucwogIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcyA9IGZ1bmN0aW9uIChoYXNoKSB7CiAgICB2YXIgbm9ybWFsaXplZEhhc2ggPSB7fTsKICAgIF8uZWFjaChoYXNoLCBmdW5jdGlvbiAobWV0aG9kLCBuYW1lKSB7CiAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIHsKICAgICAgICBtZXRob2QgPSB0aGlzW21ldGhvZF07CiAgICAgIH0KICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbm9ybWFsaXplZEhhc2hbbmFtZV0gPSBtZXRob2Q7CiAgICB9LCB0aGlzKTsKICAgIHJldHVybiBub3JtYWxpemVkSGFzaDsKICB9OwogIC8vIHV0aWxpdHkgbWV0aG9kIGZvciBwYXJzaW5nIEB1aS4gc3ludGF4IHN0cmluZ3MKICAvLyBpbnRvIGFzc29jaWF0ZWQgc2VsZWN0b3IKICBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJU3RyaW5nID0gZnVuY3Rpb24gKHVpU3RyaW5nLCB1aSkgewogICAgcmV0dXJuIHVpU3RyaW5nLnJlcGxhY2UoL0B1aVwuW2EtekEtWl8kMC05XSovZywgZnVuY3Rpb24gKHIpIHsKICAgICAgcmV0dXJuIHVpW3Iuc2xpY2UoNCldOwogICAgfSk7CiAgfTsKICAvLyBhbGxvd3MgZm9yIHRoZSB1c2Ugb2YgdGhlIEB1aS4gc3ludGF4IHdpdGhpbgogIC8vIGEgZ2l2ZW4ga2V5IGZvciB0cmlnZ2VycyBhbmQgZXZlbnRzCiAgLy8gc3dhcHMgdGhlIEB1aSB3aXRoIHRoZSBhc3NvY2lhdGVkIHNlbGVjdG9yLgogIC8vIFJldHVybnMgYSBuZXcsIG5vbi1tdXRhdGVkLCBwYXJzZWQgZXZlbnRzIGhhc2guCiAgTWFyaW9uZXR0ZS5ub3JtYWxpemVVSUtleXMgPSBmdW5jdGlvbiAoaGFzaCwgdWkpIHsKICAgIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaGFzaCA9IF8uY2xvbmUoaGFzaCk7CiAgICBfLmVhY2goXy5rZXlzKGhhc2gpLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyhrZXksIHVpKTsKICAgICAgaWYgKG5vcm1hbGl6ZWRLZXkgIT09IGtleSkgewogICAgICAgIGhhc2hbbm9ybWFsaXplZEtleV0gPSBoYXNoW2tleV07CiAgICAgICAgZGVsZXRlIGhhc2hba2V5XTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaGFzaDsKICB9OwogIC8vIGFsbG93cyBmb3IgdGhlIHVzZSBvZiB0aGUgQHVpLiBzeW50YXggd2l0aGluCiAgLy8gYSBnaXZlbiB2YWx1ZSBmb3IgcmVnaW9ucwogIC8vIHN3YXBzIHRoZSBAdWkgd2l0aCB0aGUgYXNzb2NpYXRlZCBzZWxlY3RvcgogIE1hcmlvbmV0dGUubm9ybWFsaXplVUlWYWx1ZXMgPSBmdW5jdGlvbiAoaGFzaCwgdWkpIHsKICAgIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgXy5lYWNoKGhhc2gsIGZ1bmN0aW9uICh2YWwsIGtleSkgewogICAgICBpZiAoXy5pc1N0cmluZyh2YWwpKSB7CiAgICAgICAgaGFzaFtrZXldID0gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyh2YWwsIHVpKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaGFzaDsKICB9OwogIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgLy8gY29sbGVjdGlvbiByZWxhdGVkIGZlYXR1cmVzLgogIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogIC8vIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZy9kb2NzL2JhY2tib25lLmh0bWwjc2VjdGlvbi0xMjEKICBNYXJpb25ldHRlLmFjdEFzQ29sbGVjdGlvbiA9IGZ1bmN0aW9uIChvYmplY3QsIGxpc3RQcm9wZXJ0eSkgewogICAgdmFyIG1ldGhvZHMgPSBbCiAgICAgICdmb3JFYWNoJywKICAgICAgJ2VhY2gnLAogICAgICAnbWFwJywKICAgICAgJ2ZpbmQnLAogICAgICAnZGV0ZWN0JywKICAgICAgJ2ZpbHRlcicsCiAgICAgICdzZWxlY3QnLAogICAgICAncmVqZWN0JywKICAgICAgJ2V2ZXJ5JywKICAgICAgJ2FsbCcsCiAgICAgICdzb21lJywKICAgICAgJ2FueScsCiAgICAgICdpbmNsdWRlJywKICAgICAgJ2NvbnRhaW5zJywKICAgICAgJ2ludm9rZScsCiAgICAgICd0b0FycmF5JywKICAgICAgJ2ZpcnN0JywKICAgICAgJ2luaXRpYWwnLAogICAgICAncmVzdCcsCiAgICAgICdsYXN0JywKICAgICAgJ3dpdGhvdXQnLAogICAgICAnaXNFbXB0eScsCiAgICAgICdwbHVjaycKICAgIF07CiAgICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICBvYmplY3RbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbGlzdCA9IF8udmFsdWVzKF8ucmVzdWx0KHRoaXMsIGxpc3RQcm9wZXJ0eSkpOwogICAgICAgIHZhciBhcmdzID0gW2xpc3RdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgLy8gVHJpZ2dlciBhbiBldmVudCBhbmQvb3IgYSBjb3JyZXNwb25kaW5nIG1ldGhvZCBuYW1lLiBFeGFtcGxlczoKICAvLwogIC8vIGB0aGlzLnRyaWdnZXJNZXRob2QoImZvbyIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb28iIGV2ZW50IGFuZAogIC8vIGNhbGwgdGhlICJvbkZvbyIgbWV0aG9kLgogIC8vCiAgLy8gYHRoaXMudHJpZ2dlck1ldGhvZCgiZm9vOmJhciIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb286YmFyIiBldmVudCBhbmQKICAvLyBjYWxsIHRoZSAib25Gb29CYXIiIG1ldGhvZC4KICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIC8vIHNwbGl0IHRoZSBldmVudCBuYW1lIG9uIHRoZSAiOiIKICAgIHZhciBzcGxpdHRlciA9IC8oXnw6KShcdykvZ2k7CiAgICAvLyB0YWtlIHRoZSBldmVudCBzZWN0aW9uICgic2VjdGlvbjE6c2VjdGlvbjI6c2VjdGlvbjMiKQogICAgLy8gYW5kIHR1cm4gaXQgaW4gdG8gdXBwZXJjYXNlIG5hbWUKICAgIGZ1bmN0aW9uIGdldEV2ZW50TmFtZShtYXRjaCwgcHJlZml4LCBldmVudE5hbWUpIHsKICAgICAgcmV0dXJuIGV2ZW50TmFtZS50b1VwcGVyQ2FzZSgpOwogICAgfQogICAgLy8gZ2V0IHRoZSBtZXRob2QgbmFtZSBmcm9tIHRoZSBldmVudCBuYW1lCiAgICB2YXIgbWV0aG9kTmFtZSA9ICdvbicgKyBldmVudC5yZXBsYWNlKHNwbGl0dGVyLCBnZXRFdmVudE5hbWUpOwogICAgdmFyIG1ldGhvZCA9IHRoaXNbbWV0aG9kTmFtZV07CiAgICB2YXIgcmVzdWx0OwogICAgLy8gY2FsbCB0aGUgb25NZXRob2ROYW1lIGlmIGl0IGV4aXN0cwogICAgaWYgKF8uaXNGdW5jdGlvbihtZXRob2QpKSB7CiAgICAgIC8vIHBhc3MgYWxsIGFyZ3VtZW50cywgZXhjZXB0IHRoZSBldmVudCBuYW1lCiAgICAgIHJlc3VsdCA9IG1ldGhvZC5hcHBseSh0aGlzLCBfLnRhaWwoYXJndW1lbnRzKSk7CiAgICB9CiAgICAvLyB0cmlnZ2VyIHRoZSBldmVudCwgaWYgYSB0cmlnZ2VyIG1ldGhvZCBleGlzdHMKICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy50cmlnZ2VyKSkgewogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyB0cmlnZ2VyTWV0aG9kT24gaW52b2tlcyB0cmlnZ2VyTWV0aG9kIG9uIGEgc3BlY2lmaWMgY29udGV4dAogIC8vCiAgLy8gZS5nLiBgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ3Nob3cnKWAKICAvLyB3aWxsIHRyaWdnZXIgYSAic2hvdyIgZXZlbnQgb3IgaW52b2tlIG9uU2hvdyB0aGUgdmlldy4KICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbiA9IGZ1bmN0aW9uIChjb250ZXh0LCBldmVudCkgewogICAgdmFyIGFyZ3MgPSBfLnRhaWwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBmbmM7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGNvbnRleHQudHJpZ2dlck1ldGhvZCkpIHsKICAgICAgZm5jID0gY29udGV4dC50cmlnZ2VyTWV0aG9kOwogICAgfSBlbHNlIHsKICAgICAgZm5jID0gTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kOwogICAgfQogICAgcmV0dXJuIGZuYy5hcHBseShjb250ZXh0LCBbZXZlbnRdLmNvbmNhdChhcmdzKSk7CiAgfTsKICAvLyBET01SZWZyZXNoCiAgLy8gLS0tLS0tLS0tLQogIC8vCiAgLy8gTW9uaXRvciBhIHZpZXcncyBzdGF0ZSwgYW5kIGFmdGVyIGl0IGhhcyBiZWVuIHJlbmRlcmVkIGFuZCBzaG93bgogIC8vIGluIHRoZSBET00sIHRyaWdnZXIgYSAiZG9tOnJlZnJlc2giIGV2ZW50IGV2ZXJ5IHRpbWUgaXQgaXMKICAvLyByZS1yZW5kZXJlZC4KICBNYXJpb25ldHRlLk1vbml0b3JET01SZWZyZXNoID0gZnVuY3Rpb24gKGRvY3VtZW50RWxlbWVudCkgewogICAgLy8gdHJhY2sgd2hlbiB0aGUgdmlldyBoYXMgYmVlbiBzaG93biBpbiB0aGUgRE9NLAogICAgLy8gdXNpbmcgYSBNYXJpb25ldHRlLlJlZ2lvbiAob3IgYnkgb3RoZXIgbWVhbnMgb2YgdHJpZ2dlcmluZyAic2hvdyIpCiAgICBmdW5jdGlvbiBoYW5kbGVTaG93KHZpZXcpIHsKICAgICAgdmlldy5faXNTaG93biA9IHRydWU7CiAgICAgIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpOwogICAgfQogICAgLy8gdHJhY2sgd2hlbiB0aGUgdmlldyBoYXMgYmVlbiByZW5kZXJlZAogICAgZnVuY3Rpb24gaGFuZGxlUmVuZGVyKHZpZXcpIHsKICAgICAgdmlldy5faXNSZW5kZXJlZCA9IHRydWU7CiAgICAgIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpOwogICAgfQogICAgLy8gVHJpZ2dlciB0aGUgImRvbTpyZWZyZXNoIiBldmVudCBhbmQgY29ycmVzcG9uZGluZyAib25Eb21SZWZyZXNoIiBtZXRob2QKICAgIGZ1bmN0aW9uIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpIHsKICAgICAgaWYgKHZpZXcuX2lzU2hvd24gJiYgdmlldy5faXNSZW5kZXJlZCAmJiBpc0luRE9NKHZpZXcpKSB7CiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih2aWV3LnRyaWdnZXJNZXRob2QpKSB7CiAgICAgICAgICB2aWV3LnRyaWdnZXJNZXRob2QoJ2RvbTpyZWZyZXNoJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc0luRE9NKHZpZXcpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLiQuY29udGFpbnMoZG9jdW1lbnRFbGVtZW50LCB2aWV3LmVsKTsKICAgIH0KICAgIC8vIEV4cG9ydCBwdWJsaWMgQVBJCiAgICByZXR1cm4gZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgdmlldy5saXN0ZW5Ubyh2aWV3LCAnc2hvdycsIGZ1bmN0aW9uICgpIHsKICAgICAgICBoYW5kbGVTaG93KHZpZXcpOwogICAgICB9KTsKICAgICAgdmlldy5saXN0ZW5Ubyh2aWV3LCAncmVuZGVyJywgZnVuY3Rpb24gKCkgewogICAgICAgIGhhbmRsZVJlbmRlcih2aWV3KTsKICAgICAgfSk7CiAgICB9OwogIH0oZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTsKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA1ICovCiAgLy8gTWFyaW9uZXR0ZS5iaW5kRW50aXR5RXZlbnRzICYgdW5iaW5kRW50aXR5RXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBUaGVzZSBtZXRob2RzIGFyZSB1c2VkIHRvIGJpbmQvdW5iaW5kIGEgYmFja2JvbmUgImVudGl0eSIgKGNvbGxlY3Rpb24vbW9kZWwpCiAgLy8gdG8gbWV0aG9kcyBvbiBhIHRhcmdldCBvYmplY3QuCiAgLy8KICAvLyBUaGUgZmlyc3QgcGFyYW1ldGVyLCBgdGFyZ2V0YCwgbXVzdCBoYXZlIGEgYGxpc3RlblRvYCBtZXRob2QgZnJvbSB0aGUKICAvLyBFdmVudEJpbmRlciBvYmplY3QuCiAgLy8KICAvLyBUaGUgc2Vjb25kIHBhcmFtZXRlciBpcyB0aGUgZW50aXR5IChCYWNrYm9uZS5Nb2RlbCBvciBCYWNrYm9uZS5Db2xsZWN0aW9uKQogIC8vIHRvIGJpbmQgdGhlIGV2ZW50cyBmcm9tLgogIC8vCiAgLy8gVGhlIHRoaXJkIHBhcmFtZXRlciBpcyBhIGhhc2ggb2YgeyAiZXZlbnQ6bmFtZSI6ICJldmVudEhhbmRsZXIiIH0KICAvLyBjb25maWd1cmF0aW9uLiBNdWx0aXBsZSBoYW5kbGVycyBjYW4gYmUgc2VwYXJhdGVkIGJ5IGEgc3BhY2UuIEEKICAvLyBmdW5jdGlvbiBjYW4gYmUgc3VwcGxpZWQgaW5zdGVhZCBvZiBhIHN0cmluZyBoYW5kbGVyIG5hbWUuCiAgKGZ1bmN0aW9uIChNYXJpb25ldHRlKSB7CiAgICAKICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGhhbmRsZXJzIHNwZWNpZmllZCBhcyBhIHN0cmluZyBvZgogICAgLy8gaGFuZGxlciBuYW1lcyBvbiB0aGUgdGFyZ2V0IG9iamVjdAogICAgZnVuY3Rpb24gYmluZEZyb21TdHJpbmdzKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpIHsKICAgICAgdmFyIG1ldGhvZE5hbWVzID0gbWV0aG9kcy5zcGxpdCgvXHMrLyk7CiAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICB2YXIgbWV0aG9kID0gdGFyZ2V0W21ldGhvZE5hbWVdOwogICAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcignTWV0aG9kICInICsgbWV0aG9kTmFtZSArICciIHdhcyBjb25maWd1cmVkIGFzIGFuIGV2ZW50IGhhbmRsZXIsIGJ1dCBkb2VzIG5vdCBleGlzdC4nKTsKICAgICAgICB9CiAgICAgICAgdGFyZ2V0Lmxpc3RlblRvKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgICB9KTsKICAgIH0KICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGEgc3VwcGxpZWQgY2FsbGJhY2sgZnVuY3Rpb24KICAgIGZ1bmN0aW9uIGJpbmRUb0Z1bmN0aW9uKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZCkgewogICAgICB0YXJnZXQubGlzdGVuVG8oZW50aXR5LCBldnQsIG1ldGhvZCk7CiAgICB9CiAgICAvLyBCaW5kIHRoZSBldmVudCB0byBoYW5kbGVycyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgb2YKICAgIC8vIGhhbmRsZXIgbmFtZXMgb24gdGhlIHRhcmdldCBvYmplY3QKICAgIGZ1bmN0aW9uIHVuYmluZEZyb21TdHJpbmdzKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpIHsKICAgICAgdmFyIG1ldGhvZE5hbWVzID0gbWV0aG9kcy5zcGxpdCgvXHMrLyk7CiAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICB2YXIgbWV0aG9kID0gdGFyZ2V0W21ldGhvZE5hbWVdOwogICAgICAgIHRhcmdldC5zdG9wTGlzdGVuaW5nKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgICB9KTsKICAgIH0KICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGEgc3VwcGxpZWQgY2FsbGJhY2sgZnVuY3Rpb24KICAgIGZ1bmN0aW9uIHVuYmluZFRvRnVuY3Rpb24odGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kKSB7CiAgICAgIHRhcmdldC5zdG9wTGlzdGVuaW5nKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgfQogICAgLy8gZ2VuZXJpYyBsb29waW5nIGZ1bmN0aW9uCiAgICBmdW5jdGlvbiBpdGVyYXRlRXZlbnRzKHRhcmdldCwgZW50aXR5LCBiaW5kaW5ncywgZnVuY3Rpb25DYWxsYmFjaywgc3RyaW5nQ2FsbGJhY2spIHsKICAgICAgaWYgKCFlbnRpdHkgfHwgIWJpbmRpbmdzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIHR5cGUtY2hlY2sgYmluZGluZ3MKICAgICAgaWYgKCFfLmlzRnVuY3Rpb24oYmluZGluZ3MpICYmICFfLmlzT2JqZWN0KGJpbmRpbmdzKSkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG1lc3NhZ2U6ICdCaW5kaW5ncyBtdXN0IGJlIGFuIG9iamVjdCBvciBmdW5jdGlvbi4nLAogICAgICAgICAgdXJsOiAnbWFyaW9uZXR0ZS5mdW5jdGlvbnMuaHRtbCNtYXJpb25ldHRlYmluZGVudGl0eWV2ZW50cycKICAgICAgICB9KTsKICAgICAgfQogICAgICAvLyBhbGxvdyB0aGUgYmluZGluZ3MgdG8gYmUgYSBmdW5jdGlvbgogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGJpbmRpbmdzKSkgewogICAgICAgIGJpbmRpbmdzID0gYmluZGluZ3MuY2FsbCh0YXJnZXQpOwogICAgICB9CiAgICAgIC8vIGl0ZXJhdGUgdGhlIGJpbmRpbmdzIGFuZCBiaW5kIHRoZW0KICAgICAgXy5lYWNoKGJpbmRpbmdzLCBmdW5jdGlvbiAobWV0aG9kcywgZXZ0KSB7CiAgICAgICAgLy8gYWxsb3cgZm9yIGEgZnVuY3Rpb24gYXMgdGhlIGhhbmRsZXIsCiAgICAgICAgLy8gb3IgYSBsaXN0IG9mIGV2ZW50IG5hbWVzIGFzIGEgc3RyaW5nCiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihtZXRob2RzKSkgewogICAgICAgICAgZnVuY3Rpb25DYWxsYmFjayh0YXJnZXQsIGVudGl0eSwgZXZ0LCBtZXRob2RzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyaW5nQ2FsbGJhY2sodGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIC8vIEV4cG9ydCBQdWJsaWMgQVBJCiAgICBNYXJpb25ldHRlLmJpbmRFbnRpdHlFdmVudHMgPSBmdW5jdGlvbiAodGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIGl0ZXJhdGVFdmVudHModGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzLCBiaW5kVG9GdW5jdGlvbiwgYmluZEZyb21TdHJpbmdzKTsKICAgIH07CiAgICBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyA9IGZ1bmN0aW9uICh0YXJnZXQsIGVudGl0eSwgYmluZGluZ3MpIHsKICAgICAgaXRlcmF0ZUV2ZW50cyh0YXJnZXQsIGVudGl0eSwgYmluZGluZ3MsIHVuYmluZFRvRnVuY3Rpb24sIHVuYmluZEZyb21TdHJpbmdzKTsKICAgIH07CiAgICAvLyBQcm94eSBgYmluZEVudGl0eUV2ZW50c2AKICAgIE1hcmlvbmV0dGUucHJveHlCaW5kRW50aXR5RXZlbnRzID0gZnVuY3Rpb24gKGVudGl0eSwgYmluZGluZ3MpIHsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuYmluZEVudGl0eUV2ZW50cyh0aGlzLCBlbnRpdHksIGJpbmRpbmdzKTsKICAgIH07CiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYAogICAgTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cyA9IGZ1bmN0aW9uIChlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIHJldHVybiBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLCBlbnRpdHksIGJpbmRpbmdzKTsKICAgIH07CiAgfShNYXJpb25ldHRlKSk7CiAgdmFyIGVycm9yUHJvcHMgPSBbCiAgICAnZGVzY3JpcHRpb24nLAogICAgJ2ZpbGVOYW1lJywKICAgICdsaW5lTnVtYmVyJywKICAgICduYW1lJywKICAgICdtZXNzYWdlJywKICAgICdudW1iZXInCiAgXTsKICBNYXJpb25ldHRlLkVycm9yID0gTWFyaW9uZXR0ZS5leHRlbmQuY2FsbChFcnJvciwgewogICAgdXJsUm9vdDogJ2h0dHA6Ly9tYXJpb25ldHRlanMuY29tL2RvY3MvJyArIE1hcmlvbmV0dGUuVkVSU0lPTiArICcvJywKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAobWVzc2FnZSwgb3B0aW9ucykgewogICAgICBpZiAoXy5pc09iamVjdChtZXNzYWdlKSkgewogICAgICAgIG9wdGlvbnMgPSBtZXNzYWdlOwogICAgICAgIG1lc3NhZ2UgPSBvcHRpb25zLm1lc3NhZ2U7CiAgICAgIH0gZWxzZSBpZiAoIW9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgdmFyIGVycm9yID0gRXJyb3IuY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgICAgXy5leHRlbmQodGhpcywgXy5waWNrKGVycm9yLCBlcnJvclByb3BzKSwgXy5waWNrKG9wdGlvbnMsIGVycm9yUHJvcHMpKTsKICAgICAgdGhpcy5jYXB0dXJlU3RhY2tUcmFjZSgpOwogICAgICBpZiAob3B0aW9ucy51cmwpIHsKICAgICAgICB0aGlzLnVybCA9IHRoaXMudXJsUm9vdCArIG9wdGlvbnMudXJsOwogICAgICB9CiAgICB9LAogICAgY2FwdHVyZVN0YWNrVHJhY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgTWFyaW9uZXR0ZS5FcnJvcik7CiAgICAgIH0KICAgIH0sCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5uYW1lICsgJzogJyArIHRoaXMubWVzc2FnZSArICh0aGlzLnVybCA/ICcgU2VlOiAnICsgdGhpcy51cmwgOiAnJyk7CiAgICB9CiAgfSk7CiAgTWFyaW9uZXR0ZS5FcnJvci5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvLyBDYWxsYmFja3MKICAvLyAtLS0tLS0tLS0KICAvLyBBIHNpbXBsZSB3YXkgb2YgbWFuYWdpbmcgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcwogIC8vIGFuZCBleGVjdXRpbmcgdGhlbSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUsIHVzaW5nIGpRdWVyeSdzCiAgLy8gYERlZmVycmVkYCBvYmplY3QuCiAgTWFyaW9uZXR0ZS5DYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9kZWZlcnJlZCA9IE1hcmlvbmV0dGUuRGVmZXJyZWQoKTsKICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogIH07CiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5DYWxsYmFja3MucHJvdG90eXBlLCB7CiAgICAvLyBBZGQgYSBjYWxsYmFjayB0byBiZSBleGVjdXRlZC4gQ2FsbGJhY2tzIGFkZGVkIGhlcmUgYXJlCiAgICAvLyBndWFyYW50ZWVkIHRvIGV4ZWN1dGUsIGV2ZW4gaWYgdGhleSBhcmUgYWRkZWQgYWZ0ZXIgdGhlCiAgICAvLyBgcnVuYCBtZXRob2QgaXMgY2FsbGVkLgogICAgYWRkOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNvbnRleHRPdmVycmlkZSkgewogICAgICB2YXIgcHJvbWlzZSA9IF8ucmVzdWx0KHRoaXMuX2RlZmVycmVkLCAncHJvbWlzZScpOwogICAgICB0aGlzLl9jYWxsYmFja3MucHVzaCh7CiAgICAgICAgY2I6IGNhbGxiYWNrLAogICAgICAgIGN0eDogY29udGV4dE92ZXJyaWRlCiAgICAgIH0pOwogICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICBpZiAoY29udGV4dE92ZXJyaWRlKSB7CiAgICAgICAgICBhcmdzLmNvbnRleHQgPSBjb250ZXh0T3ZlcnJpZGU7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrLmNhbGwoYXJncy5jb250ZXh0LCBhcmdzLm9wdGlvbnMpOwogICAgICB9KTsKICAgIH0sCiAgICAvLyBSdW4gYWxsIHJlZ2lzdGVyZWQgY2FsbGJhY2tzIHdpdGggdGhlIGNvbnRleHQgc3BlY2lmaWVkLgogICAgLy8gQWRkaXRpb25hbCBjYWxsYmFja3MgY2FuIGJlIGFkZGVkIGFmdGVyIHRoaXMgaGFzIGJlZW4gcnVuCiAgICAvLyBhbmQgdGhleSB3aWxsIHN0aWxsIGJlIGV4ZWN1dGVkLgogICAgcnVuOiBmdW5jdGlvbiAob3B0aW9ucywgY29udGV4dCkgewogICAgICB0aGlzLl9kZWZlcnJlZC5yZXNvbHZlKHsKICAgICAgICBvcHRpb25zOiBvcHRpb25zLAogICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgfSk7CiAgICB9LAogICAgLy8gUmVzZXRzIHRoZSBsaXN0IG9mIGNhbGxiYWNrcyB0byBiZSBydW4sIGFsbG93aW5nIHRoZSBzYW1lIGxpc3QKICAgIC8vIHRvIGJlIHJ1biBtdWx0aXBsZSB0aW1lcyAtIHdoZW5ldmVyIHRoZSBgcnVuYCBtZXRob2QgaXMgY2FsbGVkLgogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrczsKICAgICAgdGhpcy5fZGVmZXJyZWQgPSBNYXJpb25ldHRlLkRlZmVycmVkKCk7CiAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogICAgICBfLmVhY2goY2FsbGJhY2tzLCBmdW5jdGlvbiAoY2IpIHsKICAgICAgICB0aGlzLmFkZChjYi5jYiwgY2IuY3R4KTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSk7CiAgLy8gTWFyaW9uZXR0ZSBDb250cm9sbGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBIG11bHRpLXB1cnBvc2Ugb2JqZWN0IHRvIHVzZSBhcyBhIGNvbnRyb2xsZXIgZm9yCiAgLy8gbW9kdWxlcyBhbmQgcm91dGVycywgYW5kIGFzIGEgbWVkaWF0b3IgZm9yIHdvcmtmbG93CiAgLy8gYW5kIGNvb3JkaW5hdGlvbiBvZiBvdGhlciBvYmplY3RzLCB2aWV3cywgYW5kIG1vcmUuCiAgTWFyaW9uZXR0ZS5Db250cm9sbGVyID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgdGhpcy5pbml0aWFsaXplKHRoaXMub3B0aW9ucyk7CiAgICB9CiAgfTsKICBNYXJpb25ldHRlLkNvbnRyb2xsZXIuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgLy8gQ29udHJvbGxlciBNZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLyBFbnN1cmUgaXQgY2FuIHRyaWdnZXIgZXZlbnRzIHdpdGggQmFja2JvbmUuRXZlbnRzCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5Db250cm9sbGVyLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzLCB7CiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QuYXBwbHkodGhpcywgWydiZWZvcmU6ZGVzdHJveSddLmNvbmNhdChhcmdzKSk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2Rlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgdGhpcy5vZmYoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIE1hcmlvbmV0dGUgT2JqZWN0CiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBIEJhc2UgQ2xhc3MgdGhhdCBvdGhlciBDbGFzc2VzIHNob3VsZCBkZXNjZW5kIGZyb20uCiAgLy8gT2JqZWN0IGJvcnJvd3MgbWFueSBjb252ZW50aW9ucyBhbmQgdXRpbGl0aWVzIGZyb20gQmFja2JvbmUuCiAgTWFyaW9uZXR0ZS5PYmplY3QgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICBNYXJpb25ldHRlLk9iamVjdC5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvLyBPYmplY3QgTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5PYmplY3QucHJvdG90eXBlLCB7CiAgICAvL3RoaXMgaXMgYSBub29wIG1ldGhvZCBpbnRlbmRlZCB0byBiZSBvdmVycmlkZGVuIGJ5IGNsYXNzZXMgdGhhdCBleHRlbmQgZnJvbSB0aGlzIGJhc2UKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmRlc3Ryb3knKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdkZXN0cm95Jyk7CiAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOwogICAgfSwKICAgIC8vIEltcG9ydCB0aGUgYHRyaWdnZXJNZXRob2RgIHRvIHRyaWdnZXIgZXZlbnRzIHdpdGggY29ycmVzcG9uZGluZwogICAgLy8gbWV0aG9kcyBpZiB0aGUgbWV0aG9kIGV4aXN0cwogICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kLAogICAgLy8gUHJveHkgYGdldE9wdGlvbmAgdG8gZW5hYmxlIGdldHRpbmcgb3B0aW9ucyBmcm9tIHRoaXMgb3IgdGhpcy5vcHRpb25zIGJ5IG5hbWUuCiAgICBnZXRPcHRpb246IE1hcmlvbmV0dGUucHJveHlHZXRPcHRpb24sCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgYmluZGluZyB2aWV3J3MgZXZlbnRzIGZyb20gYW5vdGhlciBlbnRpdHkuCiAgICBiaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5QmluZEVudGl0eUV2ZW50cywKICAgIC8vIFByb3h5IGB1bmJpbmRFbnRpdHlFdmVudHNgIHRvIGVuYWJsZSB1bmJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgdW5iaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5VW5iaW5kRW50aXR5RXZlbnRzCiAgfSk7CiAgLy8gRW5zdXJlIGl0IGNhbiB0cmlnZ2VyIGV2ZW50cyB3aXRoIEJhY2tib25lLkV2ZW50cwogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuT2JqZWN0LnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzKTsKICAvKiBqc2hpbnQgbWF4Y29tcGxleGl0eTogMTAsIG1heHN0YXRlbWVudHM6IDI5ICovCiAgLy8gUmVnaW9uCiAgLy8gLS0tLS0tCiAgLy8KICAvLyBNYW5hZ2UgdGhlIHZpc3VhbCByZWdpb25zIG9mIHlvdXIgY29tcG9zaXRlIGFwcGxpY2F0aW9uLiBTZWUKICAvLyBodHRwOi8vbG9zdGVjaGllcy5jb20vZGVyaWNrYmFpbGV5LzIwMTEvMTIvMTIvY29tcG9zaXRlLWpzLWFwcHMtcmVnaW9ucy1hbmQtcmVnaW9uLW1hbmFnZXJzLwogIE1hcmlvbmV0dGUuUmVnaW9uID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLmVsID0gdGhpcy5nZXRPcHRpb24oJ2VsJyk7CiAgICAvLyBIYW5kbGUgd2hlbiB0aGlzLmVsIGlzIHBhc3NlZCBpbiBhcyBhICQgd3JhcHBlZCBlbGVtZW50LgogICAgdGhpcy5lbCA9IHRoaXMuZWwgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gdGhpcy5lbFswXSA6IHRoaXMuZWw7CiAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgIG5hbWU6ICdOb0VsRXJyb3InLAogICAgICAgIG1lc3NhZ2U6ICdBbiAiZWwiIG11c3QgYmUgc3BlY2lmaWVkIGZvciBhIHJlZ2lvbi4nCiAgICAgIH0pOwogICAgfQogICAgdGhpcy4kZWwgPSB0aGlzLmdldEVsKHRoaXMuZWwpOwogICAgaWYgKHRoaXMuaW5pdGlhbGl6ZSkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICB9OwogIC8vIFJlZ2lvbiBDbGFzcyBtZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuUmVnaW9uLCB7CiAgICAvLyBCdWlsZCBhbiBpbnN0YW5jZSBvZiBhIHJlZ2lvbiBieSBwYXNzaW5nIGluIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgIC8vIGFuZCBhIGRlZmF1bHQgcmVnaW9uIGNsYXNzIHRvIHVzZSBpZiBub25lIGlzIHNwZWNpZmllZCBpbiB0aGUgY29uZmlnLgogICAgLy8KICAgIC8vIFRoZSBjb25maWcgb2JqZWN0IHNob3VsZCBlaXRoZXIgYmUgYSBzdHJpbmcgYXMgYSBqUXVlcnkgRE9NIHNlbGVjdG9yLAogICAgLy8gYSBSZWdpb24gY2xhc3MgZGlyZWN0bHksIG9yIGFuIG9iamVjdCBsaXRlcmFsIHRoYXQgc3BlY2lmaWVzIGJvdGgKICAgIC8vIGEgc2VsZWN0b3IgYW5kIHJlZ2lvbkNsYXNzOgogICAgLy8KICAgIC8vIGBgYGpzCiAgICAvLyB7CiAgICAvLyAgIHNlbGVjdG9yOiAiI2ZvbyIsCiAgICAvLyAgIHJlZ2lvbkNsYXNzOiBNeUN1c3RvbVJlZ2lvbgogICAgLy8gfQogICAgLy8gYGBgCiAgICAvLwogICAgYnVpbGRSZWdpb246IGZ1bmN0aW9uIChyZWdpb25Db25maWcsIERlZmF1bHRSZWdpb25DbGFzcykgewogICAgICBpZiAoXy5pc1N0cmluZyhyZWdpb25Db25maWcpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkUmVnaW9uRnJvbVNlbGVjdG9yKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKTsKICAgICAgfQogICAgICBpZiAocmVnaW9uQ29uZmlnLnNlbGVjdG9yIHx8IHJlZ2lvbkNvbmZpZy5lbCB8fCByZWdpb25Db25maWcucmVnaW9uQ2xhc3MpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25Gcm9tT2JqZWN0KHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKTsKICAgICAgfQogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbkNvbmZpZykpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25Gcm9tUmVnaW9uQ2xhc3MocmVnaW9uQ29uZmlnKTsKICAgICAgfQogICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogJ0ltcHJvcGVyIHJlZ2lvbiBjb25maWd1cmF0aW9uIHR5cGUuJywKICAgICAgICB1cmw6ICdtYXJpb25ldHRlLnJlZ2lvbi5odG1sI3JlZ2lvbi1jb25maWd1cmF0aW9uLXR5cGVzJwogICAgICB9KTsKICAgIH0sCiAgICAvLyBCdWlsZCB0aGUgcmVnaW9uIGZyb20gYSBzdHJpbmcgc2VsZWN0b3IgbGlrZSAnI2Zvby1yZWdpb24nCiAgICBfYnVpbGRSZWdpb25Gcm9tU2VsZWN0b3I6IGZ1bmN0aW9uIChzZWxlY3RvciwgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIHJldHVybiBuZXcgRGVmYXVsdFJlZ2lvbkNsYXNzKHsgZWw6IHNlbGVjdG9yIH0pOwogICAgfSwKICAgIC8vIEJ1aWxkIHRoZSByZWdpb24gZnJvbSBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAvLyBgYGBqcwogICAgLy8geyBzZWxlY3RvcjogJyNmb28nLCByZWdpb25DbGFzczogRm9vUmVnaW9uIH0KICAgIC8vIGBgYAogICAgX2J1aWxkUmVnaW9uRnJvbU9iamVjdDogZnVuY3Rpb24gKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIHZhciBSZWdpb25DbGFzcyA9IHJlZ2lvbkNvbmZpZy5yZWdpb25DbGFzcyB8fCBEZWZhdWx0UmVnaW9uQ2xhc3M7CiAgICAgIHZhciBvcHRpb25zID0gXy5vbWl0KHJlZ2lvbkNvbmZpZywgJ3NlbGVjdG9yJywgJ3JlZ2lvbkNsYXNzJyk7CiAgICAgIGlmIChyZWdpb25Db25maWcuc2VsZWN0b3IgJiYgIW9wdGlvbnMuZWwpIHsKICAgICAgICBvcHRpb25zLmVsID0gcmVnaW9uQ29uZmlnLnNlbGVjdG9yOwogICAgICB9CiAgICAgIHZhciByZWdpb24gPSBuZXcgUmVnaW9uQ2xhc3Mob3B0aW9ucyk7CiAgICAgIC8vIG92ZXJyaWRlIHRoZSBgZ2V0RWxgIGZ1bmN0aW9uIGlmIHdlIGhhdmUgYSBwYXJlbnRFbAogICAgICAvLyB0aGlzIG11c3QgYmUgb3ZlcnJpZGRlbiB0byBlbnN1cmUgdGhlIHNlbGVjdG9yIGlzIGZvdW5kCiAgICAgIC8vIG9uIHRoZSBmaXJzdCB1c2Ugb2YgdGhlIHJlZ2lvbi4gaWYgd2UgdHJ5IHRvIGFzc2lnbiB0aGUKICAgICAgLy8gcmVnaW9uJ3MgYGVsYCB0byBgcGFyZW50RWwuZmluZChzZWxlY3RvcilgIGluIHRoZSBvYmplY3QKICAgICAgLy8gbGl0ZXJhbCB0byBidWlsZCB0aGUgcmVnaW9uLCB0aGUgZWxlbWVudCB3aWxsIG5vdCBiZQogICAgICAvLyBndWFyYW50ZWVkIHRvIGJlIGluIHRoZSBET00gYWxyZWFkeSwgYW5kIHdpbGwgY2F1c2UgcHJvYmxlbXMKICAgICAgaWYgKHJlZ2lvbkNvbmZpZy5wYXJlbnRFbCkgewogICAgICAgIHJlZ2lvbi5nZXRFbCA9IGZ1bmN0aW9uIChlbCkgewogICAgICAgICAgaWYgKF8uaXNPYmplY3QoZWwpKSB7CiAgICAgICAgICAgIHJldHVybiBCYWNrYm9uZS4kKGVsKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJlbnRFbCA9IHJlZ2lvbkNvbmZpZy5wYXJlbnRFbDsKICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24ocGFyZW50RWwpKSB7CiAgICAgICAgICAgIHBhcmVudEVsID0gcGFyZW50RWwoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwYXJlbnRFbC5maW5kKGVsKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiByZWdpb247CiAgICB9LAogICAgLy8gQnVpbGQgdGhlIHJlZ2lvbiBkaXJlY3RseSBmcm9tIGEgZ2l2ZW4gYFJlZ2lvbkNsYXNzYAogICAgX2J1aWxkUmVnaW9uRnJvbVJlZ2lvbkNsYXNzOiBmdW5jdGlvbiAoUmVnaW9uQ2xhc3MpIHsKICAgICAgcmV0dXJuIG5ldyBSZWdpb25DbGFzcygpOwogICAgfQogIH0pOwogIC8vIFJlZ2lvbiBJbnN0YW5jZSBNZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICBfLmV4dGVuZChNYXJpb25ldHRlLlJlZ2lvbi5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgLy8gRGlzcGxheXMgYSBiYWNrYm9uZSB2aWV3IGluc3RhbmNlIGluc2lkZSBvZiB0aGUgcmVnaW9uLgogICAgLy8gSGFuZGxlcyBjYWxsaW5nIHRoZSBgcmVuZGVyYCBtZXRob2QgZm9yIHlvdS4gUmVhZHMgY29udGVudAogICAgLy8gZGlyZWN0bHkgZnJvbSB0aGUgYGVsYCBhdHRyaWJ1dGUuIEFsc28gY2FsbHMgYW4gb3B0aW9uYWwKICAgIC8vIGBvblNob3dgIGFuZCBgb25EZXN0cm95YCBtZXRob2Qgb24geW91ciB2aWV3LCBqdXN0IGFmdGVyIHNob3dpbmcKICAgIC8vIG9yIGp1c3QgYmVmb3JlIGRlc3Ryb3lpbmcgdGhlIHZpZXcsIHJlc3BlY3RpdmVseS4KICAgIC8vIFRoZSBgcHJldmVudERlc3Ryb3lgIG9wdGlvbiBjYW4gYmUgdXNlZCB0byBwcmV2ZW50IGEgdmlldyBmcm9tCiAgICAvLyB0aGUgb2xkIHZpZXcgYmVpbmcgZGVzdHJveWVkIG9uIHNob3cuCiAgICAvLyBUaGUgYGZvcmNlU2hvd2Agb3B0aW9uIGNhbiBiZSB1c2VkIHRvIGZvcmNlIGEgdmlldyB0byBiZQogICAgLy8gcmUtcmVuZGVyZWQgaWYgaXQncyBhbHJlYWR5IHNob3duIGluIHRoZSByZWdpb24uCiAgICBzaG93OiBmdW5jdGlvbiAodmlldywgb3B0aW9ucykgewogICAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICAgIHZhciBzaG93T3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciBpc0RpZmZlcmVudFZpZXcgPSB2aWV3ICE9PSB0aGlzLmN1cnJlbnRWaWV3OwogICAgICB2YXIgcHJldmVudERlc3Ryb3kgPSAhIXNob3dPcHRpb25zLnByZXZlbnREZXN0cm95OwogICAgICB2YXIgZm9yY2VTaG93ID0gISFzaG93T3B0aW9ucy5mb3JjZVNob3c7CiAgICAgIC8vIHdlIGFyZSBvbmx5IGNoYW5naW5nIHRoZSB2aWV3IGlmIHRoZXJlIGlzIGEgdmlldyB0byBjaGFuZ2UgdG8gYmVnaW4gd2l0aAogICAgICB2YXIgaXNDaGFuZ2luZ1ZpZXcgPSAhIXRoaXMuY3VycmVudFZpZXc7CiAgICAgIC8vIG9ubHkgZGVzdHJveSB0aGUgdmlldyBpZiB3ZSBkb24ndCB3YW50IHRvIHByZXZlbnREZXN0cm95IGFuZCB0aGUgdmlldyBpcyBkaWZmZXJlbnQKICAgICAgdmFyIF9zaG91bGREZXN0cm95VmlldyA9ICFwcmV2ZW50RGVzdHJveSAmJiBpc0RpZmZlcmVudFZpZXc7CiAgICAgIC8vIHNob3cgdGhlIHZpZXcgaWYgdGhlIHZpZXcgaXMgZGlmZmVyZW50IG9yIGlmIHlvdSB3YW50IHRvIHJlLXNob3cgdGhlIHZpZXcKICAgICAgdmFyIF9zaG91bGRTaG93VmlldyA9IGlzRGlmZmVyZW50VmlldyB8fCBmb3JjZVNob3c7CiAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgfQogICAgICBpZiAoX3Nob3VsZERlc3Ryb3lWaWV3KSB7CiAgICAgICAgdGhpcy5lbXB0eSgpOwogICAgICB9CiAgICAgIGlmIChfc2hvdWxkU2hvd1ZpZXcpIHsKICAgICAgICAvLyBXZSBuZWVkIHRvIGxpc3RlbiBmb3IgaWYgYSB2aWV3IGlzIGRlc3Ryb3llZAogICAgICAgIC8vIGluIGEgd2F5IG90aGVyIHRoYW4gdGhyb3VnaCB0aGUgcmVnaW9uLgogICAgICAgIC8vIElmIHRoaXMgaGFwcGVucyB3ZSBuZWVkIHRvIHJlbW92ZSB0aGUgcmVmZXJlbmNlCiAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnRWaWV3IHNpbmNlIG9uY2UgYSB2aWV3IGhhcyBiZWVuIGRlc3Ryb3llZAogICAgICAgIC8vIHdlIGNhbiBub3QgcmV1c2UgaXQuCiAgICAgICAgdmlldy5vbmNlKCdkZXN0cm95JywgXy5iaW5kKHRoaXMuZW1wdHksIHRoaXMpKTsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6c3dhcCcsIHZpZXcpOwogICAgICAgIH0KICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzaG93Jywgdmlldyk7CiAgICAgICAgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ2JlZm9yZTpzaG93Jyk7CiAgICAgICAgaWYgKGlzQ2hhbmdpbmdWaWV3KSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hdHRhY2hIdG1sKHZpZXcpOwogICAgICAgIHRoaXMuY3VycmVudFZpZXcgPSB2aWV3OwogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzd2FwJywgdmlldyk7CiAgICAgICAgfQogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnc2hvdycsIHZpZXcpOwogICAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKHZpZXcsICdzaG93Jyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCFfLmlzT2JqZWN0KHRoaXMuZWwpKSB7CiAgICAgICAgdGhpcy4kZWwgPSB0aGlzLmdldEVsKHRoaXMuZWwpOwogICAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuJGVsIHx8IHRoaXMuJGVsLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKCdBbiAiZWwiICcgKyB0aGlzLiRlbC5zZWxlY3RvciArICcgbXVzdCBleGlzdCBpbiBET00nKTsKICAgICAgfQogICAgfSwKICAgIC8vIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNoYW5nZSBob3cgdGhlIHJlZ2lvbiBmaW5kcyB0aGUKICAgIC8vIERPTSBlbGVtZW50IHRoYXQgaXQgbWFuYWdlcy4gUmV0dXJuIGEgalF1ZXJ5IHNlbGVjdG9yIG9iamVjdC4KICAgIGdldEVsOiBmdW5jdGlvbiAoZWwpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLiQoZWwpOwogICAgfSwKICAgIC8vIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNoYW5nZSBob3cgdGhlIG5ldyB2aWV3IGlzCiAgICAvLyBhcHBlbmRlZCB0byB0aGUgYCRlbGAgdGhhdCB0aGUgcmVnaW9uIGlzIG1hbmFnaW5nCiAgICBhdHRhY2hIdG1sOiBmdW5jdGlvbiAodmlldykgewogICAgICAvLyBlbXB0eSB0aGUgbm9kZSBhbmQgYXBwZW5kIG5ldyB2aWV3CiAgICAgIHRoaXMuZWwuaW5uZXJIVE1MID0gJyc7CiAgICAgIHRoaXMuZWwuYXBwZW5kQ2hpbGQodmlldy5lbCk7CiAgICB9LAogICAgLy8gRGVzdHJveSB0aGUgY3VycmVudCB2aWV3LCBpZiB0aGVyZSBpcyBvbmUuIElmIHRoZXJlIGlzIG5vCiAgICAvLyBjdXJyZW50IHZpZXcsIGl0IGRvZXMgbm90aGluZyBhbmQgcmV0dXJucyBpbW1lZGlhdGVseS4KICAgIGVtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB2aWV3ID0gdGhpcy5jdXJyZW50VmlldzsKICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gdmlldyBpbiB0aGUgcmVnaW9uCiAgICAgIC8vIHdlIHNob3VsZCBub3QgcmVtb3ZlIGFueXRoaW5nCiAgICAgIGlmICghdmlldykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTplbXB0eScsIHZpZXcpOwogICAgICB0aGlzLl9kZXN0cm95VmlldygpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2VtcHR5Jywgdmlldyk7CiAgICAgIC8vIFJlbW92ZSByZWdpb24gcG9pbnRlciB0byB0aGUgY3VycmVudFZpZXcKICAgICAgZGVsZXRlIHRoaXMuY3VycmVudFZpZXc7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIGNhbGwgJ2Rlc3Ryb3knIG9yICdyZW1vdmUnLCBkZXBlbmRpbmcgb24gd2hpY2ggaXMgZm91bmQKICAgIC8vIG9uIHRoZSB2aWV3IChpZiBzaG93aW5nIGEgcmF3IEJhY2tib25lIHZpZXcgb3IgYSBNYXJpb25ldHRlIFZpZXcpCiAgICBfZGVzdHJveVZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHZpZXcgPSB0aGlzLmN1cnJlbnRWaWV3OwogICAgICBpZiAodmlldy5kZXN0cm95ICYmICF2aWV3LmlzRGVzdHJveWVkKSB7CiAgICAgICAgdmlldy5kZXN0cm95KCk7CiAgICAgIH0gZWxzZSBpZiAodmlldy5yZW1vdmUpIHsKICAgICAgICB2aWV3LnJlbW92ZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gQXR0YWNoIGFuIGV4aXN0aW5nIHZpZXcgdG8gdGhlIHJlZ2lvbi4gVGhpcwogICAgLy8gd2lsbCBub3QgY2FsbCBgcmVuZGVyYCBvciBgb25TaG93YCBmb3IgdGhlIG5ldyB2aWV3LAogICAgLy8gYW5kIHdpbGwgbm90IHJlcGxhY2UgdGhlIGN1cnJlbnQgSFRNTCBmb3IgdGhlIGBlbGAKICAgIC8vIG9mIHRoZSByZWdpb24uCiAgICBhdHRhY2hWaWV3OiBmdW5jdGlvbiAodmlldykgewogICAgICB0aGlzLmN1cnJlbnRWaWV3ID0gdmlldzsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gQ2hlY2tzIHdoZXRoZXIgYSB2aWV3IGlzIGN1cnJlbnRseSBwcmVzZW50IHdpdGhpbgogICAgLy8gdGhlIHJlZ2lvbi4gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlcmUgaXMgYW5kIGBmYWxzZWAgaWYKICAgIC8vIG5vIHZpZXcgaXMgcHJlc2VudC4KICAgIGhhc1ZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICEhdGhpcy5jdXJyZW50VmlldzsKICAgIH0sCiAgICAvLyBSZXNldCB0aGUgcmVnaW9uIGJ5IGRlc3Ryb3lpbmcgYW55IGV4aXN0aW5nIHZpZXcgYW5kCiAgICAvLyBjbGVhcmluZyBvdXQgdGhlIGNhY2hlZCBgJGVsYC4gVGhlIG5leHQgdGltZSBhIHZpZXcKICAgIC8vIGlzIHNob3duIHZpYSB0aGlzIHJlZ2lvbiwgdGhlIHJlZ2lvbiB3aWxsIHJlLXF1ZXJ5IHRoZQogICAgLy8gRE9NIGZvciB0aGUgcmVnaW9uJ3MgYGVsYC4KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZW1wdHkoKTsKICAgICAgaWYgKHRoaXMuJGVsKSB7CiAgICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsLnNlbGVjdG9yOwogICAgICB9CiAgICAgIGRlbGV0ZSB0aGlzLiRlbDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gUHJveHkgYGdldE9wdGlvbmAgdG8gZW5hYmxlIGdldHRpbmcgb3B0aW9ucyBmcm9tIHRoaXMgb3IgdGhpcy5vcHRpb25zIGJ5IG5hbWUuCiAgICBnZXRPcHRpb246IE1hcmlvbmV0dGUucHJveHlHZXRPcHRpb24sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZAogIH0pOwogIC8vIENvcHkgdGhlIGBleHRlbmRgIGZ1bmN0aW9uIHVzZWQgYnkgQmFja2JvbmUncyBjbGFzc2VzCiAgTWFyaW9uZXR0ZS5SZWdpb24uZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgLy8gTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBNYW5hZ2Ugb25lIG9yIG1vcmUgcmVsYXRlZCBgTWFyaW9uZXR0ZS5SZWdpb25gIG9iamVjdHMuCiAgTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUpIHsKICAgIHZhciBSZWdpb25NYW5hZ2VyID0gTWFyaW9uZXR0ZS5Db250cm9sbGVyLmV4dGVuZCh7CiAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgIHRoaXMuX3JlZ2lvbnMgPSB7fTsKICAgICAgICBNYXJpb25ldHRlLkNvbnRyb2xsZXIuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgICAgfSwKICAgICAgLy8gQWRkIG11bHRpcGxlIHJlZ2lvbnMgdXNpbmcgYW4gb2JqZWN0IGxpdGVyYWwgb3IgYQogICAgICAvLyBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0IGxpdGVyYWwsIHdoZXJlCiAgICAgIC8vIGVhY2gga2V5IGJlY29tZXMgdGhlIHJlZ2lvbiBuYW1lLCBhbmQgZWFjaCB2YWx1ZSBpcwogICAgICAvLyB0aGUgcmVnaW9uIGRlZmluaXRpb24uCiAgICAgIGFkZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25EZWZpbml0aW9ucywgZGVmYXVsdHMpIHsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbkRlZmluaXRpb25zKSkgewogICAgICAgICAgcmVnaW9uRGVmaW5pdGlvbnMgPSByZWdpb25EZWZpbml0aW9ucy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICB2YXIgcmVnaW9ucyA9IHt9OwogICAgICAgIF8uZWFjaChyZWdpb25EZWZpbml0aW9ucywgZnVuY3Rpb24gKGRlZmluaXRpb24sIG5hbWUpIHsKICAgICAgICAgIGlmIChfLmlzU3RyaW5nKGRlZmluaXRpb24pKSB7CiAgICAgICAgICAgIGRlZmluaXRpb24gPSB7IHNlbGVjdG9yOiBkZWZpbml0aW9uIH07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5pdGlvbi5zZWxlY3RvcikgewogICAgICAgICAgICBkZWZpbml0aW9uID0gXy5kZWZhdWx0cyh7fSwgZGVmaW5pdGlvbiwgZGVmYXVsdHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuYWRkUmVnaW9uKG5hbWUsIGRlZmluaXRpb24pOwogICAgICAgICAgcmVnaW9uc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB9LCB0aGlzKTsKICAgICAgICByZXR1cm4gcmVnaW9uczsKICAgICAgfSwKICAgICAgLy8gQWRkIGFuIGluZGl2aWR1YWwgcmVnaW9uIHRvIHRoZSByZWdpb24gbWFuYWdlciwKICAgICAgLy8gYW5kIHJldHVybiB0aGUgcmVnaW9uIGluc3RhbmNlCiAgICAgIGFkZFJlZ2lvbjogZnVuY3Rpb24gKG5hbWUsIGRlZmluaXRpb24pIHsKICAgICAgICB2YXIgcmVnaW9uOwogICAgICAgIGlmIChkZWZpbml0aW9uIGluc3RhbmNlb2YgTWFyaW9uZXR0ZS5SZWdpb24pIHsKICAgICAgICAgIHJlZ2lvbiA9IGRlZmluaXRpb247CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlZ2lvbiA9IE1hcmlvbmV0dGUuUmVnaW9uLmJ1aWxkUmVnaW9uKGRlZmluaXRpb24sIE1hcmlvbmV0dGUuUmVnaW9uKTsKICAgICAgICB9CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6YWRkOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgdGhpcy5fc3RvcmUobmFtZSwgcmVnaW9uKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICAgIHJldHVybiByZWdpb247CiAgICAgIH0sCiAgICAgIC8vIEdldCBhIHJlZ2lvbiBieSBuYW1lCiAgICAgIGdldDogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgfSwKICAgICAgLy8gR2V0cyBhbGwgdGhlIHJlZ2lvbnMgY29udGFpbmVkIHdpdGhpbgogICAgICAvLyB0aGUgYHJlZ2lvbk1hbmFnZXJgIGluc3RhbmNlLgogICAgICBnZXRSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcmVnaW9ucyk7CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhIHJlZ2lvbiBieSBuYW1lCiAgICAgIHJlbW92ZVJlZ2lvbjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgcmVnaW9uID0gdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgICB0aGlzLl9yZW1vdmUobmFtZSwgcmVnaW9uKTsKICAgICAgICByZXR1cm4gcmVnaW9uOwogICAgICB9LAogICAgICAvLyBFbXB0eSBhbGwgcmVnaW9ucyBpbiB0aGUgcmVnaW9uIG1hbmFnZXIsIGFuZAogICAgICAvLyByZW1vdmUgdGhlbQogICAgICByZW1vdmVSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldFJlZ2lvbnMoKTsKICAgICAgICBfLmVhY2godGhpcy5fcmVnaW9ucywgZnVuY3Rpb24gKHJlZ2lvbiwgbmFtZSkgewogICAgICAgICAgdGhpcy5fcmVtb3ZlKG5hbWUsIHJlZ2lvbik7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHJlZ2lvbnM7CiAgICAgIH0sCiAgICAgIC8vIEVtcHR5IGFsbCByZWdpb25zIGluIHRoZSByZWdpb24gbWFuYWdlciwgYnV0CiAgICAgIC8vIGxlYXZlIHRoZW0gYXR0YWNoZWQKICAgICAgZW1wdHlSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldFJlZ2lvbnMoKTsKICAgICAgICBfLmVhY2gocmVnaW9ucywgZnVuY3Rpb24gKHJlZ2lvbikgewogICAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHJlZ2lvbnM7CiAgICAgIH0sCiAgICAgIC8vIERlc3Ryb3kgYWxsIHJlZ2lvbnMgYW5kIHNodXQgZG93biB0aGUgcmVnaW9uCiAgICAgIC8vIG1hbmFnZXIgZW50aXJlbHkKICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMucmVtb3ZlUmVnaW9ucygpOwogICAgICAgIHJldHVybiBNYXJpb25ldHRlLkNvbnRyb2xsZXIucHJvdG90eXBlLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSwKICAgICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIHN0b3JlIHJlZ2lvbnMKICAgICAgX3N0b3JlOiBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpcy5fcmVnaW9uc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoKTsKICAgICAgfSwKICAgICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIHJlbW92ZSBhIHJlZ2lvbgogICAgICBfcmVtb3ZlOiBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgcmVnaW9uLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICBkZWxldGUgdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbW92ZTpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9LAogICAgICAvLyBzZXQgdGhlIG51bWJlciBvZiByZWdpb25zIGN1cnJlbnQgaGVsZAogICAgICBfc2V0TGVuZ3RoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5sZW5ndGggPSBfLnNpemUodGhpcy5fcmVnaW9ucyk7CiAgICAgIH0KICAgIH0pOwogICAgTWFyaW9uZXR0ZS5hY3RBc0NvbGxlY3Rpb24oUmVnaW9uTWFuYWdlci5wcm90b3R5cGUsICdfcmVnaW9ucycpOwogICAgcmV0dXJuIFJlZ2lvbk1hbmFnZXI7CiAgfShNYXJpb25ldHRlKTsKICAvLyBUZW1wbGF0ZSBDYWNoZQogIC8vIC0tLS0tLS0tLS0tLS0tCiAgLy8gTWFuYWdlIHRlbXBsYXRlcyBzdG9yZWQgaW4gYDxzY3JpcHQ+YCBibG9ja3MsCiAgLy8gY2FjaGluZyB0aGVtIGZvciBmYXN0ZXIgYWNjZXNzLgogIE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZUlkKSB7CiAgICB0aGlzLnRlbXBsYXRlSWQgPSB0ZW1wbGF0ZUlkOwogIH07CiAgLy8gVGVtcGxhdGVDYWNoZSBvYmplY3QtbGV2ZWwgbWV0aG9kcy4gTWFuYWdlIHRoZSB0ZW1wbGF0ZQogIC8vIGNhY2hlcyBmcm9tIHRoZXNlIG1ldGhvZCBjYWxscyBpbnN0ZWFkIG9mIGNyZWF0aW5nCiAgLy8geW91ciBvd24gVGVtcGxhdGVDYWNoZSBpbnN0YW5jZXMKICBfLmV4dGVuZChNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUsIHsKICAgIHRlbXBsYXRlQ2FjaGVzOiB7fSwKICAgIC8vIEdldCB0aGUgc3BlY2lmaWVkIHRlbXBsYXRlIGJ5IGlkLiBFaXRoZXIKICAgIC8vIHJldHJpZXZlcyB0aGUgY2FjaGVkIHZlcnNpb24sIG9yIGxvYWRzIGl0CiAgICAvLyBmcm9tIHRoZSBET00uCiAgICBnZXQ6IGZ1bmN0aW9uICh0ZW1wbGF0ZUlkKSB7CiAgICAgIHZhciBjYWNoZWRUZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGVDYWNoZXNbdGVtcGxhdGVJZF07CiAgICAgIGlmICghY2FjaGVkVGVtcGxhdGUpIHsKICAgICAgICBjYWNoZWRUZW1wbGF0ZSA9IG5ldyBNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUodGVtcGxhdGVJZCk7CiAgICAgICAgdGhpcy50ZW1wbGF0ZUNhY2hlc1t0ZW1wbGF0ZUlkXSA9IGNhY2hlZFRlbXBsYXRlOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZWRUZW1wbGF0ZS5sb2FkKCk7CiAgICB9LAogICAgLy8gQ2xlYXIgdGVtcGxhdGVzIGZyb20gdGhlIGNhY2hlLiBJZiBubyBhcmd1bWVudHMKICAgIC8vIGFyZSBzcGVjaWZpZWQsIGNsZWFycyBhbGwgdGVtcGxhdGVzOgogICAgLy8gYGNsZWFyKClgCiAgICAvLwogICAgLy8gSWYgYXJndW1lbnRzIGFyZSBzcGVjaWZpZWQsIGNsZWFycyBlYWNoIG9mIHRoZQogICAgLy8gc3BlY2lmaWVkIHRlbXBsYXRlcyBmcm9tIHRoZSBjYWNoZToKICAgIC8vIGBjbGVhcigiI3QxIiwgIiN0MiIsICIuLi4iKWAKICAgIGNsZWFyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBpOwogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgdmFyIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgZGVsZXRlIHRoaXMudGVtcGxhdGVDYWNoZXNbYXJnc1tpXV07CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudGVtcGxhdGVDYWNoZXMgPSB7fTsKICAgICAgfQogICAgfQogIH0pOwogIC8vIFRlbXBsYXRlQ2FjaGUgaW5zdGFuY2UgbWV0aG9kcywgYWxsb3dpbmcgZWFjaAogIC8vIHRlbXBsYXRlIGNhY2hlIG9iamVjdCB0byBtYW5hZ2UgaXRzIG93biBzdGF0ZQogIC8vIGFuZCBrbm93IHdoZXRoZXIgb3Igbm90IGl0IGhhcyBiZWVuIGxvYWRlZAogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZS5wcm90b3R5cGUsIHsKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBsb2FkIHRoZSB0ZW1wbGF0ZQogICAgbG9hZDogZnVuY3Rpb24gKCkgewogICAgICAvLyBHdWFyZCBjbGF1c2UgdG8gcHJldmVudCBsb2FkaW5nIHRoaXMgdGVtcGxhdGUgbW9yZSB0aGFuIG9uY2UKICAgICAgaWYgKHRoaXMuY29tcGlsZWRUZW1wbGF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVkVGVtcGxhdGU7CiAgICAgIH0KICAgICAgLy8gTG9hZCB0aGUgdGVtcGxhdGUgYW5kIGNvbXBpbGUgaXQKICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy5sb2FkVGVtcGxhdGUodGhpcy50ZW1wbGF0ZUlkKTsKICAgICAgdGhpcy5jb21waWxlZFRlbXBsYXRlID0gdGhpcy5jb21waWxlVGVtcGxhdGUodGVtcGxhdGUpOwogICAgICByZXR1cm4gdGhpcy5jb21waWxlZFRlbXBsYXRlOwogICAgfSwKICAgIC8vIExvYWQgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBET00sIGJ5IGRlZmF1bHQuIE92ZXJyaWRlCiAgICAvLyB0aGlzIG1ldGhvZCB0byBwcm92aWRlIHlvdXIgb3duIHRlbXBsYXRlIHJldHJpZXZhbAogICAgLy8gRm9yIGFzeW5jaHJvbm91cyBsb2FkaW5nIHdpdGggQU1EL1JlcXVpcmVKUywgY29uc2lkZXIKICAgIC8vIHVzaW5nIGEgdGVtcGxhdGUtbG9hZGVyIHBsdWdpbiBhcyBkZXNjcmliZWQgaGVyZToKICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXJpb25ldHRlanMvYmFja2JvbmUubWFyaW9uZXR0ZS93aWtpL1VzaW5nLW1hcmlvbmV0dGUtd2l0aC1yZXF1aXJlanMKICAgIGxvYWRUZW1wbGF0ZTogZnVuY3Rpb24gKHRlbXBsYXRlSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlID0gQmFja2JvbmUuJCh0ZW1wbGF0ZUlkKS5odG1sKCk7CiAgICAgIGlmICghdGVtcGxhdGUgfHwgdGVtcGxhdGUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ05vVGVtcGxhdGVFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ291bGQgbm90IGZpbmQgdGVtcGxhdGU6ICInICsgdGVtcGxhdGVJZCArICciJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0sCiAgICAvLyBQcmUtY29tcGlsZSB0aGUgdGVtcGxhdGUgYmVmb3JlIGNhY2hpbmcgaXQuIE92ZXJyaWRlCiAgICAvLyB0aGlzIG1ldGhvZCBpZiB5b3UgZG8gbm90IG5lZWQgdG8gcHJlLWNvbXBpbGUgYSB0ZW1wbGF0ZQogICAgLy8gKEpTVCAvIFJlcXVpcmVKUyBmb3IgZXhhbXBsZSkgb3IgaWYgeW91IHdhbnQgdG8gY2hhbmdlCiAgICAvLyB0aGUgdGVtcGxhdGUgZW5naW5lIHVzZWQgKEhhbmRlYmFycywgZXRjKS4KICAgIGNvbXBpbGVUZW1wbGF0ZTogZnVuY3Rpb24gKHJhd1RlbXBsYXRlKSB7CiAgICAgIHJldHVybiBfLnRlbXBsYXRlKHJhd1RlbXBsYXRlKTsKICAgIH0KICB9KTsKICAvLyBSZW5kZXJlcgogIC8vIC0tLS0tLS0tCiAgLy8gUmVuZGVyIGEgdGVtcGxhdGUgd2l0aCBkYXRhIGJ5IHBhc3NpbmcgaW4gdGhlIHRlbXBsYXRlCiAgLy8gc2VsZWN0b3IgYW5kIHRoZSBkYXRhIHRvIHJlbmRlci4KICBNYXJpb25ldHRlLlJlbmRlcmVyID0gewogICAgLy8gUmVuZGVyIGEgdGVtcGxhdGUgd2l0aCBkYXRhLiBUaGUgYHRlbXBsYXRlYCBwYXJhbWV0ZXIgaXMKICAgIC8vIHBhc3NlZCB0byB0aGUgYFRlbXBsYXRlQ2FjaGVgIG9iamVjdCB0byByZXRyaWV2ZSB0aGUKICAgIC8vIHRlbXBsYXRlIGZ1bmN0aW9uLiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcm92aWRlIHlvdXIgb3duCiAgICAvLyBjdXN0b20gcmVuZGVyaW5nIGFuZCB0ZW1wbGF0ZSBoYW5kbGluZyBmb3IgYWxsIG9mIE1hcmlvbmV0dGUuCiAgICByZW5kZXI6IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgZGF0YSkgewogICAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ1RlbXBsYXRlTm90Rm91bmRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IHJlbmRlciB0aGUgdGVtcGxhdGUgc2luY2UgaXRzIGZhbHNlLCBudWxsIG9yIHVuZGVmaW5lZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdmFyIHRlbXBsYXRlRnVuYzsKICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IHRlbXBsYXRlOwogICAgICB9IGVsc2UgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZS5nZXQodGVtcGxhdGUpOwogICAgICB9CiAgICAgIHJldHVybiB0ZW1wbGF0ZUZ1bmMoZGF0YSk7CiAgICB9CiAgfTsKICAvKiBqc2hpbnQgbWF4bGVuOiAxMTQsIG5vbmV3OiBmYWxzZSAqLwogIC8vIE1hcmlvbmV0dGUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0tLQogIC8vIFRoZSBjb3JlIHZpZXcgY2xhc3MgdGhhdCBvdGhlciBNYXJpb25ldHRlIHZpZXdzIGV4dGVuZCBmcm9tLgogIE1hcmlvbmV0dGUuVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBfLmJpbmRBbGwodGhpcywgJ3JlbmRlcicpOwogICAgICAvLyB0aGlzIGV4cG9zZXMgdmlldyBvcHRpb25zIHRvIHRoZSB2aWV3IGluaXRpYWxpemVyCiAgICAgIC8vIHRoaXMgaXMgYSBiYWNrZmlsbCBzaW5jZSBiYWNrYm9uZSByZW1vdmVkIHRoZSBhc3NpZ25tZW50CiAgICAgIC8vIG9mIHRoaXMub3B0aW9ucwogICAgICAvLyBhdCBzb21lIHBvaW50IGhvd2V2ZXIgdGhpcyBtYXkgYmUgcmVtb3ZlZAogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgXy5pc0Z1bmN0aW9uKG9wdGlvbnMpID8gb3B0aW9ucy5jYWxsKHRoaXMpIDogb3B0aW9ucyk7CiAgICAgIHRoaXMuX2JlaGF2aW9ycyA9IE1hcmlvbmV0dGUuQmVoYXZpb3JzKHRoaXMpOwogICAgICBCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIE1hcmlvbmV0dGUuTW9uaXRvckRPTVJlZnJlc2godGhpcyk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcywgJ3Nob3cnLCB0aGlzLm9uU2hvd0NhbGxlZCk7CiAgICB9LAogICAgLy8gR2V0IHRoZSB0ZW1wbGF0ZSBmb3IgdGhpcyB2aWV3CiAgICAvLyBpbnN0YW5jZS4gWW91IGNhbiBzZXQgYSBgdGVtcGxhdGVgIGF0dHJpYnV0ZSBpbiB0aGUgdmlldwogICAgLy8gZGVmaW5pdGlvbiBvciBwYXNzIGEgYHRlbXBsYXRlOiAid2hhdGV2ZXIiYCBwYXJhbWV0ZXIgaW4KICAgIC8vIHRvIHRoZSBjb25zdHJ1Y3RvciBvcHRpb25zLgogICAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uKCd0ZW1wbGF0ZScpOwogICAgfSwKICAgIC8vIFNlcmlhbGl6ZSBhIG1vZGVsIGJ5IHJldHVybmluZyBpdHMgYXR0cmlidXRlcy4gQ2xvbmVzCiAgICAvLyB0aGUgYXR0cmlidXRlcyB0byBhbGxvdyBtb2RpZmljYXRpb24uCiAgICBzZXJpYWxpemVNb2RlbDogZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgIHJldHVybiBtb2RlbC50b0pTT04uYXBwbHkobW9kZWwsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB9LAogICAgLy8gTWl4IGluIHRlbXBsYXRlIGhlbHBlciBtZXRob2RzLiBMb29rcyBmb3IgYQogICAgLy8gYHRlbXBsYXRlSGVscGVyc2AgYXR0cmlidXRlLCB3aGljaCBjYW4gZWl0aGVyIGJlIGFuCiAgICAvLyBvYmplY3QgbGl0ZXJhbCwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0CiAgICAvLyBsaXRlcmFsLiBBbGwgbWV0aG9kcyBhbmQgYXR0cmlidXRlcyBmcm9tIHRoaXMgb2JqZWN0CiAgICAvLyBhcmUgY29waWVzIHRvIHRoZSBvYmplY3QgcGFzc2VkIGluLgogICAgbWl4aW5UZW1wbGF0ZUhlbHBlcnM6IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgICAgdGFyZ2V0ID0gdGFyZ2V0IHx8IHt9OwogICAgICB2YXIgdGVtcGxhdGVIZWxwZXJzID0gdGhpcy5nZXRPcHRpb24oJ3RlbXBsYXRlSGVscGVycycpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRlbXBsYXRlSGVscGVycykpIHsKICAgICAgICB0ZW1wbGF0ZUhlbHBlcnMgPSB0ZW1wbGF0ZUhlbHBlcnMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gXy5leHRlbmQodGFyZ2V0LCB0ZW1wbGF0ZUhlbHBlcnMpOwogICAgfSwKICAgIC8vIG5vcm1hbGl6ZSB0aGUga2V5cyBvZiBwYXNzZWQgaGFzaCB3aXRoIHRoZSB2aWV3cyBgdWlgIHNlbGVjdG9ycy4KICAgIC8vIGB7IkB1aS5mb28iOiAiYmFyIn1gCiAgICBub3JtYWxpemVVSUtleXM6IGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgIHZhciB1aSA9IF8ucmVzdWx0KHRoaXMsICd1aScpOwogICAgICB2YXIgdWlCaW5kaW5ncyA9IF8ucmVzdWx0KHRoaXMsICdfdWlCaW5kaW5ncycpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSUtleXMoaGFzaCwgdWlCaW5kaW5ncyB8fCB1aSk7CiAgICB9LAogICAgLy8gbm9ybWFsaXplIHRoZSB2YWx1ZXMgb2YgcGFzc2VkIGhhc2ggd2l0aCB0aGUgdmlld3MgYHVpYCBzZWxlY3RvcnMuCiAgICAvLyBge2ZvbzogIkB1aS5iYXIifWAKICAgIG5vcm1hbGl6ZVVJVmFsdWVzOiBmdW5jdGlvbiAoaGFzaCkgewogICAgICB2YXIgdWkgPSBfLnJlc3VsdCh0aGlzLCAndWknKTsKICAgICAgdmFyIHVpQmluZGluZ3MgPSBfLnJlc3VsdCh0aGlzLCAnX3VpQmluZGluZ3MnKTsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUubm9ybWFsaXplVUlWYWx1ZXMoaGFzaCwgdWlCaW5kaW5ncyB8fCB1aSk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlIGB0cmlnZ2Vyc2AgdG8gZm9yd2FyZCBET00gZXZlbnRzIHRvIHZpZXcKICAgIC8vIGV2ZW50cy4gYHRyaWdnZXJzOiB7ImNsaWNrIC5mb28iOiAiZG86Zm9vIn1gCiAgICBjb25maWd1cmVUcmlnZ2VyczogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudHJpZ2dlcnMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHRyaWdnZXJFdmVudHMgPSB7fTsKICAgICAgLy8gQWxsb3cgYHRyaWdnZXJzYCB0byBiZSBjb25maWd1cmVkIGFzIGEgZnVuY3Rpb24KICAgICAgdmFyIHRyaWdnZXJzID0gdGhpcy5ub3JtYWxpemVVSUtleXMoXy5yZXN1bHQodGhpcywgJ3RyaWdnZXJzJykpOwogICAgICAvLyBDb25maWd1cmUgdGhlIHRyaWdnZXJzLCBwcmV2ZW50IGRlZmF1bHQKICAgICAgLy8gYWN0aW9uIGFuZCBzdG9wIHByb3BhZ2F0aW9uIG9mIERPTSBldmVudHMKICAgICAgXy5lYWNoKHRyaWdnZXJzLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHRyaWdnZXJFdmVudHNba2V5XSA9IHRoaXMuX2J1aWxkVmlld1RyaWdnZXIodmFsdWUpOwogICAgICB9LCB0aGlzKTsKICAgICAgcmV0dXJuIHRyaWdnZXJFdmVudHM7CiAgICB9LAogICAgLy8gT3ZlcnJpZGluZyBCYWNrYm9uZS5WaWV3J3MgZGVsZWdhdGVFdmVudHMgdG8gaGFuZGxlCiAgICAvLyB0aGUgYHRyaWdnZXJzYCwgYG1vZGVsRXZlbnRzYCwgYW5kIGBjb2xsZWN0aW9uRXZlbnRzYCBjb25maWd1cmF0aW9uCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24gKGV2ZW50cykgewogICAgICB0aGlzLl9kZWxlZ2F0ZURPTUV2ZW50cyhldmVudHMpOwogICAgICB0aGlzLmJpbmRFbnRpdHlFdmVudHModGhpcy5tb2RlbCwgdGhpcy5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICB0aGlzLmJpbmRFbnRpdHlFdmVudHModGhpcy5jb2xsZWN0aW9uLCB0aGlzLmdldE9wdGlvbignY29sbGVjdGlvbkV2ZW50cycpKTsKICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgZnVuY3Rpb24gKGJlaGF2aW9yKSB7CiAgICAgICAgYmVoYXZpb3IuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCBiZWhhdmlvci5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICAgIGJlaGF2aW9yLmJpbmRFbnRpdHlFdmVudHModGhpcy5jb2xsZWN0aW9uLCBiZWhhdmlvci5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgICAgIH0sIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBpbnRlcm5hbCBtZXRob2QgdG8gZGVsZWdhdGUgRE9NIGV2ZW50cyBhbmQgdHJpZ2dlcnMKICAgIF9kZWxlZ2F0ZURPTUV2ZW50czogZnVuY3Rpb24gKGV2ZW50c0FyZykgewogICAgICB2YXIgZXZlbnRzID0gZXZlbnRzQXJnIHx8IHRoaXMuZXZlbnRzOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGV2ZW50cykpIHsKICAgICAgICBldmVudHMgPSBldmVudHMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICAvLyBub3JtYWxpemUgdWkga2V5cwogICAgICBldmVudHMgPSB0aGlzLm5vcm1hbGl6ZVVJS2V5cyhldmVudHMpOwogICAgICBpZiAoXy5pc1VuZGVmaW5lZChldmVudHNBcmcpKSB7CiAgICAgICAgdGhpcy5ldmVudHMgPSBldmVudHM7CiAgICAgIH0KICAgICAgdmFyIGNvbWJpbmVkRXZlbnRzID0ge307CiAgICAgIC8vIGxvb2sgdXAgaWYgdGhpcyB2aWV3IGhhcyBiZWhhdmlvciBldmVudHMKICAgICAgdmFyIGJlaGF2aW9yRXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2JlaGF2aW9yRXZlbnRzJykgfHwge307CiAgICAgIHZhciB0cmlnZ2VycyA9IHRoaXMuY29uZmlndXJlVHJpZ2dlcnMoKTsKICAgICAgdmFyIGJlaGF2aW9yVHJpZ2dlcnMgPSBfLnJlc3VsdCh0aGlzLCAnYmVoYXZpb3JUcmlnZ2VycycpIHx8IHt9OwogICAgICAvLyBiZWhhdmlvciBldmVudHMgd2lsbCBiZSBvdmVycmlkZW4gYnkgdmlldyBldmVudHMgYW5kIG9yIHRyaWdnZXJzCiAgICAgIF8uZXh0ZW5kKGNvbWJpbmVkRXZlbnRzLCBiZWhhdmlvckV2ZW50cywgZXZlbnRzLCB0cmlnZ2VycywgYmVoYXZpb3JUcmlnZ2Vycyk7CiAgICAgIEJhY2tib25lLlZpZXcucHJvdG90eXBlLmRlbGVnYXRlRXZlbnRzLmNhbGwodGhpcywgY29tYmluZWRFdmVudHMpOwogICAgfSwKICAgIC8vIE92ZXJyaWRpbmcgQmFja2JvbmUuVmlldydzIHVuZGVsZWdhdGVFdmVudHMgdG8gaGFuZGxlIHVuYmluZGluZwogICAgLy8gdGhlIGB0cmlnZ2Vyc2AsIGBtb2RlbEV2ZW50c2AsIGFuZCBgY29sbGVjdGlvbkV2ZW50c2AgY29uZmlnCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS51bmRlbGVnYXRlRXZlbnRzLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB0aGlzLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCB0aGlzLmdldE9wdGlvbignbW9kZWxFdmVudHMnKSk7CiAgICAgIHRoaXMudW5iaW5kRW50aXR5RXZlbnRzKHRoaXMuY29sbGVjdGlvbiwgdGhpcy5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgICAgIF8uZWFjaCh0aGlzLl9iZWhhdmlvcnMsIGZ1bmN0aW9uIChiZWhhdmlvcikgewogICAgICAgIGJlaGF2aW9yLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCBiZWhhdmlvci5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICAgIGJlaGF2aW9yLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLmNvbGxlY3Rpb24sIGJlaGF2aW9yLmdldE9wdGlvbignY29sbGVjdGlvbkV2ZW50cycpKTsKICAgICAgfSwgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCwgaGFuZGxlcyB0aGUgYHNob3dgIGV2ZW50LgogICAgb25TaG93Q2FsbGVkOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgaGVscGVyIG1ldGhvZCB0byB2ZXJpZnkgd2hldGhlciB0aGUgdmlldyBoYXNuJ3QgYmVlbiBkZXN0cm95ZWQKICAgIF9lbnN1cmVWaWV3SXNJbnRhY3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnVmlld0Rlc3Ryb3llZEVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdWaWV3IChjaWQ6ICInICsgdGhpcy5jaWQgKyAnIikgaGFzIGFscmVhZHkgYmVlbiBkZXN0cm95ZWQgYW5kIGNhbm5vdCBiZSB1c2VkLicKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIC8vIERlZmF1bHQgYGRlc3Ryb3lgIGltcGxlbWVudGF0aW9uLCBmb3IgcmVtb3ZpbmcgYSB2aWV3IGZyb20gdGhlCiAgICAvLyBET00gYW5kIHVuYmluZGluZyBpdC4gUmVnaW9ucyB3aWxsIGNhbGwgdGhpcyBtZXRob2QKICAgIC8vIGZvciB5b3UuIFlvdSBjYW4gc3BlY2lmeSBhbiBgb25EZXN0cm95YCBtZXRob2QgaW4geW91ciB2aWV3IHRvCiAgICAvLyBhZGQgY3VzdG9tIGNvZGUgdGhhdCBpcyBjYWxsZWQgYWZ0ZXIgdGhlIHZpZXcgaXMgZGVzdHJveWVkLgogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5pc0Rlc3Ryb3llZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kLmFwcGx5KHRoaXMsIFsnYmVmb3JlOmRlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICAvLyBtYXJrIGFzIGRlc3Ryb3llZCBiZWZvcmUgZG9pbmcgdGhlIGFjdHVhbCBkZXN0cm95LCB0bwogICAgICAvLyBwcmV2ZW50IGluZmluaXRlIGxvb3BzIHdpdGhpbiAiZGVzdHJveSIgZXZlbnQgaGFuZGxlcnMKICAgICAgLy8gdGhhdCBhcmUgdHJ5aW5nIHRvIGRlc3Ryb3kgb3RoZXIgdmlld3MKICAgICAgdGhpcy5pc0Rlc3Ryb3llZCA9IHRydWU7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2Rlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICAvLyB1bmJpbmQgVUkgZWxlbWVudHMKICAgICAgdGhpcy51bmJpbmRVSUVsZW1lbnRzKCk7CiAgICAgIC8vIHJlbW92ZSB0aGUgdmlldyBmcm9tIHRoZSBET00KICAgICAgdGhpcy5yZW1vdmUoKTsKICAgICAgLy8gQ2FsbCBkZXN0cm95IG9uIGVhY2ggYmVoYXZpb3IgYWZ0ZXIKICAgICAgLy8gZGVzdHJveWluZyB0aGUgdmlldy4KICAgICAgLy8gVGhpcyB1bmJpbmRzIGV2ZW50IGxpc3RlbmVycwogICAgICAvLyB0aGF0IGJlaGF2aW9ycyBoYXZlIHJlZ2lzdGVyZCBmb3IuCiAgICAgIF8uaW52b2tlKHRoaXMuX2JlaGF2aW9ycywgJ2Rlc3Ryb3knLCBhcmdzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgYmluZFVJRWxlbWVudHM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fYmluZFVJRWxlbWVudHMoKTsKICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCB0aGlzLl9iaW5kVUlFbGVtZW50cyk7CiAgICB9LAogICAgLy8gVGhpcyBtZXRob2QgYmluZHMgdGhlIGVsZW1lbnRzIHNwZWNpZmllZCBpbiB0aGUgInVpIiBoYXNoIGluc2lkZSB0aGUgdmlldydzIGNvZGUgd2l0aAogICAgLy8gdGhlIGFzc29jaWF0ZWQgalF1ZXJ5IHNlbGVjdG9ycy4KICAgIF9iaW5kVUlFbGVtZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudWkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gc3RvcmUgdGhlIHVpIGhhc2ggaW4gX3VpQmluZGluZ3Mgc28gdGhleSBjYW4gYmUgcmVzZXQgbGF0ZXIKICAgICAgLy8gYW5kIHNvIHJlLXJlbmRlcmluZyB0aGUgdmlldyB3aWxsIGJlIGFibGUgdG8gZmluZCB0aGUgYmluZGluZ3MKICAgICAgaWYgKCF0aGlzLl91aUJpbmRpbmdzKSB7CiAgICAgICAgdGhpcy5fdWlCaW5kaW5ncyA9IHRoaXMudWk7CiAgICAgIH0KICAgICAgLy8gZ2V0IHRoZSBiaW5kaW5ncyByZXN1bHQsIGFzIGEgZnVuY3Rpb24gb3Igb3RoZXJ3aXNlCiAgICAgIHZhciBiaW5kaW5ncyA9IF8ucmVzdWx0KHRoaXMsICdfdWlCaW5kaW5ncycpOwogICAgICAvLyBlbXB0eSB0aGUgdWkgc28gd2UgZG9uJ3QgaGF2ZSBhbnl0aGluZyB0byBzdGFydCB3aXRoCiAgICAgIHRoaXMudWkgPSB7fTsKICAgICAgLy8gYmluZCBlYWNoIG9mIHRoZSBzZWxlY3RvcnMKICAgICAgXy5lYWNoKF8ua2V5cyhiaW5kaW5ncyksIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgc2VsZWN0b3IgPSBiaW5kaW5nc1trZXldOwogICAgICAgIHRoaXMudWlba2V5XSA9IHRoaXMuJChzZWxlY3Rvcik7CiAgICAgIH0sIHRoaXMpOwogICAgfSwKICAgIC8vIFRoaXMgbWV0aG9kIHVuYmluZHMgdGhlIGVsZW1lbnRzIHNwZWNpZmllZCBpbiB0aGUgInVpIiBoYXNoCiAgICB1bmJpbmRVSUVsZW1lbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3VuYmluZFVJRWxlbWVudHMoKTsKICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCB0aGlzLl91bmJpbmRVSUVsZW1lbnRzKTsKICAgIH0sCiAgICBfdW5iaW5kVUlFbGVtZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudWkgfHwgIXRoaXMuX3VpQmluZGluZ3MpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gZGVsZXRlIGFsbCBvZiB0aGUgZXhpc3RpbmcgdWkgYmluZGluZ3MKICAgICAgXy5lYWNoKHRoaXMudWksIGZ1bmN0aW9uICgkZWwsIG5hbWUpIHsKICAgICAgICBkZWxldGUgdGhpcy51aVtuYW1lXTsKICAgICAgfSwgdGhpcyk7CiAgICAgIC8vIHJlc2V0IHRoZSB1aSBlbGVtZW50IHRvIHRoZSBvcmlnaW5hbCBiaW5kaW5ncyBjb25maWd1cmF0aW9uCiAgICAgIHRoaXMudWkgPSB0aGlzLl91aUJpbmRpbmdzOwogICAgICBkZWxldGUgdGhpcy5fdWlCaW5kaW5nczsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGFuIGV2ZW50IGhhbmRsZXIgZm9yIGEgZ2l2ZW4gYHRyaWdnZXJEZWZgIGxpa2UKICAgIC8vICdjbGljazpmb28nCiAgICBfYnVpbGRWaWV3VHJpZ2dlcjogZnVuY3Rpb24gKHRyaWdnZXJEZWYpIHsKICAgICAgdmFyIGhhc09wdGlvbnMgPSBfLmlzT2JqZWN0KHRyaWdnZXJEZWYpOwogICAgICB2YXIgb3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIGhhc09wdGlvbnMgPyB0cmlnZ2VyRGVmIDoge30sIHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogdHJ1ZSwKICAgICAgICBzdG9wUHJvcGFnYXRpb246IHRydWUKICAgICAgfSk7CiAgICAgIHZhciBldmVudE5hbWUgPSBoYXNPcHRpb25zID8gb3B0aW9ucy5ldmVudCA6IHRyaWdnZXJEZWY7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoZSkgewogICAgICAgIGlmIChlKSB7CiAgICAgICAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCAmJiBvcHRpb25zLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlLnN0b3BQcm9wYWdhdGlvbiAmJiBvcHRpb25zLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXJncyA9IHsKICAgICAgICAgIHZpZXc6IHRoaXMsCiAgICAgICAgICBtb2RlbDogdGhpcy5tb2RlbCwKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMuY29sbGVjdGlvbgogICAgICAgIH07CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKGV2ZW50TmFtZSwgYXJncyk7CiAgICAgIH07CiAgICB9LAogICAgc2V0RWxlbWVudDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgcmV0ID0gQmFja2JvbmUuVmlldy5wcm90b3R5cGUuc2V0RWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAvLyBwcm94eSBiZWhhdmlvciAkZWwgdG8gdGhlIHZpZXcncyAkZWwuCiAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIGJlY2F1c2UgYSB2aWV3J3MgJGVsIHByb3h5CiAgICAgIC8vIGlzIG5vdCBzZXQgdW50aWwgYWZ0ZXIgc2V0RWxlbWVudCBpcyBjYWxsZWQuCiAgICAgIF8uaW52b2tlKHRoaXMuX2JlaGF2aW9ycywgJ3Byb3h5Vmlld1Byb3BlcnRpZXMnLCB0aGlzKTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHZhciB0cmlnZ2VyTWV0aG9kID0gTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kOwogICAgICB2YXIgcmV0ID0gdHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgZnVuY3Rpb24gKGIpIHsKICAgICAgICB0cmlnZ2VyTWV0aG9kLmFwcGx5KGIsIGFyZ3MpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICAvLyBJbXBvcnRzIHRoZSAibm9ybWFsaXplTWV0aG9kcyIgdG8gdHJhbnNmb3JtIGhhc2hlcyBvZgogICAgLy8gZXZlbnRzPT5mdW5jdGlvbiByZWZlcmVuY2VzL25hbWVzIHRvIGEgaGFzaCBvZiBldmVudHM9PmZ1bmN0aW9uIHJlZmVyZW5jZXMKICAgIG5vcm1hbGl6ZU1ldGhvZHM6IE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcywKICAgIC8vIFByb3h5IGBnZXRPcHRpb25gIHRvIGVuYWJsZSBnZXR0aW5nIG9wdGlvbnMgZnJvbSB0aGlzIG9yIHRoaXMub3B0aW9ucyBieSBuYW1lLgogICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogICAgLy8gUHJveHkgYHVuYmluZEVudGl0eUV2ZW50c2AgdG8gZW5hYmxlIGJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eUJpbmRFbnRpdHlFdmVudHMsCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgIHVuYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cwogIH0pOwogIC8vIEl0ZW0gVmlldwogIC8vIC0tLS0tLS0tLQogIC8vIEEgc2luZ2xlIGl0ZW0gdmlldyBpbXBsZW1lbnRhdGlvbiB0aGF0IGNvbnRhaW5zIGNvZGUgZm9yIHJlbmRlcmluZwogIC8vIHdpdGggdW5kZXJzY29yZS5qcyB0ZW1wbGF0ZXMsIHNlcmlhbGl6aW5nIHRoZSB2aWV3J3MgbW9kZWwgb3IgY29sbGVjdGlvbiwKICAvLyBhbmQgY2FsbGluZyBzZXZlcmFsIG1ldGhvZHMgb24gZXh0ZW5kZWQgdmlld3MsIHN1Y2ggYXMgYG9uUmVuZGVyYC4KICBNYXJpb25ldHRlLkl0ZW1WaWV3ID0gTWFyaW9uZXR0ZS5WaWV3LmV4dGVuZCh7CiAgICAvLyBTZXR0aW5nIHVwIHRoZSBpbmhlcml0YW5jZSBjaGFpbiB3aGljaCBhbGxvd3MgY2hhbmdlcyB0bwogICAgLy8gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5jb25zdHJ1Y3RvciB3aGljaCBhbGxvd3Mgb3ZlcnJpZGluZwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uICgpIHsKICAgICAgTWFyaW9uZXR0ZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gU2VyaWFsaXplIHRoZSBtb2RlbCBvciBjb2xsZWN0aW9uIGZvciB0aGUgdmlldy4gSWYgYSBtb2RlbCBpcwogICAgLy8gZm91bmQsIHRoZSB2aWV3J3MgYHNlcmlhbGl6ZU1vZGVsYCBpcyBjYWxsZWQuIElmIGEgY29sbGVjdGlvbiBpcyBmb3VuZCwKICAgIC8vIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24gaXMgc2VyaWFsaXplZCBieSBjYWxsaW5nCiAgICAvLyB0aGUgdmlldydzIGBzZXJpYWxpemVDb2xsZWN0aW9uYCBhbmQgcHV0IGludG8gYW4gYGl0ZW1zYCBhcnJheSBpbgogICAgLy8gdGhlIHJlc3VsdGluZyBkYXRhLiBJZiBib3RoIGFyZSBmb3VuZCwgZGVmYXVsdHMgdG8gdGhlIG1vZGVsLgogICAgLy8gWW91IGNhbiBvdmVycmlkZSB0aGUgYHNlcmlhbGl6ZURhdGFgIG1ldGhvZCBpbiB5b3VyIG93biB2aWV3IGRlZmluaXRpb24sCiAgICAvLyB0byBwcm92aWRlIGN1c3RvbSBzZXJpYWxpemF0aW9uIGZvciB5b3VyIHZpZXcncyBkYXRhLgogICAgc2VyaWFsaXplRGF0YTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZGF0YSA9IHt9OwogICAgICBpZiAodGhpcy5tb2RlbCkgewogICAgICAgIGRhdGEgPSBfLnBhcnRpYWwodGhpcy5zZXJpYWxpemVNb2RlbCwgdGhpcy5tb2RlbCkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICBkYXRhID0geyBpdGVtczogXy5wYXJ0aWFsKHRoaXMuc2VyaWFsaXplQ29sbGVjdGlvbiwgdGhpcy5jb2xsZWN0aW9uKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9LAogICAgLy8gU2VyaWFsaXplIGEgY29sbGVjdGlvbiBieSBzZXJpYWxpemluZyBlYWNoIG9mIGl0cyBtb2RlbHMuCiAgICBzZXJpYWxpemVDb2xsZWN0aW9uOiBmdW5jdGlvbiAoY29sbGVjdGlvbikgewogICAgICByZXR1cm4gY29sbGVjdGlvbi50b0pTT04uYXBwbHkoY29sbGVjdGlvbiwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgdGhlIHZpZXcsIGRlZmF1bHRpbmcgdG8gdW5kZXJzY29yZS5qcyB0ZW1wbGF0ZXMuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoaXMgaW4geW91ciB2aWV3IGRlZmluaXRpb24gdG8gcHJvdmlkZQogICAgLy8gYSB2ZXJ5IHNwZWNpZmljIHJlbmRlcmluZyBmb3IgeW91ciB2aWV3LiBJbiBnZW5lcmFsLCB0aG91Z2gsCiAgICAvLyB5b3Ugc2hvdWxkIG92ZXJyaWRlIHRoZSBgTWFyaW9uZXR0ZS5SZW5kZXJlcmAgb2JqZWN0IHRvCiAgICAvLyBjaGFuZ2UgaG93IE1hcmlvbmV0dGUgcmVuZGVycyB2aWV3cy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuYmluZFVJRWxlbWVudHMoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXInLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbmRlciB0aGUgdGVtcGxhdGUgd2l0aCB0aGUgc2VyaWFsaXplZCBkYXRhCiAgICAvLyBhbmQgdGVtcGxhdGUgaGVscGVycyB2aWEgdGhlIGBNYXJpb25ldHRlLlJlbmRlcmVyYCBvYmplY3QuCiAgICAvLyBUaHJvd3MgYW4gYFVuZGVmaW5lZFRlbXBsYXRlRXJyb3JgIGVycm9yIGlmIHRoZSB0ZW1wbGF0ZSBpcwogICAgLy8gYW55IGZhbHNlbHkgdmFsdWUgYnV0IGxpdGVyYWwgYGZhbHNlYC4KICAgIF9yZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLmdldFRlbXBsYXRlKCk7CiAgICAgIC8vIEFsbG93IHRlbXBsYXRlLWxlc3MgaXRlbSB2aWV3cwogICAgICBpZiAodGVtcGxhdGUgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnVW5kZWZpbmVkVGVtcGxhdGVFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IHJlbmRlciB0aGUgdGVtcGxhdGUgc2luY2UgaXQgaXMgbnVsbCBvciB1bmRlZmluZWQuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIC8vIEFkZCBpbiBlbnRpdHkgZGF0YSBhbmQgdGVtcGxhdGUgaGVscGVycwogICAgICB2YXIgZGF0YSA9IHRoaXMuc2VyaWFsaXplRGF0YSgpOwogICAgICBkYXRhID0gdGhpcy5taXhpblRlbXBsYXRlSGVscGVycyhkYXRhKTsKICAgICAgLy8gUmVuZGVyIGFuZCBhZGQgdG8gZWwKICAgICAgdmFyIGh0bWwgPSBNYXJpb25ldHRlLlJlbmRlcmVyLnJlbmRlcih0ZW1wbGF0ZSwgZGF0YSwgdGhpcyk7CiAgICAgIHRoaXMuYXR0YWNoRWxDb250ZW50KGh0bWwpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBBdHRhY2hlcyB0aGUgY29udGVudCBvZiBhIGdpdmVuIHZpZXcuCiAgICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGRlbiB0byBvcHRpbWl6ZSByZW5kZXJpbmcsCiAgICAvLyBvciB0byByZW5kZXIgaW4gYSBub24gc3RhbmRhcmQgd2F5LgogICAgLy8KICAgIC8vIEZvciBleGFtcGxlLCB1c2luZyBgaW5uZXJIVE1MYCBpbnN0ZWFkIG9mIGAkZWwuaHRtbGAKICAgIC8vCiAgICAvLyBgYGBqcwogICAgLy8gYXR0YWNoRWxDb250ZW50OiBmdW5jdGlvbihodG1sKSB7CiAgICAvLyAgIHRoaXMuZWwuaW5uZXJIVE1MID0gaHRtbDsKICAgIC8vICAgcmV0dXJuIHRoaXM7CiAgICAvLyB9CiAgICAvLyBgYGAKICAgIGF0dGFjaEVsQ29udGVudDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdGhpcy4kZWwuaHRtbChodG1sKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZGVzdHJveSBldmVudCB0byBhZGQgYSBmZXcKICAgIC8vIG1vcmUgZXZlbnRzIHRoYXQgYXJlIHRyaWdnZXJlZC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuVmlldy5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0pOwogIC8qIGpzaGludCBtYXhzdGF0ZW1lbnRzOiAxNCAqLwogIC8qIGpzaGludCBtYXhsZW46IDIwMCAqLwogIC8vIENvbGxlY3Rpb24gVmlldwogIC8vIC0tLS0tLS0tLS0tLS0tLQogIC8vIEEgdmlldyB0aGF0IGl0ZXJhdGVzIG92ZXIgYSBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gYW5kIHJlbmRlcnMgYW4gaW5kaXZpZHVhbCBjaGlsZCB2aWV3IGZvciBlYWNoIG1vZGVsLgogIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcgPSBNYXJpb25ldHRlLlZpZXcuZXh0ZW5kKHsKICAgIC8vIHVzZWQgYXMgdGhlIHByZWZpeCBmb3IgY2hpbGQgdmlldyBldmVudHMKICAgIC8vIHRoYXQgYXJlIGZvcndhcmRlZCB0aHJvdWdoIHRoZSBjb2xsZWN0aW9udmlldwogICAgY2hpbGRWaWV3RXZlbnRQcmVmaXg6ICdjaGlsZHZpZXcnLAogICAgLy8gY29uc3RydWN0b3IKICAgIC8vIG9wdGlvbiB0byBwYXNzIGB7c29ydDogZmFsc2V9YCB0byBwcmV2ZW50IHRoZSBgQ29sbGVjdGlvblZpZXdgIGZyb20KICAgIC8vIG1haW50YWluaW5nIHRoZSBzb3J0ZWQgb3JkZXIgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAvLyBUaGlzIHdpbGwgZmFsbGJhY2sgb250byBhcHBlbmRpbmcgY2hpbGRWaWV3J3MgdG8gdGhlIGVuZC4KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgaW5pdE9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLnNvcnQgPSBfLmlzVW5kZWZpbmVkKGluaXRPcHRpb25zLnNvcnQpID8gdHJ1ZSA6IGluaXRPcHRpb25zLnNvcnQ7CiAgICAgIGlmIChpbml0T3B0aW9ucy5jb2xsZWN0aW9uICYmICEoaW5pdE9wdGlvbnMuY29sbGVjdGlvbiBpbnN0YW5jZW9mIEJhY2tib25lLkNvbGxlY3Rpb24pKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoJ1RoZSBDb2xsZWN0aW9uIG9wdGlvbiBwYXNzZWQgdG8gdGhpcyB2aWV3IG5lZWRzIHRvIGJlIGFuIGluc3RhbmNlIG9mIGEgQmFja2JvbmUuQ29sbGVjdGlvbicpOwogICAgICB9CiAgICAgIHRoaXMub25jZSgncmVuZGVyJywgdGhpcy5faW5pdGlhbEV2ZW50cyk7CiAgICAgIHRoaXMuX2luaXRDaGlsZFZpZXdTdG9yYWdlKCk7CiAgICAgIE1hcmlvbmV0dGUuVmlldy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB0aGlzLmluaXRSZW5kZXJCdWZmZXIoKTsKICAgIH0sCiAgICAvLyBJbnN0ZWFkIG9mIGluc2VydGluZyBlbGVtZW50cyBvbmUgYnkgb25lIGludG8gdGhlIHBhZ2UsCiAgICAvLyBpdCdzIG11Y2ggbW9yZSBwZXJmb3JtYW50IHRvIGluc2VydCBlbGVtZW50cyBpbnRvIGEgZG9jdW1lbnQKICAgIC8vIGZyYWdtZW50IGFuZCB0aGVuIGluc2VydCB0aGF0IGRvY3VtZW50IGZyYWdtZW50IGludG8gdGhlIHBhZ2UKICAgIGluaXRSZW5kZXJCdWZmZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5lbEJ1ZmZlciA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgdGhpcy5fYnVmZmVyZWRDaGlsZHJlbiA9IFtdOwogICAgfSwKICAgIHN0YXJ0QnVmZmVyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuaW5pdFJlbmRlckJ1ZmZlcigpOwogICAgICB0aGlzLmlzQnVmZmVyaW5nID0gdHJ1ZTsKICAgIH0sCiAgICBlbmRCdWZmZXJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5pc0J1ZmZlcmluZyA9IGZhbHNlOwogICAgICB0aGlzLl90cmlnZ2VyQmVmb3JlU2hvd0J1ZmZlcmVkQ2hpbGRyZW4oKTsKICAgICAgdGhpcy5hdHRhY2hCdWZmZXIodGhpcywgdGhpcy5lbEJ1ZmZlcik7CiAgICAgIHRoaXMuX3RyaWdnZXJTaG93QnVmZmVyZWRDaGlsZHJlbigpOwogICAgICB0aGlzLmluaXRSZW5kZXJCdWZmZXIoKTsKICAgIH0sCiAgICBfdHJpZ2dlckJlZm9yZVNob3dCdWZmZXJlZENoaWxkcmVuOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLl9pc1Nob3duKSB7CiAgICAgICAgXy5lYWNoKHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4sIF8ucGFydGlhbCh0aGlzLl90cmlnZ2VyTWV0aG9kT25DaGlsZCwgJ2JlZm9yZTpzaG93JykpOwogICAgICB9CiAgICB9LAogICAgX3RyaWdnZXJTaG93QnVmZmVyZWRDaGlsZHJlbjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIF8uZWFjaCh0aGlzLl9idWZmZXJlZENoaWxkcmVuLCBfLnBhcnRpYWwodGhpcy5fdHJpZ2dlck1ldGhvZE9uQ2hpbGQsICdzaG93JykpOwogICAgICAgIHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4gPSBbXTsKICAgICAgfQogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCBmb3IgXy5lYWNoIGxvb3BzIHRvIGNhbGwgYE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uYCBvbgogICAgLy8gYSBjaGlsZCB2aWV3CiAgICBfdHJpZ2dlck1ldGhvZE9uQ2hpbGQ6IGZ1bmN0aW9uIChldmVudCwgY2hpbGRWaWV3KSB7CiAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKGNoaWxkVmlldywgZXZlbnQpOwogICAgfSwKICAgIC8vIENvbmZpZ3VyZWQgdGhlIGluaXRpYWwgZXZlbnRzIHRoYXQgdGhlIGNvbGxlY3Rpb24gdmlldwogICAgLy8gYmluZHMgdG8uCiAgICBfaW5pdGlhbEV2ZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uKSB7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdhZGQnLCB0aGlzLl9vbkNvbGxlY3Rpb25BZGQpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAncmVtb3ZlJywgdGhpcy5fb25Db2xsZWN0aW9uUmVtb3ZlKTsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ3Jlc2V0JywgdGhpcy5yZW5kZXIpOwogICAgICAgIGlmICh0aGlzLnNvcnQpIHsKICAgICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAnc29ydCcsIHRoaXMuX3NvcnRWaWV3cyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gSGFuZGxlIGEgY2hpbGQgYWRkZWQgdG8gdGhlIGNvbGxlY3Rpb24KICAgIF9vbkNvbGxlY3Rpb25BZGQ6IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB0aGlzLmRlc3Ryb3lFbXB0eVZpZXcoKTsKICAgICAgdmFyIENoaWxkVmlldyA9IHRoaXMuZ2V0Q2hpbGRWaWV3KGNoaWxkKTsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YoY2hpbGQpOwogICAgICB0aGlzLmFkZENoaWxkKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KTsKICAgIH0sCiAgICAvLyBnZXQgdGhlIGNoaWxkIHZpZXcgYnkgbW9kZWwgaXQgaG9sZHMsIGFuZCByZW1vdmUgaXQKICAgIF9vbkNvbGxlY3Rpb25SZW1vdmU6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICB2YXIgdmlldyA9IHRoaXMuY2hpbGRyZW4uZmluZEJ5TW9kZWwobW9kZWwpOwogICAgICB0aGlzLnJlbW92ZUNoaWxkVmlldyh2aWV3KTsKICAgICAgdGhpcy5jaGVja0VtcHR5KCk7CiAgICB9LAogICAgLy8gT3ZlcnJpZGUgZnJvbSBgTWFyaW9uZXR0ZS5WaWV3YCB0byB0cmlnZ2VyIHNob3cgb24gY2hpbGQgdmlld3MKICAgIG9uU2hvd0NhbGxlZDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLmNoaWxkcmVuLmVhY2goXy5wYXJ0aWFsKHRoaXMuX3RyaWdnZXJNZXRob2RPbkNoaWxkLCAnc2hvdycpKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgY2hpbGRyZW4gdmlld3MuIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvCiAgICAvLyBwcm92aWRlIHlvdXIgb3duIGltcGxlbWVudGF0aW9uIG9mIGEgcmVuZGVyIGZ1bmN0aW9uIGZvcgogICAgLy8gdGhlIGNvbGxlY3Rpb24gdmlldy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFJlbmRlciB2aWV3IGFmdGVyIHNvcnRpbmcuIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvCiAgICAvLyBjaGFuZ2UgaG93IHRoZSB2aWV3IHJlbmRlcnMgYWZ0ZXIgYSBgc29ydGAgb24gdGhlIGNvbGxlY3Rpb24uCiAgICAvLyBBbiBleGFtcGxlIG9mIHRoaXMgd291bGQgYmUgdG8gb25seSBgcmVuZGVyQ2hpbGRyZW5gIGluIGEgYENvbXBvc2l0ZVZpZXdgCiAgICAvLyByYXRoZXIgdGhhbiB0aGUgZnVsbCB2aWV3LgogICAgcmVzb3J0VmlldzogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnJlbmRlcigpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZC4gVGhpcyBjaGVja3MgZm9yIGFueSBjaGFuZ2VzIGluIHRoZSBvcmRlciBvZiB0aGUgY29sbGVjdGlvbi4KICAgIC8vIElmIHRoZSBpbmRleCBvZiBhbnkgdmlldyBkb2Vzbid0IG1hdGNoLCBpdCB3aWxsIHJlbmRlci4KICAgIF9zb3J0Vmlld3M6IGZ1bmN0aW9uICgpIHsKICAgICAgLy8gY2hlY2sgZm9yIGFueSBjaGFuZ2VzIGluIHNvcnQgb3JkZXIgb2Ygdmlld3MKICAgICAgdmFyIG9yZGVyQ2hhbmdlZCA9IHRoaXMuY29sbGVjdGlvbi5maW5kKGZ1bmN0aW9uIChpdGVtLCBpbmRleCkgewogICAgICAgIHZhciB2aWV3ID0gdGhpcy5jaGlsZHJlbi5maW5kQnlNb2RlbChpdGVtKTsKICAgICAgICByZXR1cm4gIXZpZXcgfHwgdmlldy5faW5kZXggIT09IGluZGV4OwogICAgICB9LCB0aGlzKTsKICAgICAgaWYgKG9yZGVyQ2hhbmdlZCkgewogICAgICAgIHRoaXMucmVzb3J0VmlldygpOwogICAgICB9CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBTZXBhcmF0ZWQgc28gdGhhdCBDb21wb3NpdGVWaWV3IGNhbiBoYXZlCiAgICAvLyBtb3JlIGNvbnRyb2wgb3ZlciBldmVudHMgYmVpbmcgdHJpZ2dlcmVkLCBhcm91bmQgdGhlIHJlbmRlcmluZwogICAgLy8gcHJvY2VzcwogICAgX3JlbmRlckNoaWxkcmVuOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZGVzdHJveUVtcHR5VmlldygpOwogICAgICB0aGlzLmRlc3Ryb3lDaGlsZHJlbigpOwogICAgICBpZiAodGhpcy5pc0VtcHR5KHRoaXMuY29sbGVjdGlvbikpIHsKICAgICAgICB0aGlzLnNob3dFbXB0eVZpZXcoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpyZW5kZXI6Y29sbGVjdGlvbicsIHRoaXMpOwogICAgICAgIHRoaXMuc3RhcnRCdWZmZXJpbmcoKTsKICAgICAgICB0aGlzLnNob3dDb2xsZWN0aW9uKCk7CiAgICAgICAgdGhpcy5lbmRCdWZmZXJpbmcoKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbmRlcjpjb2xsZWN0aW9uJywgdGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gbG9vcCB0aHJvdWdoIGNvbGxlY3Rpb24gYW5kIHNob3cgZWFjaCBjaGlsZCB2aWV3LgogICAgc2hvd0NvbGxlY3Rpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIENoaWxkVmlldzsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmVhY2goZnVuY3Rpb24gKGNoaWxkLCBpbmRleCkgewogICAgICAgIENoaWxkVmlldyA9IHRoaXMuZ2V0Q2hpbGRWaWV3KGNoaWxkKTsKICAgICAgICB0aGlzLmFkZENoaWxkKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KTsKICAgICAgfSwgdGhpcyk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNob3cgYW4gZW1wdHkgdmlldyBpbiBwbGFjZSBvZgogICAgLy8gYSBjb2xsZWN0aW9uIG9mIGNoaWxkIHZpZXdzLCB3aGVuIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5CiAgICBzaG93RW1wdHlWaWV3OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBFbXB0eVZpZXcgPSB0aGlzLmdldEVtcHR5VmlldygpOwogICAgICBpZiAoRW1wdHlWaWV3ICYmICF0aGlzLl9zaG93aW5nRW1wdHlWaWV3KSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyOmVtcHR5Jyk7CiAgICAgICAgdGhpcy5fc2hvd2luZ0VtcHR5VmlldyA9IHRydWU7CiAgICAgICAgdmFyIG1vZGVsID0gbmV3IEJhY2tib25lLk1vZGVsKCk7CiAgICAgICAgdGhpcy5hZGRFbXB0eVZpZXcobW9kZWwsIEVtcHR5Vmlldyk7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXI6ZW1wdHknKTsKICAgICAgfQogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBkZXN0cm95IGFuIGV4aXN0aW5nIGVtcHR5VmlldyBpbnN0YW5jZQogICAgLy8gaWYgb25lIGV4aXN0cy4gQ2FsbGVkIHdoZW4gYSBjb2xsZWN0aW9uIHZpZXcgaGFzIGJlZW4KICAgIC8vIHJlbmRlcmVkIGVtcHR5LCBhbmQgdGhlbiBhIGNoaWxkIGlzIGFkZGVkIHRvIHRoZSBjb2xsZWN0aW9uLgogICAgZGVzdHJveUVtcHR5VmlldzogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5fc2hvd2luZ0VtcHR5VmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbW92ZTplbXB0eScpOwogICAgICAgIHRoaXMuZGVzdHJveUNoaWxkcmVuKCk7CiAgICAgICAgZGVsZXRlIHRoaXMuX3Nob3dpbmdFbXB0eVZpZXc7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6ZW1wdHknKTsKICAgICAgfQogICAgfSwKICAgIC8vIFJldHJpZXZlIHRoZSBlbXB0eSB2aWV3IGNsYXNzCiAgICBnZXRFbXB0eVZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uKCdlbXB0eVZpZXcnKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgYW5kIHNob3cgdGhlIGVtcHR5Vmlldy4gU2ltaWxhciB0byBhZGRDaGlsZCBtZXRob2QKICAgIC8vIGJ1dCAiY2hpbGQ6YWRkZWQiIGV2ZW50cyBhcmUgbm90IGZpcmVkLCBhbmQgdGhlIGV2ZW50IGZyb20KICAgIC8vIGVtcHR5VmlldyBhcmUgbm90IGZvcndhcmRlZAogICAgYWRkRW1wdHlWaWV3OiBmdW5jdGlvbiAoY2hpbGQsIEVtcHR5VmlldykgewogICAgICAvLyBnZXQgdGhlIGVtcHR5Vmlld09wdGlvbnMsIGZhbGxpbmcgYmFjayB0byBjaGlsZFZpZXdPcHRpb25zCiAgICAgIHZhciBlbXB0eVZpZXdPcHRpb25zID0gdGhpcy5nZXRPcHRpb24oJ2VtcHR5Vmlld09wdGlvbnMnKSB8fCB0aGlzLmdldE9wdGlvbignY2hpbGRWaWV3T3B0aW9ucycpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGVtcHR5Vmlld09wdGlvbnMpKSB7CiAgICAgICAgZW1wdHlWaWV3T3B0aW9ucyA9IGVtcHR5Vmlld09wdGlvbnMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICAvLyBidWlsZCB0aGUgZW1wdHkgdmlldwogICAgICB2YXIgdmlldyA9IHRoaXMuYnVpbGRDaGlsZFZpZXcoY2hpbGQsIEVtcHR5VmlldywgZW1wdHlWaWV3T3B0aW9ucyk7CiAgICAgIC8vIFByb3h5IGVtcHR5VmlldyBldmVudHMKICAgICAgdGhpcy5wcm94eUNoaWxkRXZlbnRzKHZpZXcpOwogICAgICAvLyB0cmlnZ2VyIHRoZSAnYmVmb3JlOnNob3cnIGV2ZW50IG9uIGB2aWV3YCBpZiB0aGUgY29sbGVjdGlvbiB2aWV3CiAgICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gc2hvd24KICAgICAgaWYgKHRoaXMuX2lzU2hvd24pIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnYmVmb3JlOnNob3cnKTsKICAgICAgfQogICAgICAvLyBTdG9yZSB0aGUgYGVtcHR5Vmlld2AgbGlrZSBhIGBjaGlsZFZpZXdgIHNvIHdlIGNhbiBwcm9wZXJseQogICAgICAvLyByZW1vdmUgYW5kL29yIGNsb3NlIGl0IGxhdGVyCiAgICAgIHRoaXMuY2hpbGRyZW4uYWRkKHZpZXcpOwogICAgICAvLyBSZW5kZXIgaXQgYW5kIHNob3cgaXQKICAgICAgdGhpcy5yZW5kZXJDaGlsZFZpZXcodmlldywgLTEpOwogICAgICAvLyBjYWxsIHRoZSAnc2hvdycgbWV0aG9kIGlmIHRoZSBjb2xsZWN0aW9uIHZpZXcKICAgICAgLy8gaGFzIGFscmVhZHkgYmVlbiBzaG93bgogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKHZpZXcsICdzaG93Jyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZXRyaWV2ZSB0aGUgYGNoaWxkVmlld2AgY2xhc3MsIGVpdGhlciBmcm9tIGB0aGlzLm9wdGlvbnMuY2hpbGRWaWV3YAogICAgLy8gb3IgZnJvbSB0aGUgYGNoaWxkVmlld2AgaW4gdGhlIG9iamVjdCBkZWZpbml0aW9uLiBUaGUgIm9wdGlvbnMiCiAgICAvLyB0YWtlcyBwcmVjZWRlbmNlLgogICAgLy8gVGhpcyBtZXRob2QgcmVjZWl2ZXMgdGhlIG1vZGVsIHRoYXQgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGluc3RhbmNlCiAgICAvLyBjcmVhdGVkIGZyb20gdGhpcyBgY2hpbGRWaWV3YC4gT3ZlcnJpZGluZyBtZXRob2RzIG1heSB1c2UgdGhlIGNoaWxkCiAgICAvLyB0byBkZXRlcm1pbmUgd2hhdCBgY2hpbGRWaWV3YCBjbGFzcyB0byByZXR1cm4uCiAgICBnZXRDaGlsZFZpZXc6IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB2YXIgY2hpbGRWaWV3ID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlldycpOwogICAgICBpZiAoIWNoaWxkVmlldykgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG5hbWU6ICdOb0NoaWxkVmlld0Vycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdBICJjaGlsZFZpZXciIG11c3QgYmUgc3BlY2lmaWVkJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBjaGlsZFZpZXc7CiAgICB9LAogICAgLy8gUmVuZGVyIHRoZSBjaGlsZCdzIHZpZXcgYW5kIGFkZCBpdCB0byB0aGUKICAgIC8vIEhUTUwgZm9yIHRoZSBjb2xsZWN0aW9uIHZpZXcgYXQgYSBnaXZlbiBpbmRleC4KICAgIC8vIFRoaXMgd2lsbCBhbHNvIHVwZGF0ZSB0aGUgaW5kaWNlcyBvZiBsYXRlciB2aWV3cyBpbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaW4gb3JkZXIgdG8ga2VlcCB0aGUgY2hpbGRyZW4gaW4gc3luYyB3aXRoIHRoZSBjb2xsZWN0aW9uLgogICAgYWRkQ2hpbGQ6IGZ1bmN0aW9uIChjaGlsZCwgQ2hpbGRWaWV3LCBpbmRleCkgewogICAgICB2YXIgY2hpbGRWaWV3T3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9uKCdjaGlsZFZpZXdPcHRpb25zJyk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oY2hpbGRWaWV3T3B0aW9ucykpIHsKICAgICAgICBjaGlsZFZpZXdPcHRpb25zID0gY2hpbGRWaWV3T3B0aW9ucy5jYWxsKHRoaXMsIGNoaWxkLCBpbmRleCk7CiAgICAgIH0KICAgICAgdmFyIHZpZXcgPSB0aGlzLmJ1aWxkQ2hpbGRWaWV3KGNoaWxkLCBDaGlsZFZpZXcsIGNoaWxkVmlld09wdGlvbnMpOwogICAgICAvLyBpbmNyZW1lbnQgaW5kaWNlcyBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICB0aGlzLl91cGRhdGVJbmRpY2VzKHZpZXcsIHRydWUsIGluZGV4KTsKICAgICAgdGhpcy5fYWRkQ2hpbGRWaWV3KHZpZXcsIGluZGV4KTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBUaGlzIGRlY3JlbWVudHMgb3IgaW5jcmVtZW50cyB0aGUgaW5kaWNlcyBvZiB2aWV3cyBhZnRlciB0aGUKICAgIC8vIGFkZGVkL3JlbW92ZWQgdmlldyB0byBrZWVwIGluIHN5bmMgd2l0aCB0aGUgY29sbGVjdGlvbi4KICAgIF91cGRhdGVJbmRpY2VzOiBmdW5jdGlvbiAodmlldywgaW5jcmVtZW50LCBpbmRleCkgewogICAgICBpZiAoIXRoaXMuc29ydCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaW5jcmVtZW50KSB7CiAgICAgICAgLy8gYXNzaWduIHRoZSBpbmRleCB0byB0aGUgdmlldwogICAgICAgIHZpZXcuX2luZGV4ID0gaW5kZXg7CiAgICAgICAgLy8gaW5jcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuY2hpbGRyZW4uZWFjaChmdW5jdGlvbiAobGF0ZXJWaWV3KSB7CiAgICAgICAgICBpZiAobGF0ZXJWaWV3Ll9pbmRleCA+PSB2aWV3Ll9pbmRleCkgewogICAgICAgICAgICBsYXRlclZpZXcuX2luZGV4Kys7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuY2hpbGRyZW4uZWFjaChmdW5jdGlvbiAobGF0ZXJWaWV3KSB7CiAgICAgICAgICBpZiAobGF0ZXJWaWV3Ll9pbmRleCA+PSB2aWV3Ll9pbmRleCkgewogICAgICAgICAgICBsYXRlclZpZXcuX2luZGV4LS07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBNZXRob2QuIEFkZCB0aGUgdmlldyB0byBjaGlsZHJlbiBhbmQgcmVuZGVyIGl0IGF0CiAgICAvLyB0aGUgZ2l2ZW4gaW5kZXguCiAgICBfYWRkQ2hpbGRWaWV3OiBmdW5jdGlvbiAodmlldywgaW5kZXgpIHsKICAgICAgLy8gc2V0IHVwIHRoZSBjaGlsZCB2aWV3IGV2ZW50IGZvcndhcmRpbmcKICAgICAgdGhpcy5wcm94eUNoaWxkRXZlbnRzKHZpZXcpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6Y2hpbGQnLCB2aWV3KTsKICAgICAgLy8gU3RvcmUgdGhlIGNoaWxkIHZpZXcgaXRzZWxmIHNvIHdlIGNhbiBwcm9wZXJseQogICAgICAvLyByZW1vdmUgYW5kL29yIGRlc3Ryb3kgaXQgbGF0ZXIKICAgICAgdGhpcy5jaGlsZHJlbi5hZGQodmlldyk7CiAgICAgIHRoaXMucmVuZGVyQ2hpbGRWaWV3KHZpZXcsIGluZGV4KTsKICAgICAgaWYgKHRoaXMuX2lzU2hvd24gJiYgIXRoaXMuaXNCdWZmZXJpbmcpIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnc2hvdycpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYWRkOmNoaWxkJywgdmlldyk7CiAgICB9LAogICAgLy8gcmVuZGVyIHRoZSBjaGlsZCB2aWV3CiAgICByZW5kZXJDaGlsZFZpZXc6IGZ1bmN0aW9uICh2aWV3LCBpbmRleCkgewogICAgICB2aWV3LnJlbmRlcigpOwogICAgICB0aGlzLmF0dGFjaEh0bWwodGhpcywgdmlldywgaW5kZXgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0sCiAgICAvLyBCdWlsZCBhIGBjaGlsZFZpZXdgIGZvciBhIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgogICAgYnVpbGRDaGlsZFZpZXc6IGZ1bmN0aW9uIChjaGlsZCwgQ2hpbGRWaWV3Q2xhc3MsIGNoaWxkVmlld09wdGlvbnMpIHsKICAgICAgdmFyIG9wdGlvbnMgPSBfLmV4dGVuZCh7IG1vZGVsOiBjaGlsZCB9LCBjaGlsZFZpZXdPcHRpb25zKTsKICAgICAgcmV0dXJuIG5ldyBDaGlsZFZpZXdDbGFzcyhvcHRpb25zKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgdGhlIGNoaWxkIHZpZXcgYW5kIGRlc3Ryb3kgaXQuCiAgICAvLyBUaGlzIGZ1bmN0aW9uIGFsc28gdXBkYXRlcyB0aGUgaW5kaWNlcyBvZgogICAgLy8gbGF0ZXIgdmlld3MgaW4gdGhlIGNvbGxlY3Rpb24gaW4gb3JkZXIgdG8ga2VlcAogICAgLy8gdGhlIGNoaWxkcmVuIGluIHN5bmMgd2l0aCB0aGUgY29sbGVjdGlvbi4KICAgIHJlbW92ZUNoaWxkVmlldzogZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgaWYgKHZpZXcpIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpyZW1vdmU6Y2hpbGQnLCB2aWV3KTsKICAgICAgICAvLyBjYWxsICdkZXN0cm95JyBvciAncmVtb3ZlJywgZGVwZW5kaW5nIG9uIHdoaWNoIGlzIGZvdW5kCiAgICAgICAgaWYgKHZpZXcuZGVzdHJveSkgewogICAgICAgICAgdmlldy5kZXN0cm95KCk7CiAgICAgICAgfSBlbHNlIGlmICh2aWV3LnJlbW92ZSkgewogICAgICAgICAgdmlldy5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKHZpZXcpOwogICAgICAgIHRoaXMuY2hpbGRyZW4ucmVtb3ZlKHZpZXcpOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOmNoaWxkJywgdmlldyk7CiAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuX3VwZGF0ZUluZGljZXModmlldywgZmFsc2UpOwogICAgICB9CiAgICAgIHJldHVybiB2aWV3OwogICAgfSwKICAgIC8vIGNoZWNrIGlmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5CiAgICBpc0VtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAhdGhpcy5jb2xsZWN0aW9uIHx8IHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDA7CiAgICB9LAogICAgLy8gSWYgZW1wdHksIHNob3cgdGhlIGVtcHR5IHZpZXcKICAgIGNoZWNrRW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNFbXB0eSh0aGlzLmNvbGxlY3Rpb24pKSB7CiAgICAgICAgdGhpcy5zaG93RW1wdHlWaWV3KCk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBZb3UgbWlnaHQgbmVlZCB0byBvdmVycmlkZSB0aGlzIGlmIHlvdSd2ZSBvdmVycmlkZGVuIGF0dGFjaEh0bWwKICAgIGF0dGFjaEJ1ZmZlcjogZnVuY3Rpb24gKGNvbGxlY3Rpb25WaWV3LCBidWZmZXIpIHsKICAgICAgY29sbGVjdGlvblZpZXcuJGVsLmFwcGVuZChidWZmZXIpOwogICAgfSwKICAgIC8vIEFwcGVuZCB0aGUgSFRNTCB0byB0aGUgY29sbGVjdGlvbidzIGBlbGAuCiAgICAvLyBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBkbyBzb21ldGhpbmcgb3RoZXIKICAgIC8vIHRoYW4gYC5hcHBlbmRgLgogICAgYXR0YWNoSHRtbDogZnVuY3Rpb24gKGNvbGxlY3Rpb25WaWV3LCBjaGlsZFZpZXcsIGluZGV4KSB7CiAgICAgIGlmIChjb2xsZWN0aW9uVmlldy5pc0J1ZmZlcmluZykgewogICAgICAgIC8vIGJ1ZmZlcmluZyBoYXBwZW5zIG9uIHJlc2V0IGV2ZW50cyBhbmQgaW5pdGlhbCByZW5kZXJzCiAgICAgICAgLy8gaW4gb3JkZXIgdG8gcmVkdWNlIHRoZSBudW1iZXIgb2YgaW5zZXJ0cyBpbnRvIHRoZQogICAgICAgIC8vIGRvY3VtZW50LCB3aGljaCBhcmUgZXhwZW5zaXZlLgogICAgICAgIGNvbGxlY3Rpb25WaWV3LmVsQnVmZmVyLmFwcGVuZENoaWxkKGNoaWxkVmlldy5lbCk7CiAgICAgICAgY29sbGVjdGlvblZpZXcuX2J1ZmZlcmVkQ2hpbGRyZW4ucHVzaChjaGlsZFZpZXcpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIHdlJ3ZlIGFscmVhZHkgcmVuZGVyZWQgdGhlIG1haW4gY29sbGVjdGlvbiwgYXBwZW5kCiAgICAgICAgLy8gdGhlIG5ldyBjaGlsZCBpbnRvIHRoZSBjb3JyZWN0IG9yZGVyIGlmIHdlIG5lZWQgdG8uIE90aGVyd2lzZQogICAgICAgIC8vIGFwcGVuZCB0byB0aGUgZW5kLgogICAgICAgIGlmICghY29sbGVjdGlvblZpZXcuX2luc2VydEJlZm9yZShjaGlsZFZpZXcsIGluZGV4KSkgewogICAgICAgICAgY29sbGVjdGlvblZpZXcuX2luc2VydEFmdGVyKGNoaWxkVmlldyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBDaGVjayB3aGV0aGVyIHdlIG5lZWQgdG8gaW5zZXJ0IHRoZSB2aWV3IGludG8KICAgIC8vIHRoZSBjb3JyZWN0IHBvc2l0aW9uLgogICAgX2luc2VydEJlZm9yZTogZnVuY3Rpb24gKGNoaWxkVmlldywgaW5kZXgpIHsKICAgICAgdmFyIGN1cnJlbnRWaWV3OwogICAgICB2YXIgZmluZFBvc2l0aW9uID0gdGhpcy5zb3J0ICYmIGluZGV4IDwgdGhpcy5jaGlsZHJlbi5sZW5ndGggLSAxOwogICAgICBpZiAoZmluZFBvc2l0aW9uKSB7CiAgICAgICAgLy8gRmluZCB0aGUgdmlldyBhZnRlciB0aGlzIG9uZQogICAgICAgIGN1cnJlbnRWaWV3ID0gdGhpcy5jaGlsZHJlbi5maW5kKGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgICByZXR1cm4gdmlldy5faW5kZXggPT09IGluZGV4ICsgMTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoY3VycmVudFZpZXcpIHsKICAgICAgICBjdXJyZW50Vmlldy4kZWwuYmVmb3JlKGNoaWxkVmlldy5lbCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZC4gQXBwZW5kIGEgdmlldyB0byB0aGUgZW5kIG9mIHRoZSAkZWwKICAgIF9pbnNlcnRBZnRlcjogZnVuY3Rpb24gKGNoaWxkVmlldykgewogICAgICB0aGlzLiRlbC5hcHBlbmQoY2hpbGRWaWV3LmVsKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V0IHVwIHRoZSBgY2hpbGRyZW5gIG9iamVjdCBmb3IKICAgIC8vIHN0b3JpbmcgYWxsIG9mIHRoZSBjaGlsZCB2aWV3cwogICAgX2luaXRDaGlsZFZpZXdTdG9yYWdlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuY2hpbGRyZW4gPSBuZXcgQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyKCk7CiAgICB9LAogICAgLy8gSGFuZGxlIGNsZWFudXAgYW5kIG90aGVyIGRlc3Ryb3lpbmcgbmVlZHMgZm9yIHRoZSBjb2xsZWN0aW9uIG9mIHZpZXdzCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmRlc3Ryb3k6Y29sbGVjdGlvbicpOwogICAgICB0aGlzLmRlc3Ryb3lDaGlsZHJlbigpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2Rlc3Ryb3k6Y29sbGVjdGlvbicpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5kZXN0cm95LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gRGVzdHJveSB0aGUgY2hpbGQgdmlld3MgdGhhdCB0aGlzIGNvbGxlY3Rpb24gdmlldwogICAgLy8gaXMgaG9sZGluZyBvbiB0bywgaWYgYW55CiAgICBkZXN0cm95Q2hpbGRyZW46IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNoaWxkVmlld3MgPSB0aGlzLmNoaWxkcmVuLm1hcChfLmlkZW50aXR5KTsKICAgICAgdGhpcy5jaGlsZHJlbi5lYWNoKHRoaXMucmVtb3ZlQ2hpbGRWaWV3LCB0aGlzKTsKICAgICAgdGhpcy5jaGVja0VtcHR5KCk7CiAgICAgIHJldHVybiBjaGlsZFZpZXdzOwogICAgfSwKICAgIC8vIFNldCB1cCB0aGUgY2hpbGQgdmlldyBldmVudCBmb3J3YXJkaW5nLiBVc2VzIGEgImNoaWxkdmlldzoiCiAgICAvLyBwcmVmaXggaW4gZnJvbnQgb2YgYWxsIGZvcndhcmRlZCBldmVudHMuCiAgICBwcm94eUNoaWxkRXZlbnRzOiBmdW5jdGlvbiAodmlldykgewogICAgICB2YXIgcHJlZml4ID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlld0V2ZW50UHJlZml4Jyk7CiAgICAgIC8vIEZvcndhcmQgYWxsIGNoaWxkIHZpZXcgZXZlbnRzIHRocm91Z2ggdGhlIHBhcmVudCwKICAgICAgLy8gcHJlcGVuZGluZyAiY2hpbGR2aWV3OiIgdG8gdGhlIGV2ZW50IG5hbWUKICAgICAgdGhpcy5saXN0ZW5Ubyh2aWV3LCAnYWxsJywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHZhciByb290RXZlbnQgPSBhcmdzWzBdOwogICAgICAgIHZhciBjaGlsZEV2ZW50cyA9IHRoaXMubm9ybWFsaXplTWV0aG9kcyhfLnJlc3VsdCh0aGlzLCAnY2hpbGRFdmVudHMnKSk7CiAgICAgICAgYXJnc1swXSA9IHByZWZpeCArICc6JyArIHJvb3RFdmVudDsKICAgICAgICBhcmdzLnNwbGljZSgxLCAwLCB2aWV3KTsKICAgICAgICAvLyBjYWxsIGNvbGxlY3Rpb25WaWV3IGNoaWxkRXZlbnQgaWYgZGVmaW5lZAogICAgICAgIGlmICh0eXBlb2YgY2hpbGRFdmVudHMgIT09ICd1bmRlZmluZWQnICYmIF8uaXNGdW5jdGlvbihjaGlsZEV2ZW50c1tyb290RXZlbnRdKSkgewogICAgICAgICAgY2hpbGRFdmVudHNbcm9vdEV2ZW50XS5hcHBseSh0aGlzLCBhcmdzLnNsaWNlKDEpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9KTsKICAvKiBqc2hpbnQgbWF4c3RhdGVtZW50czogMTcsIG1heGxlbjogMTE3ICovCiAgLy8gQ29tcG9zaXRlIFZpZXcKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vIFVzZWQgZm9yIHJlbmRlcmluZyBhIGJyYW5jaC1sZWFmLCBoaWVyYXJjaGljYWwgc3RydWN0dXJlLgogIC8vIEV4dGVuZHMgZGlyZWN0bHkgZnJvbSBDb2xsZWN0aW9uVmlldyBhbmQgYWxzbyByZW5kZXJzIGFuCiAgLy8gYSBjaGlsZCB2aWV3IGFzIGBtb2RlbFZpZXdgLCBmb3IgdGhlIHRvcCBsZWFmCiAgTWFyaW9uZXR0ZS5Db21wb3NpdGVWaWV3ID0gTWFyaW9uZXR0ZS5Db2xsZWN0aW9uVmlldy5leHRlbmQoewogICAgLy8gU2V0dGluZyB1cCB0aGUgaW5oZXJpdGFuY2UgY2hhaW4gd2hpY2ggYWxsb3dzIGNoYW5nZXMgdG8KICAgIC8vIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcucHJvdG90eXBlLmNvbnN0cnVjdG9yIHdoaWNoIGFsbG93cyBvdmVycmlkaW5nCiAgICAvLyBvcHRpb24gdG8gcGFzcyAne3NvcnQ6IGZhbHNlfScgdG8gcHJldmVudCB0aGUgQ29tcG9zaXRlVmlldyBmcm9tCiAgICAvLyBtYWludGFpbmluZyB0aGUgc29ydGVkIG9yZGVyIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgLy8gVGhpcyB3aWxsIGZhbGxiYWNrIG9udG8gYXBwZW5kaW5nIGNoaWxkVmlldydzIHRvIHRoZSBlbmQuCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKCkgewogICAgICBNYXJpb25ldHRlLkNvbGxlY3Rpb25WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlZCB0aGUgaW5pdGlhbCBldmVudHMgdGhhdCB0aGUgY29tcG9zaXRlIHZpZXcKICAgIC8vIGJpbmRzIHRvLiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcmV2ZW50IHRoZSBpbml0aWFsCiAgICAvLyBldmVudHMsIG9yIHRvIGFkZCB5b3VyIG93biBpbml0aWFsIGV2ZW50cy4KICAgIF9pbml0aWFsRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIEJpbmQgb25seSBhZnRlciBjb21wb3NpdGUgdmlldyBpcyByZW5kZXJlZCB0byBhdm9pZCBhZGRpbmcgY2hpbGQgdmlld3MKICAgICAgLy8gdG8gbm9uZXhpc3RlbnQgY2hpbGRWaWV3Q29udGFpbmVyCiAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2FkZCcsIHRoaXMuX29uQ29sbGVjdGlvbkFkZCk7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdyZW1vdmUnLCB0aGlzLl9vbkNvbGxlY3Rpb25SZW1vdmUpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAncmVzZXQnLCB0aGlzLl9yZW5kZXJDaGlsZHJlbik7CiAgICAgICAgaWYgKHRoaXMuc29ydCkgewogICAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdzb3J0JywgdGhpcy5fc29ydFZpZXdzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZXRyaWV2ZSB0aGUgYGNoaWxkVmlld2AgdG8gYmUgdXNlZCB3aGVuIHJlbmRlcmluZyBlYWNoIG9mCiAgICAvLyB0aGUgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGlzIHRvIHJldHVybgogICAgLy8gYHRoaXMuY2hpbGRWaWV3YCBvciBNYXJpb25ldHRlLkNvbXBvc2l0ZVZpZXcgaWYgbm8gYGNoaWxkVmlld2AKICAgIC8vIGhhcyBiZWVuIGRlZmluZWQKICAgIGdldENoaWxkVmlldzogZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgIHZhciBjaGlsZFZpZXcgPSB0aGlzLmdldE9wdGlvbignY2hpbGRWaWV3JykgfHwgdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgaWYgKCFjaGlsZFZpZXcpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnTm9DaGlsZFZpZXdFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQSAiY2hpbGRWaWV3IiBtdXN0IGJlIHNwZWNpZmllZCcKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gY2hpbGRWaWV3OwogICAgfSwKICAgIC8vIFNlcmlhbGl6ZSB0aGUgY29sbGVjdGlvbiBmb3IgdGhlIHZpZXcuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoZSBgc2VyaWFsaXplRGF0YWAgbWV0aG9kIGluIHlvdXIgb3duIHZpZXcKICAgIC8vIGRlZmluaXRpb24sIHRvIHByb3ZpZGUgY3VzdG9tIHNlcmlhbGl6YXRpb24gZm9yIHlvdXIgdmlldydzIGRhdGEuCiAgICBzZXJpYWxpemVEYXRhOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkYXRhID0ge307CiAgICAgIGlmICh0aGlzLm1vZGVsKSB7CiAgICAgICAgZGF0YSA9IF8ucGFydGlhbCh0aGlzLnNlcmlhbGl6ZU1vZGVsLCB0aGlzLm1vZGVsKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfSwKICAgIC8vIFJlbmRlcnMgdGhlIG1vZGVsIG9uY2UsIGFuZCB0aGUgY29sbGVjdGlvbiBvbmNlLiBDYWxsaW5nCiAgICAvLyB0aGlzIGFnYWluIHdpbGwgdGVsbCB0aGUgbW9kZWwncyB2aWV3IHRvIHJlLXJlbmRlciBpdHNlbGYKICAgIC8vIGJ1dCB0aGUgY29sbGVjdGlvbiB3aWxsIG5vdCByZS1yZW5kZXIuCiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fZW5zdXJlVmlld0lzSW50YWN0KCk7CiAgICAgIHRoaXMuaXNSZW5kZXJlZCA9IHRydWU7CiAgICAgIHRoaXMucmVzZXRDaGlsZFZpZXdDb250YWluZXIoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIF9yZW5kZXJDaGlsZHJlbjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5pc1JlbmRlcmVkKSB7CiAgICAgICAgTWFyaW9uZXR0ZS5Db2xsZWN0aW9uVmlldy5wcm90b3R5cGUuX3JlbmRlckNoaWxkcmVuLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZW5kZXIgdGhlIHJvb3QgdGVtcGxhdGUgdGhhdCB0aGUgY2hpbGRyZW4KICAgIC8vIHZpZXdzIGFyZSBhcHBlbmRlZCB0bwogICAgX3JlbmRlclRlbXBsYXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkYXRhID0ge307CiAgICAgIGRhdGEgPSB0aGlzLnNlcmlhbGl6ZURhdGEoKTsKICAgICAgZGF0YSA9IHRoaXMubWl4aW5UZW1wbGF0ZUhlbHBlcnMoZGF0YSk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbmRlcjp0ZW1wbGF0ZScpOwogICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLmdldFRlbXBsYXRlKCk7CiAgICAgIHZhciBodG1sID0gTWFyaW9uZXR0ZS5SZW5kZXJlci5yZW5kZXIodGVtcGxhdGUsIGRhdGEsIHRoaXMpOwogICAgICB0aGlzLmF0dGFjaEVsQ29udGVudChodG1sKTsKICAgICAgLy8gdGhlIHVpIGJpbmRpbmdzIGlzIGRvbmUgaGVyZSBhbmQgbm90IGF0IHRoZSBlbmQgb2YgcmVuZGVyIHNpbmNlIHRoZXkKICAgICAgLy8gd2lsbCBub3QgYmUgYXZhaWxhYmxlIHVudGlsIGFmdGVyIHRoZSBtb2RlbCBpcyByZW5kZXJlZCwgYnV0IHNob3VsZCBiZQogICAgICAvLyBhdmFpbGFibGUgYmVmb3JlIHRoZSBjb2xsZWN0aW9uIGlzIHJlbmRlcmVkLgogICAgICB0aGlzLmJpbmRVSUVsZW1lbnRzKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyOnRlbXBsYXRlJyk7CiAgICB9LAogICAgLy8gQXR0YWNoZXMgdGhlIGNvbnRlbnQgb2YgdGhlIHJvb3QuCiAgICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGRlbiB0byBvcHRpbWl6ZSByZW5kZXJpbmcsCiAgICAvLyBvciB0byByZW5kZXIgaW4gYSBub24gc3RhbmRhcmQgd2F5LgogICAgLy8KICAgIC8vIEZvciBleGFtcGxlLCB1c2luZyBgaW5uZXJIVE1MYCBpbnN0ZWFkIG9mIGAkZWwuaHRtbGAKICAgIC8vCiAgICAvLyBgYGBqcwogICAgLy8gYXR0YWNoRWxDb250ZW50OiBmdW5jdGlvbihodG1sKSB7CiAgICAvLyAgIHRoaXMuZWwuaW5uZXJIVE1MID0gaHRtbDsKICAgIC8vICAgcmV0dXJuIHRoaXM7CiAgICAvLyB9CiAgICAvLyBgYGAKICAgIGF0dGFjaEVsQ29udGVudDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdGhpcy4kZWwuaHRtbChodG1sKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gWW91IG1pZ2h0IG5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBpZiB5b3UndmUgb3ZlcnJpZGRlbiBhdHRhY2hIdG1sCiAgICBhdHRhY2hCdWZmZXI6IGZ1bmN0aW9uIChjb21wb3NpdGVWaWV3LCBidWZmZXIpIHsKICAgICAgdmFyICRjb250YWluZXIgPSB0aGlzLmdldENoaWxkVmlld0NvbnRhaW5lcihjb21wb3NpdGVWaWV3KTsKICAgICAgJGNvbnRhaW5lci5hcHBlbmQoYnVmZmVyKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QuIEFwcGVuZCBhIHZpZXcgdG8gdGhlIGVuZCBvZiB0aGUgJGVsLgogICAgLy8gT3ZlcmlkZGVuIGZyb20gQ29sbGVjdGlvblZpZXcgdG8gZW5zdXJlIHZpZXcgaXMgYXBwZW5kZWQgdG8KICAgIC8vIGNoaWxkVmlld0NvbnRhaW5lcgogICAgX2luc2VydEFmdGVyOiBmdW5jdGlvbiAoY2hpbGRWaWV3KSB7CiAgICAgIHZhciAkY29udGFpbmVyID0gdGhpcy5nZXRDaGlsZFZpZXdDb250YWluZXIodGhpcyk7CiAgICAgICRjb250YWluZXIuYXBwZW5kKGNoaWxkVmlldy5lbCk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGVuc3VyZSBhbiBgJGNoaWxkVmlld0NvbnRhaW5lcmAgZXhpc3RzLCBmb3IgdGhlCiAgICAvLyBgYXR0YWNoSHRtbGAgbWV0aG9kIHRvIHVzZS4KICAgIGdldENoaWxkVmlld0NvbnRhaW5lcjogZnVuY3Rpb24gKGNvbnRhaW5lclZpZXcpIHsKICAgICAgaWYgKCckY2hpbGRWaWV3Q29udGFpbmVyJyBpbiBjb250YWluZXJWaWV3KSB7CiAgICAgICAgcmV0dXJuIGNvbnRhaW5lclZpZXcuJGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgfQogICAgICB2YXIgY29udGFpbmVyOwogICAgICB2YXIgY2hpbGRWaWV3Q29udGFpbmVyID0gTWFyaW9uZXR0ZS5nZXRPcHRpb24oY29udGFpbmVyVmlldywgJ2NoaWxkVmlld0NvbnRhaW5lcicpOwogICAgICBpZiAoY2hpbGRWaWV3Q29udGFpbmVyKSB7CiAgICAgICAgdmFyIHNlbGVjdG9yID0gXy5pc0Z1bmN0aW9uKGNoaWxkVmlld0NvbnRhaW5lcikgPyBjaGlsZFZpZXdDb250YWluZXIuY2FsbChjb250YWluZXJWaWV3KSA6IGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgICBpZiAoc2VsZWN0b3IuY2hhckF0KDApID09PSAnQCcgJiYgY29udGFpbmVyVmlldy51aSkgewogICAgICAgICAgY29udGFpbmVyID0gY29udGFpbmVyVmlldy51aVtzZWxlY3Rvci5zdWJzdHIoNCldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250YWluZXIgPSBjb250YWluZXJWaWV3LiQoc2VsZWN0b3IpOwogICAgICAgIH0KICAgICAgICBpZiAoY29udGFpbmVyLmxlbmd0aCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICAgIG5hbWU6ICdDaGlsZFZpZXdDb250YWluZXJNaXNzaW5nRXJyb3InLAogICAgICAgICAgICBtZXNzYWdlOiAnVGhlIHNwZWNpZmllZCAiY2hpbGRWaWV3Q29udGFpbmVyIiB3YXMgbm90IGZvdW5kOiAnICsgY29udGFpbmVyVmlldy5jaGlsZFZpZXdDb250YWluZXIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb250YWluZXIgPSBjb250YWluZXJWaWV3LiRlbDsKICAgICAgfQogICAgICBjb250YWluZXJWaWV3LiRjaGlsZFZpZXdDb250YWluZXIgPSBjb250YWluZXI7CiAgICAgIHJldHVybiBjb250YWluZXI7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlc2V0IHRoZSBgJGNoaWxkVmlld0NvbnRhaW5lcmAgb24gcmVuZGVyCiAgICByZXNldENoaWxkVmlld0NvbnRhaW5lcjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy4kY2hpbGRWaWV3Q29udGFpbmVyKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuJGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgfQogICAgfQogIH0pOwogIC8vIExheW91dFZpZXcKICAvLyAtLS0tLS0tLS0tCiAgLy8gVXNlZCBmb3IgbWFuYWdpbmcgYXBwbGljYXRpb24gbGF5b3V0Vmlld3MsIG5lc3RlZCBsYXlvdXRWaWV3cyBhbmQKICAvLyBtdWx0aXBsZSByZWdpb25zIHdpdGhpbiBhbiBhcHBsaWNhdGlvbiBvciBzdWItYXBwbGljYXRpb24uCiAgLy8KICAvLyBBIHNwZWNpYWxpemVkIHZpZXcgY2xhc3MgdGhhdCByZW5kZXJzIGFuIGFyZWEgb2YgSFRNTCBhbmQgdGhlbgogIC8vIGF0dGFjaGVzIGBSZWdpb25gIGluc3RhbmNlcyB0byB0aGUgc3BlY2lmaWVkIGByZWdpb25zYC4KICAvLyBVc2VkIGZvciBjb21wb3NpdGUgdmlldyBtYW5hZ2VtZW50IGFuZCBzdWItYXBwbGljYXRpb24gYXJlYXMuCiAgTWFyaW9uZXR0ZS5MYXlvdXRWaWV3ID0gTWFyaW9uZXR0ZS5JdGVtVmlldy5leHRlbmQoewogICAgcmVnaW9uQ2xhc3M6IE1hcmlvbmV0dGUuUmVnaW9uLAogICAgLy8gRW5zdXJlIHRoZSByZWdpb25zIGFyZSBhdmFpbGFibGUgd2hlbiB0aGUgYGluaXRpYWxpemVgIG1ldGhvZAogICAgLy8gaXMgY2FsbGVkLgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLl9maXJzdFJlbmRlciA9IHRydWU7CiAgICAgIHRoaXMuX2luaXRpYWxpemVSZWdpb25zKG9wdGlvbnMpOwogICAgICBNYXJpb25ldHRlLkl0ZW1WaWV3LmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICB9LAogICAgLy8gTGF5b3V0VmlldydzIHJlbmRlciB3aWxsIHVzZSB0aGUgZXhpc3RpbmcgcmVnaW9uIG9iamVjdHMgdGhlCiAgICAvLyBmaXJzdCB0aW1lIGl0IGlzIGNhbGxlZC4gU3Vic2VxdWVudCBjYWxscyB3aWxsIGRlc3Ryb3kgdGhlCiAgICAvLyB2aWV3cyB0aGF0IHRoZSByZWdpb25zIGFyZSBzaG93aW5nIGFuZCB0aGVuIHJlc2V0IHRoZSBgZWxgCiAgICAvLyBmb3IgdGhlIHJlZ2lvbnMgdG8gdGhlIG5ld2x5IHJlbmRlcmVkIERPTSBlbGVtZW50cy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgaWYgKHRoaXMuX2ZpcnN0UmVuZGVyKSB7CiAgICAgICAgLy8gaWYgdGhpcyBpcyB0aGUgZmlyc3QgcmVuZGVyLCBkb24ndCBkbyBhbnl0aGluZyB0bwogICAgICAgIC8vIHJlc2V0IHRoZSByZWdpb25zCiAgICAgICAgdGhpcy5fZmlyc3RSZW5kZXIgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiB0aGlzIGlzIG5vdCB0aGUgZmlyc3QgcmVuZGVyIGNhbGwsIHRoZW4gd2UgbmVlZCB0bwogICAgICAgIC8vIHJlLWluaXRpYWxpemUgdGhlIGBlbGAgZm9yIGVhY2ggcmVnaW9uCiAgICAgICAgdGhpcy5fcmVJbml0aWFsaXplUmVnaW9ucygpOwogICAgICB9CiAgICAgIHJldHVybiBNYXJpb25ldHRlLkl0ZW1WaWV3LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAvLyBIYW5kbGUgZGVzdHJveWluZyByZWdpb25zLCBhbmQgdGhlbiBkZXN0cm95IHRoZSB2aWV3IGl0c2VsZi4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICB0aGlzLnJlZ2lvbk1hbmFnZXIuZGVzdHJveSgpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5JdGVtVmlldy5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEFkZCBhIHNpbmdsZSByZWdpb24sIGJ5IG5hbWUsIHRvIHRoZSBsYXlvdXRWaWV3CiAgICBhZGRSZWdpb246IGZ1bmN0aW9uIChuYW1lLCBkZWZpbml0aW9uKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlZ2lvbjphZGQnLCBuYW1lKTsKICAgICAgdmFyIHJlZ2lvbnMgPSB7fTsKICAgICAgcmVnaW9uc1tuYW1lXSA9IGRlZmluaXRpb247CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlZ2lvbnMocmVnaW9ucylbbmFtZV07CiAgICB9LAogICAgLy8gQWRkIG11bHRpcGxlIHJlZ2lvbnMgYXMgYSB7bmFtZTogZGVmaW5pdGlvbiwgbmFtZTI6IGRlZjJ9IG9iamVjdCBsaXRlcmFsCiAgICBhZGRSZWdpb25zOiBmdW5jdGlvbiAocmVnaW9ucykgewogICAgICB0aGlzLnJlZ2lvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5yZWdpb25zLCByZWdpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkUmVnaW9ucyhyZWdpb25zKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgYSBzaW5nbGUgcmVnaW9uIGZyb20gdGhlIExheW91dFZpZXcsIGJ5IG5hbWUKICAgIHJlbW92ZVJlZ2lvbjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVnaW9uOnJlbW92ZScsIG5hbWUpOwogICAgICBkZWxldGUgdGhpcy5yZWdpb25zW25hbWVdOwogICAgICByZXR1cm4gdGhpcy5yZWdpb25NYW5hZ2VyLnJlbW92ZVJlZ2lvbihuYW1lKTsKICAgIH0sCiAgICAvLyBQcm92aWRlcyBhbHRlcm5hdGl2ZSBhY2Nlc3MgdG8gcmVnaW9ucwogICAgLy8gQWNjZXB0cyB0aGUgcmVnaW9uIG5hbWUKICAgIC8vIGdldFJlZ2lvbignbWFpbicpCiAgICBnZXRSZWdpb246IGZ1bmN0aW9uIChyZWdpb24pIHsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5nZXQocmVnaW9uKTsKICAgIH0sCiAgICAvLyBHZXQgYWxsIHJlZ2lvbnMKICAgIGdldFJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5nZXRSZWdpb25zKCk7CiAgICB9LAogICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIGJ1aWxkIHJlZ2lvbnMKICAgIF9idWlsZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25zKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgdmFyIGRlZmF1bHRzID0gewogICAgICAgIHJlZ2lvbkNsYXNzOiB0aGlzLmdldE9wdGlvbigncmVnaW9uQ2xhc3MnKSwKICAgICAgICBwYXJlbnRFbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuJGVsOwogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5hZGRSZWdpb25zKHJlZ2lvbnMsIGRlZmF1bHRzKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaW5pdGlhbGl6ZSB0aGUgcmVnaW9ucyB0aGF0IGhhdmUgYmVlbiBkZWZpbmVkIGluIGEKICAgIC8vIGByZWdpb25zYCBhdHRyaWJ1dGUgb24gdGhpcyBsYXlvdXRWaWV3LgogICAgX2luaXRpYWxpemVSZWdpb25zOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgcmVnaW9uczsKICAgICAgdGhpcy5faW5pdFJlZ2lvbk1hbmFnZXIoKTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLnJlZ2lvbnMpKSB7CiAgICAgICAgcmVnaW9ucyA9IHRoaXMucmVnaW9ucyhvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWdpb25zID0gdGhpcy5yZWdpb25zIHx8IHt9OwogICAgICB9CiAgICAgIC8vIEVuYWJsZSB1c2VycyB0byBkZWZpbmUgYHJlZ2lvbnNgIGFzIGluc3RhbmNlIG9wdGlvbnMuCiAgICAgIHZhciByZWdpb25PcHRpb25zID0gdGhpcy5nZXRPcHRpb24uY2FsbChvcHRpb25zLCAncmVnaW9ucycpOwogICAgICAvLyBlbmFibGUgcmVnaW9uIG9wdGlvbnMgdG8gYmUgYSBmdW5jdGlvbgogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbk9wdGlvbnMpKSB7CiAgICAgICAgcmVnaW9uT3B0aW9ucyA9IHJlZ2lvbk9wdGlvbnMuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgICAgfQogICAgICBfLmV4dGVuZChyZWdpb25zLCByZWdpb25PcHRpb25zKTsKICAgICAgLy8gTm9ybWFsaXplIHJlZ2lvbiBzZWxlY3RvcnMgaGFzaCB0byBhbGxvdwogICAgICAvLyBhIHVzZXIgdG8gdXNlIHRoZSBAdWkuIHN5bnRheC4KICAgICAgcmVnaW9ucyA9IHRoaXMubm9ybWFsaXplVUlWYWx1ZXMocmVnaW9ucyk7CiAgICAgIHRoaXMuYWRkUmVnaW9ucyhyZWdpb25zKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gcmUtaW5pdGlhbGl6ZSBhbGwgb2YgdGhlIHJlZ2lvbnMgYnkgdXBkYXRpbmcgdGhlIGBlbGAgdGhhdAogICAgLy8gdGhleSBwb2ludCB0bwogICAgX3JlSW5pdGlhbGl6ZVJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5yZWdpb25NYW5hZ2VyLmVtcHR5UmVnaW9ucygpOwogICAgICB0aGlzLnJlZ2lvbk1hbmFnZXIuZWFjaChmdW5jdGlvbiAocmVnaW9uKSB7CiAgICAgICAgcmVnaW9uLnJlc2V0KCk7CiAgICAgIH0pOwogICAgfSwKICAgIC8vIEVuYWJsZSBlYXN5IG92ZXJyaWRpbmcgb2YgdGhlIGRlZmF1bHQgYFJlZ2lvbk1hbmFnZXJgCiAgICAvLyBmb3IgY3VzdG9taXplZCByZWdpb24gaW50ZXJhY3Rpb25zIGFuZCBidXNpbmVzcyBzcGVjaWZpYwogICAgLy8gdmlldyBsb2dpYyBmb3IgYmV0dGVyIGNvbnRyb2wgb3ZlciBzaW5nbGUgcmVnaW9ucy4KICAgIGdldFJlZ2lvbk1hbmFnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG5ldyBNYXJpb25ldHRlLlJlZ2lvbk1hbmFnZXIoKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaW5pdGlhbGl6ZSB0aGUgcmVnaW9uIG1hbmFnZXIKICAgIC8vIGFuZCBhbGwgcmVnaW9ucyBpbiBpdAogICAgX2luaXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMucmVnaW9uTWFuYWdlciA9IHRoaXMuZ2V0UmVnaW9uTWFuYWdlcigpOwogICAgICB0aGlzLmxpc3RlblRvKHRoaXMucmVnaW9uTWFuYWdlciwgJ2JlZm9yZTphZGQ6cmVnaW9uJywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6cmVnaW9uJywgbmFtZSk7CiAgICAgIH0pOwogICAgICB0aGlzLmxpc3RlblRvKHRoaXMucmVnaW9uTWFuYWdlciwgJ2FkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlZ2lvbk1hbmFnZXIsICdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUpOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlZ2lvbk1hbmFnZXIsICdyZW1vdmU6cmVnaW9uJywgZnVuY3Rpb24gKG5hbWUsIHJlZ2lvbikgewogICAgICAgIGRlbGV0ZSB0aGlzW25hbWVdOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgIH0pOwogICAgfQogIH0pOwogIC8vIEJlaGF2aW9yCiAgLy8gLS0tLS0tLS0tLS0KICAvLyBBIEJlaGF2aW9yIGlzIGFuIGlzb2xhdGVkIHNldCBvZiBET00gLwogIC8vIHVzZXIgaW50ZXJhY3Rpb25zIHRoYXQgY2FuIGJlIG1peGVkIGludG8gYW55IFZpZXcuCiAgLy8gQmVoYXZpb3JzIGFsbG93IHlvdSB0byBibGFja2JveCBWaWV3IHNwZWNpZmljIGludGVyYWN0aW9ucwogIC8vIGludG8gcG9ydGFibGUgbG9naWNhbCBjaHVua3MsIGtlZXBpbmcgeW91ciB2aWV3cyBzaW1wbGUgYW5kIHlvdXIgY29kZSBEUlkuCiAgTWFyaW9uZXR0ZS5CZWhhdmlvciA9IGZ1bmN0aW9uIChfLCBCYWNrYm9uZSkgewogICAgZnVuY3Rpb24gQmVoYXZpb3Iob3B0aW9ucywgdmlldykgewogICAgICAvLyBTZXR1cCByZWZlcmVuY2UgdG8gdGhlIHZpZXcuCiAgICAgIC8vIHRoaXMgY29tZXMgaW4gaGFuZGxlIHdoZW4gYSBiZWhhdmlvcgogICAgICAvLyB3YW50cyB0byBkaXJlY3RseSB0YWxrIHVwIHRoZSBjaGFpbgogICAgICAvLyB0byB0aGUgdmlldy4KICAgICAgdGhpcy52aWV3ID0gdmlldzsKICAgICAgdGhpcy5kZWZhdWx0cyA9IF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpIHx8IHt9OwogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5kZWZhdWx0cywgb3B0aW9ucyk7CiAgICAgIC8vIHByb3h5IGJlaGF2aW9yICQgbWV0aG9kIHRvIHRoZSB2aWV3CiAgICAgIC8vIHRoaXMgaXMgdXNlZnVsIGZvciBkb2luZyBqcXVlcnkgRE9NIGxvb2t1cHMKICAgICAgLy8gc2NvcGVkIHRvIGJlaGF2aW9ycyB2aWV3LgogICAgICB0aGlzLiQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy4kLmFwcGx5KHRoaXMudmlldywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgICAgLy8gQ2FsbCB0aGUgaW5pdGlhbGl6ZSBtZXRob2QgcGFzc2luZwogICAgICAvLyB0aGUgYXJndW1lbnRzIGZyb20gdGhlIGluc3RhbmNlIGNvbnN0cnVjdG9yCiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgXy5leHRlbmQoQmVoYXZpb3IucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICB9LAogICAgICAvLyBzdG9wTGlzdGVuaW5nIHRvIGJlaGF2aW9yIGBvbkxpc3RlbmAgZXZlbnRzLgogICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIH0sCiAgICAgIHByb3h5Vmlld1Byb3BlcnRpZXM6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgdGhpcy4kZWwgPSB2aWV3LiRlbDsKICAgICAgICB0aGlzLmVsID0gdmlldy5lbDsKICAgICAgfSwKICAgICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kLAogICAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgYmluZGluZyB2aWV3J3MgZXZlbnRzIGZyb20gYW5vdGhlciBlbnRpdHkuCiAgICAgIGJpbmRFbnRpdHlFdmVudHM6IE1hcmlvbmV0dGUucHJveHlCaW5kRW50aXR5RXZlbnRzLAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgICAgdW5iaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5VW5iaW5kRW50aXR5RXZlbnRzCiAgICB9KTsKICAgIC8vIEJvcnJvdyBCYWNrYm9uZXMgZXh0ZW5kIGltcGxlbWVudGF0aW9uCiAgICAvLyB0aGlzIGFsbG93cyB1cyB0byBzZXR1cCBhIHByb3BlcgogICAgLy8gaW5oZXJpdGFuY2UgcGF0dGVybiB0aGF0IGZvbGxvd3Mgc3VpdAogICAgLy8gd2l0aCB0aGUgcmVzdCBvZiBNYXJpb25ldHRlIHZpZXdzLgogICAgQmVoYXZpb3IuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgICByZXR1cm4gQmVoYXZpb3I7CiAgfShfLCBCYWNrYm9uZSk7CiAgLyoganNoaW50IG1heGxlbjogMTQzICovCiAgLy8gTWFyaW9uZXR0ZS5CZWhhdmlvcnMKICAvLyAtLS0tLS0tLQogIC8vIEJlaGF2aW9ycyBpcyBhIHV0aWxpdHkgY2xhc3MgdGhhdCB0YWtlcyBjYXJlIG9mCiAgLy8gZ2x1aW5nIHlvdXIgYmVoYXZpb3IgaW5zdGFuY2VzIHRvIHRoZWlyIGdpdmVuIFZpZXcuCiAgLy8gVGhlIG1vc3QgaW1wb3J0YW50IHBhcnQgb2YgdGhpcyBjbGFzcyBpcyB0aGF0IHlvdQogIC8vICoqTVVTVCoqIG92ZXJyaWRlIHRoZSBjbGFzcyBsZXZlbCBiZWhhdmlvcnNMb29rdXAKICAvLyBtZXRob2QgZm9yIHRoaW5ncyB0byB3b3JrIHByb3Blcmx5LgogIE1hcmlvbmV0dGUuQmVoYXZpb3JzID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUsIF8pIHsKICAgIGZ1bmN0aW9uIEJlaGF2aW9ycyh2aWV3LCBiZWhhdmlvcnMpIHsKICAgICAgaWYgKCFfLmlzT2JqZWN0KHZpZXcuYmVoYXZpb3JzKSkgewogICAgICAgIHJldHVybiB7fTsKICAgICAgfQogICAgICAvLyBCZWhhdmlvcnMgZGVmaW5lZCBvbiBhIHZpZXcgY2FuIGJlIGEgZmxhdCBvYmplY3QgbGl0ZXJhbAogICAgICAvLyBvciBpdCBjYW4gYmUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0LgogICAgICBiZWhhdmlvcnMgPSBCZWhhdmlvcnMucGFyc2VCZWhhdmlvcnModmlldywgYmVoYXZpb3JzIHx8IF8ucmVzdWx0KHZpZXcsICdiZWhhdmlvcnMnKSk7CiAgICAgIC8vIFdyYXBzIHNldmVyYWwgb2YgdGhlIHZpZXcncyBtZXRob2RzCiAgICAgIC8vIGNhbGxpbmcgdGhlIG1ldGhvZHMgZmlyc3Qgb24gZWFjaCBiZWhhdmlvcgogICAgICAvLyBhbmQgdGhlbiBldmVudHVhbGx5IGNhbGxpbmcgdGhlIG1ldGhvZCBvbiB0aGUgdmlldy4KICAgICAgQmVoYXZpb3JzLndyYXAodmlldywgYmVoYXZpb3JzLCBfLmtleXMobWV0aG9kcykpOwogICAgICByZXR1cm4gYmVoYXZpb3JzOwogICAgfQogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgIGJlaGF2aW9yVHJpZ2dlcnM6IGZ1bmN0aW9uIChiZWhhdmlvclRyaWdnZXJzLCBiZWhhdmlvcnMpIHsKICAgICAgICB2YXIgdHJpZ2dlckJ1aWxkZXIgPSBuZXcgQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIodGhpcywgYmVoYXZpb3JzKTsKICAgICAgICByZXR1cm4gdHJpZ2dlckJ1aWxkZXIuYnVpbGRCZWhhdmlvclRyaWdnZXJzKCk7CiAgICAgIH0sCiAgICAgIGJlaGF2aW9yRXZlbnRzOiBmdW5jdGlvbiAoYmVoYXZpb3JFdmVudHMsIGJlaGF2aW9ycykgewogICAgICAgIHZhciBfYmVoYXZpb3JzRXZlbnRzID0ge307CiAgICAgICAgdmFyIHZpZXdVSSA9IF8ucmVzdWx0KHRoaXMsICd1aScpOwogICAgICAgIF8uZWFjaChiZWhhdmlvcnMsIGZ1bmN0aW9uIChiLCBpKSB7CiAgICAgICAgICB2YXIgX2V2ZW50cyA9IHt9OwogICAgICAgICAgdmFyIGJlaGF2aW9yRXZlbnRzID0gXy5jbG9uZShfLnJlc3VsdChiLCAnZXZlbnRzJykpIHx8IHt9OwogICAgICAgICAgdmFyIGJlaGF2aW9yVUkgPSBfLnJlc3VsdChiLCAndWknKTsKICAgICAgICAgIC8vIENvbnN0cnVjdCBhbiBpbnRlcm5hbCBVSSBoYXNoIGZpcnN0IHVzaW5nCiAgICAgICAgICAvLyB0aGUgdmlld3MgVUkgaGFzaCBhbmQgdGhlbiB0aGUgYmVoYXZpb3JzIFVJIGhhc2guCiAgICAgICAgICAvLyBUaGlzIGFsbG93cyB0aGUgdXNlciB0byB1c2UgVUkgaGFzaCBlbGVtZW50cwogICAgICAgICAgLy8gZGVmaW5lZCBpbiB0aGUgcGFyZW50IHZpZXcgYXMgd2VsbCBhcyB0aG9zZQogICAgICAgICAgLy8gZGVmaW5lZCBpbiB0aGUgZ2l2ZW4gYmVoYXZpb3IuCiAgICAgICAgICB2YXIgdWkgPSBfLmV4dGVuZCh7fSwgdmlld1VJLCBiZWhhdmlvclVJKTsKICAgICAgICAgIC8vIE5vcm1hbGl6ZSBiZWhhdmlvciBldmVudHMgaGFzaCB0byBhbGxvdwogICAgICAgICAgLy8gYSB1c2VyIHRvIHVzZSB0aGUgQHVpLiBzeW50YXguCiAgICAgICAgICBiZWhhdmlvckV2ZW50cyA9IE1hcmlvbmV0dGUubm9ybWFsaXplVUlLZXlzKGJlaGF2aW9yRXZlbnRzLCB1aSk7CiAgICAgICAgICBfLmVhY2goXy5rZXlzKGJlaGF2aW9yRXZlbnRzKSwgZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAvLyBBcHBlbmQgd2hpdGUtc3BhY2UgYXQgdGhlIGVuZCBvZiBlYWNoIGtleSB0byBwcmV2ZW50IGJlaGF2aW9yIGtleSBjb2xsaXNpb25zLgogICAgICAgICAgICAvLyBUaGlzIGlzIHJlbHlpbmcgb24gdGhlIGZhY3QgdGhhdCBiYWNrYm9uZSBldmVudHMgY29uc2lkZXJzICJjbGljayAuZm9vIiB0aGUgc2FtZSBhcwogICAgICAgICAgICAvLyAiY2xpY2sgLmZvbyAiLgogICAgICAgICAgICAvLyArMiBpcyB1c2VkIGJlY2F1c2UgbmV3IEFycmF5KDEpIG9yIDAgaXMgIiIgYW5kIG5vdCAiICIKICAgICAgICAgICAgdmFyIHdoaXRlc3BhY2UgPSBuZXcgQXJyYXkoaSArIDIpLmpvaW4oJyAnKTsKICAgICAgICAgICAgdmFyIGV2ZW50S2V5ID0ga2V5ICsgd2hpdGVzcGFjZTsKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBfLmlzRnVuY3Rpb24oYmVoYXZpb3JFdmVudHNba2V5XSkgPyBiZWhhdmlvckV2ZW50c1trZXldIDogYltiZWhhdmlvckV2ZW50c1trZXldXTsKICAgICAgICAgICAgX2V2ZW50c1tldmVudEtleV0gPSBfLmJpbmQoaGFuZGxlciwgYik7CiAgICAgICAgICB9KTsKICAgICAgICAgIF9iZWhhdmlvcnNFdmVudHMgPSBfLmV4dGVuZChfYmVoYXZpb3JzRXZlbnRzLCBfZXZlbnRzKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gX2JlaGF2aW9yc0V2ZW50czsKICAgICAgfQogICAgfTsKICAgIF8uZXh0ZW5kKEJlaGF2aW9ycywgewogICAgICAvLyBQbGFjZWhvbGRlciBtZXRob2QgdG8gYmUgZXh0ZW5kZWQgYnkgdGhlIHVzZXIuCiAgICAgIC8vIFRoZSBtZXRob2Qgc2hvdWxkIGRlZmluZSB0aGUgb2JqZWN0IHRoYXQgc3RvcmVzIHRoZSBiZWhhdmlvcnMuCiAgICAgIC8vIGkuZS4KICAgICAgLy8KICAgICAgLy8gYGBganMKICAgICAgLy8gTWFyaW9uZXR0ZS5CZWhhdmlvcnMuYmVoYXZpb3JzTG9va3VwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gICByZXR1cm4gQXBwLkJlaGF2aW9ycwogICAgICAvLyB9CiAgICAgIC8vIGBgYAogICAgICBiZWhhdmlvcnNMb29rdXA6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBtZXNzYWdlOiAnWW91IG11c3QgZGVmaW5lIHdoZXJlIHlvdXIgYmVoYXZpb3JzIGFyZSBzdG9yZWQuJywKICAgICAgICAgIHVybDogJ21hcmlvbmV0dGUuYmVoYXZpb3JzLmh0bWwjYmVoYXZpb3JzbG9va3VwJwogICAgICAgIH0pOwogICAgICB9LAogICAgICAvLyBUYWtlcyBjYXJlIG9mIGdldHRpbmcgdGhlIGJlaGF2aW9yIGNsYXNzCiAgICAgIC8vIGdpdmVuIG9wdGlvbnMgYW5kIGEga2V5LgogICAgICAvLyBJZiBhIHVzZXIgcGFzc2VzIGluIG9wdGlvbnMuYmVoYXZpb3JDbGFzcwogICAgICAvLyBkZWZhdWx0IHRvIHVzaW5nIHRoYXQuIE90aGVyd2lzZSBkZWxlZ2F0ZQogICAgICAvLyB0aGUgbG9va3VwIHRvIHRoZSB1c2VycyBgYmVoYXZpb3JzTG9va3VwYCBpbXBsZW1lbnRhdGlvbi4KICAgICAgZ2V0QmVoYXZpb3JDbGFzczogZnVuY3Rpb24gKG9wdGlvbnMsIGtleSkgewogICAgICAgIGlmIChvcHRpb25zLmJlaGF2aW9yQ2xhc3MpIHsKICAgICAgICAgIHJldHVybiBvcHRpb25zLmJlaGF2aW9yQ2xhc3M7CiAgICAgICAgfQogICAgICAgIC8vIEdldCBiZWhhdmlvciBjbGFzcyBjYW4gYmUgZWl0aGVyIGEgZmxhdCBvYmplY3Qgb3IgYSBtZXRob2QKICAgICAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKEJlaGF2aW9ycy5iZWhhdmlvcnNMb29rdXApID8gQmVoYXZpb3JzLmJlaGF2aW9yc0xvb2t1cC5hcHBseSh0aGlzLCBhcmd1bWVudHMpW2tleV0gOiBCZWhhdmlvcnMuYmVoYXZpb3JzTG9va3VwW2tleV07CiAgICAgIH0sCiAgICAgIC8vIEl0ZXJhdGUgb3ZlciB0aGUgYmVoYXZpb3JzIG9iamVjdCwgZm9yIGVhY2ggYmVoYXZpb3IKICAgICAgLy8gaW5zdGFudGlhdGUgaXQgYW5kIGdldCBpdHMgZ3JvdXBlZCBiZWhhdmlvcnMuCiAgICAgIHBhcnNlQmVoYXZpb3JzOiBmdW5jdGlvbiAodmlldywgYmVoYXZpb3JzKSB7CiAgICAgICAgcmV0dXJuIF8uY2hhaW4oYmVoYXZpb3JzKS5tYXAoZnVuY3Rpb24gKG9wdGlvbnMsIGtleSkgewogICAgICAgICAgdmFyIEJlaGF2aW9yQ2xhc3MgPSBCZWhhdmlvcnMuZ2V0QmVoYXZpb3JDbGFzcyhvcHRpb25zLCBrZXkpOwogICAgICAgICAgdmFyIGJlaGF2aW9yID0gbmV3IEJlaGF2aW9yQ2xhc3Mob3B0aW9ucywgdmlldyk7CiAgICAgICAgICB2YXIgbmVzdGVkQmVoYXZpb3JzID0gQmVoYXZpb3JzLnBhcnNlQmVoYXZpb3JzKHZpZXcsIF8ucmVzdWx0KGJlaGF2aW9yLCAnYmVoYXZpb3JzJykpOwogICAgICAgICAgcmV0dXJuIFtiZWhhdmlvcl0uY29uY2F0KG5lc3RlZEJlaGF2aW9ycyk7CiAgICAgICAgfSkuZmxhdHRlbigpLnZhbHVlKCk7CiAgICAgIH0sCiAgICAgIC8vIFdyYXAgdmlldyBpbnRlcm5hbCBtZXRob2RzIHNvIHRoYXQgdGhleSBkZWxlZ2F0ZSB0byBiZWhhdmlvcnMuIEZvciBleGFtcGxlLAogICAgICAvLyBgb25EZXN0cm95YCBzaG91bGQgdHJpZ2dlciBkZXN0cm95IG9uIGFsbCBvZiB0aGUgYmVoYXZpb3JzIGFuZCB0aGVuIGRlc3Ryb3kgaXRzZWxmLgogICAgICAvLyBpLmUuCiAgICAgIC8vCiAgICAgIC8vIGB2aWV3LmRlbGVnYXRlRXZlbnRzID0gXy5wYXJ0aWFsKG1ldGhvZHMuZGVsZWdhdGVFdmVudHMsIHZpZXcuZGVsZWdhdGVFdmVudHMsIGJlaGF2aW9ycyk7YAogICAgICB3cmFwOiBmdW5jdGlvbiAodmlldywgYmVoYXZpb3JzLCBtZXRob2ROYW1lcykgewogICAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHZpZXdbbWV0aG9kTmFtZV0gPSBfLnBhcnRpYWwobWV0aG9kc1ttZXRob2ROYW1lXSwgdmlld1ttZXRob2ROYW1lXSwgYmVoYXZpb3JzKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICAvLyBDbGFzcyB0byBidWlsZCBoYW5kbGVycyBmb3IgYHRyaWdnZXJzYCBvbiBiZWhhdmlvcnMKICAgIC8vIGZvciB2aWV3cwogICAgZnVuY3Rpb24gQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIodmlldywgYmVoYXZpb3JzKSB7CiAgICAgIHRoaXMuX3ZpZXcgPSB2aWV3OwogICAgICB0aGlzLl92aWV3VUkgPSBfLnJlc3VsdCh2aWV3LCAndWknKTsKICAgICAgdGhpcy5fYmVoYXZpb3JzID0gYmVoYXZpb3JzOwogICAgICB0aGlzLl90cmlnZ2VycyA9IHt9OwogICAgfQogICAgXy5leHRlbmQoQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIucHJvdG90eXBlLCB7CiAgICAgIC8vIE1haW4gbWV0aG9kIHRvIGJ1aWxkIHRoZSB0cmlnZ2VycyBoYXNoIHdpdGggZXZlbnQga2V5cyBhbmQgaGFuZGxlcnMKICAgICAgYnVpbGRCZWhhdmlvclRyaWdnZXJzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgdGhpcy5fYnVpbGRUcmlnZ2VySGFuZGxlcnNGb3JCZWhhdmlvciwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3RyaWdnZXJzOwogICAgICB9LAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gYnVpbGQgYWxsIHRyaWdnZXIgaGFuZGxlcnMgZm9yIGEgZ2l2ZW4gYmVoYXZpb3IKICAgICAgX2J1aWxkVHJpZ2dlckhhbmRsZXJzRm9yQmVoYXZpb3I6IGZ1bmN0aW9uIChiZWhhdmlvciwgaSkgewogICAgICAgIHZhciB1aSA9IF8uZXh0ZW5kKHt9LCB0aGlzLl92aWV3VUksIF8ucmVzdWx0KGJlaGF2aW9yLCAndWknKSk7CiAgICAgICAgdmFyIHRyaWdnZXJzSGFzaCA9IF8uY2xvbmUoXy5yZXN1bHQoYmVoYXZpb3IsICd0cmlnZ2VycycpKSB8fCB7fTsKICAgICAgICB0cmlnZ2Vyc0hhc2ggPSBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJS2V5cyh0cmlnZ2Vyc0hhc2gsIHVpKTsKICAgICAgICBfLmVhY2godHJpZ2dlcnNIYXNoLCBfLnBhcnRpYWwodGhpcy5fc2V0SGFuZGxlckZvckJlaGF2aW9yLCBiZWhhdmlvciwgaSksIHRoaXMpOwogICAgICB9LAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGFuZCBhc3NpZ24gdGhlIHRyaWdnZXIgaGFuZGxlciBmb3IgYSBnaXZlbgogICAgICAvLyBiZWhhdmlvcgogICAgICBfc2V0SGFuZGxlckZvckJlaGF2aW9yOiBmdW5jdGlvbiAoYmVoYXZpb3IsIGksIGV2ZW50TmFtZSwgdHJpZ2dlcikgewogICAgICAgIC8vIFVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgYHRoaXMuX3RyaWdnZXJzYCBoYXNoCiAgICAgICAgdmFyIHRyaWdnZXJLZXkgPSB0cmlnZ2VyLnJlcGxhY2UoL15cUysvLCBmdW5jdGlvbiAodHJpZ2dlck5hbWUpIHsKICAgICAgICAgIHJldHVybiB0cmlnZ2VyTmFtZSArICcuJyArICdiZWhhdmlvcnRyaWdnZXJzJyArIGk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5fdHJpZ2dlcnNbdHJpZ2dlcktleV0gPSB0aGlzLl92aWV3Ll9idWlsZFZpZXdUcmlnZ2VyKGV2ZW50TmFtZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIEJlaGF2aW9yczsKICB9KE1hcmlvbmV0dGUsIF8pOwogIC8vIEFwcFJvdXRlcgogIC8vIC0tLS0tLS0tLQogIC8vIFJlZHVjZSB0aGUgYm9pbGVycGxhdGUgY29kZSBvZiBoYW5kbGluZyByb3V0ZSBldmVudHMKICAvLyBhbmQgdGhlbiBjYWxsaW5nIGEgc2luZ2xlIG1ldGhvZCBvbiBhbm90aGVyIG9iamVjdC4KICAvLyBIYXZlIHlvdXIgcm91dGVycyBjb25maWd1cmVkIHRvIGNhbGwgdGhlIG1ldGhvZCBvbgogIC8vIHlvdXIgb2JqZWN0LCBkaXJlY3RseS4KICAvLwogIC8vIENvbmZpZ3VyZSBhbiBBcHBSb3V0ZXIgd2l0aCBgYXBwUm91dGVzYC4KICAvLwogIC8vIEFwcCByb3V0ZXJzIGNhbiBvbmx5IHRha2Ugb25lIGBjb250cm9sbGVyYCBvYmplY3QuCiAgLy8gSXQgaXMgcmVjb21tZW5kZWQgdGhhdCB5b3UgZGl2aWRlIHlvdXIgY29udHJvbGxlcgogIC8vIG9iamVjdHMgaW4gdG8gc21hbGxlciBwaWVjZXMgb2YgcmVsYXRlZCBmdW5jdGlvbmFsaXR5CiAgLy8gYW5kIGhhdmUgbXVsdGlwbGUgcm91dGVycyAvIGNvbnRyb2xsZXJzLCBpbnN0ZWFkIG9mCiAgLy8ganVzdCBvbmUgZ2lhbnQgcm91dGVyIGFuZCBjb250cm9sbGVyLgogIC8vCiAgLy8gWW91IGNhbiBhbHNvIGFkZCBzdGFuZGFyZCByb3V0ZXMgdG8gYW4gQXBwUm91dGVyLgogIE1hcmlvbmV0dGUuQXBwUm91dGVyID0gQmFja2JvbmUuUm91dGVyLmV4dGVuZCh7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuUm91dGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciBhcHBSb3V0ZXMgPSB0aGlzLmdldE9wdGlvbignYXBwUm91dGVzJyk7CiAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5fZ2V0Q29udHJvbGxlcigpOwogICAgICB0aGlzLnByb2Nlc3NBcHBSb3V0ZXMoY29udHJvbGxlciwgYXBwUm91dGVzKTsKICAgICAgdGhpcy5vbigncm91dGUnLCB0aGlzLl9wcm9jZXNzT25Sb3V0ZSwgdGhpcyk7CiAgICB9LAogICAgLy8gU2ltaWxhciB0byByb3V0ZSBtZXRob2Qgb24gYSBCYWNrYm9uZSBSb3V0ZXIgYnV0CiAgICAvLyBtZXRob2QgaXMgY2FsbGVkIG9uIHRoZSBjb250cm9sbGVyCiAgICBhcHBSb3V0ZTogZnVuY3Rpb24gKHJvdXRlLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5fZ2V0Q29udHJvbGxlcigpOwogICAgICB0aGlzLl9hZGRBcHBSb3V0ZShjb250cm9sbGVyLCByb3V0ZSwgbWV0aG9kTmFtZSk7CiAgICB9LAogICAgLy8gcHJvY2VzcyB0aGUgcm91dGUgZXZlbnQgYW5kIHRyaWdnZXIgdGhlIG9uUm91dGUKICAgIC8vIG1ldGhvZCBjYWxsLCBpZiBpdCBleGlzdHMKICAgIF9wcm9jZXNzT25Sb3V0ZTogZnVuY3Rpb24gKHJvdXRlTmFtZSwgcm91dGVBcmdzKSB7CiAgICAgIC8vIGZpbmQgdGhlIHBhdGggdGhhdCBtYXRjaGVkCiAgICAgIHZhciByb3V0ZVBhdGggPSBfLmludmVydCh0aGlzLmdldE9wdGlvbignYXBwUm91dGVzJykpW3JvdXRlTmFtZV07CiAgICAgIC8vIG1ha2Ugc3VyZSBhbiBvblJvdXRlIGlzIHRoZXJlLCBhbmQgY2FsbCBpdAogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMub25Sb3V0ZSkpIHsKICAgICAgICB0aGlzLm9uUm91dGUocm91dGVOYW1lLCByb3V0ZVBhdGgsIHJvdXRlQXJncyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gcHJvY2VzcyB0aGUgYGFwcFJvdXRlc2AgZm9yIHRoZQogICAgLy8gcm91dGVyLCBhbmQgdHVybiB0aGVtIGluIHRvIHJvdXRlcyB0aGF0IHRyaWdnZXIgdGhlCiAgICAvLyBzcGVjaWZpZWQgbWV0aG9kIG9uIHRoZSBzcGVjaWZpZWQgYGNvbnRyb2xsZXJgLgogICAgcHJvY2Vzc0FwcFJvdXRlczogZnVuY3Rpb24gKGNvbnRyb2xsZXIsIGFwcFJvdXRlcykgewogICAgICBpZiAoIWFwcFJvdXRlcykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgcm91dGVOYW1lcyA9IF8ua2V5cyhhcHBSb3V0ZXMpLnJldmVyc2UoKTsKICAgICAgLy8gQmFja2JvbmUgcmVxdWlyZXMgcmV2ZXJ0ZWQgb3JkZXIgb2Ygcm91dGVzCiAgICAgIF8uZWFjaChyb3V0ZU5hbWVzLCBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgICB0aGlzLl9hZGRBcHBSb3V0ZShjb250cm9sbGVyLCByb3V0ZSwgYXBwUm91dGVzW3JvdXRlXSk7CiAgICAgIH0sIHRoaXMpOwogICAgfSwKICAgIF9nZXRDb250cm9sbGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldE9wdGlvbignY29udHJvbGxlcicpOwogICAgfSwKICAgIF9hZGRBcHBSb3V0ZTogZnVuY3Rpb24gKGNvbnRyb2xsZXIsIHJvdXRlLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBtZXRob2QgPSBjb250cm9sbGVyW21ldGhvZE5hbWVdOwogICAgICBpZiAoIW1ldGhvZCkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKCdNZXRob2QgIicgKyBtZXRob2ROYW1lICsgJyIgd2FzIG5vdCBmb3VuZCBvbiB0aGUgY29udHJvbGxlcicpOwogICAgICB9CiAgICAgIHRoaXMucm91dGUocm91dGUsIG1ldGhvZE5hbWUsIF8uYmluZChtZXRob2QsIGNvbnRyb2xsZXIpKTsKICAgIH0sCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIEFwcGxpY2F0aW9uCiAgLy8gLS0tLS0tLS0tLS0KICAvLyBDb250YWluIGFuZCBtYW5hZ2UgdGhlIGNvbXBvc2l0ZSBhcHBsaWNhdGlvbiBhcyBhIHdob2xlLgogIC8vIFN0b3JlcyBhbmQgc3RhcnRzIHVwIGBSZWdpb25gIG9iamVjdHMsIGluY2x1ZGVzIGFuCiAgLy8gZXZlbnQgYWdncmVnYXRvciBhcyBgYXBwLnZlbnRgCiAgTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbiA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy5faW5pdGlhbGl6ZVJlZ2lvbnMob3B0aW9ucyk7CiAgICB0aGlzLl9pbml0Q2FsbGJhY2tzID0gbmV3IE1hcmlvbmV0dGUuQ2FsbGJhY2tzKCk7CiAgICB0aGlzLnN1Ym1vZHVsZXMgPSB7fTsKICAgIF8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgdGhpcy5faW5pdENoYW5uZWwoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbi5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICAvLyBDb21tYW5kIGV4ZWN1dGlvbiwgZmFjaWxpdGF0ZWQgYnkgQmFja2JvbmUuV3JlcXIuQ29tbWFuZHMKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jb21tYW5kcy5leGVjdXRlLmFwcGx5KHRoaXMuY29tbWFuZHMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gUmVxdWVzdC9yZXNwb25zZSwgZmFjaWxpdGF0ZWQgYnkgQmFja2JvbmUuV3JlcXIuUmVxdWVzdFJlc3BvbnNlCiAgICByZXF1ZXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcXJlcy5yZXF1ZXN0LmFwcGx5KHRoaXMucmVxcmVzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEFkZCBhbiBpbml0aWFsaXplciB0aGF0IGlzIGVpdGhlciBydW4gYXQgd2hlbiB0aGUgYHN0YXJ0YAogICAgLy8gbWV0aG9kIGlzIGNhbGxlZCwgb3IgcnVuIGltbWVkaWF0ZWx5IGlmIGFkZGVkIGFmdGVyIGBzdGFydGAKICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gY2FsbGVkLgogICAgYWRkSW5pdGlhbGl6ZXI6IGZ1bmN0aW9uIChpbml0aWFsaXplcikgewogICAgICB0aGlzLl9pbml0Q2FsbGJhY2tzLmFkZChpbml0aWFsaXplcik7CiAgICB9LAogICAgLy8ga2ljayBvZmYgYWxsIG9mIHRoZSBhcHBsaWNhdGlvbidzIHByb2Nlc3Nlcy4KICAgIC8vIGluaXRpYWxpemVzIGFsbCBvZiB0aGUgcmVnaW9ucyB0aGF0IGhhdmUgYmVlbiBhZGRlZAogICAgLy8gdG8gdGhlIGFwcCwgYW5kIHJ1bnMgYWxsIG9mIHRoZSBpbml0aWFsaXplciBmdW5jdGlvbnMKICAgIHN0YXJ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzdGFydCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9pbml0Q2FsbGJhY2tzLnJ1bihvcHRpb25zLCB0aGlzKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzdGFydCcsIG9wdGlvbnMpOwogICAgfSwKICAgIC8vIEFkZCByZWdpb25zIHRvIHlvdXIgYXBwLgogICAgLy8gQWNjZXB0cyBhIGhhc2ggb2YgbmFtZWQgc3RyaW5ncyBvciBSZWdpb24gb2JqZWN0cwogICAgLy8gYWRkUmVnaW9ucyh7c29tZXRoaW5nOiAiI3NvbWVSZWdpb24ifSkKICAgIC8vIGFkZFJlZ2lvbnMoe3NvbWV0aGluZzogUmVnaW9uLmV4dGVuZCh7ZWw6ICIjc29tZVJlZ2lvbiJ9KSB9KTsKICAgIGFkZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmFkZFJlZ2lvbnMocmVnaW9ucyk7CiAgICB9LAogICAgLy8gRW1wdHkgYWxsIHJlZ2lvbnMgaW4gdGhlIGFwcCwgd2l0aG91dCByZW1vdmluZyB0aGVtCiAgICBlbXB0eVJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lvbk1hbmFnZXIuZW1wdHlSZWdpb25zKCk7CiAgICB9LAogICAgLy8gUmVtb3ZlcyBhIHJlZ2lvbiBmcm9tIHlvdXIgYXBwLCBieSBuYW1lCiAgICAvLyBBY2NlcHRzIHRoZSByZWdpb25zIG5hbWUKICAgIC8vIHJlbW92ZVJlZ2lvbignbXlSZWdpb24nKQogICAgcmVtb3ZlUmVnaW9uOiBmdW5jdGlvbiAocmVnaW9uKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLnJlbW92ZVJlZ2lvbihyZWdpb24pOwogICAgfSwKICAgIC8vIFByb3ZpZGVzIGFsdGVybmF0aXZlIGFjY2VzcyB0byByZWdpb25zCiAgICAvLyBBY2NlcHRzIHRoZSByZWdpb24gbmFtZQogICAgLy8gZ2V0UmVnaW9uKCdtYWluJykKICAgIGdldFJlZ2lvbjogZnVuY3Rpb24gKHJlZ2lvbikgewogICAgICByZXR1cm4gdGhpcy5fcmVnaW9uTWFuYWdlci5nZXQocmVnaW9uKTsKICAgIH0sCiAgICAvLyBHZXQgYWxsIHRoZSByZWdpb25zIGZyb20gdGhlIHJlZ2lvbiBtYW5hZ2VyCiAgICBnZXRSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmdldFJlZ2lvbnMoKTsKICAgIH0sCiAgICAvLyBDcmVhdGUgYSBtb2R1bGUsIGF0dGFjaGVkIHRvIHRoZSBhcHBsaWNhdGlvbgogICAgbW9kdWxlOiBmdW5jdGlvbiAobW9kdWxlTmFtZXMsIG1vZHVsZURlZmluaXRpb24pIHsKICAgICAgLy8gT3ZlcndyaXRlIHRoZSBtb2R1bGUgY2xhc3MgaWYgdGhlIHVzZXIgc3BlY2lmaWVzIG9uZQogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSBNYXJpb25ldHRlLk1vZHVsZS5nZXRDbGFzcyhtb2R1bGVEZWZpbml0aW9uKTsKICAgICAgLy8gc2xpY2UgdGhlIGFyZ3MsIGFuZCBhZGQgdGhpcyBhcHBsaWNhdGlvbiBvYmplY3QgYXMgdGhlCiAgICAgIC8vIGZpcnN0IGFyZ3VtZW50IG9mIHRoZSBhcnJheQogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgYXJncy51bnNoaWZ0KHRoaXMpOwogICAgICAvLyBzZWUgdGhlIE1hcmlvbmV0dGUuTW9kdWxlIG9iamVjdCBmb3IgbW9yZSBpbmZvcm1hdGlvbgogICAgICByZXR1cm4gTW9kdWxlQ2xhc3MuY3JlYXRlLmFwcGx5KE1vZHVsZUNsYXNzLCBhcmdzKTsKICAgIH0sCiAgICAvLyBFbmFibGUgZWFzeSBvdmVycmlkaW5nIG9mIHRoZSBkZWZhdWx0IGBSZWdpb25NYW5hZ2VyYAogICAgLy8gZm9yIGN1c3RvbWl6ZWQgcmVnaW9uIGludGVyYWN0aW9ucyBhbmQgYnVzaW5lc3Mtc3BlY2lmaWMKICAgIC8vIHZpZXcgbG9naWMgZm9yIGJldHRlciBjb250cm9sIG92ZXIgc2luZ2xlIHJlZ2lvbnMuCiAgICBnZXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyKCk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGluaXRpYWxpemUgdGhlIHJlZ2lvbnMgdGhhdCBoYXZlIGJlZW4gZGVmaW5lZCBpbiBhCiAgICAvLyBgcmVnaW9uc2AgYXR0cmlidXRlIG9uIHRoZSBhcHBsaWNhdGlvbiBpbnN0YW5jZQogICAgX2luaXRpYWxpemVSZWdpb25zOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgcmVnaW9ucyA9IF8uaXNGdW5jdGlvbih0aGlzLnJlZ2lvbnMpID8gdGhpcy5yZWdpb25zKG9wdGlvbnMpIDogdGhpcy5yZWdpb25zIHx8IHt9OwogICAgICB0aGlzLl9pbml0UmVnaW9uTWFuYWdlcigpOwogICAgICAvLyBFbmFibGUgdXNlcnMgdG8gZGVmaW5lIGByZWdpb25zYCBpbiBpbnN0YW5jZSBvcHRpb25zLgogICAgICB2YXIgb3B0aW9uUmVnaW9ucyA9IE1hcmlvbmV0dGUuZ2V0T3B0aW9uKG9wdGlvbnMsICdyZWdpb25zJyk7CiAgICAgIC8vIEVuYWJsZSByZWdpb24gb3B0aW9ucyB0byBiZSBhIGZ1bmN0aW9uCiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob3B0aW9uUmVnaW9ucykpIHsKICAgICAgICBvcHRpb25SZWdpb25zID0gb3B0aW9uUmVnaW9ucy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIC8vIE92ZXJ3cml0ZSBjdXJyZW50IHJlZ2lvbnMgd2l0aCB0aG9zZSBwYXNzZWQgaW4gb3B0aW9ucwogICAgICBfLmV4dGVuZChyZWdpb25zLCBvcHRpb25SZWdpb25zKTsKICAgICAgdGhpcy5hZGRSZWdpb25zKHJlZ2lvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V0IHVwIHRoZSByZWdpb24gbWFuYWdlcgogICAgX2luaXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3JlZ2lvbk1hbmFnZXIgPSB0aGlzLmdldFJlZ2lvbk1hbmFnZXIoKTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOmFkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmFkZDpyZWdpb24nLCBuYW1lKTsKICAgICAgfSk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5fcmVnaW9uTWFuYWdlciwgJ2FkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBuYW1lKTsKICAgICAgfSk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5fcmVnaW9uTWFuYWdlciwgJ3JlbW92ZTpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgZGVsZXRlIHRoaXNbbmFtZV07CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6cmVnaW9uJywgbmFtZSwgcmVnaW9uKTsKICAgICAgfSk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNldHVwIHRoZSBXcmVxci5yYWRpbyBjaGFubmVsCiAgICBfaW5pdENoYW5uZWw6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jaGFubmVsTmFtZSA9IF8ucmVzdWx0KHRoaXMsICdjaGFubmVsTmFtZScpIHx8ICdnbG9iYWwnOwogICAgICB0aGlzLmNoYW5uZWwgPSBfLnJlc3VsdCh0aGlzLCAnY2hhbm5lbCcpIHx8IEJhY2tib25lLldyZXFyLnJhZGlvLmNoYW5uZWwodGhpcy5jaGFubmVsTmFtZSk7CiAgICAgIHRoaXMudmVudCA9IF8ucmVzdWx0KHRoaXMsICd2ZW50JykgfHwgdGhpcy5jaGFubmVsLnZlbnQ7CiAgICAgIHRoaXMuY29tbWFuZHMgPSBfLnJlc3VsdCh0aGlzLCAnY29tbWFuZHMnKSB8fCB0aGlzLmNoYW5uZWwuY29tbWFuZHM7CiAgICAgIHRoaXMucmVxcmVzID0gXy5yZXN1bHQodGhpcywgJ3JlcXJlcycpIHx8IHRoaXMuY2hhbm5lbC5yZXFyZXM7CiAgICB9LAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIENvcHkgdGhlIGBleHRlbmRgIGZ1bmN0aW9uIHVzZWQgYnkgQmFja2JvbmUncyBjbGFzc2VzCiAgTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbi5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA5ICovCiAgLy8gTW9kdWxlCiAgLy8gLS0tLS0tCiAgLy8gQSBzaW1wbGUgbW9kdWxlIHN5c3RlbSwgdXNlZCB0byBjcmVhdGUgcHJpdmFjeSBhbmQgZW5jYXBzdWxhdGlvbiBpbgogIC8vIE1hcmlvbmV0dGUgYXBwbGljYXRpb25zCiAgTWFyaW9uZXR0ZS5Nb2R1bGUgPSBmdW5jdGlvbiAobW9kdWxlTmFtZSwgYXBwLCBvcHRpb25zKSB7CiAgICB0aGlzLm1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lOwogICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CiAgICAvLyBBbGxvdyBmb3IgYSB1c2VyIHRvIG92ZXJpZGUgdGhlIGluaXRpYWxpemUKICAgIC8vIGZvciBhIGdpdmVuIG1vZHVsZSBpbnN0YW5jZS4KICAgIHRoaXMuaW5pdGlhbGl6ZSA9IG9wdGlvbnMuaW5pdGlhbGl6ZSB8fCB0aGlzLmluaXRpYWxpemU7CiAgICAvLyBTZXQgdXAgYW4gaW50ZXJuYWwgc3RvcmUgZm9yIHN1Yi1tb2R1bGVzLgogICAgdGhpcy5zdWJtb2R1bGVzID0ge307CiAgICB0aGlzLl9zZXR1cEluaXRpYWxpemVyc0FuZEZpbmFsaXplcnMoKTsKICAgIC8vIFNldCBhbiBpbnRlcm5hbCByZWZlcmVuY2UgdG8gdGhlIGFwcAogICAgLy8gd2l0aGluIGEgbW9kdWxlLgogICAgdGhpcy5hcHAgPSBhcHA7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgdGhpcy5pbml0aWFsaXplKG1vZHVsZU5hbWUsIGFwcCwgdGhpcy5vcHRpb25zKTsKICAgIH0KICB9OwogIE1hcmlvbmV0dGUuTW9kdWxlLmV4dGVuZCA9IE1hcmlvbmV0dGUuZXh0ZW5kOwogIC8vIEV4dGVuZCB0aGUgTW9kdWxlIHByb3RvdHlwZSB3aXRoIGV2ZW50cyAvIGxpc3RlblRvLCBzbyB0aGF0IHRoZSBtb2R1bGUKICAvLyBjYW4gYmUgdXNlZCBhcyBhbiBldmVudCBhZ2dyZWdhdG9yIG9yIHB1Yi9zdWIuCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5Nb2R1bGUucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgIC8vIEJ5IGRlZmF1bHQgbW9kdWxlcyBzdGFydCB3aXRoIHRoZWlyIHBhcmVudHMuCiAgICBzdGFydFdpdGhQYXJlbnQ6IHRydWUsCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljIHdoZW4gZXh0ZW5kaW5nIE1hcmlvbmV0dGUuTW9kdWxlLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgfSwKICAgIC8vIEluaXRpYWxpemVyIGZvciBhIHNwZWNpZmljIG1vZHVsZS4gSW5pdGlhbGl6ZXJzIGFyZSBydW4gd2hlbiB0aGUKICAgIC8vIG1vZHVsZSdzIGBzdGFydGAgbWV0aG9kIGlzIGNhbGxlZC4KICAgIGFkZEluaXRpYWxpemVyOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgdGhpcy5faW5pdGlhbGl6ZXJDYWxsYmFja3MuYWRkKGNhbGxiYWNrKTsKICAgIH0sCiAgICAvLyBGaW5hbGl6ZXJzIGFyZSBydW4gd2hlbiBhIG1vZHVsZSBpcyBzdG9wcGVkLiBUaGV5IGFyZSB1c2VkIHRvIHRlYXJkb3duCiAgICAvLyBhbmQgZmluYWxpemUgYW55IHZhcmlhYmxlcywgcmVmZXJlbmNlcywgZXZlbnRzIGFuZCBvdGhlciBjb2RlIHRoYXQgdGhlCiAgICAvLyBtb2R1bGUgaGFkIHNldCB1cC4KICAgIGFkZEZpbmFsaXplcjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5hZGQoY2FsbGJhY2spOwogICAgfSwKICAgIC8vIFN0YXJ0IHRoZSBtb2R1bGUsIGFuZCBydW4gYWxsIG9mIGl0cyBpbml0aWFsaXplcnMKICAgIHN0YXJ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAvLyBQcmV2ZW50IHJlLXN0YXJ0aW5nIGEgbW9kdWxlIHRoYXQgaXMgYWxyZWFkeSBzdGFydGVkCiAgICAgIGlmICh0aGlzLl9pc0luaXRpYWxpemVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIHN0YXJ0IHRoZSBzdWItbW9kdWxlcyAoZGVwdGgtZmlyc3QgaGllcmFyY2h5KQogICAgICBfLmVhY2godGhpcy5zdWJtb2R1bGVzLCBmdW5jdGlvbiAobW9kKSB7CiAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHdlIHNob3VsZCBzdGFydCB0aGUgc3ViLW1vZHVsZSB3aXRoIHRoaXMgcGFyZW50CiAgICAgICAgaWYgKG1vZC5zdGFydFdpdGhQYXJlbnQpIHsKICAgICAgICAgIG1vZC5zdGFydChvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBydW4gdGhlIGNhbGxiYWNrcyB0byAic3RhcnQiIHRoZSBjdXJyZW50IG1vZHVsZQogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzdGFydCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcy5ydW4ob3B0aW9ucywgdGhpcyk7CiAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N0YXJ0Jywgb3B0aW9ucyk7CiAgICB9LAogICAgLy8gU3RvcCB0aGlzIG1vZHVsZSBieSBydW5uaW5nIGl0cyBmaW5hbGl6ZXJzIGFuZCB0aGVuIHN0b3AgYWxsIG9mCiAgICAvLyB0aGUgc3ViLW1vZHVsZXMgZm9yIHRoaXMgbW9kdWxlCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIGlmIHdlIGFyZSBub3QgaW5pdGlhbGl6ZWQsIGRvbid0IGJvdGhlciBmaW5hbGl6aW5nCiAgICAgIGlmICghdGhpcy5faXNJbml0aWFsaXplZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLl9pc0luaXRpYWxpemVkID0gZmFsc2U7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN0b3AnKTsKICAgICAgLy8gc3RvcCB0aGUgc3ViLW1vZHVsZXM7IGRlcHRoLWZpcnN0LCB0byBtYWtlIHN1cmUgdGhlCiAgICAgIC8vIHN1Yi1tb2R1bGVzIGFyZSBzdG9wcGVkIC8gZmluYWxpemVkIGJlZm9yZSBwYXJlbnRzCiAgICAgIF8uZWFjaCh0aGlzLnN1Ym1vZHVsZXMsIGZ1bmN0aW9uIChtb2QpIHsKICAgICAgICBtb2Quc3RvcCgpOwogICAgICB9KTsKICAgICAgLy8gcnVuIHRoZSBmaW5hbGl6ZXJzCiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5ydW4odW5kZWZpbmVkLCB0aGlzKTsKICAgICAgLy8gcmVzZXQgdGhlIGluaXRpYWxpemVycyBhbmQgZmluYWxpemVycwogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcy5yZXNldCgpOwogICAgICB0aGlzLl9maW5hbGl6ZXJDYWxsYmFja3MucmVzZXQoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzdG9wJyk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlIHRoZSBtb2R1bGUgd2l0aCBhIGRlZmluaXRpb24gZnVuY3Rpb24gYW5kIGFueSBjdXN0b20gYXJncwogICAgLy8gdGhhdCBhcmUgdG8gYmUgcGFzc2VkIGluIHRvIHRoZSBkZWZpbml0aW9uIGZ1bmN0aW9uCiAgICBhZGREZWZpbml0aW9uOiBmdW5jdGlvbiAobW9kdWxlRGVmaW5pdGlvbiwgY3VzdG9tQXJncykgewogICAgICB0aGlzLl9ydW5Nb2R1bGVEZWZpbml0aW9uKG1vZHVsZURlZmluaXRpb24sIGN1c3RvbUFyZ3MpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZDogcnVuIHRoZSBtb2R1bGUgZGVmaW5pdGlvbiBmdW5jdGlvbiB3aXRoIHRoZSBjb3JyZWN0CiAgICAvLyBhcmd1bWVudHMKICAgIF9ydW5Nb2R1bGVEZWZpbml0aW9uOiBmdW5jdGlvbiAoZGVmaW5pdGlvbiwgY3VzdG9tQXJncykgewogICAgICAvLyBJZiB0aGVyZSBpcyBubyBkZWZpbml0aW9uIHNob3J0IGNpcmN1dCB0aGUgbWV0aG9kLgogICAgICBpZiAoIWRlZmluaXRpb24pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gYnVpbGQgdGhlIGNvcnJlY3QgbGlzdCBvZiBhcmd1bWVudHMgZm9yIHRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICB2YXIgYXJncyA9IF8uZmxhdHRlbihbCiAgICAgICAgdGhpcywKICAgICAgICB0aGlzLmFwcCwKICAgICAgICBCYWNrYm9uZSwKICAgICAgICBNYXJpb25ldHRlLAogICAgICAgIEJhY2tib25lLiQsCiAgICAgICAgXywKICAgICAgICBjdXN0b21BcmdzCiAgICAgIF0pOwogICAgICBkZWZpbml0aW9uLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZDogc2V0IHVwIG5ldyBjb3BpZXMgb2YgaW5pdGlhbGl6ZXJzIGFuZCBmaW5hbGl6ZXJzLgogICAgLy8gQ2FsbGluZyB0aGlzIG1ldGhvZCB3aWxsIHdpcGUgb3V0IGFsbCBleGlzdGluZyBpbml0aWFsaXplcnMgYW5kCiAgICAvLyBmaW5hbGl6ZXJzLgogICAgX3NldHVwSW5pdGlhbGl6ZXJzQW5kRmluYWxpemVyczogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcyA9IG5ldyBNYXJpb25ldHRlLkNhbGxiYWNrcygpOwogICAgICB0aGlzLl9maW5hbGl6ZXJDYWxsYmFja3MgPSBuZXcgTWFyaW9uZXR0ZS5DYWxsYmFja3MoKTsKICAgIH0sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZAogIH0pOwogIC8vIENsYXNzIG1ldGhvZHMgdG8gY3JlYXRlIG1vZHVsZXMKICBfLmV4dGVuZChNYXJpb25ldHRlLk1vZHVsZSwgewogICAgLy8gQ3JlYXRlIGEgbW9kdWxlLCBoYW5naW5nIG9mZiB0aGUgYXBwIHBhcmFtZXRlciBhcyB0aGUgcGFyZW50IG9iamVjdC4KICAgIGNyZWF0ZTogZnVuY3Rpb24gKGFwcCwgbW9kdWxlTmFtZXMsIG1vZHVsZURlZmluaXRpb24pIHsKICAgICAgdmFyIG1vZHVsZSA9IGFwcDsKICAgICAgLy8gZ2V0IHRoZSBjdXN0b20gYXJncyBwYXNzZWQgaW4gYWZ0ZXIgdGhlIG1vZHVsZSBkZWZpbml0aW9uIGFuZAogICAgICAvLyBnZXQgcmlkIG9mIHRoZSBtb2R1bGUgbmFtZSBhbmQgZGVmaW5pdGlvbiBmdW5jdGlvbgogICAgICB2YXIgY3VzdG9tQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgY3VzdG9tQXJncy5zcGxpY2UoMCwgMyk7CiAgICAgIC8vIFNwbGl0IHRoZSBtb2R1bGUgbmFtZXMgYW5kIGdldCB0aGUgbnVtYmVyIG9mIHN1Ym1vZHVsZXMuCiAgICAgIC8vIGkuZS4gYW4gZXhhbXBsZSBtb2R1bGUgbmFtZSBvZiBgRG9nZS5Xb3cuQW1hemVgIHdvdWxkCiAgICAgIC8vIHRoZW4gaGF2ZSB0aGUgcG90ZW50aWFsIGZvciAzIG1vZHVsZSBkZWZpbml0aW9ucy4KICAgICAgbW9kdWxlTmFtZXMgPSBtb2R1bGVOYW1lcy5zcGxpdCgnLicpOwogICAgICB2YXIgbGVuZ3RoID0gbW9kdWxlTmFtZXMubGVuZ3RoOwogICAgICAvLyBzdG9yZSB0aGUgbW9kdWxlIGRlZmluaXRpb24gZm9yIHRoZSBsYXN0IG1vZHVsZSBpbiB0aGUgY2hhaW4KICAgICAgdmFyIG1vZHVsZURlZmluaXRpb25zID0gW107CiAgICAgIG1vZHVsZURlZmluaXRpb25zW2xlbmd0aCAtIDFdID0gbW9kdWxlRGVmaW5pdGlvbjsKICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGFydHMgb2YgdGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgIF8uZWFjaChtb2R1bGVOYW1lcywgZnVuY3Rpb24gKG1vZHVsZU5hbWUsIGkpIHsKICAgICAgICB2YXIgcGFyZW50TW9kdWxlID0gbW9kdWxlOwogICAgICAgIG1vZHVsZSA9IHRoaXMuX2dldE1vZHVsZShwYXJlbnRNb2R1bGUsIG1vZHVsZU5hbWUsIGFwcCwgbW9kdWxlRGVmaW5pdGlvbik7CiAgICAgICAgdGhpcy5fYWRkTW9kdWxlRGVmaW5pdGlvbihwYXJlbnRNb2R1bGUsIG1vZHVsZSwgbW9kdWxlRGVmaW5pdGlvbnNbaV0sIGN1c3RvbUFyZ3MpOwogICAgICB9LCB0aGlzKTsKICAgICAgLy8gUmV0dXJuIHRoZSBsYXN0IG1vZHVsZSBpbiB0aGUgZGVmaW5pdGlvbiBjaGFpbgogICAgICByZXR1cm4gbW9kdWxlOwogICAgfSwKICAgIF9nZXRNb2R1bGU6IGZ1bmN0aW9uIChwYXJlbnRNb2R1bGUsIG1vZHVsZU5hbWUsIGFwcCwgZGVmLCBhcmdzKSB7CiAgICAgIHZhciBvcHRpb25zID0gXy5leHRlbmQoe30sIGRlZik7CiAgICAgIHZhciBNb2R1bGVDbGFzcyA9IHRoaXMuZ2V0Q2xhc3MoZGVmKTsKICAgICAgLy8gR2V0IGFuIGV4aXN0aW5nIG1vZHVsZSBvZiB0aGlzIG5hbWUgaWYgd2UgaGF2ZSBvbmUKICAgICAgdmFyIG1vZHVsZSA9IHBhcmVudE1vZHVsZVttb2R1bGVOYW1lXTsKICAgICAgaWYgKCFtb2R1bGUpIHsKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIGlmIHdlIGRvbid0IGhhdmUgb25lCiAgICAgICAgbW9kdWxlID0gbmV3IE1vZHVsZUNsYXNzKG1vZHVsZU5hbWUsIGFwcCwgb3B0aW9ucyk7CiAgICAgICAgcGFyZW50TW9kdWxlW21vZHVsZU5hbWVdID0gbW9kdWxlOwogICAgICAgIC8vIHN0b3JlIHRoZSBtb2R1bGUgb24gdGhlIHBhcmVudAogICAgICAgIHBhcmVudE1vZHVsZS5zdWJtb2R1bGVzW21vZHVsZU5hbWVdID0gbW9kdWxlOwogICAgICB9CiAgICAgIHJldHVybiBtb2R1bGU7CiAgICB9LAogICAgLy8gIyMgTW9kdWxlIENsYXNzZXMKICAgIC8vCiAgICAvLyBNb2R1bGUgY2xhc3NlcyBjYW4gYmUgdXNlZCBhcyBhbiBhbHRlcm5hdGl2ZSB0byB0aGUgZGVmaW5lIHBhdHRlcm4uCiAgICAvLyBUaGUgZXh0ZW5kIGZ1bmN0aW9uIG9mIGEgTW9kdWxlIGlzIGlkZW50aWNhbCB0byB0aGUgZXh0ZW5kIGZ1bmN0aW9ucwogICAgLy8gb24gb3RoZXIgQmFja2JvbmUgYW5kIE1hcmlvbmV0dGUgY2xhc3Nlcy4KICAgIC8vIFRoaXMgYWxsb3dzIG1vZHVsZSBsaWZlY3lsZSBldmVudHMgbGlrZSBgb25TdGFydGAgYW5kIGBvblN0b3BgIHRvIGJlIGNhbGxlZCBkaXJlY3RseS4KICAgIGdldENsYXNzOiBmdW5jdGlvbiAobW9kdWxlRGVmaW5pdGlvbikgewogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSBNYXJpb25ldHRlLk1vZHVsZTsKICAgICAgaWYgKCFtb2R1bGVEZWZpbml0aW9uKSB7CiAgICAgICAgcmV0dXJuIE1vZHVsZUNsYXNzOwogICAgICB9CiAgICAgIC8vIElmIGFsbCBvZiB0aGUgbW9kdWxlJ3MgZnVuY3Rpb25hbGl0eSBpcyBkZWZpbmVkIGluc2lkZSBpdHMgY2xhc3MsCiAgICAgIC8vIHRoZW4gdGhlIGNsYXNzIGNhbiBiZSBwYXNzZWQgaW4gZGlyZWN0bHkuIGBNeUFwcC5tb2R1bGUoIkZvbyIsIEZvb01vZHVsZSlgLgogICAgICBpZiAobW9kdWxlRGVmaW5pdGlvbi5wcm90b3R5cGUgaW5zdGFuY2VvZiBNb2R1bGVDbGFzcykgewogICAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uOwogICAgICB9CiAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uLm1vZHVsZUNsYXNzIHx8IE1vZHVsZUNsYXNzOwogICAgfSwKICAgIC8vIEFkZCB0aGUgbW9kdWxlIGRlZmluaXRpb24gYW5kIGFkZCBhIHN0YXJ0V2l0aFBhcmVudCBpbml0aWFsaXplciBmdW5jdGlvbi4KICAgIC8vIFRoaXMgaXMgY29tcGxpY2F0ZWQgYmVjYXVzZSBtb2R1bGUgZGVmaW5pdGlvbnMgYXJlIGhlYXZpbHkgb3ZlcmxvYWRlZAogICAgLy8gYW5kIHN1cHBvcnQgYW4gYW5vbnltb3VzIGZ1bmN0aW9uLCBtb2R1bGUgY2xhc3MsIG9yIG9wdGlvbnMgb2JqZWN0CiAgICBfYWRkTW9kdWxlRGVmaW5pdGlvbjogZnVuY3Rpb24gKHBhcmVudE1vZHVsZSwgbW9kdWxlLCBkZWYsIGFyZ3MpIHsKICAgICAgdmFyIGZuID0gdGhpcy5fZ2V0RGVmaW5lKGRlZik7CiAgICAgIHZhciBzdGFydFdpdGhQYXJlbnQgPSB0aGlzLl9nZXRTdGFydFdpdGhQYXJlbnQoZGVmLCBtb2R1bGUpOwogICAgICBpZiAoZm4pIHsKICAgICAgICBtb2R1bGUuYWRkRGVmaW5pdGlvbihmbiwgYXJncyk7CiAgICAgIH0KICAgICAgdGhpcy5fYWRkU3RhcnRXaXRoUGFyZW50KHBhcmVudE1vZHVsZSwgbW9kdWxlLCBzdGFydFdpdGhQYXJlbnQpOwogICAgfSwKICAgIF9nZXRTdGFydFdpdGhQYXJlbnQ6IGZ1bmN0aW9uIChkZWYsIG1vZHVsZSkgewogICAgICB2YXIgc3dwOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGRlZikgJiYgZGVmLnByb3RvdHlwZSBpbnN0YW5jZW9mIE1hcmlvbmV0dGUuTW9kdWxlKSB7CiAgICAgICAgc3dwID0gbW9kdWxlLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAgICAgaWYgKF8uaXNPYmplY3QoZGVmKSkgewogICAgICAgIHN3cCA9IGRlZi5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgX2dldERlZmluZTogZnVuY3Rpb24gKGRlZikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGRlZikgJiYgIShkZWYucHJvdG90eXBlIGluc3RhbmNlb2YgTWFyaW9uZXR0ZS5Nb2R1bGUpKSB7CiAgICAgICAgcmV0dXJuIGRlZjsKICAgICAgfQogICAgICBpZiAoXy5pc09iamVjdChkZWYpKSB7CiAgICAgICAgcmV0dXJuIGRlZi5kZWZpbmU7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAogICAgX2FkZFN0YXJ0V2l0aFBhcmVudDogZnVuY3Rpb24gKHBhcmVudE1vZHVsZSwgbW9kdWxlLCBzdGFydFdpdGhQYXJlbnQpIHsKICAgICAgbW9kdWxlLnN0YXJ0V2l0aFBhcmVudCA9IG1vZHVsZS5zdGFydFdpdGhQYXJlbnQgJiYgc3RhcnRXaXRoUGFyZW50OwogICAgICBpZiAoIW1vZHVsZS5zdGFydFdpdGhQYXJlbnQgfHwgISFtb2R1bGUuc3RhcnRXaXRoUGFyZW50SXNDb25maWd1cmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIG1vZHVsZS5zdGFydFdpdGhQYXJlbnRJc0NvbmZpZ3VyZWQgPSB0cnVlOwogICAgICBwYXJlbnRNb2R1bGUuYWRkSW5pdGlhbGl6ZXIoZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICBpZiAobW9kdWxlLnN0YXJ0V2l0aFBhcmVudCkgewogICAgICAgICAgbW9kdWxlLnN0YXJ0KG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIE1hcmlvbmV0dGU7Cn0pKTsKLyohCiAqIGl0ZW1WaWV3LmpzCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQKICovCml0ZW1WaWV3ID0gZnVuY3Rpb24gKF8sIE1hcmlvbmV0dGUpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEl0ZW1WaWV3CiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICByZXR1cm4gTWFyaW9uZXR0ZS5JdGVtVmlldy5leHRlbmQoewogICAgLy8gTGF5b3V0cyBoYXZlIG5vIGltbWVkaWF0ZSB0ZW1wbGF0ZQogICAgdGVtcGxhdGU6IGZhbHNlCiAgfSk7Cn0odW5kZXJzY29yZSwgYmFja2JvbmVtYXJpb25ldHRlKTsKLyohCiAqIGl0ZW1Db250cm9sbGVyLmpzCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQKICovCml0ZW1Db250cm9sbGVyID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUsIEl0ZW1WaWV3KSB7CiAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJdGVtQ29udHJvbGxlcgogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgcmV0dXJuIE1hcmlvbmV0dGUuQ29udHJvbGxlci5leHRlbmQoewogICAgLy8gRGVmYXVsdCBMYXlvdXRWSWV3CiAgICBWaWV3OiBJdGVtVmlldywKICAgIC8qKgogICAgICogQmFzZSBpdGVtQ29udHJvbGxlci4gU2V0cyB1cCBDb250cm9sbGVyIFZpZXcuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIHZhciBjb250cm9sbGVyID0gbmV3IEl0ZW1Db250cm9sbGVyKHsKICAgICAqICAgVmlldzogSXRlbVZpZXcKICAgICAqIH0pOwogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHB1YmxpYwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgLy8gU2V0dXAgb3VyIGl0ZW1Db250cm9sbGVyCiAgICAgIHRoaXMuc2V0dXAob3B0aW9ucyk7CiAgICAgIC8vIEluaXRsaWF6ZSB5byEKICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLmluaXRpYWxpemUpKSB7CiAgICAgICAgdGhpcy5pbml0aWFsaXplKHRoaXMub3B0aW9ucyk7CiAgICAgIH0KICAgIH0sCiAgICAvKioKICAgICAqIEJyZWFraW5nIHNldHVwIG91dCBzbyBpdCBjYW4gYmUgY2FsbGVkCiAgICAgKiBieSBhbnkgY29udHJvbGxlcnMgdGhhdCB3YW50IHRvIHVzZSB0aGlzCiAgICAgKiBhcyBhIHN1cGVyLiBPdGhlcndpc2UgaW5pdGlhbGl6ZSB3aWxsIGJlCiAgICAgKiBjYWxsZWQKICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBzZXR1cDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgLy8gU2V0IG9wdGlvbnMgaW5zdGFuY2Ugb3B0aW9ucwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAvLyBHZXQgdmFyIG9yIHRocm93IGVycm9yCiAgICAgIHRoaXMuVmlldyA9IHRoaXMucmVxdWlyZWQoJ1ZpZXcnKTsKICAgICAgLy8gUmVuZGVyIHlvIQogICAgICB0aGlzLnZpZXcgPSBuZXcgdGhpcy5WaWV3KHRoaXMuZ2V0T3B0aW9uKCd2aWV3T3B0aW9ucycpIHx8IHt9KTsKICAgIH0sCiAgICAvKioKICAgICAqIE1ha2Ugc3VyZSBwcm9wIGlzIGRlZmluZWQgb24gb3VyIGluc3RhbmNlIG9yCiAgICAgKiBpbiBvdXIgaW5zdGFuY2Ugb3B0aW9ucyBvYmplY3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIE5hbWUgb2YgcHJvcGVydHkgd2UgYXJlIGNoZWNraW5nCiAgICAgKiAgIGV4aXN0YW5jZSBvZi4KICAgICAqLwogICAgcmVxdWlyZWQ6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHZhciB2YWwgPSB0aGlzLmdldE9wdGlvbihuYW1lKTsKICAgICAgaWYgKCF2YWwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVpcmVzICInICsgbmFtZSArICciIHRvIGJlIGRlZmluZWQuJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbDsKICAgIH0sCiAgICAvKioKICAgICAqIENvbnZlbmNpZW5jZSB3cmFwcGVyIGFyb3VuZCBNYXJpb25ldHRlLmdldE9wdGlvbiBzbwogICAgICogdGhhdCBpdCBkb2VzIG5vdCBuZWVkIHRvIGJlIHJlcXVpcmVkIGluIGVhY2ggc3ViIGNsYXNzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGdldE9wdGlvbjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuZ2V0T3B0aW9uKHRoaXMsIG5hbWUpOwogICAgfQogIH0pOwp9KGJhY2tib25lbWFyaW9uZXR0ZSwgaXRlbVZpZXcpOwovKiEKICogbGF5b3V0Vmlldy5qcwogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0CiAqLwpsYXlvdXRWaWV3ID0gZnVuY3Rpb24gKF8sIE1hcmlvbmV0dGUpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIExheW91dFZpZXcKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIC8qKgogICAqIExheW91dFZpZXcgdGhhdCBkeW5hbWljYWxseSBjcmVhdGVzIGFuZCBhcHBlbmRzIHJlZ2lvbnMuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIHZhciB2aWV3ID0gbmV3IExheW91dFZpZXcoKTsKICAgKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwdWJsaWMKICAgKi8KICByZXR1cm4gTWFyaW9uZXR0ZS5MYXlvdXRWaWV3LmV4dGVuZCh7CiAgICAvLyBMYXlvdXRzIGhhdmUgbm8gaW1tZWRpYXRlIHRlbXBsYXRlCiAgICB0ZW1wbGF0ZTogZmFsc2UsCiAgICAvKioKICAgICAqIEFkZCByZWdpb25zIHRvIHRoZSB2aWV3IGJ5IHRlbXBsYXRpbmcgYW5kIGF0dGFjaGluZwogICAgICogYSBuZXcgcmVnaW9uIGhvbGRlciB0byB0aGUgRE9NLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiB2aWV3LmFkZFJlZ2lvbigncjEnLCB7IHByZWZpeDogJ3IxJyB9KTsKICAgICAqCiAgICAgKiBAcHVibGljCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBOYW1lIG9mIHRoZSByZWdpb24gdG8gYWRkLgogICAgICogQHBhcmFtIHtvYmplY3R9IGRlZmluaXRpb24gLSBSZWdpb24gZGVmaW5pdGlvbi4KICAgICAqLwogICAgYWRkUmVnaW9uOiBmdW5jdGlvbiAobmFtZSwgZGVmaW5pdGlvbikgewogICAgICAvLyBBcHBlbmQgcmVnaW9ucyBwcmlvciB0byBhc3NpZ25pbmcgdGhlbQogICAgICB2YXIgZm9ybWF0dGVkID0geyBlbDogdGhpcy5hcHBlbmRSZWdpb24obmFtZSwgZGVmaW5pdGlvbikgfTsKICAgICAgTWFyaW9uZXR0ZS5MYXlvdXRWaWV3LnByb3RvdHlwZS5hZGRSZWdpb24uY2FsbCh0aGlzLCBuYW1lLCBmb3JtYXR0ZWQpOwogICAgfSwKICAgIC8qKgogICAgICogQWRkIG11bHRpcGxlIHJlZ2lvbnMgYXQgb25lLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiB2aWV3LmFkZFJlZ2lvbnMoewogICAgICogICAncjEnOiB7IHByZWZpeDogJ3IxJyB9LAogICAgICogICAncjInOiB7IHByZWZpeDogJ3IyJyB9CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBAcHVibGljCiAgICAgKgogICAgICogQHBhcmFtIHtyZWdpb25zfSBuYW1lIC0gUmVnaW9ucyBvYmplY3Qgd2hlcmUgdGhlIGtleSByZXByZXNlbnRzCiAgICAgKiAgIHRoZSByZWdpb24gbmFtZSBhbmQgdGhlIHZhbHVlIGlzIHRoZSByZWdpb24gZGVmaW5pdGlvbi4KICAgICAqLwogICAgYWRkUmVnaW9uczogZnVuY3Rpb24gKHJlZ2lvbnMpIHsKICAgICAgdmFyIGZvcm1hdHRlZCA9IHt9OwogICAgICAvLyBBcHBlbmQgUmVnaW9ucyBwcmlvciB0byBhc3NpZ25pbmcgdGhlbQogICAgICBfLmVhY2gocmVnaW9ucywgZnVuY3Rpb24gKHZhbCwga2V5KSB7CiAgICAgICAgZm9ybWF0dGVkW2tleV0gPSB7IGVsOiB0aGlzLmFwcGVuZFJlZ2lvbihrZXksIHZhbCkgfTsKICAgICAgfSwgdGhpcyk7CiAgICAgIE1hcmlvbmV0dGUuTGF5b3V0Vmlldy5wcm90b3R5cGUuYWRkUmVnaW9ucy5jYWxsKHRoaXMsIGZvcm1hdHRlZCk7CiAgICB9LAogICAgLyoqCiAgICAgKiBSZW1vdmUgYm90aCByZWdpb24gYW5kIGhvbGRlciBlbC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogdmlldy5yZW1vdmVSZWdpb24oJ3IxJyk7CiAgICAgKgogICAgICogQHB1YmxpYwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gTmFtZSBvZiB0aGUgcmVnaW9uIHRvIHJlbW92ZS4KICAgICAqLwogICAgcmVtb3ZlUmVnaW9uOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAvLyBSZW1vdmUgJHJlZ2lvbiBlbGVtZW50CiAgICAgIHRoaXMuJHJlZ2lvbnNbbmFtZV0ucmVtb3ZlKCk7CiAgICAgIE1hcmlvbmV0dGUuTGF5b3V0Vmlldy5wcm90b3R5cGUucmVtb3ZlUmVnaW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLyoqCiAgICAgKiBBcHBlbmQgYXBwIHJlZ2lvbiB0ZW1wbGF0ZSB0byBET00uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIE5hbWUgb2YgdGhlIHJlZ2lvbiB0byBhZGQuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGVmaW5pdGlvbiAtIFJlZ2lvbiBkZWZpbml0aW9uLgogICAgICovCiAgICBhcHBlbmRSZWdpb246IGZ1bmN0aW9uIChuYW1lLCBkZWZpbml0aW9uKSB7CiAgICAgIHZhciB0bXBsID0gZGVmaW5pdGlvbi50bXBsLCBwcm9wcyA9IF8uZXh0ZW5kKHsgbmFtZTogbmFtZSB9LCBkZWZpbml0aW9uKTsKICAgICAgLy8gQ2FuIHRlbXBsYXRlIGEgamF2YXNjcmlwdCBmdW5jdGlvbgogICAgICBkZWxldGUgcHJvcHMudG1wbDsKICAgICAgLy8gVGVtcGxhdGUgd2lsbCBmYWlsIGlmIHByb3BzIGFyZSBtaXNzaW5nCiAgICAgIF8uZGVmYXVsdHMocHJvcHMsIHsKICAgICAgICBwcmVmaXg6ICcnLAogICAgICAgIG5hbWU6ICcnLAogICAgICAgIGNsczogJycKICAgICAgfSk7CiAgICAgIHZhciAkcmVnaW9uID0gJChfLnRlbXBsYXRlKHRtcGwsIHByb3BzKSk7CiAgICAgIC8vIEFwcGVuZCB0ZW1wbGF0ZXRlZCBodG1sCiAgICAgIHRoaXMuJHJlZ2lvbnMgPSB0aGlzLiRyZWdpb25zIHx8IHt9OwogICAgICB0aGlzLiRyZWdpb25zW25hbWVdID0gJHJlZ2lvbjsKICAgICAgdGhpcy4kZWwuYXBwZW5kKCRyZWdpb24pOwogICAgICByZXR1cm4gJHJlZ2lvbjsKICAgIH0KICB9KTsKfSh1bmRlcnNjb3JlLCBiYWNrYm9uZW1hcmlvbmV0dGUpOwovKiEKICogbGF5b3V0Q29udHJvbGxlci5qcwogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0CiAqLwpsYXlvdXRDb250cm9sbGVyID0gZnVuY3Rpb24gKF8sIGl0ZW1Db250cm9sbGVyLCBjb21tYW5kZXIsIExheW91dFZpZXcpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIHNjb3BlCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgdG1wbCA9ICc8ZGl2IGNsYXNzPSI8JT1wcmVmaXglPi08JT1uYW1lJT4gPCU9Y2xzJT4iPjwvZGl2Pic7CiAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBMYXlvdXRDb250cm9sbGVyCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICByZXR1cm4gaXRlbUNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgIC8vIERlZmF1bHQgTGF5b3V0VklldwogICAgVmlldzogTGF5b3V0VmlldywKICAgIC8qKgogICAgICogQ29udHJvbGxlciB3aXRoIG1ldGhvZHMgdG8gbWFuaXB1bGF0ZSBuZXN0ZWQgbGF5b3V0CiAgICAgKiB2aWV3cyBhbmQgYXNzb2NpYXRlZCByZWdpb25zLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgY29udHJvbGxlciA9IG5ldyBMYXlvdXRDb250cm9sbGVyKCk7CiAgICAgKgogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKiBAcHVibGljCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAvLyBMYXlvdXQgQ29udHJvbGxlciB1c2VzIGl0ZW1Db250cm9sbGVyCiAgICAgIC8vIGFzIGEgYmFzZS4KICAgICAgdGhpcy5zZXR1cChvcHRpb25zKTsKICAgICAgLy8gU2V0IHJlcXVpcmVkIGluc3RhbmNlIHZhcmlhYmxlcwogICAgICB0aGlzLnByZWZpeCA9IHRoaXMucmVxdWlyZWQoJ3ByZWZpeCcpOwogICAgICB0aGlzLm5hbWVzcGFjZSA9IHRoaXMucmVxdWlyZWQoJ25hbWVzcGFjZScpOwogICAgICAvLyBTZXQgdXAgYW4gZW1wdHkgYXJyYXkgdG8gaG9sZCByZWZlcmVuY2UgdG8gYWxsCiAgICAgIC8vIGFwcGxpZWQgZXZlbnRzIChmb3IgY2xlYW51cCkuCiAgICAgIHRoaXMuX2NoaWxkRXZlbnRzID0gW107CiAgICAgIC8vIFNldCB1cCBhbiBlbXB0eSBvYmplY3QgcmVzcG9uc2libGUgZm9yIG1hbmFnaW5nCiAgICAgIC8vIHZpZXcgcmVnaW9ucyBhbmQgY3VycmVudCBzdGF0ZS4gCiAgICAgIHRoaXMuX3JlZ2lvbnMgPSB7fTsKICAgICAgLy8gU2V0IHVwIGFuIGVtcHR5IG9iamVjdCByZXNwb25zaWJsZSBmb3IgbWFuZ2luZwogICAgICAvLyBzdWIgY29udHJvbGxlcnMuCiAgICAgIHRoaXMuX2l0ZW1zID0ge307CiAgICAgIC8vIFNldHVwIGFueSByZWdpb25zIHNldAogICAgICB0aGlzLmNvbmZpZ3VyZVJlZ2lvbnMoKTsKICAgICAgLy8gSW5pdGxpYXplIHlvIQogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgICB0aGlzLmluaXRpYWxpemUodGhpcy5vcHRpb25zKTsKICAgICAgfQogICAgfSwKICAgIC8qKgogICAgICogQ2FsbGVkIG9uIGNvbnRyb2xsZXIgZGVzdHJveS4gVXNlZCB0byBjbGVhbiB1cCBhbnkKICAgICAqIGFwcGxpZWQgZXZlbnRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIG9uRGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICBfLmVhY2godGhpcy5fY2hpbGRFdmVudHMsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGNvbW1hbmRlci5yZW1vdmVIYW5kbGVyKGV2ZW50KTsKICAgICAgfSk7CiAgICAgIF8uZWFjaCh0aGlzLl9pdGVtcywgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICBpdGVtLmNvbnRyb2xsZXIuZGVzdHJveSgpOwogICAgICB9KTsKICAgIH0sCiAgICAvKioKICAgICAqIENyZWF0ZSBhbnkgcmVnaW9ucyBkZWNsYXJlZCBpbiBsYXlvdXRSZWdpb25zLgogICAgICogRGVjbGFyZWQgaW4gY2xhc3Mgb3IgcGFzc2VkIGluIHRoaXMub3B0aW9ucwogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGNvbmZpZ3VyZVJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldE9wdGlvbigncmVnaW9ucycpLCBpc0FyciA9IF8uaXNBcnJheShyZWdpb25zKTsKICAgICAgXy5lYWNoKHJlZ2lvbnMsIGZ1bmN0aW9uICh2YWwsIGtleSkgewogICAgICAgIHJldHVybiBpc0FyciA/IHRoaXMuYWRkUmVnaW9uKHZhbCwge30pIDogdGhpcy5hZGRSZWdpb24oa2V5LCB2YWwpOwogICAgICB9LCB0aGlzKTsKICAgIH0sCiAgICAvKioKICAgICAqIEFkZCByZWdpb25zIHRvIG91ciBhcHAgdmlldyBhbmQgc2V0IHVwIGdsb2JhbCBldmVudHMgb24gY29tbWFuZGVyCiAgICAgKiB0byBpbnRlcmFjdCB3aXRoIHRoZW0uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIGNvbnRyb2xsZXIuYWRkUmVnaW9uKCdyMScsIHsgdG1wbDogdGVtcGxhdGUgfSk7CiAgICAgKgogICAgICogQHB1YmxpYwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gTmFtZSBvZiB0aGUgcmVnaW9uIHRvIGFkZC4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkZWZpbml0aW9uIC0gUmVnaW9uIGRlZmluaXRpb24uCiAgICAgKi8KICAgIGFkZFJlZ2lvbjogZnVuY3Rpb24gKG5hbWUsIGRlZmluaXRpb24pIHsKICAgICAgdmFyIG5hbWVzcGFjZSA9IFsKICAgICAgICB0aGlzLm5hbWVzcGFjZSwKICAgICAgICBuYW1lCiAgICAgIF0uam9pbignOicpOwogICAgICB2YXIgZXZlbnROYW1lID0gWwogICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAnc2hvdycKICAgICAgXS5qb2luKCc6Jyk7CiAgICAgIC8vIE1peGluIHdpdGggZGVmYXVsdHMKICAgICAgZGVmaW5pdGlvbiA9IF8uZXh0ZW5kKHt9LCBkZWZpbml0aW9uKTsKICAgICAgZGVmaW5pdGlvblsncHJlZml4J10gPSBkZWZpbml0aW9uWydwcmVmaXgnXSB8fCB0aGlzLnByZWZpeDsKICAgICAgZGVmaW5pdGlvblsndG1wbCddID0gZGVmaW5pdGlvblsndG1wbCddIHx8IHRtcGw7CiAgICAgIC8vIEFkZCBhIG5ldyByZWdpb24gdG8gb3VyIHZpZXcKICAgICAgdGhpcy52aWV3LmFkZFJlZ2lvbihuYW1lLCBkZWZpbml0aW9uKTsKICAgICAgLy8gV2Ugd2FudCB0byBhbHdheXMgaGF2ZSB0cmFjayBvZiBvdXIgY3JydWVudCByZWdpb24gY29udHJvbGxlci4KICAgICAgLy8gU2V0dGluZyB0byBlbXB0eSBvdmplY3QgdG8gYXZvaWQgaGF2aW5nIHRvIGNoZWNrIGZvciBleGlzdGVuY2UKICAgICAgLy8gZXZlcnl3aGVyZSB3ZSBsb29rdXAKICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuX3JlZ2lvbnNbbmFtZV0gPSB7fTsKICAgICAgcmVnaW9uWyduYW1lc3BhY2UnXSA9IG5hbWVzcGFjZTsKICAgICAgcmVnaW9uWydjdXJyZW50J10gPSB7fTsKICAgICAgLy8gQWRkIGFuIGV2ZW50IHRvIHNob3cgYSBzcGVjaWZpZWQgY29udHJvbGxlciB2aWV3CiAgICAgIC8vIGluIHRoZSByZWdpb24uIEhhbmRsZXIgc2hvdWxkIGJlIHBhc3NlZCByZWdpb24gbmFtZS4KICAgICAgdGhpcy5fY2hpbGRFdmVudHMucHVzaChldmVudE5hbWUpOwogICAgICBjb21tYW5kZXIuc2V0SGFuZGxlcihldmVudE5hbWUsIF8uYmluZCh0aGlzLm9uU2hvdywgdGhpcywgbmFtZSkpOwogICAgfSwKICAgIC8qKgogICAgICogU2hvdyBoYW5kbGVyLiBSZXNwb25zaWJsZSBmb3Igc2hvd2luZyBhIHZpZXcvY29udHJvbGxlcgogICAgICogaW4gdGhlIG5ldyByZWdpb24uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW1zIHtzdHJpbmd9IHJlZ2lvbk5hbWUgLSBOYW1lIG9mIHJlZ2lvbiB0byBzaG93IHZpZXcgaW4uCiAgICAgKiBAcGFyYW1zIHtzdHJpbmd9IGl0ZW1OYW1lIC0gTmFtZSBvZiB2aWV3IHRvIHNob3cgaW4gcmVnaW9uLgogICAgICogQHBhcmFtcyB7b2JqZWN0fSBpdGVtIC0gVGhlIGl0ZW0gY29udGFpbnMgYSBDb250cm9sbGVyCiAgICAgKiAgIGFuZCBhbnkgb3B0aW9ucyB0byBwYXNzIGluIGF0IENvbnRyb2xsZXIgaW5zdGFudGlhdGlvbi4KICAgICAqIEBwYXJhbXMge2Z1bmN0aW9ufSBkb25lIC0gQ2FsbGJhY2sgdG8gZXhlY3V0ZSBvbmNlIHJlZ2lvbgogICAgICogICBoYXMgYmVlbiBzaG93bi4gV2lsbCBwYXNzIGluIHRoZSBuZXdseSBpbnN0YW50aWF0ZWQKICAgICAqICAgY29udHJvbGxlci4KICAgICAqLwogICAgb25TaG93OiBmdW5jdGlvbiAocmVnaW9uTmFtZSwgaXRlbU5hbWUsIGl0ZW0sIGRvbmUpIHsKICAgICAgLy8gaXRlbSBwYXNzZWQgYXMgQ29udHJvbGxlcgogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGl0ZW0pKSB7CiAgICAgICAgaXRlbSA9IHsgQ29udHJvbGxlcjogaXRlbSB9OwogICAgICB9CiAgICAgIC8vIGFkZCBuYW1lIHRvIGl0ZW0gb2JqZWN0CiAgICAgIGl0ZW1bJ25hbWUnXSA9IGl0ZW1OYW1lOwogICAgICAvLyBNaXggbmFtZSBpbnRvIGZvcm1hdHRlZCBpdGVtCiAgICAgIHRoaXMuc2hvd0luUmVnaW9uKHJlZ2lvbk5hbWUsIGl0ZW0sIGRvbmUpOwogICAgfSwKICAgIC8qKgogICAgICogU2hvdyBhIHZpZXcgaW4gdGhlIHNwZWNpZmllZCByZWdpb24gdXNpbmcgdGhlIGNvbnRyb2xsZXIKICAgICAqIHRoYXQgaW5zdGFudGlhdGVzIHRoZSB2aWV3LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBjb250cm9sbGVyLnNob3dJblJlZ2lvbigncjEnLCB7IAogICAgICogICBuYW1lOiAnY29udGVudCcsCiAgICAgKiAgIENvbnRyb2xsZXI6IENvbnRlbnRDb250cm9sbGVyCiAgICAgKiB9LCBjb21wbGV0ZWQpOwogICAgICoKICAgICAqIEBwdWJsaWMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIE5hbWUgb2YgdGhlIHJlZ2lvbiB0byBzaG93IGNvbnRlbnQgaW4uCiAgICAgKiBAcGFyYW0ge29iamVjdH0gaXRlbSAtIEl0ZW0gZGVmaW5pdGlvbi4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGRvbmUgLSBDYWxsYmFjayBleGVjdXRlZCBvbmNlIHZpZXcgaXMgc2hvd24uCiAgICAgKi8KICAgIHNob3dJblJlZ2lvbjogZnVuY3Rpb24gKHJlZ2lvbk5hbWUsIGl0ZW0sIGRvbmUpIHsKICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuX3JlZ2lvbnNbcmVnaW9uTmFtZV07CiAgICAgIHZhciBuYW1lID0gWwogICAgICAgIHJlZ2lvbk5hbWUsCiAgICAgICAgaXRlbS5uYW1lCiAgICAgIF0uam9pbignOicpOwogICAgICB2YXIgY3VycmVudCA9IHJlZ2lvbi5jdXJyZW50OwogICAgICB2YXIgY3VyTmFtZSA9IFsKICAgICAgICByZWdpb25OYW1lLAogICAgICAgIGN1cnJlbnQubmFtZQogICAgICBdLmpvaW4oJzonKTsKICAgICAgdmFyIGlzRGlmZiA9IGN1cnJlbnQubmFtZSAhPT0gaXRlbS5uYW1lOwogICAgICAvLyBJZiBpdCBjdXJyZW50bHkgZXhpc3RzIGFuZCBpcyBkaWZmZXJudAogICAgICAvLyB0aGVuIHdlIG5lZWQgdG8gZGVzdHJveS9yZW1vdmUuCiAgICAgIGlmIChpc0RpZmYgJiYgY3VycmVudC5uYW1lICYmICFpdGVtLnByZXZlbnRDbG9zZSkgewogICAgICAgIGN1cnJlbnQuY29udHJvbGxlci5kZXN0cm95KCk7CiAgICAgICAgZGVsZXRlIHRoaXMuX2l0ZW1zW2N1ck5hbWVdOwogICAgICB9CiAgICAgIC8vIENyZWF0ZSBhIG5ldyBpdGVtIGlmIGl0IGRvZXMgbm90IHlldCBleGlzdC4KICAgICAgaWYgKGlzRGlmZiAmJiAhdGhpcy5faXRlbXNbbmFtZV0pIHsKICAgICAgICB0aGlzLl9pdGVtc1tuYW1lXSA9IHRoaXMuY3JlYXRlSXRlbShyZWdpb24sIGl0ZW0pOwogICAgICB9CiAgICAgIC8vIFNob3cgYW5kIHNldCBjdXJyZW50LgogICAgICBpZiAoaXNEaWZmKSB7CiAgICAgICAgcmVnaW9uLmN1cnJlbnQgPSB0aGlzLl9pdGVtc1tuYW1lXTsKICAgICAgICB0aGlzLnZpZXdbcmVnaW9uTmFtZV0uc2hvdyhyZWdpb24uY3VycmVudC5jb250cm9sbGVyLnZpZXcpOwogICAgICB9CiAgICAgIC8vIE9wdGlvbmFsIGNhbGxiYWNrIHRoYXQgcGFzc2VzIGN1cnJlbnQgcmVnaW9uIG9iamVjdC4KICAgICAgaWYgKGRvbmUpIHsKICAgICAgICBkb25lKHJlZ2lvbi5jdXJyZW50KTsKICAgICAgfQogICAgfSwKICAgIC8qKgogICAgICogU2V0IGN1cnJlbnQgb2Ygc3BlY2lmaWVkIHJlZ2lvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gUmVnaW9uIGN1cnJlbnRseSBtYW5pcHVsYXRpbmcgb24uCiAgICAgKiBAcGFyYW0ge29iamVjdH0gaXRlbSAtIEl0ZW0gdG8gaW5pdGlhbGl6ZSBhbmQgc2V0IGFzIGN1cnJlbnQuCiAgICAgKi8KICAgIGNyZWF0ZUl0ZW06IGZ1bmN0aW9uIChyZWdpb24sIGl0ZW0pIHsKICAgICAgdmFyIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgaXRlbS5vcHRpb25zKTsKICAgICAgdmFyIG5hbWVzcGFjZSA9IFsKICAgICAgICByZWdpb24ubmFtZXNwYWNlLAogICAgICAgIGl0ZW0ubmFtZQogICAgICBdLmpvaW4oJzonKTsKICAgICAgLy8gQWRkIG5hbWVzcGFjZSB0byBvcHRpb25zCiAgICAgIG9wdGlvbnNbJ25hbWVzcGFjZSddID0gbmFtZXNwYWNlOwogICAgICAvLyBBZGQgaXRlbQogICAgICByZXR1cm4gewogICAgICAgICdjb250cm9sbGVyJzogbmV3IGl0ZW0uQ29udHJvbGxlcihvcHRpb25zKSwKICAgICAgICAnbmFtZSc6IGl0ZW0ubmFtZQogICAgICB9OwogICAgfQogIH0pOwp9KHVuZGVyc2NvcmUsIGl0ZW1Db250cm9sbGVyLCBjb21tYW5kZXIsIGxheW91dFZpZXcpOwovKiEKICogbWFyaW9uZXR0ZS5keW5hbWljbGF5b3V0LmpzCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQKICovCm1hcmlvbmV0dGVkeW5hbWljbGF5b3V0ID0gZnVuY3Rpb24gKGNvbW1hbmRlciwgSXRlbUNvbnRyb2xsZXIsIExheW91dENvbnRyb2xsZXIsIExheW91dFZpZXcpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGV4cG9ydAogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgcmV0dXJuIHsKICAgIGNvbW1hbmRlcjogY29tbWFuZGVyLAogICAgSXRlbUNvbnRyb2xsZXI6IEl0ZW1Db250cm9sbGVyLAogICAgTGF5b3V0Q29udHJvbGxlcjogTGF5b3V0Q29udHJvbGxlciwKICAgIExheW91dFZpZXc6IExheW91dFZpZXcKICB9Owp9KGNvbW1hbmRlciwgaXRlbUNvbnRyb2xsZXIsIGxheW91dENvbnRyb2xsZXIsIGxheW91dFZpZXcpOwoKcmV0dXJuIG1hcmlvbmV0dGVEeW5hbWljbGF5b3V0OwoKCn0pKTs=",
                "body": "KGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgogICAgZGVmaW5lKFtdLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAocm9vdC5yZXR1cm5FeHBvcnRzR2xvYmFsID0gZmFjdG9yeSgpKTsKICAgIH0pOwogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CiAgICAvLyBOb2RlLiBEb2VzIG5vdCB3b3JrIHdpdGggc3RyaWN0IENvbW1vbkpTLCBidXQKICAgIC8vIG9ubHkgQ29tbW9uSlMtbGlrZSBlbnZpcm9tZW50cyB0aGF0IHN1cHBvcnQgbW9kdWxlLmV4cG9ydHMsCiAgICAvLyBsaWtlIE5vZGUuCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKICB9IGVsc2UgewogICAgcm9vdFsnRHluYW1pY0xheW91dCddID0gZmFjdG9yeSgpOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAoKSB7CgovLyAgICAgVW5kZXJzY29yZS5qcyAxLjYuMAovLyAgICAgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcKLy8gICAgIChjKSAyMDA5LTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKLy8gICAgIFVuZGVyc2NvcmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCnZhciB1bmRlcnNjb3JlLCBqcXVlcnksIGJhY2tib25lLCBiYWNrYm9uZXdyZXFyLCBjb21tYW5kZXIsIGJhY2tib25lYmFieXNpdHRlciwgYmFja2JvbmVtYXJpb25ldHRlLCBpdGVtVmlldywgaXRlbUNvbnRyb2xsZXIsIGxheW91dFZpZXcsIGxheW91dENvbnRyb2xsZXIsIG1hcmlvbmV0dGVkeW5hbWljbGF5b3V0OwooZnVuY3Rpb24gKCkgewogIC8vIEJhc2VsaW5lIHNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGV4cG9ydHNgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCiAgdmFyIHByZXZpb3VzVW5kZXJzY29yZSA9IHJvb3QuXzsKICAvLyBFc3RhYmxpc2ggdGhlIG9iamVjdCB0aGF0IGdldHMgcmV0dXJuZWQgdG8gYnJlYWsgb3V0IG9mIGEgbG9vcCBpdGVyYXRpb24uCiAgdmFyIGJyZWFrZXIgPSB7fTsKICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLCBPYmpQcm90byA9IE9iamVjdC5wcm90b3R5cGUsIEZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIgcHVzaCA9IEFycmF5UHJvdG8ucHVzaCwgc2xpY2UgPSBBcnJheVByb3RvLnNsaWNlLCBjb25jYXQgPSBBcnJheVByb3RvLmNvbmNhdCwgdG9TdHJpbmcgPSBPYmpQcm90by50b1N0cmluZywgaGFzT3duUHJvcGVydHkgPSBPYmpQcm90by5oYXNPd25Qcm9wZXJ0eTsKICAvLyBBbGwgKipFQ01BU2NyaXB0IDUqKiBuYXRpdmUgZnVuY3Rpb24gaW1wbGVtZW50YXRpb25zIHRoYXQgd2UgaG9wZSB0byB1c2UKICAvLyBhcmUgZGVjbGFyZWQgaGVyZS4KICB2YXIgbmF0aXZlRm9yRWFjaCA9IEFycmF5UHJvdG8uZm9yRWFjaCwgbmF0aXZlTWFwID0gQXJyYXlQcm90by5tYXAsIG5hdGl2ZVJlZHVjZSA9IEFycmF5UHJvdG8ucmVkdWNlLCBuYXRpdmVSZWR1Y2VSaWdodCA9IEFycmF5UHJvdG8ucmVkdWNlUmlnaHQsIG5hdGl2ZUZpbHRlciA9IEFycmF5UHJvdG8uZmlsdGVyLCBuYXRpdmVFdmVyeSA9IEFycmF5UHJvdG8uZXZlcnksIG5hdGl2ZVNvbWUgPSBBcnJheVByb3RvLnNvbWUsIG5hdGl2ZUluZGV4T2YgPSBBcnJheVByb3RvLmluZGV4T2YsIG5hdGl2ZUxhc3RJbmRleE9mID0gQXJyYXlQcm90by5sYXN0SW5kZXhPZiwgbmF0aXZlSXNBcnJheSA9IEFycmF5LmlzQXJyYXksIG5hdGl2ZUtleXMgPSBPYmplY3Qua2V5cywgbmF0aXZlQmluZCA9IEZ1bmNQcm90by5iaW5kOwogIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgogIHZhciBfID0gZnVuY3Rpb24gKG9iaikgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIF8pCiAgICAgIHJldHVybiBvYmo7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpCiAgICAgIHJldHVybiBuZXcgXyhvYmopOwogICAgdGhpcy5fd3JhcHBlZCA9IG9iajsKICB9OwogIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCiAgLy8gYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgZm9yIHRoZSBvbGQgYHJlcXVpcmUoKWAgQVBJLiBJZiB3ZSdyZSBpbgogIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdCB2aWEgYSBzdHJpbmcgaWRlbnRpZmllciwKICAvLyBmb3IgQ2xvc3VyZSBDb21waWxlciAiYWR2YW5jZWQiIG1vZGUuCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CiAgICB9CiAgICBleHBvcnRzLl8gPSBfOwogIH0gZWxzZSB7CiAgICByb290Ll8gPSBfOwogIH0KICAvLyBDdXJyZW50IHZlcnNpb24uCiAgXy5WRVJTSU9OID0gJzEuNi4wJzsKICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCiAgLy8gSGFuZGxlcyBvYmplY3RzIHdpdGggdGhlIGJ1aWx0LWluIGBmb3JFYWNoYCwgYXJyYXlzLCBhbmQgcmF3IG9iamVjdHMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZvckVhY2hgIGlmIGF2YWlsYWJsZS4KICB2YXIgZWFjaCA9IF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uIChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIHJldHVybiBvYmo7CiAgICBpZiAobmF0aXZlRm9yRWFjaCAmJiBvYmouZm9yRWFjaCA9PT0gbmF0aXZlRm9yRWFjaCkgewogICAgICBvYmouZm9yRWFjaChpdGVyYXRvciwgY29udGV4dCk7CiAgICB9IGVsc2UgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBvYmoubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpbaV0sIGksIG9iaikgPT09IGJyZWFrZXIpCiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleXNbaV1dLCBrZXlzW2ldLCBvYmopID09PSBicmVha2VyKQogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH07CiAgLy8gUmV0dXJuIHRoZSByZXN1bHRzIG9mIGFwcGx5aW5nIHRoZSBpdGVyYXRvciB0byBlYWNoIGVsZW1lbnQuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYG1hcGAgaWYgYXZhaWxhYmxlLgogIF8ubWFwID0gXy5jb2xsZWN0ID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZU1hcCAmJiBvYmoubWFwID09PSBuYXRpdmVNYXApCiAgICAgIHJldHVybiBvYmoubWFwKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJlc3VsdHMucHVzaChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwogIHZhciByZWR1Y2VFcnJvciA9ICdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJzsKICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCiAgLy8gb3IgYGZvbGRsYC4gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZWAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZSAmJiBvYmoucmVkdWNlID09PSBuYXRpdmVSZWR1Y2UpIHsKICAgICAgaWYgKGNvbnRleHQpCiAgICAgICAgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZShpdGVyYXRvcik7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gdmFsdWU7CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IocmVkdWNlRXJyb3IpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKICAvLyBUaGUgcmlnaHQtYXNzb2NpYXRpdmUgdmVyc2lvbiBvZiByZWR1Y2UsIGFsc28ga25vd24gYXMgYGZvbGRyYC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgcmVkdWNlUmlnaHRgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZVJpZ2h0ID0gXy5mb2xkciA9IGZ1bmN0aW9uIChvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKQogICAgICBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2VSaWdodCAmJiBvYmoucmVkdWNlUmlnaHQgPT09IG5hdGl2ZVJlZHVjZVJpZ2h0KSB7CiAgICAgIGlmIChjb250ZXh0KQogICAgICAgIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yKTsKICAgIH0KICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgaWYgKGxlbmd0aCAhPT0gK2xlbmd0aCkgewogICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgICBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGluZGV4ID0ga2V5cyA/IGtleXNbLS1sZW5ndGhdIDogLS1sZW5ndGg7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSBvYmpbaW5kZXhdOwogICAgICAgIGluaXRpYWwgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIG1lbW8gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG1lbW8sIG9ialtpbmRleF0sIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IocmVkdWNlRXJyb3IpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCiAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbiAob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQ7CiAgICBhbnkob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChwcmVkaWNhdGUuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZpbHRlcmAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uIChvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlRmlsdGVyICYmIG9iai5maWx0ZXIgPT09IG5hdGl2ZUZpbHRlcikKICAgICAgcmV0dXJuIG9iai5maWx0ZXIocHJlZGljYXRlLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChwcmVkaWNhdGUuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKQogICAgICAgIHJlc3VsdHMucHVzaCh2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgZm9yIHdoaWNoIGEgdHJ1dGggdGVzdCBmYWlscy4KICBfLnJlamVjdCA9IGZ1bmN0aW9uIChvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgcmV0dXJuIF8uZmlsdGVyKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gIXByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCk7CiAgICB9LCBjb250ZXh0KTsKICB9OwogIC8vIERldGVybWluZSB3aGV0aGVyIGFsbCBvZiB0aGUgZWxlbWVudHMgbWF0Y2ggYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBldmVyeWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFsbGAuCiAgXy5ldmVyeSA9IF8uYWxsID0gZnVuY3Rpb24gKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICBwcmVkaWNhdGUgfHwgKHByZWRpY2F0ZSA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlRXZlcnkgJiYgb2JqLmV2ZXJ5ID09PSBuYXRpdmVFdmVyeSkKICAgICAgcmV0dXJuIG9iai5ldmVyeShwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCEocmVzdWx0ID0gcmVzdWx0ICYmIHByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpKQogICAgICAgIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgc29tZWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgdmFyIGFueSA9IF8uc29tZSA9IF8uYW55ID0gZnVuY3Rpb24gKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICBwcmVkaWNhdGUgfHwgKHByZWRpY2F0ZSA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKG9iaiA9PSBudWxsKQogICAgICByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZVNvbWUgJiYgb2JqLnNvbWUgPT09IG5hdGl2ZVNvbWUpCiAgICAgIHJldHVybiBvYmouc29tZShwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHJlc3VsdCB8fCAocmVzdWx0ID0gcHJlZGljYXRlLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpCiAgICAgICAgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwogIC8vIERldGVybWluZSBpZiB0aGUgYXJyYXkgb3Igb2JqZWN0IGNvbnRhaW5zIGEgZ2l2ZW4gdmFsdWUgKHVzaW5nIGA9PT1gKS4KICAvLyBBbGlhc2VkIGFzIGBpbmNsdWRlYC4KICBfLmNvbnRhaW5zID0gXy5pbmNsdWRlID0gZnVuY3Rpb24gKG9iaiwgdGFyZ2V0KSB7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIGlmIChuYXRpdmVJbmRleE9mICYmIG9iai5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKQogICAgICByZXR1cm4gb2JqLmluZGV4T2YodGFyZ2V0KSAhPSAtMTsKICAgIHJldHVybiBhbnkob2JqLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0YXJnZXQ7CiAgICB9KTsKICB9OwogIC8vIEludm9rZSBhIG1ldGhvZCAod2l0aCBhcmd1bWVudHMpIG9uIGV2ZXJ5IGl0ZW0gaW4gYSBjb2xsZWN0aW9uLgogIF8uaW52b2tlID0gZnVuY3Rpb24gKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBpc0Z1bmMgPSBfLmlzRnVuY3Rpb24obWV0aG9kKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICByZXR1cm4gKGlzRnVuYyA/IG1ldGhvZCA6IHZhbHVlW21ldGhvZF0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgIH0pOwogIH07CiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgbWFwYDogZmV0Y2hpbmcgYSBwcm9wZXJ0eS4KICBfLnBsdWNrID0gZnVuY3Rpb24gKG9iaiwga2V5KSB7CiAgICByZXR1cm4gXy5tYXAob2JqLCBfLnByb3BlcnR5KGtleSkpOwogIH07CiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uIChvYmosIGF0dHJzKSB7CiAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBfLm1hdGNoZXMoYXR0cnMpKTsKICB9OwogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbmRgOiBnZXR0aW5nIHRoZSBmaXJzdCBvYmplY3QKICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8uZmluZFdoZXJlID0gZnVuY3Rpb24gKG9iaiwgYXR0cnMpIHsKICAgIHJldHVybiBfLmZpbmQob2JqLCBfLm1hdGNoZXMoYXR0cnMpKTsKICB9OwogIC8vIFJldHVybiB0aGUgbWF4aW11bSBlbGVtZW50IG9yIChlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICAvLyBDYW4ndCBvcHRpbWl6ZSBhcnJheXMgb2YgaW50ZWdlcnMgbG9uZ2VyIHRoYW4gNjUsNTM1IGVsZW1lbnRzLgogIC8vIFNlZSBbV2ViS2l0IEJ1ZyA4MDc5N10oaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTgwNzk3KQogIF8ubWF4ID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIHZhciByZXN1bHQgPSAtSW5maW5pdHksIGxhc3RDb21wdXRlZCA9IC1JbmZpbml0eTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGlmIChjb21wdXRlZCA+IGxhc3RDb21wdXRlZCkgewogICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIGxhc3RDb21wdXRlZCA9IGNvbXB1dGVkOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyBSZXR1cm4gdGhlIG1pbmltdW0gZWxlbWVudCAob3IgZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCiAgXy5taW4gPSBmdW5jdGlvbiAob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgdmFyIHJlc3VsdCA9IEluZmluaXR5LCBsYXN0Q29tcHV0ZWQgPSBJbmZpbml0eTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGlmIChjb21wdXRlZCA8IGxhc3RDb21wdXRlZCkgewogICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIGxhc3RDb21wdXRlZCA9IGNvbXB1dGVkOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyBTaHVmZmxlIGFuIGFycmF5LCB1c2luZyB0aGUgbW9kZXJuIHZlcnNpb24gb2YgdGhlCiAgLy8gW0Zpc2hlci1ZYXRlcyBzaHVmZmxlXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Zpc2hlcuKAk1lhdGVzX3NodWZmbGUpLgogIF8uc2h1ZmZsZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciByYW5kOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzaHVmZmxlZCA9IFtdOwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICByYW5kID0gXy5yYW5kb20oaW5kZXgrKyk7CiAgICAgIHNodWZmbGVkW2luZGV4IC0gMV0gPSBzaHVmZmxlZFtyYW5kXTsKICAgICAgc2h1ZmZsZWRbcmFuZF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHNodWZmbGVkOwogIH07CiAgLy8gU2FtcGxlICoqbioqIHJhbmRvbSB2YWx1ZXMgZnJvbSBhIGNvbGxlY3Rpb24uCiAgLy8gSWYgKipuKiogaXMgbm90IHNwZWNpZmllZCwgcmV0dXJucyBhIHNpbmdsZSByYW5kb20gZWxlbWVudC4KICAvLyBUaGUgaW50ZXJuYWwgYGd1YXJkYCBhcmd1bWVudCBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBtYXBgLgogIF8uc2FtcGxlID0gZnVuY3Rpb24gKG9iaiwgbiwgZ3VhcmQpIHsKICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpIHsKICAgICAgaWYgKG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoKQogICAgICAgIG9iaiA9IF8udmFsdWVzKG9iaik7CiAgICAgIHJldHVybiBvYmpbXy5yYW5kb20ob2JqLmxlbmd0aCAtIDEpXTsKICAgIH0KICAgIHJldHVybiBfLnNodWZmbGUob2JqKS5zbGljZSgwLCBNYXRoLm1heCgwLCBuKSk7CiAgfTsKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB0byBnZW5lcmF0ZSBsb29rdXAgaXRlcmF0b3JzLgogIHZhciBsb29rdXBJdGVyYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgaWYgKHZhbHVlID09IG51bGwpCiAgICAgIHJldHVybiBfLmlkZW50aXR5OwogICAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpCiAgICAgIHJldHVybiB2YWx1ZTsKICAgIHJldHVybiBfLnByb3BlcnR5KHZhbHVlKTsKICB9OwogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRvci4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uIChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgIHJldHVybiBfLnBsdWNrKF8ubWFwKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgY3JpdGVyaWE6IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KQogICAgICB9OwogICAgfSkuc29ydChmdW5jdGlvbiAobGVmdCwgcmlnaHQpIHsKICAgICAgdmFyIGEgPSBsZWZ0LmNyaXRlcmlhOwogICAgICB2YXIgYiA9IHJpZ2h0LmNyaXRlcmlhOwogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGlmIChhID4gYiB8fCBhID09PSB2b2lkIDApCiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICBpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKQogICAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHJldHVybiBsZWZ0LmluZGV4IC0gcmlnaHQuaW5kZXg7CiAgICB9KSwgJ3ZhbHVlJyk7CiAgfTsKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgogIHZhciBncm91cCA9IGZ1bmN0aW9uIChiZWhhdmlvcikgewogICAgcmV0dXJuIGZ1bmN0aW9uIChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcihpdGVyYXRvcik7CiAgICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgdmFyIGtleSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBvYmopOwogICAgICAgIGJlaGF2aW9yKHJlc3VsdCwga2V5LCB2YWx1ZSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwogIC8vIEdyb3VwcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLiBQYXNzIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUKICAvLyB0byBncm91cCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGNyaXRlcmlvbi4KICBfLmdyb3VwQnkgPSBncm91cChmdW5jdGlvbiAocmVzdWx0LCBrZXksIHZhbHVlKSB7CiAgICBfLmhhcyhyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XS5wdXNoKHZhbHVlKSA6IHJlc3VsdFtrZXldID0gW3ZhbHVlXTsKICB9KTsKICAvLyBJbmRleGVzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24sIHNpbWlsYXIgdG8gYGdyb3VwQnlgLCBidXQgZm9yCiAgLy8gd2hlbiB5b3Uga25vdyB0aGF0IHlvdXIgaW5kZXggdmFsdWVzIHdpbGwgYmUgdW5pcXVlLgogIF8uaW5kZXhCeSA9IGdyb3VwKGZ1bmN0aW9uIChyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgfSk7CiAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCiAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgLy8gY3JpdGVyaW9uLgogIF8uY291bnRCeSA9IGdyb3VwKGZ1bmN0aW9uIChyZXN1bHQsIGtleSkgewogICAgXy5oYXMocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0rKyA6IHJlc3VsdFtrZXldID0gMTsKICB9KTsKICAvLyBVc2UgYSBjb21wYXJhdG9yIGZ1bmN0aW9uIHRvIGZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoCiAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgogIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbiAoYXJyYXksIG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmopOwogICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CiAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICB2YXIgbWlkID0gbG93ICsgaGlnaCA+Pj4gMTsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBhcnJheVttaWRdKSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CiAgLy8gU2FmZWx5IGNyZWF0ZSBhIHJlYWwsIGxpdmUgYXJyYXkgZnJvbSBhbnl0aGluZyBpdGVyYWJsZS4KICBfLnRvQXJyYXkgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBpZiAoIW9iaikKICAgICAgcmV0dXJuIFtdOwogICAgaWYgKF8uaXNBcnJheShvYmopKQogICAgICByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKQogICAgICByZXR1cm4gXy5tYXAob2JqLCBfLmlkZW50aXR5KTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CiAgLy8gUmV0dXJuIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gb2JqZWN0LgogIF8uc2l6ZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIDA7CiAgICByZXR1cm4gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CiAgLy8gQXJyYXkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawogIC8vIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24gKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpCiAgICAgIHJldHVybiB2b2lkIDA7CiAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKQogICAgICByZXR1cm4gYXJyYXlbMF07CiAgICBpZiAobiA8IDApCiAgICAgIHJldHVybiBbXTsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBuKTsKICB9OwogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgogIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCiAgLy8gdGhlIGFycmF5LCBleGNsdWRpbmcgdGhlIGxhc3QgTi4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoCiAgLy8gYF8ubWFwYC4KICBfLmluaXRpYWwgPSBmdW5jdGlvbiAoYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgYXJyYXkubGVuZ3RoIC0gKG4gPT0gbnVsbCB8fCBndWFyZCA/IDEgOiBuKSk7CiAgfTsKICAvLyBHZXQgdGhlIGxhc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgbGFzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5sYXN0ID0gZnVuY3Rpb24gKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpCiAgICAgIHJldHVybiB2b2lkIDA7CiAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKQogICAgICByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgTWF0aC5tYXgoYXJyYXkubGVuZ3RoIC0gbiwgMCkpOwogIH07CiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgogIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCiAgLy8gdGhlIHJlc3QgTiB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqCiAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uIChhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBuID09IG51bGwgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKICAvLyBUcmltIG91dCBhbGwgZmFsc3kgdmFsdWVzIGZyb20gYW4gYXJyYXkuCiAgXy5jb21wYWN0ID0gZnVuY3Rpb24gKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIF8uaWRlbnRpdHkpOwogIH07CiAgLy8gSW50ZXJuYWwgaW1wbGVtZW50YXRpb24gb2YgYSByZWN1cnNpdmUgYGZsYXR0ZW5gIGZ1bmN0aW9uLgogIHZhciBmbGF0dGVuID0gZnVuY3Rpb24gKGlucHV0LCBzaGFsbG93LCBvdXRwdXQpIHsKICAgIGlmIChzaGFsbG93ICYmIF8uZXZlcnkoaW5wdXQsIF8uaXNBcnJheSkpIHsKICAgICAgcmV0dXJuIGNvbmNhdC5hcHBseShvdXRwdXQsIGlucHV0KTsKICAgIH0KICAgIGVhY2goaW5wdXQsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSB8fCBfLmlzQXJndW1lbnRzKHZhbHVlKSkgewogICAgICAgIHNoYWxsb3cgPyBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpIDogZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgb3V0cHV0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwogIC8vIEZsYXR0ZW4gb3V0IGFuIGFycmF5LCBlaXRoZXIgcmVjdXJzaXZlbHkgKGJ5IGRlZmF1bHQpLCBvciBqdXN0IG9uZSBsZXZlbC4KICBfLmZsYXR0ZW4gPSBmdW5jdGlvbiAoYXJyYXksIHNoYWxsb3cpIHsKICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBbXSk7CiAgfTsKICAvLyBSZXR1cm4gYSB2ZXJzaW9uIG9mIHRoZSBhcnJheSB0aGF0IGRvZXMgbm90IGNvbnRhaW4gdGhlIHNwZWNpZmllZCB2YWx1ZShzKS4KICBfLndpdGhvdXQgPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgIHJldHVybiBfLmRpZmZlcmVuY2UoYXJyYXksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfTsKICAvLyBTcGxpdCBhbiBhcnJheSBpbnRvIHR3byBhcnJheXM6IG9uZSB3aG9zZSBlbGVtZW50cyBhbGwgc2F0aXNmeSB0aGUgZ2l2ZW4KICAvLyBwcmVkaWNhdGUsIGFuZCBvbmUgd2hvc2UgZWxlbWVudHMgYWxsIGRvIG5vdCBzYXRpc2Z5IHRoZSBwcmVkaWNhdGUuCiAgXy5wYXJ0aXRpb24gPSBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSkgewogICAgdmFyIHBhc3MgPSBbXSwgZmFpbCA9IFtdOwogICAgZWFjaChhcnJheSwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgKHByZWRpY2F0ZShlbGVtKSA/IHBhc3MgOiBmYWlsKS5wdXNoKGVsZW0pOwogICAgfSk7CiAgICByZXR1cm4gWwogICAgICBwYXNzLAogICAgICBmYWlsCiAgICBdOwogIH07CiAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKICAvLyBiZWVuIHNvcnRlZCwgeW91IGhhdmUgdGhlIG9wdGlvbiBvZiB1c2luZyBhIGZhc3RlciBhbGdvcml0aG0uCiAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uIChhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGlzU29ydGVkKSkgewogICAgICBjb250ZXh0ID0gaXRlcmF0b3I7CiAgICAgIGl0ZXJhdG9yID0gaXNTb3J0ZWQ7CiAgICAgIGlzU29ydGVkID0gZmFsc2U7CiAgICB9CiAgICB2YXIgaW5pdGlhbCA9IGl0ZXJhdG9yID8gXy5tYXAoYXJyYXksIGl0ZXJhdG9yLCBjb250ZXh0KSA6IGFycmF5OwogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBzZWVuID0gW107CiAgICBlYWNoKGluaXRpYWwsIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgaWYgKGlzU29ydGVkID8gIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gdmFsdWUgOiAhXy5jb250YWlucyhzZWVuLCB2YWx1ZSkpIHsKICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIHJlc3VsdHMucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CiAgLy8gUHJvZHVjZSBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIHRoZSB1bmlvbjogZWFjaCBkaXN0aW5jdCBlbGVtZW50IGZyb20gYWxsIG9mCiAgLy8gdGhlIHBhc3NlZC1pbiBhcnJheXMuCiAgXy51bmlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBfLnVuaXEoXy5mbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSkpOwogIH07CiAgLy8gUHJvZHVjZSBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIGV2ZXJ5IGl0ZW0gc2hhcmVkIGJldHdlZW4gYWxsIHRoZQogIC8vIHBhc3NlZC1pbiBhcnJheXMuCiAgXy5pbnRlcnNlY3Rpb24gPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgIHZhciByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIF8uZmlsdGVyKF8udW5pcShhcnJheSksIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiBfLmV2ZXJ5KHJlc3QsIGZ1bmN0aW9uIChvdGhlcikgewogICAgICAgIHJldHVybiBfLmNvbnRhaW5zKG90aGVyLCBpdGVtKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uIChhcnJheSkgewogICAgdmFyIHJlc3QgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7CiAgICB9KTsKICB9OwogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsZW5ndGggPSBfLm1heChfLnBsdWNrKGFyZ3VtZW50cywgJ2xlbmd0aCcpLmNvbmNhdCgwKSk7CiAgICB2YXIgcmVzdWx0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICByZXN1bHRzW2ldID0gXy5wbHVjayhhcmd1bWVudHMsICcnICsgaSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbiAobGlzdCwgdmFsdWVzKSB7CiAgICBpZiAobGlzdCA9PSBudWxsKQogICAgICByZXR1cm4ge307CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gbGlzdC5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBpZiAodmFsdWVzKSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1dID0gdmFsdWVzW2ldOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdFtsaXN0W2ldWzBdXSA9IGxpc3RbaV1bMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyBJZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBseSB1cyB3aXRoIGluZGV4T2YgKEknbSBsb29raW5nIGF0IHlvdSwgKipNU0lFKiopLAogIC8vIHdlIG5lZWQgdGhpcyBmdW5jdGlvbi4gUmV0dXJuIHRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhbgogIC8vIGl0ZW0gaW4gYW4gYXJyYXksIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uIChhcnJheSwgaXRlbSwgaXNTb3J0ZWQpIHsKICAgIGlmIChhcnJheSA9PSBudWxsKQogICAgICByZXR1cm4gLTE7CiAgICB2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChpc1NvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CiAgICAgICAgaSA9IGlzU29ydGVkIDwgMCA/IE1hdGgubWF4KDAsIGxlbmd0aCArIGlzU29ydGVkKSA6IGlzU29ydGVkOwogICAgICB9IGVsc2UgewogICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKICAgICAgICByZXR1cm4gYXJyYXlbaV0gPT09IGl0ZW0gPyBpIDogLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChuYXRpdmVJbmRleE9mICYmIGFycmF5LmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpCiAgICAgIHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0sIGlzU29ydGVkKTsKICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspCiAgICAgIGlmIChhcnJheVtpXSA9PT0gaXRlbSkKICAgICAgICByZXR1cm4gaTsKICAgIHJldHVybiAtMTsKICB9OwogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBsYXN0SW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbiAoYXJyYXksIGl0ZW0sIGZyb20pIHsKICAgIGlmIChhcnJheSA9PSBudWxsKQogICAgICByZXR1cm4gLTE7CiAgICB2YXIgaGFzSW5kZXggPSBmcm9tICE9IG51bGw7CiAgICBpZiAobmF0aXZlTGFzdEluZGV4T2YgJiYgYXJyYXkubGFzdEluZGV4T2YgPT09IG5hdGl2ZUxhc3RJbmRleE9mKSB7CiAgICAgIHJldHVybiBoYXNJbmRleCA/IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0sIGZyb20pIDogYXJyYXkubGFzdEluZGV4T2YoaXRlbSk7CiAgICB9CiAgICB2YXIgaSA9IGhhc0luZGV4ID8gZnJvbSA6IGFycmF5Lmxlbmd0aDsKICAgIHdoaWxlIChpLS0pCiAgICAgIGlmIChhcnJheVtpXSA9PT0gaXRlbSkKICAgICAgICByZXR1cm4gaTsKICAgIHJldHVybiAtMTsKICB9OwogIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKICAvLyB0aGUgbmF0aXZlIFB5dGhvbiBgcmFuZ2UoKWAgZnVuY3Rpb24uIFNlZQogIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCiAgXy5yYW5nZSA9IGZ1bmN0aW9uIChzdGFydCwgc3RvcCwgc3RlcCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMSkgewogICAgICBzdG9wID0gc3RhcnQgfHwgMDsKICAgICAgc3RhcnQgPSAwOwogICAgfQogICAgc3RlcCA9IGFyZ3VtZW50c1syXSB8fCAxOwogICAgdmFyIGxlbmd0aCA9IE1hdGgubWF4KE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApLCAwKTsKICAgIHZhciBpZHggPSAwOwogICAgdmFyIHJhbmdlID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICB3aGlsZSAoaWR4IDwgbGVuZ3RoKSB7CiAgICAgIHJhbmdlW2lkeCsrXSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQogICAgcmV0dXJuIHJhbmdlOwogIH07CiAgLy8gRnVuY3Rpb24gKGFoZW0pIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIFJldXNhYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciBwcm90b3R5cGUgc2V0dGluZy4KICB2YXIgY3RvciA9IGZ1bmN0aW9uICgpIHsKICB9OwogIC8vIENyZWF0ZSBhIGZ1bmN0aW9uIGJvdW5kIHRvIGEgZ2l2ZW4gb2JqZWN0IChhc3NpZ25pbmcgYHRoaXNgLCBhbmQgYXJndW1lbnRzLAogIC8vIG9wdGlvbmFsbHkpLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgRnVuY3Rpb24uYmluZGAgaWYKICAvLyBhdmFpbGFibGUuCiAgXy5iaW5kID0gZnVuY3Rpb24gKGZ1bmMsIGNvbnRleHQpIHsKICAgIHZhciBhcmdzLCBib3VuZDsKICAgIGlmIChuYXRpdmVCaW5kICYmIGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCkKICAgICAgcmV0dXJuIG5hdGl2ZUJpbmQuYXBwbHkoZnVuYywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGlmICghXy5pc0Z1bmN0aW9uKGZ1bmMpKQogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgYm91bmQpKQogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBjdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICB2YXIgc2VsZiA9IG5ldyBjdG9yKCk7CiAgICAgIGN0b3IucHJvdG90eXBlID0gbnVsbDsKICAgICAgdmFyIHJlc3VsdCA9IGZ1bmMuYXBwbHkoc2VsZiwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIGlmIChPYmplY3QocmVzdWx0KSA9PT0gcmVzdWx0KQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIHJldHVybiBzZWxmOwogICAgfTsKICB9OwogIC8vIFBhcnRpYWxseSBhcHBseSBhIGZ1bmN0aW9uIGJ5IGNyZWF0aW5nIGEgdmVyc2lvbiB0aGF0IGhhcyBoYWQgc29tZSBvZiBpdHMKICAvLyBhcmd1bWVudHMgcHJlLWZpbGxlZCwgd2l0aG91dCBjaGFuZ2luZyBpdHMgZHluYW1pYyBgdGhpc2AgY29udGV4dC4gXyBhY3RzCiAgLy8gYXMgYSBwbGFjZWhvbGRlciwgYWxsb3dpbmcgYW55IGNvbWJpbmF0aW9uIG9mIGFyZ3VtZW50cyB0byBiZSBwcmUtZmlsbGVkLgogIF8ucGFydGlhbCA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICB2YXIgYm91bmRBcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHBvc2l0aW9uID0gMDsKICAgICAgdmFyIGFyZ3MgPSBib3VuZEFyZ3Muc2xpY2UoKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoYXJnc1tpXSA9PT0gXykKICAgICAgICAgIGFyZ3NbaV0gPSBhcmd1bWVudHNbcG9zaXRpb24rK107CiAgICAgIH0KICAgICAgd2hpbGUgKHBvc2l0aW9uIDwgYXJndW1lbnRzLmxlbmd0aCkKICAgICAgICBhcmdzLnB1c2goYXJndW1lbnRzW3Bvc2l0aW9uKytdKTsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CiAgLy8gQmluZCBhIG51bWJlciBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBSZW1haW5pbmcgYXJndW1lbnRzCiAgLy8gYXJlIHRoZSBtZXRob2QgbmFtZXMgdG8gYmUgYm91bmQuIFVzZWZ1bCBmb3IgZW5zdXJpbmcgdGhhdCBhbGwgY2FsbGJhY2tzCiAgLy8gZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgogIF8uYmluZEFsbCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBmdW5jcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIGlmIChmdW5jcy5sZW5ndGggPT09IDApCiAgICAgIHRocm93IG5ldyBFcnJvcignYmluZEFsbCBtdXN0IGJlIHBhc3NlZCBmdW5jdGlvbiBuYW1lcycpOwogICAgZWFjaChmdW5jcywgZnVuY3Rpb24gKGYpIHsKICAgICAgb2JqW2ZdID0gXy5iaW5kKG9ialtmXSwgb2JqKTsKICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwogIC8vIE1lbW9pemUgYW4gZXhwZW5zaXZlIGZ1bmN0aW9uIGJ5IHN0b3JpbmcgaXRzIHJlc3VsdHMuCiAgXy5tZW1vaXplID0gZnVuY3Rpb24gKGZ1bmMsIGhhc2hlcikgewogICAgdmFyIG1lbW8gPSB7fTsKICAgIGhhc2hlciB8fCAoaGFzaGVyID0gXy5pZGVudGl0eSk7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICB2YXIga2V5ID0gaGFzaGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBfLmhhcyhtZW1vLCBrZXkpID8gbWVtb1trZXldIDogbWVtb1trZXldID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9OwogIC8vIERlbGF5cyBhIGZ1bmN0aW9uIGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kIHRoZW4gY2FsbHMKICAvLyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgc3VwcGxpZWQuCiAgXy5kZWxheSA9IGZ1bmN0aW9uIChmdW5jLCB3YWl0KSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkobnVsbCwgYXJncyk7CiAgICB9LCB3YWl0KTsKICB9OwogIC8vIERlZmVycyBhIGZ1bmN0aW9uLCBzY2hlZHVsaW5nIGl0IHRvIHJ1biBhZnRlciB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcwogIC8vIGNsZWFyZWQuCiAgXy5kZWZlciA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICByZXR1cm4gXy5kZWxheS5hcHBseShfLCBbCiAgICAgIGZ1bmMsCiAgICAgIDEKICAgIF0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpOwogIH07CiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCB3aGVuIGludm9rZWQsIHdpbGwgb25seSBiZSB0cmlnZ2VyZWQgYXQgbW9zdCBvbmNlCiAgLy8gZHVyaW5nIGEgZ2l2ZW4gd2luZG93IG9mIHRpbWUuIE5vcm1hbGx5LCB0aGUgdGhyb3R0bGVkIGZ1bmN0aW9uIHdpbGwgcnVuCiAgLy8gYXMgbXVjaCBhcyBpdCBjYW4sIHdpdGhvdXQgZXZlciBnb2luZyBtb3JlIHRoYW4gb25jZSBwZXIgYHdhaXRgIGR1cmF0aW9uOwogIC8vIGJ1dCBpZiB5b3UnZCBsaWtlIHRvIGRpc2FibGUgdGhlIGV4ZWN1dGlvbiBvbiB0aGUgbGVhZGluZyBlZGdlLCBwYXNzCiAgLy8gYHtsZWFkaW5nOiBmYWxzZX1gLiBUbyBkaXNhYmxlIGV4ZWN1dGlvbiBvbiB0aGUgdHJhaWxpbmcgZWRnZSwgZGl0dG8uCiAgXy50aHJvdHRsZSA9IGZ1bmN0aW9uIChmdW5jLCB3YWl0LCBvcHRpb25zKSB7CiAgICB2YXIgY29udGV4dCwgYXJncywgcmVzdWx0OwogICAgdmFyIHRpbWVvdXQgPSBudWxsOwogICAgdmFyIHByZXZpb3VzID0gMDsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHByZXZpb3VzID0gb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSA/IDAgOiBfLm5vdygpOwogICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBub3cgPSBfLm5vdygpOwogICAgICBpZiAoIXByZXZpb3VzICYmIG9wdGlvbnMubGVhZGluZyA9PT0gZmFsc2UpCiAgICAgICAgcHJldmlvdXMgPSBub3c7CiAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGlmIChyZW1haW5pbmcgPD0gMCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBwcmV2aW91cyA9IG5vdzsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKICAgICAgfSBlbHNlIGlmICghdGltZW91dCAmJiBvcHRpb25zLnRyYWlsaW5nICE9PSBmYWxzZSkgewogICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAogIC8vIGJlIHRyaWdnZXJlZC4gVGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGl0IHN0b3BzIGJlaW5nIGNhbGxlZCBmb3IKICAvLyBOIG1pbGxpc2Vjb25kcy4gSWYgYGltbWVkaWF0ZWAgaXMgcGFzc2VkLCB0cmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUKICAvLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLgogIF8uZGVib3VuY2UgPSBmdW5jdGlvbiAoZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICB2YXIgdGltZW91dCwgYXJncywgY29udGV4dCwgdGltZXN0YW1wLCByZXN1bHQ7CiAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBsYXN0ID0gXy5ub3coKSAtIHRpbWVzdGFtcDsKICAgICAgaWYgKGxhc3QgPCB3YWl0KSB7CiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQgLSBsYXN0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAoIWltbWVkaWF0ZSkgewogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdGltZXN0YW1wID0gXy5ub3coKTsKICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGlmICghdGltZW91dCkgewogICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgfQogICAgICBpZiAoY2FsbE5vdykgewogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CiAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KICBfLm9uY2UgPSBmdW5jdGlvbiAoZnVuYykgewogICAgdmFyIHJhbiA9IGZhbHNlLCBtZW1vOwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHJhbikKICAgICAgICByZXR1cm4gbWVtbzsKICAgICAgcmFuID0gdHJ1ZTsKICAgICAgbWVtbyA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgZnVuYyA9IG51bGw7CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICB9OwogIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAogIC8vIGFsbG93aW5nIHlvdSB0byBhZGp1c3QgYXJndW1lbnRzLCBydW4gY29kZSBiZWZvcmUgYW5kIGFmdGVyLCBhbmQKICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogIF8ud3JhcCA9IGZ1bmN0aW9uIChmdW5jLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gXy5wYXJ0aWFsKHdyYXBwZXIsIGZ1bmMpOwogIH07CiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgaXMgdGhlIGNvbXBvc2l0aW9uIG9mIGEgbGlzdCBvZiBmdW5jdGlvbnMsIGVhY2gKICAvLyBjb25zdW1pbmcgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCBmb2xsb3dzLgogIF8uY29tcG9zZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICBmb3IgKHZhciBpID0gZnVuY3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgfQogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH07CiAgfTsKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCiAgXy5hZnRlciA9IGZ1bmN0aW9uICh0aW1lcywgZnVuYykgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKC0tdGltZXMgPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9OwogIC8vIE9iamVjdCBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgLy8gUmV0cmlldmUgdGhlIG5hbWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYE9iamVjdC5rZXlzYAogIF8ua2V5cyA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmICghXy5pc09iamVjdChvYmopKQogICAgICByZXR1cm4gW107CiAgICBpZiAobmF0aXZlS2V5cykKICAgICAgcmV0dXJuIG5hdGl2ZUtleXMob2JqKTsKICAgIHZhciBrZXlzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKQogICAgICBpZiAoXy5oYXMob2JqLCBrZXkpKQogICAgICAgIGtleXMucHVzaChrZXkpOwogICAgcmV0dXJuIGtleXM7CiAgfTsKICAvLyBSZXRyaWV2ZSB0aGUgdmFsdWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgXy52YWx1ZXMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgdmFyIHZhbHVlcyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YWx1ZXNbaV0gPSBvYmpba2V5c1tpXV07CiAgICB9CiAgICByZXR1cm4gdmFsdWVzOwogIH07CiAgLy8gQ29udmVydCBhbiBvYmplY3QgaW50byBhIGxpc3Qgb2YgYFtrZXksIHZhbHVlXWAgcGFpcnMuCiAgXy5wYWlycyA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICB2YXIgcGFpcnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcGFpcnNbaV0gPSBbCiAgICAgICAga2V5c1tpXSwKICAgICAgICBvYmpba2V5c1tpXV0KICAgICAgXTsKICAgIH0KICAgIHJldHVybiBwYWlyczsKICB9OwogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICByZXN1bHRbb2JqW2tleXNbaV1dXSA9IGtleXNbaV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgbmFtZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihvYmpba2V5XSkpCiAgICAgICAgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwogIC8vIEV4dGVuZCBhIGdpdmVuIG9iamVjdCB3aXRoIGFsbCB0aGUgcHJvcGVydGllcyBpbiBwYXNzZWQtaW4gb2JqZWN0KHMpLgogIF8uZXh0ZW5kID0gZnVuY3Rpb24gKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgb25seSBjb250YWluaW5nIHRoZSB3aGl0ZWxpc3RlZCBwcm9wZXJ0aWVzLgogIF8ucGljayA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZWFjaChrZXlzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKQogICAgICAgIGNvcHlba2V5XSA9IG9ialtrZXldOwogICAgfSk7CiAgICByZXR1cm4gY29weTsKICB9OwogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgogIF8ub21pdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoIV8uY29udGFpbnMoa2V5cywga2V5KSkKICAgICAgICBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CiAgLy8gRmlsbCBpbiBhIGdpdmVuIG9iamVjdCB3aXRoIGRlZmF1bHQgcHJvcGVydGllcy4KICBfLmRlZmF1bHRzID0gZnVuY3Rpb24gKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICBpZiAob2JqW3Byb3BdID09PSB2b2lkIDApCiAgICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwogIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KICBfLmNsb25lID0gZnVuY3Rpb24gKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpCiAgICAgIHJldHVybiBvYmo7CiAgICByZXR1cm4gXy5pc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IF8uZXh0ZW5kKHt9LCBvYmopOwogIH07CiAgLy8gSW52b2tlcyBpbnRlcmNlcHRvciB3aXRoIHRoZSBvYmosIGFuZCB0aGVuIHJldHVybnMgb2JqLgogIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICBfLnRhcCA9IGZ1bmN0aW9uIChvYmosIGludGVyY2VwdG9yKSB7CiAgICBpbnRlcmNlcHRvcihvYmopOwogICAgcmV0dXJuIG9iajsKICB9OwogIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCiAgdmFyIGVxID0gZnVuY3Rpb24gKGEsIGIsIGFTdGFjaywgYlN0YWNrKSB7CiAgICAvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCiAgICAvLyBTZWUgdGhlIFtIYXJtb255IGBlZ2FsYCBwcm9wb3NhbF0oaHR0cDovL3dpa2kuZWNtYXNjcmlwdC5vcmcvZG9rdS5waHA/aWQ9aGFybW9ueTplZ2FsKS4KICAgIGlmIChhID09PSBiKQogICAgICByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PSAxIC8gYjsKICAgIC8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKQogICAgICByZXR1cm4gYSA9PT0gYjsKICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgogICAgaWYgKGEgaW5zdGFuY2VvZiBfKQogICAgICBhID0gYS5fd3JhcHBlZDsKICAgIGlmIChiIGluc3RhbmNlb2YgXykKICAgICAgYiA9IGIuX3dyYXBwZWQ7CiAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CiAgICBpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAvLyBTdHJpbmdzLCBudW1iZXJzLCBkYXRlcywgYW5kIGJvb2xlYW5zIGFyZSBjb21wYXJlZCBieSB2YWx1ZS4KICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CiAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwogICAgICAvLyBlcXVpdmFsZW50IHRvIGBuZXcgU3RyaW5nKCI1IilgLgogICAgICByZXR1cm4gYSA9PSBTdHJpbmcoYik7CiAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgogICAgICAvLyBgTmFOYHMgYXJlIGVxdWl2YWxlbnQsIGJ1dCBub24tcmVmbGV4aXZlLiBBbiBgZWdhbGAgY29tcGFyaXNvbiBpcyBwZXJmb3JtZWQgZm9yCiAgICAgIC8vIG90aGVyIG51bWVyaWMgdmFsdWVzLgogICAgICByZXR1cm4gYSAhPSArYSA/IGIgIT0gK2IgOiBhID09IDAgPyAxIC8gYSA9PSAxIC8gYiA6IGEgPT0gK2I7CiAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoKICAgIGNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgogICAgICAvLyBDb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWVyaWMgcHJpbWl0aXZlIHZhbHVlcy4gRGF0ZXMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyCiAgICAgIC8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKICAgICAgLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgogICAgICByZXR1cm4gK2EgPT0gK2I7CiAgICAvLyBSZWdFeHBzIGFyZSBjb21wYXJlZCBieSB0aGVpciBzb3VyY2UgcGF0dGVybnMgYW5kIGZsYWdzLgogICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKICAgICAgcmV0dXJuIGEuc291cmNlID09IGIuc291cmNlICYmIGEuZ2xvYmFsID09IGIuZ2xvYmFsICYmIGEubXVsdGlsaW5lID09IGIubXVsdGlsaW5lICYmIGEuaWdub3JlQ2FzZSA9PSBiLmlnbm9yZUNhc2U7CiAgICB9CiAgICBpZiAodHlwZW9mIGEgIT0gJ29iamVjdCcgfHwgdHlwZW9mIGIgIT0gJ29iamVjdCcpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIC8vIEFzc3VtZSBlcXVhbGl0eSBmb3IgY3ljbGljIHN0cnVjdHVyZXMuIFRoZSBhbGdvcml0aG0gZm9yIGRldGVjdGluZyBjeWNsaWMKICAgIC8vIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMSBzZWN0aW9uIDE1LjEyLjMsIGFic3RyYWN0IG9wZXJhdGlvbiBgSk9gLgogICAgdmFyIGxlbmd0aCA9IGFTdGFjay5sZW5ndGg7CiAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgLy8gTGluZWFyIHNlYXJjaC4gUGVyZm9ybWFuY2UgaXMgaW52ZXJzZWx5IHByb3BvcnRpb25hbCB0byB0aGUgbnVtYmVyIG9mCiAgICAgIC8vIHVuaXF1ZSBuZXN0ZWQgc3RydWN0dXJlcy4KICAgICAgaWYgKGFTdGFja1tsZW5ndGhdID09IGEpCiAgICAgICAgcmV0dXJuIGJTdGFja1tsZW5ndGhdID09IGI7CiAgICB9CiAgICAvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKICAgIC8vIGZyb20gZGlmZmVyZW50IGZyYW1lcyBhcmUuCiAgICB2YXIgYUN0b3IgPSBhLmNvbnN0cnVjdG9yLCBiQ3RvciA9IGIuY29uc3RydWN0b3I7CiAgICBpZiAoYUN0b3IgIT09IGJDdG9yICYmICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiBhQ3RvciBpbnN0YW5jZW9mIGFDdG9yICYmIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgYkN0b3IgaW5zdGFuY2VvZiBiQ3RvcikgJiYgKCdjb25zdHJ1Y3RvcicgaW4gYSAmJiAnY29uc3RydWN0b3InIGluIGIpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8vIEFkZCB0aGUgZmlyc3Qgb2JqZWN0IHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wdXNoKGEpOwogICAgYlN0YWNrLnB1c2goYik7CiAgICB2YXIgc2l6ZSA9IDAsIHJlc3VsdCA9IHRydWU7CiAgICAvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KICAgIGlmIChjbGFzc05hbWUgPT0gJ1tvYmplY3QgQXJyYXldJykgewogICAgICAvLyBDb21wYXJlIGFycmF5IGxlbmd0aHMgdG8gZGV0ZXJtaW5lIGlmIGEgZGVlcCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeS4KICAgICAgc2l6ZSA9IGEubGVuZ3RoOwogICAgICByZXN1bHQgPSBzaXplID09IGIubGVuZ3RoOwogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgLy8gRGVlcCBjb21wYXJlIHRoZSBjb250ZW50cywgaWdub3Jpbmcgbm9uLW51bWVyaWMgcHJvcGVydGllcy4KICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBlcShhW3NpemVdLCBiW3NpemVdLCBhU3RhY2ssIGJTdGFjaykpKQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIERlZXAgY29tcGFyZSBvYmplY3RzLgogICAgICBmb3IgKHZhciBrZXkgaW4gYSkgewogICAgICAgIGlmIChfLmhhcyhhLCBrZXkpKSB7CiAgICAgICAgICAvLyBDb3VudCB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgICAgICBzaXplKys7CiAgICAgICAgICAvLyBEZWVwIGNvbXBhcmUgZWFjaCBtZW1iZXIuCiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBfLmhhcyhiLCBrZXkpICYmIGVxKGFba2V5XSwgYltrZXldLCBhU3RhY2ssIGJTdGFjaykpKQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICBmb3IgKGtleSBpbiBiKSB7CiAgICAgICAgICBpZiAoXy5oYXMoYiwga2V5KSAmJiAhc2l6ZS0tKQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgIH0KICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnBvcCgpOwogICAgYlN0YWNrLnBvcCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIC8vIFBlcmZvcm0gYSBkZWVwIGNvbXBhcmlzb24gdG8gY2hlY2sgaWYgdHdvIG9iamVjdHMgYXJlIGVxdWFsLgogIF8uaXNFcXVhbCA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKICB9OwogIC8vIElzIGEgZ2l2ZW4gYXJyYXksIHN0cmluZywgb3Igb2JqZWN0IGVtcHR5PwogIC8vIEFuICJlbXB0eSIgb2JqZWN0IGhhcyBubyBlbnVtZXJhYmxlIG93bi1wcm9wZXJ0aWVzLgogIF8uaXNFbXB0eSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIHRydWU7CiAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopKQogICAgICByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIGZvciAodmFyIGtleSBpbiBvYmopCiAgICAgIGlmIChfLmhhcyhvYmosIGtleSkpCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfTsKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGEgRE9NIGVsZW1lbnQ/CiAgXy5pc0VsZW1lbnQgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMSk7CiAgfTsKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGFuIGFycmF5PwogIC8vIERlbGVnYXRlcyB0byBFQ01BNSdzIG5hdGl2ZSBBcnJheS5pc0FycmF5CiAgXy5pc0FycmF5ID0gbmF0aXZlSXNBcnJheSB8fCBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIGFuIG9iamVjdD8KICBfLmlzT2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gT2JqZWN0KG9iaik7CiAgfTsKICAvLyBBZGQgc29tZSBpc1R5cGUgbWV0aG9kczogaXNBcmd1bWVudHMsIGlzRnVuY3Rpb24sIGlzU3RyaW5nLCBpc051bWJlciwgaXNEYXRlLCBpc1JlZ0V4cC4KICBlYWNoKFsKICAgICdBcmd1bWVudHMnLAogICAgJ0Z1bmN0aW9uJywKICAgICdTdHJpbmcnLAogICAgJ051bWJlcicsCiAgICAnRGF0ZScsCiAgICAnUmVnRXhwJwogIF0sIGZ1bmN0aW9uIChuYW1lKSB7CiAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCAnICsgbmFtZSArICddJzsKICAgIH07CiAgfSk7CiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiAhIShvYmogJiYgXy5oYXMob2JqLCAnY2FsbGVlJykpOwogICAgfTsKICB9CiAgLy8gT3B0aW1pemUgYGlzRnVuY3Rpb25gIGlmIGFwcHJvcHJpYXRlLgogIGlmICh0eXBlb2YgLy4vICE9PSAnZnVuY3Rpb24nKSB7CiAgICBfLmlzRnVuY3Rpb24gPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nOwogICAgfTsKICB9CiAgLy8gSXMgYSBnaXZlbiBvYmplY3QgYSBmaW5pdGUgbnVtYmVyPwogIF8uaXNGaW5pdGUgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gaXNGaW5pdGUob2JqKSAmJiAhaXNOYU4ocGFyc2VGbG9hdChvYmopKTsKICB9OwogIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KICBfLmlzTmFOID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIF8uaXNOdW1iZXIob2JqKSAmJiBvYmogIT0gK29iajsKICB9OwogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdHJ1ZSB8fCBvYmogPT09IGZhbHNlIHx8IHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBCb29sZWFuXSc7CiAgfTsKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGVxdWFsIHRvIG51bGw/CiAgXy5pc051bGwgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSBudWxsOwogIH07CiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CiAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBvYmogPT09IHZvaWQgMDsKICB9OwogIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKICAvLyBvbiBpdHNlbGYgKGluIG90aGVyIHdvcmRzLCBub3Qgb24gYSBwcm90b3R5cGUpLgogIF8uaGFzID0gZnVuY3Rpb24gKG9iaiwga2V5KSB7CiAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSk7CiAgfTsKICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tCiAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwogIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICByb290Ll8gPSBwcmV2aW91c1VuZGVyc2NvcmU7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRvcnMuCiAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH07CiAgXy5jb25zdGFudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICB9OwogIF8ucHJvcGVydHkgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKG9iaikgewogICAgICByZXR1cm4gb2JqW2tleV07CiAgICB9OwogIH07CiAgLy8gUmV0dXJucyBhIHByZWRpY2F0ZSBmb3IgY2hlY2tpbmcgd2hldGhlciBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gc2V0IG9mIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8ubWF0Y2hlcyA9IGZ1bmN0aW9uIChhdHRycykgewogICAgcmV0dXJuIGZ1bmN0aW9uIChvYmopIHsKICAgICAgaWYgKG9iaiA9PT0gYXR0cnMpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIC8vYXZvaWQgY29tcGFyaW5nIGFuIG9iamVjdCB0byBpdHNlbGYuCiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgIGlmIChhdHRyc1trZXldICE9PSBvYmpba2V5XSkKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CiAgfTsKICAvLyBSdW4gYSBmdW5jdGlvbiAqKm4qKiB0aW1lcy4KICBfLnRpbWVzID0gZnVuY3Rpb24gKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgYWNjdW0gPSBBcnJheShNYXRoLm1heCgwLCBuKSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykKICAgICAgYWNjdW1baV0gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGkpOwogICAgcmV0dXJuIGFjY3VtOwogIH07CiAgLy8gUmV0dXJuIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS4KICBfLnJhbmRvbSA9IGZ1bmN0aW9uIChtaW4sIG1heCkgewogICAgaWYgKG1heCA9PSBudWxsKSB7CiAgICAgIG1heCA9IG1pbjsKICAgICAgbWluID0gMDsKICAgIH0KICAgIHJldHVybiBtaW4gKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpOwogIH07CiAgLy8gQSAocG9zc2libHkgZmFzdGVyKSB3YXkgdG8gZ2V0IHRoZSBjdXJyZW50IHRpbWVzdGFtcCBhcyBhbiBpbnRlZ2VyLgogIF8ubm93ID0gRGF0ZS5ub3cgfHwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIH07CiAgLy8gTGlzdCBvZiBIVE1MIGVudGl0aWVzIGZvciBlc2NhcGluZy4KICB2YXIgZW50aXR5TWFwID0gewogICAgZXNjYXBlOiB7CiAgICAgICcmJzogJyZhbXA7JywKICAgICAgJzwnOiAnJmx0OycsCiAgICAgICc+JzogJyZndDsnLAogICAgICAnIic6ICcmcXVvdDsnLAogICAgICAnXCcnOiAnJiN4Mjc7JwogICAgfQogIH07CiAgZW50aXR5TWFwLnVuZXNjYXBlID0gXy5pbnZlcnQoZW50aXR5TWFwLmVzY2FwZSk7CiAgLy8gUmVnZXhlcyBjb250YWluaW5nIHRoZSBrZXlzIGFuZCB2YWx1ZXMgbGlzdGVkIGltbWVkaWF0ZWx5IGFib3ZlLgogIHZhciBlbnRpdHlSZWdleGVzID0gewogICAgZXNjYXBlOiBuZXcgUmVnRXhwKCdbJyArIF8ua2V5cyhlbnRpdHlNYXAuZXNjYXBlKS5qb2luKCcnKSArICddJywgJ2cnKSwKICAgIHVuZXNjYXBlOiBuZXcgUmVnRXhwKCcoJyArIF8ua2V5cyhlbnRpdHlNYXAudW5lc2NhcGUpLmpvaW4oJ3wnKSArICcpJywgJ2cnKQogIH07CiAgLy8gRnVuY3Rpb25zIGZvciBlc2NhcGluZyBhbmQgdW5lc2NhcGluZyBzdHJpbmdzIHRvL2Zyb20gSFRNTCBpbnRlcnBvbGF0aW9uLgogIF8uZWFjaChbCiAgICAnZXNjYXBlJywKICAgICd1bmVzY2FwZScKICBdLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICBfW21ldGhvZF0gPSBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgIGlmIChzdHJpbmcgPT0gbnVsbCkKICAgICAgICByZXR1cm4gJyc7CiAgICAgIHJldHVybiAoJycgKyBzdHJpbmcpLnJlcGxhY2UoZW50aXR5UmVnZXhlc1ttZXRob2RdLCBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICByZXR1cm4gZW50aXR5TWFwW21ldGhvZF1bbWF0Y2hdOwogICAgICB9KTsKICAgIH07CiAgfSk7CiAgLy8gSWYgdGhlIHZhbHVlIG9mIHRoZSBuYW1lZCBgcHJvcGVydHlgIGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQgd2l0aCB0aGUKICAvLyBgb2JqZWN0YCBhcyBjb250ZXh0OyBvdGhlcndpc2UsIHJldHVybiBpdC4KICBfLnJlc3VsdCA9IGZ1bmN0aW9uIChvYmplY3QsIHByb3BlcnR5KSB7CiAgICBpZiAob2JqZWN0ID09IG51bGwpCiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB2YXIgdmFsdWUgPSBvYmplY3RbcHJvcGVydHldOwogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZS5jYWxsKG9iamVjdCkgOiB2YWx1ZTsKICB9OwogIC8vIEFkZCB5b3VyIG93biBjdXN0b20gZnVuY3Rpb25zIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm1peGluID0gZnVuY3Rpb24gKG9iaikgewogICAgZWFjaChfLmZ1bmN0aW9ucyhvYmopLCBmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgZnVuYyA9IF9bbmFtZV0gPSBvYmpbbmFtZV07CiAgICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX3dyYXBwZWRdOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CiAgICAgIH07CiAgICB9KTsKICB9OwogIC8vIEdlbmVyYXRlIGEgdW5pcXVlIGludGVnZXIgaWQgKHVuaXF1ZSB3aXRoaW4gdGhlIGVudGlyZSBjbGllbnQgc2Vzc2lvbikuCiAgLy8gVXNlZnVsIGZvciB0ZW1wb3JhcnkgRE9NIGlkcy4KICB2YXIgaWRDb3VudGVyID0gMDsKICBfLnVuaXF1ZUlkID0gZnVuY3Rpb24gKHByZWZpeCkgewogICAgdmFyIGlkID0gKytpZENvdW50ZXIgKyAnJzsKICAgIHJldHVybiBwcmVmaXggPyBwcmVmaXggKyBpZCA6IGlkOwogIH07CiAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCiAgLy8gZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgIGV2YWx1YXRlOiAvPCUoW1xzXFNdKz8pJT4vZywKICAgIGludGVycG9sYXRlOiAvPCU9KFtcc1xTXSs/KSU+L2csCiAgICBlc2NhcGU6IC88JS0oW1xzXFNdKz8pJT4vZwogIH07CiAgLy8gV2hlbiBjdXN0b21pemluZyBgdGVtcGxhdGVTZXR0aW5nc2AsIGlmIHlvdSBkb24ndCB3YW50IHRvIGRlZmluZSBhbgogIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KICB2YXIgbm9NYXRjaCA9IC8oLileLzsKICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQogIC8vIHN0cmluZyBsaXRlcmFsLgogIHZhciBlc2NhcGVzID0gewogICAgJ1wnJzogJ1wnJywKICAgICdcXCc6ICdcXCcsCiAgICAnXHInOiAncicsCiAgICAnXG4nOiAnbicsCiAgICAnXHQnOiAndCcsCiAgICAnXHUyMDI4JzogJ3UyMDI4JywKICAgICdcdTIwMjknOiAndTIwMjknCiAgfTsKICB2YXIgZXNjYXBlciA9IC9cXHwnfFxyfFxufFx0fFx1MjAyOHxcdTIwMjkvZzsKICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgogIC8vIFVuZGVyc2NvcmUgdGVtcGxhdGluZyBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMgd2hpdGVzcGFjZSwKICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24gKHRleHQsIGRhdGEsIHNldHRpbmdzKSB7CiAgICB2YXIgcmVuZGVyOwogICAgc2V0dGluZ3MgPSBfLmRlZmF1bHRzKHt9LCBzZXR0aW5ncywgXy50ZW1wbGF0ZVNldHRpbmdzKTsKICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlIHNvdXJjZSwgZXNjYXBpbmcgc3RyaW5nIGxpdGVyYWxzIGFwcHJvcHJpYXRlbHkuCiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNvdXJjZSA9ICdfX3ArPVwnJzsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbiAobWF0Y2gsIGVzY2FwZSwgaW50ZXJwb2xhdGUsIGV2YWx1YXRlLCBvZmZzZXQpIHsKICAgICAgc291cmNlICs9IHRleHQuc2xpY2UoaW5kZXgsIG9mZnNldCkucmVwbGFjZShlc2NhcGVyLCBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICByZXR1cm4gJ1xcJyArIGVzY2FwZXNbbWF0Y2hdOwogICAgICB9KTsKICAgICAgaWYgKGVzY2FwZSkgewogICAgICAgIHNvdXJjZSArPSAnXCcrXG4oKF9fdD0oJyArIGVzY2FwZSArICcpKT09bnVsbD9cJ1wnOl8uZXNjYXBlKF9fdCkpK1xuXCcnOwogICAgICB9CiAgICAgIGlmIChpbnRlcnBvbGF0ZSkgewogICAgICAgIHNvdXJjZSArPSAnXCcrXG4oKF9fdD0oJyArIGludGVycG9sYXRlICsgJykpPT1udWxsP1wnXCc6X190KStcblwnJzsKICAgICAgfQogICAgICBpZiAoZXZhbHVhdGUpIHsKICAgICAgICBzb3VyY2UgKz0gJ1wnO1xuJyArIGV2YWx1YXRlICsgJ1xuX19wKz1cJyc7CiAgICAgIH0KICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwogICAgc291cmNlICs9ICdcJztcbic7CiAgICAvLyBJZiBhIHZhcmlhYmxlIGlzIG5vdCBzcGVjaWZpZWQsIHBsYWNlIGRhdGEgdmFsdWVzIGluIGxvY2FsIHNjb3BlLgogICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkKICAgICAgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CiAgICBzb3VyY2UgPSAndmFyIF9fdCxfX3A9XCdcJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sJyArICdwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLFwnXCcpO307XG4nICsgc291cmNlICsgJ3JldHVybiBfX3A7XG4nOwogICAgdHJ5IHsKICAgICAgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICB0aHJvdyBlOwogICAgfQogICAgaWYgKGRhdGEpCiAgICAgIHJldHVybiByZW5kZXIoZGF0YSwgXyk7CiAgICB2YXIgdGVtcGxhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwogICAgLy8gUHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24gc291cmNlIGFzIGEgY29udmVuaWVuY2UgZm9yIHByZWNvbXBpbGF0aW9uLgogICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyAoc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicpICsgJyl7XG4nICsgc291cmNlICsgJ30nOwogICAgcmV0dXJuIHRlbXBsYXRlOwogIH07CiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbiwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSB0byB0aGUgd3JhcHBlci4KICBfLmNoYWluID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIF8ob2JqKS5jaGFpbigpOwogIH07CiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnRpbnVlIGNoYWluaW5nIGludGVybWVkaWF0ZSByZXN1bHRzLgogIHZhciByZXN1bHQgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwogIC8vIEFkZCBhbGwgb2YgdGhlIFVuZGVyc2NvcmUgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyIG9iamVjdC4KICBfLm1peGluKF8pOwogIC8vIEFkZCBhbGwgbXV0YXRvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbCiAgICAncG9wJywKICAgICdwdXNoJywKICAgICdyZXZlcnNlJywKICAgICdzaGlmdCcsCiAgICAnc29ydCcsCiAgICAnc3BsaWNlJywKICAgICd1bnNoaWZ0JwogIF0sIGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fd3JhcHBlZDsKICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKICAgICAgaWYgKChuYW1lID09ICdzaGlmdCcgfHwgbmFtZSA9PSAnc3BsaWNlJykgJiYgb2JqLmxlbmd0aCA9PT0gMCkKICAgICAgICBkZWxldGUgb2JqWzBdOwogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgb2JqKTsKICAgIH07CiAgfSk7CiAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbCiAgICAnY29uY2F0JywKICAgICdqb2luJywKICAgICdzbGljZScKICBdLCBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CiAgXy5leHRlbmQoXy5wcm90b3R5cGUsIHsKICAgIC8vIFN0YXJ0IGNoYWluaW5nIGEgd3JhcHBlZCBVbmRlcnNjb3JlIG9iamVjdC4KICAgIGNoYWluOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX2NoYWluID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gRXh0cmFjdHMgdGhlIHJlc3VsdCBmcm9tIGEgd3JhcHBlZCBhbmQgY2hhaW5lZCBvYmplY3QuCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICAgIH0KICB9KTsKICAvLyBBTUQgcmVnaXN0cmF0aW9uIGhhcHBlbnMgYXQgdGhlIGVuZCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIEFNRCBsb2FkZXJzCiAgLy8gdGhhdCBtYXkgbm90IGVuZm9yY2UgbmV4dC10dXJuIHNlbWFudGljcyBvbiBtb2R1bGVzLiBFdmVuIHRob3VnaCBnZW5lcmFsCiAgLy8gcHJhY3RpY2UgZm9yIEFNRCByZWdpc3RyYXRpb24gaXMgdG8gYmUgYW5vbnltb3VzLCB1bmRlcnNjb3JlIHJlZ2lzdGVycwogIC8vIGFzIGEgbmFtZWQgbW9kdWxlIGJlY2F1c2UsIGxpa2UgalF1ZXJ5LCBpdCBpcyBhIGJhc2UgbGlicmFyeSB0aGF0IGlzCiAgLy8gcG9wdWxhciBlbm91Z2ggdG8gYmUgYnVuZGxlZCBpbiBhIHRoaXJkIHBhcnR5IGxpYiwgYnV0IG5vdCBiZSBwYXJ0IG9mCiAgLy8gYW4gQU1EIGxvYWQgcmVxdWVzdC4gVGhvc2UgY2FzZXMgY291bGQgZ2VuZXJhdGUgYW4gZXJyb3Igd2hlbiBhbgogIC8vIGFub255bW91cyBkZWZpbmUoKSBpcyBjYWxsZWQgb3V0c2lkZSBvZiBhIGxvYWRlciByZXF1ZXN0LgogIGlmICh0cnVlKSB7CiAgICB1bmRlcnNjb3JlID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gXzsKICAgIH0oKTsKICB9Cn0uY2FsbCh0aGlzKSk7Ci8qIQogKiBqUXVlcnkgSmF2YVNjcmlwdCBMaWJyYXJ5IHYyLjEuMQogKiBodHRwOi8vanF1ZXJ5LmNvbS8KICoKICogSW5jbHVkZXMgU2l6emxlLmpzCiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqCiAqIENvcHlyaWdodCAyMDA1LCAyMDE0IGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogRGF0ZTogMjAxNC0wNS0wMVQxNzoxMVoKICovCihmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CiAgaWYgKHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUuZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKICAgIC8vIEZvciBDb21tb25KUyBhbmQgQ29tbW9uSlMtbGlrZSBlbnZpcm9ubWVudHMgd2hlcmUgYSBwcm9wZXIgd2luZG93IGlzIHByZXNlbnQsCiAgICAvLyBleGVjdXRlIHRoZSBmYWN0b3J5IGFuZCBnZXQgalF1ZXJ5CiAgICAvLyBGb3IgZW52aXJvbm1lbnRzIHRoYXQgZG8gbm90IGluaGVyZW50bHkgcG9zc2VzIGEgd2luZG93IHdpdGggYSBkb2N1bWVudAogICAgLy8gKHN1Y2ggYXMgTm9kZS5qcyksIGV4cG9zZSBhIGpRdWVyeS1tYWtpbmcgZmFjdG9yeSBhcyBtb2R1bGUuZXhwb3J0cwogICAgLy8gVGhpcyBhY2NlbnR1YXRlcyB0aGUgbmVlZCBmb3IgdGhlIGNyZWF0aW9uIG9mIGEgcmVhbCB3aW5kb3cKICAgIC8vIGUuZy4gdmFyIGpRdWVyeSA9IHJlcXVpcmUoImpxdWVyeSIpKHdpbmRvdyk7CiAgICAvLyBTZWUgdGlja2V0ICMxNDU0OSBmb3IgbW9yZSBpbmZvCiAgICBtb2R1bGUuZXhwb3J0cyA9IGdsb2JhbC5kb2N1bWVudCA/IGZhY3RvcnkoZ2xvYmFsLCB0cnVlKSA6IGZ1bmN0aW9uICh3KSB7CiAgICAgIGlmICghdy5kb2N1bWVudCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignalF1ZXJ5IHJlcXVpcmVzIGEgd2luZG93IHdpdGggYSBkb2N1bWVudCcpOwogICAgICB9CiAgICAgIHJldHVybiBmYWN0b3J5KHcpOwogICAgfTsKICB9IGVsc2UgewogICAgZmFjdG9yeShnbG9iYWwpOwogIH0gIC8vIFBhc3MgdGhpcyBpZiB3aW5kb3cgaXMgbm90IGRlZmluZWQgeWV0Cn0odHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgPyB3aW5kb3cgOiB0aGlzLCBmdW5jdGlvbiAod2luZG93LCBub0dsb2JhbCkgewogIC8vIENhbid0IGRvIHRoaXMgYmVjYXVzZSBzZXZlcmFsIGFwcHMgaW5jbHVkaW5nIEFTUC5ORVQgdHJhY2UKICAvLyB0aGUgc3RhY2sgdmlhIGFyZ3VtZW50cy5jYWxsZXIuY2FsbGVlIGFuZCBGaXJlZm94IGRpZXMgaWYKICAvLyB5b3UgdHJ5IHRvIHRyYWNlIHRocm91Z2ggInVzZSBzdHJpY3QiIGNhbGwgY2hhaW5zLiAoIzEzMzM1KQogIC8vIFN1cHBvcnQ6IEZpcmVmb3ggMTgrCiAgLy8KICB2YXIgYXJyID0gW107CiAgdmFyIHNsaWNlID0gYXJyLnNsaWNlOwogIHZhciBjb25jYXQgPSBhcnIuY29uY2F0OwogIHZhciBwdXNoID0gYXJyLnB1c2g7CiAgdmFyIGluZGV4T2YgPSBhcnIuaW5kZXhPZjsKICB2YXIgY2xhc3MydHlwZSA9IHt9OwogIHZhciB0b1N0cmluZyA9IGNsYXNzMnR5cGUudG9TdHJpbmc7CiAgdmFyIGhhc093biA9IGNsYXNzMnR5cGUuaGFzT3duUHJvcGVydHk7CiAgdmFyIHN1cHBvcnQgPSB7fTsKICB2YXIKICAgIC8vIFVzZSB0aGUgY29ycmVjdCBkb2N1bWVudCBhY2NvcmRpbmdseSB3aXRoIHdpbmRvdyBhcmd1bWVudCAoc2FuZGJveCkKICAgIGRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50LCB2ZXJzaW9uID0gJzIuMS4xJywKICAgIC8vIERlZmluZSBhIGxvY2FsIGNvcHkgb2YgalF1ZXJ5CiAgICBqUXVlcnkgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgLy8gVGhlIGpRdWVyeSBvYmplY3QgaXMgYWN0dWFsbHkganVzdCB0aGUgaW5pdCBjb25zdHJ1Y3RvciAnZW5oYW5jZWQnCiAgICAgIC8vIE5lZWQgaW5pdCBpZiBqUXVlcnkgaXMgY2FsbGVkIChqdXN0IGFsbG93IGVycm9yIHRvIGJlIHRocm93biBpZiBub3QgaW5jbHVkZWQpCiAgICAgIHJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoc2VsZWN0b3IsIGNvbnRleHQpOwogICAgfSwKICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQ8NC4xCiAgICAvLyBNYWtlIHN1cmUgd2UgdHJpbSBCT00gYW5kIE5CU1AKICAgIHJ0cmltID0gL15bXHNcdUZFRkZceEEwXSt8W1xzXHVGRUZGXHhBMF0rJC9nLAogICAgLy8gTWF0Y2hlcyBkYXNoZWQgc3RyaW5nIGZvciBjYW1lbGl6aW5nCiAgICBybXNQcmVmaXggPSAvXi1tcy0vLCByZGFzaEFscGhhID0gLy0oW1xkYS16XSkvZ2ksCiAgICAvLyBVc2VkIGJ5IGpRdWVyeS5jYW1lbENhc2UgYXMgY2FsbGJhY2sgdG8gcmVwbGFjZSgpCiAgICBmY2FtZWxDYXNlID0gZnVuY3Rpb24gKGFsbCwgbGV0dGVyKSB7CiAgICAgIHJldHVybiBsZXR0ZXIudG9VcHBlckNhc2UoKTsKICAgIH07CiAgalF1ZXJ5LmZuID0galF1ZXJ5LnByb3RvdHlwZSA9IHsKICAgIC8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKICAgIGpxdWVyeTogdmVyc2lvbiwKICAgIGNvbnN0cnVjdG9yOiBqUXVlcnksCiAgICAvLyBTdGFydCB3aXRoIGFuIGVtcHR5IHNlbGVjdG9yCiAgICBzZWxlY3RvcjogJycsCiAgICAvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDAKICAgIGxlbmd0aDogMCwKICAgIHRvQXJyYXk6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHNsaWNlLmNhbGwodGhpcyk7CiAgICB9LAogICAgLy8gR2V0IHRoZSBOdGggZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldCBPUgogICAgLy8gR2V0IHRoZSB3aG9sZSBtYXRjaGVkIGVsZW1lbnQgc2V0IGFzIGEgY2xlYW4gYXJyYXkKICAgIGdldDogZnVuY3Rpb24gKG51bSkgewogICAgICByZXR1cm4gbnVtICE9IG51bGwgPyBudW0gPCAwID8gdGhpc1tudW0gKyB0aGlzLmxlbmd0aF0gOiB0aGlzW251bV0gOiAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBpbiBhIGNsZWFuIGFycmF5CiAgICAgIHNsaWNlLmNhbGwodGhpcyk7CiAgICB9LAogICAgLy8gVGFrZSBhbiBhcnJheSBvZiBlbGVtZW50cyBhbmQgcHVzaCBpdCBvbnRvIHRoZSBzdGFjawogICAgLy8gKHJldHVybmluZyB0aGUgbmV3IG1hdGNoZWQgZWxlbWVudCBzZXQpCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uIChlbGVtcykgewogICAgICAvLyBCdWlsZCBhIG5ldyBqUXVlcnkgbWF0Y2hlZCBlbGVtZW50IHNldAogICAgICB2YXIgcmV0ID0galF1ZXJ5Lm1lcmdlKHRoaXMuY29uc3RydWN0b3IoKSwgZWxlbXMpOwogICAgICAvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQogICAgICByZXQucHJldk9iamVjdCA9IHRoaXM7CiAgICAgIHJldC5jb250ZXh0ID0gdGhpcy5jb250ZXh0OwogICAgICAvLyBSZXR1cm4gdGhlIG5ld2x5LWZvcm1lZCBlbGVtZW50IHNldAogICAgICByZXR1cm4gcmV0OwogICAgfSwKICAgIC8vIEV4ZWN1dGUgYSBjYWxsYmFjayBmb3IgZXZlcnkgZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBzZXQuCiAgICAvLyAoWW91IGNhbiBzZWVkIHRoZSBhcmd1bWVudHMgd2l0aCBhbiBhcnJheSBvZiBhcmdzLCBidXQgdGhpcyBpcwogICAgLy8gb25seSB1c2VkIGludGVybmFsbHkuKQogICAgZWFjaDogZnVuY3Rpb24gKGNhbGxiYWNrLCBhcmdzKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZWFjaCh0aGlzLCBjYWxsYmFjaywgYXJncyk7CiAgICB9LAogICAgbWFwOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbChlbGVtLCBpLCBlbGVtKTsKICAgICAgfSkpOwogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0sCiAgICBmaXJzdDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5lcSgwKTsKICAgIH0sCiAgICBsYXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmVxKC0xKTsKICAgIH0sCiAgICBlcTogZnVuY3Rpb24gKGkpIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoLCBqID0gK2kgKyAoaSA8IDAgPyBsZW4gOiAwKTsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGogPj0gMCAmJiBqIDwgbGVuID8gW3RoaXNbal1dIDogW10pOwogICAgfSwKICAgIGVuZDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5wcmV2T2JqZWN0IHx8IHRoaXMuY29uc3RydWN0b3IobnVsbCk7CiAgICB9LAogICAgLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgogICAgLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCiAgICBwdXNoOiBwdXNoLAogICAgc29ydDogYXJyLnNvcnQsCiAgICBzcGxpY2U6IGFyci5zcGxpY2UKICB9OwogIGpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIG9wdGlvbnMsIG5hbWUsIHNyYywgY29weSwgY29weUlzQXJyYXksIGNsb25lLCB0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sIGkgPSAxLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLCBkZWVwID0gZmFsc2U7CiAgICAvLyBIYW5kbGUgYSBkZWVwIGNvcHkgc2l0dWF0aW9uCiAgICBpZiAodHlwZW9mIHRhcmdldCA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgIGRlZXAgPSB0YXJnZXQ7CiAgICAgIC8vIHNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKICAgICAgdGFyZ2V0ID0gYXJndW1lbnRzW2ldIHx8IHt9OwogICAgICBpKys7CiAgICB9CiAgICAvLyBIYW5kbGUgY2FzZSB3aGVuIHRhcmdldCBpcyBhIHN0cmluZyBvciBzb21ldGhpbmcgKHBvc3NpYmxlIGluIGRlZXAgY29weSkKICAgIGlmICh0eXBlb2YgdGFyZ2V0ICE9PSAnb2JqZWN0JyAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24odGFyZ2V0KSkgewogICAgICB0YXJnZXQgPSB7fTsKICAgIH0KICAgIC8vIGV4dGVuZCBqUXVlcnkgaXRzZWxmIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAogICAgaWYgKGkgPT09IGxlbmd0aCkgewogICAgICB0YXJnZXQgPSB0aGlzOwogICAgICBpLS07CiAgICB9CiAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIC8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKICAgICAgaWYgKChvcHRpb25zID0gYXJndW1lbnRzW2ldKSAhPSBudWxsKSB7CiAgICAgICAgLy8gRXh0ZW5kIHRoZSBiYXNlIG9iamVjdAogICAgICAgIGZvciAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgICAgICBzcmMgPSB0YXJnZXRbbmFtZV07CiAgICAgICAgICBjb3B5ID0gb3B0aW9uc1tuYW1lXTsKICAgICAgICAgIC8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3AKICAgICAgICAgIGlmICh0YXJnZXQgPT09IGNvcHkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgcGxhaW4gb2JqZWN0cyBvciBhcnJheXMKICAgICAgICAgIGlmIChkZWVwICYmIGNvcHkgJiYgKGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvcHkpIHx8IChjb3B5SXNBcnJheSA9IGpRdWVyeS5pc0FycmF5KGNvcHkpKSkpIHsKICAgICAgICAgICAgaWYgKGNvcHlJc0FycmF5KSB7CiAgICAgICAgICAgICAgY29weUlzQXJyYXkgPSBmYWxzZTsKICAgICAgICAgICAgICBjbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNBcnJheShzcmMpID8gc3JjIDogW107CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSA/IHNyYyA6IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQogICAgICAgICAgICB0YXJnZXRbbmFtZV0gPSBqUXVlcnkuZXh0ZW5kKGRlZXAsIGNsb25lLCBjb3B5KTsgIC8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMKICAgICAgICAgIH0gZWxzZSBpZiAoY29weSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IGNvcHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAogICAgcmV0dXJuIHRhcmdldDsKICB9OwogIGpRdWVyeS5leHRlbmQoewogICAgLy8gVW5pcXVlIGZvciBlYWNoIGNvcHkgb2YgalF1ZXJ5IG9uIHRoZSBwYWdlCiAgICBleHBhbmRvOiAnalF1ZXJ5JyArICh2ZXJzaW9uICsgTWF0aC5yYW5kb20oKSkucmVwbGFjZSgvXEQvZywgJycpLAogICAgLy8gQXNzdW1lIGpRdWVyeSBpcyByZWFkeSB3aXRob3V0IHRoZSByZWFkeSBtb2R1bGUKICAgIGlzUmVhZHk6IHRydWUsCiAgICBlcnJvcjogZnVuY3Rpb24gKG1zZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgIH0sCiAgICBub29wOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gU2VlIHRlc3QvdW5pdC9jb3JlLmpzIGZvciBkZXRhaWxzIGNvbmNlcm5pbmcgaXNGdW5jdGlvbi4KICAgIC8vIFNpbmNlIHZlcnNpb24gMS4zLCBET00gbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGxpa2UgYWxlcnQKICAgIC8vIGFyZW4ndCBzdXBwb3J0ZWQuIFRoZXkgcmV0dXJuIGZhbHNlIG9uIElFICgjMjk2OCkuCiAgICBpc0Z1bmN0aW9uOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAnZnVuY3Rpb24nOwogICAgfSwKICAgIGlzQXJyYXk6IEFycmF5LmlzQXJyYXksCiAgICBpc1dpbmRvdzogZnVuY3Rpb24gKG9iaikgewogICAgICByZXR1cm4gb2JqICE9IG51bGwgJiYgb2JqID09PSBvYmoud2luZG93OwogICAgfSwKICAgIGlzTnVtZXJpYzogZnVuY3Rpb24gKG9iaikgewogICAgICAvLyBwYXJzZUZsb2F0IE5hTnMgbnVtZXJpYy1jYXN0IGZhbHNlIHBvc2l0aXZlcyAobnVsbHx0cnVlfGZhbHNlfCIiKQogICAgICAvLyAuLi5idXQgbWlzaW50ZXJwcmV0cyBsZWFkaW5nLW51bWJlciBzdHJpbmdzLCBwYXJ0aWN1bGFybHkgaGV4IGxpdGVyYWxzICgiMHguLi4iKQogICAgICAvLyBzdWJ0cmFjdGlvbiBmb3JjZXMgaW5maW5pdGllcyB0byBOYU4KICAgICAgcmV0dXJuICFqUXVlcnkuaXNBcnJheShvYmopICYmIG9iaiAtIHBhcnNlRmxvYXQob2JqKSA+PSAwOwogICAgfSwKICAgIGlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgLy8gTm90IHBsYWluIG9iamVjdHM6CiAgICAgIC8vIC0gQW55IG9iamVjdCBvciB2YWx1ZSB3aG9zZSBpbnRlcm5hbCBbW0NsYXNzXV0gcHJvcGVydHkgaXMgbm90ICJbb2JqZWN0IE9iamVjdF0iCiAgICAgIC8vIC0gRE9NIG5vZGVzCiAgICAgIC8vIC0gd2luZG93CiAgICAgIGlmIChqUXVlcnkudHlwZShvYmopICE9PSAnb2JqZWN0JyB8fCBvYmoubm9kZVR5cGUgfHwgalF1ZXJ5LmlzV2luZG93KG9iaikpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciAmJiAhaGFzT3duLmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgJ2lzUHJvdG90eXBlT2YnKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBJZiB0aGUgZnVuY3Rpb24gaGFzbid0IHJldHVybmVkIGFscmVhZHksIHdlJ3JlIGNvbmZpZGVudCB0aGF0CiAgICAgIC8vIHxvYmp8IGlzIGEgcGxhaW4gb2JqZWN0LCBjcmVhdGVkIGJ5IHt9IG9yIGNvbnN0cnVjdGVkIHdpdGggbmV3IE9iamVjdAogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICBpc0VtcHR5T2JqZWN0OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHZhciBuYW1lOwogICAgICBmb3IgKG5hbWUgaW4gb2JqKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIHR5cGU6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIG9iaiArICcnOwogICAgICB9CiAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPCA0LjAsIGlPUyA8IDYgKGZ1bmN0aW9uaXNoIFJlZ0V4cCkKICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicgPyBjbGFzczJ0eXBlW3RvU3RyaW5nLmNhbGwob2JqKV0gfHwgJ29iamVjdCcgOiB0eXBlb2Ygb2JqOwogICAgfSwKICAgIC8vIEV2YWx1YXRlcyBhIHNjcmlwdCBpbiBhIGdsb2JhbCBjb250ZXh0CiAgICBnbG9iYWxFdmFsOiBmdW5jdGlvbiAoY29kZSkgewogICAgICB2YXIgc2NyaXB0LCBpbmRpcmVjdCA9IGV2YWw7CiAgICAgIGNvZGUgPSBqUXVlcnkudHJpbShjb2RlKTsKICAgICAgaWYgKGNvZGUpIHsKICAgICAgICAvLyBJZiB0aGUgY29kZSBpbmNsdWRlcyBhIHZhbGlkLCBwcm9sb2d1ZSBwb3NpdGlvbgogICAgICAgIC8vIHN0cmljdCBtb2RlIHByYWdtYSwgZXhlY3V0ZSBjb2RlIGJ5IGluamVjdGluZyBhCiAgICAgICAgLy8gc2NyaXB0IHRhZyBpbnRvIHRoZSBkb2N1bWVudC4KICAgICAgICBpZiAoY29kZS5pbmRleE9mKCd1c2Ugc3RyaWN0JykgPT09IDEpIHsKICAgICAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogICAgICAgICAgc2NyaXB0LnRleHQgPSBjb2RlOwogICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gT3RoZXJ3aXNlLCBhdm9pZCB0aGUgRE9NIG5vZGUgY3JlYXRpb24sIGluc2VydGlvbgogICAgICAgICAgLy8gYW5kIHJlbW92YWwgYnkgdXNpbmcgYW4gaW5kaXJlY3QgZ2xvYmFsIGV2YWwKICAgICAgICAgIGluZGlyZWN0KGNvZGUpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIC8vIENvbnZlcnQgZGFzaGVkIHRvIGNhbWVsQ2FzZTsgdXNlZCBieSB0aGUgY3NzIGFuZCBkYXRhIG1vZHVsZXMKICAgIC8vIE1pY3Jvc29mdCBmb3Jnb3QgdG8gaHVtcCB0aGVpciB2ZW5kb3IgcHJlZml4ICgjOTU3MikKICAgIGNhbWVsQ2FzZTogZnVuY3Rpb24gKHN0cmluZykgewogICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2Uocm1zUHJlZml4LCAnbXMtJykucmVwbGFjZShyZGFzaEFscGhhLCBmY2FtZWxDYXNlKTsKICAgIH0sCiAgICBub2RlTmFtZTogZnVuY3Rpb24gKGVsZW0sIG5hbWUpIHsKICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICB9LAogICAgLy8gYXJncyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQogICAgZWFjaDogZnVuY3Rpb24gKG9iaiwgY2FsbGJhY2ssIGFyZ3MpIHsKICAgICAgdmFyIHZhbHVlLCBpID0gMCwgbGVuZ3RoID0gb2JqLmxlbmd0aCwgaXNBcnJheSA9IGlzQXJyYXlsaWtlKG9iaik7CiAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgaWYgKGlzQXJyYXkpIHsKICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsdWUgPSBjYWxsYmFjay5hcHBseShvYmpbaV0sIGFyZ3MpOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpIGluIG9iaikgewogICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KG9ialtpXSwgYXJncyk7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gIC8vIEEgc3BlY2lhbCwgZmFzdCwgY2FzZSBmb3IgdGhlIG1vc3QgY29tbW9uIHVzZSBvZiBlYWNoCiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzQXJyYXkpIHsKICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsdWUgPSBjYWxsYmFjay5jYWxsKG9ialtpXSwgaSwgb2JqW2ldKTsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaSBpbiBvYmopIHsKICAgICAgICAgICAgdmFsdWUgPSBjYWxsYmFjay5jYWxsKG9ialtpXSwgaSwgb2JqW2ldKTsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvYmo7CiAgICB9LAogICAgLy8gU3VwcG9ydDogQW5kcm9pZDw0LjEKICAgIHRyaW06IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgIHJldHVybiB0ZXh0ID09IG51bGwgPyAnJyA6ICh0ZXh0ICsgJycpLnJlcGxhY2UocnRyaW0sICcnKTsKICAgIH0sCiAgICAvLyByZXN1bHRzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgICBtYWtlQXJyYXk6IGZ1bmN0aW9uIChhcnIsIHJlc3VsdHMpIHsKICAgICAgdmFyIHJldCA9IHJlc3VsdHMgfHwgW107CiAgICAgIGlmIChhcnIgIT0gbnVsbCkgewogICAgICAgIGlmIChpc0FycmF5bGlrZShPYmplY3QoYXJyKSkpIHsKICAgICAgICAgIGpRdWVyeS5tZXJnZShyZXQsIHR5cGVvZiBhcnIgPT09ICdzdHJpbmcnID8gW2Fycl0gOiBhcnIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwdXNoLmNhbGwocmV0LCBhcnIpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmV0OwogICAgfSwKICAgIGluQXJyYXk6IGZ1bmN0aW9uIChlbGVtLCBhcnIsIGkpIHsKICAgICAgcmV0dXJuIGFyciA9PSBudWxsID8gLTEgOiBpbmRleE9mLmNhbGwoYXJyLCBlbGVtLCBpKTsKICAgIH0sCiAgICBtZXJnZTogZnVuY3Rpb24gKGZpcnN0LCBzZWNvbmQpIHsKICAgICAgdmFyIGxlbiA9ICtzZWNvbmQubGVuZ3RoLCBqID0gMCwgaSA9IGZpcnN0Lmxlbmd0aDsKICAgICAgZm9yICg7IGogPCBsZW47IGorKykgewogICAgICAgIGZpcnN0W2krK10gPSBzZWNvbmRbal07CiAgICAgIH0KICAgICAgZmlyc3QubGVuZ3RoID0gaTsKICAgICAgcmV0dXJuIGZpcnN0OwogICAgfSwKICAgIGdyZXA6IGZ1bmN0aW9uIChlbGVtcywgY2FsbGJhY2ssIGludmVydCkgewogICAgICB2YXIgY2FsbGJhY2tJbnZlcnNlLCBtYXRjaGVzID0gW10sIGkgPSAwLCBsZW5ndGggPSBlbGVtcy5sZW5ndGgsIGNhbGxiYWNrRXhwZWN0ID0gIWludmVydDsKICAgICAgLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIG9ubHkgc2F2aW5nIHRoZSBpdGVtcwogICAgICAvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgogICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgY2FsbGJhY2tJbnZlcnNlID0gIWNhbGxiYWNrKGVsZW1zW2ldLCBpKTsKICAgICAgICBpZiAoY2FsbGJhY2tJbnZlcnNlICE9PSBjYWxsYmFja0V4cGVjdCkgewogICAgICAgICAgbWF0Y2hlcy5wdXNoKGVsZW1zW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoZXM7CiAgICB9LAogICAgLy8gYXJnIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgICBtYXA6IGZ1bmN0aW9uIChlbGVtcywgY2FsbGJhY2ssIGFyZykgewogICAgICB2YXIgdmFsdWUsIGkgPSAwLCBsZW5ndGggPSBlbGVtcy5sZW5ndGgsIGlzQXJyYXkgPSBpc0FycmF5bGlrZShlbGVtcyksIHJldCA9IFtdOwogICAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXIgbmV3IHZhbHVlcwogICAgICBpZiAoaXNBcnJheSkgewogICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbXNbaV0sIGksIGFyZyk7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICByZXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSAgLy8gR28gdGhyb3VnaCBldmVyeSBrZXkgb24gdGhlIG9iamVjdCwKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGkgaW4gZWxlbXMpIHsKICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbXNbaV0sIGksIGFyZyk7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICByZXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMKICAgICAgcmV0dXJuIGNvbmNhdC5hcHBseShbXSwgcmV0KTsKICAgIH0sCiAgICAvLyBBIGdsb2JhbCBHVUlEIGNvdW50ZXIgZm9yIG9iamVjdHMKICAgIGd1aWQ6IDEsCiAgICAvLyBCaW5kIGEgZnVuY3Rpb24gdG8gYSBjb250ZXh0LCBvcHRpb25hbGx5IHBhcnRpYWxseSBhcHBseWluZyBhbnkKICAgIC8vIGFyZ3VtZW50cy4KICAgIHByb3h5OiBmdW5jdGlvbiAoZm4sIGNvbnRleHQpIHsKICAgICAgdmFyIHRtcCwgYXJncywgcHJveHk7CiAgICAgIGlmICh0eXBlb2YgY29udGV4dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICB0bXAgPSBmbltjb250ZXh0XTsKICAgICAgICBjb250ZXh0ID0gZm47CiAgICAgICAgZm4gPSB0bXA7CiAgICAgIH0KICAgICAgLy8gUXVpY2sgY2hlY2sgdG8gZGV0ZXJtaW5lIGlmIHRhcmdldCBpcyBjYWxsYWJsZSwgaW4gdGhlIHNwZWMKICAgICAgLy8gdGhpcyB0aHJvd3MgYSBUeXBlRXJyb3IsIGJ1dCB3ZSB3aWxsIGp1c3QgcmV0dXJuIHVuZGVmaW5lZC4KICAgICAgaWYgKCFqUXVlcnkuaXNGdW5jdGlvbihmbikpIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIC8vIFNpbXVsYXRlZCBiaW5kCiAgICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgIHByb3h5ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBmbi5hcHBseShjb250ZXh0IHx8IHRoaXMsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICB9OwogICAgICAvLyBTZXQgdGhlIGd1aWQgb2YgdW5pcXVlIGhhbmRsZXIgdG8gdGhlIHNhbWUgb2Ygb3JpZ2luYWwgaGFuZGxlciwgc28gaXQgY2FuIGJlIHJlbW92ZWQKICAgICAgcHJveHkuZ3VpZCA9IGZuLmd1aWQgPSBmbi5ndWlkIHx8IGpRdWVyeS5ndWlkKys7CiAgICAgIHJldHVybiBwcm94eTsKICAgIH0sCiAgICBub3c6IERhdGUubm93LAogICAgLy8galF1ZXJ5LnN1cHBvcnQgaXMgbm90IHVzZWQgaW4gQ29yZSBidXQgb3RoZXIgcHJvamVjdHMgYXR0YWNoIHRoZWlyCiAgICAvLyBwcm9wZXJ0aWVzIHRvIGl0IHNvIGl0IG5lZWRzIHRvIGV4aXN0LgogICAgc3VwcG9ydDogc3VwcG9ydAogIH0pOwogIC8vIFBvcHVsYXRlIHRoZSBjbGFzczJ0eXBlIG1hcAogIGpRdWVyeS5lYWNoKCdCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0IEVycm9yJy5zcGxpdCgnICcpLCBmdW5jdGlvbiAoaSwgbmFtZSkgewogICAgY2xhc3MydHlwZVsnW29iamVjdCAnICsgbmFtZSArICddJ10gPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgfSk7CiAgZnVuY3Rpb24gaXNBcnJheWxpa2Uob2JqKSB7CiAgICB2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aCwgdHlwZSA9IGpRdWVyeS50eXBlKG9iaik7CiAgICBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJyB8fCBqUXVlcnkuaXNXaW5kb3cob2JqKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAob2JqLm5vZGVUeXBlID09PSAxICYmIGxlbmd0aCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiB0eXBlID09PSAnYXJyYXknIHx8IGxlbmd0aCA9PT0gMCB8fCB0eXBlb2YgbGVuZ3RoID09PSAnbnVtYmVyJyAmJiBsZW5ndGggPiAwICYmIGxlbmd0aCAtIDEgaW4gb2JqOwogIH0KICB2YXIgU2l6emxlID0gLyohCiAgICogU2l6emxlIENTUyBTZWxlY3RvciBFbmdpbmUgdjEuMTAuMTkKICAgKiBodHRwOi8vc2l6emxlanMuY29tLwogICAqCiAgICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogICAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQogICAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICAgKgogICAqIERhdGU6IDIwMTQtMDQtMTgKICAgKi8KICBmdW5jdGlvbiAod2luZG93KSB7CiAgICB2YXIgaSwgc3VwcG9ydCwgRXhwciwgZ2V0VGV4dCwgaXNYTUwsIHRva2VuaXplLCBjb21waWxlLCBzZWxlY3QsIG91dGVybW9zdENvbnRleHQsIHNvcnRJbnB1dCwgaGFzRHVwbGljYXRlLAogICAgICAvLyBMb2NhbCBkb2N1bWVudCB2YXJzCiAgICAgIHNldERvY3VtZW50LCBkb2N1bWVudCwgZG9jRWxlbSwgZG9jdW1lbnRJc0hUTUwsIHJidWdneVFTQSwgcmJ1Z2d5TWF0Y2hlcywgbWF0Y2hlcywgY29udGFpbnMsCiAgICAgIC8vIEluc3RhbmNlLXNwZWNpZmljIGRhdGEKICAgICAgZXhwYW5kbyA9ICdzaXp6bGUnICsgLW5ldyBEYXRlKCksIHByZWZlcnJlZERvYyA9IHdpbmRvdy5kb2N1bWVudCwgZGlycnVucyA9IDAsIGRvbmUgPSAwLCBjbGFzc0NhY2hlID0gY3JlYXRlQ2FjaGUoKSwgdG9rZW5DYWNoZSA9IGNyZWF0ZUNhY2hlKCksIGNvbXBpbGVyQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLCBzb3J0T3JkZXIgPSBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICBoYXNEdXBsaWNhdGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgICAgfSwKICAgICAgLy8gR2VuZXJhbC1wdXJwb3NlIGNvbnN0YW50cwogICAgICBzdHJ1bmRlZmluZWQgPSB0eXBlb2YgdW5kZWZpbmVkLCBNQVhfTkVHQVRJVkUgPSAxIDw8IDMxLAogICAgICAvLyBJbnN0YW5jZSBtZXRob2RzCiAgICAgIGhhc093biA9IHt9Lmhhc093blByb3BlcnR5LCBhcnIgPSBbXSwgcG9wID0gYXJyLnBvcCwgcHVzaF9uYXRpdmUgPSBhcnIucHVzaCwgcHVzaCA9IGFyci5wdXNoLCBzbGljZSA9IGFyci5zbGljZSwKICAgICAgLy8gVXNlIGEgc3RyaXBwZWQtZG93biBpbmRleE9mIGlmIHdlIGNhbid0IHVzZSBhIG5hdGl2ZSBvbmUKICAgICAgaW5kZXhPZiA9IGFyci5pbmRleE9mIHx8IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgdmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsKICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAodGhpc1tpXSA9PT0gZWxlbSkgewogICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIC0xOwogICAgICB9LCBib29sZWFucyA9ICdjaGVja2VkfHNlbGVjdGVkfGFzeW5jfGF1dG9mb2N1c3xhdXRvcGxheXxjb250cm9sc3xkZWZlcnxkaXNhYmxlZHxoaWRkZW58aXNtYXB8bG9vcHxtdWx0aXBsZXxvcGVufHJlYWRvbmx5fHJlcXVpcmVkfHNjb3BlZCcsCiAgICAgIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbnMKICAgICAgLy8gV2hpdGVzcGFjZSBjaGFyYWN0ZXJzIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc2VsZWN0b3JzLyN3aGl0ZXNwYWNlCiAgICAgIHdoaXRlc3BhY2UgPSAnW1xceDIwXFx0XFxyXFxuXFxmXScsCiAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc3ludGF4LyNjaGFyYWN0ZXJzCiAgICAgIGNoYXJhY3RlckVuY29kaW5nID0gJyg/OlxcXFwufFtcXHctXXxbXlxceDAwLVxceGEwXSkrJywKICAgICAgLy8gTG9vc2VseSBtb2RlbGVkIG9uIENTUyBpZGVudGlmaWVyIGNoYXJhY3RlcnMKICAgICAgLy8gQW4gdW5xdW90ZWQgdmFsdWUgc2hvdWxkIGJlIGEgQ1NTIGlkZW50aWZpZXIgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMKICAgICAgLy8gUHJvcGVyIHN5bnRheDogaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI3ZhbHVlLWRlZi1pZGVudGlmaWVyCiAgICAgIGlkZW50aWZpZXIgPSBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCd3JywgJ3cjJyksCiAgICAgIC8vIEF0dHJpYnV0ZSBzZWxlY3RvcnM6IGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwogICAgICBhdHRyaWJ1dGVzID0gJ1xcWycgKyB3aGl0ZXNwYWNlICsgJyooJyArIGNoYXJhY3RlckVuY29kaW5nICsgJykoPzonICsgd2hpdGVzcGFjZSArIC8vIE9wZXJhdG9yIChjYXB0dXJlIDIpCiAgICAgICcqKFsqXiR8IX5dPz0pJyArIHdoaXRlc3BhY2UgKyAvLyAiQXR0cmlidXRlIHZhbHVlcyBtdXN0IGJlIENTUyBpZGVudGlmaWVycyBbY2FwdHVyZSA1XSBvciBzdHJpbmdzIFtjYXB0dXJlIDMgb3IgY2FwdHVyZSA0XSIKICAgICAgJyooPzpcJygoPzpcXFxcLnxbXlxcXFxcJ10pKilcJ3wiKCg/OlxcXFwufFteXFxcXCJdKSopInwoJyArIGlkZW50aWZpZXIgKyAnKSl8KScgKyB3aGl0ZXNwYWNlICsgJypcXF0nLCBwc2V1ZG9zID0gJzooJyArIGNoYXJhY3RlckVuY29kaW5nICsgJykoPzpcXCgoJyArIC8vIFRvIHJlZHVjZSB0aGUgbnVtYmVyIG9mIHNlbGVjdG9ycyBuZWVkaW5nIHRva2VuaXplIGluIHRoZSBwcmVGaWx0ZXIsIHByZWZlciBhcmd1bWVudHM6CiAgICAgIC8vIDEuIHF1b3RlZCAoY2FwdHVyZSAzOyBjYXB0dXJlIDQgb3IgY2FwdHVyZSA1KQogICAgICAnKFwnKCg/OlxcXFwufFteXFxcXFwnXSkqKVwnfCIoKD86XFxcXC58W15cXFxcIl0pKikiKXwnICsgLy8gMi4gc2ltcGxlIChjYXB0dXJlIDYpCiAgICAgICcoKD86XFxcXC58W15cXFxcKClbXFxdXXwnICsgYXR0cmlidXRlcyArICcpKil8JyArIC8vIDMuIGFueXRoaW5nIGVsc2UgKGNhcHR1cmUgMikKICAgICAgJy4qJyArICcpXFwpfCknLAogICAgICAvLyBMZWFkaW5nIGFuZCBub24tZXNjYXBlZCB0cmFpbGluZyB3aGl0ZXNwYWNlLCBjYXB0dXJpbmcgc29tZSBub24td2hpdGVzcGFjZSBjaGFyYWN0ZXJzIHByZWNlZGluZyB0aGUgbGF0dGVyCiAgICAgIHJ0cmltID0gbmV3IFJlZ0V4cCgnXicgKyB3aGl0ZXNwYWNlICsgJyt8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKScgKyB3aGl0ZXNwYWNlICsgJyskJywgJ2cnKSwgcmNvbW1hID0gbmV3IFJlZ0V4cCgnXicgKyB3aGl0ZXNwYWNlICsgJyosJyArIHdoaXRlc3BhY2UgKyAnKicpLCByY29tYmluYXRvcnMgPSBuZXcgUmVnRXhwKCdeJyArIHdoaXRlc3BhY2UgKyAnKihbPit+XXwnICsgd2hpdGVzcGFjZSArICcpJyArIHdoaXRlc3BhY2UgKyAnKicpLCByYXR0cmlidXRlUXVvdGVzID0gbmV3IFJlZ0V4cCgnPScgKyB3aGl0ZXNwYWNlICsgJyooW15cXF1cJyJdKj8pJyArIHdoaXRlc3BhY2UgKyAnKlxcXScsICdnJyksIHJwc2V1ZG8gPSBuZXcgUmVnRXhwKHBzZXVkb3MpLCByaWRlbnRpZmllciA9IG5ldyBSZWdFeHAoJ14nICsgaWRlbnRpZmllciArICckJyksIG1hdGNoRXhwciA9IHsKICAgICAgICAnSUQnOiBuZXcgUmVnRXhwKCdeIygnICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAnKScpLAogICAgICAgICdDTEFTUyc6IG5ldyBSZWdFeHAoJ15cXC4oJyArIGNoYXJhY3RlckVuY29kaW5nICsgJyknKSwKICAgICAgICAnVEFHJzogbmV3IFJlZ0V4cCgnXignICsgY2hhcmFjdGVyRW5jb2RpbmcucmVwbGFjZSgndycsICd3KicpICsgJyknKSwKICAgICAgICAnQVRUUic6IG5ldyBSZWdFeHAoJ14nICsgYXR0cmlidXRlcyksCiAgICAgICAgJ1BTRVVETyc6IG5ldyBSZWdFeHAoJ14nICsgcHNldWRvcyksCiAgICAgICAgJ0NISUxEJzogbmV3IFJlZ0V4cCgnXjoob25seXxmaXJzdHxsYXN0fG50aHxudGgtbGFzdCktKGNoaWxkfG9mLXR5cGUpKD86XFwoJyArIHdoaXRlc3BhY2UgKyAnKihldmVufG9kZHwoKFsrLV18KShcXGQqKW58KScgKyB3aGl0ZXNwYWNlICsgJyooPzooWystXXwpJyArIHdoaXRlc3BhY2UgKyAnKihcXGQrKXwpKScgKyB3aGl0ZXNwYWNlICsgJypcXCl8KScsICdpJyksCiAgICAgICAgJ2Jvb2wnOiBuZXcgUmVnRXhwKCdeKD86JyArIGJvb2xlYW5zICsgJykkJywgJ2knKSwKICAgICAgICAvLyBGb3IgdXNlIGluIGxpYnJhcmllcyBpbXBsZW1lbnRpbmcgLmlzKCkKICAgICAgICAvLyBXZSB1c2UgdGhpcyBmb3IgUE9TIG1hdGNoaW5nIGluIGBzZWxlY3RgCiAgICAgICAgJ25lZWRzQ29udGV4dCc6IG5ldyBSZWdFeHAoJ14nICsgd2hpdGVzcGFjZSArICcqWz4rfl18OihldmVufG9kZHxlcXxndHxsdHxudGh8Zmlyc3R8bGFzdCkoPzpcXCgnICsgd2hpdGVzcGFjZSArICcqKCg/Oi1cXGQpP1xcZCopJyArIHdoaXRlc3BhY2UgKyAnKlxcKXwpKD89W14tXXwkKScsICdpJykKICAgICAgfSwgcmlucHV0cyA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbikkL2ksIHJoZWFkZXIgPSAvXmhcZCQvaSwgcm5hdGl2ZSA9IC9eW157XStce1xzKlxbbmF0aXZlIFx3LywKICAgICAgLy8gRWFzaWx5LXBhcnNlYWJsZS9yZXRyaWV2YWJsZSBJRCBvciBUQUcgb3IgQ0xBU1Mgc2VsZWN0b3JzCiAgICAgIHJxdWlja0V4cHIgPSAvXig/OiMoW1x3LV0rKXwoXHcrKXxcLihbXHctXSspKSQvLCByc2libGluZyA9IC9bK35dLywgcmVzY2FwZSA9IC8nfFxcL2csCiAgICAgIC8vIENTUyBlc2NhcGVzIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCNlc2NhcGVkLWNoYXJhY3RlcnMKICAgICAgcnVuZXNjYXBlID0gbmV3IFJlZ0V4cCgnXFxcXChbXFxkYS1mXXsxLDZ9JyArIHdoaXRlc3BhY2UgKyAnP3woJyArIHdoaXRlc3BhY2UgKyAnKXwuKScsICdpZycpLCBmdW5lc2NhcGUgPSBmdW5jdGlvbiAoXywgZXNjYXBlZCwgZXNjYXBlZFdoaXRlc3BhY2UpIHsKICAgICAgICB2YXIgaGlnaCA9ICcweCcgKyBlc2NhcGVkIC0gNjU1MzY7CiAgICAgICAgLy8gTmFOIG1lYW5zIG5vbi1jb2RlcG9pbnQKICAgICAgICAvLyBTdXBwb3J0OiBGaXJlZm94PDI0CiAgICAgICAgLy8gV29ya2Fyb3VuZCBlcnJvbmVvdXMgbnVtZXJpYyBpbnRlcnByZXRhdGlvbiBvZiArIjB4IgogICAgICAgIHJldHVybiBoaWdoICE9PSBoaWdoIHx8IGVzY2FwZWRXaGl0ZXNwYWNlID8gZXNjYXBlZCA6IGhpZ2ggPCAwID8gLy8gQk1QIGNvZGVwb2ludAogICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoaGlnaCArIDY1NTM2KSA6IC8vIFN1cHBsZW1lbnRhbCBQbGFuZSBjb2RlcG9pbnQgKHN1cnJvZ2F0ZSBwYWlyKQogICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoaGlnaCA+PiAxMCB8IDU1Mjk2LCBoaWdoICYgMTAyMyB8IDU2MzIwKTsKICAgICAgfTsKICAgIC8vIE9wdGltaXplIGZvciBwdXNoLmFwcGx5KCBfLCBOb2RlTGlzdCApCiAgICB0cnkgewogICAgICBwdXNoLmFwcGx5KGFyciA9IHNsaWNlLmNhbGwocHJlZmVycmVkRG9jLmNoaWxkTm9kZXMpLCBwcmVmZXJyZWREb2MuY2hpbGROb2Rlcyk7CiAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQ8NC4wCiAgICAgIC8vIERldGVjdCBzaWxlbnRseSBmYWlsaW5nIHB1c2guYXBwbHkKICAgICAgYXJyW3ByZWZlcnJlZERvYy5jaGlsZE5vZGVzLmxlbmd0aF0ubm9kZVR5cGU7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHB1c2ggPSB7CiAgICAgICAgYXBwbHk6IGFyci5sZW5ndGggPyAvLyBMZXZlcmFnZSBzbGljZSBpZiBwb3NzaWJsZQogICAgICAgIGZ1bmN0aW9uICh0YXJnZXQsIGVscykgewogICAgICAgICAgcHVzaF9uYXRpdmUuYXBwbHkodGFyZ2V0LCBzbGljZS5jYWxsKGVscykpOwogICAgICAgIH0gOiAvLyBTdXBwb3J0OiBJRTw5CiAgICAgICAgLy8gT3RoZXJ3aXNlIGFwcGVuZCBkaXJlY3RseQogICAgICAgIGZ1bmN0aW9uICh0YXJnZXQsIGVscykgewogICAgICAgICAgdmFyIGogPSB0YXJnZXQubGVuZ3RoLCBpID0gMDsKICAgICAgICAgIC8vIENhbid0IHRydXN0IE5vZGVMaXN0Lmxlbmd0aAogICAgICAgICAgd2hpbGUgKHRhcmdldFtqKytdID0gZWxzW2krK10pIHsKICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldC5sZW5ndGggPSBqIC0gMTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBTaXp6bGUoc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpIHsKICAgICAgdmFyIG1hdGNoLCBlbGVtLCBtLCBub2RlVHlwZSwKICAgICAgICAvLyBRU0EgdmFycwogICAgICAgIGksIGdyb3Vwcywgb2xkLCBuaWQsIG5ld0NvbnRleHQsIG5ld1NlbGVjdG9yOwogICAgICBpZiAoKGNvbnRleHQgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IHByZWZlcnJlZERvYykgIT09IGRvY3VtZW50KSB7CiAgICAgICAgc2V0RG9jdW1lbnQoY29udGV4dCk7CiAgICAgIH0KICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CiAgICAgIHJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwogICAgICBpZiAoIXNlbGVjdG9yIHx8IHR5cGVvZiBzZWxlY3RvciAhPT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgfQogICAgICBpZiAoKG5vZGVUeXBlID0gY29udGV4dC5ub2RlVHlwZSkgIT09IDEgJiYgbm9kZVR5cGUgIT09IDkpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgaWYgKGRvY3VtZW50SXNIVE1MICYmICFzZWVkKSB7CiAgICAgICAgLy8gU2hvcnRjdXRzCiAgICAgICAgaWYgKG1hdGNoID0gcnF1aWNrRXhwci5leGVjKHNlbGVjdG9yKSkgewogICAgICAgICAgLy8gU3BlZWQtdXA6IFNpenpsZSgiI0lEIikKICAgICAgICAgIGlmIChtID0gbWF0Y2hbMV0pIHsKICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICAgICAgZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQobSk7CiAgICAgICAgICAgICAgLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKICAgICAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50IChqUXVlcnkgIzY5NjMpCiAgICAgICAgICAgICAgaWYgKGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUsIE9wZXJhLCBhbmQgV2Via2l0IHJldHVybiBpdGVtcwogICAgICAgICAgICAgICAgLy8gYnkgbmFtZSBpbnN0ZWFkIG9mIElECiAgICAgICAgICAgICAgICBpZiAoZWxlbS5pZCA9PT0gbSkgewogICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goZWxlbSk7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gQ29udGV4dCBpcyBub3QgYSBkb2N1bWVudAogICAgICAgICAgICAgIGlmIChjb250ZXh0Lm93bmVyRG9jdW1lbnQgJiYgKGVsZW0gPSBjb250ZXh0Lm93bmVyRG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobSkpICYmIGNvbnRhaW5zKGNvbnRleHQsIGVsZW0pICYmIGVsZW0uaWQgPT09IG0pIHsKICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChlbGVtKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAgLy8gU3BlZWQtdXA6IFNpenpsZSgiVEFHIikKICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbMl0pIHsKICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOyAgLy8gU3BlZWQtdXA6IFNpenpsZSgiLkNMQVNTIikKICAgICAgICAgIH0gZWxzZSBpZiAoKG0gPSBtYXRjaFszXSkgJiYgc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSkgewogICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShtKSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBRU0EgcGF0aAogICAgICAgIGlmIChzdXBwb3J0LnFzYSAmJiAoIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3Qoc2VsZWN0b3IpKSkgewogICAgICAgICAgbmlkID0gb2xkID0gZXhwYW5kbzsKICAgICAgICAgIG5ld0NvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgbmV3U2VsZWN0b3IgPSBub2RlVHlwZSA9PT0gOSAmJiBzZWxlY3RvcjsKICAgICAgICAgIC8vIHFTQSB3b3JrcyBzdHJhbmdlbHkgb24gRWxlbWVudC1yb290ZWQgcXVlcmllcwogICAgICAgICAgLy8gV2UgY2FuIHdvcmsgYXJvdW5kIHRoaXMgYnkgc3BlY2lmeWluZyBhbiBleHRyYSBJRCBvbiB0aGUgcm9vdAogICAgICAgICAgLy8gYW5kIHdvcmtpbmcgdXAgZnJvbSB0aGVyZSAoVGhhbmtzIHRvIEFuZHJldyBEdXBvbnQgZm9yIHRoZSB0ZWNobmlxdWUpCiAgICAgICAgICAvLyBJRSA4IGRvZXNuJ3Qgd29yayBvbiBvYmplY3QgZWxlbWVudHMKICAgICAgICAgIGlmIChub2RlVHlwZSA9PT0gMSAmJiBjb250ZXh0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIGdyb3VwcyA9IHRva2VuaXplKHNlbGVjdG9yKTsKICAgICAgICAgICAgaWYgKG9sZCA9IGNvbnRleHQuZ2V0QXR0cmlidXRlKCdpZCcpKSB7CiAgICAgICAgICAgICAgbmlkID0gb2xkLnJlcGxhY2UocmVzY2FwZSwgJ1xcJCYnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250ZXh0LnNldEF0dHJpYnV0ZSgnaWQnLCBuaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5pZCA9ICdbaWQ9XCcnICsgbmlkICsgJ1wnXSAnOwogICAgICAgICAgICBpID0gZ3JvdXBzLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgIGdyb3Vwc1tpXSA9IG5pZCArIHRvU2VsZWN0b3IoZ3JvdXBzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDb250ZXh0ID0gcnNpYmxpbmcudGVzdChzZWxlY3RvcikgJiYgdGVzdENvbnRleHQoY29udGV4dC5wYXJlbnROb2RlKSB8fCBjb250ZXh0OwogICAgICAgICAgICBuZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCcsJyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmV3U2VsZWN0b3IpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIG5ld0NvbnRleHQucXVlcnlTZWxlY3RvckFsbChuZXdTZWxlY3RvcikpOwogICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICB9IGNhdGNoIChxc2FFcnJvcikgewogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGlmICghb2xkKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0LnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQWxsIG90aGVycwogICAgICByZXR1cm4gc2VsZWN0KHNlbGVjdG9yLnJlcGxhY2UocnRyaW0sICckMScpLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkKTsKICAgIH0KICAgIC8qKgogICAgICogQ3JlYXRlIGtleS12YWx1ZSBjYWNoZXMgb2YgbGltaXRlZCBzaXplCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb24oc3RyaW5nLCBPYmplY3QpfSBSZXR1cm5zIHRoZSBPYmplY3QgZGF0YSBhZnRlciBzdG9yaW5nIGl0IG9uIGl0c2VsZiB3aXRoCiAgICAgKglwcm9wZXJ0eSBuYW1lIHRoZSAoc3BhY2Utc3VmZml4ZWQpIHN0cmluZyBhbmQgKGlmIHRoZSBjYWNoZSBpcyBsYXJnZXIgdGhhbiBFeHByLmNhY2hlTGVuZ3RoKQogICAgICoJZGVsZXRpbmcgdGhlIG9sZGVzdCBlbnRyeQogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVDYWNoZSgpIHsKICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgZnVuY3Rpb24gY2FjaGUoa2V5LCB2YWx1ZSkgewogICAgICAgIC8vIFVzZSAoa2V5ICsgIiAiKSB0byBhdm9pZCBjb2xsaXNpb24gd2l0aCBuYXRpdmUgcHJvdG90eXBlIHByb3BlcnRpZXMgKHNlZSBJc3N1ZSAjMTU3KQogICAgICAgIGlmIChrZXlzLnB1c2goa2V5ICsgJyAnKSA+IEV4cHIuY2FjaGVMZW5ndGgpIHsKICAgICAgICAgIC8vIE9ubHkga2VlcCB0aGUgbW9zdCByZWNlbnQgZW50cmllcwogICAgICAgICAgZGVsZXRlIGNhY2hlW2tleXMuc2hpZnQoKV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYWNoZVtrZXkgKyAnICddID0gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGNhY2hlOwogICAgfQogICAgLyoqCiAgICAgKiBNYXJrIGEgZnVuY3Rpb24gZm9yIHNwZWNpYWwgdXNlIGJ5IFNpenpsZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIG1hcmsKICAgICAqLwogICAgZnVuY3Rpb24gbWFya0Z1bmN0aW9uKGZuKSB7CiAgICAgIGZuW2V4cGFuZG9dID0gdHJ1ZTsKICAgICAgcmV0dXJuIGZuOwogICAgfQogICAgLyoqCiAgICAgKiBTdXBwb3J0IHRlc3RpbmcgdXNpbmcgYW4gZWxlbWVudAogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gUGFzc2VkIHRoZSBjcmVhdGVkIGRpdiBhbmQgZXhwZWN0cyBhIGJvb2xlYW4gcmVzdWx0CiAgICAgKi8KICAgIGZ1bmN0aW9uIGFzc2VydChmbikgewogICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuICEhZm4oZGl2KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAvLyBSZW1vdmUgZnJvbSBpdHMgcGFyZW50IGJ5IGRlZmF1bHQKICAgICAgICBpZiAoZGl2LnBhcmVudE5vZGUpIHsKICAgICAgICAgIGRpdi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGRpdik7CiAgICAgICAgfQogICAgICAgIC8vIHJlbGVhc2UgbWVtb3J5IGluIElFCiAgICAgICAgZGl2ID0gbnVsbDsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBBZGRzIHRoZSBzYW1lIGhhbmRsZXIgZm9yIGFsbCBvZiB0aGUgc3BlY2lmaWVkIGF0dHJzCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gYXR0cnMgUGlwZS1zZXBhcmF0ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBtZXRob2QgdGhhdCB3aWxsIGJlIGFwcGxpZWQKICAgICAqLwogICAgZnVuY3Rpb24gYWRkSGFuZGxlKGF0dHJzLCBoYW5kbGVyKSB7CiAgICAgIHZhciBhcnIgPSBhdHRycy5zcGxpdCgnfCcpLCBpID0gYXR0cnMubGVuZ3RoOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgRXhwci5hdHRySGFuZGxlW2FycltpXV0gPSBoYW5kbGVyOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrcyBkb2N1bWVudCBvcmRlciBvZiB0d28gc2libGluZ3MKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gYQogICAgICogQHBhcmFtIHtFbGVtZW50fSBiCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIGxlc3MgdGhhbiAwIGlmIGEgcHJlY2VkZXMgYiwgZ3JlYXRlciB0aGFuIDAgaWYgYSBmb2xsb3dzIGIKICAgICAqLwogICAgZnVuY3Rpb24gc2libGluZ0NoZWNrKGEsIGIpIHsKICAgICAgdmFyIGN1ciA9IGIgJiYgYSwgZGlmZiA9IGN1ciAmJiBhLm5vZGVUeXBlID09PSAxICYmIGIubm9kZVR5cGUgPT09IDEgJiYgKH5iLnNvdXJjZUluZGV4IHx8IE1BWF9ORUdBVElWRSkgLSAofmEuc291cmNlSW5kZXggfHwgTUFYX05FR0FUSVZFKTsKICAgICAgLy8gVXNlIElFIHNvdXJjZUluZGV4IGlmIGF2YWlsYWJsZSBvbiBib3RoIG5vZGVzCiAgICAgIGlmIChkaWZmKSB7CiAgICAgICAgcmV0dXJuIGRpZmY7CiAgICAgIH0KICAgICAgLy8gQ2hlY2sgaWYgYiBmb2xsb3dzIGEKICAgICAgaWYgKGN1cikgewogICAgICAgIHdoaWxlIChjdXIgPSBjdXIubmV4dFNpYmxpbmcpIHsKICAgICAgICAgIGlmIChjdXIgPT09IGIpIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYSA/IDEgOiAtMTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBpbnB1dCB0eXBlcwogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlSW5wdXRQc2V1ZG8odHlwZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gbmFtZSA9PT0gJ2lucHV0JyAmJiBlbGVtLnR5cGUgPT09IHR5cGU7CiAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgYnV0dG9ucwogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQnV0dG9uUHNldWRvKHR5cGUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcmV0dXJuIChuYW1lID09PSAnaW5wdXQnIHx8IG5hbWUgPT09ICdidXR0b24nKSAmJiBlbGVtLnR5cGUgPT09IHR5cGU7CiAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgcG9zaXRpb25hbHMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZm4pIHsKICAgICAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoYXJndW1lbnQpIHsKICAgICAgICBhcmd1bWVudCA9ICthcmd1bWVudDsKICAgICAgICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzKSB7CiAgICAgICAgICB2YXIgaiwgbWF0Y2hJbmRleGVzID0gZm4oW10sIHNlZWQubGVuZ3RoLCBhcmd1bWVudCksIGkgPSBtYXRjaEluZGV4ZXMubGVuZ3RoOwogICAgICAgICAgLy8gTWF0Y2ggZWxlbWVudHMgZm91bmQgYXQgdGhlIHNwZWNpZmllZCBpbmRleGVzCiAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIGlmIChzZWVkW2ogPSBtYXRjaEluZGV4ZXNbaV1dKSB7CiAgICAgICAgICAgICAgc2VlZFtqXSA9ICEobWF0Y2hlc1tqXSA9IHNlZWRbal0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgYSBub2RlIGZvciB2YWxpZGl0eSBhcyBhIFNpenpsZSBjb250ZXh0CiAgICAgKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0PX0gY29udGV4dAogICAgICogQHJldHVybnMge0VsZW1lbnR8T2JqZWN0fEJvb2xlYW59IFRoZSBpbnB1dCBub2RlIGlmIGFjY2VwdGFibGUsIG90aGVyd2lzZSBhIGZhbHN5IHZhbHVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRlc3RDb250ZXh0KGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGNvbnRleHQgJiYgdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09IHN0cnVuZGVmaW5lZCAmJiBjb250ZXh0OwogICAgfQogICAgLy8gRXhwb3NlIHN1cHBvcnQgdmFycyBmb3IgY29udmVuaWVuY2UKICAgIHN1cHBvcnQgPSBTaXp6bGUuc3VwcG9ydCA9IHt9OwogICAgLyoqCiAgICAgKiBEZXRlY3RzIFhNTCBub2RlcwogICAgICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gZWxlbSBBbiBlbGVtZW50IG9yIGEgZG9jdW1lbnQKICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmZiBlbGVtIGlzIGEgbm9uLUhUTUwgWE1MIG5vZGUKICAgICAqLwogICAgaXNYTUwgPSBTaXp6bGUuaXNYTUwgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICAvLyBkb2N1bWVudEVsZW1lbnQgaXMgdmVyaWZpZWQgZm9yIGNhc2VzIHdoZXJlIGl0IGRvZXNuJ3QgeWV0IGV4aXN0CiAgICAgIC8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKQogICAgICB2YXIgZG9jdW1lbnRFbGVtZW50ID0gZWxlbSAmJiAoZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0pLmRvY3VtZW50RWxlbWVudDsKICAgICAgcmV0dXJuIGRvY3VtZW50RWxlbWVudCA/IGRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPT0gJ0hUTUwnIDogZmFsc2U7CiAgICB9OwogICAgLyoqCiAgICAgKiBTZXRzIGRvY3VtZW50LXJlbGF0ZWQgdmFyaWFibGVzIG9uY2UgYmFzZWQgb24gdGhlIGN1cnJlbnQgZG9jdW1lbnQKICAgICAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3R9IFtkb2NdIEFuIGVsZW1lbnQgb3IgZG9jdW1lbnQgb2JqZWN0IHRvIHVzZSB0byBzZXQgdGhlIGRvY3VtZW50CiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjdXJyZW50IGRvY3VtZW50CiAgICAgKi8KICAgIHNldERvY3VtZW50ID0gU2l6emxlLnNldERvY3VtZW50ID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgdmFyIGhhc0NvbXBhcmUsIGRvYyA9IG5vZGUgPyBub2RlLm93bmVyRG9jdW1lbnQgfHwgbm9kZSA6IHByZWZlcnJlZERvYywgcGFyZW50ID0gZG9jLmRlZmF1bHRWaWV3OwogICAgICAvLyBJZiBubyBkb2N1bWVudCBhbmQgZG9jdW1lbnRFbGVtZW50IGlzIGF2YWlsYWJsZSwgcmV0dXJuCiAgICAgIGlmIChkb2MgPT09IGRvY3VtZW50IHx8IGRvYy5ub2RlVHlwZSAhPT0gOSB8fCAhZG9jLmRvY3VtZW50RWxlbWVudCkgewogICAgICAgIHJldHVybiBkb2N1bWVudDsKICAgICAgfQogICAgICAvLyBTZXQgb3VyIGRvY3VtZW50CiAgICAgIGRvY3VtZW50ID0gZG9jOwogICAgICBkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKICAgICAgLy8gU3VwcG9ydCB0ZXN0cwogICAgICBkb2N1bWVudElzSFRNTCA9ICFpc1hNTChkb2MpOwogICAgICAvLyBTdXBwb3J0OiBJRT44CiAgICAgIC8vIElmIGlmcmFtZSBkb2N1bWVudCBpcyBhc3NpZ25lZCB0byAiZG9jdW1lbnQiIHZhcmlhYmxlIGFuZCBpZiBpZnJhbWUgaGFzIGJlZW4gcmVsb2FkZWQsCiAgICAgIC8vIElFIHdpbGwgdGhyb3cgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIGFjY2Vzc2luZyAiZG9jdW1lbnQiIHZhcmlhYmxlLCBzZWUgalF1ZXJ5ICMxMzkzNgogICAgICAvLyBJRTYtOCBkbyBub3Qgc3VwcG9ydCB0aGUgZGVmYXVsdFZpZXcgcHJvcGVydHkgc28gcGFyZW50IHdpbGwgYmUgdW5kZWZpbmVkCiAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50ICE9PSBwYXJlbnQudG9wKSB7CiAgICAgICAgLy8gSUUxMSBkb2VzIG5vdCBoYXZlIGF0dGFjaEV2ZW50LCBzbyBhbGwgbXVzdCBzdWZmZXIKICAgICAgICBpZiAocGFyZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgIHBhcmVudC5hZGRFdmVudExpc3RlbmVyKCd1bmxvYWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNldERvY3VtZW50KCk7CiAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgfSBlbHNlIGlmIChwYXJlbnQuYXR0YWNoRXZlbnQpIHsKICAgICAgICAgIHBhcmVudC5hdHRhY2hFdmVudCgnb251bmxvYWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNldERvY3VtZW50KCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLyogQXR0cmlidXRlcwogICAgICAJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogICAgICAvLyBTdXBwb3J0OiBJRTw4CiAgICAgIC8vIFZlcmlmeSB0aGF0IGdldEF0dHJpYnV0ZSByZWFsbHkgcmV0dXJucyBhdHRyaWJ1dGVzIGFuZCBub3QgcHJvcGVydGllcyAoZXhjZXB0aW5nIElFOCBib29sZWFucykKICAgICAgc3VwcG9ydC5hdHRyaWJ1dGVzID0gYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICBkaXYuY2xhc3NOYW1lID0gJ2knOwogICAgICAgIHJldHVybiAhZGl2LmdldEF0dHJpYnV0ZSgnY2xhc3NOYW1lJyk7CiAgICAgIH0pOwogICAgICAvKiBnZXRFbGVtZW50KHMpQnkqCiAgICAgIAktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAgICAgIC8vIENoZWNrIGlmIGdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgcmV0dXJucyBvbmx5IGVsZW1lbnRzCiAgICAgIHN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPSBhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgIGRpdi5hcHBlbmRDaGlsZChkb2MuY3JlYXRlQ29tbWVudCgnJykpOwogICAgICAgIHJldHVybiAhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoOwogICAgICB9KTsKICAgICAgLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYW4gYmUgdHJ1c3RlZAogICAgICBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgPSBybmF0aXZlLnRlc3QoZG9jLmdldEVsZW1lbnRzQnlDbGFzc05hbWUpICYmIGFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPVwnYVwnPjwvZGl2PjxkaXYgY2xhc3M9XCdhIGlcJz48L2Rpdj4nOwogICAgICAgIC8vIFN1cHBvcnQ6IFNhZmFyaTw0CiAgICAgICAgLy8gQ2F0Y2ggY2xhc3Mgb3Zlci1jYWNoaW5nCiAgICAgICAgZGl2LmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gJ2knOwogICAgICAgIC8vIFN1cHBvcnQ6IE9wZXJhPDEwCiAgICAgICAgLy8gQ2F0Y2ggZ0VCQ04gZmFpbHVyZSB0byBmaW5kIG5vbi1sZWFkaW5nIGNsYXNzZXMKICAgICAgICByZXR1cm4gZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2knKS5sZW5ndGggPT09IDI7CiAgICAgIH0pOwogICAgICAvLyBTdXBwb3J0OiBJRTwxMAogICAgICAvLyBDaGVjayBpZiBnZXRFbGVtZW50QnlJZCByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUKICAgICAgLy8gVGhlIGJyb2tlbiBnZXRFbGVtZW50QnlJZCBtZXRob2RzIGRvbid0IHBpY2sgdXAgcHJvZ3JhbWF0aWNhbGx5LXNldCBuYW1lcywKICAgICAgLy8gc28gdXNlIGEgcm91bmRhYm91dCBnZXRFbGVtZW50c0J5TmFtZSB0ZXN0CiAgICAgIHN1cHBvcnQuZ2V0QnlJZCA9IGFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgZG9jRWxlbS5hcHBlbmRDaGlsZChkaXYpLmlkID0gZXhwYW5kbzsKICAgICAgICByZXR1cm4gIWRvYy5nZXRFbGVtZW50c0J5TmFtZSB8fCAhZG9jLmdldEVsZW1lbnRzQnlOYW1lKGV4cGFuZG8pLmxlbmd0aDsKICAgICAgfSk7CiAgICAgIC8vIElEIGZpbmQgYW5kIGZpbHRlcgogICAgICBpZiAoc3VwcG9ydC5nZXRCeUlkKSB7CiAgICAgICAgRXhwci5maW5kWydJRCddID0gZnVuY3Rpb24gKGlkLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09IHN0cnVuZGVmaW5lZCAmJiBkb2N1bWVudElzSFRNTCkgewogICAgICAgICAgICB2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgICAgIHJldHVybiBtICYmIG0ucGFyZW50Tm9kZSA/IFttXSA6IFtdOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgRXhwci5maWx0ZXJbJ0lEJ10gPSBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgIHZhciBhdHRySWQgPSBpZC5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoJ2lkJykgPT09IGF0dHJJZDsKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTdXBwb3J0OiBJRTYvNwogICAgICAgIC8vIGdldEVsZW1lbnRCeUlkIGlzIG5vdCByZWxpYWJsZSBhcyBhIGZpbmQgc2hvcnRjdXQKICAgICAgICBkZWxldGUgRXhwci5maW5kWydJRCddOwogICAgICAgIEV4cHIuZmlsdGVyWydJRCddID0gZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICB2YXIgYXR0cklkID0gaWQucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpOwogICAgICAgICAgICByZXR1cm4gbm9kZSAmJiBub2RlLnZhbHVlID09PSBhdHRySWQ7CiAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgIH0KICAgICAgLy8gVGFnCiAgICAgIEV4cHIuZmluZFsnVEFHJ10gPSBzdXBwb3J0LmdldEVsZW1lbnRzQnlUYWdOYW1lID8gZnVuY3Rpb24gKHRhZywgY29udGV4dCkgewogICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gc3RydW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwogICAgICAgIH0KICAgICAgfSA6IGZ1bmN0aW9uICh0YWcsIGNvbnRleHQpIHsKICAgICAgICB2YXIgZWxlbSwgdG1wID0gW10sIGkgPSAwLCByZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwogICAgICAgIC8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMKICAgICAgICBpZiAodGFnID09PSAnKicpIHsKICAgICAgICAgIHdoaWxlIChlbGVtID0gcmVzdWx0c1tpKytdKSB7CiAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgdG1wLnB1c2goZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0bXA7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICB9OwogICAgICAvLyBDbGFzcwogICAgICBFeHByLmZpbmRbJ0NMQVNTJ10gPSBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgZnVuY3Rpb24gKGNsYXNzTmFtZSwgY29udGV4dCkgewogICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICE9PSBzdHJ1bmRlZmluZWQgJiYgZG9jdW1lbnRJc0hUTUwpIHsKICAgICAgICAgIHJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NOYW1lKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIC8qIFFTQS9tYXRjaGVzU2VsZWN0b3IKICAgICAgCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KICAgICAgLy8gUVNBIGFuZCBtYXRjaGVzU2VsZWN0b3Igc3VwcG9ydAogICAgICAvLyBtYXRjaGVzU2VsZWN0b3IoOmFjdGl2ZSkgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKElFOS9PcGVyYSAxMS41KQogICAgICByYnVnZ3lNYXRjaGVzID0gW107CiAgICAgIC8vIHFTYSg6Zm9jdXMpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChDaHJvbWUgMjEpCiAgICAgIC8vIFdlIGFsbG93IHRoaXMgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBJRTgvOSB0aGF0IHRocm93cyBhbiBlcnJvcgogICAgICAvLyB3aGVuZXZlciBgZG9jdW1lbnQuYWN0aXZlRWxlbWVudGAgaXMgYWNjZXNzZWQgb24gYW4gaWZyYW1lCiAgICAgIC8vIFNvLCB3ZSBhbGxvdyA6Zm9jdXMgdG8gcGFzcyB0aHJvdWdoIFFTQSBhbGwgdGhlIHRpbWUgdG8gYXZvaWQgdGhlIElFIGVycm9yCiAgICAgIC8vIFNlZSBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMzM3OAogICAgICByYnVnZ3lRU0EgPSBbXTsKICAgICAgaWYgKHN1cHBvcnQucXNhID0gcm5hdGl2ZS50ZXN0KGRvYy5xdWVyeVNlbGVjdG9yQWxsKSkgewogICAgICAgIC8vIEJ1aWxkIFFTQSByZWdleAogICAgICAgIC8vIFJlZ2V4IHN0cmF0ZWd5IGFkb3B0ZWQgZnJvbSBEaWVnbyBQZXJpbmkKICAgICAgICBhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgICAgLy8gU2VsZWN0IGlzIHNldCB0byBlbXB0eSBzdHJpbmcgb24gcHVycG9zZQogICAgICAgICAgLy8gVGhpcyBpcyB0byB0ZXN0IElFJ3MgdHJlYXRtZW50IG9mIG5vdCBleHBsaWNpdGx5CiAgICAgICAgICAvLyBzZXR0aW5nIGEgYm9vbGVhbiBjb250ZW50IGF0dHJpYnV0ZSwKICAgICAgICAgIC8vIHNpbmNlIGl0cyBwcmVzZW5jZSBzaG91bGQgYmUgZW5vdWdoCiAgICAgICAgICAvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMjM1OQogICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8c2VsZWN0IG1zYWxsb3djbGlwPVwnXCc+PG9wdGlvbiBzZWxlY3RlZD1cJ1wnPjwvb3B0aW9uPjwvc2VsZWN0Pic7CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRTgsIE9wZXJhIDExLTEyLjE2CiAgICAgICAgICAvLyBOb3RoaW5nIHNob3VsZCBiZSBzZWxlY3RlZCB3aGVuIGVtcHR5IHN0cmluZ3MgZm9sbG93IF49IG9yICQ9IG9yICo9CiAgICAgICAgICAvLyBUaGUgdGVzdCBhdHRyaWJ1dGUgbXVzdCBiZSB1bmtub3duIGluIE9wZXJhIGJ1dCAic2FmZSIgZm9yIFdpblJUCiAgICAgICAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvaGg0NjUzODguYXNweCNhdHRyaWJ1dGVfc2VjdGlvbgogICAgICAgICAgaWYgKGRpdi5xdWVyeVNlbGVjdG9yQWxsKCdbbXNhbGxvd2NsaXBePVwnXCddJykubGVuZ3RoKSB7CiAgICAgICAgICAgIHJidWdneVFTQS5wdXNoKCdbKl4kXT0nICsgd2hpdGVzcGFjZSArICcqKD86XCdcJ3wiIiknKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFN1cHBvcnQ6IElFOAogICAgICAgICAgLy8gQm9vbGVhbiBhdHRyaWJ1dGVzIGFuZCAidmFsdWUiIGFyZSBub3QgdHJlYXRlZCBjb3JyZWN0bHkKICAgICAgICAgIGlmICghZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tzZWxlY3RlZF0nKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goJ1xcWycgKyB3aGl0ZXNwYWNlICsgJyooPzp2YWx1ZXwnICsgYm9vbGVhbnMgKyAnKScpOwogICAgICAgICAgfQogICAgICAgICAgLy8gV2Via2l0L09wZXJhIC0gOmNoZWNrZWQgc2hvdWxkIHJldHVybiBzZWxlY3RlZCBvcHRpb24gZWxlbWVudHMKICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCiAgICAgICAgICAvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwogICAgICAgICAgaWYgKCFkaXYucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goJzpjaGVja2VkJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICAgIC8vIFN1cHBvcnQ6IFdpbmRvd3MgOCBOYXRpdmUgQXBwcwogICAgICAgICAgLy8gVGhlIHR5cGUgYW5kIG5hbWUgYXR0cmlidXRlcyBhcmUgcmVzdHJpY3RlZCBkdXJpbmcgLmlubmVySFRNTCBhc3NpZ25tZW50CiAgICAgICAgICB2YXIgaW5wdXQgPSBkb2MuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsKICAgICAgICAgIGlucHV0LnNldEF0dHJpYnV0ZSgndHlwZScsICdoaWRkZW4nKTsKICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChpbnB1dCkuc2V0QXR0cmlidXRlKCduYW1lJywgJ0QnKTsKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFOAogICAgICAgICAgLy8gRW5mb3JjZSBjYXNlLXNlbnNpdGl2aXR5IG9mIG5hbWUgYXR0cmlidXRlCiAgICAgICAgICBpZiAoZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tuYW1lPWRdJykubGVuZ3RoKSB7CiAgICAgICAgICAgIHJidWdneVFTQS5wdXNoKCduYW1lJyArIHdoaXRlc3BhY2UgKyAnKlsqXiR8IX5dPz0nKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEZGIDMuNSAtIDplbmFibGVkLzpkaXNhYmxlZCBhbmQgaGlkZGVuIGVsZW1lbnRzIChoaWRkZW4gZWxlbWVudHMgYXJlIHN0aWxsIGVuYWJsZWQpCiAgICAgICAgICAvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwogICAgICAgICAgaWYgKCFkaXYucXVlcnlTZWxlY3RvckFsbCgnOmVuYWJsZWQnKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goJzplbmFibGVkJywgJzpkaXNhYmxlZCcpOwogICAgICAgICAgfQogICAgICAgICAgLy8gT3BlcmEgMTAtMTEgZG9lcyBub3QgdGhyb3cgb24gcG9zdC1jb21tYSBpbnZhbGlkIHBzZXVkb3MKICAgICAgICAgIGRpdi5xdWVyeVNlbGVjdG9yQWxsKCcqLDp4Jyk7CiAgICAgICAgICByYnVnZ3lRU0EucHVzaCgnLC4qOicpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciA9IHJuYXRpdmUudGVzdChtYXRjaGVzID0gZG9jRWxlbS5tYXRjaGVzIHx8IGRvY0VsZW0ud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8IGRvY0VsZW0ubW96TWF0Y2hlc1NlbGVjdG9yIHx8IGRvY0VsZW0ub01hdGNoZXNTZWxlY3RvciB8fCBkb2NFbGVtLm1zTWF0Y2hlc1NlbGVjdG9yKSkgewogICAgICAgIGFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgICAvLyBDaGVjayB0byBzZWUgaWYgaXQncyBwb3NzaWJsZSB0byBkbyBtYXRjaGVzU2VsZWN0b3IKICAgICAgICAgIC8vIG9uIGEgZGlzY29ubmVjdGVkIG5vZGUgKElFIDkpCiAgICAgICAgICBzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoID0gbWF0Y2hlcy5jYWxsKGRpdiwgJ2RpdicpOwogICAgICAgICAgLy8gVGhpcyBzaG91bGQgZmFpbCB3aXRoIGFuIGV4Y2VwdGlvbgogICAgICAgICAgLy8gR2Vja28gZG9lcyBub3QgZXJyb3IsIHJldHVybnMgZmFsc2UgaW5zdGVhZAogICAgICAgICAgbWF0Y2hlcy5jYWxsKGRpdiwgJ1tzIT1cJ1wnXTp4Jyk7CiAgICAgICAgICByYnVnZ3lNYXRjaGVzLnB1c2goJyE9JywgcHNldWRvcyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmJ1Z2d5UVNBID0gcmJ1Z2d5UVNBLmxlbmd0aCAmJiBuZXcgUmVnRXhwKHJidWdneVFTQS5qb2luKCd8JykpOwogICAgICByYnVnZ3lNYXRjaGVzID0gcmJ1Z2d5TWF0Y2hlcy5sZW5ndGggJiYgbmV3IFJlZ0V4cChyYnVnZ3lNYXRjaGVzLmpvaW4oJ3wnKSk7CiAgICAgIC8qIENvbnRhaW5zCiAgICAgIAktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAgICAgIGhhc0NvbXBhcmUgPSBybmF0aXZlLnRlc3QoZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbik7CiAgICAgIC8vIEVsZW1lbnQgY29udGFpbnMgYW5vdGhlcgogICAgICAvLyBQdXJwb3NlZnVsbHkgZG9lcyBub3QgaW1wbGVtZW50IGluY2x1c2l2ZSBkZXNjZW5kZW50CiAgICAgIC8vIEFzIGluLCBhbiBlbGVtZW50IGRvZXMgbm90IGNvbnRhaW4gaXRzZWxmCiAgICAgIGNvbnRhaW5zID0gaGFzQ29tcGFyZSB8fCBybmF0aXZlLnRlc3QoZG9jRWxlbS5jb250YWlucykgPyBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHZhciBhZG93biA9IGEubm9kZVR5cGUgPT09IDkgPyBhLmRvY3VtZW50RWxlbWVudCA6IGEsIGJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwogICAgICAgIHJldHVybiBhID09PSBidXAgfHwgISEoYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoYWRvd24uY29udGFpbnMgPyBhZG93bi5jb250YWlucyhidXApIDogYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGJ1cCkgJiAxNikpOwogICAgICB9IDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICBpZiAoYikgewogICAgICAgICAgd2hpbGUgKGIgPSBiLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgaWYgKGIgPT09IGEpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH07CiAgICAgIC8qIFNvcnRpbmcKICAgICAgCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KICAgICAgLy8gRG9jdW1lbnQgb3JkZXIgc29ydGluZwogICAgICBzb3J0T3JkZXIgPSBoYXNDb21wYXJlID8gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAvLyBGbGFnIGZvciBkdXBsaWNhdGUgcmVtb3ZhbAogICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICBoYXNEdXBsaWNhdGUgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIC8vIFNvcnQgb24gbWV0aG9kIGV4aXN0ZW5jZSBpZiBvbmx5IG9uZSBpbnB1dCBoYXMgY29tcGFyZURvY3VtZW50UG9zaXRpb24KICAgICAgICB2YXIgY29tcGFyZSA9ICFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIC0gIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb247CiAgICAgICAgaWYgKGNvbXBhcmUpIHsKICAgICAgICAgIHJldHVybiBjb21wYXJlOwogICAgICAgIH0KICAgICAgICAvLyBDYWxjdWxhdGUgcG9zaXRpb24gaWYgYm90aCBpbnB1dHMgYmVsb25nIHRvIHRoZSBzYW1lIGRvY3VtZW50CiAgICAgICAgY29tcGFyZSA9IChhLm93bmVyRG9jdW1lbnQgfHwgYSkgPT09IChiLm93bmVyRG9jdW1lbnQgfHwgYikgPyBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGIpIDogLy8gT3RoZXJ3aXNlIHdlIGtub3cgdGhleSBhcmUgZGlzY29ubmVjdGVkCiAgICAgICAgMTsKICAgICAgICAvLyBEaXNjb25uZWN0ZWQgbm9kZXMKICAgICAgICBpZiAoY29tcGFyZSAmIDEgfHwgIXN1cHBvcnQuc29ydERldGFjaGVkICYmIGIuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYSkgPT09IGNvbXBhcmUpIHsKICAgICAgICAgIC8vIENob29zZSB0aGUgZmlyc3QgZWxlbWVudCB0aGF0IGlzIHJlbGF0ZWQgdG8gb3VyIHByZWZlcnJlZCBkb2N1bWVudAogICAgICAgICAgaWYgKGEgPT09IGRvYyB8fCBhLm93bmVyRG9jdW1lbnQgPT09IHByZWZlcnJlZERvYyAmJiBjb250YWlucyhwcmVmZXJyZWREb2MsIGEpKSB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiID09PSBkb2MgfHwgYi5vd25lckRvY3VtZW50ID09PSBwcmVmZXJyZWREb2MgJiYgY29udGFpbnMocHJlZmVycmVkRG9jLCBiKSkgewogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIE1haW50YWluIG9yaWdpbmFsIG9yZGVyCiAgICAgICAgICByZXR1cm4gc29ydElucHV0ID8gaW5kZXhPZi5jYWxsKHNvcnRJbnB1dCwgYSkgLSBpbmRleE9mLmNhbGwoc29ydElucHV0LCBiKSA6IDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb21wYXJlICYgNCA/IC0xIDogMTsKICAgICAgfSA6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgLy8gRXhpdCBlYXJseSBpZiB0aGUgbm9kZXMgYXJlIGlkZW50aWNhbAogICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICBoYXNEdXBsaWNhdGUgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIHZhciBjdXIsIGkgPSAwLCBhdXAgPSBhLnBhcmVudE5vZGUsIGJ1cCA9IGIucGFyZW50Tm9kZSwgYXAgPSBbYV0sIGJwID0gW2JdOwogICAgICAgIC8vIFBhcmVudGxlc3Mgbm9kZXMgYXJlIGVpdGhlciBkb2N1bWVudHMgb3IgZGlzY29ubmVjdGVkCiAgICAgICAgaWYgKCFhdXAgfHwgIWJ1cCkgewogICAgICAgICAgcmV0dXJuIGEgPT09IGRvYyA/IC0xIDogYiA9PT0gZG9jID8gMSA6IGF1cCA/IC0xIDogYnVwID8gMSA6IHNvcnRJbnB1dCA/IGluZGV4T2YuY2FsbChzb3J0SW5wdXQsIGEpIC0gaW5kZXhPZi5jYWxsKHNvcnRJbnB1dCwgYikgOiAwOyAgLy8gSWYgdGhlIG5vZGVzIGFyZSBzaWJsaW5ncywgd2UgY2FuIGRvIGEgcXVpY2sgY2hlY2sKICAgICAgICB9IGVsc2UgaWYgKGF1cCA9PT0gYnVwKSB7CiAgICAgICAgICByZXR1cm4gc2libGluZ0NoZWNrKGEsIGIpOwogICAgICAgIH0KICAgICAgICAvLyBPdGhlcndpc2Ugd2UgbmVlZCBmdWxsIGxpc3RzIG9mIHRoZWlyIGFuY2VzdG9ycyBmb3IgY29tcGFyaXNvbgogICAgICAgIGN1ciA9IGE7CiAgICAgICAgd2hpbGUgKGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgICBhcC51bnNoaWZ0KGN1cik7CiAgICAgICAgfQogICAgICAgIGN1ciA9IGI7CiAgICAgICAgd2hpbGUgKGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgICBicC51bnNoaWZ0KGN1cik7CiAgICAgICAgfQogICAgICAgIC8vIFdhbGsgZG93biB0aGUgdHJlZSBsb29raW5nIGZvciBhIGRpc2NyZXBhbmN5CiAgICAgICAgd2hpbGUgKGFwW2ldID09PSBicFtpXSkgewogICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaSA/IC8vIERvIGEgc2libGluZyBjaGVjayBpZiB0aGUgbm9kZXMgaGF2ZSBhIGNvbW1vbiBhbmNlc3RvcgogICAgICAgIHNpYmxpbmdDaGVjayhhcFtpXSwgYnBbaV0pIDogLy8gT3RoZXJ3aXNlIG5vZGVzIGluIG91ciBkb2N1bWVudCBzb3J0IGZpcnN0CiAgICAgICAgYXBbaV0gPT09IHByZWZlcnJlZERvYyA/IC0xIDogYnBbaV0gPT09IHByZWZlcnJlZERvYyA/IDEgOiAwOwogICAgICB9OwogICAgICByZXR1cm4gZG9jOwogICAgfTsKICAgIFNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24gKGV4cHIsIGVsZW1lbnRzKSB7CiAgICAgIHJldHVybiBTaXp6bGUoZXhwciwgbnVsbCwgbnVsbCwgZWxlbWVudHMpOwogICAgfTsKICAgIFNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiAoZWxlbSwgZXhwcikgewogICAgICAvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKICAgICAgaWYgKChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkgIT09IGRvY3VtZW50KSB7CiAgICAgICAgc2V0RG9jdW1lbnQoZWxlbSk7CiAgICAgIH0KICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgYXR0cmlidXRlIHNlbGVjdG9ycyBhcmUgcXVvdGVkCiAgICAgIGV4cHIgPSBleHByLnJlcGxhY2UocmF0dHJpYnV0ZVF1b3RlcywgJz1cJyQxXCddJyk7CiAgICAgIGlmIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciAmJiBkb2N1bWVudElzSFRNTCAmJiAoIXJidWdneU1hdGNoZXMgfHwgIXJidWdneU1hdGNoZXMudGVzdChleHByKSkgJiYgKCFyYnVnZ3lRU0EgfHwgIXJidWdneVFTQS50ZXN0KGV4cHIpKSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcmV0ID0gbWF0Y2hlcy5jYWxsKGVsZW0sIGV4cHIpOwogICAgICAgICAgLy8gSUUgOSdzIG1hdGNoZXNTZWxlY3RvciByZXR1cm5zIGZhbHNlIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwogICAgICAgICAgaWYgKHJldCB8fCBzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoIHx8IC8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50CiAgICAgICAgICAgIC8vIGZyYWdtZW50IGluIElFIDkKICAgICAgICAgICAgZWxlbS5kb2N1bWVudCAmJiBlbGVtLmRvY3VtZW50Lm5vZGVUeXBlICE9PSAxMSkgewogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIFNpenpsZShleHByLCBkb2N1bWVudCwgbnVsbCwgW2VsZW1dKS5sZW5ndGggPiAwOwogICAgfTsKICAgIFNpenpsZS5jb250YWlucyA9IGZ1bmN0aW9uIChjb250ZXh0LCBlbGVtKSB7CiAgICAgIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogICAgICBpZiAoKGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0KSAhPT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChjb250ZXh0KTsKICAgICAgfQogICAgICByZXR1cm4gY29udGFpbnMoY29udGV4dCwgZWxlbSk7CiAgICB9OwogICAgU2l6emxlLmF0dHIgPSBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICAvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKICAgICAgaWYgKChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkgIT09IGRvY3VtZW50KSB7CiAgICAgICAgc2V0RG9jdW1lbnQoZWxlbSk7CiAgICAgIH0KICAgICAgdmFyIGZuID0gRXhwci5hdHRySGFuZGxlW25hbWUudG9Mb3dlckNhc2UoKV0sCiAgICAgICAgLy8gRG9uJ3QgZ2V0IGZvb2xlZCBieSBPYmplY3QucHJvdG90eXBlIHByb3BlcnRpZXMgKGpRdWVyeSAjMTM4MDcpCiAgICAgICAgdmFsID0gZm4gJiYgaGFzT3duLmNhbGwoRXhwci5hdHRySGFuZGxlLCBuYW1lLnRvTG93ZXJDYXNlKCkpID8gZm4oZWxlbSwgbmFtZSwgIWRvY3VtZW50SXNIVE1MKSA6IHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIHZhbCAhPT0gdW5kZWZpbmVkID8gdmFsIDogc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFkb2N1bWVudElzSFRNTCA/IGVsZW0uZ2V0QXR0cmlidXRlKG5hbWUpIDogKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZShuYW1lKSkgJiYgdmFsLnNwZWNpZmllZCA/IHZhbC52YWx1ZSA6IG51bGw7CiAgICB9OwogICAgU2l6emxlLmVycm9yID0gZnVuY3Rpb24gKG1zZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICcgKyBtc2cpOwogICAgfTsKICAgIC8qKgogICAgICogRG9jdW1lbnQgc29ydGluZyBhbmQgcmVtb3ZpbmcgZHVwbGljYXRlcwogICAgICogQHBhcmFtIHtBcnJheUxpa2V9IHJlc3VsdHMKICAgICAqLwogICAgU2l6emxlLnVuaXF1ZVNvcnQgPSBmdW5jdGlvbiAocmVzdWx0cykgewogICAgICB2YXIgZWxlbSwgZHVwbGljYXRlcyA9IFtdLCBqID0gMCwgaSA9IDA7CiAgICAgIC8vIFVubGVzcyB3ZSAqa25vdyogd2UgY2FuIGRldGVjdCBkdXBsaWNhdGVzLCBhc3N1bWUgdGhlaXIgcHJlc2VuY2UKICAgICAgaGFzRHVwbGljYXRlID0gIXN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlczsKICAgICAgc29ydElucHV0ID0gIXN1cHBvcnQuc29ydFN0YWJsZSAmJiByZXN1bHRzLnNsaWNlKDApOwogICAgICByZXN1bHRzLnNvcnQoc29ydE9yZGVyKTsKICAgICAgaWYgKGhhc0R1cGxpY2F0ZSkgewogICAgICAgIHdoaWxlIChlbGVtID0gcmVzdWx0c1tpKytdKSB7CiAgICAgICAgICBpZiAoZWxlbSA9PT0gcmVzdWx0c1tpXSkgewogICAgICAgICAgICBqID0gZHVwbGljYXRlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICByZXN1bHRzLnNwbGljZShkdXBsaWNhdGVzW2pdLCAxKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQ2xlYXIgaW5wdXQgYWZ0ZXIgc29ydGluZyB0byByZWxlYXNlIG9iamVjdHMKICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvc2l6emxlL3B1bGwvMjI1CiAgICAgIHNvcnRJbnB1dCA9IG51bGw7CiAgICAgIHJldHVybiByZXN1bHRzOwogICAgfTsKICAgIC8qKgogICAgICogVXRpbGl0eSBmdW5jdGlvbiBmb3IgcmV0cmlldmluZyB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKICAgICAqIEBwYXJhbSB7QXJyYXl8RWxlbWVudH0gZWxlbQogICAgICovCiAgICBnZXRUZXh0ID0gU2l6emxlLmdldFRleHQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICB2YXIgbm9kZSwgcmV0ID0gJycsIGkgPSAwLCBub2RlVHlwZSA9IGVsZW0ubm9kZVR5cGU7CiAgICAgIGlmICghbm9kZVR5cGUpIHsKICAgICAgICAvLyBJZiBubyBub2RlVHlwZSwgdGhpcyBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheQogICAgICAgIHdoaWxlIChub2RlID0gZWxlbVtpKytdKSB7CiAgICAgICAgICAvLyBEbyBub3QgdHJhdmVyc2UgY29tbWVudCBub2RlcwogICAgICAgICAgcmV0ICs9IGdldFRleHQobm9kZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG5vZGVUeXBlID09PSAxIHx8IG5vZGVUeXBlID09PSA5IHx8IG5vZGVUeXBlID09PSAxMSkgewogICAgICAgIC8vIFVzZSB0ZXh0Q29udGVudCBmb3IgZWxlbWVudHMKICAgICAgICAvLyBpbm5lclRleHQgdXNhZ2UgcmVtb3ZlZCBmb3IgY29uc2lzdGVuY3kgb2YgbmV3IGxpbmVzIChqUXVlcnkgIzExMTUzKQogICAgICAgIGlmICh0eXBlb2YgZWxlbS50ZXh0Q29udGVudCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJldHVybiBlbGVtLnRleHRDb250ZW50OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBUcmF2ZXJzZSBpdHMgY2hpbGRyZW4KICAgICAgICAgIGZvciAoZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsgZWxlbTsgZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgcmV0ICs9IGdldFRleHQoZWxlbSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0KSB7CiAgICAgICAgcmV0dXJuIGVsZW0ubm9kZVZhbHVlOwogICAgICB9CiAgICAgIC8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwogICAgICByZXR1cm4gcmV0OwogICAgfTsKICAgIEV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzID0gewogICAgICAvLyBDYW4gYmUgYWRqdXN0ZWQgYnkgdGhlIHVzZXIKICAgICAgY2FjaGVMZW5ndGg6IDUwLAogICAgICBjcmVhdGVQc2V1ZG86IG1hcmtGdW5jdGlvbiwKICAgICAgbWF0Y2g6IG1hdGNoRXhwciwKICAgICAgYXR0ckhhbmRsZToge30sCiAgICAgIGZpbmQ6IHt9LAogICAgICByZWxhdGl2ZTogewogICAgICAgICc+JzogewogICAgICAgICAgZGlyOiAncGFyZW50Tm9kZScsCiAgICAgICAgICBmaXJzdDogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgJyAnOiB7IGRpcjogJ3BhcmVudE5vZGUnIH0sCiAgICAgICAgJysnOiB7CiAgICAgICAgICBkaXI6ICdwcmV2aW91c1NpYmxpbmcnLAogICAgICAgICAgZmlyc3Q6IHRydWUKICAgICAgICB9LAogICAgICAgICd+JzogeyBkaXI6ICdwcmV2aW91c1NpYmxpbmcnIH0KICAgICAgfSwKICAgICAgcHJlRmlsdGVyOiB7CiAgICAgICAgJ0FUVFInOiBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICAgIG1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSk7CiAgICAgICAgICAvLyBNb3ZlIHRoZSBnaXZlbiB2YWx1ZSB0byBtYXRjaFszXSB3aGV0aGVyIHF1b3RlZCBvciB1bnF1b3RlZAogICAgICAgICAgbWF0Y2hbM10gPSAobWF0Y2hbM10gfHwgbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgJycpLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpOwogICAgICAgICAgaWYgKG1hdGNoWzJdID09PSAnfj0nKSB7CiAgICAgICAgICAgIG1hdGNoWzNdID0gJyAnICsgbWF0Y2hbM10gKyAnICc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2guc2xpY2UoMCwgNCk7CiAgICAgICAgfSwKICAgICAgICAnQ0hJTEQnOiBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICAgIC8qIG1hdGNoZXMgZnJvbSBtYXRjaEV4cHJbIkNISUxEIl0KICAgICAgICAgIAkJMSB0eXBlIChvbmx5fG50aHwuLi4pCiAgICAgICAgICAJCTIgd2hhdCAoY2hpbGR8b2YtdHlwZSkKICAgICAgICAgIAkJMyBhcmd1bWVudCAoZXZlbnxvZGR8XGQqfFxkKm4oWystXVxkKyk/fC4uLikKICAgICAgICAgIAkJNCB4bi1jb21wb25lbnQgb2YgeG4reSBhcmd1bWVudCAoWystXT9cZCpufCkKICAgICAgICAgIAkJNSBzaWduIG9mIHhuLWNvbXBvbmVudAogICAgICAgICAgCQk2IHggb2YgeG4tY29tcG9uZW50CiAgICAgICAgICAJCTcgc2lnbiBvZiB5LWNvbXBvbmVudAogICAgICAgICAgCQk4IHkgb2YgeS1jb21wb25lbnQKICAgICAgICAgIAkqLwogICAgICAgICAgbWF0Y2hbMV0gPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYgKG1hdGNoWzFdLnNsaWNlKDAsIDMpID09PSAnbnRoJykgewogICAgICAgICAgICAvLyBudGgtKiByZXF1aXJlcyBhcmd1bWVudAogICAgICAgICAgICBpZiAoIW1hdGNoWzNdKSB7CiAgICAgICAgICAgICAgU2l6emxlLmVycm9yKG1hdGNoWzBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBudW1lcmljIHggYW5kIHkgcGFyYW1ldGVycyBmb3IgRXhwci5maWx0ZXIuQ0hJTEQKICAgICAgICAgICAgLy8gcmVtZW1iZXIgdGhhdCBmYWxzZS90cnVlIGNhc3QgcmVzcGVjdGl2ZWx5IHRvIDAvMQogICAgICAgICAgICBtYXRjaFs0XSA9ICsobWF0Y2hbNF0gPyBtYXRjaFs1XSArIChtYXRjaFs2XSB8fCAxKSA6IDIgKiAobWF0Y2hbM10gPT09ICdldmVuJyB8fCBtYXRjaFszXSA9PT0gJ29kZCcpKTsKICAgICAgICAgICAgbWF0Y2hbNV0gPSArKG1hdGNoWzddICsgbWF0Y2hbOF0gfHwgbWF0Y2hbM10gPT09ICdvZGQnKTsgIC8vIG90aGVyIHR5cGVzIHByb2hpYml0IGFyZ3VtZW50cwogICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFszXSkgewogICAgICAgICAgICBTaXp6bGUuZXJyb3IobWF0Y2hbMF0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgIH0sCiAgICAgICAgJ1BTRVVETyc6IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgdmFyIGV4Y2VzcywgdW5xdW90ZWQgPSAhbWF0Y2hbNl0gJiYgbWF0Y2hbMl07CiAgICAgICAgICBpZiAobWF0Y2hFeHByWydDSElMRCddLnRlc3QobWF0Y2hbMF0pKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgLy8gQWNjZXB0IHF1b3RlZCBhcmd1bWVudHMgYXMtaXMKICAgICAgICAgIGlmIChtYXRjaFszXSkgewogICAgICAgICAgICBtYXRjaFsyXSA9IG1hdGNoWzRdIHx8IG1hdGNoWzVdIHx8ICcnOyAgLy8gU3RyaXAgZXhjZXNzIGNoYXJhY3RlcnMgZnJvbSB1bnF1b3RlZCBhcmd1bWVudHMKICAgICAgICAgIH0gZWxzZSBpZiAodW5xdW90ZWQgJiYgcnBzZXVkby50ZXN0KHVucXVvdGVkKSAmJiAoZXhjZXNzID0gdG9rZW5pemUodW5xdW90ZWQsIHRydWUpKSAmJiAoZXhjZXNzID0gdW5xdW90ZWQuaW5kZXhPZignKScsIHVucXVvdGVkLmxlbmd0aCAtIGV4Y2VzcykgLSB1bnF1b3RlZC5sZW5ndGgpKSB7CiAgICAgICAgICAgIC8vIGV4Y2VzcyBpcyBhIG5lZ2F0aXZlIGluZGV4CiAgICAgICAgICAgIG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoMCwgZXhjZXNzKTsKICAgICAgICAgICAgbWF0Y2hbMl0gPSB1bnF1b3RlZC5zbGljZSgwLCBleGNlc3MpOwogICAgICAgICAgfQogICAgICAgICAgLy8gUmV0dXJuIG9ubHkgY2FwdHVyZXMgbmVlZGVkIGJ5IHRoZSBwc2V1ZG8gZmlsdGVyIG1ldGhvZCAodHlwZSBhbmQgYXJndW1lbnQpCiAgICAgICAgICByZXR1cm4gbWF0Y2guc2xpY2UoMCwgMyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBmaWx0ZXI6IHsKICAgICAgICAnVEFHJzogZnVuY3Rpb24gKG5vZGVOYW1lU2VsZWN0b3IpIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IG5vZGVOYW1lU2VsZWN0b3IucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZVNlbGVjdG9yID09PSAnKicgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSA6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZU5hbWU7CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgJ0NMQVNTJzogZnVuY3Rpb24gKGNsYXNzTmFtZSkgewogICAgICAgICAgdmFyIHBhdHRlcm4gPSBjbGFzc0NhY2hlW2NsYXNzTmFtZSArICcgJ107CiAgICAgICAgICByZXR1cm4gcGF0dGVybiB8fCAocGF0dGVybiA9IG5ldyBSZWdFeHAoJyhefCcgKyB3aGl0ZXNwYWNlICsgJyknICsgY2xhc3NOYW1lICsgJygnICsgd2hpdGVzcGFjZSArICd8JCknKSkgJiYgY2xhc3NDYWNoZShjbGFzc05hbWUsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBwYXR0ZXJuLnRlc3QodHlwZW9mIGVsZW0uY2xhc3NOYW1lID09PSAnc3RyaW5nJyAmJiBlbGVtLmNsYXNzTmFtZSB8fCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgIT09IHN0cnVuZGVmaW5lZCAmJiBlbGVtLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJyk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgICdBVFRSJzogZnVuY3Rpb24gKG5hbWUsIG9wZXJhdG9yLCBjaGVjaykgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBTaXp6bGUuYXR0cihlbGVtLCBuYW1lKTsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG9wZXJhdG9yID09PSAnIT0nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghb3BlcmF0b3IpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQgKz0gJyc7CiAgICAgICAgICAgIHJldHVybiBvcGVyYXRvciA9PT0gJz0nID8gcmVzdWx0ID09PSBjaGVjayA6IG9wZXJhdG9yID09PSAnIT0nID8gcmVzdWx0ICE9PSBjaGVjayA6IG9wZXJhdG9yID09PSAnXj0nID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoY2hlY2spID09PSAwIDogb3BlcmF0b3IgPT09ICcqPScgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZihjaGVjaykgPiAtMSA6IG9wZXJhdG9yID09PSAnJD0nID8gY2hlY2sgJiYgcmVzdWx0LnNsaWNlKC1jaGVjay5sZW5ndGgpID09PSBjaGVjayA6IG9wZXJhdG9yID09PSAnfj0nID8gKCcgJyArIHJlc3VsdCArICcgJykuaW5kZXhPZihjaGVjaykgPiAtMSA6IG9wZXJhdG9yID09PSAnfD0nID8gcmVzdWx0ID09PSBjaGVjayB8fCByZXN1bHQuc2xpY2UoMCwgY2hlY2subGVuZ3RoICsgMSkgPT09IGNoZWNrICsgJy0nIDogZmFsc2U7CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgJ0NISUxEJzogZnVuY3Rpb24gKHR5cGUsIHdoYXQsIGFyZ3VtZW50LCBmaXJzdCwgbGFzdCkgewogICAgICAgICAgdmFyIHNpbXBsZSA9IHR5cGUuc2xpY2UoMCwgMykgIT09ICdudGgnLCBmb3J3YXJkID0gdHlwZS5zbGljZSgtNCkgIT09ICdsYXN0Jywgb2ZUeXBlID0gd2hhdCA9PT0gJ29mLXR5cGUnOwogICAgICAgICAgcmV0dXJuIGZpcnN0ID09PSAxICYmIGxhc3QgPT09IDAgPyAvLyBTaG9ydGN1dCBmb3IgOm50aC0qKG4pCiAgICAgICAgICBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gISFlbGVtLnBhcmVudE5vZGU7CiAgICAgICAgICB9IDogZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgICAgICB2YXIgY2FjaGUsIG91dGVyQ2FjaGUsIG5vZGUsIGRpZmYsIG5vZGVJbmRleCwgc3RhcnQsIGRpciA9IHNpbXBsZSAhPT0gZm9yd2FyZCA/ICduZXh0U2libGluZycgOiAncHJldmlvdXNTaWJsaW5nJywgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlLCBuYW1lID0gb2ZUeXBlICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwgdXNlQ2FjaGUgPSAheG1sICYmICFvZlR5cGU7CiAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAvLyA6KGZpcnN0fGxhc3R8b25seSktKGNoaWxkfG9mLXR5cGUpCiAgICAgICAgICAgICAgaWYgKHNpbXBsZSkgewogICAgICAgICAgICAgICAgd2hpbGUgKGRpcikgewogICAgICAgICAgICAgICAgICBub2RlID0gZWxlbTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgPSBub2RlW2Rpcl0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAob2ZUeXBlID8gbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lIDogbm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBSZXZlcnNlIGRpcmVjdGlvbiBmb3IgOm9ubHktKiAoaWYgd2UgaGF2ZW4ndCB5ZXQgZG9uZSBzbykKICAgICAgICAgICAgICAgICAgc3RhcnQgPSBkaXIgPSB0eXBlID09PSAnb25seScgJiYgIXN0YXJ0ICYmICduZXh0U2libGluZyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhcnQgPSBbZm9yd2FyZCA/IHBhcmVudC5maXJzdENoaWxkIDogcGFyZW50Lmxhc3RDaGlsZF07CiAgICAgICAgICAgICAgLy8gbm9uLXhtbCA6bnRoLWNoaWxkKC4uLikgc3RvcmVzIGNhY2hlIGRhdGEgb24gYHBhcmVudGAKICAgICAgICAgICAgICBpZiAoZm9yd2FyZCAmJiB1c2VDYWNoZSkgewogICAgICAgICAgICAgICAgLy8gU2VlayBgZWxlbWAgZnJvbSBhIHByZXZpb3VzbHktY2FjaGVkIGluZGV4CiAgICAgICAgICAgICAgICBvdXRlckNhY2hlID0gcGFyZW50W2V4cGFuZG9dIHx8IChwYXJlbnRbZXhwYW5kb10gPSB7fSk7CiAgICAgICAgICAgICAgICBjYWNoZSA9IG91dGVyQ2FjaGVbdHlwZV0gfHwgW107CiAgICAgICAgICAgICAgICBub2RlSW5kZXggPSBjYWNoZVswXSA9PT0gZGlycnVucyAmJiBjYWNoZVsxXTsKICAgICAgICAgICAgICAgIGRpZmYgPSBjYWNoZVswXSA9PT0gZGlycnVucyAmJiBjYWNoZVsyXTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlSW5kZXggJiYgcGFyZW50LmNoaWxkTm9kZXNbbm9kZUluZGV4XTsKICAgICAgICAgICAgICAgIHdoaWxlIChub2RlID0gKytub2RlSW5kZXggJiYgbm9kZSAmJiBub2RlW2Rpcl0gfHwgKGRpZmYgPSBub2RlSW5kZXggPSAwKSB8fCBzdGFydC5wb3AoKSkgewogICAgICAgICAgICAgICAgICAvLyBXaGVuIGZvdW5kLCBjYWNoZSBpbmRleGVzIG9uIGBwYXJlbnRgIGFuZCBicmVhawogICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSAmJiArK2RpZmYgJiYgbm9kZSA9PT0gZWxlbSkgewogICAgICAgICAgICAgICAgICAgIG91dGVyQ2FjaGVbdHlwZV0gPSBbCiAgICAgICAgICAgICAgICAgICAgICBkaXJydW5zLAogICAgICAgICAgICAgICAgICAgICAgbm9kZUluZGV4LAogICAgICAgICAgICAgICAgICAgICAgZGlmZgogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gIC8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodXNlQ2FjaGUgJiYgKGNhY2hlID0gKGVsZW1bZXhwYW5kb10gfHwgKGVsZW1bZXhwYW5kb10gPSB7fSkpW3R5cGVdKSAmJiBjYWNoZVswXSA9PT0gZGlycnVucykgewogICAgICAgICAgICAgICAgZGlmZiA9IGNhY2hlWzFdOyAgLy8geG1sIDpudGgtY2hpbGQoLi4uKSBvciA6bnRoLWxhc3QtY2hpbGQoLi4uKSBvciA6bnRoKC1sYXN0KT8tb2YtdHlwZSguLi4pCiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgc2FtZSBsb29wIGFzIGFib3ZlIHRvIHNlZWsgYGVsZW1gIGZyb20gdGhlIHN0YXJ0CiAgICAgICAgICAgICAgICB3aGlsZSAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVtkaXJdIHx8IChkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpIHsKICAgICAgICAgICAgICAgICAgaWYgKChvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxKSAmJiArK2RpZmYpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYWNoZSB0aGUgaW5kZXggb2YgZWFjaCBlbmNvdW50ZXJlZCBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHVzZUNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAobm9kZVtleHBhbmRvXSB8fCAobm9kZVtleHBhbmRvXSA9IHt9KSlbdHlwZV0gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgIGRpcnJ1bnMsCiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmYKICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gSW5jb3Jwb3JhdGUgdGhlIG9mZnNldCwgdGhlbiBjaGVjayBhZ2FpbnN0IGN5Y2xlIHNpemUKICAgICAgICAgICAgICBkaWZmIC09IGxhc3Q7CiAgICAgICAgICAgICAgcmV0dXJuIGRpZmYgPT09IGZpcnN0IHx8IGRpZmYgJSBmaXJzdCA9PT0gMCAmJiBkaWZmIC8gZmlyc3QgPj0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgICdQU0VVRE8nOiBmdW5jdGlvbiAocHNldWRvLCBhcmd1bWVudCkgewogICAgICAgICAgLy8gcHNldWRvLWNsYXNzIG5hbWVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlCiAgICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI3BzZXVkby1jbGFzc2VzCiAgICAgICAgICAvLyBQcmlvcml0aXplIGJ5IGNhc2Ugc2Vuc2l0aXZpdHkgaW4gY2FzZSBjdXN0b20gcHNldWRvcyBhcmUgYWRkZWQgd2l0aCB1cHBlcmNhc2UgbGV0dGVycwogICAgICAgICAgLy8gUmVtZW1iZXIgdGhhdCBzZXRGaWx0ZXJzIGluaGVyaXRzIGZyb20gcHNldWRvcwogICAgICAgICAgdmFyIGFyZ3MsIGZuID0gRXhwci5wc2V1ZG9zW3BzZXVkb10gfHwgRXhwci5zZXRGaWx0ZXJzW3BzZXVkby50b0xvd2VyQ2FzZSgpXSB8fCBTaXp6bGUuZXJyb3IoJ3Vuc3VwcG9ydGVkIHBzZXVkbzogJyArIHBzZXVkbyk7CiAgICAgICAgICAvLyBUaGUgdXNlciBtYXkgdXNlIGNyZWF0ZVBzZXVkbyB0byBpbmRpY2F0ZSB0aGF0CiAgICAgICAgICAvLyBhcmd1bWVudHMgYXJlIG5lZWRlZCB0byBjcmVhdGUgdGhlIGZpbHRlciBmdW5jdGlvbgogICAgICAgICAgLy8ganVzdCBhcyBTaXp6bGUgZG9lcwogICAgICAgICAgaWYgKGZuW2V4cGFuZG9dKSB7CiAgICAgICAgICAgIHJldHVybiBmbihhcmd1bWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBCdXQgbWFpbnRhaW4gc3VwcG9ydCBmb3Igb2xkIHNpZ25hdHVyZXMKICAgICAgICAgIGlmIChmbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIGFyZ3MgPSBbCiAgICAgICAgICAgICAgcHNldWRvLAogICAgICAgICAgICAgIHBzZXVkbywKICAgICAgICAgICAgICAnJywKICAgICAgICAgICAgICBhcmd1bWVudAogICAgICAgICAgICBdOwogICAgICAgICAgICByZXR1cm4gRXhwci5zZXRGaWx0ZXJzLmhhc093blByb3BlcnR5KHBzZXVkby50b0xvd2VyQ2FzZSgpKSA/IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoc2VlZCwgbWF0Y2hlcykgewogICAgICAgICAgICAgIHZhciBpZHgsIG1hdGNoZWQgPSBmbihzZWVkLCBhcmd1bWVudCksIGkgPSBtYXRjaGVkLmxlbmd0aDsKICAgICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgICBpZHggPSBpbmRleE9mLmNhbGwoc2VlZCwgbWF0Y2hlZFtpXSk7CiAgICAgICAgICAgICAgICBzZWVkW2lkeF0gPSAhKG1hdGNoZXNbaWR4XSA9IG1hdGNoZWRbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkgOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgIHJldHVybiBmbihlbGVtLCAwLCBhcmdzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHBzZXVkb3M6IHsKICAgICAgICAvLyBQb3RlbnRpYWxseSBjb21wbGV4IHBzZXVkb3MKICAgICAgICAnbm90JzogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgLy8gVHJpbSB0aGUgc2VsZWN0b3IgcGFzc2VkIHRvIGNvbXBpbGUKICAgICAgICAgIC8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCiAgICAgICAgICAvLyBzcGFjZXMgYXMgY29tYmluYXRvcnMKICAgICAgICAgIHZhciBpbnB1dCA9IFtdLCByZXN1bHRzID0gW10sIG1hdGNoZXIgPSBjb21waWxlKHNlbGVjdG9yLnJlcGxhY2UocnRyaW0sICckMScpKTsKICAgICAgICAgIHJldHVybiBtYXRjaGVyW2V4cGFuZG9dID8gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICAgICAgdmFyIGVsZW0sIHVubWF0Y2hlZCA9IG1hdGNoZXIoc2VlZCwgbnVsbCwgeG1sLCBbXSksIGkgPSBzZWVkLmxlbmd0aDsKICAgICAgICAgICAgLy8gTWF0Y2ggZWxlbWVudHMgdW5tYXRjaGVkIGJ5IGBtYXRjaGVyYAogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgaWYgKGVsZW0gPSB1bm1hdGNoZWRbaV0pIHsKICAgICAgICAgICAgICAgIHNlZWRbaV0gPSAhKG1hdGNoZXNbaV0gPSBlbGVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pIDogZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgICAgICBpbnB1dFswXSA9IGVsZW07CiAgICAgICAgICAgIG1hdGNoZXIoaW5wdXQsIG51bGwsIHhtbCwgcmVzdWx0cyk7CiAgICAgICAgICAgIHJldHVybiAhcmVzdWx0cy5wb3AoKTsKICAgICAgICAgIH07CiAgICAgICAgfSksCiAgICAgICAgJ2hhcyc6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gU2l6emxlKHNlbGVjdG9yLCBlbGVtKS5sZW5ndGggPiAwOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAnY29udGFpbnMnOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gKGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lclRleHQgfHwgZ2V0VGV4dChlbGVtKSkuaW5kZXhPZih0ZXh0KSA+IC0xOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAvLyAiV2hldGhlciBhbiBlbGVtZW50IGlzIHJlcHJlc2VudGVkIGJ5IGEgOmxhbmcoKSBzZWxlY3RvcgogICAgICAgIC8vIGlzIGJhc2VkIHNvbGVseSBvbiB0aGUgZWxlbWVudCdzIGxhbmd1YWdlIHZhbHVlCiAgICAgICAgLy8gYmVpbmcgZXF1YWwgdG8gdGhlIGlkZW50aWZpZXIgQywKICAgICAgICAvLyBvciBiZWdpbm5pbmcgd2l0aCB0aGUgaWRlbnRpZmllciBDIGltbWVkaWF0ZWx5IGZvbGxvd2VkIGJ5ICItIi4KICAgICAgICAvLyBUaGUgbWF0Y2hpbmcgb2YgQyBhZ2FpbnN0IHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUgaXMgcGVyZm9ybWVkIGNhc2UtaW5zZW5zaXRpdmVseS4KICAgICAgICAvLyBUaGUgaWRlbnRpZmllciBDIGRvZXMgbm90IGhhdmUgdG8gYmUgYSB2YWxpZCBsYW5ndWFnZSBuYW1lLiIKICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2xhbmctcHNldWRvCiAgICAgICAgJ2xhbmcnOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKGxhbmcpIHsKICAgICAgICAgIC8vIGxhbmcgdmFsdWUgbXVzdCBiZSBhIHZhbGlkIGlkZW50aWZpZXIKICAgICAgICAgIGlmICghcmlkZW50aWZpZXIudGVzdChsYW5nIHx8ICcnKSkgewogICAgICAgICAgICBTaXp6bGUuZXJyb3IoJ3Vuc3VwcG9ydGVkIGxhbmc6ICcgKyBsYW5nKTsKICAgICAgICAgIH0KICAgICAgICAgIGxhbmcgPSBsYW5nLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgdmFyIGVsZW1MYW5nOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKGVsZW1MYW5nID0gZG9jdW1lbnRJc0hUTUwgPyBlbGVtLmxhbmcgOiBlbGVtLmdldEF0dHJpYnV0ZSgneG1sOmxhbmcnKSB8fCBlbGVtLmdldEF0dHJpYnV0ZSgnbGFuZycpKSB7CiAgICAgICAgICAgICAgICBlbGVtTGFuZyA9IGVsZW1MYW5nLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbUxhbmcgPT09IGxhbmcgfHwgZWxlbUxhbmcuaW5kZXhPZihsYW5nICsgJy0nKSA9PT0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKChlbGVtID0gZWxlbS5wYXJlbnROb2RlKSAmJiBlbGVtLm5vZGVUeXBlID09PSAxKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAvLyBNaXNjZWxsYW5lb3VzCiAgICAgICAgJ3RhcmdldCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaDsKICAgICAgICAgIHJldHVybiBoYXNoICYmIGhhc2guc2xpY2UoMSkgPT09IGVsZW0uaWQ7CiAgICAgICAgfSwKICAgICAgICAncm9vdCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gZG9jRWxlbTsKICAgICAgICB9LAogICAgICAgICdmb2N1cyc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAoIWRvY3VtZW50Lmhhc0ZvY3VzIHx8IGRvY3VtZW50Lmhhc0ZvY3VzKCkpICYmICEhKGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXgpOwogICAgICAgIH0sCiAgICAgICAgLy8gQm9vbGVhbiBwcm9wZXJ0aWVzCiAgICAgICAgJ2VuYWJsZWQnOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgJ2Rpc2FibGVkJzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSB0cnVlOwogICAgICAgIH0sCiAgICAgICAgJ2NoZWNrZWQnOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgLy8gSW4gQ1NTMywgOmNoZWNrZWQgc2hvdWxkIHJldHVybiBib3RoIGNoZWNrZWQgYW5kIHNlbGVjdGVkIGVsZW1lbnRzCiAgICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDExL1JFQy1jc3MzLXNlbGVjdG9ycy0yMDExMDkyOS8jY2hlY2tlZAogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lID09PSAnaW5wdXQnICYmICEhZWxlbS5jaGVja2VkIHx8IG5vZGVOYW1lID09PSAnb3B0aW9uJyAmJiAhIWVsZW0uc2VsZWN0ZWQ7CiAgICAgICAgfSwKICAgICAgICAnc2VsZWN0ZWQnOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgLy8gQWNjZXNzaW5nIHRoaXMgcHJvcGVydHkgbWFrZXMgc2VsZWN0ZWQtYnktZGVmYXVsdAogICAgICAgICAgLy8gb3B0aW9ucyBpbiBTYWZhcmkgd29yayBwcm9wZXJseQogICAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOwogICAgICAgIH0sCiAgICAgICAgLy8gQ29udGVudHMKICAgICAgICAnZW1wdHknOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNlbXB0eS1wc2V1ZG8KICAgICAgICAgIC8vIDplbXB0eSBpcyBuZWdhdGVkIGJ5IGVsZW1lbnQgKDEpIG9yIGNvbnRlbnQgbm9kZXMgKHRleHQ6IDM7IGNkYXRhOiA0OyBlbnRpdHkgcmVmOiA1KSwKICAgICAgICAgIC8vICAgYnV0IG5vdCBieSBvdGhlcnMgKGNvbW1lbnQ6IDg7IHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb246IDc7IGV0Yy4pCiAgICAgICAgICAvLyBub2RlVHlwZSA8IDYgd29ya3MgYmVjYXVzZSBhdHRyaWJ1dGVzICgyKSBkbyBub3QgYXBwZWFyIGFzIGNoaWxkcmVuCiAgICAgICAgICBmb3IgKGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlIDwgNikgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICAncGFyZW50JzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiAhRXhwci5wc2V1ZG9zWydlbXB0eSddKGVsZW0pOwogICAgICAgIH0sCiAgICAgICAgLy8gRWxlbWVudC9pbnB1dCB0eXBlcwogICAgICAgICdoZWFkZXInOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIHJoZWFkZXIudGVzdChlbGVtLm5vZGVOYW1lKTsKICAgICAgICB9LAogICAgICAgICdpbnB1dCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gcmlucHV0cy50ZXN0KGVsZW0ubm9kZU5hbWUpOwogICAgICAgIH0sCiAgICAgICAgJ2J1dHRvbic6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBuYW1lID09PSAnaW5wdXQnICYmIGVsZW0udHlwZSA9PT0gJ2J1dHRvbicgfHwgbmFtZSA9PT0gJ2J1dHRvbic7CiAgICAgICAgfSwKICAgICAgICAndGV4dCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgYXR0cjsKICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdpbnB1dCcgJiYgZWxlbS50eXBlID09PSAndGV4dCcgJiYgKChhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGUoJ3R5cGUnKSkgPT0gbnVsbCB8fCBhdHRyLnRvTG93ZXJDYXNlKCkgPT09ICd0ZXh0Jyk7CiAgICAgICAgfSwKICAgICAgICAvLyBQb3NpdGlvbi1pbi1jb2xsZWN0aW9uCiAgICAgICAgJ2ZpcnN0JzogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gWzBdOwogICAgICAgIH0pLAogICAgICAgICdsYXN0JzogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBbbGVuZ3RoIC0gMV07CiAgICAgICAgfSksCiAgICAgICAgJ2VxJzogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50KSB7CiAgICAgICAgICByZXR1cm4gW2FyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnRdOwogICAgICAgIH0pLAogICAgICAgICdldmVuJzogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgpIHsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pLAogICAgICAgICdvZGQnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCkgewogICAgICAgICAgdmFyIGkgPSAxOwogICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICBtYXRjaEluZGV4ZXMucHVzaChpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICAgICAgfSksCiAgICAgICAgJ2x0JzogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50KSB7CiAgICAgICAgICB2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7CiAgICAgICAgICBmb3IgKDsgLS1pID49IDA7KSB7CiAgICAgICAgICAgIG1hdGNoSW5kZXhlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoSW5kZXhlczsKICAgICAgICB9KSwKICAgICAgICAnZ3QnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQpIHsKICAgICAgICAgIHZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudDsKICAgICAgICAgIGZvciAoOyArK2kgPCBsZW5ndGg7KSB7CiAgICAgICAgICAgIG1hdGNoSW5kZXhlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoSW5kZXhlczsKICAgICAgICB9KQogICAgICB9CiAgICB9OwogICAgRXhwci5wc2V1ZG9zWydudGgnXSA9IEV4cHIucHNldWRvc1snZXEnXTsKICAgIC8vIEFkZCBidXR0b24vaW5wdXQgdHlwZSBwc2V1ZG9zCiAgICBmb3IgKGkgaW4gewogICAgICAgIHJhZGlvOiB0cnVlLAogICAgICAgIGNoZWNrYm94OiB0cnVlLAogICAgICAgIGZpbGU6IHRydWUsCiAgICAgICAgcGFzc3dvcmQ6IHRydWUsCiAgICAgICAgaW1hZ2U6IHRydWUKICAgICAgfSkgewogICAgICBFeHByLnBzZXVkb3NbaV0gPSBjcmVhdGVJbnB1dFBzZXVkbyhpKTsKICAgIH0KICAgIGZvciAoaSBpbiB7CiAgICAgICAgc3VibWl0OiB0cnVlLAogICAgICAgIHJlc2V0OiB0cnVlCiAgICAgIH0pIHsKICAgICAgRXhwci5wc2V1ZG9zW2ldID0gY3JlYXRlQnV0dG9uUHNldWRvKGkpOwogICAgfQogICAgLy8gRWFzeSBBUEkgZm9yIGNyZWF0aW5nIG5ldyBzZXRGaWx0ZXJzCiAgICBmdW5jdGlvbiBzZXRGaWx0ZXJzKCkgewogICAgfQogICAgc2V0RmlsdGVycy5wcm90b3R5cGUgPSBFeHByLmZpbHRlcnMgPSBFeHByLnBzZXVkb3M7CiAgICBFeHByLnNldEZpbHRlcnMgPSBuZXcgc2V0RmlsdGVycygpOwogICAgdG9rZW5pemUgPSBTaXp6bGUudG9rZW5pemUgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIHBhcnNlT25seSkgewogICAgICB2YXIgbWF0Y2hlZCwgbWF0Y2gsIHRva2VucywgdHlwZSwgc29GYXIsIGdyb3VwcywgcHJlRmlsdGVycywgY2FjaGVkID0gdG9rZW5DYWNoZVtzZWxlY3RvciArICcgJ107CiAgICAgIGlmIChjYWNoZWQpIHsKICAgICAgICByZXR1cm4gcGFyc2VPbmx5ID8gMCA6IGNhY2hlZC5zbGljZSgwKTsKICAgICAgfQogICAgICBzb0ZhciA9IHNlbGVjdG9yOwogICAgICBncm91cHMgPSBbXTsKICAgICAgcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyOwogICAgICB3aGlsZSAoc29GYXIpIHsKICAgICAgICAvLyBDb21tYSBhbmQgZmlyc3QgcnVuCiAgICAgICAgaWYgKCFtYXRjaGVkIHx8IChtYXRjaCA9IHJjb21tYS5leGVjKHNvRmFyKSkpIHsKICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAvLyBEb24ndCBjb25zdW1lIHRyYWlsaW5nIGNvbW1hcyBhcyB2YWxpZAogICAgICAgICAgICBzb0ZhciA9IHNvRmFyLnNsaWNlKG1hdGNoWzBdLmxlbmd0aCkgfHwgc29GYXI7CiAgICAgICAgICB9CiAgICAgICAgICBncm91cHMucHVzaCh0b2tlbnMgPSBbXSk7CiAgICAgICAgfQogICAgICAgIG1hdGNoZWQgPSBmYWxzZTsKICAgICAgICAvLyBDb21iaW5hdG9ycwogICAgICAgIGlmIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKHNvRmFyKSkgewogICAgICAgICAgbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CiAgICAgICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgICAgIHZhbHVlOiBtYXRjaGVkLAogICAgICAgICAgICAvLyBDYXN0IGRlc2NlbmRhbnQgY29tYmluYXRvcnMgdG8gc3BhY2UKICAgICAgICAgICAgdHlwZTogbWF0Y2hbMF0ucmVwbGFjZShydHJpbSwgJyAnKQogICAgICAgICAgfSk7CiAgICAgICAgICBzb0ZhciA9IHNvRmFyLnNsaWNlKG1hdGNoZWQubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgLy8gRmlsdGVycwogICAgICAgIGZvciAodHlwZSBpbiBFeHByLmZpbHRlcikgewogICAgICAgICAgaWYgKChtYXRjaCA9IG1hdGNoRXhwclt0eXBlXS5leGVjKHNvRmFyKSkgJiYgKCFwcmVGaWx0ZXJzW3R5cGVdIHx8IChtYXRjaCA9IHByZUZpbHRlcnNbdHlwZV0obWF0Y2gpKSkpIHsKICAgICAgICAgICAgbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CiAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICB2YWx1ZTogbWF0Y2hlZCwKICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgIG1hdGNoZXM6IG1hdGNoCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzb0ZhciA9IHNvRmFyLnNsaWNlKG1hdGNoZWQubGVuZ3RoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFtYXRjaGVkKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gUmV0dXJuIHRoZSBsZW5ndGggb2YgdGhlIGludmFsaWQgZXhjZXNzCiAgICAgIC8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwogICAgICAvLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yIG9yIHJldHVybiB0b2tlbnMKICAgICAgcmV0dXJuIHBhcnNlT25seSA/IHNvRmFyLmxlbmd0aCA6IHNvRmFyID8gU2l6emxlLmVycm9yKHNlbGVjdG9yKSA6IC8vIENhY2hlIHRoZSB0b2tlbnMKICAgICAgdG9rZW5DYWNoZShzZWxlY3RvciwgZ3JvdXBzKS5zbGljZSgwKTsKICAgIH07CiAgICBmdW5jdGlvbiB0b1NlbGVjdG9yKHRva2VucykgewogICAgICB2YXIgaSA9IDAsIGxlbiA9IHRva2Vucy5sZW5ndGgsIHNlbGVjdG9yID0gJyc7CiAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBzZWxlY3RvciArPSB0b2tlbnNbaV0udmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHNlbGVjdG9yOwogICAgfQogICAgZnVuY3Rpb24gYWRkQ29tYmluYXRvcihtYXRjaGVyLCBjb21iaW5hdG9yLCBiYXNlKSB7CiAgICAgIHZhciBkaXIgPSBjb21iaW5hdG9yLmRpciwgY2hlY2tOb25FbGVtZW50cyA9IGJhc2UgJiYgZGlyID09PSAncGFyZW50Tm9kZScsIGRvbmVOYW1lID0gZG9uZSsrOwogICAgICByZXR1cm4gY29tYmluYXRvci5maXJzdCA/IC8vIENoZWNrIGFnYWluc3QgY2xvc2VzdCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudAogICAgICBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgd2hpbGUgKGVsZW0gPSBlbGVtW2Rpcl0pIHsKICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMpIHsKICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXIoZWxlbSwgY29udGV4dCwgeG1sKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gOiAvLyBDaGVjayBhZ2FpbnN0IGFsbCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudHMKICAgICAgZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgIHZhciBvbGRDYWNoZSwgb3V0ZXJDYWNoZSwgbmV3Q2FjaGUgPSBbCiAgICAgICAgICAgIGRpcnJ1bnMsCiAgICAgICAgICAgIGRvbmVOYW1lCiAgICAgICAgICBdOwogICAgICAgIC8vIFdlIGNhbid0IHNldCBhcmJpdHJhcnkgZGF0YSBvbiBYTUwgbm9kZXMsIHNvIHRoZXkgZG9uJ3QgYmVuZWZpdCBmcm9tIGRpciBjYWNoaW5nCiAgICAgICAgaWYgKHhtbCkgewogICAgICAgICAgd2hpbGUgKGVsZW0gPSBlbGVtW2Rpcl0pIHsKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cykgewogICAgICAgICAgICAgIGlmIChtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1bZGlyXSkgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzKSB7CiAgICAgICAgICAgICAgb3V0ZXJDYWNoZSA9IGVsZW1bZXhwYW5kb10gfHwgKGVsZW1bZXhwYW5kb10gPSB7fSk7CiAgICAgICAgICAgICAgaWYgKChvbGRDYWNoZSA9IG91dGVyQ2FjaGVbZGlyXSkgJiYgb2xkQ2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgb2xkQ2FjaGVbMV0gPT09IGRvbmVOYW1lKSB7CiAgICAgICAgICAgICAgICAvLyBBc3NpZ24gdG8gbmV3Q2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cwogICAgICAgICAgICAgICAgcmV0dXJuIG5ld0NhY2hlWzJdID0gb2xkQ2FjaGVbMl07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJldXNlIG5ld2NhY2hlIHNvIHJlc3VsdHMgYmFjay1wcm9wYWdhdGUgdG8gcHJldmlvdXMgZWxlbWVudHMKICAgICAgICAgICAgICAgIG91dGVyQ2FjaGVbZGlyXSA9IG5ld0NhY2hlOwogICAgICAgICAgICAgICAgLy8gQSBtYXRjaCBtZWFucyB3ZSdyZSBkb25lOyBhIGZhaWwgbWVhbnMgd2UgaGF2ZSB0byBrZWVwIGNoZWNraW5nCiAgICAgICAgICAgICAgICBpZiAobmV3Q2FjaGVbMl0gPSBtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gZWxlbWVudE1hdGNoZXIobWF0Y2hlcnMpIHsKICAgICAgcmV0dXJuIG1hdGNoZXJzLmxlbmd0aCA+IDEgPyBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgdmFyIGkgPSBtYXRjaGVycy5sZW5ndGg7CiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgaWYgKCFtYXRjaGVyc1tpXShlbGVtLCBjb250ZXh0LCB4bWwpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gOiBtYXRjaGVyc1swXTsKICAgIH0KICAgIGZ1bmN0aW9uIG11bHRpcGxlQ29udGV4dHMoc2VsZWN0b3IsIGNvbnRleHRzLCByZXN1bHRzKSB7CiAgICAgIHZhciBpID0gMCwgbGVuID0gY29udGV4dHMubGVuZ3RoOwogICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgU2l6emxlKHNlbGVjdG9yLCBjb250ZXh0c1tpXSwgcmVzdWx0cyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9CiAgICBmdW5jdGlvbiBjb25kZW5zZSh1bm1hdGNoZWQsIG1hcCwgZmlsdGVyLCBjb250ZXh0LCB4bWwpIHsKICAgICAgdmFyIGVsZW0sIG5ld1VubWF0Y2hlZCA9IFtdLCBpID0gMCwgbGVuID0gdW5tYXRjaGVkLmxlbmd0aCwgbWFwcGVkID0gbWFwICE9IG51bGw7CiAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgewogICAgICAgICAgaWYgKCFmaWx0ZXIgfHwgZmlsdGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgbmV3VW5tYXRjaGVkLnB1c2goZWxlbSk7CiAgICAgICAgICAgIGlmIChtYXBwZWQpIHsKICAgICAgICAgICAgICBtYXAucHVzaChpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbmV3VW5tYXRjaGVkOwogICAgfQogICAgZnVuY3Rpb24gc2V0TWF0Y2hlcihwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IpIHsKICAgICAgaWYgKHBvc3RGaWx0ZXIgJiYgIXBvc3RGaWx0ZXJbZXhwYW5kb10pIHsKICAgICAgICBwb3N0RmlsdGVyID0gc2V0TWF0Y2hlcihwb3N0RmlsdGVyKTsKICAgICAgfQogICAgICBpZiAocG9zdEZpbmRlciAmJiAhcG9zdEZpbmRlcltleHBhbmRvXSkgewogICAgICAgIHBvc3RGaW5kZXIgPSBzZXRNYXRjaGVyKHBvc3RGaW5kZXIsIHBvc3RTZWxlY3Rvcik7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoc2VlZCwgcmVzdWx0cywgY29udGV4dCwgeG1sKSB7CiAgICAgICAgdmFyIHRlbXAsIGksIGVsZW0sIHByZU1hcCA9IFtdLCBwb3N0TWFwID0gW10sIHByZWV4aXN0aW5nID0gcmVzdWx0cy5sZW5ndGgsCiAgICAgICAgICAvLyBHZXQgaW5pdGlhbCBlbGVtZW50cyBmcm9tIHNlZWQgb3IgY29udGV4dAogICAgICAgICAgZWxlbXMgPSBzZWVkIHx8IG11bHRpcGxlQ29udGV4dHMoc2VsZWN0b3IgfHwgJyonLCBjb250ZXh0Lm5vZGVUeXBlID8gW2NvbnRleHRdIDogY29udGV4dCwgW10pLAogICAgICAgICAgLy8gUHJlZmlsdGVyIHRvIGdldCBtYXRjaGVyIGlucHV0LCBwcmVzZXJ2aW5nIGEgbWFwIGZvciBzZWVkLXJlc3VsdHMgc3luY2hyb25pemF0aW9uCiAgICAgICAgICBtYXRjaGVySW4gPSBwcmVGaWx0ZXIgJiYgKHNlZWQgfHwgIXNlbGVjdG9yKSA/IGNvbmRlbnNlKGVsZW1zLCBwcmVNYXAsIHByZUZpbHRlciwgY29udGV4dCwgeG1sKSA6IGVsZW1zLCBtYXRjaGVyT3V0ID0gbWF0Y2hlciA/IC8vIElmIHdlIGhhdmUgYSBwb3N0RmluZGVyLCBvciBmaWx0ZXJlZCBzZWVkLCBvciBub24tc2VlZCBwb3N0RmlsdGVyIG9yIHByZWV4aXN0aW5nIHJlc3VsdHMsCiAgICAgICAgICBwb3N0RmluZGVyIHx8IChzZWVkID8gcHJlRmlsdGVyIDogcHJlZXhpc3RpbmcgfHwgcG9zdEZpbHRlcikgPyAvLyAuLi5pbnRlcm1lZGlhdGUgcHJvY2Vzc2luZyBpcyBuZWNlc3NhcnkKICAgICAgICAgIFtdIDogLy8gLi4ub3RoZXJ3aXNlIHVzZSByZXN1bHRzIGRpcmVjdGx5CiAgICAgICAgICByZXN1bHRzIDogbWF0Y2hlckluOwogICAgICAgIC8vIEZpbmQgcHJpbWFyeSBtYXRjaGVzCiAgICAgICAgaWYgKG1hdGNoZXIpIHsKICAgICAgICAgIG1hdGNoZXIobWF0Y2hlckluLCBtYXRjaGVyT3V0LCBjb250ZXh0LCB4bWwpOwogICAgICAgIH0KICAgICAgICAvLyBBcHBseSBwb3N0RmlsdGVyCiAgICAgICAgaWYgKHBvc3RGaWx0ZXIpIHsKICAgICAgICAgIHRlbXAgPSBjb25kZW5zZShtYXRjaGVyT3V0LCBwb3N0TWFwKTsKICAgICAgICAgIHBvc3RGaWx0ZXIodGVtcCwgW10sIGNvbnRleHQsIHhtbCk7CiAgICAgICAgICAvLyBVbi1tYXRjaCBmYWlsaW5nIGVsZW1lbnRzIGJ5IG1vdmluZyB0aGVtIGJhY2sgdG8gbWF0Y2hlckluCiAgICAgICAgICBpID0gdGVtcC5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIGlmIChlbGVtID0gdGVtcFtpXSkgewogICAgICAgICAgICAgIG1hdGNoZXJPdXRbcG9zdE1hcFtpXV0gPSAhKG1hdGNoZXJJbltwb3N0TWFwW2ldXSA9IGVsZW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChzZWVkKSB7CiAgICAgICAgICBpZiAocG9zdEZpbmRlciB8fCBwcmVGaWx0ZXIpIHsKICAgICAgICAgICAgaWYgKHBvc3RGaW5kZXIpIHsKICAgICAgICAgICAgICAvLyBHZXQgdGhlIGZpbmFsIG1hdGNoZXJPdXQgYnkgY29uZGVuc2luZyB0aGlzIGludGVybWVkaWF0ZSBpbnRvIHBvc3RGaW5kZXIgY29udGV4dHMKICAgICAgICAgICAgICB0ZW1wID0gW107CiAgICAgICAgICAgICAgaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwogICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtID0gbWF0Y2hlck91dFtpXSkgewogICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIG1hdGNoZXJJbiBzaW5jZSBlbGVtIGlzIG5vdCB5ZXQgYSBmaW5hbCBtYXRjaAogICAgICAgICAgICAgICAgICB0ZW1wLnB1c2gobWF0Y2hlckluW2ldID0gZWxlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBvc3RGaW5kZXIobnVsbCwgbWF0Y2hlck91dCA9IFtdLCB0ZW1wLCB4bWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vdmUgbWF0Y2hlZCBlbGVtZW50cyBmcm9tIHNlZWQgdG8gcmVzdWx0cyB0byBrZWVwIHRoZW0gc3luY2hyb25pemVkCiAgICAgICAgICAgIGkgPSBtYXRjaGVyT3V0Lmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgIGlmICgoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICYmICh0ZW1wID0gcG9zdEZpbmRlciA/IGluZGV4T2YuY2FsbChzZWVkLCBlbGVtKSA6IHByZU1hcFtpXSkgPiAtMSkgewogICAgICAgICAgICAgICAgc2VlZFt0ZW1wXSA9ICEocmVzdWx0c1t0ZW1wXSA9IGVsZW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSAgLy8gQWRkIGVsZW1lbnRzIHRvIHJlc3VsdHMsIHRocm91Z2ggcG9zdEZpbmRlciBpZiBkZWZpbmVkCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1hdGNoZXJPdXQgPSBjb25kZW5zZShtYXRjaGVyT3V0ID09PSByZXN1bHRzID8gbWF0Y2hlck91dC5zcGxpY2UocHJlZXhpc3RpbmcsIG1hdGNoZXJPdXQubGVuZ3RoKSA6IG1hdGNoZXJPdXQpOwogICAgICAgICAgaWYgKHBvc3RGaW5kZXIpIHsKICAgICAgICAgICAgcG9zdEZpbmRlcihudWxsLCByZXN1bHRzLCBtYXRjaGVyT3V0LCB4bWwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBtYXRjaGVyT3V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gbWF0Y2hlckZyb21Ub2tlbnModG9rZW5zKSB7CiAgICAgIHZhciBjaGVja0NvbnRleHQsIG1hdGNoZXIsIGosIGxlbiA9IHRva2Vucy5sZW5ndGgsIGxlYWRpbmdSZWxhdGl2ZSA9IEV4cHIucmVsYXRpdmVbdG9rZW5zWzBdLnR5cGVdLCBpbXBsaWNpdFJlbGF0aXZlID0gbGVhZGluZ1JlbGF0aXZlIHx8IEV4cHIucmVsYXRpdmVbJyAnXSwgaSA9IGxlYWRpbmdSZWxhdGl2ZSA/IDEgOiAwLAogICAgICAgIC8vIFRoZSBmb3VuZGF0aW9uYWwgbWF0Y2hlciBlbnN1cmVzIHRoYXQgZWxlbWVudHMgYXJlIHJlYWNoYWJsZSBmcm9tIHRvcC1sZXZlbCBjb250ZXh0KHMpCiAgICAgICAgbWF0Y2hDb250ZXh0ID0gYWRkQ29tYmluYXRvcihmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsKICAgICAgICB9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlKSwgbWF0Y2hBbnlDb250ZXh0ID0gYWRkQ29tYmluYXRvcihmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbChjaGVja0NvbnRleHQsIGVsZW0pID4gLTE7CiAgICAgICAgfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSksIG1hdGNoZXJzID0gW2Z1bmN0aW9uIChlbGVtLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICAgICAgcmV0dXJuICFsZWFkaW5nUmVsYXRpdmUgJiYgKHhtbCB8fCBjb250ZXh0ICE9PSBvdXRlcm1vc3RDb250ZXh0KSB8fCAoKGNoZWNrQ29udGV4dCA9IGNvbnRleHQpLm5vZGVUeXBlID8gbWF0Y2hDb250ZXh0KGVsZW0sIGNvbnRleHQsIHhtbCkgOiBtYXRjaEFueUNvbnRleHQoZWxlbSwgY29udGV4dCwgeG1sKSk7CiAgICAgICAgICB9XTsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmIChtYXRjaGVyID0gRXhwci5yZWxhdGl2ZVt0b2tlbnNbaV0udHlwZV0pIHsKICAgICAgICAgIG1hdGNoZXJzID0gW2FkZENvbWJpbmF0b3IoZWxlbWVudE1hdGNoZXIobWF0Y2hlcnMpLCBtYXRjaGVyKV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1hdGNoZXIgPSBFeHByLmZpbHRlclt0b2tlbnNbaV0udHlwZV0uYXBwbHkobnVsbCwgdG9rZW5zW2ldLm1hdGNoZXMpOwogICAgICAgICAgLy8gUmV0dXJuIHNwZWNpYWwgdXBvbiBzZWVpbmcgYSBwb3NpdGlvbmFsIG1hdGNoZXIKICAgICAgICAgIGlmIChtYXRjaGVyW2V4cGFuZG9dKSB7CiAgICAgICAgICAgIC8vIEZpbmQgdGhlIG5leHQgcmVsYXRpdmUgb3BlcmF0b3IgKGlmIGFueSkgZm9yIHByb3BlciBoYW5kbGluZwogICAgICAgICAgICBqID0gKytpOwogICAgICAgICAgICBmb3IgKDsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICAgICAgaWYgKEV4cHIucmVsYXRpdmVbdG9rZW5zW2pdLnR5cGVdKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNldE1hdGNoZXIoaSA+IDEgJiYgZWxlbWVudE1hdGNoZXIobWF0Y2hlcnMpLCBpID4gMSAmJiB0b1NlbGVjdG9yKC8vIElmIHRoZSBwcmVjZWRpbmcgdG9rZW4gd2FzIGEgZGVzY2VuZGFudCBjb21iaW5hdG9yLCBpbnNlcnQgYW4gaW1wbGljaXQgYW55LWVsZW1lbnQgYCpgCiAgICAgICAgICAgIHRva2Vucy5zbGljZSgwLCBpIC0gMSkuY29uY2F0KHsgdmFsdWU6IHRva2Vuc1tpIC0gMl0udHlwZSA9PT0gJyAnID8gJyonIDogJycgfSkpLnJlcGxhY2UocnRyaW0sICckMScpLCBtYXRjaGVyLCBpIDwgaiAmJiBtYXRjaGVyRnJvbVRva2Vucyh0b2tlbnMuc2xpY2UoaSwgaikpLCBqIDwgbGVuICYmIG1hdGNoZXJGcm9tVG9rZW5zKHRva2VucyA9IHRva2Vucy5zbGljZShqKSksIGogPCBsZW4gJiYgdG9TZWxlY3Rvcih0b2tlbnMpKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hdGNoZXJzLnB1c2gobWF0Y2hlcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBlbGVtZW50TWF0Y2hlcihtYXRjaGVycyk7CiAgICB9CiAgICBmdW5jdGlvbiBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycykgewogICAgICB2YXIgYnlTZXQgPSBzZXRNYXRjaGVycy5sZW5ndGggPiAwLCBieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwgc3VwZXJNYXRjaGVyID0gZnVuY3Rpb24gKHNlZWQsIGNvbnRleHQsIHhtbCwgcmVzdWx0cywgb3V0ZXJtb3N0KSB7CiAgICAgICAgICB2YXIgZWxlbSwgaiwgbWF0Y2hlciwgbWF0Y2hlZENvdW50ID0gMCwgaSA9ICcwJywgdW5tYXRjaGVkID0gc2VlZCAmJiBbXSwgc2V0TWF0Y2hlZCA9IFtdLCBjb250ZXh0QmFja3VwID0gb3V0ZXJtb3N0Q29udGV4dCwKICAgICAgICAgICAgLy8gV2UgbXVzdCBhbHdheXMgaGF2ZSBlaXRoZXIgc2VlZCBlbGVtZW50cyBvciBvdXRlcm1vc3QgY29udGV4dAogICAgICAgICAgICBlbGVtcyA9IHNlZWQgfHwgYnlFbGVtZW50ICYmIEV4cHIuZmluZFsnVEFHJ10oJyonLCBvdXRlcm1vc3QpLAogICAgICAgICAgICAvLyBVc2UgaW50ZWdlciBkaXJydW5zIGlmZiB0aGlzIGlzIHRoZSBvdXRlcm1vc3QgbWF0Y2hlcgogICAgICAgICAgICBkaXJydW5zVW5pcXVlID0gZGlycnVucyArPSBjb250ZXh0QmFja3VwID09IG51bGwgPyAxIDogTWF0aC5yYW5kb20oKSB8fCAwLjEsIGxlbiA9IGVsZW1zLmxlbmd0aDsKICAgICAgICAgIGlmIChvdXRlcm1vc3QpIHsKICAgICAgICAgICAgb3V0ZXJtb3N0Q29udGV4dCA9IGNvbnRleHQgIT09IGRvY3VtZW50ICYmIGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBBZGQgZWxlbWVudHMgcGFzc2luZyBlbGVtZW50TWF0Y2hlcnMgZGlyZWN0bHkgdG8gcmVzdWx0cwogICAgICAgICAgLy8gS2VlcCBgaWAgYSBzdHJpbmcgaWYgdGhlcmUgYXJlIG5vIGVsZW1lbnRzIHNvIGBtYXRjaGVkQ291bnRgIHdpbGwgYmUgIjAwIiBiZWxvdwogICAgICAgICAgLy8gU3VwcG9ydDogSUU8OSwgU2FmYXJpCiAgICAgICAgICAvLyBUb2xlcmF0ZSBOb2RlTGlzdCBwcm9wZXJ0aWVzIChJRTogImxlbmd0aCI7IFNhZmFyaTogPG51bWJlcj4pIG1hdGNoaW5nIGVsZW1lbnRzIGJ5IGlkCiAgICAgICAgICBmb3IgKDsgaSAhPT0gbGVuICYmIChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgICAgICBpZiAoYnlFbGVtZW50ICYmIGVsZW0pIHsKICAgICAgICAgICAgICBqID0gMDsKICAgICAgICAgICAgICB3aGlsZSAobWF0Y2hlciA9IGVsZW1lbnRNYXRjaGVyc1tqKytdKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcihlbGVtLCBjb250ZXh0LCB4bWwpKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChlbGVtKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChvdXRlcm1vc3QpIHsKICAgICAgICAgICAgICAgIGRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBUcmFjayB1bm1hdGNoZWQgZWxlbWVudHMgZm9yIHNldCBmaWx0ZXJzCiAgICAgICAgICAgIGlmIChieVNldCkgewogICAgICAgICAgICAgIC8vIFRoZXkgd2lsbCBoYXZlIGdvbmUgdGhyb3VnaCBhbGwgcG9zc2libGUgbWF0Y2hlcnMKICAgICAgICAgICAgICBpZiAoZWxlbSA9ICFtYXRjaGVyICYmIGVsZW0pIHsKICAgICAgICAgICAgICAgIG1hdGNoZWRDb3VudC0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBMZW5ndGhlbiB0aGUgYXJyYXkgZm9yIGV2ZXJ5IGVsZW1lbnQsIG1hdGNoZWQgb3Igbm90CiAgICAgICAgICAgICAgaWYgKHNlZWQpIHsKICAgICAgICAgICAgICAgIHVubWF0Y2hlZC5wdXNoKGVsZW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gQXBwbHkgc2V0IGZpbHRlcnMgdG8gdW5tYXRjaGVkIGVsZW1lbnRzCiAgICAgICAgICBtYXRjaGVkQ291bnQgKz0gaTsKICAgICAgICAgIGlmIChieVNldCAmJiBpICE9PSBtYXRjaGVkQ291bnQpIHsKICAgICAgICAgICAgaiA9IDA7CiAgICAgICAgICAgIHdoaWxlIChtYXRjaGVyID0gc2V0TWF0Y2hlcnNbaisrXSkgewogICAgICAgICAgICAgIG1hdGNoZXIodW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzZWVkKSB7CiAgICAgICAgICAgICAgLy8gUmVpbnRlZ3JhdGUgZWxlbWVudCBtYXRjaGVzIHRvIGVsaW1pbmF0ZSB0aGUgbmVlZCBmb3Igc29ydGluZwogICAgICAgICAgICAgIGlmIChtYXRjaGVkQ291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgICAgIGlmICghKHVubWF0Y2hlZFtpXSB8fCBzZXRNYXRjaGVkW2ldKSkgewogICAgICAgICAgICAgICAgICAgIHNldE1hdGNoZWRbaV0gPSBwb3AuY2FsbChyZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBEaXNjYXJkIGluZGV4IHBsYWNlaG9sZGVyIHZhbHVlcyB0byBnZXQgb25seSBhY3R1YWwgbWF0Y2hlcwogICAgICAgICAgICAgIHNldE1hdGNoZWQgPSBjb25kZW5zZShzZXRNYXRjaGVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBBZGQgbWF0Y2hlcyB0byByZXN1bHRzCiAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgc2V0TWF0Y2hlZCk7CiAgICAgICAgICAgIC8vIFNlZWRsZXNzIHNldCBtYXRjaGVzIHN1Y2NlZWRpbmcgbXVsdGlwbGUgc3VjY2Vzc2Z1bCBtYXRjaGVycyBzdGlwdWxhdGUgc29ydGluZwogICAgICAgICAgICBpZiAob3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJiBtYXRjaGVkQ291bnQgKyBzZXRNYXRjaGVycy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgU2l6emxlLnVuaXF1ZVNvcnQocmVzdWx0cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIE92ZXJyaWRlIG1hbmlwdWxhdGlvbiBvZiBnbG9iYWxzIGJ5IG5lc3RlZCBtYXRjaGVycwogICAgICAgICAgaWYgKG91dGVybW9zdCkgewogICAgICAgICAgICBkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsKICAgICAgICAgICAgb3V0ZXJtb3N0Q29udGV4dCA9IGNvbnRleHRCYWNrdXA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdW5tYXRjaGVkOwogICAgICAgIH07CiAgICAgIHJldHVybiBieVNldCA/IG1hcmtGdW5jdGlvbihzdXBlck1hdGNoZXIpIDogc3VwZXJNYXRjaGVyOwogICAgfQogICAgY29tcGlsZSA9IFNpenpsZS5jb21waWxlID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBtYXRjaCkgewogICAgICB2YXIgaSwgc2V0TWF0Y2hlcnMgPSBbXSwgZWxlbWVudE1hdGNoZXJzID0gW10sIGNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbc2VsZWN0b3IgKyAnICddOwogICAgICBpZiAoIWNhY2hlZCkgewogICAgICAgIC8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAogICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgIG1hdGNoID0gdG9rZW5pemUoc2VsZWN0b3IpOwogICAgICAgIH0KICAgICAgICBpID0gbWF0Y2gubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGNhY2hlZCA9IG1hdGNoZXJGcm9tVG9rZW5zKG1hdGNoW2ldKTsKICAgICAgICAgIGlmIChjYWNoZWRbZXhwYW5kb10pIHsKICAgICAgICAgICAgc2V0TWF0Y2hlcnMucHVzaChjYWNoZWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbWVudE1hdGNoZXJzLnB1c2goY2FjaGVkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gQ2FjaGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uCiAgICAgICAgY2FjaGVkID0gY29tcGlsZXJDYWNoZShzZWxlY3RvciwgbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMpKTsKICAgICAgICAvLyBTYXZlIHNlbGVjdG9yIGFuZCB0b2tlbml6YXRpb24KICAgICAgICBjYWNoZWQuc2VsZWN0b3IgPSBzZWxlY3RvcjsKICAgICAgfQogICAgICByZXR1cm4gY2FjaGVkOwogICAgfTsKICAgIC8qKgogICAgICogQSBsb3ctbGV2ZWwgc2VsZWN0aW9uIGZ1bmN0aW9uIHRoYXQgd29ya3Mgd2l0aCBTaXp6bGUncyBjb21waWxlZAogICAgICogIHNlbGVjdG9yIGZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IHNlbGVjdG9yIEEgc2VsZWN0b3Igb3IgYSBwcmUtY29tcGlsZWQKICAgICAqICBzZWxlY3RvciBmdW5jdGlvbiBidWlsdCB3aXRoIFNpenpsZS5jb21waWxlCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGNvbnRleHQKICAgICAqIEBwYXJhbSB7QXJyYXl9IFtyZXN1bHRzXQogICAgICogQHBhcmFtIHtBcnJheX0gW3NlZWRdIEEgc2V0IG9mIGVsZW1lbnRzIHRvIG1hdGNoIGFnYWluc3QKICAgICAqLwogICAgc2VsZWN0ID0gU2l6emxlLnNlbGVjdCA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCkgewogICAgICB2YXIgaSwgdG9rZW5zLCB0b2tlbiwgdHlwZSwgZmluZCwgY29tcGlsZWQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICdmdW5jdGlvbicgJiYgc2VsZWN0b3IsIG1hdGNoID0gIXNlZWQgJiYgdG9rZW5pemUoc2VsZWN0b3IgPSBjb21waWxlZC5zZWxlY3RvciB8fCBzZWxlY3Rvcik7CiAgICAgIHJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwogICAgICAvLyBUcnkgdG8gbWluaW1pemUgb3BlcmF0aW9ucyBpZiB0aGVyZSBpcyBubyBzZWVkIGFuZCBvbmx5IG9uZSBncm91cAogICAgICBpZiAobWF0Y2gubGVuZ3RoID09PSAxKSB7CiAgICAgICAgLy8gVGFrZSBhIHNob3J0Y3V0IGFuZCBzZXQgdGhlIGNvbnRleHQgaWYgdGhlIHJvb3Qgc2VsZWN0b3IgaXMgYW4gSUQKICAgICAgICB0b2tlbnMgPSBtYXRjaFswXSA9IG1hdGNoWzBdLnNsaWNlKDApOwogICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID4gMiAmJiAodG9rZW4gPSB0b2tlbnNbMF0pLnR5cGUgPT09ICdJRCcgJiYgc3VwcG9ydC5nZXRCeUlkICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDkgJiYgZG9jdW1lbnRJc0hUTUwgJiYgRXhwci5yZWxhdGl2ZVt0b2tlbnNbMV0udHlwZV0pIHsKICAgICAgICAgIGNvbnRleHQgPSAoRXhwci5maW5kWydJRCddKHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSksIGNvbnRleHQpIHx8IFtdKVswXTsKICAgICAgICAgIGlmICghY29udGV4dCkgewogICAgICAgICAgICByZXR1cm4gcmVzdWx0czsgIC8vIFByZWNvbXBpbGVkIG1hdGNoZXJzIHdpbGwgc3RpbGwgdmVyaWZ5IGFuY2VzdHJ5LCBzbyBzdGVwIHVwIGEgbGV2ZWwKICAgICAgICAgIH0gZWxzZSBpZiAoY29tcGlsZWQpIHsKICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3Iuc2xpY2UodG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgLy8gRmV0Y2ggYSBzZWVkIHNldCBmb3IgcmlnaHQtdG8tbGVmdCBtYXRjaGluZwogICAgICAgIGkgPSBtYXRjaEV4cHJbJ25lZWRzQ29udGV4dCddLnRlc3Qoc2VsZWN0b3IpID8gMCA6IHRva2Vucy5sZW5ndGg7CiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgdG9rZW4gPSB0b2tlbnNbaV07CiAgICAgICAgICAvLyBBYm9ydCBpZiB3ZSBoaXQgYSBjb21iaW5hdG9yCiAgICAgICAgICBpZiAoRXhwci5yZWxhdGl2ZVt0eXBlID0gdG9rZW4udHlwZV0pIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmluZCA9IEV4cHIuZmluZFt0eXBlXSkgewogICAgICAgICAgICAvLyBTZWFyY2gsIGV4cGFuZGluZyBjb250ZXh0IGZvciBsZWFkaW5nIHNpYmxpbmcgY29tYmluYXRvcnMKICAgICAgICAgICAgaWYgKHNlZWQgPSBmaW5kKHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSksIHJzaWJsaW5nLnRlc3QodG9rZW5zWzBdLnR5cGUpICYmIHRlc3RDb250ZXh0KGNvbnRleHQucGFyZW50Tm9kZSkgfHwgY29udGV4dCkpIHsKICAgICAgICAgICAgICAvLyBJZiBzZWVkIGlzIGVtcHR5IG9yIG5vIHRva2VucyByZW1haW4sIHdlIGNhbiByZXR1cm4gZWFybHkKICAgICAgICAgICAgICB0b2tlbnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIHNlbGVjdG9yID0gc2VlZC5sZW5ndGggJiYgdG9TZWxlY3Rvcih0b2tlbnMpOwogICAgICAgICAgICAgIGlmICghc2VsZWN0b3IpIHsKICAgICAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgc2VlZCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQ29tcGlsZSBhbmQgZXhlY3V0ZSBhIGZpbHRlcmluZyBmdW5jdGlvbiBpZiBvbmUgaXMgbm90IHByb3ZpZGVkCiAgICAgIC8vIFByb3ZpZGUgYG1hdGNoYCB0byBhdm9pZCByZXRva2VuaXphdGlvbiBpZiB3ZSBtb2RpZmllZCB0aGUgc2VsZWN0b3IgYWJvdmUKICAgICAgKGNvbXBpbGVkIHx8IGNvbXBpbGUoc2VsZWN0b3IsIG1hdGNoKSkoc2VlZCwgY29udGV4dCwgIWRvY3VtZW50SXNIVE1MLCByZXN1bHRzLCByc2libGluZy50ZXN0KHNlbGVjdG9yKSAmJiB0ZXN0Q29udGV4dChjb250ZXh0LnBhcmVudE5vZGUpIHx8IGNvbnRleHQpOwogICAgICByZXR1cm4gcmVzdWx0czsKICAgIH07CiAgICAvLyBPbmUtdGltZSBhc3NpZ25tZW50cwogICAgLy8gU29ydCBzdGFiaWxpdHkKICAgIHN1cHBvcnQuc29ydFN0YWJsZSA9IGV4cGFuZG8uc3BsaXQoJycpLnNvcnQoc29ydE9yZGVyKS5qb2luKCcnKSA9PT0gZXhwYW5kbzsKICAgIC8vIFN1cHBvcnQ6IENocm9tZTwxNAogICAgLy8gQWx3YXlzIGFzc3VtZSBkdXBsaWNhdGVzIGlmIHRoZXkgYXJlbid0IHBhc3NlZCB0byB0aGUgY29tcGFyaXNvbiBmdW5jdGlvbgogICAgc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzID0gISFoYXNEdXBsaWNhdGU7CiAgICAvLyBJbml0aWFsaXplIGFnYWluc3QgdGhlIGRlZmF1bHQgZG9jdW1lbnQKICAgIHNldERvY3VtZW50KCk7CiAgICAvLyBTdXBwb3J0OiBXZWJraXQ8NTM3LjMyIC0gU2FmYXJpIDYuMC4zL0Nocm9tZSAyNSAoZml4ZWQgaW4gQ2hyb21lIDI3KQogICAgLy8gRGV0YWNoZWQgbm9kZXMgY29uZm91bmRpbmdseSBmb2xsb3cgKmVhY2ggb3RoZXIqCiAgICBzdXBwb3J0LnNvcnREZXRhY2hlZCA9IGFzc2VydChmdW5jdGlvbiAoZGl2MSkgewogICAgICAvLyBTaG91bGQgcmV0dXJuIDEsIGJ1dCByZXR1cm5zIDQgKGZvbGxvd2luZykKICAgICAgcmV0dXJuIGRpdjEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykpICYgMTsKICAgIH0pOwogICAgLy8gU3VwcG9ydDogSUU8OAogICAgLy8gUHJldmVudCBhdHRyaWJ1dGUvcHJvcGVydHkgImludGVycG9sYXRpb24iCiAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4CiAgICBpZiAoIWFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8YSBocmVmPVwnI1wnPjwvYT4nOwogICAgICAgIHJldHVybiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSA9PT0gJyMnOwogICAgICB9KSkgewogICAgICBhZGRIYW5kbGUoJ3R5cGV8aHJlZnxoZWlnaHR8d2lkdGgnLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgaXNYTUwpIHsKICAgICAgICBpZiAoIWlzWE1MKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSwgbmFtZS50b0xvd2VyQ2FzZSgpID09PSAndHlwZScgPyAxIDogMik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIC8vIFN1cHBvcnQ6IElFPDkKICAgIC8vIFVzZSBkZWZhdWx0VmFsdWUgaW4gcGxhY2Ugb2YgZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpCiAgICBpZiAoIXN1cHBvcnQuYXR0cmlidXRlcyB8fCAhYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzxpbnB1dC8+JzsKICAgICAgICBkaXYuZmlyc3RDaGlsZC5zZXRBdHRyaWJ1dGUoJ3ZhbHVlJywgJycpOwogICAgICAgIHJldHVybiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykgPT09ICcnOwogICAgICB9KSkgewogICAgICBhZGRIYW5kbGUoJ3ZhbHVlJywgZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGlzWE1MKSB7CiAgICAgICAgaWYgKCFpc1hNTCAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdpbnB1dCcpIHsKICAgICAgICAgIHJldHVybiBlbGVtLmRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgLy8gU3VwcG9ydDogSUU8OQogICAgLy8gVXNlIGdldEF0dHJpYnV0ZU5vZGUgdG8gZmV0Y2ggYm9vbGVhbnMgd2hlbiBnZXRBdHRyaWJ1dGUgbGllcwogICAgaWYgKCFhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgIHJldHVybiBkaXYuZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpID09IG51bGw7CiAgICAgIH0pKSB7CiAgICAgIGFkZEhhbmRsZShib29sZWFucywgZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGlzWE1MKSB7CiAgICAgICAgdmFyIHZhbDsKICAgICAgICBpZiAoIWlzWE1MKSB7CiAgICAgICAgICByZXR1cm4gZWxlbVtuYW1lXSA9PT0gdHJ1ZSA/IG5hbWUudG9Mb3dlckNhc2UoKSA6ICh2YWwgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUobmFtZSkpICYmIHZhbC5zcGVjaWZpZWQgPyB2YWwudmFsdWUgOiBudWxsOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gU2l6emxlOwogIH0od2luZG93KTsKICBqUXVlcnkuZmluZCA9IFNpenpsZTsKICBqUXVlcnkuZXhwciA9IFNpenpsZS5zZWxlY3RvcnM7CiAgalF1ZXJ5LmV4cHJbJzonXSA9IGpRdWVyeS5leHByLnBzZXVkb3M7CiAgalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwogIGpRdWVyeS50ZXh0ID0gU2l6emxlLmdldFRleHQ7CiAgalF1ZXJ5LmlzWE1MRG9jID0gU2l6emxlLmlzWE1MOwogIGpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKICB2YXIgcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dDsKICB2YXIgcnNpbmdsZVRhZyA9IC9ePChcdyspXHMqXC8/Pig/OjxcL1wxPnwpJC87CiAgdmFyIHJpc1NpbXBsZSA9IC9eLlteOiNcW1wuLF0qJC87CiAgLy8gSW1wbGVtZW50IHRoZSBpZGVudGljYWwgZnVuY3Rpb25hbGl0eSBmb3IgZmlsdGVyIGFuZCBub3QKICBmdW5jdGlvbiB3aW5ub3coZWxlbWVudHMsIHF1YWxpZmllciwgbm90KSB7CiAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24ocXVhbGlmaWVyKSkgewogICAgICByZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uIChlbGVtLCBpKSB7CiAgICAgICAgLyoganNoaW50IC1XMDE4ICovCiAgICAgICAgcmV0dXJuICEhcXVhbGlmaWVyLmNhbGwoZWxlbSwgaSwgZWxlbSkgIT09IG5vdDsKICAgICAgfSk7CiAgICB9CiAgICBpZiAocXVhbGlmaWVyLm5vZGVUeXBlKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICByZXR1cm4gZWxlbSA9PT0gcXVhbGlmaWVyICE9PSBub3Q7CiAgICAgIH0pOwogICAgfQogICAgaWYgKHR5cGVvZiBxdWFsaWZpZXIgPT09ICdzdHJpbmcnKSB7CiAgICAgIGlmIChyaXNTaW1wbGUudGVzdChxdWFsaWZpZXIpKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5maWx0ZXIocXVhbGlmaWVyLCBlbGVtZW50cywgbm90KTsKICAgICAgfQogICAgICBxdWFsaWZpZXIgPSBqUXVlcnkuZmlsdGVyKHF1YWxpZmllciwgZWxlbWVudHMpOwogICAgfQogICAgcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKHF1YWxpZmllciwgZWxlbSkgPj0gMCAhPT0gbm90OwogICAgfSk7CiAgfQogIGpRdWVyeS5maWx0ZXIgPSBmdW5jdGlvbiAoZXhwciwgZWxlbXMsIG5vdCkgewogICAgdmFyIGVsZW0gPSBlbGVtc1swXTsKICAgIGlmIChub3QpIHsKICAgICAgZXhwciA9ICc6bm90KCcgKyBleHByICsgJyknOwogICAgfQogICAgcmV0dXJuIGVsZW1zLmxlbmd0aCA9PT0gMSAmJiBlbGVtLm5vZGVUeXBlID09PSAxID8galF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGVsZW0sIGV4cHIpID8gW2VsZW1dIDogW10gOiBqUXVlcnkuZmluZC5tYXRjaGVzKGV4cHIsIGpRdWVyeS5ncmVwKGVsZW1zLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMTsKICAgIH0pKTsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgZmluZDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHZhciBpLCBsZW4gPSB0aGlzLmxlbmd0aCwgcmV0ID0gW10sIHNlbGYgPSB0aGlzOwogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkoc2VsZWN0b3IpLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKGpRdWVyeS5jb250YWlucyhzZWxmW2ldLCB0aGlzKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIGpRdWVyeS5maW5kKHNlbGVjdG9yLCBzZWxmW2ldLCByZXQpOwogICAgICB9CiAgICAgIC8vIE5lZWRlZCBiZWNhdXNlICQoIHNlbGVjdG9yLCBjb250ZXh0ICkgYmVjb21lcyAkKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKQogICAgICByZXQgPSB0aGlzLnB1c2hTdGFjayhsZW4gPiAxID8galF1ZXJ5LnVuaXF1ZShyZXQpIDogcmV0KTsKICAgICAgcmV0LnNlbGVjdG9yID0gdGhpcy5zZWxlY3RvciA/IHRoaXMuc2VsZWN0b3IgKyAnICcgKyBzZWxlY3RvciA6IHNlbGVjdG9yOwogICAgICByZXR1cm4gcmV0OwogICAgfSwKICAgIGZpbHRlcjogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayh3aW5ub3codGhpcywgc2VsZWN0b3IgfHwgW10sIGZhbHNlKSk7CiAgICB9LAogICAgbm90OiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHdpbm5vdyh0aGlzLCBzZWxlY3RvciB8fCBbXSwgdHJ1ZSkpOwogICAgfSwKICAgIGlzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuICEhd2lubm93KHRoaXMsIC8vIElmIHRoaXMgaXMgYSBwb3NpdGlvbmFsL3JlbGF0aXZlIHNlbGVjdG9yLCBjaGVjayBtZW1iZXJzaGlwIGluIHRoZSByZXR1cm5lZCBzZXQKICAgICAgLy8gc28gJCgicDpmaXJzdCIpLmlzKCJwOmxhc3QiKSB3b24ndCByZXR1cm4gdHJ1ZSBmb3IgYSBkb2Mgd2l0aCB0d28gInAiLgogICAgICB0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnICYmIHJuZWVkc0NvbnRleHQudGVzdChzZWxlY3RvcikgPyBqUXVlcnkoc2VsZWN0b3IpIDogc2VsZWN0b3IgfHwgW10sIGZhbHNlKS5sZW5ndGg7CiAgICB9CiAgfSk7CiAgLy8gSW5pdGlhbGl6ZSBhIGpRdWVyeSBvYmplY3QKICAvLyBBIGNlbnRyYWwgcmVmZXJlbmNlIHRvIHRoZSByb290IGpRdWVyeShkb2N1bWVudCkKICB2YXIgcm9vdGpRdWVyeSwKICAgIC8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzCiAgICAvLyBQcmlvcml0aXplICNpZCBvdmVyIDx0YWc+IHRvIGF2b2lkIFhTUyB2aWEgbG9jYXRpb24uaGFzaCAoIzk1MjEpCiAgICAvLyBTdHJpY3QgSFRNTCByZWNvZ25pdGlvbiAoIzExMjkwOiBtdXN0IHN0YXJ0IHdpdGggPCkKICAgIHJxdWlja0V4cHIgPSAvXig/OlxzKig8W1x3XFddKz4pW14+XSp8IyhbXHctXSopKSQvLCBpbml0ID0galF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgdmFyIG1hdGNoLCBlbGVtOwogICAgICAvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCiAgICAgIGlmICghc2VsZWN0b3IpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICAvLyBIYW5kbGUgSFRNTCBzdHJpbmdzCiAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgaWYgKHNlbGVjdG9yWzBdID09PSAnPCcgJiYgc2VsZWN0b3Jbc2VsZWN0b3IubGVuZ3RoIC0gMV0gPT09ICc+JyAmJiBzZWxlY3Rvci5sZW5ndGggPj0gMykgewogICAgICAgICAgLy8gQXNzdW1lIHRoYXQgc3RyaW5ncyB0aGF0IHN0YXJ0IGFuZCBlbmQgd2l0aCA8PiBhcmUgSFRNTCBhbmQgc2tpcCB0aGUgcmVnZXggY2hlY2sKICAgICAgICAgIG1hdGNoID0gWwogICAgICAgICAgICBudWxsLAogICAgICAgICAgICBzZWxlY3RvciwKICAgICAgICAgICAgbnVsbAogICAgICAgICAgXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoc2VsZWN0b3IpOwogICAgICAgIH0KICAgICAgICAvLyBNYXRjaCBodG1sIG9yIG1ha2Ugc3VyZSBubyBjb250ZXh0IGlzIHNwZWNpZmllZCBmb3IgI2lkCiAgICAgICAgaWYgKG1hdGNoICYmIChtYXRjaFsxXSB8fCAhY29udGV4dCkpIHsKICAgICAgICAgIC8vIEhBTkRMRTogJChodG1sKSAtPiAkKGFycmF5KQogICAgICAgICAgaWYgKG1hdGNoWzFdKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFswXSA6IGNvbnRleHQ7CiAgICAgICAgICAgIC8vIHNjcmlwdHMgaXMgdHJ1ZSBmb3IgYmFjay1jb21wYXQKICAgICAgICAgICAgLy8gSW50ZW50aW9uYWxseSBsZXQgdGhlIGVycm9yIGJlIHRocm93biBpZiBwYXJzZUhUTUwgaXMgbm90IHByZXNlbnQKICAgICAgICAgICAgalF1ZXJ5Lm1lcmdlKHRoaXMsIGpRdWVyeS5wYXJzZUhUTUwobWF0Y2hbMV0sIGNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsIHRydWUpKTsKICAgICAgICAgICAgLy8gSEFORExFOiAkKGh0bWwsIHByb3BzKQogICAgICAgICAgICBpZiAocnNpbmdsZVRhZy50ZXN0KG1hdGNoWzFdKSAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdChjb250ZXh0KSkgewogICAgICAgICAgICAgIGZvciAobWF0Y2ggaW4gY29udGV4dCkgewogICAgICAgICAgICAgICAgLy8gUHJvcGVydGllcyBvZiBjb250ZXh0IGFyZSBjYWxsZWQgYXMgbWV0aG9kcyBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKHRoaXNbbWF0Y2hdKSkgewogICAgICAgICAgICAgICAgICB0aGlzW21hdGNoXShjb250ZXh0W21hdGNoXSk7ICAvLyAuLi5hbmQgb3RoZXJ3aXNlIHNldCBhcyBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLmF0dHIobWF0Y2gsIGNvbnRleHRbbWF0Y2hdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7ICAvLyBIQU5ETEU6ICQoI2lkKQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG1hdGNoWzJdKTsKICAgICAgICAgICAgLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKICAgICAgICAgICAgLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwogICAgICAgICAgICBpZiAoZWxlbSAmJiBlbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAvLyBJbmplY3QgdGhlIGVsZW1lbnQgZGlyZWN0bHkgaW50byB0aGUgalF1ZXJ5IG9iamVjdAogICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMTsKICAgICAgICAgICAgICB0aGlzWzBdID0gZWxlbTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBkb2N1bWVudDsKICAgICAgICAgICAgdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0gIC8vIEhBTkRMRTogJChleHByLCAkKC4uLikpCiAgICAgICAgfSBlbHNlIGlmICghY29udGV4dCB8fCBjb250ZXh0LmpxdWVyeSkgewogICAgICAgICAgcmV0dXJuIChjb250ZXh0IHx8IHJvb3RqUXVlcnkpLmZpbmQoc2VsZWN0b3IpOyAgLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IoY29udGV4dCkuZmluZChzZWxlY3Rvcik7CiAgICAgICAgfSAgLy8gSEFORExFOiAkKERPTUVsZW1lbnQpCiAgICAgIH0gZWxzZSBpZiAoc2VsZWN0b3Iubm9kZVR5cGUpIHsKICAgICAgICB0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gc2VsZWN0b3I7CiAgICAgICAgdGhpcy5sZW5ndGggPSAxOwogICAgICAgIHJldHVybiB0aGlzOyAgLy8gSEFORExFOiAkKGZ1bmN0aW9uKQogICAgICAgICAgICAgICAgICAgICAgLy8gU2hvcnRjdXQgZm9yIGRvY3VtZW50IHJlYWR5CiAgICAgIH0gZWxzZSBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oc2VsZWN0b3IpKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiByb290alF1ZXJ5LnJlYWR5ICE9PSAndW5kZWZpbmVkJyA/IHJvb3RqUXVlcnkucmVhZHkoc2VsZWN0b3IpIDogLy8gRXhlY3V0ZSBpbW1lZGlhdGVseSBpZiByZWFkeSBpcyBub3QgcHJlc2VudAogICAgICAgIHNlbGVjdG9yKGpRdWVyeSk7CiAgICAgIH0KICAgICAgaWYgKHNlbGVjdG9yLnNlbGVjdG9yICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3Iuc2VsZWN0b3I7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gc2VsZWN0b3IuY29udGV4dDsKICAgICAgfQogICAgICByZXR1cm4galF1ZXJ5Lm1ha2VBcnJheShzZWxlY3RvciwgdGhpcyk7CiAgICB9OwogIC8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KICBpbml0LnByb3RvdHlwZSA9IGpRdWVyeS5mbjsKICAvLyBJbml0aWFsaXplIGNlbnRyYWwgcmVmZXJlbmNlCiAgcm9vdGpRdWVyeSA9IGpRdWVyeShkb2N1bWVudCk7CiAgdmFyIHJwYXJlbnRzcHJldiA9IC9eKD86cGFyZW50c3xwcmV2KD86VW50aWx8QWxsKSkvLAogICAgLy8gbWV0aG9kcyBndWFyYW50ZWVkIHRvIHByb2R1Y2UgYSB1bmlxdWUgc2V0IHdoZW4gc3RhcnRpbmcgZnJvbSBhIHVuaXF1ZSBzZXQKICAgIGd1YXJhbnRlZWRVbmlxdWUgPSB7CiAgICAgIGNoaWxkcmVuOiB0cnVlLAogICAgICBjb250ZW50czogdHJ1ZSwKICAgICAgbmV4dDogdHJ1ZSwKICAgICAgcHJldjogdHJ1ZQogICAgfTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIGRpcjogZnVuY3Rpb24gKGVsZW0sIGRpciwgdW50aWwpIHsKICAgICAgdmFyIG1hdGNoZWQgPSBbXSwgdHJ1bmNhdGUgPSB1bnRpbCAhPT0gdW5kZWZpbmVkOwogICAgICB3aGlsZSAoKGVsZW0gPSBlbGVtW2Rpcl0pICYmIGVsZW0ubm9kZVR5cGUgIT09IDkpIHsKICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgaWYgKHRydW5jYXRlICYmIGpRdWVyeShlbGVtKS5pcyh1bnRpbCkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBtYXRjaGVkLnB1c2goZWxlbSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtYXRjaGVkOwogICAgfSwKICAgIHNpYmxpbmc6IGZ1bmN0aW9uIChuLCBlbGVtKSB7CiAgICAgIHZhciBtYXRjaGVkID0gW107CiAgICAgIGZvciAoOyBuOyBuID0gbi5uZXh0U2libGluZykgewogICAgICAgIGlmIChuLm5vZGVUeXBlID09PSAxICYmIG4gIT09IGVsZW0pIHsKICAgICAgICAgIG1hdGNoZWQucHVzaChuKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBoYXM6IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgICAgdmFyIHRhcmdldHMgPSBqUXVlcnkodGFyZ2V0LCB0aGlzKSwgbCA9IHRhcmdldHMubGVuZ3RoOwogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBpID0gMDsKICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgaWYgKGpRdWVyeS5jb250YWlucyh0aGlzLCB0YXJnZXRzW2ldKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGNsb3Nlc3Q6IGZ1bmN0aW9uIChzZWxlY3RvcnMsIGNvbnRleHQpIHsKICAgICAgdmFyIGN1ciwgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCwgbWF0Y2hlZCA9IFtdLCBwb3MgPSBybmVlZHNDb250ZXh0LnRlc3Qoc2VsZWN0b3JzKSB8fCB0eXBlb2Ygc2VsZWN0b3JzICE9PSAnc3RyaW5nJyA/IGpRdWVyeShzZWxlY3RvcnMsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0KSA6IDA7CiAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgZm9yIChjdXIgPSB0aGlzW2ldOyBjdXIgJiYgY3VyICE9PSBjb250ZXh0OyBjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgLy8gQWx3YXlzIHNraXAgZG9jdW1lbnQgZnJhZ21lbnRzCiAgICAgICAgICBpZiAoY3VyLm5vZGVUeXBlIDwgMTEgJiYgKHBvcyA/IHBvcy5pbmRleChjdXIpID4gLTEgOiAvLyBEb24ndCBwYXNzIG5vbi1lbGVtZW50cyB0byBTaXp6bGUKICAgICAgICAgICAgY3VyLm5vZGVUeXBlID09PSAxICYmIGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihjdXIsIHNlbGVjdG9ycykpKSB7CiAgICAgICAgICAgIG1hdGNoZWQucHVzaChjdXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKG1hdGNoZWQubGVuZ3RoID4gMSA/IGpRdWVyeS51bmlxdWUobWF0Y2hlZCkgOiBtYXRjaGVkKTsKICAgIH0sCiAgICAvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluCiAgICAvLyB0aGUgbWF0Y2hlZCBzZXQgb2YgZWxlbWVudHMKICAgIGluZGV4OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAogICAgICBpZiAoIWVsZW0pIHsKICAgICAgICByZXR1cm4gdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgPyB0aGlzLmZpcnN0KCkucHJldkFsbCgpLmxlbmd0aCA6IC0xOwogICAgICB9CiAgICAgIC8vIGluZGV4IGluIHNlbGVjdG9yCiAgICAgIGlmICh0eXBlb2YgZWxlbSA9PT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKGpRdWVyeShlbGVtKSwgdGhpc1swXSk7CiAgICAgIH0KICAgICAgLy8gTG9jYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgZGVzaXJlZCBlbGVtZW50CiAgICAgIHJldHVybiBpbmRleE9mLmNhbGwodGhpcywgLy8gSWYgaXQgcmVjZWl2ZXMgYSBqUXVlcnkgb2JqZWN0LCB0aGUgZmlyc3QgZWxlbWVudCBpcyB1c2VkCiAgICAgIGVsZW0uanF1ZXJ5ID8gZWxlbVswXSA6IGVsZW0pOwogICAgfSwKICAgIGFkZDogZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkudW5pcXVlKGpRdWVyeS5tZXJnZSh0aGlzLmdldCgpLCBqUXVlcnkoc2VsZWN0b3IsIGNvbnRleHQpKSkpOwogICAgfSwKICAgIGFkZEJhY2s6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy5hZGQoc2VsZWN0b3IgPT0gbnVsbCA/IHRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoc2VsZWN0b3IpKTsKICAgIH0KICB9KTsKICBmdW5jdGlvbiBzaWJsaW5nKGN1ciwgZGlyKSB7CiAgICB3aGlsZSAoKGN1ciA9IGN1cltkaXJdKSAmJiBjdXIubm9kZVR5cGUgIT09IDEpIHsKICAgIH0KICAgIHJldHVybiBjdXI7CiAgfQogIGpRdWVyeS5lYWNoKHsKICAgIHBhcmVudDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKICAgIH0sCiAgICBwYXJlbnRzOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LmRpcihlbGVtLCAncGFyZW50Tm9kZScpOwogICAgfSwKICAgIHBhcmVudHNVbnRpbDogZnVuY3Rpb24gKGVsZW0sIGksIHVudGlsKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICdwYXJlbnROb2RlJywgdW50aWwpOwogICAgfSwKICAgIG5leHQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5nKGVsZW0sICduZXh0U2libGluZycpOwogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5nKGVsZW0sICdwcmV2aW91c1NpYmxpbmcnKTsKICAgIH0sCiAgICBuZXh0QWxsOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LmRpcihlbGVtLCAnbmV4dFNpYmxpbmcnKTsKICAgIH0sCiAgICBwcmV2QWxsOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LmRpcihlbGVtLCAncHJldmlvdXNTaWJsaW5nJyk7CiAgICB9LAogICAgbmV4dFVudGlsOiBmdW5jdGlvbiAoZWxlbSwgaSwgdW50aWwpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgJ25leHRTaWJsaW5nJywgdW50aWwpOwogICAgfSwKICAgIHByZXZVbnRpbDogZnVuY3Rpb24gKGVsZW0sIGksIHVudGlsKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICdwcmV2aW91c1NpYmxpbmcnLCB1bnRpbCk7CiAgICB9LAogICAgc2libGluZ3M6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuc2libGluZygoZWxlbS5wYXJlbnROb2RlIHx8IHt9KS5maXJzdENoaWxkLCBlbGVtKTsKICAgIH0sCiAgICBjaGlsZHJlbjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGpRdWVyeS5zaWJsaW5nKGVsZW0uZmlyc3RDaGlsZCk7CiAgICB9LAogICAgY29udGVudHM6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBqUXVlcnkubWVyZ2UoW10sIGVsZW0uY2hpbGROb2Rlcyk7CiAgICB9CiAgfSwgZnVuY3Rpb24gKG5hbWUsIGZuKSB7CiAgICBqUXVlcnkuZm5bbmFtZV0gPSBmdW5jdGlvbiAodW50aWwsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBtYXRjaGVkID0galF1ZXJ5Lm1hcCh0aGlzLCBmbiwgdW50aWwpOwogICAgICBpZiAobmFtZS5zbGljZSgtNSkgIT09ICdVbnRpbCcpIHsKICAgICAgICBzZWxlY3RvciA9IHVudGlsOwogICAgICB9CiAgICAgIGlmIChzZWxlY3RvciAmJiB0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgbWF0Y2hlZCA9IGpRdWVyeS5maWx0ZXIoc2VsZWN0b3IsIG1hdGNoZWQpOwogICAgICB9CiAgICAgIGlmICh0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcwogICAgICAgIGlmICghZ3VhcmFudGVlZFVuaXF1ZVtuYW1lXSkgewogICAgICAgICAgalF1ZXJ5LnVuaXF1ZShtYXRjaGVkKTsKICAgICAgICB9CiAgICAgICAgLy8gUmV2ZXJzZSBvcmRlciBmb3IgcGFyZW50cyogYW5kIHByZXYtZGVyaXZhdGl2ZXMKICAgICAgICBpZiAocnBhcmVudHNwcmV2LnRlc3QobmFtZSkpIHsKICAgICAgICAgIG1hdGNoZWQucmV2ZXJzZSgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sobWF0Y2hlZCk7CiAgICB9OwogIH0pOwogIHZhciBybm90d2hpdGUgPSAvXFMrL2c7CiAgLy8gU3RyaW5nIHRvIE9iamVjdCBvcHRpb25zIGZvcm1hdCBjYWNoZQogIHZhciBvcHRpb25zQ2FjaGUgPSB7fTsKICAvLyBDb252ZXJ0IFN0cmluZy1mb3JtYXR0ZWQgb3B0aW9ucyBpbnRvIE9iamVjdC1mb3JtYXR0ZWQgb25lcyBhbmQgc3RvcmUgaW4gY2FjaGUKICBmdW5jdGlvbiBjcmVhdGVPcHRpb25zKG9wdGlvbnMpIHsKICAgIHZhciBvYmplY3QgPSBvcHRpb25zQ2FjaGVbb3B0aW9uc10gPSB7fTsKICAgIGpRdWVyeS5lYWNoKG9wdGlvbnMubWF0Y2gocm5vdHdoaXRlKSB8fCBbXSwgZnVuY3Rpb24gKF8sIGZsYWcpIHsKICAgICAgb2JqZWN0W2ZsYWddID0gdHJ1ZTsKICAgIH0pOwogICAgcmV0dXJuIG9iamVjdDsKICB9CiAgLyoKICAgKiBDcmVhdGUgYSBjYWxsYmFjayBsaXN0IHVzaW5nIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICAgKgogICAqCW9wdGlvbnM6IGFuIG9wdGlvbmFsIGxpc3Qgb2Ygc3BhY2Utc2VwYXJhdGVkIG9wdGlvbnMgdGhhdCB3aWxsIGNoYW5nZSBob3cKICAgKgkJCXRoZSBjYWxsYmFjayBsaXN0IGJlaGF2ZXMgb3IgYSBtb3JlIHRyYWRpdGlvbmFsIG9wdGlvbiBvYmplY3QKICAgKgogICAqIEJ5IGRlZmF1bHQgYSBjYWxsYmFjayBsaXN0IHdpbGwgYWN0IGxpa2UgYW4gZXZlbnQgY2FsbGJhY2sgbGlzdCBhbmQgY2FuIGJlCiAgICogImZpcmVkIiBtdWx0aXBsZSB0aW1lcy4KICAgKgogICAqIFBvc3NpYmxlIG9wdGlvbnM6CiAgICoKICAgKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkKICAgKgogICAqCW1lbW9yeToJCQl3aWxsIGtlZXAgdHJhY2sgb2YgcHJldmlvdXMgdmFsdWVzIGFuZCB3aWxsIGNhbGwgYW55IGNhbGxiYWNrIGFkZGVkCiAgICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAgICoJCQkJCXZhbHVlcyAobGlrZSBhIERlZmVycmVkKQogICAqCiAgICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQogICAqCiAgICoJc3RvcE9uRmFsc2U6CWludGVycnVwdCBjYWxsaW5ncyB3aGVuIGEgY2FsbGJhY2sgcmV0dXJucyBmYWxzZQogICAqCiAgICovCiAgalF1ZXJ5LkNhbGxiYWNrcyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAvLyBDb252ZXJ0IG9wdGlvbnMgZnJvbSBTdHJpbmctZm9ybWF0dGVkIHRvIE9iamVjdC1mb3JtYXR0ZWQgaWYgbmVlZGVkCiAgICAvLyAod2UgY2hlY2sgaW4gY2FjaGUgZmlyc3QpCiAgICBvcHRpb25zID0gdHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnID8gb3B0aW9uc0NhY2hlW29wdGlvbnNdIHx8IGNyZWF0ZU9wdGlvbnMob3B0aW9ucykgOiBqUXVlcnkuZXh0ZW5kKHt9LCBvcHRpb25zKTsKICAgIHZhcgogICAgICAvLyBMYXN0IGZpcmUgdmFsdWUgKGZvciBub24tZm9yZ2V0dGFibGUgbGlzdHMpCiAgICAgIG1lbW9yeSwKICAgICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3Qgd2FzIGFscmVhZHkgZmlyZWQKICAgICAgZmlyZWQsCiAgICAgIC8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcKICAgICAgZmlyaW5nLAogICAgICAvLyBGaXJzdCBjYWxsYmFjayB0byBmaXJlICh1c2VkIGludGVybmFsbHkgYnkgYWRkIGFuZCBmaXJlV2l0aCkKICAgICAgZmlyaW5nU3RhcnQsCiAgICAgIC8vIEVuZCBvZiB0aGUgbG9vcCB3aGVuIGZpcmluZwogICAgICBmaXJpbmdMZW5ndGgsCiAgICAgIC8vIEluZGV4IG9mIGN1cnJlbnRseSBmaXJpbmcgY2FsbGJhY2sgKG1vZGlmaWVkIGJ5IHJlbW92ZSBpZiBuZWVkZWQpCiAgICAgIGZpcmluZ0luZGV4LAogICAgICAvLyBBY3R1YWwgY2FsbGJhY2sgbGlzdAogICAgICBsaXN0ID0gW10sCiAgICAgIC8vIFN0YWNrIG9mIGZpcmUgY2FsbHMgZm9yIHJlcGVhdGFibGUgbGlzdHMKICAgICAgc3RhY2sgPSAhb3B0aW9ucy5vbmNlICYmIFtdLAogICAgICAvLyBGaXJlIGNhbGxiYWNrcwogICAgICBmaXJlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBtZW1vcnkgPSBvcHRpb25zLm1lbW9yeSAmJiBkYXRhOwogICAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgICBmaXJpbmdJbmRleCA9IGZpcmluZ1N0YXJ0IHx8IDA7CiAgICAgICAgZmlyaW5nU3RhcnQgPSAwOwogICAgICAgIGZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwogICAgICAgIGZpcmluZyA9IHRydWU7CiAgICAgICAgZm9yICg7IGxpc3QgJiYgZmlyaW5nSW5kZXggPCBmaXJpbmdMZW5ndGg7IGZpcmluZ0luZGV4KyspIHsKICAgICAgICAgIGlmIChsaXN0W2ZpcmluZ0luZGV4XS5hcHBseShkYXRhWzBdLCBkYXRhWzFdKSA9PT0gZmFsc2UgJiYgb3B0aW9ucy5zdG9wT25GYWxzZSkgewogICAgICAgICAgICBtZW1vcnkgPSBmYWxzZTsKICAgICAgICAgICAgLy8gVG8gcHJldmVudCBmdXJ0aGVyIGNhbGxzIHVzaW5nIGFkZAogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZmlyaW5nID0gZmFsc2U7CiAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgIGlmIChzdGFjaykgewogICAgICAgICAgICBpZiAoc3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgICAgZmlyZShzdGFjay5zaGlmdCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChtZW1vcnkpIHsKICAgICAgICAgICAgbGlzdCA9IFtdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5kaXNhYmxlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAvLyBBY3R1YWwgQ2FsbGJhY2tzIG9iamVjdAogICAgICBzZWxmID0gewogICAgICAgIC8vIEFkZCBhIGNhbGxiYWNrIG9yIGEgY29sbGVjdGlvbiBvZiBjYWxsYmFja3MgdG8gdGhlIGxpc3QKICAgICAgICBhZGQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICAgIC8vIEZpcnN0LCB3ZSBzYXZlIHRoZSBjdXJyZW50IGxlbmd0aAogICAgICAgICAgICB2YXIgc3RhcnQgPSBsaXN0Lmxlbmd0aDsKICAgICAgICAgICAgKGZ1bmN0aW9uIGFkZChhcmdzKSB7CiAgICAgICAgICAgICAgalF1ZXJ5LmVhY2goYXJncywgZnVuY3Rpb24gKF8sIGFyZykgewogICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBqUXVlcnkudHlwZShhcmcpOwogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLnVuaXF1ZSB8fCAhc2VsZi5oYXMoYXJnKSkgewogICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChhcmcpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFyZyAmJiBhcmcubGVuZ3RoICYmIHR5cGUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgIC8vIEluc3BlY3QgcmVjdXJzaXZlbHkKICAgICAgICAgICAgICAgICAgYWRkKGFyZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0oYXJndW1lbnRzKSk7CiAgICAgICAgICAgIC8vIERvIHdlIG5lZWQgdG8gYWRkIHRoZSBjYWxsYmFja3MgdG8gdGhlCiAgICAgICAgICAgIC8vIGN1cnJlbnQgZmlyaW5nIGJhdGNoPwogICAgICAgICAgICBpZiAoZmlyaW5nKSB7CiAgICAgICAgICAgICAgZmlyaW5nTGVuZ3RoID0gbGlzdC5sZW5ndGg7ICAvLyBXaXRoIG1lbW9yeSwgaWYgd2UncmUgbm90IGZpcmluZyB0aGVuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBzaG91bGQgY2FsbCByaWdodCBhd2F5CiAgICAgICAgICAgIH0gZWxzZSBpZiAobWVtb3J5KSB7CiAgICAgICAgICAgICAgZmlyaW5nU3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgICBmaXJlKG1lbW9yeSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgalF1ZXJ5LmVhY2goYXJndW1lbnRzLCBmdW5jdGlvbiAoXywgYXJnKSB7CiAgICAgICAgICAgICAgdmFyIGluZGV4OwogICAgICAgICAgICAgIHdoaWxlICgoaW5kZXggPSBqUXVlcnkuaW5BcnJheShhcmcsIGxpc3QsIGluZGV4KSkgPiAtMSkgewogICAgICAgICAgICAgICAgbGlzdC5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICAgICAgLy8gSGFuZGxlIGZpcmluZyBpbmRleGVzCiAgICAgICAgICAgICAgICBpZiAoZmlyaW5nKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA8PSBmaXJpbmdMZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBmaXJpbmdMZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPD0gZmlyaW5nSW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICBmaXJpbmdJbmRleC0tOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gQ2hlY2sgaWYgYSBnaXZlbiBjYWxsYmFjayBpcyBpbiB0aGUgbGlzdC4KICAgICAgICAvLyBJZiBubyBhcmd1bWVudCBpcyBnaXZlbiwgcmV0dXJuIHdoZXRoZXIgb3Igbm90IGxpc3QgaGFzIGNhbGxiYWNrcyBhdHRhY2hlZC4KICAgICAgICBoYXM6IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgcmV0dXJuIGZuID8galF1ZXJ5LmluQXJyYXkoZm4sIGxpc3QpID4gLTEgOiAhIShsaXN0ICYmIGxpc3QubGVuZ3RoKTsKICAgICAgICB9LAogICAgICAgIC8vIFJlbW92ZSBhbGwgY2FsbGJhY2tzIGZyb20gdGhlIGxpc3QKICAgICAgICBlbXB0eTogZnVuY3Rpb24gKCkgewogICAgICAgICAgbGlzdCA9IFtdOwogICAgICAgICAgZmlyaW5nTGVuZ3RoID0gMDsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gSGF2ZSB0aGUgbGlzdCBkbyBub3RoaW5nIGFueW1vcmUKICAgICAgICBkaXNhYmxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBsaXN0ID0gc3RhY2sgPSBtZW1vcnkgPSB1bmRlZmluZWQ7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIElzIGl0IGRpc2FibGVkPwogICAgICAgIGRpc2FibGVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gIWxpc3Q7CiAgICAgICAgfSwKICAgICAgICAvLyBMb2NrIHRoZSBsaXN0IGluIGl0cyBjdXJyZW50IHN0YXRlCiAgICAgICAgbG9jazogZnVuY3Rpb24gKCkgewogICAgICAgICAgc3RhY2sgPSB1bmRlZmluZWQ7CiAgICAgICAgICBpZiAoIW1lbW9yeSkgewogICAgICAgICAgICBzZWxmLmRpc2FibGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gSXMgaXQgbG9ja2VkPwogICAgICAgIGxvY2tlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuICFzdGFjazsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgYWxsIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBjb250ZXh0IGFuZCBhcmd1bWVudHMKICAgICAgICBmaXJlV2l0aDogZnVuY3Rpb24gKGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICAgIGlmIChsaXN0ICYmICghZmlyZWQgfHwgc3RhY2spKSB7CiAgICAgICAgICAgIGFyZ3MgPSBhcmdzIHx8IFtdOwogICAgICAgICAgICBhcmdzID0gWwogICAgICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICAgICAgYXJncy5zbGljZSA/IGFyZ3Muc2xpY2UoKSA6IGFyZ3MKICAgICAgICAgICAgXTsKICAgICAgICAgICAgaWYgKGZpcmluZykgewogICAgICAgICAgICAgIHN0YWNrLnB1c2goYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZmlyZShhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBDYWxsIGFsbCB0aGUgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cwogICAgICAgIGZpcmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHNlbGYuZmlyZVdpdGgodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gVG8ga25vdyBpZiB0aGUgY2FsbGJhY2tzIGhhdmUgYWxyZWFkeSBiZWVuIGNhbGxlZCBhdCBsZWFzdCBvbmNlCiAgICAgICAgZmlyZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiAhIWZpcmVkOwogICAgICAgIH0KICAgICAgfTsKICAgIHJldHVybiBzZWxmOwogIH07CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBEZWZlcnJlZDogZnVuY3Rpb24gKGZ1bmMpIHsKICAgICAgdmFyIHR1cGxlcyA9IFsKICAgICAgICAgIC8vIGFjdGlvbiwgYWRkIGxpc3RlbmVyLCBsaXN0ZW5lciBsaXN0LCBmaW5hbCBzdGF0ZQogICAgICAgICAgWwogICAgICAgICAgICAncmVzb2x2ZScsCiAgICAgICAgICAgICdkb25lJywKICAgICAgICAgICAgalF1ZXJ5LkNhbGxiYWNrcygnb25jZSBtZW1vcnknKSwKICAgICAgICAgICAgJ3Jlc29sdmVkJwogICAgICAgICAgXSwKICAgICAgICAgIFsKICAgICAgICAgICAgJ3JlamVjdCcsCiAgICAgICAgICAgICdmYWlsJywKICAgICAgICAgICAgalF1ZXJ5LkNhbGxiYWNrcygnb25jZSBtZW1vcnknKSwKICAgICAgICAgICAgJ3JlamVjdGVkJwogICAgICAgICAgXSwKICAgICAgICAgIFsKICAgICAgICAgICAgJ25vdGlmeScsCiAgICAgICAgICAgICdwcm9ncmVzcycsCiAgICAgICAgICAgIGpRdWVyeS5DYWxsYmFja3MoJ21lbW9yeScpCiAgICAgICAgICBdCiAgICAgICAgXSwgc3RhdGUgPSAncGVuZGluZycsIHByb21pc2UgPSB7CiAgICAgICAgICBzdGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICB9LAogICAgICAgICAgYWx3YXlzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGRlZmVycmVkLmRvbmUoYXJndW1lbnRzKS5mYWlsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIHRoZW46IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGZucyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5EZWZlcnJlZChmdW5jdGlvbiAobmV3RGVmZXIpIHsKICAgICAgICAgICAgICBqUXVlcnkuZWFjaCh0dXBsZXMsIGZ1bmN0aW9uIChpLCB0dXBsZSkgewogICAgICAgICAgICAgICAgdmFyIGZuID0galF1ZXJ5LmlzRnVuY3Rpb24oZm5zW2ldKSAmJiBmbnNbaV07CiAgICAgICAgICAgICAgICAvLyBkZWZlcnJlZFsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdIGZvciBmb3J3YXJkaW5nIGFjdGlvbnMgdG8gbmV3RGVmZXIKICAgICAgICAgICAgICAgIGRlZmVycmVkW3R1cGxlWzFdXShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXR1cm5lZCA9IGZuICYmIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5lZCAmJiBqUXVlcnkuaXNGdW5jdGlvbihyZXR1cm5lZC5wcm9taXNlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybmVkLnByb21pc2UoKS5kb25lKG5ld0RlZmVyLnJlc29sdmUpLmZhaWwobmV3RGVmZXIucmVqZWN0KS5wcm9ncmVzcyhuZXdEZWZlci5ub3RpZnkpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5ld0RlZmVyW3R1cGxlWzBdICsgJ1dpdGgnXSh0aGlzID09PSBwcm9taXNlID8gbmV3RGVmZXIucHJvbWlzZSgpIDogdGhpcywgZm4gPyBbcmV0dXJuZWRdIDogYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgZm5zID0gbnVsbDsKICAgICAgICAgICAgfSkucHJvbWlzZSgpOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIEdldCBhIHByb21pc2UgZm9yIHRoaXMgZGVmZXJyZWQKICAgICAgICAgIC8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QKICAgICAgICAgIHByb21pc2U6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAhPSBudWxsID8galF1ZXJ5LmV4dGVuZChvYmosIHByb21pc2UpIDogcHJvbWlzZTsKICAgICAgICAgIH0KICAgICAgICB9LCBkZWZlcnJlZCA9IHt9OwogICAgICAvLyBLZWVwIHBpcGUgZm9yIGJhY2stY29tcGF0CiAgICAgIHByb21pc2UucGlwZSA9IHByb21pc2UudGhlbjsKICAgICAgLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcwogICAgICBqUXVlcnkuZWFjaCh0dXBsZXMsIGZ1bmN0aW9uIChpLCB0dXBsZSkgewogICAgICAgIHZhciBsaXN0ID0gdHVwbGVbMl0sIHN0YXRlU3RyaW5nID0gdHVwbGVbM107CiAgICAgICAgLy8gcHJvbWlzZVsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdID0gbGlzdC5hZGQKICAgICAgICBwcm9taXNlW3R1cGxlWzFdXSA9IGxpc3QuYWRkOwogICAgICAgIC8vIEhhbmRsZSBzdGF0ZQogICAgICAgIGlmIChzdGF0ZVN0cmluZykgewogICAgICAgICAgbGlzdC5hZGQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBzdGF0ZSA9IFsgcmVzb2x2ZWQgfCByZWplY3RlZCBdCiAgICAgICAgICAgIHN0YXRlID0gc3RhdGVTdHJpbmc7ICAvLyBbIHJlamVjdF9saXN0IHwgcmVzb2x2ZV9saXN0IF0uZGlzYWJsZTsgcHJvZ3Jlc3NfbGlzdC5sb2NrCiAgICAgICAgICB9LCB0dXBsZXNbaSBeIDFdWzJdLmRpc2FibGUsIHR1cGxlc1syXVsyXS5sb2NrKTsKICAgICAgICB9CiAgICAgICAgLy8gZGVmZXJyZWRbIHJlc29sdmUgfCByZWplY3QgfCBub3RpZnkgXQogICAgICAgIGRlZmVycmVkW3R1cGxlWzBdXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRlZmVycmVkW3R1cGxlWzBdICsgJ1dpdGgnXSh0aGlzID09PSBkZWZlcnJlZCA/IHByb21pc2UgOiB0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBkZWZlcnJlZFt0dXBsZVswXSArICdXaXRoJ10gPSBsaXN0LmZpcmVXaXRoOwogICAgICB9KTsKICAgICAgLy8gTWFrZSB0aGUgZGVmZXJyZWQgYSBwcm9taXNlCiAgICAgIHByb21pc2UucHJvbWlzZShkZWZlcnJlZCk7CiAgICAgIC8vIENhbGwgZ2l2ZW4gZnVuYyBpZiBhbnkKICAgICAgaWYgKGZ1bmMpIHsKICAgICAgICBmdW5jLmNhbGwoZGVmZXJyZWQsIGRlZmVycmVkKTsKICAgICAgfQogICAgICAvLyBBbGwgZG9uZSEKICAgICAgcmV0dXJuIGRlZmVycmVkOwogICAgfSwKICAgIC8vIERlZmVycmVkIGhlbHBlcgogICAgd2hlbjogZnVuY3Rpb24gKHN1Ym9yZGluYXRlKSB7CiAgICAgIHZhciBpID0gMCwgcmVzb2x2ZVZhbHVlcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKSwgbGVuZ3RoID0gcmVzb2x2ZVZhbHVlcy5sZW5ndGgsCiAgICAgICAgLy8gdGhlIGNvdW50IG9mIHVuY29tcGxldGVkIHN1Ym9yZGluYXRlcwogICAgICAgIHJlbWFpbmluZyA9IGxlbmd0aCAhPT0gMSB8fCBzdWJvcmRpbmF0ZSAmJiBqUXVlcnkuaXNGdW5jdGlvbihzdWJvcmRpbmF0ZS5wcm9taXNlKSA/IGxlbmd0aCA6IDAsCiAgICAgICAgLy8gdGhlIG1hc3RlciBEZWZlcnJlZC4gSWYgcmVzb2x2ZVZhbHVlcyBjb25zaXN0IG9mIG9ubHkgYSBzaW5nbGUgRGVmZXJyZWQsIGp1c3QgdXNlIHRoYXQuCiAgICAgICAgZGVmZXJyZWQgPSByZW1haW5pbmcgPT09IDEgPyBzdWJvcmRpbmF0ZSA6IGpRdWVyeS5EZWZlcnJlZCgpLAogICAgICAgIC8vIFVwZGF0ZSBmdW5jdGlvbiBmb3IgYm90aCByZXNvbHZlIGFuZCBwcm9ncmVzcyB2YWx1ZXMKICAgICAgICB1cGRhdGVGdW5jID0gZnVuY3Rpb24gKGksIGNvbnRleHRzLCB2YWx1ZXMpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgY29udGV4dHNbaV0gPSB0aGlzOwogICAgICAgICAgICB2YWx1ZXNbaV0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSA/IHNsaWNlLmNhbGwoYXJndW1lbnRzKSA6IHZhbHVlOwogICAgICAgICAgICBpZiAodmFsdWVzID09PSBwcm9ncmVzc1ZhbHVlcykgewogICAgICAgICAgICAgIGRlZmVycmVkLm5vdGlmeVdpdGgoY29udGV4dHMsIHZhbHVlcyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIS0tcmVtYWluaW5nKSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoY29udGV4dHMsIHZhbHVlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfSwgcHJvZ3Jlc3NWYWx1ZXMsIHByb2dyZXNzQ29udGV4dHMsIHJlc29sdmVDb250ZXh0czsKICAgICAgLy8gYWRkIGxpc3RlbmVycyB0byBEZWZlcnJlZCBzdWJvcmRpbmF0ZXM7IHRyZWF0IG90aGVycyBhcyByZXNvbHZlZAogICAgICBpZiAobGVuZ3RoID4gMSkgewogICAgICAgIHByb2dyZXNzVmFsdWVzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgcHJvZ3Jlc3NDb250ZXh0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIHJlc29sdmVDb250ZXh0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChyZXNvbHZlVmFsdWVzW2ldICYmIGpRdWVyeS5pc0Z1bmN0aW9uKHJlc29sdmVWYWx1ZXNbaV0ucHJvbWlzZSkpIHsKICAgICAgICAgICAgcmVzb2x2ZVZhbHVlc1tpXS5wcm9taXNlKCkuZG9uZSh1cGRhdGVGdW5jKGksIHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcykpLmZhaWwoZGVmZXJyZWQucmVqZWN0KS5wcm9ncmVzcyh1cGRhdGVGdW5jKGksIHByb2dyZXNzQ29udGV4dHMsIHByb2dyZXNzVmFsdWVzKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAtLXJlbWFpbmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gaWYgd2UncmUgbm90IHdhaXRpbmcgb24gYW55dGhpbmcsIHJlc29sdmUgdGhlIG1hc3RlcgogICAgICBpZiAoIXJlbWFpbmluZykgewogICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKICAgIH0KICB9KTsKICAvLyBUaGUgZGVmZXJyZWQgdXNlZCBvbiBET00gcmVhZHkKICB2YXIgcmVhZHlMaXN0OwogIGpRdWVyeS5mbi5yZWFkeSA9IGZ1bmN0aW9uIChmbikgewogICAgLy8gQWRkIHRoZSBjYWxsYmFjawogICAgalF1ZXJ5LnJlYWR5LnByb21pc2UoKS5kb25lKGZuKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgogICAgaXNSZWFkeTogZmFsc2UsCiAgICAvLyBBIGNvdW50ZXIgdG8gdHJhY2sgaG93IG1hbnkgaXRlbXMgdG8gd2FpdCBmb3IgYmVmb3JlCiAgICAvLyB0aGUgcmVhZHkgZXZlbnQgZmlyZXMuIFNlZSAjNjc4MQogICAgcmVhZHlXYWl0OiAxLAogICAgLy8gSG9sZCAob3IgcmVsZWFzZSkgdGhlIHJlYWR5IGV2ZW50CiAgICBob2xkUmVhZHk6IGZ1bmN0aW9uIChob2xkKSB7CiAgICAgIGlmIChob2xkKSB7CiAgICAgICAgalF1ZXJ5LnJlYWR5V2FpdCsrOwogICAgICB9IGVsc2UgewogICAgICAgIGpRdWVyeS5yZWFkeSh0cnVlKTsKICAgICAgfQogICAgfSwKICAgIC8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIHJlYWR5OiBmdW5jdGlvbiAod2FpdCkgewogICAgICAvLyBBYm9ydCBpZiB0aGVyZSBhcmUgcGVuZGluZyBob2xkcyBvciB3ZSdyZSBhbHJlYWR5IHJlYWR5CiAgICAgIGlmICh3YWl0ID09PSB0cnVlID8gLS1qUXVlcnkucmVhZHlXYWl0IDogalF1ZXJ5LmlzUmVhZHkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CiAgICAgIGpRdWVyeS5pc1JlYWR5ID0gdHJ1ZTsKICAgICAgLy8gSWYgYSBub3JtYWwgRE9NIFJlYWR5IGV2ZW50IGZpcmVkLCBkZWNyZW1lbnQsIGFuZCB3YWl0IGlmIG5lZWQgYmUKICAgICAgaWYgKHdhaXQgIT09IHRydWUgJiYgLS1qUXVlcnkucmVhZHlXYWl0ID4gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCiAgICAgIHJlYWR5TGlzdC5yZXNvbHZlV2l0aChkb2N1bWVudCwgW2pRdWVyeV0pOwogICAgICAvLyBUcmlnZ2VyIGFueSBib3VuZCByZWFkeSBldmVudHMKICAgICAgaWYgKGpRdWVyeS5mbi50cmlnZ2VySGFuZGxlcikgewogICAgICAgIGpRdWVyeShkb2N1bWVudCkudHJpZ2dlckhhbmRsZXIoJ3JlYWR5Jyk7CiAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS5vZmYoJ3JlYWR5Jyk7CiAgICAgIH0KICAgIH0KICB9KTsKICAvKioKICAgKiBUaGUgcmVhZHkgZXZlbnQgaGFuZGxlciBhbmQgc2VsZiBjbGVhbnVwIG1ldGhvZAogICAqLwogIGZ1bmN0aW9uIGNvbXBsZXRlZCgpIHsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBjb21wbGV0ZWQsIGZhbHNlKTsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdsb2FkJywgY29tcGxldGVkLCBmYWxzZSk7CiAgICBqUXVlcnkucmVhZHkoKTsKICB9CiAgalF1ZXJ5LnJlYWR5LnByb21pc2UgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBpZiAoIXJlYWR5TGlzdCkgewogICAgICByZWFkeUxpc3QgPSBqUXVlcnkuRGVmZXJyZWQoKTsKICAgICAgLy8gQ2F0Y2ggY2FzZXMgd2hlcmUgJChkb2N1bWVudCkucmVhZHkoKSBpcyBjYWxsZWQgYWZ0ZXIgdGhlIGJyb3dzZXIgZXZlbnQgaGFzIGFscmVhZHkgb2NjdXJyZWQuCiAgICAgIC8vIHdlIG9uY2UgdHJpZWQgdG8gdXNlIHJlYWR5U3RhdGUgImludGVyYWN0aXZlIiBoZXJlLCBidXQgaXQgY2F1c2VkIGlzc3VlcyBsaWtlIHRoZSBvbmUKICAgICAgLy8gZGlzY292ZXJlZCBieSBDaHJpc1MgaGVyZTogaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIyODIjY29tbWVudDoxNQogICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykgewogICAgICAgIC8vIEhhbmRsZSBpdCBhc3luY2hyb25vdXNseSB0byBhbGxvdyBzY3JpcHRzIHRoZSBvcHBvcnR1bml0eSB0byBkZWxheSByZWFkeQogICAgICAgIHNldFRpbWVvdXQoalF1ZXJ5LnJlYWR5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBVc2UgdGhlIGhhbmR5IGV2ZW50IGNhbGxiYWNrCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGNvbXBsZXRlZCwgZmFsc2UpOwogICAgICAgIC8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBjb21wbGV0ZWQsIGZhbHNlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlYWR5TGlzdC5wcm9taXNlKG9iaik7CiAgfTsKICAvLyBLaWNrIG9mZiB0aGUgRE9NIHJlYWR5IGNoZWNrIGV2ZW4gaWYgdGhlIHVzZXIgZG9lcyBub3QKICBqUXVlcnkucmVhZHkucHJvbWlzZSgpOwogIC8vIE11bHRpZnVuY3Rpb25hbCBtZXRob2QgdG8gZ2V0IGFuZCBzZXQgdmFsdWVzIG9mIGEgY29sbGVjdGlvbgogIC8vIFRoZSB2YWx1ZS9zIGNhbiBvcHRpb25hbGx5IGJlIGV4ZWN1dGVkIGlmIGl0J3MgYSBmdW5jdGlvbgogIHZhciBhY2Nlc3MgPSBqUXVlcnkuYWNjZXNzID0gZnVuY3Rpb24gKGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcmF3KSB7CiAgICB2YXIgaSA9IDAsIGxlbiA9IGVsZW1zLmxlbmd0aCwgYnVsayA9IGtleSA9PSBudWxsOwogICAgLy8gU2V0cyBtYW55IHZhbHVlcwogICAgaWYgKGpRdWVyeS50eXBlKGtleSkgPT09ICdvYmplY3QnKSB7CiAgICAgIGNoYWluYWJsZSA9IHRydWU7CiAgICAgIGZvciAoaSBpbiBrZXkpIHsKICAgICAgICBqUXVlcnkuYWNjZXNzKGVsZW1zLCBmbiwgaSwga2V5W2ldLCB0cnVlLCBlbXB0eUdldCwgcmF3KTsKICAgICAgfSAgLy8gU2V0cyBvbmUgdmFsdWUKICAgIH0gZWxzZSBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICBjaGFpbmFibGUgPSB0cnVlOwogICAgICBpZiAoIWpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJhdyA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGJ1bGspIHsKICAgICAgICAvLyBCdWxrIG9wZXJhdGlvbnMgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKICAgICAgICBpZiAocmF3KSB7CiAgICAgICAgICBmbi5jYWxsKGVsZW1zLCB2YWx1ZSk7CiAgICAgICAgICBmbiA9IG51bGw7ICAvLyAuLi5leGNlcHQgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJ1bGsgPSBmbjsKICAgICAgICAgIGZuID0gZnVuY3Rpb24gKGVsZW0sIGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGJ1bGsuY2FsbChqUXVlcnkoZWxlbSksIHZhbHVlKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmbikgewogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGZuKGVsZW1zW2ldLCBrZXksIHJhdyA/IHZhbHVlIDogdmFsdWUuY2FsbChlbGVtc1tpXSwgaSwgZm4oZWxlbXNbaV0sIGtleSkpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjaGFpbmFibGUgPyBlbGVtcyA6IC8vIEdldHMKICAgIGJ1bGsgPyBmbi5jYWxsKGVsZW1zKSA6IGxlbiA/IGZuKGVsZW1zWzBdLCBrZXkpIDogZW1wdHlHZXQ7CiAgfTsKICAvKioKICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgYW4gb2JqZWN0IGNhbiBoYXZlIGRhdGEKICAgKi8KICBqUXVlcnkuYWNjZXB0RGF0YSA9IGZ1bmN0aW9uIChvd25lcikgewogICAgLy8gQWNjZXB0cyBvbmx5OgogICAgLy8gIC0gTm9kZQogICAgLy8gICAgLSBOb2RlLkVMRU1FTlRfTk9ERQogICAgLy8gICAgLSBOb2RlLkRPQ1VNRU5UX05PREUKICAgIC8vICAtIE9iamVjdAogICAgLy8gICAgLSBBbnkKICAgIC8qIGpzaGludCAtVzAxOCAqLwogICAgcmV0dXJuIG93bmVyLm5vZGVUeXBlID09PSAxIHx8IG93bmVyLm5vZGVUeXBlID09PSA5IHx8ICErb3duZXIubm9kZVR5cGU7CiAgfTsKICBmdW5jdGlvbiBEYXRhKCkgewogICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQsCiAgICAvLyBPbGQgV2ViS2l0IGRvZXMgbm90IGhhdmUgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zL2ZyZWV6ZSBtZXRob2QsCiAgICAvLyByZXR1cm4gbmV3IGVtcHR5IG9iamVjdCBpbnN0ZWFkIHdpdGggbm8gW1tzZXRdXSBhY2Nlc3NvcgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMuY2FjaGUgPSB7fSwgMCwgewogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4ge307CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5leHBhbmRvID0galF1ZXJ5LmV4cGFuZG8gKyBNYXRoLnJhbmRvbSgpOwogIH0KICBEYXRhLnVpZCA9IDE7CiAgRGF0YS5hY2NlcHRzID0galF1ZXJ5LmFjY2VwdERhdGE7CiAgRGF0YS5wcm90b3R5cGUgPSB7CiAgICBrZXk6IGZ1bmN0aW9uIChvd25lcikgewogICAgICAvLyBXZSBjYW4gYWNjZXB0IGRhdGEgZm9yIG5vbi1lbGVtZW50IG5vZGVzIGluIG1vZGVybiBicm93c2VycywKICAgICAgLy8gYnV0IHdlIHNob3VsZCBub3QsIHNlZSAjODMzNS4KICAgICAgLy8gQWx3YXlzIHJldHVybiB0aGUga2V5IGZvciBhIGZyb3plbiBvYmplY3QuCiAgICAgIGlmICghRGF0YS5hY2NlcHRzKG93bmVyKSkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIHZhciBkZXNjcmlwdG9yID0ge30sCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIG93bmVyIG9iamVjdCBhbHJlYWR5IGhhcyBhIGNhY2hlIGtleQogICAgICAgIHVubG9jayA9IG93bmVyW3RoaXMuZXhwYW5kb107CiAgICAgIC8vIElmIG5vdCwgY3JlYXRlIG9uZQogICAgICBpZiAoIXVubG9jaykgewogICAgICAgIHVubG9jayA9IERhdGEudWlkKys7CiAgICAgICAgLy8gU2VjdXJlIGl0IGluIGEgbm9uLWVudW1lcmFibGUsIG5vbi13cml0YWJsZSBwcm9wZXJ0eQogICAgICAgIHRyeSB7CiAgICAgICAgICBkZXNjcmlwdG9yW3RoaXMuZXhwYW5kb10gPSB7IHZhbHVlOiB1bmxvY2sgfTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKG93bmVyLCBkZXNjcmlwdG9yKTsgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPCA0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBhIGxlc3Mgc2VjdXJlIGRlZmluaXRpb24KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBkZXNjcmlwdG9yW3RoaXMuZXhwYW5kb10gPSB1bmxvY2s7CiAgICAgICAgICBqUXVlcnkuZXh0ZW5kKG93bmVyLCBkZXNjcmlwdG9yKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRW5zdXJlIHRoZSBjYWNoZSBvYmplY3QKICAgICAgaWYgKCF0aGlzLmNhY2hlW3VubG9ja10pIHsKICAgICAgICB0aGlzLmNhY2hlW3VubG9ja10gPSB7fTsKICAgICAgfQogICAgICByZXR1cm4gdW5sb2NrOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gKG93bmVyLCBkYXRhLCB2YWx1ZSkgewogICAgICB2YXIgcHJvcCwKICAgICAgICAvLyBUaGVyZSBtYXkgYmUgYW4gdW5sb2NrIGFzc2lnbmVkIHRvIHRoaXMgbm9kZSwKICAgICAgICAvLyBpZiB0aGVyZSBpcyBubyBlbnRyeSBmb3IgdGhpcyAib3duZXIiLCBjcmVhdGUgb25lIGlubGluZQogICAgICAgIC8vIGFuZCBzZXQgdGhlIHVubG9jayBhcyB0aG91Z2ggYW4gb3duZXIgZW50cnkgaGFkIGFsd2F5cyBleGlzdGVkCiAgICAgICAgdW5sb2NrID0gdGhpcy5rZXkob3duZXIpLCBjYWNoZSA9IHRoaXMuY2FjaGVbdW5sb2NrXTsKICAgICAgLy8gSGFuZGxlOiBbIG93bmVyLCBrZXksIHZhbHVlIF0gYXJncwogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgY2FjaGVbZGF0YV0gPSB2YWx1ZTsgIC8vIEhhbmRsZTogWyBvd25lciwgeyBwcm9wZXJ0aWVzIH0gXSBhcmdzCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRnJlc2ggYXNzaWdubWVudHMgYnkgb2JqZWN0IGFyZSBzaGFsbG93IGNvcGllZAogICAgICAgIGlmIChqUXVlcnkuaXNFbXB0eU9iamVjdChjYWNoZSkpIHsKICAgICAgICAgIGpRdWVyeS5leHRlbmQodGhpcy5jYWNoZVt1bmxvY2tdLCBkYXRhKTsgIC8vIE90aGVyd2lzZSwgY29weSB0aGUgcHJvcGVydGllcyBvbmUtYnktb25lIHRvIHRoZSBjYWNoZSBvYmplY3QKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChwcm9wIGluIGRhdGEpIHsKICAgICAgICAgICAgY2FjaGVbcHJvcF0gPSBkYXRhW3Byb3BdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gY2FjaGU7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiAob3duZXIsIGtleSkgewogICAgICAvLyBFaXRoZXIgYSB2YWxpZCBjYWNoZSBpcyBmb3VuZCwgb3Igd2lsbCBiZSBjcmVhdGVkLgogICAgICAvLyBOZXcgY2FjaGVzIHdpbGwgYmUgY3JlYXRlZCBhbmQgdGhlIHVubG9jayByZXR1cm5lZCwKICAgICAgLy8gYWxsb3dpbmcgZGlyZWN0IGFjY2VzcyB0byB0aGUgbmV3bHkgY3JlYXRlZAogICAgICAvLyBlbXB0eSBkYXRhIG9iamVjdC4gQSB2YWxpZCBvd25lciBvYmplY3QgbXVzdCBiZSBwcm92aWRlZC4KICAgICAgdmFyIGNhY2hlID0gdGhpcy5jYWNoZVt0aGlzLmtleShvd25lcildOwogICAgICByZXR1cm4ga2V5ID09PSB1bmRlZmluZWQgPyBjYWNoZSA6IGNhY2hlW2tleV07CiAgICB9LAogICAgYWNjZXNzOiBmdW5jdGlvbiAob3duZXIsIGtleSwgdmFsdWUpIHsKICAgICAgdmFyIHN0b3JlZDsKICAgICAgLy8gSW4gY2FzZXMgd2hlcmUgZWl0aGVyOgogICAgICAvLwogICAgICAvLyAgIDEuIE5vIGtleSB3YXMgc3BlY2lmaWVkCiAgICAgIC8vICAgMi4gQSBzdHJpbmcga2V5IHdhcyBzcGVjaWZpZWQsIGJ1dCBubyB2YWx1ZSBwcm92aWRlZAogICAgICAvLwogICAgICAvLyBUYWtlIHRoZSAicmVhZCIgcGF0aCBhbmQgYWxsb3cgdGhlIGdldCBtZXRob2QgdG8gZGV0ZXJtaW5lCiAgICAgIC8vIHdoaWNoIHZhbHVlIHRvIHJldHVybiwgcmVzcGVjdGl2ZWx5IGVpdGhlcjoKICAgICAgLy8KICAgICAgLy8gICAxLiBUaGUgZW50aXJlIGNhY2hlIG9iamVjdAogICAgICAvLyAgIDIuIFRoZSBkYXRhIHN0b3JlZCBhdCB0aGUga2V5CiAgICAgIC8vCiAgICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCB8fCBrZXkgJiYgdHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHN0b3JlZCA9IHRoaXMuZ2V0KG93bmVyLCBrZXkpOwogICAgICAgIHJldHVybiBzdG9yZWQgIT09IHVuZGVmaW5lZCA/IHN0b3JlZCA6IHRoaXMuZ2V0KG93bmVyLCBqUXVlcnkuY2FtZWxDYXNlKGtleSkpOwogICAgICB9CiAgICAgIC8vIFsqXVdoZW4gdGhlIGtleSBpcyBub3QgYSBzdHJpbmcsIG9yIGJvdGggYSBrZXkgYW5kIHZhbHVlCiAgICAgIC8vIGFyZSBzcGVjaWZpZWQsIHNldCBvciBleHRlbmQgKGV4aXN0aW5nIG9iamVjdHMpIHdpdGggZWl0aGVyOgogICAgICAvLwogICAgICAvLyAgIDEuIEFuIG9iamVjdCBvZiBwcm9wZXJ0aWVzCiAgICAgIC8vICAgMi4gQSBrZXkgYW5kIHZhbHVlCiAgICAgIC8vCiAgICAgIHRoaXMuc2V0KG93bmVyLCBrZXksIHZhbHVlKTsKICAgICAgLy8gU2luY2UgdGhlICJzZXQiIHBhdGggY2FuIGhhdmUgdHdvIHBvc3NpYmxlIGVudHJ5IHBvaW50cwogICAgICAvLyByZXR1cm4gdGhlIGV4cGVjdGVkIGRhdGEgYmFzZWQgb24gd2hpY2ggcGF0aCB3YXMgdGFrZW5bKl0KICAgICAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPyB2YWx1ZSA6IGtleTsKICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uIChvd25lciwga2V5KSB7CiAgICAgIHZhciBpLCBuYW1lLCBjYW1lbCwgdW5sb2NrID0gdGhpcy5rZXkob3duZXIpLCBjYWNoZSA9IHRoaXMuY2FjaGVbdW5sb2NrXTsKICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5jYWNoZVt1bmxvY2tdID0ge307CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU3VwcG9ydCBhcnJheSBvciBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIG9mIGtleXMKICAgICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkoa2V5KSkgewogICAgICAgICAgLy8gSWYgIm5hbWUiIGlzIGFuIGFycmF5IG9mIGtleXMuLi4KICAgICAgICAgIC8vIFdoZW4gZGF0YSBpcyBpbml0aWFsbHkgY3JlYXRlZCwgdmlhICgia2V5IiwgInZhbCIpIHNpZ25hdHVyZSwKICAgICAgICAgIC8vIGtleXMgd2lsbCBiZSBjb252ZXJ0ZWQgdG8gY2FtZWxDYXNlLgogICAgICAgICAgLy8gU2luY2UgdGhlcmUgaXMgbm8gd2F5IHRvIHRlbGwgX2hvd18gYSBrZXkgd2FzIGFkZGVkLCByZW1vdmUKICAgICAgICAgIC8vIGJvdGggcGxhaW4ga2V5IGFuZCBjYW1lbENhc2Uga2V5LiAjMTI3ODYKICAgICAgICAgIC8vIFRoaXMgd2lsbCBvbmx5IHBlbmFsaXplIHRoZSBhcnJheSBhcmd1bWVudCBwYXRoLgogICAgICAgICAgbmFtZSA9IGtleS5jb25jYXQoa2V5Lm1hcChqUXVlcnkuY2FtZWxDYXNlKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhbWVsID0galF1ZXJ5LmNhbWVsQ2FzZShrZXkpOwogICAgICAgICAgLy8gVHJ5IHRoZSBzdHJpbmcgYXMgYSBrZXkgYmVmb3JlIGFueSBtYW5pcHVsYXRpb24KICAgICAgICAgIGlmIChrZXkgaW4gY2FjaGUpIHsKICAgICAgICAgICAgbmFtZSA9IFsKICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgY2FtZWwKICAgICAgICAgICAgXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIElmIGEga2V5IHdpdGggdGhlIHNwYWNlcyBleGlzdHMsIHVzZSBpdC4KICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBjcmVhdGUgYW4gYXJyYXkgYnkgbWF0Y2hpbmcgbm9uLXdoaXRlc3BhY2UKICAgICAgICAgICAgbmFtZSA9IGNhbWVsOwogICAgICAgICAgICBuYW1lID0gbmFtZSBpbiBjYWNoZSA/IFtuYW1lXSA6IG5hbWUubWF0Y2gocm5vdHdoaXRlKSB8fCBbXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaSA9IG5hbWUubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGRlbGV0ZSBjYWNoZVtuYW1lW2ldXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBoYXNEYXRhOiBmdW5jdGlvbiAob3duZXIpIHsKICAgICAgcmV0dXJuICFqUXVlcnkuaXNFbXB0eU9iamVjdCh0aGlzLmNhY2hlW293bmVyW3RoaXMuZXhwYW5kb11dIHx8IHt9KTsKICAgIH0sCiAgICBkaXNjYXJkOiBmdW5jdGlvbiAob3duZXIpIHsKICAgICAgaWYgKG93bmVyW3RoaXMuZXhwYW5kb10pIHsKICAgICAgICBkZWxldGUgdGhpcy5jYWNoZVtvd25lclt0aGlzLmV4cGFuZG9dXTsKICAgICAgfQogICAgfQogIH07CiAgdmFyIGRhdGFfcHJpdiA9IG5ldyBEYXRhKCk7CiAgdmFyIGRhdGFfdXNlciA9IG5ldyBEYXRhKCk7CiAgLyoKICAJSW1wbGVtZW50YXRpb24gU3VtbWFyeQogIAogIAkxLiBFbmZvcmNlIEFQSSBzdXJmYWNlIGFuZCBzZW1hbnRpYyBjb21wYXRpYmlsaXR5IHdpdGggMS45LnggYnJhbmNoCiAgCTIuIEltcHJvdmUgdGhlIG1vZHVsZSdzIG1haW50YWluYWJpbGl0eSBieSByZWR1Y2luZyB0aGUgc3RvcmFnZQogIAkJcGF0aHMgdG8gYSBzaW5nbGUgbWVjaGFuaXNtLgogIAkzLiBVc2UgdGhlIHNhbWUgc2luZ2xlIG1lY2hhbmlzbSB0byBzdXBwb3J0ICJwcml2YXRlIiBhbmQgInVzZXIiIGRhdGEuCiAgCTQuIF9OZXZlcl8gZXhwb3NlICJwcml2YXRlIiBkYXRhIHRvIHVzZXIgY29kZSAoVE9ETzogRHJvcCBfZGF0YSwgX3JlbW92ZURhdGEpCiAgCTUuIEF2b2lkIGV4cG9zaW5nIGltcGxlbWVudGF0aW9uIGRldGFpbHMgb24gdXNlciBvYmplY3RzIChlZy4gZXhwYW5kbyBwcm9wZXJ0aWVzKQogIAk2LiBQcm92aWRlIGEgY2xlYXIgcGF0aCBmb3IgaW1wbGVtZW50YXRpb24gdXBncmFkZSB0byBXZWFrTWFwIGluIDIwMTQKICAqLwogIHZhciByYnJhY2UgPSAvXig/Olx7W1x3XFddKlx9fFxbW1x3XFddKlxdKSQvLCBybXVsdGlEYXNoID0gLyhbQS1aXSkvZzsKICBmdW5jdGlvbiBkYXRhQXR0cihlbGVtLCBrZXksIGRhdGEpIHsKICAgIHZhciBuYW1lOwogICAgLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW50ZXJuYWxseSwgdHJ5IHRvIGZldGNoIGFueQogICAgLy8gZGF0YSBmcm9tIHRoZSBIVE1MNSBkYXRhLSogYXR0cmlidXRlCiAgICBpZiAoZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgbmFtZSA9ICdkYXRhLScgKyBrZXkucmVwbGFjZShybXVsdGlEYXNoLCAnLSQxJykudG9Mb3dlckNhc2UoKTsKICAgICAgZGF0YSA9IGVsZW0uZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGRhdGEgPSBkYXRhID09PSAndHJ1ZScgPyB0cnVlIDogZGF0YSA9PT0gJ2ZhbHNlJyA/IGZhbHNlIDogZGF0YSA9PT0gJ251bGwnID8gbnVsbCA6IC8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCiAgICAgICAgICArZGF0YSArICcnID09PSBkYXRhID8gK2RhdGEgOiByYnJhY2UudGVzdChkYXRhKSA/IGpRdWVyeS5wYXJzZUpTT04oZGF0YSkgOiBkYXRhOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgLy8gTWFrZSBzdXJlIHdlIHNldCB0aGUgZGF0YSBzbyBpdCBpc24ndCBjaGFuZ2VkIGxhdGVyCiAgICAgICAgZGF0YV91c2VyLnNldChlbGVtLCBrZXksIGRhdGEpOwogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICBqUXVlcnkuZXh0ZW5kKHsKICAgIGhhc0RhdGE6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBkYXRhX3VzZXIuaGFzRGF0YShlbGVtKSB8fCBkYXRhX3ByaXYuaGFzRGF0YShlbGVtKTsKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZGF0YSkgewogICAgICByZXR1cm4gZGF0YV91c2VyLmFjY2VzcyhlbGVtLCBuYW1lLCBkYXRhKTsKICAgIH0sCiAgICByZW1vdmVEYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICBkYXRhX3VzZXIucmVtb3ZlKGVsZW0sIG5hbWUpOwogICAgfSwKICAgIC8vIFRPRE86IE5vdyB0aGF0IGFsbCBjYWxscyB0byBfZGF0YSBhbmQgX3JlbW92ZURhdGEgaGF2ZSBiZWVuIHJlcGxhY2VkCiAgICAvLyB3aXRoIGRpcmVjdCBjYWxscyB0byBkYXRhX3ByaXYgbWV0aG9kcywgdGhlc2UgY2FuIGJlIGRlcHJlY2F0ZWQuCiAgICBfZGF0YTogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGRhdGEpIHsKICAgICAgcmV0dXJuIGRhdGFfcHJpdi5hY2Nlc3MoZWxlbSwgbmFtZSwgZGF0YSk7CiAgICB9LAogICAgX3JlbW92ZURhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgIGRhdGFfcHJpdi5yZW1vdmUoZWxlbSwgbmFtZSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBkYXRhOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICB2YXIgaSwgbmFtZSwgZGF0YSwgZWxlbSA9IHRoaXNbMF0sIGF0dHJzID0gZWxlbSAmJiBlbGVtLmF0dHJpYnV0ZXM7CiAgICAgIC8vIEdldHMgYWxsIHZhbHVlcwogICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAodGhpcy5sZW5ndGgpIHsKICAgICAgICAgIGRhdGEgPSBkYXRhX3VzZXIuZ2V0KGVsZW0pOwogICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWRhdGFfcHJpdi5nZXQoZWxlbSwgJ2hhc0RhdGFBdHRycycpKSB7CiAgICAgICAgICAgIGkgPSBhdHRycy5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBJRTExKwogICAgICAgICAgICAgIC8vIFRoZSBhdHRycyBlbGVtZW50cyBjYW4gYmUgbnVsbCAoIzE0ODk0KQogICAgICAgICAgICAgIGlmIChhdHRyc1tpXSkgewogICAgICAgICAgICAgICAgbmFtZSA9IGF0dHJzW2ldLm5hbWU7CiAgICAgICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCdkYXRhLScpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIG5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKG5hbWUuc2xpY2UoNSkpOwogICAgICAgICAgICAgICAgICBkYXRhQXR0cihlbGVtLCBuYW1lLCBkYXRhW25hbWVdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YV9wcml2LnNldChlbGVtLCAnaGFzRGF0YUF0dHJzJywgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkYXRhOwogICAgICB9CiAgICAgIC8vIFNldHMgbXVsdGlwbGUgdmFsdWVzCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgZGF0YV91c2VyLnNldCh0aGlzLCBrZXkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdmFyIGRhdGEsIGNhbWVsS2V5ID0galF1ZXJ5LmNhbWVsQ2FzZShrZXkpOwogICAgICAgIC8vIFRoZSBjYWxsaW5nIGpRdWVyeSBvYmplY3QgKGVsZW1lbnQgbWF0Y2hlcykgaXMgbm90IGVtcHR5CiAgICAgICAgLy8gKGFuZCB0aGVyZWZvcmUgaGFzIGFuIGVsZW1lbnQgYXBwZWFycyBhdCB0aGlzWyAwIF0pIGFuZCB0aGUKICAgICAgICAvLyBgdmFsdWVgIHBhcmFtZXRlciB3YXMgbm90IHVuZGVmaW5lZC4gQW4gZW1wdHkgalF1ZXJ5IG9iamVjdAogICAgICAgIC8vIHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGZvciBlbGVtID0gdGhpc1sgMCBdIHdoaWNoIHdpbGwKICAgICAgICAvLyB0aHJvdyBhbiBleGNlcHRpb24gaWYgYW4gYXR0ZW1wdCB0byByZWFkIGEgZGF0YSBjYWNoZSBpcyBtYWRlLgogICAgICAgIGlmIChlbGVtICYmIHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIC8vIEF0dGVtcHQgdG8gZ2V0IGRhdGEgZnJvbSB0aGUgY2FjaGUKICAgICAgICAgIC8vIHdpdGggdGhlIGtleSBhcy1pcwogICAgICAgICAgZGF0YSA9IGRhdGFfdXNlci5nZXQoZWxlbSwga2V5KTsKICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBBdHRlbXB0IHRvIGdldCBkYXRhIGZyb20gdGhlIGNhY2hlCiAgICAgICAgICAvLyB3aXRoIHRoZSBrZXkgY2FtZWxpemVkCiAgICAgICAgICBkYXRhID0gZGF0YV91c2VyLmdldChlbGVtLCBjYW1lbEtleSk7CiAgICAgICAgICBpZiAoZGF0YSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgICAgfQogICAgICAgICAgLy8gQXR0ZW1wdCB0byAiZGlzY292ZXIiIHRoZSBkYXRhIGluCiAgICAgICAgICAvLyBIVE1MNSBjdXN0b20gZGF0YS0qIGF0dHJzCiAgICAgICAgICBkYXRhID0gZGF0YUF0dHIoZWxlbSwgY2FtZWxLZXksIHVuZGVmaW5lZCk7CiAgICAgICAgICBpZiAoZGF0YSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgICAgfQogICAgICAgICAgLy8gV2UgdHJpZWQgcmVhbGx5IGhhcmQsIGJ1dCB0aGUgZGF0YSBkb2Vzbid0IGV4aXN0LgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBTZXQgdGhlIGRhdGEuLi4KICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gRmlyc3QsIGF0dGVtcHQgdG8gc3RvcmUgYSBjb3B5IG9yIHJlZmVyZW5jZSBvZiBhbnkKICAgICAgICAgIC8vIGRhdGEgdGhhdCBtaWdodCd2ZSBiZWVuIHN0b3JlIHdpdGggYSBjYW1lbENhc2VkIGtleS4KICAgICAgICAgIHZhciBkYXRhID0gZGF0YV91c2VyLmdldCh0aGlzLCBjYW1lbEtleSk7CiAgICAgICAgICAvLyBGb3IgSFRNTDUgZGF0YS0qIGF0dHJpYnV0ZSBpbnRlcm9wLCB3ZSBoYXZlIHRvCiAgICAgICAgICAvLyBzdG9yZSBwcm9wZXJ0eSBuYW1lcyB3aXRoIGRhc2hlcyBpbiBhIGNhbWVsQ2FzZSBmb3JtLgogICAgICAgICAgLy8gVGhpcyBtaWdodCBub3QgYXBwbHkgdG8gYWxsIHByb3BlcnRpZXMuLi4qCiAgICAgICAgICBkYXRhX3VzZXIuc2V0KHRoaXMsIGNhbWVsS2V5LCB2YWx1ZSk7CiAgICAgICAgICAvLyAqLi4uIEluIHRoZSBjYXNlIG9mIHByb3BlcnRpZXMgdGhhdCBtaWdodCBfYWN0dWFsbHlfCiAgICAgICAgICAvLyBoYXZlIGRhc2hlcywgd2UgbmVlZCB0byBhbHNvIHN0b3JlIGEgY29weSBvZiB0aGF0CiAgICAgICAgICAvLyB1bmNoYW5nZWQgcHJvcGVydHkuCiAgICAgICAgICBpZiAoa2V5LmluZGV4T2YoJy0nKSAhPT0gLTEgJiYgZGF0YSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGRhdGFfdXNlci5zZXQodGhpcywga2V5LCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSwgbnVsbCwgdHJ1ZSk7CiAgICB9LAogICAgcmVtb3ZlRGF0YTogZnVuY3Rpb24gKGtleSkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBkYXRhX3VzZXIucmVtb3ZlKHRoaXMsIGtleSk7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgcXVldWU6IGZ1bmN0aW9uIChlbGVtLCB0eXBlLCBkYXRhKSB7CiAgICAgIHZhciBxdWV1ZTsKICAgICAgaWYgKGVsZW0pIHsKICAgICAgICB0eXBlID0gKHR5cGUgfHwgJ2Z4JykgKyAncXVldWUnOwogICAgICAgIHF1ZXVlID0gZGF0YV9wcml2LmdldChlbGVtLCB0eXBlKTsKICAgICAgICAvLyBTcGVlZCB1cCBkZXF1ZXVlIGJ5IGdldHRpbmcgb3V0IHF1aWNrbHkgaWYgdGhpcyBpcyBqdXN0IGEgbG9va3VwCiAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgIGlmICghcXVldWUgfHwgalF1ZXJ5LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgcXVldWUgPSBkYXRhX3ByaXYuYWNjZXNzKGVsZW0sIHR5cGUsIGpRdWVyeS5tYWtlQXJyYXkoZGF0YSkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcXVldWUucHVzaChkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHF1ZXVlIHx8IFtdOwogICAgICB9CiAgICB9LAogICAgZGVxdWV1ZTogZnVuY3Rpb24gKGVsZW0sIHR5cGUpIHsKICAgICAgdHlwZSA9IHR5cGUgfHwgJ2Z4JzsKICAgICAgdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKGVsZW0sIHR5cGUpLCBzdGFydExlbmd0aCA9IHF1ZXVlLmxlbmd0aCwgZm4gPSBxdWV1ZS5zaGlmdCgpLCBob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyhlbGVtLCB0eXBlKSwgbmV4dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGpRdWVyeS5kZXF1ZXVlKGVsZW0sIHR5cGUpOwogICAgICAgIH07CiAgICAgIC8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKICAgICAgaWYgKGZuID09PSAnaW5wcm9ncmVzcycpIHsKICAgICAgICBmbiA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgc3RhcnRMZW5ndGgtLTsKICAgICAgfQogICAgICBpZiAoZm4pIHsKICAgICAgICAvLyBBZGQgYSBwcm9ncmVzcyBzZW50aW5lbCB0byBwcmV2ZW50IHRoZSBmeCBxdWV1ZSBmcm9tIGJlaW5nCiAgICAgICAgLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAogICAgICAgIGlmICh0eXBlID09PSAnZngnKSB7CiAgICAgICAgICBxdWV1ZS51bnNoaWZ0KCdpbnByb2dyZXNzJyk7CiAgICAgICAgfQogICAgICAgIC8vIGNsZWFyIHVwIHRoZSBsYXN0IHF1ZXVlIHN0b3AgZnVuY3Rpb24KICAgICAgICBkZWxldGUgaG9va3Muc3RvcDsKICAgICAgICBmbi5jYWxsKGVsZW0sIG5leHQsIGhvb2tzKTsKICAgICAgfQogICAgICBpZiAoIXN0YXJ0TGVuZ3RoICYmIGhvb2tzKSB7CiAgICAgICAgaG9va3MuZW1wdHkuZmlyZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gbm90IGludGVuZGVkIGZvciBwdWJsaWMgY29uc3VtcHRpb24gLSBnZW5lcmF0ZXMgYSBxdWV1ZUhvb2tzIG9iamVjdCwgb3IgcmV0dXJucyB0aGUgY3VycmVudCBvbmUKICAgIF9xdWV1ZUhvb2tzOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSkgewogICAgICB2YXIga2V5ID0gdHlwZSArICdxdWV1ZUhvb2tzJzsKICAgICAgcmV0dXJuIGRhdGFfcHJpdi5nZXQoZWxlbSwga2V5KSB8fCBkYXRhX3ByaXYuYWNjZXNzKGVsZW0sIGtleSwgewogICAgICAgIGVtcHR5OiBqUXVlcnkuQ2FsbGJhY2tzKCdvbmNlIG1lbW9yeScpLmFkZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkYXRhX3ByaXYucmVtb3ZlKGVsZW0sIFsKICAgICAgICAgICAgdHlwZSArICdxdWV1ZScsCiAgICAgICAgICAgIGtleQogICAgICAgICAgXSk7CiAgICAgICAgfSkKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBxdWV1ZTogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgdmFyIHNldHRlciA9IDI7CiAgICAgIGlmICh0eXBlb2YgdHlwZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICBkYXRhID0gdHlwZTsKICAgICAgICB0eXBlID0gJ2Z4JzsKICAgICAgICBzZXR0ZXItLTsKICAgICAgfQogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlcikgewogICAgICAgIHJldHVybiBqUXVlcnkucXVldWUodGhpc1swXSwgdHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/IHRoaXMgOiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSh0aGlzLCB0eXBlLCBkYXRhKTsKICAgICAgICAvLyBlbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQogICAgICAgIGpRdWVyeS5fcXVldWVIb29rcyh0aGlzLCB0eXBlKTsKICAgICAgICBpZiAodHlwZSA9PT0gJ2Z4JyAmJiBxdWV1ZVswXSAhPT0gJ2lucHJvZ3Jlc3MnKSB7CiAgICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGRlcXVldWU6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeS5kZXF1ZXVlKHRoaXMsIHR5cGUpOwogICAgICB9KTsKICAgIH0sCiAgICBjbGVhclF1ZXVlOiBmdW5jdGlvbiAodHlwZSkgewogICAgICByZXR1cm4gdGhpcy5xdWV1ZSh0eXBlIHx8ICdmeCcsIFtdKTsKICAgIH0sCiAgICAvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlCiAgICAvLyBhcmUgZW1wdGllZCAoZnggaXMgdGhlIHR5cGUgYnkgZGVmYXVsdCkKICAgIHByb21pc2U6IGZ1bmN0aW9uICh0eXBlLCBvYmopIHsKICAgICAgdmFyIHRtcCwgY291bnQgPSAxLCBkZWZlciA9IGpRdWVyeS5EZWZlcnJlZCgpLCBlbGVtZW50cyA9IHRoaXMsIGkgPSB0aGlzLmxlbmd0aCwgcmVzb2x2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICghLS1jb3VudCkgewogICAgICAgICAgICBkZWZlci5yZXNvbHZlV2l0aChlbGVtZW50cywgW2VsZW1lbnRzXSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAnc3RyaW5nJykgewogICAgICAgIG9iaiA9IHR5cGU7CiAgICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICB0eXBlID0gdHlwZSB8fCAnZngnOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgdG1wID0gZGF0YV9wcml2LmdldChlbGVtZW50c1tpXSwgdHlwZSArICdxdWV1ZUhvb2tzJyk7CiAgICAgICAgaWYgKHRtcCAmJiB0bXAuZW1wdHkpIHsKICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICB0bXAuZW1wdHkuYWRkKHJlc29sdmUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXNvbHZlKCk7CiAgICAgIHJldHVybiBkZWZlci5wcm9taXNlKG9iaik7CiAgICB9CiAgfSk7CiAgdmFyIHBudW0gPSAvWystXT8oPzpcZCpcLnwpXGQrKD86W2VFXVsrLV0/XGQrfCkvLnNvdXJjZTsKICB2YXIgY3NzRXhwYW5kID0gWwogICAgJ1RvcCcsCiAgICAnUmlnaHQnLAogICAgJ0JvdHRvbScsCiAgICAnTGVmdCcKICBdOwogIHZhciBpc0hpZGRlbiA9IGZ1bmN0aW9uIChlbGVtLCBlbCkgewogICAgLy8gaXNIaWRkZW4gbWlnaHQgYmUgY2FsbGVkIGZyb20galF1ZXJ5I2ZpbHRlciBmdW5jdGlvbjsKICAgIC8vIGluIHRoYXQgY2FzZSwgZWxlbWVudCB3aWxsIGJlIHNlY29uZCBhcmd1bWVudAogICAgZWxlbSA9IGVsIHx8IGVsZW07CiAgICByZXR1cm4galF1ZXJ5LmNzcyhlbGVtLCAnZGlzcGxheScpID09PSAnbm9uZScgfHwgIWpRdWVyeS5jb250YWlucyhlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0pOwogIH07CiAgdmFyIHJjaGVja2FibGVUeXBlID0gL14oPzpjaGVja2JveHxyYWRpbykkL2k7CiAgKGZ1bmN0aW9uICgpIHsKICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwgZGl2ID0gZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykpLCBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7CiAgICAvLyAjMTEyMTcgLSBXZWJLaXQgbG9zZXMgY2hlY2sgd2hlbiB0aGUgbmFtZSBpcyBhZnRlciB0aGUgY2hlY2tlZCBhdHRyaWJ1dGUKICAgIC8vIFN1cHBvcnQ6IFdpbmRvd3MgV2ViIEFwcHMgKFdXQSkKICAgIC8vIGBuYW1lYCBhbmQgYHR5cGVgIG5lZWQgLnNldEF0dHJpYnV0ZSBmb3IgV1dBCiAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAncmFkaW8nKTsKICAgIGlucHV0LnNldEF0dHJpYnV0ZSgnY2hlY2tlZCcsICdjaGVja2VkJyk7CiAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoJ25hbWUnLCAndCcpOwogICAgZGl2LmFwcGVuZENoaWxkKGlucHV0KTsKICAgIC8vIFN1cHBvcnQ6IFNhZmFyaSA1LjEsIGlPUyA1LjEsIEFuZHJvaWQgNC54LCBBbmRyb2lkIDIuMwogICAgLy8gb2xkIFdlYktpdCBkb2Vzbid0IGNsb25lIGNoZWNrZWQgc3RhdGUgY29ycmVjdGx5IGluIGZyYWdtZW50cwogICAgc3VwcG9ydC5jaGVja0Nsb25lID0gZGl2LmNsb25lTm9kZSh0cnVlKS5jbG9uZU5vZGUodHJ1ZSkubGFzdENoaWxkLmNoZWNrZWQ7CiAgICAvLyBNYWtlIHN1cmUgdGV4dGFyZWEgKGFuZCBjaGVja2JveCkgZGVmYXVsdFZhbHVlIGlzIHByb3Blcmx5IGNsb25lZAogICAgLy8gU3VwcG9ydDogSUU5LUlFMTErCiAgICBkaXYuaW5uZXJIVE1MID0gJzx0ZXh0YXJlYT54PC90ZXh0YXJlYT4nOwogICAgc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCA9ICEhZGl2LmNsb25lTm9kZSh0cnVlKS5sYXN0Q2hpbGQuZGVmYXVsdFZhbHVlOwogIH0oKSk7CiAgdmFyIHN0cnVuZGVmaW5lZCA9IHR5cGVvZiB1bmRlZmluZWQ7CiAgc3VwcG9ydC5mb2N1c2luQnViYmxlcyA9ICdvbmZvY3VzaW4nIGluIHdpbmRvdzsKICB2YXIgcmtleUV2ZW50ID0gL15rZXkvLCBybW91c2VFdmVudCA9IC9eKD86bW91c2V8cG9pbnRlcnxjb250ZXh0bWVudSl8Y2xpY2svLCByZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywgcnR5cGVuYW1lc3BhY2UgPSAvXihbXi5dKikoPzpcLiguKyl8KSQvOwogIGZ1bmN0aW9uIHJldHVyblRydWUoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIHNhZmVBY3RpdmVFbGVtZW50KCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgIH0KICB9CiAgLyoKICAgKiBIZWxwZXIgZnVuY3Rpb25zIGZvciBtYW5hZ2luZyBldmVudHMgLS0gbm90IHBhcnQgb2YgdGhlIHB1YmxpYyBpbnRlcmZhY2UuCiAgICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICAgKi8KICBqUXVlcnkuZXZlbnQgPSB7CiAgICBnbG9iYWw6IHt9LAogICAgYWRkOiBmdW5jdGlvbiAoZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBoYW5kbGVPYmpJbiwgZXZlbnRIYW5kbGUsIHRtcCwgZXZlbnRzLCB0LCBoYW5kbGVPYmosIHNwZWNpYWwsIGhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwgZWxlbURhdGEgPSBkYXRhX3ByaXYuZ2V0KGVsZW0pOwogICAgICAvLyBEb24ndCBhdHRhY2ggZXZlbnRzIHRvIG5vRGF0YSBvciB0ZXh0L2NvbW1lbnQgbm9kZXMgKGJ1dCBhbGxvdyBwbGFpbiBvYmplY3RzKQogICAgICBpZiAoIWVsZW1EYXRhKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIENhbGxlciBjYW4gcGFzcyBpbiBhbiBvYmplY3Qgb2YgY3VzdG9tIGRhdGEgaW4gbGlldSBvZiB0aGUgaGFuZGxlcgogICAgICBpZiAoaGFuZGxlci5oYW5kbGVyKSB7CiAgICAgICAgaGFuZGxlT2JqSW4gPSBoYW5kbGVyOwogICAgICAgIGhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwogICAgICAgIHNlbGVjdG9yID0gaGFuZGxlT2JqSW4uc2VsZWN0b3I7CiAgICAgIH0KICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGhhbmRsZXIgaGFzIGEgdW5pcXVlIElELCB1c2VkIHRvIGZpbmQvcmVtb3ZlIGl0IGxhdGVyCiAgICAgIGlmICghaGFuZGxlci5ndWlkKSB7CiAgICAgICAgaGFuZGxlci5ndWlkID0galF1ZXJ5Lmd1aWQrKzsKICAgICAgfQogICAgICAvLyBJbml0IHRoZSBlbGVtZW50J3MgZXZlbnQgc3RydWN0dXJlIGFuZCBtYWluIGhhbmRsZXIsIGlmIHRoaXMgaXMgdGhlIGZpcnN0CiAgICAgIGlmICghKGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cykpIHsKICAgICAgICBldmVudHMgPSBlbGVtRGF0YS5ldmVudHMgPSB7fTsKICAgICAgfQogICAgICBpZiAoIShldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSkpIHsKICAgICAgICBldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAvLyBEaXNjYXJkIHRoZSBzZWNvbmQgZXZlbnQgb2YgYSBqUXVlcnkuZXZlbnQudHJpZ2dlcigpIGFuZAogICAgICAgICAgLy8gd2hlbiBhbiBldmVudCBpcyBjYWxsZWQgYWZ0ZXIgYSBwYWdlIGhhcyB1bmxvYWRlZAogICAgICAgICAgcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT09IHN0cnVuZGVmaW5lZCAmJiBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUgPyBqUXVlcnkuZXZlbnQuZGlzcGF0Y2guYXBwbHkoZWxlbSwgYXJndW1lbnRzKSA6IHVuZGVmaW5lZDsKICAgICAgICB9OwogICAgICB9CiAgICAgIC8vIEhhbmRsZSBtdWx0aXBsZSBldmVudHMgc2VwYXJhdGVkIGJ5IGEgc3BhY2UKICAgICAgdHlwZXMgPSAodHlwZXMgfHwgJycpLm1hdGNoKHJub3R3aGl0ZSkgfHwgWycnXTsKICAgICAgdCA9IHR5cGVzLmxlbmd0aDsKICAgICAgd2hpbGUgKHQtLSkgewogICAgICAgIHRtcCA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWModHlwZXNbdF0pIHx8IFtdOwogICAgICAgIHR5cGUgPSBvcmlnVHlwZSA9IHRtcFsxXTsKICAgICAgICBuYW1lc3BhY2VzID0gKHRtcFsyXSB8fCAnJykuc3BsaXQoJy4nKS5zb3J0KCk7CiAgICAgICAgLy8gVGhlcmUgKm11c3QqIGJlIGEgdHlwZSwgbm8gYXR0YWNoaW5nIG5hbWVzcGFjZS1vbmx5IGhhbmRsZXJzCiAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgLy8gSWYgZXZlbnQgY2hhbmdlcyBpdHMgdHlwZSwgdXNlIHRoZSBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgY2hhbmdlZCB0eXBlCiAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwogICAgICAgIC8vIElmIHNlbGVjdG9yIGRlZmluZWQsIGRldGVybWluZSBzcGVjaWFsIGV2ZW50IGFwaSB0eXBlLCBvdGhlcndpc2UgZ2l2ZW4gdHlwZQogICAgICAgIHR5cGUgPSAoc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUpIHx8IHR5cGU7CiAgICAgICAgLy8gVXBkYXRlIHNwZWNpYWwgYmFzZWQgb24gbmV3bHkgcmVzZXQgdHlwZQogICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKICAgICAgICAvLyBoYW5kbGVPYmogaXMgcGFzc2VkIHRvIGFsbCBldmVudCBoYW5kbGVycwogICAgICAgIGhhbmRsZU9iaiA9IGpRdWVyeS5leHRlbmQoewogICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgIG9yaWdUeXBlOiBvcmlnVHlwZSwKICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgICAgZ3VpZDogaGFuZGxlci5ndWlkLAogICAgICAgICAgc2VsZWN0b3I6IHNlbGVjdG9yLAogICAgICAgICAgbmVlZHNDb250ZXh0OiBzZWxlY3RvciAmJiBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQudGVzdChzZWxlY3RvciksCiAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZXMuam9pbignLicpCiAgICAgICAgfSwgaGFuZGxlT2JqSW4pOwogICAgICAgIC8vIEluaXQgdGhlIGV2ZW50IGhhbmRsZXIgcXVldWUgaWYgd2UncmUgdGhlIGZpcnN0CiAgICAgICAgaWYgKCEoaGFuZGxlcnMgPSBldmVudHNbdHlwZV0pKSB7CiAgICAgICAgICBoYW5kbGVycyA9IGV2ZW50c1t0eXBlXSA9IFtdOwogICAgICAgICAgaGFuZGxlcnMuZGVsZWdhdGVDb3VudCA9IDA7CiAgICAgICAgICAvLyBPbmx5IHVzZSBhZGRFdmVudExpc3RlbmVyIGlmIHRoZSBzcGVjaWFsIGV2ZW50cyBoYW5kbGVyIHJldHVybnMgZmFsc2UKICAgICAgICAgIGlmICghc3BlY2lhbC5zZXR1cCB8fCBzcGVjaWFsLnNldHVwLmNhbGwoZWxlbSwgZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUpID09PSBmYWxzZSkgewogICAgICAgICAgICBpZiAoZWxlbS5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHNwZWNpYWwuYWRkKSB7CiAgICAgICAgICBzcGVjaWFsLmFkZC5jYWxsKGVsZW0sIGhhbmRsZU9iaik7CiAgICAgICAgICBpZiAoIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQpIHsKICAgICAgICAgICAgaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCA9IGhhbmRsZXIuZ3VpZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gQWRkIHRvIHRoZSBlbGVtZW50J3MgaGFuZGxlciBsaXN0LCBkZWxlZ2F0ZXMgaW4gZnJvbnQKICAgICAgICBpZiAoc2VsZWN0b3IpIHsKICAgICAgICAgIGhhbmRsZXJzLnNwbGljZShoYW5kbGVycy5kZWxlZ2F0ZUNvdW50KyssIDAsIGhhbmRsZU9iaik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGhhbmRsZXJzLnB1c2goaGFuZGxlT2JqKTsKICAgICAgICB9CiAgICAgICAgLy8gS2VlcCB0cmFjayBvZiB3aGljaCBldmVudHMgaGF2ZSBldmVyIGJlZW4gdXNlZCwgZm9yIGV2ZW50IG9wdGltaXphdGlvbgogICAgICAgIGpRdWVyeS5ldmVudC5nbG9iYWxbdHlwZV0gPSB0cnVlOwogICAgICB9CiAgICB9LAogICAgLy8gRGV0YWNoIGFuIGV2ZW50IG9yIHNldCBvZiBldmVudHMgZnJvbSBhbiBlbGVtZW50CiAgICByZW1vdmU6IGZ1bmN0aW9uIChlbGVtLCB0eXBlcywgaGFuZGxlciwgc2VsZWN0b3IsIG1hcHBlZFR5cGVzKSB7CiAgICAgIHZhciBqLCBvcmlnQ291bnQsIHRtcCwgZXZlbnRzLCB0LCBoYW5kbGVPYmosIHNwZWNpYWwsIGhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwgZWxlbURhdGEgPSBkYXRhX3ByaXYuaGFzRGF0YShlbGVtKSAmJiBkYXRhX3ByaXYuZ2V0KGVsZW0pOwogICAgICBpZiAoIWVsZW1EYXRhIHx8ICEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBPbmNlIGZvciBlYWNoIHR5cGUubmFtZXNwYWNlIGluIHR5cGVzOyB0eXBlIG1heSBiZSBvbWl0dGVkCiAgICAgIHR5cGVzID0gKHR5cGVzIHx8ICcnKS5tYXRjaChybm90d2hpdGUpIHx8IFsnJ107CiAgICAgIHQgPSB0eXBlcy5sZW5ndGg7CiAgICAgIHdoaWxlICh0LS0pIHsKICAgICAgICB0bXAgPSBydHlwZW5hbWVzcGFjZS5leGVjKHR5cGVzW3RdKSB8fCBbXTsKICAgICAgICB0eXBlID0gb3JpZ1R5cGUgPSB0bXBbMV07CiAgICAgICAgbmFtZXNwYWNlcyA9ICh0bXBbMl0gfHwgJycpLnNwbGl0KCcuJykuc29ydCgpOwogICAgICAgIC8vIFVuYmluZCBhbGwgZXZlbnRzIChvbiB0aGlzIG5hbWVzcGFjZSwgaWYgcHJvdmlkZWQpIGZvciB0aGUgZWxlbWVudAogICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgZm9yICh0eXBlIGluIGV2ZW50cykgewogICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKGVsZW0sIHR5cGUgKyB0eXBlc1t0XSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKICAgICAgICB0eXBlID0gKHNlbGVjdG9yID8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlKSB8fCB0eXBlOwogICAgICAgIGhhbmRsZXJzID0gZXZlbnRzW3R5cGVdIHx8IFtdOwogICAgICAgIHRtcCA9IHRtcFsyXSAmJiBuZXcgUmVnRXhwKCcoXnxcXC4pJyArIG5hbWVzcGFjZXMuam9pbignXFwuKD86LipcXC58KScpICsgJyhcXC58JCknKTsKICAgICAgICAvLyBSZW1vdmUgbWF0Y2hpbmcgZXZlbnRzCiAgICAgICAgb3JpZ0NvdW50ID0gaiA9IGhhbmRsZXJzLmxlbmd0aDsKICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICBoYW5kbGVPYmogPSBoYW5kbGVyc1tqXTsKICAgICAgICAgIGlmICgobWFwcGVkVHlwZXMgfHwgb3JpZ1R5cGUgPT09IGhhbmRsZU9iai5vcmlnVHlwZSkgJiYgKCFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQpICYmICghdG1wIHx8IHRtcC50ZXN0KGhhbmRsZU9iai5uYW1lc3BhY2UpKSAmJiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09ICcqKicgJiYgaGFuZGxlT2JqLnNlbGVjdG9yKSkgewogICAgICAgICAgICBoYW5kbGVycy5zcGxpY2UoaiwgMSk7CiAgICAgICAgICAgIGlmIChoYW5kbGVPYmouc2VsZWN0b3IpIHsKICAgICAgICAgICAgICBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNwZWNpYWwucmVtb3ZlKSB7CiAgICAgICAgICAgICAgc3BlY2lhbC5yZW1vdmUuY2FsbChlbGVtLCBoYW5kbGVPYmopOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgd2UgcmVtb3ZlZCBzb21ldGhpbmcgYW5kIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKICAgICAgICAvLyAoYXZvaWRzIHBvdGVudGlhbCBmb3IgZW5kbGVzcyByZWN1cnNpb24gZHVyaW5nIHJlbW92YWwgb2Ygc3BlY2lhbCBldmVudCBoYW5kbGVycykKICAgICAgICBpZiAob3JpZ0NvdW50ICYmICFoYW5kbGVycy5sZW5ndGgpIHsKICAgICAgICAgIGlmICghc3BlY2lhbC50ZWFyZG93biB8fCBzcGVjaWFsLnRlYXJkb3duLmNhbGwoZWxlbSwgbmFtZXNwYWNlcywgZWxlbURhdGEuaGFuZGxlKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZUV2ZW50KGVsZW0sIHR5cGUsIGVsZW1EYXRhLmhhbmRsZSk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAogICAgICBpZiAoalF1ZXJ5LmlzRW1wdHlPYmplY3QoZXZlbnRzKSkgewogICAgICAgIGRlbGV0ZSBlbGVtRGF0YS5oYW5kbGU7CiAgICAgICAgZGF0YV9wcml2LnJlbW92ZShlbGVtLCAnZXZlbnRzJyk7CiAgICAgIH0KICAgIH0sCiAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoZXZlbnQsIGRhdGEsIGVsZW0sIG9ubHlIYW5kbGVycykgewogICAgICB2YXIgaSwgY3VyLCB0bXAsIGJ1YmJsZVR5cGUsIG9udHlwZSwgaGFuZGxlLCBzcGVjaWFsLCBldmVudFBhdGggPSBbZWxlbSB8fCBkb2N1bWVudF0sIHR5cGUgPSBoYXNPd24uY2FsbChldmVudCwgJ3R5cGUnKSA/IGV2ZW50LnR5cGUgOiBldmVudCwgbmFtZXNwYWNlcyA9IGhhc093bi5jYWxsKGV2ZW50LCAnbmFtZXNwYWNlJykgPyBldmVudC5uYW1lc3BhY2Uuc3BsaXQoJy4nKSA6IFtdOwogICAgICBjdXIgPSB0bXAgPSBlbGVtID0gZWxlbSB8fCBkb2N1bWVudDsKICAgICAgLy8gRG9uJ3QgZG8gZXZlbnRzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBmb2N1cy9ibHVyIG1vcnBocyB0byBmb2N1c2luL291dDsgZW5zdXJlIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbSByaWdodCBub3cKICAgICAgaWYgKHJmb2N1c01vcnBoLnRlc3QodHlwZSArIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0eXBlLmluZGV4T2YoJy4nKSA+PSAwKSB7CiAgICAgICAgLy8gTmFtZXNwYWNlZCB0cmlnZ2VyOyBjcmVhdGUgYSByZWdleHAgdG8gbWF0Y2ggZXZlbnQgdHlwZSBpbiBoYW5kbGUoKQogICAgICAgIG5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCcuJyk7CiAgICAgICAgdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsKICAgICAgICBuYW1lc3BhY2VzLnNvcnQoKTsKICAgICAgfQogICAgICBvbnR5cGUgPSB0eXBlLmluZGV4T2YoJzonKSA8IDAgJiYgJ29uJyArIHR5cGU7CiAgICAgIC8vIENhbGxlciBjYW4gcGFzcyBpbiBhIGpRdWVyeS5FdmVudCBvYmplY3QsIE9iamVjdCwgb3IganVzdCBhbiBldmVudCB0eXBlIHN0cmluZwogICAgICBldmVudCA9IGV2ZW50W2pRdWVyeS5leHBhbmRvXSA/IGV2ZW50IDogbmV3IGpRdWVyeS5FdmVudCh0eXBlLCB0eXBlb2YgZXZlbnQgPT09ICdvYmplY3QnICYmIGV2ZW50KTsKICAgICAgLy8gVHJpZ2dlciBiaXRtYXNrOiAmIDEgZm9yIG5hdGl2ZSBoYW5kbGVyczsgJiAyIGZvciBqUXVlcnkgKGFsd2F5cyB0cnVlKQogICAgICBldmVudC5pc1RyaWdnZXIgPSBvbmx5SGFuZGxlcnMgPyAyIDogMzsKICAgICAgZXZlbnQubmFtZXNwYWNlID0gbmFtZXNwYWNlcy5qb2luKCcuJyk7CiAgICAgIGV2ZW50Lm5hbWVzcGFjZV9yZSA9IGV2ZW50Lm5hbWVzcGFjZSA/IG5ldyBSZWdFeHAoJyhefFxcLiknICsgbmFtZXNwYWNlcy5qb2luKCdcXC4oPzouKlxcLnwpJykgKyAnKFxcLnwkKScpIDogbnVsbDsKICAgICAgLy8gQ2xlYW4gdXAgdGhlIGV2ZW50IGluIGNhc2UgaXQgaXMgYmVpbmcgcmV1c2VkCiAgICAgIGV2ZW50LnJlc3VsdCA9IHVuZGVmaW5lZDsKICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICBldmVudC50YXJnZXQgPSBlbGVtOwogICAgICB9CiAgICAgIC8vIENsb25lIGFueSBpbmNvbWluZyBkYXRhIGFuZCBwcmVwZW5kIHRoZSBldmVudCwgY3JlYXRpbmcgdGhlIGhhbmRsZXIgYXJnIGxpc3QKICAgICAgZGF0YSA9IGRhdGEgPT0gbnVsbCA/IFtldmVudF0gOiBqUXVlcnkubWFrZUFycmF5KGRhdGEsIFtldmVudF0pOwogICAgICAvLyBBbGxvdyBzcGVjaWFsIGV2ZW50cyB0byBkcmF3IG91dHNpZGUgdGhlIGxpbmVzCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKICAgICAgaWYgKCFvbmx5SGFuZGxlcnMgJiYgc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseShlbGVtLCBkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gRGV0ZXJtaW5lIGV2ZW50IHByb3BhZ2F0aW9uIHBhdGggaW4gYWR2YW5jZSwgcGVyIFczQyBldmVudHMgc3BlYyAoIzk5NTEpCiAgICAgIC8vIEJ1YmJsZSB1cCB0byBkb2N1bWVudCwgdGhlbiB0byB3aW5kb3c7IHdhdGNoIGZvciBhIGdsb2JhbCBvd25lckRvY3VtZW50IHZhciAoIzk3MjQpCiAgICAgIGlmICghb25seUhhbmRsZXJzICYmICFzcGVjaWFsLm5vQnViYmxlICYmICFqUXVlcnkuaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICBidWJibGVUeXBlID0gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgfHwgdHlwZTsKICAgICAgICBpZiAoIXJmb2N1c01vcnBoLnRlc3QoYnViYmxlVHlwZSArIHR5cGUpKSB7CiAgICAgICAgICBjdXIgPSBjdXIucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgZm9yICg7IGN1cjsgY3VyID0gY3VyLnBhcmVudE5vZGUpIHsKICAgICAgICAgIGV2ZW50UGF0aC5wdXNoKGN1cik7CiAgICAgICAgICB0bXAgPSBjdXI7CiAgICAgICAgfQogICAgICAgIC8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQogICAgICAgIGlmICh0bXAgPT09IChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpKSB7CiAgICAgICAgICBldmVudFBhdGgucHVzaCh0bXAuZGVmYXVsdFZpZXcgfHwgdG1wLnBhcmVudFdpbmRvdyB8fCB3aW5kb3cpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBGaXJlIGhhbmRsZXJzIG9uIHRoZSBldmVudCBwYXRoCiAgICAgIGkgPSAwOwogICAgICB3aGlsZSAoKGN1ciA9IGV2ZW50UGF0aFtpKytdKSAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgIGV2ZW50LnR5cGUgPSBpID4gMSA/IGJ1YmJsZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlIHx8IHR5cGU7CiAgICAgICAgLy8galF1ZXJ5IGhhbmRsZXIKICAgICAgICBoYW5kbGUgPSAoZGF0YV9wcml2LmdldChjdXIsICdldmVudHMnKSB8fCB7fSlbZXZlbnQudHlwZV0gJiYgZGF0YV9wcml2LmdldChjdXIsICdoYW5kbGUnKTsKICAgICAgICBpZiAoaGFuZGxlKSB7CiAgICAgICAgICBoYW5kbGUuYXBwbHkoY3VyLCBkYXRhKTsKICAgICAgICB9CiAgICAgICAgLy8gTmF0aXZlIGhhbmRsZXIKICAgICAgICBoYW5kbGUgPSBvbnR5cGUgJiYgY3VyW29udHlwZV07CiAgICAgICAgaWYgKGhhbmRsZSAmJiBoYW5kbGUuYXBwbHkgJiYgalF1ZXJ5LmFjY2VwdERhdGEoY3VyKSkgewogICAgICAgICAgZXZlbnQucmVzdWx0ID0gaGFuZGxlLmFwcGx5KGN1ciwgZGF0YSk7CiAgICAgICAgICBpZiAoZXZlbnQucmVzdWx0ID09PSBmYWxzZSkgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBldmVudC50eXBlID0gdHlwZTsKICAgICAgLy8gSWYgbm9ib2R5IHByZXZlbnRlZCB0aGUgZGVmYXVsdCBhY3Rpb24sIGRvIGl0IG5vdwogICAgICBpZiAoIW9ubHlIYW5kbGVycyAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICBpZiAoKCFzcGVjaWFsLl9kZWZhdWx0IHx8IHNwZWNpYWwuX2RlZmF1bHQuYXBwbHkoZXZlbnRQYXRoLnBvcCgpLCBkYXRhKSA9PT0gZmFsc2UpICYmIGpRdWVyeS5hY2NlcHREYXRhKGVsZW0pKSB7CiAgICAgICAgICAvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgbmFtZSBhcyB0aGUgZXZlbnQuCiAgICAgICAgICAvLyBEb24ndCBkbyBkZWZhdWx0IGFjdGlvbnMgb24gd2luZG93LCB0aGF0J3Mgd2hlcmUgZ2xvYmFsIHZhcmlhYmxlcyBiZSAoIzYxNzApCiAgICAgICAgICBpZiAob250eXBlICYmIGpRdWVyeS5pc0Z1bmN0aW9uKGVsZW1bdHlwZV0pICYmICFqUXVlcnkuaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICAgICAgLy8gRG9uJ3QgcmUtdHJpZ2dlciBhbiBvbkZPTyBldmVudCB3aGVuIHdlIGNhbGwgaXRzIEZPTygpIG1ldGhvZAogICAgICAgICAgICB0bXAgPSBlbGVtW29udHlwZV07CiAgICAgICAgICAgIGlmICh0bXApIHsKICAgICAgICAgICAgICBlbGVtW29udHlwZV0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlCiAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwogICAgICAgICAgICBlbGVtW3R5cGVdKCk7CiAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGlmICh0bXApIHsKICAgICAgICAgICAgICBlbGVtW29udHlwZV0gPSB0bXA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50LnJlc3VsdDsKICAgIH0sCiAgICBkaXNwYXRjaDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIC8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdAogICAgICBldmVudCA9IGpRdWVyeS5ldmVudC5maXgoZXZlbnQpOwogICAgICB2YXIgaSwgaiwgcmV0LCBtYXRjaGVkLCBoYW5kbGVPYmosIGhhbmRsZXJRdWV1ZSA9IFtdLCBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpLCBoYW5kbGVycyA9IChkYXRhX3ByaXYuZ2V0KHRoaXMsICdldmVudHMnKSB8fCB7fSlbZXZlbnQudHlwZV0gfHwgW10sIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFtldmVudC50eXBlXSB8fCB7fTsKICAgICAgLy8gVXNlIHRoZSBmaXgtZWQgalF1ZXJ5LkV2ZW50IHJhdGhlciB0aGFuIHRoZSAocmVhZC1vbmx5KSBuYXRpdmUgZXZlbnQKICAgICAgYXJnc1swXSA9IGV2ZW50OwogICAgICBldmVudC5kZWxlZ2F0ZVRhcmdldCA9IHRoaXM7CiAgICAgIC8vIENhbGwgdGhlIHByZURpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZSwgYW5kIGxldCBpdCBiYWlsIGlmIGRlc2lyZWQKICAgICAgaWYgKHNwZWNpYWwucHJlRGlzcGF0Y2ggJiYgc3BlY2lhbC5wcmVEaXNwYXRjaC5jYWxsKHRoaXMsIGV2ZW50KSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gRGV0ZXJtaW5lIGhhbmRsZXJzCiAgICAgIGhhbmRsZXJRdWV1ZSA9IGpRdWVyeS5ldmVudC5oYW5kbGVycy5jYWxsKHRoaXMsIGV2ZW50LCBoYW5kbGVycyk7CiAgICAgIC8vIFJ1biBkZWxlZ2F0ZXMgZmlyc3Q7IHRoZXkgbWF5IHdhbnQgdG8gc3RvcCBwcm9wYWdhdGlvbiBiZW5lYXRoIHVzCiAgICAgIGkgPSAwOwogICAgICB3aGlsZSAoKG1hdGNoZWQgPSBoYW5kbGVyUXVldWVbaSsrXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gbWF0Y2hlZC5lbGVtOwogICAgICAgIGogPSAwOwogICAgICAgIHdoaWxlICgoaGFuZGxlT2JqID0gbWF0Y2hlZC5oYW5kbGVyc1tqKytdKSAmJiAhZXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgLy8gVHJpZ2dlcmVkIGV2ZW50IG11c3QgZWl0aGVyIDEpIGhhdmUgbm8gbmFtZXNwYWNlLCBvcgogICAgICAgICAgLy8gMikgaGF2ZSBuYW1lc3BhY2UocykgYSBzdWJzZXQgb3IgZXF1YWwgdG8gdGhvc2UgaW4gdGhlIGJvdW5kIGV2ZW50IChib3RoIGNhbiBoYXZlIG5vIG5hbWVzcGFjZSkuCiAgICAgICAgICBpZiAoIWV2ZW50Lm5hbWVzcGFjZV9yZSB8fCBldmVudC5uYW1lc3BhY2VfcmUudGVzdChoYW5kbGVPYmoubmFtZXNwYWNlKSkgewogICAgICAgICAgICBldmVudC5oYW5kbGVPYmogPSBoYW5kbGVPYmo7CiAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBoYW5kbGVPYmouZGF0YTsKICAgICAgICAgICAgcmV0ID0gKChqUXVlcnkuZXZlbnQuc3BlY2lhbFtoYW5kbGVPYmoub3JpZ1R5cGVdIHx8IHt9KS5oYW5kbGUgfHwgaGFuZGxlT2JqLmhhbmRsZXIpLmFwcGx5KG1hdGNoZWQuZWxlbSwgYXJncyk7CiAgICAgICAgICAgIGlmIChyZXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGlmICgoZXZlbnQucmVzdWx0ID0gcmV0KSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQogICAgICBpZiAoc3BlY2lhbC5wb3N0RGlzcGF0Y2gpIHsKICAgICAgICBzcGVjaWFsLnBvc3REaXNwYXRjaC5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgfQogICAgICByZXR1cm4gZXZlbnQucmVzdWx0OwogICAgfSwKICAgIGhhbmRsZXJzOiBmdW5jdGlvbiAoZXZlbnQsIGhhbmRsZXJzKSB7CiAgICAgIHZhciBpLCBtYXRjaGVzLCBzZWwsIGhhbmRsZU9iaiwgaGFuZGxlclF1ZXVlID0gW10sIGRlbGVnYXRlQ291bnQgPSBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LCBjdXIgPSBldmVudC50YXJnZXQ7CiAgICAgIC8vIEZpbmQgZGVsZWdhdGUgaGFuZGxlcnMKICAgICAgLy8gQmxhY2staG9sZSBTVkcgPHVzZT4gaW5zdGFuY2UgdHJlZXMgKCMxMzE4MCkKICAgICAgLy8gQXZvaWQgbm9uLWxlZnQtY2xpY2sgYnViYmxpbmcgaW4gRmlyZWZveCAoIzM4NjEpCiAgICAgIGlmIChkZWxlZ2F0ZUNvdW50ICYmIGN1ci5ub2RlVHlwZSAmJiAoIWV2ZW50LmJ1dHRvbiB8fCBldmVudC50eXBlICE9PSAnY2xpY2snKSkgewogICAgICAgIGZvciAoOyBjdXIgIT09IHRoaXM7IGN1ciA9IGN1ci5wYXJlbnROb2RlIHx8IHRoaXMpIHsKICAgICAgICAgIC8vIERvbid0IHByb2Nlc3MgY2xpY2tzIG9uIGRpc2FibGVkIGVsZW1lbnRzICgjNjkxMSwgIzgxNjUsICMxMTM4MiwgIzExNzY0KQogICAgICAgICAgaWYgKGN1ci5kaXNhYmxlZCAhPT0gdHJ1ZSB8fCBldmVudC50eXBlICE9PSAnY2xpY2snKSB7CiAgICAgICAgICAgIG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGRlbGVnYXRlQ291bnQ7IGkrKykgewogICAgICAgICAgICAgIGhhbmRsZU9iaiA9IGhhbmRsZXJzW2ldOwogICAgICAgICAgICAgIC8vIERvbid0IGNvbmZsaWN0IHdpdGggT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzICgjMTMyMDMpCiAgICAgICAgICAgICAgc2VsID0gaGFuZGxlT2JqLnNlbGVjdG9yICsgJyAnOwogICAgICAgICAgICAgIGlmIChtYXRjaGVzW3NlbF0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgbWF0Y2hlc1tzZWxdID0gaGFuZGxlT2JqLm5lZWRzQ29udGV4dCA/IGpRdWVyeShzZWwsIHRoaXMpLmluZGV4KGN1cikgPj0gMCA6IGpRdWVyeS5maW5kKHNlbCwgdGhpcywgbnVsbCwgW2N1cl0pLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG1hdGNoZXNbc2VsXSkgewogICAgICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKGhhbmRsZU9iaik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtYXRjaGVzLmxlbmd0aCkgewogICAgICAgICAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGVsZW06IGN1ciwKICAgICAgICAgICAgICAgIGhhbmRsZXJzOiBtYXRjaGVzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQWRkIHRoZSByZW1haW5pbmcgKGRpcmVjdGx5LWJvdW5kKSBoYW5kbGVycwogICAgICBpZiAoZGVsZWdhdGVDb3VudCA8IGhhbmRsZXJzLmxlbmd0aCkgewogICAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsKICAgICAgICAgIGVsZW06IHRoaXMsCiAgICAgICAgICBoYW5kbGVyczogaGFuZGxlcnMuc2xpY2UoZGVsZWdhdGVDb3VudCkKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gaGFuZGxlclF1ZXVlOwogICAgfSwKICAgIC8vIEluY2x1ZGVzIHNvbWUgZXZlbnQgcHJvcHMgc2hhcmVkIGJ5IEtleUV2ZW50IGFuZCBNb3VzZUV2ZW50CiAgICBwcm9wczogJ2FsdEtleSBidWJibGVzIGNhbmNlbGFibGUgY3RybEtleSBjdXJyZW50VGFyZ2V0IGV2ZW50UGhhc2UgbWV0YUtleSByZWxhdGVkVGFyZ2V0IHNoaWZ0S2V5IHRhcmdldCB0aW1lU3RhbXAgdmlldyB3aGljaCcuc3BsaXQoJyAnKSwKICAgIGZpeEhvb2tzOiB7fSwKICAgIGtleUhvb2tzOiB7CiAgICAgIHByb3BzOiAnY2hhciBjaGFyQ29kZSBrZXkga2V5Q29kZScuc3BsaXQoJyAnKSwKICAgICAgZmlsdGVyOiBmdW5jdGlvbiAoZXZlbnQsIG9yaWdpbmFsKSB7CiAgICAgICAgLy8gQWRkIHdoaWNoIGZvciBrZXkgZXZlbnRzCiAgICAgICAgaWYgKGV2ZW50LndoaWNoID09IG51bGwpIHsKICAgICAgICAgIGV2ZW50LndoaWNoID0gb3JpZ2luYWwuY2hhckNvZGUgIT0gbnVsbCA/IG9yaWdpbmFsLmNoYXJDb2RlIDogb3JpZ2luYWwua2V5Q29kZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICB9CiAgICB9LAogICAgbW91c2VIb29rczogewogICAgICBwcm9wczogJ2J1dHRvbiBidXR0b25zIGNsaWVudFggY2xpZW50WSBvZmZzZXRYIG9mZnNldFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIHRvRWxlbWVudCcuc3BsaXQoJyAnKSwKICAgICAgZmlsdGVyOiBmdW5jdGlvbiAoZXZlbnQsIG9yaWdpbmFsKSB7CiAgICAgICAgdmFyIGV2ZW50RG9jLCBkb2MsIGJvZHksIGJ1dHRvbiA9IG9yaWdpbmFsLmJ1dHRvbjsKICAgICAgICAvLyBDYWxjdWxhdGUgcGFnZVgvWSBpZiBtaXNzaW5nIGFuZCBjbGllbnRYL1kgYXZhaWxhYmxlCiAgICAgICAgaWYgKGV2ZW50LnBhZ2VYID09IG51bGwgJiYgb3JpZ2luYWwuY2xpZW50WCAhPSBudWxsKSB7CiAgICAgICAgICBldmVudERvYyA9IGV2ZW50LnRhcmdldC5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50OwogICAgICAgICAgZG9jID0gZXZlbnREb2MuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgYm9keSA9IGV2ZW50RG9jLmJvZHk7CiAgICAgICAgICBldmVudC5wYWdlWCA9IG9yaWdpbmFsLmNsaWVudFggKyAoZG9jICYmIGRvYy5zY3JvbGxMZWZ0IHx8IGJvZHkgJiYgYm9keS5zY3JvbGxMZWZ0IHx8IDApIC0gKGRvYyAmJiBkb2MuY2xpZW50TGVmdCB8fCBib2R5ICYmIGJvZHkuY2xpZW50TGVmdCB8fCAwKTsKICAgICAgICAgIGV2ZW50LnBhZ2VZID0gb3JpZ2luYWwuY2xpZW50WSArIChkb2MgJiYgZG9jLnNjcm9sbFRvcCB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsVG9wIHx8IDApIC0gKGRvYyAmJiBkb2MuY2xpZW50VG9wIHx8IGJvZHkgJiYgYm9keS5jbGllbnRUb3AgfHwgMCk7CiAgICAgICAgfQogICAgICAgIC8vIEFkZCB3aGljaCBmb3IgY2xpY2s6IDEgPT09IGxlZnQ7IDIgPT09IG1pZGRsZTsgMyA9PT0gcmlnaHQKICAgICAgICAvLyBOb3RlOiBidXR0b24gaXMgbm90IG5vcm1hbGl6ZWQsIHNvIGRvbid0IHVzZSBpdAogICAgICAgIGlmICghZXZlbnQud2hpY2ggJiYgYnV0dG9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGV2ZW50LndoaWNoID0gYnV0dG9uICYgMSA/IDEgOiBidXR0b24gJiAyID8gMyA6IGJ1dHRvbiAmIDQgPyAyIDogMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICB9CiAgICB9LAogICAgZml4OiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgaWYgKGV2ZW50W2pRdWVyeS5leHBhbmRvXSkgewogICAgICAgIHJldHVybiBldmVudDsKICAgICAgfQogICAgICAvLyBDcmVhdGUgYSB3cml0YWJsZSBjb3B5IG9mIHRoZSBldmVudCBvYmplY3QgYW5kIG5vcm1hbGl6ZSBzb21lIHByb3BlcnRpZXMKICAgICAgdmFyIGksIHByb3AsIGNvcHksIHR5cGUgPSBldmVudC50eXBlLCBvcmlnaW5hbEV2ZW50ID0gZXZlbnQsIGZpeEhvb2sgPSB0aGlzLmZpeEhvb2tzW3R5cGVdOwogICAgICBpZiAoIWZpeEhvb2spIHsKICAgICAgICB0aGlzLmZpeEhvb2tzW3R5cGVdID0gZml4SG9vayA9IHJtb3VzZUV2ZW50LnRlc3QodHlwZSkgPyB0aGlzLm1vdXNlSG9va3MgOiBya2V5RXZlbnQudGVzdCh0eXBlKSA/IHRoaXMua2V5SG9va3MgOiB7fTsKICAgICAgfQogICAgICBjb3B5ID0gZml4SG9vay5wcm9wcyA/IHRoaXMucHJvcHMuY29uY2F0KGZpeEhvb2sucHJvcHMpIDogdGhpcy5wcm9wczsKICAgICAgZXZlbnQgPSBuZXcgalF1ZXJ5LkV2ZW50KG9yaWdpbmFsRXZlbnQpOwogICAgICBpID0gY29weS5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICBwcm9wID0gY29weVtpXTsKICAgICAgICBldmVudFtwcm9wXSA9IG9yaWdpbmFsRXZlbnRbcHJvcF07CiAgICAgIH0KICAgICAgLy8gU3VwcG9ydDogQ29yZG92YSAyLjUgKFdlYktpdCkgKCMxMzI1NSkKICAgICAgLy8gQWxsIGV2ZW50cyBzaG91bGQgaGF2ZSBhIHRhcmdldDsgQ29yZG92YSBkZXZpY2VyZWFkeSBkb2Vzbid0CiAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgZXZlbnQudGFyZ2V0ID0gZG9jdW1lbnQ7CiAgICAgIH0KICAgICAgLy8gU3VwcG9ydDogU2FmYXJpIDYuMCssIENocm9tZSA8IDI4CiAgICAgIC8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCAjMTMxNDMpCiAgICAgIGlmIChldmVudC50YXJnZXQubm9kZVR5cGUgPT09IDMpIHsKICAgICAgICBldmVudC50YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTsKICAgICAgfQogICAgICByZXR1cm4gZml4SG9vay5maWx0ZXIgPyBmaXhIb29rLmZpbHRlcihldmVudCwgb3JpZ2luYWxFdmVudCkgOiBldmVudDsKICAgIH0sCiAgICBzcGVjaWFsOiB7CiAgICAgIGxvYWQ6IHsKICAgICAgICAvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkCiAgICAgICAgbm9CdWJibGU6IHRydWUKICAgICAgfSwKICAgICAgZm9jdXM6IHsKICAgICAgICAvLyBGaXJlIG5hdGl2ZSBldmVudCBpZiBwb3NzaWJsZSBzbyBibHVyL2ZvY3VzIHNlcXVlbmNlIGlzIGNvcnJlY3QKICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcyAhPT0gc2FmZUFjdGl2ZUVsZW1lbnQoKSAmJiB0aGlzLmZvY3VzKSB7CiAgICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZGVsZWdhdGVUeXBlOiAnZm9jdXNpbicKICAgICAgfSwKICAgICAgYmx1cjogewogICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzID09PSBzYWZlQWN0aXZlRWxlbWVudCgpICYmIHRoaXMuYmx1cikgewogICAgICAgICAgICB0aGlzLmJsdXIoKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZGVsZWdhdGVUeXBlOiAnZm9jdXNvdXQnCiAgICAgIH0sCiAgICAgIGNsaWNrOiB7CiAgICAgICAgLy8gRm9yIGNoZWNrYm94LCBmaXJlIG5hdGl2ZSBldmVudCBzbyBjaGVja2VkIHN0YXRlIHdpbGwgYmUgcmlnaHQKICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy50eXBlID09PSAnY2hlY2tib3gnICYmIHRoaXMuY2xpY2sgJiYgalF1ZXJ5Lm5vZGVOYW1lKHRoaXMsICdpbnB1dCcpKSB7CiAgICAgICAgICAgIHRoaXMuY2xpY2soKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLy8gRm9yIGNyb3NzLWJyb3dzZXIgY29uc2lzdGVuY3ksIGRvbid0IGZpcmUgbmF0aXZlIC5jbGljaygpIG9uIGxpbmtzCiAgICAgICAgX2RlZmF1bHQ6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgcmV0dXJuIGpRdWVyeS5ub2RlTmFtZShldmVudC50YXJnZXQsICdhJyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBiZWZvcmV1bmxvYWQ6IHsKICAgICAgICBwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgLy8gU3VwcG9ydDogRmlyZWZveCAyMCsKICAgICAgICAgIC8vIEZpcmVmb3ggZG9lc24ndCBhbGVydCBpZiB0aGUgcmV0dXJuVmFsdWUgZmllbGQgaXMgbm90IHNldC4KICAgICAgICAgIGlmIChldmVudC5yZXN1bHQgIT09IHVuZGVmaW5lZCAmJiBldmVudC5vcmlnaW5hbEV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50Lm9yaWdpbmFsRXZlbnQucmV0dXJuVmFsdWUgPSBldmVudC5yZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgc2ltdWxhdGU6IGZ1bmN0aW9uICh0eXBlLCBlbGVtLCBldmVudCwgYnViYmxlKSB7CiAgICAgIC8vIFBpZ2d5YmFjayBvbiBhIGRvbm9yIGV2ZW50IHRvIHNpbXVsYXRlIGEgZGlmZmVyZW50IG9uZS4KICAgICAgLy8gRmFrZSBvcmlnaW5hbEV2ZW50IHRvIGF2b2lkIGRvbm9yJ3Mgc3RvcFByb3BhZ2F0aW9uLCBidXQgaWYgdGhlCiAgICAgIC8vIHNpbXVsYXRlZCBldmVudCBwcmV2ZW50cyBkZWZhdWx0IHRoZW4gd2UgZG8gdGhlIHNhbWUgb24gdGhlIGRvbm9yLgogICAgICB2YXIgZSA9IGpRdWVyeS5leHRlbmQobmV3IGpRdWVyeS5FdmVudCgpLCBldmVudCwgewogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgaXNTaW11bGF0ZWQ6IHRydWUsCiAgICAgICAgb3JpZ2luYWxFdmVudDoge30KICAgICAgfSk7CiAgICAgIGlmIChidWJibGUpIHsKICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcihlLCBudWxsLCBlbGVtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBqUXVlcnkuZXZlbnQuZGlzcGF0Y2guY2FsbChlbGVtLCBlKTsKICAgICAgfQogICAgICBpZiAoZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgewogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0KICB9OwogIGpRdWVyeS5yZW1vdmVFdmVudCA9IGZ1bmN0aW9uIChlbGVtLCB0eXBlLCBoYW5kbGUpIHsKICAgIGlmIChlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHsKICAgICAgZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZSwgZmFsc2UpOwogICAgfQogIH07CiAgalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24gKHNyYywgcHJvcHMpIHsKICAgIC8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGpRdWVyeS5FdmVudCkpIHsKICAgICAgcmV0dXJuIG5ldyBqUXVlcnkuRXZlbnQoc3JjLCBwcm9wcyk7CiAgICB9CiAgICAvLyBFdmVudCBvYmplY3QKICAgIGlmIChzcmMgJiYgc3JjLnR5cGUpIHsKICAgICAgdGhpcy5vcmlnaW5hbEV2ZW50ID0gc3JjOwogICAgICB0aGlzLnR5cGUgPSBzcmMudHlwZTsKICAgICAgLy8gRXZlbnRzIGJ1YmJsaW5nIHVwIHRoZSBkb2N1bWVudCBtYXkgaGF2ZSBiZWVuIG1hcmtlZCBhcyBwcmV2ZW50ZWQKICAgICAgLy8gYnkgYSBoYW5kbGVyIGxvd2VyIGRvd24gdGhlIHRyZWU7IHJlZmxlY3QgdGhlIGNvcnJlY3QgdmFsdWUuCiAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gc3JjLmRlZmF1bHRQcmV2ZW50ZWQgfHwgc3JjLmRlZmF1bHRQcmV2ZW50ZWQgPT09IHVuZGVmaW5lZCAmJiAvLyBTdXBwb3J0OiBBbmRyb2lkIDwgNC4wCiAgICAgIHNyYy5yZXR1cm5WYWx1ZSA9PT0gZmFsc2UgPyByZXR1cm5UcnVlIDogcmV0dXJuRmFsc2U7ICAvLyBFdmVudCB0eXBlCiAgICB9IGVsc2UgewogICAgICB0aGlzLnR5cGUgPSBzcmM7CiAgICB9CiAgICAvLyBQdXQgZXhwbGljaXRseSBwcm92aWRlZCBwcm9wZXJ0aWVzIG9udG8gdGhlIGV2ZW50IG9iamVjdAogICAgaWYgKHByb3BzKSB7CiAgICAgIGpRdWVyeS5leHRlbmQodGhpcywgcHJvcHMpOwogICAgfQogICAgLy8gQ3JlYXRlIGEgdGltZXN0YW1wIGlmIGluY29taW5nIGV2ZW50IGRvZXNuJ3QgaGF2ZSBvbmUKICAgIHRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgalF1ZXJ5Lm5vdygpOwogICAgLy8gTWFyayBpdCBhcyBmaXhlZAogICAgdGhpc1tqUXVlcnkuZXhwYW5kb10gPSB0cnVlOwogIH07CiAgLy8galF1ZXJ5LkV2ZW50IGlzIGJhc2VkIG9uIERPTTMgRXZlbnRzIGFzIHNwZWNpZmllZCBieSB0aGUgRUNNQVNjcmlwdCBMYW5ndWFnZSBCaW5kaW5nCiAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAwMy9XRC1ET00tTGV2ZWwtMy1FdmVudHMtMjAwMzAzMzEvZWNtYS1zY3JpcHQtYmluZGluZy5odG1sCiAgalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSA9IHsKICAgIGlzRGVmYXVsdFByZXZlbnRlZDogcmV0dXJuRmFsc2UsCiAgICBpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICBpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSByZXR1cm5UcnVlOwogICAgICBpZiAoZSAmJiBlLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9LAogICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwogICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKICAgICAgaWYgKGUgJiYgZS5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICB9CiAgICB9LAogICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwogICAgICB0aGlzLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKICAgICAgaWYgKGUgJiYgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24pIHsKICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICB9CiAgICAgIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB9CiAgfTsKICAvLyBDcmVhdGUgbW91c2VlbnRlci9sZWF2ZSBldmVudHMgdXNpbmcgbW91c2VvdmVyL291dCBhbmQgZXZlbnQtdGltZSBjaGVja3MKICAvLyBTdXBwb3J0OiBDaHJvbWUgMTUrCiAgalF1ZXJ5LmVhY2goewogICAgbW91c2VlbnRlcjogJ21vdXNlb3ZlcicsCiAgICBtb3VzZWxlYXZlOiAnbW91c2VvdXQnLAogICAgcG9pbnRlcmVudGVyOiAncG9pbnRlcm92ZXInLAogICAgcG9pbnRlcmxlYXZlOiAncG9pbnRlcm91dCcKICB9LCBmdW5jdGlvbiAob3JpZywgZml4KSB7CiAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbFtvcmlnXSA9IHsKICAgICAgZGVsZWdhdGVUeXBlOiBmaXgsCiAgICAgIGJpbmRUeXBlOiBmaXgsCiAgICAgIGhhbmRsZTogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIHJldCwgdGFyZ2V0ID0gdGhpcywgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQsIGhhbmRsZU9iaiA9IGV2ZW50LmhhbmRsZU9iajsKICAgICAgICAvLyBGb3IgbW91c2VudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCiAgICAgICAgLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKICAgICAgICBpZiAoIXJlbGF0ZWQgfHwgcmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFqUXVlcnkuY29udGFpbnModGFyZ2V0LCByZWxhdGVkKSkgewogICAgICAgICAgZXZlbnQudHlwZSA9IGhhbmRsZU9iai5vcmlnVHlwZTsKICAgICAgICAgIHJldCA9IGhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBldmVudC50eXBlID0gZml4OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9CiAgICB9OwogIH0pOwogIC8vIENyZWF0ZSAiYnViYmxpbmciIGZvY3VzIGFuZCBibHVyIGV2ZW50cwogIC8vIFN1cHBvcnQ6IEZpcmVmb3gsIENocm9tZSwgU2FmYXJpCiAgaWYgKCFzdXBwb3J0LmZvY3VzaW5CdWJibGVzKSB7CiAgICBqUXVlcnkuZWFjaCh7CiAgICAgIGZvY3VzOiAnZm9jdXNpbicsCiAgICAgIGJsdXI6ICdmb2N1c291dCcKICAgIH0sIGZ1bmN0aW9uIChvcmlnLCBmaXgpIHsKICAgICAgLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudCB3aGlsZSBzb21lb25lIHdhbnRzIGZvY3VzaW4vZm9jdXNvdXQKICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBqUXVlcnkuZXZlbnQuc2ltdWxhdGUoZml4LCBldmVudC50YXJnZXQsIGpRdWVyeS5ldmVudC5maXgoZXZlbnQpLCB0cnVlKTsKICAgICAgfTsKICAgICAgalF1ZXJ5LmV2ZW50LnNwZWNpYWxbZml4XSA9IHsKICAgICAgICBzZXR1cDogZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGRvYyA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLCBhdHRhY2hlcyA9IGRhdGFfcHJpdi5hY2Nlc3MoZG9jLCBmaXgpOwogICAgICAgICAgaWYgKCFhdHRhY2hlcykgewogICAgICAgICAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcihvcmlnLCBoYW5kbGVyLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGRhdGFfcHJpdi5hY2Nlc3MoZG9jLCBmaXgsIChhdHRhY2hlcyB8fCAwKSArIDEpOwogICAgICAgIH0sCiAgICAgICAgdGVhcmRvd246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcywgYXR0YWNoZXMgPSBkYXRhX3ByaXYuYWNjZXNzKGRvYywgZml4KSAtIDE7CiAgICAgICAgICBpZiAoIWF0dGFjaGVzKSB7CiAgICAgICAgICAgIGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKG9yaWcsIGhhbmRsZXIsIHRydWUpOwogICAgICAgICAgICBkYXRhX3ByaXYucmVtb3ZlKGRvYywgZml4KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRhdGFfcHJpdi5hY2Nlc3MoZG9jLCBmaXgsIGF0dGFjaGVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKICB9CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBvbjogZnVuY3Rpb24gKHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIG9uZSkgewogICAgICB2YXIgb3JpZ0ZuLCB0eXBlOwogICAgICAvLyBUeXBlcyBjYW4gYmUgYSBtYXAgb2YgdHlwZXMvaGFuZGxlcnMKICAgICAgaWYgKHR5cGVvZiB0eXBlcyA9PT0gJ29iamVjdCcpIHsKICAgICAgICAvLyAoIHR5cGVzLU9iamVjdCwgc2VsZWN0b3IsIGRhdGEgKQogICAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAvLyAoIHR5cGVzLU9iamVjdCwgZGF0YSApCiAgICAgICAgICBkYXRhID0gZGF0YSB8fCBzZWxlY3RvcjsKICAgICAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICBmb3IgKHR5cGUgaW4gdHlwZXMpIHsKICAgICAgICAgIHRoaXMub24odHlwZSwgc2VsZWN0b3IsIGRhdGEsIHR5cGVzW3R5cGVdLCBvbmUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBpZiAoZGF0YSA9PSBudWxsICYmIGZuID09IG51bGwpIHsKICAgICAgICAvLyAoIHR5cGVzLCBmbiApCiAgICAgICAgZm4gPSBzZWxlY3RvcjsKICAgICAgICBkYXRhID0gc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSBpZiAoZm4gPT0gbnVsbCkgewogICAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAvLyAoIHR5cGVzLCBzZWxlY3RvciwgZm4gKQogICAgICAgICAgZm4gPSBkYXRhOwogICAgICAgICAgZGF0YSA9IHVuZGVmaW5lZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gKCB0eXBlcywgZGF0YSwgZm4gKQogICAgICAgICAgZm4gPSBkYXRhOwogICAgICAgICAgZGF0YSA9IHNlbGVjdG9yOwogICAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmbiA9PT0gZmFsc2UpIHsKICAgICAgICBmbiA9IHJldHVybkZhbHNlOwogICAgICB9IGVsc2UgaWYgKCFmbikgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmIChvbmUgPT09IDEpIHsKICAgICAgICBvcmlnRm4gPSBmbjsKICAgICAgICBmbiA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvCiAgICAgICAgICBqUXVlcnkoKS5vZmYoZXZlbnQpOwogICAgICAgICAgcmV0dXJuIG9yaWdGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH07CiAgICAgICAgLy8gVXNlIHNhbWUgZ3VpZCBzbyBjYWxsZXIgY2FuIHJlbW92ZSB1c2luZyBvcmlnRm4KICAgICAgICBmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKG9yaWdGbi5ndWlkID0galF1ZXJ5Lmd1aWQrKyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZCh0aGlzLCB0eXBlcywgZm4sIGRhdGEsIHNlbGVjdG9yKTsKICAgICAgfSk7CiAgICB9LAogICAgb25lOiBmdW5jdGlvbiAodHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbikgewogICAgICByZXR1cm4gdGhpcy5vbih0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAxKTsKICAgIH0sCiAgICBvZmY6IGZ1bmN0aW9uICh0eXBlcywgc2VsZWN0b3IsIGZuKSB7CiAgICAgIHZhciBoYW5kbGVPYmosIHR5cGU7CiAgICAgIGlmICh0eXBlcyAmJiB0eXBlcy5wcmV2ZW50RGVmYXVsdCAmJiB0eXBlcy5oYW5kbGVPYmopIHsKICAgICAgICAvLyAoIGV2ZW50ICkgIGRpc3BhdGNoZWQgalF1ZXJ5LkV2ZW50CiAgICAgICAgaGFuZGxlT2JqID0gdHlwZXMuaGFuZGxlT2JqOwogICAgICAgIGpRdWVyeSh0eXBlcy5kZWxlZ2F0ZVRhcmdldCkub2ZmKGhhbmRsZU9iai5uYW1lc3BhY2UgPyBoYW5kbGVPYmoub3JpZ1R5cGUgKyAnLicgKyBoYW5kbGVPYmoubmFtZXNwYWNlIDogaGFuZGxlT2JqLm9yaWdUeXBlLCBoYW5kbGVPYmouc2VsZWN0b3IsIGhhbmRsZU9iai5oYW5kbGVyKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHR5cGVzID09PSAnb2JqZWN0JykgewogICAgICAgIC8vICggdHlwZXMtb2JqZWN0IFssIHNlbGVjdG9yXSApCiAgICAgICAgZm9yICh0eXBlIGluIHR5cGVzKSB7CiAgICAgICAgICB0aGlzLm9mZih0eXBlLCBzZWxlY3RvciwgdHlwZXNbdHlwZV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBpZiAoc2VsZWN0b3IgPT09IGZhbHNlIHx8IHR5cGVvZiBzZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIC8vICggdHlwZXMgWywgZm5dICkKICAgICAgICBmbiA9IHNlbGVjdG9yOwogICAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGlmIChmbiA9PT0gZmFsc2UpIHsKICAgICAgICBmbiA9IHJldHVybkZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUodGhpcywgdHlwZXMsIGZuLCBzZWxlY3Rvcik7CiAgICAgIH0pOwogICAgfSwKICAgIHRyaWdnZXI6IGZ1bmN0aW9uICh0eXBlLCBkYXRhKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKHR5cGUsIGRhdGEsIHRoaXMpOwogICAgICB9KTsKICAgIH0sCiAgICB0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgdmFyIGVsZW0gPSB0aGlzWzBdOwogICAgICBpZiAoZWxlbSkgewogICAgICAgIHJldHVybiBqUXVlcnkuZXZlbnQudHJpZ2dlcih0eXBlLCBkYXRhLCBlbGVtLCB0cnVlKTsKICAgICAgfQogICAgfQogIH0pOwogIHZhciByeGh0bWxUYWcgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbXHc6XSspW14+XSopXC8+L2dpLCBydGFnTmFtZSA9IC88KFtcdzpdKykvLCByaHRtbCA9IC88fCYjP1x3KzsvLCBybm9Jbm5lcmh0bWwgPSAvPCg/OnNjcmlwdHxzdHlsZXxsaW5rKS9pLAogICAgLy8gY2hlY2tlZD0iY2hlY2tlZCIgb3IgY2hlY2tlZAogICAgcmNoZWNrZWQgPSAvY2hlY2tlZFxzKig/OltePV18PVxzKi5jaGVja2VkLikvaSwgcnNjcmlwdFR5cGUgPSAvXiR8XC8oPzpqYXZhfGVjbWEpc2NyaXB0L2ksIHJzY3JpcHRUeXBlTWFza2VkID0gL150cnVlXC8oLiopLywgcmNsZWFuU2NyaXB0ID0gL15ccyo8ISg/OlxbQ0RBVEFcW3wtLSl8KD86XF1cXXwtLSk+XHMqJC9nLAogICAgLy8gV2UgaGF2ZSB0byBjbG9zZSB0aGVzZSB0YWdzIHRvIHN1cHBvcnQgWEhUTUwgKCMxMzIwMCkKICAgIHdyYXBNYXAgPSB7CiAgICAgIC8vIFN1cHBvcnQ6IElFIDkKICAgICAgb3B0aW9uOiBbCiAgICAgICAgMSwKICAgICAgICAnPHNlbGVjdCBtdWx0aXBsZT1cJ211bHRpcGxlXCc+JywKICAgICAgICAnPC9zZWxlY3Q+JwogICAgICBdLAogICAgICB0aGVhZDogWwogICAgICAgIDEsCiAgICAgICAgJzx0YWJsZT4nLAogICAgICAgICc8L3RhYmxlPicKICAgICAgXSwKICAgICAgY29sOiBbCiAgICAgICAgMiwKICAgICAgICAnPHRhYmxlPjxjb2xncm91cD4nLAogICAgICAgICc8L2NvbGdyb3VwPjwvdGFibGU+JwogICAgICBdLAogICAgICB0cjogWwogICAgICAgIDIsCiAgICAgICAgJzx0YWJsZT48dGJvZHk+JywKICAgICAgICAnPC90Ym9keT48L3RhYmxlPicKICAgICAgXSwKICAgICAgdGQ6IFsKICAgICAgICAzLAogICAgICAgICc8dGFibGU+PHRib2R5Pjx0cj4nLAogICAgICAgICc8L3RyPjwvdGJvZHk+PC90YWJsZT4nCiAgICAgIF0sCiAgICAgIF9kZWZhdWx0OiBbCiAgICAgICAgMCwKICAgICAgICAnJywKICAgICAgICAnJwogICAgICBdCiAgICB9OwogIC8vIFN1cHBvcnQ6IElFIDkKICB3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247CiAgd3JhcE1hcC50Ym9keSA9IHdyYXBNYXAudGZvb3QgPSB3cmFwTWFwLmNvbGdyb3VwID0gd3JhcE1hcC5jYXB0aW9uID0gd3JhcE1hcC50aGVhZDsKICB3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKICAvLyBTdXBwb3J0OiAxLnggY29tcGF0aWJpbGl0eQogIC8vIE1hbmlwdWxhdGluZyB0YWJsZXMgcmVxdWlyZXMgYSB0Ym9keQogIGZ1bmN0aW9uIG1hbmlwdWxhdGlvblRhcmdldChlbGVtLCBjb250ZW50KSB7CiAgICByZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICd0YWJsZScpICYmIGpRdWVyeS5ub2RlTmFtZShjb250ZW50Lm5vZGVUeXBlICE9PSAxMSA/IGNvbnRlbnQgOiBjb250ZW50LmZpcnN0Q2hpbGQsICd0cicpID8gZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGJvZHknKVswXSB8fCBlbGVtLmFwcGVuZENoaWxkKGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0Ym9keScpKSA6IGVsZW07CiAgfQogIC8vIFJlcGxhY2UvcmVzdG9yZSB0aGUgdHlwZSBhdHRyaWJ1dGUgb2Ygc2NyaXB0IGVsZW1lbnRzIGZvciBzYWZlIERPTSBtYW5pcHVsYXRpb24KICBmdW5jdGlvbiBkaXNhYmxlU2NyaXB0KGVsZW0pIHsKICAgIGVsZW0udHlwZSA9IChlbGVtLmdldEF0dHJpYnV0ZSgndHlwZScpICE9PSBudWxsKSArICcvJyArIGVsZW0udHlwZTsKICAgIHJldHVybiBlbGVtOwogIH0KICBmdW5jdGlvbiByZXN0b3JlU2NyaXB0KGVsZW0pIHsKICAgIHZhciBtYXRjaCA9IHJzY3JpcHRUeXBlTWFza2VkLmV4ZWMoZWxlbS50eXBlKTsKICAgIGlmIChtYXRjaCkgewogICAgICBlbGVtLnR5cGUgPSBtYXRjaFsxXTsKICAgIH0gZWxzZSB7CiAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKCd0eXBlJyk7CiAgICB9CiAgICByZXR1cm4gZWxlbTsKICB9CiAgLy8gTWFyayBzY3JpcHRzIGFzIGhhdmluZyBhbHJlYWR5IGJlZW4gZXZhbHVhdGVkCiAgZnVuY3Rpb24gc2V0R2xvYmFsRXZhbChlbGVtcywgcmVmRWxlbWVudHMpIHsKICAgIHZhciBpID0gMCwgbCA9IGVsZW1zLmxlbmd0aDsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGRhdGFfcHJpdi5zZXQoZWxlbXNbaV0sICdnbG9iYWxFdmFsJywgIXJlZkVsZW1lbnRzIHx8IGRhdGFfcHJpdi5nZXQocmVmRWxlbWVudHNbaV0sICdnbG9iYWxFdmFsJykpOwogICAgfQogIH0KICBmdW5jdGlvbiBjbG9uZUNvcHlFdmVudChzcmMsIGRlc3QpIHsKICAgIHZhciBpLCBsLCB0eXBlLCBwZGF0YU9sZCwgcGRhdGFDdXIsIHVkYXRhT2xkLCB1ZGF0YUN1ciwgZXZlbnRzOwogICAgaWYgKGRlc3Qubm9kZVR5cGUgIT09IDEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gMS4gQ29weSBwcml2YXRlIGRhdGE6IGV2ZW50cywgaGFuZGxlcnMsIGV0Yy4KICAgIGlmIChkYXRhX3ByaXYuaGFzRGF0YShzcmMpKSB7CiAgICAgIHBkYXRhT2xkID0gZGF0YV9wcml2LmFjY2VzcyhzcmMpOwogICAgICBwZGF0YUN1ciA9IGRhdGFfcHJpdi5zZXQoZGVzdCwgcGRhdGFPbGQpOwogICAgICBldmVudHMgPSBwZGF0YU9sZC5ldmVudHM7CiAgICAgIGlmIChldmVudHMpIHsKICAgICAgICBkZWxldGUgcGRhdGFDdXIuaGFuZGxlOwogICAgICAgIHBkYXRhQ3VyLmV2ZW50cyA9IHt9OwogICAgICAgIGZvciAodHlwZSBpbiBldmVudHMpIHsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBldmVudHNbdHlwZV0ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQoZGVzdCwgdHlwZSwgZXZlbnRzW3R5cGVdW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIDIuIENvcHkgdXNlciBkYXRhCiAgICBpZiAoZGF0YV91c2VyLmhhc0RhdGEoc3JjKSkgewogICAgICB1ZGF0YU9sZCA9IGRhdGFfdXNlci5hY2Nlc3Moc3JjKTsKICAgICAgdWRhdGFDdXIgPSBqUXVlcnkuZXh0ZW5kKHt9LCB1ZGF0YU9sZCk7CiAgICAgIGRhdGFfdXNlci5zZXQoZGVzdCwgdWRhdGFDdXIpOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRBbGwoY29udGV4dCwgdGFnKSB7CiAgICB2YXIgcmV0ID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSA/IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnIHx8ICcqJykgOiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwgPyBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwodGFnIHx8ICcqJykgOiBbXTsKICAgIHJldHVybiB0YWcgPT09IHVuZGVmaW5lZCB8fCB0YWcgJiYgalF1ZXJ5Lm5vZGVOYW1lKGNvbnRleHQsIHRhZykgPyBqUXVlcnkubWVyZ2UoW2NvbnRleHRdLCByZXQpIDogcmV0OwogIH0KICAvLyBTdXBwb3J0OiBJRSA+PSA5CiAgZnVuY3Rpb24gZml4SW5wdXQoc3JjLCBkZXN0KSB7CiAgICB2YXIgbm9kZU5hbWUgPSBkZXN0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAvLyBGYWlscyB0byBwZXJzaXN0IHRoZSBjaGVja2VkIHN0YXRlIG9mIGEgY2xvbmVkIGNoZWNrYm94IG9yIHJhZGlvIGJ1dHRvbi4KICAgIGlmIChub2RlTmFtZSA9PT0gJ2lucHV0JyAmJiByY2hlY2thYmxlVHlwZS50ZXN0KHNyYy50eXBlKSkgewogICAgICBkZXN0LmNoZWNrZWQgPSBzcmMuY2hlY2tlZDsgIC8vIEZhaWxzIHRvIHJldHVybiB0aGUgc2VsZWN0ZWQgb3B0aW9uIHRvIHRoZSBkZWZhdWx0IHNlbGVjdGVkIHN0YXRlIHdoZW4gY2xvbmluZyBvcHRpb25zCiAgICB9IGVsc2UgaWYgKG5vZGVOYW1lID09PSAnaW5wdXQnIHx8IG5vZGVOYW1lID09PSAndGV4dGFyZWEnKSB7CiAgICAgIGRlc3QuZGVmYXVsdFZhbHVlID0gc3JjLmRlZmF1bHRWYWx1ZTsKICAgIH0KICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBjbG9uZTogZnVuY3Rpb24gKGVsZW0sIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgIHZhciBpLCBsLCBzcmNFbGVtZW50cywgZGVzdEVsZW1lbnRzLCBjbG9uZSA9IGVsZW0uY2xvbmVOb2RlKHRydWUpLCBpblBhZ2UgPSBqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LCBlbGVtKTsKICAgICAgLy8gU3VwcG9ydDogSUUgPj0gOQogICAgICAvLyBGaXggQ2xvbmluZyBpc3N1ZXMKICAgICAgaWYgKCFzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkICYmIChlbGVtLm5vZGVUeXBlID09PSAxIHx8IGVsZW0ubm9kZVR5cGUgPT09IDExKSAmJiAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pKSB7CiAgICAgICAgLy8gV2UgZXNjaGV3IFNpenpsZSBoZXJlIGZvciBwZXJmb3JtYW5jZSByZWFzb25zOiBodHRwOi8vanNwZXJmLmNvbS9nZXRhbGwtdnMtc2l6emxlLzIKICAgICAgICBkZXN0RWxlbWVudHMgPSBnZXRBbGwoY2xvbmUpOwogICAgICAgIHNyY0VsZW1lbnRzID0gZ2V0QWxsKGVsZW0pOwogICAgICAgIGZvciAoaSA9IDAsIGwgPSBzcmNFbGVtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGZpeElucHV0KHNyY0VsZW1lbnRzW2ldLCBkZXN0RWxlbWVudHNbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBDb3B5IHRoZSBldmVudHMgZnJvbSB0aGUgb3JpZ2luYWwgdG8gdGhlIGNsb25lCiAgICAgIGlmIChkYXRhQW5kRXZlbnRzKSB7CiAgICAgICAgaWYgKGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgICAgICBzcmNFbGVtZW50cyA9IHNyY0VsZW1lbnRzIHx8IGdldEFsbChlbGVtKTsKICAgICAgICAgIGRlc3RFbGVtZW50cyA9IGRlc3RFbGVtZW50cyB8fCBnZXRBbGwoY2xvbmUpOwogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHNyY0VsZW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBjbG9uZUNvcHlFdmVudChzcmNFbGVtZW50c1tpXSwgZGVzdEVsZW1lbnRzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2xvbmVDb3B5RXZlbnQoZWxlbSwgY2xvbmUpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CiAgICAgIGRlc3RFbGVtZW50cyA9IGdldEFsbChjbG9uZSwgJ3NjcmlwdCcpOwogICAgICBpZiAoZGVzdEVsZW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICBzZXRHbG9iYWxFdmFsKGRlc3RFbGVtZW50cywgIWluUGFnZSAmJiBnZXRBbGwoZWxlbSwgJ3NjcmlwdCcpKTsKICAgICAgfQogICAgICAvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKICAgICAgcmV0dXJuIGNsb25lOwogICAgfSwKICAgIGJ1aWxkRnJhZ21lbnQ6IGZ1bmN0aW9uIChlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uKSB7CiAgICAgIHZhciBlbGVtLCB0bXAsIHRhZywgd3JhcCwgY29udGFpbnMsIGosIGZyYWdtZW50ID0gY29udGV4dC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksIG5vZGVzID0gW10sIGkgPSAwLCBsID0gZWxlbXMubGVuZ3RoOwogICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgIGVsZW0gPSBlbGVtc1tpXTsKICAgICAgICBpZiAoZWxlbSB8fCBlbGVtID09PSAwKSB7CiAgICAgICAgICAvLyBBZGQgbm9kZXMgZGlyZWN0bHkKICAgICAgICAgIGlmIChqUXVlcnkudHlwZShlbGVtKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgLy8gU3VwcG9ydDogUXRXZWJLaXQKICAgICAgICAgICAgLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwogICAgICAgICAgICBqUXVlcnkubWVyZ2Uobm9kZXMsIGVsZW0ubm9kZVR5cGUgPyBbZWxlbV0gOiBlbGVtKTsgIC8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQogICAgICAgICAgfSBlbHNlIGlmICghcmh0bWwudGVzdChlbGVtKSkgewogICAgICAgICAgICBub2Rlcy5wdXNoKGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoZWxlbSkpOyAgLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0bXAgPSB0bXAgfHwgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoY29udGV4dC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7CiAgICAgICAgICAgIC8vIERlc2VyaWFsaXplIGEgc3RhbmRhcmQgcmVwcmVzZW50YXRpb24KICAgICAgICAgICAgdGFnID0gKHJ0YWdOYW1lLmV4ZWMoZWxlbSkgfHwgWwogICAgICAgICAgICAgICcnLAogICAgICAgICAgICAgICcnCiAgICAgICAgICAgIF0pWzFdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHdyYXAgPSB3cmFwTWFwW3RhZ10gfHwgd3JhcE1hcC5fZGVmYXVsdDsKICAgICAgICAgICAgdG1wLmlubmVySFRNTCA9IHdyYXBbMV0gKyBlbGVtLnJlcGxhY2UocnhodG1sVGFnLCAnPCQxPjwvJDI+JykgKyB3cmFwWzJdOwogICAgICAgICAgICAvLyBEZXNjZW5kIHRocm91Z2ggd3JhcHBlcnMgdG8gdGhlIHJpZ2h0IGNvbnRlbnQKICAgICAgICAgICAgaiA9IHdyYXBbMF07CiAgICAgICAgICAgIHdoaWxlIChqLS0pIHsKICAgICAgICAgICAgICB0bXAgPSB0bXAubGFzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFF0V2ViS2l0CiAgICAgICAgICAgIC8vIGpRdWVyeS5tZXJnZSBiZWNhdXNlIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3MKICAgICAgICAgICAgalF1ZXJ5Lm1lcmdlKG5vZGVzLCB0bXAuY2hpbGROb2Rlcyk7CiAgICAgICAgICAgIC8vIFJlbWVtYmVyIHRoZSB0b3AtbGV2ZWwgY29udGFpbmVyCiAgICAgICAgICAgIHRtcCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIC8vIEZpeGVzICMxMjM0NgogICAgICAgICAgICAvLyBTdXBwb3J0OiBXZWJraXQsIElFCiAgICAgICAgICAgIHRtcC50ZXh0Q29udGVudCA9ICcnOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBSZW1vdmUgd3JhcHBlciBmcm9tIGZyYWdtZW50CiAgICAgIGZyYWdtZW50LnRleHRDb250ZW50ID0gJyc7CiAgICAgIGkgPSAwOwogICAgICB3aGlsZSAoZWxlbSA9IG5vZGVzW2krK10pIHsKICAgICAgICAvLyAjNDA4NyAtIElmIG9yaWdpbiBhbmQgZGVzdGluYXRpb24gZWxlbWVudHMgYXJlIHRoZSBzYW1lLCBhbmQgdGhpcyBpcwogICAgICAgIC8vIHRoYXQgZWxlbWVudCwgZG8gbm90IGRvIGFueXRoaW5nCiAgICAgICAgaWYgKHNlbGVjdGlvbiAmJiBqUXVlcnkuaW5BcnJheShlbGVtLCBzZWxlY3Rpb24pICE9PSAtMSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvbnRhaW5zID0galF1ZXJ5LmNvbnRhaW5zKGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSk7CiAgICAgICAgLy8gQXBwZW5kIHRvIGZyYWdtZW50CiAgICAgICAgdG1wID0gZ2V0QWxsKGZyYWdtZW50LmFwcGVuZENoaWxkKGVsZW0pLCAnc2NyaXB0Jyk7CiAgICAgICAgLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQogICAgICAgIGlmIChjb250YWlucykgewogICAgICAgICAgc2V0R2xvYmFsRXZhbCh0bXApOwogICAgICAgIH0KICAgICAgICAvLyBDYXB0dXJlIGV4ZWN1dGFibGVzCiAgICAgICAgaWYgKHNjcmlwdHMpIHsKICAgICAgICAgIGogPSAwOwogICAgICAgICAgd2hpbGUgKGVsZW0gPSB0bXBbaisrXSkgewogICAgICAgICAgICBpZiAocnNjcmlwdFR5cGUudGVzdChlbGVtLnR5cGUgfHwgJycpKSB7CiAgICAgICAgICAgICAgc2NyaXB0cy5wdXNoKGVsZW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmcmFnbWVudDsKICAgIH0sCiAgICBjbGVhbkRhdGE6IGZ1bmN0aW9uIChlbGVtcykgewogICAgICB2YXIgZGF0YSwgZWxlbSwgdHlwZSwga2V5LCBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWwsIGkgPSAwOwogICAgICBmb3IgKDsgKGVsZW0gPSBlbGVtc1tpXSkgIT09IHVuZGVmaW5lZDsgaSsrKSB7CiAgICAgICAgaWYgKGpRdWVyeS5hY2NlcHREYXRhKGVsZW0pKSB7CiAgICAgICAgICBrZXkgPSBlbGVtW2RhdGFfcHJpdi5leHBhbmRvXTsKICAgICAgICAgIGlmIChrZXkgJiYgKGRhdGEgPSBkYXRhX3ByaXYuY2FjaGVba2V5XSkpIHsKICAgICAgICAgICAgaWYgKGRhdGEuZXZlbnRzKSB7CiAgICAgICAgICAgICAgZm9yICh0eXBlIGluIGRhdGEuZXZlbnRzKSB7CiAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbFt0eXBlXSkgewogICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKGVsZW0sIHR5cGUpOyAgLy8gVGhpcyBpcyBhIHNob3J0Y3V0IHRvIGF2b2lkIGpRdWVyeS5ldmVudC5yZW1vdmUncyBvdmVyaGVhZAogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZUV2ZW50KGVsZW0sIHR5cGUsIGRhdGEuaGFuZGxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRhdGFfcHJpdi5jYWNoZVtrZXldKSB7CiAgICAgICAgICAgICAgLy8gRGlzY2FyZCBhbnkgcmVtYWluaW5nIGBwcml2YXRlYCBkYXRhCiAgICAgICAgICAgICAgZGVsZXRlIGRhdGFfcHJpdi5jYWNoZVtrZXldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIERpc2NhcmQgYW55IHJlbWFpbmluZyBgdXNlcmAgZGF0YQogICAgICAgIGRlbGV0ZSBkYXRhX3VzZXIuY2FjaGVbZWxlbVtkYXRhX3VzZXIuZXhwYW5kb11dOwogICAgICB9CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB0ZXh0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/IGpRdWVyeS50ZXh0KHRoaXMpIDogdGhpcy5lbXB0eSgpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgICB0aGlzLnRleHRDb250ZW50ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0sCiAgICBhcHBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGlmICh0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQodGhpcywgZWxlbSk7CiAgICAgICAgICB0YXJnZXQuYXBwZW5kQ2hpbGQoZWxlbSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBwcmVwZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSA9PT0gMSB8fCB0aGlzLm5vZGVUeXBlID09PSAxMSB8fCB0aGlzLm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KHRoaXMsIGVsZW0pOwogICAgICAgICAgdGFyZ2V0Lmluc2VydEJlZm9yZShlbGVtLCB0YXJnZXQuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBiZWZvcmU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGlmICh0aGlzLnBhcmVudE5vZGUpIHsKICAgICAgICAgIHRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZWxlbSwgdGhpcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBhZnRlcjogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgewogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZShlbGVtLCB0aGlzLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24gKHNlbGVjdG9yLCBrZWVwRGF0YSkgewogICAgICB2YXIgZWxlbSwgZWxlbXMgPSBzZWxlY3RvciA/IGpRdWVyeS5maWx0ZXIoc2VsZWN0b3IsIHRoaXMpIDogdGhpcywgaSA9IDA7CiAgICAgIGZvciAoOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICBpZiAoIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZ2V0QWxsKGVsZW0pKTsKICAgICAgICB9CiAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgaWYgKGtlZXBEYXRhICYmIGpRdWVyeS5jb250YWlucyhlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0pKSB7CiAgICAgICAgICAgIHNldEdsb2JhbEV2YWwoZ2V0QWxsKGVsZW0sICdzY3JpcHQnKSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGVtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlbGVtLCBpID0gMDsKICAgICAgZm9yICg7IChlbGVtID0gdGhpc1tpXSkgIT0gbnVsbDsgaSsrKSB7CiAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIC8vIFByZXZlbnQgbWVtb3J5IGxlYWtzCiAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbChlbGVtLCBmYWxzZSkpOwogICAgICAgICAgLy8gUmVtb3ZlIGFueSByZW1haW5pbmcgbm9kZXMKICAgICAgICAgIGVsZW0udGV4dENvbnRlbnQgPSAnJzsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uIChkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cykgewogICAgICBkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOwogICAgICBkZWVwRGF0YUFuZEV2ZW50cyA9IGRlZXBEYXRhQW5kRXZlbnRzID09IG51bGwgPyBkYXRhQW5kRXZlbnRzIDogZGVlcERhdGFBbmRFdmVudHM7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5jbG9uZSh0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyk7CiAgICAgIH0pOwogICAgfSwKICAgIGh0bWw6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHZhciBlbGVtID0gdGhpc1swXSB8fCB7fSwgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsKICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5pbm5lckhUTUw7CiAgICAgICAgfQogICAgICAgIC8vIFNlZSBpZiB3ZSBjYW4gdGFrZSBhIHNob3J0Y3V0IGFuZCBqdXN0IHVzZSBpbm5lckhUTUwKICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiAhcm5vSW5uZXJodG1sLnRlc3QodmFsdWUpICYmICF3cmFwTWFwWyhydGFnTmFtZS5leGVjKHZhbHVlKSB8fCBbCiAgICAgICAgICAgICcnLAogICAgICAgICAgICAnJwogICAgICAgICAgXSlbMV0udG9Mb3dlckNhc2UoKV0pIHsKICAgICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZShyeGh0bWxUYWcsICc8JDE+PC8kMj4nKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbaV0gfHwge307CiAgICAgICAgICAgICAgLy8gUmVtb3ZlIGVsZW1lbnQgbm9kZXMgYW5kIHByZXZlbnQgbWVtb3J5IGxlYWtzCiAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZ2V0QWxsKGVsZW0sIGZhbHNlKSk7CiAgICAgICAgICAgICAgICBlbGVtLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtID0gMDsgIC8vIElmIHVzaW5nIGlubmVySFRNTCB0aHJvd3MgYW4gZXhjZXB0aW9uLCB1c2UgdGhlIGZhbGxiYWNrIG1ldGhvZAogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZWxlbSkgewogICAgICAgICAgdGhpcy5lbXB0eSgpLmFwcGVuZCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCk7CiAgICB9LAogICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZyA9IGFyZ3VtZW50c1swXTsKICAgICAgLy8gTWFrZSB0aGUgY2hhbmdlcywgcmVwbGFjaW5nIGVhY2ggY29udGV4dCBlbGVtZW50IHdpdGggdGhlIG5ldyBjb250ZW50CiAgICAgIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGFyZyA9IHRoaXMucGFyZW50Tm9kZTsKICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbCh0aGlzKSk7CiAgICAgICAgaWYgKGFyZykgewogICAgICAgICAgYXJnLnJlcGxhY2VDaGlsZChlbGVtLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBGb3JjZSByZW1vdmFsIGlmIHRoZXJlIHdhcyBubyBuZXcgY29udGVudCAoZS5nLiwgZnJvbSBlbXB0eSBhcmd1bWVudHMpCiAgICAgIHJldHVybiBhcmcgJiYgKGFyZy5sZW5ndGggfHwgYXJnLm5vZGVUeXBlKSA/IHRoaXMgOiB0aGlzLnJlbW92ZSgpOwogICAgfSwKICAgIGRldGFjaDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLnJlbW92ZShzZWxlY3RvciwgdHJ1ZSk7CiAgICB9LAogICAgZG9tTWFuaXA6IGZ1bmN0aW9uIChhcmdzLCBjYWxsYmFjaykgewogICAgICAvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCiAgICAgIGFyZ3MgPSBjb25jYXQuYXBwbHkoW10sIGFyZ3MpOwogICAgICB2YXIgZnJhZ21lbnQsIGZpcnN0LCBzY3JpcHRzLCBoYXNTY3JpcHRzLCBub2RlLCBkb2MsIGkgPSAwLCBsID0gdGhpcy5sZW5ndGgsIHNldCA9IHRoaXMsIGlOb0Nsb25lID0gbCAtIDEsIHZhbHVlID0gYXJnc1swXSwgaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKTsKICAgICAgLy8gV2UgY2FuJ3QgY2xvbmVOb2RlIGZyYWdtZW50cyB0aGF0IGNvbnRhaW4gY2hlY2tlZCwgaW4gV2ViS2l0CiAgICAgIGlmIChpc0Z1bmN0aW9uIHx8IGwgPiAxICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgJiYgIXN1cHBvcnQuY2hlY2tDbG9uZSAmJiByY2hlY2tlZC50ZXN0KHZhbHVlKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgICB2YXIgc2VsZiA9IHNldC5lcShpbmRleCk7CiAgICAgICAgICBpZiAoaXNGdW5jdGlvbikgewogICAgICAgICAgICBhcmdzWzBdID0gdmFsdWUuY2FsbCh0aGlzLCBpbmRleCwgc2VsZi5odG1sKCkpOwogICAgICAgICAgfQogICAgICAgICAgc2VsZi5kb21NYW5pcChhcmdzLCBjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGwpIHsKICAgICAgICBmcmFnbWVudCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KGFyZ3MsIHRoaXNbMF0ub3duZXJEb2N1bWVudCwgZmFsc2UsIHRoaXMpOwogICAgICAgIGZpcnN0ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKICAgICAgICBpZiAoZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIGZyYWdtZW50ID0gZmlyc3Q7CiAgICAgICAgfQogICAgICAgIGlmIChmaXJzdCkgewogICAgICAgICAgc2NyaXB0cyA9IGpRdWVyeS5tYXAoZ2V0QWxsKGZyYWdtZW50LCAnc2NyaXB0JyksIGRpc2FibGVTY3JpcHQpOwogICAgICAgICAgaGFzU2NyaXB0cyA9IHNjcmlwdHMubGVuZ3RoOwogICAgICAgICAgLy8gVXNlIHRoZSBvcmlnaW5hbCBmcmFnbWVudCBmb3IgdGhlIGxhc3QgaXRlbSBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBiZWNhdXNlIGl0IGNhbiBlbmQgdXAKICAgICAgICAgIC8vIGJlaW5nIGVtcHRpZWQgaW5jb3JyZWN0bHkgaW4gY2VydGFpbiBzaXR1YXRpb25zICgjODA3MCkuCiAgICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBub2RlID0gZnJhZ21lbnQ7CiAgICAgICAgICAgIGlmIChpICE9PSBpTm9DbG9uZSkgewogICAgICAgICAgICAgIG5vZGUgPSBqUXVlcnkuY2xvbmUobm9kZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgLy8gS2VlcCByZWZlcmVuY2VzIHRvIGNsb25lZCBzY3JpcHRzIGZvciBsYXRlciByZXN0b3JhdGlvbgogICAgICAgICAgICAgIGlmIChoYXNTY3JpcHRzKSB7CiAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBRdFdlYktpdAogICAgICAgICAgICAgICAgLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwogICAgICAgICAgICAgICAgalF1ZXJ5Lm1lcmdlKHNjcmlwdHMsIGdldEFsbChub2RlLCAnc2NyaXB0JykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXNbaV0sIG5vZGUsIGkpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc1NjcmlwdHMpIHsKICAgICAgICAgICAgZG9jID0gc2NyaXB0c1tzY3JpcHRzLmxlbmd0aCAtIDFdLm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICAgIC8vIFJlZW5hYmxlIHNjcmlwdHMKICAgICAgICAgICAgalF1ZXJ5Lm1hcChzY3JpcHRzLCByZXN0b3JlU2NyaXB0KTsKICAgICAgICAgICAgLy8gRXZhbHVhdGUgZXhlY3V0YWJsZSBzY3JpcHRzIG9uIGZpcnN0IGRvY3VtZW50IGluc2VydGlvbgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaGFzU2NyaXB0czsgaSsrKSB7CiAgICAgICAgICAgICAgbm9kZSA9IHNjcmlwdHNbaV07CiAgICAgICAgICAgICAgaWYgKHJzY3JpcHRUeXBlLnRlc3Qobm9kZS50eXBlIHx8ICcnKSAmJiAhZGF0YV9wcml2LmFjY2Vzcyhub2RlLCAnZ2xvYmFsRXZhbCcpICYmIGpRdWVyeS5jb250YWlucyhkb2MsIG5vZGUpKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5zcmMpIHsKICAgICAgICAgICAgICAgICAgLy8gT3B0aW9uYWwgQUpBWCBkZXBlbmRlbmN5LCBidXQgd29uJ3QgcnVuIHNjcmlwdHMgaWYgbm90IHByZXNlbnQKICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5fZXZhbFVybCkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5fZXZhbFVybChub2RlLnNyYyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGpRdWVyeS5nbG9iYWxFdmFsKG5vZGUudGV4dENvbnRlbnQucmVwbGFjZShyY2xlYW5TY3JpcHQsICcnKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKHsKICAgIGFwcGVuZFRvOiAnYXBwZW5kJywKICAgIHByZXBlbmRUbzogJ3ByZXBlbmQnLAogICAgaW5zZXJ0QmVmb3JlOiAnYmVmb3JlJywKICAgIGluc2VydEFmdGVyOiAnYWZ0ZXInLAogICAgcmVwbGFjZUFsbDogJ3JlcGxhY2VXaXRoJwogIH0sIGZ1bmN0aW9uIChuYW1lLCBvcmlnaW5hbCkgewogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHZhciBlbGVtcywgcmV0ID0gW10sIGluc2VydCA9IGpRdWVyeShzZWxlY3RvciksIGxhc3QgPSBpbnNlcnQubGVuZ3RoIC0gMSwgaSA9IDA7CiAgICAgIGZvciAoOyBpIDw9IGxhc3Q7IGkrKykgewogICAgICAgIGVsZW1zID0gaSA9PT0gbGFzdCA/IHRoaXMgOiB0aGlzLmNsb25lKHRydWUpOwogICAgICAgIGpRdWVyeShpbnNlcnRbaV0pW29yaWdpbmFsXShlbGVtcyk7CiAgICAgICAgLy8gU3VwcG9ydDogUXRXZWJLaXQKICAgICAgICAvLyAuZ2V0KCkgYmVjYXVzZSBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzCiAgICAgICAgcHVzaC5hcHBseShyZXQsIGVsZW1zLmdldCgpKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2socmV0KTsKICAgIH07CiAgfSk7CiAgdmFyIGlmcmFtZSwgZWxlbWRpc3BsYXkgPSB7fTsKICAvKioKICAgKiBSZXRyaWV2ZSB0aGUgYWN0dWFsIGRpc3BsYXkgb2YgYSBlbGVtZW50CiAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgbm9kZU5hbWUgb2YgdGhlIGVsZW1lbnQKICAgKiBAcGFyYW0ge09iamVjdH0gZG9jIERvY3VtZW50IG9iamVjdAogICAqLwogIC8vIENhbGxlZCBvbmx5IGZyb20gd2l0aGluIGRlZmF1bHREaXNwbGF5CiAgZnVuY3Rpb24gYWN0dWFsRGlzcGxheShuYW1lLCBkb2MpIHsKICAgIHZhciBzdHlsZSwgZWxlbSA9IGpRdWVyeShkb2MuY3JlYXRlRWxlbWVudChuYW1lKSkuYXBwZW5kVG8oZG9jLmJvZHkpLAogICAgICAvLyBnZXREZWZhdWx0Q29tcHV0ZWRTdHlsZSBtaWdodCBiZSByZWxpYWJseSB1c2VkIG9ubHkgb24gYXR0YWNoZWQgZWxlbWVudAogICAgICBkaXNwbGF5ID0gd2luZG93LmdldERlZmF1bHRDb21wdXRlZFN0eWxlICYmIChzdHlsZSA9IHdpbmRvdy5nZXREZWZhdWx0Q29tcHV0ZWRTdHlsZShlbGVtWzBdKSkgPyAvLyBVc2Ugb2YgdGhpcyBtZXRob2QgaXMgYSB0ZW1wb3JhcnkgZml4IChtb3JlIGxpa2Ugb3B0bWl6YXRpb24pIHVudGlsIHNvbWV0aGluZyBiZXR0ZXIgY29tZXMgYWxvbmcsCiAgICAgIC8vIHNpbmNlIGl0IHdhcyByZW1vdmVkIGZyb20gc3BlY2lmaWNhdGlvbiBhbmQgc3VwcG9ydGVkIG9ubHkgaW4gRkYKICAgICAgc3R5bGUuZGlzcGxheSA6IGpRdWVyeS5jc3MoZWxlbVswXSwgJ2Rpc3BsYXknKTsKICAgIC8vIFdlIGRvbid0IGhhdmUgYW55IGRhdGEgc3RvcmVkIG9uIHRoZSBlbGVtZW50LAogICAgLy8gc28gdXNlICJkZXRhY2giIG1ldGhvZCBhcyBmYXN0IHdheSB0byBnZXQgcmlkIG9mIHRoZSBlbGVtZW50CiAgICBlbGVtLmRldGFjaCgpOwogICAgcmV0dXJuIGRpc3BsYXk7CiAgfQogIC8qKgogICAqIFRyeSB0byBkZXRlcm1pbmUgdGhlIGRlZmF1bHQgZGlzcGxheSB2YWx1ZSBvZiBhbiBlbGVtZW50CiAgICogQHBhcmFtIHtTdHJpbmd9IG5vZGVOYW1lCiAgICovCiAgZnVuY3Rpb24gZGVmYXVsdERpc3BsYXkobm9kZU5hbWUpIHsKICAgIHZhciBkb2MgPSBkb2N1bWVudCwgZGlzcGxheSA9IGVsZW1kaXNwbGF5W25vZGVOYW1lXTsKICAgIGlmICghZGlzcGxheSkgewogICAgICBkaXNwbGF5ID0gYWN0dWFsRGlzcGxheShub2RlTmFtZSwgZG9jKTsKICAgICAgLy8gSWYgdGhlIHNpbXBsZSB3YXkgZmFpbHMsIHJlYWQgZnJvbSBpbnNpZGUgYW4gaWZyYW1lCiAgICAgIGlmIChkaXNwbGF5ID09PSAnbm9uZScgfHwgIWRpc3BsYXkpIHsKICAgICAgICAvLyBVc2UgdGhlIGFscmVhZHktY3JlYXRlZCBpZnJhbWUgaWYgcG9zc2libGUKICAgICAgICBpZnJhbWUgPSAoaWZyYW1lIHx8IGpRdWVyeSgnPGlmcmFtZSBmcmFtZWJvcmRlcj1cJzBcJyB3aWR0aD1cJzBcJyBoZWlnaHQ9XCcwXCcvPicpKS5hcHBlbmRUbyhkb2MuZG9jdW1lbnRFbGVtZW50KTsKICAgICAgICAvLyBBbHdheXMgd3JpdGUgYSBuZXcgSFRNTCBza2VsZXRvbiBzbyBXZWJraXQgYW5kIEZpcmVmb3ggZG9uJ3QgY2hva2Ugb24gcmV1c2UKICAgICAgICBkb2MgPSBpZnJhbWVbMF0uY29udGVudERvY3VtZW50OwogICAgICAgIC8vIFN1cHBvcnQ6IElFCiAgICAgICAgZG9jLndyaXRlKCk7CiAgICAgICAgZG9jLmNsb3NlKCk7CiAgICAgICAgZGlzcGxheSA9IGFjdHVhbERpc3BsYXkobm9kZU5hbWUsIGRvYyk7CiAgICAgICAgaWZyYW1lLmRldGFjaCgpOwogICAgICB9CiAgICAgIC8vIFN0b3JlIHRoZSBjb3JyZWN0IGRlZmF1bHQgZGlzcGxheQogICAgICBlbGVtZGlzcGxheVtub2RlTmFtZV0gPSBkaXNwbGF5OwogICAgfQogICAgcmV0dXJuIGRpc3BsYXk7CiAgfQogIHZhciBybWFyZ2luID0gL15tYXJnaW4vOwogIHZhciBybnVtbm9ucHggPSBuZXcgUmVnRXhwKCdeKCcgKyBwbnVtICsgJykoPyFweClbYS16JV0rJCcsICdpJyk7CiAgdmFyIGdldFN0eWxlcyA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICByZXR1cm4gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbSwgbnVsbCk7CiAgfTsKICBmdW5jdGlvbiBjdXJDU1MoZWxlbSwgbmFtZSwgY29tcHV0ZWQpIHsKICAgIHZhciB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLCByZXQsIHN0eWxlID0gZWxlbS5zdHlsZTsKICAgIGNvbXB1dGVkID0gY29tcHV0ZWQgfHwgZ2V0U3R5bGVzKGVsZW0pOwogICAgLy8gU3VwcG9ydDogSUU5CiAgICAvLyBnZXRQcm9wZXJ0eVZhbHVlIGlzIG9ubHkgbmVlZGVkIGZvciAuY3NzKCdmaWx0ZXInKSBpbiBJRTksIHNlZSAjMTI1MzcKICAgIGlmIChjb21wdXRlZCkgewogICAgICByZXQgPSBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKG5hbWUpIHx8IGNvbXB1dGVkW25hbWVdOwogICAgfQogICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgIGlmIChyZXQgPT09ICcnICYmICFqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LCBlbGVtKSkgewogICAgICAgIHJldCA9IGpRdWVyeS5zdHlsZShlbGVtLCBuYW1lKTsKICAgICAgfQogICAgICAvLyBTdXBwb3J0OiBpT1MgPCA2CiAgICAgIC8vIEEgdHJpYnV0ZSB0byB0aGUgImF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMiCiAgICAgIC8vIGlPUyA8IDYgKGF0IGxlYXN0KSByZXR1cm5zIHBlcmNlbnRhZ2UgZm9yIGEgbGFyZ2VyIHNldCBvZiB2YWx1ZXMsIGJ1dCB3aWR0aCBzZWVtcyB0byBiZSByZWxpYWJseSBwaXhlbHMKICAgICAgLy8gdGhpcyBpcyBhZ2FpbnN0IHRoZSBDU1NPTSBkcmFmdCBzcGVjOiBodHRwOi8vZGV2LnczLm9yZy9jc3N3Zy9jc3NvbS8jcmVzb2x2ZWQtdmFsdWVzCiAgICAgIGlmIChybnVtbm9ucHgudGVzdChyZXQpICYmIHJtYXJnaW4udGVzdChuYW1lKSkgewogICAgICAgIC8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKICAgICAgICB3aWR0aCA9IHN0eWxlLndpZHRoOwogICAgICAgIG1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CiAgICAgICAgbWF4V2lkdGggPSBzdHlsZS5tYXhXaWR0aDsKICAgICAgICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgICAgICAgc3R5bGUubWluV2lkdGggPSBzdHlsZS5tYXhXaWR0aCA9IHN0eWxlLndpZHRoID0gcmV0OwogICAgICAgIHJldCA9IGNvbXB1dGVkLndpZHRoOwogICAgICAgIC8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMKICAgICAgICBzdHlsZS53aWR0aCA9IHdpZHRoOwogICAgICAgIHN0eWxlLm1pbldpZHRoID0gbWluV2lkdGg7CiAgICAgICAgc3R5bGUubWF4V2lkdGggPSBtYXhXaWR0aDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJldCAhPT0gdW5kZWZpbmVkID8gLy8gU3VwcG9ydDogSUUKICAgIC8vIElFIHJldHVybnMgekluZGV4IHZhbHVlIGFzIGFuIGludGVnZXIuCiAgICByZXQgKyAnJyA6IHJldDsKICB9CiAgZnVuY3Rpb24gYWRkR2V0SG9va0lmKGNvbmRpdGlvbkZuLCBob29rRm4pIHsKICAgIC8vIERlZmluZSB0aGUgaG9vaywgd2UnbGwgY2hlY2sgb24gdGhlIGZpcnN0IHJ1biBpZiBpdCdzIHJlYWxseSBuZWVkZWQuCiAgICByZXR1cm4gewogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoY29uZGl0aW9uRm4oKSkgewogICAgICAgICAgLy8gSG9vayBub3QgbmVlZGVkIChvciBpdCdzIG5vdCBwb3NzaWJsZSB0byB1c2UgaXQgZHVlIHRvIG1pc3NpbmcgZGVwZW5kZW5jeSksCiAgICAgICAgICAvLyByZW1vdmUgaXQuCiAgICAgICAgICAvLyBTaW5jZSB0aGVyZSBhcmUgbm8gb3RoZXIgaG9va3MgZm9yIG1hcmdpblJpZ2h0LCByZW1vdmUgdGhlIHdob2xlIG9iamVjdC4KICAgICAgICAgIGRlbGV0ZSB0aGlzLmdldDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gSG9vayBuZWVkZWQ7IHJlZGVmaW5lIGl0IHNvIHRoYXQgdGhlIHN1cHBvcnQgdGVzdCBpcyBub3QgZXhlY3V0ZWQgYWdhaW4uCiAgICAgICAgcmV0dXJuICh0aGlzLmdldCA9IGhvb2tGbikuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9CiAgKGZ1bmN0aW9uICgpIHsKICAgIHZhciBwaXhlbFBvc2l0aW9uVmFsLCBib3hTaXppbmdSZWxpYWJsZVZhbCwgZG9jRWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgaWYgKCFkaXYuc3R5bGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID0gJ2NvbnRlbnQtYm94JzsKICAgIGRpdi5jbG9uZU5vZGUodHJ1ZSkuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAnJzsKICAgIHN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlID0gZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID09PSAnY29udGVudC1ib3gnOwogICAgY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAnYm9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDt0b3A6MDtsZWZ0Oi05OTk5cHg7bWFyZ2luLXRvcDoxcHg7JyArICdwb3NpdGlvbjphYnNvbHV0ZSc7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZGl2KTsKICAgIC8vIEV4ZWN1dGluZyBib3RoIHBpeGVsUG9zaXRpb24gJiBib3hTaXppbmdSZWxpYWJsZSB0ZXN0cyByZXF1aXJlIG9ubHkgb25lIGxheW91dAogICAgLy8gc28gdGhleSdyZSBleGVjdXRlZCBhdCB0aGUgc2FtZSB0aW1lIHRvIHNhdmUgdGhlIHNlY29uZCBjb21wdXRhdGlvbi4KICAgIGZ1bmN0aW9uIGNvbXB1dGVQaXhlbFBvc2l0aW9uQW5kQm94U2l6aW5nUmVsaWFibGUoKSB7CiAgICAgIGRpdi5zdHlsZS5jc3NUZXh0ID0gLy8gU3VwcG9ydDogRmlyZWZveDwyOSwgQW5kcm9pZCAyLjMKICAgICAgLy8gVmVuZG9yLXByZWZpeCBib3gtc2l6aW5nCiAgICAgICctd2Via2l0LWJveC1zaXppbmc6Ym9yZGVyLWJveDstbW96LWJveC1zaXppbmc6Ym9yZGVyLWJveDsnICsgJ2JveC1zaXppbmc6Ym9yZGVyLWJveDtkaXNwbGF5OmJsb2NrO21hcmdpbi10b3A6MSU7dG9wOjElOycgKyAnYm9yZGVyOjFweDtwYWRkaW5nOjFweDt3aWR0aDo0cHg7cG9zaXRpb246YWJzb2x1dGUnOwogICAgICBkaXYuaW5uZXJIVE1MID0gJyc7CiAgICAgIGRvY0VsZW0uYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKICAgICAgdmFyIGRpdlN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZGl2LCBudWxsKTsKICAgICAgcGl4ZWxQb3NpdGlvblZhbCA9IGRpdlN0eWxlLnRvcCAhPT0gJzElJzsKICAgICAgYm94U2l6aW5nUmVsaWFibGVWYWwgPSBkaXZTdHlsZS53aWR0aCA9PT0gJzRweCc7CiAgICAgIGRvY0VsZW0ucmVtb3ZlQ2hpbGQoY29udGFpbmVyKTsKICAgIH0KICAgIC8vIFN1cHBvcnQ6IG5vZGUuanMganNkb20KICAgIC8vIERvbid0IGFzc3VtZSB0aGF0IGdldENvbXB1dGVkU3R5bGUgaXMgYSBwcm9wZXJ0eSBvZiB0aGUgZ2xvYmFsIG9iamVjdAogICAgaWYgKHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgIGpRdWVyeS5leHRlbmQoc3VwcG9ydCwgewogICAgICAgIHBpeGVsUG9zaXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIFRoaXMgdGVzdCBpcyBleGVjdXRlZCBvbmx5IG9uY2UgYnV0IHdlIHN0aWxsIGRvIG1lbW9pemluZwogICAgICAgICAgLy8gc2luY2Ugd2UgY2FuIHVzZSB0aGUgYm94U2l6aW5nUmVsaWFibGUgcHJlLWNvbXB1dGluZy4KICAgICAgICAgIC8vIE5vIG5lZWQgdG8gY2hlY2sgaWYgdGhlIHRlc3Qgd2FzIGFscmVhZHkgcGVyZm9ybWVkLCB0aG91Z2guCiAgICAgICAgICBjb21wdXRlUGl4ZWxQb3NpdGlvbkFuZEJveFNpemluZ1JlbGlhYmxlKCk7CiAgICAgICAgICByZXR1cm4gcGl4ZWxQb3NpdGlvblZhbDsKICAgICAgICB9LAogICAgICAgIGJveFNpemluZ1JlbGlhYmxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoYm94U2l6aW5nUmVsaWFibGVWYWwgPT0gbnVsbCkgewogICAgICAgICAgICBjb21wdXRlUGl4ZWxQb3NpdGlvbkFuZEJveFNpemluZ1JlbGlhYmxlKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYm94U2l6aW5nUmVsaWFibGVWYWw7CiAgICAgICAgfSwKICAgICAgICByZWxpYWJsZU1hcmdpblJpZ2h0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDIuMwogICAgICAgICAgLy8gQ2hlY2sgaWYgZGl2IHdpdGggZXhwbGljaXQgd2lkdGggYW5kIG5vIG1hcmdpbi1yaWdodCBpbmNvcnJlY3RseQogICAgICAgICAgLy8gZ2V0cyBjb21wdXRlZCBtYXJnaW4tcmlnaHQgYmFzZWQgb24gd2lkdGggb2YgY29udGFpbmVyLiAoIzMzMzMpCiAgICAgICAgICAvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKICAgICAgICAgIC8vIFRoaXMgc3VwcG9ydCBmdW5jdGlvbiBpcyBvbmx5IGV4ZWN1dGVkIG9uY2Ugc28gbm8gbWVtb2l6aW5nIGlzIG5lZWRlZC4KICAgICAgICAgIHZhciByZXQsIG1hcmdpbkRpdiA9IGRpdi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7CiAgICAgICAgICAvLyBSZXNldCBDU1M6IGJveC1zaXppbmc7IGRpc3BsYXk7IG1hcmdpbjsgYm9yZGVyOyBwYWRkaW5nCiAgICAgICAgICBtYXJnaW5EaXYuc3R5bGUuY3NzVGV4dCA9IGRpdi5zdHlsZS5jc3NUZXh0ID0gLy8gU3VwcG9ydDogRmlyZWZveDwyOSwgQW5kcm9pZCAyLjMKICAgICAgICAgIC8vIFZlbmRvci1wcmVmaXggYm94LXNpemluZwogICAgICAgICAgJy13ZWJraXQtYm94LXNpemluZzpjb250ZW50LWJveDstbW96LWJveC1zaXppbmc6Y29udGVudC1ib3g7JyArICdib3gtc2l6aW5nOmNvbnRlbnQtYm94O2Rpc3BsYXk6YmxvY2s7bWFyZ2luOjA7Ym9yZGVyOjA7cGFkZGluZzowJzsKICAgICAgICAgIG1hcmdpbkRpdi5zdHlsZS5tYXJnaW5SaWdodCA9IG1hcmdpbkRpdi5zdHlsZS53aWR0aCA9ICcwJzsKICAgICAgICAgIGRpdi5zdHlsZS53aWR0aCA9ICcxcHgnOwogICAgICAgICAgZG9jRWxlbS5hcHBlbmRDaGlsZChjb250YWluZXIpOwogICAgICAgICAgcmV0ID0gIXBhcnNlRmxvYXQod2luZG93LmdldENvbXB1dGVkU3R5bGUobWFyZ2luRGl2LCBudWxsKS5tYXJnaW5SaWdodCk7CiAgICAgICAgICBkb2NFbGVtLnJlbW92ZUNoaWxkKGNvbnRhaW5lcik7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSgpKTsKICAvLyBBIG1ldGhvZCBmb3IgcXVpY2tseSBzd2FwcGluZyBpbi9vdXQgQ1NTIHByb3BlcnRpZXMgdG8gZ2V0IGNvcnJlY3QgY2FsY3VsYXRpb25zLgogIGpRdWVyeS5zd2FwID0gZnVuY3Rpb24gKGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrLCBhcmdzKSB7CiAgICB2YXIgcmV0LCBuYW1lLCBvbGQgPSB7fTsKICAgIC8vIFJlbWVtYmVyIHRoZSBvbGQgdmFsdWVzLCBhbmQgaW5zZXJ0IHRoZSBuZXcgb25lcwogICAgZm9yIChuYW1lIGluIG9wdGlvbnMpIHsKICAgICAgb2xkW25hbWVdID0gZWxlbS5zdHlsZVtuYW1lXTsKICAgICAgZWxlbS5zdHlsZVtuYW1lXSA9IG9wdGlvbnNbbmFtZV07CiAgICB9CiAgICByZXQgPSBjYWxsYmFjay5hcHBseShlbGVtLCBhcmdzIHx8IFtdKTsKICAgIC8vIFJldmVydCB0aGUgb2xkIHZhbHVlcwogICAgZm9yIChuYW1lIGluIG9wdGlvbnMpIHsKICAgICAgZWxlbS5zdHlsZVtuYW1lXSA9IG9sZFtuYW1lXTsKICAgIH0KICAgIHJldHVybiByZXQ7CiAgfTsKICB2YXIKICAgIC8vIHN3YXBwYWJsZSBpZiBkaXNwbGF5IGlzIG5vbmUgb3Igc3RhcnRzIHdpdGggdGFibGUgZXhjZXB0ICJ0YWJsZSIsICJ0YWJsZS1jZWxsIiwgb3IgInRhYmxlLWNhcHRpb24iCiAgICAvLyBzZWUgaGVyZSBmb3IgZGlzcGxheSB2YWx1ZXM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvQ1NTL2Rpc3BsYXkKICAgIHJkaXNwbGF5c3dhcCA9IC9eKG5vbmV8dGFibGUoPyEtY1tlYV0pLispLywgcm51bXNwbGl0ID0gbmV3IFJlZ0V4cCgnXignICsgcG51bSArICcpKC4qKSQnLCAnaScpLCBycmVsTnVtID0gbmV3IFJlZ0V4cCgnXihbKy1dKT0oJyArIHBudW0gKyAnKScsICdpJyksIGNzc1Nob3cgPSB7CiAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICB2aXNpYmlsaXR5OiAnaGlkZGVuJywKICAgICAgZGlzcGxheTogJ2Jsb2NrJwogICAgfSwgY3NzTm9ybWFsVHJhbnNmb3JtID0gewogICAgICBsZXR0ZXJTcGFjaW5nOiAnMCcsCiAgICAgIGZvbnRXZWlnaHQ6ICc0MDAnCiAgICB9LCBjc3NQcmVmaXhlcyA9IFsKICAgICAgJ1dlYmtpdCcsCiAgICAgICdPJywKICAgICAgJ01veicsCiAgICAgICdtcycKICAgIF07CiAgLy8gcmV0dXJuIGEgY3NzIHByb3BlcnR5IG1hcHBlZCB0byBhIHBvdGVudGlhbGx5IHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQogIGZ1bmN0aW9uIHZlbmRvclByb3BOYW1lKHN0eWxlLCBuYW1lKSB7CiAgICAvLyBzaG9ydGN1dCBmb3IgbmFtZXMgdGhhdCBhcmUgbm90IHZlbmRvciBwcmVmaXhlZAogICAgaWYgKG5hbWUgaW4gc3R5bGUpIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgICAvLyBjaGVjayBmb3IgdmVuZG9yIHByZWZpeGVkIG5hbWVzCiAgICB2YXIgY2FwTmFtZSA9IG5hbWVbMF0udG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSksIG9yaWdOYW1lID0gbmFtZSwgaSA9IGNzc1ByZWZpeGVzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgbmFtZSA9IGNzc1ByZWZpeGVzW2ldICsgY2FwTmFtZTsKICAgICAgaWYgKG5hbWUgaW4gc3R5bGUpIHsKICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9yaWdOYW1lOwogIH0KICBmdW5jdGlvbiBzZXRQb3NpdGl2ZU51bWJlcihlbGVtLCB2YWx1ZSwgc3VidHJhY3QpIHsKICAgIHZhciBtYXRjaGVzID0gcm51bXNwbGl0LmV4ZWModmFsdWUpOwogICAgcmV0dXJuIG1hdGNoZXMgPyAvLyBHdWFyZCBhZ2FpbnN0IHVuZGVmaW5lZCAic3VidHJhY3QiLCBlLmcuLCB3aGVuIHVzZWQgYXMgaW4gY3NzSG9va3MKICAgIE1hdGgubWF4KDAsIG1hdGNoZXNbMV0gLSAoc3VidHJhY3QgfHwgMCkpICsgKG1hdGNoZXNbMl0gfHwgJ3B4JykgOiB2YWx1ZTsKICB9CiAgZnVuY3Rpb24gYXVnbWVudFdpZHRoT3JIZWlnaHQoZWxlbSwgbmFtZSwgZXh0cmEsIGlzQm9yZGVyQm94LCBzdHlsZXMpIHsKICAgIHZhciBpID0gZXh0cmEgPT09IChpc0JvcmRlckJveCA/ICdib3JkZXInIDogJ2NvbnRlbnQnKSA/IC8vIElmIHdlIGFscmVhZHkgaGF2ZSB0aGUgcmlnaHQgbWVhc3VyZW1lbnQsIGF2b2lkIGF1Z21lbnRhdGlvbgogICAgICA0IDogLy8gT3RoZXJ3aXNlIGluaXRpYWxpemUgZm9yIGhvcml6b250YWwgb3IgdmVydGljYWwgcHJvcGVydGllcwogICAgICBuYW1lID09PSAnd2lkdGgnID8gMSA6IDAsIHZhbCA9IDA7CiAgICBmb3IgKDsgaSA8IDQ7IGkgKz0gMikgewogICAgICAvLyBib3RoIGJveCBtb2RlbHMgZXhjbHVkZSBtYXJnaW4sIHNvIGFkZCBpdCBpZiB3ZSB3YW50IGl0CiAgICAgIGlmIChleHRyYSA9PT0gJ21hcmdpbicpIHsKICAgICAgICB2YWwgKz0galF1ZXJ5LmNzcyhlbGVtLCBleHRyYSArIGNzc0V4cGFuZFtpXSwgdHJ1ZSwgc3R5bGVzKTsKICAgICAgfQogICAgICBpZiAoaXNCb3JkZXJCb3gpIHsKICAgICAgICAvLyBib3JkZXItYm94IGluY2x1ZGVzIHBhZGRpbmcsIHNvIHJlbW92ZSBpdCBpZiB3ZSB3YW50IGNvbnRlbnQKICAgICAgICBpZiAoZXh0cmEgPT09ICdjb250ZW50JykgewogICAgICAgICAgdmFsIC09IGpRdWVyeS5jc3MoZWxlbSwgJ3BhZGRpbmcnICsgY3NzRXhwYW5kW2ldLCB0cnVlLCBzdHlsZXMpOwogICAgICAgIH0KICAgICAgICAvLyBhdCB0aGlzIHBvaW50LCBleHRyYSBpc24ndCBib3JkZXIgbm9yIG1hcmdpbiwgc28gcmVtb3ZlIGJvcmRlcgogICAgICAgIGlmIChleHRyYSAhPT0gJ21hcmdpbicpIHsKICAgICAgICAgIHZhbCAtPSBqUXVlcnkuY3NzKGVsZW0sICdib3JkZXInICsgY3NzRXhwYW5kW2ldICsgJ1dpZHRoJywgdHJ1ZSwgc3R5bGVzKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCwgc28gYWRkIHBhZGRpbmcKICAgICAgICB2YWwgKz0galF1ZXJ5LmNzcyhlbGVtLCAncGFkZGluZycgKyBjc3NFeHBhbmRbaV0sIHRydWUsIHN0eWxlcyk7CiAgICAgICAgLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCBub3IgcGFkZGluZywgc28gYWRkIGJvcmRlcgogICAgICAgIGlmIChleHRyYSAhPT0gJ3BhZGRpbmcnKSB7CiAgICAgICAgICB2YWwgKz0galF1ZXJ5LmNzcyhlbGVtLCAnYm9yZGVyJyArIGNzc0V4cGFuZFtpXSArICdXaWR0aCcsIHRydWUsIHN0eWxlcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdmFsOwogIH0KICBmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KGVsZW0sIG5hbWUsIGV4dHJhKSB7CiAgICAvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQogICAgdmFyIHZhbHVlSXNCb3JkZXJCb3ggPSB0cnVlLCB2YWwgPSBuYW1lID09PSAnd2lkdGgnID8gZWxlbS5vZmZzZXRXaWR0aCA6IGVsZW0ub2Zmc2V0SGVpZ2h0LCBzdHlsZXMgPSBnZXRTdHlsZXMoZWxlbSksIGlzQm9yZGVyQm94ID0galF1ZXJ5LmNzcyhlbGVtLCAnYm94U2l6aW5nJywgZmFsc2UsIHN0eWxlcykgPT09ICdib3JkZXItYm94JzsKICAgIC8vIHNvbWUgbm9uLWh0bWwgZWxlbWVudHMgcmV0dXJuIHVuZGVmaW5lZCBmb3Igb2Zmc2V0V2lkdGgsIHNvIGNoZWNrIGZvciBudWxsL3VuZGVmaW5lZAogICAgLy8gc3ZnIC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjQ5Mjg1CiAgICAvLyBNYXRoTUwgLSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD00OTE2NjgKICAgIGlmICh2YWwgPD0gMCB8fCB2YWwgPT0gbnVsbCkgewogICAgICAvLyBGYWxsIGJhY2sgdG8gY29tcHV0ZWQgdGhlbiB1bmNvbXB1dGVkIGNzcyBpZiBuZWNlc3NhcnkKICAgICAgdmFsID0gY3VyQ1NTKGVsZW0sIG5hbWUsIHN0eWxlcyk7CiAgICAgIGlmICh2YWwgPCAwIHx8IHZhbCA9PSBudWxsKSB7CiAgICAgICAgdmFsID0gZWxlbS5zdHlsZVtuYW1lXTsKICAgICAgfQogICAgICAvLyBDb21wdXRlZCB1bml0IGlzIG5vdCBwaXhlbHMuIFN0b3AgaGVyZSBhbmQgcmV0dXJuLgogICAgICBpZiAocm51bW5vbnB4LnRlc3QodmFsKSkgewogICAgICAgIHJldHVybiB2YWw7CiAgICAgIH0KICAgICAgLy8gd2UgbmVlZCB0aGUgY2hlY2sgZm9yIHN0eWxlIGluIGNhc2UgYSBicm93c2VyIHdoaWNoIHJldHVybnMgdW5yZWxpYWJsZSB2YWx1ZXMKICAgICAgLy8gZm9yIGdldENvbXB1dGVkU3R5bGUgc2lsZW50bHkgZmFsbHMgYmFjayB0byB0aGUgcmVsaWFibGUgZWxlbS5zdHlsZQogICAgICB2YWx1ZUlzQm9yZGVyQm94ID0gaXNCb3JkZXJCb3ggJiYgKHN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUoKSB8fCB2YWwgPT09IGVsZW0uc3R5bGVbbmFtZV0pOwogICAgICAvLyBOb3JtYWxpemUgIiIsIGF1dG8sIGFuZCBwcmVwYXJlIGZvciBleHRyYQogICAgICB2YWwgPSBwYXJzZUZsb2F0KHZhbCkgfHwgMDsKICAgIH0KICAgIC8vIHVzZSB0aGUgYWN0aXZlIGJveC1zaXppbmcgbW9kZWwgdG8gYWRkL3N1YnRyYWN0IGlycmVsZXZhbnQgc3R5bGVzCiAgICByZXR1cm4gdmFsICsgYXVnbWVudFdpZHRoT3JIZWlnaHQoZWxlbSwgbmFtZSwgZXh0cmEgfHwgKGlzQm9yZGVyQm94ID8gJ2JvcmRlcicgOiAnY29udGVudCcpLCB2YWx1ZUlzQm9yZGVyQm94LCBzdHlsZXMpICsgJ3B4JzsKICB9CiAgZnVuY3Rpb24gc2hvd0hpZGUoZWxlbWVudHMsIHNob3cpIHsKICAgIHZhciBkaXNwbGF5LCBlbGVtLCBoaWRkZW4sIHZhbHVlcyA9IFtdLCBpbmRleCA9IDAsIGxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBlbGVtID0gZWxlbWVudHNbaW5kZXhdOwogICAgICBpZiAoIWVsZW0uc3R5bGUpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICB2YWx1ZXNbaW5kZXhdID0gZGF0YV9wcml2LmdldChlbGVtLCAnb2xkZGlzcGxheScpOwogICAgICBkaXNwbGF5ID0gZWxlbS5zdHlsZS5kaXNwbGF5OwogICAgICBpZiAoc2hvdykgewogICAgICAgIC8vIFJlc2V0IHRoZSBpbmxpbmUgZGlzcGxheSBvZiB0aGlzIGVsZW1lbnQgdG8gbGVhcm4gaWYgaXQgaXMKICAgICAgICAvLyBiZWluZyBoaWRkZW4gYnkgY2FzY2FkZWQgcnVsZXMgb3Igbm90CiAgICAgICAgaWYgKCF2YWx1ZXNbaW5kZXhdICYmIGRpc3BsYXkgPT09ICdub25lJykgewogICAgICAgICAgZWxlbS5zdHlsZS5kaXNwbGF5ID0gJyc7CiAgICAgICAgfQogICAgICAgIC8vIFNldCBlbGVtZW50cyB3aGljaCBoYXZlIGJlZW4gb3ZlcnJpZGRlbiB3aXRoIGRpc3BsYXk6IG5vbmUKICAgICAgICAvLyBpbiBhIHN0eWxlc2hlZXQgdG8gd2hhdGV2ZXIgdGhlIGRlZmF1bHQgYnJvd3NlciBzdHlsZSBpcwogICAgICAgIC8vIGZvciBzdWNoIGFuIGVsZW1lbnQKICAgICAgICBpZiAoZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAnJyAmJiBpc0hpZGRlbihlbGVtKSkgewogICAgICAgICAgdmFsdWVzW2luZGV4XSA9IGRhdGFfcHJpdi5hY2Nlc3MoZWxlbSwgJ29sZGRpc3BsYXknLCBkZWZhdWx0RGlzcGxheShlbGVtLm5vZGVOYW1lKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGhpZGRlbiA9IGlzSGlkZGVuKGVsZW0pOwogICAgICAgIGlmIChkaXNwbGF5ICE9PSAnbm9uZScgfHwgIWhpZGRlbikgewogICAgICAgICAgZGF0YV9wcml2LnNldChlbGVtLCAnb2xkZGlzcGxheScsIGhpZGRlbiA/IGRpc3BsYXkgOiBqUXVlcnkuY3NzKGVsZW0sICdkaXNwbGF5JykpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gU2V0IHRoZSBkaXNwbGF5IG9mIG1vc3Qgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AKICAgIC8vIHRvIGF2b2lkIHRoZSBjb25zdGFudCByZWZsb3cKICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBlbGVtID0gZWxlbWVudHNbaW5kZXhdOwogICAgICBpZiAoIWVsZW0uc3R5bGUpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoIXNob3cgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZScgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAnJykgewogICAgICAgIGVsZW0uc3R5bGUuZGlzcGxheSA9IHNob3cgPyB2YWx1ZXNbaW5kZXhdIHx8ICcnIDogJ25vbmUnOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZWxlbWVudHM7CiAgfQogIGpRdWVyeS5leHRlbmQoewogICAgLy8gQWRkIGluIHN0eWxlIHByb3BlcnR5IGhvb2tzIGZvciBvdmVycmlkaW5nIHRoZSBkZWZhdWx0CiAgICAvLyBiZWhhdmlvciBvZiBnZXR0aW5nIGFuZCBzZXR0aW5nIGEgc3R5bGUgcHJvcGVydHkKICAgIGNzc0hvb2tzOiB7CiAgICAgIG9wYWNpdHk6IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCkgewogICAgICAgICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgICAgICAgIC8vIFdlIHNob3VsZCBhbHdheXMgZ2V0IGEgbnVtYmVyIGJhY2sgZnJvbSBvcGFjaXR5CiAgICAgICAgICAgIHZhciByZXQgPSBjdXJDU1MoZWxlbSwgJ29wYWNpdHknKTsKICAgICAgICAgICAgcmV0dXJuIHJldCA9PT0gJycgPyAnMScgOiByZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gRG9uJ3QgYXV0b21hdGljYWxseSBhZGQgInB4IiB0byB0aGVzZSBwb3NzaWJseS11bml0bGVzcyBwcm9wZXJ0aWVzCiAgICBjc3NOdW1iZXI6IHsKICAgICAgJ2NvbHVtbkNvdW50JzogdHJ1ZSwKICAgICAgJ2ZpbGxPcGFjaXR5JzogdHJ1ZSwKICAgICAgJ2ZsZXhHcm93JzogdHJ1ZSwKICAgICAgJ2ZsZXhTaHJpbmsnOiB0cnVlLAogICAgICAnZm9udFdlaWdodCc6IHRydWUsCiAgICAgICdsaW5lSGVpZ2h0JzogdHJ1ZSwKICAgICAgJ29wYWNpdHknOiB0cnVlLAogICAgICAnb3JkZXInOiB0cnVlLAogICAgICAnb3JwaGFucyc6IHRydWUsCiAgICAgICd3aWRvd3MnOiB0cnVlLAogICAgICAnekluZGV4JzogdHJ1ZSwKICAgICAgJ3pvb20nOiB0cnVlCiAgICB9LAogICAgLy8gQWRkIGluIHByb3BlcnRpZXMgd2hvc2UgbmFtZXMgeW91IHdpc2ggdG8gZml4IGJlZm9yZQogICAgLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQogICAgY3NzUHJvcHM6IHsKICAgICAgLy8gbm9ybWFsaXplIGZsb2F0IGNzcyBwcm9wZXJ0eQogICAgICAnZmxvYXQnOiAnY3NzRmxvYXQnCiAgICB9LAogICAgLy8gR2V0IGFuZCBzZXQgdGhlIHN0eWxlIHByb3BlcnR5IG9uIGEgRE9NIE5vZGUKICAgIHN0eWxlOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgdmFsdWUsIGV4dHJhKSB7CiAgICAgIC8vIERvbid0IHNldCBzdHlsZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwogICAgICBpZiAoIWVsZW0gfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4IHx8ICFlbGVtLnN0eWxlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQogICAgICB2YXIgcmV0LCB0eXBlLCBob29rcywgb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKG5hbWUpLCBzdHlsZSA9IGVsZW0uc3R5bGU7CiAgICAgIG5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbb3JpZ05hbWVdIHx8IChqUXVlcnkuY3NzUHJvcHNbb3JpZ05hbWVdID0gdmVuZG9yUHJvcE5hbWUoc3R5bGUsIG9yaWdOYW1lKSk7CiAgICAgIC8vIGdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24KICAgICAgLy8gZm9sbG93ZWQgYnkgdGhlIHVucHJlZml4ZWQgdmVyc2lvbgogICAgICBob29rcyA9IGpRdWVyeS5jc3NIb29rc1tuYW1lXSB8fCBqUXVlcnkuY3NzSG9va3Nbb3JpZ05hbWVdOwogICAgICAvLyBDaGVjayBpZiB3ZSdyZSBzZXR0aW5nIGEgdmFsdWUKICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0eXBlID0gdHlwZW9mIHZhbHVlOwogICAgICAgIC8vIGNvbnZlcnQgcmVsYXRpdmUgbnVtYmVyIHN0cmluZ3MgKCs9IG9yIC09KSB0byByZWxhdGl2ZSBudW1iZXJzLiAjNzM0NQogICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJyAmJiAocmV0ID0gcnJlbE51bS5leGVjKHZhbHVlKSkpIHsKICAgICAgICAgIHZhbHVlID0gKHJldFsxXSArIDEpICogcmV0WzJdICsgcGFyc2VGbG9hdChqUXVlcnkuY3NzKGVsZW0sIG5hbWUpKTsKICAgICAgICAgIC8vIEZpeGVzIGJ1ZyAjOTIzNwogICAgICAgICAgdHlwZSA9ICdudW1iZXInOwogICAgICAgIH0KICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBudWxsIGFuZCBOYU4gdmFsdWVzIGFyZW4ndCBzZXQuIFNlZTogIzcxMTYKICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gSWYgYSBudW1iZXIgd2FzIHBhc3NlZCBpbiwgYWRkICdweCcgdG8gdGhlIChleGNlcHQgZm9yIGNlcnRhaW4gQ1NTIHByb3BlcnRpZXMpCiAgICAgICAgaWYgKHR5cGUgPT09ICdudW1iZXInICYmICFqUXVlcnkuY3NzTnVtYmVyW29yaWdOYW1lXSkgewogICAgICAgICAgdmFsdWUgKz0gJ3B4JzsKICAgICAgICB9CiAgICAgICAgLy8gRml4ZXMgIzg5MDgsIGl0IGNhbiBiZSBkb25lIG1vcmUgY29ycmVjdGx5IGJ5IHNwZWNpZnlpbmcgc2V0dGVycyBpbiBjc3NIb29rcywKICAgICAgICAvLyBidXQgaXQgd291bGQgbWVhbiB0byBkZWZpbmUgZWlnaHQgKGZvciBldmVyeSBwcm9ibGVtYXRpYyBwcm9wZXJ0eSkgaWRlbnRpY2FsIGZ1bmN0aW9ucwogICAgICAgIGlmICghc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgJiYgdmFsdWUgPT09ICcnICYmIG5hbWUuaW5kZXhPZignYmFja2dyb3VuZCcpID09PSAwKSB7CiAgICAgICAgICBzdHlsZVtuYW1lXSA9ICdpbmhlcml0JzsKICAgICAgICB9CiAgICAgICAgLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCwgdXNlIHRoYXQgdmFsdWUsIG90aGVyd2lzZSBqdXN0IHNldCB0aGUgc3BlY2lmaWVkIHZhbHVlCiAgICAgICAgaWYgKCFob29rcyB8fCAhKCdzZXQnIGluIGhvb2tzKSB8fCAodmFsdWUgPSBob29rcy5zZXQoZWxlbSwgdmFsdWUsIGV4dHJhKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIG5vbi1jb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICAgICAgaWYgKGhvb2tzICYmICdnZXQnIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgZmFsc2UsIGV4dHJhKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgLy8gT3RoZXJ3aXNlIGp1c3QgZ2V0IHRoZSB2YWx1ZSBmcm9tIHRoZSBzdHlsZSBvYmplY3QKICAgICAgICByZXR1cm4gc3R5bGVbbmFtZV07CiAgICAgIH0KICAgIH0sCiAgICBjc3M6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBleHRyYSwgc3R5bGVzKSB7CiAgICAgIHZhciB2YWwsIG51bSwgaG9va3MsIG9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZShuYW1lKTsKICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lCiAgICAgIG5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbb3JpZ05hbWVdIHx8IChqUXVlcnkuY3NzUHJvcHNbb3JpZ05hbWVdID0gdmVuZG9yUHJvcE5hbWUoZWxlbS5zdHlsZSwgb3JpZ05hbWUpKTsKICAgICAgLy8gZ2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbgogICAgICAvLyBmb2xsb3dlZCBieSB0aGUgdW5wcmVmaXhlZCB2ZXJzaW9uCiAgICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzW25hbWVdIHx8IGpRdWVyeS5jc3NIb29rc1tvcmlnTmFtZV07CiAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICAgIGlmIChob29rcyAmJiAnZ2V0JyBpbiBob29rcykgewogICAgICAgIHZhbCA9IGhvb2tzLmdldChlbGVtLCB0cnVlLCBleHRyYSk7CiAgICAgIH0KICAgICAgLy8gT3RoZXJ3aXNlLCBpZiBhIHdheSB0byBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGV4aXN0cywgdXNlIHRoYXQKICAgICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFsID0gY3VyQ1NTKGVsZW0sIG5hbWUsIHN0eWxlcyk7CiAgICAgIH0KICAgICAgLy9jb252ZXJ0ICJub3JtYWwiIHRvIGNvbXB1dGVkIHZhbHVlCiAgICAgIGlmICh2YWwgPT09ICdub3JtYWwnICYmIG5hbWUgaW4gY3NzTm9ybWFsVHJhbnNmb3JtKSB7CiAgICAgICAgdmFsID0gY3NzTm9ybWFsVHJhbnNmb3JtW25hbWVdOwogICAgICB9CiAgICAgIC8vIFJldHVybiwgY29udmVydGluZyB0byBudW1iZXIgaWYgZm9yY2VkIG9yIGEgcXVhbGlmaWVyIHdhcyBwcm92aWRlZCBhbmQgdmFsIGxvb2tzIG51bWVyaWMKICAgICAgaWYgKGV4dHJhID09PSAnJyB8fCBleHRyYSkgewogICAgICAgIG51bSA9IHBhcnNlRmxvYXQodmFsKTsKICAgICAgICByZXR1cm4gZXh0cmEgPT09IHRydWUgfHwgalF1ZXJ5LmlzTnVtZXJpYyhudW0pID8gbnVtIHx8IDAgOiB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbDsKICAgIH0KICB9KTsKICBqUXVlcnkuZWFjaChbCiAgICAnaGVpZ2h0JywKICAgICd3aWR0aCcKICBdLCBmdW5jdGlvbiAoaSwgbmFtZSkgewogICAgalF1ZXJ5LmNzc0hvb2tzW25hbWVdID0gewogICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCwgZXh0cmEpIHsKICAgICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICAgIC8vIGNlcnRhaW4gZWxlbWVudHMgY2FuIGhhdmUgZGltZW5zaW9uIGluZm8gaWYgd2UgaW52aXNpYmx5IHNob3cgdGhlbQogICAgICAgICAgLy8gaG93ZXZlciwgaXQgbXVzdCBoYXZlIGEgY3VycmVudCBkaXNwbGF5IHN0eWxlIHRoYXQgd291bGQgYmVuZWZpdCBmcm9tIHRoaXMKICAgICAgICAgIHJldHVybiByZGlzcGxheXN3YXAudGVzdChqUXVlcnkuY3NzKGVsZW0sICdkaXNwbGF5JykpICYmIGVsZW0ub2Zmc2V0V2lkdGggPT09IDAgPyBqUXVlcnkuc3dhcChlbGVtLCBjc3NTaG93LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRXaWR0aE9ySGVpZ2h0KGVsZW0sIG5hbWUsIGV4dHJhKTsKICAgICAgICAgIH0pIDogZ2V0V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSwgZXh0cmEpIHsKICAgICAgICB2YXIgc3R5bGVzID0gZXh0cmEgJiYgZ2V0U3R5bGVzKGVsZW0pOwogICAgICAgIHJldHVybiBzZXRQb3NpdGl2ZU51bWJlcihlbGVtLCB2YWx1ZSwgZXh0cmEgPyBhdWdtZW50V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSwgalF1ZXJ5LmNzcyhlbGVtLCAnYm94U2l6aW5nJywgZmFsc2UsIHN0eWxlcykgPT09ICdib3JkZXItYm94Jywgc3R5bGVzKSA6IDApOwogICAgICB9CiAgICB9OwogIH0pOwogIC8vIFN1cHBvcnQ6IEFuZHJvaWQgMi4zCiAgalF1ZXJ5LmNzc0hvb2tzLm1hcmdpblJpZ2h0ID0gYWRkR2V0SG9va0lmKHN1cHBvcnQucmVsaWFibGVNYXJnaW5SaWdodCwgZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkKSB7CiAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CiAgICAgIC8vIFdvcmsgYXJvdW5kIGJ5IHRlbXBvcmFyaWx5IHNldHRpbmcgZWxlbWVudCBkaXNwbGF5IHRvIGlubGluZS1ibG9jawogICAgICByZXR1cm4galF1ZXJ5LnN3YXAoZWxlbSwgeyAnZGlzcGxheSc6ICdpbmxpbmUtYmxvY2snIH0sIGN1ckNTUywgWwogICAgICAgIGVsZW0sCiAgICAgICAgJ21hcmdpblJpZ2h0JwogICAgICBdKTsKICAgIH0KICB9KTsKICAvLyBUaGVzZSBob29rcyBhcmUgdXNlZCBieSBhbmltYXRlIHRvIGV4cGFuZCBwcm9wZXJ0aWVzCiAgalF1ZXJ5LmVhY2goewogICAgbWFyZ2luOiAnJywKICAgIHBhZGRpbmc6ICcnLAogICAgYm9yZGVyOiAnV2lkdGgnCiAgfSwgZnVuY3Rpb24gKHByZWZpeCwgc3VmZml4KSB7CiAgICBqUXVlcnkuY3NzSG9va3NbcHJlZml4ICsgc3VmZml4XSA9IHsKICAgICAgZXhwYW5kOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgaSA9IDAsIGV4cGFuZGVkID0ge30sCiAgICAgICAgICAvLyBhc3N1bWVzIGEgc2luZ2xlIG51bWJlciBpZiBub3QgYSBzdHJpbmcKICAgICAgICAgIHBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHZhbHVlLnNwbGl0KCcgJykgOiBbdmFsdWVdOwogICAgICAgIGZvciAoOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgICBleHBhbmRlZFtwcmVmaXggKyBjc3NFeHBhbmRbaV0gKyBzdWZmaXhdID0gcGFydHNbaV0gfHwgcGFydHNbaSAtIDJdIHx8IHBhcnRzWzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwYW5kZWQ7CiAgICAgIH0KICAgIH07CiAgICBpZiAoIXJtYXJnaW4udGVzdChwcmVmaXgpKSB7CiAgICAgIGpRdWVyeS5jc3NIb29rc1twcmVmaXggKyBzdWZmaXhdLnNldCA9IHNldFBvc2l0aXZlTnVtYmVyOwogICAgfQogIH0pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgY3NzOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgdmFsdWUpIHsKICAgICAgICB2YXIgc3R5bGVzLCBsZW4sIG1hcCA9IHt9LCBpID0gMDsKICAgICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgIHN0eWxlcyA9IGdldFN0eWxlcyhlbGVtKTsKICAgICAgICAgIGxlbiA9IG5hbWUubGVuZ3RoOwogICAgICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBtYXBbbmFtZVtpXV0gPSBqUXVlcnkuY3NzKGVsZW0sIG5hbWVbaV0sIGZhbHNlLCBzdHlsZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPyBqUXVlcnkuc3R5bGUoZWxlbSwgbmFtZSwgdmFsdWUpIDogalF1ZXJ5LmNzcyhlbGVtLCBuYW1lKTsKICAgICAgfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxKTsKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzaG93SGlkZSh0aGlzLCB0cnVlKTsKICAgIH0sCiAgICBoaWRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzaG93SGlkZSh0aGlzKTsKICAgIH0sCiAgICB0b2dnbGU6IGZ1bmN0aW9uIChzdGF0ZSkgewogICAgICBpZiAodHlwZW9mIHN0YXRlID09PSAnYm9vbGVhbicpIHsKICAgICAgICByZXR1cm4gc3RhdGUgPyB0aGlzLnNob3coKSA6IHRoaXMuaGlkZSgpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChpc0hpZGRlbih0aGlzKSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLnNob3coKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLmhpZGUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIFR3ZWVuKGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nKSB7CiAgICByZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nKTsKICB9CiAgalF1ZXJ5LlR3ZWVuID0gVHdlZW47CiAgVHdlZW4ucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IFR3ZWVuLAogICAgaW5pdDogZnVuY3Rpb24gKGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0KSB7CiAgICAgIHRoaXMuZWxlbSA9IGVsZW07CiAgICAgIHRoaXMucHJvcCA9IHByb3A7CiAgICAgIHRoaXMuZWFzaW5nID0gZWFzaW5nIHx8ICdzd2luZyc7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCk7CiAgICAgIHRoaXMuZW5kID0gZW5kOwogICAgICB0aGlzLnVuaXQgPSB1bml0IHx8IChqUXVlcnkuY3NzTnVtYmVyW3Byb3BdID8gJycgOiAncHgnKTsKICAgIH0sCiAgICBjdXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgIHJldHVybiBob29rcyAmJiBob29rcy5nZXQgPyBob29rcy5nZXQodGhpcykgOiBUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KHRoaXMpOwogICAgfSwKICAgIHJ1bjogZnVuY3Rpb24gKHBlcmNlbnQpIHsKICAgICAgdmFyIGVhc2VkLCBob29rcyA9IFR3ZWVuLnByb3BIb29rc1t0aGlzLnByb3BdOwogICAgICBpZiAodGhpcy5vcHRpb25zLmR1cmF0aW9uKSB7CiAgICAgICAgdGhpcy5wb3MgPSBlYXNlZCA9IGpRdWVyeS5lYXNpbmdbdGhpcy5lYXNpbmddKHBlcmNlbnQsIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIHBlcmNlbnQsIDAsIDEsIHRoaXMub3B0aW9ucy5kdXJhdGlvbik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wb3MgPSBlYXNlZCA9IHBlcmNlbnQ7CiAgICAgIH0KICAgICAgdGhpcy5ub3cgPSAodGhpcy5lbmQgLSB0aGlzLnN0YXJ0KSAqIGVhc2VkICsgdGhpcy5zdGFydDsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5zdGVwKSB7CiAgICAgICAgdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCh0aGlzLmVsZW0sIHRoaXMubm93LCB0aGlzKTsKICAgICAgfQogICAgICBpZiAoaG9va3MgJiYgaG9va3Muc2V0KSB7CiAgICAgICAgaG9va3Muc2V0KHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIFR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5zZXQodGhpcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfTsKICBUd2Vlbi5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBUd2Vlbi5wcm90b3R5cGU7CiAgVHdlZW4ucHJvcEhvb2tzID0gewogICAgX2RlZmF1bHQ6IHsKICAgICAgZ2V0OiBmdW5jdGlvbiAodHdlZW4pIHsKICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgIGlmICh0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdICE9IG51bGwgJiYgKCF0d2Vlbi5lbGVtLnN0eWxlIHx8IHR3ZWVuLmVsZW0uc3R5bGVbdHdlZW4ucHJvcF0gPT0gbnVsbCkpIHsKICAgICAgICAgIHJldHVybiB0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdOwogICAgICAgIH0KICAgICAgICAvLyBwYXNzaW5nIGFuIGVtcHR5IHN0cmluZyBhcyBhIDNyZCBwYXJhbWV0ZXIgdG8gLmNzcyB3aWxsIGF1dG9tYXRpY2FsbHkKICAgICAgICAvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzCiAgICAgICAgLy8gc28sIHNpbXBsZSB2YWx1ZXMgc3VjaCBhcyAiMTBweCIgYXJlIHBhcnNlZCB0byBGbG9hdC4KICAgICAgICAvLyBjb21wbGV4IHZhbHVlcyBzdWNoIGFzICJyb3RhdGUoMXJhZCkiIGFyZSByZXR1cm5lZCBhcyBpcy4KICAgICAgICByZXN1bHQgPSBqUXVlcnkuY3NzKHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsICcnKTsKICAgICAgICAvLyBFbXB0eSBzdHJpbmdzLCBudWxsLCB1bmRlZmluZWQgYW5kICJhdXRvIiBhcmUgY29udmVydGVkIHRvIDAuCiAgICAgICAgcmV0dXJuICFyZXN1bHQgfHwgcmVzdWx0ID09PSAnYXV0bycgPyAwIDogcmVzdWx0OwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uICh0d2VlbikgewogICAgICAgIC8vIHVzZSBzdGVwIGhvb2sgZm9yIGJhY2sgY29tcGF0IC0gdXNlIGNzc0hvb2sgaWYgaXRzIHRoZXJlIC0gdXNlIC5zdHlsZSBpZiBpdHMKICAgICAgICAvLyBhdmFpbGFibGUgYW5kIHVzZSBwbGFpbiBwcm9wZXJ0aWVzIHdoZXJlIGF2YWlsYWJsZQogICAgICAgIGlmIChqUXVlcnkuZnguc3RlcFt0d2Vlbi5wcm9wXSkgewogICAgICAgICAgalF1ZXJ5LmZ4LnN0ZXBbdHdlZW4ucHJvcF0odHdlZW4pOwogICAgICAgIH0gZWxzZSBpZiAodHdlZW4uZWxlbS5zdHlsZSAmJiAodHdlZW4uZWxlbS5zdHlsZVtqUXVlcnkuY3NzUHJvcHNbdHdlZW4ucHJvcF1dICE9IG51bGwgfHwgalF1ZXJ5LmNzc0hvb2tzW3R3ZWVuLnByb3BdKSkgewogICAgICAgICAgalF1ZXJ5LnN0eWxlKHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsIHR3ZWVuLm5vdyArIHR3ZWVuLnVuaXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdID0gdHdlZW4ubm93OwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CiAgLy8gU3VwcG9ydDogSUU5CiAgLy8gUGFuaWMgYmFzZWQgYXBwcm9hY2ggdG8gc2V0dGluZyB0aGluZ3Mgb24gZGlzY29ubmVjdGVkIG5vZGVzCiAgVHdlZW4ucHJvcEhvb2tzLnNjcm9sbFRvcCA9IFR3ZWVuLnByb3BIb29rcy5zY3JvbGxMZWZ0ID0gewogICAgc2V0OiBmdW5jdGlvbiAodHdlZW4pIHsKICAgICAgaWYgKHR3ZWVuLmVsZW0ubm9kZVR5cGUgJiYgdHdlZW4uZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgdHdlZW4uZWxlbVt0d2Vlbi5wcm9wXSA9IHR3ZWVuLm5vdzsKICAgICAgfQogICAgfQogIH07CiAgalF1ZXJ5LmVhc2luZyA9IHsKICAgIGxpbmVhcjogZnVuY3Rpb24gKHApIHsKICAgICAgcmV0dXJuIHA7CiAgICB9LAogICAgc3dpbmc6IGZ1bmN0aW9uIChwKSB7CiAgICAgIHJldHVybiAwLjUgLSBNYXRoLmNvcyhwICogTWF0aC5QSSkgLyAyOwogICAgfQogIH07CiAgalF1ZXJ5LmZ4ID0gVHdlZW4ucHJvdG90eXBlLmluaXQ7CiAgLy8gQmFjayBDb21wYXQgPDEuOCBleHRlbnNpb24gcG9pbnQKICBqUXVlcnkuZnguc3RlcCA9IHt9OwogIHZhciBmeE5vdywgdGltZXJJZCwgcmZ4dHlwZXMgPSAvXig/OnRvZ2dsZXxzaG93fGhpZGUpJC8sIHJmeG51bSA9IG5ldyBSZWdFeHAoJ14oPzooWystXSk9fCkoJyArIHBudW0gKyAnKShbYS16JV0qKSQnLCAnaScpLCBycnVuID0gL3F1ZXVlSG9va3MkLywgYW5pbWF0aW9uUHJlZmlsdGVycyA9IFtkZWZhdWx0UHJlZmlsdGVyXSwgdHdlZW5lcnMgPSB7CiAgICAgICcqJzogW2Z1bmN0aW9uIChwcm9wLCB2YWx1ZSkgewogICAgICAgICAgdmFyIHR3ZWVuID0gdGhpcy5jcmVhdGVUd2Vlbihwcm9wLCB2YWx1ZSksIHRhcmdldCA9IHR3ZWVuLmN1cigpLCBwYXJ0cyA9IHJmeG51bS5leGVjKHZhbHVlKSwgdW5pdCA9IHBhcnRzICYmIHBhcnRzWzNdIHx8IChqUXVlcnkuY3NzTnVtYmVyW3Byb3BdID8gJycgOiAncHgnKSwKICAgICAgICAgICAgLy8gU3RhcnRpbmcgdmFsdWUgY29tcHV0YXRpb24gaXMgcmVxdWlyZWQgZm9yIHBvdGVudGlhbCB1bml0IG1pc21hdGNoZXMKICAgICAgICAgICAgc3RhcnQgPSAoalF1ZXJ5LmNzc051bWJlcltwcm9wXSB8fCB1bml0ICE9PSAncHgnICYmICt0YXJnZXQpICYmIHJmeG51bS5leGVjKGpRdWVyeS5jc3ModHdlZW4uZWxlbSwgcHJvcCkpLCBzY2FsZSA9IDEsIG1heEl0ZXJhdGlvbnMgPSAyMDsKICAgICAgICAgIGlmIChzdGFydCAmJiBzdGFydFszXSAhPT0gdW5pdCkgewogICAgICAgICAgICAvLyBUcnVzdCB1bml0cyByZXBvcnRlZCBieSBqUXVlcnkuY3NzCiAgICAgICAgICAgIHVuaXQgPSB1bml0IHx8IHN0YXJ0WzNdOwogICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSB0d2VlbiBwcm9wZXJ0aWVzIGxhdGVyIG9uCiAgICAgICAgICAgIHBhcnRzID0gcGFydHMgfHwgW107CiAgICAgICAgICAgIC8vIEl0ZXJhdGl2ZWx5IGFwcHJveGltYXRlIGZyb20gYSBub256ZXJvIHN0YXJ0aW5nIHBvaW50CiAgICAgICAgICAgIHN0YXJ0ID0gK3RhcmdldCB8fCAxOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgLy8gSWYgcHJldmlvdXMgaXRlcmF0aW9uIHplcm9lZCBvdXQsIGRvdWJsZSB1bnRpbCB3ZSBnZXQgKnNvbWV0aGluZyoKICAgICAgICAgICAgICAvLyBVc2UgYSBzdHJpbmcgZm9yIGRvdWJsaW5nIGZhY3RvciBzbyB3ZSBkb24ndCBhY2NpZGVudGFsbHkgc2VlIHNjYWxlIGFzIHVuY2hhbmdlZCBiZWxvdwogICAgICAgICAgICAgIHNjYWxlID0gc2NhbGUgfHwgJy41JzsKICAgICAgICAgICAgICAvLyBBZGp1c3QgYW5kIGFwcGx5CiAgICAgICAgICAgICAgc3RhcnQgPSBzdGFydCAvIHNjYWxlOwogICAgICAgICAgICAgIGpRdWVyeS5zdHlsZSh0d2Vlbi5lbGVtLCBwcm9wLCBzdGFydCArIHVuaXQpOyAgLy8gVXBkYXRlIHNjYWxlLCB0b2xlcmF0aW5nIHplcm8gb3IgTmFOIGZyb20gdHdlZW4uY3VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFuZCBicmVha2luZyB0aGUgbG9vcCBpZiBzY2FsZSBpcyB1bmNoYW5nZWQgb3IgcGVyZmVjdCwgb3IgaWYgd2UndmUganVzdCBoYWQgZW5vdWdoCiAgICAgICAgICAgIH0gd2hpbGUgKHNjYWxlICE9PSAoc2NhbGUgPSB0d2Vlbi5jdXIoKSAvIHRhcmdldCkgJiYgc2NhbGUgIT09IDEgJiYgLS1tYXhJdGVyYXRpb25zKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFVwZGF0ZSB0d2VlbiBwcm9wZXJ0aWVzCiAgICAgICAgICBpZiAocGFydHMpIHsKICAgICAgICAgICAgc3RhcnQgPSB0d2Vlbi5zdGFydCA9ICtzdGFydCB8fCArdGFyZ2V0IHx8IDA7CiAgICAgICAgICAgIHR3ZWVuLnVuaXQgPSB1bml0OwogICAgICAgICAgICAvLyBJZiBhICs9Ly09IHRva2VuIHdhcyBwcm92aWRlZCwgd2UncmUgZG9pbmcgYSByZWxhdGl2ZSBhbmltYXRpb24KICAgICAgICAgICAgdHdlZW4uZW5kID0gcGFydHNbMV0gPyBzdGFydCArIChwYXJ0c1sxXSArIDEpICogcGFydHNbMl0gOiArcGFydHNbMl07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHdlZW47CiAgICAgICAgfV0KICAgIH07CiAgLy8gQW5pbWF0aW9ucyBjcmVhdGVkIHN5bmNocm9ub3VzbHkgd2lsbCBydW4gc3luY2hyb25vdXNseQogIGZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgewogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGZ4Tm93ID0gdW5kZWZpbmVkOwogICAgfSk7CiAgICByZXR1cm4gZnhOb3cgPSBqUXVlcnkubm93KCk7CiAgfQogIC8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCiAgZnVuY3Rpb24gZ2VuRngodHlwZSwgaW5jbHVkZVdpZHRoKSB7CiAgICB2YXIgd2hpY2gsIGkgPSAwLCBhdHRycyA9IHsgaGVpZ2h0OiB0eXBlIH07CiAgICAvLyBpZiB3ZSBpbmNsdWRlIHdpZHRoLCBzdGVwIHZhbHVlIGlzIDEgdG8gZG8gYWxsIGNzc0V4cGFuZCB2YWx1ZXMsCiAgICAvLyBpZiB3ZSBkb24ndCBpbmNsdWRlIHdpZHRoLCBzdGVwIHZhbHVlIGlzIDIgdG8gc2tpcCBvdmVyIExlZnQgYW5kIFJpZ2h0CiAgICBpbmNsdWRlV2lkdGggPSBpbmNsdWRlV2lkdGggPyAxIDogMDsKICAgIGZvciAoOyBpIDwgNDsgaSArPSAyIC0gaW5jbHVkZVdpZHRoKSB7CiAgICAgIHdoaWNoID0gY3NzRXhwYW5kW2ldOwogICAgICBhdHRyc1snbWFyZ2luJyArIHdoaWNoXSA9IGF0dHJzWydwYWRkaW5nJyArIHdoaWNoXSA9IHR5cGU7CiAgICB9CiAgICBpZiAoaW5jbHVkZVdpZHRoKSB7CiAgICAgIGF0dHJzLm9wYWNpdHkgPSBhdHRycy53aWR0aCA9IHR5cGU7CiAgICB9CiAgICByZXR1cm4gYXR0cnM7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVR3ZWVuKHZhbHVlLCBwcm9wLCBhbmltYXRpb24pIHsKICAgIHZhciB0d2VlbiwgY29sbGVjdGlvbiA9ICh0d2VlbmVyc1twcm9wXSB8fCBbXSkuY29uY2F0KHR3ZWVuZXJzWycqJ10pLCBpbmRleCA9IDAsIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGlmICh0d2VlbiA9IGNvbGxlY3Rpb25baW5kZXhdLmNhbGwoYW5pbWF0aW9uLCBwcm9wLCB2YWx1ZSkpIHsKICAgICAgICAvLyB3ZSdyZSBkb25lIHdpdGggdGhpcyBwcm9wZXJ0eQogICAgICAgIHJldHVybiB0d2VlbjsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKGVsZW0sIHByb3BzLCBvcHRzKSB7CiAgICAvKiBqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICB2YXIgcHJvcCwgdmFsdWUsIHRvZ2dsZSwgdHdlZW4sIGhvb2tzLCBvbGRmaXJlLCBkaXNwbGF5LCBjaGVja0Rpc3BsYXksIGFuaW0gPSB0aGlzLCBvcmlnID0ge30sIHN0eWxlID0gZWxlbS5zdHlsZSwgaGlkZGVuID0gZWxlbS5ub2RlVHlwZSAmJiBpc0hpZGRlbihlbGVtKSwgZGF0YVNob3cgPSBkYXRhX3ByaXYuZ2V0KGVsZW0sICdmeHNob3cnKTsKICAgIC8vIGhhbmRsZSBxdWV1ZTogZmFsc2UgcHJvbWlzZXMKICAgIGlmICghb3B0cy5xdWV1ZSkgewogICAgICBob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyhlbGVtLCAnZngnKTsKICAgICAgaWYgKGhvb2tzLnVucXVldWVkID09IG51bGwpIHsKICAgICAgICBob29rcy51bnF1ZXVlZCA9IDA7CiAgICAgICAgb2xkZmlyZSA9IGhvb2tzLmVtcHR5LmZpcmU7CiAgICAgICAgaG9va3MuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICghaG9va3MudW5xdWV1ZWQpIHsKICAgICAgICAgICAgb2xkZmlyZSgpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgaG9va3MudW5xdWV1ZWQrKzsKICAgICAgYW5pbS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIGRvaW5nIHRoaXMgbWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wbGV0ZSBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkCiAgICAgICAgLy8gYmVmb3JlIHRoaXMgY29tcGxldGVzCiAgICAgICAgYW5pbS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgICAgaG9va3MudW5xdWV1ZWQtLTsKICAgICAgICAgIGlmICghalF1ZXJ5LnF1ZXVlKGVsZW0sICdmeCcpLmxlbmd0aCkgewogICAgICAgICAgICBob29rcy5lbXB0eS5maXJlKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogICAgLy8gaGVpZ2h0L3dpZHRoIG92ZXJmbG93IHBhc3MKICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxICYmICgnaGVpZ2h0JyBpbiBwcm9wcyB8fCAnd2lkdGgnIGluIHByb3BzKSkgewogICAgICAvLyBNYWtlIHN1cmUgdGhhdCBub3RoaW5nIHNuZWFrcyBvdXQKICAgICAgLy8gUmVjb3JkIGFsbCAzIG92ZXJmbG93IGF0dHJpYnV0ZXMgYmVjYXVzZSBJRTktMTAgZG8gbm90CiAgICAgIC8vIGNoYW5nZSB0aGUgb3ZlcmZsb3cgYXR0cmlidXRlIHdoZW4gb3ZlcmZsb3dYIGFuZAogICAgICAvLyBvdmVyZmxvd1kgYXJlIHNldCB0byB0aGUgc2FtZSB2YWx1ZQogICAgICBvcHRzLm92ZXJmbG93ID0gWwogICAgICAgIHN0eWxlLm92ZXJmbG93LAogICAgICAgIHN0eWxlLm92ZXJmbG93WCwKICAgICAgICBzdHlsZS5vdmVyZmxvd1kKICAgICAgXTsKICAgICAgLy8gU2V0IGRpc3BsYXkgcHJvcGVydHkgdG8gaW5saW5lLWJsb2NrIGZvciBoZWlnaHQvd2lkdGgKICAgICAgLy8gYW5pbWF0aW9ucyBvbiBpbmxpbmUgZWxlbWVudHMgdGhhdCBhcmUgaGF2aW5nIHdpZHRoL2hlaWdodCBhbmltYXRlZAogICAgICBkaXNwbGF5ID0galF1ZXJ5LmNzcyhlbGVtLCAnZGlzcGxheScpOwogICAgICAvLyBUZXN0IGRlZmF1bHQgZGlzcGxheSBpZiBkaXNwbGF5IGlzIGN1cnJlbnRseSAibm9uZSIKICAgICAgY2hlY2tEaXNwbGF5ID0gZGlzcGxheSA9PT0gJ25vbmUnID8gZGF0YV9wcml2LmdldChlbGVtLCAnb2xkZGlzcGxheScpIHx8IGRlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpIDogZGlzcGxheTsKICAgICAgaWYgKGNoZWNrRGlzcGxheSA9PT0gJ2lubGluZScgJiYgalF1ZXJ5LmNzcyhlbGVtLCAnZmxvYXQnKSA9PT0gJ25vbmUnKSB7CiAgICAgICAgc3R5bGUuZGlzcGxheSA9ICdpbmxpbmUtYmxvY2snOwogICAgICB9CiAgICB9CiAgICBpZiAob3B0cy5vdmVyZmxvdykgewogICAgICBzdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nOwogICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgc3R5bGUub3ZlcmZsb3cgPSBvcHRzLm92ZXJmbG93WzBdOwogICAgICAgIHN0eWxlLm92ZXJmbG93WCA9IG9wdHMub3ZlcmZsb3dbMV07CiAgICAgICAgc3R5bGUub3ZlcmZsb3dZID0gb3B0cy5vdmVyZmxvd1syXTsKICAgICAgfSk7CiAgICB9CiAgICAvLyBzaG93L2hpZGUgcGFzcwogICAgZm9yIChwcm9wIGluIHByb3BzKSB7CiAgICAgIHZhbHVlID0gcHJvcHNbcHJvcF07CiAgICAgIGlmIChyZnh0eXBlcy5leGVjKHZhbHVlKSkgewogICAgICAgIGRlbGV0ZSBwcm9wc1twcm9wXTsKICAgICAgICB0b2dnbGUgPSB0b2dnbGUgfHwgdmFsdWUgPT09ICd0b2dnbGUnOwogICAgICAgIGlmICh2YWx1ZSA9PT0gKGhpZGRlbiA/ICdoaWRlJyA6ICdzaG93JykpIHsKICAgICAgICAgIC8vIElmIHRoZXJlIGlzIGRhdGFTaG93IGxlZnQgb3ZlciBmcm9tIGEgc3RvcHBlZCBoaWRlIG9yIHNob3cgYW5kIHdlIGFyZSBnb2luZyB0byBwcm9jZWVkIHdpdGggc2hvdywgd2Ugc2hvdWxkIHByZXRlbmQgdG8gYmUgaGlkZGVuCiAgICAgICAgICBpZiAodmFsdWUgPT09ICdzaG93JyAmJiBkYXRhU2hvdyAmJiBkYXRhU2hvd1twcm9wXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGhpZGRlbiA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgb3JpZ1twcm9wXSA9IGRhdGFTaG93ICYmIGRhdGFTaG93W3Byb3BdIHx8IGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wKTsgIC8vIEFueSBub24tZnggdmFsdWUgc3RvcHMgdXMgZnJvbSByZXN0b3JpbmcgdGhlIG9yaWdpbmFsIGRpc3BsYXkgdmFsdWUKICAgICAgfSBlbHNlIHsKICAgICAgICBkaXNwbGF5ID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9CiAgICBpZiAoIWpRdWVyeS5pc0VtcHR5T2JqZWN0KG9yaWcpKSB7CiAgICAgIGlmIChkYXRhU2hvdykgewogICAgICAgIGlmICgnaGlkZGVuJyBpbiBkYXRhU2hvdykgewogICAgICAgICAgaGlkZGVuID0gZGF0YVNob3cuaGlkZGVuOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRhU2hvdyA9IGRhdGFfcHJpdi5hY2Nlc3MoZWxlbSwgJ2Z4c2hvdycsIHt9KTsKICAgICAgfQogICAgICAvLyBzdG9yZSBzdGF0ZSBpZiBpdHMgdG9nZ2xlIC0gZW5hYmxlcyAuc3RvcCgpLnRvZ2dsZSgpIHRvICJyZXZlcnNlIgogICAgICBpZiAodG9nZ2xlKSB7CiAgICAgICAgZGF0YVNob3cuaGlkZGVuID0gIWhpZGRlbjsKICAgICAgfQogICAgICBpZiAoaGlkZGVuKSB7CiAgICAgICAgalF1ZXJ5KGVsZW0pLnNob3coKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhbmltLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgalF1ZXJ5KGVsZW0pLmhpZGUoKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBhbmltLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwcm9wOwogICAgICAgIGRhdGFfcHJpdi5yZW1vdmUoZWxlbSwgJ2Z4c2hvdycpOwogICAgICAgIGZvciAocHJvcCBpbiBvcmlnKSB7CiAgICAgICAgICBqUXVlcnkuc3R5bGUoZWxlbSwgcHJvcCwgb3JpZ1twcm9wXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgZm9yIChwcm9wIGluIG9yaWcpIHsKICAgICAgICB0d2VlbiA9IGNyZWF0ZVR3ZWVuKGhpZGRlbiA/IGRhdGFTaG93W3Byb3BdIDogMCwgcHJvcCwgYW5pbSk7CiAgICAgICAgaWYgKCEocHJvcCBpbiBkYXRhU2hvdykpIHsKICAgICAgICAgIGRhdGFTaG93W3Byb3BdID0gdHdlZW4uc3RhcnQ7CiAgICAgICAgICBpZiAoaGlkZGVuKSB7CiAgICAgICAgICAgIHR3ZWVuLmVuZCA9IHR3ZWVuLnN0YXJ0OwogICAgICAgICAgICB0d2Vlbi5zdGFydCA9IHByb3AgPT09ICd3aWR0aCcgfHwgcHJvcCA9PT0gJ2hlaWdodCcgPyAxIDogMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gIC8vIElmIHRoaXMgaXMgYSBub29wIGxpa2UgLmhpZGUoKS5oaWRlKCksIHJlc3RvcmUgYW4gb3ZlcndyaXR0ZW4gZGlzcGxheSB2YWx1ZQogICAgfSBlbHNlIGlmICgoZGlzcGxheSA9PT0gJ25vbmUnID8gZGVmYXVsdERpc3BsYXkoZWxlbS5ub2RlTmFtZSkgOiBkaXNwbGF5KSA9PT0gJ2lubGluZScpIHsKICAgICAgc3R5bGUuZGlzcGxheSA9IGRpc3BsYXk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHByb3BGaWx0ZXIocHJvcHMsIHNwZWNpYWxFYXNpbmcpIHsKICAgIHZhciBpbmRleCwgbmFtZSwgZWFzaW5nLCB2YWx1ZSwgaG9va3M7CiAgICAvLyBjYW1lbENhc2UsIHNwZWNpYWxFYXNpbmcgYW5kIGV4cGFuZCBjc3NIb29rIHBhc3MKICAgIGZvciAoaW5kZXggaW4gcHJvcHMpIHsKICAgICAgbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoaW5kZXgpOwogICAgICBlYXNpbmcgPSBzcGVjaWFsRWFzaW5nW25hbWVdOwogICAgICB2YWx1ZSA9IHByb3BzW2luZGV4XTsKICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIGVhc2luZyA9IHZhbHVlWzFdOwogICAgICAgIHZhbHVlID0gcHJvcHNbaW5kZXhdID0gdmFsdWVbMF07CiAgICAgIH0KICAgICAgaWYgKGluZGV4ICE9PSBuYW1lKSB7CiAgICAgICAgcHJvcHNbbmFtZV0gPSB2YWx1ZTsKICAgICAgICBkZWxldGUgcHJvcHNbaW5kZXhdOwogICAgICB9CiAgICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzW25hbWVdOwogICAgICBpZiAoaG9va3MgJiYgJ2V4cGFuZCcgaW4gaG9va3MpIHsKICAgICAgICB2YWx1ZSA9IGhvb2tzLmV4cGFuZCh2YWx1ZSk7CiAgICAgICAgZGVsZXRlIHByb3BzW25hbWVdOwogICAgICAgIC8vIG5vdCBxdWl0ZSAkLmV4dGVuZCwgdGhpcyB3b250IG92ZXJ3cml0ZSBrZXlzIGFscmVhZHkgcHJlc2VudC4KICAgICAgICAvLyBhbHNvIC0gcmV1c2luZyAnaW5kZXgnIGZyb20gYWJvdmUgYmVjYXVzZSB3ZSBoYXZlIHRoZSBjb3JyZWN0ICJuYW1lIgogICAgICAgIGZvciAoaW5kZXggaW4gdmFsdWUpIHsKICAgICAgICAgIGlmICghKGluZGV4IGluIHByb3BzKSkgewogICAgICAgICAgICBwcm9wc1tpbmRleF0gPSB2YWx1ZVtpbmRleF07CiAgICAgICAgICAgIHNwZWNpYWxFYXNpbmdbaW5kZXhdID0gZWFzaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzcGVjaWFsRWFzaW5nW25hbWVdID0gZWFzaW5nOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIEFuaW1hdGlvbihlbGVtLCBwcm9wZXJ0aWVzLCBvcHRpb25zKSB7CiAgICB2YXIgcmVzdWx0LCBzdG9wcGVkLCBpbmRleCA9IDAsIGxlbmd0aCA9IGFuaW1hdGlvblByZWZpbHRlcnMubGVuZ3RoLCBkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gZG9uJ3QgbWF0Y2ggZWxlbSBpbiB0aGUgOmFuaW1hdGVkIHNlbGVjdG9yCiAgICAgICAgZGVsZXRlIHRpY2suZWxlbTsKICAgICAgfSksIHRpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwgcmVtYWluaW5nID0gTWF0aC5tYXgoMCwgYW5pbWF0aW9uLnN0YXJ0VGltZSArIGFuaW1hdGlvbi5kdXJhdGlvbiAtIGN1cnJlbnRUaW1lKSwKICAgICAgICAgIC8vIGFyY2hhaWMgY3Jhc2ggYnVnIHdvbid0IGFsbG93IHVzIHRvIHVzZSAxIC0gKCAwLjUgfHwgMCApICgjMTI0OTcpCiAgICAgICAgICB0ZW1wID0gcmVtYWluaW5nIC8gYW5pbWF0aW9uLmR1cmF0aW9uIHx8IDAsIHBlcmNlbnQgPSAxIC0gdGVtcCwgaW5kZXggPSAwLCBsZW5ndGggPSBhbmltYXRpb24udHdlZW5zLmxlbmd0aDsKICAgICAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgIGFuaW1hdGlvbi50d2VlbnNbaW5kZXhdLnJ1bihwZXJjZW50KTsKICAgICAgICB9CiAgICAgICAgZGVmZXJyZWQubm90aWZ5V2l0aChlbGVtLCBbCiAgICAgICAgICBhbmltYXRpb24sCiAgICAgICAgICBwZXJjZW50LAogICAgICAgICAgcmVtYWluaW5nCiAgICAgICAgXSk7CiAgICAgICAgaWYgKHBlcmNlbnQgPCAxICYmIGxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIHJlbWFpbmluZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoZWxlbSwgW2FuaW1hdGlvbl0pOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSwgYW5pbWF0aW9uID0gZGVmZXJyZWQucHJvbWlzZSh7CiAgICAgICAgZWxlbTogZWxlbSwKICAgICAgICBwcm9wczogalF1ZXJ5LmV4dGVuZCh7fSwgcHJvcGVydGllcyksCiAgICAgICAgb3B0czogalF1ZXJ5LmV4dGVuZCh0cnVlLCB7IHNwZWNpYWxFYXNpbmc6IHt9IH0sIG9wdGlvbnMpLAogICAgICAgIG9yaWdpbmFsUHJvcGVydGllczogcHJvcGVydGllcywKICAgICAgICBvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgc3RhcnRUaW1lOiBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAogICAgICAgIGR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAogICAgICAgIHR3ZWVuczogW10sCiAgICAgICAgY3JlYXRlVHdlZW46IGZ1bmN0aW9uIChwcm9wLCBlbmQpIHsKICAgICAgICAgIHZhciB0d2VlbiA9IGpRdWVyeS5Ud2VlbihlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nW3Byb3BdIHx8IGFuaW1hdGlvbi5vcHRzLmVhc2luZyk7CiAgICAgICAgICBhbmltYXRpb24udHdlZW5zLnB1c2godHdlZW4pOwogICAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKGdvdG9FbmQpIHsKICAgICAgICAgIHZhciBpbmRleCA9IDAsCiAgICAgICAgICAgIC8vIGlmIHdlIGFyZSBnb2luZyB0byB0aGUgZW5kLCB3ZSB3YW50IHRvIHJ1biBhbGwgdGhlIHR3ZWVucwogICAgICAgICAgICAvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKICAgICAgICAgICAgbGVuZ3RoID0gZ290b0VuZCA/IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoIDogMDsKICAgICAgICAgIGlmIChzdG9wcGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgc3RvcHBlZCA9IHRydWU7CiAgICAgICAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgYW5pbWF0aW9uLnR3ZWVuc1tpbmRleF0ucnVuKDEpOwogICAgICAgICAgfQogICAgICAgICAgLy8gcmVzb2x2ZSB3aGVuIHdlIHBsYXllZCB0aGUgbGFzdCBmcmFtZQogICAgICAgICAgLy8gb3RoZXJ3aXNlLCByZWplY3QKICAgICAgICAgIGlmIChnb3RvRW5kKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKGVsZW0sIFsKICAgICAgICAgICAgICBhbmltYXRpb24sCiAgICAgICAgICAgICAgZ290b0VuZAogICAgICAgICAgICBdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdFdpdGgoZWxlbSwgWwogICAgICAgICAgICAgIGFuaW1hdGlvbiwKICAgICAgICAgICAgICBnb3RvRW5kCiAgICAgICAgICAgIF0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICB9KSwgcHJvcHMgPSBhbmltYXRpb24ucHJvcHM7CiAgICBwcm9wRmlsdGVyKHByb3BzLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nKTsKICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICByZXN1bHQgPSBhbmltYXRpb25QcmVmaWx0ZXJzW2luZGV4XS5jYWxsKGFuaW1hdGlvbiwgZWxlbSwgcHJvcHMsIGFuaW1hdGlvbi5vcHRzKTsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH0KICAgIGpRdWVyeS5tYXAocHJvcHMsIGNyZWF0ZVR3ZWVuLCBhbmltYXRpb24pOwogICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGFuaW1hdGlvbi5vcHRzLnN0YXJ0KSkgewogICAgICBhbmltYXRpb24ub3B0cy5zdGFydC5jYWxsKGVsZW0sIGFuaW1hdGlvbik7CiAgICB9CiAgICBqUXVlcnkuZngudGltZXIoalF1ZXJ5LmV4dGVuZCh0aWNrLCB7CiAgICAgIGVsZW06IGVsZW0sCiAgICAgIGFuaW06IGFuaW1hdGlvbiwKICAgICAgcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlCiAgICB9KSk7CiAgICAvLyBhdHRhY2ggY2FsbGJhY2tzIGZyb20gb3B0aW9ucwogICAgcmV0dXJuIGFuaW1hdGlvbi5wcm9ncmVzcyhhbmltYXRpb24ub3B0cy5wcm9ncmVzcykuZG9uZShhbmltYXRpb24ub3B0cy5kb25lLCBhbmltYXRpb24ub3B0cy5jb21wbGV0ZSkuZmFpbChhbmltYXRpb24ub3B0cy5mYWlsKS5hbHdheXMoYW5pbWF0aW9uLm9wdHMuYWx3YXlzKTsKICB9CiAgalF1ZXJ5LkFuaW1hdGlvbiA9IGpRdWVyeS5leHRlbmQoQW5pbWF0aW9uLCB7CiAgICB0d2VlbmVyOiBmdW5jdGlvbiAocHJvcHMsIGNhbGxiYWNrKSB7CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihwcm9wcykpIHsKICAgICAgICBjYWxsYmFjayA9IHByb3BzOwogICAgICAgIHByb3BzID0gWycqJ107CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvcHMgPSBwcm9wcy5zcGxpdCgnICcpOwogICAgICB9CiAgICAgIHZhciBwcm9wLCBpbmRleCA9IDAsIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKICAgICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgcHJvcCA9IHByb3BzW2luZGV4XTsKICAgICAgICB0d2VlbmVyc1twcm9wXSA9IHR3ZWVuZXJzW3Byb3BdIHx8IFtdOwogICAgICAgIHR3ZWVuZXJzW3Byb3BdLnVuc2hpZnQoY2FsbGJhY2spOwogICAgICB9CiAgICB9LAogICAgcHJlZmlsdGVyOiBmdW5jdGlvbiAoY2FsbGJhY2ssIHByZXBlbmQpIHsKICAgICAgaWYgKHByZXBlbmQpIHsKICAgICAgICBhbmltYXRpb25QcmVmaWx0ZXJzLnVuc2hpZnQoY2FsbGJhY2spOwogICAgICB9IGVsc2UgewogICAgICAgIGFuaW1hdGlvblByZWZpbHRlcnMucHVzaChjYWxsYmFjayk7CiAgICAgIH0KICAgIH0KICB9KTsKICBqUXVlcnkuc3BlZWQgPSBmdW5jdGlvbiAoc3BlZWQsIGVhc2luZywgZm4pIHsKICAgIHZhciBvcHQgPSBzcGVlZCAmJiB0eXBlb2Ygc3BlZWQgPT09ICdvYmplY3QnID8galF1ZXJ5LmV4dGVuZCh7fSwgc3BlZWQpIDogewogICAgICBjb21wbGV0ZTogZm4gfHwgIWZuICYmIGVhc2luZyB8fCBqUXVlcnkuaXNGdW5jdGlvbihzcGVlZCkgJiYgc3BlZWQsCiAgICAgIGR1cmF0aW9uOiBzcGVlZCwKICAgICAgZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmICFqUXVlcnkuaXNGdW5jdGlvbihlYXNpbmcpICYmIGVhc2luZwogICAgfTsKICAgIG9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5vZmYgPyAwIDogdHlwZW9mIG9wdC5kdXJhdGlvbiA9PT0gJ251bWJlcicgPyBvcHQuZHVyYXRpb24gOiBvcHQuZHVyYXRpb24gaW4galF1ZXJ5LmZ4LnNwZWVkcyA/IGpRdWVyeS5meC5zcGVlZHNbb3B0LmR1cmF0aW9uXSA6IGpRdWVyeS5meC5zcGVlZHMuX2RlZmF1bHQ7CiAgICAvLyBub3JtYWxpemUgb3B0LnF1ZXVlIC0gdHJ1ZS91bmRlZmluZWQvbnVsbCAtPiAiZngiCiAgICBpZiAob3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlKSB7CiAgICAgIG9wdC5xdWV1ZSA9ICdmeCc7CiAgICB9CiAgICAvLyBRdWV1ZWluZwogICAgb3B0Lm9sZCA9IG9wdC5jb21wbGV0ZTsKICAgIG9wdC5jb21wbGV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKG9wdC5vbGQpKSB7CiAgICAgICAgb3B0Lm9sZC5jYWxsKHRoaXMpOwogICAgICB9CiAgICAgIGlmIChvcHQucXVldWUpIHsKICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCBvcHQucXVldWUpOwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIG9wdDsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgZmFkZVRvOiBmdW5jdGlvbiAoc3BlZWQsIHRvLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIC8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoaXNIaWRkZW4pLmNzcygnb3BhY2l0eScsIDApLnNob3coKSAgLy8gYW5pbWF0ZSB0byB0aGUgdmFsdWUgc3BlY2lmaWVkCi5lbmQoKS5hbmltYXRlKHsgb3BhY2l0eTogdG8gfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwogICAgfSwKICAgIGFuaW1hdGU6IGZ1bmN0aW9uIChwcm9wLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICB2YXIgZW1wdHkgPSBqUXVlcnkuaXNFbXB0eU9iamVjdChwcm9wKSwgb3B0YWxsID0galF1ZXJ5LnNwZWVkKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSwgZG9BbmltYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBPcGVyYXRlIG9uIGEgY29weSBvZiBwcm9wIHNvIHBlci1wcm9wZXJ0eSBlYXNpbmcgd29uJ3QgYmUgbG9zdAogICAgICAgICAgdmFyIGFuaW0gPSBBbmltYXRpb24odGhpcywgalF1ZXJ5LmV4dGVuZCh7fSwgcHJvcCksIG9wdGFsbCk7CiAgICAgICAgICAvLyBFbXB0eSBhbmltYXRpb25zLCBvciBmaW5pc2hpbmcgcmVzb2x2ZXMgaW1tZWRpYXRlbHkKICAgICAgICAgIGlmIChlbXB0eSB8fCBkYXRhX3ByaXYuZ2V0KHRoaXMsICdmaW5pc2gnKSkgewogICAgICAgICAgICBhbmltLnN0b3AodHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgZG9BbmltYXRpb24uZmluaXNoID0gZG9BbmltYXRpb247CiAgICAgIHJldHVybiBlbXB0eSB8fCBvcHRhbGwucXVldWUgPT09IGZhbHNlID8gdGhpcy5lYWNoKGRvQW5pbWF0aW9uKSA6IHRoaXMucXVldWUob3B0YWxsLnF1ZXVlLCBkb0FuaW1hdGlvbik7CiAgICB9LAogICAgc3RvcDogZnVuY3Rpb24gKHR5cGUsIGNsZWFyUXVldWUsIGdvdG9FbmQpIHsKICAgICAgdmFyIHN0b3BRdWV1ZSA9IGZ1bmN0aW9uIChob29rcykgewogICAgICAgIHZhciBzdG9wID0gaG9va3Muc3RvcDsKICAgICAgICBkZWxldGUgaG9va3Muc3RvcDsKICAgICAgICBzdG9wKGdvdG9FbmQpOwogICAgICB9OwogICAgICBpZiAodHlwZW9mIHR5cGUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgZ290b0VuZCA9IGNsZWFyUXVldWU7CiAgICAgICAgY2xlYXJRdWV1ZSA9IHR5cGU7CiAgICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBpZiAoY2xlYXJRdWV1ZSAmJiB0eXBlICE9PSBmYWxzZSkgewogICAgICAgIHRoaXMucXVldWUodHlwZSB8fCAnZngnLCBbXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRlcXVldWUgPSB0cnVlLCBpbmRleCA9IHR5cGUgIT0gbnVsbCAmJiB0eXBlICsgJ3F1ZXVlSG9va3MnLCB0aW1lcnMgPSBqUXVlcnkudGltZXJzLCBkYXRhID0gZGF0YV9wcml2LmdldCh0aGlzKTsKICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgIGlmIChkYXRhW2luZGV4XSAmJiBkYXRhW2luZGV4XS5zdG9wKSB7CiAgICAgICAgICAgIHN0b3BRdWV1ZShkYXRhW2luZGV4XSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaW5kZXggaW4gZGF0YSkgewogICAgICAgICAgICBpZiAoZGF0YVtpbmRleF0gJiYgZGF0YVtpbmRleF0uc3RvcCAmJiBycnVuLnRlc3QoaW5kZXgpKSB7CiAgICAgICAgICAgICAgc3RvcFF1ZXVlKGRhdGFbaW5kZXhdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTspIHsKICAgICAgICAgIGlmICh0aW1lcnNbaW5kZXhdLmVsZW0gPT09IHRoaXMgJiYgKHR5cGUgPT0gbnVsbCB8fCB0aW1lcnNbaW5kZXhdLnF1ZXVlID09PSB0eXBlKSkgewogICAgICAgICAgICB0aW1lcnNbaW5kZXhdLmFuaW0uc3RvcChnb3RvRW5kKTsKICAgICAgICAgICAgZGVxdWV1ZSA9IGZhbHNlOwogICAgICAgICAgICB0aW1lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gc3RhcnQgdGhlIG5leHQgaW4gdGhlIHF1ZXVlIGlmIHRoZSBsYXN0IHN0ZXAgd2Fzbid0IGZvcmNlZAogICAgICAgIC8vIHRpbWVycyBjdXJyZW50bHkgd2lsbCBjYWxsIHRoZWlyIGNvbXBsZXRlIGNhbGxiYWNrcywgd2hpY2ggd2lsbCBkZXF1ZXVlCiAgICAgICAgLy8gYnV0IG9ubHkgaWYgdGhleSB3ZXJlIGdvdG9FbmQKICAgICAgICBpZiAoZGVxdWV1ZSB8fCAhZ290b0VuZCkgewogICAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgdHlwZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBmaW5pc2g6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIGlmICh0eXBlICE9PSBmYWxzZSkgewogICAgICAgIHR5cGUgPSB0eXBlIHx8ICdmeCc7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGluZGV4LCBkYXRhID0gZGF0YV9wcml2LmdldCh0aGlzKSwgcXVldWUgPSBkYXRhW3R5cGUgKyAncXVldWUnXSwgaG9va3MgPSBkYXRhW3R5cGUgKyAncXVldWVIb29rcyddLCB0aW1lcnMgPSBqUXVlcnkudGltZXJzLCBsZW5ndGggPSBxdWV1ZSA/IHF1ZXVlLmxlbmd0aCA6IDA7CiAgICAgICAgLy8gZW5hYmxlIGZpbmlzaGluZyBmbGFnIG9uIHByaXZhdGUgZGF0YQogICAgICAgIGRhdGEuZmluaXNoID0gdHJ1ZTsKICAgICAgICAvLyBlbXB0eSB0aGUgcXVldWUgZmlyc3QKICAgICAgICBqUXVlcnkucXVldWUodGhpcywgdHlwZSwgW10pOwogICAgICAgIGlmIChob29rcyAmJiBob29rcy5zdG9wKSB7CiAgICAgICAgICBob29rcy5zdG9wLmNhbGwodGhpcywgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIC8vIGxvb2sgZm9yIGFueSBhY3RpdmUgYW5pbWF0aW9ucywgYW5kIGZpbmlzaCB0aGVtCiAgICAgICAgZm9yIChpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07KSB7CiAgICAgICAgICBpZiAodGltZXJzW2luZGV4XS5lbGVtID09PSB0aGlzICYmIHRpbWVyc1tpbmRleF0ucXVldWUgPT09IHR5cGUpIHsKICAgICAgICAgICAgdGltZXJzW2luZGV4XS5hbmltLnN0b3AodHJ1ZSk7CiAgICAgICAgICAgIHRpbWVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBsb29rIGZvciBhbnkgYW5pbWF0aW9ucyBpbiB0aGUgb2xkIHF1ZXVlIGFuZCBmaW5pc2ggdGhlbQogICAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgaWYgKHF1ZXVlW2luZGV4XSAmJiBxdWV1ZVtpbmRleF0uZmluaXNoKSB7CiAgICAgICAgICAgIHF1ZXVlW2luZGV4XS5maW5pc2guY2FsbCh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gdHVybiBvZmYgZmluaXNoaW5nIGZsYWcKICAgICAgICBkZWxldGUgZGF0YS5maW5pc2g7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKFsKICAgICd0b2dnbGUnLAogICAgJ3Nob3cnLAogICAgJ2hpZGUnCiAgXSwgZnVuY3Rpb24gKGksIG5hbWUpIHsKICAgIHZhciBjc3NGbiA9IGpRdWVyeS5mbltuYW1lXTsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICdib29sZWFuJyA/IGNzc0ZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiB0aGlzLmFuaW1hdGUoZ2VuRngobmFtZSwgdHJ1ZSksIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKICAgIH07CiAgfSk7CiAgLy8gR2VuZXJhdGUgc2hvcnRjdXRzIGZvciBjdXN0b20gYW5pbWF0aW9ucwogIGpRdWVyeS5lYWNoKHsKICAgIHNsaWRlRG93bjogZ2VuRngoJ3Nob3cnKSwKICAgIHNsaWRlVXA6IGdlbkZ4KCdoaWRlJyksCiAgICBzbGlkZVRvZ2dsZTogZ2VuRngoJ3RvZ2dsZScpLAogICAgZmFkZUluOiB7IG9wYWNpdHk6ICdzaG93JyB9LAogICAgZmFkZU91dDogeyBvcGFjaXR5OiAnaGlkZScgfSwKICAgIGZhZGVUb2dnbGU6IHsgb3BhY2l0eTogJ3RvZ2dsZScgfQogIH0sIGZ1bmN0aW9uIChuYW1lLCBwcm9wcykgewogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLmFuaW1hdGUocHJvcHMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKICAgIH07CiAgfSk7CiAgalF1ZXJ5LnRpbWVycyA9IFtdOwogIGpRdWVyeS5meC50aWNrID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHRpbWVyLCBpID0gMCwgdGltZXJzID0galF1ZXJ5LnRpbWVyczsKICAgIGZ4Tm93ID0galF1ZXJ5Lm5vdygpOwogICAgZm9yICg7IGkgPCB0aW1lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgdGltZXIgPSB0aW1lcnNbaV07CiAgICAgIC8vIENoZWNrcyB0aGUgdGltZXIgaGFzIG5vdCBhbHJlYWR5IGJlZW4gcmVtb3ZlZAogICAgICBpZiAoIXRpbWVyKCkgJiYgdGltZXJzW2ldID09PSB0aW1lcikgewogICAgICAgIHRpbWVycy5zcGxpY2UoaS0tLCAxKTsKICAgICAgfQogICAgfQogICAgaWYgKCF0aW1lcnMubGVuZ3RoKSB7CiAgICAgIGpRdWVyeS5meC5zdG9wKCk7CiAgICB9CiAgICBmeE5vdyA9IHVuZGVmaW5lZDsKICB9OwogIGpRdWVyeS5meC50aW1lciA9IGZ1bmN0aW9uICh0aW1lcikgewogICAgalF1ZXJ5LnRpbWVycy5wdXNoKHRpbWVyKTsKICAgIGlmICh0aW1lcigpKSB7CiAgICAgIGpRdWVyeS5meC5zdGFydCgpOwogICAgfSBlbHNlIHsKICAgICAgalF1ZXJ5LnRpbWVycy5wb3AoKTsKICAgIH0KICB9OwogIGpRdWVyeS5meC5pbnRlcnZhbCA9IDEzOwogIGpRdWVyeS5meC5zdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghdGltZXJJZCkgewogICAgICB0aW1lcklkID0gc2V0SW50ZXJ2YWwoalF1ZXJ5LmZ4LnRpY2ssIGpRdWVyeS5meC5pbnRlcnZhbCk7CiAgICB9CiAgfTsKICBqUXVlcnkuZnguc3RvcCA9IGZ1bmN0aW9uICgpIHsKICAgIGNsZWFySW50ZXJ2YWwodGltZXJJZCk7CiAgICB0aW1lcklkID0gbnVsbDsKICB9OwogIGpRdWVyeS5meC5zcGVlZHMgPSB7CiAgICBzbG93OiA2MDAsCiAgICBmYXN0OiAyMDAsCiAgICAvLyBEZWZhdWx0IHNwZWVkCiAgICBfZGVmYXVsdDogNDAwCiAgfTsKICAvLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uCiAgLy8gaHR0cDovL2JsaW5kc2lnbmFscy5jb20vaW5kZXgucGhwLzIwMDkvMDcvanF1ZXJ5LWRlbGF5LwogIGpRdWVyeS5mbi5kZWxheSA9IGZ1bmN0aW9uICh0aW1lLCB0eXBlKSB7CiAgICB0aW1lID0galF1ZXJ5LmZ4ID8galF1ZXJ5LmZ4LnNwZWVkc1t0aW1lXSB8fCB0aW1lIDogdGltZTsKICAgIHR5cGUgPSB0eXBlIHx8ICdmeCc7CiAgICByZXR1cm4gdGhpcy5xdWV1ZSh0eXBlLCBmdW5jdGlvbiAobmV4dCwgaG9va3MpIHsKICAgICAgdmFyIHRpbWVvdXQgPSBzZXRUaW1lb3V0KG5leHQsIHRpbWUpOwogICAgICBob29rcy5zdG9wID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgKGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0JyksIHNlbGVjdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NlbGVjdCcpLCBvcHQgPSBzZWxlY3QuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJykpOwogICAgaW5wdXQudHlwZSA9ICdjaGVja2JveCc7CiAgICAvLyBTdXBwb3J0OiBpT1MgNS4xLCBBbmRyb2lkIDQueCwgQW5kcm9pZCAyLjMKICAgIC8vIENoZWNrIHRoZSBkZWZhdWx0IGNoZWNrYm94L3JhZGlvIHZhbHVlICgiIiBvbiBvbGQgV2ViS2l0OyAib24iIGVsc2V3aGVyZSkKICAgIHN1cHBvcnQuY2hlY2tPbiA9IGlucHV0LnZhbHVlICE9PSAnJzsKICAgIC8vIE11c3QgYWNjZXNzIHRoZSBwYXJlbnQgdG8gbWFrZSBhbiBvcHRpb24gc2VsZWN0IHByb3Blcmx5CiAgICAvLyBTdXBwb3J0OiBJRTksIElFMTAKICAgIHN1cHBvcnQub3B0U2VsZWN0ZWQgPSBvcHQuc2VsZWN0ZWQ7CiAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgb3B0aW9ucyBpbnNpZGUgZGlzYWJsZWQgc2VsZWN0cyBhcmVuJ3QgbWFya2VkIGFzIGRpc2FibGVkCiAgICAvLyAoV2ViS2l0IG1hcmtzIHRoZW0gYXMgZGlzYWJsZWQpCiAgICBzZWxlY3QuZGlzYWJsZWQgPSB0cnVlOwogICAgc3VwcG9ydC5vcHREaXNhYmxlZCA9ICFvcHQuZGlzYWJsZWQ7CiAgICAvLyBDaGVjayBpZiBhbiBpbnB1dCBtYWludGFpbnMgaXRzIHZhbHVlIGFmdGVyIGJlY29taW5nIGEgcmFkaW8KICAgIC8vIFN1cHBvcnQ6IElFOSwgSUUxMAogICAgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOwogICAgaW5wdXQudmFsdWUgPSAndCc7CiAgICBpbnB1dC50eXBlID0gJ3JhZGlvJzsKICAgIHN1cHBvcnQucmFkaW9WYWx1ZSA9IGlucHV0LnZhbHVlID09PSAndCc7CiAgfSgpKTsKICB2YXIgbm9kZUhvb2ssIGJvb2xIb29rLCBhdHRySGFuZGxlID0galF1ZXJ5LmV4cHIuYXR0ckhhbmRsZTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGF0dHI6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGpRdWVyeS5hdHRyLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfSwKICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeS5yZW1vdmVBdHRyKHRoaXMsIG5hbWUpOwogICAgICB9KTsKICAgIH0KICB9KTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIGF0dHI6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSkgewogICAgICB2YXIgaG9va3MsIHJldCwgblR5cGUgPSBlbGVtLm5vZGVUeXBlOwogICAgICAvLyBkb24ndCBnZXQvc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCiAgICAgIGlmICghZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBGYWxsYmFjayB0byBwcm9wIHdoZW4gYXR0cmlidXRlcyBhcmUgbm90IHN1cHBvcnRlZAogICAgICBpZiAodHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlID09PSBzdHJ1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4galF1ZXJ5LnByb3AoZWxlbSwgbmFtZSwgdmFsdWUpOwogICAgICB9CiAgICAgIC8vIEFsbCBhdHRyaWJ1dGVzIGFyZSBsb3dlcmNhc2UKICAgICAgLy8gR3JhYiBuZWNlc3NhcnkgaG9vayBpZiBvbmUgaXMgZGVmaW5lZAogICAgICBpZiAoblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyhlbGVtKSkgewogICAgICAgIG5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzW25hbWVdIHx8IChqUXVlcnkuZXhwci5tYXRjaC5ib29sLnRlc3QobmFtZSkgPyBib29sSG9vayA6IG5vZGVIb29rKTsKICAgICAgfQogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIoZWxlbSwgbmFtZSk7CiAgICAgICAgfSBlbHNlIGlmIChob29rcyAmJiAnc2V0JyBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KGVsZW0sIHZhbHVlLCBuYW1lKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUgKyAnJyk7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGhvb2tzICYmICdnZXQnIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgbmFtZSkpICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXQgPSBqUXVlcnkuZmluZC5hdHRyKGVsZW0sIG5hbWUpOwogICAgICAgIC8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCiAgICAgICAgcmV0dXJuIHJldCA9PSBudWxsID8gdW5kZWZpbmVkIDogcmV0OwogICAgICB9CiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgIHZhciBuYW1lLCBwcm9wTmFtZSwgaSA9IDAsIGF0dHJOYW1lcyA9IHZhbHVlICYmIHZhbHVlLm1hdGNoKHJub3R3aGl0ZSk7CiAgICAgIGlmIChhdHRyTmFtZXMgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgIHdoaWxlIChuYW1lID0gYXR0ck5hbWVzW2krK10pIHsKICAgICAgICAgIHByb3BOYW1lID0galF1ZXJ5LnByb3BGaXhbbmFtZV0gfHwgbmFtZTsKICAgICAgICAgIC8vIEJvb2xlYW4gYXR0cmlidXRlcyBnZXQgc3BlY2lhbCB0cmVhdG1lbnQgKCMxMDg3MCkKICAgICAgICAgIGlmIChqUXVlcnkuZXhwci5tYXRjaC5ib29sLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgLy8gU2V0IGNvcnJlc3BvbmRpbmcgcHJvcGVydHkgdG8gZmFsc2UKICAgICAgICAgICAgZWxlbVtwcm9wTmFtZV0gPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGF0dHJIb29rczogewogICAgICB0eXBlOiB7CiAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgICAgIGlmICghc3VwcG9ydC5yYWRpb1ZhbHVlICYmIHZhbHVlID09PSAncmFkaW8nICYmIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAnaW5wdXQnKSkgewogICAgICAgICAgICAvLyBTZXR0aW5nIHRoZSB0eXBlIG9uIGEgcmFkaW8gYnV0dG9uIGFmdGVyIHRoZSB2YWx1ZSByZXNldHMgdGhlIHZhbHVlIGluIElFNi05CiAgICAgICAgICAgIC8vIFJlc2V0IHZhbHVlIHRvIGRlZmF1bHQgaW4gY2FzZSB0eXBlIGlzIHNldCBhZnRlciB2YWx1ZSBkdXJpbmcgY3JlYXRpb24KICAgICAgICAgICAgdmFyIHZhbCA9IGVsZW0udmFsdWU7CiAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCd0eXBlJywgdmFsdWUpOwogICAgICAgICAgICBpZiAodmFsKSB7CiAgICAgICAgICAgICAgZWxlbS52YWx1ZSA9IHZhbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgLy8gSG9va3MgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwogIGJvb2xIb29rID0gewogICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUsIG5hbWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIC8vIFJlbW92ZSBib29sZWFuIGF0dHJpYnV0ZXMgd2hlbiBzZXQgdG8gZmFsc2UKICAgICAgICBqUXVlcnkucmVtb3ZlQXR0cihlbGVtLCBuYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZShuYW1lLCBuYW1lKTsKICAgICAgfQogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9OwogIGpRdWVyeS5lYWNoKGpRdWVyeS5leHByLm1hdGNoLmJvb2wuc291cmNlLm1hdGNoKC9cdysvZyksIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICB2YXIgZ2V0dGVyID0gYXR0ckhhbmRsZVtuYW1lXSB8fCBqUXVlcnkuZmluZC5hdHRyOwogICAgYXR0ckhhbmRsZVtuYW1lXSA9IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBpc1hNTCkgewogICAgICB2YXIgcmV0LCBoYW5kbGU7CiAgICAgIGlmICghaXNYTUwpIHsKICAgICAgICAvLyBBdm9pZCBhbiBpbmZpbml0ZSBsb29wIGJ5IHRlbXBvcmFyaWx5IHJlbW92aW5nIHRoaXMgZnVuY3Rpb24gZnJvbSB0aGUgZ2V0dGVyCiAgICAgICAgaGFuZGxlID0gYXR0ckhhbmRsZVtuYW1lXTsKICAgICAgICBhdHRySGFuZGxlW25hbWVdID0gcmV0OwogICAgICAgIHJldCA9IGdldHRlcihlbGVtLCBuYW1lLCBpc1hNTCkgIT0gbnVsbCA/IG5hbWUudG9Mb3dlckNhc2UoKSA6IG51bGw7CiAgICAgICAgYXR0ckhhbmRsZVtuYW1lXSA9IGhhbmRsZTsKICAgICAgfQogICAgICByZXR1cm4gcmV0OwogICAgfTsKICB9KTsKICB2YXIgcmZvY3VzYWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbikkL2k7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBwcm9wOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBqUXVlcnkucHJvcCwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxKTsKICAgIH0sCiAgICByZW1vdmVQcm9wOiBmdW5jdGlvbiAobmFtZSkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBkZWxldGUgdGhpc1tqUXVlcnkucHJvcEZpeFtuYW1lXSB8fCBuYW1lXTsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBwcm9wRml4OiB7CiAgICAgICdmb3InOiAnaHRtbEZvcicsCiAgICAgICdjbGFzcyc6ICdjbGFzc05hbWUnCiAgICB9LAogICAgcHJvcDogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciByZXQsIGhvb2tzLCBub3R4bWwsIG5UeXBlID0gZWxlbS5ub2RlVHlwZTsKICAgICAgLy8gZG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwogICAgICBpZiAoIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbm90eG1sID0gblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyhlbGVtKTsKICAgICAgaWYgKG5vdHhtbCkgewogICAgICAgIC8vIEZpeCBuYW1lIGFuZCBhdHRhY2ggaG9va3MKICAgICAgICBuYW1lID0galF1ZXJ5LnByb3BGaXhbbmFtZV0gfHwgbmFtZTsKICAgICAgICBob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbbmFtZV07CiAgICAgIH0KICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gaG9va3MgJiYgJ3NldCcgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldChlbGVtLCB2YWx1ZSwgbmFtZSkpICE9PSB1bmRlZmluZWQgPyByZXQgOiBlbGVtW25hbWVdID0gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGhvb2tzICYmICdnZXQnIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgbmFtZSkpICE9PSBudWxsID8gcmV0IDogZWxlbVtuYW1lXTsKICAgICAgfQogICAgfSwKICAgIHByb3BIb29rczogewogICAgICB0YWJJbmRleDogewogICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBlbGVtLmhhc0F0dHJpYnV0ZSgndGFiaW5kZXgnKSB8fCByZm9jdXNhYmxlLnRlc3QoZWxlbS5ub2RlTmFtZSkgfHwgZWxlbS5ocmVmID8gZWxlbS50YWJJbmRleCA6IC0xOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwogIC8vIFN1cHBvcnQ6IElFOSsKICAvLyBTZWxlY3RlZG5lc3MgZm9yIGFuIG9wdGlvbiBpbiBhbiBvcHRncm91cCBjYW4gYmUgaW5hY2N1cmF0ZQogIGlmICghc3VwcG9ydC5vcHRTZWxlY3RlZCkgewogICAgalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCA9IHsKICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CiAgICAgICAgaWYgKHBhcmVudCAmJiBwYXJlbnQucGFyZW50Tm9kZSkgewogICAgICAgICAgcGFyZW50LnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH07CiAgfQogIGpRdWVyeS5lYWNoKFsKICAgICd0YWJJbmRleCcsCiAgICAncmVhZE9ubHknLAogICAgJ21heExlbmd0aCcsCiAgICAnY2VsbFNwYWNpbmcnLAogICAgJ2NlbGxQYWRkaW5nJywKICAgICdyb3dTcGFuJywKICAgICdjb2xTcGFuJywKICAgICd1c2VNYXAnLAogICAgJ2ZyYW1lQm9yZGVyJywKICAgICdjb250ZW50RWRpdGFibGUnCiAgXSwgZnVuY3Rpb24gKCkgewogICAgalF1ZXJ5LnByb3BGaXhbdGhpcy50b0xvd2VyQ2FzZSgpXSA9IHRoaXM7CiAgfSk7CiAgdmFyIHJjbGFzcyA9IC9bXHRcclxuXGZdL2c7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBhZGRDbGFzczogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhciBjbGFzc2VzLCBlbGVtLCBjdXIsIGNsYXp6LCBqLCBmaW5hbFZhbHVlLCBwcm9jZWVkID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiB2YWx1ZSwgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaikgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLmFkZENsYXNzKHZhbHVlLmNhbGwodGhpcywgaiwgdGhpcy5jbGFzc05hbWUpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAocHJvY2VlZCkgewogICAgICAgIC8vIFRoZSBkaXNqdW5jdGlvbiBoZXJlIGlzIGZvciBiZXR0ZXIgY29tcHJlc3NpYmlsaXR5IChzZWUgcmVtb3ZlQ2xhc3MpCiAgICAgICAgY2xhc3NlcyA9ICh2YWx1ZSB8fCAnJykubWF0Y2gocm5vdHdoaXRlKSB8fCBbXTsKICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBlbGVtID0gdGhpc1tpXTsKICAgICAgICAgIGN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKGVsZW0uY2xhc3NOYW1lID8gKCcgJyArIGVsZW0uY2xhc3NOYW1lICsgJyAnKS5yZXBsYWNlKHJjbGFzcywgJyAnKSA6ICcgJyk7CiAgICAgICAgICBpZiAoY3VyKSB7CiAgICAgICAgICAgIGogPSAwOwogICAgICAgICAgICB3aGlsZSAoY2xhenogPSBjbGFzc2VzW2orK10pIHsKICAgICAgICAgICAgICBpZiAoY3VyLmluZGV4T2YoJyAnICsgY2xhenogKyAnICcpIDwgMCkgewogICAgICAgICAgICAgICAgY3VyICs9IGNsYXp6ICsgJyAnOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBvbmx5IGFzc2lnbiBpZiBkaWZmZXJlbnQgdG8gYXZvaWQgdW5uZWVkZWQgcmVuZGVyaW5nLgogICAgICAgICAgICBmaW5hbFZhbHVlID0galF1ZXJ5LnRyaW0oY3VyKTsKICAgICAgICAgICAgaWYgKGVsZW0uY2xhc3NOYW1lICE9PSBmaW5hbFZhbHVlKSB7CiAgICAgICAgICAgICAgZWxlbS5jbGFzc05hbWUgPSBmaW5hbFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY2xhenosIGosIGZpbmFsVmFsdWUsIHByb2NlZWQgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgJiYgdmFsdWUsIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGopIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS5yZW1vdmVDbGFzcyh2YWx1ZS5jYWxsKHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHByb2NlZWQpIHsKICAgICAgICBjbGFzc2VzID0gKHZhbHVlIHx8ICcnKS5tYXRjaChybm90d2hpdGUpIHx8IFtdOwogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGVsZW0gPSB0aGlzW2ldOwogICAgICAgICAgLy8gVGhpcyBleHByZXNzaW9uIGlzIGhlcmUgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSBhZGRDbGFzcykKICAgICAgICAgIGN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKGVsZW0uY2xhc3NOYW1lID8gKCcgJyArIGVsZW0uY2xhc3NOYW1lICsgJyAnKS5yZXBsYWNlKHJjbGFzcywgJyAnKSA6ICcnKTsKICAgICAgICAgIGlmIChjdXIpIHsKICAgICAgICAgICAgaiA9IDA7CiAgICAgICAgICAgIHdoaWxlIChjbGF6eiA9IGNsYXNzZXNbaisrXSkgewogICAgICAgICAgICAgIC8vIFJlbW92ZSAqYWxsKiBpbnN0YW5jZXMKICAgICAgICAgICAgICB3aGlsZSAoY3VyLmluZGV4T2YoJyAnICsgY2xhenogKyAnICcpID49IDApIHsKICAgICAgICAgICAgICAgIGN1ciA9IGN1ci5yZXBsYWNlKCcgJyArIGNsYXp6ICsgJyAnLCAnICcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBvbmx5IGFzc2lnbiBpZiBkaWZmZXJlbnQgdG8gYXZvaWQgdW5uZWVkZWQgcmVuZGVyaW5nLgogICAgICAgICAgICBmaW5hbFZhbHVlID0gdmFsdWUgPyBqUXVlcnkudHJpbShjdXIpIDogJyc7CiAgICAgICAgICAgIGlmIChlbGVtLmNsYXNzTmFtZSAhPT0gZmluYWxWYWx1ZSkgewogICAgICAgICAgICAgIGVsZW0uY2xhc3NOYW1lID0gZmluYWxWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKHZhbHVlLCBzdGF0ZVZhbCkgewogICAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKICAgICAgaWYgKHR5cGVvZiBzdGF0ZVZhbCA9PT0gJ2Jvb2xlYW4nICYmIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIHN0YXRlVmFsID8gdGhpcy5hZGRDbGFzcyh2YWx1ZSkgOiB0aGlzLnJlbW92ZUNsYXNzKHZhbHVlKTsKICAgICAgfQogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLnRvZ2dsZUNsYXNzKHZhbHVlLmNhbGwodGhpcywgaSwgdGhpcy5jbGFzc05hbWUsIHN0YXRlVmFsKSwgc3RhdGVWYWwpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykgewogICAgICAgICAgLy8gdG9nZ2xlIGluZGl2aWR1YWwgY2xhc3MgbmFtZXMKICAgICAgICAgIHZhciBjbGFzc05hbWUsIGkgPSAwLCBzZWxmID0galF1ZXJ5KHRoaXMpLCBjbGFzc05hbWVzID0gdmFsdWUubWF0Y2gocm5vdHdoaXRlKSB8fCBbXTsKICAgICAgICAgIHdoaWxlIChjbGFzc05hbWUgPSBjbGFzc05hbWVzW2krK10pIHsKICAgICAgICAgICAgLy8gY2hlY2sgZWFjaCBjbGFzc05hbWUgZ2l2ZW4sIHNwYWNlIHNlcGFyYXRlZCBsaXN0CiAgICAgICAgICAgIGlmIChzZWxmLmhhc0NsYXNzKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICBzZWxmLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZi5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9ICAvLyBUb2dnbGUgd2hvbGUgY2xhc3MgbmFtZQogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gc3RydW5kZWZpbmVkIHx8IHR5cGUgPT09ICdib29sZWFuJykgewogICAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIC8vIHN0b3JlIGNsYXNzTmFtZSBpZiBzZXQKICAgICAgICAgICAgZGF0YV9wcml2LnNldCh0aGlzLCAnX19jbGFzc05hbWVfXycsIHRoaXMuY2xhc3NOYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIElmIHRoZSBlbGVtZW50IGhhcyBhIGNsYXNzIG5hbWUgb3IgaWYgd2UncmUgcGFzc2VkICJmYWxzZSIsCiAgICAgICAgICAvLyB0aGVuIHJlbW92ZSB0aGUgd2hvbGUgY2xhc3NuYW1lIChpZiB0aGVyZSB3YXMgb25lLCB0aGUgYWJvdmUgc2F2ZWQgaXQpLgogICAgICAgICAgLy8gT3RoZXJ3aXNlIGJyaW5nIGJhY2sgd2hhdGV2ZXIgd2FzIHByZXZpb3VzbHkgc2F2ZWQgKGlmIGFueXRoaW5nKSwKICAgICAgICAgIC8vIGZhbGxpbmcgYmFjayB0byB0aGUgZW1wdHkgc3RyaW5nIGlmIG5vdGhpbmcgd2FzIHN0b3JlZC4KICAgICAgICAgIHRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUgfHwgdmFsdWUgPT09IGZhbHNlID8gJycgOiBkYXRhX3ByaXYuZ2V0KHRoaXMsICdfX2NsYXNzTmFtZV9fJykgfHwgJyc7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHZhciBjbGFzc05hbWUgPSAnICcgKyBzZWxlY3RvciArICcgJywgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsKICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAodGhpc1tpXS5ub2RlVHlwZSA9PT0gMSAmJiAoJyAnICsgdGhpc1tpXS5jbGFzc05hbWUgKyAnICcpLnJlcGxhY2UocmNsYXNzLCAnICcpLmluZGV4T2YoY2xhc3NOYW1lKSA+PSAwKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0pOwogIHZhciBycmV0dXJuID0gL1xyL2c7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB2YWw6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIgaG9va3MsIHJldCwgaXNGdW5jdGlvbiwgZWxlbSA9IHRoaXNbMF07CiAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICBob29rcyA9IGpRdWVyeS52YWxIb29rc1tlbGVtLnR5cGVdIHx8IGpRdWVyeS52YWxIb29rc1tlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgICAgaWYgKGhvb2tzICYmICdnZXQnIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgJ3ZhbHVlJykpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgIH0KICAgICAgICAgIHJldCA9IGVsZW0udmFsdWU7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIHJldCA9PT0gJ3N0cmluZycgPyAvLyBoYW5kbGUgbW9zdCBjb21tb24gc3RyaW5nIGNhc2VzCiAgICAgICAgICByZXQucmVwbGFjZShycmV0dXJuLCAnJykgOiAvLyBoYW5kbGUgY2FzZXMgd2hlcmUgdmFsdWUgaXMgbnVsbC91bmRlZiBvciBudW1iZXIKICAgICAgICAgIHJldCA9PSBudWxsID8gJycgOiByZXQ7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpOwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgdmFyIHZhbDsKICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNGdW5jdGlvbikgewogICAgICAgICAgdmFsID0gdmFsdWUuY2FsbCh0aGlzLCBpLCBqUXVlcnkodGhpcykudmFsKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YWwgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgLy8gVHJlYXQgbnVsbC91bmRlZmluZWQgYXMgIiI7IGNvbnZlcnQgbnVtYmVycyB0byBzdHJpbmcKICAgICAgICBpZiAodmFsID09IG51bGwpIHsKICAgICAgICAgIHZhbCA9ICcnOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHZhbCArPSAnJzsKICAgICAgICB9IGVsc2UgaWYgKGpRdWVyeS5pc0FycmF5KHZhbCkpIHsKICAgICAgICAgIHZhbCA9IGpRdWVyeS5tYXAodmFsLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgPyAnJyA6IHZhbHVlICsgJyc7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaG9va3MgPSBqUXVlcnkudmFsSG9va3NbdGhpcy50eXBlXSB8fCBqUXVlcnkudmFsSG9va3NbdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICAvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwogICAgICAgIGlmICghaG9va3MgfHwgISgnc2V0JyBpbiBob29rcykgfHwgaG9va3Muc2V0KHRoaXMsIHZhbCwgJ3ZhbHVlJykgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgdmFsSG9va3M6IHsKICAgICAgb3B0aW9uOiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgdmFyIHZhbCA9IGpRdWVyeS5maW5kLmF0dHIoZWxlbSwgJ3ZhbHVlJyk7CiAgICAgICAgICByZXR1cm4gdmFsICE9IG51bGwgPyB2YWwgOiAvLyBTdXBwb3J0OiBJRTEwLTExKwogICAgICAgICAgLy8gb3B0aW9uLnRleHQgdGhyb3dzIGV4Y2VwdGlvbnMgKCMxNDY4NiwgIzE0ODU4KQogICAgICAgICAgalF1ZXJ5LnRyaW0oalF1ZXJ5LnRleHQoZWxlbSkpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2VsZWN0OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgdmFyIHZhbHVlLCBvcHRpb24sIG9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsIGluZGV4ID0gZWxlbS5zZWxlY3RlZEluZGV4LCBvbmUgPSBlbGVtLnR5cGUgPT09ICdzZWxlY3Qtb25lJyB8fCBpbmRleCA8IDAsIHZhbHVlcyA9IG9uZSA/IG51bGwgOiBbXSwgbWF4ID0gb25lID8gaW5kZXggKyAxIDogb3B0aW9ucy5sZW5ndGgsIGkgPSBpbmRleCA8IDAgPyBtYXggOiBvbmUgPyBpbmRleCA6IDA7CiAgICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBzZWxlY3RlZCBvcHRpb25zCiAgICAgICAgICBmb3IgKDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbnNbaV07CiAgICAgICAgICAgIC8vIElFNi05IGRvZXNuJ3QgdXBkYXRlIHNlbGVjdGVkIGFmdGVyIGZvcm0gcmVzZXQgKCMyNTUxKQogICAgICAgICAgICBpZiAoKG9wdGlvbi5zZWxlY3RlZCB8fCBpID09PSBpbmRleCkgJiYgKHN1cHBvcnQub3B0RGlzYWJsZWQgPyAhb3B0aW9uLmRpc2FibGVkIDogb3B0aW9uLmdldEF0dHJpYnV0ZSgnZGlzYWJsZWQnKSA9PT0gbnVsbCkgJiYgKCFvcHRpb24ucGFyZW50Tm9kZS5kaXNhYmxlZCB8fCAhalF1ZXJ5Lm5vZGVOYW1lKG9wdGlvbi5wYXJlbnROb2RlLCAnb3B0Z3JvdXAnKSkpIHsKICAgICAgICAgICAgICAvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uCiAgICAgICAgICAgICAgdmFsdWUgPSBqUXVlcnkob3B0aW9uKS52YWwoKTsKICAgICAgICAgICAgICAvLyBXZSBkb24ndCBuZWVkIGFuIGFycmF5IGZvciBvbmUgc2VsZWN0cwogICAgICAgICAgICAgIGlmIChvbmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgdmFyIG9wdGlvblNldCwgb3B0aW9uLCBvcHRpb25zID0gZWxlbS5vcHRpb25zLCB2YWx1ZXMgPSBqUXVlcnkubWFrZUFycmF5KHZhbHVlKSwgaSA9IG9wdGlvbnMubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICBvcHRpb24gPSBvcHRpb25zW2ldOwogICAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkID0galF1ZXJ5LmluQXJyYXkob3B0aW9uLnZhbHVlLCB2YWx1ZXMpID49IDApIHsKICAgICAgICAgICAgICBvcHRpb25TZXQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBmb3JjZSBicm93c2VycyB0byBiZWhhdmUgY29uc2lzdGVudGx5IHdoZW4gbm9uLW1hdGNoaW5nIHZhbHVlIGlzIHNldAogICAgICAgICAgaWYgKCFvcHRpb25TZXQpIHsKICAgICAgICAgICAgZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwogIC8vIFJhZGlvcyBhbmQgY2hlY2tib3hlcyBnZXR0ZXIvc2V0dGVyCiAgalF1ZXJ5LmVhY2goWwogICAgJ3JhZGlvJywKICAgICdjaGVja2JveCcKICBdLCBmdW5jdGlvbiAoKSB7CiAgICBqUXVlcnkudmFsSG9va3NbdGhpc10gPSB7CiAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uY2hlY2tlZCA9IGpRdWVyeS5pbkFycmF5KGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUpID49IDA7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgaWYgKCFzdXBwb3J0LmNoZWNrT24pIHsKICAgICAgalF1ZXJ5LnZhbEhvb2tzW3RoaXNdLmdldCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgLy8gU3VwcG9ydDogV2Via2l0CiAgICAgICAgLy8gIiIgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiAib24iIGlmIGEgdmFsdWUgaXNuJ3Qgc3BlY2lmaWVkCiAgICAgICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCd2YWx1ZScpID09PSBudWxsID8gJ29uJyA6IGVsZW0udmFsdWU7CiAgICAgIH07CiAgICB9CiAgfSk7CiAgLy8gUmV0dXJuIGpRdWVyeSBmb3IgYXR0cmlidXRlcy1vbmx5IGluY2x1c2lvbgogIGpRdWVyeS5lYWNoKCgnYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgJyArICdtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAnICsgJ2NoYW5nZSBzZWxlY3Qgc3VibWl0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3IgY29udGV4dG1lbnUnKS5zcGxpdCgnICcpLCBmdW5jdGlvbiAoaSwgbmFtZSkgewogICAgLy8gSGFuZGxlIGV2ZW50IGJpbmRpbmcKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uIChkYXRhLCBmbikgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDAgPyB0aGlzLm9uKG5hbWUsIG51bGwsIGRhdGEsIGZuKSA6IHRoaXMudHJpZ2dlcihuYW1lKTsKICAgIH07CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBob3ZlcjogZnVuY3Rpb24gKGZuT3ZlciwgZm5PdXQpIHsKICAgICAgcmV0dXJuIHRoaXMubW91c2VlbnRlcihmbk92ZXIpLm1vdXNlbGVhdmUoZm5PdXQgfHwgZm5PdmVyKTsKICAgIH0sCiAgICBiaW5kOiBmdW5jdGlvbiAodHlwZXMsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGVzLCBudWxsLCBkYXRhLCBmbik7CiAgICB9LAogICAgdW5iaW5kOiBmdW5jdGlvbiAodHlwZXMsIGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9mZih0eXBlcywgbnVsbCwgZm4pOwogICAgfSwKICAgIGRlbGVnYXRlOiBmdW5jdGlvbiAoc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbikgewogICAgICByZXR1cm4gdGhpcy5vbih0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuKTsKICAgIH0sCiAgICB1bmRlbGVnYXRlOiBmdW5jdGlvbiAoc2VsZWN0b3IsIHR5cGVzLCBmbikgewogICAgICAvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gdGhpcy5vZmYoc2VsZWN0b3IsICcqKicpIDogdGhpcy5vZmYodHlwZXMsIHNlbGVjdG9yIHx8ICcqKicsIGZuKTsKICAgIH0KICB9KTsKICB2YXIgbm9uY2UgPSBqUXVlcnkubm93KCk7CiAgdmFyIHJxdWVyeSA9IC9cPy87CiAgLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKICAvLyBXb3JrYXJvdW5kIGZhaWx1cmUgdG8gc3RyaW5nLWNhc3QgbnVsbCBpbnB1dAogIGpRdWVyeS5wYXJzZUpTT04gPSBmdW5jdGlvbiAoZGF0YSkgewogICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSArICcnKTsKICB9OwogIC8vIENyb3NzLWJyb3dzZXIgeG1sIHBhcnNpbmcKICBqUXVlcnkucGFyc2VYTUwgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHhtbCwgdG1wOwogICAgaWYgKCFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIC8vIFN1cHBvcnQ6IElFOQogICAgdHJ5IHsKICAgICAgdG1wID0gbmV3IERPTVBhcnNlcigpOwogICAgICB4bWwgPSB0bXAucGFyc2VGcm9tU3RyaW5nKGRhdGEsICd0ZXh0L3htbCcpOwogICAgfSBjYXRjaCAoZSkgewogICAgICB4bWwgPSB1bmRlZmluZWQ7CiAgICB9CiAgICBpZiAoIXhtbCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3BhcnNlcmVycm9yJykubGVuZ3RoKSB7CiAgICAgIGpRdWVyeS5lcnJvcignSW52YWxpZCBYTUw6ICcgKyBkYXRhKTsKICAgIH0KICAgIHJldHVybiB4bWw7CiAgfTsKICB2YXIKICAgIC8vIERvY3VtZW50IGxvY2F0aW9uCiAgICBhamF4TG9jUGFydHMsIGFqYXhMb2NhdGlvbiwgcmhhc2ggPSAvIy4qJC8sIHJ0cyA9IC8oWz8mXSlfPVteJl0qLywgcmhlYWRlcnMgPSAvXiguKj8pOlsgXHRdKihbXlxyXG5dKikkL2dtLAogICAgLy8gIzc2NTMsICM4MTI1LCAjODE1MjogbG9jYWwgcHJvdG9jb2wgZGV0ZWN0aW9uCiAgICBybG9jYWxQcm90b2NvbCA9IC9eKD86YWJvdXR8YXBwfGFwcC1zdG9yYWdlfC4rLWV4dGVuc2lvbnxmaWxlfHJlc3x3aWRnZXQpOiQvLCBybm9Db250ZW50ID0gL14oPzpHRVR8SEVBRCkkLywgcnByb3RvY29sID0gL15cL1wvLywgcnVybCA9IC9eKFtcdy4rLV0rOikoPzpcL1wvKD86W15cLz8jXSpAfCkoW15cLz8jOl0qKSg/OjooXGQrKXwpfCkvLAogICAgLyogUHJlZmlsdGVycwogICAgKiAxKSBUaGV5IGFyZSB1c2VmdWwgdG8gaW50cm9kdWNlIGN1c3RvbSBkYXRhVHlwZXMgKHNlZSBhamF4L2pzb25wLmpzIGZvciBhbiBleGFtcGxlKQogICAgKiAyKSBUaGVzZSBhcmUgY2FsbGVkOgogICAgKiAgICAtIEJFRk9SRSBhc2tpbmcgZm9yIGEgdHJhbnNwb3J0CiAgICAqICAgIC0gQUZURVIgcGFyYW0gc2VyaWFsaXphdGlvbiAocy5kYXRhIGlzIGEgc3RyaW5nIGlmIHMucHJvY2Vzc0RhdGEgaXMgdHJ1ZSkKICAgICogMykga2V5IGlzIHRoZSBkYXRhVHlwZQogICAgKiA0KSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAogICAgKiA1KSBleGVjdXRpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBjb250aW51ZSBkb3duIHRvICIqIiBpZiBuZWVkZWQKICAgICovCiAgICBwcmVmaWx0ZXJzID0ge30sCiAgICAvKiBUcmFuc3BvcnRzIGJpbmRpbmdzCiAgICAqIDEpIGtleSBpcyB0aGUgZGF0YVR5cGUKICAgICogMikgdGhlIGNhdGNoYWxsIHN5bWJvbCAiKiIgY2FuIGJlIHVzZWQKICAgICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZAogICAgKi8KICAgIHRyYW5zcG9ydHMgPSB7fSwKICAgIC8vIEF2b2lkIGNvbW1lbnQtcHJvbG9nIGNoYXIgc2VxdWVuY2UgKCMxMDA5OCk7IG11c3QgYXBwZWFzZSBsaW50IGFuZCBldmFkZSBjb21wcmVzc2lvbgogICAgYWxsVHlwZXMgPSAnKi8nLmNvbmNhdCgnKicpOwogIC8vICM4MTM4LCBJRSBtYXkgdGhyb3cgYW4gZXhjZXB0aW9uIHdoZW4gYWNjZXNzaW5nCiAgLy8gYSBmaWVsZCBmcm9tIHdpbmRvdy5sb2NhdGlvbiBpZiBkb2N1bWVudC5kb21haW4gaGFzIGJlZW4gc2V0CiAgdHJ5IHsKICAgIGFqYXhMb2NhdGlvbiA9IGxvY2F0aW9uLmhyZWY7CiAgfSBjYXRjaCAoZSkgewogICAgLy8gVXNlIHRoZSBocmVmIGF0dHJpYnV0ZSBvZiBhbiBBIGVsZW1lbnQKICAgIC8vIHNpbmNlIElFIHdpbGwgbW9kaWZ5IGl0IGdpdmVuIGRvY3VtZW50LmxvY2F0aW9uCiAgICBhamF4TG9jYXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICBhamF4TG9jYXRpb24uaHJlZiA9ICcnOwogICAgYWpheExvY2F0aW9uID0gYWpheExvY2F0aW9uLmhyZWY7CiAgfQogIC8vIFNlZ21lbnQgbG9jYXRpb24gaW50byBwYXJ0cwogIGFqYXhMb2NQYXJ0cyA9IHJ1cmwuZXhlYyhhamF4TG9jYXRpb24udG9Mb3dlckNhc2UoKSkgfHwgW107CiAgLy8gQmFzZSAiY29uc3RydWN0b3IiIGZvciBqUXVlcnkuYWpheFByZWZpbHRlciBhbmQgalF1ZXJ5LmFqYXhUcmFuc3BvcnQKICBmdW5jdGlvbiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoc3RydWN0dXJlKSB7CiAgICAvLyBkYXRhVHlwZUV4cHJlc3Npb24gaXMgb3B0aW9uYWwgYW5kIGRlZmF1bHRzIHRvICIqIgogICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhVHlwZUV4cHJlc3Npb24sIGZ1bmMpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhVHlwZUV4cHJlc3Npb24gIT09ICdzdHJpbmcnKSB7CiAgICAgICAgZnVuYyA9IGRhdGFUeXBlRXhwcmVzc2lvbjsKICAgICAgICBkYXRhVHlwZUV4cHJlc3Npb24gPSAnKic7CiAgICAgIH0KICAgICAgdmFyIGRhdGFUeXBlLCBpID0gMCwgZGF0YVR5cGVzID0gZGF0YVR5cGVFeHByZXNzaW9uLnRvTG93ZXJDYXNlKCkubWF0Y2gocm5vdHdoaXRlKSB8fCBbXTsKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgLy8gRm9yIGVhY2ggZGF0YVR5cGUgaW4gdGhlIGRhdGFUeXBlRXhwcmVzc2lvbgogICAgICAgIHdoaWxlIChkYXRhVHlwZSA9IGRhdGFUeXBlc1tpKytdKSB7CiAgICAgICAgICAvLyBQcmVwZW5kIGlmIHJlcXVlc3RlZAogICAgICAgICAgaWYgKGRhdGFUeXBlWzBdID09PSAnKycpIHsKICAgICAgICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZS5zbGljZSgxKSB8fCAnKic7CiAgICAgICAgICAgIChzdHJ1Y3R1cmVbZGF0YVR5cGVdID0gc3RydWN0dXJlW2RhdGFUeXBlXSB8fCBbXSkudW5zaGlmdChmdW5jKTsgIC8vIE90aGVyd2lzZSBhcHBlbmQKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIChzdHJ1Y3R1cmVbZGF0YVR5cGVdID0gc3RydWN0dXJlW2RhdGFUeXBlXSB8fCBbXSkucHVzaChmdW5jKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQogIC8vIEJhc2UgaW5zcGVjdGlvbiBmdW5jdGlvbiBmb3IgcHJlZmlsdGVycyBhbmQgdHJhbnNwb3J0cwogIGZ1bmN0aW9uIGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUikgewogICAgdmFyIGluc3BlY3RlZCA9IHt9LCBzZWVraW5nVHJhbnNwb3J0ID0gc3RydWN0dXJlID09PSB0cmFuc3BvcnRzOwogICAgZnVuY3Rpb24gaW5zcGVjdChkYXRhVHlwZSkgewogICAgICB2YXIgc2VsZWN0ZWQ7CiAgICAgIGluc3BlY3RlZFtkYXRhVHlwZV0gPSB0cnVlOwogICAgICBqUXVlcnkuZWFjaChzdHJ1Y3R1cmVbZGF0YVR5cGVdIHx8IFtdLCBmdW5jdGlvbiAoXywgcHJlZmlsdGVyT3JGYWN0b3J5KSB7CiAgICAgICAgdmFyIGRhdGFUeXBlT3JUcmFuc3BvcnQgPSBwcmVmaWx0ZXJPckZhY3Rvcnkob3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUik7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhVHlwZU9yVHJhbnNwb3J0ID09PSAnc3RyaW5nJyAmJiAhc2Vla2luZ1RyYW5zcG9ydCAmJiAhaW5zcGVjdGVkW2RhdGFUeXBlT3JUcmFuc3BvcnRdKSB7CiAgICAgICAgICBvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KGRhdGFUeXBlT3JUcmFuc3BvcnQpOwogICAgICAgICAgaW5zcGVjdChkYXRhVHlwZU9yVHJhbnNwb3J0KTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgaWYgKHNlZWtpbmdUcmFuc3BvcnQpIHsKICAgICAgICAgIHJldHVybiAhKHNlbGVjdGVkID0gZGF0YVR5cGVPclRyYW5zcG9ydCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHNlbGVjdGVkOwogICAgfQogICAgcmV0dXJuIGluc3BlY3Qob3B0aW9ucy5kYXRhVHlwZXNbMF0pIHx8ICFpbnNwZWN0ZWRbJyonXSAmJiBpbnNwZWN0KCcqJyk7CiAgfQogIC8vIEEgc3BlY2lhbCBleHRlbmQgZm9yIGFqYXggb3B0aW9ucwogIC8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQogIC8vIEZpeGVzICM5ODg3CiAgZnVuY3Rpb24gYWpheEV4dGVuZCh0YXJnZXQsIHNyYykgewogICAgdmFyIGtleSwgZGVlcCwgZmxhdE9wdGlvbnMgPSBqUXVlcnkuYWpheFNldHRpbmdzLmZsYXRPcHRpb25zIHx8IHt9OwogICAgZm9yIChrZXkgaW4gc3JjKSB7CiAgICAgIGlmIChzcmNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgKGZsYXRPcHRpb25zW2tleV0gPyB0YXJnZXQgOiBkZWVwIHx8IChkZWVwID0ge30pKVtrZXldID0gc3JjW2tleV07CiAgICAgIH0KICAgIH0KICAgIGlmIChkZWVwKSB7CiAgICAgIGpRdWVyeS5leHRlbmQodHJ1ZSwgdGFyZ2V0LCBkZWVwKTsKICAgIH0KICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIC8qIEhhbmRsZXMgcmVzcG9uc2VzIHRvIGFuIGFqYXggcmVxdWVzdDoKICAgKiAtIGZpbmRzIHRoZSByaWdodCBkYXRhVHlwZSAobWVkaWF0ZXMgYmV0d2VlbiBjb250ZW50LXR5cGUgYW5kIGV4cGVjdGVkIGRhdGFUeXBlKQogICAqIC0gcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogICAqLwogIGZ1bmN0aW9uIGFqYXhIYW5kbGVSZXNwb25zZXMocywganFYSFIsIHJlc3BvbnNlcykgewogICAgdmFyIGN0LCB0eXBlLCBmaW5hbERhdGFUeXBlLCBmaXJzdERhdGFUeXBlLCBjb250ZW50cyA9IHMuY29udGVudHMsIGRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzOwogICAgLy8gUmVtb3ZlIGF1dG8gZGF0YVR5cGUgYW5kIGdldCBjb250ZW50LXR5cGUgaW4gdGhlIHByb2Nlc3MKICAgIHdoaWxlIChkYXRhVHlwZXNbMF0gPT09ICcqJykgewogICAgICBkYXRhVHlwZXMuc2hpZnQoKTsKICAgICAgaWYgKGN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoJ0NvbnRlbnQtVHlwZScpOwogICAgICB9CiAgICB9CiAgICAvLyBDaGVjayBpZiB3ZSdyZSBkZWFsaW5nIHdpdGggYSBrbm93biBjb250ZW50LXR5cGUKICAgIGlmIChjdCkgewogICAgICBmb3IgKHR5cGUgaW4gY29udGVudHMpIHsKICAgICAgICBpZiAoY29udGVudHNbdHlwZV0gJiYgY29udGVudHNbdHlwZV0udGVzdChjdCkpIHsKICAgICAgICAgIGRhdGFUeXBlcy51bnNoaWZ0KHR5cGUpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhIHJlc3BvbnNlIGZvciB0aGUgZXhwZWN0ZWQgZGF0YVR5cGUKICAgIGlmIChkYXRhVHlwZXNbMF0gaW4gcmVzcG9uc2VzKSB7CiAgICAgIGZpbmFsRGF0YVR5cGUgPSBkYXRhVHlwZXNbMF07CiAgICB9IGVsc2UgewogICAgICAvLyBUcnkgY29udmVydGlibGUgZGF0YVR5cGVzCiAgICAgIGZvciAodHlwZSBpbiByZXNwb25zZXMpIHsKICAgICAgICBpZiAoIWRhdGFUeXBlc1swXSB8fCBzLmNvbnZlcnRlcnNbdHlwZSArICcgJyArIGRhdGFUeXBlc1swXV0pIHsKICAgICAgICAgIGZpbmFsRGF0YVR5cGUgPSB0eXBlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmICghZmlyc3REYXRhVHlwZSkgewogICAgICAgICAgZmlyc3REYXRhVHlwZSA9IHR5cGU7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQogICAgICBmaW5hbERhdGFUeXBlID0gZmluYWxEYXRhVHlwZSB8fCBmaXJzdERhdGFUeXBlOwogICAgfQogICAgLy8gSWYgd2UgZm91bmQgYSBkYXRhVHlwZQogICAgLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKICAgIC8vIGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKICAgIGlmIChmaW5hbERhdGFUeXBlKSB7CiAgICAgIGlmIChmaW5hbERhdGFUeXBlICE9PSBkYXRhVHlwZXNbMF0pIHsKICAgICAgICBkYXRhVHlwZXMudW5zaGlmdChmaW5hbERhdGFUeXBlKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzcG9uc2VzW2ZpbmFsRGF0YVR5cGVdOwogICAgfQogIH0KICAvKiBDaGFpbiBjb252ZXJzaW9ucyBnaXZlbiB0aGUgcmVxdWVzdCBhbmQgdGhlIG9yaWdpbmFsIHJlc3BvbnNlCiAgICogQWxzbyBzZXRzIHRoZSByZXNwb25zZVhYWCBmaWVsZHMgb24gdGhlIGpxWEhSIGluc3RhbmNlCiAgICovCiAgZnVuY3Rpb24gYWpheENvbnZlcnQocywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MpIHsKICAgIHZhciBjb252MiwgY3VycmVudCwgY29udiwgdG1wLCBwcmV2LCBjb252ZXJ0ZXJzID0ge30sCiAgICAgIC8vIFdvcmsgd2l0aCBhIGNvcHkgb2YgZGF0YVR5cGVzIGluIGNhc2Ugd2UgbmVlZCB0byBtb2RpZnkgaXQgZm9yIGNvbnZlcnNpb24KICAgICAgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXMuc2xpY2UoKTsKICAgIC8vIENyZWF0ZSBjb252ZXJ0ZXJzIG1hcCB3aXRoIGxvd2VyY2FzZWQga2V5cwogICAgaWYgKGRhdGFUeXBlc1sxXSkgewogICAgICBmb3IgKGNvbnYgaW4gcy5jb252ZXJ0ZXJzKSB7CiAgICAgICAgY29udmVydGVyc1tjb252LnRvTG93ZXJDYXNlKCldID0gcy5jb252ZXJ0ZXJzW2NvbnZdOwogICAgICB9CiAgICB9CiAgICBjdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CiAgICAvLyBDb252ZXJ0IHRvIGVhY2ggc2VxdWVudGlhbCBkYXRhVHlwZQogICAgd2hpbGUgKGN1cnJlbnQpIHsKICAgICAgaWYgKHMucmVzcG9uc2VGaWVsZHNbY3VycmVudF0pIHsKICAgICAgICBqcVhIUltzLnJlc3BvbnNlRmllbGRzW2N1cnJlbnRdXSA9IHJlc3BvbnNlOwogICAgICB9CiAgICAgIC8vIEFwcGx5IHRoZSBkYXRhRmlsdGVyIGlmIHByb3ZpZGVkCiAgICAgIGlmICghcHJldiAmJiBpc1N1Y2Nlc3MgJiYgcy5kYXRhRmlsdGVyKSB7CiAgICAgICAgcmVzcG9uc2UgPSBzLmRhdGFGaWx0ZXIocmVzcG9uc2UsIHMuZGF0YVR5cGUpOwogICAgICB9CiAgICAgIHByZXYgPSBjdXJyZW50OwogICAgICBjdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CiAgICAgIGlmIChjdXJyZW50KSB7CiAgICAgICAgLy8gVGhlcmUncyBvbmx5IHdvcmsgdG8gZG8gaWYgY3VycmVudCBkYXRhVHlwZSBpcyBub24tYXV0bwogICAgICAgIGlmIChjdXJyZW50ID09PSAnKicpIHsKICAgICAgICAgIGN1cnJlbnQgPSBwcmV2OyAgLy8gQ29udmVydCByZXNwb25zZSBpZiBwcmV2IGRhdGFUeXBlIGlzIG5vbi1hdXRvIGFuZCBkaWZmZXJzIGZyb20gY3VycmVudAogICAgICAgIH0gZWxzZSBpZiAocHJldiAhPT0gJyonICYmIHByZXYgIT09IGN1cnJlbnQpIHsKICAgICAgICAgIC8vIFNlZWsgYSBkaXJlY3QgY29udmVydGVyCiAgICAgICAgICBjb252ID0gY29udmVydGVyc1twcmV2ICsgJyAnICsgY3VycmVudF0gfHwgY29udmVydGVyc1snKiAnICsgY3VycmVudF07CiAgICAgICAgICAvLyBJZiBub25lIGZvdW5kLCBzZWVrIGEgcGFpcgogICAgICAgICAgaWYgKCFjb252KSB7CiAgICAgICAgICAgIGZvciAoY29udjIgaW4gY29udmVydGVycykgewogICAgICAgICAgICAgIC8vIElmIGNvbnYyIG91dHB1dHMgY3VycmVudAogICAgICAgICAgICAgIHRtcCA9IGNvbnYyLnNwbGl0KCcgJyk7CiAgICAgICAgICAgICAgaWYgKHRtcFsxXSA9PT0gY3VycmVudCkgewogICAgICAgICAgICAgICAgLy8gSWYgcHJldiBjYW4gYmUgY29udmVydGVkIHRvIGFjY2VwdGVkIGlucHV0CiAgICAgICAgICAgICAgICBjb252ID0gY29udmVydGVyc1twcmV2ICsgJyAnICsgdG1wWzBdXSB8fCBjb252ZXJ0ZXJzWycqICcgKyB0bXBbMF1dOwogICAgICAgICAgICAgICAgaWYgKGNvbnYpIHsKICAgICAgICAgICAgICAgICAgLy8gQ29uZGVuc2UgZXF1aXZhbGVuY2UgY29udmVydGVycwogICAgICAgICAgICAgICAgICBpZiAoY29udiA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnYgPSBjb252ZXJ0ZXJzW2NvbnYyXTsgIC8vIE90aGVyd2lzZSwgaW5zZXJ0IHRoZSBpbnRlcm1lZGlhdGUgZGF0YVR5cGUKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb252ZXJ0ZXJzW2NvbnYyXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0bXBbMF07CiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQodG1wWzFdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIEFwcGx5IGNvbnZlcnRlciAoaWYgbm90IGFuIGVxdWl2YWxlbmNlKQogICAgICAgICAgaWYgKGNvbnYgIT09IHRydWUpIHsKICAgICAgICAgICAgLy8gVW5sZXNzIGVycm9ycyBhcmUgYWxsb3dlZCB0byBidWJibGUsIGNhdGNoIGFuZCByZXR1cm4gdGhlbQogICAgICAgICAgICBpZiAoY29udiAmJiBzWyd0aHJvd3MnXSkgewogICAgICAgICAgICAgIHJlc3BvbnNlID0gY29udihyZXNwb25zZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gY29udihyZXNwb25zZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgc3RhdGU6ICdwYXJzZXJlcnJvcicsCiAgICAgICAgICAgICAgICAgIGVycm9yOiBjb252ID8gZSA6ICdObyBjb252ZXJzaW9uIGZyb20gJyArIHByZXYgKyAnIHRvICcgKyBjdXJyZW50CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgc3RhdGU6ICdzdWNjZXNzJywKICAgICAgZGF0YTogcmVzcG9uc2UKICAgIH07CiAgfQogIGpRdWVyeS5leHRlbmQoewogICAgLy8gQ291bnRlciBmb3IgaG9sZGluZyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSBxdWVyaWVzCiAgICBhY3RpdmU6IDAsCiAgICAvLyBMYXN0LU1vZGlmaWVkIGhlYWRlciBjYWNoZSBmb3IgbmV4dCByZXF1ZXN0CiAgICBsYXN0TW9kaWZpZWQ6IHt9LAogICAgZXRhZzoge30sCiAgICBhamF4U2V0dGluZ3M6IHsKICAgICAgdXJsOiBhamF4TG9jYXRpb24sCiAgICAgIHR5cGU6ICdHRVQnLAogICAgICBpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KGFqYXhMb2NQYXJ0c1sxXSksCiAgICAgIGdsb2JhbDogdHJ1ZSwKICAgICAgcHJvY2Vzc0RhdGE6IHRydWUsCiAgICAgIGFzeW5jOiB0cnVlLAogICAgICBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD1VVEYtOCcsCiAgICAgIC8qCiAgICAgIHRpbWVvdXQ6IDAsCiAgICAgIGRhdGE6IG51bGwsCiAgICAgIGRhdGFUeXBlOiBudWxsLAogICAgICB1c2VybmFtZTogbnVsbCwKICAgICAgcGFzc3dvcmQ6IG51bGwsCiAgICAgIGNhY2hlOiBudWxsLAogICAgICB0aHJvd3M6IGZhbHNlLAogICAgICB0cmFkaXRpb25hbDogZmFsc2UsCiAgICAgIGhlYWRlcnM6IHt9LAogICAgICAqLwogICAgICBhY2NlcHRzOiB7CiAgICAgICAgJyonOiBhbGxUeXBlcywKICAgICAgICB0ZXh0OiAndGV4dC9wbGFpbicsCiAgICAgICAgaHRtbDogJ3RleHQvaHRtbCcsCiAgICAgICAgeG1sOiAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgICAganNvbjogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvamF2YXNjcmlwdCcKICAgICAgfSwKICAgICAgY29udGVudHM6IHsKICAgICAgICB4bWw6IC94bWwvLAogICAgICAgIGh0bWw6IC9odG1sLywKICAgICAgICBqc29uOiAvanNvbi8KICAgICAgfSwKICAgICAgcmVzcG9uc2VGaWVsZHM6IHsKICAgICAgICB4bWw6ICdyZXNwb25zZVhNTCcsCiAgICAgICAgdGV4dDogJ3Jlc3BvbnNlVGV4dCcsCiAgICAgICAganNvbjogJ3Jlc3BvbnNlSlNPTicKICAgICAgfSwKICAgICAgLy8gRGF0YSBjb252ZXJ0ZXJzCiAgICAgIC8vIEtleXMgc2VwYXJhdGUgc291cmNlIChvciBjYXRjaGFsbCAiKiIpIGFuZCBkZXN0aW5hdGlvbiB0eXBlcyB3aXRoIGEgc2luZ2xlIHNwYWNlCiAgICAgIGNvbnZlcnRlcnM6IHsKICAgICAgICAvLyBDb252ZXJ0IGFueXRoaW5nIHRvIHRleHQKICAgICAgICAnKiB0ZXh0JzogU3RyaW5nLAogICAgICAgIC8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQogICAgICAgICd0ZXh0IGh0bWwnOiB0cnVlLAogICAgICAgIC8vIEV2YWx1YXRlIHRleHQgYXMgYSBqc29uIGV4cHJlc3Npb24KICAgICAgICAndGV4dCBqc29uJzogalF1ZXJ5LnBhcnNlSlNPTiwKICAgICAgICAvLyBQYXJzZSB0ZXh0IGFzIHhtbAogICAgICAgICd0ZXh0IHhtbCc6IGpRdWVyeS5wYXJzZVhNTAogICAgICB9LAogICAgICAvLyBGb3Igb3B0aW9ucyB0aGF0IHNob3VsZG4ndCBiZSBkZWVwIGV4dGVuZGVkOgogICAgICAvLyB5b3UgY2FuIGFkZCB5b3VyIG93biBjdXN0b20gb3B0aW9ucyBoZXJlIGlmCiAgICAgIC8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCiAgICAgIC8vIGRlZXAgZXh0ZW5kZWQgKHNlZSBhamF4RXh0ZW5kKQogICAgICBmbGF0T3B0aW9uczogewogICAgICAgIHVybDogdHJ1ZSwKICAgICAgICBjb250ZXh0OiB0cnVlCiAgICAgIH0KICAgIH0sCiAgICAvLyBDcmVhdGVzIGEgZnVsbCBmbGVkZ2VkIHNldHRpbmdzIG9iamVjdCBpbnRvIHRhcmdldAogICAgLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgogICAgLy8gSWYgdGFyZ2V0IGlzIG9taXR0ZWQsIHdyaXRlcyBpbnRvIGFqYXhTZXR0aW5ncy4KICAgIGFqYXhTZXR1cDogZnVuY3Rpb24gKHRhcmdldCwgc2V0dGluZ3MpIHsKICAgICAgcmV0dXJuIHNldHRpbmdzID8gLy8gQnVpbGRpbmcgYSBzZXR0aW5ncyBvYmplY3QKICAgICAgYWpheEV4dGVuZChhamF4RXh0ZW5kKHRhcmdldCwgalF1ZXJ5LmFqYXhTZXR0aW5ncyksIHNldHRpbmdzKSA6IC8vIEV4dGVuZGluZyBhamF4U2V0dGluZ3MKICAgICAgYWpheEV4dGVuZChqUXVlcnkuYWpheFNldHRpbmdzLCB0YXJnZXQpOwogICAgfSwKICAgIGFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyhwcmVmaWx0ZXJzKSwKICAgIGFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyh0cmFuc3BvcnRzKSwKICAgIC8vIE1haW4gbWV0aG9kCiAgICBhamF4OiBmdW5jdGlvbiAodXJsLCBvcHRpb25zKSB7CiAgICAgIC8vIElmIHVybCBpcyBhbiBvYmplY3QsIHNpbXVsYXRlIHByZS0xLjUgc2lnbmF0dXJlCiAgICAgIGlmICh0eXBlb2YgdXJsID09PSAnb2JqZWN0JykgewogICAgICAgIG9wdGlvbnMgPSB1cmw7CiAgICAgICAgdXJsID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIC8vIEZvcmNlIG9wdGlvbnMgdG8gYmUgYW4gb2JqZWN0CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB2YXIgdHJhbnNwb3J0LAogICAgICAgIC8vIFVSTCB3aXRob3V0IGFudGktY2FjaGUgcGFyYW0KICAgICAgICBjYWNoZVVSTCwKICAgICAgICAvLyBSZXNwb25zZSBoZWFkZXJzCiAgICAgICAgcmVzcG9uc2VIZWFkZXJzU3RyaW5nLCByZXNwb25zZUhlYWRlcnMsCiAgICAgICAgLy8gdGltZW91dCBoYW5kbGUKICAgICAgICB0aW1lb3V0VGltZXIsCiAgICAgICAgLy8gQ3Jvc3MtZG9tYWluIGRldGVjdGlvbiB2YXJzCiAgICAgICAgcGFydHMsCiAgICAgICAgLy8gVG8ga25vdyBpZiBnbG9iYWwgZXZlbnRzIGFyZSB0byBiZSBkaXNwYXRjaGVkCiAgICAgICAgZmlyZUdsb2JhbHMsCiAgICAgICAgLy8gTG9vcCB2YXJpYWJsZQogICAgICAgIGksCiAgICAgICAgLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdAogICAgICAgIHMgPSBqUXVlcnkuYWpheFNldHVwKHt9LCBvcHRpb25zKSwKICAgICAgICAvLyBDYWxsYmFja3MgY29udGV4dAogICAgICAgIGNhbGxiYWNrQ29udGV4dCA9IHMuY29udGV4dCB8fCBzLAogICAgICAgIC8vIENvbnRleHQgZm9yIGdsb2JhbCBldmVudHMgaXMgY2FsbGJhY2tDb250ZXh0IGlmIGl0IGlzIGEgRE9NIG5vZGUgb3IgalF1ZXJ5IGNvbGxlY3Rpb24KICAgICAgICBnbG9iYWxFdmVudENvbnRleHQgPSBzLmNvbnRleHQgJiYgKGNhbGxiYWNrQ29udGV4dC5ub2RlVHlwZSB8fCBjYWxsYmFja0NvbnRleHQuanF1ZXJ5KSA/IGpRdWVyeShjYWxsYmFja0NvbnRleHQpIDogalF1ZXJ5LmV2ZW50LAogICAgICAgIC8vIERlZmVycmVkcwogICAgICAgIGRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksIGNvbXBsZXRlRGVmZXJyZWQgPSBqUXVlcnkuQ2FsbGJhY2tzKCdvbmNlIG1lbW9yeScpLAogICAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgICAgc3RhdHVzQ29kZSA9IHMuc3RhdHVzQ29kZSB8fCB7fSwKICAgICAgICAvLyBIZWFkZXJzICh0aGV5IGFyZSBzZW50IGFsbCBhdCBvbmNlKQogICAgICAgIHJlcXVlc3RIZWFkZXJzID0ge30sIHJlcXVlc3RIZWFkZXJzTmFtZXMgPSB7fSwKICAgICAgICAvLyBUaGUganFYSFIgc3RhdGUKICAgICAgICBzdGF0ZSA9IDAsCiAgICAgICAgLy8gRGVmYXVsdCBhYm9ydCBtZXNzYWdlCiAgICAgICAgc3RyQWJvcnQgPSAnY2FuY2VsZWQnLAogICAgICAgIC8vIEZha2UgeGhyCiAgICAgICAganFYSFIgPSB7CiAgICAgICAgICByZWFkeVN0YXRlOiAwLAogICAgICAgICAgLy8gQnVpbGRzIGhlYWRlcnMgaGFzaHRhYmxlIGlmIG5lZWRlZAogICAgICAgICAgZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgdmFyIG1hdGNoOwogICAgICAgICAgICBpZiAoc3RhdGUgPT09IDIpIHsKICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzID0ge307CiAgICAgICAgICAgICAgICB3aGlsZSAobWF0Y2ggPSByaGVhZGVycy5leGVjKHJlc3BvbnNlSGVhZGVyc1N0cmluZykpIHsKICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzW21hdGNoWzFdLnRvTG93ZXJDYXNlKCldID0gbWF0Y2hbMl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG1hdGNoID0gcmVzcG9uc2VIZWFkZXJzW2tleS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWF0Y2ggPT0gbnVsbCA/IG51bGwgOiBtYXRjaDsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBSYXcgc3RyaW5nCiAgICAgICAgICBnZXRBbGxSZXNwb25zZUhlYWRlcnM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHN0YXRlID09PSAyID8gcmVzcG9uc2VIZWFkZXJzU3RyaW5nIDogbnVsbDsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBDYWNoZXMgdGhlIGhlYWRlcgogICAgICAgICAgc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBsbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgaWYgKCFzdGF0ZSkgewogICAgICAgICAgICAgIG5hbWUgPSByZXF1ZXN0SGVhZGVyc05hbWVzW2xuYW1lXSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbbG5hbWVdIHx8IG5hbWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBPdmVycmlkZXMgcmVzcG9uc2UgY29udGVudC10eXBlIGhlYWRlcgogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgaWYgKCFzdGF0ZSkgewogICAgICAgICAgICAgIHMubWltZVR5cGUgPSB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgICAgICBzdGF0dXNDb2RlOiBmdW5jdGlvbiAobWFwKSB7CiAgICAgICAgICAgIHZhciBjb2RlOwogICAgICAgICAgICBpZiAobWFwKSB7CiAgICAgICAgICAgICAgaWYgKHN0YXRlIDwgMikgewogICAgICAgICAgICAgICAgZm9yIChjb2RlIGluIG1hcCkgewogICAgICAgICAgICAgICAgICAvLyBMYXp5LWFkZCB0aGUgbmV3IGNhbGxiYWNrIGluIGEgd2F5IHRoYXQgcHJlc2VydmVzIG9sZCBvbmVzCiAgICAgICAgICAgICAgICAgIHN0YXR1c0NvZGVbY29kZV0gPSBbCiAgICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZVtjb2RlXSwKICAgICAgICAgICAgICAgICAgICBtYXBbY29kZV0KICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRXhlY3V0ZSB0aGUgYXBwcm9wcmlhdGUgY2FsbGJhY2tzCiAgICAgICAgICAgICAgICBqcVhIUi5hbHdheXMobWFwW2pxWEhSLnN0YXR1c10pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBDYW5jZWwgdGhlIHJlcXVlc3QKICAgICAgICAgIGFib3J0OiBmdW5jdGlvbiAoc3RhdHVzVGV4dCkgewogICAgICAgICAgICB2YXIgZmluYWxUZXh0ID0gc3RhdHVzVGV4dCB8fCBzdHJBYm9ydDsKICAgICAgICAgICAgaWYgKHRyYW5zcG9ydCkgewogICAgICAgICAgICAgIHRyYW5zcG9ydC5hYm9ydChmaW5hbFRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvbmUoMCwgZmluYWxUZXh0KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgLy8gQXR0YWNoIGRlZmVycmVkcwogICAgICBkZWZlcnJlZC5wcm9taXNlKGpxWEhSKS5jb21wbGV0ZSA9IGNvbXBsZXRlRGVmZXJyZWQuYWRkOwogICAgICBqcVhIUi5zdWNjZXNzID0ganFYSFIuZG9uZTsKICAgICAganFYSFIuZXJyb3IgPSBqcVhIUi5mYWlsOwogICAgICAvLyBSZW1vdmUgaGFzaCBjaGFyYWN0ZXIgKCM3NTMxOiBhbmQgc3RyaW5nIHByb21vdGlvbikKICAgICAgLy8gQWRkIHByb3RvY29sIGlmIG5vdCBwcm92aWRlZCAocHJlZmlsdGVycyBtaWdodCBleHBlY3QgaXQpCiAgICAgIC8vIEhhbmRsZSBmYWxzeSB1cmwgaW4gdGhlIHNldHRpbmdzIG9iamVjdCAoIzEwMDkzOiBjb25zaXN0ZW5jeSB3aXRoIG9sZCBzaWduYXR1cmUpCiAgICAgIC8vIFdlIGFsc28gdXNlIHRoZSB1cmwgcGFyYW1ldGVyIGlmIGF2YWlsYWJsZQogICAgICBzLnVybCA9ICgodXJsIHx8IHMudXJsIHx8IGFqYXhMb2NhdGlvbikgKyAnJykucmVwbGFjZShyaGFzaCwgJycpLnJlcGxhY2UocnByb3RvY29sLCBhamF4TG9jUGFydHNbMV0gKyAnLy8nKTsKICAgICAgLy8gQWxpYXMgbWV0aG9kIG9wdGlvbiB0byB0eXBlIGFzIHBlciB0aWNrZXQgIzEyMDA0CiAgICAgIHMudHlwZSA9IG9wdGlvbnMubWV0aG9kIHx8IG9wdGlvbnMudHlwZSB8fCBzLm1ldGhvZCB8fCBzLnR5cGU7CiAgICAgIC8vIEV4dHJhY3QgZGF0YVR5cGVzIGxpc3QKICAgICAgcy5kYXRhVHlwZXMgPSBqUXVlcnkudHJpbShzLmRhdGFUeXBlIHx8ICcqJykudG9Mb3dlckNhc2UoKS5tYXRjaChybm90d2hpdGUpIHx8IFsnJ107CiAgICAgIC8vIEEgY3Jvc3MtZG9tYWluIHJlcXVlc3QgaXMgaW4gb3JkZXIgd2hlbiB3ZSBoYXZlIGEgcHJvdG9jb2w6aG9zdDpwb3J0IG1pc21hdGNoCiAgICAgIGlmIChzLmNyb3NzRG9tYWluID09IG51bGwpIHsKICAgICAgICBwYXJ0cyA9IHJ1cmwuZXhlYyhzLnVybC50b0xvd2VyQ2FzZSgpKTsKICAgICAgICBzLmNyb3NzRG9tYWluID0gISEocGFydHMgJiYgKHBhcnRzWzFdICE9PSBhamF4TG9jUGFydHNbMV0gfHwgcGFydHNbMl0gIT09IGFqYXhMb2NQYXJ0c1syXSB8fCAocGFydHNbM10gfHwgKHBhcnRzWzFdID09PSAnaHR0cDonID8gJzgwJyA6ICc0NDMnKSkgIT09IChhamF4TG9jUGFydHNbM10gfHwgKGFqYXhMb2NQYXJ0c1sxXSA9PT0gJ2h0dHA6JyA/ICc4MCcgOiAnNDQzJykpKSk7CiAgICAgIH0KICAgICAgLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCiAgICAgIGlmIChzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAnc3RyaW5nJykgewogICAgICAgIHMuZGF0YSA9IGpRdWVyeS5wYXJhbShzLmRhdGEsIHMudHJhZGl0aW9uYWwpOwogICAgICB9CiAgICAgIC8vIEFwcGx5IHByZWZpbHRlcnMKICAgICAgaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMocHJlZmlsdGVycywgcywgb3B0aW9ucywganFYSFIpOwogICAgICAvLyBJZiByZXF1ZXN0IHdhcyBhYm9ydGVkIGluc2lkZSBhIHByZWZpbHRlciwgc3RvcCB0aGVyZQogICAgICBpZiAoc3RhdGUgPT09IDIpIHsKICAgICAgICByZXR1cm4ganFYSFI7CiAgICAgIH0KICAgICAgLy8gV2UgY2FuIGZpcmUgZ2xvYmFsIGV2ZW50cyBhcyBvZiBub3cgaWYgYXNrZWQgdG8KICAgICAgZmlyZUdsb2JhbHMgPSBzLmdsb2JhbDsKICAgICAgLy8gV2F0Y2ggZm9yIGEgbmV3IHNldCBvZiByZXF1ZXN0cwogICAgICBpZiAoZmlyZUdsb2JhbHMgJiYgalF1ZXJ5LmFjdGl2ZSsrID09PSAwKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoJ2FqYXhTdGFydCcpOwogICAgICB9CiAgICAgIC8vIFVwcGVyY2FzZSB0aGUgdHlwZQogICAgICBzLnR5cGUgPSBzLnR5cGUudG9VcHBlckNhc2UoKTsKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHJlcXVlc3QgaGFzIGNvbnRlbnQKICAgICAgcy5oYXNDb250ZW50ID0gIXJub0NvbnRlbnQudGVzdChzLnR5cGUpOwogICAgICAvLyBTYXZlIHRoZSBVUkwgaW4gY2FzZSB3ZSdyZSB0b3lpbmcgd2l0aCB0aGUgSWYtTW9kaWZpZWQtU2luY2UKICAgICAgLy8gYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyIGxhdGVyIG9uCiAgICAgIGNhY2hlVVJMID0gcy51cmw7CiAgICAgIC8vIE1vcmUgb3B0aW9ucyBoYW5kbGluZyBmb3IgcmVxdWVzdHMgd2l0aCBubyBjb250ZW50CiAgICAgIGlmICghcy5oYXNDb250ZW50KSB7CiAgICAgICAgLy8gSWYgZGF0YSBpcyBhdmFpbGFibGUsIGFwcGVuZCBkYXRhIHRvIHVybAogICAgICAgIGlmIChzLmRhdGEpIHsKICAgICAgICAgIGNhY2hlVVJMID0gcy51cmwgKz0gKHJxdWVyeS50ZXN0KGNhY2hlVVJMKSA/ICcmJyA6ICc/JykgKyBzLmRhdGE7CiAgICAgICAgICAvLyAjOTY4MjogcmVtb3ZlIGRhdGEgc28gdGhhdCBpdCdzIG5vdCB1c2VkIGluIGFuIGV2ZW50dWFsIHJldHJ5CiAgICAgICAgICBkZWxldGUgcy5kYXRhOwogICAgICAgIH0KICAgICAgICAvLyBBZGQgYW50aS1jYWNoZSBpbiB1cmwgaWYgbmVlZGVkCiAgICAgICAgaWYgKHMuY2FjaGUgPT09IGZhbHNlKSB7CiAgICAgICAgICBzLnVybCA9IHJ0cy50ZXN0KGNhY2hlVVJMKSA/IC8vIElmIHRoZXJlIGlzIGFscmVhZHkgYSAnXycgcGFyYW1ldGVyLCBzZXQgaXRzIHZhbHVlCiAgICAgICAgICBjYWNoZVVSTC5yZXBsYWNlKHJ0cywgJyQxXz0nICsgbm9uY2UrKykgOiAvLyBPdGhlcndpc2UgYWRkIG9uZSB0byB0aGUgZW5kCiAgICAgICAgICBjYWNoZVVSTCArIChycXVlcnkudGVzdChjYWNoZVVSTCkgPyAnJicgOiAnPycpICsgJ189JyArIG5vbmNlKys7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCiAgICAgIGlmIChzLmlmTW9kaWZpZWQpIHsKICAgICAgICBpZiAoalF1ZXJ5Lmxhc3RNb2RpZmllZFtjYWNoZVVSTF0pIHsKICAgICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoJ0lmLU1vZGlmaWVkLVNpbmNlJywgalF1ZXJ5Lmxhc3RNb2RpZmllZFtjYWNoZVVSTF0pOwogICAgICAgIH0KICAgICAgICBpZiAoalF1ZXJ5LmV0YWdbY2FjaGVVUkxdKSB7CiAgICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCdJZi1Ob25lLU1hdGNoJywgalF1ZXJ5LmV0YWdbY2FjaGVVUkxdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CiAgICAgIGlmIChzLmRhdGEgJiYgcy5oYXNDb250ZW50ICYmIHMuY29udGVudFR5cGUgIT09IGZhbHNlIHx8IG9wdGlvbnMuY29udGVudFR5cGUpIHsKICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCBzLmNvbnRlbnRUeXBlKTsKICAgICAgfQogICAgICAvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlCiAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoJ0FjY2VwdCcsIHMuZGF0YVR5cGVzWzBdICYmIHMuYWNjZXB0c1tzLmRhdGFUeXBlc1swXV0gPyBzLmFjY2VwdHNbcy5kYXRhVHlwZXNbMF1dICsgKHMuZGF0YVR5cGVzWzBdICE9PSAnKicgPyAnLCAnICsgYWxsVHlwZXMgKyAnOyBxPTAuMDEnIDogJycpIDogcy5hY2NlcHRzWycqJ10pOwogICAgICAvLyBDaGVjayBmb3IgaGVhZGVycyBvcHRpb24KICAgICAgZm9yIChpIGluIHMuaGVhZGVycykgewogICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoaSwgcy5oZWFkZXJzW2ldKTsKICAgICAgfQogICAgICAvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0CiAgICAgIGlmIChzLmJlZm9yZVNlbmQgJiYgKHMuYmVmb3JlU2VuZC5jYWxsKGNhbGxiYWNrQ29udGV4dCwganFYSFIsIHMpID09PSBmYWxzZSB8fCBzdGF0ZSA9PT0gMikpIHsKICAgICAgICAvLyBBYm9ydCBpZiBub3QgZG9uZSBhbHJlYWR5IGFuZCByZXR1cm4KICAgICAgICByZXR1cm4ganFYSFIuYWJvcnQoKTsKICAgICAgfQogICAgICAvLyBhYm9ydGluZyBpcyBubyBsb25nZXIgYSBjYW5jZWxsYXRpb24KICAgICAgc3RyQWJvcnQgPSAnYWJvcnQnOwogICAgICAvLyBJbnN0YWxsIGNhbGxiYWNrcyBvbiBkZWZlcnJlZHMKICAgICAgZm9yIChpIGluIHsKICAgICAgICAgIHN1Y2Nlc3M6IDEsCiAgICAgICAgICBlcnJvcjogMSwKICAgICAgICAgIGNvbXBsZXRlOiAxCiAgICAgICAgfSkgewogICAgICAgIGpxWEhSW2ldKHNbaV0pOwogICAgICB9CiAgICAgIC8vIEdldCB0cmFuc3BvcnQKICAgICAgdHJhbnNwb3J0ID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHModHJhbnNwb3J0cywgcywgb3B0aW9ucywganFYSFIpOwogICAgICAvLyBJZiBubyB0cmFuc3BvcnQsIHdlIGF1dG8tYWJvcnQKICAgICAgaWYgKCF0cmFuc3BvcnQpIHsKICAgICAgICBkb25lKC0xLCAnTm8gVHJhbnNwb3J0Jyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAganFYSFIucmVhZHlTdGF0ZSA9IDE7CiAgICAgICAgLy8gU2VuZCBnbG9iYWwgZXZlbnQKICAgICAgICBpZiAoZmlyZUdsb2JhbHMpIHsKICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCdhamF4U2VuZCcsIFsKICAgICAgICAgICAganFYSFIsCiAgICAgICAgICAgIHMKICAgICAgICAgIF0pOwogICAgICAgIH0KICAgICAgICAvLyBUaW1lb3V0CiAgICAgICAgaWYgKHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCkgewogICAgICAgICAgdGltZW91dFRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGpxWEhSLmFib3J0KCd0aW1lb3V0Jyk7CiAgICAgICAgICB9LCBzLnRpbWVvdXQpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgc3RhdGUgPSAxOwogICAgICAgICAgdHJhbnNwb3J0LnNlbmQocmVxdWVzdEhlYWRlcnMsIGRvbmUpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIC8vIFByb3BhZ2F0ZSBleGNlcHRpb24gYXMgZXJyb3IgaWYgbm90IGRvbmUKICAgICAgICAgIGlmIChzdGF0ZSA8IDIpIHsKICAgICAgICAgICAgZG9uZSgtMSwgZSk7ICAvLyBTaW1wbHkgcmV0aHJvdyBvdGhlcndpc2UKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIENhbGxiYWNrIGZvciB3aGVuIGV2ZXJ5dGhpbmcgaXMgZG9uZQogICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzKSB7CiAgICAgICAgdmFyIGlzU3VjY2Vzcywgc3VjY2VzcywgZXJyb3IsIHJlc3BvbnNlLCBtb2RpZmllZCwgc3RhdHVzVGV4dCA9IG5hdGl2ZVN0YXR1c1RleHQ7CiAgICAgICAgLy8gQ2FsbGVkIG9uY2UKICAgICAgICBpZiAoc3RhdGUgPT09IDIpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gU3RhdGUgaXMgImRvbmUiIG5vdwogICAgICAgIHN0YXRlID0gMjsKICAgICAgICAvLyBDbGVhciB0aW1lb3V0IGlmIGl0IGV4aXN0cwogICAgICAgIGlmICh0aW1lb3V0VGltZXIpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0VGltZXIpOwogICAgICAgIH0KICAgICAgICAvLyBEZXJlZmVyZW5jZSB0cmFuc3BvcnQgZm9yIGVhcmx5IGdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgIC8vIChubyBtYXR0ZXIgaG93IGxvbmcgdGhlIGpxWEhSIG9iamVjdCB3aWxsIGJlIHVzZWQpCiAgICAgICAgdHJhbnNwb3J0ID0gdW5kZWZpbmVkOwogICAgICAgIC8vIENhY2hlIHJlc3BvbnNlIGhlYWRlcnMKICAgICAgICByZXNwb25zZUhlYWRlcnNTdHJpbmcgPSBoZWFkZXJzIHx8ICcnOwogICAgICAgIC8vIFNldCByZWFkeVN0YXRlCiAgICAgICAganFYSFIucmVhZHlTdGF0ZSA9IHN0YXR1cyA+IDAgPyA0IDogMDsKICAgICAgICAvLyBEZXRlcm1pbmUgaWYgc3VjY2Vzc2Z1bAogICAgICAgIGlzU3VjY2VzcyA9IHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0OwogICAgICAgIC8vIEdldCByZXNwb25zZSBkYXRhCiAgICAgICAgaWYgKHJlc3BvbnNlcykgewogICAgICAgICAgcmVzcG9uc2UgPSBhamF4SGFuZGxlUmVzcG9uc2VzKHMsIGpxWEhSLCByZXNwb25zZXMpOwogICAgICAgIH0KICAgICAgICAvLyBDb252ZXJ0IG5vIG1hdHRlciB3aGF0ICh0aGF0IHdheSByZXNwb25zZVhYWCBmaWVsZHMgYXJlIGFsd2F5cyBzZXQpCiAgICAgICAgcmVzcG9uc2UgPSBhamF4Q29udmVydChzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2Vzcyk7CiAgICAgICAgLy8gSWYgc3VjY2Vzc2Z1bCwgaGFuZGxlIHR5cGUgY2hhaW5pbmcKICAgICAgICBpZiAoaXNTdWNjZXNzKSB7CiAgICAgICAgICAvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgogICAgICAgICAgaWYgKHMuaWZNb2RpZmllZCkgewogICAgICAgICAgICBtb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCdMYXN0LU1vZGlmaWVkJyk7CiAgICAgICAgICAgIGlmIChtb2RpZmllZCkgewogICAgICAgICAgICAgIGpRdWVyeS5sYXN0TW9kaWZpZWRbY2FjaGVVUkxdID0gbW9kaWZpZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcignZXRhZycpOwogICAgICAgICAgICBpZiAobW9kaWZpZWQpIHsKICAgICAgICAgICAgICBqUXVlcnkuZXRhZ1tjYWNoZVVSTF0gPSBtb2RpZmllZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gaWYgbm8gY29udGVudAogICAgICAgICAgaWYgKHN0YXR1cyA9PT0gMjA0IHx8IHMudHlwZSA9PT0gJ0hFQUQnKSB7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAnbm9jb250ZW50JzsgIC8vIGlmIG5vdCBtb2RpZmllZAogICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IDMwNCkgewogICAgICAgICAgICBzdGF0dXNUZXh0ID0gJ25vdG1vZGlmaWVkJzsgIC8vIElmIHdlIGhhdmUgZGF0YSwgbGV0J3MgY29udmVydCBpdAogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9IHJlc3BvbnNlLnN0YXRlOwogICAgICAgICAgICBzdWNjZXNzID0gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgICAgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgICAgICAgICAgaXNTdWNjZXNzID0gIWVycm9yOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBXZSBleHRyYWN0IGVycm9yIGZyb20gc3RhdHVzVGV4dAogICAgICAgICAgLy8gdGhlbiBub3JtYWxpemUgc3RhdHVzVGV4dCBhbmQgc3RhdHVzIGZvciBub24tYWJvcnRzCiAgICAgICAgICBlcnJvciA9IHN0YXR1c1RleHQ7CiAgICAgICAgICBpZiAoc3RhdHVzIHx8ICFzdGF0dXNUZXh0KSB7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAnZXJyb3InOwogICAgICAgICAgICBpZiAoc3RhdHVzIDwgMCkgewogICAgICAgICAgICAgIHN0YXR1cyA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gU2V0IGRhdGEgZm9yIHRoZSBmYWtlIHhociBvYmplY3QKICAgICAgICBqcVhIUi5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAganFYSFIuc3RhdHVzVGV4dCA9IChuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQpICsgJyc7CiAgICAgICAgLy8gU3VjY2Vzcy9FcnJvcgogICAgICAgIGlmIChpc1N1Y2Nlc3MpIHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKGNhbGxiYWNrQ29udGV4dCwgWwogICAgICAgICAgICBzdWNjZXNzLAogICAgICAgICAgICBzdGF0dXNUZXh0LAogICAgICAgICAgICBqcVhIUgogICAgICAgICAgXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdFdpdGgoY2FsbGJhY2tDb250ZXh0LCBbCiAgICAgICAgICAgIGpxWEhSLAogICAgICAgICAgICBzdGF0dXNUZXh0LAogICAgICAgICAgICBlcnJvcgogICAgICAgICAgXSk7CiAgICAgICAgfQogICAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgICAganFYSFIuc3RhdHVzQ29kZShzdGF0dXNDb2RlKTsKICAgICAgICBzdGF0dXNDb2RlID0gdW5kZWZpbmVkOwogICAgICAgIGlmIChmaXJlR2xvYmFscykgewogICAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoaXNTdWNjZXNzID8gJ2FqYXhTdWNjZXNzJyA6ICdhamF4RXJyb3InLCBbCiAgICAgICAgICAgIGpxWEhSLAogICAgICAgICAgICBzLAogICAgICAgICAgICBpc1N1Y2Nlc3MgPyBzdWNjZXNzIDogZXJyb3IKICAgICAgICAgIF0pOwogICAgICAgIH0KICAgICAgICAvLyBDb21wbGV0ZQogICAgICAgIGNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoY2FsbGJhY2tDb250ZXh0LCBbCiAgICAgICAgICBqcVhIUiwKICAgICAgICAgIHN0YXR1c1RleHQKICAgICAgICBdKTsKICAgICAgICBpZiAoZmlyZUdsb2JhbHMpIHsKICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCdhamF4Q29tcGxldGUnLCBbCiAgICAgICAgICAgIGpxWEhSLAogICAgICAgICAgICBzCiAgICAgICAgICBdKTsKICAgICAgICAgIC8vIEhhbmRsZSB0aGUgZ2xvYmFsIEFKQVggY291bnRlcgogICAgICAgICAgaWYgKCEtLWpRdWVyeS5hY3RpdmUpIHsKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoJ2FqYXhTdG9wJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBqcVhIUjsKICAgIH0sCiAgICBnZXRKU09OOiBmdW5jdGlvbiAodXJsLCBkYXRhLCBjYWxsYmFjaykgewogICAgICByZXR1cm4galF1ZXJ5LmdldCh1cmwsIGRhdGEsIGNhbGxiYWNrLCAnanNvbicpOwogICAgfSwKICAgIGdldFNjcmlwdDogZnVuY3Rpb24gKHVybCwgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIGpRdWVyeS5nZXQodXJsLCB1bmRlZmluZWQsIGNhbGxiYWNrLCAnc2NyaXB0Jyk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goWwogICAgJ2dldCcsCiAgICAncG9zdCcKICBdLCBmdW5jdGlvbiAoaSwgbWV0aG9kKSB7CiAgICBqUXVlcnlbbWV0aG9kXSA9IGZ1bmN0aW9uICh1cmwsIGRhdGEsIGNhbGxiYWNrLCB0eXBlKSB7CiAgICAgIC8vIHNoaWZ0IGFyZ3VtZW50cyBpZiBkYXRhIGFyZ3VtZW50IHdhcyBvbWl0dGVkCiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihkYXRhKSkgewogICAgICAgIHR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwogICAgICAgIGNhbGxiYWNrID0gZGF0YTsKICAgICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIHJldHVybiBqUXVlcnkuYWpheCh7CiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgdHlwZTogbWV0aG9kLAogICAgICAgIGRhdGFUeXBlOiB0eXBlLAogICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgc3VjY2VzczogY2FsbGJhY2sKICAgICAgfSk7CiAgICB9OwogIH0pOwogIC8vIEF0dGFjaCBhIGJ1bmNoIG9mIGZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgY29tbW9uIEFKQVggZXZlbnRzCiAgalF1ZXJ5LmVhY2goWwogICAgJ2FqYXhTdGFydCcsCiAgICAnYWpheFN0b3AnLAogICAgJ2FqYXhDb21wbGV0ZScsCiAgICAnYWpheEVycm9yJywKICAgICdhamF4U3VjY2VzcycsCiAgICAnYWpheFNlbmQnCiAgXSwgZnVuY3Rpb24gKGksIHR5cGUpIHsKICAgIGpRdWVyeS5mblt0eXBlXSA9IGZ1bmN0aW9uIChmbikgewogICAgICByZXR1cm4gdGhpcy5vbih0eXBlLCBmbik7CiAgICB9OwogIH0pOwogIGpRdWVyeS5fZXZhbFVybCA9IGZ1bmN0aW9uICh1cmwpIHsKICAgIHJldHVybiBqUXVlcnkuYWpheCh7CiAgICAgIHVybDogdXJsLAogICAgICB0eXBlOiAnR0VUJywKICAgICAgZGF0YVR5cGU6ICdzY3JpcHQnLAogICAgICBhc3luYzogZmFsc2UsCiAgICAgIGdsb2JhbDogZmFsc2UsCiAgICAgICd0aHJvd3MnOiB0cnVlCiAgICB9KTsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgd3JhcEFsbDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdmFyIHdyYXA7CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihodG1sKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS53cmFwQWxsKGh0bWwuY2FsbCh0aGlzLCBpKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHRoaXNbMF0pIHsKICAgICAgICAvLyBUaGUgZWxlbWVudHMgdG8gd3JhcCB0aGUgdGFyZ2V0IGFyb3VuZAogICAgICAgIHdyYXAgPSBqUXVlcnkoaHRtbCwgdGhpc1swXS5vd25lckRvY3VtZW50KS5lcSgwKS5jbG9uZSh0cnVlKTsKICAgICAgICBpZiAodGhpc1swXS5wYXJlbnROb2RlKSB7CiAgICAgICAgICB3cmFwLmluc2VydEJlZm9yZSh0aGlzWzBdKTsKICAgICAgICB9CiAgICAgICAgd3JhcC5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGVsZW0gPSB0aGlzOwogICAgICAgICAgd2hpbGUgKGVsZW0uZmlyc3RFbGVtZW50Q2hpbGQpIHsKICAgICAgICAgICAgZWxlbSA9IGVsZW0uZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbTsKICAgICAgICB9KS5hcHBlbmQodGhpcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgd3JhcElubmVyOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oaHRtbCkpIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykud3JhcElubmVyKGh0bWwuY2FsbCh0aGlzLCBpKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHNlbGYgPSBqUXVlcnkodGhpcyksIGNvbnRlbnRzID0gc2VsZi5jb250ZW50cygpOwogICAgICAgIGlmIChjb250ZW50cy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnRlbnRzLndyYXBBbGwoaHRtbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuYXBwZW5kKGh0bWwpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgd3JhcDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdmFyIGlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbihodG1sKTsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgIGpRdWVyeSh0aGlzKS53cmFwQWxsKGlzRnVuY3Rpb24gPyBodG1sLmNhbGwodGhpcywgaSkgOiBodG1sKTsKICAgICAgfSk7CiAgICB9LAogICAgdW53cmFwOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnBhcmVudCgpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghalF1ZXJ5Lm5vZGVOYW1lKHRoaXMsICdib2R5JykpIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS5yZXBsYWNlV2l0aCh0aGlzLmNoaWxkTm9kZXMpOwogICAgICAgIH0KICAgICAgfSkuZW5kKCk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4gPSBmdW5jdGlvbiAoZWxlbSkgewogICAgLy8gU3VwcG9ydDogT3BlcmEgPD0gMTIuMTIKICAgIC8vIE9wZXJhIHJlcG9ydHMgb2Zmc2V0V2lkdGhzIGFuZCBvZmZzZXRIZWlnaHRzIGxlc3MgdGhhbiB6ZXJvIG9uIHNvbWUgZWxlbWVudHMKICAgIHJldHVybiBlbGVtLm9mZnNldFdpZHRoIDw9IDAgJiYgZWxlbS5vZmZzZXRIZWlnaHQgPD0gMDsKICB9OwogIGpRdWVyeS5leHByLmZpbHRlcnMudmlzaWJsZSA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICByZXR1cm4gIWpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuKGVsZW0pOwogIH07CiAgdmFyIHIyMCA9IC8lMjAvZywgcmJyYWNrZXQgPSAvXFtcXSQvLCByQ1JMRiA9IC9ccj9cbi9nLCByc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXR8ZmlsZSkkL2ksIHJzdWJtaXR0YWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGtleWdlbikvaTsKICBmdW5jdGlvbiBidWlsZFBhcmFtcyhwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCkgewogICAgdmFyIG5hbWU7CiAgICBpZiAoalF1ZXJ5LmlzQXJyYXkob2JqKSkgewogICAgICAvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KICAgICAgalF1ZXJ5LmVhY2gob2JqLCBmdW5jdGlvbiAoaSwgdikgewogICAgICAgIGlmICh0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KHByZWZpeCkpIHsKICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgIGFkZChwcmVmaXgsIHYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBJdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMgbnVtZXJpYyBpbmRleC4KICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICdbJyArICh0eXBlb2YgdiA9PT0gJ29iamVjdCcgPyBpIDogJycpICsgJ10nLCB2LCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIGlmICghdHJhZGl0aW9uYWwgJiYgalF1ZXJ5LnR5cGUob2JqKSA9PT0gJ29iamVjdCcpIHsKICAgICAgLy8gU2VyaWFsaXplIG9iamVjdCBpdGVtLgogICAgICBmb3IgKG5hbWUgaW4gb2JqKSB7CiAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgJ1snICsgbmFtZSArICddJywgb2JqW25hbWVdLCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgogICAgICBhZGQocHJlZml4LCBvYmopOwogICAgfQogIH0KICAvLyBTZXJpYWxpemUgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cyBvciBhIHNldCBvZgogIC8vIGtleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwogIGpRdWVyeS5wYXJhbSA9IGZ1bmN0aW9uIChhLCB0cmFkaXRpb25hbCkgewogICAgdmFyIHByZWZpeCwgcyA9IFtdLCBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIC8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgcmV0dXJuIGl0cyB2YWx1ZQogICAgICAgIHZhbHVlID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlID09IG51bGwgPyAnJyA6IHZhbHVlOwogICAgICAgIHNbcy5sZW5ndGhdID0gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICB9OwogICAgLy8gU2V0IHRyYWRpdGlvbmFsIHRvIHRydWUgZm9yIGpRdWVyeSA8PSAxLjMuMiBiZWhhdmlvci4KICAgIGlmICh0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRyYWRpdGlvbmFsID0galF1ZXJ5LmFqYXhTZXR0aW5ncyAmJiBqUXVlcnkuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsOwogICAgfQogICAgLy8gSWYgYW4gYXJyYXkgd2FzIHBhc3NlZCBpbiwgYXNzdW1lIHRoYXQgaXQgaXMgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cy4KICAgIGlmIChqUXVlcnkuaXNBcnJheShhKSB8fCBhLmpxdWVyeSAmJiAhalF1ZXJ5LmlzUGxhaW5PYmplY3QoYSkpIHsKICAgICAgLy8gU2VyaWFsaXplIHRoZSBmb3JtIGVsZW1lbnRzCiAgICAgIGpRdWVyeS5lYWNoKGEsIGZ1bmN0aW9uICgpIHsKICAgICAgICBhZGQodGhpcy5uYW1lLCB0aGlzLnZhbHVlKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICAvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKICAgICAgLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCiAgICAgIGZvciAocHJlZml4IGluIGEpIHsKICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXgsIGFbcHJlZml4XSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgIH0KICAgIH0KICAgIC8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KICAgIHJldHVybiBzLmpvaW4oJyYnKS5yZXBsYWNlKHIyMCwgJysnKTsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgc2VyaWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBqUXVlcnkucGFyYW0odGhpcy5zZXJpYWxpemVBcnJheSgpKTsKICAgIH0sCiAgICBzZXJpYWxpemVBcnJheTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIENhbiBhZGQgcHJvcEhvb2sgZm9yICJlbGVtZW50cyIgdG8gZmlsdGVyIG9yIGFkZCBmb3JtIGVsZW1lbnRzCiAgICAgICAgdmFyIGVsZW1lbnRzID0galF1ZXJ5LnByb3AodGhpcywgJ2VsZW1lbnRzJyk7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRzID8galF1ZXJ5Lm1ha2VBcnJheShlbGVtZW50cykgOiB0aGlzOwogICAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0eXBlID0gdGhpcy50eXBlOwogICAgICAgIC8vIFVzZSAuaXMoICI6ZGlzYWJsZWQiICkgc28gdGhhdCBmaWVsZHNldFtkaXNhYmxlZF0gd29ya3MKICAgICAgICByZXR1cm4gdGhpcy5uYW1lICYmICFqUXVlcnkodGhpcykuaXMoJzpkaXNhYmxlZCcpICYmIHJzdWJtaXR0YWJsZS50ZXN0KHRoaXMubm9kZU5hbWUpICYmICFyc3VibWl0dGVyVHlwZXMudGVzdCh0eXBlKSAmJiAodGhpcy5jaGVja2VkIHx8ICFyY2hlY2thYmxlVHlwZS50ZXN0KHR5cGUpKTsKICAgICAgfSkubWFwKGZ1bmN0aW9uIChpLCBlbGVtKSB7CiAgICAgICAgdmFyIHZhbCA9IGpRdWVyeSh0aGlzKS52YWwoKTsKICAgICAgICByZXR1cm4gdmFsID09IG51bGwgPyBudWxsIDogalF1ZXJ5LmlzQXJyYXkodmFsKSA/IGpRdWVyeS5tYXAodmFsLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBuYW1lOiBlbGVtLm5hbWUsCiAgICAgICAgICAgIHZhbHVlOiB2YWwucmVwbGFjZShyQ1JMRiwgJ1xyXG4nKQogICAgICAgICAgfTsKICAgICAgICB9KSA6IHsKICAgICAgICAgIG5hbWU6IGVsZW0ubmFtZSwKICAgICAgICAgIHZhbHVlOiB2YWwucmVwbGFjZShyQ1JMRiwgJ1xyXG4nKQogICAgICAgIH07CiAgICAgIH0pLmdldCgpOwogICAgfQogIH0pOwogIGpRdWVyeS5hamF4U2V0dGluZ3MueGhyID0gZnVuY3Rpb24gKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgfSBjYXRjaCAoZSkgewogICAgfQogIH07CiAgdmFyIHhocklkID0gMCwgeGhyQ2FsbGJhY2tzID0ge30sIHhoclN1Y2Nlc3NTdGF0dXMgPSB7CiAgICAgIC8vIGZpbGUgcHJvdG9jb2wgYWx3YXlzIHlpZWxkcyBzdGF0dXMgY29kZSAwLCBhc3N1bWUgMjAwCiAgICAgIDA6IDIwMCwKICAgICAgLy8gU3VwcG9ydDogSUU5CiAgICAgIC8vICMxNDUwOiBzb21ldGltZXMgSUUgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAogICAgICAxMjIzOiAyMDQKICAgIH0sIHhoclN1cHBvcnRlZCA9IGpRdWVyeS5hamF4U2V0dGluZ3MueGhyKCk7CiAgLy8gU3VwcG9ydDogSUU5CiAgLy8gT3BlbiByZXF1ZXN0cyBtdXN0IGJlIG1hbnVhbGx5IGFib3J0ZWQgb24gdW5sb2FkICgjNTI4MCkKICBpZiAod2luZG93LkFjdGl2ZVhPYmplY3QpIHsKICAgIGpRdWVyeSh3aW5kb3cpLm9uKCd1bmxvYWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiB4aHJDYWxsYmFja3MpIHsKICAgICAgICB4aHJDYWxsYmFja3Nba2V5XSgpOwogICAgICB9CiAgICB9KTsKICB9CiAgc3VwcG9ydC5jb3JzID0gISF4aHJTdXBwb3J0ZWQgJiYgJ3dpdGhDcmVkZW50aWFscycgaW4geGhyU3VwcG9ydGVkOwogIHN1cHBvcnQuYWpheCA9IHhoclN1cHBvcnRlZCA9ICEheGhyU3VwcG9ydGVkOwogIGpRdWVyeS5hamF4VHJhbnNwb3J0KGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB2YXIgY2FsbGJhY2s7CiAgICAvLyBDcm9zcyBkb21haW4gb25seSBhbGxvd2VkIGlmIHN1cHBvcnRlZCB0aHJvdWdoIFhNTEh0dHBSZXF1ZXN0CiAgICBpZiAoc3VwcG9ydC5jb3JzIHx8IHhoclN1cHBvcnRlZCAmJiAhb3B0aW9ucy5jcm9zc0RvbWFpbikgewogICAgICByZXR1cm4gewogICAgICAgIHNlbmQ6IGZ1bmN0aW9uIChoZWFkZXJzLCBjb21wbGV0ZSkgewogICAgICAgICAgdmFyIGksIHhociA9IG9wdGlvbnMueGhyKCksIGlkID0gKyt4aHJJZDsKICAgICAgICAgIHhoci5vcGVuKG9wdGlvbnMudHlwZSwgb3B0aW9ucy51cmwsIG9wdGlvbnMuYXN5bmMsIG9wdGlvbnMudXNlcm5hbWUsIG9wdGlvbnMucGFzc3dvcmQpOwogICAgICAgICAgLy8gQXBwbHkgY3VzdG9tIGZpZWxkcyBpZiBwcm92aWRlZAogICAgICAgICAgaWYgKG9wdGlvbnMueGhyRmllbGRzKSB7CiAgICAgICAgICAgIGZvciAoaSBpbiBvcHRpb25zLnhockZpZWxkcykgewogICAgICAgICAgICAgIHhocltpXSA9IG9wdGlvbnMueGhyRmllbGRzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkCiAgICAgICAgICBpZiAob3B0aW9ucy5taW1lVHlwZSAmJiB4aHIub3ZlcnJpZGVNaW1lVHlwZSkgewogICAgICAgICAgICB4aHIub3ZlcnJpZGVNaW1lVHlwZShvcHRpb25zLm1pbWVUeXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFgtUmVxdWVzdGVkLVdpdGggaGVhZGVyCiAgICAgICAgICAvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCiAgICAgICAgICAvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgogICAgICAgICAgLy8gKGl0IGNhbiBhbHdheXMgYmUgc2V0IG9uIGEgcGVyLXJlcXVlc3QgYmFzaXMgb3IgZXZlbiB1c2luZyBhamF4U2V0dXApCiAgICAgICAgICAvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KICAgICAgICAgIGlmICghb3B0aW9ucy5jcm9zc0RvbWFpbiAmJiAhaGVhZGVyc1snWC1SZXF1ZXN0ZWQtV2l0aCddKSB7CiAgICAgICAgICAgIGhlYWRlcnNbJ1gtUmVxdWVzdGVkLVdpdGgnXSA9ICdYTUxIdHRwUmVxdWVzdCc7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBTZXQgaGVhZGVycwogICAgICAgICAgZm9yIChpIGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoaSwgaGVhZGVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBDYWxsYmFjawogICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgZGVsZXRlIHhockNhbGxiYWNrc1tpZF07CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IHhoci5vbmxvYWQgPSB4aHIub25lcnJvciA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2Fib3J0JykgewogICAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Vycm9yJykgewogICAgICAgICAgICAgICAgICBjb21wbGV0ZSgvLyBmaWxlOiBwcm90b2NvbCBhbHdheXMgeWllbGRzIHN0YXR1cyAwOyBzZWUgIzg2MDUsICMxNDIwNwogICAgICAgICAgICAgICAgICB4aHIuc3RhdHVzLCB4aHIuc3RhdHVzVGV4dCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21wbGV0ZSh4aHJTdWNjZXNzU3RhdHVzW3hoci5zdGF0dXNdIHx8IHhoci5zdGF0dXMsIHhoci5zdGF0dXNUZXh0LCAvLyBTdXBwb3J0OiBJRTkKICAgICAgICAgICAgICAgICAgLy8gQWNjZXNzaW5nIGJpbmFyeS1kYXRhIHJlc3BvbnNlVGV4dCB0aHJvd3MgYW4gZXhjZXB0aW9uCiAgICAgICAgICAgICAgICAgIC8vICgjMTE0MjYpCiAgICAgICAgICAgICAgICAgIHR5cGVvZiB4aHIucmVzcG9uc2VUZXh0ID09PSAnc3RyaW5nJyA/IHsgdGV4dDogeGhyLnJlc3BvbnNlVGV4dCB9IDogdW5kZWZpbmVkLCB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH07CiAgICAgICAgICAvLyBMaXN0ZW4gdG8gZXZlbnRzCiAgICAgICAgICB4aHIub25sb2FkID0gY2FsbGJhY2soKTsKICAgICAgICAgIHhoci5vbmVycm9yID0gY2FsbGJhY2soJ2Vycm9yJyk7CiAgICAgICAgICAvLyBDcmVhdGUgdGhlIGFib3J0IGNhbGxiYWNrCiAgICAgICAgICBjYWxsYmFjayA9IHhockNhbGxiYWNrc1tpZF0gPSBjYWxsYmFjaygnYWJvcnQnKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIERvIHNlbmQgdGhlIHJlcXVlc3QgKHRoaXMgbWF5IHJhaXNlIGFuIGV4Y2VwdGlvbikKICAgICAgICAgICAgeGhyLnNlbmQob3B0aW9ucy5oYXNDb250ZW50ICYmIG9wdGlvbnMuZGF0YSB8fCBudWxsKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gIzE0NjgzOiBPbmx5IHJldGhyb3cgaWYgdGhpcyBoYXNuJ3QgYmVlbiBub3RpZmllZCBhcyBhbiBlcnJvciB5ZXQKICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9KTsKICAvLyBJbnN0YWxsIHNjcmlwdCBkYXRhVHlwZQogIGpRdWVyeS5hamF4U2V0dXAoewogICAgYWNjZXB0czogeyBzY3JpcHQ6ICd0ZXh0L2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2VjbWFzY3JpcHQsIGFwcGxpY2F0aW9uL3gtZWNtYXNjcmlwdCcgfSwKICAgIGNvbnRlbnRzOiB7IHNjcmlwdDogLyg/OmphdmF8ZWNtYSlzY3JpcHQvIH0sCiAgICBjb252ZXJ0ZXJzOiB7CiAgICAgICd0ZXh0IHNjcmlwdCc6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwodGV4dCk7CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgIH0KICAgIH0KICB9KTsKICAvLyBIYW5kbGUgY2FjaGUncyBzcGVjaWFsIGNhc2UgYW5kIGNyb3NzRG9tYWluCiAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoJ3NjcmlwdCcsIGZ1bmN0aW9uIChzKSB7CiAgICBpZiAocy5jYWNoZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHMuY2FjaGUgPSBmYWxzZTsKICAgIH0KICAgIGlmIChzLmNyb3NzRG9tYWluKSB7CiAgICAgIHMudHlwZSA9ICdHRVQnOwogICAgfQogIH0pOwogIC8vIEJpbmQgc2NyaXB0IHRhZyBoYWNrIHRyYW5zcG9ydAogIGpRdWVyeS5hamF4VHJhbnNwb3J0KCdzY3JpcHQnLCBmdW5jdGlvbiAocykgewogICAgLy8gVGhpcyB0cmFuc3BvcnQgb25seSBkZWFscyB3aXRoIGNyb3NzIGRvbWFpbiByZXF1ZXN0cwogICAgaWYgKHMuY3Jvc3NEb21haW4pIHsKICAgICAgdmFyIHNjcmlwdCwgY2FsbGJhY2s7CiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24gKF8sIGNvbXBsZXRlKSB7CiAgICAgICAgICBzY3JpcHQgPSBqUXVlcnkoJzxzY3JpcHQ+JykucHJvcCh7CiAgICAgICAgICAgIGFzeW5jOiB0cnVlLAogICAgICAgICAgICBjaGFyc2V0OiBzLnNjcmlwdENoYXJzZXQsCiAgICAgICAgICAgIHNyYzogcy51cmwKICAgICAgICAgIH0pLm9uKCdsb2FkIGVycm9yJywgY2FsbGJhY2sgPSBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgICAgIHNjcmlwdC5yZW1vdmUoKTsKICAgICAgICAgICAgY2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICBpZiAoZXZ0KSB7CiAgICAgICAgICAgICAgY29tcGxldGUoZXZ0LnR5cGUgPT09ICdlcnJvcicgPyA0MDQgOiAyMDAsIGV2dC50eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdFswXSk7CiAgICAgICAgfSwKICAgICAgICBhYm9ydDogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH0pOwogIHZhciBvbGRDYWxsYmFja3MgPSBbXSwgcmpzb25wID0gLyg9KVw/KD89JnwkKXxcP1w/LzsKICAvLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCiAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICBqc29ucDogJ2NhbGxiYWNrJywKICAgIGpzb25wQ2FsbGJhY2s6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8IGpRdWVyeS5leHBhbmRvICsgJ18nICsgbm9uY2UrKzsKICAgICAgdGhpc1tjYWxsYmFja10gPSB0cnVlOwogICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICB9CiAgfSk7CiAgLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzCiAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoJ2pzb24ganNvbnAnLCBmdW5jdGlvbiAocywgb3JpZ2luYWxTZXR0aW5ncywganFYSFIpIHsKICAgIHZhciBjYWxsYmFja05hbWUsIG92ZXJ3cml0dGVuLCByZXNwb25zZUNvbnRhaW5lciwganNvblByb3AgPSBzLmpzb25wICE9PSBmYWxzZSAmJiAocmpzb25wLnRlc3Qocy51cmwpID8gJ3VybCcgOiB0eXBlb2Ygcy5kYXRhID09PSAnc3RyaW5nJyAmJiAhKHMuY29udGVudFR5cGUgfHwgJycpLmluZGV4T2YoJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpICYmIHJqc29ucC50ZXN0KHMuZGF0YSkgJiYgJ2RhdGEnKTsKICAgIC8vIEhhbmRsZSBpZmYgdGhlIGV4cGVjdGVkIGRhdGEgdHlwZSBpcyAianNvbnAiIG9yIHdlIGhhdmUgYSBwYXJhbWV0ZXIgdG8gc2V0CiAgICBpZiAoanNvblByb3AgfHwgcy5kYXRhVHlwZXNbMF0gPT09ICdqc29ucCcpIHsKICAgICAgLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdAogICAgICBjYWxsYmFja05hbWUgPSBzLmpzb25wQ2FsbGJhY2sgPSBqUXVlcnkuaXNGdW5jdGlvbihzLmpzb25wQ2FsbGJhY2spID8gcy5qc29ucENhbGxiYWNrKCkgOiBzLmpzb25wQ2FsbGJhY2s7CiAgICAgIC8vIEluc2VydCBjYWxsYmFjayBpbnRvIHVybCBvciBmb3JtIGRhdGEKICAgICAgaWYgKGpzb25Qcm9wKSB7CiAgICAgICAgc1tqc29uUHJvcF0gPSBzW2pzb25Qcm9wXS5yZXBsYWNlKHJqc29ucCwgJyQxJyArIGNhbGxiYWNrTmFtZSk7CiAgICAgIH0gZWxzZSBpZiAocy5qc29ucCAhPT0gZmFsc2UpIHsKICAgICAgICBzLnVybCArPSAocnF1ZXJ5LnRlc3Qocy51cmwpID8gJyYnIDogJz8nKSArIHMuanNvbnAgKyAnPScgKyBjYWxsYmFja05hbWU7CiAgICAgIH0KICAgICAgLy8gVXNlIGRhdGEgY29udmVydGVyIHRvIHJldHJpZXZlIGpzb24gYWZ0ZXIgc2NyaXB0IGV4ZWN1dGlvbgogICAgICBzLmNvbnZlcnRlcnNbJ3NjcmlwdCBqc29uJ10gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFyZXNwb25zZUNvbnRhaW5lcikgewogICAgICAgICAgalF1ZXJ5LmVycm9yKGNhbGxiYWNrTmFtZSArICcgd2FzIG5vdCBjYWxsZWQnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlQ29udGFpbmVyWzBdOwogICAgICB9OwogICAgICAvLyBmb3JjZSBqc29uIGRhdGFUeXBlCiAgICAgIHMuZGF0YVR5cGVzWzBdID0gJ2pzb24nOwogICAgICAvLyBJbnN0YWxsIGNhbGxiYWNrCiAgICAgIG92ZXJ3cml0dGVuID0gd2luZG93W2NhbGxiYWNrTmFtZV07CiAgICAgIHdpbmRvd1tjYWxsYmFja05hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJlc3BvbnNlQ29udGFpbmVyID0gYXJndW1lbnRzOwogICAgICB9OwogICAgICAvLyBDbGVhbi11cCBmdW5jdGlvbiAoZmlyZXMgYWZ0ZXIgY29udmVydGVycykKICAgICAganFYSFIuYWx3YXlzKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBSZXN0b3JlIHByZWV4aXN0aW5nIHZhbHVlCiAgICAgICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBvdmVyd3JpdHRlbjsKICAgICAgICAvLyBTYXZlIGJhY2sgYXMgZnJlZQogICAgICAgIGlmIChzW2NhbGxiYWNrTmFtZV0pIHsKICAgICAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHJlLXVzaW5nIHRoZSBvcHRpb25zIGRvZXNuJ3Qgc2NyZXcgdGhpbmdzIGFyb3VuZAogICAgICAgICAgcy5qc29ucENhbGxiYWNrID0gb3JpZ2luYWxTZXR0aW5ncy5qc29ucENhbGxiYWNrOwogICAgICAgICAgLy8gc2F2ZSB0aGUgY2FsbGJhY2sgbmFtZSBmb3IgZnV0dXJlIHVzZQogICAgICAgICAgb2xkQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2tOYW1lKTsKICAgICAgICB9CiAgICAgICAgLy8gQ2FsbCBpZiBpdCB3YXMgYSBmdW5jdGlvbiBhbmQgd2UgaGF2ZSBhIHJlc3BvbnNlCiAgICAgICAgaWYgKHJlc3BvbnNlQ29udGFpbmVyICYmIGpRdWVyeS5pc0Z1bmN0aW9uKG92ZXJ3cml0dGVuKSkgewogICAgICAgICAgb3ZlcndyaXR0ZW4ocmVzcG9uc2VDb250YWluZXJbMF0pOwogICAgICAgIH0KICAgICAgICByZXNwb25zZUNvbnRhaW5lciA9IG92ZXJ3cml0dGVuID0gdW5kZWZpbmVkOwogICAgICB9KTsKICAgICAgLy8gRGVsZWdhdGUgdG8gc2NyaXB0CiAgICAgIHJldHVybiAnc2NyaXB0JzsKICAgIH0KICB9KTsKICAvLyBkYXRhOiBzdHJpbmcgb2YgaHRtbAogIC8vIGNvbnRleHQgKG9wdGlvbmFsKTogSWYgc3BlY2lmaWVkLCB0aGUgZnJhZ21lbnQgd2lsbCBiZSBjcmVhdGVkIGluIHRoaXMgY29udGV4dCwgZGVmYXVsdHMgdG8gZG9jdW1lbnQKICAvLyBrZWVwU2NyaXB0cyAob3B0aW9uYWwpOiBJZiB0cnVlLCB3aWxsIGluY2x1ZGUgc2NyaXB0cyBwYXNzZWQgaW4gdGhlIGh0bWwgc3RyaW5nCiAgalF1ZXJ5LnBhcnNlSFRNTCA9IGZ1bmN0aW9uIChkYXRhLCBjb250ZXh0LCBrZWVwU2NyaXB0cykgewogICAgaWYgKCFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmICh0eXBlb2YgY29udGV4dCA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgIGtlZXBTY3JpcHRzID0gY29udGV4dDsKICAgICAgY29udGV4dCA9IGZhbHNlOwogICAgfQogICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CiAgICB2YXIgcGFyc2VkID0gcnNpbmdsZVRhZy5leGVjKGRhdGEpLCBzY3JpcHRzID0gIWtlZXBTY3JpcHRzICYmIFtdOwogICAgLy8gU2luZ2xlIHRhZwogICAgaWYgKHBhcnNlZCkgewogICAgICByZXR1cm4gW2NvbnRleHQuY3JlYXRlRWxlbWVudChwYXJzZWRbMV0pXTsKICAgIH0KICAgIHBhcnNlZCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KFtkYXRhXSwgY29udGV4dCwgc2NyaXB0cyk7CiAgICBpZiAoc2NyaXB0cyAmJiBzY3JpcHRzLmxlbmd0aCkgewogICAgICBqUXVlcnkoc2NyaXB0cykucmVtb3ZlKCk7CiAgICB9CiAgICByZXR1cm4galF1ZXJ5Lm1lcmdlKFtdLCBwYXJzZWQuY2hpbGROb2Rlcyk7CiAgfTsKICAvLyBLZWVwIGEgY29weSBvZiB0aGUgb2xkIGxvYWQgbWV0aG9kCiAgdmFyIF9sb2FkID0galF1ZXJ5LmZuLmxvYWQ7CiAgLyoqCiAgICogTG9hZCBhIHVybCBpbnRvIGEgcGFnZQogICAqLwogIGpRdWVyeS5mbi5sb2FkID0gZnVuY3Rpb24gKHVybCwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnICYmIF9sb2FkKSB7CiAgICAgIHJldHVybiBfbG9hZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgdmFyIHNlbGVjdG9yLCB0eXBlLCByZXNwb25zZSwgc2VsZiA9IHRoaXMsIG9mZiA9IHVybC5pbmRleE9mKCcgJyk7CiAgICBpZiAob2ZmID49IDApIHsKICAgICAgc2VsZWN0b3IgPSBqUXVlcnkudHJpbSh1cmwuc2xpY2Uob2ZmKSk7CiAgICAgIHVybCA9IHVybC5zbGljZSgwLCBvZmYpOwogICAgfQogICAgLy8gSWYgaXQncyBhIGZ1bmN0aW9uCiAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24ocGFyYW1zKSkgewogICAgICAvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawogICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgcGFyYW1zID0gdW5kZWZpbmVkOyAgLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZwogICAgfSBlbHNlIGlmIChwYXJhbXMgJiYgdHlwZW9mIHBhcmFtcyA9PT0gJ29iamVjdCcpIHsKICAgICAgdHlwZSA9ICdQT1NUJzsKICAgIH0KICAgIC8vIElmIHdlIGhhdmUgZWxlbWVudHMgdG8gbW9kaWZ5LCBtYWtlIHRoZSByZXF1ZXN0CiAgICBpZiAoc2VsZi5sZW5ndGggPiAwKSB7CiAgICAgIGpRdWVyeS5hamF4KHsKICAgICAgICB1cmw6IHVybCwKICAgICAgICAvLyBpZiAidHlwZSIgdmFyaWFibGUgaXMgdW5kZWZpbmVkLCB0aGVuICJHRVQiIG1ldGhvZCB3aWxsIGJlIHVzZWQKICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgIGRhdGFUeXBlOiAnaHRtbCcsCiAgICAgICAgZGF0YTogcGFyYW1zCiAgICAgIH0pLmRvbmUoZnVuY3Rpb24gKHJlc3BvbnNlVGV4dCkgewogICAgICAgIC8vIFNhdmUgcmVzcG9uc2UgZm9yIHVzZSBpbiBjb21wbGV0ZSBjYWxsYmFjawogICAgICAgIHJlc3BvbnNlID0gYXJndW1lbnRzOwogICAgICAgIHNlbGYuaHRtbChzZWxlY3RvciA/IC8vIElmIGEgc2VsZWN0b3Igd2FzIHNwZWNpZmllZCwgbG9jYXRlIHRoZSByaWdodCBlbGVtZW50cyBpbiBhIGR1bW15IGRpdgogICAgICAgIC8vIEV4Y2x1ZGUgc2NyaXB0cyB0byBhdm9pZCBJRSAnUGVybWlzc2lvbiBEZW5pZWQnIGVycm9ycwogICAgICAgIGpRdWVyeSgnPGRpdj4nKS5hcHBlbmQoalF1ZXJ5LnBhcnNlSFRNTChyZXNwb25zZVRleHQpKS5maW5kKHNlbGVjdG9yKSA6IC8vIE90aGVyd2lzZSB1c2UgdGhlIGZ1bGwgcmVzdWx0CiAgICAgICAgcmVzcG9uc2VUZXh0KTsKICAgICAgfSkuY29tcGxldGUoY2FsbGJhY2sgJiYgZnVuY3Rpb24gKGpxWEhSLCBzdGF0dXMpIHsKICAgICAgICBzZWxmLmVhY2goY2FsbGJhY2ssIHJlc3BvbnNlIHx8IFsKICAgICAgICAgIGpxWEhSLnJlc3BvbnNlVGV4dCwKICAgICAgICAgIHN0YXR1cywKICAgICAgICAgIGpxWEhSCiAgICAgICAgXSk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKICBqUXVlcnkuZXhwci5maWx0ZXJzLmFuaW1hdGVkID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgIHJldHVybiBqUXVlcnkuZ3JlcChqUXVlcnkudGltZXJzLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgcmV0dXJuIGVsZW0gPT09IGZuLmVsZW07CiAgICB9KS5sZW5ndGg7CiAgfTsKICB2YXIgZG9jRWxlbSA9IHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgLyoqCiAgICogR2V0cyBhIHdpbmRvdyBmcm9tIGFuIGVsZW1lbnQKICAgKi8KICBmdW5jdGlvbiBnZXRXaW5kb3coZWxlbSkgewogICAgcmV0dXJuIGpRdWVyeS5pc1dpbmRvdyhlbGVtKSA/IGVsZW0gOiBlbGVtLm5vZGVUeXBlID09PSA5ICYmIGVsZW0uZGVmYXVsdFZpZXc7CiAgfQogIGpRdWVyeS5vZmZzZXQgPSB7CiAgICBzZXRPZmZzZXQ6IGZ1bmN0aW9uIChlbGVtLCBvcHRpb25zLCBpKSB7CiAgICAgIHZhciBjdXJQb3NpdGlvbiwgY3VyTGVmdCwgY3VyQ1NTVG9wLCBjdXJUb3AsIGN1ck9mZnNldCwgY3VyQ1NTTGVmdCwgY2FsY3VsYXRlUG9zaXRpb24sIHBvc2l0aW9uID0galF1ZXJ5LmNzcyhlbGVtLCAncG9zaXRpb24nKSwgY3VyRWxlbSA9IGpRdWVyeShlbGVtKSwgcHJvcHMgPSB7fTsKICAgICAgLy8gU2V0IHBvc2l0aW9uIGZpcnN0LCBpbi1jYXNlIHRvcC9sZWZ0IGFyZSBzZXQgZXZlbiBvbiBzdGF0aWMgZWxlbQogICAgICBpZiAocG9zaXRpb24gPT09ICdzdGF0aWMnKSB7CiAgICAgICAgZWxlbS5zdHlsZS5wb3NpdGlvbiA9ICdyZWxhdGl2ZSc7CiAgICAgIH0KICAgICAgY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKTsKICAgICAgY3VyQ1NTVG9wID0galF1ZXJ5LmNzcyhlbGVtLCAndG9wJyk7CiAgICAgIGN1ckNTU0xlZnQgPSBqUXVlcnkuY3NzKGVsZW0sICdsZWZ0Jyk7CiAgICAgIGNhbGN1bGF0ZVBvc2l0aW9uID0gKHBvc2l0aW9uID09PSAnYWJzb2x1dGUnIHx8IHBvc2l0aW9uID09PSAnZml4ZWQnKSAmJiAoY3VyQ1NTVG9wICsgY3VyQ1NTTGVmdCkuaW5kZXhPZignYXV0bycpID4gLTE7CiAgICAgIC8vIE5lZWQgdG8gYmUgYWJsZSB0byBjYWxjdWxhdGUgcG9zaXRpb24gaWYgZWl0aGVyIHRvcCBvciBsZWZ0IGlzIGF1dG8gYW5kIHBvc2l0aW9uIGlzIGVpdGhlciBhYnNvbHV0ZSBvciBmaXhlZAogICAgICBpZiAoY2FsY3VsYXRlUG9zaXRpb24pIHsKICAgICAgICBjdXJQb3NpdGlvbiA9IGN1ckVsZW0ucG9zaXRpb24oKTsKICAgICAgICBjdXJUb3AgPSBjdXJQb3NpdGlvbi50b3A7CiAgICAgICAgY3VyTGVmdCA9IGN1clBvc2l0aW9uLmxlZnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3VyVG9wID0gcGFyc2VGbG9hdChjdXJDU1NUb3ApIHx8IDA7CiAgICAgICAgY3VyTGVmdCA9IHBhcnNlRmxvYXQoY3VyQ1NTTGVmdCkgfHwgMDsKICAgICAgfQogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24ob3B0aW9ucykpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucy5jYWxsKGVsZW0sIGksIGN1ck9mZnNldCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudG9wICE9IG51bGwpIHsKICAgICAgICBwcm9wcy50b3AgPSBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKyBjdXJUb3A7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMubGVmdCAhPSBudWxsKSB7CiAgICAgICAgcHJvcHMubGVmdCA9IG9wdGlvbnMubGVmdCAtIGN1ck9mZnNldC5sZWZ0ICsgY3VyTGVmdDsKICAgICAgfQogICAgICBpZiAoJ3VzaW5nJyBpbiBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucy51c2luZy5jYWxsKGVsZW0sIHByb3BzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJFbGVtLmNzcyhwcm9wcyk7CiAgICAgIH0KICAgIH0KICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgb2Zmc2V0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHJldHVybiBvcHRpb25zID09PSB1bmRlZmluZWQgPyB0aGlzIDogdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICBqUXVlcnkub2Zmc2V0LnNldE9mZnNldCh0aGlzLCBvcHRpb25zLCBpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgZG9jRWxlbSwgd2luLCBlbGVtID0gdGhpc1swXSwgYm94ID0gewogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMAogICAgICAgIH0sIGRvYyA9IGVsZW0gJiYgZWxlbS5vd25lckRvY3VtZW50OwogICAgICBpZiAoIWRvYykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKICAgICAgLy8gTWFrZSBzdXJlIGl0J3Mgbm90IGEgZGlzY29ubmVjdGVkIERPTSBub2RlCiAgICAgIGlmICghalF1ZXJ5LmNvbnRhaW5zKGRvY0VsZW0sIGVsZW0pKSB7CiAgICAgICAgcmV0dXJuIGJveDsKICAgICAgfQogICAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIGdCQ1IsIGp1c3QgdXNlIDAsMCByYXRoZXIgdGhhbiBlcnJvcgogICAgICAvLyBCbGFja0JlcnJ5IDUsIGlPUyAzIChvcmlnaW5hbCBpUGhvbmUpCiAgICAgIGlmICh0eXBlb2YgZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09IHN0cnVuZGVmaW5lZCkgewogICAgICAgIGJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIH0KICAgICAgd2luID0gZ2V0V2luZG93KGRvYyk7CiAgICAgIHJldHVybiB7CiAgICAgICAgdG9wOiBib3gudG9wICsgd2luLnBhZ2VZT2Zmc2V0IC0gZG9jRWxlbS5jbGllbnRUb3AsCiAgICAgICAgbGVmdDogYm94LmxlZnQgKyB3aW4ucGFnZVhPZmZzZXQgLSBkb2NFbGVtLmNsaWVudExlZnQKICAgICAgfTsKICAgIH0sCiAgICBwb3NpdGlvbjogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXNbMF0pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIG9mZnNldFBhcmVudCwgb2Zmc2V0LCBlbGVtID0gdGhpc1swXSwgcGFyZW50T2Zmc2V0ID0gewogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMAogICAgICAgIH07CiAgICAgIC8vIEZpeGVkIGVsZW1lbnRzIGFyZSBvZmZzZXQgZnJvbSB3aW5kb3cgKHBhcmVudE9mZnNldCA9IHt0b3A6MCwgbGVmdDogMH0sIGJlY2F1c2UgaXQgaXMgaXRzIG9ubHkgb2Zmc2V0IHBhcmVudAogICAgICBpZiAoalF1ZXJ5LmNzcyhlbGVtLCAncG9zaXRpb24nKSA9PT0gJ2ZpeGVkJykgewogICAgICAgIC8vIFdlIGFzc3VtZSB0aGF0IGdldEJvdW5kaW5nQ2xpZW50UmVjdCBpcyBhdmFpbGFibGUgd2hlbiBjb21wdXRlZCBwb3NpdGlvbiBpcyBmaXhlZAogICAgICAgIG9mZnNldCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gR2V0ICpyZWFsKiBvZmZzZXRQYXJlbnQKICAgICAgICBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpOwogICAgICAgIC8vIEdldCBjb3JyZWN0IG9mZnNldHMKICAgICAgICBvZmZzZXQgPSB0aGlzLm9mZnNldCgpOwogICAgICAgIGlmICghalF1ZXJ5Lm5vZGVOYW1lKG9mZnNldFBhcmVudFswXSwgJ2h0bWwnKSkgewogICAgICAgICAgcGFyZW50T2Zmc2V0ID0gb2Zmc2V0UGFyZW50Lm9mZnNldCgpOwogICAgICAgIH0KICAgICAgICAvLyBBZGQgb2Zmc2V0UGFyZW50IGJvcmRlcnMKICAgICAgICBwYXJlbnRPZmZzZXQudG9wICs9IGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50WzBdLCAnYm9yZGVyVG9wV2lkdGgnLCB0cnVlKTsKICAgICAgICBwYXJlbnRPZmZzZXQubGVmdCArPSBqUXVlcnkuY3NzKG9mZnNldFBhcmVudFswXSwgJ2JvcmRlckxlZnRXaWR0aCcsIHRydWUpOwogICAgICB9CiAgICAgIC8vIFN1YnRyYWN0IHBhcmVudCBvZmZzZXRzIGFuZCBlbGVtZW50IG1hcmdpbnMKICAgICAgcmV0dXJuIHsKICAgICAgICB0b3A6IG9mZnNldC50b3AgLSBwYXJlbnRPZmZzZXQudG9wIC0galF1ZXJ5LmNzcyhlbGVtLCAnbWFyZ2luVG9wJywgdHJ1ZSksCiAgICAgICAgbGVmdDogb2Zmc2V0LmxlZnQgLSBwYXJlbnRPZmZzZXQubGVmdCAtIGpRdWVyeS5jc3MoZWxlbSwgJ21hcmdpbkxlZnQnLCB0cnVlKQogICAgICB9OwogICAgfSwKICAgIG9mZnNldFBhcmVudDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCB8fCBkb2NFbGVtOwogICAgICAgIHdoaWxlIChvZmZzZXRQYXJlbnQgJiYgKCFqUXVlcnkubm9kZU5hbWUob2Zmc2V0UGFyZW50LCAnaHRtbCcpICYmIGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50LCAncG9zaXRpb24nKSA9PT0gJ3N0YXRpYycpKSB7CiAgICAgICAgICBvZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgIH0KICAgICAgICByZXR1cm4gb2Zmc2V0UGFyZW50IHx8IGRvY0VsZW07CiAgICAgIH0pOwogICAgfQogIH0pOwogIC8vIENyZWF0ZSBzY3JvbGxMZWZ0IGFuZCBzY3JvbGxUb3AgbWV0aG9kcwogIGpRdWVyeS5lYWNoKHsKICAgIHNjcm9sbExlZnQ6ICdwYWdlWE9mZnNldCcsCiAgICBzY3JvbGxUb3A6ICdwYWdlWU9mZnNldCcKICB9LCBmdW5jdGlvbiAobWV0aG9kLCBwcm9wKSB7CiAgICB2YXIgdG9wID0gJ3BhZ2VZT2Zmc2V0JyA9PT0gcHJvcDsKICAgIGpRdWVyeS5mblttZXRob2RdID0gZnVuY3Rpb24gKHZhbCkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uIChlbGVtLCBtZXRob2QsIHZhbCkgewogICAgICAgIHZhciB3aW4gPSBnZXRXaW5kb3coZWxlbSk7CiAgICAgICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gd2luID8gd2luW3Byb3BdIDogZWxlbVttZXRob2RdOwogICAgICAgIH0KICAgICAgICBpZiAod2luKSB7CiAgICAgICAgICB3aW4uc2Nyb2xsVG8oIXRvcCA/IHZhbCA6IHdpbmRvdy5wYWdlWE9mZnNldCwgdG9wID8gdmFsIDogd2luZG93LnBhZ2VZT2Zmc2V0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbVttZXRob2RdID0gdmFsOwogICAgICAgIH0KICAgICAgfSwgbWV0aG9kLCB2YWwsIGFyZ3VtZW50cy5sZW5ndGgsIG51bGwpOwogICAgfTsKICB9KTsKICAvLyBBZGQgdGhlIHRvcC9sZWZ0IGNzc0hvb2tzIHVzaW5nIGpRdWVyeS5mbi5wb3NpdGlvbgogIC8vIFdlYmtpdCBidWc6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0yOTA4NAogIC8vIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyBwZXJjZW50IHdoZW4gc3BlY2lmaWVkIGZvciB0b3AvbGVmdC9ib3R0b20vcmlnaHQKICAvLyByYXRoZXIgdGhhbiBtYWtlIHRoZSBjc3MgbW9kdWxlIGRlcGVuZCBvbiB0aGUgb2Zmc2V0IG1vZHVsZSwgd2UganVzdCBjaGVjayBmb3IgaXQgaGVyZQogIGpRdWVyeS5lYWNoKFsKICAgICd0b3AnLAogICAgJ2xlZnQnCiAgXSwgZnVuY3Rpb24gKGksIHByb3ApIHsKICAgIGpRdWVyeS5jc3NIb29rc1twcm9wXSA9IGFkZEdldEhvb2tJZihzdXBwb3J0LnBpeGVsUG9zaXRpb24sIGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCkgewogICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICBjb21wdXRlZCA9IGN1ckNTUyhlbGVtLCBwcm9wKTsKICAgICAgICAvLyBpZiBjdXJDU1MgcmV0dXJucyBwZXJjZW50YWdlLCBmYWxsYmFjayB0byBvZmZzZXQKICAgICAgICByZXR1cm4gcm51bW5vbnB4LnRlc3QoY29tcHV0ZWQpID8galF1ZXJ5KGVsZW0pLnBvc2l0aW9uKClbcHJvcF0gKyAncHgnIDogY29tcHV0ZWQ7CiAgICAgIH0KICAgIH0pOwogIH0pOwogIC8vIENyZWF0ZSBpbm5lckhlaWdodCwgaW5uZXJXaWR0aCwgaGVpZ2h0LCB3aWR0aCwgb3V0ZXJIZWlnaHQgYW5kIG91dGVyV2lkdGggbWV0aG9kcwogIGpRdWVyeS5lYWNoKHsKICAgIEhlaWdodDogJ2hlaWdodCcsCiAgICBXaWR0aDogJ3dpZHRoJwogIH0sIGZ1bmN0aW9uIChuYW1lLCB0eXBlKSB7CiAgICBqUXVlcnkuZWFjaCh7CiAgICAgIHBhZGRpbmc6ICdpbm5lcicgKyBuYW1lLAogICAgICBjb250ZW50OiB0eXBlLAogICAgICAnJzogJ291dGVyJyArIG5hbWUKICAgIH0sIGZ1bmN0aW9uIChkZWZhdWx0RXh0cmEsIGZ1bmNOYW1lKSB7CiAgICAgIC8vIG1hcmdpbiBpcyBvbmx5IGZvciBvdXRlckhlaWdodCwgb3V0ZXJXaWR0aAogICAgICBqUXVlcnkuZm5bZnVuY05hbWVdID0gZnVuY3Rpb24gKG1hcmdpbiwgdmFsdWUpIHsKICAgICAgICB2YXIgY2hhaW5hYmxlID0gYXJndW1lbnRzLmxlbmd0aCAmJiAoZGVmYXVsdEV4dHJhIHx8IHR5cGVvZiBtYXJnaW4gIT09ICdib29sZWFuJyksIGV4dHJhID0gZGVmYXVsdEV4dHJhIHx8IChtYXJnaW4gPT09IHRydWUgfHwgdmFsdWUgPT09IHRydWUgPyAnbWFyZ2luJyA6ICdib3JkZXInKTsKICAgICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uIChlbGVtLCB0eXBlLCB2YWx1ZSkgewogICAgICAgICAgdmFyIGRvYzsKICAgICAgICAgIGlmIChqUXVlcnkuaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICAgICAgLy8gQXMgb2YgNS84LzIwMTIgdGhpcyB3aWxsIHlpZWxkIGluY29ycmVjdCByZXN1bHRzIGZvciBNb2JpbGUgU2FmYXJpLCBidXQgdGhlcmUKICAgICAgICAgICAgLy8gaXNuJ3QgYSB3aG9sZSBsb3Qgd2UgY2FuIGRvLiBTZWUgcHVsbCByZXF1ZXN0IGF0IHRoaXMgVVJMIGZvciBkaXNjdXNzaW9uOgogICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzc2NAogICAgICAgICAgICByZXR1cm4gZWxlbS5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbJ2NsaWVudCcgKyBuYW1lXTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEdldCBkb2N1bWVudCB3aWR0aCBvciBoZWlnaHQKICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICAgIGRvYyA9IGVsZW0uZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgICAvLyBFaXRoZXIgc2Nyb2xsW1dpZHRoL0hlaWdodF0gb3Igb2Zmc2V0W1dpZHRoL0hlaWdodF0gb3IgY2xpZW50W1dpZHRoL0hlaWdodF0sCiAgICAgICAgICAgIC8vIHdoaWNoZXZlciBpcyBncmVhdGVzdAogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoZWxlbS5ib2R5WydzY3JvbGwnICsgbmFtZV0sIGRvY1snc2Nyb2xsJyArIG5hbWVdLCBlbGVtLmJvZHlbJ29mZnNldCcgKyBuYW1lXSwgZG9jWydvZmZzZXQnICsgbmFtZV0sIGRvY1snY2xpZW50JyArIG5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8gLy8gR2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCwgcmVxdWVzdGluZyBidXQgbm90IGZvcmNpbmcgcGFyc2VGbG9hdAogICAgICAgICAgalF1ZXJ5LmNzcyhlbGVtLCB0eXBlLCBleHRyYSkgOiAvLyBTZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CiAgICAgICAgICBqUXVlcnkuc3R5bGUoZWxlbSwgdHlwZSwgdmFsdWUsIGV4dHJhKTsKICAgICAgICB9LCB0eXBlLCBjaGFpbmFibGUgPyBtYXJnaW4gOiB1bmRlZmluZWQsIGNoYWluYWJsZSwgbnVsbCk7CiAgICAgIH07CiAgICB9KTsKICB9KTsKICAvLyBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGNvbnRhaW5lZCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldAogIGpRdWVyeS5mbi5zaXplID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoOwogIH07CiAgalF1ZXJ5LmZuLmFuZFNlbGYgPSBqUXVlcnkuZm4uYWRkQmFjazsKICAvLyBSZWdpc3RlciBhcyBhIG5hbWVkIEFNRCBtb2R1bGUsIHNpbmNlIGpRdWVyeSBjYW4gYmUgY29uY2F0ZW5hdGVkIHdpdGggb3RoZXIKICAvLyBmaWxlcyB0aGF0IG1heSB1c2UgZGVmaW5lLCBidXQgbm90IHZpYSBhIHByb3BlciBjb25jYXRlbmF0aW9uIHNjcmlwdCB0aGF0CiAgLy8gdW5kZXJzdGFuZHMgYW5vbnltb3VzIEFNRCBtb2R1bGVzLiBBIG5hbWVkIEFNRCBpcyBzYWZlc3QgYW5kIG1vc3Qgcm9idXN0CiAgLy8gd2F5IHRvIHJlZ2lzdGVyLiBMb3dlcmNhc2UganF1ZXJ5IGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZQogIC8vIGRlcml2ZWQgZnJvbSBmaWxlIG5hbWVzLCBhbmQgalF1ZXJ5IGlzIG5vcm1hbGx5IGRlbGl2ZXJlZCBpbiBhIGxvd2VyY2FzZQogIC8vIGZpbGUgbmFtZS4gRG8gdGhpcyBhZnRlciBjcmVhdGluZyB0aGUgZ2xvYmFsIHNvIHRoYXQgaWYgYW4gQU1EIG1vZHVsZSB3YW50cwogIC8vIHRvIGNhbGwgbm9Db25mbGljdCB0byBoaWRlIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnksIGl0IHdpbGwgd29yay4KICAvLyBOb3RlIHRoYXQgZm9yIG1heGltdW0gcG9ydGFiaWxpdHksIGxpYnJhcmllcyB0aGF0IGFyZSBub3QgalF1ZXJ5IHNob3VsZAogIC8vIGRlY2xhcmUgdGhlbXNlbHZlcyBhcyBhbm9ueW1vdXMgbW9kdWxlcywgYW5kIGF2b2lkIHNldHRpbmcgYSBnbG9iYWwgaWYgYW4KICAvLyBBTUQgbG9hZGVyIGlzIHByZXNlbnQuIGpRdWVyeSBpcyBhIHNwZWNpYWwgY2FzZS4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZQogIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcmJ1cmtlL3JlcXVpcmVqcy93aWtpL1VwZGF0aW5nLWV4aXN0aW5nLWxpYnJhcmllcyN3aWtpLWFub24KICBpZiAodHJ1ZSkgewogICAganF1ZXJ5ID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4galF1ZXJ5OwogICAgfSgpOwogIH0KICB2YXIKICAgIC8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQogICAgX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksCiAgICAvLyBNYXAgb3ZlciB0aGUgJCBpbiBjYXNlIG9mIG92ZXJ3cml0ZQogICAgXyQgPSB3aW5kb3cuJDsKICBqUXVlcnkubm9Db25mbGljdCA9IGZ1bmN0aW9uIChkZWVwKSB7CiAgICBpZiAod2luZG93LiQgPT09IGpRdWVyeSkgewogICAgICB3aW5kb3cuJCA9IF8kOwogICAgfQogICAgaWYgKGRlZXAgJiYgd2luZG93LmpRdWVyeSA9PT0galF1ZXJ5KSB7CiAgICAgIHdpbmRvdy5qUXVlcnkgPSBfalF1ZXJ5OwogICAgfQogICAgcmV0dXJuIGpRdWVyeTsKICB9OwogIC8vIEV4cG9zZSBqUXVlcnkgYW5kICQgaWRlbnRpZmllcnMsIGV2ZW4gaW4KICAvLyBBTUQgKCM3MTAyI2NvbW1lbnQ6MTAsIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNTU3KQogIC8vIGFuZCBDb21tb25KUyBmb3IgYnJvd3NlciBlbXVsYXRvcnMgKCMxMzU2NikKICBpZiAodHlwZW9mIG5vR2xvYmFsID09PSBzdHJ1bmRlZmluZWQpIHsKICAgIHdpbmRvdy5qUXVlcnkgPSB3aW5kb3cuJCA9IGpRdWVyeTsKICB9CiAgcmV0dXJuIGpRdWVyeTsKfSkpOwovLyAgICAgQmFja2JvbmUuanMgMS4xLjIKLy8gICAgIChjKSAyMDEwLTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIC8vIFNldCB1cCBCYWNrYm9uZSBhcHByb3ByaWF0ZWx5IGZvciB0aGUgZW52aXJvbm1lbnQuIFN0YXJ0IHdpdGggQU1ELgogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZSA9IGZ1bmN0aW9uIChfLCAkLCBleHBvcnRzKSB7CiAgICAgIC8vIEV4cG9ydCBnbG9iYWwgZXZlbiBpbiBBTUQgY2FzZSBpbiBjYXNlIHRoaXMgc2NyaXB0IGlzIGxvYWRlZCB3aXRoCiAgICAgIC8vIG90aGVycyB0aGF0IG1heSBzdGlsbCBleHBlY3QgYSBnbG9iYWwgQmFja2JvbmUuCiAgICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8sICQpOwogICAgICByZXR1cm4gZXhwb3J0czsKICAgIH0odW5kZXJzY29yZSwganF1ZXJ5LCB7fSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBfID0gdW5kZXJzY29yZTsKICAgIGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXyk7CiAgfSBlbHNlIHsKICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIHt9LCByb290Ll8sIHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQpOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAocm9vdCwgQmFja2JvbmUsIF8sICQpIHsKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlLCBzbyB0aGF0IGl0IGNhbiBiZQogIC8vIHJlc3RvcmVkIGxhdGVyIG9uLCBpZiBgbm9Db25mbGljdGAgaXMgdXNlZC4KICB2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7CiAgLy8gQ3JlYXRlIGxvY2FsIHJlZmVyZW5jZXMgdG8gYXJyYXkgbWV0aG9kcyB3ZSdsbCB3YW50IHRvIHVzZSBsYXRlci4KICB2YXIgYXJyYXkgPSBbXTsKICB2YXIgcHVzaCA9IGFycmF5LnB1c2g7CiAgdmFyIHNsaWNlID0gYXJyYXkuc2xpY2U7CiAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgogIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjInOwogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwogIC8vIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9ICQ7CiAgLy8gUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCiAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgogIEJhY2tib25lLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgogIC8vIHdpbGwgZmFrZSBgIlBBVENIImAsIGAiUFVUImAgYW5kIGAiREVMRVRFImAgcmVxdWVzdHMgdmlhIHRoZSBgX21ldGhvZGAgcGFyYW1ldGVyIGFuZAogIC8vIHNldCBhIGBYLUh0dHAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgQmFja2JvbmUuZW11bGF0ZUhUVFAgPSBmYWxzZTsKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAogIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKICAvLyBmdW5jdGlvbnMgdG8gYW4gZXZlbnQ7IGB0cmlnZ2VyYC1pbmcgYW4gZXZlbnQgZmlyZXMgYWxsIGNhbGxiYWNrcyBpbgogIC8vIHN1Y2Nlc3Npb24uCiAgLy8KICAvLyAgICAgdmFyIG9iamVjdCA9IHt9OwogIC8vICAgICBfLmV4dGVuZChvYmplY3QsIEJhY2tib25lLkV2ZW50cyk7CiAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwogIC8vICAgICBvYmplY3QudHJpZ2dlcignZXhwYW5kJyk7CiAgLy8KICB2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbCiAgICAgICAgICBjYWxsYmFjaywKICAgICAgICAgIGNvbnRleHQKICAgICAgICBdKSB8fCAhY2FsbGJhY2spCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHsKICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICBjdHg6IGNvbnRleHQgfHwgdGhpcwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gQmluZCBhbiBldmVudCB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQogICAgLy8gdGhlIGNhbGxiYWNrIGlzIGludm9rZWQsIGl0IHdpbGwgYmUgcmVtb3ZlZC4KICAgIG9uY2U6IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFsKICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgY29udGV4dAogICAgICAgIF0pIHx8ICFjYWxsYmFjaykKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgb25jZSA9IF8ub25jZShmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwogICAgfSwKICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBuYW1lYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAogICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgogICAgb2ZmOiBmdW5jdGlvbiAobmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgdmFyIHJldGFpbiwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFsKICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgY29udGV4dAogICAgICAgIF0pKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICBpZiAoIW5hbWUgJiYgIWNhbGxiYWNrICYmICFjb250ZXh0KSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0gdm9pZCAwOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIG5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IF8ua2V5cyh0aGlzLl9ldmVudHMpOwogICAgICBmb3IgKGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbmFtZSA9IG5hbWVzW2ldOwogICAgICAgIGlmIChldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0pIHsKICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IHJldGFpbiA9IFtdOwogICAgICAgICAgaWYgKGNhbGxiYWNrIHx8IGNvbnRleHQpIHsKICAgICAgICAgICAgZm9yIChqID0gMCwgayA9IGV2ZW50cy5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBldiA9IGV2ZW50c1tqXTsKICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2sgfHwgY29udGV4dCAmJiBjb250ZXh0ICE9PSBldi5jb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXRhaW4ucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJldGFpbi5sZW5ndGgpCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbbmFtZV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgLy8gcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgIC8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgIC8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KICAgIHRyaWdnZXI6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ3RyaWdnZXInLCBuYW1lLCBhcmdzKSkKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpCiAgICAgICAgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKQogICAgICAgIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCiAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgogICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24gKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG87CiAgICAgIGlmICghbGlzdGVuaW5nVG8pCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIHZhciByZW1vdmUgPSAhbmFtZSAmJiAhY2FsbGJhY2s7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKQogICAgICAgIGNhbGxiYWNrID0gdGhpczsKICAgICAgaWYgKG9iaikKICAgICAgICAobGlzdGVuaW5nVG8gPSB7fSlbb2JqLl9saXN0ZW5JZF0gPSBvYmo7CiAgICAgIGZvciAodmFyIGlkIGluIGxpc3RlbmluZ1RvKSB7CiAgICAgICAgb2JqID0gbGlzdGVuaW5nVG9baWRdOwogICAgICAgIG9iai5vZmYobmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICAgIGlmIChyZW1vdmUgfHwgXy5pc0VtcHR5KG9iai5fZXZlbnRzKSkKICAgICAgICAgIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfTsKICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgogIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uIChvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewogICAgaWYgKCFuYW1lKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgWwogICAgICAgICAga2V5LAogICAgICAgICAgbmFtZVtrZXldCiAgICAgICAgXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8vIEhhbmRsZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMuCiAgICBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CiAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfTsKICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgogIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKICAvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbiAoZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICBjYXNlIDA6CiAgICAgIHdoaWxlICgrK2kgPCBsKQogICAgICAgIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgpOwogICAgICByZXR1cm47CiAgICBjYXNlIDE6CiAgICAgIHdoaWxlICgrK2kgPCBsKQogICAgICAgIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsKICAgICAgcmV0dXJuOwogICAgY2FzZSAyOgogICAgICB3aGlsZSAoKytpIDwgbCkKICAgICAgICAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOwogICAgICByZXR1cm47CiAgICBjYXNlIDM6CiAgICAgIHdoaWxlICgrK2kgPCBsKQogICAgICAgIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMiwgYTMpOwogICAgICByZXR1cm47CiAgICBkZWZhdWx0OgogICAgICB3aGlsZSAoKytpIDwgbCkKICAgICAgICAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CiAgICAgIHJldHVybjsKICAgIH0KICB9OwogIHZhciBsaXN0ZW5NZXRob2RzID0gewogICAgbGlzdGVuVG86ICdvbicsCiAgICBsaXN0ZW5Ub09uY2U6ICdvbmNlJwogIH07CiAgLy8gSW52ZXJzaW9uLW9mLWNvbnRyb2wgdmVyc2lvbnMgb2YgYG9uYCBhbmQgYG9uY2VgLiBUZWxsICp0aGlzKiBvYmplY3QgdG8KICAvLyBsaXN0ZW4gdG8gYW4gZXZlbnQgaW4gYW5vdGhlciBvYmplY3QgLi4uIGtlZXBpbmcgdHJhY2sgb2Ygd2hhdCBpdCdzCiAgLy8gbGlzdGVuaW5nIHRvLgogIF8uZWFjaChsaXN0ZW5NZXRob2RzLCBmdW5jdGlvbiAoaW1wbGVtZW50YXRpb24sIG1ldGhvZCkgewogICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbiAob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKQogICAgICAgIGNhbGxiYWNrID0gdGhpczsKICAgICAgb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKICAvLyBBbGlhc2VzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KICBFdmVudHMuYmluZCA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKICAvLyBBbGxvdyB0aGUgYEJhY2tib25lYCBvYmplY3QgdG8gc2VydmUgYXMgYSBnbG9iYWwgZXZlbnQgYnVzLCBmb3IgZm9sa3Mgd2hvCiAgLy8gd2FudCBnbG9iYWwgInB1YnN1YiIgaW4gYSBjb252ZW5pZW50IHBsYWNlLgogIF8uZXh0ZW5kKEJhY2tib25lLCBFdmVudHMpOwogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLyBCYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQogIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCiAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCiAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggdGhlIHNwZWNpZmllZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApCiAgLy8gaXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIGFzc2lnbmVkIGZvciB5b3UuCiAgdmFyIE1vZGVsID0gQmFja2JvbmUuTW9kZWwgPSBmdW5jdGlvbiAoYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikKICAgICAgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwogICAgaWYgKG9wdGlvbnMucGFyc2UpCiAgICAgIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSk7CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuCiAgXy5leHRlbmQoTW9kZWwucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCiAgICAvLyBUaGUgdmFsdWUgcmV0dXJuZWQgZHVyaW5nIHRoZSBsYXN0IGZhaWxlZCB2YWxpZGF0aW9uLgogICAgdmFsaWRhdGlvbkVycm9yOiBudWxsLAogICAgLy8gVGhlIGRlZmF1bHQgbmFtZSBmb3IgdGhlIEpTT04gYGlkYCBhdHRyaWJ1dGUgaXMgYCJpZCJgLiBNb25nb0RCIGFuZAogICAgLy8gQ291Y2hEQiB1c2VycyBtYXkgd2FudCB0byBzZXQgdGhpcyB0byBgIl9pZCJgLgogICAgaWRBdHRyaWJ1dGU6ICdpZCcsCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgfSwKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1thdHRyXTsKICAgIH0sCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgIHJldHVybiBfLmVzY2FwZSh0aGlzLmdldChhdHRyKSk7CiAgICB9LAogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0KGF0dHIpICE9IG51bGw7CiAgICB9LAogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbiAoa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHIsIGF0dHJzLCB1bnNldCwgY2hhbmdlcywgc2lsZW50LCBjaGFuZ2luZywgcHJldiwgY3VycmVudDsKICAgICAgaWYgKGtleSA9PSBudWxsKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAvLyBFeHRyYWN0IGF0dHJpYnV0ZXMgYW5kIG9wdGlvbnMuCiAgICAgIHVuc2V0ID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgPSBbXTsKICAgICAgY2hhbmdpbmcgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgPSB0cnVlOwogICAgICBpZiAoIWNoYW5naW5nKSB7CiAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgICB9CiAgICAgIGN1cnJlbnQgPSB0aGlzLmF0dHJpYnV0ZXMsIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKQogICAgICAgIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKICAgICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLCB1cGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgogICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKICAgICAgICB2YWwgPSBhdHRyc1thdHRyXTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChjdXJyZW50W2F0dHJdLCB2YWwpKQogICAgICAgICAgY2hhbmdlcy5wdXNoKGF0dHIpOwogICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkpIHsKICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlZFthdHRyXTsKICAgICAgICB9CiAgICAgICAgdW5zZXQgPyBkZWxldGUgY3VycmVudFthdHRyXSA6IGN1cnJlbnRbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgLy8gVHJpZ2dlciBhbGwgcmVsZXZhbnQgYXR0cmlidXRlIGNoYW5nZXMuCiAgICAgIGlmICghc2lsZW50KSB7CiAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoKQogICAgICAgICAgdGhpcy5fcGVuZGluZyA9IG9wdGlvbnM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6JyArIGNoYW5nZXNbaV0sIHRoaXMsIGN1cnJlbnRbY2hhbmdlc1tpXV0sIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBZb3UgbWlnaHQgYmUgd29uZGVyaW5nIHdoeSB0aGVyZSdzIGEgYHdoaWxlYCBsb29wIGhlcmUuIENoYW5nZXMgY2FuCiAgICAgIC8vIGJlIHJlY3Vyc2l2ZWx5IG5lc3RlZCB3aXRoaW4gYCJjaGFuZ2UiYCBldmVudHMuCiAgICAgIGlmIChjaGFuZ2luZykKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgb3B0aW9ucyA9IHRoaXMuX3BlbmRpbmc7CiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFJlbW92ZSBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLiBgdW5zZXRgIGlzIGEgbm9vcAogICAgLy8gaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgdW5zZXQ6IGZ1bmN0aW9uIChhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7IHVuc2V0OiB0cnVlIH0pKTsKICAgIH0sCiAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLgogICAgY2xlYXI6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKQogICAgICAgIGF0dHJzW2tleV0gPSB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHsgdW5zZXQ6IHRydWUgfSkpOwogICAgfSwKICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbiAoYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsKQogICAgICAgIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwogICAgfSwKICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCiAgICAvLyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gY2hhbmdlZCBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIGRldGVybWluaW5nIHdoYXQKICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICAvLyBZb3UgY2FuIGFsc28gcGFzcyBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBkaWZmIGFnYWluc3QgdGhlIG1vZGVsLAogICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbiAoZGlmZikgewogICAgICBpZiAoIWRpZmYpCiAgICAgICAgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gXy5jbG9uZSh0aGlzLmNoYW5nZWQpIDogZmFsc2U7CiAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKHZhciBhdHRyIGluIGRpZmYpIHsKICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgdmFsID0gZGlmZlthdHRyXSkpCiAgICAgICAgICBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAogICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CiAgICAvLyBgImNoYW5nZSJgIGV2ZW50IHdhcyBmaXJlZC4KICAgIHByZXZpb3VzOiBmdW5jdGlvbiAoYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAogICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CiAgICB9LAogICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQogICAgLy8gbW9kZWwgZGlmZmVycyBmcm9tIGl0cyBjdXJyZW50IGF0dHJpYnV0ZXMsIHRoZXkgd2lsbCBiZSBvdmVycmlkZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApCiAgICAgICAgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpLCBvcHRpb25zKSkKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCiAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKICAgIC8vIHN0YXRlIHdpbGwgYmUgYHNldGAgYWdhaW4uCiAgICBzYXZlOiBmdW5jdGlvbiAoa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsgdmFsaWRhdGU6IHRydWUgfSwgb3B0aW9ucyk7CiAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKICAgICAgLy8gYHNldChhdHRyKS5zYXZlKG51bGwsIG9wdHMpYCB3aXRoIHZhbGlkYXRpb24uIE90aGVyd2lzZSwgY2hlY2sgaWYKICAgICAgLy8gdGhlIG1vZGVsIHdpbGwgYmUgdmFsaWQgd2hlbiB0aGUgYXR0cmlidXRlcywgaWYgYW55LCBhcmUgc2V0LgogICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewogICAgICAgIGlmICghdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIFNldCB0ZW1wb3JhcnkgYXR0cmlidXRlcyBpZiBge3dhaXQ6IHRydWV9YC4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgewogICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IF8uZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgIH0KICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApCiAgICAgICAgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgIC8vIEVuc3VyZSBhdHRyaWJ1dGVzIGFyZSByZXN0b3JlZCBkdXJpbmcgc3luY2hyb25vdXMgc2F2ZXMuCiAgICAgICAgbW9kZWwuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkKICAgICAgICAgIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKICAgICAgICBpZiAoXy5pc09iamVjdChzZXJ2ZXJBdHRycykgJiYgIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogb3B0aW9ucy5wYXRjaCA/ICdwYXRjaCcgOiAndXBkYXRlJzsKICAgICAgaWYgKG1ldGhvZCA9PT0gJ3BhdGNoJykKICAgICAgICBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwogICAgICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpCiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpCiAgICAgICAgICBkZXN0cm95KCk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoIW1vZGVsLmlzTmV3KCkpCiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgdmFyIHhociA9IHRoaXMuc3luYygnZGVsZXRlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KQogICAgICAgIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCiAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICB1cmw6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpCiAgICAgICAgcmV0dXJuIGJhc2U7CiAgICAgIHJldHVybiBiYXNlLnJlcGxhY2UoLyhbXlwvXSkkLywgJyQxLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwogICAgfSwKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uIChyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICF0aGlzLmhhcyh0aGlzLmlkQXR0cmlidXRlKTsKICAgIH0sCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGUoe30sIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsgdmFsaWRhdGU6IHRydWUgfSkpOwogICAgfSwKICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCiAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uIChhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRpb25FcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHx8IG51bGw7CiAgICAgIGlmICghZXJyb3IpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIGVycm9yLCBfLmV4dGVuZChvcHRpb25zLCB7IHZhbGlkYXRpb25FcnJvcjogZXJyb3IgfSkpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSk7CiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIE1vZGVsLgogIHZhciBtb2RlbE1ldGhvZHMgPSBbCiAgICAna2V5cycsCiAgICAndmFsdWVzJywKICAgICdwYWlycycsCiAgICAnaW52ZXJ0JywKICAgICdwaWNrJywKICAgICdvbWl0JwogIF07CiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgTW9kZWwjYXR0cmlidXRlc2AuCiAgXy5lYWNoKG1vZGVsTWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLyBJZiBtb2RlbHMgdGVuZCB0byByZXByZXNlbnQgYSBzaW5nbGUgcm93IG9mIGRhdGEsIGEgQmFja2JvbmUgQ29sbGVjdGlvbiBpcwogIC8vIG1vcmUgYW5hbGFnb3VzIHRvIGEgdGFibGUgZnVsbCBvZiBkYXRhIC4uLiBvciBhIHNtYWxsIHNsaWNlIG9yIHBhZ2Ugb2YgdGhhdAogIC8vIHRhYmxlLCBvciBhIGNvbGxlY3Rpb24gb2Ygcm93cyB0aGF0IGJlbG9uZyB0b2dldGhlciBmb3IgYSBwYXJ0aWN1bGFyIHJlYXNvbgogIC8vIC0tIGFsbCBvZiB0aGUgbWVzc2FnZXMgaW4gdGhpcyBwYXJ0aWN1bGFyIGZvbGRlciwgYWxsIG9mIHRoZSBkb2N1bWVudHMKICAvLyBiZWxvbmdpbmcgdG8gdGhpcyBwYXJ0aWN1bGFyIGF1dGhvciwgYW5kIHNvIG9uLiBDb2xsZWN0aW9ucyBtYWludGFpbgogIC8vIGluZGV4ZXMgb2YgdGhlaXIgbW9kZWxzLCBib3RoIGluIG9yZGVyLCBhbmQgZm9yIGxvb2t1cCBieSBgaWRgLgogIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgogIC8vIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbgogIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMubW9kZWwpCiAgICAgIHRoaXMubW9kZWwgPSBvcHRpb25zLm1vZGVsOwogICAgaWYgKG9wdGlvbnMuY29tcGFyYXRvciAhPT0gdm9pZCAwKQogICAgICB0aGlzLmNvbXBhcmF0b3IgPSBvcHRpb25zLmNvbXBhcmF0b3I7CiAgICB0aGlzLl9yZXNldCgpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAobW9kZWxzKQogICAgICB0aGlzLnJlc2V0KG1vZGVscywgXy5leHRlbmQoeyBzaWxlbnQ6IHRydWUgfSwgb3B0aW9ucykpOwogIH07CiAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgogIHZhciBzZXRPcHRpb25zID0gewogICAgYWRkOiB0cnVlLAogICAgcmVtb3ZlOiB0cnVlLAogICAgbWVyZ2U6IHRydWUKICB9OwogIHZhciBhZGRPcHRpb25zID0gewogICAgYWRkOiB0cnVlLAogICAgcmVtb3ZlOiBmYWxzZQogIH07CiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CiAgICAvLyBUaGUgZGVmYXVsdCBtb2RlbCBmb3IgYSBjb2xsZWN0aW9uIGlzIGp1c3QgYSAqKkJhY2tib25lLk1vZGVsKiouCiAgICAvLyBUaGlzIHNob3VsZCBiZSBvdmVycmlkZGVuIGluIG1vc3QgY2FzZXMuCiAgICBtb2RlbDogTW9kZWwsCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgfSwKICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUKICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KICAgIHRvSlNPTjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7CiAgICAgIH0pOwogICAgfSwKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgogICAgc3luYzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEFkZCBhIG1vZGVsLCBvciBsaXN0IG9mIG1vZGVscyB0byB0aGUgc2V0LgogICAgYWRkOiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHsgbWVyZ2U6IGZhbHNlIH0sIG9wdGlvbnMsIGFkZE9wdGlvbnMpKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCiAgICByZW1vdmU6IGZ1bmN0aW9uIChtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IFttb2RlbHNdIDogXy5jbG9uZShtb2RlbHMpOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5nZXQobW9kZWxzW2ldKTsKICAgICAgICBpZiAoIW1vZGVsKQogICAgICAgICAgY29udGludWU7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKICAgIC8vIFVwZGF0ZSBhIGNvbGxlY3Rpb24gYnkgYHNldGAtaW5nIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCBhZGRpbmcgbmV3IG9uZXMsCiAgICAvLyByZW1vdmluZyBtb2RlbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHByZXNlbnQsIGFuZCBtZXJnaW5nIG1vZGVscyB0aGF0CiAgICAvLyBhbHJlYWR5IGV4aXN0IGluIHRoZSBjb2xsZWN0aW9uLCBhcyBuZWNlc3NhcnkuIFNpbWlsYXIgdG8gKipNb2RlbCNzZXQqKiwKICAgIC8vIHRoZSBjb3JlIG9wZXJhdGlvbiBmb3IgdXBkYXRpbmcgdGhlIGRhdGEgY29udGFpbmVkIGJ5IHRoZSBjb2xsZWN0aW9uLgogICAgc2V0OiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpCiAgICAgICAgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMsIG9wdGlvbnMpOwogICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CiAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gbW9kZWxzID8gW21vZGVsc10gOiBbXSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgdmFyIGksIGwsIGlkLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwogICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwogICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgYXQgPT0gbnVsbCAmJiBvcHRpb25zLnNvcnQgIT09IGZhbHNlOwogICAgICB2YXIgc29ydEF0dHIgPSBfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgPyB0aGlzLmNvbXBhcmF0b3IgOiBudWxsOwogICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKICAgICAgdmFyIGFkZCA9IG9wdGlvbnMuYWRkLCBtZXJnZSA9IG9wdGlvbnMubWVyZ2UsIHJlbW92ZSA9IG9wdGlvbnMucmVtb3ZlOwogICAgICB2YXIgb3JkZXIgPSAhc29ydGFibGUgJiYgYWRkICYmIHJlbW92ZSA/IFtdIDogZmFsc2U7CiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBhdHRycyA9IG1vZGVsc1tpXSB8fCB7fTsKICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZSB8fCAnaWQnXTsKICAgICAgICB9CiAgICAgICAgLy8gSWYgYSBkdXBsaWNhdGUgaXMgZm91bmQsIHByZXZlbnQgaXQgZnJvbSBiZWluZyBhZGRlZCBhbmQKICAgICAgICAvLyBvcHRpb25hbGx5IG1lcmdlIGl0IGludG8gdGhlIGV4aXN0aW5nIG1vZGVsLgogICAgICAgIGlmIChleGlzdGluZyA9IHRoaXMuZ2V0KGlkKSkgewogICAgICAgICAgaWYgKHJlbW92ZSkKICAgICAgICAgICAgbW9kZWxNYXBbZXhpc3RpbmcuY2lkXSA9IHRydWU7CiAgICAgICAgICBpZiAobWVyZ2UpIHsKICAgICAgICAgICAgYXR0cnMgPSBhdHRycyA9PT0gbW9kZWwgPyBtb2RlbC5hdHRyaWJ1dGVzIDogYXR0cnM7CiAgICAgICAgICAgIGlmIChvcHRpb25zLnBhcnNlKQogICAgICAgICAgICAgIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydGFibGUgJiYgIXNvcnQgJiYgZXhpc3RpbmcuaGFzQ2hhbmdlZChzb3J0QXR0cikpCiAgICAgICAgICAgICAgc29ydCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBtb2RlbHNbaV0gPSBleGlzdGluZzsgIC8vIElmIHRoaXMgaXMgYSBuZXcsIHZhbGlkIG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgdG9BZGRgIGxpc3QuCiAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgIGlmICghbW9kZWwpCiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CiAgICAgICAgICB0aGlzLl9hZGRSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICAvLyBEbyBub3QgYWRkIG11bHRpcGxlIG1vZGVscyB3aXRoIHRoZSBzYW1lIGBpZGAuCiAgICAgICAgbW9kZWwgPSBleGlzdGluZyB8fCBtb2RlbDsKICAgICAgICBpZiAob3JkZXIgJiYgKG1vZGVsLmlzTmV3KCkgfHwgIW1vZGVsTWFwW21vZGVsLmlkXSkpCiAgICAgICAgICBvcmRlci5wdXNoKG1vZGVsKTsKICAgICAgICBtb2RlbE1hcFttb2RlbC5pZF0gPSB0cnVlOwogICAgICB9CiAgICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pCiAgICAgICAgICAgIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgICBpZiAodG9SZW1vdmUubGVuZ3RoKQogICAgICAgICAgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKHRvQWRkLmxlbmd0aCB8fCBvcmRlciAmJiBvcmRlci5sZW5ndGgpIHsKICAgICAgICBpZiAoc29ydGFibGUpCiAgICAgICAgICBzb3J0ID0gdHJ1ZTsKICAgICAgICB0aGlzLmxlbmd0aCArPSB0b0FkZC5sZW5ndGg7CiAgICAgICAgaWYgKGF0ICE9IG51bGwpIHsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0b0FkZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGF0ICsgaSwgMCwgdG9BZGRbaV0pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAob3JkZXIpCiAgICAgICAgICAgIHRoaXMubW9kZWxzLmxlbmd0aCA9IDA7CiAgICAgICAgICB2YXIgb3JkZXJlZE1vZGVscyA9IG9yZGVyIHx8IHRvQWRkOwogICAgICAgICAgZm9yIChpID0gMCwgbCA9IG9yZGVyZWRNb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMubW9kZWxzLnB1c2gob3JkZXJlZE1vZGVsc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KQogICAgICAgIHRoaXMuc29ydCh7IHNpbGVudDogdHJ1ZSB9KTsKICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnQgfHwgb3JkZXIgJiYgb3JkZXIubGVuZ3RoKQogICAgICAgICAgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgLy8gUmV0dXJuIHRoZSBhZGRlZCAob3IgbWVyZ2VkKSBtb2RlbCAob3IgbW9kZWxzKS4KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCiAgICByZXNldDogZnVuY3Rpb24gKG1vZGVscywgb3B0aW9ucykgewogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOwogICAgICB0aGlzLl9yZXNldCgpOwogICAgICBtb2RlbHMgPSB0aGlzLmFkZChtb2RlbHMsIF8uZXh0ZW5kKHsgc2lsZW50OiB0cnVlIH0sIG9wdGlvbnMpKTsKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkKICAgICAgICB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbHM7CiAgICB9LAogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHB1c2g6IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHsgYXQ6IHRoaXMubGVuZ3RoIH0sIG9wdGlvbnMpKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQodGhpcy5sZW5ndGggLSAxKTsKICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHsgYXQ6IDAgfSwgb3B0aW9ucykpOwogICAgfSwKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHNoaWZ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICBzbGljZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc2xpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmpdIHx8IHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdOwogICAgfSwKICAgIC8vIEdldCB0aGUgbW9kZWwgYXQgdGhlIGdpdmVuIGluZGV4LgogICAgYXQ6IGZ1bmN0aW9uIChpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKICAgIC8vIFJldHVybiBtb2RlbHMgd2l0aCBtYXRjaGluZyBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIHNpbXBsZSBjYXNlcyBvZgogICAgLy8gYGZpbHRlcmAuCiAgICB3aGVyZTogZnVuY3Rpb24gKGF0dHJzLCBmaXJzdCkgewogICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkKICAgICAgICByZXR1cm4gZmlyc3QgPyB2b2lkIDAgOiBbXTsKICAgICAgcmV0dXJuIHRoaXNbZmlyc3QgPyAnZmluZCcgOiAnZmlsdGVyJ10oZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKICAgIC8vIFJldHVybiB0aGUgZmlyc3QgbW9kZWwgd2l0aCBtYXRjaGluZyBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIHNpbXBsZSBjYXNlcwogICAgLy8gb2YgYGZpbmRgLgogICAgZmluZFdoZXJlOiBmdW5jdGlvbiAoYXR0cnMpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwogICAgfSwKICAgIC8vIEZvcmNlIHRoZSBjb2xsZWN0aW9uIHRvIHJlLXNvcnQgaXRzZWxmLiBZb3UgZG9uJ3QgbmVlZCB0byBjYWxsIHRoaXMgdW5kZXIKICAgIC8vIG5vcm1hbCBjaXJjdW1zdGFuY2VzLCBhcyB0aGUgc2V0IHdpbGwgbWFpbnRhaW4gc29ydCBvcmRlciBhcyBlYWNoIGl0ZW0KICAgIC8vIGlzIGFkZGVkLgogICAgc29ydDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc29ydCBhIHNldCB3aXRob3V0IGEgY29tcGFyYXRvcicpOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAvLyBSdW4gc29ydCBiYXNlZCBvbiB0eXBlIG9mIGBjb21wYXJhdG9yYC4KICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwogICAgICB9CiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpCiAgICAgICAgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBwbHVjazogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7CiAgICB9LAogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHJlc2V0YCBtZXRob2QgaW5zdGVhZCBvZiBgc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkKICAgICAgICBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICB2YXIgbWV0aG9kID0gb3B0aW9ucy5yZXNldCA/ICdyZXNldCcgOiAnc2V0JzsKICAgICAgICBjb2xsZWN0aW9uW21ldGhvZF0ocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCiAgICAvLyBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgYSBtb2RlbCBpbiB0aGlzIGNvbGxlY3Rpb24uIEFkZCB0aGUgbW9kZWwgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uIGltbWVkaWF0ZWx5LCB1bmxlc3MgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgaW4gd2hpY2ggY2FzZSB3ZQogICAgLy8gd2FpdCBmb3IgdGhlIHNlcnZlciB0byBhZ3JlZS4KICAgIGNyZWF0ZTogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucykpKQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpCiAgICAgICAgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAobW9kZWwsIHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KQogICAgICAgICAgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKQogICAgICAgICAgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgaXQgdGhyb3VnaC4KICAgIHBhcnNlOiBmdW5jdGlvbiAocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCiAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAogICAgLy8gUHJpdmF0ZSBtZXRob2QgdG8gcmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaXMgZmlyc3QgaW5pdGlhbGl6ZWQgb3IgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICB0aGlzLl9ieUlkID0ge307CiAgICB9LAogICAgLy8gUHJlcGFyZSBhIGhhc2ggb2YgYXR0cmlidXRlcyAob3Igb3RoZXIgbW9kZWwpIHRvIGJlIGFkZGVkIHRvIHRoaXMKICAgIC8vIGNvbGxlY3Rpb24uCiAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbiAoYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpCiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgb3B0aW9ucy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIG1vZGVsID0gbmV3IHRoaXMubW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICBpZiAoIW1vZGVsLnZhbGlkYXRpb25FcnJvcikKICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIG1vZGVsLnZhbGlkYXRpb25FcnJvciwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KICAgIF9hZGRSZWZlcmVuY2U6IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykgewogICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpCiAgICAgICAgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgaWYgKCFtb2RlbC5jb2xsZWN0aW9uKQogICAgICAgIG1vZGVsLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzID09PSBtb2RlbC5jb2xsZWN0aW9uKQogICAgICAgIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbiAoZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykKICAgICAgICByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKQogICAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgaWYgKG1vZGVsICYmIGV2ZW50ID09PSAnY2hhbmdlOicgKyBtb2RlbC5pZEF0dHJpYnV0ZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLnByZXZpb3VzKG1vZGVsLmlkQXR0cmlidXRlKV07CiAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpCiAgICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0pOwogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCiAgLy8gcmlnaHQgaGVyZToKICB2YXIgbWV0aG9kcyA9IFsKICAgICdmb3JFYWNoJywKICAgICdlYWNoJywKICAgICdtYXAnLAogICAgJ2NvbGxlY3QnLAogICAgJ3JlZHVjZScsCiAgICAnZm9sZGwnLAogICAgJ2luamVjdCcsCiAgICAncmVkdWNlUmlnaHQnLAogICAgJ2ZvbGRyJywKICAgICdmaW5kJywKICAgICdkZXRlY3QnLAogICAgJ2ZpbHRlcicsCiAgICAnc2VsZWN0JywKICAgICdyZWplY3QnLAogICAgJ2V2ZXJ5JywKICAgICdhbGwnLAogICAgJ3NvbWUnLAogICAgJ2FueScsCiAgICAnaW5jbHVkZScsCiAgICAnY29udGFpbnMnLAogICAgJ2ludm9rZScsCiAgICAnbWF4JywKICAgICdtaW4nLAogICAgJ3RvQXJyYXknLAogICAgJ3NpemUnLAogICAgJ2ZpcnN0JywKICAgICdoZWFkJywKICAgICd0YWtlJywKICAgICdpbml0aWFsJywKICAgICdyZXN0JywKICAgICd0YWlsJywKICAgICdkcm9wJywKICAgICdsYXN0JywKICAgICd3aXRob3V0JywKICAgICdkaWZmZXJlbmNlJywKICAgICdpbmRleE9mJywKICAgICdzaHVmZmxlJywKICAgICdsYXN0SW5kZXhPZicsCiAgICAnaXNFbXB0eScsCiAgICAnY2hhaW4nLAogICAgJ3NhbXBsZScKICBdOwogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHRha2UgYSBwcm9wZXJ0eSBuYW1lIGFzIGFuIGFyZ3VtZW50LgogIHZhciBhdHRyaWJ1dGVNZXRob2RzID0gWwogICAgJ2dyb3VwQnknLAogICAgJ2NvdW50QnknLAogICAgJ3NvcnRCeScsCiAgICAnaW5kZXhCeScKICBdOwogIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KICBfLmVhY2goYXR0cmlidXRlTWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICh2YWx1ZSwgY29udGV4dCkgewogICAgICB2YXIgaXRlcmF0b3IgPSBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbiAobW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKICAgICAgfTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfTsKICB9KTsKICAvLyBCYWNrYm9uZS5WaWV3CiAgLy8gLS0tLS0tLS0tLS0tLQogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLgogIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwogIC8vIExpc3Qgb2YgdmlldyBvcHRpb25zIHRvIGJlIG1lcmdlZCBhcyBwcm9wZXJ0aWVzLgogIHZhciB2aWV3T3B0aW9ucyA9IFsKICAgICdtb2RlbCcsCiAgICAnY29sbGVjdGlvbicsCiAgICAnZWwnLAogICAgJ2lkJywKICAgICdhdHRyaWJ1dGVzJywKICAgICdjbGFzc05hbWUnLAogICAgJ3RhZ05hbWUnLAogICAgJ2V2ZW50cycKICBdOwogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CiAgICAvLyBUaGUgZGVmYXVsdCBgdGFnTmFtZWAgb2YgYSBWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLgogICAgdGFnTmFtZTogJ2RpdicsCiAgICAvLyBqUXVlcnkgZGVsZWdhdGUgZm9yIGVsZW1lbnQgbG9va3VwLCBzY29wZWQgdG8gRE9NIGVsZW1lbnRzIHdpdGhpbiB0aGUKICAgIC8vIGN1cnJlbnQgdmlldy4gVGhpcyBzaG91bGQgYmUgcHJlZmVycmVkIHRvIGdsb2JhbCBsb29rdXBzIHdoZXJlIHBvc3NpYmxlLgogICAgJDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgfSwKICAgIC8vICoqcmVuZGVyKiogaXMgdGhlIGNvcmUgZnVuY3Rpb24gdGhhdCB5b3VyIHZpZXcgc2hvdWxkIG92ZXJyaWRlLCBpbiBvcmRlcgogICAgLy8gdG8gcG9wdWxhdGUgaXRzIGVsZW1lbnQgKGB0aGlzLmVsYCksIHdpdGggdGhlIGFwcHJvcHJpYXRlIEhUTUwuIFRoZQogICAgLy8gY29udmVudGlvbiBpcyBmb3IgKipyZW5kZXIqKiB0byBhbHdheXMgcmV0dXJuIGB0aGlzYC4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBSZW1vdmUgdGhpcyB2aWV3IGJ5IHRha2luZyB0aGUgZWxlbWVudCBvdXQgb2YgdGhlIERPTSwgYW5kIHJlbW92aW5nIGFueQogICAgLy8gYXBwbGljYWJsZSBCYWNrYm9uZS5FdmVudHMgbGlzdGVuZXJzLgogICAgcmVtb3ZlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gQ2hhbmdlIHRoZSB2aWV3J3MgZWxlbWVudCAoYHRoaXMuZWxgIHByb3BlcnR5KSwgaW5jbHVkaW5nIGV2ZW50CiAgICAvLyByZS1kZWxlZ2F0aW9uLgogICAgc2V0RWxlbWVudDogZnVuY3Rpb24gKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkKICAgICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgdGhpcy4kZWwgPSBlbGVtZW50IGluc3RhbmNlb2YgQmFja2JvbmUuJCA/IGVsZW1lbnQgOiBCYWNrYm9uZS4kKGVsZW1lbnQpOwogICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07CiAgICAgIGlmIChkZWxlZ2F0ZSAhPT0gZmFsc2UpCiAgICAgICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJywKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24gKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKQogICAgICAgICAgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpCiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIHNlbGVjdG9yLCBtZXRob2QpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4KICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQogICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCiAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKICAgIC8vIG1hdGNoaW5nIGVsZW1lbnQsIGFuZCByZS1hc3NpZ24gaXQgdG8gYGVsYC4gT3RoZXJ3aXNlLCBjcmVhdGUKICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKQogICAgICAgICAgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsKICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpCiAgICAgICAgICBhdHRyc1snY2xhc3MnXSA9IF8ucmVzdWx0KHRoaXMsICdjbGFzc05hbWUnKTsKICAgICAgICB2YXIgJGVsID0gQmFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KICB9KTsKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQogIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKICAvLyBtb2RlbCBpbiBxdWVzdGlvbi4gQnkgZGVmYXVsdCwgbWFrZXMgYSBSRVNUZnVsIEFqYXggcmVxdWVzdAogIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CiAgLy8KICAvLyAqIFVzZSBgc2V0VGltZW91dGAgdG8gYmF0Y2ggcmFwaWQtZmlyZSB1cGRhdGVzIGludG8gYSBzaW5nbGUgcmVxdWVzdC4KICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgogIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgogIC8vCiAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCiAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAogIC8vIGFzIHdlbGwgYXMgYWxsIHJlcXVlc3RzIHdpdGggdGhlIGJvZHkgYXMgYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAKICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQogIC8vIGl0IGRpZmZpY3VsdCB0byByZWFkIHRoZSBib2R5IG9mIGBQVVRgIHJlcXVlc3RzLgogIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbiAobWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewogICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCiAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTgogICAgfSk7CiAgICAvLyBEZWZhdWx0IEpTT04tcmVxdWVzdCBvcHRpb25zLgogICAgdmFyIHBhcmFtcyA9IHsKICAgICAgdHlwZTogdHlwZSwKICAgICAgZGF0YVR5cGU6ICdqc29uJwogICAgfTsKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCiAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CiAgICB9CiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBKU09OIGJ5IGVuY29kaW5nIHRoZSByZXF1ZXN0IGludG8gYW4gSFRNTC1mb3JtLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCc7CiAgICAgIHBhcmFtcy5kYXRhID0gcGFyYW1zLmRhdGEgPyB7IG1vZGVsOiBwYXJhbXMuZGF0YSB9IDoge307CiAgICB9CiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CiAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikKICAgICAgICBwYXJhbXMuZGF0YS5fbWV0aG9kID0gdHlwZTsKICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9IGZ1bmN0aW9uICh4aHIpIHsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgIGlmIChiZWZvcmVTZW5kKQogICAgICAgICAgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CiAgICB9CiAgICAvLyBJZiB3ZSdyZSBzZW5kaW5nIGEgYFBBVENIYCByZXF1ZXN0LCBhbmQgd2UncmUgaW4gYW4gb2xkIEludGVybmV0IEV4cGxvcmVyCiAgICAvLyB0aGF0IHN0aWxsIGhhcyBBY3RpdmVYIGVuYWJsZWQgYnkgZGVmYXVsdCwgb3ZlcnJpZGUgalF1ZXJ5IHRvIHVzZSB0aGF0CiAgICAvLyBmb3IgWEhSIGluc3RlYWQuIFJlbW92ZSB0aGlzIGxpbmUgd2hlbiBqUXVlcnkgc3VwcG9ydHMgYFBBVENIYCBvbiBJRTguCiAgICBpZiAocGFyYW1zLnR5cGUgPT09ICdQQVRDSCcgJiYgbm9YaHJQYXRjaCkgewogICAgICBwYXJhbXMueGhyID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKTsKICAgICAgfTsKICAgIH0KICAgIC8vIE1ha2UgdGhlIHJlcXVlc3QsIGFsbG93aW5nIHRoZSB1c2VyIHRvIG92ZXJyaWRlIGFueSBBamF4IG9wdGlvbnMuCiAgICB2YXIgeGhyID0gb3B0aW9ucy54aHIgPSBCYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOwogICAgbW9kZWwudHJpZ2dlcigncmVxdWVzdCcsIG1vZGVsLCB4aHIsIG9wdGlvbnMpOwogICAgcmV0dXJuIHhocjsKICB9OwogIHZhciBub1hoclBhdGNoID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJiAhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiBuZXcgWE1MSHR0cFJlcXVlc3QoKS5kaXNwYXRjaEV2ZW50KTsKICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBCYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4KICB2YXIgbWV0aG9kTWFwID0gewogICAgJ2NyZWF0ZSc6ICdQT1NUJywKICAgICd1cGRhdGUnOiAnUFVUJywKICAgICdwYXRjaCc6ICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICdHRVQnCiAgfTsKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIC8vIE92ZXJyaWRlIHRoaXMgaWYgeW91J2QgbGlrZSB0byB1c2UgYSBkaWZmZXJlbnQgbGlicmFyeS4KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIEJhY2tib25lLiQuYWpheC5hcHBseShCYWNrYm9uZS4kLCBhcmd1bWVudHMpOwogIH07CiAgLy8gQmFja2JvbmUuUm91dGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLnJvdXRlcykKICAgICAgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgPSAvW1wte31cW1xdKz8uLFxcXF4kfCNcc10vZzsKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24gKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKQogICAgICAgIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgICBjYWxsYmFjayA9IG5hbWU7CiAgICAgICAgbmFtZSA9ICcnOwogICAgICB9CiAgICAgIGlmICghY2FsbGJhY2spCiAgICAgICAgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwogICAgICB2YXIgcm91dGVyID0gdGhpczsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgZnVuY3Rpb24gKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgcm91dGVyLmV4ZWN1dGUoY2FsbGJhY2ssIGFyZ3MpOwogICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICByb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgcm91dGVyLCBuYW1lLCBhcmdzKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIEV4ZWN1dGUgYSByb3V0ZSBoYW5kbGVyIHdpdGggdGhlIHByb3ZpZGVkIHBhcmFtZXRlcnMuICBUaGlzIGlzIGFuCiAgICAvLyBleGNlbGxlbnQgcGxhY2UgdG8gZG8gcHJlLXJvdXRlIHNldHVwIG9yIHBvc3Qtcm91dGUgY2xlYW51cC4KICAgIGV4ZWN1dGU6IGZ1bmN0aW9uIChjYWxsYmFjaywgYXJncykgewogICAgICBpZiAoY2FsbGJhY2spCiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICB9LAogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbiAoZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQogICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAogICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpCiAgICAgICAgcmV0dXJuOwogICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCiAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCiAgICBfcm91dGVUb1JlZ0V4cDogZnVuY3Rpb24gKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykucmVwbGFjZShvcHRpb25hbFBhcmFtLCAnKD86JDEpPycpLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24gKG1hdGNoLCBvcHRpb25hbCkgewogICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXi8/XSspJzsKICAgICAgfSkucmVwbGFjZShzcGxhdFBhcmFtLCAnKFteP10qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnKD86XFw/KFtcXHNcXFNdKikpPyQnKTsKICAgIH0sCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgZGVjb2RlZCBwYXJhbWV0ZXJzLiBFbXB0eSBvciB1bm1hdGNoZWQgcGFyYW1ldGVycyB3aWxsIGJlCiAgICAvLyB0cmVhdGVkIGFzIGBudWxsYCB0byBub3JtYWxpemUgY3Jvc3MtYnJvd3NlciBiZWhhdmlvci4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24gKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uIChwYXJhbSwgaSkgewogICAgICAgIC8vIERvbid0IGRlY29kZSB0aGUgc2VhcmNoIHBhcmFtcy4KICAgICAgICBpZiAoaSA9PT0gcGFyYW1zLmxlbmd0aCAtIDEpCiAgICAgICAgICByZXR1cm4gcGFyYW0gfHwgbnVsbDsKICAgICAgICByZXR1cm4gcGFyYW0gPyBkZWNvZGVVUklDb21wb25lbnQocGFyYW0pIDogbnVsbDsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KICAvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBlaXRoZXIKICAvLyBbcHVzaFN0YXRlXShodHRwOi8vZGl2ZWludG9odG1sNS5pbmZvL2hpc3RvcnkuaHRtbCkgYW5kIHJlYWwgVVJMcywgb3IKICAvLyBbb25oYXNoY2hhbmdlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS93aW5kb3cub25oYXNoY2hhbmdlKQogIC8vIGFuZCBVUkwgZnJhZ21lbnRzLiBJZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBuZWl0aGVyIChvbGQgSUUsIG5hdGNoKSwKICAvLyBmYWxscyBiYWNrIHRvIHBvbGxpbmcuCiAgdmFyIEhpc3RvcnkgPSBCYWNrYm9uZS5IaXN0b3J5ID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwogICAgLy8gRW5zdXJlIHRoYXQgYEhpc3RvcnlgIGNhbiBiZSB1c2VkIG91dHNpZGUgb2YgdGhlIGJyb3dzZXIuCiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgdGhpcy5sb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKICAgICAgdGhpcy5oaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CiAgICB9CiAgfTsKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBhIGxlYWRpbmcgaGFzaC9zbGFzaCBhbmQgdHJhaWxpbmcgc3BhY2UuCiAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBkZXRlY3RpbmcgTVNJRS4KICB2YXIgaXNFeHBsb3JlciA9IC9tc2llIFtcdy5dKy87CiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgogIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoLgogIHZhciBwYXRoU3RyaXBwZXIgPSAvIy4qJC87CiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CiAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgIGludGVydmFsOiA1MCwKICAgIC8vIEFyZSB3ZSBhdCB0aGUgYXBwIHJvb3Q/CiAgICBhdFJvb3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CiAgICB9LAogICAgLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwogICAgLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCiAgICBnZXRIYXNoOiBmdW5jdGlvbiAod2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAogICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAogICAgLy8gdGhlIGhhc2gsIG9yIHRoZSBvdmVycmlkZS4KICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbiAoZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IGRlY29kZVVSSSh0aGlzLmxvY2F0aW9uLnBhdGhuYW1lICsgdGhpcy5sb2NhdGlvbi5zZWFyY2gpOwogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpCiAgICAgICAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAogICAgLy8gU3RhcnQgdGhlIGhhc2ggY2hhbmdlIGhhbmRsaW5nLCByZXR1cm5pbmcgYHRydWVgIGlmIHRoZSBjdXJyZW50IFVSTCBtYXRjaGVzCiAgICAvLyBhbiBleGlzdGluZyByb3V0ZSwgYW5kIGBmYWxzZWAgb3RoZXJ3aXNlLgogICAgc3RhcnQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWNrYm9uZS5oaXN0b3J5IGhhcyBhbHJlYWR5IGJlZW4gc3RhcnRlZCcpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSB0cnVlOwogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7IHJvb3Q6ICcvJyB9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgICB0aGlzLnJvb3QgPSB0aGlzLm9wdGlvbnMucm9vdDsKICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwogICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKICAgICAgdGhpcy5faGFzUHVzaFN0YXRlID0gISEodGhpcy5vcHRpb25zLnB1c2hTdGF0ZSAmJiB0aGlzLmhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5LnB1c2hTdGF0ZSk7CiAgICAgIHZhciBmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgdmFyIGRvY01vZGUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSA9IGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpOwogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHZhciBmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSI+Jyk7CiAgICAgICAgdGhpcy5pZnJhbWUgPSBmcmFtZS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CiAgICAgIC8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSBvciBoYXNoZXMsIGFuZCB3aGV0aGVyCiAgICAgIC8vICdvbmhhc2hjaGFuZ2UnIGlzIHN1cHBvcnRlZCwgZGV0ZXJtaW5lIGhvdyB3ZSBjaGVjayB0aGUgVVJMIHN0YXRlLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CiAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCiAgICAgIC8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4KICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKICAgICAgLy8gVHJhbnNpdGlvbiBmcm9tIGhhc2hDaGFuZ2UgdG8gcHVzaFN0YXRlIG9yIHZpY2UgdmVyc2EgaWYgYm90aCBhcmUKICAgICAgLy8gcmVxdWVzdGVkLgogICAgICBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmIHRoaXMuX3dhbnRzUHVzaFN0YXRlKSB7CiAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCiAgICAgICAgLy8gYnJvd3NlciwgYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhdGhpcy5hdFJvb3QoKSkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CiAgICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICAgIHJldHVybiB0cnVlOyAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW4gYSBicm93c2VyIHdoZXJlIGl0IGNvdWxkIGJlIGBwdXNoU3RhdGVgLWJhc2VkIGluc3RlYWQuLi4KICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSAmJiB0aGlzLmF0Um9vdCgpICYmIGxvYy5oYXNoKSB7CiAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkKICAgICAgICByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CiAgICB9LAogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9mZigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS5vZmYoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgaWYgKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpCiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICB9LAogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbiAocm91dGUsIGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7CiAgICAgICAgcm91dGU6IHJvdXRlLAogICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjawogICAgICB9KTsKICAgIH0sCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgewogICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKQogICAgICAgIHRoaXMubmF2aWdhdGUoY3VycmVudCk7CiAgICAgIHRoaXMubG9hZFVybCgpOwogICAgfSwKICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCiAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAogICAgLy8gcmV0dXJucyBgZmFsc2VgLgogICAgbG9hZFVybDogZnVuY3Rpb24gKGZyYWdtZW50KSB7CiAgICAgIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQpOwogICAgICByZXR1cm4gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24gKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIC8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUKICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKICAgIC8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgogICAgLy8KICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKICAgIC8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCiAgICAvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uIChmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zID09PSB0cnVlKQogICAgICAgIG9wdGlvbnMgPSB7IHRyaWdnZXI6ICEhb3B0aW9ucyB9OwogICAgICB2YXIgdXJsID0gdGhpcy5yb290ICsgKGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJykpOwogICAgICAvLyBTdHJpcCB0aGUgaGFzaCBmb3IgbWF0Y2hpbmcuCiAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKICAgICAgaWYgKHRoaXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KQogICAgICAgIHJldHVybjsKICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCiAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpCiAgICAgICAgdXJsID0gdXJsLnNsaWNlKDAsIC0xKTsKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7ICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSB7CiAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAvLyB3YW50IHRoaXMuCiAgICAgICAgICBpZiAoIW9wdGlvbnMucmVwbGFjZSkKICAgICAgICAgICAgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9ICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KICAgICAgICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKQogICAgICAgIHJldHVybiB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgfSwKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbiAobG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgfQogICAgfQogIH0pOwogIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5LgogIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeSgpOwogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCiAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogIHZhciBleHRlbmQgPSBmdW5jdGlvbiAocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwogICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQogICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAogICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogICAgaWYgKHByb3RvUHJvcHMgJiYgXy5oYXMocHJvdG9Qcm9wcywgJ2NvbnN0cnVjdG9yJykpIHsKICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwogICAgfSBlbHNlIHsKICAgICAgY2hpbGQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogICAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCiAgICBfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CiAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsKICAgIH07CiAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGUoKTsKICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAogICAgLy8gaWYgc3VwcGxpZWQuCiAgICBpZiAocHJvdG9Qcm9wcykKICAgICAgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKICAgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQKICAgIC8vIGxhdGVyLgogICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKICAgIHJldHVybiBjaGlsZDsKICB9OwogIC8vIFNldCB1cCBpbmhlcml0YW5jZSBmb3IgdGhlIG1vZGVsLCBjb2xsZWN0aW9uLCByb3V0ZXIsIHZpZXcgYW5kIGhpc3RvcnkuCiAgTW9kZWwuZXh0ZW5kID0gQ29sbGVjdGlvbi5leHRlbmQgPSBSb3V0ZXIuZXh0ZW5kID0gVmlldy5leHRlbmQgPSBIaXN0b3J5LmV4dGVuZCA9IGV4dGVuZDsKICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCiAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdBICJ1cmwiIHByb3BlcnR5IG9yIGZ1bmN0aW9uIG11c3QgYmUgc3BlY2lmaWVkJyk7CiAgfTsKICAvLyBXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KICB2YXIgd3JhcEVycm9yID0gZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwogICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgIGlmIChlcnJvcikKICAgICAgICBlcnJvcihtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIG1vZGVsLnRyaWdnZXIoJ2Vycm9yJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgfTsKICB9OwogIHJldHVybiBCYWNrYm9uZTsKfSkpOwovLyBCYWNrYm9uZS5XcmVxciAoQmFja2JvbmUuTWFyaW9uZXR0ZSkKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyB2MS4zLjEKLy8KLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCi8vIERpc3RyaWJ1dGVkIHVuZGVyIE1JVCBsaWNlbnNlCi8vCi8vIGh0dHA6Ly9naXRodWIuY29tL21hcmlvbmV0dGVqcy9iYWNrYm9uZS53cmVxcgooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKICBpZiAodHJ1ZSkgewogICAgYmFja2JvbmV3cmVxciA9IGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogICAgICByZXR1cm4gZmFjdG9yeShCYWNrYm9uZSwgXyk7CiAgICB9KGJhY2tib25lLCB1bmRlcnNjb3JlKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgdmFyIEJhY2tib25lID0gYmFja2JvbmU7CiAgICB2YXIgXyA9IHVuZGVyc2NvcmU7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoQmFja2JvbmUsIF8pOwogIH0gZWxzZSB7CiAgICBmYWN0b3J5KHJvb3QuQmFja2JvbmUsIHJvb3QuXyk7CiAgfQp9KHRoaXMsIGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogIAogIHZhciBwcmV2aW91c1dyZXFyID0gQmFja2JvbmUuV3JlcXI7CiAgdmFyIFdyZXFyID0gQmFja2JvbmUuV3JlcXIgPSB7fTsKICBCYWNrYm9uZS5XcmVxci5WRVJTSU9OID0gJzEuMy4xJzsKICBCYWNrYm9uZS5XcmVxci5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgQmFja2JvbmUuV3JlcXIgPSBwcmV2aW91c1dyZXFyOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvLyBIYW5kbGVycwogIC8vIC0tLS0tLS0tCiAgLy8gQSByZWdpc3RyeSBvZiBmdW5jdGlvbnMgdG8gY2FsbCwgZ2l2ZW4gYSBuYW1lCiAgV3JlcXIuSGFuZGxlcnMgPSBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAgIAogICAgLy8gQ29uc3RydWN0b3IKICAgIC8vIC0tLS0tLS0tLS0tCiAgICB2YXIgSGFuZGxlcnMgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICB0aGlzLl93cmVxckhhbmRsZXJzID0ge307CiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5pbml0aWFsaXplKSkgewogICAgICAgIHRoaXMuaW5pdGlhbGl6ZShvcHRpb25zKTsKICAgICAgfQogICAgfTsKICAgIEhhbmRsZXJzLmV4dGVuZCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZDsKICAgIC8vIEluc3RhbmNlIE1lbWJlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0KICAgIF8uZXh0ZW5kKEhhbmRsZXJzLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzLCB7CiAgICAgIC8vIEFkZCBtdWx0aXBsZSBoYW5kbGVycyB1c2luZyBhbiBvYmplY3QgbGl0ZXJhbCBjb25maWd1cmF0aW9uCiAgICAgIHNldEhhbmRsZXJzOiBmdW5jdGlvbiAoaGFuZGxlcnMpIHsKICAgICAgICBfLmVhY2goaGFuZGxlcnMsIGZ1bmN0aW9uIChoYW5kbGVyLCBuYW1lKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IG51bGw7CiAgICAgICAgICBpZiAoXy5pc09iamVjdChoYW5kbGVyKSAmJiAhXy5pc0Z1bmN0aW9uKGhhbmRsZXIpKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSBoYW5kbGVyLmNvbnRleHQ7CiAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVyLmNhbGxiYWNrOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5zZXRIYW5kbGVyKG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9LAogICAgICAvLyBBZGQgYSBoYW5kbGVyIGZvciB0aGUgZ2l2ZW4gbmFtZSwgd2l0aCBhbgogICAgICAvLyBvcHRpb25hbCBjb250ZXh0IHRvIHJ1biB0aGUgaGFuZGxlciB3aXRoaW4KICAgICAgc2V0SGFuZGxlcjogZnVuY3Rpb24gKG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICB2YXIgY29uZmlnID0gewogICAgICAgICAgY2FsbGJhY2s6IGhhbmRsZXIsCiAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgfTsKICAgICAgICB0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdID0gY29uZmlnOwogICAgICAgIHRoaXMudHJpZ2dlcignaGFuZGxlcjphZGQnLCBuYW1lLCBoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgfSwKICAgICAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgb3Igbm90IGEgaGFuZGxlciBpcyByZWdpc3RlcmVkCiAgICAgIGhhc0hhbmRsZXI6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuICEhdGhpcy5fd3JlcXJIYW5kbGVyc1tuYW1lXTsKICAgICAgfSwKICAgICAgLy8gR2V0IHRoZSBjdXJyZW50bHkgcmVnaXN0ZXJlZCBoYW5kbGVyIGZvcgogICAgICAvLyB0aGUgc3BlY2lmaWVkIG5hbWUuIFRocm93cyBhbiBleGNlcHRpb24gaWYKICAgICAgLy8gbm8gaGFuZGxlciBpcyBmb3VuZC4KICAgICAgZ2V0SGFuZGxlcjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgY29uZmlnID0gdGhpcy5fd3JlcXJIYW5kbGVyc1tuYW1lXTsKICAgICAgICBpZiAoIWNvbmZpZykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzKTsKICAgICAgICAgIHJldHVybiBjb25maWcuY2FsbGJhY2suYXBwbHkoY29uZmlnLmNvbnRleHQsIGFyZ3MpOwogICAgICAgIH07CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgbmFtZQogICAgICByZW1vdmVIYW5kbGVyOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdOwogICAgICB9LAogICAgICAvLyBSZW1vdmUgYWxsIGhhbmRsZXJzIGZyb20gdGhpcyByZWdpc3RyeQogICAgICByZW1vdmVBbGxIYW5kbGVyczogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuX3dyZXFySGFuZGxlcnMgPSB7fTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gSGFuZGxlcnM7CiAgfShCYWNrYm9uZSwgXyk7CiAgLy8gV3JlcXIuQ29tbWFuZFN0b3JhZ2UKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gU3RvcmUgYW5kIHJldHJpZXZlIGNvbW1hbmRzIGZvciBleGVjdXRpb24uCiAgV3JlcXIuQ29tbWFuZFN0b3JhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAKICAgIC8vIENvbnN0cnVjdG9yIGZ1bmN0aW9uCiAgICB2YXIgQ29tbWFuZFN0b3JhZ2UgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICB0aGlzLl9jb21tYW5kcyA9IHt9OwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgICB0aGlzLmluaXRpYWxpemUob3B0aW9ucyk7CiAgICAgIH0KICAgIH07CiAgICAvLyBJbnN0YW5jZSBtZXRob2RzCiAgICBfLmV4dGVuZChDb21tYW5kU3RvcmFnZS5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgICAvLyBHZXQgYW4gb2JqZWN0IGxpdGVyYWwgYnkgY29tbWFuZCBuYW1lLCB0aGF0IGNvbnRhaW5zCiAgICAgIC8vIHRoZSBgY29tbWFuZE5hbWVgIGFuZCB0aGUgYGluc3RhbmNlc2Agb2YgYWxsIGNvbW1hbmRzCiAgICAgIC8vIHJlcHJlc2VudGVkIGFzIGFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byBwcm9jZXNzCiAgICAgIGdldENvbW1hbmRzOiBmdW5jdGlvbiAoY29tbWFuZE5hbWUpIHsKICAgICAgICB2YXIgY29tbWFuZHMgPSB0aGlzLl9jb21tYW5kc1tjb21tYW5kTmFtZV07CiAgICAgICAgLy8gd2UgZG9uJ3QgaGF2ZSBpdCwgc28gYWRkIGl0CiAgICAgICAgaWYgKCFjb21tYW5kcykgewogICAgICAgICAgLy8gYnVpbGQgdGhlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgIGNvbW1hbmRzID0gewogICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kTmFtZSwKICAgICAgICAgICAgaW5zdGFuY2VzOiBbXQogICAgICAgICAgfTsKICAgICAgICAgIC8vIHN0b3JlIGl0CiAgICAgICAgICB0aGlzLl9jb21tYW5kc1tjb21tYW5kTmFtZV0gPSBjb21tYW5kczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbW1hbmRzOwogICAgICB9LAogICAgICAvLyBBZGQgYSBjb21tYW5kIGJ5IG5hbWUsIHRvIHRoZSBzdG9yYWdlIGFuZCBzdG9yZSB0aGUKICAgICAgLy8gYXJncyBmb3IgdGhlIGNvbW1hbmQKICAgICAgYWRkQ29tbWFuZDogZnVuY3Rpb24gKGNvbW1hbmROYW1lLCBhcmdzKSB7CiAgICAgICAgdmFyIGNvbW1hbmQgPSB0aGlzLmdldENvbW1hbmRzKGNvbW1hbmROYW1lKTsKICAgICAgICBjb21tYW5kLmluc3RhbmNlcy5wdXNoKGFyZ3MpOwogICAgICB9LAogICAgICAvLyBDbGVhciBhbGwgY29tbWFuZHMgZm9yIHRoZSBnaXZlbiBgY29tbWFuZE5hbWVgCiAgICAgIGNsZWFyQ29tbWFuZHM6IGZ1bmN0aW9uIChjb21tYW5kTmFtZSkgewogICAgICAgIHZhciBjb21tYW5kID0gdGhpcy5nZXRDb21tYW5kcyhjb21tYW5kTmFtZSk7CiAgICAgICAgY29tbWFuZC5pbnN0YW5jZXMgPSBbXTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gQ29tbWFuZFN0b3JhZ2U7CiAgfSgpOwogIC8vIFdyZXFyLkNvbW1hbmRzCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLwogIC8vIEEgc2ltcGxlIGNvbW1hbmQgcGF0dGVybiBpbXBsZW1lbnRhdGlvbi4gUmVnaXN0ZXIgYSBjb21tYW5kCiAgLy8gaGFuZGxlciBhbmQgZXhlY3V0ZSBpdC4KICBXcmVxci5Db21tYW5kcyA9IGZ1bmN0aW9uIChXcmVxcikgewogICAgCiAgICByZXR1cm4gV3JlcXIuSGFuZGxlcnMuZXh0ZW5kKHsKICAgICAgLy8gZGVmYXVsdCBzdG9yYWdlIHR5cGUKICAgICAgc3RvcmFnZVR5cGU6IFdyZXFyLkNvbW1hbmRTdG9yYWdlLAogICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgIHRoaXMuX2luaXRpYWxpemVTdG9yYWdlKHRoaXMub3B0aW9ucyk7CiAgICAgICAgdGhpcy5vbignaGFuZGxlcjphZGQnLCB0aGlzLl9leGVjdXRlQ29tbWFuZHMsIHRoaXMpOwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICBXcmVxci5IYW5kbGVycy5wcm90b3R5cGUuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0sCiAgICAgIC8vIEV4ZWN1dGUgYSBuYW1lZCBjb21tYW5kIHdpdGggdGhlIHN1cHBsaWVkIGFyZ3MKICAgICAgZXhlY3V0ZTogZnVuY3Rpb24gKG5hbWUsIGFyZ3MpIHsKICAgICAgICBuYW1lID0gYXJndW1lbnRzWzBdOwogICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgIGlmICh0aGlzLmhhc0hhbmRsZXIobmFtZSkpIHsKICAgICAgICAgIHRoaXMuZ2V0SGFuZGxlcihuYW1lKS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5zdG9yYWdlLmFkZENvbW1hbmQobmFtZSwgYXJncyk7CiAgICAgICAgfQogICAgICB9LAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaGFuZGxlIGJ1bGsgZXhlY3V0aW9uIG9mIHN0b3JlZCBjb21tYW5kcwogICAgICBfZXhlY3V0ZUNvbW1hbmRzOiBmdW5jdGlvbiAobmFtZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgICAgIHZhciBjb21tYW5kID0gdGhpcy5zdG9yYWdlLmdldENvbW1hbmRzKG5hbWUpOwogICAgICAgIC8vIGxvb3AgdGhyb3VnaCBhbmQgZXhlY3V0ZSBhbGwgdGhlIHN0b3JlZCBjb21tYW5kIGluc3RhbmNlcwogICAgICAgIF8uZWFjaChjb21tYW5kLmluc3RhbmNlcywgZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICAgIGhhbmRsZXIuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5zdG9yYWdlLmNsZWFyQ29tbWFuZHMobmFtZSk7CiAgICAgIH0sCiAgICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBpbml0aWFsaXplIHN0b3JhZ2UgZWl0aGVyIGZyb20gdGhlIHR5cGUncwogICAgICAvLyBgc3RvcmFnZVR5cGVgIG9yIHRoZSBpbnN0YW5jZSBgb3B0aW9ucy5zdG9yYWdlVHlwZWAuCiAgICAgIF9pbml0aWFsaXplU3RvcmFnZTogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICB2YXIgc3RvcmFnZTsKICAgICAgICB2YXIgU3RvcmFnZVR5cGUgPSBvcHRpb25zLnN0b3JhZ2VUeXBlIHx8IHRoaXMuc3RvcmFnZVR5cGU7CiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihTdG9yYWdlVHlwZSkpIHsKICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgU3RvcmFnZVR5cGUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RvcmFnZSA9IFN0b3JhZ2VUeXBlOwogICAgICAgIH0KICAgICAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlOwogICAgICB9CiAgICB9KTsKICB9KFdyZXFyKTsKICAvLyBXcmVxci5SZXF1ZXN0UmVzcG9uc2UKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLwogIC8vIEEgc2ltcGxlIHJlcXVlc3QvcmVzcG9uc2UgaW1wbGVtZW50YXRpb24uIFJlZ2lzdGVyIGEKICAvLyByZXF1ZXN0IGhhbmRsZXIsIGFuZCByZXR1cm4gYSByZXNwb25zZSBmcm9tIGl0CiAgV3JlcXIuUmVxdWVzdFJlc3BvbnNlID0gZnVuY3Rpb24gKFdyZXFyKSB7CiAgICAKICAgIHJldHVybiBXcmVxci5IYW5kbGVycy5leHRlbmQoewogICAgICByZXF1ZXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG5hbWUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgIGlmICh0aGlzLmhhc0hhbmRsZXIobmFtZSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmdldEhhbmRsZXIobmFtZSkuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9KFdyZXFyKTsKICAvLyBFdmVudCBBZ2dyZWdhdG9yCiAgLy8gLS0tLS0tLS0tLS0tLS0tLQogIC8vIEEgcHViLXN1YiBvYmplY3QgdGhhdCBjYW4gYmUgdXNlZCB0byBkZWNvdXBsZSB2YXJpb3VzIHBhcnRzCiAgLy8gb2YgYW4gYXBwbGljYXRpb24gdGhyb3VnaCBldmVudC1kcml2ZW4gYXJjaGl0ZWN0dXJlLgogIFdyZXFyLkV2ZW50QWdncmVnYXRvciA9IGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogICAgCiAgICB2YXIgRUEgPSBmdW5jdGlvbiAoKSB7CiAgICB9OwogICAgLy8gQ29weSB0aGUgYGV4dGVuZGAgZnVuY3Rpb24gdXNlZCBieSBCYWNrYm9uZSdzIGNsYXNzZXMKICAgIEVBLmV4dGVuZCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZDsKICAgIC8vIENvcHkgdGhlIGJhc2ljIEJhY2tib25lLkV2ZW50cyBvbiB0byB0aGUgZXZlbnQgYWdncmVnYXRvcgogICAgXy5leHRlbmQoRUEucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMpOwogICAgcmV0dXJuIEVBOwogIH0oQmFja2JvbmUsIF8pOwogIC8vIFdyZXFyLkNoYW5uZWwKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gQW4gb2JqZWN0IHRoYXQgd3JhcHMgdGhlIHRocmVlIG1lc3NhZ2luZyBzeXN0ZW1zOgogIC8vIEV2ZW50QWdncmVnYXRvciwgUmVxdWVzdFJlc3BvbnNlLCBDb21tYW5kcwogIFdyZXFyLkNoYW5uZWwgPSBmdW5jdGlvbiAoV3JlcXIpIHsKICAgIAogICAgdmFyIENoYW5uZWwgPSBmdW5jdGlvbiAoY2hhbm5lbE5hbWUpIHsKICAgICAgdGhpcy52ZW50ID0gbmV3IEJhY2tib25lLldyZXFyLkV2ZW50QWdncmVnYXRvcigpOwogICAgICB0aGlzLnJlcXJlcyA9IG5ldyBCYWNrYm9uZS5XcmVxci5SZXF1ZXN0UmVzcG9uc2UoKTsKICAgICAgdGhpcy5jb21tYW5kcyA9IG5ldyBCYWNrYm9uZS5XcmVxci5Db21tYW5kcygpOwogICAgICB0aGlzLmNoYW5uZWxOYW1lID0gY2hhbm5lbE5hbWU7CiAgICB9OwogICAgXy5leHRlbmQoQ2hhbm5lbC5wcm90b3R5cGUsIHsKICAgICAgLy8gUmVtb3ZlIGFsbCBoYW5kbGVycyBmcm9tIHRoZSBtZXNzYWdpbmcgc3lzdGVtcyBvZiB0aGlzIGNoYW5uZWwKICAgICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLnZlbnQub2ZmKCk7CiAgICAgICAgdGhpcy52ZW50LnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICB0aGlzLnJlcXJlcy5yZW1vdmVBbGxIYW5kbGVycygpOwogICAgICAgIHRoaXMuY29tbWFuZHMucmVtb3ZlQWxsSGFuZGxlcnMoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gQ29ubmVjdCBhIGhhc2ggb2YgZXZlbnRzOyBvbmUgZm9yIGVhY2ggbWVzc2FnaW5nIHN5c3RlbQogICAgICBjb25uZWN0RXZlbnRzOiBmdW5jdGlvbiAoaGFzaCwgY29udGV4dCkgewogICAgICAgIHRoaXMuX2Nvbm5lY3QoJ3ZlbnQnLCBoYXNoLCBjb250ZXh0KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgY29ubmVjdENvbW1hbmRzOiBmdW5jdGlvbiAoaGFzaCwgY29udGV4dCkgewogICAgICAgIHRoaXMuX2Nvbm5lY3QoJ2NvbW1hbmRzJywgaGFzaCwgY29udGV4dCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0sCiAgICAgIGNvbm5lY3RSZXF1ZXN0czogZnVuY3Rpb24gKGhhc2gsIGNvbnRleHQpIHsKICAgICAgICB0aGlzLl9jb25uZWN0KCdyZXFyZXMnLCBoYXNoLCBjb250ZXh0KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gQXR0YWNoIHRoZSBoYW5kbGVycyB0byBhIGdpdmVuIG1lc3NhZ2Ugc3lzdGVtIGB0eXBlYAogICAgICBfY29ubmVjdDogZnVuY3Rpb24gKHR5cGUsIGhhc2gsIGNvbnRleHQpIHsKICAgICAgICBpZiAoIWhhc2gpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgdGhpczsKICAgICAgICB2YXIgbWV0aG9kID0gdHlwZSA9PT0gJ3ZlbnQnID8gJ29uJyA6ICdzZXRIYW5kbGVyJzsKICAgICAgICBfLmVhY2goaGFzaCwgZnVuY3Rpb24gKGZuLCBldmVudE5hbWUpIHsKICAgICAgICAgIHRoaXNbdHlwZV1bbWV0aG9kXShldmVudE5hbWUsIF8uYmluZChmbiwgY29udGV4dCkpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBDaGFubmVsOwogIH0oV3JlcXIpOwogIC8vIFdyZXFyLlJhZGlvCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLwogIC8vIEFuIG9iamVjdCB0aGF0IGxldHMgeW91IGNvbW11bmljYXRlIHdpdGggbWFueSBjaGFubmVscy4KICBXcmVxci5yYWRpbyA9IGZ1bmN0aW9uIChXcmVxcikgewogICAgCiAgICB2YXIgUmFkaW8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX2NoYW5uZWxzID0ge307CiAgICAgIHRoaXMudmVudCA9IHt9OwogICAgICB0aGlzLmNvbW1hbmRzID0ge307CiAgICAgIHRoaXMucmVxcmVzID0ge307CiAgICAgIHRoaXMuX3Byb3h5TWV0aG9kcygpOwogICAgfTsKICAgIF8uZXh0ZW5kKFJhZGlvLnByb3RvdHlwZSwgewogICAgICBjaGFubmVsOiBmdW5jdGlvbiAoY2hhbm5lbE5hbWUpIHsKICAgICAgICBpZiAoIWNoYW5uZWxOYW1lKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NoYW5uZWwgbXVzdCByZWNlaXZlIGEgbmFtZScpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q2hhbm5lbChjaGFubmVsTmFtZSk7CiAgICAgIH0sCiAgICAgIF9nZXRDaGFubmVsOiBmdW5jdGlvbiAoY2hhbm5lbE5hbWUpIHsKICAgICAgICB2YXIgY2hhbm5lbCA9IHRoaXMuX2NoYW5uZWxzW2NoYW5uZWxOYW1lXTsKICAgICAgICBpZiAoIWNoYW5uZWwpIHsKICAgICAgICAgIGNoYW5uZWwgPSBuZXcgV3JlcXIuQ2hhbm5lbChjaGFubmVsTmFtZSk7CiAgICAgICAgICB0aGlzLl9jaGFubmVsc1tjaGFubmVsTmFtZV0gPSBjaGFubmVsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2hhbm5lbDsKICAgICAgfSwKICAgICAgX3Byb3h5TWV0aG9kczogZnVuY3Rpb24gKCkgewogICAgICAgIF8uZWFjaChbCiAgICAgICAgICAndmVudCcsCiAgICAgICAgICAnY29tbWFuZHMnLAogICAgICAgICAgJ3JlcXJlcycKICAgICAgICBdLCBmdW5jdGlvbiAoc3lzdGVtKSB7CiAgICAgICAgICBfLmVhY2gobWVzc2FnZVN5c3RlbXNbc3lzdGVtXSwgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgICAgICB0aGlzW3N5c3RlbV1bbWV0aG9kXSA9IHByb3h5TWV0aG9kKHRoaXMsIHN5c3RlbSwgbWV0aG9kKTsKICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBtZXNzYWdlU3lzdGVtcyA9IHsKICAgICAgdmVudDogWwogICAgICAgICdvbicsCiAgICAgICAgJ29mZicsCiAgICAgICAgJ3RyaWdnZXInLAogICAgICAgICdvbmNlJywKICAgICAgICAnc3RvcExpc3RlbmluZycsCiAgICAgICAgJ2xpc3RlblRvJywKICAgICAgICAnbGlzdGVuVG9PbmNlJwogICAgICBdLAogICAgICBjb21tYW5kczogWwogICAgICAgICdleGVjdXRlJywKICAgICAgICAnc2V0SGFuZGxlcicsCiAgICAgICAgJ3NldEhhbmRsZXJzJywKICAgICAgICAncmVtb3ZlSGFuZGxlcicsCiAgICAgICAgJ3JlbW92ZUFsbEhhbmRsZXJzJwogICAgICBdLAogICAgICByZXFyZXM6IFsKICAgICAgICAncmVxdWVzdCcsCiAgICAgICAgJ3NldEhhbmRsZXInLAogICAgICAgICdzZXRIYW5kbGVycycsCiAgICAgICAgJ3JlbW92ZUhhbmRsZXInLAogICAgICAgICdyZW1vdmVBbGxIYW5kbGVycycKICAgICAgXQogICAgfTsKICAgIHZhciBwcm94eU1ldGhvZCA9IGZ1bmN0aW9uIChyYWRpbywgc3lzdGVtLCBtZXRob2QpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChjaGFubmVsTmFtZSkgewogICAgICAgIHZhciBtZXNzYWdlU3lzdGVtID0gcmFkaW8uX2dldENoYW5uZWwoY2hhbm5lbE5hbWUpW3N5c3RlbV07CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgIHJldHVybiBtZXNzYWdlU3lzdGVtW21ldGhvZF0uYXBwbHkobWVzc2FnZVN5c3RlbSwgYXJncyk7CiAgICAgIH07CiAgICB9OwogICAgcmV0dXJuIG5ldyBSYWRpbygpOwogIH0oV3JlcXIpOwogIHJldHVybiBCYWNrYm9uZS5XcmVxcjsKfSkpOwovKiEKICogY29tbWFuZGVyLmpzCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQKICovCmNvbW1hbmRlciA9IGZ1bmN0aW9uIChXcmVxcikgewogIC8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY29tbWFuZGVyCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICByZXR1cm4gbmV3IFdyZXFyLkNvbW1hbmRzKCk7Cn0oYmFja2JvbmV3cmVxcik7Ci8vIEJhY2tib25lLkJhYnlTaXR0ZXIKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQovLyB2MC4xLjQKLy8KLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCi8vIERpc3RyaWJ1dGVkIHVuZGVyIE1JVCBsaWNlbnNlCi8vCi8vIGh0dHA6Ly9naXRodWIuY29tL21hcmlvbmV0dGVqcy9iYWNrYm9uZS5iYWJ5c2l0dGVyCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZWJhYnlzaXR0ZXIgPSBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAgICAgcmV0dXJuIGZhY3RvcnkoQmFja2JvbmUsIF8pOwogICAgfShiYWNrYm9uZSwgdW5kZXJzY29yZSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBCYWNrYm9uZSA9IGJhY2tib25lOwogICAgdmFyIF8gPSB1bmRlcnNjb3JlOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KEJhY2tib25lLCBfKTsKICB9IGVsc2UgewogICAgZmFjdG9yeShyb290LkJhY2tib25lLCByb290Ll8pOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAKICB2YXIgcHJldmlvdXNDaGlsZFZpZXdDb250YWluZXIgPSBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXI7CiAgLy8gQmFieVNpdHRlci5DaGlsZFZpZXdDb250YWluZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gUHJvdmlkZSBhIGNvbnRhaW5lciB0byBzdG9yZSwgcmV0cmlldmUgYW5kCiAgLy8gc2h1dCBkb3duIGNoaWxkIHZpZXdzLgogIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lciA9IGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogICAgLy8gQ29udGFpbmVyIENvbnN0cnVjdG9yCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIHZhciBDb250YWluZXIgPSBmdW5jdGlvbiAodmlld3MpIHsKICAgICAgdGhpcy5fdmlld3MgPSB7fTsKICAgICAgdGhpcy5faW5kZXhCeU1vZGVsID0ge307CiAgICAgIHRoaXMuX2luZGV4QnlDdXN0b20gPSB7fTsKICAgICAgdGhpcy5fdXBkYXRlTGVuZ3RoKCk7CiAgICAgIF8uZWFjaCh2aWV3cywgdGhpcy5hZGQsIHRoaXMpOwogICAgfTsKICAgIC8vIENvbnRhaW5lciBNZXRob2RzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLQogICAgXy5leHRlbmQoQ29udGFpbmVyLnByb3RvdHlwZSwgewogICAgICAvLyBBZGQgYSB2aWV3IHRvIHRoaXMgY29udGFpbmVyLiBTdG9yZXMgdGhlIHZpZXcKICAgICAgLy8gYnkgYGNpZGAgYW5kIG1ha2VzIGl0IHNlYXJjaGFibGUgYnkgdGhlIG1vZGVsCiAgICAgIC8vIGNpZCAoYW5kIG1vZGVsIGl0c2VsZikuIE9wdGlvbmFsbHkgc3BlY2lmeQogICAgICAvLyBhIGN1c3RvbSBrZXkgdG8gc3RvcmUgYW4gcmV0cmlldmUgdGhlIHZpZXcuCiAgICAgIGFkZDogZnVuY3Rpb24gKHZpZXcsIGN1c3RvbUluZGV4KSB7CiAgICAgICAgdmFyIHZpZXdDaWQgPSB2aWV3LmNpZDsKICAgICAgICAvLyBzdG9yZSB0aGUgdmlldwogICAgICAgIHRoaXMuX3ZpZXdzW3ZpZXdDaWRdID0gdmlldzsKICAgICAgICAvLyBpbmRleCBpdCBieSBtb2RlbAogICAgICAgIGlmICh2aWV3Lm1vZGVsKSB7CiAgICAgICAgICB0aGlzLl9pbmRleEJ5TW9kZWxbdmlldy5tb2RlbC5jaWRdID0gdmlld0NpZDsKICAgICAgICB9CiAgICAgICAgLy8gaW5kZXggYnkgY3VzdG9tCiAgICAgICAgaWYgKGN1c3RvbUluZGV4KSB7CiAgICAgICAgICB0aGlzLl9pbmRleEJ5Q3VzdG9tW2N1c3RvbUluZGV4XSA9IHZpZXdDaWQ7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3VwZGF0ZUxlbmd0aCgpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBGaW5kIGEgdmlldyBieSB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgLy8gaXQuIFVzZXMgdGhlIG1vZGVsJ3MgYGNpZGAgdG8gZmluZCBpdC4KICAgICAgZmluZEJ5TW9kZWw6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgIHJldHVybiB0aGlzLmZpbmRCeU1vZGVsQ2lkKG1vZGVsLmNpZCk7CiAgICAgIH0sCiAgICAgIC8vIEZpbmQgYSB2aWV3IGJ5IHRoZSBgY2lkYCBvZiB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgLy8gaXQuIFVzZXMgdGhlIG1vZGVsJ3MgYGNpZGAgdG8gZmluZCB0aGUgdmlldyBgY2lkYCBhbmQKICAgICAgLy8gcmV0cmlldmUgdGhlIHZpZXcgdXNpbmcgaXQuCiAgICAgIGZpbmRCeU1vZGVsQ2lkOiBmdW5jdGlvbiAobW9kZWxDaWQpIHsKICAgICAgICB2YXIgdmlld0NpZCA9IHRoaXMuX2luZGV4QnlNb2RlbFttb2RlbENpZF07CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICB9LAogICAgICAvLyBGaW5kIGEgdmlldyBieSBhIGN1c3RvbSBpbmRleGVyLgogICAgICBmaW5kQnlDdXN0b206IGZ1bmN0aW9uIChpbmRleCkgewogICAgICAgIHZhciB2aWV3Q2lkID0gdGhpcy5faW5kZXhCeUN1c3RvbVtpbmRleF07CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICB9LAogICAgICAvLyBGaW5kIGJ5IGluZGV4LiBUaGlzIGlzIG5vdCBndWFyYW50ZWVkIHRvIGJlIGEKICAgICAgLy8gc3RhYmxlIGluZGV4LgogICAgICBmaW5kQnlJbmRleDogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgcmV0dXJuIF8udmFsdWVzKHRoaXMuX3ZpZXdzKVtpbmRleF07CiAgICAgIH0sCiAgICAgIC8vIHJldHJpZXZlIGEgdmlldyBieSBpdHMgYGNpZGAgZGlyZWN0bHkKICAgICAgZmluZEJ5Q2lkOiBmdW5jdGlvbiAoY2lkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3ZpZXdzW2NpZF07CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhIHZpZXcKICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAodmlldykgewogICAgICAgIHZhciB2aWV3Q2lkID0gdmlldy5jaWQ7CiAgICAgICAgLy8gZGVsZXRlIG1vZGVsIGluZGV4CiAgICAgICAgaWYgKHZpZXcubW9kZWwpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbmRleEJ5TW9kZWxbdmlldy5tb2RlbC5jaWRdOwogICAgICAgIH0KICAgICAgICAvLyBkZWxldGUgY3VzdG9tIGluZGV4CiAgICAgICAgXy5hbnkodGhpcy5faW5kZXhCeUN1c3RvbSwgZnVuY3Rpb24gKGNpZCwga2V5KSB7CiAgICAgICAgICBpZiAoY2lkID09PSB2aWV3Q2lkKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbmRleEJ5Q3VzdG9tW2tleV07CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0sIHRoaXMpOwogICAgICAgIC8vIHJlbW92ZSB0aGUgdmlldyBmcm9tIHRoZSBjb250YWluZXIKICAgICAgICBkZWxldGUgdGhpcy5fdmlld3Nbdmlld0NpZF07CiAgICAgICAgLy8gdXBkYXRlIHRoZSBsZW5ndGgKICAgICAgICB0aGlzLl91cGRhdGVMZW5ndGgoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gQ2FsbCBhIG1ldGhvZCBvbiBldmVyeSB2aWV3IGluIHRoZSBjb250YWluZXIsCiAgICAgIC8vIHBhc3NpbmcgcGFyYW1ldGVycyB0byB0aGUgY2FsbCBtZXRob2Qgb25lIGF0IGEKICAgICAgLy8gdGltZSwgbGlrZSBgZnVuY3Rpb24uY2FsbGAuCiAgICAgIGNhbGw6IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICB0aGlzLmFwcGx5KG1ldGhvZCwgXy50YWlsKGFyZ3VtZW50cykpOwogICAgICB9LAogICAgICAvLyBBcHBseSBhIG1ldGhvZCBvbiBldmVyeSB2aWV3IGluIHRoZSBjb250YWluZXIsCiAgICAgIC8vIHBhc3NpbmcgcGFyYW1ldGVycyB0byB0aGUgY2FsbCBtZXRob2Qgb25lIGF0IGEKICAgICAgLy8gdGltZSwgbGlrZSBgZnVuY3Rpb24uYXBwbHlgLgogICAgICBhcHBseTogZnVuY3Rpb24gKG1ldGhvZCwgYXJncykgewogICAgICAgIF8uZWFjaCh0aGlzLl92aWV3cywgZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24odmlld1ttZXRob2RdKSkgewogICAgICAgICAgICB2aWV3W21ldGhvZF0uYXBwbHkodmlldywgYXJncyB8fCBbXSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIC8vIFVwZGF0ZSB0aGUgYC5sZW5ndGhgIGF0dHJpYnV0ZSBvbiB0aGlzIGNvbnRhaW5lcgogICAgICBfdXBkYXRlTGVuZ3RoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5sZW5ndGggPSBfLnNpemUodGhpcy5fdmlld3MpOwogICAgICB9CiAgICB9KTsKICAgIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogICAgLy8gaHR0cDovL2JhY2tib25lanMub3JnL2RvY3MvYmFja2JvbmUuaHRtbCNzZWN0aW9uLTEwNgogICAgLy8KICAgIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgICAvLyBjb2xsZWN0aW9uIHJlbGF0ZWQgZmVhdHVyZXMuCiAgICB2YXIgbWV0aG9kcyA9IFsKICAgICAgJ2ZvckVhY2gnLAogICAgICAnZWFjaCcsCiAgICAgICdtYXAnLAogICAgICAnZmluZCcsCiAgICAgICdkZXRlY3QnLAogICAgICAnZmlsdGVyJywKICAgICAgJ3NlbGVjdCcsCiAgICAgICdyZWplY3QnLAogICAgICAnZXZlcnknLAogICAgICAnYWxsJywKICAgICAgJ3NvbWUnLAogICAgICAnYW55JywKICAgICAgJ2luY2x1ZGUnLAogICAgICAnY29udGFpbnMnLAogICAgICAnaW52b2tlJywKICAgICAgJ3RvQXJyYXknLAogICAgICAnZmlyc3QnLAogICAgICAnaW5pdGlhbCcsCiAgICAgICdyZXN0JywKICAgICAgJ2xhc3QnLAogICAgICAnd2l0aG91dCcsCiAgICAgICdpc0VtcHR5JywKICAgICAgJ3BsdWNrJwogICAgXTsKICAgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgIENvbnRhaW5lci5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdmlld3MgPSBfLnZhbHVlcyh0aGlzLl92aWV3cyk7CiAgICAgICAgdmFyIGFyZ3MgPSBbdmlld3NdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogICAgLy8gcmV0dXJuIHRoZSBwdWJsaWMgQVBJCiAgICByZXR1cm4gQ29udGFpbmVyOwogIH0oQmFja2JvbmUsIF8pOwogIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lci5WRVJTSU9OID0gJzAuMS40JzsKICBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXIubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lciA9IHByZXZpb3VzQ2hpbGRWaWV3Q29udGFpbmVyOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICByZXR1cm4gQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyOwp9KSk7Ci8vIE1hcmlvbmV0dGVKUyAoQmFja2JvbmUuTWFyaW9uZXR0ZSkKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyB2Mi4yLjAKLy8KLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCi8vIERpc3RyaWJ1dGVkIHVuZGVyIE1JVCBsaWNlbnNlCi8vCi8vIGh0dHA6Ly9tYXJpb25ldHRlanMuY29tCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZW1hcmlvbmV0dGUgPSBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAgICAgcmV0dXJuIHJvb3QuTWFyaW9uZXR0ZSA9IGZhY3Rvcnkocm9vdCwgQmFja2JvbmUsIF8pOwogICAgfShiYWNrYm9uZSwgdW5kZXJzY29yZSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBCYWNrYm9uZSA9IGJhY2tib25lOwogICAgdmFyIF8gPSB1bmRlcnNjb3JlOwogICAgdmFyIFdyZXFyID0gYmFja2JvbmV3cmVxcjsKICAgIHZhciBCYWJ5U2l0dGVyID0gYmFja2JvbmViYWJ5c2l0dGVyOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJvb3QsIEJhY2tib25lLCBfKTsKICB9IGVsc2UgewogICAgcm9vdC5NYXJpb25ldHRlID0gZmFjdG9yeShyb290LCByb290LkJhY2tib25lLCByb290Ll8pOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAocm9vdCwgQmFja2JvbmUsIF8pIHsKICAKICB2YXIgcHJldmlvdXNNYXJpb25ldHRlID0gcm9vdC5NYXJpb25ldHRlOwogIHZhciBNYXJpb25ldHRlID0gQmFja2JvbmUuTWFyaW9uZXR0ZSA9IHt9OwogIE1hcmlvbmV0dGUuVkVSU0lPTiA9ICcyLjIuMCc7CiAgTWFyaW9uZXR0ZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgcm9vdC5NYXJpb25ldHRlID0gcHJldmlvdXNNYXJpb25ldHRlOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvLyBHZXQgdGhlIERlZmVycmVkIGNyZWF0b3IgZm9yIGxhdGVyIHVzZQogIE1hcmlvbmV0dGUuRGVmZXJyZWQgPSBCYWNrYm9uZS4kLkRlZmVycmVkOwogIC8qIGpzaGludCB1bnVzZWQ6IGZhbHNlICovCiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KICAvLyBGb3Igc2xpY2luZyBgYXJndW1lbnRzYCBpbiBmdW5jdGlvbnMKICB2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgLy8gTWFyaW9uZXR0ZS5leHRlbmQKICAvLyAtLS0tLS0tLS0tLS0tLS0tLQogIC8vIEJvcnJvdyB0aGUgQmFja2JvbmUgYGV4dGVuZGAgbWV0aG9kIHNvIHdlIGNhbiB1c2UgaXQgYXMgbmVlZGVkCiAgTWFyaW9uZXR0ZS5leHRlbmQgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQ7CiAgLy8gTWFyaW9uZXR0ZS5nZXRPcHRpb24KICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIFJldHJpZXZlIGFuIG9iamVjdCwgZnVuY3Rpb24gb3Igb3RoZXIgdmFsdWUgZnJvbSBhIHRhcmdldAogIC8vIG9iamVjdCBvciBpdHMgYG9wdGlvbnNgLCB3aXRoIGBvcHRpb25zYCB0YWtpbmcgcHJlY2VkZW5jZS4KICBNYXJpb25ldHRlLmdldE9wdGlvbiA9IGZ1bmN0aW9uICh0YXJnZXQsIG9wdGlvbk5hbWUpIHsKICAgIGlmICghdGFyZ2V0IHx8ICFvcHRpb25OYW1lKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB2YWx1ZTsKICAgIGlmICh0YXJnZXQub3B0aW9ucyAmJiB0YXJnZXQub3B0aW9uc1tvcHRpb25OYW1lXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhbHVlID0gdGFyZ2V0Lm9wdGlvbnNbb3B0aW9uTmFtZV07CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IHRhcmdldFtvcHRpb25OYW1lXTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9OwogIC8vIFByb3h5IGBNYXJpb25ldHRlLmdldE9wdGlvbmAKICBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uID0gZnVuY3Rpb24gKG9wdGlvbk5hbWUpIHsKICAgIHJldHVybiBNYXJpb25ldHRlLmdldE9wdGlvbih0aGlzLCBvcHRpb25OYW1lKTsKICB9OwogIC8vIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLyBQYXNzIGluIGEgbWFwcGluZyBvZiBldmVudHMgPT4gZnVuY3Rpb25zIG9yIGZ1bmN0aW9uIG5hbWVzCiAgLy8gYW5kIHJldHVybiBhIG1hcHBpbmcgb2YgZXZlbnRzID0+IGZ1bmN0aW9ucwogIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcyA9IGZ1bmN0aW9uIChoYXNoKSB7CiAgICB2YXIgbm9ybWFsaXplZEhhc2ggPSB7fTsKICAgIF8uZWFjaChoYXNoLCBmdW5jdGlvbiAobWV0aG9kLCBuYW1lKSB7CiAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIHsKICAgICAgICBtZXRob2QgPSB0aGlzW21ldGhvZF07CiAgICAgIH0KICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbm9ybWFsaXplZEhhc2hbbmFtZV0gPSBtZXRob2Q7CiAgICB9LCB0aGlzKTsKICAgIHJldHVybiBub3JtYWxpemVkSGFzaDsKICB9OwogIC8vIHV0aWxpdHkgbWV0aG9kIGZvciBwYXJzaW5nIEB1aS4gc3ludGF4IHN0cmluZ3MKICAvLyBpbnRvIGFzc29jaWF0ZWQgc2VsZWN0b3IKICBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJU3RyaW5nID0gZnVuY3Rpb24gKHVpU3RyaW5nLCB1aSkgewogICAgcmV0dXJuIHVpU3RyaW5nLnJlcGxhY2UoL0B1aVwuW2EtekEtWl8kMC05XSovZywgZnVuY3Rpb24gKHIpIHsKICAgICAgcmV0dXJuIHVpW3Iuc2xpY2UoNCldOwogICAgfSk7CiAgfTsKICAvLyBhbGxvd3MgZm9yIHRoZSB1c2Ugb2YgdGhlIEB1aS4gc3ludGF4IHdpdGhpbgogIC8vIGEgZ2l2ZW4ga2V5IGZvciB0cmlnZ2VycyBhbmQgZXZlbnRzCiAgLy8gc3dhcHMgdGhlIEB1aSB3aXRoIHRoZSBhc3NvY2lhdGVkIHNlbGVjdG9yLgogIC8vIFJldHVybnMgYSBuZXcsIG5vbi1tdXRhdGVkLCBwYXJzZWQgZXZlbnRzIGhhc2guCiAgTWFyaW9uZXR0ZS5ub3JtYWxpemVVSUtleXMgPSBmdW5jdGlvbiAoaGFzaCwgdWkpIHsKICAgIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaGFzaCA9IF8uY2xvbmUoaGFzaCk7CiAgICBfLmVhY2goXy5rZXlzKGhhc2gpLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyhrZXksIHVpKTsKICAgICAgaWYgKG5vcm1hbGl6ZWRLZXkgIT09IGtleSkgewogICAgICAgIGhhc2hbbm9ybWFsaXplZEtleV0gPSBoYXNoW2tleV07CiAgICAgICAgZGVsZXRlIGhhc2hba2V5XTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaGFzaDsKICB9OwogIC8vIGFsbG93cyBmb3IgdGhlIHVzZSBvZiB0aGUgQHVpLiBzeW50YXggd2l0aGluCiAgLy8gYSBnaXZlbiB2YWx1ZSBmb3IgcmVnaW9ucwogIC8vIHN3YXBzIHRoZSBAdWkgd2l0aCB0aGUgYXNzb2NpYXRlZCBzZWxlY3RvcgogIE1hcmlvbmV0dGUubm9ybWFsaXplVUlWYWx1ZXMgPSBmdW5jdGlvbiAoaGFzaCwgdWkpIHsKICAgIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgXy5lYWNoKGhhc2gsIGZ1bmN0aW9uICh2YWwsIGtleSkgewogICAgICBpZiAoXy5pc1N0cmluZyh2YWwpKSB7CiAgICAgICAgaGFzaFtrZXldID0gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyh2YWwsIHVpKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaGFzaDsKICB9OwogIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgLy8gY29sbGVjdGlvbiByZWxhdGVkIGZlYXR1cmVzLgogIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogIC8vIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZy9kb2NzL2JhY2tib25lLmh0bWwjc2VjdGlvbi0xMjEKICBNYXJpb25ldHRlLmFjdEFzQ29sbGVjdGlvbiA9IGZ1bmN0aW9uIChvYmplY3QsIGxpc3RQcm9wZXJ0eSkgewogICAgdmFyIG1ldGhvZHMgPSBbCiAgICAgICdmb3JFYWNoJywKICAgICAgJ2VhY2gnLAogICAgICAnbWFwJywKICAgICAgJ2ZpbmQnLAogICAgICAnZGV0ZWN0JywKICAgICAgJ2ZpbHRlcicsCiAgICAgICdzZWxlY3QnLAogICAgICAncmVqZWN0JywKICAgICAgJ2V2ZXJ5JywKICAgICAgJ2FsbCcsCiAgICAgICdzb21lJywKICAgICAgJ2FueScsCiAgICAgICdpbmNsdWRlJywKICAgICAgJ2NvbnRhaW5zJywKICAgICAgJ2ludm9rZScsCiAgICAgICd0b0FycmF5JywKICAgICAgJ2ZpcnN0JywKICAgICAgJ2luaXRpYWwnLAogICAgICAncmVzdCcsCiAgICAgICdsYXN0JywKICAgICAgJ3dpdGhvdXQnLAogICAgICAnaXNFbXB0eScsCiAgICAgICdwbHVjaycKICAgIF07CiAgICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICBvYmplY3RbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbGlzdCA9IF8udmFsdWVzKF8ucmVzdWx0KHRoaXMsIGxpc3RQcm9wZXJ0eSkpOwogICAgICAgIHZhciBhcmdzID0gW2xpc3RdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgLy8gVHJpZ2dlciBhbiBldmVudCBhbmQvb3IgYSBjb3JyZXNwb25kaW5nIG1ldGhvZCBuYW1lLiBFeGFtcGxlczoKICAvLwogIC8vIGB0aGlzLnRyaWdnZXJNZXRob2QoImZvbyIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb28iIGV2ZW50IGFuZAogIC8vIGNhbGwgdGhlICJvbkZvbyIgbWV0aG9kLgogIC8vCiAgLy8gYHRoaXMudHJpZ2dlck1ldGhvZCgiZm9vOmJhciIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb286YmFyIiBldmVudCBhbmQKICAvLyBjYWxsIHRoZSAib25Gb29CYXIiIG1ldGhvZC4KICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIC8vIHNwbGl0IHRoZSBldmVudCBuYW1lIG9uIHRoZSAiOiIKICAgIHZhciBzcGxpdHRlciA9IC8oXnw6KShcdykvZ2k7CiAgICAvLyB0YWtlIHRoZSBldmVudCBzZWN0aW9uICgic2VjdGlvbjE6c2VjdGlvbjI6c2VjdGlvbjMiKQogICAgLy8gYW5kIHR1cm4gaXQgaW4gdG8gdXBwZXJjYXNlIG5hbWUKICAgIGZ1bmN0aW9uIGdldEV2ZW50TmFtZShtYXRjaCwgcHJlZml4LCBldmVudE5hbWUpIHsKICAgICAgcmV0dXJuIGV2ZW50TmFtZS50b1VwcGVyQ2FzZSgpOwogICAgfQogICAgLy8gZ2V0IHRoZSBtZXRob2QgbmFtZSBmcm9tIHRoZSBldmVudCBuYW1lCiAgICB2YXIgbWV0aG9kTmFtZSA9ICdvbicgKyBldmVudC5yZXBsYWNlKHNwbGl0dGVyLCBnZXRFdmVudE5hbWUpOwogICAgdmFyIG1ldGhvZCA9IHRoaXNbbWV0aG9kTmFtZV07CiAgICB2YXIgcmVzdWx0OwogICAgLy8gY2FsbCB0aGUgb25NZXRob2ROYW1lIGlmIGl0IGV4aXN0cwogICAgaWYgKF8uaXNGdW5jdGlvbihtZXRob2QpKSB7CiAgICAgIC8vIHBhc3MgYWxsIGFyZ3VtZW50cywgZXhjZXB0IHRoZSBldmVudCBuYW1lCiAgICAgIHJlc3VsdCA9IG1ldGhvZC5hcHBseSh0aGlzLCBfLnRhaWwoYXJndW1lbnRzKSk7CiAgICB9CiAgICAvLyB0cmlnZ2VyIHRoZSBldmVudCwgaWYgYSB0cmlnZ2VyIG1ldGhvZCBleGlzdHMKICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy50cmlnZ2VyKSkgewogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyB0cmlnZ2VyTWV0aG9kT24gaW52b2tlcyB0cmlnZ2VyTWV0aG9kIG9uIGEgc3BlY2lmaWMgY29udGV4dAogIC8vCiAgLy8gZS5nLiBgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ3Nob3cnKWAKICAvLyB3aWxsIHRyaWdnZXIgYSAic2hvdyIgZXZlbnQgb3IgaW52b2tlIG9uU2hvdyB0aGUgdmlldy4KICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbiA9IGZ1bmN0aW9uIChjb250ZXh0LCBldmVudCkgewogICAgdmFyIGFyZ3MgPSBfLnRhaWwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBmbmM7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGNvbnRleHQudHJpZ2dlck1ldGhvZCkpIHsKICAgICAgZm5jID0gY29udGV4dC50cmlnZ2VyTWV0aG9kOwogICAgfSBlbHNlIHsKICAgICAgZm5jID0gTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kOwogICAgfQogICAgcmV0dXJuIGZuYy5hcHBseShjb250ZXh0LCBbZXZlbnRdLmNvbmNhdChhcmdzKSk7CiAgfTsKICAvLyBET01SZWZyZXNoCiAgLy8gLS0tLS0tLS0tLQogIC8vCiAgLy8gTW9uaXRvciBhIHZpZXcncyBzdGF0ZSwgYW5kIGFmdGVyIGl0IGhhcyBiZWVuIHJlbmRlcmVkIGFuZCBzaG93bgogIC8vIGluIHRoZSBET00sIHRyaWdnZXIgYSAiZG9tOnJlZnJlc2giIGV2ZW50IGV2ZXJ5IHRpbWUgaXQgaXMKICAvLyByZS1yZW5kZXJlZC4KICBNYXJpb25ldHRlLk1vbml0b3JET01SZWZyZXNoID0gZnVuY3Rpb24gKGRvY3VtZW50RWxlbWVudCkgewogICAgLy8gdHJhY2sgd2hlbiB0aGUgdmlldyBoYXMgYmVlbiBzaG93biBpbiB0aGUgRE9NLAogICAgLy8gdXNpbmcgYSBNYXJpb25ldHRlLlJlZ2lvbiAob3IgYnkgb3RoZXIgbWVhbnMgb2YgdHJpZ2dlcmluZyAic2hvdyIpCiAgICBmdW5jdGlvbiBoYW5kbGVTaG93KHZpZXcpIHsKICAgICAgdmlldy5faXNTaG93biA9IHRydWU7CiAgICAgIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpOwogICAgfQogICAgLy8gdHJhY2sgd2hlbiB0aGUgdmlldyBoYXMgYmVlbiByZW5kZXJlZAogICAgZnVuY3Rpb24gaGFuZGxlUmVuZGVyKHZpZXcpIHsKICAgICAgdmlldy5faXNSZW5kZXJlZCA9IHRydWU7CiAgICAgIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpOwogICAgfQogICAgLy8gVHJpZ2dlciB0aGUgImRvbTpyZWZyZXNoIiBldmVudCBhbmQgY29ycmVzcG9uZGluZyAib25Eb21SZWZyZXNoIiBtZXRob2QKICAgIGZ1bmN0aW9uIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpIHsKICAgICAgaWYgKHZpZXcuX2lzU2hvd24gJiYgdmlldy5faXNSZW5kZXJlZCAmJiBpc0luRE9NKHZpZXcpKSB7CiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih2aWV3LnRyaWdnZXJNZXRob2QpKSB7CiAgICAgICAgICB2aWV3LnRyaWdnZXJNZXRob2QoJ2RvbTpyZWZyZXNoJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc0luRE9NKHZpZXcpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLiQuY29udGFpbnMoZG9jdW1lbnRFbGVtZW50LCB2aWV3LmVsKTsKICAgIH0KICAgIC8vIEV4cG9ydCBwdWJsaWMgQVBJCiAgICByZXR1cm4gZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgdmlldy5saXN0ZW5Ubyh2aWV3LCAnc2hvdycsIGZ1bmN0aW9uICgpIHsKICAgICAgICBoYW5kbGVTaG93KHZpZXcpOwogICAgICB9KTsKICAgICAgdmlldy5saXN0ZW5Ubyh2aWV3LCAncmVuZGVyJywgZnVuY3Rpb24gKCkgewogICAgICAgIGhhbmRsZVJlbmRlcih2aWV3KTsKICAgICAgfSk7CiAgICB9OwogIH0oZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTsKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA1ICovCiAgLy8gTWFyaW9uZXR0ZS5iaW5kRW50aXR5RXZlbnRzICYgdW5iaW5kRW50aXR5RXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBUaGVzZSBtZXRob2RzIGFyZSB1c2VkIHRvIGJpbmQvdW5iaW5kIGEgYmFja2JvbmUgImVudGl0eSIgKGNvbGxlY3Rpb24vbW9kZWwpCiAgLy8gdG8gbWV0aG9kcyBvbiBhIHRhcmdldCBvYmplY3QuCiAgLy8KICAvLyBUaGUgZmlyc3QgcGFyYW1ldGVyLCBgdGFyZ2V0YCwgbXVzdCBoYXZlIGEgYGxpc3RlblRvYCBtZXRob2QgZnJvbSB0aGUKICAvLyBFdmVudEJpbmRlciBvYmplY3QuCiAgLy8KICAvLyBUaGUgc2Vjb25kIHBhcmFtZXRlciBpcyB0aGUgZW50aXR5IChCYWNrYm9uZS5Nb2RlbCBvciBCYWNrYm9uZS5Db2xsZWN0aW9uKQogIC8vIHRvIGJpbmQgdGhlIGV2ZW50cyBmcm9tLgogIC8vCiAgLy8gVGhlIHRoaXJkIHBhcmFtZXRlciBpcyBhIGhhc2ggb2YgeyAiZXZlbnQ6bmFtZSI6ICJldmVudEhhbmRsZXIiIH0KICAvLyBjb25maWd1cmF0aW9uLiBNdWx0aXBsZSBoYW5kbGVycyBjYW4gYmUgc2VwYXJhdGVkIGJ5IGEgc3BhY2UuIEEKICAvLyBmdW5jdGlvbiBjYW4gYmUgc3VwcGxpZWQgaW5zdGVhZCBvZiBhIHN0cmluZyBoYW5kbGVyIG5hbWUuCiAgKGZ1bmN0aW9uIChNYXJpb25ldHRlKSB7CiAgICAKICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGhhbmRsZXJzIHNwZWNpZmllZCBhcyBhIHN0cmluZyBvZgogICAgLy8gaGFuZGxlciBuYW1lcyBvbiB0aGUgdGFyZ2V0IG9iamVjdAogICAgZnVuY3Rpb24gYmluZEZyb21TdHJpbmdzKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpIHsKICAgICAgdmFyIG1ldGhvZE5hbWVzID0gbWV0aG9kcy5zcGxpdCgvXHMrLyk7CiAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICB2YXIgbWV0aG9kID0gdGFyZ2V0W21ldGhvZE5hbWVdOwogICAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcignTWV0aG9kICInICsgbWV0aG9kTmFtZSArICciIHdhcyBjb25maWd1cmVkIGFzIGFuIGV2ZW50IGhhbmRsZXIsIGJ1dCBkb2VzIG5vdCBleGlzdC4nKTsKICAgICAgICB9CiAgICAgICAgdGFyZ2V0Lmxpc3RlblRvKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgICB9KTsKICAgIH0KICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGEgc3VwcGxpZWQgY2FsbGJhY2sgZnVuY3Rpb24KICAgIGZ1bmN0aW9uIGJpbmRUb0Z1bmN0aW9uKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZCkgewogICAgICB0YXJnZXQubGlzdGVuVG8oZW50aXR5LCBldnQsIG1ldGhvZCk7CiAgICB9CiAgICAvLyBCaW5kIHRoZSBldmVudCB0byBoYW5kbGVycyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgb2YKICAgIC8vIGhhbmRsZXIgbmFtZXMgb24gdGhlIHRhcmdldCBvYmplY3QKICAgIGZ1bmN0aW9uIHVuYmluZEZyb21TdHJpbmdzKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpIHsKICAgICAgdmFyIG1ldGhvZE5hbWVzID0gbWV0aG9kcy5zcGxpdCgvXHMrLyk7CiAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICB2YXIgbWV0aG9kID0gdGFyZ2V0W21ldGhvZE5hbWVdOwogICAgICAgIHRhcmdldC5zdG9wTGlzdGVuaW5nKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgICB9KTsKICAgIH0KICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGEgc3VwcGxpZWQgY2FsbGJhY2sgZnVuY3Rpb24KICAgIGZ1bmN0aW9uIHVuYmluZFRvRnVuY3Rpb24odGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kKSB7CiAgICAgIHRhcmdldC5zdG9wTGlzdGVuaW5nKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgfQogICAgLy8gZ2VuZXJpYyBsb29waW5nIGZ1bmN0aW9uCiAgICBmdW5jdGlvbiBpdGVyYXRlRXZlbnRzKHRhcmdldCwgZW50aXR5LCBiaW5kaW5ncywgZnVuY3Rpb25DYWxsYmFjaywgc3RyaW5nQ2FsbGJhY2spIHsKICAgICAgaWYgKCFlbnRpdHkgfHwgIWJpbmRpbmdzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIHR5cGUtY2hlY2sgYmluZGluZ3MKICAgICAgaWYgKCFfLmlzRnVuY3Rpb24oYmluZGluZ3MpICYmICFfLmlzT2JqZWN0KGJpbmRpbmdzKSkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG1lc3NhZ2U6ICdCaW5kaW5ncyBtdXN0IGJlIGFuIG9iamVjdCBvciBmdW5jdGlvbi4nLAogICAgICAgICAgdXJsOiAnbWFyaW9uZXR0ZS5mdW5jdGlvbnMuaHRtbCNtYXJpb25ldHRlYmluZGVudGl0eWV2ZW50cycKICAgICAgICB9KTsKICAgICAgfQogICAgICAvLyBhbGxvdyB0aGUgYmluZGluZ3MgdG8gYmUgYSBmdW5jdGlvbgogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGJpbmRpbmdzKSkgewogICAgICAgIGJpbmRpbmdzID0gYmluZGluZ3MuY2FsbCh0YXJnZXQpOwogICAgICB9CiAgICAgIC8vIGl0ZXJhdGUgdGhlIGJpbmRpbmdzIGFuZCBiaW5kIHRoZW0KICAgICAgXy5lYWNoKGJpbmRpbmdzLCBmdW5jdGlvbiAobWV0aG9kcywgZXZ0KSB7CiAgICAgICAgLy8gYWxsb3cgZm9yIGEgZnVuY3Rpb24gYXMgdGhlIGhhbmRsZXIsCiAgICAgICAgLy8gb3IgYSBsaXN0IG9mIGV2ZW50IG5hbWVzIGFzIGEgc3RyaW5nCiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihtZXRob2RzKSkgewogICAgICAgICAgZnVuY3Rpb25DYWxsYmFjayh0YXJnZXQsIGVudGl0eSwgZXZ0LCBtZXRob2RzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyaW5nQ2FsbGJhY2sodGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIC8vIEV4cG9ydCBQdWJsaWMgQVBJCiAgICBNYXJpb25ldHRlLmJpbmRFbnRpdHlFdmVudHMgPSBmdW5jdGlvbiAodGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIGl0ZXJhdGVFdmVudHModGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzLCBiaW5kVG9GdW5jdGlvbiwgYmluZEZyb21TdHJpbmdzKTsKICAgIH07CiAgICBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyA9IGZ1bmN0aW9uICh0YXJnZXQsIGVudGl0eSwgYmluZGluZ3MpIHsKICAgICAgaXRlcmF0ZUV2ZW50cyh0YXJnZXQsIGVudGl0eSwgYmluZGluZ3MsIHVuYmluZFRvRnVuY3Rpb24sIHVuYmluZEZyb21TdHJpbmdzKTsKICAgIH07CiAgICAvLyBQcm94eSBgYmluZEVudGl0eUV2ZW50c2AKICAgIE1hcmlvbmV0dGUucHJveHlCaW5kRW50aXR5RXZlbnRzID0gZnVuY3Rpb24gKGVudGl0eSwgYmluZGluZ3MpIHsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuYmluZEVudGl0eUV2ZW50cyh0aGlzLCBlbnRpdHksIGJpbmRpbmdzKTsKICAgIH07CiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYAogICAgTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cyA9IGZ1bmN0aW9uIChlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIHJldHVybiBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLCBlbnRpdHksIGJpbmRpbmdzKTsKICAgIH07CiAgfShNYXJpb25ldHRlKSk7CiAgdmFyIGVycm9yUHJvcHMgPSBbCiAgICAnZGVzY3JpcHRpb24nLAogICAgJ2ZpbGVOYW1lJywKICAgICdsaW5lTnVtYmVyJywKICAgICduYW1lJywKICAgICdtZXNzYWdlJywKICAgICdudW1iZXInCiAgXTsKICBNYXJpb25ldHRlLkVycm9yID0gTWFyaW9uZXR0ZS5leHRlbmQuY2FsbChFcnJvciwgewogICAgdXJsUm9vdDogJ2h0dHA6Ly9tYXJpb25ldHRlanMuY29tL2RvY3MvJyArIE1hcmlvbmV0dGUuVkVSU0lPTiArICcvJywKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAobWVzc2FnZSwgb3B0aW9ucykgewogICAgICBpZiAoXy5pc09iamVjdChtZXNzYWdlKSkgewogICAgICAgIG9wdGlvbnMgPSBtZXNzYWdlOwogICAgICAgIG1lc3NhZ2UgPSBvcHRpb25zLm1lc3NhZ2U7CiAgICAgIH0gZWxzZSBpZiAoIW9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgdmFyIGVycm9yID0gRXJyb3IuY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgICAgXy5leHRlbmQodGhpcywgXy5waWNrKGVycm9yLCBlcnJvclByb3BzKSwgXy5waWNrKG9wdGlvbnMsIGVycm9yUHJvcHMpKTsKICAgICAgdGhpcy5jYXB0dXJlU3RhY2tUcmFjZSgpOwogICAgICBpZiAob3B0aW9ucy51cmwpIHsKICAgICAgICB0aGlzLnVybCA9IHRoaXMudXJsUm9vdCArIG9wdGlvbnMudXJsOwogICAgICB9CiAgICB9LAogICAgY2FwdHVyZVN0YWNrVHJhY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgTWFyaW9uZXR0ZS5FcnJvcik7CiAgICAgIH0KICAgIH0sCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5uYW1lICsgJzogJyArIHRoaXMubWVzc2FnZSArICh0aGlzLnVybCA/ICcgU2VlOiAnICsgdGhpcy51cmwgOiAnJyk7CiAgICB9CiAgfSk7CiAgTWFyaW9uZXR0ZS5FcnJvci5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvLyBDYWxsYmFja3MKICAvLyAtLS0tLS0tLS0KICAvLyBBIHNpbXBsZSB3YXkgb2YgbWFuYWdpbmcgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcwogIC8vIGFuZCBleGVjdXRpbmcgdGhlbSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUsIHVzaW5nIGpRdWVyeSdzCiAgLy8gYERlZmVycmVkYCBvYmplY3QuCiAgTWFyaW9uZXR0ZS5DYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9kZWZlcnJlZCA9IE1hcmlvbmV0dGUuRGVmZXJyZWQoKTsKICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogIH07CiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5DYWxsYmFja3MucHJvdG90eXBlLCB7CiAgICAvLyBBZGQgYSBjYWxsYmFjayB0byBiZSBleGVjdXRlZC4gQ2FsbGJhY2tzIGFkZGVkIGhlcmUgYXJlCiAgICAvLyBndWFyYW50ZWVkIHRvIGV4ZWN1dGUsIGV2ZW4gaWYgdGhleSBhcmUgYWRkZWQgYWZ0ZXIgdGhlCiAgICAvLyBgcnVuYCBtZXRob2QgaXMgY2FsbGVkLgogICAgYWRkOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNvbnRleHRPdmVycmlkZSkgewogICAgICB2YXIgcHJvbWlzZSA9IF8ucmVzdWx0KHRoaXMuX2RlZmVycmVkLCAncHJvbWlzZScpOwogICAgICB0aGlzLl9jYWxsYmFja3MucHVzaCh7CiAgICAgICAgY2I6IGNhbGxiYWNrLAogICAgICAgIGN0eDogY29udGV4dE92ZXJyaWRlCiAgICAgIH0pOwogICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICBpZiAoY29udGV4dE92ZXJyaWRlKSB7CiAgICAgICAgICBhcmdzLmNvbnRleHQgPSBjb250ZXh0T3ZlcnJpZGU7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrLmNhbGwoYXJncy5jb250ZXh0LCBhcmdzLm9wdGlvbnMpOwogICAgICB9KTsKICAgIH0sCiAgICAvLyBSdW4gYWxsIHJlZ2lzdGVyZWQgY2FsbGJhY2tzIHdpdGggdGhlIGNvbnRleHQgc3BlY2lmaWVkLgogICAgLy8gQWRkaXRpb25hbCBjYWxsYmFja3MgY2FuIGJlIGFkZGVkIGFmdGVyIHRoaXMgaGFzIGJlZW4gcnVuCiAgICAvLyBhbmQgdGhleSB3aWxsIHN0aWxsIGJlIGV4ZWN1dGVkLgogICAgcnVuOiBmdW5jdGlvbiAob3B0aW9ucywgY29udGV4dCkgewogICAgICB0aGlzLl9kZWZlcnJlZC5yZXNvbHZlKHsKICAgICAgICBvcHRpb25zOiBvcHRpb25zLAogICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgfSk7CiAgICB9LAogICAgLy8gUmVzZXRzIHRoZSBsaXN0IG9mIGNhbGxiYWNrcyB0byBiZSBydW4sIGFsbG93aW5nIHRoZSBzYW1lIGxpc3QKICAgIC8vIHRvIGJlIHJ1biBtdWx0aXBsZSB0aW1lcyAtIHdoZW5ldmVyIHRoZSBgcnVuYCBtZXRob2QgaXMgY2FsbGVkLgogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrczsKICAgICAgdGhpcy5fZGVmZXJyZWQgPSBNYXJpb25ldHRlLkRlZmVycmVkKCk7CiAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogICAgICBfLmVhY2goY2FsbGJhY2tzLCBmdW5jdGlvbiAoY2IpIHsKICAgICAgICB0aGlzLmFkZChjYi5jYiwgY2IuY3R4KTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSk7CiAgLy8gTWFyaW9uZXR0ZSBDb250cm9sbGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBIG11bHRpLXB1cnBvc2Ugb2JqZWN0IHRvIHVzZSBhcyBhIGNvbnRyb2xsZXIgZm9yCiAgLy8gbW9kdWxlcyBhbmQgcm91dGVycywgYW5kIGFzIGEgbWVkaWF0b3IgZm9yIHdvcmtmbG93CiAgLy8gYW5kIGNvb3JkaW5hdGlvbiBvZiBvdGhlciBvYmplY3RzLCB2aWV3cywgYW5kIG1vcmUuCiAgTWFyaW9uZXR0ZS5Db250cm9sbGVyID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgdGhpcy5pbml0aWFsaXplKHRoaXMub3B0aW9ucyk7CiAgICB9CiAgfTsKICBNYXJpb25ldHRlLkNvbnRyb2xsZXIuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgLy8gQ29udHJvbGxlciBNZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLyBFbnN1cmUgaXQgY2FuIHRyaWdnZXIgZXZlbnRzIHdpdGggQmFja2JvbmUuRXZlbnRzCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5Db250cm9sbGVyLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzLCB7CiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QuYXBwbHkodGhpcywgWydiZWZvcmU6ZGVzdHJveSddLmNvbmNhdChhcmdzKSk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2Rlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgdGhpcy5vZmYoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIE1hcmlvbmV0dGUgT2JqZWN0CiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBIEJhc2UgQ2xhc3MgdGhhdCBvdGhlciBDbGFzc2VzIHNob3VsZCBkZXNjZW5kIGZyb20uCiAgLy8gT2JqZWN0IGJvcnJvd3MgbWFueSBjb252ZW50aW9ucyBhbmQgdXRpbGl0aWVzIGZyb20gQmFja2JvbmUuCiAgTWFyaW9uZXR0ZS5PYmplY3QgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICBNYXJpb25ldHRlLk9iamVjdC5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvLyBPYmplY3QgTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5PYmplY3QucHJvdG90eXBlLCB7CiAgICAvL3RoaXMgaXMgYSBub29wIG1ldGhvZCBpbnRlbmRlZCB0byBiZSBvdmVycmlkZGVuIGJ5IGNsYXNzZXMgdGhhdCBleHRlbmQgZnJvbSB0aGlzIGJhc2UKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmRlc3Ryb3knKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdkZXN0cm95Jyk7CiAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOwogICAgfSwKICAgIC8vIEltcG9ydCB0aGUgYHRyaWdnZXJNZXRob2RgIHRvIHRyaWdnZXIgZXZlbnRzIHdpdGggY29ycmVzcG9uZGluZwogICAgLy8gbWV0aG9kcyBpZiB0aGUgbWV0aG9kIGV4aXN0cwogICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kLAogICAgLy8gUHJveHkgYGdldE9wdGlvbmAgdG8gZW5hYmxlIGdldHRpbmcgb3B0aW9ucyBmcm9tIHRoaXMgb3IgdGhpcy5vcHRpb25zIGJ5IG5hbWUuCiAgICBnZXRPcHRpb246IE1hcmlvbmV0dGUucHJveHlHZXRPcHRpb24sCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgYmluZGluZyB2aWV3J3MgZXZlbnRzIGZyb20gYW5vdGhlciBlbnRpdHkuCiAgICBiaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5QmluZEVudGl0eUV2ZW50cywKICAgIC8vIFByb3h5IGB1bmJpbmRFbnRpdHlFdmVudHNgIHRvIGVuYWJsZSB1bmJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgdW5iaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5VW5iaW5kRW50aXR5RXZlbnRzCiAgfSk7CiAgLy8gRW5zdXJlIGl0IGNhbiB0cmlnZ2VyIGV2ZW50cyB3aXRoIEJhY2tib25lLkV2ZW50cwogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuT2JqZWN0LnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzKTsKICAvKiBqc2hpbnQgbWF4Y29tcGxleGl0eTogMTAsIG1heHN0YXRlbWVudHM6IDI5ICovCiAgLy8gUmVnaW9uCiAgLy8gLS0tLS0tCiAgLy8KICAvLyBNYW5hZ2UgdGhlIHZpc3VhbCByZWdpb25zIG9mIHlvdXIgY29tcG9zaXRlIGFwcGxpY2F0aW9uLiBTZWUKICAvLyBodHRwOi8vbG9zdGVjaGllcy5jb20vZGVyaWNrYmFpbGV5LzIwMTEvMTIvMTIvY29tcG9zaXRlLWpzLWFwcHMtcmVnaW9ucy1hbmQtcmVnaW9uLW1hbmFnZXJzLwogIE1hcmlvbmV0dGUuUmVnaW9uID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLmVsID0gdGhpcy5nZXRPcHRpb24oJ2VsJyk7CiAgICAvLyBIYW5kbGUgd2hlbiB0aGlzLmVsIGlzIHBhc3NlZCBpbiBhcyBhICQgd3JhcHBlZCBlbGVtZW50LgogICAgdGhpcy5lbCA9IHRoaXMuZWwgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gdGhpcy5lbFswXSA6IHRoaXMuZWw7CiAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgIG5hbWU6ICdOb0VsRXJyb3InLAogICAgICAgIG1lc3NhZ2U6ICdBbiAiZWwiIG11c3QgYmUgc3BlY2lmaWVkIGZvciBhIHJlZ2lvbi4nCiAgICAgIH0pOwogICAgfQogICAgdGhpcy4kZWwgPSB0aGlzLmdldEVsKHRoaXMuZWwpOwogICAgaWYgKHRoaXMuaW5pdGlhbGl6ZSkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICB9OwogIC8vIFJlZ2lvbiBDbGFzcyBtZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuUmVnaW9uLCB7CiAgICAvLyBCdWlsZCBhbiBpbnN0YW5jZSBvZiBhIHJlZ2lvbiBieSBwYXNzaW5nIGluIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgIC8vIGFuZCBhIGRlZmF1bHQgcmVnaW9uIGNsYXNzIHRvIHVzZSBpZiBub25lIGlzIHNwZWNpZmllZCBpbiB0aGUgY29uZmlnLgogICAgLy8KICAgIC8vIFRoZSBjb25maWcgb2JqZWN0IHNob3VsZCBlaXRoZXIgYmUgYSBzdHJpbmcgYXMgYSBqUXVlcnkgRE9NIHNlbGVjdG9yLAogICAgLy8gYSBSZWdpb24gY2xhc3MgZGlyZWN0bHksIG9yIGFuIG9iamVjdCBsaXRlcmFsIHRoYXQgc3BlY2lmaWVzIGJvdGgKICAgIC8vIGEgc2VsZWN0b3IgYW5kIHJlZ2lvbkNsYXNzOgogICAgLy8KICAgIC8vIGBgYGpzCiAgICAvLyB7CiAgICAvLyAgIHNlbGVjdG9yOiAiI2ZvbyIsCiAgICAvLyAgIHJlZ2lvbkNsYXNzOiBNeUN1c3RvbVJlZ2lvbgogICAgLy8gfQogICAgLy8gYGBgCiAgICAvLwogICAgYnVpbGRSZWdpb246IGZ1bmN0aW9uIChyZWdpb25Db25maWcsIERlZmF1bHRSZWdpb25DbGFzcykgewogICAgICBpZiAoXy5pc1N0cmluZyhyZWdpb25Db25maWcpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkUmVnaW9uRnJvbVNlbGVjdG9yKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKTsKICAgICAgfQogICAgICBpZiAocmVnaW9uQ29uZmlnLnNlbGVjdG9yIHx8IHJlZ2lvbkNvbmZpZy5lbCB8fCByZWdpb25Db25maWcucmVnaW9uQ2xhc3MpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25Gcm9tT2JqZWN0KHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKTsKICAgICAgfQogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbkNvbmZpZykpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25Gcm9tUmVnaW9uQ2xhc3MocmVnaW9uQ29uZmlnKTsKICAgICAgfQogICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogJ0ltcHJvcGVyIHJlZ2lvbiBjb25maWd1cmF0aW9uIHR5cGUuJywKICAgICAgICB1cmw6ICdtYXJpb25ldHRlLnJlZ2lvbi5odG1sI3JlZ2lvbi1jb25maWd1cmF0aW9uLXR5cGVzJwogICAgICB9KTsKICAgIH0sCiAgICAvLyBCdWlsZCB0aGUgcmVnaW9uIGZyb20gYSBzdHJpbmcgc2VsZWN0b3IgbGlrZSAnI2Zvby1yZWdpb24nCiAgICBfYnVpbGRSZWdpb25Gcm9tU2VsZWN0b3I6IGZ1bmN0aW9uIChzZWxlY3RvciwgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIHJldHVybiBuZXcgRGVmYXVsdFJlZ2lvbkNsYXNzKHsgZWw6IHNlbGVjdG9yIH0pOwogICAgfSwKICAgIC8vIEJ1aWxkIHRoZSByZWdpb24gZnJvbSBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAvLyBgYGBqcwogICAgLy8geyBzZWxlY3RvcjogJyNmb28nLCByZWdpb25DbGFzczogRm9vUmVnaW9uIH0KICAgIC8vIGBgYAogICAgX2J1aWxkUmVnaW9uRnJvbU9iamVjdDogZnVuY3Rpb24gKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIHZhciBSZWdpb25DbGFzcyA9IHJlZ2lvbkNvbmZpZy5yZWdpb25DbGFzcyB8fCBEZWZhdWx0UmVnaW9uQ2xhc3M7CiAgICAgIHZhciBvcHRpb25zID0gXy5vbWl0KHJlZ2lvbkNvbmZpZywgJ3NlbGVjdG9yJywgJ3JlZ2lvbkNsYXNzJyk7CiAgICAgIGlmIChyZWdpb25Db25maWcuc2VsZWN0b3IgJiYgIW9wdGlvbnMuZWwpIHsKICAgICAgICBvcHRpb25zLmVsID0gcmVnaW9uQ29uZmlnLnNlbGVjdG9yOwogICAgICB9CiAgICAgIHZhciByZWdpb24gPSBuZXcgUmVnaW9uQ2xhc3Mob3B0aW9ucyk7CiAgICAgIC8vIG92ZXJyaWRlIHRoZSBgZ2V0RWxgIGZ1bmN0aW9uIGlmIHdlIGhhdmUgYSBwYXJlbnRFbAogICAgICAvLyB0aGlzIG11c3QgYmUgb3ZlcnJpZGRlbiB0byBlbnN1cmUgdGhlIHNlbGVjdG9yIGlzIGZvdW5kCiAgICAgIC8vIG9uIHRoZSBmaXJzdCB1c2Ugb2YgdGhlIHJlZ2lvbi4gaWYgd2UgdHJ5IHRvIGFzc2lnbiB0aGUKICAgICAgLy8gcmVnaW9uJ3MgYGVsYCB0byBgcGFyZW50RWwuZmluZChzZWxlY3RvcilgIGluIHRoZSBvYmplY3QKICAgICAgLy8gbGl0ZXJhbCB0byBidWlsZCB0aGUgcmVnaW9uLCB0aGUgZWxlbWVudCB3aWxsIG5vdCBiZQogICAgICAvLyBndWFyYW50ZWVkIHRvIGJlIGluIHRoZSBET00gYWxyZWFkeSwgYW5kIHdpbGwgY2F1c2UgcHJvYmxlbXMKICAgICAgaWYgKHJlZ2lvbkNvbmZpZy5wYXJlbnRFbCkgewogICAgICAgIHJlZ2lvbi5nZXRFbCA9IGZ1bmN0aW9uIChlbCkgewogICAgICAgICAgaWYgKF8uaXNPYmplY3QoZWwpKSB7CiAgICAgICAgICAgIHJldHVybiBCYWNrYm9uZS4kKGVsKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJlbnRFbCA9IHJlZ2lvbkNvbmZpZy5wYXJlbnRFbDsKICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24ocGFyZW50RWwpKSB7CiAgICAgICAgICAgIHBhcmVudEVsID0gcGFyZW50RWwoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwYXJlbnRFbC5maW5kKGVsKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiByZWdpb247CiAgICB9LAogICAgLy8gQnVpbGQgdGhlIHJlZ2lvbiBkaXJlY3RseSBmcm9tIGEgZ2l2ZW4gYFJlZ2lvbkNsYXNzYAogICAgX2J1aWxkUmVnaW9uRnJvbVJlZ2lvbkNsYXNzOiBmdW5jdGlvbiAoUmVnaW9uQ2xhc3MpIHsKICAgICAgcmV0dXJuIG5ldyBSZWdpb25DbGFzcygpOwogICAgfQogIH0pOwogIC8vIFJlZ2lvbiBJbnN0YW5jZSBNZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICBfLmV4dGVuZChNYXJpb25ldHRlLlJlZ2lvbi5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgLy8gRGlzcGxheXMgYSBiYWNrYm9uZSB2aWV3IGluc3RhbmNlIGluc2lkZSBvZiB0aGUgcmVnaW9uLgogICAgLy8gSGFuZGxlcyBjYWxsaW5nIHRoZSBgcmVuZGVyYCBtZXRob2QgZm9yIHlvdS4gUmVhZHMgY29udGVudAogICAgLy8gZGlyZWN0bHkgZnJvbSB0aGUgYGVsYCBhdHRyaWJ1dGUuIEFsc28gY2FsbHMgYW4gb3B0aW9uYWwKICAgIC8vIGBvblNob3dgIGFuZCBgb25EZXN0cm95YCBtZXRob2Qgb24geW91ciB2aWV3LCBqdXN0IGFmdGVyIHNob3dpbmcKICAgIC8vIG9yIGp1c3QgYmVmb3JlIGRlc3Ryb3lpbmcgdGhlIHZpZXcsIHJlc3BlY3RpdmVseS4KICAgIC8vIFRoZSBgcHJldmVudERlc3Ryb3lgIG9wdGlvbiBjYW4gYmUgdXNlZCB0byBwcmV2ZW50IGEgdmlldyBmcm9tCiAgICAvLyB0aGUgb2xkIHZpZXcgYmVpbmcgZGVzdHJveWVkIG9uIHNob3cuCiAgICAvLyBUaGUgYGZvcmNlU2hvd2Agb3B0aW9uIGNhbiBiZSB1c2VkIHRvIGZvcmNlIGEgdmlldyB0byBiZQogICAgLy8gcmUtcmVuZGVyZWQgaWYgaXQncyBhbHJlYWR5IHNob3duIGluIHRoZSByZWdpb24uCiAgICBzaG93OiBmdW5jdGlvbiAodmlldywgb3B0aW9ucykgewogICAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICAgIHZhciBzaG93T3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciBpc0RpZmZlcmVudFZpZXcgPSB2aWV3ICE9PSB0aGlzLmN1cnJlbnRWaWV3OwogICAgICB2YXIgcHJldmVudERlc3Ryb3kgPSAhIXNob3dPcHRpb25zLnByZXZlbnREZXN0cm95OwogICAgICB2YXIgZm9yY2VTaG93ID0gISFzaG93T3B0aW9ucy5mb3JjZVNob3c7CiAgICAgIC8vIHdlIGFyZSBvbmx5IGNoYW5naW5nIHRoZSB2aWV3IGlmIHRoZXJlIGlzIGEgdmlldyB0byBjaGFuZ2UgdG8gYmVnaW4gd2l0aAogICAgICB2YXIgaXNDaGFuZ2luZ1ZpZXcgPSAhIXRoaXMuY3VycmVudFZpZXc7CiAgICAgIC8vIG9ubHkgZGVzdHJveSB0aGUgdmlldyBpZiB3ZSBkb24ndCB3YW50IHRvIHByZXZlbnREZXN0cm95IGFuZCB0aGUgdmlldyBpcyBkaWZmZXJlbnQKICAgICAgdmFyIF9zaG91bGREZXN0cm95VmlldyA9ICFwcmV2ZW50RGVzdHJveSAmJiBpc0RpZmZlcmVudFZpZXc7CiAgICAgIC8vIHNob3cgdGhlIHZpZXcgaWYgdGhlIHZpZXcgaXMgZGlmZmVyZW50IG9yIGlmIHlvdSB3YW50IHRvIHJlLXNob3cgdGhlIHZpZXcKICAgICAgdmFyIF9zaG91bGRTaG93VmlldyA9IGlzRGlmZmVyZW50VmlldyB8fCBmb3JjZVNob3c7CiAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgfQogICAgICBpZiAoX3Nob3VsZERlc3Ryb3lWaWV3KSB7CiAgICAgICAgdGhpcy5lbXB0eSgpOwogICAgICB9CiAgICAgIGlmIChfc2hvdWxkU2hvd1ZpZXcpIHsKICAgICAgICAvLyBXZSBuZWVkIHRvIGxpc3RlbiBmb3IgaWYgYSB2aWV3IGlzIGRlc3Ryb3llZAogICAgICAgIC8vIGluIGEgd2F5IG90aGVyIHRoYW4gdGhyb3VnaCB0aGUgcmVnaW9uLgogICAgICAgIC8vIElmIHRoaXMgaGFwcGVucyB3ZSBuZWVkIHRvIHJlbW92ZSB0aGUgcmVmZXJlbmNlCiAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnRWaWV3IHNpbmNlIG9uY2UgYSB2aWV3IGhhcyBiZWVuIGRlc3Ryb3llZAogICAgICAgIC8vIHdlIGNhbiBub3QgcmV1c2UgaXQuCiAgICAgICAgdmlldy5vbmNlKCdkZXN0cm95JywgXy5iaW5kKHRoaXMuZW1wdHksIHRoaXMpKTsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6c3dhcCcsIHZpZXcpOwogICAgICAgIH0KICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzaG93Jywgdmlldyk7CiAgICAgICAgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ2JlZm9yZTpzaG93Jyk7CiAgICAgICAgaWYgKGlzQ2hhbmdpbmdWaWV3KSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hdHRhY2hIdG1sKHZpZXcpOwogICAgICAgIHRoaXMuY3VycmVudFZpZXcgPSB2aWV3OwogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzd2FwJywgdmlldyk7CiAgICAgICAgfQogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnc2hvdycsIHZpZXcpOwogICAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKHZpZXcsICdzaG93Jyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCFfLmlzT2JqZWN0KHRoaXMuZWwpKSB7CiAgICAgICAgdGhpcy4kZWwgPSB0aGlzLmdldEVsKHRoaXMuZWwpOwogICAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuJGVsIHx8IHRoaXMuJGVsLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKCdBbiAiZWwiICcgKyB0aGlzLiRlbC5zZWxlY3RvciArICcgbXVzdCBleGlzdCBpbiBET00nKTsKICAgICAgfQogICAgfSwKICAgIC8vIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNoYW5nZSBob3cgdGhlIHJlZ2lvbiBmaW5kcyB0aGUKICAgIC8vIERPTSBlbGVtZW50IHRoYXQgaXQgbWFuYWdlcy4gUmV0dXJuIGEgalF1ZXJ5IHNlbGVjdG9yIG9iamVjdC4KICAgIGdldEVsOiBmdW5jdGlvbiAoZWwpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLiQoZWwpOwogICAgfSwKICAgIC8vIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNoYW5nZSBob3cgdGhlIG5ldyB2aWV3IGlzCiAgICAvLyBhcHBlbmRlZCB0byB0aGUgYCRlbGAgdGhhdCB0aGUgcmVnaW9uIGlzIG1hbmFnaW5nCiAgICBhdHRhY2hIdG1sOiBmdW5jdGlvbiAodmlldykgewogICAgICAvLyBlbXB0eSB0aGUgbm9kZSBhbmQgYXBwZW5kIG5ldyB2aWV3CiAgICAgIHRoaXMuZWwuaW5uZXJIVE1MID0gJyc7CiAgICAgIHRoaXMuZWwuYXBwZW5kQ2hpbGQodmlldy5lbCk7CiAgICB9LAogICAgLy8gRGVzdHJveSB0aGUgY3VycmVudCB2aWV3LCBpZiB0aGVyZSBpcyBvbmUuIElmIHRoZXJlIGlzIG5vCiAgICAvLyBjdXJyZW50IHZpZXcsIGl0IGRvZXMgbm90aGluZyBhbmQgcmV0dXJucyBpbW1lZGlhdGVseS4KICAgIGVtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB2aWV3ID0gdGhpcy5jdXJyZW50VmlldzsKICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gdmlldyBpbiB0aGUgcmVnaW9uCiAgICAgIC8vIHdlIHNob3VsZCBub3QgcmVtb3ZlIGFueXRoaW5nCiAgICAgIGlmICghdmlldykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTplbXB0eScsIHZpZXcpOwogICAgICB0aGlzLl9kZXN0cm95VmlldygpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2VtcHR5Jywgdmlldyk7CiAgICAgIC8vIFJlbW92ZSByZWdpb24gcG9pbnRlciB0byB0aGUgY3VycmVudFZpZXcKICAgICAgZGVsZXRlIHRoaXMuY3VycmVudFZpZXc7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIGNhbGwgJ2Rlc3Ryb3knIG9yICdyZW1vdmUnLCBkZXBlbmRpbmcgb24gd2hpY2ggaXMgZm91bmQKICAgIC8vIG9uIHRoZSB2aWV3IChpZiBzaG93aW5nIGEgcmF3IEJhY2tib25lIHZpZXcgb3IgYSBNYXJpb25ldHRlIFZpZXcpCiAgICBfZGVzdHJveVZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHZpZXcgPSB0aGlzLmN1cnJlbnRWaWV3OwogICAgICBpZiAodmlldy5kZXN0cm95ICYmICF2aWV3LmlzRGVzdHJveWVkKSB7CiAgICAgICAgdmlldy5kZXN0cm95KCk7CiAgICAgIH0gZWxzZSBpZiAodmlldy5yZW1vdmUpIHsKICAgICAgICB2aWV3LnJlbW92ZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gQXR0YWNoIGFuIGV4aXN0aW5nIHZpZXcgdG8gdGhlIHJlZ2lvbi4gVGhpcwogICAgLy8gd2lsbCBub3QgY2FsbCBgcmVuZGVyYCBvciBgb25TaG93YCBmb3IgdGhlIG5ldyB2aWV3LAogICAgLy8gYW5kIHdpbGwgbm90IHJlcGxhY2UgdGhlIGN1cnJlbnQgSFRNTCBmb3IgdGhlIGBlbGAKICAgIC8vIG9mIHRoZSByZWdpb24uCiAgICBhdHRhY2hWaWV3OiBmdW5jdGlvbiAodmlldykgewogICAgICB0aGlzLmN1cnJlbnRWaWV3ID0gdmlldzsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gQ2hlY2tzIHdoZXRoZXIgYSB2aWV3IGlzIGN1cnJlbnRseSBwcmVzZW50IHdpdGhpbgogICAgLy8gdGhlIHJlZ2lvbi4gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlcmUgaXMgYW5kIGBmYWxzZWAgaWYKICAgIC8vIG5vIHZpZXcgaXMgcHJlc2VudC4KICAgIGhhc1ZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICEhdGhpcy5jdXJyZW50VmlldzsKICAgIH0sCiAgICAvLyBSZXNldCB0aGUgcmVnaW9uIGJ5IGRlc3Ryb3lpbmcgYW55IGV4aXN0aW5nIHZpZXcgYW5kCiAgICAvLyBjbGVhcmluZyBvdXQgdGhlIGNhY2hlZCBgJGVsYC4gVGhlIG5leHQgdGltZSBhIHZpZXcKICAgIC8vIGlzIHNob3duIHZpYSB0aGlzIHJlZ2lvbiwgdGhlIHJlZ2lvbiB3aWxsIHJlLXF1ZXJ5IHRoZQogICAgLy8gRE9NIGZvciB0aGUgcmVnaW9uJ3MgYGVsYC4KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZW1wdHkoKTsKICAgICAgaWYgKHRoaXMuJGVsKSB7CiAgICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsLnNlbGVjdG9yOwogICAgICB9CiAgICAgIGRlbGV0ZSB0aGlzLiRlbDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gUHJveHkgYGdldE9wdGlvbmAgdG8gZW5hYmxlIGdldHRpbmcgb3B0aW9ucyBmcm9tIHRoaXMgb3IgdGhpcy5vcHRpb25zIGJ5IG5hbWUuCiAgICBnZXRPcHRpb246IE1hcmlvbmV0dGUucHJveHlHZXRPcHRpb24sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZAogIH0pOwogIC8vIENvcHkgdGhlIGBleHRlbmRgIGZ1bmN0aW9uIHVzZWQgYnkgQmFja2JvbmUncyBjbGFzc2VzCiAgTWFyaW9uZXR0ZS5SZWdpb24uZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgLy8gTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBNYW5hZ2Ugb25lIG9yIG1vcmUgcmVsYXRlZCBgTWFyaW9uZXR0ZS5SZWdpb25gIG9iamVjdHMuCiAgTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUpIHsKICAgIHZhciBSZWdpb25NYW5hZ2VyID0gTWFyaW9uZXR0ZS5Db250cm9sbGVyLmV4dGVuZCh7CiAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgIHRoaXMuX3JlZ2lvbnMgPSB7fTsKICAgICAgICBNYXJpb25ldHRlLkNvbnRyb2xsZXIuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgICAgfSwKICAgICAgLy8gQWRkIG11bHRpcGxlIHJlZ2lvbnMgdXNpbmcgYW4gb2JqZWN0IGxpdGVyYWwgb3IgYQogICAgICAvLyBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0IGxpdGVyYWwsIHdoZXJlCiAgICAgIC8vIGVhY2gga2V5IGJlY29tZXMgdGhlIHJlZ2lvbiBuYW1lLCBhbmQgZWFjaCB2YWx1ZSBpcwogICAgICAvLyB0aGUgcmVnaW9uIGRlZmluaXRpb24uCiAgICAgIGFkZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25EZWZpbml0aW9ucywgZGVmYXVsdHMpIHsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbkRlZmluaXRpb25zKSkgewogICAgICAgICAgcmVnaW9uRGVmaW5pdGlvbnMgPSByZWdpb25EZWZpbml0aW9ucy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICB2YXIgcmVnaW9ucyA9IHt9OwogICAgICAgIF8uZWFjaChyZWdpb25EZWZpbml0aW9ucywgZnVuY3Rpb24gKGRlZmluaXRpb24sIG5hbWUpIHsKICAgICAgICAgIGlmIChfLmlzU3RyaW5nKGRlZmluaXRpb24pKSB7CiAgICAgICAgICAgIGRlZmluaXRpb24gPSB7IHNlbGVjdG9yOiBkZWZpbml0aW9uIH07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5pdGlvbi5zZWxlY3RvcikgewogICAgICAgICAgICBkZWZpbml0aW9uID0gXy5kZWZhdWx0cyh7fSwgZGVmaW5pdGlvbiwgZGVmYXVsdHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuYWRkUmVnaW9uKG5hbWUsIGRlZmluaXRpb24pOwogICAgICAgICAgcmVnaW9uc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB9LCB0aGlzKTsKICAgICAgICByZXR1cm4gcmVnaW9uczsKICAgICAgfSwKICAgICAgLy8gQWRkIGFuIGluZGl2aWR1YWwgcmVnaW9uIHRvIHRoZSByZWdpb24gbWFuYWdlciwKICAgICAgLy8gYW5kIHJldHVybiB0aGUgcmVnaW9uIGluc3RhbmNlCiAgICAgIGFkZFJlZ2lvbjogZnVuY3Rpb24gKG5hbWUsIGRlZmluaXRpb24pIHsKICAgICAgICB2YXIgcmVnaW9uOwogICAgICAgIGlmIChkZWZpbml0aW9uIGluc3RhbmNlb2YgTWFyaW9uZXR0ZS5SZWdpb24pIHsKICAgICAgICAgIHJlZ2lvbiA9IGRlZmluaXRpb247CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlZ2lvbiA9IE1hcmlvbmV0dGUuUmVnaW9uLmJ1aWxkUmVnaW9uKGRlZmluaXRpb24sIE1hcmlvbmV0dGUuUmVnaW9uKTsKICAgICAgICB9CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6YWRkOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgdGhpcy5fc3RvcmUobmFtZSwgcmVnaW9uKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICAgIHJldHVybiByZWdpb247CiAgICAgIH0sCiAgICAgIC8vIEdldCBhIHJlZ2lvbiBieSBuYW1lCiAgICAgIGdldDogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgfSwKICAgICAgLy8gR2V0cyBhbGwgdGhlIHJlZ2lvbnMgY29udGFpbmVkIHdpdGhpbgogICAgICAvLyB0aGUgYHJlZ2lvbk1hbmFnZXJgIGluc3RhbmNlLgogICAgICBnZXRSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcmVnaW9ucyk7CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhIHJlZ2lvbiBieSBuYW1lCiAgICAgIHJlbW92ZVJlZ2lvbjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgcmVnaW9uID0gdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgICB0aGlzLl9yZW1vdmUobmFtZSwgcmVnaW9uKTsKICAgICAgICByZXR1cm4gcmVnaW9uOwogICAgICB9LAogICAgICAvLyBFbXB0eSBhbGwgcmVnaW9ucyBpbiB0aGUgcmVnaW9uIG1hbmFnZXIsIGFuZAogICAgICAvLyByZW1vdmUgdGhlbQogICAgICByZW1vdmVSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldFJlZ2lvbnMoKTsKICAgICAgICBfLmVhY2godGhpcy5fcmVnaW9ucywgZnVuY3Rpb24gKHJlZ2lvbiwgbmFtZSkgewogICAgICAgICAgdGhpcy5fcmVtb3ZlKG5hbWUsIHJlZ2lvbik7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHJlZ2lvbnM7CiAgICAgIH0sCiAgICAgIC8vIEVtcHR5IGFsbCByZWdpb25zIGluIHRoZSByZWdpb24gbWFuYWdlciwgYnV0CiAgICAgIC8vIGxlYXZlIHRoZW0gYXR0YWNoZWQKICAgICAgZW1wdHlSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldFJlZ2lvbnMoKTsKICAgICAgICBfLmVhY2gocmVnaW9ucywgZnVuY3Rpb24gKHJlZ2lvbikgewogICAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHJlZ2lvbnM7CiAgICAgIH0sCiAgICAgIC8vIERlc3Ryb3kgYWxsIHJlZ2lvbnMgYW5kIHNodXQgZG93biB0aGUgcmVnaW9uCiAgICAgIC8vIG1hbmFnZXIgZW50aXJlbHkKICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMucmVtb3ZlUmVnaW9ucygpOwogICAgICAgIHJldHVybiBNYXJpb25ldHRlLkNvbnRyb2xsZXIucHJvdG90eXBlLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSwKICAgICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIHN0b3JlIHJlZ2lvbnMKICAgICAgX3N0b3JlOiBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpcy5fcmVnaW9uc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoKTsKICAgICAgfSwKICAgICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIHJlbW92ZSBhIHJlZ2lvbgogICAgICBfcmVtb3ZlOiBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgcmVnaW9uLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICBkZWxldGUgdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbW92ZTpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9LAogICAgICAvLyBzZXQgdGhlIG51bWJlciBvZiByZWdpb25zIGN1cnJlbnQgaGVsZAogICAgICBfc2V0TGVuZ3RoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5sZW5ndGggPSBfLnNpemUodGhpcy5fcmVnaW9ucyk7CiAgICAgIH0KICAgIH0pOwogICAgTWFyaW9uZXR0ZS5hY3RBc0NvbGxlY3Rpb24oUmVnaW9uTWFuYWdlci5wcm90b3R5cGUsICdfcmVnaW9ucycpOwogICAgcmV0dXJuIFJlZ2lvbk1hbmFnZXI7CiAgfShNYXJpb25ldHRlKTsKICAvLyBUZW1wbGF0ZSBDYWNoZQogIC8vIC0tLS0tLS0tLS0tLS0tCiAgLy8gTWFuYWdlIHRlbXBsYXRlcyBzdG9yZWQgaW4gYDxzY3JpcHQ+YCBibG9ja3MsCiAgLy8gY2FjaGluZyB0aGVtIGZvciBmYXN0ZXIgYWNjZXNzLgogIE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZUlkKSB7CiAgICB0aGlzLnRlbXBsYXRlSWQgPSB0ZW1wbGF0ZUlkOwogIH07CiAgLy8gVGVtcGxhdGVDYWNoZSBvYmplY3QtbGV2ZWwgbWV0aG9kcy4gTWFuYWdlIHRoZSB0ZW1wbGF0ZQogIC8vIGNhY2hlcyBmcm9tIHRoZXNlIG1ldGhvZCBjYWxscyBpbnN0ZWFkIG9mIGNyZWF0aW5nCiAgLy8geW91ciBvd24gVGVtcGxhdGVDYWNoZSBpbnN0YW5jZXMKICBfLmV4dGVuZChNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUsIHsKICAgIHRlbXBsYXRlQ2FjaGVzOiB7fSwKICAgIC8vIEdldCB0aGUgc3BlY2lmaWVkIHRlbXBsYXRlIGJ5IGlkLiBFaXRoZXIKICAgIC8vIHJldHJpZXZlcyB0aGUgY2FjaGVkIHZlcnNpb24sIG9yIGxvYWRzIGl0CiAgICAvLyBmcm9tIHRoZSBET00uCiAgICBnZXQ6IGZ1bmN0aW9uICh0ZW1wbGF0ZUlkKSB7CiAgICAgIHZhciBjYWNoZWRUZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGVDYWNoZXNbdGVtcGxhdGVJZF07CiAgICAgIGlmICghY2FjaGVkVGVtcGxhdGUpIHsKICAgICAgICBjYWNoZWRUZW1wbGF0ZSA9IG5ldyBNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUodGVtcGxhdGVJZCk7CiAgICAgICAgdGhpcy50ZW1wbGF0ZUNhY2hlc1t0ZW1wbGF0ZUlkXSA9IGNhY2hlZFRlbXBsYXRlOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZWRUZW1wbGF0ZS5sb2FkKCk7CiAgICB9LAogICAgLy8gQ2xlYXIgdGVtcGxhdGVzIGZyb20gdGhlIGNhY2hlLiBJZiBubyBhcmd1bWVudHMKICAgIC8vIGFyZSBzcGVjaWZpZWQsIGNsZWFycyBhbGwgdGVtcGxhdGVzOgogICAgLy8gYGNsZWFyKClgCiAgICAvLwogICAgLy8gSWYgYXJndW1lbnRzIGFyZSBzcGVjaWZpZWQsIGNsZWFycyBlYWNoIG9mIHRoZQogICAgLy8gc3BlY2lmaWVkIHRlbXBsYXRlcyBmcm9tIHRoZSBjYWNoZToKICAgIC8vIGBjbGVhcigiI3QxIiwgIiN0MiIsICIuLi4iKWAKICAgIGNsZWFyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBpOwogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgdmFyIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgZGVsZXRlIHRoaXMudGVtcGxhdGVDYWNoZXNbYXJnc1tpXV07CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudGVtcGxhdGVDYWNoZXMgPSB7fTsKICAgICAgfQogICAgfQogIH0pOwogIC8vIFRlbXBsYXRlQ2FjaGUgaW5zdGFuY2UgbWV0aG9kcywgYWxsb3dpbmcgZWFjaAogIC8vIHRlbXBsYXRlIGNhY2hlIG9iamVjdCB0byBtYW5hZ2UgaXRzIG93biBzdGF0ZQogIC8vIGFuZCBrbm93IHdoZXRoZXIgb3Igbm90IGl0IGhhcyBiZWVuIGxvYWRlZAogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZS5wcm90b3R5cGUsIHsKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBsb2FkIHRoZSB0ZW1wbGF0ZQogICAgbG9hZDogZnVuY3Rpb24gKCkgewogICAgICAvLyBHdWFyZCBjbGF1c2UgdG8gcHJldmVudCBsb2FkaW5nIHRoaXMgdGVtcGxhdGUgbW9yZSB0aGFuIG9uY2UKICAgICAgaWYgKHRoaXMuY29tcGlsZWRUZW1wbGF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVkVGVtcGxhdGU7CiAgICAgIH0KICAgICAgLy8gTG9hZCB0aGUgdGVtcGxhdGUgYW5kIGNvbXBpbGUgaXQKICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy5sb2FkVGVtcGxhdGUodGhpcy50ZW1wbGF0ZUlkKTsKICAgICAgdGhpcy5jb21waWxlZFRlbXBsYXRlID0gdGhpcy5jb21waWxlVGVtcGxhdGUodGVtcGxhdGUpOwogICAgICByZXR1cm4gdGhpcy5jb21waWxlZFRlbXBsYXRlOwogICAgfSwKICAgIC8vIExvYWQgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBET00sIGJ5IGRlZmF1bHQuIE92ZXJyaWRlCiAgICAvLyB0aGlzIG1ldGhvZCB0byBwcm92aWRlIHlvdXIgb3duIHRlbXBsYXRlIHJldHJpZXZhbAogICAgLy8gRm9yIGFzeW5jaHJvbm91cyBsb2FkaW5nIHdpdGggQU1EL1JlcXVpcmVKUywgY29uc2lkZXIKICAgIC8vIHVzaW5nIGEgdGVtcGxhdGUtbG9hZGVyIHBsdWdpbiBhcyBkZXNjcmliZWQgaGVyZToKICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXJpb25ldHRlanMvYmFja2JvbmUubWFyaW9uZXR0ZS93aWtpL1VzaW5nLW1hcmlvbmV0dGUtd2l0aC1yZXF1aXJlanMKICAgIGxvYWRUZW1wbGF0ZTogZnVuY3Rpb24gKHRlbXBsYXRlSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlID0gQmFja2JvbmUuJCh0ZW1wbGF0ZUlkKS5odG1sKCk7CiAgICAgIGlmICghdGVtcGxhdGUgfHwgdGVtcGxhdGUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ05vVGVtcGxhdGVFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ291bGQgbm90IGZpbmQgdGVtcGxhdGU6ICInICsgdGVtcGxhdGVJZCArICciJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0sCiAgICAvLyBQcmUtY29tcGlsZSB0aGUgdGVtcGxhdGUgYmVmb3JlIGNhY2hpbmcgaXQuIE92ZXJyaWRlCiAgICAvLyB0aGlzIG1ldGhvZCBpZiB5b3UgZG8gbm90IG5lZWQgdG8gcHJlLWNvbXBpbGUgYSB0ZW1wbGF0ZQogICAgLy8gKEpTVCAvIFJlcXVpcmVKUyBmb3IgZXhhbXBsZSkgb3IgaWYgeW91IHdhbnQgdG8gY2hhbmdlCiAgICAvLyB0aGUgdGVtcGxhdGUgZW5naW5lIHVzZWQgKEhhbmRlYmFycywgZXRjKS4KICAgIGNvbXBpbGVUZW1wbGF0ZTogZnVuY3Rpb24gKHJhd1RlbXBsYXRlKSB7CiAgICAgIHJldHVybiBfLnRlbXBsYXRlKHJhd1RlbXBsYXRlKTsKICAgIH0KICB9KTsKICAvLyBSZW5kZXJlcgogIC8vIC0tLS0tLS0tCiAgLy8gUmVuZGVyIGEgdGVtcGxhdGUgd2l0aCBkYXRhIGJ5IHBhc3NpbmcgaW4gdGhlIHRlbXBsYXRlCiAgLy8gc2VsZWN0b3IgYW5kIHRoZSBkYXRhIHRvIHJlbmRlci4KICBNYXJpb25ldHRlLlJlbmRlcmVyID0gewogICAgLy8gUmVuZGVyIGEgdGVtcGxhdGUgd2l0aCBkYXRhLiBUaGUgYHRlbXBsYXRlYCBwYXJhbWV0ZXIgaXMKICAgIC8vIHBhc3NlZCB0byB0aGUgYFRlbXBsYXRlQ2FjaGVgIG9iamVjdCB0byByZXRyaWV2ZSB0aGUKICAgIC8vIHRlbXBsYXRlIGZ1bmN0aW9uLiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcm92aWRlIHlvdXIgb3duCiAgICAvLyBjdXN0b20gcmVuZGVyaW5nIGFuZCB0ZW1wbGF0ZSBoYW5kbGluZyBmb3IgYWxsIG9mIE1hcmlvbmV0dGUuCiAgICByZW5kZXI6IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgZGF0YSkgewogICAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ1RlbXBsYXRlTm90Rm91bmRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IHJlbmRlciB0aGUgdGVtcGxhdGUgc2luY2UgaXRzIGZhbHNlLCBudWxsIG9yIHVuZGVmaW5lZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdmFyIHRlbXBsYXRlRnVuYzsKICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IHRlbXBsYXRlOwogICAgICB9IGVsc2UgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZS5nZXQodGVtcGxhdGUpOwogICAgICB9CiAgICAgIHJldHVybiB0ZW1wbGF0ZUZ1bmMoZGF0YSk7CiAgICB9CiAgfTsKICAvKiBqc2hpbnQgbWF4bGVuOiAxMTQsIG5vbmV3OiBmYWxzZSAqLwogIC8vIE1hcmlvbmV0dGUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0tLQogIC8vIFRoZSBjb3JlIHZpZXcgY2xhc3MgdGhhdCBvdGhlciBNYXJpb25ldHRlIHZpZXdzIGV4dGVuZCBmcm9tLgogIE1hcmlvbmV0dGUuVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBfLmJpbmRBbGwodGhpcywgJ3JlbmRlcicpOwogICAgICAvLyB0aGlzIGV4cG9zZXMgdmlldyBvcHRpb25zIHRvIHRoZSB2aWV3IGluaXRpYWxpemVyCiAgICAgIC8vIHRoaXMgaXMgYSBiYWNrZmlsbCBzaW5jZSBiYWNrYm9uZSByZW1vdmVkIHRoZSBhc3NpZ25tZW50CiAgICAgIC8vIG9mIHRoaXMub3B0aW9ucwogICAgICAvLyBhdCBzb21lIHBvaW50IGhvd2V2ZXIgdGhpcyBtYXkgYmUgcmVtb3ZlZAogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgXy5pc0Z1bmN0aW9uKG9wdGlvbnMpID8gb3B0aW9ucy5jYWxsKHRoaXMpIDogb3B0aW9ucyk7CiAgICAgIHRoaXMuX2JlaGF2aW9ycyA9IE1hcmlvbmV0dGUuQmVoYXZpb3JzKHRoaXMpOwogICAgICBCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIE1hcmlvbmV0dGUuTW9uaXRvckRPTVJlZnJlc2godGhpcyk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcywgJ3Nob3cnLCB0aGlzLm9uU2hvd0NhbGxlZCk7CiAgICB9LAogICAgLy8gR2V0IHRoZSB0ZW1wbGF0ZSBmb3IgdGhpcyB2aWV3CiAgICAvLyBpbnN0YW5jZS4gWW91IGNhbiBzZXQgYSBgdGVtcGxhdGVgIGF0dHJpYnV0ZSBpbiB0aGUgdmlldwogICAgLy8gZGVmaW5pdGlvbiBvciBwYXNzIGEgYHRlbXBsYXRlOiAid2hhdGV2ZXIiYCBwYXJhbWV0ZXIgaW4KICAgIC8vIHRvIHRoZSBjb25zdHJ1Y3RvciBvcHRpb25zLgogICAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uKCd0ZW1wbGF0ZScpOwogICAgfSwKICAgIC8vIFNlcmlhbGl6ZSBhIG1vZGVsIGJ5IHJldHVybmluZyBpdHMgYXR0cmlidXRlcy4gQ2xvbmVzCiAgICAvLyB0aGUgYXR0cmlidXRlcyB0byBhbGxvdyBtb2RpZmljYXRpb24uCiAgICBzZXJpYWxpemVNb2RlbDogZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgIHJldHVybiBtb2RlbC50b0pTT04uYXBwbHkobW9kZWwsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB9LAogICAgLy8gTWl4IGluIHRlbXBsYXRlIGhlbHBlciBtZXRob2RzLiBMb29rcyBmb3IgYQogICAgLy8gYHRlbXBsYXRlSGVscGVyc2AgYXR0cmlidXRlLCB3aGljaCBjYW4gZWl0aGVyIGJlIGFuCiAgICAvLyBvYmplY3QgbGl0ZXJhbCwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0CiAgICAvLyBsaXRlcmFsLiBBbGwgbWV0aG9kcyBhbmQgYXR0cmlidXRlcyBmcm9tIHRoaXMgb2JqZWN0CiAgICAvLyBhcmUgY29waWVzIHRvIHRoZSBvYmplY3QgcGFzc2VkIGluLgogICAgbWl4aW5UZW1wbGF0ZUhlbHBlcnM6IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgICAgdGFyZ2V0ID0gdGFyZ2V0IHx8IHt9OwogICAgICB2YXIgdGVtcGxhdGVIZWxwZXJzID0gdGhpcy5nZXRPcHRpb24oJ3RlbXBsYXRlSGVscGVycycpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRlbXBsYXRlSGVscGVycykpIHsKICAgICAgICB0ZW1wbGF0ZUhlbHBlcnMgPSB0ZW1wbGF0ZUhlbHBlcnMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gXy5leHRlbmQodGFyZ2V0LCB0ZW1wbGF0ZUhlbHBlcnMpOwogICAgfSwKICAgIC8vIG5vcm1hbGl6ZSB0aGUga2V5cyBvZiBwYXNzZWQgaGFzaCB3aXRoIHRoZSB2aWV3cyBgdWlgIHNlbGVjdG9ycy4KICAgIC8vIGB7IkB1aS5mb28iOiAiYmFyIn1gCiAgICBub3JtYWxpemVVSUtleXM6IGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgIHZhciB1aSA9IF8ucmVzdWx0KHRoaXMsICd1aScpOwogICAgICB2YXIgdWlCaW5kaW5ncyA9IF8ucmVzdWx0KHRoaXMsICdfdWlCaW5kaW5ncycpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSUtleXMoaGFzaCwgdWlCaW5kaW5ncyB8fCB1aSk7CiAgICB9LAogICAgLy8gbm9ybWFsaXplIHRoZSB2YWx1ZXMgb2YgcGFzc2VkIGhhc2ggd2l0aCB0aGUgdmlld3MgYHVpYCBzZWxlY3RvcnMuCiAgICAvLyBge2ZvbzogIkB1aS5iYXIifWAKICAgIG5vcm1hbGl6ZVVJVmFsdWVzOiBmdW5jdGlvbiAoaGFzaCkgewogICAgICB2YXIgdWkgPSBfLnJlc3VsdCh0aGlzLCAndWknKTsKICAgICAgdmFyIHVpQmluZGluZ3MgPSBfLnJlc3VsdCh0aGlzLCAnX3VpQmluZGluZ3MnKTsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUubm9ybWFsaXplVUlWYWx1ZXMoaGFzaCwgdWlCaW5kaW5ncyB8fCB1aSk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlIGB0cmlnZ2Vyc2AgdG8gZm9yd2FyZCBET00gZXZlbnRzIHRvIHZpZXcKICAgIC8vIGV2ZW50cy4gYHRyaWdnZXJzOiB7ImNsaWNrIC5mb28iOiAiZG86Zm9vIn1gCiAgICBjb25maWd1cmVUcmlnZ2VyczogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudHJpZ2dlcnMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHRyaWdnZXJFdmVudHMgPSB7fTsKICAgICAgLy8gQWxsb3cgYHRyaWdnZXJzYCB0byBiZSBjb25maWd1cmVkIGFzIGEgZnVuY3Rpb24KICAgICAgdmFyIHRyaWdnZXJzID0gdGhpcy5ub3JtYWxpemVVSUtleXMoXy5yZXN1bHQodGhpcywgJ3RyaWdnZXJzJykpOwogICAgICAvLyBDb25maWd1cmUgdGhlIHRyaWdnZXJzLCBwcmV2ZW50IGRlZmF1bHQKICAgICAgLy8gYWN0aW9uIGFuZCBzdG9wIHByb3BhZ2F0aW9uIG9mIERPTSBldmVudHMKICAgICAgXy5lYWNoKHRyaWdnZXJzLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHRyaWdnZXJFdmVudHNba2V5XSA9IHRoaXMuX2J1aWxkVmlld1RyaWdnZXIodmFsdWUpOwogICAgICB9LCB0aGlzKTsKICAgICAgcmV0dXJuIHRyaWdnZXJFdmVudHM7CiAgICB9LAogICAgLy8gT3ZlcnJpZGluZyBCYWNrYm9uZS5WaWV3J3MgZGVsZWdhdGVFdmVudHMgdG8gaGFuZGxlCiAgICAvLyB0aGUgYHRyaWdnZXJzYCwgYG1vZGVsRXZlbnRzYCwgYW5kIGBjb2xsZWN0aW9uRXZlbnRzYCBjb25maWd1cmF0aW9uCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24gKGV2ZW50cykgewogICAgICB0aGlzLl9kZWxlZ2F0ZURPTUV2ZW50cyhldmVudHMpOwogICAgICB0aGlzLmJpbmRFbnRpdHlFdmVudHModGhpcy5tb2RlbCwgdGhpcy5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICB0aGlzLmJpbmRFbnRpdHlFdmVudHModGhpcy5jb2xsZWN0aW9uLCB0aGlzLmdldE9wdGlvbignY29sbGVjdGlvbkV2ZW50cycpKTsKICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgZnVuY3Rpb24gKGJlaGF2aW9yKSB7CiAgICAgICAgYmVoYXZpb3IuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCBiZWhhdmlvci5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICAgIGJlaGF2aW9yLmJpbmRFbnRpdHlFdmVudHModGhpcy5jb2xsZWN0aW9uLCBiZWhhdmlvci5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgICAgIH0sIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBpbnRlcm5hbCBtZXRob2QgdG8gZGVsZWdhdGUgRE9NIGV2ZW50cyBhbmQgdHJpZ2dlcnMKICAgIF9kZWxlZ2F0ZURPTUV2ZW50czogZnVuY3Rpb24gKGV2ZW50c0FyZykgewogICAgICB2YXIgZXZlbnRzID0gZXZlbnRzQXJnIHx8IHRoaXMuZXZlbnRzOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGV2ZW50cykpIHsKICAgICAgICBldmVudHMgPSBldmVudHMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICAvLyBub3JtYWxpemUgdWkga2V5cwogICAgICBldmVudHMgPSB0aGlzLm5vcm1hbGl6ZVVJS2V5cyhldmVudHMpOwogICAgICBpZiAoXy5pc1VuZGVmaW5lZChldmVudHNBcmcpKSB7CiAgICAgICAgdGhpcy5ldmVudHMgPSBldmVudHM7CiAgICAgIH0KICAgICAgdmFyIGNvbWJpbmVkRXZlbnRzID0ge307CiAgICAgIC8vIGxvb2sgdXAgaWYgdGhpcyB2aWV3IGhhcyBiZWhhdmlvciBldmVudHMKICAgICAgdmFyIGJlaGF2aW9yRXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2JlaGF2aW9yRXZlbnRzJykgfHwge307CiAgICAgIHZhciB0cmlnZ2VycyA9IHRoaXMuY29uZmlndXJlVHJpZ2dlcnMoKTsKICAgICAgdmFyIGJlaGF2aW9yVHJpZ2dlcnMgPSBfLnJlc3VsdCh0aGlzLCAnYmVoYXZpb3JUcmlnZ2VycycpIHx8IHt9OwogICAgICAvLyBiZWhhdmlvciBldmVudHMgd2lsbCBiZSBvdmVycmlkZW4gYnkgdmlldyBldmVudHMgYW5kIG9yIHRyaWdnZXJzCiAgICAgIF8uZXh0ZW5kKGNvbWJpbmVkRXZlbnRzLCBiZWhhdmlvckV2ZW50cywgZXZlbnRzLCB0cmlnZ2VycywgYmVoYXZpb3JUcmlnZ2Vycyk7CiAgICAgIEJhY2tib25lLlZpZXcucHJvdG90eXBlLmRlbGVnYXRlRXZlbnRzLmNhbGwodGhpcywgY29tYmluZWRFdmVudHMpOwogICAgfSwKICAgIC8vIE92ZXJyaWRpbmcgQmFja2JvbmUuVmlldydzIHVuZGVsZWdhdGVFdmVudHMgdG8gaGFuZGxlIHVuYmluZGluZwogICAgLy8gdGhlIGB0cmlnZ2Vyc2AsIGBtb2RlbEV2ZW50c2AsIGFuZCBgY29sbGVjdGlvbkV2ZW50c2AgY29uZmlnCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS51bmRlbGVnYXRlRXZlbnRzLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB0aGlzLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCB0aGlzLmdldE9wdGlvbignbW9kZWxFdmVudHMnKSk7CiAgICAgIHRoaXMudW5iaW5kRW50aXR5RXZlbnRzKHRoaXMuY29sbGVjdGlvbiwgdGhpcy5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgICAgIF8uZWFjaCh0aGlzLl9iZWhhdmlvcnMsIGZ1bmN0aW9uIChiZWhhdmlvcikgewogICAgICAgIGJlaGF2aW9yLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCBiZWhhdmlvci5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICAgIGJlaGF2aW9yLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLmNvbGxlY3Rpb24sIGJlaGF2aW9yLmdldE9wdGlvbignY29sbGVjdGlvbkV2ZW50cycpKTsKICAgICAgfSwgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCwgaGFuZGxlcyB0aGUgYHNob3dgIGV2ZW50LgogICAgb25TaG93Q2FsbGVkOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgaGVscGVyIG1ldGhvZCB0byB2ZXJpZnkgd2hldGhlciB0aGUgdmlldyBoYXNuJ3QgYmVlbiBkZXN0cm95ZWQKICAgIF9lbnN1cmVWaWV3SXNJbnRhY3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnVmlld0Rlc3Ryb3llZEVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdWaWV3IChjaWQ6ICInICsgdGhpcy5jaWQgKyAnIikgaGFzIGFscmVhZHkgYmVlbiBkZXN0cm95ZWQgYW5kIGNhbm5vdCBiZSB1c2VkLicKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIC8vIERlZmF1bHQgYGRlc3Ryb3lgIGltcGxlbWVudGF0aW9uLCBmb3IgcmVtb3ZpbmcgYSB2aWV3IGZyb20gdGhlCiAgICAvLyBET00gYW5kIHVuYmluZGluZyBpdC4gUmVnaW9ucyB3aWxsIGNhbGwgdGhpcyBtZXRob2QKICAgIC8vIGZvciB5b3UuIFlvdSBjYW4gc3BlY2lmeSBhbiBgb25EZXN0cm95YCBtZXRob2QgaW4geW91ciB2aWV3IHRvCiAgICAvLyBhZGQgY3VzdG9tIGNvZGUgdGhhdCBpcyBjYWxsZWQgYWZ0ZXIgdGhlIHZpZXcgaXMgZGVzdHJveWVkLgogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5pc0Rlc3Ryb3llZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kLmFwcGx5KHRoaXMsIFsnYmVmb3JlOmRlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICAvLyBtYXJrIGFzIGRlc3Ryb3llZCBiZWZvcmUgZG9pbmcgdGhlIGFjdHVhbCBkZXN0cm95LCB0bwogICAgICAvLyBwcmV2ZW50IGluZmluaXRlIGxvb3BzIHdpdGhpbiAiZGVzdHJveSIgZXZlbnQgaGFuZGxlcnMKICAgICAgLy8gdGhhdCBhcmUgdHJ5aW5nIHRvIGRlc3Ryb3kgb3RoZXIgdmlld3MKICAgICAgdGhpcy5pc0Rlc3Ryb3llZCA9IHRydWU7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2Rlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICAvLyB1bmJpbmQgVUkgZWxlbWVudHMKICAgICAgdGhpcy51bmJpbmRVSUVsZW1lbnRzKCk7CiAgICAgIC8vIHJlbW92ZSB0aGUgdmlldyBmcm9tIHRoZSBET00KICAgICAgdGhpcy5yZW1vdmUoKTsKICAgICAgLy8gQ2FsbCBkZXN0cm95IG9uIGVhY2ggYmVoYXZpb3IgYWZ0ZXIKICAgICAgLy8gZGVzdHJveWluZyB0aGUgdmlldy4KICAgICAgLy8gVGhpcyB1bmJpbmRzIGV2ZW50IGxpc3RlbmVycwogICAgICAvLyB0aGF0IGJlaGF2aW9ycyBoYXZlIHJlZ2lzdGVyZCBmb3IuCiAgICAgIF8uaW52b2tlKHRoaXMuX2JlaGF2aW9ycywgJ2Rlc3Ryb3knLCBhcmdzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgYmluZFVJRWxlbWVudHM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fYmluZFVJRWxlbWVudHMoKTsKICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCB0aGlzLl9iaW5kVUlFbGVtZW50cyk7CiAgICB9LAogICAgLy8gVGhpcyBtZXRob2QgYmluZHMgdGhlIGVsZW1lbnRzIHNwZWNpZmllZCBpbiB0aGUgInVpIiBoYXNoIGluc2lkZSB0aGUgdmlldydzIGNvZGUgd2l0aAogICAgLy8gdGhlIGFzc29jaWF0ZWQgalF1ZXJ5IHNlbGVjdG9ycy4KICAgIF9iaW5kVUlFbGVtZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudWkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gc3RvcmUgdGhlIHVpIGhhc2ggaW4gX3VpQmluZGluZ3Mgc28gdGhleSBjYW4gYmUgcmVzZXQgbGF0ZXIKICAgICAgLy8gYW5kIHNvIHJlLXJlbmRlcmluZyB0aGUgdmlldyB3aWxsIGJlIGFibGUgdG8gZmluZCB0aGUgYmluZGluZ3MKICAgICAgaWYgKCF0aGlzLl91aUJpbmRpbmdzKSB7CiAgICAgICAgdGhpcy5fdWlCaW5kaW5ncyA9IHRoaXMudWk7CiAgICAgIH0KICAgICAgLy8gZ2V0IHRoZSBiaW5kaW5ncyByZXN1bHQsIGFzIGEgZnVuY3Rpb24gb3Igb3RoZXJ3aXNlCiAgICAgIHZhciBiaW5kaW5ncyA9IF8ucmVzdWx0KHRoaXMsICdfdWlCaW5kaW5ncycpOwogICAgICAvLyBlbXB0eSB0aGUgdWkgc28gd2UgZG9uJ3QgaGF2ZSBhbnl0aGluZyB0byBzdGFydCB3aXRoCiAgICAgIHRoaXMudWkgPSB7fTsKICAgICAgLy8gYmluZCBlYWNoIG9mIHRoZSBzZWxlY3RvcnMKICAgICAgXy5lYWNoKF8ua2V5cyhiaW5kaW5ncyksIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgc2VsZWN0b3IgPSBiaW5kaW5nc1trZXldOwogICAgICAgIHRoaXMudWlba2V5XSA9IHRoaXMuJChzZWxlY3Rvcik7CiAgICAgIH0sIHRoaXMpOwogICAgfSwKICAgIC8vIFRoaXMgbWV0aG9kIHVuYmluZHMgdGhlIGVsZW1lbnRzIHNwZWNpZmllZCBpbiB0aGUgInVpIiBoYXNoCiAgICB1bmJpbmRVSUVsZW1lbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3VuYmluZFVJRWxlbWVudHMoKTsKICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCB0aGlzLl91bmJpbmRVSUVsZW1lbnRzKTsKICAgIH0sCiAgICBfdW5iaW5kVUlFbGVtZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudWkgfHwgIXRoaXMuX3VpQmluZGluZ3MpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gZGVsZXRlIGFsbCBvZiB0aGUgZXhpc3RpbmcgdWkgYmluZGluZ3MKICAgICAgXy5lYWNoKHRoaXMudWksIGZ1bmN0aW9uICgkZWwsIG5hbWUpIHsKICAgICAgICBkZWxldGUgdGhpcy51aVtuYW1lXTsKICAgICAgfSwgdGhpcyk7CiAgICAgIC8vIHJlc2V0IHRoZSB1aSBlbGVtZW50IHRvIHRoZSBvcmlnaW5hbCBiaW5kaW5ncyBjb25maWd1cmF0aW9uCiAgICAgIHRoaXMudWkgPSB0aGlzLl91aUJpbmRpbmdzOwogICAgICBkZWxldGUgdGhpcy5fdWlCaW5kaW5nczsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGFuIGV2ZW50IGhhbmRsZXIgZm9yIGEgZ2l2ZW4gYHRyaWdnZXJEZWZgIGxpa2UKICAgIC8vICdjbGljazpmb28nCiAgICBfYnVpbGRWaWV3VHJpZ2dlcjogZnVuY3Rpb24gKHRyaWdnZXJEZWYpIHsKICAgICAgdmFyIGhhc09wdGlvbnMgPSBfLmlzT2JqZWN0KHRyaWdnZXJEZWYpOwogICAgICB2YXIgb3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIGhhc09wdGlvbnMgPyB0cmlnZ2VyRGVmIDoge30sIHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogdHJ1ZSwKICAgICAgICBzdG9wUHJvcGFnYXRpb246IHRydWUKICAgICAgfSk7CiAgICAgIHZhciBldmVudE5hbWUgPSBoYXNPcHRpb25zID8gb3B0aW9ucy5ldmVudCA6IHRyaWdnZXJEZWY7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoZSkgewogICAgICAgIGlmIChlKSB7CiAgICAgICAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCAmJiBvcHRpb25zLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlLnN0b3BQcm9wYWdhdGlvbiAmJiBvcHRpb25zLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXJncyA9IHsKICAgICAgICAgIHZpZXc6IHRoaXMsCiAgICAgICAgICBtb2RlbDogdGhpcy5tb2RlbCwKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMuY29sbGVjdGlvbgogICAgICAgIH07CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKGV2ZW50TmFtZSwgYXJncyk7CiAgICAgIH07CiAgICB9LAogICAgc2V0RWxlbWVudDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgcmV0ID0gQmFja2JvbmUuVmlldy5wcm90b3R5cGUuc2V0RWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAvLyBwcm94eSBiZWhhdmlvciAkZWwgdG8gdGhlIHZpZXcncyAkZWwuCiAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIGJlY2F1c2UgYSB2aWV3J3MgJGVsIHByb3h5CiAgICAgIC8vIGlzIG5vdCBzZXQgdW50aWwgYWZ0ZXIgc2V0RWxlbWVudCBpcyBjYWxsZWQuCiAgICAgIF8uaW52b2tlKHRoaXMuX2JlaGF2aW9ycywgJ3Byb3h5Vmlld1Byb3BlcnRpZXMnLCB0aGlzKTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHZhciB0cmlnZ2VyTWV0aG9kID0gTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kOwogICAgICB2YXIgcmV0ID0gdHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgZnVuY3Rpb24gKGIpIHsKICAgICAgICB0cmlnZ2VyTWV0aG9kLmFwcGx5KGIsIGFyZ3MpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICAvLyBJbXBvcnRzIHRoZSAibm9ybWFsaXplTWV0aG9kcyIgdG8gdHJhbnNmb3JtIGhhc2hlcyBvZgogICAgLy8gZXZlbnRzPT5mdW5jdGlvbiByZWZlcmVuY2VzL25hbWVzIHRvIGEgaGFzaCBvZiBldmVudHM9PmZ1bmN0aW9uIHJlZmVyZW5jZXMKICAgIG5vcm1hbGl6ZU1ldGhvZHM6IE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcywKICAgIC8vIFByb3h5IGBnZXRPcHRpb25gIHRvIGVuYWJsZSBnZXR0aW5nIG9wdGlvbnMgZnJvbSB0aGlzIG9yIHRoaXMub3B0aW9ucyBieSBuYW1lLgogICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogICAgLy8gUHJveHkgYHVuYmluZEVudGl0eUV2ZW50c2AgdG8gZW5hYmxlIGJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eUJpbmRFbnRpdHlFdmVudHMsCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgIHVuYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cwogIH0pOwogIC8vIEl0ZW0gVmlldwogIC8vIC0tLS0tLS0tLQogIC8vIEEgc2luZ2xlIGl0ZW0gdmlldyBpbXBsZW1lbnRhdGlvbiB0aGF0IGNvbnRhaW5zIGNvZGUgZm9yIHJlbmRlcmluZwogIC8vIHdpdGggdW5kZXJzY29yZS5qcyB0ZW1wbGF0ZXMsIHNlcmlhbGl6aW5nIHRoZSB2aWV3J3MgbW9kZWwgb3IgY29sbGVjdGlvbiwKICAvLyBhbmQgY2FsbGluZyBzZXZlcmFsIG1ldGhvZHMgb24gZXh0ZW5kZWQgdmlld3MsIHN1Y2ggYXMgYG9uUmVuZGVyYC4KICBNYXJpb25ldHRlLkl0ZW1WaWV3ID0gTWFyaW9uZXR0ZS5WaWV3LmV4dGVuZCh7CiAgICAvLyBTZXR0aW5nIHVwIHRoZSBpbmhlcml0YW5jZSBjaGFpbiB3aGljaCBhbGxvd3MgY2hhbmdlcyB0bwogICAgLy8gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5jb25zdHJ1Y3RvciB3aGljaCBhbGxvd3Mgb3ZlcnJpZGluZwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uICgpIHsKICAgICAgTWFyaW9uZXR0ZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gU2VyaWFsaXplIHRoZSBtb2RlbCBvciBjb2xsZWN0aW9uIGZvciB0aGUgdmlldy4gSWYgYSBtb2RlbCBpcwogICAgLy8gZm91bmQsIHRoZSB2aWV3J3MgYHNlcmlhbGl6ZU1vZGVsYCBpcyBjYWxsZWQuIElmIGEgY29sbGVjdGlvbiBpcyBmb3VuZCwKICAgIC8vIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24gaXMgc2VyaWFsaXplZCBieSBjYWxsaW5nCiAgICAvLyB0aGUgdmlldydzIGBzZXJpYWxpemVDb2xsZWN0aW9uYCBhbmQgcHV0IGludG8gYW4gYGl0ZW1zYCBhcnJheSBpbgogICAgLy8gdGhlIHJlc3VsdGluZyBkYXRhLiBJZiBib3RoIGFyZSBmb3VuZCwgZGVmYXVsdHMgdG8gdGhlIG1vZGVsLgogICAgLy8gWW91IGNhbiBvdmVycmlkZSB0aGUgYHNlcmlhbGl6ZURhdGFgIG1ldGhvZCBpbiB5b3VyIG93biB2aWV3IGRlZmluaXRpb24sCiAgICAvLyB0byBwcm92aWRlIGN1c3RvbSBzZXJpYWxpemF0aW9uIGZvciB5b3VyIHZpZXcncyBkYXRhLgogICAgc2VyaWFsaXplRGF0YTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZGF0YSA9IHt9OwogICAgICBpZiAodGhpcy5tb2RlbCkgewogICAgICAgIGRhdGEgPSBfLnBhcnRpYWwodGhpcy5zZXJpYWxpemVNb2RlbCwgdGhpcy5tb2RlbCkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICBkYXRhID0geyBpdGVtczogXy5wYXJ0aWFsKHRoaXMuc2VyaWFsaXplQ29sbGVjdGlvbiwgdGhpcy5jb2xsZWN0aW9uKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9LAogICAgLy8gU2VyaWFsaXplIGEgY29sbGVjdGlvbiBieSBzZXJpYWxpemluZyBlYWNoIG9mIGl0cyBtb2RlbHMuCiAgICBzZXJpYWxpemVDb2xsZWN0aW9uOiBmdW5jdGlvbiAoY29sbGVjdGlvbikgewogICAgICByZXR1cm4gY29sbGVjdGlvbi50b0pTT04uYXBwbHkoY29sbGVjdGlvbiwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgdGhlIHZpZXcsIGRlZmF1bHRpbmcgdG8gdW5kZXJzY29yZS5qcyB0ZW1wbGF0ZXMuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoaXMgaW4geW91ciB2aWV3IGRlZmluaXRpb24gdG8gcHJvdmlkZQogICAgLy8gYSB2ZXJ5IHNwZWNpZmljIHJlbmRlcmluZyBmb3IgeW91ciB2aWV3LiBJbiBnZW5lcmFsLCB0aG91Z2gsCiAgICAvLyB5b3Ugc2hvdWxkIG92ZXJyaWRlIHRoZSBgTWFyaW9uZXR0ZS5SZW5kZXJlcmAgb2JqZWN0IHRvCiAgICAvLyBjaGFuZ2UgaG93IE1hcmlvbmV0dGUgcmVuZGVycyB2aWV3cy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuYmluZFVJRWxlbWVudHMoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXInLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbmRlciB0aGUgdGVtcGxhdGUgd2l0aCB0aGUgc2VyaWFsaXplZCBkYXRhCiAgICAvLyBhbmQgdGVtcGxhdGUgaGVscGVycyB2aWEgdGhlIGBNYXJpb25ldHRlLlJlbmRlcmVyYCBvYmplY3QuCiAgICAvLyBUaHJvd3MgYW4gYFVuZGVmaW5lZFRlbXBsYXRlRXJyb3JgIGVycm9yIGlmIHRoZSB0ZW1wbGF0ZSBpcwogICAgLy8gYW55IGZhbHNlbHkgdmFsdWUgYnV0IGxpdGVyYWwgYGZhbHNlYC4KICAgIF9yZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLmdldFRlbXBsYXRlKCk7CiAgICAgIC8vIEFsbG93IHRlbXBsYXRlLWxlc3MgaXRlbSB2aWV3cwogICAgICBpZiAodGVtcGxhdGUgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnVW5kZWZpbmVkVGVtcGxhdGVFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IHJlbmRlciB0aGUgdGVtcGxhdGUgc2luY2UgaXQgaXMgbnVsbCBvciB1bmRlZmluZWQuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIC8vIEFkZCBpbiBlbnRpdHkgZGF0YSBhbmQgdGVtcGxhdGUgaGVscGVycwogICAgICB2YXIgZGF0YSA9IHRoaXMuc2VyaWFsaXplRGF0YSgpOwogICAgICBkYXRhID0gdGhpcy5taXhpblRlbXBsYXRlSGVscGVycyhkYXRhKTsKICAgICAgLy8gUmVuZGVyIGFuZCBhZGQgdG8gZWwKICAgICAgdmFyIGh0bWwgPSBNYXJpb25ldHRlLlJlbmRlcmVyLnJlbmRlcih0ZW1wbGF0ZSwgZGF0YSwgdGhpcyk7CiAgICAgIHRoaXMuYXR0YWNoRWxDb250ZW50KGh0bWwpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBBdHRhY2hlcyB0aGUgY29udGVudCBvZiBhIGdpdmVuIHZpZXcuCiAgICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGRlbiB0byBvcHRpbWl6ZSByZW5kZXJpbmcsCiAgICAvLyBvciB0byByZW5kZXIgaW4gYSBub24gc3RhbmRhcmQgd2F5LgogICAgLy8KICAgIC8vIEZvciBleGFtcGxlLCB1c2luZyBgaW5uZXJIVE1MYCBpbnN0ZWFkIG9mIGAkZWwuaHRtbGAKICAgIC8vCiAgICAvLyBgYGBqcwogICAgLy8gYXR0YWNoRWxDb250ZW50OiBmdW5jdGlvbihodG1sKSB7CiAgICAvLyAgIHRoaXMuZWwuaW5uZXJIVE1MID0gaHRtbDsKICAgIC8vICAgcmV0dXJuIHRoaXM7CiAgICAvLyB9CiAgICAvLyBgYGAKICAgIGF0dGFjaEVsQ29udGVudDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdGhpcy4kZWwuaHRtbChodG1sKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZGVzdHJveSBldmVudCB0byBhZGQgYSBmZXcKICAgIC8vIG1vcmUgZXZlbnRzIHRoYXQgYXJlIHRyaWdnZXJlZC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuVmlldy5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0pOwogIC8qIGpzaGludCBtYXhzdGF0ZW1lbnRzOiAxNCAqLwogIC8qIGpzaGludCBtYXhsZW46IDIwMCAqLwogIC8vIENvbGxlY3Rpb24gVmlldwogIC8vIC0tLS0tLS0tLS0tLS0tLQogIC8vIEEgdmlldyB0aGF0IGl0ZXJhdGVzIG92ZXIgYSBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gYW5kIHJlbmRlcnMgYW4gaW5kaXZpZHVhbCBjaGlsZCB2aWV3IGZvciBlYWNoIG1vZGVsLgogIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcgPSBNYXJpb25ldHRlLlZpZXcuZXh0ZW5kKHsKICAgIC8vIHVzZWQgYXMgdGhlIHByZWZpeCBmb3IgY2hpbGQgdmlldyBldmVudHMKICAgIC8vIHRoYXQgYXJlIGZvcndhcmRlZCB0aHJvdWdoIHRoZSBjb2xsZWN0aW9udmlldwogICAgY2hpbGRWaWV3RXZlbnRQcmVmaXg6ICdjaGlsZHZpZXcnLAogICAgLy8gY29uc3RydWN0b3IKICAgIC8vIG9wdGlvbiB0byBwYXNzIGB7c29ydDogZmFsc2V9YCB0byBwcmV2ZW50IHRoZSBgQ29sbGVjdGlvblZpZXdgIGZyb20KICAgIC8vIG1haW50YWluaW5nIHRoZSBzb3J0ZWQgb3JkZXIgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAvLyBUaGlzIHdpbGwgZmFsbGJhY2sgb250byBhcHBlbmRpbmcgY2hpbGRWaWV3J3MgdG8gdGhlIGVuZC4KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgaW5pdE9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLnNvcnQgPSBfLmlzVW5kZWZpbmVkKGluaXRPcHRpb25zLnNvcnQpID8gdHJ1ZSA6IGluaXRPcHRpb25zLnNvcnQ7CiAgICAgIGlmIChpbml0T3B0aW9ucy5jb2xsZWN0aW9uICYmICEoaW5pdE9wdGlvbnMuY29sbGVjdGlvbiBpbnN0YW5jZW9mIEJhY2tib25lLkNvbGxlY3Rpb24pKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoJ1RoZSBDb2xsZWN0aW9uIG9wdGlvbiBwYXNzZWQgdG8gdGhpcyB2aWV3IG5lZWRzIHRvIGJlIGFuIGluc3RhbmNlIG9mIGEgQmFja2JvbmUuQ29sbGVjdGlvbicpOwogICAgICB9CiAgICAgIHRoaXMub25jZSgncmVuZGVyJywgdGhpcy5faW5pdGlhbEV2ZW50cyk7CiAgICAgIHRoaXMuX2luaXRDaGlsZFZpZXdTdG9yYWdlKCk7CiAgICAgIE1hcmlvbmV0dGUuVmlldy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB0aGlzLmluaXRSZW5kZXJCdWZmZXIoKTsKICAgIH0sCiAgICAvLyBJbnN0ZWFkIG9mIGluc2VydGluZyBlbGVtZW50cyBvbmUgYnkgb25lIGludG8gdGhlIHBhZ2UsCiAgICAvLyBpdCdzIG11Y2ggbW9yZSBwZXJmb3JtYW50IHRvIGluc2VydCBlbGVtZW50cyBpbnRvIGEgZG9jdW1lbnQKICAgIC8vIGZyYWdtZW50IGFuZCB0aGVuIGluc2VydCB0aGF0IGRvY3VtZW50IGZyYWdtZW50IGludG8gdGhlIHBhZ2UKICAgIGluaXRSZW5kZXJCdWZmZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5lbEJ1ZmZlciA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgdGhpcy5fYnVmZmVyZWRDaGlsZHJlbiA9IFtdOwogICAgfSwKICAgIHN0YXJ0QnVmZmVyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuaW5pdFJlbmRlckJ1ZmZlcigpOwogICAgICB0aGlzLmlzQnVmZmVyaW5nID0gdHJ1ZTsKICAgIH0sCiAgICBlbmRCdWZmZXJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5pc0J1ZmZlcmluZyA9IGZhbHNlOwogICAgICB0aGlzLl90cmlnZ2VyQmVmb3JlU2hvd0J1ZmZlcmVkQ2hpbGRyZW4oKTsKICAgICAgdGhpcy5hdHRhY2hCdWZmZXIodGhpcywgdGhpcy5lbEJ1ZmZlcik7CiAgICAgIHRoaXMuX3RyaWdnZXJTaG93QnVmZmVyZWRDaGlsZHJlbigpOwogICAgICB0aGlzLmluaXRSZW5kZXJCdWZmZXIoKTsKICAgIH0sCiAgICBfdHJpZ2dlckJlZm9yZVNob3dCdWZmZXJlZENoaWxkcmVuOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLl9pc1Nob3duKSB7CiAgICAgICAgXy5lYWNoKHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4sIF8ucGFydGlhbCh0aGlzLl90cmlnZ2VyTWV0aG9kT25DaGlsZCwgJ2JlZm9yZTpzaG93JykpOwogICAgICB9CiAgICB9LAogICAgX3RyaWdnZXJTaG93QnVmZmVyZWRDaGlsZHJlbjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIF8uZWFjaCh0aGlzLl9idWZmZXJlZENoaWxkcmVuLCBfLnBhcnRpYWwodGhpcy5fdHJpZ2dlck1ldGhvZE9uQ2hpbGQsICdzaG93JykpOwogICAgICAgIHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4gPSBbXTsKICAgICAgfQogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCBmb3IgXy5lYWNoIGxvb3BzIHRvIGNhbGwgYE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uYCBvbgogICAgLy8gYSBjaGlsZCB2aWV3CiAgICBfdHJpZ2dlck1ldGhvZE9uQ2hpbGQ6IGZ1bmN0aW9uIChldmVudCwgY2hpbGRWaWV3KSB7CiAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKGNoaWxkVmlldywgZXZlbnQpOwogICAgfSwKICAgIC8vIENvbmZpZ3VyZWQgdGhlIGluaXRpYWwgZXZlbnRzIHRoYXQgdGhlIGNvbGxlY3Rpb24gdmlldwogICAgLy8gYmluZHMgdG8uCiAgICBfaW5pdGlhbEV2ZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uKSB7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdhZGQnLCB0aGlzLl9vbkNvbGxlY3Rpb25BZGQpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAncmVtb3ZlJywgdGhpcy5fb25Db2xsZWN0aW9uUmVtb3ZlKTsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ3Jlc2V0JywgdGhpcy5yZW5kZXIpOwogICAgICAgIGlmICh0aGlzLnNvcnQpIHsKICAgICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAnc29ydCcsIHRoaXMuX3NvcnRWaWV3cyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gSGFuZGxlIGEgY2hpbGQgYWRkZWQgdG8gdGhlIGNvbGxlY3Rpb24KICAgIF9vbkNvbGxlY3Rpb25BZGQ6IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB0aGlzLmRlc3Ryb3lFbXB0eVZpZXcoKTsKICAgICAgdmFyIENoaWxkVmlldyA9IHRoaXMuZ2V0Q2hpbGRWaWV3KGNoaWxkKTsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YoY2hpbGQpOwogICAgICB0aGlzLmFkZENoaWxkKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KTsKICAgIH0sCiAgICAvLyBnZXQgdGhlIGNoaWxkIHZpZXcgYnkgbW9kZWwgaXQgaG9sZHMsIGFuZCByZW1vdmUgaXQKICAgIF9vbkNvbGxlY3Rpb25SZW1vdmU6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICB2YXIgdmlldyA9IHRoaXMuY2hpbGRyZW4uZmluZEJ5TW9kZWwobW9kZWwpOwogICAgICB0aGlzLnJlbW92ZUNoaWxkVmlldyh2aWV3KTsKICAgICAgdGhpcy5jaGVja0VtcHR5KCk7CiAgICB9LAogICAgLy8gT3ZlcnJpZGUgZnJvbSBgTWFyaW9uZXR0ZS5WaWV3YCB0byB0cmlnZ2VyIHNob3cgb24gY2hpbGQgdmlld3MKICAgIG9uU2hvd0NhbGxlZDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLmNoaWxkcmVuLmVhY2goXy5wYXJ0aWFsKHRoaXMuX3RyaWdnZXJNZXRob2RPbkNoaWxkLCAnc2hvdycpKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgY2hpbGRyZW4gdmlld3MuIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvCiAgICAvLyBwcm92aWRlIHlvdXIgb3duIGltcGxlbWVudGF0aW9uIG9mIGEgcmVuZGVyIGZ1bmN0aW9uIGZvcgogICAgLy8gdGhlIGNvbGxlY3Rpb24gdmlldy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFJlbmRlciB2aWV3IGFmdGVyIHNvcnRpbmcuIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvCiAgICAvLyBjaGFuZ2UgaG93IHRoZSB2aWV3IHJlbmRlcnMgYWZ0ZXIgYSBgc29ydGAgb24gdGhlIGNvbGxlY3Rpb24uCiAgICAvLyBBbiBleGFtcGxlIG9mIHRoaXMgd291bGQgYmUgdG8gb25seSBgcmVuZGVyQ2hpbGRyZW5gIGluIGEgYENvbXBvc2l0ZVZpZXdgCiAgICAvLyByYXRoZXIgdGhhbiB0aGUgZnVsbCB2aWV3LgogICAgcmVzb3J0VmlldzogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnJlbmRlcigpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZC4gVGhpcyBjaGVja3MgZm9yIGFueSBjaGFuZ2VzIGluIHRoZSBvcmRlciBvZiB0aGUgY29sbGVjdGlvbi4KICAgIC8vIElmIHRoZSBpbmRleCBvZiBhbnkgdmlldyBkb2Vzbid0IG1hdGNoLCBpdCB3aWxsIHJlbmRlci4KICAgIF9zb3J0Vmlld3M6IGZ1bmN0aW9uICgpIHsKICAgICAgLy8gY2hlY2sgZm9yIGFueSBjaGFuZ2VzIGluIHNvcnQgb3JkZXIgb2Ygdmlld3MKICAgICAgdmFyIG9yZGVyQ2hhbmdlZCA9IHRoaXMuY29sbGVjdGlvbi5maW5kKGZ1bmN0aW9uIChpdGVtLCBpbmRleCkgewogICAgICAgIHZhciB2aWV3ID0gdGhpcy5jaGlsZHJlbi5maW5kQnlNb2RlbChpdGVtKTsKICAgICAgICByZXR1cm4gIXZpZXcgfHwgdmlldy5faW5kZXggIT09IGluZGV4OwogICAgICB9LCB0aGlzKTsKICAgICAgaWYgKG9yZGVyQ2hhbmdlZCkgewogICAgICAgIHRoaXMucmVzb3J0VmlldygpOwogICAgICB9CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBTZXBhcmF0ZWQgc28gdGhhdCBDb21wb3NpdGVWaWV3IGNhbiBoYXZlCiAgICAvLyBtb3JlIGNvbnRyb2wgb3ZlciBldmVudHMgYmVpbmcgdHJpZ2dlcmVkLCBhcm91bmQgdGhlIHJlbmRlcmluZwogICAgLy8gcHJvY2VzcwogICAgX3JlbmRlckNoaWxkcmVuOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZGVzdHJveUVtcHR5VmlldygpOwogICAgICB0aGlzLmRlc3Ryb3lDaGlsZHJlbigpOwogICAgICBpZiAodGhpcy5pc0VtcHR5KHRoaXMuY29sbGVjdGlvbikpIHsKICAgICAgICB0aGlzLnNob3dFbXB0eVZpZXcoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpyZW5kZXI6Y29sbGVjdGlvbicsIHRoaXMpOwogICAgICAgIHRoaXMuc3RhcnRCdWZmZXJpbmcoKTsKICAgICAgICB0aGlzLnNob3dDb2xsZWN0aW9uKCk7CiAgICAgICAgdGhpcy5lbmRCdWZmZXJpbmcoKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbmRlcjpjb2xsZWN0aW9uJywgdGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gbG9vcCB0aHJvdWdoIGNvbGxlY3Rpb24gYW5kIHNob3cgZWFjaCBjaGlsZCB2aWV3LgogICAgc2hvd0NvbGxlY3Rpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIENoaWxkVmlldzsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmVhY2goZnVuY3Rpb24gKGNoaWxkLCBpbmRleCkgewogICAgICAgIENoaWxkVmlldyA9IHRoaXMuZ2V0Q2hpbGRWaWV3KGNoaWxkKTsKICAgICAgICB0aGlzLmFkZENoaWxkKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KTsKICAgICAgfSwgdGhpcyk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNob3cgYW4gZW1wdHkgdmlldyBpbiBwbGFjZSBvZgogICAgLy8gYSBjb2xsZWN0aW9uIG9mIGNoaWxkIHZpZXdzLCB3aGVuIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5CiAgICBzaG93RW1wdHlWaWV3OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBFbXB0eVZpZXcgPSB0aGlzLmdldEVtcHR5VmlldygpOwogICAgICBpZiAoRW1wdHlWaWV3ICYmICF0aGlzLl9zaG93aW5nRW1wdHlWaWV3KSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyOmVtcHR5Jyk7CiAgICAgICAgdGhpcy5fc2hvd2luZ0VtcHR5VmlldyA9IHRydWU7CiAgICAgICAgdmFyIG1vZGVsID0gbmV3IEJhY2tib25lLk1vZGVsKCk7CiAgICAgICAgdGhpcy5hZGRFbXB0eVZpZXcobW9kZWwsIEVtcHR5Vmlldyk7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXI6ZW1wdHknKTsKICAgICAgfQogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBkZXN0cm95IGFuIGV4aXN0aW5nIGVtcHR5VmlldyBpbnN0YW5jZQogICAgLy8gaWYgb25lIGV4aXN0cy4gQ2FsbGVkIHdoZW4gYSBjb2xsZWN0aW9uIHZpZXcgaGFzIGJlZW4KICAgIC8vIHJlbmRlcmVkIGVtcHR5LCBhbmQgdGhlbiBhIGNoaWxkIGlzIGFkZGVkIHRvIHRoZSBjb2xsZWN0aW9uLgogICAgZGVzdHJveUVtcHR5VmlldzogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5fc2hvd2luZ0VtcHR5VmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbW92ZTplbXB0eScpOwogICAgICAgIHRoaXMuZGVzdHJveUNoaWxkcmVuKCk7CiAgICAgICAgZGVsZXRlIHRoaXMuX3Nob3dpbmdFbXB0eVZpZXc7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6ZW1wdHknKTsKICAgICAgfQogICAgfSwKICAgIC8vIFJldHJpZXZlIHRoZSBlbXB0eSB2aWV3IGNsYXNzCiAgICBnZXRFbXB0eVZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uKCdlbXB0eVZpZXcnKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgYW5kIHNob3cgdGhlIGVtcHR5Vmlldy4gU2ltaWxhciB0byBhZGRDaGlsZCBtZXRob2QKICAgIC8vIGJ1dCAiY2hpbGQ6YWRkZWQiIGV2ZW50cyBhcmUgbm90IGZpcmVkLCBhbmQgdGhlIGV2ZW50IGZyb20KICAgIC8vIGVtcHR5VmlldyBhcmUgbm90IGZvcndhcmRlZAogICAgYWRkRW1wdHlWaWV3OiBmdW5jdGlvbiAoY2hpbGQsIEVtcHR5VmlldykgewogICAgICAvLyBnZXQgdGhlIGVtcHR5Vmlld09wdGlvbnMsIGZhbGxpbmcgYmFjayB0byBjaGlsZFZpZXdPcHRpb25zCiAgICAgIHZhciBlbXB0eVZpZXdPcHRpb25zID0gdGhpcy5nZXRPcHRpb24oJ2VtcHR5Vmlld09wdGlvbnMnKSB8fCB0aGlzLmdldE9wdGlvbignY2hpbGRWaWV3T3B0aW9ucycpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGVtcHR5Vmlld09wdGlvbnMpKSB7CiAgICAgICAgZW1wdHlWaWV3T3B0aW9ucyA9IGVtcHR5Vmlld09wdGlvbnMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICAvLyBidWlsZCB0aGUgZW1wdHkgdmlldwogICAgICB2YXIgdmlldyA9IHRoaXMuYnVpbGRDaGlsZFZpZXcoY2hpbGQsIEVtcHR5VmlldywgZW1wdHlWaWV3T3B0aW9ucyk7CiAgICAgIC8vIFByb3h5IGVtcHR5VmlldyBldmVudHMKICAgICAgdGhpcy5wcm94eUNoaWxkRXZlbnRzKHZpZXcpOwogICAgICAvLyB0cmlnZ2VyIHRoZSAnYmVmb3JlOnNob3cnIGV2ZW50IG9uIGB2aWV3YCBpZiB0aGUgY29sbGVjdGlvbiB2aWV3CiAgICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gc2hvd24KICAgICAgaWYgKHRoaXMuX2lzU2hvd24pIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnYmVmb3JlOnNob3cnKTsKICAgICAgfQogICAgICAvLyBTdG9yZSB0aGUgYGVtcHR5Vmlld2AgbGlrZSBhIGBjaGlsZFZpZXdgIHNvIHdlIGNhbiBwcm9wZXJseQogICAgICAvLyByZW1vdmUgYW5kL29yIGNsb3NlIGl0IGxhdGVyCiAgICAgIHRoaXMuY2hpbGRyZW4uYWRkKHZpZXcpOwogICAgICAvLyBSZW5kZXIgaXQgYW5kIHNob3cgaXQKICAgICAgdGhpcy5yZW5kZXJDaGlsZFZpZXcodmlldywgLTEpOwogICAgICAvLyBjYWxsIHRoZSAnc2hvdycgbWV0aG9kIGlmIHRoZSBjb2xsZWN0aW9uIHZpZXcKICAgICAgLy8gaGFzIGFscmVhZHkgYmVlbiBzaG93bgogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKHZpZXcsICdzaG93Jyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZXRyaWV2ZSB0aGUgYGNoaWxkVmlld2AgY2xhc3MsIGVpdGhlciBmcm9tIGB0aGlzLm9wdGlvbnMuY2hpbGRWaWV3YAogICAgLy8gb3IgZnJvbSB0aGUgYGNoaWxkVmlld2AgaW4gdGhlIG9iamVjdCBkZWZpbml0aW9uLiBUaGUgIm9wdGlvbnMiCiAgICAvLyB0YWtlcyBwcmVjZWRlbmNlLgogICAgLy8gVGhpcyBtZXRob2QgcmVjZWl2ZXMgdGhlIG1vZGVsIHRoYXQgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGluc3RhbmNlCiAgICAvLyBjcmVhdGVkIGZyb20gdGhpcyBgY2hpbGRWaWV3YC4gT3ZlcnJpZGluZyBtZXRob2RzIG1heSB1c2UgdGhlIGNoaWxkCiAgICAvLyB0byBkZXRlcm1pbmUgd2hhdCBgY2hpbGRWaWV3YCBjbGFzcyB0byByZXR1cm4uCiAgICBnZXRDaGlsZFZpZXc6IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB2YXIgY2hpbGRWaWV3ID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlldycpOwogICAgICBpZiAoIWNoaWxkVmlldykgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG5hbWU6ICdOb0NoaWxkVmlld0Vycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdBICJjaGlsZFZpZXciIG11c3QgYmUgc3BlY2lmaWVkJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBjaGlsZFZpZXc7CiAgICB9LAogICAgLy8gUmVuZGVyIHRoZSBjaGlsZCdzIHZpZXcgYW5kIGFkZCBpdCB0byB0aGUKICAgIC8vIEhUTUwgZm9yIHRoZSBjb2xsZWN0aW9uIHZpZXcgYXQgYSBnaXZlbiBpbmRleC4KICAgIC8vIFRoaXMgd2lsbCBhbHNvIHVwZGF0ZSB0aGUgaW5kaWNlcyBvZiBsYXRlciB2aWV3cyBpbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaW4gb3JkZXIgdG8ga2VlcCB0aGUgY2hpbGRyZW4gaW4gc3luYyB3aXRoIHRoZSBjb2xsZWN0aW9uLgogICAgYWRkQ2hpbGQ6IGZ1bmN0aW9uIChjaGlsZCwgQ2hpbGRWaWV3LCBpbmRleCkgewogICAgICB2YXIgY2hpbGRWaWV3T3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9uKCdjaGlsZFZpZXdPcHRpb25zJyk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oY2hpbGRWaWV3T3B0aW9ucykpIHsKICAgICAgICBjaGlsZFZpZXdPcHRpb25zID0gY2hpbGRWaWV3T3B0aW9ucy5jYWxsKHRoaXMsIGNoaWxkLCBpbmRleCk7CiAgICAgIH0KICAgICAgdmFyIHZpZXcgPSB0aGlzLmJ1aWxkQ2hpbGRWaWV3KGNoaWxkLCBDaGlsZFZpZXcsIGNoaWxkVmlld09wdGlvbnMpOwogICAgICAvLyBpbmNyZW1lbnQgaW5kaWNlcyBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICB0aGlzLl91cGRhdGVJbmRpY2VzKHZpZXcsIHRydWUsIGluZGV4KTsKICAgICAgdGhpcy5fYWRkQ2hpbGRWaWV3KHZpZXcsIGluZGV4KTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBUaGlzIGRlY3JlbWVudHMgb3IgaW5jcmVtZW50cyB0aGUgaW5kaWNlcyBvZiB2aWV3cyBhZnRlciB0aGUKICAgIC8vIGFkZGVkL3JlbW92ZWQgdmlldyB0byBrZWVwIGluIHN5bmMgd2l0aCB0aGUgY29sbGVjdGlvbi4KICAgIF91cGRhdGVJbmRpY2VzOiBmdW5jdGlvbiAodmlldywgaW5jcmVtZW50LCBpbmRleCkgewogICAgICBpZiAoIXRoaXMuc29ydCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaW5jcmVtZW50KSB7CiAgICAgICAgLy8gYXNzaWduIHRoZSBpbmRleCB0byB0aGUgdmlldwogICAgICAgIHZpZXcuX2luZGV4ID0gaW5kZXg7CiAgICAgICAgLy8gaW5jcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuY2hpbGRyZW4uZWFjaChmdW5jdGlvbiAobGF0ZXJWaWV3KSB7CiAgICAgICAgICBpZiAobGF0ZXJWaWV3Ll9pbmRleCA+PSB2aWV3Ll9pbmRleCkgewogICAgICAgICAgICBsYXRlclZpZXcuX2luZGV4Kys7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuY2hpbGRyZW4uZWFjaChmdW5jdGlvbiAobGF0ZXJWaWV3KSB7CiAgICAgICAgICBpZiAobGF0ZXJWaWV3Ll9pbmRleCA+PSB2aWV3Ll9pbmRleCkgewogICAgICAgICAgICBsYXRlclZpZXcuX2luZGV4LS07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBNZXRob2QuIEFkZCB0aGUgdmlldyB0byBjaGlsZHJlbiBhbmQgcmVuZGVyIGl0IGF0CiAgICAvLyB0aGUgZ2l2ZW4gaW5kZXguCiAgICBfYWRkQ2hpbGRWaWV3OiBmdW5jdGlvbiAodmlldywgaW5kZXgpIHsKICAgICAgLy8gc2V0IHVwIHRoZSBjaGlsZCB2aWV3IGV2ZW50IGZvcndhcmRpbmcKICAgICAgdGhpcy5wcm94eUNoaWxkRXZlbnRzKHZpZXcpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6Y2hpbGQnLCB2aWV3KTsKICAgICAgLy8gU3RvcmUgdGhlIGNoaWxkIHZpZXcgaXRzZWxmIHNvIHdlIGNhbiBwcm9wZXJseQogICAgICAvLyByZW1vdmUgYW5kL29yIGRlc3Ryb3kgaXQgbGF0ZXIKICAgICAgdGhpcy5jaGlsZHJlbi5hZGQodmlldyk7CiAgICAgIHRoaXMucmVuZGVyQ2hpbGRWaWV3KHZpZXcsIGluZGV4KTsKICAgICAgaWYgKHRoaXMuX2lzU2hvd24gJiYgIXRoaXMuaXNCdWZmZXJpbmcpIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnc2hvdycpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYWRkOmNoaWxkJywgdmlldyk7CiAgICB9LAogICAgLy8gcmVuZGVyIHRoZSBjaGlsZCB2aWV3CiAgICByZW5kZXJDaGlsZFZpZXc6IGZ1bmN0aW9uICh2aWV3LCBpbmRleCkgewogICAgICB2aWV3LnJlbmRlcigpOwogICAgICB0aGlzLmF0dGFjaEh0bWwodGhpcywgdmlldywgaW5kZXgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0sCiAgICAvLyBCdWlsZCBhIGBjaGlsZFZpZXdgIGZvciBhIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgogICAgYnVpbGRDaGlsZFZpZXc6IGZ1bmN0aW9uIChjaGlsZCwgQ2hpbGRWaWV3Q2xhc3MsIGNoaWxkVmlld09wdGlvbnMpIHsKICAgICAgdmFyIG9wdGlvbnMgPSBfLmV4dGVuZCh7IG1vZGVsOiBjaGlsZCB9LCBjaGlsZFZpZXdPcHRpb25zKTsKICAgICAgcmV0dXJuIG5ldyBDaGlsZFZpZXdDbGFzcyhvcHRpb25zKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgdGhlIGNoaWxkIHZpZXcgYW5kIGRlc3Ryb3kgaXQuCiAgICAvLyBUaGlzIGZ1bmN0aW9uIGFsc28gdXBkYXRlcyB0aGUgaW5kaWNlcyBvZgogICAgLy8gbGF0ZXIgdmlld3MgaW4gdGhlIGNvbGxlY3Rpb24gaW4gb3JkZXIgdG8ga2VlcAogICAgLy8gdGhlIGNoaWxkcmVuIGluIHN5bmMgd2l0aCB0aGUgY29sbGVjdGlvbi4KICAgIHJlbW92ZUNoaWxkVmlldzogZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgaWYgKHZpZXcpIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpyZW1vdmU6Y2hpbGQnLCB2aWV3KTsKICAgICAgICAvLyBjYWxsICdkZXN0cm95JyBvciAncmVtb3ZlJywgZGVwZW5kaW5nIG9uIHdoaWNoIGlzIGZvdW5kCiAgICAgICAgaWYgKHZpZXcuZGVzdHJveSkgewogICAgICAgICAgdmlldy5kZXN0cm95KCk7CiAgICAgICAgfSBlbHNlIGlmICh2aWV3LnJlbW92ZSkgewogICAgICAgICAgdmlldy5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKHZpZXcpOwogICAgICAgIHRoaXMuY2hpbGRyZW4ucmVtb3ZlKHZpZXcpOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOmNoaWxkJywgdmlldyk7CiAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuX3VwZGF0ZUluZGljZXModmlldywgZmFsc2UpOwogICAgICB9CiAgICAgIHJldHVybiB2aWV3OwogICAgfSwKICAgIC8vIGNoZWNrIGlmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5CiAgICBpc0VtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAhdGhpcy5jb2xsZWN0aW9uIHx8IHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDA7CiAgICB9LAogICAgLy8gSWYgZW1wdHksIHNob3cgdGhlIGVtcHR5IHZpZXcKICAgIGNoZWNrRW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNFbXB0eSh0aGlzLmNvbGxlY3Rpb24pKSB7CiAgICAgICAgdGhpcy5zaG93RW1wdHlWaWV3KCk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBZb3UgbWlnaHQgbmVlZCB0byBvdmVycmlkZSB0aGlzIGlmIHlvdSd2ZSBvdmVycmlkZGVuIGF0dGFjaEh0bWwKICAgIGF0dGFjaEJ1ZmZlcjogZnVuY3Rpb24gKGNvbGxlY3Rpb25WaWV3LCBidWZmZXIpIHsKICAgICAgY29sbGVjdGlvblZpZXcuJGVsLmFwcGVuZChidWZmZXIpOwogICAgfSwKICAgIC8vIEFwcGVuZCB0aGUgSFRNTCB0byB0aGUgY29sbGVjdGlvbidzIGBlbGAuCiAgICAvLyBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBkbyBzb21ldGhpbmcgb3RoZXIKICAgIC8vIHRoYW4gYC5hcHBlbmRgLgogICAgYXR0YWNoSHRtbDogZnVuY3Rpb24gKGNvbGxlY3Rpb25WaWV3LCBjaGlsZFZpZXcsIGluZGV4KSB7CiAgICAgIGlmIChjb2xsZWN0aW9uVmlldy5pc0J1ZmZlcmluZykgewogICAgICAgIC8vIGJ1ZmZlcmluZyBoYXBwZW5zIG9uIHJlc2V0IGV2ZW50cyBhbmQgaW5pdGlhbCByZW5kZXJzCiAgICAgICAgLy8gaW4gb3JkZXIgdG8gcmVkdWNlIHRoZSBudW1iZXIgb2YgaW5zZXJ0cyBpbnRvIHRoZQogICAgICAgIC8vIGRvY3VtZW50LCB3aGljaCBhcmUgZXhwZW5zaXZlLgogICAgICAgIGNvbGxlY3Rpb25WaWV3LmVsQnVmZmVyLmFwcGVuZENoaWxkKGNoaWxkVmlldy5lbCk7CiAgICAgICAgY29sbGVjdGlvblZpZXcuX2J1ZmZlcmVkQ2hpbGRyZW4ucHVzaChjaGlsZFZpZXcpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIHdlJ3ZlIGFscmVhZHkgcmVuZGVyZWQgdGhlIG1haW4gY29sbGVjdGlvbiwgYXBwZW5kCiAgICAgICAgLy8gdGhlIG5ldyBjaGlsZCBpbnRvIHRoZSBjb3JyZWN0IG9yZGVyIGlmIHdlIG5lZWQgdG8uIE90aGVyd2lzZQogICAgICAgIC8vIGFwcGVuZCB0byB0aGUgZW5kLgogICAgICAgIGlmICghY29sbGVjdGlvblZpZXcuX2luc2VydEJlZm9yZShjaGlsZFZpZXcsIGluZGV4KSkgewogICAgICAgICAgY29sbGVjdGlvblZpZXcuX2luc2VydEFmdGVyKGNoaWxkVmlldyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBDaGVjayB3aGV0aGVyIHdlIG5lZWQgdG8gaW5zZXJ0IHRoZSB2aWV3IGludG8KICAgIC8vIHRoZSBjb3JyZWN0IHBvc2l0aW9uLgogICAgX2luc2VydEJlZm9yZTogZnVuY3Rpb24gKGNoaWxkVmlldywgaW5kZXgpIHsKICAgICAgdmFyIGN1cnJlbnRWaWV3OwogICAgICB2YXIgZmluZFBvc2l0aW9uID0gdGhpcy5zb3J0ICYmIGluZGV4IDwgdGhpcy5jaGlsZHJlbi5sZW5ndGggLSAxOwogICAgICBpZiAoZmluZFBvc2l0aW9uKSB7CiAgICAgICAgLy8gRmluZCB0aGUgdmlldyBhZnRlciB0aGlzIG9uZQogICAgICAgIGN1cnJlbnRWaWV3ID0gdGhpcy5jaGlsZHJlbi5maW5kKGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgICByZXR1cm4gdmlldy5faW5kZXggPT09IGluZGV4ICsgMTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoY3VycmVudFZpZXcpIHsKICAgICAgICBjdXJyZW50Vmlldy4kZWwuYmVmb3JlKGNoaWxkVmlldy5lbCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZC4gQXBwZW5kIGEgdmlldyB0byB0aGUgZW5kIG9mIHRoZSAkZWwKICAgIF9pbnNlcnRBZnRlcjogZnVuY3Rpb24gKGNoaWxkVmlldykgewogICAgICB0aGlzLiRlbC5hcHBlbmQoY2hpbGRWaWV3LmVsKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V0IHVwIHRoZSBgY2hpbGRyZW5gIG9iamVjdCBmb3IKICAgIC8vIHN0b3JpbmcgYWxsIG9mIHRoZSBjaGlsZCB2aWV3cwogICAgX2luaXRDaGlsZFZpZXdTdG9yYWdlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuY2hpbGRyZW4gPSBuZXcgQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyKCk7CiAgICB9LAogICAgLy8gSGFuZGxlIGNsZWFudXAgYW5kIG90aGVyIGRlc3Ryb3lpbmcgbmVlZHMgZm9yIHRoZSBjb2xsZWN0aW9uIG9mIHZpZXdzCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmRlc3Ryb3k6Y29sbGVjdGlvbicpOwogICAgICB0aGlzLmRlc3Ryb3lDaGlsZHJlbigpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2Rlc3Ryb3k6Y29sbGVjdGlvbicpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5kZXN0cm95LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gRGVzdHJveSB0aGUgY2hpbGQgdmlld3MgdGhhdCB0aGlzIGNvbGxlY3Rpb24gdmlldwogICAgLy8gaXMgaG9sZGluZyBvbiB0bywgaWYgYW55CiAgICBkZXN0cm95Q2hpbGRyZW46IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNoaWxkVmlld3MgPSB0aGlzLmNoaWxkcmVuLm1hcChfLmlkZW50aXR5KTsKICAgICAgdGhpcy5jaGlsZHJlbi5lYWNoKHRoaXMucmVtb3ZlQ2hpbGRWaWV3LCB0aGlzKTsKICAgICAgdGhpcy5jaGVja0VtcHR5KCk7CiAgICAgIHJldHVybiBjaGlsZFZpZXdzOwogICAgfSwKICAgIC8vIFNldCB1cCB0aGUgY2hpbGQgdmlldyBldmVudCBmb3J3YXJkaW5nLiBVc2VzIGEgImNoaWxkdmlldzoiCiAgICAvLyBwcmVmaXggaW4gZnJvbnQgb2YgYWxsIGZvcndhcmRlZCBldmVudHMuCiAgICBwcm94eUNoaWxkRXZlbnRzOiBmdW5jdGlvbiAodmlldykgewogICAgICB2YXIgcHJlZml4ID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlld0V2ZW50UHJlZml4Jyk7CiAgICAgIC8vIEZvcndhcmQgYWxsIGNoaWxkIHZpZXcgZXZlbnRzIHRocm91Z2ggdGhlIHBhcmVudCwKICAgICAgLy8gcHJlcGVuZGluZyAiY2hpbGR2aWV3OiIgdG8gdGhlIGV2ZW50IG5hbWUKICAgICAgdGhpcy5saXN0ZW5Ubyh2aWV3LCAnYWxsJywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHZhciByb290RXZlbnQgPSBhcmdzWzBdOwogICAgICAgIHZhciBjaGlsZEV2ZW50cyA9IHRoaXMubm9ybWFsaXplTWV0aG9kcyhfLnJlc3VsdCh0aGlzLCAnY2hpbGRFdmVudHMnKSk7CiAgICAgICAgYXJnc1swXSA9IHByZWZpeCArICc6JyArIHJvb3RFdmVudDsKICAgICAgICBhcmdzLnNwbGljZSgxLCAwLCB2aWV3KTsKICAgICAgICAvLyBjYWxsIGNvbGxlY3Rpb25WaWV3IGNoaWxkRXZlbnQgaWYgZGVmaW5lZAogICAgICAgIGlmICh0eXBlb2YgY2hpbGRFdmVudHMgIT09ICd1bmRlZmluZWQnICYmIF8uaXNGdW5jdGlvbihjaGlsZEV2ZW50c1tyb290RXZlbnRdKSkgewogICAgICAgICAgY2hpbGRFdmVudHNbcm9vdEV2ZW50XS5hcHBseSh0aGlzLCBhcmdzLnNsaWNlKDEpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9KTsKICAvKiBqc2hpbnQgbWF4c3RhdGVtZW50czogMTcsIG1heGxlbjogMTE3ICovCiAgLy8gQ29tcG9zaXRlIFZpZXcKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vIFVzZWQgZm9yIHJlbmRlcmluZyBhIGJyYW5jaC1sZWFmLCBoaWVyYXJjaGljYWwgc3RydWN0dXJlLgogIC8vIEV4dGVuZHMgZGlyZWN0bHkgZnJvbSBDb2xsZWN0aW9uVmlldyBhbmQgYWxzbyByZW5kZXJzIGFuCiAgLy8gYSBjaGlsZCB2aWV3IGFzIGBtb2RlbFZpZXdgLCBmb3IgdGhlIHRvcCBsZWFmCiAgTWFyaW9uZXR0ZS5Db21wb3NpdGVWaWV3ID0gTWFyaW9uZXR0ZS5Db2xsZWN0aW9uVmlldy5leHRlbmQoewogICAgLy8gU2V0dGluZyB1cCB0aGUgaW5oZXJpdGFuY2UgY2hhaW4gd2hpY2ggYWxsb3dzIGNoYW5nZXMgdG8KICAgIC8vIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcucHJvdG90eXBlLmNvbnN0cnVjdG9yIHdoaWNoIGFsbG93cyBvdmVycmlkaW5nCiAgICAvLyBvcHRpb24gdG8gcGFzcyAne3NvcnQ6IGZhbHNlfScgdG8gcHJldmVudCB0aGUgQ29tcG9zaXRlVmlldyBmcm9tCiAgICAvLyBtYWludGFpbmluZyB0aGUgc29ydGVkIG9yZGVyIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgLy8gVGhpcyB3aWxsIGZhbGxiYWNrIG9udG8gYXBwZW5kaW5nIGNoaWxkVmlldydzIHRvIHRoZSBlbmQuCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKCkgewogICAgICBNYXJpb25ldHRlLkNvbGxlY3Rpb25WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlZCB0aGUgaW5pdGlhbCBldmVudHMgdGhhdCB0aGUgY29tcG9zaXRlIHZpZXcKICAgIC8vIGJpbmRzIHRvLiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcmV2ZW50IHRoZSBpbml0aWFsCiAgICAvLyBldmVudHMsIG9yIHRvIGFkZCB5b3VyIG93biBpbml0aWFsIGV2ZW50cy4KICAgIF9pbml0aWFsRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIEJpbmQgb25seSBhZnRlciBjb21wb3NpdGUgdmlldyBpcyByZW5kZXJlZCB0byBhdm9pZCBhZGRpbmcgY2hpbGQgdmlld3MKICAgICAgLy8gdG8gbm9uZXhpc3RlbnQgY2hpbGRWaWV3Q29udGFpbmVyCiAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2FkZCcsIHRoaXMuX29uQ29sbGVjdGlvbkFkZCk7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdyZW1vdmUnLCB0aGlzLl9vbkNvbGxlY3Rpb25SZW1vdmUpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAncmVzZXQnLCB0aGlzLl9yZW5kZXJDaGlsZHJlbik7CiAgICAgICAgaWYgKHRoaXMuc29ydCkgewogICAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdzb3J0JywgdGhpcy5fc29ydFZpZXdzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZXRyaWV2ZSB0aGUgYGNoaWxkVmlld2AgdG8gYmUgdXNlZCB3aGVuIHJlbmRlcmluZyBlYWNoIG9mCiAgICAvLyB0aGUgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGlzIHRvIHJldHVybgogICAgLy8gYHRoaXMuY2hpbGRWaWV3YCBvciBNYXJpb25ldHRlLkNvbXBvc2l0ZVZpZXcgaWYgbm8gYGNoaWxkVmlld2AKICAgIC8vIGhhcyBiZWVuIGRlZmluZWQKICAgIGdldENoaWxkVmlldzogZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgIHZhciBjaGlsZFZpZXcgPSB0aGlzLmdldE9wdGlvbignY2hpbGRWaWV3JykgfHwgdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgaWYgKCFjaGlsZFZpZXcpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnTm9DaGlsZFZpZXdFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQSAiY2hpbGRWaWV3IiBtdXN0IGJlIHNwZWNpZmllZCcKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gY2hpbGRWaWV3OwogICAgfSwKICAgIC8vIFNlcmlhbGl6ZSB0aGUgY29sbGVjdGlvbiBmb3IgdGhlIHZpZXcuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoZSBgc2VyaWFsaXplRGF0YWAgbWV0aG9kIGluIHlvdXIgb3duIHZpZXcKICAgIC8vIGRlZmluaXRpb24sIHRvIHByb3ZpZGUgY3VzdG9tIHNlcmlhbGl6YXRpb24gZm9yIHlvdXIgdmlldydzIGRhdGEuCiAgICBzZXJpYWxpemVEYXRhOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkYXRhID0ge307CiAgICAgIGlmICh0aGlzLm1vZGVsKSB7CiAgICAgICAgZGF0YSA9IF8ucGFydGlhbCh0aGlzLnNlcmlhbGl6ZU1vZGVsLCB0aGlzLm1vZGVsKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfSwKICAgIC8vIFJlbmRlcnMgdGhlIG1vZGVsIG9uY2UsIGFuZCB0aGUgY29sbGVjdGlvbiBvbmNlLiBDYWxsaW5nCiAgICAvLyB0aGlzIGFnYWluIHdpbGwgdGVsbCB0aGUgbW9kZWwncyB2aWV3IHRvIHJlLXJlbmRlciBpdHNlbGYKICAgIC8vIGJ1dCB0aGUgY29sbGVjdGlvbiB3aWxsIG5vdCByZS1yZW5kZXIuCiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fZW5zdXJlVmlld0lzSW50YWN0KCk7CiAgICAgIHRoaXMuaXNSZW5kZXJlZCA9IHRydWU7CiAgICAgIHRoaXMucmVzZXRDaGlsZFZpZXdDb250YWluZXIoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIF9yZW5kZXJDaGlsZHJlbjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5pc1JlbmRlcmVkKSB7CiAgICAgICAgTWFyaW9uZXR0ZS5Db2xsZWN0aW9uVmlldy5wcm90b3R5cGUuX3JlbmRlckNoaWxkcmVuLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZW5kZXIgdGhlIHJvb3QgdGVtcGxhdGUgdGhhdCB0aGUgY2hpbGRyZW4KICAgIC8vIHZpZXdzIGFyZSBhcHBlbmRlZCB0bwogICAgX3JlbmRlclRlbXBsYXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkYXRhID0ge307CiAgICAgIGRhdGEgPSB0aGlzLnNlcmlhbGl6ZURhdGEoKTsKICAgICAgZGF0YSA9IHRoaXMubWl4aW5UZW1wbGF0ZUhlbHBlcnMoZGF0YSk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbmRlcjp0ZW1wbGF0ZScpOwogICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLmdldFRlbXBsYXRlKCk7CiAgICAgIHZhciBodG1sID0gTWFyaW9uZXR0ZS5SZW5kZXJlci5yZW5kZXIodGVtcGxhdGUsIGRhdGEsIHRoaXMpOwogICAgICB0aGlzLmF0dGFjaEVsQ29udGVudChodG1sKTsKICAgICAgLy8gdGhlIHVpIGJpbmRpbmdzIGlzIGRvbmUgaGVyZSBhbmQgbm90IGF0IHRoZSBlbmQgb2YgcmVuZGVyIHNpbmNlIHRoZXkKICAgICAgLy8gd2lsbCBub3QgYmUgYXZhaWxhYmxlIHVudGlsIGFmdGVyIHRoZSBtb2RlbCBpcyByZW5kZXJlZCwgYnV0IHNob3VsZCBiZQogICAgICAvLyBhdmFpbGFibGUgYmVmb3JlIHRoZSBjb2xsZWN0aW9uIGlzIHJlbmRlcmVkLgogICAgICB0aGlzLmJpbmRVSUVsZW1lbnRzKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyOnRlbXBsYXRlJyk7CiAgICB9LAogICAgLy8gQXR0YWNoZXMgdGhlIGNvbnRlbnQgb2YgdGhlIHJvb3QuCiAgICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGRlbiB0byBvcHRpbWl6ZSByZW5kZXJpbmcsCiAgICAvLyBvciB0byByZW5kZXIgaW4gYSBub24gc3RhbmRhcmQgd2F5LgogICAgLy8KICAgIC8vIEZvciBleGFtcGxlLCB1c2luZyBgaW5uZXJIVE1MYCBpbnN0ZWFkIG9mIGAkZWwuaHRtbGAKICAgIC8vCiAgICAvLyBgYGBqcwogICAgLy8gYXR0YWNoRWxDb250ZW50OiBmdW5jdGlvbihodG1sKSB7CiAgICAvLyAgIHRoaXMuZWwuaW5uZXJIVE1MID0gaHRtbDsKICAgIC8vICAgcmV0dXJuIHRoaXM7CiAgICAvLyB9CiAgICAvLyBgYGAKICAgIGF0dGFjaEVsQ29udGVudDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdGhpcy4kZWwuaHRtbChodG1sKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gWW91IG1pZ2h0IG5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBpZiB5b3UndmUgb3ZlcnJpZGRlbiBhdHRhY2hIdG1sCiAgICBhdHRhY2hCdWZmZXI6IGZ1bmN0aW9uIChjb21wb3NpdGVWaWV3LCBidWZmZXIpIHsKICAgICAgdmFyICRjb250YWluZXIgPSB0aGlzLmdldENoaWxkVmlld0NvbnRhaW5lcihjb21wb3NpdGVWaWV3KTsKICAgICAgJGNvbnRhaW5lci5hcHBlbmQoYnVmZmVyKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QuIEFwcGVuZCBhIHZpZXcgdG8gdGhlIGVuZCBvZiB0aGUgJGVsLgogICAgLy8gT3ZlcmlkZGVuIGZyb20gQ29sbGVjdGlvblZpZXcgdG8gZW5zdXJlIHZpZXcgaXMgYXBwZW5kZWQgdG8KICAgIC8vIGNoaWxkVmlld0NvbnRhaW5lcgogICAgX2luc2VydEFmdGVyOiBmdW5jdGlvbiAoY2hpbGRWaWV3KSB7CiAgICAgIHZhciAkY29udGFpbmVyID0gdGhpcy5nZXRDaGlsZFZpZXdDb250YWluZXIodGhpcyk7CiAgICAgICRjb250YWluZXIuYXBwZW5kKGNoaWxkVmlldy5lbCk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGVuc3VyZSBhbiBgJGNoaWxkVmlld0NvbnRhaW5lcmAgZXhpc3RzLCBmb3IgdGhlCiAgICAvLyBgYXR0YWNoSHRtbGAgbWV0aG9kIHRvIHVzZS4KICAgIGdldENoaWxkVmlld0NvbnRhaW5lcjogZnVuY3Rpb24gKGNvbnRhaW5lclZpZXcpIHsKICAgICAgaWYgKCckY2hpbGRWaWV3Q29udGFpbmVyJyBpbiBjb250YWluZXJWaWV3KSB7CiAgICAgICAgcmV0dXJuIGNvbnRhaW5lclZpZXcuJGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgfQogICAgICB2YXIgY29udGFpbmVyOwogICAgICB2YXIgY2hpbGRWaWV3Q29udGFpbmVyID0gTWFyaW9uZXR0ZS5nZXRPcHRpb24oY29udGFpbmVyVmlldywgJ2NoaWxkVmlld0NvbnRhaW5lcicpOwogICAgICBpZiAoY2hpbGRWaWV3Q29udGFpbmVyKSB7CiAgICAgICAgdmFyIHNlbGVjdG9yID0gXy5pc0Z1bmN0aW9uKGNoaWxkVmlld0NvbnRhaW5lcikgPyBjaGlsZFZpZXdDb250YWluZXIuY2FsbChjb250YWluZXJWaWV3KSA6IGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgICBpZiAoc2VsZWN0b3IuY2hhckF0KDApID09PSAnQCcgJiYgY29udGFpbmVyVmlldy51aSkgewogICAgICAgICAgY29udGFpbmVyID0gY29udGFpbmVyVmlldy51aVtzZWxlY3Rvci5zdWJzdHIoNCldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250YWluZXIgPSBjb250YWluZXJWaWV3LiQoc2VsZWN0b3IpOwogICAgICAgIH0KICAgICAgICBpZiAoY29udGFpbmVyLmxlbmd0aCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICAgIG5hbWU6ICdDaGlsZFZpZXdDb250YWluZXJNaXNzaW5nRXJyb3InLAogICAgICAgICAgICBtZXNzYWdlOiAnVGhlIHNwZWNpZmllZCAiY2hpbGRWaWV3Q29udGFpbmVyIiB3YXMgbm90IGZvdW5kOiAnICsgY29udGFpbmVyVmlldy5jaGlsZFZpZXdDb250YWluZXIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb250YWluZXIgPSBjb250YWluZXJWaWV3LiRlbDsKICAgICAgfQogICAgICBjb250YWluZXJWaWV3LiRjaGlsZFZpZXdDb250YWluZXIgPSBjb250YWluZXI7CiAgICAgIHJldHVybiBjb250YWluZXI7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlc2V0IHRoZSBgJGNoaWxkVmlld0NvbnRhaW5lcmAgb24gcmVuZGVyCiAgICByZXNldENoaWxkVmlld0NvbnRhaW5lcjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy4kY2hpbGRWaWV3Q29udGFpbmVyKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuJGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgfQogICAgfQogIH0pOwogIC8vIExheW91dFZpZXcKICAvLyAtLS0tLS0tLS0tCiAgLy8gVXNlZCBmb3IgbWFuYWdpbmcgYXBwbGljYXRpb24gbGF5b3V0Vmlld3MsIG5lc3RlZCBsYXlvdXRWaWV3cyBhbmQKICAvLyBtdWx0aXBsZSByZWdpb25zIHdpdGhpbiBhbiBhcHBsaWNhdGlvbiBvciBzdWItYXBwbGljYXRpb24uCiAgLy8KICAvLyBBIHNwZWNpYWxpemVkIHZpZXcgY2xhc3MgdGhhdCByZW5kZXJzIGFuIGFyZWEgb2YgSFRNTCBhbmQgdGhlbgogIC8vIGF0dGFjaGVzIGBSZWdpb25gIGluc3RhbmNlcyB0byB0aGUgc3BlY2lmaWVkIGByZWdpb25zYC4KICAvLyBVc2VkIGZvciBjb21wb3NpdGUgdmlldyBtYW5hZ2VtZW50IGFuZCBzdWItYXBwbGljYXRpb24gYXJlYXMuCiAgTWFyaW9uZXR0ZS5MYXlvdXRWaWV3ID0gTWFyaW9uZXR0ZS5JdGVtVmlldy5leHRlbmQoewogICAgcmVnaW9uQ2xhc3M6IE1hcmlvbmV0dGUuUmVnaW9uLAogICAgLy8gRW5zdXJlIHRoZSByZWdpb25zIGFyZSBhdmFpbGFibGUgd2hlbiB0aGUgYGluaXRpYWxpemVgIG1ldGhvZAogICAgLy8gaXMgY2FsbGVkLgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLl9maXJzdFJlbmRlciA9IHRydWU7CiAgICAgIHRoaXMuX2luaXRpYWxpemVSZWdpb25zKG9wdGlvbnMpOwogICAgICBNYXJpb25ldHRlLkl0ZW1WaWV3LmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICB9LAogICAgLy8gTGF5b3V0VmlldydzIHJlbmRlciB3aWxsIHVzZSB0aGUgZXhpc3RpbmcgcmVnaW9uIG9iamVjdHMgdGhlCiAgICAvLyBmaXJzdCB0aW1lIGl0IGlzIGNhbGxlZC4gU3Vic2VxdWVudCBjYWxscyB3aWxsIGRlc3Ryb3kgdGhlCiAgICAvLyB2aWV3cyB0aGF0IHRoZSByZWdpb25zIGFyZSBzaG93aW5nIGFuZCB0aGVuIHJlc2V0IHRoZSBgZWxgCiAgICAvLyBmb3IgdGhlIHJlZ2lvbnMgdG8gdGhlIG5ld2x5IHJlbmRlcmVkIERPTSBlbGVtZW50cy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgaWYgKHRoaXMuX2ZpcnN0UmVuZGVyKSB7CiAgICAgICAgLy8gaWYgdGhpcyBpcyB0aGUgZmlyc3QgcmVuZGVyLCBkb24ndCBkbyBhbnl0aGluZyB0bwogICAgICAgIC8vIHJlc2V0IHRoZSByZWdpb25zCiAgICAgICAgdGhpcy5fZmlyc3RSZW5kZXIgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiB0aGlzIGlzIG5vdCB0aGUgZmlyc3QgcmVuZGVyIGNhbGwsIHRoZW4gd2UgbmVlZCB0bwogICAgICAgIC8vIHJlLWluaXRpYWxpemUgdGhlIGBlbGAgZm9yIGVhY2ggcmVnaW9uCiAgICAgICAgdGhpcy5fcmVJbml0aWFsaXplUmVnaW9ucygpOwogICAgICB9CiAgICAgIHJldHVybiBNYXJpb25ldHRlLkl0ZW1WaWV3LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAvLyBIYW5kbGUgZGVzdHJveWluZyByZWdpb25zLCBhbmQgdGhlbiBkZXN0cm95IHRoZSB2aWV3IGl0c2VsZi4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICB0aGlzLnJlZ2lvbk1hbmFnZXIuZGVzdHJveSgpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5JdGVtVmlldy5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEFkZCBhIHNpbmdsZSByZWdpb24sIGJ5IG5hbWUsIHRvIHRoZSBsYXlvdXRWaWV3CiAgICBhZGRSZWdpb246IGZ1bmN0aW9uIChuYW1lLCBkZWZpbml0aW9uKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlZ2lvbjphZGQnLCBuYW1lKTsKICAgICAgdmFyIHJlZ2lvbnMgPSB7fTsKICAgICAgcmVnaW9uc1tuYW1lXSA9IGRlZmluaXRpb247CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlZ2lvbnMocmVnaW9ucylbbmFtZV07CiAgICB9LAogICAgLy8gQWRkIG11bHRpcGxlIHJlZ2lvbnMgYXMgYSB7bmFtZTogZGVmaW5pdGlvbiwgbmFtZTI6IGRlZjJ9IG9iamVjdCBsaXRlcmFsCiAgICBhZGRSZWdpb25zOiBmdW5jdGlvbiAocmVnaW9ucykgewogICAgICB0aGlzLnJlZ2lvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5yZWdpb25zLCByZWdpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkUmVnaW9ucyhyZWdpb25zKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgYSBzaW5nbGUgcmVnaW9uIGZyb20gdGhlIExheW91dFZpZXcsIGJ5IG5hbWUKICAgIHJlbW92ZVJlZ2lvbjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVnaW9uOnJlbW92ZScsIG5hbWUpOwogICAgICBkZWxldGUgdGhpcy5yZWdpb25zW25hbWVdOwogICAgICByZXR1cm4gdGhpcy5yZWdpb25NYW5hZ2VyLnJlbW92ZVJlZ2lvbihuYW1lKTsKICAgIH0sCiAgICAvLyBQcm92aWRlcyBhbHRlcm5hdGl2ZSBhY2Nlc3MgdG8gcmVnaW9ucwogICAgLy8gQWNjZXB0cyB0aGUgcmVnaW9uIG5hbWUKICAgIC8vIGdldFJlZ2lvbignbWFpbicpCiAgICBnZXRSZWdpb246IGZ1bmN0aW9uIChyZWdpb24pIHsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5nZXQocmVnaW9uKTsKICAgIH0sCiAgICAvLyBHZXQgYWxsIHJlZ2lvbnMKICAgIGdldFJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5nZXRSZWdpb25zKCk7CiAgICB9LAogICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIGJ1aWxkIHJlZ2lvbnMKICAgIF9idWlsZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25zKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgdmFyIGRlZmF1bHRzID0gewogICAgICAgIHJlZ2lvbkNsYXNzOiB0aGlzLmdldE9wdGlvbigncmVnaW9uQ2xhc3MnKSwKICAgICAgICBwYXJlbnRFbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuJGVsOwogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5hZGRSZWdpb25zKHJlZ2lvbnMsIGRlZmF1bHRzKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaW5pdGlhbGl6ZSB0aGUgcmVnaW9ucyB0aGF0IGhhdmUgYmVlbiBkZWZpbmVkIGluIGEKICAgIC8vIGByZWdpb25zYCBhdHRyaWJ1dGUgb24gdGhpcyBsYXlvdXRWaWV3LgogICAgX2luaXRpYWxpemVSZWdpb25zOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgcmVnaW9uczsKICAgICAgdGhpcy5faW5pdFJlZ2lvbk1hbmFnZXIoKTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLnJlZ2lvbnMpKSB7CiAgICAgICAgcmVnaW9ucyA9IHRoaXMucmVnaW9ucyhvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWdpb25zID0gdGhpcy5yZWdpb25zIHx8IHt9OwogICAgICB9CiAgICAgIC8vIEVuYWJsZSB1c2VycyB0byBkZWZpbmUgYHJlZ2lvbnNgIGFzIGluc3RhbmNlIG9wdGlvbnMuCiAgICAgIHZhciByZWdpb25PcHRpb25zID0gdGhpcy5nZXRPcHRpb24uY2FsbChvcHRpb25zLCAncmVnaW9ucycpOwogICAgICAvLyBlbmFibGUgcmVnaW9uIG9wdGlvbnMgdG8gYmUgYSBmdW5jdGlvbgogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbk9wdGlvbnMpKSB7CiAgICAgICAgcmVnaW9uT3B0aW9ucyA9IHJlZ2lvbk9wdGlvbnMuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgICAgfQogICAgICBfLmV4dGVuZChyZWdpb25zLCByZWdpb25PcHRpb25zKTsKICAgICAgLy8gTm9ybWFsaXplIHJlZ2lvbiBzZWxlY3RvcnMgaGFzaCB0byBhbGxvdwogICAgICAvLyBhIHVzZXIgdG8gdXNlIHRoZSBAdWkuIHN5bnRheC4KICAgICAgcmVnaW9ucyA9IHRoaXMubm9ybWFsaXplVUlWYWx1ZXMocmVnaW9ucyk7CiAgICAgIHRoaXMuYWRkUmVnaW9ucyhyZWdpb25zKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gcmUtaW5pdGlhbGl6ZSBhbGwgb2YgdGhlIHJlZ2lvbnMgYnkgdXBkYXRpbmcgdGhlIGBlbGAgdGhhdAogICAgLy8gdGhleSBwb2ludCB0bwogICAgX3JlSW5pdGlhbGl6ZVJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5yZWdpb25NYW5hZ2VyLmVtcHR5UmVnaW9ucygpOwogICAgICB0aGlzLnJlZ2lvbk1hbmFnZXIuZWFjaChmdW5jdGlvbiAocmVnaW9uKSB7CiAgICAgICAgcmVnaW9uLnJlc2V0KCk7CiAgICAgIH0pOwogICAgfSwKICAgIC8vIEVuYWJsZSBlYXN5IG92ZXJyaWRpbmcgb2YgdGhlIGRlZmF1bHQgYFJlZ2lvbk1hbmFnZXJgCiAgICAvLyBmb3IgY3VzdG9taXplZCByZWdpb24gaW50ZXJhY3Rpb25zIGFuZCBidXNpbmVzcyBzcGVjaWZpYwogICAgLy8gdmlldyBsb2dpYyBmb3IgYmV0dGVyIGNvbnRyb2wgb3ZlciBzaW5nbGUgcmVnaW9ucy4KICAgIGdldFJlZ2lvbk1hbmFnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG5ldyBNYXJpb25ldHRlLlJlZ2lvbk1hbmFnZXIoKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaW5pdGlhbGl6ZSB0aGUgcmVnaW9uIG1hbmFnZXIKICAgIC8vIGFuZCBhbGwgcmVnaW9ucyBpbiBpdAogICAgX2luaXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMucmVnaW9uTWFuYWdlciA9IHRoaXMuZ2V0UmVnaW9uTWFuYWdlcigpOwogICAgICB0aGlzLmxpc3RlblRvKHRoaXMucmVnaW9uTWFuYWdlciwgJ2JlZm9yZTphZGQ6cmVnaW9uJywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6cmVnaW9uJywgbmFtZSk7CiAgICAgIH0pOwogICAgICB0aGlzLmxpc3RlblRvKHRoaXMucmVnaW9uTWFuYWdlciwgJ2FkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlZ2lvbk1hbmFnZXIsICdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUpOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlZ2lvbk1hbmFnZXIsICdyZW1vdmU6cmVnaW9uJywgZnVuY3Rpb24gKG5hbWUsIHJlZ2lvbikgewogICAgICAgIGRlbGV0ZSB0aGlzW25hbWVdOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgIH0pOwogICAgfQogIH0pOwogIC8vIEJlaGF2aW9yCiAgLy8gLS0tLS0tLS0tLS0KICAvLyBBIEJlaGF2aW9yIGlzIGFuIGlzb2xhdGVkIHNldCBvZiBET00gLwogIC8vIHVzZXIgaW50ZXJhY3Rpb25zIHRoYXQgY2FuIGJlIG1peGVkIGludG8gYW55IFZpZXcuCiAgLy8gQmVoYXZpb3JzIGFsbG93IHlvdSB0byBibGFja2JveCBWaWV3IHNwZWNpZmljIGludGVyYWN0aW9ucwogIC8vIGludG8gcG9ydGFibGUgbG9naWNhbCBjaHVua3MsIGtlZXBpbmcgeW91ciB2aWV3cyBzaW1wbGUgYW5kIHlvdXIgY29kZSBEUlkuCiAgTWFyaW9uZXR0ZS5CZWhhdmlvciA9IGZ1bmN0aW9uIChfLCBCYWNrYm9uZSkgewogICAgZnVuY3Rpb24gQmVoYXZpb3Iob3B0aW9ucywgdmlldykgewogICAgICAvLyBTZXR1cCByZWZlcmVuY2UgdG8gdGhlIHZpZXcuCiAgICAgIC8vIHRoaXMgY29tZXMgaW4gaGFuZGxlIHdoZW4gYSBiZWhhdmlvcgogICAgICAvLyB3YW50cyB0byBkaXJlY3RseSB0YWxrIHVwIHRoZSBjaGFpbgogICAgICAvLyB0byB0aGUgdmlldy4KICAgICAgdGhpcy52aWV3ID0gdmlldzsKICAgICAgdGhpcy5kZWZhdWx0cyA9IF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpIHx8IHt9OwogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5kZWZhdWx0cywgb3B0aW9ucyk7CiAgICAgIC8vIHByb3h5IGJlaGF2aW9yICQgbWV0aG9kIHRvIHRoZSB2aWV3CiAgICAgIC8vIHRoaXMgaXMgdXNlZnVsIGZvciBkb2luZyBqcXVlcnkgRE9NIGxvb2t1cHMKICAgICAgLy8gc2NvcGVkIHRvIGJlaGF2aW9ycyB2aWV3LgogICAgICB0aGlzLiQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy4kLmFwcGx5KHRoaXMudmlldywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgICAgLy8gQ2FsbCB0aGUgaW5pdGlhbGl6ZSBtZXRob2QgcGFzc2luZwogICAgICAvLyB0aGUgYXJndW1lbnRzIGZyb20gdGhlIGluc3RhbmNlIGNvbnN0cnVjdG9yCiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgXy5leHRlbmQoQmVoYXZpb3IucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICB9LAogICAgICAvLyBzdG9wTGlzdGVuaW5nIHRvIGJlaGF2aW9yIGBvbkxpc3RlbmAgZXZlbnRzLgogICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIH0sCiAgICAgIHByb3h5Vmlld1Byb3BlcnRpZXM6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgdGhpcy4kZWwgPSB2aWV3LiRlbDsKICAgICAgICB0aGlzLmVsID0gdmlldy5lbDsKICAgICAgfSwKICAgICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kLAogICAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgYmluZGluZyB2aWV3J3MgZXZlbnRzIGZyb20gYW5vdGhlciBlbnRpdHkuCiAgICAgIGJpbmRFbnRpdHlFdmVudHM6IE1hcmlvbmV0dGUucHJveHlCaW5kRW50aXR5RXZlbnRzLAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgICAgdW5iaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5VW5iaW5kRW50aXR5RXZlbnRzCiAgICB9KTsKICAgIC8vIEJvcnJvdyBCYWNrYm9uZXMgZXh0ZW5kIGltcGxlbWVudGF0aW9uCiAgICAvLyB0aGlzIGFsbG93cyB1cyB0byBzZXR1cCBhIHByb3BlcgogICAgLy8gaW5oZXJpdGFuY2UgcGF0dGVybiB0aGF0IGZvbGxvd3Mgc3VpdAogICAgLy8gd2l0aCB0aGUgcmVzdCBvZiBNYXJpb25ldHRlIHZpZXdzLgogICAgQmVoYXZpb3IuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgICByZXR1cm4gQmVoYXZpb3I7CiAgfShfLCBCYWNrYm9uZSk7CiAgLyoganNoaW50IG1heGxlbjogMTQzICovCiAgLy8gTWFyaW9uZXR0ZS5CZWhhdmlvcnMKICAvLyAtLS0tLS0tLQogIC8vIEJlaGF2aW9ycyBpcyBhIHV0aWxpdHkgY2xhc3MgdGhhdCB0YWtlcyBjYXJlIG9mCiAgLy8gZ2x1aW5nIHlvdXIgYmVoYXZpb3IgaW5zdGFuY2VzIHRvIHRoZWlyIGdpdmVuIFZpZXcuCiAgLy8gVGhlIG1vc3QgaW1wb3J0YW50IHBhcnQgb2YgdGhpcyBjbGFzcyBpcyB0aGF0IHlvdQogIC8vICoqTVVTVCoqIG92ZXJyaWRlIHRoZSBjbGFzcyBsZXZlbCBiZWhhdmlvcnNMb29rdXAKICAvLyBtZXRob2QgZm9yIHRoaW5ncyB0byB3b3JrIHByb3Blcmx5LgogIE1hcmlvbmV0dGUuQmVoYXZpb3JzID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUsIF8pIHsKICAgIGZ1bmN0aW9uIEJlaGF2aW9ycyh2aWV3LCBiZWhhdmlvcnMpIHsKICAgICAgaWYgKCFfLmlzT2JqZWN0KHZpZXcuYmVoYXZpb3JzKSkgewogICAgICAgIHJldHVybiB7fTsKICAgICAgfQogICAgICAvLyBCZWhhdmlvcnMgZGVmaW5lZCBvbiBhIHZpZXcgY2FuIGJlIGEgZmxhdCBvYmplY3QgbGl0ZXJhbAogICAgICAvLyBvciBpdCBjYW4gYmUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0LgogICAgICBiZWhhdmlvcnMgPSBCZWhhdmlvcnMucGFyc2VCZWhhdmlvcnModmlldywgYmVoYXZpb3JzIHx8IF8ucmVzdWx0KHZpZXcsICdiZWhhdmlvcnMnKSk7CiAgICAgIC8vIFdyYXBzIHNldmVyYWwgb2YgdGhlIHZpZXcncyBtZXRob2RzCiAgICAgIC8vIGNhbGxpbmcgdGhlIG1ldGhvZHMgZmlyc3Qgb24gZWFjaCBiZWhhdmlvcgogICAgICAvLyBhbmQgdGhlbiBldmVudHVhbGx5IGNhbGxpbmcgdGhlIG1ldGhvZCBvbiB0aGUgdmlldy4KICAgICAgQmVoYXZpb3JzLndyYXAodmlldywgYmVoYXZpb3JzLCBfLmtleXMobWV0aG9kcykpOwogICAgICByZXR1cm4gYmVoYXZpb3JzOwogICAgfQogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgIGJlaGF2aW9yVHJpZ2dlcnM6IGZ1bmN0aW9uIChiZWhhdmlvclRyaWdnZXJzLCBiZWhhdmlvcnMpIHsKICAgICAgICB2YXIgdHJpZ2dlckJ1aWxkZXIgPSBuZXcgQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIodGhpcywgYmVoYXZpb3JzKTsKICAgICAgICByZXR1cm4gdHJpZ2dlckJ1aWxkZXIuYnVpbGRCZWhhdmlvclRyaWdnZXJzKCk7CiAgICAgIH0sCiAgICAgIGJlaGF2aW9yRXZlbnRzOiBmdW5jdGlvbiAoYmVoYXZpb3JFdmVudHMsIGJlaGF2aW9ycykgewogICAgICAgIHZhciBfYmVoYXZpb3JzRXZlbnRzID0ge307CiAgICAgICAgdmFyIHZpZXdVSSA9IF8ucmVzdWx0KHRoaXMsICd1aScpOwogICAgICAgIF8uZWFjaChiZWhhdmlvcnMsIGZ1bmN0aW9uIChiLCBpKSB7CiAgICAgICAgICB2YXIgX2V2ZW50cyA9IHt9OwogICAgICAgICAgdmFyIGJlaGF2aW9yRXZlbnRzID0gXy5jbG9uZShfLnJlc3VsdChiLCAnZXZlbnRzJykpIHx8IHt9OwogICAgICAgICAgdmFyIGJlaGF2aW9yVUkgPSBfLnJlc3VsdChiLCAndWknKTsKICAgICAgICAgIC8vIENvbnN0cnVjdCBhbiBpbnRlcm5hbCBVSSBoYXNoIGZpcnN0IHVzaW5nCiAgICAgICAgICAvLyB0aGUgdmlld3MgVUkgaGFzaCBhbmQgdGhlbiB0aGUgYmVoYXZpb3JzIFVJIGhhc2guCiAgICAgICAgICAvLyBUaGlzIGFsbG93cyB0aGUgdXNlciB0byB1c2UgVUkgaGFzaCBlbGVtZW50cwogICAgICAgICAgLy8gZGVmaW5lZCBpbiB0aGUgcGFyZW50IHZpZXcgYXMgd2VsbCBhcyB0aG9zZQogICAgICAgICAgLy8gZGVmaW5lZCBpbiB0aGUgZ2l2ZW4gYmVoYXZpb3IuCiAgICAgICAgICB2YXIgdWkgPSBfLmV4dGVuZCh7fSwgdmlld1VJLCBiZWhhdmlvclVJKTsKICAgICAgICAgIC8vIE5vcm1hbGl6ZSBiZWhhdmlvciBldmVudHMgaGFzaCB0byBhbGxvdwogICAgICAgICAgLy8gYSB1c2VyIHRvIHVzZSB0aGUgQHVpLiBzeW50YXguCiAgICAgICAgICBiZWhhdmlvckV2ZW50cyA9IE1hcmlvbmV0dGUubm9ybWFsaXplVUlLZXlzKGJlaGF2aW9yRXZlbnRzLCB1aSk7CiAgICAgICAgICBfLmVhY2goXy5rZXlzKGJlaGF2aW9yRXZlbnRzKSwgZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAvLyBBcHBlbmQgd2hpdGUtc3BhY2UgYXQgdGhlIGVuZCBvZiBlYWNoIGtleSB0byBwcmV2ZW50IGJlaGF2aW9yIGtleSBjb2xsaXNpb25zLgogICAgICAgICAgICAvLyBUaGlzIGlzIHJlbHlpbmcgb24gdGhlIGZhY3QgdGhhdCBiYWNrYm9uZSBldmVudHMgY29uc2lkZXJzICJjbGljayAuZm9vIiB0aGUgc2FtZSBhcwogICAgICAgICAgICAvLyAiY2xpY2sgLmZvbyAiLgogICAgICAgICAgICAvLyArMiBpcyB1c2VkIGJlY2F1c2UgbmV3IEFycmF5KDEpIG9yIDAgaXMgIiIgYW5kIG5vdCAiICIKICAgICAgICAgICAgdmFyIHdoaXRlc3BhY2UgPSBuZXcgQXJyYXkoaSArIDIpLmpvaW4oJyAnKTsKICAgICAgICAgICAgdmFyIGV2ZW50S2V5ID0ga2V5ICsgd2hpdGVzcGFjZTsKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBfLmlzRnVuY3Rpb24oYmVoYXZpb3JFdmVudHNba2V5XSkgPyBiZWhhdmlvckV2ZW50c1trZXldIDogYltiZWhhdmlvckV2ZW50c1trZXldXTsKICAgICAgICAgICAgX2V2ZW50c1tldmVudEtleV0gPSBfLmJpbmQoaGFuZGxlciwgYik7CiAgICAgICAgICB9KTsKICAgICAgICAgIF9iZWhhdmlvcnNFdmVudHMgPSBfLmV4dGVuZChfYmVoYXZpb3JzRXZlbnRzLCBfZXZlbnRzKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gX2JlaGF2aW9yc0V2ZW50czsKICAgICAgfQogICAgfTsKICAgIF8uZXh0ZW5kKEJlaGF2aW9ycywgewogICAgICAvLyBQbGFjZWhvbGRlciBtZXRob2QgdG8gYmUgZXh0ZW5kZWQgYnkgdGhlIHVzZXIuCiAgICAgIC8vIFRoZSBtZXRob2Qgc2hvdWxkIGRlZmluZSB0aGUgb2JqZWN0IHRoYXQgc3RvcmVzIHRoZSBiZWhhdmlvcnMuCiAgICAgIC8vIGkuZS4KICAgICAgLy8KICAgICAgLy8gYGBganMKICAgICAgLy8gTWFyaW9uZXR0ZS5CZWhhdmlvcnMuYmVoYXZpb3JzTG9va3VwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gICByZXR1cm4gQXBwLkJlaGF2aW9ycwogICAgICAvLyB9CiAgICAgIC8vIGBgYAogICAgICBiZWhhdmlvcnNMb29rdXA6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBtZXNzYWdlOiAnWW91IG11c3QgZGVmaW5lIHdoZXJlIHlvdXIgYmVoYXZpb3JzIGFyZSBzdG9yZWQuJywKICAgICAgICAgIHVybDogJ21hcmlvbmV0dGUuYmVoYXZpb3JzLmh0bWwjYmVoYXZpb3JzbG9va3VwJwogICAgICAgIH0pOwogICAgICB9LAogICAgICAvLyBUYWtlcyBjYXJlIG9mIGdldHRpbmcgdGhlIGJlaGF2aW9yIGNsYXNzCiAgICAgIC8vIGdpdmVuIG9wdGlvbnMgYW5kIGEga2V5LgogICAgICAvLyBJZiBhIHVzZXIgcGFzc2VzIGluIG9wdGlvbnMuYmVoYXZpb3JDbGFzcwogICAgICAvLyBkZWZhdWx0IHRvIHVzaW5nIHRoYXQuIE90aGVyd2lzZSBkZWxlZ2F0ZQogICAgICAvLyB0aGUgbG9va3VwIHRvIHRoZSB1c2VycyBgYmVoYXZpb3JzTG9va3VwYCBpbXBsZW1lbnRhdGlvbi4KICAgICAgZ2V0QmVoYXZpb3JDbGFzczogZnVuY3Rpb24gKG9wdGlvbnMsIGtleSkgewogICAgICAgIGlmIChvcHRpb25zLmJlaGF2aW9yQ2xhc3MpIHsKICAgICAgICAgIHJldHVybiBvcHRpb25zLmJlaGF2aW9yQ2xhc3M7CiAgICAgICAgfQogICAgICAgIC8vIEdldCBiZWhhdmlvciBjbGFzcyBjYW4gYmUgZWl0aGVyIGEgZmxhdCBvYmplY3Qgb3IgYSBtZXRob2QKICAgICAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKEJlaGF2aW9ycy5iZWhhdmlvcnNMb29rdXApID8gQmVoYXZpb3JzLmJlaGF2aW9yc0xvb2t1cC5hcHBseSh0aGlzLCBhcmd1bWVudHMpW2tleV0gOiBCZWhhdmlvcnMuYmVoYXZpb3JzTG9va3VwW2tleV07CiAgICAgIH0sCiAgICAgIC8vIEl0ZXJhdGUgb3ZlciB0aGUgYmVoYXZpb3JzIG9iamVjdCwgZm9yIGVhY2ggYmVoYXZpb3IKICAgICAgLy8gaW5zdGFudGlhdGUgaXQgYW5kIGdldCBpdHMgZ3JvdXBlZCBiZWhhdmlvcnMuCiAgICAgIHBhcnNlQmVoYXZpb3JzOiBmdW5jdGlvbiAodmlldywgYmVoYXZpb3JzKSB7CiAgICAgICAgcmV0dXJuIF8uY2hhaW4oYmVoYXZpb3JzKS5tYXAoZnVuY3Rpb24gKG9wdGlvbnMsIGtleSkgewogICAgICAgICAgdmFyIEJlaGF2aW9yQ2xhc3MgPSBCZWhhdmlvcnMuZ2V0QmVoYXZpb3JDbGFzcyhvcHRpb25zLCBrZXkpOwogICAgICAgICAgdmFyIGJlaGF2aW9yID0gbmV3IEJlaGF2aW9yQ2xhc3Mob3B0aW9ucywgdmlldyk7CiAgICAgICAgICB2YXIgbmVzdGVkQmVoYXZpb3JzID0gQmVoYXZpb3JzLnBhcnNlQmVoYXZpb3JzKHZpZXcsIF8ucmVzdWx0KGJlaGF2aW9yLCAnYmVoYXZpb3JzJykpOwogICAgICAgICAgcmV0dXJuIFtiZWhhdmlvcl0uY29uY2F0KG5lc3RlZEJlaGF2aW9ycyk7CiAgICAgICAgfSkuZmxhdHRlbigpLnZhbHVlKCk7CiAgICAgIH0sCiAgICAgIC8vIFdyYXAgdmlldyBpbnRlcm5hbCBtZXRob2RzIHNvIHRoYXQgdGhleSBkZWxlZ2F0ZSB0byBiZWhhdmlvcnMuIEZvciBleGFtcGxlLAogICAgICAvLyBgb25EZXN0cm95YCBzaG91bGQgdHJpZ2dlciBkZXN0cm95IG9uIGFsbCBvZiB0aGUgYmVoYXZpb3JzIGFuZCB0aGVuIGRlc3Ryb3kgaXRzZWxmLgogICAgICAvLyBpLmUuCiAgICAgIC8vCiAgICAgIC8vIGB2aWV3LmRlbGVnYXRlRXZlbnRzID0gXy5wYXJ0aWFsKG1ldGhvZHMuZGVsZWdhdGVFdmVudHMsIHZpZXcuZGVsZWdhdGVFdmVudHMsIGJlaGF2aW9ycyk7YAogICAgICB3cmFwOiBmdW5jdGlvbiAodmlldywgYmVoYXZpb3JzLCBtZXRob2ROYW1lcykgewogICAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHZpZXdbbWV0aG9kTmFtZV0gPSBfLnBhcnRpYWwobWV0aG9kc1ttZXRob2ROYW1lXSwgdmlld1ttZXRob2ROYW1lXSwgYmVoYXZpb3JzKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICAvLyBDbGFzcyB0byBidWlsZCBoYW5kbGVycyBmb3IgYHRyaWdnZXJzYCBvbiBiZWhhdmlvcnMKICAgIC8vIGZvciB2aWV3cwogICAgZnVuY3Rpb24gQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIodmlldywgYmVoYXZpb3JzKSB7CiAgICAgIHRoaXMuX3ZpZXcgPSB2aWV3OwogICAgICB0aGlzLl92aWV3VUkgPSBfLnJlc3VsdCh2aWV3LCAndWknKTsKICAgICAgdGhpcy5fYmVoYXZpb3JzID0gYmVoYXZpb3JzOwogICAgICB0aGlzLl90cmlnZ2VycyA9IHt9OwogICAgfQogICAgXy5leHRlbmQoQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIucHJvdG90eXBlLCB7CiAgICAgIC8vIE1haW4gbWV0aG9kIHRvIGJ1aWxkIHRoZSB0cmlnZ2VycyBoYXNoIHdpdGggZXZlbnQga2V5cyBhbmQgaGFuZGxlcnMKICAgICAgYnVpbGRCZWhhdmlvclRyaWdnZXJzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgdGhpcy5fYnVpbGRUcmlnZ2VySGFuZGxlcnNGb3JCZWhhdmlvciwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3RyaWdnZXJzOwogICAgICB9LAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gYnVpbGQgYWxsIHRyaWdnZXIgaGFuZGxlcnMgZm9yIGEgZ2l2ZW4gYmVoYXZpb3IKICAgICAgX2J1aWxkVHJpZ2dlckhhbmRsZXJzRm9yQmVoYXZpb3I6IGZ1bmN0aW9uIChiZWhhdmlvciwgaSkgewogICAgICAgIHZhciB1aSA9IF8uZXh0ZW5kKHt9LCB0aGlzLl92aWV3VUksIF8ucmVzdWx0KGJlaGF2aW9yLCAndWknKSk7CiAgICAgICAgdmFyIHRyaWdnZXJzSGFzaCA9IF8uY2xvbmUoXy5yZXN1bHQoYmVoYXZpb3IsICd0cmlnZ2VycycpKSB8fCB7fTsKICAgICAgICB0cmlnZ2Vyc0hhc2ggPSBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJS2V5cyh0cmlnZ2Vyc0hhc2gsIHVpKTsKICAgICAgICBfLmVhY2godHJpZ2dlcnNIYXNoLCBfLnBhcnRpYWwodGhpcy5fc2V0SGFuZGxlckZvckJlaGF2aW9yLCBiZWhhdmlvciwgaSksIHRoaXMpOwogICAgICB9LAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGFuZCBhc3NpZ24gdGhlIHRyaWdnZXIgaGFuZGxlciBmb3IgYSBnaXZlbgogICAgICAvLyBiZWhhdmlvcgogICAgICBfc2V0SGFuZGxlckZvckJlaGF2aW9yOiBmdW5jdGlvbiAoYmVoYXZpb3IsIGksIGV2ZW50TmFtZSwgdHJpZ2dlcikgewogICAgICAgIC8vIFVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgYHRoaXMuX3RyaWdnZXJzYCBoYXNoCiAgICAgICAgdmFyIHRyaWdnZXJLZXkgPSB0cmlnZ2VyLnJlcGxhY2UoL15cUysvLCBmdW5jdGlvbiAodHJpZ2dlck5hbWUpIHsKICAgICAgICAgIHJldHVybiB0cmlnZ2VyTmFtZSArICcuJyArICdiZWhhdmlvcnRyaWdnZXJzJyArIGk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5fdHJpZ2dlcnNbdHJpZ2dlcktleV0gPSB0aGlzLl92aWV3Ll9idWlsZFZpZXdUcmlnZ2VyKGV2ZW50TmFtZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIEJlaGF2aW9yczsKICB9KE1hcmlvbmV0dGUsIF8pOwogIC8vIEFwcFJvdXRlcgogIC8vIC0tLS0tLS0tLQogIC8vIFJlZHVjZSB0aGUgYm9pbGVycGxhdGUgY29kZSBvZiBoYW5kbGluZyByb3V0ZSBldmVudHMKICAvLyBhbmQgdGhlbiBjYWxsaW5nIGEgc2luZ2xlIG1ldGhvZCBvbiBhbm90aGVyIG9iamVjdC4KICAvLyBIYXZlIHlvdXIgcm91dGVycyBjb25maWd1cmVkIHRvIGNhbGwgdGhlIG1ldGhvZCBvbgogIC8vIHlvdXIgb2JqZWN0LCBkaXJlY3RseS4KICAvLwogIC8vIENvbmZpZ3VyZSBhbiBBcHBSb3V0ZXIgd2l0aCBgYXBwUm91dGVzYC4KICAvLwogIC8vIEFwcCByb3V0ZXJzIGNhbiBvbmx5IHRha2Ugb25lIGBjb250cm9sbGVyYCBvYmplY3QuCiAgLy8gSXQgaXMgcmVjb21tZW5kZWQgdGhhdCB5b3UgZGl2aWRlIHlvdXIgY29udHJvbGxlcgogIC8vIG9iamVjdHMgaW4gdG8gc21hbGxlciBwaWVjZXMgb2YgcmVsYXRlZCBmdW5jdGlvbmFsaXR5CiAgLy8gYW5kIGhhdmUgbXVsdGlwbGUgcm91dGVycyAvIGNvbnRyb2xsZXJzLCBpbnN0ZWFkIG9mCiAgLy8ganVzdCBvbmUgZ2lhbnQgcm91dGVyIGFuZCBjb250cm9sbGVyLgogIC8vCiAgLy8gWW91IGNhbiBhbHNvIGFkZCBzdGFuZGFyZCByb3V0ZXMgdG8gYW4gQXBwUm91dGVyLgogIE1hcmlvbmV0dGUuQXBwUm91dGVyID0gQmFja2JvbmUuUm91dGVyLmV4dGVuZCh7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuUm91dGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciBhcHBSb3V0ZXMgPSB0aGlzLmdldE9wdGlvbignYXBwUm91dGVzJyk7CiAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5fZ2V0Q29udHJvbGxlcigpOwogICAgICB0aGlzLnByb2Nlc3NBcHBSb3V0ZXMoY29udHJvbGxlciwgYXBwUm91dGVzKTsKICAgICAgdGhpcy5vbigncm91dGUnLCB0aGlzLl9wcm9jZXNzT25Sb3V0ZSwgdGhpcyk7CiAgICB9LAogICAgLy8gU2ltaWxhciB0byByb3V0ZSBtZXRob2Qgb24gYSBCYWNrYm9uZSBSb3V0ZXIgYnV0CiAgICAvLyBtZXRob2QgaXMgY2FsbGVkIG9uIHRoZSBjb250cm9sbGVyCiAgICBhcHBSb3V0ZTogZnVuY3Rpb24gKHJvdXRlLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5fZ2V0Q29udHJvbGxlcigpOwogICAgICB0aGlzLl9hZGRBcHBSb3V0ZShjb250cm9sbGVyLCByb3V0ZSwgbWV0aG9kTmFtZSk7CiAgICB9LAogICAgLy8gcHJvY2VzcyB0aGUgcm91dGUgZXZlbnQgYW5kIHRyaWdnZXIgdGhlIG9uUm91dGUKICAgIC8vIG1ldGhvZCBjYWxsLCBpZiBpdCBleGlzdHMKICAgIF9wcm9jZXNzT25Sb3V0ZTogZnVuY3Rpb24gKHJvdXRlTmFtZSwgcm91dGVBcmdzKSB7CiAgICAgIC8vIGZpbmQgdGhlIHBhdGggdGhhdCBtYXRjaGVkCiAgICAgIHZhciByb3V0ZVBhdGggPSBfLmludmVydCh0aGlzLmdldE9wdGlvbignYXBwUm91dGVzJykpW3JvdXRlTmFtZV07CiAgICAgIC8vIG1ha2Ugc3VyZSBhbiBvblJvdXRlIGlzIHRoZXJlLCBhbmQgY2FsbCBpdAogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMub25Sb3V0ZSkpIHsKICAgICAgICB0aGlzLm9uUm91dGUocm91dGVOYW1lLCByb3V0ZVBhdGgsIHJvdXRlQXJncyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gcHJvY2VzcyB0aGUgYGFwcFJvdXRlc2AgZm9yIHRoZQogICAgLy8gcm91dGVyLCBhbmQgdHVybiB0aGVtIGluIHRvIHJvdXRlcyB0aGF0IHRyaWdnZXIgdGhlCiAgICAvLyBzcGVjaWZpZWQgbWV0aG9kIG9uIHRoZSBzcGVjaWZpZWQgYGNvbnRyb2xsZXJgLgogICAgcHJvY2Vzc0FwcFJvdXRlczogZnVuY3Rpb24gKGNvbnRyb2xsZXIsIGFwcFJvdXRlcykgewogICAgICBpZiAoIWFwcFJvdXRlcykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgcm91dGVOYW1lcyA9IF8ua2V5cyhhcHBSb3V0ZXMpLnJldmVyc2UoKTsKICAgICAgLy8gQmFja2JvbmUgcmVxdWlyZXMgcmV2ZXJ0ZWQgb3JkZXIgb2Ygcm91dGVzCiAgICAgIF8uZWFjaChyb3V0ZU5hbWVzLCBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgICB0aGlzLl9hZGRBcHBSb3V0ZShjb250cm9sbGVyLCByb3V0ZSwgYXBwUm91dGVzW3JvdXRlXSk7CiAgICAgIH0sIHRoaXMpOwogICAgfSwKICAgIF9nZXRDb250cm9sbGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldE9wdGlvbignY29udHJvbGxlcicpOwogICAgfSwKICAgIF9hZGRBcHBSb3V0ZTogZnVuY3Rpb24gKGNvbnRyb2xsZXIsIHJvdXRlLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBtZXRob2QgPSBjb250cm9sbGVyW21ldGhvZE5hbWVdOwogICAgICBpZiAoIW1ldGhvZCkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKCdNZXRob2QgIicgKyBtZXRob2ROYW1lICsgJyIgd2FzIG5vdCBmb3VuZCBvbiB0aGUgY29udHJvbGxlcicpOwogICAgICB9CiAgICAgIHRoaXMucm91dGUocm91dGUsIG1ldGhvZE5hbWUsIF8uYmluZChtZXRob2QsIGNvbnRyb2xsZXIpKTsKICAgIH0sCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIEFwcGxpY2F0aW9uCiAgLy8gLS0tLS0tLS0tLS0KICAvLyBDb250YWluIGFuZCBtYW5hZ2UgdGhlIGNvbXBvc2l0ZSBhcHBsaWNhdGlvbiBhcyBhIHdob2xlLgogIC8vIFN0b3JlcyBhbmQgc3RhcnRzIHVwIGBSZWdpb25gIG9iamVjdHMsIGluY2x1ZGVzIGFuCiAgLy8gZXZlbnQgYWdncmVnYXRvciBhcyBgYXBwLnZlbnRgCiAgTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbiA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy5faW5pdGlhbGl6ZVJlZ2lvbnMob3B0aW9ucyk7CiAgICB0aGlzLl9pbml0Q2FsbGJhY2tzID0gbmV3IE1hcmlvbmV0dGUuQ2FsbGJhY2tzKCk7CiAgICB0aGlzLnN1Ym1vZHVsZXMgPSB7fTsKICAgIF8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgdGhpcy5faW5pdENoYW5uZWwoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbi5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICAvLyBDb21tYW5kIGV4ZWN1dGlvbiwgZmFjaWxpdGF0ZWQgYnkgQmFja2JvbmUuV3JlcXIuQ29tbWFuZHMKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jb21tYW5kcy5leGVjdXRlLmFwcGx5KHRoaXMuY29tbWFuZHMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gUmVxdWVzdC9yZXNwb25zZSwgZmFjaWxpdGF0ZWQgYnkgQmFja2JvbmUuV3JlcXIuUmVxdWVzdFJlc3BvbnNlCiAgICByZXF1ZXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcXJlcy5yZXF1ZXN0LmFwcGx5KHRoaXMucmVxcmVzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEFkZCBhbiBpbml0aWFsaXplciB0aGF0IGlzIGVpdGhlciBydW4gYXQgd2hlbiB0aGUgYHN0YXJ0YAogICAgLy8gbWV0aG9kIGlzIGNhbGxlZCwgb3IgcnVuIGltbWVkaWF0ZWx5IGlmIGFkZGVkIGFmdGVyIGBzdGFydGAKICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gY2FsbGVkLgogICAgYWRkSW5pdGlhbGl6ZXI6IGZ1bmN0aW9uIChpbml0aWFsaXplcikgewogICAgICB0aGlzLl9pbml0Q2FsbGJhY2tzLmFkZChpbml0aWFsaXplcik7CiAgICB9LAogICAgLy8ga2ljayBvZmYgYWxsIG9mIHRoZSBhcHBsaWNhdGlvbidzIHByb2Nlc3Nlcy4KICAgIC8vIGluaXRpYWxpemVzIGFsbCBvZiB0aGUgcmVnaW9ucyB0aGF0IGhhdmUgYmVlbiBhZGRlZAogICAgLy8gdG8gdGhlIGFwcCwgYW5kIHJ1bnMgYWxsIG9mIHRoZSBpbml0aWFsaXplciBmdW5jdGlvbnMKICAgIHN0YXJ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzdGFydCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9pbml0Q2FsbGJhY2tzLnJ1bihvcHRpb25zLCB0aGlzKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzdGFydCcsIG9wdGlvbnMpOwogICAgfSwKICAgIC8vIEFkZCByZWdpb25zIHRvIHlvdXIgYXBwLgogICAgLy8gQWNjZXB0cyBhIGhhc2ggb2YgbmFtZWQgc3RyaW5ncyBvciBSZWdpb24gb2JqZWN0cwogICAgLy8gYWRkUmVnaW9ucyh7c29tZXRoaW5nOiAiI3NvbWVSZWdpb24ifSkKICAgIC8vIGFkZFJlZ2lvbnMoe3NvbWV0aGluZzogUmVnaW9uLmV4dGVuZCh7ZWw6ICIjc29tZVJlZ2lvbiJ9KSB9KTsKICAgIGFkZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmFkZFJlZ2lvbnMocmVnaW9ucyk7CiAgICB9LAogICAgLy8gRW1wdHkgYWxsIHJlZ2lvbnMgaW4gdGhlIGFwcCwgd2l0aG91dCByZW1vdmluZyB0aGVtCiAgICBlbXB0eVJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lvbk1hbmFnZXIuZW1wdHlSZWdpb25zKCk7CiAgICB9LAogICAgLy8gUmVtb3ZlcyBhIHJlZ2lvbiBmcm9tIHlvdXIgYXBwLCBieSBuYW1lCiAgICAvLyBBY2NlcHRzIHRoZSByZWdpb25zIG5hbWUKICAgIC8vIHJlbW92ZVJlZ2lvbignbXlSZWdpb24nKQogICAgcmVtb3ZlUmVnaW9uOiBmdW5jdGlvbiAocmVnaW9uKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLnJlbW92ZVJlZ2lvbihyZWdpb24pOwogICAgfSwKICAgIC8vIFByb3ZpZGVzIGFsdGVybmF0aXZlIGFjY2VzcyB0byByZWdpb25zCiAgICAvLyBBY2NlcHRzIHRoZSByZWdpb24gbmFtZQogICAgLy8gZ2V0UmVnaW9uKCdtYWluJykKICAgIGdldFJlZ2lvbjogZnVuY3Rpb24gKHJlZ2lvbikgewogICAgICByZXR1cm4gdGhpcy5fcmVnaW9uTWFuYWdlci5nZXQocmVnaW9uKTsKICAgIH0sCiAgICAvLyBHZXQgYWxsIHRoZSByZWdpb25zIGZyb20gdGhlIHJlZ2lvbiBtYW5hZ2VyCiAgICBnZXRSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmdldFJlZ2lvbnMoKTsKICAgIH0sCiAgICAvLyBDcmVhdGUgYSBtb2R1bGUsIGF0dGFjaGVkIHRvIHRoZSBhcHBsaWNhdGlvbgogICAgbW9kdWxlOiBmdW5jdGlvbiAobW9kdWxlTmFtZXMsIG1vZHVsZURlZmluaXRpb24pIHsKICAgICAgLy8gT3ZlcndyaXRlIHRoZSBtb2R1bGUgY2xhc3MgaWYgdGhlIHVzZXIgc3BlY2lmaWVzIG9uZQogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSBNYXJpb25ldHRlLk1vZHVsZS5nZXRDbGFzcyhtb2R1bGVEZWZpbml0aW9uKTsKICAgICAgLy8gc2xpY2UgdGhlIGFyZ3MsIGFuZCBhZGQgdGhpcyBhcHBsaWNhdGlvbiBvYmplY3QgYXMgdGhlCiAgICAgIC8vIGZpcnN0IGFyZ3VtZW50IG9mIHRoZSBhcnJheQogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgYXJncy51bnNoaWZ0KHRoaXMpOwogICAgICAvLyBzZWUgdGhlIE1hcmlvbmV0dGUuTW9kdWxlIG9iamVjdCBmb3IgbW9yZSBpbmZvcm1hdGlvbgogICAgICByZXR1cm4gTW9kdWxlQ2xhc3MuY3JlYXRlLmFwcGx5KE1vZHVsZUNsYXNzLCBhcmdzKTsKICAgIH0sCiAgICAvLyBFbmFibGUgZWFzeSBvdmVycmlkaW5nIG9mIHRoZSBkZWZhdWx0IGBSZWdpb25NYW5hZ2VyYAogICAgLy8gZm9yIGN1c3RvbWl6ZWQgcmVnaW9uIGludGVyYWN0aW9ucyBhbmQgYnVzaW5lc3Mtc3BlY2lmaWMKICAgIC8vIHZpZXcgbG9naWMgZm9yIGJldHRlciBjb250cm9sIG92ZXIgc2luZ2xlIHJlZ2lvbnMuCiAgICBnZXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyKCk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGluaXRpYWxpemUgdGhlIHJlZ2lvbnMgdGhhdCBoYXZlIGJlZW4gZGVmaW5lZCBpbiBhCiAgICAvLyBgcmVnaW9uc2AgYXR0cmlidXRlIG9uIHRoZSBhcHBsaWNhdGlvbiBpbnN0YW5jZQogICAgX2luaXRpYWxpemVSZWdpb25zOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgcmVnaW9ucyA9IF8uaXNGdW5jdGlvbih0aGlzLnJlZ2lvbnMpID8gdGhpcy5yZWdpb25zKG9wdGlvbnMpIDogdGhpcy5yZWdpb25zIHx8IHt9OwogICAgICB0aGlzLl9pbml0UmVnaW9uTWFuYWdlcigpOwogICAgICAvLyBFbmFibGUgdXNlcnMgdG8gZGVmaW5lIGByZWdpb25zYCBpbiBpbnN0YW5jZSBvcHRpb25zLgogICAgICB2YXIgb3B0aW9uUmVnaW9ucyA9IE1hcmlvbmV0dGUuZ2V0T3B0aW9uKG9wdGlvbnMsICdyZWdpb25zJyk7CiAgICAgIC8vIEVuYWJsZSByZWdpb24gb3B0aW9ucyB0byBiZSBhIGZ1bmN0aW9uCiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob3B0aW9uUmVnaW9ucykpIHsKICAgICAgICBvcHRpb25SZWdpb25zID0gb3B0aW9uUmVnaW9ucy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIC8vIE92ZXJ3cml0ZSBjdXJyZW50IHJlZ2lvbnMgd2l0aCB0aG9zZSBwYXNzZWQgaW4gb3B0aW9ucwogICAgICBfLmV4dGVuZChyZWdpb25zLCBvcHRpb25SZWdpb25zKTsKICAgICAgdGhpcy5hZGRSZWdpb25zKHJlZ2lvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V0IHVwIHRoZSByZWdpb24gbWFuYWdlcgogICAgX2luaXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3JlZ2lvbk1hbmFnZXIgPSB0aGlzLmdldFJlZ2lvbk1hbmFnZXIoKTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOmFkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmFkZDpyZWdpb24nLCBuYW1lKTsKICAgICAgfSk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5fcmVnaW9uTWFuYWdlciwgJ2FkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBuYW1lKTsKICAgICAgfSk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5fcmVnaW9uTWFuYWdlciwgJ3JlbW92ZTpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgZGVsZXRlIHRoaXNbbmFtZV07CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6cmVnaW9uJywgbmFtZSwgcmVnaW9uKTsKICAgICAgfSk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNldHVwIHRoZSBXcmVxci5yYWRpbyBjaGFubmVsCiAgICBfaW5pdENoYW5uZWw6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jaGFubmVsTmFtZSA9IF8ucmVzdWx0KHRoaXMsICdjaGFubmVsTmFtZScpIHx8ICdnbG9iYWwnOwogICAgICB0aGlzLmNoYW5uZWwgPSBfLnJlc3VsdCh0aGlzLCAnY2hhbm5lbCcpIHx8IEJhY2tib25lLldyZXFyLnJhZGlvLmNoYW5uZWwodGhpcy5jaGFubmVsTmFtZSk7CiAgICAgIHRoaXMudmVudCA9IF8ucmVzdWx0KHRoaXMsICd2ZW50JykgfHwgdGhpcy5jaGFubmVsLnZlbnQ7CiAgICAgIHRoaXMuY29tbWFuZHMgPSBfLnJlc3VsdCh0aGlzLCAnY29tbWFuZHMnKSB8fCB0aGlzLmNoYW5uZWwuY29tbWFuZHM7CiAgICAgIHRoaXMucmVxcmVzID0gXy5yZXN1bHQodGhpcywgJ3JlcXJlcycpIHx8IHRoaXMuY2hhbm5lbC5yZXFyZXM7CiAgICB9LAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIENvcHkgdGhlIGBleHRlbmRgIGZ1bmN0aW9uIHVzZWQgYnkgQmFja2JvbmUncyBjbGFzc2VzCiAgTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbi5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA5ICovCiAgLy8gTW9kdWxlCiAgLy8gLS0tLS0tCiAgLy8gQSBzaW1wbGUgbW9kdWxlIHN5c3RlbSwgdXNlZCB0byBjcmVhdGUgcHJpdmFjeSBhbmQgZW5jYXBzdWxhdGlvbiBpbgogIC8vIE1hcmlvbmV0dGUgYXBwbGljYXRpb25zCiAgTWFyaW9uZXR0ZS5Nb2R1bGUgPSBmdW5jdGlvbiAobW9kdWxlTmFtZSwgYXBwLCBvcHRpb25zKSB7CiAgICB0aGlzLm1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lOwogICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CiAgICAvLyBBbGxvdyBmb3IgYSB1c2VyIHRvIG92ZXJpZGUgdGhlIGluaXRpYWxpemUKICAgIC8vIGZvciBhIGdpdmVuIG1vZHVsZSBpbnN0YW5jZS4KICAgIHRoaXMuaW5pdGlhbGl6ZSA9IG9wdGlvbnMuaW5pdGlhbGl6ZSB8fCB0aGlzLmluaXRpYWxpemU7CiAgICAvLyBTZXQgdXAgYW4gaW50ZXJuYWwgc3RvcmUgZm9yIHN1Yi1tb2R1bGVzLgogICAgdGhpcy5zdWJtb2R1bGVzID0ge307CiAgICB0aGlzLl9zZXR1cEluaXRpYWxpemVyc0FuZEZpbmFsaXplcnMoKTsKICAgIC8vIFNldCBhbiBpbnRlcm5hbCByZWZlcmVuY2UgdG8gdGhlIGFwcAogICAgLy8gd2l0aGluIGEgbW9kdWxlLgogICAgdGhpcy5hcHAgPSBhcHA7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgdGhpcy5pbml0aWFsaXplKG1vZHVsZU5hbWUsIGFwcCwgdGhpcy5vcHRpb25zKTsKICAgIH0KICB9OwogIE1hcmlvbmV0dGUuTW9kdWxlLmV4dGVuZCA9IE1hcmlvbmV0dGUuZXh0ZW5kOwogIC8vIEV4dGVuZCB0aGUgTW9kdWxlIHByb3RvdHlwZSB3aXRoIGV2ZW50cyAvIGxpc3RlblRvLCBzbyB0aGF0IHRoZSBtb2R1bGUKICAvLyBjYW4gYmUgdXNlZCBhcyBhbiBldmVudCBhZ2dyZWdhdG9yIG9yIHB1Yi9zdWIuCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5Nb2R1bGUucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgIC8vIEJ5IGRlZmF1bHQgbW9kdWxlcyBzdGFydCB3aXRoIHRoZWlyIHBhcmVudHMuCiAgICBzdGFydFdpdGhQYXJlbnQ6IHRydWUsCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljIHdoZW4gZXh0ZW5kaW5nIE1hcmlvbmV0dGUuTW9kdWxlLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgfSwKICAgIC8vIEluaXRpYWxpemVyIGZvciBhIHNwZWNpZmljIG1vZHVsZS4gSW5pdGlhbGl6ZXJzIGFyZSBydW4gd2hlbiB0aGUKICAgIC8vIG1vZHVsZSdzIGBzdGFydGAgbWV0aG9kIGlzIGNhbGxlZC4KICAgIGFkZEluaXRpYWxpemVyOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgdGhpcy5faW5pdGlhbGl6ZXJDYWxsYmFja3MuYWRkKGNhbGxiYWNrKTsKICAgIH0sCiAgICAvLyBGaW5hbGl6ZXJzIGFyZSBydW4gd2hlbiBhIG1vZHVsZSBpcyBzdG9wcGVkLiBUaGV5IGFyZSB1c2VkIHRvIHRlYXJkb3duCiAgICAvLyBhbmQgZmluYWxpemUgYW55IHZhcmlhYmxlcywgcmVmZXJlbmNlcywgZXZlbnRzIGFuZCBvdGhlciBjb2RlIHRoYXQgdGhlCiAgICAvLyBtb2R1bGUgaGFkIHNldCB1cC4KICAgIGFkZEZpbmFsaXplcjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5hZGQoY2FsbGJhY2spOwogICAgfSwKICAgIC8vIFN0YXJ0IHRoZSBtb2R1bGUsIGFuZCBydW4gYWxsIG9mIGl0cyBpbml0aWFsaXplcnMKICAgIHN0YXJ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAvLyBQcmV2ZW50IHJlLXN0YXJ0aW5nIGEgbW9kdWxlIHRoYXQgaXMgYWxyZWFkeSBzdGFydGVkCiAgICAgIGlmICh0aGlzLl9pc0luaXRpYWxpemVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIHN0YXJ0IHRoZSBzdWItbW9kdWxlcyAoZGVwdGgtZmlyc3QgaGllcmFyY2h5KQogICAgICBfLmVhY2godGhpcy5zdWJtb2R1bGVzLCBmdW5jdGlvbiAobW9kKSB7CiAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHdlIHNob3VsZCBzdGFydCB0aGUgc3ViLW1vZHVsZSB3aXRoIHRoaXMgcGFyZW50CiAgICAgICAgaWYgKG1vZC5zdGFydFdpdGhQYXJlbnQpIHsKICAgICAgICAgIG1vZC5zdGFydChvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBydW4gdGhlIGNhbGxiYWNrcyB0byAic3RhcnQiIHRoZSBjdXJyZW50IG1vZHVsZQogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzdGFydCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcy5ydW4ob3B0aW9ucywgdGhpcyk7CiAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N0YXJ0Jywgb3B0aW9ucyk7CiAgICB9LAogICAgLy8gU3RvcCB0aGlzIG1vZHVsZSBieSBydW5uaW5nIGl0cyBmaW5hbGl6ZXJzIGFuZCB0aGVuIHN0b3AgYWxsIG9mCiAgICAvLyB0aGUgc3ViLW1vZHVsZXMgZm9yIHRoaXMgbW9kdWxlCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIGlmIHdlIGFyZSBub3QgaW5pdGlhbGl6ZWQsIGRvbid0IGJvdGhlciBmaW5hbGl6aW5nCiAgICAgIGlmICghdGhpcy5faXNJbml0aWFsaXplZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLl9pc0luaXRpYWxpemVkID0gZmFsc2U7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN0b3AnKTsKICAgICAgLy8gc3RvcCB0aGUgc3ViLW1vZHVsZXM7IGRlcHRoLWZpcnN0LCB0byBtYWtlIHN1cmUgdGhlCiAgICAgIC8vIHN1Yi1tb2R1bGVzIGFyZSBzdG9wcGVkIC8gZmluYWxpemVkIGJlZm9yZSBwYXJlbnRzCiAgICAgIF8uZWFjaCh0aGlzLnN1Ym1vZHVsZXMsIGZ1bmN0aW9uIChtb2QpIHsKICAgICAgICBtb2Quc3RvcCgpOwogICAgICB9KTsKICAgICAgLy8gcnVuIHRoZSBmaW5hbGl6ZXJzCiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5ydW4odW5kZWZpbmVkLCB0aGlzKTsKICAgICAgLy8gcmVzZXQgdGhlIGluaXRpYWxpemVycyBhbmQgZmluYWxpemVycwogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcy5yZXNldCgpOwogICAgICB0aGlzLl9maW5hbGl6ZXJDYWxsYmFja3MucmVzZXQoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzdG9wJyk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlIHRoZSBtb2R1bGUgd2l0aCBhIGRlZmluaXRpb24gZnVuY3Rpb24gYW5kIGFueSBjdXN0b20gYXJncwogICAgLy8gdGhhdCBhcmUgdG8gYmUgcGFzc2VkIGluIHRvIHRoZSBkZWZpbml0aW9uIGZ1bmN0aW9uCiAgICBhZGREZWZpbml0aW9uOiBmdW5jdGlvbiAobW9kdWxlRGVmaW5pdGlvbiwgY3VzdG9tQXJncykgewogICAgICB0aGlzLl9ydW5Nb2R1bGVEZWZpbml0aW9uKG1vZHVsZURlZmluaXRpb24sIGN1c3RvbUFyZ3MpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZDogcnVuIHRoZSBtb2R1bGUgZGVmaW5pdGlvbiBmdW5jdGlvbiB3aXRoIHRoZSBjb3JyZWN0CiAgICAvLyBhcmd1bWVudHMKICAgIF9ydW5Nb2R1bGVEZWZpbml0aW9uOiBmdW5jdGlvbiAoZGVmaW5pdGlvbiwgY3VzdG9tQXJncykgewogICAgICAvLyBJZiB0aGVyZSBpcyBubyBkZWZpbml0aW9uIHNob3J0IGNpcmN1dCB0aGUgbWV0aG9kLgogICAgICBpZiAoIWRlZmluaXRpb24pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gYnVpbGQgdGhlIGNvcnJlY3QgbGlzdCBvZiBhcmd1bWVudHMgZm9yIHRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICB2YXIgYXJncyA9IF8uZmxhdHRlbihbCiAgICAgICAgdGhpcywKICAgICAgICB0aGlzLmFwcCwKICAgICAgICBCYWNrYm9uZSwKICAgICAgICBNYXJpb25ldHRlLAogICAgICAgIEJhY2tib25lLiQsCiAgICAgICAgXywKICAgICAgICBjdXN0b21BcmdzCiAgICAgIF0pOwogICAgICBkZWZpbml0aW9uLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZDogc2V0IHVwIG5ldyBjb3BpZXMgb2YgaW5pdGlhbGl6ZXJzIGFuZCBmaW5hbGl6ZXJzLgogICAgLy8gQ2FsbGluZyB0aGlzIG1ldGhvZCB3aWxsIHdpcGUgb3V0IGFsbCBleGlzdGluZyBpbml0aWFsaXplcnMgYW5kCiAgICAvLyBmaW5hbGl6ZXJzLgogICAgX3NldHVwSW5pdGlhbGl6ZXJzQW5kRmluYWxpemVyczogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcyA9IG5ldyBNYXJpb25ldHRlLkNhbGxiYWNrcygpOwogICAgICB0aGlzLl9maW5hbGl6ZXJDYWxsYmFja3MgPSBuZXcgTWFyaW9uZXR0ZS5DYWxsYmFja3MoKTsKICAgIH0sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZAogIH0pOwogIC8vIENsYXNzIG1ldGhvZHMgdG8gY3JlYXRlIG1vZHVsZXMKICBfLmV4dGVuZChNYXJpb25ldHRlLk1vZHVsZSwgewogICAgLy8gQ3JlYXRlIGEgbW9kdWxlLCBoYW5naW5nIG9mZiB0aGUgYXBwIHBhcmFtZXRlciBhcyB0aGUgcGFyZW50IG9iamVjdC4KICAgIGNyZWF0ZTogZnVuY3Rpb24gKGFwcCwgbW9kdWxlTmFtZXMsIG1vZHVsZURlZmluaXRpb24pIHsKICAgICAgdmFyIG1vZHVsZSA9IGFwcDsKICAgICAgLy8gZ2V0IHRoZSBjdXN0b20gYXJncyBwYXNzZWQgaW4gYWZ0ZXIgdGhlIG1vZHVsZSBkZWZpbml0aW9uIGFuZAogICAgICAvLyBnZXQgcmlkIG9mIHRoZSBtb2R1bGUgbmFtZSBhbmQgZGVmaW5pdGlvbiBmdW5jdGlvbgogICAgICB2YXIgY3VzdG9tQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgY3VzdG9tQXJncy5zcGxpY2UoMCwgMyk7CiAgICAgIC8vIFNwbGl0IHRoZSBtb2R1bGUgbmFtZXMgYW5kIGdldCB0aGUgbnVtYmVyIG9mIHN1Ym1vZHVsZXMuCiAgICAgIC8vIGkuZS4gYW4gZXhhbXBsZSBtb2R1bGUgbmFtZSBvZiBgRG9nZS5Xb3cuQW1hemVgIHdvdWxkCiAgICAgIC8vIHRoZW4gaGF2ZSB0aGUgcG90ZW50aWFsIGZvciAzIG1vZHVsZSBkZWZpbml0aW9ucy4KICAgICAgbW9kdWxlTmFtZXMgPSBtb2R1bGVOYW1lcy5zcGxpdCgnLicpOwogICAgICB2YXIgbGVuZ3RoID0gbW9kdWxlTmFtZXMubGVuZ3RoOwogICAgICAvLyBzdG9yZSB0aGUgbW9kdWxlIGRlZmluaXRpb24gZm9yIHRoZSBsYXN0IG1vZHVsZSBpbiB0aGUgY2hhaW4KICAgICAgdmFyIG1vZHVsZURlZmluaXRpb25zID0gW107CiAgICAgIG1vZHVsZURlZmluaXRpb25zW2xlbmd0aCAtIDFdID0gbW9kdWxlRGVmaW5pdGlvbjsKICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGFydHMgb2YgdGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgIF8uZWFjaChtb2R1bGVOYW1lcywgZnVuY3Rpb24gKG1vZHVsZU5hbWUsIGkpIHsKICAgICAgICB2YXIgcGFyZW50TW9kdWxlID0gbW9kdWxlOwogICAgICAgIG1vZHVsZSA9IHRoaXMuX2dldE1vZHVsZShwYXJlbnRNb2R1bGUsIG1vZHVsZU5hbWUsIGFwcCwgbW9kdWxlRGVmaW5pdGlvbik7CiAgICAgICAgdGhpcy5fYWRkTW9kdWxlRGVmaW5pdGlvbihwYXJlbnRNb2R1bGUsIG1vZHVsZSwgbW9kdWxlRGVmaW5pdGlvbnNbaV0sIGN1c3RvbUFyZ3MpOwogICAgICB9LCB0aGlzKTsKICAgICAgLy8gUmV0dXJuIHRoZSBsYXN0IG1vZHVsZSBpbiB0aGUgZGVmaW5pdGlvbiBjaGFpbgogICAgICByZXR1cm4gbW9kdWxlOwogICAgfSwKICAgIF9nZXRNb2R1bGU6IGZ1bmN0aW9uIChwYXJlbnRNb2R1bGUsIG1vZHVsZU5hbWUsIGFwcCwgZGVmLCBhcmdzKSB7CiAgICAgIHZhciBvcHRpb25zID0gXy5leHRlbmQoe30sIGRlZik7CiAgICAgIHZhciBNb2R1bGVDbGFzcyA9IHRoaXMuZ2V0Q2xhc3MoZGVmKTsKICAgICAgLy8gR2V0IGFuIGV4aXN0aW5nIG1vZHVsZSBvZiB0aGlzIG5hbWUgaWYgd2UgaGF2ZSBvbmUKICAgICAgdmFyIG1vZHVsZSA9IHBhcmVudE1vZHVsZVttb2R1bGVOYW1lXTsKICAgICAgaWYgKCFtb2R1bGUpIHsKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIGlmIHdlIGRvbid0IGhhdmUgb25lCiAgICAgICAgbW9kdWxlID0gbmV3IE1vZHVsZUNsYXNzKG1vZHVsZU5hbWUsIGFwcCwgb3B0aW9ucyk7CiAgICAgICAgcGFyZW50TW9kdWxlW21vZHVsZU5hbWVdID0gbW9kdWxlOwogICAgICAgIC8vIHN0b3JlIHRoZSBtb2R1bGUgb24gdGhlIHBhcmVudAogICAgICAgIHBhcmVudE1vZHVsZS5zdWJtb2R1bGVzW21vZHVsZU5hbWVdID0gbW9kdWxlOwogICAgICB9CiAgICAgIHJldHVybiBtb2R1bGU7CiAgICB9LAogICAgLy8gIyMgTW9kdWxlIENsYXNzZXMKICAgIC8vCiAgICAvLyBNb2R1bGUgY2xhc3NlcyBjYW4gYmUgdXNlZCBhcyBhbiBhbHRlcm5hdGl2ZSB0byB0aGUgZGVmaW5lIHBhdHRlcm4uCiAgICAvLyBUaGUgZXh0ZW5kIGZ1bmN0aW9uIG9mIGEgTW9kdWxlIGlzIGlkZW50aWNhbCB0byB0aGUgZXh0ZW5kIGZ1bmN0aW9ucwogICAgLy8gb24gb3RoZXIgQmFja2JvbmUgYW5kIE1hcmlvbmV0dGUgY2xhc3Nlcy4KICAgIC8vIFRoaXMgYWxsb3dzIG1vZHVsZSBsaWZlY3lsZSBldmVudHMgbGlrZSBgb25TdGFydGAgYW5kIGBvblN0b3BgIHRvIGJlIGNhbGxlZCBkaXJlY3RseS4KICAgIGdldENsYXNzOiBmdW5jdGlvbiAobW9kdWxlRGVmaW5pdGlvbikgewogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSBNYXJpb25ldHRlLk1vZHVsZTsKICAgICAgaWYgKCFtb2R1bGVEZWZpbml0aW9uKSB7CiAgICAgICAgcmV0dXJuIE1vZHVsZUNsYXNzOwogICAgICB9CiAgICAgIC8vIElmIGFsbCBvZiB0aGUgbW9kdWxlJ3MgZnVuY3Rpb25hbGl0eSBpcyBkZWZpbmVkIGluc2lkZSBpdHMgY2xhc3MsCiAgICAgIC8vIHRoZW4gdGhlIGNsYXNzIGNhbiBiZSBwYXNzZWQgaW4gZGlyZWN0bHkuIGBNeUFwcC5tb2R1bGUoIkZvbyIsIEZvb01vZHVsZSlgLgogICAgICBpZiAobW9kdWxlRGVmaW5pdGlvbi5wcm90b3R5cGUgaW5zdGFuY2VvZiBNb2R1bGVDbGFzcykgewogICAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uOwogICAgICB9CiAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uLm1vZHVsZUNsYXNzIHx8IE1vZHVsZUNsYXNzOwogICAgfSwKICAgIC8vIEFkZCB0aGUgbW9kdWxlIGRlZmluaXRpb24gYW5kIGFkZCBhIHN0YXJ0V2l0aFBhcmVudCBpbml0aWFsaXplciBmdW5jdGlvbi4KICAgIC8vIFRoaXMgaXMgY29tcGxpY2F0ZWQgYmVjYXVzZSBtb2R1bGUgZGVmaW5pdGlvbnMgYXJlIGhlYXZpbHkgb3ZlcmxvYWRlZAogICAgLy8gYW5kIHN1cHBvcnQgYW4gYW5vbnltb3VzIGZ1bmN0aW9uLCBtb2R1bGUgY2xhc3MsIG9yIG9wdGlvbnMgb2JqZWN0CiAgICBfYWRkTW9kdWxlRGVmaW5pdGlvbjogZnVuY3Rpb24gKHBhcmVudE1vZHVsZSwgbW9kdWxlLCBkZWYsIGFyZ3MpIHsKICAgICAgdmFyIGZuID0gdGhpcy5fZ2V0RGVmaW5lKGRlZik7CiAgICAgIHZhciBzdGFydFdpdGhQYXJlbnQgPSB0aGlzLl9nZXRTdGFydFdpdGhQYXJlbnQoZGVmLCBtb2R1bGUpOwogICAgICBpZiAoZm4pIHsKICAgICAgICBtb2R1bGUuYWRkRGVmaW5pdGlvbihmbiwgYXJncyk7CiAgICAgIH0KICAgICAgdGhpcy5fYWRkU3RhcnRXaXRoUGFyZW50KHBhcmVudE1vZHVsZSwgbW9kdWxlLCBzdGFydFdpdGhQYXJlbnQpOwogICAgfSwKICAgIF9nZXRTdGFydFdpdGhQYXJlbnQ6IGZ1bmN0aW9uIChkZWYsIG1vZHVsZSkgewogICAgICB2YXIgc3dwOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGRlZikgJiYgZGVmLnByb3RvdHlwZSBpbnN0YW5jZW9mIE1hcmlvbmV0dGUuTW9kdWxlKSB7CiAgICAgICAgc3dwID0gbW9kdWxlLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAgICAgaWYgKF8uaXNPYmplY3QoZGVmKSkgewogICAgICAgIHN3cCA9IGRlZi5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgX2dldERlZmluZTogZnVuY3Rpb24gKGRlZikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGRlZikgJiYgIShkZWYucHJvdG90eXBlIGluc3RhbmNlb2YgTWFyaW9uZXR0ZS5Nb2R1bGUpKSB7CiAgICAgICAgcmV0dXJuIGRlZjsKICAgICAgfQogICAgICBpZiAoXy5pc09iamVjdChkZWYpKSB7CiAgICAgICAgcmV0dXJuIGRlZi5kZWZpbmU7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAogICAgX2FkZFN0YXJ0V2l0aFBhcmVudDogZnVuY3Rpb24gKHBhcmVudE1vZHVsZSwgbW9kdWxlLCBzdGFydFdpdGhQYXJlbnQpIHsKICAgICAgbW9kdWxlLnN0YXJ0V2l0aFBhcmVudCA9IG1vZHVsZS5zdGFydFdpdGhQYXJlbnQgJiYgc3RhcnRXaXRoUGFyZW50OwogICAgICBpZiAoIW1vZHVsZS5zdGFydFdpdGhQYXJlbnQgfHwgISFtb2R1bGUuc3RhcnRXaXRoUGFyZW50SXNDb25maWd1cmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIG1vZHVsZS5zdGFydFdpdGhQYXJlbnRJc0NvbmZpZ3VyZWQgPSB0cnVlOwogICAgICBwYXJlbnRNb2R1bGUuYWRkSW5pdGlhbGl6ZXIoZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICBpZiAobW9kdWxlLnN0YXJ0V2l0aFBhcmVudCkgewogICAgICAgICAgbW9kdWxlLnN0YXJ0KG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIE1hcmlvbmV0dGU7Cn0pKTsKLyohCiAqIGl0ZW1WaWV3LmpzCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQKICovCml0ZW1WaWV3ID0gZnVuY3Rpb24gKF8sIE1hcmlvbmV0dGUpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEl0ZW1WaWV3CiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICByZXR1cm4gTWFyaW9uZXR0ZS5JdGVtVmlldy5leHRlbmQoewogICAgLy8gTGF5b3V0cyBoYXZlIG5vIGltbWVkaWF0ZSB0ZW1wbGF0ZQogICAgdGVtcGxhdGU6IGZhbHNlCiAgfSk7Cn0odW5kZXJzY29yZSwgYmFja2JvbmVtYXJpb25ldHRlKTsKLyohCiAqIGl0ZW1Db250cm9sbGVyLmpzCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQKICovCml0ZW1Db250cm9sbGVyID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUsIEl0ZW1WaWV3KSB7CiAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJdGVtQ29udHJvbGxlcgogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgcmV0dXJuIE1hcmlvbmV0dGUuQ29udHJvbGxlci5leHRlbmQoewogICAgLy8gRGVmYXVsdCBMYXlvdXRWSWV3CiAgICBWaWV3OiBJdGVtVmlldywKICAgIC8qKgogICAgICogQmFzZSBpdGVtQ29udHJvbGxlci4gU2V0cyB1cCBDb250cm9sbGVyIFZpZXcuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIHZhciBjb250cm9sbGVyID0gbmV3IEl0ZW1Db250cm9sbGVyKHsKICAgICAqICAgVmlldzogSXRlbVZpZXcKICAgICAqIH0pOwogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHB1YmxpYwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgLy8gU2V0dXAgb3VyIGl0ZW1Db250cm9sbGVyCiAgICAgIHRoaXMuc2V0dXAob3B0aW9ucyk7CiAgICAgIC8vIEluaXRsaWF6ZSB5byEKICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLmluaXRpYWxpemUpKSB7CiAgICAgICAgdGhpcy5pbml0aWFsaXplKHRoaXMub3B0aW9ucyk7CiAgICAgIH0KICAgIH0sCiAgICAvKioKICAgICAqIEJyZWFraW5nIHNldHVwIG91dCBzbyBpdCBjYW4gYmUgY2FsbGVkCiAgICAgKiBieSBhbnkgY29udHJvbGxlcnMgdGhhdCB3YW50IHRvIHVzZSB0aGlzCiAgICAgKiBhcyBhIHN1cGVyLiBPdGhlcndpc2UgaW5pdGlhbGl6ZSB3aWxsIGJlCiAgICAgKiBjYWxsZWQKICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBzZXR1cDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgLy8gU2V0IG9wdGlvbnMgaW5zdGFuY2Ugb3B0aW9ucwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAvLyBHZXQgdmFyIG9yIHRocm93IGVycm9yCiAgICAgIHRoaXMuVmlldyA9IHRoaXMucmVxdWlyZWQoJ1ZpZXcnKTsKICAgICAgLy8gUmVuZGVyIHlvIQogICAgICB0aGlzLnZpZXcgPSBuZXcgdGhpcy5WaWV3KHRoaXMuZ2V0T3B0aW9uKCd2aWV3T3B0aW9ucycpIHx8IHt9KTsKICAgIH0sCiAgICAvKioKICAgICAqIE1ha2Ugc3VyZSBwcm9wIGlzIGRlZmluZWQgb24gb3VyIGluc3RhbmNlIG9yCiAgICAgKiBpbiBvdXIgaW5zdGFuY2Ugb3B0aW9ucyBvYmplY3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIE5hbWUgb2YgcHJvcGVydHkgd2UgYXJlIGNoZWNraW5nCiAgICAgKiAgIGV4aXN0YW5jZSBvZi4KICAgICAqLwogICAgcmVxdWlyZWQ6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHZhciB2YWwgPSB0aGlzLmdldE9wdGlvbihuYW1lKTsKICAgICAgaWYgKCF2YWwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVpcmVzICInICsgbmFtZSArICciIHRvIGJlIGRlZmluZWQuJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbDsKICAgIH0sCiAgICAvKioKICAgICAqIENvbnZlbmNpZW5jZSB3cmFwcGVyIGFyb3VuZCBNYXJpb25ldHRlLmdldE9wdGlvbiBzbwogICAgICogdGhhdCBpdCBkb2VzIG5vdCBuZWVkIHRvIGJlIHJlcXVpcmVkIGluIGVhY2ggc3ViIGNsYXNzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGdldE9wdGlvbjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuZ2V0T3B0aW9uKHRoaXMsIG5hbWUpOwogICAgfQogIH0pOwp9KGJhY2tib25lbWFyaW9uZXR0ZSwgaXRlbVZpZXcpOwovKiEKICogbGF5b3V0Vmlldy5qcwogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0CiAqLwpsYXlvdXRWaWV3ID0gZnVuY3Rpb24gKF8sIE1hcmlvbmV0dGUpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIExheW91dFZpZXcKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIC8qKgogICAqIExheW91dFZpZXcgdGhhdCBkeW5hbWljYWxseSBjcmVhdGVzIGFuZCBhcHBlbmRzIHJlZ2lvbnMuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIHZhciB2aWV3ID0gbmV3IExheW91dFZpZXcoKTsKICAgKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwdWJsaWMKICAgKi8KICByZXR1cm4gTWFyaW9uZXR0ZS5MYXlvdXRWaWV3LmV4dGVuZCh7CiAgICAvLyBMYXlvdXRzIGhhdmUgbm8gaW1tZWRpYXRlIHRlbXBsYXRlCiAgICB0ZW1wbGF0ZTogZmFsc2UsCiAgICAvKioKICAgICAqIEFkZCByZWdpb25zIHRvIHRoZSB2aWV3IGJ5IHRlbXBsYXRpbmcgYW5kIGF0dGFjaGluZwogICAgICogYSBuZXcgcmVnaW9uIGhvbGRlciB0byB0aGUgRE9NLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiB2aWV3LmFkZFJlZ2lvbigncjEnLCB7IHByZWZpeDogJ3IxJyB9KTsKICAgICAqCiAgICAgKiBAcHVibGljCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBOYW1lIG9mIHRoZSByZWdpb24gdG8gYWRkLgogICAgICogQHBhcmFtIHtvYmplY3R9IGRlZmluaXRpb24gLSBSZWdpb24gZGVmaW5pdGlvbi4KICAgICAqLwogICAgYWRkUmVnaW9uOiBmdW5jdGlvbiAobmFtZSwgZGVmaW5pdGlvbikgewogICAgICAvLyBBcHBlbmQgcmVnaW9ucyBwcmlvciB0byBhc3NpZ25pbmcgdGhlbQogICAgICB2YXIgZm9ybWF0dGVkID0geyBlbDogdGhpcy5hcHBlbmRSZWdpb24obmFtZSwgZGVmaW5pdGlvbikgfTsKICAgICAgTWFyaW9uZXR0ZS5MYXlvdXRWaWV3LnByb3RvdHlwZS5hZGRSZWdpb24uY2FsbCh0aGlzLCBuYW1lLCBmb3JtYXR0ZWQpOwogICAgfSwKICAgIC8qKgogICAgICogQWRkIG11bHRpcGxlIHJlZ2lvbnMgYXQgb25lLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiB2aWV3LmFkZFJlZ2lvbnMoewogICAgICogICAncjEnOiB7IHByZWZpeDogJ3IxJyB9LAogICAgICogICAncjInOiB7IHByZWZpeDogJ3IyJyB9CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBAcHVibGljCiAgICAgKgogICAgICogQHBhcmFtIHtyZWdpb25zfSBuYW1lIC0gUmVnaW9ucyBvYmplY3Qgd2hlcmUgdGhlIGtleSByZXByZXNlbnRzCiAgICAgKiAgIHRoZSByZWdpb24gbmFtZSBhbmQgdGhlIHZhbHVlIGlzIHRoZSByZWdpb24gZGVmaW5pdGlvbi4KICAgICAqLwogICAgYWRkUmVnaW9uczogZnVuY3Rpb24gKHJlZ2lvbnMpIHsKICAgICAgdmFyIGZvcm1hdHRlZCA9IHt9OwogICAgICAvLyBBcHBlbmQgUmVnaW9ucyBwcmlvciB0byBhc3NpZ25pbmcgdGhlbQogICAgICBfLmVhY2gocmVnaW9ucywgZnVuY3Rpb24gKHZhbCwga2V5KSB7CiAgICAgICAgZm9ybWF0dGVkW2tleV0gPSB7IGVsOiB0aGlzLmFwcGVuZFJlZ2lvbihrZXksIHZhbCkgfTsKICAgICAgfSwgdGhpcyk7CiAgICAgIE1hcmlvbmV0dGUuTGF5b3V0Vmlldy5wcm90b3R5cGUuYWRkUmVnaW9ucy5jYWxsKHRoaXMsIGZvcm1hdHRlZCk7CiAgICB9LAogICAgLyoqCiAgICAgKiBSZW1vdmUgYm90aCByZWdpb24gYW5kIGhvbGRlciBlbC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogdmlldy5yZW1vdmVSZWdpb24oJ3IxJyk7CiAgICAgKgogICAgICogQHB1YmxpYwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gTmFtZSBvZiB0aGUgcmVnaW9uIHRvIHJlbW92ZS4KICAgICAqLwogICAgcmVtb3ZlUmVnaW9uOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAvLyBSZW1vdmUgJHJlZ2lvbiBlbGVtZW50CiAgICAgIHRoaXMuJHJlZ2lvbnNbbmFtZV0ucmVtb3ZlKCk7CiAgICAgIE1hcmlvbmV0dGUuTGF5b3V0Vmlldy5wcm90b3R5cGUucmVtb3ZlUmVnaW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLyoqCiAgICAgKiBBcHBlbmQgYXBwIHJlZ2lvbiB0ZW1wbGF0ZSB0byBET00uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIE5hbWUgb2YgdGhlIHJlZ2lvbiB0byBhZGQuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGVmaW5pdGlvbiAtIFJlZ2lvbiBkZWZpbml0aW9uLgogICAgICovCiAgICBhcHBlbmRSZWdpb246IGZ1bmN0aW9uIChuYW1lLCBkZWZpbml0aW9uKSB7CiAgICAgIHZhciB0bXBsID0gZGVmaW5pdGlvbi50bXBsLCBwcm9wcyA9IF8uZXh0ZW5kKHsgbmFtZTogbmFtZSB9LCBkZWZpbml0aW9uKTsKICAgICAgLy8gQ2FuIHRlbXBsYXRlIGEgamF2YXNjcmlwdCBmdW5jdGlvbgogICAgICBkZWxldGUgcHJvcHMudG1wbDsKICAgICAgLy8gVGVtcGxhdGUgd2lsbCBmYWlsIGlmIHByb3BzIGFyZSBtaXNzaW5nCiAgICAgIF8uZGVmYXVsdHMocHJvcHMsIHsKICAgICAgICBwcmVmaXg6ICcnLAogICAgICAgIG5hbWU6ICcnLAogICAgICAgIGNsczogJycKICAgICAgfSk7CiAgICAgIHZhciAkcmVnaW9uID0gJChfLnRlbXBsYXRlKHRtcGwsIHByb3BzKSk7CiAgICAgIC8vIEFwcGVuZCB0ZW1wbGF0ZXRlZCBodG1sCiAgICAgIHRoaXMuJHJlZ2lvbnMgPSB0aGlzLiRyZWdpb25zIHx8IHt9OwogICAgICB0aGlzLiRyZWdpb25zW25hbWVdID0gJHJlZ2lvbjsKICAgICAgdGhpcy4kZWwuYXBwZW5kKCRyZWdpb24pOwogICAgICByZXR1cm4gJHJlZ2lvbjsKICAgIH0KICB9KTsKfSh1bmRlcnNjb3JlLCBiYWNrYm9uZW1hcmlvbmV0dGUpOwovKiEKICogbGF5b3V0Q29udHJvbGxlci5qcwogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0CiAqLwpsYXlvdXRDb250cm9sbGVyID0gZnVuY3Rpb24gKF8sIGl0ZW1Db250cm9sbGVyLCBjb21tYW5kZXIsIExheW91dFZpZXcpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIHNjb3BlCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgdG1wbCA9ICc8ZGl2IGNsYXNzPSI8JT1wcmVmaXglPi08JT1uYW1lJT4gPCU9Y2xzJT4iPjwvZGl2Pic7CiAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBMYXlvdXRDb250cm9sbGVyCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICByZXR1cm4gaXRlbUNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgIC8vIERlZmF1bHQgTGF5b3V0VklldwogICAgVmlldzogTGF5b3V0VmlldywKICAgIC8qKgogICAgICogQ29udHJvbGxlciB3aXRoIG1ldGhvZHMgdG8gbWFuaXB1bGF0ZSBuZXN0ZWQgbGF5b3V0CiAgICAgKiB2aWV3cyBhbmQgYXNzb2NpYXRlZCByZWdpb25zLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgY29udHJvbGxlciA9IG5ldyBMYXlvdXRDb250cm9sbGVyKCk7CiAgICAgKgogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKiBAcHVibGljCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAvLyBMYXlvdXQgQ29udHJvbGxlciB1c2VzIGl0ZW1Db250cm9sbGVyCiAgICAgIC8vIGFzIGEgYmFzZS4KICAgICAgdGhpcy5zZXR1cChvcHRpb25zKTsKICAgICAgLy8gU2V0IHJlcXVpcmVkIGluc3RhbmNlIHZhcmlhYmxlcwogICAgICB0aGlzLnByZWZpeCA9IHRoaXMucmVxdWlyZWQoJ3ByZWZpeCcpOwogICAgICB0aGlzLm5hbWVzcGFjZSA9IHRoaXMucmVxdWlyZWQoJ25hbWVzcGFjZScpOwogICAgICAvLyBTZXQgdXAgYW4gZW1wdHkgYXJyYXkgdG8gaG9sZCByZWZlcmVuY2UgdG8gYWxsCiAgICAgIC8vIGFwcGxpZWQgZXZlbnRzIChmb3IgY2xlYW51cCkuCiAgICAgIHRoaXMuX2NoaWxkRXZlbnRzID0gW107CiAgICAgIC8vIFNldCB1cCBhbiBlbXB0eSBvYmplY3QgcmVzcG9uc2libGUgZm9yIG1hbmFnaW5nCiAgICAgIC8vIHZpZXcgcmVnaW9ucyBhbmQgY3VycmVudCBzdGF0ZS4gCiAgICAgIHRoaXMuX3JlZ2lvbnMgPSB7fTsKICAgICAgLy8gU2V0IHVwIGFuIGVtcHR5IG9iamVjdCByZXNwb25zaWJsZSBmb3IgbWFuZ2luZwogICAgICAvLyBzdWIgY29udHJvbGxlcnMuCiAgICAgIHRoaXMuX2l0ZW1zID0ge307CiAgICAgIC8vIFNldHVwIGFueSByZWdpb25zIHNldAogICAgICB0aGlzLmNvbmZpZ3VyZVJlZ2lvbnMoKTsKICAgICAgLy8gSW5pdGxpYXplIHlvIQogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgICB0aGlzLmluaXRpYWxpemUodGhpcy5vcHRpb25zKTsKICAgICAgfQogICAgfSwKICAgIC8qKgogICAgICogQ2FsbGVkIG9uIGNvbnRyb2xsZXIgZGVzdHJveS4gVXNlZCB0byBjbGVhbiB1cCBhbnkKICAgICAqIGFwcGxpZWQgZXZlbnRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIG9uRGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICBfLmVhY2godGhpcy5fY2hpbGRFdmVudHMsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGNvbW1hbmRlci5yZW1vdmVIYW5kbGVyKGV2ZW50KTsKICAgICAgfSk7CiAgICAgIF8uZWFjaCh0aGlzLl9pdGVtcywgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICBpdGVtLmNvbnRyb2xsZXIuZGVzdHJveSgpOwogICAgICB9KTsKICAgIH0sCiAgICAvKioKICAgICAqIENyZWF0ZSBhbnkgcmVnaW9ucyBkZWNsYXJlZCBpbiBsYXlvdXRSZWdpb25zLgogICAgICogRGVjbGFyZWQgaW4gY2xhc3Mgb3IgcGFzc2VkIGluIHRoaXMub3B0aW9ucwogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGNvbmZpZ3VyZVJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldE9wdGlvbigncmVnaW9ucycpLCBpc0FyciA9IF8uaXNBcnJheShyZWdpb25zKTsKICAgICAgXy5lYWNoKHJlZ2lvbnMsIGZ1bmN0aW9uICh2YWwsIGtleSkgewogICAgICAgIHJldHVybiBpc0FyciA/IHRoaXMuYWRkUmVnaW9uKHZhbCwge30pIDogdGhpcy5hZGRSZWdpb24oa2V5LCB2YWwpOwogICAgICB9LCB0aGlzKTsKICAgIH0sCiAgICAvKioKICAgICAqIEFkZCByZWdpb25zIHRvIG91ciBhcHAgdmlldyBhbmQgc2V0IHVwIGdsb2JhbCBldmVudHMgb24gY29tbWFuZGVyCiAgICAgKiB0byBpbnRlcmFjdCB3aXRoIHRoZW0uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIGNvbnRyb2xsZXIuYWRkUmVnaW9uKCdyMScsIHsgdG1wbDogdGVtcGxhdGUgfSk7CiAgICAgKgogICAgICogQHB1YmxpYwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gTmFtZSBvZiB0aGUgcmVnaW9uIHRvIGFkZC4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkZWZpbml0aW9uIC0gUmVnaW9uIGRlZmluaXRpb24uCiAgICAgKi8KICAgIGFkZFJlZ2lvbjogZnVuY3Rpb24gKG5hbWUsIGRlZmluaXRpb24pIHsKICAgICAgdmFyIG5hbWVzcGFjZSA9IFsKICAgICAgICB0aGlzLm5hbWVzcGFjZSwKICAgICAgICBuYW1lCiAgICAgIF0uam9pbignOicpOwogICAgICB2YXIgZXZlbnROYW1lID0gWwogICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAnc2hvdycKICAgICAgXS5qb2luKCc6Jyk7CiAgICAgIC8vIE1peGluIHdpdGggZGVmYXVsdHMKICAgICAgZGVmaW5pdGlvbiA9IF8uZXh0ZW5kKHt9LCBkZWZpbml0aW9uKTsKICAgICAgZGVmaW5pdGlvblsncHJlZml4J10gPSBkZWZpbml0aW9uWydwcmVmaXgnXSB8fCB0aGlzLnByZWZpeDsKICAgICAgZGVmaW5pdGlvblsndG1wbCddID0gZGVmaW5pdGlvblsndG1wbCddIHx8IHRtcGw7CiAgICAgIC8vIEFkZCBhIG5ldyByZWdpb24gdG8gb3VyIHZpZXcKICAgICAgdGhpcy52aWV3LmFkZFJlZ2lvbihuYW1lLCBkZWZpbml0aW9uKTsKICAgICAgLy8gV2Ugd2FudCB0byBhbHdheXMgaGF2ZSB0cmFjayBvZiBvdXIgY3JydWVudCByZWdpb24gY29udHJvbGxlci4KICAgICAgLy8gU2V0dGluZyB0byBlbXB0eSBvdmplY3QgdG8gYXZvaWQgaGF2aW5nIHRvIGNoZWNrIGZvciBleGlzdGVuY2UKICAgICAgLy8gZXZlcnl3aGVyZSB3ZSBsb29rdXAKICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuX3JlZ2lvbnNbbmFtZV0gPSB7fTsKICAgICAgcmVnaW9uWyduYW1lc3BhY2UnXSA9IG5hbWVzcGFjZTsKICAgICAgcmVnaW9uWydjdXJyZW50J10gPSB7fTsKICAgICAgLy8gQWRkIGFuIGV2ZW50IHRvIHNob3cgYSBzcGVjaWZpZWQgY29udHJvbGxlciB2aWV3CiAgICAgIC8vIGluIHRoZSByZWdpb24uIEhhbmRsZXIgc2hvdWxkIGJlIHBhc3NlZCByZWdpb24gbmFtZS4KICAgICAgdGhpcy5fY2hpbGRFdmVudHMucHVzaChldmVudE5hbWUpOwogICAgICBjb21tYW5kZXIuc2V0SGFuZGxlcihldmVudE5hbWUsIF8uYmluZCh0aGlzLm9uU2hvdywgdGhpcywgbmFtZSkpOwogICAgfSwKICAgIC8qKgogICAgICogU2hvdyBoYW5kbGVyLiBSZXNwb25zaWJsZSBmb3Igc2hvd2luZyBhIHZpZXcvY29udHJvbGxlcgogICAgICogaW4gdGhlIG5ldyByZWdpb24uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW1zIHtzdHJpbmd9IHJlZ2lvbk5hbWUgLSBOYW1lIG9mIHJlZ2lvbiB0byBzaG93IHZpZXcgaW4uCiAgICAgKiBAcGFyYW1zIHtzdHJpbmd9IGl0ZW1OYW1lIC0gTmFtZSBvZiB2aWV3IHRvIHNob3cgaW4gcmVnaW9uLgogICAgICogQHBhcmFtcyB7b2JqZWN0fSBpdGVtIC0gVGhlIGl0ZW0gY29udGFpbnMgYSBDb250cm9sbGVyCiAgICAgKiAgIGFuZCBhbnkgb3B0aW9ucyB0byBwYXNzIGluIGF0IENvbnRyb2xsZXIgaW5zdGFudGlhdGlvbi4KICAgICAqIEBwYXJhbXMge2Z1bmN0aW9ufSBkb25lIC0gQ2FsbGJhY2sgdG8gZXhlY3V0ZSBvbmNlIHJlZ2lvbgogICAgICogICBoYXMgYmVlbiBzaG93bi4gV2lsbCBwYXNzIGluIHRoZSBuZXdseSBpbnN0YW50aWF0ZWQKICAgICAqICAgY29udHJvbGxlci4KICAgICAqLwogICAgb25TaG93OiBmdW5jdGlvbiAocmVnaW9uTmFtZSwgaXRlbU5hbWUsIGl0ZW0sIGRvbmUpIHsKICAgICAgLy8gaXRlbSBwYXNzZWQgYXMgQ29udHJvbGxlcgogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGl0ZW0pKSB7CiAgICAgICAgaXRlbSA9IHsgQ29udHJvbGxlcjogaXRlbSB9OwogICAgICB9CiAgICAgIC8vIGFkZCBuYW1lIHRvIGl0ZW0gb2JqZWN0CiAgICAgIGl0ZW1bJ25hbWUnXSA9IGl0ZW1OYW1lOwogICAgICAvLyBNaXggbmFtZSBpbnRvIGZvcm1hdHRlZCBpdGVtCiAgICAgIHRoaXMuc2hvd0luUmVnaW9uKHJlZ2lvbk5hbWUsIGl0ZW0sIGRvbmUpOwogICAgfSwKICAgIC8qKgogICAgICogU2hvdyBhIHZpZXcgaW4gdGhlIHNwZWNpZmllZCByZWdpb24gdXNpbmcgdGhlIGNvbnRyb2xsZXIKICAgICAqIHRoYXQgaW5zdGFudGlhdGVzIHRoZSB2aWV3LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBjb250cm9sbGVyLnNob3dJblJlZ2lvbigncjEnLCB7IAogICAgICogICBuYW1lOiAnY29udGVudCcsCiAgICAgKiAgIENvbnRyb2xsZXI6IENvbnRlbnRDb250cm9sbGVyCiAgICAgKiB9LCBjb21wbGV0ZWQpOwogICAgICoKICAgICAqIEBwdWJsaWMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIE5hbWUgb2YgdGhlIHJlZ2lvbiB0byBzaG93IGNvbnRlbnQgaW4uCiAgICAgKiBAcGFyYW0ge29iamVjdH0gaXRlbSAtIEl0ZW0gZGVmaW5pdGlvbi4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGRvbmUgLSBDYWxsYmFjayBleGVjdXRlZCBvbmNlIHZpZXcgaXMgc2hvd24uCiAgICAgKi8KICAgIHNob3dJblJlZ2lvbjogZnVuY3Rpb24gKHJlZ2lvbk5hbWUsIGl0ZW0sIGRvbmUpIHsKICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuX3JlZ2lvbnNbcmVnaW9uTmFtZV07CiAgICAgIHZhciBuYW1lID0gWwogICAgICAgIHJlZ2lvbk5hbWUsCiAgICAgICAgaXRlbS5uYW1lCiAgICAgIF0uam9pbignOicpOwogICAgICB2YXIgY3VycmVudCA9IHJlZ2lvbi5jdXJyZW50OwogICAgICB2YXIgY3VyTmFtZSA9IFsKICAgICAgICByZWdpb25OYW1lLAogICAgICAgIGN1cnJlbnQubmFtZQogICAgICBdLmpvaW4oJzonKTsKICAgICAgdmFyIGlzRGlmZiA9IGN1cnJlbnQubmFtZSAhPT0gaXRlbS5uYW1lOwogICAgICAvLyBJZiBpdCBjdXJyZW50bHkgZXhpc3RzIGFuZCBpcyBkaWZmZXJudAogICAgICAvLyB0aGVuIHdlIG5lZWQgdG8gZGVzdHJveS9yZW1vdmUuCiAgICAgIGlmIChpc0RpZmYgJiYgY3VycmVudC5uYW1lICYmICFpdGVtLnByZXZlbnRDbG9zZSkgewogICAgICAgIGN1cnJlbnQuY29udHJvbGxlci5kZXN0cm95KCk7CiAgICAgICAgZGVsZXRlIHRoaXMuX2l0ZW1zW2N1ck5hbWVdOwogICAgICB9CiAgICAgIC8vIENyZWF0ZSBhIG5ldyBpdGVtIGlmIGl0IGRvZXMgbm90IHlldCBleGlzdC4KICAgICAgaWYgKGlzRGlmZiAmJiAhdGhpcy5faXRlbXNbbmFtZV0pIHsKICAgICAgICB0aGlzLl9pdGVtc1tuYW1lXSA9IHRoaXMuY3JlYXRlSXRlbShyZWdpb24sIGl0ZW0pOwogICAgICB9CiAgICAgIC8vIFNob3cgYW5kIHNldCBjdXJyZW50LgogICAgICBpZiAoaXNEaWZmKSB7CiAgICAgICAgcmVnaW9uLmN1cnJlbnQgPSB0aGlzLl9pdGVtc1tuYW1lXTsKICAgICAgICB0aGlzLnZpZXdbcmVnaW9uTmFtZV0uc2hvdyhyZWdpb24uY3VycmVudC5jb250cm9sbGVyLnZpZXcpOwogICAgICB9CiAgICAgIC8vIE9wdGlvbmFsIGNhbGxiYWNrIHRoYXQgcGFzc2VzIGN1cnJlbnQgcmVnaW9uIG9iamVjdC4KICAgICAgaWYgKGRvbmUpIHsKICAgICAgICBkb25lKHJlZ2lvbi5jdXJyZW50KTsKICAgICAgfQogICAgfSwKICAgIC8qKgogICAgICogU2V0IGN1cnJlbnQgb2Ygc3BlY2lmaWVkIHJlZ2lvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gUmVnaW9uIGN1cnJlbnRseSBtYW5pcHVsYXRpbmcgb24uCiAgICAgKiBAcGFyYW0ge29iamVjdH0gaXRlbSAtIEl0ZW0gdG8gaW5pdGlhbGl6ZSBhbmQgc2V0IGFzIGN1cnJlbnQuCiAgICAgKi8KICAgIGNyZWF0ZUl0ZW06IGZ1bmN0aW9uIChyZWdpb24sIGl0ZW0pIHsKICAgICAgdmFyIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgaXRlbS5vcHRpb25zKTsKICAgICAgdmFyIG5hbWVzcGFjZSA9IFsKICAgICAgICByZWdpb24ubmFtZXNwYWNlLAogICAgICAgIGl0ZW0ubmFtZQogICAgICBdLmpvaW4oJzonKTsKICAgICAgLy8gQWRkIG5hbWVzcGFjZSB0byBvcHRpb25zCiAgICAgIG9wdGlvbnNbJ25hbWVzcGFjZSddID0gbmFtZXNwYWNlOwogICAgICAvLyBBZGQgaXRlbQogICAgICByZXR1cm4gewogICAgICAgICdjb250cm9sbGVyJzogbmV3IGl0ZW0uQ29udHJvbGxlcihvcHRpb25zKSwKICAgICAgICAnbmFtZSc6IGl0ZW0ubmFtZQogICAgICB9OwogICAgfQogIH0pOwp9KHVuZGVyc2NvcmUsIGl0ZW1Db250cm9sbGVyLCBjb21tYW5kZXIsIGxheW91dFZpZXcpOwovKiEKICogbWFyaW9uZXR0ZS5keW5hbWljbGF5b3V0LmpzCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQKICovCm1hcmlvbmV0dGVkeW5hbWljbGF5b3V0ID0gZnVuY3Rpb24gKGNvbW1hbmRlciwgSXRlbUNvbnRyb2xsZXIsIExheW91dENvbnRyb2xsZXIsIExheW91dFZpZXcpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGV4cG9ydAogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgcmV0dXJuIHsKICAgIGNvbW1hbmRlcjogY29tbWFuZGVyLAogICAgSXRlbUNvbnRyb2xsZXI6IEl0ZW1Db250cm9sbGVyLAogICAgTGF5b3V0Q29udHJvbGxlcjogTGF5b3V0Q29udHJvbGxlciwKICAgIExheW91dFZpZXc6IExheW91dFZpZXcKICB9Owp9KGNvbW1hbmRlciwgaXRlbUNvbnRyb2xsZXIsIGxheW91dENvbnRyb2xsZXIsIGxheW91dFZpZXcpOwoKcmV0dXJuIG1hcmlvbmV0dGVEeW5hbWljbGF5b3V0OwoKCn0pKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 09:16:45 GMT",
                    "Content-Length": "509963",
                    "Date": "Fri, 07 Nov 2014 09:16:45 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}