{
    "url": "http://localhost:9999/mariusGundersen/OrdnungJS/Dist/ordnung.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>document.location.href</b> and written to <b>the 'after()' function of JQuery</b> via the following statement:<ul><li>var path = _.after(document.location.href, '#');</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/mariusGundersen/OrdnungJS/Dist/ordnung.js",
                "path": "/mariusGundersen/OrdnungJS/Dist/ordnung.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tYXJpdXNHdW5kZXJzZW4vT3JkbnVuZ0pTL0Rpc3Qvb3JkbnVuZy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzIzMzANCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMjE6Mjk6MDIgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDIxOjI5OjAyIEdNVA0KDQoKZGVmaW5lKCdvcmRudW5nL3V0aWxzJyxbXSwgZnVuY3Rpb24oKXsKCXJldHVybiB7CgkJdG9BcnJheTogZnVuY3Rpb24ob2JqKXsKCQkJdmFyIGFycmF5ID0gW107CgkJCS8vIGl0ZXJhdGUgYmFja3dhcmRzIGVuc3VyaW5nIHRoYXQgbGVuZ3RoIGlzIGFuIFVJbnQzMgoJCQlmb3IgKHZhciBpID0gb2JqLmxlbmd0aCA+Pj4gMDsgaS0tOykgeyAKCQkJCWFycmF5W2ldID0gb2JqW2ldOwoJCQl9CgkJCXJldHVybiBhcnJheTsKCQl9LAoJCWV4dGVuZDogZnVuY3Rpb24oZHN0LCBzcmMpewoJCQlzcmMgPSBzcmMgfHwge307CgkJCWRzdCA9IGRzdCB8fCB7fTsKCQkJZm9yKHZhciBpIGluIHNyYyl7CgkJCQlkc3RbaV0gPSBzcmNbaV07CgkJCX0KCQkJcmV0dXJuIGRzdDsKCQl9LAoJCWFycmF5VG9PYmplY3Q6IGZ1bmN0aW9uKGFycmF5LCBmdW5jKXsKCQkJcmV0dXJuIGFycmF5LnJlZHVjZShmdW5jdGlvbihjb2xsZWN0aW9uLCBpdGVtKXsKCQkJCWZ1bmMoaXRlbSwgY29sbGVjdGlvbik7CgkJCQlyZXR1cm4gY29sbGVjdGlvbjsKCQkJfSwge30pOwoJCX0sCgkJdHJpbTogZnVuY3Rpb24od29yZCwgY2hhcmFjdGVyKXsKCQkJd2hpbGUod29yZC5jaGFyQXQoMCkgPT0gY2hhcmFjdGVyKSB3b3JkID0gd29yZC5zdWJzdHIoMSk7CgkJCXdoaWxlKHdvcmQuY2hhckF0KHdvcmQubGVuZ3RoIC0gMSkgPT0gY2hhcmFjdGVyKSB3b3JkID0gd29yZC5zdWJzdHIoMCwgd29yZC5sZW5ndGggLSAxKTsKCQkJcmV0dXJuIHdvcmQ7CgkJfSwKCQlhZnRlcjogZnVuY3Rpb24od29yZCwgY2hhcmFjdGVyKXsKCQkJdmFyIGluZGV4ID0gd29yZC5pbmRleE9mKGNoYXJhY3Rlcik7CgkJCWlmKGluZGV4IDwgMCl7CgkJCQlyZXR1cm4gIiI7CgkJCX1lbHNlewoJCQkJcmV0dXJuIHdvcmQuc3Vic3RyKGluZGV4KzEpOwoJCQl9CgkJfSwKCQlwb3BUYWlsOiBmdW5jdGlvbihhcnJheSl7CgkJCXJldHVybiBhcnJheS5zbGljZSgwLCAtMSk7CgkJfSwKCQlzdGFydHNXaXRoOiBmdW5jdGlvbih3b3JkLCBjaGFyYWN0ZXIpewoJCQlyZXR1cm4gd29yZC5jaGFyQXQoMCkgPT09IGNoYXJhY3RlcjsKCQl9LAoJCWVuZHNXaXRoOiBmdW5jdGlvbih3b3JkLCBjaGFyYWN0ZXIpewoJCQlyZXR1cm4gd29yZC5jaGFyQXQod29yZC5sZW5ndGggLSAxKSA9PT0gY2hhcmFjdGVyOwoJCX0sCgkJYWRkRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24oZWxlbWVudCwgZXZlbnQsIGxpc3RlbmVyLCBidWJibGUpewoJCQlpZignYWRkRXZlbnRMaXN0ZW5lcicgaW4gZWxlbWVudCl7CgkJCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyLCBidWJibGUpOwoJCQl9ZWxzZXsKCQkJCWVsZW1lbnQuYXR0YWNoRXZlbnQoIm9uIitldmVudCwgbGlzdGVuZXIpOwkJCgkJCX0KCQl9Cgl9Owp9KTsKCmRlZmluZSgnb3JkbnVuZy9xdmMvRXhlY3V0YWJsZVJlc3VsdCcsWyJvcmRudW5nL3V0aWxzIl0sIGZ1bmN0aW9uKHV0aWxzKXsKCWZ1bmN0aW9uIEV4ZWN1dGFibGVSZXN1bHQocmVzdWx0KXsKCQkKCQl0aGlzLnN1Y2Nlc3MgPSBmYWxzZTsKCQl0aGlzLnZhbGlkID0gZmFsc2U7CgkJdGhpcy5yZXN1bHQgPSBudWxsOwoJCXRoaXMuZXhjZXB0aW9uID0gbnVsbDsKCQl0aGlzLnZpb2xhdGlvbnMgPSBbXTsKCQoJCXV0aWxzLmV4dGVuZCh0aGlzLCByZXN1bHQpOwoJCgl9OwoJCglyZXR1cm4gRXhlY3V0YWJsZVJlc3VsdDsKfSk7CmRlZmluZSgnb3JkbnVuZy9xdmMvQ29uc3RyYWludCcsW10sIGZ1bmN0aW9uKCl7CgkKCWZ1bmN0aW9uIENvbnN0cmFpbnQodHlwZSwgYXR0cmlidXRlcyl7CQkKCQl0aGlzLnR5cGUgPSB0eXBlOwoJCXRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CgkJdGhpcy5tZXNzYWdlID0gYXR0cmlidXRlcy5tZXNzYWdlOwoJCQoJCQoJCXRoaXMuaW5pdCh0eXBlKTsKCX0KCQkKCUNvbnN0cmFpbnQucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbih0eXBlKXsKCQlyZXF1aXJlKFsib3JkbnVuZy9xdmMvY29uc3RyYWludHMvIiArIHR5cGVdLCBmdW5jdGlvbihUZXN0ZXIpewoJCQl2YXIgdGVzdGVyID0gbmV3IFRlc3Rlcih0aGlzLmF0dHJpYnV0ZXMpOwoJCQl0aGlzLnZhbGlkYXRlID0gdGVzdGVyLmlzVmFsaWQuYmluZCh0ZXN0ZXIpOwoJCX0uYmluZCh0aGlzKSk7Cgl9OwoJCglDb25zdHJhaW50LnByb3RvdHlwZS52YWxpZGF0ZSA9IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gdHJ1ZTsvL3JlYWwgdGVzdCBub3QgbG9hZGVkIHlldAoJfTsKCQoJCglyZXR1cm4gQ29uc3RyYWludDsKfSk7CmRlZmluZSgnb3JkbnVuZy9xdmMvVmFsaWRhdG9yJyxbCgkib3JkbnVuZy9xdmMvQ29uc3RyYWludCIsIAoJImtub2Nrb3V0IgpdLCBmdW5jdGlvbigKCUNvbnN0cmFpbnQsIAoJa28KKXsKCglmdW5jdGlvbiBpbnRlcnBvbGF0ZShtZXNzYWdlLCBhdHRyaWJ1dGVzLCB2YWx1ZSwgbmFtZSwgcGF0aCl7CgkJcmV0dXJuIG1lc3NhZ2UucmVwbGFjZSgvXHsoW159XSspXH0vZywgZnVuY3Rpb24obWF0Y2gsIGtleSl7CgkJCWlmKGtleSA9PSAidmFsdWUiKSByZXR1cm4gdmFsdWU7CgkJCWlmKGtleSA9PSAidGhpcy5uYW1lIikgcmV0dXJuIG5hbWU7CgkJCWlmKGtleSA9PSAidGhpcy5wYXRoIikgcmV0dXJuIHBhdGg7CgkJCWlmKGtleSBpbiBhdHRyaWJ1dGVzKSByZXR1cm4gYXR0cmlidXRlc1trZXldOwoJCQlyZXR1cm4gbWF0Y2g7CgkJfSk7Cgl9CgkKCglmdW5jdGlvbiBWYWxpZGF0b3IodGFyZ2V0LCBvcHRpb25zKXsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJdGhpcy5jb25zdHJhaW50cyA9IFtdOwoJCQoJCXRoaXMuaXNWYWxpZCA9IGtvLm9ic2VydmFibGUodHJ1ZSk7CgkJdGhpcy5tZXNzYWdlID0ga28ub2JzZXJ2YWJsZSgiIik7CgoJCXRoaXMubmFtZSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5uYW1lOwoJCXRoaXMucGF0aCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5wYXRoOwoJfQoJCglWYWxpZGF0b3IucHJvdG90eXBlLnNldENvbnN0cmFpbnRzID0gZnVuY3Rpb24oY29uc3RyYWludHMpewoJCXRoaXMuY29uc3RyYWludHMgPSBjb25zdHJhaW50cy5tYXAoZnVuY3Rpb24oY29uc3RyYWludCl7CgkJCXJldHVybiBuZXcgQ29uc3RyYWludChjb25zdHJhaW50Lm5hbWUsIGNvbnN0cmFpbnQuYXR0cmlidXRlcyk7CgkJfSk7Cgl9OwoJCglWYWxpZGF0b3IucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24oKXsKCQl0aGlzLmlzVmFsaWQodHJ1ZSk7CgkJdGhpcy5tZXNzYWdlKCIiKTsKCX07CgkKCVZhbGlkYXRvci5wcm90b3R5cGUudmFsaWRhdGUgPSBmdW5jdGlvbih2YWx1ZSl7CgkJaWYodGhpcy5jb25zdHJhaW50cy5sZW5ndGggPT0gMCl7CgkJCXRoaXMucmVzZXQoKTsKCQl9ZWxzZSBpZih0aGlzLmNvbnN0cmFpbnRzLmV2ZXJ5KGZ1bmN0aW9uIChjb25zdHJhaW50KSB7CgkJCWlmKGNvbnN0cmFpbnQudmFsaWRhdGUodmFsdWUpKXsKCQkJCXJldHVybiB0cnVlOwoJCQl9ZWxzZXsKCQkJCXRoaXMuaXNWYWxpZChmYWxzZSk7CgkJCQl0aGlzLm1lc3NhZ2UoaW50ZXJwb2xhdGUoY29uc3RyYWludC5tZXNzYWdlLCBjb25zdHJhaW50LmF0dHJpYnV0ZXMsIHZhbHVlLCB0aGlzLm5hbWUsIHRoaXMucGF0aCkpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfS5iaW5kKHRoaXMpKSl7CgkJCXRoaXMuaXNWYWxpZCh0cnVlKTsKCQkJdGhpcy5tZXNzYWdlKCIiKTsKCQl9Cgl9OwoJCglyZXR1cm4gVmFsaWRhdG9yOwp9KTsKZGVmaW5lKCdvcmRudW5nL3F2Yy9rb0V4dGVuc2lvbnMnLFsib3JkbnVuZy9xdmMvVmFsaWRhdG9yIiwgImtub2Nrb3V0Il0sIGZ1bmN0aW9uKFZhbGlkYXRvciwga28pewoKCWlmIChrbyAhPSBudWxsKSB7CgkJa28uYmluZGluZ0hhbmRsZXJzLnZhbGlkYXRpb25NZXNzYWdlRm9yID0gewoJCQlpbml0OiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsKSB7CgkJCQl2YXIgdmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CgkJCQl2YXIgdmFsaWRhdG9yID0gdmFsdWUudmFsaWRhdG9yOwoJCQkJaWYgKHZhbGlkYXRvcikgewoJCQkJCWtvLmFwcGx5QmluZGluZ3NUb05vZGUoZWxlbWVudCwgeyBoaWRkZW46IHZhbGlkYXRvci5pc1ZhbGlkLCB0ZXh0OiB2YWxpZGF0b3IubWVzc2FnZSB9LCB2YWxpZGF0b3IpOwoJCQkJfWVsc2V7CgkJCQkJdmFyIGF0dHJpYnV0ZXMgPSBBcnJheS5wcm90b3R5cGUucmVkdWNlLmNhbGwoZWxlbWVudC5hdHRyaWJ1dGVzLCBmdW5jdGlvbihzLGUpe3JldHVybiBzKyIgIitlLmxvY2FsTmFtZSsiPVwiIitlLnZhbHVlKyJcIiJ9LCAiIik7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCJDb3VsZCBub3QgYmluZCBgdmFsaWRhdGlvbk1lc3NhZ2VGb3JgIHRvIHZhbHVlIG9uIGVsZW1lbnQgPCIrZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgKyBhdHRyaWJ1dGVzICsiPiIpOwoJCQkJfQoJCQl9CgkJfTsKCQkKCQlrby5leHRlbmRlcnMudmFsaWRhdGlvbiA9IGZ1bmN0aW9uICh0YXJnZXQsIG9wdGlvbnMpIHsKCQkJdGFyZ2V0LnZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IodGFyZ2V0LCBvcHRpb25zKTsKCQkJdGFyZ2V0LnN1YnNjcmliZShmdW5jdGlvbiAobmV3VmFsdWUpIHsKCQkJCXRhcmdldC52YWxpZGF0b3IudmFsaWRhdGUobmV3VmFsdWUpOwoJCQl9KTsKCQkJcmV0dXJuIHRhcmdldDsKCQl9OwoJCQoJCWtvLmJpbmRpbmdIYW5kbGVycy5jb21tYW5kID0ga28uYmluZGluZ0hhbmRsZXJzLnF1ZXJ5ID0gewoJCQlpbml0OiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ0FjY2Vzc29yLCB2aWV3TW9kZWwpIHsKCQkJCWtvLmFwcGx5QmluZGluZ3NUb05vZGUoZWxlbWVudCwgeyBjbGljazogdmFsdWVBY2Nlc3NvcigpIH0sIHZpZXdNb2RlbCk7CgkJCX0KCQl9OwoJfQoJCgp9KTsKZGVmaW5lKCdvcmRudW5nL3F2Yy9WYWxpZGF0YWJsZScsWyJvcmRudW5nL3V0aWxzIiwgIm9yZG51bmcvcXZjL1ZhbGlkYXRvciIsICJrbm9ja291dCIsICJvcmRudW5nL3F2Yy9rb0V4dGVuc2lvbnMiXSxmdW5jdGlvbih1dGlscywgVmFsaWRhdG9yLCBrbyl7CgkKCWZ1bmN0aW9uIHJlY3Vyc2l2bHlFeHRlbmRQYXJhbWV0ZXJzKHBhcmFtZXRlcnMsIHZhbGlkYXRhYmxlRmllbGRzLCBwYXJlbnRzKSB7CgkJZm9yICh2YXIga2V5IGluIHBhcmFtZXRlcnMpIHsKCQkJdmFyIHByb3BlcnR5ID0gcGFyYW1ldGVyc1trZXldOwoJCQl2YXIgcGF0aCA9IHBhcmVudHMuY29uY2F0KFtrZXldKTsKCQkJaWYgKGtvLmlzT2JzZXJ2YWJsZShwcm9wZXJ0eSkpIHsKCQkJCXByb3BlcnR5LmV4dGVuZCh7CgkJCQkJdmFsaWRhdGlvbjogewoJCQkJCQluYW1lOmtleSwKCQkJCQkJcGF0aDpwYXRoLmpvaW4oIi4iKQoJCQkJCX0KCQkJCX0pOwoJCQkJdmFsaWRhdGFibGVGaWVsZHMucHVzaChwcm9wZXJ0eSk7CgkJCX0KCQkJcHJvcGVydHkgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHByb3BlcnR5KTsKCQkJaWYgKHR5cGVvZiBwcm9wZXJ0eSA9PT0gIm9iamVjdCIpIHsKCQkJCXJlY3Vyc2l2bHlFeHRlbmRQYXJhbWV0ZXJzKHByb3BlcnR5LCB2YWxpZGF0YWJsZUZpZWxkcywgcGF0aCk7CgkJCX0KCQl9Cgl9CgoKCWZ1bmN0aW9uIGZpbmRGaWVsZChmaWVsZFBhdGgsIHBhcmFtZXRlcnMsIGVycm9yTWVzc2FnZSl7CgkJcmV0dXJuIGZpZWxkUGF0aC5zcGxpdCgiLiIpLnJlZHVjZShmdW5jdGlvbihvYmplY3QsIG5hbWUpewoJCQl2YXIgcGF0aCA9IG9iamVjdC5wYXRoOwoJCQl2YXIgZmllbGQgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9iamVjdC5maWVsZCk7CgkJCWlmIChuYW1lIGluIGZpZWxkKSB7CgkJCQlyZXR1cm4gewoJCQkJCWZpZWxkOiBmaWVsZFtuYW1lXSwKCQkJCQlwYXRoOiBwYXRoICsgIi4iICsgbmFtZQoJCQkJfTsKCQkJfSBlbHNlIHsKCQkJCXRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UgKyAiOiAiICsgZmllbGRQYXRoICsgIlxuIiArCgkJCQkJbmFtZSArICIgaXMgbm90IGEgbWVtYmVyIG9mICIgKyBwYXRoICsgIlxuIiArCgkJCQkJcGF0aCArICIgPSBgIiArIGtvLnRvSlNPTihmaWVsZCkgKyAiYCIpOwoJCQl9CgkJfSwgewoJCQlmaWVsZDogcGFyYW1ldGVycywKCQkJcGF0aDogInBhcmFtZXRlcnMiCgkJfSkuZmllbGQ7Cgl9CgoKCgkKCWZ1bmN0aW9uIGFwcGx5VmlvbGF0aW9uTWVzc2FnZVRvRmllbGQocGFyYW1ldGVycywgZmllbGRQYXRoLCBtZXNzYWdlKSB7CgkJdmFyIG9iamVjdCA9IGZpbmRGaWVsZChmaWVsZFBhdGgsIHBhcmFtZXRlcnMsICJFcnJvciBhcHBseWluZyB2aW9sYXRpb24iKTsKCQkKCQlpZiAodHlwZW9mIG1lc3NhZ2UgPT09ICJzdHJpbmciICYmICJ2YWxpZGF0b3IiIGluIG9iamVjdCkgewoJCQlvYmplY3QudmFsaWRhdG9yLmlzVmFsaWQoZmFsc2UpOwoJCQlvYmplY3QudmFsaWRhdG9yLm1lc3NhZ2UobWVzc2FnZSk7CgkJfWVsc2V7CgkJCXRocm93IG5ldyBFcnJvcigiRXJyb3IgYXBwbHlpbmcgdmlvbGF0aW9uXG4iK2ZpZWxkUGF0aCsiIGlzIG5vdCB2YWxpZGF0YWJsZVxuaXQgc2hvdWxkIGJlIGFuIG9ic2VydmFibGUiKTsKCQl9Cgl9OwoKCWZ1bmN0aW9uIGFwcGx5VmlvbGF0aW9uTWVzc2FnZVRvVmFsaWRhdGFibGUodmFsaWRhdGFibGUsIG1lc3NhZ2UpIHsKCQl2YWxpZGF0YWJsZS52YWxpZGF0b3IuaXNWYWxpZChmYWxzZSk7CgkJdmFyIG9sZE1lc3NhZ2UgPSB2YWxpZGF0YWJsZS52YWxpZGF0b3IubWVzc2FnZSgpOwoJCXZhciBuZXdNZXNzYWdlID0gb2xkTWVzc2FnZS5sZW5ndGggPT0gMCA/IG1lc3NhZ2UgOiBvbGRNZXNzYWdlICsgIiwgIiArIG1lc3NhZ2U7CgkJdmFsaWRhdGFibGUudmFsaWRhdG9yLm1lc3NhZ2UobmV3TWVzc2FnZSk7Cgl9OwoKCgoJZnVuY3Rpb24gVmFsaWRhdGFibGUobmFtZSwgcGFyYW1ldGVycywgY29uc3RyYWludFJlc29sdmVyKXsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJdGhpcy52YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKCk7CgkJdGhpcy52YWxpZGF0YWJsZUZpZWxkcyA9IFtdOwoJCXRoaXMudmFsaWRhdGFibGVQYXJhbWV0ZXJzID0gcGFyYW1ldGVyczsKCQkKCQkKCQlpbml0OiB7CgkJCXJlY3Vyc2l2bHlFeHRlbmRQYXJhbWV0ZXJzKHNlbGYudmFsaWRhdGFibGVQYXJhbWV0ZXJzLCBzZWxmLnZhbGlkYXRhYmxlRmllbGRzLCBbXSk7CgkJCWlmKGNvbnN0cmFpbnRSZXNvbHZlcikKCQkJCWNvbnN0cmFpbnRSZXNvbHZlci5hcHBseVZhbGlkYXRpb25Db25zdHJhaW50cyhuYW1lLCBzZWxmKTsKCQl9Cgl9CgkKCVZhbGlkYXRhYmxlLnByb3RvdHlwZS5pc1ZhbGlkID0gZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLnZhbGlkYXRhYmxlRmllbGRzLmV2ZXJ5KGZ1bmN0aW9uKGNvbnN0cmFpbnQpewoJCQlyZXR1cm4gY29uc3RyYWludC52YWxpZGF0b3IgJiYgY29uc3RyYWludC52YWxpZGF0b3IuaXNWYWxpZCgpOwoJCX0pICYmIHRoaXMudmFsaWRhdG9yLmlzVmFsaWQoKTsKCX07CgkJCglWYWxpZGF0YWJsZS5wcm90b3R5cGUuYXBwbHlWaW9sYXRpb25zID0gZnVuY3Rpb24odmlvbGF0aW9ucyl7CgkJdmlvbGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHZpb2xhdGlvbil7CgkJCXZhciBtZXNzYWdlID0gdmlvbGF0aW9uLm1lc3NhZ2U7CgkJCXZhciBmaWVsZE5hbWUgPSB2aW9sYXRpb24uZmllbGROYW1lOwoJCQlpZiAoZmllbGROYW1lLmxlbmd0aCA+IDApIHsKCQkJCS8vb25lIG9mIHRoZSBmaWVsZHMgdmlvbGF0ZXMgYSBjb25zdHJhaW50CgkJCQlhcHBseVZpb2xhdGlvbk1lc3NhZ2VUb0ZpZWxkKHRoaXMudmFsaWRhdGFibGVQYXJhbWV0ZXJzLCBmaWVsZE5hbWUsIG1lc3NhZ2UpOwoJCQl9IGVsc2UgewoJCQkJLy90aGUgdmFsaWRhdGFibGUgdmlvbGF0ZXMgYSBjb25zdHJhaW50CgkJCQlhcHBseVZpb2xhdGlvbk1lc3NhZ2VUb1ZhbGlkYXRhYmxlKHRoaXMsIG1lc3NhZ2UpOwoJCQl9CgkJfS5iaW5kKHRoaXMpKTsKCX07CgkKCVZhbGlkYXRhYmxlLnByb3RvdHlwZS5hcHBseUNvbnN0cmFpbnRzID0gZnVuY3Rpb24oZmllbGRzKXsKCQl2YXIgcGFyYW1ldGVycyA9IHRoaXMudmFsaWRhdGFibGVQYXJhbWV0ZXJzOwoJCQoJCWZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uKGZpZWxkKXsKCQkJdmFyIGZpZWxkTmFtZSA9IGZpZWxkLm5hbWU7CgkJCXZhciBjb25zdHJhaW50cyA9IGZpZWxkLmNvbnN0cmFpbnRzOwoKCQkJaWYoY29uc3RyYWludHMgPT0gbnVsbCB8fCBjb25zdHJhaW50cy5sZW5ndGggPT0gMCkKCQkJCXJldHVybjsKCQkJCgkJCXZhciBvYmplY3QgPSBmaW5kRmllbGQoZmllbGROYW1lLCBwYXJhbWV0ZXJzLCAiRXJyb3IgYXBwbHlpbmcgY29uc3RyYWludHMgdG8gZmllbGQiKTsKCQkJCgkJCWlmIChrby5pc09ic2VydmFibGUob2JqZWN0KSAmJiAidmFsaWRhdG9yIiBpbiBvYmplY3QpIHsKCQkJCW9iamVjdC52YWxpZGF0b3Iuc2V0Q29uc3RyYWludHMoY29uc3RyYWludHMpOwoJCQl9IGVsc2UgewoJCQkJdGhyb3cgbmV3IEVycm9yKCJFcnJvciBhcHBseWluZyBjb25zdHJhaW50cyB0byBmaWVsZDogIiArIGZpZWxkTmFtZSArICJcbiIgKwoJCQkJCSJJdCBpcyBub3QgYW4gb2JzZXJ2YWJsZSBvciBpcyBub3QgZXh0ZW5kZWQgd2l0aCBhIHZhbGlkYXRvci4gXG4iICsKCQkJCQlmaWVsZE5hbWUgKyAiPWAiICsga28udG9KU09OKG9iamVjdCkgKyAiYCIpOwoJCQl9CgkJfSk7Cgl9OwoJCglWYWxpZGF0YWJsZS5wcm90b3R5cGUudmFsaWRhdGUgPSBmdW5jdGlvbigpewoJCXRoaXMudmFsaWRhdG9yLnZhbGlkYXRlKHRydWUpOwoJCWlmICh0aGlzLnZhbGlkYXRvci5pc1ZhbGlkKCkpIHsKCQkJdGhpcy52YWxpZGF0YWJsZUZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uKGNvbnN0cmFpbnQpewoJCQkJdmFyIHZhbGlkYXRvciA9IGNvbnN0cmFpbnQudmFsaWRhdG9yOwoJCQkJaWYgKHZhbGlkYXRvcikgewoJCQkJCXZhbGlkYXRvci52YWxpZGF0ZShjb25zdHJhaW50KCkpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9OwoJCglWYWxpZGF0YWJsZS5wcm90b3R5cGUuY2xlYXJWYWxpZGF0aW9uTWVzc2FnZXMgPSBmdW5jdGlvbiAoKSB7CgkJdGhpcy52YWxpZGF0b3IucmVzZXQoKTsKCQl0aGlzLnZhbGlkYXRhYmxlRmllbGRzLmZvckVhY2goZnVuY3Rpb24oY29uc3RyYWludCl7CgkJCXZhciB2YWxpZGF0b3IgPSBjb25zdHJhaW50LnZhbGlkYXRvcjsKCQkJaWYgKHZhbGlkYXRvcikgewoJCQkJdmFsaWRhdG9yLnJlc2V0KCk7CgkJCX0KCQl9KTsKCX07CgkKCQoJCglyZXR1cm4gVmFsaWRhdGFibGU7Cn0pOwpkZWZpbmUoJ29yZG51bmcvcXZjL0V4ZWN1dGFibGUnLFsib3JkbnVuZy9xdmMvRXhlY3V0YWJsZVJlc3VsdCIsICJvcmRudW5nL3F2Yy9WYWxpZGF0YWJsZSIsICJvcmRudW5nL3V0aWxzIiwgImtub2Nrb3V0Il0sIGZ1bmN0aW9uKEV4ZWN1dGFibGVSZXN1bHQsIFZhbGlkYXRhYmxlLCB1dGlscywga28pewoKCWZ1bmN0aW9uIEV4ZWN1dGFibGUobmFtZSwgdHlwZSwgcGFyYW1ldGVycywgY2FsbGJhY2tzLCBxdmMpewoJCXZhciBzZWxmID0gdGhpczsKCQkKCQl0aGlzLm5hbWU7CgkJdGhpcy50eXBlOwoJCXRoaXMuaXNCdXN5ID0ga28ub2JzZXJ2YWJsZShmYWxzZSk7CgkJdGhpcy5oYXNFcnJvciA9IGtvLm9ic2VydmFibGUoZmFsc2UpOwoJCXRoaXMucmVzdWx0ID0gbmV3IEV4ZWN1dGFibGVSZXN1bHQoKTsKCQkKCQl0aGlzLnBhcmFtZXRlcnMgPSB7fTsKCQl0aGlzLmNhbGxiYWNrcyA9IHsKCQkJYmVmb3JlRXhlY3V0ZTogZnVuY3Rpb24gKCkge30sCgkJCWNhbkV4ZWN1dGU6IGZ1bmN0aW9uKCl7cmV0dXJuIHRydWU7fSwKCQkJZXJyb3I6IGZ1bmN0aW9uICgpIHt9LAoJCQlzdWNjZXNzOiBmdW5jdGlvbiAoKSB7fSwKCQkJcmVzdWx0OiBmdW5jdGlvbigpe30sCgkJCWNvbXBsZXRlOiBmdW5jdGlvbiAoKSB7fQoJCX07CgkJCgkJCgkJdGhpcy5leGVjdXRlID0gZnVuY3Rpb24gKCkgewoJCQlpZiAoc2VsZi5vbkJlZm9yZUV4ZWN1dGUoKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybjsKCQkJfQoJCQlxdmMuZXhlY3V0ZShzZWxmKTsKCQl9OwoKCQl0aGlzLm9uQmVmb3JlRXhlY3V0ZSA9IGZ1bmN0aW9uICgpIHsKCQkJCgkJCWlmIChzZWxmLmlzQnVzeSgpKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJCgkJCXNlbGYuaGFzRXJyb3IoZmFsc2UpOwoJCQkKCQkJc2VsZi5jYWxsYmFja3MuYmVmb3JlRXhlY3V0ZSgpOwoJCQkKCQkJc2VsZi52YWxpZGF0ZSgpOwoJCQlpZiAoIXNlbGYuaXNWYWxpZCgpKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJCgkJCWlmIChzZWxmLmNhbGxiYWNrcy5jYW5FeGVjdXRlKCkgPT09IGZhbHNlKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJc2VsZi5pc0J1c3kodHJ1ZSk7CgkJCQoJCQlyZXR1cm4gdHJ1ZTsKCQl9OwoJCQoJCQoJCXRoaXMub25FcnJvciA9IGZ1bmN0aW9uICgpIHsKCQkJc2VsZi5oYXNFcnJvcih0cnVlKTsKCQkJaWYoInZpb2xhdGlvbnMiIGluIHNlbGYucmVzdWx0ICYmIHNlbGYucmVzdWx0LnZpb2xhdGlvbnMgIT0gbnVsbCkKCQkJCXNlbGYuYXBwbHlWaW9sYXRpb25zKHNlbGYucmVzdWx0LnZpb2xhdGlvbnMpOwoJCQlzZWxmLmNhbGxiYWNrcy5lcnJvcihzZWxmLnJlc3VsdCk7CgkJfTsKCgkJdGhpcy5vblN1Y2Nlc3MgPSBmdW5jdGlvbiAoKSB7CgkJCXNlbGYuaGFzRXJyb3IoZmFsc2UpOwoJCQlzZWxmLmNsZWFyVmFsaWRhdGlvbk1lc3NhZ2VzKCk7CgkJCXNlbGYuY2FsbGJhY2tzLnN1Y2Nlc3Moc2VsZi5yZXN1bHQpOwoJCQlzZWxmLmNhbGxiYWNrcy5yZXN1bHQoc2VsZi5yZXN1bHQucmVzdWx0KTsKCQl9OwoKCQl0aGlzLm9uQ29tcGxldGUgPSBmdW5jdGlvbiAoKSB7CgkJCWlmICghc2VsZi5oYXNFcnJvcigpKSB7CgkJCQlzZWxmLmNhbGxiYWNrcy5jb21wbGV0ZShzZWxmLnJlc3VsdCk7CgkJCQlzZWxmLmNsZWFyVmFsaWRhdGlvbk1lc3NhZ2VzKCk7CgkJCX0KCQkJc2VsZi5pc0J1c3koZmFsc2UpOwoJCX07CgkJCgkJCgkJaW5pdDogewoJCQlzZWxmLm5hbWUgPSBuYW1lOwoJCQlzZWxmLnR5cGUgPSB0eXBlOwoJCQl1dGlscy5leHRlbmQoc2VsZi5wYXJhbWV0ZXJzLCBwYXJhbWV0ZXJzKTsKCQkJdXRpbHMuZXh0ZW5kKHNlbGYuY2FsbGJhY2tzLCBjYWxsYmFja3MpOwoJCQl1dGlscy5leHRlbmQoc2VsZiwgbmV3IFZhbGlkYXRhYmxlKHNlbGYubmFtZSwgc2VsZi5wYXJhbWV0ZXJzLCBxdmMuY29uc3RyYWludFJlc29sdmVyKSk7CgkJfQoJfQoJCglFeGVjdXRhYmxlLkNvbW1hbmQgPSAiY29tbWFuZCI7CglFeGVjdXRhYmxlLlF1ZXJ5ID0gInF1ZXJ5IjsKCQoJcmV0dXJuIEV4ZWN1dGFibGU7Cn0pOwpkZWZpbmUoJ29yZG51bmcvYWpheCcsW10sIGZ1bmN0aW9uKCl7CglmdW5jdGlvbiBkYXRhVG9QYXJhbXMoZGF0YSl7CgkJdmFyIHBhcmFtcyA9IFtdCgkJZm9yKHZhciBrZXkgaW4gZGF0YSl7CgkJCXZhciB2YWx1ZSA9IGRhdGFba2V5XTsKCQkJcGFyYW1zLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpKTsKCQl9CgkJcmV0dXJuIHBhcmFtcy5qb2luKCImIik7Cgl9CgoJZnVuY3Rpb24gYWRkUGFyYW1Ub1VybCh1cmwsIG5hbWUsIHZhbHVlKXsKCQlyZXR1cm4gdXJsICsgKHVybC5tYXRjaCgvXD8vKSA/ICh1cmwubWF0Y2goLyYkLykgPyAiIiA6ICImIikgOiAiPyIpICsgZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKCX0KCglmdW5jdGlvbiBhZGRQYXJhbXNUb1VybCh1cmwsIGRhdGEpewoJCXZhciBwYXJhbXMgPSBkYXRhVG9QYXJhbXMoZGF0YSk7CgkJcmV0dXJuIHVybCArICh1cmwubWF0Y2goL1w/LykgPyAodXJsLm1hdGNoKC8mJC8pID8gIiIgOiAocGFyYW1zLmxlbmd0aCA+IDAgPyAiJiIgOiAiIikpIDogIj8iKSArIHBhcmFtczsKCX0KCglmdW5jdGlvbiBhZGRUb1BhdGgodXJsLCBzZWdtZW50KXsKCQlyZXR1cm4gdXJsICsgKHVybC5tYXRjaCgvXC8kLykgPyAiIiA6ICIvIikgKyBzZWdtZW50OwoJfQoKCWZ1bmN0aW9uIGNhY2hlQnVzdCh1cmwpewoJCXJldHVybiBhZGRQYXJhbVRvVXJsKHVybCwgImNhY2hlS2V5IiwgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKk1hdGgucG93KDIsNTMpKSk7Cgl9CgoJZnVuY3Rpb24gYWpheCh1cmwsIG9iamVjdCwgbWV0aG9kLCBjYWxsYmFjayl7CgkJdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJCQoJCXZhciBpc1Bvc3QgPSAobWV0aG9kID09PSAiUE9TVCIpOwoJCXZhciBkYXRhID0gbnVsbDsKCQkKCQlpZihvYmplY3QpewoKCQkJaWYoaXNQb3N0KXsKCQkJCWRhdGEgPSBkYXRhVG9QYXJhbXMob2JqZWN0KTsKCQkJfSBlbHNlIHsKCQkJCXVybCA9IGFkZFBhcmFtc1RvVXJsKHVybCwgb2JqZWN0KTsKCQkJfQoJCX0KCQkKCQlpZihpc1Bvc3QpewoJCQl1cmwgPSBjYWNoZUJ1c3QodXJsKTsKCQl9CgoJCXhoci5vcGVuKG1ldGhvZCwgdXJsLCB0cnVlKTsKCQkKCQlpZihpc1Bvc3QgJiYgZGF0YSl7CgkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LXR5cGUiLCAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIik7CgkJfQoJCQoJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLVJlcXVlc3RlZC1XaXRoJywgJ1hNTEh0dHBSZXF1ZXN0Jyk7CgkJCgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CgkJCWlmKHhoci5yZWFkeVN0YXRlID09IDQpewoJCQkJY2FsbGJhY2soeGhyKTsKCQkJfQoJCX0KCQkKCQl4aHIuc2VuZChkYXRhKTsKCQlyZXR1cm4geGhyOwoJfQoKCWFqYXguYWRkUGFyYW1Ub1VybCA9IGFkZFBhcmFtVG9Vcmw7CglhamF4LmFkZFBhcmFtc1RvVXJsID0gYWRkUGFyYW1zVG9Vcmw7CglhamF4LmFkZFRvUGF0aCA9IGFkZFRvUGF0aDsKCWFqYXguY2FjaGVCdXN0ID0gY2FjaGVCdXN0OwoKCglyZXR1cm4gYWpheDsKfSk7CmRlZmluZSgnb3JkbnVuZy9xdmMvQ29uc3RyYWludFJlc29sdmVyJyxbXSwgZnVuY3Rpb24oKXsKCgoJZnVuY3Rpb24gZmluZENvbnN0cmFpbnQobmFtZSwgY29uc3RyYWludHMpIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbnN0cmFpbnRzLmxlbmd0aDsgaSsrKSB7CgkJCWlmIChjb25zdHJhaW50c1tpXS5uYW1lID09IG5hbWUpIHsKCQkJCXJldHVybiBjb25zdHJhaW50c1tpXTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9CgoJZnVuY3Rpb24gY29uc3RyYWludHNMb2FkZWQobmFtZSwgZmllbGRzKXsKCQl2YXIgY29uc3RyYWludCA9IGZpbmRDb25zdHJhaW50KG5hbWUsIHRoaXMuY29uc3RyYWludHMpOwoJCWlmKGNvbnN0cmFpbnQpewoJCQljb25zdHJhaW50LnZhbGlkYXRhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uKHZhbGlkYXRhYmxlKXsKCQkJCXZhbGlkYXRhYmxlLmFwcGx5Q29uc3RyYWludHMoZmllbGRzKTsKCQkJfSk7CgkJCWNvbnN0cmFpbnQuZmllbGRzID0gZmllbGRzOwoJCQljb25zdHJhaW50LnN0YXRlID0gImxvYWRlZCI7CgkJfQoJfQoKCglmdW5jdGlvbiBDb25zdHJhaW50UmVzb2x2ZXIocXZjKXsKCQl0aGlzLnF2YyA9IHF2YzsKCQl0aGlzLmNvbnN0cmFpbnRzID0gW107Cgl9CgkKCUNvbnN0cmFpbnRSZXNvbHZlci5wcm90b3R5cGUuYXBwbHlWYWxpZGF0aW9uQ29uc3RyYWludHMgPSBmdW5jdGlvbihuYW1lLCB2YWxpZGF0YWJsZSl7CgkJdmFyIGNvbnN0cmFpbnQgPSBmaW5kQ29uc3RyYWludChuYW1lLCB0aGlzLmNvbnN0cmFpbnRzKTsKCQlpZihjb25zdHJhaW50ID09IGZhbHNlKXsKCQkJdGhpcy5jb25zdHJhaW50cy5wdXNoKHsKCQkJCW5hbWU6IG5hbWUsCgkJCQlzdGF0ZTogImxvYWRpbmciLAoJCQkJdmFsaWRhdGFibGVzOiBbdmFsaWRhdGFibGVdCgkJCX0pOwoJCQl0aGlzLnF2Yy5sb2FkQ29uc3RyYWludHMobmFtZSwgY29uc3RyYWludHNMb2FkZWQuYmluZCh0aGlzKSk7CgkJfWVsc2V7CgkJCWlmKGNvbnN0cmFpbnQuc3RhdGUgPT09ICJsb2FkaW5nIil7CgkJCQljb25zdHJhaW50LnZhbGlkYXRhYmxlcy5wdXNoKHZhbGlkYXRhYmxlKTsKCQkJfWVsc2V7CgkJCQl2YWxpZGF0YWJsZS5hcHBseUNvbnN0cmFpbnRzKGNvbnN0cmFpbnQuZmllbGRzKTsKCQkJfQoJCX0KCX07CgkKCXJldHVybiBDb25zdHJhaW50UmVzb2x2ZXI7Cn0pOwpkZWZpbmUoJ29yZG51bmcvZXJyb3JIYW5kbGVyJyxbXSwgZnVuY3Rpb24oKXsKCXJldHVybiB7CgkJb25FcnJvcjogZnVuY3Rpb24oZXJyb3IpewoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJCQl0aHJvdyBlcnJvcjsKCQkJfSwxKTsKCQl9Cgl9Owp9KTsKZGVmaW5lKCdvcmRudW5nL3F2YycsWwoJIm9yZG51bmcvcXZjL0V4ZWN1dGFibGUiLCAKCSJvcmRudW5nL3F2Yy9FeGVjdXRhYmxlUmVzdWx0IiwgCgkib3JkbnVuZy91dGlscyIsIAoJIm9yZG51bmcvYWpheCIsCgkib3JkbnVuZy9xdmMvQ29uc3RyYWludFJlc29sdmVyIiwKCSJvcmRudW5nL2Vycm9ySGFuZGxlciIsCgkia25vY2tvdXQiLCAKCSJvcmRudW5nL3F2Yy9rb0V4dGVuc2lvbnMiXSwgCglmdW5jdGlvbigKCQlFeGVjdXRhYmxlLAoJCUV4ZWN1dGFibGVSZXN1bHQsCgkJdXRpbHMsCgkJYWpheCwKCQlDb25zdHJhaW50UmVzb2x2ZXIsCgkJZXJyb3JIYW5kbGVyLAoJCWtvKXsKCQoJZnVuY3Rpb24gUVZDKCl7CgoJCXZhciBxdmMgPSB0aGlzOwoKCQl0aGlzLmNvbnN0cmFpbnRSZXNvbHZlciA9IG5ldyBDb25zdHJhaW50UmVzb2x2ZXIocXZjKTsKCgkJdGhpcy5leGVjdXRlID0gZnVuY3Rpb24oZXhlY3V0YWJsZSl7CgkJCXZhciBwYXJhbWV0ZXJzID0ga28udG9KUyhleGVjdXRhYmxlLnBhcmFtZXRlcnMpOwoJCQl2YXIgZGF0YSA9IHsKCQkJCXBhcmFtZXRlcnM6IEpTT04uc3RyaW5naWZ5KHBhcmFtZXRlcnMpLAoJCQkJY3NyZlRva2VuOiBxdmMuY29uZmlnLmNzcmYKCQkJfTsKCQkJdmFyIHVybCA9IGFqYXguYWRkVG9QYXRoKHF2Yy5jb25maWcuYmFzZVVybCwgZXhlY3V0YWJsZS50eXBlICsgIi8iICsgZXhlY3V0YWJsZS5uYW1lKTsKCQkJYWpheCh1cmwsIGRhdGEsICJQT1NUIiwgZnVuY3Rpb24gKHhocikgewoJCQkJaWYgKHhoci5zdGF0dXMgPT09IDIwMCkgewoJCQkJCWV4ZWN1dGFibGUucmVzdWx0ID0gbmV3IEV4ZWN1dGFibGVSZXN1bHQoSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0IHx8ICJ7fSIpKTsKCQkJCQlpZiAoZXhlY3V0YWJsZS5yZXN1bHQuc3VjY2VzcyA9PT0gdHJ1ZSkgewoJCQkJCQlleGVjdXRhYmxlLm9uU3VjY2VzcygpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmKGV4ZWN1dGFibGUucmVzdWx0LmV4Y2VwdGlvbiAmJiBleGVjdXRhYmxlLnJlc3VsdC5leGNlcHRpb24ubWVzc2FnZSl7CgkJCQkJCQllcnJvckhhbmRsZXIub25FcnJvcihleGVjdXRhYmxlLnJlc3VsdC5leGNlcHRpb24ubWVzc2FnZSk7CgkJCQkJCX0KCQkJCQkJZXhlY3V0YWJsZS5vbkVycm9yKCk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlleGVjdXRhYmxlLnJlc3VsdCA9IG5ldyBFeGVjdXRhYmxlUmVzdWx0KHtleGNlcHRpb246IHttZXNzYWdlOiB4aHIucmVzcG9uc2VUZXh0LCBjYXVzZTogeGhyfX0pOwoJCQkJCWVycm9ySGFuZGxlci5vbkVycm9yKGV4ZWN1dGFibGUucmVzdWx0LmV4Y2VwdGlvbi5tZXNzYWdlKTsKCQkJCQlleGVjdXRhYmxlLm9uRXJyb3IoKTsKCQkJCX0KCQkJCWV4ZWN1dGFibGUub25Db21wbGV0ZSgpOwoJCQl9KTsKCQkKCQl9OwoJCQoJCXRoaXMubG9hZENvbnN0cmFpbnRzID0gZnVuY3Rpb24obmFtZSwgY2FsbGJhY2spewoJCQl2YXIgdXJsID0gYWpheC5hZGRUb1BhdGgocXZjLmNvbmZpZy5iYXNlVXJsLCAiY29uc3RyYWludHMvIiArIG5hbWUpOwoJCQlhamF4KHVybCwgbnVsbCwgIkdFVCIsIGZ1bmN0aW9uKHhocil7CgkJCQlpZiAoeGhyLnN0YXR1cyA9PT0gMjAwKSB7CgkJCQkJdHJ5ewoJCQkJCQl2YXIgcmVzcG9uc2UgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQgfHwgIntcInBhcmFtZXRlcnNcIjpbXX0iKTsKCQkJCQkJaWYoInBhcmFtZXRlcnMiIGluIHJlc3BvbnNlID09IGZhbHNlKXsKCQkJCQkJCXJlc3BvbnNlLnBhcmFtZXRlcnMgPSBbXTsKCQkJCQkJfQoJCQkJCQlpZihyZXNwb25zZS5leGNlcHRpb24gJiYgcmVzcG9uc2UuZXhjZXB0aW9uLm1lc3NhZ2UpewoJCQkJCQkJZXJyb3JIYW5kbGVyLm9uRXJyb3IocmVzcG9uc2UuZXhjZXB0aW9uLm1lc3NhZ2UpOwoJCQkJCQl9CgkJCQkJfWNhdGNoKGUpewoJCQkJCQl2YXIgcmVzcG9uc2UgPSB7cGFyYW1ldGVyczogW119OwoJCQkJCX0KCQkJCQljYWxsYmFjayhuYW1lLCByZXNwb25zZS5wYXJhbWV0ZXJzKTsKCQkJCX1lbHNlewoJCQkJCWVycm9ySGFuZGxlci5vbkVycm9yKHhoci5yZXNwb25zZVRleHQpOwoJCQkJfQoJCQl9KTsKCQl9OwoKCQkKCQl0aGlzLmNvbmZpZyA9IHsKCQkJYmFzZVVybDogIi8iLAoJCQljc3JmOiAiIgoJCX0KCX07CgoJdmFyIHF2YyA9IG5ldyBRVkMoKTsKCQoJZnVuY3Rpb24gY3JlYXRlRXhlY3V0YWJsZShuYW1lLCB0eXBlLCBwYXJhbWV0ZXJzLCBjYWxsYmFja3MpewoJCWlmKG5hbWUgPT0gbnVsbCB8fCBuYW1lLmxlbmd0aCA9PSAwKQoJCQl0aHJvdyBuZXcgRXJyb3IodHlwZSArICIgaXMgbWlzc2luZyBuYW1lXG5BICIgKyB0eXBlICsgIiBtdXN0IGhhdmUgYSBuYW1lIVxudXNhZ2U6IGNyZWF0ZUNvbW1hbmQoJ25hbWUnLCBbcGFyYW1ldGVycywgY2FsbGJhY2tzXSkiKTsKCQoJCXZhciBleGVjdXRhYmxlID0gbmV3IEV4ZWN1dGFibGUobmFtZSwgdHlwZSwgcGFyYW1ldGVycyB8fCB7fSwgY2FsbGJhY2tzIHx8IHt9LCBxdmMpOwoJCXZhciBleGVjdXRlID0gZXhlY3V0YWJsZS5leGVjdXRlLmJpbmQoZXhlY3V0YWJsZSk7CgkJZXhlY3V0ZS5pc1ZhbGlkID0ga28uY29tcHV0ZWQoZnVuY3Rpb24oKXtyZXR1cm4gZXhlY3V0YWJsZS5pc1ZhbGlkKCk7IH0pOwoJCWV4ZWN1dGUuaXNCdXN5ID0ga28uY29tcHV0ZWQoZnVuY3Rpb24oKXtyZXR1cm4gZXhlY3V0YWJsZS5pc0J1c3koKTt9KTsKCQlleGVjdXRlLmhhc0Vycm9yID0ga28uY29tcHV0ZWQoZnVuY3Rpb24oKXtyZXR1cm4gZXhlY3V0YWJsZS5oYXNFcnJvcigpO30pOwoJCWV4ZWN1dGUuc3VjY2VzcyA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKCQkJZXhlY3V0YWJsZS5jYWxsYmFja3Muc3VjY2VzcyA9IGNhbGxiYWNrOwoJCQlyZXR1cm4gZXhlY3V0ZTsKCQl9OwoJCWV4ZWN1dGUuZXJyb3IgPSBmdW5jdGlvbihjYWxsYmFjayl7CgkJCWV4ZWN1dGFibGUuY2FsbGJhY2tzLmVycm9yID0gY2FsbGJhY2s7CgkJCXJldHVybiBleGVjdXRlOwoJCX07CgkJZXhlY3V0ZS5iZWZvcmVFeGVjdXRlID0gZnVuY3Rpb24oY2FsbGJhY2spewoJCQlleGVjdXRhYmxlLmNhbGxiYWNrcy5iZWZvcmVFeGVjdXRlID0gY2FsbGJhY2s7CgkJCXJldHVybiBleGVjdXRlOwoJCX07CgkJZXhlY3V0ZS5jYW5FeGVjdXRlID0gZnVuY3Rpb24oY2FsbGJhY2spewoJCQlleGVjdXRhYmxlLmNhbGxiYWNrcy5jYW5FeGVjdXRlID0gY2FsbGJhY2s7CgkJCXJldHVybiBleGVjdXRlOwoJCX07CgkJZXhlY3V0ZS5yZXN1bHQgPSBmdW5jdGlvbigpewoJCQlpZihhcmd1bWVudHMubGVuZ3RoID09IDEpewoJCQkJZXhlY3V0YWJsZS5jYWxsYmFja3MucmVzdWx0ID0gYXJndW1lbnRzWzBdOwoJCQkJcmV0dXJuIGV4ZWN1dGU7CgkJCX0KCQkJcmV0dXJuIGV4ZWN1dGFibGUucmVzdWx0LnJlc3VsdDsKCQl9OwoJCWV4ZWN1dGUuY29tcGxldGUgPSBmdW5jdGlvbihjYWxsYmFjayl7CgkJCWV4ZWN1dGFibGUuY2FsbGJhY2tzLmNvbXBsZXRlID0gY2FsbGJhY2s7CgkJCXJldHVybiBleGVjdXRlOwoJCX07CgkJZXhlY3V0ZS5jbGVhclZhbGlkYXRpb25NZXNzYWdlcyA9IGV4ZWN1dGFibGUuY2xlYXJWYWxpZGF0aW9uTWVzc2FnZXMuYmluZChleGVjdXRhYmxlKTsKCQlleGVjdXRlLnZhbGlkYXRvciA9IGV4ZWN1dGFibGUudmFsaWRhdG9yOwoJCQoJCXJldHVybiBleGVjdXRlOwoJfQoJCglyZXR1cm4gewoJCWNyZWF0ZUNvbW1hbmQ6IGZ1bmN0aW9uKG5hbWUsIHBhcmFtZXRlcnMsIGNhbGxiYWNrcyl7CgkJCXJldHVybiBjcmVhdGVFeGVjdXRhYmxlKG5hbWUsIEV4ZWN1dGFibGUuQ29tbWFuZCwgcGFyYW1ldGVycywgY2FsbGJhY2tzKTsKCQl9LAoJCWNyZWF0ZVF1ZXJ5OiBmdW5jdGlvbihuYW1lLCBwYXJhbWV0ZXJzLCBjYWxsYmFja3MpewoJCQlyZXR1cm4gY3JlYXRlRXhlY3V0YWJsZShuYW1lLCBFeGVjdXRhYmxlLlF1ZXJ5LCBwYXJhbWV0ZXJzLCBjYWxsYmFja3MpOwoJCX0sCgkJY29uZmlnOiBmdW5jdGlvbihjb25maWcpewoJCQl1dGlscy5leHRlbmQocXZjLmNvbmZpZywgY29uZmlnKTsKCQl9Cgl9Cn0pOwpkZWZpbmUoJ29yZG51bmcvc3BhL091dGxldCcsWwoJImtub2Nrb3V0IgpdLCBmdW5jdGlvbigKCWtvCil7CgoJZnVuY3Rpb24gT3V0bGV0KGVsZW1lbnQsIGRvY3VtZW50KXsKCQl0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwoJCXRoaXMuZG9jdW1lbnQgPSBkb2N1bWVudCB8fCB3aW5kb3cuZG9jdW1lbnQ7Cgl9CgoJT3V0bGV0LnByb3RvdHlwZS5vdXRsZXRFeGlzdHMgPSBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmVsZW1lbnQgIT0gbnVsbDsKCX07CgoJT3V0bGV0LnByb3RvdHlwZS51bmxvYWRDdXJyZW50UGFnZSA9IGZ1bmN0aW9uKCl7CgkJa28uY2xlYW5Ob2RlKHRoaXMuZWxlbWVudCk7CgkJdGhpcy5lbGVtZW50LmlubmVySFRNTCA9ICIiOwoJfTsKCglPdXRsZXQucHJvdG90eXBlLnNldFBhZ2VDb250ZW50ID0gZnVuY3Rpb24oY29udGVudCl7CgkJdGhpcy5lbGVtZW50LmlubmVySFRNTCA9IGNvbnRlbnQ7Cgl9OwoKCU91dGxldC5wcm90b3R5cGUuZ2V0UGFnZVRpdGxlID0gZnVuY3Rpb24oKXsKCQl2YXIgdGl0bGVNZXRhVGFnID0gdGhpcy5lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoIm1ldGFbbmFtZT10aXRsZV0iKTsKCQlyZXR1cm4gKHRpdGxlTWV0YVRhZyAmJiB0aXRsZU1ldGFUYWcuZ2V0QXR0cmlidXRlKCJjb250ZW50IikpOwoJfTsKCglPdXRsZXQucHJvdG90eXBlLnNldERvY3VtZW50VGl0bGUgPSBmdW5jdGlvbih0aXRsZSl7CgkJdGhpcy5kb2N1bWVudC50aXRsZSA9IHRpdGxlOwoJfTsKCglPdXRsZXQucHJvdG90eXBlLmV4dHJhY3RBbmRSdW5QYWdlSmF2YVNjcmlwdCA9IGZ1bmN0aW9uKCl7CgkJdmFyIHNjcmlwdHMgPSB0aGlzLmVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgic2NyaXB0W3R5cGU9J3RleHQvamF2YXNjcmlwdCddIik7CgkJZm9yKHZhciBpPTA7IGk8c2NyaXB0cy5sZW5ndGg7IGkrKyl7CgkJCXNjcmlwdHNbaV0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHRzW2ldKTsKCQkJaWYoc2NyaXB0c1tpXS5pZCA9PT0gJycpIHRocm93IG5ldyBFcnJvcigiVGhlIHNjcmlwdCBtdXN0IGhhdmUgYW4gaWQiKTsKCQkJaWYodGhpcy5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChzY3JpcHRzW2ldLmlkKSA9PSBudWxsKXsKCQkJCXZhciBzY3JpcHQgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwoJCQkJc2NyaXB0LmlkID0gc2NyaXB0c1tpXS5pZDsKCQkJCXNjcmlwdC50ZXh0ID0gc2NyaXB0c1tpXS50ZXh0Q29udGVudDsKCQkJCXNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCBzY3JpcHRzW2ldLmdldEF0dHJpYnV0ZSgndHlwZScpKTsKCQkJCXRoaXMuZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQl9CgkJfQoJfTsKCglPdXRsZXQucHJvdG90eXBlLmluZGljYXRlUGFnZUlzTG9hZGluZyA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgiZGF0YS1sb2FkaW5nIiwgInRydWUiKTsKCX07CgoJT3V0bGV0LnByb3RvdHlwZS5wYWdlSGFzTG9hZGVkID0gZnVuY3Rpb24oKXsKCQl0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKCJkYXRhLWxvYWRpbmciLCAiZmFsc2UiKTsKCX07CgoJcmV0dXJuIE91dGxldDsKCn0pOwpkZWZpbmUoJ29yZG51bmcvc3BhL3doZW5Db250ZXh0JyxbCgkKXSwgZnVuY3Rpb24oCgkKKXsKCglmdW5jdGlvbiB1bnN1YnNjcmliZShldmVudCwgcmVhY3Rpb24pewoJCWV2ZW50LmRvbnQocmVhY3Rpb24pOwoJfQoKCWZ1bmN0aW9uIHN1YnNjcmliZShldmVudCwgcmVhY3Rpb24pewoJCWV2ZW50KHJlYWN0aW9uKTsKCQlyZXR1cm4gZXZlbnQuZG9udC5iaW5kKG51bGwsIHJlYWN0aW9uKTsKCX0KCglmdW5jdGlvbiB3aGVuU29tZXRoaW5nKCl7CgkJaWYodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcigiVGhpcyBjb250ZXh0IGhhcyBiZWVuIGRlc3Ryb3llZCEiKTsKCgkJaWYoYXJndW1lbnRzLmxlbmd0aCA9PSAwKXsKCQkJdmFyIGNoaWxkQ29udGV4dCA9IGNyZWF0ZUNvbnRleHQoKTsKCQkJdGhpcy5jaGlsZENvbnRleHRzLnB1c2goY2hpbGRDb250ZXh0KTsKCQkJcmV0dXJuIGNoaWxkQ29udGV4dC53aGVuOwoJCX1lbHNlIGlmKGFyZ3VtZW50cy5sZW5ndGggPT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAiZnVuY3Rpb24iKXsKCQkJcmV0dXJuIHsKCQkJCWRvbnQ6IHVuc3Vic2NyaWJlLmJpbmQobnVsbCwgYXJndW1lbnRzWzBdKQoJCQl9CgkJfWVsc2UgaWYoYXJndW1lbnRzLmxlbmd0aCA9PSAyICYmIHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICJmdW5jdGlvbiIpewoJCQl0aGlzLmV2ZW50U3Vic2NyaWJlcnMucHVzaChzdWJzY3JpYmUoYXJndW1lbnRzWzBdLCBhcmd1bWVudHNbMV0pKTsKCQl9Cgl9CgoJZnVuY3Rpb24gdGhpc0lzRGVzdHJveWVkKHJlYWN0aW9uKXsKCQl0aGlzLm9uRGVzdHJveUxpc3RlbmVycy5wdXNoKHJlYWN0aW9uKTsKCX0KCglmdW5jdGlvbiBkZXN0cm95Q2hpbGRDb250ZXh0cygpewoJCXZhciBjb250ZXh0OwoJCXdoaWxlKGNvbnRleHQgPSB0aGlzLmNoaWxkQ29udGV4dHMucG9wKCkpCgkJCWNvbnRleHQuZGVzdHJveUNvbnRleHQoKTsKCX0KCglmdW5jdGlvbiBkZXN0cm95Q29udGV4dCgpewoJCXZhciBzdWJzY3JpYmVyLCBsaXN0ZW5lciwgY29udGV4dDsKCQl3aGlsZShzdWJzY3JpYmVyID0gdGhpcy5ldmVudFN1YnNjcmliZXJzLnBvcCgpKQoJCQlzdWJzY3JpYmVyKCk7CgkJd2hpbGUobGlzdGVuZXIgPSB0aGlzLm9uRGVzdHJveUxpc3RlbmVycy5wb3AoKSkKCQkJbGlzdGVuZXIoKTsKCQl3aGlsZShjb250ZXh0ID0gdGhpcy5jaGlsZENvbnRleHRzLnBvcCgpKQoJCQljb250ZXh0LmRlc3Ryb3lDb250ZXh0KCk7CgkJdGhpcy5kZXN0cm95ZWQgPSB0cnVlOwoJfQoKCWZ1bmN0aW9uIGNyZWF0ZUNvbnRleHQoKXsKCQl2YXIgY29udGV4dCA9IHsKCQkJZGVzdHJveWVkOiBmYWxzZSwKCQkJb25EZXN0cm95TGlzdGVuZXJzOiBbXSwKCQkJY2hpbGRDb250ZXh0czogW10sCgkJCWV2ZW50U3Vic2NyaWJlcnM6IFtdCgkJfTsKCgkJdmFyIHdoZW4gPSB3aGVuU29tZXRoaW5nLmJpbmQoY29udGV4dCk7CgoJCXdoZW4udGhpc0lzRGVzdHJveWVkID0gdGhpc0lzRGVzdHJveWVkLmJpbmQoY29udGV4dCk7CgoJCXdoZW4uZGVzdHJveUNoaWxkQ29udGV4dHMgPSBkZXN0cm95Q2hpbGRDb250ZXh0cy5iaW5kKGNvbnRleHQpOwoKCQlyZXR1cm4gewoJCQl3aGVuOiB3aGVuLAoJCQlkZXN0cm95Q29udGV4dDogZGVzdHJveUNvbnRleHQuYmluZChjb250ZXh0KQoJCX07Cgl9CgoJcmV0dXJuIGNyZWF0ZUNvbnRleHQoKS53aGVuOwp9KTsKZGVmaW5lKCdvcmRudW5nL3NwYS9hcHBseVZpZXdNb2RlbHMnLFsKCSJvcmRudW5nL3V0aWxzIiwKCSJvcmRudW5nL2Vycm9ySGFuZGxlciIsCgkia25vY2tvdXQiLCAKCSJ3aGVuIiwgCgkid2hlbi9jYWxsYmFja3MiCl0sIGZ1bmN0aW9uICgKCXV0aWxzLCAKCWVycm9ySGFuZGxlciwKCWtvLCAKCXdoZW4sIAoJY2FsbGJhY2tzCikgewoKCglmdW5jdGlvbiBnZXRBdHRyaWJ1dGVzKHRhcmdldCl7CgoJCXZhciB2aWV3TW9kZWxOYW1lID0gdGFyZ2V0LmdldEF0dHJpYnV0ZSgiZGF0YS12aWV3bW9kZWwiKTsKCQl2YXIgbW9kZWwgPSB0YXJnZXQuZ2V0QXR0cmlidXRlKCJkYXRhLW1vZGVsIik7CgkJaWYgKG1vZGVsICYmIG1vZGVsLmluZGV4T2YoInsiKSA9PSAwKSB7CgkJCW1vZGVsID0gSlNPTi5wYXJzZShtb2RlbCk7CgkJfQoKCQlyZXR1cm4gewoJCQl0YXJnZXQ6IHRhcmdldCwKCQkJdmlld01vZGVsTmFtZTogdmlld01vZGVsTmFtZSwKCQkJbW9kZWw6IG1vZGVsCgkJfTsKCX0KCgoJZnVuY3Rpb24gbG9hZFZpZXdNb2RlbChkYXRhKXsKCgkJcmV0dXJuIGNhbGxiYWNrcy5jYWxsKHJlcXVpcmUsIFsKCQkJZGF0YS52aWV3TW9kZWxOYW1lCgkJXSkudGhlbihmdW5jdGlvbihWaWV3TW9kZWwpewoJCQlkYXRhLlZpZXdNb2RlbCA9IFZpZXdNb2RlbDsKCQkJcmV0dXJuIGRhdGE7CgkJfSwgZnVuY3Rpb24oZXJyb3IpewoJCQllcnJvckhhbmRsZXIub25FcnJvcihuZXcgRXJyb3IoIkNvdWxkIG5vdCBsb2FkIHRoZSBmb2xsb3dpbmcgbW9kdWxlczpcbiIrZXJyb3IucmVxdWlyZU1vZHVsZXMuam9pbigiXG4iKSkpOwoJCQlyZXR1cm4gbnVsbDsKCQl9KTsKCX0KCglmdW5jdGlvbiBhcHBseVZpZXdNb2RlbChzdWJzY3JpYmUsIGRhdGEpIHsKCQl0cnl7CgkJCXZhciB2aWV3TW9kZWwgPSBuZXcgZGF0YS5WaWV3TW9kZWwoZGF0YS5tb2RlbCB8fCB7fSwgc3Vic2NyaWJlKTsKCQkJa28uYXBwbHlCaW5kaW5ncyh2aWV3TW9kZWwsIGRhdGEudGFyZ2V0KTsKCQl9Y2F0Y2goZSl7CgkJCWVycm9ySGFuZGxlci5vbkVycm9yKGUpOwoJCX0KCX0KCglmdW5jdGlvbiB2aWV3TW9kZWxMb2FkZWRTdWNjZXNzZnVsbHkoZGF0YSl7CgkJcmV0dXJuIGRhdGEgIT0gbnVsbCAmJiBkYXRhLlZpZXdNb2RlbCAhPSBudWxsOwoJfQoKCXJldHVybiBmdW5jdGlvbiAoZG9tRWxlbWVudCwgc3Vic2NyaWJlKSB7CgoJCWRvbUVsZW1lbnQgPSBkb21FbGVtZW50IHx8IGRvY3VtZW50LmJvZHk7CgoJCXZhciBlbGVtZW50TGlzdCA9IHV0aWxzLnRvQXJyYXkoZG9tRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCIqW2RhdGEtdmlld21vZGVsXSIpKTsKCgkJdmFyIHZpZXdNb2RlbHNMb2FkZWQgPSBlbGVtZW50TGlzdC5tYXAoZ2V0QXR0cmlidXRlcykubWFwKGxvYWRWaWV3TW9kZWwpOwoKCQlyZXR1cm4gd2hlbi5hbGwodmlld01vZGVsc0xvYWRlZCkudGhlbihmdW5jdGlvbihsaXN0KXsKCQkJbGlzdC5maWx0ZXIodmlld01vZGVsTG9hZGVkU3VjY2Vzc2Z1bGx5KS5mb3JFYWNoKGFwcGx5Vmlld01vZGVsLmJpbmQobnVsbCwgc3Vic2NyaWJlKSkKCQl9KTsKCX07Cn0pOwpkZWZpbmUoJ29yZG51bmcvc3BhL2hhc2hOYXZpZ2F0aW9uJyxbCgkib3JkbnVuZy91dGlscyIKXSxmdW5jdGlvbigKCV8KKXsKCgoJCglmdW5jdGlvbiBuZXdQYXRoKGN1cnJlbnRQYXRoLCBsaW5rLCBpbmRleCl7CgkJdmFyIGlzUmVsYXRpdmUgPSBfLnN0YXJ0c1dpdGgobGluaywgJy8nKSA9PT0gZmFsc2U7CgkJdmFyIGlzRm9sZGVyID0gXy5lbmRzV2l0aChsaW5rLCAnLycpOwoJCQoJCWlmKGxpbmsgPT09ICIvIil7CgkJCXZhciBwYXRoID0gW107CgkJfWVsc2UgaWYobGluayA9PT0gIiIpewoJCQl2YXIgcGF0aCA9IFtpbmRleF07CgkJfWVsc2V7CgkJCXZhciBwYXRoID0gXy50cmltKGxpbmssICIvIikuc3BsaXQoIi8iKTsKCQl9CgoJCWlmKGlzRm9sZGVyKXsKCQkJcGF0aC5wdXNoKGluZGV4KTsKCQl9CgkJaWYoaXNSZWxhdGl2ZSl7CgkJCXBhdGggPSBfLnBvcFRhaWwoY3VycmVudFBhdGgpLmNvbmNhdChwYXRoKTsKCQl9CgoJCXZhciBvdXQgPSBbXTsKCgkJZm9yKHZhciBpID0gcGF0aC5sZW5ndGg+Pj4wOyBpLS07KXsKCQkJaWYocGF0aFtpXSA9PT0gIiIpewoJCQkJY29udGludWU7CgkJCX1lbHNlIGlmKHBhdGhbaV0gPT09ICIuIil7CgkJCQljb250aW51ZTsKCQkJfWVsc2UgaWYocGF0aFtpXSA9PT0gIi4uIikgewoJCQkJaS0tOwoJCQl9ZWxzZXsKCQkJCW91dC51bnNoaWZ0KHBhdGhbaV0pOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0OwoJfQoKCWZ1bmN0aW9uIGhhc2hDaGFuZ2VkKGNvbmZpZywgb25QYWdlQ2hhbmdlZCwgZG9jdW1lbnQpewoKCQl2YXIgcGF0aCA9IF8uYWZ0ZXIoZG9jdW1lbnQubG9jYXRpb24uaHJlZiwgJyMnKTsKCgkJdmFyIGlzUmVsYXRpdmUgPSBfLnN0YXJ0c1dpdGgocGF0aCwgJy8nKSA9PSBmYWxzZTsKCQl2YXIgaXNGb2xkZXIgPSBfLmVuZHNXaXRoKHBhdGgsICcvJyk7CgoJCWlmKGlzUmVsYXRpdmUgfHwgaXNGb2xkZXIpewoJCQl2YXIgbmV3SGFzaCA9IG5ld1BhdGgodGhpcy5jdXJyZW50UGF0aCwgcGF0aCwgY29uZmlnLmluZGV4KS5qb2luKCcvJyk7CgkJCWRvY3VtZW50LmxvY2F0aW9uLnJlcGxhY2UoIiMvIiArIG5ld0hhc2gpOwoJCX1lbHNlewoJCQl0aGlzLmN1cnJlbnRQYXRoID0gbmV3UGF0aCh0aGlzLmN1cnJlbnRQYXRoLCBwYXRoLCBjb25maWcuaW5kZXgpOwoJCQlvblBhZ2VDaGFuZ2VkKHRoaXMuY3VycmVudFBhdGguam9pbignLycpLCB0aGlzLmN1cnJlbnRQYXRoLm1hcChmdW5jdGlvbihwKXtyZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHApO30pKTsKCQl9CgoJfQoJCglmdW5jdGlvbiBzdGFydEhhc2hOYXZpZ2F0aW9uKGNvbmZpZywgb25QYWdlQ2hhbmdlZCwgZG9jLCBnbG9iYWwpewoJCWRvYyA9IGRvYyB8fCBkb2N1bWVudDsKCQlnbG9iYWwgPSBnbG9iYWwgfHwgd2luZG93OwoKCQl2YXIgc3RhdGUgPSB7CgkJCWN1cnJlbnRQYXRoOiBbXQoJCX07CgkJdmFyIG9uSGFzaENoYW5nZWQgPSBoYXNoQ2hhbmdlZC5iaW5kKHN0YXRlLCBjb25maWcsIG9uUGFnZUNoYW5nZWQsIGRvYyk7CgkJb25IYXNoQ2hhbmdlZCgpOwoJCV8uYWRkRXZlbnRMaXN0ZW5lcihnbG9iYWwsICJoYXNoY2hhbmdlIiwgb25IYXNoQ2hhbmdlZCwgZmFsc2UpOwoKCQlyZXR1cm4gewoJCQlzdG9wOiBmdW5jdGlvbigpewoJCQkJZ2xvYmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImhhc2hjaGFuZ2UiLCBvbkhhc2hDaGFuZ2VkLCBmYWxzZSk7CgkJCX0KCQl9OwoJfQoKCglyZXR1cm4gewoJCXN0YXJ0OiBzdGFydEhhc2hOYXZpZ2F0aW9uCgl9OwoKfSk7CmRlZmluZSgnb3JkbnVuZy9zcGEvUGFnZUxvYWRlcicsWwoJIm9yZG51bmcvYWpheCIKXSwgZnVuY3Rpb24oCglhamF4Cil7CgoJZnVuY3Rpb24gUGFnZUxvYWRlcihjb25maWcpewoJCXRoaXMucGF0aFRvVXJsID0gY29uZmlnICYmIGNvbmZpZy5wYXRoVG9VcmwgfHwgZnVuY3Rpb24oYSl7IHJldHVybiBhOyB9OwoJCXRoaXMuY2FjaGUgPSAoY29uZmlnICYmICdjYWNoZVBhZ2VzJyBpbiBjb25maWcgPyBjb25maWcuY2FjaGVQYWdlcyA6IHRydWUpOwoJCXRoaXMuY3VycmVudFhIUiA9IG51bGw7Cgl9CgoJUGFnZUxvYWRlci5wcm90b3R5cGUubG9hZFBhZ2UgPSBmdW5jdGlvbihwYXRoLCByZXNvbHZlcil7CgoJCXRoaXMuYWJvcnQoKTsKCgkJdmFyIHVybCA9IHRoaXMucGF0aFRvVXJsKHBhdGgpOwoKCQlpZih0aGlzLmNhY2hlID09PSBmYWxzZSkKCQkJdXJsID0gYWpheC5jYWNoZUJ1c3QodXJsKTsKCgkJdGhpcy5jdXJyZW50WEhSID0gYWpheCh1cmwsIHt9LCAiR0VUIiwgZnVuY3Rpb24oeGhyKXsKCQkJaWYoeGhyLnN0YXR1cyA9PT0gMjAwKQoJCQkJcmVzb2x2ZXIucmVzb2x2ZSh4aHIucmVzcG9uc2VUZXh0KTsKCQkJZWxzZQoJCQkJcmVzb2x2ZXIucmVqZWN0KHtlcnJvcjogeGhyLnN0YXR1cywgY29udGVudDogeGhyLnJlc3BvbnNlVGV4dH0pOwoJCX0pOwoJfTsKCglQYWdlTG9hZGVyLnByb3RvdHlwZS5hYm9ydCA9IGZ1bmN0aW9uKCl7CgkJaWYodGhpcy5jdXJyZW50WEhSICYmIHRoaXMuY3VycmVudFhIUi5yZWFkeVN0YXRlICE9PSA0KXsKCQkJdGhpcy5jdXJyZW50WEhSLmFib3J0KCk7CgkJfQoJfTsKCglyZXR1cm4gUGFnZUxvYWRlcjsKfSk7CmRlZmluZSgnb3JkbnVuZy9zcGEvVGVtcGxhdGVzJyxbCgkib3JkbnVuZy9zcGEvUGFnZUxvYWRlciIsCgkib3JkbnVuZy91dGlscyIsCgkid2hlbiIKXSwgZnVuY3Rpb24oCglQYWdlTG9hZGVyLAoJdXRpbHMsCgl3aGVuCil7CgoJZnVuY3Rpb24gZGVmYXVsdENvbmZpZygpewoJCXJldHVybiB7CgkJCXBhdGhUb1VybDogZnVuY3Rpb24oYSl7IHJldHVybiBhOyB9CgkJfQoJfQoKCWZ1bmN0aW9uIGZpbmRUZW1wbGF0ZXNJbkRvY3VtZW50KGRvYyl7CgoJCXZhciBub2RlTGlzdCA9IGRvYy5xdWVyeVNlbGVjdG9yQWxsKCJbdHlwZT0ndGV4dC9wYWdlLXRlbXBsYXRlJ10iKTsKCQl2YXIgbm9kZXMgPSB1dGlscy50b0FycmF5KG5vZGVMaXN0KTsKCQl2YXIgdGVtcGxhdGVMaXN0ID0gbm9kZXMubWFwKGZ1bmN0aW9uKHRlbXBsYXRlKXsKCQkJcmV0dXJuIHsKCQkJCWlkOiB0ZW1wbGF0ZS5pZC50b0xvd2VyQ2FzZSgpLAoJCQkJY29udGVudDogdGVtcGxhdGUuaW5uZXJIVE1MCgkJCX07CgkJfSk7CgoJCXJldHVybiB1dGlscy5hcnJheVRvT2JqZWN0KHRlbXBsYXRlTGlzdCwgZnVuY3Rpb24oaXRlbSwgb2JqZWN0KXsKCQkJb2JqZWN0W2l0ZW0uaWRdID0gaXRlbS5jb250ZW50OwoJCX0pOwoJfQoKCglmdW5jdGlvbiBUZW1wbGF0ZXMoZG9jdW1lbnQsIGNvbmZpZyl7CgkJdGhpcy5wYWdlTG9hZGVyID0gbmV3IFBhZ2VMb2FkZXIoY29uZmlnIHx8IGRlZmF1bHRDb25maWcoKSk7CgkJdGhpcy5jYWNoZVBhZ2VzID0gKGNvbmZpZyAmJiAnY2FjaGVQYWdlcycgaW4gY29uZmlnID8gY29uZmlnLmNhY2hlUGFnZXMgOiB0cnVlKQoJCXRoaXMudGVtcGxhdGVzID0gZmluZFRlbXBsYXRlc0luRG9jdW1lbnQoZG9jdW1lbnQpOwoJfQoKCVRlbXBsYXRlcy5wcm90b3R5cGUuZ2V0VGVtcGxhdGUgPSBmdW5jdGlvbihwYXRoKXsKCgkJdGhpcy5wYWdlTG9hZGVyLmFib3J0KCk7CgoJCXZhciBub3JtYWxpemVkUGF0aCA9IHBhdGgudG9Mb3dlckNhc2UoKTsKCgkJaWYobm9ybWFsaXplZFBhdGggaW4gdGhpcy50ZW1wbGF0ZXMpewoJCQlyZXR1cm4gd2hlbi5yZXNvbHZlKHRoaXMudGVtcGxhdGVzW25vcm1hbGl6ZWRQYXRoXSk7CgkJfWVsc2V7CgkJCXZhciBkZWZlcnJlZCA9IHdoZW4uZGVmZXIoKTsKCgkJCXRoaXMucGFnZUxvYWRlci5sb2FkUGFnZShwYXRoLCBkZWZlcnJlZC5yZXNvbHZlcik7CgkJCQoJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uKGNvbnRlbnQpewoJCQkJaWYodGhpcy5jYWNoZVBhZ2VzKQoJCQkJCXRoaXMudGVtcGxhdGVzW25vcm1hbGl6ZWRQYXRoXSA9IGNvbnRlbnQ7CgkJCQkKCQkJCXJldHVybiBjb250ZW50OwoJCQl9LmJpbmQodGhpcyksIGZ1bmN0aW9uKG5vdEZvdW5kKXsKCQkJCXZhciBlcnJvclRlbXBsYXRlID0gImVycm9yIiArIG5vdEZvdW5kLmVycm9yOwoJCQkJaWYoZXJyb3JUZW1wbGF0ZSBpbiB0aGlzLnRlbXBsYXRlcyl7CgkJCQkJcmV0dXJuIHRoaXMudGVtcGxhdGVzW2Vycm9yVGVtcGxhdGVdOwoJCQkJfWVsc2V7CgkJCQkJcmV0dXJuIG5vdEZvdW5kLmNvbnRlbnQ7CgkJCQl9CgkJCX0uYmluZCh0aGlzKSk7CgkJfQoJfTsKCglyZXR1cm4gVGVtcGxhdGVzOwp9KTsKZGVmaW5lKCdvcmRudW5nL3Byb2NsYWltV2hlbicsW10sIGZ1bmN0aW9uICgpIHsKCglmdW5jdGlvbiBwdWJsaXNoKG5hbWUsIHN1YnNjcmliZXJzLCBkYXRhKSB7CgkJc3Vic2NyaWJlcnMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewoJCQlpdGVtLmFwcGx5KGl0ZW0sIGRhdGEpOwoJCX0pOwoJfQoKCWZ1bmN0aW9uIHN1YnNjcmliZVRvKG5hbWUsIHN1YnNjcmliZXJzLCBzdWJzY3JpYmVyKSB7CgkJdmFyIGluZGV4ID0gc3Vic2NyaWJlcnMuaW5kZXhPZihzdWJzY3JpYmVyKTsKCQlpZihpbmRleCA8IDApCgkJCXN1YnNjcmliZXJzLnB1c2goc3Vic2NyaWJlcik7CgkJcmV0dXJuIGluZGV4IDwgMDsKCX0KCQoJZnVuY3Rpb24gdW5zdWJzY3JpYmVGcm9tKG5hbWUsIHN1YnNjcmliZXJzLCBzdWJzY3JpYmVyKXsKCQl2YXIgaW5kZXggPSBzdWJzY3JpYmVycy5pbmRleE9mKHN1YnNjcmliZXIpOwoJCWlmKGluZGV4ID49IDApCgkJCXN1YnNjcmliZXJzLnNwbGljZShpbmRleCwgMSk7CgkJcmV0dXJuIGluZGV4ID49IDA7Cgl9CglmdW5jdGlvbiBleHRlbmRFdmVudChuYW1lLCBldmVudCl7CgkJZXZlbnQuc3Vic2NyaWJlcnMgPSBbXTsKCQlldmVudC5zdWJzY3JpYmVTdWJzY3JpYmVycyA9IFtdOwoJCWV2ZW50LnVuc3Vic2NyaWJlU3Vic2NyaWJlcnMgPSBbXTsKCgkJdmFyIGV4dGVuZGVkRXZlbnQgPSBmdW5jdGlvbigpewoJCQlpZihhcmd1bWVudHMubGVuZ3RoID09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gImZ1bmN0aW9uIil7CgkJCQlpZihzdWJzY3JpYmVUbyhuYW1lLCBldmVudC5zdWJzY3JpYmVycywgYXJndW1lbnRzWzBdKSkKCQkJCQlwdWJsaXNoKG5hbWUrIi5pc1N1YnNjcmliZWRUbyIsIGV2ZW50LnN1YnNjcmliZVN1YnNjcmliZXJzKTsKCQkJfWVsc2V7CgkJCQlwdWJsaXNoKG5hbWUsIGV2ZW50LnN1YnNjcmliZXJzLCBhcmd1bWVudHMpOwoJCQl9CgkJfQoKCQlleHRlbmRlZEV2ZW50LmRvbnQgPSBmdW5jdGlvbihzdWJzY3JpYmVyKXsKCQkJaWYodW5zdWJzY3JpYmVGcm9tKG5hbWUsIGV2ZW50LnN1YnNjcmliZXJzLCBzdWJzY3JpYmVyKSkKCQkJCXB1Ymxpc2gobmFtZSsiLmlzVW5zdWJzY3JpYmVkRnJvbSIsIGV2ZW50LnVuc3Vic2NyaWJlU3Vic2NyaWJlcnMpOwoJCX07CgoJCWV4dGVuZGVkRXZlbnQuaXNTdWJzY3JpYmVkVG8gPSBmdW5jdGlvbihzdWJzY3JpYmVyKXsKCQkJc3Vic2NyaWJlVG8obmFtZSsiLmlzU3Vic2NyaWJlZFRvIiwgZXZlbnQuc3Vic2NyaWJlU3Vic2NyaWJlcnMsIHN1YnNjcmliZXIpOwoJCX07CgoJCWV4dGVuZGVkRXZlbnQuaXNTdWJzY3JpYmVkVG8uZG9udCA9IGZ1bmN0aW9uKHN1YnNjcmliZXIpewoJCQl1bnN1YnNjcmliZUZyb20obmFtZSsiLmlzU3Vic2NyaWJlZFRvIiwgZXZlbnQuc3Vic2NyaWJlU3Vic2NyaWJlcnMsIHN1YnNjcmliZXIpOwoJCX07CgoJCWV4dGVuZGVkRXZlbnQuaXNVbnN1YnNjcmliZWRGcm9tID0gZnVuY3Rpb24oc3Vic2NyaWJlcil7CgkJCXN1YnNjcmliZVRvKG5hbWUrIi5pc1Vuc3Vic2NyaWJlZEZyb20iLCBldmVudC51bnN1YnNjcmliZVN1YnNjcmliZXJzLCBzdWJzY3JpYmVyKTsKCQl9OwoKCQlleHRlbmRlZEV2ZW50LmlzVW5zdWJzY3JpYmVkRnJvbS5kb250ID0gZnVuY3Rpb24oc3Vic2NyaWJlcil7CgkJCXVuc3Vic2NyaWJlRnJvbShuYW1lKyIuaXNVbnN1YnNjcmliZWRGcm9tIiwgZXZlbnQudW5zdWJzY3JpYmVTdWJzY3JpYmVycywgc3Vic2NyaWJlcik7CgkJfTsKCgkJZXh0ZW5kZWRFdmVudC50b1N0cmluZyA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiAiW0V2ZW50ICIrbmFtZSsiXSI7CgkJfQoKCQlyZXR1cm4gZXh0ZW5kZWRFdmVudDsKCX0KCQoJZnVuY3Rpb24gZXh0ZW5kKGV2ZW50cyl7CgkJZm9yKHZhciBpIGluIGV2ZW50cyl7CgkJCWV2ZW50c1tpXSA9IGV4dGVuZEV2ZW50KGksIGV2ZW50c1tpXSk7CgkJfQoJCXJldHVybiBldmVudHM7Cgl9CgoJZnVuY3Rpb24gY3JlYXRlKGFyZzEsIGFyZzIpewoJCWlmKGFyZzIpCgkJCXJldHVybiBleHRlbmRFdmVudChhcmcxLCBhcmcyKTsKCQllbHNlCgkJCXJldHVybiBleHRlbmRFdmVudCgiYW5vbnltb3VzIGV2ZW50IiwgYXJnMSkKCX0KCglyZXR1cm4gewoJCWV4dGVuZDogZXh0ZW5kLAoJCWNyZWF0ZTogY3JlYXRlCgl9OwoJCn0pOwoKZGVmaW5lKCdvcmRudW5nL2V2ZW50cycsWydvcmRudW5nL3Byb2NsYWltV2hlbiddLCBmdW5jdGlvbihwcm9jbGFpbVdoZW4pewoJcmV0dXJuIHByb2NsYWltV2hlbi5leHRlbmQoewoJCXRoZVBhZ2VIYXNDaGFuZ2VkOiBmdW5jdGlvbihwYXRoLCBzZWdtZW50cywgdXJsKXsgfQoJfSk7Cn0pOwpkZWZpbmUoJ29yZG51bmcvc3BhJyxbCgkib3JkbnVuZy9zcGEvT3V0bGV0IiwKCSJvcmRudW5nL3NwYS93aGVuQ29udGV4dCIsCgkib3JkbnVuZy9zcGEvYXBwbHlWaWV3TW9kZWxzIiwKCSJvcmRudW5nL3NwYS9oYXNoTmF2aWdhdGlvbiIsCgkib3JkbnVuZy9zcGEvVGVtcGxhdGVzIiwKCSJvcmRudW5nL3V0aWxzIiwKCSJvcmRudW5nL2V2ZW50cyIKXSwgZnVuY3Rpb24oCglPdXRsZXQsCgl3aGVuQ29udGV4dCwKCWFwcGx5Vmlld01vZGVscywKCWhhc2hOYXZpZ2F0aW9uLAoJVGVtcGxhdGVzLAoJdXRpbHMsCglwcm9jbGFpbQopewoKCXZhciBfY29uZmlnID0gewoJCQlpbmRleDogImluZGV4IgoJCX0sCgkJX2RvY3VtZW50LAoJCV9vdXRsZXQsCgkJX29yaWdpbmFsVGl0bGUsCgkJX3RlbXBsYXRlcywKCQlfd2hlbkNvbnRleHQ7CgoJZnVuY3Rpb24gYXBwbHlDb250ZW50KGNvbnRlbnQpewoJCV9vdXRsZXQudW5sb2FkQ3VycmVudFBhZ2UoKTsKCQlfb3V0bGV0LnNldFBhZ2VDb250ZW50KGNvbnRlbnQpOwoJCV9vdXRsZXQuc2V0RG9jdW1lbnRUaXRsZShfb3V0bGV0LmdldFBhZ2VUaXRsZSgpIHx8IF9vcmlnaW5hbFRpdGxlKTsKCQlfb3V0bGV0LmV4dHJhY3RBbmRSdW5QYWdlSmF2YVNjcmlwdCgpOwoJCXJldHVybiBhcHBseVZpZXdNb2RlbHMoX291dGxldC5lbGVtZW50LCBfd2hlbkNvbnRleHQoKSk7Cgl9CgoJZnVuY3Rpb24gcGFnZUNoYW5nZWQocGF0aCwgc2VnbWVudHMpewoJCV9vdXRsZXQuaW5kaWNhdGVQYWdlSXNMb2FkaW5nKCk7CgkJX3doZW5Db250ZXh0LmRlc3Ryb3lDaGlsZENvbnRleHRzKCk7CgkJcmV0dXJuIF90ZW1wbGF0ZXMuZ2V0VGVtcGxhdGUocGF0aCkKCQkJLnRoZW4oYXBwbHlDb250ZW50KQoJCQkudGhlbihmdW5jdGlvbigpewoJCQkJX291dGxldC5wYWdlSGFzTG9hZGVkKCk7CgkJCQlwcm9jbGFpbS50aGVQYWdlSGFzQ2hhbmdlZChwYXRoLCBzZWdtZW50cywgZG9jdW1lbnQubG9jYXRpb24pCgkJCX0pOwoJfQoKCWZ1bmN0aW9uIHN0YXJ0KGNvbmZpZywgZG9jdW1lbnQpewoJCV9kb2N1bWVudCA9IGRvY3VtZW50IHx8IHdpbmRvdy5kb2N1bWVudDsKCQlfY29uZmlnID0gdXRpbHMuZXh0ZW5kKF9jb25maWcsIGNvbmZpZyk7CgkJX291dGxldCA9IG5ldyBPdXRsZXQoX2RvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIltkYXRhLW91dGxldF0iKSwgX2RvY3VtZW50KTsKCQlfb3JpZ2luYWxUaXRsZSA9IF9kb2N1bWVudC50aXRsZTsKCQlfd2hlbkNvbnRleHQgPSB3aGVuQ29udGV4dCgpOwoKCQlyZXR1cm4gYXBwbHlWaWV3TW9kZWxzKF9kb2N1bWVudCwgd2hlbkNvbnRleHQoKSkudGhlbihmdW5jdGlvbigpewoJCQlpZihfb3V0bGV0Lm91dGxldEV4aXN0cygpKXsKCQkJCV90ZW1wbGF0ZXMgPSBuZXcgVGVtcGxhdGVzKF9kb2N1bWVudCwgX2NvbmZpZyk7CgkJCQloYXNoTmF2aWdhdGlvbi5zdGFydChfY29uZmlnLCBwYWdlQ2hhbmdlZCwgX2RvY3VtZW50KTsKCQkJfQoJCX0pOwoJfQoKCXJldHVybiB7CgkJc3RhcnQ6IHN0YXJ0Cgl9Owp9KTsKZGVmaW5lKCdvcmRudW5nL29yZG51bmcnLFsKICAnb3JkbnVuZy9xdmMnLAogICdvcmRudW5nL3NwYScKXSwgZnVuY3Rpb24oCiAgcXZjLAogIHNwYQopewoKICAKCiAgZnVuY3Rpb24gY29uZmlnKGNvbmZpZyl7CgogICAgY29uZmlnID0gY29uZmlnIHx8IHt9OwoKICAgIHZhciBzcGFDb25maWcgPSBjb25maWcuc3BhIHx8IHt9OwogICAgdmFyIHF2Y0NvbmZpZyA9IGNvbmZpZy5xdmMgfHwge307CgogICAgcXZjLmNvbmZpZyhxdmNDb25maWcpOwoKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBzcGEuc3RhcnQuYmluZChudWxsLCBzcGFDb25maWcsIGRvY3VtZW50KQogICAgfQogIH0KICAKICByZXR1cm4gewogICAgY29uZmlnOiBjb25maWcKICB9OwoKfSk7CmRlZmluZSgnb3JkbnVuZycsIFsnb3JkbnVuZy9vcmRudW5nJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgnb3JkbnVuZy9xdmMvY29uc3RyYWludHMvTm90RW1wdHknLFtdLCBmdW5jdGlvbigpewoJZnVuY3Rpb24gTm90RW1wdHkoYXR0cmlidXRlcyl7CgkJCgl9CgkKCU5vdEVtcHR5LnByb3RvdHlwZS5pc1ZhbGlkID0gZnVuY3Rpb24odmFsdWUpewoJCWlmKHZhbHVlID09IG51bGwpIHJldHVybiBmYWxzZTsKCQlpZih0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIgJiYgdmFsdWUubGVuZ3RoID09IDApIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX07CgkKCXJldHVybiBOb3RFbXB0eTsKfSk7CmRlZmluZSgnb3JkbnVuZy9xdmMvY29uc3RyYWludHMvUGF0dGVybicsW10sIGZ1bmN0aW9uKCl7CglmdW5jdGlvbiBQYXR0ZXJuKGF0dHJpYnV0ZXMpewkJCgoJCWF0dHJpYnV0ZXMuZmxhZ3MgPSBhdHRyaWJ1dGVzLmZsYWdzIHx8IFtdOwoJCQoJCXZhciBmbGFncyA9ICcnOwoJCWlmKGF0dHJpYnV0ZXMuZmxhZ3MuaW5kZXhPZigiQ0FTRV9JTlNFTlNJVElWRSIpID49IDApIGZsYWdzICs9ICdpJzsKCQkKCQl0aGlzLnJlZ2V4ID0gbmV3IFJlZ0V4cChhdHRyaWJ1dGVzLnJlZ2V4cCwgZmxhZ3MpOwoJfQoJCgkKCVBhdHRlcm4ucHJvdG90eXBlLmlzVmFsaWQgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCgkJaWYodmFsdWUgPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwoJCQoJCXZhciByZXN1bHQgPSB0aGlzLnJlZ2V4LmV4ZWModmFsdWUpOwoJCQoJCWlmKHJlc3VsdCA9PSBudWxsKSByZXR1cm4gZmFsc2U7CgkJCgkJcmV0dXJuIHJlc3VsdFswXSA9PSB2YWx1ZTsKCX07CgkKCQoJcmV0dXJuIFBhdHRlcm47Cn0pOwovLyMgc291cmNlTWFwcGluZ1VSTD1vcmRudW5nLmpzLm1hcA==",
                "body": "CmRlZmluZSgnb3JkbnVuZy91dGlscycsW10sIGZ1bmN0aW9uKCl7CglyZXR1cm4gewoJCXRvQXJyYXk6IGZ1bmN0aW9uKG9iail7CgkJCXZhciBhcnJheSA9IFtdOwoJCQkvLyBpdGVyYXRlIGJhY2t3YXJkcyBlbnN1cmluZyB0aGF0IGxlbmd0aCBpcyBhbiBVSW50MzIKCQkJZm9yICh2YXIgaSA9IG9iai5sZW5ndGggPj4+IDA7IGktLTspIHsgCgkJCQlhcnJheVtpXSA9IG9ialtpXTsKCQkJfQoJCQlyZXR1cm4gYXJyYXk7CgkJfSwKCQlleHRlbmQ6IGZ1bmN0aW9uKGRzdCwgc3JjKXsKCQkJc3JjID0gc3JjIHx8IHt9OwoJCQlkc3QgPSBkc3QgfHwge307CgkJCWZvcih2YXIgaSBpbiBzcmMpewoJCQkJZHN0W2ldID0gc3JjW2ldOwoJCQl9CgkJCXJldHVybiBkc3Q7CgkJfSwKCQlhcnJheVRvT2JqZWN0OiBmdW5jdGlvbihhcnJheSwgZnVuYyl7CgkJCXJldHVybiBhcnJheS5yZWR1Y2UoZnVuY3Rpb24oY29sbGVjdGlvbiwgaXRlbSl7CgkJCQlmdW5jKGl0ZW0sIGNvbGxlY3Rpb24pOwoJCQkJcmV0dXJuIGNvbGxlY3Rpb247CgkJCX0sIHt9KTsKCQl9LAoJCXRyaW06IGZ1bmN0aW9uKHdvcmQsIGNoYXJhY3Rlcil7CgkJCXdoaWxlKHdvcmQuY2hhckF0KDApID09IGNoYXJhY3Rlcikgd29yZCA9IHdvcmQuc3Vic3RyKDEpOwoJCQl3aGlsZSh3b3JkLmNoYXJBdCh3b3JkLmxlbmd0aCAtIDEpID09IGNoYXJhY3Rlcikgd29yZCA9IHdvcmQuc3Vic3RyKDAsIHdvcmQubGVuZ3RoIC0gMSk7CgkJCXJldHVybiB3b3JkOwoJCX0sCgkJYWZ0ZXI6IGZ1bmN0aW9uKHdvcmQsIGNoYXJhY3Rlcil7CgkJCXZhciBpbmRleCA9IHdvcmQuaW5kZXhPZihjaGFyYWN0ZXIpOwoJCQlpZihpbmRleCA8IDApewoJCQkJcmV0dXJuICIiOwoJCQl9ZWxzZXsKCQkJCXJldHVybiB3b3JkLnN1YnN0cihpbmRleCsxKTsKCQkJfQoJCX0sCgkJcG9wVGFpbDogZnVuY3Rpb24oYXJyYXkpewoJCQlyZXR1cm4gYXJyYXkuc2xpY2UoMCwgLTEpOwoJCX0sCgkJc3RhcnRzV2l0aDogZnVuY3Rpb24od29yZCwgY2hhcmFjdGVyKXsKCQkJcmV0dXJuIHdvcmQuY2hhckF0KDApID09PSBjaGFyYWN0ZXI7CgkJfSwKCQllbmRzV2l0aDogZnVuY3Rpb24od29yZCwgY2hhcmFjdGVyKXsKCQkJcmV0dXJuIHdvcmQuY2hhckF0KHdvcmQubGVuZ3RoIC0gMSkgPT09IGNoYXJhY3RlcjsKCQl9LAoJCWFkZEV2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIGV2ZW50LCBsaXN0ZW5lciwgYnViYmxlKXsKCQkJaWYoJ2FkZEV2ZW50TGlzdGVuZXInIGluIGVsZW1lbnQpewoJCQkJZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lciwgYnViYmxlKTsKCQkJfWVsc2V7CgkJCQllbGVtZW50LmF0dGFjaEV2ZW50KCJvbiIrZXZlbnQsIGxpc3RlbmVyKTsJCQoJCQl9CgkJfQoJfTsKfSk7CgpkZWZpbmUoJ29yZG51bmcvcXZjL0V4ZWN1dGFibGVSZXN1bHQnLFsib3JkbnVuZy91dGlscyJdLCBmdW5jdGlvbih1dGlscyl7CglmdW5jdGlvbiBFeGVjdXRhYmxlUmVzdWx0KHJlc3VsdCl7CgkJCgkJdGhpcy5zdWNjZXNzID0gZmFsc2U7CgkJdGhpcy52YWxpZCA9IGZhbHNlOwoJCXRoaXMucmVzdWx0ID0gbnVsbDsKCQl0aGlzLmV4Y2VwdGlvbiA9IG51bGw7CgkJdGhpcy52aW9sYXRpb25zID0gW107CgkKCQl1dGlscy5leHRlbmQodGhpcywgcmVzdWx0KTsKCQoJfTsKCQoJcmV0dXJuIEV4ZWN1dGFibGVSZXN1bHQ7Cn0pOwpkZWZpbmUoJ29yZG51bmcvcXZjL0NvbnN0cmFpbnQnLFtdLCBmdW5jdGlvbigpewoJCglmdW5jdGlvbiBDb25zdHJhaW50KHR5cGUsIGF0dHJpYnV0ZXMpewkJCgkJdGhpcy50eXBlID0gdHlwZTsKCQl0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwoJCXRoaXMubWVzc2FnZSA9IGF0dHJpYnV0ZXMubWVzc2FnZTsKCQkKCQkKCQl0aGlzLmluaXQodHlwZSk7Cgl9CgkJCglDb25zdHJhaW50LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24odHlwZSl7CgkJcmVxdWlyZShbIm9yZG51bmcvcXZjL2NvbnN0cmFpbnRzLyIgKyB0eXBlXSwgZnVuY3Rpb24oVGVzdGVyKXsKCQkJdmFyIHRlc3RlciA9IG5ldyBUZXN0ZXIodGhpcy5hdHRyaWJ1dGVzKTsKCQkJdGhpcy52YWxpZGF0ZSA9IHRlc3Rlci5pc1ZhbGlkLmJpbmQodGVzdGVyKTsKCQl9LmJpbmQodGhpcykpOwoJfTsKCQoJQ29uc3RyYWludC5wcm90b3R5cGUudmFsaWRhdGUgPSBmdW5jdGlvbih2YWx1ZSl7CgkJcmV0dXJuIHRydWU7Ly9yZWFsIHRlc3Qgbm90IGxvYWRlZCB5ZXQKCX07CgkKCQoJcmV0dXJuIENvbnN0cmFpbnQ7Cn0pOwpkZWZpbmUoJ29yZG51bmcvcXZjL1ZhbGlkYXRvcicsWwoJIm9yZG51bmcvcXZjL0NvbnN0cmFpbnQiLCAKCSJrbm9ja291dCIKXSwgZnVuY3Rpb24oCglDb25zdHJhaW50LCAKCWtvCil7CgoJZnVuY3Rpb24gaW50ZXJwb2xhdGUobWVzc2FnZSwgYXR0cmlidXRlcywgdmFsdWUsIG5hbWUsIHBhdGgpewoJCXJldHVybiBtZXNzYWdlLnJlcGxhY2UoL1x7KFtefV0rKVx9L2csIGZ1bmN0aW9uKG1hdGNoLCBrZXkpewoJCQlpZihrZXkgPT0gInZhbHVlIikgcmV0dXJuIHZhbHVlOwoJCQlpZihrZXkgPT0gInRoaXMubmFtZSIpIHJldHVybiBuYW1lOwoJCQlpZihrZXkgPT0gInRoaXMucGF0aCIpIHJldHVybiBwYXRoOwoJCQlpZihrZXkgaW4gYXR0cmlidXRlcykgcmV0dXJuIGF0dHJpYnV0ZXNba2V5XTsKCQkJcmV0dXJuIG1hdGNoOwoJCX0pOwoJfQoJCgoJZnVuY3Rpb24gVmFsaWRhdG9yKHRhcmdldCwgb3B0aW9ucyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCQoJCXRoaXMuY29uc3RyYWludHMgPSBbXTsKCQkKCQl0aGlzLmlzVmFsaWQgPSBrby5vYnNlcnZhYmxlKHRydWUpOwoJCXRoaXMubWVzc2FnZSA9IGtvLm9ic2VydmFibGUoIiIpOwoKCQl0aGlzLm5hbWUgPSBvcHRpb25zICYmIG9wdGlvbnMubmFtZTsKCQl0aGlzLnBhdGggPSBvcHRpb25zICYmIG9wdGlvbnMucGF0aDsKCX0KCQoJVmFsaWRhdG9yLnByb3RvdHlwZS5zZXRDb25zdHJhaW50cyA9IGZ1bmN0aW9uKGNvbnN0cmFpbnRzKXsKCQl0aGlzLmNvbnN0cmFpbnRzID0gY29uc3RyYWludHMubWFwKGZ1bmN0aW9uKGNvbnN0cmFpbnQpewoJCQlyZXR1cm4gbmV3IENvbnN0cmFpbnQoY29uc3RyYWludC5uYW1lLCBjb25zdHJhaW50LmF0dHJpYnV0ZXMpOwoJCX0pOwoJfTsKCQoJVmFsaWRhdG9yLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5pc1ZhbGlkKHRydWUpOwoJCXRoaXMubWVzc2FnZSgiIik7Cgl9OwoJCglWYWxpZGF0b3IucHJvdG90eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24odmFsdWUpewoJCWlmKHRoaXMuY29uc3RyYWludHMubGVuZ3RoID09IDApewoJCQl0aGlzLnJlc2V0KCk7CgkJfWVsc2UgaWYodGhpcy5jb25zdHJhaW50cy5ldmVyeShmdW5jdGlvbiAoY29uc3RyYWludCkgewoJCQlpZihjb25zdHJhaW50LnZhbGlkYXRlKHZhbHVlKSl7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfWVsc2V7CgkJCQl0aGlzLmlzVmFsaWQoZmFsc2UpOwoJCQkJdGhpcy5tZXNzYWdlKGludGVycG9sYXRlKGNvbnN0cmFpbnQubWVzc2FnZSwgY29uc3RyYWludC5hdHRyaWJ1dGVzLCB2YWx1ZSwgdGhpcy5uYW1lLCB0aGlzLnBhdGgpKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0uYmluZCh0aGlzKSkpewoJCQl0aGlzLmlzVmFsaWQodHJ1ZSk7CgkJCXRoaXMubWVzc2FnZSgiIik7CgkJfQoJfTsKCQoJcmV0dXJuIFZhbGlkYXRvcjsKfSk7CmRlZmluZSgnb3JkbnVuZy9xdmMva29FeHRlbnNpb25zJyxbIm9yZG51bmcvcXZjL1ZhbGlkYXRvciIsICJrbm9ja291dCJdLCBmdW5jdGlvbihWYWxpZGF0b3IsIGtvKXsKCglpZiAoa28gIT0gbnVsbCkgewoJCWtvLmJpbmRpbmdIYW5kbGVycy52YWxpZGF0aW9uTWVzc2FnZUZvciA9IHsKCQkJaW5pdDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzQWNjZXNzb3IsIHZpZXdNb2RlbCkgewoJCQkJdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpOwoJCQkJdmFyIHZhbGlkYXRvciA9IHZhbHVlLnZhbGlkYXRvcjsKCQkJCWlmICh2YWxpZGF0b3IpIHsKCQkJCQlrby5hcHBseUJpbmRpbmdzVG9Ob2RlKGVsZW1lbnQsIHsgaGlkZGVuOiB2YWxpZGF0b3IuaXNWYWxpZCwgdGV4dDogdmFsaWRhdG9yLm1lc3NhZ2UgfSwgdmFsaWRhdG9yKTsKCQkJCX1lbHNlewoJCQkJCXZhciBhdHRyaWJ1dGVzID0gQXJyYXkucHJvdG90eXBlLnJlZHVjZS5jYWxsKGVsZW1lbnQuYXR0cmlidXRlcywgZnVuY3Rpb24ocyxlKXtyZXR1cm4gcysiICIrZS5sb2NhbE5hbWUrIj1cIiIrZS52YWx1ZSsiXCIifSwgIiIpOwoJCQkJCXRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IGJpbmQgYHZhbGlkYXRpb25NZXNzYWdlRm9yYCB0byB2YWx1ZSBvbiBlbGVtZW50IDwiK2VsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpICsgYXR0cmlidXRlcyArIj4iKTsKCQkJCX0KCQkJfQoJCX07CgkJCgkJa28uZXh0ZW5kZXJzLnZhbGlkYXRpb24gPSBmdW5jdGlvbiAodGFyZ2V0LCBvcHRpb25zKSB7CgkJCXRhcmdldC52YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKHRhcmdldCwgb3B0aW9ucyk7CgkJCXRhcmdldC5zdWJzY3JpYmUoZnVuY3Rpb24gKG5ld1ZhbHVlKSB7CgkJCQl0YXJnZXQudmFsaWRhdG9yLnZhbGlkYXRlKG5ld1ZhbHVlKTsKCQkJfSk7CgkJCXJldHVybiB0YXJnZXQ7CgkJfTsKCQkKCQlrby5iaW5kaW5nSGFuZGxlcnMuY29tbWFuZCA9IGtvLmJpbmRpbmdIYW5kbGVycy5xdWVyeSA9IHsKCQkJaW5pdDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdBY2Nlc3Nvciwgdmlld01vZGVsKSB7CgkJCQlrby5hcHBseUJpbmRpbmdzVG9Ob2RlKGVsZW1lbnQsIHsgY2xpY2s6IHZhbHVlQWNjZXNzb3IoKSB9LCB2aWV3TW9kZWwpOwoJCQl9CgkJfTsKCX0KCQoKfSk7CmRlZmluZSgnb3JkbnVuZy9xdmMvVmFsaWRhdGFibGUnLFsib3JkbnVuZy91dGlscyIsICJvcmRudW5nL3F2Yy9WYWxpZGF0b3IiLCAia25vY2tvdXQiLCAib3JkbnVuZy9xdmMva29FeHRlbnNpb25zIl0sZnVuY3Rpb24odXRpbHMsIFZhbGlkYXRvciwga28pewoJCglmdW5jdGlvbiByZWN1cnNpdmx5RXh0ZW5kUGFyYW1ldGVycyhwYXJhbWV0ZXJzLCB2YWxpZGF0YWJsZUZpZWxkcywgcGFyZW50cykgewoJCWZvciAodmFyIGtleSBpbiBwYXJhbWV0ZXJzKSB7CgkJCXZhciBwcm9wZXJ0eSA9IHBhcmFtZXRlcnNba2V5XTsKCQkJdmFyIHBhdGggPSBwYXJlbnRzLmNvbmNhdChba2V5XSk7CgkJCWlmIChrby5pc09ic2VydmFibGUocHJvcGVydHkpKSB7CgkJCQlwcm9wZXJ0eS5leHRlbmQoewoJCQkJCXZhbGlkYXRpb246IHsKCQkJCQkJbmFtZTprZXksCgkJCQkJCXBhdGg6cGF0aC5qb2luKCIuIikKCQkJCQl9CgkJCQl9KTsKCQkJCXZhbGlkYXRhYmxlRmllbGRzLnB1c2gocHJvcGVydHkpOwoJCQl9CgkJCXByb3BlcnR5ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShwcm9wZXJ0eSk7CgkJCWlmICh0eXBlb2YgcHJvcGVydHkgPT09ICJvYmplY3QiKSB7CgkJCQlyZWN1cnNpdmx5RXh0ZW5kUGFyYW1ldGVycyhwcm9wZXJ0eSwgdmFsaWRhdGFibGVGaWVsZHMsIHBhdGgpOwoJCQl9CgkJfQoJfQoKCglmdW5jdGlvbiBmaW5kRmllbGQoZmllbGRQYXRoLCBwYXJhbWV0ZXJzLCBlcnJvck1lc3NhZ2UpewoJCXJldHVybiBmaWVsZFBhdGguc3BsaXQoIi4iKS5yZWR1Y2UoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKXsKCQkJdmFyIHBhdGggPSBvYmplY3QucGF0aDsKCQkJdmFyIGZpZWxkID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvYmplY3QuZmllbGQpOwoJCQlpZiAobmFtZSBpbiBmaWVsZCkgewoJCQkJcmV0dXJuIHsKCQkJCQlmaWVsZDogZmllbGRbbmFtZV0sCgkJCQkJcGF0aDogcGF0aCArICIuIiArIG5hbWUKCQkJCX07CgkJCX0gZWxzZSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlICsgIjogIiArIGZpZWxkUGF0aCArICJcbiIgKwoJCQkJCW5hbWUgKyAiIGlzIG5vdCBhIG1lbWJlciBvZiAiICsgcGF0aCArICJcbiIgKwoJCQkJCXBhdGggKyAiID0gYCIgKyBrby50b0pTT04oZmllbGQpICsgImAiKTsKCQkJfQoJCX0sIHsKCQkJZmllbGQ6IHBhcmFtZXRlcnMsCgkJCXBhdGg6ICJwYXJhbWV0ZXJzIgoJCX0pLmZpZWxkOwoJfQoKCgoJCglmdW5jdGlvbiBhcHBseVZpb2xhdGlvbk1lc3NhZ2VUb0ZpZWxkKHBhcmFtZXRlcnMsIGZpZWxkUGF0aCwgbWVzc2FnZSkgewoJCXZhciBvYmplY3QgPSBmaW5kRmllbGQoZmllbGRQYXRoLCBwYXJhbWV0ZXJzLCAiRXJyb3IgYXBwbHlpbmcgdmlvbGF0aW9uIik7CgkJCgkJaWYgKHR5cGVvZiBtZXNzYWdlID09PSAic3RyaW5nIiAmJiAidmFsaWRhdG9yIiBpbiBvYmplY3QpIHsKCQkJb2JqZWN0LnZhbGlkYXRvci5pc1ZhbGlkKGZhbHNlKTsKCQkJb2JqZWN0LnZhbGlkYXRvci5tZXNzYWdlKG1lc3NhZ2UpOwoJCX1lbHNlewoJCQl0aHJvdyBuZXcgRXJyb3IoIkVycm9yIGFwcGx5aW5nIHZpb2xhdGlvblxuIitmaWVsZFBhdGgrIiBpcyBub3QgdmFsaWRhdGFibGVcbml0IHNob3VsZCBiZSBhbiBvYnNlcnZhYmxlIik7CgkJfQoJfTsKCglmdW5jdGlvbiBhcHBseVZpb2xhdGlvbk1lc3NhZ2VUb1ZhbGlkYXRhYmxlKHZhbGlkYXRhYmxlLCBtZXNzYWdlKSB7CgkJdmFsaWRhdGFibGUudmFsaWRhdG9yLmlzVmFsaWQoZmFsc2UpOwoJCXZhciBvbGRNZXNzYWdlID0gdmFsaWRhdGFibGUudmFsaWRhdG9yLm1lc3NhZ2UoKTsKCQl2YXIgbmV3TWVzc2FnZSA9IG9sZE1lc3NhZ2UubGVuZ3RoID09IDAgPyBtZXNzYWdlIDogb2xkTWVzc2FnZSArICIsICIgKyBtZXNzYWdlOwoJCXZhbGlkYXRhYmxlLnZhbGlkYXRvci5tZXNzYWdlKG5ld01lc3NhZ2UpOwoJfTsKCgoKCWZ1bmN0aW9uIFZhbGlkYXRhYmxlKG5hbWUsIHBhcmFtZXRlcnMsIGNvbnN0cmFpbnRSZXNvbHZlcil7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCQoJCXRoaXMudmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcigpOwoJCXRoaXMudmFsaWRhdGFibGVGaWVsZHMgPSBbXTsKCQl0aGlzLnZhbGlkYXRhYmxlUGFyYW1ldGVycyA9IHBhcmFtZXRlcnM7CgkJCgkJCgkJaW5pdDogewoJCQlyZWN1cnNpdmx5RXh0ZW5kUGFyYW1ldGVycyhzZWxmLnZhbGlkYXRhYmxlUGFyYW1ldGVycywgc2VsZi52YWxpZGF0YWJsZUZpZWxkcywgW10pOwoJCQlpZihjb25zdHJhaW50UmVzb2x2ZXIpCgkJCQljb25zdHJhaW50UmVzb2x2ZXIuYXBwbHlWYWxpZGF0aW9uQ29uc3RyYWludHMobmFtZSwgc2VsZik7CgkJfQoJfQoJCglWYWxpZGF0YWJsZS5wcm90b3R5cGUuaXNWYWxpZCA9IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy52YWxpZGF0YWJsZUZpZWxkcy5ldmVyeShmdW5jdGlvbihjb25zdHJhaW50KXsKCQkJcmV0dXJuIGNvbnN0cmFpbnQudmFsaWRhdG9yICYmIGNvbnN0cmFpbnQudmFsaWRhdG9yLmlzVmFsaWQoKTsKCQl9KSAmJiB0aGlzLnZhbGlkYXRvci5pc1ZhbGlkKCk7Cgl9OwoJCQoJVmFsaWRhdGFibGUucHJvdG90eXBlLmFwcGx5VmlvbGF0aW9ucyA9IGZ1bmN0aW9uKHZpb2xhdGlvbnMpewoJCXZpb2xhdGlvbnMuZm9yRWFjaChmdW5jdGlvbih2aW9sYXRpb24pewoJCQl2YXIgbWVzc2FnZSA9IHZpb2xhdGlvbi5tZXNzYWdlOwoJCQl2YXIgZmllbGROYW1lID0gdmlvbGF0aW9uLmZpZWxkTmFtZTsKCQkJaWYgKGZpZWxkTmFtZS5sZW5ndGggPiAwKSB7CgkJCQkvL29uZSBvZiB0aGUgZmllbGRzIHZpb2xhdGVzIGEgY29uc3RyYWludAoJCQkJYXBwbHlWaW9sYXRpb25NZXNzYWdlVG9GaWVsZCh0aGlzLnZhbGlkYXRhYmxlUGFyYW1ldGVycywgZmllbGROYW1lLCBtZXNzYWdlKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhlIHZhbGlkYXRhYmxlIHZpb2xhdGVzIGEgY29uc3RyYWludAoJCQkJYXBwbHlWaW9sYXRpb25NZXNzYWdlVG9WYWxpZGF0YWJsZSh0aGlzLCBtZXNzYWdlKTsKCQkJfQoJCX0uYmluZCh0aGlzKSk7Cgl9OwoJCglWYWxpZGF0YWJsZS5wcm90b3R5cGUuYXBwbHlDb25zdHJhaW50cyA9IGZ1bmN0aW9uKGZpZWxkcyl7CgkJdmFyIHBhcmFtZXRlcnMgPSB0aGlzLnZhbGlkYXRhYmxlUGFyYW1ldGVyczsKCQkKCQlmaWVsZHMuZm9yRWFjaChmdW5jdGlvbihmaWVsZCl7CgkJCXZhciBmaWVsZE5hbWUgPSBmaWVsZC5uYW1lOwoJCQl2YXIgY29uc3RyYWludHMgPSBmaWVsZC5jb25zdHJhaW50czsKCgkJCWlmKGNvbnN0cmFpbnRzID09IG51bGwgfHwgY29uc3RyYWludHMubGVuZ3RoID09IDApCgkJCQlyZXR1cm47CgkJCQoJCQl2YXIgb2JqZWN0ID0gZmluZEZpZWxkKGZpZWxkTmFtZSwgcGFyYW1ldGVycywgIkVycm9yIGFwcGx5aW5nIGNvbnN0cmFpbnRzIHRvIGZpZWxkIik7CgkJCQoJCQlpZiAoa28uaXNPYnNlcnZhYmxlKG9iamVjdCkgJiYgInZhbGlkYXRvciIgaW4gb2JqZWN0KSB7CgkJCQlvYmplY3QudmFsaWRhdG9yLnNldENvbnN0cmFpbnRzKGNvbnN0cmFpbnRzKTsKCQkJfSBlbHNlIHsKCQkJCXRocm93IG5ldyBFcnJvcigiRXJyb3IgYXBwbHlpbmcgY29uc3RyYWludHMgdG8gZmllbGQ6ICIgKyBmaWVsZE5hbWUgKyAiXG4iICsKCQkJCQkiSXQgaXMgbm90IGFuIG9ic2VydmFibGUgb3IgaXMgbm90IGV4dGVuZGVkIHdpdGggYSB2YWxpZGF0b3IuIFxuIiArCgkJCQkJZmllbGROYW1lICsgIj1gIiArIGtvLnRvSlNPTihvYmplY3QpICsgImAiKTsKCQkJfQoJCX0pOwoJfTsKCQoJVmFsaWRhdGFibGUucHJvdG90eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24oKXsKCQl0aGlzLnZhbGlkYXRvci52YWxpZGF0ZSh0cnVlKTsKCQlpZiAodGhpcy52YWxpZGF0b3IuaXNWYWxpZCgpKSB7CgkJCXRoaXMudmFsaWRhdGFibGVGaWVsZHMuZm9yRWFjaChmdW5jdGlvbihjb25zdHJhaW50KXsKCQkJCXZhciB2YWxpZGF0b3IgPSBjb25zdHJhaW50LnZhbGlkYXRvcjsKCQkJCWlmICh2YWxpZGF0b3IpIHsKCQkJCQl2YWxpZGF0b3IudmFsaWRhdGUoY29uc3RyYWludCgpKTsKCQkJCX0KCQkJfSk7CgkJfQoJfTsKCQoJVmFsaWRhdGFibGUucHJvdG90eXBlLmNsZWFyVmFsaWRhdGlvbk1lc3NhZ2VzID0gZnVuY3Rpb24gKCkgewoJCXRoaXMudmFsaWRhdG9yLnJlc2V0KCk7CgkJdGhpcy52YWxpZGF0YWJsZUZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uKGNvbnN0cmFpbnQpewoJCQl2YXIgdmFsaWRhdG9yID0gY29uc3RyYWludC52YWxpZGF0b3I7CgkJCWlmICh2YWxpZGF0b3IpIHsKCQkJCXZhbGlkYXRvci5yZXNldCgpOwoJCQl9CgkJfSk7Cgl9OwoJCgkKCQoJcmV0dXJuIFZhbGlkYXRhYmxlOwp9KTsKZGVmaW5lKCdvcmRudW5nL3F2Yy9FeGVjdXRhYmxlJyxbIm9yZG51bmcvcXZjL0V4ZWN1dGFibGVSZXN1bHQiLCAib3JkbnVuZy9xdmMvVmFsaWRhdGFibGUiLCAib3JkbnVuZy91dGlscyIsICJrbm9ja291dCJdLCBmdW5jdGlvbihFeGVjdXRhYmxlUmVzdWx0LCBWYWxpZGF0YWJsZSwgdXRpbHMsIGtvKXsKCglmdW5jdGlvbiBFeGVjdXRhYmxlKG5hbWUsIHR5cGUsIHBhcmFtZXRlcnMsIGNhbGxiYWNrcywgcXZjKXsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJdGhpcy5uYW1lOwoJCXRoaXMudHlwZTsKCQl0aGlzLmlzQnVzeSA9IGtvLm9ic2VydmFibGUoZmFsc2UpOwoJCXRoaXMuaGFzRXJyb3IgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTsKCQl0aGlzLnJlc3VsdCA9IG5ldyBFeGVjdXRhYmxlUmVzdWx0KCk7CgkJCgkJdGhpcy5wYXJhbWV0ZXJzID0ge307CgkJdGhpcy5jYWxsYmFja3MgPSB7CgkJCWJlZm9yZUV4ZWN1dGU6IGZ1bmN0aW9uICgpIHt9LAoJCQljYW5FeGVjdXRlOiBmdW5jdGlvbigpe3JldHVybiB0cnVlO30sCgkJCWVycm9yOiBmdW5jdGlvbiAoKSB7fSwKCQkJc3VjY2VzczogZnVuY3Rpb24gKCkge30sCgkJCXJlc3VsdDogZnVuY3Rpb24oKXt9LAoJCQljb21wbGV0ZTogZnVuY3Rpb24gKCkge30KCQl9OwoJCQoJCQoJCXRoaXMuZXhlY3V0ZSA9IGZ1bmN0aW9uICgpIHsKCQkJaWYgKHNlbGYub25CZWZvcmVFeGVjdXRlKCkgPT09IGZhbHNlKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJcXZjLmV4ZWN1dGUoc2VsZik7CgkJfTsKCgkJdGhpcy5vbkJlZm9yZUV4ZWN1dGUgPSBmdW5jdGlvbiAoKSB7CgkJCQoJCQlpZiAoc2VsZi5pc0J1c3koKSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCQoJCQlzZWxmLmhhc0Vycm9yKGZhbHNlKTsKCQkJCgkJCXNlbGYuY2FsbGJhY2tzLmJlZm9yZUV4ZWN1dGUoKTsKCQkJCgkJCXNlbGYudmFsaWRhdGUoKTsKCQkJaWYgKCFzZWxmLmlzVmFsaWQoKSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCQoJCQlpZiAoc2VsZi5jYWxsYmFja3MuY2FuRXhlY3V0ZSgpID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCXNlbGYuaXNCdXN5KHRydWUpOwoJCQkKCQkJcmV0dXJuIHRydWU7CgkJfTsKCQkKCQkKCQl0aGlzLm9uRXJyb3IgPSBmdW5jdGlvbiAoKSB7CgkJCXNlbGYuaGFzRXJyb3IodHJ1ZSk7CgkJCWlmKCJ2aW9sYXRpb25zIiBpbiBzZWxmLnJlc3VsdCAmJiBzZWxmLnJlc3VsdC52aW9sYXRpb25zICE9IG51bGwpCgkJCQlzZWxmLmFwcGx5VmlvbGF0aW9ucyhzZWxmLnJlc3VsdC52aW9sYXRpb25zKTsKCQkJc2VsZi5jYWxsYmFja3MuZXJyb3Ioc2VsZi5yZXN1bHQpOwoJCX07CgoJCXRoaXMub25TdWNjZXNzID0gZnVuY3Rpb24gKCkgewoJCQlzZWxmLmhhc0Vycm9yKGZhbHNlKTsKCQkJc2VsZi5jbGVhclZhbGlkYXRpb25NZXNzYWdlcygpOwoJCQlzZWxmLmNhbGxiYWNrcy5zdWNjZXNzKHNlbGYucmVzdWx0KTsKCQkJc2VsZi5jYWxsYmFja3MucmVzdWx0KHNlbGYucmVzdWx0LnJlc3VsdCk7CgkJfTsKCgkJdGhpcy5vbkNvbXBsZXRlID0gZnVuY3Rpb24gKCkgewoJCQlpZiAoIXNlbGYuaGFzRXJyb3IoKSkgewoJCQkJc2VsZi5jYWxsYmFja3MuY29tcGxldGUoc2VsZi5yZXN1bHQpOwoJCQkJc2VsZi5jbGVhclZhbGlkYXRpb25NZXNzYWdlcygpOwoJCQl9CgkJCXNlbGYuaXNCdXN5KGZhbHNlKTsKCQl9OwoJCQoJCQoJCWluaXQ6IHsKCQkJc2VsZi5uYW1lID0gbmFtZTsKCQkJc2VsZi50eXBlID0gdHlwZTsKCQkJdXRpbHMuZXh0ZW5kKHNlbGYucGFyYW1ldGVycywgcGFyYW1ldGVycyk7CgkJCXV0aWxzLmV4dGVuZChzZWxmLmNhbGxiYWNrcywgY2FsbGJhY2tzKTsKCQkJdXRpbHMuZXh0ZW5kKHNlbGYsIG5ldyBWYWxpZGF0YWJsZShzZWxmLm5hbWUsIHNlbGYucGFyYW1ldGVycywgcXZjLmNvbnN0cmFpbnRSZXNvbHZlcikpOwoJCX0KCX0KCQoJRXhlY3V0YWJsZS5Db21tYW5kID0gImNvbW1hbmQiOwoJRXhlY3V0YWJsZS5RdWVyeSA9ICJxdWVyeSI7CgkKCXJldHVybiBFeGVjdXRhYmxlOwp9KTsKZGVmaW5lKCdvcmRudW5nL2FqYXgnLFtdLCBmdW5jdGlvbigpewoJZnVuY3Rpb24gZGF0YVRvUGFyYW1zKGRhdGEpewoJCXZhciBwYXJhbXMgPSBbXQoJCWZvcih2YXIga2V5IGluIGRhdGEpewoJCQl2YXIgdmFsdWUgPSBkYXRhW2tleV07CgkJCXBhcmFtcy5wdXNoKGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKSk7CgkJfQoJCXJldHVybiBwYXJhbXMuam9pbigiJiIpOwoJfQoKCWZ1bmN0aW9uIGFkZFBhcmFtVG9VcmwodXJsLCBuYW1lLCB2YWx1ZSl7CgkJcmV0dXJuIHVybCArICh1cmwubWF0Y2goL1w/LykgPyAodXJsLm1hdGNoKC8mJC8pID8gIiIgOiAiJiIpIDogIj8iKSArIGVuY29kZVVSSUNvbXBvbmVudChuYW1lKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7Cgl9CgoJZnVuY3Rpb24gYWRkUGFyYW1zVG9VcmwodXJsLCBkYXRhKXsKCQl2YXIgcGFyYW1zID0gZGF0YVRvUGFyYW1zKGRhdGEpOwoJCXJldHVybiB1cmwgKyAodXJsLm1hdGNoKC9cPy8pID8gKHVybC5tYXRjaCgvJiQvKSA/ICIiIDogKHBhcmFtcy5sZW5ndGggPiAwID8gIiYiIDogIiIpKSA6ICI/IikgKyBwYXJhbXM7Cgl9CgoJZnVuY3Rpb24gYWRkVG9QYXRoKHVybCwgc2VnbWVudCl7CgkJcmV0dXJuIHVybCArICh1cmwubWF0Y2goL1wvJC8pID8gIiIgOiAiLyIpICsgc2VnbWVudDsKCX0KCglmdW5jdGlvbiBjYWNoZUJ1c3QodXJsKXsKCQlyZXR1cm4gYWRkUGFyYW1Ub1VybCh1cmwsICJjYWNoZUtleSIsIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSpNYXRoLnBvdygyLDUzKSkpOwoJfQoKCWZ1bmN0aW9uIGFqYXgodXJsLCBvYmplY3QsIG1ldGhvZCwgY2FsbGJhY2spewoJCXZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCQkKCQl2YXIgaXNQb3N0ID0gKG1ldGhvZCA9PT0gIlBPU1QiKTsKCQl2YXIgZGF0YSA9IG51bGw7CgkJCgkJaWYob2JqZWN0KXsKCgkJCWlmKGlzUG9zdCl7CgkJCQlkYXRhID0gZGF0YVRvUGFyYW1zKG9iamVjdCk7CgkJCX0gZWxzZSB7CgkJCQl1cmwgPSBhZGRQYXJhbXNUb1VybCh1cmwsIG9iamVjdCk7CgkJCX0KCQl9CgkJCgkJaWYoaXNQb3N0KXsKCQkJdXJsID0gY2FjaGVCdXN0KHVybCk7CgkJfQoKCQl4aHIub3BlbihtZXRob2QsIHVybCwgdHJ1ZSk7CgkJCgkJaWYoaXNQb3N0ICYmIGRhdGEpewoJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcigiQ29udGVudC10eXBlIiwgImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpOwoJCX0KCQkKCQl4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1SZXF1ZXN0ZWQtV2l0aCcsICdYTUxIdHRwUmVxdWVzdCcpOwoJCQoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpewoJCQlpZih4aHIucmVhZHlTdGF0ZSA9PSA0KXsKCQkJCWNhbGxiYWNrKHhocik7CgkJCX0KCQl9CgkJCgkJeGhyLnNlbmQoZGF0YSk7CgkJcmV0dXJuIHhocjsKCX0KCglhamF4LmFkZFBhcmFtVG9VcmwgPSBhZGRQYXJhbVRvVXJsOwoJYWpheC5hZGRQYXJhbXNUb1VybCA9IGFkZFBhcmFtc1RvVXJsOwoJYWpheC5hZGRUb1BhdGggPSBhZGRUb1BhdGg7CglhamF4LmNhY2hlQnVzdCA9IGNhY2hlQnVzdDsKCgoJcmV0dXJuIGFqYXg7Cn0pOwpkZWZpbmUoJ29yZG51bmcvcXZjL0NvbnN0cmFpbnRSZXNvbHZlcicsW10sIGZ1bmN0aW9uKCl7CgoKCWZ1bmN0aW9uIGZpbmRDb25zdHJhaW50KG5hbWUsIGNvbnN0cmFpbnRzKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb25zdHJhaW50cy5sZW5ndGg7IGkrKykgewoJCQlpZiAoY29uc3RyYWludHNbaV0ubmFtZSA9PSBuYW1lKSB7CgkJCQlyZXR1cm4gY29uc3RyYWludHNbaV07CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWZ1bmN0aW9uIGNvbnN0cmFpbnRzTG9hZGVkKG5hbWUsIGZpZWxkcyl7CgkJdmFyIGNvbnN0cmFpbnQgPSBmaW5kQ29uc3RyYWludChuYW1lLCB0aGlzLmNvbnN0cmFpbnRzKTsKCQlpZihjb25zdHJhaW50KXsKCQkJY29uc3RyYWludC52YWxpZGF0YWJsZXMuZm9yRWFjaChmdW5jdGlvbih2YWxpZGF0YWJsZSl7CgkJCQl2YWxpZGF0YWJsZS5hcHBseUNvbnN0cmFpbnRzKGZpZWxkcyk7CgkJCX0pOwoJCQljb25zdHJhaW50LmZpZWxkcyA9IGZpZWxkczsKCQkJY29uc3RyYWludC5zdGF0ZSA9ICJsb2FkZWQiOwoJCX0KCX0KCgoJZnVuY3Rpb24gQ29uc3RyYWludFJlc29sdmVyKHF2Yyl7CgkJdGhpcy5xdmMgPSBxdmM7CgkJdGhpcy5jb25zdHJhaW50cyA9IFtdOwoJfQoJCglDb25zdHJhaW50UmVzb2x2ZXIucHJvdG90eXBlLmFwcGx5VmFsaWRhdGlvbkNvbnN0cmFpbnRzID0gZnVuY3Rpb24obmFtZSwgdmFsaWRhdGFibGUpewoJCXZhciBjb25zdHJhaW50ID0gZmluZENvbnN0cmFpbnQobmFtZSwgdGhpcy5jb25zdHJhaW50cyk7CgkJaWYoY29uc3RyYWludCA9PSBmYWxzZSl7CgkJCXRoaXMuY29uc3RyYWludHMucHVzaCh7CgkJCQluYW1lOiBuYW1lLAoJCQkJc3RhdGU6ICJsb2FkaW5nIiwKCQkJCXZhbGlkYXRhYmxlczogW3ZhbGlkYXRhYmxlXQoJCQl9KTsKCQkJdGhpcy5xdmMubG9hZENvbnN0cmFpbnRzKG5hbWUsIGNvbnN0cmFpbnRzTG9hZGVkLmJpbmQodGhpcykpOwoJCX1lbHNlewoJCQlpZihjb25zdHJhaW50LnN0YXRlID09PSAibG9hZGluZyIpewoJCQkJY29uc3RyYWludC52YWxpZGF0YWJsZXMucHVzaCh2YWxpZGF0YWJsZSk7CgkJCX1lbHNlewoJCQkJdmFsaWRhdGFibGUuYXBwbHlDb25zdHJhaW50cyhjb25zdHJhaW50LmZpZWxkcyk7CgkJCX0KCQl9Cgl9OwoJCglyZXR1cm4gQ29uc3RyYWludFJlc29sdmVyOwp9KTsKZGVmaW5lKCdvcmRudW5nL2Vycm9ySGFuZGxlcicsW10sIGZ1bmN0aW9uKCl7CglyZXR1cm4gewoJCW9uRXJyb3I6IGZ1bmN0aW9uKGVycm9yKXsKCQkJc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJdGhyb3cgZXJyb3I7CgkJCX0sMSk7CgkJfQoJfTsKfSk7CmRlZmluZSgnb3JkbnVuZy9xdmMnLFsKCSJvcmRudW5nL3F2Yy9FeGVjdXRhYmxlIiwgCgkib3JkbnVuZy9xdmMvRXhlY3V0YWJsZVJlc3VsdCIsIAoJIm9yZG51bmcvdXRpbHMiLCAKCSJvcmRudW5nL2FqYXgiLAoJIm9yZG51bmcvcXZjL0NvbnN0cmFpbnRSZXNvbHZlciIsCgkib3JkbnVuZy9lcnJvckhhbmRsZXIiLAoJImtub2Nrb3V0IiwgCgkib3JkbnVuZy9xdmMva29FeHRlbnNpb25zIl0sIAoJZnVuY3Rpb24oCgkJRXhlY3V0YWJsZSwKCQlFeGVjdXRhYmxlUmVzdWx0LAoJCXV0aWxzLAoJCWFqYXgsCgkJQ29uc3RyYWludFJlc29sdmVyLAoJCWVycm9ySGFuZGxlciwKCQlrbyl7CgkKCWZ1bmN0aW9uIFFWQygpewoKCQl2YXIgcXZjID0gdGhpczsKCgkJdGhpcy5jb25zdHJhaW50UmVzb2x2ZXIgPSBuZXcgQ29uc3RyYWludFJlc29sdmVyKHF2Yyk7CgoJCXRoaXMuZXhlY3V0ZSA9IGZ1bmN0aW9uKGV4ZWN1dGFibGUpewoJCQl2YXIgcGFyYW1ldGVycyA9IGtvLnRvSlMoZXhlY3V0YWJsZS5wYXJhbWV0ZXJzKTsKCQkJdmFyIGRhdGEgPSB7CgkJCQlwYXJhbWV0ZXJzOiBKU09OLnN0cmluZ2lmeShwYXJhbWV0ZXJzKSwKCQkJCWNzcmZUb2tlbjogcXZjLmNvbmZpZy5jc3JmCgkJCX07CgkJCXZhciB1cmwgPSBhamF4LmFkZFRvUGF0aChxdmMuY29uZmlnLmJhc2VVcmwsIGV4ZWN1dGFibGUudHlwZSArICIvIiArIGV4ZWN1dGFibGUubmFtZSk7CgkJCWFqYXgodXJsLCBkYXRhLCAiUE9TVCIsIGZ1bmN0aW9uICh4aHIpIHsKCQkJCWlmICh4aHIuc3RhdHVzID09PSAyMDApIHsKCQkJCQlleGVjdXRhYmxlLnJlc3VsdCA9IG5ldyBFeGVjdXRhYmxlUmVzdWx0KEpTT04ucGFyc2UoeGhyLnJlc3BvbnNlVGV4dCB8fCAie30iKSk7CgkJCQkJaWYgKGV4ZWN1dGFibGUucmVzdWx0LnN1Y2Nlc3MgPT09IHRydWUpIHsKCQkJCQkJZXhlY3V0YWJsZS5vblN1Y2Nlc3MoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlpZihleGVjdXRhYmxlLnJlc3VsdC5leGNlcHRpb24gJiYgZXhlY3V0YWJsZS5yZXN1bHQuZXhjZXB0aW9uLm1lc3NhZ2UpewoJCQkJCQkJZXJyb3JIYW5kbGVyLm9uRXJyb3IoZXhlY3V0YWJsZS5yZXN1bHQuZXhjZXB0aW9uLm1lc3NhZ2UpOwoJCQkJCQl9CgkJCQkJCWV4ZWN1dGFibGUub25FcnJvcigpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZXhlY3V0YWJsZS5yZXN1bHQgPSBuZXcgRXhlY3V0YWJsZVJlc3VsdCh7ZXhjZXB0aW9uOiB7bWVzc2FnZTogeGhyLnJlc3BvbnNlVGV4dCwgY2F1c2U6IHhocn19KTsKCQkJCQllcnJvckhhbmRsZXIub25FcnJvcihleGVjdXRhYmxlLnJlc3VsdC5leGNlcHRpb24ubWVzc2FnZSk7CgkJCQkJZXhlY3V0YWJsZS5vbkVycm9yKCk7CgkJCQl9CgkJCQlleGVjdXRhYmxlLm9uQ29tcGxldGUoKTsKCQkJfSk7CgkJCgkJfTsKCQkKCQl0aGlzLmxvYWRDb25zdHJhaW50cyA9IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrKXsKCQkJdmFyIHVybCA9IGFqYXguYWRkVG9QYXRoKHF2Yy5jb25maWcuYmFzZVVybCwgImNvbnN0cmFpbnRzLyIgKyBuYW1lKTsKCQkJYWpheCh1cmwsIG51bGwsICJHRVQiLCBmdW5jdGlvbih4aHIpewoJCQkJaWYgKHhoci5zdGF0dXMgPT09IDIwMCkgewoJCQkJCXRyeXsKCQkJCQkJdmFyIHJlc3BvbnNlID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0IHx8ICJ7XCJwYXJhbWV0ZXJzXCI6W119Iik7CgkJCQkJCWlmKCJwYXJhbWV0ZXJzIiBpbiByZXNwb25zZSA9PSBmYWxzZSl7CgkJCQkJCQlyZXNwb25zZS5wYXJhbWV0ZXJzID0gW107CgkJCQkJCX0KCQkJCQkJaWYocmVzcG9uc2UuZXhjZXB0aW9uICYmIHJlc3BvbnNlLmV4Y2VwdGlvbi5tZXNzYWdlKXsKCQkJCQkJCWVycm9ySGFuZGxlci5vbkVycm9yKHJlc3BvbnNlLmV4Y2VwdGlvbi5tZXNzYWdlKTsKCQkJCQkJfQoJCQkJCX1jYXRjaChlKXsKCQkJCQkJdmFyIHJlc3BvbnNlID0ge3BhcmFtZXRlcnM6IFtdfTsKCQkJCQl9CgkJCQkJY2FsbGJhY2sobmFtZSwgcmVzcG9uc2UucGFyYW1ldGVycyk7CgkJCQl9ZWxzZXsKCQkJCQllcnJvckhhbmRsZXIub25FcnJvcih4aHIucmVzcG9uc2VUZXh0KTsKCQkJCX0KCQkJfSk7CgkJfTsKCgkJCgkJdGhpcy5jb25maWcgPSB7CgkJCWJhc2VVcmw6ICIvIiwKCQkJY3NyZjogIiIKCQl9Cgl9OwoKCXZhciBxdmMgPSBuZXcgUVZDKCk7CgkKCWZ1bmN0aW9uIGNyZWF0ZUV4ZWN1dGFibGUobmFtZSwgdHlwZSwgcGFyYW1ldGVycywgY2FsbGJhY2tzKXsKCQlpZihuYW1lID09IG51bGwgfHwgbmFtZS5sZW5ndGggPT0gMCkKCQkJdGhyb3cgbmV3IEVycm9yKHR5cGUgKyAiIGlzIG1pc3NpbmcgbmFtZVxuQSAiICsgdHlwZSArICIgbXVzdCBoYXZlIGEgbmFtZSFcbnVzYWdlOiBjcmVhdGVDb21tYW5kKCduYW1lJywgW3BhcmFtZXRlcnMsIGNhbGxiYWNrc10pIik7CgkKCQl2YXIgZXhlY3V0YWJsZSA9IG5ldyBFeGVjdXRhYmxlKG5hbWUsIHR5cGUsIHBhcmFtZXRlcnMgfHwge30sIGNhbGxiYWNrcyB8fCB7fSwgcXZjKTsKCQl2YXIgZXhlY3V0ZSA9IGV4ZWN1dGFibGUuZXhlY3V0ZS5iaW5kKGV4ZWN1dGFibGUpOwoJCWV4ZWN1dGUuaXNWYWxpZCA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCl7cmV0dXJuIGV4ZWN1dGFibGUuaXNWYWxpZCgpOyB9KTsKCQlleGVjdXRlLmlzQnVzeSA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCl7cmV0dXJuIGV4ZWN1dGFibGUuaXNCdXN5KCk7fSk7CgkJZXhlY3V0ZS5oYXNFcnJvciA9IGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCl7cmV0dXJuIGV4ZWN1dGFibGUuaGFzRXJyb3IoKTt9KTsKCQlleGVjdXRlLnN1Y2Nlc3MgPSBmdW5jdGlvbihjYWxsYmFjayl7CgkJCWV4ZWN1dGFibGUuY2FsbGJhY2tzLnN1Y2Nlc3MgPSBjYWxsYmFjazsKCQkJcmV0dXJuIGV4ZWN1dGU7CgkJfTsKCQlleGVjdXRlLmVycm9yID0gZnVuY3Rpb24oY2FsbGJhY2spewoJCQlleGVjdXRhYmxlLmNhbGxiYWNrcy5lcnJvciA9IGNhbGxiYWNrOwoJCQlyZXR1cm4gZXhlY3V0ZTsKCQl9OwoJCWV4ZWN1dGUuYmVmb3JlRXhlY3V0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKCQkJZXhlY3V0YWJsZS5jYWxsYmFja3MuYmVmb3JlRXhlY3V0ZSA9IGNhbGxiYWNrOwoJCQlyZXR1cm4gZXhlY3V0ZTsKCQl9OwoJCWV4ZWN1dGUuY2FuRXhlY3V0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKCQkJZXhlY3V0YWJsZS5jYWxsYmFja3MuY2FuRXhlY3V0ZSA9IGNhbGxiYWNrOwoJCQlyZXR1cm4gZXhlY3V0ZTsKCQl9OwoJCWV4ZWN1dGUucmVzdWx0ID0gZnVuY3Rpb24oKXsKCQkJaWYoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQkJCWV4ZWN1dGFibGUuY2FsbGJhY2tzLnJlc3VsdCA9IGFyZ3VtZW50c1swXTsKCQkJCXJldHVybiBleGVjdXRlOwoJCQl9CgkJCXJldHVybiBleGVjdXRhYmxlLnJlc3VsdC5yZXN1bHQ7CgkJfTsKCQlleGVjdXRlLmNvbXBsZXRlID0gZnVuY3Rpb24oY2FsbGJhY2spewoJCQlleGVjdXRhYmxlLmNhbGxiYWNrcy5jb21wbGV0ZSA9IGNhbGxiYWNrOwoJCQlyZXR1cm4gZXhlY3V0ZTsKCQl9OwoJCWV4ZWN1dGUuY2xlYXJWYWxpZGF0aW9uTWVzc2FnZXMgPSBleGVjdXRhYmxlLmNsZWFyVmFsaWRhdGlvbk1lc3NhZ2VzLmJpbmQoZXhlY3V0YWJsZSk7CgkJZXhlY3V0ZS52YWxpZGF0b3IgPSBleGVjdXRhYmxlLnZhbGlkYXRvcjsKCQkKCQlyZXR1cm4gZXhlY3V0ZTsKCX0KCQoJcmV0dXJuIHsKCQljcmVhdGVDb21tYW5kOiBmdW5jdGlvbihuYW1lLCBwYXJhbWV0ZXJzLCBjYWxsYmFja3MpewoJCQlyZXR1cm4gY3JlYXRlRXhlY3V0YWJsZShuYW1lLCBFeGVjdXRhYmxlLkNvbW1hbmQsIHBhcmFtZXRlcnMsIGNhbGxiYWNrcyk7CgkJfSwKCQljcmVhdGVRdWVyeTogZnVuY3Rpb24obmFtZSwgcGFyYW1ldGVycywgY2FsbGJhY2tzKXsKCQkJcmV0dXJuIGNyZWF0ZUV4ZWN1dGFibGUobmFtZSwgRXhlY3V0YWJsZS5RdWVyeSwgcGFyYW1ldGVycywgY2FsbGJhY2tzKTsKCQl9LAoJCWNvbmZpZzogZnVuY3Rpb24oY29uZmlnKXsKCQkJdXRpbHMuZXh0ZW5kKHF2Yy5jb25maWcsIGNvbmZpZyk7CgkJfQoJfQp9KTsKZGVmaW5lKCdvcmRudW5nL3NwYS9PdXRsZXQnLFsKCSJrbm9ja291dCIKXSwgZnVuY3Rpb24oCglrbwopewoKCWZ1bmN0aW9uIE91dGxldChlbGVtZW50LCBkb2N1bWVudCl7CgkJdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKCQl0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQgfHwgd2luZG93LmRvY3VtZW50OwoJfQoKCU91dGxldC5wcm90b3R5cGUub3V0bGV0RXhpc3RzID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5lbGVtZW50ICE9IG51bGw7Cgl9OwoKCU91dGxldC5wcm90b3R5cGUudW5sb2FkQ3VycmVudFBhZ2UgPSBmdW5jdGlvbigpewoJCWtvLmNsZWFuTm9kZSh0aGlzLmVsZW1lbnQpOwoJCXRoaXMuZWxlbWVudC5pbm5lckhUTUwgPSAiIjsKCX07CgoJT3V0bGV0LnByb3RvdHlwZS5zZXRQYWdlQ29udGVudCA9IGZ1bmN0aW9uKGNvbnRlbnQpewoJCXRoaXMuZWxlbWVudC5pbm5lckhUTUwgPSBjb250ZW50OwoJfTsKCglPdXRsZXQucHJvdG90eXBlLmdldFBhZ2VUaXRsZSA9IGZ1bmN0aW9uKCl7CgkJdmFyIHRpdGxlTWV0YVRhZyA9IHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yKCJtZXRhW25hbWU9dGl0bGVdIik7CgkJcmV0dXJuICh0aXRsZU1ldGFUYWcgJiYgdGl0bGVNZXRhVGFnLmdldEF0dHJpYnV0ZSgiY29udGVudCIpKTsKCX07CgoJT3V0bGV0LnByb3RvdHlwZS5zZXREb2N1bWVudFRpdGxlID0gZnVuY3Rpb24odGl0bGUpewoJCXRoaXMuZG9jdW1lbnQudGl0bGUgPSB0aXRsZTsKCX07CgoJT3V0bGV0LnByb3RvdHlwZS5leHRyYWN0QW5kUnVuUGFnZUphdmFTY3JpcHQgPSBmdW5jdGlvbigpewoJCXZhciBzY3JpcHRzID0gdGhpcy5lbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoInNjcmlwdFt0eXBlPSd0ZXh0L2phdmFzY3JpcHQnXSIpOwoJCWZvcih2YXIgaT0wOyBpPHNjcmlwdHMubGVuZ3RoOyBpKyspewoJCQlzY3JpcHRzW2ldLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0c1tpXSk7CgkJCWlmKHNjcmlwdHNbaV0uaWQgPT09ICcnKSB0aHJvdyBuZXcgRXJyb3IoIlRoZSBzY3JpcHQgbXVzdCBoYXZlIGFuIGlkIik7CgkJCWlmKHRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc2NyaXB0c1tpXS5pZCkgPT0gbnVsbCl7CgkJCQl2YXIgc2NyaXB0ID0gdGhpcy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCQkJCXNjcmlwdC5pZCA9IHNjcmlwdHNbaV0uaWQ7CgkJCQlzY3JpcHQudGV4dCA9IHNjcmlwdHNbaV0udGV4dENvbnRlbnQ7CgkJCQlzY3JpcHQuc2V0QXR0cmlidXRlKCd0eXBlJywgc2NyaXB0c1tpXS5nZXRBdHRyaWJ1dGUoJ3R5cGUnKSk7CgkJCQl0aGlzLmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJfQoJCX0KCX07CgoJT3V0bGV0LnByb3RvdHlwZS5pbmRpY2F0ZVBhZ2VJc0xvYWRpbmcgPSBmdW5jdGlvbigpewoJCXRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUoImRhdGEtbG9hZGluZyIsICJ0cnVlIik7Cgl9OwoKCU91dGxldC5wcm90b3R5cGUucGFnZUhhc0xvYWRlZCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgiZGF0YS1sb2FkaW5nIiwgImZhbHNlIik7Cgl9OwoKCXJldHVybiBPdXRsZXQ7Cgp9KTsKZGVmaW5lKCdvcmRudW5nL3NwYS93aGVuQ29udGV4dCcsWwoJCl0sIGZ1bmN0aW9uKAoJCil7CgoJZnVuY3Rpb24gdW5zdWJzY3JpYmUoZXZlbnQsIHJlYWN0aW9uKXsKCQlldmVudC5kb250KHJlYWN0aW9uKTsKCX0KCglmdW5jdGlvbiBzdWJzY3JpYmUoZXZlbnQsIHJlYWN0aW9uKXsKCQlldmVudChyZWFjdGlvbik7CgkJcmV0dXJuIGV2ZW50LmRvbnQuYmluZChudWxsLCByZWFjdGlvbik7Cgl9CgoJZnVuY3Rpb24gd2hlblNvbWV0aGluZygpewoJCWlmKHRoaXMuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgY29udGV4dCBoYXMgYmVlbiBkZXN0cm95ZWQhIik7CgoJCWlmKGFyZ3VtZW50cy5sZW5ndGggPT0gMCl7CgkJCXZhciBjaGlsZENvbnRleHQgPSBjcmVhdGVDb250ZXh0KCk7CgkJCXRoaXMuY2hpbGRDb250ZXh0cy5wdXNoKGNoaWxkQ29udGV4dCk7CgkJCXJldHVybiBjaGlsZENvbnRleHQud2hlbjsKCQl9ZWxzZSBpZihhcmd1bWVudHMubGVuZ3RoID09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gImZ1bmN0aW9uIil7CgkJCXJldHVybiB7CgkJCQlkb250OiB1bnN1YnNjcmliZS5iaW5kKG51bGwsIGFyZ3VtZW50c1swXSkKCQkJfQoJCX1lbHNlIGlmKGFyZ3VtZW50cy5sZW5ndGggPT0gMiAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09PSAiZnVuY3Rpb24iKXsKCQkJdGhpcy5ldmVudFN1YnNjcmliZXJzLnB1c2goc3Vic2NyaWJlKGFyZ3VtZW50c1swXSwgYXJndW1lbnRzWzFdKSk7CgkJfQoJfQoKCWZ1bmN0aW9uIHRoaXNJc0Rlc3Ryb3llZChyZWFjdGlvbil7CgkJdGhpcy5vbkRlc3Ryb3lMaXN0ZW5lcnMucHVzaChyZWFjdGlvbik7Cgl9CgoJZnVuY3Rpb24gZGVzdHJveUNoaWxkQ29udGV4dHMoKXsKCQl2YXIgY29udGV4dDsKCQl3aGlsZShjb250ZXh0ID0gdGhpcy5jaGlsZENvbnRleHRzLnBvcCgpKQoJCQljb250ZXh0LmRlc3Ryb3lDb250ZXh0KCk7Cgl9CgoJZnVuY3Rpb24gZGVzdHJveUNvbnRleHQoKXsKCQl2YXIgc3Vic2NyaWJlciwgbGlzdGVuZXIsIGNvbnRleHQ7CgkJd2hpbGUoc3Vic2NyaWJlciA9IHRoaXMuZXZlbnRTdWJzY3JpYmVycy5wb3AoKSkKCQkJc3Vic2NyaWJlcigpOwoJCXdoaWxlKGxpc3RlbmVyID0gdGhpcy5vbkRlc3Ryb3lMaXN0ZW5lcnMucG9wKCkpCgkJCWxpc3RlbmVyKCk7CgkJd2hpbGUoY29udGV4dCA9IHRoaXMuY2hpbGRDb250ZXh0cy5wb3AoKSkKCQkJY29udGV4dC5kZXN0cm95Q29udGV4dCgpOwoJCXRoaXMuZGVzdHJveWVkID0gdHJ1ZTsKCX0KCglmdW5jdGlvbiBjcmVhdGVDb250ZXh0KCl7CgkJdmFyIGNvbnRleHQgPSB7CgkJCWRlc3Ryb3llZDogZmFsc2UsCgkJCW9uRGVzdHJveUxpc3RlbmVyczogW10sCgkJCWNoaWxkQ29udGV4dHM6IFtdLAoJCQlldmVudFN1YnNjcmliZXJzOiBbXQoJCX07CgoJCXZhciB3aGVuID0gd2hlblNvbWV0aGluZy5iaW5kKGNvbnRleHQpOwoKCQl3aGVuLnRoaXNJc0Rlc3Ryb3llZCA9IHRoaXNJc0Rlc3Ryb3llZC5iaW5kKGNvbnRleHQpOwoKCQl3aGVuLmRlc3Ryb3lDaGlsZENvbnRleHRzID0gZGVzdHJveUNoaWxkQ29udGV4dHMuYmluZChjb250ZXh0KTsKCgkJcmV0dXJuIHsKCQkJd2hlbjogd2hlbiwKCQkJZGVzdHJveUNvbnRleHQ6IGRlc3Ryb3lDb250ZXh0LmJpbmQoY29udGV4dCkKCQl9OwoJfQoKCXJldHVybiBjcmVhdGVDb250ZXh0KCkud2hlbjsKfSk7CmRlZmluZSgnb3JkbnVuZy9zcGEvYXBwbHlWaWV3TW9kZWxzJyxbCgkib3JkbnVuZy91dGlscyIsCgkib3JkbnVuZy9lcnJvckhhbmRsZXIiLAoJImtub2Nrb3V0IiwgCgkid2hlbiIsIAoJIndoZW4vY2FsbGJhY2tzIgpdLCBmdW5jdGlvbiAoCgl1dGlscywgCgllcnJvckhhbmRsZXIsCglrbywgCgl3aGVuLCAKCWNhbGxiYWNrcwopIHsKCgoJZnVuY3Rpb24gZ2V0QXR0cmlidXRlcyh0YXJnZXQpewoKCQl2YXIgdmlld01vZGVsTmFtZSA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoImRhdGEtdmlld21vZGVsIik7CgkJdmFyIG1vZGVsID0gdGFyZ2V0LmdldEF0dHJpYnV0ZSgiZGF0YS1tb2RlbCIpOwoJCWlmIChtb2RlbCAmJiBtb2RlbC5pbmRleE9mKCJ7IikgPT0gMCkgewoJCQltb2RlbCA9IEpTT04ucGFyc2UobW9kZWwpOwoJCX0KCgkJcmV0dXJuIHsKCQkJdGFyZ2V0OiB0YXJnZXQsCgkJCXZpZXdNb2RlbE5hbWU6IHZpZXdNb2RlbE5hbWUsCgkJCW1vZGVsOiBtb2RlbAoJCX07Cgl9CgoKCWZ1bmN0aW9uIGxvYWRWaWV3TW9kZWwoZGF0YSl7CgoJCXJldHVybiBjYWxsYmFja3MuY2FsbChyZXF1aXJlLCBbCgkJCWRhdGEudmlld01vZGVsTmFtZQoJCV0pLnRoZW4oZnVuY3Rpb24oVmlld01vZGVsKXsKCQkJZGF0YS5WaWV3TW9kZWwgPSBWaWV3TW9kZWw7CgkJCXJldHVybiBkYXRhOwoJCX0sIGZ1bmN0aW9uKGVycm9yKXsKCQkJZXJyb3JIYW5kbGVyLm9uRXJyb3IobmV3IEVycm9yKCJDb3VsZCBub3QgbG9hZCB0aGUgZm9sbG93aW5nIG1vZHVsZXM6XG4iK2Vycm9yLnJlcXVpcmVNb2R1bGVzLmpvaW4oIlxuIikpKTsKCQkJcmV0dXJuIG51bGw7CgkJfSk7Cgl9CgoJZnVuY3Rpb24gYXBwbHlWaWV3TW9kZWwoc3Vic2NyaWJlLCBkYXRhKSB7CgkJdHJ5ewoJCQl2YXIgdmlld01vZGVsID0gbmV3IGRhdGEuVmlld01vZGVsKGRhdGEubW9kZWwgfHwge30sIHN1YnNjcmliZSk7CgkJCWtvLmFwcGx5QmluZGluZ3Modmlld01vZGVsLCBkYXRhLnRhcmdldCk7CgkJfWNhdGNoKGUpewoJCQllcnJvckhhbmRsZXIub25FcnJvcihlKTsKCQl9Cgl9CgoJZnVuY3Rpb24gdmlld01vZGVsTG9hZGVkU3VjY2Vzc2Z1bGx5KGRhdGEpewoJCXJldHVybiBkYXRhICE9IG51bGwgJiYgZGF0YS5WaWV3TW9kZWwgIT0gbnVsbDsKCX0KCglyZXR1cm4gZnVuY3Rpb24gKGRvbUVsZW1lbnQsIHN1YnNjcmliZSkgewoKCQlkb21FbGVtZW50ID0gZG9tRWxlbWVudCB8fCBkb2N1bWVudC5ib2R5OwoKCQl2YXIgZWxlbWVudExpc3QgPSB1dGlscy50b0FycmF5KGRvbUVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgiKltkYXRhLXZpZXdtb2RlbF0iKSk7CgoJCXZhciB2aWV3TW9kZWxzTG9hZGVkID0gZWxlbWVudExpc3QubWFwKGdldEF0dHJpYnV0ZXMpLm1hcChsb2FkVmlld01vZGVsKTsKCgkJcmV0dXJuIHdoZW4uYWxsKHZpZXdNb2RlbHNMb2FkZWQpLnRoZW4oZnVuY3Rpb24obGlzdCl7CgkJCWxpc3QuZmlsdGVyKHZpZXdNb2RlbExvYWRlZFN1Y2Nlc3NmdWxseSkuZm9yRWFjaChhcHBseVZpZXdNb2RlbC5iaW5kKG51bGwsIHN1YnNjcmliZSkpCgkJfSk7Cgl9Owp9KTsKZGVmaW5lKCdvcmRudW5nL3NwYS9oYXNoTmF2aWdhdGlvbicsWwoJIm9yZG51bmcvdXRpbHMiCl0sZnVuY3Rpb24oCglfCil7CgoKCQoJZnVuY3Rpb24gbmV3UGF0aChjdXJyZW50UGF0aCwgbGluaywgaW5kZXgpewoJCXZhciBpc1JlbGF0aXZlID0gXy5zdGFydHNXaXRoKGxpbmssICcvJykgPT09IGZhbHNlOwoJCXZhciBpc0ZvbGRlciA9IF8uZW5kc1dpdGgobGluaywgJy8nKTsKCQkKCQlpZihsaW5rID09PSAiLyIpewoJCQl2YXIgcGF0aCA9IFtdOwoJCX1lbHNlIGlmKGxpbmsgPT09ICIiKXsKCQkJdmFyIHBhdGggPSBbaW5kZXhdOwoJCX1lbHNlewoJCQl2YXIgcGF0aCA9IF8udHJpbShsaW5rLCAiLyIpLnNwbGl0KCIvIik7CgkJfQoKCQlpZihpc0ZvbGRlcil7CgkJCXBhdGgucHVzaChpbmRleCk7CgkJfQoJCWlmKGlzUmVsYXRpdmUpewoJCQlwYXRoID0gXy5wb3BUYWlsKGN1cnJlbnRQYXRoKS5jb25jYXQocGF0aCk7CgkJfQoKCQl2YXIgb3V0ID0gW107CgoJCWZvcih2YXIgaSA9IHBhdGgubGVuZ3RoPj4+MDsgaS0tOyl7CgkJCWlmKHBhdGhbaV0gPT09ICIiKXsKCQkJCWNvbnRpbnVlOwoJCQl9ZWxzZSBpZihwYXRoW2ldID09PSAiLiIpewoJCQkJY29udGludWU7CgkJCX1lbHNlIGlmKHBhdGhbaV0gPT09ICIuLiIpIHsKCQkJCWktLTsKCQkJfWVsc2V7CgkJCQlvdXQudW5zaGlmdChwYXRoW2ldKTsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglmdW5jdGlvbiBoYXNoQ2hhbmdlZChjb25maWcsIG9uUGFnZUNoYW5nZWQsIGRvY3VtZW50KXsKCgkJdmFyIHBhdGggPSBfLmFmdGVyKGRvY3VtZW50LmxvY2F0aW9uLmhyZWYsICcjJyk7CgoJCXZhciBpc1JlbGF0aXZlID0gXy5zdGFydHNXaXRoKHBhdGgsICcvJykgPT0gZmFsc2U7CgkJdmFyIGlzRm9sZGVyID0gXy5lbmRzV2l0aChwYXRoLCAnLycpOwoKCQlpZihpc1JlbGF0aXZlIHx8IGlzRm9sZGVyKXsKCQkJdmFyIG5ld0hhc2ggPSBuZXdQYXRoKHRoaXMuY3VycmVudFBhdGgsIHBhdGgsIGNvbmZpZy5pbmRleCkuam9pbignLycpOwoJCQlkb2N1bWVudC5sb2NhdGlvbi5yZXBsYWNlKCIjLyIgKyBuZXdIYXNoKTsKCQl9ZWxzZXsKCQkJdGhpcy5jdXJyZW50UGF0aCA9IG5ld1BhdGgodGhpcy5jdXJyZW50UGF0aCwgcGF0aCwgY29uZmlnLmluZGV4KTsKCQkJb25QYWdlQ2hhbmdlZCh0aGlzLmN1cnJlbnRQYXRoLmpvaW4oJy8nKSwgdGhpcy5jdXJyZW50UGF0aC5tYXAoZnVuY3Rpb24ocCl7cmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChwKTt9KSk7CgkJfQoKCX0KCQoJZnVuY3Rpb24gc3RhcnRIYXNoTmF2aWdhdGlvbihjb25maWcsIG9uUGFnZUNoYW5nZWQsIGRvYywgZ2xvYmFsKXsKCQlkb2MgPSBkb2MgfHwgZG9jdW1lbnQ7CgkJZ2xvYmFsID0gZ2xvYmFsIHx8IHdpbmRvdzsKCgkJdmFyIHN0YXRlID0gewoJCQljdXJyZW50UGF0aDogW10KCQl9OwoJCXZhciBvbkhhc2hDaGFuZ2VkID0gaGFzaENoYW5nZWQuYmluZChzdGF0ZSwgY29uZmlnLCBvblBhZ2VDaGFuZ2VkLCBkb2MpOwoJCW9uSGFzaENoYW5nZWQoKTsKCQlfLmFkZEV2ZW50TGlzdGVuZXIoZ2xvYmFsLCAiaGFzaGNoYW5nZSIsIG9uSGFzaENoYW5nZWQsIGZhbHNlKTsKCgkJcmV0dXJuIHsKCQkJc3RvcDogZnVuY3Rpb24oKXsKCQkJCWdsb2JhbC5yZW1vdmVFdmVudExpc3RlbmVyKCJoYXNoY2hhbmdlIiwgb25IYXNoQ2hhbmdlZCwgZmFsc2UpOwoJCQl9CgkJfTsKCX0KCgoJcmV0dXJuIHsKCQlzdGFydDogc3RhcnRIYXNoTmF2aWdhdGlvbgoJfTsKCn0pOwpkZWZpbmUoJ29yZG51bmcvc3BhL1BhZ2VMb2FkZXInLFsKCSJvcmRudW5nL2FqYXgiCl0sIGZ1bmN0aW9uKAoJYWpheAopewoKCWZ1bmN0aW9uIFBhZ2VMb2FkZXIoY29uZmlnKXsKCQl0aGlzLnBhdGhUb1VybCA9IGNvbmZpZyAmJiBjb25maWcucGF0aFRvVXJsIHx8IGZ1bmN0aW9uKGEpeyByZXR1cm4gYTsgfTsKCQl0aGlzLmNhY2hlID0gKGNvbmZpZyAmJiAnY2FjaGVQYWdlcycgaW4gY29uZmlnID8gY29uZmlnLmNhY2hlUGFnZXMgOiB0cnVlKTsKCQl0aGlzLmN1cnJlbnRYSFIgPSBudWxsOwoJfQoKCVBhZ2VMb2FkZXIucHJvdG90eXBlLmxvYWRQYWdlID0gZnVuY3Rpb24ocGF0aCwgcmVzb2x2ZXIpewoKCQl0aGlzLmFib3J0KCk7CgoJCXZhciB1cmwgPSB0aGlzLnBhdGhUb1VybChwYXRoKTsKCgkJaWYodGhpcy5jYWNoZSA9PT0gZmFsc2UpCgkJCXVybCA9IGFqYXguY2FjaGVCdXN0KHVybCk7CgoJCXRoaXMuY3VycmVudFhIUiA9IGFqYXgodXJsLCB7fSwgIkdFVCIsIGZ1bmN0aW9uKHhocil7CgkJCWlmKHhoci5zdGF0dXMgPT09IDIwMCkKCQkJCXJlc29sdmVyLnJlc29sdmUoeGhyLnJlc3BvbnNlVGV4dCk7CgkJCWVsc2UKCQkJCXJlc29sdmVyLnJlamVjdCh7ZXJyb3I6IHhoci5zdGF0dXMsIGNvbnRlbnQ6IHhoci5yZXNwb25zZVRleHR9KTsKCQl9KTsKCX07CgoJUGFnZUxvYWRlci5wcm90b3R5cGUuYWJvcnQgPSBmdW5jdGlvbigpewoJCWlmKHRoaXMuY3VycmVudFhIUiAmJiB0aGlzLmN1cnJlbnRYSFIucmVhZHlTdGF0ZSAhPT0gNCl7CgkJCXRoaXMuY3VycmVudFhIUi5hYm9ydCgpOwoJCX0KCX07CgoJcmV0dXJuIFBhZ2VMb2FkZXI7Cn0pOwpkZWZpbmUoJ29yZG51bmcvc3BhL1RlbXBsYXRlcycsWwoJIm9yZG51bmcvc3BhL1BhZ2VMb2FkZXIiLAoJIm9yZG51bmcvdXRpbHMiLAoJIndoZW4iCl0sIGZ1bmN0aW9uKAoJUGFnZUxvYWRlciwKCXV0aWxzLAoJd2hlbgopewoKCWZ1bmN0aW9uIGRlZmF1bHRDb25maWcoKXsKCQlyZXR1cm4gewoJCQlwYXRoVG9Vcmw6IGZ1bmN0aW9uKGEpeyByZXR1cm4gYTsgfQoJCX0KCX0KCglmdW5jdGlvbiBmaW5kVGVtcGxhdGVzSW5Eb2N1bWVudChkb2MpewoKCQl2YXIgbm9kZUxpc3QgPSBkb2MucXVlcnlTZWxlY3RvckFsbCgiW3R5cGU9J3RleHQvcGFnZS10ZW1wbGF0ZSddIik7CgkJdmFyIG5vZGVzID0gdXRpbHMudG9BcnJheShub2RlTGlzdCk7CgkJdmFyIHRlbXBsYXRlTGlzdCA9IG5vZGVzLm1hcChmdW5jdGlvbih0ZW1wbGF0ZSl7CgkJCXJldHVybiB7CgkJCQlpZDogdGVtcGxhdGUuaWQudG9Mb3dlckNhc2UoKSwKCQkJCWNvbnRlbnQ6IHRlbXBsYXRlLmlubmVySFRNTAoJCQl9OwoJCX0pOwoKCQlyZXR1cm4gdXRpbHMuYXJyYXlUb09iamVjdCh0ZW1wbGF0ZUxpc3QsIGZ1bmN0aW9uKGl0ZW0sIG9iamVjdCl7CgkJCW9iamVjdFtpdGVtLmlkXSA9IGl0ZW0uY29udGVudDsKCQl9KTsKCX0KCgoJZnVuY3Rpb24gVGVtcGxhdGVzKGRvY3VtZW50LCBjb25maWcpewoJCXRoaXMucGFnZUxvYWRlciA9IG5ldyBQYWdlTG9hZGVyKGNvbmZpZyB8fCBkZWZhdWx0Q29uZmlnKCkpOwoJCXRoaXMuY2FjaGVQYWdlcyA9IChjb25maWcgJiYgJ2NhY2hlUGFnZXMnIGluIGNvbmZpZyA/IGNvbmZpZy5jYWNoZVBhZ2VzIDogdHJ1ZSkKCQl0aGlzLnRlbXBsYXRlcyA9IGZpbmRUZW1wbGF0ZXNJbkRvY3VtZW50KGRvY3VtZW50KTsKCX0KCglUZW1wbGF0ZXMucHJvdG90eXBlLmdldFRlbXBsYXRlID0gZnVuY3Rpb24ocGF0aCl7CgoJCXRoaXMucGFnZUxvYWRlci5hYm9ydCgpOwoKCQl2YXIgbm9ybWFsaXplZFBhdGggPSBwYXRoLnRvTG93ZXJDYXNlKCk7CgoJCWlmKG5vcm1hbGl6ZWRQYXRoIGluIHRoaXMudGVtcGxhdGVzKXsKCQkJcmV0dXJuIHdoZW4ucmVzb2x2ZSh0aGlzLnRlbXBsYXRlc1tub3JtYWxpemVkUGF0aF0pOwoJCX1lbHNlewoJCQl2YXIgZGVmZXJyZWQgPSB3aGVuLmRlZmVyKCk7CgoJCQl0aGlzLnBhZ2VMb2FkZXIubG9hZFBhZ2UocGF0aCwgZGVmZXJyZWQucmVzb2x2ZXIpOwoJCQkKCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbihjb250ZW50KXsKCQkJCWlmKHRoaXMuY2FjaGVQYWdlcykKCQkJCQl0aGlzLnRlbXBsYXRlc1tub3JtYWxpemVkUGF0aF0gPSBjb250ZW50OwoJCQkJCgkJCQlyZXR1cm4gY29udGVudDsKCQkJfS5iaW5kKHRoaXMpLCBmdW5jdGlvbihub3RGb3VuZCl7CgkJCQl2YXIgZXJyb3JUZW1wbGF0ZSA9ICJlcnJvciIgKyBub3RGb3VuZC5lcnJvcjsKCQkJCWlmKGVycm9yVGVtcGxhdGUgaW4gdGhpcy50ZW1wbGF0ZXMpewoJCQkJCXJldHVybiB0aGlzLnRlbXBsYXRlc1tlcnJvclRlbXBsYXRlXTsKCQkJCX1lbHNlewoJCQkJCXJldHVybiBub3RGb3VuZC5jb250ZW50OwoJCQkJfQoJCQl9LmJpbmQodGhpcykpOwoJCX0KCX07CgoJcmV0dXJuIFRlbXBsYXRlczsKfSk7CmRlZmluZSgnb3JkbnVuZy9wcm9jbGFpbVdoZW4nLFtdLCBmdW5jdGlvbiAoKSB7CgoJZnVuY3Rpb24gcHVibGlzaChuYW1lLCBzdWJzY3JpYmVycywgZGF0YSkgewoJCXN1YnNjcmliZXJzLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKCQkJaXRlbS5hcHBseShpdGVtLCBkYXRhKTsKCQl9KTsKCX0KCglmdW5jdGlvbiBzdWJzY3JpYmVUbyhuYW1lLCBzdWJzY3JpYmVycywgc3Vic2NyaWJlcikgewoJCXZhciBpbmRleCA9IHN1YnNjcmliZXJzLmluZGV4T2Yoc3Vic2NyaWJlcik7CgkJaWYoaW5kZXggPCAwKQoJCQlzdWJzY3JpYmVycy5wdXNoKHN1YnNjcmliZXIpOwoJCXJldHVybiBpbmRleCA8IDA7Cgl9CgkKCWZ1bmN0aW9uIHVuc3Vic2NyaWJlRnJvbShuYW1lLCBzdWJzY3JpYmVycywgc3Vic2NyaWJlcil7CgkJdmFyIGluZGV4ID0gc3Vic2NyaWJlcnMuaW5kZXhPZihzdWJzY3JpYmVyKTsKCQlpZihpbmRleCA+PSAwKQoJCQlzdWJzY3JpYmVycy5zcGxpY2UoaW5kZXgsIDEpOwoJCXJldHVybiBpbmRleCA+PSAwOwoJfQoJZnVuY3Rpb24gZXh0ZW5kRXZlbnQobmFtZSwgZXZlbnQpewoJCWV2ZW50LnN1YnNjcmliZXJzID0gW107CgkJZXZlbnQuc3Vic2NyaWJlU3Vic2NyaWJlcnMgPSBbXTsKCQlldmVudC51bnN1YnNjcmliZVN1YnNjcmliZXJzID0gW107CgoJCXZhciBleHRlbmRlZEV2ZW50ID0gZnVuY3Rpb24oKXsKCQkJaWYoYXJndW1lbnRzLmxlbmd0aCA9PSAxICYmIHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICJmdW5jdGlvbiIpewoJCQkJaWYoc3Vic2NyaWJlVG8obmFtZSwgZXZlbnQuc3Vic2NyaWJlcnMsIGFyZ3VtZW50c1swXSkpCgkJCQkJcHVibGlzaChuYW1lKyIuaXNTdWJzY3JpYmVkVG8iLCBldmVudC5zdWJzY3JpYmVTdWJzY3JpYmVycyk7CgkJCX1lbHNlewoJCQkJcHVibGlzaChuYW1lLCBldmVudC5zdWJzY3JpYmVycywgYXJndW1lbnRzKTsKCQkJfQoJCX0KCgkJZXh0ZW5kZWRFdmVudC5kb250ID0gZnVuY3Rpb24oc3Vic2NyaWJlcil7CgkJCWlmKHVuc3Vic2NyaWJlRnJvbShuYW1lLCBldmVudC5zdWJzY3JpYmVycywgc3Vic2NyaWJlcikpCgkJCQlwdWJsaXNoKG5hbWUrIi5pc1Vuc3Vic2NyaWJlZEZyb20iLCBldmVudC51bnN1YnNjcmliZVN1YnNjcmliZXJzKTsKCQl9OwoKCQlleHRlbmRlZEV2ZW50LmlzU3Vic2NyaWJlZFRvID0gZnVuY3Rpb24oc3Vic2NyaWJlcil7CgkJCXN1YnNjcmliZVRvKG5hbWUrIi5pc1N1YnNjcmliZWRUbyIsIGV2ZW50LnN1YnNjcmliZVN1YnNjcmliZXJzLCBzdWJzY3JpYmVyKTsKCQl9OwoKCQlleHRlbmRlZEV2ZW50LmlzU3Vic2NyaWJlZFRvLmRvbnQgPSBmdW5jdGlvbihzdWJzY3JpYmVyKXsKCQkJdW5zdWJzY3JpYmVGcm9tKG5hbWUrIi5pc1N1YnNjcmliZWRUbyIsIGV2ZW50LnN1YnNjcmliZVN1YnNjcmliZXJzLCBzdWJzY3JpYmVyKTsKCQl9OwoKCQlleHRlbmRlZEV2ZW50LmlzVW5zdWJzY3JpYmVkRnJvbSA9IGZ1bmN0aW9uKHN1YnNjcmliZXIpewoJCQlzdWJzY3JpYmVUbyhuYW1lKyIuaXNVbnN1YnNjcmliZWRGcm9tIiwgZXZlbnQudW5zdWJzY3JpYmVTdWJzY3JpYmVycywgc3Vic2NyaWJlcik7CgkJfTsKCgkJZXh0ZW5kZWRFdmVudC5pc1Vuc3Vic2NyaWJlZEZyb20uZG9udCA9IGZ1bmN0aW9uKHN1YnNjcmliZXIpewoJCQl1bnN1YnNjcmliZUZyb20obmFtZSsiLmlzVW5zdWJzY3JpYmVkRnJvbSIsIGV2ZW50LnVuc3Vic2NyaWJlU3Vic2NyaWJlcnMsIHN1YnNjcmliZXIpOwoJCX07CgoJCWV4dGVuZGVkRXZlbnQudG9TdHJpbmcgPSBmdW5jdGlvbigpewoJCQlyZXR1cm4gIltFdmVudCAiK25hbWUrIl0iOwoJCX0KCgkJcmV0dXJuIGV4dGVuZGVkRXZlbnQ7Cgl9CgkKCWZ1bmN0aW9uIGV4dGVuZChldmVudHMpewoJCWZvcih2YXIgaSBpbiBldmVudHMpewoJCQlldmVudHNbaV0gPSBleHRlbmRFdmVudChpLCBldmVudHNbaV0pOwoJCX0KCQlyZXR1cm4gZXZlbnRzOwoJfQoKCWZ1bmN0aW9uIGNyZWF0ZShhcmcxLCBhcmcyKXsKCQlpZihhcmcyKQoJCQlyZXR1cm4gZXh0ZW5kRXZlbnQoYXJnMSwgYXJnMik7CgkJZWxzZQoJCQlyZXR1cm4gZXh0ZW5kRXZlbnQoImFub255bW91cyBldmVudCIsIGFyZzEpCgl9CgoJcmV0dXJuIHsKCQlleHRlbmQ6IGV4dGVuZCwKCQljcmVhdGU6IGNyZWF0ZQoJfTsKCQp9KTsKCmRlZmluZSgnb3JkbnVuZy9ldmVudHMnLFsnb3JkbnVuZy9wcm9jbGFpbVdoZW4nXSwgZnVuY3Rpb24ocHJvY2xhaW1XaGVuKXsKCXJldHVybiBwcm9jbGFpbVdoZW4uZXh0ZW5kKHsKCQl0aGVQYWdlSGFzQ2hhbmdlZDogZnVuY3Rpb24ocGF0aCwgc2VnbWVudHMsIHVybCl7IH0KCX0pOwp9KTsKZGVmaW5lKCdvcmRudW5nL3NwYScsWwoJIm9yZG51bmcvc3BhL091dGxldCIsCgkib3JkbnVuZy9zcGEvd2hlbkNvbnRleHQiLAoJIm9yZG51bmcvc3BhL2FwcGx5Vmlld01vZGVscyIsCgkib3JkbnVuZy9zcGEvaGFzaE5hdmlnYXRpb24iLAoJIm9yZG51bmcvc3BhL1RlbXBsYXRlcyIsCgkib3JkbnVuZy91dGlscyIsCgkib3JkbnVuZy9ldmVudHMiCl0sIGZ1bmN0aW9uKAoJT3V0bGV0LAoJd2hlbkNvbnRleHQsCglhcHBseVZpZXdNb2RlbHMsCgloYXNoTmF2aWdhdGlvbiwKCVRlbXBsYXRlcywKCXV0aWxzLAoJcHJvY2xhaW0KKXsKCgl2YXIgX2NvbmZpZyA9IHsKCQkJaW5kZXg6ICJpbmRleCIKCQl9LAoJCV9kb2N1bWVudCwKCQlfb3V0bGV0LAoJCV9vcmlnaW5hbFRpdGxlLAoJCV90ZW1wbGF0ZXMsCgkJX3doZW5Db250ZXh0OwoKCWZ1bmN0aW9uIGFwcGx5Q29udGVudChjb250ZW50KXsKCQlfb3V0bGV0LnVubG9hZEN1cnJlbnRQYWdlKCk7CgkJX291dGxldC5zZXRQYWdlQ29udGVudChjb250ZW50KTsKCQlfb3V0bGV0LnNldERvY3VtZW50VGl0bGUoX291dGxldC5nZXRQYWdlVGl0bGUoKSB8fCBfb3JpZ2luYWxUaXRsZSk7CgkJX291dGxldC5leHRyYWN0QW5kUnVuUGFnZUphdmFTY3JpcHQoKTsKCQlyZXR1cm4gYXBwbHlWaWV3TW9kZWxzKF9vdXRsZXQuZWxlbWVudCwgX3doZW5Db250ZXh0KCkpOwoJfQoKCWZ1bmN0aW9uIHBhZ2VDaGFuZ2VkKHBhdGgsIHNlZ21lbnRzKXsKCQlfb3V0bGV0LmluZGljYXRlUGFnZUlzTG9hZGluZygpOwoJCV93aGVuQ29udGV4dC5kZXN0cm95Q2hpbGRDb250ZXh0cygpOwoJCXJldHVybiBfdGVtcGxhdGVzLmdldFRlbXBsYXRlKHBhdGgpCgkJCS50aGVuKGFwcGx5Q29udGVudCkKCQkJLnRoZW4oZnVuY3Rpb24oKXsKCQkJCV9vdXRsZXQucGFnZUhhc0xvYWRlZCgpOwoJCQkJcHJvY2xhaW0udGhlUGFnZUhhc0NoYW5nZWQocGF0aCwgc2VnbWVudHMsIGRvY3VtZW50LmxvY2F0aW9uKQoJCQl9KTsKCX0KCglmdW5jdGlvbiBzdGFydChjb25maWcsIGRvY3VtZW50KXsKCQlfZG9jdW1lbnQgPSBkb2N1bWVudCB8fCB3aW5kb3cuZG9jdW1lbnQ7CgkJX2NvbmZpZyA9IHV0aWxzLmV4dGVuZChfY29uZmlnLCBjb25maWcpOwoJCV9vdXRsZXQgPSBuZXcgT3V0bGV0KF9kb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJbZGF0YS1vdXRsZXRdIiksIF9kb2N1bWVudCk7CgkJX29yaWdpbmFsVGl0bGUgPSBfZG9jdW1lbnQudGl0bGU7CgkJX3doZW5Db250ZXh0ID0gd2hlbkNvbnRleHQoKTsKCgkJcmV0dXJuIGFwcGx5Vmlld01vZGVscyhfZG9jdW1lbnQsIHdoZW5Db250ZXh0KCkpLnRoZW4oZnVuY3Rpb24oKXsKCQkJaWYoX291dGxldC5vdXRsZXRFeGlzdHMoKSl7CgkJCQlfdGVtcGxhdGVzID0gbmV3IFRlbXBsYXRlcyhfZG9jdW1lbnQsIF9jb25maWcpOwoJCQkJaGFzaE5hdmlnYXRpb24uc3RhcnQoX2NvbmZpZywgcGFnZUNoYW5nZWQsIF9kb2N1bWVudCk7CgkJCX0KCQl9KTsKCX0KCglyZXR1cm4gewoJCXN0YXJ0OiBzdGFydAoJfTsKfSk7CmRlZmluZSgnb3JkbnVuZy9vcmRudW5nJyxbCiAgJ29yZG51bmcvcXZjJywKICAnb3JkbnVuZy9zcGEnCl0sIGZ1bmN0aW9uKAogIHF2YywKICBzcGEKKXsKCiAgCgogIGZ1bmN0aW9uIGNvbmZpZyhjb25maWcpewoKICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTsKCiAgICB2YXIgc3BhQ29uZmlnID0gY29uZmlnLnNwYSB8fCB7fTsKICAgIHZhciBxdmNDb25maWcgPSBjb25maWcucXZjIHx8IHt9OwoKICAgIHF2Yy5jb25maWcocXZjQ29uZmlnKTsKCiAgICByZXR1cm4gewogICAgICBzdGFydDogc3BhLnN0YXJ0LmJpbmQobnVsbCwgc3BhQ29uZmlnLCBkb2N1bWVudCkKICAgIH0KICB9CiAgCiAgcmV0dXJuIHsKICAgIGNvbmZpZzogY29uZmlnCiAgfTsKCn0pOwpkZWZpbmUoJ29yZG51bmcnLCBbJ29yZG51bmcvb3JkbnVuZyddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ29yZG51bmcvcXZjL2NvbnN0cmFpbnRzL05vdEVtcHR5JyxbXSwgZnVuY3Rpb24oKXsKCWZ1bmN0aW9uIE5vdEVtcHR5KGF0dHJpYnV0ZXMpewoJCQoJfQoJCglOb3RFbXB0eS5wcm90b3R5cGUuaXNWYWxpZCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQlpZih2YWx1ZSA9PSBudWxsKSByZXR1cm4gZmFsc2U7CgkJaWYodHlwZW9mIHZhbHVlID09ICJzdHJpbmciICYmIHZhbHVlLmxlbmd0aCA9PSAwKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9OwoJCglyZXR1cm4gTm90RW1wdHk7Cn0pOwpkZWZpbmUoJ29yZG51bmcvcXZjL2NvbnN0cmFpbnRzL1BhdHRlcm4nLFtdLCBmdW5jdGlvbigpewoJZnVuY3Rpb24gUGF0dGVybihhdHRyaWJ1dGVzKXsJCQoKCQlhdHRyaWJ1dGVzLmZsYWdzID0gYXR0cmlidXRlcy5mbGFncyB8fCBbXTsKCQkKCQl2YXIgZmxhZ3MgPSAnJzsKCQlpZihhdHRyaWJ1dGVzLmZsYWdzLmluZGV4T2YoIkNBU0VfSU5TRU5TSVRJVkUiKSA+PSAwKSBmbGFncyArPSAnaSc7CgkJCgkJdGhpcy5yZWdleCA9IG5ldyBSZWdFeHAoYXR0cmlidXRlcy5yZWdleHAsIGZsYWdzKTsKCX0KCQoJCglQYXR0ZXJuLnByb3RvdHlwZS5pc1ZhbGlkID0gZnVuY3Rpb24odmFsdWUpewoJCQoJCWlmKHZhbHVlID09IG51bGwpIHJldHVybiBmYWxzZTsKCQkKCQl2YXIgcmVzdWx0ID0gdGhpcy5yZWdleC5leGVjKHZhbHVlKTsKCQkKCQlpZihyZXN1bHQgPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwoJCQoJCXJldHVybiByZXN1bHRbMF0gPT0gdmFsdWU7Cgl9OwoJCgkKCXJldHVybiBQYXR0ZXJuOwp9KTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9b3JkbnVuZy5qcy5tYXA=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:29:02 GMT",
                    "Content-Length": "32330",
                    "Date": "Fri, 07 Nov 2014 21:29:02 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}