{
    "url": "http://localhost:9999/CloudKidStudio/CloudKidOS/dist/cloudkid-os-pixi.debug.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Client-side JSON injection (DOM-based)",
    "issueType": 2098032,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based JSON injection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and incorporates this into a string that is parsed as a JSON data structure and then processed by the application. An attacker may be able to use this behavior to construct a URL which, if visited by another application user, will cause arbitrary JSON data to be processed. Depending on the purpose for which this data is used, it may be possible to subvert the application's logic, or cause unintended actions on behalf of the user.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based JSON injection vulnerabilities is not to parse as JSON any string containing data that originated from an untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from modifying the JSON structure in inappropriate ways. This may involve strict validation of specific items to ensure they do not contain any characters that may interfere with the structure of the JSON when it is parsed.",
    "issueDetail": "The application may be vulnerable to DOM-based client-side JSON injection. Data is read from <b>document.cookie</b> and written to <b>JSON.parse()</b> via the following statements:<ul><li>var c, nameEQ = name + \"=\", ca = document.cookie.split(\";\"), i = 0;</li><li>c = ca[i]</li><li>return JSON.parse(unescape(c.substring(nameEQ.length, c.length)));</li></ul>Because the data originates from a cookie, the application's behavior is not trivial to exploit in an attack against another user. Typically, you will need to find a means of setting an arbitrary cookie value in the victim's browser in order to exploit the vulnerability. Applications often contain \"cookie-forcing\" conditions which make this possible, and such a condition in any related domain or subdomain can potentially be used for this purpose. Nonetheless, this limitation somewhat mitigates the impact of the vulnerability. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/CloudKidStudio/CloudKidOS/dist/cloudkid-os-pixi.debug.js",
                "path": "/CloudKidStudio/CloudKidOS/dist/cloudkid-os-pixi.debug.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9DbG91ZEtpZFN0dWRpby9DbG91ZEtpZE9TL2Rpc3QvY2xvdWRraWQtb3MtcGl4aS5kZWJ1Zy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTczNTQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTU6Mzk6MzQgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDE1OjM5OjMwIEdNVA0KDQohZnVuY3Rpb24odW5kZWZpbmVkKSB7CiAgICB2YXIgT1MgPSBmdW5jdGlvbigpIHt9LCBwID0gT1MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKSwgX3BhdXNlZCA9ICExLCBfaXNSZWFkeSA9ICExLCBfZnJhbWVyYXRlID0gbnVsbCwgX2xhc3RGcmFtZVRpbWUgPSAwLCBfbGFzdEZQU1VwZGF0ZVRpbWUgPSAwLCBfZnJhbWVyYXRlVmFsdWUgPSBudWxsLCBfZnJhbWVDb3VudCA9IDAsIF90aWNrQ2FsbGJhY2sgPSBudWxsLCBfaW5zdGFuY2UgPSBudWxsLCBfdGlja0lkID0gLTEsIF91c2VSQUYgPSAhMSwgX2ZwcyA9IDAsIF9tc1BlckZyYW1lID0gMDsKICAgIE9TLlZFUlNJT04gPSAiMS4xLjI3IiwgcC5zdGFnZSA9IG51bGwsIHAuX3JlbmRlcmVyID0gbnVsbCwgcC5jYW52YXNDb250YWluZXIgPSBudWxsLCAKICAgIHAuX2FwcCA9IG51bGwsIHAub3B0aW9ucyA9IG51bGwsIHAuX3VwZGF0ZUZ1bmN0aW9ucyA9IHt9LCBPUy5pbml0ID0gZnVuY3Rpb24oc3RhZ2VOYW1lLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIF9pbnN0YW5jZSB8fCAoRGVidWcubG9nKCJDcmVhdGluZyB0aGUgc2luZ2xldG9uIGluc3RhbmNlIG9mIE9TIiksIF9pbnN0YW5jZSA9IG5ldyBPUygpLCAKICAgICAgICBfaW5zdGFuY2UuaW5pdGlhbGl6ZShzdGFnZU5hbWUsIG9wdGlvbnMpKSwgX2luc3RhbmNlOwogICAgfSwgcC5pbml0aWFsaXplID0gZnVuY3Rpb24oc3RhZ2VOYW1lLCBvcHRpb25zKSB7CiAgICAgICAgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwodGhpcyksIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge30sIHRoaXMub3B0aW9ucy5wYXJzZVF1ZXJ5U3RyaW5nICE9PSB1bmRlZmluZWQgJiYgKHRoaXMub3B0aW9ucyA9IHBhcnNlUXVlcnlTdHJpbmdQYXJhbXModGhpcy5vcHRpb25zKSksIAogICAgICAgIHRoaXMub3B0aW9ucy5kZWJ1ZyAhPT0gdW5kZWZpbmVkICYmIChEZWJ1Zy5lbmFibGVkID0gdGhpcy5vcHRpb25zLmRlYnVnID09PSAhMCB8fCAidHJ1ZSIgPT09IHRoaXMub3B0aW9ucy5kZWJ1ZyksIAogICAgICAgIHRoaXMub3B0aW9ucy5taW5Mb2dMZXZlbCAhPT0gdW5kZWZpbmVkICYmIChEZWJ1Zy5taW5Mb2dMZXZlbCA9IHBhcnNlSW50KHRoaXMub3B0aW9ucy5taW5Mb2dMZXZlbCwgMTApKSwgCiAgICAgICAgInN0cmluZyIgPT0gdHlwZW9mIHRoaXMub3B0aW9ucy5pcCAmJiBEZWJ1Zy5jb25uZWN0KHRoaXMub3B0aW9ucy5pcCk7CiAgICAgICAgdmFyIGxvYWRlciA9IGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluaXQoKTsKICAgICAgICB0aGlzLnN0YWdlID0gbmV3IFBJWEkuU3RhZ2UodGhpcy5vcHRpb25zLmJhY2tncm91bmRDb2xvciB8fCAwLCAhMCksIHRoaXMuc3RhZ2UuYWRkQ2hpbGQodGhpcyksIAogICAgICAgIHRoaXMudmlzaWJsZUxpc3RlbmVyID0gdGhpcy5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkLmJpbmQodGhpcyksIGFkZFBhZ2VIaWRlTGlzdGVuZXIodGhpcy52aXNpYmxlTGlzdGVuZXIpOwogICAgICAgIHZhciB0cmFuc3BhcmVudCA9ICEhdGhpcy5vcHRpb25zLnRyYW5zcGFyZW50IHx8ICExLCBwcmVNdWx0QWxwaGEgPSAhIXRoaXMub3B0aW9ucy5wcmVNdWx0QWxwaGEgfHwgITE7CiAgICAgICAgdGhpcy5jb250YWluZXJOYW1lID0gInN0cmluZyIgPT0gdHlwZW9mIHN0YWdlTmFtZSA/IHN0YWdlTmFtZSA6IHN0YWdlTmFtZS5hdHRyKCJpZCIpOwogICAgICAgIHZhciBjb250YWluZXIgPSAic3RyaW5nIiA9PSB0eXBlb2Ygc3RhZ2VOYW1lID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc3RhZ2VOYW1lKSA6IHN0YWdlTmFtZSwgY2FudmFzQ29udGFpbmVyID0gdGhpcy5jYW52YXNDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoY2FudmFzQ29udGFpbmVyKSwgY2FudmFzQ29udGFpbmVyLmlkID0gIkNLT1MiOwogICAgICAgIHZhciB3aWR0aCA9IHRoaXMub3B0aW9ucy53aWR0aCB8fCBjb250YWluZXIuaW5uZXJXaWR0aCwgaGVpZ2h0ID0gdGhpcy5vcHRpb25zLmhlaWdodCB8fCBjb250YWluZXIuaW5uZXJIZWlnaHQ7CiAgICAgICAgaWYgKHRoaXMuX3JlbmRlcmVyID0gImNhbnZhczJkIiA9PSB0aGlzLm9wdGlvbnMuZm9yY2VDb250ZXh0ID8gbmV3IFBJWEkuQ2FudmFzUmVuZGVyZXIod2lkdGgsIGhlaWdodCwgbnVsbCwgdHJhbnNwYXJlbnQpIDogIndlYmdsIiA9PSB0aGlzLm9wdGlvbnMuZm9yY2VDb250ZXh0ID8gbmV3IFBJWEkuV2ViR0xSZW5kZXJlcih3aWR0aCwgaGVpZ2h0LCBudWxsLCB0cmFuc3BhcmVudCwgcHJlTXVsdEFscGhhKSA6IFBJWEkuYXV0b0RldGVjdFJlbmRlcmVyKHdpZHRoLCBoZWlnaHQsIG51bGwsIHRyYW5zcGFyZW50LCBwcmVNdWx0QWxwaGEpLCAKICAgICAgICBjYW52YXNDb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5fcmVuZGVyZXIudmlldyksIGNhbnZhc0NvbnRhaW5lci5zZXRBdHRyaWJ1dGUoInN0eWxlIiwgInBvc2l0aW9uOnJlbGF0aXZlO3dpZHRoOiIgKyB3aWR0aCArICJweDtoZWlnaHQ6IiArIGhlaWdodCArICJweCIpLCAKICAgICAgICB0aGlzLl9yZW5kZXJlci5jbGVhclZpZXcgPSAhIXRoaXMub3B0aW9ucy5jbGVhclZpZXcsIHRoaXMub3B0aW9ucy5zaG93RnJhbWVyYXRlICYmIChfZnJhbWVyYXRlID0gbmV3IFBJWEkuVGV4dCgiRlBTOiAwLjAwMCIsIHsKICAgICAgICAgICAgZm9udDogIjEwcHggQXJpYWwiLAogICAgICAgICAgICBmaWxsOiAiYmxhY2siLAogICAgICAgICAgICBzdHJva2U6ICJ3aGl0ZSIsCiAgICAgICAgICAgIHN0cm9rZVRoaWNrbmVzczogMgogICAgICAgIH0pLCBfZnJhbWVyYXRlLnggPSBfZnJhbWVyYXRlLnkgPSA1LCB0aGlzLmFkZENoaWxkKF9mcmFtZXJhdGUpKSwgdGhpcy5fcmVuZGVyZXIucmVuZGVyKHRoaXMuc3RhZ2UpLCAKICAgICAgICBfdGlja0NhbGxiYWNrID0gdGhpcy50aWNrLmJpbmQodGhpcyksIF91c2VSQUYgPSB0aGlzLm9wdGlvbnMucmFmIHx8ICExLCB0aGlzLmZwcyA9IHRoaXMub3B0aW9ucy5mcHMgfHwgNjAsIAogICAgICAgIHRoaXMucmVtb3ZlQXBwKCksIHRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBfaXNSZWFkeSA9ICExOwogICAgICAgICAgICB2YXIgb3MgPSB0aGlzOwogICAgICAgICAgICBsb2FkZXIuY2FjaGVNYW5hZ2VyLmFkZFZlcnNpb25zRmlsZSh0aGlzLm9wdGlvbnMudmVyc2lvbnNGaWxlLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIF9pc1JlYWR5ID0gITAsIG9zLl9hcHAgJiYgKG9zLmFkZENoaWxkQXQob3MuX2FwcCwgMCksIG9zLl9hcHAuaW5pdCgpLCBvcy5yZXN1bWUoKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBfaXNSZWFkeSA9ICEwOwogICAgfTsKICAgIHZhciBoaWRkZW4gPSBudWxsLCBldnRNYXAgPSBudWxsLCB2ID0gInZpc2libGUiLCBoID0gImhpZGRlbiIsIGFkZFBhZ2VIaWRlTGlzdGVuZXIgPSBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgICAgIGhpZGRlbiA9ICJoaWRkZW4iLCBoaWRkZW4gaW4gZG9jdW1lbnQgPyBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpIDogKGhpZGRlbiA9ICJtb3pIaWRkZW4iKSBpbiBkb2N1bWVudCA/IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1venZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcikgOiAoaGlkZGVuID0gIndlYmtpdEhpZGRlbiIpIGluIGRvY3VtZW50ID8gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigid2Via2l0dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSA6IChoaWRkZW4gPSAibXNIaWRkZW4iKSBpbiBkb2N1bWVudCA/IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1zdmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSA6ICJvbmZvY3VzaW4iIGluIGRvY3VtZW50ID8gKGV2dE1hcCA9IHsKICAgICAgICAgICAgZm9jdXNpbjogdiwKICAgICAgICAgICAgZm9jdXNvdXQ6IGgKICAgICAgICB9LCBkb2N1bWVudC5vbmZvY3VzaW4gPSBkb2N1bWVudC5vbmZvY3Vzb3V0ID0gbGlzdGVuZXIpIDogKGV2dE1hcCA9IHsKICAgICAgICAgICAgZm9jdXM6IHYsCiAgICAgICAgICAgIHBhZ2VzaG93OiB2LAogICAgICAgICAgICBibHVyOiBoLAogICAgICAgICAgICBwYWdlaGlkZTogaAogICAgICAgIH0sIHdpbmRvdy5vbnBhZ2VzaG93ID0gd2luZG93Lm9ucGFnZWhpZGUgPSB3aW5kb3cub25mb2N1cyA9IHdpbmRvdy5vbmJsdXIgPSBsaXN0ZW5lcik7CiAgICB9LCByZW1vdmVQYWdlSGlkZUxpc3RlbmVyID0gZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICB2YXIgaGlkZGVuID0gImhpZGRlbiI7CiAgICAgICAgaGlkZGVuIGluIGRvY3VtZW50ID8gZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigidmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSA6IChoaWRkZW4gPSAibW96SGlkZGVuIikgaW4gZG9jdW1lbnQgPyBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3p2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpIDogKGhpZGRlbiA9ICJ3ZWJraXRIaWRkZW4iKSBpbiBkb2N1bWVudCA/IGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIndlYmtpdHZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcikgOiAoaGlkZGVuID0gIm1zSGlkZGVuIikgaW4gZG9jdW1lbnQgJiYgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibXN2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpLCAKICAgICAgICBkb2N1bWVudC5vbmZvY3VzaW4gPSBkb2N1bWVudC5vbmZvY3Vzb3V0ID0gbnVsbCwgd2luZG93Lm9ucGFnZXNob3cgPSB3aW5kb3cub25wYWdlaGlkZSA9IHdpbmRvdy5vbmZvY3VzID0gd2luZG93Lm9uYmx1ciA9IG51bGw7CiAgICB9OwogICAgcC5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkID0gZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgdmFyIHYgPSAidmlzaWJsZSIsIGggPSAiaGlkZGVuIjsKICAgICAgICBldnQgPSBldnQgfHwgd2luZG93LmV2ZW50OwogICAgICAgIHZhciB2YWx1ZTsKICAgICAgICB2YWx1ZSA9IGV2dE1hcCA/IGV2dE1hcFtldnQudHlwZV0gOiBkb2N1bWVudFtoaWRkZW5dID8gaCA6IHYsIHZhbHVlID09IGggPyB0aGlzLnBhdXNlKCkgOiB0aGlzLnJlc3VtZSgpOwogICAgfTsKICAgIHZhciBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zID0gZnVuY3Rpb24ob3V0cHV0KSB7CiAgICAgICAgdmFyIGhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZiwgcXVlc3Rpb25NYXJrID0gaHJlZi5pbmRleE9mKCI/Iik7CiAgICAgICAgaWYgKC0xID09IHF1ZXN0aW9uTWFyaykgcmV0dXJuIG91dHB1dDsKICAgICAgICB2YXIgdmFycyA9IDAgPiBxdWVzdGlvbk1hcmsgPyAiIiA6IGhyZWYuc3Vic3RyKHF1ZXN0aW9uTWFyayArIDEpLCBwb3VuZCA9IHZhcnMuaW5kZXhPZigiIyIpOwogICAgICAgIHZhcnMgPSAwID4gcG91bmQgPyB2YXJzIDogdmFycy5zdWJzdHJpbmcoMCwgcG91bmQpOwogICAgICAgIGZvciAodmFyIG15VmFyLCBzcGxpdEZsYXNoVmFycyA9IHZhcnMuc3BsaXQoIiYiKSwgaSA9IDA7IGkgPCBzcGxpdEZsYXNoVmFycy5sZW5ndGg7IGkrKykgbXlWYXIgPSBzcGxpdEZsYXNoVmFyc1tpXS5zcGxpdCgiPSIpLCAKICAgICAgICBEZWJ1Zy5sb2cobXlWYXJbMF0gKyAiIC0+ICIgKyBteVZhclsxXSksIG91dHB1dFtteVZhclswXV0gPSBteVZhclsxXTsKICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgfTsKICAgIHAucGF1c2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAtMSAhPSBfdGlja0lkICYmIChfdXNlUkFGID8gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lICYmIGNhbmNlbEFuaW1hdGlvbkZyYW1lKF90aWNrSWQpIDogY2xlYXJUaW1lb3V0KF90aWNrSWQpLCAKICAgICAgICBfdGlja0lkID0gLTEpLCBfcGF1c2VkID0gITA7CiAgICB9OwogICAgdmFyIG5vd0Z1bmMgPSB3aW5kb3cucGVyZm9ybWFuY2UgJiYgKHBlcmZvcm1hbmNlLm5vdyB8fCBwZXJmb3JtYW5jZS5tb3pOb3cgfHwgcGVyZm9ybWFuY2UubXNOb3cgfHwgcGVyZm9ybWFuY2Uub05vdyB8fCBwZXJmb3JtYW5jZS53ZWJraXROb3cpOwogICAgbm93RnVuYyA9IG5vd0Z1bmMgPyBub3dGdW5jLmJpbmQocGVyZm9ybWFuY2UpIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgfSwgcC5nZXRUaW1lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5vd0Z1bmMoKTsKICAgIH0sIHAucmVzdW1lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgX3BhdXNlZCA9ICExLCAtMSA9PSBfdGlja0lkICYmIChfdGlja0lkID0gX3VzZVJBRiA/IHJlcXVlc3RBbmltRnJhbWUoX3RpY2tDYWxsYmFjaykgOiBzZXRUYXJnZXRlZFRpbWVvdXQoX3RpY2tDYWxsYmFjaykpLCAKICAgICAgICBfbGFzdEZQU1VwZGF0ZVRpbWUgPSBfbGFzdEZyYW1lVGltZSA9IHRoaXMuZ2V0VGltZSgpOwogICAgfSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJmcHMiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIF9mcHM7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICJudW1iZXIiID09IHR5cGVvZiB2YWx1ZSAmJiAoX2ZwcyA9IHZhbHVlLCBfbXNQZXJGcmFtZSA9IDFlMyAvIF9mcHMgfCAwKTsKICAgICAgICB9CiAgICB9KSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJzdGFnZVdpZHRoIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBfaW5zdGFuY2UuX3JlbmRlcmVyLnZpZXcud2lkdGg7CiAgICAgICAgfQogICAgfSksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAic3RhZ2VIZWlnaHQiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIF9pbnN0YW5jZS5fcmVuZGVyZXIudmlldy5oZWlnaHQ7CiAgICAgICAgfQogICAgfSk7CiAgICB2YXIgc2V0VGFyZ2V0ZWRUaW1lb3V0ID0gZnVuY3Rpb24oY2FsbGJhY2ssIHRpbWVJbkZyYW1lKSB7CiAgICAgICAgdmFyIHRpbWVUb0NhbGwgPSAwOwogICAgICAgIHJldHVybiB0aW1lSW5GcmFtZSAmJiAodGltZVRvQ2FsbCA9IE1hdGgubWF4KDAsIF9tc1BlckZyYW1lIC0gdGltZUluRnJhbWUpKSwgc2V0VGltZW91dChjYWxsYmFjaywgdGltZVRvQ2FsbCk7CiAgICB9OwogICAgcC5yZW1vdmVBcHAgPSBmdW5jdGlvbihkZXN0cm95aW5nKSB7CiAgICAgICAgdmFyIHJlbW92ZWQgPSAhMSwgc3RhZ2UgPSB0aGlzLnN0YWdlOwogICAgICAgIHJldHVybiB0aGlzLl9hcHAgJiYgKHRoaXMuX2FwcC5wYXJlbnQgPT0gdGhpcyAmJiB0aGlzLnJlbW92ZUNoaWxkKHRoaXMuX2FwcCksIHN0YWdlLnJlbW92ZUNoaWxkcmVuKCksIAogICAgICAgIHRoaXMuX2FwcC5kZXN0cm95KCksIHJlbW92ZWQgPSAhMCksIHRoaXMuX2FwcCA9IG51bGwsIHRoaXMucGF1c2UoKSwgZGVzdHJveWluZyB8fCAoc3RhZ2UuYWRkQ2hpbGQodGhpcyksIAogICAgICAgIF9mcmFtZXJhdGUgJiYgKF9mcmFtZXJhdGUudGV4dCA9ICJGUFM6IDAuMDAwIiksIF9sYXN0RnJhbWVUaW1lID0gX2xhc3RGUFNVcGRhdGVUaW1lID0gX2ZyYW1lcmF0ZVZhbHVlID0gX2ZyYW1lQ291bnQgPSAwLCAKICAgICAgICB0aGlzLl9yZW5kZXJlci5yZW5kZXIoc3RhZ2UpKSwgcmVtb3ZlZDsKICAgIH0sIHAuYWRkQXBwID0gZnVuY3Rpb24oYXBwKSB7CiAgICAgICAgaWYgKHRoaXMucmVtb3ZlQXBwKCksICEoYXBwIGluc3RhbmNlb2YgY2xvdWRraWQuQXBwbGljYXRpb24pKSB0aHJvdyBuZXcgRXJyb3IoIkNhbiBvbmx5IG9iamVjdHMgdGhhdCBpbmhlcml0IGNsb3Vka2lkLkFwcGxpY2F0aW9uIik7CiAgICAgICAgdGhpcy5fYXBwID0gYXBwLCBfaXNSZWFkeSAmJiAodGhpcy5hZGRDaGlsZEF0KGFwcCwgMCksIHRoaXMuX2FwcC5pbml0KCksIHRoaXMucmVzdW1lKCkpOwogICAgfSwgcC5nZXRBcHAgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYXBwOwogICAgfSwgcC5hZGRVcGRhdGVDYWxsYmFjayA9IGZ1bmN0aW9uKGFsaWFzLCBmKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9PT0gdW5kZWZpbmVkICYmICh0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdID0gZik7CiAgICB9LCBwLnJlbW92ZVVwZGF0ZUNhbGxiYWNrID0gZnVuY3Rpb24oYWxpYXMpIHsKICAgICAgICB0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdICE9PSB1bmRlZmluZWQgJiYgZGVsZXRlIHRoaXMuX3VwZGF0ZUZ1bmN0aW9uc1thbGlhc107CiAgICB9LCBwLnRpY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoX3BhdXNlZCkgcmV0dXJuIHZvaWQgKF90aWNrSWQgPSAtMSk7CiAgICAgICAgdmFyIG5vdyA9IHRoaXMuZ2V0VGltZSgpLCBkVGltZSA9IG5vdyAtIF9sYXN0RnJhbWVUaW1lOwogICAgICAgIGlmIChfZnJhbWVyYXRlICYmIF9mcmFtZXJhdGUudmlzaWJsZSkgewogICAgICAgICAgICBfZnJhbWVDb3VudCsrOwogICAgICAgICAgICB2YXIgZWxhcHNlZCA9IG5vdyAtIF9sYXN0RlBTVXBkYXRlVGltZTsKICAgICAgICAgICAgZWxhcHNlZCA+IDFlMyAmJiAoX2ZyYW1lcmF0ZVZhbHVlID0gMWUzIC8gZWxhcHNlZCAqIF9mcmFtZUNvdW50LCBfZnJhbWVyYXRlLnNldFRleHQoIkZQUzogIiArIE1hdGgucm91bmQoMWUzICogX2ZyYW1lcmF0ZVZhbHVlKSAvIDFlMyksIAogICAgICAgICAgICBfbGFzdEZQU1VwZGF0ZVRpbWUgPSBub3csIF9mcmFtZUNvdW50ID0gMCk7CiAgICAgICAgfQogICAgICAgIF9sYXN0RnJhbWVUaW1lID0gbm93LCB0aGlzLl9hcHAgJiYgdGhpcy5fYXBwLnVwZGF0ZShkVGltZSk7CiAgICAgICAgZm9yICh2YXIgYWxpYXMgaW4gdGhpcy5fdXBkYXRlRnVuY3Rpb25zKSB0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdKGRUaW1lKTsKICAgICAgICB0aGlzLl9yZW5kZXJlci5yZW5kZXIodGhpcy5zdGFnZSksIF90aWNrSWQgPSBfdXNlUkFGID8gcmVxdWVzdEFuaW1GcmFtZShfdGlja0NhbGxiYWNrKSA6IHNldFRhcmdldGVkVGltZW91dChfdGlja0NhbGxiYWNrLCB0aGlzLmdldFRpbWUoKSAtIF9sYXN0RnJhbWVUaW1lKTsKICAgIH0sIHAucmVzaXplID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIHRoaXMuX3JlbmRlcmVyLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KSwgdGhpcy5jYW52YXNDb250YWluZXIuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJwb3NpdGlvbjpyZWxhdGl2ZTt3aWR0aDoiICsgd2lkdGggKyAicHg7aGVpZ2h0OiIgKyBoZWlnaHQgKyAicHgiKTsKICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzdGFnZSA9IHRoaXMuc3RhZ2UsIG1sID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5zdGFuY2U7CiAgICAgICAgdGhpcy5wYXVzZSgpLCB0aGlzLnJlbW92ZUFwcCghMCksIF9pbnN0YW5jZSA9IG51bGwsIG1sLmRlc3Ryb3koKSwgdGhpcy5zdGFnZSA9IG51bGwsIAogICAgICAgIHRoaXMuX3VwZGF0ZUZ1bmN0aW9ucyA9IG51bGwsIHJlbW92ZVBhZ2VIaWRlTGlzdGVuZXIodGhpcy52aXNpYmxlTGlzdGVuZXIpLCB0aGlzLnJlbW92ZUNoaWxkcmVuKCEwKSwgCiAgICAgICAgc3RhZ2UuZGVzdHJveSgpLCB0aGlzLl9yZW5kZXJlci5kZXN0cm95KCksIHRoaXMuX3JlbmRlcmVyID0gbnVsbCwgdGhpcy5jYW52YXNDb250YWluZXIgPSBudWxsOwogICAgfSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KE9TLCAiaW5zdGFuY2UiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFfaW5zdGFuY2UpIHRocm93ICJDYWxsIGNsb3Vka2lkLk9TLmluaXQoY2FudmFzSWQpIjsKICAgICAgICAgICAgcmV0dXJuIF9pbnN0YW5jZTsKICAgICAgICB9CiAgICB9KSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLk9TID0gT1M7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgU2F2ZWREYXRhID0ge30sIFdFQl9TVE9SQUdFX1NVUFBPUlQgPSAidW5kZWZpbmVkIiAhPSB0eXBlb2Ygd2luZG93LlN0b3JhZ2UsIEVSQVNFX0NPT0tJRSA9IC0xOwogICAgaWYgKFdFQl9TVE9SQUdFX1NVUFBPUlQpIHRyeSB7CiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpLCBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiTFNfVEVTVCIpOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIFdFQl9TVE9SQUdFX1NVUFBPUlQgPSAhMTsKICAgIH0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTYXZlZERhdGEsICJ1c2VXZWJTdG9yYWdlIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBXRUJfU1RPUkFHRV9TVVBQT1JUOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgJiYgInVuZGVmaW5lZCIgIT0gdHlwZW9mIHdpbmRvdy5TdG9yYWdlKSB0cnkgewogICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpLCBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiTFNfVEVTVCIpLCBXRUJfU1RPUkFHRV9TVVBQT1JUID0gITA7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIFdFQl9TVE9SQUdFX1NVUFBPUlQgPSAhMTsKICAgICAgICAgICAgfSBlbHNlIFdFQl9TVE9SQUdFX1NVUFBPUlQgPSAhMTsKICAgICAgICB9CiAgICB9KSwgU2F2ZWREYXRhLnJlbW92ZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBXRUJfU1RPUkFHRV9TVVBQT1JUID8gKGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKG5hbWUpLCBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKG5hbWUpKSA6IFNhdmVkRGF0YS53cml0ZShuYW1lLCAiIiwgRVJBU0VfQ09PS0lFKTsKICAgIH0sIFNhdmVkRGF0YS53cml0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCB0ZW1wT25seSkgewogICAgICAgIGlmIChXRUJfU1RPUkFHRV9TVVBQT1JUKSB0ZW1wT25seSA/IHNlc3Npb25TdG9yYWdlLnNldEl0ZW0obmFtZSwgSlNPTi5zdHJpbmdpZnkodmFsdWUpKSA6IGxvY2FsU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7IGVsc2UgewogICAgICAgICAgICB2YXIgZXhwaXJlczsKICAgICAgICAgICAgZXhwaXJlcyA9IHRlbXBPbmx5ID8gdGVtcE9ubHkgIT09IEVSQVNFX0NPT0tJRSA/ICIiIDogIjsgZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCIgOiAiOyBleHBpcmVzPSIgKyBuZXcgRGF0ZSgyMTQ3NDgzNjQ2ZTMpLnRvR01UU3RyaW5nKCksIAogICAgICAgICAgICBkb2N1bWVudC5jb29raWUgPSBuYW1lICsgIj0iICsgZXNjYXBlKEpTT04uc3RyaW5naWZ5KHZhbHVlKSkgKyBleHBpcmVzICsgIjsgcGF0aD0vIjsKICAgICAgICB9CiAgICB9LCBTYXZlZERhdGEucmVhZCA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBpZiAoV0VCX1NUT1JBR0VfU1VQUE9SVCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShuYW1lKSB8fCBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKG5hbWUpOwogICAgICAgICAgICByZXR1cm4gdmFsdWUgPyBKU09OLnBhcnNlKHZhbHVlKSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBjLCBuYW1lRVEgPSBuYW1lICsgIj0iLCBjYSA9IGRvY3VtZW50LmNvb2tpZS5zcGxpdCgiOyIpLCBpID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY2EubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgZm9yIChjID0gY2FbaV07ICIgIiA9PSBjLmNoYXJBdCgwKTsgKSBjID0gYy5zdWJzdHJpbmcoMSwgYy5sZW5ndGgpOwogICAgICAgICAgICBpZiAoMCA9PT0gYy5pbmRleE9mKG5hbWVFUSkpIHJldHVybiBKU09OLnBhcnNlKHVuZXNjYXBlKGMuc3Vic3RyaW5nKG5hbWVFUS5sZW5ndGgsIGMubGVuZ3RoKSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5TYXZlZERhdGEgPSBTYXZlZERhdGE7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB3aW5kb3cuVVJMID0gd2luZG93LlVSTCB8fCB3aW5kb3cud2Via2l0VVJMLCB3aW5kb3cuQmxvYkJ1aWxkZXIgPSB3aW5kb3cuQmxvYkJ1aWxkZXIgfHwgd2luZG93LldlYktpdEJsb2JCdWlsZGVyIHx8IHdpbmRvdy5Nb3pCbG9iQnVpbGRlcjsKICAgIHZhciBXb3JrZXIgPSB7fTsKICAgIFdvcmtlci5pbml0ID0gZnVuY3Rpb24oY29kZVN0cmluZykgewogICAgICAgIGlmICghd2luZG93LlVSTCB8fCAhd2luZG93LldvcmtlcikgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKICAgICAgICB2YXIgYmxvYjsKICAgICAgICB0cnkgewogICAgICAgICAgICBibG9iID0gbmV3IEJsb2IoWyBjb2RlU3RyaW5nIF0sIHsKICAgICAgICAgICAgICAgIHR5cGU6ICJhcHBsaWNhdGlvbi9qYXZhc2NyaXB0IgogICAgICAgICAgICB9KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGlmICghd2luZG93LkJsb2JCdWlsZGVyKSByZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYmxvYiA9IG5ldyBCbG9iQnVpbGRlcigpLCBibG9iLmFwcGVuZChjb2RlU3RyaW5nKSwgYmxvYiA9IGJsb2IuZ2V0QmxvYigpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWJsb2IpIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIHdvcmtlciA9IG5ldyBXb3JrZXIoVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKSk7CiAgICAgICAgICAgIHJldHVybiB3b3JrZXI7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwogICAgICAgIH0KICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5jcmVhdGVXb3JrZXIgPSBXb3JrZXIuaW5pdCwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLldvcmtlciA9IFdvcmtlcjsKICAgIHZhciBTdWJXb3JrZXIgPSBmdW5jdGlvbihjb2RlU3RyaW5nLCBwYXJlbnQpIHsKICAgICAgICB0aGlzLl93UGFyZW50ID0gcGFyZW50LCBldmFsKGNvZGVTdHJpbmcpOwogICAgfSwgcCA9IFN1Yldvcmtlci5wcm90b3R5cGU7CiAgICBwLm9ubWVzc2FnZSA9IG51bGwsIHAuX3dQYXJlbnQgPSBudWxsLCBwLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLl93UGFyZW50OwogICAgICAgIHNldFRpbWVvdXQocGFyZW50Lm9ubWVzc2FnZS5iaW5kKHBhcmVudCwgewogICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgfSksIDEpOwogICAgfTsKICAgIHZhciBGYWxsYmFja1dvcmtlciA9IGZ1bmN0aW9uKGNvZGVTdHJpbmcpIHsKICAgICAgICB0aGlzLl93Q2hpbGQgPSBuZXcgU3ViV29ya2VyKGNvZGVTdHJpbmcsIHRoaXMpOwogICAgfTsKICAgIHAgPSBGYWxsYmFja1dvcmtlci5wcm90b3R5cGUsIHAucG9zdE1lc3NhZ2UgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgdmFyIGNoaWxkID0gdGhpcy5fd0NoaWxkOwogICAgICAgIHNldFRpbWVvdXQoY2hpbGQub25tZXNzYWdlLmJpbmQoY2hpbGQsIHsKICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgIH0pLCAxKTsKICAgIH0sIHAudGVybWluYXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5vbm1lc3NhZ2UgPSBudWxsOwogICAgICAgIHZhciBjaGlsZCA9IHRoaXMuX3dDaGlsZDsKICAgICAgICBjaGlsZC5fd1BhcmVudCA9IG51bGwsIGNoaWxkLm9ubWVzc2FnZSA9IG51bGwsIHRoaXMuX3dDaGlsZCA9IG51bGw7CiAgICB9LCBwLm9ubWVzc2FnZSA9IG51bGwsIHAuX3dDaGlsZCA9IG51bGw7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgQ29tYmluZWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGwsIG9iaiwgcHJvcCwgY2FsbFByb3ApIHsKICAgICAgICBvYmpbcHJvcF0gPyBvYmpbY2FsbFByb3BdID0gY2FsbCA6IGNhbGwoKTsKICAgIH07CiAgICBDb21iaW5lZENhbGxiYWNrLmNyZWF0ZSA9IGZ1bmN0aW9uKGNhbGwsIG9iaiwgcHJvcCwgY2FsbFByb3ApIHsKICAgICAgICByZXR1cm4gQ29tYmluZWRDYWxsYmFjay5iaW5kKHRoaXMsIGNhbGwsIG9iaiwgcHJvcCwgY2FsbFByb3ApOwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLkNvbWJpbmVkQ2FsbGJhY2sgPSBDb21iaW5lZENhbGxiYWNrOwp9KCksIGZ1bmN0aW9uKHVuZGVmaW5lZCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIE5FWFRfSUQgPSAwLCBEZWxheWVkQ2FsbCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZWxheSwgcmVwZWF0LCBhdXRvRGVzdHJveSkgewogICAgICAgIHRoaXMuX2NhbGxiYWNrID0gY2FsbGJhY2ssIHRoaXMuX2RlbGF5ID0gZGVsYXksIHRoaXMuX3RpbWVyID0gZGVsYXksIHRoaXMuX3JlcGVhdCA9ICEhcmVwZWF0LCAKICAgICAgICB0aGlzLl9hdXRvRGVzdHJveSA9IGF1dG9EZXN0cm95ID09PSB1bmRlZmluZWQgPyAhMCA6ICEhYXV0b0Rlc3Ryb3ksIHRoaXMuX3VwZGF0ZUlkID0gIkRlbGF5ZWRDYWxsIyIgKyArK05FWFRfSUQsIAogICAgICAgIHRoaXMuX3BhdXNlZCA9ICExLCB0aGlzLl91cGRhdGUgPSB0aGlzLl91cGRhdGUuYmluZCh0aGlzKSwgY2xvdWRraWQuT1MuaW5zdGFuY2UuYWRkVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQsIHRoaXMuX3VwZGF0ZSk7CiAgICB9LCBwID0gRGVsYXllZENhbGwucHJvdG90eXBlOwogICAgcC5fdXBkYXRlID0gZnVuY3Rpb24oZWxhcHNlZCkgewogICAgICAgIHJldHVybiB0aGlzLl9jYWxsYmFjayA/ICh0aGlzLl90aW1lciAtPSBlbGFwc2VkLCB2b2lkICh0aGlzLl90aW1lciA8PSAwICYmICh0aGlzLl9jYWxsYmFjaygpLCAKICAgICAgICB0aGlzLl9yZXBlYXQgPyB0aGlzLl90aW1lciArPSB0aGlzLl9kZWxheSA6IHRoaXMuX2F1dG9EZXN0cm95ID8gdGhpcy5kZXN0cm95KCkgOiBjbG91ZGtpZC5PUy5pbnN0YW5jZS5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCkpKSkgOiB2b2lkIHRoaXMuZGVzdHJveSgpOwogICAgfSwgcC5yZXN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuX2NhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBvcyA9IGNsb3Vka2lkLk9TLmluc3RhbmNlOwogICAgICAgICAgICBvcy5hZGRVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCwgdGhpcy5fdXBkYXRlKSwgdGhpcy5fdGltZXIgPSB0aGlzLl9kZWxheSwgdGhpcy5fcGF1c2VkID0gITE7CiAgICAgICAgfQogICAgfSwgcC5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpLCB0aGlzLl9wYXVzZWQgPSAhMTsKICAgIH0sIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAicGF1c2VkIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXVzZWQ7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9jYWxsYmFjaykgewogICAgICAgICAgICAgICAgdmFyIG9zID0gY2xvdWRraWQuT1MuaW5zdGFuY2U7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXVzZWQgJiYgIXZhbHVlID8gKHRoaXMuX3BhdXNlZCA9ICExLCBvcy5oYXNVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCkgfHwgb3MuYWRkVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQsIHRoaXMuX3VwZGF0ZSkpIDogdmFsdWUgJiYgb3MuaGFzVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpICYmICh0aGlzLl9wYXVzZWQgPSAhMCwgCiAgICAgICAgICAgICAgICBvcy5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNsb3Vka2lkLk9TLmluc3RhbmNlLnJlbW92ZVVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSwgdGhpcy5fY2FsbGJhY2sgPSBudWxsOwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLkRlbGF5ZWRDYWxsID0gRGVsYXllZENhbGw7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgcCwgQXBwbGljYXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCh0aGlzKTsKICAgIH07CiAgICBwID0gQXBwbGljYXRpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKSwgCiAgICBwLmluaXQgPSBmdW5jdGlvbigpIHt9LCBwLnVwZGF0ZSA9IGZ1bmN0aW9uKCkge30sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkge30sIHAucmVzaXplID0gZnVuY3Rpb24oKSB7fSwgCiAgICBuYW1lc3BhY2UoImNsb3Vka2lkIikuQXBwbGljYXRpb24gPSBBcHBsaWNhdGlvbjsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBMb2FkZXJRdWV1ZUl0ZW0gPSBmdW5jdGlvbigpIHt9LCBwID0gTG9hZGVyUXVldWVJdGVtLnByb3RvdHlwZTsKICAgIExvYWRlclF1ZXVlSXRlbS5QUklPUklUWV9ISUdIID0gMSwgTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX05PUk1BTCA9IDAsIExvYWRlclF1ZXVlSXRlbS5QUklPUklUWV9MT1cgPSAtMSwgCiAgICBwLnVybCA9IG51bGwsIHAuZGF0YSA9IG51bGwsIHAuY2FsbGJhY2sgPSBudWxsLCBwLnByaW9yaXR5ID0gMCwgcC5wcm9ncmVzcyA9IDAsIAogICAgcC51cGRhdGVDYWxsYmFjayA9IG51bGwsIHAuX2JvdW5kRmFpbCA9IG51bGwsIHAuX2JvdW5kUHJvZ3Jlc3MgPSBudWxsLCBwLl9ib3VuZENvbXBsZXRlID0gbnVsbCwgCiAgICBwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICJbTG9hZGVyUXVldWVJdGVtKHVybDonIiArIHRoaXMudXJsICsgIicsIHByaW9yaXR5OiIgKyB0aGlzLnByaW9yaXR5ICsgIildIjsKICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuY2FsbGJhY2sgPSBudWxsLCB0aGlzLnVwZGF0ZUNhbGxiYWNrID0gbnVsbCwgdGhpcy5kYXRhID0gbnVsbCwgdGhpcy5fYm91bmRGYWlsID0gbnVsbCwgCiAgICAgICAgdGhpcy5fYm91bmRQcm9ncmVzcyA9IG51bGwsIHRoaXMuX2JvdW5kQ29tcGxldGUgPSBudWxsOwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLkxvYWRlclF1ZXVlSXRlbSA9IExvYWRlclF1ZXVlSXRlbTsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBNZWRpYUxvYWRlciA9IGZ1bmN0aW9uKCkge30sIHAgPSBNZWRpYUxvYWRlci5wcm90b3R5cGU7CiAgICBNZWRpYUxvYWRlci5faW5zdGFuY2UgPSBudWxsOwogICAgdmFyIHF1ZXVlID0gbnVsbCwgcXVldWVJdGVtcyA9IG51bGwsIGxvYWRlcnMgPSBudWxsLCBxaVBvb2wgPSBudWxsLCBsb2FkZXJQb29sID0gbnVsbCwgcmVzdWx0UG9vbCA9IG51bGwsIG51bUxvYWRzID0gMCwgcmV0cmllcyA9IG51bGw7CiAgICBwLl9jYW5Mb2FkID0gITAsIHAubWF4U2ltdWx0YW5lb3VzTG9hZHMgPSAyLCBwLmNhY2hlTWFuYWdlciA9IG51bGwsIE1lZGlhTG9hZGVyLmluaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gTWVkaWFMb2FkZXIuX2luc3RhbmNlIHx8IChNZWRpYUxvYWRlci5faW5zdGFuY2UgPSBuZXcgTWVkaWFMb2FkZXIoKSwgTWVkaWFMb2FkZXIuX2luc3RhbmNlLl9pbml0aWFsaXplKCkpLCAKICAgICAgICBNZWRpYUxvYWRlci5faW5zdGFuY2U7CiAgICB9LCBPYmplY3QuZGVmaW5lUHJvcGVydHkoTWVkaWFMb2FkZXIsICJpbnN0YW5jZSIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIU1lZGlhTG9hZGVyLl9pbnN0YW5jZSkgdGhyb3cgIkNhbGwgY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5pdCgpIjsKICAgICAgICAgICAgcmV0dXJuIE1lZGlhTG9hZGVyLl9pbnN0YW5jZTsKICAgICAgICB9CiAgICB9KSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGksIGxlbiwga2V5LCBhcnIgPSB0aGlzLnF1ZXVlOwogICAgICAgIGlmIChhcnIpIHsKICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA+IGk7ICsraSkgYXJyW2ldLmRlc3Ryb3koKTsKICAgICAgICAgICAgZm9yIChhcnIgPSBxaVBvb2wsIGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpID4gaTsgKytpKSBhcnJbaV0uZGVzdHJveSgpOwogICAgICAgICAgICBmb3IgKGFyciA9IHJlc3VsdFBvb2wsIGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpID4gaTsgKytpKSBhcnJbaV0uZGVzdHJveSgpOwogICAgICAgICAgICBmb3IgKGtleSBpbiBsb2FkZXJzKSBxdWV1ZUl0ZW1zW2tleV0uZGVzdHJveSgpLCBsb2FkZXJzW2tleV0uY2xvc2UoKTsKICAgICAgICB9CiAgICAgICAgTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbCwgdGhpcy5jYWNoZU1hbmFnZXIgJiYgdGhpcy5jYWNoZU1hbmFnZXIuZGVzdHJveSgpLCAKICAgICAgICB0aGlzLmNhY2hlTWFuYWdlciA9IG51bGwsIHF1ZXVlID0gbnVsbCwgcmVzdWx0UG9vbCA9IG51bGwsIGxvYWRlclBvb2wgPSBudWxsLCBxaVBvb2wgPSBudWxsLCAKICAgICAgICBxdWV1ZUl0ZW1zID0gbnVsbCwgcmV0cmllcyA9IG51bGwsIGxvYWRlcnMgPSBudWxsOwogICAgfSwgcC5faW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHFpUG9vbCA9IFtdLCBsb2FkZXJQb29sID0gW10sIHJlc3VsdFBvb2wgPSBbXSwgcXVldWUgPSBbXSwgcXVldWVJdGVtcyA9IHt9LCBsb2FkZXJzID0ge30sIAogICAgICAgIHJldHJpZXMgPSB7fSwgdGhpcy5jYWNoZU1hbmFnZXIgPSBuZXcgY2xvdWRraWQuQ2FjaGVNYW5hZ2VyKCk7CiAgICB9LCBwLmxvYWQgPSBmdW5jdGlvbih1cmwsIGNhbGxiYWNrLCB1cGRhdGVDYWxsYmFjaywgcHJpb3JpdHksIGRhdGEpIHsKICAgICAgICB2YXIgcWkgPSB0aGlzLl9nZXRRSSgpLCBiYXNlUGF0aCA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLm9wdGlvbnMuYmFzZVBhdGg7CiAgICAgICAgdm9pZCAwICE9PSBiYXNlUGF0aCAmJiAvXmh0dHAocyk/XDovLnRlc3QodXJsKSA9PT0gITEgJiYgLTEgPT0gdXJsLnNlYXJjaChiYXNlUGF0aCkgJiYgKHFpLmJhc2VQYXRoID0gYmFzZVBhdGgpLCAKICAgICAgICBxaS51cmwgPSB1cmwsIHFpLmNhbGxiYWNrID0gY2FsbGJhY2ssIHFpLnVwZGF0ZUNhbGxiYWNrID0gdXBkYXRlQ2FsbGJhY2sgfHwgbnVsbCwgCiAgICAgICAgcWkucHJpb3JpdHkgPSBwcmlvcml0eSB8fCBjbG91ZGtpZC5Mb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMLCBxaS5kYXRhID0gZGF0YSB8fCBudWxsLCAKICAgICAgICBxdWV1ZS5wdXNoKHFpKSwgcXVldWUuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhLnByaW9yaXR5IC0gYi5wcmlvcml0eTsKICAgICAgICB9KSwgdGhpcy5fdHJ5TmV4dExvYWQoKTsKICAgIH0sIHAuX29uTG9hZEZhaWxlZCA9IGZ1bmN0aW9uKHFpLCBldmVudCkgewogICAgICAgIERlYnVnLmVycm9yKCJVbmFibGUgdG8gbG9hZCBmaWxlOiAiICsgcWkudXJsICsgIiAtIHJlYXNvbjogIiArIGV2ZW50LmVycm9yKTsKICAgICAgICB2YXIgbG9hZGVyID0gbG9hZGVyc1txaS51cmxdOwogICAgICAgIGxvYWRlci5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpLCBsb2FkZXIuY2xvc2UoKSwgdGhpcy5fcG9vbExvYWRlcihsb2FkZXIpLCBkZWxldGUgcXVldWVJdGVtc1txaS51cmxdLCAKICAgICAgICBkZWxldGUgbG9hZGVyc1txaS51cmxdLCByZXRyaWVzW3FpLnVybF0gPyByZXRyaWVzW3FpLnVybF0rKyA6IHJldHJpZXNbcWkudXJsXSA9IDEsIAogICAgICAgIHJldHJpZXNbcWkudXJsXSA+IDMgPyB0aGlzLl9sb2FkRG9uZShxaSwgbnVsbCkgOiAobnVtTG9hZHMtLSwgcXVldWUucHVzaChxaSksIHRoaXMuX3RyeU5leHRMb2FkKCkpOwogICAgfSwgcC5fb25Mb2FkUHJvZ3Jlc3MgPSBmdW5jdGlvbihxaSwgZXZlbnQpIHsKICAgICAgICBxaS5wcm9ncmVzcyA9IGV2ZW50LnByb2dyZXNzLCBxaS51cGRhdGVDYWxsYmFjayAmJiBxaS51cGRhdGVDYWxsYmFjayhxaS5wcm9ncmVzcyk7CiAgICB9LCBwLl9vbkxvYWRDb21wbGV0ZWQgPSBmdW5jdGlvbihxaSwgZXYpIHsKICAgICAgICBEZWJ1Zy5sb2coIkZpbGUgbG9hZGVkIHN1Y2Nlc3NmdWxseSBmcm9tICIgKyBxaS51cmwpOwogICAgICAgIHZhciBsb2FkZXIgPSBsb2FkZXJzW3FpLnVybF07CiAgICAgICAgbG9hZGVyLnJlbW92ZUFsbEV2ZW50TGlzdGVuZXJzKCksIGxvYWRlci5jbG9zZSgpLCB0aGlzLl9wb29sTG9hZGVyKGxvYWRlciksIGRlbGV0ZSBxdWV1ZUl0ZW1zW3FpLnVybF0sIAogICAgICAgIGRlbGV0ZSBsb2FkZXJzW3FpLnVybF0sIHRoaXMuX2xvYWREb25lKHFpLCB0aGlzLl9nZXRSZXN1bHQoZXYucmVzdWx0LCBxaS51cmwsIGxvYWRlcikpOwogICAgfSwgcC5fdHJ5TmV4dExvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIShudW1Mb2FkcyA+IHRoaXMubWF4U2ltdWx0YW5lb3VzTG9hZHMgLSAxIHx8IDAgPT09IHF1ZXVlLmxlbmd0aCkpIHsKICAgICAgICAgICAgbnVtTG9hZHMrKzsKICAgICAgICAgICAgdmFyIHFpID0gcXVldWUuc2hpZnQoKTsKICAgICAgICAgICAgRGVidWcubG9nKCJBdHRlbXB0aW5nIHRvIGxvYWQgZmlsZSAnIiArIHFpLnVybCArICInIiksIHF1ZXVlSXRlbXNbcWkudXJsXSA9IHFpOwogICAgICAgICAgICB2YXIgbG9hZGVyID0gdGhpcy5fZ2V0TG9hZGVyKHFpLmJhc2VQYXRoKTsKICAgICAgICAgICAgbG9hZGVyc1txaS51cmxdID0gbG9hZGVyLCBsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZmlsZWxvYWQiLCBxaS5fYm91bmRDb21wbGV0ZSksIAogICAgICAgICAgICBsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBxaS5fYm91bmRGYWlsKSwgbG9hZGVyLmFkZEV2ZW50TGlzdGVuZXIoImZpbGVwcm9ncmVzcyIsIHFpLl9ib3VuZFByb2dyZXNzKTsKICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMuY2FjaGVNYW5hZ2VyLnByZXBhcmUocWkudXJsKTsKICAgICAgICAgICAgbG9hZGVyLmxvYWRGaWxlKHFpLmRhdGEgPyB7CiAgICAgICAgICAgICAgICBpZDogcWkuZGF0YS5pZCwKICAgICAgICAgICAgICAgIHNyYzogdXJsLAogICAgICAgICAgICAgICAgZGF0YTogcWkuZGF0YQogICAgICAgICAgICB9IDogdXJsKTsKICAgICAgICB9CiAgICB9LCBwLl9sb2FkRG9uZSA9IGZ1bmN0aW9uKHFpLCByZXN1bHQpIHsKICAgICAgICBudW1Mb2Fkcy0tLCBxaS5kYXRhICYmIHJlc3VsdCAmJiAocmVzdWx0LmlkID0gcWkuZGF0YS5pZCksIHFpLmNhbGxiYWNrKHJlc3VsdCksIAogICAgICAgIHRoaXMuX3Bvb2xRSShxaSksIHRoaXMuX3RyeU5leHRMb2FkKCk7CiAgICB9LCBwLmNhbmNlbCA9IGZ1bmN0aW9uKHVybCkgewogICAgICAgIHZhciBxaSA9IHF1ZXVlSXRlbXNbdXJsXSwgbG9hZGVyID0gbG9hZGVyc1t1cmxdOwogICAgICAgIGlmIChxaSAmJiBsb2FkZXIpIHJldHVybiBsb2FkZXIuY2xvc2UoKSwgZGVsZXRlIGxvYWRlcnNbdXJsXSwgZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXSwgCiAgICAgICAgbnVtTG9hZHMtLSwgdGhpcy5fcG9vbExvYWRlcihsb2FkZXIpLCB0aGlzLl9wb29sUUkocWkpLCAhMDsKICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBxdWV1ZS5sZW5ndGg7IGxlbiA+IGk7IGkrKykgaWYgKHFpID0gcXVldWVbaV0sIHFpLnVybCA9PSB1cmwpIHJldHVybiBxdWV1ZS5zcGxpY2UoaSwgMSksIAogICAgICAgIHRoaXMuX3Bvb2xRSShxaSksICEwOwogICAgICAgIHJldHVybiAhMTsKICAgIH0sIHAuX2dldFFJID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJ0bjsKICAgICAgICByZXR1cm4gcWlQb29sLmxlbmd0aCA/IHJ0biA9IHFpUG9vbC5wb3AoKSA6IChydG4gPSBuZXcgY2xvdWRraWQuTG9hZGVyUXVldWVJdGVtKCksIAogICAgICAgIHJ0bi5fYm91bmRGYWlsID0gdGhpcy5fb25Mb2FkRmFpbGVkLmJpbmQodGhpcywgcnRuKSwgcnRuLl9ib3VuZFByb2dyZXNzID0gdGhpcy5fb25Mb2FkUHJvZ3Jlc3MuYmluZCh0aGlzLCBydG4pLCAKICAgICAgICBydG4uX2JvdW5kQ29tcGxldGUgPSB0aGlzLl9vbkxvYWRDb21wbGV0ZWQuYmluZCh0aGlzLCBydG4pKSwgcnRuOwogICAgfSwgcC5fcG9vbFFJID0gZnVuY3Rpb24ocWkpIHsKICAgICAgICBxaVBvb2wucHVzaChxaSksIHFpLmNhbGxiYWNrID0gcWkudXBkYXRlQ2FsbGJhY2sgPSBxaS5kYXRhID0gcWkudXJsID0gbnVsbCwgcWkucHJvZ3Jlc3MgPSAwOwogICAgfSwgcC5fZ2V0TG9hZGVyID0gZnVuY3Rpb24oYmFzZVBhdGgpIHsKICAgICAgICB2YXIgcnRuOwogICAgICAgIHJldHVybiBsb2FkZXJQb29sLmxlbmd0aCA/IChydG4gPSBsb2FkZXJQb29sLnBvcCgpLCBydG4uX2Jhc2VQYXRoID0gYmFzZVBhdGgpIDogcnRuID0gbmV3IGNyZWF0ZWpzLkxvYWRRdWV1ZSghMCwgYmFzZVBhdGgpLCAKICAgICAgICBjcmVhdGVqcy5Tb3VuZCAmJiBydG4uaW5zdGFsbFBsdWdpbihjcmVhdGVqcy5Tb3VuZCksIHJ0bjsKICAgIH0sIHAuX3Bvb2xMb2FkZXIgPSBmdW5jdGlvbihsb2FkZXIpIHsKICAgICAgICBsb2FkZXIucmVtb3ZlQWxsKCksIGxvYWRlclBvb2wucHVzaChsb2FkZXIpOwogICAgfSwgcC5fZ2V0UmVzdWx0ID0gZnVuY3Rpb24ocmVzdWx0LCB1cmwsIGxvYWRlcikgewogICAgICAgIHZhciBydG47CiAgICAgICAgcmV0dXJuIHJlc3VsdFBvb2wubGVuZ3RoID8gKHJ0biA9IHJlc3VsdFBvb2wucG9wKCksIHJ0bi5jb250ZW50ID0gcmVzdWx0LCBydG4udXJsID0gdXJsLCAKICAgICAgICBydG4ubG9hZGVyID0gbG9hZGVyKSA6IHJ0biA9IG5ldyBjbG91ZGtpZC5NZWRpYUxvYWRlclJlc3VsdChyZXN1bHQsIHVybCwgbG9hZGVyKSwgCiAgICAgICAgcnRuOwogICAgfSwgcC5fcG9vbFJlc3VsdCA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJlc3VsdC5jb250ZW50ID0gcmVzdWx0LnVybCA9IHJlc3VsdC5sb2FkZXIgPSByZXN1bHQuaWQgPSBudWxsLCByZXN1bHRQb29sLnB1c2gocmVzdWx0KTsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5NZWRpYUxvYWRlciA9IE1lZGlhTG9hZGVyOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIE1lZGlhTG9hZGVyUmVzdWx0ID0gZnVuY3Rpb24oY29udGVudCwgdXJsLCBsb2FkZXIpIHsKICAgICAgICB0aGlzLmNvbnRlbnQgPSBjb250ZW50LCB0aGlzLnVybCA9IHVybCwgdGhpcy5sb2FkZXIgPSBsb2FkZXI7CiAgICB9LCBwID0gTWVkaWFMb2FkZXJSZXN1bHQucHJvdG90eXBlOwogICAgcC5jb250ZW50ID0gbnVsbCwgcC51cmwgPSBudWxsLCBwLmxvYWRlciA9IG51bGwsIHAudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gIltNZWRpYUxvYWRlclJlc3VsdCgnIiArIHRoaXMudXJsICsgIicpXSI7CiAgICB9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmNhbGxiYWNrID0gbnVsbCwgdGhpcy51cmwgPSBudWxsLCB0aGlzLmNvbnRlbnQgPSBudWxsOwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLk1lZGlhTG9hZGVyUmVzdWx0ID0gTWVkaWFMb2FkZXJSZXN1bHQ7Cn0oKSwgZnVuY3Rpb24odW5kZWZpbmVkKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgQ2FjaGVNYW5hZ2VyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5pbml0aWFsaXplKCk7CiAgICB9LCBwID0gQ2FjaGVNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwogICAgcC5fdmVyc2lvbnMgPSBudWxsLCBwLmNhY2hlQnVzdCA9ICExLCBwLmluaXRpYWxpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl92ZXJzaW9ucyA9IFtdOwogICAgICAgIHZhciBjYiA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLm9wdGlvbnMuY2FjaGVCdXN0OwogICAgICAgIHRoaXMuY2FjaGVCdXN0ID0gY2IgPyAidHJ1ZSIgPT09IGNiIHx8IGNiID09PSAhMCA6ICExLCB0aGlzLmNhY2hlQnVzdCAmJiBEZWJ1Zy5sb2coIkNhY2hlQnVzdCBhbGwgZmlsZXMgaXMgb24uIik7CiAgICB9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl92ZXJzaW9ucyA9IG51bGw7CiAgICB9LCBwLmFkZFZlcnNpb25zRmlsZSA9IGZ1bmN0aW9uKHVybCwgY2FsbGJhY2ssIGJhc2VVcmwpIHsKICAgICAgICBEZWJ1Zy5hc3NlcnQoL14uKlwudHh0JC8udGVzdCh1cmwpLCAiVGhlIHZlcnNpb25zIGZpbGUgbXVzdCBiZSBhICoudHh0IGZpbGUiKTsKICAgICAgICB2YXIgbWwgPSBjbG91ZGtpZC5NZWRpYUxvYWRlci5pbnN0YW5jZTsKICAgICAgICBpZiAodGhpcy5jYWNoZUJ1c3QpIHJldHVybiB2b2lkIChjYWxsYmFjayAmJiBjYWxsYmFjaygpKTsKICAgICAgICB0aGlzLmFkZFZlcnNpb24odXJsLCBNYXRoLnJvdW5kKDFlNSAqIE1hdGgucmFuZG9tKCkpKTsKICAgICAgICB2YXIgY20gPSB0aGlzOwogICAgICAgIG1sLmxvYWQodXJsLCBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQuY29udGVudCkgewogICAgICAgICAgICAgICAgdmFyIGksIHBhcnRzLCBsaW5lcyA9IHJlc3VsdC5jb250ZW50LnJlcGxhY2UoL1xyL2csICIiKS5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykgbGluZXNbaV0gJiYgKHBhcnRzID0gbGluZXNbaV0uc3BsaXQoIiAiKSwgMiA9PSBwYXJ0cy5sZW5ndGggJiYgY20uYWRkVmVyc2lvbigoYmFzZVVybCB8fCAiIikgKyBwYXJ0c1swXSwgcGFydHNbMV0pKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgfSwgcC5hZGRWZXJzaW9uID0gZnVuY3Rpb24odXJsLCB2ZXJzaW9uKSB7CiAgICAgICAgdmFyIHZlciA9IHRoaXMuX2dldFZlcnNpb25CeVVybCh1cmwpOwogICAgICAgIHZlciB8fCB0aGlzLl92ZXJzaW9ucy5wdXNoKHsKICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgIHZlcnNpb246IHZlcnNpb24KICAgICAgICB9KTsKICAgIH0sIHAuX2dldFZlcnNpb25CeVVybCA9IGZ1bmN0aW9uKHVybCkgewogICAgICAgIHZhciBpLCBsZW4gPSB0aGlzLl92ZXJzaW9ucy5sZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgbGVuID4gaTsgaSsrKSBpZiAodXJsID09IHRoaXMuX3ZlcnNpb25zW2ldLnVybCkgcmV0dXJuIHRoaXMuX3ZlcnNpb25zW2ldOwogICAgICAgIHJldHVybiBudWxsOwogICAgfSwgcC5wcmVwYXJlID0gZnVuY3Rpb24odXJsLCBhcHBseUJhc2VQYXRoKSB7CiAgICAgICAgdmFyIHZlciA9IHRoaXMuX2dldFZlcnNpb25CeVVybCh1cmwpOwogICAgICAgIGlmICh0aGlzLmNhY2hlQnVzdCAmJiAvKFw/fFwmKWNiXD1bMC05XSovLnRlc3QodXJsKSA9PT0gITEgPyAodGhpcy5fY2JWYWwgfHwgKHRoaXMuX2NiVmFsID0gbmV3IERhdGUoKS5nZXRUaW1lKCkudG9TdHJpbmcoKSksIAogICAgICAgIHVybCA9IHVybCArICh1cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyAiY2I9IiArIHRoaXMuX2NiVmFsKSA6IHZlciAmJiAvKFw/fFwmKXZcPVswLTldKi8udGVzdCh1cmwpID09PSAhMSAmJiAodXJsID0gdXJsICsgKHVybC5pbmRleE9mKCI/IikgPCAwID8gIj8iIDogIiYiKSArICJ2PSIgKyB2ZXIudmVyc2lvbiksIAogICAgICAgIGFwcGx5QmFzZVBhdGgpIHsKICAgICAgICAgICAgdmFyIGJhc2VQYXRoID0gY2xvdWRraWQuT1MuaW5zdGFuY2Uub3B0aW9ucy5iYXNlUGF0aDsKICAgICAgICAgICAgL15odHRwKHMpP1w6Ly50ZXN0KHVybCkgPT09ICExICYmIGJhc2VQYXRoICE9PSB1bmRlZmluZWQgJiYgLTEgPT0gdXJsLnNlYXJjaChiYXNlUGF0aCkgJiYgKHVybCA9IGJhc2VQYXRoICsgdXJsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVybDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5DYWNoZU1hbmFnZXIgPSBDYWNoZU1hbmFnZXI7Cn0oKSwgZnVuY3Rpb24odW5kZWZpbmVkKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBmdW5jdGlvbiBjbG9uZShvYmopIHsKICAgICAgICBpZiAoIW9iaiB8fCAib2JqZWN0IiAhPSB0eXBlb2Ygb2JqKSByZXR1cm4gbnVsbDsKICAgICAgICB2YXIgY29weSA9IG9iai5jb25zdHJ1Y3RvcigpOwogICAgICAgIGZvciAodmFyIGF0dHIgaW4gb2JqKSBvYmouaGFzT3duUHJvcGVydHkoYXR0cikgJiYgKGNvcHlbYXR0cl0gPSBvYmpbYXR0cl0pOwogICAgICAgIHJldHVybiBjb3B5OwogICAgfQogICAgZnVuY3Rpb24gZG9PYmplY3RzTWF0Y2gob2JqMSwgb2JqMikgewogICAgICAgIGlmIChvYmoxID09PSBvYmoyKSByZXR1cm4gITA7CiAgICAgICAgZm9yICh2YXIga2V5IGluIG9iajEpIGlmIChvYmoxW2tleV0gIT0gb2JqMltrZXldKSByZXR1cm4gITE7CiAgICAgICAgcmV0dXJuICEwOwogICAgfQogICAgdmFyIEJ1dHRvbiA9IGZ1bmN0aW9uKGltYWdlU2V0dGluZ3MsIGxhYmVsLCBlbmFibGVkKSB7CiAgICAgICAgaW1hZ2VTZXR0aW5ncyAmJiAoUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwodGhpcyksIHRoaXMuaW5pdGlhbGl6ZShpbWFnZVNldHRpbmdzLCBsYWJlbCwgZW5hYmxlZCkpOwogICAgfSwgcCA9IEJ1dHRvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUpOwogICAgcC5iYWNrID0gbnVsbCwgcC5sYWJlbCA9IG51bGwsIHAucmVsZWFzZUNhbGxiYWNrID0gbnVsbCwgcC5vdmVyQ2FsbGJhY2sgPSBudWxsLCAKICAgIHAub3V0Q2FsbGJhY2sgPSBudWxsLCBwLl9zdGF0ZUZsYWdzID0gbnVsbCwgcC5fc3RhdGVQcmlvcml0eSA9IG51bGwsIHAuX3N0YXRlRGF0YSA9IG51bGwsIAogICAgcC5fY3VycmVudExhYmVsU3R5bGUgPSBudWxsLCBwLl9vZmZzZXQgPSBudWxsLCBwLl9vdmVyQ0IgPSBudWxsLCBwLl9vdXRDQiA9IG51bGwsIAogICAgcC5fZG93bkNCID0gbnVsbCwgcC5fdXBDQiA9IG51bGwsIHAuX3VwT3V0Q0IgPSBudWxsLCBwLl93aWR0aCA9IDAsIHAuX2hlaWdodCA9IDA7CiAgICB2YXIgUkVTRVJWRURfU1RBVEVTID0gWyAiZGlzYWJsZWQiLCAiZW5hYmxlZCIsICJ1cCIsICJvdmVyIiwgImRvd24iIF0sIERFRkFVTFRfUFJJT1JJVFkgPSBbICJkaXNhYmxlZCIsICJkb3duIiwgIm92ZXIiLCAidXAiIF07CiAgICBwLmluaXRpYWxpemUgPSBmdW5jdGlvbihpbWFnZVNldHRpbmdzLCBsYWJlbCwgZW5hYmxlZCkgewogICAgICAgIHRoaXMuYmFjayA9IG5ldyBQSVhJLlNwcml0ZShpbWFnZVNldHRpbmdzLnVwKSwgdGhpcy5hZGRDaGlsZCh0aGlzLmJhY2spLCB0aGlzLl9vdmVyQ0IgPSB0aGlzLl9vbk92ZXIuYmluZCh0aGlzKSwgCiAgICAgICAgdGhpcy5fb3V0Q0IgPSB0aGlzLl9vbk91dC5iaW5kKHRoaXMpLCB0aGlzLl9kb3duQ0IgPSB0aGlzLl9vbkRvd24uYmluZCh0aGlzKSwgdGhpcy5fdXBDQiA9IHRoaXMuX29uVXAuYmluZCh0aGlzKSwgCiAgICAgICAgdGhpcy5fdXBPdXRDQiA9IHRoaXMuX29uVXBPdXRzaWRlLmJpbmQodGhpcyk7CiAgICAgICAgdmFyIF9zdGF0ZURhdGEgPSB0aGlzLl9zdGF0ZURhdGEgPSB7fTsKICAgICAgICB0aGlzLl9zdGF0ZUZsYWdzID0ge30sIHRoaXMuX29mZnNldCA9IG5ldyBQSVhJLlBvaW50KCk7CiAgICAgICAgdmFyIGxhYmVsRGF0YTsKICAgICAgICBpZiAobGFiZWwpIHsKICAgICAgICAgICAgbGFiZWxEYXRhID0gY2xvbmUobGFiZWwpLCBkZWxldGUgbGFiZWxEYXRhLnRleHQsIGRlbGV0ZSBsYWJlbERhdGEudHlwZSwgbGFiZWxEYXRhLnggPT09IHVuZGVmaW5lZCAmJiAobGFiZWxEYXRhLnggPSAiY2VudGVyIiksIAogICAgICAgICAgICBsYWJlbERhdGEueSA9PT0gdW5kZWZpbmVkICYmIChsYWJlbERhdGEueSA9ICJjZW50ZXIiKTsKICAgICAgICAgICAgdmFyIHN0eWxlID0gbGFiZWxEYXRhLnN0eWxlID0gY2xvbmUobGFiZWwuc3R5bGUpOwogICAgICAgICAgICAiYml0bWFwIiA9PSBsYWJlbC50eXBlID8gc3R5bGUuYWxpZ24gPSBzdHlsZS5hbGlnbiB8fCAibGVmdCIgOiAoc3R5bGUuZm9udCA9IHN0eWxlLmZvbnQgfHwgImJvbGQgMjBwdCBBcmlhbCIsIAogICAgICAgICAgICBzdHlsZS5maWxsID0gc3R5bGUuZmlsbCB8fCAiYmxhY2siLCBzdHlsZS5hbGlnbiA9IHN0eWxlLmFsaWduIHx8ICJsZWZ0Iiwgc3R5bGUuc3Ryb2tlID0gc3R5bGUuc3Ryb2tlIHx8ICJibGFjayIsIAogICAgICAgICAgICBzdHlsZS5zdHJva2VUaGlja25lc3MgPSBzdHlsZS5zdHJva2VUaGlja25lc3MgfHwgMCwgc3R5bGUud29yZFdyYXAgPSBzdHlsZS53b3JkV3JhcCB8fCAhMSwgCiAgICAgICAgICAgIHN0eWxlLndvcmRXcmFwV2lkdGggPSBzdHlsZS53b3JkV3JhcFdpZHRoIHx8IDEwMCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3N0YXRlUHJpb3JpdHkgPSBpbWFnZVNldHRpbmdzLnByaW9yaXR5IHx8IERFRkFVTFRfUFJJT1JJVFk7CiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX3N0YXRlUHJpb3JpdHkubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgICAgdmFyIHN0YXRlID0gdGhpcy5fc3RhdGVQcmlvcml0eVtpXTsKICAgICAgICAgICAgdGhpcy5fYWRkUHJvcGVydHkoc3RhdGUpLCAiZGlzYWJsZWQiICE9IHN0YXRlICYmICJ1cCIgIT0gc3RhdGUgJiYgKHRoaXMuX3N0YXRlRmxhZ3Nbc3RhdGVdID0gITEpOwogICAgICAgICAgICB2YXIgaW5wdXREYXRhID0gaW1hZ2VTZXR0aW5nc1tzdGF0ZV07CiAgICAgICAgICAgIGlmIChfc3RhdGVEYXRhW3N0YXRlXSA9IGlucHV0RGF0YSA/IGlucHV0RGF0YS50ZXggPyB7CiAgICAgICAgICAgICAgICB0ZXg6IGlucHV0RGF0YS50ZXgKICAgICAgICAgICAgfSA6IHsKICAgICAgICAgICAgICAgIHRleDogaW5wdXREYXRhCiAgICAgICAgICAgIH0gOiBfc3RhdGVEYXRhLnVwLCBsYWJlbCkgaWYgKGlucHV0RGF0YSAmJiBpbnB1dERhdGEubGFiZWwpIHsKICAgICAgICAgICAgICAgIGlucHV0RGF0YSA9IGlucHV0RGF0YS5sYWJlbDsKICAgICAgICAgICAgICAgIHZhciBzdGF0ZUxhYmVsID0gX3N0YXRlRGF0YVtzdGF0ZV0ubGFiZWwgPSB7fTsKICAgICAgICAgICAgICAgIHN0YXRlTGFiZWwuc3R5bGUgPSBpbnB1dERhdGEuc3R5bGUgfHwgbGFiZWxEYXRhLnN0eWxlLCBzdGF0ZUxhYmVsLnggPSBpbnB1dERhdGEueCB8fCBsYWJlbERhdGEueCwgCiAgICAgICAgICAgICAgICBzdGF0ZUxhYmVsLnkgPSBpbnB1dERhdGEueSB8fCBsYWJlbERhdGEueTsKICAgICAgICAgICAgfSBlbHNlIF9zdGF0ZURhdGFbc3RhdGVdLmxhYmVsID0gbGFiZWxEYXRhOwogICAgICAgIH0KICAgICAgICBpZiAoX3N0YXRlRGF0YS51cCB8fCAoRGVidWcuZXJyb3IoIkJ1dHRvbiBsYWNrcyBhbiB1cCBzdGF0ZSEgVGhpcyBpcyBhIHNlcmlvdXMgcHJvYmxlbSEgSW5wdXQgZGF0YSBmb2xsb3dzOiIpLCAKICAgICAgICBEZWJ1Zy5lcnJvcihpbWFnZVNldHRpbmdzKSksIF9zdGF0ZURhdGEub3ZlciB8fCAoX3N0YXRlRGF0YS5vdmVyID0gX3N0YXRlRGF0YS51cCksIAogICAgICAgIF9zdGF0ZURhdGEuZG93biB8fCAoX3N0YXRlRGF0YS5kb3duID0gX3N0YXRlRGF0YS51cCksIF9zdGF0ZURhdGEuZGlzYWJsZWQgfHwgKF9zdGF0ZURhdGEuZGlzYWJsZWQgPSBfc3RhdGVEYXRhLnVwKSwgCiAgICAgICAgaW1hZ2VTZXR0aW5ncy5vZmZzZXQgPyAodGhpcy5fb2Zmc2V0LnggPSBpbWFnZVNldHRpbmdzLm9mZnNldC54LCB0aGlzLl9vZmZzZXQueSA9IGltYWdlU2V0dGluZ3Mub2Zmc2V0LnkpIDogdGhpcy5fb2Zmc2V0LnggPSB0aGlzLl9vZmZzZXQueSA9IDAsIAogICAgICAgIGltYWdlU2V0dGluZ3Muc2NhbGUpIHsKICAgICAgICAgICAgdmFyIHMgPSBpbWFnZVNldHRpbmdzLnNjYWxlIHx8IDE7CiAgICAgICAgICAgIHRoaXMuYmFjay5zY2FsZS54ID0gdGhpcy5iYWNrLnNjYWxlLnkgPSBzOwogICAgICAgIH0KICAgICAgICBsYWJlbCAmJiAodGhpcy5sYWJlbCA9ICJiaXRtYXAiID09IGxhYmVsLnR5cGUgPyBuZXcgUElYSS5CaXRtYXBUZXh0KGxhYmVsLnRleHQsIGxhYmVsRGF0YS5zdHlsZSkgOiBuZXcgUElYSS5UZXh0KGxhYmVsLnRleHQsIGxhYmVsRGF0YS5zdHlsZSksIAogICAgICAgIHRoaXMuYWRkQ2hpbGQodGhpcy5sYWJlbCkpLCB0aGlzLmJhY2sueCA9IHRoaXMuX29mZnNldC54LCB0aGlzLmJhY2sueSA9IHRoaXMuX29mZnNldC55LCAKICAgICAgICB0aGlzLl93aWR0aCA9IHRoaXMuYmFjay53aWR0aCwgdGhpcy5faGVpZ2h0ID0gdGhpcy5iYWNrLmhlaWdodCwgdGhpcy5lbmFibGVkID0gZW5hYmxlZCA9PT0gdW5kZWZpbmVkID8gITAgOiAhIWVuYWJsZWQ7CiAgICB9LCBPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgIndpZHRoIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl93aWR0aCAqIHRoaXMuc2NhbGUueDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5zY2FsZS54ID0gdmFsdWUgLyB0aGlzLl93aWR0aDsKICAgICAgICB9CiAgICB9KSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJoZWlnaHQiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hlaWdodCAqIHRoaXMuc2NhbGUueTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5zY2FsZS55ID0gdmFsdWUgLyB0aGlzLl9oZWlnaHQ7CiAgICAgICAgfQogICAgfSksIHAuc2V0VGV4dCA9IGZ1bmN0aW9uKHRleHQpIHsKICAgICAgICBpZiAodGhpcy5sYWJlbCkgewogICAgICAgICAgICB0aGlzLmxhYmVsLnNldFRleHQodGV4dCksIHRoaXMubGFiZWwgaW5zdGFuY2VvZiBQSVhJLlRleHQgPyAodGhpcy5sYWJlbC51cGRhdGVUZXh0KCksIAogICAgICAgICAgICB0aGlzLmxhYmVsLmRpcnR5ID0gITEpIDogdGhpcy5sYWJlbC5mb3JjZVVwZGF0ZVRleHQoKTsKICAgICAgICAgICAgZm9yICh2YXIgZGF0YSwgaSA9IDA7IGkgPCB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aDsgKytpKSBpZiAodGhpcy5fc3RhdGVGbGFnc1t0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXSkgewogICAgICAgICAgICAgICAgZGF0YSA9IHRoaXMuX3N0YXRlRGF0YVt0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkYXRhIHx8IChkYXRhID0gdGhpcy5fc3RhdGVEYXRhLnVwKSwgZGF0YSA9IGRhdGEubGFiZWwsICJjZW50ZXIiID09IGRhdGEueCkgewogICAgICAgICAgICAgICAgdmFyIGJXID0gdGhpcy5iYWNrLndpZHRoLCBsVyA9IHRoaXMubGFiZWwud2lkdGg7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHRoaXMuX2N1cnJlbnRMYWJlbFN0eWxlLmFsaWduKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgImNlbnRlciI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gLjUgKiBiVzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgIGNhc2UgInJpZ2h0IjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSAuNSAqIChiVyAtIGxXKSArIGxXOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSAuNSAqIChiVyAtIGxXKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHRoaXMubGFiZWwucG9zaXRpb24ueCA9IGRhdGEueCArIHRoaXMuX29mZnNldC54OwogICAgICAgICAgICB0aGlzLmxhYmVsLnBvc2l0aW9uLnkgPSAiY2VudGVyIiA9PSBkYXRhLnkgPyAuNSAqICh0aGlzLmJhY2suaGVpZ2h0IC0gdGhpcy5sYWJlbC5oZWlnaHQpIDogZGF0YS55ICsgdGhpcy5fb2Zmc2V0Lnk7CiAgICAgICAgfQogICAgfSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJlbmFibGVkIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAhdGhpcy5fc3RhdGVGbGFncy5kaXNhYmxlZDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5fc3RhdGVGbGFncy5kaXNhYmxlZCA9ICF2YWx1ZSwgdGhpcy5idXR0b25Nb2RlID0gdmFsdWUsIHRoaXMuaW50ZXJhY3RpdmUgPSB2YWx1ZSwgCiAgICAgICAgICAgIHZhbHVlID8gKHRoaXMubW91c2Vkb3duID0gdGhpcy50b3VjaHN0YXJ0ID0gdGhpcy5fZG93bkNCLCB0aGlzLm1vdXNlb3ZlciA9IHRoaXMuX292ZXJDQiwgCiAgICAgICAgICAgIHRoaXMubW91c2VvdXQgPSB0aGlzLl9vdXRDQikgOiAodGhpcy5tb3VzZWRvd24gPSB0aGlzLnRvdWNoc3RhcnQgPSB0aGlzLm1vdXNlb3ZlciA9IHRoaXMubW91c2VvdXQgPSBudWxsLCAKICAgICAgICAgICAgdGhpcy5tb3VzZXVwID0gdGhpcy50b3VjaGVuZCA9IHRoaXMubW91c2V1cG91dHNpZGUgPSB0aGlzLnRvdWNoZW5kb3V0c2lkZSA9IG51bGwsIAogICAgICAgICAgICB0aGlzLl9zdGF0ZUZsYWdzLmRvd24gPSB0aGlzLl9zdGF0ZUZsYWdzLm92ZXIgPSAhMSwgdGhpcy5fX2lzT3ZlciA9ICExKSwgdGhpcy5fdXBkYXRlU3RhdGUoKTsKICAgICAgICB9CiAgICB9KSwgcC5fYWRkUHJvcGVydHkgPSBmdW5jdGlvbihwcm9wZXJ0eU5hbWUpIHsKICAgICAgICBSRVNFUlZFRF9TVEFURVMuaW5kZXhPZihwcm9wZXJ0eU5hbWUpID49IDAgfHwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwgewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlRmxhZ3NbcHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhdGVGbGFnc1twcm9wZXJ0eU5hbWVdID0gdmFsdWUsIHRoaXMuX3VwZGF0ZVN0YXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sIHAuX3VwZGF0ZVN0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuYmFjaykgewogICAgICAgICAgICBmb3IgKHZhciBkYXRhLCBpID0gMDsgaSA8IHRoaXMuX3N0YXRlUHJpb3JpdHkubGVuZ3RoOyArK2kpIGlmICh0aGlzLl9zdGF0ZUZsYWdzW3RoaXMuX3N0YXRlUHJpb3JpdHlbaV1dKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5fc3RhdGVEYXRhW3RoaXMuX3N0YXRlUHJpb3JpdHlbaV1dOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRhdGEgfHwgKGRhdGEgPSB0aGlzLl9zdGF0ZURhdGEudXApLCB0aGlzLmJhY2suc2V0VGV4dHVyZShkYXRhLnRleCksIHRoaXMubGFiZWwpIHsKICAgICAgICAgICAgICAgIGlmIChkYXRhID0gZGF0YS5sYWJlbCwgdGhpcy5fY3VycmVudExhYmVsU3R5bGUgJiYgZG9PYmplY3RzTWF0Y2godGhpcy5fY3VycmVudExhYmVsU3R5bGUsIGRhdGEuc3R5bGUpIHx8ICh0aGlzLmxhYmVsLnNldFN0eWxlKGRhdGEuc3R5bGUpLCAKICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRMYWJlbFN0eWxlID0gZGF0YS5zdHlsZSwgdGhpcy5sYWJlbCBpbnN0YW5jZW9mIFBJWEkuVGV4dCA/ICh0aGlzLmxhYmVsLnVwZGF0ZVRleHQoKSwgCiAgICAgICAgICAgICAgICB0aGlzLmxhYmVsLmRpcnR5ID0gITEpIDogdGhpcy5sYWJlbC5mb3JjZVVwZGF0ZVRleHQoKSksICJjZW50ZXIiID09IGRhdGEueCkgewogICAgICAgICAgICAgICAgICAgIHZhciBiVyA9IHRoaXMuYmFjay53aWR0aCwgbFcgPSB0aGlzLmxhYmVsLndpZHRoOwogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodGhpcy5fY3VycmVudExhYmVsU3R5bGUuYWxpZ24pIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImNlbnRlciI6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWwucG9zaXRpb24ueCA9IC41ICogYlc7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJpZ2h0IjoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gLjUgKiAoYlcgLSBsVykgKyBsVzsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gLjUgKiAoYlcgLSBsVyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHRoaXMubGFiZWwucG9zaXRpb24ueCA9IGRhdGEueCArIHRoaXMuX29mZnNldC54OwogICAgICAgICAgICAgICAgdGhpcy5sYWJlbC5wb3NpdGlvbi55ID0gImNlbnRlciIgPT0gZGF0YS55ID8gLjUgKiAodGhpcy5iYWNrLmhlaWdodCAtIHRoaXMubGFiZWwuaGVpZ2h0KSA6IGRhdGEueSArIHRoaXMuX29mZnNldC55OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwgcC5fb25PdmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fc3RhdGVGbGFncy5vdmVyID0gITAsIHRoaXMuX3VwZGF0ZVN0YXRlKCksIHRoaXMub3ZlckNhbGxiYWNrICYmIHRoaXMub3ZlckNhbGxiYWNrKHRoaXMpOwogICAgfSwgcC5fb25PdXQgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl9zdGF0ZUZsYWdzLm92ZXIgPSAhMSwgdGhpcy5fdXBkYXRlU3RhdGUoKSwgdGhpcy5vdXRDYWxsYmFjayAmJiB0aGlzLm91dENhbGxiYWNrKHRoaXMpOwogICAgfSwgcC5fb25Eb3duID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGRhdGEub3JpZ2luYWxFdmVudC5wcmV2ZW50RGVmYXVsdCgpLCB0aGlzLl9zdGF0ZUZsYWdzLmRvd24gPSAhMCwgdGhpcy5fdXBkYXRlU3RhdGUoKSwgCiAgICAgICAgdGhpcy5tb3VzZXVwID0gdGhpcy50b3VjaGVuZCA9IHRoaXMuX3VwQ0IsIHRoaXMubW91c2V1cG91dHNpZGUgPSB0aGlzLnRvdWNoZW5kb3V0c2lkZSA9IHRoaXMuX3VwT3V0Q0I7CiAgICB9LCBwLl9vblVwID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGRhdGEub3JpZ2luYWxFdmVudC5wcmV2ZW50RGVmYXVsdCgpLCB0aGlzLl9zdGF0ZUZsYWdzLmRvd24gPSAhMSwgdGhpcy5tb3VzZXVwID0gdGhpcy50b3VjaGVuZCA9IG51bGwsIAogICAgICAgIHRoaXMubW91c2V1cG91dHNpZGUgPSB0aGlzLnRvdWNoZW5kb3V0c2lkZSA9IG51bGwsIHRoaXMuX3VwZGF0ZVN0YXRlKCksIHRoaXMucmVsZWFzZUNhbGxiYWNrICYmIHRoaXMucmVsZWFzZUNhbGxiYWNrKHRoaXMpOwogICAgfSwgcC5fb25VcE91dHNpZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl9zdGF0ZUZsYWdzLmRvd24gPSAhMSwgdGhpcy5tb3VzZXVwID0gdGhpcy50b3VjaGVuZCA9IG51bGwsIHRoaXMubW91c2V1cG91dHNpZGUgPSB0aGlzLnRvdWNoZW5kb3V0c2lkZSA9IG51bGwsIAogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlKCk7CiAgICB9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm1vdXNlZG93biA9IHRoaXMudG91Y2hzdGFydCA9IHRoaXMubW91c2VvdmVyID0gdGhpcy5tb3VzZW91dCA9IG51bGwsIHRoaXMubW91c2V1cCA9IHRoaXMudG91Y2hlbmQgPSB0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSBudWxsLCAKICAgICAgICB0aGlzLnJlbW92ZUNoaWxkcmVuKCEwKSwgdGhpcy5sYWJlbCA9IG51bGwsIHRoaXMuYmFjayA9IG51bGwsIHRoaXMucmVsZWFzZUNhbGxiYWNrID0gbnVsbCwgCiAgICAgICAgdGhpcy5vdmVyQ2FsbGJhY2sgPSBudWxsLCB0aGlzLm91dENhbGxiYWNrID0gbnVsbCwgdGhpcy5fc3RhdGVEYXRhID0gbnVsbCwgdGhpcy5fc3RhdGVGbGFncyA9IG51bGwsIAogICAgICAgIHRoaXMuX3N0YXRlUHJpb3JpdHkgPSBudWxsLCB0aGlzLl9kb3duQ0IgPSBudWxsLCB0aGlzLl91cENCID0gbnVsbCwgdGhpcy5fb3ZlckNCID0gbnVsbCwgCiAgICAgICAgdGhpcy5fb3V0Q0IgPSBudWxsLCB0aGlzLl91cE91dENCID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5CdXR0b24gPSBCdXR0b247Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgRHJhZ01hbmFnZXIgPSBmdW5jdGlvbihzdGFydENhbGxiYWNrLCBlbmRDYWxsYmFjaykgewogICAgICAgIHRoaXMuaW5pdGlhbGl6ZShzdGFydENhbGxiYWNrLCBlbmRDYWxsYmFjayk7CiAgICB9LCBwID0gRHJhZ01hbmFnZXIucHJvdG90eXBlID0ge307CiAgICBwLmRyYWdnZWRPYmogPSBudWxsLCBwLmRyYWdTdGFydFRocmVzaG9sZCA9IDIwLCBwLm1vdXNlRG93blN0YWdlUG9zID0gbnVsbCwgcC5tb3VzZURvd25PYmpQb3MgPSBudWxsLCAKICAgIHAuaXNUb3VjaE1vdmUgPSAhMSwgcC5pc0hlbGREcmFnID0gITEsIHAuaXNTdGlja3lDbGljayA9ICExLCBwLmFsbG93U3RpY2t5Q2xpY2sgPSAhMCwgCiAgICBwLnNuYXBTZXR0aW5ncyA9IG51bGwsIHAuX3RoZVN0YWdlID0gbnVsbCwgcC5fZHJhZ09mZnNldCA9IG51bGwsIHAuX2RyYWdTdGFydENhbGxiYWNrID0gbnVsbCwgCiAgICBwLl9kcmFnRW5kQ2FsbGJhY2sgPSBudWxsLCBwLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayA9IG51bGwsIHAuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrID0gbnVsbCwgCiAgICBwLl9zdGFnZU1vdXNlVXBDYWxsYmFjayA9IG51bGwsIHAuX3VwZGF0ZUNhbGxiYWNrID0gbnVsbCwgcC5fZHJhZ2dhYmxlT2JqZWN0cyA9IG51bGw7CiAgICB2YXIgaGVscGVyUG9pbnQgPSBudWxsLCBUWVBFX01PVVNFID0gMCwgVFlQRV9UT1VDSCA9IDE7CiAgICBwLmluaXRpYWxpemUgPSBmdW5jdGlvbihzdGFydENhbGxiYWNrLCBlbmRDYWxsYmFjaykgewogICAgICAgIHRoaXMuX3VwZGF0ZUNhbGxiYWNrID0gdGhpcy5fdXBkYXRlT2JqUG9zaXRpb24uYmluZCh0aGlzKSwgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2sgPSB0aGlzLl90cmlnZ2VySGVsZERyYWcuYmluZCh0aGlzKSwgCiAgICAgICAgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2sgPSB0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2suYmluZCh0aGlzKSwgdGhpcy5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2sgPSB0aGlzLl9zdG9wRHJhZy5iaW5kKHRoaXMpLCAKICAgICAgICB0aGlzLl90aGVTdGFnZSA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLnN0YWdlLCB0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayA9IHN0YXJ0Q2FsbGJhY2ssIAogICAgICAgIHRoaXMuX2RyYWdFbmRDYWxsYmFjayA9IGVuZENhbGxiYWNrLCB0aGlzLl9kcmFnZ2FibGVPYmplY3RzID0gW10sIHRoaXMubW91c2VEb3duU3RhZ2VQb3MgPSBuZXcgUElYSS5Qb2ludCgwLCAwKSwgCiAgICAgICAgdGhpcy5tb3VzZURvd25PYmpQb3MgPSBuZXcgUElYSS5Qb2ludCgwLCAwKSwgaGVscGVyUG9pbnQgPSBuZXcgUElYSS5Qb2ludCgwLCAwKTsKICAgIH0sIHAuc3RhcnREcmFnID0gZnVuY3Rpb24ob2JqZWN0LCBpbnRlcmFjdGlvbkRhdGEpIHsKICAgICAgICB0aGlzLl9vYmpNb3VzZURvd24oVFlQRV9NT1VTRSwgb2JqZWN0LCBpbnRlcmFjdGlvbkRhdGEpOwogICAgfSwgcC5fb2JqTW91c2VEb3duID0gZnVuY3Rpb24odHlwZSwgb2JqLCBpbnRlcmFjdGlvbkRhdGEpIHsKICAgICAgICBudWxsID09PSB0aGlzLmRyYWdnZWRPYmogJiYgKHRoaXMuZHJhZ2dlZE9iaiA9IG9iaiwgY3JlYXRlanMuVHdlZW4ucmVtb3ZlVHdlZW5zKHRoaXMuZHJhZ2dlZE9iaiksIAogICAgICAgIGNyZWF0ZWpzLlR3ZWVuLnJlbW92ZVR3ZWVucyh0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24pLCB0aGlzLl9kcmFnT2Zmc2V0ID0gaW50ZXJhY3Rpb25EYXRhLmdldExvY2FsUG9zaXRpb24odGhpcy5kcmFnZ2VkT2JqLnBhcmVudCksIAogICAgICAgIHRoaXMuX2RyYWdPZmZzZXQueCAtPSB0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueCwgdGhpcy5fZHJhZ09mZnNldC55IC09IHRoaXMuZHJhZ2dlZE9iai5wb3NpdGlvbi55LCAKICAgICAgICB0aGlzLm1vdXNlRG93bk9ialBvcy54ID0gdGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uLngsIHRoaXMubW91c2VEb3duT2JqUG9zLnkgPSB0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueSwgCiAgICAgICAgdGhpcy5tb3VzZURvd25TdGFnZVBvcy54ID0gaW50ZXJhY3Rpb25EYXRhLmdsb2JhbC54LCB0aGlzLm1vdXNlRG93blN0YWdlUG9zLnkgPSBpbnRlcmFjdGlvbkRhdGEuZ2xvYmFsLnksIAogICAgICAgIHRoaXMuYWxsb3dTdGlja3lDbGljayAmJiB0eXBlICE9IFRZUEVfVE9VQ0ggPyAodGhpcy5kcmFnZ2VkT2JqLm1vdXNlbW92ZSA9IHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrLCAKICAgICAgICB0aGlzLl90aGVTdGFnZS5pbnRlcmFjdGlvbk1hbmFnZXIuc3RhZ2VVcCA9IHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrKSA6ICh0aGlzLmlzVG91Y2hNb3ZlID0gdHlwZSA9PSBUWVBFX1RPVUNILCAKICAgICAgICB0aGlzLmlzSGVsZERyYWcgPSAhMCwgdGhpcy5fc3RhcnREcmFnKCkpKTsKICAgIH0sIHAuX3RyaWdnZXJTdGlja3lDbGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaXNTdGlja3lDbGljayA9ICEwLCB0aGlzLmRyYWdnZWRPYmoubW91c2Vtb3ZlID0gbnVsbCwgdGhpcy5fdGhlU3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLnN0YWdlVXAgPSBudWxsLCAKICAgICAgICB0aGlzLl9zdGFydERyYWcoKTsKICAgIH0sIHAuX3RyaWdnZXJIZWxkRHJhZyA9IGZ1bmN0aW9uKGludGVyYWN0aW9uRGF0YSkgewogICAgICAgIHZhciB4RGlmZiA9IGludGVyYWN0aW9uRGF0YS5nbG9iYWwueCAtIHRoaXMubW91c2VEb3duU3RhZ2VQb3MueCwgeURpZmYgPSBpbnRlcmFjdGlvbkRhdGEuZ2xvYmFsLnkgLSB0aGlzLm1vdXNlRG93blN0YWdlUG9zLnk7CiAgICAgICAgeERpZmYgKiB4RGlmZiArIHlEaWZmICogeURpZmYgPj0gdGhpcy5kcmFnU3RhcnRUaHJlc2hvbGQgKiB0aGlzLmRyYWdTdGFydFRocmVzaG9sZCAmJiAodGhpcy5pc0hlbGREcmFnID0gITAsIAogICAgICAgIHRoaXMuZHJhZ2dlZE9iai5tb3VzZW1vdmUgPSBudWxsLCB0aGlzLl90aGVTdGFnZS5pbnRlcmFjdGlvbk1hbmFnZXIuc3RhZ2VVcCA9IG51bGwsIAogICAgICAgIHRoaXMuX3N0YXJ0RHJhZygpKTsKICAgIH0sIHAuX3N0YXJ0RHJhZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpbSA9IHRoaXMuX3RoZVN0YWdlLmludGVyYWN0aW9uTWFuYWdlcjsKICAgICAgICBpbS5zdGFnZVVwID0gdGhpcy5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2ssIHRoaXMuZHJhZ2dlZE9iai5tb3VzZW1vdmUgPSB0aGlzLmRyYWdnZWRPYmoudG91Y2htb3ZlID0gdGhpcy5fdXBkYXRlQ2FsbGJhY2ssIAogICAgICAgIHRoaXMuX2RyYWdTdGFydENhbGxiYWNrKHRoaXMuZHJhZ2dlZE9iaik7CiAgICB9LCBwLnN0b3BEcmFnID0gZnVuY3Rpb24oZG9DYWxsYmFjaykgewogICAgICAgIHRoaXMuX3N0b3BEcmFnKG51bGwsIGRvQ2FsbGJhY2sgPT09ICEwKTsKICAgIH0sIHAuX3N0b3BEcmFnID0gZnVuY3Rpb24ob3JpZ01vdXNlRXYsIGRvQ2FsbGJhY2spIHsKICAgICAgICB0aGlzLmRyYWdnZWRPYmogJiYgKHRoaXMuZHJhZ2dlZE9iai50b3VjaG1vdmUgPSB0aGlzLmRyYWdnZWRPYmoubW91c2Vtb3ZlID0gbnVsbCk7CiAgICAgICAgdmFyIGltID0gdGhpcy5fdGhlU3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyOwogICAgICAgIGltLnN0YWdlVXAgPSBudWxsOwogICAgICAgIHZhciBvYmogPSB0aGlzLmRyYWdnZWRPYmo7CiAgICAgICAgdGhpcy5kcmFnZ2VkT2JqID0gbnVsbCwgdGhpcy5pc1RvdWNoTW92ZSA9ICExLCB0aGlzLmlzU3RpY2t5Q2xpY2sgPSAhMSwgdGhpcy5pc0hlbGRNb3ZlID0gITEsIAogICAgICAgIGRvQ2FsbGJhY2sgIT09ICExICYmIHRoaXMuX2RyYWdFbmRDYWxsYmFjayhvYmopOwogICAgfSwgcC5fdXBkYXRlT2JqUG9zaXRpb24gPSBmdW5jdGlvbihpbnRlcmFjdGlvbkRhdGEpIHsKICAgICAgICBpZiAodGhpcy5pc1RvdWNoTW92ZSB8fCB0aGlzLl90aGVTdGFnZS5pbnRlcmFjdGlvbk1hbmFnZXIubW91c2VJblN0YWdlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5kcmFnZ2VkT2JqIHx8ICF0aGlzLmRyYWdnZWRPYmoucGFyZW50KSByZXR1cm4gdm9pZCB0aGlzLl9zdG9wRHJhZyhudWxsLCAhMSk7CiAgICAgICAgICAgIHZhciBtb3VzZVBvcyA9IGludGVyYWN0aW9uRGF0YS5nZXRMb2NhbFBvc2l0aW9uKHRoaXMuZHJhZ2dlZE9iai5wYXJlbnQsIGhlbHBlclBvaW50KSwgYm91bmRzID0gdGhpcy5kcmFnZ2VkT2JqLl9kcmFnQm91bmRzOwogICAgICAgICAgICBpZiAodGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uLnggPSBjbGFtcChtb3VzZVBvcy54IC0gdGhpcy5fZHJhZ09mZnNldC54LCBib3VuZHMueCwgYm91bmRzLnJpZ2h0KSwgCiAgICAgICAgICAgIHRoaXMuZHJhZ2dlZE9iai5wb3NpdGlvbi55ID0gY2xhbXAobW91c2VQb3MueSAtIHRoaXMuX2RyYWdPZmZzZXQueSwgYm91bmRzLnksIGJvdW5kcy5ib3R0b20pLCAKICAgICAgICAgICAgdGhpcy5zbmFwU2V0dGluZ3MpIHN3aXRjaCAodGhpcy5zbmFwU2V0dGluZ3MubW9kZSkgewogICAgICAgICAgICAgIGNhc2UgInBvaW50cyI6CiAgICAgICAgICAgICAgICB0aGlzLl9oYW5kbGVQb2ludFNuYXAobW91c2VQb3MpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgImdyaWQiOgogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgImxpbmUiOiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LCBwLl9oYW5kbGVQb2ludFNuYXAgPSBmdW5jdGlvbihsb2NhbE1vdXNlUG9zKSB7CiAgICAgICAgZm9yICh2YXIgc25hcFNldHRpbmdzID0gdGhpcy5zbmFwU2V0dGluZ3MsIG1pbkRpc3RTcSA9IHNuYXBTZXR0aW5ncy5kaXN0ICogc25hcFNldHRpbmdzLmRpc3QsIHBvaW50cyA9IHNuYXBTZXR0aW5ncy5wb2ludHMsIG9ialggPSBsb2NhbE1vdXNlUG9zLnggLSB0aGlzLl9kcmFnT2Zmc2V0LngsIG9ialkgPSBsb2NhbE1vdXNlUG9zLnkgLSB0aGlzLl9kcmFnT2Zmc2V0LnksIGxlYXN0RGlzdCA9IC0xLCBjbG9zZXN0UG9pbnQgPSBudWxsLCBpID0gcG9pbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgIHZhciBwID0gcG9pbnRzW2ldLCBkaXN0U3EgPSBkaXN0U3F1YXJlZChvYmpYLCBvYmpZLCBwLngsIHAueSk7CiAgICAgICAgICAgIG1pbkRpc3RTcSA+PSBkaXN0U3EgJiYgKGxlYXN0RGlzdCA+IGRpc3RTcSB8fCAtMSA9PSBsZWFzdERpc3QpICYmIChsZWFzdERpc3QgPSBkaXN0U3EsIAogICAgICAgICAgICBjbG9zZXN0UG9pbnQgPSBwKTsKICAgICAgICB9CiAgICAgICAgY2xvc2VzdFBvaW50ICYmICh0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueCA9IGNsb3Nlc3RQb2ludC54LCB0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueSA9IGNsb3Nlc3RQb2ludC55KTsKICAgIH07CiAgICB2YXIgZGlzdFNxdWFyZWQgPSBmdW5jdGlvbih4MSwgeTEsIHgyLCB5MikgewogICAgICAgIHZhciB4RGlmZiA9IHgxIC0geDIsIHlEaWZmID0geTEgLSB5MjsKICAgICAgICByZXR1cm4geERpZmYgKiB4RGlmZiArIHlEaWZmICogeURpZmY7CiAgICB9LCBjbGFtcCA9IGZ1bmN0aW9uKHgsIGEsIGIpIHsKICAgICAgICByZXR1cm4gYSA+IHggPyBhIDogeCA+IGIgPyBiIDogeDsKICAgIH0sIGVuYWJsZURyYWcgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm1vdXNlZG93biA9IHRoaXMuX29uTW91c2VEb3duTGlzdGVuZXIsIHRoaXMudG91Y2hzdGFydCA9IHRoaXMuX29uVG91Y2hTdGFydExpc3RlbmVyLCAKICAgICAgICB0aGlzLmJ1dHRvbk1vZGUgPSB0aGlzLmludGVyYWN0aXZlID0gITA7CiAgICB9LCBkaXNhYmxlRHJhZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubW91c2Vkb3duID0gdGhpcy50b3VjaHN0YXJ0ID0gbnVsbCwgdGhpcy5idXR0b25Nb2RlID0gdGhpcy5pbnRlcmFjdGl2ZSA9ICExOwogICAgfSwgX29uTW91c2VEb3duID0gZnVuY3Rpb24odHlwZSwgbW91c2VEYXRhKSB7CiAgICAgICAgdGhpcy5fZHJhZ01hbi5fb2JqTW91c2VEb3duKHR5cGUsIHRoaXMsIG1vdXNlRGF0YSk7CiAgICB9OwogICAgcC5hZGRPYmplY3QgPSBmdW5jdGlvbihvYmosIGJvdW5kcykgewogICAgICAgIGlmICghYm91bmRzKSB7CiAgICAgICAgICAgIHZhciBjYW52YXMgPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5fcmVuZGVyZXIudmlldzsKICAgICAgICAgICAgYm91bmRzID0gewogICAgICAgICAgICAgICAgeDogMCwKICAgICAgICAgICAgICAgIHk6IDAsCiAgICAgICAgICAgICAgICB3aWR0aDogY2FudmFzLndpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBjYW52YXMuaGVpZ2h0CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGJvdW5kcy5yaWdodCA9IGJvdW5kcy54ICsgYm91bmRzLndpZHRoLCBib3VuZHMuYm90dG9tID0gYm91bmRzLnkgKyBib3VuZHMuaGVpZ2h0LCAKICAgICAgICBvYmouX2RyYWdCb3VuZHMgPSBib3VuZHMsIHRoaXMuX2RyYWdnYWJsZU9iamVjdHMuaW5kZXhPZihvYmopID49IDAgfHwgKG9iai5lbmFibGVEcmFnID0gZW5hYmxlRHJhZywgCiAgICAgICAgb2JqLmRpc2FibGVEcmFnID0gZGlzYWJsZURyYWcsIG9iai5fb25Nb3VzZURvd25MaXN0ZW5lciA9IF9vbk1vdXNlRG93bi5iaW5kKG9iaiwgVFlQRV9NT1VTRSksIAogICAgICAgIG9iai5fb25Ub3VjaFN0YXJ0TGlzdGVuZXIgPSBfb25Nb3VzZURvd24uYmluZChvYmosIFRZUEVfVE9VQ0gpLCBvYmouX2RyYWdNYW4gPSB0aGlzLCAKICAgICAgICB0aGlzLl9kcmFnZ2FibGVPYmplY3RzLnB1c2gob2JqKSk7CiAgICB9LCBwLnJlbW92ZU9iamVjdCA9IGZ1bmN0aW9uKG9iaikgewogICAgICAgIHZhciBpbmRleCA9IHRoaXMuX2RyYWdnYWJsZU9iamVjdHMuaW5kZXhPZihvYmopOwogICAgICAgIGluZGV4ID49IDAgJiYgKG9iai5kaXNhYmxlRHJhZygpLCBkZWxldGUgb2JqLmVuYWJsZURyYWcsIGRlbGV0ZSBvYmouZGlzYWJsZURyYWcsIAogICAgICAgIGRlbGV0ZSBvYmouX29uTW91c2VEb3duTGlzdGVuZXIsIGRlbGV0ZSBvYmouX29uVG91Y2hTdGFydExpc3RlbmVyLCBkZWxldGUgb2JqLl9kcmFnTWFuLCAKICAgICAgICBkZWxldGUgb2JqLl9kcmFnQm91bmRzLCB0aGlzLl9kcmFnZ2FibGVPYmplY3RzLnNwbGljZShpbmRleCwgMSkpOwogICAgfSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbnVsbCAhPT0gdGhpcy5kcmFnZ2VkT2JqICYmIHRoaXMuX3N0b3BEcmFnKG51bGwsICExKSwgdGhpcy5fdXBkYXRlQ2FsbGJhY2sgPSBudWxsLCAKICAgICAgICB0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayA9IG51bGwsIHRoaXMuX2RyYWdFbmRDYWxsYmFjayA9IG51bGwsIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gbnVsbCwgCiAgICAgICAgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2sgPSBudWxsLCB0aGlzLl9zdGFnZU1vdXNlVXBDYWxsYmFjayA9IG51bGwsIHRoaXMuX3RoZVN0YWdlID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgICAgICB2YXIgb2JqID0gdGhpcy5fZHJhZ2dhYmxlT2JqZWN0c1tpXTsKICAgICAgICAgICAgb2JqLmRpc2FibGVEcmFnKCksIGRlbGV0ZSBvYmouZW5hYmxlRHJhZywgZGVsZXRlIG9iai5kaXNhYmxlRHJhZywgZGVsZXRlIG9iai5fb25Nb3VzZURvd25MaXN0ZW5lciwgCiAgICAgICAgICAgIGRlbGV0ZSBvYmouX2RyYWdNYW4sIGRlbGV0ZSBvYmouX2RyYWdCb3VuZHM7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2RyYWdnYWJsZU9iamVjdHMgPSBudWxsOwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLkRyYWdNYW5hZ2VyID0gRHJhZ01hbmFnZXI7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgUG9zaXRpb25lciA9IGZ1bmN0aW9uKCkge307CiAgICBQb3NpdGlvbmVyLnByb3RvdHlwZSA9IHt9LCBQb3NpdGlvbmVyLnBvc2l0aW9uSXRlbXMgPSBmdW5jdGlvbihwYXJlbnQsIGl0ZW1TZXR0aW5ncykgewogICAgICAgIHZhciByb3QsIHB0LCBkZWdUb1JhZDsKICAgICAgICBkZWdUb1JhZCA9IE1hdGguUEkgLyAxODA7CiAgICAgICAgZm9yICh2YXIgaU5hbWUgaW4gaXRlbVNldHRpbmdzKSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gcGFyZW50W2lOYW1lXTsKICAgICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICAgIHZhciBzZXR0aW5nID0gaXRlbVNldHRpbmdzW2lOYW1lXTsKICAgICAgICAgICAgICAgIGlmIChpdGVtLnBvc2l0aW9uLnggPSBzZXR0aW5nLngsIGl0ZW0ucG9zaXRpb24ueSA9IHNldHRpbmcueSwgcHQgPSBzZXR0aW5nLnNjYWxlLCAKICAgICAgICAgICAgICAgIHB0ICYmIChpdGVtLnNjYWxlLnggKj0gcHQueCwgaXRlbS5zY2FsZS55ICo9IHB0LnkpLCBwdCA9IHNldHRpbmcucGl2b3QsIHB0ICYmIChpdGVtLnBpdm90LnggPSBwdC54LCAKICAgICAgICAgICAgICAgIGl0ZW0ucGl2b3QueSA9IHB0LnkpLCByb3QgPSBzZXR0aW5nLnJvdGF0aW9uLCByb3QgJiYgKGl0ZW0ucm90YXRpb24gPSByb3QgKiBkZWdUb1JhZCksIAogICAgICAgICAgICAgICAgc2V0dGluZy5oaXRBcmVhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhpdEFyZWEgPSBzZXR0aW5nLmhpdEFyZWE7CiAgICAgICAgICAgICAgICAgICAgaXRlbS5oaXRBcmVhID0gUG9zaXRpb25lci5nZW5lcmF0ZUhpdEFyZWEoaGl0QXJlYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBEZWJ1Zy5lcnJvcigiY291bGQgbm90IGZpbmQgb2JqZWN0ICciICsgaU5hbWUgKyAiJyIpOwogICAgICAgIH0KICAgIH0sIFBvc2l0aW9uZXIuZ2VuZXJhdGVIaXRBcmVhID0gZnVuY3Rpb24oaGl0QXJlYSwgc2NhbGUpIHsKICAgICAgICBzY2FsZSB8fCAoc2NhbGUgPSAxKTsKICAgICAgICB2YXIgbGlicmFyeTsKICAgICAgICBpZiAobGlicmFyeSA9IHdpbmRvdy5QSVhJLCBpc0FycmF5KGhpdEFyZWEpKSB7CiAgICAgICAgICAgIGlmICgxID09IHNjYWxlKSByZXR1cm4gbmV3IGxpYnJhcnkuUG9seWdvbihoaXRBcmVhKTsKICAgICAgICAgICAgZm9yICh2YXIgdGVtcCA9IFtdLCBpID0gMCwgbGVuID0gaGl0QXJlYS5sZW5ndGg7IGxlbiA+IGk7ICsraSkgdGVtcC5wdXNoKG5ldyBsaWJyYXJ5LlBvaW50KGhpdEFyZWFbaV0ueCAqIHNjYWxlLCBoaXRBcmVhW2ldLnkgKiBzY2FsZSkpOwogICAgICAgICAgICByZXR1cm4gbmV3IGxpYnJhcnkuUG9seWdvbih0ZW1wKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICJyZWN0IiAhPSBoaXRBcmVhLnR5cGUgJiYgaGl0QXJlYS50eXBlID8gImVsbGlwc2UiID09IGhpdEFyZWEudHlwZSA/IG5ldyBsaWJyYXJ5LkVsbGlwc2UoKGhpdEFyZWEueCAtIC41ICogaGl0QXJlYS53KSAqIHNjYWxlLCAoaGl0QXJlYS55IC0gLjUgKiBoaXRBcmVhLmgpICogc2NhbGUsIGhpdEFyZWEudyAqIHNjYWxlLCBoaXRBcmVhLmggKiBzY2FsZSkgOiAiY2lyY2xlIiA9PSBoaXRBcmVhLnR5cGUgPyBuZXcgbGlicmFyeS5DaXJjbGUoaGl0QXJlYS54ICogc2NhbGUsIGhpdEFyZWEueSAqIHNjYWxlLCBoaXRBcmVhLnIgKiBzY2FsZSkgOiAic2VjdG9yIiA9PSBoaXRBcmVhLnR5cGUgPyBuZXcgbGlicmFyeS5TZWN0b3IoaGl0QXJlYS54ICogc2NhbGUsIGhpdEFyZWEueSAqIHNjYWxlLCBoaXRBcmVhLnIgKiBzY2FsZSwgaGl0QXJlYS5zdGFydCwgaGl0QXJlYS5lbmQpIDogbnVsbCA6IG5ldyBsaWJyYXJ5LlJlY3RhbmdsZShoaXRBcmVhLnggKiBzY2FsZSwgaGl0QXJlYS55ICogc2NhbGUsIGhpdEFyZWEudyAqIHNjYWxlLCBoaXRBcmVhLmggKiBzY2FsZSk7CiAgICB9OwogICAgdmFyIGlzQXJyYXkgPSBmdW5jdGlvbihvKSB7CiAgICAgICAgcmV0dXJuICJbb2JqZWN0IEFycmF5XSIgPT09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvKTsKICAgIH07CiAgICBuYW1lc3BhY2UoImNsb3Vka2lkIikuUG9zaXRpb25lciA9IFBvc2l0aW9uZXI7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgU2NyZWVuU2V0dGluZ3MgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0LCBwcGkpIHsKICAgICAgICB0aGlzLndpZHRoID0gd2lkdGgsIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0LCB0aGlzLnBwaSA9IHBwaTsKICAgIH07CiAgICBTY3JlZW5TZXR0aW5ncy5wcm90b3R5cGUgPSB7fSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLlNjcmVlblNldHRpbmdzID0gU2NyZWVuU2V0dGluZ3M7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgVUlTY2FsZXIsIFVJRWxlbWVudCA9IGZ1bmN0aW9uKGl0ZW0sIHNldHRpbmdzLCBkZXNpZ25lZFNjcmVlbikgewogICAgICAgIHN3aXRjaCAoVUlTY2FsZXIgPSBjbG91ZGtpZC5VSVNjYWxlciwgdGhpcy5faXRlbSA9IGl0ZW0sIHRoaXMuX3NldHRpbmdzID0gc2V0dGluZ3MsIAogICAgICAgIHRoaXMuX2Rlc2lnbmVkU2NyZWVuID0gZGVzaWduZWRTY3JlZW4sIHRoaXMub3JpZ1NjYWxlWCA9IGl0ZW0uc2NhbGUueCwgdGhpcy5vcmlnU2NhbGVZID0gaXRlbS5zY2FsZS55LCAKICAgICAgICB0aGlzLm9yaWdXaWR0aCA9IGl0ZW0ud2lkdGgsIHRoaXMub3JpZ0JvdW5kcyA9IHsKICAgICAgICAgICAgeDogMCwKICAgICAgICAgICAgeTogMCwKICAgICAgICAgICAgd2lkdGg6IGl0ZW0ud2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogaXRlbS5oZWlnaHQKICAgICAgICB9LCB0aGlzLm9yaWdCb3VuZHMucmlnaHQgPSB0aGlzLm9yaWdCb3VuZHMueCArIHRoaXMub3JpZ0JvdW5kcy53aWR0aCwgdGhpcy5vcmlnQm91bmRzLmJvdHRvbSA9IHRoaXMub3JpZ0JvdW5kcy55ICsgdGhpcy5vcmlnQm91bmRzLmhlaWdodCwgCiAgICAgICAgc2V0dGluZ3MudmVydEFsaWduKSB7CiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX1RPUDoKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luVmVydCA9IGl0ZW0ucG9zaXRpb24ueSArIHRoaXMub3JpZ0JvdW5kcy55OwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luVmVydCA9IC41ICogZGVzaWduZWRTY3JlZW4uaGVpZ2h0IC0gaXRlbS5wb3NpdGlvbi55OwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0JPVFRPTToKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luVmVydCA9IGRlc2lnbmVkU2NyZWVuLmhlaWdodCAtIChpdGVtLnBvc2l0aW9uLnkgKyB0aGlzLm9yaWdCb3VuZHMuYm90dG9tKTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoIChzZXR0aW5ncy5ob3JpQWxpZ24pIHsKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fTEVGVDoKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGl0ZW0ucG9zaXRpb24ueCArIHRoaXMub3JpZ0JvdW5kcy54OwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luSG9yaSA9IC41ICogZGVzaWduZWRTY3JlZW4ud2lkdGggLSBpdGVtLnBvc2l0aW9uLng7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fUklHSFQ6CiAgICAgICAgICAgIHRoaXMub3JpZ01hcmdpbkhvcmkgPSBkZXNpZ25lZFNjcmVlbi53aWR0aCAtIChpdGVtLnBvc2l0aW9uLnggKyB0aGlzLm9yaWdCb3VuZHMucmlnaHQpOwogICAgICAgIH0KICAgIH0sIHAgPSBVSUVsZW1lbnQucHJvdG90eXBlID0ge307CiAgICBwLm9yaWdNYXJnaW5Ib3JpID0gMCwgcC5vcmlnTWFyZ2luVmVydCA9IDAsIHAub3JpZ1dpZHRoID0gMCwgcC5vcmlnU2NhbGVYID0gMCwgcC5vcmlnU2NhbGVZID0gMCwgCiAgICBwLm9yaWdCb3VuZHMgPSBudWxsLCBwLl9zZXR0aW5ncyA9IG51bGwsIHAuX2l0ZW0gPSBudWxsLCBwLl9kZXNpZ25lZFNjcmVlbiA9IG51bGwsIAogICAgcC5yZXNpemUgPSBmdW5jdGlvbihuZXdTY3JlZW4pIHsKICAgICAgICB2YXIgb3ZlcmFsbFNjYWxlID0gbmV3U2NyZWVuLmhlaWdodCAvIHRoaXMuX2Rlc2lnbmVkU2NyZWVuLmhlaWdodCwgcHBpU2NhbGUgPSBuZXdTY3JlZW4ucHBpIC8gdGhpcy5fZGVzaWduZWRTY3JlZW4ucHBpLCBsZXR0ZXJCb3hXaWR0aCA9IChuZXdTY3JlZW4ud2lkdGggLSB0aGlzLl9kZXNpZ25lZFNjcmVlbi53aWR0aCAqIG92ZXJhbGxTY2FsZSkgLyAyLCBpdGVtU2NhbGUgPSBvdmVyYWxsU2NhbGUgLyBwcGlTY2FsZTsKICAgICAgICB0aGlzLl9zZXR0aW5ncy5taW5TY2FsZSAmJiBpdGVtU2NhbGUgPCB0aGlzLl9zZXR0aW5ncy5taW5TY2FsZSA/IGl0ZW1TY2FsZSA9IHRoaXMuX3NldHRpbmdzLm1pblNjYWxlIDogdGhpcy5fc2V0dGluZ3MubWF4U2NhbGUgJiYgaXRlbVNjYWxlID4gdGhpcy5fc2V0dGluZ3MubWF4U2NhbGUgJiYgKGl0ZW1TY2FsZSA9IHRoaXMuX3NldHRpbmdzLm1heFNjYWxlKSwgCiAgICAgICAgaXRlbVNjYWxlICo9IHBwaVNjYWxlLCB0aGlzLl9pdGVtLnNjYWxlLnggPSB0aGlzLm9yaWdTY2FsZVggKiBpdGVtU2NhbGUsIHRoaXMuX2l0ZW0uc2NhbGUueSA9IHRoaXMub3JpZ1NjYWxlWSAqIGl0ZW1TY2FsZTsKICAgICAgICB2YXIgbTsKICAgICAgICBzd2l0Y2ggKG0gPSB0aGlzLm9yaWdNYXJnaW5WZXJ0ICogb3ZlcmFsbFNjYWxlLCB0aGlzLl9zZXR0aW5ncy52ZXJ0QWxpZ24pIHsKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fVE9QOgogICAgICAgICAgICB0aGlzLl9pdGVtLnBvc2l0aW9uLnkgPSBtIC0gdGhpcy5vcmlnQm91bmRzLnkgKiBpdGVtU2NhbGU7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOgogICAgICAgICAgICB0aGlzLl9pdGVtLnBvc2l0aW9uLnkgPSAuNSAqIG5ld1NjcmVlbi5oZWlnaHQgLSBtOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0JPVFRPTToKICAgICAgICAgICAgdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gbmV3U2NyZWVuLmhlaWdodCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMuYm90dG9tICogaXRlbVNjYWxlOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKG0gPSB0aGlzLm9yaWdNYXJnaW5Ib3JpICogb3ZlcmFsbFNjYWxlLCB0aGlzLl9zZXR0aW5ncy5ob3JpQWxpZ24pIHsKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fTEVGVDoKICAgICAgICAgICAgdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gdGhpcy5fc2V0dGluZ3MudGl0bGVTYWZlID8gbGV0dGVyQm94V2lkdGggKyBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGUgOiBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGU7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOgogICAgICAgICAgICB0aGlzLl9pdGVtLnBvc2l0aW9uLnggPSB0aGlzLl9zZXR0aW5ncy5jZW50ZXJlZEhvcml6b250YWxseSA/IC41ICogKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2l0ZW0ud2lkdGgpIDogLjUgKiBuZXdTY3JlZW4ud2lkdGggLSBtOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX1JJR0hUOgogICAgICAgICAgICB0aGlzLl9pdGVtLnBvc2l0aW9uLnggPSB0aGlzLl9zZXR0aW5ncy50aXRsZVNhZmUgPyBuZXdTY3JlZW4ud2lkdGggLSBsZXR0ZXJCb3hXaWR0aCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMucmlnaHQgKiBpdGVtU2NhbGUgOiBuZXdTY3JlZW4ud2lkdGggLSBtIC0gdGhpcy5vcmlnQm91bmRzLnJpZ2h0ICogaXRlbVNjYWxlOwogICAgICAgIH0KICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMub3JpZ0JvdW5kcyA9IG51bGwsIHRoaXMuX2l0ZW0gPSBudWxsLCB0aGlzLl9zZXR0aW5ncyA9IG51bGwsIHRoaXMuX2Rlc2lnbmVkU2NyZWVuID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5VSUVsZW1lbnQgPSBVSUVsZW1lbnQ7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgVUlFbGVtZW50U2V0dGluZ3MgPSBmdW5jdGlvbigpIHt9LCBwID0gVUlFbGVtZW50U2V0dGluZ3MucHJvdG90eXBlID0ge307CiAgICBwLnZlcnRBbGlnbiA9IG51bGwsIHAuaG9yaUFsaWduID0gbnVsbCwgcC50aXRsZVNhZmUgPSAhMSwgcC5tYXhTY2FsZSA9IDEsIHAubWluU2NhbGUgPSAxLCAKICAgIHAuY2VudGVyZWRIb3Jpem9udGFsbHkgPSAhMSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLlVJRWxlbWVudFNldHRpbmdzID0gVUlFbGVtZW50U2V0dGluZ3M7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgVUlFbGVtZW50U2V0dGluZ3MgPSBjbG91ZGtpZC5VSUVsZW1lbnRTZXR0aW5ncywgVUlFbGVtZW50ID0gY2xvdWRraWQuVUlFbGVtZW50LCBTY3JlZW5TZXR0aW5ncyA9IGNsb3Vka2lkLlNjcmVlblNldHRpbmdzLCBVSVNjYWxlciA9IGZ1bmN0aW9uKHBhcmVudCwgZGVzaWduZWRXaWR0aCwgZGVzaWduZWRIZWlnaHQsIGRlc2lnbmVkUFBJKSB7CiAgICAgICAgdGhpcy5fcGFyZW50ID0gcGFyZW50LCB0aGlzLl9pdGVtcyA9IFtdLCB0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG5ldyBTY3JlZW5TZXR0aW5ncyhkZXNpZ25lZFdpZHRoLCBkZXNpZ25lZEhlaWdodCwgZGVzaWduZWRQUEkpOwogICAgfSwgcCA9IFVJU2NhbGVyLnByb3RvdHlwZSA9IHt9LCBjdXJyZW50U2NyZWVuID0gbmV3IFNjcmVlblNldHRpbmdzKDAsIDAsIDApLCBpbml0aWFsaXplZCA9ICExOwogICAgcC5fcGFyZW50ID0gbnVsbCwgcC5fZGVzaWduZWRTY3JlZW4gPSBudWxsLCBwLl9pdGVtcyA9IG51bGwsIFVJU2NhbGVyLkFMSUdOX1RPUCA9ICJ0b3AiLCAKICAgIFVJU2NhbGVyLkFMSUdOX0JPVFRPTSA9ICJib3R0b20iLCBVSVNjYWxlci5BTElHTl9MRUZUID0gImxlZnQiLCBVSVNjYWxlci5BTElHTl9SSUdIVCA9ICJyaWdodCIsIAogICAgVUlTY2FsZXIuQUxJR05fQ0VOVEVSID0gImNlbnRlciIsIFVJU2NhbGVyLmZyb21KU09OID0gZnVuY3Rpb24ocGFyZW50LCBqc29uU2V0dGluZ3MsIGpzb25JdGVtcywgaW1tZWRpYXRlRGVzdHJveSkgewogICAgICAgICJib29sZWFuIiAhPSB0eXBlb2YgaW1tZWRpYXRlRGVzdHJveSAmJiAoaW1tZWRpYXRlRGVzdHJveSA9ICEwKTsKICAgICAgICB2YXIgaXRlbSwgaSwgYWxpZ24sIHZlcnRBbGlnbiwgaG9yaUFsaWduLCBzY2FsZXIgPSBuZXcgVUlTY2FsZXIocGFyZW50LCBqc29uU2V0dGluZ3MuZGVzaWduZWRXaWR0aCwganNvblNldHRpbmdzLmRlc2lnbmVkSGVpZ2h0LCBqc29uU2V0dGluZ3MuZGVzaWduZWRQUEkpOwogICAgICAgIGZvciAoaSBpbiBqc29uSXRlbXMpIGl0ZW0gPSBqc29uSXRlbXNbaV0sIGl0ZW0uYWxpZ24gPyAoYWxpZ24gPSBpdGVtLmFsaWduLnNwbGl0KCItIiksIAogICAgICAgIHZlcnRBbGlnbiA9IGFsaWduWzBdLCBob3JpQWxpZ24gPSBhbGlnblsxXSkgOiAodmVydEFsaWduID0gQUxJR05fQ0VOVEVSLCBob3JpQWxpZ24gPSBBTElHTl9DRU5URVIpLCAKICAgICAgICBzY2FsZXIuYWRkKHBhcmVudFtpXSwgdmVydEFsaWduLCBob3JpQWxpZ24sIGl0ZW0udGl0bGVTYWZlIHx8ICExLCBpdGVtLm1pblNjYWxlIHx8IDAvMCwgaXRlbS5tYXhTY2FsZSB8fCAwLzAsIGl0ZW0uY2VudGVyZWRIb3Jpem9udGFsbHkgfHwgITEpOwogICAgICAgIHJldHVybiBzY2FsZXIucmVzaXplKCksIGltbWVkaWF0ZURlc3Ryb3kgJiYgc2NhbGVyLmRlc3Ryb3koKSwgc2NhbGVyOwogICAgfSwgVUlTY2FsZXIuaW5pdCA9IGZ1bmN0aW9uKHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQsIHNjcmVlblBQSSkgewogICAgICAgIGN1cnJlbnRTY3JlZW4ud2lkdGggPSBzY3JlZW5XaWR0aCwgY3VycmVudFNjcmVlbi5oZWlnaHQgPSBzY3JlZW5IZWlnaHQsIGN1cnJlbnRTY3JlZW4ucHBpID0gc2NyZWVuUFBJLCAKICAgICAgICBpbml0aWFsaXplZCA9ICEwOwogICAgfSwgcC5nZXRTY2FsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBjdXJyZW50U2NyZWVuLmhlaWdodCAvIHRoaXMuX2Rlc2lnbmVkU2NyZWVuLmhlaWdodDsKICAgIH0sIHAuYWRkID0gZnVuY3Rpb24oaXRlbSwgdmVydEFsaWduLCBob3JpQWxpZ24sIHRpdGxlU2FmZSwgbWluU2NhbGUsIG1heFNjYWxlLCBjZW50ZXJlZEhvcml6b250YWxseSkgewogICAgICAgIHZhciBzID0gbmV3IFVJRWxlbWVudFNldHRpbmdzKCk7CiAgICAgICAgcy52ZXJ0QWxpZ24gPSB2ZXJ0QWxpZ24gfHwgVUlTY2FsZXIuQUxJR05fQ0VOVEVSLCBzLmhvcmlBbGlnbiA9IGhvcmlBbGlnbiB8fCBVSVNjYWxlci5BTElHTl9DRU5URVIsIAogICAgICAgIHMudGl0bGVTYWZlID0gImJvb2xlYW4iICE9IHR5cGVvZiB0aXRsZVNhZmUgPyAhMSA6IHRpdGxlU2FmZSwgcy5tYXhTY2FsZSA9ICJudW1iZXIiICE9IHR5cGVvZiBtYXhTY2FsZSA/IDAvMCA6IG1heFNjYWxlLCAKICAgICAgICBzLm1pblNjYWxlID0gIm51bWJlciIgIT0gdHlwZW9mIG1pblNjYWxlID8gMC8wIDogbWluU2NhbGUsIHMuY2VudGVyZWRIb3Jpem9udGFsbHkgPSBjZW50ZXJlZEhvcml6b250YWxseSB8fCAhMSwgCiAgICAgICAgdGhpcy5faXRlbXMucHVzaChuZXcgVUlFbGVtZW50KGl0ZW0sIHMsIHRoaXMuX2Rlc2lnbmVkU2NyZWVuKSk7CiAgICB9LCBVSVNjYWxlci5yZXNpemVCYWNrZ3JvdW5kID0gZnVuY3Rpb24oYml0bWFwKSB7CiAgICAgICAgaWYgKGluaXRpYWxpemVkKSB7CiAgICAgICAgICAgIHZhciBoLCB3LCBzY2FsZTsKICAgICAgICAgICAgaCA9IGJpdG1hcC5oZWlnaHQgLyBiaXRtYXAuc2NhbGUueSwgdyA9IGJpdG1hcC53aWR0aCAvIGJpdG1hcC5zY2FsZS54LCBzY2FsZSA9IGN1cnJlbnRTY3JlZW4uaGVpZ2h0IC8gaCwgCiAgICAgICAgICAgIGJpdG1hcC5zY2FsZS54ID0gYml0bWFwLnNjYWxlLnkgPSBzY2FsZSwgYml0bWFwLnBvc2l0aW9uLnggPSAuNSAqIChjdXJyZW50U2NyZWVuLndpZHRoIC0gYml0bWFwLndpZHRoKTsKICAgICAgICB9CiAgICB9LCBVSVNjYWxlci5yZXNpemVCYWNrZ3JvdW5kcyA9IGZ1bmN0aW9uKGJpdG1hcHMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gYml0bWFwcy5sZW5ndGg7IGxlbiA+IGk7ICsraSkgVUlTY2FsZXIucmVzaXplQmFja2dyb3VuZChiaXRtYXBzW2ldKTsKICAgIH0sIHAucmVzaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuX2l0ZW1zLmxlbmd0aCA+IDApIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLl9pdGVtcy5sZW5ndGg7IGxlbiA+IGk7ICsraSkgdGhpcy5faXRlbXNbaV0ucmVzaXplKGN1cnJlbnRTY3JlZW4pOwogICAgfSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuX2l0ZW1zLmxlbmd0aCA+IDApIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLl9pdGVtcy5sZW5ndGg7IGxlbiA+IGk7ICsraSkgdGhpcy5faXRlbXNbaV0uZGVzdHJveSgpOwogICAgICAgIHRoaXMuX3BhcmVudCA9IG51bGwsIHRoaXMuX2Rlc2lnbmVkU2NyZWVuID0gbnVsbCwgdGhpcy5faXRlbXMgPSBudWxsOwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLlVJU2NhbGVyID0gVUlTY2FsZXI7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgQXNzZXRNYW5hZ2VyID0ge307CiAgICBBc3NldE1hbmFnZXIuc2NhbGVzID0gbnVsbDsKICAgIHZhciBzaXplcyA9IG51bGwsIGFzc2V0cyA9IG51bGwsIGFzc2V0VXJsQ2FjaGUgPSBudWxsLCBzY2FsZXMgPSBudWxsLCBwYXRocyA9IG51bGwsIHNpemVPcmRlciA9IG51bGw7CiAgICBBc3NldE1hbmFnZXIubG93SFcgPSAhMSwgQXNzZXRNYW5hZ2VyLmluaXQgPSBmdW5jdGlvbihjb25maWcsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICBBc3NldE1hbmFnZXIuc2NhbGVzID0ge30sIGFzc2V0cyA9IGNvbmZpZy5hc3NldHMsIGFzc2V0VXJsQ2FjaGUgPSB7fSwgcGF0aHMgPSBjb25maWcucGF0aCwgCiAgICAgICAgc2l6ZXMgPSBjb25maWcuc2l6aW5nLCBzY2FsZXMgPSBjb25maWcuc2NhbGUsIHBpY2tTY2FsZSh3aWR0aCwgaGVpZ2h0KTsKICAgIH0sIEFzc2V0TWFuYWdlci5nZXRQcmVmZXJyZWRTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNpemVPcmRlclswXTsKICAgIH0sIEFzc2V0TWFuYWdlci5nZXRQcmVmZXJyZWRTY2FsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzY2FsZXNbc2l6ZU9yZGVyWzBdXTsKICAgIH07CiAgICB2YXIgcGlja1NjYWxlID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIGZvciAodmFyIHMsIG1pblNpemUgPSBoZWlnaHQgPiB3aWR0aCA/IHdpZHRoIDogaGVpZ2h0LCBpID0gc2l6ZXMubGVuZ3RoIC0gMTsgaSA+PSAwICYmIHNpemVzW2ldLm1heFNpemUgPiBtaW5TaXplOyAtLWkpIHMgPSBzaXplc1tpXTsKICAgICAgICBzaXplT3JkZXIgPSBzLm9yZGVyOwogICAgfTsKICAgIEFzc2V0TWFuYWdlci5nZXRVcmwgPSBmdW5jdGlvbihhc3NldElkKSB7CiAgICAgICAgdmFyIGEgPSBhc3NldHNbYXNzZXRJZF07CiAgICAgICAgaWYgKCFhKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoYXNzZXRVcmxDYWNoZVthc3NldElkXSkgcmV0dXJuIGFzc2V0VXJsQ2FjaGVbYXNzZXRJZF07CiAgICAgICAgdmFyIHVybDsKICAgICAgICBpZiAoYS5hbmltKSByZXR1cm4gdXJsID0gYXNzZXRVcmxDYWNoZVthc3NldElkXSA9IHBhdGhzLmFuaW0gKyBhLnNyYzsKICAgICAgICBpZiAoQXNzZXRNYW5hZ2VyLmxvd0hXICYmIGEubG93SFcpIHJldHVybiBBc3NldE1hbmFnZXIuc2NhbGVzW2Fzc2V0SWRdID0gc2NhbGVzW2EubG93SFddLCAKICAgICAgICB1cmwgPSBhc3NldFVybENhY2hlW2Fzc2V0SWRdID0gcGF0aHNbYS5sb3dIV10gKyBhLnNyYzsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpemVPcmRlci5sZW5ndGg7ICsraSkgewogICAgICAgICAgICB2YXIgdHlwZUlkID0gc2l6ZU9yZGVyW2ldOwogICAgICAgICAgICBpZiAoYVt0eXBlSWRdKSByZXR1cm4gQXNzZXRNYW5hZ2VyLnNjYWxlc1thc3NldElkXSA9IHNjYWxlc1t0eXBlSWRdLCB1cmwgPSBhc3NldFVybENhY2hlW2Fzc2V0SWRdID0gcGF0aHNbdHlwZUlkXSArIGEuc3JjOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sIEFzc2V0TWFuYWdlci51bmxvYWQgPSBmdW5jdGlvbihhc3NldE9yQXNzZXRzKSB7CiAgICAgICAgaWYgKGFzc2V0T3JBc3NldHMgaW5zdGFuY2VvZiBBcnJheSkgZm9yICh2YXIgaSA9IGFzc2V0T3JBc3NldHMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgICAgdmFyIGlkID0gYXNzZXRPckFzc2V0c1tpXTsKICAgICAgICAgICAgdW5sb2FkQXNzZXQoaWQpOwogICAgICAgIH0gZWxzZSB1bmxvYWRBc3NldChhc3NldE9yQXNzZXRzKTsKICAgIH07CiAgICB2YXIgdW5sb2FkQXNzZXQgPSBmdW5jdGlvbihhc3NldCkgewogICAgICAgIGlmIChhc3NldFVybENhY2hlW2Fzc2V0XSkgewogICAgICAgICAgICB2YXIgYSA9IGFzc2V0c1thc3NldF07CiAgICAgICAgICAgIGEgJiYgKGEuYW5pbSB8fCAoYS5pc0ZvbnQgJiYgUElYSS5CaXRtYXBUZXh0LmZvbnRzW2Fzc2V0XSAmJiBkZWxldGUgUElYSS5CaXRtYXBUZXh0LmZvbnRzW2Fzc2V0XSwgCiAgICAgICAgICAgIFBJWEkuVGV4dHVyZS5kZXN0cm95VGV4dHVyZShhc3NldFVybENhY2hlW2Fzc2V0XSksIGRlbGV0ZSBBc3NldE1hbmFnZXIuc2NhbGVzW2Fzc2V0XSwgCiAgICAgICAgICAgIGRlbGV0ZSBhc3NldFVybENhY2hlW2Fzc2V0XSkpOwogICAgICAgIH0KICAgIH07CiAgICBBc3NldE1hbmFnZXIuZ2V0QW5pbXMgPSBmdW5jdGlvbihhbmltcywgbWF4RGlnaXRzLCBvdXRPYmopIHsKICAgICAgICB2b2lkIDAgPT09IG1heERpZ2l0cyAmJiAobWF4RGlnaXRzID0gNCksIDAgPiBtYXhEaWdpdHMgJiYgKG1heERpZ2l0cyA9IDApOwogICAgICAgIHZhciBpLCBjLCB6ZXJvcyA9IFtdLCBjb21wYXJlcyA9IFtdOwogICAgICAgIGZvciAoaSA9IDE7IG1heERpZ2l0cyA+IGk7ICsraSkgewogICAgICAgICAgICB2YXIgcyA9ICIiOwogICAgICAgICAgICBjID0gMTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGkgPiBqOyArK2opIHMgKz0gIjAiLCBjICo9IDEwOwogICAgICAgICAgICB6ZXJvcy51bnNoaWZ0KHMpLCBjb21wYXJlcy5wdXNoKGMpOwogICAgICAgIH0KICAgICAgICB2YXIgcHJldlRleCwgbGVuLCBjb21wYXJlTGVuZ3RoID0gY29tcGFyZXMubGVuZ3RoLCBydG5EaWN0ID0gb3V0T2JqIHx8IHt9LCBmcm9tRnJhbWUgPSBQSVhJLlRleHR1cmUuZnJvbUZyYW1lOwogICAgICAgIGZvciAodmFyIGEgaW4gYW5pbXMpIHsKICAgICAgICAgICAgdmFyIGRhdGEgPSBhbmltc1thXSwgbGlzdCA9IFtdOwogICAgICAgICAgICBmb3IgKGkgPSBkYXRhLm51bWJlck1pbiwgbGVuID0gZGF0YS5udW1iZXJNYXg7IGxlbiA+PSBpOyArK2kpIHsKICAgICAgICAgICAgICAgIHZhciBudW0gPSBudWxsOwogICAgICAgICAgICAgICAgZm9yIChjID0gMDsgY29tcGFyZUxlbmd0aCA+IGM7ICsrYykgaWYgKGkgPCBjb21wYXJlc1tjXSkgewogICAgICAgICAgICAgICAgICAgIG51bSA9IHplcm9zW2NdICsgaTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG51bSB8fCAobnVtID0gaS50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIHZhciB0ZXhOYW1lID0gZGF0YS5uYW1lLnJlcGxhY2UoIiMiLCBudW0pLCB0ZXggPSBmcm9tRnJhbWUodGV4TmFtZSwgITApOwogICAgICAgICAgICAgICAgdGV4ICYmIChwcmV2VGV4ID0gdGV4KSwgbGlzdC5wdXNoKHByZXZUZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJ0bkRpY3RbYV0gPSBsaXN0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcnRuRGljdDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5Bc3NldE1hbmFnZXIgPSBBc3NldE1hbmFnZXI7Cn0oKTs=",
                "body": "IWZ1bmN0aW9uKHVuZGVmaW5lZCkgewogICAgdmFyIE9TID0gZnVuY3Rpb24oKSB7fSwgcCA9IE9TLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZSksIF9wYXVzZWQgPSAhMSwgX2lzUmVhZHkgPSAhMSwgX2ZyYW1lcmF0ZSA9IG51bGwsIF9sYXN0RnJhbWVUaW1lID0gMCwgX2xhc3RGUFNVcGRhdGVUaW1lID0gMCwgX2ZyYW1lcmF0ZVZhbHVlID0gbnVsbCwgX2ZyYW1lQ291bnQgPSAwLCBfdGlja0NhbGxiYWNrID0gbnVsbCwgX2luc3RhbmNlID0gbnVsbCwgX3RpY2tJZCA9IC0xLCBfdXNlUkFGID0gITEsIF9mcHMgPSAwLCBfbXNQZXJGcmFtZSA9IDA7CiAgICBPUy5WRVJTSU9OID0gIjEuMS4yNyIsIHAuc3RhZ2UgPSBudWxsLCBwLl9yZW5kZXJlciA9IG51bGwsIHAuY2FudmFzQ29udGFpbmVyID0gbnVsbCwgCiAgICBwLl9hcHAgPSBudWxsLCBwLm9wdGlvbnMgPSBudWxsLCBwLl91cGRhdGVGdW5jdGlvbnMgPSB7fSwgT1MuaW5pdCA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBfaW5zdGFuY2UgfHwgKERlYnVnLmxvZygiQ3JlYXRpbmcgdGhlIHNpbmdsZXRvbiBpbnN0YW5jZSBvZiBPUyIpLCBfaW5zdGFuY2UgPSBuZXcgT1MoKSwgCiAgICAgICAgX2luc3RhbmNlLmluaXRpYWxpemUoc3RhZ2VOYW1lLCBvcHRpb25zKSksIF9pbnN0YW5jZTsKICAgIH0sIHAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykgewogICAgICAgIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5jYWxsKHRoaXMpLCB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9LCB0aGlzLm9wdGlvbnMucGFyc2VRdWVyeVN0cmluZyAhPT0gdW5kZWZpbmVkICYmICh0aGlzLm9wdGlvbnMgPSBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zKHRoaXMub3B0aW9ucykpLCAKICAgICAgICB0aGlzLm9wdGlvbnMuZGVidWcgIT09IHVuZGVmaW5lZCAmJiAoRGVidWcuZW5hYmxlZCA9IHRoaXMub3B0aW9ucy5kZWJ1ZyA9PT0gITAgfHwgInRydWUiID09PSB0aGlzLm9wdGlvbnMuZGVidWcpLCAKICAgICAgICB0aGlzLm9wdGlvbnMubWluTG9nTGV2ZWwgIT09IHVuZGVmaW5lZCAmJiAoRGVidWcubWluTG9nTGV2ZWwgPSBwYXJzZUludCh0aGlzLm9wdGlvbnMubWluTG9nTGV2ZWwsIDEwKSksIAogICAgICAgICJzdHJpbmciID09IHR5cGVvZiB0aGlzLm9wdGlvbnMuaXAgJiYgRGVidWcuY29ubmVjdCh0aGlzLm9wdGlvbnMuaXApOwogICAgICAgIHZhciBsb2FkZXIgPSBjbG91ZGtpZC5NZWRpYUxvYWRlci5pbml0KCk7CiAgICAgICAgdGhpcy5zdGFnZSA9IG5ldyBQSVhJLlN0YWdlKHRoaXMub3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IgfHwgMCwgITApLCB0aGlzLnN0YWdlLmFkZENoaWxkKHRoaXMpLCAKICAgICAgICB0aGlzLnZpc2libGVMaXN0ZW5lciA9IHRoaXMub25XaW5kb3dWaXNpYmlsaXR5Q2hhbmdlZC5iaW5kKHRoaXMpLCBhZGRQYWdlSGlkZUxpc3RlbmVyKHRoaXMudmlzaWJsZUxpc3RlbmVyKTsKICAgICAgICB2YXIgdHJhbnNwYXJlbnQgPSAhIXRoaXMub3B0aW9ucy50cmFuc3BhcmVudCB8fCAhMSwgcHJlTXVsdEFscGhhID0gISF0aGlzLm9wdGlvbnMucHJlTXVsdEFscGhhIHx8ICExOwogICAgICAgIHRoaXMuY29udGFpbmVyTmFtZSA9ICJzdHJpbmciID09IHR5cGVvZiBzdGFnZU5hbWUgPyBzdGFnZU5hbWUgOiBzdGFnZU5hbWUuYXR0cigiaWQiKTsKICAgICAgICB2YXIgY29udGFpbmVyID0gInN0cmluZyIgPT0gdHlwZW9mIHN0YWdlTmFtZSA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHN0YWdlTmFtZSkgOiBzdGFnZU5hbWUsIGNhbnZhc0NvbnRhaW5lciA9IHRoaXMuY2FudmFzQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGNhbnZhc0NvbnRhaW5lciksIGNhbnZhc0NvbnRhaW5lci5pZCA9ICJDS09TIjsKICAgICAgICB2YXIgd2lkdGggPSB0aGlzLm9wdGlvbnMud2lkdGggfHwgY29udGFpbmVyLmlubmVyV2lkdGgsIGhlaWdodCA9IHRoaXMub3B0aW9ucy5oZWlnaHQgfHwgY29udGFpbmVyLmlubmVySGVpZ2h0OwogICAgICAgIGlmICh0aGlzLl9yZW5kZXJlciA9ICJjYW52YXMyZCIgPT0gdGhpcy5vcHRpb25zLmZvcmNlQ29udGV4dCA/IG5ldyBQSVhJLkNhbnZhc1JlbmRlcmVyKHdpZHRoLCBoZWlnaHQsIG51bGwsIHRyYW5zcGFyZW50KSA6ICJ3ZWJnbCIgPT0gdGhpcy5vcHRpb25zLmZvcmNlQ29udGV4dCA/IG5ldyBQSVhJLldlYkdMUmVuZGVyZXIod2lkdGgsIGhlaWdodCwgbnVsbCwgdHJhbnNwYXJlbnQsIHByZU11bHRBbHBoYSkgOiBQSVhJLmF1dG9EZXRlY3RSZW5kZXJlcih3aWR0aCwgaGVpZ2h0LCBudWxsLCB0cmFuc3BhcmVudCwgcHJlTXVsdEFscGhhKSwgCiAgICAgICAgY2FudmFzQ29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuX3JlbmRlcmVyLnZpZXcpLCBjYW52YXNDb250YWluZXIuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJwb3NpdGlvbjpyZWxhdGl2ZTt3aWR0aDoiICsgd2lkdGggKyAicHg7aGVpZ2h0OiIgKyBoZWlnaHQgKyAicHgiKSwgCiAgICAgICAgdGhpcy5fcmVuZGVyZXIuY2xlYXJWaWV3ID0gISF0aGlzLm9wdGlvbnMuY2xlYXJWaWV3LCB0aGlzLm9wdGlvbnMuc2hvd0ZyYW1lcmF0ZSAmJiAoX2ZyYW1lcmF0ZSA9IG5ldyBQSVhJLlRleHQoIkZQUzogMC4wMDAiLCB7CiAgICAgICAgICAgIGZvbnQ6ICIxMHB4IEFyaWFsIiwKICAgICAgICAgICAgZmlsbDogImJsYWNrIiwKICAgICAgICAgICAgc3Ryb2tlOiAid2hpdGUiLAogICAgICAgICAgICBzdHJva2VUaGlja25lc3M6IDIKICAgICAgICB9KSwgX2ZyYW1lcmF0ZS54ID0gX2ZyYW1lcmF0ZS55ID0gNSwgdGhpcy5hZGRDaGlsZChfZnJhbWVyYXRlKSksIHRoaXMuX3JlbmRlcmVyLnJlbmRlcih0aGlzLnN0YWdlKSwgCiAgICAgICAgX3RpY2tDYWxsYmFjayA9IHRoaXMudGljay5iaW5kKHRoaXMpLCBfdXNlUkFGID0gdGhpcy5vcHRpb25zLnJhZiB8fCAhMSwgdGhpcy5mcHMgPSB0aGlzLm9wdGlvbnMuZnBzIHx8IDYwLCAKICAgICAgICB0aGlzLnJlbW92ZUFwcCgpLCB0aGlzLm9wdGlvbnMudmVyc2lvbnNGaWxlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgX2lzUmVhZHkgPSAhMTsKICAgICAgICAgICAgdmFyIG9zID0gdGhpczsKICAgICAgICAgICAgbG9hZGVyLmNhY2hlTWFuYWdlci5hZGRWZXJzaW9uc0ZpbGUodGhpcy5vcHRpb25zLnZlcnNpb25zRmlsZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBfaXNSZWFkeSA9ICEwLCBvcy5fYXBwICYmIChvcy5hZGRDaGlsZEF0KG9zLl9hcHAsIDApLCBvcy5fYXBwLmluaXQoKSwgb3MucmVzdW1lKCkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgX2lzUmVhZHkgPSAhMDsKICAgIH07CiAgICB2YXIgaGlkZGVuID0gbnVsbCwgZXZ0TWFwID0gbnVsbCwgdiA9ICJ2aXNpYmxlIiwgaCA9ICJoaWRkZW4iLCBhZGRQYWdlSGlkZUxpc3RlbmVyID0gZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICBoaWRkZW4gPSAiaGlkZGVuIiwgaGlkZGVuIGluIGRvY3VtZW50ID8gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSA6IChoaWRkZW4gPSAibW96SGlkZGVuIikgaW4gZG9jdW1lbnQgPyBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3p2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpIDogKGhpZGRlbiA9ICJ3ZWJraXRIaWRkZW4iKSBpbiBkb2N1bWVudCA/IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIndlYmtpdHZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcikgOiAoaGlkZGVuID0gIm1zSGlkZGVuIikgaW4gZG9jdW1lbnQgPyBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtc3Zpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcikgOiAib25mb2N1c2luIiBpbiBkb2N1bWVudCA/IChldnRNYXAgPSB7CiAgICAgICAgICAgIGZvY3VzaW46IHYsCiAgICAgICAgICAgIGZvY3Vzb3V0OiBoCiAgICAgICAgfSwgZG9jdW1lbnQub25mb2N1c2luID0gZG9jdW1lbnQub25mb2N1c291dCA9IGxpc3RlbmVyKSA6IChldnRNYXAgPSB7CiAgICAgICAgICAgIGZvY3VzOiB2LAogICAgICAgICAgICBwYWdlc2hvdzogdiwKICAgICAgICAgICAgYmx1cjogaCwKICAgICAgICAgICAgcGFnZWhpZGU6IGgKICAgICAgICB9LCB3aW5kb3cub25wYWdlc2hvdyA9IHdpbmRvdy5vbnBhZ2VoaWRlID0gd2luZG93Lm9uZm9jdXMgPSB3aW5kb3cub25ibHVyID0gbGlzdGVuZXIpOwogICAgfSwgcmVtb3ZlUGFnZUhpZGVMaXN0ZW5lciA9IGZ1bmN0aW9uKGxpc3RlbmVyKSB7CiAgICAgICAgdmFyIGhpZGRlbiA9ICJoaWRkZW4iOwogICAgICAgIGhpZGRlbiBpbiBkb2N1bWVudCA/IGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcikgOiAoaGlkZGVuID0gIm1vekhpZGRlbiIpIGluIGRvY3VtZW50ID8gZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW96dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSA6IChoaWRkZW4gPSAid2Via2l0SGlkZGVuIikgaW4gZG9jdW1lbnQgPyBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJ3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpIDogKGhpZGRlbiA9ICJtc0hpZGRlbiIpIGluIGRvY3VtZW50ICYmIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1zdmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSwgCiAgICAgICAgZG9jdW1lbnQub25mb2N1c2luID0gZG9jdW1lbnQub25mb2N1c291dCA9IG51bGwsIHdpbmRvdy5vbnBhZ2VzaG93ID0gd2luZG93Lm9ucGFnZWhpZGUgPSB3aW5kb3cub25mb2N1cyA9IHdpbmRvdy5vbmJsdXIgPSBudWxsOwogICAgfTsKICAgIHAub25XaW5kb3dWaXNpYmlsaXR5Q2hhbmdlZCA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgIHZhciB2ID0gInZpc2libGUiLCBoID0gImhpZGRlbiI7CiAgICAgICAgZXZ0ID0gZXZ0IHx8IHdpbmRvdy5ldmVudDsKICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgdmFsdWUgPSBldnRNYXAgPyBldnRNYXBbZXZ0LnR5cGVdIDogZG9jdW1lbnRbaGlkZGVuXSA/IGggOiB2LCB2YWx1ZSA9PSBoID8gdGhpcy5wYXVzZSgpIDogdGhpcy5yZXN1bWUoKTsKICAgIH07CiAgICB2YXIgcGFyc2VRdWVyeVN0cmluZ1BhcmFtcyA9IGZ1bmN0aW9uKG91dHB1dCkgewogICAgICAgIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWYsIHF1ZXN0aW9uTWFyayA9IGhyZWYuaW5kZXhPZigiPyIpOwogICAgICAgIGlmICgtMSA9PSBxdWVzdGlvbk1hcmspIHJldHVybiBvdXRwdXQ7CiAgICAgICAgdmFyIHZhcnMgPSAwID4gcXVlc3Rpb25NYXJrID8gIiIgOiBocmVmLnN1YnN0cihxdWVzdGlvbk1hcmsgKyAxKSwgcG91bmQgPSB2YXJzLmluZGV4T2YoIiMiKTsKICAgICAgICB2YXJzID0gMCA+IHBvdW5kID8gdmFycyA6IHZhcnMuc3Vic3RyaW5nKDAsIHBvdW5kKTsKICAgICAgICBmb3IgKHZhciBteVZhciwgc3BsaXRGbGFzaFZhcnMgPSB2YXJzLnNwbGl0KCImIiksIGkgPSAwOyBpIDwgc3BsaXRGbGFzaFZhcnMubGVuZ3RoOyBpKyspIG15VmFyID0gc3BsaXRGbGFzaFZhcnNbaV0uc3BsaXQoIj0iKSwgCiAgICAgICAgRGVidWcubG9nKG15VmFyWzBdICsgIiAtPiAiICsgbXlWYXJbMV0pLCBvdXRwdXRbbXlWYXJbMF1dID0gbXlWYXJbMV07CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH07CiAgICBwLnBhdXNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgLTEgIT0gX3RpY2tJZCAmJiAoX3VzZVJBRiA/IHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSAmJiBjYW5jZWxBbmltYXRpb25GcmFtZShfdGlja0lkKSA6IGNsZWFyVGltZW91dChfdGlja0lkKSwgCiAgICAgICAgX3RpY2tJZCA9IC0xKSwgX3BhdXNlZCA9ICEwOwogICAgfTsKICAgIHZhciBub3dGdW5jID0gd2luZG93LnBlcmZvcm1hbmNlICYmIChwZXJmb3JtYW5jZS5ub3cgfHwgcGVyZm9ybWFuY2UubW96Tm93IHx8IHBlcmZvcm1hbmNlLm1zTm93IHx8IHBlcmZvcm1hbmNlLm9Ob3cgfHwgcGVyZm9ybWFuY2Uud2Via2l0Tm93KTsKICAgIG5vd0Z1bmMgPSBub3dGdW5jID8gbm93RnVuYy5iaW5kKHBlcmZvcm1hbmNlKSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIH0sIHAuZ2V0VGltZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBub3dGdW5jKCk7CiAgICB9LCBwLnJlc3VtZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIF9wYXVzZWQgPSAhMSwgLTEgPT0gX3RpY2tJZCAmJiAoX3RpY2tJZCA9IF91c2VSQUYgPyByZXF1ZXN0QW5pbUZyYW1lKF90aWNrQ2FsbGJhY2spIDogc2V0VGFyZ2V0ZWRUaW1lb3V0KF90aWNrQ2FsbGJhY2spKSwgCiAgICAgICAgX2xhc3RGUFNVcGRhdGVUaW1lID0gX2xhc3RGcmFtZVRpbWUgPSB0aGlzLmdldFRpbWUoKTsKICAgIH0sIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiZnBzIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBfZnBzOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAibnVtYmVyIiA9PSB0eXBlb2YgdmFsdWUgJiYgKF9mcHMgPSB2YWx1ZSwgX21zUGVyRnJhbWUgPSAxZTMgLyBfZnBzIHwgMCk7CiAgICAgICAgfQogICAgfSksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAic3RhZ2VXaWR0aCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gX2luc3RhbmNlLl9yZW5kZXJlci52aWV3LndpZHRoOwogICAgICAgIH0KICAgIH0pLCBPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInN0YWdlSGVpZ2h0IiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBfaW5zdGFuY2UuX3JlbmRlcmVyLnZpZXcuaGVpZ2h0OwogICAgICAgIH0KICAgIH0pOwogICAgdmFyIHNldFRhcmdldGVkVGltZW91dCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aW1lSW5GcmFtZSkgewogICAgICAgIHZhciB0aW1lVG9DYWxsID0gMDsKICAgICAgICByZXR1cm4gdGltZUluRnJhbWUgJiYgKHRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCBfbXNQZXJGcmFtZSAtIHRpbWVJbkZyYW1lKSksIHNldFRpbWVvdXQoY2FsbGJhY2ssIHRpbWVUb0NhbGwpOwogICAgfTsKICAgIHAucmVtb3ZlQXBwID0gZnVuY3Rpb24oZGVzdHJveWluZykgewogICAgICAgIHZhciByZW1vdmVkID0gITEsIHN0YWdlID0gdGhpcy5zdGFnZTsKICAgICAgICByZXR1cm4gdGhpcy5fYXBwICYmICh0aGlzLl9hcHAucGFyZW50ID09IHRoaXMgJiYgdGhpcy5yZW1vdmVDaGlsZCh0aGlzLl9hcHApLCBzdGFnZS5yZW1vdmVDaGlsZHJlbigpLCAKICAgICAgICB0aGlzLl9hcHAuZGVzdHJveSgpLCByZW1vdmVkID0gITApLCB0aGlzLl9hcHAgPSBudWxsLCB0aGlzLnBhdXNlKCksIGRlc3Ryb3lpbmcgfHwgKHN0YWdlLmFkZENoaWxkKHRoaXMpLCAKICAgICAgICBfZnJhbWVyYXRlICYmIChfZnJhbWVyYXRlLnRleHQgPSAiRlBTOiAwLjAwMCIpLCBfbGFzdEZyYW1lVGltZSA9IF9sYXN0RlBTVXBkYXRlVGltZSA9IF9mcmFtZXJhdGVWYWx1ZSA9IF9mcmFtZUNvdW50ID0gMCwgCiAgICAgICAgdGhpcy5fcmVuZGVyZXIucmVuZGVyKHN0YWdlKSksIHJlbW92ZWQ7CiAgICB9LCBwLmFkZEFwcCA9IGZ1bmN0aW9uKGFwcCkgewogICAgICAgIGlmICh0aGlzLnJlbW92ZUFwcCgpLCAhKGFwcCBpbnN0YW5jZW9mIGNsb3Vka2lkLkFwcGxpY2F0aW9uKSkgdGhyb3cgbmV3IEVycm9yKCJDYW4gb25seSBvYmplY3RzIHRoYXQgaW5oZXJpdCBjbG91ZGtpZC5BcHBsaWNhdGlvbiIpOwogICAgICAgIHRoaXMuX2FwcCA9IGFwcCwgX2lzUmVhZHkgJiYgKHRoaXMuYWRkQ2hpbGRBdChhcHAsIDApLCB0aGlzLl9hcHAuaW5pdCgpLCB0aGlzLnJlc3VtZSgpKTsKICAgIH0sIHAuZ2V0QXBwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2FwcDsKICAgIH0sIHAuYWRkVXBkYXRlQ2FsbGJhY2sgPSBmdW5jdGlvbihhbGlhcywgZikgewogICAgICAgIHRoaXMuX3VwZGF0ZUZ1bmN0aW9uc1thbGlhc10gPT09IHVuZGVmaW5lZCAmJiAodGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9IGYpOwogICAgfSwgcC5yZW1vdmVVcGRhdGVDYWxsYmFjayA9IGZ1bmN0aW9uKGFsaWFzKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSAhPT0gdW5kZWZpbmVkICYmIGRlbGV0ZSB0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdOwogICAgfSwgcC50aWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKF9wYXVzZWQpIHJldHVybiB2b2lkIChfdGlja0lkID0gLTEpOwogICAgICAgIHZhciBub3cgPSB0aGlzLmdldFRpbWUoKSwgZFRpbWUgPSBub3cgLSBfbGFzdEZyYW1lVGltZTsKICAgICAgICBpZiAoX2ZyYW1lcmF0ZSAmJiBfZnJhbWVyYXRlLnZpc2libGUpIHsKICAgICAgICAgICAgX2ZyYW1lQ291bnQrKzsKICAgICAgICAgICAgdmFyIGVsYXBzZWQgPSBub3cgLSBfbGFzdEZQU1VwZGF0ZVRpbWU7CiAgICAgICAgICAgIGVsYXBzZWQgPiAxZTMgJiYgKF9mcmFtZXJhdGVWYWx1ZSA9IDFlMyAvIGVsYXBzZWQgKiBfZnJhbWVDb3VudCwgX2ZyYW1lcmF0ZS5zZXRUZXh0KCJGUFM6ICIgKyBNYXRoLnJvdW5kKDFlMyAqIF9mcmFtZXJhdGVWYWx1ZSkgLyAxZTMpLCAKICAgICAgICAgICAgX2xhc3RGUFNVcGRhdGVUaW1lID0gbm93LCBfZnJhbWVDb3VudCA9IDApOwogICAgICAgIH0KICAgICAgICBfbGFzdEZyYW1lVGltZSA9IG5vdywgdGhpcy5fYXBwICYmIHRoaXMuX2FwcC51cGRhdGUoZFRpbWUpOwogICAgICAgIGZvciAodmFyIGFsaWFzIGluIHRoaXMuX3VwZGF0ZUZ1bmN0aW9ucykgdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXShkVGltZSk7CiAgICAgICAgdGhpcy5fcmVuZGVyZXIucmVuZGVyKHRoaXMuc3RhZ2UpLCBfdGlja0lkID0gX3VzZVJBRiA/IHJlcXVlc3RBbmltRnJhbWUoX3RpY2tDYWxsYmFjaykgOiBzZXRUYXJnZXRlZFRpbWVvdXQoX3RpY2tDYWxsYmFjaywgdGhpcy5nZXRUaW1lKCkgLSBfbGFzdEZyYW1lVGltZSk7CiAgICB9LCBwLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICB0aGlzLl9yZW5kZXJlci5yZXNpemUod2lkdGgsIGhlaWdodCksIHRoaXMuY2FudmFzQ29udGFpbmVyLnNldEF0dHJpYnV0ZSgic3R5bGUiLCAicG9zaXRpb246cmVsYXRpdmU7d2lkdGg6IiArIHdpZHRoICsgInB4O2hlaWdodDoiICsgaGVpZ2h0ICsgInB4Iik7CiAgICB9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc3RhZ2UgPSB0aGlzLnN0YWdlLCBtbCA9IGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluc3RhbmNlOwogICAgICAgIHRoaXMucGF1c2UoKSwgdGhpcy5yZW1vdmVBcHAoITApLCBfaW5zdGFuY2UgPSBudWxsLCBtbC5kZXN0cm95KCksIHRoaXMuc3RhZ2UgPSBudWxsLCAKICAgICAgICB0aGlzLl91cGRhdGVGdW5jdGlvbnMgPSBudWxsLCByZW1vdmVQYWdlSGlkZUxpc3RlbmVyKHRoaXMudmlzaWJsZUxpc3RlbmVyKSwgdGhpcy5yZW1vdmVDaGlsZHJlbighMCksIAogICAgICAgIHN0YWdlLmRlc3Ryb3koKSwgdGhpcy5fcmVuZGVyZXIuZGVzdHJveSgpLCB0aGlzLl9yZW5kZXJlciA9IG51bGwsIHRoaXMuY2FudmFzQ29udGFpbmVyID0gbnVsbDsKICAgIH0sIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShPUywgImluc3RhbmNlIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghX2luc3RhbmNlKSB0aHJvdyAiQ2FsbCBjbG91ZGtpZC5PUy5pbml0KGNhbnZhc0lkKSI7CiAgICAgICAgICAgIHJldHVybiBfaW5zdGFuY2U7CiAgICAgICAgfQogICAgfSksIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5PUyA9IE9TOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFNhdmVkRGF0YSA9IHt9LCBXRUJfU1RPUkFHRV9TVVBQT1JUID0gInVuZGVmaW5lZCIgIT0gdHlwZW9mIHdpbmRvdy5TdG9yYWdlLCBFUkFTRV9DT09LSUUgPSAtMTsKICAgIGlmIChXRUJfU1RPUkFHRV9TVVBQT1JUKSB0cnkgewogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJMU19URVNUIiwgInRlc3QiKSwgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oIkxTX1RFU1QiKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBXRUJfU1RPUkFHRV9TVVBQT1JUID0gITE7CiAgICB9CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2F2ZWREYXRhLCAidXNlV2ViU3RvcmFnZSIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gV0VCX1NUT1JBR0VfU1VQUE9SVDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICYmICJ1bmRlZmluZWQiICE9IHR5cGVvZiB3aW5kb3cuU3RvcmFnZSkgdHJ5IHsKICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJMU19URVNUIiwgInRlc3QiKSwgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oIkxTX1RFU1QiKSwgV0VCX1NUT1JBR0VfU1VQUE9SVCA9ICEwOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBXRUJfU1RPUkFHRV9TVVBQT1JUID0gITE7CiAgICAgICAgICAgIH0gZWxzZSBXRUJfU1RPUkFHRV9TVVBQT1JUID0gITE7CiAgICAgICAgfQogICAgfSksIFNhdmVkRGF0YS5yZW1vdmUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgV0VCX1NUT1JBR0VfU1VQUE9SVCA/IChsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShuYW1lKSwgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbShuYW1lKSkgOiBTYXZlZERhdGEud3JpdGUobmFtZSwgIiIsIEVSQVNFX0NPT0tJRSk7CiAgICB9LCBTYXZlZERhdGEud3JpdGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgdGVtcE9ubHkpIHsKICAgICAgICBpZiAoV0VCX1NUT1JBR0VfU1VQUE9SVCkgdGVtcE9ubHkgPyBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSkgOiBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShuYW1lLCBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpOyBlbHNlIHsKICAgICAgICAgICAgdmFyIGV4cGlyZXM7CiAgICAgICAgICAgIGV4cGlyZXMgPSB0ZW1wT25seSA/IHRlbXBPbmx5ICE9PSBFUkFTRV9DT09LSUUgPyAiIiA6ICI7IGV4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBHTVQiIDogIjsgZXhwaXJlcz0iICsgbmV3IERhdGUoMjE0NzQ4MzY0NmUzKS50b0dNVFN0cmluZygpLCAKICAgICAgICAgICAgZG9jdW1lbnQuY29va2llID0gbmFtZSArICI9IiArIGVzY2FwZShKU09OLnN0cmluZ2lmeSh2YWx1ZSkpICsgZXhwaXJlcyArICI7IHBhdGg9LyI7CiAgICAgICAgfQogICAgfSwgU2F2ZWREYXRhLnJlYWQgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgaWYgKFdFQl9TVE9SQUdFX1NVUFBPUlQpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0obmFtZSkgfHwgc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShuYW1lKTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gSlNPTi5wYXJzZSh2YWx1ZSkgOiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYywgbmFtZUVRID0gbmFtZSArICI9IiwgY2EgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoIjsiKSwgaSA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGZvciAoYyA9IGNhW2ldOyAiICIgPT0gYy5jaGFyQXQoMCk7ICkgYyA9IGMuc3Vic3RyaW5nKDEsIGMubGVuZ3RoKTsKICAgICAgICAgICAgaWYgKDAgPT09IGMuaW5kZXhPZihuYW1lRVEpKSByZXR1cm4gSlNPTi5wYXJzZSh1bmVzY2FwZShjLnN1YnN0cmluZyhuYW1lRVEubGVuZ3RoLCBjLmxlbmd0aCkpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuU2F2ZWREYXRhID0gU2F2ZWREYXRhOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgd2luZG93LlVSTCA9IHdpbmRvdy5VUkwgfHwgd2luZG93LndlYmtpdFVSTCwgd2luZG93LkJsb2JCdWlsZGVyID0gd2luZG93LkJsb2JCdWlsZGVyIHx8IHdpbmRvdy5XZWJLaXRCbG9iQnVpbGRlciB8fCB3aW5kb3cuTW96QmxvYkJ1aWxkZXI7CiAgICB2YXIgV29ya2VyID0ge307CiAgICBXb3JrZXIuaW5pdCA9IGZ1bmN0aW9uKGNvZGVTdHJpbmcpIHsKICAgICAgICBpZiAoIXdpbmRvdy5VUkwgfHwgIXdpbmRvdy5Xb3JrZXIpIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CiAgICAgICAgdmFyIGJsb2I7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYmxvYiA9IG5ldyBCbG9iKFsgY29kZVN0cmluZyBdLCB7CiAgICAgICAgICAgICAgICB0eXBlOiAiYXBwbGljYXRpb24vamF2YXNjcmlwdCIKICAgICAgICAgICAgfSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5CbG9iQnVpbGRlcikgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGJsb2IgPSBuZXcgQmxvYkJ1aWxkZXIoKSwgYmxvYi5hcHBlbmQoY29kZVN0cmluZyksIGJsb2IgPSBibG9iLmdldEJsb2IoKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFibG9iKSByZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciB3b3JrZXIgPSBuZXcgV29ya2VyKFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYikpOwogICAgICAgICAgICByZXR1cm4gd29ya2VyOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKICAgICAgICB9CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuY3JlYXRlV29ya2VyID0gV29ya2VyLmluaXQsIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5Xb3JrZXIgPSBXb3JrZXI7CiAgICB2YXIgU3ViV29ya2VyID0gZnVuY3Rpb24oY29kZVN0cmluZywgcGFyZW50KSB7CiAgICAgICAgdGhpcy5fd1BhcmVudCA9IHBhcmVudCwgZXZhbChjb2RlU3RyaW5nKTsKICAgIH0sIHAgPSBTdWJXb3JrZXIucHJvdG90eXBlOwogICAgcC5vbm1lc3NhZ2UgPSBudWxsLCBwLl93UGFyZW50ID0gbnVsbCwgcC5wb3N0TWVzc2FnZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5fd1BhcmVudDsKICAgICAgICBzZXRUaW1lb3V0KHBhcmVudC5vbm1lc3NhZ2UuYmluZChwYXJlbnQsIHsKICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgIH0pLCAxKTsKICAgIH07CiAgICB2YXIgRmFsbGJhY2tXb3JrZXIgPSBmdW5jdGlvbihjb2RlU3RyaW5nKSB7CiAgICAgICAgdGhpcy5fd0NoaWxkID0gbmV3IFN1Yldvcmtlcihjb2RlU3RyaW5nLCB0aGlzKTsKICAgIH07CiAgICBwID0gRmFsbGJhY2tXb3JrZXIucHJvdG90eXBlLCBwLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgIHZhciBjaGlsZCA9IHRoaXMuX3dDaGlsZDsKICAgICAgICBzZXRUaW1lb3V0KGNoaWxkLm9ubWVzc2FnZS5iaW5kKGNoaWxkLCB7CiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICB9KSwgMSk7CiAgICB9LCBwLnRlcm1pbmF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMub25tZXNzYWdlID0gbnVsbDsKICAgICAgICB2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CiAgICAgICAgY2hpbGQuX3dQYXJlbnQgPSBudWxsLCBjaGlsZC5vbm1lc3NhZ2UgPSBudWxsLCB0aGlzLl93Q2hpbGQgPSBudWxsOwogICAgfSwgcC5vbm1lc3NhZ2UgPSBudWxsLCBwLl93Q2hpbGQgPSBudWxsOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIENvbWJpbmVkQ2FsbGJhY2sgPSBmdW5jdGlvbihjYWxsLCBvYmosIHByb3AsIGNhbGxQcm9wKSB7CiAgICAgICAgb2JqW3Byb3BdID8gb2JqW2NhbGxQcm9wXSA9IGNhbGwgOiBjYWxsKCk7CiAgICB9OwogICAgQ29tYmluZWRDYWxsYmFjay5jcmVhdGUgPSBmdW5jdGlvbihjYWxsLCBvYmosIHByb3AsIGNhbGxQcm9wKSB7CiAgICAgICAgcmV0dXJuIENvbWJpbmVkQ2FsbGJhY2suYmluZCh0aGlzLCBjYWxsLCBvYmosIHByb3AsIGNhbGxQcm9wKTsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5Db21iaW5lZENhbGxiYWNrID0gQ29tYmluZWRDYWxsYmFjazsKfSgpLCBmdW5jdGlvbih1bmRlZmluZWQpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBORVhUX0lEID0gMCwgRGVsYXllZENhbGwgPSBmdW5jdGlvbihjYWxsYmFjaywgZGVsYXksIHJlcGVhdCwgYXV0b0Rlc3Ryb3kpIHsKICAgICAgICB0aGlzLl9jYWxsYmFjayA9IGNhbGxiYWNrLCB0aGlzLl9kZWxheSA9IGRlbGF5LCB0aGlzLl90aW1lciA9IGRlbGF5LCB0aGlzLl9yZXBlYXQgPSAhIXJlcGVhdCwgCiAgICAgICAgdGhpcy5fYXV0b0Rlc3Ryb3kgPSBhdXRvRGVzdHJveSA9PT0gdW5kZWZpbmVkID8gITAgOiAhIWF1dG9EZXN0cm95LCB0aGlzLl91cGRhdGVJZCA9ICJEZWxheWVkQ2FsbCMiICsgKytORVhUX0lELCAKICAgICAgICB0aGlzLl9wYXVzZWQgPSAhMSwgdGhpcy5fdXBkYXRlID0gdGhpcy5fdXBkYXRlLmJpbmQodGhpcyksIGNsb3Vka2lkLk9TLmluc3RhbmNlLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpOwogICAgfSwgcCA9IERlbGF5ZWRDYWxsLnByb3RvdHlwZTsKICAgIHAuX3VwZGF0ZSA9IGZ1bmN0aW9uKGVsYXBzZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY2FsbGJhY2sgPyAodGhpcy5fdGltZXIgLT0gZWxhcHNlZCwgdm9pZCAodGhpcy5fdGltZXIgPD0gMCAmJiAodGhpcy5fY2FsbGJhY2soKSwgCiAgICAgICAgdGhpcy5fcmVwZWF0ID8gdGhpcy5fdGltZXIgKz0gdGhpcy5fZGVsYXkgOiB0aGlzLl9hdXRvRGVzdHJveSA/IHRoaXMuZGVzdHJveSgpIDogY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpKSkpIDogdm9pZCB0aGlzLmRlc3Ryb3koKTsKICAgIH0sIHAucmVzdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl9jYWxsYmFjaykgewogICAgICAgICAgICB2YXIgb3MgPSBjbG91ZGtpZC5PUy5pbnN0YW5jZTsKICAgICAgICAgICAgb3MuYWRkVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQsIHRoaXMuX3VwZGF0ZSksIHRoaXMuX3RpbWVyID0gdGhpcy5fZGVsYXksIHRoaXMuX3BhdXNlZCA9ICExOwogICAgICAgIH0KICAgIH0sIHAuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNsb3Vka2lkLk9TLmluc3RhbmNlLnJlbW92ZVVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSwgdGhpcy5fcGF1c2VkID0gITE7CiAgICB9LCBPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInBhdXNlZCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGF1c2VkOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAodGhpcy5fY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHZhciBvcyA9IGNsb3Vka2lkLk9TLmluc3RhbmNlOwogICAgICAgICAgICAgICAgdGhpcy5fcGF1c2VkICYmICF2YWx1ZSA/ICh0aGlzLl9wYXVzZWQgPSAhMSwgb3MuaGFzVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpIHx8IG9zLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpKSA6IHZhbHVlICYmIG9zLmhhc1VwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSAmJiAodGhpcy5fcGF1c2VkID0gITAsIAogICAgICAgICAgICAgICAgb3MucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBjbG91ZGtpZC5PUy5pbnN0YW5jZS5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCksIHRoaXMuX2NhbGxiYWNrID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5EZWxheWVkQ2FsbCA9IERlbGF5ZWRDYWxsOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIHAsIEFwcGxpY2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwodGhpcyk7CiAgICB9OwogICAgcCA9IEFwcGxpY2F0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZSksIAogICAgcC5pbml0ID0gZnVuY3Rpb24oKSB7fSwgcC51cGRhdGUgPSBmdW5jdGlvbigpIHt9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHt9LCBwLnJlc2l6ZSA9IGZ1bmN0aW9uKCkge30sIAogICAgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLkFwcGxpY2F0aW9uID0gQXBwbGljYXRpb247Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgTG9hZGVyUXVldWVJdGVtID0gZnVuY3Rpb24oKSB7fSwgcCA9IExvYWRlclF1ZXVlSXRlbS5wcm90b3R5cGU7CiAgICBMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfSElHSCA9IDEsIExvYWRlclF1ZXVlSXRlbS5QUklPUklUWV9OT1JNQUwgPSAwLCBMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTE9XID0gLTEsIAogICAgcC51cmwgPSBudWxsLCBwLmRhdGEgPSBudWxsLCBwLmNhbGxiYWNrID0gbnVsbCwgcC5wcmlvcml0eSA9IDAsIHAucHJvZ3Jlc3MgPSAwLCAKICAgIHAudXBkYXRlQ2FsbGJhY2sgPSBudWxsLCBwLl9ib3VuZEZhaWwgPSBudWxsLCBwLl9ib3VuZFByb2dyZXNzID0gbnVsbCwgcC5fYm91bmRDb21wbGV0ZSA9IG51bGwsIAogICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAiW0xvYWRlclF1ZXVlSXRlbSh1cmw6JyIgKyB0aGlzLnVybCArICInLCBwcmlvcml0eToiICsgdGhpcy5wcmlvcml0eSArICIpXSI7CiAgICB9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmNhbGxiYWNrID0gbnVsbCwgdGhpcy51cGRhdGVDYWxsYmFjayA9IG51bGwsIHRoaXMuZGF0YSA9IG51bGwsIHRoaXMuX2JvdW5kRmFpbCA9IG51bGwsIAogICAgICAgIHRoaXMuX2JvdW5kUHJvZ3Jlc3MgPSBudWxsLCB0aGlzLl9ib3VuZENvbXBsZXRlID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5Mb2FkZXJRdWV1ZUl0ZW0gPSBMb2FkZXJRdWV1ZUl0ZW07Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgTWVkaWFMb2FkZXIgPSBmdW5jdGlvbigpIHt9LCBwID0gTWVkaWFMb2FkZXIucHJvdG90eXBlOwogICAgTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbDsKICAgIHZhciBxdWV1ZSA9IG51bGwsIHF1ZXVlSXRlbXMgPSBudWxsLCBsb2FkZXJzID0gbnVsbCwgcWlQb29sID0gbnVsbCwgbG9hZGVyUG9vbCA9IG51bGwsIHJlc3VsdFBvb2wgPSBudWxsLCBudW1Mb2FkcyA9IDAsIHJldHJpZXMgPSBudWxsOwogICAgcC5fY2FuTG9hZCA9ICEwLCBwLm1heFNpbXVsdGFuZW91c0xvYWRzID0gMiwgcC5jYWNoZU1hbmFnZXIgPSBudWxsLCBNZWRpYUxvYWRlci5pbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIE1lZGlhTG9hZGVyLl9pbnN0YW5jZSB8fCAoTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbmV3IE1lZGlhTG9hZGVyKCksIE1lZGlhTG9hZGVyLl9pbnN0YW5jZS5faW5pdGlhbGl6ZSgpKSwgCiAgICAgICAgTWVkaWFMb2FkZXIuX2luc3RhbmNlOwogICAgfSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KE1lZGlhTG9hZGVyLCAiaW5zdGFuY2UiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFNZWRpYUxvYWRlci5faW5zdGFuY2UpIHRocm93ICJDYWxsIGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluaXQoKSI7CiAgICAgICAgICAgIHJldHVybiBNZWRpYUxvYWRlci5faW5zdGFuY2U7CiAgICAgICAgfQogICAgfSksIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpLCBsZW4sIGtleSwgYXJyID0gdGhpcy5xdWV1ZTsKICAgICAgICBpZiAoYXJyKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPiBpOyArK2kpIGFycltpXS5kZXN0cm95KCk7CiAgICAgICAgICAgIGZvciAoYXJyID0gcWlQb29sLCBpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA+IGk7ICsraSkgYXJyW2ldLmRlc3Ryb3koKTsKICAgICAgICAgICAgZm9yIChhcnIgPSByZXN1bHRQb29sLCBpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA+IGk7ICsraSkgYXJyW2ldLmRlc3Ryb3koKTsKICAgICAgICAgICAgZm9yIChrZXkgaW4gbG9hZGVycykgcXVldWVJdGVtc1trZXldLmRlc3Ryb3koKSwgbG9hZGVyc1trZXldLmNsb3NlKCk7CiAgICAgICAgfQogICAgICAgIE1lZGlhTG9hZGVyLl9pbnN0YW5jZSA9IG51bGwsIHRoaXMuY2FjaGVNYW5hZ2VyICYmIHRoaXMuY2FjaGVNYW5hZ2VyLmRlc3Ryb3koKSwgCiAgICAgICAgdGhpcy5jYWNoZU1hbmFnZXIgPSBudWxsLCBxdWV1ZSA9IG51bGwsIHJlc3VsdFBvb2wgPSBudWxsLCBsb2FkZXJQb29sID0gbnVsbCwgcWlQb29sID0gbnVsbCwgCiAgICAgICAgcXVldWVJdGVtcyA9IG51bGwsIHJldHJpZXMgPSBudWxsLCBsb2FkZXJzID0gbnVsbDsKICAgIH0sIHAuX2luaXRpYWxpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICBxaVBvb2wgPSBbXSwgbG9hZGVyUG9vbCA9IFtdLCByZXN1bHRQb29sID0gW10sIHF1ZXVlID0gW10sIHF1ZXVlSXRlbXMgPSB7fSwgbG9hZGVycyA9IHt9LCAKICAgICAgICByZXRyaWVzID0ge30sIHRoaXMuY2FjaGVNYW5hZ2VyID0gbmV3IGNsb3Vka2lkLkNhY2hlTWFuYWdlcigpOwogICAgfSwgcC5sb2FkID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgdXBkYXRlQ2FsbGJhY2ssIHByaW9yaXR5LCBkYXRhKSB7CiAgICAgICAgdmFyIHFpID0gdGhpcy5fZ2V0UUkoKSwgYmFzZVBhdGggPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5vcHRpb25zLmJhc2VQYXRoOwogICAgICAgIHZvaWQgMCAhPT0gYmFzZVBhdGggJiYgL15odHRwKHMpP1w6Ly50ZXN0KHVybCkgPT09ICExICYmIC0xID09IHVybC5zZWFyY2goYmFzZVBhdGgpICYmIChxaS5iYXNlUGF0aCA9IGJhc2VQYXRoKSwgCiAgICAgICAgcWkudXJsID0gdXJsLCBxaS5jYWxsYmFjayA9IGNhbGxiYWNrLCBxaS51cGRhdGVDYWxsYmFjayA9IHVwZGF0ZUNhbGxiYWNrIHx8IG51bGwsIAogICAgICAgIHFpLnByaW9yaXR5ID0gcHJpb3JpdHkgfHwgY2xvdWRraWQuTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX05PUk1BTCwgcWkuZGF0YSA9IGRhdGEgfHwgbnVsbCwgCiAgICAgICAgcXVldWUucHVzaChxaSksIHF1ZXVlLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICByZXR1cm4gYS5wcmlvcml0eSAtIGIucHJpb3JpdHk7CiAgICAgICAgfSksIHRoaXMuX3RyeU5leHRMb2FkKCk7CiAgICB9LCBwLl9vbkxvYWRGYWlsZWQgPSBmdW5jdGlvbihxaSwgZXZlbnQpIHsKICAgICAgICBEZWJ1Zy5lcnJvcigiVW5hYmxlIHRvIGxvYWQgZmlsZTogIiArIHFpLnVybCArICIgLSByZWFzb246ICIgKyBldmVudC5lcnJvcik7CiAgICAgICAgdmFyIGxvYWRlciA9IGxvYWRlcnNbcWkudXJsXTsKICAgICAgICBsb2FkZXIucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMoKSwgbG9hZGVyLmNsb3NlKCksIHRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKSwgZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXSwgCiAgICAgICAgZGVsZXRlIGxvYWRlcnNbcWkudXJsXSwgcmV0cmllc1txaS51cmxdID8gcmV0cmllc1txaS51cmxdKysgOiByZXRyaWVzW3FpLnVybF0gPSAxLCAKICAgICAgICByZXRyaWVzW3FpLnVybF0gPiAzID8gdGhpcy5fbG9hZERvbmUocWksIG51bGwpIDogKG51bUxvYWRzLS0sIHF1ZXVlLnB1c2gocWkpLCB0aGlzLl90cnlOZXh0TG9hZCgpKTsKICAgIH0sIHAuX29uTG9hZFByb2dyZXNzID0gZnVuY3Rpb24ocWksIGV2ZW50KSB7CiAgICAgICAgcWkucHJvZ3Jlc3MgPSBldmVudC5wcm9ncmVzcywgcWkudXBkYXRlQ2FsbGJhY2sgJiYgcWkudXBkYXRlQ2FsbGJhY2socWkucHJvZ3Jlc3MpOwogICAgfSwgcC5fb25Mb2FkQ29tcGxldGVkID0gZnVuY3Rpb24ocWksIGV2KSB7CiAgICAgICAgRGVidWcubG9nKCJGaWxlIGxvYWRlZCBzdWNjZXNzZnVsbHkgZnJvbSAiICsgcWkudXJsKTsKICAgICAgICB2YXIgbG9hZGVyID0gbG9hZGVyc1txaS51cmxdOwogICAgICAgIGxvYWRlci5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpLCBsb2FkZXIuY2xvc2UoKSwgdGhpcy5fcG9vbExvYWRlcihsb2FkZXIpLCBkZWxldGUgcXVldWVJdGVtc1txaS51cmxdLCAKICAgICAgICBkZWxldGUgbG9hZGVyc1txaS51cmxdLCB0aGlzLl9sb2FkRG9uZShxaSwgdGhpcy5fZ2V0UmVzdWx0KGV2LnJlc3VsdCwgcWkudXJsLCBsb2FkZXIpKTsKICAgIH0sIHAuX3RyeU5leHRMb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCEobnVtTG9hZHMgPiB0aGlzLm1heFNpbXVsdGFuZW91c0xvYWRzIC0gMSB8fCAwID09PSBxdWV1ZS5sZW5ndGgpKSB7CiAgICAgICAgICAgIG51bUxvYWRzKys7CiAgICAgICAgICAgIHZhciBxaSA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICAgIERlYnVnLmxvZygiQXR0ZW1wdGluZyB0byBsb2FkIGZpbGUgJyIgKyBxaS51cmwgKyAiJyIpLCBxdWV1ZUl0ZW1zW3FpLnVybF0gPSBxaTsKICAgICAgICAgICAgdmFyIGxvYWRlciA9IHRoaXMuX2dldExvYWRlcihxaS5iYXNlUGF0aCk7CiAgICAgICAgICAgIGxvYWRlcnNbcWkudXJsXSA9IGxvYWRlciwgbG9hZGVyLmFkZEV2ZW50TGlzdGVuZXIoImZpbGVsb2FkIiwgcWkuX2JvdW5kQ29tcGxldGUpLCAKICAgICAgICAgICAgbG9hZGVyLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgcWkuX2JvdW5kRmFpbCksIGxvYWRlci5hZGRFdmVudExpc3RlbmVyKCJmaWxlcHJvZ3Jlc3MiLCBxaS5fYm91bmRQcm9ncmVzcyk7CiAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmNhY2hlTWFuYWdlci5wcmVwYXJlKHFpLnVybCk7CiAgICAgICAgICAgIGxvYWRlci5sb2FkRmlsZShxaS5kYXRhID8gewogICAgICAgICAgICAgICAgaWQ6IHFpLmRhdGEuaWQsCiAgICAgICAgICAgICAgICBzcmM6IHVybCwKICAgICAgICAgICAgICAgIGRhdGE6IHFpLmRhdGEKICAgICAgICAgICAgfSA6IHVybCk7CiAgICAgICAgfQogICAgfSwgcC5fbG9hZERvbmUgPSBmdW5jdGlvbihxaSwgcmVzdWx0KSB7CiAgICAgICAgbnVtTG9hZHMtLSwgcWkuZGF0YSAmJiByZXN1bHQgJiYgKHJlc3VsdC5pZCA9IHFpLmRhdGEuaWQpLCBxaS5jYWxsYmFjayhyZXN1bHQpLCAKICAgICAgICB0aGlzLl9wb29sUUkocWkpLCB0aGlzLl90cnlOZXh0TG9hZCgpOwogICAgfSwgcC5jYW5jZWwgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICB2YXIgcWkgPSBxdWV1ZUl0ZW1zW3VybF0sIGxvYWRlciA9IGxvYWRlcnNbdXJsXTsKICAgICAgICBpZiAocWkgJiYgbG9hZGVyKSByZXR1cm4gbG9hZGVyLmNsb3NlKCksIGRlbGV0ZSBsb2FkZXJzW3VybF0sIGRlbGV0ZSBxdWV1ZUl0ZW1zW3FpLnVybF0sIAogICAgICAgIG51bUxvYWRzLS0sIHRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKSwgdGhpcy5fcG9vbFFJKHFpKSwgITA7CiAgICAgICAgZm9yIChpID0gMCwgbGVuID0gcXVldWUubGVuZ3RoOyBsZW4gPiBpOyBpKyspIGlmIChxaSA9IHF1ZXVlW2ldLCBxaS51cmwgPT0gdXJsKSByZXR1cm4gcXVldWUuc3BsaWNlKGksIDEpLCAKICAgICAgICB0aGlzLl9wb29sUUkocWkpLCAhMDsKICAgICAgICByZXR1cm4gITE7CiAgICB9LCBwLl9nZXRRSSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBydG47CiAgICAgICAgcmV0dXJuIHFpUG9vbC5sZW5ndGggPyBydG4gPSBxaVBvb2wucG9wKCkgOiAocnRuID0gbmV3IGNsb3Vka2lkLkxvYWRlclF1ZXVlSXRlbSgpLCAKICAgICAgICBydG4uX2JvdW5kRmFpbCA9IHRoaXMuX29uTG9hZEZhaWxlZC5iaW5kKHRoaXMsIHJ0biksIHJ0bi5fYm91bmRQcm9ncmVzcyA9IHRoaXMuX29uTG9hZFByb2dyZXNzLmJpbmQodGhpcywgcnRuKSwgCiAgICAgICAgcnRuLl9ib3VuZENvbXBsZXRlID0gdGhpcy5fb25Mb2FkQ29tcGxldGVkLmJpbmQodGhpcywgcnRuKSksIHJ0bjsKICAgIH0sIHAuX3Bvb2xRSSA9IGZ1bmN0aW9uKHFpKSB7CiAgICAgICAgcWlQb29sLnB1c2gocWkpLCBxaS5jYWxsYmFjayA9IHFpLnVwZGF0ZUNhbGxiYWNrID0gcWkuZGF0YSA9IHFpLnVybCA9IG51bGwsIHFpLnByb2dyZXNzID0gMDsKICAgIH0sIHAuX2dldExvYWRlciA9IGZ1bmN0aW9uKGJhc2VQYXRoKSB7CiAgICAgICAgdmFyIHJ0bjsKICAgICAgICByZXR1cm4gbG9hZGVyUG9vbC5sZW5ndGggPyAocnRuID0gbG9hZGVyUG9vbC5wb3AoKSwgcnRuLl9iYXNlUGF0aCA9IGJhc2VQYXRoKSA6IHJ0biA9IG5ldyBjcmVhdGVqcy5Mb2FkUXVldWUoITAsIGJhc2VQYXRoKSwgCiAgICAgICAgY3JlYXRlanMuU291bmQgJiYgcnRuLmluc3RhbGxQbHVnaW4oY3JlYXRlanMuU291bmQpLCBydG47CiAgICB9LCBwLl9wb29sTG9hZGVyID0gZnVuY3Rpb24obG9hZGVyKSB7CiAgICAgICAgbG9hZGVyLnJlbW92ZUFsbCgpLCBsb2FkZXJQb29sLnB1c2gobG9hZGVyKTsKICAgIH0sIHAuX2dldFJlc3VsdCA9IGZ1bmN0aW9uKHJlc3VsdCwgdXJsLCBsb2FkZXIpIHsKICAgICAgICB2YXIgcnRuOwogICAgICAgIHJldHVybiByZXN1bHRQb29sLmxlbmd0aCA/IChydG4gPSByZXN1bHRQb29sLnBvcCgpLCBydG4uY29udGVudCA9IHJlc3VsdCwgcnRuLnVybCA9IHVybCwgCiAgICAgICAgcnRuLmxvYWRlciA9IGxvYWRlcikgOiBydG4gPSBuZXcgY2xvdWRraWQuTWVkaWFMb2FkZXJSZXN1bHQocmVzdWx0LCB1cmwsIGxvYWRlciksIAogICAgICAgIHJ0bjsKICAgIH0sIHAuX3Bvb2xSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXN1bHQuY29udGVudCA9IHJlc3VsdC51cmwgPSByZXN1bHQubG9hZGVyID0gcmVzdWx0LmlkID0gbnVsbCwgcmVzdWx0UG9vbC5wdXNoKHJlc3VsdCk7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuTWVkaWFMb2FkZXIgPSBNZWRpYUxvYWRlcjsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBNZWRpYUxvYWRlclJlc3VsdCA9IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCwgbG9hZGVyKSB7CiAgICAgICAgdGhpcy5jb250ZW50ID0gY29udGVudCwgdGhpcy51cmwgPSB1cmwsIHRoaXMubG9hZGVyID0gbG9hZGVyOwogICAgfSwgcCA9IE1lZGlhTG9hZGVyUmVzdWx0LnByb3RvdHlwZTsKICAgIHAuY29udGVudCA9IG51bGwsIHAudXJsID0gbnVsbCwgcC5sb2FkZXIgPSBudWxsLCBwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICJbTWVkaWFMb2FkZXJSZXN1bHQoJyIgKyB0aGlzLnVybCArICInKV0iOwogICAgfSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jYWxsYmFjayA9IG51bGwsIHRoaXMudXJsID0gbnVsbCwgdGhpcy5jb250ZW50ID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5NZWRpYUxvYWRlclJlc3VsdCA9IE1lZGlhTG9hZGVyUmVzdWx0Owp9KCksIGZ1bmN0aW9uKHVuZGVmaW5lZCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIENhY2hlTWFuYWdlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfSwgcCA9IENhY2hlTWFuYWdlci5wcm90b3R5cGUgPSB7fTsKICAgIHAuX3ZlcnNpb25zID0gbnVsbCwgcC5jYWNoZUJ1c3QgPSAhMSwgcC5pbml0aWFsaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fdmVyc2lvbnMgPSBbXTsKICAgICAgICB2YXIgY2IgPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5vcHRpb25zLmNhY2hlQnVzdDsKICAgICAgICB0aGlzLmNhY2hlQnVzdCA9IGNiID8gInRydWUiID09PSBjYiB8fCBjYiA9PT0gITAgOiAhMSwgdGhpcy5jYWNoZUJ1c3QgJiYgRGVidWcubG9nKCJDYWNoZUJ1c3QgYWxsIGZpbGVzIGlzIG9uLiIpOwogICAgfSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fdmVyc2lvbnMgPSBudWxsOwogICAgfSwgcC5hZGRWZXJzaW9uc0ZpbGUgPSBmdW5jdGlvbih1cmwsIGNhbGxiYWNrLCBiYXNlVXJsKSB7CiAgICAgICAgRGVidWcuYXNzZXJ0KC9eLipcLnR4dCQvLnRlc3QodXJsKSwgIlRoZSB2ZXJzaW9ucyBmaWxlIG11c3QgYmUgYSAqLnR4dCBmaWxlIik7CiAgICAgICAgdmFyIG1sID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5zdGFuY2U7CiAgICAgICAgaWYgKHRoaXMuY2FjaGVCdXN0KSByZXR1cm4gdm9pZCAoY2FsbGJhY2sgJiYgY2FsbGJhY2soKSk7CiAgICAgICAgdGhpcy5hZGRWZXJzaW9uKHVybCwgTWF0aC5yb3VuZCgxZTUgKiBNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgdmFyIGNtID0gdGhpczsKICAgICAgICBtbC5sb2FkKHVybCwgZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmNvbnRlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBwYXJ0cywgbGluZXMgPSByZXN1bHQuY29udGVudC5yZXBsYWNlKC9cci9nLCAiIikuc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspIGxpbmVzW2ldICYmIChwYXJ0cyA9IGxpbmVzW2ldLnNwbGl0KCIgIiksIDIgPT0gcGFydHMubGVuZ3RoICYmIGNtLmFkZFZlcnNpb24oKGJhc2VVcmwgfHwgIiIpICsgcGFydHNbMF0sIHBhcnRzWzFdKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soKTsKICAgICAgICB9KTsKICAgIH0sIHAuYWRkVmVyc2lvbiA9IGZ1bmN0aW9uKHVybCwgdmVyc2lvbikgewogICAgICAgIHZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKICAgICAgICB2ZXIgfHwgdGhpcy5fdmVyc2lvbnMucHVzaCh7CiAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICB2ZXJzaW9uOiB2ZXJzaW9uCiAgICAgICAgfSk7CiAgICB9LCBwLl9nZXRWZXJzaW9uQnlVcmwgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICB2YXIgaSwgbGVuID0gdGhpcy5fdmVyc2lvbnMubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGxlbiA+IGk7IGkrKykgaWYgKHVybCA9PSB0aGlzLl92ZXJzaW9uc1tpXS51cmwpIHJldHVybiB0aGlzLl92ZXJzaW9uc1tpXTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sIHAucHJlcGFyZSA9IGZ1bmN0aW9uKHVybCwgYXBwbHlCYXNlUGF0aCkgewogICAgICAgIHZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKICAgICAgICBpZiAodGhpcy5jYWNoZUJ1c3QgJiYgLyhcP3xcJiljYlw9WzAtOV0qLy50ZXN0KHVybCkgPT09ICExID8gKHRoaXMuX2NiVmFsIHx8ICh0aGlzLl9jYlZhbCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLnRvU3RyaW5nKCkpLCAKICAgICAgICB1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgImNiPSIgKyB0aGlzLl9jYlZhbCkgOiB2ZXIgJiYgLyhcP3xcJil2XD1bMC05XSovLnRlc3QodXJsKSA9PT0gITEgJiYgKHVybCA9IHVybCArICh1cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyAidj0iICsgdmVyLnZlcnNpb24pLCAKICAgICAgICBhcHBseUJhc2VQYXRoKSB7CiAgICAgICAgICAgIHZhciBiYXNlUGF0aCA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLm9wdGlvbnMuYmFzZVBhdGg7CiAgICAgICAgICAgIC9eaHR0cChzKT9cOi8udGVzdCh1cmwpID09PSAhMSAmJiBiYXNlUGF0aCAhPT0gdW5kZWZpbmVkICYmIC0xID09IHVybC5zZWFyY2goYmFzZVBhdGgpICYmICh1cmwgPSBiYXNlUGF0aCArIHVybCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1cmw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuQ2FjaGVNYW5hZ2VyID0gQ2FjaGVNYW5hZ2VyOwp9KCksIGZ1bmN0aW9uKHVuZGVmaW5lZCkgewogICAgInVzZSBzdHJpY3QiOwogICAgZnVuY3Rpb24gY2xvbmUob2JqKSB7CiAgICAgICAgaWYgKCFvYmogfHwgIm9iamVjdCIgIT0gdHlwZW9mIG9iaikgcmV0dXJuIG51bGw7CiAgICAgICAgdmFyIGNvcHkgPSBvYmouY29uc3RydWN0b3IoKTsKICAgICAgICBmb3IgKHZhciBhdHRyIGluIG9iaikgb2JqLmhhc093blByb3BlcnR5KGF0dHIpICYmIChjb3B5W2F0dHJdID0gb2JqW2F0dHJdKTsKICAgICAgICByZXR1cm4gY29weTsKICAgIH0KICAgIGZ1bmN0aW9uIGRvT2JqZWN0c01hdGNoKG9iajEsIG9iajIpIHsKICAgICAgICBpZiAob2JqMSA9PT0gb2JqMikgcmV0dXJuICEwOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmoxKSBpZiAob2JqMVtrZXldICE9IG9iajJba2V5XSkgcmV0dXJuICExOwogICAgICAgIHJldHVybiAhMDsKICAgIH0KICAgIHZhciBCdXR0b24gPSBmdW5jdGlvbihpbWFnZVNldHRpbmdzLCBsYWJlbCwgZW5hYmxlZCkgewogICAgICAgIGltYWdlU2V0dGluZ3MgJiYgKFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5jYWxsKHRoaXMpLCB0aGlzLmluaXRpYWxpemUoaW1hZ2VTZXR0aW5ncywgbGFiZWwsIGVuYWJsZWQpKTsKICAgIH0sIHAgPSBCdXR0b24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKTsKICAgIHAuYmFjayA9IG51bGwsIHAubGFiZWwgPSBudWxsLCBwLnJlbGVhc2VDYWxsYmFjayA9IG51bGwsIHAub3ZlckNhbGxiYWNrID0gbnVsbCwgCiAgICBwLm91dENhbGxiYWNrID0gbnVsbCwgcC5fc3RhdGVGbGFncyA9IG51bGwsIHAuX3N0YXRlUHJpb3JpdHkgPSBudWxsLCBwLl9zdGF0ZURhdGEgPSBudWxsLCAKICAgIHAuX2N1cnJlbnRMYWJlbFN0eWxlID0gbnVsbCwgcC5fb2Zmc2V0ID0gbnVsbCwgcC5fb3ZlckNCID0gbnVsbCwgcC5fb3V0Q0IgPSBudWxsLCAKICAgIHAuX2Rvd25DQiA9IG51bGwsIHAuX3VwQ0IgPSBudWxsLCBwLl91cE91dENCID0gbnVsbCwgcC5fd2lkdGggPSAwLCBwLl9oZWlnaHQgPSAwOwogICAgdmFyIFJFU0VSVkVEX1NUQVRFUyA9IFsgImRpc2FibGVkIiwgImVuYWJsZWQiLCAidXAiLCAib3ZlciIsICJkb3duIiBdLCBERUZBVUxUX1BSSU9SSVRZID0gWyAiZGlzYWJsZWQiLCAiZG93biIsICJvdmVyIiwgInVwIiBdOwogICAgcC5pbml0aWFsaXplID0gZnVuY3Rpb24oaW1hZ2VTZXR0aW5ncywgbGFiZWwsIGVuYWJsZWQpIHsKICAgICAgICB0aGlzLmJhY2sgPSBuZXcgUElYSS5TcHJpdGUoaW1hZ2VTZXR0aW5ncy51cCksIHRoaXMuYWRkQ2hpbGQodGhpcy5iYWNrKSwgdGhpcy5fb3ZlckNCID0gdGhpcy5fb25PdmVyLmJpbmQodGhpcyksIAogICAgICAgIHRoaXMuX291dENCID0gdGhpcy5fb25PdXQuYmluZCh0aGlzKSwgdGhpcy5fZG93bkNCID0gdGhpcy5fb25Eb3duLmJpbmQodGhpcyksIHRoaXMuX3VwQ0IgPSB0aGlzLl9vblVwLmJpbmQodGhpcyksIAogICAgICAgIHRoaXMuX3VwT3V0Q0IgPSB0aGlzLl9vblVwT3V0c2lkZS5iaW5kKHRoaXMpOwogICAgICAgIHZhciBfc3RhdGVEYXRhID0gdGhpcy5fc3RhdGVEYXRhID0ge307CiAgICAgICAgdGhpcy5fc3RhdGVGbGFncyA9IHt9LCB0aGlzLl9vZmZzZXQgPSBuZXcgUElYSS5Qb2ludCgpOwogICAgICAgIHZhciBsYWJlbERhdGE7CiAgICAgICAgaWYgKGxhYmVsKSB7CiAgICAgICAgICAgIGxhYmVsRGF0YSA9IGNsb25lKGxhYmVsKSwgZGVsZXRlIGxhYmVsRGF0YS50ZXh0LCBkZWxldGUgbGFiZWxEYXRhLnR5cGUsIGxhYmVsRGF0YS54ID09PSB1bmRlZmluZWQgJiYgKGxhYmVsRGF0YS54ID0gImNlbnRlciIpLCAKICAgICAgICAgICAgbGFiZWxEYXRhLnkgPT09IHVuZGVmaW5lZCAmJiAobGFiZWxEYXRhLnkgPSAiY2VudGVyIik7CiAgICAgICAgICAgIHZhciBzdHlsZSA9IGxhYmVsRGF0YS5zdHlsZSA9IGNsb25lKGxhYmVsLnN0eWxlKTsKICAgICAgICAgICAgImJpdG1hcCIgPT0gbGFiZWwudHlwZSA/IHN0eWxlLmFsaWduID0gc3R5bGUuYWxpZ24gfHwgImxlZnQiIDogKHN0eWxlLmZvbnQgPSBzdHlsZS5mb250IHx8ICJib2xkIDIwcHQgQXJpYWwiLCAKICAgICAgICAgICAgc3R5bGUuZmlsbCA9IHN0eWxlLmZpbGwgfHwgImJsYWNrIiwgc3R5bGUuYWxpZ24gPSBzdHlsZS5hbGlnbiB8fCAibGVmdCIsIHN0eWxlLnN0cm9rZSA9IHN0eWxlLnN0cm9rZSB8fCAiYmxhY2siLCAKICAgICAgICAgICAgc3R5bGUuc3Ryb2tlVGhpY2tuZXNzID0gc3R5bGUuc3Ryb2tlVGhpY2tuZXNzIHx8IDAsIHN0eWxlLndvcmRXcmFwID0gc3R5bGUud29yZFdyYXAgfHwgITEsIAogICAgICAgICAgICBzdHlsZS53b3JkV3JhcFdpZHRoID0gc3R5bGUud29yZFdyYXBXaWR0aCB8fCAxMDApOwogICAgICAgIH0KICAgICAgICB0aGlzLl9zdGF0ZVByaW9yaXR5ID0gaW1hZ2VTZXR0aW5ncy5wcmlvcml0eSB8fCBERUZBVUxUX1BSSU9SSVRZOwogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgIHZhciBzdGF0ZSA9IHRoaXMuX3N0YXRlUHJpb3JpdHlbaV07CiAgICAgICAgICAgIHRoaXMuX2FkZFByb3BlcnR5KHN0YXRlKSwgImRpc2FibGVkIiAhPSBzdGF0ZSAmJiAidXAiICE9IHN0YXRlICYmICh0aGlzLl9zdGF0ZUZsYWdzW3N0YXRlXSA9ICExKTsKICAgICAgICAgICAgdmFyIGlucHV0RGF0YSA9IGltYWdlU2V0dGluZ3Nbc3RhdGVdOwogICAgICAgICAgICBpZiAoX3N0YXRlRGF0YVtzdGF0ZV0gPSBpbnB1dERhdGEgPyBpbnB1dERhdGEudGV4ID8gewogICAgICAgICAgICAgICAgdGV4OiBpbnB1dERhdGEudGV4CiAgICAgICAgICAgIH0gOiB7CiAgICAgICAgICAgICAgICB0ZXg6IGlucHV0RGF0YQogICAgICAgICAgICB9IDogX3N0YXRlRGF0YS51cCwgbGFiZWwpIGlmIChpbnB1dERhdGEgJiYgaW5wdXREYXRhLmxhYmVsKSB7CiAgICAgICAgICAgICAgICBpbnB1dERhdGEgPSBpbnB1dERhdGEubGFiZWw7CiAgICAgICAgICAgICAgICB2YXIgc3RhdGVMYWJlbCA9IF9zdGF0ZURhdGFbc3RhdGVdLmxhYmVsID0ge307CiAgICAgICAgICAgICAgICBzdGF0ZUxhYmVsLnN0eWxlID0gaW5wdXREYXRhLnN0eWxlIHx8IGxhYmVsRGF0YS5zdHlsZSwgc3RhdGVMYWJlbC54ID0gaW5wdXREYXRhLnggfHwgbGFiZWxEYXRhLngsIAogICAgICAgICAgICAgICAgc3RhdGVMYWJlbC55ID0gaW5wdXREYXRhLnkgfHwgbGFiZWxEYXRhLnk7CiAgICAgICAgICAgIH0gZWxzZSBfc3RhdGVEYXRhW3N0YXRlXS5sYWJlbCA9IGxhYmVsRGF0YTsKICAgICAgICB9CiAgICAgICAgaWYgKF9zdGF0ZURhdGEudXAgfHwgKERlYnVnLmVycm9yKCJCdXR0b24gbGFja3MgYW4gdXAgc3RhdGUhIFRoaXMgaXMgYSBzZXJpb3VzIHByb2JsZW0hIElucHV0IGRhdGEgZm9sbG93czoiKSwgCiAgICAgICAgRGVidWcuZXJyb3IoaW1hZ2VTZXR0aW5ncykpLCBfc3RhdGVEYXRhLm92ZXIgfHwgKF9zdGF0ZURhdGEub3ZlciA9IF9zdGF0ZURhdGEudXApLCAKICAgICAgICBfc3RhdGVEYXRhLmRvd24gfHwgKF9zdGF0ZURhdGEuZG93biA9IF9zdGF0ZURhdGEudXApLCBfc3RhdGVEYXRhLmRpc2FibGVkIHx8IChfc3RhdGVEYXRhLmRpc2FibGVkID0gX3N0YXRlRGF0YS51cCksIAogICAgICAgIGltYWdlU2V0dGluZ3Mub2Zmc2V0ID8gKHRoaXMuX29mZnNldC54ID0gaW1hZ2VTZXR0aW5ncy5vZmZzZXQueCwgdGhpcy5fb2Zmc2V0LnkgPSBpbWFnZVNldHRpbmdzLm9mZnNldC55KSA6IHRoaXMuX29mZnNldC54ID0gdGhpcy5fb2Zmc2V0LnkgPSAwLCAKICAgICAgICBpbWFnZVNldHRpbmdzLnNjYWxlKSB7CiAgICAgICAgICAgIHZhciBzID0gaW1hZ2VTZXR0aW5ncy5zY2FsZSB8fCAxOwogICAgICAgICAgICB0aGlzLmJhY2suc2NhbGUueCA9IHRoaXMuYmFjay5zY2FsZS55ID0gczsKICAgICAgICB9CiAgICAgICAgbGFiZWwgJiYgKHRoaXMubGFiZWwgPSAiYml0bWFwIiA9PSBsYWJlbC50eXBlID8gbmV3IFBJWEkuQml0bWFwVGV4dChsYWJlbC50ZXh0LCBsYWJlbERhdGEuc3R5bGUpIDogbmV3IFBJWEkuVGV4dChsYWJlbC50ZXh0LCBsYWJlbERhdGEuc3R5bGUpLCAKICAgICAgICB0aGlzLmFkZENoaWxkKHRoaXMubGFiZWwpKSwgdGhpcy5iYWNrLnggPSB0aGlzLl9vZmZzZXQueCwgdGhpcy5iYWNrLnkgPSB0aGlzLl9vZmZzZXQueSwgCiAgICAgICAgdGhpcy5fd2lkdGggPSB0aGlzLmJhY2sud2lkdGgsIHRoaXMuX2hlaWdodCA9IHRoaXMuYmFjay5oZWlnaHQsIHRoaXMuZW5hYmxlZCA9IGVuYWJsZWQgPT09IHVuZGVmaW5lZCA/ICEwIDogISFlbmFibGVkOwogICAgfSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJ3aWR0aCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fd2lkdGggKiB0aGlzLnNjYWxlLng7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc2NhbGUueCA9IHZhbHVlIC8gdGhpcy5fd2lkdGg7CiAgICAgICAgfQogICAgfSksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiaGVpZ2h0IiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9oZWlnaHQgKiB0aGlzLnNjYWxlLnk7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc2NhbGUueSA9IHZhbHVlIC8gdGhpcy5faGVpZ2h0OwogICAgICAgIH0KICAgIH0pLCBwLnNldFRleHQgPSBmdW5jdGlvbih0ZXh0KSB7CiAgICAgICAgaWYgKHRoaXMubGFiZWwpIHsKICAgICAgICAgICAgdGhpcy5sYWJlbC5zZXRUZXh0KHRleHQpLCB0aGlzLmxhYmVsIGluc3RhbmNlb2YgUElYSS5UZXh0ID8gKHRoaXMubGFiZWwudXBkYXRlVGV4dCgpLCAKICAgICAgICAgICAgdGhpcy5sYWJlbC5kaXJ0eSA9ICExKSA6IHRoaXMubGFiZWwuZm9yY2VVcGRhdGVUZXh0KCk7CiAgICAgICAgICAgIGZvciAodmFyIGRhdGEsIGkgPSAwOyBpIDwgdGhpcy5fc3RhdGVQcmlvcml0eS5sZW5ndGg7ICsraSkgaWYgKHRoaXMuX3N0YXRlRmxhZ3NbdGhpcy5fc3RhdGVQcmlvcml0eVtpXV0pIHsKICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLl9zdGF0ZURhdGFbdGhpcy5fc3RhdGVQcmlvcml0eVtpXV07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGF0YSB8fCAoZGF0YSA9IHRoaXMuX3N0YXRlRGF0YS51cCksIGRhdGEgPSBkYXRhLmxhYmVsLCAiY2VudGVyIiA9PSBkYXRhLngpIHsKICAgICAgICAgICAgICAgIHZhciBiVyA9IHRoaXMuYmFjay53aWR0aCwgbFcgPSB0aGlzLmxhYmVsLndpZHRoOwogICAgICAgICAgICAgICAgc3dpdGNoICh0aGlzLl9jdXJyZW50TGFiZWxTdHlsZS5hbGlnbikgewogICAgICAgICAgICAgICAgICBjYXNlICJjZW50ZXIiOgogICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWwucG9zaXRpb24ueCA9IC41ICogYlc7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICBjYXNlICJyaWdodCI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gLjUgKiAoYlcgLSBsVykgKyBsVzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbC5wb3NpdGlvbi54ID0gLjUgKiAoYlcgLSBsVyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSBkYXRhLnggKyB0aGlzLl9vZmZzZXQueDsKICAgICAgICAgICAgdGhpcy5sYWJlbC5wb3NpdGlvbi55ID0gImNlbnRlciIgPT0gZGF0YS55ID8gLjUgKiAodGhpcy5iYWNrLmhlaWdodCAtIHRoaXMubGFiZWwuaGVpZ2h0KSA6IGRhdGEueSArIHRoaXMuX29mZnNldC55OwogICAgICAgIH0KICAgIH0sIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiZW5hYmxlZCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIXRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQ7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQgPSAhdmFsdWUsIHRoaXMuYnV0dG9uTW9kZSA9IHZhbHVlLCB0aGlzLmludGVyYWN0aXZlID0gdmFsdWUsIAogICAgICAgICAgICB2YWx1ZSA/ICh0aGlzLm1vdXNlZG93biA9IHRoaXMudG91Y2hzdGFydCA9IHRoaXMuX2Rvd25DQiwgdGhpcy5tb3VzZW92ZXIgPSB0aGlzLl9vdmVyQ0IsIAogICAgICAgICAgICB0aGlzLm1vdXNlb3V0ID0gdGhpcy5fb3V0Q0IpIDogKHRoaXMubW91c2Vkb3duID0gdGhpcy50b3VjaHN0YXJ0ID0gdGhpcy5tb3VzZW92ZXIgPSB0aGlzLm1vdXNlb3V0ID0gbnVsbCwgCiAgICAgICAgICAgIHRoaXMubW91c2V1cCA9IHRoaXMudG91Y2hlbmQgPSB0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSBudWxsLCAKICAgICAgICAgICAgdGhpcy5fc3RhdGVGbGFncy5kb3duID0gdGhpcy5fc3RhdGVGbGFncy5vdmVyID0gITEsIHRoaXMuX19pc092ZXIgPSAhMSksIHRoaXMuX3VwZGF0ZVN0YXRlKCk7CiAgICAgICAgfQogICAgfSksIHAuX2FkZFByb3BlcnR5ID0gZnVuY3Rpb24ocHJvcGVydHlOYW1lKSB7CiAgICAgICAgUkVTRVJWRURfU1RBVEVTLmluZGV4T2YocHJvcGVydHlOYW1lKSA+PSAwIHx8IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdGF0ZUZsYWdzW3Byb3BlcnR5TmFtZV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXRlRmxhZ3NbcHJvcGVydHlOYW1lXSA9IHZhbHVlLCB0aGlzLl91cGRhdGVTdGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LCBwLl91cGRhdGVTdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmJhY2spIHsKICAgICAgICAgICAgZm9yICh2YXIgZGF0YSwgaSA9IDA7IGkgPCB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aDsgKytpKSBpZiAodGhpcy5fc3RhdGVGbGFnc1t0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXSkgewogICAgICAgICAgICAgICAgZGF0YSA9IHRoaXMuX3N0YXRlRGF0YVt0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkYXRhIHx8IChkYXRhID0gdGhpcy5fc3RhdGVEYXRhLnVwKSwgdGhpcy5iYWNrLnNldFRleHR1cmUoZGF0YS50ZXgpLCB0aGlzLmxhYmVsKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF0YSA9IGRhdGEubGFiZWwsIHRoaXMuX2N1cnJlbnRMYWJlbFN0eWxlICYmIGRvT2JqZWN0c01hdGNoKHRoaXMuX2N1cnJlbnRMYWJlbFN0eWxlLCBkYXRhLnN0eWxlKSB8fCAodGhpcy5sYWJlbC5zZXRTdHlsZShkYXRhLnN0eWxlKSwgCiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50TGFiZWxTdHlsZSA9IGRhdGEuc3R5bGUsIHRoaXMubGFiZWwgaW5zdGFuY2VvZiBQSVhJLlRleHQgPyAodGhpcy5sYWJlbC51cGRhdGVUZXh0KCksIAogICAgICAgICAgICAgICAgdGhpcy5sYWJlbC5kaXJ0eSA9ICExKSA6IHRoaXMubGFiZWwuZm9yY2VVcGRhdGVUZXh0KCkpLCAiY2VudGVyIiA9PSBkYXRhLngpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYlcgPSB0aGlzLmJhY2sud2lkdGgsIGxXID0gdGhpcy5sYWJlbC53aWR0aDsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRoaXMuX2N1cnJlbnRMYWJlbFN0eWxlLmFsaWduKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlICJjZW50ZXIiOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSAuNSAqIGJXOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyaWdodCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWwucG9zaXRpb24ueCA9IC41ICogKGJXIC0gbFcpICsgbFc7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWwucG9zaXRpb24ueCA9IC41ICogKGJXIC0gbFcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB0aGlzLmxhYmVsLnBvc2l0aW9uLnggPSBkYXRhLnggKyB0aGlzLl9vZmZzZXQueDsKICAgICAgICAgICAgICAgIHRoaXMubGFiZWwucG9zaXRpb24ueSA9ICJjZW50ZXIiID09IGRhdGEueSA/IC41ICogKHRoaXMuYmFjay5oZWlnaHQgLSB0aGlzLmxhYmVsLmhlaWdodCkgOiBkYXRhLnkgKyB0aGlzLl9vZmZzZXQueTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIHAuX29uT3ZlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuX3N0YXRlRmxhZ3Mub3ZlciA9ICEwLCB0aGlzLl91cGRhdGVTdGF0ZSgpLCB0aGlzLm92ZXJDYWxsYmFjayAmJiB0aGlzLm92ZXJDYWxsYmFjayh0aGlzKTsKICAgIH0sIHAuX29uT3V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fc3RhdGVGbGFncy5vdmVyID0gITEsIHRoaXMuX3VwZGF0ZVN0YXRlKCksIHRoaXMub3V0Q2FsbGJhY2sgJiYgdGhpcy5vdXRDYWxsYmFjayh0aGlzKTsKICAgIH0sIHAuX29uRG93biA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBkYXRhLm9yaWdpbmFsRXZlbnQucHJldmVudERlZmF1bHQoKSwgdGhpcy5fc3RhdGVGbGFncy5kb3duID0gITAsIHRoaXMuX3VwZGF0ZVN0YXRlKCksIAogICAgICAgIHRoaXMubW91c2V1cCA9IHRoaXMudG91Y2hlbmQgPSB0aGlzLl91cENCLCB0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSB0aGlzLl91cE91dENCOwogICAgfSwgcC5fb25VcCA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBkYXRhLm9yaWdpbmFsRXZlbnQucHJldmVudERlZmF1bHQoKSwgdGhpcy5fc3RhdGVGbGFncy5kb3duID0gITEsIHRoaXMubW91c2V1cCA9IHRoaXMudG91Y2hlbmQgPSBudWxsLCAKICAgICAgICB0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSBudWxsLCB0aGlzLl91cGRhdGVTdGF0ZSgpLCB0aGlzLnJlbGVhc2VDYWxsYmFjayAmJiB0aGlzLnJlbGVhc2VDYWxsYmFjayh0aGlzKTsKICAgIH0sIHAuX29uVXBPdXRzaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fc3RhdGVGbGFncy5kb3duID0gITEsIHRoaXMubW91c2V1cCA9IHRoaXMudG91Y2hlbmQgPSBudWxsLCB0aGlzLm1vdXNldXBvdXRzaWRlID0gdGhpcy50b3VjaGVuZG91dHNpZGUgPSBudWxsLCAKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSgpOwogICAgfSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5tb3VzZWRvd24gPSB0aGlzLnRvdWNoc3RhcnQgPSB0aGlzLm1vdXNlb3ZlciA9IHRoaXMubW91c2VvdXQgPSBudWxsLCB0aGlzLm1vdXNldXAgPSB0aGlzLnRvdWNoZW5kID0gdGhpcy5tb3VzZXVwb3V0c2lkZSA9IHRoaXMudG91Y2hlbmRvdXRzaWRlID0gbnVsbCwgCiAgICAgICAgdGhpcy5yZW1vdmVDaGlsZHJlbighMCksIHRoaXMubGFiZWwgPSBudWxsLCB0aGlzLmJhY2sgPSBudWxsLCB0aGlzLnJlbGVhc2VDYWxsYmFjayA9IG51bGwsIAogICAgICAgIHRoaXMub3ZlckNhbGxiYWNrID0gbnVsbCwgdGhpcy5vdXRDYWxsYmFjayA9IG51bGwsIHRoaXMuX3N0YXRlRGF0YSA9IG51bGwsIHRoaXMuX3N0YXRlRmxhZ3MgPSBudWxsLCAKICAgICAgICB0aGlzLl9zdGF0ZVByaW9yaXR5ID0gbnVsbCwgdGhpcy5fZG93bkNCID0gbnVsbCwgdGhpcy5fdXBDQiA9IG51bGwsIHRoaXMuX292ZXJDQiA9IG51bGwsIAogICAgICAgIHRoaXMuX291dENCID0gbnVsbCwgdGhpcy5fdXBPdXRDQiA9IG51bGw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuQnV0dG9uID0gQnV0dG9uOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIERyYWdNYW5hZ2VyID0gZnVuY3Rpb24oc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spIHsKICAgICAgICB0aGlzLmluaXRpYWxpemUoc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spOwogICAgfSwgcCA9IERyYWdNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwogICAgcC5kcmFnZ2VkT2JqID0gbnVsbCwgcC5kcmFnU3RhcnRUaHJlc2hvbGQgPSAyMCwgcC5tb3VzZURvd25TdGFnZVBvcyA9IG51bGwsIHAubW91c2VEb3duT2JqUG9zID0gbnVsbCwgCiAgICBwLmlzVG91Y2hNb3ZlID0gITEsIHAuaXNIZWxkRHJhZyA9ICExLCBwLmlzU3RpY2t5Q2xpY2sgPSAhMSwgcC5hbGxvd1N0aWNreUNsaWNrID0gITAsIAogICAgcC5zbmFwU2V0dGluZ3MgPSBudWxsLCBwLl90aGVTdGFnZSA9IG51bGwsIHAuX2RyYWdPZmZzZXQgPSBudWxsLCBwLl9kcmFnU3RhcnRDYWxsYmFjayA9IG51bGwsIAogICAgcC5fZHJhZ0VuZENhbGxiYWNrID0gbnVsbCwgcC5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2sgPSBudWxsLCBwLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayA9IG51bGwsIAogICAgcC5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2sgPSBudWxsLCBwLl91cGRhdGVDYWxsYmFjayA9IG51bGwsIHAuX2RyYWdnYWJsZU9iamVjdHMgPSBudWxsOwogICAgdmFyIGhlbHBlclBvaW50ID0gbnVsbCwgVFlQRV9NT1VTRSA9IDAsIFRZUEVfVE9VQ0ggPSAxOwogICAgcC5pbml0aWFsaXplID0gZnVuY3Rpb24oc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spIHsKICAgICAgICB0aGlzLl91cGRhdGVDYWxsYmFjayA9IHRoaXMuX3VwZGF0ZU9ialBvc2l0aW9uLmJpbmQodGhpcyksIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gdGhpcy5fdHJpZ2dlckhlbGREcmFnLmJpbmQodGhpcyksIAogICAgICAgIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrID0gdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrLmJpbmQodGhpcyksIHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrID0gdGhpcy5fc3RvcERyYWcuYmluZCh0aGlzKSwgCiAgICAgICAgdGhpcy5fdGhlU3RhZ2UgPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5zdGFnZSwgdGhpcy5fZHJhZ1N0YXJ0Q2FsbGJhY2sgPSBzdGFydENhbGxiYWNrLCAKICAgICAgICB0aGlzLl9kcmFnRW5kQ2FsbGJhY2sgPSBlbmRDYWxsYmFjaywgdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cyA9IFtdLCB0aGlzLm1vdXNlRG93blN0YWdlUG9zID0gbmV3IFBJWEkuUG9pbnQoMCwgMCksIAogICAgICAgIHRoaXMubW91c2VEb3duT2JqUG9zID0gbmV3IFBJWEkuUG9pbnQoMCwgMCksIGhlbHBlclBvaW50ID0gbmV3IFBJWEkuUG9pbnQoMCwgMCk7CiAgICB9LCBwLnN0YXJ0RHJhZyA9IGZ1bmN0aW9uKG9iamVjdCwgaW50ZXJhY3Rpb25EYXRhKSB7CiAgICAgICAgdGhpcy5fb2JqTW91c2VEb3duKFRZUEVfTU9VU0UsIG9iamVjdCwgaW50ZXJhY3Rpb25EYXRhKTsKICAgIH0sIHAuX29iak1vdXNlRG93biA9IGZ1bmN0aW9uKHR5cGUsIG9iaiwgaW50ZXJhY3Rpb25EYXRhKSB7CiAgICAgICAgbnVsbCA9PT0gdGhpcy5kcmFnZ2VkT2JqICYmICh0aGlzLmRyYWdnZWRPYmogPSBvYmosIGNyZWF0ZWpzLlR3ZWVuLnJlbW92ZVR3ZWVucyh0aGlzLmRyYWdnZWRPYmopLCAKICAgICAgICBjcmVhdGVqcy5Ud2Vlbi5yZW1vdmVUd2VlbnModGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uKSwgdGhpcy5fZHJhZ09mZnNldCA9IGludGVyYWN0aW9uRGF0YS5nZXRMb2NhbFBvc2l0aW9uKHRoaXMuZHJhZ2dlZE9iai5wYXJlbnQpLCAKICAgICAgICB0aGlzLl9kcmFnT2Zmc2V0LnggLT0gdGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uLngsIHRoaXMuX2RyYWdPZmZzZXQueSAtPSB0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueSwgCiAgICAgICAgdGhpcy5tb3VzZURvd25PYmpQb3MueCA9IHRoaXMuZHJhZ2dlZE9iai5wb3NpdGlvbi54LCB0aGlzLm1vdXNlRG93bk9ialBvcy55ID0gdGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uLnksIAogICAgICAgIHRoaXMubW91c2VEb3duU3RhZ2VQb3MueCA9IGludGVyYWN0aW9uRGF0YS5nbG9iYWwueCwgdGhpcy5tb3VzZURvd25TdGFnZVBvcy55ID0gaW50ZXJhY3Rpb25EYXRhLmdsb2JhbC55LCAKICAgICAgICB0aGlzLmFsbG93U3RpY2t5Q2xpY2sgJiYgdHlwZSAhPSBUWVBFX1RPVUNIID8gKHRoaXMuZHJhZ2dlZE9iai5tb3VzZW1vdmUgPSB0aGlzLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjaywgCiAgICAgICAgdGhpcy5fdGhlU3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLnN0YWdlVXAgPSB0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjaykgOiAodGhpcy5pc1RvdWNoTW92ZSA9IHR5cGUgPT0gVFlQRV9UT1VDSCwgCiAgICAgICAgdGhpcy5pc0hlbGREcmFnID0gITAsIHRoaXMuX3N0YXJ0RHJhZygpKSk7CiAgICB9LCBwLl90cmlnZ2VyU3RpY2t5Q2xpY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmlzU3RpY2t5Q2xpY2sgPSAhMCwgdGhpcy5kcmFnZ2VkT2JqLm1vdXNlbW92ZSA9IG51bGwsIHRoaXMuX3RoZVN0YWdlLmludGVyYWN0aW9uTWFuYWdlci5zdGFnZVVwID0gbnVsbCwgCiAgICAgICAgdGhpcy5fc3RhcnREcmFnKCk7CiAgICB9LCBwLl90cmlnZ2VySGVsZERyYWcgPSBmdW5jdGlvbihpbnRlcmFjdGlvbkRhdGEpIHsKICAgICAgICB2YXIgeERpZmYgPSBpbnRlcmFjdGlvbkRhdGEuZ2xvYmFsLnggLSB0aGlzLm1vdXNlRG93blN0YWdlUG9zLngsIHlEaWZmID0gaW50ZXJhY3Rpb25EYXRhLmdsb2JhbC55IC0gdGhpcy5tb3VzZURvd25TdGFnZVBvcy55OwogICAgICAgIHhEaWZmICogeERpZmYgKyB5RGlmZiAqIHlEaWZmID49IHRoaXMuZHJhZ1N0YXJ0VGhyZXNob2xkICogdGhpcy5kcmFnU3RhcnRUaHJlc2hvbGQgJiYgKHRoaXMuaXNIZWxkRHJhZyA9ICEwLCAKICAgICAgICB0aGlzLmRyYWdnZWRPYmoubW91c2Vtb3ZlID0gbnVsbCwgdGhpcy5fdGhlU3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLnN0YWdlVXAgPSBudWxsLCAKICAgICAgICB0aGlzLl9zdGFydERyYWcoKSk7CiAgICB9LCBwLl9zdGFydERyYWcgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaW0gPSB0aGlzLl90aGVTdGFnZS5pbnRlcmFjdGlvbk1hbmFnZXI7CiAgICAgICAgaW0uc3RhZ2VVcCA9IHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrLCB0aGlzLmRyYWdnZWRPYmoubW91c2Vtb3ZlID0gdGhpcy5kcmFnZ2VkT2JqLnRvdWNobW92ZSA9IHRoaXMuX3VwZGF0ZUNhbGxiYWNrLCAKICAgICAgICB0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayh0aGlzLmRyYWdnZWRPYmopOwogICAgfSwgcC5zdG9wRHJhZyA9IGZ1bmN0aW9uKGRvQ2FsbGJhY2spIHsKICAgICAgICB0aGlzLl9zdG9wRHJhZyhudWxsLCBkb0NhbGxiYWNrID09PSAhMCk7CiAgICB9LCBwLl9zdG9wRHJhZyA9IGZ1bmN0aW9uKG9yaWdNb3VzZUV2LCBkb0NhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5kcmFnZ2VkT2JqICYmICh0aGlzLmRyYWdnZWRPYmoudG91Y2htb3ZlID0gdGhpcy5kcmFnZ2VkT2JqLm1vdXNlbW92ZSA9IG51bGwpOwogICAgICAgIHZhciBpbSA9IHRoaXMuX3RoZVN0YWdlLmludGVyYWN0aW9uTWFuYWdlcjsKICAgICAgICBpbS5zdGFnZVVwID0gbnVsbDsKICAgICAgICB2YXIgb2JqID0gdGhpcy5kcmFnZ2VkT2JqOwogICAgICAgIHRoaXMuZHJhZ2dlZE9iaiA9IG51bGwsIHRoaXMuaXNUb3VjaE1vdmUgPSAhMSwgdGhpcy5pc1N0aWNreUNsaWNrID0gITEsIHRoaXMuaXNIZWxkTW92ZSA9ICExLCAKICAgICAgICBkb0NhbGxiYWNrICE9PSAhMSAmJiB0aGlzLl9kcmFnRW5kQ2FsbGJhY2sob2JqKTsKICAgIH0sIHAuX3VwZGF0ZU9ialBvc2l0aW9uID0gZnVuY3Rpb24oaW50ZXJhY3Rpb25EYXRhKSB7CiAgICAgICAgaWYgKHRoaXMuaXNUb3VjaE1vdmUgfHwgdGhpcy5fdGhlU3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLm1vdXNlSW5TdGFnZSkgewogICAgICAgICAgICBpZiAoIXRoaXMuZHJhZ2dlZE9iaiB8fCAhdGhpcy5kcmFnZ2VkT2JqLnBhcmVudCkgcmV0dXJuIHZvaWQgdGhpcy5fc3RvcERyYWcobnVsbCwgITEpOwogICAgICAgICAgICB2YXIgbW91c2VQb3MgPSBpbnRlcmFjdGlvbkRhdGEuZ2V0TG9jYWxQb3NpdGlvbih0aGlzLmRyYWdnZWRPYmoucGFyZW50LCBoZWxwZXJQb2ludCksIGJvdW5kcyA9IHRoaXMuZHJhZ2dlZE9iai5fZHJhZ0JvdW5kczsKICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ2dlZE9iai5wb3NpdGlvbi54ID0gY2xhbXAobW91c2VQb3MueCAtIHRoaXMuX2RyYWdPZmZzZXQueCwgYm91bmRzLngsIGJvdW5kcy5yaWdodCksIAogICAgICAgICAgICB0aGlzLmRyYWdnZWRPYmoucG9zaXRpb24ueSA9IGNsYW1wKG1vdXNlUG9zLnkgLSB0aGlzLl9kcmFnT2Zmc2V0LnksIGJvdW5kcy55LCBib3VuZHMuYm90dG9tKSwgCiAgICAgICAgICAgIHRoaXMuc25hcFNldHRpbmdzKSBzd2l0Y2ggKHRoaXMuc25hcFNldHRpbmdzLm1vZGUpIHsKICAgICAgICAgICAgICBjYXNlICJwb2ludHMiOgogICAgICAgICAgICAgICAgdGhpcy5faGFuZGxlUG9pbnRTbmFwKG1vdXNlUG9zKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlICJncmlkIjoKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlICJsaW5lIjogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwgcC5faGFuZGxlUG9pbnRTbmFwID0gZnVuY3Rpb24obG9jYWxNb3VzZVBvcykgewogICAgICAgIGZvciAodmFyIHNuYXBTZXR0aW5ncyA9IHRoaXMuc25hcFNldHRpbmdzLCBtaW5EaXN0U3EgPSBzbmFwU2V0dGluZ3MuZGlzdCAqIHNuYXBTZXR0aW5ncy5kaXN0LCBwb2ludHMgPSBzbmFwU2V0dGluZ3MucG9pbnRzLCBvYmpYID0gbG9jYWxNb3VzZVBvcy54IC0gdGhpcy5fZHJhZ09mZnNldC54LCBvYmpZID0gbG9jYWxNb3VzZVBvcy55IC0gdGhpcy5fZHJhZ09mZnNldC55LCBsZWFzdERpc3QgPSAtMSwgY2xvc2VzdFBvaW50ID0gbnVsbCwgaSA9IHBvaW50cy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgICAgICB2YXIgcCA9IHBvaW50c1tpXSwgZGlzdFNxID0gZGlzdFNxdWFyZWQob2JqWCwgb2JqWSwgcC54LCBwLnkpOwogICAgICAgICAgICBtaW5EaXN0U3EgPj0gZGlzdFNxICYmIChsZWFzdERpc3QgPiBkaXN0U3EgfHwgLTEgPT0gbGVhc3REaXN0KSAmJiAobGVhc3REaXN0ID0gZGlzdFNxLCAKICAgICAgICAgICAgY2xvc2VzdFBvaW50ID0gcCk7CiAgICAgICAgfQogICAgICAgIGNsb3Nlc3RQb2ludCAmJiAodGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uLnggPSBjbG9zZXN0UG9pbnQueCwgdGhpcy5kcmFnZ2VkT2JqLnBvc2l0aW9uLnkgPSBjbG9zZXN0UG9pbnQueSk7CiAgICB9OwogICAgdmFyIGRpc3RTcXVhcmVkID0gZnVuY3Rpb24oeDEsIHkxLCB4MiwgeTIpIHsKICAgICAgICB2YXIgeERpZmYgPSB4MSAtIHgyLCB5RGlmZiA9IHkxIC0geTI7CiAgICAgICAgcmV0dXJuIHhEaWZmICogeERpZmYgKyB5RGlmZiAqIHlEaWZmOwogICAgfSwgY2xhbXAgPSBmdW5jdGlvbih4LCBhLCBiKSB7CiAgICAgICAgcmV0dXJuIGEgPiB4ID8gYSA6IHggPiBiID8gYiA6IHg7CiAgICB9LCBlbmFibGVEcmFnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5tb3VzZWRvd24gPSB0aGlzLl9vbk1vdXNlRG93bkxpc3RlbmVyLCB0aGlzLnRvdWNoc3RhcnQgPSB0aGlzLl9vblRvdWNoU3RhcnRMaXN0ZW5lciwgCiAgICAgICAgdGhpcy5idXR0b25Nb2RlID0gdGhpcy5pbnRlcmFjdGl2ZSA9ICEwOwogICAgfSwgZGlzYWJsZURyYWcgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm1vdXNlZG93biA9IHRoaXMudG91Y2hzdGFydCA9IG51bGwsIHRoaXMuYnV0dG9uTW9kZSA9IHRoaXMuaW50ZXJhY3RpdmUgPSAhMTsKICAgIH0sIF9vbk1vdXNlRG93biA9IGZ1bmN0aW9uKHR5cGUsIG1vdXNlRGF0YSkgewogICAgICAgIHRoaXMuX2RyYWdNYW4uX29iak1vdXNlRG93bih0eXBlLCB0aGlzLCBtb3VzZURhdGEpOwogICAgfTsKICAgIHAuYWRkT2JqZWN0ID0gZnVuY3Rpb24ob2JqLCBib3VuZHMpIHsKICAgICAgICBpZiAoIWJvdW5kcykgewogICAgICAgICAgICB2YXIgY2FudmFzID0gY2xvdWRraWQuT1MuaW5zdGFuY2UuX3JlbmRlcmVyLnZpZXc7CiAgICAgICAgICAgIGJvdW5kcyA9IHsKICAgICAgICAgICAgICAgIHg6IDAsCiAgICAgICAgICAgICAgICB5OiAwLAogICAgICAgICAgICAgICAgd2lkdGg6IGNhbnZhcy53aWR0aCwKICAgICAgICAgICAgICAgIGhlaWdodDogY2FudmFzLmhlaWdodAogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBib3VuZHMucmlnaHQgPSBib3VuZHMueCArIGJvdW5kcy53aWR0aCwgYm91bmRzLmJvdHRvbSA9IGJvdW5kcy55ICsgYm91bmRzLmhlaWdodCwgCiAgICAgICAgb2JqLl9kcmFnQm91bmRzID0gYm91bmRzLCB0aGlzLl9kcmFnZ2FibGVPYmplY3RzLmluZGV4T2Yob2JqKSA+PSAwIHx8IChvYmouZW5hYmxlRHJhZyA9IGVuYWJsZURyYWcsIAogICAgICAgIG9iai5kaXNhYmxlRHJhZyA9IGRpc2FibGVEcmFnLCBvYmouX29uTW91c2VEb3duTGlzdGVuZXIgPSBfb25Nb3VzZURvd24uYmluZChvYmosIFRZUEVfTU9VU0UpLCAKICAgICAgICBvYmouX29uVG91Y2hTdGFydExpc3RlbmVyID0gX29uTW91c2VEb3duLmJpbmQob2JqLCBUWVBFX1RPVUNIKSwgb2JqLl9kcmFnTWFuID0gdGhpcywgCiAgICAgICAgdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5wdXNoKG9iaikpOwogICAgfSwgcC5yZW1vdmVPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLl9kcmFnZ2FibGVPYmplY3RzLmluZGV4T2Yob2JqKTsKICAgICAgICBpbmRleCA+PSAwICYmIChvYmouZGlzYWJsZURyYWcoKSwgZGVsZXRlIG9iai5lbmFibGVEcmFnLCBkZWxldGUgb2JqLmRpc2FibGVEcmFnLCAKICAgICAgICBkZWxldGUgb2JqLl9vbk1vdXNlRG93bkxpc3RlbmVyLCBkZWxldGUgb2JqLl9vblRvdWNoU3RhcnRMaXN0ZW5lciwgZGVsZXRlIG9iai5fZHJhZ01hbiwgCiAgICAgICAgZGVsZXRlIG9iai5fZHJhZ0JvdW5kcywgdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5zcGxpY2UoaW5kZXgsIDEpKTsKICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG51bGwgIT09IHRoaXMuZHJhZ2dlZE9iaiAmJiB0aGlzLl9zdG9wRHJhZyhudWxsLCAhMSksIHRoaXMuX3VwZGF0ZUNhbGxiYWNrID0gbnVsbCwgCiAgICAgICAgdGhpcy5fZHJhZ1N0YXJ0Q2FsbGJhY2sgPSBudWxsLCB0aGlzLl9kcmFnRW5kQ2FsbGJhY2sgPSBudWxsLCB0aGlzLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayA9IG51bGwsIAogICAgICAgIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrID0gbnVsbCwgdGhpcy5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2sgPSBudWxsLCB0aGlzLl90aGVTdGFnZSA9IG51bGw7CiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX2RyYWdnYWJsZU9iamVjdHMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgICAgdmFyIG9iaiA9IHRoaXMuX2RyYWdnYWJsZU9iamVjdHNbaV07CiAgICAgICAgICAgIG9iai5kaXNhYmxlRHJhZygpLCBkZWxldGUgb2JqLmVuYWJsZURyYWcsIGRlbGV0ZSBvYmouZGlzYWJsZURyYWcsIGRlbGV0ZSBvYmouX29uTW91c2VEb3duTGlzdGVuZXIsIAogICAgICAgICAgICBkZWxldGUgb2JqLl9kcmFnTWFuLCBkZWxldGUgb2JqLl9kcmFnQm91bmRzOwogICAgICAgIH0KICAgICAgICB0aGlzLl9kcmFnZ2FibGVPYmplY3RzID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5EcmFnTWFuYWdlciA9IERyYWdNYW5hZ2VyOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFBvc2l0aW9uZXIgPSBmdW5jdGlvbigpIHt9OwogICAgUG9zaXRpb25lci5wcm90b3R5cGUgPSB7fSwgUG9zaXRpb25lci5wb3NpdGlvbkl0ZW1zID0gZnVuY3Rpb24ocGFyZW50LCBpdGVtU2V0dGluZ3MpIHsKICAgICAgICB2YXIgcm90LCBwdCwgZGVnVG9SYWQ7CiAgICAgICAgZGVnVG9SYWQgPSBNYXRoLlBJIC8gMTgwOwogICAgICAgIGZvciAodmFyIGlOYW1lIGluIGl0ZW1TZXR0aW5ncykgewogICAgICAgICAgICB2YXIgaXRlbSA9IHBhcmVudFtpTmFtZV07CiAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICB2YXIgc2V0dGluZyA9IGl0ZW1TZXR0aW5nc1tpTmFtZV07CiAgICAgICAgICAgICAgICBpZiAoaXRlbS5wb3NpdGlvbi54ID0gc2V0dGluZy54LCBpdGVtLnBvc2l0aW9uLnkgPSBzZXR0aW5nLnksIHB0ID0gc2V0dGluZy5zY2FsZSwgCiAgICAgICAgICAgICAgICBwdCAmJiAoaXRlbS5zY2FsZS54ICo9IHB0LngsIGl0ZW0uc2NhbGUueSAqPSBwdC55KSwgcHQgPSBzZXR0aW5nLnBpdm90LCBwdCAmJiAoaXRlbS5waXZvdC54ID0gcHQueCwgCiAgICAgICAgICAgICAgICBpdGVtLnBpdm90LnkgPSBwdC55KSwgcm90ID0gc2V0dGluZy5yb3RhdGlvbiwgcm90ICYmIChpdGVtLnJvdGF0aW9uID0gcm90ICogZGVnVG9SYWQpLCAKICAgICAgICAgICAgICAgIHNldHRpbmcuaGl0QXJlYSkgewogICAgICAgICAgICAgICAgICAgIHZhciBoaXRBcmVhID0gc2V0dGluZy5oaXRBcmVhOwogICAgICAgICAgICAgICAgICAgIGl0ZW0uaGl0QXJlYSA9IFBvc2l0aW9uZXIuZ2VuZXJhdGVIaXRBcmVhKGhpdEFyZWEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgRGVidWcuZXJyb3IoImNvdWxkIG5vdCBmaW5kIG9iamVjdCAnIiArIGlOYW1lICsgIiciKTsKICAgICAgICB9CiAgICB9LCBQb3NpdGlvbmVyLmdlbmVyYXRlSGl0QXJlYSA9IGZ1bmN0aW9uKGhpdEFyZWEsIHNjYWxlKSB7CiAgICAgICAgc2NhbGUgfHwgKHNjYWxlID0gMSk7CiAgICAgICAgdmFyIGxpYnJhcnk7CiAgICAgICAgaWYgKGxpYnJhcnkgPSB3aW5kb3cuUElYSSwgaXNBcnJheShoaXRBcmVhKSkgewogICAgICAgICAgICBpZiAoMSA9PSBzY2FsZSkgcmV0dXJuIG5ldyBsaWJyYXJ5LlBvbHlnb24oaGl0QXJlYSk7CiAgICAgICAgICAgIGZvciAodmFyIHRlbXAgPSBbXSwgaSA9IDAsIGxlbiA9IGhpdEFyZWEubGVuZ3RoOyBsZW4gPiBpOyArK2kpIHRlbXAucHVzaChuZXcgbGlicmFyeS5Qb2ludChoaXRBcmVhW2ldLnggKiBzY2FsZSwgaGl0QXJlYVtpXS55ICogc2NhbGUpKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBsaWJyYXJ5LlBvbHlnb24odGVtcCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAicmVjdCIgIT0gaGl0QXJlYS50eXBlICYmIGhpdEFyZWEudHlwZSA/ICJlbGxpcHNlIiA9PSBoaXRBcmVhLnR5cGUgPyBuZXcgbGlicmFyeS5FbGxpcHNlKChoaXRBcmVhLnggLSAuNSAqIGhpdEFyZWEudykgKiBzY2FsZSwgKGhpdEFyZWEueSAtIC41ICogaGl0QXJlYS5oKSAqIHNjYWxlLCBoaXRBcmVhLncgKiBzY2FsZSwgaGl0QXJlYS5oICogc2NhbGUpIDogImNpcmNsZSIgPT0gaGl0QXJlYS50eXBlID8gbmV3IGxpYnJhcnkuQ2lyY2xlKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS5yICogc2NhbGUpIDogInNlY3RvciIgPT0gaGl0QXJlYS50eXBlID8gbmV3IGxpYnJhcnkuU2VjdG9yKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS5yICogc2NhbGUsIGhpdEFyZWEuc3RhcnQsIGhpdEFyZWEuZW5kKSA6IG51bGwgOiBuZXcgbGlicmFyeS5SZWN0YW5nbGUoaGl0QXJlYS54ICogc2NhbGUsIGhpdEFyZWEueSAqIHNjYWxlLCBoaXRBcmVhLncgKiBzY2FsZSwgaGl0QXJlYS5oICogc2NhbGUpOwogICAgfTsKICAgIHZhciBpc0FycmF5ID0gZnVuY3Rpb24obykgewogICAgICAgIHJldHVybiAiW29iamVjdCBBcnJheV0iID09PSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobyk7CiAgICB9OwogICAgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLlBvc2l0aW9uZXIgPSBQb3NpdGlvbmVyOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFNjcmVlblNldHRpbmdzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCwgcHBpKSB7CiAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoLCB0aGlzLmhlaWdodCA9IGhlaWdodCwgdGhpcy5wcGkgPSBwcGk7CiAgICB9OwogICAgU2NyZWVuU2V0dGluZ3MucHJvdG90eXBlID0ge30sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5TY3JlZW5TZXR0aW5ncyA9IFNjcmVlblNldHRpbmdzOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFVJU2NhbGVyLCBVSUVsZW1lbnQgPSBmdW5jdGlvbihpdGVtLCBzZXR0aW5ncywgZGVzaWduZWRTY3JlZW4pIHsKICAgICAgICBzd2l0Y2ggKFVJU2NhbGVyID0gY2xvdWRraWQuVUlTY2FsZXIsIHRoaXMuX2l0ZW0gPSBpdGVtLCB0aGlzLl9zZXR0aW5ncyA9IHNldHRpbmdzLCAKICAgICAgICB0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IGRlc2lnbmVkU2NyZWVuLCB0aGlzLm9yaWdTY2FsZVggPSBpdGVtLnNjYWxlLngsIHRoaXMub3JpZ1NjYWxlWSA9IGl0ZW0uc2NhbGUueSwgCiAgICAgICAgdGhpcy5vcmlnV2lkdGggPSBpdGVtLndpZHRoLCB0aGlzLm9yaWdCb3VuZHMgPSB7CiAgICAgICAgICAgIHg6IDAsCiAgICAgICAgICAgIHk6IDAsCiAgICAgICAgICAgIHdpZHRoOiBpdGVtLndpZHRoLAogICAgICAgICAgICBoZWlnaHQ6IGl0ZW0uaGVpZ2h0CiAgICAgICAgfSwgdGhpcy5vcmlnQm91bmRzLnJpZ2h0ID0gdGhpcy5vcmlnQm91bmRzLnggKyB0aGlzLm9yaWdCb3VuZHMud2lkdGgsIHRoaXMub3JpZ0JvdW5kcy5ib3R0b20gPSB0aGlzLm9yaWdCb3VuZHMueSArIHRoaXMub3JpZ0JvdW5kcy5oZWlnaHQsIAogICAgICAgIHNldHRpbmdzLnZlcnRBbGlnbikgewogICAgICAgICAgY2FzZSBVSVNjYWxlci5BTElHTl9UT1A6CiAgICAgICAgICAgIHRoaXMub3JpZ01hcmdpblZlcnQgPSBpdGVtLnBvc2l0aW9uLnkgKyB0aGlzLm9yaWdCb3VuZHMueTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBVSVNjYWxlci5BTElHTl9DRU5URVI6CiAgICAgICAgICAgIHRoaXMub3JpZ01hcmdpblZlcnQgPSAuNSAqIGRlc2lnbmVkU2NyZWVuLmhlaWdodCAtIGl0ZW0ucG9zaXRpb24ueTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBVSVNjYWxlci5BTElHTl9CT1RUT006CiAgICAgICAgICAgIHRoaXMub3JpZ01hcmdpblZlcnQgPSBkZXNpZ25lZFNjcmVlbi5oZWlnaHQgLSAoaXRlbS5wb3NpdGlvbi55ICsgdGhpcy5vcmlnQm91bmRzLmJvdHRvbSk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoc2V0dGluZ3MuaG9yaUFsaWduKSB7CiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0xFRlQ6CiAgICAgICAgICAgIHRoaXMub3JpZ01hcmdpbkhvcmkgPSBpdGVtLnBvc2l0aW9uLnggKyB0aGlzLm9yaWdCb3VuZHMueDsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBVSVNjYWxlci5BTElHTl9DRU5URVI6CiAgICAgICAgICAgIHRoaXMub3JpZ01hcmdpbkhvcmkgPSAuNSAqIGRlc2lnbmVkU2NyZWVuLndpZHRoIC0gaXRlbS5wb3NpdGlvbi54OwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX1JJR0hUOgogICAgICAgICAgICB0aGlzLm9yaWdNYXJnaW5Ib3JpID0gZGVzaWduZWRTY3JlZW4ud2lkdGggLSAoaXRlbS5wb3NpdGlvbi54ICsgdGhpcy5vcmlnQm91bmRzLnJpZ2h0KTsKICAgICAgICB9CiAgICB9LCBwID0gVUlFbGVtZW50LnByb3RvdHlwZSA9IHt9OwogICAgcC5vcmlnTWFyZ2luSG9yaSA9IDAsIHAub3JpZ01hcmdpblZlcnQgPSAwLCBwLm9yaWdXaWR0aCA9IDAsIHAub3JpZ1NjYWxlWCA9IDAsIHAub3JpZ1NjYWxlWSA9IDAsIAogICAgcC5vcmlnQm91bmRzID0gbnVsbCwgcC5fc2V0dGluZ3MgPSBudWxsLCBwLl9pdGVtID0gbnVsbCwgcC5fZGVzaWduZWRTY3JlZW4gPSBudWxsLCAKICAgIHAucmVzaXplID0gZnVuY3Rpb24obmV3U2NyZWVuKSB7CiAgICAgICAgdmFyIG92ZXJhbGxTY2FsZSA9IG5ld1NjcmVlbi5oZWlnaHQgLyB0aGlzLl9kZXNpZ25lZFNjcmVlbi5oZWlnaHQsIHBwaVNjYWxlID0gbmV3U2NyZWVuLnBwaSAvIHRoaXMuX2Rlc2lnbmVkU2NyZWVuLnBwaSwgbGV0dGVyQm94V2lkdGggPSAobmV3U2NyZWVuLndpZHRoIC0gdGhpcy5fZGVzaWduZWRTY3JlZW4ud2lkdGggKiBvdmVyYWxsU2NhbGUpIC8gMiwgaXRlbVNjYWxlID0gb3ZlcmFsbFNjYWxlIC8gcHBpU2NhbGU7CiAgICAgICAgdGhpcy5fc2V0dGluZ3MubWluU2NhbGUgJiYgaXRlbVNjYWxlIDwgdGhpcy5fc2V0dGluZ3MubWluU2NhbGUgPyBpdGVtU2NhbGUgPSB0aGlzLl9zZXR0aW5ncy5taW5TY2FsZSA6IHRoaXMuX3NldHRpbmdzLm1heFNjYWxlICYmIGl0ZW1TY2FsZSA+IHRoaXMuX3NldHRpbmdzLm1heFNjYWxlICYmIChpdGVtU2NhbGUgPSB0aGlzLl9zZXR0aW5ncy5tYXhTY2FsZSksIAogICAgICAgIGl0ZW1TY2FsZSAqPSBwcGlTY2FsZSwgdGhpcy5faXRlbS5zY2FsZS54ID0gdGhpcy5vcmlnU2NhbGVYICogaXRlbVNjYWxlLCB0aGlzLl9pdGVtLnNjYWxlLnkgPSB0aGlzLm9yaWdTY2FsZVkgKiBpdGVtU2NhbGU7CiAgICAgICAgdmFyIG07CiAgICAgICAgc3dpdGNoIChtID0gdGhpcy5vcmlnTWFyZ2luVmVydCAqIG92ZXJhbGxTY2FsZSwgdGhpcy5fc2V0dGluZ3MudmVydEFsaWduKSB7CiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX1RPUDoKICAgICAgICAgICAgdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gbSAtIHRoaXMub3JpZ0JvdW5kcy55ICogaXRlbVNjYWxlOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKICAgICAgICAgICAgdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gLjUgKiBuZXdTY3JlZW4uaGVpZ2h0IC0gbTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBVSVNjYWxlci5BTElHTl9CT1RUT006CiAgICAgICAgICAgIHRoaXMuX2l0ZW0ucG9zaXRpb24ueSA9IG5ld1NjcmVlbi5oZWlnaHQgLSBtIC0gdGhpcy5vcmlnQm91bmRzLmJvdHRvbSAqIGl0ZW1TY2FsZTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoIChtID0gdGhpcy5vcmlnTWFyZ2luSG9yaSAqIG92ZXJhbGxTY2FsZSwgdGhpcy5fc2V0dGluZ3MuaG9yaUFsaWduKSB7CiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0xFRlQ6CiAgICAgICAgICAgIHRoaXMuX2l0ZW0ucG9zaXRpb24ueCA9IHRoaXMuX3NldHRpbmdzLnRpdGxlU2FmZSA/IGxldHRlckJveFdpZHRoICsgbSAtIHRoaXMub3JpZ0JvdW5kcy54ICogaXRlbVNjYWxlIDogbSAtIHRoaXMub3JpZ0JvdW5kcy54ICogaXRlbVNjYWxlOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKICAgICAgICAgICAgdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gdGhpcy5fc2V0dGluZ3MuY2VudGVyZWRIb3Jpem9udGFsbHkgPyAuNSAqIChuZXdTY3JlZW4ud2lkdGggLSB0aGlzLl9pdGVtLndpZHRoKSA6IC41ICogbmV3U2NyZWVuLndpZHRoIC0gbTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBVSVNjYWxlci5BTElHTl9SSUdIVDoKICAgICAgICAgICAgdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gdGhpcy5fc2V0dGluZ3MudGl0bGVTYWZlID8gbmV3U2NyZWVuLndpZHRoIC0gbGV0dGVyQm94V2lkdGggLSBtIC0gdGhpcy5vcmlnQm91bmRzLnJpZ2h0ICogaXRlbVNjYWxlIDogbmV3U2NyZWVuLndpZHRoIC0gbSAtIHRoaXMub3JpZ0JvdW5kcy5yaWdodCAqIGl0ZW1TY2FsZTsKICAgICAgICB9CiAgICB9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm9yaWdCb3VuZHMgPSBudWxsLCB0aGlzLl9pdGVtID0gbnVsbCwgdGhpcy5fc2V0dGluZ3MgPSBudWxsLCB0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuVUlFbGVtZW50ID0gVUlFbGVtZW50Owp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFVJRWxlbWVudFNldHRpbmdzID0gZnVuY3Rpb24oKSB7fSwgcCA9IFVJRWxlbWVudFNldHRpbmdzLnByb3RvdHlwZSA9IHt9OwogICAgcC52ZXJ0QWxpZ24gPSBudWxsLCBwLmhvcmlBbGlnbiA9IG51bGwsIHAudGl0bGVTYWZlID0gITEsIHAubWF4U2NhbGUgPSAxLCBwLm1pblNjYWxlID0gMSwgCiAgICBwLmNlbnRlcmVkSG9yaXpvbnRhbGx5ID0gITEsIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5VSUVsZW1lbnRTZXR0aW5ncyA9IFVJRWxlbWVudFNldHRpbmdzOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFVJRWxlbWVudFNldHRpbmdzID0gY2xvdWRraWQuVUlFbGVtZW50U2V0dGluZ3MsIFVJRWxlbWVudCA9IGNsb3Vka2lkLlVJRWxlbWVudCwgU2NyZWVuU2V0dGluZ3MgPSBjbG91ZGtpZC5TY3JlZW5TZXR0aW5ncywgVUlTY2FsZXIgPSBmdW5jdGlvbihwYXJlbnQsIGRlc2lnbmVkV2lkdGgsIGRlc2lnbmVkSGVpZ2h0LCBkZXNpZ25lZFBQSSkgewogICAgICAgIHRoaXMuX3BhcmVudCA9IHBhcmVudCwgdGhpcy5faXRlbXMgPSBbXSwgdGhpcy5fZGVzaWduZWRTY3JlZW4gPSBuZXcgU2NyZWVuU2V0dGluZ3MoZGVzaWduZWRXaWR0aCwgZGVzaWduZWRIZWlnaHQsIGRlc2lnbmVkUFBJKTsKICAgIH0sIHAgPSBVSVNjYWxlci5wcm90b3R5cGUgPSB7fSwgY3VycmVudFNjcmVlbiA9IG5ldyBTY3JlZW5TZXR0aW5ncygwLCAwLCAwKSwgaW5pdGlhbGl6ZWQgPSAhMTsKICAgIHAuX3BhcmVudCA9IG51bGwsIHAuX2Rlc2lnbmVkU2NyZWVuID0gbnVsbCwgcC5faXRlbXMgPSBudWxsLCBVSVNjYWxlci5BTElHTl9UT1AgPSAidG9wIiwgCiAgICBVSVNjYWxlci5BTElHTl9CT1RUT00gPSAiYm90dG9tIiwgVUlTY2FsZXIuQUxJR05fTEVGVCA9ICJsZWZ0IiwgVUlTY2FsZXIuQUxJR05fUklHSFQgPSAicmlnaHQiLCAKICAgIFVJU2NhbGVyLkFMSUdOX0NFTlRFUiA9ICJjZW50ZXIiLCBVSVNjYWxlci5mcm9tSlNPTiA9IGZ1bmN0aW9uKHBhcmVudCwganNvblNldHRpbmdzLCBqc29uSXRlbXMsIGltbWVkaWF0ZURlc3Ryb3kpIHsKICAgICAgICAiYm9vbGVhbiIgIT0gdHlwZW9mIGltbWVkaWF0ZURlc3Ryb3kgJiYgKGltbWVkaWF0ZURlc3Ryb3kgPSAhMCk7CiAgICAgICAgdmFyIGl0ZW0sIGksIGFsaWduLCB2ZXJ0QWxpZ24sIGhvcmlBbGlnbiwgc2NhbGVyID0gbmV3IFVJU2NhbGVyKHBhcmVudCwganNvblNldHRpbmdzLmRlc2lnbmVkV2lkdGgsIGpzb25TZXR0aW5ncy5kZXNpZ25lZEhlaWdodCwganNvblNldHRpbmdzLmRlc2lnbmVkUFBJKTsKICAgICAgICBmb3IgKGkgaW4ganNvbkl0ZW1zKSBpdGVtID0ganNvbkl0ZW1zW2ldLCBpdGVtLmFsaWduID8gKGFsaWduID0gaXRlbS5hbGlnbi5zcGxpdCgiLSIpLCAKICAgICAgICB2ZXJ0QWxpZ24gPSBhbGlnblswXSwgaG9yaUFsaWduID0gYWxpZ25bMV0pIDogKHZlcnRBbGlnbiA9IEFMSUdOX0NFTlRFUiwgaG9yaUFsaWduID0gQUxJR05fQ0VOVEVSKSwgCiAgICAgICAgc2NhbGVyLmFkZChwYXJlbnRbaV0sIHZlcnRBbGlnbiwgaG9yaUFsaWduLCBpdGVtLnRpdGxlU2FmZSB8fCAhMSwgaXRlbS5taW5TY2FsZSB8fCAwLzAsIGl0ZW0ubWF4U2NhbGUgfHwgMC8wLCBpdGVtLmNlbnRlcmVkSG9yaXpvbnRhbGx5IHx8ICExKTsKICAgICAgICByZXR1cm4gc2NhbGVyLnJlc2l6ZSgpLCBpbW1lZGlhdGVEZXN0cm95ICYmIHNjYWxlci5kZXN0cm95KCksIHNjYWxlcjsKICAgIH0sIFVJU2NhbGVyLmluaXQgPSBmdW5jdGlvbihzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0LCBzY3JlZW5QUEkpIHsKICAgICAgICBjdXJyZW50U2NyZWVuLndpZHRoID0gc2NyZWVuV2lkdGgsIGN1cnJlbnRTY3JlZW4uaGVpZ2h0ID0gc2NyZWVuSGVpZ2h0LCBjdXJyZW50U2NyZWVuLnBwaSA9IHNjcmVlblBQSSwgCiAgICAgICAgaW5pdGlhbGl6ZWQgPSAhMDsKICAgIH0sIHAuZ2V0U2NhbGUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gY3VycmVudFNjcmVlbi5oZWlnaHQgLyB0aGlzLl9kZXNpZ25lZFNjcmVlbi5oZWlnaHQ7CiAgICB9LCBwLmFkZCA9IGZ1bmN0aW9uKGl0ZW0sIHZlcnRBbGlnbiwgaG9yaUFsaWduLCB0aXRsZVNhZmUsIG1pblNjYWxlLCBtYXhTY2FsZSwgY2VudGVyZWRIb3Jpem9udGFsbHkpIHsKICAgICAgICB2YXIgcyA9IG5ldyBVSUVsZW1lbnRTZXR0aW5ncygpOwogICAgICAgIHMudmVydEFsaWduID0gdmVydEFsaWduIHx8IFVJU2NhbGVyLkFMSUdOX0NFTlRFUiwgcy5ob3JpQWxpZ24gPSBob3JpQWxpZ24gfHwgVUlTY2FsZXIuQUxJR05fQ0VOVEVSLCAKICAgICAgICBzLnRpdGxlU2FmZSA9ICJib29sZWFuIiAhPSB0eXBlb2YgdGl0bGVTYWZlID8gITEgOiB0aXRsZVNhZmUsIHMubWF4U2NhbGUgPSAibnVtYmVyIiAhPSB0eXBlb2YgbWF4U2NhbGUgPyAwLzAgOiBtYXhTY2FsZSwgCiAgICAgICAgcy5taW5TY2FsZSA9ICJudW1iZXIiICE9IHR5cGVvZiBtaW5TY2FsZSA/IDAvMCA6IG1pblNjYWxlLCBzLmNlbnRlcmVkSG9yaXpvbnRhbGx5ID0gY2VudGVyZWRIb3Jpem9udGFsbHkgfHwgITEsIAogICAgICAgIHRoaXMuX2l0ZW1zLnB1c2gobmV3IFVJRWxlbWVudChpdGVtLCBzLCB0aGlzLl9kZXNpZ25lZFNjcmVlbikpOwogICAgfSwgVUlTY2FsZXIucmVzaXplQmFja2dyb3VuZCA9IGZ1bmN0aW9uKGJpdG1hcCkgewogICAgICAgIGlmIChpbml0aWFsaXplZCkgewogICAgICAgICAgICB2YXIgaCwgdywgc2NhbGU7CiAgICAgICAgICAgIGggPSBiaXRtYXAuaGVpZ2h0IC8gYml0bWFwLnNjYWxlLnksIHcgPSBiaXRtYXAud2lkdGggLyBiaXRtYXAuc2NhbGUueCwgc2NhbGUgPSBjdXJyZW50U2NyZWVuLmhlaWdodCAvIGgsIAogICAgICAgICAgICBiaXRtYXAuc2NhbGUueCA9IGJpdG1hcC5zY2FsZS55ID0gc2NhbGUsIGJpdG1hcC5wb3NpdGlvbi54ID0gLjUgKiAoY3VycmVudFNjcmVlbi53aWR0aCAtIGJpdG1hcC53aWR0aCk7CiAgICAgICAgfQogICAgfSwgVUlTY2FsZXIucmVzaXplQmFja2dyb3VuZHMgPSBmdW5jdGlvbihiaXRtYXBzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGJpdG1hcHMubGVuZ3RoOyBsZW4gPiBpOyArK2kpIFVJU2NhbGVyLnJlc2l6ZUJhY2tncm91bmQoYml0bWFwc1tpXSk7CiAgICB9LCBwLnJlc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl9pdGVtcy5sZW5ndGggPiAwKSBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5faXRlbXMubGVuZ3RoOyBsZW4gPiBpOyArK2kpIHRoaXMuX2l0ZW1zW2ldLnJlc2l6ZShjdXJyZW50U2NyZWVuKTsKICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl9pdGVtcy5sZW5ndGggPiAwKSBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5faXRlbXMubGVuZ3RoOyBsZW4gPiBpOyArK2kpIHRoaXMuX2l0ZW1zW2ldLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLl9wYXJlbnQgPSBudWxsLCB0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGwsIHRoaXMuX2l0ZW1zID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5VSVNjYWxlciA9IFVJU2NhbGVyOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIEFzc2V0TWFuYWdlciA9IHt9OwogICAgQXNzZXRNYW5hZ2VyLnNjYWxlcyA9IG51bGw7CiAgICB2YXIgc2l6ZXMgPSBudWxsLCBhc3NldHMgPSBudWxsLCBhc3NldFVybENhY2hlID0gbnVsbCwgc2NhbGVzID0gbnVsbCwgcGF0aHMgPSBudWxsLCBzaXplT3JkZXIgPSBudWxsOwogICAgQXNzZXRNYW5hZ2VyLmxvd0hXID0gITEsIEFzc2V0TWFuYWdlci5pbml0ID0gZnVuY3Rpb24oY29uZmlnLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgQXNzZXRNYW5hZ2VyLnNjYWxlcyA9IHt9LCBhc3NldHMgPSBjb25maWcuYXNzZXRzLCBhc3NldFVybENhY2hlID0ge30sIHBhdGhzID0gY29uZmlnLnBhdGgsIAogICAgICAgIHNpemVzID0gY29uZmlnLnNpemluZywgc2NhbGVzID0gY29uZmlnLnNjYWxlLCBwaWNrU2NhbGUod2lkdGgsIGhlaWdodCk7CiAgICB9LCBBc3NldE1hbmFnZXIuZ2V0UHJlZmVycmVkU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzaXplT3JkZXJbMF07CiAgICB9LCBBc3NldE1hbmFnZXIuZ2V0UHJlZmVycmVkU2NhbGUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc2NhbGVzW3NpemVPcmRlclswXV07CiAgICB9OwogICAgdmFyIHBpY2tTY2FsZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICBmb3IgKHZhciBzLCBtaW5TaXplID0gaGVpZ2h0ID4gd2lkdGggPyB3aWR0aCA6IGhlaWdodCwgaSA9IHNpemVzLmxlbmd0aCAtIDE7IGkgPj0gMCAmJiBzaXplc1tpXS5tYXhTaXplID4gbWluU2l6ZTsgLS1pKSBzID0gc2l6ZXNbaV07CiAgICAgICAgc2l6ZU9yZGVyID0gcy5vcmRlcjsKICAgIH07CiAgICBBc3NldE1hbmFnZXIuZ2V0VXJsID0gZnVuY3Rpb24oYXNzZXRJZCkgewogICAgICAgIHZhciBhID0gYXNzZXRzW2Fzc2V0SWRdOwogICAgICAgIGlmICghYSkgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKGFzc2V0VXJsQ2FjaGVbYXNzZXRJZF0pIHJldHVybiBhc3NldFVybENhY2hlW2Fzc2V0SWRdOwogICAgICAgIHZhciB1cmw7CiAgICAgICAgaWYgKGEuYW5pbSkgcmV0dXJuIHVybCA9IGFzc2V0VXJsQ2FjaGVbYXNzZXRJZF0gPSBwYXRocy5hbmltICsgYS5zcmM7CiAgICAgICAgaWYgKEFzc2V0TWFuYWdlci5sb3dIVyAmJiBhLmxvd0hXKSByZXR1cm4gQXNzZXRNYW5hZ2VyLnNjYWxlc1thc3NldElkXSA9IHNjYWxlc1thLmxvd0hXXSwgCiAgICAgICAgdXJsID0gYXNzZXRVcmxDYWNoZVthc3NldElkXSA9IHBhdGhzW2EubG93SFddICsgYS5zcmM7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaXplT3JkZXIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgdmFyIHR5cGVJZCA9IHNpemVPcmRlcltpXTsKICAgICAgICAgICAgaWYgKGFbdHlwZUlkXSkgcmV0dXJuIEFzc2V0TWFuYWdlci5zY2FsZXNbYXNzZXRJZF0gPSBzY2FsZXNbdHlwZUlkXSwgdXJsID0gYXNzZXRVcmxDYWNoZVthc3NldElkXSA9IHBhdGhzW3R5cGVJZF0gKyBhLnNyYzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LCBBc3NldE1hbmFnZXIudW5sb2FkID0gZnVuY3Rpb24oYXNzZXRPckFzc2V0cykgewogICAgICAgIGlmIChhc3NldE9yQXNzZXRzIGluc3RhbmNlb2YgQXJyYXkpIGZvciAodmFyIGkgPSBhc3NldE9yQXNzZXRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgIHZhciBpZCA9IGFzc2V0T3JBc3NldHNbaV07CiAgICAgICAgICAgIHVubG9hZEFzc2V0KGlkKTsKICAgICAgICB9IGVsc2UgdW5sb2FkQXNzZXQoYXNzZXRPckFzc2V0cyk7CiAgICB9OwogICAgdmFyIHVubG9hZEFzc2V0ID0gZnVuY3Rpb24oYXNzZXQpIHsKICAgICAgICBpZiAoYXNzZXRVcmxDYWNoZVthc3NldF0pIHsKICAgICAgICAgICAgdmFyIGEgPSBhc3NldHNbYXNzZXRdOwogICAgICAgICAgICBhICYmIChhLmFuaW0gfHwgKGEuaXNGb250ICYmIFBJWEkuQml0bWFwVGV4dC5mb250c1thc3NldF0gJiYgZGVsZXRlIFBJWEkuQml0bWFwVGV4dC5mb250c1thc3NldF0sIAogICAgICAgICAgICBQSVhJLlRleHR1cmUuZGVzdHJveVRleHR1cmUoYXNzZXRVcmxDYWNoZVthc3NldF0pLCBkZWxldGUgQXNzZXRNYW5hZ2VyLnNjYWxlc1thc3NldF0sIAogICAgICAgICAgICBkZWxldGUgYXNzZXRVcmxDYWNoZVthc3NldF0pKTsKICAgICAgICB9CiAgICB9OwogICAgQXNzZXRNYW5hZ2VyLmdldEFuaW1zID0gZnVuY3Rpb24oYW5pbXMsIG1heERpZ2l0cywgb3V0T2JqKSB7CiAgICAgICAgdm9pZCAwID09PSBtYXhEaWdpdHMgJiYgKG1heERpZ2l0cyA9IDQpLCAwID4gbWF4RGlnaXRzICYmIChtYXhEaWdpdHMgPSAwKTsKICAgICAgICB2YXIgaSwgYywgemVyb3MgPSBbXSwgY29tcGFyZXMgPSBbXTsKICAgICAgICBmb3IgKGkgPSAxOyBtYXhEaWdpdHMgPiBpOyArK2kpIHsKICAgICAgICAgICAgdmFyIHMgPSAiIjsKICAgICAgICAgICAgYyA9IDE7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBpID4gajsgKytqKSBzICs9ICIwIiwgYyAqPSAxMDsKICAgICAgICAgICAgemVyb3MudW5zaGlmdChzKSwgY29tcGFyZXMucHVzaChjKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByZXZUZXgsIGxlbiwgY29tcGFyZUxlbmd0aCA9IGNvbXBhcmVzLmxlbmd0aCwgcnRuRGljdCA9IG91dE9iaiB8fCB7fSwgZnJvbUZyYW1lID0gUElYSS5UZXh0dXJlLmZyb21GcmFtZTsKICAgICAgICBmb3IgKHZhciBhIGluIGFuaW1zKSB7CiAgICAgICAgICAgIHZhciBkYXRhID0gYW5pbXNbYV0sIGxpc3QgPSBbXTsKICAgICAgICAgICAgZm9yIChpID0gZGF0YS5udW1iZXJNaW4sIGxlbiA9IGRhdGEubnVtYmVyTWF4OyBsZW4gPj0gaTsgKytpKSB7CiAgICAgICAgICAgICAgICB2YXIgbnVtID0gbnVsbDsKICAgICAgICAgICAgICAgIGZvciAoYyA9IDA7IGNvbXBhcmVMZW5ndGggPiBjOyArK2MpIGlmIChpIDwgY29tcGFyZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICBudW0gPSB6ZXJvc1tjXSArIGk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBudW0gfHwgKG51bSA9IGkudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICB2YXIgdGV4TmFtZSA9IGRhdGEubmFtZS5yZXBsYWNlKCIjIiwgbnVtKSwgdGV4ID0gZnJvbUZyYW1lKHRleE5hbWUsICEwKTsKICAgICAgICAgICAgICAgIHRleCAmJiAocHJldlRleCA9IHRleCksIGxpc3QucHVzaChwcmV2VGV4KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBydG5EaWN0W2FdID0gbGlzdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJ0bkRpY3Q7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuQXNzZXRNYW5hZ2VyID0gQXNzZXRNYW5hZ2VyOwp9KCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 15:39:30 GMT",
                    "Content-Length": "57354",
                    "Date": "Thu, 06 Nov 2014 15:39:34 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}