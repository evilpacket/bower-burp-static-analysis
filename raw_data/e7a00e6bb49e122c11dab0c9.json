{
    "url": "http://localhost:9999/ariya/phantomjs/src/qt/qtwebkit/Source/WebCore/inspector/front-end/inspector.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>document.location</b> via the following statements:<ul><li>var url = window.location.href;</li><li>url = url.substring(0, url.length - queryParams.length);</li><li>document.location = url;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/ariya/phantomjs/src/qt/qtwebkit/Source/WebCore/inspector/front-end/inspector.js",
                "path": "/ariya/phantomjs/src/qt/qtwebkit/Source/WebCore/inspector/front-end/inspector.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9hcml5YS9waGFudG9tanMvc3JjL3F0L3F0d2Via2l0L1NvdXJjZS9XZWJDb3JlL2luc3BlY3Rvci9mcm9udC1lbmQvaW5zcGVjdG9yLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDEyODENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMjE6NTA6NDcgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDIxOjQ5OjU4IEdNVA0KDQovKgogKiBDb3B5cmlnaHQgKEMpIDIwMDYsIDIwMDcsIDIwMDggQXBwbGUgSW5jLiAgQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogQ29weXJpZ2h0IChDKSAyMDA3IE1hdHQgTGlsZWsgKHBld3Rlcm1vb3NlQGdtYWlsLmNvbSkuCiAqIENvcHlyaWdodCAoQykgMjAwOSBKb3NlcGggUGVjb3Jhcm8KICoKICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0CiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucwogKiBhcmUgbWV0OgogKgogKiAxLiAgUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKICogICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KICogMi4gIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0CiAqICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlCiAqICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgogKiAzLiAgTmVpdGhlciB0aGUgbmFtZSBvZiBBcHBsZSBDb21wdXRlciwgSW5jLiAoIkFwcGxlIikgbm9yIHRoZSBuYW1lcyBvZgogKiAgICAgaXRzIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHMgZGVyaXZlZAogKiAgICAgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLgogKgogKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIEFQUExFIEFORCBJVFMgQ09OVFJJQlVUT1JTICJBUyBJUyIgQU5EIEFOWQogKiBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVECiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUKICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgQVBQTEUgT1IgSVRTIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWQogKiBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUwogKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7CiAqIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORAogKiBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVAogKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YKICogVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KICovCgp2YXIgV2ViSW5zcGVjdG9yID0gewogICAgX3BhbmVsRGVzY3JpcHRvcnM6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLnBhbmVscyA9IHt9OwogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3ID0gbmV3IFdlYkluc3BlY3Rvci5JbnNwZWN0b3JWaWV3KCk7CiAgICAgICAgdmFyIHBhcmVudEVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibWFpbiIpOwogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LnNob3cocGFyZW50RWxlbWVudCk7CiAgICAgICAgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuSW5zcGVjdG9yVmlldy5FdmVudHMuUGFuZWxTZWxlY3RlZCwgdGhpcy5fcGFuZWxTZWxlY3RlZCwgdGhpcyk7CgogICAgICAgIHZhciBlbGVtZW50cyA9IG5ldyBXZWJJbnNwZWN0b3IuRWxlbWVudHNQYW5lbERlc2NyaXB0b3IoKTsKICAgICAgICB2YXIgcmVzb3VyY2VzID0gbmV3IFdlYkluc3BlY3Rvci5QYW5lbERlc2NyaXB0b3IoInJlc291cmNlcyIsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiUmVzb3VyY2VzIiksICJSZXNvdXJjZXNQYW5lbCIsICJSZXNvdXJjZXNQYW5lbC5qcyIpOwogICAgICAgIHZhciBuZXR3b3JrID0gbmV3IFdlYkluc3BlY3Rvci5OZXR3b3JrUGFuZWxEZXNjcmlwdG9yKCk7CiAgICAgICAgdmFyIHNjcmlwdHMgPSBuZXcgV2ViSW5zcGVjdG9yLlNjcmlwdHNQYW5lbERlc2NyaXB0b3IoKTsKICAgICAgICB2YXIgdGltZWxpbmUgPSBuZXcgV2ViSW5zcGVjdG9yLlRpbWVsaW5lUGFuZWxEZXNjcmlwdG9yKCk7CiAgICAgICAgdmFyIHByb2ZpbGVzID0gbmV3IFdlYkluc3BlY3Rvci5Qcm9maWxlc1BhbmVsRGVzY3JpcHRvcigpOwogICAgICAgIHZhciBhdWRpdHMgPSBuZXcgV2ViSW5zcGVjdG9yLlBhbmVsRGVzY3JpcHRvcigiYXVkaXRzIiwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJBdWRpdHMiKSwgIkF1ZGl0c1BhbmVsIiwgIkF1ZGl0c1BhbmVsLmpzIik7CiAgICAgICAgdmFyIGNvbnNvbGUgPSBuZXcgV2ViSW5zcGVjdG9yLlBhbmVsRGVzY3JpcHRvcigiY29uc29sZSIsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiQ29uc29sZSIpLCAiQ29uc29sZVBhbmVsIik7CiAgICAgICAgdmFyIGFsbERlc2NyaXB0b3JzID0gW2VsZW1lbnRzLCByZXNvdXJjZXMsIG5ldHdvcmssIHNjcmlwdHMsIHRpbWVsaW5lLCBwcm9maWxlcywgYXVkaXRzLCBjb25zb2xlXTsKICAgICAgICB2YXIgYWxsUHJvZmlsZXJzID0gW3Byb2ZpbGVzXTsKICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLmV4cGVyaW1lbnRzU2V0dGluZ3Muc2VwYXJhdGVQcm9maWxlcnMuaXNFbmFibGVkKCkpIHsKICAgICAgICAgICAgYWxsUHJvZmlsZXJzID0gW107CiAgICAgICAgICAgIGFsbFByb2ZpbGVycy5wdXNoKG5ldyBXZWJJbnNwZWN0b3IuUGFuZWxEZXNjcmlwdG9yKCJjcHUtcHJvZmlsZXIiLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkNQVSBQcm9maWxlciIpLCAiQ1BVUHJvZmlsZXJQYW5lbCIsICJQcm9maWxlc1BhbmVsLmpzIikpOwogICAgICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5Xb3JrZXJNYW5hZ2VyLmlzV29ya2VyRnJvbnRlbmQoKSkKICAgICAgICAgICAgICAgIGFsbFByb2ZpbGVycy5wdXNoKG5ldyBXZWJJbnNwZWN0b3IuUGFuZWxEZXNjcmlwdG9yKCJjc3MtcHJvZmlsZXIiLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkNTUyBQcm9maWxlciIpLCAiQ1NTU2VsZWN0b3JQcm9maWxlclBhbmVsIiwgIlByb2ZpbGVzUGFuZWwuanMiKSk7CiAgICAgICAgICAgIGlmIChDYXBhYmlsaXRpZXMuaGVhcFByb2ZpbGVyUHJlc2VudCkKICAgICAgICAgICAgICAgIGFsbFByb2ZpbGVycy5wdXNoKG5ldyBXZWJJbnNwZWN0b3IuUGFuZWxEZXNjcmlwdG9yKCJoZWFwLXByb2ZpbGVyIiwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJIZWFwIFByb2ZpbGVyIiksICJIZWFwUHJvZmlsZXJQYW5lbCIsICJQcm9maWxlc1BhbmVsLmpzIikpOwogICAgICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5Xb3JrZXJNYW5hZ2VyLmlzV29ya2VyRnJvbnRlbmQoKSAmJiBXZWJJbnNwZWN0b3IuZXhwZXJpbWVudHNTZXR0aW5ncy5jYW52YXNJbnNwZWN0aW9uLmlzRW5hYmxlZCgpKQogICAgICAgICAgICAgICAgYWxsUHJvZmlsZXJzLnB1c2gobmV3IFdlYkluc3BlY3Rvci5QYW5lbERlc2NyaXB0b3IoImNhbnZhcy1wcm9maWxlciIsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiQ2FudmFzIFByb2ZpbGVyIiksICJDYW52YXNQcm9maWxlclBhbmVsIiwgIlByb2ZpbGVzUGFuZWwuanMiKSk7CiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYmluZChhbGxEZXNjcmlwdG9ycywgYWxsRGVzY3JpcHRvcnMuaW5kZXhPZihwcm9maWxlcyksIDEpLmFwcGx5KG51bGwsIGFsbFByb2ZpbGVycyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFuZWxEZXNjcmlwdG9ycyA9IFtdOwogICAgICAgIGlmIChXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc1dvcmtlckZyb250ZW5kKCkpIHsKICAgICAgICAgICAgcGFuZWxEZXNjcmlwdG9ycy5wdXNoKHNjcmlwdHMpOwogICAgICAgICAgICBwYW5lbERlc2NyaXB0b3JzLnB1c2godGltZWxpbmUpOwogICAgICAgICAgICBwYW5lbERlc2NyaXB0b3JzID0gcGFuZWxEZXNjcmlwdG9ycy5jb25jYXQoYWxsUHJvZmlsZXJzKTsKICAgICAgICAgICAgcGFuZWxEZXNjcmlwdG9ycy5wdXNoKGNvbnNvbGUpOwogICAgICAgICAgICByZXR1cm4gcGFuZWxEZXNjcmlwdG9yczsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhbGxEZXNjcmlwdG9ycy5sZW5ndGg7ICsraSkKICAgICAgICAgICAgcGFuZWxEZXNjcmlwdG9ycy5wdXNoKGFsbERlc2NyaXB0b3JzW2ldKTsKICAgICAgICByZXR1cm4gcGFuZWxEZXNjcmlwdG9yczsKICAgIH0sCgogICAgX3BhbmVsU2VsZWN0ZWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnNldEVuYWJsZWQoV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkubmFtZSAhPT0gImNvbnNvbGUiKTsKICAgIH0sCgogICAgX2NyZWF0ZUdsb2JhbFN0YXR1c0Jhckl0ZW1zOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdmFyIGJvdHRvbVN0YXR1c0JhckNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJib3R0b20tc3RhdHVzLWJhci1jb250YWluZXIiKTsKCiAgICAgICAgLy8gQ3JlYXRlIG1haW4gZG9jayBidXR0b24gYW5kIG9wdGlvbnMuCiAgICAgICAgdmFyIG1haW5TdGF0dXNCYXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibWFpbi1zdGF0dXMtYmFyIik7CiAgICAgICAgbWFpblN0YXR1c0Jhci5pbnNlcnRCZWZvcmUodGhpcy5kb2NrQ29udHJvbGxlci5lbGVtZW50LCBib3R0b21TdGF0dXNCYXJDb250YWluZXIpOwoKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uID0gbmV3IFdlYkluc3BlY3Rvci5TdGF0dXNCYXJCdXR0b24oV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTaG93IGNvbnNvbGUuIiksICJjb25zb2xlLXN0YXR1cy1iYXItaXRlbSIpOwogICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uQ2xpY2tlZC5iaW5kKHRoaXMpLCBmYWxzZSk7CiAgICAgICAgbWFpblN0YXR1c0Jhci5pbnNlcnRCZWZvcmUodGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi5lbGVtZW50LCBib3R0b21TdGF0dXNCYXJDb250YWluZXIpOwoKICAgICAgICBpZiAodGhpcy5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyKQogICAgICAgICAgICBtYWluU3RhdHVzQmFyLmluc2VydEJlZm9yZSh0aGlzLmluc3BlY3RFbGVtZW50TW9kZUNvbnRyb2xsZXIudG9nZ2xlU2VhcmNoQnV0dG9uLmVsZW1lbnQsIGJvdHRvbVN0YXR1c0JhckNvbnRhaW5lcik7CgogICAgICAgIG1haW5TdGF0dXNCYXIuYXBwZW5kQ2hpbGQodGhpcy5zZXR0aW5nc0NvbnRyb2xsZXIuc3RhdHVzQmFySXRlbSk7CiAgICB9LAoKICAgIF90b2dnbGVDb25zb2xlQnV0dG9uQ2xpY2tlZDogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICghdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi5lbmFibGVkKCkpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50b2dnbGVkID0gIXRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udG9nZ2xlZDsKCiAgICAgICAgdmFyIGFuaW1hdGlvblR5cGUgPSB3aW5kb3cuZXZlbnQgJiYgd2luZG93LmV2ZW50LnNoaWZ0S2V5ID8gV2ViSW5zcGVjdG9yLkRyYXdlci5BbmltYXRpb25UeXBlLlNsb3cgOiBXZWJJbnNwZWN0b3IuRHJhd2VyLkFuaW1hdGlvblR5cGUuTm9ybWFsOwogICAgICAgIGlmICh0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRvZ2dsZWQpIHsKICAgICAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiSGlkZSBjb25zb2xlLiIpOwogICAgICAgICAgICB0aGlzLmRyYXdlci5zaG93KHRoaXMuY29uc29sZVZpZXcsIGFuaW1hdGlvblR5cGUpOwogICAgICAgICAgICB0aGlzLl9jb25zb2xlV2FzU2hvd24gPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIlNob3cgY29uc29sZS4iKTsKICAgICAgICAgICAgdGhpcy5kcmF3ZXIuaGlkZShhbmltYXRpb25UeXBlKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2NvbnNvbGVXYXNTaG93bjsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtFbGVtZW50fSBzdGF0dXNCYXJFbGVtZW50CiAgICAgKiBAcGFyYW0ge1dlYkluc3BlY3Rvci5WaWV3fSB2aWV3CiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCk9fSBvbmNsb3NlCiAgICAgKi8KICAgIHNob3dWaWV3SW5EcmF3ZXI6IGZ1bmN0aW9uKHN0YXR1c0JhckVsZW1lbnQsIHZpZXcsIG9uY2xvc2UpCiAgICB7CiAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiSGlkZSBjb25zb2xlLiIpOwogICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udG9nZ2xlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuX2Nsb3NlUHJldmlvdXNEcmF3ZXJWaWV3KCk7CgogICAgICAgIHZhciBkcmF3ZXJTdGF0dXNCYXJIZWFkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBkcmF3ZXJTdGF0dXNCYXJIZWFkZXIuY2xhc3NOYW1lID0gImRyYXdlci1oZWFkZXIgc3RhdHVzLWJhci1pdGVtIjsKICAgICAgICBkcmF3ZXJTdGF0dXNCYXJIZWFkZXIuYXBwZW5kQ2hpbGQoc3RhdHVzQmFyRWxlbWVudCk7CiAgICAgICAgZHJhd2VyU3RhdHVzQmFySGVhZGVyLm9uY2xvc2UgPSBvbmNsb3NlOwoKICAgICAgICB2YXIgY2xvc2VCdXR0b24gPSBkcmF3ZXJTdGF0dXNCYXJIZWFkZXIuY3JlYXRlQ2hpbGQoInNwYW4iKTsKICAgICAgICBjbG9zZUJ1dHRvbi50ZXh0Q29udGVudCA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiXHUwMEQ3Iik7CiAgICAgICAgY2xvc2VCdXR0b24uYWRkU3R5bGVDbGFzcygiZHJhd2VyLWhlYWRlci1jbG9zZS1idXR0b24iKTsKICAgICAgICBjbG9zZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuY2xvc2VWaWV3SW5EcmF3ZXIuYmluZCh0aGlzKSwgZmFsc2UpOwoKICAgICAgICB2YXIgcGFuZWxTdGF0dXNCYXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGFuZWwtc3RhdHVzLWJhciIpOwogICAgICAgIHZhciBkcmF3ZXJWaWV3QW5jaG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRyYXdlci12aWV3LWFuY2hvciIpOwogICAgICAgIHBhbmVsU3RhdHVzQmFyLmluc2VydEJlZm9yZShkcmF3ZXJTdGF0dXNCYXJIZWFkZXIsIGRyYXdlclZpZXdBbmNob3IpOwogICAgICAgIHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlciA9IGRyYXdlclN0YXR1c0JhckhlYWRlcjsKICAgICAgICB0aGlzLmRyYXdlci5zaG93KHZpZXcsIFdlYkluc3BlY3Rvci5EcmF3ZXIuQW5pbWF0aW9uVHlwZS5JbW1lZGlhdGVseSk7CiAgICB9LAoKICAgIGNsb3NlVmlld0luRHJhd2VyOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlcikgewogICAgICAgICAgICB0aGlzLl9jbG9zZVByZXZpb3VzRHJhd2VyVmlldygpOwoKICAgICAgICAgICAgLy8gT25jZSBkcmF3ZXIgaXMgY2xvc2VkIGNvbnNvbGUgc2hvdWxkIGJlIHNob3duIGlmIGl0IHdhcyBzaG93biBiZWZvcmUgY3VycmVudCB2aWV3IHJlcGxhY2VkIGl0IGluIGRyYXdlci4gCiAgICAgICAgICAgIGlmICghdGhpcy5fY29uc29sZVdhc1Nob3duKQogICAgICAgICAgICAgICAgdGhpcy5kcmF3ZXIuaGlkZShXZWJJbnNwZWN0b3IuRHJhd2VyLkFuaW1hdGlvblR5cGUuSW1tZWRpYXRlbHkpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uQ2xpY2tlZCgpOwogICAgICAgIH0KICAgIH0sCgogICAgX2Nsb3NlUHJldmlvdXNEcmF3ZXJWaWV3OiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlcikgewogICAgICAgICAgICB0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXIucGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXIpOwogICAgICAgICAgICBpZiAodGhpcy5fZHJhd2VyU3RhdHVzQmFySGVhZGVyLm9uY2xvc2UpCiAgICAgICAgICAgICAgICB0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXIub25jbG9zZSgpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5fZHJhd2VyU3RhdHVzQmFySGVhZGVyOwogICAgICAgIH0KICAgIH0sCgogICAgX3VwZGF0ZUVycm9yQW5kV2FybmluZ0NvdW50czogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBlcnJvcldhcm5pbmdFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImVycm9yLXdhcm5pbmctY291bnQiKTsKICAgICAgICBpZiAoIWVycm9yV2FybmluZ0VsZW1lbnQpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgdmFyIGVycm9ycyA9IFdlYkluc3BlY3Rvci5jb25zb2xlLmVycm9yczsKICAgICAgICB2YXIgd2FybmluZ3MgPSBXZWJJbnNwZWN0b3IuY29uc29sZS53YXJuaW5nczsKICAgICAgICBpZiAoIWVycm9ycyAmJiAhd2FybmluZ3MpIHsKICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC5hZGRTdHlsZUNsYXNzKCJoaWRkZW4iKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC5yZW1vdmVTdHlsZUNsYXNzKCJoaWRkZW4iKTsKCiAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC5yZW1vdmVDaGlsZHJlbigpOwoKICAgICAgICBpZiAoZXJyb3JzKSB7CiAgICAgICAgICAgIHZhciBlcnJvckltYWdlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgICAgICAgICBlcnJvckltYWdlRWxlbWVudC5pZCA9ICJlcnJvci1jb3VudC1pbWciOwogICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LmFwcGVuZENoaWxkKGVycm9ySW1hZ2VFbGVtZW50KTsKICAgICAgICAgICAgdmFyIGVycm9yRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgICAgICAgZXJyb3JFbGVtZW50LmlkID0gImVycm9yLWNvdW50IjsKICAgICAgICAgICAgZXJyb3JFbGVtZW50LnRleHRDb250ZW50ID0gZXJyb3JzOwogICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LmFwcGVuZENoaWxkKGVycm9yRWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAod2FybmluZ3MpIHsKICAgICAgICAgICAgdmFyIHdhcm5pbmdzSW1hZ2VFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgICAgICAgICAgIHdhcm5pbmdzSW1hZ2VFbGVtZW50LmlkID0gIndhcm5pbmctY291bnQtaW1nIjsKICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC5hcHBlbmRDaGlsZCh3YXJuaW5nc0ltYWdlRWxlbWVudCk7CiAgICAgICAgICAgIHZhciB3YXJuaW5nc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICAgICAgICAgIHdhcm5pbmdzRWxlbWVudC5pZCA9ICJ3YXJuaW5nLWNvdW50IjsKICAgICAgICAgICAgd2FybmluZ3NFbGVtZW50LnRleHRDb250ZW50ID0gd2FybmluZ3M7CiAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQuYXBwZW5kQ2hpbGQod2FybmluZ3NFbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIGlmIChlcnJvcnMpIHsKICAgICAgICAgICAgaWYgKHdhcm5pbmdzKSB7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3JzID09IDEpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2FybmluZ3MgPT0gMSkKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiJWQgZXJyb3IsICVkIHdhcm5pbmciLCBlcnJvcnMsIHdhcm5pbmdzKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIiVkIGVycm9yLCAlZCB3YXJuaW5ncyIsIGVycm9ycywgd2FybmluZ3MpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh3YXJuaW5ncyA9PSAxKQogICAgICAgICAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIiVkIGVycm9ycywgJWQgd2FybmluZyIsIGVycm9ycywgd2FybmluZ3MpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIiVkIGVycm9ycywgJWQgd2FybmluZ3MiLCBlcnJvcnMsIHdhcm5pbmdzKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvcnMgPT0gMSkKICAgICAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIiVkIGVycm9yIiwgZXJyb3JzKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC50aXRsZSA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiJWQgZXJyb3JzIiwgZXJyb3JzKTsKICAgICAgICB9IGVsc2UgaWYgKHdhcm5pbmdzID09IDEpCiAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIiVkIHdhcm5pbmciLCB3YXJuaW5ncyk7CiAgICAgICAgZWxzZSBpZiAod2FybmluZ3MpCiAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIiVkIHdhcm5pbmdzIiwgd2FybmluZ3MpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC50aXRsZSA9IG51bGw7CiAgICB9LAoKICAgIGdldCBpbnNwZWN0ZWRQYWdlRG9tYWluKCkKICAgIHsKICAgICAgICB2YXIgcGFyc2VkVVJMID0gV2ViSW5zcGVjdG9yLmluc3BlY3RlZFBhZ2VVUkwgJiYgV2ViSW5zcGVjdG9yLmluc3BlY3RlZFBhZ2VVUkwuYXNQYXJzZWRVUkwoKTsKICAgICAgICByZXR1cm4gcGFyc2VkVVJMID8gcGFyc2VkVVJMLmhvc3QgOiAiIjsKICAgIH0sCgogICAgX2luaXRpYWxpemVDYXBhYmlsaXR5OiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgZXJyb3IsIHJlc3VsdCkKICAgIHsKICAgICAgICBDYXBhYmlsaXRpZXNbbmFtZV0gPSByZXN1bHQ7CiAgICAgICAgaWYgKGNhbGxiYWNrKQogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgfSwKCiAgICBfem9vbUluOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fem9vbUxldmVsID0gTWF0aC5taW4odGhpcy5fem9vbUxldmVsICsgMSwgV2ViSW5zcGVjdG9yLlpvb20uVGFibGUubGVuZ3RoIC0gV2ViSW5zcGVjdG9yLlpvb20uRGVmYXVsdE9mZnNldCAtIDEpOwogICAgICAgIHRoaXMuX3JlcXVlc3Rab29tKCk7CiAgICB9LAoKICAgIF96b29tT3V0OiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fem9vbUxldmVsID0gTWF0aC5tYXgodGhpcy5fem9vbUxldmVsIC0gMSwgLVdlYkluc3BlY3Rvci5ab29tLkRlZmF1bHRPZmZzZXQpOwogICAgICAgIHRoaXMuX3JlcXVlc3Rab29tKCk7CiAgICB9LAoKICAgIF9yZXNldFpvb206IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl96b29tTGV2ZWwgPSAwOwogICAgICAgIHRoaXMuX3JlcXVlc3Rab29tKCk7CiAgICB9LAoKICAgIF9yZXF1ZXN0Wm9vbTogZnVuY3Rpb24oKQogICAgewogICAgICAgIFdlYkluc3BlY3Rvci5zZXR0aW5ncy56b29tTGV2ZWwuc2V0KHRoaXMuX3pvb21MZXZlbCk7CiAgICAgICAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCB6b29tTGV2ZWwgdGFrZXMgaW50ZWdlcnMgKHdpdGggMCBiZWluZyBkZWZhdWx0IHpvb20pLgogICAgICAgIHZhciBpbmRleCA9IHRoaXMuX3pvb21MZXZlbCArIFdlYkluc3BlY3Rvci5ab29tLkRlZmF1bHRPZmZzZXQ7CiAgICAgICAgaW5kZXggPSBNYXRoLm1pbihXZWJJbnNwZWN0b3IuWm9vbS5UYWJsZS5sZW5ndGggLSAxLCBpbmRleCk7CiAgICAgICAgaW5kZXggPSBNYXRoLm1heCgwLCBpbmRleCk7CiAgICAgICAgSW5zcGVjdG9yRnJvbnRlbmRIb3N0LnNldFpvb21GYWN0b3IoV2ViSW5zcGVjdG9yLlpvb20uVGFibGVbaW5kZXhdKTsKICAgIH0sCgogICAgX2RlYnVnZ2VyUGF1c2VkOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgLy8gQ3JlYXRlIHNjcmlwdHMgcGFuZWwgdXBvbiBkZW1hbmQuCiAgICAgICAgV2ViSW5zcGVjdG9yLnBhbmVsKCJzY3JpcHRzIik7CiAgICB9Cn0KCldlYkluc3BlY3Rvci5FdmVudHMgPSB7CiAgICBJbnNwZWN0b3JMb2FkZWQ6ICJJbnNwZWN0b3JMb2FkZWQiLAogICAgSW5zcGVjdG9yQ2xvc2luZzogIkluc3BlY3RvckNsb3NpbmciCn0KCnsoZnVuY3Rpb24gcGFyc2VRdWVyeVBhcmFtZXRlcnMoKQp7CiAgICBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QgPSB7fTsKICAgIHZhciBxdWVyeVBhcmFtcyA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2g7CiAgICBpZiAoIXF1ZXJ5UGFyYW1zKQogICAgICAgIHJldHVybjsKICAgIHZhciBwYXJhbXMgPSBxdWVyeVBhcmFtcy5zdWJzdHJpbmcoMSkuc3BsaXQoIiYiKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyYW1zLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIHBhaXIgPSBwYXJhbXNbaV0uc3BsaXQoIj0iKTsKICAgICAgICBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3RbcGFpclswXV0gPSBwYWlyWzFdOwogICAgfQp9KSgpO30KCldlYkluc3BlY3Rvci5zdWdnZXN0UmVsb2FkID0gZnVuY3Rpb24oKQp7CiAgICBpZiAod2luZG93LmNvbmZpcm0oV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJJdCBpcyByZWNvbW1lbmRlZCB0byByZXN0YXJ0IGluc3BlY3RvciBhZnRlciBtYWtpbmcgdGhlc2UgY2hhbmdlcy4gV291bGQgeW91IGxpa2UgdG8gcmVzdGFydCBpdD8iKSkpCiAgICAgICAgdGhpcy5yZWxvYWQoKTsKfQoKV2ViSW5zcGVjdG9yLnJlbG9hZCA9IGZ1bmN0aW9uKCkKewogICAgdmFyIHF1ZXJ5UGFyYW1zID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaDsKICAgIHZhciB1cmwgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgIHVybCA9IHVybC5zdWJzdHJpbmcoMCwgdXJsLmxlbmd0aCAtIHF1ZXJ5UGFyYW1zLmxlbmd0aCk7CiAgICB2YXIgcXVlcnlQYXJhbXNPYmplY3QgPSB7fTsKICAgIGZvciAodmFyIG5hbWUgaW4gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0KQogICAgICAgIHF1ZXJ5UGFyYW1zT2JqZWN0W25hbWVdID0gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0W25hbWVdOwogICAgaWYgKHRoaXMuZG9ja0NvbnRyb2xsZXIpCiAgICAgICAgcXVlcnlQYXJhbXNPYmplY3RbImRvY2tTaWRlIl0gPSB0aGlzLmRvY2tDb250cm9sbGVyLmRvY2tTaWRlKCk7CiAgICB2YXIgbmFtZXMgPSBPYmplY3Qua2V5cyhxdWVyeVBhcmFtc09iamVjdCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgKytpKQogICAgICAgIHVybCArPSAoaSA/ICImIiA6ICI/IikgKyBuYW1lc1tpXSArICI9IiArIHF1ZXJ5UGFyYW1zT2JqZWN0W25hbWVzW2ldXTsKCiAgICBJbnNwZWN0b3JCYWNrZW5kLmRpc2Nvbm5lY3QoKTsKICAgIGRvY3VtZW50LmxvY2F0aW9uID0gdXJsOwp9CgpXZWJJbnNwZWN0b3IubG9hZGVkID0gZnVuY3Rpb24oKQp7CiAgICBJbnNwZWN0b3JCYWNrZW5kLmxvYWRGcm9tSlNPTklmTmVlZGVkKCIuLi9JbnNwZWN0b3IuanNvbiIpOwogICAgV2ViSW5zcGVjdG9yLmRvY2tDb250cm9sbGVyID0gbmV3IFdlYkluc3BlY3Rvci5Eb2NrQ29udHJvbGxlcigpOwoKICAgIGlmIChXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc0RlZGljYXRlZFdvcmtlckZyb250ZW5kKCkpIHsKICAgICAgICAvLyBEbyBub3QgY3JlYXRlIHNvY2tldCBmb3IgdGhlIHdvcmtlciBmcm9udC1lbmQuCiAgICAgICAgV2ViSW5zcGVjdG9yLmRvTG9hZGVkRG9uZSgpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgd3M7CiAgICBpZiAoIndzIiBpbiBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QpCiAgICAgICAgd3MgPSAid3M6Ly8iICsgV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0LndzOwogICAgZWxzZSBpZiAoInBhZ2UiIGluIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdCkgewogICAgICAgIHZhciBwYWdlID0gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0LnBhZ2U7CiAgICAgICAgdmFyIGhvc3QgPSAiaG9zdCIgaW4gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0ID8gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0Lmhvc3QgOiB3aW5kb3cubG9jYXRpb24uaG9zdDsKICAgICAgICB3cyA9ICJ3czovLyIgKyBob3N0ICsgIi9kZXZ0b29scy9wYWdlLyIgKyBwYWdlOwogICAgfQoKICAgIGlmICh3cykgewogICAgICAgIFdlYkluc3BlY3Rvci5zb2NrZXQgPSBuZXcgV2ViU29ja2V0KHdzKTsKICAgICAgICBXZWJJbnNwZWN0b3Iuc29ja2V0Lm9ubWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsgSW5zcGVjdG9yQmFja2VuZC5kaXNwYXRjaChtZXNzYWdlLmRhdGEpOyB9CiAgICAgICAgV2ViSW5zcGVjdG9yLnNvY2tldC5vbmVycm9yID0gZnVuY3Rpb24oZXJyb3IpIHsgY29uc29sZS5lcnJvcihlcnJvcik7IH0KICAgICAgICBXZWJJbnNwZWN0b3Iuc29ja2V0Lm9ub3BlbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3Quc2VuZE1lc3NhZ2VUb0JhY2tlbmQgPSBXZWJJbnNwZWN0b3Iuc29ja2V0LnNlbmQuYmluZChXZWJJbnNwZWN0b3Iuc29ja2V0KTsKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmRvTG9hZGVkRG9uZSgpOwogICAgICAgIH0KICAgICAgICBXZWJJbnNwZWN0b3Iuc29ja2V0Lm9uY2xvc2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFXZWJJbnNwZWN0b3Iuc29ja2V0Ll9kZXRhY2hSZWFzb24pCiAgICAgICAgICAgICAgICAobmV3IFdlYkluc3BlY3Rvci5SZW1vdGVEZWJ1Z2dpbmdUZXJtaW5hdGVkU2NyZWVuKCJ3ZWJzb2NrZXRfY2xvc2VkIikpLnNob3dNb2RhbCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICB9CgogICAgV2ViSW5zcGVjdG9yLmRvTG9hZGVkRG9uZSgpOwoKICAgIC8vIEluIGNhc2Ugb2YgbG9hZGluZyBhcyBhIHdlYiBwYWdlIHdpdGggbm8gYmluZGluZ3MgLyBoYXJuZXNzLCBraWNrIG9mZiBpbml0aWFsaXphdGlvbiBtYW51YWxseS4KICAgIGlmIChJbnNwZWN0b3JGcm9udGVuZEhvc3QuaXNTdHViKSB7CiAgICAgICAgSW5zcGVjdG9yRnJvbnRlbmRBUEkuZGlzcGF0Y2hRdWVyeVBhcmFtZXRlcnMoKTsKICAgICAgICBXZWJJbnNwZWN0b3IuX2RvTG9hZGVkRG9uZVdpdGhDYXBhYmlsaXRpZXMoKTsKICAgIH0KfQoKV2ViSW5zcGVjdG9yLmRvTG9hZGVkRG9uZSA9IGZ1bmN0aW9uKCkKewogICAgLy8gSW5zdGFsbCBzdHlsZXMgYW5kIHRoZW1lcwogICAgV2ViSW5zcGVjdG9yLmluc3RhbGxQb3J0U3R5bGVzKCk7CiAgICBpZiAoV2ViSW5zcGVjdG9yLnNvY2tldCkKICAgICAgICBkb2N1bWVudC5ib2R5LmFkZFN0eWxlQ2xhc3MoInJlbW90ZSIpOwoKICAgIGlmIChXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QudG9vbGJhckNvbG9yICYmIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdC50ZXh0Q29sb3IpCiAgICAgICAgV2ViSW5zcGVjdG9yLnNldFRvb2xiYXJDb2xvcnMoV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0LnRvb2xiYXJDb2xvciwgV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0LnRleHRDb2xvcik7CgogICAgSW5zcGVjdG9yRnJvbnRlbmRIb3N0LmxvYWRlZCgpOwogICAgV2ViSW5zcGVjdG9yLldvcmtlck1hbmFnZXIubG9hZGVkKCk7CgogICAgRGVidWdnZXJBZ2VudC5jYXVzZXNSZWNvbXBpbGF0aW9uKFdlYkluc3BlY3Rvci5faW5pdGlhbGl6ZUNhcGFiaWxpdHkuYmluZChXZWJJbnNwZWN0b3IsICJkZWJ1Z2dlckNhdXNlc1JlY29tcGlsYXRpb24iLCBudWxsKSk7CiAgICBEZWJ1Z2dlckFnZW50LnN1cHBvcnRzU2VwYXJhdGVTY3JpcHRDb21waWxhdGlvbkFuZEV4ZWN1dGlvbihXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAic2VwYXJhdGVTY3JpcHRDb21waWxhdGlvbkFuZEV4ZWN1dGlvbkVuYWJsZWQiLCBudWxsKSk7CiAgICBQcm9maWxlckFnZW50LmNhdXNlc1JlY29tcGlsYXRpb24oV2ViSW5zcGVjdG9yLl9pbml0aWFsaXplQ2FwYWJpbGl0eS5iaW5kKFdlYkluc3BlY3RvciwgInByb2ZpbGVyQ2F1c2VzUmVjb21waWxhdGlvbiIsIG51bGwpKTsKICAgIFByb2ZpbGVyQWdlbnQuaXNTYW1wbGluZyhXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAic2FtcGxpbmdDUFVQcm9maWxlciIsIG51bGwpKTsKICAgIEhlYXBQcm9maWxlckFnZW50Lmhhc0hlYXBQcm9maWxlcihXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAiaGVhcFByb2ZpbGVyUHJlc2VudCIsIG51bGwpKTsKICAgIFRpbWVsaW5lQWdlbnQuc3VwcG9ydHNGcmFtZUluc3RydW1lbnRhdGlvbihXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAidGltZWxpbmVTdXBwb3J0c0ZyYW1lSW5zdHJ1bWVudGF0aW9uIiwgbnVsbCkpOwogICAgVGltZWxpbmVBZ2VudC5jYW5Nb25pdG9yTWFpblRocmVhZChXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAidGltZWxpbmVDYW5Nb25pdG9yTWFpblRocmVhZCIsIG51bGwpKTsKICAgIFBhZ2VBZ2VudC5jYW5TaG93RGVidWdCb3JkZXJzKFdlYkluc3BlY3Rvci5faW5pdGlhbGl6ZUNhcGFiaWxpdHkuYmluZChXZWJJbnNwZWN0b3IsICJjYW5TaG93RGVidWdCb3JkZXJzIiwgbnVsbCkpOwogICAgUGFnZUFnZW50LmNhblNob3dGUFNDb3VudGVyKFdlYkluc3BlY3Rvci5faW5pdGlhbGl6ZUNhcGFiaWxpdHkuYmluZChXZWJJbnNwZWN0b3IsICJjYW5TaG93RlBTQ291bnRlciIsIG51bGwpKTsKICAgIFBhZ2VBZ2VudC5jYW5Db250aW51b3VzbHlQYWludChXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAiY2FuQ29udGludW91c2x5UGFpbnQiLCBudWxsKSk7CiAgICBQYWdlQWdlbnQuY2FuT3ZlcnJpZGVEZXZpY2VNZXRyaWNzKFdlYkluc3BlY3Rvci5faW5pdGlhbGl6ZUNhcGFiaWxpdHkuYmluZChXZWJJbnNwZWN0b3IsICJjYW5PdmVycmlkZURldmljZU1ldHJpY3MiLCBudWxsKSk7CiAgICBQYWdlQWdlbnQuY2FuT3ZlcnJpZGVHZW9sb2NhdGlvbihXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAiY2FuT3ZlcnJpZGVHZW9sb2NhdGlvbiIsIG51bGwpKTsKICAgIFdvcmtlckFnZW50LmNhbkluc3BlY3RXb3JrZXJzKFdlYkluc3BlY3Rvci5faW5pdGlhbGl6ZUNhcGFiaWxpdHkuYmluZChXZWJJbnNwZWN0b3IsICJjYW5JbnNwZWN0V29ya2VycyIsIG51bGwpKTsKICAgIFBhZ2VBZ2VudC5jYW5PdmVycmlkZURldmljZU9yaWVudGF0aW9uKFdlYkluc3BlY3Rvci5faW5pdGlhbGl6ZUNhcGFiaWxpdHkuYmluZChXZWJJbnNwZWN0b3IsICJjYW5PdmVycmlkZURldmljZU9yaWVudGF0aW9uIiwgV2ViSW5zcGVjdG9yLl9kb0xvYWRlZERvbmVXaXRoQ2FwYWJpbGl0aWVzLmJpbmQoV2ViSW5zcGVjdG9yKSkpOwp9CgpXZWJJbnNwZWN0b3IuX2RvTG9hZGVkRG9uZVdpdGhDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbigpCnsKICAgIG5ldyBXZWJJbnNwZWN0b3IuVmVyc2lvbkNvbnRyb2xsZXIoKS51cGRhdGVWZXJzaW9uKCk7CgogICAgV2ViSW5zcGVjdG9yLnNob3J0Y3V0c1NjcmVlbiA9IG5ldyBXZWJJbnNwZWN0b3IuU2hvcnRjdXRzU2NyZWVuKCk7CiAgICB0aGlzLl9yZWdpc3RlclNob3J0Y3V0cygpOwoKICAgIC8vIHNldCBvcmRlciBvZiBzb21lIHNlY3Rpb25zIGV4cGxpY2l0bHkKICAgIFdlYkluc3BlY3Rvci5zaG9ydGN1dHNTY3JlZW4uc2VjdGlvbihXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkNvbnNvbGUiKSk7CiAgICBXZWJJbnNwZWN0b3Iuc2hvcnRjdXRzU2NyZWVuLnNlY3Rpb24oV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJFbGVtZW50cyBQYW5lbCIpKTsKCiAgICB2YXIgcGFuZWxEZXNjcmlwdG9ycyA9IHRoaXMuX3BhbmVsRGVzY3JpcHRvcnMoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFuZWxEZXNjcmlwdG9ycy5sZW5ndGg7ICsraSkKICAgICAgICBwYW5lbERlc2NyaXB0b3JzW2ldLnJlZ2lzdGVyU2hvcnRjdXRzKCk7CgogICAgdGhpcy5jb25zb2xlID0gbmV3IFdlYkluc3BlY3Rvci5Db25zb2xlTW9kZWwoKTsKICAgIHRoaXMuY29uc29sZS5hZGRFdmVudExpc3RlbmVyKFdlYkluc3BlY3Rvci5Db25zb2xlTW9kZWwuRXZlbnRzLkNvbnNvbGVDbGVhcmVkLCB0aGlzLl91cGRhdGVFcnJvckFuZFdhcm5pbmdDb3VudHMsIHRoaXMpOwogICAgdGhpcy5jb25zb2xlLmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLkNvbnNvbGVNb2RlbC5FdmVudHMuTWVzc2FnZUFkZGVkLCB0aGlzLl91cGRhdGVFcnJvckFuZFdhcm5pbmdDb3VudHMsIHRoaXMpOwogICAgdGhpcy5jb25zb2xlLmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLkNvbnNvbGVNb2RlbC5FdmVudHMuUmVwZWF0Q291bnRVcGRhdGVkLCB0aGlzLl91cGRhdGVFcnJvckFuZFdhcm5pbmdDb3VudHMsIHRoaXMpOwoKICAgIFdlYkluc3BlY3Rvci5DU1NNZXRhZGF0YS5yZXF1ZXN0Q1NTU2hvcnRoYW5kRGF0YSgpOwoKICAgIHRoaXMuZHJhd2VyID0gbmV3IFdlYkluc3BlY3Rvci5EcmF3ZXIoKTsKCiAgICB0aGlzLm5ldHdvcmtNYW5hZ2VyID0gbmV3IFdlYkluc3BlY3Rvci5OZXR3b3JrTWFuYWdlcigpOwogICAgdGhpcy5yZXNvdXJjZVRyZWVNb2RlbCA9IG5ldyBXZWJJbnNwZWN0b3IuUmVzb3VyY2VUcmVlTW9kZWwodGhpcy5uZXR3b3JrTWFuYWdlcik7CiAgICB0aGlzLmRlYnVnZ2VyTW9kZWwgPSBuZXcgV2ViSW5zcGVjdG9yLkRlYnVnZ2VyTW9kZWwoKTsKICAgIHRoaXMuZGVidWdnZXJNb2RlbC5hZGRFdmVudExpc3RlbmVyKFdlYkluc3BlY3Rvci5EZWJ1Z2dlck1vZGVsLkV2ZW50cy5EZWJ1Z2dlclBhdXNlZCwgdGhpcy5fZGVidWdnZXJQYXVzZWQsIHRoaXMpOwogICAgdGhpcy5uZXR3b3JrTG9nID0gbmV3IFdlYkluc3BlY3Rvci5OZXR3b3JrTG9nKCk7CiAgICB0aGlzLmRvbUFnZW50ID0gbmV3IFdlYkluc3BlY3Rvci5ET01BZ2VudCgpOwogICAgdGhpcy5ydW50aW1lTW9kZWwgPSBuZXcgV2ViSW5zcGVjdG9yLlJ1bnRpbWVNb2RlbCh0aGlzLnJlc291cmNlVHJlZU1vZGVsKTsKCiAgICB0aGlzLmNvbnNvbGVWaWV3ID0gbmV3IFdlYkluc3BlY3Rvci5Db25zb2xlVmlldyhXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc1dvcmtlckZyb250ZW5kKCkpOwoKICAgIEluc3BlY3RvckJhY2tlbmQucmVnaXN0ZXJJbnNwZWN0b3JEaXNwYXRjaGVyKHRoaXMpOwoKICAgIHRoaXMuaXNvbGF0ZWRGaWxlU3lzdGVtTWFuYWdlciA9IG5ldyBXZWJJbnNwZWN0b3IuSXNvbGF0ZWRGaWxlU3lzdGVtTWFuYWdlcigpOwogICAgdGhpcy5pc29sYXRlZEZpbGVTeXN0ZW1EaXNwYXRjaGVyID0gbmV3IFdlYkluc3BlY3Rvci5Jc29sYXRlZEZpbGVTeXN0ZW1EaXNwYXRjaGVyKHRoaXMuaXNvbGF0ZWRGaWxlU3lzdGVtTWFuYWdlcik7CiAgICB0aGlzLmZpbGVNYXBwaW5nID0gbmV3IFdlYkluc3BlY3Rvci5GaWxlTWFwcGluZygpOwogICAgdGhpcy53b3Jrc3BhY2UgPSBuZXcgV2ViSW5zcGVjdG9yLldvcmtzcGFjZSh0aGlzLmZpbGVNYXBwaW5nLCB0aGlzLmlzb2xhdGVkRmlsZVN5c3RlbU1hbmFnZXIubWFwcGluZygpKTsKCiAgICB0aGlzLmNzc01vZGVsID0gbmV3IFdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsKHRoaXMud29ya3NwYWNlKTsKICAgIHRoaXMudGltZWxpbmVNYW5hZ2VyID0gbmV3IFdlYkluc3BlY3Rvci5UaW1lbGluZU1hbmFnZXIoKTsKICAgIHRoaXMudXNlckFnZW50U3VwcG9ydCA9IG5ldyBXZWJJbnNwZWN0b3IuVXNlckFnZW50U3VwcG9ydCgpOwoKICAgIHRoaXMuc2VhcmNoQ29udHJvbGxlciA9IG5ldyBXZWJJbnNwZWN0b3IuU2VhcmNoQ29udHJvbGxlcigpOwogICAgdGhpcy5hZHZhbmNlZFNlYXJjaENvbnRyb2xsZXIgPSBuZXcgV2ViSW5zcGVjdG9yLkFkdmFuY2VkU2VhcmNoQ29udHJvbGxlcigpOwogICAgaWYgKCFXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc1dvcmtlckZyb250ZW5kKCkpCiAgICAgICAgdGhpcy5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyID0gbmV3IFdlYkluc3BlY3Rvci5JbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyKCk7CgogICAgdGhpcy5zZXR0aW5nc0NvbnRyb2xsZXIgPSBuZXcgV2ViSW5zcGVjdG9yLlNldHRpbmdzQ29udHJvbGxlcigpOwoKICAgIHRoaXMuZG9tQnJlYWtwb2ludHNTaWRlYmFyUGFuZSA9IG5ldyBXZWJJbnNwZWN0b3IuRE9NQnJlYWtwb2ludHNTaWRlYmFyUGFuZSgpOwoKICAgIHRoaXMuX3pvb21MZXZlbCA9IFdlYkluc3BlY3Rvci5zZXR0aW5ncy56b29tTGV2ZWwuZ2V0KCk7CiAgICBpZiAodGhpcy5fem9vbUxldmVsKQogICAgICAgIHRoaXMuX3JlcXVlc3Rab29tKCk7CgogICAgdmFyIGF1dG9zZWxlY3RQYW5lbCA9IFdlYkluc3BlY3Rvci5VSVN0cmluZygiYSBwYW5lbCBjaG9zZW4gYXV0b21hdGljYWxseSIpOwogICAgdmFyIG9wZW5BbmNob3JMb2NhdGlvblNldHRpbmcgPSBXZWJJbnNwZWN0b3Iuc2V0dGluZ3MuY3JlYXRlU2V0dGluZygib3BlbkxpbmtIYW5kbGVyIiwgYXV0b3NlbGVjdFBhbmVsKTsKICAgIHRoaXMub3BlbkFuY2hvckxvY2F0aW9uUmVnaXN0cnkgPSBuZXcgV2ViSW5zcGVjdG9yLkhhbmRsZXJSZWdpc3RyeShvcGVuQW5jaG9yTG9jYXRpb25TZXR0aW5nKTsKICAgIHRoaXMub3BlbkFuY2hvckxvY2F0aW9uUmVnaXN0cnkucmVnaXN0ZXJIYW5kbGVyKGF1dG9zZWxlY3RQYW5lbCwgZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfSk7CgogICAgdGhpcy53b3Jrc3BhY2VDb250cm9sbGVyID0gbmV3IFdlYkluc3BlY3Rvci5Xb3Jrc3BhY2VDb250cm9sbGVyKHRoaXMud29ya3NwYWNlKTsKCiAgICB0aGlzLmZpbGVTeXN0ZW1Xb3Jrc3BhY2VQcm92aWRlciA9IG5ldyBXZWJJbnNwZWN0b3IuRmlsZVN5c3RlbVdvcmtzcGFjZVByb3ZpZGVyKHRoaXMuaXNvbGF0ZWRGaWxlU3lzdGVtTWFuYWdlciwgdGhpcy53b3Jrc3BhY2UpOwoKICAgIHRoaXMubmV0d29ya1dvcmtzcGFjZVByb3ZpZGVyID0gbmV3IFdlYkluc3BlY3Rvci5TaW1wbGVXb3Jrc3BhY2VQcm92aWRlcih0aGlzLndvcmtzcGFjZSwgV2ViSW5zcGVjdG9yLnByb2plY3RUeXBlcy5OZXR3b3JrKTsKICAgIG5ldyBXZWJJbnNwZWN0b3IuTmV0d29ya1VJU291cmNlQ29kZVByb3ZpZGVyKHRoaXMubmV0d29ya1dvcmtzcGFjZVByb3ZpZGVyLCB0aGlzLndvcmtzcGFjZSk7CgogICAgdGhpcy5icmVha3BvaW50TWFuYWdlciA9IG5ldyBXZWJJbnNwZWN0b3IuQnJlYWtwb2ludE1hbmFnZXIoV2ViSW5zcGVjdG9yLnNldHRpbmdzLmJyZWFrcG9pbnRzLCB0aGlzLmRlYnVnZ2VyTW9kZWwsIHRoaXMud29ya3NwYWNlKTsKCiAgICB0aGlzLnNjcmlwdFNuaXBwZXRNb2RlbCA9IG5ldyBXZWJJbnNwZWN0b3IuU2NyaXB0U25pcHBldE1vZGVsKHRoaXMud29ya3NwYWNlKTsKCiAgICBuZXcgV2ViSW5zcGVjdG9yLkRlYnVnZ2VyU2NyaXB0TWFwcGluZyh0aGlzLndvcmtzcGFjZSwgdGhpcy5uZXR3b3JrV29ya3NwYWNlUHJvdmlkZXIpOwogICAgdGhpcy5saXZlRWRpdFN1cHBvcnQgPSBuZXcgV2ViSW5zcGVjdG9yLkxpdmVFZGl0U3VwcG9ydCh0aGlzLndvcmtzcGFjZSk7CiAgICB0aGlzLnN0eWxlQ29udGVudEJpbmRpbmcgPSBuZXcgV2ViSW5zcGVjdG9yLlN0eWxlQ29udGVudEJpbmRpbmcodGhpcy5jc3NNb2RlbCwgdGhpcy53b3Jrc3BhY2UpOwogICAgbmV3IFdlYkluc3BlY3Rvci5TdHlsZXNTb3VyY2VNYXBwaW5nKHRoaXMuY3NzTW9kZWwsIHRoaXMud29ya3NwYWNlKTsKICAgIGlmIChXZWJJbnNwZWN0b3IuZXhwZXJpbWVudHNTZXR0aW5ncy5zYXNzLmlzRW5hYmxlZCgpKQogICAgICAgIG5ldyBXZWJJbnNwZWN0b3IuU0FTU1NvdXJjZU1hcHBpbmcodGhpcy5jc3NNb2RlbCwgdGhpcy53b3Jrc3BhY2UsIHRoaXMubmV0d29ya1dvcmtzcGFjZVByb3ZpZGVyKTsKCiAgICBuZXcgV2ViSW5zcGVjdG9yLlByZXNlbnRhdGlvbkNvbnNvbGVNZXNzYWdlSGVscGVyKHRoaXMud29ya3NwYWNlKTsKCiAgICB0aGlzLl9jcmVhdGVHbG9iYWxTdGF0dXNCYXJJdGVtcygpOwoKICAgIHRoaXMudG9vbGJhciA9IG5ldyBXZWJJbnNwZWN0b3IuVG9vbGJhcigpOwogICAgV2ViSW5zcGVjdG9yLnN0YXJ0QmF0Y2hVcGRhdGUoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFuZWxEZXNjcmlwdG9ycy5sZW5ndGg7ICsraSkKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5hZGRQYW5lbChwYW5lbERlc2NyaXB0b3JzW2ldKTsKICAgIFdlYkluc3BlY3Rvci5lbmRCYXRjaFVwZGF0ZSgpOwoKICAgIHRoaXMuYWRkTWFpbkV2ZW50TGlzdGVuZXJzKGRvY3VtZW50KTsKCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgdGhpcy53aW5kb3dSZXNpemUuYmluZCh0aGlzKSwgdHJ1ZSk7CgogICAgdmFyIGVycm9yV2FybmluZ0NvdW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImVycm9yLXdhcm5pbmctY291bnQiKTsKICAgIGVycm9yV2FybmluZ0NvdW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5zaG93Q29uc29sZS5iaW5kKHRoaXMpLCBmYWxzZSk7CiAgICB0aGlzLl91cGRhdGVFcnJvckFuZFdhcm5pbmdDb3VudHMoKTsKCiAgICB0aGlzLmV4dGVuc2lvblNlcnZlci5pbml0RXh0ZW5zaW9ucygpOwoKICAgIHRoaXMuY29uc29sZS5lbmFibGVBZ2VudCgpOwoKICAgIGZ1bmN0aW9uIHNob3dJbml0aWFsUGFuZWwoKQogICAgewogICAgICAgIGlmICghV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkpCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoV2ViSW5zcGVjdG9yLnNldHRpbmdzLmxhc3RBY3RpdmVQYW5lbC5nZXQoKSk7CiAgICB9CgogICAgSW5zcGVjdG9yQWdlbnQuZW5hYmxlKHNob3dJbml0aWFsUGFuZWwpOwogICAgdGhpcy5kYXRhYmFzZU1vZGVsID0gbmV3IFdlYkluc3BlY3Rvci5EYXRhYmFzZU1vZGVsKCk7CiAgICB0aGlzLmRvbVN0b3JhZ2VNb2RlbCA9IG5ldyBXZWJJbnNwZWN0b3IuRE9NU3RvcmFnZU1vZGVsKCk7CgogICAgaWYgKCFDYXBhYmlsaXRpZXMucHJvZmlsZXJDYXVzZXNSZWNvbXBpbGF0aW9uIHx8IFdlYkluc3BlY3Rvci5zZXR0aW5ncy5wcm9maWxlckVuYWJsZWQuZ2V0KCkpCiAgICAgICAgUHJvZmlsZXJBZ2VudC5lbmFibGUoKTsKCiAgICBpZiAoV2ViSW5zcGVjdG9yLnNldHRpbmdzLnNob3dQYWludFJlY3RzLmdldCgpKQogICAgICAgIFBhZ2VBZ2VudC5zZXRTaG93UGFpbnRSZWN0cyh0cnVlKTsKCiAgICBpZiAoV2ViSW5zcGVjdG9yLnNldHRpbmdzLnNob3dEZWJ1Z0JvcmRlcnMuZ2V0KCkpCiAgICAgICAgUGFnZUFnZW50LnNldFNob3dEZWJ1Z0JvcmRlcnModHJ1ZSk7CgogICAgaWYgKFdlYkluc3BlY3Rvci5zZXR0aW5ncy5jb250aW51b3VzUGFpbnRpbmcuZ2V0KCkpCiAgICAgICAgUGFnZUFnZW50LnNldENvbnRpbnVvdXNQYWludGluZ0VuYWJsZWQodHJ1ZSk7CgogICAgaWYgKFdlYkluc3BlY3Rvci5zZXR0aW5ncy5qYXZhU2NyaXB0RGlzYWJsZWQuZ2V0KCkpCiAgICAgICAgUGFnZUFnZW50LnNldFNjcmlwdEV4ZWN1dGlvbkRpc2FibGVkKHRydWUpOwoKICAgIGlmIChXZWJJbnNwZWN0b3Iuc2V0dGluZ3Muc2hvd0ZQU0NvdW50ZXIuZ2V0KCkpCiAgICAgICAgUGFnZUFnZW50LnNldFNob3dGUFNDb3VudGVyKHRydWUpOwoKICAgIHRoaXMuZG9tQWdlbnQuX2VtdWxhdGVUb3VjaEV2ZW50c0NoYW5nZWQoKTsKCiAgICBXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5sb2FkQ29tcGxldGVkKCk7CiAgICBJbnNwZWN0b3JGcm9udGVuZEFQSS5sb2FkQ29tcGxldGVkKCk7CgogICAgV2ViSW5zcGVjdG9yLm5vdGlmaWNhdGlvbnMuZGlzcGF0Y2hFdmVudFRvTGlzdGVuZXJzKFdlYkluc3BlY3Rvci5FdmVudHMuSW5zcGVjdG9yTG9hZGVkKTsKfQoKdmFyIHdpbmRvd0xvYWRlZCA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGxvY2FsaXplZFN0cmluZ3NVUkwgPSBJbnNwZWN0b3JGcm9udGVuZEhvc3QubG9jYWxpemVkU3RyaW5nc1VSTCgpOwogICAgaWYgKGxvY2FsaXplZFN0cmluZ3NVUkwpIHsKICAgICAgICB2YXIgbG9jYWxpemVkU3RyaW5nc1NjcmlwdEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICBsb2NhbGl6ZWRTdHJpbmdzU2NyaXB0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgV2ViSW5zcGVjdG9yLmxvYWRlZC5iaW5kKFdlYkluc3BlY3RvciksIGZhbHNlKTsKICAgICAgICBsb2NhbGl6ZWRTdHJpbmdzU2NyaXB0RWxlbWVudC50eXBlID0gInRleHQvamF2YXNjcmlwdCI7CiAgICAgICAgbG9jYWxpemVkU3RyaW5nc1NjcmlwdEVsZW1lbnQuc3JjID0gbG9jYWxpemVkU3RyaW5nc1VSTDsKICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGxvY2FsaXplZFN0cmluZ3NTY3JpcHRFbGVtZW50KTsKICAgIH0gZWxzZQogICAgICAgIFdlYkluc3BlY3Rvci5sb2FkZWQoKTsKCiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIHdpbmRvd0xvYWRlZCwgZmFsc2UpOwogICAgZGVsZXRlIHdpbmRvd0xvYWRlZDsKfTsKCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgd2luZG93TG9hZGVkLCBmYWxzZSk7CgovLyBXZSdkIGxpa2UgdG8gZW5mb3JjZSBhc3luY2hyb25vdXMgaW50ZXJhY3Rpb24gYmV0d2VlbiB0aGUgaW5zcGVjdG9yIGNvbnRyb2xsZXIgYW5kIHRoZSBmcm9udGVuZC4KLy8gSXQgaXMgbmVlZGVkIHRvIHByZXZlbnQgcmUtZW50ZXJpbmcgdGhlIGJhY2tlbmQgY29kZS4KLy8gQWxzbywgbmF0aXZlIGRpc3BhdGNoZXMgZG8gbm90IGd1YXJhbnRlZSBzZXRUaW1lb3V0cyB0byBiZSBzZXJpYWxpemVkLCBzbyB3ZQovLyBlbmZvcmNlIHNlcmlhbGl6YXRpb24gdXNpbmcgJ21lc3NhZ2VzVG9EaXNwYXRjaCcgcXVldWUuIEl0IGlzIGFsc28gaW1wb3J0YW50IHRoYXQgSlNDIGRlYnVnZ2VyCi8vIHRlc3RzIHJlcXVpcmUgdGhhdCBlYWNoIGNvbW1hbmQgd2FzIGRpc3BhdGNoIHdpdGhpbiBpbmRpdmlkdWFsIHRpbWVvdXQgY2FsbGJhY2ssIHNvIHdlIGRvbid0IGJhdGNoIHRoZW0uCgp2YXIgbWVzc2FnZXNUb0Rpc3BhdGNoID0gW107CgpXZWJJbnNwZWN0b3IuZGlzcGF0Y2hRdWV1ZUlzRW1wdHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBtZXNzYWdlc1RvRGlzcGF0Y2gubGVuZ3RoID09IDA7Cn0KCldlYkluc3BlY3Rvci5kaXNwYXRjaCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgIG1lc3NhZ2VzVG9EaXNwYXRjaC5wdXNoKG1lc3NhZ2UpOwogICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBJbnNwZWN0b3JCYWNrZW5kLmRpc3BhdGNoKG1lc3NhZ2VzVG9EaXNwYXRjaC5zaGlmdCgpKTsKICAgIH0sIDApOwp9CgpXZWJJbnNwZWN0b3Iud2luZG93UmVzaXplID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIGlmIChXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldykKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5kb1Jlc2l6ZSgpOwogICAgaWYgKFdlYkluc3BlY3Rvci5kcmF3ZXIpCiAgICAgICAgV2ViSW5zcGVjdG9yLmRyYXdlci5yZXNpemUoKTsKICAgIGlmIChXZWJJbnNwZWN0b3IudG9vbGJhcikKICAgICAgICBXZWJJbnNwZWN0b3IudG9vbGJhci5yZXNpemUoKTsKICAgIGlmIChXZWJJbnNwZWN0b3Iuc2V0dGluZ3NDb250cm9sbGVyKQogICAgICAgIFdlYkluc3BlY3Rvci5zZXR0aW5nc0NvbnRyb2xsZXIucmVzaXplKCk7Cn0KCldlYkluc3BlY3Rvci5zZXREb2NraW5nVW5hdmFpbGFibGUgPSBmdW5jdGlvbih1bmF2YWlsYWJsZSkKewogICAgaWYgKHRoaXMuZG9ja0NvbnRyb2xsZXIpCiAgICAgICAgdGhpcy5kb2NrQ29udHJvbGxlci5zZXREb2NraW5nVW5hdmFpbGFibGUodW5hdmFpbGFibGUpOwp9CgpXZWJJbnNwZWN0b3IuY2xvc2UgPSBmdW5jdGlvbihldmVudCkKewogICAgaWYgKHRoaXMuX2lzQ2xvc2luZykKICAgICAgICByZXR1cm47CiAgICB0aGlzLl9pc0Nsb3NpbmcgPSB0cnVlOwogICAgdGhpcy5ub3RpZmljYXRpb25zLmRpc3BhdGNoRXZlbnRUb0xpc3RlbmVycyhXZWJJbnNwZWN0b3IuRXZlbnRzLkluc3BlY3RvckNsb3NpbmcpOwogICAgSW5zcGVjdG9yRnJvbnRlbmRIb3N0LmNsb3NlV2luZG93KCk7Cn0KCldlYkluc3BlY3Rvci5kb2N1bWVudENsaWNrID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIHZhciBhbmNob3IgPSBldmVudC50YXJnZXQuZW5jbG9zaW5nTm9kZU9yU2VsZldpdGhOb2RlTmFtZSgiYSIpOwogICAgaWYgKCFhbmNob3IgfHwgKGFuY2hvci50YXJnZXQgPT09ICJfYmxhbmsiKSkKICAgICAgICByZXR1cm47CgogICAgLy8gUHJldmVudCB0aGUgbGluayBmcm9tIG5hdmlnYXRpbmcsIHNpbmNlIHdlIGRvbid0IGRvIGFueSBuYXZpZ2F0aW9uIGJ5IGZvbGxvd2luZyBsaW5rcyBub3JtYWxseS4KICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CgogICAgZnVuY3Rpb24gZm9sbG93TGluaygpCiAgICB7CiAgICAgICAgaWYgKFdlYkluc3BlY3Rvci5pc0JlaW5nRWRpdGVkKGV2ZW50LnRhcmdldCkgfHwgV2ViSW5zcGVjdG9yLl9zaG93QW5jaG9yTG9jYXRpb24oYW5jaG9yKSkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBjb25zdCBwcm9maWxlTWF0Y2ggPSBXZWJJbnNwZWN0b3IuUHJvZmlsZXNQYW5lbERlc2NyaXB0b3IuUHJvZmlsZVVSTFJlZ0V4cC5leGVjKGFuY2hvci5ocmVmKTsKICAgICAgICBpZiAocHJvZmlsZU1hdGNoKSB7CiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoInByb2ZpbGVzIikuc2hvd1Byb2ZpbGUocHJvZmlsZU1hdGNoWzFdLCBwcm9maWxlTWF0Y2hbMl0pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFyc2VkVVJMID0gYW5jaG9yLmhyZWYuYXNQYXJzZWRVUkwoKTsKICAgICAgICBpZiAocGFyc2VkVVJMICYmIHBhcnNlZFVSTC5zY2hlbWUgPT09ICJ3ZWJraXQtbGluay1hY3Rpb24iKSB7CiAgICAgICAgICAgIGlmIChwYXJzZWRVUkwuaG9zdCA9PT0gInNob3ctcGFuZWwiKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFuZWwgPSBwYXJzZWRVUkwucGF0aC5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLnBhbmVsKHBhbmVsKSkKICAgICAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKHBhbmVsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3Qub3BlbkluTmV3VGFiKGFuY2hvci5ocmVmKTsKICAgIH0KCiAgICBpZiAoV2ViSW5zcGVjdG9yLmZvbGxvd0xpbmtUaW1lb3V0KQogICAgICAgIGNsZWFyVGltZW91dChXZWJJbnNwZWN0b3IuZm9sbG93TGlua1RpbWVvdXQpOwoKICAgIGlmIChhbmNob3IucHJldmVudEZvbGxvd09uRG91YmxlQ2xpY2spIHsKICAgICAgICAvLyBTdGFydCBhIHRpbWVvdXQgaWYgdGhpcyBpcyB0aGUgZmlyc3QgY2xpY2ssIGlmIHRoZSB0aW1lb3V0IGlzIGNhbmNlbGVkCiAgICAgICAgLy8gYmVmb3JlIGl0IGZpcmVzLCB0aGVuIGEgZG91YmxlIGNsaWNrZWQgaGFwcGVuZWQgb3IgYW5vdGhlciBsaW5rIHdhcyBjbGlja2VkLgogICAgICAgIGlmIChldmVudC5kZXRhaWwgPT09IDEpCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5mb2xsb3dMaW5rVGltZW91dCA9IHNldFRpbWVvdXQoZm9sbG93TGluaywgMzMzKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgZm9sbG93TGluaygpOwp9CgpXZWJJbnNwZWN0b3Iub3BlblJlc291cmNlID0gZnVuY3Rpb24ocmVzb3VyY2VVUkwsIGluUmVzb3VyY2VzUGFuZWwpCnsKICAgIHZhciByZXNvdXJjZSA9IFdlYkluc3BlY3Rvci5yZXNvdXJjZUZvclVSTChyZXNvdXJjZVVSTCk7CiAgICBpZiAoaW5SZXNvdXJjZXNQYW5lbCAmJiByZXNvdXJjZSkKICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJyZXNvdXJjZXMiKS5zaG93UmVzb3VyY2UocmVzb3VyY2UpOwogICAgZWxzZQogICAgICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5vcGVuSW5OZXdUYWIocmVzb3VyY2VVUkwpOwp9CgpXZWJJbnNwZWN0b3IuX3JlZ2lzdGVyU2hvcnRjdXRzID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgc2hvcnRjdXQgPSBXZWJJbnNwZWN0b3IuS2V5Ym9hcmRTaG9ydGN1dDsKICAgIHZhciBzZWN0aW9uID0gV2ViSW5zcGVjdG9yLnNob3J0Y3V0c1NjcmVlbi5zZWN0aW9uKFdlYkluc3BlY3Rvci5VSVN0cmluZygiQWxsIFBhbmVscyIpKTsKICAgIHZhciBrZXlzID0gWwogICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJbIiwgc2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEpLAogICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJdIiwgc2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEpCiAgICBdOwogICAgc2VjdGlvbi5hZGRSZWxhdGVkS2V5cyhrZXlzLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkdvIHRvIHRoZSBwYW5lbCB0byB0aGUgbGVmdC9yaWdodCIpKTsKCiAgICBrZXlzID0gWwogICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJbIiwgc2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEgfCBzaG9ydGN1dC5Nb2RpZmllcnMuQWx0KSwKICAgICAgICBzaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigiXSIsIHNob3J0Y3V0Lk1vZGlmaWVycy5DdHJsT3JNZXRhIHwgc2hvcnRjdXQuTW9kaWZpZXJzLkFsdCkKICAgIF07CiAgICBzZWN0aW9uLmFkZFJlbGF0ZWRLZXlzKGtleXMsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiR28gYmFjay9mb3J3YXJkIGluIHBhbmVsIGhpc3RvcnkiKSk7CgogICAgc2VjdGlvbi5hZGRLZXkoc2hvcnRjdXQubWFrZURlc2NyaXB0b3Ioc2hvcnRjdXQuS2V5cy5Fc2MpLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIlRvZ2dsZSBjb25zb2xlIikpOwogICAgc2VjdGlvbi5hZGRLZXkoc2hvcnRjdXQubWFrZURlc2NyaXB0b3IoImYiLCBzaG9ydGN1dC5Nb2RpZmllcnMuQ3RybE9yTWV0YSksIFdlYkluc3BlY3Rvci5VSVN0cmluZygiU2VhcmNoIikpOwoKICAgIHZhciBhZHZhbmNlZFNlYXJjaFNob3J0Y3V0ID0gV2ViSW5zcGVjdG9yLkFkdmFuY2VkU2VhcmNoQ29udHJvbGxlci5jcmVhdGVTaG9ydGN1dCgpOwogICAgc2VjdGlvbi5hZGRLZXkoYWR2YW5jZWRTZWFyY2hTaG9ydGN1dCwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTZWFyY2ggYWNyb3NzIGFsbCBzb3VyY2VzIikpOwoKICAgIHZhciBpbnNwZWN0RWxlbWVudE1vZGVTaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5JbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyLmNyZWF0ZVNob3J0Y3V0KCk7CiAgICBzZWN0aW9uLmFkZEtleShpbnNwZWN0RWxlbWVudE1vZGVTaG9ydGN1dCwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTZWxlY3Qgbm9kZSB0byBpbnNwZWN0IikpOwoKICAgIHZhciBvcGVuUmVzb3VyY2VTaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJvIiwgV2ViSW5zcGVjdG9yLktleWJvYXJkU2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEpOwogICAgc2VjdGlvbi5hZGRLZXkob3BlblJlc291cmNlU2hvcnRjdXQsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiR28gdG8gc291cmNlIikpOwoKICAgIGlmIChXZWJJbnNwZWN0b3IuaXNNYWMoKSkgewogICAgICAgIGtleXMgPSBbCiAgICAgICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJnIiwgc2hvcnRjdXQuTW9kaWZpZXJzLk1ldGEpLAogICAgICAgICAgICBzaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigiZyIsIHNob3J0Y3V0Lk1vZGlmaWVycy5NZXRhIHwgc2hvcnRjdXQuTW9kaWZpZXJzLlNoaWZ0KQogICAgICAgIF07CiAgICAgICAgc2VjdGlvbi5hZGRSZWxhdGVkS2V5cyhrZXlzLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkZpbmQgbmV4dC9wcmV2aW91cyIpKTsKICAgIH0KCiAgICB2YXIgZ29Ub1Nob3J0Y3V0ID0gV2ViSW5zcGVjdG9yLkdvVG9MaW5lRGlhbG9nLmNyZWF0ZVNob3J0Y3V0KCk7CiAgICBzZWN0aW9uLmFkZEtleShnb1RvU2hvcnRjdXQsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiR28gdG8gbGluZSIpKTsKCiAgICBrZXlzID0gWwogICAgICAgIHNob3J0Y3V0LktleXMuRjEsCiAgICAgICAgc2hvcnRjdXQubWFrZURlc2NyaXB0b3IoIj8iKQogICAgXTsKICAgIHNlY3Rpb24uYWRkQWx0ZXJuYXRlS2V5cyhrZXlzLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIlNob3cga2V5Ym9hcmQgc2hvcnRjdXRzIikpOwp9CgovKioKICogQHBhcmFtIHtLZXlib2FyZEV2ZW50fSBldmVudAogKi8KV2ViSW5zcGVjdG9yLmRvY3VtZW50S2V5RG93biA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBjb25zdCBoZWxwS2V5ID0gV2ViSW5zcGVjdG9yLmlzTWFjKCkgPyAiVSswMDNGIiA6ICJVKzAwQkYiOyAvLyAiPyIgZm9yIGJvdGggcGxhdGZvcm1zCgogICAgaWYgKGV2ZW50LmtleUlkZW50aWZpZXIgPT09ICJGMSIgfHwKICAgICAgICAoZXZlbnQua2V5SWRlbnRpZmllciA9PT0gaGVscEtleSAmJiBldmVudC5zaGlmdEtleSAmJiAoIVdlYkluc3BlY3Rvci5pc0JlaW5nRWRpdGVkKGV2ZW50LnRhcmdldCkgfHwgZXZlbnQubWV0YUtleSkpKSB7CiAgICAgICAgdGhpcy5zZXR0aW5nc0NvbnRyb2xsZXIuc2hvd1NldHRpbmdzU2NyZWVuKFdlYkluc3BlY3Rvci5TZXR0aW5nc1NjcmVlbi5UYWJzLlNob3J0Y3V0cyk7CiAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKFdlYkluc3BlY3Rvci5jdXJyZW50Rm9jdXNFbGVtZW50KCkgJiYgV2ViSW5zcGVjdG9yLmN1cnJlbnRGb2N1c0VsZW1lbnQoKS5oYW5kbGVLZXlFdmVudCkgewogICAgICAgIFdlYkluc3BlY3Rvci5jdXJyZW50Rm9jdXNFbGVtZW50KCkuaGFuZGxlS2V5RXZlbnQoZXZlbnQpOwogICAgICAgIGlmIChldmVudC5oYW5kbGVkKSB7CiAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgaWYgKFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpKSB7CiAgICAgICAgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkuaGFuZGxlU2hvcnRjdXQoZXZlbnQpOwogICAgICAgIGlmIChldmVudC5oYW5kbGVkKSB7CiAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgaWYgKFdlYkluc3BlY3Rvci5zZWFyY2hDb250cm9sbGVyLmhhbmRsZVNob3J0Y3V0KGV2ZW50KSkKICAgICAgICByZXR1cm47CiAgICBpZiAoV2ViSW5zcGVjdG9yLmFkdmFuY2VkU2VhcmNoQ29udHJvbGxlci5oYW5kbGVTaG9ydGN1dChldmVudCkpCiAgICAgICAgcmV0dXJuOwogICAgaWYgKFdlYkluc3BlY3Rvci5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyICYmIFdlYkluc3BlY3Rvci5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyLmhhbmRsZVNob3J0Y3V0KGV2ZW50KSkKICAgICAgICByZXR1cm47CgogICAgc3dpdGNoIChldmVudC5rZXlJZGVudGlmaWVyKSB7CiAgICAgICAgY2FzZSAiVSswMDRGIjogLy8gTyBrZXkKICAgICAgICAgICAgaWYgKCFldmVudC5zaGlmdEtleSAmJiAhZXZlbnQuYWx0S2V5ICYmIFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0LmV2ZW50SGFzQ3RybE9yTWV0YShldmVudCkpIHsKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoInNjcmlwdHMiKS5zaG93R29Ub1NvdXJjZURpYWxvZygpOwogICAgICAgICAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJVKzAwNTIiOiAvLyBSIGtleQogICAgICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLktleWJvYXJkU2hvcnRjdXQuZXZlbnRIYXNDdHJsT3JNZXRhKGV2ZW50KSkgewogICAgICAgICAgICAgICAgUGFnZUFnZW50LnJlbG9hZChldmVudC5zaGlmdEtleSk7CiAgICAgICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3aW5kb3cuREVCVUcgJiYgZXZlbnQuYWx0S2V5KSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IucmVsb2FkKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiRjUiOgogICAgICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5pc01hYygpKSB7CiAgICAgICAgICAgICAgICBQYWdlQWdlbnQucmVsb2FkKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQuc2hpZnRLZXkpOwogICAgICAgICAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgaXNWYWxpZFpvb21TaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0LmV2ZW50SGFzQ3RybE9yTWV0YShldmVudCkgJiYKICAgICAgICAhZXZlbnQuYWx0S2V5ICYmCiAgICAgICAgIUluc3BlY3RvckZyb250ZW5kSG9zdC5pc1N0dWI7CiAgICBzd2l0Y2ggKGV2ZW50LmtleUNvZGUpIHsKICAgICAgICBjYXNlIDEwNzogLy8gKwogICAgICAgIGNhc2UgMTg3OiAvLyArCiAgICAgICAgICAgIGlmIChpc1ZhbGlkWm9vbVNob3J0Y3V0KSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IuX3pvb21JbigpOwogICAgICAgICAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDEwOTogLy8gLQogICAgICAgIGNhc2UgMTg5OiAvLyAtCiAgICAgICAgICAgIGlmIChpc1ZhbGlkWm9vbVNob3J0Y3V0KSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IuX3pvb21PdXQoKTsKICAgICAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSA0ODogLy8gMAogICAgICAgICAgICAvLyBab29tIHJlc2V0IHNob3J0Y3V0IGRvZXMgbm90IGFsbG93ICJTaGlmdCIgd2hlbiBoYW5kbGVkIGJ5IHRoZSBicm93c2VyLgogICAgICAgICAgICBpZiAoaXNWYWxpZFpvb21TaG9ydGN1dCAmJiAhZXZlbnQuc2hpZnRLZXkpIHsKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5fcmVzZXRab29tKCk7CiAgICAgICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgfQp9CgpXZWJJbnNwZWN0b3IucG9zdERvY3VtZW50S2V5RG93biA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBpZiAoZXZlbnQuaGFuZGxlZCkKICAgICAgICByZXR1cm47CgogICAgaWYgKGV2ZW50LmtleUNvZGUgPT09IFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0LktleXMuRXNjLmNvZGUpIHsKICAgICAgICAvLyBJZiBkcmF3ZXIgaXMgb3BlbiB3aXRoIHNvbWUgdmlldyBvdGhlciB0aGFuIGNvbnNvbGUgdGhlbiBjbG9zZSBpdC4KICAgICAgICBpZiAoIXRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udG9nZ2xlZCAmJiBXZWJJbnNwZWN0b3IuZHJhd2VyLnZpc2libGUpCiAgICAgICAgICAgIHRoaXMuY2xvc2VWaWV3SW5EcmF3ZXIoKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b25DbGlja2VkKCk7CiAgICB9Cn0KCldlYkluc3BlY3Rvci5kb2N1bWVudENhbkNvcHkgPSBmdW5jdGlvbihldmVudCkKewogICAgaWYgKFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpICYmIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpLmhhbmRsZUNvcHlFdmVudCkKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwp9CgpXZWJJbnNwZWN0b3IuZG9jdW1lbnRDb3B5ID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIGlmIChXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5jdXJyZW50UGFuZWwoKSAmJiBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5jdXJyZW50UGFuZWwoKS5oYW5kbGVDb3B5RXZlbnQpCiAgICAgICAgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkuaGFuZGxlQ29weUV2ZW50KGV2ZW50KTsKICAgIFdlYkluc3BlY3Rvci5kb2N1bWVudENvcHlFdmVudEZpcmVkKGV2ZW50KTsKfQoKV2ViSW5zcGVjdG9yLmRvY3VtZW50Q29weUV2ZW50RmlyZWQgPSBmdW5jdGlvbihldmVudCkKewp9CgpXZWJJbnNwZWN0b3IuY29udGV4dE1lbnVFdmVudEZpcmVkID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIGlmIChldmVudC5oYW5kbGVkIHx8IGV2ZW50LnRhcmdldC5oYXNTdHlsZUNsYXNzKCJwb3B1cC1nbGFzc3BhbmUiKSkKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwp9CgpXZWJJbnNwZWN0b3Iuc2hvd0NvbnNvbGUgPSBmdW5jdGlvbigpCnsKICAgIGlmIChXZWJJbnNwZWN0b3IuX3RvZ2dsZUNvbnNvbGVCdXR0b24gJiYgIVdlYkluc3BlY3Rvci5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50b2dnbGVkKSB7CiAgICAgICAgaWYgKFdlYkluc3BlY3Rvci5kcmF3ZXIudmlzaWJsZSkKICAgICAgICAgICAgdGhpcy5fY2xvc2VQcmV2aW91c0RyYXdlclZpZXcoKTsKICAgICAgICBXZWJJbnNwZWN0b3IuX3RvZ2dsZUNvbnNvbGVCdXR0b25DbGlja2VkKCk7CiAgICB9Cn0KCldlYkluc3BlY3Rvci5zaG93UGFuZWwgPSBmdW5jdGlvbihwYW5lbCkKewogICAgcmV0dXJuIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LnNob3dQYW5lbChwYW5lbCk7Cn0KCldlYkluc3BlY3Rvci5wYW5lbCA9IGZ1bmN0aW9uKHBhbmVsKQp7CiAgICByZXR1cm4gV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcucGFuZWwocGFuZWwpOwp9CgpXZWJJbnNwZWN0b3IuYnJpbmdUb0Zyb250ID0gZnVuY3Rpb24oKQp7CiAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3QuYnJpbmdUb0Zyb250KCk7Cn0KCi8qKgogKiBAcGFyYW0ge3N0cmluZz19IG1lc3NhZ2VMZXZlbAogKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93Q29uc29sZQogKi8KV2ViSW5zcGVjdG9yLmxvZyA9IGZ1bmN0aW9uKG1lc3NhZ2UsIG1lc3NhZ2VMZXZlbCwgc2hvd0NvbnNvbGUpCnsKICAgIC8vIHJlbWVtYmVyICd0aGlzJyBmb3Igc2V0SW50ZXJ2YWwoKSBjYWxsYmFjawogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIHJldHVybiBpbmRpY2F0aW9uIGlmIHdlIGNhbiBhY3R1YWxseSBsb2cgYSBtZXNzYWdlCiAgICBmdW5jdGlvbiBpc0xvZ0F2YWlsYWJsZSgpCiAgICB7CiAgICAgICAgcmV0dXJuIFdlYkluc3BlY3Rvci5Db25zb2xlTWVzc2FnZSAmJiBXZWJJbnNwZWN0b3IuUmVtb3RlT2JqZWN0ICYmIHNlbGYuY29uc29sZTsKICAgIH0KCiAgICAvLyBmbHVzaCB0aGUgcXVldWUgb2YgcGVuZGluZyBtZXNzYWdlcwogICAgZnVuY3Rpb24gZmx1c2hRdWV1ZSgpCiAgICB7CiAgICAgICAgdmFyIHF1ZXVlZCA9IFdlYkluc3BlY3Rvci5sb2cucXVldWVkOwogICAgICAgIGlmICghcXVldWVkKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWVkLmxlbmd0aDsgKytpKQogICAgICAgICAgICBsb2dNZXNzYWdlKHF1ZXVlZFtpXSk7CgogICAgICAgIGRlbGV0ZSBXZWJJbnNwZWN0b3IubG9nLnF1ZXVlZDsKICAgIH0KCiAgICAvLyBmbHVzaCB0aGUgcXVldWUgaWYgaXQgY29uc29sZSBpcyBhdmFpbGFibGUKICAgIC8vIC0gdGhpcyBmdW5jdGlvbiBpcyBydW4gb24gYW4gaW50ZXJ2YWwKICAgIGZ1bmN0aW9uIGZsdXNoUXVldWVJZkF2YWlsYWJsZSgpCiAgICB7CiAgICAgICAgaWYgKCFpc0xvZ0F2YWlsYWJsZSgpKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGNsZWFySW50ZXJ2YWwoV2ViSW5zcGVjdG9yLmxvZy5pbnRlcnZhbCk7CiAgICAgICAgZGVsZXRlIFdlYkluc3BlY3Rvci5sb2cuaW50ZXJ2YWw7CgogICAgICAgIGZsdXNoUXVldWUoKTsKICAgIH0KCiAgICAvLyBhY3R1YWxseSBsb2cgdGhlIG1lc3NhZ2UKICAgIGZ1bmN0aW9uIGxvZ01lc3NhZ2UobWVzc2FnZSkKICAgIHsKICAgICAgICAvLyBwb3N0IHRoZSBtZXNzYWdlCiAgICAgICAgdmFyIG1zZyA9IFdlYkluc3BlY3Rvci5Db25zb2xlTWVzc2FnZS5jcmVhdGUoCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5Db25zb2xlTWVzc2FnZS5NZXNzYWdlU291cmNlLk90aGVyLAogICAgICAgICAgICBtZXNzYWdlTGV2ZWwgfHwgV2ViSW5zcGVjdG9yLkNvbnNvbGVNZXNzYWdlLk1lc3NhZ2VMZXZlbC5EZWJ1ZywKICAgICAgICAgICAgbWVzc2FnZSk7CgogICAgICAgIHNlbGYuY29uc29sZS5hZGRNZXNzYWdlKG1zZyk7CiAgICAgICAgaWYgKHNob3dDb25zb2xlKQogICAgICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd0NvbnNvbGUoKTsKICAgIH0KCiAgICAvLyBpZiB3ZSBjYW4ndCBsb2cgdGhlIG1lc3NhZ2UsIHF1ZXVlIGl0CiAgICBpZiAoIWlzTG9nQXZhaWxhYmxlKCkpIHsKICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5sb2cucXVldWVkKQogICAgICAgICAgICBXZWJJbnNwZWN0b3IubG9nLnF1ZXVlZCA9IFtdOwoKICAgICAgICBXZWJJbnNwZWN0b3IubG9nLnF1ZXVlZC5wdXNoKG1lc3NhZ2UpOwoKICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5sb2cuaW50ZXJ2YWwpCiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5sb2cuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmbHVzaFF1ZXVlSWZBdmFpbGFibGUsIDEwMDApOwoKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gZmx1c2ggdGhlIHBlbmRpbmcgcXVldWUgaWYgYW55CiAgICBmbHVzaFF1ZXVlKCk7CgogICAgLy8gbG9nIHRoZSBtZXNzYWdlCiAgICBsb2dNZXNzYWdlKG1lc3NhZ2UpOwp9CgpXZWJJbnNwZWN0b3Iuc2hvd0Vycm9yTWVzc2FnZSA9IGZ1bmN0aW9uKGVycm9yKQp7CiAgICBXZWJJbnNwZWN0b3IubG9nKGVycm9yLCBXZWJJbnNwZWN0b3IuQ29uc29sZU1lc3NhZ2UuTWVzc2FnZUxldmVsLkVycm9yLCB0cnVlKTsKfQoKLy8gSW5zcGVjdG9yLmluc3BlY3QgcHJvdG9jb2wgZXZlbnQKV2ViSW5zcGVjdG9yLmluc3BlY3QgPSBmdW5jdGlvbihwYXlsb2FkLCBoaW50cykKewogICAgdmFyIG9iamVjdCA9IFdlYkluc3BlY3Rvci5SZW1vdGVPYmplY3QuZnJvbVBheWxvYWQocGF5bG9hZCk7CiAgICBpZiAob2JqZWN0LnN1YnR5cGUgPT09ICJub2RlIikgewogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKG5vZGVJZCkKICAgICAgICB7CiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5fdXBkYXRlRm9jdXNlZE5vZGUobm9kZUlkKTsKICAgICAgICAgICAgb2JqZWN0LnJlbGVhc2UoKTsKICAgICAgICB9CiAgICAgICAgb2JqZWN0LnB1c2hOb2RlVG9Gcm9udGVuZChjYWxsYmFjayk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChoaW50cy5kYXRhYmFzZUlkKQogICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoInJlc291cmNlcyIpLnNlbGVjdERhdGFiYXNlKFdlYkluc3BlY3Rvci5kYXRhYmFzZU1vZGVsLmRhdGFiYXNlRm9ySWQoaGludHMuZGF0YWJhc2VJZCkpOwogICAgZWxzZSBpZiAoaGludHMuZG9tU3RvcmFnZUlkKQogICAgICAgIFdlYkluc3BlY3Rvci5zaG93UGFuZWwoInJlc291cmNlcyIpLnNlbGVjdERPTVN0b3JhZ2UoV2ViSW5zcGVjdG9yLmRvbVN0b3JhZ2VNb2RlbC5zdG9yYWdlRm9ySWQoaGludHMuZG9tU3RvcmFnZUlkKSk7CgogICAgb2JqZWN0LnJlbGVhc2UoKTsKfQoKLy8gSW5zcGVjdG9yLmRldGFjaGVkIHByb3RvY29sIGV2ZW50CldlYkluc3BlY3Rvci5kZXRhY2hlZCA9IGZ1bmN0aW9uKHJlYXNvbikKewogICAgV2ViSW5zcGVjdG9yLnNvY2tldC5fZGV0YWNoUmVhc29uID0gcmVhc29uOwogICAgKG5ldyBXZWJJbnNwZWN0b3IuUmVtb3RlRGVidWdnaW5nVGVybWluYXRlZFNjcmVlbihyZWFzb24pKS5zaG93TW9kYWwoKTsKfQoKV2ViSW5zcGVjdG9yLnRhcmdldENyYXNoZWQgPSBmdW5jdGlvbigpCnsKICAgIChuZXcgV2ViSW5zcGVjdG9yLkhlbHBTY3JlZW5VbnRpbFJlbG9hZCgKICAgICAgICBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkluc3BlY3RlZCB0YXJnZXQgY3Jhc2hlZCIpLAogICAgICAgIFdlYkluc3BlY3Rvci5VSVN0cmluZygiSW5zcGVjdGVkIHRhcmdldCBoYXMgY3Jhc2hlZC4gT25jZSBpdCByZWxvYWRzIHdlIHdpbGwgYXR0YWNoIHRvIGl0IGF1dG9tYXRpY2FsbHkuIikpKS5zaG93TW9kYWwoKTsKfQoKV2ViSW5zcGVjdG9yLl91cGRhdGVGb2N1c2VkTm9kZSA9IGZ1bmN0aW9uKG5vZGVJZCkKewogICAgaWYgKFdlYkluc3BlY3Rvci5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyICYmIFdlYkluc3BlY3Rvci5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyLmVuYWJsZWQoKSkgewogICAgICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5icmluZ1RvRnJvbnQoKTsKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlci5kaXNhYmxlKCk7CiAgICB9CiAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJlbGVtZW50cyIpLnJldmVhbEFuZFNlbGVjdE5vZGUobm9kZUlkKTsKfQoKV2ViSW5zcGVjdG9yLl9zaG93QW5jaG9yTG9jYXRpb24gPSBmdW5jdGlvbihhbmNob3IpCnsKICAgIGlmIChXZWJJbnNwZWN0b3Iub3BlbkFuY2hvckxvY2F0aW9uUmVnaXN0cnkuZGlzcGF0Y2goeyB1cmw6IGFuY2hvci5ocmVmLCBsaW5lTnVtYmVyOiBhbmNob3IubGluZU51bWJlcn0pKQogICAgICAgIHJldHVybiB0cnVlOwogICAgdmFyIHByZWZlcnJlZFBhbmVsID0gdGhpcy5wYW5lbHNbYW5jaG9yLnByZWZlcnJlZFBhbmVsXTsKICAgIGlmIChwcmVmZXJyZWRQYW5lbCAmJiBXZWJJbnNwZWN0b3IuX3Nob3dBbmNob3JMb2NhdGlvbkluUGFuZWwoYW5jaG9yLCBwcmVmZXJyZWRQYW5lbCkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICBpZiAoV2ViSW5zcGVjdG9yLl9zaG93QW5jaG9yTG9jYXRpb25JblBhbmVsKGFuY2hvciwgdGhpcy5wYW5lbCgic2NyaXB0cyIpKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIGlmIChXZWJJbnNwZWN0b3IuX3Nob3dBbmNob3JMb2NhdGlvbkluUGFuZWwoYW5jaG9yLCB0aGlzLnBhbmVsKCJyZXNvdXJjZXMiKSkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICBpZiAoV2ViSW5zcGVjdG9yLl9zaG93QW5jaG9yTG9jYXRpb25JblBhbmVsKGFuY2hvciwgdGhpcy5wYW5lbCgibmV0d29yayIpKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiBmYWxzZTsKfQoKV2ViSW5zcGVjdG9yLl9zaG93QW5jaG9yTG9jYXRpb25JblBhbmVsID0gZnVuY3Rpb24oYW5jaG9yLCBwYW5lbCkKewogICAgaWYgKCFwYW5lbCB8fCAhcGFuZWwuY2FuU2hvd0FuY2hvckxvY2F0aW9uKGFuY2hvcikpCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIC8vIEZJWE1FOiBzdXBwb3J0IHdlYmtpdC1odG1sLWV4dGVybmFsLWxpbmsgbGlua3MgaGVyZS4KICAgIGlmIChhbmNob3IuaGFzU3R5bGVDbGFzcygid2Via2l0LWh0bWwtZXh0ZXJuYWwtbGluayIpKSB7CiAgICAgICAgYW5jaG9yLnJlbW92ZVN0eWxlQ2xhc3MoIndlYmtpdC1odG1sLWV4dGVybmFsLWxpbmsiKTsKICAgICAgICBhbmNob3IuYWRkU3R5bGVDbGFzcygid2Via2l0LWh0bWwtcmVzb3VyY2UtbGluayIpOwogICAgfQoKICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LnNob3dQYW5lbEZvckFuY2hvck5hdmlnYXRpb24ocGFuZWwpOwogICAgcGFuZWwuc2hvd0FuY2hvckxvY2F0aW9uKGFuY2hvcik7CiAgICByZXR1cm4gdHJ1ZTsKfQoKV2ViSW5zcGVjdG9yLmV2YWx1YXRlSW5Db25zb2xlID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgc2hvd1Jlc3VsdE9ubHkpCnsKICAgIHRoaXMuc2hvd0NvbnNvbGUoKTsKICAgIHRoaXMuY29uc29sZVZpZXcuZXZhbHVhdGVVc2luZ1RleHRQcm9tcHQoZXhwcmVzc2lvbiwgc2hvd1Jlc3VsdE9ubHkpOwp9CgpXZWJJbnNwZWN0b3IuYWRkTWFpbkV2ZW50TGlzdGVuZXJzID0gZnVuY3Rpb24oZG9jKQp7CiAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMuZG9jdW1lbnRLZXlEb3duLmJpbmQodGhpcyksIHRydWUpOwogICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLnBvc3REb2N1bWVudEtleURvd24uYmluZCh0aGlzKSwgZmFsc2UpOwogICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoImJlZm9yZWNvcHkiLCB0aGlzLmRvY3VtZW50Q2FuQ29weS5iaW5kKHRoaXMpLCB0cnVlKTsKICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCJjb3B5IiwgdGhpcy5kb2N1bWVudENvcHkuYmluZCh0aGlzKSwgZmFsc2UpOwogICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51IiwgdGhpcy5jb250ZXh0TWVudUV2ZW50RmlyZWQuYmluZCh0aGlzKSwgdHJ1ZSk7CiAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLmRvY3VtZW50Q2xpY2suYmluZCh0aGlzKSwgdHJ1ZSk7Cn0KCldlYkluc3BlY3Rvci5ab29tID0gewogICAgVGFibGU6IFswLjI1LCAwLjMzLCAwLjUsIDAuNjYsIDAuNzUsIDAuOSwgMSwgMS4xLCAxLjI1LCAxLjUsIDEuNzUsIDIsIDIuNSwgMywgNCwgNV0sCiAgICBEZWZhdWx0T2Zmc2V0OiA2Cn0K",
                "body": "LyoKICogQ29weXJpZ2h0IChDKSAyMDA2LCAyMDA3LCAyMDA4IEFwcGxlIEluYy4gIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIENvcHlyaWdodCAoQykgMjAwNyBNYXR0IExpbGVrIChwZXd0ZXJtb29zZUBnbWFpbC5jb20pLgogKiBDb3B5cmlnaHQgKEMpIDIwMDkgSm9zZXBoIFBlY29yYXJvCiAqCiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dAogKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMKICogYXJlIG1ldDoKICoKICogMS4gIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiAqICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiAqIDIuICBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodAogKiAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZQogKiAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KICogMy4gIE5laXRoZXIgdGhlIG5hbWUgb2YgQXBwbGUgQ29tcHV0ZXIsIEluYy4gKCJBcHBsZSIpIG5vciB0aGUgbmFtZXMgb2YKICogICAgIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzIGRlcml2ZWQKICogICAgIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi4KICoKICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBBUFBMRSBBTkQgSVRTIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORCBBTlkKICogRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAogKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFCiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFQUExFIE9SIElUUyBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkKICogRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMKICogKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOwogKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQKICogT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlQKICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFIE9GCiAqIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiAqLwoKdmFyIFdlYkluc3BlY3RvciA9IHsKICAgIF9wYW5lbERlc2NyaXB0b3JzOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5wYW5lbHMgPSB7fTsKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldyA9IG5ldyBXZWJJbnNwZWN0b3IuSW5zcGVjdG9yVmlldygpOwogICAgICAgIHZhciBwYXJlbnRFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1haW4iKTsKICAgICAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5zaG93KHBhcmVudEVsZW1lbnQpOwogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLkluc3BlY3RvclZpZXcuRXZlbnRzLlBhbmVsU2VsZWN0ZWQsIHRoaXMuX3BhbmVsU2VsZWN0ZWQsIHRoaXMpOwoKICAgICAgICB2YXIgZWxlbWVudHMgPSBuZXcgV2ViSW5zcGVjdG9yLkVsZW1lbnRzUGFuZWxEZXNjcmlwdG9yKCk7CiAgICAgICAgdmFyIHJlc291cmNlcyA9IG5ldyBXZWJJbnNwZWN0b3IuUGFuZWxEZXNjcmlwdG9yKCJyZXNvdXJjZXMiLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIlJlc291cmNlcyIpLCAiUmVzb3VyY2VzUGFuZWwiLCAiUmVzb3VyY2VzUGFuZWwuanMiKTsKICAgICAgICB2YXIgbmV0d29yayA9IG5ldyBXZWJJbnNwZWN0b3IuTmV0d29ya1BhbmVsRGVzY3JpcHRvcigpOwogICAgICAgIHZhciBzY3JpcHRzID0gbmV3IFdlYkluc3BlY3Rvci5TY3JpcHRzUGFuZWxEZXNjcmlwdG9yKCk7CiAgICAgICAgdmFyIHRpbWVsaW5lID0gbmV3IFdlYkluc3BlY3Rvci5UaW1lbGluZVBhbmVsRGVzY3JpcHRvcigpOwogICAgICAgIHZhciBwcm9maWxlcyA9IG5ldyBXZWJJbnNwZWN0b3IuUHJvZmlsZXNQYW5lbERlc2NyaXB0b3IoKTsKICAgICAgICB2YXIgYXVkaXRzID0gbmV3IFdlYkluc3BlY3Rvci5QYW5lbERlc2NyaXB0b3IoImF1ZGl0cyIsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiQXVkaXRzIiksICJBdWRpdHNQYW5lbCIsICJBdWRpdHNQYW5lbC5qcyIpOwogICAgICAgIHZhciBjb25zb2xlID0gbmV3IFdlYkluc3BlY3Rvci5QYW5lbERlc2NyaXB0b3IoImNvbnNvbGUiLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkNvbnNvbGUiKSwgIkNvbnNvbGVQYW5lbCIpOwogICAgICAgIHZhciBhbGxEZXNjcmlwdG9ycyA9IFtlbGVtZW50cywgcmVzb3VyY2VzLCBuZXR3b3JrLCBzY3JpcHRzLCB0aW1lbGluZSwgcHJvZmlsZXMsIGF1ZGl0cywgY29uc29sZV07CiAgICAgICAgdmFyIGFsbFByb2ZpbGVycyA9IFtwcm9maWxlc107CiAgICAgICAgaWYgKFdlYkluc3BlY3Rvci5leHBlcmltZW50c1NldHRpbmdzLnNlcGFyYXRlUHJvZmlsZXJzLmlzRW5hYmxlZCgpKSB7CiAgICAgICAgICAgIGFsbFByb2ZpbGVycyA9IFtdOwogICAgICAgICAgICBhbGxQcm9maWxlcnMucHVzaChuZXcgV2ViSW5zcGVjdG9yLlBhbmVsRGVzY3JpcHRvcigiY3B1LXByb2ZpbGVyIiwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJDUFUgUHJvZmlsZXIiKSwgIkNQVVByb2ZpbGVyUGFuZWwiLCAiUHJvZmlsZXNQYW5lbC5qcyIpKTsKICAgICAgICAgICAgaWYgKCFXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc1dvcmtlckZyb250ZW5kKCkpCiAgICAgICAgICAgICAgICBhbGxQcm9maWxlcnMucHVzaChuZXcgV2ViSW5zcGVjdG9yLlBhbmVsRGVzY3JpcHRvcigiY3NzLXByb2ZpbGVyIiwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJDU1MgUHJvZmlsZXIiKSwgIkNTU1NlbGVjdG9yUHJvZmlsZXJQYW5lbCIsICJQcm9maWxlc1BhbmVsLmpzIikpOwogICAgICAgICAgICBpZiAoQ2FwYWJpbGl0aWVzLmhlYXBQcm9maWxlclByZXNlbnQpCiAgICAgICAgICAgICAgICBhbGxQcm9maWxlcnMucHVzaChuZXcgV2ViSW5zcGVjdG9yLlBhbmVsRGVzY3JpcHRvcigiaGVhcC1wcm9maWxlciIsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiSGVhcCBQcm9maWxlciIpLCAiSGVhcFByb2ZpbGVyUGFuZWwiLCAiUHJvZmlsZXNQYW5lbC5qcyIpKTsKICAgICAgICAgICAgaWYgKCFXZWJJbnNwZWN0b3IuV29ya2VyTWFuYWdlci5pc1dvcmtlckZyb250ZW5kKCkgJiYgV2ViSW5zcGVjdG9yLmV4cGVyaW1lbnRzU2V0dGluZ3MuY2FudmFzSW5zcGVjdGlvbi5pc0VuYWJsZWQoKSkKICAgICAgICAgICAgICAgIGFsbFByb2ZpbGVycy5wdXNoKG5ldyBXZWJJbnNwZWN0b3IuUGFuZWxEZXNjcmlwdG9yKCJjYW52YXMtcHJvZmlsZXIiLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkNhbnZhcyBQcm9maWxlciIpLCAiQ2FudmFzUHJvZmlsZXJQYW5lbCIsICJQcm9maWxlc1BhbmVsLmpzIikpOwogICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmJpbmQoYWxsRGVzY3JpcHRvcnMsIGFsbERlc2NyaXB0b3JzLmluZGV4T2YocHJvZmlsZXMpLCAxKS5hcHBseShudWxsLCBhbGxQcm9maWxlcnMpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHBhbmVsRGVzY3JpcHRvcnMgPSBbXTsKICAgICAgICBpZiAoV2ViSW5zcGVjdG9yLldvcmtlck1hbmFnZXIuaXNXb3JrZXJGcm9udGVuZCgpKSB7CiAgICAgICAgICAgIHBhbmVsRGVzY3JpcHRvcnMucHVzaChzY3JpcHRzKTsKICAgICAgICAgICAgcGFuZWxEZXNjcmlwdG9ycy5wdXNoKHRpbWVsaW5lKTsKICAgICAgICAgICAgcGFuZWxEZXNjcmlwdG9ycyA9IHBhbmVsRGVzY3JpcHRvcnMuY29uY2F0KGFsbFByb2ZpbGVycyk7CiAgICAgICAgICAgIHBhbmVsRGVzY3JpcHRvcnMucHVzaChjb25zb2xlKTsKICAgICAgICAgICAgcmV0dXJuIHBhbmVsRGVzY3JpcHRvcnM7CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYWxsRGVzY3JpcHRvcnMubGVuZ3RoOyArK2kpCiAgICAgICAgICAgIHBhbmVsRGVzY3JpcHRvcnMucHVzaChhbGxEZXNjcmlwdG9yc1tpXSk7CiAgICAgICAgcmV0dXJuIHBhbmVsRGVzY3JpcHRvcnM7CiAgICB9LAoKICAgIF9wYW5lbFNlbGVjdGVkOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi5zZXRFbmFibGVkKFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpLm5hbWUgIT09ICJjb25zb2xlIik7CiAgICB9LAoKICAgIF9jcmVhdGVHbG9iYWxTdGF0dXNCYXJJdGVtczogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBib3R0b21TdGF0dXNCYXJDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYm90dG9tLXN0YXR1cy1iYXItY29udGFpbmVyIik7CgogICAgICAgIC8vIENyZWF0ZSBtYWluIGRvY2sgYnV0dG9uIGFuZCBvcHRpb25zLgogICAgICAgIHZhciBtYWluU3RhdHVzQmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1haW4tc3RhdHVzLWJhciIpOwogICAgICAgIG1haW5TdGF0dXNCYXIuaW5zZXJ0QmVmb3JlKHRoaXMuZG9ja0NvbnRyb2xsZXIuZWxlbWVudCwgYm90dG9tU3RhdHVzQmFyQ29udGFpbmVyKTsKCiAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbiA9IG5ldyBXZWJJbnNwZWN0b3IuU3RhdHVzQmFyQnV0dG9uKFdlYkluc3BlY3Rvci5VSVN0cmluZygiU2hvdyBjb25zb2xlLiIpLCAiY29uc29sZS1zdGF0dXMtYmFyLWl0ZW0iKTsKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbkNsaWNrZWQuYmluZCh0aGlzKSwgZmFsc2UpOwogICAgICAgIG1haW5TdGF0dXNCYXIuaW5zZXJ0QmVmb3JlKHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24uZWxlbWVudCwgYm90dG9tU3RhdHVzQmFyQ29udGFpbmVyKTsKCiAgICAgICAgaWYgKHRoaXMuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlcikKICAgICAgICAgICAgbWFpblN0YXR1c0Jhci5pbnNlcnRCZWZvcmUodGhpcy5pbnNwZWN0RWxlbWVudE1vZGVDb250cm9sbGVyLnRvZ2dsZVNlYXJjaEJ1dHRvbi5lbGVtZW50LCBib3R0b21TdGF0dXNCYXJDb250YWluZXIpOwoKICAgICAgICBtYWluU3RhdHVzQmFyLmFwcGVuZENoaWxkKHRoaXMuc2V0dGluZ3NDb250cm9sbGVyLnN0YXR1c0Jhckl0ZW0pOwogICAgfSwKCiAgICBfdG9nZ2xlQ29uc29sZUJ1dHRvbkNsaWNrZWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBpZiAoIXRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24uZW5hYmxlZCgpKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udG9nZ2xlZCA9ICF0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRvZ2dsZWQ7CgogICAgICAgIHZhciBhbmltYXRpb25UeXBlID0gd2luZG93LmV2ZW50ICYmIHdpbmRvdy5ldmVudC5zaGlmdEtleSA/IFdlYkluc3BlY3Rvci5EcmF3ZXIuQW5pbWF0aW9uVHlwZS5TbG93IDogV2ViSW5zcGVjdG9yLkRyYXdlci5BbmltYXRpb25UeXBlLk5vcm1hbDsKICAgICAgICBpZiAodGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbi50b2dnbGVkKSB7CiAgICAgICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkhpZGUgY29uc29sZS4iKTsKICAgICAgICAgICAgdGhpcy5kcmF3ZXIuc2hvdyh0aGlzLmNvbnNvbGVWaWV3LCBhbmltYXRpb25UeXBlKTsKICAgICAgICAgICAgdGhpcy5fY29uc29sZVdhc1Nob3duID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTaG93IGNvbnNvbGUuIik7CiAgICAgICAgICAgIHRoaXMuZHJhd2VyLmhpZGUoYW5pbWF0aW9uVHlwZSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9jb25zb2xlV2FzU2hvd247CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gc3RhdHVzQmFyRWxlbWVudAogICAgICogQHBhcmFtIHtXZWJJbnNwZWN0b3IuVmlld30gdmlldwogICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gb25jbG9zZQogICAgICovCiAgICBzaG93Vmlld0luRHJhd2VyOiBmdW5jdGlvbihzdGF0dXNCYXJFbGVtZW50LCB2aWV3LCBvbmNsb3NlKQogICAgewogICAgICAgIHRoaXMuX3RvZ2dsZUNvbnNvbGVCdXR0b24udGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkhpZGUgY29uc29sZS4iKTsKICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRvZ2dsZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLl9jbG9zZVByZXZpb3VzRHJhd2VyVmlldygpOwoKICAgICAgICB2YXIgZHJhd2VyU3RhdHVzQmFySGVhZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgZHJhd2VyU3RhdHVzQmFySGVhZGVyLmNsYXNzTmFtZSA9ICJkcmF3ZXItaGVhZGVyIHN0YXR1cy1iYXItaXRlbSI7CiAgICAgICAgZHJhd2VyU3RhdHVzQmFySGVhZGVyLmFwcGVuZENoaWxkKHN0YXR1c0JhckVsZW1lbnQpOwogICAgICAgIGRyYXdlclN0YXR1c0JhckhlYWRlci5vbmNsb3NlID0gb25jbG9zZTsKCiAgICAgICAgdmFyIGNsb3NlQnV0dG9uID0gZHJhd2VyU3RhdHVzQmFySGVhZGVyLmNyZWF0ZUNoaWxkKCJzcGFuIik7CiAgICAgICAgY2xvc2VCdXR0b24udGV4dENvbnRlbnQgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIlx1MDBENyIpOwogICAgICAgIGNsb3NlQnV0dG9uLmFkZFN0eWxlQ2xhc3MoImRyYXdlci1oZWFkZXItY2xvc2UtYnV0dG9uIik7CiAgICAgICAgY2xvc2VCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLmNsb3NlVmlld0luRHJhd2VyLmJpbmQodGhpcyksIGZhbHNlKTsKCiAgICAgICAgdmFyIHBhbmVsU3RhdHVzQmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBhbmVsLXN0YXR1cy1iYXIiKTsKICAgICAgICB2YXIgZHJhd2VyVmlld0FuY2hvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkcmF3ZXItdmlldy1hbmNob3IiKTsKICAgICAgICBwYW5lbFN0YXR1c0Jhci5pbnNlcnRCZWZvcmUoZHJhd2VyU3RhdHVzQmFySGVhZGVyLCBkcmF3ZXJWaWV3QW5jaG9yKTsKICAgICAgICB0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXIgPSBkcmF3ZXJTdGF0dXNCYXJIZWFkZXI7CiAgICAgICAgdGhpcy5kcmF3ZXIuc2hvdyh2aWV3LCBXZWJJbnNwZWN0b3IuRHJhd2VyLkFuaW1hdGlvblR5cGUuSW1tZWRpYXRlbHkpOwogICAgfSwKCiAgICBjbG9zZVZpZXdJbkRyYXdlcjogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICh0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXIpIHsKICAgICAgICAgICAgdGhpcy5fY2xvc2VQcmV2aW91c0RyYXdlclZpZXcoKTsKCiAgICAgICAgICAgIC8vIE9uY2UgZHJhd2VyIGlzIGNsb3NlZCBjb25zb2xlIHNob3VsZCBiZSBzaG93biBpZiBpdCB3YXMgc2hvd24gYmVmb3JlIGN1cnJlbnQgdmlldyByZXBsYWNlZCBpdCBpbiBkcmF3ZXIuIAogICAgICAgICAgICBpZiAoIXRoaXMuX2NvbnNvbGVXYXNTaG93bikKICAgICAgICAgICAgICAgIHRoaXMuZHJhd2VyLmhpZGUoV2ViSW5zcGVjdG9yLkRyYXdlci5BbmltYXRpb25UeXBlLkltbWVkaWF0ZWx5KTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhpcy5fdG9nZ2xlQ29uc29sZUJ1dHRvbkNsaWNrZWQoKTsKICAgICAgICB9CiAgICB9LAoKICAgIF9jbG9zZVByZXZpb3VzRHJhd2VyVmlldzogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICh0aGlzLl9kcmF3ZXJTdGF0dXNCYXJIZWFkZXIpIHsKICAgICAgICAgICAgdGhpcy5fZHJhd2VyU3RhdHVzQmFySGVhZGVyLnBhcmVudEVsZW1lbnQucmVtb3ZlQ2hpbGQodGhpcy5fZHJhd2VyU3RhdHVzQmFySGVhZGVyKTsKICAgICAgICAgICAgaWYgKHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlci5vbmNsb3NlKQogICAgICAgICAgICAgICAgdGhpcy5fZHJhd2VyU3RhdHVzQmFySGVhZGVyLm9uY2xvc2UoKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2RyYXdlclN0YXR1c0JhckhlYWRlcjsKICAgICAgICB9CiAgICB9LAoKICAgIF91cGRhdGVFcnJvckFuZFdhcm5pbmdDb3VudHM6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB2YXIgZXJyb3JXYXJuaW5nRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJlcnJvci13YXJuaW5nLWNvdW50Iik7CiAgICAgICAgaWYgKCFlcnJvcldhcm5pbmdFbGVtZW50KQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIHZhciBlcnJvcnMgPSBXZWJJbnNwZWN0b3IuY29uc29sZS5lcnJvcnM7CiAgICAgICAgdmFyIHdhcm5pbmdzID0gV2ViSW5zcGVjdG9yLmNvbnNvbGUud2FybmluZ3M7CiAgICAgICAgaWYgKCFlcnJvcnMgJiYgIXdhcm5pbmdzKSB7CiAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQuYWRkU3R5bGVDbGFzcygiaGlkZGVuIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQucmVtb3ZlU3R5bGVDbGFzcygiaGlkZGVuIik7CgogICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQucmVtb3ZlQ2hpbGRyZW4oKTsKCiAgICAgICAgaWYgKGVycm9ycykgewogICAgICAgICAgICB2YXIgZXJyb3JJbWFnZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICAgICAgICAgICAgZXJyb3JJbWFnZUVsZW1lbnQuaWQgPSAiZXJyb3ItY291bnQtaW1nIjsKICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC5hcHBlbmRDaGlsZChlcnJvckltYWdlRWxlbWVudCk7CiAgICAgICAgICAgIHZhciBlcnJvckVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICAgICAgICAgIGVycm9yRWxlbWVudC5pZCA9ICJlcnJvci1jb3VudCI7CiAgICAgICAgICAgIGVycm9yRWxlbWVudC50ZXh0Q29udGVudCA9IGVycm9yczsKICAgICAgICAgICAgZXJyb3JXYXJuaW5nRWxlbWVudC5hcHBlbmRDaGlsZChlcnJvckVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdhcm5pbmdzKSB7CiAgICAgICAgICAgIHZhciB3YXJuaW5nc0ltYWdlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgICAgICAgICB3YXJuaW5nc0ltYWdlRWxlbWVudC5pZCA9ICJ3YXJuaW5nLWNvdW50LWltZyI7CiAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQuYXBwZW5kQ2hpbGQod2FybmluZ3NJbWFnZUVsZW1lbnQpOwogICAgICAgICAgICB2YXIgd2FybmluZ3NFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICAgICAgICB3YXJuaW5nc0VsZW1lbnQuaWQgPSAid2FybmluZy1jb3VudCI7CiAgICAgICAgICAgIHdhcm5pbmdzRWxlbWVudC50ZXh0Q29udGVudCA9IHdhcm5pbmdzOwogICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LmFwcGVuZENoaWxkKHdhcm5pbmdzRWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoZXJyb3JzKSB7CiAgICAgICAgICAgIGlmICh3YXJuaW5ncykgewogICAgICAgICAgICAgICAgaWYgKGVycm9ycyA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdhcm5pbmdzID09IDEpCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIiVkIGVycm9yLCAlZCB3YXJuaW5nIiwgZXJyb3JzLCB3YXJuaW5ncyk7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCBlcnJvciwgJWQgd2FybmluZ3MiLCBlcnJvcnMsIHdhcm5pbmdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAod2FybmluZ3MgPT0gMSkKICAgICAgICAgICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCBlcnJvcnMsICVkIHdhcm5pbmciLCBlcnJvcnMsIHdhcm5pbmdzKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCBlcnJvcnMsICVkIHdhcm5pbmdzIiwgZXJyb3JzLCB3YXJuaW5ncyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3JzID09IDEpCiAgICAgICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCBlcnJvciIsIGVycm9ycyk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIiVkIGVycm9ycyIsIGVycm9ycyk7CiAgICAgICAgfSBlbHNlIGlmICh3YXJuaW5ncyA9PSAxKQogICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCB3YXJuaW5nIiwgd2FybmluZ3MpOwogICAgICAgIGVsc2UgaWYgKHdhcm5pbmdzKQogICAgICAgICAgICBlcnJvcldhcm5pbmdFbGVtZW50LnRpdGxlID0gV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCIlZCB3YXJuaW5ncyIsIHdhcm5pbmdzKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIGVycm9yV2FybmluZ0VsZW1lbnQudGl0bGUgPSBudWxsOwogICAgfSwKCiAgICBnZXQgaW5zcGVjdGVkUGFnZURvbWFpbigpCiAgICB7CiAgICAgICAgdmFyIHBhcnNlZFVSTCA9IFdlYkluc3BlY3Rvci5pbnNwZWN0ZWRQYWdlVVJMICYmIFdlYkluc3BlY3Rvci5pbnNwZWN0ZWRQYWdlVVJMLmFzUGFyc2VkVVJMKCk7CiAgICAgICAgcmV0dXJuIHBhcnNlZFVSTCA/IHBhcnNlZFVSTC5ob3N0IDogIiI7CiAgICB9LAoKICAgIF9pbml0aWFsaXplQ2FwYWJpbGl0eTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGVycm9yLCByZXN1bHQpCiAgICB7CiAgICAgICAgQ2FwYWJpbGl0aWVzW25hbWVdID0gcmVzdWx0OwogICAgICAgIGlmIChjYWxsYmFjaykKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgIH0sCgogICAgX3pvb21JbjogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX3pvb21MZXZlbCA9IE1hdGgubWluKHRoaXMuX3pvb21MZXZlbCArIDEsIFdlYkluc3BlY3Rvci5ab29tLlRhYmxlLmxlbmd0aCAtIFdlYkluc3BlY3Rvci5ab29tLkRlZmF1bHRPZmZzZXQgLSAxKTsKICAgICAgICB0aGlzLl9yZXF1ZXN0Wm9vbSgpOwogICAgfSwKCiAgICBfem9vbU91dDogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX3pvb21MZXZlbCA9IE1hdGgubWF4KHRoaXMuX3pvb21MZXZlbCAtIDEsIC1XZWJJbnNwZWN0b3IuWm9vbS5EZWZhdWx0T2Zmc2V0KTsKICAgICAgICB0aGlzLl9yZXF1ZXN0Wm9vbSgpOwogICAgfSwKCiAgICBfcmVzZXRab29tOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fem9vbUxldmVsID0gMDsKICAgICAgICB0aGlzLl9yZXF1ZXN0Wm9vbSgpOwogICAgfSwKCiAgICBfcmVxdWVzdFpvb206IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBXZWJJbnNwZWN0b3Iuc2V0dGluZ3Muem9vbUxldmVsLnNldCh0aGlzLl96b29tTGV2ZWwpOwogICAgICAgIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgem9vbUxldmVsIHRha2VzIGludGVnZXJzICh3aXRoIDAgYmVpbmcgZGVmYXVsdCB6b29tKS4KICAgICAgICB2YXIgaW5kZXggPSB0aGlzLl96b29tTGV2ZWwgKyBXZWJJbnNwZWN0b3IuWm9vbS5EZWZhdWx0T2Zmc2V0OwogICAgICAgIGluZGV4ID0gTWF0aC5taW4oV2ViSW5zcGVjdG9yLlpvb20uVGFibGUubGVuZ3RoIC0gMSwgaW5kZXgpOwogICAgICAgIGluZGV4ID0gTWF0aC5tYXgoMCwgaW5kZXgpOwogICAgICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5zZXRab29tRmFjdG9yKFdlYkluc3BlY3Rvci5ab29tLlRhYmxlW2luZGV4XSk7CiAgICB9LAoKICAgIF9kZWJ1Z2dlclBhdXNlZDogZnVuY3Rpb24oKQogICAgewogICAgICAgIC8vIENyZWF0ZSBzY3JpcHRzIHBhbmVsIHVwb24gZGVtYW5kLgogICAgICAgIFdlYkluc3BlY3Rvci5wYW5lbCgic2NyaXB0cyIpOwogICAgfQp9CgpXZWJJbnNwZWN0b3IuRXZlbnRzID0gewogICAgSW5zcGVjdG9yTG9hZGVkOiAiSW5zcGVjdG9yTG9hZGVkIiwKICAgIEluc3BlY3RvckNsb3Npbmc6ICJJbnNwZWN0b3JDbG9zaW5nIgp9Cgp7KGZ1bmN0aW9uIHBhcnNlUXVlcnlQYXJhbWV0ZXJzKCkKewogICAgV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0ID0ge307CiAgICB2YXIgcXVlcnlQYXJhbXMgPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoOwogICAgaWYgKCFxdWVyeVBhcmFtcykKICAgICAgICByZXR1cm47CiAgICB2YXIgcGFyYW1zID0gcXVlcnlQYXJhbXMuc3Vic3RyaW5nKDEpLnNwbGl0KCImIik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBwYWlyID0gcGFyYW1zW2ldLnNwbGl0KCI9Iik7CiAgICAgICAgV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0W3BhaXJbMF1dID0gcGFpclsxXTsKICAgIH0KfSkoKTt9CgpXZWJJbnNwZWN0b3Iuc3VnZ2VzdFJlbG9hZCA9IGZ1bmN0aW9uKCkKewogICAgaWYgKHdpbmRvdy5jb25maXJtKFdlYkluc3BlY3Rvci5VSVN0cmluZygiSXQgaXMgcmVjb21tZW5kZWQgdG8gcmVzdGFydCBpbnNwZWN0b3IgYWZ0ZXIgbWFraW5nIHRoZXNlIGNoYW5nZXMuIFdvdWxkIHlvdSBsaWtlIHRvIHJlc3RhcnQgaXQ/IikpKQogICAgICAgIHRoaXMucmVsb2FkKCk7Cn0KCldlYkluc3BlY3Rvci5yZWxvYWQgPSBmdW5jdGlvbigpCnsKICAgIHZhciBxdWVyeVBhcmFtcyA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2g7CiAgICB2YXIgdXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICB1cmwgPSB1cmwuc3Vic3RyaW5nKDAsIHVybC5sZW5ndGggLSBxdWVyeVBhcmFtcy5sZW5ndGgpOwogICAgdmFyIHF1ZXJ5UGFyYW1zT2JqZWN0ID0ge307CiAgICBmb3IgKHZhciBuYW1lIGluIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdCkKICAgICAgICBxdWVyeVBhcmFtc09iamVjdFtuYW1lXSA9IFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdFtuYW1lXTsKICAgIGlmICh0aGlzLmRvY2tDb250cm9sbGVyKQogICAgICAgIHF1ZXJ5UGFyYW1zT2JqZWN0WyJkb2NrU2lkZSJdID0gdGhpcy5kb2NrQ29udHJvbGxlci5kb2NrU2lkZSgpOwogICAgdmFyIG5hbWVzID0gT2JqZWN0LmtleXMocXVlcnlQYXJhbXNPYmplY3QpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuYW1lcy5sZW5ndGg7ICsraSkKICAgICAgICB1cmwgKz0gKGkgPyAiJiIgOiAiPyIpICsgbmFtZXNbaV0gKyAiPSIgKyBxdWVyeVBhcmFtc09iamVjdFtuYW1lc1tpXV07CgogICAgSW5zcGVjdG9yQmFja2VuZC5kaXNjb25uZWN0KCk7CiAgICBkb2N1bWVudC5sb2NhdGlvbiA9IHVybDsKfQoKV2ViSW5zcGVjdG9yLmxvYWRlZCA9IGZ1bmN0aW9uKCkKewogICAgSW5zcGVjdG9yQmFja2VuZC5sb2FkRnJvbUpTT05JZk5lZWRlZCgiLi4vSW5zcGVjdG9yLmpzb24iKTsKICAgIFdlYkluc3BlY3Rvci5kb2NrQ29udHJvbGxlciA9IG5ldyBXZWJJbnNwZWN0b3IuRG9ja0NvbnRyb2xsZXIoKTsKCiAgICBpZiAoV2ViSW5zcGVjdG9yLldvcmtlck1hbmFnZXIuaXNEZWRpY2F0ZWRXb3JrZXJGcm9udGVuZCgpKSB7CiAgICAgICAgLy8gRG8gbm90IGNyZWF0ZSBzb2NrZXQgZm9yIHRoZSB3b3JrZXIgZnJvbnQtZW5kLgogICAgICAgIFdlYkluc3BlY3Rvci5kb0xvYWRlZERvbmUoKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHdzOwogICAgaWYgKCJ3cyIgaW4gV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0KQogICAgICAgIHdzID0gIndzOi8vIiArIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdC53czsKICAgIGVsc2UgaWYgKCJwYWdlIiBpbiBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QpIHsKICAgICAgICB2YXIgcGFnZSA9IFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdC5wYWdlOwogICAgICAgIHZhciBob3N0ID0gImhvc3QiIGluIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdCA/IFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdC5ob3N0IDogd2luZG93LmxvY2F0aW9uLmhvc3Q7CiAgICAgICAgd3MgPSAid3M6Ly8iICsgaG9zdCArICIvZGV2dG9vbHMvcGFnZS8iICsgcGFnZTsKICAgIH0KCiAgICBpZiAod3MpIHsKICAgICAgICBXZWJJbnNwZWN0b3Iuc29ja2V0ID0gbmV3IFdlYlNvY2tldCh3cyk7CiAgICAgICAgV2ViSW5zcGVjdG9yLnNvY2tldC5vbm1lc3NhZ2UgPSBmdW5jdGlvbihtZXNzYWdlKSB7IEluc3BlY3RvckJhY2tlbmQuZGlzcGF0Y2gobWVzc2FnZS5kYXRhKTsgfQogICAgICAgIFdlYkluc3BlY3Rvci5zb2NrZXQub25lcnJvciA9IGZ1bmN0aW9uKGVycm9yKSB7IGNvbnNvbGUuZXJyb3IoZXJyb3IpOyB9CiAgICAgICAgV2ViSW5zcGVjdG9yLnNvY2tldC5vbm9wZW4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgSW5zcGVjdG9yRnJvbnRlbmRIb3N0LnNlbmRNZXNzYWdlVG9CYWNrZW5kID0gV2ViSW5zcGVjdG9yLnNvY2tldC5zZW5kLmJpbmQoV2ViSW5zcGVjdG9yLnNvY2tldCk7CiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5kb0xvYWRlZERvbmUoKTsKICAgICAgICB9CiAgICAgICAgV2ViSW5zcGVjdG9yLnNvY2tldC5vbmNsb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghV2ViSW5zcGVjdG9yLnNvY2tldC5fZGV0YWNoUmVhc29uKQogICAgICAgICAgICAgICAgKG5ldyBXZWJJbnNwZWN0b3IuUmVtb3RlRGVidWdnaW5nVGVybWluYXRlZFNjcmVlbigid2Vic29ja2V0X2Nsb3NlZCIpKS5zaG93TW9kYWwoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIFdlYkluc3BlY3Rvci5kb0xvYWRlZERvbmUoKTsKCiAgICAvLyBJbiBjYXNlIG9mIGxvYWRpbmcgYXMgYSB3ZWIgcGFnZSB3aXRoIG5vIGJpbmRpbmdzIC8gaGFybmVzcywga2ljayBvZmYgaW5pdGlhbGl6YXRpb24gbWFudWFsbHkuCiAgICBpZiAoSW5zcGVjdG9yRnJvbnRlbmRIb3N0LmlzU3R1YikgewogICAgICAgIEluc3BlY3RvckZyb250ZW5kQVBJLmRpc3BhdGNoUXVlcnlQYXJhbWV0ZXJzKCk7CiAgICAgICAgV2ViSW5zcGVjdG9yLl9kb0xvYWRlZERvbmVXaXRoQ2FwYWJpbGl0aWVzKCk7CiAgICB9Cn0KCldlYkluc3BlY3Rvci5kb0xvYWRlZERvbmUgPSBmdW5jdGlvbigpCnsKICAgIC8vIEluc3RhbGwgc3R5bGVzIGFuZCB0aGVtZXMKICAgIFdlYkluc3BlY3Rvci5pbnN0YWxsUG9ydFN0eWxlcygpOwogICAgaWYgKFdlYkluc3BlY3Rvci5zb2NrZXQpCiAgICAgICAgZG9jdW1lbnQuYm9keS5hZGRTdHlsZUNsYXNzKCJyZW1vdGUiKTsKCiAgICBpZiAoV2ViSW5zcGVjdG9yLnF1ZXJ5UGFyYW1zT2JqZWN0LnRvb2xiYXJDb2xvciAmJiBXZWJJbnNwZWN0b3IucXVlcnlQYXJhbXNPYmplY3QudGV4dENvbG9yKQogICAgICAgIFdlYkluc3BlY3Rvci5zZXRUb29sYmFyQ29sb3JzKFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdC50b29sYmFyQ29sb3IsIFdlYkluc3BlY3Rvci5xdWVyeVBhcmFtc09iamVjdC50ZXh0Q29sb3IpOwoKICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5sb2FkZWQoKTsKICAgIFdlYkluc3BlY3Rvci5Xb3JrZXJNYW5hZ2VyLmxvYWRlZCgpOwoKICAgIERlYnVnZ2VyQWdlbnQuY2F1c2VzUmVjb21waWxhdGlvbihXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAiZGVidWdnZXJDYXVzZXNSZWNvbXBpbGF0aW9uIiwgbnVsbCkpOwogICAgRGVidWdnZXJBZ2VudC5zdXBwb3J0c1NlcGFyYXRlU2NyaXB0Q29tcGlsYXRpb25BbmRFeGVjdXRpb24oV2ViSW5zcGVjdG9yLl9pbml0aWFsaXplQ2FwYWJpbGl0eS5iaW5kKFdlYkluc3BlY3RvciwgInNlcGFyYXRlU2NyaXB0Q29tcGlsYXRpb25BbmRFeGVjdXRpb25FbmFibGVkIiwgbnVsbCkpOwogICAgUHJvZmlsZXJBZ2VudC5jYXVzZXNSZWNvbXBpbGF0aW9uKFdlYkluc3BlY3Rvci5faW5pdGlhbGl6ZUNhcGFiaWxpdHkuYmluZChXZWJJbnNwZWN0b3IsICJwcm9maWxlckNhdXNlc1JlY29tcGlsYXRpb24iLCBudWxsKSk7CiAgICBQcm9maWxlckFnZW50LmlzU2FtcGxpbmcoV2ViSW5zcGVjdG9yLl9pbml0aWFsaXplQ2FwYWJpbGl0eS5iaW5kKFdlYkluc3BlY3RvciwgInNhbXBsaW5nQ1BVUHJvZmlsZXIiLCBudWxsKSk7CiAgICBIZWFwUHJvZmlsZXJBZ2VudC5oYXNIZWFwUHJvZmlsZXIoV2ViSW5zcGVjdG9yLl9pbml0aWFsaXplQ2FwYWJpbGl0eS5iaW5kKFdlYkluc3BlY3RvciwgImhlYXBQcm9maWxlclByZXNlbnQiLCBudWxsKSk7CiAgICBUaW1lbGluZUFnZW50LnN1cHBvcnRzRnJhbWVJbnN0cnVtZW50YXRpb24oV2ViSW5zcGVjdG9yLl9pbml0aWFsaXplQ2FwYWJpbGl0eS5iaW5kKFdlYkluc3BlY3RvciwgInRpbWVsaW5lU3VwcG9ydHNGcmFtZUluc3RydW1lbnRhdGlvbiIsIG51bGwpKTsKICAgIFRpbWVsaW5lQWdlbnQuY2FuTW9uaXRvck1haW5UaHJlYWQoV2ViSW5zcGVjdG9yLl9pbml0aWFsaXplQ2FwYWJpbGl0eS5iaW5kKFdlYkluc3BlY3RvciwgInRpbWVsaW5lQ2FuTW9uaXRvck1haW5UaHJlYWQiLCBudWxsKSk7CiAgICBQYWdlQWdlbnQuY2FuU2hvd0RlYnVnQm9yZGVycyhXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAiY2FuU2hvd0RlYnVnQm9yZGVycyIsIG51bGwpKTsKICAgIFBhZ2VBZ2VudC5jYW5TaG93RlBTQ291bnRlcihXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAiY2FuU2hvd0ZQU0NvdW50ZXIiLCBudWxsKSk7CiAgICBQYWdlQWdlbnQuY2FuQ29udGludW91c2x5UGFpbnQoV2ViSW5zcGVjdG9yLl9pbml0aWFsaXplQ2FwYWJpbGl0eS5iaW5kKFdlYkluc3BlY3RvciwgImNhbkNvbnRpbnVvdXNseVBhaW50IiwgbnVsbCkpOwogICAgUGFnZUFnZW50LmNhbk92ZXJyaWRlRGV2aWNlTWV0cmljcyhXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAiY2FuT3ZlcnJpZGVEZXZpY2VNZXRyaWNzIiwgbnVsbCkpOwogICAgUGFnZUFnZW50LmNhbk92ZXJyaWRlR2VvbG9jYXRpb24oV2ViSW5zcGVjdG9yLl9pbml0aWFsaXplQ2FwYWJpbGl0eS5iaW5kKFdlYkluc3BlY3RvciwgImNhbk92ZXJyaWRlR2VvbG9jYXRpb24iLCBudWxsKSk7CiAgICBXb3JrZXJBZ2VudC5jYW5JbnNwZWN0V29ya2VycyhXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAiY2FuSW5zcGVjdFdvcmtlcnMiLCBudWxsKSk7CiAgICBQYWdlQWdlbnQuY2FuT3ZlcnJpZGVEZXZpY2VPcmllbnRhdGlvbihXZWJJbnNwZWN0b3IuX2luaXRpYWxpemVDYXBhYmlsaXR5LmJpbmQoV2ViSW5zcGVjdG9yLCAiY2FuT3ZlcnJpZGVEZXZpY2VPcmllbnRhdGlvbiIsIFdlYkluc3BlY3Rvci5fZG9Mb2FkZWREb25lV2l0aENhcGFiaWxpdGllcy5iaW5kKFdlYkluc3BlY3RvcikpKTsKfQoKV2ViSW5zcGVjdG9yLl9kb0xvYWRlZERvbmVXaXRoQ2FwYWJpbGl0aWVzID0gZnVuY3Rpb24oKQp7CiAgICBuZXcgV2ViSW5zcGVjdG9yLlZlcnNpb25Db250cm9sbGVyKCkudXBkYXRlVmVyc2lvbigpOwoKICAgIFdlYkluc3BlY3Rvci5zaG9ydGN1dHNTY3JlZW4gPSBuZXcgV2ViSW5zcGVjdG9yLlNob3J0Y3V0c1NjcmVlbigpOwogICAgdGhpcy5fcmVnaXN0ZXJTaG9ydGN1dHMoKTsKCiAgICAvLyBzZXQgb3JkZXIgb2Ygc29tZSBzZWN0aW9ucyBleHBsaWNpdGx5CiAgICBXZWJJbnNwZWN0b3Iuc2hvcnRjdXRzU2NyZWVuLnNlY3Rpb24oV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJDb25zb2xlIikpOwogICAgV2ViSW5zcGVjdG9yLnNob3J0Y3V0c1NjcmVlbi5zZWN0aW9uKFdlYkluc3BlY3Rvci5VSVN0cmluZygiRWxlbWVudHMgUGFuZWwiKSk7CgogICAgdmFyIHBhbmVsRGVzY3JpcHRvcnMgPSB0aGlzLl9wYW5lbERlc2NyaXB0b3JzKCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhbmVsRGVzY3JpcHRvcnMubGVuZ3RoOyArK2kpCiAgICAgICAgcGFuZWxEZXNjcmlwdG9yc1tpXS5yZWdpc3RlclNob3J0Y3V0cygpOwoKICAgIHRoaXMuY29uc29sZSA9IG5ldyBXZWJJbnNwZWN0b3IuQ29uc29sZU1vZGVsKCk7CiAgICB0aGlzLmNvbnNvbGUuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuQ29uc29sZU1vZGVsLkV2ZW50cy5Db25zb2xlQ2xlYXJlZCwgdGhpcy5fdXBkYXRlRXJyb3JBbmRXYXJuaW5nQ291bnRzLCB0aGlzKTsKICAgIHRoaXMuY29uc29sZS5hZGRFdmVudExpc3RlbmVyKFdlYkluc3BlY3Rvci5Db25zb2xlTW9kZWwuRXZlbnRzLk1lc3NhZ2VBZGRlZCwgdGhpcy5fdXBkYXRlRXJyb3JBbmRXYXJuaW5nQ291bnRzLCB0aGlzKTsKICAgIHRoaXMuY29uc29sZS5hZGRFdmVudExpc3RlbmVyKFdlYkluc3BlY3Rvci5Db25zb2xlTW9kZWwuRXZlbnRzLlJlcGVhdENvdW50VXBkYXRlZCwgdGhpcy5fdXBkYXRlRXJyb3JBbmRXYXJuaW5nQ291bnRzLCB0aGlzKTsKCiAgICBXZWJJbnNwZWN0b3IuQ1NTTWV0YWRhdGEucmVxdWVzdENTU1Nob3J0aGFuZERhdGEoKTsKCiAgICB0aGlzLmRyYXdlciA9IG5ldyBXZWJJbnNwZWN0b3IuRHJhd2VyKCk7CgogICAgdGhpcy5uZXR3b3JrTWFuYWdlciA9IG5ldyBXZWJJbnNwZWN0b3IuTmV0d29ya01hbmFnZXIoKTsKICAgIHRoaXMucmVzb3VyY2VUcmVlTW9kZWwgPSBuZXcgV2ViSW5zcGVjdG9yLlJlc291cmNlVHJlZU1vZGVsKHRoaXMubmV0d29ya01hbmFnZXIpOwogICAgdGhpcy5kZWJ1Z2dlck1vZGVsID0gbmV3IFdlYkluc3BlY3Rvci5EZWJ1Z2dlck1vZGVsKCk7CiAgICB0aGlzLmRlYnVnZ2VyTW9kZWwuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuRGVidWdnZXJNb2RlbC5FdmVudHMuRGVidWdnZXJQYXVzZWQsIHRoaXMuX2RlYnVnZ2VyUGF1c2VkLCB0aGlzKTsKICAgIHRoaXMubmV0d29ya0xvZyA9IG5ldyBXZWJJbnNwZWN0b3IuTmV0d29ya0xvZygpOwogICAgdGhpcy5kb21BZ2VudCA9IG5ldyBXZWJJbnNwZWN0b3IuRE9NQWdlbnQoKTsKICAgIHRoaXMucnVudGltZU1vZGVsID0gbmV3IFdlYkluc3BlY3Rvci5SdW50aW1lTW9kZWwodGhpcy5yZXNvdXJjZVRyZWVNb2RlbCk7CgogICAgdGhpcy5jb25zb2xlVmlldyA9IG5ldyBXZWJJbnNwZWN0b3IuQ29uc29sZVZpZXcoV2ViSW5zcGVjdG9yLldvcmtlck1hbmFnZXIuaXNXb3JrZXJGcm9udGVuZCgpKTsKCiAgICBJbnNwZWN0b3JCYWNrZW5kLnJlZ2lzdGVySW5zcGVjdG9yRGlzcGF0Y2hlcih0aGlzKTsKCiAgICB0aGlzLmlzb2xhdGVkRmlsZVN5c3RlbU1hbmFnZXIgPSBuZXcgV2ViSW5zcGVjdG9yLklzb2xhdGVkRmlsZVN5c3RlbU1hbmFnZXIoKTsKICAgIHRoaXMuaXNvbGF0ZWRGaWxlU3lzdGVtRGlzcGF0Y2hlciA9IG5ldyBXZWJJbnNwZWN0b3IuSXNvbGF0ZWRGaWxlU3lzdGVtRGlzcGF0Y2hlcih0aGlzLmlzb2xhdGVkRmlsZVN5c3RlbU1hbmFnZXIpOwogICAgdGhpcy5maWxlTWFwcGluZyA9IG5ldyBXZWJJbnNwZWN0b3IuRmlsZU1hcHBpbmcoKTsKICAgIHRoaXMud29ya3NwYWNlID0gbmV3IFdlYkluc3BlY3Rvci5Xb3Jrc3BhY2UodGhpcy5maWxlTWFwcGluZywgdGhpcy5pc29sYXRlZEZpbGVTeXN0ZW1NYW5hZ2VyLm1hcHBpbmcoKSk7CgogICAgdGhpcy5jc3NNb2RlbCA9IG5ldyBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbCh0aGlzLndvcmtzcGFjZSk7CiAgICB0aGlzLnRpbWVsaW5lTWFuYWdlciA9IG5ldyBXZWJJbnNwZWN0b3IuVGltZWxpbmVNYW5hZ2VyKCk7CiAgICB0aGlzLnVzZXJBZ2VudFN1cHBvcnQgPSBuZXcgV2ViSW5zcGVjdG9yLlVzZXJBZ2VudFN1cHBvcnQoKTsKCiAgICB0aGlzLnNlYXJjaENvbnRyb2xsZXIgPSBuZXcgV2ViSW5zcGVjdG9yLlNlYXJjaENvbnRyb2xsZXIoKTsKICAgIHRoaXMuYWR2YW5jZWRTZWFyY2hDb250cm9sbGVyID0gbmV3IFdlYkluc3BlY3Rvci5BZHZhbmNlZFNlYXJjaENvbnRyb2xsZXIoKTsKICAgIGlmICghV2ViSW5zcGVjdG9yLldvcmtlck1hbmFnZXIuaXNXb3JrZXJGcm9udGVuZCgpKQogICAgICAgIHRoaXMuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlciA9IG5ldyBXZWJJbnNwZWN0b3IuSW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlcigpOwoKICAgIHRoaXMuc2V0dGluZ3NDb250cm9sbGVyID0gbmV3IFdlYkluc3BlY3Rvci5TZXR0aW5nc0NvbnRyb2xsZXIoKTsKCiAgICB0aGlzLmRvbUJyZWFrcG9pbnRzU2lkZWJhclBhbmUgPSBuZXcgV2ViSW5zcGVjdG9yLkRPTUJyZWFrcG9pbnRzU2lkZWJhclBhbmUoKTsKCiAgICB0aGlzLl96b29tTGV2ZWwgPSBXZWJJbnNwZWN0b3Iuc2V0dGluZ3Muem9vbUxldmVsLmdldCgpOwogICAgaWYgKHRoaXMuX3pvb21MZXZlbCkKICAgICAgICB0aGlzLl9yZXF1ZXN0Wm9vbSgpOwoKICAgIHZhciBhdXRvc2VsZWN0UGFuZWwgPSBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoImEgcGFuZWwgY2hvc2VuIGF1dG9tYXRpY2FsbHkiKTsKICAgIHZhciBvcGVuQW5jaG9yTG9jYXRpb25TZXR0aW5nID0gV2ViSW5zcGVjdG9yLnNldHRpbmdzLmNyZWF0ZVNldHRpbmcoIm9wZW5MaW5rSGFuZGxlciIsIGF1dG9zZWxlY3RQYW5lbCk7CiAgICB0aGlzLm9wZW5BbmNob3JMb2NhdGlvblJlZ2lzdHJ5ID0gbmV3IFdlYkluc3BlY3Rvci5IYW5kbGVyUmVnaXN0cnkob3BlbkFuY2hvckxvY2F0aW9uU2V0dGluZyk7CiAgICB0aGlzLm9wZW5BbmNob3JMb2NhdGlvblJlZ2lzdHJ5LnJlZ2lzdGVySGFuZGxlcihhdXRvc2VsZWN0UGFuZWwsIGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0pOwoKICAgIHRoaXMud29ya3NwYWNlQ29udHJvbGxlciA9IG5ldyBXZWJJbnNwZWN0b3IuV29ya3NwYWNlQ29udHJvbGxlcih0aGlzLndvcmtzcGFjZSk7CgogICAgdGhpcy5maWxlU3lzdGVtV29ya3NwYWNlUHJvdmlkZXIgPSBuZXcgV2ViSW5zcGVjdG9yLkZpbGVTeXN0ZW1Xb3Jrc3BhY2VQcm92aWRlcih0aGlzLmlzb2xhdGVkRmlsZVN5c3RlbU1hbmFnZXIsIHRoaXMud29ya3NwYWNlKTsKCiAgICB0aGlzLm5ldHdvcmtXb3Jrc3BhY2VQcm92aWRlciA9IG5ldyBXZWJJbnNwZWN0b3IuU2ltcGxlV29ya3NwYWNlUHJvdmlkZXIodGhpcy53b3Jrc3BhY2UsIFdlYkluc3BlY3Rvci5wcm9qZWN0VHlwZXMuTmV0d29yayk7CiAgICBuZXcgV2ViSW5zcGVjdG9yLk5ldHdvcmtVSVNvdXJjZUNvZGVQcm92aWRlcih0aGlzLm5ldHdvcmtXb3Jrc3BhY2VQcm92aWRlciwgdGhpcy53b3Jrc3BhY2UpOwoKICAgIHRoaXMuYnJlYWtwb2ludE1hbmFnZXIgPSBuZXcgV2ViSW5zcGVjdG9yLkJyZWFrcG9pbnRNYW5hZ2VyKFdlYkluc3BlY3Rvci5zZXR0aW5ncy5icmVha3BvaW50cywgdGhpcy5kZWJ1Z2dlck1vZGVsLCB0aGlzLndvcmtzcGFjZSk7CgogICAgdGhpcy5zY3JpcHRTbmlwcGV0TW9kZWwgPSBuZXcgV2ViSW5zcGVjdG9yLlNjcmlwdFNuaXBwZXRNb2RlbCh0aGlzLndvcmtzcGFjZSk7CgogICAgbmV3IFdlYkluc3BlY3Rvci5EZWJ1Z2dlclNjcmlwdE1hcHBpbmcodGhpcy53b3Jrc3BhY2UsIHRoaXMubmV0d29ya1dvcmtzcGFjZVByb3ZpZGVyKTsKICAgIHRoaXMubGl2ZUVkaXRTdXBwb3J0ID0gbmV3IFdlYkluc3BlY3Rvci5MaXZlRWRpdFN1cHBvcnQodGhpcy53b3Jrc3BhY2UpOwogICAgdGhpcy5zdHlsZUNvbnRlbnRCaW5kaW5nID0gbmV3IFdlYkluc3BlY3Rvci5TdHlsZUNvbnRlbnRCaW5kaW5nKHRoaXMuY3NzTW9kZWwsIHRoaXMud29ya3NwYWNlKTsKICAgIG5ldyBXZWJJbnNwZWN0b3IuU3R5bGVzU291cmNlTWFwcGluZyh0aGlzLmNzc01vZGVsLCB0aGlzLndvcmtzcGFjZSk7CiAgICBpZiAoV2ViSW5zcGVjdG9yLmV4cGVyaW1lbnRzU2V0dGluZ3Muc2Fzcy5pc0VuYWJsZWQoKSkKICAgICAgICBuZXcgV2ViSW5zcGVjdG9yLlNBU1NTb3VyY2VNYXBwaW5nKHRoaXMuY3NzTW9kZWwsIHRoaXMud29ya3NwYWNlLCB0aGlzLm5ldHdvcmtXb3Jrc3BhY2VQcm92aWRlcik7CgogICAgbmV3IFdlYkluc3BlY3Rvci5QcmVzZW50YXRpb25Db25zb2xlTWVzc2FnZUhlbHBlcih0aGlzLndvcmtzcGFjZSk7CgogICAgdGhpcy5fY3JlYXRlR2xvYmFsU3RhdHVzQmFySXRlbXMoKTsKCiAgICB0aGlzLnRvb2xiYXIgPSBuZXcgV2ViSW5zcGVjdG9yLlRvb2xiYXIoKTsKICAgIFdlYkluc3BlY3Rvci5zdGFydEJhdGNoVXBkYXRlKCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhbmVsRGVzY3JpcHRvcnMubGVuZ3RoOyArK2kpCiAgICAgICAgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuYWRkUGFuZWwocGFuZWxEZXNjcmlwdG9yc1tpXSk7CiAgICBXZWJJbnNwZWN0b3IuZW5kQmF0Y2hVcGRhdGUoKTsKCiAgICB0aGlzLmFkZE1haW5FdmVudExpc3RlbmVycyhkb2N1bWVudCk7CgogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInJlc2l6ZSIsIHRoaXMud2luZG93UmVzaXplLmJpbmQodGhpcyksIHRydWUpOwoKICAgIHZhciBlcnJvcldhcm5pbmdDb3VudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJlcnJvci13YXJuaW5nLWNvdW50Iik7CiAgICBlcnJvcldhcm5pbmdDb3VudC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuc2hvd0NvbnNvbGUuYmluZCh0aGlzKSwgZmFsc2UpOwogICAgdGhpcy5fdXBkYXRlRXJyb3JBbmRXYXJuaW5nQ291bnRzKCk7CgogICAgdGhpcy5leHRlbnNpb25TZXJ2ZXIuaW5pdEV4dGVuc2lvbnMoKTsKCiAgICB0aGlzLmNvbnNvbGUuZW5hYmxlQWdlbnQoKTsKCiAgICBmdW5jdGlvbiBzaG93SW5pdGlhbFBhbmVsKCkKICAgIHsKICAgICAgICBpZiAoIVdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpKQogICAgICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKFdlYkluc3BlY3Rvci5zZXR0aW5ncy5sYXN0QWN0aXZlUGFuZWwuZ2V0KCkpOwogICAgfQoKICAgIEluc3BlY3RvckFnZW50LmVuYWJsZShzaG93SW5pdGlhbFBhbmVsKTsKICAgIHRoaXMuZGF0YWJhc2VNb2RlbCA9IG5ldyBXZWJJbnNwZWN0b3IuRGF0YWJhc2VNb2RlbCgpOwogICAgdGhpcy5kb21TdG9yYWdlTW9kZWwgPSBuZXcgV2ViSW5zcGVjdG9yLkRPTVN0b3JhZ2VNb2RlbCgpOwoKICAgIGlmICghQ2FwYWJpbGl0aWVzLnByb2ZpbGVyQ2F1c2VzUmVjb21waWxhdGlvbiB8fCBXZWJJbnNwZWN0b3Iuc2V0dGluZ3MucHJvZmlsZXJFbmFibGVkLmdldCgpKQogICAgICAgIFByb2ZpbGVyQWdlbnQuZW5hYmxlKCk7CgogICAgaWYgKFdlYkluc3BlY3Rvci5zZXR0aW5ncy5zaG93UGFpbnRSZWN0cy5nZXQoKSkKICAgICAgICBQYWdlQWdlbnQuc2V0U2hvd1BhaW50UmVjdHModHJ1ZSk7CgogICAgaWYgKFdlYkluc3BlY3Rvci5zZXR0aW5ncy5zaG93RGVidWdCb3JkZXJzLmdldCgpKQogICAgICAgIFBhZ2VBZ2VudC5zZXRTaG93RGVidWdCb3JkZXJzKHRydWUpOwoKICAgIGlmIChXZWJJbnNwZWN0b3Iuc2V0dGluZ3MuY29udGludW91c1BhaW50aW5nLmdldCgpKQogICAgICAgIFBhZ2VBZ2VudC5zZXRDb250aW51b3VzUGFpbnRpbmdFbmFibGVkKHRydWUpOwoKICAgIGlmIChXZWJJbnNwZWN0b3Iuc2V0dGluZ3MuamF2YVNjcmlwdERpc2FibGVkLmdldCgpKQogICAgICAgIFBhZ2VBZ2VudC5zZXRTY3JpcHRFeGVjdXRpb25EaXNhYmxlZCh0cnVlKTsKCiAgICBpZiAoV2ViSW5zcGVjdG9yLnNldHRpbmdzLnNob3dGUFNDb3VudGVyLmdldCgpKQogICAgICAgIFBhZ2VBZ2VudC5zZXRTaG93RlBTQ291bnRlcih0cnVlKTsKCiAgICB0aGlzLmRvbUFnZW50Ll9lbXVsYXRlVG91Y2hFdmVudHNDaGFuZ2VkKCk7CgogICAgV2ViSW5zcGVjdG9yLldvcmtlck1hbmFnZXIubG9hZENvbXBsZXRlZCgpOwogICAgSW5zcGVjdG9yRnJvbnRlbmRBUEkubG9hZENvbXBsZXRlZCgpOwoKICAgIFdlYkluc3BlY3Rvci5ub3RpZmljYXRpb25zLmRpc3BhdGNoRXZlbnRUb0xpc3RlbmVycyhXZWJJbnNwZWN0b3IuRXZlbnRzLkluc3BlY3RvckxvYWRlZCk7Cn0KCnZhciB3aW5kb3dMb2FkZWQgPSBmdW5jdGlvbigpCnsKICAgIHZhciBsb2NhbGl6ZWRTdHJpbmdzVVJMID0gSW5zcGVjdG9yRnJvbnRlbmRIb3N0LmxvY2FsaXplZFN0cmluZ3NVUkwoKTsKICAgIGlmIChsb2NhbGl6ZWRTdHJpbmdzVVJMKSB7CiAgICAgICAgdmFyIGxvY2FsaXplZFN0cmluZ3NTY3JpcHRFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgbG9jYWxpemVkU3RyaW5nc1NjcmlwdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIFdlYkluc3BlY3Rvci5sb2FkZWQuYmluZChXZWJJbnNwZWN0b3IpLCBmYWxzZSk7CiAgICAgICAgbG9jYWxpemVkU3RyaW5nc1NjcmlwdEVsZW1lbnQudHlwZSA9ICJ0ZXh0L2phdmFzY3JpcHQiOwogICAgICAgIGxvY2FsaXplZFN0cmluZ3NTY3JpcHRFbGVtZW50LnNyYyA9IGxvY2FsaXplZFN0cmluZ3NVUkw7CiAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsb2NhbGl6ZWRTdHJpbmdzU2NyaXB0RWxlbWVudCk7CiAgICB9IGVsc2UKICAgICAgICBXZWJJbnNwZWN0b3IubG9hZGVkKCk7CgogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCB3aW5kb3dMb2FkZWQsIGZhbHNlKTsKICAgIGRlbGV0ZSB3aW5kb3dMb2FkZWQ7Cn07Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIHdpbmRvd0xvYWRlZCwgZmFsc2UpOwoKLy8gV2UnZCBsaWtlIHRvIGVuZm9yY2UgYXN5bmNocm9ub3VzIGludGVyYWN0aW9uIGJldHdlZW4gdGhlIGluc3BlY3RvciBjb250cm9sbGVyIGFuZCB0aGUgZnJvbnRlbmQuCi8vIEl0IGlzIG5lZWRlZCB0byBwcmV2ZW50IHJlLWVudGVyaW5nIHRoZSBiYWNrZW5kIGNvZGUuCi8vIEFsc28sIG5hdGl2ZSBkaXNwYXRjaGVzIGRvIG5vdCBndWFyYW50ZWUgc2V0VGltZW91dHMgdG8gYmUgc2VyaWFsaXplZCwgc28gd2UKLy8gZW5mb3JjZSBzZXJpYWxpemF0aW9uIHVzaW5nICdtZXNzYWdlc1RvRGlzcGF0Y2gnIHF1ZXVlLiBJdCBpcyBhbHNvIGltcG9ydGFudCB0aGF0IEpTQyBkZWJ1Z2dlcgovLyB0ZXN0cyByZXF1aXJlIHRoYXQgZWFjaCBjb21tYW5kIHdhcyBkaXNwYXRjaCB3aXRoaW4gaW5kaXZpZHVhbCB0aW1lb3V0IGNhbGxiYWNrLCBzbyB3ZSBkb24ndCBiYXRjaCB0aGVtLgoKdmFyIG1lc3NhZ2VzVG9EaXNwYXRjaCA9IFtdOwoKV2ViSW5zcGVjdG9yLmRpc3BhdGNoUXVldWVJc0VtcHR5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbWVzc2FnZXNUb0Rpc3BhdGNoLmxlbmd0aCA9PSAwOwp9CgpXZWJJbnNwZWN0b3IuZGlzcGF0Y2ggPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICBtZXNzYWdlc1RvRGlzcGF0Y2gucHVzaChtZXNzYWdlKTsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgSW5zcGVjdG9yQmFja2VuZC5kaXNwYXRjaChtZXNzYWdlc1RvRGlzcGF0Y2guc2hpZnQoKSk7CiAgICB9LCAwKTsKfQoKV2ViSW5zcGVjdG9yLndpbmRvd1Jlc2l6ZSA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBpZiAoV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcpCiAgICAgICAgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuZG9SZXNpemUoKTsKICAgIGlmIChXZWJJbnNwZWN0b3IuZHJhd2VyKQogICAgICAgIFdlYkluc3BlY3Rvci5kcmF3ZXIucmVzaXplKCk7CiAgICBpZiAoV2ViSW5zcGVjdG9yLnRvb2xiYXIpCiAgICAgICAgV2ViSW5zcGVjdG9yLnRvb2xiYXIucmVzaXplKCk7CiAgICBpZiAoV2ViSW5zcGVjdG9yLnNldHRpbmdzQ29udHJvbGxlcikKICAgICAgICBXZWJJbnNwZWN0b3Iuc2V0dGluZ3NDb250cm9sbGVyLnJlc2l6ZSgpOwp9CgpXZWJJbnNwZWN0b3Iuc2V0RG9ja2luZ1VuYXZhaWxhYmxlID0gZnVuY3Rpb24odW5hdmFpbGFibGUpCnsKICAgIGlmICh0aGlzLmRvY2tDb250cm9sbGVyKQogICAgICAgIHRoaXMuZG9ja0NvbnRyb2xsZXIuc2V0RG9ja2luZ1VuYXZhaWxhYmxlKHVuYXZhaWxhYmxlKTsKfQoKV2ViSW5zcGVjdG9yLmNsb3NlID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIGlmICh0aGlzLl9pc0Nsb3NpbmcpCiAgICAgICAgcmV0dXJuOwogICAgdGhpcy5faXNDbG9zaW5nID0gdHJ1ZTsKICAgIHRoaXMubm90aWZpY2F0aW9ucy5kaXNwYXRjaEV2ZW50VG9MaXN0ZW5lcnMoV2ViSW5zcGVjdG9yLkV2ZW50cy5JbnNwZWN0b3JDbG9zaW5nKTsKICAgIEluc3BlY3RvckZyb250ZW5kSG9zdC5jbG9zZVdpbmRvdygpOwp9CgpXZWJJbnNwZWN0b3IuZG9jdW1lbnRDbGljayA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICB2YXIgYW5jaG9yID0gZXZlbnQudGFyZ2V0LmVuY2xvc2luZ05vZGVPclNlbGZXaXRoTm9kZU5hbWUoImEiKTsKICAgIGlmICghYW5jaG9yIHx8IChhbmNob3IudGFyZ2V0ID09PSAiX2JsYW5rIikpCiAgICAgICAgcmV0dXJuOwoKICAgIC8vIFByZXZlbnQgdGhlIGxpbmsgZnJvbSBuYXZpZ2F0aW5nLCBzaW5jZSB3ZSBkb24ndCBkbyBhbnkgbmF2aWdhdGlvbiBieSBmb2xsb3dpbmcgbGlua3Mgbm9ybWFsbHkuCiAgICBldmVudC5jb25zdW1lKHRydWUpOwoKICAgIGZ1bmN0aW9uIGZvbGxvd0xpbmsoKQogICAgewogICAgICAgIGlmIChXZWJJbnNwZWN0b3IuaXNCZWluZ0VkaXRlZChldmVudC50YXJnZXQpIHx8IFdlYkluc3BlY3Rvci5fc2hvd0FuY2hvckxvY2F0aW9uKGFuY2hvcikpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgY29uc3QgcHJvZmlsZU1hdGNoID0gV2ViSW5zcGVjdG9yLlByb2ZpbGVzUGFuZWxEZXNjcmlwdG9yLlByb2ZpbGVVUkxSZWdFeHAuZXhlYyhhbmNob3IuaHJlZik7CiAgICAgICAgaWYgKHByb2ZpbGVNYXRjaCkgewogICAgICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJwcm9maWxlcyIpLnNob3dQcm9maWxlKHByb2ZpbGVNYXRjaFsxXSwgcHJvZmlsZU1hdGNoWzJdKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHBhcnNlZFVSTCA9IGFuY2hvci5ocmVmLmFzUGFyc2VkVVJMKCk7CiAgICAgICAgaWYgKHBhcnNlZFVSTCAmJiBwYXJzZWRVUkwuc2NoZW1lID09PSAid2Via2l0LWxpbmstYWN0aW9uIikgewogICAgICAgICAgICBpZiAocGFyc2VkVVJMLmhvc3QgPT09ICJzaG93LXBhbmVsIikgewogICAgICAgICAgICAgICAgdmFyIHBhbmVsID0gcGFyc2VkVVJMLnBhdGguc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgaWYgKFdlYkluc3BlY3Rvci5wYW5lbChwYW5lbCkpCiAgICAgICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLnNob3dQYW5lbChwYW5lbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgSW5zcGVjdG9yRnJvbnRlbmRIb3N0Lm9wZW5Jbk5ld1RhYihhbmNob3IuaHJlZik7CiAgICB9CgogICAgaWYgKFdlYkluc3BlY3Rvci5mb2xsb3dMaW5rVGltZW91dCkKICAgICAgICBjbGVhclRpbWVvdXQoV2ViSW5zcGVjdG9yLmZvbGxvd0xpbmtUaW1lb3V0KTsKCiAgICBpZiAoYW5jaG9yLnByZXZlbnRGb2xsb3dPbkRvdWJsZUNsaWNrKSB7CiAgICAgICAgLy8gU3RhcnQgYSB0aW1lb3V0IGlmIHRoaXMgaXMgdGhlIGZpcnN0IGNsaWNrLCBpZiB0aGUgdGltZW91dCBpcyBjYW5jZWxlZAogICAgICAgIC8vIGJlZm9yZSBpdCBmaXJlcywgdGhlbiBhIGRvdWJsZSBjbGlja2VkIGhhcHBlbmVkIG9yIGFub3RoZXIgbGluayB3YXMgY2xpY2tlZC4KICAgICAgICBpZiAoZXZlbnQuZGV0YWlsID09PSAxKQogICAgICAgICAgICBXZWJJbnNwZWN0b3IuZm9sbG93TGlua1RpbWVvdXQgPSBzZXRUaW1lb3V0KGZvbGxvd0xpbmssIDMzMyk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGZvbGxvd0xpbmsoKTsKfQoKV2ViSW5zcGVjdG9yLm9wZW5SZXNvdXJjZSA9IGZ1bmN0aW9uKHJlc291cmNlVVJMLCBpblJlc291cmNlc1BhbmVsKQp7CiAgICB2YXIgcmVzb3VyY2UgPSBXZWJJbnNwZWN0b3IucmVzb3VyY2VGb3JVUkwocmVzb3VyY2VVUkwpOwogICAgaWYgKGluUmVzb3VyY2VzUGFuZWwgJiYgcmVzb3VyY2UpCiAgICAgICAgV2ViSW5zcGVjdG9yLnNob3dQYW5lbCgicmVzb3VyY2VzIikuc2hvd1Jlc291cmNlKHJlc291cmNlKTsKICAgIGVsc2UKICAgICAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3Qub3BlbkluTmV3VGFiKHJlc291cmNlVVJMKTsKfQoKV2ViSW5zcGVjdG9yLl9yZWdpc3RlclNob3J0Y3V0cyA9IGZ1bmN0aW9uKCkKewogICAgdmFyIHNob3J0Y3V0ID0gV2ViSW5zcGVjdG9yLktleWJvYXJkU2hvcnRjdXQ7CiAgICB2YXIgc2VjdGlvbiA9IFdlYkluc3BlY3Rvci5zaG9ydGN1dHNTY3JlZW4uc2VjdGlvbihXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkFsbCBQYW5lbHMiKSk7CiAgICB2YXIga2V5cyA9IFsKICAgICAgICBzaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigiWyIsIHNob3J0Y3V0Lk1vZGlmaWVycy5DdHJsT3JNZXRhKSwKICAgICAgICBzaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigiXSIsIHNob3J0Y3V0Lk1vZGlmaWVycy5DdHJsT3JNZXRhKQogICAgXTsKICAgIHNlY3Rpb24uYWRkUmVsYXRlZEtleXMoa2V5cywgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJHbyB0byB0aGUgcGFuZWwgdG8gdGhlIGxlZnQvcmlnaHQiKSk7CgogICAga2V5cyA9IFsKICAgICAgICBzaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigiWyIsIHNob3J0Y3V0Lk1vZGlmaWVycy5DdHJsT3JNZXRhIHwgc2hvcnRjdXQuTW9kaWZpZXJzLkFsdCksCiAgICAgICAgc2hvcnRjdXQubWFrZURlc2NyaXB0b3IoIl0iLCBzaG9ydGN1dC5Nb2RpZmllcnMuQ3RybE9yTWV0YSB8IHNob3J0Y3V0Lk1vZGlmaWVycy5BbHQpCiAgICBdOwogICAgc2VjdGlvbi5hZGRSZWxhdGVkS2V5cyhrZXlzLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkdvIGJhY2svZm9yd2FyZCBpbiBwYW5lbCBoaXN0b3J5IikpOwoKICAgIHNlY3Rpb24uYWRkS2V5KHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKHNob3J0Y3V0LktleXMuRXNjKSwgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJUb2dnbGUgY29uc29sZSIpKTsKICAgIHNlY3Rpb24uYWRkS2V5KHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCJmIiwgc2hvcnRjdXQuTW9kaWZpZXJzLkN0cmxPck1ldGEpLCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIlNlYXJjaCIpKTsKCiAgICB2YXIgYWR2YW5jZWRTZWFyY2hTaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5BZHZhbmNlZFNlYXJjaENvbnRyb2xsZXIuY3JlYXRlU2hvcnRjdXQoKTsKICAgIHNlY3Rpb24uYWRkS2V5KGFkdmFuY2VkU2VhcmNoU2hvcnRjdXQsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiU2VhcmNoIGFjcm9zcyBhbGwgc291cmNlcyIpKTsKCiAgICB2YXIgaW5zcGVjdEVsZW1lbnRNb2RlU2hvcnRjdXQgPSBXZWJJbnNwZWN0b3IuSW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlci5jcmVhdGVTaG9ydGN1dCgpOwogICAgc2VjdGlvbi5hZGRLZXkoaW5zcGVjdEVsZW1lbnRNb2RlU2hvcnRjdXQsIFdlYkluc3BlY3Rvci5VSVN0cmluZygiU2VsZWN0IG5vZGUgdG8gaW5zcGVjdCIpKTsKCiAgICB2YXIgb3BlblJlc291cmNlU2hvcnRjdXQgPSBXZWJJbnNwZWN0b3IuS2V5Ym9hcmRTaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigibyIsIFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0Lk1vZGlmaWVycy5DdHJsT3JNZXRhKTsKICAgIHNlY3Rpb24uYWRkS2V5KG9wZW5SZXNvdXJjZVNob3J0Y3V0LCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkdvIHRvIHNvdXJjZSIpKTsKCiAgICBpZiAoV2ViSW5zcGVjdG9yLmlzTWFjKCkpIHsKICAgICAgICBrZXlzID0gWwogICAgICAgICAgICBzaG9ydGN1dC5tYWtlRGVzY3JpcHRvcigiZyIsIHNob3J0Y3V0Lk1vZGlmaWVycy5NZXRhKSwKICAgICAgICAgICAgc2hvcnRjdXQubWFrZURlc2NyaXB0b3IoImciLCBzaG9ydGN1dC5Nb2RpZmllcnMuTWV0YSB8IHNob3J0Y3V0Lk1vZGlmaWVycy5TaGlmdCkKICAgICAgICBdOwogICAgICAgIHNlY3Rpb24uYWRkUmVsYXRlZEtleXMoa2V5cywgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJGaW5kIG5leHQvcHJldmlvdXMiKSk7CiAgICB9CgogICAgdmFyIGdvVG9TaG9ydGN1dCA9IFdlYkluc3BlY3Rvci5Hb1RvTGluZURpYWxvZy5jcmVhdGVTaG9ydGN1dCgpOwogICAgc2VjdGlvbi5hZGRLZXkoZ29Ub1Nob3J0Y3V0LCBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkdvIHRvIGxpbmUiKSk7CgogICAga2V5cyA9IFsKICAgICAgICBzaG9ydGN1dC5LZXlzLkYxLAogICAgICAgIHNob3J0Y3V0Lm1ha2VEZXNjcmlwdG9yKCI/IikKICAgIF07CiAgICBzZWN0aW9uLmFkZEFsdGVybmF0ZUtleXMoa2V5cywgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJTaG93IGtleWJvYXJkIHNob3J0Y3V0cyIpKTsKfQoKLyoqCiAqIEBwYXJhbSB7S2V5Ym9hcmRFdmVudH0gZXZlbnQKICovCldlYkluc3BlY3Rvci5kb2N1bWVudEtleURvd24gPSBmdW5jdGlvbihldmVudCkKewogICAgY29uc3QgaGVscEtleSA9IFdlYkluc3BlY3Rvci5pc01hYygpID8gIlUrMDAzRiIgOiAiVSswMEJGIjsgLy8gIj8iIGZvciBib3RoIHBsYXRmb3JtcwoKICAgIGlmIChldmVudC5rZXlJZGVudGlmaWVyID09PSAiRjEiIHx8CiAgICAgICAgKGV2ZW50LmtleUlkZW50aWZpZXIgPT09IGhlbHBLZXkgJiYgZXZlbnQuc2hpZnRLZXkgJiYgKCFXZWJJbnNwZWN0b3IuaXNCZWluZ0VkaXRlZChldmVudC50YXJnZXQpIHx8IGV2ZW50Lm1ldGFLZXkpKSkgewogICAgICAgIHRoaXMuc2V0dGluZ3NDb250cm9sbGVyLnNob3dTZXR0aW5nc1NjcmVlbihXZWJJbnNwZWN0b3IuU2V0dGluZ3NTY3JlZW4uVGFicy5TaG9ydGN1dHMpOwogICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChXZWJJbnNwZWN0b3IuY3VycmVudEZvY3VzRWxlbWVudCgpICYmIFdlYkluc3BlY3Rvci5jdXJyZW50Rm9jdXNFbGVtZW50KCkuaGFuZGxlS2V5RXZlbnQpIHsKICAgICAgICBXZWJJbnNwZWN0b3IuY3VycmVudEZvY3VzRWxlbWVudCgpLmhhbmRsZUtleUV2ZW50KGV2ZW50KTsKICAgICAgICBpZiAoZXZlbnQuaGFuZGxlZCkgewogICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQoKICAgIGlmIChXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5jdXJyZW50UGFuZWwoKSkgewogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpLmhhbmRsZVNob3J0Y3V0KGV2ZW50KTsKICAgICAgICBpZiAoZXZlbnQuaGFuZGxlZCkgewogICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQoKICAgIGlmIChXZWJJbnNwZWN0b3Iuc2VhcmNoQ29udHJvbGxlci5oYW5kbGVTaG9ydGN1dChldmVudCkpCiAgICAgICAgcmV0dXJuOwogICAgaWYgKFdlYkluc3BlY3Rvci5hZHZhbmNlZFNlYXJjaENvbnRyb2xsZXIuaGFuZGxlU2hvcnRjdXQoZXZlbnQpKQogICAgICAgIHJldHVybjsKICAgIGlmIChXZWJJbnNwZWN0b3IuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlciAmJiBXZWJJbnNwZWN0b3IuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlci5oYW5kbGVTaG9ydGN1dChldmVudCkpCiAgICAgICAgcmV0dXJuOwoKICAgIHN3aXRjaCAoZXZlbnQua2V5SWRlbnRpZmllcikgewogICAgICAgIGNhc2UgIlUrMDA0RiI6IC8vIE8ga2V5CiAgICAgICAgICAgIGlmICghZXZlbnQuc2hpZnRLZXkgJiYgIWV2ZW50LmFsdEtleSAmJiBXZWJJbnNwZWN0b3IuS2V5Ym9hcmRTaG9ydGN1dC5ldmVudEhhc0N0cmxPck1ldGEoZXZlbnQpKSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJzY3JpcHRzIikuc2hvd0dvVG9Tb3VyY2VEaWFsb2coKTsKICAgICAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiVSswMDUyIjogLy8gUiBrZXkKICAgICAgICAgICAgaWYgKFdlYkluc3BlY3Rvci5LZXlib2FyZFNob3J0Y3V0LmV2ZW50SGFzQ3RybE9yTWV0YShldmVudCkpIHsKICAgICAgICAgICAgICAgIFBhZ2VBZ2VudC5yZWxvYWQoZXZlbnQuc2hpZnRLZXkpOwogICAgICAgICAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod2luZG93LkRFQlVHICYmIGV2ZW50LmFsdEtleSkgewogICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLnJlbG9hZCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIkY1IjoKICAgICAgICAgICAgaWYgKCFXZWJJbnNwZWN0b3IuaXNNYWMoKSkgewogICAgICAgICAgICAgICAgUGFnZUFnZW50LnJlbG9hZChldmVudC5jdHJsS2V5IHx8IGV2ZW50LnNoaWZ0S2V5KTsKICAgICAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGlzVmFsaWRab29tU2hvcnRjdXQgPSBXZWJJbnNwZWN0b3IuS2V5Ym9hcmRTaG9ydGN1dC5ldmVudEhhc0N0cmxPck1ldGEoZXZlbnQpICYmCiAgICAgICAgIWV2ZW50LmFsdEtleSAmJgogICAgICAgICFJbnNwZWN0b3JGcm9udGVuZEhvc3QuaXNTdHViOwogICAgc3dpdGNoIChldmVudC5rZXlDb2RlKSB7CiAgICAgICAgY2FzZSAxMDc6IC8vICsKICAgICAgICBjYXNlIDE4NzogLy8gKwogICAgICAgICAgICBpZiAoaXNWYWxpZFpvb21TaG9ydGN1dCkgewogICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLl96b29tSW4oKTsKICAgICAgICAgICAgICAgIGV2ZW50LmNvbnN1bWUodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAxMDk6IC8vIC0KICAgICAgICBjYXNlIDE4OTogLy8gLQogICAgICAgICAgICBpZiAoaXNWYWxpZFpvb21TaG9ydGN1dCkgewogICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLl96b29tT3V0KCk7CiAgICAgICAgICAgICAgICBldmVudC5jb25zdW1lKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgNDg6IC8vIDAKICAgICAgICAgICAgLy8gWm9vbSByZXNldCBzaG9ydGN1dCBkb2VzIG5vdCBhbGxvdyAiU2hpZnQiIHdoZW4gaGFuZGxlZCBieSB0aGUgYnJvd3Nlci4KICAgICAgICAgICAgaWYgKGlzVmFsaWRab29tU2hvcnRjdXQgJiYgIWV2ZW50LnNoaWZ0S2V5KSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IuX3Jlc2V0Wm9vbSgpOwogICAgICAgICAgICAgICAgZXZlbnQuY29uc3VtZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgIH0KfQoKV2ViSW5zcGVjdG9yLnBvc3REb2N1bWVudEtleURvd24gPSBmdW5jdGlvbihldmVudCkKewogICAgaWYgKGV2ZW50LmhhbmRsZWQpCiAgICAgICAgcmV0dXJuOwoKICAgIGlmIChldmVudC5rZXlDb2RlID09PSBXZWJJbnNwZWN0b3IuS2V5Ym9hcmRTaG9ydGN1dC5LZXlzLkVzYy5jb2RlKSB7CiAgICAgICAgLy8gSWYgZHJhd2VyIGlzIG9wZW4gd2l0aCBzb21lIHZpZXcgb3RoZXIgdGhhbiBjb25zb2xlIHRoZW4gY2xvc2UgaXQuCiAgICAgICAgaWYgKCF0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uLnRvZ2dsZWQgJiYgV2ViSW5zcGVjdG9yLmRyYXdlci52aXNpYmxlKQogICAgICAgICAgICB0aGlzLmNsb3NlVmlld0luRHJhd2VyKCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICB0aGlzLl90b2dnbGVDb25zb2xlQnV0dG9uQ2xpY2tlZCgpOwogICAgfQp9CgpXZWJJbnNwZWN0b3IuZG9jdW1lbnRDYW5Db3B5ID0gZnVuY3Rpb24oZXZlbnQpCnsKICAgIGlmIChXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5jdXJyZW50UGFuZWwoKSAmJiBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5jdXJyZW50UGFuZWwoKS5oYW5kbGVDb3B5RXZlbnQpCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKfQoKV2ViSW5zcGVjdG9yLmRvY3VtZW50Q29weSA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBpZiAoV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkgJiYgV2ViSW5zcGVjdG9yLmluc3BlY3RvclZpZXcuY3VycmVudFBhbmVsKCkuaGFuZGxlQ29weUV2ZW50KQogICAgICAgIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LmN1cnJlbnRQYW5lbCgpLmhhbmRsZUNvcHlFdmVudChldmVudCk7CiAgICBXZWJJbnNwZWN0b3IuZG9jdW1lbnRDb3B5RXZlbnRGaXJlZChldmVudCk7Cn0KCldlYkluc3BlY3Rvci5kb2N1bWVudENvcHlFdmVudEZpcmVkID0gZnVuY3Rpb24oZXZlbnQpCnsKfQoKV2ViSW5zcGVjdG9yLmNvbnRleHRNZW51RXZlbnRGaXJlZCA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBpZiAoZXZlbnQuaGFuZGxlZCB8fCBldmVudC50YXJnZXQuaGFzU3R5bGVDbGFzcygicG9wdXAtZ2xhc3NwYW5lIikpCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKfQoKV2ViSW5zcGVjdG9yLnNob3dDb25zb2xlID0gZnVuY3Rpb24oKQp7CiAgICBpZiAoV2ViSW5zcGVjdG9yLl90b2dnbGVDb25zb2xlQnV0dG9uICYmICFXZWJJbnNwZWN0b3IuX3RvZ2dsZUNvbnNvbGVCdXR0b24udG9nZ2xlZCkgewogICAgICAgIGlmIChXZWJJbnNwZWN0b3IuZHJhd2VyLnZpc2libGUpCiAgICAgICAgICAgIHRoaXMuX2Nsb3NlUHJldmlvdXNEcmF3ZXJWaWV3KCk7CiAgICAgICAgV2ViSW5zcGVjdG9yLl90b2dnbGVDb25zb2xlQnV0dG9uQ2xpY2tlZCgpOwogICAgfQp9CgpXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsID0gZnVuY3Rpb24ocGFuZWwpCnsKICAgIHJldHVybiBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5zaG93UGFuZWwocGFuZWwpOwp9CgpXZWJJbnNwZWN0b3IucGFuZWwgPSBmdW5jdGlvbihwYW5lbCkKewogICAgcmV0dXJuIFdlYkluc3BlY3Rvci5pbnNwZWN0b3JWaWV3LnBhbmVsKHBhbmVsKTsKfQoKV2ViSW5zcGVjdG9yLmJyaW5nVG9Gcm9udCA9IGZ1bmN0aW9uKCkKewogICAgSW5zcGVjdG9yRnJvbnRlbmRIb3N0LmJyaW5nVG9Gcm9udCgpOwp9CgovKioKICogQHBhcmFtIHtzdHJpbmc9fSBtZXNzYWdlTGV2ZWwKICogQHBhcmFtIHtib29sZWFuPX0gc2hvd0NvbnNvbGUKICovCldlYkluc3BlY3Rvci5sb2cgPSBmdW5jdGlvbihtZXNzYWdlLCBtZXNzYWdlTGV2ZWwsIHNob3dDb25zb2xlKQp7CiAgICAvLyByZW1lbWJlciAndGhpcycgZm9yIHNldEludGVydmFsKCkgY2FsbGJhY2sKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvLyByZXR1cm4gaW5kaWNhdGlvbiBpZiB3ZSBjYW4gYWN0dWFsbHkgbG9nIGEgbWVzc2FnZQogICAgZnVuY3Rpb24gaXNMb2dBdmFpbGFibGUoKQogICAgewogICAgICAgIHJldHVybiBXZWJJbnNwZWN0b3IuQ29uc29sZU1lc3NhZ2UgJiYgV2ViSW5zcGVjdG9yLlJlbW90ZU9iamVjdCAmJiBzZWxmLmNvbnNvbGU7CiAgICB9CgogICAgLy8gZmx1c2ggdGhlIHF1ZXVlIG9mIHBlbmRpbmcgbWVzc2FnZXMKICAgIGZ1bmN0aW9uIGZsdXNoUXVldWUoKQogICAgewogICAgICAgIHZhciBxdWV1ZWQgPSBXZWJJbnNwZWN0b3IubG9nLnF1ZXVlZDsKICAgICAgICBpZiAoIXF1ZXVlZCkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlZC5sZW5ndGg7ICsraSkKICAgICAgICAgICAgbG9nTWVzc2FnZShxdWV1ZWRbaV0pOwoKICAgICAgICBkZWxldGUgV2ViSW5zcGVjdG9yLmxvZy5xdWV1ZWQ7CiAgICB9CgogICAgLy8gZmx1c2ggdGhlIHF1ZXVlIGlmIGl0IGNvbnNvbGUgaXMgYXZhaWxhYmxlCiAgICAvLyAtIHRoaXMgZnVuY3Rpb24gaXMgcnVuIG9uIGFuIGludGVydmFsCiAgICBmdW5jdGlvbiBmbHVzaFF1ZXVlSWZBdmFpbGFibGUoKQogICAgewogICAgICAgIGlmICghaXNMb2dBdmFpbGFibGUoKSkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBjbGVhckludGVydmFsKFdlYkluc3BlY3Rvci5sb2cuaW50ZXJ2YWwpOwogICAgICAgIGRlbGV0ZSBXZWJJbnNwZWN0b3IubG9nLmludGVydmFsOwoKICAgICAgICBmbHVzaFF1ZXVlKCk7CiAgICB9CgogICAgLy8gYWN0dWFsbHkgbG9nIHRoZSBtZXNzYWdlCiAgICBmdW5jdGlvbiBsb2dNZXNzYWdlKG1lc3NhZ2UpCiAgICB7CiAgICAgICAgLy8gcG9zdCB0aGUgbWVzc2FnZQogICAgICAgIHZhciBtc2cgPSBXZWJJbnNwZWN0b3IuQ29uc29sZU1lc3NhZ2UuY3JlYXRlKAogICAgICAgICAgICBXZWJJbnNwZWN0b3IuQ29uc29sZU1lc3NhZ2UuTWVzc2FnZVNvdXJjZS5PdGhlciwKICAgICAgICAgICAgbWVzc2FnZUxldmVsIHx8IFdlYkluc3BlY3Rvci5Db25zb2xlTWVzc2FnZS5NZXNzYWdlTGV2ZWwuRGVidWcsCiAgICAgICAgICAgIG1lc3NhZ2UpOwoKICAgICAgICBzZWxmLmNvbnNvbGUuYWRkTWVzc2FnZShtc2cpOwogICAgICAgIGlmIChzaG93Q29uc29sZSkKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLnNob3dDb25zb2xlKCk7CiAgICB9CgogICAgLy8gaWYgd2UgY2FuJ3QgbG9nIHRoZSBtZXNzYWdlLCBxdWV1ZSBpdAogICAgaWYgKCFpc0xvZ0F2YWlsYWJsZSgpKSB7CiAgICAgICAgaWYgKCFXZWJJbnNwZWN0b3IubG9nLnF1ZXVlZCkKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmxvZy5xdWV1ZWQgPSBbXTsKCiAgICAgICAgV2ViSW5zcGVjdG9yLmxvZy5xdWV1ZWQucHVzaChtZXNzYWdlKTsKCiAgICAgICAgaWYgKCFXZWJJbnNwZWN0b3IubG9nLmludGVydmFsKQogICAgICAgICAgICBXZWJJbnNwZWN0b3IubG9nLmludGVydmFsID0gc2V0SW50ZXJ2YWwoZmx1c2hRdWV1ZUlmQXZhaWxhYmxlLCAxMDAwKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIGZsdXNoIHRoZSBwZW5kaW5nIHF1ZXVlIGlmIGFueQogICAgZmx1c2hRdWV1ZSgpOwoKICAgIC8vIGxvZyB0aGUgbWVzc2FnZQogICAgbG9nTWVzc2FnZShtZXNzYWdlKTsKfQoKV2ViSW5zcGVjdG9yLnNob3dFcnJvck1lc3NhZ2UgPSBmdW5jdGlvbihlcnJvcikKewogICAgV2ViSW5zcGVjdG9yLmxvZyhlcnJvciwgV2ViSW5zcGVjdG9yLkNvbnNvbGVNZXNzYWdlLk1lc3NhZ2VMZXZlbC5FcnJvciwgdHJ1ZSk7Cn0KCi8vIEluc3BlY3Rvci5pbnNwZWN0IHByb3RvY29sIGV2ZW50CldlYkluc3BlY3Rvci5pbnNwZWN0ID0gZnVuY3Rpb24ocGF5bG9hZCwgaGludHMpCnsKICAgIHZhciBvYmplY3QgPSBXZWJJbnNwZWN0b3IuUmVtb3RlT2JqZWN0LmZyb21QYXlsb2FkKHBheWxvYWQpOwogICAgaWYgKG9iamVjdC5zdWJ0eXBlID09PSAibm9kZSIpIHsKICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayhub2RlSWQpCiAgICAgICAgewogICAgICAgICAgICBXZWJJbnNwZWN0b3IuX3VwZGF0ZUZvY3VzZWROb2RlKG5vZGVJZCk7CiAgICAgICAgICAgIG9iamVjdC5yZWxlYXNlKCk7CiAgICAgICAgfQogICAgICAgIG9iamVjdC5wdXNoTm9kZVRvRnJvbnRlbmQoY2FsbGJhY2spOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoaGludHMuZGF0YWJhc2VJZCkKICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJyZXNvdXJjZXMiKS5zZWxlY3REYXRhYmFzZShXZWJJbnNwZWN0b3IuZGF0YWJhc2VNb2RlbC5kYXRhYmFzZUZvcklkKGhpbnRzLmRhdGFiYXNlSWQpKTsKICAgIGVsc2UgaWYgKGhpbnRzLmRvbVN0b3JhZ2VJZCkKICAgICAgICBXZWJJbnNwZWN0b3Iuc2hvd1BhbmVsKCJyZXNvdXJjZXMiKS5zZWxlY3RET01TdG9yYWdlKFdlYkluc3BlY3Rvci5kb21TdG9yYWdlTW9kZWwuc3RvcmFnZUZvcklkKGhpbnRzLmRvbVN0b3JhZ2VJZCkpOwoKICAgIG9iamVjdC5yZWxlYXNlKCk7Cn0KCi8vIEluc3BlY3Rvci5kZXRhY2hlZCBwcm90b2NvbCBldmVudApXZWJJbnNwZWN0b3IuZGV0YWNoZWQgPSBmdW5jdGlvbihyZWFzb24pCnsKICAgIFdlYkluc3BlY3Rvci5zb2NrZXQuX2RldGFjaFJlYXNvbiA9IHJlYXNvbjsKICAgIChuZXcgV2ViSW5zcGVjdG9yLlJlbW90ZURlYnVnZ2luZ1Rlcm1pbmF0ZWRTY3JlZW4ocmVhc29uKSkuc2hvd01vZGFsKCk7Cn0KCldlYkluc3BlY3Rvci50YXJnZXRDcmFzaGVkID0gZnVuY3Rpb24oKQp7CiAgICAobmV3IFdlYkluc3BlY3Rvci5IZWxwU2NyZWVuVW50aWxSZWxvYWQoCiAgICAgICAgV2ViSW5zcGVjdG9yLlVJU3RyaW5nKCJJbnNwZWN0ZWQgdGFyZ2V0IGNyYXNoZWQiKSwKICAgICAgICBXZWJJbnNwZWN0b3IuVUlTdHJpbmcoIkluc3BlY3RlZCB0YXJnZXQgaGFzIGNyYXNoZWQuIE9uY2UgaXQgcmVsb2FkcyB3ZSB3aWxsIGF0dGFjaCB0byBpdCBhdXRvbWF0aWNhbGx5LiIpKSkuc2hvd01vZGFsKCk7Cn0KCldlYkluc3BlY3Rvci5fdXBkYXRlRm9jdXNlZE5vZGUgPSBmdW5jdGlvbihub2RlSWQpCnsKICAgIGlmIChXZWJJbnNwZWN0b3IuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlciAmJiBXZWJJbnNwZWN0b3IuaW5zcGVjdEVsZW1lbnRNb2RlQ29udHJvbGxlci5lbmFibGVkKCkpIHsKICAgICAgICBJbnNwZWN0b3JGcm9udGVuZEhvc3QuYnJpbmdUb0Zyb250KCk7CiAgICAgICAgV2ViSW5zcGVjdG9yLmluc3BlY3RFbGVtZW50TW9kZUNvbnRyb2xsZXIuZGlzYWJsZSgpOwogICAgfQogICAgV2ViSW5zcGVjdG9yLnNob3dQYW5lbCgiZWxlbWVudHMiKS5yZXZlYWxBbmRTZWxlY3ROb2RlKG5vZGVJZCk7Cn0KCldlYkluc3BlY3Rvci5fc2hvd0FuY2hvckxvY2F0aW9uID0gZnVuY3Rpb24oYW5jaG9yKQp7CiAgICBpZiAoV2ViSW5zcGVjdG9yLm9wZW5BbmNob3JMb2NhdGlvblJlZ2lzdHJ5LmRpc3BhdGNoKHsgdXJsOiBhbmNob3IuaHJlZiwgbGluZU51bWJlcjogYW5jaG9yLmxpbmVOdW1iZXJ9KSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIHZhciBwcmVmZXJyZWRQYW5lbCA9IHRoaXMucGFuZWxzW2FuY2hvci5wcmVmZXJyZWRQYW5lbF07CiAgICBpZiAocHJlZmVycmVkUGFuZWwgJiYgV2ViSW5zcGVjdG9yLl9zaG93QW5jaG9yTG9jYXRpb25JblBhbmVsKGFuY2hvciwgcHJlZmVycmVkUGFuZWwpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgaWYgKFdlYkluc3BlY3Rvci5fc2hvd0FuY2hvckxvY2F0aW9uSW5QYW5lbChhbmNob3IsIHRoaXMucGFuZWwoInNjcmlwdHMiKSkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICBpZiAoV2ViSW5zcGVjdG9yLl9zaG93QW5jaG9yTG9jYXRpb25JblBhbmVsKGFuY2hvciwgdGhpcy5wYW5lbCgicmVzb3VyY2VzIikpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgaWYgKFdlYkluc3BlY3Rvci5fc2hvd0FuY2hvckxvY2F0aW9uSW5QYW5lbChhbmNob3IsIHRoaXMucGFuZWwoIm5ldHdvcmsiKSkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICByZXR1cm4gZmFsc2U7Cn0KCldlYkluc3BlY3Rvci5fc2hvd0FuY2hvckxvY2F0aW9uSW5QYW5lbCA9IGZ1bmN0aW9uKGFuY2hvciwgcGFuZWwpCnsKICAgIGlmICghcGFuZWwgfHwgIXBhbmVsLmNhblNob3dBbmNob3JMb2NhdGlvbihhbmNob3IpKQogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICAvLyBGSVhNRTogc3VwcG9ydCB3ZWJraXQtaHRtbC1leHRlcm5hbC1saW5rIGxpbmtzIGhlcmUuCiAgICBpZiAoYW5jaG9yLmhhc1N0eWxlQ2xhc3MoIndlYmtpdC1odG1sLWV4dGVybmFsLWxpbmsiKSkgewogICAgICAgIGFuY2hvci5yZW1vdmVTdHlsZUNsYXNzKCJ3ZWJraXQtaHRtbC1leHRlcm5hbC1saW5rIik7CiAgICAgICAgYW5jaG9yLmFkZFN0eWxlQ2xhc3MoIndlYmtpdC1odG1sLXJlc291cmNlLWxpbmsiKTsKICAgIH0KCiAgICBXZWJJbnNwZWN0b3IuaW5zcGVjdG9yVmlldy5zaG93UGFuZWxGb3JBbmNob3JOYXZpZ2F0aW9uKHBhbmVsKTsKICAgIHBhbmVsLnNob3dBbmNob3JMb2NhdGlvbihhbmNob3IpOwogICAgcmV0dXJuIHRydWU7Cn0KCldlYkluc3BlY3Rvci5ldmFsdWF0ZUluQ29uc29sZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIHNob3dSZXN1bHRPbmx5KQp7CiAgICB0aGlzLnNob3dDb25zb2xlKCk7CiAgICB0aGlzLmNvbnNvbGVWaWV3LmV2YWx1YXRlVXNpbmdUZXh0UHJvbXB0KGV4cHJlc3Npb24sIHNob3dSZXN1bHRPbmx5KTsKfQoKV2ViSW5zcGVjdG9yLmFkZE1haW5FdmVudExpc3RlbmVycyA9IGZ1bmN0aW9uKGRvYykKewogICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLmRvY3VtZW50S2V5RG93bi5iaW5kKHRoaXMpLCB0cnVlKTsKICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5wb3N0RG9jdW1lbnRLZXlEb3duLmJpbmQodGhpcyksIGZhbHNlKTsKICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCJiZWZvcmVjb3B5IiwgdGhpcy5kb2N1bWVudENhbkNvcHkuYmluZCh0aGlzKSwgdHJ1ZSk7CiAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcigiY29weSIsIHRoaXMuZG9jdW1lbnRDb3B5LmJpbmQodGhpcyksIGZhbHNlKTsKICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIHRoaXMuY29udGV4dE1lbnVFdmVudEZpcmVkLmJpbmQodGhpcyksIHRydWUpOwogICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5kb2N1bWVudENsaWNrLmJpbmQodGhpcyksIHRydWUpOwp9CgpXZWJJbnNwZWN0b3IuWm9vbSA9IHsKICAgIFRhYmxlOiBbMC4yNSwgMC4zMywgMC41LCAwLjY2LCAwLjc1LCAwLjksIDEsIDEuMSwgMS4yNSwgMS41LCAxLjc1LCAyLCAyLjUsIDMsIDQsIDVdLAogICAgRGVmYXVsdE9mZnNldDogNgp9Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:49:58 GMT",
                    "Content-Length": "41281",
                    "Date": "Fri, 07 Nov 2014 21:50:47 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}